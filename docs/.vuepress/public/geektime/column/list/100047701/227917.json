{"id":227917,"title":"19 | Springæ¡†æ¶ï¼šIoCå’ŒAOPæ˜¯æ‰©å±•çš„æ ¸å¿ƒ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯æœ±æ™”ã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬æ¥èŠèŠSpringæ¡†æ¶ä¸­çš„IoCå’ŒAOPï¼ŒåŠå…¶å®¹æ˜“å‡ºé”™çš„åœ°æ–¹ã€‚</p><p>ç†Ÿæ‚‰Javaçš„åŒå­¦éƒ½çŸ¥é“ï¼ŒSpringçš„å®¶æ—åºå¤§ï¼Œå¸¸ç”¨çš„æ¨¡å—å°±æœ‰Spring Dataã€Spring Securityã€Spring Bootã€Spring Cloudç­‰ã€‚å…¶å®å‘¢ï¼ŒSpringä½“ç³»è™½ç„¶åºå¤§ï¼Œä½†éƒ½æ˜¯å›´ç»•Spring Coreå±•å¼€çš„ï¼Œè€ŒSpring Coreä¸­æœ€æ ¸å¿ƒçš„å°±æ˜¯IoCï¼ˆæ§åˆ¶åè½¬ï¼‰å’ŒAOPï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰ã€‚</p><p>æ¦‚æ‹¬åœ°è¯´ï¼ŒIoCå’ŒAOPçš„åˆè¡·æ˜¯è§£è€¦å’Œæ‰©å±•ã€‚ç†è§£è¿™ä¸¤ä¸ªæ ¸å¿ƒæŠ€æœ¯ï¼Œå°±å¯ä»¥è®©ä½ çš„ä»£ç å˜å¾—æ›´çµæ´»ã€å¯éšæ—¶æ›¿æ¢ï¼Œä»¥åŠä¸šåŠ¡ç»„ä»¶é—´æ›´è§£è€¦ã€‚åœ¨æ¥ä¸‹æ¥çš„ä¸¤è®²ä¸­ï¼Œæˆ‘ä¼šä¸ä½ æ·±å…¥å‰–æå‡ ä¸ªæ¡ˆä¾‹ï¼Œå¸¦ä½ ç»•è¿‡ä¸šåŠ¡ä¸­é€šè¿‡Springå®ç°IoCå’ŒAOPç›¸å…³çš„å‘ã€‚</p><p>ä¸ºäº†ä¾¿äºç†è§£è¿™ä¸¤è®²ä¸­çš„æ¡ˆä¾‹ï¼Œæˆ‘ä»¬å…ˆå›é¡¾ä¸‹IoCå’ŒAOPçš„åŸºç¡€çŸ¥è¯†ã€‚</p><p>IoCï¼Œå…¶å®å°±æ˜¯ä¸€ç§è®¾è®¡æ€æƒ³ã€‚ä½¿ç”¨Springæ¥å®ç°IoCï¼Œæ„å‘³ç€å°†ä½ è®¾è®¡å¥½çš„å¯¹è±¡äº¤ç»™Springå®¹å™¨æ§åˆ¶ï¼Œè€Œä¸æ˜¯ç›´æ¥åœ¨å¯¹è±¡å†…éƒ¨æ§åˆ¶ã€‚é‚£ï¼Œä¸ºä»€ä¹ˆè¦è®©å®¹å™¨æ¥ç®¡ç†å¯¹è±¡å‘¢ï¼Ÿæˆ–è®¸ä½ èƒ½æƒ³åˆ°çš„æ˜¯ï¼Œä½¿ç”¨IoCæ–¹ä¾¿ã€å¯ä»¥å®ç°è§£è€¦ã€‚ä½†åœ¨æˆ‘çœ‹æ¥ï¼Œç›¸æ¯”äºè¿™ä¸¤ä¸ªåŸå› ï¼Œæ›´é‡è¦çš„æ˜¯IoCå¸¦æ¥äº†æ›´å¤šçš„å¯èƒ½æ€§ã€‚</p><p>å¦‚æœä»¥å®¹å™¨ä¸ºä¾æ‰˜æ¥ç®¡ç†æ‰€æœ‰çš„æ¡†æ¶ã€ä¸šåŠ¡å¯¹è±¡ï¼Œæˆ‘ä»¬ä¸ä»…å¯ä»¥æ— ä¾µå…¥åœ°è°ƒæ•´å¯¹è±¡çš„å…³ç³»ï¼Œè¿˜å¯ä»¥æ— ä¾µå…¥åœ°éšæ—¶è°ƒæ•´å¯¹è±¡çš„å±æ€§ï¼Œç”šè‡³æ˜¯å®ç°å¯¹è±¡çš„æ›¿æ¢ã€‚è¿™å°±ä½¿å¾—æ¡†æ¶å¼€å‘è€…åœ¨ç¨‹åºèƒŒåå®ç°ä¸€äº›æ‰©å±•ä¸å†æ˜¯é—®é¢˜ï¼Œå¸¦æ¥çš„å¯èƒ½æ€§æ˜¯æ— é™çš„ã€‚æ¯”å¦‚æˆ‘ä»¬è¦ç›‘æ§çš„å¯¹è±¡å¦‚æœæ˜¯Beanï¼Œå®ç°å°±ä¼šéå¸¸ç®€å•ã€‚æ‰€ä»¥ï¼Œè¿™å¥—å®¹å™¨ä½“ç³»ï¼Œä¸ä»…è¢«Spring Coreå’ŒSpring Bootå¤§é‡ä¾èµ–ï¼Œè¿˜å®ç°äº†ä¸€äº›å¤–éƒ¨æ¡†æ¶å’ŒSpringçš„æ— ç¼æ•´åˆã€‚</p><!-- [[[read_end]]] --><p>AOPï¼Œä½“ç°äº†æ¾è€¦åˆã€é«˜å†…èšçš„ç²¾é«“ï¼Œåœ¨åˆ‡é¢é›†ä¸­å®ç°æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼ˆç¼“å­˜ã€æƒé™ã€æ—¥å¿—ç­‰ï¼‰ï¼Œç„¶åé€šè¿‡åˆ‡ç‚¹é…ç½®æŠŠä»£ç æ³¨å…¥åˆé€‚çš„åœ°æ–¹ã€‚åˆ‡é¢ã€åˆ‡ç‚¹ã€å¢å¼ºã€è¿æ¥ç‚¹ï¼Œæ˜¯AOPä¸­éå¸¸é‡è¦çš„æ¦‚å¿µï¼Œä¹Ÿæ˜¯æˆ‘ä»¬è¿™ä¸¤è®²ä¼šå¤§é‡æåŠçš„ã€‚</p><p>ä¸ºæ–¹ä¾¿ç†è§£ï¼Œæˆ‘ä»¬æŠŠSpring AOPæŠ€æœ¯çœ‹ä½œä¸ºè›‹ç³•åšå¥¶æ²¹å¤¹å±‚çš„å·¥åºã€‚å¦‚æœæˆ‘ä»¬å¸Œæœ›æ‰¾åˆ°ä¸€ä¸ªåˆé€‚çš„åœ°æ–¹æŠŠå¥¶æ²¹æ³¨å…¥è›‹ç³•èƒšå­ä¸­ï¼Œé‚£åº”è¯¥å¦‚ä½•æŒ‡å¯¼å·¥äººå®Œæˆæ“ä½œå‘¢ï¼Ÿ</p><p><img src=\"https://static001.geekbang.org/resource/image/c7/db/c71f2ec73901f7bcaa8332f237dfeddb.png?wh=1410*572\" alt=\"\"></p><ul>\n<li>é¦–å…ˆï¼Œæˆ‘ä»¬è¦æé†’ä»–ï¼Œåªèƒ½å¾€è›‹ç³•èƒšå­é‡Œé¢åŠ å¥¶æ²¹ï¼Œè€Œä¸èƒ½ä¸Šé¢æˆ–ä¸‹é¢åŠ å¥¶æ²¹ã€‚è¿™å°±æ˜¯è¿æ¥ç‚¹ï¼ˆJoin pointï¼‰ï¼Œå¯¹äºSpring AOPæ¥è¯´ï¼Œè¿æ¥ç‚¹å°±æ˜¯æ–¹æ³•æ‰§è¡Œã€‚</li>\n<li>ç„¶åï¼Œæˆ‘ä»¬è¦å‘Šè¯‰ä»–ï¼Œåœ¨ä»€ä¹ˆç‚¹åˆ‡å¼€è›‹ç³•åŠ å¥¶æ²¹ã€‚æ¯”å¦‚ï¼Œå¯ä»¥åœ¨è›‹ç³•å¯å­ä¸­é—´åŠ å…¥ä¸€å±‚å¥¶æ²¹ï¼Œåœ¨ä¸­é—´åˆ‡ä¸€æ¬¡ï¼›ä¹Ÿå¯ä»¥åœ¨ä¸­é—´åŠ ä¸¤å±‚å¥¶æ²¹ï¼Œåœ¨1/3å’Œ2/3çš„åœ°æ–¹åˆ‡ä¸¤æ¬¡ã€‚è¿™å°±æ˜¯åˆ‡ç‚¹ï¼ˆPointcutï¼‰ï¼ŒSpring AOPä¸­é»˜è®¤ä½¿ç”¨AspectJæŸ¥è¯¢è¡¨è¾¾å¼ï¼Œé€šè¿‡åœ¨è¿æ¥ç‚¹è¿è¡ŒæŸ¥è¯¢è¡¨è¾¾å¼æ¥åŒ¹é…åˆ‡å…¥ç‚¹ã€‚</li>\n<li>æ¥ä¸‹æ¥ä¹Ÿæ˜¯æœ€é‡è¦çš„ï¼Œæˆ‘ä»¬è¦å‘Šè¯‰ä»–ï¼Œåˆ‡å¼€è›‹ç³•åè¦åšä»€ä¹ˆï¼Œä¹Ÿå°±æ˜¯åŠ å…¥å¥¶æ²¹ã€‚è¿™å°±æ˜¯å¢å¼ºï¼ˆAdviceï¼‰ï¼Œä¹Ÿå«ä½œé€šçŸ¥ï¼Œå®šä¹‰äº†åˆ‡å…¥åˆ‡ç‚¹åå¢å¼ºçš„æ–¹å¼ï¼ŒåŒ…æ‹¬å‰ã€åã€ç¯ç»•ç­‰ã€‚Spring AOPä¸­ï¼ŒæŠŠå¢å¼ºå®šä¹‰ä¸ºæ‹¦æˆªå™¨ã€‚</li>\n<li>æœ€åï¼Œæˆ‘ä»¬è¦å‘Šè¯‰ä»–ï¼Œæ‰¾åˆ°è›‹ç³•èƒšå­ä¸­è¦åŠ å¥¶æ²¹çš„åœ°æ–¹å¹¶åŠ å…¥å¥¶æ²¹ã€‚ä¸ºè›‹ç³•åšå¥¶æ²¹å¤¹å±‚çš„æ“ä½œï¼Œå¯¹Spring AOPæ¥è¯´å°±æ˜¯åˆ‡é¢ï¼ˆAspectï¼‰ï¼Œä¹Ÿå«ä½œæ–¹é¢ã€‚åˆ‡é¢=åˆ‡ç‚¹+å¢å¼ºã€‚</li>\n</ul><p>å¥½äº†ï¼Œç†è§£äº†è¿™å‡ ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼Œæˆ‘ä»¬å°±å¯ä»¥ç»§ç»­åˆ†ææ¡ˆä¾‹äº†ã€‚</p><p>æˆ‘è¦é¦–å…ˆè¯´æ˜çš„æ˜¯ï¼ŒSpringç›¸å…³é—®é¢˜çš„é—®é¢˜æ¯”è¾ƒå¤æ‚ï¼Œä¸€æ–¹é¢æ˜¯Springæä¾›çš„IoCå’ŒAOPæœ¬å°±çµæ´»ï¼Œå¦ä¸€æ–¹é¢Spring Bootçš„è‡ªåŠ¨è£…é…ã€Spring Cloudå¤æ‚çš„æ¨¡å—ä¼šè®©é—®é¢˜æ’æŸ¥å˜å¾—æ›´å¤æ‚ã€‚å› æ­¤ï¼Œä»Šå¤©è¿™ä¸€è®²ï¼Œæˆ‘ä¼šå¸¦ä½ å…ˆæ‰“å¥½åŸºç¡€ï¼Œé€šè¿‡ä¸¤ä¸ªæ¡ˆä¾‹æ¥é‡ç‚¹èŠèŠIoCå’ŒAOPï¼›ç„¶åï¼Œæˆ‘ä¼šåœ¨ä¸‹ä¸€è®²ä¸­ä¸ä½ åˆ†äº«Springç›¸å…³çš„å‘ã€‚</p><h2>å•ä¾‹çš„Beanå¦‚ä½•æ³¨å…¥Prototypeçš„Beanï¼Ÿ</h2><p>æˆ‘ä»¬è™½ç„¶çŸ¥é“Springåˆ›å»ºçš„Beané»˜è®¤æ˜¯å•ä¾‹çš„ï¼Œä½†å½“Beané‡åˆ°ç»§æ‰¿çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šå¿½ç•¥è¿™ä¸€ç‚¹ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå¿½ç•¥è¿™ä¸€ç‚¹åˆä¼šé€ æˆä»€ä¹ˆå½±å“å‘¢ï¼Ÿæ¥ä¸‹æ¥ï¼Œæˆ‘å°±å’Œä½ åˆ†äº«ä¸€ä¸ªç”±å•ä¾‹å¼•èµ·å†…å­˜æ³„éœ²çš„æ¡ˆä¾‹ã€‚</p><p>æ¶æ„å¸ˆä¸€å¼€å§‹å®šä¹‰äº†è¿™ä¹ˆä¸€ä¸ªSayServiceæŠ½è±¡ç±»ï¼Œå…¶ä¸­ç»´æŠ¤äº†ä¸€ä¸ªç±»å‹æ˜¯ArrayListçš„å­—æ®µdataï¼Œç”¨äºä¿å­˜æ–¹æ³•å¤„ç†çš„ä¸­é—´æ•°æ®ã€‚æ¯æ¬¡è°ƒç”¨sayæ–¹æ³•éƒ½ä¼šå¾€dataåŠ å…¥æ–°æ•°æ®ï¼Œå¯ä»¥è®¤ä¸ºSayServiceæ˜¯æœ‰çŠ¶æ€ï¼Œå¦‚æœSayServiceæ˜¯å•ä¾‹çš„è¯å¿…ç„¶ä¼šOOMï¼š</p><pre><code>@Slf4j\npublic abstract class SayService {\n    List&lt;String&gt; data = new ArrayList&lt;&gt;();\n\n    public void say() {\n        data.add(IntStream.rangeClosed(1, 1000000)\n                .mapToObj(__ -&gt; &quot;a&quot;)\n                .collect(Collectors.joining(&quot;&quot;)) + UUID.randomUUID().toString());\n        log.info(&quot;I'm {} size:{}&quot;, this, data.size());\n    }\n}\n</code></pre><p>ä½†å®é™…å¼€å‘çš„æ—¶å€™ï¼Œå¼€å‘åŒå­¦æ²¡æœ‰è¿‡å¤šæ€è€ƒå°±æŠŠSayHelloå’ŒSayByeç±»åŠ ä¸Šäº†@Serviceæ³¨è§£ï¼Œè®©å®ƒä»¬æˆä¸ºäº†Beanï¼Œä¹Ÿæ²¡æœ‰è€ƒè™‘åˆ°çˆ¶ç±»æ˜¯æœ‰çŠ¶æ€çš„ï¼š</p><pre><code>@Service\n@Slf4j\npublic class SayHello extends SayService {\n    @Override\n    public void say() {\n        super.say();\n        log.info(&quot;hello&quot;);\n    }\n}\n\n@Service\n@Slf4j\npublic class SayBye extends SayService {\n    @Override\n    public void say() {\n        super.say();\n        log.info(&quot;bye&quot;);\n    }\n}\n</code></pre><p>è®¸å¤šå¼€å‘åŒå­¦è®¤ä¸ºï¼Œ@Serviceæ³¨è§£çš„æ„ä¹‰åœ¨äºï¼Œèƒ½é€šè¿‡@Autowiredæ³¨è§£è®©Springè‡ªåŠ¨æ³¨å…¥å¯¹è±¡ï¼Œå°±æ¯”å¦‚å¯ä»¥ç›´æ¥ä½¿ç”¨æ³¨å…¥çš„List<sayservice>è·å–åˆ°SayHelloå’ŒSayByeï¼Œè€Œæ²¡æƒ³è¿‡ç±»çš„ç”Ÿå‘½å‘¨æœŸï¼š</sayservice></p><pre><code>@Autowired\nList&lt;SayService&gt; sayServiceList;\n\n@GetMapping(&quot;test&quot;)\npublic void test() {\n    log.info(&quot;====================&quot;);\n    sayServiceList.forEach(SayService::say);\n}\n</code></pre><p>è¿™ä¸€ä¸ªç‚¹éå¸¸å®¹æ˜“å¿½ç•¥ã€‚å¼€å‘åŸºç±»çš„æ¶æ„å¸ˆå°†åŸºç±»è®¾è®¡ä¸ºæœ‰çŠ¶æ€çš„ï¼Œä½†å¹¶ä¸çŸ¥é“å­ç±»æ˜¯æ€ä¹ˆä½¿ç”¨åŸºç±»çš„ï¼›è€Œå¼€å‘å­ç±»çš„åŒå­¦ï¼Œæ²¡å¤šæƒ³å°±ç›´æ¥æ ‡è®°äº†@Serviceï¼Œè®©ç±»æˆä¸ºäº†Beanï¼Œé€šè¿‡@Autowiredæ³¨è§£æ¥æ³¨å…¥è¿™ä¸ªæœåŠ¡ã€‚ä½†è¿™æ ·è®¾ç½®åï¼Œæœ‰çŠ¶æ€çš„åŸºç±»å°±å¯èƒ½äº§ç”Ÿå†…å­˜æ³„éœ²æˆ–çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚</p><p>æ­£ç¡®çš„æ–¹å¼æ˜¯ï¼Œ<strong>åœ¨ä¸ºç±»æ ‡è®°ä¸Š@Serviceæ³¨è§£æŠŠç±»å‹äº¤ç”±å®¹å™¨ç®¡ç†å‰ï¼Œé¦–å…ˆè¯„ä¼°ä¸€ä¸‹ç±»æ˜¯å¦æœ‰çŠ¶æ€ï¼Œç„¶åä¸ºBeanè®¾ç½®åˆé€‚çš„Scope</strong>ã€‚å¥½åœ¨ä¸Šçº¿å‰ï¼Œæ¶æ„å¸ˆå‘ç°äº†è¿™ä¸ªå†…å­˜æ³„éœ²é—®é¢˜ï¼Œå¼€å‘åŒå­¦ä¹Ÿåšäº†ä¿®æ”¹ï¼Œä¸ºSayHelloå’ŒSayByeä¸¤ä¸ªç±»éƒ½æ ‡è®°äº†@Scopeæ³¨è§£ï¼Œè®¾ç½®äº†PROTOTYPEçš„ç”Ÿå‘½å‘¨æœŸï¼Œä¹Ÿå°±æ˜¯å¤šä¾‹ï¼š</p><pre><code>@Scope(value = ConfigurableBeanFactory.SCOPE_PROTOTYPE)\n</code></pre><p>ä½†ï¼Œä¸Šçº¿åè¿˜æ˜¯å‡ºç°äº†å†…å­˜æ³„æ¼ï¼Œè¯æ˜ä¿®æ”¹æ˜¯æ— æ•ˆçš„ã€‚</p><p>ä»æ—¥å¿—å¯ä»¥çœ‹åˆ°ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨å’Œç¬¬äºŒæ¬¡è°ƒç”¨çš„æ—¶å€™ï¼ŒSayByeå¯¹è±¡éƒ½æ˜¯4c0bfe9eï¼ŒSayHelloä¹Ÿæ˜¯ä¸€æ ·çš„é—®é¢˜ã€‚ä»æ—¥å¿—ç¬¬7åˆ°10è¡Œè¿˜å¯ä»¥çœ‹åˆ°ï¼Œç¬¬äºŒæ¬¡è°ƒç”¨åListçš„å…ƒç´ ä¸ªæ•°å˜ä¸ºäº†2ï¼Œè¯´æ˜çˆ¶ç±»SayServiceç»´æŠ¤çš„Liståœ¨ä¸æ–­å¢é•¿ï¼Œä¸æ–­è°ƒç”¨å¿…ç„¶å‡ºç°OOMï¼š</p><pre><code>[15:01:09.349] [http-nio-45678-exec-1] [INFO ] [.s.d.BeanSingletonAndOrderController:22  ] - ====================\n[15:01:09.401] [http-nio-45678-exec-1] [INFO ] [o.g.t.c.spring.demo1.SayService         :19  ] - I'm org.geekbang.time.commonmistakes.spring.demo1.SayBye@4c0bfe9e size:1\n[15:01:09.402] [http-nio-45678-exec-1] [INFO ] [t.commonmistakes.spring.demo1.SayBye:16  ] - bye\n[15:01:09.469] [http-nio-45678-exec-1] [INFO ] [o.g.t.c.spring.demo1.SayService         :19  ] - I'm org.geekbang.time.commonmistakes.spring.demo1.SayHello@490fbeaa size:1\n[15:01:09.469] [http-nio-45678-exec-1] [INFO ] [o.g.t.c.spring.demo1.SayHello           :17  ] - hello\n[15:01:15.167] [http-nio-45678-exec-2] [INFO ] [.s.d.BeanSingletonAndOrderController:22  ] - ====================\n[15:01:15.197] [http-nio-45678-exec-2] [INFO ] [o.g.t.c.spring.demo1.SayService         :19  ] - I'm org.geekbang.time.commonmistakes.spring.demo1.SayBye@4c0bfe9e size:2\n[15:01:15.198] [http-nio-45678-exec-2] [INFO ] [t.commonmistakes.spring.demo1.SayBye:16  ] - bye\n[15:01:15.224] [http-nio-45678-exec-2] [INFO ] [o.g.t.c.spring.demo1.SayService         :19  ] - I'm org.geekbang.time.commonmistakes.spring.demo1.SayHello@490fbeaa size:2\n[15:01:15.224] [http-nio-45678-exec-2] [INFO ] [o.g.t.c.spring.demo1.SayHello           :17  ] - hello\n</code></pre><p>è¿™å°±å¼•å‡ºäº†å•ä¾‹çš„Beanå¦‚ä½•æ³¨å…¥Prototypeçš„Beanè¿™ä¸ªé—®é¢˜ã€‚Controlleræ ‡è®°äº†@RestControlleræ³¨è§£ï¼Œè€Œ@RestControlleræ³¨è§£=@Controlleræ³¨è§£+@ResponseBodyæ³¨è§£ï¼Œåˆå› ä¸º@Controlleræ ‡è®°äº†@Componentå…ƒæ³¨è§£ï¼Œæ‰€ä»¥@RestControlleræ³¨è§£å…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªSpring Beanï¼š</p><pre><code>//@RestControlleræ³¨è§£=@Controlleræ³¨è§£+@ResponseBodyæ³¨è§£@Target(ElementType.TYPE)\n@Retention(RetentionPolicy.RUNTIME)\n@Documented\n@Controller\n@ResponseBody\npublic @interface RestController {}\n\n//@Controlleråˆæ ‡è®°äº†@Componentå…ƒæ³¨è§£\n@Target({ElementType.TYPE})\n@Retention(RetentionPolicy.RUNTIME)\n@Documented\n@Component\npublic @interface Controller {}\n</code></pre><p><strong>Beané»˜è®¤æ˜¯å•ä¾‹çš„ï¼Œæ‰€ä»¥å•ä¾‹çš„Controlleræ³¨å…¥çš„Serviceä¹Ÿæ˜¯ä¸€æ¬¡æ€§åˆ›å»ºçš„ï¼Œå³ä½¿Serviceæœ¬èº«æ ‡è¯†äº†prototypeçš„èŒƒå›´ä¹Ÿæ²¡ç”¨ã€‚</strong></p><p>ä¿®å¤æ–¹å¼æ˜¯ï¼Œè®©Serviceä»¥ä»£ç†æ–¹å¼æ³¨å…¥ã€‚è¿™æ ·è™½ç„¶Controlleræœ¬èº«æ˜¯å•ä¾‹çš„ï¼Œä½†æ¯æ¬¡éƒ½èƒ½ä»ä»£ç†è·å–Serviceã€‚è¿™æ ·ä¸€æ¥ï¼ŒprototypeèŒƒå›´çš„é…ç½®æ‰èƒ½çœŸæ­£ç”Ÿæ•ˆï¼š</p><pre><code>@Scope(value = ConfigurableBeanFactory.SCOPE_PROTOTYPE, proxyMode = ScopedProxyMode.TARGET_CLASS)\n</code></pre><p>é€šè¿‡æ—¥å¿—å¯ä»¥ç¡®è®¤è¿™ç§ä¿®å¤æ–¹å¼æœ‰æ•ˆï¼š</p><pre><code>[15:08:42.649] [http-nio-45678-exec-1] [INFO ] [.s.d.BeanSingletonAndOrderController:22  ] - ====================\n[15:08:42.747] [http-nio-45678-exec-1] [INFO ] [o.g.t.c.spring.demo1.SayService         :19  ] - I'm org.geekbang.time.commonmistakes.spring.demo1.SayBye@3fa64743 size:1\n[15:08:42.747] [http-nio-45678-exec-1] [INFO ] [t.commonmistakes.spring.demo1.SayBye:17  ] - bye\n[15:08:42.871] [http-nio-45678-exec-1] [INFO ] [o.g.t.c.spring.demo1.SayService         :19  ] - I'm org.geekbang.time.commonmistakes.spring.demo1.SayHello@2f0b779 size:1\n[15:08:42.872] [http-nio-45678-exec-1] [INFO ] [o.g.t.c.spring.demo1.SayHello           :17  ] - hello\n[15:08:42.932] [http-nio-45678-exec-2] [INFO ] [.s.d.BeanSingletonAndOrderController:22  ] - ====================\n[15:08:42.991] [http-nio-45678-exec-2] [INFO ] [o.g.t.c.spring.demo1.SayService         :19  ] - I'm org.geekbang.time.commonmistakes.spring.demo1.SayBye@7319b18e size:1\n[15:08:42.992] [http-nio-45678-exec-2] [INFO ] [t.commonmistakes.spring.demo1.SayBye:17  ] - bye\n[15:08:43.046] [http-nio-45678-exec-2] [INFO ] [o.g.t.c.spring.demo1.SayService         :19  ] - I'm org.geekbang.time.commonmistakes.spring.demo1.SayHello@77262b35 size:1\n[15:08:43.046] [http-nio-45678-exec-2] [INFO ] [o.g.t.c.spring.demo1.SayHello           :17  ] - hello\n</code></pre><p>è°ƒè¯•ä¸€ä¸‹ä¹Ÿå¯ä»¥å‘ç°ï¼Œæ³¨å…¥çš„Serviceéƒ½æ˜¯Springç”Ÿæˆçš„ä»£ç†ç±»ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/a9/30/a95f7a5f3a576b3b426c7c5625b29230.png?wh=2082*264\" alt=\"\"></p><p>å½“ç„¶ï¼Œå¦‚æœä¸å¸Œæœ›èµ°ä»£ç†çš„è¯è¿˜æœ‰ä¸€ç§æ–¹å¼æ˜¯ï¼Œæ¯æ¬¡ç›´æ¥ä»ApplicationContextä¸­è·å–Beanï¼š</p><pre><code>@Autowired\nprivate ApplicationContext applicationContext;\n@GetMapping(&quot;test2&quot;)\npublic void test2() {\napplicationContext.getBeansOfType(SayService.class).values().forEach(SayService::say);\n}\n</code></pre><p>å¦‚æœç»†å¿ƒçš„è¯ï¼Œä½ å¯ä»¥å‘ç°å¦ä¸€ä¸ªæ½œåœ¨çš„é—®é¢˜ã€‚è¿™é‡ŒSpringæ³¨å…¥çš„SayServiceçš„Listï¼Œç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯SayByeï¼Œç¬¬äºŒä¸ªå…ƒç´ æ˜¯SayHelloã€‚ä½†ï¼Œæˆ‘ä»¬æ›´å¸Œæœ›çš„æ˜¯å…ˆæ‰§è¡ŒHelloå†æ‰§è¡ŒByeï¼Œæ‰€ä»¥æ³¨å…¥ä¸€ä¸ªList Beanæ—¶ï¼Œéœ€è¦è¿›ä¸€æ­¥è€ƒè™‘Beançš„é¡ºåºæˆ–è€…è¯´ä¼˜å…ˆçº§ã€‚</p><p>å¤§å¤šæ•°æƒ…å†µä¸‹é¡ºåºå¹¶ä¸æ˜¯é‚£ä¹ˆé‡è¦ï¼Œä½†å¯¹äºAOPï¼Œé¡ºåºå¯èƒ½ä¼šå¼•å‘è‡´å‘½é—®é¢˜ã€‚æˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹è¿™ä¸ªé—®é¢˜å§ã€‚</p><h2>ç›‘æ§åˆ‡é¢å› ä¸ºé¡ºåºé—®é¢˜å¯¼è‡´Springäº‹åŠ¡å¤±æ•ˆ</h2><p>å®ç°æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼Œæ˜¯AOPéå¸¸å¸¸è§çš„ä¸€ä¸ªåº”ç”¨ã€‚æˆ‘æ›¾çœ‹åˆ°è¿‡ä¸€ä¸ªä¸é”™çš„AOPå®è·µï¼Œé€šè¿‡AOPå®ç°äº†ä¸€ä¸ªæ•´åˆæ—¥å¿—è®°å½•ã€å¼‚å¸¸å¤„ç†å’Œæ–¹æ³•è€—æ—¶æ‰“ç‚¹ä¸ºä¸€ä½“çš„ç»Ÿä¸€åˆ‡é¢ã€‚ä½†åæ¥å‘ç°ï¼Œä½¿ç”¨äº†AOPåˆ‡é¢åï¼Œè¿™ä¸ªåº”ç”¨çš„å£°æ˜å¼äº‹åŠ¡å¤„ç†å±…ç„¶éƒ½æ˜¯æ— æ•ˆçš„ã€‚ä½ å¯ä»¥å…ˆå›é¡¾ä¸‹<a href=\"https://time.geekbang.org/column/article/213295\">ç¬¬6è®²</a>ä¸­æåˆ°çš„ï¼ŒSpringäº‹åŠ¡å¤±æ•ˆçš„å‡ ç§å¯èƒ½æ€§ã€‚</p><p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹ä¸‹è¿™ä¸ªæ¡ˆä¾‹ï¼Œåˆ†æä¸‹AOPå®ç°çš„ç›‘æ§ç»„ä»¶å’Œäº‹åŠ¡å¤±æ•ˆæœ‰ä»€ä¹ˆå…³ç³»ï¼Œä»¥åŠé€šè¿‡AOPå®ç°ç›‘æ§ç»„ä»¶æ˜¯å¦è¿˜æœ‰å…¶ä»–å‘ã€‚</p><p>é¦–å…ˆï¼Œå®šä¹‰ä¸€ä¸ªè‡ªå®šä¹‰æ³¨è§£Metricsï¼Œæ‰“ä¸Šäº†è¯¥æ³¨è§£çš„æ–¹æ³•å¯ä»¥å®ç°å„ç§ç›‘æ§åŠŸèƒ½ï¼š</p><pre><code>@Retention(RetentionPolicy.RUNTIME)\n@Target({ElementType.METHOD, ElementType.TYPE})\npublic @interface Metrics {\n    /**\n     * åœ¨æ–¹æ³•æˆåŠŸæ‰§è¡Œåæ‰“ç‚¹ï¼Œè®°å½•æ–¹æ³•çš„æ‰§è¡Œæ—¶é—´å‘é€åˆ°æŒ‡æ ‡ç³»ç»Ÿï¼Œé»˜è®¤å¼€å¯\n     *\n     * @return\n     */\n    boolean recordSuccessMetrics() default true;\n\n    /**\n     * åœ¨æ–¹æ³•æˆåŠŸå¤±è´¥åæ‰“ç‚¹ï¼Œè®°å½•æ–¹æ³•çš„æ‰§è¡Œæ—¶é—´å‘é€åˆ°æŒ‡æ ‡ç³»ç»Ÿï¼Œé»˜è®¤å¼€å¯\n     *\n     * @return\n     */\n    boolean recordFailMetrics() default true;\n\n    /**\n     * é€šè¿‡æ—¥å¿—è®°å½•è¯·æ±‚å‚æ•°ï¼Œé»˜è®¤å¼€å¯\n     *\n     * @return\n     */\n    boolean logParameters() default true;\n\n    /**\n     * é€šè¿‡æ—¥å¿—è®°å½•æ–¹æ³•è¿”å›å€¼ï¼Œé»˜è®¤å¼€å¯\n     *\n     * @return\n     */\n    boolean logReturn() default true;\n\n    /**\n     * å‡ºç°å¼‚å¸¸åé€šè¿‡æ—¥å¿—è®°å½•å¼‚å¸¸ä¿¡æ¯ï¼Œé»˜è®¤å¼€å¯\n     *\n     * @return\n     */\n    boolean logException() default true;\n\n    /**\n     * å‡ºç°å¼‚å¸¸åå¿½ç•¥å¼‚å¸¸è¿”å›é»˜è®¤å€¼ï¼Œé»˜è®¤å…³é—­\n     *\n     * @return\n     */\n    boolean ignoreException() default false;\n}\n</code></pre><p>ç„¶åï¼Œå®ç°ä¸€ä¸ªåˆ‡é¢å®ŒæˆMetricsæ³¨è§£æä¾›çš„åŠŸèƒ½ã€‚è¿™ä¸ªåˆ‡é¢å¯ä»¥å®ç°æ ‡è®°äº†@RestControlleræ³¨è§£çš„Webæ§åˆ¶å™¨çš„è‡ªåŠ¨åˆ‡å…¥ï¼Œå¦‚æœè¿˜éœ€è¦å¯¹æ›´å¤šBeanè¿›è¡Œåˆ‡å…¥çš„è¯ï¼Œå†è‡ªè¡Œæ ‡è®°@Metricsæ³¨è§£ã€‚</p><blockquote>\n<p>å¤‡æ³¨ï¼šè¿™æ®µä»£ç æœ‰äº›é•¿ï¼Œé‡Œé¢è¿˜ç”¨åˆ°äº†ä¸€äº›å°æŠ€å·§ï¼Œä½ éœ€è¦ä»”ç»†é˜…è¯»ä»£ç ä¸­çš„æ³¨é‡Šã€‚</p>\n</blockquote><pre><code>@Aspect\n@Component\n@Slf4j\npublic class MetricsAspect {\n    //è®©Springå¸®æˆ‘ä»¬æ³¨å…¥ObjectMapperï¼Œä»¥æ–¹ä¾¿é€šè¿‡JSONåºåˆ—åŒ–æ¥è®°å½•æ–¹æ³•å…¥å‚å’Œå‡ºå‚\n    \n    @Autowired\n    private ObjectMapper objectMapper;\n\n    //å®ç°ä¸€ä¸ªè¿”å›JavaåŸºæœ¬ç±»å‹é»˜è®¤å€¼çš„å·¥å…·ã€‚å…¶å®ï¼Œä½ ä¹Ÿå¯ä»¥é€ä¸€å†™å¾ˆå¤šif-elseåˆ¤æ–­ç±»å‹ï¼Œç„¶åæ‰‹åŠ¨è®¾ç½®å…¶é»˜è®¤å€¼ã€‚è¿™é‡Œä¸ºäº†å‡å°‘ä»£ç é‡ç”¨äº†ä¸€ä¸ªå°æŠ€å·§ï¼Œå³é€šè¿‡åˆå§‹åŒ–ä¸€ä¸ªå…·æœ‰1ä¸ªå…ƒç´ çš„æ•°ç»„ï¼Œç„¶åé€šè¿‡è·å–è¿™ä¸ªæ•°ç»„çš„å€¼æ¥è·å–åŸºæœ¬ç±»å‹é»˜è®¤å€¼\n    private static final Map&lt;Class&lt;?&gt;, Object&gt; DEFAULT_VALUES = Stream\n            .of(boolean.class, byte.class, char.class, double.class, float.class, int.class, long.class, short.class)\n            .collect(toMap(clazz -&gt; (Class&lt;?&gt;) clazz, clazz -&gt; Array.get(Array.newInstance(clazz, 1), 0)));\n    public static &lt;T&gt; T getDefaultValue(Class&lt;T&gt; clazz) {\n        return (T) DEFAULT_VALUES.get(clazz);\n    }\n\n    //@annotationæŒ‡ç¤ºå™¨å®ç°å¯¹æ ‡è®°äº†Metricsæ³¨è§£çš„æ–¹æ³•è¿›è¡ŒåŒ¹é…\n   @Pointcut(&quot;within(@org.geekbang.time.commonmistakes.springpart1.aopmetrics.Metrics *)&quot;)\n    public void withMetricsAnnotation() {\n    }\n\n    //withinæŒ‡ç¤ºå™¨å®ç°äº†åŒ¹é…é‚£äº›ç±»å‹ä¸Šæ ‡è®°äº†@RestControlleræ³¨è§£çš„æ–¹æ³•\n    @Pointcut(&quot;within(@org.springframework.web.bind.annotation.RestController *)&quot;)\n    public void controllerBean() {\n    }\n\n    @Around(&quot;controllerBean() || withMetricsAnnotation())&quot;)\n    public Object metrics(ProceedingJoinPoint pjp) throws Throwable {\n        //é€šè¿‡è¿æ¥ç‚¹è·å–æ–¹æ³•ç­¾åå’Œæ–¹æ³•ä¸ŠMetricsæ³¨è§£ï¼Œå¹¶æ ¹æ®æ–¹æ³•ç­¾åç”Ÿæˆæ—¥å¿—ä¸­è¦è¾“å‡ºçš„æ–¹æ³•å®šä¹‰æè¿°\n        MethodSignature signature = (MethodSignature) pjp.getSignature();\n        Metrics metrics = signature.getMethod().getAnnotation(Metrics.class);\n \n        String name = String.format(&quot;ã€%sã€‘ã€%sã€‘&quot;, signature.getDeclaringType().toString(), signature.toLongString());\n        //å› ä¸ºéœ€è¦é»˜è®¤å¯¹æ‰€æœ‰@RestControlleræ ‡è®°çš„Webæ§åˆ¶å™¨å®ç°@Metricsæ³¨è§£çš„åŠŸèƒ½ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹æ–¹æ³•ä¸Šå¿…ç„¶æ˜¯æ²¡æœ‰@Metricsæ³¨è§£çš„ï¼Œæˆ‘ä»¬éœ€è¦è·å–ä¸€ä¸ªé»˜è®¤æ³¨è§£ã€‚è™½ç„¶å¯ä»¥æ‰‹åŠ¨å®ä¾‹åŒ–ä¸€ä¸ª@Metricsæ³¨è§£çš„å®ä¾‹å‡ºæ¥ï¼Œä½†ä¸ºäº†èŠ‚çœä»£ç è¡Œæ•°ï¼Œæˆ‘ä»¬é€šè¿‡åœ¨ä¸€ä¸ªå†…éƒ¨ç±»ä¸Šå®šä¹‰@Metricsæ³¨è§£æ–¹å¼ï¼Œç„¶åé€šè¿‡åå°„è·å–æ³¨è§£çš„å°æŠ€å·§ï¼Œæ¥è·å¾—ä¸€ä¸ªé»˜è®¤çš„@Metricsæ³¨è§£çš„å®ä¾‹\n        if (metrics == null) {\n            @Metrics\n            final class c {}\n            metrics = c.class.getAnnotation(Metrics.class);\n        }\n        //å°è¯•ä»è¯·æ±‚ä¸Šä¸‹æ–‡ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰è·å¾—è¯·æ±‚URLï¼Œä»¥æ–¹ä¾¿å®šä½é—®é¢˜\n        RequestAttributes requestAttributes = RequestContextHolder.getRequestAttributes();\n        if (requestAttributes != null) {\n            HttpServletRequest request = ((ServletRequestAttributes) requestAttributes).getRequest();\n            if (request != null)\n                name += String.format(&quot;ã€%sã€‘&quot;, request.getRequestURL().toString());\n        }\n        //å®ç°çš„æ˜¯å…¥å‚çš„æ—¥å¿—è¾“å‡º\n        if (metrics.logParameters())\n            log.info(String.format(&quot;ã€å…¥å‚æ—¥å¿—ã€‘è°ƒç”¨ %s çš„å‚æ•°æ˜¯ï¼šã€%sã€‘&quot;, name, objectMapper.writeValueAsString(pjp.getArgs())));\n        //å®ç°è¿æ¥ç‚¹æ–¹æ³•çš„æ‰§è¡Œï¼Œä»¥åŠæˆåŠŸå¤±è´¥çš„æ‰“ç‚¹ï¼Œå‡ºç°å¼‚å¸¸çš„æ—¶å€™è¿˜ä¼šè®°å½•æ—¥å¿—\n        Object returnValue;\n        Instant start = Instant.now();\n        try {\n            returnValue = pjp.proceed();\n            if (metrics.recordSuccessMetrics())\n                //åœ¨ç”Ÿäº§çº§ä»£ç ä¸­ï¼Œæˆ‘ä»¬åº”è€ƒè™‘ä½¿ç”¨ç±»ä¼¼Micrometerçš„æŒ‡æ ‡æ¡†æ¶ï¼ŒæŠŠæ‰“ç‚¹ä¿¡æ¯è®°å½•åˆ°æ—¶é—´åºåˆ—æ•°æ®åº“ä¸­ï¼Œå®ç°é€šè¿‡å›¾è¡¨æ¥æŸ¥çœ‹æ–¹æ³•çš„è°ƒç”¨æ¬¡æ•°å’Œæ‰§è¡Œæ—¶é—´ï¼Œåœ¨è®¾è®¡ç¯‡æˆ‘ä»¬ä¼šé‡ç‚¹ä»‹ç»\n                log.info(String.format(&quot;ã€æˆåŠŸæ‰“ç‚¹ã€‘è°ƒç”¨ %s æˆåŠŸï¼Œè€—æ—¶ï¼š%d ms&quot;, name, Duration.between(start, Instant.now()).toMillis()));\n        } catch (Exception ex) {\n            if (metrics.recordFailMetrics())\n                log.info(String.format(&quot;ã€å¤±è´¥æ‰“ç‚¹ã€‘è°ƒç”¨ %s å¤±è´¥ï¼Œè€—æ—¶ï¼š%d ms&quot;, name, Duration.between(start, Instant.now()).toMillis()));\n            if (metrics.logException())\n                log.error(String.format(&quot;ã€å¼‚å¸¸æ—¥å¿—ã€‘è°ƒç”¨ %s å‡ºç°å¼‚å¸¸ï¼&quot;, name), ex);\n\n            //å¿½ç•¥å¼‚å¸¸çš„æ—¶å€™ï¼Œä½¿ç”¨ä¸€å¼€å§‹å®šä¹‰çš„getDefaultValueæ–¹æ³•ï¼Œæ¥è·å–åŸºæœ¬ç±»å‹çš„é»˜è®¤å€¼\n            if (metrics.ignoreException())\n                returnValue = getDefaultValue(signature.getReturnType());\n            else\n                throw ex;\n        }\n        //å®ç°äº†è¿”å›å€¼çš„æ—¥å¿—è¾“å‡º\n        if (metrics.logReturn())\n            log.info(String.format(&quot;ã€å‡ºå‚æ—¥å¿—ã€‘è°ƒç”¨ %s çš„è¿”å›æ˜¯ï¼šã€%sã€‘&quot;, name, returnValue));\n        return returnValue;\n    }\n}\n</code></pre><p>æ¥ä¸‹æ¥ï¼Œåˆ†åˆ«å®šä¹‰æœ€ç®€å•çš„Controllerã€Serviceå’ŒRepositoryï¼Œæ¥æµ‹è¯•MetricsAspectçš„åŠŸèƒ½ã€‚</p><p>å…¶ä¸­ï¼ŒServiceä¸­å®ç°åˆ›å»ºç”¨æˆ·çš„æ—¶å€™åšäº†äº‹åŠ¡å¤„ç†ï¼Œå½“ç”¨æˆ·ååŒ…å«testå­—æ ·æ—¶ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå¯¼è‡´äº‹åŠ¡å›æ»šã€‚åŒæ—¶ï¼Œæˆ‘ä»¬ä¸ºServiceä¸­çš„createUseræ ‡è®°äº†@Metricsæ³¨è§£ã€‚è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æ‰‹åŠ¨ä¸ºç±»æˆ–æ–¹æ³•æ ‡è®°@Metricsæ³¨è§£ï¼Œå®ç°Controllerä¹‹å¤–çš„å…¶ä»–ç»„ä»¶çš„è‡ªåŠ¨ç›‘æ§ã€‚</p><pre><code>@Slf4j\n@RestController //è‡ªåŠ¨è¿›è¡Œç›‘æ§\n@RequestMapping(&quot;metricstest&quot;)\npublic class MetricsController {\n    @Autowired\n    private UserService userService;\n    @GetMapping(&quot;transaction&quot;)\n    public int transaction(@RequestParam(&quot;name&quot;) String name) {\n        try {\n            userService.createUser(new UserEntity(name));\n        } catch (Exception ex) {\n            log.error(&quot;create user failed because {}&quot;, ex.getMessage());\n        }\n        return userService.getUserCount(name);\n    }\n}\n\n@Service\n@Slf4j\npublic class UserService {\n    @Autowired\n    private UserRepository userRepository;\n    @Transactional\n    @Metrics //å¯ç”¨æ–¹æ³•ç›‘æ§\n    public void createUser(UserEntity entity) {\n        userRepository.save(entity);\n        if (entity.getName().contains(&quot;test&quot;))\n            throw new RuntimeException(&quot;invalid username!&quot;);\n    }\n\n    public int getUserCount(String name) {\n        return userRepository.findByName(name).size();\n    }\n}\n\n@Repository\npublic interface UserRepository extends JpaRepository&lt;UserEntity, Long&gt; {\n    List&lt;UserEntity&gt; findByName(String name);\n}\n</code></pre><p>ä½¿ç”¨ç”¨æˆ·åâ€œtestâ€æµ‹è¯•ä¸€ä¸‹æ³¨å†ŒåŠŸèƒ½ï¼š</p><pre><code>[16:27:52.586] [http-nio-45678-exec-3] [INFO ] [o.g.t.c.spring.demo2.MetricsAspect      :85  ] - ã€å…¥å‚æ—¥å¿—ã€‘è°ƒç”¨ ã€class org.geekbang.time.commonmistakes.spring.demo2.MetricsControllerã€‘ã€public int org.geekbang.time.commonmistakes.spring.demo2.MetricsController.transaction(java.lang.String)ã€‘ã€http://localhost:45678/metricstest/transactionã€‘ çš„å‚æ•°æ˜¯ï¼šã€[&quot;test&quot;]ã€‘\n[16:27:52.590] [http-nio-45678-exec-3] [INFO ] [o.g.t.c.spring.demo2.MetricsAspect      :85  ] - ã€å…¥å‚æ—¥å¿—ã€‘è°ƒç”¨ ã€class org.geekbang.time.commonmistakes.spring.demo2.UserServiceã€‘ã€public void org.geekbang.time.commonmistakes.spring.demo2.UserService.createUser(org.geekbang.time.commonmistakes.spring.demo2.UserEntity)ã€‘ã€http://localhost:45678/metricstest/transactionã€‘ çš„å‚æ•°æ˜¯ï¼šã€[{&quot;id&quot;:null,&quot;name&quot;:&quot;test&quot;}]ã€‘\n[16:27:52.609] [http-nio-45678-exec-3] [INFO ] [o.g.t.c.spring.demo2.MetricsAspect      :96  ] - ã€å¤±è´¥æ‰“ç‚¹ã€‘è°ƒç”¨ ã€class org.geekbang.time.commonmistakes.spring.demo2.UserServiceã€‘ã€public void org.geekbang.time.commonmistakes.spring.demo2.UserService.createUser(org.geekbang.time.commonmistakes.spring.demo2.UserEntity)ã€‘ã€http://localhost:45678/metricstest/transactionã€‘ å¤±è´¥ï¼Œè€—æ—¶ï¼š19 ms\n[16:27:52.610] [http-nio-45678-exec-3] [ERROR] [o.g.t.c.spring.demo2.MetricsAspect      :98  ] - ã€å¼‚å¸¸æ—¥å¿—ã€‘è°ƒç”¨ ã€class org.geekbang.time.commonmistakes.spring.demo2.UserServiceã€‘ã€public void org.geekbang.time.commonmistakes.spring.demo2.UserService.createUser(org.geekbang.time.commonmistakes.spring.demo2.UserEntity)ã€‘ã€http://localhost:45678/metricstest/transactionã€‘ å‡ºç°å¼‚å¸¸ï¼\njava.lang.RuntimeException: invalid username!\n\tat org.geekbang.time.commonmistakes.spring.demo2.UserService.createUser(UserService.java:18)\n\tat org.geekbang.time.commonmistakes.spring.demo2.UserService$$FastClassBySpringCGLIB$$9eec91f.invoke(&lt;generated&gt;)\n[16:27:52.614] [http-nio-45678-exec-3] [ERROR] [g.t.c.spring.demo2.MetricsController:21  ] - create user failed because invalid username!\n[16:27:52.617] [http-nio-45678-exec-3] [INFO ] [o.g.t.c.spring.demo2.MetricsAspect      :93  ] - ã€æˆåŠŸæ‰“ç‚¹ã€‘è°ƒç”¨ ã€class org.geekbang.time.commonmistakes.spring.demo2.MetricsControllerã€‘ã€public int org.geekbang.time.commonmistakes.spring.demo2.MetricsController.transaction(java.lang.String)ã€‘ã€http://localhost:45678/metricstest/transactionã€‘ æˆåŠŸï¼Œè€—æ—¶ï¼š31 ms\n[16:27:52.618] [http-nio-45678-exec-3] [INFO ] [o.g.t.c.spring.demo2.MetricsAspect      :108 ] - ã€å‡ºå‚æ—¥å¿—ã€‘è°ƒç”¨ ã€class org.geekbang.time.commonmistakes.spring.demo2.MetricsControllerã€‘ã€public int org.geekbang.time.commonmistakes.spring.demo2.MetricsController.transaction(java.lang.String)ã€‘ã€http://localhost:45678/metricstest/transactionã€‘ çš„è¿”å›æ˜¯ï¼šã€0ã€‘\n</code></pre><p>çœ‹èµ·æ¥è¿™ä¸ªåˆ‡é¢å¾ˆä¸é”™ï¼Œæ—¥å¿—ä¸­æ‰“å‡ºäº†æ•´ä¸ªè°ƒç”¨çš„å‡ºå…¥å‚ã€æ–¹æ³•è€—æ—¶ï¼š</p><ul>\n<li>ç¬¬1ã€8ã€9å’Œ10è¡Œåˆ†åˆ«æ˜¯Controlleræ–¹æ³•çš„å…¥å‚æ—¥å¿—ã€è°ƒç”¨Serviceæ–¹æ³•å‡ºé”™åè®°å½•çš„é”™è¯¯ä¿¡æ¯ã€æˆåŠŸæ‰§è¡Œçš„æ‰“ç‚¹å’Œå‡ºå‚æ—¥å¿—ã€‚å› ä¸ºControlleræ–¹æ³•å†…éƒ¨è¿›è¡Œäº†try-catchå¤„ç†ï¼Œæ‰€ä»¥å…¶æ–¹æ³•æœ€ç»ˆæ˜¯æˆåŠŸæ‰§è¡Œçš„ã€‚å‡ºå‚æ—¥å¿—ä¸­æ˜¾ç¤ºæœ€åæŸ¥è¯¢åˆ°çš„ç”¨æˆ·æ•°é‡æ˜¯0ï¼Œè¡¨ç¤ºç”¨æˆ·åˆ›å»ºå®é™…æ˜¯å¤±è´¥çš„ã€‚</li>\n<li>ç¬¬2ã€3å’Œ4~7è¡Œåˆ†åˆ«æ˜¯Serviceæ–¹æ³•çš„å…¥å‚æ—¥å¿—ã€å¤±è´¥æ‰“ç‚¹å’Œå¼‚å¸¸æ—¥å¿—ã€‚æ­£æ˜¯å› ä¸ºServiceæ–¹æ³•çš„å¼‚å¸¸æŠ›åˆ°äº†Controllerï¼Œæ‰€ä»¥æ•´ä¸ªæ–¹æ³•æ‰èƒ½è¢«@Transactionalå£°æ˜å¼äº‹åŠ¡å›æ»šã€‚åœ¨è¿™é‡Œï¼ŒMetricsAspectæ•è·äº†å¼‚å¸¸åˆé‡æ–°æŠ›å‡ºï¼Œè®°å½•äº†å¼‚å¸¸çš„åŒæ—¶åˆä¸å½±å“äº‹åŠ¡å›æ»šã€‚</li>\n</ul><p>ä¸€æ®µæ—¶é—´åï¼Œå¼€å‘åŒå­¦è§‰å¾—é»˜è®¤çš„@Metricsé…ç½®æœ‰ç‚¹ä¸åˆé€‚ï¼Œå¸Œæœ›è¿›è¡Œä¸¤ä¸ªè°ƒæ•´ï¼š</p><ul>\n<li>å¯¹äºControllerçš„è‡ªåŠ¨æ‰“ç‚¹ï¼Œä¸è¦è‡ªåŠ¨è®°å½•å…¥å‚å’Œå‡ºå‚æ—¥å¿—ï¼Œå¦åˆ™æ—¥å¿—é‡å¤ªå¤§ï¼›</li>\n<li>å¯¹äºServiceä¸­çš„æ–¹æ³•ï¼Œæœ€å¥½å¯ä»¥è‡ªåŠ¨æ•è·å¼‚å¸¸ã€‚</li>\n</ul><p>äºæ˜¯ï¼Œä»–å°±ä¸ºMetricsControlleræ‰‹åŠ¨åŠ ä¸Šäº†@Metricsæ³¨è§£ï¼Œè®¾ç½®logParameterså’ŒlogReturnä¸ºfalseï¼›ç„¶åä¸ºServiceä¸­çš„createUseræ–¹æ³•çš„@Metricsæ³¨è§£ï¼Œè®¾ç½®äº†ignoreExceptionå±æ€§ä¸ºtrueï¼š</p><pre><code>@Metrics(logParameters = false, logReturn = false) //æ”¹åŠ¨ç‚¹1\npublic class MetricsController {\n\n@Service\n@Slf4j\npublic class UserService {\n    @Transactional\n    @Metrics(ignoreException = true) //æ”¹åŠ¨ç‚¹2\n    public void createUser(UserEntity entity) {\n    ...\n</code></pre><p>ä»£ç ä¸Šçº¿åå‘ç°æ—¥å¿—é‡å¹¶æ²¡æœ‰å‡å°‘ï¼Œæ›´è¦å‘½çš„æ˜¯äº‹åŠ¡å›æ»šå¤±æ•ˆäº†ï¼Œä»è¾“å‡ºçœ‹åˆ°æœ€åæŸ¥è¯¢åˆ°äº†åä¸ºtestçš„ç”¨æˆ·ï¼š</p><pre><code>[17:01:16.549] [http-nio-45678-exec-1] [INFO ] [o.g.t.c.spring.demo2.MetricsAspect      :75  ] - ã€å…¥å‚æ—¥å¿—ã€‘è°ƒç”¨ ã€class org.geekbang.time.commonmistakes.spring.demo2.MetricsControllerã€‘ã€public int org.geekbang.time.commonmistakes.spring.demo2.MetricsController.transaction(java.lang.String)ã€‘ã€http://localhost:45678/metricstest/transactionã€‘ çš„å‚æ•°æ˜¯ï¼šã€[&quot;test&quot;]ã€‘\n[17:01:16.670] [http-nio-45678-exec-1] [INFO ] [o.g.t.c.spring.demo2.MetricsAspect      :75  ] - ã€å…¥å‚æ—¥å¿—ã€‘è°ƒç”¨ ã€class org.geekbang.time.commonmistakes.spring.demo2.UserServiceã€‘ã€public void org.geekbang.time.commonmistakes.spring.demo2.UserService.createUser(org.geekbang.time.commonmistakes.spring.demo2.UserEntity)ã€‘ã€http://localhost:45678/metricstest/transactionã€‘ çš„å‚æ•°æ˜¯ï¼šã€[{&quot;id&quot;:null,&quot;name&quot;:&quot;test&quot;}]ã€‘\n[17:01:16.885] [http-nio-45678-exec-1] [INFO ] [o.g.t.c.spring.demo2.MetricsAspect      :86  ] - ã€å¤±è´¥æ‰“ç‚¹ã€‘è°ƒç”¨ ã€class org.geekbang.time.commonmistakes.spring.demo2.UserServiceã€‘ã€public void org.geekbang.time.commonmistakes.spring.demo2.UserService.createUser(org.geekbang.time.commonmistakes.spring.demo2.UserEntity)ã€‘ã€http://localhost:45678/metricstest/transactionã€‘ å¤±è´¥ï¼Œè€—æ—¶ï¼š211 ms\n[17:01:16.899] [http-nio-45678-exec-1] [ERROR] [o.g.t.c.spring.demo2.MetricsAspect      :88  ] - ã€å¼‚å¸¸æ—¥å¿—ã€‘è°ƒç”¨ ã€class org.geekbang.time.commonmistakes.spring.demo2.UserServiceã€‘ã€public void org.geekbang.time.commonmistakes.spring.demo2.UserService.createUser(org.geekbang.time.commonmistakes.spring.demo2.UserEntity)ã€‘ã€http://localhost:45678/metricstest/transactionã€‘ å‡ºç°å¼‚å¸¸ï¼\njava.lang.RuntimeException: invalid username!\n\tat org.geekbang.time.commonmistakes.spring.demo2.UserService.createUser(UserService.java:18)\n\tat org.geekbang.time.commonmistakes.spring.demo2.UserService$$FastClassBySpringCGLIB$$9eec91f.invoke(&lt;generated&gt;)\n[17:01:16.902] [http-nio-45678-exec-1] [INFO ] [o.g.t.c.spring.demo2.MetricsAspect      :98  ] - ã€å‡ºå‚æ—¥å¿—ã€‘è°ƒç”¨ ã€class org.geekbang.time.commonmistakes.spring.demo2.UserServiceã€‘ã€public void org.geekbang.time.commonmistakes.spring.demo2.UserService.createUser(org.geekbang.time.commonmistakes.spring.demo2.UserEntity)ã€‘ã€http://localhost:45678/metricstest/transactionã€‘ çš„è¿”å›æ˜¯ï¼šã€nullã€‘\n[17:01:17.466] [http-nio-45678-exec-1] [INFO ] [o.g.t.c.spring.demo2.MetricsAspect      :83  ] - ã€æˆåŠŸæ‰“ç‚¹ã€‘è°ƒç”¨ ã€class org.geekbang.time.commonmistakes.spring.demo2.MetricsControllerã€‘ã€public int org.geekbang.time.commonmistakes.spring.demo2.MetricsController.transaction(java.lang.String)ã€‘ã€http://localhost:45678/metricstest/transactionã€‘ æˆåŠŸï¼Œè€—æ—¶ï¼š915 ms\n[17:01:17.467] [http-nio-45678-exec-1] [INFO ] [o.g.t.c.spring.demo2.MetricsAspect      :98  ] - ã€å‡ºå‚æ—¥å¿—ã€‘è°ƒç”¨ ã€class org.geekbang.time.commonmistakes.spring.demo2.MetricsControllerã€‘ã€public int org.geekbang.time.commonmistakes.spring.demo2.MetricsController.transaction(java.lang.String)ã€‘ã€http://localhost:45678/metricstest/transactionã€‘ çš„è¿”å›æ˜¯ï¼šã€1ã€‘\n</code></pre><p>åœ¨ä»‹ç»<a href=\"https://time.geekbang.org/column/article/213295\">æ•°æ®åº“äº‹åŠ¡</a>æ—¶ï¼Œæˆ‘ä»¬åˆ†æäº†Springé€šè¿‡TransactionAspectSupportç±»å®ç°äº‹åŠ¡ã€‚åœ¨invokeWithinTransactionæ–¹æ³•ä¸­è®¾ç½®æ–­ç‚¹å¯ä»¥å‘ç°ï¼Œåœ¨æ‰§è¡ŒServiceçš„createUseræ–¹æ³•æ—¶ï¼ŒTransactionAspectSupportå¹¶æ²¡æœ‰æ•è·åˆ°å¼‚å¸¸ï¼Œæ‰€ä»¥è‡ªç„¶æ— æ³•å›æ»šäº‹åŠ¡ã€‚åŸå› å°±æ˜¯ï¼Œ<strong>å¼‚å¸¸è¢«MetricsAspectåƒæ‰äº†</strong>ã€‚</p><p>æˆ‘ä»¬çŸ¥é“ï¼Œåˆ‡é¢æœ¬èº«æ˜¯ä¸€ä¸ªBeanï¼ŒSpringå¯¹ä¸åŒåˆ‡é¢å¢å¼ºçš„æ‰§è¡Œé¡ºåºæ˜¯ç”±Beanä¼˜å…ˆçº§å†³å®šçš„ï¼Œå…·ä½“è§„åˆ™æ˜¯ï¼š</p><ul>\n<li>å…¥æ“ä½œï¼ˆAroundï¼ˆè¿æ¥ç‚¹æ‰§è¡Œå‰ï¼‰ã€Beforeï¼‰ï¼Œåˆ‡é¢ä¼˜å…ˆçº§è¶Šé«˜ï¼Œè¶Šå…ˆæ‰§è¡Œã€‚ä¸€ä¸ªåˆ‡é¢çš„å…¥æ“ä½œæ‰§è¡Œå®Œï¼Œæ‰è½®åˆ°ä¸‹ä¸€åˆ‡é¢ï¼Œæ‰€æœ‰åˆ‡é¢å…¥æ“ä½œæ‰§è¡Œå®Œï¼Œæ‰å¼€å§‹æ‰§è¡Œè¿æ¥ç‚¹ï¼ˆæ–¹æ³•ï¼‰ã€‚</li>\n<li>å‡ºæ“ä½œï¼ˆAroundï¼ˆè¿æ¥ç‚¹æ‰§è¡Œåï¼‰ã€Afterã€AfterReturningã€AfterThrowingï¼‰ï¼Œåˆ‡é¢ä¼˜å…ˆçº§è¶Šä½ï¼Œè¶Šå…ˆæ‰§è¡Œã€‚ä¸€ä¸ªåˆ‡é¢çš„å‡ºæ“ä½œæ‰§è¡Œå®Œï¼Œæ‰è½®åˆ°ä¸‹ä¸€åˆ‡é¢ï¼Œç›´åˆ°è¿”å›åˆ°è°ƒç”¨ç‚¹ã€‚</li>\n<li>åŒä¸€åˆ‡é¢çš„Aroundæ¯”Afterã€Beforeå…ˆæ‰§è¡Œã€‚</li>\n</ul><p>å¯¹äºBeanå¯ä»¥é€šè¿‡@Orderæ³¨è§£æ¥è®¾ç½®ä¼˜å…ˆçº§ï¼ŒæŸ¥çœ‹@Orderæ³¨è§£å’ŒOrderedæ¥å£æºç å¯ä»¥å‘ç°ï¼Œé»˜è®¤æƒ…å†µä¸‹Beançš„ä¼˜å…ˆçº§ä¸ºæœ€ä½ä¼˜å…ˆçº§ï¼Œå…¶å€¼æ˜¯Integerçš„æœ€å¤§å€¼ã€‚å…¶å®ï¼Œ<strong>å€¼è¶Šå¤§ä¼˜å…ˆçº§åè€Œè¶Šä½ï¼Œè¿™ç‚¹æ¯”è¾ƒåç›´è§‰</strong>ï¼š</p><pre><code>@Retention(RetentionPolicy.RUNTIME)\n@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD})\n@Documented\npublic @interface Order {\n\n   int value() default Ordered.LOWEST_PRECEDENCE;\n\n}\npublic interface Ordered {\n   int HIGHEST_PRECEDENCE = Integer.MIN_VALUE;\n   int LOWEST_PRECEDENCE = Integer.MAX_VALUE;\n   int getOrder();\n}\n</code></pre><p>æˆ‘ä»¬å†é€šè¿‡ä¸€ä¸ªä¾‹å­ï¼Œæ¥ç†è§£ä¸‹å¢å¼ºçš„æ‰§è¡Œé¡ºåºã€‚æ–°å»ºä¸€ä¸ªTestAspectWithOrder10åˆ‡é¢ï¼Œé€šè¿‡@Orderæ³¨è§£è®¾ç½®ä¼˜å…ˆçº§ä¸º10ï¼Œåœ¨å†…éƒ¨å®šä¹‰@Beforeã€@Afterã€@Aroundä¸‰ç±»å¢å¼ºï¼Œä¸‰ä¸ªå¢å¼ºçš„é€»è¾‘åªæ˜¯ç®€å•çš„æ—¥å¿—è¾“å‡ºï¼Œåˆ‡ç‚¹æ˜¯TestControlleræ‰€æœ‰æ–¹æ³•ï¼›ç„¶åå†å®šä¹‰ä¸€ä¸ªç±»ä¼¼çš„TestAspectWithOrder20åˆ‡é¢ï¼Œè®¾ç½®ä¼˜å…ˆçº§ä¸º20ï¼š</p><pre><code>@Aspect\n@Component\n@Order(10)\n@Slf4j\npublic class TestAspectWithOrder10 {\n    @Before(&quot;execution(* org.geekbang.time.commonmistakes.springpart1.aopmetrics.TestController.*(..))&quot;)\n    public void before(JoinPoint joinPoint) throws Throwable {\n        log.info(&quot;TestAspectWithOrder10 @Before&quot;);\n    }\n    @After(&quot;execution(* org.geekbang.time.commonmistakes.springpart1.aopmetrics.TestController.*(..))&quot;)\n    public void after(JoinPoint joinPoint) throws Throwable {\n        log.info(&quot;TestAspectWithOrder10 @After&quot;);\n    }\n    @Around(&quot;execution(* org.geekbang.time.commonmistakes.springpart1.aopmetrics.TestController.*(..))&quot;)\n    public Object around(ProceedingJoinPoint pjp) throws Throwable {\n        log.info(&quot;TestAspectWithOrder10 @Around before&quot;);\n        Object o = pjp.proceed();\n        log.info(&quot;TestAspectWithOrder10 @Around after&quot;);\n        return o;\n    }\n}\n\n@Aspect\n@Component\n@Order(20)\n@Slf4j\npublic class TestAspectWithOrder20 {\n\t...\n}\n</code></pre><p>è°ƒç”¨TestControllerçš„æ–¹æ³•åï¼Œé€šè¿‡æ—¥å¿—è¾“å‡ºå¯ä»¥çœ‹åˆ°ï¼Œå¢å¼ºæ‰§è¡Œé¡ºåºç¬¦åˆåˆ‡é¢æ‰§è¡Œé¡ºåºçš„ä¸‰ä¸ªè§„åˆ™ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/3c/3e/3c687829083abebe1d6e347f5766903e.png?wh=782*676\" alt=\"\"></p><p>å› ä¸ºSpringçš„äº‹åŠ¡ç®¡ç†ä¹Ÿæ˜¯åŸºäºAOPçš„ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¼˜å…ˆçº§æœ€ä½ä¹Ÿå°±æ˜¯ä¼šå…ˆæ‰§è¡Œå‡ºæ“ä½œï¼Œä½†æ˜¯è‡ªå®šä¹‰åˆ‡é¢MetricsAspectä¹ŸåŒæ ·æ˜¯æœ€ä½ä¼˜å…ˆçº§ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯èƒ½å‡ºç°é—®é¢˜ï¼šå¦‚æœå‡ºæ“ä½œå…ˆæ‰§è¡Œæ•è·äº†å¼‚å¸¸ï¼Œé‚£ä¹ˆSpringçš„äº‹åŠ¡å¤„ç†å°±ä¼šå› ä¸ºæ— æ³•æ•è·åˆ°å¼‚å¸¸å¯¼è‡´æ— æ³•å›æ»šäº‹åŠ¡ã€‚</p><p>è§£å†³æ–¹å¼æ˜¯ï¼Œæ˜ç¡®MetricsAspectçš„ä¼˜å…ˆçº§ï¼Œå¯ä»¥è®¾ç½®ä¸ºæœ€é«˜ä¼˜å…ˆçº§ï¼Œä¹Ÿå°±æ˜¯æœ€å…ˆæ‰§è¡Œå…¥æ“ä½œæœ€åæ‰§è¡Œå‡ºæ“ä½œï¼š</p><pre><code>//å°†MetricsAspectè¿™ä¸ªBeançš„ä¼˜å…ˆçº§è®¾ç½®ä¸ºæœ€é«˜\n@Order(Ordered.HIGHEST_PRECEDENCE)\npublic class MetricsAspect {\n    ...\n}\n</code></pre><p>æ­¤å¤–ï¼Œ<strong>æˆ‘ä»¬è¦çŸ¥é“åˆ‡å…¥çš„è¿æ¥ç‚¹æ˜¯æ–¹æ³•ï¼Œæ³¨è§£å®šä¹‰åœ¨ç±»ä¸Šæ˜¯æ— æ³•ç›´æ¥ä»æ–¹æ³•ä¸Šè·å–åˆ°æ³¨è§£çš„</strong>ã€‚ä¿®å¤æ–¹å¼æ˜¯ï¼Œæ”¹ä¸ºä¼˜å…ˆä»æ–¹æ³•è·å–ï¼Œå¦‚æœè·å–ä¸åˆ°å†ä»ç±»è·å–ï¼Œå¦‚æœè¿˜æ˜¯è·å–ä¸åˆ°å†ä½¿ç”¨é»˜è®¤çš„æ³¨è§£ï¼š</p><pre><code>Metrics metrics = signature.getMethod().getAnnotation(Metrics.class);\nif (metrics == null) {\n    metrics = signature.getMethod().getDeclaringClass().getAnnotation(Metrics.class);\n}\n</code></pre><p>ç»è¿‡è¿™2å¤„ä¿®æ”¹ï¼Œäº‹åŠ¡ç»ˆäºåˆå¯ä»¥å›æ»šäº†ï¼Œå¹¶ä¸”Controllerçš„ç›‘æ§æ—¥å¿—ä¹Ÿä¸å†å‡ºç°å…¥å‚ã€å‡ºå‚ä¿¡æ¯ã€‚</p><p>æˆ‘å†æ€»ç»“ä¸‹è¿™ä¸ªæ¡ˆä¾‹ã€‚åˆ©ç”¨åå°„+æ³¨è§£+Spring AOPå®ç°ç»Ÿä¸€çš„æ¨ªåˆ‡æ—¥å¿—å…³æ³¨ç‚¹æ—¶ï¼Œæˆ‘ä»¬é‡åˆ°çš„Springäº‹åŠ¡å¤±æ•ˆé—®é¢˜ï¼Œæ˜¯ç”±è‡ªå®šä¹‰çš„åˆ‡é¢æ‰§è¡Œé¡ºåºå¼•èµ·çš„ã€‚è¿™ä¹Ÿè®©æˆ‘ä»¬è®¤è¯†åˆ°ï¼Œå› ä¸ºSpringå†…éƒ¨å¤§é‡åˆ©ç”¨IoCå’ŒAOPå®ç°äº†å„ç§ç»„ä»¶ï¼Œå½“ä½¿ç”¨IoCå’ŒAOPæ—¶ï¼Œä¸€å®šè¦è€ƒè™‘æ˜¯å¦ä¼šå½±å“å…¶ä»–å†…éƒ¨ç»„ä»¶ã€‚</p><h2>é‡ç‚¹å›é¡¾</h2><p>ä»Šå¤©ï¼Œæˆ‘é€šè¿‡2ä¸ªæ¡ˆä¾‹å’Œä½ åˆ†äº«äº†Spring IoCå’ŒAOPçš„åŸºæœ¬æ¦‚å¿µï¼Œä»¥åŠä¸‰ä¸ªæ¯”è¾ƒå®¹æ˜“å‡ºé”™çš„ç‚¹ã€‚</p><p>ç¬¬ä¸€ï¼Œè®©Springå®¹å™¨ç®¡ç†å¯¹è±¡ï¼Œè¦è€ƒè™‘å¯¹è±¡é»˜è®¤çš„Scopeå•ä¾‹æ˜¯å¦é€‚åˆï¼Œå¯¹äºæœ‰çŠ¶æ€çš„ç±»å‹ï¼Œå•ä¾‹å¯èƒ½äº§ç”Ÿå†…å­˜æ³„éœ²é—®é¢˜ã€‚</p><p>ç¬¬äºŒï¼Œå¦‚æœè¦ä¸ºå•ä¾‹çš„Beanæ³¨å…¥Prototypeçš„Beanï¼Œç»ä¸æ˜¯ä»…ä»…ä¿®æ”¹Scopeå±æ€§è¿™ä¹ˆç®€å•ã€‚ç”±äºå•ä¾‹çš„Beanåœ¨å®¹å™¨å¯åŠ¨æ—¶å°±ä¼šå®Œæˆä¸€æ¬¡æ€§åˆå§‹åŒ–ã€‚æœ€ç®€å•çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼ŒæŠŠPrototypeçš„Beanè®¾ç½®ä¸ºé€šè¿‡ä»£ç†æ³¨å…¥ï¼Œä¹Ÿå°±æ˜¯è®¾ç½®proxyModeå±æ€§ä¸ºTARGET_CLASSã€‚</p><p>ç¬¬ä¸‰ï¼Œå¦‚æœä¸€ç»„ç›¸åŒç±»å‹çš„Beanæ˜¯æœ‰é¡ºåºçš„ï¼Œéœ€è¦æ˜ç¡®ä½¿ç”¨@Orderæ³¨è§£æ¥è®¾ç½®é¡ºåºã€‚ä½ å¯ä»¥å†å›é¡¾ä¸‹ï¼Œä¸¤ä¸ªä¸åŒä¼˜å…ˆçº§åˆ‡é¢ä¸­@Beforeã€@Afterå’Œ@Aroundä¸‰ç§å¢å¼ºçš„æ‰§è¡Œé¡ºåºï¼Œæ˜¯ä»€ä¹ˆæ ·çš„ã€‚</p><p>æœ€åæˆ‘è¦è¯´çš„æ˜¯ï¼Œæ–‡å†…ç¬¬äºŒä¸ªæ¡ˆä¾‹æ˜¯ä¸€ä¸ªå®Œæ•´çš„ç»Ÿä¸€æ—¥å¿—ç›‘æ§æ¡ˆä¾‹ï¼Œç»§ç»­ä¿®æ”¹å°±å¯ä»¥å®ç°ä¸€ä¸ªå®Œå–„çš„ã€ç”Ÿäº§çº§çš„æ–¹æ³•è°ƒç”¨ç›‘æ§å¹³å°ã€‚è¿™äº›ä¿®æ”¹ä¸»è¦æ˜¯ä¸¤æ–¹é¢ï¼šæŠŠæ—¥å¿—æ‰“ç‚¹ï¼Œæ”¹ä¸ºå¯¹æ¥Metricsç›‘æ§ç³»ç»Ÿï¼›æŠŠå„ç§åŠŸèƒ½çš„ç›‘æ§å¼€å…³ï¼Œä»æ³¨è§£å±æ€§è·å–æ”¹ä¸ºé€šè¿‡é…ç½®ç³»ç»Ÿå®æ—¶è·å–ã€‚</p><p>ä»Šå¤©ç”¨åˆ°çš„ä»£ç ï¼Œæˆ‘éƒ½æ”¾åœ¨äº†GitHubä¸Šï¼Œä½ å¯ä»¥ç‚¹å‡»<a href=\"https://github.com/JosephZhu1983/java-common-mistakes\">è¿™ä¸ªé“¾æ¥</a>æŸ¥çœ‹ã€‚</p><h2>æ€è€ƒä¸è®¨è®º</h2><ol>\n<li>é™¤äº†é€šè¿‡@Autowiredæ³¨å…¥Beanå¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨@Injectæˆ–@Resourceæ¥æ³¨å…¥Beanã€‚ä½ çŸ¥é“è¿™ä¸‰ç§æ–¹å¼çš„åŒºåˆ«æ˜¯ä»€ä¹ˆå—ï¼Ÿ</li>\n<li>å½“Beanäº§ç”Ÿå¾ªç¯ä¾èµ–æ—¶ï¼Œæ¯”å¦‚BeanAçš„æ„é€ æ–¹æ³•ä¾èµ–BeanBä½œä¸ºæˆå‘˜éœ€è¦æ³¨å…¥ï¼ŒBeanBä¹Ÿä¾èµ–BeanAï¼Œä½ è§‰å¾—ä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿåˆæœ‰å“ªäº›è§£å†³æ–¹å¼å‘¢ï¼Ÿ</li>\n</ol><p>åœ¨ä¸‹ä¸€è®²ä¸­ï¼Œæˆ‘ä¼šç»§ç»­ä¸ä½ æ¢è®¨Springæ ¸å¿ƒçš„å…¶ä»–é—®é¢˜ã€‚æˆ‘æ˜¯æœ±æ™”ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºä¸æˆ‘ç•™è¨€åˆ†äº«ä½ çš„æƒ³æ³•ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹æˆ–åŒäº‹ï¼Œä¸€èµ·äº¤æµã€‚</p>","neighbors":{"left":{"article_title":"18 | å½“åå°„ã€æ³¨è§£å’Œæ³›å‹é‡åˆ°OOPæ—¶ï¼Œä¼šæœ‰å“ªäº›å‘ï¼Ÿ","id":225596},"right":{"article_title":"20 | Springæ¡†æ¶ï¼šæ¡†æ¶å¸®æˆ‘ä»¬åšäº†å¾ˆå¤šå·¥ä½œä¹Ÿå¸¦æ¥äº†å¤æ‚åº¦","id":227918}},"comments":[{"had_liked":false,"id":211216,"user_name":"Darren","can_delete":false,"product_type":"c1","uid":1254968,"ip_address":"","ucode":"CCD2B2C492BE9A","user_header":"https://static001.geekbang.org/account/avatar/00/13/26/38/ef063dc2.jpg","comment_is_top":true,"comment_ctime":1587916396,"is_pvip":true,"replies":[{"id":"78536","content":"ğŸ‘ğŸ»ğŸ‘ğŸ»ğŸ‘ğŸ»ğŸ‘ğŸ»ğŸ‘ğŸ»ğŸ‘ğŸ»ğŸ‘ğŸ»ğŸ‘ğŸ»ğŸ‘ğŸ»ğŸ‘ğŸ»ğŸ‘ğŸ»","user_name":"ä½œè€…å›å¤","comment_id":211216,"uid":"1001470","ip_address":"","utype":1,"ctime":1587947647,"user_name_real":"æœ±æ™”"}],"discussion_count":6,"race_medal":0,"score":"9.2233724378747003e+18","product_id":100047701,"comment_content":"ä¸€ã€æ³¨è§£åŒºåˆ«<br>@Autowired<br>\t1ã€@Autowiredæ˜¯springè‡ªå¸¦çš„æ³¨è§£ï¼Œé€šè¿‡â€˜AutowiredAnnotationBeanPostProcessorâ€™ ç±»å®ç°çš„ä¾èµ–æ³¨å…¥ï¼›<br>\t2ã€@Autowiredæ˜¯æ ¹æ®ç±»å‹è¿›è¡Œè‡ªåŠ¨è£…é…çš„ï¼Œå¦‚æœéœ€è¦æŒ‰åç§°è¿›è¡Œè£…é…ï¼Œåˆ™éœ€è¦é…åˆ@Qualifierï¼›<br>\t3ã€@Autowiredæœ‰ä¸ªå±æ€§ä¸ºrequiredï¼Œå¯ä»¥é…ç½®ä¸ºfalseï¼Œå¦‚æœé…ç½®ä¸ºfalseä¹‹åï¼Œå½“æ²¡æœ‰æ‰¾åˆ°ç›¸åº”beançš„æ—¶å€™ï¼Œç³»ç»Ÿä¸ä¼šæŠ›é”™ï¼›<br>\t4ã€@Autowiredå¯ä»¥ä½œç”¨åœ¨å˜é‡ã€setteræ–¹æ³•ã€æ„é€ å‡½æ•°ä¸Šã€‚<br><br>@Inject<br>\t1ã€@Injectæ˜¯JSR330 (Dependency Injection for Java)ä¸­çš„è§„èŒƒï¼Œéœ€è¦å¯¼å…¥javax.inject.Inject;å®ç°æ³¨å…¥ã€‚<br>\t2ã€@Injectæ˜¯æ ¹æ®ç±»å‹è¿›è¡Œè‡ªåŠ¨è£…é…çš„ï¼Œå¦‚æœéœ€è¦æŒ‰åç§°è¿›è¡Œè£…é…ï¼Œåˆ™éœ€è¦é…åˆ@Namedï¼›<br>\t3ã€@Injectå¯ä»¥ä½œç”¨åœ¨å˜é‡ã€setteræ–¹æ³•ã€æ„é€ å‡½æ•°ä¸Šã€‚<br><br>@Resource<br>\t1ã€@Resourceæ˜¯JSR250è§„èŒƒçš„å®ç°ï¼Œéœ€è¦å¯¼å…¥javax.annotationå®ç°æ³¨å…¥ã€‚<br>\t2ã€@Resourceæ˜¯æ ¹æ®åç§°è¿›è¡Œè‡ªåŠ¨è£…é…çš„ï¼Œä¸€èˆ¬ä¼šæŒ‡å®šä¸€ä¸ªnameå±æ€§<br>\t3ã€@Resourceå¯ä»¥ä½œç”¨åœ¨å˜é‡ã€setteræ–¹æ³•ä¸Šã€‚<br><br>æ€»ç»“ï¼š<br>1ã€@Autowiredæ˜¯springè‡ªå¸¦çš„ï¼Œ@Injectæ˜¯JSR330è§„èŒƒå®ç°çš„ï¼Œ@Resourceæ˜¯JSR250è§„èŒƒå®ç°çš„ï¼Œéœ€è¦å¯¼å…¥ä¸åŒçš„åŒ…<br>2ã€@Autowiredã€@Injectç”¨æ³•åŸºæœ¬ä¸€æ ·ï¼Œä¸åŒçš„æ˜¯@Autowiredæœ‰ä¸€ä¸ªrequestå±æ€§<br>3ã€@Autowiredã€@Injectæ˜¯é»˜è®¤æŒ‰ç…§ç±»å‹åŒ¹é…çš„ï¼Œ@Resourceæ˜¯æŒ‰ç…§åç§°åŒ¹é…çš„<br>4ã€@Autowiredå¦‚æœéœ€è¦æŒ‰ç…§åç§°åŒ¹é…éœ€è¦å’Œ@Qualifierä¸€èµ·ä½¿ç”¨ï¼Œ@Injectå’Œ@Nameä¸€èµ·ä½¿ç”¨<br><br><br>äºŒï¼šå¾ªç¯ä¾èµ–ï¼š<br>ç›´è§‚è§£å†³æ–¹æ³•æ—¶é€šè¿‡setæ–¹æ³•å»å¤„ç†ï¼ŒèƒŒåçš„åŸç†å…¶å®æ˜¯ç¼“å­˜ã€‚<br>ä¸»è¦è§£å†³æ–¹å¼ï¼šä½¿ç”¨ä¸‰çº§ç¼“å­˜<br>singletonObjectsï¼š ä¸€çº§ç¼“å­˜ï¼Œ Cache of singleton objects: bean name --&gt; bean instance<br>earlySingletonObjectsï¼š äºŒçº§ç¼“å­˜ï¼Œ Cache of early singleton objects: bean name --&gt; bean instance  æå‰æ›å…‰çš„BEANç¼“å­˜<br>singletonFactoriesï¼š ä¸‰çº§ç¼“å­˜ï¼Œ Cache of singleton factories: bean name --&gt; ObjectFactory","like_count":94,"discussions":[{"author":{"id":1001470,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/fe/d0e25d57.jpg","nickname":"æœ±æ™”","note":"","ucode":"0B7F0BADE6AAB8","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493221,"discussion_content":"ğŸ‘ğŸ»ğŸ‘ğŸ»ğŸ‘ğŸ»ğŸ‘ğŸ»ğŸ‘ğŸ»ğŸ‘ğŸ»ğŸ‘ğŸ»ğŸ‘ğŸ»ğŸ‘ğŸ»ğŸ‘ğŸ»ğŸ‘ğŸ»","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587947647,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2051293,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/4c/dd/c6035349.jpg","nickname":"Bumblebee","note":"","ucode":"B879C8A511D08D","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":555746,"discussion_content":"ğŸš©","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1647056603,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1750549,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/b6/15/e2cfd10d.jpg","nickname":"ImYoursÂ°","note":"","ucode":"51F653129034C9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":381923,"discussion_content":"å¤šå…°å¤§ä½¬ç‰›é€¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625299436,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2251446,"avatar":"https://static001.geekbang.org/account/avatar/00/22/5a/b6/abf52ebe.jpg","nickname":"guanineğŸ€","note":"","ucode":"8AFDD724F77C99","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":320586,"discussion_content":"@Autowiredé»˜è®¤byTypeï¼Œæ‰¾åˆ°å¤šä¸ªç±»å‹ä¸€æ ·çš„å†byNameï¼Œæˆ‘è®°å¾—","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604407169,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1014665,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/7b/89/34f2cbcc.jpg","nickname":"æ¨å®‡","note":"","ucode":"EB74DF6E269F03","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":2251446,"avatar":"https://static001.geekbang.org/account/avatar/00/22/5a/b6/abf52ebe.jpg","nickname":"guanineğŸ€","note":"","ucode":"8AFDD724F77C99","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":379406,"discussion_content":"ç›¸åŒç±»å‹æ‰¾åˆ°å¤šä¸ªï¼Œä¼šæŠ¥é”™çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1623889971,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":320586,"ip_address":""},"score":379406,"extra":""}]},{"author":{"id":1134861,"avatar":"https://static001.geekbang.org/account/avatar/00/11/51/0d/fc1652fe.jpg","nickname":"James","note":"","ucode":"48B0F2A334D1C1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":294562,"discussion_content":"è¯¾ä»£è¡¨ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595928791,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":210633,"user_name":"Husiun","can_delete":false,"product_type":"c1","uid":1448664,"ip_address":"","ucode":"F783484743BFE4","user_header":"https://static001.geekbang.org/account/avatar/00/16/1a/d8/9ae1bdb9.jpg","comment_is_top":false,"comment_ctime":1587800117,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"70307276853","product_id":100047701,"comment_content":"é—®é¢˜2ï¼Œå¾ªç¯ä¾èµ–ä¼šæŠ›å‡ºå¼‚å¸¸BeanCurrentlyInCreationExceptionï¼Œå®˜ç½‘çš„è§£å†³æ–¹æ¡ˆæ˜¯ç”±æ„é€ å™¨æ³¨å…¥æ”¹ä¸ºsetteræ³¨å…¥","like_count":17},{"had_liked":false,"id":210571,"user_name":"norman","can_delete":false,"product_type":"c1","uid":1148747,"ip_address":"","ucode":"BEE517AEFB159F","user_header":"https://static001.geekbang.org/account/avatar/00/11/87/4b/7f90f912.jpg","comment_is_top":false,"comment_ctime":1587788553,"is_pvip":false,"replies":[{"id":"78438","content":"ğŸ‘ğŸ»ï¼Œä¹Ÿå¯ä»¥å‚è€ƒ https:&#47;&#47;stackoverflow.com&#47;questions&#47;20450902&#47;inject-and-resource-and-autowired-annotations è¿™é‡Œçš„å›å¤","user_name":"ä½œè€…å›å¤","comment_id":210571,"uid":"1001470","ip_address":"","utype":1,"ctime":1587815381,"user_name_real":"æœ±æ™”"}],"discussion_count":1,"race_medal":0,"score":"31652559625","product_id":100047701,"comment_content":"@Resource å’Œ @Autowired @Inject ä¸‰è€…åŒºåˆ«ï¼š<br>1 @Resourceé»˜è®¤æ˜¯æŒ‰ç…§åç§°æ¥è£…é…æ³¨å…¥çš„ï¼Œåªæœ‰å½“æ‰¾ä¸åˆ°ä¸åç§°åŒ¹é…çš„beanæ‰ä¼šæŒ‰ç…§ç±»å‹æ¥è£…é…æ³¨å…¥ã€‚<br>2 @Autowiredé»˜è®¤æ˜¯æŒ‰ç…§ç±»å‹è£…é…æ³¨å…¥çš„ï¼Œå¦‚æœæƒ³æŒ‰ç…§åç§°æ¥è½¬é…æ³¨å…¥ï¼Œåˆ™éœ€è¦ç»“åˆ@Qualifierã€‚è¿™ä¸ªæ³¨é‡Šæ˜¯Springç‰¹æœ‰çš„ã€‚<br>3 @Injectæ˜¯æ ¹æ®ç±»å‹è¿›è¡Œè‡ªåŠ¨è£…é…çš„ï¼Œå¦‚æœéœ€è¦æŒ‰åç§°è¿›è¡Œè£…é…ï¼Œåˆ™éœ€è¦é…åˆ@Named","like_count":7,"discussions":[{"author":{"id":1001470,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/fe/d0e25d57.jpg","nickname":"æœ±æ™”","note":"","ucode":"0B7F0BADE6AAB8","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493057,"discussion_content":"ğŸ‘ğŸ»ï¼Œä¹Ÿå¯ä»¥å‚è€ƒ https://stackoverflow.com/questions/20450902/inject-and-resource-and-autowired-annotations è¿™é‡Œçš„å›å¤","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587815381,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":211134,"user_name":"å·¦çª","can_delete":false,"product_type":"c1","uid":1468773,"ip_address":"","ucode":"6B797070168A12","user_header":"https://static001.geekbang.org/account/avatar/00/16/69/65/eb778125.jpg","comment_is_top":false,"comment_ctime":1587900387,"is_pvip":false,"replies":[{"id":"78525","content":"ä»£ç†ç±»ä¼šæ¥åˆ¤æ–­æ˜¯å¦éœ€è¦åˆ›å»ºæ–°çš„å¯¹è±¡","user_name":"ä½œè€…å›å¤","comment_id":211134,"uid":"1001470","ip_address":"","utype":1,"ctime":1587907326,"user_name_real":"æœ±æ™”"}],"discussion_count":1,"race_medal":0,"score":"27357704163","product_id":100047701,"comment_content":"è¿™é‡Œçš„ä»£ç†ç±»ä¸æ˜¯å•ä¾‹ä¹ˆï¼Œè¿˜æ˜¯è¯´ä¼šåœ¨å¢å¼ºé€»è¾‘é‡Œä¸æ–­åˆ›å»ºè¢«ä»£ç†ç±»ï¼Ÿ","like_count":7,"discussions":[{"author":{"id":1001470,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/fe/d0e25d57.jpg","nickname":"æœ±æ™”","note":"","ucode":"0B7F0BADE6AAB8","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493205,"discussion_content":"ä»£ç†ç±»ä¼šæ¥åˆ¤æ–­æ˜¯å¦éœ€è¦åˆ›å»ºæ–°çš„å¯¹è±¡","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587907326,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":264036,"user_name":"å’Œæµ·æ˜å¨ä¸‹æ£‹","can_delete":false,"product_type":"c1","uid":1400363,"ip_address":"","ucode":"567BA8167971A5","user_header":"https://static001.geekbang.org/account/avatar/00/15/5e/2b/1c158008.jpg","comment_is_top":false,"comment_ctime":1606316993,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"23081153473","product_id":100047701,"comment_content":"&#47;&#47;@annotationæŒ‡ç¤ºå™¨å®ç°å¯¹æ ‡è®°äº†Metricsæ³¨è§£çš„æ–¹æ³•è¿›è¡ŒåŒ¹é…<br>   @Pointcut(&quot;within(@org.geekbang.time.commonmistakes.springpart1.aopmetrics.Metrics *)&quot;<br><br>è¿™é‡Œæ˜¯ä¸æ˜¯æœ‰ç¬”è¯¯ï¼Ÿæˆ‘è¯•äº†ä¸‹withinæ— æ³•æ‹¦æˆªæ–¹æ³•çš„æ³¨è§£ï¼Œæ¢æˆ@annotationå°±å¯ä»¥äº†","like_count":6},{"had_liked":false,"id":214281,"user_name":"çœ‹ä¸åˆ°deé¢œè‰²","can_delete":false,"product_type":"c1","uid":1162714,"ip_address":"","ucode":"88348CCAE81931","user_header":"https://static001.geekbang.org/account/avatar/00/11/bd/da/3d76ea74.jpg","comment_is_top":false,"comment_ctime":1588693567,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"18768562751","product_id":100047701,"comment_content":"å¾ˆå¹²è´§çš„æ–‡ç« ï¼Œæ”¶è·æ»¡æ»¡ã€‚<br>ä½¿ç”¨AOPæ—¶ç¡®å®è¦æ³¨æ„æ‰§è¡Œé¡ºåºã€‚A_Around-before -&gt; A_Before -&gt; B_Around-before -&gt; B_Before -&gt; B_Around-after -&gt; B_After -&gt; A_Around-after -&gt; A_After<br><br>è¯¾åç­”ç–‘ï¼š<br>å…³äºå¾ªç¯ä¾èµ–ï¼Œåœ¨å•ä¾‹æ¨¡å¼ä¸‹ï¼ŒSpringé‡‡ç”¨ç¼“å­˜æå‰æš´éœ²ååˆå§‹åŒ–çš„æ–¹å¼è¿›è¡Œè§£å†³ã€‚ä½†æ˜¯ç”Ÿäº§ä¸Šå‡ºç°è¿‡ä¸€æ¬¡é—®é¢˜ï¼Œå½“ä½¿ç”¨äº†@Repositoryæ³¨è§£æ—¶ï¼Œå¾ªç¯ä¾èµ–æ˜¯è§£ä¸äº†çš„ã€‚SpringBootä¸­å¯¹@Repositoryåšäº†ç‰¹æ®Šå¤„ç†ã€‚","like_count":4,"discussions":[{"author":{"id":1750549,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/b6/15/e2cfd10d.jpg","nickname":"ImYoursÂ°","note":"","ucode":"51F653129034C9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":381926,"discussion_content":"ä¸ºä»€ä¹ˆå‘¢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625299881,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":210544,"user_name":"W","can_delete":false,"product_type":"c1","uid":1921315,"ip_address":"","ucode":"9434684DE2EFFB","user_header":"https://static001.geekbang.org/account/avatar/00/1d/51/23/36bc8745.jpg","comment_is_top":false,"comment_ctime":1587786616,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"18767655800","product_id":100047701,"comment_content":"MetricsAspect è¿™ä¸ªç±»é‡Œé¢çš„å°æŠ€å·§å­¦åˆ°äº†","like_count":5},{"had_liked":false,"id":241701,"user_name":"OneDy","can_delete":false,"product_type":"c1","uid":1160082,"ip_address":"","ucode":"BF0705E486994F","user_header":"https://static001.geekbang.org/account/avatar/00/11/b3/92/6a20da3f.jpg","comment_is_top":false,"comment_ctime":1597393836,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"14482295724","product_id":100047701,"comment_content":"å…³äºå¾ªç¯ä¾èµ–çš„è§£å†³ï¼Œçœ‹åˆ°äº†ä¸‰ç§å¤„ç†æ–¹å¼ï¼š<br>1.ä½¿ç”¨@Lazy å¯¹å…¶ä¸­ä¸€ä¸ªbeanæ‡’åŠ è½½<br>2. ä½¿ç”¨setterå±æ€§æ³¨å…¥ï¼Œè€Œå¹¶ä¸æ˜¯æ„é€ å™¨æ³¨å…¥<br>3. ä½¿ç”¨@PostConstructåœ¨ä¾èµ–æ³¨å…¥åæ‰§è¡Œåˆå§‹åŒ–<br>å…·ä½“å¯ä»¥å‚è€ƒï¼šhttps:&#47;&#47;www.baeldung.com&#47;circular-dependencies-in-spring","like_count":3},{"had_liked":false,"id":210682,"user_name":"Demon.Lee","can_delete":false,"product_type":"c1","uid":1052859,"ip_address":"","ucode":"7F0E5493A8E345","user_header":"https://static001.geekbang.org/account/avatar/00/10/10/bb/f1061601.jpg","comment_is_top":false,"comment_ctime":1587806767,"is_pvip":false,"replies":[{"id":"78431","content":"ä¸é”™","user_name":"ä½œè€…å›å¤","comment_id":210682,"uid":"1001470","ip_address":"","utype":1,"ctime":1587809070,"user_name_real":"æœ±æ™”"}],"discussion_count":1,"race_medal":1,"score":"14472708655","product_id":100047701,"comment_content":"è¿æ¥ç‚¹: ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­èƒ½å¤Ÿåº”ç”¨é€šçŸ¥çš„æ‰€æœ‰ç‚¹ï¼›é€šçŸ¥ï¼ˆå¢å¼ºï¼‰: å³åˆ‡é¢çš„å·¥ä½œï¼Œå®šä¹‰äº†Whatä»¥åŠWhenï¼›åˆ‡ç‚¹å®šä¹‰äº†Whereï¼Œé€šçŸ¥è¢«åº”ç”¨çš„å…·ä½“ä½ç½®ï¼ˆå“ªäº›è¿æ¥ç‚¹ï¼‰<br>----Springå®æˆ˜ï¼ˆç¬¬4ç‰ˆï¼‰","like_count":4,"discussions":[{"author":{"id":1001470,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/fe/d0e25d57.jpg","nickname":"æœ±æ™”","note":"","ucode":"0B7F0BADE6AAB8","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493085,"discussion_content":"ä¸é”™","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587809070,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":210711,"user_name":"Joker","can_delete":false,"product_type":"c1","uid":1156592,"ip_address":"","ucode":"126AF848001A1E","user_header":"https://static001.geekbang.org/account/avatar/00/11/a5/f0/8648c464.jpg","comment_is_top":false,"comment_ctime":1587813688,"is_pvip":false,"replies":[{"id":"78439","content":"åªæ˜¯ä¸ºäº†æ¨¡æ‹ŸSayServiceæ˜¯æœ‰çŠ¶æ€","user_name":"ä½œè€…å›å¤","comment_id":210711,"uid":"1001470","ip_address":"","utype":1,"ctime":1587815436,"user_name_real":"æœ±æ™”"}],"discussion_count":1,"race_medal":0,"score":"10177748280","product_id":100047701,"comment_content":"è€å¸ˆï¼Œè¯·æ•™ä¸€ä¸‹ï¼Œé‚£ä¸ªsayserviceé‡Œçš„dataæœ‰å•¥ç”¨ï¼Œé‚£ä¸ªå•ä¾‹æ˜¯ä¸ºäº†ä¸€ç§é‡å¤ä½¿ç”¨dataå¯¹å§ï¼Œé‚£æ¢æˆæ¯æ¬¡éƒ½ç”Ÿæˆä¸€ä¸ªæ–°çš„beanï¼Œé‚£ä¸ªdataè¿˜æœ‰æ•ˆæœå—ã€‚ã€‚","like_count":2,"discussions":[{"author":{"id":1001470,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/fe/d0e25d57.jpg","nickname":"æœ±æ™”","note":"","ucode":"0B7F0BADE6AAB8","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493091,"discussion_content":"åªæ˜¯ä¸ºäº†æ¨¡æ‹ŸSayServiceæ˜¯æœ‰çŠ¶æ€","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587815436,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":245498,"user_name":"é¾™è¡Œç§€","can_delete":false,"product_type":"c1","uid":1351066,"ip_address":"","ucode":"2DA088D199EA9D","user_header":"https://static001.geekbang.org/account/avatar/00/14/9d/9a/7f064a9f.jpg","comment_is_top":false,"comment_ctime":1598960697,"is_pvip":false,"replies":[{"id":"90345","content":"å®¹å™¨ç»´æŠ¤äº†è¿™ä¸ªå•ä¾‹ï¼Œå›æ”¶ä¸äº†","user_name":"ä½œè€…å›å¤","comment_id":245498,"uid":"1001470","ip_address":"","utype":1,"ctime":1599019413,"user_name_real":"æœ±æ™”"}],"discussion_count":3,"race_medal":0,"score":"5893927993","product_id":100047701,"comment_content":"â€œæ¶æ„å¸ˆä¸€å¼€å§‹å®šä¹‰äº†è¿™ä¹ˆä¸€ä¸ª SayService æŠ½è±¡ç±»ï¼Œå…¶ä¸­ç»´æŠ¤äº†ä¸€ä¸ªç±»å‹æ˜¯ ArrayList çš„å­—æ®µ dataï¼Œç”¨äºä¿å­˜æ–¹æ³•å¤„ç†çš„ä¸­é—´æ•°æ®ã€‚æ¯æ¬¡è°ƒç”¨ say æ–¹æ³•éƒ½ä¼šå¾€ data åŠ å…¥æ–°æ•°æ®ï¼Œå¯ä»¥è®¤ä¸º SayService æ˜¯æœ‰çŠ¶æ€ï¼Œå¦‚æœ SayService æ˜¯å•ä¾‹çš„è¯å¿…ç„¶ä¼š OOMâ€<br>-----ä¸ºä»€ä¹ˆå•ä¾‹å°±ä¼šOOMï¼Œå¤šä¾‹å°±ä¸ä¼šå‘¢ï¼Ÿæ²¡çœ‹æ‡‚","like_count":2,"discussions":[{"author":{"id":1001470,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/fe/d0e25d57.jpg","nickname":"æœ±æ™”","note":"","ucode":"0B7F0BADE6AAB8","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":504901,"discussion_content":"å®¹å™¨ç»´æŠ¤äº†è¿™ä¸ªå•ä¾‹ï¼Œå›æ”¶ä¸äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599019413,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1879320,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/ad/18/6e641cc8.jpg","nickname":"Simon","note":"","ucode":"81580164480ADC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1001470,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/fe/d0e25d57.jpg","nickname":"æœ±æ™”","note":"","ucode":"0B7F0BADE6AAB8","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":571373,"discussion_content":"æ˜¯ä¸æ˜¯å¯ä»¥è¿™æ ·ç†è§£ï¼š å› ä¸ºæ˜¯å•ä¾‹ï¼Œå¤§å®¶éƒ½åœ¨å¾€è¿™ä¸ªå•ä¾‹çš„å¯¹è±¡ä¸­çš„dataå¡æ•°æ®ï¼Œé‡å¤§çš„è¯å°±OOMï¼›è€Œå¤šä¾‹æƒ…å†µä¸‹ï¼Œæ¯äººå¾€è‡ªå·±å¯¹è±¡ä¸­çš„dataå¡æ•°æ®ï¼Œæ‰€ä»¥æ²¡å‡ºç°OOMã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1652187963,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":504901,"ip_address":""},"score":571373,"extra":""}]},{"author":{"id":1256314,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/xOSB7nvK0BCPPDfYupD5gAPjNLWtGt1WAJqFNWlcnz1SajF18W13Pp069MlXy2slWARryqianwexetHjZKWvsXg/132","nickname":"çˆ±è›‡","note":"","ucode":"195D000CE20E3B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":302652,"discussion_content":"è·Ÿä½ ä¸€æ ·ï¼Œæˆ‘æ²¡çœ‹åˆ°é—®é¢˜æ˜¯ä»€ä¹ˆ.å³ä½¿å•ä¾‹è¿˜æ˜¯å¤šä¾‹ï¼Œæ¯è°ƒç”¨ä¸€æ¬¡super.sayå°±ä¼šå¢åŠ ä¸€æ¬¡é•¿åº¦ï¼Œè¿™ä¸ä¹Ÿä¼šoomå—ï¼Ÿä¸æ˜ç™½ä¸ºä»€ä¹ˆè€å¸ˆå¼„å®Œä»¥åï¼Œä¸¤ä¸ªå­ç±»è°ƒç”¨super.sayæ–¹æ³•éƒ½åªå¢åŠ 1","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598986122,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":224878,"user_name":"Carisy","can_delete":false,"product_type":"c1","uid":1657429,"ip_address":"","ucode":"67E887967347BA","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLwTZdUafC5YM7bCASt8icUnoyYfV4hUHulexibDI7B4eaokTxYXHFtoic97DBlCAU9j5Jw4QUuGhyZQ/132","comment_is_top":false,"comment_ctime":1591582267,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5886549563","product_id":100047701,"comment_content":"é’ˆå¯¹æ¥¼ä¸Šåšäº›è¡¥å……è¯´æ˜ï¼š<br>1ã€@Resource æ³¨è§£æ˜¯é€šè¿‡CommonAnnotationBeanPostProcessorå¤„ç†çš„ï¼Œå¹¶ä¸”@Resourceæ³¨è§£å¹¶ä¸æ˜¯â€œå…ˆå»æŒ‰åå­—æ‰¾ï¼Œæ‰¾ä¸åˆ°å†æŒ‰ç±»å‹â€è€Œæ˜¯&quot;æ ¹æ®ç±»å‹ç­›é€‰ï¼Œç­›é€‰å‡ºçš„æ‰€æœ‰çš„beanæ ¹æ®åå­—è·å–&quot;<br>2ã€å¾ªç¯ä¾èµ–å¯ä»¥é€šè¿‡@Lazyæ³¨è§£","like_count":2},{"had_liked":false,"id":216105,"user_name":"mgs2002","can_delete":false,"product_type":"c1","uid":1812970,"ip_address":"","ucode":"F5931108BD509B","user_header":"https://static001.geekbang.org/account/avatar/00/1b/a9/ea/5bfce6c5.jpg","comment_is_top":false,"comment_ctime":1589190660,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5884157956","product_id":100047701,"comment_content":"é¡¹ç›®ä¹Ÿå†™è¿‡ç±»ä¼¼çš„æ—¥å¿—æ‰“ç‚¹åˆ‡é¢,å­¦åˆ°äº†ä¸€äº›å°æŠ€å·§ï¼Œçœ‹åç»­åŠ åˆ°é¡¹ç›®é‡Œé¢","like_count":1},{"had_liked":false,"id":212863,"user_name":"David Mo","can_delete":false,"product_type":"c1","uid":1083504,"ip_address":"","ucode":"66C30A3CD7EDA6","user_header":"https://static001.geekbang.org/account/avatar/00/10/88/70/32534e2d.jpg","comment_is_top":false,"comment_ctime":1588228215,"is_pvip":false,"replies":[{"id":"79058","content":"å¥½å§","user_name":"ä½œè€…å›å¤","comment_id":212863,"uid":"1001470","ip_address":"","utype":1,"ctime":1588242197,"user_name_real":"æœ±æ™”"}],"discussion_count":1,"race_medal":0,"score":"5883195511","product_id":100047701,"comment_content":"@sevice çš„å‘è¸©è¿‡ï¼Œä»£ç†ç±»ä¸€å¼€å§‹ä¸è¡Œç™½ï¼Œåæ¥è¯´åŠ¨æ€åˆ›å»ºå°±æ‡‚äº†ã€‚å½“æ—¶æ˜¯ç”¨ä¸€ä¸ªç±»ä¼¼å·¥å‚ç±»è§£å†³çš„","like_count":1,"discussions":[{"author":{"id":1001470,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/fe/d0e25d57.jpg","nickname":"æœ±æ™”","note":"","ucode":"0B7F0BADE6AAB8","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493632,"discussion_content":"å¥½å§","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588242197,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":212799,"user_name":"Geek_3b1096","can_delete":false,"product_type":"c1","uid":1549364,"ip_address":"","ucode":"A6BD92B79B3632","user_header":"","comment_is_top":false,"comment_ctime":1588212994,"is_pvip":false,"replies":[{"id":"79047","content":"ä¸å®¢æ°”","user_name":"ä½œè€…å›å¤","comment_id":212799,"uid":"1001470","ip_address":"","utype":1,"ctime":1588227274,"user_name_real":"æœ±æ™”"}],"discussion_count":1,"race_medal":0,"score":"5883180290","product_id":100047701,"comment_content":"å¾ˆæœ‰æ”¶è·è°¢è°¢è€å¸ˆ","like_count":1,"discussions":[{"author":{"id":1001470,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/fe/d0e25d57.jpg","nickname":"æœ±æ™”","note":"","ucode":"0B7F0BADE6AAB8","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493613,"discussion_content":"ä¸å®¢æ°”","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588227274,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":308588,"user_name":"coder","can_delete":false,"product_type":"c1","uid":1656956,"ip_address":"","ucode":"3A0940EBF94577","user_header":"https://static001.geekbang.org/account/avatar/00/19/48/7c/2aaf50e5.jpg","comment_is_top":false,"comment_ctime":1629692124,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1629692124","product_id":100047701,"comment_content":"å¹²è´§å¤ªå¤šäº†ï¼Œè€å¸ˆå¤ªå¼ºäº†","like_count":0},{"had_liked":false,"id":272041,"user_name":"Devil May Cry","can_delete":false,"product_type":"c1","uid":2396435,"ip_address":"","ucode":"F06B99B71AA25D","user_header":"https://static001.geekbang.org/account/avatar/00/24/91/13/009f6a74.jpg","comment_is_top":false,"comment_ctime":1609916785,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1609916785","product_id":100047701,"comment_content":"æ²¡ç†è§£æœ‰çŠ¶æ€æ˜¯ä»€ä¹ˆæ„æ€,è€å¸ˆå¯ä»¥è§£ç­”ä¸€ä¸‹å—","like_count":0,"discussions":[{"author":{"id":1242455,"avatar":"https://static001.geekbang.org/account/avatar/00/12/f5/57/ce10fb1b.jpg","nickname":"å¤©å¤©å‘ä¸Š","note":"","ucode":"0CCCA6F4DCC480","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":340762,"discussion_content":"å¯ä»¥ç†è§£ä¸ºï¼ŒçŠ¶æ€å°±æ˜¯ä¸‹æ¬¡è¯·æ±‚èƒ½ä¿ç•™ä¸Šæ¬¡è¯·æ±‚çš„æ•°æ®","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1610121266,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":253631,"user_name":"å°å­¦ç”Ÿ","can_delete":false,"product_type":"c1","uid":1166994,"ip_address":"","ucode":"6EF88756389547","user_header":"https://static001.geekbang.org/account/avatar/00/11/ce/92/f53c41ee.jpg","comment_is_top":false,"comment_ctime":1602815939,"is_pvip":false,"replies":[{"id":"92649","content":"å“ªé‡Œä¸å¯¹ï¼Ÿ","user_name":"ä½œè€…å›å¤","comment_id":253631,"uid":"1001470","ip_address":"","utype":1,"ctime":1602835171,"user_name_real":"æœ±æ™”"}],"discussion_count":3,"race_medal":0,"score":"1602815939","product_id":100047701,"comment_content":"è€å¸ˆï¼Œæ‚¨å¥½ï¼Œæ‚¨è®² çš„åˆ‡é¢æ‰§è¡Œé¡ºåºå¥½åƒä¸å¯¹å•Šï¼Œæˆ‘çš„æ‰§è¡Œé¡ºåºå’Œä½ è¯´çš„ä¸ä¸€è‡´ï¼<br>[10:34:11.367] [http-nio-45678-exec-4] [INFO ] [o.g.t.c.s.a.TestAspectWithOrder10:31  ] - TestAspectWithOrder10 @Around before<br>[10:34:11.377] [http-nio-45678-exec-4] [INFO ] [o.g.t.c.s.a.TestAspectWithOrder10:21  ] - TestAspectWithOrder10 @Before<br>[10:34:11.377] [http-nio-45678-exec-4] [INFO ] [o.g.t.c.s.a.TestAspectWithOrder20:31  ] - TestAspectWithOrder20 @Around before<br>[10:34:11.378] [http-nio-45678-exec-4] [INFO ] [o.g.t.c.s.a.TestAspectWithOrder20:21  ] - TestAspectWithOrder20 @Before<br>[10:34:11.379] [http-nio-45678-exec-4] [INFO ] [o.g.t.c.s.aopmetrics.MetricsAspect:79  ] - ã€å…¥å‚æ—¥å¿—ã€‘è°ƒç”¨ ã€class org.geekbang.time.commonmistakes.springpart1.aopmetrics.TestControllerã€‘ã€public void org.geekbang.time.commonmistakes.springpart1.aopmetrics.TestController.test()ã€‘ã€http:&#47;&#47;localhost:45678&#47;testã€‘ çš„å‚æ•°æ˜¯ï¼šã€[]ã€‘<br>[10:34:11.379] [http-nio-45678-exec-4] [INFO ] [o.g.t.c.s.aopmetrics.MetricsAspect:88  ] - ã€æˆåŠŸæ‰“ç‚¹ã€‘è°ƒç”¨ ã€class org.geekbang.time.commonmistakes.springpart1.aopmetrics.TestControllerã€‘ã€public void org.geekbang.time.commonmistakes.springpart1.aopmetrics.TestController.test()ã€‘ã€http:&#47;&#47;localhost:45678&#47;testã€‘ æˆåŠŸï¼Œè€—æ—¶ï¼š0 ms<br>[10:34:11.379] [http-nio-45678-exec-4] [INFO ] [o.g.t.c.s.aopmetrics.MetricsAspect:107 ] - ã€å‡ºå‚æ—¥å¿—ã€‘è°ƒç”¨ ã€class org.geekbang.time.commonmistakes.springpart1.aopmetrics.TestControllerã€‘ã€public void org.geekbang.time.commonmistakes.springpart1.aopmetrics.TestController.test()ã€‘ã€http:&#47;&#47;localhost:45678&#47;testã€‘ çš„è¿”å›æ˜¯ï¼šã€nullã€‘<br>[10:34:11.380] [http-nio-45678-exec-4] [INFO ] [o.g.t.c.s.a.TestAspectWithOrder20:26  ] - TestAspectWithOrder20 @After<br>[10:34:11.380] [http-nio-45678-exec-4] [INFO ] [o.g.t.c.s.a.TestAspectWithOrder20:33  ] - TestAspectWithOrder20 @Around after<br>[10:34:11.380] [http-nio-45678-exec-4] [INFO ] [o.g.t.c.s.a.TestAspectWithOrder10:26  ] - TestAspectWithOrder10 @After<br>[10:34:11.380] [http-nio-45678-exec-4] [INFO ] [o.g.t.c.s.a.TestAspectWithOrder10:33  ] - TestAspectWithOrder10 @Around after<br>","like_count":1,"discussions":[{"author":{"id":1001470,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/fe/d0e25d57.jpg","nickname":"æœ±æ™”","note":"","ucode":"0B7F0BADE6AAB8","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":507131,"discussion_content":"å“ªé‡Œä¸å¯¹ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1602835171,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1327997,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/YqF3S64vHV7cuGIQLczgj4hgOxZlHEN7X48nIShQIiaN1cU4VsE9ia4VVmTibVKzMfRG7ibgibKOPJfA5S1SrYZNDyA/132","nickname":"InfoQ_aae1c4db19b4","note":"","ucode":"481665EAB720F5","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":590757,"discussion_content":"ç‰ˆæœ¬é—®é¢˜","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1666064125,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å¹¿ä¸œ"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1474579,"avatar":"https://static001.geekbang.org/account/avatar/00/16/80/13/df2a0ced.jpg","nickname":"éƒ‘æ€é›¨","note":"","ucode":"F1F4B08FC94E7D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":318559,"discussion_content":"æˆ‘è¿è¡Œäº†ä¸€ä¸‹ä»£ç ï¼Œå’Œè€å¸ˆçš„æ‰“å°é¡ºåºæ˜¯ä¸€æ ·çš„ï¼Œå…ˆæ‰§è¡Œ @Around after ï¼Œåæ‰§è¡Œçš„@After","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603780821,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":250025,"user_name":"é²é¸£","can_delete":false,"product_type":"c1","uid":2152306,"ip_address":"","ucode":"974BA3C3E64630","user_header":"https://static001.geekbang.org/account/avatar/00/20/d7/72/cbef720d.jpg","comment_is_top":false,"comment_ctime":1600910216,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1600910216","product_id":100047701,"comment_content":"æœ‰ä¸€ä¸ªéœ€æ±‚ï¼ŒAä¾èµ–Bä¸­çš„æŸä¸ªå±æ€§ï¼Œè¿™ä¸ªå±æ€§ä¼šé€šè¿‡é…ç½®ä¸­å¿ƒå˜æ›´è¿›æ¥ï¼Œä½†æ˜¯æ€ä¹ˆå¯ä»¥åšåˆ°å½“Bçš„è¿™ä¸ªå±æ€§åˆå§‹åŒ–å®Œæˆäº†ï¼Œæ‰ä¼šå¯¹Aåˆå§‹åŒ–å‘¢ï¼Œç°åœ¨é€šè¿‡æ³¨å…¥æ–¹å¼ï¼Œå¯èƒ½Aåˆå§‹åŒ–æ—¶ç”¨åˆ°çš„Bå±æ€§æ˜¯ä¸ªç©ºå€¼","like_count":1},{"had_liked":false,"id":237123,"user_name":"xuyd","can_delete":false,"product_type":"c1","uid":1050847,"ip_address":"","ucode":"62E1E7D5201E89","user_header":"https://static001.geekbang.org/account/avatar/00/10/08/df/866ed645.jpg","comment_is_top":false,"comment_ctime":1595683793,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1595683793","product_id":100047701,"comment_content":"ç›´æ¥åœ¨Metricsé‡Œè¾¹æŠŠå¼‚å¸¸è·‘å‡ºæ¥å¯ä»¥å˜›","like_count":0},{"had_liked":false,"id":232317,"user_name":"libocz","can_delete":false,"product_type":"c1","uid":1227392,"ip_address":"","ucode":"9DC917019EB2CA","user_header":"https://static001.geekbang.org/account/avatar/00/12/ba/80/2b427c9c.jpg","comment_is_top":false,"comment_ctime":1593954901,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1593954901","product_id":100047701,"comment_content":"çœ‹ä¸æ‡‚ä¸ºä»€ä¹ˆControlleræ¢æˆç”¨@Metricsæ³¨è§£åå°±ä¼šä¸springçš„äº‹åŠ¡å‘ç”Ÿé¡ºåºé—®é¢˜ï¼Œè€Œä¸ç”¨@Metricså»æ³¨è§£Controllerçš„æ—¶å€™ï¼Œèƒ½ä¸springçš„äº‹åŠ¡æ­£ç¡®è¿è¡Œ","like_count":0,"discussions":[{"author":{"id":1238436,"avatar":"https://static001.geekbang.org/account/avatar/00/12/e5/a4/e16dca6a.jpg","nickname":"é˜¿å‡¯æ–‡","note":"","ucode":"F17CF201E74849","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":299400,"discussion_content":"ä½ è¿˜æ²¡çœ‹æ‡‚ï¼Œè¿™å’ŒControllerçš„@Metricsæ— å…³ï¼Œè€Œæ˜¯å’ŒUserServiceä¸­çš„æ³¨è§£@Transactionalå’Œ@Metrics(ignoreException=true)æœ‰å…³ï¼Œè¿™ä¸¤ä¸ªæ³¨è§£å¯¹åº”åˆ‡é¢æœ‰é¡ºåºé—®é¢˜ï¼ŒåŸæœ¬äº‹åŠ¡åˆ‡é¢ä¼˜å…ˆçº§æœ€ä½ï¼Œä½†è‡ªå®šä¹‰çš„è¿™ä¸ªåˆ‡é¢ä¹Ÿæ˜¯æœ€ä½çš„ï¼Œå¦‚æœå…ˆæ‰§è¡ŒMetricsåˆ‡é¢å¹¶ä¸”å¼‚å¸¸è¢«ä»–åæ‰ï¼Œäº‹åŠ¡åˆ‡é¢å†æ‰§è¡Œçš„æ—¶å€™å°±æ•è·ä¸åˆ°å¼‚å¸¸æ— æ³•å›æ»šï¼Œ@Metricsé»˜è®¤æ˜¯ä¸æ•è·å¼‚å¸¸æ‰€ä»¥æ²¡æœ‰é—®é¢˜ä½†å¦‚æœæ ‡è®°@Metrics(ignoreException=true)æ—¶åˆ‡é¢å°±ä¼šåƒæ‰å¼‚å¸¸ï¼Œè§£å†³åŠæ³•å°±æ˜¯æŠŠMetricsåˆ‡é¢ä¼˜å…ˆçº§è°ƒé«˜ï¼Œè®©å…¶å‡ºæ“ä½œåœ¨äº‹åŠ¡åˆ‡é¢ä¹‹åæ‰§è¡Œå°±å¥½äº†","likes_number":6,"is_delete":false,"is_hidden":false,"ctime":1597673304,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1227392,"avatar":"https://static001.geekbang.org/account/avatar/00/12/ba/80/2b427c9c.jpg","nickname":"libocz","note":"","ucode":"9DC917019EB2CA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1238436,"avatar":"https://static001.geekbang.org/account/avatar/00/12/e5/a4/e16dca6a.jpg","nickname":"é˜¿å‡¯æ–‡","note":"","ucode":"F17CF201E74849","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":302108,"discussion_content":"æ„Ÿè°¢ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598792108,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":299400,"ip_address":""},"score":302108,"extra":""}]}]},{"had_liked":false,"id":226153,"user_name":"track6688","can_delete":false,"product_type":"c1","uid":1088040,"ip_address":"","ucode":"0A9E893F8FD379","user_header":"https://static001.geekbang.org/account/avatar/00/10/9a/28/03613c22.jpg","comment_is_top":false,"comment_ctime":1591964413,"is_pvip":false,"replies":[{"id":"83303","content":"æ„æ€æ˜¯ExposeInvocationInterceptoréœ€è¦åœ¨å‰é¢æ‰§è¡Œï¼Œæœ€æ–°çš„ExposeInvocationInterceptorå·²ç»æ˜¯PriorityOrderedäº†ï¼Œä½ æ˜¯ä¸æ˜¯è€ç‰ˆæœ¬çš„Springï¼ŸæŠŠè‡ªå·±çš„ç±»ä¼˜å…ˆçº§è°ƒä½ç‚¹","user_name":"ä½œè€…å›å¤","user_name_real":"æœ±æ™”","uid":"1001470","ctime":1591970276,"ip_address":"","comment_id":226153,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1591964413","product_id":100047701,"comment_content":"è€å¸ˆï¼Œè¯·æ•™ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä½¿ç”¨è¿™ä¸ªæ³¨è§£ï¼Œ@Order(Ordered.HIGHEST_PRECEDENCE)ï¼Œä½¿ç”¨@AfterThrowingè¿™ä¸ªæ—¶ï¼ŒæŠ¥No MethodInvocation found: Check that an AOP invocation is in progress, and that the ExposeInvocationInterceptor is upfront in the interceptor chain. Specifically, note that advices with order HIGHEST_PRECEDENCE will execute before ExposeInvocationInterceptor!ï¼Œæ€ä¹ˆå¤„ç†å‘¢ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1001470,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/fe/d0e25d57.jpg","nickname":"æœ±æ™”","note":"","ucode":"0B7F0BADE6AAB8","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":498125,"discussion_content":"æ„æ€æ˜¯ExposeInvocationInterceptoréœ€è¦åœ¨å‰é¢æ‰§è¡Œï¼Œæœ€æ–°çš„ExposeInvocationInterceptorå·²ç»æ˜¯PriorityOrderedäº†ï¼Œä½ æ˜¯ä¸æ˜¯è€ç‰ˆæœ¬çš„Springï¼ŸæŠŠè‡ªå·±çš„ç±»ä¼˜å…ˆçº§è°ƒä½ç‚¹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591970276,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":217777,"user_name":"çœ‹ä¸åˆ°deé¢œè‰²","can_delete":false,"product_type":"c1","uid":1162714,"ip_address":"","ucode":"88348CCAE81931","user_header":"https://static001.geekbang.org/account/avatar/00/11/bd/da/3d76ea74.jpg","comment_is_top":false,"comment_ctime":1589611318,"is_pvip":false,"replies":[{"id":"80549","content":"è¿™ä¸ä¼šï¼Œä¼šç¼–è¯‘ä¸º<br>final class MetricsAspect$1c {<br>    MetricsAspect$1c(MetricsAspect this$0) {<br>        this.this$0 = this$0;<br>    }<br>}","user_name":"ä½œè€…å›å¤","user_name_real":"æœ±æ™”","uid":"1001470","ctime":1589629617,"ip_address":"","comment_id":217777,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1589611318","product_id":100047701,"comment_content":"æ„Ÿè§‰Spring Intercepterçš„æ‰§è¡Œé¡ºåºå’ŒServlet Filterçš„æ‰§è¡Œè¿‡ç¨‹æ˜¯ä¸€æ ·çš„ï¼Œä¸€ä¸ªé€’å½’è°ƒç”¨æ ˆã€‚<br>æœ‰ä¸ªç–‘é—®æƒ³è¯·è€å¸ˆè§£ç­”ä¸€ä¸‹ã€‚é‡‡ç”¨åˆ›å»ºå†…éƒ¨ç±»çš„æ–¹å¼è·å–é»˜è®¤æ³¨è§£é…ç½®ï¼Œè¿™æ ·ä¸ä¼šæ¯è°ƒç”¨ä¸€æ¬¡å°±ä¼šåœ¨å…ƒç©ºé—´ä¸­ç”Ÿæˆä¸€ä¸ªcçš„Classä¿¡æ¯å—ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1001470,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/fe/d0e25d57.jpg","nickname":"æœ±æ™”","note":"","ucode":"0B7F0BADE6AAB8","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":495259,"discussion_content":"è¿™ä¸ä¼šï¼Œä¼šç¼–è¯‘ä¸º\nfinal class MetricsAspect$1c {\n    MetricsAspect$1c(MetricsAspect this$0) {\n        this.this$0 = this$0;\n    }\n}","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589629617,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}