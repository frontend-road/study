{"id":477358,"title":"13ï½œæ ‡å‡†åº“ï¼šä½ éœ€è¦äº†è§£çš„ C å¹¶å‘ç¼–ç¨‹åŸºç¡€çŸ¥è¯†æœ‰å“ªäº›ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯äºèˆªã€‚</p><p>åœ¨æ„å»ºé«˜æ€§èƒ½åº”ç”¨æ—¶ï¼Œå¹¶å‘ç¼–ç¨‹æ˜¯æˆ‘ä»¬ç»å¸¸é‡‡ç”¨çš„ä¸€ç§æŠ€å·§ã€‚å®ƒé€šè¿‡åœ¨ç¨‹åºçš„è¿è¡Œè¿›ç¨‹å†…æä¾›å¯æ§åˆ¶ç²’åº¦æ›´ç»†çš„â€œçº¿ç¨‹â€ï¼Œä»è€Œå°†ç¨‹åºçš„æ•´ä½“åŠŸèƒ½æ‹†åˆ†ä¸ºæ›´å°çš„ç‹¬ç«‹ä»»åŠ¡å•å…ƒï¼Œå¹¶ä»¥æ­¤æ¥è¿›ä¸€æ­¥åˆ©ç”¨å¤šæ ¸ CPU çš„è¿ç®—èµ„æºã€‚</p><p>å¯¹äº C11 æ ‡å‡†ä¹‹å‰çš„ C è¯­è¨€æ¥è¯´ï¼Œæƒ³è¦æ„å»ºå¤šçº¿ç¨‹åº”ç”¨ï¼Œåªèƒ½ä¾èµ–äºæ‰€åœ¨å¹³å°ä¸Šçš„ä¸“æœ‰æ¥å£ï¼Œæ¯”å¦‚ Unix ä¸ç±» Unix å¹³å°ä¸Šå¹¿æ³›ä½¿ç”¨çš„ POSIX æ¨¡å‹ï¼Œä»¥åŠåèµ·ä¹‹ç§€ OpenMP æ¨¡å‹ç­‰ã€‚è¿™äº›æ¨¡å‹æä¾›çš„ç¼–ç¨‹æ¥å£ï¼Œä»¥åŠæ‰€æ”¯æŒå¹³å°éƒ½æœ‰å¾ˆå¤§çš„ä¸åŒã€‚å› æ­¤ï¼Œå¯¹äºé‚£æ—¶çš„ C è¯­è¨€æ¥è¯´ï¼Œæƒ³è¦ç¼–å†™é«˜å¯ç§»æ¤æ€§çš„å¤šçº¿ç¨‹åº”ç”¨ï¼Œä»éœ€è¦èŠ±è´¹å¾ˆå¤§åŠŸå¤«ã€‚</p><p>è€Œè‡ª C11 æ ‡å‡†åï¼ŒC è¯­è¨€ä¸ºæˆ‘ä»¬ä¸“é—¨æä¾›äº†ä¸€å¥—é€šç”¨çš„å¹¶å‘ç¼–ç¨‹æ¥å£ï¼Œä½ å¯ä»¥é€šè¿‡æ ‡å‡†åº“å¤´æ–‡ä»¶ threads.h ä¸ stdatomic.h æ¥ä½¿ç”¨å®ƒä»¬ã€‚å…¶ä¸­ï¼Œthreads.h ä¸­åŒ…å«æœ‰ä¸çº¿ç¨‹æ§åˆ¶ã€äº’æ–¥é‡ã€æ¡ä»¶å˜é‡ï¼Œä»¥åŠçº¿ç¨‹æœ¬åœ°å­˜å‚¨ç›¸å…³çš„æ¥å£ï¼›è€Œ stdatomic.h ä¸­åˆ™åŒ…å«æœ‰ä¸åŸå­æ“ä½œç›¸å…³çš„æ¥å£ã€‚è¿™äº›æ¥å£æä¾›äº†å¤šç§ä¸åŒæ–¹å¼ï¼Œå¯ç”¨æ¥é¿å…å¤šçº¿ç¨‹åº”ç”¨åœ¨è¿è¡Œè¿‡ç¨‹ä¸­å¯èƒ½é‡åˆ°çš„å„ç±»çº¿ç¨‹åŒæ­¥é—®é¢˜ã€‚</p><p>C11 æ ‡å‡†çš„å‘å¸ƒï¼Œç†è®ºä¸Šä½¿æ„å»ºå¯ç§»æ¤çš„å¤šçº¿ç¨‹ C åº”ç”¨æˆä¸ºå¯èƒ½ï¼Œä½†ç°å®æƒ…å†µå´å¹¶éè¿™æ ·ç†æƒ³ã€‚å„ç±» C æ ‡å‡†åº“å¯¹ C11 ä¸­å¹¶å‘ç¼–ç¨‹æ¥å£çš„æ”¯æŒç¨‹åº¦ä¸åŒï¼Œæ¯”å¦‚ Glibcï¼ˆGNU C æ ‡å‡†åº“ï¼‰åœ¨å…¶ 2018 å¹´ä¸­æ—¬å‘å¸ƒçš„ 2.28 ç‰ˆæœ¬ä¸­ï¼Œæ‰å°†ç›¸å…³æ¥å£è¿›è¡Œäº†è¾ƒä¸ºå®Œæ•´çš„å®ç°ã€‚è¿™å°±å¯¼è‡´äº† C11 æ ‡å‡†ä¸­çš„è¿™äº›é‡è¦ç‰¹æ€§ï¼Œè‡³ä»Šï¼ˆ2022 å¹´åˆï¼‰ä»ç„¶æ²¡æœ‰å¾—åˆ°è¾ƒä¸ºå¹¿æ³›çš„åº”ç”¨ã€‚</p><!-- [[[read_end]]] --><p>å› æ­¤ï¼Œæ¥ä¸‹æ¥æˆ‘å°†ç”¨ä¸¤è®²çš„ç¯‡å¹…ï¼Œä¸ºä½ ä»é›¶ä»‹ç»æœ‰å…³å¹¶å‘ç¼–ç¨‹çš„ä¸€äº›åŸºç¡€çŸ¥è¯†ï¼Œä»¥åŠ C11 å¹¶å‘ç¼–ç¨‹ç›¸å…³æ¥å£çš„åŸºæœ¬ä½¿ç”¨æ–¹å¼ã€‚å½“ç„¶ï¼Œç”±äºå¹¶å‘ç¼–ç¨‹æ˜¯ä¸€ç§å®Œå…¨ä¸åŒçš„ç¼–ç¨‹æ¨¡å‹ï¼ŒçŸ­çŸ­å‡ åƒå­—æ˜¯æ— æ³•è¯¦ç»†æ¢³ç†å®Œæ‰€æœ‰ç›¸å…³å†…å®¹çš„ã€‚ä½†æˆ‘å¸Œæœ›é€šè¿‡å¯¹è¿™ä¸¤è®²å†…å®¹çš„å­¦ä¹ ï¼Œä½ èƒ½å¤Ÿå¯¹ä½¿ç”¨ C è¯­è¨€å¼€å‘å¤šçº¿ç¨‹åº”ç”¨æœ‰ä¸€ä¸ªå…¨æ–°çš„è®¤è¯†ï¼Œå¹¶ä»¥æ­¤ä¸ºèµ·ç‚¹ï¼Œåœ¨æœªæ¥è¿›è¡Œæ›´åŠ æ·±å…¥çš„äº†è§£ã€‚</p><p>è¿™ä¸€è®²ï¼Œå°±è®©æˆ‘ä»¬æ¥ä¸€èµ·äº†è§£ä¸‹å¹¶å‘ç¼–ç¨‹çš„ä¸»è§’ï¼Œçº¿ç¨‹ï¼Œä»¥åŠæˆ‘ä»¬åœ¨å›´ç»•å®ƒè¿›è¡Œå¤šçº¿ç¨‹å¼€å‘æ—¶å¯èƒ½é‡åˆ°çš„ä¸€äº›å¸¸è§é—®é¢˜ã€‚</p><h2>è¿›ç¨‹ vs çº¿ç¨‹</h2><p>ç›¸ä¿¡ä½ å¯¹â€œè¿›ç¨‹â€è¿™ä¸ªæ¦‚å¿µåº”è¯¥æ¯”è¾ƒç†Ÿæ‚‰ï¼Œé‚£ä¹ˆçº¿ç¨‹ä¸è¿›ç¨‹æœ‰å“ªäº›åŒºåˆ«å‘¢ï¼Ÿæˆ‘ä»¬æ¥ä¸€èµ·çœ‹ä¸€çœ‹ã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ“ä½œç³»ç»Ÿä¼šä¸ºæ¯ä¸€ä¸ªè¿è¡Œä¸­çš„ç¨‹åºåˆ›å»ºä¸€ä¸ªç›¸åº”çš„è¿›ç¨‹ï¼Œä»¥ä½œä¸ºå®ƒçš„è¿è¡Œå®ä¾‹ã€‚è€Œè¿›ç¨‹ä¸­åˆ™åŒ…å«ä¸è¯¥ç¨‹åºæœ‰å…³çš„ä¸€ç³»åˆ—è¿è¡Œæ—¶ä¿¡æ¯ï¼Œæ¯”å¦‚ VASã€è¿›ç¨‹ IDã€å¤„ç†å™¨ä¸Šä¸‹æ–‡ï¼ˆå¦‚é€šç”¨ç›®çš„å¯„å­˜å™¨ä¸æŒ‡ä»¤å¯„å­˜å™¨ä¸­çš„å€¼ï¼‰ã€è¿›ç¨‹çŠ¶æ€ï¼Œä»¥åŠæ“ä½œç³»ç»Ÿåˆ†é…ç»™è¯¥è¿›ç¨‹çš„ç›¸å…³èµ„æºç­‰ã€‚è¿™äº›ä¿¡æ¯è¢«ç»Ÿä¸€å­˜æ”¾åœ¨å†…æ ¸æä¾›çš„ï¼Œåä¸ºâ€œè¿›ç¨‹æ§åˆ¶å—ï¼ˆPCBï¼‰â€çš„æ•°æ®ç»“æ„ä¸­ã€‚</p><p>ç°ä»£ CPU é€šå¸¸ä¼šé‡‡ç”¨â€œæŠ¢å å¼â€è°ƒåº¦ç®—æ³•ï¼Œæ¥è¿›è¡Œå¤šä¸ªè¿›ç¨‹ä¹‹é—´çš„ä»»åŠ¡åˆ‡æ¢è¿‡ç¨‹ã€‚æ¯”å¦‚ï¼Œå½“æŸä¸ªè¿›ç¨‹çš„æ‰§è¡Œæ—¶é—´è¶…è¿‡ä¸€å®šé˜ˆå€¼ï¼Œæˆ–å¼€å§‹ç­‰å¾… IO å“åº”ï¼Œæˆ–æ‰€åœ¨ç³»ç»Ÿå‡ºç°ç¡¬ä»¶ä¸­æ–­ç­‰æƒ…å†µæ—¶ï¼Œå†…æ ¸ä»»åŠ¡è°ƒåº¦å™¨å¯èƒ½ä¼šå°†è¯¥è¿›ç¨‹æŒ‚èµ·ï¼Œå¹¶å°† CPU èµ„æºâ€œè½¬ç§»â€ç»™å…¶ä»–è¿›ç¨‹ä½¿ç”¨ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå³ä½¿æ˜¯åœ¨å•æ ¸ CPU ä¸Šï¼Œæ“ä½œç³»ç»Ÿä¹Ÿèƒ½å¤Ÿå®ç°ç”¨æˆ·å¯è§‚æµ‹çš„å¤šä»»åŠ¡å¤„ç†è¿‡ç¨‹ã€‚å½“ç„¶ï¼Œå…·ä½“çš„è°ƒåº¦ç®—æ³•è¿˜ä¼šè€ƒè™‘è¿›ç¨‹çš„ä¼˜å…ˆçº§æƒé‡ã€å†å²æ‰§è¡Œæƒ…å†µç­‰å› ç´ ã€‚è°ƒåº¦å™¨åªæœ‰åœ¨ç»è¿‡â€œç»¼åˆè¯„å®šâ€åï¼Œæ‰ä¼šä½œå‡ºé€‰æ‹©ã€‚</p><p><strong>è€Œç›¸è¾ƒäºè¿›ç¨‹ï¼Œçº¿ç¨‹åˆ™ä¸ºç¨‹åºæä¾›äº†æ›´ç»†ç²’åº¦çš„è¿è¡Œå•å…ƒã€‚</strong>å¯¹äºå¤§å¤šæ•°ä¼ ç»Ÿæ“ä½œç³»ç»Ÿå®ç°æ¥è¯´ï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸€ä¸ªè¿›ç¨‹å†…éƒ¨éƒ½ä¼šå­˜åœ¨è‡³å°‘ä¸€ä¸ªçº¿ç¨‹ã€‚å…¶ä¸­ï¼Œè¿›ç¨‹è´Ÿè´£åˆ’åˆ†ä¸åŒç¨‹åºæ‰€äº«æœ‰èµ„æºçš„è¾¹ç•Œï¼›è€Œçº¿ç¨‹åˆ™åœ¨å…±äº«ç¨‹åºè¿è¡Œèµ„æºçš„æƒ…å†µä¸‹ï¼Œè´Ÿè´£ç¨‹åºæŸä¸ªå­ä»»åŠ¡çš„å…·ä½“æ‰§è¡Œè¿‡ç¨‹ã€‚</p><p>æ­¤æ—¶ï¼Œä»»åŠ¡è°ƒåº¦å™¨ä¹Ÿå°†ä»¥çº¿ç¨‹ä½œä¸ºæœ€å°çš„è°ƒåº¦å®ä½“ï¼Œæ¥æ›´åŠ ç²¾ç»†åœ°ç»„ç»‡ç¨‹åºçš„è¿è¡Œã€‚å› æ­¤ï¼Œé€šè¿‡å¢åŠ è¿›ç¨‹ä¸­çº¿ç¨‹çš„ä¸ªæ•°ï¼Œæˆ‘ä»¬ä¾¿èƒ½å¤Ÿå°†ç¨‹åºéœ€è¦å®Œæˆçš„ä»»åŠ¡è¿›è¡Œæ›´å…·ä½“çš„åˆ’åˆ†ï¼ˆæ¯”å¦‚å°† IO ç›¸å…³æ“ä½œå•ç‹¬åˆ†é…ç»™ä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œï¼‰ï¼Œå¹¶åŒæ—¶è¿›ä¸€æ­¥åˆ©ç”¨å¤šæ ¸ CPU çš„è®¡ç®—èµ„æºã€‚</p><p>åŒè¿›ç¨‹ç±»ä¼¼ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹æ‰€å…·æœ‰çš„ä¸åŒçŠ¶æ€ä¿¡æ¯è¢«ä¿å­˜åœ¨å†…æ ¸ä¸­åä¸ºâ€œçº¿ç¨‹æ§åˆ¶å—ï¼ˆTCBï¼‰â€çš„æ•°æ®ç»“æ„ä¸­ã€‚å…¶ä¸­åŒ…å«æœ‰ä¸ç‰¹å®šçº¿ç¨‹è¿è¡Œç´§å¯†ç›¸å…³çš„å¤„ç†å™¨ä¸Šä¸‹æ–‡ã€çº¿ç¨‹ IDã€æ‰€å±è¿›ç¨‹ï¼Œä»¥åŠçŠ¶æ€ä¿¡æ¯ï¼Œç­‰ç­‰ã€‚å¯ä»¥çœ‹åˆ°çš„æ˜¯ï¼ŒPCB ä¸ TCB ä¸¤è€…å†…éƒ¨æ‰€åŒ…å«çš„å†…å®¹ä¼šæœ‰ä¸€å®šé‡åˆã€‚è¿™æ˜¯ç”±äºåœ¨æŸäº›æ“ä½œç³»ç»Ÿä¸Šï¼Œå•è¿›ç¨‹ï¼ˆå•çº¿ç¨‹ï¼‰åº”ç”¨çš„è¿è¡Œå¯èƒ½ä¼šç›´æ¥ä½¿ç”¨ PCBï¼Œæ¥åŒæ—¶ä¿å­˜ç¨‹åºçš„èµ„æºæè¿°ä¿¡æ¯ä¸æ‰§è¡ŒçŠ¶æ€ä¿¡æ¯ã€‚è€Œå½“è¿è¡Œå¤šçº¿ç¨‹åº”ç”¨æ—¶ï¼Œæ‰ä¼šé…åˆä½¿ç”¨ PCB ä¸ TCBã€‚è¿™é‡Œï¼Œä½ å¯ä»¥é€šè¿‡ä¸‹å›¾æ¥ç›´è§‚åœ°å¯¹æ¯”è¿›ç¨‹ä¸çº¿ç¨‹ä¹‹é—´çš„åŒºåˆ«å’Œè”ç³»ã€‚å½“ç„¶ï¼Œå…·ä½“çš„å®ç°æ–¹å¼å¹¶ä¸å”¯ä¸€ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/7b/81/7ba38592d36f442a3b16980fd39f9881.jpg?wh=1920x1127\" alt=\"å›¾ç‰‡\"></p><p>èŠå®Œäº†åŸºæœ¬çš„ç†è®ºçŸ¥è¯†ï¼Œæ¥ä¸‹æ¥å°±è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•åœ¨ C ä»£ç ä¸­åˆ›å»ºçº¿ç¨‹ã€‚</p><h2>çº¿ç¨‹çš„åŸºæœ¬æ§åˆ¶</h2><p>å€ŸåŠ© threads.h å¤´æ–‡ä»¶æä¾›çš„æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°å¯¹çº¿ç¨‹çš„åˆ›å»ºã€ç­‰å¾…ã€é˜»å¡ã€åˆ†ç¦»ï¼Œä»¥åŠé‡æ–°è°ƒåº¦ç­‰æ“ä½œã€‚æ¥çœ‹ä¸‹é¢è¿™æ®µç¤ºä¾‹ä»£ç ï¼š</p><pre><code class=\"language-c++\">#include &lt;threads.h&gt;\n#include &lt;stdio.h&gt;\nint run(void *arg) {\n  thrd_t id = thrd_current();  // è¿”å›è¯¥å‡½æ•°è¿è¡Œæ‰€åœ¨çº¿ç¨‹çš„æ ‡è¯†ç¬¦ï¼›\n  printf((const char*) arg, id);\n  return thrd_success;\n}\nint main(void) {\n#ifndef __STDC_NO_THREADS__\n  thrd_t thread;\n  int result;\n  // åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼›\n  thrd_create(&amp;thread, run, \"Hello C11 thread with id: %lu.\\n\");\n  if (thrd_join(thread, &amp;result) == thrd_success) {\n    // ç­‰å¾…å…¶ä»–çº¿ç¨‹é€€å‡ºï¼›\n    printf(\"Thread returns %d at the end.\\n\", result);  \n  }  \n#endif\n  return 0;\n}\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ main å‡½æ•°çš„å¼€å¤´ï¼Œæˆ‘ä»¬é¦–å…ˆé€šè¿‡åˆ¤æ–­å® <strong>STDC_NO_THREADS</strong> æ˜¯å¦å­˜åœ¨ï¼Œæ¥å†³å®šæ˜¯å¦â€œå¯ç”¨â€å¤šçº¿ç¨‹ç›¸å…³çš„ä»£ç ã€‚C11 æ ‡å‡†ä¸­è§„å®šï¼Œè‹¥ç¼–è¯‘å™¨å®ç°ä¸æ”¯æŒå¹¶å‘ç¼–ç¨‹ç›¸å…³æ¥å£ï¼Œåˆ™éœ€è¦å®šä¹‰è¯¥å®ã€‚</p><p>ç„¶åï¼Œåœ¨æ¡ä»¶ç¼–è¯‘æŒ‡ä»¤ <code>ifndef</code> çš„å†…éƒ¨ï¼Œæˆ‘ä»¬å®šä¹‰äº†ç±»å‹ä¸º <code>thrd_t</code> çš„å˜é‡ threadã€‚è¯¥ç±»å‹ä¸ºç”±å…·ä½“å®ç°å®šä¹‰çš„ï¼Œç”¨äºæ ‡è¯†æŸä¸ªçº¿ç¨‹çš„å”¯ä¸€å¯¹è±¡ã€‚æ¥ä¸‹æ¥ï¼Œåœ¨ä»£ç çš„ç¬¬ 13 è¡Œï¼Œæˆ‘ä»¬é€šè¿‡ thrd_create å‡½æ•°åˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹ã€‚è¿™é‡Œï¼Œä¼ å…¥è¯¥å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ä¸ºä¸€ä¸ª <code>thrd_start_t</code> ç±»å‹çš„å‡½æ•°æŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆæ‰€æŒ‡å‘å‡½æ•°å°†ä¼šåœ¨è¿™ä¸ªæ–°çº¿ç¨‹å†…è¢«æ‰§è¡Œï¼Œå…¶æ¥æ”¶åˆ°çš„å‚æ•°ä¸º thrd_create å‡½æ•°è°ƒç”¨æ—¶ä¼ å…¥çš„ç¬¬ä¸‰ä¸ªå‚æ•°ã€‚</p><p>å½“æ–°çº¿ç¨‹åˆ›å»ºå®Œæ¯•åï¼Œå…¶æ‰§è¡Œè¿‡ç¨‹ä¾¿ä¸ main å‡½æ•°æ‰€åœ¨çº¿ç¨‹å‘ç”Ÿäº†â€œåˆ†ç¦»â€ã€‚å› æ­¤ï¼Œä¸ºäº†é˜²æ­¢ main å‡½æ•°æ‰§è¡Œç»“æŸå‰ï¼ˆå³æ•´ä¸ªç¨‹åºé€€å‡ºå‰ï¼‰ï¼Œæ–°çº¿ç¨‹å†…çš„ä»£ç è¿˜æ²¡æœ‰æ‰§è¡Œå®Œæˆã€‚è¿™é‡Œï¼Œæˆ‘ä»¬ä¾¿éœ€è¦é€šè¿‡ thrd_join å‡½æ•°ï¼Œæ¥è®© main å‡½æ•°æ‰€åœ¨çº¿ç¨‹â€œç­‰å¾…â€æ–°çº¿ç¨‹çš„æ‰§è¡Œç»“æŸã€‚å½“ç„¶ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œå¦‚æœä»…æ˜¯ä¸ºäº†èƒ½è®©æ–°çº¿ç¨‹é¡ºåˆ©æ‰§è¡Œå®Œæ¯•ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨ thrd_exit å‡½æ•°æ¥è¾¾åˆ°è¿™ä¸ªç›®çš„ã€‚è¿™é‡Œä½ å¯ä»¥æ€è€ƒä¸‹å…·ä½“åº”è¯¥æ€æ ·åšï¼Œå¹¶åœ¨è¯„è®ºåŒºç•™ä¸‹ä½ çš„ç­”æ¡ˆã€‚</p><p>æ¥ä¸‹æ¥ï¼Œå‡½æ•° run åœ¨æ–°çº¿ç¨‹ä¸­è¢«æ‰§è¡Œã€‚é€šè¿‡å‡½æ•° thrd_currentï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°å½“å‰ä»£ç æ‰§è¡Œæ‰€åœ¨çº¿ç¨‹çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚ç„¶åï¼Œè°ƒç”¨ printf å‡½æ•°ï¼Œæˆ‘ä»¬å°†è¯¥æ ‡è¯†ç¬¦çš„å€¼æ‰“å°äº†å‡ºæ¥ã€‚è‡³æ­¤ï¼Œæ–°çº¿ç¨‹æ‰§è¡Œå®Œæ¯•å¹¶ç»ˆæ­¢ï¼Œæ‰§è¡Œæµç¨‹åˆå›åˆ° main å‡½æ•°æ‰€åœ¨çº¿ç¨‹ä¸­ã€‚</p><p>å®é™…ä¸Šï¼Œé™¤äº†æˆ‘ä»¬åœ¨ä¸Šé¢ä¾‹å­ä¸­ä½¿ç”¨åˆ°çš„ä»¥ â€œthrd_â€ å¼€å¤´çš„å‡½æ•°å¤–ï¼ŒC11 è¿˜ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€äº›å…¶ä»–çš„çº¿ç¨‹æ§åˆ¶å‡½æ•°ã€‚è¿™é‡Œï¼Œæˆ‘å°†å®ƒä»¬æ•´ç†åˆ°äº†ä¸‹é¢çš„è¡¨æ ¼ä¸­ï¼Œä¾›ä½ å‚è€ƒï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/3b/d7/3b9248a4dc11b1228835d0547679c8d7.jpg?wh=1920x988\" alt=\"å›¾ç‰‡\"></p><p>éšç€å¤šçº¿ç¨‹åº”ç”¨çš„åŠŸèƒ½å˜å¾—é€æ¸å¤æ‚ï¼Œå…±äº«å˜é‡å¯èƒ½ä¼šè¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ã€‚å¹¶ä¸”ï¼Œä¸åŒçº¿ç¨‹å¯èƒ½ä¼šä»¥ä¸åŒçš„å…ˆåé¡ºåºï¼Œæ¥æ‰§è¡Œç¨‹åºä¸­çš„åŒä¸€æ®µä»£ç ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œç°ä»£ CPU é‡‡ç”¨çš„ç‰¹æ®ŠæŒ‡ä»¤å¤„ç†æ–¹å¼ï¼Œä½¿å¾—ç¨‹åºçš„å®é™…æ‰§è¡Œæµç¨‹ä¸å¯¹åº”çš„æ±‡ç¼–ä»£ç å¯èƒ½ä¹Ÿä¸å®Œå…¨ä¸€è‡´ã€‚è€Œä¸Šè¿°è¿™ä¸‰ä¸ªå› ç´ ï¼Œéƒ½ç¡®å®ä¼šåœ¨æŸäº›æƒ…å†µä¸‹å½±å“å¤šçº¿ç¨‹åº”ç”¨çš„æ­£å¸¸æ‰§è¡Œã€‚</p><p>ä¸‹é¢ï¼Œæˆ‘ä»¬å°±æ¥äº†è§£ä¸€ä¸‹ä¸ä¸Šè¿°è¿™ä¸‰ç§æƒ…å†µç›¸å¯¹åº”çš„ä¸‰ä¸ªæ¦‚å¿µï¼Œå³ï¼šæ•°æ®ç«äº‰ã€ç«æ€æ¡ä»¶ï¼Œä»¥åŠæŒ‡ä»¤é‡æ’ã€‚</p><h2>æ•°æ®ç«äº‰</h2><p>ä»å®šä¹‰ä¸Šæ¥è®²ï¼Œæ•°æ®ç«äº‰ï¼ˆData Raceï¼‰æ˜¯æŒ‡åœ¨ä¸€ä¸ªå¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œæœ‰ä¸¤ä¸ªåŠä»¥ä¸Šçš„çº¿ç¨‹åœ¨åŒä¸€æ—¶é—´å¯¹åŒä¸€å—å†…å­˜ä¸­çš„æ•°æ®è¿›è¡Œäº†éåŸå­æ“ä½œï¼Œä¸”å…¶ä¸­è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯å†™æ“ä½œã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¯¥æ•°æ®å€¼çš„æœ€ç»ˆçŠ¶æ€å¯èƒ½ä¸ç¨‹åºè¯­ä¹‰ä¸Šå¸Œæœ›è¡¨è¾¾çš„è®¡ç®—ç»“æœä¸ä¸€è‡´ã€‚æ¥çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š</p><pre><code class=\"language-c++\">#include &lt;threads.h&gt;\n#include &lt;stdio.h&gt;\n#define THREAD_COUNT 20\n#define THREAD_LOOP 100000000\nlong counter = 0;&nbsp; // å…¨å±€å˜é‡ï¼Œç”¨æ¥è®°å½•çº¿ç¨‹çš„ç´¯åŠ å€¼ï¼›\nint run(void* data) {\n&nbsp; for (int i = 0; i &lt; THREAD_LOOP; i++)\n&nbsp; &nbsp; counter++;&nbsp; // åœ¨çº¿ç¨‹ä¸­é€’å¢å…¨å±€å˜é‡çš„å€¼ï¼›\n&nbsp; printf(\"Thread %d terminates.\\n\", *((int*) data));\n&nbsp; return thrd_success;\n}\nint main(void) {\n#ifndef __STDC_NO_THREADS__\n&nbsp; int ids[THREAD_COUNT];  // ç”¨äºå­˜æ”¾çº¿ç¨‹åºå·çš„æ•°ç»„ï¼›\n&nbsp; thrd_t threads[THREAD_COUNT];&nbsp;&nbsp;\n&nbsp; for (int i = 0; i &lt; THREAD_COUNT; i++) {\n&nbsp; &nbsp; ids[i] = i + 1;\n&nbsp; &nbsp; thrd_create(&amp;threads[i], run, ids + i);&nbsp; // åˆ›å»º THREAD_COUNT ä¸ªçº¿ç¨‹ï¼›\n&nbsp; }\n&nbsp; for (int i = 0; i &lt; THREAD_COUNT; i++)\n&nbsp; &nbsp; thrd_join(threads[i], NULL);&nbsp; // è®©å½“å‰çº¿ç¨‹ç­‰å¾…å…¶ä»–çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ï¼›\n&nbsp; printf(\"Counter value is: %ld.\\n\", counter);&nbsp; // è¾“å‡º counter å˜é‡æœ€ç»ˆç»“æœï¼›\n#endif\n&nbsp; return 0;&nbsp;\n}&nbsp;&nbsp;\n</code></pre><p>åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬åœ¨ main å‡½æ•°å†…åˆ›å»ºäº† 20 ä¸ªçº¿ç¨‹ï¼ˆç”±å®å¸¸é‡ THREAD_COUNT æŒ‡å®šï¼‰ï¼Œå¹¶è®©è¿™äº›çº¿ç¨‹åŒæ—¶å¯¹å…¨å±€å˜é‡ counter è¿›è¡Œå€¼é€’å¢æ“ä½œã€‚ç”±äº counter çš„åˆå§‹å€¼è¢«è®¾ç½®ä¸º 0ï¼Œå› æ­¤ï¼Œå¦‚æœä»£ç æŒ‰ç…§æˆ‘ä»¬çš„é¢„æœŸæ‰§è¡Œï¼Œ20 ä¸ªçº¿ç¨‹åˆ†åˆ«å¯¹è¯¥å…¨å±€å˜é‡é€’å¢ 1 äº¿æ¬¡ï¼Œç¨‹åºåœ¨é€€å‡ºå‰æ‰“å°çš„ counter å˜é‡å€¼åº”è¯¥ä¸º 20 äº¿ã€‚ä½†å®é™…æƒ…å†µå¯èƒ½å¹¶éå¦‚æ­¤ï¼Œä¸‹é¢æˆ‘ä»¬å…·ä½“çœ‹ä¸‹ã€‚</p><p>åœ¨éä¼˜åŒ–æƒ…å†µä¸‹ç¼–è¯‘å¹¶å¤šæ¬¡è¿è¡Œè¿™æ®µä»£ç ï¼Œä½ ä¼šå‘ç°ç¨‹åºæ‰“å°å‡ºçš„ counter å˜é‡å€¼å¹¶ä¸ç¨³å®šã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œè¿™ä¸ªå€¼æ˜¯å‡†ç¡®çš„ï¼Œè€ŒæŸäº›æƒ…å†µä¸‹å´å°äºè¿™ä¸ªæ•°å­—ã€‚è¿™ä¸ªé—®é¢˜ä¾¿æ˜¯ç”±äºå¤šçº¿ç¨‹æ¨¡å‹ä¸‹çš„æ•°æ®ç«äº‰å¼•èµ·çš„ã€‚</p><p>å¯¹äºä¸Šé¢è¿™ä¸ªä¾‹å­æ¥è¯´ï¼Œç¼–è¯‘å™¨å¯èƒ½ä¼šå°† run å‡½æ•°å†…çš„ counter å˜é‡è‡ªå¢è¯­å¥ï¼Œç¼–è¯‘ä¸ºå¦‚ä¸‹æ‰€ç¤ºçš„å‡ æ¡æœºå™¨æŒ‡ä»¤çš„ç»„åˆï¼š</p><pre><code class=\"language-c++\">mov eax, DWORD PTR counter[rip]\nadd eax, 1\nmov DWORD PTR counter[rip], eax\n</code></pre><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå½“å¤šä¸ªçº¿ç¨‹åœ¨ CPU çš„è°ƒåº¦ä¸‹äº¤é”™è¿è¡Œæ—¶ï¼Œä¾¿å¯èƒ½ä¼šå‘ç”Ÿè¿™æ ·ä¸€ç§æƒ…å†µï¼šæŸä¸ªçº¿ç¨‹åˆšåˆšæ‰§è¡Œå®Œä¸Šè¿°ä»£ç çš„ç¬¬ä¸€æ¡æŒ‡ä»¤ï¼Œå°†å˜é‡ counter çš„å€¼æš‚å­˜åœ¨äº†å¯„å­˜å™¨ rax ä¸­ã€‚æ­¤æ—¶ï¼Œæ“ä½œç³»ç»Ÿå¼€å§‹è°ƒåº¦çº¿ç¨‹ï¼Œå°†å½“å‰çº¿ç¨‹æŒ‚èµ·ï¼Œå¹¶å¼€å§‹æ‰§è¡Œå¦ä¸€ä¸ªçº¿ç¨‹çš„ä»£ç ã€‚</p><p>æ–°çš„çº¿ç¨‹åœ¨æ‰§è¡Œé€’å¢æ—¶ï¼Œç”±äºéœ€è¦å†æ¬¡ä» counter æ‰€åœ¨çš„åŸå†…å­˜åœ°å€ä¸­è¯»å…¥æ•°æ®ï¼Œå› æ­¤ï¼Œè¯¥å€¼ä¸ä¸Šä¸€ä¸ªçº¿ç¨‹è¯»å–åˆ°çš„æ•°æ®æ˜¯ç›¸åŒçš„ã€‚è€Œè¿™ä¾¿ä¼šå¯¼è‡´è¿™ä¸¤ä¸ªçº¿ç¨‹åœ¨é€’å¢åå¾—åˆ°çš„ç»“æœå€¼ä¹Ÿå®Œå…¨ç›¸åŒï¼Œä¸¤ä¸ªçº¿ç¨‹å¯¹ counter å˜é‡çš„ä¸¤æ¬¡é€’å¢è¿‡ç¨‹ä»…ä½¿å¾—å®ƒçš„åŸå€¼å¢åŠ äº† 1ã€‚</p><p>ä¸ä»…å¦‚æ­¤ï¼Œå“ªæ€•ç¼–è¯‘å™¨åœ¨ä¼˜åŒ–æƒ…å†µä¸‹ï¼Œå¯ä»¥å°†ä¸Šè¿°é€’å¢è¯­å¥å®ç°ä¸ºä»…ä¸€æ¡æ±‡ç¼–æŒ‡ä»¤ï¼Œæ•°æ®ç«äº‰çš„é—®é¢˜ä»å¯èƒ½ä¼šå­˜åœ¨ã€‚</p><p>æ¯”å¦‚ï¼Œç¼–è¯‘å™¨å°†è¯¥é€’å¢æ“ä½œå®ç°ä¸ºæœºå™¨æŒ‡ä»¤ <code>add&nbsp;DWORD PTR counter[rip], 1</code>ï¼ˆè¿™é‡Œä½¿ç”¨ RIP-relative å¯»å€ï¼‰ã€‚ç°ä»£ x86-64 å¤„ç†å™¨åœ¨å¤„ç†è¿™æ¡ CISC é£æ ¼çš„æœºå™¨æŒ‡ä»¤æ—¶ï¼Œå¯èƒ½ä¼šå°†å…¶æ‹†åˆ†ä¸ºå¯¹åº”çš„ä¸‰ç§ä¸åŒâ€œå¾®æŒ‡ä»¤ï¼ˆuOpï¼‰â€ï¼šLOADã€ADDã€STOREã€‚å…¶ä¸­ï¼ŒLOAD æŒ‡ä»¤ä¼šé¦–å…ˆä»ç»™å®šå†…å­˜åœ°å€å¤„è¯»å‡ºå½“å‰çš„æ•°æ®å€¼ï¼›ADD æŒ‡ä»¤åˆ™ä¼šæ ¹æ®ç”¨æˆ·ä¼ å…¥çš„ç«‹å³æ•°å‚æ•°ï¼Œæ¥è®¡ç®—å‡ºæ›´æ–°åçš„æ•°æ®å€¼ï¼›æœ€åï¼ŒSTORE æŒ‡ä»¤ä¼šå°†è¿™ä¸ªç»“æœæ•°æ®å€¼æ›´æ–°åˆ°å¯¹åº”çš„å†…å­˜ä¸­ã€‚åŒä¹‹å‰å¤šæ¡æœºå™¨æŒ‡ä»¤çš„å®ç°ç±»ä¼¼ï¼Œè¿™äº›å¾®æŒ‡ä»¤åœ¨æ“ä½œç³»ç»Ÿçš„çº¿ç¨‹è°ƒåº¦ä¸‹ï¼Œä¹Ÿå¯èƒ½å­˜åœ¨ç€äº¤æ›¿æ‰§è¡Œçš„è¿‡ç¨‹ï¼Œå› æ­¤ä¹Ÿæœ‰ç€äº§ç”Ÿæ•°æ®ç«äº‰çš„é£é™©ã€‚</p><h2>ç«æ€æ¡ä»¶</h2><p>ç«æ€æ¡ä»¶ï¼ˆRace Conditionï¼‰æ˜¯æŒ‡ç”±äºç¨‹åºä¸­æŸäº›äº‹ä»¶çš„å‘ç”Ÿæ—¶æœºä¸é¡ºåºä¸ä¸€è‡´ï¼Œä»è€Œå½±å“ç¨‹åºè¿è¡Œæ­£ç¡®æ€§çš„ä¸€ç§ç¼ºé™·ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ•°æ®ç«äº‰çš„å­˜åœ¨å¯èƒ½ä¼šå¯¼è‡´ç«æ€æ¡ä»¶çš„å‡ºç°ï¼Œä½†ä¸¤è€…çš„å‡ºç°å®é™…ä¸Šå¹¶æ²¡æœ‰å¤ªå¤šè”ç³»ï¼ˆæœ‰éƒ¨åˆ†äººè®¤ä¸ºæ•°æ®ç«äº‰æ˜¯ç«æ€æ¡ä»¶çš„ä¸€ç§ï¼Œä½†ä¹Ÿæœ‰äººæŒåå¯¹æ„è§ï¼‰ã€‚</p><p>ä¸åŒäºæ•°æ®ç«äº‰çš„æ˜¯ï¼Œå¯¹ç¨‹åºä¸­ç«æ€æ¡ä»¶çš„åˆ¤æ–­å¯èƒ½æ˜¯éå¸¸å›°éš¾çš„ã€‚ç«æ€æ¡ä»¶å¹¶æ²¡æœ‰å¯ä»¥ç²¾ç¡®åˆ°å…·ä½“æ“ä½œå’Œè¡Œä¸ºä¸Šçš„å®šä¹‰ï¼Œå› æ­¤ï¼Œå®ƒæ˜¯å¦äº§ç”Ÿå®Œå…¨å–å†³äºç¨‹åºçš„å…·ä½“è®¾è®¡ï¼Œä»¥åŠæ˜¯å¦å­˜åœ¨å¯èƒ½å½±å“ç¨‹åºè¿è¡Œçš„å¤–éƒ¨éç¡®å®šæ€§å˜åŒ–ã€‚</p><p>æ¯”å¦‚ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹é¢è¿™æ®µä»…å«æœ‰ç«æ€æ¡ä»¶ï¼Œä½†å¹¶æ²¡æœ‰æ•°æ®ç«äº‰çš„ç¤ºä¾‹ä»£ç ï¼š</p><pre><code class=\"language-c++\">#include &lt;threads.h&gt;\n#include &lt;stdio.h&gt;\n#include &lt;stdatomic.h&gt;\n#include &lt;stdlib.h&gt;\n#include &lt;time.h&gt;\n#define THREAD_COUNT 10\natomic_int accountA = 100000000;&nbsp; // è½¬å‡ºè´¦æˆ·åˆå§‹é‡‘é¢ï¼›\natomic_int accountB = 0;&nbsp; // è½¬å…¥è´¦æˆ·åˆå§‹é‡‘é¢ï¼›\nint run(void* v) {\n&nbsp; int _amount = *((int*) v);&nbsp; // è·å¾—å½“å‰çº¿ç¨‹çš„è½¬ç§»é‡‘é¢ï¼›\n&nbsp; for(;;) {\n&nbsp; &nbsp; // é¦–å…ˆåˆ¤æ–­è½¬å‡ºè´¦æˆ·é‡‘é¢æ˜¯å¦è¶³å¤Ÿï¼Œä¸å¤Ÿåˆ™ç›´æ¥é€€å‡ºï¼›\n&nbsp; &nbsp; if (accountA &lt; _amount) return thrd_error;&nbsp;&nbsp;\n&nbsp; &nbsp; atomic_fetch_add(&amp;accountB, _amount);&nbsp; // å°†é‡‘é¢ç´¯åŠ åˆ°è½¬å…¥è´¦æˆ·ï¼›\n&nbsp; &nbsp; atomic_fetch_sub(&amp;accountA, _amount);&nbsp; // å°†é‡‘é¢ä»è½¬å‡ºè´¦æˆ·ä¸­æ‰£é™¤ï¼›\n&nbsp; }\n}\nint main(void) {\n#if !defined(__STDC_NO_THREADS__) &amp;&amp; !defined(__STDC_NO_ATOMICS__)\n&nbsp; thrd_t threads[THREAD_COUNT];&nbsp;&nbsp;\n&nbsp; srand(time(NULL));\n&nbsp; for (int i = 0; i &lt; THREAD_COUNT; i++) {\n&nbsp; &nbsp; int amount = rand() % 50;&nbsp; // ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹ç”Ÿæˆä¸€ä¸ªéšæœºè½¬ç§»é‡‘é¢ï¼›\n&nbsp; &nbsp; thrd_create(&amp;threads[i], run, &amp;amount);\n&nbsp; }\n&nbsp; for (int i = 0; i &lt; THREAD_COUNT; i++)\n&nbsp; &nbsp; thrd_join(threads[i], NULL);\n&nbsp; printf(\"A: %d\\nB: %d\", accountA, accountB);\n#endif\n&nbsp; return 0;&nbsp;\n}&nbsp;\n</code></pre><p>åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬ä»¥ç®€åŒ–çš„æ–¹å¼å®ç°äº†ä¸€ä¸ªåŸºæœ¬çš„é‡‘èåœºæ™¯ï¼Œå³è´¦æˆ· A å‘è´¦æˆ· B è¿›è¡Œå¤šæ¬¡è½¬è´¦ï¼Œä¸”æ¯æ¬¡è½¬è´¦çš„é‡‘é¢éƒ½å¹¶ä¸å›ºå®šã€‚åœ¨ main å‡½æ•°çš„ç¬¬ 22~25 è¡Œï¼Œæˆ‘ä»¬é€šè¿‡åˆ›å»ºå¤šä¸ªçº¿ç¨‹çš„æ–¹å¼æ¥æ¨¡æ‹Ÿä¸¤ä¸ªè´¦æˆ·ä¹‹é—´åˆ†æ‰¹ã€å¤šæ¬¡çš„è´¢äº§è½¬ç§»è¿‡ç¨‹ã€‚å…¶ä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹ä¼šä½¿ç”¨ä¸åŒçš„å›ºå®šä»½é¢æ¥è¿›è¡Œè½¬è´¦è¿‡ç¨‹ï¼Œè€Œéšæœºæ•° amount ä¾¿è¡¨ç¤ºäº†è¿™ä¸ªé¢åº¦ã€‚</p><p>çº¿ç¨‹å¼€å§‹è¿è¡Œåï¼Œåœ¨ä»£ç ç¬¬ 10 è¡Œçš„ run å‡½æ•°å†…ï¼Œæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªçº¿ç¨‹æœ¬åœ°å˜é‡ _amount æ¥å­˜æ”¾ä¼ å…¥çš„ã€å½“å‰çº¿ç¨‹éœ€è¦ä½¿ç”¨çš„å›ºå®šä»½é¢ã€‚æ¥ä¸‹æ¥ï¼Œåœ¨ä¸€ä¸ªæ— é™å¾ªç¯ä¸­ï¼Œçº¿ç¨‹ä¼šé€šè¿‡ä»¥ä¸‹ä¸‰ä¸ªæ­¥éª¤ï¼Œæ¥å®Œæˆä¸¤ä¸ªè´¦æˆ·ä¹‹é—´çš„è½¬è´¦è¿‡ç¨‹ï¼š</p><ol>\n<li>åˆ¤æ–­è´¦æˆ· A çš„å‰©ä½™èµ„é‡‘æ˜¯å¦è¶³å¤Ÿè¿›è¡Œè½¬è´¦ã€‚è‹¥å¦ï¼Œåˆ™ç›´æ¥é€€å‡ºï¼›</li>\n<li>å°†è½¬è´¦çš„é‡‘é¢ç´¯åŠ åˆ°è´¦æˆ· B ä¸­ï¼›</li>\n<li>å°†è½¬è´¦çš„é‡‘é¢ä»è´¦æˆ· A ä¸­æ‰£é™¤ã€‚</li>\n</ol><p>è€Œå½“æ‰€æœ‰çº¿ç¨‹éƒ½é€€å‡ºæ—¶ï¼Œåˆ™è¡¨ç¤ºå½“å‰è´¦æˆ· A ä¸­çš„å‰©ä½™é‡‘é¢ï¼Œæ— æ³•å†æ»¡è¶³ä»»ä½•ä¸€ä¸ªçº¿ç¨‹ä»¥å®ƒçš„å›ºå®šé‡‘é¢ä¸ºå•ä½è¿›è¡Œè½¬è´¦ã€‚æœ€åï¼Œé€šè¿‡ printf å‡½æ•°ï¼Œæˆ‘ä»¬å°†ä¸¤ä¸ªè´¦æˆ·å†…çš„å‰©ä½™èµ„é‡‘æ‰“å°äº†å‡ºæ¥ã€‚æŒ‰ç…§æˆ‘ä»¬å¯¹ç¨‹åºçš„ç†è§£ï¼Œæ­¤æ—¶ï¼Œä¸¤ä¸ªè´¦æˆ·ä¸­çš„é‡‘é¢åº”è¯¥éƒ½å¤§äº 0ï¼Œä¸”ä¸¤è€…ä¹‹å’Œä¸º 1 äº¿ã€‚</p><p>å¯ä»¥çœ‹åˆ°ï¼Œç¨‹åºçš„æ•´ä¸ªæ‰§è¡Œæµç¨‹ååˆ†ç®€å•ã€‚ä¸ä»…å¦‚æ­¤ï¼Œæˆ‘ä»¬è¿˜ä½¿ç”¨äº†åŸå­æ“ä½œï¼Œæ¥ä¿è¯ç¨‹åºå¯¹è´¦æˆ·å˜é‡ accountA ä¸ accountB çš„ä¿®æ”¹è¿‡ç¨‹æ˜¯ä¸ä¼šäº§ç”Ÿæ•°æ®ç«äº‰çš„ã€‚æœ‰å…³åŸå­æ“ä½œçš„æ›´å¤šå†…å®¹ï¼Œæˆ‘ä¼šåœ¨ä¸‹ä¸€è®²ä¸­ä¸ºä½ ä»‹ç»ï¼Œè¿™é‡Œä½ å¯ä»¥å…ˆå¯¹å®ƒçš„ç”¨æ³•æœ‰ä¸€ä¸ªåŸºæœ¬äº†è§£ã€‚</p><p>åˆ°è¿™é‡Œï¼Œç¨‹åºçš„é€»è¾‘çœ‹èµ·æ¥æ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚ä½†å½“æˆ‘ä»¬çœŸæ­£è¿è¡Œå®ƒæ—¶ï¼Œå´å¯èƒ½ä¼šå¾—åˆ°å¦‚ä¸‹æ‰€ç¤ºçš„è¾“å‡ºç»“æœï¼š</p><pre><code class=\"language-c++\">A: -46\nB: 100000046\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œè´¦æˆ· A çš„å‰©ä½™é‡‘é¢å˜ä¸ºäº†è´Ÿæ•°ï¼Œç¨‹åºè¿è¡Œå‡ºç°äº†å¼‚å¸¸ã€‚å¦‚æœä»”ç»†åˆ†æä¸Šè¿°ä»£ç çš„æ‰§è¡Œé€»è¾‘ï¼Œä½ ä¼šå‘ç°å¤šä¸ªçº¿ç¨‹åœ¨å¯¹è´¦æˆ·å˜é‡è¿›è¡Œä¿®æ”¹æ—¶ï¼Œè™½ç„¶æ²¡æœ‰æ•°æ®ç«äº‰ï¼Œä½†ç¨‹åºçš„ä¸æ°å½“è®¾è®¡å¯¼è‡´å…¶å­˜åœ¨ç€ç«æ€æ¡ä»¶ã€‚</p><p>å½“å¤šä¸ªçº¿ç¨‹åœ¨åŒæ—¶æ‰§è¡Œ run å‡½æ•°å†…çš„é€»è¾‘æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¸­çš„ä»»åŠ¡è°ƒåº¦å™¨å¯èƒ½ä¼šåœ¨ä»»æ„æ—¶åˆ»æš‚åœæŸä¸ªçº¿ç¨‹çš„æ‰§è¡Œï¼Œè½¬è€Œå»è¿è¡Œå¦ä¸€ä¸ªçº¿ç¨‹ã€‚å› æ­¤ï¼Œä¾¿å¯èƒ½å‡ºç°è¿™æ ·ä¸€ç§æƒ…å†µï¼šæŸä¸ªçº¿ç¨‹ä»¥åŸå­å½¢å¼ï¼Œæ‰§è¡Œäº†ä»£ç çš„ç¬¬ 14 è¡Œè¯­å¥ï¼Œå°†é‡‘é¢ç´¯åŠ åˆ°è´¦æˆ· Aã€‚è€Œæ­¤æ—¶ï¼Œè°ƒåº¦å™¨å°†æ‰§è¡Œæµç¨‹è½¬ç§»ç»™å¦ä¸€ä¸ªçº¿ç¨‹ã€‚è¯¥çº¿ç¨‹åœ¨ä¸Šä¸€ä¸ªçº¿ç¨‹è¿˜æ²¡æœ‰å®Œæˆå¯¹è´¦æˆ· B çš„æ‰£å‡æ“ä½œå‰ï¼Œä¾¿ç›´æ¥ä½¿ç”¨æœªåŒæ­¥çš„å€¼å‚ä¸äº†ä¸‹ä¸€æ¬¡çš„è½¬è´¦æ“ä½œã€‚</p><p>å› æ­¤ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç¨‹åºçš„æ­£ç¡®æ€§å®é™…ä¸Šä¾èµ–äºå„ä¸ªçº¿ç¨‹ä¹‹é—´ï¼ŒæŒ‰ç…§ä¸€å®šé¡ºåºçš„æ‰§è¡Œè¿‡ç¨‹ã€‚é‚£ä¹ˆï¼Œåº”è¯¥å¦‚ä½•ä¿®å¤è¿™ä¸ªç¨‹åºå‘¢ï¼Ÿå­¦å®Œä¸‹ä¸€è®²åï¼Œä½ å°±å¯ä»¥ç»“åˆè¿™ä¸¤è®²çš„çŸ¥è¯†ï¼Œå°è¯•è§£å†³è¿™ä¸ªé—®é¢˜äº†ã€‚</p><p>æœ€åï¼Œæˆ‘ä»¬å†æ¥çœ‹å¦ä¸€ä¸ªä¸å¹¶å‘ç¼–ç¨‹å¯†åˆ‡ç›¸å…³çš„è¯é¢˜ï¼ŒæŒ‡ä»¤é‡æ’ã€‚</p><h2>æŒ‡ä»¤é‡æ’</h2><p>ç°ä»£ç¼–è¯‘å™¨å’Œå¤„ç†å™¨é€šå¸¸ä¼šé‡‡ç”¨åä¸ºâ€œæŒ‡ä»¤é‡æ’â€ï¼ˆä¹±åºæ‰§è¡Œçš„ä¸€ç§ï¼‰çš„æŠ€æœ¯æ¥è¿›ä¸€æ­¥æå‡ç¨‹åºçš„è¿è¡Œæ•ˆç‡ã€‚è¿™ç§æŠ€æœ¯ä¼šåœ¨å°½é‡ä¸å½±å“ç¨‹åºå¯è§‚æµ‹æ‰§è¡Œç»“æœçš„æƒ…å†µä¸‹ï¼Œå¯¹ç”Ÿæˆçš„æœºå™¨æŒ‡ä»¤ï¼Œæˆ–å®ƒä»¬çš„å®é™…æ‰§è¡Œé¡ºåºè¿›è¡Œé€‚å½“çš„é‡æ–°æ’åºã€‚å¯¹äºç¼–è¯‘å™¨æ¥è¯´ï¼Œå…¶è¡¨è±¡æ˜¯æºä»£ç ä¸­è¯­å¥çš„å‡ºç°é¡ºåºï¼Œä¸å¯¹åº”æ±‡ç¼–ä»£ç çš„å®ç°é¡ºåºä¸ä¸€è‡´ã€‚è€Œå¯¹äºå¤„ç†å™¨æ¥è¯´ï¼Œåˆ™æ˜¯<strong>ç¨‹åºåœ¨çœŸæ­£æ‰§è¡Œæ—¶äº§ç”Ÿå‰¯ä½œç”¨çš„é¡ºåºï¼ˆæ¯”å¦‚å˜é‡èµ‹å€¼ï¼‰ï¼Œä¸æ±‡ç¼–ä»£ç ä¸­æŒ‡ä»¤çš„å‡ºç°é¡ºåºä¸ä¸€è‡´</strong>ã€‚</p><p>å¯¹å¤šçº¿ç¨‹åº”ç”¨æ¥è¯´ï¼Œå³ä½¿ç¼–è¯‘å™¨å¯ä»¥ä»é™æ€åˆ†æçš„è§†è§’ï¼Œæ¥ç¡®ä¿æ±‡ç¼–æŒ‡ä»¤çš„é‡æ’ä¸å½±å“ç¨‹åºçš„å¯è§‚æµ‹æ‰§è¡Œç»“æœï¼Œä½†å½“å¤šä¸ªçº¿ç¨‹è¢«è°ƒåº¦åˆ°ä¸åŒçš„ç‰©ç† CPU ä¸Šæ‰§è¡Œæ—¶ï¼Œä¸åŒ CPU ä¹‹é—´ä¸€èˆ¬æ— æ³•å…±äº«å¯¹åº”çº¿ç¨‹æŒ‡ä»¤åœ¨æ‰§è¡Œæ—¶çš„é‡æ’ä¿¡æ¯ã€‚å› æ­¤ï¼Œå½“çº¿ç¨‹ä¹‹é—´å­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»æ—¶ï¼Œç¨‹åºçš„è¿è¡Œæ—¶æ­£ç¡®æ€§å¯èƒ½ä¼šå—åˆ°å½±å“ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š</p><pre><code class=\"language-c++\">#include &lt;threads.h&gt;\n#include &lt;stdio.h&gt;\n#include &lt;stdatomic.h&gt;\n#if !defined(__STDC_NO_ATOMICS__)\natomic_int x = 0, y = 0;\n#endif\nint run(void* v) {\n&nbsp; x = 10;\n&nbsp; y = 20;  // ï¼å˜é‡ y çš„å€¼å¯èƒ½è¢«ä¼˜å…ˆæ›´æ–°ï¼\n}\nint observe(void* v) {\n&nbsp; while(y != 20) ;&nbsp; // å¿™ç­‰å¾…ï¼›\n&nbsp; printf(\"%d\", x);  // åªåœ¨ x è¢«æ›´æ–°åæ‰“å°ï¼›\n}\nint main(void) {\n#if !defined(__STDC_NO_THREADS__)\n&nbsp; thrd_t threadA, threadB;&nbsp;&nbsp;\n&nbsp; thrd_create(&amp;threadA, run, NULL);\n&nbsp; thrd_create(&amp;threadB, observe, NULL);\n&nbsp; thrd_join(threadA, NULL);\n&nbsp; thrd_join(threadB, NULL);\n#endif\n&nbsp; return 0;&nbsp;\n}\n</code></pre><p>åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬åœ¨ main å‡½æ•°å†…ç”Ÿæˆäº†ä¸¤ä¸ªçº¿ç¨‹ï¼Œåˆ†åˆ«å¯¹åº”äºå‡½æ•° run å’Œ observeã€‚å…¶ä¸­ï¼Œobserve çº¿ç¨‹åœ¨æ‰§è¡Œæ—¶ä¼šé€šè¿‡â€œå¿™ç­‰å¾…â€çš„æ–¹å¼ï¼Œä¸æ–­æŸ¥è¯¢å˜é‡ y çš„çŠ¶æ€ï¼Œå¹¶åœ¨å‘ç°å…¶å€¼å˜æ›´ä¸º 20 åï¼Œå†ç»§ç»­æ‰§è¡Œæ¥ä¸‹æ¥çš„ printf å‡½æ•°ã€‚è€Œ run çº¿ç¨‹åœ¨æ‰§è¡Œæ—¶ï¼Œä»…ä¼šç®€å•åœ°å°†å˜é‡ x æ›´æ–°ä¸ºå€¼ 10ï¼Œç„¶åå†å°†å˜é‡ y çš„å€¼æ›´æ–°ä¸º 20ã€‚è¿™æ˜¯æˆ‘ä»¬é€šè¿‡æŸ¥çœ‹ä¸Šè¿° C ä»£ç å¾—å‡ºçš„ç»“è®ºã€‚</p><p>ä½†ç”±äºæŒ‡ä»¤é‡æ’çš„å­˜åœ¨ï¼Œrun å‡½æ•°åœ¨ç¨‹åºå®é™…æ‰§è¡Œæ—¶ï¼Œå…¶å†…éƒ¨å¯¹å˜é‡ x ä¸ y çš„å€¼å˜æ›´è¿‡ç¨‹ï¼Œå¯èƒ½ä¸æˆ‘ä»¬åœ¨ C ä»£ç ä¸­è§‚å¯Ÿåˆ°çš„é¡ºåºå¹¶ä¸ä¸€è‡´ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå˜é‡ y çš„å€¼å¯èƒ½ä¼šè¢«ä¼˜å…ˆæ›´æ–°ã€‚è€Œå¦‚æœæ­¤æ—¶ observe çº¿ç¨‹è¢«é‡æ–°è°ƒåº¦ï¼Œåˆ™ printf è¯­å¥ä¾¿ä¼šæ‰“å°å‡ºå¹¶éæˆ‘ä»¬æ‰€æœŸæœ›çš„å€¼ã€‚</p><p>ä¸ºæ­¤ï¼ŒC è¯­è¨€ä¸ºæˆ‘ä»¬æä¾›äº†ç›¸åº”çš„è¢«ç§°ä¸ºâ€œå†…å­˜é¡ºåºï¼ˆMemory Orderï¼‰â€çš„ä¸€ç³»åˆ—æšä¸¾å€¼ã€‚é€šè¿‡é…åˆç‰¹å®šçš„åº“å‡½æ•°ä¸€èµ·ä½¿ç”¨ï¼Œæˆ‘ä»¬èƒ½å¤Ÿæ˜ç¡®è§„å®šç¼–è¯‘å™¨åŠå¤„ç†å™¨åº”è¯¥å¦‚ä½•å¯¹æŸæ®µä»£ç çš„æŒ‡ä»¤é‡æ’è¿›è¡Œçº¦æŸã€‚ä¸‹ä¸€è®²ï¼Œåœ¨â€œä½¿ç”¨åŸå­æ“ä½œâ€å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬è¿˜ä¼šå›é¡¾ä¸Šé¢çš„è¿™ä¸ªä¾‹å­ã€‚</p><h2>æ€»ç»“</h2><p>å¥½äº†ï¼Œè®²åˆ°è¿™é‡Œï¼Œä»Šå¤©çš„å†…å®¹ä¹Ÿå°±åŸºæœ¬ç»“æŸäº†ã€‚æœ€åæˆ‘æ¥ç»™ä½ æ€»ç»“ä¸€ä¸‹ã€‚</p><p>è¿™ä¸€è®²ï¼Œæˆ‘ä¸»è¦ä»‹ç»äº†ä¸ C å¹¶å‘ç¼–ç¨‹æœ‰å…³çš„ä¸€äº›åŸºæœ¬æ¦‚å¿µã€‚å½“ç„¶ï¼Œè¿™äº›æ¦‚å¿µæœ¬èº«éƒ½è¾ƒä¸ºé€šç”¨ï¼Œå®ƒä»¬ä¹Ÿå¯ä»¥åº”ç”¨åœ¨å…¶ä»–ç¼–ç¨‹è¯­è¨€çš„ç¯å¢ƒä¸­ã€‚</p><p>æˆ‘ä»¬é¦–å…ˆå¯¹æ¯”äº†è¿›ç¨‹ä¸çº¿ç¨‹ä¸¤è€…ä¹‹é—´çš„ä¸åŒã€‚å…¶ä¸­ï¼Œè¿›ç¨‹ä¸»è¦åˆ’åˆ†äº†è¿è¡Œç¨‹åºæ‰€äº«æœ‰çš„èµ„æºè¾¹ç•Œï¼›è€Œçº¿ç¨‹åˆ™åœ¨å…±äº«è¿›ç¨‹èµ„æºçš„æƒ…å†µä¸‹ï¼Œç‹¬ç«‹è´Ÿè´£ä¸åŒå­ä»»åŠ¡çš„æ‰§è¡Œæµç¨‹ã€‚é€šè¿‡ä½¿ç”¨å¤šçº¿ç¨‹ï¼Œç¨‹åºå¯ä»¥åˆ©ç”¨å¤šæ ¸ CPU çš„è®¡ç®—èµ„æºï¼Œåšåˆ°çœŸæ­£çš„ä»»åŠ¡å¹¶è¡Œã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»‹ç»äº†å¦‚ä½•åœ¨ C ä»£ç ä¸­åˆ›å»ºçº¿ç¨‹ã€‚C æ ‡å‡†å°†ä¸çº¿ç¨‹æ§åˆ¶ç›¸å…³çš„æ¥å£æ•´åˆåœ¨äº†åä¸º threads.h çš„å¤´æ–‡ä»¶ä¸­ã€‚å€ŸåŠ© thrd_createã€thrd_join ç­‰å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°å¯¹çº¿ç¨‹çš„åˆ›å»ºã€ç­‰å¾…ã€é˜»å¡ã€åˆ†ç¦»ç­‰ä¸€ç³»åˆ—æ“ä½œã€‚</p><p>æœ€åï¼Œå¤šçº¿ç¨‹åº”ç”¨çš„æ­£ç¡®æ‰§è¡Œç¦»ä¸å¼€æˆ‘ä»¬å¯¹ç¨‹åºçš„åˆç†è®¾è®¡ã€‚æˆ‘è¿˜è®²è§£äº†ç”±æ•°æ®ç«äº‰ã€é™æ€æ¡ä»¶ï¼Œä»¥åŠæŒ‡ä»¤é‡æ’ç­‰å› ç´ å¼•èµ·çš„æ½œåœ¨é—®é¢˜ã€‚æŒæ¡äº†è¿™äº›çŸ¥è¯†ï¼Œå†åˆç†ä½¿ç”¨æˆ‘å°†åœ¨ä¸‹ä¸€è®²ä¸­ä»‹ç»çš„å…¶ä»– C11 å¹¶å‘ç¼–ç¨‹ç‰¹æ€§ï¼Œä½ å°±èƒ½åœ¨ä¸€å®šç¨‹åº¦ä¸Šè§£å†³å’Œé¿å…è¿™äº›é—®é¢˜ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>ä»€ä¹ˆç±»å‹çš„åº”ç”¨æ›´é€‚åˆä½¿ç”¨å¤šçº¿ç¨‹æŠ€æœ¯æ¥æå‡å…¶è¿è¡Œæ—¶æ€§èƒ½ï¼Ÿä½ å¯ä»¥å…ˆè¯•ç€æŸ¥æ‰¾èµ„æ–™ï¼Œå¹¶åœ¨è¯„è®ºåŒºåˆ†äº«ä½ çš„æ€è€ƒã€‚</p><p>ä»Šå¤©çš„è¯¾ç¨‹åˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œå¸Œæœ›å¯ä»¥å¸®åŠ©åˆ°ä½ ï¼Œä¹Ÿå¸Œæœ›ä½ åœ¨ä¸‹æ–¹çš„ç•™è¨€åŒºå’Œæˆ‘ä¸€èµ·è®¨è®ºã€‚åŒæ—¶ï¼Œæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™ä½ çš„æœ‹å‹æˆ–åŒäº‹ï¼Œæˆ‘ä»¬ä¸€èµ·äº¤æµã€‚</p>","neighbors":{"left":{"article_title":"12ï½œæ ‡å‡†åº“ï¼šéæœ¬åœ°è·³è½¬ä¸å¯å˜å‚æ•°æ˜¯æ€æ ·å®ç°çš„ï¼Ÿ","id":475867},"right":{"article_title":"14ï½œæ ‡å‡†åº“ï¼šå¦‚ä½•ä½¿ç”¨äº’æ–¥é‡ç­‰æŠ€æœ¯åè°ƒçº¿ç¨‹è¿è¡Œï¼Ÿ","id":478213}},"comments":[{"had_liked":false,"id":330434,"user_name":"èµµå²©æ¾","can_delete":false,"product_type":"c1","uid":2032451,"ip_address":"","ucode":"596694E4360482","user_header":"https://static001.geekbang.org/account/avatar/00/1f/03/43/ed0dcb27.jpg","comment_is_top":false,"comment_ctime":1641976821,"is_pvip":false,"replies":[{"id":"120563","content":"æ˜¯çš„ï¼Œå…¶å® PCB ä¸ TCB å°±æ˜¯é’ˆå¯¹è¿›ç¨‹å’Œçº¿ç¨‹çš„ä¸¤ä¸ªä¸åŒçš„æŠ½è±¡æ¦‚å¿µï¼Œå…·ä½“å®ç°æ˜¯å¯ä»¥å¤šç§å¤šæ ·çš„ã€‚ç®€å•æ¥è®²ï¼ŒLinux åœ¨å®ç°ä¸­æ²¡æœ‰ä¸ºè¿›ç¨‹å’Œçº¿ç¨‹å•ç‹¬è®¾ç½®ç”¨äºå­˜æ”¾ç›¸å…³ä¿¡æ¯çš„æ•°æ®ç»“æ„ï¼Œè€Œæ˜¯ç»Ÿä¸€ä½¿ç”¨ task_struct å­˜å‚¨é€šç”¨çš„ä»»åŠ¡ä¿¡æ¯ï¼Œä½¿ç”¨ thread_info å­˜æ”¾å¹³å°ç›¸å…³çš„ä¿¡æ¯ã€‚åŒºåˆ†æ˜¯ä¸æ˜¯çº¿ç¨‹å°±çœ‹ä¸åŒ task_struct å¯¹è±¡ä¹‹é—´æœ‰æ²¡æœ‰å…±äº«èµ„æºã€‚å³ä½ å¯ä»¥è®¤ä¸ºåœ¨ Linux ä¸­åªæœ‰è¿›ç¨‹ï¼ˆPCBï¼‰ï¼Œæ²¡æœ‰ç‹¬ç«‹çš„çº¿ç¨‹ï¼ˆTCBï¼‰ã€‚è€Œç›¸è¾ƒäº Windows å’Œ Sun Solaris ç­‰æ˜ç¡®åŒºåˆ†è¿›ç¨‹ä¸çº¿ç¨‹çš„æ“ä½œç³»ç»Ÿå®ç°ï¼ŒLinux çš„å®ç°ç›¸å¯¹æ›´åŠ ä¼˜é›…ã€‚<br>â€” å‚è€ƒè‡ªã€ŠLinux Kernel Development 3rd Editionã€‹ï¼ŒåŸºäº 2.6 ç‰ˆæœ¬å†…æ ¸ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1005890","ctime":1642067646,"ip_address":"","comment_id":330434,"utype":1}],"discussion_count":1,"race_medal":0,"score":"31706747893","product_id":100100701,"comment_content":"å¯¹äºPCBæˆ‘ä¸€ç›´æœ‰ä¸€ä¸ªç–‘æƒ‘ï¼Œåœ¨æˆ‘çš„ç†è§£ä¸­è¿™ä¸ªæ¦‚å¿µæ˜¯æ“ä½œç³»ç»Ÿç»Ÿä¸€çš„ä¸€ä¸ªæŠ½è±¡æ¦‚å¿µï¼ŒåŒæ—¶æ®æˆ‘æ‰€çŸ¥Linuxä¸­å­˜åœ¨ä¸¤ä¸ªè¿›ç¨‹ç›¸å…³çš„ç»“æ„ï¼š`thread_info`å’Œ`task_struct`ï¼Œé‚£ä¹ˆPCBå’Œè¿™ä¸¤ä¸ªç»“æ„æœ‰æ²¡æœ‰å¯¹åº”å…³ç³»å‘¢ï¼Ÿè‡³äºTCBæ˜¯æˆ‘ä»Šå¤©ç¬¬ä¸€æ¬¡å¬åˆ°çš„ä¸€ä¸ªæ¦‚å¿µï¼ŒåŒæ ·çš„è¿™ä¸ªæ¦‚å¿µä¸å‰é¢æåˆ°çš„ä¸¤ä¸ªLinuxç»“æ„æœ‰å¯¹åº”å…³ç³»å—ï¼Ÿ","like_count":7,"discussions":[{"author":{"id":1005890,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/59/42/e1757583.jpg","nickname":"Jason Yu äºèˆª","note":"","ucode":"0731492F4BC77D","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":545863,"discussion_content":"æ˜¯çš„ï¼Œå…¶å® PCB ä¸ TCB å°±æ˜¯é’ˆå¯¹è¿›ç¨‹å’Œçº¿ç¨‹çš„ä¸¤ä¸ªä¸åŒçš„æŠ½è±¡æ¦‚å¿µï¼Œå…·ä½“å®ç°æ˜¯å¯ä»¥å¤šç§å¤šæ ·çš„ã€‚ç®€å•æ¥è®²ï¼ŒLinux åœ¨å®ç°ä¸­æ²¡æœ‰ä¸ºè¿›ç¨‹å’Œçº¿ç¨‹å•ç‹¬è®¾ç½®ç”¨äºå­˜æ”¾ç›¸å…³ä¿¡æ¯çš„æ•°æ®ç»“æ„ï¼Œè€Œæ˜¯ç»Ÿä¸€ä½¿ç”¨ task_struct å­˜å‚¨é€šç”¨çš„ä»»åŠ¡ä¿¡æ¯ï¼Œä½¿ç”¨ thread_info å­˜æ”¾å¹³å°ç›¸å…³çš„ä¿¡æ¯ã€‚åŒºåˆ†æ˜¯ä¸æ˜¯çº¿ç¨‹å°±çœ‹ä¸åŒ task_struct å¯¹è±¡ä¹‹é—´æœ‰æ²¡æœ‰å…±äº«èµ„æºã€‚å³ä½ å¯ä»¥è®¤ä¸ºåœ¨ Linux ä¸­åªæœ‰è¿›ç¨‹ï¼ˆPCBï¼‰ï¼Œæ²¡æœ‰ç‹¬ç«‹çš„çº¿ç¨‹ï¼ˆTCBï¼‰ã€‚è€Œç›¸è¾ƒäº Windows å’Œ Sun Solaris ç­‰æ˜ç¡®åŒºåˆ†è¿›ç¨‹ä¸çº¿ç¨‹çš„æ“ä½œç³»ç»Ÿå®ç°ï¼ŒLinux çš„å®ç°ç›¸å¯¹æ›´åŠ ä¼˜é›…ã€‚\nâ€” å‚è€ƒè‡ªã€ŠLinux Kernel Development 3rd Editionã€‹ï¼ŒåŸºäº 2.6 ç‰ˆæœ¬å†…æ ¸ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642067646,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":330445,"user_name":"=","can_delete":false,"product_type":"c1","uid":2600127,"ip_address":"","ucode":"104232A8292220","user_header":"https://static001.geekbang.org/account/avatar/00/27/ac/bf/f549183e.jpg","comment_is_top":false,"comment_ctime":1641979208,"is_pvip":false,"replies":[{"id":"120557","content":"å›ç­”çš„å¾ˆæ£’ï¼","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1005890","ctime":1642065476,"ip_address":"","comment_id":330445,"utype":1}],"discussion_count":1,"race_medal":0,"score":"23116815688","product_id":100100701,"comment_content":"1. IOå¯†é›†å‹çš„åº”ç”¨ã€‚å› ä¸ºCPUç­‰å¾…IOå®Œæˆçš„æ—¶é—´å¾ˆå¤šï¼Œåœ¨ç­‰å¾…çš„æ—¶é—´å†…ï¼Œå¤šçº¿ç¨‹å¯ä»¥è®©å…¶ä»–åº”ç”¨ç»§ç»­æ‰§è¡Œ<br>2. æœ‰å¤šæ ¸CPUæ—¶çš„è®¡ç®—å¯†é›†å‹åº”ç”¨ã€‚å› ä¸ºå¯ä»¥åˆ©ç”¨å¤šæ ¸CPUå¹¶è¡Œçš„ä¼˜åŠ¿ï¼Œæ¥å¿«é€Ÿå®Œæˆè®¡ç®—","like_count":6,"discussions":[{"author":{"id":1005890,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/59/42/e1757583.jpg","nickname":"Jason Yu äºèˆª","note":"","ucode":"0731492F4BC77D","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":545844,"discussion_content":"å›ç­”çš„å¾ˆæ£’ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642065476,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":356630,"user_name":"Luke","can_delete":false,"product_type":"c1","uid":1216016,"ip_address":"æ±Ÿè‹","ucode":"C34D4C44DBCE03","user_header":"https://static001.geekbang.org/account/avatar/00/12/8e/10/10092bb1.jpg","comment_is_top":false,"comment_ctime":1662456322,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5957423618","product_id":100100701,"comment_content":"Windowsçš„VCå¯¹äºc11çš„threadsæ”¯æŒä¸å¥½ï¼Œå¾®è½¯æ˜¯å¸Œæœ›å¤§å®¶åœ¨å®ƒå¹³å°ä¸Šç”¨cè‰¹ğŸ˜‚ï¼Œå¦‚æœå¤´é“éè¦åœ¨Windowsä¸Šå†™æ ‡å‡†åŒ–çš„Cè¯­è¨€ç¨‹åºï¼Œthreadsè¿™å—è€å¸ˆæœ‰ä»€ä¹ˆæ›¿ä»£æ–¹æ¡ˆå—ï¼Ÿpthreadï¼Ÿ<br>ä¸€å¼€å§‹åœ¨Linuxä¸‹gccç¼–è¯‘ï¼Œæç¤ºæ‰¾ä¸åˆ°thrd_xxçš„ç¬¦å·ï¼ŒåŸæ¥ç¼–è¯‘é€‰é¡¹è¦ä»-lthreadsæ”¹æˆ-pthreads","like_count":1},{"had_liked":false,"id":344987,"user_name":"å°æ°","can_delete":false,"product_type":"c1","uid":2853200,"ip_address":"","ucode":"BBDF8E9F348F65","user_header":"https://static001.geekbang.org/account/avatar/00/2b/89/50/aee9fdab.jpg","comment_is_top":false,"comment_ctime":1651913922,"is_pvip":true,"replies":[{"id":"126168","content":"èµğŸ‘ğŸ»","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1005890","ctime":1652584523,"ip_address":"","comment_id":344987,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5946881218","product_id":100100701,"comment_content":"å¦‚æœç¼–è¯‘æ˜¾ç¤ºæ²¡æœ‰threadsæ–‡ä»¶ï¼Œæœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥è§£å†³ã€‚1ã€ä½¿ç”¨pthread.hå¤´æ–‡ä»¶ï¼Œä½¿ç”¨æ–¹å¼ä¸threadsä¸€æ ·ï¼Œä¹Ÿæœ‰ä¸åŒçš„åœ°æ–¹ï¼Œä½†æ˜¯æå°‘ã€‚2ã€ä½¿ç”¨ubuntu20.04,gcc+glibcéƒ½æ˜¯æ”¯æŒthreads.hçš„ï¼Œç¼–è¯‘æ—¶å¯èƒ½ä¹Ÿä¼šå‡ºç°æ²¡æœ‰æ­¤æ–‡ä»¶çš„é”™è¯¯ï¼Œå› ä¸ºç¼ºå°‘ä¸€äº›æ–‡ä»¶ã€‚å…·ä½“å¸Œæœ›å¤§å®¶åŠ¨æ‰‹å»è§£å†³ã€‚<br>æœ€åå›ç­”ä¸€ä¸‹è€å¸ˆçš„é—®é¢˜ï¼Œé€‚åˆåœºæ™¯åº”è¯¥æ˜¯é«˜å¹¶å‘ï¼Œæ¯”å¦‚å¤§é‡æ¶ˆæ¯é˜Ÿåˆ—çš„å¤„ç†ï¼Œå¯ä»¥ä½¿ç”¨å¤šçº¿ç¨‹ã€‚å¯ä»¥ä¸ç”¨å»ç­‰å¾…ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œå†å»æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ï¼Œè¿™æ ·å¯ä»¥å……åˆ†åˆ©ç”¨cpu","like_count":1,"discussions":[{"author":{"id":1005890,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/59/42/e1757583.jpg","nickname":"Jason Yu äºèˆª","note":"","ucode":"0731492F4BC77D","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":572052,"discussion_content":"èµğŸ‘ğŸ»","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1652584523,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":333582,"user_name":"ã€€ç„šå¿ƒä»¥ç«","can_delete":false,"product_type":"c1","uid":1251067,"ip_address":"","ucode":"41AB4C408C96D1","user_header":"https://static001.geekbang.org/account/avatar/00/13/16/fb/2727d82c.jpg","comment_is_top":false,"comment_ctime":1644411698,"is_pvip":false,"replies":[{"id":"121916","content":"å¤§å¤šæ•°æƒ…å†µæ˜¯ç”±äºç¼–è¯‘å™¨ä¸æ”¯æŒ C11 çš„å¤šçº¿ç¨‹ç‰¹æ€§ï¼Œä½ å¯ä»¥é€šè¿‡æ£€æµ‹å®å¸¸é‡ __STDC_NO_THREADS__ æ¥åˆ¤æ–­å½“å‰ç¼–è¯‘å™¨æ˜¯å¦æ”¯æŒ threads.hï¼Œç„¶åä»…åœ¨æ”¯æŒçš„æƒ…å†µä¸‹å† includeã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1005890","ctime":1644510521,"ip_address":"","comment_id":333582,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5939378994","product_id":100100701,"comment_content":"å¤§å®¶æœ‰é‡åˆ° fatal error: &#39;threads.h&#39; file not found æ˜¯æ€ä¹ˆè§£å†³çš„å‘¢ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1005890,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/59/42/e1757583.jpg","nickname":"Jason Yu äºèˆª","note":"","ucode":"0731492F4BC77D","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":550410,"discussion_content":"å¤§å¤šæ•°æƒ…å†µæ˜¯ç”±äºç¼–è¯‘å™¨ä¸æ”¯æŒ C11 çš„å¤šçº¿ç¨‹ç‰¹æ€§ï¼Œä½ å¯ä»¥é€šè¿‡æ£€æµ‹å®å¸¸é‡ __STDC_NO_THREADS__ æ¥åˆ¤æ–­å½“å‰ç¼–è¯‘å™¨æ˜¯å¦æ”¯æŒ threads.hï¼Œç„¶åä»…åœ¨æ”¯æŒçš„æƒ…å†µä¸‹å† includeã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644510521,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":330350,"user_name":"ppm","can_delete":false,"product_type":"c1","uid":2550034,"ip_address":"","ucode":"A52733E4654270","user_header":"https://static001.geekbang.org/account/avatar/00/26/e9/12/a1d173fe.jpg","comment_is_top":false,"comment_ctime":1641947294,"is_pvip":false,"replies":[{"id":"120374","content":"å¯ä»¥å†æè¿°çš„å…·ä½“ç‚¹ï¼Ÿ","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1005890","ctime":1641968090,"ip_address":"","comment_id":330350,"utype":1}],"discussion_count":4,"race_medal":0,"score":"5936914590","product_id":100100701,"comment_content":"è¯·é—®ä¸€ä¸ªè¿›ç¨‹é‡Œé¢é•¿æ—¶é—´æœ‰å¤šä¸ªçº¿ç¨‹ å¥½ä¸å¥½","like_count":1,"discussions":[{"author":{"id":1005890,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/59/42/e1757583.jpg","nickname":"Jason Yu äºèˆª","note":"","ucode":"0731492F4BC77D","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":545457,"discussion_content":"å¯ä»¥å†æè¿°çš„å…·ä½“ç‚¹ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641968090,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":3,"child_discussions":[{"author":{"id":2550034,"avatar":"https://static001.geekbang.org/account/avatar/00/26/e9/12/a1d173fe.jpg","nickname":"ppm","note":"","ucode":"A52733E4654270","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1005890,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/59/42/e1757583.jpg","nickname":"Jason Yu äºèˆª","note":"","ucode":"0731492F4BC77D","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":545530,"discussion_content":"å¦‚æœä¸€ä¸ªåº”ç”¨é‡Œé¢å¤šçº¿ç¨‹ä¸€ç›´è¿è¡Œï¼Œä¼šé€ æˆå•æ ¸cpuè´Ÿè½½é«˜å—","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641987802,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":545457,"ip_address":""},"score":545530,"extra":""},{"author":{"id":1188710,"avatar":"https://static001.geekbang.org/account/avatar/00/12/23/66/413c0bb5.jpg","nickname":"LDxy","note":"","ucode":"956432CE7B7761","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2550034,"avatar":"https://static001.geekbang.org/account/avatar/00/26/e9/12/a1d173fe.jpg","nickname":"ppm","note":"","ucode":"A52733E4654270","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":545540,"discussion_content":"å°±ç®—åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨å•æ ¸CPUä¸Šä¸€ç›´è¿è¡Œï¼ŒCPUè´Ÿè½½ä¹Ÿä¼šå¾ˆé«˜","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1641992292,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":545530,"ip_address":""},"score":545540,"extra":""},{"author":{"id":1707352,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKwGurTWOiaZ2O2oCdxK9kbF4PcwGg0ALqsWhNq87hWvwPy8ZU9cxRzmcGOgdIeJkTOoKfbxgEKqrg/132","nickname":"ZR2021","note":"","ucode":"4F685C7516F057","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2550034,"avatar":"https://static001.geekbang.org/account/avatar/00/26/e9/12/a1d173fe.jpg","nickname":"ppm","note":"","ucode":"A52733E4654270","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":545625,"discussion_content":"çœ‹ä½ çº¿ç¨‹ä»£ç æ€ä¹ˆå†™çš„ï¼Œä¸€èˆ¬çº¿ç¨‹è¦ä¹ˆé˜»å¡åœ¨é”ï¼Œä¿¡å·é‡æˆ–è€…è¯»ç›¸å…³æ•°æ®ä¸Šé¢ï¼Œè¦ä¹ˆå°±æ˜¯æœ‰ä¸ªç¡çœ æ“ä½œï¼Œè¿™äº›åŸºæœ¬ä¸ä¼šé€ æˆcpué«˜ï¼Œé™¤éä½ å¾ªç¯é‡Œåšçš„æ˜¯é•¿æ—¶é—´çš„cpuå¯†é›†å‹æ“ä½œ","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1642003751,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":545530,"ip_address":""},"score":545625,"extra":""}]}]},{"had_liked":false,"id":360657,"user_name":"æ°è‰¯","can_delete":false,"product_type":"c1","uid":2567349,"ip_address":"å¹¿ä¸œ","ucode":"5DC1D1C58A4731","user_header":"https://static001.geekbang.org/account/avatar/00/27/2c/b5/10141329.jpg","comment_is_top":false,"comment_ctime":1666740230,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1666740230","product_id":100100701,"comment_content":"è€å¸ˆå¥½ï¼ŒæŒ‡ä»¤é‡æ’çš„ä¾‹å­ï¼Œè¯•äº†åå¤šæ¬¡æ²¡å‡ºç°æ‰“å° x ä¸º 0 çš„æƒ…å†µã€‚è¿™é‡Œå¯èƒ½å‘ç”Ÿçš„å…ˆæ‰§è¡Œ y å˜é‡çš„æ›´æ–°çš„åŸå› ä¼šæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ","like_count":0},{"had_liked":false,"id":347100,"user_name":"æ¼ åšåµ©","can_delete":false,"product_type":"c1","uid":2660316,"ip_address":"","ucode":"33704880E9790F","user_header":"https://static001.geekbang.org/account/avatar/00/28/97/dc/8eacc8f1.jpg","comment_is_top":false,"comment_ctime":1653714232,"is_pvip":true,"replies":[{"id":"127247","content":"å“ªä¸€ä¸ªå‡½æ•°æ²¡æ‰¾åˆ°ï¼Ÿ","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1005890","ctime":1656223689,"ip_address":"","comment_id":347100,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1653714232","product_id":100100701,"comment_content":"cmake è¯´æ‰¾ä¸åˆ°ã€‚å‡½æ•°","like_count":0,"discussions":[{"author":{"id":1005890,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/59/42/e1757583.jpg","nickname":"Jason Yu äºèˆª","note":"","ucode":"0731492F4BC77D","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":577599,"discussion_content":"å“ªä¸€ä¸ªå‡½æ•°æ²¡æ‰¾åˆ°ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1656223689,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}