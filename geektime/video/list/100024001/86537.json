{"id":86537,"title":"24 | 共享内存并发机制","content":"<h1>课件及源代码地址</h1><p><a href=\"https://gitee.com/geektime-geekbang/go_learning\">https://gitee.com/geektime-geekbang/go_learning</a></p><h2>书目推荐</h2><p><a href=\"time://mall?url=https%3A%2F%2Fh5.youzan.com%2Fv2%2Fgoods%2F1ycmk3uob0ryw\">《计算机程序的构造和解释》</a></p>","comments":[{"had_liked":false,"id":80677,"user_name":"Chris","can_delete":false,"product_type":"c3","uid":1024842,"ip_address":"","ucode":"47E030165390BE","user_header":"https://static001.geekbang.org/account/avatar/00/0f/a3/4a/2006a4dc.jpg","comment_is_top":false,"comment_ctime":1553697336,"is_pvip":false,"replies":[{"id":29404,"content":"好问题。你完全可以写个程序动手试试。然后，记得把结果分享给大家。","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1553750634,"ip_address":"","comment_id":80677,"utype":1}],"discussion_count":4,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"老师，假如mut.Lock()之前有一段代码，并且还没有执行到这里就出错了，那么defer里面的Unlock就会先执行，这样是不是会出错？","like_count":5,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":444941,"discussion_content":"好问题。你完全可以写个程序动手试试。然后，记得把结果分享给大家。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1553750634,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1233073,"avatar":"https://static001.geekbang.org/account/avatar/00/12/d0/b1/87853049.jpg","nickname":"郑文祥","note":"","ucode":"730452A9B3376A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":2473,"discussion_content":"换成fmt.Printf就能打印出来，那testing包中的Log和fmt中的有什么区别呢？为什么我用t.Log就不会打印日志，fmt.Printf就能打印出来？我在go test中加了-v选项","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563687074,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1233073,"avatar":"https://static001.geekbang.org/account/avatar/00/12/d0/b1/87853049.jpg","nickname":"郑文祥","note":"","ucode":"730452A9B3376A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":2472,"discussion_content":"老师，我在goroutine中Lock前加了个panic，发现程序并没有走到defer里面，这是为什么呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563685283,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2198970,"avatar":"","nickname":"Geek_1acb32","note":"","ucode":"73290D0435996F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1233073,"avatar":"https://static001.geekbang.org/account/avatar/00/12/d0/b1/87853049.jpg","nickname":"郑文祥","note":"","ucode":"730452A9B3376A","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":337785,"discussion_content":"我认为是因为defer语句在panic之后，当panic时，其后面的语句就运行不到了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609076863,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":2472,"ip_address":"","group_id":0},"score":337785,"extra":""}]}]},{"had_liked":false,"id":156824,"user_name":"码农Kevin亮","can_delete":false,"product_type":"c3","uid":1116630,"ip_address":"","ucode":"D34562461CA0A1","user_header":"https://static001.geekbang.org/account/avatar/00/11/09/d6/5f366427.jpg","comment_is_top":false,"comment_ctime":1574985823,"is_pvip":false,"replies":[{"id":60361,"content":"1.在设计函数的时候就想清楚收尾工作，释放资源\n2.便于排错时，快速确定没有资源&#47;锁等释放问题","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1575168600,"ip_address":"","comment_id":156824,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"为什么老师喜欢把defer函数写在最前面，看起来逻辑怪怪的","like_count":4,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":476243,"discussion_content":"1.在设计函数的时候就想清楚收尾工作，释放资源\n2.便于排错时，快速确定没有资源/锁等释放问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1575168600,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":77781,"user_name":"Gary","can_delete":false,"product_type":"c3","uid":1218372,"ip_address":"","ucode":"12265D6A578113","user_header":"https://static001.geekbang.org/account/avatar/00/12/97/44/3929e620.jpg","comment_is_top":false,"comment_ctime":1552997730,"is_pvip":false,"replies":[{"id":28414,"content":"这个看你的应用场景。","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1553006109,"ip_address":"","comment_id":77781,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"wg.done()是不是放到defer函数里更好？","like_count":3,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":443850,"discussion_content":"这个看你的应用场景。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1553006109,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":77764,"user_name":"心向无限","can_delete":false,"product_type":"c3","uid":1447843,"ip_address":"","ucode":"D4F5444FEFDB49","user_header":"https://static001.geekbang.org/account/avatar/00/16/17/a3/9f5430fa.jpg","comment_is_top":false,"comment_ctime":1552995655,"is_pvip":false,"replies":[{"id":28417,"content":"刚才已经联系过平台了，明天平台回补上这一期","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1553006671,"ip_address":"","comment_id":77764,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"线程机制？没有这课啊？","like_count":3,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":443842,"discussion_content":"刚才已经联系过平台了，明天平台回补上这一期","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1553006671,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":120470,"user_name":"hj","can_delete":false,"product_type":"c3","uid":1264287,"ip_address":"","ucode":"6ED34286AC30FA","user_header":"https://static001.geekbang.org/account/avatar/00/13/4a/9f/b92a9139.jpg","comment_is_top":false,"comment_ctime":1564909219,"is_pvip":false,"replies":[{"id":44721,"content":"其实share memory的锁，更应该看成是共享内容上的锁，每个访问者（协程&#47;线程）在访问共享内容前要先获取这个锁（lock），如果无法锁住就要等待释放，所以才会在每个协程里要先锁住再释放。并不是说释放别人&#47;自己的锁","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1565190741,"ip_address":"","comment_id":120470,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"...\nfor i := 0; i &lt; 5000; i++ {\n  &#47;&#47; 加锁，放在协程的外面\n  mutex.Lock()\n  go func() {\n    defer func() {\n\tmutex.Unlock()\n    }()\n    ......\n  }\n}\n...\n\n这样也能成功执行，结果是4999。奇怪的点是：在外面lock的，在协程内部可以unlock，也就是说协程可以unlock别人的锁？？？","like_count":1,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":461348,"discussion_content":"其实share memory的锁，更应该看成是共享内容上的锁，每个访问者（协程/线程）在访问共享内容前要先获取这个锁（lock），如果无法锁住就要等待释放，所以才会在每个协程里要先锁住再释放。并不是说释放别人/自己的锁","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565190741,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":79962,"user_name":"「ZY」","can_delete":false,"product_type":"c3","uid":1208912,"ip_address":"","ucode":"576332E29CC400","user_header":"https://static001.geekbang.org/account/avatar/00/12/72/50/68304a30.jpg","comment_is_top":false,"comment_ctime":1553584603,"is_pvip":false,"replies":[{"id":29193,"content":"这个要根据你的需求来看，用chan比较容易做成异步的，共享内存呢比较容易做同步的调用。当然，其实两者都可以构建同步或异步的处理。","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1553605589,"ip_address":"","comment_id":79962,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"蔡老师您好\n多个协程并发的去修改一个变量  需要用锁或者channel\n甚至以下代码  去append一个切片 或者 给map赋值 都不行\n会出现 concurrent map writes\n\n\tfor i := 0; i &lt; 100; i++ {\n\t\tgo func(i int) {\n\t\t\tslice = append(slice, 1)\n\t\t\tonlinemap[i] = i\n\n\t\t}(i)\n\t}\n那么我的问题来了：\n是不是 意味着用GO写服务器的时候  几乎所有的数据都需要加锁或者通过channel来操作了？\n比如我想创建一个TCP协议的服务器，n, err := conn.Read(buffer)\n读取过来的buffer 不管三七二十一，先放进channel再说是吗？","like_count":1,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":444704,"discussion_content":"这个要根据你的需求来看，用chan比较容易做成异步的，共享内存呢比较容易做同步的调用。当然，其实两者都可以构建同步或异步的处理。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1553605589,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1953243,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epsRcQM1w3rNhv9iaYxz7tDGtFQ6tKCbrjnic2uEAZFyd3TK8Sb24DUic2f845VtP0GnVnfRspwiaH5ug/132","nickname":"Geek_8607a4","note":"","ucode":"493EA87394BDD4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":225226,"discussion_content":"变量不被多个协程同时读写，是不会出现安全问题的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586352758,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":386755,"user_name":"Geek_c9206f","can_delete":false,"product_type":"c3","uid":3789456,"ip_address":"上海","ucode":"C9BC6595682EAE","user_header":"","comment_is_top":false,"comment_ctime":1705481480,"is_pvip":false,"replies":[{"id":141105,"content":"可以的","user_name":"作者回复","user_name_real":"编辑","uid":1008262,"ctime":1706495062,"ip_address":"北京","comment_id":386755,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"wg.Done() 是不是可以放在defer里面","like_count":0,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":636575,"discussion_content":"可以的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1706495063,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":260471,"user_name":"李圣悦","can_delete":false,"product_type":"c3","uid":1638427,"ip_address":"","ucode":"C1786C98824E50","user_header":"https://static001.geekbang.org/account/avatar/00/19/00/1b/eee13196.jpg","comment_is_top":false,"comment_ctime":1605017549,"is_pvip":false,"replies":[{"id":97498,"content":"请提供一些错误信息","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1608340121,"ip_address":"","comment_id":260471,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"老师，你好，为啥实力程序运行的时候偶尔会报错？主程序退出，协程会出错？\npackage gorutine_test\n\nimport (\n\t&quot;testing&quot;\n)\n\nfunc TestGroutine(t *testing.T) {\n\tfor i := 0; i &lt; 10; i++ {\n\t\tgo func(i int) {\n\t\t\tt.Log(i)\n\t\t}(i)\n\t}\n\n    &#47;&#47; ime.Sleep(time.Millisecond * 50)\n}\n","like_count":0,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":509204,"discussion_content":"请提供一些错误信息","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608340121,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1020525,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/92/6d/becd841a.jpg","nickname":"escray","note":"","ucode":"1F4204930E47C4","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":365722,"discussion_content":"我这里可以运行，是不是 package 写错了？gorutine_test ?","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617871259,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":245666,"user_name":"Geek_9a021c","can_delete":false,"product_type":"c3","uid":1988279,"ip_address":"","ucode":"DB41B43AEAD3F8","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI6zpHWIiaWSoY6b99O8QKG1IWhmOEXL8QnMenD3ErtIOUtkXVOd1mRBnvCQ4YoCqaDKDuIVd1Xe7Q/132","comment_is_top":false,"comment_ctime":1599019348,"is_pvip":false,"replies":[{"id":90445,"content":"看你锁的范围和粒度，让能并行的尽量并行","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1599182746,"ip_address":"","comment_id":245666,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"这个协程安全的循环跟不用协程的执行效率上有什么区别吗，感觉这里加了lock就变成顺序执行就不是并发了。","like_count":0,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":504950,"discussion_content":"看你锁的范围和粒度，让能并行的尽量并行","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599182746,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":234062,"user_name":"Aprelude","can_delete":false,"product_type":"c3","uid":1658796,"ip_address":"","ucode":"840D3F7A35AEEF","user_header":"https://static001.geekbang.org/account/avatar/00/19/4f/ac/80439ba7.jpg","comment_is_top":false,"comment_ctime":1594569041,"is_pvip":false,"replies":[{"id":87661,"content":"可以","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1595767002,"ip_address":"","comment_id":234062,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"go func() {\n\t\t\t&#47;&#47;在defer里面进行释放锁\n\t\t\tmut.Lock()\n\t\t\tdefer func() {\n\t\t\t\tmut.Unlock()\n\t\t\t}()\n\t\t\tcounter++\n\t\t}()\n这种写法可以吗","like_count":0,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":501261,"discussion_content":"可以","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595767002,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":228091,"user_name":"黄三可","can_delete":false,"product_type":"c3","uid":1132988,"ip_address":"","ucode":"DDD0ED0C1E419F","user_header":"https://static001.geekbang.org/account/avatar/00/11/49/bc/c324a7de.jpg","comment_is_top":false,"comment_ctime":1592552775,"is_pvip":false,"replies":[{"id":84176,"content":"完全可以啊，你可以启动不同协程，这些协程为不同的函数实现","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1592638562,"ip_address":"","comment_id":228091,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"请问下，假如我想要像java一样，不同的协程运行不同的逻辑，如何处理？","like_count":0,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":498918,"discussion_content":"完全可以啊，你可以启动不同协程，这些协程为不同的函数实现","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592638562,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":202958,"user_name":"Crazy","can_delete":false,"product_type":"c3","uid":1201383,"ip_address":"","ucode":"B509FCB4498015","user_header":"https://static001.geekbang.org/account/avatar/00/12/54/e7/b756c98f.jpg","comment_is_top":false,"comment_ctime":1586093284,"is_pvip":false,"replies":[{"id":75897,"content":"需要的。对可以用读写锁","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1586138832,"ip_address":"","comment_id":202958,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"老师，我想问下，只有一个协程写，多个协程读，这种情况下需不需要加锁？读写锁？","like_count":0,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":490717,"discussion_content":"需要的。对可以用读写锁","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586138832,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":136103,"user_name":"面向加薪学习","can_delete":false,"product_type":"c3","uid":1108117,"ip_address":"","ucode":"5164A1DF058AC5","user_header":"https://static001.geekbang.org/account/avatar/00/10/e8/95/13b88119.jpg","comment_is_top":false,"comment_ctime":1569365493,"is_pvip":false,"replies":[{"id":52479,"content":"没错。对应的。不是一接到就解除wait","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1569543308,"ip_address":"","comment_id":136103,"utype":1}],"discussion_count":2,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"请教老师，waitgroup是每次add(1)，done(),对应的吗?不是一接到done程序就跳到wait后执行吗？","like_count":0,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":468461,"discussion_content":"没错。对应的。不是一接到就解除wait","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1569543308,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1890825,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/da/09/5fc3b526.jpg","nickname":"郭泽鑫🐤","note":"","ucode":"40B9981EEC524F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":652041,"discussion_content":"// Done decrements the [WaitGroup] counter by one.\nfunc (wg *WaitGroup) Done() {\n\twg.Add(-1)\n}","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1728101180,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":89586,"user_name":"嗯哼","can_delete":false,"product_type":"c3","uid":1196748,"ip_address":"","ucode":"AA6464F7BA9A1A","user_header":"https://static001.geekbang.org/account/avatar/00/12/42/cc/505a9c3d.jpg","comment_is_top":false,"comment_ctime":1556227703,"is_pvip":false,"replies":[{"id":32186,"content":"因为读到脏数据（即别的协程已经更新了，但是当前协程不知道）所以，覆盖了别人的更新。","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1556282886,"ip_address":"","comment_id":89586,"utype":1}],"discussion_count":3,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"老师，我想请问一下一开始线程不安全的时候为什么count会比5000少呢？","like_count":0,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":448183,"discussion_content":"因为读到脏数据（即别的协程已经更新了，但是当前协程不知道）所以，覆盖了别人的更新。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1556282886,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1022267,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/99/3b/791d0f5e.jpg","nickname":"王先森","note":"","ucode":"1AF1A395107479","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":72635,"discussion_content":"我也没搞懂这块 还得去看书或google，感觉这块共享内存为什么少于5000一笔带过了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1575510110,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1953243,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epsRcQM1w3rNhv9iaYxz7tDGtFQ6tKCbrjnic2uEAZFyd3TK8Sb24DUic2f845VtP0GnVnfRspwiaH5ug/132","nickname":"Geek_8607a4","note":"","ucode":"493EA87394BDD4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1022267,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/99/3b/791d0f5e.jpg","nickname":"王先森","note":"","ucode":"1AF1A395107479","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":225240,"discussion_content":"可以理解counter++是两步操作，这两步操作并不是原子操作。a协程和b协程同时拿到counter的副本值，假设值是5，各自都在5上加1，然后接下来写回去6。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586353118,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":72635,"ip_address":"","group_id":0},"score":225240,"extra":""}]}]},{"had_liked":false,"id":78420,"user_name":"面朝大海春暖花开","can_delete":false,"product_type":"c3","uid":1118924,"ip_address":"","ucode":"F9F9F53D05304B","user_header":"https://static001.geekbang.org/account/avatar/00/11/12/cc/6a08cf26.jpg","comment_is_top":false,"comment_ctime":1553143770,"is_pvip":false,"replies":[{"id":28592,"content":"很好的思考。但只可能是最后一个，因为要想执行到wg.Done（）就必须得到锁，同时，只有一个携程会获得锁，必须等其他携程Unlock，而unlock又在最后一步。所以，counter的结果也不会错。","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1553180366,"ip_address":"","comment_id":78420,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"说错了。是有可能 n个 (n&gt;0 &amp;&amp; n&lt;=5000) 携程没有正常执行完，主线程就退出了，看defer里的逻辑吧。","like_count":0,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":444088,"discussion_content":"很好的思考。但只可能是最后一个，因为要想执行到wg.Done（）就必须得到锁，同时，只有一个携程会获得锁，必须等其他携程Unlock，而unlock又在最后一步。所以，counter的结果也不会错。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1553180366,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":101222,"user_name":"Eden","can_delete":false,"product_type":"c3","uid":1197733,"ip_address":"","ucode":"BE0AD731E5EF5E","user_header":"https://static001.geekbang.org/account/avatar/00/12/46/a5/51449de6.jpg","comment_is_top":false,"comment_ctime":1559744603,"is_pvip":false,"replies":null,"discussion_count":4,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"初学语言，用中文解释了一下，便于理解\n```go\nfunc TestCounter(t *testing.T) {\n\tcounter := 0\n\tfor i := 0; i &lt; 5000; i++ { &#47;&#47; 循环出 5000 个协程程序\n\t\tgo func() { &#47;&#47;执行这个协程匿名函数给 counter 自增\n\t\t\tcounter++\n\t\t}()\n\t}\n\t&#47;&#47; 执行完成后得到的结果并不是 5000，这是因为这 5000 个并发协程都在抢用 counter,\n\t&#47;&#47; 这样的话，整个程序是不安全的,我们需要对 counter 的共享内存做锁的保护\n\ttime.Sleep(1 * time.Second)\n\tt.Logf(&quot;counter = %d&quot;, counter)\n}\n\nfunc TestCounterThreadSafe(t *testing.T) {\n\tvar mut sync.Mutex &#47;&#47; ⚠️  1. 增加一个互斥锁\n\tcounter := 0\n\tfor i := 0; i &lt; 5000; i++ {\n\t\tgo func() {\n\t\t\tdefer func() { &#47;&#47; ⚠️  3. 使用 defer 用于释放资源，此处用于解除锁\n\t\t\t\tmut.Unlock()\n\t\t\t}()\n\t\t\tmut.Lock() &#47;&#47; ⚠️  2. counter 自增前加锁\n\t\t\tcounter++\n\t\t}()\n\t}\n\ttime.Sleep(1 * time.Second)\n\t&#47;&#47; 加这个延时是担心程序一下就跑完了，甚至协程还没有跑完，\n\t&#47;&#47; 给一个定时肯定不是万全之策，但是使用 waitGroup 就好办啦\n\tt.Logf(&quot;counter = %d&quot;, counter)\n}\n\nfunc TestCounterThreadSafeWaitGroup(t *testing.T) {\n\tvar mut sync.Mutex\n\tvar wg sync.WaitGroup &#47;&#47; 1.声明一个等待组\n\tcounter := 0\n\tfor i := 0; i &lt; 5000; i++ {\n\t\twg.Add(1) &#47;&#47; 3.每启动一个协程都新增加一个等待\n\t\tgo func() {\n\t\t\tdefer func() {\n\t\t\t\tmut.Unlock()\n\t\t\t}()\n\t\t\tmut.Lock()\n\t\t\tcounter++\n\t\t\twg.Done() &#47;&#47; 4.这个等待完成了\n\t\t}()\n\t}\n\twg.Wait()\n\t&#47;&#47; 2.这里等待上面所有的等待完成后马上走下面的程序\n\t&#47;&#47; 这样就可以准确的等待协程执行了\n\tt.Logf(&quot;counter = %d&quot;, counter)\n}\n\n```","like_count":24,"discussions":[{"author":{"id":2853200,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/89/50/aee9fdab.jpg","nickname":"小杰","note":"","ucode":"BBDF8E9F348F65","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":544818,"discussion_content":"很棒，我也是这样的学习，然后上传到gtihub。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641723192,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1359127,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqlqI5gE1MuPtKj6TgRBdoRnK2rKK3pGyVjkMia2431JVSgr0O4ScrqLoLe0T3mH8s6G04qtdk6zNg/132","nickname":"InfoQ_339e6b2a10f3","note":"","ucode":"B374F4812603FB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":351885,"discussion_content":"我就说我为啥结果总不对，原来是没休眠导致携程还没跑起来程序就结束了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1614513138,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1573551,"avatar":"https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI2huicolVwLfbbVsfhmLdGyTV2I6QMHdGm67ZdRkXTfmPJQd4Yibjge4dlrxOfAibeqLN48b1RVRdGw/132","nickname":"新龙","note":"","ucode":"B9202437EBC198","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":319851,"discussion_content":"真棒","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604143823,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1105161,"avatar":"https://static001.geekbang.org/account/avatar/00/10/dd/09/feca820a.jpg","nickname":"helloworld","note":"","ucode":"1EECCA0F43E278","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":47313,"discussion_content":"学习了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573311341,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":81289,"user_name":"Vincent","can_delete":false,"product_type":"c3","uid":1437404,"ip_address":"","ucode":"EC72C58FE32369","user_header":"https://static001.geekbang.org/account/avatar/00/15/ee/dc/67838c05.jpg","comment_is_top":false,"comment_ctime":1553849673,"is_pvip":false,"replies":null,"discussion_count":3,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"实验了下Lin同学的问题：解锁还没有锁的mu，运行报错！\nfunc TestCounterThreadSafe(t *testing.T){\n\tvar mu sync.Mutex\n\tcounter :=0\n\tfor i:=0; i&lt;5000;i++{\n\t\tgo func(){\n\t\t\tdefer func(){\n\t\t\t\tmu.Unlock()\n\t\t\t}()\n\t\t\tpanic(&quot;SomeThing Wrong!&quot;)\n\t\t\tmu.Lock()\n\t\t\tcounter++\n\t\t}()\n\t}\n\t&#47;&#47;time.Sleep(time.Microsecond*1)\n\tt.Logf(&quot;Counter=%v&quot;,counter)\n}\n\n运行出错：\n=== RUN   TestCounterThreadSafe\nfatal error: sync: unlock of unlocked mutex","like_count":7,"discussions":[{"author":{"id":1576577,"avatar":"https://static001.geekbang.org/account/avatar/00/18/0e/81/15c29b59.jpg","nickname":"或跃在渊","note":"","ucode":"FE1260C842B1F9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":2935,"discussion_content":"因为你在加锁之前panic了","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1564042795,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1494158,"avatar":"https://static001.geekbang.org/account/avatar/00/16/cc/8e/eb8e4669.jpg","nickname":"Enigma","note":"","ucode":"533A791F3176CA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":4097,"discussion_content":"正确的写法应该是\nmu.Lock()\ndefer mu.Unlock()","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1565109998,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2890901,"avatar":"https://static001.geekbang.org/account/avatar/00/2c/1c/95/3d8920c9.jpg","nickname":"abcdabcd999","note":"","ucode":"E1D9902737F544","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1494158,"avatar":"https://static001.geekbang.org/account/avatar/00/16/cc/8e/eb8e4669.jpg","nickname":"Enigma","note":"","ucode":"533A791F3176CA","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":600430,"discussion_content":"正解","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1674354640,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":4097,"ip_address":"山西","group_id":0},"score":600430,"extra":""}]}]},{"had_liked":false,"id":82152,"user_name":"NIXUS","can_delete":false,"product_type":"c3","uid":1000060,"ip_address":"","ucode":"853763C229A5AA","user_header":"https://static001.geekbang.org/account/avatar/00/0f/42/7c/8ef14715.jpg","comment_is_top":false,"comment_ctime":1554131577,"is_pvip":false,"replies":null,"discussion_count":3,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"老师, defer 后的代码:\ndefer mut.Unlock()  和  defer func() { mut.Unlock() }()\n有什么区别吗?","like_count":5,"discussions":[{"author":{"id":2890901,"avatar":"https://static001.geekbang.org/account/avatar/00/2c/1c/95/3d8920c9.jpg","nickname":"abcdabcd999","note":"","ucode":"E1D9902737F544","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":600431,"discussion_content":"我见过的都这么写 defer mut.Unlock() 而且很少用 mutex 大家都用 rwlock","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1674354668,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"山西","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2853200,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/89/50/aee9fdab.jpg","nickname":"小杰","note":"","ucode":"BBDF8E9F348F65","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":544819,"discussion_content":"你可以尝试运行一下，我运行是没有区别的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641723329,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1433247,"avatar":"https://static001.geekbang.org/account/avatar/00/15/de/9f/b6c59a75.jpg","nickname":"dust！","note":"","ucode":"7ADCCC7985B381","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":178726,"discussion_content":"没有区别","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582192805,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":282030,"user_name":"申","can_delete":false,"product_type":"c3","uid":2033634,"ip_address":"","ucode":"CE7BFCF552B4F1","user_header":"https://static001.geekbang.org/account/avatar/00/1f/07/e2/32c9a634.jpg","comment_is_top":false,"comment_ctime":1615022245,"is_pvip":false,"replies":null,"discussion_count":4,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"```\nfor i := 0; i &lt; 5000; i++ {\n\tcounter++\n}\n```\n这样也能得到5000，这里用协程的目的是什么，为什么要用go func() {counter++}}()\n","like_count":3,"discussions":[{"author":{"id":2890901,"avatar":"https://static001.geekbang.org/account/avatar/00/2c/1c/95/3d8920c9.jpg","nickname":"abcdabcd999","note":"","ucode":"E1D9902737F544","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":600427,"discussion_content":"你这是单线程，跟 goroutine 有什么关系 这节课在 demo goroutine 诶 😊","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1674353670,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"山西","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2101081,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI5a9ianL7JOjmEKTEw075rKDeBD0YqD5cBlgY6nbdPiaskIVqa1HHYm7pibeVnoPqibEWr6a3rqc0xdA/132","nickname":"何时不漂泊","note":"","ucode":"4C47064E5B6C14","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":581500,"discussion_content":"我理解应该就是用这个当个例子吧，如果真的是数增加应该没必要开协程","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1658818214,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2403351,"avatar":"https://static001.geekbang.org/account/avatar/00/24/ac/17/430ddd05.jpg","nickname":"🐟","note":"","ucode":"F61C3F67E4A2E6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":542488,"discussion_content":"你这相当于是一个线程给一个内存加了5000次 当然没问题了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640766409,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1046041,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f6/19/8c4f63f2.jpg","nickname":"梁鑫辉","note":"","ucode":"3A57C936D6F4C4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":369726,"discussion_content":"多试几次，或者把5000改的更大一点试试？\n我第一次也是这样，后来写完第二个测试用例，再去执行第一个时候，发现不到5000了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619142670,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":211022,"user_name":"光","can_delete":false,"product_type":"c3","uid":1447871,"ip_address":"","ucode":"A52F6E3F18EA4B","user_header":"https://static001.geekbang.org/account/avatar/00/16/17/bf/f35bdd6e.jpg","comment_is_top":false,"comment_ctime":1587882510,"is_pvip":false,"replies":null,"discussion_count":3,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"var mu sync.Mutex\n这个mu不需要初始化就可以直接用吗？","like_count":3,"discussions":[{"author":{"id":2890901,"avatar":"https://static001.geekbang.org/account/avatar/00/2c/1c/95/3d8920c9.jpg","nickname":"abcdabcd999","note":"","ucode":"E1D9902737F544","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":600426,"discussion_content":"为初始化就是 0 初始化也没问题 var rwlock *sync.RWMutex = new(sync.RWMutex) 或者 var rwlock sync.RWMutex = sync.RWMutex{} 按照你想的初始化 随便","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1674353632,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"山西","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2403351,"avatar":"https://static001.geekbang.org/account/avatar/00/24/ac/17/430ddd05.jpg","nickname":"🐟","note":"","ucode":"F61C3F67E4A2E6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":542490,"discussion_content":"https://blog.csdn.net/qq_42956653/article/details/121346340。关于Mutex的数据结构 那块儿 解答了你这个问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640766772,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1445907,"avatar":"https://static001.geekbang.org/account/avatar/00/16/10/13/a5194058.jpg","nickname":"陈磊","note":"","ucode":"F69485EA1DCC7A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":535869,"discussion_content":"这里我也没搞懂，之前没提过这种写法。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638585687,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":221572,"user_name":"東","can_delete":false,"product_type":"c3","uid":1657218,"ip_address":"","ucode":"B59125E442234D","user_header":"https://static001.geekbang.org/account/avatar/00/19/49/82/e34f9ce9.jpg","comment_is_top":false,"comment_ctime":1590543205,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":4,"product_id":100024001,"comment_content":"如果不用time.Sleep()，也会导致计数不足","like_count":2,"discussions":[{"author":{"id":2890901,"avatar":"https://static001.geekbang.org/account/avatar/00/2c/1c/95/3d8920c9.jpg","nickname":"abcdabcd999","note":"","ucode":"E1D9902737F544","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":600428,"discussion_content":"那不是 time.Sleep 导致的 根源没找对 兄弟","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1674353716,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"山西","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":348231,"user_name":"青梅煮马","can_delete":false,"product_type":"c3","uid":1033108,"ip_address":"","ucode":"3CD7A2BA87E7D5","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c3/94/3b039dd8.jpg","comment_is_top":false,"comment_ctime":1654853199,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100024001,"comment_content":"稍微包装了下\n\ntype NewCounter struct {\n\tsync.WaitGroup\n\tsync.Mutex\n\tValue uint32\n}\n\nfunc TestCalCounter(t *testing.T) {\n\tvar count NewCounter\n\n\tfor index := 0; index &lt; 10000; index++ {\n\t\tcount.Add(1)\n\t\tgo func() {\n\t\t\tdefer count.Unlock()\n\t\t\tcount.Lock()\n\t\t\tcount.Value++\n\t\t\tcount.Done()\n\t\t}()\n\t}\n\tcount.Wait()\n\tt.Logf(&quot;cal value result is : %d&quot;, count.Value)\n}","like_count":0},{"had_liked":false,"id":324416,"user_name":"Geek__38012c6589d3","can_delete":false,"product_type":"c3","uid":1454933,"ip_address":"","ucode":"85A08CF5E70C73","user_header":"","comment_is_top":false,"comment_ctime":1638424737,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100024001,"comment_content":"这节讲的真好","like_count":0},{"had_liked":false,"id":319368,"user_name":"嘚啵嘚朱","can_delete":false,"product_type":"c3","uid":1233039,"ip_address":"","ucode":"3CC39C5E22DC61","user_header":"https://static001.geekbang.org/account/avatar/00/12/d0/8f/eda69272.jpg","comment_is_top":false,"comment_ctime":1635761338,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100024001,"comment_content":"wg.add 我觉得应该放到遍历的外面,有可能加了 4000 个 wait 了 4000 个,然后正常结束","like_count":0},{"had_liked":false,"id":312874,"user_name":"白菜馅大包子","can_delete":false,"product_type":"c3","uid":2284455,"ip_address":"","ucode":"68400A5EDC4756","user_header":"https://static001.geekbang.org/account/avatar/00/22/db/a7/52f13f0a.jpg","comment_is_top":false,"comment_ctime":1632074924,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100024001,"comment_content":"怎么一直说java？你讲go说java干什么？来学go的好吗？别那么多废话","like_count":0},{"had_liked":false,"id":305746,"user_name":"噼里啪啦啪啦噼里噼里啪啦","can_delete":false,"product_type":"c3","uid":1109143,"ip_address":"","ucode":"2A4B86D38F7E11","user_header":"https://static001.geekbang.org/account/avatar/00/10/ec/97/58e7bc9a.jpg","comment_is_top":false,"comment_ctime":1628149136,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":4,"product_id":100024001,"comment_content":"老师我测试了一下，waitGroup也可以当互斥锁用\nfunc TestCounterWaitGroup(t *testing.T) {\n\tvar wg sync.WaitGroup\n\tcounter := 0\n\tfor i := 0; i &lt; 5000; i++ {\n\t\twg.Add(1) &#47;&#47; 每启动一个协程增加一个等待\n\t\tgo func() {\n\t\t\tcounter++\n\t\t\twg.Done()\n\t\t}()\n\t\twg.Wait()\n\t}\n\tt.Logf(&quot;counter = %d&quot;, counter)\n}","like_count":0,"discussions":[{"author":{"id":2403351,"avatar":"https://static001.geekbang.org/account/avatar/00/24/ac/17/430ddd05.jpg","nickname":"🐟","note":"","ucode":"F61C3F67E4A2E6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":542498,"discussion_content":"哇 确实可以，这个和 互斥锁 有啥区别呢？ 这么用会不会有啥问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640768496,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":289681,"user_name":"梁鑫辉","can_delete":false,"product_type":"c3","uid":1046041,"ip_address":"","ucode":"3A57C936D6F4C4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f6/19/8c4f63f2.jpg","comment_is_top":false,"comment_ctime":1619142226,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":4,"product_id":100024001,"comment_content":"下面这段代码，没有加锁。在我的环境下，直接输出的就是5000.\n默认都线程安全了？\n\n环境如下：\nGo：go version go1.16.3 linux&#47;amd64\nOS：CentOS Linux release 7.8.2003 (Core)\n\n\n```\npackage share_mem\n\nimport (\n\t&quot;testing&quot;\n\t&quot;time&quot;\n)\n\nfunc TestSharemem(t *testing.T) {\n\tcounter := 0\n\tfor i := 0; i &lt; 5000; i++ {\n\t\tgo func() {\n\t\t\tcounter++\n\t\t}()\n\t}\n\ttime.Sleep(time.Second * 1)\n\tt.Logf(&quot;counter = %d&quot;, counter)\n}\n\n```","like_count":0,"discussions":[{"author":{"id":1435172,"avatar":"https://static001.geekbang.org/account/avatar/00/15/e6/24/30806a88.jpg","nickname":"right-chen","note":"","ucode":"E0E940E80E7A2D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":582807,"discussion_content":"再多测试几遍，我试了你的代码，执行后输出：counter = 4870","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659683562,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":287299,"user_name":"escray","can_delete":false,"product_type":"c3","uid":1020525,"ip_address":"","ucode":"1F4204930E47C4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/92/6d/becd841a.jpg","comment_is_top":false,"comment_ctime":1617871911,"is_pvip":true,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100024001,"comment_content":"视频中的代码和课件上的不太一样\n\n```\n&#47;&#47; 视频\nfor i := 0; i &lt; 5000; i++ {\n    wg.Add(1)\n    go func() {\n        defer func ()  {\n            mut.Unlock()\n        }()\n        mut.Lock()\n        counter++\n        wg.Done()\n    }()\n}\nwg.Wait()\n\n&#47;&#47; 课件\nfor i := 0; i &lt; 5000; i++ {\n    wg.Add(1)\n    go func() {\n        defer func ()  {\n            mut.Unlock()\n            wg.Done()\n        }()\n        mut.Lock()\n        counter++        \n    }()\n}\nwg.Wait()\n```\n\n主要的差别实在 wg.Done() 的位置，简单测试了一下，两种方法的输出结果都是对的。\n\n按照老师在留言中的回复，wg.Done() 和 wg.Add(1) 应该是对应的，那么视频中的写法应该更符合本意。\n\n老师在视频最后的补充说明：\n\nWaitGroup 相当于 Java 中的 Join\n\nMutex 和 RW lock 都是共享内存机制，尽量使用 RW lock \n\n- 两个读锁不是互斥锁，共享内存\n- 两个写锁是互斥锁","like_count":0},{"had_liked":false,"id":251656,"user_name":"刘稹","can_delete":false,"product_type":"c3","uid":1061398,"ip_address":"","ucode":"04E72146C6E68D","user_header":"https://static001.geekbang.org/account/avatar/00/10/32/16/ea9c3cb2.jpg","comment_is_top":false,"comment_ctime":1601775916,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100024001,"comment_content":"wg.Done() 应该也放在defer 里比较好","like_count":0},{"had_liked":false,"id":245552,"user_name":"程龙","can_delete":false,"product_type":"c3","uid":1131918,"ip_address":"","ucode":"645516BFF8A96F","user_header":"https://static001.geekbang.org/account/avatar/00/11/45/8e/83bac3bb.jpg","comment_is_top":false,"comment_ctime":1598974937,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100024001,"comment_content":"其实第三个用wait group 可以不用加锁, 让其他的协程 去进行等待 上一个协程结束就好\n```\nfunc TestCounterSafe3(t *testing.T) {\n\tvar counter int\n\tvar wg sync.WaitGroup\n\tfor i := 1; i &lt;= 5000; i++ {\n\t\t&#47;&#47;1. 首先 开启一个等待组 给等待组 +1\n\t\twg.Add(1)\n\t\tgo func() {\n\t\t\tcounter++\n\t\t\t&#47;&#47; 标志位进行 -1\n\t\t\twg.Done()\n\t\t}()\n\t\twg.Wait()\n\t}\n\t&#47;&#47;output: 5000\n\tt.Log(counter)\n}\n```","like_count":0},{"had_liked":false,"id":211025,"user_name":"光","can_delete":false,"product_type":"c3","uid":1447871,"ip_address":"","ucode":"A52F6E3F18EA4B","user_header":"https://static001.geekbang.org/account/avatar/00/16/17/bf/f35bdd6e.jpg","comment_is_top":false,"comment_ctime":1587883019,"is_pvip":false,"replies":null,"discussion_count":2,"race_medal":0,"score":5,"product_id":100024001,"comment_content":"wg.Done() 是否写在defer func里面更好呢？","like_count":0,"discussions":[{"author":{"id":1020525,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/92/6d/becd841a.jpg","nickname":"escray","note":"","ucode":"1F4204930E47C4","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":365718,"discussion_content":"wg.Done() 放在 defer func 里面也能输出中确的结果。\n\n按照老师在留言中的回复，wg.Done() 和 wg.Add(1) 应该是一一对应的，那么视频中的写法应该更符合本意。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617870982,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1248307,"avatar":"https://static001.geekbang.org/account/avatar/00/13/0c/33/c5026169.jpg","nickname":"hiyang","note":"","ucode":"E521EE72C0F247","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":268755,"discussion_content":"有同样的疑问","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589815899,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":90425,"user_name":"郑文祥","can_delete":false,"product_type":"c3","uid":1233073,"ip_address":"","ucode":"730452A9B3376A","user_header":"https://static001.geekbang.org/account/avatar/00/12/d0/b1/87853049.jpg","comment_is_top":false,"comment_ctime":1556516790,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":5,"product_id":100024001,"comment_content":"func TestCounterThreadSafe(t *testing.T){\n    var mu sync.Mutex\n    counter :=0\n    for i:=0; i&lt;5000;i++{\n        go func(){\n            mu.Lock()\n            defer func(){\n                mu.Unlock()\n            }()\n            counter++\n        }()\n    }\n    &#47;&#47;time.Sleep(time.Microsecond*1)\n    t.Logf(&quot;Counter=%v&quot;,counter)\n}\n所以程序最好是这么写规范些，defer放在lock后","like_count":0,"discussions":[{"author":{"id":1953243,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epsRcQM1w3rNhv9iaYxz7tDGtFQ6tKCbrjnic2uEAZFyd3TK8Sb24DUic2f845VtP0GnVnfRspwiaH5ug/132","nickname":"Geek_8607a4","note":"","ucode":"493EA87394BDD4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":225232,"discussion_content":"并没有任何区别","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586352836,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":78416,"user_name":"面朝大海春暖花开","can_delete":false,"product_type":"c3","uid":1118924,"ip_address":"","ucode":"F9F9F53D05304B","user_header":"https://static001.geekbang.org/account/avatar/00/11/12/cc/6a08cf26.jpg","comment_is_top":false,"comment_ctime":1553143115,"is_pvip":false,"replies":null,"discussion_count":3,"race_medal":0,"score":5,"product_id":100024001,"comment_content":"老师，如果将wg.Done()按您的写法，第5000个执行mut.Unlock()的携程，有可能在主线程退出时还没有执行完。这里defer逻辑比较简单，如果是耗时的是不是可以挪过来。请老师百忙之中批评指正。\n\tgo func() {\n\t\t\tdefer func() {\n\t\t\t\tmut.Unlock()\n                               wg.Done() &#47;&#47; 移到这里\n\t\t\t}()\n\t\t\tmut.Lock()\n\t\t\tcounter++\n\t\t\twg.Done()\n\t\t}()","like_count":0,"discussions":[{"author":{"id":2890901,"avatar":"https://static001.geekbang.org/account/avatar/00/2c/1c/95/3d8920c9.jpg","nickname":"abcdabcd999","note":"","ucode":"E1D9902737F544","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":600433,"discussion_content":"这没啥优雅不优雅的，你主线程都退出了，这些 goroutine 资源都被清理了，你写哪里不都一样没什么用","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1674355897,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"山西","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1433247,"avatar":"https://static001.geekbang.org/account/avatar/00/15/de/9f/b6c59a75.jpg","nickname":"dust！","note":"","ucode":"7ADCCC7985B381","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":178774,"discussion_content":"这样写更好，老师写的也没问题。\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582195982,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1071739,"avatar":"https://static001.geekbang.org/account/avatar/00/10/5a/7b/8d1a1e1d.jpg","nickname":"大脸猫","note":"","ucode":"A4AECC1C80C8F6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":2922,"discussion_content":"我就是这样实现的，暂时没发现问题，我觉得这么做更优雅。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564039721,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}