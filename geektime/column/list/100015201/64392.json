{"id":64392,"title":"31 | å®¹å™¨å­˜å‚¨å®è·µï¼šCSIæ’ä»¶ç¼–å†™æŒ‡å—","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å¼ ç£Šã€‚ä»Šå¤©æˆ‘å’Œä½ åˆ†äº«çš„ä¸»é¢˜æ˜¯ï¼šå®¹å™¨å­˜å‚¨å®è·µä¹‹CSIæ’ä»¶ç¼–å†™æŒ‡å—ã€‚</p><p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å·²ç»ä¸ºä½ è¯¦ç»†è®²è§£äº†CSIæ’ä»¶æœºåˆ¶çš„è®¾è®¡åŸç†ã€‚ä»Šå¤©æˆ‘å°†ç»§ç»­å’Œä½ ä¸€èµ·å®è·µä¸€ä¸ªCSIæ’ä»¶çš„ç¼–å†™è¿‡ç¨‹ã€‚</p><p>ä¸ºäº†èƒ½å¤Ÿè¦†ç›–åˆ°CSIæ’ä»¶çš„æ‰€æœ‰åŠŸèƒ½ï¼Œæˆ‘è¿™ä¸€æ¬¡é€‰æ‹©äº†DigitalOceançš„å—å­˜å‚¨ï¼ˆBlock Storageï¼‰æœåŠ¡ï¼Œæ¥ä½œä¸ºå®è·µå¯¹è±¡ã€‚</p><p>DigitalOceanæ˜¯ä¸šç•ŒçŸ¥åçš„â€œæœ€ç®€â€å…¬æœ‰äº‘æœåŠ¡ï¼Œå³ï¼šå®ƒåªæä¾›è™šæ‹Ÿæœºã€å­˜å‚¨ã€ç½‘ç»œç­‰ä¸ºæ•°ä¸å¤šçš„å‡ ä¸ªåŸºç¡€åŠŸèƒ½ï¼Œå…¶ä»–åŠŸèƒ½ä¸€æ¦‚ä¸ç®¡ã€‚è€Œè¿™ï¼Œæ°æ°å°±ä½¿å¾—DigitalOceanæˆäº†æˆ‘ä»¬åœ¨å…¬æœ‰äº‘ä¸Šå®è·µKubernetesçš„æœ€ä½³é€‰æ‹©ã€‚</p><p><span class=\"orange\">æˆ‘ä»¬è¿™æ¬¡ç¼–å†™çš„CSIæ’ä»¶çš„åŠŸèƒ½ï¼Œå°±æ˜¯ï¼šè®©æˆ‘ä»¬è¿è¡Œåœ¨DigitalOceanä¸Šçš„Kubernetesé›†ç¾¤èƒ½å¤Ÿä½¿ç”¨å®ƒçš„å—å­˜å‚¨æœåŠ¡ï¼Œä½œä¸ºå®¹å™¨çš„æŒä¹…åŒ–å­˜å‚¨ã€‚</span></p><blockquote>\n<p>å¤‡æ³¨ï¼šåœ¨DigitalOceanä¸Šéƒ¨ç½²ä¸€ä¸ªKubernetesé›†ç¾¤çš„è¿‡ç¨‹ï¼Œä¹Ÿå¾ˆç®€å•ã€‚ä½ åªéœ€è¦å…ˆåœ¨DigitalOceanä¸Šåˆ›å»ºå‡ ä¸ªè™šæ‹Ÿæœºï¼Œç„¶åæŒ‰ç…§æˆ‘ä»¬åœ¨ç¬¬11ç¯‡æ–‡ç« <a href=\"https://time.geekbang.org/column/article/39724\">ã€Šä»0åˆ°1ï¼šæ­å»ºä¸€ä¸ªå®Œæ•´çš„Kubernetesé›†ç¾¤ã€‹</a>ä¸­ä»0åˆ°1çš„æ­¥éª¤ç›´æ¥éƒ¨ç½²å³å¯ã€‚</p>\n</blockquote><p>è€Œæœ‰äº†CSIæ’ä»¶ä¹‹åï¼ŒæŒä¹…åŒ–å­˜å‚¨çš„ç”¨æ³•å°±éå¸¸ç®€å•äº†ï¼Œä½ åªéœ€è¦åˆ›å»ºä¸€ä¸ªå¦‚ä¸‹æ‰€ç¤ºçš„StorageClasså¯¹è±¡å³å¯ï¼š</p><!-- [[[read_end]]] --><pre><code>kind: StorageClass\napiVersion: storage.k8s.io/v1\nmetadata:\n  name: do-block-storage\n  namespace: kube-system\n  annotations:\n    storageclass.kubernetes.io/is-default-class: &quot;true&quot;\nprovisioner: com.digitalocean.csi.dobs\n</code></pre><p>æœ‰äº†è¿™ä¸ªStorageClassï¼ŒExternal Provisonerå°±ä¼šä¸ºé›†ç¾¤ä¸­æ–°å‡ºç°çš„PVCè‡ªåŠ¨åˆ›å»ºå‡ºPVï¼Œç„¶åè°ƒç”¨CSIæ’ä»¶åˆ›å»ºå‡ºè¿™ä¸ªPVå¯¹åº”çš„Volumeï¼Œè¿™æ­£æ˜¯CSIä½“ç³»ä¸­Dynamic Provisioningçš„å®ç°æ–¹å¼ã€‚</p><blockquote>\n<p>å¤‡æ³¨ï¼š<code>storageclass.kubernetes.io/is-default-class: \"true\"</code>çš„æ„æ€ï¼Œæ˜¯ä½¿ç”¨è¿™ä¸ªStorageClassä½œä¸ºé»˜è®¤çš„æŒä¹…åŒ–å­˜å‚¨æä¾›è€…ã€‚</p>\n</blockquote><p>ä¸éš¾çœ‹åˆ°ï¼Œè¿™ä¸ªStorageClassé‡Œå”¯ä¸€å¼•äººæ³¨æ„çš„ï¼Œæ˜¯provisioner=com.digitalocean.csi.dobsè¿™ä¸ªå­—æ®µã€‚æ˜¾ç„¶ï¼Œè¿™ä¸ªå­—æ®µå‘Šè¯‰äº†Kubernetesï¼Œè¯·ä½¿ç”¨åå«com.digitalocean.csi.dobsçš„CSIæ’ä»¶æ¥ä¸ºæˆ‘å¤„ç†è¿™ä¸ªStorageClassç›¸å…³çš„æ‰€æœ‰æ“ä½œã€‚</p><p>é‚£ä¹ˆï¼Œ<span class=\"orange\">Kubernetesåˆæ˜¯å¦‚ä½•çŸ¥é“ä¸€ä¸ªCSIæ’ä»¶çš„åå­—çš„å‘¢ï¼Ÿ</span></p><p><strong>è¿™å°±éœ€è¦ä»CSIæ’ä»¶çš„ç¬¬ä¸€ä¸ªæœåŠ¡CSI Identityè¯´èµ·äº†ã€‚</strong></p><p>å…¶å®ï¼Œä¸€ä¸ªCSIæ’ä»¶çš„ä»£ç ç»“æ„éå¸¸ç®€å•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>tree $GOPATH/src/github.com/digitalocean/csi-digitalocean/driver  \n$GOPATH/src/github.com/digitalocean/csi-digitalocean/driver \nâ”œâ”€â”€ controller.go\nâ”œâ”€â”€ driver.go\nâ”œâ”€â”€ identity.go\nâ”œâ”€â”€ mounter.go\nâ””â”€â”€ node.go\n</code></pre><p>å…¶ä¸­ï¼ŒCSI IdentityæœåŠ¡çš„å®ç°ï¼Œå°±å®šä¹‰åœ¨äº†driverç›®å½•ä¸‹çš„identity.goæ–‡ä»¶é‡Œã€‚</p><p>å½“ç„¶ï¼Œä¸ºäº†èƒ½å¤Ÿè®©Kubernetesè®¿é—®åˆ°CSI IdentityæœåŠ¡ï¼Œæˆ‘ä»¬éœ€è¦å…ˆåœ¨driver.goæ–‡ä»¶é‡Œï¼Œå®šä¹‰ä¸€ä¸ªæ ‡å‡†çš„gRPC Serverï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>// Run starts the CSI plugin by communication over the given endpoint\nfunc (d *Driver) Run() error {\n ...\n \n listener, err := net.Listen(u.Scheme, addr)\n ...\n \n d.srv = grpc.NewServer(grpc.UnaryInterceptor(errHandler))\n csi.RegisterIdentityServer(d.srv, d)\n csi.RegisterControllerServer(d.srv, d)\n csi.RegisterNodeServer(d.srv, d)\n \n d.ready = true // we're now ready to go!\n ...\n return d.srv.Serve(listener)\n}\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œåªè¦æŠŠç¼–å†™å¥½çš„gRPC Serveræ³¨å†Œç»™CSIï¼Œå®ƒå°±å¯ä»¥å“åº”æ¥è‡ªExternal Componentsçš„CSIè¯·æ±‚äº†ã€‚</p><p><strong>CSI IdentityæœåŠ¡ä¸­ï¼Œæœ€é‡è¦çš„æ¥å£æ˜¯GetPluginInfo</strong>ï¼Œå®ƒè¿”å›çš„å°±æ˜¯è¿™ä¸ªæ’ä»¶çš„åå­—å’Œç‰ˆæœ¬å·ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><blockquote>\n<p>å¤‡æ³¨ï¼šCSIå„ä¸ªæœåŠ¡çš„æ¥å£æˆ‘åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­å·²ç»ä»‹ç»è¿‡ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°<a href=\"https://github.com/container-storage-interface/spec/blob/master/csi.proto\">å®ƒçš„protocæ–‡ä»¶</a>ã€‚</p>\n</blockquote><pre><code>func (d *Driver) GetPluginInfo(ctx context.Context, req *csi.GetPluginInfoRequest) (*csi.GetPluginInfoResponse, error) {\n resp := &amp;csi.GetPluginInfoResponse{\n  Name:          driverName,\n  VendorVersion: version,\n }\n ...\n}\n</code></pre><p>å…¶ä¸­ï¼ŒdriverNameçš„å€¼ï¼Œæ­£æ˜¯\"com.digitalocean.csi.dobs\"ã€‚æ‰€ä»¥è¯´ï¼ŒKubernetesæ­£æ˜¯é€šè¿‡GetPluginInfoçš„è¿”å›å€¼ï¼Œæ¥æ‰¾åˆ°ä½ åœ¨StorageClassé‡Œå£°æ˜è¦ä½¿ç”¨çš„CSIæ’ä»¶çš„ã€‚</p><blockquote>\n<p>å¤‡æ³¨ï¼šCSIè¦æ±‚æ’ä»¶çš„åå­—éµå®ˆ<a href=\"https://en.wikipedia.org/wiki/Reverse_domain_name_notation\">â€œåå‘DNSâ€æ ¼å¼</a>ã€‚</p>\n</blockquote><p>å¦å¤–ä¸€ä¸ª<strong>GetPluginCapabilitiesæ¥å£ä¹Ÿå¾ˆé‡è¦</strong>ã€‚è¿™ä¸ªæ¥å£è¿”å›çš„æ˜¯è¿™ä¸ªCSIæ’ä»¶çš„â€œèƒ½åŠ›â€ã€‚</p><p>æ¯”å¦‚ï¼Œå½“ä½ ç¼–å†™çš„CSIæ’ä»¶ä¸å‡†å¤‡å®ç°â€œProvisioné˜¶æ®µâ€å’Œâ€œAttaché˜¶æ®µâ€ï¼ˆæ¯”å¦‚ï¼Œä¸€ä¸ªæœ€ç®€å•çš„NFSå­˜å‚¨æ’ä»¶å°±ä¸éœ€è¦è¿™ä¸¤ä¸ªé˜¶æ®µï¼‰æ—¶ï¼Œä½ å°±å¯ä»¥é€šè¿‡è¿™ä¸ªæ¥å£è¿”å›ï¼šæœ¬æ’ä»¶ä¸æä¾›CSI ControlleræœåŠ¡ï¼Œå³ï¼šæ²¡æœ‰csi.PluginCapability_Service_CONTROLLER_SERVICEè¿™ä¸ªâ€œèƒ½åŠ›â€ã€‚è¿™æ ·ï¼ŒKuberneteså°±çŸ¥é“è¿™ä¸ªä¿¡æ¯äº†ã€‚</p><p>æœ€åï¼Œ<strong>CSI IdentityæœåŠ¡è¿˜æä¾›äº†ä¸€ä¸ªProbeæ¥å£</strong>ã€‚Kubernetesä¼šè°ƒç”¨å®ƒæ¥æ£€æŸ¥è¿™ä¸ªCSIæ’ä»¶æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚</p><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘å»ºè®®ä½ åœ¨ç¼–å†™æ’ä»¶æ—¶ç»™å®ƒè®¾ç½®ä¸€ä¸ªReadyæ ‡å¿—ï¼Œå½“æ’ä»¶çš„gRPC Serveråœæ­¢çš„æ—¶å€™ï¼ŒæŠŠè¿™ä¸ªReadyæ ‡å¿—è®¾ç½®ä¸ºfalseã€‚æˆ–è€…ï¼Œä½ å¯ä»¥åœ¨è¿™é‡Œè®¿é—®ä¸€ä¸‹æ’ä»¶çš„ç«¯å£ï¼Œç±»ä¼¼äºå¥åº·æ£€æŸ¥çš„åšæ³•ã€‚</p><blockquote>\n<p>å¤‡æ³¨ï¼šå…³äºå¥åº·æ£€æŸ¥çš„é—®é¢˜ï¼Œä½ å¯ä»¥å†å›é¡¾ä¸€ä¸‹ç¬¬15ç¯‡æ–‡ç« <a href=\"https://time.geekbang.org/column/article/40466\">ã€Šæ·±å…¥è§£æPodå¯¹è±¡ï¼ˆäºŒï¼‰ï¼šä½¿ç”¨è¿›é˜¶ã€‹</a>ä¸­çš„ç›¸å…³å†…å®¹ã€‚</p>\n</blockquote><p>ç„¶åï¼Œ<span class=\"orange\">æˆ‘ä»¬è¦å¼€å§‹ç¼–å†™CSI æ’ä»¶çš„ç¬¬äºŒä¸ªæœåŠ¡ï¼Œå³CSI ControlleræœåŠ¡äº†ã€‚</span>å®ƒçš„ä»£ç å®ç°ï¼Œåœ¨controller.goæ–‡ä»¶é‡Œã€‚</p><p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æˆ‘å·²ç»ä¸ºä½ è®²è§£è¿‡ï¼Œè¿™ä¸ªæœåŠ¡ä¸»è¦å®ç°çš„å°±æ˜¯Volumeç®¡ç†æµç¨‹ä¸­çš„â€œProvisioné˜¶æ®µâ€å’Œâ€œAttaché˜¶æ®µâ€ã€‚</p><p><strong>â€œProvisioné˜¶æ®µâ€å¯¹åº”çš„æ¥å£ï¼Œæ˜¯CreateVolumeå’ŒDeleteVolume</strong>ï¼Œå®ƒä»¬çš„è°ƒç”¨è€…æ˜¯External Provisonerã€‚ä»¥CreateVolumeä¸ºä¾‹ï¼Œå®ƒçš„ä¸»è¦é€»è¾‘å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>func (d *Driver) CreateVolume(ctx context.Context, req *csi.CreateVolumeRequest) (*csi.CreateVolumeResponse, error) {\n ...\n \n volumeReq := &amp;godo.VolumeCreateRequest{\n  Region:        d.region,\n  Name:          volumeName,\n  Description:   createdByDO,\n  SizeGigaBytes: size / GB,\n }\n \n ...\n \n vol, _, err := d.doClient.Storage.CreateVolume(ctx, volumeReq)\n \n ...\n \n resp := &amp;csi.CreateVolumeResponse{\n  Volume: &amp;csi.Volume{\n   Id:            vol.ID,\n   CapacityBytes: size,\n   AccessibleTopology: []*csi.Topology{\n    {\n     Segments: map[string]string{\n      &quot;region&quot;: d.region,\n     },\n    },\n   },\n  },\n }\n \n return resp, nil\n}\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äºDigitalOceanè¿™æ ·çš„å…¬æœ‰äº‘æ¥è¯´ï¼ŒCreateVolumeéœ€è¦åšçš„æ“ä½œï¼Œå°±æ˜¯è°ƒç”¨DigitalOceanå—å­˜å‚¨æœåŠ¡çš„APIï¼Œåˆ›å»ºå‡ºä¸€ä¸ªå­˜å‚¨å·ï¼ˆd.doClient.Storage.CreateVolumeï¼‰ã€‚å¦‚æœä½ ä½¿ç”¨çš„æ˜¯å…¶ä»–ç±»å‹çš„å—å­˜å‚¨ï¼ˆæ¯”å¦‚Cinderã€Ceph RBDç­‰ï¼‰ï¼Œå¯¹åº”çš„æ“ä½œä¹Ÿæ˜¯ç±»ä¼¼åœ°è°ƒç”¨åˆ›å»ºå­˜å‚¨å·çš„APIã€‚</p><p>è€Œâ€œ<strong>Attaché˜¶æ®µâ€å¯¹åº”çš„æ¥å£æ˜¯ControllerPublishVolumeå’ŒControllerUnpublishVolume</strong>ï¼Œå®ƒä»¬çš„è°ƒç”¨è€…æ˜¯External Attacherã€‚ä»¥ControllerPublishVolumeä¸ºä¾‹ï¼Œå®ƒçš„é€»è¾‘å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>func (d *Driver) ControllerPublishVolume(ctx context.Context, req *csi.ControllerPublishVolumeRequest) (*csi.ControllerPublishVolumeResponse, error) {\n ...\n \n  dropletID, err := strconv.Atoi(req.NodeId)\n  \n  // check if volume exist before trying to attach it\n  _, resp, err := d.doClient.Storage.GetVolume(ctx, req.VolumeId)\n \n ...\n \n  // check if droplet exist before trying to attach the volume to the droplet\n  _, resp, err = d.doClient.Droplets.Get(ctx, dropletID)\n \n ...\n \n  action, resp, err := d.doClient.StorageActions.Attach(ctx, req.VolumeId, dropletID)\n\n ...\n \n if action != nil {\n  ll.Info(&quot;waiting until volume is attached&quot;)\n if err := d.waitAction(ctx, req.VolumeId, action.ID); err != nil {\n  return nil, err\n  }\n  }\n  \n  ll.Info(&quot;volume is attached&quot;)\n return &amp;csi.ControllerPublishVolumeResponse{}, nil\n}\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äºDigitalOceanæ¥è¯´ï¼ŒControllerPublishVolumeåœ¨â€œAttaché˜¶æ®µâ€éœ€è¦åšçš„å·¥ä½œï¼Œæ˜¯è°ƒç”¨DigitalOceançš„APIï¼Œå°†æˆ‘ä»¬å‰é¢åˆ›å»ºçš„å­˜å‚¨å·ï¼ŒæŒ‚è½½åˆ°æŒ‡å®šçš„è™šæ‹Ÿæœºä¸Šï¼ˆd.doClient.StorageActions.Attachï¼‰ã€‚</p><p>å…¶ä¸­ï¼Œå­˜å‚¨å·ç”±è¯·æ±‚ä¸­çš„VolumeIdæ¥æŒ‡å®šã€‚è€Œè™šæ‹Ÿæœºï¼Œä¹Ÿå°±æ˜¯å°†è¦è¿è¡ŒPodçš„å®¿ä¸»æœºï¼Œåˆ™ç”±è¯·æ±‚ä¸­çš„NodeIdæ¥æŒ‡å®šã€‚è¿™äº›å‚æ•°ï¼Œéƒ½æ˜¯External Attacheråœ¨å‘èµ·è¯·æ±‚æ—¶éœ€è¦è®¾ç½®çš„ã€‚</p><p>æˆ‘åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­å·²ç»ä¸ºä½ ä»‹ç»è¿‡ï¼ŒExternal Attacherçš„å·¥ä½œåŸç†ï¼Œæ˜¯ç›‘å¬ï¼ˆWatchï¼‰äº†ä¸€ç§åå«VolumeAttachmentçš„APIå¯¹è±¡ã€‚è¿™ç§APIå¯¹è±¡çš„ä¸»è¦å­—æ®µå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>// VolumeAttachmentSpec is the specification of a VolumeAttachment request.\ntype VolumeAttachmentSpec struct {\n // Attacher indicates the name of the volume driver that MUST handle this\n // request. This is the name returned by GetPluginName().\n Attacher string\n \n // Source represents the volume that should be attached.\n Source VolumeAttachmentSource\n \n // The node that the volume should be attached to.\n NodeName string\n}\n</code></pre><p>è€Œè¿™ä¸ªå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œæ­£æ˜¯ç”±AttachDetachControllerè´Ÿè´£ç®¡ç†çš„ï¼ˆè¿™é‡Œï¼Œä½ å¯ä»¥å†å›é¡¾ä¸€ä¸‹ç¬¬28ç¯‡æ–‡ç« <a href=\"https://time.geekbang.org/column/article/42698\">ã€ŠPVã€PVCã€StorageClassï¼Œè¿™äº›åˆ°åº•åœ¨è¯´å•¥ï¼Ÿã€‹</a>ä¸­çš„ç›¸å…³å†…å®¹ï¼‰ã€‚</p><p>è¿™ä¸ªæ§åˆ¶å¾ªç¯çš„èŒè´£ï¼Œæ˜¯ä¸æ–­æ£€æŸ¥Podæ‰€å¯¹åº”çš„PVï¼Œåœ¨å®ƒæ‰€ç»‘å®šçš„å®¿ä¸»æœºä¸Šçš„æŒ‚è½½æƒ…å†µï¼Œä»è€Œå†³å®šæ˜¯å¦éœ€è¦å¯¹è¿™ä¸ªPVè¿›è¡ŒAttachï¼ˆæˆ–è€…Dettachï¼‰æ“ä½œã€‚</p><p>è€Œè¿™ä¸ªAttachæ“ä½œï¼Œåœ¨CSIä½“ç³»é‡Œï¼Œå°±æ˜¯åˆ›å»ºå‡ºä¸Šé¢è¿™æ ·ä¸€ä¸ªVolumeAttachmentå¯¹è±¡ã€‚å¯ä»¥çœ‹åˆ°ï¼ŒAttachæ“ä½œæ‰€éœ€çš„PVçš„åå­—ï¼ˆSourceï¼‰ã€å®¿ä¸»æœºçš„åå­—ï¼ˆNodeNameï¼‰ã€å­˜å‚¨æ’ä»¶çš„åå­—ï¼ˆAttacherï¼‰ï¼Œéƒ½æ˜¯è¿™ä¸ªVolumeAttachmentå¯¹è±¡çš„ä¸€éƒ¨åˆ†ã€‚</p><p>è€Œå½“External Attacherç›‘å¬åˆ°è¿™æ ·çš„ä¸€ä¸ªå¯¹è±¡å‡ºç°ä¹‹åï¼Œå°±å¯ä»¥ç«‹å³ä½¿ç”¨VolumeAttachmenté‡Œçš„è¿™äº›å­—æ®µï¼Œå°è£…æˆä¸€ä¸ªgRPCè¯·æ±‚è°ƒç”¨CSI Controllerçš„ControllerPublishVolumeæ–¹æ³•ã€‚</p><p>æœ€åï¼Œ<span class=\"orange\">æˆ‘ä»¬å°±å¯ä»¥ç¼–å†™CSI NodeæœåŠ¡äº†ã€‚</span></p><p>CSI NodeæœåŠ¡å¯¹åº”çš„ï¼Œæ˜¯Volumeç®¡ç†æµç¨‹é‡Œçš„â€œMounté˜¶æ®µâ€ã€‚å®ƒçš„ä»£ç å®ç°ï¼Œåœ¨node.goæ–‡ä»¶é‡Œã€‚</p><p>æˆ‘åœ¨ä¸Šä¸€ç¯‡æ–‡ç« é‡Œæ›¾ç»æåˆ°è¿‡ï¼Œkubeletçš„VolumeManagerReconcileræ§åˆ¶å¾ªç¯ä¼šç›´æ¥è°ƒç”¨CSI NodeæœåŠ¡æ¥å®ŒæˆVolumeçš„â€œMounté˜¶æ®µâ€ã€‚</p><p>ä¸è¿‡ï¼Œåœ¨å…·ä½“çš„å®ç°ä¸­ï¼Œè¿™ä¸ªâ€œMounté˜¶æ®µâ€çš„å¤„ç†å…¶å®è¢«ç»†åˆ†æˆäº†NodeStageVolumeå’ŒNodePublishVolumeè¿™ä¸¤ä¸ªæ¥å£ã€‚</p><p>è¿™é‡Œçš„åŸå› å…¶å®ä¹Ÿå¾ˆå®¹æ˜“ç†è§£ï¼šæˆ‘åœ¨ç¬¬28ç¯‡æ–‡ç« <a href=\"https://time.geekbang.org/column/article/42698\">ã€ŠPVã€PVCã€StorageClassï¼Œè¿™äº›åˆ°åº•åœ¨è¯´å•¥ï¼Ÿã€‹</a>ä¸­æ›¾ç»ä»‹ç»è¿‡ï¼Œå¯¹äºç£ç›˜ä»¥åŠå—è®¾å¤‡æ¥è¯´ï¼Œå®ƒä»¬è¢«Attachåˆ°å®¿ä¸»æœºä¸Šä¹‹åï¼Œå°±æˆä¸ºäº†å®¿ä¸»æœºä¸Šçš„ä¸€ä¸ªå¾…ç”¨å­˜å‚¨è®¾å¤‡ã€‚è€Œåˆ°äº†â€œMounté˜¶æ®µâ€ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦æ ¼å¼åŒ–è¿™ä¸ªè®¾å¤‡ï¼Œç„¶åæ‰èƒ½æŠŠå®ƒæŒ‚è½½åˆ°Volumeå¯¹åº”çš„å®¿ä¸»æœºç›®å½•ä¸Šã€‚</p><p>åœ¨kubeletçš„VolumeManagerReconcileræ§åˆ¶å¾ªç¯ä¸­ï¼Œè¿™ä¸¤æ­¥æ“ä½œåˆ†åˆ«å«ä½œ<strong>MountDeviceå’ŒSetUpã€‚</strong></p><p>å…¶ä¸­ï¼ŒMountDeviceæ“ä½œï¼Œå°±æ˜¯ç›´æ¥è°ƒç”¨äº†CSI NodeæœåŠ¡é‡Œçš„NodeStageVolumeæ¥å£ã€‚é¡¾åæ€ä¹‰ï¼Œè¿™ä¸ªæ¥å£çš„ä½œç”¨ï¼Œå°±æ˜¯æ ¼å¼åŒ–Volumeåœ¨å®¿ä¸»æœºä¸Šå¯¹åº”çš„å­˜å‚¨è®¾å¤‡ï¼Œç„¶åæŒ‚è½½åˆ°ä¸€ä¸ªä¸´æ—¶ç›®å½•ï¼ˆStagingç›®å½•ï¼‰ä¸Šã€‚</p><p>å¯¹äºDigitalOceanæ¥è¯´ï¼Œå®ƒå¯¹NodeStageVolumeæ¥å£çš„å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>func (d *Driver) NodeStageVolume(ctx context.Context, req *csi.NodeStageVolumeRequest) (*csi.NodeStageVolumeResponse, error) {\n ...\n \n vol, resp, err := d.doClient.Storage.GetVolume(ctx, req.VolumeId)\n \n ...\n \n source := getDiskSource(vol.Name)\n target := req.StagingTargetPath\n \n ...\n \n if !formatted {\n  ll.Info(&quot;formatting the volume for staging&quot;)\n  if err := d.mounter.Format(source, fsType); err != nil {\n   return nil, status.Error(codes.Internal, err.Error())\n  }\n } else {\n  ll.Info(&quot;source device is already formatted&quot;)\n }\n \n...\n\n if !mounted {\n  if err := d.mounter.Mount(source, target, fsType, options...); err != nil {\n   return nil, status.Error(codes.Internal, err.Error())\n  }\n } else {\n  ll.Info(&quot;source device is already mounted to the target path&quot;)\n }\n \n ...\n return &amp;csi.NodeStageVolumeResponse{}, nil\n}\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨NodeStageVolumeçš„å®ç°é‡Œï¼Œæˆ‘ä»¬é¦–å…ˆé€šè¿‡DigitalOceançš„APIè·å–åˆ°äº†è¿™ä¸ªVolumeå¯¹åº”çš„è®¾å¤‡è·¯å¾„ï¼ˆgetDiskSourceï¼‰ï¼›ç„¶åï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªè®¾å¤‡æ ¼å¼åŒ–æˆæŒ‡å®šçš„æ ¼å¼ï¼ˆ d.mounter.Formatï¼‰ï¼›æœ€åï¼Œæˆ‘ä»¬æŠŠæ ¼å¼åŒ–åçš„è®¾å¤‡æŒ‚è½½åˆ°äº†ä¸€ä¸ªä¸´æ—¶çš„Stagingç›®å½•ï¼ˆStagingTargetPathï¼‰ä¸‹ã€‚</p><p>è€ŒSetUpæ“ä½œåˆ™ä¼šè°ƒç”¨CSI NodeæœåŠ¡çš„NodePublishVolumeæ¥å£ã€‚æœ‰äº†ä¸Šè¿°å¯¹è®¾å¤‡çš„é¢„å¤„ç†å·¥ä½œåï¼Œå®ƒçš„å®ç°å°±éå¸¸ç®€å•äº†ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>func (d *Driver) NodePublishVolume(ctx context.Context, req *csi.NodePublishVolumeRequest) (*csi.NodePublishVolumeResponse, error) {\n ...\n source := req.StagingTargetPath\n target := req.TargetPath\n \n mnt := req.VolumeCapability.GetMount()\n options := mnt.MountFlag\n    ...\n    \n if !mounted {\n  ll.Info(&quot;mounting the volume&quot;)\n  if err := d.mounter.Mount(source, target, fsType, options...); err != nil {\n   return nil, status.Error(codes.Internal, err.Error())\n  }\n } else {\n  ll.Info(&quot;volume is already mounted&quot;)\n }\n \n return &amp;csi.NodePublishVolumeResponse{}, nil\n}\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¿™ä¸€æ­¥å®ç°ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦åšä¸€æ­¥æ“ä½œï¼Œå³ï¼šå°†Stagingç›®å½•ï¼Œç»‘å®šæŒ‚è½½åˆ°Volumeå¯¹åº”çš„å®¿ä¸»æœºç›®å½•ä¸Šã€‚</p><p>ç”±äºStagingç›®å½•ï¼Œæ­£æ˜¯Volumeå¯¹åº”çš„è®¾å¤‡è¢«æ ¼å¼åŒ–åæŒ‚è½½åœ¨å®¿ä¸»æœºä¸Šçš„ä½ç½®ï¼Œæ‰€ä»¥å½“å®ƒå’ŒVolumeçš„å®¿ä¸»æœºç›®å½•ç»‘å®šæŒ‚è½½ä¹‹åï¼Œè¿™ä¸ªVolumeå®¿ä¸»æœºç›®å½•çš„â€œæŒä¹…åŒ–â€å¤„ç†ä¹Ÿå°±å®Œæˆäº†ã€‚</p><p>å½“ç„¶ï¼Œæˆ‘åœ¨å‰é¢ä¹Ÿæ›¾ç»æåˆ°è¿‡ï¼Œå¯¹äºæ–‡ä»¶ç³»ç»Ÿç±»å‹çš„å­˜å‚¨æœåŠ¡æ¥è¯´ï¼Œæ¯”å¦‚NFSå’ŒGlusterFSç­‰ï¼Œå®ƒä»¬å¹¶æ²¡æœ‰ä¸€ä¸ªå¯¹åº”çš„ç£ç›˜â€œè®¾å¤‡â€å­˜åœ¨äºå®¿ä¸»æœºä¸Šï¼Œæ‰€ä»¥kubeletåœ¨VolumeManagerReconcileræ§åˆ¶å¾ªç¯ä¸­ï¼Œä¼šè·³è¿‡MountDeviceæ“ä½œè€Œç›´æ¥æ‰§è¡ŒSetUpæ“ä½œã€‚æ‰€ä»¥å¯¹äºå®ƒä»¬æ¥è¯´ï¼Œä¹Ÿå°±ä¸éœ€è¦å®ç°NodeStageVolumeæ¥å£äº†ã€‚</p><p><span class=\"orange\">åœ¨ç¼–å†™å®Œäº†CSIæ’ä»¶ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠè¿™ä¸ªæ’ä»¶å’ŒExternal Componentsä¸€èµ·éƒ¨ç½²èµ·æ¥ã€‚</span></p><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªDigitalOcean clientæˆæƒéœ€è¦ä½¿ç”¨çš„Secretå¯¹è±¡ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>apiVersion: v1\nkind: Secret\nmetadata:\n  name: digitalocean\n  namespace: kube-system\nstringData:\n  access-token: &quot;a05dd2f26b9b9ac2asdas__REPLACE_ME____123cb5d1ec17513e06da&quot;\n</code></pre><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é€šè¿‡ä¸€å¥æŒ‡ä»¤å°±å¯ä»¥å°†CSIæ’ä»¶éƒ¨ç½²èµ·æ¥ï¼š</p><pre><code>$ kubectl apply -f https://raw.githubusercontent.com/digitalocean/csi-digitalocean/master/deploy/kubernetes/releases/csi-digitalocean-v0.2.0.yaml\n</code></pre><p>è¿™ä¸ªCSIæ’ä»¶çš„YAMLæ–‡ä»¶çš„ä¸»è¦å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼ˆå…¶ä¸­ï¼Œéé‡è¦çš„å†…å®¹å·²ç»è¢«ç•¥å»ï¼‰ï¼š</p><pre><code>kind: DaemonSet\napiVersion: apps/v1beta2\nmetadata:\n  name: csi-do-node\n  namespace: kube-system\nspec:\n  selector:\n    matchLabels:\n      app: csi-do-node\n  template:\n    metadata:\n      labels:\n        app: csi-do-node\n        role: csi-do\n    spec:\n      serviceAccount: csi-do-node-sa\n      hostNetwork: true\n      containers:\n        - name: driver-registrar\n          image: quay.io/k8scsi/driver-registrar:v0.3.0\n          ...\n        - name: csi-do-plugin\n          image: digitalocean/do-csi-plugin:v0.2.0\n          args :\n            - &quot;--endpoint=$(CSI_ENDPOINT)&quot;\n            - &quot;--token=$(DIGITALOCEAN_ACCESS_TOKEN)&quot;\n            - &quot;--url=$(DIGITALOCEAN_API_URL)&quot;\n          env:\n            - name: CSI_ENDPOINT\n              value: unix:///csi/csi.sock\n            - name: DIGITALOCEAN_API_URL\n              value: https://api.digitalocean.com/\n            - name: DIGITALOCEAN_ACCESS_TOKEN\n              valueFrom:\n                secretKeyRef:\n                  name: digitalocean\n                  key: access-token\n          imagePullPolicy: &quot;Always&quot;\n          securityContext:\n            privileged: true\n            capabilities:\n              add: [&quot;SYS_ADMIN&quot;]\n            allowPrivilegeEscalation: true\n          volumeMounts:\n            - name: plugin-dir\n              mountPath: /csi\n            - name: pods-mount-dir\n              mountPath: /var/lib/kubelet\n              mountPropagation: &quot;Bidirectional&quot;\n            - name: device-dir\n              mountPath: /dev\n      volumes:\n        - name: plugin-dir\n          hostPath:\n            path: /var/lib/kubelet/plugins/com.digitalocean.csi.dobs\n            type: DirectoryOrCreate\n        - name: pods-mount-dir\n          hostPath:\n            path: /var/lib/kubelet\n            type: Directory\n        - name: device-dir\n          hostPath:\n            path: /dev\n---\nkind: StatefulSet\napiVersion: apps/v1beta1\nmetadata:\n  name: csi-do-controller\n  namespace: kube-system\nspec:\n  serviceName: &quot;csi-do&quot;\n  replicas: 1\n  template:\n    metadata:\n      labels:\n        app: csi-do-controller\n        role: csi-do\n    spec:\n      serviceAccount: csi-do-controller-sa\n      containers:\n        - name: csi-provisioner\n          image: quay.io/k8scsi/csi-provisioner:v0.3.0\n          ...\n        - name: csi-attacher\n          image: quay.io/k8scsi/csi-attacher:v0.3.0\n          ...\n        - name: csi-do-plugin\n          image: digitalocean/do-csi-plugin:v0.2.0\n          args :\n            - &quot;--endpoint=$(CSI_ENDPOINT)&quot;\n            - &quot;--token=$(DIGITALOCEAN_ACCESS_TOKEN)&quot;\n            - &quot;--url=$(DIGITALOCEAN_API_URL)&quot;\n          env:\n            - name: CSI_ENDPOINT\n              value: unix:///var/lib/csi/sockets/pluginproxy/csi.sock\n            - name: DIGITALOCEAN_API_URL\n              value: https://api.digitalocean.com/\n            - name: DIGITALOCEAN_ACCESS_TOKEN\n              valueFrom:\n                secretKeyRef:\n                  name: digitalocean\n                  key: access-token\n          imagePullPolicy: &quot;Always&quot;\n          volumeMounts:\n            - name: socket-dir\n              mountPath: /var/lib/csi/sockets/pluginproxy/\n      volumes:\n        - name: socket-dir\n          emptyDir: {}\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬ç¼–å†™çš„CSIæ’ä»¶åªæœ‰ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå®ƒçš„é•œåƒæ˜¯digitalocean/do-csi-plugin:v0.2.0ã€‚</p><p>è€Œæˆ‘ä»¬<strong>éƒ¨ç½²CSIæ’ä»¶çš„å¸¸ç”¨åŸåˆ™æ˜¯ï¼š</strong></p><p><strong>ç¬¬ä¸€ï¼Œé€šè¿‡DaemonSetåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ½å¯åŠ¨ä¸€ä¸ªCSIæ’ä»¶ï¼Œæ¥ä¸ºkubeletæä¾›CSI NodeæœåŠ¡</strong>ã€‚è¿™æ˜¯å› ä¸ºï¼ŒCSI NodeæœåŠ¡éœ€è¦è¢«kubeletç›´æ¥è°ƒç”¨ï¼Œæ‰€ä»¥å®ƒè¦å’Œkubeletâ€œä¸€å¯¹ä¸€â€åœ°éƒ¨ç½²èµ·æ¥ã€‚</p><p>æ­¤å¤–ï¼Œåœ¨ä¸Šè¿°DaemonSetçš„å®šä¹‰é‡Œé¢ï¼Œé™¤äº†CSIæ’ä»¶ï¼Œæˆ‘ä»¬è¿˜ä»¥sidecarçš„æ–¹å¼è¿è¡Œç€driver-registrarè¿™ä¸ªå¤–éƒ¨ç»„ä»¶ã€‚å®ƒçš„ä½œç”¨ï¼Œæ˜¯å‘kubeletæ³¨å†Œè¿™ä¸ªCSIæ’ä»¶ã€‚è¿™ä¸ªæ³¨å†Œè¿‡ç¨‹ä½¿ç”¨çš„æ’ä»¶ä¿¡æ¯ï¼Œåˆ™é€šè¿‡è®¿é—®åŒä¸€ä¸ªPodé‡Œçš„CSIæ’ä»¶å®¹å™¨çš„IdentityæœåŠ¡è·å–åˆ°ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºCSIæ’ä»¶è¿è¡Œåœ¨ä¸€ä¸ªå®¹å™¨é‡Œï¼Œé‚£ä¹ˆCSI NodeæœåŠ¡åœ¨â€œMounté˜¶æ®µâ€æ‰§è¡Œçš„æŒ‚è½½æ“ä½œï¼Œå®é™…ä¸Šæ˜¯å‘ç”Ÿåœ¨è¿™ä¸ªå®¹å™¨çš„Mount Namespaceé‡Œçš„ã€‚å¯æ˜¯ï¼Œæˆ‘ä»¬çœŸæ­£å¸Œæœ›æ‰§è¡ŒæŒ‚è½½æ“ä½œçš„å¯¹è±¡ï¼Œéƒ½æ˜¯å®¿ä¸»æœº/var/lib/kubeletç›®å½•ä¸‹çš„æ–‡ä»¶å’Œç›®å½•ã€‚</p><p>æ‰€ä»¥ï¼Œåœ¨å®šä¹‰DaemonSet Podçš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦æŠŠå®¿ä¸»æœºçš„/var/lib/kubeletä»¥Volumeçš„æ–¹å¼æŒ‚è½½è¿›CSIæ’ä»¶å®¹å™¨çš„åŒåç›®å½•ä¸‹ï¼Œç„¶åè®¾ç½®è¿™ä¸ªVolumeçš„mountPropagation=Bidirectionalï¼Œå³å¼€å¯åŒå‘æŒ‚è½½ä¼ æ’­ï¼Œä»è€Œå°†å®¹å™¨åœ¨è¿™ä¸ªç›®å½•ä¸‹è¿›è¡Œçš„æŒ‚è½½æ“ä½œâ€œä¼ æ’­â€ç»™å®¿ä¸»æœºï¼Œåä¹‹äº¦ç„¶ã€‚</p><p><strong>ç¬¬äºŒï¼Œé€šè¿‡StatefulSetåœ¨ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹ä¸Šå†å¯åŠ¨ä¸€ä¸ªCSIæ’ä»¶ï¼Œä¸ºExternal Componentsæä¾›CSI ControlleræœåŠ¡</strong>ã€‚æ‰€ä»¥ï¼Œä½œä¸ºCSI ControlleræœåŠ¡çš„è°ƒç”¨è€…ï¼ŒExternal Provisionerå’ŒExternal Attacherè¿™ä¸¤ä¸ªå¤–éƒ¨ç»„ä»¶ï¼Œå°±éœ€è¦ä»¥sidecarçš„æ–¹å¼å’Œè¿™æ¬¡éƒ¨ç½²çš„CSIæ’ä»¶å®šä¹‰åœ¨åŒä¸€ä¸ªPodé‡Œã€‚</p><p>ä½ å¯èƒ½ä¼šå¥½å¥‡ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬ä¼šç”¨StatefulSetè€Œä¸æ˜¯Deploymentæ¥è¿è¡Œè¿™ä¸ªCSIæ’ä»¶å‘¢ã€‚</p><p>è¿™æ˜¯å› ä¸ºï¼Œç”±äºStatefulSetéœ€è¦ç¡®ä¿åº”ç”¨æ‹“æ‰‘çŠ¶æ€çš„ç¨³å®šæ€§ï¼Œæ‰€ä»¥å®ƒå¯¹Podçš„æ›´æ–°ï¼Œæ˜¯ä¸¥æ ¼ä¿è¯é¡ºåºçš„ï¼Œå³ï¼šåªæœ‰åœ¨å‰ä¸€ä¸ªPodåœæ­¢å¹¶åˆ é™¤ä¹‹åï¼Œå®ƒæ‰ä¼šåˆ›å»ºå¹¶å¯åŠ¨ä¸‹ä¸€ä¸ªPodã€‚</p><p>è€Œåƒæˆ‘ä»¬ä¸Šé¢è¿™æ ·å°†StatefulSetçš„replicasè®¾ç½®ä¸º1çš„è¯ï¼ŒStatefulSetå°±ä¼šç¡®ä¿Podè¢«åˆ é™¤é‡å»ºçš„æ—¶å€™ï¼Œæ°¸è¿œæœ‰ä¸”åªæœ‰ä¸€ä¸ªCSIæ’ä»¶çš„Podè¿è¡Œåœ¨é›†ç¾¤ä¸­ã€‚è¿™å¯¹CSIæ’ä»¶çš„æ­£ç¡®æ€§æ¥è¯´ï¼Œè‡³å…³é‡è¦ã€‚</p><p>è€Œåœ¨ä»Šå¤©è¿™ç¯‡æ–‡ç« ä¸€å¼€å§‹ï¼Œæˆ‘ä»¬å°±å·²ç»å®šä¹‰äº†è¿™ä¸ªCSIæ’ä»¶å¯¹åº”çš„StorageClassï¼ˆå³ï¼šdo-block-storageï¼‰ï¼Œæ‰€ä»¥ä½ æ¥ä¸‹æ¥åªéœ€è¦å®šä¹‰ä¸€ä¸ªå£°æ˜ä½¿ç”¨è¿™ä¸ªStorageClassçš„PVCå³å¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>apiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: csi-pvc\nspec:\n  accessModes:\n  - ReadWriteOnce\n  resources:\n    requests:\n      storage: 5Gi\n  storageClassName: do-block-storage\n</code></pre><p>å½“ä½ æŠŠä¸Šè¿°PVCæäº¤ç»™Kubernetesä¹‹åï¼Œä½ å°±å¯ä»¥åœ¨Podé‡Œå£°æ˜ä½¿ç”¨è¿™ä¸ªcsi-pvcæ¥ä½œä¸ºæŒä¹…åŒ–å­˜å‚¨äº†ã€‚è¿™ä¸€éƒ¨åˆ†ä½¿ç”¨PVå’ŒPVCçš„å†…å®¹ï¼Œæˆ‘å°±ä¸å†èµ˜è¿°äº†ã€‚</p><h2>æ€»ç»“</h2><p>åœ¨ä»Šå¤©è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¥ä¸€ä¸ªDigitalOceançš„CSIæ’ä»¶ä¸ºä¾‹ï¼Œå’Œä½ åˆ†äº«äº†ç¼–å†™CSIæ’ä»¶çš„å…·ä½“æµç¨‹ã€‚</p><p>åŸºäºè¿™äº›è®²è¿°ï¼Œä½ ç°åœ¨åº”è¯¥å·²ç»å¯¹KubernetesæŒä¹…åŒ–å­˜å‚¨ä½“ç³»æœ‰äº†ä¸€ä¸ªæ›´åŠ å…¨é¢å’Œæ·±å…¥çš„è®¤è¯†ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œå¯¹äºä¸€ä¸ªéƒ¨ç½²äº†CSIå­˜å‚¨æ’ä»¶çš„Kubernetesé›†ç¾¤æ¥è¯´ï¼š</p><p>å½“ç”¨æˆ·åˆ›å»ºäº†ä¸€ä¸ªPVCä¹‹åï¼Œä½ å‰é¢éƒ¨ç½²çš„StatefulSeté‡Œçš„External Provisionerå®¹å™¨ï¼Œå°±ä¼šç›‘å¬åˆ°è¿™ä¸ªPVCçš„è¯ç”Ÿï¼Œç„¶åè°ƒç”¨åŒä¸€ä¸ªPodé‡Œçš„CSIæ’ä»¶çš„CSI ControlleræœåŠ¡çš„CreateVolumeæ–¹æ³•ï¼Œä¸ºä½ åˆ›å»ºå‡ºå¯¹åº”çš„PVã€‚</p><p>è¿™æ—¶å€™ï¼Œè¿è¡Œåœ¨Kubernetes MasterèŠ‚ç‚¹ä¸Šçš„Volume Controllerï¼Œå°±ä¼šé€šè¿‡PersistentVolumeControlleræ§åˆ¶å¾ªç¯ï¼Œå‘ç°è¿™å¯¹æ–°åˆ›å»ºå‡ºæ¥çš„PVå’ŒPVCï¼Œå¹¶ä¸”çœ‹åˆ°å®ƒä»¬å£°æ˜çš„æ˜¯åŒä¸€ä¸ªStorageClassã€‚æ‰€ä»¥ï¼Œå®ƒä¼šæŠŠè¿™ä¸€å¯¹PVå’ŒPVCç»‘å®šèµ·æ¥ï¼Œä½¿PVCè¿›å…¥BoundçŠ¶æ€ã€‚</p><p>ç„¶åï¼Œç”¨æˆ·åˆ›å»ºäº†ä¸€ä¸ªå£°æ˜ä½¿ç”¨ä¸Šè¿°PVCçš„Podï¼Œå¹¶ä¸”è¿™ä¸ªPodè¢«è°ƒåº¦å™¨è°ƒåº¦åˆ°äº†å®¿ä¸»æœºAä¸Šã€‚è¿™æ—¶å€™ï¼ŒVolume Controllerçš„AttachDetachControlleræ§åˆ¶å¾ªç¯å°±ä¼šå‘ç°ï¼Œä¸Šè¿°PVCå¯¹åº”çš„Volumeï¼Œéœ€è¦è¢«Attachåˆ°å®¿ä¸»æœºAä¸Šã€‚æ‰€ä»¥ï¼ŒAttachDetachControllerä¼šåˆ›å»ºä¸€ä¸ªVolumeAttachmentå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡æºå¸¦äº†å®¿ä¸»æœºAå’Œå¾…å¤„ç†çš„Volumeçš„åå­—ã€‚</p><p>è¿™æ ·ï¼ŒStatefulSeté‡Œçš„External Attacherå®¹å™¨ï¼Œå°±ä¼šç›‘å¬åˆ°è¿™ä¸ªVolumeAttachmentå¯¹è±¡çš„è¯ç”Ÿã€‚äºæ˜¯ï¼Œå®ƒå°±ä¼šä½¿ç”¨è¿™ä¸ªå¯¹è±¡é‡Œçš„å®¿ä¸»æœºå’ŒVolumeåå­—ï¼Œè°ƒç”¨åŒä¸€ä¸ªPodé‡Œçš„CSIæ’ä»¶çš„CSI ControlleræœåŠ¡çš„ControllerPublishVolumeæ–¹æ³•ï¼Œå®Œæˆâ€œAttaché˜¶æ®µâ€ã€‚</p><p>ä¸Šè¿°è¿‡ç¨‹å®Œæˆåï¼Œè¿è¡Œåœ¨å®¿ä¸»æœºAä¸Šçš„kubeletï¼Œå°±ä¼šé€šè¿‡VolumeManagerReconcileræ§åˆ¶å¾ªç¯ï¼Œå‘ç°å½“å‰å®¿ä¸»æœºä¸Šæœ‰ä¸€ä¸ªVolumeå¯¹åº”çš„å­˜å‚¨è®¾å¤‡ï¼ˆæ¯”å¦‚ç£ç›˜ï¼‰å·²ç»è¢«Attachåˆ°äº†æŸä¸ªè®¾å¤‡ç›®å½•ä¸‹ã€‚äºæ˜¯kubeletå°±ä¼šè°ƒç”¨åŒä¸€å°å®¿ä¸»æœºä¸Šçš„CSIæ’ä»¶çš„CSI NodeæœåŠ¡çš„NodeStageVolumeå’ŒNodePublishVolumeæ–¹æ³•ï¼Œå®Œæˆè¿™ä¸ªVolumeçš„â€œMounté˜¶æ®µâ€ã€‚</p><p>è‡³æ­¤ï¼Œä¸€ä¸ªå®Œæ•´çš„æŒä¹…åŒ–Volumeçš„åˆ›å»ºå’ŒæŒ‚è½½æµç¨‹å°±ç»“æŸäº†ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>è¯·ä½ æ ¹æ®ç¼–å†™FlexVolumeå’ŒCSIæ’ä»¶çš„æµç¨‹ï¼Œåˆ†æä¸€ä¸‹ä»€ä¹ˆæ—¶å€™è¯¥ä½¿ç”¨FlexVolumeï¼Œä»€ä¹ˆæ—¶å€™åº”è¯¥ä½¿ç”¨CSIï¼Ÿ</p><p>æ„Ÿè°¢ä½ çš„æ”¶å¬ï¼Œæ¬¢è¿ä½ ç»™æˆ‘ç•™è¨€ï¼Œä¹Ÿæ¬¢è¿åˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹ä¸€èµ·é˜…è¯»ã€‚</p>","comments":[{"had_liked":false,"id":235876,"user_name":"å¼€å¿ƒå“¥","can_delete":false,"product_type":"c1","uid":1705468,"ip_address":"","ucode":"D44C1F03B23C5A","user_header":"https://static001.geekbang.org/account/avatar/00/1a/05/fc/bceb3f2b.jpg","comment_is_top":false,"comment_ctime":1595232500,"is_pvip":false,"discussion_count":6,"race_medal":0,"score":"143329153268","product_id":100015201,"comment_content":"æœç„¶æ˜¯äº‘åŸç”ŸæŠ€æœ¯ï¼Œå¬çš„äº‘é‡Œé›¾é‡Œã€‚","like_count":33,"discussions":[{"author":{"id":2147220,"avatar":"https://static001.geekbang.org/account/avatar/00/20/c3/94/e89ebc50.jpg","nickname":"ç¥æ¯“é€é¥","note":"","ucode":"83351CB18B190E","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":390968,"discussion_content":"æ–‡å­—å¤ªå¤šï¼Œå›¾å¤ªå°‘ï¼Œé€»è¾‘çº¿å±•ç¤ºçš„ä¸æ¸…æ™°","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1630204187,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1488020,"avatar":"https://static001.geekbang.org/account/avatar/00/16/b4/94/2796de72.jpg","nickname":"è¿½é£ç­çš„äºº","note":"","ucode":"2993D60F94C396","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":536389,"discussion_content":"å¤©ä¹¦","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1638776405,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2014285,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKNv880TlsNuKaWcKbxiaAZTQIBWfJAddC8wfOROnwRPRwJXaEGSTBH2sic4jK7IGpxZn79tTDcREjw/132","nickname":"Geek_7482f6","note":"","ucode":"F3565F78525D30","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":591335,"discussion_content":"åº”ç”¨å¼€å‘å…¶å®äº†è§£ä¸€ä¸‹å°±å¥½äº†ï¼Œdevopså¼€å‘ç¨‹åºæ‰éœ€è¦è¯¦ç»†äº†è§£å¹¶å¼„æ‡‚è¿™éƒ¨åˆ†çš„å†…å®¹ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1666516192,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å¹¿ä¸œ"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1488020,"avatar":"https://static001.geekbang.org/account/avatar/00/16/b4/94/2796de72.jpg","nickname":"è¿½é£ç­çš„äºº","note":"","ucode":"2993D60F94C396","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":536388,"discussion_content":"hh","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638776396,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1625340,"avatar":"https://static001.geekbang.org/account/avatar/00/18/cc/fc/92646317.jpg","nickname":"éª‘ç€é©´è¯»ç€ä¹¦çš„è°¢å°å¤•","note":"","ucode":"56F0A469B630A2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":378267,"discussion_content":"ç¡®å®","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1623135055,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1207457,"avatar":"https://static001.geekbang.org/account/avatar/00/12/6c/a1/80d83f0a.jpg","nickname":"Ellison","note":"","ucode":"A2FB94D4F6A332","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":346317,"discussion_content":"å“ˆå“ˆå•Šå“ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1611906652,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":151906,"user_name":"djfhchdh","can_delete":false,"product_type":"c1","uid":1484184,"ip_address":"","ucode":"E71D75328CE398","user_header":"https://static001.geekbang.org/account/avatar/00/16/a5/98/a65ff31a.jpg","comment_is_top":false,"comment_ctime":1573810645,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"139012764117","product_id":100015201,"comment_content":"flexVolumeæ’ä»¶åªè´Ÿè´£attachå’Œmountï¼Œä½¿ç”¨ç®€å•ã€‚è€ŒCSIæ’ä»¶åŒ…æ‹¬äº†ä¸€éƒ¨åˆ†åŸæ¥kubernetesä¸­å­˜å‚¨ç®¡ç†çš„åŠŸèƒ½ï¼Œå®ç°ã€éƒ¨ç½²èµ·æ¥æ¯”è¾ƒå¤æ‚ã€‚æ‰€ä»¥ï¼Œå¦‚æœåœºæ™¯ç®€å•ï¼Œä¸éœ€è¦Dynamic Provisioningï¼Œåˆ™å¯ä»¥ä½¿ç”¨flexVolumeï¼›å¦‚æœåœºæ™¯å¤æ‚ï¼Œéœ€è¦æ”¯æŒDynamic Provisioningï¼Œåˆ™ç”¨CSIæ’ä»¶ã€‚","like_count":32},{"had_liked":false,"id":257305,"user_name":"ch_ort","can_delete":false,"product_type":"c1","uid":1580926,"ip_address":"","ucode":"B79746E687F29E","user_header":"","comment_is_top":false,"comment_ctime":1603934308,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"53143541860","product_id":100015201,"comment_content":"CSIçš„å·¥ä½œåŸç†ï¼š æ­¥éª¤åˆ†ä¸ºå­˜å‚¨æ’ä»¶æ³¨å†Œã€åˆ›å»ºç£ç›˜ã€æŒ‚è½½ç£ç›˜åˆ°è™šæ‹Ÿæœºã€æŒ‚è½½ç£ç›˜åˆ°Volumeã€‚å…¶ä¸­<br><br>æ’ä»¶æ³¨å†Œï¼š Driver Registerè°ƒç”¨CSIçš„CSI Identifyæ¥å®Œæˆæ³¨å†Œï¼Œå°†æ’ä»¶æ³¨å†Œåˆ°kubeleté‡Œé¢ï¼ˆè¿™å¯ä»¥ç±»æ¯”ï¼Œå°†å¯æ‰§è¡Œæ–‡ä»¶æ”¾åœ¨æ’ä»¶ç›®å½•ä¸‹ï¼‰ã€‚<br>å­˜å‚¨åˆ›å»ºï¼šExternal Provisionerè°ƒç”¨CSIçš„CSI Controlleræ¥åˆ›å»ºPVå’Œ(è¿œç¨‹)å­˜å‚¨Volumeï¼ŒPVå’ŒPVCç»‘å®šä¹‹åï¼Œéœ€è¦ç»è¿‡Attachå’ŒMountè¿™ä¸¤é˜¶æ®µä¹‹åæ‰èƒ½å˜æˆå®¿ä¸»æœºå¯ç”¨çš„Volumeã€‚æ‰€ä»¥ï¼ŒPVå’ŒPVCç»‘å®šä¹‹åï¼Œåœ¨Podæ‰€åœ¨çš„å®¿ä¸»æœºä¸Šï¼Œæ‰§è¡ŒAttachå’ŒMountï¼Œå³ï¼š<br><br>æŒ‚è½½ç£ç›˜åˆ°è™šæ‹Ÿæœºï¼š External Attacherè°ƒç”¨CSI Controlleræ¥å°†æ–°åˆ›å»ºçš„å­˜å‚¨å·æŒ‚è½½åˆ°è™šæ‹Ÿæœºä¸Šï¼ˆAttachï¼‰<br>æ ¼å¼åŒ–å¹¶æŒ‚è½½åˆ°Volumeï¼šk8sçš„NodeèŠ‚ç‚¹è°ƒç”¨CSI Node å°†è™šæ‹Ÿæœºä¸Šçš„å­˜å‚¨å·æ ¼å¼åŒ–å¹¶æŒ‚è½½åˆ°å®¹å™¨çš„Volumeä¸Šï¼ˆMountï¼‰<br><br>ä¾‹ï¼š<br><br>å½“ç”¨æˆ·åˆ›å»ºäº†ä¸€ä¸ªPVCä¹‹åï¼ŒExternal Provisionerä¼šç›‘å¬åˆ°è¿™ä¸ªPVCçš„è¯ç”Ÿï¼Œç„¶åè°ƒç”¨åŒä¸€ä¸ªPodé‡Œçš„CSIæ’ä»¶çš„CSI ControlleræœåŠ¡çš„CreateVolumeæ–¹æ³•ï¼Œä¸ºä½ åˆ›å»ºå‡ºå¯¹åº”çš„PVã€‚è¿™æ—¶å€™ï¼Œè¿è¡Œåœ¨Kubernetes MasterèŠ‚ç‚¹ä¸Šçš„Volume Controllerå°±ä¼šé€šè¿‡PersistentVolumeControlleræ§åˆ¶å¾ªç¯ï¼Œå‘ç°è¿™å¯¹æ–°åˆ›å»ºå‡ºæ¥çš„PVå’ŒPVCï¼Œå¹¶ä¸”çœ‹åˆ°å®ƒä»¬å£°æ˜çš„æ˜¯åŒä¸€ä¸ªStorageClassã€‚æ‰€ä»¥ï¼Œå®ƒä¼šæŠŠè¿™ä¸€å¯¹PVå’ŒPVCç»‘å®šï¼Œä½¿PVCè¿›å…¥BoundçŠ¶æ€ã€‚ç„¶åï¼Œç”¨æˆ·åˆ›å»ºä¸€ä¸ªå£°æ˜ä½¿ç”¨ä¸Šè¿°PVCçš„Podï¼Œå¹¶ä¸”è¿™ä¸ªPodè¢«è°ƒåº¦åˆ°äº†å®¿ä¸»æœºAä¸Šï¼Œè¿™æ—¶ï¼ŒVolume Controllerçš„AttachDetachControlleræ§åˆ¶å¾ªç¯å°±ä¼šå‘ç°ï¼Œä¸Šè¿°PVCå¯¹åº”çš„Volumeï¼Œéœ€è¦è¢«Attachåˆ°å®¿ä¸»æœºAä¸Šã€‚æ‰€ä»¥ï¼ŒAttachDetachControllerå°±ä¼šåˆ›å»ºä¸€ä¸ªVolumeAttachmentå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡æºå¸¦äº†å®¿ä¸»æœºAå’Œå¾…å¤„ç†çš„Volumeåå­—ã€‚External  Attacherç›‘å¬åˆ°VolumeAttachmentå¯¹è±¡çš„è¯ç”Ÿã€‚äºæ˜¯ï¼Œå®ƒå°±ä¼šä½¿ç”¨è¿™ä¸ªå¯¹è±¡é‡Œçš„å®¿ä¸»æœºå’ŒVolumeåå­—ï¼Œè°ƒç”¨åŒä¸€ä¸ªPodé‡Œçš„CSIæ’ä»¶çš„CSI ControlleræœåŠ¡çš„ControllerPublishVolumeï¼Œå®ŒæˆAttaché˜¶æ®µã€‚ä¸Šè¿°è¿‡ç¨‹å®Œæˆåï¼Œè¿è¡Œåœ¨å®¿ä¸»æœºAçš„kubeletï¼Œå°±ä¼šé€šè¿‡VolumeManagerReconcileræ§åˆ¶å¾ªç¯ï¼Œå‘ç°å½“å‰å®¿ä¸»æœºä¸Šæœ‰ä¸€ä¸ªVolumeå¯¹åº”çš„å­˜å‚¨è®¾å¤‡ï¼ˆæ¯”å¦‚ç£ç›˜ï¼‰å·²ç»è¢«Attachåˆ°äº†æŸä¸ªè®¾å¤‡ç›®å½•ä¸‹ã€‚äºæ˜¯kubeletå°±ä¼šè°ƒç”¨åŒä¸€å®¿ä¸»æœºä¸Šçš„CSIæ’ä»¶çš„CSI NodeæœåŠ¡çš„NodeStageVolumeå’ŒNodePublishVolumeå®Œæˆè¿™ä¸ªVolumeçš„â€œMounté˜¶æ®µâ€ã€‚è‡³æ­¤ï¼Œä¸€ä¸ªå®Œæˆçš„æŒä¹…åŒ–Volumeçš„åˆ›å»ºå’ŒæŒ‚è½½å°±ç»“æŸäº†ã€‚<br>","like_count":12},{"had_liked":false,"id":152189,"user_name":"æ‹‰æ¬§","can_delete":false,"product_type":"c1","uid":1206605,"ip_address":"","ucode":"40996A8093A95F","user_header":"https://static001.geekbang.org/account/avatar/00/12/69/4d/81c44f45.jpg","comment_is_top":false,"comment_ctime":1573908194,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"53113515746","product_id":100015201,"comment_content":"è€å¸ˆå¯¹k8sçš„ç†è§£çœŸå¿ƒè®©äººæ•¬ä½©","like_count":12},{"had_liked":false,"id":37303,"user_name":"åˆå­¦è€…","can_delete":false,"product_type":"c1","uid":1042833,"ip_address":"","ucode":"9471A905D07CE1","user_header":"https://static001.geekbang.org/account/avatar/00/0f/e9/91/4219d305.jpg","comment_is_top":false,"comment_ctime":1541526911,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"44491199871","product_id":100015201,"comment_content":"ä¸€èˆ¬æ¥è¯´ä¸€ä¸ªå—å­˜å‚¨åœ¨è¢«å®¿ä¸»æœºä½¿ç”¨ä¹‹å‰ï¼Œéœ€è¦å…ˆå°†è¯¥å—å­˜å‚¨load åˆ°å®¿ä¸»æœºçš„&#47;dev ä¸‹æˆä¸ºlinux çš„è®¾å¤‡æ–‡ä»¶ï¼Œç„¶åformatè¿˜è®¾å¤‡æ–‡ä»¶ï¼Œç„¶åæŒ‚è½½åˆ°ä¸€ä¸ªç›®å½•ä¸‹å°±å¯ä»¥ä½¿ç”¨äº†ï¼Œæˆ‘è§‰å¾—nodestagevolumeè¿™æ­¥æŒ‚è½½æ“ä½œæ›´åƒæ˜¯ä¸ºäº†åŒä¸€å°å®¿ä¸»æœºä¸Šçš„pod å¯ä»¥å…±äº«ä¸€å—ç›˜","like_count":10},{"had_liked":false,"id":36548,"user_name":"DJH","can_delete":false,"product_type":"c1","uid":1256740,"ip_address":"","ucode":"2BDEF123B3DB6A","user_header":"https://static001.geekbang.org/account/avatar/00/13/2d/24/28acca15.jpg","comment_is_top":false,"comment_ctime":1541147278,"is_pvip":false,"replies":[{"id":"13043","content":"é¢„å¤„ç†å®Œæˆå‰volumeå¹¶ä¸æ˜¯å¯ç”¨çš„ï¼Œç›´æ¥æŒ‚è½½ç›®çš„ç›®å½•ä¸Šæ˜¾ç„¶å¤ªæ—©äº†ã€‚","user_name":"ä½œè€…å›å¤","comment_id":36548,"uid":"1218095","ip_address":"","utype":1,"ctime":1541339355,"user_name_real":"Geek_6ef93d"}],"discussion_count":4,"race_medal":0,"score":"23015983758","product_id":100015201,"comment_content":"å¤§å¸ˆï¼Œè¯·æ•™ä¸€ä¸ªé—®é¢˜ï¼š&quot;å°†Stagingç›®å½•ï¼Œç»‘å®šæŒ‚è½½åˆ°Volumeå¯¹åº”çš„å®¿ä¸»æœºç›®å½•ä¸Š&quot;è¿™ä¸ªç»‘å®šæŒ‚è½½æ˜¯æŒ‡mount -bindå—ï¼Ÿ ä¸ºä»€ä¹ˆè¦æŒ‚è½½åˆ°ä¸€ä¸ªä¸´æ—¶ç›®å½•ï¼Œå†ç»‘å®šæŒ‚è½½Volumeå¯¹åº”çš„å®¿ä¸»æœºç›®å½•ä¸Šï¼Œè€Œä¸æ˜¯ä¸€æ­¥æŒ‚è½½åˆ°ç›®æ ‡ç›®å½•ä¸Šï¼Ÿå¦å¤–Stagingç›®å½•å…·ä½“æ˜¯å“ªä¸ªç›®å½•ï¼Ÿ<br>è°¢è°¢ï¼","like_count":5,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"å¼ ç£Š Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":427906,"discussion_content":"é¢„å¤„ç†å®Œæˆå‰volumeå¹¶ä¸æ˜¯å¯ç”¨çš„ï¼Œç›´æ¥æŒ‚è½½ç›®çš„ç›®å½•ä¸Šæ˜¾ç„¶å¤ªæ—©äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1541339355,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1018611,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/8a/f3/fc992148.jpg","nickname":"kitsdk","note":"","ucode":"A3570300D8A48C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":574846,"discussion_content":"ä¸¾ä¸ªä¾‹å­ï¼Œlinuxå¢åŠ ä¸€å—ç›˜å³ä¸€ä¸ªå—è®¾å¤‡æ¯”å¦‚/dev/vdbï¼Œè¿™æ—¶å€™ä½ èƒ½ç›´æ¥é€šè¿‡å‘½ä»¤æ ¼å¼åŒ–mkfs.xfs /dev/vdbå—ï¼Ÿç­”æ¡ˆæ˜¯ä¸èƒ½ã€‚ä½ éœ€è¦å…ˆåˆ†åŒºåˆå§‹åŒ–ä¸€ä¸ªåˆ†åŒºæ¯”å¦‚/dev/vdb1ç„¶åå°±å¯ä»¥mkfs.xfs /dev/vdb1äº†","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1654402262,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1350159,"avatar":"https://static001.geekbang.org/account/avatar/00/14/9a/0f/da7ed75a.jpg","nickname":"èŠ’æœå°‘ä¾ ","note":"","ucode":"98D0BBB52BB80F","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":197776,"discussion_content":"å°†ç›®å½•æš‚å­˜èµ·æ¥å¯èƒ½æ˜¯ä¸ºäº†æœ€ç»ˆæŒ‚è½½ä¹‹å‰ä¸€äº›å¯æ‰©å±•æ­¥éª¤ã€‚æ¯”å¦‚è¯´ç”¨è¿™ä¸ªæš‚å­˜çš„ç›®å½•åšä¸€äº›åˆ«çš„äº‹æƒ…ï¼Œåˆ°æ—¶é‡åˆ°äº†å…·ä½“é—®é¢˜å†è¿›è¡Œåˆ†æå³å¯ã€‚\n\nhttps://github.com/container-storage-interface/spec/blob/da3002f2908656e6387aa91d72ac77441900b974/spec.md\nè¿™æ˜¯CSIçš„NoticeStageVolumeRequestä¸­çš„å­—æ®µï¼Œæ¨æµ‹æ˜¯ç”¨äºè¾…åŠ©å¼€å‘è€…å…ˆæš‚å­˜åˆ°è¯¥ç›®å½•ã€‚åç»­å¯ä»¥åŸºäºè¯¥æš‚å­˜ç›®å½•ç»§ç»­è¿›ä¸€æ­¥å¤„ç†ã€‚\n\nå…¶å®ï¼Œåœ¨è¿™ä¸ªdigitalOceançš„CSIæ’ä»¶ä¾‹å­ä¸­ï¼Œå®Œå…¨å¯ä»¥åœ¨stagevolumeæ­¥éª¤ä¸­ä¸è¿›è¡Œè¿™æ­¥æ“ä½œï¼ˆåªæ‰§è¡Œæ ¼å¼åŒ–ï¼‰ï¼Œè€Œåœ¨publishVolumnæ­¥éª¤ä¸­ï¼Œå†åˆ©ç”¨volç›´æ¥æŒ‚è½½å³å¯ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583432317,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1218347,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLvdWoCic6ItzibF8ia8vrUTRuyj6AT3tg5f4QicIK0jTIFheJ6274ZkibuRLFP1NXG3jibv5TiaSKNoJpLw/132","nickname":"Geek_37984c","note":"","ucode":"7A319AE28599B0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":163256,"discussion_content":"ä¸ºä»€ä¹ˆå¤ªæ—©äº†ï¼Ÿå¦å¤–Stagingç›®å½•å…·ä½“æ˜¯å“ªä¸ªç›®å½•ï¼ŸåŒé—®","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581065008,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":286192,"user_name":"æœ±ä¸œè¾‰","can_delete":false,"product_type":"c1","uid":1983157,"ip_address":"","ucode":"D9EA5C37A1B386","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIh7iatqAeGsJuDNxsDlmCQx64ktJl7ATAkBtDO6iczIqsLFPXkF6GPGJpMBCxbl4DJ5obHwAK0bSAQ/132","comment_is_top":false,"comment_ctime":1617182888,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"18797052072","product_id":100015201,"comment_content":"å¼ å¤§ä½¬çœŸçš„å¤©èŠ±æ¿ä¸€æ ·çš„å­˜å‚¨ï¼ŒäºŒåˆ·ä¾ç„¶æ”¶è·æ»¡æ»¡ï¼Œå¤šè°¢å¤§ä½¬æä¾›çš„è¿™ä¹ˆå¥½çš„å­¦ä¹ èµ„æ–™","like_count":4},{"had_liked":false,"id":63180,"user_name":"xfan","can_delete":false,"product_type":"c1","uid":1315147,"ip_address":"","ucode":"48ED8D498D7F56","user_header":"https://static001.geekbang.org/account/avatar/00/14/11/4b/fa64f061.jpg","comment_is_top":false,"comment_ctime":1548294073,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"14433195961","product_id":100015201,"comment_content":"æ‰¾åˆ°äº†ï¼Œæ–‡ä¸­æœ‰å‡ºç°ã€‚æ˜¯åœ¨ https:&#47;&#47;raw.githubusercontent.com&#47;digitalocean&#47;csi-digitalocean<br>","like_count":3},{"had_liked":false,"id":36827,"user_name":"silver","can_delete":false,"product_type":"c1","uid":1186740,"ip_address":"","ucode":"908E3C8560D6E1","user_header":"https://static001.geekbang.org/account/avatar/00/12/1b/b4/a6db1c1e.jpg","comment_is_top":false,"comment_ctime":1541363328,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"14426265216","product_id":100015201,"comment_content":"å—å¤„ç†è®¾å¤‡ä»æŒ‚è½½åˆ°stagingï¼Œåˆ°æŒ‚è½½åˆ°å®¿ä¸»æœºç›®å½•å…·ä½“åšäº†å“ªäº›é¢„å¤„ç†å‘¢ï¼Ÿæˆ‘å’Œå‰é¢å‡ ä½ä¸€æ ·ï¼Œå¯¹éœ€è¦åˆ†ä¸¤éƒ¨æŒ‚è½½ä¸æ˜¯å¾ˆç†è§£","like_count":3},{"had_liked":false,"id":38618,"user_name":"è½¦å°å‹ºçš„ç”·ç¥","can_delete":false,"product_type":"c1","uid":1285577,"ip_address":"","ucode":"6D5C959139D40B","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJutT9JkFAcOk1JxOBdPuLgROpvcuxD9ROP9ACILAHITjcaYGNrZ5lHMZORYM6ibCuScDibYlgRvAIw/132","comment_is_top":false,"comment_ctime":1542086615,"is_pvip":false,"replies":[{"id":"13873","content":"å¯ä»¥å•Š ä½ æœä¸‹S3çš„Kubernetes å­˜å‚¨æ’ä»¶","user_name":"ä½œè€…å›å¤","comment_id":38618,"uid":"1218095","ip_address":"","utype":1,"ctime":1542122207,"user_name_real":"Geek_6ef93d"}],"discussion_count":1,"race_medal":0,"score":"10132021207","product_id":100015201,"comment_content":"è¯·æ•™ä¸€ä¸‹ èƒ½ç”¨å¯¹è±¡å­˜å‚¨æ¥ä½œä¸ºæŒä¹…åŒ–å­˜å‚¨ä¹ˆ","like_count":2,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"å¼ ç£Š Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":428758,"discussion_content":"å¯ä»¥å•Š ä½ æœä¸‹S3çš„Kubernetes å­˜å‚¨æ’ä»¶","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1542122207,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":339111,"user_name":"ryan","can_delete":false,"product_type":"c1","uid":1596005,"ip_address":"","ucode":"845DAC632BF51B","user_header":"https://static001.geekbang.org/account/avatar/00/18/5a/65/b80035a6.jpg","comment_is_top":false,"comment_ctime":1647920885,"is_pvip":true,"discussion_count":0,"race_medal":1,"score":"5942888181","product_id":100015201,"comment_content":"å¥½åƒçœ‹æ‡‚äº†ï¼Œåˆå¥½åƒæ²¡çœ‹æ‡‚","like_count":1},{"had_liked":false,"id":199944,"user_name":"Geek_f1b96b","can_delete":false,"product_type":"c1","uid":1940893,"ip_address":"","ucode":"9B05B56BEB0EA5","user_header":"","comment_is_top":false,"comment_ctime":1585504507,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5880471803","product_id":100015201,"comment_content":"è€å¸ˆï¼Œä½ å¥½ï¼š  ControllerPublishVolume è¿™ä¸ªæ–¹æ³•æ˜¯å¦‚ä½•å°† å—è®¾å¤‡mapåˆ°nodeä¸Šçš„ï¼Ÿ å®ƒåº”è¯¥æ˜¯external-attacher ï¼ˆdeployment æˆ–daemonsetï¼‰ä¸­çš„æ–¹æ³•ï¼Œå®ƒå’Œnodeä¸­çš„å“ªä¸ªè¿›ç¨‹é€šä¿¡nodeplugin or kubeletï¼Ÿtks","like_count":1},{"had_liked":false,"id":172753,"user_name":"Podman","can_delete":false,"product_type":"c1","uid":1801003,"ip_address":"","ucode":"1C9C7EA8C28ED7","user_header":"https://static001.geekbang.org/account/avatar/00/1b/7b/2b/97e4d599.jpg","comment_is_top":false,"comment_ctime":1579273668,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5874240964","product_id":100015201,"comment_content":"è¯·æ•™ä¸€ä¸‹ï¼Œglusterfs+heketi+k8så®ç°çš„è‡ªåŠ¨ç»‘å®šPVçš„æ¨¡å¼ æˆ‘æ˜¯å¦å¯ä»¥ç†è§£ä¸ºä¸ceph+rook+k8sæ¨¡å¼ä¸€è‡´ï¼ŸCSIå®ç°çš„è‡ªå®šä¹‰å­˜å‚¨æ’ä»¶ä¸rookçš„è§’è‰²æœ‰ä½•ä¸åŒï¼Ÿglusterfs+heketi+k8sçš„æ¶æ„æ˜¯ä¸æ˜¯ä¹Ÿå¯ä»¥é€šè¿‡CSIæ¥å®ç°ï¼Ÿ","like_count":1},{"had_liked":false,"id":47356,"user_name":"Alery","can_delete":false,"product_type":"c1","uid":1156557,"ip_address":"","ucode":"08F3F49181E67B","user_header":"https://static001.geekbang.org/account/avatar/00/11/a5/cd/3aff5d57.jpg","comment_is_top":false,"comment_ctime":1544113336,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5839080632","product_id":100015201,"comment_content":"å¯¹äºæ–‡ä»¶ç³»ç»Ÿç±»å‹çš„å­˜å‚¨æœåŠ¡ï¼Œä¾‹å¦‚: NFSï¼Œå®ƒå¹¶æ²¡æœ‰å¯¹ä¸€ä¸ªçš„ç£ç›˜è®¾å¤‡å­˜åœ¨ä¸å®¿ä¸»æœºä¸Šï¼Œæœ‰äº›nfsç±»å‹çš„csi driverä¸Šå¹¶æ²¡æœ‰å®ç°ControllerPublishVolumeè¿™ä¸ªæ“ä½œï¼Œæ˜¯ä¸æ˜¯å¯ä»¥ç†è§£è¿™é‡Œnfså­˜å‚¨å·çš„attaché˜¶æ®µåªæ˜¯åˆ›å»ºäº†VolumeAttachmentå¯¹è±¡ï¼Œå¹¶ä¸éœ€è¦é€šè¿‡ControllerPublishVolumeå®Œæˆnfs volumeæŒ‚è½½åˆ°è™šæ‹Ÿæœºä¸Šï¼Ÿ","like_count":1},{"had_liked":false,"id":36660,"user_name":"è™è™â¤ï¸","can_delete":false,"product_type":"c1","uid":1086535,"ip_address":"","ucode":"157F261E80291A","user_header":"https://static001.geekbang.org/account/avatar/00/10/94/47/75875257.jpg","comment_is_top":false,"comment_ctime":1541222943,"is_pvip":false,"replies":[{"id":"13038","content":"csiè‡ªå·±æœ‰ä¸€å¥—types.goï¼Œè¿™è·Ÿkuberneteså·²ç»æ²¡å…³ç³»äº†","user_name":"ä½œè€…å›å¤","comment_id":36660,"uid":"1218095","ip_address":"","utype":1,"ctime":1541338885,"user_name_real":"Geek_6ef93d"}],"discussion_count":2,"race_medal":0,"score":"5836190239","product_id":100015201,"comment_content":"è¯·é—®åœ¨ä¸Šä¸€èŠ‚é‡Œæåˆ° â€œ CSI çš„ api ä¸ä¼šç›´æ¥ä½¿ç”¨ Kubernetes å®šä¹‰çš„ PV ç±»å‹ï¼Œ è€Œæ˜¯ä¼šè‡ªå·±å®šä¹‰ä¸€ä¸ªå•ç‹¬çš„ volume ç±»å‹ã€‚ è¿™ä¸ªåœ¨digitalocean csi é‡Œå…·ä½“ä½“ç°æ˜¯ä»€ä¹ˆï¼Ÿæ˜¯ä¸€ä¸ªcdrå—ï¼Œæˆ‘å¥½åƒæ²¡æ‰¾åˆ°ã€‚","like_count":1,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"å¼ ç£Š Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":427960,"discussion_content":"csiè‡ªå·±æœ‰ä¸€å¥—types.goï¼Œè¿™è·Ÿkuberneteså·²ç»æ²¡å…³ç³»äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1541338885,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1904954,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoGJtWol6dEq1uIZ9lEAc0WH7MFdlKFe3tYVNyl3ibfIXcMGS7XS85mDTbIY30JticsydYtLDhM9kIw/132","nickname":"å¤§æ¼ ç‹‚æ½®","note":"","ucode":"C3A589B82A35BD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":215173,"discussion_content":"è¯·é—®è€å¸ˆï¼Œç”¨k8s + rook + ceph æ¥æ­å»ºä¸€ä¸ªæµ·é‡çš„å›¾ç‰‡ã€è§†é¢‘çš„å­˜å‚¨æœåŠ¡å™¨å¯è¡Œå—ï¼Ÿä¸æƒ³ç”¨hadoop hdfs é‚£ä¸€å¥—","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585295791,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":36655,"user_name":"è™è™â¤ï¸","can_delete":false,"product_type":"c1","uid":1086535,"ip_address":"","ucode":"157F261E80291A","user_header":"https://static001.geekbang.org/account/avatar/00/10/94/47/75875257.jpg","comment_is_top":false,"comment_ctime":1541220026,"is_pvip":false,"replies":[{"id":"13042","content":"å—å­˜å‚¨è®¾å¤‡ä¸ç»è¿‡é¢„å¤„ç†å°±èƒ½ç›´æ¥æŒ‚è½½ä½¿ç”¨çš„æƒ…å†µï¼Œæˆ‘è¿˜çœŸæƒ³ä¸å‡ºæ¥ã€‚","user_name":"ä½œè€…å›å¤","comment_id":36655,"uid":"1218095","ip_address":"","utype":1,"ctime":1541339214,"user_name_real":"Geek_6ef93d"}],"discussion_count":3,"race_medal":0,"score":"5836187322","product_id":100015201,"comment_content":"DJH ç«Ÿç„¶å’Œæˆ‘çš„é—®é¢˜ä¸€æ¨¡ä¸€æ ·ï¼Œæ¡æ‰‹ï¼<br>ä¸ºä»€ä¹ˆä¸ç›´æ¥æŠŠè®¾å¤‡æŒ‚è½½åˆ° volumeå®¿ä¸»æœºç›®å½•ï¼Ÿåœ¨pv&#47;pvcåˆ°åº•è®²ä»€ä¹ˆé‚£ä¹ˆä¸€èŠ‚é‡Œå°±æ˜¯è¿™ä¹ˆè®²çš„ã€‚<br>åœ¨è¿™é‡Œæœ‰ä»€ä¹ˆç‰¹æ®Šçš„è€ƒè™‘å—ï¼Ÿ<br>","like_count":1,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"å¼ ç£Š Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":427958,"discussion_content":"å—å­˜å‚¨è®¾å¤‡ä¸ç»è¿‡é¢„å¤„ç†å°±èƒ½ç›´æ¥æŒ‚è½½ä½¿ç”¨çš„æƒ…å†µï¼Œæˆ‘è¿˜çœŸæƒ³ä¸å‡ºæ¥ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1541339214,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1484184,"avatar":"https://static001.geekbang.org/account/avatar/00/16/a5/98/a65ff31a.jpg","nickname":"djfhchdh","note":"","ucode":"E71D75328CE398","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":51083,"discussion_content":"å—è®¾å¤‡è‚¯å®šè¦å…ˆç»è¿‡æ ¼å¼åŒ–ï¼Œæ„å»ºæ–‡ä»¶ç³»ç»Ÿçš„ï¼Œæ‰èƒ½å†å»æŒ‚è½½å•Šï¼Œæ‰€ä»¥é¢„å¤„ç†è¿™ä¸€æ­¥ä¸èƒ½çœç•¥","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1573808951,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1199670,"avatar":"https://static001.geekbang.org/account/avatar/00/12/4e/36/de029ebf.jpg","nickname":"ğŸ¬Innocence","note":"","ucode":"7CBAB4976FACE0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":273109,"discussion_content":"è¿˜æ˜¯ä¸æ˜¯å¾ˆç†è§£ï¼Œè®¾å¤‡è·¯å¾„åº”è¯¥æ˜¯ç±»ä¼¼äº/dev/disk1è¿™è·¯å¾„ï¼Œç»è¿‡æ ¼å¼åŒ–æˆæŒ‡å®šæ ¼å¼åï¼Œåº”è¯¥æ˜¯å¯ä»¥ç›´æ¥æŒ‚åœ¨åˆ°å¯¹åº”çš„ç›®å½•ä¸Šçš„ï¼Ÿæ±‚æŒ‡æ•™","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590412282,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":360595,"user_name":"ğŸŠ ğŸ±","can_delete":false,"product_type":"c1","uid":3207939,"ip_address":"åŒ—äº¬","ucode":"D73A27E7427D7C","user_header":"https://static001.geekbang.org/account/avatar/00/30/f3/03/24a0e652.jpg","comment_is_top":false,"comment_ctime":1666679342,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1666679342","product_id":100015201,"comment_content":"æœ‰çš„åŒå­¦è·Ÿæˆ‘æœ‰ä¸€æ ·çš„ç–‘æƒ‘ï¼Œå°±æ˜¯ staging è¿™ä¸€æ­¥ä¸ºä»€ä¹ˆéœ€è¦å†æ ¼å¼åŒ–åæŒ‚è½½åˆ°ä¸€ä¸ªä¸´æ—¶ç›®å½•ï¼Œè€Œä¸æ˜¯ç›´æ¥ç•™ç»™ publish é˜¶æ®µæŒ‚åœ¨åˆ° pod ä¸­ï¼Œæ ¹æ®ä½œè€…ç»™å…¶ä»–å°ä¼™ä¼´çš„å›å¤å’Œæˆ‘é˜…è¯» sample ä»£ç çš„ç†è§£å¦‚ä¸‹ï¼škubelet çš„ VolumeManagerReconciler åˆ†ä¸¤æ­¥ mount çš„åŸå› æ˜¯å‡å¦‚ç›´æ¥ä¸€æ­¥ format çš„è¿‡ç¨‹éå¸¸ä¹…ï¼Œå¯èƒ½ä¼šå¯¼è‡´ reconciler é˜»å¡ï¼Œè€Œåˆ†å¼€ä¸¤æ­¥å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¦å¤–åœ¨ç¬¬ä¸€æ­¥ staging åæŒ‚è½½åˆ°ä¸´æ—¶ç›®å½•ï¼ˆç”± req è·å–ï¼‰çš„ç›®çš„æ˜¯æ–¹ä¾¿ reconciler åˆ¤æ–­ volumï¼ˆé€šè¿‡ä¼ ç»™ç¬¬ä¸€æ­¥ req çš„ä¸´æ—¶ç›®å½•ï¼‰ æ˜¯å¦ format å®Œæ¯•ï¼Œå¯ä»¥è¿›å…¥ç¬¬äºŒæ­¥æŒ‚è½½åˆ° pod ä¸­ã€‚å¦‚æœç†è§£é”™äº†è¿˜å¸Œæœ›ä½œè€…æŒ‡å‡ºã€‚","like_count":0},{"had_liked":false,"id":360267,"user_name":"linyy","can_delete":false,"product_type":"c1","uid":1198286,"ip_address":"ä¸Šæµ·","ucode":"F54A20D17DD5DA","user_header":"https://static001.geekbang.org/account/avatar/00/12/48/ce/9978ed21.jpg","comment_is_top":false,"comment_ctime":1666356214,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1666356214","product_id":100015201,"comment_content":"è€å¸ˆé—®ä¸‹ å­˜å‚¨æ’ä»¶æœ¬èº«çš„é«˜å¯ç”¨æ€ä¹ˆå¤„ç†å‘¢","like_count":0},{"had_liked":false,"id":348238,"user_name":"Double f","can_delete":false,"product_type":"c1","uid":2750411,"ip_address":"","ucode":"C4DCFDF0A9CA36","user_header":"https://static001.geekbang.org/account/avatar/00/29/f7/cb/771876e5.jpg","comment_is_top":false,"comment_ctime":1654856757,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1654856757","product_id":100015201,"comment_content":"ä¸€ç« çœ‹äº†4éï¼Œæ„Ÿè§‰æ¯ä¸€éæ”¶è·éƒ½ä¸ä¸€æ ·ï¼Œæ„Ÿè°¢å¤§å¸ˆ","like_count":0},{"had_liked":false,"id":344610,"user_name":"æ€€æ£æ¢¦æƒ³çš„å­¦æ¸£","can_delete":false,"product_type":"c1","uid":1916685,"ip_address":"","ucode":"2349B9F4F6FDE3","user_header":"https://static001.geekbang.org/account/avatar/00/1d/3f/0d/1e8dbb2c.jpg","comment_is_top":false,"comment_ctime":1651669737,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1651669737","product_id":100015201,"comment_content":"æœ‰ç§éœ€è¦è¡¥Go langåŸºç¡€çŸ¥è¯†çš„æ„Ÿå—","like_count":0},{"had_liked":false,"id":324999,"user_name":"è¿½é£ç­çš„äºº","can_delete":false,"product_type":"c1","uid":1488020,"ip_address":"","ucode":"2993D60F94C396","user_header":"https://static001.geekbang.org/account/avatar/00/16/b4/94/2796de72.jpg","comment_is_top":false,"comment_ctime":1638776342,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1638776342","product_id":100015201,"comment_content":"æ‡µé€¼äº†  å¤©ä¹¦          åªæœ‰ä¹‹å‰çš„namespace, cgroups,rootfs å¬æ˜ç™½äº†","like_count":0,"discussions":[{"author":{"id":2850687,"avatar":"","nickname":"Geek_3635b2","note":"","ucode":"46674380343EEF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":585635,"discussion_content":"è¿™ä¸¤èŠ‚ï¼Œæ”¾å¼ƒäº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661740767,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"æ²³å—"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":322091,"user_name":"Wall-Eve","can_delete":false,"product_type":"c1","uid":2108027,"ip_address":"","ucode":"FBF2FED8F13BD3","user_header":"https://static001.geekbang.org/account/avatar/00/20/2a/7b/2092e1fd.jpg","comment_is_top":false,"comment_ctime":1637161991,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1637161991","product_id":100015201,"comment_content":"è¯·é—®å¯¹äºç”Ÿäº§é›†ç¾¤å½“ä¸­in-treeå’Œout-of-treeç±»å‹çš„å­˜å‚¨æ–¹å¼æ›´ä¸ºé€‚åˆ","like_count":0},{"had_liked":false,"id":312398,"user_name":"kissrain","can_delete":false,"product_type":"c1","uid":1120583,"ip_address":"","ucode":"2177C53E3B2DCC","user_header":"https://static001.geekbang.org/account/avatar/00/11/19/47/b27f1314.jpg","comment_is_top":false,"comment_ctime":1631785606,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1631785606","product_id":100015201,"comment_content":"çœ‹äº†å¥½å‡ éï¼Œè¿›è¿‡å®è·µç»ˆäºçœ‹æ‡‚äº†","like_count":0},{"had_liked":false,"id":279006,"user_name":"zlel","can_delete":false,"product_type":"c1","uid":2139471,"ip_address":"","ucode":"D98D44B933D6D5","user_header":"https://static001.geekbang.org/account/avatar/00/20/a5/4f/772dd0f3.jpg","comment_is_top":false,"comment_ctime":1613538702,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1613538702","product_id":100015201,"comment_content":"â‘  åˆ›å»ºPVC &lt;--ç›‘å¬-- External Provisioner --è°ƒç”¨ --&gt; CSI Controller(CreateVolume) --&gt; åˆ›å»ºPV<br>â‘¡ PVC&amp;PVçŠ¶æ€ &lt;--è§‚å¯Ÿ-- Volume Controller(PersistentVolumeController) --&gt;ç»‘å®šPVC&amp;PV<br>â‘¢ åˆ›å»ºPod(ä½¿ç”¨PVC) --&gt; è°ƒåº¦Pod &lt;--è§‚å¯ŸPVC Volume-- Volume Controller(AttachDetachController)  --&gt; åˆ›å»ºVolumeAttachment(å«æœ‰Podè¢«è°ƒåº¦Nodeå’ŒPVC Volume)  &lt;--ç›‘å¬-- External Attacher --è°ƒç”¨--&gt; CSI Controller(ControllerPublishVolume) --&gt; Node Attach Volume<br>â‘£ Node Attach Volumeçš„è®¾å¤‡ç›®å½• &lt;--è§‚å¯Ÿ-- kubelet(VolumeManagerReconciler) --è°ƒç”¨--&gt; CSI Node(NodeStageVolume) --&gt; æ ¼å¼åŒ–Attachè®¾å¤‡ --&gt; CSI Node(NodePublishVolume) --&gt; Mountåˆ°Nodeçš„æŒ‡å®šç›®å½•","like_count":0},{"had_liked":false,"id":272001,"user_name":"å°å¯å­ã€‚(â‰¥3â‰¤)","can_delete":false,"product_type":"c1","uid":1206545,"ip_address":"","ucode":"6D978BDCBB2862","user_header":"https://static001.geekbang.org/account/avatar/00/12/69/11/831cec7d.jpg","comment_is_top":false,"comment_ctime":1609905357,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1609905357","product_id":100015201,"comment_content":"ä¸çŸ¥é“2021å¹´è¿™ä¸€å¥—æ˜¯å¦è¿˜è¿™æ ·ã€‚ æˆ‘æ‰‹ä¸Šæœ‰ä¸ªopenshiftçš„cluster é‡Œé¢çš„å®ç°å¥½åƒå¹¶ä¸å¤ªä¸€æ ·  ","like_count":0},{"had_liked":false,"id":245695,"user_name":"Geek_da8747","can_delete":false,"product_type":"c1","uid":2106619,"ip_address":"","ucode":"992F8F92664386","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIvc0wApgEPKZu9SqlyGcrj2l42bJezgicKficl7kaBA8MJx6Cbcl92YqVJ1BTTdibR9gcbrtqjpKskA/132","comment_is_top":false,"comment_ctime":1599028970,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1599028970","product_id":100015201,"comment_content":"è¯·æ•™ä¸€ä¸ªé—®é¢˜ï¼Œå½“æˆ‘åˆ›å»ºå®ŒStorageClassã€PVCã€Podä¹‹åï¼Œæˆ‘çš„CSIæ’ä»¶æ²¡æœ‰è°ƒç”¨ControllerServerçš„CreateVolumeã€‚<br>identityserverçš„GetPluginCapabilitiesä¸­ä½¿ç”¨äº† PluginCapability_Service_CONTROLLER_SERVICE<br>å¹¶ä¸”ä¹Ÿåœ¨é€‚å½“çš„ä½ç½®å£°æ˜äº†ControllerServiceCapability_RPC_CREATE_DELETE_VOLUME<br>è¾¹è½¦ä¹Ÿæ²¡æœ‰å‡ºç°é—®é¢˜<br>è¿˜æœ‰ä»€ä¹ˆåŸå› èƒ½äº§ç”Ÿè¿™ä¸ªé—®é¢˜ï¼Ÿ","like_count":0},{"had_liked":false,"id":230899,"user_name":"Mr.Brooks","can_delete":false,"product_type":"c1","uid":1118650,"ip_address":"","ucode":"D47A6B0236A79F","user_header":"https://static001.geekbang.org/account/avatar/00/11/11/ba/2175bc50.jpg","comment_is_top":false,"comment_ctime":1593518532,"is_pvip":true,"discussion_count":2,"race_medal":0,"score":"1593518532","product_id":100015201,"comment_content":"external provisioneræ˜¯ä»¥sidecarçš„æ–¹å¼éƒ¨ç½²åœ¨worker nodeä¸Šçš„podå§ï¼Ÿ é‚£ä¹ˆå½“æœ‰ä¸€ä¸ªPVCå‡ºç°çš„æ—¶å€™ï¼Œæ˜¯è°å†³å®šç”¨å“ªä¸€ä¸ªnodeä¸Šçš„provisionerå‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1207457,"avatar":"https://static001.geekbang.org/account/avatar/00/12/6c/a1/80d83f0a.jpg","nickname":"Ellison","note":"","ucode":"A2FB94D4F6A332","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":346320,"discussion_content":"é¢„é€‰å’Œä¼˜é€‰è°ƒåº¦çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1611906704,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1207457,"avatar":"https://static001.geekbang.org/account/avatar/00/12/6c/a1/80d83f0a.jpg","nickname":"Ellison","note":"","ucode":"A2FB94D4F6A332","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":346319,"discussion_content":"schdulerå•Š","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1611906692,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":184219,"user_name":"èƒ–è¾¾","can_delete":false,"product_type":"c1","uid":1348090,"ip_address":"","ucode":"84E23DB84F258A","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIwWPicOxyL0sIVicLOcFI5IIEkffn56gOzRWfFY6exEmUUbxPicHyWC579SM6jga3oxcLzRibGHoA9Qw/132","comment_is_top":false,"comment_ctime":1583248613,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1583248613","product_id":100015201,"comment_content":"è€å¸ˆï¼Œè¯·æ•™ä¸‹NodePublishVolumeå¯ä»¥ä»è¯·æ±‚å‚æ•°ä¸­è·å–namespacesç­‰ä¿¡æ¯ä¹ˆ","like_count":0},{"had_liked":false,"id":115309,"user_name":"æ•°å­—è®°å¿†","can_delete":false,"product_type":"c1","uid":1227797,"ip_address":"","ucode":"26E16F65F559A1","user_header":"https://static001.geekbang.org/account/avatar/00/12/bc/15/23ce17f9.jpg","comment_is_top":false,"comment_ctime":1563529250,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1563529250","product_id":100015201,"comment_content":"å†™çš„å¤ªå¥½äº†","like_count":0},{"had_liked":false,"id":61065,"user_name":"JZY","can_delete":false,"product_type":"c1","uid":1228072,"ip_address":"","ucode":"6115708DAB8E33","user_header":"https://static001.geekbang.org/account/avatar/00/12/bd/28/df2b8cee.jpg","comment_is_top":false,"comment_ctime":1547610701,"is_pvip":false,"replies":[{"id":"22064","content":"æ–‡ä¸­å·²ç»ç»™å‡ºäº†å•Š","user_name":"ä½œè€…å›å¤","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1548053733,"ip_address":"","comment_id":61065,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1547610701","product_id":100015201,"comment_content":"è¯·é—®å“ªé‡Œæœ‰å®Œæ•´çš„ç¤ºä¾‹å‘¢ï¼Œæˆ‘çœ‹æ–‡ä¸­æœ‰éƒ¨åˆ†æ˜¯...çœç•¥çš„","like_count":0,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"å¼ ç£Š Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":436730,"discussion_content":"æ–‡ä¸­å·²ç»ç»™å‡ºäº†å•Š","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548053733,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":38807,"user_name":"è½¦å°å‹ºçš„ç”·ç¥","can_delete":false,"product_type":"c1","uid":1285577,"ip_address":"","ucode":"6D5C959139D40B","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJutT9JkFAcOk1JxOBdPuLgROpvcuxD9ROP9ACILAHITjcaYGNrZ5lHMZORYM6ibCuScDibYlgRvAIw/132","comment_is_top":false,"comment_ctime":1542131639,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1542131639","product_id":100015201,"comment_content":"s3çš„å­˜å‚¨æ’ä»¶å¤§å¤šæ˜¯é€šè¿‡s3fsè¿™ç±»çš„å·¥å…·å®ç°çš„ï¼Œè¯·é—®s3å¯ä»¥ç›´æ¥ç”¨åšæŒä¹…åŒ–å­˜å‚¨å˜›","like_count":0},{"had_liked":false,"id":37169,"user_name":"åœ£è¯ä½¿è€…","can_delete":false,"product_type":"c1","uid":1028183,"ip_address":"","ucode":"E59436F6392122","user_header":"https://static001.geekbang.org/account/avatar/00/0f/b0/57/a84d633e.jpg","comment_is_top":false,"comment_ctime":1541471924,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1541471924","product_id":100015201,"comment_content":"çœ‹äº†åˆ«äººçš„è¯„è®ºï¼Œæˆ‘ä¹Ÿä¸æ˜¯å¾ˆæ‡‚è¿™ä¸ª NodeStageVolumeï¼ŒNodePublishVolume è¿™ä¸ªä¸¤é˜¶æ®µå¤„ç†ï¼Œæˆ‘ä¸‹è½½äº† digitalocean çš„æºç ï¼Œçœ‹åˆ°è¿™ä¸ªå¥è¯ driver&#47;node.go (200)ï¼š #Perform a bind mount to the full path to allow duplicate mounts of the same PDï¼Œæ„Ÿè§‰NodePublishVolumeä¸»è¦å°±æ˜¯è¿™ä¸ªä½œç”¨ï¼ŒPDæ²¡ç†è§£ä»€ä¹ˆæ„æ€ï¼ŒçŒœæµ‹æ˜¯physical driverã€‚è¿˜è¯·è€å¸ˆè§£æƒ‘ã€‚","like_count":0,"discussions":[{"author":{"id":1227797,"avatar":"https://static001.geekbang.org/account/avatar/00/12/bc/15/23ce17f9.jpg","nickname":"æ•°å­—è®°å¿†","note":"","ucode":"26E16F65F559A1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":2385,"discussion_content":"NodeStageVolumeæ˜¯å°†å—è®¾å¤‡ä»è¿œç«¯æŒ‚è½½åˆ°æœ¬åœ°ï¼ŒNodePublishVolumeæ˜¯å°†æŒ‚è½½åˆ°æœ¬åœ°å¹¶æ ¼å¼åŒ–åçš„ç›˜æŒ‚è½½ç»‘å®šåˆ°å®¹å™¨çš„ç›®å½•ä¸Š","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563529392,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":36672,"user_name":"æ¯æ—¥éƒ½æƒ³ä¸Šç­","can_delete":false,"product_type":"c1","uid":1060466,"ip_address":"","ucode":"1DE64120C8B14A","user_header":"https://static001.geekbang.org/account/avatar/00/10/2e/72/145c10db.jpg","comment_is_top":false,"comment_ctime":1541227733,"is_pvip":false,"replies":[{"id":"13041","content":"è§serviceéƒ¨åˆ†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1541339157,"ip_address":"","comment_id":36672,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1541227733","product_id":100015201,"comment_content":"æœ‰ä¸ªé—®é¢˜ï¼šserviceåæŒ‚è½½å¤šä¸ªpodï¼Œserviceçš„è°ƒåº¦æ˜¯è½®è¯¢çš„è¿˜æ˜¯æ€ä¹ˆæ ·çš„å‘¢","like_count":0,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"å¼ ç£Š Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":427963,"discussion_content":"è§serviceéƒ¨åˆ†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1541339157,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}