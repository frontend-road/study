{"id":120834,"title":"39 | é«˜æ€§èƒ½çš„å…³é”®ï¼šshared dict ç¼“å­˜å’Œ lru ç¼“å­˜","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯æ¸©é“­ã€‚</p><p>åœ¨å‰é¢å‡ èŠ‚è¯¾ä¸­ï¼Œæˆ‘å·²ç»æŠŠ OpenResty è‡ªèº«çš„ä¼˜åŒ–æŠ€å·§å’Œæ€§èƒ½è°ƒä¼˜çš„å·¥å…·éƒ½ä»‹ç»è¿‡äº†ï¼Œåˆ†åˆ«æ¶‰åŠåˆ°å­—ç¬¦ä¸²ã€tableã€Lua APIã€LuaJITã€SystemTapã€ç«ç„°å›¾ç­‰ã€‚</p><p>è¿™äº›éƒ½æ˜¯ç³»ç»Ÿä¼˜åŒ–çš„åŸºçŸ³ï¼Œéœ€è¦ä½ å¥½å¥½æŒæ¡ã€‚ä½†æ˜¯ï¼Œåªæ‡‚å¾—å®ƒä»¬ï¼Œè¿˜æ˜¯ä¸è¶³ä»¥é¢å¯¹çœŸå®çš„ä¸šåŠ¡åœºæ™¯ã€‚åœ¨ä¸€ä¸ªç¨å¾®å¤æ‚ä¸€äº›çš„ä¸šåŠ¡ä¸­ï¼Œä¿æŒé«˜æ€§èƒ½æ˜¯ä¸€ä¸ªç³»ç»Ÿæ€§çš„å·¥ä½œï¼Œå¹¶ä¸ä»…ä»…æ˜¯ä»£ç å’Œç½‘å…³å±‚é¢çš„ä¼˜åŒ–ã€‚å®ƒä¼šæ¶‰åŠåˆ°æ•°æ®åº“ã€ç½‘ç»œã€åè®®ã€ç¼“å­˜ã€ç£ç›˜ç­‰å„ä¸ªæ–¹é¢ï¼Œè¿™ä¹Ÿæ­£æ˜¯æ¶æ„å¸ˆå­˜åœ¨çš„æ„ä¹‰ã€‚</p><p>ä»Šå¤©è¿™èŠ‚è¯¾ï¼Œå°±è®©æˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸‹ï¼Œæ€§èƒ½ä¼˜åŒ–ä¸­æ‰®æ¼”éå¸¸å…³é”®è§’è‰²çš„ç»„ä»¶â€”â€”ç¼“å­˜ï¼Œçœ‹çœ‹å®ƒåœ¨ OpenResty ä¸­æ˜¯å¦‚ä½•ä½¿ç”¨å’Œè¿›è¡Œä¼˜åŒ–çš„ã€‚</p><h2>ç¼“å­˜</h2><p>åœ¨ç¡¬ä»¶å±‚é¢ï¼Œå¤§éƒ¨åˆ†çš„è®¡ç®—æœºç¡¬ä»¶éƒ½ä¼šç”¨ç¼“å­˜æ¥æé«˜é€Ÿåº¦ï¼Œæ¯”å¦‚ CPU ä¼šæœ‰å¤šçº§ç¼“å­˜ï¼ŒRAID å¡ä¹Ÿæœ‰è¯»å†™ç¼“å­˜ã€‚è€Œåœ¨è½¯ä»¶å±‚é¢ï¼Œæˆ‘ä»¬ç”¨çš„æ•°æ®åº“å°±æ˜¯ä¸€ä¸ªç¼“å­˜è®¾è®¡éå¸¸å¥½çš„ä¾‹å­ã€‚åœ¨ SQL è¯­å¥çš„ä¼˜åŒ–ã€ç´¢å¼•è®¾è®¡ä»¥åŠç£ç›˜è¯»å†™çš„å„ä¸ªåœ°æ–¹ï¼Œéƒ½æœ‰ç¼“å­˜ã€‚</p><p>è¿™é‡Œï¼Œæˆ‘ä¹Ÿå»ºè®®ä½ åœ¨è®¾è®¡è‡ªå·±çš„ç¼“å­˜ä¹‹å‰ï¼Œå…ˆå»äº†è§£ä¸‹ MySQL é‡Œé¢çš„å„ç§ç¼“å­˜æœºåˆ¶ã€‚æˆ‘ç»™ä½ æ¨èçš„èµ„æ–™æ˜¯ã€ŠHigh Performance MySQLã€‹ è¿™æœ¬éå¸¸æ£’çš„ä¹¦ã€‚æˆ‘åœ¨å¤šå¹´å‰è´Ÿè´£æ•°æ®åº“çš„æ—¶å€™ï¼Œä»è¿™æœ¬ä¹¦ä¸­è·ç›Šè‰¯å¤šï¼Œè€Œä¸”åæ¥ä¸å°‘å…¶ä»–çš„ä¼˜åŒ–åœºæ™¯ï¼Œä¹Ÿå€Ÿé‰´äº† MySQL çš„è®¾è®¡ã€‚</p><!-- [[[read_end]]] --><p>å›åˆ°ç¼“å­˜ä¸Šæ¥è¯´ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œä¸€ä¸ªç”Ÿäº§ç¯å¢ƒçš„ç¼“å­˜ç³»ç»Ÿï¼Œéœ€è¦æ ¹æ®è‡ªå·±çš„ä¸šåŠ¡åœºæ™¯å’Œç³»ç»Ÿç“¶é¢ˆï¼Œæ¥æ‰¾å‡ºæœ€å¥½çš„æ–¹æ¡ˆã€‚è¿™æ˜¯ä¸€é—¨å¹³è¡¡çš„è‰ºæœ¯ã€‚</p><p>ä¸€èˆ¬æ¥è¯´ï¼Œç¼“å­˜æœ‰ä¸¤ä¸ªåŸåˆ™ã€‚</p><ul>\n<li>ä¸€æ˜¯è¶Šé è¿‘ç”¨æˆ·çš„è¯·æ±‚è¶Šå¥½ã€‚æ¯”å¦‚ï¼Œèƒ½ç”¨æœ¬åœ°ç¼“å­˜çš„å°±ä¸è¦å‘é€ HTTP è¯·æ±‚ï¼Œèƒ½ç”¨ CDN ç¼“å­˜çš„å°±ä¸è¦æ‰“åˆ°æºç«™ï¼Œèƒ½ç”¨ OpenResty ç¼“å­˜çš„å°±ä¸è¦æ‰“åˆ°æ•°æ®åº“ã€‚</li>\n<li>äºŒæ˜¯å°½é‡ä½¿ç”¨æœ¬è¿›ç¨‹å’Œæœ¬æœºçš„ç¼“å­˜è§£å†³ã€‚å› ä¸ºè·¨äº†è¿›ç¨‹å’Œæœºå™¨ç”šè‡³æœºæˆ¿ï¼Œç¼“å­˜çš„ç½‘ç»œå¼€é”€å°±ä¼šéå¸¸å¤§ï¼Œè¿™ä¸€ç‚¹åœ¨é«˜å¹¶å‘çš„æ—¶å€™ä¼šéå¸¸æ˜æ˜¾ã€‚</li>\n</ul><p>è‡ªç„¶ï¼Œåœ¨OpenResty ä¸­ï¼Œç¼“å­˜çš„è®¾è®¡å’Œä½¿ç”¨ä¹Ÿéµå¾ªè¿™ä¸¤ä¸ªåŸåˆ™ã€‚OpenResty ä¸­æœ‰ä¸¤ä¸ªç¼“å­˜çš„ç»„ä»¶ï¼šshared dict ç¼“å­˜å’Œ lru ç¼“å­˜ã€‚å‰è€…åªèƒ½ç¼“å­˜å­—ç¬¦ä¸²å¯¹è±¡ï¼Œç¼“å­˜çš„æ•°æ®æœ‰ä¸”åªæœ‰ä¸€ä»½ï¼Œæ¯ä¸€ä¸ª worker éƒ½å¯ä»¥è¿›è¡Œè®¿é—®ï¼Œæ‰€ä»¥å¸¸ç”¨äº worker ä¹‹é—´çš„æ•°æ®é€šä¿¡ã€‚åè€…åˆ™å¯ä»¥ç¼“å­˜æ‰€æœ‰çš„ Lua å¯¹è±¡ï¼Œä½†åªèƒ½åœ¨å•ä¸ª worker è¿›ç¨‹å†…è®¿é—®ï¼Œæœ‰å¤šå°‘ä¸ª workerï¼Œå°±ä¼šæœ‰å¤šå°‘ä»½ç¼“å­˜æ•°æ®ã€‚</p><p>ä¸‹é¢è¿™ä¸¤ä¸ªç®€å•çš„è¡¨æ ¼ï¼Œå¯ä»¥è¯´æ˜ shared dict å’Œ lru ç¼“å­˜çš„åŒºåˆ«ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/ba/cd/baa08571c1ca48585d14a6141e2f00cd.png?wh=973*174\" alt=\"\"><br>\n<img src=\"https://static001.geekbang.org/resource/image/c3/a9/c3f7415b4cb793a556f27b08da370ca9.png?wh=973*174\" alt=\"\"><br>\nshared dict å’Œ lru ç¼“å­˜ï¼Œå¹¶æ²¡æœ‰å“ªä¸€ä¸ªæ›´å¥½çš„è¯´æ³•ï¼Œè€Œæ˜¯åº”è¯¥æ ¹æ®ä½ çš„åœºæ™¯æ¥é…åˆä½¿ç”¨ã€‚</p><ul>\n<li>å¦‚æœä½ æ²¡æœ‰ worker ä¹‹é—´å…±äº«æ•°æ®çš„éœ€æ±‚ï¼Œé‚£ä¹ˆlru å¯ä»¥ç¼“å­˜æ•°ç»„ã€å‡½æ•°ç­‰å¤æ‚çš„æ•°æ®ç±»å‹ï¼Œå¹¶ä¸”æ€§èƒ½æœ€é«˜ï¼Œè‡ªç„¶æ˜¯é¦–é€‰ã€‚</li>\n<li>ä½†å¦‚æœä½ éœ€è¦åœ¨ worker ä¹‹é—´å…±äº«æ•°æ®ï¼Œé‚£å°±å¯ä»¥åœ¨ lru ç¼“å­˜çš„åŸºç¡€ä¸Šï¼ŒåŠ ä¸Š shared dict çš„ç¼“å­˜ï¼Œæ„æˆä¸¤çº§ç¼“å­˜çš„æ¶æ„ã€‚</li>\n</ul><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å…·ä½“æ¥çœ‹çœ‹è¿™ä¸¤ç§ç¼“å­˜æ–¹å¼ã€‚</p><h2>å…±äº«å­—å…¸ç¼“å­˜</h2><p>åœ¨ Lua ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬å·²ç»å¯¹ shared dict åšäº†å…·ä½“çš„ä»‹ç»ï¼Œè¿™é‡Œå…ˆç®€å•å›é¡¾ä¸‹å®ƒçš„ä½¿ç”¨æ–¹æ³•ï¼š</p><pre><code>$ resty --shdict='dogs 1m' -e 'local dict = ngx.shared.dogs\n                               dict:set(&quot;Tom&quot;, 56)\n                               print(dict:get(&quot;Tom&quot;))'\n</code></pre><p>ä½ éœ€è¦äº‹å…ˆåœ¨ Nginx çš„é…ç½®æ–‡ä»¶ä¸­ï¼Œå£°æ˜ä¸€ä¸ªå†…å­˜åŒº dogsï¼Œç„¶ååœ¨ Lua ä»£ç ä¸­æ‰å¯ä»¥ä½¿ç”¨ã€‚å¦‚æœä½ åœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç°ç»™ dogs åˆ†é…çš„ç©ºé—´ä¸å¤Ÿç”¨ï¼Œé‚£ä¹ˆæ˜¯éœ€è¦å…ˆä¿®æ”¹ Nginx é…ç½®æ–‡ä»¶ï¼Œç„¶åé‡æ–°åŠ è½½ Nginx æ‰èƒ½ç”Ÿæ•ˆçš„ã€‚å› ä¸ºæˆ‘ä»¬å¹¶ä¸èƒ½åœ¨è¿è¡Œæ—¶è¿›è¡Œæ‰©å®¹å’Œç¼©å®¹ã€‚</p><p>ä¸‹é¢ï¼Œæˆ‘ä»¬é‡ç‚¹èŠä¸‹ï¼Œåœ¨å…±äº«å­—å…¸ç¼“å­˜ä¸­ï¼Œå’Œæ€§èƒ½ç›¸å…³çš„å‡ ä¸ªé—®é¢˜ã€‚</p><h3>ç¼“å­˜æ•°æ®çš„åºåˆ—åŒ–</h3><p>ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œç¼“å­˜æ•°æ®çš„åºåˆ—åŒ–ã€‚ç”±äºå…±äº«å­—å…¸ä¸­åªèƒ½ç¼“å­˜å­—ç¬¦ä¸²å¯¹è±¡ï¼Œæ‰€ä»¥ï¼Œå¦‚æœä½ æƒ³è¦ç¼“å­˜æ•°ç»„ï¼Œå°±å°‘ä¸äº†è¦åœ¨ set çš„æ—¶å€™è¦åšä¸€æ¬¡åºåˆ—åŒ–ï¼Œåœ¨ get çš„æ—¶å€™åšä¸€æ¬¡ååºåˆ—åŒ–ï¼š</p><pre><code>resty --shdict='dogs 1m' -e 'local dict = ngx.shared.dogs\n                        dict:set(&quot;Tom&quot;, require(&quot;cjson&quot;).encode({a=111}))\n                        print(require(&quot;cjson&quot;).decode(dict:get(&quot;Tom&quot;)).a)'\n</code></pre><p>ä¸è¿‡ï¼Œè¿™ç±»åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ“ä½œæ˜¯éå¸¸æ¶ˆè€— CPU èµ„æºçš„ã€‚å¦‚æœæ¯ä¸ªè¯·æ±‚éƒ½æœ‰é‚£ä¹ˆå‡ æ¬¡è¿™ç§æ“ä½œï¼Œé‚£ä¹ˆï¼Œåœ¨ç«ç„°å›¾ä¸Šä½ å°±èƒ½å¾ˆæ˜æ˜¾åœ°çœ‹åˆ°å®ƒä»¬çš„æ¶ˆè€—ã€‚</p><p>æ‰€ä»¥ï¼Œå¦‚ä½•åœ¨å…±äº«å­—å…¸é‡Œé¿å…è¿™ç§æ¶ˆè€—å‘¢ï¼Ÿå…¶å®è¿™é‡Œå¹¶æ²¡æœ‰ä»€ä¹ˆå¥½çš„åŠæ³•ï¼Œè¦ä¹ˆåœ¨ä¸šåŠ¡å±‚é¢é¿å…æŠŠæ•°ç»„æ”¾åˆ°å…±äº«å­—å…¸é‡Œé¢ï¼›è¦ä¹ˆè‡ªå·±å»æ‰‹å·¥æ‹¼æ¥å­—ç¬¦ä¸²ä¸ºJSON æ ¼å¼ï¼Œå½“ç„¶ï¼Œè¿™ä¹Ÿä¼šå¸¦æ¥å­—ç¬¦ä¸²æ‹¼æ¥çš„æ€§èƒ½æ¶ˆè€—ï¼Œä»¥åŠå¯èƒ½ä¼šéšè—æ›´å¤šçš„ bug åœ¨å…¶ä¸­ã€‚</p><p>å¤§éƒ¨åˆ†çš„åºåˆ—åŒ–éƒ½æ˜¯å¯ä»¥åœ¨ä¸šåŠ¡å±‚é¢è¿›è¡Œæ‹†è§£çš„ã€‚ä½ å¯ä»¥æŠŠæ•°ç»„çš„å†…å®¹æ‰“æ•£ï¼Œåˆ†åˆ«ç”¨å­—ç¬¦ä¸²çš„å½¢å¼å­˜å‚¨åœ¨å…±äº«å­—å…¸ä¸­ã€‚å¦‚æœè¿˜ä¸è¡Œçš„è¯ï¼Œé‚£ä¹ˆä¹Ÿå¯ä»¥æŠŠæ•°ç»„ç¼“å­˜åœ¨ lru ä¸­ï¼Œç”¨å†…å­˜ç©ºé—´æ¥æ¢å–ç¨‹åºçš„ä¾¿æ·æ€§å’Œæ€§èƒ½ã€‚</p><p>æ­¤å¤–ï¼Œç¼“å­˜ä¸­çš„ key ä¹Ÿåº”è¯¥å°½é‡é€‰æ‹©çŸ­å’Œæœ‰æ„ä¹‰çš„ï¼Œè¿™æ ·ä¸ä»…å¯ä»¥èŠ‚çœç©ºé—´ï¼Œä¹Ÿæ–¹ä¾¿åç»­çš„è°ƒè¯•ã€‚</p><h3>stale æ•°æ®</h3><p>å…±äº«å­—å…¸ä¸­è¿˜æœ‰ä¸€ä¸ª <code>get_stale</code> çš„è¯»å–æ•°æ®çš„æ–¹æ³•ï¼Œç›¸æ¯” <code>get</code> æ–¹æ³•ï¼Œå¤šäº†ä¸€ä¸ªè¿‡æœŸæ•°æ®çš„è¿”å›å€¼ï¼š</p><pre><code>resty --shdict='dogs 1m' -e 'local dict = ngx.shared.dogs\n                            dict:set(&quot;Tom&quot;, 56, 0.01)\n                            ngx.sleep(0.02)\n                             local val, flags, stale = dict:get_stale(&quot;Tom&quot;)\n                            print(val)'\n</code></pre><p>åœ¨ä¸Šé¢çš„è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæ•°æ®åªåœ¨å…±äº«å­—å…¸ä¸­ç¼“å­˜äº† 0.01 ç§’ï¼Œåœ¨ set åçš„ 0.02 ç§’åï¼Œæ•°æ®å°±å·²ç»è¶…æ—¶äº†ã€‚è¿™æ—¶å€™ï¼Œé€šè¿‡ get æ¥å£å°±ä¸ä¼šè·å–åˆ°æ•°æ®äº†ï¼Œä½†é€šè¿‡ <code>get_stale</code> è¿˜å¯èƒ½è·å–åˆ°è¿‡æœŸçš„æ•°æ®ã€‚è¿™é‡Œæˆ‘ä¹‹æ‰€ä»¥ç”¨â€œå¯èƒ½â€ä¸¤ä¸ªå­—ï¼Œæ˜¯å› ä¸ºè¿‡æœŸæ•°æ®æ‰€å ç”¨çš„ç©ºé—´ï¼Œæ˜¯æœ‰ä¸€å®šå‡ ç‡è¢«å›æ”¶ï¼Œå†ç»™å…¶ä»–æ•°æ®ä½¿ç”¨çš„ï¼Œè¿™ä¹Ÿå°±æ˜¯ LRU ç®—æ³•ã€‚</p><p>çœ‹åˆ°è¿™é‡Œï¼Œä½ å¯èƒ½ä¼šæœ‰ç–‘æƒ‘å—ï¼šè·å–å·²ç»è¿‡æœŸçš„æ•°æ®æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿä¸è¦å¿˜è®°äº†ï¼Œæˆ‘ä»¬åœ¨ shared dict ä¸­å­˜æ”¾çš„æ˜¯ç¼“å­˜æ•°æ®ï¼Œå³ä½¿ç¼“å­˜æ•°æ®è¿‡æœŸäº†ï¼Œä¹Ÿå¹¶ä¸æ„å‘³ç€æºæ•°æ®å°±ä¸€å®šæœ‰æ›´æ–°ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œæ•°æ®æºå­˜å‚¨åœ¨ MySQL ä¸­ï¼Œæˆ‘ä»¬ä» MySQL ä¸­è·å–åˆ°æ•°æ®åï¼Œåœ¨ shared dict ä¸­è®¾ç½®äº† 5 ç§’è¶…æ—¶ï¼Œé‚£ä¹ˆï¼Œå½“è¿™ä¸ªæ•°æ®è¿‡æœŸåï¼Œæˆ‘ä»¬å°±ä¼šæœ‰ä¸¤ä¸ªé€‰æ‹©ï¼š</p><ul>\n<li>å½“è¿™ä¸ªæ•°æ®ä¸å­˜åœ¨æ—¶ï¼Œé‡æ–°å» MySQL ä¸­å†æŸ¥è¯¢ä¸€æ¬¡ï¼ŒæŠŠç»“æœæ”¾åˆ°ç¼“å­˜ä¸­ï¼›</li>\n<li>åˆ¤æ–­ MySQL çš„æ•°æ®æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–ï¼Œå¦‚æœæ²¡æœ‰å˜åŒ–ï¼Œå°±æŠŠç¼“å­˜ä¸­è¿‡æœŸçš„æ•°æ®è¯»å–å‡ºæ¥ï¼Œä¿®æ”¹å®ƒçš„è¿‡æœŸæ—¶é—´ï¼Œè®©å®ƒç»§ç»­ç”Ÿæ•ˆã€‚</li>\n</ul><p>å¾ˆæ˜æ˜¾ï¼Œåè€…æ˜¯æ›´ä¼˜åŒ–çš„æ–¹æ¡ˆï¼Œè¿™æ ·å¯ä»¥å°½å¯èƒ½å°‘åœ°å»å’Œ MySQL äº¤äº’ï¼Œè®©ç»ˆç«¯çš„è¯·æ±‚éƒ½ä»æœ€å¿«çš„ç¼“å­˜ä¸­è·å–æ•°æ®ã€‚</p><p>è¿™æ—¶å€™ï¼Œå¦‚ä½•åˆ¤æ–­æ•°æ®æºä¸­çš„æ•°æ®æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–ï¼Œå°±æˆä¸ºäº†æˆ‘ä»¬éœ€è¦è€ƒè™‘å’Œè§£å†³çš„é—®é¢˜ã€‚æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬ä»¥ lru ç¼“å­˜ä¸ºä¾‹ï¼Œçœ‹çœ‹ä¸€ä¸ªå®é™…çš„é¡¹ç›®æ˜¯å¦‚ä½•æ¥è§£å†³è¿™ä¸ªé—®é¢˜çš„ã€‚</p><h2>lru ç¼“å­˜</h2><p>lru ç¼“å­˜çš„æ¥å£åªæœ‰ 5 ä¸ªï¼š<code>new</code>ã€<code>set</code>ã€<code>get</code>ã€<code>delete</code> å’Œ <code>flush_all</code>ã€‚å’Œä¸Šé¢é—®é¢˜ç›¸å…³çš„å°±åªæœ‰ <code>get</code> æ¥å£ï¼Œè®©æˆ‘ä»¬å…ˆæ¥äº†è§£ä¸‹è¿™ä¸ªæ¥å£æ˜¯å¦‚ä½•ä½¿ç”¨çš„ï¼š</p><pre><code>resty -e 'local lrucache = require &quot;resty.lrucache&quot;\nlocal cache, err = lrucache.new(200)\ncache:set(&quot;dog&quot;, 32, 0.01)\nngx.sleep(0.02)\nlocal data, stale_data = cache:get(&quot;dog&quot;)\nprint(stale_data)'\n</code></pre><p>ä½ å¯ä»¥çœ‹åˆ°ï¼Œåœ¨lru ç¼“å­˜ä¸­ï¼Œ get æ¥å£çš„ç¬¬äºŒä¸ªè¿”å›å€¼ç›´æ¥å°±æ˜¯ <code>stale_data</code>ï¼Œè€Œä¸æ˜¯åƒ shared dict é‚£æ ·åˆ†ä¸ºäº† <code>get</code> å’Œ <code>get_stale</code> ä¸¤ä¸ªä¸åŒçš„ APIã€‚è¿™æ ·çš„æ¥å£å°è£…ï¼Œå¯¹äºä½¿ç”¨è¿‡æœŸæ•°æ®æ¥è¯´æ˜¾ç„¶æ›´åŠ å‹å¥½ã€‚</p><p>åœ¨å®é™…çš„é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬æ¨èä½¿ç”¨ç‰ˆæœ¬å·æ¥åŒºåˆ†ä¸åŒçš„æ•°æ®ï¼Œè¿™æ ·ï¼Œåœ¨æ•°æ®å‘å£°å˜åŒ–åï¼Œå®ƒçš„ç‰ˆæœ¬å·ä¹Ÿå°±è·Ÿç€å˜äº†ã€‚æ¯”å¦‚ï¼Œåœ¨ etcd ä¸­çš„ <code>modifiedIndex</code> ï¼Œå°±å¯ä»¥æ‹¿æ¥å½“ä½œç‰ˆæœ¬å·ï¼Œæ¥æ ‡è®°æ•°æ®æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–ã€‚æœ‰äº†ç‰ˆæœ¬å·çš„æ¦‚å¿µåï¼Œæˆ‘ä»¬å°±å¯ä»¥å¯¹ lru ç¼“å­˜åšä¸€ä¸ªç®€å•çš„äºŒæ¬¡å°è£…ï¼Œæ¯”å¦‚æ¥çœ‹ä¸‹é¢çš„ä¼ªç ï¼Œæ‘˜è‡ª<a href=\"https://github.com/iresty/apisix/blob/master/lua/apisix/core/lrucache.lua\">https://github.com/iresty/apisix/blob/master/lua/apisix/core/lrucache.lua</a> ï¼š</p><pre><code>local function (key, version, create_obj_fun, ...)\n    local obj, stale_obj = lru_obj:get(key)\n    -- å¦‚æœæ•°æ®æ²¡æœ‰è¿‡æœŸï¼Œå¹¶ä¸”ç‰ˆæœ¬æ²¡æœ‰å˜åŒ–ï¼Œå°±ç›´æ¥è¿”å›ç¼“å­˜æ•°æ®\n    if obj and obj._cache_ver == version then\n        return obj\n    end\n\n    -- å¦‚æœæ•°æ®å·²ç»è¿‡æœŸï¼Œä½†è¿˜èƒ½è·å–åˆ°ï¼Œå¹¶ä¸”ç‰ˆæœ¬æ²¡æœ‰å˜åŒ–ï¼Œå°±ç›´æ¥è¿”å›ç¼“å­˜ä¸­çš„è¿‡æœŸæ•°æ®\n    if stale_obj and stale_obj._cache_ver == version then\n        lru_obj:set(key, obj, item_ttl)\n        return stale_obj\n    end\n\n    -- å¦‚æœæ‰¾ä¸åˆ°è¿‡æœŸæ•°æ®ï¼Œæˆ–è€…ç‰ˆæœ¬å·æœ‰å˜åŒ–ï¼Œå°±ä»æ•°æ®æºè·å–æ•°æ®\n    local obj, err = create_obj_fun(...)\n    obj._cache_ver = version\n    lru_obj:set(key, obj, item_ttl)\n    return obj, err\nend\n</code></pre><p>ä»è¿™æ®µä»£ç ä¸­ä½ å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬é€šè¿‡å¼•å…¥ç‰ˆæœ¬å·çš„æ¦‚å¿µï¼Œåœ¨ç‰ˆæœ¬å·æ²¡æœ‰å˜åŒ–çš„æƒ…å†µä¸‹ï¼Œå……åˆ†åˆ©ç”¨äº†è¿‡æœŸæ•°æ®æ¥å‡å°‘å¯¹æ•°æ®æºçš„å‹åŠ›ï¼Œè¾¾åˆ°äº†æ€§èƒ½çš„æœ€ä¼˜ã€‚</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œåœ¨ä¸Šé¢çš„æ–¹æ¡ˆä¸­ï¼Œå…¶å®è¿˜æœ‰ä¸€ä¸ªæ½œåœ¨çš„å¾ˆå¤§ä¼˜åŒ–ç‚¹ï¼Œé‚£å°±æ˜¯æˆ‘ä»¬æŠŠ key å’Œç‰ˆæœ¬å·åšäº†åˆ†ç¦»ï¼ŒæŠŠç‰ˆæœ¬å·ä½œä¸º value çš„ä¸€ä¸ªå±æ€§ã€‚</p><p>æˆ‘ä»¬çŸ¥é“ï¼Œæ›´å¸¸è§„çš„åšæ³•æ˜¯æŠŠç‰ˆæœ¬å·å†™å…¥ key ä¸­ã€‚æ¯”å¦‚ key çš„å€¼æ˜¯ <code>key_1234</code>ï¼Œè¿™ç§åšæ³•éå¸¸æ™®éï¼Œä½†åœ¨ OpenResty çš„ç¯å¢ƒä¸‹ï¼Œè¿™æ ·å…¶å®æ˜¯å­˜åœ¨æµªè´¹çš„ã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Ÿ</p><p>ä¸¾ä¸ªä¾‹å­ä½ å°±æ˜ç™½äº†ã€‚å‡å¦‚ç‰ˆæœ¬å·æ¯åˆ†é’Ÿå˜åŒ–ä¸€æ¬¡ï¼Œé‚£ä¹ˆ<code>key_1234</code> è¿‡ä¸€åˆ†é’Ÿå°±å˜ä¸ºäº† <code>key_1235</code>ï¼Œä¸€ä¸ªå°æ—¶å°±ä¼šé‡æ–°ç”Ÿæˆ 60 ä¸ªä¸åŒçš„ keyï¼Œä»¥åŠ 60 ä¸ª valueã€‚è¿™ä¹Ÿå°±æ„å‘³ç€ï¼Œ Lua GC éœ€è¦å›æ”¶ 59 ä¸ªé”®å€¼å¯¹èƒŒåçš„ Lua å¯¹è±¡ã€‚å¦‚æœä½ çš„æ›´æ–°æ›´åŠ é¢‘ç¹ï¼Œé‚£ä¹ˆå¯¹è±¡çš„æ–°å»ºå’Œ GC æ˜¾ç„¶ä¼šæ¶ˆè€—æ›´å¤šçš„èµ„æºã€‚</p><p>å½“ç„¶ï¼Œè¿™äº›æ¶ˆè€—ä¹Ÿå¯ä»¥å¾ˆç®€å•åœ°é¿å…ï¼Œé‚£å°±æ˜¯æŠŠç‰ˆæœ¬å·ä» key æŒªåˆ° value ä¸­ã€‚è¿™æ ·ï¼Œä¸€ä¸ª key ä¸ç®¡æ›´æ–°åœ°å¤šä¹ˆé¢‘ç¹ï¼Œä¹Ÿåªæœ‰å›ºå®šçš„ä¸¤ä¸ª Lua å¯¹è±¡ã€‚å¯ä»¥çœ‹å‡ºï¼Œè¿™æ ·çš„ä¼˜åŒ–æŠ€å·§éå¸¸å·§å¦™ï¼Œä¸è¿‡ï¼Œç®€å•å·§å¦™çš„æŠ€å·§èƒŒåï¼Œå…¶å®éœ€è¦ä½ å¯¹ OpenResty çš„ API ä»¥åŠç¼“å­˜çš„æœºåˆ¶éƒ½æœ‰å¾ˆæ·±å…¥çš„äº†è§£æ‰å¯ä»¥ã€‚</p><h2>å†™åœ¨æœ€å</h2><p>è¯šç„¶ï¼ŒOpenResty çš„æ–‡æ¡£æ¯”è¾ƒè¯¦ç»†ï¼Œä½†å¦‚ä½•å’Œä¸šåŠ¡ç»„åˆä»¥äº§ç”Ÿæœ€å¤§çš„ä¼˜åŒ–æ•ˆæœï¼Œå°±éœ€è¦ä½ è‡ªå·±æ¥æ¥ä½“ä¼šå’Œé¢†æ‚Ÿäº†ã€‚å¾ˆå¤šæ—¶å€™ï¼Œæ–‡æ¡£ä¸­åªæœ‰ä¸€ä¸¤å¥çš„åœ°æ–¹ï¼Œæ¯”å¦‚ stale dataè¿™æ ·çš„ï¼Œå´ä¼šäº§ç”Ÿå·¨å¤§çš„æ€§èƒ½å·®å¼‚ã€‚</p><p>é‚£ä¹ˆï¼Œä½ åœ¨ä½¿ç”¨ OpenResty çš„è¿‡ç¨‹ä¸­ï¼Œæ˜¯å¦æœ‰è¿‡ç±»ä¼¼çš„ç»å†å‘¢ï¼Ÿæ¬¢è¿ç•™è¨€å’Œæˆ‘åˆ†äº«ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™ç¯‡æ–‡ç« åˆ†äº«å‡ºå»ï¼Œæˆ‘ä»¬ä¸€èµ·å­¦ä¹ å’Œè¿›æ­¥ã€‚</p><p></p>","neighbors":{"left":{"article_title":"38 | [è§†é¢‘]å·§ç”¨wrkå’Œç«ç„°å›¾ï¼Œç§‘å­¦å®šä½æ€§èƒ½ç“¶é¢ˆ","id":105639},"right":{"article_title":"40 | ç¼“å­˜ä¸é£æš´å¹¶å­˜ï¼Œè°è¯´ç¼“å­˜é£æš´ä¸å¯é¿å…ï¼Ÿ","id":126872}},"comments":[{"had_liked":false,"id":126989,"user_name":"Shliesce","can_delete":false,"product_type":"c1","uid":1198028,"ip_address":"","ucode":"75B1DCE6989B38","user_header":"https://static001.geekbang.org/account/avatar/00/12/47/cc/04a749e1.jpg","comment_is_top":false,"comment_ctime":1566531054,"is_pvip":false,"replies":[{"id":"47623","content":"å»ºè®®çœ‹çœ‹ lua-resty-mlcacheï¼Œç­‰äºå¤šåŠ ä¸€å±‚ lru cacheã€‚mlcacheæä¾›äº† `l1_serializer`ï¼Œä¸“é—¨ç”¨äºå¤„ç† shared dict æå‡åˆ° lru cache æ—¶å€™å¯¹æ•°æ®çš„å¤„ç†ï¼Œå¯ä»¥å°½å¯èƒ½çš„å‡å°‘åºåˆ—åŒ–ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1566888583,"ip_address":"","comment_id":126989,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5861498350","product_id":100028301,"comment_content":"æ­£åœ¨å†™ä¸€ä¸ªä¸consulè”åŠ¨åŠ¨æ€æ›´æ–°upstreamçš„æ’ä»¶ï¼Œæˆ‘ä»¬ä¹‹å‰ä½¿ç”¨çš„å¾®åšupsyncæ¨¡å—åŠŸèƒ½ä¸æ˜¯å¤ªç†æƒ³ã€‚ç›®å‰æˆ‘ä¹Ÿæ˜¯æŠŠupstreamä¿¡æ¯æ”¾åœ¨shared dictä¸­çš„ï¼Œå› ä¸ºconsulè‡ªå¸¦çš„å°±æœ‰long pollingå’Œindexï¼Œæˆ‘è€ƒè™‘æŠŠindexå’Œvalueåˆ†åˆ«å­˜åœ¨ä¸¤ä¸ªshared dictä¸­ï¼Œè¿™æ ·å®šæ—¶å™¨åªä¼šé¢‘ç¹åœ°è®¿é—®indexè¿™ä¸ªshared dictï¼Œå‡å°‘å…¨å±€é”å¯¹å…¶ä»–workerçš„å½±å“ï¼Œä½†æ˜¯æˆ‘ä¼°è®¡æ€§èƒ½è¿˜è¾¾ä¸åˆ°æˆ‘ä»¬äº§çº¿é‡çº§çš„è¦æ±‚ï¼Œå°±åƒè€å¸ˆè¯´çš„æ¯æ¬¡è¯·æ±‚éƒ½è¦ååºåˆ—ä¸€æ¬¡ï¼Œåç»­å¯èƒ½ä¼šå†å¼•å…¥lru cacheã€‚ã€‚è€å¸ˆæœ‰ä»€ä¹ˆå¥½çš„å»ºè®®å—ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":464273,"discussion_content":"å»ºè®®çœ‹çœ‹ lua-resty-mlcacheï¼Œç­‰äºå¤šåŠ ä¸€å±‚ lru cacheã€‚mlcacheæä¾›äº† `l1_serializer`ï¼Œä¸“é—¨ç”¨äºå¤„ç† shared dict æå‡åˆ° lru cache æ—¶å€™å¯¹æ•°æ®çš„å¤„ç†ï¼Œå¯ä»¥å°½å¯èƒ½çš„å‡å°‘åºåˆ—åŒ–ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566888583,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":317028,"user_name":"ch3cknull","can_delete":false,"product_type":"c1","uid":2815354,"ip_address":"","ucode":"27010F7022066B","user_header":"https://static001.geekbang.org/account/avatar/00/2a/f5/7a/7351b235.jpg","comment_is_top":false,"comment_ctime":1634643520,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1634643520","product_id":100028301,"comment_content":"lruç¼“å­˜ ç¤ºä¾‹éƒ¨åˆ†çš„é“¾æ¥å¤±æ•ˆäº†ï¼Œè¿™ä¸ªé“¾æ¥å¯ç”¨<br>https:&#47;&#47;github.com&#47;apache&#47;apisix&#47;blob&#47;master&#47;apisix&#47;core&#47;lrucache.lua","like_count":0},{"had_liked":false,"id":307770,"user_name":"å°èƒ¡å­","can_delete":false,"product_type":"c1","uid":1018182,"ip_address":"","ucode":"79FEC6400D25DA","user_header":"https://static001.geekbang.org/account/avatar/00/0f/89/46/0b7828a1.jpg","comment_is_top":false,"comment_ctime":1629250946,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1629250946","product_id":100028301,"comment_content":"åˆ¤æ–­æ•°æ®æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–ï¼Œä¸‹é¢å‡½æ•°ä¸­çš„versionæ€ä¹ˆæ¥çš„å‘¢ã€‚ã€‚","like_count":0,"discussions":[{"author":{"id":1626709,"avatar":"https://static001.geekbang.org/account/avatar/00/18/d2/55/4aa406a3.jpg","nickname":"æ™®æ‹‰é»˜","note":"","ucode":"827FC5E4915C83","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":545471,"discussion_content":"å¤šå‘€ï¼Œversionæ€ä¹ˆæ¥çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641970853,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":282513,"user_name":"Cobol","can_delete":false,"product_type":"c1","uid":1081059,"ip_address":"","ucode":"A885F09D313A26","user_header":"https://static001.geekbang.org/account/avatar/00/10/7e/e3/e87db3c0.jpg","comment_is_top":false,"comment_ctime":1615286423,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1615286423","product_id":100028301,"comment_content":"é‡‡ç”¨ Kong çš„ Proxy-Cache å»ç¼“å­˜å¤§æ–‡ä»¶(&gt;80M)çš„æ—¶å€™ï¼Œwget çš„é€Ÿåº¦æ¯”ç›´æ¥ä¸‹è½½è¿˜æ…¢ï¼Œåº”è¯¥æ˜¯ä¸ cjson çš„ååºåˆ—åŒ–æœ‰å…³ã€‚å¦‚æœè¦è°ƒä¼˜ï¼Œæ˜¯è¦è°ƒæ•´å…±äº«å†…å­˜å¤§å°å—ï¼Ÿ","like_count":0},{"had_liked":false,"id":225776,"user_name":"å«æ™ºé›„","can_delete":false,"product_type":"c1","uid":1358530,"ip_address":"","ucode":"A837A52142FE8E","user_header":"https://static001.geekbang.org/account/avatar/00/14/ba/c2/50e24e09.jpg","comment_is_top":false,"comment_ctime":1591853123,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1591853123","product_id":100028301,"comment_content":"å—¨~ï¼Œè¯·æ•™ä¸€ä¸‹ï¼Œ æˆ‘ä½¿ç”¨ ngx.shared.DICT.incr æ–¹æ³•, å‘ç° value ä¼šè·³å˜<br>ä¸‹é¢æ˜¯æˆ‘å¾—é…ç½®å’Œæµ‹è¯•æ–¹å¼<br>```<br>lua_shared_dict counter_ip_dict 100m;<br><br>server {<br>    listen 80;<br>    server_name test.com;<br><br>    access_by_lua_block {<br>        local ngx_var = ngx.var<br>        local counter_ip_dict = ngx.shared.counter_ip_dict<br>        local remoteIp = ngx_var.remote_addr<br><br>        local function limitRate(limitKey, maxReqs, expTime)<br><br>            local ipCount = counter_ip_dict:get(limitKey)<br>            -- ngx.say(ipCount)<br><br>            if ipCount == nil then<br>                counter_ip_dict:add(limitKey, 1, expTime)<br>            else<br>                if ipCount &gt; maxReqs then<br>                    ngx.print(&#39;ipCount: &#39;)<br>                    ngx.say(ipCount)<br>                    ngx.exit(200)<br>                else<br>                    counter_ip_dict:incr(limitKey, 1)<br>                end<br>            end<br><br>        end<br><br>        limitRate(remoteIp, 10, 20)<br>    }<br><br>    location &#47; {<br>        root &#47;data&#47;html;<br>        index index.html;<br>    }<br><br>}<br><br>```<br>```<br>for((i=1;i&lt;12;i++));do echo &quot;-----$i----&quot; ; curl -s -w &quot;http_code: %{http_code}\\n&quot; -H &#39;Host: test.com&#39; 127.0.0.1 ; done<br>```","like_count":0},{"had_liked":false,"id":127048,"user_name":"è®¸ç«¥ç«¥","can_delete":false,"product_type":"c1","uid":1003005,"ip_address":"","ucode":"4B799C0C6BC678","user_header":"https://static001.geekbang.org/account/avatar/00/0f/4d/fd/0aa0e39f.jpg","comment_is_top":false,"comment_ctime":1566544422,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1566544422","product_id":100028301,"comment_content":"è·Ÿç€è€å¸ˆä¸€èµ·ç²¾è¿›ã€‚","like_count":0},{"had_liked":false,"id":126922,"user_name":"helloworld","can_delete":false,"product_type":"c1","uid":1105161,"ip_address":"","ucode":"1EECCA0F43E278","user_header":"https://static001.geekbang.org/account/avatar/00/10/dd/09/feca820a.jpg","comment_is_top":false,"comment_ctime":1566521882,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1566521882","product_id":100028301,"comment_content":"èµğŸ‘","like_count":0},{"had_liked":false,"id":126914,"user_name":"Rye","can_delete":false,"product_type":"c1","uid":1175100,"ip_address":"","ucode":"5BDC40ED641A6C","user_header":"https://static001.geekbang.org/account/avatar/00/11/ee/3c/a2b67971.jpg","comment_is_top":false,"comment_ctime":1566520924,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1566520924","product_id":100028301,"comment_content":"æ­£åœ¨å†™APIç½‘å…³çš„æ’ä»¶ï¼Œä¹Ÿç”¨äº†sharedictï¼Œæ„Ÿè°¢è€å¸ˆçš„æ€è·¯ã€‚sharedictå’Œlruç¡®å®æœ‰ç‚¹éš¾ä¸¤å…¨çš„æ„Ÿè§‰ã€‚","like_count":0}]}