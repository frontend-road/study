{"id":739345,"title":"29ï½œUnsafeç¼–ç¨‹ï¼ˆä¸Šï¼‰ï¼š Unsafe Rustä¸­é‚£äº›è¢«å°å°çš„èƒ½åŠ›","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯Mikeã€‚</p><p>è¿™é—¨è¯¾ç›®å‰å·²æ¥è¿‘å°¾å£°ï¼Œå‰©ä¸‹çš„ä¸¤èŠ‚è¯¾æˆ‘å‡†å¤‡è®²è®²Rustä¸­çœ‹èµ·æ¥æœ‰ç‚¹é»‘é­”æ³•çš„éƒ¨åˆ†â€”â€”Unsafe Rustã€‚è¿™ä¸€èŠ‚è¯¾æˆ‘ä»¬å…ˆæ¥èŠèŠç›¸å…³çš„æ¦‚å¿µã€‚</p><p>åœ¨å‰é¢è¯¾ç¨‹çš„å­¦ä¹ ä¸­ï¼Œä½ æœ‰æ²¡æœ‰æ„Ÿè§‰åˆ°ï¼ŒRustç¼–è¯‘å™¨å°±åƒæ˜¯ä¸€ä¸ªä¸¥å‰çš„å¤§å¸ˆå‚…ï¼Œæˆ–è€…ä¸€ä¸ªè´´å¿ƒçš„å°åŠ©æ‰‹ï¼Œåœ¨ä½ èº«è¾¹é™ªä½ ç»“å¯¹ç¼–ç¨‹ï¼Œä½ å†™ä»£ç çš„æ—¶å€™ï¼Œä»–ç›¯ç€å±å¹•ï¼Œæ—¶ä¸æ—¶æé†’ä½ ã€‚å¦‚æœæŸä¸ªæ—¶åˆ»ï¼Œè¿™ä¸ªå¤§å¸ˆå‚…æˆ–å°åŠ©æ‰‹çªç„¶ç¦»å¼€äº†ï¼Œä½ ä¼šä¸ä¼šæ…Œï¼Ÿå°±åƒåˆšæè½¦ï¼Œç¬¬ä¸€æ¬¡ç‹¬è‡ªä¸Šè·¯çš„é‚£ç§æ„Ÿè§‰ã€‚</p><h2>ä¸‰ä¸ªç‹å›½</h2><p>Unsafe Rust å°±æ˜¯è¿™æ ·ä¸€ä¸ªé¢†åŸŸï¼Œè¿›å…¥è¿™ä¸ªé¢†åŸŸï¼Œä½ çªç„¶æ‹¥æœ‰äº†å‡ ç§å¿…æ€æŠ€èƒ½ï¼Œä½†æ˜¯èº«è¾¹å·²ç»æ²¡æœ‰å¤§å¸ˆå‚…åŒè¡Œäº†ï¼Œåªèƒ½é ä½ è‡ªå·±å®Œå…¨æ§åˆ¶è¿™å‡ ç§æŠ€èƒ½çš„ä½¿ç”¨ã€‚ä½¿ç”¨å¾—å¥½ï¼Œå¨åŠ›æ— ç©·ã€‚ä½¿ç”¨ä¸å¥½ï¼Œå¯¹è‡ªå·±ä¹Ÿä¼šé€ æˆå·¨å¤§ä¼¤å®³ã€‚Unsafe Rustå°±æ˜¯è¿™æ ·ä¸€ä¸ªç›¸å¯¹ç‹¬ç«‹çš„é¢†åŸŸã€‚å‰é¢æˆ‘ä»¬è®²åˆ°è¿‡ï¼ŒAsync Rustä¹Ÿæ˜¯ç›¸å¯¹ç‹¬ç«‹çš„ä¸€ä¸ªé™„å±ç‹å›½ï¼Œç°åœ¨åˆå¤šäº†ä¸€ä¸ªUnsafe Rustè¿™æ ·çš„é™„å±ç‹å›½ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/f7/88/f71d96faf019a6e0dc3f4291cf251f88.jpg?wh=1003x683\" alt=\"å›¾ç‰‡\"></p><p>Rustè¯­è¨€å¯ä»¥çœ‹ä½œæ˜¯è¿™ä¸‰å—ç–†åŸŸçš„åˆä½“ï¼Œå®ƒä»¬å…±åŒç»„æˆäº†ä¸€ä¸ªè”ç›ŸRustç‹å›½ã€‚ä½ ç”šè‡³å¯ä»¥æŠŠRustè¯­è¨€çœ‹æˆåŒ…å«ä¸Šé¢ä¸‰ç§ç¼–ç¨‹è¯­è¨€çš„ä¸€ç§æ··åˆè¯­è¨€ã€‚æ‰€ä»¥å¾ˆå¤šäººæŠ±æ€¨Rustéš¾å­¦ï¼Œä¹Ÿæ˜¯å¯ä»¥ç†è§£çš„ã€‚</p><p>ç°åœ¨è®©æˆ‘ä»¬æŠŠæ³¨æ„åŠ›é›†ä¸­åœ¨Unsafe Rustè¿™ä¸ªç‹å›½é‡Œé¢ã€‚å®ƒåˆ°åº•æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿç®€å•åœ°è¯´ï¼Œä½ å¯ä»¥æŠŠå®ƒç†è§£æˆè¿™ä¸ªç‹å›½é‡Œé¢ä½ç€ä¸€ä¸ªCè¯­è¨€æ—çš„å›½ç‹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒCè¯­è¨€èƒ½åšçš„äº‹æƒ…ï¼ŒUnsafe Rustéƒ½èƒ½åšã€‚Cè¯­è¨€èƒ½åšå“ªäº›äº‹æƒ…å‘¢ï¼Ÿç†è®ºä¸Šæ¥è¯´ï¼Œå®ƒèƒ½åšè®¡ç®—æœºä¸­çš„ä»»ä½•äº‹æƒ…ã€‚å› æ­¤ï¼Œåœ¨Unsafe Rustä¸­ï¼Œä½ ä¹Ÿèƒ½åšè®¡ç®—æœºä¸­çš„ä»»ä½•äº‹æƒ…ã€‚Cçš„å¼ºå¤§å¨åŠ›æ¥æºäºå®ƒé”‹åˆ©çš„æŒ‡é’ˆï¼Œè€Œåœ¨Unsafe Rustä¸­ä¹Ÿæä¾›äº†è¿™ç§èƒ½åŠ›ã€‚</p><!-- [[[read_end]]] --><h2>è¢«å°å°çš„èƒ½åŠ›</h2><p>Safe Rustç‹å›½æœ‰äº›æŠ€èƒ½è¢«å°å°äº†ï¼Œè€Œè¿™äº›æŠ€èƒ½è¿›å…¥åˆ°Unsafe Rustç‹å›½åï¼Œå°±å¯ä»¥è¢«æ­å¼€ä½¿ç”¨ã€‚å…·ä½“æ¥è¯´ï¼Œæœ‰5ç§æŠ€èƒ½ã€‚</p><ol>\n<li>è§£å¼•ç”¨åŸå§‹æŒ‡é’ˆ</li>\n<li>è°ƒç”¨unsafeå‡½æ•°æˆ–æ–¹æ³•</li>\n<li>è®¿é—®æˆ–ä¿®æ”¹å¯å˜çš„é™æ€å˜é‡</li>\n<li>å®ç°ä¸€ä¸ªunsafe trait</li>\n<li>è®¿é—® union ä¸­çš„å­—æ®µ</li>\n</ol><p>è¿™é‡Œæˆ‘ä»¬ç®€å•æä¸€ä¸‹è¿™5ä¸ªæ–¹é¢ï¼Œæˆ‘ä»¬ä»ç¬¬5ç‚¹è®²èµ·ã€‚unionæˆ‘ä»¬åœ¨è¯¾ç¨‹é‡Œæ²¡æœ‰è®²ï¼Œè¿™é‡Œæˆ‘ä»¬ç®€å•äº†è§£ä¸‹ã€‚å®ƒæ˜¯ä¸€ä¸ªç±»ä¼¼äºCä¸­unionçš„è®¾è®¡ï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰å­—æ®µå…±åŒå æœ‰åŒä¸€å—å­˜å‚¨ç©ºé—´ã€‚è®¿é—®å®ƒçš„å­—æ®µæ—¶ï¼Œéœ€è¦åœ¨ Unsafe Rust ä¸­ä½¿ç”¨ã€‚</p><pre><code class=\"language-plain\">union IntOrFloat {\n    i: u32,\n    f: f32,\n}\nlet mut u = IntOrFloat { f: 1.0 };\n// è¯»å–unionå­—æ®µæ—¶éœ€è¦ç”¨ unsafe {} åŒ…èµ·æ¥ \nassert_eq!(unsafe { u.i }, 1065353216);\n// æ›´æ–°äº†iï¼Œç»“æœfå­—æ®µçš„å€¼ä¹Ÿå˜åŒ–äº†ã€‚\nu.i = 1073741824;\nassert_eq!(unsafe { u.f }, 2.0);\n</code></pre><p>æˆ‘ä»¬ä¸€èˆ¬ç”¨ä¸åˆ° unionï¼Œå¦‚æœéœ€è¦æ·±å…¥ç ”ç©¶ï¼Œå¯ä»¥æŸ¥çœ‹æˆ‘ç»™å‡ºçš„<a href=\"https://doc.rust-lang.org/std/keyword.union.html\">é“¾æ¥</a>ã€‚</p><p>ç¬¬4ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥ç»™ trait å®ç° unsafeï¼Œè¿™å—å†…å®¹æ¯”è¾ƒæ·±ï¼Œæ‰€ä»¥åœ¨æˆ‘ä»¬è¿™é—¨åˆçº§è¯¾ç¨‹é‡Œä¸è¦æ±‚äº†è§£ï¼Œå¦‚æœä½ æœ‰å…´è¶£å¯ä»¥æŸ¥çœ‹æˆ‘ç»™å‡ºçš„<a href=\"https://doc.rust-lang.org/nomicon/safe-unsafe-meaning.html\">é“¾æ¥</a>ã€‚</p><p>ç¬¬3ç‚¹ä¹Ÿå°±æ˜¯å…¨å±€é™æ€å˜é‡ï¼Œå‰é¢æˆ‘ä¸æå€¡ä¿®æ”¹å®ƒï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ç§ä¸å¤ªå¥½çš„ç¼–ç¨‹æ¨¡å‹ã€‚ä½†æ˜¯å¦‚æœä½ éè¦æ”¹çš„è¯ï¼Œä¹Ÿæ˜¯æœ‰åŠæ³•çš„ï¼Œé‚£å°±ç•™ä¸‹è¶³è¿¹ï¼ŒåŠ ä¸ª <code>unsafe {}</code> å¥—èµ·æ¥ï¼Œæ¯”å¦‚ the book é‡Œçš„<a href=\"https://doc.rust-lang.org/book/ch19-01-unsafe-rust.html#accessing-or-modifying-a-mutable-static-variable\">ç¤ºä¾‹</a>ã€‚</p><pre><code class=\"language-plain\">// è¿™é‡Œä¿®é¥°ä¸º mut\nstatic mut COUNTER: u32 = 0;\nfn add_to_count(inc: u32) {\n    // ä¿®æ”¹å…¨å±€å¯å˜é™æ€å˜é‡éœ€è¦ç”¨ unsafe\n    unsafe {\n        COUNTER += inc;\n    }\n}\nfn main() {\n    add_to_count(3);\n    // è®¿é—®å…¨å±€å¯å˜é™æ€å˜é‡ä¹Ÿéœ€è¦ç”¨ unsafe\n    unsafe {\n        println!(\"COUNTER: {}\", COUNTER);\n    }\n}\n// è¾“å‡º \nCOUNTER: 3\n</code></pre><p>ä¸‹é¢æˆ‘æ¥é‡ç‚¹è®²è§£ä¸€ä¸‹å‰2ç§åœºæ™¯ã€‚</p><h3>unsafeå…³é”®å­—</h3><p>Rustä¸­æœ‰ä¸€ä¸ª unsafe å…³é”®å­—ï¼Œç”¨æ¥æ˜¾å¼åœ°æ ‡æ˜æˆ‘ä»¬è¦è¿›å…¥ unsafe Rust çš„é¢†åœ°ã€‚unsafe å…³é”®å­—å¯ä»¥ä¿®é¥° fnã€traitï¼Œè¿˜å¯ä»¥åœ¨åé¢è·Ÿä¸€ä¸ª {} è¡¨æ˜è¿™æ˜¯ä¸€ä¸ª unsafe å—ï¼ŒæŠŠå¯èƒ½ä¸å®‰å…¨çš„é€»è¾‘åŒ…èµ·æ¥ï¼Œåƒä¸‹é¢è¿™æ ·ï¼š</p><pre><code class=\"language-plain\">unsafe {\n    //...\n}\n</code></pre><p>è¿™é‡Œï¼Œéœ€è¦è¯´æ˜ä¸€ä¸‹ï¼Œè¢« unsafe æ ‡è¯†æˆ–åŒ…èµ·æ¥çš„ä»£ç ï¼Œå¹¶ä¸æ˜¯è¯´ä¸€å®šæœ‰é—®é¢˜ã€‚å®ƒçš„å‡†ç¡®æ„æ€æ˜¯ï¼š<strong>Rustcç¼–è¯‘å™¨ä¸ä¿è¯è¢«unsafeæ ‡è¯†çš„ä»£ç æ˜¯å®‰å…¨çš„ï¼Œä½ åº”è¯¥ä¿è¯ä½ å†™çš„ä»£ç æ˜¯å®‰å…¨çš„</strong>ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œunsafe è¿™ä¸ªæ ‡è¯†ç¬¦ï¼Œåœ¨ä»£ç ä¸­ç•™ä¸‹äº†æ˜ç¡®çš„è¶³è¿¹ï¼Œå°†äº¤ç”±Rustcå…¨æƒä¿è¯å®‰å…¨çš„ä»£ç ï¼Œå’Œä¸äº¤ç”±Rustcå…¨æƒä¿è¯å®‰å…¨çš„ä»£ç ï¼Œåˆ†éš”å¼€äº†ã€‚</p><p>è¯·æ³¨æ„ä¸Šé¢è¿™å¥è¯çš„ç”¨è¯ï¼Œâ€œä¸äº¤ç”±Rustcå…¨æƒä¿è¯å®‰å…¨çš„ä»£ç éƒ¨åˆ†â€å¹¶ä¸æ˜¯è¯´Rustcç¼–è¯‘å™¨å°±å®Œå…¨ä¸æ£€æŸ¥ unsafe é‡Œçš„ä»£ç äº†ï¼Œå®é™…Rustcåªæ˜¯å¯¹ä¸Šé¢æåˆ°çš„5ç§æŠ€èƒ½ä¸åŠ æ£€æŸ¥ã€‚å¯¹äºSafe Rusté‡Œçš„å†…å®¹è¿˜æ˜¯è¦åšæ£€æŸ¥ï¼Œè·Ÿä¹‹å‰ä¸€æ ·ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªç¤ºä¾‹ã€‚</p><pre><code class=\"language-plain\">fn main() {\n&nbsp; &nbsp; let v = [1,2,3];\n&nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; unsafe {\n&nbsp; &nbsp; &nbsp; &nbsp; println!(\"COUNTER: {}\", v[3]);\n&nbsp; &nbsp; }\n}\n// ç¼–è¯‘è¾“å‡º\nwarning: unnecessary `unsafe` block\n&nbsp;--&gt; src/main.rs:4:5\n&nbsp; |\n4 |&nbsp; &nbsp; &nbsp;unsafe {\n&nbsp; |&nbsp; &nbsp; &nbsp;^^^^^^ unnecessary `unsafe` block\n&nbsp; |\n&nbsp; = note: `#[warn(unused_unsafe)]` on by default\n\nerror: this operation will panic at runtime\n&nbsp;--&gt; src/main.rs:5:33\n&nbsp; |\n5 |&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;println!(\"COUNTER: {}\", v[3]);\n&nbsp; |&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^^^^ index out of bounds: the length is 3 but the index is 3\n</code></pre><p>ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦é‡ç‚¹å…³æ³¨ array çš„ä¸‹æ ‡ç´¢å¼•è¶Šç•Œçš„é—®é¢˜ã€‚æˆ‘ä»¬åœ¨<a href=\"https://time.geekbang.org/column/article/718865\">ç¬¬ 1 è®²</a>é‡Œå·²ç»è®²è¿‡ï¼Œarrayçš„ä¸‹æ ‡ç´¢å¼•è¶Šç•Œä¼šåœ¨ç¼–è¯‘æœŸè¢«æ£€æŸ¥å‡ºæ¥ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå³ä½¿æ”¾åœ¨ unsafe block ä¸­ï¼Œå®ƒä»ç„¶æ‰§è¡Œäº†æ£€æŸ¥ã€‚è¿™å°è¯äº†æˆ‘ä»¬ä¸Šé¢çš„è¯´æ³•ï¼š<strong>è¢« unsafe æ ‡è¯†çš„ä»£ç ï¼Œå¹¶ä¸æ˜¯è®©Rustcå®Œå…¨ä¸ç®¡ï¼Œè€Œåªæ˜¯æŸå‡ ç§æŠ€èƒ½è®©Rustcä¸ç®¡</strong>ã€‚Safe Rustä¸­çš„é‚£äº›å…ƒç´ ï¼ŒRustcè¯¥ç®¡çš„è¿˜æ˜¯è¦ç®¡ã€‚</p><p>æ‰€ä»¥å³ä½¿æ˜¯Unsafe Rustï¼Œçœ‹ä¸Šå»ä¹Ÿè¦æ¯”å†™ C ä»£ç æ¥å¾—â€œå®‰å…¨â€ï¼ŒçŠ¯é”™çš„é£é™©æ›´å°ä¸€äº›ã€‚å¦å¤–ç¼–è¯‘å™¨æŒ‡å‡ºè¿™é‡Œ unsafe å—æ²¡ä»€ä¹ˆç”¨ï¼Œå¯ä»¥å»æ‰ï¼Œæˆ‘ä»¬ç¡®å®æ²¡ä½¿ç”¨å®ƒã€‚</p><h3>åŸå§‹æŒ‡é’ˆ</h3><p>Rustä¸­æœ‰ä¸¤ç§åŸå§‹æŒ‡é’ˆï¼ˆraw pointerï¼‰ï¼Œ<code>*const T</code> å’Œ <code>*mut T</code>ã€‚ç”¨æ³•å¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">fn main() {\n&nbsp; &nbsp; let my_num: i32 = 10;\n&nbsp; &nbsp; let my_num_ptr: *const i32 = &amp;my_num;\n&nbsp; &nbsp; let mut my_speed: i32 = 88;\n&nbsp; &nbsp; let my_speed_ptr: *mut i32 = &amp;mut my_speed;\n&nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; unsafe {\n&nbsp; &nbsp; &nbsp; &nbsp; println!(\"my_num is: {}\", *my_num_ptr);\n&nbsp; &nbsp; &nbsp; &nbsp; println!(\"my_speed is: {}\", *my_speed_ptr);\n&nbsp; &nbsp; }\n}\n// è¾“å‡º\nmy_num is: 10\nmy_speed is: 88\n</code></pre><p>ä¹Ÿå°±æ˜¯å¯ä»¥å°†ä¸å¯å˜å¼•ç”¨ <code>&amp;T</code> è½¬æ¢æˆ <code>*const T</code> æŒ‡é’ˆã€‚å°†å¯å˜å¼•ç”¨ <code>&amp;mut T</code> è½¬æ¢æˆ <code>*mut T</code> æŒ‡é’ˆã€‚ä½ ä¹Ÿå¯ä»¥ç”¨ <a href=\"https://doc.rust-lang.org/book/ch19-01-unsafe-rust.html#dereferencing-a-raw-pointer\">as æ“ä½œç¬¦</a>æ¥è½¬æ¢ã€‚</p><p>ä¹‹å‰æˆ‘ä»¬è®²è¿‡ï¼Œå¼•ç”¨æ˜¯å¿…é¡»æœ‰æ•ˆçš„æŒ‡é’ˆï¼Œè€ŒæŒ‡é’ˆä¸ä¸€å®šæ˜¯å¼•ç”¨ï¼Œåœ¨è¿™é‡Œå°±å¾—åˆ°äº†å……åˆ†çš„ä½“ç°ã€‚åŸå§‹æŒ‡é’ˆæŒ‡å‘çš„æ•°æ®ä¸å¯¹çš„è¯ï¼Œè§£å¼•ç”¨æœ‰å¯èƒ½ä¼šå¯¼è‡´æ®µé”™è¯¯æˆ–å…¶ä»–æœªå®šä¹‰è¡Œä¸ºã€‚å› æ­¤å¼•ç”¨è½¬æ¢ä¸ºåŸå§‹æŒ‡é’ˆçš„æ—¶å€™ï¼Œä¸éœ€è¦åŒ…unsafeï¼Œè§£å¼•ç”¨åŸå§‹æŒ‡é’ˆçš„æ—¶å€™ï¼Œè¦ç”¨unsafeåŒ…èµ·æ¥ã€‚è¿™å°±æ˜¯æˆ‘ä»¬ä¸Šé¢è¯´çš„é‚£5ç§è¢«å°å°çš„èƒ½åŠ›ä¸­çš„ç¬¬ä¸€ç§èƒ½åŠ›ï¼š<strong>åœ¨ unsafe Rust ä¸­ï¼Œå¯ä»¥è§£å¼•ç”¨åŸå§‹æŒ‡é’ˆã€‚</strong></p><p>ä¸€æ—¦æ¥è§¦åˆ°äº†åŸå§‹æŒ‡é’ˆï¼Œä¹Ÿå°±å¼€å¯äº†è®¡ç®—æœºåº•å±‚ç³»ç»Ÿçš„å¤§é—¨ã€‚ä½ å¯ä»¥çœ‹æˆ‘æ”¾åœ¨è¿™é‡Œçš„ä¸¤ä¸ªé“¾æ¥ï¼Œæ„Ÿå—ä¸€ä¸‹åŸå§‹æŒ‡é’ˆçš„å¤æ‚æ€§ã€‚</p><ul>\n<li><a href=\"https://doc.rust-lang.org/std/primitive.pointer.html\">https://doc.rust-lang.org/std/primitive.pointer.html</a></li>\n<li><a href=\"https://doc.rust-lang.org/std/ptr/index.html\">https://doc.rust-lang.org/std/ptr/index.html</a></li>\n</ul><h3><code>Box&lt;T&gt;</code> è½¬æˆåŸå§‹æŒ‡é’ˆ</h3><p><code>Box&lt;T&gt;</code> æ˜¯å¸¦æ‰€æœ‰æƒçš„æ™ºèƒ½æŒ‡é’ˆï¼Œå®ƒæœ‰ä¸€ä¸ª <code>into_raw()</code> å‡½æ•°å¯ä»¥è½¬æ¢æˆåŸå§‹æŒ‡é’ˆã€‚è¿™ä¸ªè½¬æ¢å¯¹äºå†…å­˜é‡Œçš„èµ„æºæ²¡æœ‰å½±å“ã€‚ä½†æ˜¯è¦å†ä»raw pointerè½¬å›Boxå°±è¦æ”¾åœ¨ unsafe é‡ŒåŒ…èµ·æ¥ï¼Œ<code>Box::from_raw()</code> æ˜¯ unsafe çš„ã€‚</p><pre><code class=\"language-plain\">fn main() {\n&nbsp; &nbsp; let my_speed: Box&lt;i32&gt; = Box::new(88);\n&nbsp; &nbsp; let my_speed: *mut i32 = Box::into_raw(my_speed);\n\n&nbsp; &nbsp; unsafe {\n&nbsp; &nbsp; &nbsp; &nbsp; let _ = Box::from_raw(my_speed);\n&nbsp; &nbsp; }\n}\n</code></pre><p>è¿™å®é™…ä¸Šä¹Ÿæ˜¯å¯¹åŸå§‹æŒ‡é’ˆè§£å¼•ç”¨çš„ä¸€ä¸ªå˜å½¢ï¼Œæ‰€ä»¥è¦æ”¾åœ¨ unsafe å—é‡Œã€‚</p><h3>nullæŒ‡é’ˆ</h3><p>ä¹‹å‰æˆ‘ä»¬è¯´è¿‡ï¼ŒRustä¸­ä¸å­˜åœ¨null/nilå€¼ï¼Œæ‰€æœ‰çš„å˜é‡éƒ½å¿…é¡»åˆå§‹åŒ–ã€‚è¿™åœ¨Safe Rusté‡Œæ˜¯æ­£ç¡®çš„ã€‚ä½†æ˜¯åœ¨Unsafe Rustä¸­ï¼Œå´æä¾›äº†nullæŒ‡é’ˆçš„è¡¨ç¤ºã€‚</p><p>å¯ä»¥ç”¨ std::ptr é‡Œçš„ <code>null()</code> å’Œ <code>null_mut()</code> ç”Ÿæˆä¸¤ç§åŸå§‹ç©ºæŒ‡é’ˆã€‚</p><pre><code class=\"language-plain\">fn main() {\n&nbsp; &nbsp; use std::ptr;\n\n&nbsp; &nbsp; let p: *const i32 = ptr::null();\n&nbsp; &nbsp; assert!(p.is_null());\n&nbsp; &nbsp; let p: *mut i32 = ptr::null_mut();\n&nbsp; &nbsp; assert!(p.is_null());\n}\n</code></pre><p>Rustä¸­ä¸ºä»€ä¹ˆä¼šæœ‰ç©ºæŒ‡é’ˆå­˜åœ¨ï¼Ÿæœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿé‚£æ˜¯å› ä¸ºCè¯­è¨€ä¸­æœ‰ç©ºæŒ‡é’ˆè¿™ä¸ªä¸œè¥¿ã€‚ä¸ºäº†ä¸Cæ‰“äº¤é“ï¼ŒRustä¸­è¦æœ‰å¯¹åº”çš„è®¾è®¡ï¼Œå¥½ä¸Cåº“æˆ–è€…Cåº”ç”¨ç¨‹åºå¯¹æ¥ï¼Œæ¯•ç«Ÿåœ¨Rustå‡ºæ¥ä¹‹å‰ï¼ŒC/C++ å·²ç»å»ºæˆäº†è¿™ä¸ªè½¯ä»¶ä¸–ç•Œçš„åœ°åŸºã€‚</p><h3>Safeä¸Unsafeçš„è¾¹ç•Œ</h3><p>åœ¨Rustä¸­ï¼Œunsafeå‡½æ•°å¿…é¡»åœ¨ unsafe å‡½æ•°ä¸­è°ƒç”¨ï¼Œæˆ–ä½¿ç”¨ <code>unsafe {}</code> å—åŒ…èµ·æ¥è°ƒç”¨ã€‚å› æ­¤ä¸‹é¢çš„ä»£ç æ˜¯å¯ä»¥çš„ï¼š</p><pre><code class=\"language-plain\">fn foo() {\n&nbsp; &nbsp; let my_num_ptr = &amp;10 as *const i32;\n&nbsp; &nbsp; let my_speed_ptr = &amp;mut 88 as *mut i32;\n&nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; unsafe {\n&nbsp; &nbsp; &nbsp; &nbsp; println!(\"my_num is: {}\", *my_num_ptr);\n&nbsp; &nbsp; &nbsp; &nbsp; println!(\"my_speed is: {}\", *my_speed_ptr);\n&nbsp; &nbsp; }\n}\n\nfn main() {\n&nbsp; &nbsp; foo();\n}\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>foo()</code> å‡½æ•°ä¸­åŒ…å«äº† unsafe å—çš„è°ƒç”¨ã€‚ä½†æ˜¯ä» <code>main()</code> å‡½æ•°çš„è§’åº¦æ¥çœ‹ï¼Œå®ƒè°ƒç”¨ <code>foo()</code> æ—¶ä¸éœ€è¦åœ¨å¤–é¢å†å¥—ä¸€å±‚ <code>unsafe {}</code> æ¥è°ƒç”¨äº†ã€‚è¿™é‡Œå®é™…ä½“ç°äº†é‡è¦çš„ä¸€ç‚¹ï¼Œ<strong>Unsafe ä¸ Safe çš„è¾¹ç•Œ</strong>ã€‚ç¤ºä¾‹ä»£ç é‡Œä¸¤è€…çš„è¾¹ç•Œå°±åœ¨ <code>foo()</code> å‡½æ•°ä¸­ã€‚</p><p>ä» <code>main()</code> çš„è§†è§’æ¥çœ‹ï¼Œå®ƒè°ƒç”¨çš„ <code>foo()</code> æœ‰å¯èƒ½æ˜¯ç¬¬ä¸‰æ–¹åº“æš´éœ²å‡ºæ¥çš„æ¥å£ï¼Œå¹¶ä¸çŸ¥é“é‡Œé¢å…·ä½“çš„å®ç°ï¼ŒåªçŸ¥é“è¿™ä¸ªå‡½æ•°å¯ä»¥æŒ‰Safe Rustçš„å½¢å¼å®‰å…¨è°ƒç”¨ã€‚è¿™é‡Œçš„è¿™ä¸ª <code>foo()</code> å°±æ˜¯<strong>å¯¹unsafeä»£ç çš„safeå°è£…</strong>ã€‚</p><p>æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸ªå®é™…ä¸€ç‚¹çš„ä¾‹å­ã€‚</p><pre><code class=\"language-plain\">use std::slice;\nfn split_at_mut(values: &amp;mut [i32], mid: usize) -&gt; (&amp;mut [i32], &amp;mut [i32]) {\n    let len = values.len();\n    let ptr = values.as_mut_ptr();\n    assert!(mid &lt;= len);\n    unsafe {\n        (\n            slice::from_raw_parts_mut(ptr, mid),\n            slice::from_raw_parts_mut(ptr.add(mid), len - mid),\n        )\n    }\n}\nfn main() {\n    let mut vector = vec![1, 2, 3, 4, 5, 6];\n    let (left, right) = split_at_mut(&amp;mut vector, 3);\n}\n</code></pre><p>ä¸Šé¢å‡½æ•°å°†ä¸€ä¸ª i32 æ•°ç»„çš„ slice å¯å˜å¼•ç”¨åˆ†æˆäº†å‰åä¸¤æ®µsliceå¯å˜å¼•ç”¨ã€‚è¿™åœ¨ Safe Rust æ˜¯åšä¸åˆ°çš„ï¼Œå› ä¸ºåŒæ—¶å¯¹åŸæ•°ç»„å­˜åœ¨äº†ä¸¤ä¸ªå¯å˜å¼•ç”¨ï¼Œè¯¦æƒ…è¯·çœ‹<a href=\"https://doc.rust-lang.org/book/ch19-01-unsafe-rust.html#creating-a-safe-abstraction-over-unsafe-code\">å®˜æ–¹ä¹¦</a>ã€‚</p><p>åœ¨Unsafe Rustä¸­å¯ä»¥åšåˆ°ï¼Œä½†æ˜¯ <code>slice::from_raw_parts_mut()</code> åªèƒ½ç”¨ <code>unsafe {}</code> åŒ…èµ·æ¥è°ƒç”¨ã€‚è€Œå¯¹ä¸šåŠ¡å¼€å‘è€…æ¥è¯´ï¼Œåœ¨ <code>main()</code> å‡½æ•°ä¸­ä»¥Safe Rustçš„å½¢å¼ç›´æ¥ä½¿ç”¨ <code>split_at_mut()</code> å°±è¡Œäº†ï¼Œä¸€åˆ‡å°±å¥½åƒ <code>split_at_mut()</code> æ˜¯çœŸæ­£safeçš„ä¸€æ ·ã€‚åœ¨è¿™é‡Œï¼Œå®ƒç¡®å®æ˜¯safeçš„ï¼Œåªä¸è¿‡è¿™ä¸ªsafeä¸æ˜¯ç”±Rustcæ¥ä¿è¯çš„safeï¼Œè€Œæ˜¯ç”±æˆ‘ä»¬ç¨‹åºå‘˜è‡ªå·±ä¿è¯çš„safeã€‚æˆ‘ä»¬çŸ¥é“æˆ‘ä»¬åœ¨å¹²ä»€ä¹ˆï¼Œä¸¤ä¸ª slice å¹¶ä¸é‡å ï¼Œä¸ä¼šæœ‰é—®é¢˜ã€‚</p><p>å¦‚æœæ‰“ç ´ç ‚é”…é—®åˆ°åº•çš„è¯ï¼Œæ˜¯ä¸æ˜¯å‡ ä¹æ‰€æœ‰çš„Ruståº•å±‚éƒ½æœ‰è¿™ä¸ªé—®é¢˜ï¼Ÿè·Ÿè¸ªåˆ°æœ€åº•å±‚ä»£ç çš„è¯ï¼Œæ˜¯ä¸æ˜¯éƒ½æ˜¯ unsafe çš„ï¼Ÿå¦‚æœæ˜¯ï¼Œé‚£ä¹ˆRustæ‰€æ ‡æ¦œçš„ safeï¼Œå²‚ä¸æ˜¯ä¸€ä¸ªè™šå¹»çš„ç©ºä¸­æ¥¼é˜ï¼Ÿ</p><p>ä½ çš„çŒœæµ‹å¤§ä½“æ˜¯æ­£ç¡®çš„ã€‚</p><h3>æå°åŒ–Unsafeå±‚</h3><p>ä»æœ¬è´¨æ¥è¯´ï¼Œä¸–ç•Œæ˜¯å»ºç«‹åœ¨unsafeä¸Šé¢çš„ã€‚</p><p>ä»ç¡¬ä»¶æ¥è¯´ï¼Œæˆ‘ä»¬ç¼–å†™ç¨‹åºæ¥æ“ä½œå„ç§è®¾å¤‡ï¼Œå†…å­˜ã€ç¡¬ç›˜ã€æ˜¾å¡ã€ç½‘ç»œè®¾å¤‡ç­‰ç­‰ï¼Œå¯¹å®ƒä»¬çš„æ“ä½œå®Œå…¨æœ‰å¯èƒ½æ˜¯ä¸å®‰å…¨çš„ï¼Œè¿™ä¸ªé”™è¯¯å¯èƒ½æ¥è‡ªå„ç§å±‚æ¬¡ï¼Œæ¯”å¦‚ç”µæºæ³¢åŠ¨å¼•èµ·çš„æ•…éšœã€çº¿è·¯è€åŒ–æ•…éšœã€æ™¶ä½“ç®¡æŸåæ•…éšœï¼Œç”šè‡³æ˜¯å¤ªé˜³é»‘å­çˆ†å‘å¼•èµ·çš„æ•…éšœç­‰ç­‰ã€‚</p><p>ä»è½¯ä»¶æŒ‡ä»¤æ¥è¯´ï¼Œå½“ä»£ç ç¼–è¯‘æˆäºŒè¿›åˆ¶åï¼Œè¿™ä¸ªäºŒè¿›åˆ¶å¯æ‰§è¡Œåºåˆ—çš„å¨åŠ›æ˜¯æ— ç©·å¤§çš„ï¼Œç†è®ºä¸Šå¯ä»¥å¯¹è®¡ç®—æœºå†…å­˜å’Œè®¾å¤‡åœ°å€åšä»»æ„è®¿é—®ï¼Œè¿™ä¹Ÿæ˜¯hackè¡Œä¸ºçš„æºå¤´ã€‚åªè¦hackeræ‰¾åˆ°äº†ä½ ç¨‹åºä¸­çš„æ¼æ´ï¼Œå®ƒå°±å¯èƒ½åœ¨ä½ çš„è®¡ç®—æœºä¸­åšä»»ä½•å±é™©çš„äº‹æƒ…ã€‚è¿™å°±æ˜¯Cè¿™ç§é æŒ‡é’ˆåƒé¥­çš„è¯­è¨€å¼ºå¤§ä¸”å±é™©çš„åŸå› ã€‚</p><p>ä¸ç®¡æ˜¯ä»ç¡¬ä»¶å±‚é¢è¿˜æ˜¯è½¯ä»¶å±‚é¢ï¼Œä½ çš„ä¸€ä¸ªæ“ä½œå®Œå…¨å¯èƒ½ä¼šå¾—åˆ°ä¸€ä¸ªæœªçŸ¥çš„è¡Œä¸ºæˆ–æœªå®šä¹‰è¡Œä¸º <a href=\"https://doc.rust-lang.org/reference/behavior-considered-undefined.html\">Undefined Behaviour</a>ã€‚<strong>ä»Safe Rustçš„è§‚ç‚¹æ¥çœ‹ï¼Œä¸€ä¸ªä¼šäº§ç”Ÿæœªå®šä¹‰è¡Œä¸ºçš„æ“ä½œï¼Œå°±æ˜¯Unsafeçš„</strong>ã€‚è€Œunsafeçš„æ“ä½œï¼Œéƒ½å¿…é¡»æ˜ç¡®åœ°æ”¾åœ¨ <code>unsafe {}</code> å—ä¸­éš”ç¦»ã€‚</p><p>å› æ­¤ï¼Œåœ¨Safe Rustçœ‹æ¥ï¼Œå¨åŠ›è¿‡å¤§çš„æŠ€èƒ½ï¼Œæ¯”å¦‚åŸå§‹æŒ‡é’ˆçš„è§£å¼•ç”¨ï¼Œå¯èƒ½è®¿é—®åˆ°æœªåˆå§‹åŒ–çš„åœ°å€ï¼Œæˆ–è€…æ˜¯å·²ç»é‡Šæ”¾åçš„åœ°å€ï¼Œå› æ­¤å®ƒæ˜¯Unsafeçš„ï¼›å¤–éƒ¨çš„C/C++ä»£ç ï¼Œå®ƒä»¬éƒ½å¾—é ç¨‹åºå‘˜è‡ªå·±æ¥ä¿è¯å®‰å…¨æ€§ï¼Œå› æ­¤å®ƒä»¬æ˜¯ä¸å¯ä¿¡ä»»çš„ï¼ŒæŠŠå®ƒä»¬éƒ½å½’ç±»åˆ° Unsafe ä¸­ï¼›å¯¹å¤–éƒ¨è®¾å¤‡çš„æ“ä½œï¼Œå·²ç»è¶…è¿‡å†…å­˜èµ„æºçš„ç®¡ç†æƒé™äº†ï¼ŒRustè‡ªå·±é­é•¿è«åŠï¼Œå› æ­¤æŠŠå®ƒå½’ä¸ºä¸ä¿¡ä»»ï¼Œå½’ç±»åˆ° Unsafe ä¸­ã€‚</p><p>äºæ˜¯æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒRustå°†æ‰€æœ‰ä»£ç åˆ†å‰²æˆäº† Safe çš„å’Œ Unsafeçš„ä¸¤å—ï¼Œä¸¤å—ä¹‹é—´å°±é€šè¿‡æ˜ç¡®çš„ <code>unsafe {}</code> æ ‡è¯†æ¥éš”ç¦»ï¼Œè¿™æ˜¯Rustçš„åŸºæœ¬ä¸–ç•Œè§‚ã€‚</p><p>åœ¨è¿™ä¸ªä¸–ç•Œè§‚ä¹‹ä¸Šï¼ŒåŸºäºRustçš„è½¯ä»¶ä½“ç³»è¿˜æœ‰ä¸€å¥—æŠ½è±¡å“²å­¦â€”â€”å½“éœ€è¦Unsafeæ—¶ï¼Œåº”è¯¥æŠŠå®ƒå°è£…åœ¨ä¸€ä¸ªæå°å±‚ï¼ˆminimalist layerï¼‰ï¼Œç„¶ååœ¨å®ƒçš„ä¸Šé¢å»ºç«‹ä¸Šå±‚å»ºç­‘ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸å¾—ä¸ç”¨Unsafeä»£ç ï¼Œé‚£è¯·å°è£…å°½é‡è–„çš„ä¸€å±‚unsafe layerï¼Œè€Œåœ¨å…¶ä¹‹ä¸Šå®Œå…¨ä½¿ç”¨safe rustç¼–å†™ã€‚è¿™ä¸ªæ—¶å€™å°±å¯ä»¥å›ç­”è¿™ä¸ªé—®é¢˜äº†ï¼šå¦‚æœæ˜¯ï¼Œé‚£ä¹ˆRustæ‰€æ ‡æ¦œçš„ safeï¼Œå²‚ä¸æ˜¯ä¸€ä¸ªè™šå¹»çš„ç©ºä¸­æ¥¼é˜ï¼Ÿ</p><p>Rusté€šè¿‡è¿™å¥—æ–¹æ³•å­¦ï¼Œè®©Safe Rustçš„ä»£ç éƒ¨åˆ†å¯ä»¥è‡ªè¯å®‰å…¨ï¼Œè€ŒUnsafe Rustçš„ä»£ç éƒ¨åˆ†ç”±ç¨‹åºå‘˜æ¥ä¿è¯å®‰å…¨ã€‚ä½ å¯ä»¥æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœä¸€ä¸ªç³»ç»Ÿæœ‰10ä¸‡è¡ŒRustä»£ç ï¼Œ98%çš„ä»£ç æ˜¯ Safe Rustï¼Œ2%çš„ä»£ç æ˜¯ Unsafe Rustï¼Œé‚£ä¹ˆéœ€è¦ç”±äººæ¥å®¡è®¡çš„ä»£ç å°±åªæœ‰2åƒè¡Œã€‚é‚£æˆ‘ä»¬å°±å¯ä»¥æŠŠæ‰€æœ‰ç²¾åŠ›é›†ä¸­åœ¨è¿™2åƒè¡Œä»£ç çš„å®¡è®¡ä¸Šï¼Œç¡®ä¿å®ƒä»¬ä¸ä¼šå‡ºé—®é¢˜ã€‚æˆ–è€…è¯´å³ä½¿å‡ºäº†é—®é¢˜ï¼Œä¹Ÿå¯ä»¥å»è¿™2åƒè¡Œä»£ç ä¸­å»æ‰¾åŸå› ã€‚</p><p>è€Œå¦‚æœåŒæ ·çš„è¿™å¥—ç³»ç»Ÿï¼Œç”±10ä¸‡è¡ŒC/C++ä»£ç æ¥å®ç°ï¼Œé‚£ä¹ˆå®¡è®¡çš„æ—¶å€™ï¼Œå°±å¿…é¡»å®¡è®¡ 10ä¸‡è¡Œä»£ç ï¼Œä¹Ÿå°±æ˜¯ 50 å€çš„å®¡è®¡å·¥ä½œé‡ã€‚é‡åˆ°é—®é¢˜ï¼Œä¹Ÿæ˜¯åœ¨10ä¸‡è¡Œä»£ç é‡Œé¢å»æ‰¾åŸå› ã€‚è¿™ä¸ªæˆæœ¬å®Œå…¨ä¸å¯æ¯”æ‹Ÿã€‚</p><p>å› æ­¤ï¼ŒRust æ‰€æ ‡æ¦œçš„ safeï¼Œå®Œå…¨ä¸æ˜¯ç©ºä¸­æ¥¼é˜ã€‚ä¸ä»…ä¸æ˜¯ç©ºä¸­æ¥¼é˜ï¼Œè¿˜æ˜¯éå¸¸åˆ‡å®å¯è¡Œçš„ä¸€å¥—è½¯ä»¶å·¥ç¨‹æ–¹æ³•å­¦ã€‚</p><h2>æ ‡å‡†åº“ä¸­çš„unsafeç¤ºä¾‹</h2><p>Rustæ ‡å‡†åº“ä¸­æœ‰ä¸€äº›unsafeå‡½æ•°ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸¤ä¸ªã€‚</p><h3>Sliceçš„ <a href=\"https://doc.rust-lang.org/std/primitive.slice.html#method.get_unchecked\">get_unchecked()</a> å‡½æ•°</h3><pre><code class=\"language-plain\">fn main() {\n&nbsp; &nbsp; let x = &amp;[1, 2, 4];\n\n&nbsp; &nbsp; unsafe {\n&nbsp; &nbsp; &nbsp; &nbsp; assert_eq!(x.get_unchecked(1), &amp;2);\n&nbsp; &nbsp; }\n}\n</code></pre><p>åœ¨æœ‰ <code>get()</code> çš„æƒ…å†µä¸‹ï¼ŒRustæ ‡å‡†åº“è¿˜æä¾›è¿™ä¸ª <code>get_unchecked()</code> å‡½æ•°ï¼ŒåŸå› å…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œå› ä¸º<code>get()</code> ä¼šè¿›è¡Œè¾¹ç•Œæ£€æŸ¥ï¼Œè€Œ <code>get_unchecked()</code> ä¸ä¼šã€‚åœ¨æœ‰äº›å¯†é›†è¿ç®—çš„æƒ…å†µä¸‹ï¼Œè¾¹ç•Œæ£€æŸ¥å¯¹æ€§èƒ½å½±å“æ¯”è¾ƒå¤§ï¼Œå› æ­¤æä¾›ä¸€ä¸ªä¸åšè¾¹ç•Œæ£€æŸ¥çš„ç‰ˆæœ¬ï¼Œç”¨æ¥è¿½æ±‚æè‡´çš„é€Ÿåº¦ã€‚æ¯•ç«Ÿï¼ŒRustæ˜¯ä¸€é—¨ä¸C/C++åœ¨åŒä¸€å±‚æ¬¡çš„è¯­è¨€ï¼Œä¸åº”è¯¥ç»™Rustäººä¸ºå‘†æ¿åœ°è®¾ç½®éšœç¢ï¼Œæ¯”å¦‚å¿…é¡»ä½¿ç”¨è¾¹ç•Œæ£€æŸ¥çš„å®‰å…¨ç‰ˆæœ¬ã€‚</p><h3>strçš„ <a href=\"https://doc.rust-lang.org/std/str/fn.from_utf8_unchecked.html\">from_utf8_unchecked()</a> å‡½æ•°</h3><pre><code class=\"language-plain\">fn main() {\n&nbsp; &nbsp; use std::str;\n\n&nbsp; &nbsp; // some bytes, in a vector\n&nbsp; &nbsp; let sparkle_heart = vec![240, 159, 146, 150];\n\n&nbsp; &nbsp; let sparkle_heart = unsafe { str::from_utf8_unchecked(&amp;sparkle_heart) };\n\n&nbsp; &nbsp; assert_eq!(\"ğŸ’–\", sparkle_heart);\n}\n</code></pre><p>è¿™ä¸ªå‡½æ•°æˆ‘ä»¬åœ¨<a href=\"https://time.geekbang.org/column/article/720426\">ç¬¬ 4 è®²</a>èŠå­—ç¬¦ä¸²çš„æ—¶å€™æåˆ°è¿‡ï¼Œå®ƒä¸æ£€æŸ¥å­—èŠ‚åºåˆ—ä¸ºæœ‰æ•ˆçš„UTF8ç¼–ç ï¼Œå› æ­¤è½¬å‡ºæ¥å¯èƒ½ä¸æ˜¯æœ‰æ•ˆçš„å­—ç¬¦ä¸²ã€‚åŸå› ä¹Ÿå¾ˆç®€å•ï¼Œè¿˜æ˜¯ä¸ºäº†æ€§èƒ½ã€‚åœ¨æœ‰äº›åœºåˆä¸‹ï¼Œç»å¯¹çš„æ€§èƒ½å°±æ˜¯ç»å¯¹çš„ç‹é“ï¼ŒRustä¸ç»™ä½ è®¾ç½®å¤©èŠ±æ¿ã€‚</p><h2>å¤–éƒ¨å‡½æ•°æ¥å£ FFI</h2><p>è¿™é‡Œæˆ‘æå‡ºä¸€ä¸ªé—®é¢˜ï¼Œä½ æ¥æƒ³ä¸€ä¸‹ã€‚<strong>ä¸€é—¨ç¼–ç¨‹è¯­è¨€å¦‚ä½•ä¸å¦ä¸€é—¨ç¼–ç¨‹è¯­è¨€åœ¨è¯­è¨€å±‚é¢äº¤äº’å‘¢ï¼Ÿ</strong>è¿™ä¸ªé—®é¢˜è¿˜çœŸä¸å¥½åŠã€‚</p><p>äº‹å®ä¸Šï¼ŒåƒJavaScriptå°±ä¸å¤ªå¯èƒ½ç›´æ¥ä¸Pythonè¿›è¡Œäº¤äº’ã€‚å¤§éƒ¨åˆ†è¯­è¨€ä¹‹é—´æ˜¯æ²¡åŠæ³•ç›´æ¥äº¤äº’çš„ã€‚ä½†æ˜¯ï¼Œå†å²å´ç•™ä¸‹ä¸€ä¸ªæœ‰è¶£ä¸”å¯è´µçš„é—äº§â€”â€”æ‰€æœ‰ä¸»æµè¯­è¨€åŸºæœ¬éƒ½èƒ½ä¸Cè¯­è¨€äº¤äº’ï¼Œå› ä¸ºå®ƒä»¬éƒ½éœ€è¦ç”¨Cæ¥å†™æ‰©å±•ï¼Œæå‡æ€§èƒ½ã€‚å½“ç„¶ C++ æ˜¯åœ¨è¯­è¨€å±‚é¢ç›´æ¥åŒ…å«äº† Cï¼Œè¿™ä¸ªå¦å½“åˆ«è®ºã€‚</p><p>Ruståœ¨è®¾è®¡ä¹‹åˆï¼Œ<strong>ä¸Cå®ç°äºŒè¿›åˆ¶çº§çš„å…¼å®¹</strong>å°±æ˜¯ä¸€é¡¹é‡è¦ç›®æ ‡ã€‚äºŒè¿›åˆ¶å…¼å®¹çš„æ„æ€å…¶å®å°±æ˜¯Rustå¯ä»¥é€‰æ‹©ç¼–è¯‘ç›®æ ‡ä¸ºç¬¦åˆCè¯­è¨€ <a href=\"https://en.wikipedia.org/wiki/Application_binary_interface\">ABI</a>ï¼ˆApplication Binary Interfaceï¼‰çš„äºŒè¿›åˆ¶æ ¼å¼ã€‚</p><p>ABIåŒ…å«æ•°æ®ç»“æ„æ€ä¹ˆå¯¹é½ã€å­˜å‚¨ï¼Œå‡½æ•°å¦‚ä½•ä¼ å‚ã€è¿”å‚ã€è°ƒç”¨äºŒè¿›åˆ¶æ ¼å¼ä¿¡æ¯ç­‰ï¼Œè€ŒRustå°±æ”¯æŒç¼–è¯‘åˆ°éµå¾ª C ABI çš„äºŒè¿›åˆ¶åº“ç›®æ ‡ä¸Šã€‚è¿™æ„å‘³ç€ç”¨Rustç¼–å†™çš„å…±äº«åŠ¨æ€åº“ <code>.so</code>ã€<code>.dll</code> ç­‰åœ¨å¤–ç•Œçœ‹æ¥ï¼Œä¸ç”¨Cç¼–è¯‘æˆçš„ <code>.so</code>ã€<code>.dll</code> åŠ¨æ€åº“æ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œä½ ç”šè‡³ä¸çŸ¥é“æ˜¯ä»€ä¹ˆè¯­è¨€å†™æˆçš„ã€‚å› æ­¤ï¼ŒRustç¼–å†™çš„åŠ¨æ€åº“ä¹Ÿèƒ½è¢« Pythonã€JavaScriptã€Goã€Java ç­‰å…¶ä»–è¯­è¨€è°ƒç”¨ï¼Œå®ƒä»¬éƒ½æ”¯æŒC ABIåŠ¨æ€åº“ã€‚</p><p>å¦ä¸€æ–¹é¢ï¼Œ<strong>Cå®ç°çš„åŠ¨æ€åº“ä¹Ÿèƒ½è¢«Rustæ— ç¼è°ƒç”¨</strong>ï¼Œå› ä¸ºRustèƒ½è¯†åˆ«C ABIã€‚ä¸€ä¸ªCçš„åº“å‡½æ•°ï¼Œåœ¨Cåº”ç”¨ä¸­è¿è¡Œå’Œåœ¨Ruståº”ç”¨ä¸­è¿è¡Œæ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œæ€§èƒ½ä¹Ÿæ²¡æœ‰æŸå¤±ï¼Œå°±å¥½åƒæ²¡æœ‰è·¨è¯­è¨€ä¸€æ ·ï¼Œè¿™å°±æ˜¯Rustçš„é­”æ³•æ‰€åœ¨ã€‚</p><p>è¿™ç‚¹ä¸å…¶ä»–åŠ¨æ€è¯­è¨€å¦‚ Pythonã€JavaScript ç­‰å°±æœ‰å¾ˆå¤§å·®åˆ«ã€‚è¿™äº›åŠ¨æ€è¯­è¨€åˆ°Cè¯­è¨€çš„FFIè¾¹ç•Œä¼šæœ‰ä¸å°çš„é¢å¤–æ¶ˆè€—ã€‚ç©¶å…¶åŸå› ï¼Œå°±æ˜¯å› ä¸ºå…¥å‚ä¸è¿”å‚ä¼šæœ‰ç±»å‹è½¬æ¢çš„å·¥ä½œï¼Œè€Œåœ¨è¿™äº›åŠ¨æ€è¯­è¨€ä¸­ï¼Œç±»å‹æ˜¯è¢«GCæ‰˜ç®¡çš„ï¼Œè¿™é‡Œé¢å°±æœ‰å¾ˆå¤šç»†èŠ‚è¦å¤„ç†ï¼Œä¼šå¸¦æ¥é¢å¤–çš„æ¶ˆè€—ã€‚è€ŒRustå°±ä¸å­˜åœ¨è¿™ä¸ªé—®é¢˜ï¼Œå‰é¢æˆ‘ä»¬æç¤ºï¼ŒUnsafe Rusté‡Œé¢ä½ç€ä¸€ä½Cå›½ç‹ï¼Œå°±å¥½åƒä¸€å®¶äººä¸€æ ·ï¼Œæˆ–è€…è‡³å°‘æ˜¯å…³ç³»å¾ˆè¿‘çš„äº²æˆšã€‚</p><p>å°½ç®¡å¦‚æ­¤ï¼Œæœ‰å…³Rustä¸Cçš„FFIçš„çŸ¥è¯†ç‚¹è¿˜æ˜¯éå¸¸å¤šçš„ï¼Œæœ‰è®¸å¤šè¦æ³¨æ„çš„åœ°æ–¹ï¼Œä¹Ÿä¸æ˜¯ä¸€ä¸‹å­å°±èƒ½æŒæ¡çš„ï¼Œéœ€è¦åœ¨å®é™…éœ€æ±‚äº§ç”Ÿæ—¶æŠ å„ç§ç»†èŠ‚ã€‚å¦å¤–ï¼ŒRustä¸­çš„Unsafeå…¶å®è¦æ±‚ä½ è€ƒè™‘æ›´å¤šï¼Œå› ä¸ºå®ƒæ¯”ä¼ ç»Ÿçš„Cè¯­è¨€å·¥ç¨‹æ›´è¯¦å°½åœ°è€ƒè™‘äº†<a href=\"https://doc.rust-lang.org/reference/behavior-considered-undefined.html\">æœªå®šä¹‰è¡Œä¸º</a>çš„æ¦‚å¿µï¼Œå®ƒè¦æ±‚ä½ å°½å¯èƒ½åœ°è€ƒè™‘å‘¨å…¨ï¼Œ<strong>å› ä¸ºå°è£…ç»™Safe Rustçš„åŠŸèƒ½è¢«è¦æ±‚ä¸èƒ½äº§ç”Ÿä»»ä½•æœªå®šä¹‰è¡Œä¸º</strong>ã€‚æ‰€ä»¥Rustä¸ä»…æ˜¯å·¥ç¨‹ä¸Šçš„åˆ›æ–°ï¼Œåœ¨å­¦æœ¯ç†è®ºä¸Šä¹Ÿæœ‰ä¸€å®šç¨‹åº¦çš„åˆ›æ–°ï¼Œç›®æ ‡å°±æ˜¯å†™å‡ºæ›´å¥å£®çš„ä»£ç ã€‚</p><h2>å°ç»“</h2><p><img src=\"https://static001.geekbang.org/resource/image/4f/03/4fd442ed26a7f5d05bdb32c9eca7f703.jpg?wh=3429x2773\" alt=\"\"></p><p>è¿™èŠ‚è¯¾æˆ‘ä»¬äº†è§£äº†æœ‰å…³Rustä¸­Unsafeå’ŒFFIçš„åŸºç¡€æ¦‚å¿µã€‚æˆ‘ä»¬è¿›å…¥Unsafe Ruståï¼Œå°±å¯ä»¥ä½¿ç”¨ä¸€äº›å¿…æ€æŠ€èƒ½äº†ã€‚è¿™äº›æŠ€èƒ½å¨åŠ›å·¨å¤§ï¼Œä½†æ˜¯ä¹Ÿå……æ»¡é£é™©ï¼Œéœ€è¦ç”±ç¨‹åºå‘˜è‡ªå·±æ¥ä¿è¯ä½¿ç”¨ä¸Šçš„å®‰å…¨æ€§ã€‚</p><p>æˆ‘ä»¬è¯´Rustç”±ä¸‰ä¸ªç‹å›½ç»„æˆï¼Œæ—¢ç„¶æ˜¯ç‹å›½ï¼Œé‚£ä¹ˆå†…å®¹é“å®šä¸ä¼šå°‘ã€‚ä» <code>unsafe {}</code> è¿™ä¸ªå¤§é—¨è¿›å…¥Unsafe Rustï¼Œå®é™…å°±è¿›å…¥äº†è®¡ç®—æœºä½“ç³»ç»“æ„çš„åº•å±‚ï¼Œä½ ä¼šå‘ç°ä¸€ç‰‡ç¾ä¸½æ–°ä¸–ç•Œã€‚è¿™ä¸ªä¸–ç•Œä¸­æœ‰ OSã€å†…å­˜ç»“æ„ã€å¯¹é½ã€é”ã€ABIã€è°ƒåº¦ã€æŒ‡ä»¤é›†ã€æ€»çº¿åè®®ç­‰ç­‰çœ¼èŠ±ç¼­ä¹±çš„æ–°ä¸œè¥¿ã€‚æˆ‘ä»¬ä¹‹å‰æåˆ°è¿‡ä¸€ç§è§‚ç‚¹ï¼Œ<strong>å­¦ä¹ Rustå°±æ˜¯å­¦ä¹ CSè®¡ç®—æœºç§‘å­¦ï¼ŒUnsafe Rustå°±æ˜¯ä¸‹æ²‰ä¹‹é—¨</strong>ã€‚</p><p>Rustä¸Cæœ‰æ­£ç»Ÿçš„è¡€è„‰å…³ç³»ï¼Œå¯ä»¥å®ç°çœŸæ­£çš„åŒå‘äº’é€šï¼Œè€Œæ²¡æœ‰è¾¹ç•Œæ€§èƒ½æŸå¤±ã€‚è¿™é¢„ç¤ºç€æœªæ¥åœ¨åµŒå…¥å¼ã€å·¥ä¸šæ§åˆ¶ã€èˆªç©ºèˆªå¤©ã€è‡ªåŠ¨é©¾é©¶ç­‰é¢†åŸŸï¼ŒRustéƒ½æœ‰éå¸¸å¤§çš„æ½œåŠ›æˆä¸ºä¸»æµé€‰æ‰‹ã€‚ç»å¤§éƒ¨åˆ†çš„äººå†™ç†Ÿäº†Rustä»¥åå°±å†ä¹Ÿä¸æƒ³å†™Cäº†ï¼Œç¼–ç¨‹ä½“éªŒå®Œå…¨ä¸å¯åŒæ—¥è€Œè¯­ã€‚é•¿æœŸæ¥çœ‹ï¼ŒCè¯­è¨€çš„ä»½é¢ä¼šé€æ¸ç¼“æ…¢åœ°èç¼©åˆ°ä¸€ä¸ªæ¯”è¾ƒå°çš„èŒƒå›´ï¼Œè€ŒRuståˆ™ä¼šæ‹…å½“èµ·Cè¯­è¨€ä¹‹å‰çš„é‡ä»»ã€‚</p><p>æˆ‘ä»¬è¦ç†è§£Rustå°†Safeå»ºç«‹åœ¨Unsafeçš„è¿™å¥—æ–¹æ³•ä¹‹ä¸Šï¼Œè¿™ä¹Ÿæ˜¯è½¯ä»¶å·¥ä¸šç•Œå‡ åå¹´æ¢ç´¢çš„ä¸€ä¸ªé‡è¦æˆæœã€‚æ‰€ä»¥ä½ ä¼šå¬åˆ°NASAã€å¾®è½¯ç­‰æœºæ„å‘¼åæ–°çš„è½¯ä»¶å¼€å‘ä¸è¦å†ä½¿ç”¨C/C++äº†ï¼Œè€Œåº”è¯¥ç”¨â€œå®‰å…¨ç¼–ç¨‹â€çš„è¯­è¨€æ¥å–ä»£ã€‚ä»è¿™ä¸ªæ„ä¹‰ä¸Šæ¥è®²ï¼ŒRustæ˜¯åˆ’æ—¶ä»£çš„è¯­è¨€ã€‚ä»¥åçš„è¯­è¨€å¯èƒ½ä¼šè¿™ä¹ˆåˆ†ç±»ï¼šRustä¹‹åçš„è¯­è¨€ä¸Rustä¹‹å‰çš„è¯­è¨€ã€‚</p><p>ä¸‹èŠ‚è¯¾æˆ‘ä»¬ä¼šå°†Rustä»£ç å¯¼å‡ºç»™Cè¯­è¨€ä½¿ç”¨ï¼Œå¹¶ä¸”è¿›ä¸€æ­¥å¯¼å‡ºç»™Pythonä½¿ç”¨ï¼Œç»™Pythonå®ç°ä¸€ä¸ªè‡ªå®šä¹‰æ‰©å±•ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>Unsafe Rustæ¯”Cè¯­è¨€æ›´å®‰å…¨å—ï¼Œä¸ºä»€ä¹ˆï¼Ÿæ¬¢è¿ä½ æŠŠè‡ªå·±çš„æ€è€ƒåˆ†äº«åˆ°è¯„è®ºåŒºï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾çš„å†…å®¹åˆ†äº«ç»™éœ€è¦çš„æœ‹å‹ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼</p>","neighbors":{"left":{"article_title":"28ï½œNomï¼šç”¨Rustå†™ä¸€ä¸ªParserè§£æå™¨","id":738631},"right":{"article_title":"30ï½œUnsafeç¼–ç¨‹ï¼ˆä¸‹ï¼‰ï¼šä½¿ç”¨Rustä¸ºPythonå†™ä¸€ä¸ªæ‰©å±•","id":739360}},"comments":[{"had_liked":false,"id":386891,"user_name":"seven9t","can_delete":false,"product_type":"c1","uid":1979955,"ip_address":"å¹¿ä¸œ","ucode":"B7CA7D62C56938","user_header":"https://static001.geekbang.org/account/avatar/00/1e/36/33/3411df0d.jpg","comment_is_top":false,"comment_ctime":1705829641,"is_pvip":false,"replies":[{"id":141074,"content":"è¿™ä¸ªé—®é¢˜è¢«æ¿€çƒˆè®¨è®ºè¿‡ï¼Œä¸ºä½ çš„åˆ›æ„ç‚¹èµğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1705970712,"ip_address":"é‡åº†","comment_id":386891,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"unsafeæ”¹åå«trustMeå¤šå¥½","like_count":5,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":636339,"discussion_content":"è¿™ä¸ªé—®é¢˜è¢«æ¿€çƒˆè®¨è®ºè¿‡ï¼Œä¸ºä½ çš„åˆ›æ„ç‚¹èµğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1705970712,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":387969,"user_name":"Geek_03197d","can_delete":false,"product_type":"c1","uid":3196256,"ip_address":"æ±Ÿè‹","ucode":"1A4CB405EF154A","user_header":"","comment_is_top":false,"comment_ctime":1709047485,"is_pvip":false,"replies":[{"id":141300,"content":"è£¸æŒ‡é’ˆ ä¹Ÿè¡Œã€‚ ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1709139878,"ip_address":"åŠ æ‹¿å¤§","comment_id":387969,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"raw pointer ç¿»è¯‘æˆ è£¸æŒ‡é’ˆ æ˜¯ä¸æ˜¯æ›´é€šç”¨ï¼Ÿ","like_count":2,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":637955,"discussion_content":"è£¸æŒ‡é’ˆ ä¹Ÿè¡Œã€‚ ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1709139878,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŠ æ‹¿å¤§","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":386361,"user_name":"Apaç¦","can_delete":false,"product_type":"c1","uid":3710982,"ip_address":"ä¸Šæµ·","ucode":"A4A76A4D7364EA","user_header":"https://static001.geekbang.org/account/avatar/00/38/a0/06/f0ca94ca.jpg","comment_is_top":false,"comment_ctime":1704677429,"is_pvip":false,"replies":[{"id":140813,"content":"tokioåº“åº•å±‚æœ‰å°‘é‡ç”¨åˆ°unsafe","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1704688430,"ip_address":"é‡åº†","comment_id":386361,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"tokioåº“ä¹Ÿæ˜¯ç”¨unsafeå®ç°çš„ä¹ˆï¼Œrustè‡ªå·±æ²¡æœ‰å®ç°Asyncï¼Œä¹Ÿå°±åªèƒ½ä½¿ç”¨unsafeè°ƒç”¨cè¯­è¨€åº“å®ç°äº†","like_count":2,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":635276,"discussion_content":"tokioåº“åº•å±‚æœ‰å°‘é‡ç”¨åˆ°unsafe","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1704688430,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1979955,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/36/33/3411df0d.jpg","nickname":"seven9t","note":"","ucode":"B7CA7D62C56938","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":636211,"discussion_content":"ä¸ºå•¥ç¬¬ä¸‰æ–¹asyncä¸€å®šè¦unsafeå®ç° @Apa","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1705829828,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":385990,"user_name":"åå…«å“¥","can_delete":false,"product_type":"c1","uid":1027167,"ip_address":"å¤©æ´¥","ucode":"C0130252F97814","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ac/5f/894761f8.jpg","comment_is_top":false,"comment_ctime":1703811772,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"Unsafe Rust æ¯” C è¯­è¨€æ›´å®‰å…¨å—ï¼Ÿæ˜¯çš„ã€‚è™½ç„¶æ˜¯Unsafeï¼Œå¯ä»¥ç”¨æŒ‡é’ˆã€‚ä½†æ˜¯ï¼ŒUnsafeä¾ç„¶å±äºæ‰€æœ‰æƒè¿™æ ·çš„è¯­æ³•èŒƒç•´ã€‚","like_count":2}]}