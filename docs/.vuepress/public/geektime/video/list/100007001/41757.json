{"id":41757,"title":"116 | 基于 Eureka、Zuul 和容器云的持续交付架构","content":"无","comments":[{"had_liked":false,"id":178106,"user_name":"zhaoni","can_delete":false,"product_type":"c3","uid":1052158,"ip_address":"","ucode":"F317ECD6380984","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqT1ykjFve5LCsFvegqLb8MKrf6ASApsOgm8nRb5icDE7MgzKbia0zUQkxe44tKvpCwQ65QuHo4NVoQ/132","comment_is_top":false,"comment_ctime":1581587032,"is_pvip":false,"replies":[{"id":69343,"content":"这个没有一般通用做法，需要具体问题具体分析应对。\n\n一般升级前需要考虑好回滚策略(回滚安全的升级，也就是有后手，不能没有后路就升级)，并且在测试环境要进行演练验证。\n\n另外，对于数据库的升级，一般也需要考虑回滚兼容方案，一般可以添加字段(append only)，但是不要修改字段(修改可以用添加来代替)。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1581783371,"ip_address":"","comment_id":178106,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"波波老师：\n1、蓝绿部署时，一般V1版本和V2版本涉及到数据库的调整，有可能增加字段或者修改字段，如果回滚到V1版本，有些数据差异，这种一般是如何处理的？","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":483667,"discussion_content":"这个没有一般通用做法，需要具体问题具体分析应对。\n\n一般升级前需要考虑好回滚策略(回滚安全的升级，也就是有后手，不能没有后路就升级)，并且在测试环境要进行演练验证。\n\n另外，对于数据库的升级，一般也需要考虑回滚兼容方案，一般可以添加字段(append only)，但是不要修改字段(修改可以用添加来代替)。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581783371,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":53752,"user_name":"王盛武","can_delete":false,"product_type":"c3","uid":1182516,"ip_address":"","ucode":"DE7EF246D3DCE8","user_header":"https://static001.geekbang.org/account/avatar/00/12/0b/34/f41d73a4.jpg","comment_is_top":false,"comment_ctime":1545719237,"is_pvip":false,"replies":[{"id":19953,"content":"课程中讲的基于eureka的发布体系，如果要实现你说的这种测试方式，需要做一些扩展，一种简单思路，一方面这个新的绿机实例要打tag（eureka支持实例打tag），标识这些绿机只能测试用，另外ribbon端要扩展，生产流量不能去这台绿机（有tag）,测试流量（通过ip或http header判断）可以去访问绿机。测试完成没问题，把tag去掉，绿机也可接生产流量了。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1546006620,"ip_address":"","comment_id":53752,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"波波老师，\n生产灰度更新，有一种情况如何考虑？\n比如更新了1台绿机， 测试想通过指定访问绿机访问验证核心功能是否正常；\n这种情况好像跟本节讲的不一样，因为测试的时候，不是100%命中那台绿机的接口，要慢慢等一段时间；","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434229,"discussion_content":"课程中讲的基于eureka的发布体系，如果要实现你说的这种测试方式，需要做一些扩展，一种简单思路，一方面这个新的绿机实例要打tag（eureka支持实例打tag），标识这些绿机只能测试用，另外ribbon端要扩展，生产流量不能去这台绿机（有tag）,测试流量（通过ip或http header判断）可以去访问绿机。测试完成没问题，把tag去掉，绿机也可接生产流量了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546006620,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":34145,"user_name":"Sam_Deep_Thinking","can_delete":false,"product_type":"c3","uid":1001152,"ip_address":"","ucode":"8E4EF6F24B821B","user_header":"https://static001.geekbang.org/account/avatar/00/0f/46/c0/106d98e7.jpg","comment_is_top":false,"comment_ctime":1540020875,"is_pvip":false,"replies":[{"id":12664,"content":"谢谢支持🌹","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1540732945,"ip_address":"","comment_id":34145,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"讲的真好。感谢老师。","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":427131,"discussion_content":"谢谢支持🌹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1540732945,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":178107,"user_name":"zhaoni","can_delete":false,"product_type":"c3","uid":1052158,"ip_address":"","ucode":"F317ECD6380984","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqT1ykjFve5LCsFvegqLb8MKrf6ASApsOgm8nRb5icDE7MgzKbia0zUQkxe44tKvpCwQ65QuHo4NVoQ/132","comment_is_top":false,"comment_ctime":1581587105,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"2、当金丝雀测试成功后，发布了V2版本的十台，同一个用户来访问服务时，不同时段请求的版本会不会不同？","like_count":0,"discussions":[{"author":{"id":1270632,"avatar":"https://static001.geekbang.org/account/avatar/00/13/63/68/14b98bbc.jpg","nickname":"大鹏","note":"","ucode":"F4611B80B08A3A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":349717,"discussion_content":"请求的版本会有不同。你的场景是指视频里的第三步吧，金丝雀成功后，V1和V2同时存在，并且V1还没有拉出。此时无论是途径zuul的外部流量，还是内部服务间调用的内部流量，都会由ribbon进行负载均衡，均匀的分布到V1和V2上。在ribbon看来，v1和v2只是同一app的实例，没有什么不同。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1613476426,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}