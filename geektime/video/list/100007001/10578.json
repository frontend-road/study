{"id":10578,"title":"50 | Zuul网关和基本应用场景","content":"<h1>课件及源码地址</h1>\n<p><a href=\"https://gitee.com/geektime-geekbang/zuul_lab\">https://gitee.com/geektime-geekbang/zuul_lab</a><br />\n<a href=\"https://gitee.com/geektime-geekbang/oauth2lab\">https://gitee.com/geektime-geekbang/oauth2lab</a></p>\n","comments":[{"had_liked":false,"id":24313,"user_name":"郭嵩阳","can_delete":false,"product_type":"c3","uid":1080998,"ip_address":"","ucode":"9DC42C7B73F580","user_header":"https://static001.geekbang.org/account/avatar/00/10/7e/a6/188817b6.jpg","comment_is_top":false,"comment_ctime":1536896369,"is_pvip":false,"replies":[{"id":9646,"content":"网关主要是请求路由转发，开销有一点，但是一般不是很大，我们观察生产一般网关损耗只有大约10ms左右；另外网关上需要做好限流熔断，防止后端慢服务影响网关。具体部署多少个zuul实例，要看你的访问量规模，我之前公司有部署上百个的，也有10~20个的，你需要自己评估，做好监控和容量规划。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1537681676,"ip_address":"","comment_id":24313,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"波波老师您好，想问一下，zuul在后续所有的请求都经过，后续网关会不会存在性能问题，您使用zuul 部署了多少个实例","like_count":2,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":423933,"discussion_content":"网关主要是请求路由转发，开销有一点，但是一般不是很大，我们观察生产一般网关损耗只有大约10ms左右；另外网关上需要做好限流熔断，防止后端慢服务影响网关。具体部署多少个zuul实例，要看你的访问量规模，我之前公司有部署上百个的，也有10~20个的，你需要自己评估，做好监控和容量规划。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1537681676,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":182747,"user_name":"loris","can_delete":false,"product_type":"c3","uid":1179312,"ip_address":"","ucode":"00842745CF4B31","user_header":"https://static001.geekbang.org/account/avatar/00/11/fe/b0/260f41f0.jpg","comment_is_top":false,"comment_ctime":1582859594,"is_pvip":false,"replies":[{"id":70907,"content":"Base Service都是基础服务，例如电商网站的产品&#47;分类&#47;库存&#47;购物车&#47;支付&#47;客服等等。基础服务一般不直接对外暴露，而是通过Edge Service聚合后间接对外暴露。Edge Service也称聚合服务，对基础服务进行适当聚合裁剪，适配各种不同的前端展示(Web&#47;SPA&#47;无线&#47;第三方开放平台...），也就是聚合出适合不同前端展示的API视图(View)。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1582989482,"ip_address":"","comment_id":182747,"utype":1}],"discussion_count":1,"race_medal":1,"score":2,"product_id":100007001,"comment_content":"波波老师好，您能简单说明一下，什么样的服务归类为Edge Service 和 Base Service","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":485434,"discussion_content":"Base Service都是基础服务，例如电商网站的产品/分类/库存/购物车/支付/客服等等。基础服务一般不直接对外暴露，而是通过Edge Service聚合后间接对外暴露。Edge Service也称聚合服务，对基础服务进行适当聚合裁剪，适配各种不同的前端展示(Web/SPA/无线/第三方开放平台...），也就是聚合出适合不同前端展示的API视图(View)。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1582989482,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":69296,"user_name":"Geek_zbvt62","can_delete":false,"product_type":"c3","uid":1046714,"ip_address":"","ucode":"81EA27ADD9EC1A","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f8/ba/d28174a9.jpg","comment_is_top":false,"comment_ctime":1550713714,"is_pvip":false,"replies":[{"id":25117,"content":"你好，你的问题很长很多，这里回复不全，建议参考我的文章《BFF和网关是如何演化出来》https:&#47;&#47;blog.csdn.net&#47;yang75108&#47;article&#47;details&#47;86987404，应该能够找到答案，如果还有疑问，可以直接在群里向我提问。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1551099765,"ip_address":"","comment_id":69296,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"波波老师，之前看过您的关于BFF的讲解。我觉得我们目前的架构也是有一系列的BFF。但我一直有个困惑，也体现在您的架构图上——网关（我们是基于spring cloud zuul)和BFF之间的功能是不是有重合的部分？\n或者说详细些，假如我有A,B,C三个大的业务块，分别对外暴露三个不同的域名，A.xxx.com, B.xxx.com, C.xxx.com。\n此时我是应该做一“套”网关，网关路由到A,B,C三个不同的BFF，然后在这一“套”网关上，区别对待A,B,C，做不同的身份验证，限流，熔断规则呢？\n还是做三“套”不同的网关，网关路由到各自的一个或多个BFF，自然，安全和限流的工作也各做个的？但这样我们大多数时候，网关和BFF是不是可以合二为一？\n\n这就是我一直的困惑，到底网关和BFF是不是可以合并。有的微服务课程会把聚合功能算到网关头上，但又说网关不应该包含业务逻辑，感觉自相矛盾。\n\n另外，您能否推荐一个能给简化BFF做聚合工作的框架，开源的。或者是最佳实践标准？\n\n希望得到您的指点，我也在您的微信群，您也可以把解惑发到那里。\n","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440046,"discussion_content":"你好，你的问题很长很多，这里回复不全，建议参考我的文章《BFF和网关是如何演化出来》https://blog.csdn.net/yang75108/article/details/86987404，应该能够找到答案，如果还有疑问，可以直接在群里向我提问。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551099765,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":50240,"user_name":"王盛武","can_delete":false,"product_type":"c3","uid":1182516,"ip_address":"","ucode":"DE7EF246D3DCE8","user_header":"https://static001.geekbang.org/account/avatar/00/12/0b/34/f41d73a4.jpg","comment_is_top":false,"comment_ctime":1544930799,"is_pvip":false,"replies":[{"id":18273,"content":"zuul可以做细粒度权限控制，可开发定制过滤器filter，权限逻辑根据业务需求灵活定制实现。jwt带权限往后传可以，userid往后传再到集中服务验权也可以，两种架构风格，各有利弊。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1545055403,"ip_address":"","comment_id":50240,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"zuul权限控制是基于URL的形式，各个微服务的方法级控制是提供zuul分发的jwt权限控制？       如果微服务a依赖微服务b，那a请求b的时候也要带上jwt这种授权详情集合？   还是a通过传递类似userId的标识给b，b再从共享redis里取出授权集合？","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432923,"discussion_content":"zuul可以做细粒度权限控制，可开发定制过滤器filter，权限逻辑根据业务需求灵活定制实现。jwt带权限往后传可以，userid往后传再到集中服务验权也可以，两种架构风格，各有利弊。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545055403,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":182744,"user_name":"loris","can_delete":false,"product_type":"c3","uid":1179312,"ip_address":"","ucode":"00842745CF4B31","user_header":"https://static001.geekbang.org/account/avatar/00/11/fe/b0/260f41f0.jpg","comment_is_top":false,"comment_ctime":1582858896,"is_pvip":false,"replies":[{"id":70906,"content":"Zuul容量规划主要依赖测试环境的压测数据+生产环境监控数据，综合评估得到。刚开始可以根据压测数据预估一个容量(需要一些经验)，然后按照预估容量的x1.5或x2倍先到生产上去试，之后再根据生产监控数据再不断优化调整。完善的压测体系+监控体系+开发人员经验是要素。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1582989133,"ip_address":"","comment_id":182744,"utype":1}],"discussion_count":1,"race_medal":1,"score":2,"product_id":100007001,"comment_content":"波波老师好，请问一般对部署多少个zuul实例做容量规划\n需要考虑的因素有哪些","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":485431,"discussion_content":"Zuul容量规划主要依赖测试环境的压测数据+生产环境监控数据，综合评估得到。刚开始可以根据压测数据预估一个容量(需要一些经验)，然后按照预估容量的x1.5或x2倍先到生产上去试，之后再根据生产监控数据再不断优化调整。完善的压测体系+监控体系+开发人员经验是要素。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582989133,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":157927,"user_name":"💢 星星💢","can_delete":false,"product_type":"c3","uid":1254392,"ip_address":"","ucode":"A402B765222C35","user_header":"https://static001.geekbang.org/account/avatar/00/13/23/f8/24fcccea.jpg","comment_is_top":false,"comment_ctime":1575283861,"is_pvip":false,"replies":[{"id":60750,"content":"能做和该不该它做是两码事，网关适合做反向路由，负载均衡，安全，监控，和限流熔断这些基础功能。\n\n分布式事务一般和业务相关，建议不要耦合在网关上。分布式锁简单的采用DB锁或者复杂点的采用Zookeeper做，一般不要放在网关上。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1575463538,"ip_address":"","comment_id":157927,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"既然网办能做跨横切面的事情，那是否也可以做分布式事务，分布式锁？","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":476579,"discussion_content":"能做和该不该它做是两码事，网关适合做反向路由，负载均衡，安全，监控，和限流熔断这些基础功能。\n\n分布式事务一般和业务相关，建议不要耦合在网关上。分布式锁简单的采用DB锁或者复杂点的采用Zookeeper做，一般不要放在网关上。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1575463538,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":30661,"user_name":"东东","can_delete":false,"product_type":"c3","uid":1225648,"ip_address":"","ucode":"18DA0899BF8BF8","user_header":"https://static001.geekbang.org/account/avatar/00/12/b3/b0/ce15bc15.jpg","comment_is_top":false,"comment_ctime":1538967215,"is_pvip":false,"replies":[{"id":11399,"content":"我之前公司实践，Edge Service依赖Base Service走内部nginx代理，Edge Service之间或Base Service之间如有依然（网状结构有时也合理）也走内部nginx代理。内部服务（Edge或Base Service）对外暴露时才走zuul网关。当然，内部服务用rpc直连，不走内部nginx代理，也是可以，是另一种架构风格。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1539267685,"ip_address":"","comment_id":30661,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"波波老师您好,想问你一下您在实践zuul网关时针对Edge Services 服务依赖 Base Service 时是通过zuul网关实现吗?还是RPC与网关两种方式的结合实现?如果用RPC方式的话,你们的Base Services之音是不是也容忍依赖的网状结构, 另外针对Edge Services 之间的相互依赖是只走网关的吗? 谢谢,期待您的回答!","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426062,"discussion_content":"我之前公司实践，Edge Service依赖Base Service走内部nginx代理，Edge Service之间或Base Service之间如有依然（网状结构有时也合理）也走内部nginx代理。内部服务（Edge或Base Service）对外暴露时才走zuul网关。当然，内部服务用rpc直连，不走内部nginx代理，也是可以，是另一种架构风格。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539267685,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":23509,"user_name":"枯枯草","can_delete":false,"product_type":"c3","uid":1183503,"ip_address":"","ucode":"B32BE88E1AFC20","user_header":"https://static001.geekbang.org/account/avatar/00/12/0f/0f/7ff6ea95.jpg","comment_is_top":false,"comment_ctime":1536457145,"is_pvip":false,"replies":[{"id":8569,"content":"两种做法都可以，是两种架构风格，静态资源可以躲在网关zuul后面，这样就没有跨域问题；也可以前面加nginx，做动静分别转发，动态api转网关zuul，静态转资源服务器，这种方式需要考虑跨域问题。我们目前用第二种，但是在考虑简化采用第一种，但是zuul网关需要优化改造，改造成同时适合处理api和静态资源。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1536547990,"ip_address":"","comment_id":23509,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"老师您好，请问一般架构上，页面资源的请求也会打到zuul么，例如js&#47;css等，我的理解是elb下面是不是还有一层nginx，做前后分离，其中的后端请求全部跳转到zuul层，同时nginx帮助zuul做负载均衡","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":423596,"discussion_content":"两种做法都可以，是两种架构风格，静态资源可以躲在网关zuul后面，这样就没有跨域问题；也可以前面加nginx，做动静分别转发，动态api转网关zuul，静态转资源服务器，这种方式需要考虑跨域问题。我们目前用第二种，但是在考虑简化采用第一种，但是zuul网关需要优化改造，改造成同时适合处理api和静态资源。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1536547990,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":21498,"user_name":"🎸祥子","can_delete":false,"product_type":"c3","uid":1172458,"ip_address":"","ucode":"1AE4CA15D4FA73","user_header":"https://static001.geekbang.org/account/avatar/00/11/e3/ea/148f9a19.jpg","comment_is_top":false,"comment_ctime":1535115483,"is_pvip":false,"replies":[{"id":8123,"content":"我只用过zuul，spring cloud gateway还没用，不好做建议，你需要自己调研测试。总体我认为zuul比较成熟，在netflix有大规模落地，但是同步模型（zuul2是异步），spring cloud gateway比较新，实际落地案例还不多，你用的话要实测下。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1535864424,"ip_address":"","comment_id":21498,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"老师，zuul和Spring Cloud Gateway哪个好？生产环境用哪个？","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":422706,"discussion_content":"我只用过zuul，spring cloud gateway还没用，不好做建议，你需要自己调研测试。总体我认为zuul比较成熟，在netflix有大规模落地，但是同步模型（zuul2是异步），spring cloud gateway比较新，实际落地案例还不多，你用的话要实测下。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1535864424,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}