{"id":109695,"title":"19丨基础篇总结：如何理解查询优化、通配符以及存储过程？","content":"<p>到这一篇的时候，意味着SQL专栏的基础部分正式更新完毕。在文章更新的时候，谢谢大家积极地评论和提问，让专栏增色不少。我总结了一些基础篇的常见问题，希望能对你有所帮助。答疑篇主要包括了DBMS、查询优化、存储过程、事务处理等一些问题。</p><h2>关于各种DBMS的介绍</h2><h3>答疑1</h3><p>文章中有句话不太理解，“列式数据库是将数据按照列存储到数据库中，这样做的好处是可以大量降低系统的 I/O”，可以解释一些“降低系统I/O”是什么意思吗？</p><h3>解答</h3><p>行式存储是把一行的数据都串起来进行存储，然后再存储下一行。同样，列式存储是把一列的数据都串起来进行存储，然后再存储下一列。这样做的话，相邻数据的数据类型都是一样的，更容易压缩，压缩之后就自然降低了I/O。</p><p>我们还需要从数据处理的需求出发，去理解行式存储和列式存储。数据处理可以分为OLTP（联机事务处理）和OLAP（联机分析处理）两大类。</p><p>OLTP一般用于处理客户的事务和进行查询，需要随时对数据表中的记录进行增删改查，对实时性要求高。</p><p>OLAP一般用于市场的数据分析，通常数据量大，需要进行复杂的分析操作，可以对大量历史数据进行汇总和分析，对实时性要求不高。</p><p>那么对于OLTP来说，由于随时需要对数据记录进行增删改查，更适合采用行式存储，因为一行数据的写入会同时修改多个列。传统的RDBMS都属于行式存储，比如Oracle、SQL Server和MySQL等。</p><!-- [[[read_end]]] --><p>对于OLAP来说，由于需要对大量历史数据进行汇总和分析，则适合采用列式存储，这样的话汇总数据会非常快，但是对于插入（INSERT）和更新（UPDATE）会比较麻烦，相比于行式存储性能会差不少。</p><p>所以说列式存储适合大批量数据查询，可以降低I/O，但如果对实时性要求高，则更适合行式存储。</p><h2>关于查询优化</h2><h3>答疑1</h3><p>在MySQL中统计数据表的行数，可以使用三种方式：<code>SELECT COUNT(*)</code>、<code>SELECT COUNT(1)</code>和<code>SELECT COUNT(具体字段)</code>，使用这三者之间的查询效率是怎样的？之前看到说是：<code>SELECT COUNT(*)</code>＞ <code>SELECT COUNT(1)</code>＞ <code>SELECT COUNT(具体字段)</code>。</p><h3>解答</h3><p>在MySQL InnoDB存储引擎中，<code>COUNT(*)</code>和<code>COUNT(1)</code>都是对所有结果进行<code>COUNT</code>。如果有WHERE子句，则是对所有符合筛选条件的数据行进行统计；如果没有WHERE子句，则是对数据表的数据行数进行统计。</p><p>因此<code>COUNT(*)</code>和<code>COUNT(1)</code>本质上并没有区别，执行的复杂度都是<code>O(N)</code>，也就是采用全表扫描，进行循环+计数的方式进行统计。</p><p>如果是MySQL MyISAM存储引擎，统计数据表的行数只需要<code>O(1)</code>的复杂度，这是因为每张MyISAM的数据表都有一个meta信息存储了<code>row_count</code>值，而一致性则由表级锁来保证。因为InnoDB支持事务，采用行级锁和MVCC机制，所以无法像MyISAM一样，只维护一个<code>row_count</code>变量，因此需要采用扫描全表，进行循环+计数的方式来完成统计。</p><p>需要注意的是，在实际执行中，<code>COUNT(*)</code>和<code>COUNT(1)</code>的执行时间可能略有差别，不过你还是可以把它俩的执行效率看成是相等的。</p><p>另外在InnoDB引擎中，如果采用<code>COUNT(*)</code>和<code>COUNT(1)</code>来统计数据行数，要尽量采用二级索引。因为主键采用的索引是聚簇索引，聚簇索引包含的信息多，明显会大于二级索引（非聚簇索引）。对于<code>COUNT(*)</code>和<code>COUNT(1)</code>来说，它们不需要查找具体的行，只是统计行数，系统会自动采用占用空间更小的二级索引来进行统计。</p><p>然而如果想要查找具体的行，那么采用主键索引的效率更高。如果有多个二级索引，会使用key_len小的二级索引进行扫描。当没有二级索引的时候，才会采用主键索引来进行统计。</p><p>这里我总结一下：</p><ol>\n<li>一般情况下，三者执行的效率为 <code>COUNT(*)</code>= <code>COUNT(1)</code>&gt; <code>COUNT(字段)</code>。我们尽量使用<code>COUNT(*)</code>，当然如果你要统计的是某个字段的非空数据行数，则另当别论，毕竟比较执行效率的前提是结果一样才可以。</li>\n<li>如果要统计<code>COUNT(*)</code>，尽量在数据表上建立二级索引，系统会自动采用<code>key_len</code>小的二级索引进行扫描，这样当我们使用<code>SELECT COUNT(*)</code>的时候效率就会提升，有时候可以提升几倍甚至更高。</li>\n</ol><h3>答疑2</h3><p>在MySQL中，<code>LIMIT</code>关键词是最后执行的，如果可以确定只有一条结果，那么就起不到查询优化的效果了吧，因为<code>LIMIT</code>是对最后的结果集过滤，如果结果集本来就只有一条，那就没有什么用了。</p><h3>解答</h3><p>如果你可以确定结果集只有一条，那么加上<code>LIMIT 1</code>的时候，当找到一条结果的时候就不会继续扫描了，这样会加快查询速度。这里指的查询优化针对的是会扫描全表的SQL语句，如果数据表已经对字段建立了唯一索引，那么可以通过索引进行查询，不会全表扫描的话，就不需要加上<code>LIMIT 1</code>了。</p><h2>关于通配符的解释</h2><p>关于查询语句中通配符的使用理解，我举了一个查询英雄名除了第一个字以外，包含“太”字的英雄都有谁的例子，使用的SQL语句是：</p><pre><code>SQL&gt; SELECT name FROM heros WHERE name LIKE '_%太%'\n</code></pre><p>（_）匹配任意一个字符，（%） 匹配大于等于0个任意字符。</p><p>所以通配符<code>'_%太%'</code>说明在第一个字符之后需要有“太”字，这里就不能匹配上“太乙真人”，但是可以匹配上“东皇太一”。如果数据表中有“太乙真人太太”，那么结果集中也可以匹配到。</p><p>另外，单独的<code>LIKE '%'</code>无法查出NULL值，比如：<code>SELECT * FROM heros WHERE role_assist LIKE '%'</code>。</p><h3>答疑4</h3><p>可以理解在WHERE条件字段上加索引，但是为什么在ORDER BY字段上还要加索引呢？这个时候已经通过WHERE条件过滤得到了数据，已经不需要再筛选过滤数据了，只需要根据字段排序就好了。</p><h3>解答</h3><p>在MySQL中，支持两种排序方式，分别是FileSort和Index排序。在Index排序中，索引可以保证数据的有序性，不需要再进行排序，效率更高。而FileSort排序则一般在内存中进行排序，占用CPU较多。如果待排结果较大，会产生临时文件I/O到磁盘进行排序的情况，效率较低。</p><p>所以使用ORDER BY子句时，应该尽量使用Index排序，避免使用FileSort排序。当然你可以使用explain来查看执行计划，看下优化器是否采用索引进行排序。</p><p>优化建议：</p><ol>\n<li>SQL中，可以在WHERE子句和ORDER BY子句中使用索引，目的是在WHERE子句中避免全表扫描，在ORDER BY子句避免使用FileSort排序。当然，某些情况下全表扫描，或者FileSort排序不一定比索引慢。但总的来说，我们还是要避免，以提高查询效率。一般情况下，优化器会帮我们进行更好的选择，当然我们也需要建立合理的索引。</li>\n<li>尽量使用Index完成ORDER BY排序。如果WHERE和ORDER BY后面是相同的列就使用单索引列；如果不同就使用联合索引。</li>\n<li>无法使用Index时，需要对FileSort方式进行调优。</li>\n</ol><h3>答疑5</h3><p>ORDER BY是对分的组排序还是对分组中的记录排序呢？</p><h3>解答</h3><p>ORDER BY就是对记录进行排序。如果你在ORDER BY前面用到了GROUP BY，实际上这是一种分组的聚合方式，已经把一组的数据聚合成为了一条记录，再进行排序的时候，相当于对分的组进行了排序。</p><h3>答疑6</h3><p>请问下关于SELECT语句内部的执行步骤。</p><h3>解答</h3><p>一条完整的SELECT语句内部的执行顺序是这样的：</p><ol>\n<li>FROM子句组装数据（包括通过ON进行连接）；</li>\n<li>WHERE子句进行条件筛选；</li>\n<li>GROUP BY分组 ；</li>\n<li>使用聚集函数进行计算；</li>\n<li>HAVING筛选分组；</li>\n<li>计算所有的表达式；</li>\n<li>SELECT 的字段；</li>\n<li>ORDER BY排序；</li>\n<li>LIMIT筛选。</li>\n</ol><h3>答疑7</h3><p>不太理解哪种情况下应该使用EXISTS，哪种情况应该用IN。选择的标准是看能否使用表的索引吗？</p><h3>解答</h3><p>索引是个前提，其实选择与否还是要看表的大小。你可以将选择的标准理解为小表驱动大表。在这种方式下效率是最高的。</p><p>比如下面这样：</p><pre><code> SELECT * FROM A WHERE cc IN (SELECT cc FROM B)\n SELECT * FROM A WHERE EXISTS (SELECT cc FROM B WHERE B.cc=A.cc)\n</code></pre><p>当A小于B时，用EXISTS。因为EXISTS的实现，相当于外表循环，实现的逻辑类似于：</p><pre><code> for i in A\n     for j in B\n         if j.cc == i.cc then ...\n</code></pre><p>当B小于A时用IN，因为实现的逻辑类似于：</p><pre><code> for i in B\n     for j in A\n         if j.cc == i.cc then ...\n</code></pre><p>哪个表小就用哪个表来驱动，A表小就用EXISTS，B表小就用IN。</p><h2>关于存储过程</h2><h3>答疑1</h3><p>在使用存储过程声明变量时，都支持哪些数据类型呢？</p><h3>解答</h3><p>不同的DBMS对数据类型的定义不同，你需要查询相关的DBMS文档。以MySQL为例，常见的数据类型可以分成三类，分别是数值类型、字符串类型和日期／时间类型。</p><h3>答疑2</h3><p>“IN参数必须在调用存储过程时指定”的含义是什么？我查询了MySQL的存储过程定义，可以不包含 IN 参数。当存储过程的定义语句里有 IN 参数时，存储过程的语句中必须用到这个参数吗?</p><h3>解答</h3><p>如果存储过程定义了IN参数，就需要在调用的时候传入。当然在定义存储过程的时候，如果不指定参数类型，就默认是IN类型的参数。因为IN参数在存储过程中是默认值，可以省略不写。比如下面两种定义方式都是一样的：</p><pre><code>CREATE PROCEDURE `add_num`(IN n INT)\n</code></pre><pre><code>CREATE PROCEDURE `add_num`(n INT)\n</code></pre><p>在存储过程中的语句里，不一定要用到IN参数，只是在调用的时候需要传入这个。另外IN参数在存储过程中进行了修改，也不会进行返回的。如果想要返回参数，需要使用OUT，或者INOUT参数类型。</p><h2>关于事务处理</h2><h3>答疑1</h3><p>如果<code>INSERT INTO test SELECT '关羽';</code>之后没有执行COMMIT，结果应该是空。但是我执行出来的结果是<code>'关羽'</code>，为什么ROLLBACK没有全部回滚？</p><p>代码如下：</p><pre><code> CREATE TABLE test(name varchar(255), PRIMARY KEY (name)) ENGINE=InnoDB;\n BEGIN;\n INSERT INTO test SELECT '关羽';\n BEGIN;\n INSERT INTO test SELECT '张飞';\n INSERT INTO test SELECT '张飞';\n ROLLBACK;\n SELECT * FROM test;\n</code></pre><h3>解答</h3><p>先解释下连续BEGIN的情况。</p><p>在MySQL中BEGIN用于开启事务，如果是连续BEGIN，当开启了第一个事务，还没有进行COMMIT提交时，会直接进行第二个事务的BEGIN，这时数据库会隐式地COMMIT第一个事务，然后再进入到第二个事务。</p><p>为什么ROLLBACK没有全部回滚呢？</p><p>因为ROLLBACK是针对当前事务的，在BEGIN之后已经开启了第二个事务，当遇到ROLLBACK的时候，第二个事务都进行了回滚，也就得到了第一个事务执行之后的结果即“关羽”。</p><p>关于事务的ACID，以及我们使用COMMIT和ROLLBACK来控制事务的时候，有一个容易出错的地方。</p><p>在一个事务的执行过程中可能会失败。遇到失败的时候是进行回滚，还是将事务执行过程中已经成功操作的来进行提交，这个逻辑是需要开发者自己来控制的。</p><p>这里开发者可以决定，如果遇到了小错误是直接忽略，提交事务，还是遇到任何错误都进行回滚。如果我们强行进行COMMIT，数据库会将这个事务中成功的操作进行提交，它会认为你觉得已经是ACID了（就是你认为可以做COMMIT了，即使遇到了一些小问题也是可以忽略的）。</p><p>我在今天的文章里重点解答了一些问题，还有一些未解答的会留在评论里进行回复。最后出一道思考题吧。</p><p>请你自己写出下面操作的运行结果（你可以把它作为一道笔试题，自己写出结果，再与实际的运行结果进行比对）：</p><pre><code>DROP TABLE IF EXISTS test;\nCREATE TABLE test(name varchar(255), PRIMARY KEY (name)) ENGINE=InnoDB;\nBEGIN;\nINSERT INTO test SELECT '关羽';\nBEGIN;\nINSERT INTO test SELECT '张飞';\nINSERT INTO test SELECT '张飞';\nCOMMIT;\nSELECT * FROM test;\n</code></pre><p>欢迎你在评论区写下你的思考，我会与你一起交流，也欢迎把这篇文章分享给你的朋友或者同事，一起交流一下。</p><p></p>","comments":[{"had_liked":false,"id":116902,"user_name":"TKbook","can_delete":false,"product_type":"c1","uid":1073829,"ip_address":"","ucode":"F6E0E99CC79059","user_header":"https://static001.geekbang.org/account/avatar/00/10/62/a5/43aa0c27.jpg","comment_is_top":false,"comment_ctime":1563936914,"is_pvip":false,"replies":[{"id":"43075","content":"对的 这个解释也正确","user_name":"作者回复","comment_id":116902,"uid":"1306094","ip_address":"","utype":1,"ctime":1564104834,"user_name_real":"cy"}],"discussion_count":5,"race_medal":0,"score":"126117988498","product_id":100029501,"comment_content":"结果是：<br>+------+<br>| name |<br>+------+<br>| 关羽 |<br>| 张飞 |<br>+------+<br><br>因为插入关羽这个是第一个事务，虽然没有commit，但是第二个begin数据库会隐式地 COMMIT 第一个事务，第二事务，插入张飞两次，第一次插入成功，第二次插入失败。强制commit，第一次插入的张飞会进行提交。所以结果是关羽和张飞。","like_count":29,"discussions":[{"author":{"id":1306094,"avatar":"https://static001.geekbang.org/account/avatar/00/13/ed/ee/c4779b67.jpg","nickname":"cy","note":"","ucode":"50D653399A31F6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":459724,"discussion_content":"对的 这个解释也正确","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564104834,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1913261,"avatar":"","nickname":"Cookie123456","note":"","ucode":"F9EF63C38F8976","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":219048,"discussion_content":"解释的没有问题，运行的时候也没有问题，显示各影响了两行，但是打开数据表只有关羽这条记录","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1585727726,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2962599,"avatar":"https://static001.geekbang.org/account/avatar/00/2d/34/a7/52c4ea60.jpg","nickname":"年少挽滑稽世无双","note":"","ucode":"793DCBDE25A07B","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1913261,"avatar":"","nickname":"Cookie123456","note":"","ucode":"F9EF63C38F8976","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":587270,"discussion_content":"一样","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662950322,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":219048,"ip_address":"四川"},"score":587270,"extra":""}]},{"author":{"id":1968721,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/unkzY52hVDjTmZJGNkrBR75tFs4XTGBoYYcOYkIcPvHlQrLibwc94aBfj1uWiawoKeEMwHbkvgThXZarfoP8Dzag/132","nickname":"她","note":"","ucode":"FAC6851866C9C7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":254779,"discussion_content":"你应该是全选运行的，到插入第二个张飞时报错了。后面两条没执行，所以会出现你这种情况。你可以试试把commit;select * from test; 这两条在执行一遍。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1588343905,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2962599,"avatar":"https://static001.geekbang.org/account/avatar/00/2d/34/a7/52c4ea60.jpg","nickname":"年少挽滑稽世无双","note":"","ucode":"793DCBDE25A07B","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1968721,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/unkzY52hVDjTmZJGNkrBR75tFs4XTGBoYYcOYkIcPvHlQrLibwc94aBfj1uWiawoKeEMwHbkvgThXZarfoP8Dzag/132","nickname":"她","note":"","ucode":"FAC6851866C9C7","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":587271,"discussion_content":"解决了，感谢！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662950351,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":254779,"ip_address":"四川"},"score":587271,"extra":""}]}]},{"had_liked":false,"id":116917,"user_name":"许童童","can_delete":false,"product_type":"c1","uid":1003005,"ip_address":"","ucode":"4B799C0C6BC678","user_header":"https://static001.geekbang.org/account/avatar/00/0f/4d/fd/0aa0e39f.jpg","comment_is_top":false,"comment_ctime":1563938220,"is_pvip":false,"replies":[{"id":"43073","content":"相同点：可变长度，字符类型数据<br>不同点：varchar(n)是n个字节，非Unicode字符。（英文字母占1个字节，中文占2个字节）<br>而nvarchar(n)是n个字符，Unicode字符。（英文字母或者中文都是占用2个字节）<br><br>举个例子，varchar(10)代表10个字节，所以可以是10个英文字母，也可以是5个汉字。<br>而nvarchar(10)代表10个字符，这10个字符可以是10个字母，也可以是10个汉字（英文字母或者中文 都是占用2个字节）","user_name":"作者回复","comment_id":116917,"uid":"1306094","ip_address":"","utype":1,"ctime":1564104804,"user_name_real":"cy"}],"discussion_count":5,"race_medal":0,"score":"104643153324","product_id":100029501,"comment_content":"老师你好，能否说一下varchar和nvarchar有什么区别，分别用在什么场景？","like_count":24,"discussions":[{"author":{"id":1306094,"avatar":"https://static001.geekbang.org/account/avatar/00/13/ed/ee/c4779b67.jpg","nickname":"cy","note":"","ucode":"50D653399A31F6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":459731,"discussion_content":"相同点：可变长度，字符类型数据\n不同点：varchar(n)是n个字节，非Unicode字符。（英文字母占1个字节，中文占2个字节）\n而nvarchar(n)是n个字符，Unicode字符。（英文字母或者中文都是占用2个字节）\n\n举个例子，varchar(10)代表10个字节，所以可以是10个英文字母，也可以是5个汉字。\n而nvarchar(10)代表10个字符，这10个字符可以是10个字母，也可以是10个汉字（英文字母或者中文 都是占用2个字节）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564104804,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1497645,"avatar":"https://static001.geekbang.org/account/avatar/00/16/da/2d/82b24cd0.jpg","nickname":"杨丰旭","note":"","ucode":"C61647E2F4E476","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":34353,"discussion_content":"mysql里5.0以上就没有nvarchar了吧，varchar里就是字符数等同于nvarchar","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1571195496,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1200544,"avatar":"https://static001.geekbang.org/account/avatar/00/12/51/a0/f3bb1dd7.jpg","nickname":"张大人","note":"","ucode":"4FCA71788DEB29","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":136867,"discussion_content":"MySQL 5.0版本以上varchar(n) 里边的n代表的是字符个数","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1579169281,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1336970,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/fUDCLLob6DFS8kZcMUfxOc4qQHeQfW4rIMK5Ty2u2AqLemcdhVRw7byx85HrVicSvy5AiabE0YGMj5gVt8ibgrusA/132","nickname":"NO.9","note":"","ucode":"B92F14B493406F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":2953,"discussion_content":"nvarchar 用来存汉字吧","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1564060410,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1435389,"avatar":"https://static001.geekbang.org/account/avatar/00/15/e6/fd/9f1c9398.jpg","nickname":"陈 yi 豪","note":"","ucode":"BFBFCF8768A0B0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":296839,"discussion_content":"MySQL5.7，实测字段类型指定为varchar(10)时，可以存10个汉字","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596681282,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":137380,"user_name":"挠头侠","can_delete":false,"product_type":"c1","uid":1150474,"ip_address":"","ucode":"F96966832E2252","user_header":"https://static001.geekbang.org/account/avatar/00/11/8e/0a/31ec5392.jpg","comment_is_top":false,"comment_ctime":1569726756,"is_pvip":false,"replies":[{"id":"53354","content":"COMMIT这里会进行强制提交，也就是程序员来控制当存在错误的时候，是否进行强制提交。所以第一个张飞会提交成功，数据表的结果是：关羽、张飞。你也可以看下看下第一个留言的同学的解答","user_name":"作者回复","comment_id":137380,"uid":"1306094","ip_address":"","utype":1,"ctime":1570425285,"user_name_real":"cy"}],"discussion_count":2,"race_medal":0,"score":"31634497828","product_id":100029501,"comment_content":"老师 你上述这个例子，第二个begin中，这里不加 commit 得到的结果仍然是 关羽和张飞啊。第二个事务如果要回滚的话不应该没有 “张飞“ 这个名字吗？commit是默认的吗？这点老师还是补充一下吧。","like_count":7,"discussions":[{"author":{"id":1306094,"avatar":"https://static001.geekbang.org/account/avatar/00/13/ed/ee/c4779b67.jpg","nickname":"cy","note":"","ucode":"50D653399A31F6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":469060,"discussion_content":"COMMIT这里会进行强制提交，也就是程序员来控制当存在错误的时候，是否进行强制提交。所以第一个张飞会提交成功，数据表的结果是：关羽、张飞。你也可以看下看下第一个留言的同学的解答","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1570425285,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1475276,"avatar":"","nickname":"徐相华","note":"","ucode":"343CEDA213DC70","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":589534,"discussion_content":"因为没有设置aotocommit = 0吧？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1665064429,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"上海"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":117370,"user_name":"另至","can_delete":false,"product_type":"c1","uid":1073651,"ip_address":"","ucode":"B2CAC3B17A2FA1","user_header":"https://static001.geekbang.org/account/avatar/00/10/61/f3/584d3b46.jpg","comment_is_top":false,"comment_ctime":1564035408,"is_pvip":false,"replies":[{"id":"43146","content":"原子是这个特点，不过在代码操作的时候，如果在一个事务中遇到的错误，还是可以强制进行COMMIT的，这时会把这个事务中成功执行的部分进行提交。你可以运行下 文章中给到的代码","user_name":"作者回复","comment_id":117370,"uid":"1306094","ip_address":"","utype":1,"ctime":1564137856,"user_name_real":"cy"}],"discussion_count":1,"race_medal":0,"score":"31628806480","product_id":100029501,"comment_content":"根据第十四篇-事务，原子性：要不全部成功，要不全部失败。","like_count":7,"discussions":[{"author":{"id":1306094,"avatar":"https://static001.geekbang.org/account/avatar/00/13/ed/ee/c4779b67.jpg","nickname":"cy","note":"","ucode":"50D653399A31F6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":459933,"discussion_content":"原子是这个特点，不过在代码操作的时候，如果在一个事务中遇到的错误，还是可以强制进行COMMIT的，这时会把这个事务中成功执行的部分进行提交。你可以运行下 文章中给到的代码","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564137856,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":117372,"user_name":"另至","can_delete":false,"product_type":"c1","uid":1073651,"ip_address":"","ucode":"B2CAC3B17A2FA1","user_header":"https://static001.geekbang.org/account/avatar/00/10/61/f3/584d3b46.jpg","comment_is_top":false,"comment_ctime":1564035718,"is_pvip":false,"replies":[{"id":"43088","content":"对事务ACID的理解是这样的，不过在程序中是需要自己来控制的，如果遇到了错误，还继续执行COMMIT的话，也会让事务中正确的部分进行提交。所以你可以跑一遍代码，运行结果应该是 关羽，张飞。","user_name":"作者回复","comment_id":117372,"uid":"1306094","ip_address":"","utype":1,"ctime":1564106280,"user_name_real":"cy"}],"discussion_count":1,"race_medal":0,"score":"23038872198","product_id":100029501,"comment_content":"答案是：“关羽”<br>根据第十四篇-事务中原子性的描述：要不全部成功要不全部失败。<br><br>第一个事务成功插入“关羽”<br>第二个事务，第一条插入“张飞”成功，第二条插入“张飞”失败。<br>所以第二个事务整体回滚，一条“张飞”都没插入。<br>所以结果只有“关羽”","like_count":5,"discussions":[{"author":{"id":1306094,"avatar":"https://static001.geekbang.org/account/avatar/00/13/ed/ee/c4779b67.jpg","nickname":"cy","note":"","ucode":"50D653399A31F6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":459935,"discussion_content":"对事务ACID的理解是这样的，不过在程序中是需要自己来控制的，如果遇到了错误，还继续执行COMMIT的话，也会让事务中正确的部分进行提交。所以你可以跑一遍代码，运行结果应该是 关羽，张飞。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564106280,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":116779,"user_name":"ack","can_delete":false,"product_type":"c1","uid":1440912,"ip_address":"","ucode":"69CA1233EEA8E2","user_header":"https://static001.geekbang.org/account/avatar/00/15/fc/90/c9df0459.jpg","comment_is_top":false,"comment_ctime":1563925990,"is_pvip":false,"replies":[{"id":"63637","content":"如果出现异常，这时强制提交的话， 会将操作成功的进行提交","user_name":"作者回复","comment_id":116779,"uid":"1306094","ip_address":"","utype":1,"ctime":1577525857,"user_name_real":"cy"}],"discussion_count":3,"race_medal":0,"score":"18743795174","product_id":100029501,"comment_content":"思考题：<br>自己想出来是只有关羽一条，因为name是主键，插入两条导致第二个事务回滚。但实际运行后结果是关羽、张飞。不知道是为什么，望老师解答。（mysql的autocommit=1，隔离级别是可重复读）","like_count":4,"discussions":[{"author":{"id":1306094,"avatar":"https://static001.geekbang.org/account/avatar/00/13/ed/ee/c4779b67.jpg","nickname":"cy","note":"","ucode":"50D653399A31F6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":459681,"discussion_content":"如果出现异常，这时强制提交的话， 会将操作成功的进行提交","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577525857,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1028805,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b2/c5/6ae0be56.jpg","nickname":"木偶人King","note":"","ucode":"0BDCA51E6F0B76","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":3050,"discussion_content":"这个老师已经说明了。   如果出现异常。强制提交。 会将操作成功没有异常的进行提交。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564133321,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1127175,"avatar":"https://static001.geekbang.org/account/avatar/00/11/33/07/8f351609.jpg","nickname":"JustDoDT","note":"","ucode":"6AF0B80F00EAEF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":2788,"discussion_content":"事务隔离级别为可重复度。\n当前连接（操作人小王）：会产生幻读，读到两条信息。\n别的连接（操作人小李）：不会产生幻读，会只读到一条信息。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1563936070,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":116739,"user_name":"Cue","can_delete":false,"product_type":"c1","uid":1516991,"ip_address":"","ucode":"A5CB460B54FDB0","user_header":"https://static001.geekbang.org/account/avatar/00/17/25/bf/1e9c853f.jpg","comment_is_top":false,"comment_ctime":1563898397,"is_pvip":false,"replies":[{"id":"47680","content":"感谢","user_name":"作者回复","comment_id":116739,"uid":"1306094","ip_address":"","utype":1,"ctime":1566902325,"user_name_real":"cy"}],"discussion_count":1,"race_medal":0,"score":"18743767581","product_id":100029501,"comment_content":"很详细的答疑，赞","like_count":4,"discussions":[{"author":{"id":1306094,"avatar":"https://static001.geekbang.org/account/avatar/00/13/ed/ee/c4779b67.jpg","nickname":"cy","note":"","ucode":"50D653399A31F6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":459666,"discussion_content":"感谢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566902325,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":121445,"user_name":"Geek_7777","can_delete":false,"product_type":"c1","uid":1578271,"ip_address":"","ucode":"FC5FFB3DE50BB4","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLTOaSibFSEnoB5c0qdG7g9Eia5f2xONMbWYmnpQZTYrSqUUMnG984jFVGyVG8px3oSDVUIXj185VEA/132","comment_is_top":false,"comment_ctime":1565140591,"is_pvip":false,"replies":[{"id":"63573","content":"OLAP更偏数据分析，业务端，比如 Apache Kylin","user_name":"作者回复","comment_id":121445,"uid":"1306094","ip_address":"","utype":1,"ctime":1577518770,"user_name_real":"cy"}],"discussion_count":1,"race_medal":0,"score":"14450042479","product_id":100029501,"comment_content":"OLAP可以详细讲一下么？","like_count":3,"discussions":[{"author":{"id":1306094,"avatar":"https://static001.geekbang.org/account/avatar/00/13/ed/ee/c4779b67.jpg","nickname":"cy","note":"","ucode":"50D653399A31F6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":461795,"discussion_content":"OLAP更偏数据分析，业务端，比如 Apache Kylin","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577518770,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":117269,"user_name":"一叶知秋","can_delete":false,"product_type":"c1","uid":1445189,"ip_address":"","ucode":"15A95FA86B7AE4","user_header":"https://static001.geekbang.org/account/avatar/00/16/0d/45/b88a1794.jpg","comment_is_top":false,"comment_ctime":1564017571,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"14448919459","product_id":100029501,"comment_content":"老师 我也想问个问题。。。<br>之前提到过SQL执行的顺序是：FROM &gt; WHERE &gt; GROUP BY &gt; HAVING &gt; SELECT 的字段 &gt; DISTINCT &gt; ORDER BY &gt; LIMIT<br>1）既然limit是最后执行的那么为何limit可以避免全表扫描。<br>2) 假如select的字段不包含order by字段那么是否在distinct产生的虚拟表上还要添加列？","like_count":3,"discussions":[{"author":{"id":1445189,"avatar":"https://static001.geekbang.org/account/avatar/00/16/0d/45/b88a1794.jpg","nickname":"一叶知秋","note":"","ucode":"15A95FA86B7AE4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":2937,"discussion_content":"第一个问题，我自己的思考是limit只会避免全表扫描最终的虚拟表。。不知道对不对\n第二问题。。。我还没想明白，","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564046138,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":117218,"user_name":"庞鑫华","can_delete":false,"product_type":"c1","uid":1114368,"ip_address":"","ucode":"2A4B9FD568ADF7","user_header":"https://static001.geekbang.org/account/avatar/00/11/01/00/326f3d4d.jpg","comment_is_top":false,"comment_ctime":1564011599,"is_pvip":false,"replies":[{"id":"63630","content":"SELECT DISTINCT player_id, player_name, count(*) as num #顺序5<br>FROM player JOIN team ON player.team_id = team.team_id #顺序1<br>WHERE height &gt; 1.80 #顺序2<br>GROUP BY player.team_id #顺序3<br>HAVING num &gt; 2 #顺序4<br>ORDER BY num DESC #顺序6<br>LIMIT 2 #顺序7","user_name":"作者回复","comment_id":117218,"uid":"1306094","ip_address":"","utype":1,"ctime":1577525565,"user_name_real":"cy"}],"discussion_count":1,"race_medal":0,"score":"14448913487","product_id":100029501,"comment_content":"老师，请问join查询，on后面的条件、连接条件，where后面的条件，数据过滤顺序是怎样的呢？","like_count":3,"discussions":[{"author":{"id":1306094,"avatar":"https://static001.geekbang.org/account/avatar/00/13/ed/ee/c4779b67.jpg","nickname":"cy","note":"","ucode":"50D653399A31F6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":459866,"discussion_content":"SELECT DISTINCT player_id, player_name, count(*) as num #顺序5\nFROM player JOIN team ON player.team_id = team.team_id #顺序1\nWHERE height &amp;gt; 1.80 #顺序2\nGROUP BY player.team_id #顺序3\nHAVING num &amp;gt; 2 #顺序4\nORDER BY num DESC #顺序6\nLIMIT 2 #顺序7","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577525565,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":116904,"user_name":"mickey","can_delete":false,"product_type":"c1","uid":1051663,"ip_address":"","ucode":"8B490C2DDE4010","user_header":"https://static001.geekbang.org/account/avatar/00/10/0c/0f/93d1c8eb.jpg","comment_is_top":false,"comment_ctime":1563937021,"is_pvip":false,"replies":[{"id":"43074","content":"正确","user_name":"作者回复","comment_id":116904,"uid":"1306094","ip_address":"","utype":1,"ctime":1564104815,"user_name_real":"cy"}],"discussion_count":1,"race_medal":0,"score":"14448838909","product_id":100029501,"comment_content":"答案是<br><br>name<br>关羽<br>张飞","like_count":3,"discussions":[{"author":{"id":1306094,"avatar":"https://static001.geekbang.org/account/avatar/00/13/ed/ee/c4779b67.jpg","nickname":"cy","note":"","ucode":"50D653399A31F6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":459725,"discussion_content":"正确","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564104815,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":116953,"user_name":"NO.9","can_delete":false,"product_type":"c1","uid":1336970,"ip_address":"","ucode":"B92F14B493406F","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/fUDCLLob6DFS8kZcMUfxOc4qQHeQfW4rIMK5Ty2u2AqLemcdhVRw7byx85HrVicSvy5AiabE0YGMj5gVt8ibgrusA/132","comment_is_top":false,"comment_ctime":1563944984,"is_pvip":false,"replies":[{"id":"43084","content":"对的，可以使用hint，不同DBMS方法略有不同：<br>Oracle：&#47;*+ index(索引名称) *&#47;<br>SQL Serve：WITH (INDEX(索引名称))<br>MySQL：FORCE INDEX(索引名称)<br><br>比如我们查询player表的时候想要强制使用player_name进行索引，可以写成：<br>Oracle: SELECT &#47;*+ INDEX(player_name) *&#47; FROM player<br>SQL Server: SELECT player_id, team_id, player_name FROM player WITH(INDEX(player_name))<br>MySQL：SELECT player_id, team_id, player_name FROM player FORCE INDEX(player_name)<br>","user_name":"作者回复","comment_id":116953,"uid":"1306094","ip_address":"","utype":1,"ctime":1564106144,"user_name_real":"cy"}],"discussion_count":2,"race_medal":0,"score":"10153879576","product_id":100029501,"comment_content":"在sql语句里 怎么指定使用哪个索引呢？<br>是像oracle里那样用hint么？","like_count":2,"discussions":[{"author":{"id":1306094,"avatar":"https://static001.geekbang.org/account/avatar/00/13/ed/ee/c4779b67.jpg","nickname":"cy","note":"","ucode":"50D653399A31F6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":459750,"discussion_content":"对的，可以使用hint，不同DBMS方法略有不同：\nOracle：/*+ index(索引名称) */\nSQL Serve：WITH (INDEX(索引名称))\nMySQL：FORCE INDEX(索引名称)\n\n比如我们查询player表的时候想要强制使用player_name进行索引，可以写成：\nOracle: SELECT /*+ INDEX(player_name) */ FROM player\nSQL Server: SELECT player_id, team_id, player_name FROM player WITH(INDEX(player_name))\nMySQL：SELECT player_id, team_id, player_name FROM player FORCE INDEX(player_name)\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564106144,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1307855,"avatar":"https://static001.geekbang.org/account/avatar/00/13/f4/cf/2af390ad.jpg","nickname":"511","note":"","ucode":"AB0D3907F4EA39","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":2825,"discussion_content":"force index(index_name)","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1563957907,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":270060,"user_name":"上善若水","can_delete":false,"product_type":"c1","uid":1565462,"ip_address":"","ucode":"7E783812D2D164","user_header":"https://static001.geekbang.org/account/avatar/00/17/e3/16/0e476be6.jpg","comment_is_top":false,"comment_ctime":1608888837,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5903856133","product_id":100029501,"comment_content":"查询结果是：关羽 张飞。 但数据库里其实是关羽，张飞是幻读了","like_count":1},{"had_liked":false,"id":256580,"user_name":"Geek_b88c9a","can_delete":false,"product_type":"c1","uid":1772461,"ip_address":"","ucode":"A23A335495416C","user_header":"","comment_is_top":false,"comment_ctime":1603683013,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5898650309","product_id":100029501,"comment_content":"请问老师每次执行DROP TABLE IF EXISTS test 这句的时候都特别慢是什么原因呢？","like_count":1},{"had_liked":false,"id":154361,"user_name":"不似旧日","can_delete":false,"product_type":"c1","uid":1161271,"ip_address":"","ucode":"DF4C5E3AB9570C","user_header":"https://static001.geekbang.org/account/avatar/00/11/b8/37/98991aeb.jpg","comment_is_top":false,"comment_ctime":1574415160,"is_pvip":false,"replies":[{"id":"59722","content":"慢慢来","user_name":"作者回复","comment_id":154361,"uid":"1306094","ip_address":"","utype":1,"ctime":1574737850,"user_name_real":"cy"}],"discussion_count":1,"race_medal":0,"score":"5869382456","product_id":100029501,"comment_content":"好复杂哦  <br>","like_count":1,"discussions":[{"author":{"id":1306094,"avatar":"https://static001.geekbang.org/account/avatar/00/13/ed/ee/c4779b67.jpg","nickname":"cy","note":"","ucode":"50D653399A31F6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":475443,"discussion_content":"慢慢来","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574737850,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":121623,"user_name":"神码也不懂","can_delete":false,"product_type":"c1","uid":1063310,"ip_address":"","ucode":"2DA7453BAA0293","user_header":"https://static001.geekbang.org/account/avatar/00/10/39/8e/4439066c.jpg","comment_is_top":false,"comment_ctime":1565169054,"is_pvip":false,"replies":[{"id":"63569","content":"对 但是多张表连接顺序不同，导致的计算量也是不同的，所以即使都会有笛卡尔积，也还是存在个优化问题","user_name":"作者回复","comment_id":121623,"uid":"1306094","ip_address":"","utype":1,"ctime":1577518504,"user_name_real":"cy"}],"discussion_count":1,"race_medal":0,"score":"5860136350","product_id":100029501,"comment_content":"老师 我问个问题，SQL的执行顺序 1、from 2、join 3、on 4、where 5、group by 6、having 7、select；其中第一步是首先对from子句前连个表执行一个笛卡儿积，生成虚拟表vt1，第二部对vt1应用on筛选器；我的问题是：如果这样的话那是不是笛卡儿积是不是无论怎么优化，只要表连接一定会有笛卡儿积？  麻烦老师有时间的时候帮我解答一下，谢谢老师","like_count":1,"discussions":[{"author":{"id":1306094,"avatar":"https://static001.geekbang.org/account/avatar/00/13/ed/ee/c4779b67.jpg","nickname":"cy","note":"","ucode":"50D653399A31F6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":461883,"discussion_content":"对 但是多张表连接顺序不同，导致的计算量也是不同的，所以即使都会有笛卡尔积，也还是存在个优化问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577518504,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":117189,"user_name":"Goal","can_delete":false,"product_type":"c1","uid":1307012,"ip_address":"","ucode":"C337CD4C7E07B0","user_header":"https://static001.geekbang.org/account/avatar/00/13/f1/84/7d21bd9e.jpg","comment_is_top":false,"comment_ctime":1563984452,"is_pvip":false,"replies":[{"id":"43071","content":"哈哈 这时专栏里的一个同学举的例子，我觉得不错，挺好的说明了通配符的使用","user_name":"作者回复","comment_id":117189,"uid":"1306094","ip_address":"","utype":1,"ctime":1564104183,"user_name_real":"cy"}],"discussion_count":1,"race_medal":0,"score":"5858951748","product_id":100029501,"comment_content":"太乙真人太太，真开心，哈哈哈。","like_count":1,"discussions":[{"author":{"id":1306094,"avatar":"https://static001.geekbang.org/account/avatar/00/13/ed/ee/c4779b67.jpg","nickname":"cy","note":"","ucode":"50D653399A31F6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":459853,"discussion_content":"哈哈 这时专栏里的一个同学举的例子，我觉得不错，挺好的说明了通配符的使用","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564104183,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":117080,"user_name":"Ronnyz","can_delete":false,"product_type":"c1","uid":1488280,"ip_address":"","ucode":"9F34527B1D343D","user_header":"https://static001.geekbang.org/account/avatar/00/16/b5/98/ffaf2aca.jpg","comment_is_top":false,"comment_ctime":1563964052,"is_pvip":false,"replies":[{"id":"43072","content":"对的 答案正确，是关羽，张飞","user_name":"作者回复","comment_id":117080,"uid":"1306094","ip_address":"","utype":1,"ctime":1564104271,"user_name_real":"cy"}],"discussion_count":1,"race_medal":0,"score":"5858931348","product_id":100029501,"comment_content":"作业：关羽 张飞","like_count":1,"discussions":[{"author":{"id":1306094,"avatar":"https://static001.geekbang.org/account/avatar/00/13/ed/ee/c4779b67.jpg","nickname":"cy","note":"","ucode":"50D653399A31F6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":459810,"discussion_content":"对的 答案正确，是关羽，张飞","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564104271,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":116900,"user_name":"liuyyy","can_delete":false,"product_type":"c1","uid":1158611,"ip_address":"","ucode":"AAA3922482E4F7","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83ercic1LB9N9P1lWftkyyNqjILPAedlbRqvJl2KNTrDFCboiakKoTHPBTF3ufaIsdcLb9uXU8hFlptuw/132","comment_is_top":false,"comment_ctime":1563936338,"is_pvip":false,"replies":[{"id":"63635","content":"多个索引，就是多种检索方式，比python的数据结构要复杂一些。因为你用SQL检索数据的时候，不同的SQL查询，可能采用的索引方式不同，所以你可以实现定义出来哪些字段可以被设置为索引，方便后续查询时使用","user_name":"作者回复","comment_id":116900,"uid":"1306094","ip_address":"","utype":1,"ctime":1577525799,"user_name_real":"cy"}],"discussion_count":1,"race_medal":0,"score":"5858903634","product_id":100029501,"comment_content":"老师我想问下索引，你文中多次提到了这个，还包括二级索引，添加索引等，我理解的索引就只有像python中的index等，为什么还有多个索引这个说法呢","like_count":1,"discussions":[{"author":{"id":1306094,"avatar":"https://static001.geekbang.org/account/avatar/00/13/ed/ee/c4779b67.jpg","nickname":"cy","note":"","ucode":"50D653399A31F6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":459723,"discussion_content":"多个索引，就是多种检索方式，比python的数据结构要复杂一些。因为你用SQL检索数据的时候，不同的SQL查询，可能采用的索引方式不同，所以你可以实现定义出来哪些字段可以被设置为索引，方便后续查询时使用","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577525799,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":357091,"user_name":"年少挽滑稽世无双","can_delete":false,"product_type":"c1","uid":2962599,"ip_address":"四川","ucode":"793DCBDE25A07B","user_header":"https://static001.geekbang.org/account/avatar/00/2d/34/a7/52c4ea60.jpg","comment_is_top":false,"comment_ctime":1662950738,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1662950738","product_id":100029501,"comment_content":"答案：<br>name<br>关羽<br>张飞<br>不过，这里要注意commit要单独执行，强制提交。","like_count":0},{"had_liked":false,"id":334846,"user_name":"追风筝的人","can_delete":false,"product_type":"c1","uid":1488020,"ip_address":"","ucode":"2993D60F94C396","user_header":"https://static001.geekbang.org/account/avatar/00/16/b4/94/2796de72.jpg","comment_is_top":false,"comment_ctime":1645154319,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1645154319","product_id":100029501,"comment_content":"SELECT COUNT(*)＞ SELECT COUNT(1)＞ SELECT COUNT(具体字段)。","like_count":0},{"had_liked":false,"id":229406,"user_name":"陈柏林","can_delete":false,"product_type":"c1","uid":1282562,"ip_address":"","ucode":"2636649821FAB9","user_header":"https://static001.geekbang.org/account/avatar/00/13/92/02/288a6b8c.jpg","comment_is_top":false,"comment_ctime":1592986273,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1592986273","product_id":100029501,"comment_content":"有一些出现问题,在表中只有一条记录的老哥,试试别用Navicat查询界面,用命令行试试,有不一样的结果,有可能是navicat自己做了一个处理.","like_count":0},{"had_liked":false,"id":207914,"user_name":"傻傻的帅","can_delete":false,"product_type":"c1","uid":1668617,"ip_address":"","ucode":"14A795523A682E","user_header":"https://static001.geekbang.org/account/avatar/00/19/76/09/62a10668.jpg","comment_is_top":false,"comment_ctime":1587215232,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1587215232","product_id":100029501,"comment_content":"结果没什么异议：关羽，张飞；<br>分析：begin开启一个事务，插入关羽<br>          begin开启第二个事务，隐式提交之前的事务，<br>          在插入第一个张飞的时候，应该是先判断是否唯一，由于表中没有这个值，所以插入成功，<br>          在第二个插入语句中，先判断名字是否重复，结果发现表中已经存在相同的数据了，因此抛出异常，没有发生插入操作，也不存在回滚操作<br>           然后commit提交，因此最后表里存在两条记录","like_count":0},{"had_liked":false,"id":206518,"user_name":"ballgod","can_delete":false,"product_type":"c1","uid":1584098,"ip_address":"","ucode":"C20E95E98EAC43","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIR9QrAn9TZOrJMSYMyN96PAuAjETVrN5SPp3hMbfUAGIWtHceWPEoQtPdXeuBn7VB7dagtxynAIA/132","comment_is_top":false,"comment_ctime":1586873615,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1586873615","product_id":100029501,"comment_content":"最后的问题，为什么select的结果是张飞和关羽，但是在test表中查看只有关于？？","like_count":0,"discussions":[{"author":{"id":2015869,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/T1yWWsOsVjpw9URXBMv86D2FmEVjAE7BStgZlGsEFbzl8DLupTDvIE4JXd7S4DPPY5YXNGhciaZMM2BOVxCpSEw/132","nickname":"苏打饼干","note":"","ucode":"F1FD934B3EA027","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":281845,"discussion_content":"我的navicate报错了，应该是隔离级别没设置好。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591833586,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":195289,"user_name":"track6688","can_delete":false,"product_type":"c1","uid":1088040,"ip_address":"","ucode":"0A9E893F8FD379","user_header":"https://static001.geekbang.org/account/avatar/00/10/9a/28/03613c22.jpg","comment_is_top":false,"comment_ctime":1585154134,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1585154134","product_id":100029501,"comment_content":"复习了一遍SQL基础，老师总结的很好。都是精华。除了SQL本身的知识之外，我想还要学习老师的总结思路。每个小节的脑图也是一特色。继续往前学。。。。","like_count":0},{"had_liked":false,"id":178610,"user_name":"David.cui","can_delete":false,"product_type":"c1","uid":1302228,"ip_address":"","ucode":"AB46F310403612","user_header":"https://static001.geekbang.org/account/avatar/00/13/de/d4/b83c4185.jpg","comment_is_top":false,"comment_ctime":1581758830,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1581758830","product_id":100029501,"comment_content":"select count(*)和count(1)不同数据库实现起来是不一样的,不能下结论","like_count":0},{"had_liked":false,"id":154378,"user_name":"不似旧日","can_delete":false,"product_type":"c1","uid":1161271,"ip_address":"","ucode":"DF4C5E3AB9570C","user_header":"https://static001.geekbang.org/account/avatar/00/11/b8/37/98991aeb.jpg","comment_is_top":false,"comment_ctime":1574418226,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1574418226","product_id":100029501,"comment_content":"如果你可以确定结果集只有一条，那么加上LIMIT 1的时候，当找到一条结果的时候就不会继续扫描了，这样会加快查询速度。 多一条少一条效率真真真可以忽略不计","like_count":0},{"had_liked":false,"id":144021,"user_name":"右耳朵猫咪","can_delete":false,"product_type":"c1","uid":1014984,"ip_address":"","ucode":"3AB186CC780FBB","user_header":"https://static001.geekbang.org/account/avatar/00/0f/7c/c8/8627f5c1.jpg","comment_is_top":false,"comment_ctime":1571825780,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1571825780","product_id":100029501,"comment_content":"请问如何防止很多left join？","like_count":0},{"had_liked":false,"id":118459,"user_name":"出招吧","can_delete":false,"product_type":"c1","uid":1573369,"ip_address":"","ucode":"4B1C9796BF01AB","user_header":"https://static001.geekbang.org/account/avatar/00/18/01/f9/85facaca.jpg","comment_is_top":false,"comment_ctime":1564368587,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1564368587","product_id":100029501,"comment_content":"MySQL 5.7 测试是只有一条关羽的数据插入成功，第二个begin隐式提交了第一条，然而第二个事务中途失败回滚了，相当于张飞的数据没有插入成功。","like_count":0},{"had_liked":false,"id":117437,"user_name":"Geek_c76f38","can_delete":false,"product_type":"c1","uid":1563124,"ip_address":"","ucode":"926EDF9B1BF4DA","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTK009KMmXKFVeR6ja1dDB69lZEbUiabA8r8QnChtcIEWsqsO42opsXQ7A9pnezCz38lqbuKxrczCMA/132","comment_is_top":false,"comment_ctime":1564046823,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1564046823","product_id":100029501,"comment_content":"请教一个sql如何在一个表里间隔固定刚修改数据，如每间隔3行将一个字段设置成0?","like_count":0,"discussions":[{"author":{"id":1412994,"avatar":"https://static001.geekbang.org/account/avatar/00/15/8f/82/374f43a1.jpg","nickname":"假装自己不胖","note":"","ucode":"308F1BAA96CDA5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":200773,"discussion_content":"可以全部查,然后根据某个字段排序之后,然后赋予一个递增的常量,根据结果集的常量来取模,和id,就可以修改了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583720501,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":117255,"user_name":"苏籍","can_delete":false,"product_type":"c1","uid":1396252,"ip_address":"","ucode":"4FA289E084B789","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erYNBIwAj3KdIXaXbeMBUjTMz31zAToHIJSdo7oQk8bfsibwViaLobVQ8miatwBlC5spLS9kVCzHMjUA/132","comment_is_top":false,"comment_ctime":1564016159,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1564016159","product_id":100029501,"comment_content":"对于COUNT 这个有些困惑<br>1、老师你说，聚簇索引比二级索引信息多？是指的什么信息多，它是怎么导致使用主键索引慢了呢","like_count":0,"discussions":[{"author":{"id":1507657,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/VF22kbprrVk1gTYnEaSvVyvJPaG249icNkvBtVSwWZPkR0gIVf0ObOiaAib1mCUyia8zEJXcicqzgYibtYFJfWKVVcKA/132","nickname":"Geek_f8cd05","note":"","ucode":"FEBE700704F0B0","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":20331,"discussion_content":"聚簇索引下的叶子节点是整行记录，而二级索引的叶子节点是主键id，所以信息相对二级索引信息多","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1569302304,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":117215,"user_name":"庞鑫华","can_delete":false,"product_type":"c1","uid":1114368,"ip_address":"","ucode":"2A4B9FD568ADF7","user_header":"https://static001.geekbang.org/account/avatar/00/11/01/00/326f3d4d.jpg","comment_is_top":false,"comment_ctime":1564011310,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1564011310","product_id":100029501,"comment_content":"老师，能否举例说明一条复杂sql的查询解析过程，包括join操作的","like_count":0},{"had_liked":false,"id":116899,"user_name":"JustDoDT","can_delete":false,"product_type":"c1","uid":1127175,"ip_address":"","ucode":"6AF0B80F00EAEF","user_header":"https://static001.geekbang.org/account/avatar/00/11/33/07/8f351609.jpg","comment_is_top":false,"comment_ctime":1563936118,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1563936118","product_id":100029501,"comment_content":"思考题：<br>事务隔离级别为可重复度。<br>当前连接（操作人小王）：会产生幻读，读到两条信息。<br>别的连接（操作人小李）：不会产生幻读，会只读到一条信息。","like_count":0},{"had_liked":false,"id":116884,"user_name":"一叶知秋","can_delete":false,"product_type":"c1","uid":1445189,"ip_address":"","ucode":"15A95FA86B7AE4","user_header":"https://static001.geekbang.org/account/avatar/00/16/0d/45/b88a1794.jpg","comment_is_top":false,"comment_ctime":1563934136,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1563934136","product_id":100029501,"comment_content":"关羽、张飞。<br>1）MySQL默认开始自动提交事务。那么第一条insert会自动提交。<br>2）set autocommit=0; 结果一致, 因为没有写rollback 只有commit 因此仍会执行可执行的SQL不会导致整个事务的回滚。","like_count":0},{"had_liked":false,"id":116852,"user_name":"柯察金","can_delete":false,"product_type":"c1","uid":1115149,"ip_address":"","ucode":"F722BF8FCD2C47","user_header":"https://static001.geekbang.org/account/avatar/00/11/04/0d/3dc5683a.jpg","comment_is_top":false,"comment_ctime":1563931866,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1563931866","product_id":100029501,"comment_content":"老师，我问下，union 左右的两个子句是按照顺序执行的，还是并发执行的啊","like_count":0},{"had_liked":false,"id":116847,"user_name":"往事随风，顺其自然","can_delete":false,"product_type":"c1","uid":1235692,"ip_address":"","ucode":"F266EC6B143E38","user_header":"https://static001.geekbang.org/account/avatar/00/12/da/ec/779c1a78.jpg","comment_is_top":false,"comment_ctime":1563931430,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1563931430","product_id":100029501,"comment_content":"上面那个回滚的test 表，我验证一条记录也没有，并没有关羽那条记录默认提交，这个是怎么回事，和老师说的不符合","like_count":0,"discussions":[{"author":{"id":1412994,"avatar":"https://static001.geekbang.org/account/avatar/00/15/8f/82/374f43a1.jpg","nickname":"假装自己不胖","note":"","ucode":"308F1BAA96CDA5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":200777,"discussion_content":"你没有开启事务吧.. set autocommit,  ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583720840,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}