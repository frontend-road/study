{"id":485101,"title":"11 | å®¹å™¨å®‰å…¨ï¼šå¦‚ä½•ä½¿ç”¨eBPFå¢å¼ºå®¹å™¨å®‰å…¨ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å€ªæœ‹é£ã€‚</p><p>ä¸Šä¸€è®²ï¼Œæˆ‘ä»¥æœ€å¸¸è§çš„ç½‘ç»œä¸¢åŒ…ä¸ºä¾‹ï¼Œå¸¦ä½ ä¸€èµ·æ¢³ç†äº† eBPF æ‰€æä¾›çš„ç½‘ç»œåŠŸèƒ½ç‰¹æ€§ï¼Œå¹¶æ•™ä½ ä½¿ç”¨ bpftrace å¼€å‘äº†ä¸€ä¸ªè·Ÿè¸ªå†…æ ¸ç½‘ç»œåè®®æ ˆçš„ eBPF ç¨‹åºã€‚è™½ç„¶ eBPF èµ·æºäºç½‘ç»œè¿‡æ»¤ï¼Œå¹¶ä¸”ç½‘ç»œè¿‡æ»¤ä¹Ÿæ˜¯ eBPF åº”ç”¨æœ€ä¸ºå¹¿æ³›çš„ä¸€ä¸ªé¢†åŸŸï¼Œä½†å…¶å® eBPF çš„åº”ç”¨å·²ç»è¿œè¿œè¶…å‡ºäº†è¿™ä¸€èŒƒç•´ã€‚æ•…éšœè¯Šæ–­ã€ç½‘ç»œä¼˜åŒ–ã€å®‰å…¨æ§åˆ¶ã€æ€§èƒ½ç›‘æ§ç­‰ï¼Œéƒ½å·²æ˜¯ eBPF çš„ä¸»æˆ˜åœºã€‚</p><p>éšç€å®¹å™¨å’Œäº‘åŸç”ŸæŠ€æœ¯çš„æ™®åŠï¼Œç”±äºå®¹å™¨å¤©ç”Ÿå…±äº«å†…æ ¸çš„ç‰¹æ€§ï¼Œå®¹å™¨çš„å®‰å…¨å’Œéš”ç¦»å°±æ˜¯æ‰€æœ‰å®¹å™¨å¹³å°å¤´ä¸Šçš„â€œç´§ç®å’’â€ã€‚å› æ­¤ï¼Œå¦‚ä½•å¿«é€Ÿå®šä½å®¹å™¨å®‰å…¨é—®é¢˜ï¼Œå¦‚ä½•ç¡®ä¿å®¹å™¨çš„éš”ç¦»ï¼Œä»¥åŠå¦‚ä½•é¢„é˜²å®¹å™¨å®‰å…¨æ¼æ´ç­‰ï¼Œæ˜¯æ¯ä¸ªå®¹å™¨å¹³å°éƒ½éœ€è¦è§£å†³çš„å¤´å·é—®é¢˜ã€‚</p><p>æ—¢ç„¶å®¹å™¨æ˜¯å…±äº«å†…æ ¸çš„ï¼Œè¿™äº›å®‰å…¨é—®é¢˜çš„è§£å†³è‡ªç„¶å°±å¯ä»¥ä»å†…æ ¸çš„è§’åº¦è¿›è¡Œè€ƒè™‘ã€‚é™¤äº†å®¹å™¨è‡ªèº«æ‰€å¼ºä¾èµ–çš„å‘½åç©ºé—´ã€cgroupsã€Linux æƒé™æ§åˆ¶ Capabilities ä¹‹å¤–ï¼Œå¯ä»¥åŠ¨æ€è·Ÿè¸ªå’Œæ‰©å±•å†…æ ¸çš„ eBPF å°±æˆä¸ºäº†å®‰å…¨ç›‘æ§å’Œå®‰å…¨æ§åˆ¶çš„ä¸»è¦æ‰‹æ®µä¹‹ä¸€ã€‚ Sysdigã€Aqua Securityã€Datadog ç­‰ä¸šå†…çŸ¥åçš„å®¹å™¨å®‰å…¨è§£å†³æ–¹æ¡ˆï¼Œéƒ½åŸºäº eBPF æ„å»ºäº†ä¸°å¯Œçš„å®‰å…¨ç‰¹æ€§ã€‚</p><p>é‚£ä¹ˆï¼Œåˆ°åº•å¦‚ä½•ä½¿ç”¨ eBPF æ¥ç›‘æ§å®¹å™¨çš„å®‰å…¨é—®é¢˜ï¼Œåˆå¦‚ä½•ä½¿ç”¨ eBPF é˜»æ­¢å®¹å™¨ä¸­çš„æ¶æ„è¡Œä¸ºå‘¢ï¼Ÿä»Šå¤©ï¼Œæˆ‘å°±å¸¦ä½ ä¸€èµ·æ¥çœ‹çœ‹å¦‚ä½•å€ŸåŠ© eBPF æ¥å¢å¼ºå®¹å™¨å®‰å…¨ã€‚</p><!-- [[[read_end]]] --><h2>eBPF éƒ½æœ‰å“ªäº›å®‰å…¨èƒ½åŠ›ï¼Ÿ</h2><p>å®‰å…¨è¿™ä¸ªè¯é€šå¸¸åŒ…å«äº†éå¸¸å¹¿æ³›çš„ä»»åŠ¡ï¼ŒåŒ…æ‹¬å®‰å…¨é—®é¢˜çš„åˆ†æä¸è¯Šæ–­ã€å®‰å…¨äº‹ä»¶çš„æ£€æµ‹ï¼Œä»¥åŠå®‰å…¨ç­–ç•¥çš„æ‰§è¡Œç­‰ã€‚é’ˆå¯¹è¿™äº›ä»»åŠ¡ï¼ŒeBPF åˆæä¾›äº†å“ªäº›å®‰å…¨èƒ½åŠ›å‘¢ï¼Ÿ</p><p>é¦–å…ˆï¼Œå¯¹äº<strong>å®‰å…¨é—®é¢˜çš„åˆ†æä¸è¯Šæ–­</strong>ï¼ŒeBPF æ— éœ€ä¿®æ”¹å¹¶é‡æ–°ç¼–è¯‘å†…æ ¸å’Œåº”ç”¨å°±å¯ä»¥åŠ¨æ€åˆ†æå†…æ ¸åŠåº”ç”¨çš„è¡Œä¸ºã€‚è¿™åœ¨å¾ˆå¤šéœ€è¦ä¿ç•™å®‰å…¨é—®é¢˜ç°åœºçš„æƒ…å†µä¸‹éå¸¸æœ‰ç”¨ã€‚ç‰¹åˆ«æ˜¯åœ¨ç´§æ€¥å®‰å…¨äº‹ä»¶çš„å¤„ç†è¿‡ç¨‹ä¸­ï¼ŒeBPF å¯ä»¥å®æ—¶æ¢æµ‹è¿›ç¨‹æˆ–å†…æ ¸ä¸­çš„å¯ç–‘è¡Œä¸ºï¼Œè¿›è€Œå¸®ä½ æ›´å¿«åœ°å®šä½å®‰å…¨é—®é¢˜çš„æ ¹æºã€‚</p><p>æ¯”å¦‚ï¼ŒAqua Security å¼€æºçš„ <a href=\"https://aquasecurity.github.io/tracee/dev/\">Tracee</a> é¡¹ç›®å°±åˆ©ç”¨ eBPFï¼ŒåŠ¨æ€è·Ÿè¸ªç³»ç»Ÿå’Œåº”ç”¨çš„å¯ç–‘è¡Œä¸ºæ¨¡å¼ï¼Œå†ä¸ä¸æ–­ä¸°å¯Œçš„ç‰¹å¾æ£€æµ‹åº“è¿›è¡ŒåŒ¹é…ï¼Œå°±å¯ä»¥åˆ†æå‡ºå®¹å™¨åº”ç”¨ä¸­çš„å®‰å…¨é—®é¢˜ã€‚ä¸‹é¢æ˜¯ Tracee çš„å·¥ä½œåŸç†ç¤ºæ„å›¾ï¼ˆå›¾ç‰‡æ¥è‡ª <a href=\"https://aquasecurity.github.io/tracee/dev/architecture/\">Tracee æ–‡æ¡£</a>ï¼‰ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/a9/6f/a97a6b3e5077c13fbcb346f217c0a96f.png?wh=1340x853\" alt=\"å›¾ç‰‡\" title=\"Tracee åŸç†ç¤ºæ„å›¾\"></p><p>å…¶æ¬¡ï¼Œå¯¹äº<strong>å®‰å…¨äº‹ä»¶çš„ç›‘æµ‹</strong>ï¼ŒeBPF çš„äº‹ä»¶è§¦å‘æœºåˆ¶ä¸ä»…å¯ä»¥ç”¨æä½çš„å¼€é”€ï¼ŒåŠ¨æ€ç›‘æµ‹å†…æ ¸å’Œåº”ç”¨ç¨‹åºä¸­çš„å„ç±»å®‰å…¨äº‹ä»¶ï¼Œæ›´å¯ä»¥é¿å…å…¶ä»–åŸºäºé‡‡æ ·æˆ–ç»Ÿè®¡æœºåˆ¶çš„å®‰å…¨æ£€æµ‹ç³»ç»Ÿä¸­ç»å¸¸å‘ç”Ÿçš„å®‰å…¨äº‹ä»¶æ¼æ£€é—®é¢˜ã€‚</p><p>å¦‚ä¸‹å›¾ï¼ˆå›¾ç‰‡æ¥è‡ª<a href=\"https://www.brendangregg.com/Slides/BSidesSF2017_BPF_security_monitoring.pdf\">brendangregg.com</a>ï¼‰æ‰€ç¤ºï¼Œkprobeã€uprobeã€tracepointã€USDT ç­‰å„ç±»æ¢é’ˆå·²ç»éå¸¸å…¨é¢åœ°æ¶µç›–äº†ä»åº”ç”¨åˆ°å†…æ ¸ä¸­çš„å„ç±»å®‰å…¨é—®é¢˜ç›¸å…³çš„è·Ÿè¸ªç‚¹ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/5e/6e/5e178ebbc7928a0cd2aff7243f24e96e.png?wh=1089x693\" alt=\"å›¾ç‰‡\" title=\"eBPF å®‰å…¨è·Ÿè¸ªç‚¹\"></p><p>æ¯”å¦‚ï¼ŒSysdig è´¡çŒ®ç»™ CNCF åŸºé‡‘ä¼šçš„ <a href=\"https://falco.org/\">Falco</a> é¡¹ç›®ï¼Œå°±åˆ©ç”¨ eBPF åœ¨è¿è¡Œæ—¶ç›‘æµ‹å†…æ ¸å’Œåº”ç”¨ä¸­æ˜¯å¦å‘ç”Ÿäº†è¯¸å¦‚ç‰¹æƒæå‡ã€SHELL å‘½ä»¤æ‰§è¡Œã€ç³»ç»Ÿæ–‡ä»¶ï¼ˆæ¯”å¦‚ <code>/etc/passwd</code>ï¼‰ä¿®æ”¹ã€SSH ç™»å½•ç­‰å¼‚å¸¸è¡Œä¸ºï¼Œå†é€šè¿‡å‘Šè­¦ç³»ç»Ÿå®æ—¶å°†è¿™äº›å®‰å…¨äº‹ä»¶åŠæ—¶æ¨é€ç»™ä½ ã€‚</p><p>æœ€åï¼Œå¯¹äº<strong>å®‰å…¨ç­–ç•¥çš„æ‰§è¡Œ</strong>ï¼Œå®‰å…¨è®¡ç®—ï¼ˆseccompï¼‰ã€Linux å®‰å…¨æ¨¡å—ï¼ˆLSMï¼‰ç­‰ Linux å·²æœ‰çš„å®‰å…¨æœºåˆ¶ï¼Œå‡å¯ä»¥é€šè¿‡ eBPF æ¥è¿›è¡Œå®‰å…¨å®¡è®¡å’Œå†³ç­–æ‰§è¡Œï¼Œé˜»æ­¢ç³»ç»Ÿå’Œè¿›ç¨‹ä¸­çš„éæ³•æ“ä½œï¼Œç”šè‡³å¯ä»¥é€šè¿‡è¾…åŠ©å‡½æ•° <code>bpf_send_signal()</code> ç›´æ¥æŠŠæœ‰å®‰å…¨éšæ‚£çš„è¿›ç¨‹æ€æ­»ã€‚åœ¨ç½‘ç»œå®‰å…¨æ–¹é¢ï¼ŒeBPF ä¸ä»…å¯ä»¥ç”¨æ¥å®æ—¶æ¢æµ‹å’Œè·Ÿè¸ªç½‘ç»œè¯·æ±‚ï¼Œæ›´å¯ä»¥åœ¨æ¢æµ‹åˆ°ç½‘ç»œæ”»å‡»ç­‰å±å®³è¡Œä¸ºæ—¶ç›´æ¥åœ¨ç½‘ç»œåè®®æ ˆä¹‹å‰ä¸¢å¼ƒæ•°æ®åŒ…ï¼Œä»è€Œå®ç°æé«˜çš„ç½‘ç»œæ€§èƒ½ã€‚</p><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆå›¾ç‰‡æ¥è‡ª KubeArmor <a href=\"https://docs.kubearmor.com/kubearmor/kubearmor-design\">æ–‡æ¡£</a>ï¼‰ï¼Œå®¹å™¨è¿è¡Œæ—¶å®‰å…¨ç³»ç»Ÿ <a href=\"https://kubearmor.com/\">KubeArmor</a> å°±åˆ©ç”¨ LSM å’Œ eBPFï¼Œé™åˆ¶å®¹å™¨ä¸­è¿›ç¨‹æ‰§è¡Œã€æ–‡ä»¶è®¿é—®ã€ç½‘ç»œè¿æ¥ç­‰å„ç§è¿åå®‰å…¨ç­–ç•¥çš„æ“ä½œã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/49/6d/49bd8dbce937eff08bcc40c12559df6d.png?wh=932x518\" alt=\"å›¾ç‰‡\" title=\"KubeArmor å·¥ä½œåŸç†\"></p><h2>å¦‚ä½•ä½¿ç”¨ eBPF åˆ†æå®¹å™¨çš„å®‰å…¨é—®é¢˜ï¼Ÿ</h2><p>æ—¢ç„¶å®¹å™¨è¿˜æ˜¯å…±äº«å†…æ ¸çš„ï¼Œè¿è¡Œåœ¨å†…æ ¸ä¸­çš„ eBPF ç¨‹åºè‡ªç„¶ä¹Ÿèƒ½å¤Ÿè·Ÿè¸ªå’Œåˆ†æå®¹å™¨ä¸­çš„åº”ç”¨ç¨‹åºã€‚ä½†ç”±äºå®¹å™¨åˆ©ç”¨ Linux çš„ namespace æœºåˆ¶è¿›è¡Œäº†éš”ç¦»ï¼Œå…¶è·Ÿè¸ªå’Œåˆ†ææ–¹æ³•åˆè·Ÿç›´æ¥è¿è¡Œåœ¨ä¸»æœºå†…çš„è¿›ç¨‹æœ‰äº›ä¸åŒã€‚</p><p>ä»¥è·Ÿè¸ªæ¶æ„ç¨‹åºçš„æ‰§è¡Œä¸ºä¾‹ï¼Œä¸ºäº†èº²é¿å®‰å…¨ç›‘æ§ï¼Œå¾ˆå¤šæ¶æ„ç¨‹åºå¹¶ä¸æ˜¯åœ¨å®¹å™¨ä¸€å¼€å§‹å¯åŠ¨çš„æ—¶å€™å°±è¿è¡Œäº†æ¶æ„è¿›ç¨‹ï¼Œè€Œæ˜¯å…ˆå¯åŠ¨ä¸€ä¸ªæ­£å¸¸ç¨‹åºï¼Œä¹‹åå†åˆ›å»ºæ–°çš„æ¶æ„è¿›ç¨‹ã€‚è¿™ç§åœºæ™¯ç‰¹åˆ«å®¹æ˜“å‡ºç°åœ¨å®¹å™¨å®‰å…¨æ¼æ´è¢«æ¶æ„è½¯ä»¶ä¾µå…¥çš„åœºæ™¯ã€‚</p><p>é‚£ä¹ˆï¼Œå¦‚ä½•ç”¨ eBPF æ¥åˆ†æè¿™ç±»å®‰å…¨é—®é¢˜å‘¢ï¼Ÿæˆ‘æƒ³ï¼Œä½ å¯èƒ½å·²ç»æƒ³èµ·æ¥äº†ï¼Œæˆ‘ä»¬è¯¾ç¨‹çš„ <a href=\"https://time.geekbang.org/column/article/484207\">07 è®²</a> å…¶å®å·²ç»å®ç°äº†å¯¹æ–°è¿›ç¨‹åˆ›å»ºçš„è·Ÿè¸ªç¨‹åºï¼Œå³è·Ÿè¸ªç³»ç»Ÿè°ƒç”¨ <code>execve</code>ã€‚æ¯”å¦‚ï¼Œæ‰§è¡Œä¸‹é¢çš„ bpftrace å‘½ä»¤ï¼Œå°±å¯ä»¥è·Ÿè¸ªæ–°åˆ›å»ºçš„è¿›ç¨‹ï¼š</p><pre><code class=\"language-bash\">sudo bpftrace -e 'tracepoint:syscalls:sys_enter_execve { printf(\"%-6d %-8s\", pid, comm); join(args-&gt;argv);}'\n</code></pre><p>æ‰“å¼€ä¸€ä¸ªæ–°ç»ˆç«¯ï¼Œæ‰§è¡Œä¸€æ¡ <code>ls</code> å‘½ä»¤ï¼Œç„¶åä½ å°±ä¼šçœ‹åˆ°å¦‚ä¸‹çš„è¾“å‡ºï¼š</p><pre><code class=\"language-plain\">8964   bash    ls --color=auto\n</code></pre><p>æ¥ä¸‹æ¥ï¼Œå‚è€ƒ <a href=\"https://docs.docker.com/engine/install/\">Docker å®˜æ–¹æ–‡æ¡£</a>å®‰è£… Docker ä¹‹åï¼Œå†æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œå¯åŠ¨ä¸€ä¸ª Ubuntu å®¹å™¨ï¼š</p><pre><code class=\"language-bash\"># -itè¡¨ç¤ºè¿›å…¥å®¹å™¨ç»ˆç«¯ï¼Œ--rmè¡¨ç¤ºç»ˆç«¯å…³é—­åè‡ªåŠ¨æ¸…ç†å®¹å™¨\ndocker run -it --rm --name bash --hostname bash ubuntu:impish\n</code></pre><p>åœ¨å®¹å™¨ä¸­æ‰§è¡Œ <code>ls</code> å‘½ä»¤ï¼Œå¿½ç•¥å®¹å™¨å¯åŠ¨è¿‡ç¨‹ä¸­çš„è¿›ç¨‹è·Ÿè¸ªä¿¡æ¯ï¼ˆDockeråœ¨å¯åŠ¨å®¹å™¨è¿‡ç¨‹ä¸­ä¹Ÿä¼šæ‰§è¡Œå¤§é‡çš„å‘½ä»¤ï¼‰ï¼Œä½ ä¼šçœ‹åˆ°è·Ÿåˆšæ‰ç±»ä¼¼çš„è¾“å‡ºï¼š</p><pre><code class=\"language-plain\">9018   bash    ls --color=auto\n</code></pre><p>è¿™ä¸ªè¾“å‡ºè·Ÿåˆšæ‰åœ¨ä¸»æœºä¸­æ‰§è¡Œ <code>ls</code> åçš„ç»“æœæ˜¯ä¸€æ ·çš„ï¼Œåªæ ¹æ®è¿™ä¸ªè¾“å‡ºï¼Œæˆ‘ä»¬æ˜¾ç„¶æ²¡æ³•åŒºåˆ† <code>ls</code> æ˜¯ä¸æ˜¯è¿è¡Œåœ¨å®¹å™¨ä¸­ã€‚</p><p>å®é™…ä¸Šï¼Œè™½ç„¶æ‰€æœ‰å®¹å™¨éƒ½æ˜¯å…±äº«å†…æ ¸çš„ï¼Œä½†ä¸åŒçš„å®¹å™¨ä¹‹é—´è¿˜æ˜¯é€šè¿‡å‘½åç©ºé—´è¿›è¡Œäº†éš”ç¦»ã€‚ä½ å¯ä»¥ä½¿ç”¨ <code>lsns</code> å‘½ä»¤æ¥æŸ¥è¯¢å®¹å™¨æˆ–è€…ä¸»æœºçš„å‘½åç©ºé—´ã€‚æ¯”å¦‚ï¼Œåœ¨åˆšæ‰çš„å®¹å™¨ç»ˆç«¯ä¸­æ‰§è¡Œ <code>lsns</code> å‘½ä»¤ï¼Œå°±å¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„è¾“å‡ºï¼š</p><pre><code class=\"language-plain\">        NS TYPE   NPROCS PID USER COMMAND\n4026531834 time        2   1 root bash\n4026531835 cgroup      2   1 root bash\n4026531837 user        2   1 root bash\n4026532530 mnt         2   1 root bash\n4026532531 uts         2   1 root bash\n4026532532 ipc         2   1 root bash\n4026532533 pid         2   1 root bash\n4026532535 net         2   1 root bash\n</code></pre><p>å…³äºè¿™äº›å‘½åç©ºé—´çš„å«ä¹‰ï¼Œå¦‚æœä½ è¿˜ä¸äº†è§£ï¼Œå¯ä»¥å‚è€ƒ<a href=\"https://man7.org/linux/man-pages/man7/namespaces.7.html\">è¿™é‡Œ</a>çš„ Linux æ‰‹å†Œã€‚</p><p>åœ¨å†…æ ¸ä¸­ï¼Œè¿›ç¨‹çš„åŸºæœ¬ä¿¡æ¯éƒ½ä¿å­˜åœ¨ <a href=\"https://elixir.bootlin.com/linux/v5.13/source/include/linux/sched.h#L657\">task_struct</a> ç»“æ„ä½“ä¸­ï¼Œå…¶ä¸­ä¹ŸåŒ…æ‹¬äº†åŒ…å«å‘½åç©ºé—´ä¿¡æ¯çš„  <a href=\"https://elixir.bootlin.com/linux/v5.13/source/include/linux/nsproxy.h#L31\">nsproxy</a> ç»“æ„ä½“ã€‚<code>nsproxy</code> ç»“æ„ä½“çš„å®šä¹‰å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code class=\"language-c++\">struct nsproxy {\n\tatomic_t count;\n\tstruct uts_namespace *uts_ns;\n\tstruct ipc_namespace *ipc_ns;\n\tstruct mnt_namespace *mnt_ns;\n\tstruct pid_namespace *pid_ns_for_children;\n\tstruct net \t     *net_ns;\n\tstruct time_namespace *time_ns;\n\tstruct time_namespace *time_ns_for_children;\n\tstruct cgroup_namespace *cgroup_ns;\n};\n</code></pre><p>ä¸ºäº†åŒºåˆ†ä¸€ä¸ªè¿›ç¨‹æ˜¯å±äºå®¹å™¨è¿˜æ˜¯ä¸»æœºï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è·Ÿè¸ªç»“æœä¸­è¾“å‡º PID å‘½åç©ºé—´å’Œ UTS å‘½åç©ºé—´ä¸­çš„ä¸»æœºåã€‚</p><p>bpftrace å†…ç½®äº†è¡¨ç¤ºè¿›ç¨‹ç»“æ„ä½“çš„ <a href=\"https://github.com/iovisor/bpftrace/blob/master/docs/reference_guide.md#1-builtins\">curtask</a>ï¼Œå› è€Œå¯¹å‰é¢çš„ bpftrace è„šæœ¬ï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œä¸‹é¢çš„æ”¹è¿›ï¼š</p><pre><code class=\"language-c++\">tracepoint:syscalls:sys_enter_execve {\n  /* 1. è·å–task_structç»“æ„ä½“ */\n  $task = (struct task_struct *)curtask;\n  /* 2. è·å–PIDå‘½åç©ºé—´ */\n  $pidns = $task-&gt;nsproxy-&gt;pid_ns_for_children-&gt;ns.inum;\n  /* 3. è·å–ä¸»æœºå */\n  $cname = $task-&gt;nsproxy-&gt;uts_ns-&gt;name.nodename;\n  /* 4. è¾“å‡ºPIDå‘½åç©ºé—´ã€ä¸»æœºåå’Œè¿›ç¨‹åŸºæœ¬ä¿¡æ¯ */\n  printf(\"%-12ld %-8s %-6d %-6d %-8s\", (uint64)$pidns, $cname, curtask-&gt;parent-&gt;pid, pid, comm); join(args-&gt;argv);\n}\n</code></pre><p>è¿™æ®µä»£ç ä¸­çš„å…·ä½“å†…å®¹å«ä¹‰å¦‚ä¸‹ï¼š</p><ul>\n<li>ç¬¬ 1 å¤„ï¼ŒæŠŠå†…ç½®å˜é‡ <code>curtask</code> è½¬æ¢ä¸ºæˆ‘ä»¬æƒ³è¦çš„ <code>task_struct</code> ç»“æ„ä½“ï¼›</li>\n<li>ç¬¬ 2 å¤„ï¼Œä»è¿›ç¨‹ä¿¡æ¯çš„ nsproxy ä¸­è¯»å– PID å‘½åç©ºé—´ç¼–å·ï¼›</li>\n<li>ç¬¬ 3 å¤„ï¼Œä»è¿›ç¨‹ä¿¡æ¯çš„ nsproxy ä¸­è¯»å– UTS å‘½åç©ºé—´çš„ä¸»æœºåï¼ˆä¹Ÿå°±æ˜¯åœ¨å®¹å™¨ä¸­æ‰§è¡Œ <code>hostname</code> å‘½ä»¤åçš„è¾“å‡ºï¼‰ï¼›</li>\n<li>ç¬¬ 4 å¤„ä½ å·²ç»éå¸¸ç†Ÿæ‚‰äº†ï¼Œå°±æ˜¯æŠŠåˆšæ‰è·å–çš„ä¿¡æ¯è¾“å‡ºï¼Œä»¥ä¾¿æˆ‘ä»¬è§‚å¯Ÿã€‚</li>\n</ul><p>ç”±äºè¿™å„¿ç”¨åˆ°äº†å¾ˆå¤šå†…æ ¸æ•°æ®ç»“æ„ï¼Œåœ¨è¿è¡Œä¹‹å‰ï¼Œè¿˜éœ€è¦ç»™å®ƒå¼•å…¥ç›¸å…³æ•°æ®ç»“æ„å®šä¹‰çš„å¤´æ–‡ä»¶ï¼š</p><pre><code class=\"language-c++\">#include &lt;linux/sched.h&gt;\n#include &lt;linux/nsproxy.h&gt;\n#include &lt;linux/utsname.h&gt;\n#include &lt;linux/pid_namespace.h&gt;\n</code></pre><p>åŒæ—¶ï¼Œç”±äºè¾“å‡ºçš„å†…å®¹æ¯”è¾ƒå¤šï¼Œä¸ºäº†ä¾¿äºç†è§£ï¼Œä½ è¿˜å¯ä»¥åœ¨è„šæœ¬è¿è¡Œå¼€å§‹çš„æ—¶å€™è¾“å‡ºä¸€ä¸ªè¡¨å¤´ï¼Œè¡¨ç¤ºæ¯ä¸ªè¾“å‡ºçš„å«ä¹‰ï¼š</p><pre><code class=\"language-plain\">BEGIN {\n  printf(\"%-12s %-8s %-6s %-6s %-8s %s\\n\", \"PIDNS\", \"CONTAINER\", \"PPID\", \"PID\", \"COMM\", \"ARGS\");\n}\n</code></pre><p>æŠŠå¤´æ–‡ä»¶å¼•å…¥å’Œæ”¹è¿›åçš„ bpftrace è„šæœ¬ä¿å­˜åˆ° <code>execsnoop-container.bt</code> æ–‡ä»¶ä¸­ï¼ˆä½ ä¹Ÿå¯ä»¥åœ¨ <a href=\"https://github.com/feiskyer/ebpf-apps/blob/main/bpftrace/execsnoop-container.bt\">GitHub</a> ä¸Šæ‰¾åˆ°å®Œæ•´ä»£ç ï¼‰ï¼Œç„¶åæ‰“å¼€ä¸€ä¸ªæ–°ç»ˆç«¯ï¼Œè¿è¡Œä¸‹é¢çš„å‘½ä»¤æ¥æ‰§è¡Œï¼š</p><pre><code class=\"language-bash\">sudo bpftrace execsnoop-container.bt\n</code></pre><p>æ¥ä¸‹æ¥ï¼Œåˆ†åˆ«åœ¨å®¹å™¨ç»ˆç«¯å’Œä¸»æœºç»ˆç«¯ä¸­æ‰§è¡Œä¸€ä¸ª <code>ls</code> å‘½ä»¤ï¼Œå°±å¯ä»¥å¾—åˆ°å¦‚ä¸‹çš„è¾“å‡ºï¼š</p><pre><code class=\"language-bash\">PIDNS        CONTAINER PPID   PID    COMM     ARGS\n# å®¹å™¨lså‘½ä»¤è·Ÿè¸ªç»“æœ\n4026532533   bash     41046  41335  bash    ls --color=auto\n\n# ä¸»æœºlså‘½ä»¤è·Ÿè¸ªç»“æœ\n4026531836   ubuntu.localdomain 40958  41356  bash    ls --color=auto\n</code></pre><p>åœ¨è¾“å‡ºä¸­ï¼Œå®¹å™¨ <code>ls</code> å‘½ä»¤è·Ÿè¸ªç»“æœä¸­çš„ PID å‘½åç©ºé—´ <code>4026532533</code> è·Ÿä¸Šè¿°å®¹å™¨ä¸­ <code>lsns</code> ç»“æœæ˜¯ä¸€è‡´çš„ï¼Œè€Œä¸»æœºå <code>bash</code> ä¹Ÿè·Ÿè¿è¡Œå®¹å™¨æ—¶è®¾ç½®çš„ <code>--hostname name</code> ä¸€è‡´ï¼Œå› è€Œæˆ‘ä»¬å¾ˆå®¹æ˜“åŒºåˆ†è¿™æ¡ <code>ls</code> å‘½ä»¤çš„æ¥æºã€‚</p><p>ä½ å¯ä»¥å‘ç°ï¼Œ<strong>åªè¦ç†è§£äº†å®¹å™¨çš„åŸºæœ¬åŸç†ï¼Œåœ¨è·Ÿè¸ªè¿‡ç¨‹ä¸­åŠ å…¥å®¹å™¨çš„åŸºæœ¬ä¿¡æ¯ï¼Œå®¹å™¨å†…å¤–è¿›ç¨‹çš„è·Ÿè¸ªå’Œåˆ†æå¹¶æ²¡æœ‰æœ¬è´¨çš„åŒºåˆ«</strong>ã€‚</p><p>ä¹Ÿè®¸çœ‹åˆ°è¿™é‡Œä½ ä¼šæœ‰ç–‘é—®ï¼šè¿™å„¿è®²åˆ°çš„æ˜¯å†…æ ¸æ€çš„è·Ÿè¸ªï¼Œå®¹å™¨å†…å¤–æ²¡æœ‰åŒºåˆ«å¾ˆæ­£å¸¸ã€‚ä½†å¦‚æœæ˜¯ç”¨æˆ·æ€çš„è¿›ç¨‹è·Ÿè¸ªå‘¢ï¼Ÿä½ å¯ä»¥å…ˆæ€è€ƒä¸€ä¸‹ï¼Œå†ç»§ç»­ä¸‹é¢çš„å†…å®¹ã€‚</p><p>å®é™…ä¸Šï¼Œç”¨æˆ·æ€è¿›ç¨‹çš„è·Ÿè¸ªä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œå”¯ä¸€éœ€è¦æ³¨æ„çš„å°±æ˜¯æ‰¾åˆ°å®¹å™¨å†…äºŒè¿›åˆ¶æ–‡ä»¶çš„æ­£ç¡®è·¯å¾„ã€‚è™½ç„¶å®¹å™¨æ–‡ä»¶ç³»ç»Ÿåœ¨ä¸åŒçš„ mount å‘½ä»¤ç©ºé—´ä¸­ï¼Œä½†å¯¹äºæ¯ä¸ªè¿›ç¨‹æ¥è¯´ï¼ŒLinux éƒ½åœ¨ <code>/proc/[pid]/root</code> å¤„åˆ›å»ºäº†ä¸€ä¸ªé“¾æ¥ï¼ˆè¯¦ç»†ä¿¡æ¯è¯·å‚è€ƒ <a href=\"https://man7.org/linux/man-pages/man5/proc.5.html\">proc æ–‡ä»¶ç³»ç»Ÿæ‰‹å†Œ</a>ï¼‰ã€‚å› è€Œï¼Œå®¹å™¨å†…çš„æ–‡ä»¶å°±å¯ä»¥é€šè¿‡ <code>/proc/[pid]/root</code> åœ¨ä¸»æœºä¸­è®¿é—®ã€‚</p><p>ä½ å¯ä»¥æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼ŒæŸ¥è¯¢å®¹å™¨çš„ PIDï¼Œè¿›è€Œå†æŸ¥è¯¢ bash çš„ uprobe åˆ—è¡¨ï¼š</p><pre><code class=\"language-bash\"># æŸ¥è¯¢å®¹å™¨è¿›ç¨‹åœ¨ä¸»æœºå‘½åç©ºé—´ä¸­çš„PID\nPID=$(docker inspect -f '{{.State.Pid}}' bash)\n\n# æŸ¥è¯¢uprobe\nsudo bpftrace -l \"uprobe:/proc/$PID/root/usr/bin/bash:*\"\n\n# è·Ÿè¸ªbash:readlineçš„ç»“æœ\nsudo bpftrace -e \"uretprobe:/proc/$PID/root/usr/bin/bash:readline { printf(\\\"User %d executed %s in container\\n\\\", uid, str(retval)); }\"\n</code></pre><h2>å¦‚ä½•ä½¿ç”¨ eBPF é˜»æ­¢å®¹å™¨çš„å¼‚å¸¸è¡Œä¸ºï¼Ÿ</h2><p>äº†è§£äº†å¦‚ä½•åˆ†æå®¹å™¨ä¸­çš„å®‰å…¨é—®é¢˜ä¹‹åï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹å¦‚ä½•é˜»æ­¢å®¹å™¨ä¸­çš„å¼‚å¸¸è¡Œä¸ºã€‚</p><p>åœ¨ eBPF ä¹‹å‰ï¼Œå…¶å®å·²ç»æœ‰å¾ˆå¤šçš„æœºåˆ¶æ¥é˜»æ­¢å®¹å™¨çš„å¼‚å¸¸è¡Œä¸ºï¼Œæ¯”å¦‚ <a href=\"https://docs.docker.com/engine/security/apparmor/\">AppArmor</a>ã€<a href=\"https://docs.docker.com/engine/security/seccomp/\">Seccomp</a>ã€<a href=\"https://man7.org/linux/man-pages/man7/capabilities.7.html\">Capabilities</a> ç­‰ã€‚è¿™äº›æœºåˆ¶è™½ç„¶å¥½ç”¨ï¼Œä½†å®ƒä»¬çš„ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œé‚£å°±æ˜¯å®ƒä»¬éƒ½éœ€è¦é¢„å…ˆé…ç½®å¥½ç›¸å…³çš„å®‰å…¨ç­–ç•¥ã€‚åœ¨æ£€æµ‹åˆ°å®‰å…¨éšæ‚£ä¹‹åï¼Œæ›´æ–°ç­–ç•¥åˆ°ç­–ç•¥ç”Ÿæ•ˆä¸­é—´æ€»æœ‰ä¸€å®šçš„å»¶è¿Ÿã€‚</p><p>è€Œ eBPF åˆ™å¯ä»¥åœ¨æ£€æµ‹åˆ°å®‰å…¨éšæ‚£æ—¶ï¼Œå®æ—¶å»è§¦å‘å®‰å…¨ç­–ç•¥çš„æ‰§è¡Œã€‚æ¯”å¦‚ï¼ŒLinux 5.3 ç‰ˆæœ¬ä¸­æ–°å¢çš„è¾…åŠ©å‡½æ•° <code>bpf_send_signal()</code> å¯ä»¥ç›´æ¥æŠŠæœ‰å®‰å…¨éšæ‚£çš„è¿›ç¨‹æ€æ­»ï¼Œè€Œ Linux 5.7 æ–°å¢çš„ LSM æ’æ¡©åˆ™å¯ä»¥æ‰©å±• Linux å®‰å…¨æ¨¡å—çš„å®¡è®¡å’Œç­–ç•¥æ‰§è¡Œï¼ˆæƒ³äº†è§£ LSM é’©å­çš„è¯¦ç»†ä¿¡æ¯ï¼Œä½ å¯ä»¥å‚è€ƒå†…æ ¸å¤´æ–‡ä»¶ <a href=\"https://elixir.bootlin.com/linux/v5.13/source/include/linux/lsm_hooks.h\">include/linux/lsm_hooks.h</a>ï¼‰ã€‚åœ¨ç½‘ç»œå®‰å…¨æ–¹é¢ï¼ŒXDP ç¨‹åºè¿˜å¯ä»¥åœ¨ç½‘ç»œåè®®æ ˆä¹‹å‰ä¸¢å¼ƒæ•°æ®åŒ…ï¼Œå‡å°‘éæ³•ç½‘ç»œè¯·æ±‚å¯¹ç³»ç»Ÿèµ„æºçš„æ¶ˆè€—ã€‚</p><p>ä»¥ä¸Šä¸€å°èŠ‚çš„äºŒè¿›åˆ¶å‘½ä»¤æ‰§è¡Œä¸ºä¾‹ï¼Œä½ å¯ä»¥åœ¨ bpftrace ä¸­è°ƒç”¨ <code>signal()</code> å‡½æ•°ï¼Œç»™å½“å‰è¿›ç¨‹å‘é€ç‰¹å®šä¿¡å·ï¼š</p><pre><code class=\"language-c++\">tracepoint:syscalls:sys_enter_execve\n/comm == \"bash\"/ {\n  $task = (struct task_struct *)curtask;\n  $cname = $task-&gt;nsproxy-&gt;uts_ns-&gt;name.nodename;\n  printf(\"Killing shell command in container %s: %s \", $cname, $pidns, comm); join(args-&gt;argv);\n signal(9); /* SIGKILL */\n}\n</code></pre><p>è¿™æ®µä»£ç ä¸­çš„å…·ä½“å†…å®¹å«ä¹‰å¦‚ä¸‹ï¼š</p><ul>\n<li><code>/comm == \"bash\"/</code> è¡¨ç¤ºå¯¹è¿›ç¨‹åç§°è¿›è¡Œè¿‡æ»¤ï¼Œåªå¤„ç† Bash è¿›ç¨‹ï¼›</li>\n<li><code>signal(9)</code> è¡¨ç¤ºå‘è¿›ç¨‹å‘é€ SIGKILL ä¿¡å·ï¼Œå³æ€æ­»è¿›ç¨‹ã€‚</li>\n</ul><p>åŠ å…¥ä¸ä¸Šä¸€å°èŠ‚ä¸­ç›¸åŒçš„å¤´æ–‡ä»¶ï¼Œç„¶åæŠŠå®ƒä¿å­˜åˆ° <code>block-container-shell.bt</code> æ–‡ä»¶ï¼ˆä½ ä¹Ÿå¯ä»¥åœ¨ <a href=\"https://github.com/feiskyer/ebpf-apps/blob/main/bpftrace/block-container-shell.bt\">GitHub</a> ä¸Šæ‰¾åˆ°å®Œæ•´ä»£ç ï¼‰ä¸­ï¼Œç„¶åè¿è¡Œä¸‹é¢çš„å‘½ä»¤æ¥æ‰§è¡Œï¼š</p><pre><code class=\"language-bash\">sudo bpftrace --unsafe block-container-shell.bt\n</code></pre><p>æ¥ç€ï¼Œå›åˆ°å®¹å™¨ç»ˆç«¯ï¼Œæ‰§è¡Œä»»æ„å‘½ä»¤éƒ½ä¼šå¤±è´¥ï¼Œå¹¶ä¸”å¤±è´¥ä¿¡æ¯éƒ½æ˜¯ <code>Killed</code> ã€‚</p><p>éœ€è¦æ³¨æ„ï¼Œè¿™ç§ç›´æ¥æ€æ­»è¿›ç¨‹çš„æ–¹æ³•å®é™…ä¸Šæ¯”è¾ƒå±é™©ï¼Œå¦‚æœå‡ºç°è¯¯æ€ï¼Œå¯èƒ½ä¼šå¯¼è‡´å¤§é‡è¿›ç¨‹éƒ½æ— æ³•æ­£å¸¸å¯åŠ¨ã€‚æ‰€ä»¥ bpftrace è¦æ±‚ä½ åŠ ä¸Š <code>--unsafe</code>é€‰é¡¹åæ‰å¯ä»¥æ­£å¸¸è¿è¡Œã€‚</p><h2>å°ç»“</h2><p>ä»Šå¤©ï¼Œæˆ‘å¸¦ä½ ä¸€èµ·æ¢³ç†äº† eBPF çš„å®‰å…¨èƒ½åŠ›ï¼Œå¹¶ä»¥å®¹å™¨åº”ç”¨ä¸ºä¾‹ï¼Œå¸¦ä½ ç”¨ eBPF åˆ†æå¹¶é˜»æ­¢äº†å®¹å™¨ä¸­çš„å‘½ä»¤æ‰§è¡Œã€‚</p><p>eBPF æ‰€æ”¯æŒçš„ kprobeã€uprobeã€tracepoint ç­‰å„ç±»æ¢é’ˆå·²ç»éå¸¸å…¨é¢åœ°æ¶µç›–äº†ä»åº”ç”¨åˆ°å†…æ ¸ä¸­çš„å„ç±»å®‰å…¨é—®é¢˜ç›¸å…³çš„è·Ÿè¸ªç‚¹ï¼Œå†é…åˆå…¶å¼€é”€ä½ã€å®æ—¶æ€§å¥½ï¼Œä¸”ä¸éœ€è¦ä¿®æ”¹å¹¶é‡æ–°ç¼–è¯‘å†…æ ¸å’Œåº”ç”¨ç­‰ç‰¹æ€§ï¼Œä½¿ eBPF ç‰¹åˆ«é€‚åˆç”¨äºå®‰å…¨äº‹ä»¶çš„åŠ¨æ€ç›‘æµ‹å’Œå®æ—¶åˆ†æè¯Šæ–­ã€‚å¯¹äºå®‰å…¨ç­–ç•¥çš„æ‰§è¡Œï¼ŒeBPF ä¹Ÿå·²ç»æ”¯æŒäº† LSM é’©å­ã€å‘è¿›ç¨‹å‘é€ä¿¡å·ã€ä¸¢å¼ƒç½‘ç»œæ•°æ®åŒ…ç­‰å„ç±»æ“ä½œã€‚</p><p>åœ¨è¿™ä¸€è®²çš„æœ€åï¼Œæˆ‘æƒ³æé†’ä½ ï¼šæ—¢ç„¶ eBPF æä¾›äº†è¿™ä¹ˆå¼ºå¤§çš„åŠŸèƒ½ï¼Œåœ¨ç”¨å¥½ eBPF è¿™äº›ä¸°å¯Œç‰¹æ€§çš„åŒæ—¶ï¼Œä½ ä¹Ÿè¦ç‰¹åˆ«ç•™æ„ eBPF ç¨‹åºè‡ªèº«çš„å®‰å…¨æ€§ã€‚æ¯”å¦‚ï¼Œç¦æ­¢æ™®é€šç”¨æˆ·å’Œæ™®é€šå®¹å™¨åº”ç”¨è¿è¡Œ eBPF ç¨‹åºï¼Œè€Œåªå…è®¸ç®¡ç†å‘˜å’Œç³»ç»ŸæœåŠ¡è¿è¡Œã€‚å¯¹å®¹å™¨æ¥è¯´ï¼Œä½ å¯ä»¥åˆ©ç”¨ Capabilities ç¦æ­¢æ™®é€šå®¹å™¨çš„ <code>CAP_PERFMON</code>ã€<code>CAP_BPF</code>å’Œ <code>CAP_SYS_ADMIN</code>ç­‰æƒé™ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>æœ€åï¼Œæˆ‘æƒ³é‚€è¯·ä½ æ¥èŠä¸€èŠï¼š</p><ol>\n<li>åœ¨äº†è§£ eBPF ä¹‹å‰ï¼Œä½ æ˜¯å¦‚ä½•ç›‘æµ‹ã€åˆ†æå’Œé˜»æ­¢å®¹å™¨çš„å®‰å…¨é—®é¢˜çš„ï¼Ÿ</li>\n<li>åœ¨é˜»æ­¢å®¹å™¨ Bash å‘½ä»¤æ‰§è¡Œçš„æ¡ˆä¾‹ä¸­ï¼Œé™¤äº†æ€æ­»è¿›ç¨‹ä¹‹å¤–ï¼Œè¿˜æœ‰å“ªäº›å…¶ä»–çš„æ–¹æ³•ï¼Ÿ</li>\n</ol><p>æœŸå¾…ä½ åœ¨ç•™è¨€åŒºå’Œæˆ‘è®¨è®ºï¼Œä¹Ÿæ¬¢è¿æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™ä½ çš„åŒäº‹ã€æœ‹å‹ã€‚è®©æˆ‘ä»¬ä¸€èµ·åœ¨å®æˆ˜ä¸­æ¼”ç»ƒï¼Œåœ¨äº¤æµä¸­è¿›æ­¥ã€‚</p>","comments":[{"had_liked":false,"id":333692,"user_name":"è«å","can_delete":false,"product_type":"c1","uid":1007254,"ip_address":"","ucode":"E28F2602BA25DD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/5e/96/a03175bc.jpg","comment_is_top":false,"comment_ctime":1644476074,"is_pvip":false,"replies":[{"id":122034,"content":"éå¸¸æ£’çš„ç¤ºä¾‹ï¼Œè°¢è°¢åˆ†äº«ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001282,"ctime":1644731694,"ip_address":"","comment_id":333692,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"å¦å¤–åˆ†äº«ä¸€ä¸ªç»éªŒï¼Œç»“æ„ä½“ nsproxy çš„ net å­—æ®µï¼ˆä»£è¡¨è¿›ç¨‹æ‰€åœ¨çš„ç½‘ç»œå‘½åç©ºé—´ï¼‰åœ¨è¿½è¸ªç½‘ç»œåŒ…åœ¨å®¿ä¸»æœº -&gt; å®¹å™¨ä¼ é€’è¿‡ç¨‹æ—¶å°¤å…¶æœ‰ç”¨ï¼Œå¯ä»¥æ¯”è¾ƒæ¸…æ¥šçš„çœ‹åˆ°ç½‘ç»œåŒ…ä»å®¿ä¸»æœºçš„ç½‘ç»œå‘½åç©ºé—´ä¼ é€’åˆ°å®¹å™¨ç‹¬ç«‹çš„ç½‘ç»œå‘½åç©ºé—´ä¹‹ä¸­ï¼ŒååŠ©æ›´å¥½çš„ç†è§£å®¹å™¨ç½‘ç»œæ¨¡å‹ã€‚ï¼ˆæŠŠç½‘ç»œè®¾å¤‡åå­—ä¹Ÿæ‰“å°å‡ºæ¥ä¼šæ›´å¥½ã€‚ï¼‰\n\nå€ªè€å¸ˆæ–‡ä¸­çš„ç¤ºä¾‹ç¨‹åº execsnoop-container.bt ä½¿ç”¨äº†ç»“æ„ä½“ nsproxy çš„ pid_ns_for_children è·å– PID å‘½åç©ºé—´ï¼Œç¨å¾®æ”¹åŠ¨äº†ä¸€ä¸‹ï¼Œæ¢æˆ NET å‘½åç©ºé—´ï¼ŒæŠŠå…·ä½“çš„ id æ‰“å‡ºæ¥ã€‚\n\nè¾“å‡ºç¤ºä¾‹ï¼ˆshell1 æ‰§è¡Œ docker run ... bash, shell2 è¿½è¸ª execve äº‹ä»¶ï¼Œå¯ä»¥çœ‹åˆ° bash è¿›ç¨‹åœ¨ä¸€ä¸ªæ–°çš„ç½‘ç»œå‘½åç©ºé—´ä¸‹æ‰§è¡Œã€‚ï¼‰ï¼š\n\nshell 1 # docker exec -ti vibrant_jepsen bash\nroot@c340ba5cb9de:&#47;#\n\nshell2 # # .&#47;execve.bt\nAttaching 3 probes...\nNETNS          CONTAINER              PPID     PID     COMM         ARGS\n4026531993   VM-56-211-centos   799603 181059 bash            docker exec -ti vibrant_jepsen bash\n...\n4026532351   c340ba5cb9de         181078   181083 runc:[2:INIT]   bash\n\nå…·ä½“æºç ï¼š\n======================================\n\n#!&#47;usr&#47;bin&#47;env bpftrace\n\n#include &lt;linux&#47;sched.h&gt;\n#include &lt;linux&#47;nsproxy.h&gt;\n#include &lt;linux&#47;utsname.h&gt;\n&#47;&#47;#include &lt;linux&#47;pid_namespace.h&gt;\n#include &lt;net&#47;net_namespace.h&gt;\n\nBEGIN \n{\n  printf(&quot;%-12s %-18s %-6s %-6s %-16s %s\\n&quot;, &quot;NETNS&quot;, &quot;CONTAINER&quot;, &quot;PPID&quot;, &quot;PID&quot;, &quot;COMM&quot;, &quot;ARGS&quot;);\n}\n\ntracepoint:syscalls:sys_enter_execve,\ntracepoint:syscalls:sys_enter_execveat\n{\n  $task = (struct task_struct *)curtask;\n  $netns = $task-&gt;nsproxy-&gt;net_ns-&gt;ns.inum;\n  &#47;&#47;$pidns = $task-&gt;nsproxy-&gt;pid_ns_for_children-&gt;ns.inum;\n  $cname = $task-&gt;nsproxy-&gt;uts_ns-&gt;name.nodename;\n  printf(&quot;%-12ld %-18s %-6d %-6d %-16s&quot;, (uint64)$netns, $cname, curtask-&gt;parent-&gt;pid, pid, comm);\n  join(args-&gt;argv);\n}","like_count":14,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":550786,"discussion_content":"éå¸¸æ£’çš„ç¤ºä¾‹ï¼Œè°¢è°¢åˆ†äº«ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644731694,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":333580,"user_name":"å†™ç‚¹å•¥å‘¢","can_delete":false,"product_type":"c1","uid":1065272,"ip_address":"","ucode":"C19032CF1C41BA","user_header":"https://static001.geekbang.org/account/avatar/00/10/41/38/4f89095b.jpg","comment_is_top":false,"comment_ctime":1644411478,"is_pvip":false,"replies":[{"id":122031,"content":"ä½ è¯´çš„éå¸¸æ­£ç¡®ï¼ŒeBPFå¦‚æœè¢«æ¶æ„åº”ç”¨åˆ©ç”¨ï¼Œä¹ŸåŒæ ·ä¼šå¸¦æ¥ä¸å¯é¢„æ–™çš„æŸå¤±ã€‚æ‰€ä»¥ï¼Œåœ¨ç³»ç»Ÿç»´æŠ¤ä¸­ï¼Œè¿˜æ˜¯éœ€è¦å¯¹è¿›ç¨‹çš„æƒé™æœ‰æ‰€é™åˆ¶ã€‚æ¯”å¦‚ï¼Œä¸è¦ç”¨rootç”¨æˆ·è¿è¡Œè¿›ç¨‹ã€ä¸è¦ç»™å®¹å™¨ç‰¹æƒæˆ–è€…ADMIN capabilityç­‰ç­‰ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001282,"ctime":1644731249,"ip_address":"","comment_id":333580,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"æœ¬èŠ‚è¯¾æ˜¯å…³äºeBPFåœ¨å®‰å…¨æ–¹é¢çš„ä½¿ç”¨ï¼Œå¾®åšä¸Šçœ‹åˆ°æœ‰äººå‘çš„è¿™ä¸ªrookitï¼šhttps:&#47;&#47;weibo.com&#47;tv&#47;show&#47;1034:4718242451882158?from=old_pc_videoshowï¼Œå› æ­¤æˆ‘å¯¹eBPFå¦‚ä½•ä¿è¯è‡ªèº«å®‰å…¨æ€§å¾ˆå¥½å¥‡ï¼Œæƒ³è¯·æ•™ä¸‹è€å¸ˆå¯¹äºç³»ç»Ÿæ¥è¯´eBPFæ˜¯ä¸€ä¸ªä¸¤é¢åˆ©å™¨ï¼Œå®ƒè‡ªèº«è®¾è®¡ä¸å®ç°ï¼Œè¿˜æœ‰åœ¨ä½¿ç”¨ä¸­è¯¥å¦‚ä½•æ³¨æ„é¿å…å¼•å…¥å®‰å…¨é—®é¢˜å‘¢ï¼Ÿ\n\nå¦å¤–åƒbpf_send_signalè¾…åŠ©å‡½æ•°èƒ½å¤Ÿé€šè¿‡ä¿¡å·æ€æ­»è¿›ç¨‹ï¼Œè¿™æ˜¯ä¸æ˜¯ä¸€ç§ç±»ä¼¼å˜æˆè¯­è¨€çš„unsafeæ–¹æ³•ï¼Œåº”è¯¥åœ¨å®é™…ä¸­è°¨æ…ä½¿ç”¨å‘¢ï¼Ÿ\n\nè°¢è°¢è€å¸ˆã€‚","like_count":5,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":550781,"discussion_content":"ä½ è¯´çš„éå¸¸æ­£ç¡®ï¼ŒeBPFå¦‚æœè¢«æ¶æ„åº”ç”¨åˆ©ç”¨ï¼Œä¹ŸåŒæ ·ä¼šå¸¦æ¥ä¸å¯é¢„æ–™çš„æŸå¤±ã€‚æ‰€ä»¥ï¼Œåœ¨ç³»ç»Ÿç»´æŠ¤ä¸­ï¼Œè¿˜æ˜¯éœ€è¦å¯¹è¿›ç¨‹çš„æƒé™æœ‰æ‰€é™åˆ¶ã€‚æ¯”å¦‚ï¼Œä¸è¦ç”¨rootç”¨æˆ·è¿è¡Œè¿›ç¨‹ã€ä¸è¦ç»™å®¹å™¨ç‰¹æƒæˆ–è€…ADMIN capabilityç­‰ç­‰ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644731249,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":333674,"user_name":"è«å","can_delete":false,"product_type":"c1","uid":1007254,"ip_address":"","ucode":"E28F2602BA25DD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/5e/96/a03175bc.jpg","comment_is_top":false,"comment_ctime":1644466208,"is_pvip":false,"replies":[{"id":122032,"content":"1. è°¢è°¢åˆ†äº«sysdigçš„ä½¿ç”¨ç»éªŒï¼\n2. å—¯å—¯ï¼Œè¿™æ˜¯ä¸€ç§ä¸é”™çš„æ–¹æ³•ã€‚æˆ–è€…è€ƒè™‘æç«¯ä¸€äº›ï¼Œå®Œå…¨ç¦æ­¢æ‰Bashï¼ˆæ¯”å¦‚æ‰€æœ‰è¿›ç¨‹éƒ½è·‘åœ¨å®¹å™¨ä¸­ï¼Œå®¹å™¨å†…ä¸å…è®¸å®‰è£…ä»»ä½•SHELLï¼‰ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001282,"ctime":1644731537,"ip_address":"","comment_id":333674,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"1ã€æ›¾ä½¿ç”¨è¿‡ sysdigï¼Œè€ç‰ˆæœ¬é€šè¿‡æ’å…¥å†…æ ¸æ¨¡å—çš„æ–¹å¼è¿›è¡Œå®‰å…¨å®¡è®¡ã€‚åæ¥ sysdig æ”¯æŒäº† eBPF driverï¼Œä¸»è¦é€šè¿‡è¿½è¸ªç³»ç»Ÿè°ƒç”¨åˆ†æå¯èƒ½çš„å®‰å…¨éšæ‚£ã€‚sysdig eBPF driver å®ç°æ¯”è¾ƒç®€å•ï¼Œä¸€å…±åå‡ ä¸ª programï¼Œç»Ÿä¸€æ”¾åœ¨ probe.c æºæ–‡ä»¶ï¼Œé‡Œé¢çš„æ€è·¯å€Ÿé‰´ä¸‹è¿˜æ˜¯ä¸é”™çš„ã€‚\n2ã€è§‰å¾—éœ€è¦åœ¨ bash è‡ªèº«ä¸Šåšæ‰‹è„šï¼Œæ¯”å¦‚æŠŠ bash è½¯é“¾æ¥åˆ°ä¸€ä¸ªè„šæœ¬æ–‡ä»¶ï¼Œè®°å½•ä¸‹ bash æ‰§è¡Œè®°å½•ï¼Œç„¶å ç›´æ¥ exitã€‚æˆ–è€…ä¿®æ”¹ bash é…ç½®æ–‡ä»¶ .bashrcï¼Œæ–‡ä»¶æœ«å°¾ç›´æ¥ exitã€‚ä¸¤ç§æ–¹æ³•éƒ½æœ‰å±€é™æ€§ï¼Œå¦‚æœè¢«è¯†ç ´å¯ä»¥å¾ˆå®¹æ˜“ç»•è¿‡å»ã€‚","like_count":3,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":550784,"discussion_content":"1. è°¢è°¢åˆ†äº«sysdigçš„ä½¿ç”¨ç»éªŒï¼\n2. å—¯å—¯ï¼Œè¿™æ˜¯ä¸€ç§ä¸é”™çš„æ–¹æ³•ã€‚æˆ–è€…è€ƒè™‘æç«¯ä¸€äº›ï¼Œå®Œå…¨ç¦æ­¢æ‰Bashï¼ˆæ¯”å¦‚æ‰€æœ‰è¿›ç¨‹éƒ½è·‘åœ¨å®¹å™¨ä¸­ï¼Œå®¹å™¨å†…ä¸å…è®¸å®‰è£…ä»»ä½•SHELLï¼‰ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644731537,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":333559,"user_name":"Geek_89541f","can_delete":false,"product_type":"c1","uid":2093634,"ip_address":"","ucode":"422C487C634351","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIsEia7TcYPiaO53QIydh4tPonwnpktgrhLeJqg4sNa8s11XNVTVajrI9jKibHs0FYn0EW8d8t3EM8ibQ/132","comment_is_top":false,"comment_ctime":1644405906,"is_pvip":false,"replies":[{"id":122038,"content":"xdpdrvæ¨¡å¼éœ€è¦ç½‘å¡é©±åŠ¨çš„æ”¯æŒçš„ï¼Œå…·ä½“çš„é©±åŠ¨æ”¯æŒæƒ…å†µå¯ä»¥å‚è€ƒ https:&#47;&#47;github.com&#47;iovisor&#47;bcc&#47;blob&#47;master&#47;docs&#47;kernel-versions.md#xdp","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001282,"ctime":1644732142,"ip_address":"","comment_id":333559,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"è¯·é—®æˆ‘åœ¨é˜¿é‡Œäº‘çš„è™šæ‹Ÿæœºï¼ˆcentosç³»ç»Ÿï¼Œå†…æ ¸ç‰ˆæœ¬4.18)ä¸­ä½¿ç”¨ip linkåŠ è½½xdpç¨‹åºï¼Œè‹¥æŒ‡å®šxdpdrvæ¨¡å¼ä¼šæŠ¥é”™ï¼Œxdpgenericå¯ä»¥ã€‚è¿™æ˜¯ä¸ºå•¥ï¼Ÿè™šæ‹Ÿç½‘å¡åªèƒ½ä½¿ç”¨genericæ¨¡å¼å—ï¼Ÿè¿™æ ·æ€§èƒ½ä¸èƒ½æ»¡è¶³ç”Ÿäº§éœ€æ±‚ã€‚","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":550791,"discussion_content":"xdpdrvæ¨¡å¼éœ€è¦ç½‘å¡é©±åŠ¨çš„æ”¯æŒçš„ï¼Œå…·ä½“çš„é©±åŠ¨æ”¯æŒæƒ…å†µå¯ä»¥å‚è€ƒ https://github.com/iovisor/bcc/blob/master/docs/kernel-versions.md#xdp","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644732142,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2171451,"avatar":"","nickname":"Geek_e8988c","note":"","ucode":"E5B2F025A108B3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":550471,"discussion_content":"è¿™ä¸ªè¦çœ‹ç½‘å¡æ”¯ä¸æ”¯æŒäº†ï¼Œçœ‹æƒ…å†µæ˜¯ä½ é˜¿é‡Œäº‘çš„è™šæ‹Ÿç½‘å¡ä¸æ”¯æŒ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644560926,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":372349,"user_name":"Bachue Zhou","can_delete":false,"product_type":"c1","uid":1494491,"ip_address":"ä¸Šæµ·","ucode":"3175754775CA32","user_header":"https://static001.geekbang.org/account/avatar/00/16/cd/db/7467ad23.jpg","comment_is_top":false,"comment_ctime":1681011399,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"å¦‚æœè¿è¡Œ bpftrace æ‰¾ä¸åˆ° BEGIN symbolï¼Œä¾‹å¦‚å‡ºç°ï¼š\nERROR: Could not resolve symbol: &#47;proc&#47;self&#47;exe:BEGIN_trigger\nå°±è¿è¡Œ \nsudo apt install bpftrace-dbgsym\nå°±è¡Œäº†å“ˆ","like_count":0},{"had_liked":false,"id":341817,"user_name":"éƒ‘æµ·æˆ","can_delete":false,"product_type":"c1","uid":1192616,"ip_address":"","ucode":"B0363EA4B2C646","user_header":"https://static001.geekbang.org/account/avatar/00/12/32/a8/d5bf5445.jpg","comment_is_top":false,"comment_ctime":1649842154,"is_pvip":true,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"https:&#47;&#47;elixir.bootlin.com&#47;linux&#47;v5.13&#47;source&#47;include&#47;linux&#47;sched.h#L657 è€å¸ˆï¼Œbootlinè¿™ä¸ªç½‘ç«™æ˜¯æœ‰ä»€ä¹ˆè¦æ±‚å—ï¼Ÿä¸ºä»€ä¹ˆæˆ‘æ‰€æœ‰çš„ä»£ç linkéƒ½æ˜¾ç¤º &quot;This file does not exist.&quot;å‘¢ï¼Ÿ","like_count":0}]}