{"id":134098,"title":"42 | Kafka Streamsåœ¨é‡‘èé¢†åŸŸçš„åº”ç”¨","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯èƒ¡å¤•ã€‚ä»Šå¤©æˆ‘è¦å’Œä½ åˆ†äº«çš„ä¸»é¢˜æ˜¯ï¼šKafka Streamsåœ¨é‡‘èé¢†åŸŸçš„åº”ç”¨ã€‚</p><h2>èƒŒæ™¯</h2><p>é‡‘èé¢†åŸŸå›Šæ‹¬çš„å†…å®¹æœ‰å¾ˆå¤šï¼Œæˆ‘ä»Šå¤©åˆ†äº«çš„ä¸»è¦æ˜¯ï¼Œå¦‚ä½•åˆ©ç”¨å¤§æ•°æ®æŠ€æœ¯ï¼Œç‰¹åˆ«æ˜¯Kafka Streamså®æ—¶è®¡ç®—æ¡†æ¶ï¼Œæ¥å¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°åšä¼ä¸šç”¨æˆ·æ´å¯Ÿã€‚</p><p>ä¼—æ‰€å‘¨çŸ¥ï¼Œé‡‘èé¢†åŸŸå†…çš„è·å®¢æˆæœ¬æ˜¯ç›¸å½“é«˜çš„ï¼Œä¸€çº¿åŸå¸‚é«˜å‡€å€¼ç™½é¢†çš„è·å®¢æˆæœ¬é€šå¸¸å¯è¾¾ä¸Šåƒå…ƒã€‚é¢å¯¹å¦‚æ­¤å·¨å¤§çš„æˆæœ¬å‹åŠ›ï¼Œé‡‘èä¼ä¸šä¸€æ–¹é¢è¦é™ä½å¹¿å‘ŠæŠ•æ”¾çš„è·å®¢æˆæœ¬ï¼Œå¦ä¸€æ–¹é¢è¦åšå¥½ç²¾ç»†åŒ–è¿è¥ï¼Œå®ç°å®¢æˆ·ç”Ÿå‘½å‘¨æœŸå†…ä»·å€¼ï¼ˆCustom Lifecycle Value, CLVï¼‰çš„æœ€å¤§åŒ–ã€‚</p><p><strong>å®ç°ä»·å€¼æœ€å¤§åŒ–çš„ä¸€ä¸ªé‡è¦é€”å¾„å°±æ˜¯åšå¥½ç”¨æˆ·æ´å¯Ÿï¼Œè€Œç”¨æˆ·æ´å¯Ÿè¦æ±‚ä½ è¦æ›´æ·±åº¦åœ°äº†è§£ä½ çš„å®¢æˆ·</strong>ï¼Œå³æ‰€è°“çš„Know Your Customerï¼ˆKYCï¼‰ï¼ŒçœŸæ­£åšåˆ°ä»¥å®¢æˆ·ä¸ºä¸­å¿ƒï¼Œä¸æ–­åœ°æ»¡è¶³å®¢æˆ·éœ€æ±‚ã€‚</p><p>ä¸ºäº†å®ç°KYCï¼Œä¼ ç»Ÿçš„åšæ³•æ˜¯èŠ±è´¹å¤§é‡çš„æ—¶é—´ä¸å®¢æˆ·è§é¢ï¼Œåšé¢å¯¹é¢çš„æ²Ÿé€šä»¥äº†è§£å®¢æˆ·çš„æƒ…å†µã€‚ä½†æ˜¯ï¼Œç”¨è¿™ç§æ–¹å¼å¾—åˆ°çš„æ•°æ®å¾€å¾€æ˜¯ä¸çœŸå®çš„ï¼Œæ¯•ç«Ÿå®¢æˆ·å†…å¿ƒæ˜¯æœ‰æ½œåœ¨çš„è‡ªæˆ‘ä¿æŠ¤æ„è¯†çš„ï¼ŒçŸ­æ—¶é—´å†…çš„é¢å¯¹é¢äº¤æµå¾ˆéš¾çœŸæ­£æ´å¯Ÿåˆ°å®¢æˆ·çš„çœŸå®è¯‰æ±‚ã€‚</p><p>ç›¸ååœ°ï¼Œæ¸—é€åˆ°æ¯ä¸ªäººæ—¥å¸¸ç”Ÿæ´»æ–¹æ–¹é¢é¢çš„å¤§æ•°æ®ä¿¡æ¯åˆ™ä»£è¡¨äº†å®¢æˆ·çš„å®é™…éœ€æ±‚ã€‚æ¯”å¦‚å®¢æˆ·ç»å¸¸æµè§ˆå“ªäº›ç½‘ç«™ã€éƒ½ä¹°è¿‡ä»€ä¹ˆä¸œè¥¿ã€æœ€å–œæ¬¢çš„è§†é¢‘ç±»å‹æ˜¯ä»€ä¹ˆã€‚è¿™äº›æ•°æ®çœ‹ä¼¼å¾ˆéšæ„ï¼Œä½†éƒ½è¡¨å¾äº†å®¢æˆ·æœ€çœŸå®çš„æƒ³æ³•ã€‚å°†è¿™äº›æ•°æ®æ±‡æ€»åœ¨ä¸€èµ·ï¼Œæˆ‘ä»¬å°±èƒ½å®Œæ•´åœ°æ„é€ å‡ºå®¢æˆ·çš„ç”»åƒï¼Œè¿™å°±æ˜¯æ‰€è°“çš„ç”¨æˆ·ç”»åƒï¼ˆUser Profileï¼‰æŠ€æœ¯ã€‚</p><!-- [[[read_end]]] --><h2>ç”¨æˆ·ç”»åƒ</h2><p>ç”¨æˆ·ç”»åƒå¬èµ·æ¥å¾ˆç„å¦™ï¼Œä½†å®é™…ä¸Šä½ åº”è¯¥æ˜¯å¾ˆç†Ÿæ‚‰çš„ã€‚ä½ çš„å¾ˆå¤šåŸºæœ¬ä¿¡æ¯ï¼Œæ¯”å¦‚æ€§åˆ«ã€å¹´é¾„ã€æ‰€å±è¡Œä¸šã€å·¥èµ„æ”¶å…¥å’Œçˆ±å¥½ç­‰ï¼Œéƒ½æ˜¯ç”¨æˆ·ç”»åƒçš„ä¸€éƒ¨åˆ†ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·æè¿°ä¸€ä¸ªäººï¼šæŸæŸæŸï¼Œç”·æ€§ï¼Œ28å²ï¼Œæœªå©šï¼Œå·¥èµ„æ°´å¹³å¤§è‡´åœ¨15000åˆ°20000å…ƒä¹‹é—´ï¼Œæ˜¯ä¸€åå¤§æ•°æ®å¼€å‘å·¥ç¨‹å¸ˆï¼Œå±…ä½åœ¨åŒ—äº¬å¤©é€šè‹‘å°åŒºï¼Œå¹³æ—¶åŠ ç­å¾ˆå¤šï¼Œå–œæ¬¢åŠ¨æ¼«æˆ–æ¸¸æˆã€‚</p><p>å…¶å®ï¼Œè¿™ä¸€è¿ä¸²çš„æè¿°å°±æ˜¯å…¸å‹çš„ç”¨æˆ·ç”»åƒã€‚é€šä¿—ç‚¹æ¥è¯´ï¼Œæ„å»ºç”¨æˆ·ç”»åƒçš„æ ¸å¿ƒå·¥ä½œå°±æ˜¯ç»™å®¢æˆ·æˆ–ç”¨æˆ·æ‰“æ ‡ç­¾ï¼ˆTaggingï¼‰ã€‚åˆšåˆšé‚£ä¸€è¿ä¸²çš„æè¿°å°±æ˜¯ç”¨æˆ·ç³»ç»Ÿä¸­çš„å…¸å‹æ ‡ç­¾ã€‚ç”¨æˆ·ç”»åƒç³»ç»Ÿé€šè¿‡æ‰“æ ‡ç­¾çš„å½¢å¼ï¼ŒæŠŠå®¢æˆ·æä¾›ç»™ä¸šåŠ¡äººå‘˜ï¼Œä»è€Œå®ç°ç²¾å‡†è¥é”€ã€‚</p><h2>IDæ˜ å°„ï¼ˆID Mappingï¼‰</h2><p>ç”¨æˆ·ç”»åƒçš„å¥½å¤„ä¸è¨€è€Œå–»ï¼Œè€Œä¸”æ ‡ç­¾æ‰“å¾—è¶Šå¤šè¶Šä¸°å¯Œï¼Œå°±è¶Šèƒ½ç²¾ç¡®åœ°è¡¨å¾ä¸€ä¸ªäººçš„æ–¹æ–¹é¢é¢ã€‚ä¸è¿‡ï¼Œåœ¨æ‰“ä¸€ä¸ªä¸ªå…·ä½“çš„æ ‡ç­¾ä¹‹å‰ï¼Œå¼„æ¸…æ¥šâ€œä½ æ˜¯è°â€æ˜¯æ‰€æœ‰ç”¨æˆ·ç”»åƒç³»ç»Ÿé¦–è¦è€ƒè™‘çš„é—®é¢˜ï¼Œè¿™ä¸ªé—®é¢˜ä¹Ÿè¢«ç§°ä¸ºIDè¯†åˆ«é—®é¢˜ã€‚</p><p>æ‰€è°“çš„IDå³Identificationï¼Œè¡¨ç¤ºç”¨æˆ·èº«ä»½ã€‚åœ¨ç½‘ç»œä¸Šï¼Œèƒ½å¤Ÿæ ‡è¯†ç”¨æˆ·èº«ä»½ä¿¡æ¯çš„å¸¸è§IDæœ‰5ç§ã€‚</p><ul>\n<li>èº«ä»½è¯å·ï¼šè¿™æ˜¯æœ€èƒ½è¡¨å¾èº«ä»½çš„IDä¿¡æ¯ï¼Œæ¯ä¸ªèº«ä»½è¯å·åªä¼šå¯¹åº”ä¸€ä¸ªäººã€‚</li>\n<li>æ‰‹æœºå·ï¼šæ‰‹æœºå·é€šå¸¸èƒ½è¾ƒå¥½åœ°è¡¨å¾èº«ä»½ã€‚è™½ç„¶ä¼šå‡ºç°åŒä¸€ä¸ªäººæœ‰å¤šä¸ªæ‰‹æœºå·æˆ–ä¸€ä¸ªæ‰‹æœºå·åœ¨ä¸åŒæ—¶æœŸè¢«å¤šä¸ªäººä½¿ç”¨çš„æƒ…å½¢ï¼Œä½†å¤§éƒ¨åˆ†äº’è”ç½‘åº”ç”¨ä½¿ç”¨æ‰‹æœºå·è¡¨å¾ç”¨æˆ·èº«ä»½çš„åšæ³•æ˜¯å¾ˆæµè¡Œçš„ã€‚</li>\n<li>è®¾å¤‡IDï¼šåœ¨ç§»åŠ¨äº’è”ç½‘æ—¶ä»£ï¼Œè¿™ä¸»è¦æ˜¯æŒ‡æ‰‹æœºçš„è®¾å¤‡IDæˆ–Macã€iPadç­‰ç§»åŠ¨ç»ˆç«¯è®¾å¤‡çš„è®¾å¤‡IDã€‚ç‰¹åˆ«æ˜¯æ‰‹æœºçš„è®¾å¤‡IDï¼Œåœ¨å¾ˆå¤šåœºæ™¯ä¸‹å…·å¤‡å®šä½å’Œè¯†åˆ«ç”¨æˆ·çš„åŠŸèƒ½ã€‚å¸¸è§çš„è®¾å¤‡IDæœ‰iOSç«¯çš„IDFAå’ŒAndroidç«¯çš„IMEIã€‚</li>\n<li>åº”ç”¨æ³¨å†Œè´¦å·ï¼šè¿™å±äºæ¯”è¾ƒå¼±çš„ä¸€ç±»IDã€‚æ¯ä¸ªäººåœ¨ä¸åŒçš„åº”ç”¨ä¸Šå¯èƒ½ä¼šæ³¨å†Œä¸åŒçš„è´¦å·ï¼Œä½†ä¾ç„¶æœ‰å¾ˆå¤šäººä½¿ç”¨é€šç”¨çš„æ³¨å†Œè´¦å·åç§°ï¼Œå› æ­¤å…·æœ‰ä¸€å®šçš„å…³è”æ€§å’Œè¯†åˆ«æ€§ã€‚</li>\n<li>Cookieï¼šåœ¨PCæ—¶ä»£ï¼Œæµè§ˆå™¨ç«¯çš„Cookieä¿¡æ¯æ˜¯å¾ˆé‡è¦çš„æ•°æ®ï¼Œå®ƒæ˜¯ç½‘ç»œä¸Šè¡¨å¾ç”¨æˆ·ä¿¡æ¯çš„é‡è¦æ‰‹æ®µä¹‹ä¸€ã€‚åªä¸è¿‡éšç€ç§»åŠ¨äº’è”ç½‘æ—¶ä»£çš„æ¥ä¸´ï¼ŒCookieæ—©å·²æ±Ÿæ²³æ—¥ä¸‹ï¼Œå¦‚ä»Šä½œä¸ºIDæ•°æ®çš„ä»·å€¼ä¹Ÿè¶Šæ¥è¶Šå°äº†ã€‚æˆ‘ä¸ªäººç”šè‡³è®¤ä¸ºï¼Œåœ¨æ„å»ºåŸºäºç§»åŠ¨äº’è”ç½‘çš„æ–°ä¸€ä»£ç”¨æˆ·ç”»åƒæ—¶ï¼ŒCookieå¯èƒ½è¦è¢«æŠ›å¼ƒäº†ã€‚</li>\n</ul><p>åœ¨æ„å»ºç”¨æˆ·ç”»åƒç³»ç»Ÿæ—¶ï¼Œæˆ‘ä»¬ä¼šä»å¤šä¸ªæ•°æ®æºä¸Šæºæºä¸æ–­åœ°æ”¶é›†å„ç§ä¸ªäººç”¨æˆ·æ•°æ®ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œè¿™äº›æ•°æ®ä¸ä¼šå…¨éƒ¨æºå¸¦ä»¥ä¸Šè¿™äº›IDä¿¡æ¯ã€‚æ¯”å¦‚åœ¨è¯»å–æµè§ˆå™¨çš„æµè§ˆå†å²æ—¶ï¼Œä½ è·å–çš„æ˜¯Cookieæ•°æ®ï¼Œè€Œè¯»å–ç”¨æˆ·åœ¨æŸä¸ªAppä¸Šçš„è®¿é—®è¡Œä¸ºæ•°æ®æ—¶ï¼Œä½ æ‹¿åˆ°çš„æ˜¯ç”¨æˆ·çš„è®¾å¤‡IDå’Œæ³¨å†Œè´¦å·ä¿¡æ¯ã€‚</p><p>å€˜è‹¥è¿™äº›æ•°æ®è¡¨å¾çš„éƒ½æ˜¯ä¸€ä¸ªç”¨æˆ·çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬çš„ç”¨æˆ·ç”»åƒç³»ç»Ÿå¦‚ä½•è¯†åˆ«å‡ºæ¥å‘¢ï¼Ÿæ¢å¥è¯è¯´ï¼Œä½ éœ€è¦ä¸€ç§æ‰‹æ®µæˆ–æŠ€æœ¯å¸®ä½ åšå„ä¸ªIDçš„æ‰“é€šæˆ–æ˜ å°„ã€‚è¿™å°±æ˜¯ç”¨æˆ·ç”»åƒé¢†åŸŸçš„IDæ˜ å°„é—®é¢˜ã€‚</p><h2>å®æ—¶ID Mapping</h2><p>æˆ‘ä¸¾ä¸ªç®€å•çš„ä¾‹å­ã€‚å‡è®¾æœ‰ä¸€ä¸ªé‡‘èç†è´¢ç”¨æˆ·å¼ ä¸‰ï¼Œä»–é¦–å…ˆåœ¨è‹¹æœæ‰‹æœºä¸Šè®¿é—®äº†æŸç†è´¢äº§å“ï¼Œç„¶ååœ¨å®‰å“æ‰‹æœºä¸Šæ³¨å†Œäº†è¯¥ç†è´¢äº§å“çš„è´¦å·ï¼Œæœ€ååœ¨ç”µè„‘ä¸Šç™»å½•è¯¥è´¦å·ï¼Œå¹¶è´­ä¹°äº†è¯¥ç†è´¢äº§å“ã€‚ID Mapping å°±æ˜¯è¦å°†è¿™äº›ä¸åŒç«¯æˆ–è®¾å¤‡ä¸Šçš„ç”¨æˆ·ä¿¡æ¯èšåˆèµ·æ¥ï¼Œç„¶åæ‰¾å‡ºå¹¶æ‰“é€šç”¨æˆ·æ‰€å…³è”çš„æ‰€æœ‰IDä¿¡æ¯ã€‚</p><p>å®æ—¶ID Mappingçš„è¦æ±‚å°±æ›´é«˜äº†ï¼Œå®ƒè¦æ±‚æˆ‘ä»¬èƒ½å¤Ÿå®æ—¶åœ°åˆ†æä»å„ä¸ªè®¾å¤‡æ”¶é›†æ¥çš„æ•°æ®ï¼Œå¹¶åœ¨å¾ˆçŸ­çš„æ—¶é—´å†…å®ŒæˆID Mappingã€‚æ‰“é€šç”¨æˆ·IDèº«ä»½çš„æ—¶é—´è¶ŠçŸ­ï¼Œæˆ‘ä»¬å°±èƒ½è¶Šå¿«åœ°ä¸ºå…¶æ‰“ä¸Šæ›´å¤šçš„æ ‡ç­¾ï¼Œä»è€Œè®©ç”¨æˆ·ç”»åƒå‘æŒ¥æ›´å¤§çš„ä»·å€¼ã€‚</p><p>ä»å®æ—¶è®¡ç®—æˆ–æµå¤„ç†çš„è§’åº¦æ¥çœ‹ï¼Œå®æ—¶ID Mappingèƒ½å¤Ÿè½¬æ¢æˆä¸€ä¸ª<strong>æµ-è¡¨è¿æ¥é—®é¢˜</strong>ï¼ˆStream-Table Joinï¼‰ï¼Œå³æˆ‘ä»¬å®æ—¶åœ°å°†ä¸€ä¸ªæµå’Œä¸€ä¸ªè¡¨è¿›è¡Œè¿æ¥ã€‚</p><p>æ¶ˆæ¯æµä¸­çš„æ¯ä¸ªäº‹ä»¶æˆ–æ¯æ¡æ¶ˆæ¯åŒ…å«çš„æ˜¯ä¸€ä¸ªæœªçŸ¥ç”¨æˆ·çš„æŸç§ä¿¡æ¯ï¼Œå®ƒå¯ä»¥æ˜¯ç”¨æˆ·åœ¨é¡µé¢çš„è®¿é—®è®°å½•æ•°æ®ï¼Œä¹Ÿå¯ä»¥æ˜¯ç”¨æˆ·çš„è´­ä¹°è¡Œä¸ºæ•°æ®ã€‚è¿™äº›æ¶ˆæ¯ä¸­å¯èƒ½ä¼šåŒ…å«æˆ‘ä»¬åˆšæ‰æåˆ°çš„è‹¥å¹²ç§IDä¿¡æ¯ï¼Œæ¯”å¦‚é¡µé¢è®¿é—®ä¿¡æ¯ä¸­å¯èƒ½åŒ…å«è®¾å¤‡IDï¼Œä¹Ÿå¯èƒ½åŒ…å«æ³¨å†Œè´¦å·ï¼Œè€Œè´­ä¹°è¡Œä¸ºä¿¡æ¯ä¸­å¯èƒ½åŒ…å«èº«ä»½è¯ä¿¡æ¯å’Œæ‰‹æœºå·ç­‰ã€‚</p><p>è¿æ¥çš„å¦ä¸€æ–¹è¡¨ä¿å­˜çš„æ˜¯<strong>ç”¨æˆ·æ‰€æœ‰çš„IDä¿¡æ¯</strong>ï¼Œéšç€è¿æ¥çš„ä¸æ–­æ·±å…¥ï¼Œè¡¨ä¸­ä¿å­˜çš„IDå“ç±»ä¼šè¶Šæ¥è¶Šä¸°å¯Œï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæµä¸­çš„æ•°æ®ä¼šè¢«ä¸æ–­åœ°è¡¥å……è¿›è¡¨ä¸­ï¼Œæœ€ç»ˆå®ç°å¯¹ç”¨æˆ·æ‰€æœ‰IDçš„æ‰“é€šã€‚</p><h2>Kafka Streamså®ç°</h2><p>å¥½äº†ï¼Œç°åœ¨æˆ‘ä»¬å°±æ¥çœ‹çœ‹å¦‚ä½•ä½¿ç”¨Kafka Streamsæ¥å®ç°ä¸€ä¸ªç‰¹å®šåœºæ™¯ä¸‹çš„å®æ—¶ID Mappingã€‚ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œæˆ‘ä»¬å‡è®¾ID Mappingåªå…³å¿ƒèº«ä»½è¯å·ã€æ‰‹æœºå·ä»¥åŠè®¾å¤‡IDã€‚ä¸‹é¢æ˜¯ç”¨Avroå†™æˆçš„Schemaæ ¼å¼ï¼š</p><pre><code>{\n  &quot;namespace&quot;: &quot;kafkalearn.userprofile.idmapping&quot;,\n  &quot;type&quot;: &quot;record&quot;,\n  &quot;name&quot;: &quot;IDMapping&quot;,\n  &quot;fields&quot;: [\n    {&quot;name&quot;: &quot;deviceId&quot;, &quot;type&quot;: &quot;string&quot;},\n    {&quot;name&quot;: &quot;idCard&quot;, &quot;type&quot;: &quot;string&quot;},\n    {&quot;name&quot;: &quot;phone&quot;, &quot;type&quot;: &quot;string&quot;}\n  ]\n}\n</code></pre><p>é¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œ<strong>Avroæ˜¯Javaæˆ–å¤§æ•°æ®ç”Ÿæ€åœˆå¸¸ç”¨çš„åºåˆ—åŒ–ç¼–ç æœºåˆ¶</strong>ï¼Œæ¯”å¦‚ç›´æ¥ä½¿ç”¨JSONæˆ–XMLä¿å­˜å¯¹è±¡ã€‚Avroèƒ½æå¤§åœ°èŠ‚çœç£ç›˜å ç”¨ç©ºé—´æˆ–ç½‘ç»œI/Oä¼ è¾“é‡ï¼Œå› æ­¤æ™®éåº”ç”¨äºå¤§æ•°æ®é‡ä¸‹çš„æ•°æ®ä¼ è¾“ã€‚</p><p>åœ¨è¿™ä¸ªåœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ä¸¤ä¸ªKafkaä¸»é¢˜ï¼Œä¸€ä¸ªç”¨äºæ„é€ è¡¨ï¼Œå¦ä¸€ä¸ªç”¨äºæ„å»ºæµã€‚è¿™ä¸¤ä¸ªä¸»é¢˜çš„æ¶ˆæ¯æ ¼å¼éƒ½æ˜¯ä¸Šé¢çš„IDMappingå¯¹è±¡ã€‚</p><p>æ–°ç”¨æˆ·åœ¨å¡«å†™æ‰‹æœºå·æ³¨å†ŒAppæ—¶ï¼Œä¼šå‘ç¬¬ä¸€ä¸ªä¸»é¢˜å‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œè¯¥ç”¨æˆ·åç»­åœ¨Appä¸Šçš„æ‰€æœ‰è®¿é—®è®°å½•ï¼Œä¹Ÿéƒ½ä¼šä»¥æ¶ˆæ¯çš„å½¢å¼å‘é€åˆ°ç¬¬äºŒä¸ªä¸»é¢˜ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå‘é€åˆ°ç¬¬äºŒä¸ªä¸»é¢˜ä¸Šçš„æ¶ˆæ¯æœ‰å¯èƒ½æºå¸¦å…¶ä»–çš„IDä¿¡æ¯ï¼Œæ¯”å¦‚æ‰‹æœºå·æˆ–è®¾å¤‡IDç­‰ã€‚å°±åƒæˆ‘åˆšåˆšæ‰€è¯´çš„ï¼Œè¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„æµ-è¡¨å®æ—¶è¿æ¥åœºæ™¯ï¼Œè¿æ¥ä¹‹åï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿå°†ç”¨æˆ·çš„æ‰€æœ‰æ•°æ®è¡¥é½ï¼Œå®ç°ID Mappingçš„æ‰“é€šã€‚</p><p>åŸºäºè¿™ä¸ªè®¾è®¡æ€è·¯ï¼Œæˆ‘å…ˆç»™å‡ºå®Œæ•´çš„Kafka Streamsä»£ç ï¼Œç¨åæˆ‘ä¼šå¯¹é‡ç‚¹éƒ¨åˆ†è¿›è¡Œè¯¦ç»†è§£é‡Šï¼š</p><pre><code>package kafkalearn.userprofile.idmapping;\n\n// omit importsâ€¦â€¦\n\npublic class IDMappingStreams {\n\n\n    public static void main(String[] args) throws Exception {\n\n        if (args.length &lt; 1) {\n            throw new IllegalArgumentException(&quot;Must specify the path for a configuration file.&quot;);\n        }\n\n        IDMappingStreams instance = new IDMappingStreams();\n        Properties envProps = instance.loadProperties(args[0]);\n        Properties streamProps = instance.buildStreamsProperties(envProps);\n        Topology topology = instance.buildTopology(envProps);\n\n        instance.createTopics(envProps);\n\n        final KafkaStreams streams = new KafkaStreams(topology, streamProps);\n        final CountDownLatch latch = new CountDownLatch(1);\n\n        // Attach shutdown handler to catch Control-C.\n        Runtime.getRuntime().addShutdownHook(new Thread(&quot;streams-shutdown-hook&quot;) {\n            @Override\n            public void run() {\n                streams.close();\n                latch.countDown();\n            }\n        });\n\n        try {\n            streams.start();\n            latch.await();\n        } catch (Throwable e) {\n            System.exit(1);\n        }\n        System.exit(0);\n    }\n\n    private Properties loadProperties(String propertyFilePath) throws IOException {\n        Properties envProps = new Properties();\n        try (FileInputStream input = new FileInputStream(propertyFilePath)) {\n            envProps.load(input);\n            return envProps;\n        }\n    }\n\n    private Properties buildStreamsProperties(Properties envProps) {\n        Properties props = new Properties();\n        props.put(StreamsConfig.APPLICATION_ID_CONFIG, envProps.getProperty(&quot;application.id&quot;));\n        props.put(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG, envProps.getProperty(&quot;bootstrap.servers&quot;));\n        props.put(StreamsConfig.DEFAULT_KEY_SERDE_CLASS_CONFIG, Serdes.String().getClass());\n        props.put(StreamsConfig.DEFAULT_VALUE_SERDE_CLASS_CONFIG, Serdes.String().getClass());\n        return props;\n    }\n\n    private void createTopics(Properties envProps) {\n        Map&lt;String, Object&gt; config = new HashMap&lt;&gt;();\n        config.put(AdminClientConfig.BOOTSTRAP_SERVERS_CONFIG, envProps.getProperty(&quot;bootstrap.servers&quot;));\n        try (AdminClient client = AdminClient.create(config)) {\n            List&lt;NewTopic&gt; topics = new ArrayList&lt;&gt;();\n            topics.add(new NewTopic(\n                    envProps.getProperty(&quot;stream.topic.name&quot;),\n                    Integer.parseInt(envProps.getProperty(&quot;stream.topic.partitions&quot;)),\n                    Short.parseShort(envProps.getProperty(&quot;stream.topic.replication.factor&quot;))));\n\n            topics.add(new NewTopic(\n                    envProps.getProperty(&quot;table.topic.name&quot;),\n                    Integer.parseInt(envProps.getProperty(&quot;table.topic.partitions&quot;)),\n                    Short.parseShort(envProps.getProperty(&quot;table.topic.replication.factor&quot;))));\n\n            client.createTopics(topics);\n        }\n    }\n\n    private Topology buildTopology(Properties envProps) {\n        final StreamsBuilder builder = new StreamsBuilder();\n        final String streamTopic = envProps.getProperty(&quot;stream.topic.name&quot;);\n        final String rekeyedTopic = envProps.getProperty(&quot;rekeyed.topic.name&quot;);\n        final String tableTopic = envProps.getProperty(&quot;table.topic.name&quot;);\n        final String outputTopic = envProps.getProperty(&quot;output.topic.name&quot;);\n        final Gson gson = new Gson();\n\n        // 1. æ„é€ è¡¨\n        KStream&lt;String, IDMapping&gt; rekeyed = builder.&lt;String, String&gt;stream(tableTopic)\n                .mapValues(json -&gt; gson.fromJson(json, IDMapping.class))\n                .filter((noKey, idMapping) -&gt; !Objects.isNull(idMapping.getPhone()))\n                .map((noKey, idMapping) -&gt; new KeyValue&lt;&gt;(idMapping.getPhone(), idMapping));\n        rekeyed.to(rekeyedTopic);\n        KTable&lt;String, IDMapping&gt; table = builder.table(rekeyedTopic);\n\n        // 2. æµ-è¡¨è¿æ¥\n        KStream&lt;String, String&gt; joinedStream = builder.&lt;String, String&gt;stream(streamTopic)\n                .mapValues(json -&gt; gson.fromJson(json, IDMapping.class))\n                .map((noKey, idMapping) -&gt; new KeyValue&lt;&gt;(idMapping.getPhone(), idMapping))\n                .leftJoin(table, (value1, value2) -&gt; IDMapping.newBuilder()\n                        .setPhone(value2.getPhone() == null ? value1.getPhone() : value2.getPhone())\n                        .setDeviceId(value2.getDeviceId() == null ? value1.getDeviceId() : value2.getDeviceId())\n                        .setIdCard(value2.getIdCard() == null ? value1.getIdCard() : value2.getIdCard())\n                        .build())\n                .mapValues(v -&gt; gson.toJson(v));\n\n        joinedStream.to(outputTopic);\n\n        return builder.build();\n    }\n}\n\n</code></pre><p>è¿™ä¸ªJavaç±»ä»£ç ä¸­æœ€é‡è¦çš„æ–¹æ³•æ˜¯<strong>buildTopologyå‡½æ•°</strong>ï¼Œå®ƒæ„é€ äº†æˆ‘ä»¬æ‰“é€šID Mappingçš„æ‰€æœ‰é€»è¾‘ã€‚</p><p>åœ¨è¯¥æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆæ„é€ äº†StreamsBuilderå¯¹è±¡å®ä¾‹ï¼Œè¿™æ˜¯æ„é€ ä»»ä½•Kafka Streamsåº”ç”¨çš„ç¬¬ä¸€æ­¥ã€‚ä¹‹åæˆ‘ä»¬è¯»å–é…ç½®æ–‡ä»¶ï¼Œè·å–äº†è¦è¯»å†™çš„æ‰€æœ‰Kafkaä¸»é¢˜åã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ç”¨åˆ°4ä¸ªä¸»é¢˜ï¼Œå®ƒä»¬çš„ä½œç”¨å¦‚ä¸‹ï¼š</p><ul>\n<li>streamTopicï¼šä¿å­˜ç”¨æˆ·ç™»å½•Appåå‘ç”Ÿçš„å„ç§è¡Œä¸ºæ•°æ®ï¼Œæ ¼å¼æ˜¯IDMappingå¯¹è±¡çš„JSONä¸²ã€‚ä½ å¯èƒ½ä¼šé—®ï¼Œå‰é¢ä¸æ˜¯éƒ½åˆ›å»ºAvro Schemaæ–‡ä»¶äº†å—ï¼Œæ€ä¹ˆè¿™é‡Œåˆç”¨å›JSONäº†å‘¢ï¼ŸåŸå› æ˜¯è¿™æ ·çš„ï¼šç¤¾åŒºç‰ˆçš„Kafkaæ²¡æœ‰æä¾›Avroçš„åºåˆ—åŒ–/ååºåˆ—åŒ–ç±»æ”¯æŒï¼Œå¦‚æœæˆ‘è¦ä½¿ç”¨Avroï¼Œå¿…é¡»æ”¹ç”¨Confluentå…¬å¸æä¾›çš„Kafkaï¼Œä½†è¿™ä¼šåç¦»æˆ‘ä»¬ä¸“æ æƒ³è¦ä»‹ç»Apache Kafkaçš„åˆè¡·ã€‚æ‰€ä»¥ï¼Œæˆ‘è¿˜æ˜¯ä½¿ç”¨JSONè¿›è¡Œè¯´æ˜ã€‚è¿™é‡Œæˆ‘åªæ˜¯ç”¨äº†Avro Code Generatorå¸®æˆ‘ä»¬æä¾›IDMappingå¯¹è±¡å„ä¸ªå­—æ®µçš„set/getæ–¹æ³•ï¼Œä½ ä½¿ç”¨Lombokä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</li>\n<li>rekeyedTopicï¼šè¿™ä¸ªä¸»é¢˜æ˜¯ä¸€ä¸ªä¸­é—´ä¸»é¢˜ï¼Œå®ƒå°†streamTopicä¸­çš„æ‰‹æœºå·æå–å‡ºæ¥ä½œä¸ºæ¶ˆæ¯çš„Keyï¼ŒåŒæ—¶ç»´æŒæ¶ˆæ¯ä½“ä¸å˜ã€‚</li>\n<li>tableTopicï¼šä¿å­˜ç”¨æˆ·æ³¨å†ŒAppæ—¶å¡«å†™çš„æ‰‹æœºå·ã€‚æˆ‘ä»¬è¦ä½¿ç”¨è¿™ä¸ªä¸»é¢˜æ„é€ è¿æ¥æ—¶è¦ç”¨åˆ°çš„è¡¨æ•°æ®ã€‚</li>\n<li>outputTopicï¼šä¿å­˜è¿æ¥åçš„è¾“å‡ºä¿¡æ¯ï¼Œå³æ‰“é€šäº†ç”¨æˆ·æ‰€æœ‰IDæ•°æ®çš„IDMappingå¯¹è±¡ï¼Œå°†å…¶è½¬æ¢æˆJSONåè¾“å‡ºã€‚</li>\n</ul><p>buildTopologyçš„ç¬¬ä¸€æ­¥æ˜¯æ„é€ è¡¨ï¼Œå³KTableå¯¹è±¡ã€‚æˆ‘ä»¬ä¿®æ”¹åˆå§‹çš„æ¶ˆæ¯æµï¼Œä»¥ç”¨æˆ·æ³¨å†Œçš„æ‰‹æœºå·ä½œä¸ºKeyï¼Œæ„é€ äº†ä¸€ä¸ªä¸­é—´æµï¼Œä¹‹åå°†è¿™ä¸ªæµå†™å…¥åˆ°rekeyedTopicï¼Œæœ€åç›´æ¥ä½¿ç”¨builder.tableæ–¹æ³•æ„é€ å‡ºKTableã€‚è¿™æ ·æ¯å½“æœ‰æ–°ç”¨æˆ·æ³¨å†Œæ—¶ï¼Œè¯¥KTableéƒ½ä¼šæ–°å¢ä¸€æ¡æ•°æ®ã€‚</p><p>æœ‰äº†è¡¨ä¹‹åï¼Œæˆ‘ä»¬ç»§ç»­æ„é€ æ¶ˆæ¯æµæ¥å°è£…ç”¨æˆ·ç™»å½•Appä¹‹åçš„è¡Œä¸ºæ•°æ®ï¼Œæˆ‘ä»¬åŒæ ·æå–å‡ºæ‰‹æœºå·ä½œä¸ºè¦è¿æ¥çš„Keyï¼Œä¹‹åä½¿ç”¨KStreamçš„<strong>leftJoinæ–¹æ³•</strong>å°†å…¶ä¸ä¸Šä¸€æ­¥çš„KTableå¯¹è±¡è¿›è¡Œå…³è”ã€‚</p><p>åœ¨å…³è”çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬åŒæ—¶æå–ä¸¤è¾¹çš„ä¿¡æ¯ï¼Œå°½å¯èƒ½åœ°è¡¥å……åˆ°æœ€åç”Ÿæˆçš„IDMappingå¯¹è±¡ä¸­ï¼Œç„¶åå°†è¿™ä¸ªç”Ÿæˆçš„IDMappingå®ä¾‹è¿”å›åˆ°æ–°ç”Ÿæˆçš„æµä¸­ã€‚æœ€åï¼Œæˆ‘ä»¬å°†å®ƒå†™å…¥åˆ°outputTopicä¸­ä¿å­˜ã€‚</p><p>è‡³æ­¤ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸åˆ°200è¡Œçš„Javaä»£ç ï¼Œå°±ç®€å•å®ç°äº†ä¸€ä¸ªçœŸå®åœºæ™¯ä¸‹çš„å®æ—¶ID Mappingä»»åŠ¡ã€‚ç†è®ºä¸Šï¼Œä½ å¯ä»¥å°†è¿™ä¸ªä¾‹å­ç»§ç»­æ‰©å……ï¼Œæ‰©å±•åˆ°ä»»æ„å¤šä¸ªID Mappingï¼Œç”šè‡³æ˜¯å«æœ‰å…¶ä»–æ ‡ç­¾çš„æ•°æ®ï¼Œè¿æ¥åŸç†æ˜¯ç›¸é€šçš„ã€‚åœ¨æˆ‘è‡ªå·±çš„é¡¹ç›®ä¸­ï¼Œæˆ‘å€ŸåŠ©äºKafka Streamså¸®åŠ©æˆ‘å®ç°äº†ç”¨æˆ·ç”»åƒç³»ç»Ÿçš„éƒ¨åˆ†åŠŸèƒ½ï¼Œè€ŒID Mappingå°±æ˜¯å…¶ä¸­çš„ä¸€ä¸ªã€‚</p><h2>å°ç»“</h2><p>å¥½äº†ï¼Œæˆ‘ä»¬å°ç»“ä¸€ä¸‹ã€‚ä»Šå¤©ï¼Œæˆ‘å±•ç¤ºäº†Kafka Streamsåœ¨é‡‘èé¢†åŸŸçš„ä¸€ä¸ªåº”ç”¨æ¡ˆä¾‹ï¼Œé‡ç‚¹æ¼”ç¤ºäº†å¦‚ä½•åˆ©ç”¨è¿æ¥å‡½æ•°æ¥å®æ—¶å…³è”æµå’Œè¡¨ã€‚å…¶å®ï¼ŒKafka Streamsæä¾›çš„åŠŸèƒ½è¿œä¸æ­¢è¿™äº›ï¼Œæˆ‘æ¨èä½ é˜…è¯»ä¸€ä¸‹<a href=\"https://kafka.apache.org/23/documentation/streams/developer-guide/\">å®˜ç½‘</a>çš„æ•™ç¨‹ï¼Œç„¶åæŠŠè‡ªå·±çš„ä¸€äº›è½»é‡çº§çš„å®æ—¶è®¡ç®—çº¿ä¸Šä»»åŠ¡æ”¹ä¸ºä½¿ç”¨Kafka Streamsæ¥å®ç°ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/75/e7/75df06c2b75c3886ca3496a774730de7.jpg?wh=2069*2560\" alt=\"\"></p><h2>å¼€æ”¾è®¨è®º</h2><p>æœ€åï¼Œæˆ‘ä»¬æ¥è®¨è®ºä¸€ä¸ªé—®é¢˜ã€‚åœ¨åˆšåˆšçš„è¿™ä¸ªä¾‹å­ä¸­ï¼Œä½ è§‰å¾—æˆ‘ä¸ºä»€ä¹ˆä½¿ç”¨leftJoinæ–¹æ³•è€Œä¸æ˜¯joinæ–¹æ³•å‘¢ï¼Ÿï¼ˆå°æç¤ºï¼šå¯ä»¥å¯¹æ¯”ä¸€ä¸‹SQLä¸­çš„left joinå’Œinner joinã€‚ï¼‰</p><p>æ¬¢è¿å†™ä¸‹ä½ çš„æ€è€ƒå’Œç­”æ¡ˆï¼Œæˆ‘ä»¬ä¸€èµ·è®¨è®ºã€‚å¦‚æœä½ è§‰å¾—æœ‰æ‰€æ”¶è·ï¼Œä¹Ÿæ¬¢è¿æŠŠæ–‡ç« åˆ†äº«ç»™ä½ çš„æœ‹å‹ã€‚</p><p></p>","comments":[{"had_liked":false,"id":132433,"user_name":"å…”2ğŸ°ğŸƒ","can_delete":false,"product_type":"c1","uid":1096984,"ip_address":"","ucode":"1FEDA044BB6CBD","user_header":"https://static001.geekbang.org/account/avatar/00/10/bd/18/2af6bf4b.jpg","comment_is_top":false,"comment_ctime":1568121265,"is_pvip":false,"discussion_count":4,"race_medal":0,"score":"44517794225","product_id":100029201,"comment_content":"Appä¸Šå‘ç°è¯¥æ ç›®æ›´æ–°äº†æœ€åä¸€èŠ‚ï¼Œç›®å‰æ‰å­¦åˆ°22èŠ‚ï¼Œå®Œæˆäº†å‰ä¸‰ç« çš„äº†è§£ã€‚æˆ‘ä»ä¸Šä¸ªæœˆ20æ—¥å¼€å§‹çš„ï¼Œæœ‰20å¤©æ—¶é—´äº†ï¼Œä¹Ÿç®—æ˜¯ä»0å¼€å§‹çš„ï¼Œå¯¹Kafkaæœ‰äº†å¾ˆå¤šäº†è§£ï¼Œæ¯å¬å®Œä¸€èŠ‚ï¼Œéè·Ÿç€å†™ç¬”è®°ï¼Œç»“æ„åŒ–æ–‡ç« å†…å®¹ï¼Œæ„Ÿè§‰æœ‰ç‚¹æ…¢ï¼Œå®è·µè¿˜æ²¡å¼€å§‹ã€‚æ˜å¤©èµ·æ¢ä¸ªæ–¹å¼è¯•è¯•æ•ˆæœï¼Œæ­ä¸ªç¯å¢ƒï¼Œå®è·µä¸‹å‰22èŠ‚å†…å®¹ï¼Œæ¥ç€åé¢çš„ç« èŠ‚å…ˆæ¯ç« èŠ‚å†…å®¹å¬ä¸€éåæ¢³ç†æ•´ä¸ªç« èŠ‚çš„å†…å®¹ï¼Œå†åˆ°å®è·µã€‚<br>æ„Ÿè°¢èƒ¡è€å¸ˆçš„æ•™è¯¾ï¼ŒèŠ‚æ—¥å¿«ä¹~","like_count":11,"discussions":[{"author":{"id":1488020,"avatar":"https://static001.geekbang.org/account/avatar/00/16/b4/94/2796de72.jpg","nickname":"è¿½é£ç­çš„äºº","note":"","ucode":"2993D60F94C396","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":551579,"discussion_content":"å‰å®³äº†  å…”å“¥","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1645064918,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1096984,"avatar":"https://static001.geekbang.org/account/avatar/00/10/bd/18/2af6bf4b.jpg","nickname":"å…”2ğŸ°ğŸƒ","note":"","ucode":"1FEDA044BB6CBD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":45391,"discussion_content":"æ¬£æ…°å•Šï¼Œç»ˆäºçœ‹å®Œäº†è¦ï¼Œå¥½å¤šè¿˜è¦å›é¡¾ç†Ÿæ‚‰ä¸‹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573032901,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1032331,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/c0/8b/0371baee.jpg","nickname":"å¼ ä¸½å¨œ","note":"","ucode":"D70CFF68E72DAF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1096984,"avatar":"https://static001.geekbang.org/account/avatar/00/10/bd/18/2af6bf4b.jpg","nickname":"å…”2ğŸ°ğŸƒ","note":"","ucode":"1FEDA044BB6CBD","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":197010,"discussion_content":"æ­å»ºç¯å¢ƒäº†ä¹ˆï¼Ÿç†è®ºçŸ¥è¯†å¦‚æœæ²¡æœ‰å®ç°çš„è¯ï¼Œæœ‰æ²¡æœ‰æ„Ÿè§‰å¾ˆéš¾è½åœ°ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583395007,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":45391,"ip_address":""},"score":197010,"extra":""},{"author":{"id":1096984,"avatar":"https://static001.geekbang.org/account/avatar/00/10/bd/18/2af6bf4b.jpg","nickname":"å…”2ğŸ°ğŸƒ","note":"","ucode":"1FEDA044BB6CBD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1032331,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/c0/8b/0371baee.jpg","nickname":"å¼ ä¸½å¨œ","note":"","ucode":"D70CFF68E72DAF","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":198068,"discussion_content":"å—¯ï¼Œç¯å¢ƒæ­å»ºäº†ï¼Œå¯¹äºwindowsç”¨æˆ·æ¥è¯´è¿˜æ˜¯æœ‰ç‚¹éš¾åº¦ï¼Œé…åˆç½‘ä¸Šèµ„æ–™æ‰æ˜ç™½æ€ä¹ˆæ­å»ºé›†ç¾¤ï¼Œæ²¡åŸºç¡€çš„å…‰çœ‹ç†è®ºå¾ˆéš¾å¼„æ‡‚ï¼Œä¸Šæ‰‹æ“ä½œæ—¶ä¸€å¤§å †é—®é¢˜ï¼Œå‘èµ°è¿‡äº†æ‰èƒ½å­¦åˆ°ä¸œè¥¿ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1583468632,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":197010,"ip_address":""},"score":198068,"extra":""}]}]},{"had_liked":false,"id":132541,"user_name":"æ›¾è½¼éºŸ","can_delete":false,"product_type":"c1","uid":1451391,"ip_address":"","ucode":"D418371AC11270","user_header":"https://static001.geekbang.org/account/avatar/00/16/25/7f/473d5a77.jpg","comment_is_top":false,"comment_ctime":1568163462,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"23042999942","product_id":100029201,"comment_content":"left join å¯ä»¥å…³è”ä¸Šä¸å­˜åœ¨çš„æ•°æ®è¡Œï¼Œè€Œjoinå…¶å®æ˜¯inner join éœ€è¦ä¸¤å¼ è¡¨æ•°æ®éƒ½åŒ¹é…ä¸Šç»“æœæ‰ä¼šæœ‰ï¼Œleft joinçš„å¥½å¤„å°±æ˜¯ï¼Œå¦‚æœå…¶ä¸­æœ‰ä¸€å¼ è¡¨æ²¡æœ‰åŒ¹é…æ•°æ®ï¼Œä¹Ÿä¸ä¼šå¯¼è‡´ç»“æœé›†æ²¡æœ‰è¿™æ¡è®°å½•","like_count":4},{"had_liked":false,"id":290709,"user_name":"Minze","can_delete":false,"product_type":"c1","uid":1534718,"ip_address":"","ucode":"2367DA6C09BE7C","user_header":"https://static001.geekbang.org/account/avatar/00/17/6a/fe/446c0282.jpg","comment_is_top":false,"comment_ctime":1619696543,"is_pvip":false,"replies":[{"id":"105701","content":"æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„å«ä¹‰ï¼Œæºç å°±æ˜¯è¿™ä¹ˆå‘½åçš„ï¼Œå¦‚ä¸‹ï¼š<br>static final String OUTEROTHER_NAME = &quot;KSTREAM-OUTEROTHER-&quot;;","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1620614426,"ip_address":"","comment_id":290709,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5914663839","product_id":100029201,"comment_content":"èƒ¡è€å¸ˆæ‚¨å¥½ï¼Œæœ€è¿‘æˆ‘åœ¨å­¦ä¹ ä½¿ç”¨Kafka streamsï¼Œæœ‰ä¸€ç‚¹è®©æˆ‘å›°æƒ‘çš„æ˜¯åœ¨ä½¿ç”¨joinçš„æ—¶å€™ï¼Œç”Ÿæˆçš„topologyä¸­ä¼šæœ‰ä¸€äº›åå­—åŒ…å«KSTREAMâ€“JOINTHISå’ŒKSTREAMâ€“OUTEROTHERçš„processorå’Œstoreåˆ›å»ºå‡ºæ¥ï¼Œè¿™äº›æœ¬åœ°çš„storeåº”è¯¥æ˜¯ç”¨æ¥å­˜å‚¨joinè¦ç”¨åˆ°çš„æ•°æ®ï¼Œè¿™æˆ‘èƒ½ç†è§£ï¼Œä½†æ˜¯è¿™äº›processorçš„ä½œç”¨å’ŒJOINTHISã€OUTEROTHERçš„å‘½åå«ä¹‰å´ç™¾æ€ä¸å¾—å…¶è§£ï¼Œè€å¸ˆå¯å¦ç»™äº›å»ºè®®æˆ–è€…æç¤ºï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":519268,"discussion_content":"æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„å«ä¹‰ï¼Œæºç å°±æ˜¯è¿™ä¹ˆå‘½åçš„ï¼Œå¦‚ä¸‹ï¼š\nstatic final String OUTEROTHER_NAME = &amp;quot;KSTREAM-OUTEROTHER-&amp;quot;;","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620614426,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":191474,"user_name":"King","can_delete":false,"product_type":"c1","uid":1109772,"ip_address":"","ucode":"955CDA858B1073","user_header":"https://static001.geekbang.org/account/avatar/00/10/ef/0c/e2169f41.jpg","comment_is_top":false,"comment_ctime":1584776871,"is_pvip":false,"replies":[{"id":"73520","content":"appendçš„æ–¹å¼ã€‚ä¸èƒ½ä¿è¯ï¼Œå› ä¸ºæœ€åæ˜¯å°†æ‰€æœ‰çŠ¶æ€è½¬æ¢æˆstreamäº†","user_name":"ä½œè€…å›å¤","user_name_real":"huxi_2b","uid":"1288090","ctime":1584846924,"ip_address":"","comment_id":191474,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5879744167","product_id":100029201,"comment_content":"æœ€åå†™å…¥outputTopicæ˜¯ä»¥appendè¿˜æ˜¯updateï¼Ÿå¯ä»¥ä¿è¯ç”¨æˆ·åœ¨outputTopicä¸­åªæœ‰ä¸€æ¡è®°å½•å—ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":488184,"discussion_content":"appendçš„æ–¹å¼ã€‚ä¸èƒ½ä¿è¯ï¼Œå› ä¸ºæœ€åæ˜¯å°†æ‰€æœ‰çŠ¶æ€è½¬æ¢æˆstreamäº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584846924,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":176126,"user_name":"ITå°åƒ§","can_delete":false,"product_type":"c1","uid":1036906,"ip_address":"","ucode":"4DC9B291AAD748","user_header":"https://static001.geekbang.org/account/avatar/00/0f/d2/6a/a9039139.jpg","comment_is_top":false,"comment_ctime":1580964740,"is_pvip":true,"replies":[{"id":"68706","content":"ä¹Ÿæ²¡å…³ç³»å•Šï¼Œä¿å­˜åœ¨åº•å±‚çš„topicä¸­","user_name":"ä½œè€…å›å¤","user_name_real":"huxi_2b","uid":"1288090","ctime":1581296160,"ip_address":"","comment_id":176126,"utype":1}],"discussion_count":3,"race_medal":0,"score":"5875932036","product_id":100029201,"comment_content":"è€å¸ˆå¥½ï¼Œè¿™ä¸ªæ„é€ IDMappingä¸­çš„KTableå¯¹è±¡è‚¯å®šä¼šè¶Šæ¥è¶Šå¤§å§ï¼Œè¿™ä¸ªæ€ä¹ˆå¤„ç†å‘¢","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":483027,"discussion_content":"ä¹Ÿæ²¡å…³ç³»å•Šï¼Œä¿å­˜åœ¨åº•å±‚çš„topicä¸­","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581296160,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1635021,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/MIbA6MRiblftUawVWvKt6jvgOvTwibKsTCJhh5y5vKEuURtcEZDtylwGFfekZBanmwIgNSJTm9YMmZlPPicDQ14Iw/132","nickname":"Geek_4254d8","note":"","ucode":"806A8116A3177F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":313329,"discussion_content":"å¦å¤–æƒ³è¯·æ•™è€å¸ˆï¼Œåº•å±‚Topicæ•°æ®é‡å¤§äº†ä¹‹åï¼ˆå³ä½¿åˆ†åŒºåº”è¯¥ä¹Ÿé¿å…ä¸äº†è†¨èƒ€ï¼Œè€Œåˆ†åŒºæ¶ˆæ¯åº”è¯¥ä¹Ÿæ— æ³•åƒæ•°æ®åº“ä¸€æ ·é€šè¿‡keyå¿«é€Ÿè®¿é—®ä¸­é—´è®°å½•å§ï¼‰ï¼Œæ€ä¹ˆä¿è¯æµè¡¨left joinçš„æ€§èƒ½ï¼Ÿcompactå­˜å‚¨åè¿‡æ¥ä¹Ÿä¼šæ¶ˆè€—è¯»å–çš„æ€§èƒ½","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603032048,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1635021,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/MIbA6MRiblftUawVWvKt6jvgOvTwibKsTCJhh5y5vKEuURtcEZDtylwGFfekZBanmwIgNSJTm9YMmZlPPicDQ14Iw/132","nickname":"Geek_4254d8","note":"","ucode":"806A8116A3177F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":313324,"discussion_content":"ä½†æ˜¯topicä¸æ˜¯ä¹Ÿä¼šæ¶ˆæ¯è¿‡æœŸå—ï¼Ÿè¿™å—æ€ä¹ˆæ§åˆ¶æ¶ˆæ¯ä»€ä¹ˆæ—¶å€™å¯ä»¥ä¸¢å¼ƒå‘¢ï¼ˆä¸¤ä¸ªåœºæ™¯1.ç”¨æˆ·ä¿¡æ¯å¾ˆå¿«å·²ç»åŒ¹é…å®Œæˆè¾“å‡ºåˆ°ä»“å­˜å‚¨KTableä¸­å¯¹åº”çš„æ•°æ®å·²ç»å®Œæˆä½¿å‘½ï¼Œ2.ç”¨æˆ·ä¿¡æ¯ä¸€ç›´æ²¡å®Œæˆå¡«æŠ¥ï¼Œå¹¶ä¸”ä¸ç¡®å®šç”¨æˆ·æ˜¯å¦è¿˜ä¼šå¡«æŠ¥ï¼‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603031763,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":335637,"user_name":"Kaine","can_delete":false,"product_type":"c1","uid":2799936,"ip_address":"","ucode":"970FBF356F3F59","user_header":"https://static001.geekbang.org/account/avatar/00/2a/b9/40/e350862c.jpg","comment_is_top":false,"comment_ctime":1645609671,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1645609671","product_id":100029201,"comment_content":"è€å¸ˆåœ¨&lt;VT, VR&gt; KStream&lt;K, VR&gt; leftJoin(final KTable&lt;K, VT&gt; table,<br>                                     final ValueJoiner&lt;? super V, ? super VT, ? extends VR&gt; joiner);<br>æœ‰è¿™ä¹ˆä¸€æ®µæ³¨é‡Šï¼Œä¸Šé¢è¯´è¾“å…¥æµçš„åˆ†åŒºæ•°å¿…é¡»ä¸Ktableå¯¹åº”çš„topicçš„åˆ†åŒºæ•°ä¸€è‡´è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢<br>Both input streams (or to be more precise, their underlying source topics) need to have the same number of partitions. If this is not the case, you would need to call through(String) for this KStream before doing the join, using a pre-created topic with the same number of partitions as the given KTable. Furthermore, both input streams need to be co-partitioned on the join key (i.e., use the same partitioner); cf. join(GlobalKTable, KeyValueMapper, ValueJoiner). If this requirement is not met, Kafka Streams will automatically repartition the data, i.e., it will create an internal repartitioning topic in Kafka and write and re-read the data via this topic before the actual join. The repartitioning topic will be named &quot;${applicationId}-&lt;name&gt;-repartition&quot;, where &quot;applicationId&quot; is user-specified in StreamsConfig via parameter APPLICATION_ID_CONFIG, &quot;&lt;name&gt;&quot; is an internally generated name, and &quot;-repartition&quot; is a fixed suffix.","like_count":0},{"had_liked":false,"id":331212,"user_name":"å°ä»™","can_delete":false,"product_type":"c1","uid":1866677,"ip_address":"","ucode":"9F94043DFCEC3A","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eq6pWvKsV4rzQ62z5MDEjaEU5MbDfmzbA62kUgoqia2tgKIIxw4ibkDhF7W48iat5dT8UB9Adky2NuzQ/132","comment_is_top":false,"comment_ctime":1642487257,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1642487257","product_id":100029201,"comment_content":"è¿™é‡Œç”¨åˆ°çš„ 4 ä¸ª topic å°±æ˜¯æ™®é€šçš„ topic å—ï¼Ÿä¹Ÿæ˜¯é»˜è®¤ 7 å¤©æ¶ˆæ¯è¿‡æœŸç­‰ç­‰è®¾å®šï¼Œå¹¶éæ°¸ä¹…ä¿å­˜","like_count":0},{"had_liked":false,"id":260868,"user_name":"æœèŠ±è¥¿è½","can_delete":false,"product_type":"c1","uid":1055199,"ip_address":"","ucode":"CBD4A0D129500D","user_header":"https://static001.geekbang.org/account/avatar/00/10/19/df/5486f00d.jpg","comment_is_top":false,"comment_ctime":1605145990,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1605145990","product_id":100029201,"comment_content":"ä»£ç çš„99è¡Œæ˜¯ä¸æ˜¯æ²¡æœ‰å¿…è¦å‘¢ï¼Œæˆ‘æ„Ÿè§‰æ—¢ç„¶æ˜¯æŒ‰æ‰‹æœºå·keyæ¥åšjoinçš„ï¼Œé‚£ä¸ç®¡value2æ˜¯å¦ä¸ºnullï¼Œæœ€ç»ˆéƒ½åº”è¯¥æ˜¯value1çš„å€¼ã€‚å› ä¸ºå¦‚æœä¸ä¸ºnullï¼Œvalue1å’Œvalue2ä¹Ÿæ˜¯ç›¸ç­‰çš„å§ã€‚","like_count":0},{"had_liked":false,"id":251623,"user_name":"timmy21","can_delete":false,"product_type":"c1","uid":1174860,"ip_address":"","ucode":"9D6DED247B1F38","user_header":"https://static001.geekbang.org/account/avatar/00/11/ed/4c/8674b6ad.jpg","comment_is_top":false,"comment_ctime":1601732673,"is_pvip":false,"replies":[{"id":"92148","content":"ä¿å­˜åœ¨åº•å±‚çš„Topicä¸­ï¼Œè¿™ç±»topicä¸€å®šæ˜¯å¯ç”¨äº†compactäº†çš„","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1602206503,"ip_address":"","comment_id":251623,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1601732673","product_id":100029201,"comment_content":"KTableæ˜¯å…¨éƒ¨ä¿å­˜åœ¨å†…å­˜å—ï¼Ÿå…·ä½“å®ç°æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":506569,"discussion_content":"ä¿å­˜åœ¨åº•å±‚çš„Topicä¸­ï¼Œè¿™ç±»topicä¸€å®šæ˜¯å¯ç”¨äº†compactäº†çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1602206503,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":236025,"user_name":"J.Smile","can_delete":false,"product_type":"c1","uid":1336475,"ip_address":"","ucode":"C4D98DFDBF7584","user_header":"https://static001.geekbang.org/account/avatar/00/14/64/9b/0b578b08.jpg","comment_is_top":false,"comment_ctime":1595293981,"is_pvip":false,"replies":[{"id":"87309","content":"å¦‚æœæ˜¯Kafka Streamsï¼Œconsumerçš„æ•°é‡ç”±num.stream.threadsç›´æ¥å†³å®šï¼Œå½“ç„¶ä¹Ÿå—è®¢é˜…æ€»åˆ†åŒºæ•°çš„åˆ¶çº¦","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1595386629,"ip_address":"","comment_id":236025,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1595293981","product_id":100029201,"comment_content":"è€å¸ˆï¼Œæˆ‘çœ‹åˆ°æœ‰ä½¿ç”¨streamåŠ è¿­ä»£å™¨çš„æ–¹å¼å»æ¶ˆè´¹æ¶ˆæ¯çš„ï¼Œè²Œä¼¼å»ºç«‹è¿æ¥æ—¶ä¼ å…¥äº†ä¸€ä¸ªtopicCountçš„mapï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªstreamå…¶å®å¯ä»¥æ¶ˆè´¹åˆ°å¤šä¸ªtopicçš„æ•°æ®ï¼Œæ€»è§‰å¾—æœ‰ç‚¹å¥‡æ€ªï¼Œå› ä¸ºè·Ÿè€å¸ˆä¹‹å‰è¯¾ç¨‹é‡Œé‚£ç§pollçš„æ–¹å¼å·®åˆ«å¾ˆå¤§ã€‚æˆ‘ä¸å¤ªèƒ½æ˜ç™½è¿™ç§å½¢å¼æ¶ˆè´¹æ•°æ®ï¼Œåˆ°åº•æ¶ˆè´¹è€…å¯¹åº”æ˜¯æŸä¸€ä¸ªstreamï¼Ÿè¿˜æ˜¯topicCountçš„æ¯ä¸ªtopicï¼Ÿæ˜¯å“ªä¸ªå†³å®šäº†consumerçš„æ•°é‡ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":501920,"discussion_content":"å¦‚æœæ˜¯Kafka Streamsï¼Œconsumerçš„æ•°é‡ç”±num.stream.threadsç›´æ¥å†³å®šï¼Œå½“ç„¶ä¹Ÿå—è®¢é˜…æ€»åˆ†åŒºæ•°çš„åˆ¶çº¦","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595386629,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":233414,"user_name":"å¸ƒå‰å²›ä¸Šçš„ä¸ç§‘å­¦å›","can_delete":false,"product_type":"c1","uid":1162178,"ip_address":"","ucode":"A796610CAF5904","user_header":"https://static001.geekbang.org/account/avatar/00/11/bb/c2/cbd652ab.jpg","comment_is_top":false,"comment_ctime":1594309995,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1594309995","product_id":100029201,"comment_content":"è€å¸ˆä½ å¥½ï¼Œæˆ‘æœ‰ä¸€ä¸ªç–‘æƒ‘ï¼š<br>é¦–å…ˆï¼Œå‡è®¾ç”¨æˆ·æ³¨å†Œçš„æ—¶å€™åªæœ‰ã€æ‰‹æœºå·ã€‘ä¿¡æ¯ï¼Œé‚£ä¹ˆKTableé‡Œæ˜¯æ²¡æœ‰ã€DeviceIdã€‘å’Œã€IdCardã€‘çš„ã€‚<br>ç„¶åç”¨æˆ·å‘ç”Ÿçš„ç¬¬ä¸€æ¬¡æ“ä½œï¼Œæºå¸¦äº†ã€DeviceIdã€‘ï¼Œç¬¬äºŒæ¬¡æ“ä½œæºå¸¦äº†ã€IdCardã€‘ï¼Œè¿™äº›æ•°æ®ä»ä»£ç ä¸Šçœ‹æ˜¯ä¸ä¼šæ›´æ–°ã€KTableã€‘çš„ï¼Œé‚£ä¹ˆã€outputTopicã€‘ä¸¤æ¬¡è¾“å‡ºçš„å†…å®¹éƒ½æ˜¯ä¸å…¨é¢ï¼Œä¹Ÿå°±æ˜¯è¯´ã€outputTopicã€‘æ²¡æ³•åŒæ—¶è¾“å‡ºæºå¸¦äº†ã€DeviceIdå’ŒIdCardã€‘ä¿¡æ¯çš„å§ï¼Ÿå¸Œæœ›èƒ¡è€å¸ˆèƒ½å¤ŸæŠ½ç©ºè§£ç­”ä¸€ä¸‹ï¼Œè°¢è°¢ã€‚<br>","like_count":0}]}