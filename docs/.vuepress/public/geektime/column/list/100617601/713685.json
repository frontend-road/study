{"id":713685,"title":"17ï½œå›è°ƒå‡½æ•°ï¼šåœ¨AIåº”ç”¨ä¸­å¼•å…¥å¼‚æ­¥é€šä¿¡æœºåˆ¶","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯é»„ä½³ï¼Œæ¬¢è¿æ¥åˆ°LangChainå®æˆ˜è¯¾ï¼</p><p>è¿™èŠ‚è¯¾æˆ‘ä»¬ä¸€èµ·æ¥å­¦ä¹ ä¸€ä¸‹LangChainä¸­çš„å›è°ƒå‡½æ•°ã€‚</p><h2>å›è°ƒå‡½æ•°å’Œå¼‚æ­¥ç¼–ç¨‹</h2><p>å›è°ƒå‡½æ•°ï¼Œä½ å¯èƒ½å¹¶ä¸é™Œç”Ÿã€‚å®ƒæ˜¯å‡½æ•°Aä½œä¸ºå‚æ•°ä¼ ç»™å¦ä¸€ä¸ªå‡½æ•°Bï¼Œç„¶ååœ¨å‡½æ•°Bå†…éƒ¨æ‰§è¡Œå‡½æ•°Aã€‚å½“å‡½æ•°Bå®ŒæˆæŸäº›æ“ä½œåï¼Œä¼šè°ƒç”¨ï¼ˆå³â€œå›è°ƒâ€ï¼‰å‡½æ•°Aã€‚è¿™ç§ç¼–ç¨‹æ¨¡å¼å¸¸è§äºå¤„ç†å¼‚æ­¥æ“ä½œï¼Œå¦‚äº‹ä»¶ç›‘å¬ã€å®šæ—¶ä»»åŠ¡æˆ–ç½‘ç»œè¯·æ±‚ã€‚</p><blockquote>\n<p><span class=\"reference\">åœ¨ç¼–ç¨‹ä¸­ï¼Œå¼‚æ­¥é€šå¸¸æ˜¯æŒ‡ä»£ç ä¸å¿…ç­‰å¾…æŸä¸ªæ“ä½œå®Œæˆï¼ˆå¦‚I/Oæ“ä½œã€ç½‘ç»œè¯·æ±‚ã€æ•°æ®åº“æŸ¥è¯¢ç­‰ï¼‰å°±å¯ä»¥ç»§ç»­æ‰§è¡Œçš„èƒ½åŠ›ã€‚å¼‚æ­¥æœºåˆ¶çš„å®ç°æ¶‰åŠäº‹ä»¶å¾ªç¯ã€ä»»åŠ¡é˜Ÿåˆ—å’Œå…¶ä»–å¤æ‚çš„åº•å±‚æœºåˆ¶ã€‚è¿™ä¸åŒæ­¥ç¼–ç¨‹å½¢æˆå¯¹æ¯”ï¼Œåœ¨åŒæ­¥ç¼–ç¨‹ä¸­ï¼Œæ“ä½œå¿…é¡»æŒ‰ç…§å®ƒä»¬å‡ºç°çš„é¡ºåºå®Œæˆã€‚</span></p>\n</blockquote><p>ä¸‹é¢æ˜¯å›è°ƒå‡½æ•°çš„ä¸€ä¸ªç®€å•ç¤ºä¾‹ã€‚</p><pre><code class=\"language-plain\">def compute(x, y, callback):\n&nbsp; &nbsp; result = x + y\n&nbsp; &nbsp; callback(result)\n\ndef print_result(value):\n&nbsp; &nbsp; print(f\"The result is: {value}\")\n\ndef square_result(value):\n&nbsp; &nbsp; print(f\"The squared result is: {value**2}\")\n\n# ä½¿ç”¨print_resultä½œä¸ºå›è°ƒ\ncompute(3, 4, print_result) &nbsp;# è¾“å‡º: The result is: 7\n\n# ä½¿ç”¨square_resultä½œä¸ºå›è°ƒ\ncompute(3, 4, square_result) &nbsp;# è¾“å‡º: The squared result is: 49\n</code></pre><!-- [[[read_end]]] --><p>ä¸è¿‡ï¼Œä¸Šé¢è¿™ä¸ªç¨‹åºä¸­å¹¶æ²¡æœ‰ä½“ç°å‡ºå¼‚æ­¥æ“ä½œã€‚è™½ç„¶å›è°ƒå‡½æ•°è¿™ç§ç¼–ç¨‹æ¨¡å¼å¸¸è§äºå¤„ç†å¼‚æ­¥æ“ä½œï¼Œä½†å›è°ƒå‡½æ•°æœ¬èº«å¹¶ä¸ä»£è¡¨å¼‚æ­¥ã€‚å›è°ƒåªæ˜¯ä¸€ç§ç¼–ç¨‹æ¨¡å¼ï¼Œå…è®¸ä½ åœ¨æŸä¸ªæ“ä½œå®Œæˆæ—¶ï¼ˆæ— è®ºæ˜¯å¦å¼‚æ­¥ï¼‰æ‰§è¡ŒæŸäº›ä»£ç ã€‚</p><p>è€Œä¸‹é¢çš„ä¾‹å­ï¼Œå°±æ˜¯åœ¨å¼‚æ­¥æ“ä½œæ—¶ä½¿ç”¨å›è°ƒå‡½æ•°çš„ç¤ºä¾‹ã€‚</p><pre><code class=\"language-plain\">import asyncio\n\nasync def compute(x, y, callback):\n&nbsp; &nbsp; print(\"Starting compute...\")\n&nbsp; &nbsp; await asyncio.sleep(0.5) &nbsp;# æ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œ\n&nbsp; &nbsp; result = x + y\n&nbsp; &nbsp; # callback(result)\n&nbsp; &nbsp; print(\"Finished compute...\")\n\ndef print_result(value):\n&nbsp; &nbsp; print(f\"The result is: {value}\")\n\nasync def another_task():\n&nbsp; &nbsp; print(\"Starting another task...\")\n&nbsp; &nbsp; await asyncio.sleep(1)\n&nbsp; &nbsp; print(\"Finished another task...\")\n\nasync def main():\n&nbsp; &nbsp; print(\"Main starts...\")\n&nbsp; &nbsp; task1 = asyncio.create_task(compute(3, 4, print_result))\n&nbsp; &nbsp; task2 = asyncio.create_task(another_task())\n&nbsp; &nbsp; \n&nbsp; &nbsp; await task1\n&nbsp; &nbsp; await task2\n&nbsp; &nbsp; print(\"Main ends...\")\n\nasyncio.run(main())\n</code></pre><p>è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œå½“æˆ‘ä»¬è°ƒç”¨ asyncio.create_task(compute(3, 4, print_result))ï¼Œcomputeå‡½æ•°å¼€å§‹æ‰§è¡Œã€‚å½“å®ƒé‡åˆ° await asyncio.sleep(2) æ—¶ï¼Œå®ƒä¼šæš‚åœï¼Œå¹¶å°†æ§åˆ¶æƒäº¤è¿˜ç»™äº‹ä»¶å¾ªç¯ã€‚è¿™æ—¶ï¼Œäº‹ä»¶å¾ªç¯å¯ä»¥é€‰æ‹©å¼€å§‹æ‰§è¡Œanother_taskï¼Œè¿™æ˜¯å¦ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡ã€‚è¿™æ ·ï¼Œä½ å¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°ï¼Œå°½ç®¡computeå‡½æ•°è¿˜æ²¡æœ‰å®Œæˆï¼Œanother_taskå‡½æ•°ä¹Ÿå¾—ä»¥å¼€å§‹æ‰§è¡Œå¹¶å®Œæˆã€‚è¿™å°±æ˜¯å¼‚æ­¥ç¼–ç¨‹ï¼Œå…è®¸ä½ åŒæ—¶æ‰§è¡Œå¤šä¸ªæ“ä½œï¼Œè€Œä¸éœ€è¦ç­‰å¾…ä¸€ä¸ªå®Œæˆåå†å¼€å§‹å¦ä¸€ä¸ªã€‚</p><h2>LangChain ä¸­çš„ Callback å¤„ç†å™¨</h2><p>LangChain çš„ Callback æœºåˆ¶å…è®¸ä½ åœ¨åº”ç”¨ç¨‹åºçš„ä¸åŒé˜¶æ®µè¿›è¡Œè‡ªå®šä¹‰æ“ä½œï¼Œå¦‚æ—¥å¿—è®°å½•ã€ç›‘æ§å’Œæ•°æ®æµå¤„ç†ï¼Œè¿™ä¸ªæœºåˆ¶é€šè¿‡ CallbackHandlerï¼ˆå›è°ƒå¤„ç†å™¨ï¼‰æ¥å®ç°ã€‚</p><p>å›è°ƒå¤„ç†å™¨æ˜¯LangChainä¸­å®ç° CallbackHandler æ¥å£çš„å¯¹è±¡ï¼Œä¸ºæ¯ç±»å¯ç›‘æ§çš„äº‹ä»¶æä¾›ä¸€ä¸ªæ–¹æ³•ã€‚å½“è¯¥äº‹ä»¶è¢«è§¦å‘æ—¶ï¼ŒCallbackManager ä¼šåœ¨è¿™äº›å¤„ç†å™¨ä¸Šè°ƒç”¨é€‚å½“çš„æ–¹æ³•ã€‚</p><p>BaseCallbackHandleræ˜¯æœ€åŸºæœ¬çš„å›è°ƒå¤„ç†å™¨ï¼Œä½ å¯ä»¥ç»§æ‰¿å®ƒæ¥åˆ›å»ºè‡ªå·±çš„å›è°ƒå¤„ç†å™¨ã€‚å®ƒåŒ…å«äº†å¤šç§æ–¹æ³•ï¼Œå¦‚on_llm_start/on_chatï¼ˆå½“ LLM å¼€å§‹è¿è¡Œæ—¶è°ƒç”¨ï¼‰å’Œon_llm_errorï¼ˆå½“ LLM å‡ºç°é”™è¯¯æ—¶è°ƒç”¨ï¼‰ç­‰ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/f3/91/f393b0aa5b0b4fa795c27b5e04cae491.jpg?wh=698x805\" alt=\"\"></p><p>LangChain ä¹Ÿæä¾›äº†ä¸€äº›å†…ç½®çš„å¤„ç†å™¨ï¼Œä¾‹å¦‚ StdOutCallbackHandlerï¼Œå®ƒä¼šå°†æ‰€æœ‰äº‹ä»¶è®°å½•åˆ°æ ‡å‡†è¾“å‡ºã€‚è¿˜æœ‰FileCallbackHandlerï¼Œä¼šå°†æ‰€æœ‰çš„æ—¥å¿—è®°å½•åˆ°ä¸€ä¸ªæŒ‡å®šçš„æ–‡ä»¶ä¸­ã€‚</p><h2>åœ¨ç»„ä»¶ä¸­ä½¿ç”¨å›è°ƒå¤„ç†å™¨</h2><p>åœ¨ LangChain çš„å„ä¸ªç»„ä»¶ï¼Œå¦‚ Chainsã€Modelsã€Toolsã€Agents ç­‰ï¼Œéƒ½æä¾›äº†ä¸¤ç§ç±»å‹çš„å›è°ƒè®¾ç½®æ–¹æ³•ï¼šæ„é€ å‡½æ•°å›è°ƒå’Œè¯·æ±‚å›è°ƒã€‚ä½ å¯ä»¥åœ¨åˆå§‹åŒ– LangChain æ—¶å°†å›è°ƒå¤„ç†å™¨ä¼ å…¥ï¼Œæˆ–è€…åœ¨å•ç‹¬çš„è¯·æ±‚ä¸­ä½¿ç”¨å›è°ƒã€‚ä¾‹å¦‚ï¼Œå½“ä½ æƒ³è¦åœ¨æ•´ä¸ªé“¾çš„æ‰€æœ‰è¯·æ±‚ä¸­è¿›è¡Œæ—¥å¿—è®°å½•æ—¶ï¼Œå¯ä»¥åœ¨åˆå§‹åŒ–æ—¶ä¼ å…¥å¤„ç†å™¨ï¼›è€Œå½“ä½ åªæƒ³åœ¨æŸä¸ªç‰¹å®šè¯·æ±‚ä¸­ä½¿ç”¨å›è°ƒæ—¶ï¼Œå¯ä»¥åœ¨è¯·æ±‚æ—¶ä¼ å…¥ã€‚</p><p>è¿™ä¸¤è€…çš„åŒºåˆ«ï¼Œæˆ‘ç»™ä½ æ•´ç†äº†ä¸€ä¸‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/a5/5e/a593e19a4c3693365756a5c34a96355e.jpg?wh=1306x461\" alt=\"\"></p><p>ä¸‹é¢è¿™æ®µç¤ºä¾‹ä»£ç ï¼Œä½¿ç”¨ LangChain æ‰§è¡Œäº†ä¸€ä¸ªç®€å•çš„ä»»åŠ¡ï¼Œç»“åˆä½¿ç”¨ LangChain çš„å›è°ƒæœºåˆ¶ä¸ loguru æ—¥å¿—åº“ï¼Œå°†ç›¸å…³äº‹ä»¶åŒæ—¶è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºå’Œ <code>\"output.log\"</code> æ–‡ä»¶ä¸­ã€‚</p><pre><code class=\"language-plain\">from loguru import logger\n\nfrom langchain.callbacks import FileCallbackHandler\nfrom langchain.chains import LLMChain\nfrom langchain.llms import OpenAI\nfrom langchain.prompts import PromptTemplate\n\nlogfile = \"output.log\"\n\nlogger.add(logfile, colorize=True, enqueue=True)\nhandler = FileCallbackHandler(logfile)\n\nllm = OpenAI()\nprompt = PromptTemplate.from_template(\"1 + {number} = \")\n\n# this chain will both print to stdout (because verbose=True) and write to 'output.log'\n# if verbose=False, the FileCallbackHandler will still write to 'output.log'\nchain = LLMChain(llm=llm, prompt=prompt, callbacks=[handler], verbose=True)\nanswer = chain.run(number=2)\nlogger.info(answer)\n</code></pre><p>å…¶ä¸­ï¼Œåˆå§‹åŒ–LLMChainæ—¶æŒ‡å®šçš„ verbose å‚æ•°ï¼Œå°±ç­‰åŒäºå°†ä¸€ä¸ªè¾“å‡ºåˆ°æ§åˆ¶å°çš„å›è°ƒå¤„ç†å™¨æ·»åŠ åˆ°ä½ çš„å¯¹è±¡ä¸­ã€‚è¿™ä¸ªåœ¨ä½ è°ƒè¯•ç¨‹åºæ—¶éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºå®ƒä¼šå°†æ‰€æœ‰äº‹ä»¶çš„ä¿¡æ¯è¾“å‡ºåˆ°æ§åˆ¶å°ã€‚</p><p>ç®€è€Œè¨€ä¹‹ï¼ŒLangChain é€šè¿‡å›è°ƒç³»ç»Ÿæä¾›äº†ä¸€ç§çµæ´»çš„æ–¹å¼ï¼Œæ¥ç›‘æ§å’Œæ“ä½œåº”ç”¨ç¨‹åºçš„ä¸åŒé˜¶æ®µã€‚</p><h2>è‡ªå®šä¹‰å›è°ƒå‡½æ•°</h2><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡BaseCallbackHandlerå’ŒAsyncCallbackHandleræ¥è‡ªå®šä¹‰å›è°ƒå‡½æ•°ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ã€‚</p><pre><code class=\"language-plain\">import asyncio\nfrom typing import Any, Dict, List\n\nfrom langchain.chat_models import ChatOpenAI\nfrom langchain.schema import LLMResult, HumanMessage\nfrom langchain.callbacks.base import AsyncCallbackHandler, BaseCallbackHandler\n\n# åˆ›å»ºåŒæ­¥å›è°ƒå¤„ç†å™¨\nclass MyFlowerShopSyncHandler(BaseCallbackHandler):\n&nbsp; &nbsp; def on_llm_new_token(self, token: str, **kwargs) -&gt; None:\n&nbsp; &nbsp; &nbsp; &nbsp; print(f\"è·å–èŠ±å‰æ•°æ®: token: {token}\")\n\n# åˆ›å»ºå¼‚æ­¥å›è°ƒå¤„ç†å™¨\nclass MyFlowerShopAsyncHandler(AsyncCallbackHandler):\n\n&nbsp; &nbsp; async def on_llm_start(\n&nbsp; &nbsp; &nbsp; &nbsp; self, serialized: Dict[str, Any], prompts: List[str], **kwargs: Any\n&nbsp; &nbsp; ) -&gt; None:\n&nbsp; &nbsp; &nbsp; &nbsp; print(\"æ­£åœ¨è·å–èŠ±å‰æ•°æ®...\")\n&nbsp; &nbsp; &nbsp; &nbsp; await asyncio.sleep(0.5) &nbsp;# æ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œ\n&nbsp; &nbsp; &nbsp; &nbsp; print(\"èŠ±å‰æ•°æ®è·å–å®Œæ¯•ã€‚æä¾›å»ºè®®...\")\n\n&nbsp; &nbsp; async def on_llm_end(self, response: LLMResult, **kwargs: Any) -&gt; None:\n&nbsp; &nbsp; &nbsp; &nbsp; print(\"æ•´ç†èŠ±å‰å»ºè®®...\")\n&nbsp; &nbsp; &nbsp; &nbsp; await asyncio.sleep(0.5) &nbsp;# æ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œ\n&nbsp; &nbsp; &nbsp; &nbsp; print(\"ç¥ä½ ä»Šå¤©æ„‰å¿«ï¼\")\n\n# ä¸»è¦çš„å¼‚æ­¥å‡½æ•°\nasync def main():\n&nbsp; &nbsp; flower_shop_chat = ChatOpenAI(\n&nbsp; &nbsp; &nbsp; &nbsp; max_tokens=100,\n&nbsp; &nbsp; &nbsp; &nbsp; streaming=True,\n&nbsp; &nbsp; &nbsp; &nbsp; callbacks=[MyFlowerShopSyncHandler(), MyFlowerShopAsyncHandler()],\n&nbsp; &nbsp; )\n\n&nbsp; &nbsp; # å¼‚æ­¥ç”ŸæˆèŠå¤©å›å¤\n&nbsp; &nbsp; await flower_shop_chat.agenerate([[HumanMessage(content=\"å“ªç§èŠ±å‰æœ€é€‚åˆç”Ÿæ—¥ï¼Ÿåªç®€å•è¯´3ç§ï¼Œä¸è¶…è¿‡50å­—\")]])\n\n# è¿è¡Œä¸»å¼‚æ­¥å‡½æ•°\nasyncio.run(main())\n</code></pre><p>åœ¨è¿™ä¸ªé²œèŠ±åº—å®¢æœçš„ç¨‹åºä¸­ï¼Œå½“å®¢æˆ·é—®åŠå…³äºé²œèŠ±çš„å»ºè®®æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªåŒæ­¥å’Œä¸€ä¸ªå¼‚æ­¥å›è°ƒã€‚</p><p>MyFlowerShopSyncHandler æ˜¯ä¸€ä¸ªåŒæ­¥å›è°ƒï¼Œæ¯å½“æ–°çš„Tokenç”Ÿæˆæ—¶ï¼Œå®ƒå°±ç®€å•åœ°æ‰“å°å‡ºæ­£åœ¨è·å–çš„é²œèŠ±æ•°æ®ã€‚</p><p>è€Œ MyFlowerShopAsyncHandler åˆ™æ˜¯å¼‚æ­¥çš„ï¼Œå½“å®¢æœå¼€å§‹æä¾›é²œèŠ±å»ºè®®æ—¶ï¼Œå®ƒä¼šæ¨¡æ‹Ÿæ•°æ®çš„å¼‚æ­¥è·å–ã€‚åœ¨å»ºè®®å®Œæˆåï¼Œå®ƒè¿˜ä¼šæ¨¡æ‹Ÿä¸€ä¸ªç»“æŸçš„æ“ä½œï¼Œå¦‚å‘å®¢æˆ·å‘å‡ºæ„Ÿè°¢ã€‚</p><p>è¿™ç§ç»“åˆäº†åŒæ­¥å’Œå¼‚æ­¥æ“ä½œçš„æ–¹æ³•ï¼Œä½¿å¾—ç¨‹åºèƒ½å¤Ÿæ›´æœ‰æ•ˆç‡åœ°å¤„ç†å®¢æˆ·è¯·æ±‚ï¼ŒåŒæ—¶æä¾›å®æ—¶åé¦ˆã€‚</p><p><strong>è¿™é‡Œçš„å¼‚æ­¥ä½“ç°åœ¨è¿™æ ·å‡ ä¸ªæ–¹é¢ã€‚</strong></p><ol>\n<li>æ¨¡æ‹Ÿå»¶æ—¶æ“ä½œï¼šåœ¨MyFlowerShopAsyncHandlerä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†await asyncio.sleep(0.5)æ¥æ¨¡æ‹Ÿå…¶ä»–è¯·æ±‚å¼‚æ­¥è·å–èŠ±å‰ä¿¡æ¯çš„è¿‡ç¨‹ã€‚å½“æ‰§è¡Œåˆ°è¿™ä¸ªawaitè¯­å¥æ—¶ï¼Œå½“å‰çš„on_llm_startå‡½æ•°ä¼šâ€œæš‚åœâ€ï¼Œé‡Šæ”¾æ§åˆ¶æƒå›åˆ°äº‹ä»¶å¾ªç¯ã€‚è¿™æ„å‘³ç€ï¼Œåœ¨è¿™ä¸ªsleepæœŸé—´ï¼Œå…¶ä»–å¼‚æ­¥ä»»åŠ¡ï¼ˆå¦‚å…¶ä»–å®¢æˆ·çš„è¯·æ±‚ï¼‰å¯ä»¥è¢«å¤„ç†ã€‚<br>\n&nbsp;</li>\n<li>å›è°ƒæœºåˆ¶ï¼šå½“ChatOpenAIåœ¨å¤„ç†æ¯ä¸ªæ–°Tokenæ—¶ï¼Œå®ƒä¼šè°ƒç”¨on_llm_new_tokenæ–¹æ³•ã€‚å› ä¸ºè¿™æ˜¯ä¸€ä¸ªåŒæ­¥å›è°ƒï¼Œæ‰€ä»¥å®ƒä¼šç«‹å³è¾“å‡ºã€‚ä½†æ˜¯ï¼Œå¼€å§‹å’Œç»“æŸçš„å¼‚æ­¥å›è°ƒon_llm_startå’Œon_llm_endåœ¨å¼€å§‹å’Œç»“æŸæ—¶éƒ½æœ‰ä¸€ä¸ªå°çš„å»¶æ—¶æ“ä½œï¼Œè¿™æ˜¯é€šè¿‡await asyncio.sleep(0.5)æ¨¡æ‹Ÿçš„ã€‚<br>\n&nbsp;</li>\n<li>äº‹ä»¶å¾ªç¯ï¼šPythonçš„syncioåº“æä¾›äº†ä¸€ä¸ªäº‹ä»¶å¾ªç¯ï¼Œå…è®¸å¤šä¸ªå¼‚æ­¥ä»»åŠ¡å¹¶å‘è¿è¡Œã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œè™½ç„¶çœ‹èµ·æ¥æ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯æŒ‰é¡ºåºå‘ç”Ÿçš„ï¼Œä½†ç”±äºæˆ‘ä»¬ä½¿ç”¨äº†å¼‚æ­¥æ“ä½œå’Œå›è°ƒï¼Œå¦‚æœæœ‰å…¶ä»–å¹¶å‘ä»»åŠ¡ï¼Œå®ƒä»¬å¯ä»¥åœ¨awaitæš‚åœæœŸé—´è¿è¡Œã€‚</li>\n</ol><p>ä¸ºäº†æ›´æ¸…æ™°åœ°å±•ç¤ºå¼‚æ­¥çš„ä¼˜åŠ¿ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šåœ¨ç¨‹åºä¸­åŒæ—¶è¿è¡Œå¤šä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œå¹¶è§‚å¯Ÿå®ƒä»¬å¦‚ä½•â€œå¹¶å‘â€æ‰§è¡Œã€‚ä½†åœ¨è¿™ä¸ªç®€å•çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦æ˜¯é€šè¿‡æ¨¡æ‹Ÿå»¶æ—¶æ¥å±•ç¤ºå¼‚æ­¥æ“ä½œçš„åŸºæœ¬æœºåˆ¶ã€‚</p><p>å› æ­¤è¯´ï¼Œå›è°ƒå‡½æ•°ä¸ºå¼‚æ­¥æ“ä½œæä¾›äº†ä¸€ä¸ªæœºåˆ¶ï¼Œä½¿ä½ å¯ä»¥å®šä¹‰â€œå½“æ“ä½œå®Œæˆæ—¶è¦åšä»€ä¹ˆâ€ï¼Œè€Œå¼‚æ­¥æœºåˆ¶çš„çœŸæ­£å®ç°æ¶‰åŠæ›´æ·±å±‚æ¬¡çš„åº•å±‚å·¥ä½œï¼Œå¦‚äº‹ä»¶å¾ªç¯å’Œä»»åŠ¡è°ƒåº¦ã€‚</p><h2>ç”¨ get_openai_callback æ„é€ ä»¤ç‰Œè®¡æ•°å™¨</h2><p>ä¸‹é¢ï¼Œæˆ‘å¸¦ç€ä½ ä½¿ç”¨LangChainä¸­çš„å›è°ƒå‡½æ•°æ¥æ„é€ ä¸€ä¸ªä»¤ç‰Œè®¡æ•°å™¨ã€‚è¿™ä¸ªè®¡æ•°åŠŸèƒ½å¯¹äºç›‘æ§å¤§æ¨¡å‹çš„ä¼šè¯æ¶ˆè€—ä»¥åŠæˆæœ¬æ§åˆ¶ååˆ†é‡è¦ã€‚</p><p>åœ¨æ„é€ ä»¤ç‰Œè®¡æ•°å™¨ä¹‹å‰ï¼Œæˆ‘ä»¬æ¥å›å¿†ä¸€ä¸‹<a href=\"https://time.geekbang.org/column/article/704183\">ç¬¬10è¯¾</a>ä¸­çš„è®°å¿†æœºåˆ¶ã€‚æˆ‘ä»¬ç”¨ä¸‹é¢çš„ä»£ç ç”Ÿæˆäº†ConversationBufferMemoryã€‚</p><pre><code class=\"language-plain\">from langchain import OpenAI\nfrom langchain.chains import ConversationChain\nfrom langchain.chains.conversation.memory import ConversationBufferMemory\n\n# åˆå§‹åŒ–å¤§è¯­è¨€æ¨¡å‹\nllm = OpenAI(\n&nbsp; &nbsp; temperature=0.5,\n&nbsp; &nbsp; model_name=\"gpt-3.5-turbo-instruct\")\n\n# åˆå§‹åŒ–å¯¹è¯é“¾\nconversation = ConversationChain(\n&nbsp; &nbsp; llm=llm,\n&nbsp; &nbsp; memory=ConversationBufferMemory()\n)\n\n# ç¬¬ä¸€å¤©çš„å¯¹è¯\n# å›åˆ1\nconversation(\"æˆ‘å§å§æ˜å¤©è¦è¿‡ç”Ÿæ—¥ï¼Œæˆ‘éœ€è¦ä¸€æŸç”Ÿæ—¥èŠ±æŸã€‚\")\nprint(\"ç¬¬ä¸€æ¬¡å¯¹è¯åçš„è®°å¿†:\", conversation.memory.buffer)\n\n# å›åˆ2\nconversation(\"å¥¹å–œæ¬¢ç²‰è‰²ç«ç‘°ï¼Œé¢œè‰²æ˜¯ç²‰è‰²çš„ã€‚\")\nprint(\"ç¬¬äºŒæ¬¡å¯¹è¯åçš„è®°å¿†:\", conversation.memory.buffer)\n\n# å›åˆ3 ï¼ˆç¬¬äºŒå¤©çš„å¯¹è¯ï¼‰\nconversation(\"æˆ‘åˆæ¥äº†ï¼Œè¿˜è®°å¾—æˆ‘æ˜¨å¤©ä¸ºä»€ä¹ˆè¦æ¥ä¹°èŠ±å—ï¼Ÿ\")\nprint(\"/nç¬¬ä¸‰æ¬¡å¯¹è¯åæ—¶æç¤º:/n\",conversation.prompt.template)\nprint(\"/nç¬¬ä¸‰æ¬¡å¯¹è¯åçš„è®°å¿†:/n\", conversation.memory.buffer)\n</code></pre><p>åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿç»™å‡ºäº†å„ç§è®°å¿†æœºåˆ¶å¯¹Tokençš„æ¶ˆè€—æ•°é‡çš„ä¼°ç®—ç¤ºæ„å›¾ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/b6/52/b605f14e7c9151c5172fff5860285e52.png?wh=3627x1427\" alt=\"\" title=\"å½“å¯¹è¯è½®æ¬¡é€æ¸å¢åŠ æ—¶ï¼Œå„ç§è®°å¿†æœºåˆ¶å¯¹ Token çš„æ¶ˆè€—æ•°é‡ä¼°ç®—\"></p><p>ä¸è¿‡ï¼Œè¿™å¼ å›¾æ¯•ç«Ÿæ˜¯ä¼°ç®—ï¼Œè¦çœŸæ­£åœ°è¡¡é‡å‡ºæ¯ç§è®°å¿†æœºåˆ¶åˆ°åº•è€—è´¹äº†å¤šå°‘ä¸ªTokenï¼Œé‚£å°±éœ€è¦å›è°ƒå‡½æ•°ä¸Šåœºäº†ã€‚</p><p>ä¸‹é¢ï¼Œæˆ‘ä»¬é€šè¿‡å›è°ƒå‡½æ•°æœºåˆ¶ï¼Œé‡æ„è¿™æ®µç¨‹åºã€‚ä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦ç¡®ä¿åœ¨ä¸å¤§è¯­è¨€æ¨¡å‹è¿›è¡Œäº¤äº’æ—¶ï¼Œä½¿ç”¨äº†get_openai_callbackä¸Šä¸‹æ–‡ç®¡ç†å™¨ã€‚</p><blockquote>\n<p><span class=\"reference\">åœ¨Pythonä¸­ï¼Œä¸€ä¸ªä¸Šä¸‹æ–‡ç®¡ç†å™¨é€šå¸¸ç”¨äºç®¡ç†èµ„æºï¼Œå¦‚æ–‡ä»¶æˆ–ç½‘ç»œè¿æ¥ï¼Œè¿™äº›èµ„æºåœ¨ä½¿ç”¨å‰éœ€è¦è®¾ç½®ï¼Œåœ¨ä½¿ç”¨åéœ€è¦æ¸…ç†ã€‚ä¸Šä¸‹æ–‡ç®¡ç†å™¨ç»å¸¸ä¸withè¯­å¥ä¸€èµ·ä½¿ç”¨ï¼Œä»¥ç¡®ä¿èµ„æºæ­£ç¡®åœ°è®¾ç½®å’Œæ¸…ç†ã€‚</span><br>\n&nbsp;<br>\n<span class=\"reference\">get_openai_callbackè¢«è®¾è®¡ç”¨æ¥ç›‘æ§ä¸OpenAIäº¤äº’çš„Tokenæ•°é‡ã€‚å½“ä½ è¿›å…¥è¯¥ä¸Šä¸‹æ–‡æ—¶ï¼Œå®ƒä¼šé€šè¿‡ç›‘å¬å™¨è·Ÿè¸ªTokençš„ä½¿ç”¨ã€‚å½“ä½ é€€å‡ºä¸Šä¸‹æ–‡æ—¶ï¼Œå®ƒä¼šæ¸…ç†ç›‘å¬å™¨å¹¶æä¾›ä¸€ä¸ªTokençš„æ€»æ•°ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå®ƒå……å½“äº†ä¸€ä¸ªå›è°ƒæœºåˆ¶ï¼Œå…è®¸ä½ åœ¨ç‰¹å®šäº‹ä»¶å‘ç”Ÿæ—¶æ‰§è¡Œç‰¹å®šçš„æ“ä½œæˆ–æ”¶é›†ç‰¹å®šçš„ä¿¡æ¯ã€‚</span></p>\n</blockquote><p>å…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">from langchain import OpenAI\nfrom langchain.chains import ConversationChain\nfrom langchain.chains.conversation.memory import ConversationBufferMemory\nfrom langchain.callbacks import get_openai_callback\n\n# åˆå§‹åŒ–å¤§è¯­è¨€æ¨¡å‹\nllm = OpenAI(temperature=0.5, model_name=\"gpt-3.5-turbo-instruct\")\n\n# åˆå§‹åŒ–å¯¹è¯é“¾\nconversation = ConversationChain(\n&nbsp; &nbsp; llm=llm,\n&nbsp; &nbsp; memory=ConversationBufferMemory()\n)\n\n# ä½¿ç”¨context managerè¿›è¡Œtoken counting\nwith get_openai_callback() as cb:\n&nbsp; &nbsp; # ç¬¬ä¸€å¤©çš„å¯¹è¯\n&nbsp; &nbsp; # å›åˆ1\n&nbsp; &nbsp; conversation(\"æˆ‘å§å§æ˜å¤©è¦è¿‡ç”Ÿæ—¥ï¼Œæˆ‘éœ€è¦ä¸€æŸç”Ÿæ—¥èŠ±æŸã€‚\")\n&nbsp; &nbsp; print(\"ç¬¬ä¸€æ¬¡å¯¹è¯åçš„è®°å¿†:\", conversation.memory.buffer)\n\n&nbsp; &nbsp; # å›åˆ2\n&nbsp; &nbsp; conversation(\"å¥¹å–œæ¬¢ç²‰è‰²ç«ç‘°ï¼Œé¢œè‰²æ˜¯ç²‰è‰²çš„ã€‚\")\n&nbsp; &nbsp; print(\"ç¬¬äºŒæ¬¡å¯¹è¯åçš„è®°å¿†:\", conversation.memory.buffer)\n\n&nbsp; &nbsp; # å›åˆ3 ï¼ˆç¬¬äºŒå¤©çš„å¯¹è¯ï¼‰\n&nbsp; &nbsp; conversation(\"æˆ‘åˆæ¥äº†ï¼Œè¿˜è®°å¾—æˆ‘æ˜¨å¤©ä¸ºä»€ä¹ˆè¦æ¥ä¹°èŠ±å—ï¼Ÿ\")\n&nbsp; &nbsp; print(\"/nç¬¬ä¸‰æ¬¡å¯¹è¯åæ—¶æç¤º:/n\",conversation.prompt.template)\n&nbsp; &nbsp; print(\"/nç¬¬ä¸‰æ¬¡å¯¹è¯åçš„è®°å¿†:/n\", conversation.memory.buffer)\n\n# è¾“å‡ºä½¿ç”¨çš„tokens\nprint(\"\\næ€»è®¡ä½¿ç”¨çš„tokens:\", cb.total_tokens)\n</code></pre><p>è¿™é‡Œï¼Œæˆ‘ä½¿ç”¨äº†get_openai_callbackä¸Šä¸‹æ–‡ç®¡ç†å™¨æ¥ç›‘æ§ä¸ConversationChainçš„äº¤äº’ã€‚è¿™å…è®¸æˆ‘ä»¬è®¡ç®—åœ¨è¿™äº›äº¤äº’ä¸­ä½¿ç”¨çš„æ€»Tokensæ•°ã€‚</p><p>è¾“å‡ºï¼š</p><pre><code class=\"language-plain\">æ€»è®¡ä½¿ç”¨çš„tokens: 966\n</code></pre><p>ä¸‹é¢ï¼Œæˆ‘å†æ·»åŠ äº†ä¸€ä¸ªadditional_interactionså¼‚æ­¥å‡½æ•°ï¼Œç”¨äºæ¼”ç¤ºå¦‚ä½•åœ¨å¤šä¸ªå¹¶å‘äº¤äº’ä¸­è®¡ç®—Tokensã€‚</p><blockquote>\n<p><span class=\"reference\">å½“æˆ‘ä»¬è®¨è®ºå¼‚æ­¥äº¤äº’æ—¶ï¼ŒæŒ‡çš„æ˜¯æˆ‘ä»¬å¯ä»¥å¯åŠ¨å¤šä¸ªä»»åŠ¡ï¼Œå®ƒä»¬å¯ä»¥å¹¶å‘ï¼ˆè€Œä¸æ˜¯å¹¶è¡Œï¼‰åœ°è¿è¡Œï¼Œå¹¶ä¸”ä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹ã€‚åœ¨Pythonä¸­ï¼Œè¿™æ˜¯é€šè¿‡asyncioåº“å®ç°çš„ï¼Œå®ƒä½¿ç”¨äº‹ä»¶å¾ªç¯æ¥ç®¡ç†å¹¶å‘çš„å¼‚æ­¥ä»»åŠ¡ã€‚</span></p>\n</blockquote><pre><code class=\"language-plain\">import asyncio\n# è¿›è¡Œæ›´å¤šçš„å¼‚æ­¥äº¤äº’å’Œtokenè®¡æ•°\nasync def additional_interactions():\n&nbsp; &nbsp; with get_openai_callback() as cb:\n&nbsp; &nbsp; &nbsp; &nbsp; await asyncio.gather(\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *[llm.agenerate([\"æˆ‘å§å§å–œæ¬¢ä»€ä¹ˆé¢œè‰²çš„èŠ±ï¼Ÿ\"]) for _ in range(3)]\n&nbsp; &nbsp; &nbsp; &nbsp; )\n&nbsp; &nbsp; print(\"\\nå¦å¤–çš„äº¤äº’ä¸­ä½¿ç”¨çš„tokens:\", cb.total_tokens)\n\n# è¿è¡Œå¼‚æ­¥å‡½æ•°\nasyncio.run(additional_interactions())\n</code></pre><p>ç®€å•è§£é‡Šä¸€ä¸‹ã€‚</p><ol>\n<li><code>async def</code>ï¼šè¿™è¡¨ç¤ºadditional_interactionsæ˜¯ä¸€ä¸ªå¼‚æ­¥å‡½æ•°ã€‚å®ƒå¯ä»¥ä½¿ç”¨awaitå…³é”®å­—åœ¨å…¶ä¸­æŒ‚èµ·æ‰§è¡Œï¼Œå…è®¸å…¶ä»–å¼‚æ­¥ä»»åŠ¡ç»§ç»­ã€‚</li>\n<li><code>await asyncio.gather(...)</code>ï¼šè¿™æ˜¯asyncioåº“æä¾›çš„ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„æ–¹æ³•ï¼Œç”¨äºå¹¶å‘åœ°è¿è¡Œå¤šä¸ªå¼‚æ­¥ä»»åŠ¡ã€‚å®ƒä¼šç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼Œç„¶åç»§ç»­æ‰§è¡Œã€‚</li>\n<li><code>*[llm.agenerate([\"æˆ‘å§å§å–œæ¬¢ä»€ä¹ˆé¢œè‰²çš„èŠ±ï¼Ÿ\"]) for _ in range(3)]</code>ï¼šè¿™å®é™…ä¸Šæ˜¯ä¸€ä¸ªPythonåˆ—è¡¨è§£æï¼Œå®ƒç”Ÿæˆäº†3ä¸ª llm.agenerate(â€¦)çš„å¼‚æ­¥è°ƒç”¨ã€‚asyncio.gatherå°†å¹¶å‘åœ°è¿è¡Œè¿™3ä¸ªè°ƒç”¨ã€‚</li>\n</ol><p>ç”±äºè¿™3ä¸ªllm.agenerateè°ƒç”¨æ˜¯å¹¶å‘çš„ï¼Œæ‰€ä»¥å®ƒä»¬ä¸ä¼šæŒ‰é¡ºåºæ‰§è¡Œï¼Œè€Œæ˜¯å‡ ä¹åŒæ—¶å¯åŠ¨ï¼Œå¹¶åœ¨å„è‡ªå®Œæˆæ—¶è¿”å›ã€‚è¿™æ„å‘³ç€ï¼Œå³ä½¿å…¶ä¸­ä¸€ä¸ªè°ƒç”¨ç”±äºæŸç§åŸå› éœ€è¦æ›´é•¿æ—¶é—´ï¼Œå…¶ä»–è°ƒç”¨ä¹Ÿä¸ä¼šè¢«é˜»å¡ï¼Œå®ƒä»¬ä¼šç»§ç»­å¹¶å®Œæˆã€‚</p><h2>æ€»ç»“æ—¶åˆ»</h2><p>å›è°ƒå‡½æ•°æ˜¯è®¡ç®—æœºç§‘å­¦ä¸­ä¸€ä¸ªé‡è¦å’Œå¹¿æ³›åº”ç”¨çš„æ¦‚å¿µï¼Œå®ƒå…è®¸æˆ‘ä»¬åœ¨ç‰¹å®šçš„æ—¶é—´æˆ–æ¡ä»¶ä¸‹æ‰§è¡Œç‰¹å®šçš„ä»£ç ã€‚</p><p>å›è°ƒå‡½æ•°åœ¨å¼€å‘è¿‡ç¨‹ä¸­æœ‰å¾ˆå¤šåº”ç”¨åœºæ™¯ã€‚</p><ol>\n<li>å¼‚æ­¥ç¼–ç¨‹ï¼šåœ¨JavaScriptä¸­ï¼Œå›è°ƒå‡½æ•°å¸¸å¸¸ç”¨äºå¼‚æ­¥ç¼–ç¨‹ã€‚ä¾‹å¦‚ï¼Œå½“ä½ å‘é€ä¸€ä¸ªAJAXè¯·æ±‚åˆ°æœåŠ¡å™¨æ—¶ï¼Œä½ å¯ä»¥æä¾›ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å°†åœ¨æœåŠ¡å™¨çš„å“åº”åˆ°è¾¾æ—¶è¢«è°ƒç”¨ã€‚</li>\n<li>äº‹ä»¶å¤„ç†ï¼šåœ¨è®¸å¤šç¼–ç¨‹è¯­è¨€å’Œæ¡†æ¶ä¸­ï¼Œå›è°ƒå‡½æ•°è¢«ç”¨ä½œäº‹ä»¶å¤„ç†å™¨ã€‚ä¾‹å¦‚ï¼Œä½ å¯èƒ½ä¼šå†™ä¸€ä¸ªå›è°ƒå‡½æ•°æ¥å¤„ç†ç”¨æˆ·çš„ç‚¹å‡»äº‹ä»¶ï¼Œå½“ç”¨æˆ·ç‚¹å‡»æŸä¸ªæŒ‰é’®æ—¶ï¼Œè¿™ä¸ªå‡½æ•°å°±ä¼šè¢«è°ƒç”¨ã€‚</li>\n<li>å®šæ—¶å™¨ï¼šä½ å¯ä»¥ä½¿ç”¨å›è°ƒå‡½æ•°æ¥åˆ›å»ºå®šæ—¶å™¨ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥ä½¿ç”¨JavaScriptçš„setTimeoutæˆ–setIntervalå‡½æ•°ï¼Œå¹¶æä¾›ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¼šåœ¨æŒ‡å®šçš„æ—¶é—´è¿‡åè¢«è°ƒç”¨ã€‚</li>\n</ol><p>åœ¨ LangChain ä¸­ï¼Œå›è°ƒæœºåˆ¶åŒæ ·ä¸ºç”¨æˆ·æä¾›äº†çµæ´»æ€§å’Œè‡ªå®šä¹‰èƒ½åŠ›ï¼Œä»¥ä¾¿æ›´å¥½åœ°æ§åˆ¶å’Œå“åº”äº‹ä»¶ã€‚CallbackHandlerå…è®¸å¼€å‘è€…åœ¨é“¾çš„ç‰¹å®šé˜¶æ®µæˆ–æ¡ä»¶ä¸‹æ³¨å…¥è‡ªå®šä¹‰çš„è¡Œä¸ºï¼Œä¾‹å¦‚å¼‚æ­¥ç¼–ç¨‹ä¸­çš„å“åº”å¤„ç†ã€äº‹ä»¶é©±åŠ¨ç¼–ç¨‹ä¸­çš„äº‹ä»¶å¤„ç†ç­‰ã€‚è¿™ä¸º LangChain æä¾›äº†çµæ´»æ€§å’Œæ‰©å±•æ€§ï¼Œä½¿å…¶èƒ½å¤Ÿé€‚åº”å„ç§åº”ç”¨åœºæ™¯ã€‚</p><h2>æ€è€ƒé¢˜</h2><ol>\n<li>æˆ‘é€šè¿‡get_openai_callbacké‡æ„äº†ConversationBufferMemoryçš„ç¨‹åºï¼Œä½ èƒ½å¦æŠŠè¿™ä¸ªä»¤ç‰Œè®¡æ•°å™¨å®ç°åˆ°å…¶ä»–è®°å¿†æœºåˆ¶ä¸­ï¼Ÿ<br>\n&nbsp;</li>\n<li>åœ¨LangChainå¼€å‘è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥åœ¨æ„é€ å‡½æ•°ä¸­å¼•å…¥å›è°ƒæœºåˆ¶ï¼Œæˆ‘ç»™å‡ºäº†ä¸€ä¸ªç¤ºä¾‹ï¼Œä½ èƒ½å¦å°è¯•åœ¨è¯·æ±‚è¿‡ç¨‹ï¼ˆrun/applyæ–¹æ³•ï¼‰ä¸­å¼•å…¥å›è°ƒæœºåˆ¶ï¼Ÿ</li>\n</ol><p>æç¤ºï¼šè¯·æ±‚å›è°ƒå¸¸ç”¨åœ¨æµå¼ä¼ è¾“çš„å®ç°ä¸­ã€‚åœ¨ä¼ ç»Ÿçš„ä¼ è¾“ä¸­ï¼Œæˆ‘ä»¬å¿…é¡»ç­‰å¾…è¿™ä¸ªå‡½æ•°ç”Ÿæˆæ‰€æœ‰æ•°æ®åæ‰èƒ½å¼€å§‹å¤„ç†ã€‚åœ¨æµå¼ä¼ è¾“ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ•°æ®è¢«ç”Ÿæˆæ—¶ç«‹å³å¼€å§‹å¤„ç†ã€‚å¦‚æœä½ æƒ³å°†å•ä¸ªè¯·æ±‚çš„è¾“å‡ºæµå¼ä¼ è¾“åˆ°ä¸€ä¸ªWebSocketï¼Œä½ å¯ä»¥å°†ä¸€ä¸ªCallbackå¤„ç†å™¨ä¼ é€’ç»™ call() æ–¹æ³•ã€‚</p><p>æœŸå¾…åœ¨ç•™è¨€åŒºçœ‹åˆ°ä½ çš„åˆ†äº«ï¼Œå¦‚æœè§‰å¾—å†…å®¹å¯¹ä½ æœ‰å¸®åŠ©ï¼Œä¹Ÿæ¬¢è¿åˆ†äº«ç»™æœ‰éœ€è¦çš„æœ‹å‹ï¼æœ€åå¦‚æœä½ å­¦æœ‰ä½™åŠ›ï¼Œå¯ä»¥è¿›ä¸€æ­¥å­¦ä¹ ä¸‹é¢çš„å»¶ä¼¸é˜…è¯»ã€‚</p><h2>å»¶ä¼¸é˜…è¯»</h2><ol>\n<li>GitHub ä»£ç ï¼š<a href=\"https://github.com/langchain-ai/langchain/blob/master/libs/langchain/langchain/callbacks/base.py\">CallbackHandler</a> ä¸­çš„å¯ç›‘æ§äº‹ä»¶å’Œæ–¹æ³•</li>\n<li>æ–‡æ¡£ï¼šLangChainä¸­çš„<a href=\"https://python.langchain.com/docs/modules/callbacks/\">å›è°ƒ</a>æœºåˆ¶</li>\n<li>æ–‡æ¡£ï¼šä»€ä¹ˆæ˜¯<a href=\"https://www.zhihu.com/question/19801131\">å›è°ƒå‡½æ•°</a>ï¼ˆçŸ¥ä¹ï¼‰</li>\n</ol>","neighbors":{"left":{"article_title":"16ï½œè¿æ¥æ•°æ®åº“ï¼šé€šè¿‡é“¾å’Œä»£ç†æŸ¥è¯¢é²œèŠ±ä¿¡æ¯","id":713462},"right":{"article_title":"18ï½œCAMELï¼šé€šè¿‡è§’è‰²æ‰®æ¼”è„‘æš´ä¸€ä¸ªé²œèŠ±è¥é”€æ–¹æ¡ˆ","id":714249}},"comments":[{"had_liked":false,"id":382673,"user_name":"é˜¿æ–¯è’‚èŠ¬","can_delete":false,"product_type":"c1","uid":1024164,"ip_address":"å¹¿ä¸œ","ucode":"61D5E3BDA4EBC5","user_header":"https://static001.geekbang.org/account/avatar/00/0f/a0/a4/b060c723.jpg","comment_is_top":true,"comment_ctime":1697784943,"is_pvip":false,"replies":[{"id":139438,"content":"å—¯å—¯ï¼Œä½ æ˜¯è¯¾ä»£è¡¨å•Šã€‚ä½œä¸šåšçš„åˆç»†åˆå¥½ã€‚å¥½æ»´ï¼Œç¬¬ä¸€ä¸ªæˆ‘ä»¬ç»Ÿä¸€æˆ0.5ï¼Œç¬¬2ä¸ªç»éªŒä¹Ÿéå¸¸å®è´µï¼Œå€¼å¾—ç”¨ä»£ç†çš„ç«¥é‹å€Ÿé‰´ã€‚å€¼å¾—ç½®é¡¶ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1809833,"ctime":1698138139,"ip_address":"ç‘å£«","comment_id":382673,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100617601,"comment_content":"ç¬”è®°markï¼š\n\n\n1.ç–‘ä¼¼çº é”™ï¼š\nç¬¬äºŒä¸ªä»£ç ç¤ºä¾‹åå†™é“ï¼šã€compute å‡½æ•°å¼€å§‹æ‰§è¡Œã€‚å½“å®ƒé‡åˆ° await asyncio.sleep(2) æ—¶ï¼Œå®ƒä¼šæš‚åœã€‘\nä½†æ˜¯ä»£ç ä¸­æ˜¯ await asyncio.sleep(0.5)ï¼Œä¼‘çœ æ—¶é•¿ä¼šå½±å“æœ€ç»ˆç¨‹åºçš„æ‰“å°è¾“å‡ºé¡ºåºï¼›\nåé¢èŠ±å‰éƒ¨åˆ† ã€åœ¨ MyFlowerShopAsyncHandler ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† await asyncio.sleep(0.3) ã€‘ä¹Ÿä¸ä»£ç ä¸­çš„ await asyncio.sleep(0.5) ä¸ä¸€è‡´ï¼›\nå¦‚æœå±å®ï¼Œè¿˜æ˜¯å»ºè®®ä¿®æ”¹ä¸‹ï¼Œå¦åˆ™å®¹æ˜“é€ æˆå›°æƒ‘\n\n\n2. è‡ªå®šä¹‰å›è°ƒå‡½æ•° ä»£ç æŠ¥é”™é—®é¢˜\nä¸€å¼€å§‹ç›´æ¥ä½¿ç”¨è€å¸ˆçš„ä»£ç ï¼Œæœªèƒ½è·å¾—æµå¼å“åº”çš„æ‰“å°ï¼Œå‡ºç°æŠ¥é”™ï¼š\nRetrying langchain.chat_models.openai.acompletion_with_retry.&lt;locals&gt;._completion_with_retry in 4.0 seconds as it raised APIConnectionError: Error communicating with OpenAI.\nä½†æ˜¯æ­¤æ—¶éæµå¼çš„å“åº”ï¼Œæ˜¯èƒ½å¤Ÿæ­£å¸¸å®Œæˆçš„ï¼›\næŠ˜è…¾è®¸ä¹…ï¼Œå®šä½åˆ°æ˜¯openaiä»£ç†çš„é—®é¢˜ï¼Œä½†æ˜¯æµå¼å“åº”æ˜¯é€šè¿‡SSEåè®®ï¼Œæ­¤æ—¶vpnä¼¼ä¹è¢«ç»•è¿‡äº†ï¼Œå°†vpnä»£ç†æ˜¾ç¤ºæ·»åŠ åˆ° OPENAI_PROXY ç¯å¢ƒå˜é‡åè§£å†³\n\n3. æœ€åçš„ additional_interactions() ç¤ºä¾‹ä¸­ï¼Œå¯ä»¥å°† asynio.gather çš„è¿”å›ç»“æœæ‰“å°å‡ºæ¥ï¼Œèƒ½å¤Ÿçœ‹åˆ°æ¯ä¸ªä»»åŠ¡ä½¿ç”¨çš„tokenæ•°é‡ï¼Œä¸æœ€ç»ˆçš„æ€»æ•°æ˜¯ä¸€è‡´çš„","like_count":1,"discussions":[{"author":{"id":1809833,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/9d/a9/4602808f.jpg","nickname":"é»„ä½³","note":"","ucode":"8EC41D2EAB0E3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":630141,"discussion_content":"å—¯å—¯ï¼Œä½ æ˜¯è¯¾ä»£è¡¨å•Šã€‚ä½œä¸šåšçš„åˆç»†åˆå¥½ã€‚å¥½æ»´ï¼Œç¬¬ä¸€ä¸ªæˆ‘ä»¬ç»Ÿä¸€æˆ0.5ï¼Œç¬¬2ä¸ªç»éªŒä¹Ÿéå¸¸å®è´µï¼Œå€¼å¾—ç”¨ä»£ç†çš„ç«¥é‹å€Ÿé‰´ã€‚å€¼å¾—ç½®é¡¶ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1698138139,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"ç‘å£«","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":382672,"user_name":"é˜¿æ–¯è’‚èŠ¬","can_delete":false,"product_type":"c1","uid":1024164,"ip_address":"å¹¿ä¸œ","ucode":"61D5E3BDA4EBC5","user_header":"https://static001.geekbang.org/account/avatar/00/0f/a0/a4/b060c723.jpg","comment_is_top":false,"comment_ctime":1697783713,"is_pvip":false,"replies":[{"id":139463,"content":"ğŸ¤´ğŸ»","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1809833,"ctime":1698155394,"ip_address":"ç‘å£«","comment_id":382672,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100617601,"comment_content":"æ¥äº¤ä½œä¸šäº†ï¼š\n\næ€è€ƒé¢˜1ï¼š\nåœ¨ç¡®ä¿æ•ˆæœç›¸åŒçš„ä¸‰è½®äº¤äº’ä¸­ï¼Œä½¿ç”¨äº†å…¶ä»–è®°å¿†æœºåˆ¶ï¼Œå¹¶è®°å½•ä»¤ç‰Œä½¿ç”¨æƒ…å†µï¼ˆåˆ†åˆ«æµ‹è¯•ä¸‰æ¬¡å–èŒƒå›´å€¼ï¼‰\nConversationBufferMemory: 1000 ~ 1500\nConversationBufferWindowMemory(k=2): 1200 ~ 1600\nConversationSummaryMemory: 2000 ~ 2500\nConversationSummaryBufferMemory(max_token_limt=300): 1000~1500\n\nå¤§è‡´çœ‹ä¹Ÿç¬¦åˆä¼°ç®—ç¤ºæ„å›¾ç¬¬ä¸€é˜¶æ®µ 0-5 interacitions çš„èµ°åŠ¿ï¼ŒConversationSummaryMemory å¢é•¿è¾ƒå¿«ï¼Œå…¶ä»–å‡ ä¸ªå¢é•¿é€Ÿç‡è¾ƒä¸ºä¸€è‡´\n\n\næ€è€ƒé¢˜2ï¼š\nä½¿ç”¨LLMChainçš„ run æ–¹æ³•ä¹Ÿå¯ä»¥ä¼ é€’callback\n\nclass MyCallBackHandler(BaseCallbackHandler):\n    def on_llm_new_token(self, token: str, **kwargs) -&gt; None:\n        print(f&quot;recv token: {token}&quot;)\n\n\nllm = ChatOpenAI(streaming=True)\nprompt = PromptTemplate.from_template(&quot;1 + {number} = &quot;)\n\n\nchain = LLMChain(llm=llm, prompt=prompt)\nchain.run(number=2, callbacks=[MyCallBackHandler()])\n\nå…¶å®è¿™ä¸ªç¤ºä¾‹å°±æ˜¯ä»è€å¸ˆçš„å»¶ä¼¸é˜…è¯»ä¸­â€œæ‹¿æ¥â€çš„ï¼Œä¸çŸ¥ç­”å¯¹æ²¡","like_count":1,"discussions":[{"author":{"id":1809833,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/9d/a9/4602808f.jpg","nickname":"é»„ä½³","note":"","ucode":"8EC41D2EAB0E3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":630184,"discussion_content":"ğŸ¤´ğŸ»","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1698155394,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"ç‘å£«","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":383837,"user_name":"æ‚Ÿå°˜","can_delete":false,"product_type":"c1","uid":2189310,"ip_address":"åŒ—äº¬","ucode":"4E7E854340D3A4","user_header":"https://static001.geekbang.org/account/avatar/00/21/67/fe/5d17661a.jpg","comment_is_top":false,"comment_ctime":1699777494,"is_pvip":false,"replies":[{"id":140181,"content":"åŒå­¦ï¼Œå…·ä½“æŒ‡çš„æ˜¯å“ªä¸€æ®µä»£ç çš„è¾“å‡ºç»“æœï¼Œæˆ‘å›å¤´çœ‹çœ‹ã€‚ã€‚ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1809833,"ctime":1700581433,"ip_address":"ç‘å£«","comment_id":383837,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100617601,"comment_content":"è€å¸ˆï¼Œè¿™èŠ‚è¯¾å°‘äº†è¾“å‡ºç»“æœçš„æ¼”ç¤º~ç†è§£èµ·æ¥æœ‰ç‚¹è´¹åŠ²","like_count":0,"discussions":[{"author":{"id":1809833,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/9d/a9/4602808f.jpg","nickname":"é»„ä½³","note":"","ucode":"8EC41D2EAB0E3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":632229,"discussion_content":"åŒå­¦ï¼Œå…·ä½“æŒ‡çš„æ˜¯å“ªä¸€æ®µä»£ç çš„è¾“å‡ºç»“æœï¼Œæˆ‘å›å¤´çœ‹çœ‹ã€‚ã€‚ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1700581433,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"ç‘å£«","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":393849,"user_name":"yanyu-xin","can_delete":false,"product_type":"c1","uid":1899757,"ip_address":"å¹¿ä¸œ","ucode":"3AA389F9E4C236","user_header":"","comment_is_top":false,"comment_ctime":1725089614,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100617601,"comment_content":"###3 å°†è¯¾ç¨‹ä»£ç åˆ°å¤§æ¨¡å‹ä¿®è®¢ä¸ºå›½äº§é€šä¹‰åƒé—®æ¨¡å‹ï¼ˆ03_LangChainOpenAICallback.pyï¼‰\n###â€œç”¨ get_openai_callback æ„é€ ä»¤ç‰Œè®¡æ•°å™¨â€ä»£ç ã€‚ç”¨ ChatOpenAIå’Œåƒé—®æ¨¡å‹å¹³æ›¿ OpenAI\n# åŸä»£ç 3\nllm = OpenAI()\n# æ–°ä»£ç 3\nfrom langchain_openai import ChatOpenAI\nllm = ChatOpenAI(\n        model_name=&quot;qwen-turbo&quot;,\n        stream_usage=True,\n        api_key= â€œAPI_KEYâ€, #å¡«å†™ä½ è‡ªå·±çš„DASHSCOPE_API_KEY\n        base_url=&quot;https:&#47;&#47;dashscope.aliyuncs.com&#47;compatible-mode&#47;v1&quot;, \n    )\n\n###4 ä¿®æ”¹â€œadditional_interactions å¼‚æ­¥å‡½æ•°â€ä»£ç ï¼ˆ03_LangChainOpenAICallback.pyï¼‰ï¼Œå°†llm.agenerateä¸­çš„å‚æ•°ç”¨ langchain_core.messages ä¿®è®¢ã€‚\n\n# æ—§ä»£ç 4\nimport asyncio\nasync def additional_interactions():\n    with get_openai_callback() as cb:\n        await asyncio.gather(\n            *[llm.agenerate([&quot;æˆ‘å§å§å–œæ¬¢ä»€ä¹ˆé¢œè‰²çš„èŠ±ï¼Ÿ&quot;]) for _ in range(3)]\n        )\n    print(&quot;\\nå¦å¤–çš„äº¤äº’ä¸­ä½¿ç”¨çš„tokens:&quot;, cb.total_tokens)\nasyncio.run(additional_interactions())\n\n# æ–°ä»£ç 4\nimport asyncio\nfrom langchain_core.messages import HumanMessage, SystemMessage\nmessages = [[\n            SystemMessage(content=&quot;ä½ æ˜¯ä¸ªèŠ±åº—å°åŠ©æ‰‹ã€‚&quot;),\n            HumanMessage(content=&quot;æˆ‘å§å§å–œæ¬¢ä»€ä¹ˆé¢œè‰²çš„èŠ±ï¼Ÿ&quot;),\n        ]]\n\n#è¿›è¡Œæ›´å¤šçš„å¼‚æ­¥äº¤äº’å’Œtokenè®¡æ•°\nasync def additional_interactions():\n    print(&quot;\\nå¼€å§‹è¿›è¡Œæ›´å¤šçš„äº¤äº’...&quot;)\n    with get_openai_callback() as cb:\n        await asyncio.gather(\n\n            *[llm.agenerate(messages) for _ in range(3)]\n        )\n   print(f&quot;äº¤äº’{i+1}ä½¿ç”¨çš„tokens: {cb.total_tokens}&quot;)  \nasyncio.run(additional_interactions())","like_count":1},{"had_liked":false,"id":393848,"user_name":"yanyu-xin","can_delete":false,"product_type":"c1","uid":1899757,"ip_address":"å¹¿ä¸œ","ucode":"3AA389F9E4C236","user_header":"","comment_is_top":false,"comment_ctime":1725089529,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100617601,"comment_content":"å°†è¯¾ç¨‹ä»£ç åˆ°å¤§æ¨¡å‹ä¿®è®¢ä¸ºå›½äº§é€šä¹‰åƒé—®æ¨¡å‹ï¼š\n###1 ä¿®æ”¹â€œåœ¨ç»„ä»¶ä¸­ä½¿ç”¨å›è°ƒå¤„ç†å™¨â€ä»£ç ï¼Œç”¨ ChatOpenAIå’Œåƒé—®æ¨¡å‹å¹³æ›¿ OpenAI\n\n# åŸä»£ç 1\nllm = OpenAI()\n# æ–°ä»£ç 1\nfrom langchain_openai import ChatOpenAI\nllm = ChatOpenAI(\n        model_name=&quot;qwen-turbo&quot;, #ç”¨é€šä¹‰æ¨¡å‹\n        api_key=â€œAPI_KEYâ€, #å¡«å†™ä½ è‡ªå·±çš„DASHSCOPE_API_KEY\n        base_url=&quot;https:&#47;&#47;dashscope.aliyuncs.com&#47;compatible-mode&#47;v1&quot;\n\tï¼‰\nâ€”â€”â€”â€”\n\n###2 ä¿®æ”¹â€œè‡ªå®šä¹‰å›è°ƒå‡½æ•°â€ä»£ç ï¼Œå°†é€šä¹‰æ¨¡å‹å¹³æ›¿OpenAI\n# åŸä»£ç 2\nflower_shop_chat = ChatOpenAI(\n        max_tokens=100,\n        streaming=True,\n        callbacks=[MyFlowerShopSyncHandler(), MyFlowerShopAsyncHandler()],\n    )\n# æ–°ä»£ç 2\n    flower_shop_chat = ChatOpenAI(\n        model_name=&quot;qwen-turbo&quot;,  #ç”¨åƒé—®æ¨¡å‹\n        api_key=â€œAPI_KEYâ€, #å¡«å†™ä½ è‡ªå·±çš„DASHSCOPE_API_KEY\n        base_url=&quot;https:&#47;&#47;dashscope.aliyuncs.com&#47;compatible-mode&#47;v1&quot;, \n        max_tokens=100,\n        streaming=True,\n        callbacks=[MyFlowerShopSyncHandler(), MyFlowerShopAsyncHandler()],\n    )","like_count":1},{"had_liked":false,"id":392613,"user_name":"å¼ ç”³å‚²","can_delete":false,"product_type":"c1","uid":1182372,"ip_address":"åŒ—äº¬","ucode":"22D46BC529BA8A","user_header":"https://static001.geekbang.org/account/avatar/00/12/0a/a4/828a431f.jpg","comment_is_top":false,"comment_ctime":1721302901,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":2,"score":2,"product_id":100617601,"comment_content":"ç¬¬17è®²æ‰“å¡~\nå¯ä»¥é€šè¿‡å›è°ƒæœºåˆ¶ï¼Œå°†LLMè¿è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„æ—¥å¿—å¼‚æ­¥å†™å…¥æ–‡ä»¶æˆ–æ—¥å¿—æœåŠ¡ï¼Œåç»­é€šè¿‡ELKç­‰æœºåˆ¶è¿›è¡Œæ—¥å¿—é‡‡é›†å’Œé“¾è·¯è¿½è¸ª","like_count":0}]}