{"id":186413,"title":"33 | MongoDB索引机制（一）","content":"<p><strong>亲爱的学员：</strong><br>\n你好，在回答学员问题的过程中，我发现大家对于第二章的事务处理, 特别是隔离级别，以及第三章的分片集群有相对较多的问题。在这里我给大家推荐一些补充的学习材料可以从另外一个角度来加深一些这些概念的理解。<br>\nMongoDB事务的原子性<br>\n<a href=\"https://docs.mongodb.com/manual/core/write-operations-atomicity/\">https://docs.mongodb.com/manual/core/write-operations-atomicity/</a><br>\nMongoDB事务的隔离级别和一致性模型<br>\n<a href=\"https://docs.mongodb.com/manual/core/read-isolation-consistency-recency/\">https://docs.mongodb.com/manual/core/read-isolation-consistency-recency/</a><br>\n如果英文不太感冒，在MongoDB中文网站上有不少内容，比如分片相关的：<br>\n<a href=\"http://www.mongoing.com/?s=%E5%88%86%E7%89%87%E9%9B%86%E7%BE%A4\">http://www.mongoing.com/?s=分片集群</a></p><p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/geektime-mongodb-course\">https://gitee.com/geektime-geekbang/geektime-mongodb-course</a></p>","comments":[{"had_liked":false,"id":226858,"user_name":"征里","can_delete":false,"product_type":"c3","uid":1157016,"ip_address":"","ucode":"A840E4E38FC16C","user_header":"https://static001.geekbang.org/account/avatar/00/11/a7/98/d3ddcb4a.jpg","comment_is_top":false,"comment_ctime":1592218558,"is_pvip":false,"replies":[{"id":88178,"content":"B-树里面的那个  - 不是“减”，这个就是说 B树的意思。B+树是B树的一个子集，所以也是B树","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1596280269,"ip_address":"","comment_id":226858,"utype":1}],"discussion_count":4,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"看晕了 到底是不是B-树\n在MongoDB的官方文档上看到，索引实现确实是使用的B-树：MongoDB indexes use a B-tree data structure.\n版本4.2\nhttps:&#47;&#47;docs.mongodb.com&#47;manual&#47;indexes&#47;#id2","like_count":10,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":498392,"discussion_content":"B-树里面的那个  - 不是“减”，这个就是说 B树的意思。B+树是B树的一个子集，所以也是B树","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596280269,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1005549,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/57/ed/d50de13c.jpg","nickname":"mj4ever","note":"","ucode":"73028E537099CC","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":540599,"discussion_content":"看图，是B树，如果是B+树的话，叶子结点是需要出现根结点的，B+树的叶子结点是个链表，这样的设计是为了进行范围查询时，不需要进行中序查找，所以，范围查询B+树性能更好","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640091686,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2653715,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKib3vNM6TPT1umvR3TictnLurJPKuQq4iblH5upgBB3kHL9hoN3Pgh3MaR2rjz6fWgMiaDpicd8R5wsAQ/132","nickname":"陈阳","note":"","ucode":"C8E676C967D23A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":413702,"discussion_content":"(1) B+树改进了B树, 让内结点只作索引使用, 去掉了其中指向data record的指针, 使得每个结点中能够存放更多的key, 因此能有更大的出度. 这有什么用? 这样就意味着存放同样多的key, 树的层高能进一步被压缩, 使得检索的时间更短. \n(2)当然了,由于底部的叶子结点是链表形式, 因此也可以实现更方便的顺序遍历, 但是这是比较次要的, 最主要的的还是第(1)点.\n\n","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1636546074,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1866677,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eq6pWvKsV4rzQ62z5MDEjaEU5MbDfmzbA62kUgoqia2tgKIIxw4ibkDhF7W48iat5dT8UB9Adky2NuzQ/132","nickname":"小仙","note":"","ucode":"9F94043DFCEC3A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":350646,"discussion_content":"B 表示的是 balance 平衡，B-Tree 表示绝对平衡树","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1613964711,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":173745,"user_name":"奔奔奔跑","can_delete":false,"product_type":"c3","uid":1210265,"ip_address":"","ucode":"F86EC205DCAACE","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Gswh7ibY4tubXhp0BXOmV2pXZ3XsXic1d942ZMAEgWrRSF99bDskOTsG1g172ibORXxSCWTn9HWUX5vSSUVWU5I4A/132","comment_is_top":false,"comment_ctime":1579676455,"is_pvip":false,"replies":[{"id":67334,"content":"最后一个不是计数器，是随机数\n\n纠正上面的内容，ObjectID的格式有所修改：\n\nObjectID有12个bytes，分别为：\n\n- 4个字节的timestamp（精确到秒）\n- 5个字节的随机数\n- 3个字节的计数器\n\nMongoDB并未在文档中提到保证这个_id的顺序性。不过实际上如果在同一个客户端进程，应该是有这种顺序性的。\n你把你的流程贴出来看一下\n\n\n\n\n\n","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1579681457,"ip_address":"","comment_id":173745,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"用电脑看视频入迷了，哈哈，都忘了还有留言栏可以与老师交流了。\n老师，我有个问题要请教，按理来说mongodb的objectID是时间戳+机器码+PID+计数器构成的，按理来说我用(sort:_id)进行排序，新插入的数据排序出来应该在最后才对，但是为何我有几次看到新插入的数据排序在旧数据之前。请问这是为什么？如果没有问题的话，那是不是就意味着不能用objectID作为时间排序的索引了？希望老师能够解答，谢谢唐老师了！","like_count":4,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":482192,"discussion_content":"最后一个不是计数器，是随机数\n\n纠正上面的内容，ObjectID的格式有所修改：\n\nObjectID有12个bytes，分别为：\n\n- 4个字节的timestamp（精确到秒）\n- 5个字节的随机数\n- 3个字节的计数器\n\nMongoDB并未在文档中提到保证这个_id的顺序性。不过实际上如果在同一个客户端进程，应该是有这种顺序性的。\n你把你的流程贴出来看一下\n\n\n\n\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579681457,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":226908,"user_name":"fedwing","can_delete":false,"product_type":"c3","uid":1743661,"ip_address":"","ucode":"2DFF902FD190C7","user_header":"https://static001.geekbang.org/account/avatar/00/1a/9b/2d/f7fca208.jpg","comment_is_top":false,"comment_ctime":1592227561,"is_pvip":false,"replies":[{"id":88222,"content":"MongoDB是B树索引\nMongoDB是B+树索引\n\n上面两句话都是对的。因为B+树是B树的子集","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1596353624,"ip_address":"","comment_id":226908,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师，为什么我查了很多资料，说mysql是用B+树，mongo是用B树存储索引的，我看了下源码，好像也是Btree，求验证","like_count":2,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":498410,"discussion_content":"MongoDB是B树索引\nMongoDB是B+树索引\n\n上面两句话都是对的。因为B+树是B树的子集","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596353624,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1135477,"avatar":"https://static001.geekbang.org/account/avatar/00/11/53/75/fe495607.jpg","nickname":"执笔不回首","note":"","ucode":"A390CCE8A6B68F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":300070,"discussion_content":"兄弟，你后来搞清楚了吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597928290,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":180199,"user_name":"hal","can_delete":false,"product_type":"c3","uid":1359844,"ip_address":"","ucode":"98E625F7327FD9","user_header":"https://static001.geekbang.org/account/avatar/00/14/bf/e4/45758517.jpg","comment_is_top":false,"comment_ctime":1582208553,"is_pvip":false,"replies":[{"id":70068,"content":"视频是错的 - 我们正在试图修复。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1582341171,"ip_address":"","comment_id":180199,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师好，看完评论有个疑惑，为什么视频中讲MongoDB的索引是B-树，但是评论区中看到老师的回复，说MongoDB的索引是B+树？","like_count":2,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":484561,"discussion_content":"视频是错的 - 我们正在试图修复。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582341171,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1010571,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/6b/8b/ccdb819a.jpg","nickname":"W","note":"","ucode":"62AE242DD703B7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":235278,"discussion_content":"老师，官方文档上说MongoDB索引就是 B-Tree 实现的啊，怎么又是B+树了呢？https://docs.mongodb.com/manual/indexes/#b-tree","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1587033455,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":173408,"user_name":"qbit","can_delete":false,"product_type":"c3","uid":1262927,"ip_address":"","ucode":"96C70A1E47B93D","user_header":"https://static001.geekbang.org/account/avatar/00/13/45/4f/f94caf47.jpg","comment_is_top":false,"comment_ctime":1579527866,"is_pvip":false,"replies":[{"id":67810,"content":"可以参考 $currentDate\n\nhttps:&#47;&#47;docs.mongodb.com&#47;manual&#47;reference&#47;operator&#47;update&#47;currentDate&#47;\n\n","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1580255272,"ip_address":"","comment_id":173408,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"请问 mongoDB 可以定义类似 MySQL 的 create_time 和 update_time 字段吗？","like_count":1,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":482061,"discussion_content":"可以参考 $currentDate\n\nhttps://docs.mongodb.com/manual/reference/operator/update/currentDate/\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580255272,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":287232,"user_name":"大懒虫","can_delete":false,"product_type":"c3","uid":1440873,"ip_address":"","ucode":"51014C4A7074DA","user_header":"https://static001.geekbang.org/account/avatar/00/15/fc/69/02953435.jpg","comment_is_top":false,"comment_ctime":1617849548,"is_pvip":false,"replies":[{"id":104301,"content":"你好，是的，你说的是对的。老师也在本节课的第一条留言中解答了这个问题。","user_name":"编辑回复","user_name_real":"龚仕伟","uid":1615887,"ctime":1617875717,"ip_address":"","comment_id":287232,"utype":2}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"实际上B-树，是翻译过来的时候，中间的-没有取消，B-树和B树是一个意思，没有B减树","like_count":0,"discussions":[{"author":{"id":1615887,"avatar":"https://static001.geekbang.org/account/avatar/00/18/a8/0f/e1f7a51a.jpg","nickname":"知行合一","note":"","ucode":"8D0AE75B6BB836","race_medal":0,"user_type":4,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":518240,"discussion_content":"你好，是的，你说的是对的。老师也在本节课的第一条留言中解答了这个问题。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617875717,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":4}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":242533,"user_name":"执笔不回首","can_delete":false,"product_type":"c3","uid":1135477,"ip_address":"","ucode":"A390CCE8A6B68F","user_header":"https://static001.geekbang.org/account/avatar/00/11/53/75/fe495607.jpg","comment_is_top":false,"comment_ctime":1597752468,"is_pvip":false,"replies":[{"id":89748,"content":"可以看下评论区","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1598223398,"ip_address":"","comment_id":242533,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师我看的官方文档MongoDB索引使用B树数据结构，为什么评论里说是B+树。网上看了很多文章关于“为什么mongoDB使用B树，而mysql使用B+树”的文章。现在有点懵逼","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":504031,"discussion_content":"可以看下评论区","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598223398,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":237483,"user_name":"EricJones","can_delete":false,"product_type":"c3","uid":1207580,"ip_address":"","ucode":"0A80B609400D6B","user_header":"https://static001.geekbang.org/account/avatar/00/12/6d/1c/d9746372.jpg","comment_is_top":false,"comment_ctime":1595843399,"is_pvip":false,"replies":[{"id":88158,"content":"“我对字段 A 与字段 B 都创建了索引，并创建了复合索引”\n\n如果你创建了 A,B 复合索引，那么 A 上的单独索引就是多余的了。\n\n“用 A、B 字段当做条件去 count 就很慢很慢。这个怎么破？”\n你可以用 .explain(true) 方法看下它是否用了正确的索引。\n","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1596276981,"ip_address":"","comment_id":237483,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"可以谈论下 count 吗？我对字段 A 与字段 B 都创建了索引，并创建了复合索引。当时使用 find 查询时速度很快。当我分别按 A&#47;B 字段条件去 count 时速度也很快。但是当我同时使用 A、B 字段当做条件去 count 就很慢很慢。这个怎么破？","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":502433,"discussion_content":"“我对字段 A 与字段 B 都创建了索引，并创建了复合索引”\n\n如果你创建了 A,B 复合索引，那么 A 上的单独索引就是多余的了。\n\n“用 A、B 字段当做条件去 count 就很慢很慢。这个怎么破？”\n你可以用 .explain(true) 方法看下它是否用了正确的索引。\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596276981,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":227372,"user_name":"科研民工","can_delete":false,"product_type":"c3","uid":1264848,"ip_address":"","ucode":"8D51B8364C8F69","user_header":"https://static001.geekbang.org/account/avatar/00/13/4c/d0/824de931.jpg","comment_is_top":false,"comment_ctime":1592365107,"is_pvip":false,"replies":[{"id":88177,"content":"MongoDB不支持数字类型的全文检索和正则搜索。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1596280195,"ip_address":"","comment_id":227372,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师问下，mongo怎么对int类型数据模糊搜索，我用正则和全文搜索都不行","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":498609,"discussion_content":"MongoDB不支持数字类型的全文检索和正则搜索。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596280195,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":224021,"user_name":"田翌辰","can_delete":false,"product_type":"c3","uid":1430069,"ip_address":"","ucode":"4AF661C4C61C68","user_header":"https://static001.geekbang.org/account/avatar/00/15/d2/35/b25875e4.jpg","comment_is_top":false,"comment_ctime":1591257427,"is_pvip":false,"replies":[{"id":82546,"content":"1） 是的\n2） 会使用索引，等于是对$in数组内的每一个元素，使用索引，找到equal的索引项。\n3）比如从 range的lower bound 开始往上找，首先在B树里面找到lower bound的那个节点，然后就是B树遍历的流程了，直到upperbound 为止。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1591322787,"ip_address":"","comment_id":224021,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"有三个问题呢，1. 想确认一下，mongo的索引是B树对吧？  2. 如果我建立了组合索引a ， b，c，这时我a使用$in 去查询的话，是否会命中索引呢？$in的查询等同于equal，还是range呢？ 3. 如果我对一个时间的字段（比如create_time）创建了索引，您能大概和我说一下，他是怎么通过索引找到一个符合range条件的文档的嘛？ （一个一个找？）","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":497340,"discussion_content":"1） 是的\n2） 会使用索引，等于是对$in数组内的每一个元素，使用索引，找到equal的索引项。\n3）比如从 range的lower bound 开始往上找，首先在B树里面找到lower bound的那个节点，然后就是B树遍历的流程了，直到upperbound 为止。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591322787,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":207242,"user_name":"W","can_delete":false,"product_type":"c3","uid":1010571,"ip_address":"","ucode":"62AE242DD703B7","user_header":"https://static001.geekbang.org/account/avatar/00/0f/6b/8b/ccdb819a.jpg","comment_is_top":false,"comment_ctime":1587033012,"is_pvip":false,"replies":[{"id":77484,"content":"是的。\n\nB+ 树 是B树的一种（注意不是B减树，是B树，我也中过招）的一种。所以说Mongo用B树索引严格来说没有什么毛病。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1587096456,"ip_address":"","comment_id":207242,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"老师 MongoDB的索引是B+树吗？为什么网上好多资料都说是B-树，请问官方哪里有解释呢？谢谢","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492055,"discussion_content":"是的。\n\nB+ 树 是B树的一种（注意不是B减树，是B树，我也中过招）的一种。所以说Mongo用B树索引严格来说没有什么毛病。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587096456,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":201277,"user_name":"氵小明","can_delete":false,"product_type":"c3","uid":1307924,"ip_address":"","ucode":"8F748C10A4A37E","user_header":"https://static001.geekbang.org/account/avatar/00/13/f5/14/ea9fa7b1.jpg","comment_is_top":false,"comment_ctime":1585744294,"is_pvip":false,"replies":[{"id":75806,"content":"是的。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1586081051,"ip_address":"","comment_id":201277,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"老师想问下，我们mongo的索引跟mysql一样也是遵循最左前缀原则吗？","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":490289,"discussion_content":"是的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586081051,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":184220,"user_name":"Allen_","can_delete":false,"product_type":"c3","uid":1677187,"ip_address":"","ucode":"CA5E00E4644CD5","user_header":"https://static001.geekbang.org/account/avatar/00/19/97/83/845b48e2.jpg","comment_is_top":false,"comment_ctime":1583248918,"is_pvip":false,"replies":[{"id":72155,"content":"对计算机来说，数字和字符串没什么差别。字符串也是0101表示的。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1584004268,"ip_address":"","comment_id":184220,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"老师，我是从理论课解除到B数的，对于纯数字的操作比较清晰。但是我们实战中把lastname这种作为index，这种非数字的该怎么查找呢？\n换句话说，数字可以保证我的数大于此index就肯定在右边找，但是这些非数字的怎么保证呢？","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":485932,"discussion_content":"对计算机来说，数字和字符串没什么差别。字符串也是0101表示的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584004268,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":175453,"user_name":"注意力$","can_delete":false,"product_type":"c3","uid":1142316,"ip_address":"","ucode":"7FB3399A1EAB72","user_header":"https://static001.geekbang.org/account/avatar/00/11/6e/2c/e2f3cfc0.jpg","comment_is_top":false,"comment_ctime":1580723458,"is_pvip":false,"replies":[{"id":68553,"content":"不能。必须删除整个集合才会回收","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1581090653,"ip_address":"","comment_id":175453,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"唐老师，MongoDB 磁盘目录清理的话，是直接删除集合吗？删除集合部分数据，可以释放空间吗？谢谢","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":482738,"discussion_content":"不能。必须删除整个集合才会回收","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581090653,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":174232,"user_name":"月迷津渡","can_delete":false,"product_type":"c3","uid":1264111,"ip_address":"","ucode":"2B18B2FE3DAC3B","user_header":"https://static001.geekbang.org/account/avatar/00/13/49/ef/02401473.jpg","comment_is_top":false,"comment_ctime":1580101585,"is_pvip":false,"replies":[{"id":67799,"content":"mongodb用的就是B+树，如你所述在叶子节点层遍历。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1580253205,"ip_address":"","comment_id":174232,"utype":1}],"discussion_count":3,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"请问下老师 一般范围查询比如年龄4-18的查询 B+树是用叶子节点的链表遍历，那mongodb怎么做的呢？是用B树做类似于2茶树的中序遍历么？","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":482341,"discussion_content":"mongodb用的就是B+树，如你所述在叶子节点层遍历。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580253205,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1135477,"avatar":"https://static001.geekbang.org/account/avatar/00/11/53/75/fe495607.jpg","nickname":"执笔不回首","note":"","ucode":"A390CCE8A6B68F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":299612,"discussion_content":"我也好困惑，老师的评论说是B+树\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597750452,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1359844,"avatar":"https://static001.geekbang.org/account/avatar/00/14/bf/e4/45758517.jpg","nickname":"hal","note":"","ucode":"98E625F7327FD9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":176362,"discussion_content":"emm有点疑惑，为什么老师在评论里MongoDB索引用的是B+树，视频中说的是B-树？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582034239,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":173770,"user_name":"奔奔奔跑","can_delete":false,"product_type":"c3","uid":1210265,"ip_address":"","ucode":"F86EC205DCAACE","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Gswh7ibY4tubXhp0BXOmV2pXZ3XsXic1d942ZMAEgWrRSF99bDskOTsG1g172ibORXxSCWTn9HWUX5vSSUVWU5I4A/132","comment_is_top":false,"comment_ctime":1579681809,"is_pvip":false,"replies":[{"id":67805,"content":"已修改原回复内容。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1580254738,"ip_address":"","comment_id":173770,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"感谢老师的回复，假期了还这么负责太感动了。但是我还是觉得有疑惑，MongoDB应该可以用objectID来排序吧，虽然最后的是随机数，但是时间戳在前面，新插入数据肯定比旧数据要大吧","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":482202,"discussion_content":"已修改原回复内容。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580254738,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":268214,"user_name":"端碗吹水","can_delete":false,"product_type":"c3","uid":1513890,"ip_address":"","ucode":"D4D0126969650A","user_header":"https://static001.geekbang.org/account/avatar/00/17/19/a2/f70dae3a.jpg","comment_is_top":false,"comment_ctime":1608102644,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"关于MongoDB到底是用的B树还是B+树的疑问，WiredTiger的文档中有答案。MongoDB 3.2后默认使用WiredTiger作为存储引擎，WiredTiger支持B+树和LSM作为索引的数据结构。\n\n官方文档：https:&#47;&#47;source.wiredtiger.com&#47;3.0.0&#47;tune_page_size_and_comp.html。提到了：\nWiredTiger maintains a table&#39;s data in memory using a data structure called a B-Tree ( B+ Tree to be specific), referring to the nodes of a B-Tree as pages. Internal pages carry only keys. The leaf pages store both keys and values.\n\nWiredTiger使用一种称为B树（具体地说是B+树）的数据结构在内存中维护表的数据，将B树的节点称为pages。pages只携带索引键。叶子节点存储键和值。","like_count":7},{"had_liked":false,"id":252145,"user_name":"Geek_be5c57","can_delete":false,"product_type":"c3","uid":1636059,"ip_address":"","ucode":"B086B6B019C148","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/P5XJib9wlWdMrs7Z6XWGic42mxUMSsB08Sluiat17w1AoVxYrtDI9X7zCfARtFwjGiaM0kIMYAkPpqia0ZhAh8GVCNg/132","comment_is_top":false,"comment_ctime":1602143522,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"老师的课件中，给的是原生 BTree 的结构（非叶子节点也有 data 指针），感觉为了避免歧义，可以考虑换成 B+Tree 的图。\n感觉网上对 MongoDB 的索引结构已经产生了误解，搜一下“MongoDB b树”就有一堆。","like_count":4},{"had_liked":false,"id":321970,"user_name":"Jesson","can_delete":false,"product_type":"c3","uid":1212313,"ip_address":"","ucode":"EBADA87D9E5AE6","user_header":"https://static001.geekbang.org/account/avatar/00/12/7f/99/6a92ff95.jpg","comment_is_top":false,"comment_ctime":1637120141,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"老师，能出一章关于  explain返回结果分 析吗？","like_count":3},{"had_liked":false,"id":316334,"user_name":"No ver","can_delete":false,"product_type":"c3","uid":1106465,"ip_address":"","ucode":"BD5FA90AAF07D8","user_header":"https://static001.geekbang.org/account/avatar/00/10/e2/21/840410d8.jpg","comment_is_top":false,"comment_ctime":1634274417,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"老师，有两个问题请教一下。\n1.mongodb的数据在物理存储上是和索引数据在一起的吗？还是单独文件存储数据？\n2.非主键索引查询时，是直接指向了实际数据位置还是存储主键索引的值。","like_count":1},{"had_liked":false,"id":304231,"user_name":"空指针","can_delete":false,"product_type":"c3","uid":1176683,"ip_address":"","ucode":"8E50F8D8E2A868","user_header":"https://static001.geekbang.org/account/avatar/00/11/f4/6b/84463877.jpg","comment_is_top":false,"comment_ctime":1627299838,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100040001,"comment_content":"你好，我有张表2000万条数据，其中有个字段status 值为1或者0，其中为1 的有900万+， 该字段已经创建索引，但是每次统计status = 1的的总数，非常慢，需要3-5秒，这个正常么？ 能否优化？","like_count":1},{"had_liked":false,"id":183406,"user_name":"Cary","can_delete":false,"product_type":"c3","uid":1066991,"ip_address":"","ucode":"1B85272C1E03CF","user_header":"https://static001.geekbang.org/account/avatar/00/10/47/ef/3c657df8.jpg","comment_is_top":false,"comment_ctime":1583034596,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100040001,"comment_content":"单个文档大小35KB，共有500w记录，容器内存7GB，创建索引内存不够，导致容器关闭，老师，请问如何处理？","like_count":1},{"had_liked":false,"id":242807,"user_name":"执笔不回首","can_delete":false,"product_type":"c3","uid":1135477,"ip_address":"","ucode":"A390CCE8A6B68F","user_header":"https://static001.geekbang.org/account/avatar/00/11/53/75/fe495607.jpg","comment_is_top":false,"comment_ctime":1597846594,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100040001,"comment_content":"对于WiredTiger存储引擎来说，集合所在的数据文件和相应的索引文件都是按B-Tree结构来组织的，不同之处在于数据文件对应的B-Tree叶子结点上除了存储键名外（keys），还会存储真正的集合数据（values），所以数据文件的存储结构也可以认为是一种B+Tree","like_count":0},{"had_liked":false,"id":225475,"user_name":"龙晓","can_delete":false,"product_type":"c3","uid":1043325,"ip_address":"","ucode":"FAF34F1C65D103","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/c9xpiakQ3OC1AlfCeW03lLnnb7mj5v35Hib8YDs66zpnVib2n2qFichFmFp2Ec4QDPR0dKh38MkBBLyD3bE4NiaanZQ/132","comment_is_top":false,"comment_ctime":1591761863,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100040001,"comment_content":"mongo的B树索引什么情况下分裂重组？分支节点的key数是什么决定的","like_count":0}]}