{"id":119494,"title":"07 | ZooKeeper架构解析","content":"<p><strong>课件和Demo地址</strong></p><p><a href=\"https://gitee.com/geektime-geekbang/geekbang-zk-course\">https://gitee.com/geektime-geekbang/geekbang-zk-course</a></p>","comments":[{"had_liked":false,"id":134626,"user_name":"lizhaochao","can_delete":false,"product_type":"c3","uid":1170705,"ip_address":"","ucode":"1357C60BB567B7","user_header":"https://static001.geekbang.org/account/avatar/00/11/dd/11/04ebee55.jpg","comment_is_top":false,"comment_ctime":1568881772,"is_pvip":false,"replies":[{"id":52038,"content":"不是的。这3个配置是集群中所有的节点（一个机器上装一个ZooKeeper节点）。例如下面的配置表示集群中的3个节点配置：\n\nserver.1=ali-1:2222:2223\nserver.2=ali-2:2222:2223\nserver.3=ali-3:2222:2223\n\nmyid文件保存节点的id。例如，如果myid的内容为2，就代表这个机器上的节点是server.2=ali-2:2222:2223。\n","user_name":"作者回复","user_name_real":"Geek_215586","uid":1591870,"ctime":1569248746,"ip_address":"","comment_id":134626,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100034201,"comment_content":"每个znode的配置文件下 都有3个server的配置 这些server如何理解 是主机吗 znode和主机是1:N的关系吗 ","like_count":3,"discussions":[{"author":{"id":1591870,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJyDiaaDJrwRsdUia9HxA8EuWaDVLr4E1gMG5y2ZTxV7BNUhdNABCmH3GMZTzib796X5duibiaeuRmNXeg/132","nickname":"Geek_215586","note":"","ucode":"5916AC9CC5FBE2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":467835,"discussion_content":"不是的。这3个配置是集群中所有的节点（一个机器上装一个ZooKeeper节点）。例如下面的配置表示集群中的3个节点配置：\n\nserver.1=ali-1:2222:2223\nserver.2=ali-2:2222:2223\nserver.3=ali-3:2222:2223\n\nmyid文件保存节点的id。例如，如果myid的内容为2，就代表这个机器上的节点是server.2=ali-2:2222:2223。\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1569248746,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1068432,"avatar":"https://static001.geekbang.org/account/avatar/00/10/4d/90/25b6f544.jpg","nickname":"马文龙","note":"","ucode":"679B0F0AB402C7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":370838,"discussion_content":"手工创建","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619543594,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1111985,"avatar":"https://static001.geekbang.org/account/avatar/00/10/f7/b1/982ea185.jpg","nickname":"美妙的代码","note":"","ucode":"9DADD72C193296","race_medal":1,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":315072,"discussion_content":"myid 文件是自动创建的，还是需要手动创建啊？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603240908,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":213451,"user_name":"妥协","can_delete":false,"product_type":"c3","uid":1249656,"ip_address":"","ucode":"7201DFE9C12669","user_header":"https://static001.geekbang.org/account/avatar/00/13/11/78/4f0cd172.jpg","comment_is_top":false,"comment_ctime":1588417226,"is_pvip":false,"replies":[{"id":79212,"content":"不会。一个新ZooKeeper节点只有比客户端以前连接的节点的状态新，也就是说新节点的zxid不比旧节点的zxid小，才可以处理来自客户端的请求。","user_name":"作者回复","user_name_real":"Geek_215586","uid":1591870,"ctime":1588558547,"ip_address":"","comment_id":213451,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100034201,"comment_content":"如果客户端从zookeeper读取数据，连接的节点发生切换后，会读到比之前读老的数据吗？zookeeper是如果保证单调一致性的?","like_count":1,"discussions":[{"author":{"id":1591870,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJyDiaaDJrwRsdUia9HxA8EuWaDVLr4E1gMG5y2ZTxV7BNUhdNABCmH3GMZTzib796X5duibiaeuRmNXeg/132","nickname":"Geek_215586","note":"","ucode":"5916AC9CC5FBE2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493785,"discussion_content":"不会。一个新ZooKeeper节点只有比客户端以前连接的节点的状态新，也就是说新节点的zxid不比旧节点的zxid小，才可以处理来自客户端的请求。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588558547,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1249656,"avatar":"https://static001.geekbang.org/account/avatar/00/13/11/78/4f0cd172.jpg","nickname":"妥协","note":"","ucode":"7201DFE9C12669","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":262537,"discussion_content":"另一个问题，由于过半写机制，客户端可能读不到最新写入的值，这样的话，zookeeper也就不是强一致的了呀","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589110742,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":208012,"user_name":"而立斋","can_delete":false,"product_type":"c3","uid":1087258,"ip_address":"","ucode":"5FED6E9E148195","user_header":"https://static001.geekbang.org/account/avatar/00/10/97/1a/389eab84.jpg","comment_is_top":false,"comment_ctime":1587255837,"is_pvip":false,"replies":[{"id":79206,"content":"&gt; myid可以自动生成吗？\n不可以。理论上是可以自动生成的，但是ZooKeeper没有提供这个选项。例如Kafka节点的broker.id就是可以自动生成的。\n\n&gt; zk自己不就可以做配置中心吗？\n是的。\n","user_name":"作者回复","user_name_real":"Geek_215586","uid":1591870,"ctime":1588557435,"ip_address":"","comment_id":208012,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100034201,"comment_content":"myid可以自动生成吗？为啥都要自己去配置。不可以默认。zk自己不就可以做配置中心吗？","like_count":0,"discussions":[{"author":{"id":1591870,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJyDiaaDJrwRsdUia9HxA8EuWaDVLr4E1gMG5y2ZTxV7BNUhdNABCmH3GMZTzib796X5duibiaeuRmNXeg/132","nickname":"Geek_215586","note":"","ucode":"5916AC9CC5FBE2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492316,"discussion_content":"&amp;gt; myid可以自动生成吗？\n不可以。理论上是可以自动生成的，但是ZooKeeper没有提供这个选项。例如Kafka节点的broker.id就是可以自动生成的。\n\n&amp;gt; zk自己不就可以做配置中心吗？\n是的。\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588557435,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":178465,"user_name":"bbbi","can_delete":false,"product_type":"c3","uid":1682175,"ip_address":"","ucode":"9A539AEF791428","user_header":"https://static001.geekbang.org/account/avatar/00/19/aa/ff/e2c331e0.jpg","comment_is_top":false,"comment_ctime":1581694425,"is_pvip":false,"replies":[{"id":75911,"content":"这个ID用的是zookeeper.jute里面的cversion：\n    class Stat {\n        long czxid;      &#47;&#47; created zxid\n        long mzxid;      &#47;&#47; last modified zxid\n        long ctime;      &#47;&#47; created\n        long mtime;      &#47;&#47; last modified\n        int version;     &#47;&#47; version\n        int cversion;    &#47;&#47; child version\n        int aversion;    &#47;&#47; acl version\n        long ephemeralOwner; &#47;&#47; owner id if ephemeral, 0 otw\n        int dataLength;  &#47;&#47;length of the data in the node\n        int numChildren; &#47;&#47;number of children of this node\n        long pzxid;      &#47;&#47; last modified children\n    }\nID从0开始一直递增到2147483647，到-2147483648，到-1, 最后回到0。做递增操作的是PrepRequestProcessor.java的以下代码：\n\tint newCversion = parentRecord.stat.getCversion()+1;","user_name":"作者回复","user_name_real":"Geek_215586","uid":1591870,"ctime":1586142965,"ip_address":"","comment_id":178465,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100034201,"comment_content":"老师您好！有一个问题，就是节点的自增ID最大时多少? 如果自增ID用完了会有什么后果吗？","like_count":0,"discussions":[{"author":{"id":1591870,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJyDiaaDJrwRsdUia9HxA8EuWaDVLr4E1gMG5y2ZTxV7BNUhdNABCmH3GMZTzib796X5duibiaeuRmNXeg/132","nickname":"Geek_215586","note":"","ucode":"5916AC9CC5FBE2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":483835,"discussion_content":"这个ID用的是zookeeper.jute里面的cversion：\n    class Stat {\n        long czxid;      // created zxid\n        long mzxid;      // last modified zxid\n        long ctime;      // created\n        long mtime;      // last modified\n        int version;     // version\n        int cversion;    // child version\n        int aversion;    // acl version\n        long ephemeralOwner; // owner id if ephemeral, 0 otw\n        int dataLength;  //length of the data in the node\n        int numChildren; //number of children of this node\n        long pzxid;      // last modified children\n    }\nID从0开始一直递增到2147483647，到-2147483648，到-1, 最后回到0。做递增操作的是PrepRequestProcessor.java的以下代码：\n\tint newCversion = parentRecord.stat.getCversion()+1;","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586142965,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2760246,"avatar":"","nickname":"Geek_74dea9","note":"","ucode":"14092EEBC08171","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":543514,"discussion_content":"那会到顶吗， 到最大后怎么办呢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641190350,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":131783,"user_name":"ican_只会0到9","can_delete":false,"product_type":"c3","uid":1029473,"ip_address":"","ucode":"9EE33C42EE519D","user_header":"https://static001.geekbang.org/account/avatar/00/0f/b5/61/9802a552.jpg","comment_is_top":false,"comment_ctime":1567906292,"is_pvip":false,"replies":[{"id":50629,"content":"是的。假设connectString中有三个节点的访问信息。每次客户端建立连接都是随机选取一个节点。这样可以起到负责均衡的作用。","user_name":"作者回复","user_name_real":"Geek_215586","uid":1591870,"ctime":1568105735,"ip_address":"","comment_id":131783,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100034201,"comment_content":"ClientA:\n 08:49:13,323 [myid:127.0.0.1:2182] - INFO  [main-SendThread(127.0.0.1:2182):Cli] - Session establishment complete on server localhost&#47;127.0.0.1:2182, sessionid = 0x30000timeout = 30000\nClient B:\n 09:23:29,494 [myid:127.0.0.1:2183] - INFO  [main-SendThread(127.0.0.1:2183):ClientCnxn$SendThread@1394] - Session establishment complete on server localhost&#47;127.0.0.1:2183, sessionid = 0x300001aeecf0000, negotiated timeout = 30000\n\n每次客户端连接的都不一样，这个是随机的吗？不是都主动连接到leader？\n\n","like_count":0,"discussions":[{"author":{"id":1591870,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJyDiaaDJrwRsdUia9HxA8EuWaDVLr4E1gMG5y2ZTxV7BNUhdNABCmH3GMZTzib796X5duibiaeuRmNXeg/132","nickname":"Geek_215586","note":"","ucode":"5916AC9CC5FBE2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":466617,"discussion_content":"是的。假设connectString中有三个节点的访问信息。每次客户端建立连接都是随机选取一个节点。这样可以起到负责均衡的作用。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1568105735,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1020529,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/92/71/9fd7cd7a.jpg","nickname":"Daniel","note":"","ucode":"282E09B3146501","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":114344,"discussion_content":"老师想打的是”负载均衡“ 哈哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577969346,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":131708,"user_name":"ican_只会0到9","can_delete":false,"product_type":"c3","uid":1029473,"ip_address":"","ucode":"9EE33C42EE519D","user_header":"https://static001.geekbang.org/account/avatar/00/0f/b5/61/9802a552.jpg","comment_is_top":false,"comment_ctime":1567858745,"is_pvip":false,"replies":[{"id":50528,"content":"是的。","user_name":"作者回复","user_name_real":"Geek_215586","uid":1591870,"ctime":1568044597,"ip_address":"","comment_id":131708,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100034201,"comment_content":"老师，ZK只有一个node时是standalone，集群是quorum模式，是这样子吗？","like_count":0,"discussions":[{"author":{"id":1591870,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJyDiaaDJrwRsdUia9HxA8EuWaDVLr4E1gMG5y2ZTxV7BNUhdNABCmH3GMZTzib796X5duibiaeuRmNXeg/132","nickname":"Geek_215586","note":"","ucode":"5916AC9CC5FBE2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":466585,"discussion_content":"是的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1568044597,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":126687,"user_name":"金子般的心","can_delete":false,"product_type":"c3","uid":1006897,"ip_address":"","ucode":"8F6F217AF0C0EA","user_header":"https://static001.geekbang.org/account/avatar/00/0f/5d/31/2ccc4675.jpg","comment_is_top":false,"comment_ctime":1566447739,"is_pvip":true,"replies":[{"id":46892,"content":"是的","user_name":"作者回复","user_name_real":"Geek_215586","uid":1591870,"ctime":1566486758,"ip_address":"","comment_id":126687,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100034201,"comment_content":"myid 文件需要放在每个节点的dataDir目录下","like_count":0,"discussions":[{"author":{"id":1591870,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJyDiaaDJrwRsdUia9HxA8EuWaDVLr4E1gMG5y2ZTxV7BNUhdNABCmH3GMZTzib796X5duibiaeuRmNXeg/132","nickname":"Geek_215586","note":"","ucode":"5916AC9CC5FBE2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":464121,"discussion_content":"是的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566486758,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":295683,"user_name":"Nick","can_delete":false,"product_type":"c3","uid":1131330,"ip_address":"","ucode":"C98B3E118C0539","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoiaa4r9Rpuwvwt9KPk6g61iaq1duee6q8L3InFWTWcHkJ9sVkQvic498N026DiaVP11U4kGSNxia3QehQ/132","comment_is_top":false,"comment_ctime":1622541942,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":2,"product_id":100034201,"comment_content":"需要新建myid文件\n&#47;data&#47;zk&#47;quorum&#47;node1&#47;myid内容为1\n&#47;data&#47;zk&#47;quorum&#47;node2&#47;myid内容为2\n&#47;data&#47;zk&#47;quorum&#47;node3&#47;myid内容为3","like_count":4,"discussions":[{"author":{"id":1140501,"avatar":"https://static001.geekbang.org/account/avatar/00/11/67/15/42eebd17.jpg","nickname":"xulong","note":"","ucode":"1AEA39BD3968A9","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":599211,"discussion_content":"这个千万不要把内容写错，或者不写。否则出现的问题，根本不知道如何解决","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1673405717,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":260232,"user_name":"蜥蜴1214","can_delete":false,"product_type":"c3","uid":1673879,"ip_address":"","ucode":"1CD2B3A41F3D01","user_header":"https://static001.geekbang.org/account/avatar/00/19/8a/97/7ab3a22c.jpg","comment_is_top":false,"comment_ctime":1604966659,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100034201,"comment_content":"老师，想问下。follower会把写请求转发给leader，那如果，客户端a连接的follower。而客户端b连接leader。会不会出现两个客户端几乎同时发写请求，客户端b稍晚一点，但是经过转发，反而认为a发出的请求在前面？","like_count":1},{"had_liked":false,"id":366102,"user_name":"xulong","can_delete":false,"product_type":"c3","uid":1140501,"ip_address":"广东","ucode":"1AEA39BD3968A9","user_header":"https://static001.geekbang.org/account/avatar/00/11/67/15/42eebd17.jpg","comment_is_top":false,"comment_ctime":1673403106,"is_pvip":true,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100034201,"comment_content":"org.apache.zookeeper.server.quorum.QuorumPeerConfig$ConfigException: Error processing &#47;home&#47;lighthouse&#47;tools&#47;apache-zookeeper-3.7.1-bin&#47;bin&#47;..&#47;conf&#47;zoo-quorum-node1.cfg\n\n一直找不到路径","like_count":0},{"had_liked":false,"id":329160,"user_name":"Geek_74dea9","can_delete":false,"product_type":"c3","uid":2760246,"ip_address":"","ucode":"14092EEBC08171","user_header":"","comment_is_top":false,"comment_ctime":1641190268,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100034201,"comment_content":"老师，想问下。follower会把写请求转发给leader，那如果，客户端a连接的follower。而客户端b连接leader。会不会出现两个客户端几乎同时发写请求，客户端b稍晚一点，但是经过转发，反而认为a发出的请求在前面？","like_count":0}]}