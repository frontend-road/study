{"id":422182,"title":"15ï½œæ•°æ®ç»“æ„ï¼šè¿™äº›æµ“çœ‰å¤§çœ¼çš„ç»“æ„ç«Ÿç„¶éƒ½æ˜¯æ™ºèƒ½æŒ‡é’ˆï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯é™ˆå¤©ã€‚</p><p>åˆ°ç°åœ¨ä¸ºæ­¢æˆ‘ä»¬å­¦äº†Rustçš„æ‰€æœ‰æƒä¸ç”Ÿå‘½å‘¨æœŸã€å†…å­˜ç®¡ç†ä»¥åŠç±»å‹ç³»ç»Ÿï¼ŒåŸºç¡€çŸ¥è¯†é‡Œè¿˜å‰©ä¸€å—ç‰ˆå›¾æ²¡æœ‰æ¶‰åŠï¼šæ•°æ®ç»“æ„ï¼Œæ•°æ®ç»“æ„é‡Œæœ€å®¹æ˜“è®©äººå›°æƒ‘çš„å°±æ˜¯æ™ºèƒ½æŒ‡é’ˆï¼Œæ‰€ä»¥ä»Šå¤©æˆ‘ä»¬å°±æ¥è§£å†³è¿™ä¸ªéš¾ç‚¹ã€‚</p><p>æˆ‘ä»¬ä¹‹å‰ç®€å•ä»‹ç»è¿‡æŒ‡é’ˆï¼Œè¿™é‡Œè¿˜æ˜¯å…ˆå›é¡¾ä¸€ä¸‹ï¼šæŒ‡é’ˆæ˜¯ä¸€ä¸ªæŒæœ‰å†…å­˜åœ°å€çš„å€¼ï¼Œå¯ä»¥é€šè¿‡è§£å¼•ç”¨æ¥è®¿é—®å®ƒæŒ‡å‘çš„å†…å­˜åœ°å€ï¼Œç†è®ºä¸Šå¯ä»¥è§£å¼•ç”¨åˆ°ä»»æ„æ•°æ®ç±»å‹ï¼›å¼•ç”¨æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æŒ‡é’ˆï¼Œå®ƒçš„è§£å¼•ç”¨è®¿é—®æ˜¯å—é™çš„ï¼Œåªèƒ½è§£å¼•ç”¨åˆ°å®ƒå¼•ç”¨æ•°æ®çš„ç±»å‹ï¼Œä¸èƒ½ç”¨ä½œå®ƒç”¨ã€‚</p><p>é‚£ä»€ä¹ˆæ˜¯æ™ºèƒ½æŒ‡é’ˆå‘¢ï¼Ÿ</p><h2>æ™ºèƒ½æŒ‡é’ˆ</h2><p>åœ¨æŒ‡é’ˆå’Œå¼•ç”¨çš„åŸºç¡€ä¸Šï¼ŒRust å·å¸ˆ C++ï¼Œæä¾›äº†æ™ºèƒ½æŒ‡é’ˆã€‚æ™ºèƒ½æŒ‡é’ˆæ˜¯ä¸€ä¸ªè¡¨ç°è¡Œä¸ºå¾ˆåƒæŒ‡é’ˆçš„æ•°æ®ç»“æ„ï¼Œä½†é™¤äº†æŒ‡å‘æ•°æ®çš„æŒ‡é’ˆå¤–ï¼Œå®ƒè¿˜æœ‰å…ƒæ•°æ®ä»¥æä¾›é¢å¤–çš„å¤„ç†èƒ½åŠ›ã€‚</p><p>è¿™ä¸ªå®šä¹‰æœ‰ç‚¹æ¨¡ç³Šï¼Œæˆ‘ä»¬å¯¹æ¯”å…¶ä»–çš„æ•°æ®ç»“æ„æ¥æ˜ç¡®ä¸€ä¸‹ã€‚</p><p>ä½ æœ‰æ²¡æœ‰è§‰å¾—å¾ˆåƒä¹‹å‰è®²çš„èƒ–æŒ‡é’ˆã€‚æ™ºèƒ½æŒ‡é’ˆä¸€å®šæ˜¯ä¸€ä¸ªèƒ–æŒ‡é’ˆï¼Œä½†èƒ–æŒ‡é’ˆä¸ä¸€å®šæ˜¯ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆã€‚æ¯”å¦‚ &amp;str å°±åªæ˜¯ä¸€ä¸ªèƒ–æŒ‡é’ˆï¼Œå®ƒæœ‰æŒ‡å‘å †å†…å­˜å­—ç¬¦ä¸²çš„æŒ‡é’ˆï¼ŒåŒæ—¶è¿˜æœ‰å…³äºå­—ç¬¦ä¸²é•¿åº¦çš„å…ƒæ•°æ®ã€‚</p><p>æˆ‘ä»¬çœ‹æ™ºèƒ½æŒ‡é’ˆ String å’Œ &amp;str çš„åŒºåˆ«ï¼š<img src=\"https://static001.geekbang.org/resource/image/f4/59/f4401040f7d36b9e610b6867a5d0cf59.jpg?wh=1913x1206\" alt=\"\"></p><p>ä»å›¾ä¸Šå¯ä»¥çœ‹åˆ°ï¼ŒString é™¤äº†å¤šä¸€ä¸ª capacity å­—æ®µï¼Œä¼¼ä¹ä¹Ÿæ²¡æœ‰ä»€ä¹ˆç‰¹æ®Šã€‚<strong>ä½† String å¯¹å †ä¸Šçš„å€¼æœ‰æ‰€æœ‰æƒï¼Œè€Œ &amp;str æ˜¯æ²¡æœ‰æ‰€æœ‰æƒçš„ï¼Œè¿™æ˜¯ Rust ä¸­æ™ºèƒ½æŒ‡é’ˆå’Œæ™®é€šèƒ–æŒ‡é’ˆçš„åŒºåˆ«</strong>ã€‚</p><!-- [[[read_end]]] --><p>é‚£ä¹ˆåˆæœ‰ä¸€ä¸ªé—®é¢˜äº†ï¼Œæ™ºèƒ½æŒ‡é’ˆå’Œç»“æ„ä½“æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬çŸ¥é“ï¼ŒString æ˜¯ç”¨ç»“æ„ä½“å®šä¹‰çš„ï¼š</p><pre><code class=\"language-rust\">pub struct String {\n    vec: Vec&lt;u8&gt;,\n}\n</code></pre><p>å’Œæ™®é€šçš„ç»“æ„ä½“ä¸åŒçš„æ˜¯ï¼ŒString å®ç°äº† Deref å’Œ DerefMutï¼Œè¿™ä½¿å¾—å®ƒåœ¨è§£å¼•ç”¨çš„æ—¶å€™ï¼Œä¼šå¾—åˆ° &amp;strï¼Œçœ‹ä¸‹é¢çš„<a href=\"https://doc.rust-lang.org/src/alloc/string.rs.html#2301-2316\">æ ‡å‡†åº“çš„å®ç°</a>ï¼š</p><pre><code class=\"language-rust\">impl ops::Deref for String {\n    type Target = str;\n\n    fn deref(&amp;self) -&gt; &amp;str {\n        unsafe { str::from_utf8_unchecked(&amp;self.vec) }\n    }\n}\n\nimpl ops::DerefMut for String {\n    fn deref_mut(&amp;mut self) -&gt; &amp;mut str {\n        unsafe { str::from_utf8_unchecked_mut(&amp;mut *self.vec) }\n    }\n}\n</code></pre><p>å¦å¤–ï¼Œç”±äºåœ¨å †ä¸Šåˆ†é…äº†æ•°æ®ï¼ŒString è¿˜éœ€è¦ä¸ºå…¶åˆ†é…çš„èµ„æºåšç›¸åº”çš„å›æ”¶ã€‚è€Œ String å†…éƒ¨ä½¿ç”¨äº† Vec&lt;u8&gt;ï¼Œæ‰€ä»¥å®ƒå¯ä»¥ä¾èµ– Vec&lt;T&gt; çš„èƒ½åŠ›æ¥é‡Šæ”¾å †å†…å­˜ã€‚ä¸‹é¢æ˜¯æ ‡å‡†åº“ä¸­ Vec&lt;T&gt; çš„ <a href=\"https://doc.rust-lang.org/src/alloc/vec/mod.rs.html#2710-2720\">Drop trait çš„å®ç°</a>ï¼š</p><pre><code class=\"language-rust\">unsafe impl&lt;#[may_dangle] T, A: Allocator&gt; Drop for Vec&lt;T, A&gt; {\n    fn drop(&amp;mut self) {\n        unsafe {\n            // use drop for [T]\n            // use a raw slice to refer to the elements of the vector as weakest necessary type;\n            // could avoid questions of validity in certain cases\n            ptr::drop_in_place(ptr::slice_from_raw_parts_mut(self.as_mut_ptr(), self.len))\n        }\n        // RawVec handles deallocation\n    }\n}\n</code></pre><p>æ‰€ä»¥å†æ¸…æ™°ä¸€ä¸‹å®šä¹‰ï¼Œ<strong>åœ¨ Rust ä¸­ï¼Œå‡¡æ˜¯éœ€è¦åšèµ„æºå›æ”¶çš„æ•°æ®ç»“æ„ï¼Œä¸”å®ç°äº† Deref/DerefMut/Dropï¼Œéƒ½æ˜¯æ™ºèƒ½æŒ‡é’ˆ</strong>ã€‚</p><p>æŒ‰ç…§è¿™ä¸ªå®šä¹‰ï¼Œé™¤äº† Stringï¼Œåœ¨ä¹‹å‰çš„è¯¾ç¨‹ä¸­æˆ‘ä»¬é‡åˆ°äº†å¾ˆå¤šæ™ºèƒ½æŒ‡é’ˆï¼Œæ¯”å¦‚ç”¨äºåœ¨å †ä¸Šåˆ†é…å†…å­˜çš„ Box&lt;T&gt; å’Œ Vec&lt;T&gt;ã€ç”¨äºå¼•ç”¨è®¡æ•°çš„ Rc&lt;T&gt; å’Œ Arc&lt;T&gt; ã€‚å¾ˆå¤šå…¶ä»–æ•°æ®ç»“æ„ï¼Œå¦‚ PathBufã€Cow&lt;'a, B&gt;ã€MutexGuard&lt;T&gt;ã€RwLockReadGuard&lt;T&gt; å’Œ RwLockWriteGuard ç­‰ä¹Ÿæ˜¯æ™ºèƒ½æŒ‡é’ˆã€‚</p><p>ä»Šå¤©æˆ‘ä»¬å°±æ·±å…¥åˆ†æä¸‰ä¸ªä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆçš„æ•°æ®ç»“æ„ï¼šåœ¨å †ä¸Šåˆ›å»ºå†…å­˜çš„ Box&lt;T&gt;ã€æä¾›å†™æ—¶å…‹éš†çš„ Cow&lt;'a, B&gt;ï¼Œä»¥åŠç”¨äºæ•°æ®åŠ é”çš„ MutexGuard&lt;T&gt;ã€‚</p><p>è€Œä¸”æœ€åæˆ‘ä»¬ä¼šå°è¯•å®ç°è‡ªå·±çš„æ™ºèƒ½æŒ‡é’ˆã€‚å¸Œæœ›å­¦å®Œåä½ ä¸ä½†èƒ½æ›´å¥½åœ°ç†è§£æ™ºèƒ½æŒ‡é’ˆï¼Œè¿˜èƒ½åœ¨éœ€è¦çš„æ—¶å€™ï¼Œæ„å»ºè‡ªå·±çš„æ™ºèƒ½æŒ‡é’ˆæ¥è§£å†³é—®é¢˜ã€‚</p><h2>Box&lt;T&gt;</h2><p>æˆ‘ä»¬å…ˆçœ‹ Box&lt;T&gt;ï¼Œå®ƒæ˜¯ Rust ä¸­æœ€åŸºæœ¬çš„åœ¨å †ä¸Šåˆ†é…å†…å­˜çš„æ–¹å¼ï¼Œç»å¤§å¤šæ•°å…¶å®ƒåŒ…å«å †å†…å­˜åˆ†é…çš„æ•°æ®ç±»å‹ï¼Œå†…éƒ¨éƒ½æ˜¯é€šè¿‡ Box&lt;T&gt; å®Œæˆçš„ï¼Œæ¯”å¦‚ Vec&lt;T&gt;ã€‚</p><p>ä¸ºä»€ä¹ˆæœ‰Box&lt;T&gt;çš„è®¾è®¡ï¼Œæˆ‘ä»¬å¾—å…ˆå›å¿†ä¸€ä¸‹åœ¨ C è¯­è¨€ä¸­ï¼Œå †å†…å­˜æ˜¯æ€ä¹ˆåˆ†é…çš„ã€‚</p><p>C éœ€è¦ä½¿ç”¨ malloc/calloc/realloc/free æ¥å¤„ç†å†…å­˜çš„åˆ†é…ï¼Œå¾ˆå¤šæ—¶å€™ï¼Œè¢«åˆ†é…å‡ºæ¥çš„å†…å­˜åœ¨å‡½æ•°è°ƒç”¨ä¸­æ¥æ¥å›å›ä½¿ç”¨ï¼Œå¯¼è‡´è°åº”è¯¥è´Ÿè´£é‡Šæ”¾è¿™ä»¶äº‹æƒ…å¾ˆéš¾ç¡®å®šï¼Œç»™å¼€å‘è€…é€ æˆäº†æå¤§çš„å¿ƒæ™ºè´Ÿæ‹…ã€‚</p><p>C++ åœ¨æ­¤åŸºç¡€ä¸Šæ”¹è¿›äº†ä¸€ä¸‹ï¼Œæä¾›äº†ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆ <a href=\"https://en.cppreference.com/w/cpp/memory/unique_ptr\">unique_ptr</a>ï¼Œå¯ä»¥åœ¨æŒ‡é’ˆé€€å‡ºä½œç”¨åŸŸçš„æ—¶å€™é‡Šæ”¾å †å†…å­˜ï¼Œè¿™æ ·ä¿è¯äº†å †å†…å­˜çš„å•ä¸€æ‰€æœ‰æƒã€‚è¿™ä¸ª unique_ptr å°±æ˜¯ Rust çš„ Box&lt;T&gt; çš„å‰èº«ã€‚</p><p>ä½ çœ‹ Box&lt;T&gt; çš„å®šä¹‰é‡Œï¼Œå†…éƒ¨å°±æ˜¯ä¸€ä¸ª <a href=\"https://doc.rust-lang.org/src/core/ptr/unique.rs.html#36-44\">Unique&lt;T&gt;</a> ç”¨äºè‡´æ•¬ C++ï¼ŒUnique&lt;T&gt; æ˜¯ä¸€ä¸ªç§æœ‰çš„æ•°æ®ç»“æ„ï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œå®ƒåŒ…è£¹äº†ä¸€ä¸ª *const T æŒ‡é’ˆï¼Œå¹¶å”¯ä¸€æ‹¥æœ‰è¿™ä¸ªæŒ‡é’ˆã€‚</p><pre><code class=\"language-rust\">pub struct Unique&lt;T: ?Sized&gt; {\n    pointer: *const T,\n    // NOTE: this marker has no consequences for variance, but is necessary\n    // for dropck to understand that we logically own a `T`.\n    //\n    // For details, see:\n    // https://github.com/rust-lang/rfcs/blob/master/text/0769-sound-generic-drop.md#phantom-data\n    _marker: PhantomData&lt;T&gt;,\n}\n</code></pre><p>æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨å †ä¸Šåˆ†é…å†…å­˜ï¼Œéœ€è¦ä½¿ç”¨å†…å­˜åˆ†é…å™¨ï¼ˆAllocatorï¼‰ã€‚å¦‚æœä½ ä¸Šè¿‡æ“ä½œç³»ç»Ÿè¯¾ç¨‹ï¼Œåº”è¯¥è¿˜è®°å¾—ä¸€ä¸ªç®€å•çš„ <a href=\"https://en.wikipedia.org/wiki/Buddy_memory_allocation\">buddy system</a> æ˜¯å¦‚ä½•åˆ†é…å’Œç®¡ç†å †å†…å­˜çš„ã€‚</p><p>è®¾è®¡å†…å­˜åˆ†é…å™¨çš„ç›®çš„é™¤äº†ä¿è¯æ­£ç¡®æ€§ä¹‹å¤–ï¼Œå°±æ˜¯ä¸ºäº†æœ‰æ•ˆåœ°åˆ©ç”¨å‰©ä½™å†…å­˜ï¼Œå¹¶æ§åˆ¶å†…å­˜åœ¨åˆ†é…å’Œé‡Šæ”¾è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ç¢ç‰‡çš„æ•°é‡ã€‚åœ¨å¤šæ ¸ç¯å¢ƒä¸‹ï¼Œå®ƒè¿˜è¦èƒ½å¤Ÿé«˜æ•ˆåœ°å¤„ç†å¹¶å‘è¯·æ±‚ã€‚ï¼ˆå¦‚æœä½ å¯¹é€šç”¨å†…å­˜åˆ†é…å™¨æ„Ÿå…´è¶£ï¼Œå¯ä»¥çœ‹å‚è€ƒèµ„æ–™ï¼‰</p><p>å †ä¸Šåˆ†é…å†…å­˜çš„ Box&lt;T&gt; å…¶å®æœ‰ä¸€ä¸ªç¼ºçœçš„æ³›å‹å‚æ•° Aï¼Œå°±éœ€è¦æ»¡è¶³ <a href=\"https://doc.rust-lang.org/std/alloc/trait.Allocator.html\">Allocator trait</a>ï¼Œå¹¶ä¸”é»˜è®¤æ˜¯ Globalï¼š</p><pre><code class=\"language-rust\">pub struct Box&lt;T: ?Sized,A: Allocator = Global&gt;(Unique&lt;T&gt;, A)\n</code></pre><p>Allocator trait æä¾›å¾ˆå¤šæ–¹æ³•ï¼š</p><ul>\n<li>allocateæ˜¯ä¸»è¦æ–¹æ³•ï¼Œç”¨äºåˆ†é…å†…å­˜ï¼Œå¯¹åº” C çš„ malloc/callocï¼›</li>\n<li>deallocateï¼Œç”¨äºé‡Šæ”¾å†…å­˜ï¼Œå¯¹åº” C çš„ freeï¼›</li>\n<li>è¿˜æœ‰ grow / shrinkï¼Œç”¨æ¥æ‰©å¤§æˆ–ç¼©å°å †ä¸Šå·²åˆ†é…çš„å†…å­˜ï¼Œå¯¹åº” C çš„ reallocã€‚</li>\n</ul><p>è¿™é‡Œå¯¹ Allocator trait æˆ‘ä»¬å°±ä¸è¯¦ç»†ä»‹ç»äº†ï¼Œå¦‚æœä½ æƒ³æ›¿æ¢é»˜è®¤çš„å†…å­˜åˆ†é…å™¨ï¼Œå¯ä»¥ä½¿ç”¨ #[global_allocator] æ ‡è®°å®ï¼Œå®šä¹‰ä½ è‡ªå·±çš„å…¨å±€åˆ†é…å™¨ã€‚ä¸‹é¢çš„ä»£ç å±•ç¤ºäº†å¦‚ä½•åœ¨ Rust ä¸‹ä½¿ç”¨ <a href=\"https://crates.io/crates/jemallocator\">jemalloc</a>ï¼š</p><pre><code class=\"language-rust\">use jemallocator::Jemalloc;\n\n#[global_allocator]\nstatic GLOBAL: Jemalloc = Jemalloc;\n\nfn main() {}\n</code></pre><p>è¿™æ ·è®¾ç½®ä¹‹åï¼Œä½ ä½¿ç”¨ Box::new() åˆ†é…çš„å†…å­˜å°±æ˜¯ jemalloc åˆ†é…å‡ºæ¥çš„äº†ã€‚å¦å¤–ï¼Œå¦‚æœä½ æƒ³æ’°å†™è‡ªå·±çš„å…¨å±€åˆ†é…å™¨ï¼Œå¯ä»¥å®ç° <a href=\"https://doc.rust-lang.org/std/alloc/trait.GlobalAlloc.html\">GlobalAlloc trait</a>ï¼Œå®ƒå’Œ Allocator trait çš„åŒºåˆ«ï¼Œä¸»è¦åœ¨äºæ˜¯å¦å…è®¸åˆ†é…é•¿åº¦ä¸ºé›¶çš„å†…å­˜ã€‚</p><h3>ä½¿ç”¨åœºæ™¯</h3><p>ä¸‹é¢æˆ‘ä»¬æ¥å®ç°ä¸€ä¸ªè‡ªå·±çš„å†…å­˜åˆ†é…å™¨ã€‚åˆ«æ‹…å¿ƒï¼Œè¿™é‡Œå°±æ˜¯æƒ³ debug ä¸€ä¸‹ï¼Œçœ‹çœ‹å†…å­˜å¦‚ä½•åˆ†é…å’Œé‡Šæ”¾ï¼Œå¹¶ä¸ä¼šå®é™…å®ç°æŸä¸ªåˆ†é…ç®—æ³•ã€‚</p><p>é¦–å…ˆçœ‹å†…å­˜çš„åˆ†é…ã€‚è¿™é‡Œ MyAllocator å°±ç”¨ System allocatorï¼Œç„¶ååŠ  eprintln!()ï¼Œå’Œæˆ‘ä»¬å¸¸ç”¨çš„ println!() ä¸åŒçš„æ˜¯ï¼Œeprintln!() å°†æ•°æ®æ‰“å°åˆ° stderrï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=ca0ae6821e08e16609b1e10ac743e6c9\">ä»£ç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">use std::alloc::{GlobalAlloc, Layout, System};\n\nstruct MyAllocator;\n\nunsafe impl GlobalAlloc for MyAllocator {\n    unsafe fn alloc(&amp;self, layout: Layout) -&gt; *mut u8 {\n        let data = System.alloc(layout);\n        eprintln!(\"ALLOC: {:p}, size {}\", data, layout.size());\n        data\n    }\n\n    unsafe fn dealloc(&amp;self, ptr: *mut u8, layout: Layout) {\n        System.dealloc(ptr, layout);\n        eprintln!(\"FREE: {:p}, size {}\", ptr, layout.size());\n    }\n}\n\n#[global_allocator]\nstatic GLOBAL: MyAllocator = MyAllocator;\n\n#[allow(dead_code)]\nstruct Matrix {\n    // ä½¿ç”¨ä¸è§„åˆ™çš„æ•°å­—å¦‚ 505 å¯ä»¥è®© dbg! çš„æ‰“å°å¾ˆå®¹æ˜“åˆ†è¾¨å‡ºæ¥\n    data: [u8; 505],\n}\n\nimpl Default for Matrix {\n    fn default() -&gt; Self {\n        Self { data: [0; 505] }\n    }\n}\n\nfn main() {\n    // åœ¨è¿™å¥æ‰§è¡Œä¹‹å‰å·²ç»æœ‰å¥½å¤šå†…å­˜åˆ†é…\n    let data = Box::new(Matrix::default());\n\n    // è¾“å‡ºä¸­æœ‰ä¸€ä¸ª 1024 å¤§å°çš„å†…å­˜åˆ†é…ï¼Œæ˜¯ println! å¯¼è‡´çš„\n    println!(\n        \"!!! allocated memory: {:p}, len: {}\",\n        &amp;*data,\n        std::mem::size_of::&lt;Matrix&gt;()\n    );\n\n    // data åœ¨è¿™é‡Œ dropï¼Œå¯ä»¥åœ¨æ‰“å°ä¸­çœ‹åˆ° FREE\n    // ä¹‹åè¿˜æœ‰å¾ˆå¤šå…¶å®ƒå†…å­˜è¢«é‡Šæ”¾\n}\n</code></pre><p>æ³¨æ„è¿™é‡Œä¸èƒ½ä½¿ç”¨ println!() ã€‚å› ä¸º stdout ä¼šæ‰“å°åˆ°ä¸€ä¸ªç”± Mutex äº’æ–¥é”ä¿æŠ¤çš„å…±äº«å…¨å±€ buffer ä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­ä¼šæ¶‰åŠå†…å­˜çš„åˆ†é…ï¼Œåˆ†é…çš„å†…å­˜åˆä¼šè§¦å‘ println!()ï¼Œæœ€ç»ˆé€ æˆç¨‹åºå´©æºƒã€‚è€Œ eprintln! ç›´æ¥æ‰“å°åˆ° stderrï¼Œä¸ä¼š bufferã€‚</p><p>è¿è¡Œè¿™æ®µä»£ç ï¼Œä½ å¯ä»¥çœ‹åˆ°ç±»ä¼¼å¦‚ä¸‹è¾“å‡ºï¼Œå…¶ä¸­ 505 å¤§å°çš„å†…å­˜æ˜¯æˆ‘ä»¬ Box::new() å‡ºæ¥çš„ï¼š</p><pre><code class=\"language-bash\">â¯ cargo run --bin allocator --quiet\nALLOC: 0x7fbe0dc05c20, size 4\nALLOC: 0x7fbe0dc05c30, size 5\nFREE: 0x7fbe0dc05c20, size 4\nALLOC: 0x7fbe0dc05c40, size 64\nALLOC: 0x7fbe0dc05c80, size 48\nALLOC: 0x7fbe0dc05cb0, size 80\nALLOC: 0x7fbe0dc05da0, size 24\nALLOC: 0x7fbe0dc05dc0, size 64\nALLOC: 0x7fbe0dc05e00, size 505\nALLOC: 0x7fbe0e008800, size 1024\n!!! allocated memory: 0x7fbe0dc05e00, len: 505\nFREE: 0x7fbe0dc05e00, size 505\nFREE: 0x7fbe0e008800, size 1024\nFREE: 0x7fbe0dc05c30, size 5\nFREE: 0x7fbe0dc05c40, size 64\nFREE: 0x7fbe0dc05c80, size 48\nFREE: 0x7fbe0dc05cb0, size 80\nFREE: 0x7fbe0dc05dc0, size 64\nFREE: 0x7fbe0dc05da0, size 24\n</code></pre><p>åœ¨ä½¿ç”¨ Box åˆ†é…å †å†…å­˜çš„æ—¶å€™è¦æ³¨æ„ï¼ŒBox::new() æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ‰€ä»¥ä¼ å…¥å®ƒçš„æ•°æ®ä¼šå‡ºç°åœ¨æ ˆä¸Šï¼Œå†ç§»åŠ¨åˆ°å †ä¸Šã€‚æ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬çš„ Matrix ç»“æ„ä¸æ˜¯ 505 ä¸ªå­—èŠ‚ï¼Œæ˜¯ä¸€ä¸ªéå¸¸å¤§çš„ç»“æ„ï¼Œå°±æœ‰å¯èƒ½å‡ºé—®é¢˜ã€‚</p><p>æ¯”å¦‚ä¸‹é¢çš„ä»£ç æƒ³åœ¨å †ä¸Šåˆ†é… 16M å†…å­˜ï¼Œå¦‚æœä½ åœ¨ playground é‡Œè¿è¡Œï¼Œç›´æ¥æ ˆæº¢å‡º stack overflowï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=4aa8e21e6da6b572dae2ad8d68787e1e\">ä»£ç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">fn main() {\n    // åœ¨å †ä¸Šåˆ†é… 16M å†…å­˜ï¼Œä½†å®ƒä¼šç°åœ¨æ ˆä¸Šå‡ºç°ï¼Œå†ç§»åŠ¨åˆ°å †ä¸Š\n    let boxed = Box::new([0u8; 1 &lt;&lt; 24]);\n    println!(\"len: {}\", boxed.len());\n}\n</code></pre><p>ä½†å¦‚æœä½ åœ¨æœ¬åœ°ä½¿ç”¨ â€œcargo run â€”releaseâ€ ç¼–è¯‘æˆ release ä»£ç è¿è¡Œï¼Œä¼šæ­£å¸¸æ‰§è¡Œï¼</p><p>è¿™æ˜¯å› ä¸º â€œcargo runâ€ æˆ–è€…åœ¨ playground ä¸‹è¿è¡Œï¼Œé»˜è®¤æ˜¯ debug buildï¼Œå®ƒä¸ä¼šåšä»»ä½• inline çš„ä¼˜åŒ–ï¼Œè€Œ Box::new() çš„å®ç°å°±ä¸€è¡Œä»£ç ï¼Œå¹¶æ³¨æ˜äº†è¦ inlineï¼Œåœ¨ release æ¨¡å¼ä¸‹ï¼Œè¿™ä¸ªå‡½æ•°è°ƒç”¨ä¼šè¢«ä¼˜åŒ–æ‰ï¼š</p><pre><code class=\"language-rust\">#[cfg(not(no_global_oom_handling))]\n#[inline(always)]\n#[doc(alias = \"alloc\")]\n#[doc(alias = \"malloc\")]\n#[stable(feature = \"rust1\", since = \"1.0.0\")]\npub fn new(x: T) -&gt; Self {\n    box x\n}\n</code></pre><p>å¦‚æœä¸ inlineï¼Œæ•´ä¸ª 16M çš„å¤§æ•°ç»„ä¼šé€šè¿‡æ ˆå†…å­˜ä¼ é€’ç»™ Box::newï¼Œå¯¼è‡´æ ˆæº¢å‡ºã€‚è¿™é‡Œæˆ‘ä»¬æƒŠå–œåœ°å‘ç°äº†ä¸€ä¸ªæ–°çš„å…³é”®å­— boxã€‚ç„¶è€Œ box æ˜¯ Rust å†…éƒ¨çš„å…³é”®å­—ï¼Œç”¨æˆ·ä»£ç æ— æ³•è°ƒç”¨ï¼Œå®ƒåªå‡ºç°åœ¨ Rust ä»£ç ä¸­ï¼Œç”¨äºåˆ†é…å †å†…å­˜ï¼Œbox å…³é”®å­—åœ¨ç¼–è¯‘æ—¶ï¼Œä¼šä½¿ç”¨å†…å­˜åˆ†é…å™¨åˆ†é…å†…å­˜ã€‚</p><p>ææ˜ç™½ Box&lt;T&gt; çš„å†…å­˜åˆ†é…ï¼Œæˆ‘ä»¬è¿˜å¾ˆå…³å¿ƒå†…å­˜æ˜¯å¦‚ä½•é‡Šæ”¾çš„ï¼Œæ¥çœ‹å®ƒå®ç°çš„ Drop traitï¼š</p><pre><code class=\"language-rust\">#[stable(feature = \"rust1\", since = \"1.0.0\")]\nunsafe impl&lt;#[may_dangle] T: ?Sized, A: Allocator&gt; Drop for Box&lt;T, A&gt; {\n    fn drop(&amp;mut self) {\n        // FIXME: Do nothing, drop is currently performed by compiler.\n    }\n}\n</code></pre><p>å“ˆï¼Œç›®å‰ drop trait ä»€ä¹ˆéƒ½æ²¡æœ‰åšï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨æ’å…¥ deallocate çš„ä»£ç ã€‚è¿™æ˜¯ Rust è¯­è¨€çš„ä¸€ç§ç­–ç•¥ï¼š<strong>åœ¨å…·ä½“å®ç°è¿˜æ²¡æœ‰ç¨³å®šä¸‹æ¥ä¹‹å‰ï¼Œæˆ‘å…ˆæŠŠæ¥å£ç¨³å®šï¼Œå®ç°éšç€ä¹‹åçš„è¿­ä»£æ…¢æ…¢ç¨³å®š</strong>ã€‚</p><p>è¿™æ ·å¯ä»¥æå¤§åœ°é¿å…è¯­è¨€åœ¨å‘å±•çš„è¿‡ç¨‹ä¸­ï¼Œå¼•å…¥å¯¹å¼€å‘è€…è€Œè¨€çš„ç ´åæ€§æ›´æ–°ï¼ˆbreaking changeï¼‰ã€‚ç ´åæ€§æ›´æ–°ä¼šä½¿å¾—å¼€å‘è€…åœ¨å‡çº§è¯­è¨€çš„ç‰ˆæœ¬æ—¶ï¼Œä¸å¾—ä¸å¤§å¹…æ›´æ”¹åŸæœ‰ä»£ç ã€‚</p><p>Python æ˜¯ä¸ªå‰è½¦ä¹‹é‰´ï¼Œç”±äºå¼•å…¥äº†å¤§é‡çš„ç ´åæ€§æ›´æ–°ï¼ŒPython 2 åˆ° 3 çš„å‡çº§èŠ±äº†åå¤šå¹´æ‰æ…¢æ…¢å®Œæˆã€‚æ‰€ä»¥ Rust åœ¨è®¾è®¡æ¥å£æ—¶éå¸¸è°¨æ…ï¼Œå¾ˆå¤šé‡è¦çš„æ¥å£éƒ½å…ˆä»¥åº“çš„å½¢å¼å­˜åœ¨äº†å¾ˆä¹…ï¼Œæœ€ç»ˆæ‰æˆä¸ºæ ‡å‡†åº“çš„ä¸€éƒ¨åˆ†ï¼Œæ¯”å¦‚ Future traitã€‚ä¸€æ—¦æ¥å£ç¨³å®šåï¼Œå†…éƒ¨çš„å®ç°å¯ä»¥æ…¢æ…¢ç¨³å®šã€‚</p><h2>Cow&lt;'a, B&gt;</h2><p>äº†è§£äº† Box çš„å·¥ä½œåŸç†åï¼Œå†æ¥çœ‹ Cow&lt;'a, B&gt;çš„åŸç†å’Œä½¿ç”¨åœºæ™¯ï¼Œï¼ˆ<a href=\"https://time.geekbang.org/column/article/420021\">ç¬¬12è®²</a>ï¼‰è®²æ³›å‹æ•°æ®ç»“æ„çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç®€å•è®²è¿‡å‚æ•°Bçš„ä¸‰ä¸ªçº¦æŸã€‚</p><p>Cow æ˜¯ Rust ä¸‹ç”¨äºæä¾›å†™æ—¶å…‹éš†ï¼ˆClone-on-Writeï¼‰çš„ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆï¼Œå®ƒè·Ÿè™šæ‹Ÿå†…å­˜ç®¡ç†çš„å†™æ—¶å¤åˆ¶ï¼ˆCopy-on-writeï¼‰æœ‰å¼‚æ›²åŒå·¥ä¹‹å¦™ï¼š<strong>åŒ…è£¹ä¸€ä¸ªåªè¯»å€Ÿç”¨ï¼Œä½†å¦‚æœè°ƒç”¨è€…éœ€è¦æ‰€æœ‰æƒæˆ–è€…éœ€è¦ä¿®æ”¹å†…å®¹ï¼Œé‚£ä¹ˆå®ƒä¼š clone å€Ÿç”¨çš„æ•°æ®</strong>ã€‚</p><p>æˆ‘ä»¬çœ‹Cowçš„å®šä¹‰ï¼š</p><pre><code class=\"language-rust\">pub enum Cow&lt;'a, B&gt; where B: 'a + ToOwned + ?Sized {\n  Borrowed(&amp;'a B),\n  Owned(&lt;B as ToOwned&gt;::Owned),\n}\n</code></pre><p>å®ƒæ˜¯ä¸€ä¸ª enumï¼Œå¯ä»¥åŒ…å«ä¸€ä¸ªå¯¹ç±»å‹ B çš„åªè¯»å¼•ç”¨ï¼Œæˆ–è€…åŒ…å«å¯¹ç±»å‹ B çš„æ‹¥æœ‰æ‰€æœ‰æƒçš„æ•°æ®ã€‚</p><p>è¿™é‡Œåˆå¼•å…¥äº†ä¸¤ä¸ª traitï¼Œé¦–å…ˆæ˜¯ ToOwnedï¼Œåœ¨ ToOwned trait å®šä¹‰çš„æ—¶å€™ï¼Œåˆå¼•å…¥äº† Borrow traitï¼Œå®ƒä»¬éƒ½æ˜¯ <a href=\"https://doc.rust-lang.org/std/borrow/index.html\">std::borrow</a> ä¸‹çš„ traitï¼š</p><pre><code class=\"language-rust\">pub trait ToOwned {\n    type Owned: Borrow&lt;Self&gt;;\n    #[must_use = \"cloning is often expensive and is not expected to have side effects\"]\n    fn to_owned(&amp;self) -&gt; Self::Owned;\n\n    fn clone_into(&amp;self, target: &amp;mut Self::Owned) { ... }\n}\n\npub trait Borrow&lt;Borrowed&gt; where Borrowed: ?Sized {\n    fn borrow(&amp;self) -&gt; &amp;Borrowed;\n}\n</code></pre><p>å¦‚æœä½ çœ‹ä¸æ‡‚è¿™æ®µä»£ç ï¼Œä¸è¦ç€æ€¥ï¼Œæƒ³è¦ç†è§£ Cow traitï¼ŒToOwned trait æ˜¯ä¸€é“åï¼Œå› ä¸º type Owned: Borrow&lt;Self&gt; ä¸å¥½ç†è§£ï¼Œè€ä¸‹å¿ƒæ¥æˆ‘ä»¬æ‹†å¼€ä¸€ç‚¹ç‚¹è§£è¯»ã€‚</p><p>é¦–å…ˆï¼Œtype Owned: Borrow&lt;Self&gt; æ˜¯ä¸€ä¸ªå¸¦æœ‰å…³è”ç±»å‹çš„ trait ï¼Œå¦‚æœä½ å¯¹è¿™ä¸ªçŸ¥è¯†ç‚¹æœ‰äº›é—å¿˜ï¼Œå¯ä»¥å†å¤ä¹ ä¸€ä¸‹<a href=\"https://time.geekbang.org/column/article/420028\">ç¬¬ 13 è®²</a>ã€‚è¿™é‡Œ Owned æ˜¯å…³è”ç±»å‹ï¼Œéœ€è¦ä½¿ç”¨è€…å®šä¹‰ï¼Œå’Œæˆ‘ä»¬ä¹‹å‰ä»‹ç»çš„å…³è”ç±»å‹ä¸åŒçš„æ˜¯ï¼Œè¿™é‡Œ Owned ä¸èƒ½æ˜¯ä»»æ„ç±»å‹ï¼Œå®ƒå¿…é¡»æ»¡è¶³ Borrow&lt;T&gt; traitã€‚ä¾‹å¦‚æˆ‘ä»¬çœ‹ <a href=\"https://doc.rust-lang.org/src/alloc/str.rs.html#215-227\">str å¯¹ ToOwned trait çš„å®ç°</a>ï¼š</p><pre><code class=\"language-rust\">impl ToOwned for str {\n    type Owned = String;\n    #[inline]\n    fn to_owned(&amp;self) -&gt; String {\n        unsafe { String::from_utf8_unchecked(self.as_bytes().to_owned()) }\n    }\n\n    fn clone_into(&amp;self, target: &amp;mut String) {\n        let mut b = mem::take(target).into_bytes();\n        self.as_bytes().clone_into(&amp;mut b);\n        *target = unsafe { String::from_utf8_unchecked(b) }\n    }\n}\n</code></pre><p>å¯ä»¥çœ‹åˆ°å…³è”ç±»å‹ Owned è¢«å®šä¹‰ä¸º Stringï¼Œè€Œæ ¹æ®è¦æ±‚ï¼ŒString å¿…é¡»å®šä¹‰ Borrow&lt;T&gt;ï¼Œé‚£è¿™é‡Œ Borrow&lt;T&gt; é‡Œçš„æ³›å‹å˜é‡ T æ˜¯è°å‘¢ï¼Ÿ</p><p>ToOwned è¦æ±‚æ˜¯ Borrow&lt;Self&gt;ï¼Œè€Œæ­¤åˆ»å®ç° ToOwned çš„ä¸»ä½“æ˜¯ strï¼Œæ‰€ä»¥ Borrow&lt;Self&gt; æ˜¯ Borrow&lt;str&gt;ï¼Œä¹Ÿå°±æ˜¯è¯´ String è¦å®ç° Borrow&lt;str&gt;ï¼Œæˆ‘ä»¬çœ‹<a href=\"https://doc.rust-lang.org/std/string/struct.String.html#impl-Borrow%3Cstr%3E\">æ–‡æ¡£</a>ï¼Œå®ƒçš„ç¡®<a href=\"https://doc.rust-lang.org/src/alloc/str.rs.html#198-203\">å®ç°äº†è¿™ä¸ª trait</a>ï¼š</p><pre><code class=\"language-rust\">impl Borrow&lt;str&gt; for String {\n    #[inline]\n    fn borrow(&amp;self) -&gt; &amp;str {\n        &amp;self[..]\n    }\n}\n</code></pre><p>ä½ æ˜¯ä¸æ˜¯æœ‰ç‚¹æ™•äº†ï¼Œæˆ‘ç”¨ä¸€å¼ å›¾æ¢³ç†äº†è¿™å‡ ä¸ª trait ä¹‹é—´çš„å…³ç³»ï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/ay/52/ayyc5f85c3d9897ddd1acd4c067a5852.jpg?wh=3248x2012\" alt=\"\"></p><p>é€šè¿‡è¿™å¼ å›¾ï¼Œæˆ‘ä»¬å¯ä»¥æ›´å¥½åœ°ææ¸…æ¥š Cow å’Œ ToOwned / Borrow&lt;T&gt; ä¹‹é—´çš„å…³ç³»ã€‚</p><p>è¿™é‡Œï¼Œä½ å¯èƒ½ä¼šç–‘æƒ‘ï¼Œä¸ºä½• Borrow è¦å®šä¹‰æˆä¸€ä¸ªæ³›å‹ trait å‘¢ï¼Ÿæè¿™ä¹ˆå¤æ‚ï¼Œéš¾é“ä¸€ä¸ªç±»å‹è¿˜å¯ä»¥è¢«å€Ÿç”¨æˆä¸åŒçš„å¼•ç”¨ä¹ˆï¼Ÿ</p><p>æ˜¯çš„ã€‚æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=36831f05a3e27690beac9fd5beb5b524\">ä»£ç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">use std::borrow::Borrow;\n\nfn main() {\n    let s = \"hello world!\".to_owned();\n\n    // è¿™é‡Œå¿…é¡»å£°æ˜ç±»å‹ï¼Œå› ä¸º String æœ‰å¤šä¸ª Borrow&lt;T&gt; å®ç°\n    // å€Ÿç”¨ä¸º &amp;String\n    let r1: &amp;String = s.borrow();\n    // å€Ÿç”¨ä¸º &amp;str\n    let r2: &amp;str = s.borrow();\n\n    println!(\"r1: {:p}, r2: {:p}\", r1, r2);\n}\n</code></pre><p>åœ¨è¿™é‡Œä¾‹å­é‡Œï¼ŒString å¯ä»¥è¢«å€Ÿç”¨ä¸º &amp;Stringï¼Œä¹Ÿå¯ä»¥è¢«å€Ÿç”¨ä¸º &amp;strã€‚</p><p>å¥½ï¼Œå†æ¥ç»§ç»­çœ‹ Cowã€‚æˆ‘ä»¬è¯´å®ƒæ˜¯æ™ºèƒ½æŒ‡é’ˆï¼Œé‚£å®ƒè‡ªç„¶éœ€è¦<a href=\"https://doc.rust-lang.org/src/alloc/borrow.rs.html#332-341\">å®ç° Deref trait</a>ï¼š</p><pre><code class=\"language-rust\">impl&lt;B: ?Sized + ToOwned&gt; Deref for Cow&lt;'_, B&gt; {\n    type Target = B;\n\n    fn deref(&amp;self) -&gt; &amp;B {\n        match *self {\n            Borrowed(borrowed) =&gt; borrowed,\n            Owned(ref owned) =&gt; owned.borrow(),\n        }\n    }\n}\n</code></pre><p>å®ç°çš„åŸç†å¾ˆç®€å•ï¼Œæ ¹æ® self æ˜¯ Borrowed è¿˜æ˜¯ Ownedï¼Œæˆ‘ä»¬åˆ†åˆ«å–å…¶å†…å®¹ï¼Œç”Ÿæˆå¼•ç”¨ï¼š</p><ul>\n<li>å¯¹äº Borrowedï¼Œç›´æ¥å°±æ˜¯å¼•ç”¨ï¼›</li>\n<li>å¯¹äº Ownedï¼Œè°ƒç”¨å…¶ borrow() æ–¹æ³•ï¼Œè·å¾—å¼•ç”¨ã€‚</li>\n</ul><p>è¿™å°±å¾ˆå‰å®³äº†ã€‚è™½ç„¶ Cow æ˜¯ä¸€ä¸ª enumï¼Œä½†æ˜¯é€šè¿‡ Deref çš„å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥è·å¾—ç»Ÿä¸€çš„ä½“éªŒï¼Œæ¯”å¦‚ Cow&lt;str&gt;ï¼Œä½¿ç”¨çš„æ„Ÿè§‰å’Œ &amp;str / String æ˜¯åŸºæœ¬ä¸€è‡´çš„ã€‚æ³¨æ„ï¼Œ<strong>è¿™ç§æ ¹æ® enum çš„ä¸åŒçŠ¶æ€æ¥è¿›è¡Œç»Ÿä¸€åˆ†å‘çš„æ–¹æ³•æ˜¯ç¬¬ä¸‰ç§åˆ†å‘æ‰‹æ®µ</strong>ï¼Œä¹‹å‰è®²è¿‡å¯ä»¥ä½¿ç”¨æ³›å‹å‚æ•°åšé™æ€åˆ†å‘å’Œä½¿ç”¨ trait object åšåŠ¨æ€åˆ†å‘ã€‚</p><h3>ä½¿ç”¨åœºæ™¯</h3><p>é‚£ä¹ˆ Cow æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿæ˜¾ç„¶ï¼Œå®ƒå¯ä»¥åœ¨éœ€è¦çš„æ—¶å€™æ‰è¿›è¡Œå†…å­˜çš„åˆ†é…å’Œæ‹·è´ï¼Œåœ¨å¾ˆå¤šåº”ç”¨åœºåˆï¼Œå®ƒå¯ä»¥å¤§å¤§æå‡ç³»ç»Ÿçš„æ•ˆç‡ã€‚å¦‚æœ Cow&lt;'a, B&gt; ä¸­çš„ Owned æ•°æ®ç±»å‹æ˜¯ä¸€ä¸ªéœ€è¦åœ¨å †ä¸Šåˆ†é…å†…å­˜çš„ç±»å‹ï¼Œå¦‚ Stringã€Vec&lt;T&gt; ç­‰ï¼Œè¿˜èƒ½å‡å°‘å †å†…å­˜åˆ†é…çš„æ¬¡æ•°ã€‚</p><p>æˆ‘ä»¬è¯´è¿‡ï¼Œç›¸å¯¹äºæ ˆå†…å­˜çš„åˆ†é…é‡Šæ”¾æ¥è¯´ï¼Œå †å†…å­˜çš„åˆ†é…å’Œé‡Šæ”¾æ•ˆç‡è¦ä½å¾ˆå¤šï¼Œå…¶å†…éƒ¨è¿˜æ¶‰åŠç³»ç»Ÿè°ƒç”¨å’Œé”ï¼Œ<strong>å‡å°‘ä¸å¿…è¦çš„å †å†…å­˜åˆ†é…æ˜¯æå‡ç³»ç»Ÿæ•ˆç‡çš„å…³é”®æ‰‹æ®µ</strong>ã€‚è€Œ Rust çš„ Cow&lt;'a, B&gt;ï¼Œåœ¨å¸®åŠ©ä½ è¾¾æˆè¿™ä¸ªæ•ˆæœçš„åŒæ—¶ï¼Œä½¿ç”¨ä½“éªŒè¿˜éå¸¸ç®€å•èˆ’æœã€‚</p><p>å…‰è¿™ä¹ˆè¯´æ²¡æœ‰ä»£ç ä½è¯ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸ªä½¿ç”¨ Cow çš„å®é™…ä¾‹å­ã€‚</p><p>åœ¨è§£æ URL çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦å°† querystring ä¸­çš„å‚æ•°ï¼Œæå–æˆ KV pair æ¥è¿›ä¸€æ­¥ä½¿ç”¨ã€‚ç»å¤§å¤šæ•°è¯­è¨€ä¸­ï¼Œæå–å‡ºæ¥çš„ KV éƒ½æ˜¯æ–°çš„å­—ç¬¦ä¸²ï¼Œåœ¨æ¯ç§’é’Ÿå¤„ç†å‡ å k ç”šè‡³ä¸Šç™¾ k è¯·æ±‚çš„ç³»ç»Ÿä¸­ï¼Œä½ å¯ä»¥æƒ³è±¡è¿™ä¼šå¸¦æ¥å¤šå°‘æ¬¡å †å†…å­˜çš„åˆ†é…ã€‚</p><p>ä½†åœ¨ Rust ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ Cow ç±»å‹è½»æ¾é«˜æ•ˆå¤„ç†å®ƒï¼Œåœ¨è¯»å– URL çš„è¿‡ç¨‹ä¸­ï¼š</p><ul>\n<li>æ¯è§£æå‡ºä¸€ä¸ª key æˆ–è€… valueï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ª &amp;str æŒ‡å‘ URL ä¸­ç›¸åº”çš„ä½ç½®ï¼Œç„¶åç”¨ Cow å°è£…å®ƒï¼›</li>\n<li>è€Œå½“è§£æå‡ºæ¥çš„å†…å®¹ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œéœ€è¦ decode æ—¶ï¼Œæ¯”å¦‚ â€œhello%20worldâ€ï¼Œæˆ‘ä»¬å¯ä»¥ç”Ÿæˆä¸€ä¸ªè§£æåçš„ Stringï¼ŒåŒæ ·ç”¨ Cow å°è£…å®ƒã€‚</li>\n</ul><p>çœ‹ä¸‹é¢çš„ä¾‹å­ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=4a7ec8125238dfefc0b8b82f262c3eaf\">ä»£ç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">use std::borrow::Cow;\n\nuse url::Url;\nfn main() {\n    let url = Url::parse(\"https://tyr.com/rust?page=1024&amp;sort=desc&amp;extra=hello%20world\").unwrap();\n    let mut pairs = url.query_pairs();\n\n    assert_eq!(pairs.count(), 3);\n\n    let (mut k, v) = pairs.next().unwrap();\n    // å› ä¸º k, v éƒ½æ˜¯ Cow&lt;str&gt; ä»–ä»¬ç”¨èµ·æ¥æ„Ÿè§‰å’Œ &amp;str æˆ–è€… String ä¸€æ ·\n    // æ­¤åˆ»ï¼Œä»–ä»¬éƒ½æ˜¯ Borrowed\n    println!(\"key: {}, v: {}\", k, v);\n    // å½“ä¿®æ”¹å‘ç”Ÿæ—¶ï¼Œk å˜æˆ Owned\n    k.to_mut().push_str(\"_lala\");\n\n    print_pairs((k, v));\n\n    print_pairs(pairs.next().unwrap());\n    // åœ¨å¤„ç† extra=hello%20world æ—¶ï¼Œvalue è¢«å¤„ç†æˆ \"hello world\"\n    // æ‰€ä»¥è¿™é‡Œ value æ˜¯ Owned\n    print_pairs(pairs.next().unwrap());\n}\n\nfn print_pairs(pair: (Cow&lt;str&gt;, Cow&lt;str&gt;)) {\n    println!(\"key: {}, value: {}\", show_cow(pair.0), show_cow(pair.1));\n}\n\nfn show_cow(cow: Cow&lt;str&gt;) -&gt; String {\n    match cow {\n        Cow::Borrowed(v) =&gt; format!(\"Borrowed {}\", v),\n        Cow::Owned(v) =&gt; format!(\"Owned {}\", v),\n    }\n}\n</code></pre><p>æ˜¯ä¸æ˜¯å¾ˆç®€æ´ã€‚</p><p>ç±»ä¼¼ URL parse è¿™æ ·çš„å¤„ç†æ–¹å¼ï¼Œåœ¨ Rust æ ‡å‡†åº“å’Œç¬¬ä¸‰æ–¹åº“ä¸­éå¸¸å¸¸è§ã€‚æ¯”å¦‚ Rust ä¸‹è‘—åçš„ <a href=\"https://serde.rs/\">serde åº“</a>ï¼Œå¯ä»¥éå¸¸é«˜æ•ˆåœ°å¯¹ Rust æ•°æ®ç»“æ„ï¼Œè¿›è¡Œåºåˆ—åŒ–/ååºåˆ—åŒ–æ“ä½œï¼Œå®ƒå¯¹ Cow å°±æœ‰å¾ˆå¥½çš„æ”¯æŒã€‚</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹ä»£ç å°†ä¸€ä¸ª JSON æ•°æ®ååºåˆ—åŒ–æˆ User ç±»å‹ï¼ŒåŒæ—¶è®© User ä¸­çš„ name ä½¿ç”¨ Cow æ¥å¼•ç”¨ JSON æ–‡æœ¬ä¸­çš„å†…å®¹ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=5154f27658e3853fb894b3de993d877c\">ä»£ç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">use serde::Deserialize;\nuse std::borrow::Cow;\n\n#[derive(Debug, Deserialize)]\nstruct User&lt;'input&gt; {\n    #[serde(borrow)]\n    name: Cow&lt;'input, str&gt;,\n    age: u8,\n}\n\nfn main() {\n    let input = r#\"{ \"name\": \"Tyr\", \"age\": 18 }\"#;\n    let user: User = serde_json::from_str(input).unwrap();\n\n    match user.name {\n        Cow::Borrowed(x) =&gt; println!(\"borrowed {}\", x),\n        Cow::Owned(x) =&gt; println!(\"owned {}\", x),\n    }\n}\n</code></pre><p>æœªæ¥åœ¨ä½ ç”¨ Rust æ„é€ ç³»ç»Ÿæ—¶ï¼Œä¹Ÿå¯ä»¥å……åˆ†è€ƒè™‘åœ¨æ•°æ®ç±»å‹ä¸­ä½¿ç”¨ Cowã€‚</p><h2>MutexGuard&lt;T&gt;</h2><p>å¦‚æœè¯´ï¼Œä¸Šé¢ä»‹ç»çš„ Stringã€Box&lt;T&gt;ã€Cow&lt;'a, B&gt; ç­‰æ™ºèƒ½æŒ‡é’ˆï¼Œéƒ½æ˜¯é€šè¿‡ Deref æ¥æä¾›è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒï¼Œé‚£ä¹ˆ MutexGuard&lt;T&gt; æ˜¯å¦å¤–ä¸€ç±»å¾ˆæœ‰æ„æ€çš„æ™ºèƒ½æŒ‡é’ˆï¼šå®ƒä¸ä½†é€šè¿‡ Deref æä¾›è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒï¼Œ<strong>è¿˜é€šè¿‡ Drop trait æ¥ç¡®ä¿ï¼Œä½¿ç”¨åˆ°çš„å†…å­˜ä»¥å¤–çš„èµ„æºåœ¨é€€å‡ºæ—¶è¿›è¡Œé‡Šæ”¾</strong>ã€‚</p><p>MutexGuard<t> è¿™ä¸ªç»“æ„æ˜¯åœ¨è°ƒç”¨ <a href=\"https://doc.rust-lang.org/src/std/sync/mutex.rs.html#279-284\">Mutex::lock</a> æ—¶ç”Ÿæˆçš„ï¼š</t></p><pre><code class=\"language-rust\">pub fn lock(&amp;self) -&gt; LockResult&lt;MutexGuard&lt;'_, T&gt;&gt; {\n    unsafe {\n        self.inner.raw_lock();\n        MutexGuard::new(self)\n    }\n}\n</code></pre><p>é¦–å…ˆï¼Œå®ƒä¼šå–å¾—é”èµ„æºï¼Œå¦‚æœæ‹¿ä¸åˆ°ï¼Œä¼šåœ¨è¿™é‡Œç­‰å¾…ï¼›å¦‚æœæ‹¿åˆ°äº†ï¼Œä¼šæŠŠ Mutex ç»“æ„çš„å¼•ç”¨ä¼ é€’ç»™ MutexGuardã€‚</p><p>æˆ‘ä»¬çœ‹ MutexGuard çš„<a href=\"https://doc.rust-lang.org/src/std/sync/mutex.rs.html#190-195\">å®šä¹‰</a>ä»¥åŠå®ƒçš„ Deref å’Œ Drop çš„<a href=\"https://doc.rust-lang.org/src/std/sync/mutex.rs.html#462-487\">å®ç°</a>ï¼Œå¾ˆç®€å•ï¼š</p><pre><code class=\"language-rust\">// è¿™é‡Œç”¨ must_useï¼Œå½“ä½ å¾—åˆ°äº†å´ä¸ä½¿ç”¨ MutexGuard æ—¶ä¼šæŠ¥è­¦\n#[must_use = \"if unused the Mutex will immediately unlock\"]\npub struct MutexGuard&lt;'a, T: ?Sized + 'a&gt; {\n    lock: &amp;'a Mutex&lt;T&gt;,\n    poison: poison::Guard,\n}\n\nimpl&lt;T: ?Sized&gt; Deref for MutexGuard&lt;'_, T&gt; {\n    type Target = T;\n\n    fn deref(&amp;self) -&gt; &amp;T {\n        unsafe { &amp;*self.lock.data.get() }\n    }\n}\n\nimpl&lt;T: ?Sized&gt; DerefMut for MutexGuard&lt;'_, T&gt; {\n    fn deref_mut(&amp;mut self) -&gt; &amp;mut T {\n        unsafe { &amp;mut *self.lock.data.get() }\n    }\n}\n\nimpl&lt;T: ?Sized&gt; Drop for MutexGuard&lt;'_, T&gt; {\n    #[inline]\n    fn drop(&amp;mut self) {\n        unsafe {\n            self.lock.poison.done(&amp;self.poison);\n            self.lock.inner.raw_unlock();\n        }\n    }\n}\n</code></pre><p>ä»ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå½“ MutexGuard ç»“æŸæ—¶ï¼ŒMutex ä¼šåš unlockï¼Œè¿™æ ·ç”¨æˆ·åœ¨ä½¿ç”¨ Mutex æ—¶ï¼Œå¯ä»¥ä¸å¿…å…³å¿ƒä½•æ—¶é‡Šæ”¾è¿™ä¸ªäº’æ–¥é”ã€‚å› ä¸ºæ— è®ºä½ åœ¨è°ƒç”¨æ ˆä¸Šæ€æ ·ä¼ é€’ MutexGuard ï¼Œå“ªæ€•åœ¨é”™è¯¯å¤„ç†æµç¨‹ä¸Šæå‰é€€å‡ºï¼ŒRust æœ‰æ‰€æœ‰æƒæœºåˆ¶ï¼Œå¯ä»¥ç¡®ä¿åªè¦ MutexGuard ç¦»å¼€ä½œç”¨åŸŸï¼Œé”å°±ä¼šè¢«é‡Šæ”¾ã€‚</p><h3>ä½¿ç”¨åœºæ™¯</h3><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä½¿ç”¨ Mutex å’Œ MutexGuard çš„ä¾‹å­ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=f01427ed0a8534ade980b88791be9d5b\">ä»£ç </a>ï¼‰ï¼Œä»£ç å¾ˆç®€å•ï¼Œæˆ‘å†™äº†è¯¦å°½çš„æ³¨é‡Šå¸®åŠ©ä½ ç†è§£ã€‚</p><pre><code class=\"language-rust\">use lazy_static::lazy_static;\nuse std::borrow::Cow;\nuse std::collections::HashMap;\nuse std::sync::{Arc, Mutex};\nuse std::thread;\nuse std::time::Duration;\n\n// lazy_static å®å¯ä»¥ç”Ÿæˆå¤æ‚çš„ static å¯¹è±¡\nlazy_static! {\n    // ä¸€èˆ¬æƒ…å†µä¸‹ Mutex å’Œ Arc ä¸€èµ·åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹æä¾›å¯¹å…±äº«å†…å­˜çš„ä½¿ç”¨\n    // å¦‚æœä½ æŠŠ Mutex å£°æ˜æˆ staticï¼Œå…¶ç”Ÿå‘½å‘¨æœŸæ˜¯é™æ€çš„ï¼Œä¸éœ€è¦ Arc\n    static ref METRICS: Mutex&lt;HashMap&lt;Cow&lt;'static, str&gt;, usize&gt;&gt; =\n        Mutex::new(HashMap::new());\n}\n\nfn main() {\n    // ç”¨ Arc æ¥æä¾›å¹¶å‘ç¯å¢ƒä¸‹çš„å…±äº«æ‰€æœ‰æƒï¼ˆä½¿ç”¨å¼•ç”¨è®¡æ•°ï¼‰\n    let metrics: Arc&lt;Mutex&lt;HashMap&lt;Cow&lt;'static, str&gt;, usize&gt;&gt;&gt; =\n        Arc::new(Mutex::new(HashMap::new()));\n    for _ in 0..32 {\n        let m = metrics.clone();\n        thread::spawn(move || {\n            let mut g = m.lock().unwrap();\n            // æ­¤æ—¶åªæœ‰æ‹¿åˆ° MutexGuard çš„çº¿ç¨‹å¯ä»¥è®¿é—® HashMap\n            let data = &amp;mut *g;\n            // Cow å®ç°äº†å¾ˆå¤šæ•°æ®ç»“æ„çš„ From traitï¼Œ\n\t\t\t\t\t\t// æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨ \"hello\".into() ç”Ÿæˆ Cow\n            let entry = data.entry(\"hello\".into()).or_insert(0);\n            *entry += 1;\n\t\t\t\t\t\t// MutexGuard è¢« Dropï¼Œé”è¢«é‡Šæ”¾\n        });\n    }\n\n    thread::sleep(Duration::from_millis(100));\n\n    println!(\"metrics: {:?}\", metrics.lock().unwrap());\n}\n</code></pre><p>å¦‚æœä½ æœ‰ç–‘é—®ï¼Œè¿™æ ·å¦‚ä½•ä¿è¯é”çš„çº¿ç¨‹å®‰å…¨å‘¢ï¼Ÿå¦‚æœæˆ‘åœ¨çº¿ç¨‹ 1 æ‹¿åˆ°äº†é”ï¼Œç„¶åæŠŠ MutexGuard ç§»åŠ¨ç»™çº¿ç¨‹ 2 ä½¿ç”¨ï¼ŒåŠ é”å’Œè§£é”åœ¨å®Œå…¨ä¸åŒçš„çº¿ç¨‹ä¸‹ï¼Œä¼šæœ‰å¾ˆå¤§çš„æ­»é”é£é™©ã€‚æ€ä¹ˆåŠï¼Ÿ</p><p>ä¸è¦æ‹…å¿ƒï¼ŒMutexGuard ä¸å…è®¸ Sendï¼Œåªå…è®¸ Syncï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä½ å¯ä»¥æŠŠ MutexGuard çš„å¼•ç”¨ä¼ ç»™å¦ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ï¼Œä½†ä½ æ— æ³•æŠŠ MutexGuard æ•´ä¸ªç§»åŠ¨åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ï¼š</p><pre><code class=\"language-rust\">impl&lt;T: ?Sized&gt; !Send for MutexGuard&lt;'_, T&gt; {}\nunsafe impl&lt;T: ?Sized + Sync&gt; Sync for MutexGuard&lt;'_, T&gt; {}\n</code></pre><p>ç±»ä¼¼ MutexGuard çš„æ™ºèƒ½æŒ‡é’ˆæœ‰å¾ˆå¤šç”¨é€”ã€‚æ¯”å¦‚è¦åˆ›å»ºä¸€ä¸ªè¿æ¥æ± ï¼Œä½ å¯ä»¥åœ¨ Drop trait ä¸­ï¼Œå›æ”¶ checkout å‡ºæ¥çš„è¿æ¥ï¼Œå°†å…¶å†æ”¾å›è¿æ¥æ± ã€‚å¦‚æœä½ å¯¹æ­¤æ„Ÿå…´è¶£ï¼Œå¯ä»¥çœ‹çœ‹ <a href=\"https://github.com/sfackler/r2d2/blob/master/src/lib.rs#L611\">r2d2 çš„å®ç°</a>ï¼Œå®ƒæ˜¯ Rust ä¸‹ä¸€ä¸ªæ•°æ®åº“è¿æ¥æ± çš„å®ç°ã€‚</p><h2>å®ç°è‡ªå·±çš„æ™ºèƒ½æŒ‡é’ˆ</h2><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œä¸‰ä¸ªç»å…¸çš„æ™ºèƒ½æŒ‡é’ˆï¼Œåœ¨å †ä¸Šåˆ›å»ºå†…å­˜çš„ Box&lt;T&gt;ã€æä¾›å†™æ—¶å…‹éš†çš„ Cow&lt;'a, B&gt;ï¼Œä»¥åŠç”¨äºæ•°æ®åŠ é”çš„ MutexGuard&lt;T&gt;ï¼Œå®ƒä»¬çš„å®ç°å’Œä½¿ç”¨æ–¹æ³•å°±è®²å®Œäº†ã€‚</p><p>é‚£ä¹ˆï¼Œå¦‚æœæˆ‘ä»¬æƒ³å®ç°è‡ªå·±çš„æ™ºèƒ½æŒ‡é’ˆï¼Œè¯¥æ€ä¹ˆåšï¼Ÿæˆ–è€…å’±ä»¬æ¢ä¸ªé—®é¢˜ï¼šæœ‰ä»€ä¹ˆæ•°æ®ç»“æ„é€‚åˆå®ç°æˆä¸ºæ™ºèƒ½æŒ‡é’ˆï¼Ÿ</p><p>å› ä¸ºå¾ˆå¤šæ—¶å€™ï¼Œ<strong>æˆ‘ä»¬éœ€è¦å®ç°ä¸€äº›è‡ªåŠ¨ä¼˜åŒ–çš„æ•°æ®ç»“æ„</strong>ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹æ˜¯ä¸€ç§ä¼˜åŒ–çš„æ•°æ®ç»“æ„å’Œç›¸åº”çš„ç®—æ³•ï¼Œåœ¨å…¶ä»–æƒ…å†µä¸‹ä½¿ç”¨é€šç”¨çš„ç»“æ„å’Œé€šç”¨çš„ç®—æ³•ã€‚</p><p>æ¯”å¦‚å½“ä¸€ä¸ª HashSet çš„å†…å®¹æ¯”è¾ƒå°‘çš„æ—¶å€™ï¼Œå¯ä»¥ç”¨æ•°ç»„å®ç°ï¼Œä½†å†…å®¹é€æ¸å¢å¤šï¼Œå†è½¬æ¢æˆç”¨å“ˆå¸Œè¡¨å®ç°ã€‚å¦‚æœæˆ‘ä»¬æƒ³è®©ä½¿ç”¨è€…ä¸ç”¨å…³å¿ƒè¿™äº›å®ç°çš„ç»†èŠ‚ï¼Œä½¿ç”¨åŒæ ·çš„æ¥å£å°±èƒ½äº«å—åˆ°æ›´å¥½çš„æ€§èƒ½ï¼Œé‚£ä¹ˆï¼Œå°±å¯ä»¥è€ƒè™‘ç”¨æ™ºèƒ½æŒ‡é’ˆæ¥ç»Ÿä¸€å®ƒçš„è¡Œä¸ºã€‚</p><h3>ä½¿ç”¨å°ç»ƒä¹ </h3><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªå®é™…çš„ä¾‹å­ã€‚ä¹‹å‰è®²è¿‡ï¼ŒRust ä¸‹ String åœ¨æ ˆä¸Šå äº† 24 ä¸ªå­—èŠ‚ï¼Œç„¶ååœ¨å †ä¸Šå­˜æ”¾å­—ç¬¦ä¸²å®é™…çš„å†…å®¹ï¼Œå¯¹äºä¸€äº›æ¯”è¾ƒçŸ­çš„å­—ç¬¦ä¸²ï¼Œè¿™å¾ˆæµªè´¹å†…å­˜ã€‚æœ‰æ²¡æœ‰åŠæ³•åœ¨å­—ç¬¦ä¸²é•¿åˆ°ä¸€å®šç¨‹åº¦åï¼Œæ‰ä½¿ç”¨æ ‡å‡†çš„å­—ç¬¦ä¸²å‘¢ï¼Ÿ</p><p>å‚è€ƒ Cowï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ª enum æ¥å¤„ç†ï¼šå½“å­—ç¬¦ä¸²å°äº N å­—èŠ‚æ—¶ï¼Œæˆ‘ä»¬ç›´æ¥ç”¨æ ˆä¸Šçš„æ•°ç»„ï¼Œå¦åˆ™ï¼Œä½¿ç”¨ Stringã€‚ä½†æ˜¯è¿™ä¸ª N ä¸å®œå¤ªå¤§ï¼Œå¦åˆ™å½“ä½¿ç”¨ String æ—¶ï¼Œä¼šæ¯”ç›®å‰çš„ç‰ˆæœ¬æµªè´¹å†…å­˜ã€‚</p><p>æ€ä¹ˆè®¾è®¡å‘¢ï¼Ÿä¹‹å‰åœ¨å†…å­˜ç®¡ç†çš„éƒ¨åˆ†è®²è¿‡ï¼Œå½“ä½¿ç”¨ enum æ—¶ï¼Œé¢å¤–çš„ tag + ä¸ºäº†å¯¹é½è€Œä½¿ç”¨çš„ padding ä¼šå ç”¨ä¸€äº›å†…å­˜ã€‚å› ä¸º String ç»“æ„æ˜¯ 8 å­—èŠ‚å¯¹é½çš„ï¼Œæˆ‘ä»¬çš„ enum æœ€å° 8 + 24 = 32 ä¸ªå­—èŠ‚ã€‚</p><p>æ‰€ä»¥ï¼Œå¯ä»¥è®¾è®¡ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œ<strong>å†…éƒ¨ç”¨ä¸€ä¸ªå­—èŠ‚è¡¨ç¤ºå­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œç”¨ 30 ä¸ªå­—èŠ‚è¡¨ç¤ºå­—ç¬¦ä¸²å†…å®¹ï¼Œå†åŠ ä¸Š 1 ä¸ªå­—èŠ‚çš„ tagï¼Œæ­£å¥½ä¹Ÿæ˜¯ 32 å­—èŠ‚ï¼Œå¯ä»¥å’Œ String æ”¾åœ¨ä¸€ä¸ª enum é‡Œä½¿ç”¨</strong>ã€‚æˆ‘ä»¬æš‚ä¸”ç§°è¿™ä¸ª enum å« MyStringï¼Œå®ƒçš„ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/f4/97/f45e1f15a1448943979f93d13cdc0197.jpg?wh=2987x1677\" alt=\"\"></p><p>ä¸ºäº†è®© MyString è¡¨ç°è¡Œä¸ºå’Œ &str ä¸€è‡´ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®ç° Deref trait è®© MyString å¯ä»¥è¢«è§£å¼•ç”¨æˆ &strã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å¯ä»¥å®ç° Debug/Display å’Œ From&lt;T&gt; traitï¼Œè®© MyString ä½¿ç”¨èµ·æ¥æ›´æ–¹ä¾¿ã€‚</p><p>æ•´ä¸ªå®ç°çš„ä»£ç å¦‚ä¸‹ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=ce83a82cd66aa412e68eebf6b292a832\">ä»£ç </a>ï¼‰ï¼Œä»£ç æœ¬èº«ä¸éš¾ç†è§£ï¼Œä½ å¯ä»¥è¯•ç€è‡ªå·±å®ç°ä¸€ä¸‹ï¼Œæˆ–è€…ä¸€è¡Œè¡ŒæŠ„ä¸‹æ¥è¿è¡Œï¼Œæ„Ÿå—ä¸€ä¸‹ã€‚</p><pre><code class=\"language-rust\">use std::{fmt, ops::Deref, str};\n\nconst MINI_STRING_MAX_LEN: usize = 30;\n\n// MyString é‡Œï¼ŒString æœ‰ 3 ä¸ª wordï¼Œä¾› 24 å­—èŠ‚ï¼Œæ‰€ä»¥å®ƒä»¥ 8 å­—èŠ‚å¯¹é½\n// æ‰€ä»¥ enum çš„ tag + padding æœ€å°‘ 8 å­—èŠ‚ï¼Œæ•´ä¸ªç»“æ„å  32 å­—èŠ‚ã€‚\n// MiniString å¯ä»¥æœ€å¤šæœ‰ 30 å­—èŠ‚ï¼ˆå†åŠ ä¸Š 1 å­—èŠ‚é•¿åº¦å’Œ 1å­—èŠ‚ tagï¼‰ï¼Œå°±æ˜¯ 32 å­—èŠ‚.\nstruct MiniString {\n    len: u8,\n    data: [u8; MINI_STRING_MAX_LEN],\n}\n\nimpl MiniString {\n    // è¿™é‡Œ new æ¥å£ä¸æš´éœ²å‡ºå»ï¼Œä¿è¯ä¼ å…¥çš„ v çš„å­—èŠ‚é•¿åº¦å°äºç­‰äº 30\n    fn new(v: impl AsRef&lt;str&gt;) -&gt; Self {\n        let bytes = v.as_ref().as_bytes();\n        // æˆ‘ä»¬åœ¨æ‹·è´å†…å®¹æ—¶ä¸€å®šè¦ä½¿ç”¨å­—ç¬¦ä¸²çš„å­—èŠ‚é•¿åº¦\n        let len = bytes.len();\n        let mut data = [0u8; MINI_STRING_MAX_LEN];\n        data[..len].copy_from_slice(bytes);\n        Self {\n            len: len as u8,\n            data,\n        }\n    }\n}\n\nimpl Deref for MiniString {\n    type Target = str;\n\n    fn deref(&amp;self) -&gt; &amp;Self::Target {\n        // ç”±äºç”Ÿæˆ MiniString çš„æ¥å£æ˜¯éšè—çš„ï¼Œå®ƒåªèƒ½æ¥è‡ªå­—ç¬¦ä¸²ï¼Œæ‰€ä»¥ä¸‹é¢è¿™è¡Œæ˜¯å®‰å…¨çš„\n        str::from_utf8(&amp;self.data[..self.len as usize]).unwrap()\n        // ä¹Ÿå¯ä»¥ç›´æ¥ç”¨ unsafe ç‰ˆæœ¬\n        // unsafe { str::from_utf8_unchecked(&amp;self.data[..self.len as usize]) }\n    }\n}\n\nimpl fmt::Debug for MiniString {\n    fn fmt(&amp;self, f: &amp;mut fmt::Formatter&lt;'_&gt;) -&gt; fmt::Result {\n        // è¿™é‡Œç”±äºå®ç°äº† Deref traitï¼Œå¯ä»¥ç›´æ¥å¾—åˆ°ä¸€ä¸ª &amp;str è¾“å‡º\n        write!(f, \"{}\", self.deref())\n    }\n}\n\n#[derive(Debug)]\nenum MyString {\n    Inline(MiniString),\n    Standard(String),\n}\n\n// å®ç° Deref æ¥å£å¯¹ä¸¤ç§ä¸åŒçš„åœºæ™¯ç»Ÿä¸€å¾—åˆ° &amp;str\nimpl Deref for MyString {\n    type Target = str;\n\n    fn deref(&amp;self) -&gt; &amp;Self::Target {\n        match *self {\n            MyString::Inline(ref v) =&gt; v.deref(),\n            MyString::Standard(ref v) =&gt; v.deref(),\n        }\n    }\n}\n\nimpl From&lt;&amp;str&gt; for MyString {\n    fn from(s: &amp;str) -&gt; Self {\n        match s.len() &gt; MINI_STRING_MAX_LEN {\n            true =&gt; Self::Standard(s.to_owned()),\n            _ =&gt; Self::Inline(MiniString::new(s)),\n        }\n    }\n}\n\nimpl fmt::Display for MyString {\n    fn fmt(&amp;self, f: &amp;mut fmt::Formatter&lt;'_&gt;) -&gt; fmt::Result {\n        write!(f, \"{}\", self.deref())\n    }\n}\n\nfn main() {\n    let len1 = std::mem::size_of::&lt;MyString&gt;();\n    let len2 = std::mem::size_of::&lt;MiniString&gt;();\n    println!(\"Len: MyString {}, MiniString {}\", len1, len2);\n\n    let s1: MyString = \"hello world\".into();\n    let s2: MyString = \"è¿™æ˜¯ä¸€ä¸ªè¶…è¿‡äº†ä¸‰åä¸ªå­—èŠ‚çš„å¾ˆé•¿å¾ˆé•¿çš„å­—ç¬¦ä¸²\".into();\n\n    // debug è¾“å‡º\n    println!(\"s1: {:?}, s2: {:?}\", s1, s2);\n    // display è¾“å‡º\n    println!(\n        \"s1: {}({} bytes, {} chars), s2: {}({} bytes, {} chars)\",\n        s1,\n        s1.len(),\n        s1.chars().count(),\n        s2,\n        s2.len(),\n        s2.chars().count()\n    );\n\n    // MyString å¯ä»¥ä½¿ç”¨ä¸€åˆ‡ &amp;str æ¥å£ï¼Œæ„Ÿè°¢ Rust çš„è‡ªåŠ¨ Deref\n    assert!(s1.ends_with(\"world\"));\n    assert!(s2.starts_with(\"è¿™\"));\n}\n</code></pre><p>è¿™ä¸ªç®€å•å®ç°çš„ MyStringï¼Œä¸ç®¡å®ƒå†…éƒ¨çš„æ•°æ®æ˜¯çº¯æ ˆä¸Šçš„ MiniString ç‰ˆæœ¬ï¼Œè¿˜æ˜¯åŒ…å«å †ä¸Šå†…å­˜çš„ String ç‰ˆæœ¬ï¼Œä½¿ç”¨çš„ä½“éªŒå’Œ &amp;str éƒ½ä¸€è‡´ï¼Œä»…ä»…ç‰ºç‰²äº†ä¸€ç‚¹ç‚¹æ•ˆç‡å’Œå†…å­˜ï¼Œå°±å¯ä»¥è®©å°å®¹é‡çš„å­—ç¬¦ä¸²ï¼Œå¯ä»¥é«˜æ•ˆåœ°å­˜å‚¨åœ¨æ ˆä¸Šå¹¶ä¸”è‡ªå¦‚åœ°ä½¿ç”¨ã€‚</p><p>äº‹å®ä¸Šï¼ŒRust æœ‰ä¸ªå« smartstring çš„ç¬¬ä¸‰æ–¹åº“å°±å®ç°äº†è¿™ä¸ªåŠŸèƒ½ã€‚æˆ‘ä»¬çš„ç‰ˆæœ¬åœ¨å†…å­˜ä¸Šä¸ç®—ç»æµï¼Œå¯¹äº String æ¥è¯´ï¼Œé¢å¤–å¤šç”¨äº† 8 ä¸ªå­—èŠ‚ï¼Œsmartstring é€šè¿‡ä¼˜åŒ–ï¼Œåªç”¨äº†å’Œ String ç»“æ„ä¸€æ ·å¤§å°çš„ 24 ä¸ªå­—èŠ‚ï¼Œå°±è¾¾åˆ°äº†æˆ‘ä»¬æƒ³è¦çš„ç»“æœã€‚ä½ å¦‚æœæ„Ÿå…´è¶£çš„è¯ï¼Œæ¬¢è¿å»çœ‹çœ‹å®ƒçš„<a href=\"https://github.com/bodil/smartstring\">æºä»£ç </a>ã€‚</p><h2>å°ç»“</h2><p>ä»Šå¤©æˆ‘ä»¬ä»‹ç»äº†ä¸‰ä¸ªé‡è¦çš„æ™ºèƒ½æŒ‡é’ˆï¼Œå®ƒä»¬æœ‰å„è‡ªç‹¬ç‰¹çš„å®ç°æ–¹å¼å’Œä½¿ç”¨åœºæ™¯ã€‚</p><p>Box&lt;T&gt; å¯ä»¥åœ¨å †ä¸Šåˆ›å»ºå†…å­˜ï¼Œæ˜¯å¾ˆå¤šå…¶ä»–æ•°æ®ç»“æ„çš„åŸºç¡€ã€‚</p><p>Cow å®ç°äº† Clone-on-write çš„æ•°æ®ç»“æ„ï¼Œè®©ä½ å¯ä»¥åœ¨éœ€è¦çš„æ—¶å€™å†è·å¾—æ•°æ®çš„æ‰€æœ‰æƒã€‚Cow ç»“æ„æ˜¯ä¸€ç§ä½¿ç”¨ enum æ ¹æ®å½“å‰çš„çŠ¶æ€è¿›è¡Œåˆ†å‘çš„ç»å…¸æ–¹æ¡ˆã€‚ç”šè‡³ï¼Œä½ å¯ä»¥ç”¨ç±»ä¼¼çš„æ–¹æ¡ˆå–ä»£ trait object åšåŠ¨æ€åˆ†å‘ï¼Œ<a href=\"https://gitlab.com/antonok/enum_dispatch\">å…¶æ•ˆç‡æ˜¯åŠ¨æ€åˆ†å‘çš„æ•°åå€</a>ã€‚</p><p>å¦‚æœä½ æƒ³åˆç†åœ°å¤„ç†èµ„æºç›¸å…³çš„ç®¡ç†ï¼ŒMutexGuard æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å‚è€ƒï¼Œå®ƒæŠŠä» Mutex ä¸­è·å¾—çš„é”åŒ…è£…èµ·æ¥ï¼Œå®ç°åªè¦ MutexGuard é€€å‡ºä½œç”¨åŸŸï¼Œé”å°±ä¸€å®šä¼šé‡Šæ”¾ã€‚å¦‚æœä½ è¦åšèµ„æºæ± ï¼Œå¯ä»¥ä½¿ç”¨ç±»ä¼¼ MutexGuard çš„æ–¹å¼ã€‚</p><h2>æ€è€ƒé¢˜</h2><ol>\n<li>ç›®å‰ MyString åªèƒ½ä» &amp;str ç”Ÿæˆã€‚å¦‚æœè¦æ”¯æŒä» String ä¸­ç”Ÿæˆä¸€ä¸ª MyStringï¼Œè¯¥æ€ä¹ˆåšï¼Ÿ</li>\n<li>ç›®å‰ MyString åªèƒ½è¯»å–ï¼Œä¸èƒ½ä¿®æ”¹ï¼Œèƒ½ä¸èƒ½ç»™å®ƒåŠ ä¸Šç±»ä¼¼ String çš„ <a href=\"https://doc.rust-lang.org/std/string/struct.String.html#method.push_str\">push_str</a> æ¥å£ï¼Ÿ</li>\n<li>ä½ çŸ¥é“ Cow&lt;[u8]&gt; å’Œ Cow&lt;str&gt; çš„å¤§å°ä¹ˆï¼Ÿè¯•ç€æ‰“å°ä¸€ä¸‹çœ‹çœ‹ã€‚æƒ³æƒ³ï¼Œä¸ºä»€ä¹ˆå®ƒçš„å¤§å°æ˜¯è¿™æ ·å‘¢ï¼Ÿ</li>\n</ol><p>æ¬¢è¿åœ¨ç•™è¨€åŒºåˆ†äº«ä½ çš„æ€è€ƒã€‚ä»Šå¤©ä½ å·²ç»å®ŒæˆRustå­¦ä¹ ç¬¬15æ¬¡æ‰“å¡äº†ï¼Œç»§ç»­åŠ æ²¹ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ï½</p><h2>å‚è€ƒèµ„æ–™</h2><p>å¸¸è§çš„é€šç”¨å†…å­˜åˆ†é…å™¨æœ‰ glibc çš„ <a href=\"http://www.malloc.de/en/\">pthread malloc</a>ã€Google å¼€å‘çš„ <a href=\"https://github.com/google/tcmalloc\">tcmalloc</a>ã€FreeBSD ä¸Šé»˜è®¤ä½¿ç”¨çš„ <a href=\"https://github.com/jemalloc/jemalloc\">jemalloc</a> ç­‰ã€‚é™¤äº†é€šç”¨å†…å­˜åˆ†é…å™¨ï¼Œå¯¹äºç‰¹å®šç±»å‹å†…å­˜çš„åˆ†é…ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ç”¨ <a href=\"https://en.wikipedia.org/wiki/Slab_allocation\">slab</a>ï¼Œslab ç›¸å½“äºä¸€ä¸ªé¢„åˆ†é…å¥½çš„å¯¹è±¡æ± ï¼Œå¯ä»¥æ‰©å±•å’Œæ”¶ç¼©ã€‚</p>","neighbors":{"left":{"article_title":"14ï½œç±»å‹ç³»ç»Ÿï¼šæœ‰å“ªäº›å¿…é¡»æŒæ¡çš„traitï¼Ÿ","id":421324},"right":{"article_title":"16ï½œæ•°æ®ç»“æ„ï¼šVec<T>ã€&[T]ã€Box<[T]> ï¼Œä½ çœŸçš„äº†è§£é›†åˆå®¹å™¨ä¹ˆï¼Ÿ","id":422975}},"comments":[{"had_liked":false,"id":313841,"user_name":"GengTeng","can_delete":false,"product_type":"c1","uid":1224623,"ip_address":"","ucode":"3F926F5EF1D075","user_header":"https://static001.geekbang.org/account/avatar/00/12/af/af/8b03ce2c.jpg","comment_is_top":false,"comment_ctime":1632707685,"is_pvip":false,"replies":[{"id":"113740","content":"éå¸¸æ£’ï¼ç¬¬ 1 é¢˜è¿˜å¯ä»¥ç”¨æ³›å‹å‚æ•°è¿›ä¸€æ­¥ç»Ÿä¸€ String&#47;&amp;strï¼ŒDRYï¼š<br><br>```Rust<br>impl&lt;T&gt; From&lt;T&gt; for MyString<br>where<br>    T: AsRef&lt;str&gt; + Into&lt;String&gt;,<br>{<br>    fn from(s: T) -&gt; Self {<br>        match s.as_ref().len() &gt; MINI_STRING_MAX_LEN {<br>            true =&gt; Self::Standard(s.into()),<br>            _ =&gt; Self::Inline(MiniString::new(s)),<br>        }<br>    }<br>}<br>```","user_name":"ä½œè€…å›å¤","comment_id":313841,"uid":"1079375","ip_address":"","utype":1,"ctime":1632798664,"user_name_real":"Tyr"}],"discussion_count":2,"race_medal":0,"score":"66057217125","product_id":100085301,"comment_content":"1.<br>impl From&lt;String&gt; for MyString {<br>    fn from(s: String) -&gt; Self {<br>        if s.len() &gt; MINI_STRING_MAX_LEN {<br>            Self::Standard(s)<br>        } else {<br>            Self::Inline(MiniString::new(s))<br>        }<br>    }<br>}<br>2.<br>impl MyString {<br>    fn push_str(&amp;mut self, string: &amp;str) {<br>        match self {<br>            MyString::Inline(m) =&gt; {<br>                let l = m.len();<br>                let len = l + string.len();<br>                if len &gt; MINI_STRING_MAX_LEN {<br>                    *self = Self::Standard(m.to_string() + string);<br>                } else {<br>                    m.data[l..].copy_from_slice(string.as_bytes());<br>                    m.len = len as u8;<br>                }<br>            }<br>            MyString::Standard(s) =&gt; s.push_str(string),<br>        }<br>    }<br>}<br>3. 32 32<br>Cow&lt;&#39;a, B&gt; è¦æ±‚ B å®ç° ToOwnedï¼Œå…¶Ownedå˜ä½“çš„æ•°æ®ä¸º å¯¹åº”çš„ Owned ç±»å‹ï¼Œå³ [T] å¯¹åº”çš„æ˜¯ Vec&lt;T&gt;ï¼Œ str å¯¹åº”çš„æ˜¯ Stringï¼Œè¿™ä¸¤ä¸ªçš„å¤§å°éƒ½æ˜¯24å­—èŠ‚ï¼ŒåŠ ä¸Šæšä¸¾å ç”¨çš„ä¸€å­—èŠ‚ä»¥åŠ8å­—èŠ‚å¯¹é½ï¼Œå°±æ˜¯32å­—èŠ‚ã€‚<br>","like_count":16,"discussions":[{"author":{"id":1078927,"avatar":"","nickname":"linuxfish","note":"","ucode":"557F21A1CC7EAD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":401549,"discussion_content":"ç¬¬äºŒé¢˜æœ‰ç‚¹é—®é¢˜ï¼š\n\n m.data[l..].copy_from_slice(string.as_bytes()); åº”è¯¥æ”¹æˆï¼š\n\n m.data[l..len].copy_from_slice(string.as_bytes());\n\ncopy_from_slice éœ€è¦ä¸¤ä¸ªsliceçš„é•¿åº¦ä¸€è‡´ï¼Œå¦åˆ™ä¼španic","likes_number":6,"is_delete":false,"is_hidden":false,"ctime":1633690669,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527488,"discussion_content":"éå¸¸æ£’ï¼ç¬¬ 1 é¢˜è¿˜å¯ä»¥ç”¨æ³›å‹å‚æ•°è¿›ä¸€æ­¥ç»Ÿä¸€ String/&amp;amp;strï¼ŒDRYï¼š\n\n```Rust\nimpl&amp;lt;T&amp;gt; From&amp;lt;T&amp;gt; for MyString\nwhere\n    T: AsRef&amp;lt;str&amp;gt; + Into&amp;lt;String&amp;gt;,\n{\n    fn from(s: T) -&amp;gt; Self {\n        match s.as_ref().len() &amp;gt; MINI_STRING_MAX_LEN {\n            true =&amp;gt; Self::Standard(s.into()),\n            _ =&amp;gt; Self::Inline(MiniString::new(s)),\n        }\n    }\n}\n```","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1632798664,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":315669,"user_name":"Lucas","can_delete":false,"product_type":"c1","uid":1457955,"ip_address":"","ucode":"A81F5ECB369A7A","user_header":"https://static001.geekbang.org/account/avatar/00/16/3f/23/3ea59027.jpg","comment_is_top":false,"comment_ctime":1633940943,"is_pvip":false,"replies":[{"id":"115292","content":"åŠ æ²¹ï¼å¯¹æš‚æ—¶ç†è§£ä¸äº†çš„åœ°æ–¹ï¼Œå¯ä»¥å…ˆè·³è¿‡ï¼Œä¹‹åå†å›æ¥é˜…è¯»","user_name":"ä½œè€…å›å¤","comment_id":315669,"uid":"1079375","ip_address":"","utype":1,"ctime":1635132990,"user_name_real":"Tyr"}],"discussion_count":3,"race_medal":0,"score":"27403744719","product_id":100085301,"comment_content":"è·Ÿä¸ä¸Šäº† çœ‹ä¸æ‡‚äº†ğŸ˜­","like_count":6,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":528142,"discussion_content":"åŠ æ²¹ï¼å¯¹æš‚æ—¶ç†è§£ä¸äº†çš„åœ°æ–¹ï¼Œå¯ä»¥å…ˆè·³è¿‡ï¼Œä¹‹åå†å›æ¥é˜…è¯»","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635132990,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2101988,"avatar":"https://static001.geekbang.org/account/avatar/00/20/12/e4/57ade29a.jpg","nickname":"dva","note":"","ucode":"EE27DAFCBF198D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":411447,"discussion_content":"è€å“¥åŠ æ²¹æ’’ï¼Œä¸è¦åœä¸‹æ¥ï¼Œæˆ‘çœ‹ä½ åŠ¨æ€éƒ½åœå¥½ä¹…äº†ï¼Œçœ‹ä¸æ‡‚çš„å¤šçœ‹å‡ éæ…¢æ…¢ç†è§£ï¼Œæˆ‘å°±æ˜¯è¿™æ ·ã€‚æƒ³ä¸€æƒ³rustçš„è¿‡å±±è½¦ä¼¼çš„å­¦ä¹ æ›²çº¿ï¼ŒæŸ³æš—èŠ±æ˜åˆä¸€æ‘ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1635930877,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2905523,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIDqHQQByGiaXcAk94MdDn3ftupZLXyR6bAKibxOzMxy5h3uBwZ7QiaCiaIfbCMK0cIQfGNax8iawoiaQAg/132","nickname":"nuan","note":"","ucode":"55FF98EB85404D","race_medal":5,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":550120,"discussion_content":"æˆ‘ä¹Ÿæ˜¯è·Ÿä¸ä¸Šï¼Œ20åˆ†é’Ÿçš„è¯¾è‡³å°‘è¦å­¦2å°æ—¶ï¼åˆ°å¤„æ˜¯æ–°æ¦‚å¿µï¼Œæ–°å‡½æ•°ï¼Œæ–°è¯­æ³•ï¼ŒğŸ˜µ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644390776,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":313921,"user_name":"è®°äº‹æœ¬","can_delete":false,"product_type":"c1","uid":1401568,"ip_address":"","ucode":"FA942636EE0CC8","user_header":"https://static001.geekbang.org/account/avatar/00/15/62/e0/d2ff52da.jpg","comment_is_top":false,"comment_ctime":1632741629,"is_pvip":false,"replies":[{"id":"113733","content":"as æ˜¯ Rust çš„å…³é”®å­—ï¼Œç”¨äºåšç±»å‹è½¬æ¢ï¼Œæ¯”å¦‚ï¼š<br>let i = 1; &#47;&#47; i32<br>let u = i as usize; &#47;&#47; usize<br><br>è¿™é‡Œ B æœ‰çº¦æŸæ˜¯ B: ToOwnedï¼Œæ‰€ä»¥ B as ToOwned æ˜¯æˆç«‹çš„ï¼Œç›¸å½“äºæŠŠ B è½¬æ¢æˆ ToOwnedï¼Œç„¶åå› ä¸º ToOwned å¸¦æœ‰å…³è”ç±»å‹ï¼Œæ‰€ä»¥å¼ºåˆ¶è½¬æ¢æˆ ToOwend åï¼Œå¼•ç”¨å®ƒçš„å…³è”ç±»å‹ Ownedã€‚","user_name":"ä½œè€…å›å¤","comment_id":313921,"uid":"1079375","ip_address":"","utype":1,"ctime":1632797806,"user_name_real":"Tyr"}],"discussion_count":1,"race_medal":0,"score":"14517643517","product_id":100085301,"comment_content":"Owned(&lt;B as ToOwned&gt;::Owned)  æ³›å‹Bè½¬æ¢ç‰¹å¾åç§°æ˜¯ä¸ªä»€ä¹ˆæ ·çš„è¯­æ³•ï¼Œè€å¸ˆ","like_count":3,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527519,"discussion_content":"as æ˜¯ Rust çš„å…³é”®å­—ï¼Œç”¨äºåšç±»å‹è½¬æ¢ï¼Œæ¯”å¦‚ï¼š\nlet i = 1; // i32\nlet u = i as usize; // usize\n\nè¿™é‡Œ B æœ‰çº¦æŸæ˜¯ B: ToOwnedï¼Œæ‰€ä»¥ B as ToOwned æ˜¯æˆç«‹çš„ï¼Œç›¸å½“äºæŠŠ B è½¬æ¢æˆ ToOwnedï¼Œç„¶åå› ä¸º ToOwned å¸¦æœ‰å…³è”ç±»å‹ï¼Œæ‰€ä»¥å¼ºåˆ¶è½¬æ¢æˆ ToOwend åï¼Œå¼•ç”¨å®ƒçš„å…³è”ç±»å‹ Ownedã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1632797806,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":324848,"user_name":"æ ¸æ¡ƒ","can_delete":false,"product_type":"c1","uid":1385204,"ip_address":"","ucode":"7AB05270CBCCCB","user_header":"https://static001.geekbang.org/account/avatar/00/15/22/f4/9fd6f8f0.jpg","comment_is_top":false,"comment_ctime":1638684513,"is_pvip":false,"replies":[{"id":"118857","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","comment_id":324848,"uid":"1079375","ip_address":"","utype":1,"ctime":1639848114,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"10228619105","product_id":100085301,"comment_content":"å…³äºæ‰€æœ‰æƒå’Œæ™ºèƒ½æŒ‡é’ˆçš„ç†è§£ï¼Œå¯ä»¥çœ‹çœ‹è¿™ç¯‡æ–‡ç« <br>https:&#47;&#47;zhuanlan.zhihu.com&#47;p&#47;54078587<br>è¿™äº›æ¦‚å¿µåœ¨c++é‡Œé¢éƒ½æ˜¯æœ‰çš„ï¼Œå› æ­¤ä»c++çš„è§’åº¦å»ç†è§£ä¸€ä¸‹æ™ºèƒ½æŒ‡é’ˆä¸æ™®é€šæŒ‡é’ˆåŒºåˆ«ï¼Œä»€ä¹ˆæ˜¯ç§»åŠ¨è¯­ä¹‰ï¼Œé‚£æ ·è¿”å›æ¥çœ‹rustçš„æ¦‚å¿µï¼Œå°±æ˜ç™½æ¸…æ™°å¾ˆå¤šäº†ã€‚","like_count":2,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539817,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639848114,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":316540,"user_name":"è®°äº‹æœ¬","can_delete":false,"product_type":"c1","uid":1401568,"ip_address":"","ucode":"FA942636EE0CC8","user_header":"https://static001.geekbang.org/account/avatar/00/15/62/e0/d2ff52da.jpg","comment_is_top":false,"comment_ctime":1634375037,"is_pvip":false,"replies":[{"id":"114688","content":"å¯¹çš„ã€‚","user_name":"ä½œè€…å›å¤","comment_id":316540,"uid":"1079375","ip_address":"","utype":1,"ctime":1634539963,"user_name_real":"Tyr"}],"discussion_count":1,"race_medal":0,"score":"10224309629","product_id":100085301,"comment_content":"Stringåœ¨å †ä¸Šåˆ†é…å†…å­˜,Stringæ˜¯æ ˆä¸Šçš„ä¸€ä¸ªç»“æ„ä½“,å‡å¦‚Box::new(String),æ˜¯ä¸æ˜¯Stringç»“æ„ä½“ä¹Ÿåœ¨å †ä¸Šäº†","like_count":2,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":528405,"discussion_content":"å¯¹çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634539963,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":328110,"user_name":"Mr_æå†²","can_delete":false,"product_type":"c1","uid":1631606,"ip_address":"","ucode":"61FAF80BA5FB0B","user_header":"https://static001.geekbang.org/account/avatar/00/18/e5/76/5d0b66aa.jpg","comment_is_top":false,"comment_ctime":1640533563,"is_pvip":true,"replies":[{"id":"120783","content":"å¤šè°¢æŒ‡æ­£ï¼ä¼°è®¡æ˜¯ä»£ç ç²˜åˆ°æ–‡æ¡£ä¸­çš„é—®é¢˜ï¼Œæˆ‘è®©ç¼–è¾‘ä¿®æ”¹äº†ã€‚github ä¸Šçš„ä»£ç æ˜¯æ­£ç¡®çš„ã€‚","user_name":"ä½œè€…å›å¤","comment_id":328110,"uid":"1079375","ip_address":"","utype":1,"ctime":1642309861,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"5935500859","product_id":100085301,"comment_content":"æ–‡ä¸­Cowéƒ¨åˆ†ç¤ºä¾‹æ®µUrl::parseæœ‰ä¸ªbugï¼Œurlå·¦å³ä¸¤è¾¹å„æœ‰ä¸ªå°–æ‹¬å·ï¼Œéœ€è¦å»æ‰ï¼Œå¦åˆ™ä¼šè§£æurlå¤±è´¥ï¼Œunwrapåå¯¼è‡´ç¨‹åºå´©æºƒã€‚<br>æ›´æ­£åæ˜¯ä¸‹é¢è¿™ä¸ªï¼š<br>let url = Url::parse(&quot;https:&#47;&#47;tyr.com&#47;rust?page=1024&amp;sort=desc&amp;extra=hello%20world&quot;).unwrap();","like_count":1,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546422,"discussion_content":"å¤šè°¢æŒ‡æ­£ï¼ä¼°è®¡æ˜¯ä»£ç ç²˜åˆ°æ–‡æ¡£ä¸­çš„é—®é¢˜ï¼Œæˆ‘è®©ç¼–è¾‘ä¿®æ”¹äº†ã€‚github ä¸Šçš„ä»£ç æ˜¯æ­£ç¡®çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642309861,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":323940,"user_name":"yg","can_delete":false,"product_type":"c1","uid":1136892,"ip_address":"","ucode":"0CFC91CA3F93EB","user_header":"https://static001.geekbang.org/account/avatar/00/11/58/fc/c3be5d8b.jpg","comment_is_top":false,"comment_ctime":1638235300,"is_pvip":true,"replies":[{"id":"118875","content":"å¯ä»¥å‚è€ƒï¼šhttps:&#47;&#47;github.com&#47;Rust-for-Linux&#47;linux&#47;tree&#47;rust&#47;Documentation&#47;rust","user_name":"ä½œè€…å›å¤","comment_id":323940,"uid":"1079375","ip_address":"","utype":1,"ctime":1639849573,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"5933202596","product_id":100085301,"comment_content":"é™ˆè€å¸ˆæ‚¨å¥½ï¼Œç”¨rustç¼–å†™å†…æ ¸æ¨¡å—çš„è¯ï¼Œå“ªé‡Œæœ‰èµ„æ–™å¯ä»¥å‚è€ƒä¹ˆ","like_count":1,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539836,"discussion_content":"å¯ä»¥å‚è€ƒï¼šhttps://github.com/Rust-for-Linux/linux/tree/rust/Documentation/rust","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639849573,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":320335,"user_name":"Ryan","can_delete":false,"product_type":"c1","uid":1053460,"ip_address":"","ucode":"11155E0BD72A14","user_header":"https://static001.geekbang.org/account/avatar/00/10/13/14/e5a80f4b.jpg","comment_is_top":false,"comment_ctime":1636262921,"is_pvip":false,"replies":[{"id":"116339","content":"æ…¢æ…¢æ¥ï¼Œåˆ«æ€¥","user_name":"ä½œè€…å›å¤","comment_id":320335,"uid":"1079375","ip_address":"","utype":1,"ctime":1636524514,"user_name_real":"Tyr"}],"discussion_count":1,"race_medal":0,"score":"5931230217","product_id":100085301,"comment_content":"æˆ‘æ„Ÿè§‰è¿™è¯¾ç¨‹å¾—è‡³å°‘åˆ·3éæ‰èƒ½çœ‹æ‡‚ï¼Œå·²ç»è·Ÿä¸ä¸Šäº†ã€‚ã€‚ã€‚","like_count":1,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":529961,"discussion_content":"æ…¢æ…¢æ¥ï¼Œåˆ«æ€¥","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1636524514,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":319107,"user_name":"Ryan","can_delete":false,"product_type":"c1","uid":2739803,"ip_address":"","ucode":"026C66ED684E00","user_header":"","comment_is_top":false,"comment_ctime":1635587931,"is_pvip":false,"replies":[{"id":"116574","content":"åœ¨çº¿ç¨‹é—´ä¼ é€’æ ˆä¸Šçš„æœ‰æ‰€æœ‰æƒçš„æ•°æ®ä¼š moveï¼Œæ‰€ä»¥ä¸ä¼šæœ‰é—®é¢˜ã€‚","user_name":"ä½œè€…å›å¤","comment_id":319107,"uid":"1079375","ip_address":"","utype":1,"ctime":1636641726,"user_name_real":"Tyr"}],"discussion_count":1,"race_medal":0,"score":"5930555227","product_id":100085301,"comment_content":"è¿™æ ·å®ç°å‡ºæ¥çš„MyStringå¦‚æœä¼ é€’ç»™å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œå†…éƒ¨æ ˆä¸Šçš„å†…å­˜å¯èƒ½è¢«é‡Šæ”¾äº†ã€‚è¿™æ–¹é¢ä¸æ ‡å‡†Stringçš„åŒºåˆ«æ˜¯å¦‚ä½•ä½“ç°å¹¶åŠ ä»¥ä¿è¯çš„å‘¢ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":529502,"discussion_content":"åœ¨çº¿ç¨‹é—´ä¼ é€’æ ˆä¸Šçš„æœ‰æ‰€æœ‰æƒçš„æ•°æ®ä¼š moveï¼Œæ‰€ä»¥ä¸ä¼šæœ‰é—®é¢˜ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1636641726,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":313869,"user_name":"Marvichov","can_delete":false,"product_type":"c1","uid":1111835,"ip_address":"","ucode":"7482099415C41C","user_header":"https://static001.geekbang.org/account/avatar/00/10/f7/1b/db7a0edc.jpg","comment_is_top":false,"comment_ctime":1632724489,"is_pvip":false,"replies":[{"id":"113737","content":"æ­£ç¡®ï¼<br><br>ç¬¬äºŒé¢˜å¯ä»¥ä½¿ç”¨ copy_from_slice è®©ä»£ç æ›´ç®€æ´ä¸€äº›ï¼š<br><br>```rust<br>impl MyString {<br>    pub fn push_str(&amp;mut self, s: &amp;str) {<br>        match *self {<br>            MyString::Inline(ref mut v) =&gt; {<br>                let len = v.len as usize;<br>                let len1 = s.len();<br>                if len + len1 &gt; MINI_STRING_MAX_LEN {<br>                    let mut owned = v.deref().to_string();<br>                    owned.push_str(s);<br>                    *self = MyString::Standard(owned);<br>                } else {<br>                    let total = len + len1;<br>                    v.data[len..len + len1].copy_from_slice(s.as_bytes());<br>                    v.len = total as u8;<br>                }<br>            }<br>            MyString::Standard(ref mut v) =&gt; v.push_str(s),<br>        }<br>    }<br>}<br>```<br><br>å®Œæ•´ä»£ç ï¼šhttps:&#47;&#47;play.rust-lang.org&#47;?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=8066bd343bd142369fb327d7877db814","user_name":"ä½œè€…å›å¤","comment_id":313869,"uid":"1079375","ip_address":"","utype":1,"ctime":1632798427,"user_name_real":"Tyr"}],"discussion_count":2,"race_medal":0,"score":"5927691785","product_id":100085301,"comment_content":"Cow and ToOwnedä¸€ç›´åœ¨æˆ‘çš„todo listé‡Œé¢åƒç°, æ„Ÿè°¢è€å¸ˆè¿™ä¹ˆæ¸…æ™°çš„è®²è§£, è®©å®ƒä»¬å‡ºæ¥æ”¾é£ä¹‹åç»§ç»­å›å»èººç°...<br><br>1-3çš„ä»£ç  https:&#47;&#47;play.rust-lang.org&#47;?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=4e790189feaa66f784e60aa614931a13<br><br>1. <br>    impl From&lt;String&gt; for MyString {<br>        fn from(s: String) -&gt; Self {<br>            if s.len() &gt; MINI_STRING_MAX_LEN {<br>                Self::Standard(s)<br>            } else {<br>                Self::Inline(MiniString::new(s))<br>            }<br>        }<br>    }<br><br>2.<br><br>    impl MyString {<br>        pub fn push_str(&amp;mut self, string: &amp;str) {<br>            match self {<br>                Self::Inline(s) =&gt; {<br>                    if s.len as usize + string.len() &lt;= MINI_STRING_MAX_LEN {<br>                        let bytes = string.as_bytes();<br>                        let offset = s.len as usize;<br>                        for ii in 0..bytes.len() {<br>                            s.data[offset + ii] = bytes[ii];<br>                        }<br>                        s.len += bytes.len() as u8;<br>                    } else {<br>                        let mut ss = String::with_capacity(s.len() as usize + string.len());<br>                        &#47;&#47; ä½¿ç”¨ from_utf8_unchecked ç‰ˆæœ¬çš„ deref<br>                        ss.push_str(s);<br>                        ss.push_str(string);<br>                        *self = MyString::from(ss);<br>                    }<br>                }<br>                Self::Standard(s) =&gt; {<br>                    s.push_str(string);<br>                }<br>            }<br>        }<br>    }<br>    <br>3. 32; str å¯¹åº”çš„ ownedæ˜¯String, 24 bytes. &amp;stræ˜¯fat ptr, 16 bytes; tag 1ä¸€ä¸ªå­—èŠ‚, ç„¶è€ŒStringçš„alignmentæ˜¯8, tagéœ€è¦å¯¹é½, äºæ˜¯åŠ ä¸Š7ä¸ªpadding; `[u8]` åŒç†","like_count":1,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527498,"discussion_content":"æ­£ç¡®ï¼\n\nç¬¬äºŒé¢˜å¯ä»¥ä½¿ç”¨ copy_from_slice è®©ä»£ç æ›´ç®€æ´ä¸€äº›ï¼š\n\n```rust\nimpl MyString {\n    pub fn push_str(&amp;amp;mut self, s: &amp;amp;str) {\n        match *self {\n            MyString::Inline(ref mut v) =&amp;gt; {\n                let len = v.len as usize;\n                let len1 = s.len();\n                if len + len1 &amp;gt; MINI_STRING_MAX_LEN {\n                    let mut owned = v.deref().to_string();\n                    owned.push_str(s);\n                    *self = MyString::Standard(owned);\n                } else {\n                    let total = len + len1;\n                    v.data[len..len + len1].copy_from_slice(s.as_bytes());\n                    v.len = total as u8;\n                }\n            }\n            MyString::Standard(ref mut v) =&amp;gt; v.push_str(s),\n        }\n    }\n}\n```\n\nå®Œæ•´ä»£ç ï¼šhttps://play.rust-lang.org/?version=stable&amp;amp;mode=debug&amp;amp;edition=2018&amp;amp;gist=8066bd343bd142369fb327d7877db814","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632798427,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1111835,"avatar":"https://static001.geekbang.org/account/avatar/00/10/f7/1b/db7a0edc.jpg","nickname":"Marvichov","note":"","ucode":"7482099415C41C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":398482,"discussion_content":"æ„Ÿè°¢è€å¸ˆ,  ç¡®å®!\n\næ„Ÿè§‰è¿˜æ˜¯éœ€è¦å…ˆreserve capacity. å› ä¸ºownedå¯èƒ½ä¼šallocate new memory after push_str\n\n```\n                    let mut owned = v.deref().to_string();\n                    owned.push_str(s);   // might reallocate\n                    *self = MyString::Standard(owned);\n```","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632799267,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":313814,"user_name":"qinsi","can_delete":false,"product_type":"c1","uid":1667175,"ip_address":"","ucode":"090D9C4068FF12","user_header":"https://static001.geekbang.org/account/avatar/00/19/70/67/0c1359c2.jpg","comment_is_top":false,"comment_ctime":1632696881,"is_pvip":true,"replies":[{"id":"113719","content":"å¯¹ï¼Œæ‰€ä»¥å®ƒä½¿ç”¨äº† drop æ¥å£ï¼Œå…·ä½“æ€ä¹ˆå®ç°ç°åœ¨æ˜¯ç”±ç¼–è¯‘å™¨è‡ªåŠ¨æ’å…¥ï¼Œæœªæ¥å¯èƒ½æœ‰å…¶å®ƒæ›´å…·ä½“çš„å®ç°ã€‚ä¸è¿‡æ€ä¹ˆå®ç°ï¼Œåªè¦æ˜¯ç”¨äº† drop æ¥å£ï¼Œå¯¹ç”¨æˆ·ä»£ç æ¥è¯´ä¸å—å½±å“ã€‚","user_name":"ä½œè€…å›å¤","comment_id":313814,"uid":"1079375","ip_address":"","utype":1,"ctime":1632796171,"user_name_real":"Tyr"}],"discussion_count":1,"race_medal":0,"score":"5927664177","product_id":100085301,"comment_content":"æœ‰ä¸ªå°ç–‘é—®ï¼šä¸ºä»€ä¹ˆè¯´Box&lt;T&gt;çš„Drop traitç”±ç¼–è¯‘å™¨å®ç°æ˜¯ä¸ºäº†ç¨³å®šæ¥å£ï¼Ÿåªè¦æ¥å£ç¡®å®šäº†ï¼Œæ¥å£çš„å®ç°æ€ä¹ˆæ¢å¯¹äºä½¿ç”¨è€…æ¥è¯´éƒ½æ— æ‰€è°“å§ï¼ŸçŒœæµ‹ä¼šä¸ä¼šæ˜¯ä¸ºäº†å®ç°ä¸Šçš„æ•ˆç‡ç›´æ¥ç”Ÿæˆæ±‡ç¼–ï¼Œè€Œæ±‡ç¼–æ˜¯unstableçš„ï¼Œæ— æ³•é€šè¿‡stableç¼–è¯‘ï¼Œæ‰€ä»¥åªèƒ½å…ˆæ”¾åœ¨ç¼–è¯‘å™¨é‡Œäº†ï¼Ÿä»è¿™ä¸ªè§’åº¦æ¥çœ‹çš„è¯ï¼Œå…¶å®è¦ç¨³å®šçš„ä¸æ˜¯Drop traitï¼Œè€Œæ˜¯ä»£ç å†…åµŒæ±‡ç¼–è¿™ä¸ªfeature?<br><br>(å…¶å®ä¸»è¦æ˜¯çœ‹åˆ°pythonè¢«æ‹¿å‡ºæ¥è¯´äº‹æœ‰ç‚¹ä¸å¼€å¿ƒï¼ŒæŠ¬ä¸ªæ  ;-ï¼‰","like_count":1,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527479,"discussion_content":"å¯¹ï¼Œæ‰€ä»¥å®ƒä½¿ç”¨äº† drop æ¥å£ï¼Œå…·ä½“æ€ä¹ˆå®ç°ç°åœ¨æ˜¯ç”±ç¼–è¯‘å™¨è‡ªåŠ¨æ’å…¥ï¼Œæœªæ¥å¯èƒ½æœ‰å…¶å®ƒæ›´å…·ä½“çš„å®ç°ã€‚ä¸è¿‡æ€ä¹ˆå®ç°ï¼Œåªè¦æ˜¯ç”¨äº† drop æ¥å£ï¼Œå¯¹ç”¨æˆ·ä»£ç æ¥è¯´ä¸å—å½±å“ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632796171,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":357423,"user_name":"é£æ–©æ–­æ™šéœ","can_delete":false,"product_type":"c1","uid":2160093,"ip_address":"æ¹–åŒ—","ucode":"74BC020047A2B4","user_header":"https://static001.geekbang.org/account/avatar/00/20/f5/dd/bb991e80.jpg","comment_is_top":false,"comment_ctime":1663236084,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1663236084","product_id":100085301,"comment_content":"Standard çš„ MyString å¯¹é½åæ˜¯ä¸æ˜¯ç©ºäº† 7 ä¸ªå­—èŠ‚ï¼Ÿ","like_count":0},{"had_liked":false,"id":352073,"user_name":"æ²ˆç•…","can_delete":false,"product_type":"c1","uid":1077953,"ip_address":"","ucode":"7404E41356B36B","user_header":"https://static001.geekbang.org/account/avatar/00/10/72/c1/59509397.jpg","comment_is_top":false,"comment_ctime":1658373133,"is_pvip":true,"replies":[{"id":"128031","content":"æ©ç®€å•è¯´æ˜ä¸€ä¸‹å‰é¢çš„è¯¾ç¨‹è®¾è®¡æ€è·¯ï¼š<br><br>-å‰ç½®ç¯‡æ˜¯ç¼–ç¨‹ç›¸å…³çš„æœ€åŸºæœ¬æ¦‚å¿µ<br>-åŸºç¡€ç¯‡æ˜¯å¼€å§‹æ¥è§¦Rustï¼Œè¯­æ³•ä»‹ç»äº†1è®²ï¼Œç„¶åæ’å…¥äº†get hands dirty é¡¹ç›®ä»å†™ä»£ç ä¸­ç›´è§‚æ„Ÿå—Rustè¯­æ³•ç‰¹æ€§ï¼Œç„¶åå°±è®²å‡ ä¸ªRustçš„å­¦ä¹ é‡éš¾ç‚¹äº†ï¼šæ‰€æœ‰æƒã€ç”Ÿå‘½å‘¨æœŸã€å‡½æ•°å¼ç¼–ç¨‹ç‰¹æ€§ã€ç±»å‹ç³»ç»Ÿã€æ³›å‹ç¼–ç¨‹ã€é”™è¯¯å¤„ç†ç­‰<br><br>ä½œä¸ºâ€œç¬¬ä¸€è¯¾â€ï¼Œè¯­æ³•è®²çš„ä¸æ˜¯å¾ˆå¤šç¡®å®ä¸å¤Ÿå‹å¥½ï¼Œä¸€æ˜¯è¯¾ç¨‹ç¯‡å¹…æœ‰é™ï¼ŒäºŒæ˜¯Rustçš„å®˜æ–¹æ–‡æ¡£åšçš„éå¸¸å¥½ï¼Œå¦å¤–ä¹Ÿæœ‰è€å¸ˆä¸ªäººå€¾å‘è§‰å¾—è¯­æ³•è¯¦ç»†è®²æ²¡æœ‰å¤ªå¤§å¿…è¦ï¼Œæ¯•ç«Ÿå†æ€ä¹ˆæ ·è®²ï¼Œä¹Ÿå¾—å­¦ä¹ è€…è‡ªå·±æ•²ä»£ç ä¸Šæ‰‹æ…¢æ…¢ç†Ÿæ‚‰é£æ ¼ã€‚<br><br>æ‰€ä»¥å¯èƒ½æ²¡æœ‰ç»™ä½ éå¸¸å¥½çš„å­¦ä¹ ä½“éªŒï¼Œè¡¨ç¤ºæŠ±æ­‰ã€‚<br><br>ä½ å¯ä»¥é…åˆå®˜æ–¹çš„Rust bookä¸€èµ·ä½¿ç”¨ï¼Œå¦å¤–åŠ é¤ä¸­è€å¸ˆå’Œå‡ ä¸ªåŒå­¦ä¹Ÿåˆ†äº«äº†è‡ªå·±çš„å­¦ä¹ èµ„æ–™ï¼Œç¥å­¦ä¹ æ„‰å¿«ï½","user_name":"ç¼–è¾‘å›å¤","comment_id":352073,"uid":"2547771","ip_address":"","utype":2,"ctime":1658374431,"user_name_real":"ç¼–è¾‘"}],"discussion_count":2,"race_medal":0,"score":"1658373133","product_id":100085301,"comment_content":"è¯¾ç¨‹å­¦åˆ°è¿™ï¼Œæœ€å¤§çš„é—®é¢˜æ„Ÿè§‰ä¸æˆä½“ç³»ï¼Œæ¯ç¯‡æ–‡ç« åƒæ˜¯åšå®¢ä¸“é¢˜æ–‡ç« ã€‚ä½†æ˜¯ç« èŠ‚ä¹‹é—´æ²¡æœ‰ä½“ç³»ï¼Œä½œä¸ºç¬¬ä¸€è¯¾æ„Ÿè§‰æœ‰äº›ä¸å¦¥ã€‚","like_count":0,"discussions":[{"author":{"id":2547771,"avatar":"https://static001.geekbang.org/account/avatar/00/26/e0/3b/8ec916b2.jpg","nickname":"å¤šå°‘","note":"","ucode":"0A6EF7AA6E4BB7","race_medal":0,"user_type":4,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":580794,"discussion_content":"æ©ç®€å•è¯´æ˜ä¸€ä¸‹å‰é¢çš„è¯¾ç¨‹è®¾è®¡æ€è·¯ï¼š\n\n-å‰ç½®ç¯‡æ˜¯ç¼–ç¨‹ç›¸å…³çš„æœ€åŸºæœ¬æ¦‚å¿µ\n-åŸºç¡€ç¯‡æ˜¯å¼€å§‹æ¥è§¦Rustï¼Œè¯­æ³•ä»‹ç»äº†1è®²ï¼Œç„¶åæ’å…¥äº†get hands dirty é¡¹ç›®ä»å†™ä»£ç ä¸­ç›´è§‚æ„Ÿå—Rustè¯­æ³•ç‰¹æ€§ï¼Œç„¶åå°±è®²å‡ ä¸ªRustçš„å­¦ä¹ é‡éš¾ç‚¹äº†ï¼šæ‰€æœ‰æƒã€ç”Ÿå‘½å‘¨æœŸã€å‡½æ•°å¼ç¼–ç¨‹ç‰¹æ€§ã€ç±»å‹ç³»ç»Ÿã€æ³›å‹ç¼–ç¨‹ã€é”™è¯¯å¤„ç†ç­‰\n\nä½œä¸ºâ€œç¬¬ä¸€è¯¾â€ï¼Œè¯­æ³•è®²çš„ä¸æ˜¯å¾ˆå¤šç¡®å®ä¸å¤Ÿå‹å¥½ï¼Œä¸€æ˜¯è¯¾ç¨‹ç¯‡å¹…æœ‰é™ï¼ŒäºŒæ˜¯Rustçš„å®˜æ–¹æ–‡æ¡£åšçš„éå¸¸å¥½ï¼Œå¦å¤–ä¹Ÿæœ‰è€å¸ˆä¸ªäººå€¾å‘è§‰å¾—è¯­æ³•è¯¦ç»†è®²æ²¡æœ‰å¤ªå¤§å¿…è¦ï¼Œæ¯•ç«Ÿå†æ€ä¹ˆæ ·è®²ï¼Œä¹Ÿå¾—å­¦ä¹ è€…è‡ªå·±æ•²ä»£ç ä¸Šæ‰‹æ…¢æ…¢ç†Ÿæ‚‰é£æ ¼ã€‚\n\næ‰€ä»¥å¯èƒ½æ²¡æœ‰ç»™ä½ éå¸¸å¥½çš„å­¦ä¹ ä½“éªŒï¼Œè¡¨ç¤ºæŠ±æ­‰ã€‚\n\nä½ å¯ä»¥é…åˆå®˜æ–¹çš„Rust bookä¸€èµ·ä½¿ç”¨ï¼Œå¦å¤–åŠ é¤ä¸­è€å¸ˆå’Œå‡ ä¸ªåŒå­¦ä¹Ÿåˆ†äº«äº†è‡ªå·±çš„å­¦ä¹ èµ„æ–™ï¼Œç¥å­¦ä¹ æ„‰å¿«ï½","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1658374431,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":4}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1077953,"avatar":"https://static001.geekbang.org/account/avatar/00/10/72/c1/59509397.jpg","nickname":"æ²ˆç•…","note":"","ucode":"7404E41356B36B","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":580827,"discussion_content":"å¸Œæœ›ä»Šåè¯¾ç¨‹ä½“ç³»ä¸Šè¿›è¡Œä¼˜åŒ–ï¼ŒçŸ¥è¯†ç‚¹èƒ½å¤Ÿæœ‰å‰åè¡”æ¥ï¼Œç¡®å®éœ€è¦è¾…åŠ©ä¸€äº›èµ„æ–™æ‰èƒ½å­¦ä¸‹æ¥ã€‚æ–‡ç« è´¨é‡è¿˜æ˜¯å¾ˆé«˜çš„ï¼Œæœ‰ç‹¬åˆ°ä¹‹å¤„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1658387285,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":350903,"user_name":"çº¦ä¹¦äºš","can_delete":false,"product_type":"c1","uid":1046714,"ip_address":"","ucode":"81EA27ADD9EC1A","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f8/ba/14e05601.jpg","comment_is_top":false,"comment_ctime":1657328315,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1657328315","product_id":100085301,"comment_content":"ç”¨è€å¸ˆçš„æ¨è¿Ÿçš„è§†è§’ï¼ŒCowå…¶å®æ˜¯å°†æ•°æ®çš„ä½¿ç”¨æ–¹å¼(å€Ÿç”¨è¿˜æ˜¯æ‰€æœ‰æƒ)æ¨è¿Ÿåˆ°äº†å‡½æ•°ä¸­ã€‚","like_count":0},{"had_liked":false,"id":344279,"user_name":"é¹…å¸®é€®","can_delete":false,"product_type":"c1","uid":2755534,"ip_address":"","ucode":"A6DB1BEFDA5D9A","user_header":"https://static001.geekbang.org/account/avatar/00/2a/0b/ce/f0c520d1.jpg","comment_is_top":false,"comment_ctime":1651417189,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1651417189","product_id":100085301,"comment_content":"Cowçš„åŠ¨æ€åˆ†å‘æ˜¯åªé™äºæ‰€æœ‰è€…å’Œå€Ÿç”¨å—ï¼Ÿè¿˜æœ‰å…¶ä»–çš„ä¾‹å­å—","like_count":0},{"had_liked":false,"id":336378,"user_name":"2qif49lt","can_delete":false,"product_type":"c1","uid":1061853,"ip_address":"","ucode":"F9AF272776CEDA","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q3auHgzwzM6oiaaIrgh7A3gy0FxVx8kIhUVp9U0ibSxIBCZHK9Ivo4PY1gibmBVicKTBGjaDVCUxObDdrYVwzmmwVA/132","comment_is_top":false,"comment_ctime":1646120690,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1646120690","product_id":100085301,"comment_content":"impl From&lt;String&gt; for MyString {<br>  fn from(s: String) -&gt; Self {<br>    From::&lt;&amp;str&gt;::from(s.as_str())<br>  }<br>}","like_count":0},{"had_liked":false,"id":332988,"user_name":"zzLion","can_delete":false,"product_type":"c1","uid":1475330,"ip_address":"","ucode":"3376B90C230C0A","user_header":"https://static001.geekbang.org/account/avatar/00/16/83/02/fec7a0e1.jpg","comment_is_top":false,"comment_ctime":1643942489,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1643942489","product_id":100085301,"comment_content":"Mutexå’ŒMutexGuardä¸ºä»€ä¹ˆåœ¨Durationæ—¶æ‰æ‰“å°å‡º32å‘¢","like_count":0},{"had_liked":false,"id":332501,"user_name":"è…¾è¾¾","can_delete":false,"product_type":"c1","uid":1079876,"ip_address":"","ucode":"72F9CFBA44FDEE","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTL9hlAIKQ1sGDu16oWLOHyCSicr18XibygQSMLMjuDvKk73deDlH9aMphFsj41WYJh121aniaqBLiaMNg/132","comment_is_top":false,"comment_ctime":1643277609,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1643277609","product_id":100085301,"comment_content":"Box::new() çš„å®ç°å°±ä¸€è¡Œä»£ç ï¼Œå¹¶æ³¨æ˜äº†è¦ inlineï¼Œåœ¨ release æ¨¡å¼ä¸‹ï¼Œè¿™ä¸ªå‡½æ•°è°ƒç”¨ä¼šè¢«ä¼˜åŒ–æ‰ <br>ä¸ºä»€ä¹ˆinline ä¹‹åå°±ç›´æ¥åœ¨å †ä¸Šåˆ†é…äº†ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1629924,"avatar":"https://wx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqXdYJyQjatZ6upnYpAvOTFPziaRScMap4Mj45CKBLbGBmXQF1n64dJbaDFDRrlIWkzahv86C54Yww/132","nickname":"é‡è§","note":"","ucode":"35AB24DD34E997","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":552071,"discussion_content":"inlineåº”è¯¥æ˜¯ç›´æ¥å§å‡½æ•°å±•å¼€ï¼Œæœªå±•å¼€å‰åº”è¯¥æ˜¯å¤šäº†ä¸€æ¬¡å‡½æ•°è°ƒç”¨å‚æ•°æœ€å…ˆç»è¿‡æ ˆ","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1645272780,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":328193,"user_name":"LuYoo","can_delete":false,"product_type":"c1","uid":1202297,"ip_address":"","ucode":"7EED30CB86655D","user_header":"https://static001.geekbang.org/account/avatar/00/12/58/79/266ca68e.jpg","comment_is_top":false,"comment_ctime":1640598468,"is_pvip":false,"replies":[{"id":"120780","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","comment_id":328193,"uid":"1079375","ip_address":"","utype":1,"ctime":1642309551,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"1640598468","product_id":100085301,"comment_content":"è·Ÿä¸ä¸Š+1ï¼Œæ„Ÿè§‰è¿˜æ˜¯è¦æ•´ä½“è¿‡ä¸€éï¼Œç„¶ååœ¨å›å¤´å…·ä½“çœ‹ä¸æ‡‚çš„ã€‚","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546419,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642309551,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":323949,"user_name":"é˜¿æˆ","can_delete":false,"product_type":"c1","uid":1390032,"ip_address":"","ucode":"CEC3CD65FB9333","user_header":"https://static001.geekbang.org/account/avatar/00/15/35/d0/f2ac6d91.jpg","comment_is_top":false,"comment_ctime":1638237596,"is_pvip":false,"replies":[{"id":"118874","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","comment_id":323949,"uid":"1079375","ip_address":"","utype":1,"ctime":1639849490,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"1638237596","product_id":100085301,"comment_content":"https:&#47;&#47;play.rust-lang.org&#47;?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=b77895530e3fc0df461ed8c8d7d34663","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539835,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639849490,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":320924,"user_name":"TheLudlows","can_delete":false,"product_type":"c1","uid":1069346,"ip_address":"","ucode":"64895727505014","user_header":"https://static001.geekbang.org/account/avatar/00/10/51/22/d12f7a72.jpg","comment_is_top":false,"comment_ctime":1636560497,"is_pvip":false,"replies":[{"id":"116573","content":"å¯¹çš„","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1636641448,"ip_address":"","comment_id":320924,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1636560497","product_id":100085301,"comment_content":"ä¸çŸ¥é“è¿™æ ·ç†è§£å¯¹ä¸å¯¹ï¼ŒMiniStringæ²¡æœ‰å®ç°ToString traitä½†æ˜¯èƒ½è°ƒç”¨to_stringæ–¹æ³•ï¼Œæ˜¯å› ä¸ºMiniStringå®ç°äº†Derefï¼Œå½“è°ƒç”¨to_stringæ—¶ï¼Œå…¥å‚æ˜¯&amp;selfï¼Œç›¸å½“äº*(&amp;miniString).to_stringï¼ŒåŒæ—¶stræ˜¯å®ç°äº†ToStringçš„ ","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":530165,"discussion_content":"å¯¹çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1636641448,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":315346,"user_name":"newzai","can_delete":false,"product_type":"c1","uid":1102367,"ip_address":"","ucode":"D5E34D427D65FD","user_header":"https://static001.geekbang.org/account/avatar/00/10/d2/1f/2ef2514b.jpg","comment_is_top":false,"comment_ctime":1633849849,"is_pvip":false,"replies":[{"id":"115298","content":"ä½ å¯ä»¥çœ‹çœ‹ï¼šhttps:&#47;&#47;github.com&#47;tikv&#47;pprof-rs","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1635133431,"ip_address":"","comment_id":315346,"utype":1}],"discussion_count":1,"race_medal":1,"score":"1633849849","product_id":100085301,"comment_content":"æœ‰ä»€ä¹ˆåˆ†é…å™¨å¯ä»¥ï¼Œæœ‰æ¥å£å¯ä»¥è¾“å‡ºå½“å‰è¿›ç¨‹çš„å†…å­˜åˆ†é…è®°å½•ä¸ï¼Œç±»ä¼¼go pprofæ˜¯heapå·¥å…·ï¼Œå†…åµŒåˆ°webä¸­ï¼Œå¯ä»¥éšæ—¶å®šä½ç³»ç»Ÿå†…å­˜åˆ†é…ï¼Œé‡Šæ”¾æ˜¯å¦æ­£å¸¸ã€‚<br><br>å¦å¤–rustæœ‰æ²¡æœ‰ç±»ä¼¼goçš„pprofå·¥å…·ï¼Œå¯ä»¥å†…åµŒwebä¸­ï¼ŒæŸ¥çœ‹å®æ—¶çš„æ‰€æœ‰çº¿ç¨‹stack ï¼Œæ‰€æœ‰heapåˆ†é…è®°å½•ã€‚ã€‚","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527940,"discussion_content":"ä½ å¯ä»¥çœ‹çœ‹ï¼šhttps://github.com/tikv/pprof-rs","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635133431,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":315009,"user_name":"é»„ç»´ä¸€","can_delete":false,"product_type":"c1","uid":1283961,"ip_address":"","ucode":"C9CD241D8DA153","user_header":"https://static001.geekbang.org/account/avatar/00/13/97/79/71aba0c4.jpg","comment_is_top":false,"comment_ctime":1633657422,"is_pvip":false,"replies":[{"id":"114162","content":"ä½ å¯ä»¥å¯¹æ¯”ç€ rust book æ¥çœ‹ã€‚å…¶å®æ™ºèƒ½æŒ‡é’ˆæ²¡æœ‰ä»€ä¹ˆç‰¹æ®Šçš„ï¼Œå®ƒå°±æ˜¯å®ç°äº†æŸäº› traitï¼Œè¡Œä¸ºä¸Šç±»ä¼¼æŒ‡é’ˆçš„æ•°æ®ç»“æ„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1633812258,"ip_address":"","comment_id":315009,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1633657422","product_id":100085301,"comment_content":"å®Œå…¨è·Ÿä¸ä¸Šäº†ï¼Œæ¶ˆåŒ–ä¸äº†çŸ¥è¯†äº†","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527856,"discussion_content":"ä½ å¯ä»¥å¯¹æ¯”ç€ rust book æ¥çœ‹ã€‚å…¶å®æ™ºèƒ½æŒ‡é’ˆæ²¡æœ‰ä»€ä¹ˆç‰¹æ®Šçš„ï¼Œå®ƒå°±æ˜¯å®ç°äº†æŸäº› traitï¼Œè¡Œä¸ºä¸Šç±»ä¼¼æŒ‡é’ˆçš„æ•°æ®ç»“æ„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633812258,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":313877,"user_name":"hughieyu","can_delete":false,"product_type":"c1","uid":1206690,"ip_address":"","ucode":"FC1A64B2BAB784","user_header":"https://static001.geekbang.org/account/avatar/00/12/69/a2/c30ac459.jpg","comment_is_top":false,"comment_ctime":1632727273,"is_pvip":false,"replies":[{"id":"113735","content":"éå¸¸æ£’ï¼éƒ½æ­£ç¡®ï¼<br><br>ç¬¬ 1 é¢˜è¿˜å¯ä»¥å’ŒåŸæœ¬çš„ä»£ç ä¸€èµ·èåˆæˆä¸€ä¸ªæ›´ç®€åŒ–çš„ç‰ˆæœ¬ï¼ˆè¿™æ ·å¯¹ &amp;str, String éƒ½é€‚ç”¨ï¼‰ï¼š<br><br>```rust<br>impl&lt;T&gt; From&lt;T&gt; for MyString<br>where<br>    T: AsRef&lt;str&gt; + Into&lt;String&gt;,<br>{<br>    fn from(s: T) -&gt; Self {<br>        match s.as_ref().len() &gt; MINI_STRING_MAX_LEN {<br>            true =&gt; Self::Standard(s.into()),<br>            _ =&gt; Self::Inline(MiniString::new(s)),<br>        }<br>    }<br>}<br>```<br><br>ç¬¬ 2 é¢˜æˆ‘ä¹Ÿå†™äº†ä¸ªç‰ˆæœ¬ï¼šhttps:&#47;&#47;play.rust-lang.org&#47;?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=8066bd343bd142369fb327d7877db814","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1632798298,"ip_address":"","comment_id":313877,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1632727273","product_id":100085301,"comment_content":"1.impl From&lt;String&gt; for MyString {<br>    fn from(s: String) -&gt; Self {<br>        match s.len() &lt;= MINI_STRING_MAX_LEN {<br>            true =&gt; MyString::Inline(MiniString::new(s)),<br>            false =&gt; MyString::Standard(s),<br>        }<br>    }<br>}<br>2.impl MyString {<br>    fn push_str(&amp;mut self, string: &amp;str){<br>        match *self {<br>            MyString::Standard(ref mut s)=&gt; s.push_str(string),<br>            MyString::Inline(ref mut mini) =&gt; {<br>                let size = mini.len as usize;<br>                match size + string.len() &lt;= MINI_STRING_MAX_LEN {<br>                    true =&gt; { <br>                        mini.data[size..size+string.len()].copy_from_slice(string.as_bytes());<br>                        mini.len = (size +string.len()) as u8;<br>                    },<br>                    false =&gt; *self =  MyString::Standard( format!(&quot;{}{}&quot;, mini.to_string(), string)),<br>                }<br>            },<br>        }<br>    }<br>}<br>3. å†³å®šCow&lt;&#39;a,B&gt;å¤§å°çš„æ˜¯è¾ƒå¤§çš„ä¸€ä¸ªå€¼(ä¸€èˆ¬æ˜¯&lt;B as ToOwned&gt;::Owned)ï¼Œ&lt;[u8] as ToOwned&gt;::Owned=Vec&lt;u8&gt;, &lt;str as ToOwned&gt;::Owned=String, ä¸¤ä¸ªçš„å¤§å°éƒ½ä¸º24å­—èŠ‚ï¼ŒåŠ ä¸Šenumä¸€ä¸ªå­—èŠ‚tagå’Œ7ä¸ªå­—èŠ‚å¯¹é½ï¼Œå…±è®¡32å­—èŠ‚ã€‚","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527503,"discussion_content":"éå¸¸æ£’ï¼éƒ½æ­£ç¡®ï¼\n\nç¬¬ 1 é¢˜è¿˜å¯ä»¥å’ŒåŸæœ¬çš„ä»£ç ä¸€èµ·èåˆæˆä¸€ä¸ªæ›´ç®€åŒ–çš„ç‰ˆæœ¬ï¼ˆè¿™æ ·å¯¹ &amp;amp;str, String éƒ½é€‚ç”¨ï¼‰ï¼š\n\n```rust\nimpl&amp;lt;T&amp;gt; From&amp;lt;T&amp;gt; for MyString\nwhere\n    T: AsRef&amp;lt;str&amp;gt; + Into&amp;lt;String&amp;gt;,\n{\n    fn from(s: T) -&amp;gt; Self {\n        match s.as_ref().len() &amp;gt; MINI_STRING_MAX_LEN {\n            true =&amp;gt; Self::Standard(s.into()),\n            _ =&amp;gt; Self::Inline(MiniString::new(s)),\n        }\n    }\n}\n```\n\nç¬¬ 2 é¢˜æˆ‘ä¹Ÿå†™äº†ä¸ªç‰ˆæœ¬ï¼šhttps://play.rust-lang.org/?version=stable&amp;amp;mode=debug&amp;amp;edition=2018&amp;amp;gist=8066bd343bd142369fb327d7877db814","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632798298,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":313834,"user_name":"pedro","can_delete":false,"product_type":"c1","uid":1200704,"ip_address":"","ucode":"F40C839DDFD599","user_header":"https://static001.geekbang.org/account/avatar/00/12/52/40/e57a736e.jpg","comment_is_top":false,"comment_ctime":1632704873,"is_pvip":false,"replies":[{"id":"113731","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1632797558,"ip_address":"","comment_id":313834,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1632704873","product_id":100085301,"comment_content":"æ·±åº¦å¥½æ–‡ï¼å¾ˆå¤šå®ç”¨çš„å°æŠ€å·§ï¼Œæ¶¨çŸ¥è¯†ã€‚","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527486,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632797558,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":313824,"user_name":"æ’","can_delete":false,"product_type":"c1","uid":1004816,"ip_address":"","ucode":"0C9545E9620AE9","user_header":"https://static001.geekbang.org/account/avatar/00/0f/55/10/33310cb9.jpg","comment_is_top":false,"comment_ctime":1632701295,"is_pvip":false,"replies":[{"id":"113718","content":"æ˜¯çš„ã€‚è€Œä¸” Owned è¿™ä¸ªå…³è”ç±»å‹è¿˜å¸¦æœ‰çº¦æŸï¼Œå®ƒå¿…é¡»æ˜¯å®ç°äº† Borrow&lt;Self&gt; çš„ç±»å‹ã€‚æ–‡ä¸­å…³äºè¿™ä¸ªå…³ç³»åˆè¯¦ç»†çš„ä»‹ç»ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1632796076,"ip_address":"","comment_id":313824,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1632701295","product_id":100085301,"comment_content":"é¦–å…ˆï¼Œtype Owned: Borrow&lt;Self&gt; æ˜¯ä¸€ä¸ªå¸¦æœ‰å…³è”ç±»å‹çš„ trait ï¼Œå¦‚æœä½ å¯¹è¿™ä¸ªçŸ¥è¯†ç‚¹æœ‰äº›é—å¿˜ï¼Œå¯ä»¥å†å¤ä¹ ä¸€ä¸‹<br><br>è¿™é‡Œæ˜¯å¦å®é™…æ˜¯è¯´ToOwnedæ˜¯å¸¦å…³è”ç±»å‹çš„trait","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527483,"discussion_content":"æ˜¯çš„ã€‚è€Œä¸” Owned è¿™ä¸ªå…³è”ç±»å‹è¿˜å¸¦æœ‰çº¦æŸï¼Œå®ƒå¿…é¡»æ˜¯å®ç°äº† Borrow&amp;lt;Self&amp;gt; çš„ç±»å‹ã€‚æ–‡ä¸­å…³äºè¿™ä¸ªå…³ç³»åˆè¯¦ç»†çš„ä»‹ç»ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632796076,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}