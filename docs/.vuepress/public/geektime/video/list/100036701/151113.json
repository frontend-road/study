{"id":151113,"title":"12 | TCP粘包/半包Netty全搞定","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/geek_netty\">https://gitee.com/geektime-geekbang/geek_netty</a></p>","comments":[{"had_liked":false,"id":141693,"user_name":"小不点","can_delete":false,"product_type":"c3","uid":1351860,"ip_address":"","ucode":"C307D44A185C34","user_header":"https://static001.geekbang.org/account/avatar/00/14/a0/b4/5173f1af.jpg","comment_is_top":false,"comment_ctime":1571211694,"is_pvip":false,"replies":[{"id":55057,"content":"可持续发展……","user_name":"作者回复","user_name_real":"Geek_9bc307","uid":1638649,"ctime":1571414893,"ip_address":"","comment_id":141693,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"学习不是短时间的冲刺，而是有节制的坚持","like_count":14,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":470848,"discussion_content":"可持续发展……","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571414893,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":145746,"user_name":"公众号-微观技术","can_delete":false,"product_type":"c3","uid":1043546,"ip_address":"","ucode":"BD0E46A9CF97E9","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ec/5a/1c68c5a7.jpg","comment_is_top":false,"comment_ctime":1572358784,"is_pvip":false,"replies":[{"id":58171,"content":"会做的，他会把那个不完整的数据先存起来，等待完整了，再合并起来。然后再往下一级channel handler处理器上传。","user_name":"作者回复","user_name_real":"Geek_9bc307","uid":1638649,"ctime":1573659826,"ip_address":"","comment_id":145746,"utype":1}],"discussion_count":4,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"固定长度方式，如果一个数据包比较大，超过了缓存区大小，即使头部设置了长度大小，有一部分内容也会放在第二个包传进来，业务处理肯定要求是逻辑上完整的数据包，netty会自动做合包处理吗？","like_count":7,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":472560,"discussion_content":"会做的，他会把那个不完整的数据先存起来，等待完整了，再合并起来。然后再往下一级channel handler处理器上传。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573659826,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2051293,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/4c/dd/c6035349.jpg","nickname":"Bumblebee","note":"","ucode":"B879C8A511D08D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":557302,"discussion_content":"用固定长度来解决粘包与半包问题，一般还会加上报文开始标记，报文结束标记。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1647758854,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1937062,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/8e/a6/c3286b61.jpg","nickname":"Java垒墙工程师","note":"","ucode":"E76AE44A9C76AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":301541,"discussion_content":"TCP会拆分","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598572022,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1692756,"avatar":"https://static001.geekbang.org/account/avatar/00/19/d4/54/7263deb2.jpg","nickname":"吃饭","note":"","ucode":"AF0D7165D5F049","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":240792,"discussion_content":"不理解，固定长度控制的是什么？等待完整之后合并，但是还是大雨缓冲区大小啊？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587388200,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":150951,"user_name":"paradox","can_delete":false,"product_type":"c3","uid":1063967,"ip_address":"","ucode":"51D78BE4B654D0","user_header":"https://static001.geekbang.org/account/avatar/00/10/3c/1f/3948a3c6.jpg","comment_is_top":false,"comment_ctime":1573634081,"is_pvip":false,"replies":[{"id":58169,"content":"先是一次性收到了ABC\\tBCD\\tADC\\t，然后传给DelimiterBasedFrameDecoder，就会解出三个对象，然后传递给下一级处理器了。所以所以对于下一级来说，它不需要再拆分了。","user_name":"作者回复","user_name_real":"Geek_9bc307","uid":1638649,"ctime":1573659362,"ip_address":"","comment_id":150951,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"请问老师，如果一次性读取了含有多个消息的byteBuf，如 ABC\\tBCD\\tADC\\t，服务端DelimiterBasedFrameDecoder再按照\\t接收是不是就是收到了ABC\\tBCD\\tADC？然后进一步拆分呢","like_count":5,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":474322,"discussion_content":"先是一次性收到了ABC\\tBCD\\tADC\\t，然后传给DelimiterBasedFrameDecoder，就会解出三个对象，然后传递给下一级处理器了。所以所以对于下一级来说，它不需要再拆分了。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1573659362,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":141845,"user_name":"Gary","can_delete":false,"product_type":"c3","uid":1218372,"ip_address":"","ucode":"12265D6A578113","user_header":"https://static001.geekbang.org/account/avatar/00/12/97/44/3929e620.jpg","comment_is_top":false,"comment_ctime":1571236320,"is_pvip":false,"replies":[{"id":55047,"content":"netty解码上，会捕获throwable错误，然后转成exceptionCauget方法调用让你去处理，所以上层怎么处理完全你自己决定了:比如直接把连接断了，让它去重连。另外，设置编解码有个最大长度控制参数，控制了，没那么容易挂","user_name":"作者回复","user_name_real":"Geek_9bc307","uid":1638649,"ctime":1571413695,"ip_address":"","comment_id":141845,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"如何处理错误呢？比如对端不按TLV方式（第三种）传输，你会解析出一个很大的长度，导致内存溢出，服务崩溃","like_count":4,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":470909,"discussion_content":"netty解码上，会捕获throwable错误，然后转成exceptionCauget方法调用让你去处理，所以上层怎么处理完全你自己决定了:比如直接把连接断了，让它去重连。另外，设置编解码有个最大长度控制参数，控制了，没那么容易挂","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571413695,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":142695,"user_name":"zpzeng","can_delete":false,"product_type":"c3","uid":1697579,"ip_address":"","ucode":"BC53D95766FE7C","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epOLt1slWbKAtNR9yjAfvrM73hlOQpe2Zzptah7jN3relYAhDudicALnysGfAPL0RjVdzhS7Y2Kbmg/132","comment_is_top":false,"comment_ctime":1571463191,"is_pvip":false,"replies":[{"id":55678,"content":"1 一个是编码，一个是解码，相当于一个发一个收，编解码的区别主要看输入和输出是什么\n2 也可以理解成线程池，他的本质是多个event loop，而一个evnt loop里面只有一个线程，来做绑定到这个event loop里面的多路复用器上发生的事，你看到的每个阶段不是重新注册，是判断每个处理器有没有指定自己的执行器，没有就用最开始选择的那个。如果有，就执行线程切换","user_name":"作者回复","user_name_real":"Geek_9bc307","uid":1638649,"ctime":1571924066,"ip_address":"","comment_id":142695,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"老师，我看SocketChannel注册到workerGroup，是在ServerBootstrap.ServerBootstrapAcceptor#channelRead 方法中，而这个方法调用是在ByteToMessageCodec，MessageToMessageCodec中，这两个和ByteToMessageDecoder，MessageToMessageDecoder有什么区别吗？\n\n然后我看执行过程好像是由pipeline定义的，然后我之前理解是，ServerSocketChannel创建socketChannel之后，是在一个线程里执行执行pipeline的不同阶段。但是现在看着好像是pipeline的每个阶段都要重新注册到group中，选择新的线程执行。是这样吗？能够简单说一下这个过程呢？\n\neventLoopGroup是个什么概念，我现在理解是个线程池一样的东西。\n麻烦老师解答一下","like_count":2,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":471231,"discussion_content":"1 一个是编码，一个是解码，相当于一个发一个收，编解码的区别主要看输入和输出是什么\n2 也可以理解成线程池，他的本质是多个event loop，而一个evnt loop里面只有一个线程，来做绑定到这个event loop里面的多路复用器上发生的事，你看到的每个阶段不是重新注册，是判断每个处理器有没有指定自己的执行器，没有就用最开始选择的那个。如果有，就执行线程切换","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571924066,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":150970,"user_name":"冬渐暖","can_delete":false,"product_type":"c3","uid":1586800,"ip_address":"","ucode":"907E41AAE9A36C","user_header":"https://static001.geekbang.org/account/avatar/00/18/36/70/00122b24.jpg","comment_is_top":false,"comment_ctime":1573636588,"is_pvip":false,"replies":[{"id":58170,"content":"1 空间固定的场景应该极少吧，否则都不需要补0了；\n2 加分隔符而言，如果内容都不需要转义，那不管长度是否符合要求确实一点不浪费空间，但是你说的也是对的，就是有转义的话，是有一点点浪费的，但是换个角度想，如果有那么多都需要转义，说明你的分隔符有点普通了。\n3 比如你的内容是100字节的，所以定义了一个长度字段（比如2个字节），存上数字100，那这样的话，读取的时候，每次都是读那个长度字节（固定2个字节）看看后面的内容长度是多少，比如100，那接下来你就知道要去读100字节了，而不是101什么的。","user_name":"作者回复","user_name_real":"Geek_9bc307","uid":1638649,"ctime":1573659628,"ip_address":"","comment_id":150970,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"半包的原因：发的数据太大装不下了。。。\n我感觉粘包和半包就是类似于平常的断点续传。。。。\n\n找到消息边界\n1.关于固定长度，这个我在之前和平安银行对接的时候，他就要求你没有的话就补0...很多老的存储过程也是这样子，这个比一个一个连接好多了。在空间固定的情况下算是不错的选择了。\n2.关于加分隔符，我刚参加公司的时候，因为没人带，所以对一些特殊的东西都喜欢加个标签来过滤，比如&lt;wdd&gt;&lt;&#47;wdd&gt;截取中间的内容。因为多加了东西，这样个人感觉传的时候也是浪费空间，所以我对你说的空间不浪费有点感到疑惑。。。。。。以前是用这种方法，现在感觉好沙雕哈哈，传入解析都需要处理\n3.关于固定长度的\n我有点没听懂。。。。\n我能不能理解为\n①先看这个传进来的有多长，类似于java的“”.length();  然后再根据长度读这个数据\n②还是先把数据收进来，然后自己想一个合理的长度。。。。。然后读\n感觉这个和固定长度差不多啊。。。也是浪费空间啊。。。\n我的网络知识比较薄弱。。。。希望老师能解答一下我的这些疑问。。。","like_count":1,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":474330,"discussion_content":"1 空间固定的场景应该极少吧，否则都不需要补0了；\n2 加分隔符而言，如果内容都不需要转义，那不管长度是否符合要求确实一点不浪费空间，但是你说的也是对的，就是有转义的话，是有一点点浪费的，但是换个角度想，如果有那么多都需要转义，说明你的分隔符有点普通了。\n3 比如你的内容是100字节的，所以定义了一个长度字段（比如2个字节），存上数字100，那这样的话，读取的时候，每次都是读那个长度字节（固定2个字节）看看后面的内容长度是多少，比如100，那接下来你就知道要去读100字节了，而不是101什么的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573659628,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1586800,"avatar":"https://static001.geekbang.org/account/avatar/00/18/36/70/00122b24.jpg","nickname":"冬渐暖","note":"","ucode":"907E41AAE9A36C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":50288,"discussion_content":"明白了，就是像linux那样多存个fd。。谢谢老师","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573699422,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":146352,"user_name":"jzdayz","can_delete":false,"product_type":"c3","uid":1259280,"ip_address":"","ucode":"E84C0DFC53BE8A","user_header":"https://static001.geekbang.org/account/avatar/00/13/37/10/a8aa9acb.jpg","comment_is_top":false,"comment_ctime":1572503916,"is_pvip":false,"replies":[{"id":59058,"content":"补充：http协议里面的content length字段又融合了解length的方式。","user_name":"作者回复","user_name_real":"Geek_9bc307","uid":1638649,"ctime":1574301644,"ip_address":"","comment_id":146352,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"固定的分隔符-&gt; http协议   以\\n去判定一条一条的header以及requestLine   netty对应的实现类io.netty.handler.codec.http.HttpObjectDecoder这里面有一个headerParser\n用长度去解析包-&gt; RocketMQ自定义协议，以两个字节(还是四个字节的，忘了)为剩余有效包的长度去解析","like_count":1,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":472813,"discussion_content":"补充：http协议里面的content length字段又融合了解length的方式。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574301644,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":141696,"user_name":"拾年","can_delete":false,"product_type":"c3","uid":1696458,"ip_address":"","ucode":"EA27F8B2FA2B24","user_header":"https://static001.geekbang.org/account/avatar/00/19/e2/ca/ddc6c4ff.jpg","comment_is_top":false,"comment_ctime":1571211821,"is_pvip":false,"replies":[{"id":55049,"content":"java网络编程，tcp ip协议，主要就这些领域知识","user_name":"作者回复","user_name_real":"Geek_9bc307","uid":1638649,"ctime":1571413827,"ip_address":"","comment_id":141696,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"老师可以说一些学习netty之前要系统的学习哪些相关知识吗,因为平常工作中接触不到这方面的\n","like_count":1,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":470850,"discussion_content":"java网络编程，tcp ip协议，主要就这些领域知识","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571413827,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":165636,"user_name":"delete is create","can_delete":false,"product_type":"c3","uid":1147979,"ip_address":"","ucode":"A8C751219A7746","user_header":"https://static001.geekbang.org/account/avatar/00/11/84/4b/e4738ba8.jpg","comment_is_top":false,"comment_ctime":1577274717,"is_pvip":false,"replies":[{"id":63246,"content":"一般都不会收到了，就算收到也没有用，组装不回原来的完整的消息(重启了，所以之前存在内存的半包数据丢了)，这种情况，都是需要依赖客户端重试那完成失败的请求。","user_name":"作者回复","user_name_real":"stroller","uid":1638649,"ctime":1577341419,"ip_address":"","comment_id":165636,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"老师您好，如果客户端向服务端发送数据  发生了半包问题，假设一共分了3个包，   服务端接收到一个包后  服务端就宕机重启了   那重启后还可以接收到其余的俩个包么","like_count":0,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":479241,"discussion_content":"一般都不会收到了，就算收到也没有用，组装不回原来的完整的消息(重启了，所以之前存在内存的半包数据丢了)，这种情况，都是需要依赖客户端重试那完成失败的请求。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577341419,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":144442,"user_name":"朱延云","can_delete":false,"product_type":"c3","uid":1319759,"ip_address":"","ucode":"08E6EE2AB82DE9","user_header":"https://static001.geekbang.org/account/avatar/00/14/23/4f/3ce24bed.jpg","comment_is_top":false,"comment_ctime":1571922716,"is_pvip":false,"replies":[{"id":57874,"content":"简单说，就是一个长度字段，然后后面跟着内容，那个长度字段是固定的，比如2个字节，存的就是后面跟着内容的长度，所以读取这个数据的时候，先读固定的那2个字节，拿到长度信息，然后就根据这个长度字节读取后面那么长的数据就行了。","user_name":"作者回复","user_name_real":"Geek_9bc307","uid":1638649,"ctime":1573549800,"ip_address":"","comment_id":144442,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"推荐+的这种方式,没有很理解,能举例说明下吗?","like_count":0,"discussions":[{"author":{"id":1676976,"avatar":"https://static001.geekbang.org/account/avatar/00/19/96/b0/ff84488e.jpg","nickname":"无问無为","note":"","ucode":"D00C60D283E5A1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":40813,"discussion_content":"比如固定前四位表示后续数据的长度，如：0006ABCDEF","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1572271443,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":471939,"discussion_content":"简单说，就是一个长度字段，然后后面跟着内容，那个长度字段是固定的，比如2个字节，存的就是后面跟着内容的长度，所以读取这个数据的时候，先读固定的那2个字节，拿到长度信息，然后就根据这个长度字节读取后面那么长的数据就行了。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1573549800,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":223868,"user_name":"Geek_772139","can_delete":false,"product_type":"c3","uid":1902221,"ip_address":"","ucode":"06FBB079BC38EB","user_header":"","comment_is_top":false,"comment_ctime":1591198910,"is_pvip":false,"replies":null,"discussion_count":2,"race_medal":0,"score":3,"product_id":100036701,"comment_content":"请教老师，MTU是数据链路层的最大传输单元，对于udp协议的包，如果大小超过MTU，那也是需要拆分成帧吧，那为何udp没有拆包问题呢？","like_count":2,"discussions":[{"author":{"id":3922118,"avatar":"","nickname":"wanguanhui","note":"","ucode":"A931550384416E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":649174,"discussion_content":"每个UDP数据报的大小是固定的，最大为64KB。发送端和接收端都直接处理这个大小的数据报，不会进行分段和重组。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1722931650,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1702112,"avatar":"https://static001.geekbang.org/account/avatar/00/19/f8/e0/d6e3cc8f.jpg","nickname":"qgaye","note":"","ucode":"E817609D4ED2D6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":323988,"discussion_content":"应该是不会在传输层进行拆包了，但到了数据链路层肯定是需要拆包后才能发送的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605020537,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":200943,"user_name":"雷刚","can_delete":false,"product_type":"c3","uid":1655725,"ip_address":"","ucode":"115FE2BE1AAB61","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/pTD8nS0SsORKiaRD3wB0NK9Bpd0wFnPWtYLPfBRBhvZ68iaJErMlM2NNSeEibwQfY7GReILSIYZXfT9o8iaicibcyw3g/132","comment_is_top":false,"comment_ctime":1585697018,"is_pvip":false,"replies":null,"discussion_count":4,"race_medal":0,"score":3,"product_id":100036701,"comment_content":"老师，如果 tcp 传输过程丢了一个字节，会导致之后的解码全部错位。Netty 的 LengthFieldBasedFrameDecoder 好像也不处理这种问题，如果碰到这种问题怎么做呢？但我们确实在线网碰到过解码错位的 Bug，这种情况到底是网络传输的问题，还是我们代码的 Bug？而且我看一些开源的框架使用 Netty，也是直接按官方的 API 使用的，应该也是没有处理解码错位的问题，难道这种问题不用考虑吗？","like_count":2,"discussions":[{"author":{"id":1168105,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/e9/c7a80d9f.jpg","nickname":"单行道","note":"","ucode":"4EB42149B476FF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":577961,"discussion_content":"这种处理不了了吧，感觉只能把整个消息丢弃","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1656432364,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1094810,"avatar":"https://static001.geekbang.org/account/avatar/00/10/b4/9a/a9167c59.jpg","nickname":"归去来兮","note":"","ucode":"7218D8E70FA654","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":579866,"discussion_content":"这个也是我要问的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1657731176,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2020634,"avatar":"","nickname":"haisheng","note":"","ucode":"236C399EBA8280","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":282171,"discussion_content":"是不是网站流量太大了？如果是的话，要从tcp协议层去解决这种问题了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591915680,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1136188,"avatar":"https://static001.geekbang.org/account/avatar/00/11/56/3c/e345522b.jpg","nickname":"xxwy","note":"","ucode":"BA2476EAF31F0D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":219655,"discussion_content":"TCP传输过程会掉字节吗？TCP不是保证消息完整性和有序性吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585792503,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":338838,"user_name":"Bumblebee","can_delete":false,"product_type":"c3","uid":2051293,"ip_address":"","ucode":"B879C8A511D08D","user_header":"https://static001.geekbang.org/account/avatar/00/1f/4c/dd/c6035349.jpg","comment_is_top":false,"comment_ctime":1647759687,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100036701,"comment_content":"关于采用固定长度解决粘包与半包问题，实际报文结构一般都会这么定义\n1、报文头：0xFD(定义成其他的也行)占一个字节\n2、报文长度：占两字节\n3、报文体\n4、报文尾：0xED(定义成其他的也行)占一个字节\n\n完整的一个报文\n0xFD(报文头)0003(报文长度)000000(报文内容)ED(报文尾)","like_count":1},{"had_liked":false,"id":387024,"user_name":"Geek_f523c8","can_delete":false,"product_type":"c3","uid":1463908,"ip_address":"浙江","ucode":"6FAD92ACCAB38E","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/BKusySicUz9omWVm7icJUUzJZDBFKvnjgic06j26k9Gqd4QNC1thkoZLPqn0R7IibiatXIFv8OMc15cqbUPGakjcnEg/132","comment_is_top":false,"comment_ctime":1706176812,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100036701,"comment_content":"老师，请教一下，用LengthFieldBasedFrameDecoder，如果出现拆包的现象，服务端先是收到了第一个包，然后宕机重启后，一般来说，是收不到剩余的包了。如果侥幸收到了，但是netty内存中有没有之前收到的包，而剩余的包里面，不会有长度域的数据，netty在解析这部分数据的时候，获取的长度域数据，就不是预期的，然后后续的解析都会出现非预期的情况。想问一下，对于这种情况，netty是如何能够感知收到的数据是非预期的？或者说没法感知，需要上层处理？","like_count":0},{"had_liked":false,"id":326893,"user_name":"simon","can_delete":false,"product_type":"c3","uid":1998352,"ip_address":"","ucode":"380CF1DEA68003","user_header":"https://static001.geekbang.org/account/avatar/00/1e/7e/10/5e587d1f.jpg","comment_is_top":false,"comment_ctime":1639734827,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100036701,"comment_content":"传输的是对象的化 能用DelimiterBasedFrameDecoder 么","like_count":0},{"had_liked":false,"id":314799,"user_name":"受超凡","can_delete":false,"product_type":"c3","uid":2678558,"ip_address":"","ucode":"A2A160D483BBB0","user_header":"","comment_is_top":false,"comment_ctime":1633441281,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":3,"product_id":100036701,"comment_content":"粘包半包发生的话有什么影响呢","like_count":0,"discussions":[{"author":{"id":2051293,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/4c/dd/c6035349.jpg","nickname":"Bumblebee","note":"","ucode":"B879C8A511D08D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":557305,"discussion_content":"就会丢数据","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1647759290,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":279103,"user_name":"毛艳泽_Melissa","can_delete":false,"product_type":"c3","uid":1628823,"ip_address":"","ucode":"959FCADED9342C","user_header":"https://static001.geekbang.org/account/avatar/00/18/da/97/b1fd6723.jpg","comment_is_top":false,"comment_ctime":1613622859,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100036701,"comment_content":"如果用固定长度方式，是不是要和发送方约定好内容的长度不能超过固定长度？ 假设固定长度是3. 发送的内容为abcd000。在解码后得到abc和d000，服务端会不会认为内容是不合法的","like_count":0},{"had_liked":false,"id":192506,"user_name":"ran","can_delete":false,"product_type":"c3","uid":1296666,"ip_address":"","ucode":"D5F4DFA2644A05","user_header":"https://static001.geekbang.org/account/avatar/00/13/c9/1a/7f326801.jpg","comment_is_top":false,"comment_ctime":1584856486,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100036701,"comment_content":"粘包半包解释通俗易懂","like_count":0},{"had_liked":false,"id":145343,"user_name":"Ab","can_delete":false,"product_type":"c3","uid":1039466,"ip_address":"","ucode":"8E9261782F025D","user_header":"https://static001.geekbang.org/account/avatar/00/0f/dc/6a/b5478b65.jpg","comment_is_top":false,"comment_ctime":1572255169,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100036701,"comment_content":"老师的“hold 不住了”总结的太精辟了👍😄","like_count":0}]}