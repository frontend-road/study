{"id":10994,"title":"第27讲 | 云中的网络QoS：邻居疯狂下电影，我该怎么办？","content":"<p>在小区里面，是不是经常有住户不自觉就霸占公共通道，如果你找他理论，他的话就像一个相声《楼道曲》说的一样：“公用公用，你用我用，大家都用，我为什么不能用？”。</p><p>除此之外，你租房子的时候，有没有碰到这样的情况：本来合租共享WiFi，一个人狂下小电影，从而你网都上不去，是不是很懊恼？</p><p>在云平台上，也有这种现象，好在有一种流量控制的技术，可以实现<strong>QoS</strong>（Quality of Service），从而保障大多数用户的服务质量。</p><p>对于控制一台机器的网络的QoS，分两个方向，一个是入方向，一个是出方向。</p><p><img src=\"https://static001.geekbang.org/resource/image/74/11/747b0d537fd1705171ffcca3faf96211.jpg?wh=1539*646\" alt=\"\"></p><p>其实我们能控制的只有出方向，通过Shaping，将出的流量控制成自己想要的模样。而进入的方向是无法控制的，只能通过Policy将包丢弃。</p><h2>控制网络的QoS有哪些方式？</h2><p>在Linux下，可以通过TC控制网络的QoS，主要就是通过队列的方式。</p><h3>无类别排队规则</h3><p>第一大类称为<strong>无类别排队规则</strong>（Classless Queuing Disciplines）。还记得我们讲<a href=\"https://time.geekbang.org/column/article/7772\">ip addr</a>的时候讲过的<strong>pfifo_fast</strong>，这是一种不把网络包分类的技术。</p><p><img src=\"https://static001.geekbang.org/resource/image/e3/6c/e391b4b79580a7d66afe4307ff3f6f6c.jpg?wh=2037*1175\" alt=\"\"></p><p>pfifo_fast分为三个先入先出的队列，称为三个Band。根据网络包里面TOS，看这个包到底应该进入哪个队列。TOS总共四位，每一位表示的意思不同，总共十六种类型。</p><!-- [[[read_end]]] --><p>通过命令行tc qdisc show dev eth0，可以输出结果priomap，也是十六个数字。在0到2之间，和TOS的十六种类型对应起来，表示不同的TOS对应的不同的队列。其中Band 0优先级最高，发送完毕后才轮到Band 1发送，最后才是Band 2。</p><p>另外一种无类别队列规则叫作<strong>随机公平队列</strong>（Stochastic Fair Queuing）。</p><p><img src=\"https://static001.geekbang.org/resource/image/b6/99/b6ec2e4e20ddee7d6952b7fa4586ba99.jpg?wh=2177*1182\" alt=\"\"></p><p>会建立很多的FIFO的队列，TCP Session会计算hash值，通过hash值分配到某个队列。在队列的另一端，网络包会通过轮询策略从各个队列中取出发送。这样不会有一个Session占据所有的流量。</p><p>当然如果两个Session的hash是一样的，会共享一个队列，也有可能互相影响。hash函数会经常改变，从而session不会总是相互影响。</p><p>还有一种无类别队列规则称为<strong>令牌桶规则</strong>（TBF，Token Bucket Filte）。</p><p><img src=\"https://static001.geekbang.org/resource/image/14/9b/145c6f8593bf7603eae79246b9d6859b.jpg?wh=1894*1100\" alt=\"\"></p><p>所有的网络包排成队列进行发送，但不是到了队头就能发送，而是需要拿到令牌才能发送。</p><p>令牌根据设定的速度生成，所以即便队列很长，也是按照一定的速度进行发送的。</p><p>当没有包在队列中的时候，令牌还是以既定的速度生成，但是不是无限累积的，而是放满了桶为止。设置桶的大小为了避免下面的情况：当长时间没有网络包发送的时候，积累了大量的令牌，突然来了大量的网络包，每个都能得到令牌，造成瞬间流量大增。</p><h3>基于类别的队列规则</h3><p>另外一大类是<strong>基于类别的队列规则</strong>（Classful Queuing Disciplines），其中典型的为<strong>分层令牌桶规则</strong>（<strong>HTB</strong>， Hierarchical Token Bucket）。</p><p>HTB往往是一棵树，接下来我举个具体的例子，通过TC如何构建一棵HTB树来带你理解。</p><p><img src=\"https://static001.geekbang.org/resource/image/e6/f5/e6de57bf00f2fe8865ec3548bf8c67f5.jpg?wh=2042*1852\" alt=\"\"></p><p>使用TC可以为某个网卡eth0创建一个HTB的队列规则，需要付给它一个句柄为（1:）。</p><p>这是整棵树的根节点，接下来会有分支。例如图中有三个分支，句柄分别为（:10）、（:11）、（:12）。最后的参数default 12，表示默认发送给1:12，也即发送给第三个分支。</p><pre><code>tc qdisc add dev eth0 root handle 1: htb default 12\n</code></pre><p>对于这个网卡，需要规定发送的速度。一般有两个速度可以配置，一个是<strong>rate</strong>，表示一般情况下的速度；一个是<strong>ceil</strong>，表示最高情况下的速度。对于根节点来讲，这两个速度是一样的，于是创建一个root class，速度为（rate=100kbps，ceil=100kbps）。</p><pre><code>tc class add dev eth0 parent 1: classid 1:1 htb rate 100kbps ceil 100kbps\n</code></pre><p>接下来要创建分支，也即创建几个子class。每个子class统一有两个速度。三个分支分别为（rate=30kbps，ceil=100kbps）、（rate=10kbps，ceil=100kbps）、（rate=60kbps，ceil=100kbps）。</p><pre><code>tc class add dev eth0 parent 1:1 classid 1:10 htb rate 30kbps ceil 100kbps\ntc class add dev eth0 parent 1:1 classid 1:11 htb rate 10kbps ceil 100kbps\ntc class add dev eth0 parent 1:1 classid 1:12 htb rate 60kbps ceil 100kbps\n</code></pre><p>你会发现三个rate加起来，是整个网卡允许的最大速度。</p><p>HTB有个很好的特性，同一个root class下的子类可以相互借流量，如果不直接在队列规则下面创建一个root class，而是直接创建三个class，它们之间是不能相互借流量的。借流量的策略，可以使得当前不使用这个分支的流量的时候，可以借给另一个分支，从而不浪费带宽，使带宽发挥最大的作用。</p><p>最后，创建叶子队列规则，分别为<strong>fifo</strong>和<strong>sfq</strong>。</p><pre><code>tc qdisc add dev eth0 parent 1:10 handle 20: pfifo limit 5\ntc qdisc add dev eth0 parent 1:11 handle 30: pfifo limit 5\ntc qdisc add dev eth0 parent 1:12 handle 40: sfq perturb 10\n</code></pre><p>基于这个队列规则，我们还可以通过TC设定发送规则：从1.2.3.4来的，发送给port 80的包，从第一个分支1:10走；其他从1.2.3.4发送来的包从第二个分支1:11走；其他的走默认分支。</p><pre><code>tc filter add dev eth0 protocol ip parent 1:0 prio 1 u32 match ip src 1.2.3.4 match ip dport 80 0xffff flowid 1:10\ntc filter add dev eth0 protocol ip parent 1:0 prio 1 u32 match ip src 1.2.3.4 flowid 1:11\n</code></pre><h2>如何控制QoS？</h2><p>我们讲过，使用OpenvSwitch将云中的网卡连通在一起，那如何控制QoS呢？</p><p>就像我们上面说的一样，OpenvSwitch支持两种：</p><ul>\n<li>对于进入的流量，可以设置策略Ingress policy；</li>\n</ul><pre><code>ovs-vsctl set Interface tap0 ingress_policing_rate=100000\novs-vsctl set Interface tap0 ingress_policing_burst=10000\n</code></pre><ul>\n<li>对于发出的流量，可以设置QoS规则Egress shaping，支持HTB。</li>\n</ul><p>我们构建一个拓扑图，来看看OpenvSwitch的QoS是如何工作的。</p><p><img src=\"https://static001.geekbang.org/resource/image/3b/ee/3b0de72bc937e108519a473067f607ee.jpg?wh=1945*1985\" alt=\"\"></p><p>首先，在port上可以创建QoS规则，一个QoS规则可以有多个队列Queue。</p><p><img src=\"https://static001.geekbang.org/resource/image/e6/84/e65435bde65a255a085f10d02d2ff184.jpg?wh=2184*1918\" alt=\"\"></p><pre><code>ovs-vsctl set port first_br qos=@newqos -- --id=@newqos create qos type=linux-htb other-config:max-rate=10000000 queues=0=@q0,1=@q1,2=@q2 -- --id=@q0 create queue other-config:min-rate=3000000 other-config:max-rate=10000000 -- --id=@q1 create queue other-config:min-rate=1000000 other-config:max-rate=10000000 -- --id=@q2 create queue other-config:min-rate=6000000 other-config:max-rate=10000000\n</code></pre><p>上面的命令创建了一个QoS规则，对应三个Queue。min-rate就是上面的rate，max-rate就是上面的ceil。通过交换机的网络包，要通过流表规则，匹配后进入不同的队列。然后我们就可以添加流表规则Flow(first_br是br0上的port 5)。</p><pre><code>ovs-ofctl add-flow br0 &quot;in_port=6 nw_src=192.168.100.100 actions=enqueue:5:0&quot;\novs-ofctl add-flow br0 &quot;in_port=7 nw_src=192.168.100.101 actions=enqueue:5:1&quot;\novs-ofctl add-flow br0 &quot;in_port=8 nw_src=192.168.100.102 actions=enqueue:5:2&quot;\n</code></pre><p>接下来，我们单独测试从192.168.100.100，192.168.100.101，192.168.100.102到192.168.100.103的带宽的时候，每个都是能够打满带宽的。</p><p>如果三个一起测试，一起狂发网络包，会发现是按照3:1:6的比例进行的，正是根据配置的队列的带宽比例分配的。</p><p>如果192.168.100.100和192.168.100.101一起测试，发现带宽占用比例为3:1，但是占满了总的流量，也即没有发包的192.168.100.102有60%的带宽被借用了。</p><p>如果192.168.100.100和192.168.100.102一起测试，发现带宽占用比例为1:2。如果192.168.100.101和192.168.100.102一起测试，发现带宽占用比例为1:6。</p><h2>小结</h2><p>好了，这一节就讲到这里了，我们来总结一下。</p><ul>\n<li>\n<p>云中的流量控制主要通过队列进行的，队列分为两大类：无类别队列规则和基于类别的队列规则。</p>\n</li>\n<li>\n<p>在云中网络Openvswitch中，主要使用的是分层令牌桶规则（HTB），将总的带宽在一棵树上按照配置的比例进行分配，并且在一个分支不用的时候，可以借给另外的分支，从而增强带宽利用率。</p>\n</li>\n</ul><p>最后，给你留两个思考题。</p><ol>\n<li>\n<p>这一节中提到，入口流量其实没有办法控制，出口流量是可以很好控制的，你能想出一个控制云中的虚拟机的入口流量的方式吗？</p>\n</li>\n<li>\n<p>安全性和流量控制大概解决了，但是不同用户在物理网络的隔离还是没有解决，你知道怎么解决吗？</p>\n</li>\n</ol><p>我们的专栏更新到第27讲，不知你掌握得如何？每节课后我留的思考题，你都有没有认真思考，并在留言区写下答案呢？我会从<strong>已发布的文章中选出一批认真留言的同学</strong>，赠送<span class=\"orange\">学习奖励礼券</span>和我整理的<span class=\"orange\">独家网络协议知识图谱</span>。</p><p>欢迎你留言和我讨论。趣谈网络协议，我们下期见！</p>","neighbors":{"left":{"article_title":"第26讲 | 云中的网络安全：虽然不是土豪，也需要基本安全和保障","id":10978},"right":{"article_title":"第28讲 | 云中网络的隔离GRE、VXLAN：虽然住一个小区，也要保护隐私","id":11324}},"comments":[{"had_liked":false,"id":16371,"user_name":"Hurt","can_delete":false,"product_type":"c1","uid":1050946,"ip_address":"","ucode":"DCE7428CCF08EF","user_header":"https://static001.geekbang.org/account/avatar/00/10/09/42/1f762b72.jpg","comment_is_top":false,"comment_ctime":1531913057,"is_pvip":false,"discussion_count":5,"race_medal":0,"score":"151855768417","product_id":100007101,"comment_content":"云里雾里 不是科班 感觉要补的东西太多了","like_count":36,"discussions":[{"author":{"id":1402127,"avatar":"https://static001.geekbang.org/account/avatar/00/15/65/0f/770eba2d.jpg","nickname":"Kay","note":"","ucode":"A5A6E3655FEC2D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":306399,"discussion_content":"落泪，自20讲以来，就没看懂几节。。。","likes_number":6,"is_delete":false,"is_hidden":false,"ctime":1600262671,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1144171,"avatar":"https://static001.geekbang.org/account/avatar/00/11/75/6b/fd685164.jpg","nickname":"lcf枫","note":"","ucode":"D51E8F68BD41CA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":122667,"discussion_content":"这么说的话我可能是个假科班","likes_number":6,"is_delete":false,"is_hidden":false,"ctime":1578366663,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1440772,"avatar":"https://static001.geekbang.org/account/avatar/00/15/fc/04/d83a555e.jpg","nickname":"Kevin⚡️Zhou","note":"","ucode":"C0FC2673705212","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1144171,"avatar":"https://static001.geekbang.org/account/avatar/00/11/75/6b/fd685164.jpg","nickname":"lcf枫","note":"","ucode":"D51E8F68BD41CA","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":297230,"discussion_content":"哈哈哈, 我也是假的","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1596817374,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":122667,"ip_address":""},"score":297230,"extra":""}]},{"author":{"id":1707854,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/0f/4e/07340631.jpg","nickname":"Geek_Gump","note":"","ucode":"C7EE0157EC891E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":72723,"discussion_content":"我第一次接触计算机网络的东西，已经完全不知道在讲什么了","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1575520220,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1260141,"avatar":"https://static001.geekbang.org/account/avatar/00/13/3a/6d/910b2445.jpg","nickname":"Wheat","note":"","ucode":"7D99EA149B6DE8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":350721,"discussion_content":"这讲可比数据中心那讲简单多了","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1613989914,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":16314,"user_name":"yungoo","can_delete":false,"product_type":"c1","uid":1060805,"ip_address":"","ucode":"D9BB84A75047CB","user_header":"https://static001.geekbang.org/account/avatar/00/10/2f/c5/aaacb98f.jpg","comment_is_top":false,"comment_ctime":1531878755,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"91726191971","product_id":100007101,"comment_content":"通过ingress qdisc策略将入口流量重定向到虚拟网卡ifb，然后对ifb的egress进行出口限速，从而变通实现入口流控。","like_count":20,"discussions":[{"author":{"id":1932583,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqiapnDZCf0DZvvzcB5CGibib5QDNhAX8nGY9Y5ygC9DUUwJwN4ASVv7MmIzM5vhS03zSfxibKgYTXyKg/132","nickname":"Geek_8664a7","note":"","ucode":"86F71BFF814D77","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583901,"discussion_content":"居然还有这招","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660478943,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"四川"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":16357,"user_name":"晓.光","can_delete":false,"product_type":"c1","uid":1135328,"ip_address":"","ucode":"EC826AE4901235","user_header":"https://static001.geekbang.org/account/avatar/00/11/52/e0/ef42c4ce.jpg","comment_is_top":false,"comment_ctime":1531897903,"is_pvip":false,"replies":[{"id":"5678","content":"对啊，所以原理是通的","user_name":"作者回复","comment_id":16357,"uid":"1001590","ip_address":"","utype":1,"ctime":1531907763,"user_name_real":"刘超@网易云"}],"discussion_count":1,"race_medal":0,"score":"65956407343","product_id":100007101,"comment_content":"越来越发现云中的网络控制跟本地原理一致~","like_count":16,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"刘超","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":420770,"discussion_content":"对啊，所以原理是通的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1531907763,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":16324,"user_name":"zcpromising","can_delete":false,"product_type":"c1","uid":1131966,"ip_address":"","ucode":"4F29D98A436D09","user_header":"https://static001.geekbang.org/account/avatar/00/11/45/be/494010aa.jpg","comment_is_top":false,"comment_ctime":1531882034,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"40186587698","product_id":100007101,"comment_content":"前面15讲以前的内容，在学校是可以接触到的，后面每讲的内容，在学校是体会不到的，每天听老师您的课程，感觉就像发现了新大陆一样，惊喜万分。要是学校老师能够按照您这样的方式讲，那该多好。","like_count":10},{"had_liked":false,"id":83527,"user_name":"超超","can_delete":false,"product_type":"c1","uid":1476077,"ip_address":"","ucode":"D0751F29553481","user_header":"https://static001.geekbang.org/account/avatar/00/16/85/ed/905b052f.jpg","comment_is_top":false,"comment_ctime":1554641011,"is_pvip":false,"replies":[{"id":"49889","content":"是的，可以联动","user_name":"作者回复","comment_id":83527,"uid":"1001590","ip_address":"","utype":1,"ctime":1567779994,"user_name_real":"刘超@网易云"}],"discussion_count":1,"race_medal":0,"score":"27324444787","product_id":100007101,"comment_content":"答问题1：是否可以在虚拟机的前一级控制出口流量？前一级的出口流量得到控制，那么虚拟机的入口流量也就得到了控制。","like_count":7,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"刘超","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":446057,"discussion_content":"是的，可以联动","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567779994,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":19170,"user_name":"iron_man","can_delete":false,"product_type":"c1","uid":1099883,"ip_address":"","ucode":"C0053A59442910","user_header":"https://static001.geekbang.org/account/avatar/00/10/c8/6b/0f3876ef.jpg","comment_is_top":false,"comment_ctime":1533693409,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"27303497185","product_id":100007101,"comment_content":"虚拟机的流量都通过openv switch控制，机器数量多了，openvswitch会不会成为一个瓶颈","like_count":6},{"had_liked":false,"id":16745,"user_name":"Fisher","can_delete":false,"product_type":"c1","uid":1138887,"ip_address":"","ucode":"F3063BCEBC9F14","user_header":"https://static001.geekbang.org/account/avatar/00/11/60/c7/a147b71b.jpg","comment_is_top":false,"comment_ctime":1532148828,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"27301952604","product_id":100007101,"comment_content":"这篇文章控制的出口流量是控制网卡层面的，那么像标题里面的，如果是在局域网中别人疯狂下载，这种控制网速的是在哪个层面控制的，路由器本身控制速度的原理又是什么呢，只是控制转发速度吗","like_count":6},{"had_liked":false,"id":18121,"user_name":"u","can_delete":false,"product_type":"c1","uid":1140276,"ip_address":"","ucode":"88FA7BA089807C","user_header":"https://static001.geekbang.org/account/avatar/00/11/66/34/0508d9e4.jpg","comment_is_top":false,"comment_ctime":1533141264,"is_pvip":false,"replies":[{"id":"6340","content":"现在写的少了","user_name":"作者回复","comment_id":18121,"uid":"1001590","ip_address":"","utype":1,"ctime":1533173246,"user_name_real":"刘超@网易云"}],"discussion_count":1,"race_medal":0,"score":"18713010448","product_id":100007101,"comment_content":"超哥，有个问题想问下：你平时代码写的多吗？","like_count":5,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"刘超","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":421396,"discussion_content":"现在写的少了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1533173246,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":283025,"user_name":"Gabriel","can_delete":false,"product_type":"c1","uid":1437358,"ip_address":"","ucode":"714772A93E93DC","user_header":"https://static001.geekbang.org/account/avatar/00/15/ee/ae/855b7e6e.jpg","comment_is_top":false,"comment_ctime":1615524410,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"10205459002","product_id":100007101,"comment_content":"嗯 什么就硬着头皮也要看 我现在就是","like_count":2,"discussions":[{"author":{"id":2350230,"avatar":"https://static001.geekbang.org/account/avatar/00/23/dc/96/9501cd87.jpg","nickname":"无痕之意","note":"","ucode":"8AF05C8C813352","race_medal":3,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583228,"discussion_content":"我现在也是😂，后面开始越来越看不懂了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659964113,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"上海"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":16281,"user_name":"HIK","can_delete":false,"product_type":"c1","uid":1174344,"ip_address":"","ucode":"13A57077AED932","user_header":"https://static001.geekbang.org/account/avatar/00/11/eb/48/c7aad9d6.jpg","comment_is_top":false,"comment_ctime":1531874252,"is_pvip":false,"replies":[{"id":"5659","content":"性能测试软件都可以","user_name":"作者回复","comment_id":16281,"uid":"1001590","ip_address":"","utype":1,"ctime":1531887193,"user_name_real":"刘超@网易云"}],"discussion_count":3,"race_medal":0,"score":"10121808844","product_id":100007101,"comment_content":"请问如何实现疯狂发包？","like_count":2,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"刘超","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":420739,"discussion_content":"性能测试软件都可以","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1531887193,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2344081,"avatar":"https://static001.geekbang.org/account/avatar/00/23/c4/91/a017bf72.jpg","nickname":"coconut","note":"","ucode":"07B95C7A6AC2F7","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":394268,"discussion_content":"楼上说的是iperf吧。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631805569,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1994374,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/6e/86/c682976b.jpg","nickname":"zhushenghang","note":"","ucode":"712CFE335C7CE4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":280144,"discussion_content":"perf了解一下","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591503249,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":194962,"user_name":"King-ZJ","can_delete":false,"product_type":"c1","uid":1915385,"ip_address":"","ucode":"7448A4BBB5A118","user_header":"https://static001.geekbang.org/account/avatar/00/1d/39/f9/b946719a.jpg","comment_is_top":false,"comment_ctime":1585124319,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5880091615","product_id":100007101,"comment_content":"QOS服务质量在业务运行中做一个按需的配置，更好调节网络的运行流畅度，带给客户更好的体验。","like_count":1},{"had_liked":false,"id":140986,"user_name":"被过去推开","can_delete":false,"product_type":"c1","uid":1276690,"ip_address":"","ucode":"8B4F34FE93FD5B","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Cib5umA0W17N9pichI08pnrXAExdbyh7AVzH4nEhD6KN3FXuELk4LJJuqUPPD7xmIy9nq5Hjbgnzic7sVZG5BKiaUQ/132","comment_is_top":false,"comment_ctime":1571101358,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5866068654","product_id":100007101,"comment_content":"很多网关都提供了基于令牌桶模式的限流，比如spring cloud gateway","like_count":1},{"had_liked":false,"id":56554,"user_name":"haha","can_delete":false,"product_type":"c1","uid":1041547,"ip_address":"","ucode":"F4F3EAB4A15989","user_header":"https://static001.geekbang.org/account/avatar/00/0f/e4/8b/8a0a6c86.jpg","comment_is_top":false,"comment_ctime":1546487332,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5841454628","product_id":100007101,"comment_content":"几种队列的控制策略，放到哪合适的场景适用，借鉴与启发，原理都是如此。","like_count":1},{"had_liked":false,"id":338420,"user_name":"熊@熊","can_delete":false,"product_type":"c1","uid":2005513,"ip_address":"","ucode":"2A792BA769348E","user_header":"https://static001.geekbang.org/account/avatar/00/1e/9a/09/af250bf8.jpg","comment_is_top":false,"comment_ctime":1647495142,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1647495142","product_id":100007101,"comment_content":"HTB的子队列会打满么？如果满了，新流量是丢弃么？还是会调整窗口？","like_count":0},{"had_liked":false,"id":326034,"user_name":"夜⊙▽⊙","can_delete":false,"product_type":"c1","uid":1479222,"ip_address":"","ucode":"89F24E862A20F3","user_header":"https://static001.geekbang.org/account/avatar/00/16/92/36/6f4d8528.jpg","comment_is_top":false,"comment_ctime":1639321891,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1639321891","product_id":100007101,"comment_content":"老师，文中提到的类别该如何理解划分？","like_count":0},{"had_liked":false,"id":289958,"user_name":"三景页","can_delete":false,"product_type":"c1","uid":1243410,"ip_address":"","ucode":"38588DDAA495BC","user_header":"https://static001.geekbang.org/account/avatar/00/12/f9/12/0e6620cd.jpg","comment_is_top":false,"comment_ctime":1619278006,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1619278006","product_id":100007101,"comment_content":"从刘超老师的 刘超的通俗云计算博客 追到极客时间来了","like_count":0,"discussions":[{"author":{"id":1080238,"avatar":"https://static001.geekbang.org/account/avatar/00/10/7b/ae/66ae403d.jpg","nickname":"熊猫","note":"","ucode":"23C85117A16BEF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":379844,"discussion_content":"你好，博客地址能发下吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1624184272,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1243410,"avatar":"https://static001.geekbang.org/account/avatar/00/12/f9/12/0e6620cd.jpg","nickname":"三景页","note":"","ucode":"38588DDAA495BC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1080238,"avatar":"https://static001.geekbang.org/account/avatar/00/10/7b/ae/66ae403d.jpg","nickname":"熊猫","note":"","ucode":"23C85117A16BEF","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":414647,"discussion_content":"https://blog.csdn.net/popsuper1982?ivk_sa=1024320u\n哈哈 可以看的大佬的成长过程","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1636821971,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":379844,"ip_address":""},"score":414647,"extra":""}]}]},{"had_liked":false,"id":276431,"user_name":"Ciao🌚","can_delete":false,"product_type":"c1","uid":2415283,"ip_address":"","ucode":"B048EC8A4A4D77","user_header":"https://static001.geekbang.org/account/avatar/00/24/da/b3/35859560.jpg","comment_is_top":false,"comment_ctime":1611920560,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1611920560","product_id":100007101,"comment_content":"老师，看网上有的资料说，实际上实现Qos都使用了IP头部TOS field的6个bit的DSCP的概念，而不是那4个bit，因为application都不支持。是这样吗？","like_count":0},{"had_liked":false,"id":251718,"user_name":"W҈T҈H҈","can_delete":false,"product_type":"c1","uid":1919027,"ip_address":"","ucode":"93AA6E442B5A47","user_header":"https://static001.geekbang.org/account/avatar/00/1d/48/33/4663928e.jpg","comment_is_top":false,"comment_ctime":1601806970,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1601806970","product_id":100007101,"comment_content":"Qos流量判断可以做网络黑洞吗？来抵御流量攻击？","like_count":0},{"had_liked":false,"id":223216,"user_name":"佳俊","can_delete":false,"product_type":"c1","uid":1385803,"ip_address":"","ucode":"A54445937EEF21","user_header":"https://static001.geekbang.org/account/avatar/00/15/25/4b/4cbd001e.jpg","comment_is_top":false,"comment_ctime":1591022760,"is_pvip":false,"replies":[{"id":"83034","content":"不对应，对应的是enqueue","user_name":"作者回复","comment_id":223216,"uid":"1001590","ip_address":"","utype":1,"ctime":1591755666,"user_name_real":"刘超@网易云"}],"discussion_count":1,"race_medal":0,"score":"1591022760","product_id":100007101,"comment_content":"<br>ovs-ofctl add-flow br0 &quot;in_port=6 nw_src=192.168.100.100 actions=enqueue:5:0&quot;<br>ovs-ofctl add-flow br0 &quot;in_port=7 nw_src=192.168.100.101 actions=enqueue:5:1&quot;<br>ovs-ofctl add-flow br0 &quot;in_port=8 nw_src=192.168.100.102 actions=enqueue:5:2&quot;<br><br>1. 这几个命令里面的in_port=6,7,8怎么和上面的queue对应起来的？<br>","like_count":0,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"刘超","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":497058,"discussion_content":"不对应，对应的是enqueue","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591755666,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":196841,"user_name":"25ma","can_delete":false,"product_type":"c1","uid":1303713,"ip_address":"","ucode":"AB5435B9DB52C9","user_header":"https://static001.geekbang.org/account/avatar/00/13/e4/a1/178387da.jpg","comment_is_top":false,"comment_ctime":1585317031,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1585317031","product_id":100007101,"comment_content":"感觉非科班需要花更多时间来消化这些知识，喜欢超哥的课程","like_count":0},{"had_liked":false,"id":19169,"user_name":"iron_man","can_delete":false,"product_type":"c1","uid":1099883,"ip_address":"","ucode":"C0053A59442910","user_header":"https://static001.geekbang.org/account/avatar/00/10/c8/6b/0f3876ef.jpg","comment_is_top":false,"comment_ctime":1533693311,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1533693311","product_id":100007101,"comment_content":"所有的流量都通过openv","like_count":0},{"had_liked":false,"id":16593,"user_name":"Summer___J","can_delete":false,"product_type":"c1","uid":1135471,"ip_address":"","ucode":"FF53E15E3FC267","user_header":"https://static001.geekbang.org/account/avatar/00/11/53/6f/6051e0f1.jpg","comment_is_top":false,"comment_ctime":1532048268,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1532048268","product_id":100007101,"comment_content":"3:1:6的例子、假如一开始是2个节点疯狂发包占满带宽，假如是第一个和第二个一开始在发，带宽利用占比是3:1。一段时间后，第三个节点再开始疯狂发包。这种情况，当第三个上来以后，这三个节点在带宽占用上会动态地回到3:1:6吗？","like_count":0},{"had_liked":false,"id":16515,"user_name":"rtoday","can_delete":false,"product_type":"c1","uid":1174402,"ip_address":"","ucode":"DFAA788C96ABAC","user_header":"https://static001.geekbang.org/account/avatar/00/11/eb/82/4b56fa5f.jpg","comment_is_top":false,"comment_ctime":1531998845,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1531998845","product_id":100007101,"comment_content":"ovs-vsctl set port first_br qos=@newqos <br>-- --id=@newqos create qos type=linux-htb other-config:max-rate=10,000,000 queues=0=@q0,1=@q1,2=@q2<br>-- --id=@q0 create queue other-config:min-rate=3,000,000 other-config:max-rate=10,000,000 <br>-- --id=@q1 create queue other-config:min-rate=1,000,000 other-config:max-rate=10,000,000 <br>-- --id=@q2 create queue other-config:min-rate=6,000,000 other-config:max-rate=10,000,000<br><br>这是倒数第二个指令<br>我刻意排版一下，并且把数字使用三位一个撇节<br><br>1. 语法问题<br>为何写成<br>-- --id=@newqos<br>我可以只写下面这样吗<br>--id=@newqos<br>双横线然后后面不加上option，请问有什么特殊用意吗？<br><br>2.语意问题<br>是否是我吹毛求疵了<br>好象每个数字都少一个0<br>还是我的认知有误呢","like_count":0},{"had_liked":false,"id":16502,"user_name":"网络已断开","can_delete":false,"product_type":"c1","uid":1062138,"ip_address":"","ucode":"FBE0527E62A82B","user_header":"","comment_is_top":false,"comment_ctime":1531990536,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1531990536","product_id":100007101,"comment_content":"看完似懂非懂，心里痒痒的","like_count":0},{"had_liked":false,"id":16499,"user_name":"rtoday","can_delete":false,"product_type":"c1","uid":1174402,"ip_address":"","ucode":"DFAA788C96ABAC","user_header":"https://static001.geekbang.org/account/avatar/00/11/eb/82/4b56fa5f.jpg","comment_is_top":false,"comment_ctime":1531986854,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1531986854","product_id":100007101,"comment_content":"第一题<br>这篇讲的是Client如何控制出口流量<br>那Client的入口流量<br>也按照一样的原理，只是由Server端，或是数据中心端的人，来控制他们的出口流量即可。这应该是有没有权限的问题。<br><br>第二题，应该是下期的主题，等下期出刊后，再来回顾本题，可能体会的比较完整。","like_count":0},{"had_liked":false,"id":16306,"user_name":"三水","can_delete":false,"product_type":"c1","uid":1017781,"ip_address":"","ucode":"11837CF38FD9BB","user_header":"https://static001.geekbang.org/account/avatar/00/0f/87/b5/dd0353f4.jpg","comment_is_top":false,"comment_ctime":1531876812,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1531876812","product_id":100007101,"comment_content":"问题2: 可以使用Linux Network Namespace进行隔离，cgroup 就进行资源调配和统计，云计算多租户资源使用，如基于docker的云计算服务","like_count":0}]}