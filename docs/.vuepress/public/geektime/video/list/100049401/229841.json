{"id":229841,"title":"22 | 流量镜像：解决线上问题排查的难题","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/geektime-servicemesh\">https://gitee.com/geektime-geekbang/geektime-servicemesh</a></p>","comments":[{"had_liked":false,"id":245956,"user_name":"Geek_66dcc6","can_delete":false,"product_type":"c3","uid":1317851,"ip_address":"","ucode":"0EC9C087C5008B","user_header":"","comment_is_top":false,"comment_ctime":1599120775,"is_pvip":false,"replies":[{"id":90462,"content":"mirror只是不返回response，但服务的逻辑都会走到，你可以在mirror服务的逻辑里做你想debug的事，不用非要通过http返回吧？说白了就是mirror服务一般都和原来的服务不完全一致，会多一些debug逻辑","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1599203011,"ip_address":"","comment_id":245956,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"马老师，关于mirror 有个问题，我们是有流量导入到mirror 的服务中了，但是因为mirror 这个服务的response 已经丢弃掉了，如果我想通过一种方式，能拿到mirror 的response ，用来debug ，可以用什么方法呢","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":505018,"discussion_content":"mirror只是不返回response，但服务的逻辑都会走到，你可以在mirror服务的逻辑里做你想debug的事，不用非要通过http返回吧？说白了就是mirror服务一般都和原来的服务不完全一致，会多一些debug逻辑","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599203011,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":215446,"user_name":"加菲老猫","can_delete":false,"product_type":"c3","uid":1316514,"ip_address":"","ucode":"65FE75E211BCD3","user_header":"https://static001.geekbang.org/account/avatar/00/14/16/a2/26ed8f44.jpg","comment_is_top":false,"comment_ctime":1588993496,"is_pvip":false,"replies":[{"id":79849,"content":"多谢提醒!","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1589114167,"ip_address":"","comment_id":215446,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"马老师，提醒一下，这一章之后的github上课件还没有更新，在线等","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":494441,"discussion_content":"多谢提醒!","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589114167,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":271502,"user_name":"圣杰","can_delete":false,"product_type":"c3","uid":1592196,"ip_address":"","ucode":"91CD51CB26D1EF","user_header":"https://static001.geekbang.org/account/avatar/00/18/4b/84/6550e557.jpg","comment_is_top":false,"comment_ctime":1609669785,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"```\nkubectl apply -f - &lt;&lt;EOF\napiVersion: networking.istio.io&#47;v1alpha3\nkind: VirtualService\nmetadata:\n  name: httpbin\nspec:\n  hosts:\n    - httpbin\n  http:\n  - route:\n    - destination:\n        host: httpbin\n        subset: v1\n      weight: 100\n    mirror:\n      host: httpbin\n      subset: v2\n    mirror_percent: 100\nEOF\n```\nistio 1.7.6 mirro percent 是key-value 形式","like_count":1},{"had_liked":false,"id":335967,"user_name":"Amosヾ","can_delete":false,"product_type":"c3","uid":1567014,"ip_address":"","ucode":"833F6FCB4042AD","user_header":"https://static001.geekbang.org/account/avatar/00/17/e9/26/472e16e4.jpg","comment_is_top":false,"comment_ctime":1645794410,"is_pvip":true,"replies":null,"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"如果需要流量镜像的服务会对数据库进行操作呢？会不会对生产环境造成影响？","like_count":0,"discussions":[{"author":{"id":1112676,"avatar":"https://static001.geekbang.org/account/avatar/00/10/fa/64/457325e6.jpg","nickname":"Sam Fu","note":"","ucode":"EA285A4943271F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":565453,"discussion_content":"会的 所以只能镜像读接口","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1650465379,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":320877,"user_name":"Mars丶小石头","can_delete":false,"product_type":"c3","uid":1765017,"ip_address":"","ucode":"D7689F7676C39B","user_header":"https://static001.geekbang.org/account/avatar/00/1a/ee/99/8c78ad93.jpg","comment_is_top":false,"comment_ctime":1636536234,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"# istio 1.11.4 版本\n# 配置镜像\nkubectl apply -f - &lt;&lt;EOF\napiVersion: networking.istio.io&#47;v1alpha3\nkind: VirtualService\nmetadata:\n  name: httpbin\nspec:\n  hosts:\n  - httpbin\n  http:\n  - route:\n    - destination:\n        host: httpbin\n        subset: v2\n      weight: 100\n    mirror:\n      host: httpbin\n      subset: v3\n    mirrorPercentage:\n      value: 100\nEOF","like_count":0}]}