{"id":421324,"title":"14ï½œç±»å‹ç³»ç»Ÿï¼šæœ‰å“ªäº›å¿…é¡»æŒæ¡çš„traitï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯é™ˆå¤©ã€‚</p><p>å¼€å‘è½¯ä»¶ç³»ç»Ÿæ—¶ï¼Œæˆ‘ä»¬å¼„æ¸…æ¥šéœ€æ±‚ï¼Œè¦å¯¹éœ€æ±‚è¿›è¡Œæ¶æ„ä¸Šçš„åˆ†æå’Œè®¾è®¡ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œåˆç†åœ°å®šä¹‰å’Œä½¿ç”¨ traitï¼Œä¼šè®©ä»£ç ç»“æ„å…·æœ‰å¾ˆå¥½çš„æ‰©å±•æ€§ï¼Œè®©ç³»ç»Ÿå˜å¾—éå¸¸çµæ´»ã€‚</p><p>ä¹‹å‰åœ¨ get hands dirty ç³»åˆ—ä¸­å°±ç²—ç•¥è§è¯†åˆ°äº† trait çš„å·¨å¤§å¨åŠ›ï¼Œä½¿ç”¨äº† From&lt;T&gt; / TryFrom&lt;T&gt; trait è¿›è¡Œç±»å‹é—´çš„è½¬æ¢ï¼ˆ<a href=\"https://time.geekbang.org/column/article/413634\">ç¬¬ 5 è®²</a>ï¼‰ï¼Œè¿˜ä½¿ç”¨äº† Deref trait ï¼ˆ<a href=\"https://time.geekbang.org/column/article/414478\">ç¬¬ 6 è®²</a>ï¼‰è®©ç±»å‹åœ¨ä¸æš´éœ²å…¶å†…éƒ¨ç»“æ„ä»£ç çš„åŒæ—¶ï¼Œè®©å†…éƒ¨ç»“æ„çš„æ–¹æ³•å¯ä»¥å¯¹å¤–ä½¿ç”¨ã€‚</p><p>ç»è¿‡ä¸Šä¸¤è®²çš„å­¦ä¹ ï¼Œç›¸ä¿¡ä½ ç°åœ¨å¯¹trait çš„ç†è§£å°±æ·±å…¥äº†ã€‚åœ¨å®é™…è§£å†³é—®é¢˜çš„è¿‡ç¨‹ä¸­ï¼Œ<strong>ç”¨å¥½è¿™äº› traitï¼Œä¼šè®©ä½ çš„ä»£ç ç»“æ„æ›´åŠ æ¸…æ™°ï¼Œé˜…è¯»å’Œä½¿ç”¨éƒ½æ›´åŠ ç¬¦åˆ Rust ç”Ÿæ€çš„ä¹ æƒ¯</strong>ã€‚æ¯”å¦‚æ•°æ®ç»“æ„å®ç°äº† Debug traitï¼Œé‚£ä¹ˆå½“ä½ æƒ³æ‰“å°æ•°æ®ç»“æ„æ—¶ï¼Œå°±å¯ä»¥ç”¨ {:?} æ¥æ‰“å°ï¼›å¦‚æœä½ çš„æ•°æ®ç»“æ„å®ç°äº† From&lt;T&gt;ï¼Œé‚£ä¹ˆï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ into() æ–¹æ³•åšæ•°æ®è½¬æ¢ã€‚</p><h2>trait</h2><p>Rust è¯­è¨€çš„æ ‡å‡†åº“å®šä¹‰äº†å¤§é‡çš„æ ‡å‡† traitï¼Œæ¥å…ˆæ¥æ•°å·²ç»å­¦è¿‡çš„ï¼Œçœ‹çœ‹æ”’äº†å“ªäº›ï¼š</p><ul>\n<li>Clone / Copy traitï¼Œçº¦å®šäº†æ•°æ®è¢«æ·±æ‹·è´å’Œæµ…æ‹·è´çš„è¡Œä¸ºï¼›</li>\n<li>Read / Write traitï¼Œçº¦å®šäº†å¯¹ I/O è¯»å†™çš„è¡Œä¸ºï¼›</li>\n<li>Iteratorï¼Œçº¦å®šäº†è¿­ä»£å™¨çš„è¡Œä¸ºï¼›</li>\n<li>Debugï¼Œçº¦å®šäº†æ•°æ®å¦‚ä½•è¢«ä»¥ debug çš„æ–¹å¼æ˜¾ç¤ºå‡ºæ¥çš„è¡Œä¸ºï¼›</li>\n<li>Defaultï¼Œçº¦å®šæ•°æ®ç±»å‹çš„ç¼ºçœå€¼å¦‚ä½•äº§ç”Ÿçš„è¡Œä¸ºï¼›</li>\n<li>From&lt;T&gt; / TryFrom&lt;T&gt;ï¼Œçº¦å®šäº†æ•°æ®é—´å¦‚ä½•è½¬æ¢çš„è¡Œä¸ºã€‚</li>\n</ul><!-- [[[read_end]]] --><p>æˆ‘ä»¬ä¼šå†å­¦ä¹ å‡ ç±»é‡è¦çš„ traitï¼ŒåŒ…æ‹¬å’Œå†…å­˜åˆ†é…é‡Šæ”¾ç›¸å…³çš„ traitã€ç”¨äºåŒºåˆ«ä¸åŒç±»å‹ååŠ©ç¼–è¯‘å™¨åšç±»å‹å®‰å…¨æ£€æŸ¥çš„æ ‡è®° traitã€è¿›è¡Œç±»å‹è½¬æ¢çš„ traitã€æ“ä½œç¬¦ç›¸å…³çš„ traitï¼Œä»¥åŠ Debug/Display/Defaultã€‚</p><p>åœ¨å­¦ä¹ è¿™äº› traitçš„è¿‡ç¨‹ä¸­ï¼Œä½ ä¹Ÿå¯ä»¥ç»“åˆä¹‹å‰è®²çš„å†…å®¹ï¼Œæœ‰æ„è¯†åœ°æ€è€ƒä¸€ä¸‹Rustä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡ï¼Œåœ¨å¢è¿›å¯¹è¯­è¨€ç†è§£çš„åŒæ—¶ï¼Œä¹Ÿèƒ½å†™å‡ºæ›´åŠ ä¼˜é›…çš„ Rust ä»£ç ã€‚</p><h2>å†…å­˜ç›¸å…³ï¼šClone / Copy / Drop</h2><p>é¦–å…ˆæ¥çœ‹å†…å­˜ç›¸å…³çš„ Clone/Copy/Dropã€‚è¿™ä¸‰ä¸ª trait åœ¨ä»‹ç»æ‰€æœ‰æƒçš„æ—¶å€™å·²ç»å­¦ä¹ è¿‡ï¼Œè¿™é‡Œæˆ‘ä»¬å†æ·±å…¥ç ”ç©¶ä¸€ä¸‹å®ƒä»¬çš„å®šä¹‰å’Œä½¿ç”¨åœºæ™¯ã€‚</p><h3>Clone trait</h3><p>é¦–å…ˆçœ‹ Cloneï¼š</p><pre><code class=\"language-rust\">pub trait Clone {\n  fn clone(&amp;self) -&gt; Self;\n\n  fn clone_from(&amp;mut self, source: &amp;Self) {\n    *self = source.clone()\n  }\n}\n</code></pre><p>Clone trait æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œ <code>clone()</code> å’Œ  <code>clone_from()</code> ï¼Œåè€…æœ‰ç¼ºçœå®ç°ï¼Œæ‰€ä»¥å¹³æ—¶æˆ‘ä»¬åªéœ€è¦å®ç°  <code>clone()</code> æ–¹æ³•å³å¯ã€‚ä½ ä¹Ÿè®¸ä¼šç–‘æƒ‘ï¼Œè¿™ä¸ª  <code>clone_from()</code> æœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿå› ä¸ºçœ‹èµ·æ¥  <code>a.clone_from(&amp;b)</code> ï¼Œå’Œ  <code>a = b.clone()</code> æ˜¯ç­‰ä»·çš„ã€‚</p><p>å…¶å®ä¸æ˜¯ï¼Œå¦‚æœ a å·²ç»å­˜åœ¨ï¼Œåœ¨ clone è¿‡ç¨‹ä¸­ä¼šåˆ†é…å†…å­˜ï¼Œé‚£ä¹ˆ<strong>ç”¨  <code>a.clone_from(&amp;b)</code> å¯ä»¥é¿å…å†…å­˜åˆ†é…ï¼Œæé«˜æ•ˆç‡</strong>ã€‚</p><p>Clone trait å¯ä»¥é€šè¿‡æ´¾ç”Ÿå®ç›´æ¥å®ç°ï¼Œè¿™æ ·èƒ½ç®€åŒ–ä¸å°‘ä»£ç ã€‚å¦‚æœåœ¨ä½ çš„æ•°æ®ç»“æ„é‡Œï¼Œæ¯ä¸€ä¸ªå­—æ®µéƒ½å·²ç»å®ç°äº†Clone traitï¼Œä½ å¯ä»¥ç”¨  <code>#[derive(Clone)]</code> ï¼Œçœ‹ä¸‹é¢çš„<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=9726c98022668f3249b711719a11bf09\">ä»£ç </a>ï¼Œå®šä¹‰äº† Developer ç»“æ„å’Œ Language æšä¸¾ï¼š</p><pre><code class=\"language-rust\">#[derive(Clone, Debug)]\nstruct Developer {\n  name: String,\n  age: u8,\n  lang: Language\n}\n\n#[allow(dead_code)]\n#[derive(Clone, Debug)]\nenum Language {\n  Rust,\n  TypeScript,\n  Elixir,\n  Haskell\n}\n\nfn main() {\n    let dev = Developer {\n        name: \"Tyr\".to_string(),\n        age: 18,\n        lang: Language::Rust\n    };\n    let dev1 = dev.clone();\n    println!(\"dev: {:?}, addr of dev name: {:p}\", dev, dev.name.as_str());\n    println!(\"dev1: {:?}, addr of dev1 name: {:p}\", dev1, dev1.name.as_str())\n}\n</code></pre><p>å¦‚æœæ²¡æœ‰ä¸º Language å®ç° Clone çš„è¯ï¼ŒDeveloper çš„æ´¾ç”Ÿå® Clone å°†ä¼šç¼–è¯‘å‡ºé”™ã€‚è¿è¡Œè¿™æ®µä»£ç å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äº nameï¼Œä¹Ÿå°±æ˜¯ String ç±»å‹çš„ Cloneï¼Œå…¶å †ä¸Šçš„å†…å­˜ä¹Ÿè¢« Clone äº†ä¸€ä»½ï¼Œæ‰€ä»¥ Clone æ˜¯æ·±åº¦æ‹·è´ï¼Œæ ˆå†…å­˜å’Œå †å†…å­˜ä¸€èµ·æ‹·è´ã€‚</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œclone æ–¹æ³•çš„æ¥å£æ˜¯ &amp;selfï¼Œè¿™åœ¨ç»å¤§å¤šæ•°åœºåˆä¸‹éƒ½æ˜¯é€‚ç”¨çš„ï¼Œæˆ‘ä»¬åœ¨ clone ä¸€ä¸ªæ•°æ®æ—¶åªéœ€è¦æœ‰å·²æœ‰æ•°æ®çš„åªè¯»å¼•ç”¨ã€‚ä½†å¯¹ Rc&lt;T&gt; è¿™æ ·åœ¨ clone() æ—¶ç»´æŠ¤å¼•ç”¨è®¡æ•°çš„æ•°æ®ç»“æ„ï¼Œclone() è¿‡ç¨‹ä¸­ä¼šæ”¹å˜è‡ªå·±ï¼Œæ‰€ä»¥è¦ç”¨ Cell&lt;T&gt; è¿™æ ·æä¾›å†…éƒ¨å¯å˜æ€§çš„ç»“æ„æ¥è¿›è¡Œæ”¹å˜ï¼Œå¦‚æœä½ ä¹Ÿæœ‰ç±»ä¼¼çš„éœ€æ±‚ï¼Œå¯ä»¥å‚è€ƒã€‚</p><h3>Copy trait</h3><p>å’Œ Clone trait ä¸åŒçš„æ˜¯ï¼ŒCopy trait æ²¡æœ‰ä»»ä½•é¢å¤–çš„æ–¹æ³•ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªæ ‡è®° traitï¼ˆmarker traitï¼‰ã€‚å®ƒçš„ trait å®šä¹‰ï¼š</p><pre><code class=\"language-rust\">pub trait Copy: Clone {}\n</code></pre><p>æ‰€ä»¥çœ‹è¿™ä¸ªå®šä¹‰ï¼Œå¦‚æœè¦å®ç° Copy trait çš„è¯ï¼Œå¿…é¡»å®ç° Clone traitï¼Œç„¶åå®ç°ä¸€ä¸ªç©ºçš„ Copy traitã€‚ä½ æ˜¯ä¸æ˜¯æœ‰ç‚¹ç–‘æƒ‘ï¼šè¿™æ ·ä¸åŒ…å«ä»»ä½•è¡Œä¸ºçš„ trait æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿ</p><p>è¿™æ ·çš„ trait <strong>è™½ç„¶æ²¡æœ‰ä»»ä½•è¡Œä¸ºï¼Œä½†å®ƒå¯ä»¥ç”¨ä½œ trait bound æ¥è¿›è¡Œç±»å‹å®‰å…¨æ£€æŸ¥</strong>ï¼Œæ‰€ä»¥æˆ‘ä»¬ç®¡å®ƒå«<strong>æ ‡è®° trait</strong>ã€‚</p><p>å’Œ Clone ä¸€æ ·ï¼Œå¦‚æœæ•°æ®ç»“æ„çš„æ‰€æœ‰å­—æ®µéƒ½å®ç°äº† Copyï¼Œä¹Ÿå¯ä»¥ç”¨  <code>#[derive(Copy)]</code> å®æ¥ä¸ºæ•°æ®ç»“æ„å®ç° Copyã€‚è¯•ç€ä¸º Developer å’Œ Language åŠ ä¸Š Copyï¼š</p><pre><code class=\"language-rust\">#[derive(Clone, Copy, Debug)]\nstruct Developer {\n  name: String,\n  age: u8,\n  lang: Language\n}\n\n#[derive(Clone, Copy, Debug)]\nenum Language {\n  Rust,\n  TypeScript,\n  Elixir,\n  Haskell\n}\n</code></pre><p>è¿™ä¸ªä»£ç ä¼šå‡ºé”™ã€‚å› ä¸º String ç±»å‹æ²¡æœ‰å®ç° Copyã€‚ å› æ­¤ï¼ŒDeveloper æ•°æ®ç»“æ„åªèƒ½ cloneï¼Œæ— æ³• copyã€‚æˆ‘ä»¬çŸ¥é“ï¼Œå¦‚æœç±»å‹å®ç°äº† Copyï¼Œé‚£ä¹ˆåœ¨èµ‹å€¼ã€å‡½æ•°è°ƒç”¨çš„æ—¶å€™ï¼Œå€¼ä¼šè¢«æ‹·è´ï¼Œå¦åˆ™æ‰€æœ‰æƒä¼šè¢«ç§»åŠ¨ã€‚</p><p>æ‰€ä»¥ä¸Šé¢çš„ä»£ç  Developer ç±»å‹åœ¨åšå‚æ•°ä¼ é€’æ—¶ï¼Œä¼šæ‰§è¡Œ Move è¯­ä¹‰ï¼Œè€Œ Language ä¼šæ‰§è¡Œ Copy è¯­ä¹‰ã€‚</p><p>åœ¨è®²æ‰€æœ‰æƒå¯å˜/ä¸å¯å˜å¼•ç”¨çš„æ—¶å€™æåˆ°ï¼Œä¸å¯å˜å¼•ç”¨å®ç°äº† Copyï¼Œè€Œå¯å˜å¼•ç”¨ &amp;mut T æ²¡æœ‰å®ç° Copyã€‚ä¸ºä»€ä¹ˆæ˜¯è¿™æ ·ï¼Ÿ</p><p>å› ä¸ºå¦‚æœå¯å˜å¼•ç”¨å®ç°äº† Copy traitï¼Œé‚£ä¹ˆç”Ÿæˆä¸€ä¸ªå¯å˜å¼•ç”¨ç„¶åæŠŠå®ƒèµ‹å€¼ç»™å¦ä¸€ä¸ªå˜é‡æ—¶ï¼Œå°±ä¼šè¿èƒŒæ‰€æœ‰æƒè§„åˆ™ï¼šåŒä¸€ä¸ªä½œç”¨åŸŸä¸‹åªèƒ½æœ‰ä¸€ä¸ªå¯å˜å¼•ç”¨ã€‚å¯è§ï¼ŒRust æ ‡å‡†åº“åœ¨å“ªäº›ç»“æ„å¯ä»¥ Copyã€å“ªäº›ä¸å¯ä»¥ Copy ä¸Šï¼Œæœ‰ç€ä»”ç»†çš„è€ƒé‡ã€‚</p><h3>Drop trait</h3><p>åœ¨å†…å­˜ç®¡ç†ä¸­å·²ç»è¯¦ç»†æ¢è®¨è¿‡ Drop traitã€‚è¿™é‡Œæˆ‘ä»¬å†çœ‹ä¸€ä¸‹å®ƒçš„å®šä¹‰ï¼š</p><pre><code class=\"language-rust\">pub trait Drop {\n    fn drop(&amp;mut self);\n}\n</code></pre><p>å¤§éƒ¨åˆ†åœºæ™¯æ— éœ€ä¸ºæ•°æ®ç»“æ„æä¾› Drop traitï¼Œç³»ç»Ÿé»˜è®¤ä¼šä¾æ¬¡å¯¹æ•°æ®ç»“æ„çš„æ¯ä¸ªåŸŸåš dropã€‚ä½†æœ‰ä¸¤ç§æƒ…å†µä½ å¯èƒ½éœ€è¦æ‰‹å·¥å®ç° Dropã€‚</p><p>ç¬¬ä¸€ç§æ˜¯å¸Œæœ›åœ¨æ•°æ®ç»“æŸç”Ÿå‘½å‘¨æœŸçš„æ—¶å€™åšä¸€äº›äº‹æƒ…ï¼Œæ¯”å¦‚è®°æ—¥å¿—ã€‚</p><p>ç¬¬äºŒç§æ˜¯éœ€è¦å¯¹èµ„æºå›æ”¶çš„åœºæ™¯ã€‚ç¼–è¯‘å™¨å¹¶ä¸çŸ¥é“ä½ é¢å¤–ä½¿ç”¨äº†å“ªäº›èµ„æºï¼Œä¹Ÿå°±æ— æ³•å¸®åŠ©ä½  drop å®ƒä»¬ã€‚æ¯”å¦‚è¯´é”èµ„æºçš„é‡Šæ”¾ï¼Œåœ¨ MutexGuard&lt;T&gt; ä¸­å®ç°äº† Drop æ¥é‡Šæ”¾é”èµ„æºï¼š</p><pre><code class=\"language-rust\">impl&lt;T: ?Sized&gt; Drop for MutexGuard&lt;'_, T&gt; {\n&nbsp; &nbsp; #[inline]\n&nbsp; &nbsp; fn drop(&amp;mut self) {\n&nbsp; &nbsp; &nbsp; &nbsp; unsafe {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.lock.poison.done(&amp;self.poison);\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.lock.inner.raw_unlock();\n&nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; }\n}\n</code></pre><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒCopy trait å’Œ Drop trait æ˜¯äº’æ–¥çš„ï¼Œä¸¤è€…ä¸èƒ½å…±å­˜ï¼Œå½“ä½ å°è¯•ä¸ºåŒä¸€ç§æ•°æ®ç±»å‹å®ç° Copy æ—¶ï¼Œä¹Ÿå®ç° Dropï¼Œç¼–è¯‘å™¨å°±ä¼šæŠ¥é”™ã€‚è¿™å…¶å®å¾ˆå¥½ç†è§£ï¼š<strong>Copyæ˜¯æŒ‰ä½åšæµ…æ‹·è´ï¼Œé‚£ä¹ˆå®ƒä¼šé»˜è®¤æ‹·è´çš„æ•°æ®æ²¡æœ‰éœ€è¦é‡Šæ”¾çš„èµ„æºï¼›è€ŒDropæ°æ°æ˜¯ä¸ºäº†é‡Šæ”¾é¢å¤–çš„èµ„æºè€Œç”Ÿçš„</strong>ã€‚</p><p>æˆ‘ä»¬è¿˜æ˜¯å†™ä¸€æ®µä»£ç æ¥è¾…åŠ©ç†è§£ï¼Œåœ¨ä»£ç ä¸­ï¼Œå¼ºè¡Œç”¨ Box::into_raw è·å¾—å †å†…å­˜çš„æŒ‡é’ˆï¼Œæ”¾å…¥ RawBuffer ç»“æ„ä¸­ï¼Œè¿™æ ·å°±æ¥ç®¡äº†è¿™å—å †å†…å­˜çš„é‡Šæ”¾ã€‚</p><p>è™½ç„¶ RawBuffer å¯ä»¥å®ç° Copy traitï¼Œä½†è¿™æ ·ä¸€æ¥å°±æ— æ³•å®ç° Drop traitã€‚å¦‚æœç¨‹åºéè¦è¿™ä¹ˆå†™ï¼Œä¼šå¯¼è‡´å†…å­˜æ³„æ¼ï¼Œå› ä¸ºè¯¥é‡Šæ”¾çš„å †å†…å­˜æ²¡æœ‰é‡Šæ”¾ã€‚</p><p>ä½†æ˜¯è¿™ä¸ªæ“ä½œä¸ä¼šç ´å Rust çš„æ­£ç¡®æ€§ä¿è¯ï¼šå³ä¾¿ä½  Copy äº† N ä»½ RawBufferï¼Œç”±äºæ— æ³•å®ç° Drop traitï¼ŒRawBuffer æŒ‡å‘çš„é‚£åŒä¸€å—å †å†…å­˜ä¸ä¼šé‡Šæ”¾ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç° use after free çš„å†…å­˜å®‰å…¨é—®é¢˜ã€‚ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=76de1040b516b50f671c3abfe71cfb37\">ä»£ç </a>ï¼‰</p><pre><code class=\"language-rust\">use std::{fmt, slice};\n\n// æ³¨æ„è¿™é‡Œï¼Œæˆ‘ä»¬å®ç°äº† Copyï¼Œè¿™æ˜¯å› ä¸º *mut u8/usize éƒ½æ”¯æŒ Copy\n#[derive(Clone, Copy)]\nstruct RawBuffer {\n    // è£¸æŒ‡é’ˆç”¨ *const / *mut æ¥è¡¨è¿°ï¼Œè¿™å’Œå¼•ç”¨çš„ &amp; ä¸åŒ\n    ptr: *mut u8,\n    len: usize,\n}\n\nimpl From&lt;Vec&lt;u8&gt;&gt; for RawBuffer {\n    fn from(vec: Vec&lt;u8&gt;) -&gt; Self {\n        let slice = vec.into_boxed_slice();\n        Self {\n            len: slice.len(),\n            // into_raw ä¹‹åï¼ŒBox å°±ä¸ç®¡è¿™å—å†…å­˜çš„é‡Šæ”¾äº†ï¼ŒRawBuffer éœ€è¦å¤„ç†é‡Šæ”¾\n            ptr: Box::into_raw(slice) as *mut u8,\n        }\n    }\n}\n\n// å¦‚æœ RawBuffer å®ç°äº† Drop traitï¼Œå°±å¯ä»¥åœ¨æ‰€æœ‰è€…é€€å‡ºæ—¶é‡Šæ”¾å †å†…å­˜\n// ç„¶åï¼ŒDrop trait ä¼šè·Ÿ Copy trait å†²çªï¼Œè¦ä¹ˆä¸å®ç° Copyï¼Œè¦ä¹ˆä¸å®ç° Drop\n// å¦‚æœä¸å®ç° Dropï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ï¼Œä½†å®ƒä¸ä¼šå¯¹æ­£ç¡®æ€§æœ‰ä»»ä½•ç ´å\n// æ¯”å¦‚ä¸ä¼šå‡ºç° use after free è¿™æ ·çš„é—®é¢˜ã€‚\n// ä½ å¯ä»¥è¯•ç€æŠŠä¸‹é¢æ³¨é‡Šå»æ‰ï¼Œçœ‹çœ‹ä¼šå‡ºä»€ä¹ˆé—®é¢˜\n// impl Drop for RawBuffer {\n//     #[inline]\n//     fn drop(&amp;mut self) {\n//         let data = unsafe { Box::from_raw(slice::from_raw_parts_mut(self.ptr, self.len)) };\n//         drop(data)\n//     }\n// }\n\nimpl fmt::Debug for RawBuffer {\n    fn fmt(&amp;self, f: &amp;mut fmt::Formatter&lt;'_&gt;) -&gt; fmt::Result {\n        let data = self.as_ref();\n        write!(f, \"{:p}: {:?}\", self.ptr, data)\n    }\n}\n\nimpl AsRef&lt;[u8]&gt; for RawBuffer {\n    fn as_ref(&amp;self) -&gt; &amp;[u8] {\n        unsafe { slice::from_raw_parts(self.ptr, self.len) }\n    }\n}\n\nfn main() {\n    let data = vec![1, 2, 3, 4];\n\n    let buf: RawBuffer = data.into();\n\n    // å› ä¸º buf å…è®¸ Copyï¼Œæ‰€ä»¥è¿™é‡Œ Copy äº†ä¸€ä»½\n    use_buffer(buf);\n\n    // buf è¿˜èƒ½ç”¨\n    println!(\"buf: {:?}\", buf);\n}\n\nfn use_buffer(buf: RawBuffer) {\n    println!(\"buf to die: {:?}\", buf);\n\n    // è¿™é‡Œä¸ç”¨ç‰¹æ„ dropï¼Œå†™å‡ºæ¥åªæ˜¯ä¸ºäº†è¯´æ˜ Copy å‡ºæ¥çš„ buf è¢« Drop äº†\n    drop(buf)\n}\n</code></pre><p>å¯¹äºä»£ç å®‰å…¨æ¥è¯´ï¼Œå†…å­˜æ³„æ¼å±å®³å¤§ï¼Ÿè¿˜æ˜¯ use after free å±å®³å¤§å‘¢ï¼Ÿè‚¯å®šæ˜¯åè€…ã€‚Rust çš„åº•çº¿æ˜¯å†…å­˜å®‰å…¨ï¼Œæ‰€ä»¥ä¸¤å®³ç›¸æƒå–å…¶è½»ã€‚</p><p>å®é™…ä¸Šï¼Œä»»ä½•ç¼–ç¨‹è¯­è¨€éƒ½æ— æ³•ä¿è¯ä¸å‘ç”Ÿäººä¸ºçš„å†…å­˜æ³„æ¼ï¼Œæ¯”å¦‚ç¨‹åºåœ¨è¿è¡Œæ—¶ï¼Œå¼€å‘è€…ç–å¿½äº†ï¼Œå¯¹å“ˆå¸Œè¡¨åªæ·»åŠ ä¸åˆ é™¤ï¼Œå°±ä¼šé€ æˆå†…å­˜æ³„æ¼ã€‚ä½† Rust ä¼šä¿è¯å³ä½¿å¼€å‘è€…ç–å¿½äº†ï¼Œä¹Ÿä¸ä¼šå‡ºç°å†…å­˜å®‰å…¨é—®é¢˜ã€‚</p><p>å»ºè®®ä½ ä»”ç»†é˜…è¯»è¿™æ®µä»£ç ä¸­çš„æ³¨é‡Šï¼Œè¯•ç€æŠŠæ³¨é‡Šæ‰çš„ Drop trait æ¢å¤ï¼Œç„¶åå†æŠŠä»£ç æ”¹å¾—å¯ä»¥ç¼–è¯‘é€šè¿‡ï¼Œè®¤çœŸæ€è€ƒä¸€ä¸‹ Rust è¿™æ ·åšçš„è‰¯è‹¦ç”¨å¿ƒã€‚</p><h2>æ ‡è®° traitï¼šSized / Send / Sync / Unpin</h2><p>å¥½ï¼Œè®²å®Œå†…å­˜ç›¸å…³çš„ä¸»è¦ traitï¼Œæ¥çœ‹æ ‡è®° traitã€‚</p><p>åˆšæ‰æˆ‘ä»¬å·²ç»çœ‹åˆ°äº†ä¸€ä¸ªæ ‡è®° traitï¼šCopyã€‚Rust è¿˜æ”¯æŒå…¶å®ƒå‡ ç§æ ‡è®° traitï¼š<a href=\"https://doc.rust-lang.org/std/marker/trait.Sized.html\">Sized</a> / <a href=\"https://doc.rust-lang.org/std/marker/trait.Send.html\">Send</a> / <a href=\"https://doc.rust-lang.org/std/marker/trait.Sync.html\">Sync</a> / <a href=\"https://doc.rust-lang.org/std/marker/trait.Unpin.html\">Unpin</a>ã€‚</p><p>Sized trait ç”¨äºæ ‡è®°æœ‰å…·ä½“å¤§å°çš„ç±»å‹ã€‚åœ¨ä½¿ç”¨æ³›å‹å‚æ•°æ—¶ï¼ŒRust ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨ä¸ºæ³›å‹å‚æ•°åŠ ä¸Š Sized çº¦æŸï¼Œæ¯”å¦‚ä¸‹é¢çš„ Data&lt;T&gt; å’Œå¤„ç† Data&lt;T&gt; çš„å‡½æ•° process_dataï¼š</p><pre><code class=\"language-rust\">struct Data&lt;T&gt; {\n    inner: T,\n}\n\nfn process_data&lt;T&gt;(data: Data&lt;T&gt;) {\n    todo!();\n}\n</code></pre><p>å®ƒç­‰ä»·äºï¼š</p><pre><code class=\"language-rust\">struct Data&lt;T: Sized&gt; {\n    inner: T,\n}\n\nfn process_data&lt;T: Sized&gt;(data: Data&lt;T&gt;) {\n    todo!();\n}\n</code></pre><p>å¤§éƒ¨åˆ†æ—¶å€™ï¼Œæˆ‘ä»¬éƒ½å¸Œæœ›èƒ½è‡ªåŠ¨æ·»åŠ è¿™æ ·çš„çº¦æŸï¼Œå› ä¸ºè¿™æ ·å®šä¹‰å‡ºçš„æ³›å‹ç»“æ„ï¼Œåœ¨ç¼–è¯‘æœŸï¼Œå¤§å°æ˜¯å›ºå®šçš„ï¼Œå¯ä»¥ä½œä¸ºå‚æ•°ä¼ é€’ç»™å‡½æ•°ã€‚å¦‚æœæ²¡æœ‰è¿™ä¸ªçº¦æŸï¼ŒT æ˜¯å¤§å°ä¸å›ºå®šçš„ç±»å‹ï¼Œ process_data å‡½æ•°ä¼šæ— æ³•ç¼–è¯‘ã€‚</p><p>ä½†æ˜¯è¿™ä¸ªè‡ªåŠ¨æ·»åŠ çš„çº¦æŸæœ‰æ—¶å€™ä¸å¤ªé€‚ç”¨ï¼Œ<strong>åœ¨å°‘æ•°æƒ…å†µä¸‹ï¼Œéœ€è¦ T æ˜¯å¯å˜ç±»å‹çš„ï¼Œæ€ä¹ˆåŠï¼ŸRust æä¾›äº† ?Sized æ¥æ‘†è„±è¿™ä¸ªçº¦æŸ</strong>ã€‚</p><p>å¦‚æœå¼€å‘è€…æ˜¾å¼å®šä¹‰äº†<code>T: ?Sized</code>ï¼Œé‚£ä¹ˆ T å°±å¯ä»¥æ˜¯ä»»æ„å¤§å°ã€‚å¦‚æœä½ å¯¹ï¼ˆ<a href=\"https://time.geekbang.org/column/article/420021\">ç¬¬12è®²</a>ï¼‰ä¹‹å‰è¯´çš„ Cow è¿˜æœ‰å°è±¡ï¼Œå¯èƒ½ä¼šè®°å¾— Cow ä¸­æ³›å‹å‚æ•° B çš„çº¦æŸæ˜¯ ?Sizedï¼š</p><pre><code class=\"language-rust\">pub enum Cow&lt;'a, B: ?Sized + 'a&gt; where B: ToOwned,\n{\n    // å€Ÿç”¨çš„æ•°æ®\n    Borrowed(&amp;'a B),\n    // æ‹¥æœ‰çš„æ•°æ®\n    Owned(&lt;B as ToOwned&gt;::Owned),\n}\n</code></pre><p>è¿™æ · B å°±å¯ä»¥æ˜¯ [T] æˆ–è€… str ç±»å‹ï¼Œå¤§å°éƒ½æ˜¯ä¸å›ºå®šçš„ã€‚è¦æ³¨æ„ Borrowed(&amp;'a B) å¤§å°æ˜¯å›ºå®šçš„ï¼Œå› ä¸ºå®ƒå†…éƒ¨æ˜¯å¯¹ B çš„ä¸€ä¸ªå¼•ç”¨ï¼Œè€Œå¼•ç”¨çš„å¤§å°æ˜¯å›ºå®šçš„ã€‚</p><h3>Send / Sync</h3><p>è¯´å®Œäº† Sizedï¼Œæˆ‘ä»¬å†æ¥çœ‹ Send / Syncï¼Œå®šä¹‰æ˜¯ï¼š</p><pre><code class=\"language-rust\">pub unsafe auto trait Send {}\npub unsafe auto trait Sync {}\n</code></pre><p>è¿™ä¸¤ä¸ª trait éƒ½æ˜¯ unsafe auto traitï¼Œauto æ„å‘³ç€ç¼–è¯‘å™¨ä¼šåœ¨åˆé€‚çš„åœºåˆï¼Œè‡ªåŠ¨ä¸ºæ•°æ®ç»“æ„æ·»åŠ å®ƒä»¬çš„å®ç°ï¼Œè€Œ unsafe ä»£è¡¨å®ç°çš„è¿™ä¸ª trait å¯èƒ½ä¼šè¿èƒŒ Rust çš„å†…å­˜å®‰å…¨å‡†åˆ™ï¼Œå¦‚æœå¼€å‘è€…æ‰‹å·¥å®ç°è¿™ä¸¤ä¸ª trait ï¼Œè¦è‡ªå·±ä¸ºå®ƒä»¬çš„å®‰å…¨æ€§è´Ÿè´£ã€‚</p><p>Send/Sync æ˜¯ Rust å¹¶å‘å®‰å…¨çš„åŸºç¡€ï¼š</p><ul>\n<li>å¦‚æœä¸€ä¸ªç±»å‹ T å®ç°äº† Send traitï¼Œæ„å‘³ç€ T å¯ä»¥å®‰å…¨åœ°ä»ä¸€ä¸ªçº¿ç¨‹ç§»åŠ¨åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯è¯´æ‰€æœ‰æƒå¯ä»¥åœ¨çº¿ç¨‹é—´ç§»åŠ¨ã€‚</li>\n<li>å¦‚æœä¸€ä¸ªç±»å‹ T å®ç°äº† Sync traitï¼Œåˆ™æ„å‘³ç€ &amp;T å¯ä»¥å®‰å…¨åœ°åœ¨å¤šä¸ªçº¿ç¨‹ä¸­å…±äº«ã€‚ä¸€ä¸ªç±»å‹ T æ»¡è¶³ Sync traitï¼Œå½“ä¸”ä»…å½“ &amp;T æ»¡è¶³ Send traitã€‚</li>\n</ul><p>å¯¹äº Send/Sync åœ¨çº¿ç¨‹å®‰å…¨ä¸­çš„ä½œç”¨ï¼Œå¯ä»¥è¿™ä¹ˆçœ‹ï¼Œ<strong>å¦‚æœä¸€ä¸ªç±»å‹T: Sendï¼Œé‚£ä¹ˆ T åœ¨æŸä¸ªçº¿ç¨‹ä¸­çš„ç‹¬å è®¿é—®æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼›å¦‚æœä¸€ä¸ªç±»å‹ T: Syncï¼Œé‚£ä¹ˆ T åœ¨çº¿ç¨‹é—´çš„åªè¯»å…±äº«æ˜¯å®‰å…¨çš„</strong>ã€‚</p><p>å¯¹äºæˆ‘ä»¬è‡ªå·±å®šä¹‰çš„æ•°æ®ç»“æ„ï¼Œå¦‚æœå…¶å†…éƒ¨çš„æ‰€æœ‰åŸŸéƒ½å®ç°äº† Send / Syncï¼Œé‚£ä¹ˆè¿™ä¸ªæ•°æ®ç»“æ„ä¼šè¢«è‡ªåŠ¨æ·»åŠ  Send / Sync ã€‚åŸºæœ¬ä¸ŠåŸç”Ÿæ•°æ®ç»“æ„éƒ½æ”¯æŒ Send / Syncï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç»å¤§å¤šæ•°è‡ªå®šä¹‰çš„æ•°æ®ç»“æ„éƒ½æ˜¯æ»¡è¶³ Send / Sync çš„ã€‚æ ‡å‡†åº“ä¸­ï¼Œä¸æ”¯æŒ Send / Sync çš„æ•°æ®ç»“æ„ä¸»è¦æœ‰ï¼š</p><ul>\n<li>è£¸æŒ‡é’ˆ *const T / *mut Tã€‚å®ƒä»¬æ˜¯ä¸å®‰å…¨çš„ï¼Œæ‰€ä»¥æ—¢ä¸æ˜¯ Send ä¹Ÿä¸æ˜¯ Syncã€‚</li>\n<li>UnsafeCell&lt;T&gt; ä¸æ”¯æŒ Syncã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä»»ä½•ä½¿ç”¨äº† Cell æˆ–è€… RefCell çš„æ•°æ®ç»“æ„ä¸æ”¯æŒ Syncã€‚</li>\n<li>å¼•ç”¨è®¡æ•° Rc ä¸æ”¯æŒ Send ä¹Ÿä¸æ”¯æŒ Syncã€‚æ‰€ä»¥ Rc æ— æ³•è·¨çº¿ç¨‹ã€‚</li>\n</ul><p>ä¹‹å‰ä»‹ç»è¿‡ Rc / RefCellï¼ˆ<a href=\"https://time.geekbang.org/column/article/416722\">ç¬¬9è®²</a>ï¼‰ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ï¼Œå¦‚æœå°è¯•è·¨çº¿ç¨‹ä½¿ç”¨ Rc / RefCellï¼Œä¼šå‘ç”Ÿä»€ä¹ˆã€‚åœ¨ Rust ä¸‹ï¼Œå¦‚æœæƒ³åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œéœ€è¦ä½¿ç”¨ <a href=\"https://doc.rust-lang.org/std/thread/fn.spawn.html\">std::thread::spawn</a>ï¼š</p><pre><code class=\"language-rust\">pub fn spawn&lt;F, T&gt;(f: F) -&gt; JoinHandle&lt;T&gt; \nwhere\n    F: FnOnce() -&gt; T,\n    F: Send + 'static,\n    T: Send + 'static,\n</code></pre><p>å®ƒçš„å‚æ•°æ˜¯ä¸€ä¸ªé—­åŒ…ï¼ˆåé¢ä¼šè®²ï¼‰ï¼Œè¿™ä¸ªé—­åŒ…éœ€è¦ Send + 'staticï¼š</p><ul>\n<li>'static æ„æ€æ˜¯é—­åŒ…æ•è·çš„è‡ªç”±å˜é‡å¿…é¡»æ˜¯ä¸€ä¸ªæ‹¥æœ‰æ‰€æœ‰æƒçš„ç±»å‹ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªæ‹¥æœ‰é™æ€ç”Ÿå‘½å‘¨æœŸçš„å¼•ç”¨ï¼›</li>\n<li>Send æ„æ€æ˜¯ï¼Œè¿™äº›è¢«æ•è·è‡ªç”±å˜é‡çš„æ‰€æœ‰æƒå¯ä»¥ä»ä¸€ä¸ªçº¿ç¨‹ç§»åŠ¨åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ã€‚</li>\n</ul><p>ä»è¿™ä¸ªæ¥å£ä¸Šï¼Œå¯ä»¥å¾—å‡ºç»“è®ºï¼šå¦‚æœåœ¨çº¿ç¨‹é—´ä¼ é€’ Rcï¼Œæ˜¯æ— æ³•ç¼–è¯‘é€šè¿‡çš„ï¼Œå› ä¸º <a href=\"https://doc.rust-lang.org/std/rc/struct.Rc.html#impl-Send\">Rc çš„å®ç°ä¸æ”¯æŒ Send å’Œ Sync</a>ã€‚å†™æ®µä»£ç éªŒè¯ä¸€ä¸‹ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=9892c9cd4baa26dcfcca99e4e4869cc5\">ä»£ç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">// Rc æ—¢ä¸æ˜¯ Sendï¼Œä¹Ÿä¸æ˜¯ Sync\nfn rc_is_not_send_and_sync() {\n    let a = Rc::new(1);\n    let b = a.clone();\n    let c = a.clone();\n    thread::spawn(move || {\n        println!(\"c= {:?}\", c);\n    });\n}\n</code></pre><p>æœç„¶ï¼Œè¿™æ®µä»£ç ä¸é€šè¿‡ã€‚<br>\n<img src=\"https://static001.geekbang.org/resource/image/13/e6/131b21c05850e8f5070d952a777613e6.jpg?wh=2667x1268\" alt=\"\"></p><p>é‚£ä¹ˆï¼ŒRefCell&lt;T&gt; å¯ä»¥åœ¨çº¿ç¨‹é—´è½¬ç§»æ‰€æœ‰æƒä¹ˆï¼Ÿ<a href=\"https://doc.rust-lang.org/std/cell/struct.RefCell.html#impl-Send\">RefCell å®ç°äº† Sendï¼Œä½†æ²¡æœ‰å®ç° Sync</a>ï¼Œæ‰€ä»¥ï¼Œçœ‹èµ·æ¥æ˜¯å¯ä»¥å·¥ä½œçš„ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=1a820a1bd4eca214956e85a1333e5df0\">ä»£ç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">fn refcell_is_send() {\n    let a = RefCell::new(1);\n    thread::spawn(move || {\n        println!(\"a= {:?}\", a);\n    });\n}\n</code></pre><p>éªŒè¯ä¸€ä¸‹å‘ç°ï¼Œè¿™æ˜¯ OK çš„ã€‚</p><p>æ—¢ç„¶ Rc ä¸èƒ½ Sendï¼Œæˆ‘ä»¬æ— æ³•è·¨çº¿ç¨‹ä½¿ç”¨ Rc&lt;RefCell&lt;T&gt;&gt; è¿™æ ·çš„æ•°æ®ï¼Œé‚£ä¹ˆä½¿ç”¨<a href=\"https://doc.rust-lang.org/std/sync/struct.Arc.html#impl-Send\">æ”¯æŒ Send/Sync çš„ Arc</a>å‘¢ï¼Œä½¿ç”¨ Arc&lt;RefCell&lt;T&gt;&gt; æ¥è·å¾—ï¼Œä¸€ä¸ªå¯ä»¥åœ¨å¤šçº¿ç¨‹é—´å…±äº«ï¼Œä¸”å¯ä»¥ä¿®æ”¹çš„ç±»å‹ï¼Œå¯ä»¥ä¹ˆï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=16b78ecc207cbae4a511a316681ad49e\">ä»£ç </a>ï¼‰ï¼Ÿ</p><pre><code class=\"language-rust\">// RefCell ç°åœ¨æœ‰å¤šä¸ª Arc æŒæœ‰å®ƒï¼Œè™½ç„¶ Arc æ˜¯ Send/Syncï¼Œä½† RefCell ä¸æ˜¯ Sync\nfn refcell_is_not_sync() {\n    let a = Arc::new(RefCell::new(1));\n    let b = a.clone();\n    let c = a.clone();\n    thread::spawn(move || {\n        println!(\"c= {:?}\", c);\n    });\n}\n</code></pre><p>ä¸å¯ä»¥ã€‚</p><p>å› ä¸º Arc å†…éƒ¨çš„æ•°æ®æ˜¯å…±äº«çš„ï¼Œéœ€è¦æ”¯æŒ Sync çš„æ•°æ®ç»“æ„ï¼Œä½†æ˜¯RefCell ä¸æ˜¯ Syncï¼Œç¼–è¯‘å¤±è´¥ã€‚æ‰€ä»¥åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åªèƒ½ä½¿ç”¨æ”¯æŒ Send/Sync çš„ Arc ï¼Œå’Œ Mutex ä¸€èµ·ï¼Œæ„é€ ä¸€ä¸ªå¯ä»¥åœ¨å¤šçº¿ç¨‹é—´å…±äº«ä¸”å¯ä»¥ä¿®æ”¹çš„ç±»å‹ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=e20084ea53dbd030e3f75ce0b07b6421\">ä»£ç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">use std::{\n    sync::{Arc, Mutex},\n    thread,\n};\n\n// Arc&lt;Mutex&lt;T&gt;&gt; å¯ä»¥å¤šçº¿ç¨‹å…±äº«ä¸”ä¿®æ”¹æ•°æ®\nfn arc_mutext_is_send_sync() {\n    let a = Arc::new(Mutex::new(1));\n    let b = a.clone();\n    let c = a.clone();\n    let handle = thread::spawn(move || {\n        let mut g = c.lock().unwrap();\n        *g += 1;\n    });\n\n    {\n        let mut g = b.lock().unwrap();\n        *g += 1;\n    }\n\n    handle.join().unwrap();\n    println!(\"a= {:?}\", a);\n}\n\nfn main() {\n    arc_mutext_is_send_sync();\n}\n</code></pre><p>è¿™å‡ æ®µä»£ç å»ºè®®ä½ éƒ½å¥½å¥½é˜…è¯»å’Œè¿è¡Œä¸€ä¸‹ï¼Œå¯¹äºç¼–è¯‘å‡ºé”™çš„æƒ…å†µï¼Œä»”ç»†çœ‹çœ‹ç¼–è¯‘å™¨ç»™å‡ºçš„é”™è¯¯ï¼Œä¼šå¸®åŠ©ä½ ç†è§£å¥½ Send/Sync trait ä»¥åŠå®ƒä»¬å¦‚ä½•ä¿è¯å¹¶å‘å®‰å…¨ã€‚</p><p>æœ€åä¸€ä¸ªæ ‡è®° trait Unpinï¼Œæ˜¯ç”¨äºè‡ªå¼•ç”¨ç±»å‹çš„ï¼Œåœ¨åé¢è®²åˆ° Future trait æ—¶ï¼Œå†è¯¦ç»†è®²è¿™ä¸ª traitã€‚</p><h2>ç±»å‹è½¬æ¢ç›¸å…³ï¼šFrom&lt;T&gt; / Into&lt;T&gt;/AsRef&lt;T&gt; / AsMut&lt;T&gt;</h2><p>å¥½ï¼Œå­¦å®Œäº†æ ‡è®° traitï¼Œæ¥çœ‹çœ‹å’Œç±»å‹è½¬æ¢ç›¸å…³çš„ traitã€‚åœ¨è½¯ä»¶å¼€å‘çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦åœ¨æŸä¸ªä¸Šä¸‹æ–‡ä¸­ï¼ŒæŠŠä¸€ç§æ•°æ®ç»“æ„è½¬æ¢æˆå¦ä¸€ç§æ•°æ®ç»“æ„ã€‚</p><p>ä¸è¿‡è½¬æ¢æœ‰å¾ˆå¤šæ–¹å¼ï¼Œçœ‹ä¸‹é¢çš„ä»£ç ï¼Œä½ è§‰å¾—å“ªç§æ–¹å¼æ›´å¥½å‘¢ï¼Ÿ</p><pre><code class=\"language-rust\">// ç¬¬ä¸€ç§æ–¹æ³•ï¼Œä¸ºæ¯ä¸€ç§è½¬æ¢æä¾›ä¸€ä¸ªæ–¹æ³•\n// æŠŠå­—ç¬¦ä¸² s è½¬æ¢æˆ Path\nlet v = s.to_path();\n// æŠŠå­—ç¬¦ä¸² s è½¬æ¢æˆ u64\nlet v = s.to_u64();\n\n// ç¬¬äºŒç§æ–¹æ³•ï¼Œä¸º s å’Œè¦è½¬æ¢çš„ç±»å‹ä¹‹é—´å®ç°ä¸€ä¸ª Into&lt;T&gt; trait\n// v çš„ç±»å‹æ ¹æ®ä¸Šä¸‹æ–‡å¾—å‡º\nlet v = s.into();\n// æˆ–è€…ä¹Ÿå¯ä»¥æ˜¾å¼åœ°æ ‡æ³¨ v çš„ç±»å‹\nlet v: u64 = s.into();\n</code></pre><p>ç¬¬ä¸€ç§æ–¹å¼ï¼Œåœ¨ç±»å‹ T çš„å®ç°é‡Œï¼Œè¦ä¸ºæ¯ä¸€ç§å¯èƒ½çš„è½¬æ¢æä¾›ä¸€ä¸ªæ–¹æ³•ï¼›ç¬¬äºŒç§ï¼Œæˆ‘ä»¬ä¸ºç±»å‹ T å’Œç±»å‹ U ä¹‹é—´çš„è½¬æ¢å®ç°ä¸€ä¸ªæ•°æ®è½¬æ¢ traitï¼Œè¿™æ ·å¯ä»¥ç”¨åŒä¸€ä¸ªæ–¹æ³•æ¥å®ç°ä¸åŒçš„è½¬æ¢ã€‚</p><p>æ˜¾ç„¶ï¼Œç¬¬äºŒç§æ–¹æ³•è¦æ›´å¥½ï¼Œå› ä¸ºå®ƒç¬¦åˆè½¯ä»¶å¼€å‘çš„å¼€é—­åŸåˆ™ï¼ˆOpen-Close Principleï¼‰ï¼Œâ€œ<strong>è½¯ä»¶ä¸­çš„å¯¹è±¡ï¼ˆç±»ã€æ¨¡å—ã€å‡½æ•°ç­‰ç­‰ï¼‰å¯¹æ‰©å±•æ˜¯å¼€æ”¾çš„ï¼Œä½†æ˜¯å¯¹ä¿®æ”¹æ˜¯å°é—­çš„</strong>â€ã€‚</p><p>åœ¨ç¬¬ä¸€ç§æ–¹å¼ä¸‹ï¼Œæœªæ¥æ¯æ¬¡è¦æ·»åŠ å¯¹æ–°ç±»å‹çš„è½¬æ¢ï¼Œéƒ½è¦é‡æ–°ä¿®æ”¹ç±»å‹ T çš„å®ç°ï¼Œè€Œç¬¬äºŒç§æ–¹å¼ï¼Œæˆ‘ä»¬åªéœ€è¦æ·»åŠ ä¸€ä¸ªå¯¹äºæ•°æ®è½¬æ¢ trait çš„æ–°å®ç°å³å¯ã€‚</p><p>åŸºäºè¿™ä¸ªæ€è·¯ï¼Œå¯¹å€¼ç±»å‹çš„è½¬æ¢å’Œå¯¹å¼•ç”¨ç±»å‹çš„è½¬æ¢ï¼ŒRust æä¾›äº†ä¸¤å¥—ä¸åŒçš„ traitï¼š</p><ul>\n<li>å€¼ç±»å‹åˆ°å€¼ç±»å‹çš„è½¬æ¢ï¼šFrom&lt;T&gt; / Into&lt;T&gt; / TryFrom&lt;T&gt; / TryInto&lt;T&gt;</li>\n<li>å¼•ç”¨ç±»å‹åˆ°å¼•ç”¨ç±»å‹çš„è½¬æ¢ï¼šAsRef&lt;T&gt; / AsMut&lt;T&gt;</li>\n</ul><h3>From&lt;T&gt; / Into&lt;T&gt;</h3><p>å…ˆçœ‹ <a href=\"https://doc.rust-lang.org/std/convert/trait.From.html\">From&lt;T&gt;</a> å’Œ <a href=\"https://doc.rust-lang.org/std/convert/trait.Into.html\">Into&lt;T&gt;</a>ã€‚è¿™ä¸¤ä¸ª trait çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><pre><code class=\"language-rust\">pub trait From&lt;T&gt; {\n    fn from(T) -&gt; Self;\n}\n\npub trait Into&lt;T&gt; {\n    fn into(self) -&gt; T;\n}\n</code></pre><p>åœ¨å®ç° From&lt;T&gt; çš„æ—¶å€™ä¼šè‡ªåŠ¨å®ç° Into&lt;T&gt;ã€‚è¿™æ˜¯å› ä¸ºï¼š</p><pre><code class=\"language-rust\">// å®ç° From ä¼šè‡ªåŠ¨å®ç° Into\nimpl&lt;T, U&gt; Into&lt;U&gt; for T where U: From&lt;T&gt; {\n    fn into(self) -&gt; U {\n        U::from(self)\n    }\n}\n</code></pre><p>æ‰€ä»¥å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œåªç”¨å®ç° From&lt;T&gt;ï¼Œç„¶åè¿™ä¸¤ç§æ–¹å¼éƒ½èƒ½åšæ•°æ®è½¬æ¢ï¼Œæ¯”å¦‚ï¼š</p><pre><code class=\"language-rust\">let s = String::from(\"Hello world!\");\nlet s: String = \"Hello world!\".into();\n</code></pre><p>è¿™ä¸¤ç§æ–¹å¼æ˜¯ç­‰ä»·çš„ï¼Œæ€ä¹ˆé€‰å‘¢ï¼ŸFrom&lt;T&gt; å¯ä»¥æ ¹æ®ä¸Šä¸‹æ–‡åšç±»å‹æ¨å¯¼ï¼Œä½¿ç”¨åœºæ™¯æ›´å¤šï¼›è€Œä¸”å› ä¸ºå®ç°äº† From&lt;T&gt; ä¼šè‡ªåŠ¨å®ç° Into&lt;T&gt;ï¼Œåä¹‹ä¸ä¼šã€‚<strong>æ‰€ä»¥éœ€è¦çš„æ—¶å€™ï¼Œä¸è¦å»å®ç° Into&lt;T&gt;ï¼Œåªè¦å®ç° From&lt;T&gt; å°±å¥½äº†</strong>ã€‚</p><p>æ­¤å¤–ï¼ŒFrom&lt;T&gt; å’Œ Into&lt;T&gt; è¿˜æ˜¯è‡ªåçš„ï¼šæŠŠç±»å‹ T çš„å€¼è½¬æ¢æˆç±»å‹ Tï¼Œä¼šç›´æ¥è¿”å›ã€‚è¿™æ˜¯å› ä¸ºæ ‡å‡†åº“æœ‰å¦‚ä¸‹çš„å®ç°ï¼š</p><pre><code class=\"language-rust\">// Fromï¼ˆä»¥åŠ Intoï¼‰æ˜¯è‡ªåçš„\nimpl&lt;T&gt; From&lt;T&gt; for T {\n    fn from(t: T) -&gt; T {\n        t\n    }\n}\n</code></pre><p>æœ‰äº† From&lt;T&gt; å’Œ Into&lt;T&gt;ï¼Œå¾ˆå¤šå‡½æ•°çš„æ¥å£å°±å¯ä»¥å˜å¾—çµæ´»ï¼Œæ¯”å¦‚å‡½æ•°å¦‚æœæ¥å—ä¸€ä¸ª IpAddr ä¸ºå‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Into&lt;IpAddr&gt; è®©æ›´å¤šçš„ç±»å‹å¯ä»¥è¢«è¿™ä¸ªå‡½æ•°ä½¿ç”¨ï¼Œçœ‹ä¸‹é¢çš„<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=f8be081138a8bb2c736e30badcc5ae41\">ä»£ç </a>ï¼š</p><pre><code class=\"language-rust\">use std::net::{IpAddr, Ipv4Addr, Ipv6Addr};\n\nfn print(v: impl Into&lt;IpAddr&gt;) {\n    println!(\"{:?}\", v.into());\n}\n\nfn main() {\n    let v4: Ipv4Addr = \"2.2.2.2\".parse().unwrap();\n    let v6: Ipv6Addr = \"::1\".parse().unwrap();\n    \n    // IPAddr å®ç°äº† From&lt;[u8; 4]ï¼Œè½¬æ¢ IPv4 åœ°å€\n    print([1, 1, 1, 1]);\n    // IPAddr å®ç°äº† From&lt;[u16; 8]ï¼Œè½¬æ¢ IPv6 åœ°å€\n    print([0xfe80, 0, 0, 0, 0xaede, 0x48ff, 0xfe00, 0x1122]);\n    // IPAddr å®ç°äº† From&lt;Ipv4Addr&gt;\n    print(v4);\n    // IPAddr å®ç°äº† From&lt;Ipv6Addr&gt;\n    print(v6);\n}\n</code></pre><p>æ‰€ä»¥ï¼Œåˆç†åœ°ä½¿ç”¨ From&lt;T&gt; / Into&lt;T&gt;ï¼Œå¯ä»¥è®©ä»£ç å˜å¾—ç®€æ´ï¼Œç¬¦åˆ Rust å¯è¯»æ€§å¼ºçš„é£æ ¼ï¼Œæ›´ç¬¦åˆå¼€é—­åŸåˆ™ã€‚</p><p>æ³¨æ„ï¼Œå¦‚æœä½ çš„æ•°æ®ç±»å‹åœ¨è½¬æ¢è¿‡ç¨‹ä¸­æœ‰å¯èƒ½å‡ºç°é”™è¯¯ï¼Œå¯ä»¥ä½¿ç”¨ <a href=\"https://doc.rust-lang.org/std/convert/trait.TryFrom.html\">TryFrom&lt;T&gt;</a> å’Œ <a href=\"https://doc.rust-lang.org/std/convert/trait.TryInto.html\">TryInto&lt;T&gt;</a>ï¼Œå®ƒä»¬çš„ç”¨æ³•å’Œ From&lt;T&gt; / Into&lt;T&gt; ä¸€æ ·ï¼Œåªæ˜¯ trait å†…å¤šäº†ä¸€ä¸ªå…³è”ç±»å‹ Errorï¼Œä¸”è¿”å›çš„ç»“æœæ˜¯ Result&lt;T, Self::Error&gt;ã€‚</p><h3>AsRef&lt;T&gt; / AsMut&lt;T&gt;</h3><p>ææ˜ç™½äº† From&lt;T&gt; / Into&lt;T&gt; åï¼ŒAsRef&lt;T&gt; å’Œ AsMut&lt;T&gt; å°±å¾ˆå¥½ç†è§£äº†ï¼Œç”¨äºä»å¼•ç”¨åˆ°å¼•ç”¨çš„è½¬æ¢ã€‚è¿˜æ˜¯å…ˆçœ‹å®ƒä»¬çš„å®šä¹‰ï¼š</p><pre><code class=\"language-rust\">pub trait AsRef&lt;T&gt; where T: ?Sized {\n    fn as_ref(&amp;self) -&gt; &amp;T;\n}\n\npub trait AsMut&lt;T&gt; where T: ?Sized {\n    fn as_mut(&amp;mut self) -&gt; &amp;mut T;\n}\n</code></pre><p>åœ¨ trait çš„å®šä¹‰ä¸Šï¼Œéƒ½å…è®¸ T ä½¿ç”¨å¤§å°å¯å˜çš„ç±»å‹ï¼Œå¦‚ strã€[u8] ç­‰ã€‚AsMut&lt;T&gt; é™¤äº†ä½¿ç”¨å¯å˜å¼•ç”¨ç”Ÿæˆå¯å˜å¼•ç”¨å¤–ï¼Œå…¶å®ƒéƒ½å’Œ AsRef&lt;T&gt; ä¸€æ ·ï¼Œæ‰€ä»¥æˆ‘ä»¬é‡ç‚¹çœ‹ AsRef&lt;T&gt;ã€‚</p><p>çœ‹æ ‡å‡†åº“ä¸­æ‰“å¼€æ–‡ä»¶çš„æ¥å£ <a href=\"https://doc.rust-lang.org/std/fs/struct.File.html#method.open\">std::fs::File::open</a>ï¼š</p><pre><code class=\"language-rust\">pub fn open&lt;P: AsRef&lt;Path&gt;&gt;(path: P) -&gt; Result&lt;File&gt;\n</code></pre><p>å®ƒçš„å‚æ•° path æ˜¯ç¬¦åˆ AsRef&lt;Path&gt; çš„ç±»å‹ï¼Œæ‰€ä»¥ï¼Œä½ å¯ä»¥ä¸ºè¿™ä¸ªå‚æ•°ä¼ å…¥ Stringã€&amp;strã€PathBufã€Path ç­‰ç±»å‹ã€‚è€Œä¸”ï¼Œå½“ä½ ä½¿ç”¨ path.as_ref() æ—¶ï¼Œä¼šå¾—åˆ°ä¸€ä¸ª &amp;Pathã€‚</p><p>æ¥å†™ä¸€æ®µä»£ç ä½“éªŒä¸€ä¸‹ AsRef&lt;T&gt; çš„ä½¿ç”¨å’Œå®ç°ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=176092de75680a60821d6523e6340773\">ä»£ç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">#[allow(dead_code)]\nenum Language {\n    Rust,\n    TypeScript,\n    Elixir,\n    Haskell,\n}\n\nimpl AsRef&lt;str&gt; for Language {\n    fn as_ref(&amp;self) -&gt; &amp;str {\n        match self {\n            Language::Rust =&gt; \"Rust\",\n            Language::TypeScript =&gt; \"TypeScript\",\n            Language::Elixir =&gt; \"Elixir\",\n            Language::Haskell =&gt; \"Haskell\",\n        }\n    }\n}\n\nfn print_ref(v: impl AsRef&lt;str&gt;) {\n    println!(\"{}\", v.as_ref());\n}\n\nfn main() {\n    let lang = Language::Rust;\n    // &amp;str å®ç°äº† AsRef&lt;str&gt;\n    print_ref(\"Hello world!\");\n    // String å®ç°äº† AsRef&lt;str&gt;\n    print_ref(\"Hello world!\".to_string());\n    // æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„ enum ä¹Ÿå®ç°äº† AsRef&lt;str&gt;\n    print_ref(lang);\n}\n</code></pre><p>ç°åœ¨å¯¹åœ¨ Rust ä¸‹ï¼Œå¦‚ä½•ä½¿ç”¨ From / Into / AsRef / AsMut è¿›è¡Œç±»å‹é—´è½¬æ¢ï¼Œæœ‰äº†æ·±å…¥äº†è§£ï¼Œæœªæ¥æˆ‘ä»¬è¿˜ä¼šåœ¨å®æˆ˜ä¸­ä½¿ç”¨åˆ°è¿™äº› traitã€‚</p><p>åˆšæ‰çš„å°ä¾‹å­ä¸­è¦é¢å¤–è¯´æ˜ä¸€ä¸‹çš„æ˜¯ï¼Œå¦‚æœä½ çš„ä»£ç å‡ºç° v.as_ref().clone() è¿™æ ·çš„è¯­å¥ï¼Œä¹Ÿå°±æ˜¯è¯´ä½ è¦å¯¹ v è¿›è¡Œå¼•ç”¨è½¬æ¢ï¼Œç„¶ååˆå¾—åˆ°äº†æ‹¥æœ‰æ‰€æœ‰æƒçš„å€¼ï¼Œé‚£ä¹ˆä½ åº”è¯¥å®ç° From&lt;T&gt;ï¼Œç„¶ååš v.into()ã€‚</p><h2>æ“ä½œç¬¦ç›¸å…³ï¼šDeref / DerefMut</h2><p>æ“ä½œç¬¦ç›¸å…³çš„ trait ï¼Œä¸Šä¸€è®²æˆ‘ä»¬å·²ç»çœ‹åˆ°äº† Add&lt;Rhs&gt; traitï¼Œå®ƒå…è®¸ä½ é‡è½½åŠ æ³•è¿ç®—ç¬¦ã€‚Rust ä¸ºæ‰€æœ‰çš„è¿ç®—ç¬¦éƒ½æä¾›äº† traitï¼Œä½ å¯ä»¥ä¸ºè‡ªå·±çš„ç±»å‹é‡è½½æŸäº›æ“ä½œç¬¦ã€‚è¿™é‡Œç”¨ä¸‹å›¾ç®€å•æ¦‚æ‹¬ä¸€ä¸‹ï¼Œæ›´è¯¦ç»†çš„ä¿¡æ¯ä½ å¯ä»¥é˜…è¯»<a href=\"https://doc.rust-lang.org/std/ops/index.html\">å®˜æ–¹æ–‡æ¡£</a>ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/a2/19/a28619aae702e186aa115af94300dc19.jpg?wh=2743x1515\" alt=\"\"></p><p>ä»Šå¤©é‡ç‚¹è¦ä»‹ç»çš„æ“ä½œç¬¦æ˜¯ <a href=\"https://doc.rust-lang.org/std/ops/trait.Deref.html\">Deref</a> å’Œ <a href=\"https://doc.rust-lang.org/std/ops/trait.DerefMut.html\">DerefMut</a>ã€‚æ¥çœ‹å®ƒä»¬çš„å®šä¹‰ï¼š</p><pre><code class=\"language-rust\">pub trait Deref {\n    // è§£å¼•ç”¨å‡ºæ¥çš„ç»“æœç±»å‹\n    type Target: ?Sized;\n    fn deref(&amp;self) -&gt; &amp;Self::Target;\n}\n\npub trait DerefMut: Deref {\n    fn deref_mut(&amp;mut self) -&gt; &amp;mut Self::Target;\n}\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼ŒDerefMut â€œç»§æ‰¿â€äº† Derefï¼Œåªæ˜¯å®ƒé¢å¤–æä¾›äº†ä¸€ä¸ª deref_mut æ–¹æ³•ï¼Œç”¨æ¥è·å–å¯å˜çš„è§£å¼•ç”¨ã€‚æ‰€ä»¥è¿™é‡Œé‡ç‚¹å­¦ä¹  Derefã€‚</p><p>å¯¹äºæ™®é€šçš„å¼•ç”¨ï¼Œè§£å¼•ç”¨å¾ˆç›´è§‚ï¼Œå› ä¸ºå®ƒåªæœ‰ä¸€ä¸ªæŒ‡å‘å€¼çš„åœ°å€ï¼Œä»è¿™ä¸ªåœ°å€å¯ä»¥è·å–åˆ°æ‰€éœ€è¦çš„å€¼ï¼Œæ¯”å¦‚ä¸‹é¢çš„ä¾‹å­ï¼š</p><pre><code class=\"language-rust\">let mut x = 42;\nlet y = &amp;mut x;\n// è§£å¼•ç”¨ï¼Œå†…éƒ¨è°ƒç”¨ DerefMutï¼ˆå…¶å®ç°å°±æ˜¯ *selfï¼‰\n*y += 1;\n</code></pre><p>ä½†å¯¹æ™ºèƒ½æŒ‡é’ˆæ¥è¯´ï¼Œæ‹¿ä»€ä¹ˆåŸŸæ¥è§£å¼•ç”¨å°±ä¸é‚£ä¹ˆç›´è§‚äº†ï¼Œæˆ‘ä»¬æ¥çœ‹ä¹‹å‰å­¦è¿‡çš„ Rc æ˜¯æ€ä¹ˆå®ç° Deref çš„ï¼š</p><pre><code class=\"language-rust\">impl&lt;T: ?Sized&gt; Deref for Rc&lt;T&gt; {\n    type Target = T;\n\n    fn deref(&amp;self) -&gt; &amp;T {\n        &amp;self.inner().value\n    }\n}\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œå®ƒæœ€ç»ˆæŒ‡å‘äº†å †ä¸Šçš„ RcBox å†…éƒ¨çš„ value çš„åœ°å€ï¼Œç„¶åå¦‚æœå¯¹å…¶è§£å¼•ç”¨çš„è¯ï¼Œå¾—åˆ°äº† value å¯¹åº”çš„å€¼ã€‚ä»¥ä¸‹å›¾ä¸ºä¾‹ï¼Œæœ€ç»ˆæ‰“å°å‡º v = 1ã€‚<br>\n<img src=\"https://static001.geekbang.org/resource/image/50/d1/5068f84af27d696f6a062c5a2f43f4d1.jpg?wh=2755x1487\" alt=\"\"></p><p>ä»å›¾ä¸­è¿˜å¯ä»¥çœ‹åˆ°ï¼ŒDeref å’Œ DerefMut æ˜¯è‡ªåŠ¨è°ƒç”¨çš„ï¼Œ*b ä¼šè¢«å±•å¼€ä¸º *(b.deref())ã€‚</p><p>åœ¨ Rust é‡Œï¼Œç»å¤§å¤šæ•°æ™ºèƒ½æŒ‡é’ˆéƒ½å®ç°äº† Derefï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä¸ºè‡ªå·±çš„æ•°æ®ç»“æ„å®ç° Derefã€‚çœ‹ä¸€ä¸ªä¾‹å­ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=084d38d49c6b29d6074a2c4570551601\">ä»£ç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">use std::ops::{Deref, DerefMut};\n\n#[derive(Debug)]\nstruct Buffer&lt;T&gt;(Vec&lt;T&gt;);\n\nimpl&lt;T&gt; Buffer&lt;T&gt; {\n    pub fn new(v: impl Into&lt;Vec&lt;T&gt;&gt;) -&gt; Self {\n        Self(v.into())\n    }\n}\n\nimpl&lt;T&gt; Deref for Buffer&lt;T&gt; {\n    type Target = [T];\n\n    fn deref(&amp;self) -&gt; &amp;Self::Target {\n        &amp;self.0\n    }\n}\n\nimpl&lt;T&gt; DerefMut for Buffer&lt;T&gt; {\n    fn deref_mut(&amp;mut self) -&gt; &amp;mut Self::Target {\n        &amp;mut self.0\n    }\n}\n\nfn main() {\n    let mut buf = Buffer::new([1, 3, 2, 4]);\n    // å› ä¸ºå®ç°äº† Deref å’Œ DerefMutï¼Œè¿™é‡Œ buf å¯ä»¥ç›´æ¥è®¿é—® Vec&lt;T&gt; çš„æ–¹æ³•\n    // ä¸‹é¢è¿™å¥ç›¸å½“äºï¼š(&amp;mut buf).deref_mut().sort()ï¼Œä¹Ÿå°±æ˜¯ (&amp;mut buf.0).sort()\n    buf.sort();\n    println!(\"buf: {:?}\", buf);\n}\n</code></pre><p>ä½†æ˜¯åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œæ•°æ®ç»“æ„ Buffer&lt;T&gt; åŒ…è£¹ä½äº† Vec&lt;T&gt;ï¼Œä½†è¿™æ ·ä¸€æ¥ï¼ŒåŸæœ¬ Vec&lt;T&gt; å®ç°äº†çš„å¾ˆå¤šæ–¹æ³•ï¼Œç°åœ¨ä½¿ç”¨èµ·æ¥å°±å¾ˆä¸æ–¹ä¾¿ï¼Œéœ€è¦ç”¨ buf.0 æ¥è®¿é—®ã€‚æ€ä¹ˆåŠï¼Ÿ</p><p><strong>å¯ä»¥å®ç° Deref å’Œ DerefMutï¼Œè¿™æ ·åœ¨è§£å¼•ç”¨çš„æ—¶å€™ï¼Œç›´æ¥è®¿é—®åˆ° buf.0</strong>ï¼Œçœå»äº†ä»£ç çš„å•°å—¦å’Œæ•°æ®ç»“æ„å†…éƒ¨å­—æ®µçš„éšè—ã€‚</p><p>åœ¨è¿™æ®µä»£ç é‡Œï¼Œè¿˜æœ‰ä¸€ä¸ªå€¼å¾—æ³¨æ„çš„åœ°æ–¹ï¼šå†™ buf.sort() çš„æ—¶å€™ï¼Œå¹¶æ²¡æœ‰åšè§£å¼•ç”¨çš„æ“ä½œï¼Œä¸ºä»€ä¹ˆä¼šç›¸å½“äºè®¿é—®äº† buf.0.sort() å‘¢ï¼Ÿè¿™æ˜¯å› ä¸º sort() æ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ &amp;mut selfï¼Œæ­¤æ—¶ Rust ç¼–è¯‘å™¨ä¼šå¼ºåˆ¶åš Deref/DerefMut çš„è§£å¼•ç”¨ï¼Œæ‰€ä»¥è¿™ç›¸å½“äº (*(&amp;mut buf)).sort()ã€‚</p><h2>å…¶å®ƒï¼šDebug / Display / Default</h2><p>ç°åœ¨æˆ‘ä»¬å¯¹è¿ç®—ç¬¦ç›¸å…³çš„ trait æœ‰äº†è¶³å¤Ÿçš„äº†è§£ï¼Œæœ€åæ¥çœ‹çœ‹å…¶å®ƒä¸€äº›å¸¸ç”¨çš„ traitï¼š<a href=\"https://doc.rust-lang.org/std/fmt/trait.Debug.html\">Debug</a> / <a href=\"https://doc.rust-lang.org/std/fmt/trait.Display.html\">Display</a> / <a href=\"https://doc.rust-lang.org/std/default/trait.Default.html\">Default</a>ã€‚</p><p>å…ˆçœ‹ Debug / Displayï¼Œå®ƒä»¬çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><pre><code class=\"language-rust\">pub trait Debug {\n    fn fmt(&amp;self, f: &amp;mut Formatter&lt;'_&gt;) -&gt; Result&lt;(), Error&gt;;\n}\n\npub trait Display {\n    fn fmt(&amp;self, f: &amp;mut Formatter&lt;'_&gt;) -&gt; Result&lt;(), Error&gt;;\n}\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼ŒDebug å’Œ Display ä¸¤ä¸ª trait çš„ç­¾åä¸€æ ·ï¼Œéƒ½æ¥å—ä¸€ä¸ª &amp;self å’Œä¸€ä¸ª &amp;mut Formatterã€‚é‚£ä¸ºä»€ä¹ˆè¦æœ‰ä¸¤ä¸ªä¸€æ ·çš„ trait å‘¢ï¼Ÿ</p><p>è¿™æ˜¯å› ä¸º<strong> Debug æ˜¯ä¸ºå¼€å‘è€…è°ƒè¯•æ‰“å°æ•°æ®ç»“æ„æ‰€è®¾è®¡çš„ï¼Œè€Œ Display æ˜¯ç»™ç”¨æˆ·æ˜¾ç¤ºæ•°æ®ç»“æ„æ‰€è®¾è®¡çš„</strong>ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ Debug trait çš„å®ç°å¯ä»¥é€šè¿‡æ´¾ç”Ÿå®ç›´æ¥ç”Ÿæˆï¼Œè€Œ Display å¿…é¡»æ‰‹å·¥å®ç°ã€‚åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼ŒDebug ç”¨ {:?} æ¥æ‰“å°ï¼ŒDisplay ç”¨ {} æ‰“å°ã€‚</p><p>æœ€åçœ‹ Default traitã€‚å®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š</p><pre><code class=\"language-rust\">pub trait Default {\n    fn default() -&gt; Self;\n}\n</code></pre><p>Default trait ç”¨äºä¸ºç±»å‹æä¾›ç¼ºçœå€¼ã€‚å®ƒä¹Ÿå¯ä»¥é€šè¿‡ derive å® #[derive(Default)] æ¥ç”Ÿæˆå®ç°ï¼Œå‰ææ˜¯ç±»å‹ä¸­çš„æ¯ä¸ªå­—æ®µéƒ½å®ç°äº† Default traitã€‚åœ¨åˆå§‹åŒ–ä¸€ä¸ªæ•°æ®ç»“æ„æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥éƒ¨åˆ†åˆå§‹åŒ–ï¼Œç„¶åå‰©ä½™çš„éƒ¨åˆ†ä½¿ç”¨ Default::default()ã€‚</p><p>Debug/Display/Default å¦‚ä½•ä½¿ç”¨ï¼Œç»Ÿä¸€çœ‹ä¸ªä¾‹å­ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=77bdb7c373ad7762bf0e3c2081c96719\">ä»£ç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">use std::fmt;\n// struct å¯ä»¥ derive Defaultï¼Œä½†æˆ‘ä»¬éœ€è¦æ‰€æœ‰å­—æ®µéƒ½å®ç°äº† Default\n#[derive(Clone, Debug, Default)]\nstruct Developer {\n    name: String,\n    age: u8,\n    lang: Language,\n}\n\n// enum ä¸èƒ½ derive Default\n#[allow(dead_code)]\n#[derive(Clone, Debug)]\nenum Language {\n    Rust,\n    TypeScript,\n    Elixir,\n    Haskell,\n}\n\n// æ‰‹å·¥å®ç° Default\nimpl Default for Language {\n    fn default() -&gt; Self {\n        Language::Rust\n    }\n}\n\nimpl Developer {\n    pub fn new(name: &amp;str) -&gt; Self {\n        // ç”¨ ..Default::default() ä¸ºå‰©ä½™å­—æ®µä½¿ç”¨ç¼ºçœå€¼\n        Self {\n            name: name.to_owned(),\n            ..Default::default()\n        }\n    }\n}\n\nimpl fmt::Display for Developer {\n    fn fmt(&amp;self, f: &amp;mut fmt::Formatter&lt;'_&gt;) -&gt; fmt::Result {\n        write!(\n            f,\n            \"{}({} years old): {:?} developer\",\n            self.name, self.age, self.lang\n        )\n    }\n}\n\nfn main() {\n    // ä½¿ç”¨ T::default()\n    let dev1 = Developer::default();\n    // ä½¿ç”¨ Default::default()ï¼Œä½†æ­¤æ—¶ç±»å‹æ— æ³•é€šè¿‡ä¸Šä¸‹æ–‡æ¨æ–­ï¼Œéœ€è¦æä¾›ç±»å‹\n    let dev2: Developer = Default::default();\n    // ä½¿ç”¨ T::new\n    let dev3 = Developer::new(\"Tyr\");\n    println!(\"dev1: {}\\\\ndev2: {}\\\\ndev3: {:?}\", dev1, dev2, dev3);\n}\n</code></pre><p>å®ƒä»¬å®ç°èµ·æ¥éå¸¸ç®€å•ï¼Œä½ å¯ä»¥çœ‹æ–‡ä¸­çš„ä»£ç ã€‚</p><h2>å°ç»“</h2><p>ä»Šå¤©ä»‹ç»äº†å†…å­˜ç®¡ç†ã€ç±»å‹è½¬æ¢ã€æ“ä½œç¬¦ã€æ•°æ®æ˜¾ç¤ºç­‰ç›¸å…³çš„åŸºæœ¬ traitï¼Œè¿˜ä»‹ç»äº†æ ‡è®° traitï¼Œå®ƒæ˜¯ä¸€ç§ç‰¹æ®Šçš„ traitï¼Œä¸»è¦æ˜¯ç”¨äºååŠ©ç¼–è¯‘å™¨æ£€æŸ¥ç±»å‹å®‰å…¨ã€‚<br>\n<img src=\"https://static001.geekbang.org/resource/image/c4/5e/c40e3efef2bec9140c95054547958a5e.jpg?wh=2743x1765\" alt=\"\"></p><p>åœ¨æˆ‘ä»¬ä½¿ç”¨ Rust å¼€å‘æ—¶ï¼Œtrait å æ®äº†éå¸¸æ ¸å¿ƒçš„åœ°ä½ã€‚<strong>ä¸€ä¸ªè®¾è®¡è‰¯å¥½çš„ trait å¯ä»¥å¤§å¤§æå‡æ•´ä¸ªç³»ç»Ÿçš„å¯ç”¨æ€§å’Œæ‰©å±•æ€§</strong>ã€‚</p><p>å¾ˆå¤šä¼˜ç§€çš„ç¬¬ä¸‰æ–¹åº“ï¼Œéƒ½å›´ç»•ç€ trait å±•å¼€å®ƒä»¬çš„èƒ½åŠ›ï¼Œæ¯”å¦‚ä¸Šä¸€è®²æåˆ°çš„ tower-service ä¸­çš„ <a href=\"https://docs.rs/tower-service/0.3.1/tower_service/trait.Service.html\">Service trait</a>ï¼Œå†æ¯”å¦‚ä½ æ—¥åå¯èƒ½ä¼šç»å¸¸ä½¿ç”¨åˆ°çš„ parser combinator åº“ <a href=\"https://docs.rs/nom/6.2.1/nom/\">nom</a> çš„ <a href=\"https://docs.rs/nom/6.2.1/nom/trait.Parser.html\">Parser trait</a>ã€‚</p><p>å› ä¸º trait å®ç°äº†å»¶è¿Ÿç»‘å®šã€‚ä¸çŸ¥é“ä½ æ˜¯å¦è¿˜è®°å¾—ï¼Œä¹‹å‰ä¸²è®²ç¼–ç¨‹åŸºç¡€æ¦‚å¿µçš„æ—¶å€™ï¼Œå°±è°ˆåˆ°äº†å»¶è¿Ÿç»‘å®šã€‚åœ¨è½¯ä»¶å¼€å‘ä¸­ï¼Œå»¶è¿Ÿç»‘å®šä¼šå¸¦æ¥æå¤§çš„çµæ´»æ€§ã€‚</p><p>ä»æ•°æ®çš„è§’åº¦çœ‹ï¼Œæ•°æ®ç»“æ„æ˜¯å…·ä½“æ•°æ®çš„å»¶è¿Ÿç»‘å®šï¼Œæ³›å‹ç»“æ„æ˜¯å…·ä½“æ•°æ®ç»“æ„çš„å»¶è¿Ÿç»‘å®šï¼›ä»ä»£ç çš„è§’åº¦çœ‹ï¼Œå‡½æ•°æ˜¯ä¸€ç»„å®ç°æŸä¸ªåŠŸèƒ½çš„è¡¨è¾¾å¼çš„å»¶è¿Ÿç»‘å®šï¼Œæ³›å‹å‡½æ•°æ˜¯å‡½æ•°çš„å»¶è¿Ÿç»‘å®šã€‚é‚£ä¹ˆ trait æ˜¯ä»€ä¹ˆçš„å»¶è¿Ÿç»‘å®šå‘¢ï¼Ÿ</p><p><strong>trait æ˜¯è¡Œä¸ºçš„å»¶è¿Ÿç»‘å®š</strong>ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ä¸çŸ¥é“å…·ä½“è¦å¤„ç†ä»€ä¹ˆæ•°æ®ç»“æ„çš„å‰æä¸‹ï¼Œå…ˆé€šè¿‡ trait æŠŠç³»ç»Ÿçš„å¾ˆå¤šè¡Œä¸ºçº¦å®šå¥½ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå¼€å¤´è§£é‡Šæ ‡å‡†traitæ—¶ï¼Œé¢‘ç¹ç”¨åˆ°äº†â€œçº¦å®šâ€¦â€¦è¡Œä¸ºâ€ã€‚</p><p>ç›¸ä¿¡é€šè¿‡ä»Šå¤©çš„å­¦ä¹ ï¼Œä½ èƒ½å¯¹ trait æœ‰æ›´æ·±åˆ»çš„è®¤è¯†ï¼Œåœ¨æ’°å†™è‡ªå·±çš„æ•°æ®ç±»å‹æ—¶ï¼Œå°±èƒ½æ ¹æ®éœ€è¦å®ç°è¿™äº› traitã€‚</p><h3>æ€è€ƒé¢˜</h3><p>1.Vec&lt;T&gt; å¯ä»¥å®ç° Copy trait ä¹ˆï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ<br>\n2.åœ¨ä½¿ç”¨ Arc&lt;Mutex&lt;T&gt;&gt; æ—¶ï¼Œä¸ºä»€ä¹ˆä¸‹é¢è¿™æ®µä»£ç å¯ä»¥ç›´æ¥ä½¿ç”¨ shared.lock()ï¼Ÿ</p><pre><code class=\"language-rust\">use std::sync::{Arc, Mutex};\nlet shared = Arc::new(Mutex::new(1));\nlet mut g = shared.lock().unwrap();\n*g += 1;\n</code></pre><p>3.æœ‰ä½™åŠ›çš„åŒå­¦å¯ä»¥å°è¯•ä¸€ä¸‹ï¼Œä¸ºä¸‹é¢çš„ List&lt;T&gt; ç±»å‹å®ç° Indexï¼Œä½¿å¾—æ‰€æœ‰çš„æµ‹è¯•éƒ½èƒ½é€šè¿‡ã€‚è¿™æ®µä»£ç ä½¿ç”¨äº† std::collections::LinkedListï¼Œä½ å¯ä»¥å‚è€ƒ<a href=\"https://doc.rust-lang.org/std/collections/linked_list/struct.LinkedList.html\">å®˜æ–¹æ–‡æ¡£</a>é˜…è¯»å®ƒæ”¯æŒçš„æ–¹æ³•ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=c7ddd7b647ef42753cc86a2a86e5a753\">ä»£ç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">use std::{\n    collections::LinkedList,\n    ops::{Deref, DerefMut, Index},\n};\nstruct List&lt;T&gt;(LinkedList&lt;T&gt;);\n\nimpl&lt;T&gt; Deref for List&lt;T&gt; {\n    type Target = LinkedList&lt;T&gt;;\n\n    fn deref(&amp;self) -&gt; &amp;Self::Target {\n        &amp;self.0\n    }\n}\n\nimpl&lt;T&gt; DerefMut for List&lt;T&gt; {\n    fn deref_mut(&amp;mut self) -&gt; &amp;mut Self::Target {\n        &amp;mut self.0\n    }\n}\n\nimpl&lt;T&gt; Default for List&lt;T&gt; {\n    fn default() -&gt; Self {\n        Self(Default::default())\n    }\n}\n\nimpl&lt;T&gt; Index&lt;isize&gt; for List&lt;T&gt; {\n    type Output = T;\n\n    fn index(&amp;self, index: isize) -&gt; &amp;Self::Output {\n        todo!();\n    }\n}\n\n#[test]\nfn it_works() {\n    let mut list: List&lt;u32&gt; = List::default();\n    for i in 0..16 {\n        list.push_back(i);\n    }\n\n    assert_eq!(list[0], 0);\n    assert_eq!(list[5], 5);\n    assert_eq!(list[15], 15);\n    assert_eq!(list[16], 0);\n    assert_eq!(list[-1], 15);\n    assert_eq!(list[128], 0);\n    assert_eq!(list[-128], 0);\n}\n</code></pre><p>ä»Šå¤©ä½ å·²ç»å®Œæˆäº†Rustå­¦ä¹ çš„ç¬¬14æ¬¡æ‰“å¡ï¼ŒåšæŒå­¦ä¹ ï¼Œå¦‚æœä½ è§‰å¾—æœ‰æ”¶è·ï¼Œä¹Ÿæ¬¢è¿åˆ†äº«ç»™èº«è¾¹çš„æœ‹å‹ï¼Œé‚€TAä¸€èµ·è®¨è®ºã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ï½</p>","comments":[{"had_liked":false,"id":313647,"user_name":"è®°äº‹æœ¬","can_delete":false,"product_type":"c1","uid":1401568,"ip_address":"","ucode":"FA942636EE0CC8","user_header":"https://static001.geekbang.org/account/avatar/00/15/62/e0/d2ff52da.jpg","comment_is_top":false,"comment_ctime":1632579499,"is_pvip":false,"replies":[{"id":"113743","content":"è°¢è°¢å¤¸å¥–ï¼","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1632798694,"ip_address":"","comment_id":313647,"utype":1}],"discussion_count":1,"race_medal":0,"score":"100416827307","product_id":100085301,"comment_content":"è€å¸ˆï¼Œä½ è®²å¾—å¤ªé€šé€ï¼Œå¤ªè¯¦ç»†äº†ï¼Œå¤ªè´Ÿè´£ä»»äº†ï¼Œå…¨ç½‘æœ€å¥½çš„æ•™ç¨‹äº†","like_count":24,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527423,"discussion_content":"è°¢è°¢å¤¸å¥–ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632798694,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":313529,"user_name":"c4f","can_delete":false,"product_type":"c1","uid":2637246,"ip_address":"","ucode":"F0F542BBABCB37","user_header":"https://static001.geekbang.org/account/avatar/00/28/3d/be/98bebd57.jpg","comment_is_top":false,"comment_ctime":1632475498,"is_pvip":false,"replies":[{"id":"113583","content":"å¾ˆæ£’ï¼<br><br>å¯¹äº 3ï¼Œä½ å¯ä»¥çœ‹æˆ‘çš„å‚è€ƒä»£ç ï¼š<br><br>```Rust<br>impl&lt;T&gt; Index&lt;isize&gt; for List&lt;T&gt; {<br>    type Output = T;<br><br>    fn index(&amp;self, index: isize) -&gt; &amp;Self::Output {<br>        let len = self.len() as isize;<br>        &#47;&#47; æˆ‘ä»¬éœ€è¦å…ˆå¯¹è´Ÿæ•°ï¼Œä»¥åŠ index è¶…å‡ºèŒƒå›´çš„æ•°å­—è¿›è¡Œå¤„ç†<br>        &#47;&#47; ä½¿å…¶è½åœ¨ 0..len ä¹‹é—´<br>        let n = (len + index % len) % len;<br>        let iter = self.iter();<br>        &#47;&#47; ç”±äº n ä¸€å®šå°äº len æ‰€ä»¥è¿™é‡Œå¯ä»¥ skip n å– next<br>        &#47;&#47; æ­¤æ—¶ä¸€å®šæœ‰å€¼ï¼Œæ‰€ä»¥å¯ä»¥æ”¾å¿ƒ unwrap<br>        iter.skip(n as usize).next().unwrap()<br>    }<br>}<br>```<br><br>playground: https:&#47;&#47;play.rust-lang.org&#47;?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=9f354aaed64c4b97f3b80c3be9c4b59a","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1632528931,"ip_address":"","comment_id":313529,"utype":1}],"discussion_count":3,"race_medal":0,"score":"61762017642","product_id":100085301,"comment_content":"1. ä¸è¡Œã€‚å› ä¸º Vec å’Œ Copy éƒ½ä¸æ˜¯ç”¨æˆ·è‡ªå·± crate ä¸­å®šä¹‰çš„ï¼Œæ‰€ä»¥æ ¹æ®å­¤å„¿åŸåˆ™æ— æ³•ä¸º Vec å®ç° Copy trait<br><br>2. å› ä¸º Arc å®ç°äº† Deref å’Œ DerefMut traitï¼Œè§£åº”ç”¨å¯ä»¥ç›´æ¥è®¿é—®å†…éƒ¨çš„ Mutex<br><br>3. å®ç°çš„æ—¶å€™é‡åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼šå¯¹äºéæ³•çš„ index ï¼ˆæ¯”å¦‚æµ‹è¯•ç”¨ä¾‹ä¸­çš„ 128ï¼‰è¯¥å¦‚ä½•è¿”å›ï¼Œæ²¡æ‰¾åˆ°è§£å†³æ–¹æ³•äºæ˜¯åªé’ˆå¯¹ List&lt;u32&gt; å®ç°äº† Index traitï¼Œè¿™æ ·åœ¨é‡åˆ°éæ³• index æ—¶è¿”å› &amp;0 å³å¯ã€‚<br>é’ˆå¯¹ Vec æµ‹è¯•äº†ä¸€ä¸‹éæ³• index çš„æƒ…å½¢ï¼Œå‘ç°ä¼šç›´æ¥ç»ˆæ­¢è¿›ç¨‹ã€‚å…·ä½“ä»£ç å¦‚ä¸‹<br><br>```rust<br>fn index(&amp;self, index: isize) -&gt; &amp;Self::Output {<br>    &#47;&#47; todo!();<br>    if let Some(idx_abs) = <br>        if index &gt;= 0 {<br>            Some(index as usize)<br>        } else {<br>            self.len().checked_sub(index.abs() as usize)<br>        } {<br>        let mut iter = self.iter();<br>        for _i in 0..idx_abs {<br>            iter.next();<br>        }<br>        iter.next().unwrap_or(&amp;0)<br>    } else {<br>        &amp;0<br>    }<br>}<br>```<br><br>","like_count":15,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527378,"discussion_content":"å¾ˆæ£’ï¼\n\nå¯¹äº 3ï¼Œä½ å¯ä»¥çœ‹æˆ‘çš„å‚è€ƒä»£ç ï¼š\n\n```Rust\nimpl&amp;lt;T&amp;gt; Index&amp;lt;isize&amp;gt; for List&amp;lt;T&amp;gt; {\n    type Output = T;\n\n    fn index(&amp;amp;self, index: isize) -&amp;gt; &amp;amp;Self::Output {\n        let len = self.len() as isize;\n        // æˆ‘ä»¬éœ€è¦å…ˆå¯¹è´Ÿæ•°ï¼Œä»¥åŠ index è¶…å‡ºèŒƒå›´çš„æ•°å­—è¿›è¡Œå¤„ç†\n        // ä½¿å…¶è½åœ¨ 0..len ä¹‹é—´\n        let n = (len + index % len) % len;\n        let iter = self.iter();\n        // ç”±äº n ä¸€å®šå°äº len æ‰€ä»¥è¿™é‡Œå¯ä»¥ skip n å– next\n        // æ­¤æ—¶ä¸€å®šæœ‰å€¼ï¼Œæ‰€ä»¥å¯ä»¥æ”¾å¿ƒ unwrap\n        iter.skip(n as usize).next().unwrap()\n    }\n}\n```\n\nplayground: https://play.rust-lang.org/?version=stable&amp;amp;mode=debug&amp;amp;edition=2018&amp;amp;gist=9f354aaed64c4b97f3b80c3be9c4b59a","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632528931,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1149798,"avatar":"https://static001.geekbang.org/account/avatar/00/11/8b/66/2b55a7ac.jpg","nickname":"å‘¨","note":"","ucode":"E4D57FF40B355A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":563919,"discussion_content":"è€å¸ˆï¼Œiter.skip().next() ä¸ºä»€ä¹ˆé“¾å¼å¯ä»¥ä¸éœ€è¦mut æˆ‘æ¢ä¸ªå†™æ³• let b = iter.skip(); b.next().unwrap(),ç¼–è¯‘å™¨ä¼šè¦æ±‚bæ˜¯mutçš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1650111599,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":527378,"ip_address":""},"score":563919,"extra":""}]},{"author":{"id":1158959,"avatar":"https://static001.geekbang.org/account/avatar/00/11/af/2f/2e0d9d92.jpg","nickname":"é˜¿æ–‡","note":"","ucode":"A67F91C7CCE4C4","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":397987,"discussion_content":"è¿˜æœ‰skipï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632711107,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":313898,"user_name":"noisyes","can_delete":false,"product_type":"c1","uid":2538540,"ip_address":"","ucode":"94EC310B284AD2","user_header":"https://static001.geekbang.org/account/avatar/00/26/bc/2c/963688bb.jpg","comment_is_top":false,"comment_ctime":1632731123,"is_pvip":false,"replies":[{"id":"113714","content":"å°±æ˜¯å¦‚æœä½ è·å¾—æŸä¸ªç±»å‹T åˆ°å…¶å®ƒç±»å‹çš„å¼•ç”¨ Uï¼Œç„¶ååˆæŠŠè¿™ä¸ªå¼•ç”¨ U clone å‡ºä¸€ä¸ª U çš„å¸¦æ‰€æœ‰æƒçš„æ•°æ®ã€‚é‚£ä¹ˆä¸ºä½•ä¸ç›´æ¥å®ç° From&lt;T&gt; for U å‘¢ï¼Ÿ","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1632792071,"ip_address":"","comment_id":313898,"utype":1}],"discussion_count":1,"race_medal":0,"score":"40287436787","product_id":100085301,"comment_content":"åˆšæ‰çš„å°ä¾‹å­ä¸­è¦é¢å¤–è¯´æ˜ä¸€ä¸‹çš„æ˜¯ï¼Œå¦‚æœä½ çš„ä»£ç å‡ºç° v.as_ref().clone() è¿™æ ·çš„è¯­å¥ï¼Œä¹Ÿå°±æ˜¯è¯´ä½ è¦å¯¹ v è¿›è¡Œå¼•ç”¨è½¬æ¢ï¼Œç„¶ååˆå¾—åˆ°äº†æ‹¥æœ‰æ‰€æœ‰æƒçš„å€¼ï¼Œé‚£ä¹ˆä½ åº”è¯¥å®ç° Fromï¼Œç„¶ååš v.into()ã€‚  è¿™å¥è¯æ€ä¹ˆç†è§£å‘€","like_count":10,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527511,"discussion_content":"å°±æ˜¯å¦‚æœä½ è·å¾—æŸä¸ªç±»å‹T åˆ°å…¶å®ƒç±»å‹çš„å¼•ç”¨ Uï¼Œç„¶ååˆæŠŠè¿™ä¸ªå¼•ç”¨ U clone å‡ºä¸€ä¸ª U çš„å¸¦æ‰€æœ‰æƒçš„æ•°æ®ã€‚é‚£ä¹ˆä¸ºä½•ä¸ç›´æ¥å®ç° From&amp;lt;T&amp;gt; for U å‘¢ï¼Ÿ","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1632792071,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":321946,"user_name":"å½­äºšä¼¦","can_delete":false,"product_type":"c1","uid":2425378,"ip_address":"","ucode":"77A32C73A23F72","user_header":"https://static001.geekbang.org/account/avatar/00/25/02/22/19585900.jpg","comment_is_top":false,"comment_ctime":1637114574,"is_pvip":true,"replies":[{"id":"116957","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1079375","ctime":1637161904,"ip_address":"","comment_id":321946,"utype":1}],"discussion_count":3,"race_medal":0,"score":"14522016462","product_id":100085301,"comment_content":"ç¬¬3é¢˜, åŒæ ·ä½¿ç”¨æ ‡å‡†åº“çš„2ä¸ªæ–¹æ³•, `checked_rem_euclid`å–å¾—åˆç†ç´¢å¼•å€¼, `iter().nth()`è·å¾—å®é™…å€¼<br>```rust<br>use std::{<br>    collections::LinkedList,<br>    ops::{Deref, DerefMut, Index},<br>};<br>struct List&lt;T&gt;(LinkedList&lt;T&gt;);<br><br>impl&lt;T&gt; Deref for List&lt;T&gt; {<br>    type Target = LinkedList&lt;T&gt;;<br><br>    fn deref(&amp;self) -&gt; &amp;Self::Target {<br>        &amp;self.0<br>    }<br>}<br><br>impl&lt;T&gt; DerefMut for List&lt;T&gt; {<br>    fn deref_mut(&amp;mut self) -&gt; &amp;mut Self::Target {<br>        &amp;mut self.0<br>    }<br>}<br><br>impl&lt;T&gt; Default for List&lt;T&gt; {<br>    fn default() -&gt; Self {<br>        Self(Default::default())<br>    }<br>}<br><br>impl&lt;T&gt; Index&lt;isize&gt; for List&lt;T&gt; {<br>    type Output = T;<br><br>    fn index(&amp;self, index: isize) -&gt; &amp;Self::Output {<br>        let len = self.0.len();<br>        &#47;&#47;æ ‡å‡†åº“çš„checked_rem_euclidæ–¹æ³•, å¦‚æœlen=0 åˆ™è¿”å›None<br>        &#47;&#47;è¿™é‡Œç›´æ¥æŠŠiè¿›è¡Œunwrap, å¦‚æœé“¾è¡¨é•¿åº¦ä¸ä¸º0, åˆ™iä¸€å®šåœ¨0..lenèŒƒå›´å†…, å¯ä»¥æ”¾å¿ƒä½¿ç”¨, <br>        &#47;&#47;å¦‚æœé•¿åº¦ä¸ºé›¶, æ„å‘³è¿™å¯¹ä¸€ä¸ªç©ºé“¾è¡¨è¿›è¡Œç´¢å¼•, é‚£ä¹ˆæˆ‘panicåº”è¯¥ä¹Ÿæ˜¯åˆæƒ…åˆç†çš„å§<br>        let i = (index as usize).checked_rem_euclid(len).unwrap();<br>        &amp;self.0.iter().nth(i).unwrap()<br>    }<br>}<br><br>#[test]<br>fn it_works() {<br>    let mut list: List&lt;u32&gt; = List::default();<br>    for i in 0..16 {<br>        list.push_back(i);<br>    }<br><br>    assert_eq!(list[0], 0);<br>    assert_eq!(list[5], 5);<br>    assert_eq!(list[15], 15);<br>    assert_eq!(list[16], 0);<br>    assert_eq!(list[-1], 15);<br>    assert_eq!(list[128], 0);<br>    assert_eq!(list[-128], 0);<br>}<br>```<br><br>playground é“¾æ¥:  https:&#47;&#47;play.rust-lang.org&#47;?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=73b4129f1a6608892691da92d501ba15","like_count":4,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":530883,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637161904,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1390032,"avatar":"https://static001.geekbang.org/account/avatar/00/15/35/d0/f2ac6d91.jpg","nickname":"é˜¿æˆ","note":"","ucode":"CEC3CD65FB9333","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":532972,"discussion_content":"ä½ çš„é”™è¯¯åœ¨äºæŠŠ isize å¼ºåˆ¶è½¬æˆäº† usizeã€‚è¿™ä¸ªè¿‡ç¨‹ï¼Œæ¯”å¦‚ -1 å°±ä¼šåŠ  usize::MAX å˜æˆ -1 + usize::MAXã€‚è€Œ size::MAX åˆšå¥½æ˜¯ vec é•¿åº¦ 16 çš„æ•´æ•°å€ï¼Œå› æ­¤è¿™ä¸ªè½¬å˜è¿‡ç¨‹å¹¶æ²¡æœ‰æ”¹å˜ä½™æ•°çš„ç»“æœï¼Œå› è€Œå¹¶æ²¡æœ‰å½±å“æµ‹è¯•ç”¨ä¾‹çš„é€šè¿‡ã€‚ä¸Šé¢çš„ demo ä¸­ï¼Œæˆ‘æŠŠ vec çš„é•¿åº¦æ”¹æˆäº† 15ï¼Œå°±å¯ä»¥çœ‹åˆ°æµ‹è¯•å¤±è´¥äº†ã€‚\n\nä¸è¿‡å—ä½ å¯å‘ï¼Œæˆ‘çŸ¥é“äº† rem_euclid è¿™ä¸ªä¸œè¥¿ã€‚é‚£ä¹ˆï¼Œæˆ‘æƒ³è¿™æ‰æ˜¯æœ€ç®€æ´çš„å®ç°ï¼š\nlet i = index.checked_rem_euclid(self.len() as isize).expect(&#34;divided by 0 or results are overflow&#34;);\nself.iter().nth(i as usize).unwrap()\n\nè¿™é‡Œä¸¾ä¾‹è¯´æ˜ä¸€ä¸‹ div/rem å’Œ div_euclid/rem_enclid çš„åŒºåˆ«ï¼š\n-7 é™¤ä»¥ 4ã€‚\nå¦‚æœæ˜¯ divï¼Œå°±æ˜¯ -1 * 4 - 3 = -7 ï¼Œå¾—åˆ°å•†ä¸º -1ï¼Œä½™æ•°ä¸º -3ã€‚\nè€Œå¦‚æœæ˜¯ div_euclidï¼Œä½™æ•°å¿…é¡»ä¸ºæ­£æˆ–è€…0ï¼Œå°±æ˜¯ -2 * 4 + 1 = -7ï¼ˆ-1 ä¸ª 4 ä¸å¤ŸæŠŠ -7 å˜æˆæ­£æˆ–è€…0ï¼Œæ‰€ä»¥éœ€è¦ -2 ä¸ª 4ï¼‰ï¼Œè¿™æ ·å¾—åˆ°å•†ä¸º -2ï¼Œä½™æ•°ä¸º 1ã€‚","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1637744745,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"user_type\":1}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1390032,"avatar":"https://static001.geekbang.org/account/avatar/00/15/35/d0/f2ac6d91.jpg","nickname":"é˜¿æˆ","note":"","ucode":"CEC3CD65FB9333","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":532964,"discussion_content":"ç„¶è€Œä½ çš„å®ç°æ˜¯é”™è¯¯çš„ï¼š\nhttps://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=71ad296a7ca319487021937bc5624478\n\nå»ºè®®è€å¸ˆè¡¥å……æµ‹è¯•ç”¨ä¾‹â€¦â€¦","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637742120,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"user_type\":1}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":318606,"user_name":"æ ¸æ¡ƒ","can_delete":false,"product_type":"c1","uid":1385204,"ip_address":"","ucode":"7AB05270CBCCCB","user_header":"https://static001.geekbang.org/account/avatar/00/15/22/f4/9fd6f8f0.jpg","comment_is_top":false,"comment_ctime":1635347252,"is_pvip":false,"replies":[{"id":"116576","content":"1. * ä»£è¡¨è§£å¼•ç”¨ï¼Œ&amp;æ˜¯è·å–å˜é‡å¼•ç”¨ï¼ˆåœ°å€ï¼‰<br>2. trait &quot;ç»§æ‰¿&quot; æ˜¯æ‰“å¼•å·çš„ç»§æ‰¿ï¼Œåªæ˜¯ trait A &quot;ç»§æ‰¿&quot; trait B  çš„æ–¹æ³•ï¼ˆå’Œå…³è”ç±»å‹ï¼‰ï¼Œæ˜¯è¡Œä¸ºçš„ç»§æ‰¿ï¼Œä¹Ÿæ˜¯ä¸€ç§ç»„åˆï¼Œå’Œé¢å‘å¯¹è±¡ç»§æ‰¿çš„æ¦‚å¿µæ˜¯ä¸ä¸€æ ·çš„ï¼Œå®ƒä»¬ä¹‹é—´å¹¶æ— æ•°æ®çš„ç»§æ‰¿ï¼Œä¹Ÿæ²¡æœ‰ç±»åˆ«ç»§æ‰¿çš„å…³ç³»ã€‚<br>3. unwrap() åœ¨ç¤ºä¾‹ä»£ç ä¸­ä¼šå¸¸å¸¸ç”¨åˆ°ï¼Œæˆ‘åœ¨ä¹‹å‰çš„å†…å®¹ä¸­ä»‹ç»è¿‡è¿™æ ·ä¼šå¯¼è‡´ panicï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­çš„ä»£ç é™¤éä½ åœ¨ä¸Šä¸‹æ–‡ä¸­ç¡®ä¿å®ƒä¸ä¼š panicï¼Œå¦åˆ™ä¸å®œä½¿ç”¨ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1636642236,"ip_address":"","comment_id":318606,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10225281844","product_id":100085301,"comment_content":"è€å¸ˆï¼Œè¿™é‡Œæœ‰ä¸€äº›æ¦‚å¿µæ²¡ææ¸…æ™°ã€‚<br>1. * è¿™ä¸ªç¬¦å·ï¼Œæœ‰æ—¶è¡¨ç¤ºè§£å¼•ç”¨ï¼Œæœ‰æ—¶è¡¨ç¤ºè·å–å˜é‡åœ°å€çš„å€¼ï¼Œå¯¹å—ï¼Ÿæœ‰ç‚¹ææ··åœºæ™¯äº†ã€‚<br>2. traitç»§æ‰¿è¿™é‡Œï¼Œç»å¸¸çœ‹åˆ°ä¸€å¥è¯ï¼Œç»„åˆä¼˜äºç»§æ‰¿ï¼Œæ€ä¹ˆç†è§£ã€‚åŒæ—¶å¯¹äºå®ç°å’Œç»§æ‰¿æ¥è¯´ï¼Œå¯èƒ½åŸºç¡€ä¸æ‰å®ï¼Œä¸€ç›´æ²¡ç†è§£å¥½ä»€ä¹ˆæ—¶å€™ç»§æ‰¿ä»€ä¹ˆæ—¶å€™å®ç°ï¼Œå­¦javaçš„æ—¶å€™ï¼Œé‚£äº›æŠ½è±¡ç±»å’Œæ¥å£ä¹Ÿè¿·ç³Šçš„å¾ˆã€‚<br><br>å¦å¤–è¿™é‡Œéšè—äº†å¾ˆå¤šä¸œè¥¿ï¼Œçœ‹è€å¸ˆä»£ç çš„æ—¶å€™ç»å¸¸ç”¨unwrapï¼Œå…¶å®ç”Ÿäº§ç¯å¢ƒä»£ç æ˜¯éå¸¸å±é™©çš„ã€‚ä¾‹å¦‚ä»Šå¤©å†™hashmapæ›¿æ¢é‡Œé¢å†…å®¹æ—¶ï¼Œæœ€å¥½ç”¨containkeysåˆ¤æ–­ä¸€ä¸‹ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ’å…¥ä¸€ä¸ªç©ºçš„ï¼Œå†ä½¿ç”¨get_mutå’Œunwarpï¼Œè¿™æ ·å°±ä¿è¯å®‰å…¨ä¸ä¼španicäº†ã€‚","like_count":3,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":529312,"discussion_content":"1. * ä»£è¡¨è§£å¼•ç”¨ï¼Œ&amp;amp;æ˜¯è·å–å˜é‡å¼•ç”¨ï¼ˆåœ°å€ï¼‰\n2. trait &amp;quot;ç»§æ‰¿&amp;quot; æ˜¯æ‰“å¼•å·çš„ç»§æ‰¿ï¼Œåªæ˜¯ trait A &amp;quot;ç»§æ‰¿&amp;quot; trait B  çš„æ–¹æ³•ï¼ˆå’Œå…³è”ç±»å‹ï¼‰ï¼Œæ˜¯è¡Œä¸ºçš„ç»§æ‰¿ï¼Œä¹Ÿæ˜¯ä¸€ç§ç»„åˆï¼Œå’Œé¢å‘å¯¹è±¡ç»§æ‰¿çš„æ¦‚å¿µæ˜¯ä¸ä¸€æ ·çš„ï¼Œå®ƒä»¬ä¹‹é—´å¹¶æ— æ•°æ®çš„ç»§æ‰¿ï¼Œä¹Ÿæ²¡æœ‰ç±»åˆ«ç»§æ‰¿çš„å…³ç³»ã€‚\n3. unwrap() åœ¨ç¤ºä¾‹ä»£ç ä¸­ä¼šå¸¸å¸¸ç”¨åˆ°ï¼Œæˆ‘åœ¨ä¹‹å‰çš„å†…å®¹ä¸­ä»‹ç»è¿‡è¿™æ ·ä¼šå¯¼è‡´ panicï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­çš„ä»£ç é™¤éä½ åœ¨ä¸Šä¸‹æ–‡ä¸­ç¡®ä¿å®ƒä¸ä¼š panicï¼Œå¦åˆ™ä¸å®œä½¿ç”¨ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1636642236,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":315075,"user_name":"å‘¨çƒ¨","can_delete":false,"product_type":"c1","uid":1355560,"ip_address":"","ucode":"6DAE79E4966CEF","user_header":"https://static001.geekbang.org/account/avatar/00/14/af/28/cc69ea4b.jpg","comment_is_top":false,"comment_ctime":1633680628,"is_pvip":false,"replies":[{"id":"114161","content":"æ­£ç¡®ï¼","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1633812197,"ip_address":"","comment_id":315075,"utype":1}],"discussion_count":3,"race_medal":0,"score":"10223615220","product_id":100085301,"comment_content":"1. ä¸èƒ½ï¼Œå› ä¸ºä¸èƒ½ç¡®å®šTæ˜¯å¦å®ç°äº†Copy traitã€‚<br>2. å› ä¸ºArcå®ç°äº†Deref trait<br>3. ```impl&lt;T&gt; Index&lt;isize&gt; for List&lt;T&gt; {<br>    type Output = T;<br><br>    fn index(&amp;self, index: isize) -&gt; &amp;Self::Output {<br>        let len = self.len() as isize;<br>        let i = if index % len &gt;= 0 {<br>                index % len<br>            } else {<br>                len + index % len<br>            } as usize;<br>        let it = self.iter();<br>        return it.skip(i).next().unwrap();<br>    }<br>}```","like_count":3,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527866,"discussion_content":"æ­£ç¡®ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633812197,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1828290,"avatar":"","nickname":"ilookers","note":"","ucode":"CAD6557DAC946D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":549763,"discussion_content":"é’ˆå¯¹é—®é¢˜1çš„å›ç­”ï¼Œåº”è¯¥ä¸å¤Ÿå‡†ç¡®ã€‚æ¯”å¦‚ä¸‹é¢è¿™æ®µä»£ç ï¼Œå·²çŸ¥ Vec&lt;T&gt; ä¸­ T ç±»å‹çš„æƒ…å†µä¸‹ï¼ˆæ¯”å¦‚ u8ï¼‰ï¼Œç¼–è¯‘å™¨ä¼šæç¤ºé”™è¯¯ï¼š`Derive macro generating an impl of the trait Copy`ã€‚\n\n```rust\n#[derive(Copy)]\nstruct Buffer(Vec&lt;u8&gt;);\n```\n\næˆ‘è¿™ä¹ˆç†è§£çš„ï¼ŒVec&lt;T&gt;ä¸èƒ½å®ç° Copy trait çš„åŸå› ï¼š Vec&lt;T&gt; æ˜¯ä¸€ä¸ªåˆ†é…åœ¨å †ä¸Šçš„ç©ºé—´ï¼Œæ‰€ä»¥ä¸èƒ½å®ç° Copy traitã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1644229530,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":527866,"ip_address":""},"score":549763,"extra":""}]},{"author":{"id":2254917,"avatar":"https://static001.geekbang.org/account/avatar/00/22/68/45/ddf89612.jpg","nickname":"bestgopher","note":"","ucode":"D89735C8CA9C6E","race_medal":1,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":575001,"discussion_content":"æ­£ç¡®ï¼Ÿéš¾é“ä¸æ˜¯vecçš„æ•°æ®åœ¨å †ä¸Šï¼Œæˆ–è€…è¯´å®ç°äº†Dropï¼Œå› æ­¤ä¸èƒ½å®ç°Copyå§ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1654518181,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":313707,"user_name":"å¤æ´›å…‹Moriaty","can_delete":false,"product_type":"c1","uid":2754785,"ip_address":"","ucode":"49BA020F04AB16","user_header":"https://static001.geekbang.org/account/avatar/00/2a/08/e1/b4748943.jpg","comment_is_top":false,"comment_ctime":1632625686,"is_pvip":false,"replies":[{"id":"113728","content":"åŒºåˆ«æ˜¯ï¼š<br><br>let a = &amp;*list;<br>let b = list.deref();<br>&#47;&#47; a == b<br><br>æ³¨æ„çœ‹ deref çš„è¿”å›å€¼ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1632797467,"ip_address":"","comment_id":313707,"utype":1}],"discussion_count":3,"race_medal":0,"score":"5927592982","product_id":100085301,"comment_content":"let a = *list;<br>let b  = list.deref();<br><br>è€å¸ˆè¯·é—®ä¸‹è¿™ä¸¤ç§æ–¹å¼æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œä¸ºä»€ä¹ˆaå’Œbçš„ç±»å‹ä¸åŒï¼Ÿ","like_count":2,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527445,"discussion_content":"åŒºåˆ«æ˜¯ï¼š\n\nlet a = &amp;amp;*list;\nlet b = list.deref();\n// a == b\n\næ³¨æ„çœ‹ deref çš„è¿”å›å€¼ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1632797467,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1401568,"avatar":"https://static001.geekbang.org/account/avatar/00/15/62/e0/d2ff52da.jpg","nickname":"è®°äº‹æœ¬","note":"","ucode":"FA942636EE0CC8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":397599,"discussion_content":"list ç­‰äº*list,è‡ªåŠ¨è§£å¼•ç”¨ï¼Œè¿™æ˜¯æ™ºèƒ½æŒ‡é’ˆçš„è¯­æ³•ç³–","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1632650067,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2754785,"avatar":"https://static001.geekbang.org/account/avatar/00/2a/08/e1/b4748943.jpg","nickname":"å¤æ´›å…‹Moriaty","note":"","ucode":"49BA020F04AB16","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":397979,"discussion_content":"// let a = *list;\nlet a = *(list.deref()); // aåœ¨ruståº•å±‚å®é™…ä¸Šè¿è¡Œçš„ä»£ç \nlet b = list.deref();\n\næ‡‚äº†ï¼Œç¼–è¯‘å™¨åšçš„äº‹æƒ…çœŸå¤šã€‚ã€‚ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632710032,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":313692,"user_name":"Taozi","can_delete":false,"product_type":"c1","uid":1021926,"ip_address":"","ucode":"DD6567A31B3E33","user_header":"","comment_is_top":false,"comment_ctime":1632621819,"is_pvip":false,"replies":[{"id":"113729","content":"DerefMut ä¾èµ– Derefï¼Œä¹Ÿå°±æ˜¯è¯´è¦å®ç° DerefMut å¿…é¡»å¿å®ç° Derefï¼Œæ‰€ä»¥ Target å°±å¤ç”¨äº†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1632797523,"ip_address":"","comment_id":313692,"utype":1}],"discussion_count":3,"race_medal":0,"score":"5927589115","product_id":100085301,"comment_content":"ç¬¬ä¸‰é¢˜é‡Œé¢ç»™List&lt;T&gt;å®ç°DerefMutæ—¶ï¼Œä¸ºä»€ä¹ˆä¸éœ€è¦åŠ type Target = LinkedListï¼Œé‚£è¿”å›çš„Self::Targetæ˜¯ä»€ä¹ˆã€‚","like_count":1,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527442,"discussion_content":"DerefMut ä¾èµ– Derefï¼Œä¹Ÿå°±æ˜¯è¯´è¦å®ç° DerefMut å¿…é¡»å¿å®ç° Derefï¼Œæ‰€ä»¥ Target å°±å¤ç”¨äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632797523,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2754785,"avatar":"https://static001.geekbang.org/account/avatar/00/2a/08/e1/b4748943.jpg","nickname":"å¤æ´›å…‹Moriaty","note":"","ucode":"49BA020F04AB16","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":397982,"discussion_content":"åœ¨ Rust ä¸­ï¼Œä¸€ä¸ª trait å¯ä»¥â€œç»§æ‰¿â€å¦ä¸€ä¸ª trait çš„å…³è”ç±»å‹å’Œå…³è”å‡½æ•°ã€‚\n\nDerefMutç»§æ‰¿äº†Derefï¼Œæ‰€ä»¥ç»§æ‰¿äº†å®ƒçš„å…³è”ç±»å‹ï¼Œå®ƒçš„Targetå°±æ˜¯LinkedListã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1632710357,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1021926,"avatar":"","nickname":"Taozi","note":"","ucode":"DD6567A31B3E33","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2754785,"avatar":"https://static001.geekbang.org/account/avatar/00/2a/08/e1/b4748943.jpg","nickname":"å¤æ´›å…‹Moriaty","note":"","ucode":"49BA020F04AB16","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":398030,"discussion_content":"å¤šè°¢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632719289,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":397982,"ip_address":""},"score":398030,"extra":""}]}]},{"had_liked":false,"id":313682,"user_name":"0@1","can_delete":false,"product_type":"c1","uid":1549191,"ip_address":"","ucode":"932A4139DB8169","user_header":"https://static001.geekbang.org/account/avatar/00/17/a3/87/eb923eb3.jpg","comment_is_top":false,"comment_ctime":1632620854,"is_pvip":false,"replies":[{"id":"113754","content":"è¿™é‡Œæ²¡æœ‰é¢å¤–çš„ secretï¼Œforget å’Œ ManuallyDrop::new() ä¸åŒçš„åœ°æ–¹æ˜¯ä¸€ä¸ªæœ‰è¿”å›å€¼ï¼Œä¸€ä¸ªæ²¡æœ‰è¿”å›å€¼ã€‚æ–‡æ¡£ä¸­çš„ä¾‹å­ä¹Ÿæ˜¯ä½¿ç”¨è¿™ä¸€ç‚¹çš„ä¸åŒæ¥è¡¨ç¤ºå®ƒä»¬ä¸åŒçš„ä½¿ç”¨åœºæ™¯çš„ã€‚ä½ å¯ä»¥å†ä»”ç»†çœ‹çœ‹ä¸¤ä¸ªä¾‹å­è°ƒç”¨ forget å’Œ ManuallyDrop::new() çš„ä½ç½®çš„ä¸åŒï¼Œæƒ³æƒ³ä¸ºä»€ä¹ˆä½¿ç”¨ forget ä¸èƒ½ä¸€å¼€å§‹å°±è°ƒç”¨ã€‚:) ","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1632799689,"ip_address":"","comment_id":313682,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5927588150","product_id":100085301,"comment_content":"è€å¸ˆï¼Œæƒ³æå‰é—®ä¸‹unsafeç›¸å…³çš„é—®é¢˜ï¼Œè¿™ä¸ªç›®å‰æ¯”è¾ƒå›°æ‰°æˆ‘è¿›ä¸€æ­¥å­¦ä¹ Rust.<br>æ¯”å¦‚è¿™ä¸ª std::mem::forget(t), çœ‹äº†ä¸‹æºç ï¼Œæ˜¯ç›´æ¥è°ƒç”¨ ManuallyDrop::new(t), çœ‹æ–‡æ¡£ï¼Œå¥½åƒè¿™2ä¸ªåˆä¸æ˜¯ç›´æ¥ç­‰ä»·çš„ã€‚forgetçš„æºç å¦‚ä¸‹ï¼Œå¤šäº†äº›å±æ€§å®ä¿®é¥°ï¼Œç¼–è¯‘å™¨æ˜¯ä¸æ˜¯å¤šåŠ äº†å¤„ç†ï¼Œä»è€Œè·Ÿç›´æ¥è°ƒç”¨ ManuallyDrop::new(t)èµ·åˆ°çš„æ•ˆæœä¸ä¸€æ ·ï¼Ÿ<br><br>å¦‚æœæ˜¯çš„è¯ï¼Œè¿™äº›å®çš„æ–‡æ¡£åœ¨å“ªé‡Œå¯ä»¥çœ‹åˆ°ï¼Œç±»ä¼¼çš„è¿™äº›ç¼–è¯‘å™¨å¤„ç†çš„å®æœ‰å“ªäº›ï¼Œä»–ä»¬çš„æ–‡æ¡£åœ¨å“ªé‡Œï¼Œè°¢è°¢ã€‚<br>Note: æˆ‘å­¦rusté™†ç»­2å¹´äº†ï¼Œçœ‹æºç æ—¶å¯¹è¿™äº›éœ€è¦ç¼–è¯‘å™¨é¢å¤–å¤„ç†çš„ä¸œè¥¿æ¯”è¾ƒå›°æƒ‘ï¼Œä¸çŸ¥é“å¦‚ä½•å»è¿›ä¸€æ­¥çš„ç†è§£ä»–ä»¬, rustä¸­å¾ˆå¤šéšå«è§„åˆ™è²Œä¼¼éƒ½æœ‰ä»–ä»¬çš„å½±å­ã€‚<br>#[inline]<br>#[rustc_const_stable(feature = &quot;const_forget&quot;, since = &quot;1.46.0&quot;)]<br>#[stable(feature = &quot;rust1&quot;, since = &quot;1.0.0&quot;)]<br>#[cfg_attr(not(test), rustc_diagnostic_item = &quot;mem_forget&quot;)]<br>pub const fn forget&lt;T&gt;(t: T) {<br>    let _ = ManuallyDrop::new(t);<br>}<br><br><br><br><br>","like_count":1,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527435,"discussion_content":"è¿™é‡Œæ²¡æœ‰é¢å¤–çš„ secretï¼Œforget å’Œ ManuallyDrop::new() ä¸åŒçš„åœ°æ–¹æ˜¯ä¸€ä¸ªæœ‰è¿”å›å€¼ï¼Œä¸€ä¸ªæ²¡æœ‰è¿”å›å€¼ã€‚æ–‡æ¡£ä¸­çš„ä¾‹å­ä¹Ÿæ˜¯ä½¿ç”¨è¿™ä¸€ç‚¹çš„ä¸åŒæ¥è¡¨ç¤ºå®ƒä»¬ä¸åŒçš„ä½¿ç”¨åœºæ™¯çš„ã€‚ä½ å¯ä»¥å†ä»”ç»†çœ‹çœ‹ä¸¤ä¸ªä¾‹å­è°ƒç”¨ forget å’Œ ManuallyDrop::new() çš„ä½ç½®çš„ä¸åŒï¼Œæƒ³æƒ³ä¸ºä»€ä¹ˆä½¿ç”¨ forget ä¸èƒ½ä¸€å¼€å§‹å°±è°ƒç”¨ã€‚:) ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632799689,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1390032,"avatar":"https://static001.geekbang.org/account/avatar/00/15/35/d0/f2ac6d91.jpg","nickname":"é˜¿æˆ","note":"","ucode":"CEC3CD65FB9333","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":532932,"discussion_content":"ä¾‹å­é‡Œè¯´å¾—å¾ˆæ¸…æ¥šå•Šâ€¦â€¦\nlet mut v = vec![65, 122];\nlet s = unsafe { String::from_raw_parts(v.as_mut_ptr(), v.len(), v.capacity()) };\nmem::forget(v);\nassert_eq!(s, &#34;Az&#34;);\nä½¿ç”¨ forget éœ€è¦ consume æ‰æ•°æ®ï¼Œå› æ­¤å¿…é¡»å…ˆæ„å»º s å† forget vã€‚è¿™æ ·æ˜¯å†…å­˜ä¸å®‰å…¨çš„ã€‚å¦‚æœæ„å»º s ä¹‹å forget(v) ä¹‹å‰ panic äº†ï¼Œä¼š double free é‚£ä¸€å—å†…å­˜ï¼ˆv å’Œ s çš„ destructor éƒ½ä¼šè¿è¡Œï¼‰ã€‚\n\nlet v = vec![65, 122];\nlet mut v = ManuallyDrop::new(v);\nlet (ptr, len, cap) = (v.as_mut_ptr(), v.len(), v.capacity());\nlet s = unsafe { String::from_raw_parts(ptr, len, cap) };\nassert_eq!(s, &#34;Az&#34;);\nè€Œä½¿ç”¨ ManuallyDrop åˆ™å…ˆä¸‹æ‰‹ä¸ºå¼ºï¼Œå®Œå…¨é¿å…äº† v çš„ destructor çš„æ‰§è¡Œï¼Œæ‰€ä»¥å°±ç®—ä¸­é—´ panic äº†ï¼Œä¹ŸæŒºå¤šå°±æ˜¯å†…å­˜æ³„æ¼è€Œå·²ï¼Œä¸ä¼šæœ‰ double free çš„æƒ…å†µå‘ç”Ÿã€‚\n\nç»¼ä¸Šï¼Œæ—¥å¸¸åº”è¯¥åå‘ä½¿ç”¨ ManuallyDropã€‚è‡³äº forget ç‹¬æœ‰çš„åº”ç”¨åœºæ™¯ï¼Œæˆ‘ä¸çŸ¥é“ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1637734585,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"user_type\":1}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":344893,"user_name":"flyflypeng","can_delete":false,"product_type":"c1","uid":1224113,"ip_address":"","ucode":"7A40FC08D8ACC0","user_header":"https://static001.geekbang.org/account/avatar/00/12/ad/b1/2e96794c.jpg","comment_is_top":false,"comment_ctime":1651838781,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1651838781","product_id":100085301,"comment_content":"è€å¸ˆï¼Œæˆ‘æŒ‰ç…§æœ€ç›´æ¥çš„é€»è¾‘æ¥å¤„ç†ï¼Œå¾ˆçº ç»“å¦‚ä½•æ‰èƒ½è¿”å›ä¸€ä¸ªTç±»å‹çš„é»˜è®¤å€¼ã€‚å‚è€ƒè€å¸ˆçš„ç­”æ¡ˆï¼Œæˆ‘è§‰å¾—å¯¹äºè¾“å…¥çš„indexå€¼æ˜ å°„åˆ°0~len-1åŒºé—´å†…ï¼Œä¸æ˜¯å¾ˆç¬¦åˆé¢„æœŸçš„é€»è¾‘ï¼Œå¯èƒ½å¯¹äºä¸å†åŒºé—´èŒƒå›´å†…çš„ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šè¿”å›é”™è¯¯ï¼Œæˆ–è€…è¿”å›ä¸€ä¸ªé»˜è®¤å€¼<br>impl&lt;T&gt; Index&lt;isize&gt; for List&lt;T&gt; {<br>    type Output = T;<br><br>    fn index(&amp;self, index: isize) -&gt; &amp;Self::Output {<br>        if index &lt; 0 {<br>            &#47;&#47; è¿”å›é»˜è®¤å€¼çš„å¼•ç”¨<br>        }<br><br>        for (i, item) in self.0.iter().enumerate() {<br>            if i == index as usize {<br>                return item;<br>            }<br>        }<br><br>        &#47;&#47;è¿”å›é»˜è®¤å€¼å¼•ç”¨<br>    }<br>}","like_count":0},{"had_liked":false,"id":344799,"user_name":"flyflypeng","can_delete":false,"product_type":"c1","uid":1224113,"ip_address":"","ucode":"7A40FC08D8ACC0","user_header":"https://static001.geekbang.org/account/avatar/00/12/ad/b1/2e96794c.jpg","comment_is_top":false,"comment_ctime":1651798818,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1651798818","product_id":100085301,"comment_content":"è€å¸ˆï¼Œæˆ‘å¯¹äºæ–‡ä¸­å…³äºcopyå’Œcloneçš„åŒºåˆ«è¿˜ä¸æ˜¯å¾ˆç†è§£ï¼Ÿä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™è¯¥ç”¨copy traitï¼Œä»€ä¹ˆæ—¶å€™ç”¨clone traitï¼Ÿ","like_count":0},{"had_liked":false,"id":344111,"user_name":"é¹…å¸®é€®","can_delete":false,"product_type":"c1","uid":2755534,"ip_address":"","ucode":"A6DB1BEFDA5D9A","user_header":"https://static001.geekbang.org/account/avatar/00/2a/0b/ce/f0c520d1.jpg","comment_is_top":false,"comment_ctime":1651248262,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1651248262","product_id":100085301,"comment_content":"æ‰€ä»¥ä¸Šé¢çš„ä»£ç  Developer ç±»å‹åœ¨åšå‚æ•°ä¼ é€’æ—¶ï¼Œä¼šæ‰§è¡Œ Move è¯­ä¹‰ï¼Œè€Œ Language ä¼šæ‰§è¡Œ Copy è¯­ä¹‰ã€‚<br>è¿™å¥è¯æ€ä¹ˆç†è§£å‘¢ï¼Ÿä¸ºä»€ä¹ˆLanguage ä¸æ‰§è¡Œmove","like_count":0},{"had_liked":false,"id":343414,"user_name":"Koco","can_delete":false,"product_type":"c1","uid":2394662,"ip_address":"","ucode":"AEBF53EFBA8BE5","user_header":"https://static001.geekbang.org/account/avatar/00/24/8a/26/2e2f9cfc.jpg","comment_is_top":false,"comment_ctime":1650842588,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1650842588","product_id":100085301,"comment_content":"into_xxx()ä¼šæ–°å¢ä¸€ä¸ªInto_xxx traitï¼Œè™½ç„¶ä¸ä¼˜é›…ï¼Œä½†æ˜¯æ²¡æœ‰â€œä¿®æ”¹â€å·²æœ‰çš„æ¨¡å—ï¼Œåº”è¯¥æ²¡æœ‰è¿åå¼€é—­åŸåˆ™å§ï¼Ÿ<br><br>Intoçš„è®¾è®¡ä½“ç°äº†å£°æ˜å¼ç¼–ç¨‹ï¼ˆdeclarative programming) çš„æ€æƒ³ï¼Œå°±åƒspringçš„DIä¸€æ ·ï¼Œå£°æ˜ç±»å‹å°±èƒ½å¾—åˆ°å¯¹åº”çš„beanã€‚","like_count":0},{"had_liked":false,"id":343314,"user_name":"Koco","can_delete":false,"product_type":"c1","uid":2394662,"ip_address":"","ucode":"AEBF53EFBA8BE5","user_header":"https://static001.geekbang.org/account/avatar/00/24/8a/26/2e2f9cfc.jpg","comment_is_top":false,"comment_ctime":1650777630,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1650777630","product_id":100085301,"comment_content":"å¤§éƒ¨åˆ†æ•™ç¨‹éƒ½è·Ÿå­—å…¸ä¼¼çš„ï¼Œç½—åˆ—çŸ¥è¯†ç‚¹ï¼Œæ¯ç‡¥éš¾å•ƒã€‚è¿™æ•™ç¨‹è®²å¾—å¤ªå¥½äº†ï¼Œä¸€è¾¹å­¦ä¸€è¾¹å¿ä¸ä½èµå¹ã€‚é«˜å±‹å»ºç“´ï¼Œæçº²æŒˆé¢†ï¼Œæ·±å…¥æµ…å‡ºã€‚ä¸ä»…æœ‰æœ¯â€”â€”ç»“æ„åŒ–çš„çŸ¥è¯†ï¼Œè¿˜æœ‰é“â€”â€”è®¡ç®—æœºè¯­è¨€çš„å­¦ä¹ æ–¹æ³•ã€‚é™ˆè€å¸ˆå¤ªç‰›äº†ã€‚","like_count":1},{"had_liked":false,"id":342402,"user_name":"lwshang","can_delete":false,"product_type":"c1","uid":1483392,"ip_address":"","ucode":"9194A3CB628D40","user_header":"https://static001.geekbang.org/account/avatar/00/16/a2/80/c2086557.jpg","comment_is_top":false,"comment_ctime":1650250260,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1650250260","product_id":100085301,"comment_content":"ç¬¬ä¸‰é¢˜å¯ä»¥åˆ©ç”¨æ— ç¬¦å·æ•´æ•°è¿ç®—æ¥ç®€åŒ–ã€‚å¦å¤–ï¼Œç©ºåˆ—è¡¨ä¹Ÿéœ€è¦é¢å¤–çš„å¤„ç†ã€‚<br>```rust<br>fn index(&amp;self, index: isize) -&gt; &amp;Self::Output {<br>    let len = self.0.len();<br>    if len == 0 {<br>        panic!(&quot;attempt to index empty list&quot;);<br>    }<br>    let offset = (index as usize) % len;<br>    &#47;&#47; above line guarantees that `offset` is within the range<br>    &#47;&#47; then `.nth(offset)` will always return `Some`<br>    &#47;&#47; so it is safe to `unwrap()`<br>    self.0.iter().nth(offset).unwrap()<br>}<br>```<br>https:&#47;&#47;play.rust-lang.org&#47;?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=fa3b1dd7c0f5eb222a29c0856e51b545","like_count":0,"discussions":[{"author":{"id":1544345,"avatar":"https://static001.geekbang.org/account/avatar/00/17/90/99/d03ef0d4.jpg","nickname":"newbmiao","note":"","ucode":"1BDD0341C490FD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":574048,"discussion_content":"æœ‰ä¸ªé—®é¢˜ï¼š (index as usize) % len å¹¶ä¸ç­‰ä»·äº ï¼ˆlen + index % lenï¼‰% len","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1653812451,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":339588,"user_name":"æ¬¢ä¹é©¬","can_delete":false,"product_type":"c1","uid":2231216,"ip_address":"","ucode":"F0A951D94B2AED","user_header":"https://static001.geekbang.org/account/avatar/00/22/0b/b0/9d413c8a.jpg","comment_is_top":false,"comment_ctime":1648205199,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1648205199","product_id":100085301,"comment_content":"éå¸¸ç²¾å½©ï¼ä¸ªäººè®¤ä¸ºæœ‰ä¸€ä¸ªå°é—®é¢˜ï¼šè®²Sized traitæ—¶ï¼Œæ‚¨æåˆ°<br><br>  &quot;åœ¨å°‘æ•°æƒ…å†µä¸‹ï¼Œéœ€è¦ T æ˜¯å¯å˜ç±»å‹çš„ï¼Œ...&quot;<br><br>æˆ‘ç†è§£è¿™é‡Œæ˜¯æƒ³è¯´<br><br>  &quot;åœ¨å°‘æ•°æƒ…å†µä¸‹ï¼Œ éœ€è¦å…è®¸Tæ˜¯**å¯å˜å¤§å°**çš„ç±»å‹ï¼Œ...&quot;<br><br>å¯¹ä¸ï¼Ÿ æˆ‘ä¸ªäººè®¤ä¸ºè¯´Tæ˜¯â€œå¯å˜ç±»å‹çš„â€ï¼Œæ˜¾å¾—æœ‰ç‚¹å«æ··ï¼šTæœ¬èº«å°±æ˜¯èŒƒå‹å‚æ•°ï¼Œå¯&quot;å˜&quot;ä¸ºå„ç§å…·ä½“ç±»å‹ã€‚è¿™é‡Œæ˜¾ç„¶ä¸æ˜¯è®²è¿™ä¸ªï¼Œä¸ç†Ÿåçœçš„åˆå­¦è€…å¯èƒ½ä¼šæœ‰ç‚¹å›°æƒ‘ã€‚","like_count":0},{"had_liked":false,"id":333876,"user_name":"Isaac.","can_delete":false,"product_type":"c1","uid":1101264,"ip_address":"","ucode":"C4856E35365963","user_header":"https://static001.geekbang.org/account/avatar/00/10/cd/d0/8d3dc9ef.jpg","comment_is_top":false,"comment_ctime":1644568494,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1644568494","product_id":100085301,"comment_content":"Performs copy-assignment from source.<br><br>a.clone_from(&amp;b) is equivalent to a = b.clone() in functionality, but can be overridden to reuse the resources of a to avoid unnecessary allocations.<br><br>è€å¸ˆï¼Œå®˜æ–¹æ–‡æ¡£æ²¡è¯´ clone_from é»˜è®¤å®ç°å¯ä»¥é¿å…å†…å­˜åˆ†é…ï¼Œè€Œæ˜¯å¯ä»¥é€šè¿‡è¢«é‡å†™å®ç°ã€‚è¿™é‡Œå¦‚ä½•è¯æ˜ç¡®å®æœ‰é¿å…å†…å­˜åˆ†é…å‘¢","like_count":0},{"had_liked":false,"id":329246,"user_name":"GE","can_delete":false,"product_type":"c1","uid":2773127,"ip_address":"","ucode":"A916BA2792FC0F","user_header":"https://static001.geekbang.org/account/avatar/00/2a/50/87/a6637d48.jpg","comment_is_top":false,"comment_ctime":1641256916,"is_pvip":false,"replies":[{"id":"120744","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1079375","ctime":1642307703,"ip_address":"","comment_id":329246,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1641256916","product_id":100085301,"comment_content":"1. ä¸èƒ½ï¼Œä½†æ˜¯è¿™é‡Œå’ŒTå…³ç³»æ— å…³ï¼Œè€Œæ˜¯å› ä¸ºVecæœ¬èº«å·²ç»å®ç°äº†Drop traitï¼Œæ‰€ä»¥å’ŒCopy traitæ˜¯å†²çªçš„<br>```<br>&#47;&#47; source code<br>unsafe impl&lt;#[may_dangle] T, A: Allocator&gt; Drop for Vec&lt;T, A&gt;<br>```<br><br>","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546382,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642307703,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":325685,"user_name":"james","can_delete":false,"product_type":"c1","uid":1047569,"ip_address":"","ucode":"EF807B11AF0B05","user_header":"https://static001.geekbang.org/account/avatar/00/0f/fc/11/677b83ba.jpg","comment_is_top":false,"comment_ctime":1639098473,"is_pvip":false,"replies":[{"id":"118822","content":"self.value ä¸æ˜¯ &amp;Self.Target å•Šï¼Œself.value åœ¨æ‹¿ Self.Targetï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¼šåš moveã€‚ä»¥ä¸‹ä»£ç ä¼šæŠ¥é”™ï¼Œå¦‚æœä½ æŠŠ get_inner(&amp;self) æ¢æˆ get_inner(self)ï¼Œå°±å¯ä»¥ï¼š<br><br>```rust<br>struct Container {<br>    inner: String,<br>}<br><br>impl Container {<br>    pub fn get_inner(&amp;self) -&gt; String {<br>        self.inner<br>    }<br>}<br>```","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1079375","ctime":1639805626,"ip_address":"","comment_id":325685,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1639098473","product_id":100085301,"comment_content":"å‘è€å¸ˆè¯·æ•™ä¸€ä¸ªé—®é¢˜ï¼šåœ¨å¦‚ä¸‹DerefèŒƒä¾‹ä¸­ï¼Œæ—¢ç„¶derefçš„selfå˜é‡æ˜¯&amp;Selfç±»å‹ï¼Œé‚£self.valueçš„ç±»å‹åº”è¯¥å°±æ˜¯&amp;Self.Targetï¼Œä½†æ±‰æœè¿”å›æ—¶ä¸ºä½•è¿˜è¦åœ¨self.valueå‰åŠ &amp;å‘¢ï¼Ÿ<br><br>use std::ops::Deref;<br><br>struct DerefExample&lt;T&gt; {<br>    value: T<br>}<br>impl&lt;T&gt; Deref for DerefExample&lt;T&gt; {<br>    type Target = T;<br><br>    fn deref(&amp;self) -&gt; &amp;Self::Target {<br>        &amp;self.value<br>    }<br>}<br><br>","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539698,"discussion_content":"self.value ä¸æ˜¯ &amp;Self.Target å•Šï¼Œself.value åœ¨æ‹¿ Self.Targetï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¼šåš moveã€‚ä»¥ä¸‹ä»£ç ä¼šæŠ¥é”™ï¼Œå¦‚æœä½ æŠŠ get_inner(&amp;self) æ¢æˆ get_inner(self)ï¼Œå°±å¯ä»¥ï¼š\n\n```rust\nstruct Container {\n    inner: String,\n}\n\nimpl Container {\n    pub fn get_inner(&amp;self) -&gt; String {\n        self.inner\n    }\n}\n```","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639805626,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":323127,"user_name":"ä½œæ­»çš„å¡åŸº","can_delete":false,"product_type":"c1","uid":1236784,"ip_address":"","ucode":"AC4DFF32FA9CC5","user_header":"https://static001.geekbang.org/account/avatar/00/12/df/30/338409a9.jpg","comment_is_top":false,"comment_ctime":1637737033,"is_pvip":false,"replies":[{"id":"118890","content":"é¦–å…ˆ Rust æ²¡æœ‰ç±»çš„æ¦‚å¿µï¼Œä¹Ÿæ²¡æœ‰ç»§æ‰¿çš„æ¦‚å¿µã€‚åœ¨ drop å®ç°çš„æ—¶å€™ï¼Œä½ åªéœ€è¦å…³å¿ƒä½ éœ€è¦è¿›è¡Œçš„å¯¹èµ„æºçš„é¢å¤–å¤„ç†ï¼ˆæ¯”å¦‚ç»´æŠ¤è®¡æ•°ä»€ä¹ˆçš„ï¼‰ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1079375","ctime":1639850693,"ip_address":"","comment_id":323127,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1637737033","product_id":100085301,"comment_content":"æƒ³è¯·æ•™ä¸€ä¸‹è€å¸ˆï¼Œæ¯”å¦‚è¦è‡ªå·±å®ç° Drop traitï¼Œæœ‰æ²¡æœ‰ç±»ä¼¼ Java ä¸­å­ç±»è¦†å†™çˆ¶ç±»æ–¹æ³•çš„æœºåˆ¶ï¼Œç”šè‡³è¦†å†™æ—¶è¿˜èƒ½ç”¨super.xxx()è¿˜èƒ½è°ƒç”¨çˆ¶ç±»çš„è¢«è¦†å†™æ–¹æ³•ã€‚è¿˜æ˜¯åªèƒ½è‡ªå·±æ–°å»ºä¸€ä¸ª traitï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539851,"discussion_content":"é¦–å…ˆ Rust æ²¡æœ‰ç±»çš„æ¦‚å¿µï¼Œä¹Ÿæ²¡æœ‰ç»§æ‰¿çš„æ¦‚å¿µã€‚åœ¨ drop å®ç°çš„æ—¶å€™ï¼Œä½ åªéœ€è¦å…³å¿ƒä½ éœ€è¦è¿›è¡Œçš„å¯¹èµ„æºçš„é¢å¤–å¤„ç†ï¼ˆæ¯”å¦‚ç»´æŠ¤è®¡æ•°ä»€ä¹ˆçš„ï¼‰ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639850693,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":323111,"user_name":"é˜¿æˆ","can_delete":false,"product_type":"c1","uid":1390032,"ip_address":"","ucode":"CEC3CD65FB9333","user_header":"https://static001.geekbang.org/account/avatar/00/15/35/d0/f2ac6d91.jpg","comment_is_top":false,"comment_ctime":1637732868,"is_pvip":false,"replies":[{"id":"118894","content":"ğŸ‘ ä¹Ÿå¯ä»¥çœ‹çœ‹æˆ‘åœ¨ github repo ä¸‹çš„ç­”æ¡ˆ","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1079375","ctime":1639850753,"ip_address":"","comment_id":323111,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1637732868","product_id":100085301,"comment_content":"impl&lt;T&gt; Index&lt;isize&gt; for List&lt;T&gt; {<br>    type Output = T;<br><br>    fn index(&amp;self, index: isize) -&gt; &amp;Self::Output {<br>        let len = self.len() as isize;<br>        if len == 0 {<br>            panic!(&quot;empty list&quot;);<br>        }<br>        let index = (index % len + len) % len;<br>        self.iter().nth(index as usize).unwrap()<br>    }<br>}<br>","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539855,"discussion_content":"ğŸ‘ ä¹Ÿå¯ä»¥çœ‹çœ‹æˆ‘åœ¨ github repo ä¸‹çš„ç­”æ¡ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639850753,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":322524,"user_name":"æ ¸æ¡ƒ","can_delete":false,"product_type":"c1","uid":1385204,"ip_address":"","ucode":"7AB05270CBCCCB","user_header":"https://static001.geekbang.org/account/avatar/00/15/22/f4/9fd6f8f0.jpg","comment_is_top":false,"comment_ctime":1637463421,"is_pvip":false,"replies":[{"id":"118903","content":"ä¸éœ€è¦é¢å¤–çš„å†…å­˜åˆ†é…äº†","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1079375","ctime":1639851858,"ip_address":"","comment_id":322524,"utype":1}],"discussion_count":3,"race_medal":0,"score":"1637463421","product_id":100085301,"comment_content":"clone_from è¿™é‡Œè¯´æé«˜æ•ˆç‡çš„ï¼Œæ²¡çœ‹å‡ºæ¥åŒºåˆ«åˆ°åº•åœ¨å“ªé‡Œï¼Œæºç é‡Œé¢ä¹Ÿæ˜¯ç›´æ¥ cloneçš„ï¼Ÿè§£é‡Šä¹Ÿæ²¡çœ‹æ‡‚ï¼Œå¤šè°¢äº†ã€‚","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539864,"discussion_content":"ä¸éœ€è¦é¢å¤–çš„å†…å­˜åˆ†é…äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639851858,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2755534,"avatar":"https://static001.geekbang.org/account/avatar/00/2a/0b/ce/f0c520d1.jpg","nickname":"é¹…å¸®é€®","note":"","ucode":"A6DB1BEFDA5D9A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":568918,"discussion_content":"https://www.jianshu.com/p/9570dec6a0cf","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1651248168,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1390032,"avatar":"https://static001.geekbang.org/account/avatar/00/15/35/d0/f2ac6d91.jpg","nickname":"é˜¿æˆ","note":"","ucode":"CEC3CD65FB9333","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":532870,"discussion_content":"å¯ä»¥çœ‹æˆ‘è¡¥å……çš„ç¬”è®°â€¦â€¦è™½ç„¶æˆ‘ä¹Ÿä¸çŸ¥é“ç†è§£å¾—å¯¹ä¸å¯¹â€¦â€¦","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637723612,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"user_type\":1}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":322085,"user_name":"ä¸‰å¶è™«tlb","can_delete":false,"product_type":"c1","uid":1010499,"ip_address":"","ucode":"A8236974932E6E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/6b/43/b6bcab56.jpg","comment_is_top":false,"comment_ctime":1637160906,"is_pvip":false,"replies":[{"id":"118911","content":"å¯¹ï¼Œå¦‚æœä½ çš„ struct ä½¿ç”¨çš„æ˜¯åŒ¿åçš„å­—æ®µ","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1079375","ctime":1639852267,"ip_address":"","comment_id":322085,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1637160906","product_id":100085301,"comment_content":"&amp;self.0ï¼Œ0æ˜¯æŒ‡ä¸‹æ ‡ç¬¬ä¸€ä¸ªå±æ€§çš„æ„æ€å—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539872,"discussion_content":"å¯¹ï¼Œå¦‚æœä½ çš„ struct ä½¿ç”¨çš„æ˜¯åŒ¿åçš„å­—æ®µ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639852267,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1390032,"avatar":"https://static001.geekbang.org/account/avatar/00/15/35/d0/f2ac6d91.jpg","nickname":"é˜¿æˆ","note":"","ucode":"CEC3CD65FB9333","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":532872,"discussion_content":"0 æŒ‡ tuple/tuple struct çš„ ç¬¬ä¸€ä¸ªå­—æ®µ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637723783,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"user_type\":1}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":318608,"user_name":"æ ¸æ¡ƒ","can_delete":false,"product_type":"c1","uid":1385204,"ip_address":"","ucode":"7AB05270CBCCCB","user_header":"https://static001.geekbang.org/account/avatar/00/15/22/f4/9fd6f8f0.jpg","comment_is_top":false,"comment_ctime":1635347601,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1635347601","product_id":100085301,"comment_content":"è€å¸ˆï¼Œè¿™ä¸€èŠ‚çš„å†…å®¹ï¼Œå»ºè®®å¯ä»¥è€ƒè™‘é‡‡ç”¨åµŒå¥—ä¸€äº›jsonæ•°æ®ç»“æ„è§£æçš„æ–¹å¼æ¥è®²è§£ä¸€ä¸‹åˆ°åº•é‚£äº›æ¥å£æœ‰ä»€ä¹ˆä½œç”¨ï¼Œä¾‹å¦‚å¯¹hashmapçš„å¤šå±‚åµŒå¥—ï¼Œå¯ä»¥é€šè¿‡get_mutæ¥å®ç°ä¿®æ”¹ï¼Œä¸è¦é€šè¿‡getæ–¹æ³•ã€‚å½“ç„¶è¿™ä¸ªåªæ˜¯ä¸€ä¸ªä¾‹å­å“ˆã€‚","like_count":0},{"had_liked":false,"id":317425,"user_name":"è™¢åœ‹æŠ€é†¬","can_delete":false,"product_type":"c1","uid":1056807,"ip_address":"","ucode":"5A192262AA037E","user_header":"https://static001.geekbang.org/account/avatar/00/10/20/27/a6932fbe.jpg","comment_is_top":false,"comment_ctime":1634793714,"is_pvip":false,"replies":[{"id":"115238","content":"æ…¢æ…¢æ¥","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1635121846,"ip_address":"","comment_id":317425,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1634793714","product_id":100085301,"comment_content":"æ‰“ä¸ªå¡ï¼Œè¿™ä¸€èŠ‚å†…å®¹æœ‰ç‚¹å¤šï¼Œæ–­æ–­ç»­ç»­å¤šäº†å¥½å‡ éæ‰è¯»å®Œ","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":528811,"discussion_content":"æ…¢æ…¢æ¥","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635121846,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":314532,"user_name":"qgaye","can_delete":false,"product_type":"c1","uid":1702112,"ip_address":"","ucode":"E817609D4ED2D6","user_header":"https://static001.geekbang.org/account/avatar/00/19/f8/e0/d6e3cc8f.jpg","comment_is_top":false,"comment_ctime":1633179850,"is_pvip":false,"replies":[{"id":"113968","content":"è¯·ä»”ç»†çœ‹æ–‡ç« ï¼Œæˆ‘å†™çš„æ˜¯æ˜¯ vec![1, 2, 3, 4]ã€‚<br><br>https:&#47;&#47;doc.rust-lang.org&#47;std&#47;macro.vec.html","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1633320093,"ip_address":"","comment_id":314532,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1633179850","product_id":100085301,"comment_content":"è¯·æ•™è€å¸ˆï¼Œä¸ºå•¥ [1, 2, 3, 4] æ˜¯ impl Into&lt;Vec&lt;T&gt;&gt; è¿™ä¸ªç±»å‹å‘¢","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527714,"discussion_content":"è¯·ä»”ç»†çœ‹æ–‡ç« ï¼Œæˆ‘å†™çš„æ˜¯æ˜¯ vec![1, 2, 3, 4]ã€‚\n\nhttps://doc.rust-lang.org/std/macro.vec.html","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633320093,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":314172,"user_name":"xl000","can_delete":false,"product_type":"c1","uid":1117935,"ip_address":"","ucode":"6FEABE7F7D0DC0","user_header":"https://static001.geekbang.org/account/avatar/00/11/0e/ef/030e6d27.jpg","comment_is_top":false,"comment_ctime":1632885513,"is_pvip":false,"replies":[{"id":"113981","content":"å—¯ï¼Œä¸é”™ã€‚ç”¨ let n = (len + index % len) % len; æ›´ç®€æ´äº›ã€‚ä¸”å¯¹ä¸€ä¸ªé•¿åº¦ä¸º 10 çš„ listï¼Œèƒ½å¤Ÿæ­£ç¡®å¤„ç† list[-65536]ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1633321979,"ip_address":"","comment_id":314172,"utype":1}],"discussion_count":1,"race_medal":5,"score":"1632885513","product_id":100085301,"comment_content":"```rust<br>impl&lt;T&gt; Index&lt;isize&gt; for List&lt;T&gt; {<br>    type Output = T;<br><br>    fn index(&amp;self, index: isize) -&gt; &amp;Self::Output {<br>        let len = self.len() as isize;<br>        let mut n = if index &lt; 0 { len + index } else { index };<br>        if n &gt;= len || n &lt; 0 {<br>            n = 0;<br>        }<br>        self.iter().nth(n as usize).unwrap()<br>    }<br>}<br>```","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527598,"discussion_content":"å—¯ï¼Œä¸é”™ã€‚ç”¨ let n = (len + index % len) % len; æ›´ç®€æ´äº›ã€‚ä¸”å¯¹ä¸€ä¸ªé•¿åº¦ä¸º 10 çš„ listï¼Œèƒ½å¤Ÿæ­£ç¡®å¤„ç† list[-65536]ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633321979,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":313645,"user_name":"ç½—æ°","can_delete":false,"product_type":"c1","uid":1320487,"ip_address":"","ucode":"96BAFAA147341F","user_header":"https://static001.geekbang.org/account/avatar/00/14/26/27/eba94899.jpg","comment_is_top":false,"comment_ctime":1632578974,"is_pvip":false,"replies":[{"id":"113751","content":"æ²¡æ˜ç™½ä½ çš„é—®é¢˜ã€‚æˆ‘æ˜¯æƒ³è¯´ï¼Œå†…å­˜æ³„æ¼ä¸ä¼šå¯¼è‡´ç¨‹åºå´©æºƒï¼Œä¸ä¼šè®©ç¨‹åºçš„è¡Œä¸ºå‡ºç°é—®é¢˜ï¼›è€Œ use after free ä¼šå¯¼è‡´ç¨‹åºå‡ºç°é¢„æœŸå¤–çš„è¡Œä¸ºã€‚ä»è¿™ä¸ªè§’åº¦æ¥è®²é˜²æ­¢ use after free è¿™æ ·çš„å®‰å…¨æ€§é—®é¢˜æ›´é‡è¦ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1632799198,"ip_address":"","comment_id":313645,"utype":1}],"discussion_count":1,"race_medal":2,"score":"1632578974","product_id":100085301,"comment_content":"&quot;å®é™…ä¸Šï¼Œä»»ä½•ç¼–ç¨‹è¯­è¨€éƒ½æ— æ³•ä¿è¯ä¸å‘ç”Ÿäººä¸ºçš„å†…å­˜æ³„æ¼ï¼Œæ¯”å¦‚ç¨‹åºåœ¨è¿è¡Œæ—¶ï¼Œå¼€å‘è€…ç–å¿½äº†ï¼Œå¯¹å“ˆå¸Œè¡¨åªæ·»åŠ ä¸åˆ é™¤ï¼Œå°±ä¼šé€ æˆå†…å­˜æ³„æ¼ã€‚ä½† Rust ä¼šä¿è¯å³ä½¿å¼€å‘è€…ç–å¿½äº†ï¼Œä¹Ÿä¸ä¼šå‡ºç°å†…å­˜å®‰å…¨é—®é¢˜ã€‚&quot;ï¼ŒRust å¯ä»¥ä¿è¯å¯¹å“ˆå¸Œè¡¨åªæ·»åŠ ï¼Œä¸åˆ é™¤ï¼Œè¿˜ä¸ä¼šæœ‰å†…å­˜æ³„æ¼å—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527422,"discussion_content":"æ²¡æ˜ç™½ä½ çš„é—®é¢˜ã€‚æˆ‘æ˜¯æƒ³è¯´ï¼Œå†…å­˜æ³„æ¼ä¸ä¼šå¯¼è‡´ç¨‹åºå´©æºƒï¼Œä¸ä¼šè®©ç¨‹åºçš„è¡Œä¸ºå‡ºç°é—®é¢˜ï¼›è€Œ use after free ä¼šå¯¼è‡´ç¨‹åºå‡ºç°é¢„æœŸå¤–çš„è¡Œä¸ºã€‚ä»è¿™ä¸ªè§’åº¦æ¥è®²é˜²æ­¢ use after free è¿™æ ·çš„å®‰å…¨æ€§é—®é¢˜æ›´é‡è¦ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632799198,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":313548,"user_name":"èŠ¥æœ«å°é¾™","can_delete":false,"product_type":"c1","uid":1176417,"ip_address":"","ucode":"387D01880867AC","user_header":"https://static001.geekbang.org/account/avatar/00/11/f3/61/8f7fca5b.jpg","comment_is_top":false,"comment_ctime":1632489166,"is_pvip":false,"replies":[{"id":"113750","content":"éå¸¸æ£’ï¼<br><br>2. Arc  å®ç°äº† Derefï¼Œä½†æ²¡æœ‰å®ç° DerefMut å“¦ã€‚Arc æ˜¯ä¸å…è®¸ mut çš„ã€‚<br>","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1632799062,"ip_address":"","comment_id":313548,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1632489166","product_id":100085301,"comment_content":"1.Boxã€Vecç­‰å¥½åƒä¸å…·å¤‡Copyå±æ€§ç±»å‹ã€‚æ‰€ä»¥ä¸è¡Œï¼Œ<br>2.Arc å®ç°äº† Deref å’Œ DerefMut trait<br>3.ç›´æ¥ä¸Šç¬¬ä¸‰é¢˜ï¼Œç”¨çš„ç¬¨æ–¹æ³•ã€‚<br>impl&lt;T&gt; Index&lt;isize&gt; for List&lt;T&gt; {<br>    type Output = T;<br><br>    fn index(&amp;self, index: isize) -&gt; &amp;Self::Output {<br>        match (self.0.len().checked_sub(index.abs() as usize)) &gt; Some(0) {<br>            false =&gt; return self.0.iter().next().unwrap(),<br>            true =&gt; {<br>                let mut i = 0;<br>                let mut iter = self.0.iter();<br>                loop {<br>                    if i == index &amp;&amp; index &gt;= 0 {<br>                        return iter.next().unwrap();<br>                    }<br>                    if index &lt; 0 &amp;&amp; i == index + self.0.len() as isize {<br>                        return iter.next().unwrap();<br>                    }<br>                    iter.next();<br>                    i = i + 1;<br>                }<br>            }<br>        };<br>    }<br>}","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527386,"discussion_content":"éå¸¸æ£’ï¼\n\n2. Arc  å®ç°äº† Derefï¼Œä½†æ²¡æœ‰å®ç° DerefMut å“¦ã€‚Arc æ˜¯ä¸å…è®¸ mut çš„ã€‚\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632799062,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1401568,"avatar":"https://static001.geekbang.org/account/avatar/00/15/62/e0/d2ff52da.jpg","nickname":"è®°äº‹æœ¬","note":"","ucode":"FA942636EE0CC8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":397155,"discussion_content":"çœŸæ£’","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632572190,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}