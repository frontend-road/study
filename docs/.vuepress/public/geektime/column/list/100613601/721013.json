{"id":721013,"title":"27ï½œThreadLocalï¼ˆä¸‹ï¼‰ï¼šThreadLocalå®¶æ—æˆå‘˜åŠåº”ç”¨æŒ‡å—","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯åº·æ¨ã€‚</p><p>é€šè¿‡ä¸ŠèŠ‚è¯¾çš„å­¦ä¹ ç›¸ä¿¡ä½ å¯¹ ThreadLocal å·²ç»æœ‰äº†æ·±åˆ»çš„ç†è§£ï¼Œä½†æ˜¯åœ¨å¤æ‚çš„ç°å®ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œå•é ThreadLocal æ‰€èƒ½è§£å†³çš„é—®é¢˜æ˜¯æœ‰é™çš„ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡äº†è§£ThreadLocalå®¶æ—çš„å…¶ä»–æˆå‘˜ï¼Œä»¥åŠThreadLocal åœ¨å®é™…åœºæ™¯ä¸­çš„å„ç§åº”ç”¨ï¼Œæ¥è¿›ä¸€æ­¥æå‡ThreadLocalçš„æˆ˜æ–—åŠ›ï¼Œå¸®ä½ åœ¨ç°å®ä¸­è§£å†³æ›´åŠ æ£˜æ‰‹çš„é—®é¢˜ã€‚</p><p>æ¥ä¸‹æ¥å°±è®©æˆ‘ä»¬è¿›å…¥ThreadLocalçš„æ±Ÿæ¹–ï¼Œé¦–å…ˆå‡ºåœºçš„å°±æ˜¯ThreadLocalå®¶æ—çš„4ä¸ªæˆå‘˜ã€‚</p><h2>ThreadLocalå®¶æ—</h2><p>é€šè¿‡ä¸ŠèŠ‚è¯¾çš„å­¦ä¹ ï¼Œæˆ‘ä»¬çŸ¥é“ThreadLocalæ˜¯åœ¨JDK 1.2ä¸­å¼•å…¥çš„ï¼Œè§£å†³äº†ä¸€ä¸ªçº¿ç¨‹ä¸­å¤šä¸ªæ–¹æ³•é—´ä¿¡æ¯ä¼ é€’çš„é—®é¢˜ã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä¸ºäº†æå‡ç³»ç»Ÿçš„æ€§èƒ½ï¼Œå……åˆ†å‘æŒ¥å¤šæ ¸CPUçš„ä¼˜åŠ¿ï¼Œæˆ‘ä»¬ç»å¸¸é€šè¿‡å¢åŠ çº¿ç¨‹æˆ–è€…å¼‚æ­¥çš„æ–¹å¼æ¥æ›´å¥½åœ°å‘æŒ¥åº•å±‚ç¡¬ä»¶çš„æ€§èƒ½ã€‚</p><h3><strong>InheritableThreadLocal</strong></h3><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°±è‡ªç„¶å¼•å‡ºäº†<strong>çˆ¶å­çº¿ç¨‹</strong>çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯å¦‚ä½•ä¼˜é›…åœ°æŠŠçˆ¶çº¿ç¨‹çš„ä¿¡æ¯ä¼ é€’ç»™å­çº¿ç¨‹ï¼Œè¿™æ˜¾ç„¶è¶…å‡ºäº†ThreadLocalçš„èƒ½åŠ›èŒƒå›´ã€‚æ‰€ä»¥åœ¨JDK 1.3 ä¸­ï¼ŒJVM å¼•å…¥äº†<strong>InheritableThreadLocal</strong>ï¼Œåœ¨åˆ›å»ºå­çº¿ç¨‹æ—¶å°†çˆ¶çº¿ç¨‹çš„å˜é‡å‰¯æœ¬å¤åˆ¶åˆ°å­çº¿ç¨‹ä¸­ï¼Œå®ç°å­çº¿ç¨‹ç»§æ‰¿çˆ¶çº¿ç¨‹çš„å˜é‡å‰¯æœ¬ï¼Œä»è€Œæœ‰æ•ˆè§£å†³çˆ¶å­çº¿ç¨‹ä¹‹é—´å‚æ•°ä¼ é€’çš„é—®é¢˜ï¼Œå®ç°äº†è·¨çº¿ç¨‹çš„å˜é‡ä¼ é€’ã€‚</p><!-- [[[read_end]]] --><p>ä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¾‹å­æ¥å±•ç¤ºä¸€ä¸‹ã€‚</p><pre><code class=\"language-plain\">private final static ThreadLocal&lt;String&gt; threadLocalVar1 = new ThreadLocal&lt;&gt;();\n&nbsp;\nprivate final static InheritableThreadLocal&lt;String&gt; threadLocalVar2 = new InheritableThreadLocal&lt;&gt;();\n&nbsp;\npublic static void main(String[] args) {\n&nbsp;&nbsp;&nbsp; threadLocalVar1.set(\"GoodBoy\");\n&nbsp;&nbsp;&nbsp; Runnable runnable1 = () -&gt; &nbsp;&nbsp;\n&nbsp; &nbsp; System.out.println(Thread.currentThread().getName()+\"_\"+threadLocalVar1.get());\n&nbsp;&nbsp;&nbsp; new Thread(runnable1).start();\n&nbsp;\n&nbsp;&nbsp;&nbsp; threadLocalVar2.set(\"GoodGirl\");\n&nbsp;&nbsp;&nbsp; Runnable runnable2 = () -&gt;&nbsp;\n&nbsp; &nbsp; System.out.println(Thread.currentThread().getName()+\":\"+threadLocalVar2.get());\n&nbsp;&nbsp;&nbsp; new Thread(runnable2).start();\n}\n&nbsp;\nThread-0_null\nThread-1:GoodGirl\n</code></pre><p>ä»ä¾‹å­ä¸­ï¼Œä½ ä¼šå‘ç°å½“ä½¿ç”¨ThreadLocalæ—¶ï¼Œçˆ¶çº¿ç¨‹ä¸­åˆ›å»ºçš„çº¿ç¨‹å±€éƒ¨å˜é‡åœ¨å­çº¿ç¨‹ä¸­æ˜¯æ— æ³•å–åˆ°çš„ï¼Œä½†æ˜¯å€ŸåŠ©InheritableThreadLocalï¼Œæˆ‘ä»¬åœ¨å­çº¿ç¨‹ä¸­å®ç°äº†è·å–çˆ¶çº¿ç¨‹ä¸­è®¾ç½®çš„çº¿ç¨‹å±€éƒ¨å˜é‡ã€‚</p><p>InheritableThreadLocal è§£å†³äº†ThreadLocal ä¸èƒ½è·¨çˆ¶å­çº¿ç¨‹è¿›è¡Œå‚æ•°ä¼ é€’çš„é—®é¢˜ï¼Œä½†æ˜¯å½“é‡åˆ°çº¿ç¨‹æ± çš„åœºæ™¯åˆä¼šè§¦ç¢°åˆ°å®ƒçš„èƒ½åŠ›è¾¹ç•Œã€‚å› ä¸ºInheritableThreadLocal åœ¨ä¸€å¼€å§‹åˆ›å»ºå­çº¿ç¨‹æ—¶ï¼Œå°±å¯¹å­çº¿ç¨‹è¿›è¡Œæ‰€æœ‰å¯ç»§æ‰¿çº¿ç¨‹å±€éƒ¨å˜é‡çš„èµ‹å€¼ï¼Œä½†åœ¨é€šè¿‡çº¿ç¨‹æ± ç®¡ç†çº¿ç¨‹çš„åœºæ™¯ä¸‹ï¼Œç”±äºçˆ¶å­çº¿ç¨‹éƒ½æ˜¯ç”±çº¿ç¨‹æ± è¿›è¡Œç®¡ç†ï¼Œçº¿ç¨‹åœ¨æ¯æ¬¡ä½¿ç”¨ä¹‹å‰ä¸è§å¾—éƒ½æ˜¯éœ€è¦åˆ›å»ºæ‰èƒ½ä½¿ç”¨çš„ï¼Œæ‰€ä»¥ä¼šå‡ºç°å³ä½¿ä½¿ç”¨äº†InheritableThreadLocalï¼Œä¹Ÿæ— æ³•å¯¹å­çº¿ç¨‹æœ‰æ•ˆèµ‹å€¼çš„æƒ…å†µã€‚</p><h3><strong>TransmittableThreadLocal</strong></h3><p>å¥½åœ¨è¿™ä¸ªé—®é¢˜ï¼Œä¸šå†…å·²ç»æœ‰äº†è§£å†³æ–¹æ¡ˆï¼Œé˜¿é‡Œå·´å·´å¼€æºçš„<strong>TransmittableThreadLocal</strong>å®ç°äº†åœ¨çº¿ç¨‹æ± çš„åœºæ™¯ä¸‹ä¹Ÿèƒ½æ­£å¸¸è®¿é—®çˆ¶çº¿ç¨‹è®¾ç½®çš„çº¿ç¨‹å±€éƒ¨å˜é‡ã€‚ä»è€Œè§£å†³äº†çº¿ç¨‹æ± åœºæ™¯ä¸‹çˆ¶å­çº¿ç¨‹é—´å‚æ•°ä¼ é€’çš„é—®é¢˜ã€‚</p><p>ä½ å¯ä»¥çœ‹ä¸€ä¸‹TransmittableThreadLocal ä¸å…¶ä»–ä¸¤ä¸ªThreadLocal çš„å…³ç³»ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/9e/88/9e06857f7b7ae3cb914a0fb41c38d388.png?wh=1592x768\" alt=\"å›¾ç‰‡\" title=\"ThreadLocal å®¶æ—æˆå‘˜åŠåº”ç”¨æŒ‡å—\"></p><p>ä¸‹é¢è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç»å…¸çš„æ¡ˆä¾‹æ¥æ¼”ç¤º<strong>å¦‚ä½•ä½¿ç”¨&nbsp;TransmittableThreadLocal</strong>ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬åœ¨pom.xml æ–‡ä»¶ä¸­å¼•å…¥mavenä¾èµ–ã€‚</p><pre><code class=\"language-plain\">&lt;dependency&gt;\n&nbsp;&nbsp;&nbsp; &lt;groupId&gt;com.alibaba&lt;/groupId&gt;\n&nbsp;&nbsp;&nbsp; &lt;artifactId&gt;transmittable-thread-local&lt;/artifactId&gt;\n&nbsp;&nbsp;&nbsp; &lt;version&gt;2.14.2&lt;/version&gt;\n&lt;/dependency&gt;\n</code></pre><p>ç„¶åæˆ‘ä»¬æ¨¡æ‹Ÿç°å®ä¸­çœŸå®çš„ä¸šåŠ¡åœºæ™¯ï¼Œç”¨ä¸¤ä¸ªçº¿ç¨‹æ± æ¥åä½œå®Œæˆä¸šåŠ¡è¯·æ±‚çš„å¤„ç†ã€‚ç¬¬ä¸€ä¸ªçº¿ç¨‹æ± ç”¨äºå’Œå¤–éƒ¨è¯·æ±‚äº¤äº’ï¼Œæ¥æ”¶å’Œå¤„ç†è¯·æ±‚ï¼Œè®¾ç½®ç›¸åº”çš„ä¸Šä¸‹æ–‡ç¯å¢ƒã€‚ç¬¬äºŒä¸ªçº¿ç¨‹æ± ç”¨äºå•çº¯çš„ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼Œå€ŸåŠ©&nbsp;TransmittableThreadLocal ç±»å‹å˜é‡&nbsp;contextThreadLocalï¼Œæˆ‘ä»¬åœ¨é€»è¾‘å¤„ç†çº¿ç¨‹LogicThreadä¸­è¯»å–åˆ°äº†ReqThreadä¸­è®¾ç½®çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä»è€Œå®ç°äº†æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å’Œå¤–éƒ¨è¯·æ±‚ä¹‹é—´çš„è§£è€¦ã€‚</p><pre><code class=\"language-plain\">public class ReqService {&nbsp; &nbsp;\n&nbsp;   private static final&nbsp; int threadCnt = 3;\n&nbsp;&nbsp;&nbsp; private static TransmittableThreadLocal&lt;Integer&gt; contextThreadLocal = new TransmittableThreadLocal&lt;&gt;();\n&nbsp;\n&nbsp;&nbsp;&nbsp; //æ¥æ”¶å’Œå¤„ç†è¯·æ±‚çš„çº¿ç¨‹æ± \n&nbsp;&nbsp;&nbsp; private static ExecutorService mainExecutors = Executors.newFixedThreadPool(threadCnt);\n&nbsp;&nbsp;&nbsp; //çœŸæ­£å¤„ç†ä¸šåŠ¡é€»è¾‘çš„çº¿ç¨‹æ± \n&nbsp;&nbsp;&nbsp; private static ExecutorService execExecutors =\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; TtlExecutors.getTtlExecutorService(Executors.newFixedThreadPool(threadCnt));\n&nbsp;\n&nbsp;&nbsp;&nbsp; public static void main(String[] args) {\n&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IntStream.range(0,threadCnt).forEach(i-&gt;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mainExecutors.submit(new ReqThread(i));\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; });\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Thread.sleep(600);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } catch (InterruptedException e) {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; e.printStackTrace();\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; execExecutors.shutdown();\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mainExecutors.shutdown();\n&nbsp;&nbsp;&nbsp; }\n&nbsp;\n&nbsp;&nbsp;&nbsp; // æ­¤å¤„æ¨¡æ‹Ÿæ¥æ”¶è¯·æ±‚çš„çº¿ç¨‹\n&nbsp;&nbsp;&nbsp; static class ReqThread implements Runnable {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private int i;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public ReqThread(int i) {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.i = i;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; @Override\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void run() {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.out.println(Thread.currentThread().getName() + \":\" + i);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // æ­¤å¤„è®¾ç½®çº¿ç¨‹çš„ä¸Šä¸‹æ–‡\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; contextThreadLocal.set(i);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; execExecutors.submit(new LogicThread(Thread.currentThread().getName()));\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }\n&nbsp;&nbsp;&nbsp; }\n&nbsp;\n&nbsp;&nbsp;&nbsp; // æ­¤å¤„æ¨¡æ‹Ÿå®é™…å¤„ç†ä¸šåŠ¡é€»è¾‘çš„çº¿ç¨‹\n&nbsp;&nbsp;&nbsp; static class&nbsp; LogicThread implements Runnable {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private String parentThreadName;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public LogicThread(String parentThreadName) {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.parentThreadName = parentThreadName;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; @Override\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void run() {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.out.println( \"parentThreadName:\" + parentThreadName + \":\" + contextThreadLocal.get() );\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }\n&nbsp;&nbsp;&nbsp; }\n}&nbsp;\n</code></pre><p>ä¸ºäº†å¸®ä½ æ›´å¥½åœ°ç†è§£ä¸Šé¢è¿™æ®µä»£ç ï¼Œæˆ‘ç”»äº†ä¸€å¼ å›¾ã€‚ç»“åˆå›¾ç‰‡ï¼Œä½ ä¼šå‘ç°è¿™ç§å†™æ³•æ—¢ç¬¦åˆé«˜å†…èšã€ä½è€¦åˆçš„æ€æƒ³ï¼ŒåŒæ—¶ä¹Ÿç¬¦åˆäº†å•ä¸€èŒè´£åŸåˆ™ï¼ˆSingle Responsibility Principleï¼ŒSRPï¼‰ï¼Œä½ å¯ä»¥ä»”ç»†ä½“ä¼šä¸€ä¸‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/78/9d/7822b6e69ecbd23e0b734ecc87e06a9d.png?wh=1920x1127\" alt=\"å›¾ç‰‡\"></p><h3>FastThreadLocal</h3><p>æœ€åä¸€ä¸ªå‡ºåœºçš„æ˜¯<strong>FastThreadLocal</strong>ã€‚ä¸ŠèŠ‚è¯¾ï¼Œæˆ‘ä»¬æåˆ°ThreadLocalMapæ˜¯é€šè¿‡çº¿æ€§æ¢æµ‹çš„å¼€æ”¾å®šå€æ³•è§£å†³Hashå†²çªçš„é—®é¢˜ï¼Œå½“Hashå†²çªä¸¥é‡æ—¶è¯¥æ–¹æ¡ˆä¼šå‡ºç°æ€§èƒ½é—®é¢˜ã€‚ä¸ºæ­¤Nettyè¿›è¡Œäº†ä¼˜åŒ–ï¼Œä¹Ÿæ˜¯è¿ç”¨ç©ºé—´æ¢æ—¶é—´çš„æ€æƒ³ï¼Œé€šè¿‡ç”¨ä¸€ä¸ªå±æ€§ä¿å­˜mapçš„ä¸‹æ ‡ä½ç½®ï¼Œç”¨ä¸‹æ ‡ç›´æ¥æ‰¾åˆ°å¯¹åº”çš„ä½ç½®ï¼Œæ¥åº”å¯¹å¤§æ•°æ®é‡å’Œå¤§å¹¶å‘çš„åœºæ™¯ã€‚ä½†æ˜¯FashThreadLocalåœ¨ä½¿ç”¨æ—¶æœ‰ä¸€ä¸ªéœ€è¦ç‰¹åˆ«æ³¨æ„çš„åœ°æ–¹ï¼Œå°±æ˜¯<strong>å¿…é¡»ä¸Nettyæä¾›çš„FastThreadLocalThreadç»“åˆä½¿ç”¨</strong>æ‰èƒ½å‘æŒ¥ä½œç”¨ã€‚</p><p>è‡³æ­¤ï¼ŒThreadLocalå®¶æ—çš„æˆå‘˜å·²ç»å…¨éƒ¨ç»™ä½ ä»‹ç»å®Œäº†ï¼Œæˆ‘ä»¬è®¤è¯†äº†æ”¯æŒåœ¨æ–¹æ³•é—´ä¼ å‚çš„ThreadLocalã€ä¸ºäº†è§£å†³çˆ¶å­çº¿ç¨‹é—´ä¼ å‚çš„InheritableThreadLocalã€çº¿ç¨‹æ± åœºæ™¯ä¸‹çˆ¶å­çº¿ç¨‹ ä¼ å‚çš„è§£å†³æ–¹æ¡ˆ&nbsp;<a href=\"https://github.com/alibaba/transmittable-thread-local\">TransmittableThreadLocal</a>ï¼Œä»¥åŠ Netty ä¸ºäº†è¿½æ±‚é«˜æ€§èƒ½æ‰“é€ çš„ <a href=\"https://github.com/netty/netty\">FastThreadLocalThread</a>ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/d1/b4/d15155285427f2accd5a2cc2aea40eb4.jpg?wh=1920x672\" alt=\"å›¾ç‰‡\" title=\"ThreadLocalå®¶æ—æˆå‘˜ä¹‹é—´çš„å…³ç³»\"></p><h2>ThreadLocalå®¶æ—çš„åº”ç”¨åœºæ™¯</h2><p>ä¸çŸ¥é“æ­¤æ—¶ä½ æ˜¯å¦æœ‰ä¸€ç§æ„Ÿè§‰ï¼Œå°±æ˜¯<strong>ä»»ä½•ä¸€ä¸ªè§£å†³æ–¹æ¡ˆéƒ½æœ‰å®ƒçš„å±€é™æ€§ä¹Ÿæœ‰å®ƒåº”ç”¨çš„åœºæ™¯ã€‚</strong>æ‰€ä»¥åœ¨ç°å®ç¯å¢ƒä¸­é€‰æ‹©å“ªä¸ªè§£å†³æ–¹æ¡ˆï¼Œè¦æ ¹æ®éœ€æ±‚è€Œå®šï¼Œå¯¹é—®é¢˜æœ¬è´¨çš„ç†è§£è¿œè¿œæ¯”ç”¨ä»€ä¹ˆå·¥å…·å»è§£å†³æ›´åŠ é‡è¦ï¼Œæˆ‘ä»¬æ—¢è¦é¿å…ç”¨ç‰›åˆ€å»æ€é¸¡ï¼Œä¹Ÿè¦é¿å…ç”¨æ€é¸¡åˆ€å»å®°ç‰›ã€‚</p><p>ä¸‹é¢æˆ‘æ¥ä»‹ç»ä¸€ä¸‹ç°å®åœºæ™¯ä¸­å„ä¸ªThreadLocalçš„å®é™…åº”ç”¨ï¼Œå‘ä½ æ›´å¥½åœ°è¯ é‡Šè¿™ä¸€ç‚¹ï¼Œå¸Œæœ›èƒ½åŠ©ä½ åœ¨é‡åˆ°å®é™…é—®é¢˜æ—¶ï¼Œåˆç†åœ°åº”ç”¨ThreadLocalã€‚</p><h3><strong>éçº¿ç¨‹å®‰å…¨è½¬åŒ–ä¸ºçº¿ç¨‹å®‰å…¨</strong></h3><p>åœ¨JDK å¯¹å¤–æä¾›çš„å„ç§ç±»ä¸­ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰ç±»éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œè€ŒThreadLocalä¸€ä¸ªéå¸¸é‡è¦çš„ä½œç”¨å°±æ˜¯èƒ½å°†è¿™äº›éçº¿ç¨‹å®‰å…¨çš„ç±»ä»¥çº¿ç¨‹å®‰å…¨çš„æ–¹å¼ä½¿ç”¨ã€‚æ¯”å¦‚ SimpleDateFormat æœ¬ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œé€šè¿‡ThreadLocalçš„æ”¹é€ å´å¯ä»¥å½“æˆçº¿ç¨‹å®‰å…¨çš„ç±»æ¥ä½¿ç”¨ã€‚</p><p>æˆ‘ç»™å‡ºäº†ä¸€æ®µç¤ºä¾‹ä»£ç ï¼Œæˆ‘ä»¬çœ‹çœ‹ThreadLocalå…·ä½“æ˜¯æ€ä¹ˆåšçš„ï¼Œé€šè¿‡å¯¹SimpleDateFormatå˜é‡çš„å°è£… ï¼Œæˆ‘ä»¬æŠŠä¸€ä¸ªéçº¿ç¨‹å®‰å…¨çš„SimpleDateFormatå˜é‡ï¼Œå˜æˆäº†çº¿ç¨‹å®‰å…¨çš„ ThreadLocal<simpledateformat>ï¼Œè¿™å…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªç»å…¸çš„è£…é¥°å™¨æ¨¡å¼ï¼ˆDecorator&nbsp;Patternï¼‰çš„åº”ç”¨ã€‚å½“ç„¶å¦‚æœä½ ç”¨çš„æ˜¯JDK 1.8ä»¥ä¸Šç‰ˆæœ¬ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨DateTimeFormatterä»£æ›¿SimpleDateFormat ï¼Œå®ƒç›´æ¥å°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</simpledateformat></p><pre><code class=\"language-plain\">ThreadLocal&lt;SimpleDateFormat&gt; sdf = new ThreadLocal&lt;SimpleDateFormat&gt;() {\n&nbsp;&nbsp;&nbsp; @Override\n&nbsp;&nbsp;&nbsp; protected SimpleDateFormat initialValue() {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return new SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss\");\n&nbsp;&nbsp;&nbsp; }\n};\n</code></pre><h3><strong>è§£å†³è·¨å±‚ä¼ é€’å˜é‡çš„é—®é¢˜</strong></h3><p>åœ¨å¤æ‚çš„ç³»ç»Ÿä¸­ï¼Œå¯èƒ½éœ€è¦åœ¨ä¸åŒçš„å±‚ä¹‹é—´ä¼ é€’å˜é‡ï¼Œä¾‹å¦‚åœ¨Controllerå±‚ä¸­è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œç„¶ååœ¨Serviceå±‚ä¸­ä½¿ç”¨ç”¨æˆ·ä¿¡æ¯ã€‚ç”¨ThreadLocalå¯ä»¥<strong>åœ¨å½“å‰çº¿ç¨‹ä¸­å­˜å‚¨å˜é‡å€¼ï¼Œé¿å…è·¨å±‚ä¼ é€’å˜é‡çš„é—®é¢˜ã€‚</strong></p><p>åœ¨çœŸå®ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œé€šå¸¸HTTPè¯·æ±‚æ˜¯é€šè¿‡ç½‘å…³è¿›è¡Œæ¥å…¥ï¼Œé€šè¿‡ç½‘å…³è¿›è¡Œç³»ç»Ÿçš„å®‰å…¨é˜²æŠ¤å’Œè¯·æ±‚ä¿¡æ¯çš„è§£æã€‚é€šè¿‡é‡‡ç”¨<strong>æ‹¦æˆªå™¨ +ThreadLocal</strong>çš„æ–¹å¼ï¼Œå°†è§£æçš„è¯·æ±‚ä¿¡æ¯å­˜å‚¨åˆ°threadLocalä¸­ï¼Œåˆ©ç”¨å…¶çº¿ç¨‹éš”ç¦»ç‰¹æ€§ï¼ŒæŠŠè¿™ä¸ªè¯·æ±‚ç›¸å…³çš„ä¿¡æ¯é€ä¼ ç»™ä¸‹æ¸¸ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/2f/0c/2f9aed02ed6189f0fe44975fb75fb90c.png?wh=1920x543\" alt=\"å›¾ç‰‡\"></p><pre><code class=\"language-plain\">// åœ¨ä¸Šä¸‹æ–‡ä¸­ä¼ é€’çš„ä¿¡æ¯\npublic class&nbsp; Context {\n&nbsp;&nbsp;&nbsp; private String ip;\n&nbsp;&nbsp;&nbsp; public String getIp() {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return ip;\n&nbsp;&nbsp;&nbsp; }\n&nbsp;&nbsp;&nbsp; public void setIp(String ip) {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.ip = ip;\n&nbsp;&nbsp;&nbsp; }\n}\n&nbsp;\npublic class ContextHttpInterceptor implements HandlerInterceptor {\n&nbsp;\n&nbsp;&nbsp;&nbsp; private static&nbsp; final ThreadLocal&lt;Context&gt; contextThreadLocal = new ThreadLocal&lt;Context&gt;();\n&nbsp;\n&nbsp;&nbsp;&nbsp; @Override\n&nbsp;&nbsp;&nbsp; public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object o)&nbsp;&nbsp;throws Exception {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Context context = new Context();\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; String ip = request.getParameter(\"ip\");\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (StringUtils.isNotBlank(ip)){\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; context.setIp(ip);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; contextThreadLocal.set(context);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }catch (Exception e){\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return true;\n&nbsp;&nbsp;&nbsp; }\n&nbsp;\n&nbsp;&nbsp;&nbsp; @Override\n&nbsp;&nbsp;&nbsp; public void postHandle(HttpServletRequest request, HttpServletResponse resposne, Object o,\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ModelAndView modelAndView) throws Exception {\n&nbsp;\n&nbsp;&nbsp;&nbsp; }\n&nbsp;&nbsp;&nbsp; @Override\n&nbsp;&nbsp;&nbsp; public void afterCompletion(HttpServletRequest request, HttpServletResponse resposne,\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Object o, Exception e) throws Exception {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; contextThreadLocal.remove();\n&nbsp;&nbsp;&nbsp; }\n}\n</code></pre><h3>ThreadLocalå…¶ä»–åº”ç”¨åœºæ™¯</h3><p>é™¤æ­¤ä¹‹å¤–ï¼ŒThreadLocal&nbsp;åœ¨ä»¥ä¸‹åœºæ™¯ä¹Ÿå¾—åˆ°äº†å¹¿æ³›åº”ç”¨ã€‚</p><ul>\n<li>é“¾è·¯è¿½è¸ªåœºæ™¯ï¼›</li>\n<li>Springçš„äº‹åŠ¡ç®¡ç†å™¨ä¸­ï¼›</li>\n<li>å…¨é“¾è·¯æµé‡å‹æµ‹ä¸­ï¼Œå‹æµ‹æ ‡è®°é€ä¼ ï¼›</li>\n<li>æµç¨‹ç¼–æ’å¼•æ“çš„ä¸Šä¸‹æ–‡ä¼ é€’åœºæ™¯ï¼›</li>\n<li>å¤šæ•°æ®æºåœºæ™¯ä¸‹ï¼Œåˆ‡æ¢æ•°æ®æºæŸ¥è¯¢æ•°æ®ï¼›</li>\n<li>DDDä¸­å…­è¾¹å½¢æ¶æ„ã€è±å½¢æ¶æ„ï¼Œé€šè¿‡ThreadLocalå®ç°å„å±‚ä¹‹é—´çš„æ•°æ®ä¼ é€’ã€‚</li>\n</ul><p>æ„Ÿå…´è¶£çš„è¯ï¼Œæ¬¢è¿ä½ åœ¨è¯„è®ºåŒºå’Œæˆ‘ä¸€èµ·æ¢ç´¢å¦‚ä½•æ›´å¥½åœ°ä½¿ç”¨ThreadLocalã€‚</p><h2>æœ€ä½³å®è·µ</h2><p>ThreadLocalè™½ç„¶å¾ˆå¼ºå¤§ï¼Œå¹¶ä¸”åœ¨å„ç§ä¸šåŠ¡åœºæ™¯å’Œä¸­é—´ä»¶è§£å†³æ–¹æ¡ˆä¸­éƒ½å¾—åˆ°äº†å¹¿æ³›åœ°åº”ç”¨ ï¼Œä½†æ˜¯ä»»ä½•äº‹éƒ½æ˜¯ä¸€ä½“ä¸¤é¢çš„ï¼Œå¥½ç”¨çš„åŒæ—¶ä¹Ÿéšè—ç€é£é™©ï¼Œç¨ä¸ç•™å¿ƒå°±å®¹æ˜“æ‰å‘ã€‚ä¸‹é¢æˆ‘å°±æŠŠæˆ‘é‡åˆ°çš„ä¸€äº›å‘ç‚¹å’Œä½¿ç”¨ThreadLocalçš„ä¸€äº›å°æŠ€å·§åˆ†äº«ç»™ä½ ï¼Œå¸Œæœ›èƒ½å¸®ä½ åœ¨æ—¥å¸¸å·¥ä½œä¸­è§„é¿æ‰è¿™äº›é£é™©ï¼Œé‚£æ¥ä¸‹æ¥å°±è®©æˆ‘ä»¬è¿›å…¥åˆ°æœ€ä½³å®è·µç¯èŠ‚ã€‚</p><h3>å°æŠ€å·§ï¼šThreadLocalå˜é‡çš„åˆå§‹åŒ–</h3><p>JDK8 æä¾›äº†å¾ˆå¤šåŠŸèƒ½ï¼Œèƒ½å¤Ÿä½¿ä»£ç æ›´åŠ ç®€æ´å’Œä¼˜é›… ï¼Œæ¯”å¦‚ä¸‹é¢çš„ThreadLocalçš„åˆå§‹åŒ–ã€‚</p><pre><code class=\"language-plain\">// &nbsp;å†™æ³•ä¸€ï¼šé€šå¸¸å†™æ³•\nprivate static final ThreadLocal&lt;String&gt; THREAD_LOCAL_Common = new ThreadLocal&lt;String&gt;(){\n&nbsp;&nbsp;&nbsp; protected String initialValue() {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return \"Hello World\";\n&nbsp;&nbsp;&nbsp; }\n};\n// å†™æ³•äºŒï¼š JDK 1.8 å†™æ³•\nprivate static final ThreadLocal&lt;String&gt; THREAD_LOCAL_JDK8 = ThreadLocal.withInitial(()-&gt;\"Hello World\");&nbsp;\n</code></pre><p>å’Œä¸€èˆ¬å†™æ³•ç›¸æ¯”ï¼ŒJDK8çš„å†™æ³•æ˜¯ä¸æ˜¯çœ‹èµ·æ¥æ›´åŠ ç®€æ´äº†ï¼</p><h3>å°æŠ€å·§ï¼šå°†ThreadLocalè®¾ç½®ä¸ºå…¨å±€å˜é‡</h3><p>æˆ‘ä»¬ä¸ŠèŠ‚è¯¾é˜è¿°Threadã€ThreadLocalã€ThreadLocalMapã€Entryä¹‹é—´çš„å…³ç³»æ—¶ï¼Œæ›¾è¯´åˆ°å»ºè®®å°†ThreadLocalè®¾ç½®æˆå…¨å±€å˜é‡ï¼Œä½ æœ‰æ²¡æœ‰æƒ³è¿‡ä¸ºä»€ä¹ˆè¿™æ ·åšå‘¢ï¼Ÿ</p><p><strong>å°†ThreadLocalè®¾ç½®æˆstaticï¼Œä¸»è¦æ˜¯ä¸ºäº†æå‡å†…å­˜æ•ˆç‡ã€‚</strong>å¦‚æœThreadLocalå˜é‡ä¸æ˜¯staticçš„ï¼Œé’ˆå¯¹æŸä¸€ä¸ªå˜é‡ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæœ‰ä¸€ä¸ªå•ç‹¬çš„ThreadLocalå˜é‡ï¼Œå‡å¦‚æœ‰100ä¸ªçº¿ç¨‹é‚£å°±éœ€è¦åˆ›å»º100ä¸ªThreadLocalå¯¹è±¡ï¼Œè¿™åœ¨å†…å­˜ä½¿ç”¨ä¸Šæ˜¯ç›¸å½“ä½æ•ˆçš„ã€‚å¦‚æœå°†ThreadLocalè®¾ç½®ä¸ºstaticï¼Œé‚£ä¹ˆæ‰€æœ‰å¯¹è±¡å°±åªéœ€è¦ä¸€ä¸ªThreadLocalå˜é‡ï¼Œå¤§å¤§èŠ‚çœäº†å†…å­˜ã€‚</p><p>è€Œä¸”è®¾ç½®æˆstaticçš„è¯ï¼ŒThreadLocalä¼šåœ¨æ–¹æ³•åŒºåˆ†é…ï¼Œå¦åˆ™çš„è¯å°±æ˜¯åœ¨å †åˆ†é…ï¼Œ è¿™å¾ˆå¯èƒ½æˆä¸ºè§¦å‘GCçš„ä¸€ä¸ªè¯±å› ï¼Œè¿™åœ¨é«˜å¹¶å‘ã€é«˜æ€§èƒ½çš„ç³»ç»Ÿä¸­æ˜¯éœ€è¦æ ¼å¤–æ³¨æ„çš„ï¼Œé¿å…æˆä¸ºå‹ç¼©éª†é©¼çš„æœ€åä¸€æ ¹ç¨»è‰ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/ba/19/ba716ba4ee6ba9e00d7822162bd17f19.png?wh=1920x607\" alt=\"å›¾ç‰‡\"></p><h3>å°æŠ€å·§ï¼šThreadLocalå¯¹è±¡çš„ç”¨åå³åˆ </h3><p>è¿™é‡Œæˆ‘å…ˆç»™å‡ºæ¨èå†™æ³•ã€‚</p><pre><code class=\"language-plain\">try {\n&nbsp;&nbsp;// è®¾ç½®Threadlocal\nobjThreadLocal.set(...);\n// ä½¿ç”¨Threadlocal\ndoSomething();\n} finally {\n// ç§»é™¤Threadlocal\n&nbsp;objThreadLocal.remove();&nbsp;&nbsp; //ç§»é™¤ThreadLocalå˜é‡\n}\n</code></pre><p>ThreadLocalå¦‚æœä½¿ç”¨ä¸å½“ï¼Œæœ€å®¹æ˜“å¼•å‘çš„é—®é¢˜å°±æ˜¯<strong>å†…å­˜æ³„æ¼å’Œè„æ•°æ®</strong> ï¼Œè¿™äº›é—®é¢˜æ—¥å¸¸å¾ˆéš¾æ’æŸ¥ï¼Œä½†æ˜¯åœ¨å…³é”®æ—¶åˆ»å¾€å¾€æ˜¯è‡´å‘½çš„ã€‚è™½ç„¶åœ¨ä¸ŠèŠ‚è¯¾çš„æºç é˜é‡Šä¸­ï¼Œæˆ‘ä»¬è®²äº†ThreadLocalæœ¬èº«æ˜¯å¦‚ä½•è§„é¿è¿™äº›é—®é¢˜çš„ï¼Œä½†è¿™ä¸ä»£è¡¨ä½ å°±å¯ä»¥å¿½è§†è¿™ä¸ªé—®é¢˜ï¼Œåè€Œæ›´åº”è¯¥é‡è§†èµ·æ¥ï¼Œåœ¨ä½¿ç”¨æ—¶æ ¼å¤–å…³æ³¨ã€‚ä¸‹é¢æˆ‘å°±æ¥é‡ç‚¹é˜è¿°ä¸‹è¿™äº›é—®é¢˜æ˜¯å¦‚ä½•äº§ç”Ÿçš„ã€‚</p><p><strong>åœºæ™¯1ï¼šä»…å†…å­˜æ³„éœ²åœºæ™¯</strong></p><p>ThreadLocalMap ä¸­ Entry çš„ key æ˜¯ ThreadLocal å¯¹è±¡çš„å¼±å¼•ç”¨ï¼Œå½“ ThreadLocal å¯¹è±¡ä»…è¢«è¿™ä¸€ä¸ªå¯¹è±¡å¼•ç”¨æ—¶ï¼ŒThreadLocal å¯¹è±¡ä¼šåœ¨GCæ—¶è§¦å‘å›æ”¶ã€‚å½“ ThreadLocal å˜é‡è¢«å›æ”¶åï¼Œè¯¥ Entry çš„é”®å˜ä¸ºnullï¼Œä½ å¯ä»¥çœ‹ä¸€ä¸‹ä» Thread åˆ° ThreadLocal&nbsp;æ“ä½œçš„å˜é‡å¼•ç”¨å…³ç³»ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/3d/6c/3dbd307b37d4f44fc577a618264dcc6c.png?wh=1920x315\" alt=\"å›¾ç‰‡\"></p><p>ç”±äº&nbsp;Thread å¯¹ ThreadLocalMap æ˜¯å¼ºå¼•ç”¨ï¼ŒThreadLocalMap å¯¹ Entry æ˜¯å¼ºå¼•ç”¨ï¼ŒEntry é’ˆå¯¹Value ä¹Ÿæ˜¯å¼ºå¼•ç”¨ï¼Œæ‰€ä»¥å¦‚æœThreadä¸€ç›´ä¸é”€æ¯ï¼Œè¿™ä¸ªEntryå°±æ²¡åŠæ³•è¢«ç§»é™¤ï¼Œè¿™æ ·ä¸€æ¥è¢« Entry å¼•ç”¨çš„å˜é‡ä¸€ç›´å­˜åœ¨äºå†…å­˜ä¸­æ— æ³•è¢«å›æ”¶ï¼Œä»è€Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚ä½†æ˜¯ThreadLocal å†…å­˜æ³„éœ²çš„æ ¹å› æ˜¯<strong>ThreadLocalMapçš„ç”Ÿå‘½å‘¨æœŸå’ŒThreadä¸€æ ·é•¿</strong>ï¼Œå¦‚æœæ²¡æœ‰æ‰‹åŠ¨åˆ é™¤å¯¹åº”çš„keyä¼šå¯¼è‡´Entry( null,value )çš„å¯¹è±¡è¶Šæ¥è¶Šå¤šï¼Œå¼•å‘å†…å­˜æ³„éœ²ã€‚</p><p><span class=\"reference\">æ³¨ï¼šEntry å¯¹ThreadLocal ç±»å‹æ˜¯å¼±å¼•ç”¨ï¼Œå¯¹å˜é‡æ˜¯å¼ºå¼•ç”¨ã€‚</span></p><p><img src=\"https://static001.geekbang.org/resource/image/e0/3e/e0dbbe8380f8ab44c3da71f0f206b33e.png?wh=1920x1056\" alt=\"å›¾ç‰‡\"></p><p><strong>åœºæ™¯2ï¼šè„æ•°æ®å’Œå†…å­˜æ³„éœ²åœºæ™¯</strong></p><p>åœ¨å®é™…çš„ç”Ÿäº§ç¯èŠ‚ä¸­ï¼Œä¸ºäº†æå‡ç³»ç»Ÿæ€§èƒ½ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä½¿ç”¨çº¿ç¨‹æ± å¯¹çº¿ç¨‹è¿›è¡Œç®¡ç†ï¼Œæ¥å‡å°‘çº¿ç¨‹åˆ›å»ºå’Œå›æ”¶å¸¦æ¥çš„ç³»ç»Ÿæ€§èƒ½å¼€é”€ã€‚åœ¨è¿™ç§åœºæ™¯ä¸‹ä½¿ç”¨ThreadLocalï¼Œå¾ˆå®¹æ˜“å› çº¿ç¨‹å¤ç”¨äº§ç”Ÿè„æ•°æ®å’Œå†…å­˜æ³„éœ²çš„é—®é¢˜ã€‚</p><p>ç”±äºçº¿ç¨‹æ± å¯¹Threadå¯¹è±¡çš„å¤ç”¨ï¼Œä¸Threadç»‘å®šçš„ThreadLocalå˜é‡ï¼ˆä¸€èˆ¬ç”¨private &nbsp;staticä¿®é¥°ï¼‰ä¹Ÿä¼šè¢«å¤ç”¨ã€‚å¦‚æœè¯·æ±‚ç»“æŸåæ²¡æœ‰æ‰§è¡Œremove()æ–¹æ³•ï¼Œå¯¹åº”çš„ä¿¡æ¯ä¼šè¢«å¸¦åˆ°ä¸‹ä¸€æ¬¡è¯·æ±‚ä¸­ï¼Œä»è€Œé€ æˆè„æ•°æ®çš„é—®é¢˜ã€‚ä¸æ­¤åŒæ—¶ï¼Œéšç€è¯·æ±‚çš„æŒç»­è®¿é—®ï¼Œçº¿ç¨‹æŒç»­å¤ç”¨ï¼Œå†å²ç´¯è®¡çš„å˜é‡ä¼šä¸€ç›´å åŠ ï¼Œä»è€Œå¯¼è‡´å†…å­˜æ³„éœ²ã€‚æ‰€ä»¥åœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œ<strong>æ¯æ¬¡è¯·æ±‚åéœ€è¦æ‰§è¡Œremoveæ“ä½œ</strong>ã€‚</p><h3>å…¶ä»–æ³¨æ„äº‹é¡¹</h3><ul>\n<li>åœ¨ä½¿ç”¨ThreadLocalæ—¶ ï¼Œéœ€è¦è€ƒè™‘æ€§èƒ½é—®é¢˜ &nbsp;ï¼Œé¿å…è¿‡åº¦ä½¿ç”¨ThreadLocalå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚</li>\n<li>ThreadLocal å¸¦æ¥çµæ´»æ–¹ä¾¿çš„åŒæ—¶ä¹Ÿé™ä½äº†ä»£ç çš„å¯è¯»æ€§ï¼Œå¢åŠ äº†éšæ€§çš„æ½œè§„åˆ™ï¼Œæ‰€ä»¥è¦é¿å…æ»¥ç”¨ï¼Œå¹¶å†™å¥½ç›¸å…³ä»£ç æ³¨é‡Šï¼Œé¿å…å› ç»„ç»‡å˜åŠ¨ç­‰å› ç´ è§¦å‘çº¿ä¸Šé£é™©ã€‚</li>\n<li>è·¨çº¿ç¨‹å’Œçº¿ç¨‹æ± åœºæ™¯ä¸‹ï¼ŒThreadLocaléœ€è¦è°¨æ…ä½¿ç”¨ã€‚</li>\n<li>ThreadLocalMap å¹¶ä¸é€‚åˆå­˜æ”¾å¤§é‡çš„æ•°æ® ã€‚ThreadLocalMapé‡‡ç”¨çš„æ˜¯çº¿æ€§æ¢æµ‹çš„Hashå†²çªè§£å†³æ–¹æ¡ˆï¼Œæ ¹æ®Keyè®¡ç®—Hashå€¼ï¼Œä¸€æ—¦å‡ºç°å†²çªå°±å‘åæ¢æµ‹ï¼Œåˆ°å“ˆå¸Œè¡¨æœ«å°¾æ—¶å†ä»0å¼€å§‹ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªåˆé€‚ä½ç½®ï¼Œè¿™ç§ç®—æ³•å†³å®šäº† ThreadLocalMap å¹¶ä¸é€‚åˆå­˜æ”¾å¤§é‡æ•°æ®ã€‚</li>\n</ul><h2>é‡ç‚¹å›é¡¾</h2><p>å¥½äº†ï¼Œè¿™å°±æ˜¯ä»Šå¤©çš„ä¸»è¦å†…å®¹ï¼Œå…¶å®ThreadLocalçš„åº”ç”¨åœºæ™¯è¿œæ¯”æˆ‘ä¸Šé¢é˜è¿°çš„æ›´ä¸°å¯Œï¼Œå¾ˆæœŸå¾…èƒ½åœ¨è¯„è®ºåŒºçœ‹åˆ°ä½ çš„ç•™è¨€ï¼Œå’Œæˆ‘ä¸€èµ·æ¥æŒ–æ˜ThreadLocalæ›´å¤§çš„æ½œåŠ›ï¼Œä¸‹é¢æˆ‘å…ˆæ€»ç»“ä¸‹ä»Šå¤©çš„ä¸€äº›è¦ç‚¹ã€‚</p><p>é€šè¿‡ä»Šå¤©çš„å­¦ä¹ ï¼Œæˆ‘ä»¬å‘ç°ThreadLocalå¹¶ä¸æ˜¯åªæœ‰ä¸€ä¸ªç±»ï¼Œè€Œæ˜¯ä¸€ä¸ªå®¶æ—çš„ä»£åè¯ï¼Œå®ƒä»¬ä¸åˆ†ä¼¯ä»²åœ°åœ¨ä¸åŒçš„åº”ç”¨åœºæ™¯å‘æŒ¥ç€å„è‡ªçš„ä¼˜åŠ¿ï¼Œæ‰€ä»¥åœ¨æ—¥å¸¸çš„ä½¿ç”¨ä¸­å¦‚ä½•æ­£ç¡®åœ°é€‰æ‹©æ˜¯éå¸¸å…³é”®çš„ã€‚</p><p>ThreadLocalåœ¨æ•´ä¸ªjavaç”Ÿæ€å·²ç»å¾—åˆ°äº†å¹¿æ³›åº”ç”¨ï¼Œå¾ˆå¤šä½ è§‰å¾—éå¸¸ç‰›çš„åŠŸèƒ½èƒŒåå¾ˆå¯èƒ½å°±éšè—ç€ThreadLocalçš„èº«å½±ï¼Œä»Šå¤©æˆ‘ä»¬ä¸»è¦ä»‹ç»äº†å®ƒåœ¨éçº¿ç¨‹å®‰å…¨å˜é‡è½¬åŒ–ä¸ºçº¿ç¨‹å®‰å…¨ä»¥åŠè·¨å±‚ä¿¡æ¯ä¼ é€’é¢†åŸŸçš„åº”ç”¨ï¼Œåé¢æˆ‘ä¹Ÿå°†åœ¨å®æˆ˜ç¯‡ä¸ºä½ æ­ç¤ºThreadlocalåœ¨å…¶ä»–é¢†åŸŸä¸­å‘æŒ¥çš„é‡å¤§ä½œç”¨ã€‚æœ€åï¼Œå¸Œæœ›ä½ ä¸€å®šè¦é‡è§†ä½¿ç”¨ThreadLocalçš„æ½œåœ¨é£é™©ï¼Œå‰äººç”¨è¡€å’Œæ³ªæ¢æ¥çš„ç»éªŒè¿˜æ˜¯éå¸¸å€¼å¾—å€Ÿé‰´çš„ï¼Œå°¤å…¶æ˜¯å†…å­˜æ³„æ¼é—®é¢˜ï¼Œåˆ‡è®°ï¼</p><p><img src=\"https://static001.geekbang.org/resource/image/f7/89/f72a77a238ec2a1b9f1a03f9654dff89.jpg?wh=4190x3330\" alt=\"å›¾ç‰‡\"></p><h2>æ€è€ƒé¢˜</h2><p>ThreadLocalå››å¤§å®¶æ—æˆå‘˜çš„ä½¿ç”¨åœºæ™¯å’Œå„è‡ªä¼˜åŠ£åŠ¿æœ‰å“ªäº›ï¼Ÿä½ èƒ½è¯´å‡ºå‡ ä¸ªThreadLocalçš„åº”ç”¨åœºæ™¯ï¼Ÿä½¿ç”¨ThreadLocalçš„æ½œåœ¨é£é™©æœ‰å“ªäº›ï¼Œåº”è¯¥å¦‚ä½•é¿å…ï¼Ÿ</p><p>æ¬¢è¿ä½ æŠŠä½ å¯¹Threadlocalçš„åº”ç”¨åˆ†äº«åˆ°è¯„è®ºåŒºï¼Œæˆ‘ä»¬ä¸€èµ·äº¤æµè®¨è®ºï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™éœ€è¦çš„æœ‹å‹ï¼Œé‚€ä»–ä¸€èµ·å­¦ä¹ ã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼</p><h2>ğŸ’¡ ç‚¹äº®ä½ çš„çŸ¥è¯†æ¡†æ¶å›¾</h2><p><img src=\"https://static001.geekbang.org/resource/image/49/2e/497b4d3e92ce3c2c692516ed4292932e.jpg?wh=5700x4084\" alt=\"å›¾ç‰‡\"></p>","neighbors":{"left":{"article_title":"26ï½œThreadLocalï¼ˆä¸Šï¼‰ï¼šçº¿ç¨‹å®‰å…¨çš„å¦ç±»å®ç°æ€è·¯","id":720522},"right":{"article_title":"28ï½œçº¿ç¨‹æ± ï¼šä¸åŒåœºæ™¯ä¸‹å¦‚ä½•åˆç†åœ°é€‰æ‹©çº¿ç¨‹æ± ï¼Ÿ","id":721497}},"comments":[{"had_liked":false,"id":383259,"user_name":"æµ©ä»”æ˜¯ç¨‹åºå‘˜","can_delete":false,"product_type":"c1","uid":1104601,"ip_address":"å¹¿ä¸œ","ucode":"A7E5CF9E1571A2","user_header":"https://static001.geekbang.org/account/avatar/00/10/da/d9/f051962f.jpg","comment_is_top":false,"comment_ctime":1698767484,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":2,"product_id":100613601,"comment_content":"é‚£å…¶å®threadlocalä¹Ÿæ²¡æœ‰è§£å†³å†…å­˜æ³„éœ²çš„é—®é¢˜ï¼Œé‚£keyè®¾ç½®æˆå¼±å¼•ç”¨å¥½åƒä¹Ÿæ²¡æœ‰å¤ªå¤§çš„ä½œç”¨ï¼Ÿè¯·é—®è€å¸ˆï¼Œè¿™ä¹ˆè®¾è®¡å¯ä»¥è§£å†³ä»€ä¹ˆé—®é¢˜å‘¢","like_count":0,"discussions":[{"author":{"id":3801077,"avatar":"","nickname":"kuaishou88880041","note":"","ucode":"69147FF1307EF8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":637481,"discussion_content":"å¦‚æœkeyæ˜¯å¼ºå¼•ç”¨ï¼Œå› ä¸ºthreadlocalæ˜¯é™æ€å˜é‡ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯gcrootï¼Œé‚£ä¹ˆå³ä½¿çº¿ç¨‹é”€æ¯äº†ï¼Œè¿™ä¸ªå˜é‡ä»ç„¶æŒ‡å‘entryï¼Œä½¿å¾—entryä¸èƒ½è¢«å›æ”¶ï¼Œä»è€Œé€ æˆå†…å­˜æ³„éœ²","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1708534907,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":383207,"user_name":"peter","can_delete":false,"product_type":"c1","uid":1058183,"ip_address":"åŒ—äº¬","ucode":"261C3FC001DE2D","user_header":"https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg","comment_is_top":false,"comment_ctime":1698673578,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100613601,"comment_content":"è¯·æ•™è€å¸ˆä¸¤ä¸ªé—®é¢˜ï¼š\nQ1ï¼šThreadLocalæ˜¯ç”¨äºçº¿ç¨‹ä¸åŒæ–¹æ³•ä¹‹é—´ä¿¡æ¯ä¼ é€’å—ï¼Ÿæˆ‘æ„Ÿè§‰è¿™ä¸ªè¯´æ³•æœ‰é—®é¢˜å•Šã€‚\nQ2ï¼šThreadLocalç”¨äºçˆ¶å­çº¿ç¨‹æ•°æ®ä¼ é€’ï¼Œåªæ˜¯åˆ›å»ºçš„æ—¶å€™ä¼ é€’ä¸€æ¬¡å—ï¼Ÿåˆ›å»ºå®Œæ¯•ä»¥åè¿˜æœ‰æ•°æ®ä¼ é€’å—ï¼Ÿ","like_count":0}]}