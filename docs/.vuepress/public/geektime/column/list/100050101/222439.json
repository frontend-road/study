{"id":222439,"title":"01 | æ—¥å¿—æ®µï¼šä¿å­˜æ¶ˆæ¯æ–‡ä»¶çš„å¯¹è±¡æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯èƒ¡å¤•ã€‚</p><p>ä»Šå¤©ï¼Œæˆ‘ä»¬å¼€å§‹å­¦ä¹ Kafkaæºä»£ç åˆ†æçš„ç¬¬ä¸€æ¨¡å—ï¼šæ—¥å¿—ï¼ˆLogï¼‰ã€æ—¥å¿—æ®µï¼ˆLogSegmentï¼‰ä»¥åŠç´¢å¼•ï¼ˆIndexï¼‰æºç ã€‚</p><p>æ—¥å¿—æ®µåŠå…¶ç›¸å…³ä»£ç æ˜¯KafkaæœåŠ¡å™¨æºç ä¸­æœ€ä¸ºé‡è¦çš„ç»„ä»¶ä»£ç ä¹‹ä¸€ã€‚ä½ å¯èƒ½ä¼šéå¸¸å…³å¿ƒï¼Œåœ¨Kafkaä¸­ï¼Œæ¶ˆæ¯æ˜¯å¦‚ä½•è¢«ä¿å­˜å’Œç»„ç»‡åœ¨ä¸€èµ·çš„ã€‚æ¯•ç«Ÿï¼Œ<strong>ä¸ç®¡æ˜¯å­¦ä¹ ä»»ä½•æ¶ˆæ¯å¼•æ“ï¼Œå¼„æ˜ç™½æ¶ˆæ¯å»ºæ¨¡æ–¹å¼éƒ½æ˜¯é¦–è¦çš„é—®é¢˜</strong>ã€‚å› æ­¤ï¼Œä½ éå¸¸æœ‰å¿…è¦å­¦ä¹ æ—¥å¿—æ®µè¿™ä¸ªé‡è¦çš„å­æ¨¡å—çš„æºç å®ç°ã€‚</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œäº†è§£æ—¥å¿—æ®µä¹Ÿæœ‰å¾ˆå¤šå®é™…æ„ä¹‰ï¼Œæ¯”å¦‚è¯´ï¼Œä½ ä¸€å®šå¯¹Kafkaåº•å±‚æ—¥å¿—æ–‡ä»¶00000000000000012345.logçš„å‘½åæ„Ÿåˆ°å¾ˆå¥½å¥‡ã€‚å­¦è¿‡æ—¥å¿—æ®µä¹‹åï¼Œæˆ‘ç›¸ä¿¡è¿™ä¸ªé—®é¢˜ä¸€å®šä¼šè¿åˆƒè€Œè§£çš„ã€‚</p><p>ä»Šå¤©ï¼Œæˆ‘ä¼šå¸¦ä½ è¯¦ç»†çœ‹ä¸‹æ—¥å¿—æ®µéƒ¨åˆ†çš„æºç ã€‚ä¸è¿‡åœ¨æ­¤ä¹‹å‰ï¼Œä½ éœ€è¦å…ˆäº†è§£ä¸€ä¸‹Kafkaçš„æ—¥å¿—ç»“æ„ã€‚</p><h2>Kafkaæ—¥å¿—ç»“æ„æ¦‚è§ˆ</h2><p>Kafkaæ—¥å¿—åœ¨ç£ç›˜ä¸Šçš„ç»„ç»‡æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/72/4b/72fb27cb49e41a61524322ab6bd1cb4b.jpg?wh=4000*2250\" alt=\"\"></p><p>æ—¥å¿—æ˜¯KafkaæœåŠ¡å™¨ç«¯ä»£ç çš„é‡è¦ç»„ä»¶ä¹‹ä¸€ï¼Œå¾ˆå¤šå…¶ä»–çš„æ ¸å¿ƒç»„ä»¶éƒ½æ˜¯ä»¥æ—¥å¿—ä¸ºåŸºç¡€çš„ï¼Œæ¯”å¦‚åé¢è¦è®²åˆ°çš„çŠ¶æ€ç®¡ç†æœºå’Œå‰¯æœ¬ç®¡ç†å™¨ç­‰ã€‚</p><p>æ€»çš„æ¥è¯´ï¼ŒKafkaæ—¥å¿—å¯¹è±¡ç”±å¤šä¸ªæ—¥å¿—æ®µå¯¹è±¡ç»„æˆï¼Œè€Œæ¯ä¸ªæ—¥å¿—æ®µå¯¹è±¡ä¼šåœ¨ç£ç›˜ä¸Šåˆ›å»ºä¸€ç»„æ–‡ä»¶ï¼ŒåŒ…æ‹¬æ¶ˆæ¯æ—¥å¿—æ–‡ä»¶ï¼ˆ.logï¼‰ã€ä½ç§»ç´¢å¼•æ–‡ä»¶ï¼ˆ.indexï¼‰ã€æ—¶é—´æˆ³ç´¢å¼•æ–‡ä»¶ï¼ˆ.timeindexï¼‰ä»¥åŠå·²ä¸­æ­¢ï¼ˆAbortedï¼‰äº‹åŠ¡çš„ç´¢å¼•æ–‡ä»¶ï¼ˆ.txnindexï¼‰ã€‚å½“ç„¶ï¼Œå¦‚æœä½ æ²¡æœ‰ä½¿ç”¨Kafkaäº‹åŠ¡ï¼Œå·²ä¸­æ­¢äº‹åŠ¡çš„ç´¢å¼•æ–‡ä»¶æ˜¯ä¸ä¼šè¢«åˆ›å»ºå‡ºæ¥çš„ã€‚å›¾ä¸­çš„ä¸€ä¸²æ•°å­—0æ˜¯è¯¥æ—¥å¿—æ®µçš„èµ·å§‹ä½ç§»å€¼ï¼ˆBase Offsetï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯¥æ—¥å¿—æ®µä¸­æ‰€å­˜çš„ç¬¬ä¸€æ¡æ¶ˆæ¯çš„ä½ç§»å€¼ã€‚</p><!-- [[[read_end]]] --><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸€ä¸ªKafkaä¸»é¢˜æœ‰å¾ˆå¤šåˆ†åŒºï¼Œæ¯ä¸ªåˆ†åŒºå°±å¯¹åº”ä¸€ä¸ªLogå¯¹è±¡ï¼Œåœ¨ç‰©ç†ç£ç›˜ä¸Šåˆ™å¯¹åº”äºä¸€ä¸ªå­ç›®å½•ã€‚æ¯”å¦‚ä½ åˆ›å»ºäº†ä¸€ä¸ªåŒåˆ†åŒºçš„ä¸»é¢˜test-topicï¼Œé‚£ä¹ˆï¼ŒKafkaåœ¨ç£ç›˜ä¸Šä¼šåˆ›å»ºä¸¤ä¸ªå­ç›®å½•ï¼štest-topic-0å’Œtest-topic-1ã€‚è€Œåœ¨æœåŠ¡å™¨ç«¯ï¼Œè¿™å°±æ˜¯ä¸¤ä¸ªLogå¯¹è±¡ã€‚æ¯ä¸ªå­ç›®å½•ä¸‹å­˜åœ¨å¤šç»„æ—¥å¿—æ®µï¼Œä¹Ÿå°±æ˜¯å¤šç»„.logã€.indexã€.timeindexæ–‡ä»¶ç»„åˆï¼Œåªä¸è¿‡æ–‡ä»¶åä¸åŒï¼Œå› ä¸ºæ¯ä¸ªæ—¥å¿—æ®µçš„èµ·å§‹ä½ç§»ä¸åŒã€‚</p><h2>æ—¥å¿—æ®µä»£ç è§£æ</h2><p>é˜…è¯»æ—¥å¿—æ®µæºç æ˜¯å¾ˆæœ‰å¿…è¦çš„ï¼Œå› ä¸ºæ—¥å¿—æ®µæ˜¯Kafkaä¿å­˜æ¶ˆæ¯çš„æœ€å°è½½ä½“ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¶ˆæ¯æ˜¯ä¿å­˜åœ¨æ—¥å¿—æ®µä¸­çš„ã€‚ç„¶è€Œï¼Œå®˜ç½‘å¯¹äºæ—¥å¿—æ®µçš„æè¿°å°‘å¾—å¯æ€œï¼Œä»¥è‡³äºå¾ˆå¤šäººå¯¹äºè¿™ä¹ˆé‡è¦çš„æ¦‚å¿µéƒ½çŸ¥ä¹‹ç”šå°‘ã€‚</p><p>ä½†æ˜¯ï¼Œä¸ç†Ÿæ‚‰æ—¥å¿—æ®µçš„è¯ï¼Œå¦‚æœåœ¨ç”Ÿäº§ç¯å¢ƒå‡ºç°ç›¸åº”çš„é—®é¢˜ï¼Œæˆ‘ä»¬æ˜¯æ²¡æœ‰åŠæ³•å¿«é€Ÿæ‰¾åˆ°è§£å†³æ–¹æ¡ˆçš„ã€‚æˆ‘è·Ÿä½ åˆ†äº«ä¸€ä¸ªçœŸå®æ¡ˆä¾‹ã€‚</p><p>æˆ‘ä»¬å…¬å¸ä¹‹å‰ç¢°åˆ°è¿‡ä¸€ä¸ªé—®é¢˜ï¼Œå½“æ—¶ï¼Œå¤§é¢ç§¯æ—¥å¿—æ®µåŒæ—¶é—´åˆ‡åˆ†ï¼Œå¯¼è‡´ç¬æ—¶æ‰“æ»¡ç£ç›˜I/Oå¸¦å®½ã€‚å¯¹æ­¤ï¼Œæ‰€æœ‰äººéƒ½æŸæ‰‹æ— ç­–ï¼Œæœ€ç»ˆåªèƒ½æ±‚åŠ©äºæ—¥å¿—æ®µæºç ã€‚</p><p>æœ€åï¼Œæˆ‘ä»¬åœ¨LogSegmentçš„shouldRollæ–¹æ³•ä¸­æ‰¾åˆ°äº†è§£å†³æ–¹æ¡ˆï¼šè®¾ç½®Brokerç«¯å‚æ•°log.roll.jitter.mså€¼å¤§äº0ï¼Œå³é€šè¿‡ç»™æ—¥å¿—æ®µåˆ‡åˆ†æ‰§è¡Œæ—¶é—´åŠ ä¸€ä¸ªæ‰°åŠ¨å€¼çš„æ–¹å¼ï¼Œæ¥é¿å…å¤§é‡æ—¥å¿—æ®µåœ¨åŒä¸€æ—¶åˆ»æ‰§è¡Œåˆ‡åˆ†åŠ¨ä½œï¼Œä»è€Œæ˜¾è‘—é™ä½ç£ç›˜I/Oã€‚</p><p>åæ¥åœ¨å¤ç›˜çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸€è‡´è®¤ä¸ºï¼Œé˜…è¯»LogSegmentæºç æ˜¯éå¸¸æ­£ç¡®çš„å†³å®šã€‚å¦åˆ™ï¼Œå•çº¯æŸ¥çœ‹å®˜ç½‘å¯¹è¯¥å‚æ•°çš„è¯´æ˜ï¼Œæˆ‘ä»¬ä¸ä¸€å®šèƒ½å¤Ÿäº†è§£å®ƒçš„çœŸå®ä½œç”¨ã€‚é‚£ï¼Œlog.roll.jitter.mså‚æ•°çš„å…·ä½“ä½œç”¨æ˜¯å•¥å‘¢ï¼Ÿä¸‹é¢å’±ä»¬è¯´æ—¥å¿—æ®µçš„æ—¶å€™ï¼Œæˆ‘ä¼šç»™ä½ è¯¦ç»†è§£é‡Šä¸‹ã€‚</p><p>é‚£è¯ä¸å¤šè¯´ï¼Œç°åœ¨æˆ‘ä»¬å°±æ¥çœ‹ä¸€ä¸‹æ—¥å¿—æ®µæºç ã€‚æˆ‘ä¼šé‡ç‚¹ç»™ä½ è®²ä¸€ä¸‹æ—¥å¿—æ®µç±»å£°æ˜ã€appendæ–¹æ³•ã€readæ–¹æ³•å’Œrecoveræ–¹æ³•ã€‚</p><p>ä½ é¦–å…ˆè¦çŸ¥é“çš„æ˜¯ï¼Œæ—¥å¿—æ®µæºç ä½äº Kafka çš„ core å·¥ç¨‹ä¸‹ï¼Œå…·ä½“æ–‡ä»¶ä½ç½®æ˜¯ core/src/main/scala/kafka/log/LogSegment.scalaã€‚å®é™…ä¸Šï¼Œæ‰€æœ‰æ—¥å¿—ç»“æ„éƒ¨åˆ†çš„æºç éƒ½åœ¨ core çš„ kafka.log åŒ…ä¸‹ã€‚</p><p>è¯¥æ–‡ä»¶ä¸‹å®šä¹‰äº†ä¸‰ä¸ª Scala å¯¹è±¡ï¼š</p><ul>\n<li>LogSegment classï¼›</li>\n<li>LogSegment objectï¼›</li>\n<li>LogFlushStats objectã€‚LogFlushStats ç»“å°¾æœ‰ä¸ª Statsï¼Œå®ƒæ˜¯åšç»Ÿè®¡ç”¨çš„ï¼Œä¸»è¦è´Ÿè´£ä¸ºæ—¥å¿—è½ç›˜è¿›è¡Œè®¡æ—¶ã€‚</li>\n</ul><p>æˆ‘ä»¬ä¸»è¦å…³å¿ƒçš„æ˜¯ <strong>LogSegment class å’Œ object</strong>ã€‚åœ¨ Scala è¯­è¨€é‡Œï¼Œåœ¨ä¸€ä¸ªæºä»£ç æ–‡ä»¶ä¸­åŒæ—¶å®šä¹‰ç›¸åŒåå­—çš„ class å’Œ object çš„ç”¨æ³•è¢«ç§°ä¸ºä¼´ç”Ÿï¼ˆCompanionï¼‰ã€‚Class å¯¹è±¡è¢«ç§°ä¸ºä¼´ç”Ÿç±»ï¼Œå®ƒå’Œ Java ä¸­çš„ç±»æ˜¯ä¸€æ ·çš„ï¼›è€Œ Object å¯¹è±¡æ˜¯ä¸€ä¸ªå•ä¾‹å¯¹è±¡ï¼Œç”¨äºä¿å­˜ä¸€äº›é™æ€å˜é‡æˆ–é™æ€æ–¹æ³•ã€‚å¦‚æœç”¨ Java æ¥åšç±»æ¯”çš„è¯ï¼Œæˆ‘ä»¬å¿…é¡»è¦ç¼–å†™ä¸¤ä¸ªç±»æ‰èƒ½å®ç°ï¼Œè¿™ä¸¤ä¸ªç±»ä¹Ÿå°±æ˜¯LogSegment å’Œ LogSegmentUtilsã€‚åœ¨ Scala ä¸­ï¼Œä½ ç›´æ¥ä½¿ç”¨ä¼´ç”Ÿå°±å¯ä»¥äº†ã€‚</p><p>å¯¹äº†ï¼Œå€¼å¾—ä¸€æçš„æ˜¯ï¼ŒKafka ä¸­çš„æºç æ³¨é‡Šå†™å¾—éå¸¸è¯¦ç»†ã€‚æˆ‘ä¸æ‰“ç®—æŠŠæ³¨é‡Šä¹Ÿè´´å‡ºæ¥ï¼Œä½†æˆ‘ç‰¹åˆ«æ¨èä½ è¦è¯»ä¸€è¯»æºç ä¸­çš„æ³¨é‡Šã€‚æ¯”å¦‚ï¼Œä»Šå¤©æˆ‘ä»¬è¦å­¦ä¹ çš„æ—¥å¿—æ®µæ–‡ä»¶å¼€å¤´çš„ä¸€å¤§æ®µæ³¨é‡Šå†™å¾—å°±éå¸¸ç²¾å½©ã€‚æˆ‘æˆªä¸€ä¸ªç‰‡æ®µè®©ä½ æ„Ÿå—ä¸‹ï¼š</p><p><span class=\"orange\">A segment of the log. Each segment has two components: a log and an index. The log is a FileRecords containing the actual messages. The index is an OffsetIndex that maps from logical offsets to physical file positions. Each segment has a base offset which is an offset &lt;= the least offset of any message in this segment and &gt; any offset in any previous segment.</span></p><p>è¿™æ®µæ–‡å­—æ¸…æ¥šåœ°è¯´æ˜äº†æ¯ä¸ªæ—¥å¿—æ®µç”±ä¸¤ä¸ªæ ¸å¿ƒç»„ä»¶æ„æˆï¼šæ—¥å¿—å’Œç´¢å¼•ã€‚å½“ç„¶ï¼Œè¿™é‡Œçš„ç´¢å¼•æ³›æŒ‡å¹¿ä¹‰çš„ç´¢å¼•æ–‡ä»¶ã€‚å¦å¤–ï¼Œè¿™æ®µæ³¨é‡Šè¿˜ç»™å‡ºäº†ä¸€ä¸ªé‡è¦çš„äº‹å®ï¼šæ¯ä¸ªæ—¥å¿—æ®µéƒ½æœ‰ä¸€ä¸ªèµ·å§‹ä½ç§»å€¼ï¼ˆBase Offsetï¼‰ï¼Œè€Œè¯¥ä½ç§»å€¼æ˜¯æ­¤æ—¥å¿—æ®µæ‰€æœ‰æ¶ˆæ¯ä¸­æœ€å°çš„ä½ç§»å€¼ï¼ŒåŒæ—¶ï¼Œè¯¥å€¼å´åˆæ¯”å‰é¢ä»»ä½•æ—¥å¿—æ®µä¸­æ¶ˆæ¯çš„ä½ç§»å€¼éƒ½å¤§ã€‚çœ‹å®Œè¿™ä¸ªæ³¨é‡Šï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿå¿«é€Ÿåœ°äº†è§£èµ·å§‹ä½ç§»å€¼åœ¨æ—¥å¿—æ®µä¸­çš„ä½œç”¨äº†ã€‚</p><h3>æ—¥å¿—æ®µç±»å£°æ˜</h3><p>ä¸‹é¢ï¼Œæˆ‘åˆ†æ‰¹æ¬¡ç»™å‡ºæ¯”è¾ƒå…³é”®çš„ä»£ç ç‰‡æ®µï¼Œå¹¶å¯¹å…¶è¿›è¡Œè§£é‡Šã€‚é¦–å…ˆï¼Œæˆ‘ä»¬çœ‹ä¸‹ LogSegment çš„å®šä¹‰ï¼š</p><pre><code>class LogSegment private[log] (val log: FileRecords,\n                               val lazyOffsetIndex: LazyIndex[OffsetIndex],\n                               val lazyTimeIndex: LazyIndex[TimeIndex],\n                               val txnIndex: TransactionIndex,\n                               val baseOffset: Long,\n                               val indexIntervalBytes: Int,\n                               val rollJitterMs: Long,\n\tval time: Time) extends Logging { â€¦ }\n</code></pre><p>å°±åƒæˆ‘å‰é¢è¯´çš„ï¼Œä¸€ä¸ªæ—¥å¿—æ®µåŒ…å«<strong>æ¶ˆæ¯æ—¥å¿—æ–‡ä»¶</strong>ã€<strong>ä½ç§»ç´¢å¼•æ–‡ä»¶</strong>ã€<strong>æ—¶é—´æˆ³ç´¢å¼•æ–‡ä»¶</strong>ã€<strong>å·²ä¸­æ­¢äº‹åŠ¡ç´¢å¼•æ–‡ä»¶</strong>ç­‰ã€‚è¿™é‡Œçš„ FileRecords å°±æ˜¯å®é™…ä¿å­˜ Kafka æ¶ˆæ¯çš„å¯¹è±¡ã€‚ä¸“æ åé¢æˆ‘å°†ä¸“é—¨è®¨è®º Kafka æ˜¯å¦‚ä½•ä¿å­˜å…·ä½“æ¶ˆæ¯çš„ï¼Œä¹Ÿå°±æ˜¯ FileRecords åŠå…¶å®¶æ—çš„å®ç°æ–¹å¼ã€‚åŒæ—¶ï¼Œæˆ‘è¿˜ä¼šç»™ä½ ä»‹ç»ä¸€ä¸‹ç¤¾åŒºåœ¨æŒä¹…åŒ–æ¶ˆæ¯è¿™å—æ˜¯æ€ä¹ˆæ¼”è¿›çš„ï¼Œä½ ä¸€å®šä¸è¦é”™è¿‡é‚£éƒ¨åˆ†çš„å†…å®¹ã€‚</p><p>ä¸‹é¢çš„ lazyOffsetIndexã€lazyTimeIndex å’Œ txnIndex åˆ†åˆ«å¯¹åº”äºåˆšæ‰æ‰€è¯´çš„ 3 ä¸ªç´¢å¼•æ–‡ä»¶ã€‚ä¸è¿‡ï¼Œåœ¨å®ç°æ–¹å¼ä¸Šï¼Œå‰ä¸¤ç§ä½¿ç”¨äº†å»¶è¿Ÿåˆå§‹åŒ–çš„åŸç†ï¼Œé™ä½äº†åˆå§‹åŒ–æ—¶é—´æˆæœ¬ã€‚åé¢æˆ‘ä»¬åœ¨è°ˆåˆ°ç´¢å¼•çš„æ—¶å€™å†è¯¦ç»†è¯´ã€‚</p><p>æ¯ä¸ªæ—¥å¿—æ®µå¯¹è±¡ä¿å­˜è‡ªå·±çš„èµ·å§‹ä½ç§» <strong>baseOffset</strong>â€”â€”è¿™æ˜¯éå¸¸é‡è¦çš„å±æ€§ï¼äº‹å®ä¸Šï¼Œä½ åœ¨ç£ç›˜ä¸Šçœ‹åˆ°çš„æ–‡ä»¶åå°±æ˜¯baseOffsetçš„å€¼ã€‚æ¯ä¸ªLogSegmentå¯¹è±¡å®ä¾‹ä¸€æ—¦è¢«åˆ›å»ºï¼Œå®ƒçš„èµ·å§‹ä½ç§»å°±æ˜¯å›ºå®šçš„äº†ï¼Œä¸èƒ½å†è¢«æ›´æ”¹ã€‚</p><p>indexIntervalBytes å€¼å…¶å®å°±æ˜¯ Broker ç«¯å‚æ•° log.index.interval.bytes å€¼ï¼Œå®ƒæ§åˆ¶äº†<strong>æ—¥å¿—æ®µå¯¹è±¡æ–°å¢ç´¢å¼•é¡¹çš„é¢‘ç‡</strong>ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ—¥å¿—æ®µè‡³å°‘æ–°å†™å…¥ 4KB çš„æ¶ˆæ¯æ•°æ®æ‰ä¼šæ–°å¢ä¸€æ¡ç´¢å¼•é¡¹ã€‚è€Œ rollJitterMs æ˜¯æ—¥å¿—æ®µå¯¹è±¡æ–°å¢å€’è®¡æ—¶çš„â€œæ‰°åŠ¨å€¼â€ã€‚å› ä¸ºç›®å‰ Broker ç«¯æ—¥å¿—æ®µæ–°å¢å€’è®¡æ—¶æ˜¯å…¨å±€è®¾ç½®ï¼Œè¿™å°±æ˜¯è¯´ï¼Œåœ¨æœªæ¥çš„æŸä¸ªæ—¶åˆ»å¯èƒ½åŒæ—¶åˆ›å»ºå¤šä¸ªæ—¥å¿—æ®µå¯¹è±¡ï¼Œè¿™å°†æå¤§åœ°å¢åŠ ç‰©ç†ç£ç›˜ I/O å‹åŠ›ã€‚æœ‰äº† rollJitterMs å€¼çš„å¹²æ‰°ï¼Œæ¯ä¸ªæ–°å¢æ—¥å¿—æ®µåœ¨åˆ›å»ºæ—¶ä¼šå½¼æ­¤å²”å¼€ä¸€å°æ®µæ—¶é—´ï¼Œè¿™æ ·å¯ä»¥ç¼“è§£ç‰©ç†ç£ç›˜çš„ I/O è´Ÿè½½ç“¶é¢ˆã€‚</p><p>è‡³äºæœ€åçš„ time å‚æ•°ï¼Œå®ƒå°±æ˜¯ç”¨äºç»Ÿè®¡è®¡æ—¶çš„ä¸€ä¸ªå®ç°ç±»ï¼Œåœ¨ Kafka æºç ä¸­æ™®éå‡ºç°ï¼Œæˆ‘å°±ä¸è¯¦ç»†å±•å¼€è®²äº†ã€‚</p><p>ä¸‹é¢æˆ‘æ¥è¯´ä¸€äº›é‡è¦çš„æ–¹æ³•ã€‚</p><p>å¯¹äºä¸€ä¸ªæ—¥å¿—æ®µè€Œè¨€ï¼Œæœ€é‡è¦çš„æ–¹æ³•å°±æ˜¯å†™å…¥æ¶ˆæ¯å’Œè¯»å–æ¶ˆæ¯äº†ï¼Œå®ƒä»¬åˆ†åˆ«å¯¹åº”ç€æºç ä¸­çš„ append æ–¹æ³•å’Œ read æ–¹æ³•ã€‚å¦å¤–ï¼Œrecoveræ–¹æ³•åŒæ ·å¾ˆå…³é”®ï¼Œå®ƒæ˜¯Brokeré‡å¯åæ¢å¤æ—¥å¿—æ®µçš„æ“ä½œé€»è¾‘ã€‚</p><h3>appendæ–¹æ³•</h3><p>æˆ‘ä»¬å…ˆæ¥çœ‹append æ–¹æ³•ï¼Œäº†è§£ä¸‹å†™å…¥æ¶ˆæ¯çš„å…·ä½“æ“ä½œã€‚</p><pre><code>def append(largestOffset: Long,\n             largestTimestamp: Long,\n             shallowOffsetOfMaxTimestamp: Long,\n             records: MemoryRecords): Unit = {\n    if (records.sizeInBytes &gt; 0) {\n      trace(s&quot;Inserting ${records.sizeInBytes} bytes at end offset $largestOffset at position ${log.sizeInBytes} &quot; +\n            s&quot;with largest timestamp $largestTimestamp at shallow offset $shallowOffsetOfMaxTimestamp&quot;)\n      val physicalPosition = log.sizeInBytes()\n      if (physicalPosition == 0)\n        rollingBasedTimestamp = Some(largestTimestamp)\n\n      ensureOffsetInRange(largestOffset)\n\n      // append the messages\n      val appendedBytes = log.append(records)\n      trace(s&quot;Appended $appendedBytes to ${log.file} at end offset $largestOffset&quot;)\n      // Update the in memory max timestamp and corresponding offset.\n      if (largestTimestamp &gt; maxTimestampSoFar) {\n        maxTimestampSoFar = largestTimestamp\n        offsetOfMaxTimestampSoFar = shallowOffsetOfMaxTimestamp\n      }\n      // append an entry to the index (if needed)\n      if (bytesSinceLastIndexEntry &gt; indexIntervalBytes) {\n        offsetIndex.append(largestOffset, physicalPosition)\n        timeIndex.maybeAppend(maxTimestampSoFar, offsetOfMaxTimestampSoFar)\n        bytesSinceLastIndexEntry = 0\n      }\n      bytesSinceLastIndexEntry += records.sizeInBytes\n    }\n  }\n</code></pre><p>append æ–¹æ³•æ¥æ”¶ 4 ä¸ªå‚æ•°ï¼Œåˆ†åˆ«è¡¨ç¤ºå¾…å†™å…¥æ¶ˆæ¯æ‰¹æ¬¡ä¸­æ¶ˆæ¯çš„<strong>æœ€å¤§ä½ç§»å€¼</strong>ã€<strong>æœ€å¤§æ—¶é—´æˆ³</strong>ã€<strong>æœ€å¤§æ—¶é—´æˆ³å¯¹åº”æ¶ˆæ¯çš„ä½ç§»</strong>ä»¥åŠ<strong>çœŸæ­£è¦å†™å…¥çš„æ¶ˆæ¯é›†åˆ</strong>ã€‚ä¸‹é¢è¿™å¼ å›¾å±•ç¤ºäº† append æ–¹æ³•çš„å®Œæ•´æ‰§è¡Œæµç¨‹ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/67/5c/6700570d3052fcadda54767ed8dc385c.jpg?wh=3515*2250\" alt=\"\"></p><p><strong>ç¬¬ä¸€æ­¥ï¼š</strong></p><p>åœ¨æºç ä¸­ï¼Œé¦–å…ˆè°ƒç”¨ log.sizeInBytes æ–¹æ³•åˆ¤æ–­è¯¥æ—¥å¿—æ®µæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœæ˜¯ç©ºçš„è¯ï¼Œ Kafka éœ€è¦è®°å½•è¦å†™å…¥æ¶ˆæ¯é›†åˆçš„æœ€å¤§æ—¶é—´æˆ³ï¼Œå¹¶å°†å…¶ä½œä¸ºåé¢æ–°å¢æ—¥å¿—æ®µå€’è®¡æ—¶çš„ä¾æ®ã€‚</p><p><strong>ç¬¬äºŒæ­¥ï¼š</strong></p><p>ä»£ç è°ƒç”¨ ensureOffsetInRange æ–¹æ³•ç¡®ä¿è¾“å…¥å‚æ•°æœ€å¤§ä½ç§»å€¼æ˜¯åˆæ³•çš„ã€‚é‚£æ€ä¹ˆåˆ¤æ–­æ˜¯ä¸æ˜¯åˆæ³•å‘¢ï¼Ÿæ ‡å‡†å°±æ˜¯çœ‹å®ƒä¸æ—¥å¿—æ®µèµ·å§‹ä½ç§»çš„å·®å€¼æ˜¯å¦åœ¨æ•´æ•°èŒƒå›´å†…ï¼Œå³ largestOffset - baseOffsetçš„å€¼æ˜¯ä¸æ˜¯ä»‹äº [0ï¼ŒInt.MAXVALUE] ä¹‹é—´ã€‚åœ¨æä¸ªåˆ«çš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªå·®å€¼å¯èƒ½ä¼šè¶Šç•Œï¼Œè¿™æ—¶ï¼Œappend æ–¹æ³•å°±ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œé˜»æ­¢åç»­çš„æ¶ˆæ¯å†™å…¥ã€‚ä¸€æ—¦ä½ ç¢°åˆ°è¿™ä¸ªé—®é¢˜ï¼Œä½ éœ€è¦åšçš„æ˜¯å‡çº§ä½ çš„ Kafka ç‰ˆæœ¬ï¼Œå› ä¸ºè¿™æ˜¯ç”±å·²çŸ¥çš„ Bug å¯¼è‡´çš„ã€‚</p><p><strong>ç¬¬ä¸‰æ­¥ï¼š</strong></p><p>å¾…è¿™äº›åšå®Œä¹‹åï¼Œappend æ–¹æ³•è°ƒç”¨ FileRecords çš„ append æ–¹æ³•æ‰§è¡ŒçœŸæ­£çš„å†™å…¥ã€‚å‰é¢è¯´è¿‡äº†ï¼Œä¸“æ åé¢æˆ‘ä»¬ä¼šè¯¦ç»†ä»‹ç» FileRecords ç±»ã€‚è¿™é‡Œä½ åªéœ€è¦çŸ¥é“å®ƒçš„å·¥ä½œæ˜¯å°†å†…å­˜ä¸­çš„æ¶ˆæ¯å¯¹è±¡å†™å…¥åˆ°æ“ä½œç³»ç»Ÿçš„é¡µç¼“å­˜å°±å¯ä»¥äº†ã€‚</p><p><strong>ç¬¬å››æ­¥ï¼š</strong></p><p>å†ä¸‹ä¸€æ­¥ï¼Œå°±æ˜¯æ›´æ–°æ—¥å¿—æ®µçš„æœ€å¤§æ—¶é—´æˆ³ä»¥åŠæœ€å¤§æ—¶é—´æˆ³æ‰€å±æ¶ˆæ¯çš„ä½ç§»å€¼å±æ€§ã€‚æ¯ä¸ªæ—¥å¿—æ®µéƒ½è¦ä¿å­˜å½“å‰æœ€å¤§æ—¶é—´æˆ³ä¿¡æ¯å’Œæ‰€å±æ¶ˆæ¯çš„ä½ç§»ä¿¡æ¯ã€‚</p><p>è¿˜è®°å¾— Broker ç«¯æä¾›å®šæœŸåˆ é™¤æ—¥å¿—çš„åŠŸèƒ½å—ï¼Ÿæ¯”å¦‚æˆ‘åªæƒ³ä¿ç•™æœ€è¿‘ 7 å¤©çš„æ—¥å¿—ï¼Œæ²¡é”™ï¼Œå½“å‰æœ€å¤§æ—¶é—´æˆ³è¿™ä¸ªå€¼å°±æ˜¯åˆ¤æ–­çš„ä¾æ®ï¼›è€Œæœ€å¤§æ—¶é—´æˆ³å¯¹åº”çš„æ¶ˆæ¯çš„ä½ç§»å€¼åˆ™ç”¨äºæ—¶é—´æˆ³ç´¢å¼•é¡¹ã€‚è™½ç„¶åé¢æˆ‘ä¼šè¯¦ç»†ä»‹ç»ï¼Œè¿™é‡Œæˆ‘è¿˜æ˜¯ç¨å¾®æä¸€ä¸‹ï¼š<strong>æ—¶é—´æˆ³ç´¢å¼•é¡¹ä¿å­˜æ—¶é—´æˆ³ä¸æ¶ˆæ¯ä½ç§»çš„å¯¹åº”å…³ç³»</strong>ã€‚åœ¨è¿™æ­¥æ“ä½œä¸­ï¼ŒKafkaä¼šæ›´æ–°å¹¶ä¿å­˜è¿™ç»„å¯¹åº”å…³ç³»ã€‚</p><p><strong>ç¬¬äº”æ­¥ï¼š</strong></p><p>append æ–¹æ³•çš„æœ€åä¸€æ­¥å°±æ˜¯æ›´æ–°ç´¢å¼•é¡¹å’Œå†™å…¥çš„å­—èŠ‚æ•°äº†ã€‚æˆ‘åœ¨å‰é¢è¯´è¿‡ï¼Œæ—¥å¿—æ®µæ¯å†™å…¥ 4KB æ•°æ®å°±è¦å†™å…¥ä¸€ä¸ªç´¢å¼•é¡¹ã€‚å½“å·²å†™å…¥å­—èŠ‚æ•°è¶…è¿‡äº† 4KB ä¹‹åï¼Œappend æ–¹æ³•ä¼šè°ƒç”¨ç´¢å¼•å¯¹è±¡çš„ append æ–¹æ³•æ–°å¢ç´¢å¼•é¡¹ï¼ŒåŒæ—¶æ¸…ç©ºå·²å†™å…¥å­—èŠ‚æ•°ï¼Œä»¥å¤‡ä¸‹æ¬¡é‡æ–°ç´¯ç§¯è®¡ç®—ã€‚</p><h3>read æ–¹æ³•</h3><p>å¥½äº†ï¼Œappend æ–¹æ³•æˆ‘å°±è§£é‡Šå®Œäº†ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹readæ–¹æ³•ï¼Œäº†è§£ä¸‹è¯»å–æ—¥å¿—æ®µçš„å…·ä½“æ“ä½œã€‚</p><pre><code>def read(startOffset: Long,\n           maxSize: Int,\n           maxPosition: Long = size,\n           minOneMessage: Boolean = false): FetchDataInfo = {\n    if (maxSize &lt; 0)\n      throw new IllegalArgumentException(s&quot;Invalid max size $maxSize for log read from segment $log&quot;)\n\n    val startOffsetAndSize = translateOffset(startOffset)\n\n    // if the start position is already off the end of the log, return null\n    if (startOffsetAndSize == null)\n      return null\n\n    val startPosition = startOffsetAndSize.position\n    val offsetMetadata = LogOffsetMetadata(startOffset, this.baseOffset, startPosition)\n\n    val adjustedMaxSize =\n      if (minOneMessage) math.max(maxSize, startOffsetAndSize.size)\n      else maxSize\n\n    // return a log segment but with zero size in the case below\n    if (adjustedMaxSize == 0)\n      return FetchDataInfo(offsetMetadata, MemoryRecords.EMPTY)\n\n    // calculate the length of the message set to read based on whether or not they gave us a maxOffset\n    val fetchSize: Int = min((maxPosition - startPosition).toInt, adjustedMaxSize)\n\n    FetchDataInfo(offsetMetadata, log.slice(startPosition, fetchSize),\n      firstEntryIncomplete = adjustedMaxSize &lt; startOffsetAndSize.size)\n  }\n</code></pre><p>read æ–¹æ³•æ¥æ”¶ 4 ä¸ªè¾“å…¥å‚æ•°ã€‚</p><ul>\n<li>startOffsetï¼šè¦è¯»å–çš„ç¬¬ä¸€æ¡æ¶ˆæ¯çš„ä½ç§»ï¼›</li>\n<li>maxSizeï¼šèƒ½è¯»å–çš„æœ€å¤§å­—èŠ‚æ•°ï¼›</li>\n<li>maxPosition ï¼šèƒ½è¯»åˆ°çš„æœ€å¤§æ–‡ä»¶ä½ç½®ï¼›</li>\n<li>minOneMessageï¼šæ˜¯å¦å…è®¸åœ¨æ¶ˆæ¯ä½“è¿‡å¤§æ—¶è‡³å°‘è¿”å›ç¬¬ä¸€æ¡æ¶ˆæ¯ã€‚</li>\n</ul><p>å‰3ä¸ªå‚æ•°çš„å«ä¹‰å¾ˆå¥½ç†è§£ï¼Œæˆ‘é‡ç‚¹è¯´ä¸‹ç¬¬ 4 ä¸ªã€‚å½“è¿™ä¸ªå‚æ•°ä¸º true æ—¶ï¼Œå³ä½¿å‡ºç°æ¶ˆæ¯ä½“å­—èŠ‚æ•°è¶…è¿‡äº† maxSize çš„æƒ…å½¢ï¼Œread æ–¹æ³•ä¾ç„¶èƒ½è¿”å›è‡³å°‘ä¸€æ¡æ¶ˆæ¯ã€‚å¼•å…¥è¿™ä¸ªå‚æ•°ä¸»è¦æ˜¯ä¸ºäº†ç¡®ä¿ä¸å‡ºç°æ¶ˆè´¹é¥¿æ­»çš„æƒ…å†µã€‚</p><p>ä¸‹å›¾å±•ç¤ºäº† read æ–¹æ³•çš„å®Œæ•´æ‰§è¡Œé€»è¾‘ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/61/45/61c97ee41b52e63e771cf5503e0ee345.jpg?wh=2778*2024\" alt=\"\"></p><p>é€»è¾‘å¾ˆç®€å•ï¼Œæˆ‘ä»¬ä¸€æ­¥æ­¥æ¥çœ‹ä¸‹ã€‚</p><p>ç¬¬ä¸€æ­¥æ˜¯è°ƒç”¨ translateOffset æ–¹æ³•å®šä½è¦è¯»å–çš„èµ·å§‹æ–‡ä»¶ä½ç½® ï¼ˆstartPositionï¼‰ã€‚è¾“å…¥å‚æ•° startOffset ä»…ä»…æ˜¯ä½ç§»å€¼ï¼ŒKafka éœ€è¦æ ¹æ®ç´¢å¼•ä¿¡æ¯æ‰¾åˆ°å¯¹åº”çš„ç‰©ç†æ–‡ä»¶ä½ç½®æ‰èƒ½å¼€å§‹è¯»å–æ¶ˆæ¯ã€‚</p><p>å¾…ç¡®å®šäº†è¯»å–èµ·å§‹ä½ç½®ï¼Œæ—¥å¿—æ®µä»£ç éœ€è¦æ ¹æ®è¿™éƒ¨åˆ†ä¿¡æ¯ä»¥åŠ maxSize å’Œ maxPosition å‚æ•°å…±åŒè®¡ç®—è¦è¯»å–çš„æ€»å­—èŠ‚æ•°ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾ maxSize=100ï¼ŒmaxPosition=300ï¼ŒstartPosition=250ï¼Œé‚£ä¹ˆ read æ–¹æ³•åªèƒ½è¯»å– 50 å­—èŠ‚ï¼Œå› ä¸º maxPosition - startPosition = 50ã€‚æˆ‘ä»¬æŠŠå®ƒå’ŒmaxSizeå‚æ•°ç›¸æ¯”è¾ƒï¼Œå…¶ä¸­çš„æœ€å°å€¼å°±æ˜¯æœ€ç»ˆèƒ½å¤Ÿè¯»å–çš„æ€»å­—èŠ‚æ•°ã€‚</p><p>æœ€åä¸€æ­¥æ˜¯è°ƒç”¨ FileRecords çš„ slice æ–¹æ³•ï¼Œä»æŒ‡å®šä½ç½®è¯»å–æŒ‡å®šå¤§å°çš„æ¶ˆæ¯é›†åˆã€‚</p><h3>recover æ–¹æ³•</h3><p>é™¤äº†append å’Œread æ–¹æ³•ï¼ŒLogSegment è¿˜æœ‰ä¸€ä¸ªé‡è¦çš„æ–¹æ³•éœ€è¦æˆ‘ä»¬å…³æ³¨ï¼Œå®ƒå°±æ˜¯ recoveræ–¹æ³•ï¼Œç”¨äº<strong>æ¢å¤æ—¥å¿—æ®µ</strong>ã€‚</p><p>ä¸‹é¢çš„ä»£ç æ˜¯ recover æ–¹æ³•æºç ã€‚ä»€ä¹ˆæ˜¯æ¢å¤æ—¥å¿—æ®µå‘¢ï¼Ÿå…¶å®å°±æ˜¯è¯´ï¼Œ Broker åœ¨å¯åŠ¨æ—¶ä¼šä»ç£ç›˜ä¸ŠåŠ è½½æ‰€æœ‰æ—¥å¿—æ®µä¿¡æ¯åˆ°å†…å­˜ä¸­ï¼Œå¹¶åˆ›å»ºç›¸åº”çš„ LogSegment å¯¹è±¡å®ä¾‹ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå®ƒéœ€è¦æ‰§è¡Œä¸€ç³»åˆ—çš„æ“ä½œã€‚</p><pre><code>def recover(producerStateManager: ProducerStateManager, leaderEpochCache: Option[LeaderEpochFileCache] = None): Int = {\n    offsetIndex.reset()\n    timeIndex.reset()\n    txnIndex.reset()\n    var validBytes = 0\n    var lastIndexEntry = 0\n    maxTimestampSoFar = RecordBatch.NO_TIMESTAMP\n    try {\n      for (batch &lt;- log.batches.asScala) {\n        batch.ensureValid()\n        ensureOffsetInRange(batch.lastOffset)\n\n        // The max timestamp is exposed at the batch level, so no need to iterate the records\n        if (batch.maxTimestamp &gt; maxTimestampSoFar) {\n          maxTimestampSoFar = batch.maxTimestamp\n          offsetOfMaxTimestampSoFar = batch.lastOffset\n        }\n\n        // Build offset index\n        if (validBytes - lastIndexEntry &gt; indexIntervalBytes) {\n          offsetIndex.append(batch.lastOffset, validBytes)\n          timeIndex.maybeAppend(maxTimestampSoFar, offsetOfMaxTimestampSoFar)\n          lastIndexEntry = validBytes\n        }\n        validBytes += batch.sizeInBytes()\n\n        if (batch.magic &gt;= RecordBatch.MAGIC_VALUE_V2) {\n          leaderEpochCache.foreach { cache =&gt;\n            if (batch.partitionLeaderEpoch &gt; 0 &amp;&amp; cache.latestEpoch.forall(batch.partitionLeaderEpoch &gt; _))\n              cache.assign(batch.partitionLeaderEpoch, batch.baseOffset)\n          }\n          updateProducerState(producerStateManager, batch)\n        }\n      }\n    } catch {\n      case e@ (_: CorruptRecordException | _: InvalidRecordException) =&gt;\n        warn(&quot;Found invalid messages in log segment %s at byte offset %d: %s. %s&quot;\n          .format(log.file.getAbsolutePath, validBytes, e.getMessage, e.getCause))\n    }\n    val truncated = log.sizeInBytes - validBytes\n    if (truncated &gt; 0)\n      debug(s&quot;Truncated $truncated invalid bytes at the end of segment ${log.file.getAbsoluteFile} during recovery&quot;)\n\n    log.truncateTo(validBytes)\n    offsetIndex.trimToValidSize()\n    // A normally closed segment always appends the biggest timestamp ever seen into log segment, we do this as well.\n    timeIndex.maybeAppend(maxTimestampSoFar, offsetOfMaxTimestampSoFar, skipFullCheck = true)\n    timeIndex.trimToValidSize()\n    truncated\n  }\n</code></pre><p>æˆ‘ä¾ç„¶ä½¿ç”¨ä¸€å¼ å›¾æ¥è¯´æ˜ recover çš„å¤„ç†é€»è¾‘ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/eb/6c/eb5bd324685ee393e8a3072fc4b4276c.jpg?wh=3136*2188\" alt=\"\"></p><p>recover å¼€å§‹æ—¶ï¼Œä»£ç ä¾æ¬¡è°ƒç”¨ç´¢å¼•å¯¹è±¡çš„ reset æ–¹æ³•æ¸…ç©ºæ‰€æœ‰çš„ç´¢å¼•æ–‡ä»¶ï¼Œä¹‹åä¼šå¼€å§‹éå†æ—¥å¿—æ®µä¸­çš„æ‰€æœ‰æ¶ˆæ¯é›†åˆæˆ–æ¶ˆæ¯æ‰¹æ¬¡ï¼ˆRecordBatchï¼‰ã€‚å¯¹äºè¯»å–åˆ°çš„æ¯ä¸ªæ¶ˆæ¯é›†åˆï¼Œæ—¥å¿—æ®µå¿…é¡»è¦ç¡®ä¿å®ƒä»¬æ˜¯åˆæ³•çš„ï¼Œè¿™ä¸»è¦ä½“ç°åœ¨ä¸¤ä¸ªæ–¹é¢ï¼š</p><ol>\n<li>è¯¥é›†åˆä¸­çš„æ¶ˆæ¯å¿…é¡»è¦ç¬¦åˆ Kafka å®šä¹‰çš„äºŒè¿›åˆ¶æ ¼å¼ï¼›</li>\n<li>è¯¥é›†åˆä¸­æœ€åä¸€æ¡æ¶ˆæ¯çš„ä½ç§»å€¼ä¸èƒ½è¶Šç•Œï¼Œå³å®ƒä¸æ—¥å¿—æ®µèµ·å§‹ä½ç§»çš„å·®å€¼å¿…é¡»æ˜¯ä¸€ä¸ªæ­£æ•´æ•°å€¼ã€‚</li>\n</ol><p>æ ¡éªŒå®Œæ¶ˆæ¯é›†åˆä¹‹åï¼Œä»£ç ä¼šæ›´æ–°éå†è¿‡ç¨‹ä¸­è§‚æµ‹åˆ°çš„æœ€å¤§æ—¶é—´æˆ³ä»¥åŠæ‰€å±æ¶ˆæ¯çš„ä½ç§»å€¼ã€‚åŒæ ·ï¼Œè¿™ä¸¤ä¸ªæ•°æ®ç”¨äºåç»­æ„å»ºç´¢å¼•é¡¹ã€‚å†ä¹‹åå°±æ˜¯ä¸æ–­ç´¯åŠ å½“å‰å·²è¯»å–çš„æ¶ˆæ¯å­—èŠ‚æ•°ï¼Œå¹¶æ ¹æ®è¯¥å€¼æœ‰æ¡ä»¶åœ°å†™å…¥ç´¢å¼•é¡¹ã€‚æœ€åæ˜¯æ›´æ–°äº‹åŠ¡å‹Producerçš„çŠ¶æ€ä»¥åŠLeader Epochç¼“å­˜ã€‚ä¸è¿‡ï¼Œè¿™ä¸¤ä¸ªå¹¶ä¸æ˜¯ç†è§£Kafkaæ—¥å¿—ç»“æ„æ‰€å¿…éœ€çš„ç»„ä»¶ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å¿½ç•¥å®ƒä»¬ã€‚</p><p>éå†æ‰§è¡Œå®Œæˆåï¼ŒKafka ä¼šå°†æ—¥å¿—æ®µå½“å‰æ€»å­—èŠ‚æ•°å’Œåˆšåˆšç´¯åŠ çš„å·²è¯»å–å­—èŠ‚æ•°è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœå‘ç°å‰è€…æ¯”åè€…å¤§ï¼Œè¯´æ˜æ—¥å¿—æ®µå†™å…¥äº†ä¸€äº›éæ³•æ¶ˆæ¯ï¼Œéœ€è¦æ‰§è¡Œæˆªæ–­æ“ä½œï¼Œå°†æ—¥å¿—æ®µå¤§å°è°ƒæ•´å›åˆæ³•çš„æ•°å€¼ã€‚åŒæ—¶ï¼Œ Kafka è¿˜å¿…é¡»ç›¸åº”åœ°è°ƒæ•´ç´¢å¼•æ–‡ä»¶çš„å¤§å°ã€‚æŠŠè¿™äº›éƒ½åšå®Œä¹‹åï¼Œæ—¥å¿—æ®µæ¢å¤çš„æ“ä½œä¹Ÿå°±å®£å‘Šç»“æŸäº†ã€‚</p><h2>æ€»ç»“</h2><p>ä»Šå¤©ï¼Œæˆ‘ä»¬å¯¹Kafkaæ—¥å¿—æ®µæºç è¿›è¡Œäº†é‡ç‚¹çš„åˆ†æï¼ŒåŒ…æ‹¬æ—¥å¿—æ®µçš„appendæ–¹æ³•ã€readæ–¹æ³•å’Œrecoveræ–¹æ³•ã€‚</p><ol>\n<li>appendæ–¹æ³•ï¼šæˆ‘é‡ç‚¹åˆ†æäº†æºç æ˜¯å¦‚ä½•å†™å…¥æ¶ˆæ¯åˆ°æ—¥å¿—æ®µçš„ã€‚ä½ è¦é‡ç‚¹å…³æ³¨ä¸€ä¸‹å†™æ“ä½œè¿‡ç¨‹ä¸­æ›´æ–°ç´¢å¼•çš„æ—¶æœºæ˜¯å¦‚ä½•è®¾å®šçš„ã€‚</li>\n<li>readæ–¹æ³•ï¼šæˆ‘é‡ç‚¹åˆ†æäº†æºç åº•å±‚è¯»å–æ¶ˆæ¯çš„å®Œæ•´æµç¨‹ã€‚ä½ è¦å…³æ³¨ä¸‹Kafkaè®¡ç®—å¾…è¯»å–æ¶ˆæ¯å­—èŠ‚æ•°çš„é€»è¾‘ï¼Œä¹Ÿå°±æ˜¯maxSizeã€maxPositionå’ŒstartOffsetæ˜¯å¦‚ä½•å…±åŒå½±å“readæ–¹æ³•çš„ã€‚</li>\n<li>recoveræ–¹æ³•ï¼šè¿™ä¸ªæ“ä½œä¼šè¯»å–æ—¥å¿—æ®µæ–‡ä»¶ï¼Œç„¶åé‡å»ºç´¢å¼•æ–‡ä»¶ã€‚å†å¼ºè°ƒä¸€ä¸‹ï¼Œ<strong>è¿™ä¸ªæ“ä½œåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­è¦è¯»å–æ—¥å¿—æ®µæ–‡ä»¶</strong>ã€‚å› æ­¤ï¼Œå¦‚æœä½ çš„ç¯å¢ƒä¸Šæœ‰å¾ˆå¤šæ—¥å¿—æ®µæ–‡ä»¶ï¼Œä½ åˆå‘ç°Brokeré‡å¯å¾ˆæ…¢ï¼Œé‚£ä½ ç°åœ¨å°±çŸ¥é“äº†ï¼Œè¿™æ˜¯å› ä¸ºKafkaåœ¨æ‰§è¡Œrecoverçš„è¿‡ç¨‹ä¸­éœ€è¦è¯»å–å¤§é‡çš„ç£ç›˜æ–‡ä»¶å¯¼è‡´çš„ã€‚ä½ çœ‹ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬è¯»å–æºç çš„æ”¶è·ã€‚</li>\n</ol><p><img src=\"https://static001.geekbang.org/resource/image/15/80/158bed3c92e7205fc450bb8b2d136480.jpg?wh=2521*1875\" alt=\"\"></p><p>è¿™ä¸‰ä¸ªæ–¹æ³•æ˜¯æ—¥å¿—æ®µå¯¹è±¡æœ€é‡è¦çš„åŠŸèƒ½ã€‚ä½ ä¸€å®šè¦ä»”ç»†é˜…è¯»å®ƒä»¬ï¼Œå°½é‡åšåˆ°å¯¹æºç ä¸­æ¯è¡Œä»£ç çš„ä½œç”¨éƒ½äº†ç„¶äºå¿ƒã€‚æ²¡æœ‰ä»€ä¹ˆä»£ç æ˜¯è¯»ä¸€éä¸èƒ½ç†è§£çš„ï¼Œå¦‚æœæœ‰ï¼Œé‚£å°±å†å¤šè¯»å‡ éã€‚å¦å¤–ï¼Œæˆ‘å¸Œæœ›ä½ ç‰¹åˆ«å…³æ³¨ä¸‹appendå’Œreadæ–¹æ³•ï¼Œå®ƒä»¬å°†æ˜¯åé¢æˆ‘ä»¬è®¨è®ºæ—¥å¿—å¯¹è±¡æ—¶é‡ç‚¹ä¼šç”¨åˆ°çš„ä¸¤ä¸ªæ–¹æ³•ã€‚æ¯•ç«Ÿï¼Œè¯»å†™æ—¥å¿—æ˜¯Kafkaæœ€å¸¸ç”¨çš„æ“ä½œï¼Œè€Œæ—¥å¿—è¯»å–åº•å±‚è°ƒç”¨çš„å°±æ˜¯æ—¥å¿—æ®µçš„è¿™ä¸¤ä¸ªæ–¹æ³•ã€‚</p><h2>è¯¾åè®¨è®º</h2><p>å¦‚æœä½ æŸ¥çœ‹æ—¥å¿—æ®µæºç çš„è¯ï¼Œä½ ä¼šå‘ç°ï¼Œè¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„æ–¹æ³•æˆ‘æ²¡æœ‰æåˆ°ï¼Œé‚£å°±æ˜¯truncateToæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šå°†æ—¥å¿—æ®µä¸­çš„æ•°æ®å¼ºåˆ¶æˆªæ–­åˆ°æŒ‡å®šçš„ä½ç§»å¤„ã€‚è¯¥æ–¹æ³•åªæœ‰20å‡ è¡Œä»£ç ï¼Œæˆ‘å¸Œæœ›ä½ å¯ä»¥è‡ªå·±å»é˜…è¯»ä¸‹ï¼Œç„¶åæ€è€ƒè¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼šå¦‚æœæŒ‡å®šçš„ä½ç§»å€¼ç‰¹åˆ«ç‰¹åˆ«å¤§ï¼Œä»¥è‡³äºè¶…è¿‡äº†æ—¥å¿—æ®µæœ¬èº«ä¿å­˜çš„æœ€å¤§ä½ç§»å€¼ï¼Œè¯¥æ–¹æ³•å¯¹æ‰§è¡Œæ•ˆæœæ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ</p><p>æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºç•…æ‰€æ¬²è¨€ï¼Œè·Ÿæˆ‘äº¤æµè®¨è®ºï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠæ–‡ç« åˆ†äº«ç»™ä½ çš„æœ‹å‹ã€‚</p>","neighbors":{"left":{"article_title":"é‡ç£…åŠ é¤ | å¸¦ä½ å¿«é€Ÿå…¥é—¨Scalaè¯­è¨€","id":230848},"right":{"article_title":"02 | æ—¥å¿—ï¼ˆä¸Šï¼‰ï¼šæ—¥å¿—ç©¶ç«Ÿæ˜¯å¦‚ä½•åŠ è½½æ—¥å¿—æ®µçš„ï¼Ÿ","id":224795}},"comments":[{"had_liked":false,"id":206985,"user_name":"ä¸œé£ç¬¬ä¸€æ","can_delete":false,"product_type":"c1","uid":1402697,"ip_address":"","ucode":"0CD0F62E90DAD8","user_header":"https://static001.geekbang.org/account/avatar/00/15/67/49/864dba17.jpg","comment_is_top":true,"comment_ctime":1586968947,"is_pvip":false,"replies":[{"id":"77311","content":"å¯¹çš„ï¼šï¼‰","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1587002315,"ip_address":"","comment_id":206985,"utype":1}],"discussion_count":5,"race_medal":0,"score":"9.2233720770964992e+18","product_id":100050101,"comment_content":"offsetIndex.truncateTo(offset) å’Œ timeIndex.truncateTo(offset)ä¸­æœ‰ç›¸åŒçš„ä¸€éƒ¨åˆ†ä»£ç :<br><br>\t  &#47;* There are 3 cases for choosing the new size<br>       * 1) if there is no entry in the index &lt;= the offset, delete everything<br>       * 2) if there is an entry for this exact offset, delete it and everything larger than it<br>       * 3) if there is no entry for this offset, delete everything larger than the next smallest<br>       *&#47;<br>      val newEntries =<br>        if(slot &lt; 0)<br>          0<br>        else if(relativeOffset(idx, slot) == offset - baseOffset)<br>          slot<br>        else<br>          slot + 1<br>\t\t  <br><br>æˆ‘è§‰å¾—è¿™åº”è¯¥è§£é‡Šäº†è€å¸ˆçš„æé—®ï¼šå¦‚æœæŒ‡å®šçš„ä½ç§»å€¼ç‰¹åˆ«ç‰¹åˆ«å¤§ï¼Œå¹¶ä¸”æ²¡æœ‰å¯ä»¥æˆªæ–­çš„æ¶ˆæ¯æ—¶ï¼Œä¼šæˆªæ–­æ¯”ä¸‹ä¸€ä¸ªæ¶ˆæ¯çš„ä½ç§»å¤§çš„æ‰€æœ‰çš„æ¶ˆæ¯ã€‚ä»£ç é‡Œé¢ç”¨äº†solt+1æ¥è¡¨ç¤ºã€‚ä¸çŸ¥é“æˆ‘ç†è§£çš„å¯¹ä¸å¯¹ã€‚","like_count":10,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":491971,"discussion_content":"å¯¹çš„ï¼šï¼‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587002315,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1703222,"avatar":"https://static001.geekbang.org/account/avatar/00/19/fd/36/f947c340.jpg","nickname":"Rogerå®‡","note":"","ucode":"CBA23C01409349","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":258470,"discussion_content":"æ‚¨å¥½ï¼Œä¸å¤ªç†è§£æ‚¨è¯´çš„è¿™ä¸ªtrucateToæ–¹æ³•ï¼Œæ‚¨è¯´çš„è¿™ä¸ªæ–¹æ³•æ˜¯æˆªæ–­ç´¢å¼•æ–‡ä»¶çš„å§ï¼Ÿè€å¸ˆè®©æˆ‘ä»¬çœ‹çš„ä¸æ˜¯log.truncateToæ–¹æ³•å—ï¼Ÿâ€œï¼šå¦‚æœæŒ‡å®šçš„ä½ç§»å€¼ç‰¹åˆ«ç‰¹åˆ«å¤§ï¼Œå¹¶ä¸”æ²¡æœ‰å¯ä»¥æˆªæ–­çš„æ¶ˆæ¯æ—¶ï¼Œä¼šæˆªæ–­æ¯”ä¸‹ä¸€ä¸ªæ¶ˆæ¯çš„ä½ç§»å¤§çš„æ‰€æœ‰çš„æ¶ˆæ¯â€ï¼Œè¯·é—®äº†è€å¸ˆåœ¨å“ªé‡Œè¯´åˆ°äº†è¿™ç‚¹å‘¢ï¼Ÿæˆ‘æ²¡æœ‰çœ‹åˆ°ï¼Œæ˜¯åé¢çš„ç« èŠ‚å—ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588689213,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1965728,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/fe/a0/b1212e2b.jpg","nickname":"ğŸ™Šé¡¾å°é¡¾","note":"","ucode":"FC7974A351586C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":250058,"discussion_content":"æ²¡æœ‰æ˜ç™½æ¬¸ã€‚è¿™ä¸ªå’Œè¶…è¿‡æ—¥å¿—é•¿åº¦æŠ¥å¼‚å¸¸æ˜¯ä¸æ˜¯çŸ›ç›¾çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587988334,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1402697,"avatar":"https://static001.geekbang.org/account/avatar/00/15/67/49/864dba17.jpg","nickname":"ä¸œé£ç¬¬ä¸€æ","note":"","ucode":"0CD0F62E90DAD8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":244999,"discussion_content":"ä¼šä¿ç•™çš„ï¼Œè¿™ä¸ªæˆªæ–­æ˜¯ä¸€æ¬¡æ€§æ“ä½œï¼Œä¸ä¼šå½±å“åˆ°åé¢çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587646567,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1179580,"avatar":"https://static001.geekbang.org/account/avatar/00/11/ff/bc/368b9f80.jpg","nickname":"ç°æœº","note":"","ucode":"46F6CFC2DFAA2B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":244705,"discussion_content":"å¤§ä½¬ è¯·é—®ä¸€ä¸‹ truncateToEntries(newEntries) è¿™ä¸ªä½ç½®æ˜¯æˆªå–åˆ°è¿™ä¸ªæ¶ˆæ¯çš„ä½ç½®ï¼Œ ä¼šæˆªæ–­æ¯”ä¸‹ä¸€ä¸ªæ¶ˆæ¯çš„ä½ç§»å¤§çš„æ‰€æœ‰çš„æ¶ˆæ¯ é‚£ä¹ˆè¿™ä¸ªâ€œä¸‹ä¸€ä¸ªæ¶ˆæ¯â€ ä¼šä¿ç•™å—ï¼Ÿ æ„Ÿè°¢ï½","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587622653,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":210947,"user_name":"èƒ¡å¤•","can_delete":false,"product_type":"c1","uid":1288090,"ip_address":"","ucode":"5709A689B6683B","user_header":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","comment_is_top":true,"comment_ctime":1587868748,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"9.2233720685074002e+18","product_id":100050101,"comment_content":"ä½ å¥½ï¼Œæˆ‘æ˜¯èƒ¡å¤•ã€‚æˆ‘æ¥å…¬å¸ƒä¸ŠèŠ‚è¯¾çš„â€œè¯¾åè®¨è®ºâ€é¢˜ç­”æ¡ˆå•¦ï½<br><br>ä¸ŠèŠ‚è¯¾ï¼Œå’±ä»¬é‡ç‚¹å­¦ä¹ äº†å¦‚ä½•æ„å»ºKafkaå·¥ç¨‹å’Œæ­å»ºæºç é˜…è¯»ç¯å¢ƒã€‚è¯¾åæˆ‘è®©ä½ å»å°è¯•å¯»æ‰¾kafka-console-producer.shè„šæœ¬å¯¹åº”çš„Javaç±»æ˜¯å“ªä¸ªæ–‡ä»¶ã€‚ç°åœ¨æˆ‘ç»™å‡ºç­”æ¡ˆï¼šå¦‚æœæˆ‘ä»¬æ‰“å¼€è¿™ä¸ªSHELLè„šæœ¬ï¼Œå¯ä»¥æ¸…æ¥šåœ°å‘ç°å®ƒè°ƒç”¨äº†kafka.tools.ConsoleProducerç±»ã€‚è¿™ä¸ªç±»ä½äºcoreåŒ…çš„src&#47;main&#47;scala&#47;kafka&#47;toolsä¸‹ï¼Œæ–‡ä»¶åæ˜¯ConsoleProducer.scalaã€‚<br><br>æ€ä¹ˆæ ·ï¼Œä½ æ‰¾åˆ°äº†å—ï¼Ÿæˆ‘ä»¬å¯ä»¥ä¸€èµ·è®¨è®ºä¸‹ã€‚","like_count":7},{"had_liked":false,"id":206000,"user_name":"è¶£","can_delete":false,"product_type":"c1","uid":1613430,"ip_address":"","ucode":"A14AFC6CC197A9","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIHREGPzjYqiaJc42UQ1Sg0tknO4ib4JnsRvXcS4kO6cLLft1UR8qKxMQqUjibDl09xPxdKJIgAXXyEg/132","comment_is_top":false,"comment_ctime":1586771067,"is_pvip":false,"replies":[{"id":"76988","content":"è°¢è°¢ï¼Œåé¢æˆ‘ä»¬ä¸€èµ·è®¨è®º~","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1586827761,"ip_address":"","comment_id":206000,"utype":1}],"discussion_count":1,"race_medal":0,"score":"53126378619","product_id":100050101,"comment_content":"ä¸€å£æ°”è¯»å®Œäº†è¿™ç¯‡æ–‡ç« ï¼Œæ„Ÿè§‰è€å¸ˆè®²å¾—ç‰¹åˆ«æ¸…æ¥šï¼Œç°åœ¨æˆ‘å¾ˆæœ‰ä¿¡å¿ƒå­¦å¥½æºç ã€‚è°¢è°¢è€å¸ˆï¼ŒæœŸå¾…åç»­çš„æ›´æ–°ã€‚","like_count":12,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":491640,"discussion_content":"è°¢è°¢ï¼Œåé¢æˆ‘ä»¬ä¸€èµ·è®¨è®º~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586827761,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":208519,"user_name":"Eternal","can_delete":false,"product_type":"c1","uid":1188023,"ip_address":"","ucode":"EA6FE7CC98F740","user_header":"https://static001.geekbang.org/account/avatar/00/12/20/b7/bdb3bcf0.jpg","comment_is_top":false,"comment_ctime":1587375016,"is_pvip":false,"replies":[{"id":"78144","content":"æ˜¯çš„ã€‚å‡ºç°map failed + è¶…å¤šåˆ†åŒºçš„æƒ…å†µé™¤äº†è°ƒæ•´ulimit -nä¹‹å¤–ï¼Œæœ€å¥½è°ƒæ•´ä¸‹vm.max_map_count~","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1587519883,"ip_address":"","comment_id":208519,"utype":1}],"discussion_count":3,"race_medal":0,"score":"48832015272","product_id":100050101,"comment_content":"ä¸€ä¸ªåˆ†åŒºpartionå¯¹åº”ä¸€ä¸ªLogå¯¹è±¡<br>ä¸€ä¸ªLogå¯¹è±¡å¯¹åº”ä¸€ä¸ªæ—¥å¿—ç›®å½•<br>ä¸€ä¸ªæ—¥å¿—ç›®å½•æœ‰å¤šä¸ªLogSegmentï¼Œä¸€ä¸ªLogmentæ¦‚å¿µä¸‹æœ‰4ä¸ªæ–‡ä»¶ï¼Œå¤šä¸€ä¸ªLogSegmentä¸‹çš„æ–‡ä»¶éƒ½æ˜¯åœ¨ä¸€ä¸ªç›®å½•ä¸‹çš„ï¼Œä¹Ÿå°±æ˜¯LogSegmentåªæ˜¯ä¸€ä¸ªæ¦‚å¿µä¸æ˜¯çœŸçš„æ–‡ä»¶ç›®å½•<br><br>ä¸€ä¸ªLogSegmentå°±æœ‰4ä¸ªç‰©ç†æ–‡ä»¶ï¼Œé‚£ä¹ˆé›†ç¾¤æœ‰æ–‡ä»¶=4 * LogSegment*partion*å‰¯æœ¬å› å­*topicã€‚å½“topicå’Œåˆ†åŒºæ•°å¾ˆå¤šçš„æ—¶å€™ï¼Œç³»ç»Ÿçš„æ–‡ä»¶å¥æŸ„å°±ä¸å¤Ÿç”¨äº†ï¼Œå¥½åƒç³»ç»Ÿé»˜è®¤æ˜¯65535<br>æ‰€æœ‰æˆ‘ä»¬å¯¹topicçš„æ•°é‡å’Œåˆ†åŒºçš„æ•°é‡éœ€è¦æœ‰ä¸€ä¸ªåˆç†çš„è§„åˆ’ã€‚<br><br>æˆ‘æœ‰ä¸€ä¸ªç–‘é—®ï¼šæˆ‘ä»¬å…¬å¸ä¹‹å‰é‡åˆ°è¿‡ç±»ä¼¼çš„é—®é¢˜ï¼Œä¸šåŠ¡æ–¹åˆ›å»ºäº†éå¸¸å¤šçš„topicå’Œåˆ†åŒºï¼Œç„¶åä¸€æ¬¡brokeré‡å¯çš„æ—¶å€™ï¼Œé‡å¯å¤±è´¥ï¼ŒåŸå› æ˜¯Map failed å†…å­˜æ˜ å°„å¤±è´¥ï¼Œè¿™ä¸ªå’Œè€å¸ˆæ–‡ä¸­è®²çš„â€œ Broker åœ¨å¯åŠ¨æ—¶ä¼šä»ç£ç›˜ä¸ŠåŠ è½½æ‰€æœ‰æ—¥å¿—æ®µä¿¡æ¯åˆ°å†…å­˜ä¸­ï¼Œå¹¶åˆ›å»ºç›¸åº”çš„ LogSegment å¯¹è±¡å®ä¾‹â€ å¥½åƒæ˜¯ä¸€æ ·çš„ï¼Œä¸æ­¢æˆ‘ç†è§£çš„å¯¹ä¸å¯¹ï¼š","like_count":11,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492487,"discussion_content":"æ˜¯çš„ã€‚å‡ºç°map failed + è¶…å¤šåˆ†åŒºçš„æƒ…å†µé™¤äº†è°ƒæ•´ulimit -nä¹‹å¤–ï¼Œæœ€å¥½è°ƒæ•´ä¸‹vm.max_map_count~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587519883,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1125656,"avatar":"https://static001.geekbang.org/account/avatar/00/11/2d/18/918eaecf.jpg","nickname":"åç«¯è¿›é˜¶","note":"","ucode":"480F48F5378307","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":307356,"discussion_content":"ä½ å¥½ï¼Œ4 * LogSegment*partion*å‰¯æœ¬å› å­*topicï¼Œå¥½åƒæ˜¯æ¼äº†ä¸€ä¸ªå‚æ•°ï¼Œå› ä¸ºä¸€ä¸ªæ—¥å¿—ç›®å½•æœ‰å¯èƒ½åŒ…å«å¤šä¸ªLogSegmentï¼Œæ˜¯ä¸æ˜¯è¿˜è¦ä¹˜ä»¥ä¸€ä¸ª nï¼ˆn >=1ï¼‰ï¼Ÿ","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1600609519,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1188023,"avatar":"https://static001.geekbang.org/account/avatar/00/12/20/b7/bdb3bcf0.jpg","nickname":"Eternal","note":"","ucode":"EA6FE7CC98F740","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1125656,"avatar":"https://static001.geekbang.org/account/avatar/00/11/2d/18/918eaecf.jpg","nickname":"åç«¯è¿›é˜¶","note":"","ucode":"480F48F5378307","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":307422,"discussion_content":"æ˜¯çš„ï¼Œè‡³å°‘ä¸€ä¸ªlogsegmentï¼Œéšç€æ•°æ®é‡å¢åŠ ï¼Œlogsegmemtæ•°é‡ä¹Ÿå¢åŠ ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600647281,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":307356,"ip_address":""},"score":307422,"extra":""}]}]},{"had_liked":false,"id":212637,"user_name":"å°å´”","can_delete":false,"product_type":"c1","uid":1104958,"ip_address":"","ucode":"4E537416787752","user_header":"https://static001.geekbang.org/account/avatar/00/10/dc/3e/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1588167887,"is_pvip":false,"replies":[{"id":"79136","content":"1. éƒ½å¯ä»¥çš„ã€‚Kafkaæ”¯æŒä¸¤ç§æ—¶é—´æˆ³ç­–ç•¥ï¼ŒCREATEå’ŒAPPENDã€‚å‰è€…æ˜¯producerç«¯ç”Ÿæˆçš„ï¼Œåè€…æ˜¯æŒ‡brokerç«¯ä½¿ç”¨æœ¬æœºæ—¶é—´è¦†ç›–producerç«¯ç”Ÿæˆçš„æ—¶é—´æˆ³<br>2. ç”±æ¶ˆè´¹è€…è§’è‰²è€Œå®šã€‚å‡è®¾ä¸è€ƒè™‘äº‹åŠ¡å‹consumerã€‚<br><br>å¦‚æœæ˜¯æ™®é€šconsumerï¼Œé‚£ä¹ˆä½ åªèƒ½è¯»åˆ°HWä»¥ä¸‹çš„æ¶ˆæ¯ï¼Œé‚£ä¹ˆmaxPositionå°±æ˜¯HWçš„ç‰©ç†ä½ç½®â€”â€”è¿™æ˜¯å‡è®¾è¯»å–èµ·å§‹ä½ç§»ä¸hwåœ¨åŒä¸€ä¸ªæ®µä¸Šï¼Œå¦åˆ™maxPositionå°±æ˜¯æ•´ä¸ªæ®µçš„å­—èŠ‚æ•°ï¼›<br>åŒç†ï¼Œå¦‚æœæ˜¯followerï¼Œé‚£ä¹ˆæœ€å¤šå¯ä»¥è¯»åˆ°LEOï¼ŒmaxPositionå°±æ˜¯LEOçš„ç‰©ç†ä½ç½®â€”â€”åŒæ ·æ˜¯å‡è®¾è¯»å–èµ·å§‹ä½ç§»ä¸hwåœ¨åŒä¸€ä¸ªæ®µä¸Š","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1588400964,"ip_address":"","comment_id":212637,"utype":1}],"discussion_count":1,"race_medal":0,"score":"31652938959","product_id":100050101,"comment_content":"1.æ—¶é—´æˆ³ï¼Œæ˜¯brokeræ¥æ”¶åˆ°æ¶ˆæ¯æ—¶è®¾ç½®çš„ï¼Œè¿˜æ˜¯ç”Ÿäº§è€…å‘é€æ—¶è®¾ç½®çš„ï¼Ÿ<br>2.readæ–¹æ³•é‡Œçš„maxSizeæˆ‘ç†è§£å¯ä»¥ç”±æ¶ˆè´¹è€…è®¾å®šï¼Œä½†æ˜¯maxPositionç”±è°è®¾å®šï¼Ÿåˆæœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿé˜²æ­¢ç‰©ç†ä½ç½®è¶Šç•Œä¹ˆï¼Ÿ","like_count":7,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493570,"discussion_content":"1. éƒ½å¯ä»¥çš„ã€‚Kafkaæ”¯æŒä¸¤ç§æ—¶é—´æˆ³ç­–ç•¥ï¼ŒCREATEå’ŒAPPENDã€‚å‰è€…æ˜¯producerç«¯ç”Ÿæˆçš„ï¼Œåè€…æ˜¯æŒ‡brokerç«¯ä½¿ç”¨æœ¬æœºæ—¶é—´è¦†ç›–producerç«¯ç”Ÿæˆçš„æ—¶é—´æˆ³\n2. ç”±æ¶ˆè´¹è€…è§’è‰²è€Œå®šã€‚å‡è®¾ä¸è€ƒè™‘äº‹åŠ¡å‹consumerã€‚\n\nå¦‚æœæ˜¯æ™®é€šconsumerï¼Œé‚£ä¹ˆä½ åªèƒ½è¯»åˆ°HWä»¥ä¸‹çš„æ¶ˆæ¯ï¼Œé‚£ä¹ˆmaxPositionå°±æ˜¯HWçš„ç‰©ç†ä½ç½®â€”â€”è¿™æ˜¯å‡è®¾è¯»å–èµ·å§‹ä½ç§»ä¸hwåœ¨åŒä¸€ä¸ªæ®µä¸Šï¼Œå¦åˆ™maxPositionå°±æ˜¯æ•´ä¸ªæ®µçš„å­—èŠ‚æ•°ï¼›\nåŒç†ï¼Œå¦‚æœæ˜¯followerï¼Œé‚£ä¹ˆæœ€å¤šå¯ä»¥è¯»åˆ°LEOï¼ŒmaxPositionå°±æ˜¯LEOçš„ç‰©ç†ä½ç½®â€”â€”åŒæ ·æ˜¯å‡è®¾è¯»å–èµ·å§‹ä½ç§»ä¸hwåœ¨åŒä¸€ä¸ªæ®µä¸Š","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588400964,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":208646,"user_name":"ç°æœº","can_delete":false,"product_type":"c1","uid":1179580,"ip_address":"","ucode":"46F6CFC2DFAA2B","user_header":"https://static001.geekbang.org/account/avatar/00/11/ff/bc/368b9f80.jpg","comment_is_top":false,"comment_ctime":1587395709,"is_pvip":false,"replies":[{"id":"78140","content":"å¤§è‡´æ„æ€æ˜¯è¯´producerå†™å…¥4KBçš„æ¶ˆæ¯æ•°æ®åï¼Œä¼šä¸ºå½“å‰æ—¥å¿—æ®µå¯¹è±¡çš„ç´¢å¼•æ–‡ä»¶ä¸­æ–°å†™å…¥ä¸€æ¡OffsetIndexç´¢å¼•é¡¹ã€‚ç´¢å¼•æ–‡ä»¶å°±æ˜¯***.indexã€‚4KBæ˜¯ç”±Brokerç«¯å‚æ•°log.index.interval.byteså†³å®š","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1587519102,"ip_address":"","comment_id":208646,"utype":1}],"discussion_count":1,"race_medal":0,"score":"27357199485","product_id":100050101,"comment_content":"è€å¸ˆæ‚¨å¥½ï¼Œæˆ‘æƒ³é—®ä¸€ä¸‹ â€œæ—¥å¿—æ®µè‡³å°‘æ–°å†™å…¥ 4KB çš„æ¶ˆæ¯æ•°æ®æ‰ä¼šæ–°å¢ä¸€æ¡ç´¢å¼•é¡¹â€ è¿™ä¸ªæ˜¯å†™åœ¨OffsetIndex ä¸­ä¹ˆï¼Ÿ å¯¹åº”ç‰©ç†ä½ç½®æ˜¯***.indexä¸­ä¹ˆï¼Ÿ è¿™ä¸ªæ–°å¢ä¸€æ¡ç´¢å¼•é¡¹ä¸æ˜¯å¾ˆç†è§£ï¼Œå¸Œæœ›è€å¸ˆçœ‹åˆ°åç»™äºˆè§£ç­”ã€‚ æ„Ÿè°¢","like_count":6,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492560,"discussion_content":"å¤§è‡´æ„æ€æ˜¯è¯´producerå†™å…¥4KBçš„æ¶ˆæ¯æ•°æ®åï¼Œä¼šä¸ºå½“å‰æ—¥å¿—æ®µå¯¹è±¡çš„ç´¢å¼•æ–‡ä»¶ä¸­æ–°å†™å…¥ä¸€æ¡OffsetIndexç´¢å¼•é¡¹ã€‚ç´¢å¼•æ–‡ä»¶å°±æ˜¯***.indexã€‚4KBæ˜¯ç”±Brokerç«¯å‚æ•°log.index.interval.byteså†³å®š","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587519102,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":245683,"user_name":"æå¥•æ…§","can_delete":false,"product_type":"c1","uid":1201005,"ip_address":"","ucode":"0D8871ED38859C","user_header":"https://static001.geekbang.org/account/avatar/00/12/53/6d/c3828950.jpg","comment_is_top":false,"comment_ctime":1599026612,"is_pvip":false,"replies":[{"id":"90394","content":"å¯èƒ½å‘ç”Ÿæˆªæ–­ã€æ—¥å¿—æ®µè¢«åˆ é™¤ç­‰æƒ…å†µï¼Œå› æ­¤æœ€å¥½é‡å»ºç´¢å¼•æ–‡ä»¶","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1599095098,"ip_address":"","comment_id":245683,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18778895796","product_id":100050101,"comment_content":"ä¸æ˜ç™½ä¸ºå•¥ recover éœ€è¦æ¸…ç©ºç´¢å¼•æ–‡ä»¶(è¿™é‡Œçš„ç´¢å¼•æ–‡ä»¶æŒ‡çš„æ˜¯ xxx.index æ–‡ä»¶å—ï¼Ÿ)","like_count":4,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":504957,"discussion_content":"å¯èƒ½å‘ç”Ÿæˆªæ–­ã€æ—¥å¿—æ®µè¢«åˆ é™¤ç­‰æƒ…å†µï¼Œå› æ­¤æœ€å¥½é‡å»ºç´¢å¼•æ–‡ä»¶","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599095098,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":213957,"user_name":"Rogerå®‡","can_delete":false,"product_type":"c1","uid":1703222,"ip_address":"","ucode":"CBA23C01409349","user_header":"https://static001.geekbang.org/account/avatar/00/19/fd/36/f947c340.jpg","comment_is_top":false,"comment_ctime":1588599510,"is_pvip":false,"replies":[{"id":"79372","content":"ç›®å‰producerç«¯æ˜¯å¯ä»¥è‡ªè¡ŒæŒ‡å®šä»»æ„æ—¶é—´æˆ³çš„","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1588743777,"ip_address":"","comment_id":213957,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18768468694","product_id":100050101,"comment_content":" if (largestTimestamp &gt; maxTimestampSoFar) <br>â€”â€”â€”â€”â€”- <br>è¯·æƒ³é—®ä¸€ä¸‹ï¼Œæ—¢ç„¶æ˜¯è¦è¿½åŠ çš„æ—¥å¿—ï¼Œè€Œä¸€ä¸ªæ—¥å¿—æ®µæ®µæ¶ˆæ¯åº”è¯¥æ˜¯é¡ºåºè¿½åŠ ï¼ˆæ¨æµ‹ï¼‰ï¼Œé‚£ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªif åˆ¤æ–­å‘¢ï¼Ÿè¯·é—®è€å¸ˆï¼Œåœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä¼šå‡ºç°éœ€è¦è¿½åŠ çš„æ¶ˆæ¯é›†åˆä¸­æœ€å¤§æ—¶é—´æˆ³å°äºç­‰äºå½“å‰æ—¥å¿—æ®µå·²ç»è§åˆ°çš„æ—¶é—´æˆ³çš„æœ€å¤§å€¼ï¼Œå³ largestTimestamp &lt;= maxTimestampSoFarçš„æƒ…å†µå‘¢ï¼Ÿ","like_count":4,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493912,"discussion_content":"ç›®å‰producerç«¯æ˜¯å¯ä»¥è‡ªè¡ŒæŒ‡å®šä»»æ„æ—¶é—´æˆ³çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588743777,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":209555,"user_name":"ç°æœº","can_delete":false,"product_type":"c1","uid":1179580,"ip_address":"","ucode":"46F6CFC2DFAA2B","user_header":"https://static001.geekbang.org/account/avatar/00/11/ff/bc/368b9f80.jpg","comment_is_top":false,"comment_ctime":1587566275,"is_pvip":false,"replies":[{"id":"78224","content":"å¯èƒ½å‡ºç°è¿™ç§æƒ…å†µï¼šæ—¥å¿—æ–‡ä»¶å†™å…¥äº†æ¶ˆæ¯çš„éƒ¨åˆ†å­—èŠ‚ç„¶åbrokerå®•æœºã€‚ç£ç›˜æ˜¯å—è®¾å¤‡ï¼Œå®ƒå¯ä¸èƒ½ä¿è¯æ¶ˆæ¯çš„å…¨éƒ¨å­—èŠ‚è¦ä¹ˆå…¨éƒ¨å†™å…¥ï¼Œè¦ä¹ˆå…¨éƒ½ä¸å†™å…¥ã€‚å› æ­¤Kafkaå¿…é¡»æœ‰æœºåˆ¶åº”å¯¹è¿™ç§æƒ…å†µï¼Œå³æ ¡éªŒ+truncate","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1587603685,"ip_address":"","comment_id":209555,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18767435459","product_id":100050101,"comment_content":"å…ˆå›ç­”è€å¸ˆæå‡ºçš„é—®é¢˜ï¼šlog.truncateTo(validBytes) validBytesä¸ºè¦æ¸…åˆ°çš„å¤§å°ï¼Œåœ¨truncateæ–¹æ³•ä¸­é¦–å…ˆä¼šè·å–å½“å‰LogSegmentçš„æ–‡ä»¶å¤§å°ï¼Œå½“validByte&gt; è¯¥æ–‡ä»¶å¤§å°çš„æ—¶å€™ä¼šthrows ä¸€ä¸ªå¼‚å¸¸ å¼‚å¸¸ä¸º&quot;æ‰“ç®—æ¸…ç©º xxx.log åˆ°validBytes è¿™ä¹ˆå¤§ ä½†æ˜¯å¤±è´¥äº†ï¼Œæ—¥å¿—æ®µå¤§å°ä¸ºå½“å‰LogSegementå¤§å°&quot;,å¦‚æœvalidByteå°äºå½“å‰log byte è°ƒç”¨fileChannel.truncate(validBytes)è¿›è¡Œç›´æ¥æˆªæ–­, åŒæ—¶è¿”å›æˆªæ–­çš„å¤§å°æœ‰å¤šå°‘å­—èŠ‚ã€‚<br>è¯·æ•™ï¼šè€å¸ˆ æˆ‘çœ‹åˆ°æºç ä¸­val truncated = log.sizeInBytes - validBytes  validBytesä¸ºä»logFileä¸­çš„bactch æ‰¹é‡è¯»å–messageçš„å­—èŠ‚æ•°ç´¯åŠ å®ç°ï¼Œè€Œlog.sizeInByteåŒæ ·ä¸æ˜¯logæ–‡ä»¶è¯»å–å‡ºæ¥çš„ä¹ˆï¼Ÿ ä¸ºä»€ä¹ˆä¼šå‡ºç°éœ€è¦truncateå‘¢ï¼Ÿ èƒ½å¦ä¸¾ä¾‹è¯´æ˜ä»€ä¹ˆæ—¶å€™LogFileä¸­å†™å…¥äº†å¼‚å¸¸æ•°æ®å‘¢  è¿™ä¸ªä¸æ˜¯å¾ˆç†è§£ã€‚","like_count":4,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492830,"discussion_content":"å¯èƒ½å‡ºç°è¿™ç§æƒ…å†µï¼šæ—¥å¿—æ–‡ä»¶å†™å…¥äº†æ¶ˆæ¯çš„éƒ¨åˆ†å­—èŠ‚ç„¶åbrokerå®•æœºã€‚ç£ç›˜æ˜¯å—è®¾å¤‡ï¼Œå®ƒå¯ä¸èƒ½ä¿è¯æ¶ˆæ¯çš„å…¨éƒ¨å­—èŠ‚è¦ä¹ˆå…¨éƒ¨å†™å…¥ï¼Œè¦ä¹ˆå…¨éƒ½ä¸å†™å…¥ã€‚å› æ­¤Kafkaå¿…é¡»æœ‰æœºåˆ¶åº”å¯¹è¿™ç§æƒ…å†µï¼Œå³æ ¡éªŒ+truncate","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587603685,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":332232,"user_name":"Insomnia","can_delete":false,"product_type":"c1","uid":1751214,"ip_address":"","ucode":"5986A48988D6E3","user_header":"https://static001.geekbang.org/account/avatar/00/1a/b8/ae/085484e7.jpg","comment_is_top":false,"comment_ctime":1643102099,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"10233036691","product_id":100050101,"comment_content":"èƒ¡è€å¸ˆ, å¯¹ Kafka çš„é¡ºåºè¯»å†™æœ‰ç‚¹ç–‘æƒ‘:<br>çœ‹äº†æºç ä¸­å†™ LogSegment çš„æ–¹æ³•æœ¬è´¨ä¹Ÿæ˜¯è°ƒç”¨äº† FileChannel.write() æ–¹æ³•, ä½†æ˜¯ PageCache çš„è½ç›˜æ˜¯ç”± OS æ¥æ“ä½œçš„, è¿™ä¸€ç‚¹å¹¶ä¸èƒ½ä¿è¯æ•°æ®ä¼šè½åœ¨ç£ç›˜çš„è¿ç»­æ‰‡åŒºä¸Š? æˆ‘ä¸çŸ¥é“è¿™ä¸ªç†è§£å¯¹ä¸å¯¹? å¦‚æœä¸ä¿è¯æ‰‡åŒºçš„è¿ç»­æ€§, é‚£ä¹ˆè¯»çš„æ—¶å€™é¢„è¯» PageCache çš„çº¢åˆ©ä¸å°±æ²¡æœ‰äº†ä¹ˆ?","like_count":1,"discussions":[{"author":{"id":2826174,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/1f/be/402a04e5.jpg","nickname":"åº·å®","note":"","ucode":"00EC7266C1619B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":590795,"discussion_content":"PageCacheçš„æ•°æ®æ˜¯ä¼šä¸¥æ ¼æŒ‰ç…§é¡ºåºè½ç›˜çš„ï¼Œå®ƒåªæ˜¯OSåŠ ä¸Šå»çš„ä¸€å±‚ç¼“å­˜ï¼Œä¸å½±å“æ–‡ä»¶é¡ºåº","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1666077796,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"åŒ—äº¬"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":272184,"user_name":"å¼ ä¸‰ä¸°","can_delete":false,"product_type":"c1","uid":1155275,"ip_address":"","ucode":"3A6215A40B3B21","user_header":"https://static001.geekbang.org/account/avatar/00/11/a0/cb/aab3b3e7.jpg","comment_is_top":false,"comment_ctime":1609983999,"is_pvip":false,"replies":[{"id":"98756","content":"ç´¢å¼•é¡¹å°±æ˜¯&lt;offsetï¼Œç‰©ç†æ–‡ä»¶ä½ç½®&gt;å¯¹","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1610089573,"ip_address":"","comment_id":272184,"utype":1}],"discussion_count":2,"race_medal":0,"score":"10199918591","product_id":100050101,"comment_content":"è€å¸ˆè¯·é—®è¿™ä¸ªç´¢å¼•é¡¹æ˜¯ä»€ä¹ˆï¼Ÿ ç”¨æ¥åšä»€ä¹ˆçš„ï¼Ÿ<br><br>indexIntervalBytes å€¼å…¶å®å°±æ˜¯ Broker ç«¯å‚æ•° log.index.interval.bytes å€¼ï¼Œå®ƒæ§åˆ¶äº†æ—¥å¿—æ®µå¯¹è±¡æ–°å¢ç´¢å¼•é¡¹çš„é¢‘ç‡ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ—¥å¿—æ®µè‡³å°‘æ–°å†™å…¥ 4KB çš„æ¶ˆæ¯æ•°æ®æ‰ä¼šæ–°å¢ä¸€æ¡ç´¢å¼•é¡¹ã€‚","like_count":2,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":513192,"discussion_content":"ç´¢å¼•é¡¹å°±æ˜¯&amp;lt;offsetï¼Œç‰©ç†æ–‡ä»¶ä½ç½®&amp;gt;å¯¹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1610089573,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2826174,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/1f/be/402a04e5.jpg","nickname":"åº·å®","note":"","ucode":"00EC7266C1619B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":590797,"discussion_content":"å…¶å®å°±æ˜¯ä¸ªç¨€ç–ç´¢å¼•ï¼Œç®€å•ç†è§£ä¸ºï¼Œæ¯éš”4Kæ•°æ®å°±å»ºç«‹ä¸€ä¸ªç´¢å¼•ï¼Œæ˜¯ä¸ºå°†æ¥æ•°æ®æŸ¥è¯¢æ—¶ä½¿ç”¨","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1666077903,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"åŒ—äº¬"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":230665,"user_name":"äº‘è¶…","can_delete":false,"product_type":"c1","uid":1581783,"ip_address":"","ucode":"63DFDDAB37A04F","user_header":"https://static001.geekbang.org/account/avatar/00/18/22/d7/ae0ed31f.jpg","comment_is_top":false,"comment_ctime":1593444449,"is_pvip":false,"replies":[{"id":"85261","content":"è¿™å¥è¯çš„æ„æ€æ˜¯è¯´ä½œè€…ä¼šå‡è®¾è°ƒç”¨appendæ–¹æ³•çš„æ—¶å€™å·²ç»æŒæœ‰é”äº†ã€‚äº‹å®ä¸Šä¹Ÿæ˜¯è¿™æ ·çš„ï¼Œå®ƒè¢«è°ƒç”¨æ—¶çº¿ç¨‹éƒ½æŒæœ‰äº†Partitionå¯¹è±¡çš„leaderIsrUpdateLocké”","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1593506937,"ip_address":"","comment_id":230665,"utype":1}],"discussion_count":2,"race_medal":0,"score":"10183379041","product_id":100050101,"comment_content":"è€å¸ˆï¼Œæˆ‘åœ¨çœ‹appendæ–¹æ³•çš„æ—¶å€™ï¼Œåœ¨æ³¨é‡Šä¸­çœ‹åˆ°æœ‰è¿™ä¹ˆä¸€å¥ï¼ŒIt is assumed this method is being called from within a lock. æˆ‘è‹±è¯­ä¸å¤ªå¥½ï¼Œç¿»è¯‘è¿‡æ¥å¤§æ¦‚çš„æ„æ€æ˜¯  å‡è®¾æ–¹æ³•æ˜¯ä»é”ä¸­è°ƒç”¨çš„ã€‚æˆ‘æƒ³é—®ä¸€ä¸‹ï¼Œä¸ºä»€ä¹ˆä¼šè¯´å‡è®¾æ–¹æ³•æ˜¯ä»é”ä¸­è°ƒç”¨çš„ï¼Ÿæˆ–è€…è¯´ï¼Œè¿™ä¸€å¥æ³¨é‡Šæ˜¯æƒ³è¦å‘Šè¯‰æˆ‘ä»¬äº›ä»€ä¹ˆå‘¢ï¼Ÿ","like_count":2,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":499984,"discussion_content":"è¿™å¥è¯çš„æ„æ€æ˜¯è¯´ä½œè€…ä¼šå‡è®¾è°ƒç”¨appendæ–¹æ³•çš„æ—¶å€™å·²ç»æŒæœ‰é”äº†ã€‚äº‹å®ä¸Šä¹Ÿæ˜¯è¿™æ ·çš„ï¼Œå®ƒè¢«è°ƒç”¨æ—¶çº¿ç¨‹éƒ½æŒæœ‰äº†Partitionå¯¹è±¡çš„leaderIsrUpdateLocké”","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1593506937,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1581783,"avatar":"https://static001.geekbang.org/account/avatar/00/18/22/d7/ae0ed31f.jpg","nickname":"äº‘è¶…","note":"","ucode":"63DFDDAB37A04F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":297868,"discussion_content":"å¥½çš„ï¼Œæˆ‘æ˜ç™½äº†ï¼Œè°¢è°¢è€å¸ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597074919,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":208731,"user_name":"æˆ‘æ˜¯ä¸ªbug","can_delete":false,"product_type":"c1","uid":1370035,"ip_address":"","ucode":"0666969CC4D839","user_header":"https://static001.geekbang.org/account/avatar/00/14/e7/b3/687b120e.jpg","comment_is_top":false,"comment_ctime":1587430197,"is_pvip":false,"replies":[{"id":"78136","content":"ä½ åŸºæœ¬ä¸Šå¯ä»¥è®¤ä¸ºå®ƒä»¬ä¸¤ä¸ªæ˜¯ä¸€æ ·çš„ã€‚å‰ææ˜¯æ¶ˆæ¯ä¸­æ—¶é—´æˆ³æ˜¯å•è°ƒå¢åŠ çš„ï¼Œè¿™ä¹Ÿç¬¦åˆæˆ‘ä»¬å¸¸è§çš„ä½¿ç”¨åœºæ™¯ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1587518938,"ip_address":"","comment_id":208731,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10177364789","product_id":100050101,"comment_content":"è¯·é—®ï¼Œappend æ–¹æ³•çš„ largestOffset å’Œ shallowOffsetOfMaxTimestamp å‚æ•°ï¼Œæœ‰å¯èƒ½ç›¸ç­‰å—ï¼Ÿä»€ä¹ˆæ—¶å€™ç›¸ç­‰ï¼Œä»€ä¹ˆæ—¶å€™ä¸ç›¸ç­‰ï¼Ÿ","like_count":2,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492597,"discussion_content":"ä½ åŸºæœ¬ä¸Šå¯ä»¥è®¤ä¸ºå®ƒä»¬ä¸¤ä¸ªæ˜¯ä¸€æ ·çš„ã€‚å‰ææ˜¯æ¶ˆæ¯ä¸­æ—¶é—´æˆ³æ˜¯å•è°ƒå¢åŠ çš„ï¼Œè¿™ä¹Ÿç¬¦åˆæˆ‘ä»¬å¸¸è§çš„ä½¿ç”¨åœºæ™¯ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587518938,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":207333,"user_name":"drapeauğŸ–","can_delete":false,"product_type":"c1","uid":1405331,"ip_address":"","ucode":"83BB32485995FC","user_header":"https://static001.geekbang.org/account/avatar/00/15/71/93/448cec84.jpg","comment_is_top":false,"comment_ctime":1587049290,"is_pvip":false,"replies":[{"id":"77462","content":"å¾ˆå¤šæ“ä½œç³»ç»Ÿçš„ä¹¦å¯¹é¡µç¼“å­˜éƒ½æœ‰ä»‹ç»ã€‚ç®€å•æ¥è¯´ï¼Œpage cacheæ˜¯æœ€é‡è¦çš„ä¸€ç±»æ“ä½œç³»ç»Ÿï¼ˆç‰¹åˆ«æ˜¯Linuxç³»ç»Ÿï¼‰disk cacheã€‚ç›¸å…³ä»‹ç»å¯ä»¥çœ‹çœ‹ã€ŠUnderstanding the Linux Kernelã€‹","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1587088866,"ip_address":"","comment_id":207333,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10176983882","product_id":100050101,"comment_content":"å¸Œæœ›è€å¸ˆä»¥åèƒ½è®²è®²é¡µç¼“å­˜è¿™ä¸ªä¸œè¥¿","like_count":2,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492088,"discussion_content":"å¾ˆå¤šæ“ä½œç³»ç»Ÿçš„ä¹¦å¯¹é¡µç¼“å­˜éƒ½æœ‰ä»‹ç»ã€‚ç®€å•æ¥è¯´ï¼Œpage cacheæ˜¯æœ€é‡è¦çš„ä¸€ç±»æ“ä½œç³»ç»Ÿï¼ˆç‰¹åˆ«æ˜¯Linuxç³»ç»Ÿï¼‰disk cacheã€‚ç›¸å…³ä»‹ç»å¯ä»¥çœ‹çœ‹ã€ŠUnderstanding the Linux Kernelã€‹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587088866,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":207218,"user_name":"å¥”è·‘å°ç”µé©´","can_delete":false,"product_type":"c1","uid":1670951,"ip_address":"","ucode":"36950F0FB59F58","user_header":"https://static001.geekbang.org/account/avatar/00/19/7f/27/9c5ac353.jpg","comment_is_top":false,"comment_ctime":1587026006,"is_pvip":false,"replies":[{"id":"77467","content":"Kafkaä¸­çš„å˜é‡å‘½åæ€»ä½“æ¥è¯´è¿˜æ˜¯å‹å¥½çš„ï¼Œç¡®å®ä¹Ÿå­˜åœ¨ä¸€äº›å˜é‡ä¸çŸ¥å…¶æ„ã€‚è¿˜æ˜¯è¦ç»“åˆå®ƒåœ¨æºç ä¸­çš„ä½œç”¨æ¥çœ‹ï¼Œç‰¹åˆ«æ˜¯ä½¿ç”¨å®ƒçš„æ–¹æ³•ã€‚ä¹Ÿè®¸åœ¨è¿™äº›æ–¹æ³•ä¸­æœ‰å¯¹åº”çš„infoæˆ–warn logè¯´æ˜äº†å®ƒçš„ç”¨æ³•ã€‚<br>æˆ‘ä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚LogCleanerç»„ä»¶ä¸­æœ‰ä¸ªå˜é‡å«uncleanablePartitionsï¼Œæ³¨é‡Šé‡Œå†™å®ƒä¿å­˜ä¸å¯è¢«cleançš„åˆ†åŒºï¼Œä½†å…‰çœ‹æ³¨é‡Šæˆ‘ä»¬ä¹Ÿä¸çŸ¥é“ä¸å¯è¢«cleanè¦æ»¡è¶³ä»€ä¹ˆæ¡ä»¶ã€‚è¿™ä¸ªæ—¶å€™ä½ å°±çœ‹å“ªä¸ªæ–¹æ³•å¾€è¿™ä¸ªMapä¸­æ·»åŠ åˆ†åŒºï¼Œä¸€æŸ¥æºç å‘ç°æ˜¯markPartitionUncleanableæ–¹æ³•ï¼Œå¯è¿™ä¸ªæ–¹æ³•æ²¡æœ‰ä¸€è¡Œæ³¨é‡Šï¼<br>æ²¡é—®é¢˜ï¼Œæˆ‘ä»¬ç»§ç»­çœ‹ï¼ŒtryCleanFilthiestLogæ–¹æ³•ä¼šè°ƒç”¨markPartitionUncleanableã€‚tryCleanFilthiestLogé‡Œé¢å†™äº†åˆ°åº•å“ªäº›åˆ†åŒºä¸èƒ½è¢«cleanï¼Œå› ä¸ºæœ‰ä¸€è¡Œwarnæ—¥å¿—","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1587089510,"ip_address":"","comment_id":207218,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10176960598","product_id":100050101,"comment_content":"kafkaç”¨çš„ä¹Ÿä¸ç®—å°‘ï¼Œä½†å†·ä¸ä¸çœ‹æºç è¿˜æ˜¯æœ‰éš¾åº¦ï¼Œå…·ä½“éš¾åœ¨æœ‰äº›å˜é‡ä¸æ˜¯ç‰¹åˆ«æ¸…æ¥šæ˜¯åšä»€ä¹ˆçš„ï¼Œå¯¼è‡´ç†è§£æ•´ä¸ªæµç¨‹å°±æœ‰ç‚¹å›°éš¾ï¼Œè¿™å—è€å¸ˆæœ‰ä»€ä¹ˆå¥½çš„æ–¹æ³•å˜›~~","like_count":2,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492046,"discussion_content":"Kafkaä¸­çš„å˜é‡å‘½åæ€»ä½“æ¥è¯´è¿˜æ˜¯å‹å¥½çš„ï¼Œç¡®å®ä¹Ÿå­˜åœ¨ä¸€äº›å˜é‡ä¸çŸ¥å…¶æ„ã€‚è¿˜æ˜¯è¦ç»“åˆå®ƒåœ¨æºç ä¸­çš„ä½œç”¨æ¥çœ‹ï¼Œç‰¹åˆ«æ˜¯ä½¿ç”¨å®ƒçš„æ–¹æ³•ã€‚ä¹Ÿè®¸åœ¨è¿™äº›æ–¹æ³•ä¸­æœ‰å¯¹åº”çš„infoæˆ–warn logè¯´æ˜äº†å®ƒçš„ç”¨æ³•ã€‚\næˆ‘ä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚LogCleanerç»„ä»¶ä¸­æœ‰ä¸ªå˜é‡å«uncleanablePartitionsï¼Œæ³¨é‡Šé‡Œå†™å®ƒä¿å­˜ä¸å¯è¢«cleançš„åˆ†åŒºï¼Œä½†å…‰çœ‹æ³¨é‡Šæˆ‘ä»¬ä¹Ÿä¸çŸ¥é“ä¸å¯è¢«cleanè¦æ»¡è¶³ä»€ä¹ˆæ¡ä»¶ã€‚è¿™ä¸ªæ—¶å€™ä½ å°±çœ‹å“ªä¸ªæ–¹æ³•å¾€è¿™ä¸ªMapä¸­æ·»åŠ åˆ†åŒºï¼Œä¸€æŸ¥æºç å‘ç°æ˜¯markPartitionUncleanableæ–¹æ³•ï¼Œå¯è¿™ä¸ªæ–¹æ³•æ²¡æœ‰ä¸€è¡Œæ³¨é‡Šï¼\næ²¡é—®é¢˜ï¼Œæˆ‘ä»¬ç»§ç»­çœ‹ï¼ŒtryCleanFilthiestLogæ–¹æ³•ä¼šè°ƒç”¨markPartitionUncleanableã€‚tryCleanFilthiestLogé‡Œé¢å†™äº†åˆ°åº•å“ªäº›åˆ†åŒºä¸èƒ½è¢«cleanï¼Œå› ä¸ºæœ‰ä¸€è¡Œwarnæ—¥å¿—","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587089510,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":329714,"user_name":"è¡Œèµ°çš„é£ç¿”è€…","can_delete":false,"product_type":"c1","uid":1072105,"ip_address":"","ucode":"A017E4C901A208","user_header":"https://static001.geekbang.org/account/avatar/00/10/5b/e9/829bb26f.jpg","comment_is_top":false,"comment_ctime":1641490065,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5936457361","product_id":100050101,"comment_content":"â€œä¸“æ åé¢æˆ‘å°†ä¸“é—¨è®¨è®º Kafka æ˜¯å¦‚ä½•ä¿å­˜å…·ä½“æ¶ˆæ¯çš„ï¼Œä¹Ÿå°±æ˜¯ FileRecords åŠå…¶å®¶æ—çš„å®ç°æ–¹å¼ã€‚åŒæ—¶ï¼Œæˆ‘è¿˜ä¼šç»™ä½ ä»‹ç»ä¸€ä¸‹ç¤¾åŒºåœ¨æŒä¹…åŒ–æ¶ˆæ¯è¿™å—æ˜¯æ€ä¹ˆæ¼”è¿›çš„ï¼Œä½ ä¸€å®šä¸è¦é”™è¿‡é‚£éƒ¨åˆ†çš„å†…å®¹ã€‚â€è¯·é—®è¿™å—æŸ¥äº†å…¨éƒ¨ä¸“æ ä¹Ÿæ²¡å‘ç°è®²ï¼Ÿ","like_count":1},{"had_liked":false,"id":260020,"user_name":"çå¦®â€¢ç›ä»•å¤š","can_delete":false,"product_type":"c1","uid":1806720,"ip_address":"","ucode":"6E1E5564F979B3","user_header":"https://static001.geekbang.org/account/avatar/00/1b/91/80/bc38f890.jpg","comment_is_top":false,"comment_ctime":1604909270,"is_pvip":true,"replies":[{"id":"94911","content":"çœ‹ç€çœ¼ç†Ÿã€‚æ˜¯è¿™ä¸ªå¸–å­å—ï¼Ÿhttps:&#47;&#47;www.zhihu.com&#47;question&#47;429659943&#47;answer&#47;1569256477","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1605423599,"ip_address":"","comment_id":260020,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5899876566","product_id":100050101,"comment_content":"èƒ¡è€å¸ˆï¼Œä¸ºä»€ä¹ˆä»£ç è°ƒç”¨ ensureOffsetInRange æ–¹æ³•ç¡®ä¿è¾“å…¥å‚æ•°æœ€å¤§ä½ç§»å€¼æ˜¯åˆæ³•çš„ã€‚é‚£æ€ä¹ˆåˆ¤æ–­æ˜¯ä¸æ˜¯åˆæ³•å‘¢ï¼Ÿæ ‡å‡†å°±æ˜¯çœ‹å®ƒä¸æ—¥å¿—æ®µèµ·å§‹ä½ç§»çš„å·®å€¼æ˜¯å¦åœ¨æ•´æ•°èŒƒå›´å†…ï¼Œå³ largestOffset - baseOffset çš„å€¼æ˜¯ä¸æ˜¯ä»‹äº [0ï¼ŒInt.MAXVALUE] ä¹‹é—´ã€‚è€Œä¸æ˜¯longçš„æœ€å¤§å€¼ï¼Œoffsetä¸æ˜¯longç±»å‹çš„å—ï¼Ÿ<br>","like_count":2,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":509090,"discussion_content":"çœ‹ç€çœ¼ç†Ÿã€‚æ˜¯è¿™ä¸ªå¸–å­å—ï¼Ÿhttps://www.zhihu.com/question/429659943/answer/1569256477","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605423599,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1806720,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/91/80/bc38f890.jpg","nickname":"çå¦®â€¢ç›ä»•å¤š","note":"","ucode":"6E1E5564F979B3","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":325752,"discussion_content":"å¯¹å“’ï¼Œéƒ½æ˜¯æˆ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605423660,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":251412,"user_name":"ä¸‰é¢—è±†å­","can_delete":false,"product_type":"c1","uid":2008638,"ip_address":"","ucode":"632CE3E7563666","user_header":"https://static001.geekbang.org/account/avatar/00/1e/a6/3e/3d18f35a.jpg","comment_is_top":false,"comment_ctime":1601536516,"is_pvip":false,"replies":[{"id":"92153","content":"éå¸¸ä½©æœæ‚¨çš„é’»ç ”ç²¾ç¥ï¼å…·ä½“çš„ä¸Šä¸‹æ–‡æˆ‘ç®€å•çœ‹äº†ä¸‹ï¼Œå‘ç°äº†è¿™ä¹ˆä¸€å¥ï¼š<br>So in 5), the offset will be 2 x &#39;a&#39;. That is, we never recycle offsets. They keep increasing.<br><br>å› æ­¤ï¼Œ400ä¸‡æ˜¯è¿™ä¹ˆè®¡ç®—å¾—æ¥çš„ï¼š9223372036854775807 &#47; 1024^4 &#47; 2","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1602207736,"ip_address":"","comment_id":251412,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5896503812","product_id":100050101,"comment_content":"èƒ¡å“¥ï¼Œè¯·é—®ä¸‹offsetæ˜¯å•è°ƒé€’å¢çš„ï¼Œæˆ‘å½“æ—¶æœ‰ä¸ªç–‘é—®æ˜¯å¦‚æœæº¢å‡ºæ€ä¹ˆåŠï¼Œåæ¥çœ‹åˆ°çŸ¥ä¹ä¸Šæœ‰ä¸ªå›ç­”æ˜¯è¿™å°é‚®ä»¶æµï¼ˆhttp:&#47;&#47;mail-archives.apache.org&#47;mod_mbox&#47;kafka-users&#47;201111.mbox&#47;%3CCAFbh0Q3wXeivW9G+xre5eN8-SLVprdNLWyKmd+CcW6n=A=ZSHQ@mail.gmail.com%3Eï¼‰æåˆ°å¦‚æœæ¯å¤©å†™1TBæ•°æ®ï¼Œå¤§çº¦å¯ä»¥ç”¨400ä¸‡å¤©ï¼Œä½†æ˜¯é‚®ä»¶æ²¡æœ‰ä¸Šä¸‹æ–‡ï¼Œæ‰€ä»¥æˆ‘è‡ªå·±æŒ‰ç…§ï¼š<br>å•ä¸ªåˆ†åŒºï¼Œæ¯æ¡æ¶ˆæ¯Xå­—èŠ‚ï¼Œæ¯å¤©å†™å…¥1024*1024*1024*1024å­—èŠ‚ï¼Œå†™400ä¸‡å¤©ï¼Œæ€»å…±å†™å…¥Long.max=9223372036854775807æ¡æ¶ˆæ¯ï¼Œç®—å‡ºæ¥X=(1024*1024*1024*1024*4000000)Ã·(9223372036854775807)=0.47ï¼Œä½†æ˜¯ä¸€æ¡Kafkaæ¶ˆæ¯æœ€å°‘éƒ½è¦14å­—èŠ‚çš„ç»“æ„ï¼ˆV0æ ¼å¼ï¼‰ï¼Œæ‰€ä»¥å®ƒè¿™ä¸ª400ä¸‡å¤©æ˜¯æ€ä¹ˆç®—å‡ºæ¥çš„ï¼Œæ˜¯ä¸æ˜¯å¤ªå°‘äº†å‘¢ï¼Ÿ<br>è°¢è°¢ã€‚","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":506482,"discussion_content":"éå¸¸ä½©æœæ‚¨çš„é’»ç ”ç²¾ç¥ï¼å…·ä½“çš„ä¸Šä¸‹æ–‡æˆ‘ç®€å•çœ‹äº†ä¸‹ï¼Œå‘ç°äº†è¿™ä¹ˆä¸€å¥ï¼š\nSo in 5), the offset will be 2 x &amp;#39;a&amp;#39;. That is, we never recycle offsets. They keep increasing.\n\nå› æ­¤ï¼Œ400ä¸‡æ˜¯è¿™ä¹ˆè®¡ç®—å¾—æ¥çš„ï¼š9223372036854775807 / 1024^4 / 2","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1602207736,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":240957,"user_name":"å¼ å­æ¶µ","can_delete":false,"product_type":"c1","uid":1743397,"ip_address":"","ucode":"57C509EA32B916","user_header":"https://static001.geekbang.org/account/avatar/00/1a/9a/25/3e5e942b.jpg","comment_is_top":false,"comment_ctime":1597132672,"is_pvip":false,"replies":[{"id":"89110","content":"ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½  Kafkaçš„æ³¨é‡Šå†™å¾—å¾ˆä¸é”™ï¼Œåƒä¸‡åˆ«å¿˜è®°çœ‹","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1597213036,"ip_address":"","comment_id":240957,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5892099968","product_id":100050101,"comment_content":"* If the given offset is larger than the largest message in this segment, do nothing.      è™½ç„¶åˆšå¼€å§‹é˜…è¯»æºç ä¸æ˜¯ç‰¹åˆ«é€šç•…ï¼Œéƒ¨åˆ†ä»£ç è¿˜ä¸æ˜ç™½ä¸ºä»€ä¹ˆï¼Œä½†æ˜¯è¿™ä¸ªtruncate to æ–¹æ³•çš„æ³¨é‡Šæˆ‘çœ‹æ˜ç™½äº†ï¼Œå¦‚æœæŒ‡å®šçš„ä½ç§»å€¼ç‰¹åˆ«ç‰¹åˆ«å¤§ï¼Œè¶…è¿‡äº†æ—¥å¿—æ®µæœ¬èº«ä¿å­˜çš„æœ€å¤§ä½ç§»å€¼ï¼Œåˆ™ä»€ä¹ˆä¹Ÿä¸ä¼šåšï¼Œ do nothing : )","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":503605,"discussion_content":"ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½  Kafkaçš„æ³¨é‡Šå†™å¾—å¾ˆä¸é”™ï¼Œåƒä¸‡åˆ«å¿˜è®°çœ‹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597213036,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":211070,"user_name":"ğŸ™Šé¡¾å°é¡¾","can_delete":false,"product_type":"c1","uid":1965728,"ip_address":"","ucode":"FC7974A351586C","user_header":"https://static001.geekbang.org/account/avatar/00/1d/fe/a0/b1212e2b.jpg","comment_is_top":false,"comment_ctime":1587890995,"is_pvip":false,"replies":[{"id":"78565","content":"ç®€å•æ¥è¯´ï¼Œæ—¥å¿—æ®µå¯¹è±¡å¯èƒ½è¢«å¤šä¸ªçº¿ç¨‹æ“ä½œã€‚æ¯”å¦‚Kafkaçš„å¤šä¸ªI&#47;Oçº¿ç¨‹å°±å¯èƒ½åŒæ—¶æ“ä½œåŒä¸€ä¸ªæ—¥å¿—æ®µå¯¹è±¡ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1587951511,"ip_address":"","comment_id":211070,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5882858291","product_id":100050101,"comment_content":"maxTimestampSoFarç­‰å€¼è¢«@volatileä¿®é¥°ï¼Œä¸ºä½•è¦è¿™ä¹ˆè®¾ç½®<br>æ¯ä¸€ä¸ªtopicåˆ†åŒºå¯¹åº”ä¸€ä¸ªSegmentï¼Œè¿™ä¸ªä¼šè¢«å¤šçº¿ç¨‹çš„è®¿é—®å—ï¼Ÿæ¯”å¦‚spark streamingçš„kafkaUtil.directStream,å…¶ä¼šå‘¨æœŸæ€§çš„è·å–Kafkaä¸­æ¯ä¸ªtopicçš„æ¯ä¸ªpartitionä¸­çš„æœ€æ–°offsets,å†™å…¥çš„æ—¶å€™åº”è¯¥ä¹Ÿæ˜¯ï¼Œç†è§£èµ·æ¥åº”è¯¥æ˜¯å•çº¿ç¨‹çš„æ“ä½œ","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493187,"discussion_content":"ç®€å•æ¥è¯´ï¼Œæ—¥å¿—æ®µå¯¹è±¡å¯èƒ½è¢«å¤šä¸ªçº¿ç¨‹æ“ä½œã€‚æ¯”å¦‚Kafkaçš„å¤šä¸ªI/Oçº¿ç¨‹å°±å¯èƒ½åŒæ—¶æ“ä½œåŒä¸€ä¸ªæ—¥å¿—æ®µå¯¹è±¡ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587951511,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":210376,"user_name":"Rogerå®‡","can_delete":false,"product_type":"c1","uid":1703222,"ip_address":"","ucode":"CBA23C01409349","user_header":"https://static001.geekbang.org/account/avatar/00/19/fd/36/f947c340.jpg","comment_is_top":false,"comment_ctime":1587732092,"is_pvip":false,"replies":[{"id":"78473","content":"å¦‚æœä¸ºç©ºï¼Œåˆ™æ²¡æœ‰å¯ä»¥appendçš„äº†ï¼Œç›´æ¥ç»“æŸã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1587868273,"ip_address":"","comment_id":210376,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5882699388","product_id":100050101,"comment_content":"â€œé¦–å…ˆè°ƒç”¨ records.sizeInBytes æ–¹æ³•åˆ¤æ–­è¯¥æ—¥å¿—æ®µæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœæ˜¯ç©ºçš„è¯ï¼Œ Kafka éœ€è¦è®°å½•è¦å†™å…¥æ¶ˆæ¯é›†åˆçš„æœ€å¤§æ—¶é—´æˆ³ï¼Œå¹¶å°†å…¶ä½œä¸ºåé¢æ–°å¢æ—¥å¿—æ®µå€’è®¡æ—¶çš„ä¾æ®ã€‚â€<br>-----------------------<br>æƒ³è¯·é—®ä¸‹è€å¸ˆï¼Œè¿™æ®µçš„å¦‚æœä¸ºç©ºçš„å¤„ç†é€»è¾‘æ˜¯ä¸æ˜¯ä¸åœ¨appendä¸­å•¦ï¼Ÿif recordå¤§å°ä¸ä¸ºç©ºå°±ç»“æŸappendæ–¹æ³•å•¦ã€‚","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493008,"discussion_content":"å¦‚æœä¸ºç©ºï¼Œåˆ™æ²¡æœ‰å¯ä»¥appendçš„äº†ï¼Œç›´æ¥ç»“æŸã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587868273,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1061277,"avatar":"https://static001.geekbang.org/account/avatar/00/10/31/9d/daad92d2.jpg","nickname":"Stony.ä¿®è¡Œåƒ§","note":"","ucode":"0F2368F7D93E4A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":345452,"discussion_content":"æ˜¯ä¸æ˜¯ç¬”è¯¯å•Šâ€œé¦–å…ˆè°ƒç”¨ records.sizeInBytes æ–¹æ³•åˆ¤æ–­è¯¥æ—¥å¿—æ®µæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœæ˜¯ç©ºçš„è¯ï¼Œ Kafka éœ€è¦è®°å½•è¦å†™å…¥æ¶ˆæ¯é›†åˆçš„æœ€å¤§æ—¶é—´æˆ³ï¼Œå¹¶å°†å…¶ä½œä¸ºåé¢æ–°å¢æ—¥å¿—æ®µå€’è®¡æ—¶çš„ä¾æ®ã€‚â€\nåº”è¯¥æ”¹ä¸ºâ€œå¦‚æœä¸æ˜¯ç©ºï¼ŒKafkaéœ€è¦è®°å½•ã€‚ã€‚ã€‚ã€‚ã€‚â€œ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1611721818,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":209531,"user_name":"ç°æœº","can_delete":false,"product_type":"c1","uid":1179580,"ip_address":"","ucode":"46F6CFC2DFAA2B","user_header":"https://static001.geekbang.org/account/avatar/00/11/ff/bc/368b9f80.jpg","comment_is_top":false,"comment_ctime":1587564344,"is_pvip":false,"replies":[{"id":"78225","content":"1. magicæ˜¯æ¶ˆæ¯æ ¼å¼ç‰ˆæœ¬ï¼Œæ€»æœ‰3ä¸ªç‰ˆæœ¬ã€‚V2æ˜¯æœ€æ–°ç‰ˆæœ¬<br>2. leader epochæ˜¯controlleråˆ†é…ç»™åˆ†åŒºleaderå‰¯æœ¬çš„ç‰ˆæœ¬å·ã€‚æ¯ä¸ªæ¶ˆæ¯æ‰¹æ¬¡éƒ½è¦æœ‰å¯¹åº”çš„leader epochã€‚Kafkaä¼šè®°å½•æ¯ä¸ªåˆ†åŒºleaderä¸åŒepochå¯¹åº”çš„é¦–æ¡æ¶ˆæ¯çš„ä½ç§»ã€‚æ¯”å¦‚leader epoch=0æ—¶producerå†™å…¥äº†100æ¡æ¶ˆæ¯ï¼Œé‚£ä¹ˆcacheä¼šè®°å½•&lt;0, 0&gt;ï¼Œä¹‹åleaderå˜æ›´ï¼Œepochå¢åŠ åˆ°1ï¼Œä¹‹åproduceråˆå†™å…¥äº†200æ¡æ¶ˆæ¯ï¼Œé‚£ä¹ˆcacheä¼šè®°å½•&lt;1, 100&gt;ã€‚epochä¸»è¦ç”¨äºåšæ—¥å¿—æˆªæ–­æ—¶ä¿è¯ä¸€è‡´æ€§ç”¨çš„ï¼Œå•çº¯ä¾èµ–HWå€¼å¯èƒ½å‡ºç°å„ç§ä¸ä¸€è‡´çš„æƒ…å†µã€‚è¿™æ˜¯ç¤¾åŒºå¯¹äºHWå€¼çš„ä¸€ä¸ªä¿®æ­£æœºåˆ¶","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1587604399,"ip_address":"","comment_id":209531,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5882531640","product_id":100050101,"comment_content":"è€å¸ˆï¼Œæœ‰ä¸¤ä¸ªé—®é¢˜æƒ³è¯·æ•™ä¸€ä¸‹ï¼Œ<br>1.kafka çš„magic æˆ‘çœ‹åœ¨æºç ä¸­æœ‰ä½“ç°ï¼Œè¿™ä¸ªå…·ä½“æŒ‡ä»£kafkaç‰ˆæœ¬è¿˜æ˜¯ä»€ä¹ˆï¼Ÿ<br>2.LeaderEpochè¿™ä¸ªepoch æ˜¯ä»€ä¹ˆå«ä¹‰ï¼Ÿ åœ¨recoveræ–¹æ³•ä¸­ä¼šcache.assign batch.parittionLeaderEpoch è¿™é‡Œä¸æ˜¯å¾ˆæ‡‚ã€‚å¸Œæœ›è€å¸ˆèµæ•™ã€‚","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492824,"discussion_content":"1. magicæ˜¯æ¶ˆæ¯æ ¼å¼ç‰ˆæœ¬ï¼Œæ€»æœ‰3ä¸ªç‰ˆæœ¬ã€‚V2æ˜¯æœ€æ–°ç‰ˆæœ¬\n2. leader epochæ˜¯controlleråˆ†é…ç»™åˆ†åŒºleaderå‰¯æœ¬çš„ç‰ˆæœ¬å·ã€‚æ¯ä¸ªæ¶ˆæ¯æ‰¹æ¬¡éƒ½è¦æœ‰å¯¹åº”çš„leader epochã€‚Kafkaä¼šè®°å½•æ¯ä¸ªåˆ†åŒºleaderä¸åŒepochå¯¹åº”çš„é¦–æ¡æ¶ˆæ¯çš„ä½ç§»ã€‚æ¯”å¦‚leader epoch=0æ—¶producerå†™å…¥äº†100æ¡æ¶ˆæ¯ï¼Œé‚£ä¹ˆcacheä¼šè®°å½•&amp;lt;0, 0&amp;gt;ï¼Œä¹‹åleaderå˜æ›´ï¼Œepochå¢åŠ åˆ°1ï¼Œä¹‹åproduceråˆå†™å…¥äº†200æ¡æ¶ˆæ¯ï¼Œé‚£ä¹ˆcacheä¼šè®°å½•&amp;lt;1, 100&amp;gt;ã€‚epochä¸»è¦ç”¨äºåšæ—¥å¿—æˆªæ–­æ—¶ä¿è¯ä¸€è‡´æ€§ç”¨çš„ï¼Œå•çº¯ä¾èµ–HWå€¼å¯èƒ½å‡ºç°å„ç§ä¸ä¸€è‡´çš„æƒ…å†µã€‚è¿™æ˜¯ç¤¾åŒºå¯¹äºHWå€¼çš„ä¸€ä¸ªä¿®æ­£æœºåˆ¶","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587604399,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":208176,"user_name":"å¼ ç®ç£Šæƒ³é™é™","can_delete":false,"product_type":"c1","uid":1084732,"ip_address":"","ucode":"2E582ED7BB178E","user_header":"https://static001.geekbang.org/account/avatar/00/10/8d/3c/9025c2ca.jpg","comment_is_top":false,"comment_ctime":1587291570,"is_pvip":true,"replies":[{"id":"77762","content":"ä¸ºæŸä¸ªå…·æœ‰å¤§é‡åˆ†åŒºçš„ä¸»é¢˜è®¾ç½®äº†segment.mså‚æ•°ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1587307720,"ip_address":"","comment_id":208176,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5882258866","product_id":100050101,"comment_content":"è€å¸ˆå¼€å§‹è¯´çš„æ‚¨å…¬å¸ç¢°åˆ°è¿‡å¤§é¢ç§¯æ—¥å¿—æ®µåŒæ—¶é—´åˆ‡åˆ†çš„çº¿ä¸Šé—®é¢˜ï¼Œè¿˜æ˜¯æœ‰ç‚¹ä¸å¤ªæ˜ç™½ï¼Œä»€ä¹ˆæƒ…å†µä¼šå‡ºç°è¿™æ ·çš„ç°è±¡","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492369,"discussion_content":"ä¸ºæŸä¸ªå…·æœ‰å¤§é‡åˆ†åŒºçš„ä¸»é¢˜è®¾ç½®äº†segment.mså‚æ•°ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587307720,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1188023,"avatar":"https://static001.geekbang.org/account/avatar/00/12/20/b7/bdb3bcf0.jpg","nickname":"Eternal","note":"","ucode":"EA6FE7CC98F740","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":240525,"discussion_content":"@å¼ ç®ç£Šæƒ³é™é™\nåœ¨brokerç«¯è®¾ç½®ï¼Œsegment.msï¼šå³ä½¿logçš„åˆ†å—æ–‡ä»¶æ²¡æœ‰è¾¾åˆ°éœ€è¦åˆ é™¤ã€å‹ç¼©çš„å¤§å°ï¼Œä¸€æ—¦log çš„æ—¶é—´è¾¾åˆ°è¿™ä¸ªä¸Šé™ï¼Œå°±ä¼šå¼ºåˆ¶æ–°å»ºä¸€ä¸ªlogåˆ†å—æ–‡ä»¶ï¼›é»˜è®¤è®¾ç½®çš„æ˜¯7å¤©","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587371581,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":206986,"user_name":"æ›¾è½¼éºŸ","can_delete":false,"product_type":"c1","uid":1451391,"ip_address":"","ucode":"D418371AC11270","user_header":"https://static001.geekbang.org/account/avatar/00/16/25/7f/473d5a77.jpg","comment_is_top":false,"comment_ctime":1586969029,"is_pvip":false,"replies":[{"id":"77303","content":"FileRecordså’ŒMemoryRecordsæ˜¯éå¸¸é‡è¦çš„ä¸¤ä¸ªç±»ï¼Œæˆ‘å»ºè®®å¥½å¥½ç ”è¯»ä¸‹ï¼šï¼‰","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1587000715,"ip_address":"","comment_id":206986,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5881936325","product_id":100050101,"comment_content":"ä»Šå¤©é˜…è¯»æºç å‘ç°æ”¶ç›Šè‰¯å¤šï¼Œå…ˆå›ç­”è€å¸ˆçš„é—®é¢˜ï¼Œå¦‚æœè¶…è¿‡äº†æ—¥å¿—æ®µæœ¬èº«ä¿å­˜çš„æœ€å¤§ä½ç§»å€¼æˆ–è€…targetSizeå°äº0ï¼ˆæ€€ç–‘æ˜¯æº¢å‡ºï¼‰ï¼Œä¼šæŠ›å‡ºä¸€ä¸ªKafkaExceptionæ¥ä¸­æ–­ç¨‹åºæ‰§è¡Œã€‚<br><br>å…¶æ¬¡æˆ‘å‘ç°readæ–¹æ³•æåˆ°çš„ï¼šmaxSizeï¼ŒmaxPositionï¼ŒminOneMessageå‡ ä¸ªå‚æ•°ï¼Œåˆšå¥½å¯ç”¨å¯¹åº”ä¸Šäº†kafka-clientsæ¶ˆè´¹è€…çš„é…ç½®é¡¹ï¼šmax.poll.recordsï¼Œmax.partition.fetch.bytesã€‚å…¶ä¸­kafkaå®˜æ–¹çš„apiä¸­ä¹Ÿæåˆ°KafkaConsumer.poll()æ–¹æ³•åœ¨ä¸»åŠ¨æ‹‰å–çš„æ—¶å€™ï¼Œå¦‚æœå•æ¡æ¶ˆæ¯è¶…è¿‡æœ€å¤§å€¼èƒ½ä¿è¯è‡³å°‘è¿”å›ä¸€æ¡æ¶ˆæ¯ï¼Œä¹Ÿå°±æ˜¯è€å¸ˆæåˆ°çš„æ¶ˆè´¹è€…é¥¥é¥¿çš„æƒ…å†µã€‚<br><br>åŒæ—¶æˆ‘å‘ç°kafkaé‡Œé¢å­˜åœ¨ç€Recordsæ¥å£å…¶å¯¹åº”å¤šç§è®°å½•ç±»å‹æ¯”å¦‚FileRecordsï¼ŒMemoryRecordsç­‰ç­‰é¡ºç€è¿™ä¸ªåº”è¯¥å¯ä»¥å‘ç°æ¶ˆæ¯çš„å„ç§å½¢æ€ã€‚è€Œä¸”åœ¨FileRecordsä¸­ä½¿ç”¨äº†JDKæä¾›çš„FileChannelï¼ŒFileChannelæ˜¯å¯ä»¥å®ç°0æ‹·è´æŠ€æœ¯çš„","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":491972,"discussion_content":"FileRecordså’ŒMemoryRecordsæ˜¯éå¸¸é‡è¦çš„ä¸¤ä¸ªç±»ï¼Œæˆ‘å»ºè®®å¥½å¥½ç ”è¯»ä¸‹ï¼šï¼‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587000715,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1399488,"avatar":"https://static001.geekbang.org/account/avatar/00/15/5a/c0/e20eb855.jpg","nickname":"Tomcat","note":"","ucode":"58A9D44991EDB7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":249453,"discussion_content":"æ‚¨å¥½ï¼Œæˆ‘æ˜¯ä¸€ä¸ªkafkaåˆå­¦è€…ï¼Œå¦‚æœæŠŠminOneMessageè®¾ç½®ä¸ºflaseäº†ï¼Œå¹¶ä¸”å•æ¡æ¶ˆæ¯ä½“ä¹Ÿå¤§äºå¯è¯»å–çš„æœ€å¤§å€¼ä¹‹åï¼Œä»æ–‡ç« ä¸­çš„æºç çœ‹ï¼Œå¦‚æœæ—¥å¿—æ®µé•¿åº¦ä¸å¤Ÿçš„è¯ï¼Œå®ƒä¼šè¯»åˆ°æ—¥å¿—æ®µç»“å°¾ï¼Œé‚£å¯ä»¥ä¿è¯å®ƒæ˜¯ä¸€æ¡å®Œæ•´çš„æ¶ˆæ¯å—ï¼Ÿè¿˜æ˜¯ä¼šæŠ›å‡ºå¼‚å¸¸","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587923091,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":206860,"user_name":"jeffery","can_delete":false,"product_type":"c1","uid":1219972,"ip_address":"","ucode":"35E2DAA386FB86","user_header":"https://static001.geekbang.org/account/avatar/00/12/9d/84/171b2221.jpg","comment_is_top":false,"comment_ctime":1586945876,"is_pvip":false,"replies":[{"id":"77318","content":"Javaè¯­è¨€åŸºç¡€æ˜¯å¿…éœ€çš„ï¼ŒScalaæ— éœ€å¤ªå¤šåŸºç¡€ã€‚ä¸€ä¸ªæ¯”è¾ƒå¥½çš„ç»éªŒæ˜¯å¤šè¯»æºç æ³¨é‡Š+æµ‹è¯•ç”¨ä¾‹ã€‚<br><br>æµ‹è¯•ç”¨ä¾‹ä»£ç ç®€å•ï¼Œè€Œä¸”å¯¹äºæºç è§£é‡Šæ˜¯ç›´æ¥çš„","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1587003136,"ip_address":"","comment_id":206860,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5881913172","product_id":100050101,"comment_content":"æ²¡æœ‰è¯­è¨€åŸºç¡€æ€ä¹ˆå¼¯é“è¶…è½¦æ’¸æºç ï¼Œèƒ½åˆ†äº«ä¸‹ç»éªŒå—ï¼Ÿå†æ­¤è°¢è¿‡äº†","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":491926,"discussion_content":"Javaè¯­è¨€åŸºç¡€æ˜¯å¿…éœ€çš„ï¼ŒScalaæ— éœ€å¤ªå¤šåŸºç¡€ã€‚ä¸€ä¸ªæ¯”è¾ƒå¥½çš„ç»éªŒæ˜¯å¤šè¯»æºç æ³¨é‡Š+æµ‹è¯•ç”¨ä¾‹ã€‚\n\næµ‹è¯•ç”¨ä¾‹ä»£ç ç®€å•ï¼Œè€Œä¸”å¯¹äºæºç è§£é‡Šæ˜¯ç›´æ¥çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587003136,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1188023,"avatar":"https://static001.geekbang.org/account/avatar/00/12/20/b7/bdb3bcf0.jpg","nickname":"Eternal","note":"","ucode":"EA6FE7CC98F740","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":240523,"discussion_content":"ä»¥å‰æ²¡æœ‰å…³æ³¨åˆ°æµ‹è¯•ç”¨ä¾‹è¿™ä¸ªç‚¹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587371385,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":206809,"user_name":"ä¸€æ­¥","can_delete":false,"product_type":"c1","uid":1005391,"ip_address":"","ucode":"73CEA468CE70C3","user_header":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","comment_is_top":false,"comment_ctime":1586939188,"is_pvip":true,"replies":[{"id":"77320","content":"ä¹Ÿå¯ä»¥çš„ã€‚å¾ˆå¤šJavaå·¥ç¨‹å¸ˆéƒ½æ˜¯ç›´æ¥æ’¸Tomcatæºç ï¼Œå³ä½¿æ²¡æœ‰ç”¨è¿‡ã€‚åªè¦æ˜¯ä¼˜ç§€çš„æ¡†æ¶ä»£ç éƒ½æœ‰å­¦ä¹ çš„ä»·å€¼ï¼šï¼‰","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1587003213,"ip_address":"","comment_id":206809,"utype":1}],"discussion_count":1,"race_medal":1,"score":"5881906484","product_id":100050101,"comment_content":"ç›®å‰æ²¡æœ‰ç”¨è¿‡ kafka ,ä¸€ä¸Šæ¥å°±æºç è¿™æ ·çœŸçš„å¥½å—ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":491910,"discussion_content":"ä¹Ÿå¯ä»¥çš„ã€‚å¾ˆå¤šJavaå·¥ç¨‹å¸ˆéƒ½æ˜¯ç›´æ¥æ’¸Tomcatæºç ï¼Œå³ä½¿æ²¡æœ‰ç”¨è¿‡ã€‚åªè¦æ˜¯ä¼˜ç§€çš„æ¡†æ¶ä»£ç éƒ½æœ‰å­¦ä¹ çš„ä»·å€¼ï¼šï¼‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587003213,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":206292,"user_name":"xinxin","can_delete":false,"product_type":"c1","uid":1285617,"ip_address":"","ucode":"52C5D688B10968","user_header":"https://static001.geekbang.org/account/avatar/00/13/9d/f1/05da9c09.jpg","comment_is_top":false,"comment_ctime":1586835648,"is_pvip":false,"replies":[{"id":"77345","content":"è°¢è°¢é¼“åŠ±ï¼Œä¸€èµ·åŠ æ²¹","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1587004937,"ip_address":"","comment_id":206292,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5881802944","product_id":100050101,"comment_content":"å­¦ä¹ äº†ï¼Œå¾ˆæ£’çš„æºç è¯¾ç¨‹","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":491743,"discussion_content":"è°¢è°¢é¼“åŠ±ï¼Œä¸€èµ·åŠ æ²¹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587004937,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":206186,"user_name":"æ¯å¤©æ™’ç™½ç‰™","can_delete":false,"product_type":"c1","uid":1004698,"ip_address":"","ucode":"A1B102CD933DEA","user_header":"https://static001.geekbang.org/account/avatar/00/0f/54/9a/76c0af70.jpg","comment_is_top":false,"comment_ctime":1586820041,"is_pvip":false,"replies":[{"id":"77002","content":"å¯†åº¦å¤§æ˜¯å¥½äº‹ï¼Œè¯´æ˜è®²çš„ä¸ç®—å¤ªå®½æ³›ï¼šï¼‰","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1586828882,"ip_address":"","comment_id":206186,"utype":1}],"discussion_count":1,"race_medal":1,"score":"5881787337","product_id":100050101,"comment_content":"æ–‡ç« çŸ¥è¯†å¯†åº¦å¤§","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":491704,"discussion_content":"å¯†åº¦å¤§æ˜¯å¥½äº‹ï¼Œè¯´æ˜è®²çš„ä¸ç®—å¤ªå®½æ³›ï¼šï¼‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586828882,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":355452,"user_name":"freesocean","can_delete":false,"product_type":"c1","uid":1529210,"ip_address":"ä¸­å›½é¦™æ¸¯","ucode":"CAD4C80CF569D3","user_header":"https://static001.geekbang.org/account/avatar/00/17/55/7a/d44df1d6.jpg","comment_is_top":false,"comment_ctime":1661398310,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1661398310","product_id":100050101,"comment_content":"è¯¾åæ€è€ƒï¼Œçœ‹äº†truncateToæºç ï¼Œè¯¥æ–¹æ³•æ³¨é‡Šå…¶å®è¯´çš„å¾ˆæ¸…æ¥š<br>1.è¯¥æ–¹æ³•ä¸ä¼šæ£€æŸ¥ä¼ å…¥å‚æ•°çš„è¾¹ç•Œé—®é¢˜<br>2.åªæœ‰å½“targetSize å°äºåº•å±‚FileChannel å¤§å°æ‰ä¼šæˆªæ–­<br>å…·ä½“ä»£ç ä¹Ÿå¾ˆå¥½ç†è§£ï¼šå¦‚æœä¸åœ¨èŒƒå›´å†…ï¼Œç›´æ¥æŠ›å¼‚å¸¸<br> if (targetSize &gt; originalSize || targetSize &lt; 0)<br>            throw new KafkaException(&quot;Attempt to truncate log segment &quot; + file + &quot; to &quot; + targetSize + &quot; bytes failed, &quot; +<br>                    &quot; size of this log segment is &quot; + originalSize + &quot; bytes.&quot;);","like_count":0},{"had_liked":false,"id":346418,"user_name":"æ¸…é£","can_delete":false,"product_type":"c1","uid":1542078,"ip_address":"","ucode":"AB2D169746BC23","user_header":"https://static001.geekbang.org/account/avatar/00/17/87/be/7466bf26.jpg","comment_is_top":false,"comment_ctime":1653124261,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1653124261","product_id":100050101,"comment_content":"æ‰€ä»¥ï¼Œç½‘ä¸Šè¯´ä»ç¬¬äºŒä¸ªæ˜¯segmentå¼€å§‹ï¼Œæ¯ä¸ªsegmentæ–‡ä»¶çš„åå­—æ˜¯ä¸Šä¸€ä¸ªsegment<br>çš„æœ€åä¸€æ¡æ¶ˆæ¯çš„ä½ç§»å€¼ï¼Œéƒ½æ˜¯èƒ¡æ‰¯ï¼Œè¿™æ ·è¯´å°±æ˜¯æ²¡æœ‰ç†è§£baseoffsetçš„æ„ä¹‰ï¼Œä¹Ÿæ²¡æœ‰çœ‹å®˜æ–¹æ–‡æ¡£ï¼Œä¹Ÿæ²¡æœ‰çœŸæ­£çš„å®æ“","like_count":0},{"had_liked":false,"id":318346,"user_name":"å¡å·´æ–¯å¦","can_delete":false,"product_type":"c1","uid":2721187,"ip_address":"","ucode":"5FEECDD3837B41","user_header":"https://static001.geekbang.org/account/avatar/00/29/85/a3/46648484.jpg","comment_is_top":false,"comment_ctime":1635251449,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1635251449","product_id":100050101,"comment_content":"æˆ‘æƒ³é—®ä¸ªé—®é¢˜ï¼Œåœ¨æ¶ˆè´¹è¿‡ç¨‹äº‹åŠ¡æ¯”è¾ƒé•¿ï¼ŒKafkaå‡ºç°ä¸€ä¸ªé—®é¢˜ï¼Œåå¤æ¶ˆè´¹é™·å…¥å¾ªç¯ï¼Œæœ‰å»ºè®®çš„æ–¹æ¡ˆä¹ˆï¼Ÿ<br>","like_count":0},{"had_liked":false,"id":315329,"user_name":"huolang","can_delete":false,"product_type":"c1","uid":1346708,"ip_address":"","ucode":"FDC4A6B6151C5E","user_header":"https://static001.geekbang.org/account/avatar/00/14/8c/94/5282994c.jpg","comment_is_top":false,"comment_ctime":1633835256,"is_pvip":false,"replies":[{"id":"114433","content":"ç»å¤§éƒ¨åˆ†æ—¶é—´ä¸¤è€…æ˜¯ç›¸åŒçš„","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1634004303,"ip_address":"","comment_id":315329,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1633835256","product_id":100050101,"comment_content":"è€å¸ˆï¼Œappendæ–¹æ³•ä¸­çš„largestOffsetå’ŒshallowOffsetOfMaxTimestampæœ‰ä»€ä¹ˆä¸åŒï¼Ÿæœ€å¤§ä½ç§»çš„æ¶ˆæ¯å¯¹åº”çš„æ—¶é—´æˆ³ä¸æ˜¯æœ€å¤§çš„å—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527936,"discussion_content":"ç»å¤§éƒ¨åˆ†æ—¶é—´ä¸¤è€…æ˜¯ç›¸åŒçš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634004303,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":314108,"user_name":"å‚»å‚»çš„å¸…","can_delete":false,"product_type":"c1","uid":1668617,"ip_address":"","ucode":"14A795523A682E","user_header":"https://static001.geekbang.org/account/avatar/00/19/76/09/62a10668.jpg","comment_is_top":false,"comment_ctime":1632840538,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1632840538","product_id":100050101,"comment_content":"If the given offset is larger than the largest message in this segment, do nothing.","like_count":0},{"had_liked":false,"id":294387,"user_name":"é»„æŒ¯æ¸¸","can_delete":false,"product_type":"c1","uid":1858989,"ip_address":"","ucode":"3927C81CAEDBE2","user_header":"","comment_is_top":false,"comment_ctime":1621924255,"is_pvip":false,"replies":[{"id":"107172","content":"è¿™ä¸ªæ˜¯å†™æ–°çš„ç´¢å¼•é¡¹","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1622353688,"ip_address":"","comment_id":294387,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1621924255","product_id":100050101,"comment_content":"bytesSinceLastIndexEntry &gt; indexIntervalBytes æ—¶æ˜¯ä¸æ˜¯éœ€è¦åˆ›å»ºæ–°çš„æ—¥å¿—æ–‡ä»¶äº†ï¼Œä½†åœ¨è¿™ä¹‹å‰è®°å½•å·²ç»log.append(records)ã€‚æ²¡å¤ªæ˜ç™½ï¼Œéº»çƒ¦è€å¸ˆè§£ç­”ä¸‹ã€‚","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":520633,"discussion_content":"è¿™ä¸ªæ˜¯å†™æ–°çš„ç´¢å¼•é¡¹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1622353688,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":292477,"user_name":"QAQ","can_delete":false,"product_type":"c1","uid":2307937,"ip_address":"","ucode":"6E47215CBB81F5","user_header":"https://static001.geekbang.org/account/avatar/00/23/37/61/51e10a30.jpg","comment_is_top":false,"comment_ctime":1620834525,"is_pvip":false,"replies":[{"id":"106082","content":"appendè¿‡ç¨‹ä¸­å°±ä¼šåˆ¤æ–­æ˜¯å¦éœ€è¦roll out","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1621146055,"ip_address":"","comment_id":292477,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1620834525","product_id":100050101,"comment_content":"è€å¸ˆï¼Œä½ å¥½ï¼Œè¿™é‡Œä¸€ç›´è¿›è¡Œappendæ’å…¥æ—¥å¿—æ“ä½œï¼Œä»€ä¹ˆæƒ…å†µä¸‹åº”è¯¥ç”Ÿæˆä¸€ä¸ªæ–°çš„æ®µå‘¢ï¼Ÿæ€»ä¸è‡³äºä¸€ä¸ªæ–‡ä»¶æ— é™å¤§ï¼Œé‚£ä¹Ÿä¸æ–¹ä¾¿æ–‡ä»¶æ•°æ®çš„è¿‡æœŸåˆ é™¤","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":519845,"discussion_content":"appendè¿‡ç¨‹ä¸­å°±ä¼šåˆ¤æ–­æ˜¯å¦éœ€è¦roll out","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621146055,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":288585,"user_name":"é‚€æœˆå¯¹å½±","can_delete":false,"product_type":"c1","uid":1204313,"ip_address":"","ucode":"A3482EDF73EB0D","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/QicTra5HbNEwGxeG49XibcUibB82I2hpBnp8tviaiaicvFAojuMtRiaLCyl6syzzoS546H2hJibNAQ3h9XM097iapiaamcEQ/132","comment_is_top":false,"comment_ctime":1618551851,"is_pvip":false,"replies":[{"id":"105290","content":"ä¸ªäººæ„Ÿè§‰å½±å“ä¸å¤§","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1619600122,"ip_address":"","comment_id":288585,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1618551851","product_id":100050101,"comment_content":"è€å¸ˆï¼Œæƒ³é—®ä¸‹appendæ–¹æ³•çš„ç¬¬24è¡Œä»£ç offsetIndex.append(largestOffset, physicalPosition) è¿™ä¸ªåœ°æ–¹largestOffsetå¯¹åº”çš„ç‰©ç†åœ°å€physicalPositionä¸ºå•¥æ˜¯è¿½åŠ æ¶ˆæ¯ä¹‹å‰çš„åœ°å€ï¼Œè€Œä¸æ˜¯æ¶ˆæ¯è¿½åŠ ä¹‹åçš„åœ°å€å‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":518674,"discussion_content":"ä¸ªäººæ„Ÿè§‰å½±å“ä¸å¤§","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619600122,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":283879,"user_name":"è‚–æ’","can_delete":false,"product_type":"c1","uid":1861000,"ip_address":"","ucode":"50B1118691B222","user_header":"","comment_is_top":false,"comment_ctime":1615970964,"is_pvip":false,"replies":[{"id":"103539","content":"é€šå¸¸éƒ½æ˜¯<br>","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1616722048,"ip_address":"","comment_id":283879,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1615970964","product_id":100050101,"comment_content":"è¯·æ•™ä¸‹ï¼Œæœ€å¤§æ—¶é—´å¯¹åº”çš„ offset æ˜¯å¦æ˜¯è¿™ä¸€æ‰¹æ¬¡æ¶ˆæ¯ä¸­æœ€å¤§çš„ offset äº†ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":517171,"discussion_content":"é€šå¸¸éƒ½æ˜¯\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1616722048,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":280657,"user_name":"Geek_198fea","can_delete":false,"product_type":"c1","uid":2446899,"ip_address":"","ucode":"094A1837F4F4FC","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/tANdoqYOVToHzTGNooHaWKotbZLKwIpcvg47edEbH6cRHQF5GZtm8Ay66MVA8YgxU5Z5XcFkibt1h2iadP288m9g/132","comment_is_top":false,"comment_ctime":1614306878,"is_pvip":false,"replies":[{"id":"102236","content":"LogSegmentçš„append readå°±æ˜¯è´Ÿè´£å‘.logè¯»å†™æ–‡ä»¶çš„","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1614822336,"ip_address":"","comment_id":280657,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1614306878","product_id":100050101,"comment_content":"å¤§ä½¬ä½ å¥½ï¼Œæˆ‘æƒ³é—®ä¸€ä¸‹ï¼Œå°±LogSegment.scalaä¸­çš„appendå’Œreadæ–¹æ³•ï¼Œåœ¨Log.scalaä¹Ÿæœ‰åŒæ ·çš„æ–¹æ³•ï¼Œè€Œåœ¨ç‰©ç†ç£ç›˜ä¸­ï¼Œpartitionå°±æ˜¯å¯¹äºä¸åŒç›®å½•ï¼ŒLogSegment(æ˜¯æŠŠ.index.logç­‰æ–‡ä»¶åˆèµ·æ¥å«è¿™ä¸ªåå­—å˜›)åŒ…å«äº†.index,.logç­‰æ–‡ä»¶ï¼Œé‚£ä¹ˆ.logï¼Œ.indexæ–‡ä»¶ä¸­çš„æ•°æ®è¯»å†™æ˜¯ç”±é‚£å—çš„æºç è´Ÿè´£çš„å‘¢ï¼ŸLogSegmentçš„append,readæ–¹æ³•å®ç°çš„åˆæ˜¯é‚£å—çš„è¯»å†™åŠŸèƒ½å‘¢ã€‚","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":516170,"discussion_content":"LogSegmentçš„append readå°±æ˜¯è´Ÿè´£å‘.logè¯»å†™æ–‡ä»¶çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1614822336,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":271043,"user_name":"æ˜¯ç”·äººå°±å¼€å·´å·´æ‰˜æ–¯","can_delete":false,"product_type":"c1","uid":1352006,"ip_address":"","ucode":"C65873BBB28D05","user_header":"https://static001.geekbang.org/account/avatar/00/14/a1/46/3136ac25.jpg","comment_is_top":false,"comment_ctime":1609380613,"is_pvip":false,"replies":[{"id":"98422","content":"readæ–¹æ³•ä¼šè¯»å–åº•å±‚æ¶ˆæ¯ï¼Œå®ƒæ˜¯è°ƒç”¨ä½ è¯´çš„é‚£ä¸ªæ–¹æ³•æ¥å®ç°çš„ï¼Œç®—æ˜¯ä¸ªä¸Šå±‚æ–¹æ³•æŠŠï¼šï¼‰","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1609721553,"ip_address":"","comment_id":271043,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1609380613","product_id":100050101,"comment_content":"read æ–¹æ³•ä¼¼ä¹å¹¶ä¸çœŸæ­£è¯»å–æ¶ˆæ¯ï¼Œ åªæŠŠè¦è¯»å–æ‰€æœ‰åˆ†åŒºçš„æ–‡ä»¶åï¼Œ èµ·å§‹ä½ç§»ï¼Œ è¯»å–é•¿åº¦å°è£…æˆresponseï¼Œç„¶åäº¤ç»™ SocketServerçš„processorå»å®Œæˆå®é™…çš„FileChannel-&gt;SocketChannelçš„zerocopy.<br>è€å¸ˆå¸®çœ‹çœ‹æ˜¯ä¸æ˜¯è¿™æ ·","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":512826,"discussion_content":"readæ–¹æ³•ä¼šè¯»å–åº•å±‚æ¶ˆæ¯ï¼Œå®ƒæ˜¯è°ƒç”¨ä½ è¯´çš„é‚£ä¸ªæ–¹æ³•æ¥å®ç°çš„ï¼Œç®—æ˜¯ä¸ªä¸Šå±‚æ–¹æ³•æŠŠï¼šï¼‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609721553,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":268528,"user_name":"Shane_ãƒŸæœ¨","can_delete":false,"product_type":"c1","uid":1537249,"ip_address":"","ucode":"01396B247CC8D8","user_header":"https://static001.geekbang.org/account/avatar/00/17/74/e1/623ff8d8.jpg","comment_is_top":false,"comment_ctime":1608249274,"is_pvip":false,"replies":[{"id":"97816","content":"æ€»å­—èŠ‚æ•°ä¿¡æ¯æ˜¯å•ç‹¬ä¿å­˜çš„ä¸€ä¸ªæ•°æ®ï¼Œè¿™é‡Œæ¯”è¾ƒçš„ç›®çš„æ˜¯å°†ä¸¤è€…çš„æ•°å€¼å¯¹é½ã€‚æ€»å­—èŠ‚æ•°ä¸ä¸€å®šæ˜¯çœŸå®æ­£ç¡®çš„ï¼Œä¸€åˆ‡ä»¥çœŸå®ç´¯åŠ èµ·æ¥çš„æ•°æ®ä¸ºå‡†ã€‚<br><br>æˆªæ–­å°±æ˜¯ç›´æ¥è°ƒæ•´ç‰©ç†æ–‡ä»¶ä½ç½®ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1608775400,"ip_address":"","comment_id":268528,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1608249274","product_id":100050101,"comment_content":"recoveræœ€åæ—¥å¿—æˆªæ–­æ²¡å¤ªçœ‹æ‡‚<br><br>&quot;å‰è€…æ¯”åè€…å¤§&quot;æ„æ€æ˜¯æ—¥å¿—æ®µæ€»å¤§å°æ¯”ç´¯åŠ å€¼å¤§ï¼Ÿç´¯åŠ ä¸æ˜¯ç”¨æ—¥å¿—ä¿¡æ¯åˆšåˆšéå†è®¡ç®—çš„å—ï¼Ÿä¸ºå•¥è¿˜ä¼šä¸ä¸€æ ·ï¼Ÿ<br><br>å¦‚æœç´¯åŠ æ¯”çœŸå®å°ï¼Œé‚£ä¸ºå•¥è¿˜æˆªæ–­ï¼Ÿå…·ä½“æ€ä¹ˆæˆªæ–­ï¼Ÿç´¢å¼•æˆªæ–­ä¹Ÿä¸å¤ªæ˜ç™½","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":511958,"discussion_content":"æ€»å­—èŠ‚æ•°ä¿¡æ¯æ˜¯å•ç‹¬ä¿å­˜çš„ä¸€ä¸ªæ•°æ®ï¼Œè¿™é‡Œæ¯”è¾ƒçš„ç›®çš„æ˜¯å°†ä¸¤è€…çš„æ•°å€¼å¯¹é½ã€‚æ€»å­—èŠ‚æ•°ä¸ä¸€å®šæ˜¯çœŸå®æ­£ç¡®çš„ï¼Œä¸€åˆ‡ä»¥çœŸå®ç´¯åŠ èµ·æ¥çš„æ•°æ®ä¸ºå‡†ã€‚\n\næˆªæ–­å°±æ˜¯ç›´æ¥è°ƒæ•´ç‰©ç†æ–‡ä»¶ä½ç½®ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608775400,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":268521,"user_name":"Shane_ãƒŸæœ¨","can_delete":false,"product_type":"c1","uid":1537249,"ip_address":"","ucode":"01396B247CC8D8","user_header":"https://static001.geekbang.org/account/avatar/00/17/74/e1/623ff8d8.jpg","comment_is_top":false,"comment_ctime":1608247343,"is_pvip":false,"replies":[{"id":"97592","content":"1. å¯¹çš„<br>2. åªæ˜¯æŸ¥æ‰¾ä¸€ä¸ªèµ·å§‹è¯»å–ç‚¹ã€‚ä¸ä¸€å®šéè¦æ˜¯é‚£æ¡æ¶ˆæ¯æœ¬èº«","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1608516810,"ip_address":"","comment_id":268521,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1608247343","product_id":100050101,"comment_content":"è€å¸ˆ æˆ‘æœ‰ä¸¤ä¸ªé—®é¢˜<br>1ï¼Œæ—¶æˆ³ç´¢å¼•ä¿å­˜æ—¶æˆ³å’Œä½ç§»çš„å…³ç³»ï¼Œ é‚£ä½ç§»ç´¢å¼•æ˜¯ä½ç§»å’Œç‰©ç†ä½ç½®çš„å¯¹æ€§å…³ç³»å—ï¼Ÿ<br>2ï¼Œï¼4kæ‰å†™ä½ç§»ç´¢å¼•ï¼ŒæŸ¥æ‰¾çš„æ—¶å€™æ€ä¹ˆç”¨ï¼ŸæŒ‰ä½ç§»å°±è¿‘ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":511956,"discussion_content":"1. å¯¹çš„\n2. åªæ˜¯æŸ¥æ‰¾ä¸€ä¸ªèµ·å§‹è¯»å–ç‚¹ã€‚ä¸ä¸€å®šéè¦æ˜¯é‚£æ¡æ¶ˆæ¯æœ¬èº«","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608516810,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":258103,"user_name":"flyCoder","can_delete":false,"product_type":"c1","uid":1074897,"ip_address":"","ucode":"82FB7B60775978","user_header":"https://static001.geekbang.org/account/avatar/00/10/66/d1/8664c464.jpg","comment_is_top":false,"comment_ctime":1604299317,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1604299317","product_id":100050101,"comment_content":"æˆªå–åˆ°  val slot = largestLowerBoundSlotFor(idx, offset, IndexSearchType.KEY) +1","like_count":0},{"had_liked":false,"id":257716,"user_name":"flyCoder","can_delete":false,"product_type":"c1","uid":1074897,"ip_address":"","ucode":"82FB7B60775978","user_header":"https://static001.geekbang.org/account/avatar/00/10/66/d1/8664c464.jpg","comment_is_top":false,"comment_ctime":1604075934,"is_pvip":true,"replies":[{"id":"93967","content":"privateå’ŒJavaä¸­çš„privateæ˜¯ç±»ä¼¼çš„ï¼Œåé¢çš„[log]è¡¨ç¤ºå®ƒè™½ç„¶æ˜¯privateï¼Œä½†æ˜¯åœ¨logåŒ…ä¸­å¯è§ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1604283472,"ip_address":"","comment_id":257716,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1604075934","product_id":100050101,"comment_content":"class LogSegment åé¢è·Ÿ private[log]  æ˜¯scala çš„ä»€ä¹ˆè¯­æ³•?ï¼Œè¿˜æœ‰def translateOffsetå‰é¢è·Ÿprivate[log] çš„è¯­æ³•ï¼Œæ²¡æ€ä¹ˆçœ‹æ‡‚","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":508427,"discussion_content":"privateå’ŒJavaä¸­çš„privateæ˜¯ç±»ä¼¼çš„ï¼Œåé¢çš„[log]è¡¨ç¤ºå®ƒè™½ç„¶æ˜¯privateï¼Œä½†æ˜¯åœ¨logåŒ…ä¸­å¯è§ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604283472,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":251409,"user_name":"ä¸‰é¢—è±†å­","can_delete":false,"product_type":"c1","uid":2008638,"ip_address":"","ucode":"632CE3E7563666","user_header":"https://static001.geekbang.org/account/avatar/00/1e/a6/3e/3d18f35a.jpg","comment_is_top":false,"comment_ctime":1601532629,"is_pvip":false,"replies":[{"id":"92154","content":"å…·ä½“çš„åŸå› ä¸å¾—çŸ¥ï¼Œä¹Ÿè®¸å°±æ˜¯ä¸€ç§ä¿å®ˆçš„åšæ³•ï¼šï¼‰ ","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1602208087,"ip_address":"","comment_id":251409,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1601532629","product_id":100050101,"comment_content":"è¯·é—®ä¸€ä¸‹Kafkaçš„æ–‡ä»¶ä¸ºä»€ä¹ˆè¦åšå·¦ä¾§è¡¥é›¶çš„è®¾è®¡å‘¢ï¼Ÿ<br>å¦å¤–ï¼Œä¸ºä»€ä¹ˆæ˜¯20ä½å‘¢ï¼Œoffsetæœ€å¤§æ˜¯Long.MAX_VALUE=9223372036854775807ï¼ˆ19ä½ï¼‰ï¼Ÿ<br>è°¢è°¢ã€‚","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":506481,"discussion_content":"å…·ä½“çš„åŸå› ä¸å¾—çŸ¥ï¼Œä¹Ÿè®¸å°±æ˜¯ä¸€ç§ä¿å®ˆçš„åšæ³•ï¼šï¼‰ ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1602208087,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":249364,"user_name":"åç«¯è¿›é˜¶","can_delete":false,"product_type":"c1","uid":1125656,"ip_address":"","ucode":"480F48F5378307","user_header":"https://static001.geekbang.org/account/avatar/00/11/2d/18/918eaecf.jpg","comment_is_top":false,"comment_ctime":1600610805,"is_pvip":false,"replies":[{"id":"91472","content":"æ˜¯çš„ã€‚é‚£å°±è¦åšç›¸åº”çš„ä¼˜åŒ–","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1600656452,"ip_address":"","comment_id":249364,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1600610805","product_id":100050101,"comment_content":"å‡è®¾æ¶ˆæ¯å¤§å°æ¯” 4kb è¿˜å¤§ï¼Œæ˜¯å¦å¯ä»¥è®¤ä¸ºæ¯æ¬¡appendéƒ½ä¼šä¼´éšç´¢å¼•æ–‡ä»¶çš„appendï¼Ÿè¿™æ—¶æ˜¯ä¸æ˜¯åº”è¯¥é€‚å½“è°ƒå¤§log.index.interval.bytesæ¥ä¼˜åŒ–ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":505906,"discussion_content":"æ˜¯çš„ã€‚é‚£å°±è¦åšç›¸åº”çš„ä¼˜åŒ–","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600656452,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":245679,"user_name":"æå¥•æ…§","can_delete":false,"product_type":"c1","uid":1201005,"ip_address":"","ucode":"0D8871ED38859C","user_header":"https://static001.geekbang.org/account/avatar/00/12/53/6d/c3828950.jpg","comment_is_top":false,"comment_ctime":1599025708,"is_pvip":false,"replies":[{"id":"90395","content":"æŒ‡çš„æ˜¯ç´¢å¼•æ–‡ä»¶é‡Œé¢çš„å†…å®¹","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1599095137,"ip_address":"","comment_id":245679,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1599025708","product_id":100050101,"comment_content":"ç´¢å¼•é¡¹æŒ‡çš„æ˜¯ä½ç§»ç´¢å¼•æ–‡ä»¶å— (0000.index)?","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":504956,"discussion_content":"æŒ‡çš„æ˜¯ç´¢å¼•æ–‡ä»¶é‡Œé¢çš„å†…å®¹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599095137,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":243964,"user_name":"é²Â·æœ¬","can_delete":false,"product_type":"c1","uid":1209939,"ip_address":"","ucode":"F1DEB30C21B48E","user_header":"https://static001.geekbang.org/account/avatar/00/12/76/53/21d62a23.jpg","comment_is_top":false,"comment_ctime":1598341935,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1598341935","product_id":100050101,"comment_content":"val mapping = translateOffset(offset) è¿”å›null <br>val bytesTruncated = if (mapping == null) 0 else log.truncateTo(mapping.position)<br>æ‰€ä»¥ å°±æ˜¯ä»€ä¹ˆéƒ½åš.","like_count":0},{"had_liked":false,"id":240823,"user_name":"äº‘è¶…","can_delete":false,"product_type":"c1","uid":1581783,"ip_address":"","ucode":"63DFDDAB37A04F","user_header":"https://static001.geekbang.org/account/avatar/00/18/22/d7/ae0ed31f.jpg","comment_is_top":false,"comment_ctime":1597074812,"is_pvip":false,"replies":[{"id":"88984","content":"å—¯å—¯ï¼Œå¯èƒ½æ˜¯æˆ‘æ²¡è¯´æ¸…æ¥šã€‚Kafkaæœ‰ç»„å‚æ•°ï¼ˆlog.segment.mså’Œtopicçº§åˆ«çš„segment.msï¼Œå¦‚æœæ˜¯compactå‚æ•°ï¼Œé‚£ä¹ˆå°±æ˜¯log.cleaner.max.compaction.lag.mså’Œmax.compaction.lag.msï¼‰ç”¨äºé…ç½®æ—¥å¿—æ®µå¤šä¹…ä¹‹åè¢«åˆ é™¤ã€‚è®¡ç®—çš„æ–¹å¼å°±æ˜¯ç”¨æ—¥å¿—æ®µä¸­æ¶ˆæ¯çš„æœ€å¤§æ—¶é—´æˆ³å‡å»rollingBasedTimestampçš„å€¼ï¼Œå¦‚æœè¶…è¿‡äº†é…ç½®çš„é˜ˆå€¼å°±æ‰§è¡Œåˆ é™¤ã€‚rollingBasedTimestampå°±æ˜¯åšè¿™ä¸ªç”¨çš„ã€‚å› æ­¤å½“Kafkaåœ¨å†™å…¥æ—¥å¿—æ®µç¬¬ä¸€æ¡æ¶ˆæ¯æ—¶ä¼šç»™rollingBasedTimestampè¿›è¡Œèµ‹å€¼ã€‚<br><br>ä¸çŸ¥é“è¿™ä¹ˆè¯´æ˜¯å¦æ¸…æ¥šäº†äº›ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1597111949,"ip_address":"","comment_id":240823,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1597074812","product_id":100050101,"comment_content":"rollingBasedTimestamp è€å¸ˆï¼Œä½ åœ¨æ–‡ç« é‡Œé¢æœ‰è¯´è¿™ä¸ªå€¼æ˜¯ç”¨ä½œä¸ºâ€˜æ–°å¢æ—¥å¿—æ®µå€’è®¡æ—¶çš„ä¾æ®â€˜ï¼Œæˆ‘ç†è§£ä¸äº†è¿™å¥è¯çš„æ„æ€ï¼Œè€å¸ˆèƒ½ä¸¾ä¸ªä¾‹å­è¯´ä¸€ä¸‹å®ƒçš„å®é™…ç”¨é€”å—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":503569,"discussion_content":"å—¯å—¯ï¼Œå¯èƒ½æ˜¯æˆ‘æ²¡è¯´æ¸…æ¥šã€‚Kafkaæœ‰ç»„å‚æ•°ï¼ˆlog.segment.mså’Œtopicçº§åˆ«çš„segment.msï¼Œå¦‚æœæ˜¯compactå‚æ•°ï¼Œé‚£ä¹ˆå°±æ˜¯log.cleaner.max.compaction.lag.mså’Œmax.compaction.lag.msï¼‰ç”¨äºé…ç½®æ—¥å¿—æ®µå¤šä¹…ä¹‹åè¢«åˆ é™¤ã€‚è®¡ç®—çš„æ–¹å¼å°±æ˜¯ç”¨æ—¥å¿—æ®µä¸­æ¶ˆæ¯çš„æœ€å¤§æ—¶é—´æˆ³å‡å»rollingBasedTimestampçš„å€¼ï¼Œå¦‚æœè¶…è¿‡äº†é…ç½®çš„é˜ˆå€¼å°±æ‰§è¡Œåˆ é™¤ã€‚rollingBasedTimestampå°±æ˜¯åšè¿™ä¸ªç”¨çš„ã€‚å› æ­¤å½“Kafkaåœ¨å†™å…¥æ—¥å¿—æ®µç¬¬ä¸€æ¡æ¶ˆæ¯æ—¶ä¼šç»™rollingBasedTimestampè¿›è¡Œèµ‹å€¼ã€‚\n\nä¸çŸ¥é“è¿™ä¹ˆè¯´æ˜¯å¦æ¸…æ¥šäº†äº›ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597111949,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1581783,"avatar":"https://static001.geekbang.org/account/avatar/00/18/22/d7/ae0ed31f.jpg","nickname":"äº‘è¶…","note":"","ucode":"63DFDDAB37A04F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":298076,"discussion_content":"æ¸…æ¥šäº†ï¼Œè°¢è°¢è€å¸ˆã€‚æˆ‘è¯´æ€ä¹ˆç»™è¯¥å‚æ•°åªèµ‹äº†ä¸€æ¬¡å€¼ï¼Œåé¢ä¹Ÿæ²¡å¯¹æ”¹å€¼è¿›è¡Œæ“ä½œäº†ï¼Œæ²¡æƒ³åˆ°å®ƒçš„å…·ä½“ç”¨é€”ï¼Œæƒ³äº†åŠå¤©æ²¡æƒ³æ˜ç™½ï¼Œè€å¸ˆè¿™ä¹ˆä¸€è¯´å°±æ‡‚äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597161615,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":233279,"user_name":"Shine","can_delete":false,"product_type":"c1","uid":1184853,"ip_address":"","ucode":"BF3DB5ADF2B153","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/ydVBBkofXDqCyP7pdwkicHZ9xtyEEuZvzrrkeWcnQjZ1ibEgG60eLotQTsKJFpWibuf6e7G9r0I1xaribUAQibPMl7g/132","comment_is_top":false,"comment_ctime":1594277935,"is_pvip":false,"replies":[{"id":"86095","content":"åˆ é™¤äº†æ—¥å¿—æ®µæ–‡ä»¶å°±æ„å‘³ç€ä¸¢å¤±æ•°æ®äº†ã€‚èƒ½å¦åˆ é™¤å°±çœ‹ä½ çš„éœ€æ±‚äº†ã€‚å¦‚æœä¸€å®šè¦åˆ é™¤çš„è¯ï¼Œé‚£ä¹ˆæŒ‰ç…§æ–‡ä»¶åä¸­ä½ç§»å€¼ä»å°åˆ°å¤§çš„é¡ºåºå¼€å§‹åˆ é™¤ã€‚å¦å¤–æŠŠé…å¥—çš„ç´¢å¼•æ–‡ä»¶ä¹Ÿä¸€å¹¶åˆ é™¤ï¼Œä¹‹åé‡å¯broker","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1594305936,"ip_address":"","comment_id":233279,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1594277935","product_id":100050101,"comment_content":"è€å¸ˆï¼Œæœ‰å¾ˆå¤šæ—¥å¿—æ®µæ–‡ä»¶ï¼Œå¯¼è‡´é‡å¯æ…¢ï¼Œè¦æ€ä¹ˆåšå‘¢ï¼Ÿå¯ä»¥åˆ æ—¥å¿—æ®µæ–‡ä»¶å—ï¼Ÿæ€ä¹ˆåˆç†åˆ å‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":500971,"discussion_content":"åˆ é™¤äº†æ—¥å¿—æ®µæ–‡ä»¶å°±æ„å‘³ç€ä¸¢å¤±æ•°æ®äº†ã€‚èƒ½å¦åˆ é™¤å°±çœ‹ä½ çš„éœ€æ±‚äº†ã€‚å¦‚æœä¸€å®šè¦åˆ é™¤çš„è¯ï¼Œé‚£ä¹ˆæŒ‰ç…§æ–‡ä»¶åä¸­ä½ç§»å€¼ä»å°åˆ°å¤§çš„é¡ºåºå¼€å§‹åˆ é™¤ã€‚å¦å¤–æŠŠé…å¥—çš„ç´¢å¼•æ–‡ä»¶ä¹Ÿä¸€å¹¶åˆ é™¤ï¼Œä¹‹åé‡å¯broker","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594305936,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1184853,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/ydVBBkofXDqCyP7pdwkicHZ9xtyEEuZvzrrkeWcnQjZ1ibEgG60eLotQTsKJFpWibuf6e7G9r0I1xaribUAQibPMl7g/132","nickname":"Shine","note":"","ucode":"BF3DB5ADF2B153","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":290109,"discussion_content":"è°¢è°¢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594346586,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":231370,"user_name":"...","can_delete":false,"product_type":"c1","uid":1037826,"ip_address":"","ucode":"95B6293E8274C8","user_header":"https://static001.geekbang.org/account/avatar/00/0f/d6/02/dfcf14be.jpg","comment_is_top":false,"comment_ctime":1593658388,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1593658388","product_id":100050101,"comment_content":"If the given offset is larger than the largest message in this segment, do nothing.<br>å¦‚æœæŒ‡å®šçš„ä½ç§»å€¼ç‰¹åˆ«ç‰¹åˆ«å¤§ï¼Œä»¥è‡³äºè¶…è¿‡äº†æ—¥å¿—æ®µæœ¬èº«ä¿å­˜çš„æœ€å¤§ä½ç§»å€¼ï¼Œè¯¥æ–¹æ³•ä»€ä¹ˆä¹Ÿä¸åš","like_count":0},{"had_liked":false,"id":230148,"user_name":"magict4","can_delete":false,"product_type":"c1","uid":1043789,"ip_address":"","ucode":"CB6F063D881AAC","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ed/4d/1d1a1a00.jpg","comment_is_top":false,"comment_ctime":1593279036,"is_pvip":false,"replies":[{"id":"85031","content":"1.  recordBatch çš„åœ°å€ä¿¡æ¯ = recordBatchä¸­é¦–æ¡æ¶ˆæ¯çš„ä½ç§»<br>2. åŒç†ï¼ŒäºŒåˆ†æŸ¥æ‰¾æ˜¯æœå¯»offsetç»´åº¦çš„ï¼Œä¹Ÿä¸æ˜¯record batchç»´åº¦<br>3. å†æ¬¡åŒç†ï¼šï¼‰","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1593388515,"ip_address":"","comment_id":230148,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1593279036","product_id":100050101,"comment_content":"è€å¸ˆï¼Œä½ å¥½ï¼<br><br>æˆ‘å¯¹ translateOffset æœ‰ç‚¹ç–‘æƒ‘ï¼Œä¸çŸ¥é“æˆ‘çš„ç†è§£æ˜¯å¦å‡†ç¡®ã€‚<br>1. translateOffset è¿”å›çš„æ˜¯ recordBatch çš„åœ°å€ä¿¡æ¯ï¼Œè€Œéå…·ä½“æŸä¸ª record çš„åœ°å€ä¿¡æ¯ï¼Ÿ<br>2. å®ç°ä¸Šï¼Œå…ˆæ ¹æ®äºŒåˆ†æ³•ï¼Œç²—ç•¥å®šä½åˆ°æŸä¸ªåœ°å€ã€‚å› ä¸ºä¸æ˜¯æ‰€æœ‰ recordBatch éƒ½è¢« index äº†ã€‚æ‰€ä»¥è¿™é‡ŒäºŒåˆ†æ³•æ²¡æ³•ç²¾ç¡®å®šä½åˆ°è¢«è¯·æ±‚ recordBatch çš„åœ°å€ã€‚<br>3. æœ€åå¼€å§‹çº¿æ€§æ‰«æï¼Œæ‰¾åˆ°è¢«è¯·æ±‚çš„ recordBatch çš„åœ°å€ã€‚","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":499782,"discussion_content":"1.  recordBatch çš„åœ°å€ä¿¡æ¯ = recordBatchä¸­é¦–æ¡æ¶ˆæ¯çš„ä½ç§»\n2. åŒç†ï¼ŒäºŒåˆ†æŸ¥æ‰¾æ˜¯æœå¯»offsetç»´åº¦çš„ï¼Œä¹Ÿä¸æ˜¯record batchç»´åº¦\n3. å†æ¬¡åŒç†ï¼šï¼‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1593388515,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":229827,"user_name":"yes","can_delete":false,"product_type":"c1","uid":1386201,"ip_address":"","ucode":"612BF6884ED6CC","user_header":"https://static001.geekbang.org/account/avatar/00/15/26/d9/f7e96590.jpg","comment_is_top":false,"comment_ctime":1593157734,"is_pvip":false,"replies":[{"id":"85037","content":"å—¯ï¼Œç¡®å®ã€‚çœ‹åˆ°è¿™å¥äº†å—ï¼šfirstEntryIncomplete = adjustedMaxSize &lt; startOffsetAndSize.size<br><br>ä¸Šå±‚è°ƒç”¨è€…æ ¹æ®è¿™ä¸ªæ¥åˆ¤æ–­æ˜¯å¦è¯»å–å®Œæ•´äº†ï¼Ÿ","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1593390015,"ip_address":"","comment_id":229827,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1593157734","product_id":100050101,"comment_content":"è€å¸ˆæˆ‘å¯¹è¿™ä¸ªfetchSizeæœ‰äº›ç–‘é—®ï¼Œé¦–å…ˆç»è¿‡translateOffsetçš„ç­›é€‰ä¿è¯äº†èµ·å§‹offsetçš„é‚£æ¡æ¶ˆæ¯ä¸€å®šåœ¨æ–‡ä»¶ä¸­ï¼Œä¸ç„¶å°±return nulläº†ï¼Œå¦‚è‹¥è®¾äº†minOneMessageï¼Œåˆ™é€šè¿‡adjustedMaxSizeä¿è¯è‡³å°‘æ‹‰å–ç¬¬ä¸€æ¡æ¶ˆæ¯ã€‚æ­¤æ—¶åˆæ¥äº†ä¸ªfetchSize ï¼Ÿ å¹¶ä¸”å¯èƒ½å–åˆ°æ¯”adjustedMaxSizeæ›´å°çš„sizeã€‚<br>æˆ‘çš„ç†è§£æ˜¯ ï¼šé€šè¿‡ä»¥ä¸Šçš„æ“ä½œä¿è¯adjustedMaxSizeæœ€å°å€¼æ˜¯ä¸€æ¡æ¶ˆæ¯çš„sizeã€‚é‚£ä¹ˆæ€ä¹ˆå¯èƒ½ä¼šè¿˜å­˜åœ¨æ¯”å®ƒæ›´å°çš„sizeå‘¢ï¼Ÿå‡è®¾å–å¾—æ¯”å®ƒå°ï¼Œé‚£ä¹ˆè·å–åˆ°çš„å†…å®¹ä¸å°±ä¸å®Œæ•´äº†ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":499658,"discussion_content":"å—¯ï¼Œç¡®å®ã€‚çœ‹åˆ°è¿™å¥äº†å—ï¼šfirstEntryIncomplete = adjustedMaxSize &amp;lt; startOffsetAndSize.size\n\nä¸Šå±‚è°ƒç”¨è€…æ ¹æ®è¿™ä¸ªæ¥åˆ¤æ–­æ˜¯å¦è¯»å–å®Œæ•´äº†ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1593390015,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":229130,"user_name":"åƒé¥­é¥­","can_delete":false,"product_type":"c1","uid":1231549,"ip_address":"","ucode":"95CFA07CDA2957","user_header":"https://static001.geekbang.org/account/avatar/00/12/ca/bd/a51ae4b2.jpg","comment_is_top":false,"comment_ctime":1592902518,"is_pvip":false,"replies":[{"id":"84611","content":"è¿™è¡Œä»£ç æ˜¯å‘ç´¢å¼•æ–‡ä»¶å†™å…¥ä¸€ä¸ªç´¢å¼•é¡¹ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1592966605,"ip_address":"","comment_id":229130,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1592902518","product_id":100050101,"comment_content":"æœ‰ä¸ªåœ°æ–¹æ²¡çœ‹æ˜ç™½ï¼Œkafka.log.LogSegment#append æ–¹æ³•çš„è¿™è¡Œä»£ç  offsetIndex.append(largestOffset, physicalPosition) æ˜¯å¹²äº†äº›ä»€ä¹ˆäº‹ï¼Ÿå¦‚æœå­—èŠ‚æ•°å¤§äºé»˜è®¤çš„ 4KB æ—¶æ˜¯åˆ›å»ºæ–°çš„ LogSegment æ–‡ä»¶å—ï¼Ÿè¿˜æ˜¯åªæ˜¯æ›´æ–°å½“å‰æ–‡ä»¶çš„ç´¢å¼•å€¼å’Œç‰©ç†ç´¢å¼•å€¼ï¼ŸScala çœ‹çš„å¾ˆè’™åœˆäº† ï¼šï¼‰","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":499345,"discussion_content":"è¿™è¡Œä»£ç æ˜¯å‘ç´¢å¼•æ–‡ä»¶å†™å…¥ä¸€ä¸ªç´¢å¼•é¡¹ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592966605,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1231549,"avatar":"https://static001.geekbang.org/account/avatar/00/12/ca/bd/a51ae4b2.jpg","nickname":"åƒé¥­é¥­","note":"","ucode":"95CFA07CDA2957","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":285839,"discussion_content":"å—¯ï¼Œè°¢è°¢å•¦ï¼Œæˆ‘å†ç ”ç©¶ä¸€ä¸‹ï¼Œè²Œä¼¼çœ‹è·‘åäº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592967351,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":228106,"user_name":"é›•","can_delete":false,"product_type":"c1","uid":1892202,"ip_address":"","ucode":"5D14752E1450B0","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLSEtGul3OLHfbkbq5qOywnsCmZ68icDaFcvghXyvmAicTUtLr9q18dmJHH3ZWq3QLGcaicHo1ARn5gA/132","comment_is_top":false,"comment_ctime":1592557476,"is_pvip":false,"replies":[{"id":"84345","content":"æ—¥å¿—æ®µæœ‰ä¸ªlog.roll.mså‚æ•°ï¼Œæ§åˆ¶æ—¥å¿—æ®µåˆ‡åˆ†çš„é¢‘ç‡","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1592794544,"ip_address":"","comment_id":228106,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1592557476","product_id":100050101,"comment_content":"è€å¸ˆï¼Œâ€œKafka éœ€è¦è®°å½•è¦å†™å…¥æ¶ˆæ¯é›†åˆçš„æœ€å¤§æ—¶é—´æˆ³ï¼Œå¹¶å°†å…¶ä½œä¸ºåé¢æ–°å¢æ—¥å¿—æ®µå€’è®¡æ—¶çš„ä¾æ®ã€‚â€ä¸­ä½œä¸ºåé¢æ–°å¢æ—¥å¿—æ®µå€’è®¡æ—¶çš„ä¾æ®è¿™ä¸ªæ€ä¹ˆç†è§£ï¼Œè¿˜æœ‰æ—¥å¿—æ®µçš„åˆ’åˆ†ä¾æ®æ˜¯ä»€ä¹ˆï¼Ÿæ˜¯å­˜å‚¨æ¶ˆæ¯çš„å®¹é‡è¿˜æ˜¯æ—¶é—´ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":498922,"discussion_content":"æ—¥å¿—æ®µæœ‰ä¸ªlog.roll.mså‚æ•°ï¼Œæ§åˆ¶æ—¥å¿—æ®µåˆ‡åˆ†çš„é¢‘ç‡","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592794544,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":223111,"user_name":"csyangchsh","can_delete":false,"product_type":"c1","uid":1002939,"ip_address":"","ucode":"8604F5C839710B","user_header":"https://static001.geekbang.org/account/avatar/00/0f/4d/bb/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1591003557,"is_pvip":false,"replies":[{"id":"82334","content":"å—¯å—¯ï¼Œè¿™å—ä¹‹å‰æ˜¯æ­£ç¡®çš„ï¼Œåé¢æ”¹é”™äº†ã€‚æˆ‘è¦æ”¹å›æ¥ï¼Œå¤šè°¢æ‚¨çš„æé†’ï¼šï¼‰","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1591094042,"ip_address":"","comment_id":223111,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1591003557","product_id":100050101,"comment_content":"è€å¸ˆï¼Œåœ¨è®²è§£appendæ–¹æ³•ç¬¬ä¸€æ­¥çš„æè¿° â€œåœ¨æºç ä¸­ï¼Œé¦–å…ˆè°ƒç”¨ records.sizeInBytes æ–¹æ³•åˆ¤æ–­è¯¥æ—¥å¿—æ®µæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœæ˜¯ç©ºçš„è¯ï¼Œ Kafka éœ€è¦è®°å½•è¦å†™å…¥æ¶ˆæ¯é›†åˆçš„æœ€å¤§æ—¶é—´æˆ³ï¼Œå¹¶å°†å…¶ä½œä¸ºåé¢æ–°å¢æ—¥å¿—æ®µå€’è®¡æ—¶çš„ä¾æ®ã€‚â€ ä¸­ records.sizeInBytes ä¼¼ä¹æ˜¯ç¬”è¯¯ï¼Œåº”è¯¥æ˜¯ log.sizeInBytes()ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":497015,"discussion_content":"å—¯å—¯ï¼Œè¿™å—ä¹‹å‰æ˜¯æ­£ç¡®çš„ï¼Œåé¢æ”¹é”™äº†ã€‚æˆ‘è¦æ”¹å›æ¥ï¼Œå¤šè°¢æ‚¨çš„æé†’ï¼šï¼‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591094042,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":219374,"user_name":"Rogerå®‡","can_delete":false,"product_type":"c1","uid":1703222,"ip_address":"","ucode":"CBA23C01409349","user_header":"https://static001.geekbang.org/account/avatar/00/19/fd/36/f947c340.jpg","comment_is_top":false,"comment_ctime":1590020252,"is_pvip":false,"replies":[{"id":"81033","content":"ä¸ªäººæ„Ÿè§‰æ²¡æœ‰ä»€ä¹ˆç‰¹æ®Šä¹‹å¤„ï¼Œå°±æ˜¯ç¤¾åŒºè‡ªå·±å®šä¹‰çš„ä¸€ä¸ªé˜ˆå€¼ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1590022403,"ip_address":"","comment_id":219374,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1590020252","product_id":100050101,"comment_content":"è€å¸ˆï¼Œè¯·é—®æ—¥å¿—æ®µæ²¡å†™å…¥4kbå¢åŠ ä¸€ä¸ªäººindex entryï¼Œè¿™ä¸ª4kbæ˜¯å¦æœ‰æ›´æ·±çš„è€ƒé‡ï¼Ÿå› ä¸ºæ„Ÿè§‰è¿™ä¸ª4kbå¥½åƒå’Œæ“ä½œç³»ç»Ÿå†…å­˜åˆ†é¡µçš„å¤§å°ä¸€æ ·å•Šï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":495787,"discussion_content":"ä¸ªäººæ„Ÿè§‰æ²¡æœ‰ä»€ä¹ˆç‰¹æ®Šä¹‹å¤„ï¼Œå°±æ˜¯ç¤¾åŒºè‡ªå·±å®šä¹‰çš„ä¸€ä¸ªé˜ˆå€¼ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590022403,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":219103,"user_name":"Light","can_delete":false,"product_type":"c1","uid":1271854,"ip_address":"","ucode":"DDFEF340A9433B","user_header":"https://static001.geekbang.org/account/avatar/00/13/68/2e/e9d09fac.jpg","comment_is_top":false,"comment_ctime":1589945147,"is_pvip":false,"replies":[{"id":"80980","content":"å—¯ï¼Œå…·ä½“ä»€ä¹ˆæ‰ç®—ç¬¬ä¸€æ­¥ä¸é‡è¦ã€‚é‡è¦çš„æ˜¯äº†è§£ä»£ç çš„ä½œç”¨å°±è¡Œï¼šï¼‰","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1589974422,"ip_address":"","comment_id":219103,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1589945147","product_id":100050101,"comment_content":"appendæ–¹æ³•çš„ç¬¬ä¸€æ­¥æè¿°æœ‰ç‚¹ç–‘é—®ï¼š<br>â€œrecords.sizeInBytes æ–¹æ³•åˆ¤æ–­è¯¥æ—¥å¿—æ®µæ˜¯å¦ä¸ºç©ºâ€,è¿™ä¸ªåˆ¤æ–­æ˜¯å¯¹è¦å†™å…¥æ¶ˆæ¯çš„å¤§å°è¿›è¡Œåˆ¤æ–­å§ï¼Œå½“å¾…å†™å…¥æ¶ˆæ¯å†…å®¹ä¸ä¸ºç©ºçš„æ—¶å€™æ‰å¼€å§‹appendï¼›<br>val physicalPosition = log.sizeInBytes()<br>if (physicalPosition == 0)<br>    rollingBasedTimestamp = Some(largestTimestamp)<br>è¿™æ®µä»£ç æ‰æ˜¯ç¬¬ä¸€æ­¥åšçš„äº‹æƒ…ï¼Ÿ<br>","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":495684,"discussion_content":"å—¯ï¼Œå…·ä½“ä»€ä¹ˆæ‰ç®—ç¬¬ä¸€æ­¥ä¸é‡è¦ã€‚é‡è¦çš„æ˜¯äº†è§£ä»£ç çš„ä½œç”¨å°±è¡Œï¼šï¼‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589974422,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":217344,"user_name":"å°å»–","can_delete":false,"product_type":"c1","uid":1103444,"ip_address":"","ucode":"BAABB5D93BA5BE","user_header":"https://static001.geekbang.org/account/avatar/00/10/d6/54/75625218.jpg","comment_is_top":false,"comment_ctime":1589467189,"is_pvip":false,"replies":[{"id":"80473","content":"ä½ è®¤ä¸ºè¿™å°±æ˜¯offsetOfMaxTimestampSoFarçš„setteræ–¹æ³•","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1589524436,"ip_address":"","comment_id":217344,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1589467189","product_id":100050101,"comment_content":"def offsetOfMaxTimestampSoFar_=(offset: Long): Unit = _offsetOfMaxTimestampSoFar = Some(offset)<br><br>LogSegment çš„è¿™è¡Œä»£ç æœ‰ç‚¹çœ‹ä¸æ‡‚å•Š","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":495116,"discussion_content":"ä½ è®¤ä¸ºè¿™å°±æ˜¯offsetOfMaxTimestampSoFarçš„setteræ–¹æ³•","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589524436,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":215020,"user_name":"éœäº‘Obsidian","can_delete":false,"product_type":"c1","uid":1178275,"ip_address":"","ucode":"1E5818D5C01576","user_header":"https://static001.geekbang.org/account/avatar/00/11/fa/a3/1b29f975.jpg","comment_is_top":false,"comment_ctime":1588870752,"is_pvip":false,"replies":[{"id":"79689","content":"æ²¡å¤ªæ˜ç™½æ‚¨çš„é—®é¢˜ã€‚bytesSinceLastIndexEntryåˆ¤æ–­ä¹‹åä¼šè¢«æ¸…0ï¼Œè¿™ä¸ªappendæ–¹æ³•æ˜¯ä¸€æ¬¡æ€§å°†recordsçš„æ‰€æœ‰å­—èŠ‚å†™å…¥åˆ°æ—¥å¿—æ®µã€‚è¿™æ ·æ¯æ¬¡å†™å…¥æ—¶å¦‚æœæ€»å­—èŠ‚æ•°è¶…è¿‡äº†4KBï¼Œé‚£ä¹ˆå°±æ–°å¢ä¸€æ¡ç´¢å¼•é¡¹ï¼Œä¹‹åå°†bytesSinceLastIndexEntryæ¸…0ã€‚æ¯æ¬¡éƒ½æ˜¯è¿™æ ·çš„é€»è¾‘ã€‚ä¸çŸ¥é“æ˜¯å¦è§£ç­”äº†æ‚¨çš„ç–‘é—®","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1588984335,"ip_address":"","comment_id":215020,"utype":1}],"discussion_count":3,"race_medal":0,"score":"1588870752","product_id":100050101,"comment_content":"      &#47;&#47; append an entry to the index (if needed)<br>      if (bytesSinceLastIndexEntry &gt; indexIntervalBytes) {<br>        offsetIndex.append(largestOffset, physicalPosition)<br>        timeIndex.maybeAppend(maxTimestampSoFar, offsetOfMaxTimestampSoFar)<br>        bytesSinceLastIndexEntry = 0<br>      }<br>      bytesSinceLastIndexEntry += records.sizeInBytes<br><br>å…³äºè¿™æ®µä»£ç æˆ‘æœ‰ä¸ªç–‘é—®ï¼Œrecords.sizeInByteså½“å¤§äº4Kçš„æ—¶å€™ï¼ˆæ¯”å¦‚8Kï¼‰ï¼Œé‚£ä¹ˆä»ä»£ç ä¸Šçœ‹ä¸‹ä¸€æ¬¡åˆ¤æ–­çš„æ—¶å€™åªæ˜¯åˆ¤æ–­æ˜¯å¦&gt;4Kï¼Œé‚£ä¹ˆè¿™ç§æƒ…å†µæ˜¯åªç”¨ä¸€ä¸ªindexè¡¨ç¤º8Kå—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":494279,"discussion_content":"æ²¡å¤ªæ˜ç™½æ‚¨çš„é—®é¢˜ã€‚bytesSinceLastIndexEntryåˆ¤æ–­ä¹‹åä¼šè¢«æ¸…0ï¼Œè¿™ä¸ªappendæ–¹æ³•æ˜¯ä¸€æ¬¡æ€§å°†recordsçš„æ‰€æœ‰å­—èŠ‚å†™å…¥åˆ°æ—¥å¿—æ®µã€‚è¿™æ ·æ¯æ¬¡å†™å…¥æ—¶å¦‚æœæ€»å­—èŠ‚æ•°è¶…è¿‡äº†4KBï¼Œé‚£ä¹ˆå°±æ–°å¢ä¸€æ¡ç´¢å¼•é¡¹ï¼Œä¹‹åå°†bytesSinceLastIndexEntryæ¸…0ã€‚æ¯æ¬¡éƒ½æ˜¯è¿™æ ·çš„é€»è¾‘ã€‚ä¸çŸ¥é“æ˜¯å¦è§£ç­”äº†æ‚¨çš„ç–‘é—®","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588984335,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2107375,"avatar":"https://static001.geekbang.org/account/avatar/00/20/27/ef/a7f94eda.jpg","nickname":"Jerry You","note":"","ucode":"679A44B505482F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":328921,"discussion_content":"è¿™é‡Œå¯èƒ½å°±æ¶‰åŠåˆ°äº†kafkaæ¶ˆæ¯ä½“ç»“æ„çš„æ¦‚å¿µäº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606273870,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2107375,"avatar":"https://static001.geekbang.org/account/avatar/00/20/27/ef/a7f94eda.jpg","nickname":"Jerry You","note":"","ucode":"679A44B505482F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":328920,"discussion_content":"çœ‹åˆ°è¿™æœ‰ä¸ªç–‘é—®ï¼Œ ç´¢å¼•é¡¹è™½ç„¶è®°å½•äº†æ¶ˆæ¯çš„ä½ç§»ï¼Œä½†æ˜¯æ¯æ¡æ¶ˆæ¯çš„é•¿åº¦ä¿¡æ¯åœ¨å“ªè®°å½•çš„ï¼Ÿ åœ¨logæ–‡ä»¶çš„æ¯æ¡æ¶ˆæ¯ä½“é‡Œé¢ä¹ˆï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606273817,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":214817,"user_name":"mengjun","can_delete":false,"product_type":"c1","uid":1108936,"ip_address":"","ucode":"3CA20F7C8FB28F","user_header":"https://static001.geekbang.org/account/avatar/00/10/eb/c8/278ee25c.jpg","comment_is_top":false,"comment_ctime":1588823866,"is_pvip":false,"replies":[{"id":"79560","content":"ä½ æŒ‡çš„å†™å…¥ä¸­é—´å‡ºç°é—®é¢˜æ˜¯æŒ‡ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿå¦‚æœæ˜¯å› ä¸ºç½‘ç»œæŠ–åŠ¨å¯¼è‡´æŸäº›å­—èŠ‚ä¸¢å¤±æˆ–å†™å…¥é”™è¯¯å­—èŠ‚ï¼Œä¼šå‡ºç°æ¶ˆæ¯é›†åˆCRCæ ¡éªŒå€¼å‘ç”Ÿå˜æ›´ï¼Œè¿™ä¸ªæ£€æŸ¥ä¸æ˜¯åœ¨logè¿™ä¸€å±‚çº§æ‰§è¡Œçš„ï¼Œè€Œæ˜¯åœ¨åº•å±‚çš„æ¶ˆæ¯é›†åˆæˆ–æ¶ˆæ¯æ‰¹æ¬¡è¿™ä¸ªlevelæ‰§è¡Œçš„","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1588845591,"ip_address":"","comment_id":214817,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1588823866","product_id":100050101,"comment_content":"è€å¸ˆæ‚¨å¥½ï¼Œ<br><br>å¯¹äº recover æ–¹æ³•ï¼Œæœ‰ä¸€æ®µä»£ç æœ‰ç–‘é—®ã€‚<br><br>val truncated = log.sizeInBytes - validBytes<br>    if (truncated &gt; 0)<br>      debug(s&quot;Truncated $truncated invalid bytes at the end of segment ${log.file.getAbsoluteFile} during recovery&quot;)<br><br>ä¸Šé¢è¿™å‡ è¡Œä»£ç è¯´çš„æ˜¯: å¦‚æœlog.sizeInBytes å’Œ validBytes ä¸ä¸€æ ·çš„è¯ï¼Œé‚£ä¹ˆend of segmentæ˜¯æœ‰invalid bytes. <br><br>é‚£æˆ‘çš„é—®é¢˜æ˜¯ï¼Œæœ‰æ²¡æœ‰å¯èƒ½åœ¨File (Log segment) ä¸­é—´å†™å…¥çš„æ—¶å€™å‡ºç°é—®é¢˜ï¼Ÿå¦‚æœæœ‰å¯èƒ½çš„è¯ï¼Œé‚£ä¹ˆrecover å¥½åƒå¹¶æ²¡æœ‰å¤„ç†è¿™ç§æƒ…å†µï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":494210,"discussion_content":"ä½ æŒ‡çš„å†™å…¥ä¸­é—´å‡ºç°é—®é¢˜æ˜¯æŒ‡ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿå¦‚æœæ˜¯å› ä¸ºç½‘ç»œæŠ–åŠ¨å¯¼è‡´æŸäº›å­—èŠ‚ä¸¢å¤±æˆ–å†™å…¥é”™è¯¯å­—èŠ‚ï¼Œä¼šå‡ºç°æ¶ˆæ¯é›†åˆCRCæ ¡éªŒå€¼å‘ç”Ÿå˜æ›´ï¼Œè¿™ä¸ªæ£€æŸ¥ä¸æ˜¯åœ¨logè¿™ä¸€å±‚çº§æ‰§è¡Œçš„ï¼Œè€Œæ˜¯åœ¨åº•å±‚çš„æ¶ˆæ¯é›†åˆæˆ–æ¶ˆæ¯æ‰¹æ¬¡è¿™ä¸ªlevelæ‰§è¡Œçš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588845591,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":212129,"user_name":"åŒ—å†¥æœ‰é±¼","can_delete":false,"product_type":"c1","uid":1592243,"ip_address":"","ucode":"1690734A1061F4","user_header":"https://static001.geekbang.org/account/avatar/00/18/4b/b3/51bb33f2.jpg","comment_is_top":false,"comment_ctime":1588064436,"is_pvip":false,"replies":[{"id":"78879","content":"æˆ‘ä»¬ä¸“æ é˜…è¯»Trunkåˆ†æ”¯ä»£ç è¿›è¡Œé˜…è¯»ï¼Œè‡³å°‘æ˜¯2.4ï¼Œ2.5ç‰ˆæœ¬çš„ä»£ç äº†ã€‚FileMessageSetæ˜¯å¾ˆè€çš„æ¦‚å¿µäº†","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1588083527,"ip_address":"","comment_id":212129,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1588064436","product_id":100050101,"comment_content":"è€å¸ˆï¼Œkafkaæ˜¯å“ªä¸ªç‰ˆæœ¬çš„ï¼Ÿæˆ‘è¿™è¾¹çš„æ•°æ®æ˜¯æ”¾åœ¨FileMessageSetä¸­çš„","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493435,"discussion_content":"æˆ‘ä»¬ä¸“æ é˜…è¯»Trunkåˆ†æ”¯ä»£ç è¿›è¡Œé˜…è¯»ï¼Œè‡³å°‘æ˜¯2.4ï¼Œ2.5ç‰ˆæœ¬çš„ä»£ç äº†ã€‚FileMessageSetæ˜¯å¾ˆè€çš„æ¦‚å¿µäº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588083527,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":211252,"user_name":"Tomcat","can_delete":false,"product_type":"c1","uid":1399488,"ip_address":"","ucode":"58A9D44991EDB7","user_header":"https://static001.geekbang.org/account/avatar/00/15/5a/c0/e20eb855.jpg","comment_is_top":false,"comment_ctime":1587923370,"is_pvip":false,"replies":[{"id":"78563","content":"1. æ‰€æœ‰offsetå­—çœ¼çš„å˜é‡éƒ½æ˜¯ä½ç§»å€¼ï¼Œä¸æ˜¯ç‰©ç†ä½ç½®ã€‚å½“ç„¶è¿™é‡Œçš„startOffsetAndSizeæ˜¯ä¸€ä¸ªpojoç±»ï¼ŒåŒæ—¶åŒ…å«offsetã€ç‰©ç†æ–‡ä»¶ä½ç½®å’Œå¤§å°<br>2.1 æ¯”å¦‚æ¶ˆæ¯ä½“è¶…è¿‡äº†max.partition.fetch.byteså€¼ã€‚æˆ–è€…è¿™ä¹ˆè¯´ï¼ŒBrokerä¸­ä¿å­˜çš„æ¶ˆæ¯æ˜¯1MBï¼Œæœ‰ä¸ªconsumerï¼Œæ¯æ¬¡åªèƒ½è¯»å–ä¸è¶…è¿‡500KBçš„æ•°æ®<br>2.2 ä¸å­˜åœ¨æ¶ˆæ¯ä¸å®Œæ•´çš„æƒ…å†µï¼Œè‡³å°‘å¯¹äºconsumerè€Œè¨€ä¹Ÿæ˜¯ä¸å¯è§çš„ã€‚å› ä¸ºconsumeråªèƒ½è¯»åˆ°HWä»¥ä¸‹çš„æ•°æ®ï¼Œè€ŒHWä»¥ä¸‹çš„æ•°æ®éƒ½æ˜¯å·²æäº¤çš„ï¼Œä¸å¯èƒ½æ˜¯ä¸å®Œæ•´çš„<br>3. åé¢é‚£ä¸€å¤§å †è¯æˆ‘æ²¡å¤ªæ˜ç™½ä»€ä¹ˆæ„æ€ã€‚ä¸è¿‡å½“minOneMessage=falseï¼Œä»£ç ä¹Ÿä¸ä¼šä»å¦ä¸€ä¸ªæ—¥å¿—æ®µè¯»å–æ¶ˆæ¯","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1587951325,"ip_address":"","comment_id":211252,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1587923370","product_id":100050101,"comment_content":"èƒ¡è€å¸ˆçœ‹å®Œreadæ–¹æ³•ä¹‹åæˆ‘æœ‰å‡ ä¸ªç–‘é—®æ‚¨å¯ä»¥ç»™æˆ‘è§£é‡Šä¸‹å—ï¼Ÿ<br>1ã€val startOffsetAndSize = translateOffset(startOffset)<br>\tstartOffsetAndSizeè¿™é‡ŒOffsetä»£è¡¨çš„æ˜¯ç‰©ç†æ–‡ä»¶çš„ä½ç½®ï¼ŒSizeæŒ‡çš„æ˜¯ç‰©ç†æ–‡ä»¶çš„å¤§å°ï¼Œæˆ‘è¯´çš„å¯¹å—ï¼Ÿ<br>2ã€å³ä½¿å‡ºç°æ¶ˆæ¯ä½“å­—èŠ‚æ•°è¶…è¿‡äº† maxSize çš„æƒ…å½¢ï¼Œread æ–¹æ³•ä¾ç„¶èƒ½è¿”å›è‡³å°‘ä¸€æ¡æ¶ˆæ¯ã€‚<br>   ï¼ˆ1ï¼‰ã€æ¶ˆæ¯ä½“å­—èŠ‚æ•°è¶…è¿‡äº† maxSizeï¼ˆèƒ½è¯»å–çš„æœ€å¤§å­—èŠ‚æ•°ï¼‰çš„æƒ…å½¢æŒ‡çš„æ˜¯å“ªç§ï¼Ÿè¿™ä¸¤ä¸ªæ¦‚å¿µåˆ†åˆ«æŒ‡ä»€ä¹ˆï¼Ÿ<br>   ï¼ˆ2ï¼‰ã€å¦‚æœæˆ‘çš„ç¬¬ä¸€ä¸ªå¤§é—®é¢˜æ˜¯å¯¹çš„ï¼Œé‚£ä¹ˆä»æºç å¯ä»¥çœ‹å‡ºå¦‚æœminOneMessageè®¾ä¸ºtrueçš„æ—¶å€™<br>   ä¼šè¯»åˆ°ä¸€ä¸ªæ—¥å¿—æ®µçš„æœ€å¤§ç‰©ç†ä½ç½®ï¼Œæˆ‘è¿™æ ·ç†è§£æ­£ç¡®å—ï¼Ÿï¼ˆä½†æ˜¯æˆ‘è§‰å¾—ä¼šå­˜åœ¨ä¸€æ¡æ¶ˆæ¯ä¸å®Œæ•´çš„æƒ…å†µï¼Œå®ƒæ˜¯å¦‚ä½•è§„é¿è¿™ä¸ªé—®é¢˜çš„ï¼Ÿæˆ‘çš„ç­”æ¡ˆæ˜¯kafkaåœ¨å†™æ—¥å¿—æ®µçš„æ—¶å€™ï¼Œå³ä½¿è¶…è¿‡äº†æ—¥å¿—æ®µçš„å¤§å°ï¼Œ<br>   å®ƒä¹Ÿä¸ä¼šç«‹å³åˆ†å‰²ä¸€ä¸ªæ–°çš„æ—¥å¿—æ®µï¼Œè€Œæ˜¯æŠŠä¸€æ¡å®Œæ•´çš„æ¶ˆæ¯å†™åˆ°å½“å‰çš„è¿™ä¸ªæ—¥å¿—æ®µä¹‹åå†åˆ†å‰²ä¸€ä¸ªæ–°çš„æ—¥å¿—æ®µã€‚è¿™æ ·è§£é‡Šæ­£ç¡®å—ï¼Ÿï¼‰ã€‚å½“minOneMessageä¸ºfalseçš„æ—¶å€™ï¼Œæ¶ˆæ¯ä½“å­—èŠ‚æ•°è¶…è¿‡äº†maxSizeå®ƒä¼šä»å¦ä¸€ä¸ªæ—¥å¿—æ®µä¸­å»è¯»å–æ¶ˆæ¯ã€‚è¿™æ ·ç†è§£å¯¹å—ï¼Ÿ<br>3ã€ä½†æ˜¯çœ‹å®Œè¿™è¡Œval fetchSize: Int = min((maxPosition - startPosition).toInt, adjustedMaxSize) è¿™è¡Œä»£ç è¡¨ç¤ºçš„æ˜¯å¾…è¯»å–çš„æ€»å­—èŠ‚æ•°å’Œæ—¥å¿—æ®µå¯è¯»çš„å­—èŠ‚æ•°ä¸­å–å°çš„å€¼ã€‚<br><br>æˆ‘è§‰å¾—æˆ‘å¯¹æˆ‘ç¬¬äºŒä¸ªé—®é¢˜çš„è§£ç­”æ˜¯æœ‰å¾ˆå¤§é—®é¢˜çš„ï¼Œèƒ¡è€å¸ˆèƒ½å¸®æˆ‘è§£ç­”ä¸€ä¸‹å—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493230,"discussion_content":"1. æ‰€æœ‰offsetå­—çœ¼çš„å˜é‡éƒ½æ˜¯ä½ç§»å€¼ï¼Œä¸æ˜¯ç‰©ç†ä½ç½®ã€‚å½“ç„¶è¿™é‡Œçš„startOffsetAndSizeæ˜¯ä¸€ä¸ªpojoç±»ï¼ŒåŒæ—¶åŒ…å«offsetã€ç‰©ç†æ–‡ä»¶ä½ç½®å’Œå¤§å°\n2.1 æ¯”å¦‚æ¶ˆæ¯ä½“è¶…è¿‡äº†max.partition.fetch.byteså€¼ã€‚æˆ–è€…è¿™ä¹ˆè¯´ï¼ŒBrokerä¸­ä¿å­˜çš„æ¶ˆæ¯æ˜¯1MBï¼Œæœ‰ä¸ªconsumerï¼Œæ¯æ¬¡åªèƒ½è¯»å–ä¸è¶…è¿‡500KBçš„æ•°æ®\n2.2 ä¸å­˜åœ¨æ¶ˆæ¯ä¸å®Œæ•´çš„æƒ…å†µï¼Œè‡³å°‘å¯¹äºconsumerè€Œè¨€ä¹Ÿæ˜¯ä¸å¯è§çš„ã€‚å› ä¸ºconsumeråªèƒ½è¯»åˆ°HWä»¥ä¸‹çš„æ•°æ®ï¼Œè€ŒHWä»¥ä¸‹çš„æ•°æ®éƒ½æ˜¯å·²æäº¤çš„ï¼Œä¸å¯èƒ½æ˜¯ä¸å®Œæ•´çš„\n3. åé¢é‚£ä¸€å¤§å †è¯æˆ‘æ²¡å¤ªæ˜ç™½ä»€ä¹ˆæ„æ€ã€‚ä¸è¿‡å½“minOneMessage=falseï¼Œä»£ç ä¹Ÿä¸ä¼šä»å¦ä¸€ä¸ªæ—¥å¿—æ®µè¯»å–æ¶ˆæ¯","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587951325,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1399488,"avatar":"https://static001.geekbang.org/account/avatar/00/15/5a/c0/e20eb855.jpg","nickname":"Tomcat","note":"","ucode":"58A9D44991EDB7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":249770,"discussion_content":"èƒ¡è€å¸ˆï¼Œ2.2çš„è¨€å¤–ä¹‹æ„æ˜¯ä¸æ˜¯æŠŠæ¶ˆæ¯ä»Brokeræ‹‰åˆ°ä¹‹åå¹¶ä¸ä¼šé©¬ä¸Šå»è§£æï¼Œè€Œæ˜¯Brokerä¼šæŠŠæ¶ˆæ¯æäº¤åˆ°consumerï¼Œç„¶åconsumerå†å»è§£ææˆå’±ä»¬å¯ä»¥è®¤è¯†çš„æ¶ˆæ¯","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587961485,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":211049,"user_name":"ğŸ™Šé¡¾å°é¡¾","can_delete":false,"product_type":"c1","uid":1965728,"ip_address":"","ucode":"FC7974A351586C","user_header":"https://static001.geekbang.org/account/avatar/00/1d/fe/a0/b1212e2b.jpg","comment_is_top":false,"comment_ctime":1587888674,"is_pvip":false,"replies":[{"id":"78572","content":"ä¸éœ€è¦å¾ªç¯åˆ¤æ–­å•Šã€‚ä¸€æ—¦è¶…è¿‡äº†4KBï¼Œç›´æ¥å†™ç´¢å¼•ï¼Œç„¶åæ¸…ç©ºè®¡æ•°å™¨ã€‚ä»…æ­¤è€Œå·²~","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1587952381,"ip_address":"","comment_id":211049,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1587888674","product_id":100050101,"comment_content":"å½“å·²å†™å…¥å­—èŠ‚æ•°è¶…è¿‡äº† 4KB ä¹‹åï¼Œappend æ–¹æ³•ä¼šè°ƒç”¨ç´¢å¼•å¯¹è±¡çš„ append æ–¹æ³•æ–°å¢ç´¢å¼•é¡¹ï¼ŒåŒæ—¶æ¸…ç©ºå·²å†™å…¥å­—èŠ‚æ•°ï¼Œä»¥å¤‡ä¸‹æ¬¡é‡æ–°ç´¯ç§¯è®¡ç®—. å­—èŠ‚æ•°ä¸ä¼šä¸€æ¬¡æ€§è¶…è¿‡4KBå—ï¼Œæˆ‘çœ‹æ²¡æœ‰ä¸€ä¸ªå¾ªç¯çš„åˆ¤æ–­","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493180,"discussion_content":"ä¸éœ€è¦å¾ªç¯åˆ¤æ–­å•Šã€‚ä¸€æ—¦è¶…è¿‡äº†4KBï¼Œç›´æ¥å†™ç´¢å¼•ï¼Œç„¶åæ¸…ç©ºè®¡æ•°å™¨ã€‚ä»…æ­¤è€Œå·²~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587952381,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":209976,"user_name":"å°˜æ«","can_delete":false,"product_type":"c1","uid":1093372,"ip_address":"","ucode":"79698689EDD97A","user_header":"https://static001.geekbang.org/account/avatar/00/10/ae/fc/d647a3e4.jpg","comment_is_top":false,"comment_ctime":1587644836,"is_pvip":false,"replies":[{"id":"78368","content":"è¿™ä¸ªç±»é‡Œé¢ä¿å­˜äº†Brokerç«¯çš„å‚æ•°å®šä¹‰å’Œé»˜è®¤å€¼ç­‰ä¿¡æ¯ï¼ŒåŒæ—¶å®šä¹‰äº†å¾ˆå¤šå®ç”¨æ–¹æ³•ã€‚æ‚¨å…·ä½“çš„é—®é¢˜æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1587712572,"ip_address":"","comment_id":209976,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1587644836","product_id":100050101,"comment_content":"è€å¸ˆèƒ½è®²è®²KafkaConfigså—ï¼Œ åœ¨çœ‹AbstractConfigæ—¶ï¼Œçœ‹ä¸æ˜ç™½","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492902,"discussion_content":"è¿™ä¸ªç±»é‡Œé¢ä¿å­˜äº†Brokerç«¯çš„å‚æ•°å®šä¹‰å’Œé»˜è®¤å€¼ç­‰ä¿¡æ¯ï¼ŒåŒæ—¶å®šä¹‰äº†å¾ˆå¤šå®ç”¨æ–¹æ³•ã€‚æ‚¨å…·ä½“çš„é—®é¢˜æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587712572,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":209830,"user_name":"ç°æœº","can_delete":false,"product_type":"c1","uid":1179580,"ip_address":"","ucode":"46F6CFC2DFAA2B","user_header":"https://static001.geekbang.org/account/avatar/00/11/ff/bc/368b9f80.jpg","comment_is_top":false,"comment_ctime":1587621905,"is_pvip":false,"replies":[{"id":"78371","content":"&quot;é‚£æœªå®Œæ•´å†™å…¥çš„æ¶ˆæ¯(è„æ¶ˆæ¯) ä¸ä¹Ÿä¼šç´¯åŠ åˆ°ä¸€èµ·å—ï¼Ÿ&quot;  --- ä¸ä¼šçš„ã€‚èƒ½è¯»åˆ°çš„éƒ½æ˜¯å·²æäº¤çš„å®Œæ•´çš„æ¶ˆæ¯ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1587712891,"ip_address":"","comment_id":209830,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1587621905","product_id":100050101,"comment_content":"è€å¸ˆæ‚¨å¥½ã€‚validBytesä¸ºä»logFileä¸­çš„bactch æ‰¹é‡è¯»å–messageçš„å­—èŠ‚æ•°ç´¯åŠ å®ç°ï¼Œå½“æ¶ˆæ¯batch å†™å…¥ä¸€éƒ¨åˆ†çš„æ—¶å€™å¦‚æœå‡ºç°brokerå®•æœºçš„è¯ï¼Œä¼šå†™å…¥ä¸€éƒ¨ä»½æ¶ˆæ¯ï¼Œé‚£ä¹ˆlogFileå¤§å°ä¼šå¤§äºvalidByteså¤§å°ï¼Œä½†æ˜¯validBytesä¸ä¹Ÿæ˜¯ä¼šæ‰«æå½“å‰fileçš„messageå—ï¼Ÿ é‚£æœªå®Œæ•´å†™å…¥çš„æ¶ˆæ¯(è„æ¶ˆæ¯) ä¸ä¹Ÿä¼šç´¯åŠ åˆ°ä¸€èµ·å—ï¼Ÿ è¿˜æ˜¯è¯´ logbatchä¼šéªŒè¯æ¶ˆæ¯çš„å®Œæ•´æ€§ä¹‹åå†è¯»å–å‘¢ï¼Ÿ æ„Ÿè°¢è€å¸ˆ","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492875,"discussion_content":"&amp;quot;é‚£æœªå®Œæ•´å†™å…¥çš„æ¶ˆæ¯(è„æ¶ˆæ¯) ä¸ä¹Ÿä¼šç´¯åŠ åˆ°ä¸€èµ·å—ï¼Ÿ&amp;quot;  --- ä¸ä¼šçš„ã€‚èƒ½è¯»åˆ°çš„éƒ½æ˜¯å·²æäº¤çš„å®Œæ•´çš„æ¶ˆæ¯ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587712891,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":209052,"user_name":"huldar","can_delete":false,"product_type":"c1","uid":1396865,"ip_address":"","ucode":"4B2C41B3A6B824","user_header":"https://static001.geekbang.org/account/avatar/00/15/50/81/e9c5a274.jpg","comment_is_top":false,"comment_ctime":1587482892,"is_pvip":false,"replies":[{"id":"78133","content":"è¿™æ˜¯Scalaä¸­çš„setterå’Œgetterå†™æ³•ã€‚ç‰¹åˆ«æ˜¯setterå†™æ³•ä¸Javaå¾ˆä¸ä¸€æ ·ã€‚æ¯”å¦‚ï¼š<br>private var _value = .....<br>def value = _value &#47;&#47; getter<br>def value_= (newVal:Int) = _value = newVal  &#47;&#47; setter","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1587518227,"ip_address":"","comment_id":209052,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1587482892","product_id":100050101,"comment_content":"  def offsetOfMaxTimestampSoFar_=(offset: Long): Unit = _offsetOfMaxTimestampSoFar = Some(offset)<br>  def offsetOfMaxTimestampSoFar: Long = {<br>    if (_offsetOfMaxTimestampSoFar.isEmpty)<br>      _offsetOfMaxTimestampSoFar = Some(timeIndex.lastEntry.offset)<br>    _offsetOfMaxTimestampSoFar.get<br>  }<br>è€å¸ˆ,è¿™ä¸ªæ˜¯Scalaçš„ä»€ä¹ˆç‰¹æ€§å‘¢ ?æ²¡æœ‰çœ‹æ‡‚.è°¢è°¢","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492707,"discussion_content":"è¿™æ˜¯Scalaä¸­çš„setterå’Œgetterå†™æ³•ã€‚ç‰¹åˆ«æ˜¯setterå†™æ³•ä¸Javaå¾ˆä¸ä¸€æ ·ã€‚æ¯”å¦‚ï¼š\nprivate var _value = .....\ndef value = _value // getter\ndef value_= (newVal:Int) = _value = newVal  // setter","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587518227,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":208840,"user_name":"thomas","can_delete":false,"product_type":"c1","uid":1016777,"ip_address":"","ucode":"9AB945308F1B50","user_header":"https://static001.geekbang.org/account/avatar/00/0f/83/c9/5d03981a.jpg","comment_is_top":false,"comment_ctime":1587447577,"is_pvip":true,"replies":[{"id":"78134","content":"å¯¹å¯¹ï¼Œè¿™é‡Œæ˜¯ç¬”è¯¯ã€‚æ˜¯records.sizeInBytesä¸æ˜¯log.sizeInBytesã€‚æ„Ÿè°¢æŒ‡æ­£ï¼Œæˆ‘è®©ç¼–è¾‘å°å§å§ä¿®æ­£ä¸‹~","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1587518431,"ip_address":"","comment_id":208840,"utype":1}],"discussion_count":5,"race_medal":0,"score":"1587447577","product_id":100050101,"comment_content":"ç¬¬ä¸€æ­¥ï¼šåœ¨æºç ä¸­ï¼Œé¦–å…ˆè°ƒç”¨ log.sizeInBytes æ–¹æ³•åˆ¤æ–­è¯¥æ—¥å¿—æ®µæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœæ˜¯ç©ºçš„è¯ï¼Œ Kafka éœ€è¦è®°å½•è¦å†™å…¥æ¶ˆæ¯é›†åˆçš„æœ€å¤§æ—¶é—´æˆ³ï¼Œå¹¶å°†å…¶ä½œä¸ºåé¢æ–°å¢æ—¥å¿—æ®µå€’è®¡æ—¶çš„ä¾æ®ã€‚<br>--------------------------------&gt;<br>è€å¸ˆï¼Œæˆ‘åœ¨appendæºç ä¸­åªçœ‹åˆ° records.sizeInBytes&gt;0, æ²¡æœ‰log.sizeInBytes; è€Œä¸”ä»£ç é€»è¾‘é‡Œåªæœ‰ä¸ºéç©ºçš„é€»è¾‘å—ã€‚è¯·é—®æ˜¯æˆ‘å“ªé‡Œç†è§£é”™äº†å—","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492643,"discussion_content":"å¯¹å¯¹ï¼Œè¿™é‡Œæ˜¯ç¬”è¯¯ã€‚æ˜¯records.sizeInBytesä¸æ˜¯log.sizeInBytesã€‚æ„Ÿè°¢æŒ‡æ­£ï¼Œæˆ‘è®©ç¼–è¾‘å°å§å§ä¿®æ­£ä¸‹~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587518431,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1440394,"avatar":"https://static001.geekbang.org/account/avatar/00/15/fa/8a/d5eaa5c4.jpg","nickname":"Doï¼","note":"","ucode":"C80C0B4C9B6B2A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":245160,"discussion_content":"physicalPosition == 0åº”è¯¥æ˜¯å½“å‰æ—¥å¿—æ®µä¸ºç©ºçš„è¯","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1587651753,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1703222,"avatar":"https://static001.geekbang.org/account/avatar/00/19/fd/36/f947c340.jpg","nickname":"Rogerå®‡","note":"","ucode":"CBA23C01409349","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1440394,"avatar":"https://static001.geekbang.org/account/avatar/00/15/fa/8a/d5eaa5c4.jpg","nickname":"Doï¼","note":"","ucode":"C80C0B4C9B6B2A","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":257732,"discussion_content":"æ‰€ä»¥å¹¶æ²¡æœ‰å†™é”™ï¼Œå°±åº”è¯¥æ˜¯log.sizeInBytes","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588602159,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":245160,"ip_address":""},"score":257732,"extra":""},{"author":{"id":1211223,"avatar":"https://static001.geekbang.org/account/avatar/00/12/7b/57/a9b04544.jpg","nickname":"QQæ€ª","note":"","ucode":"1A39B8433D9208","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1703222,"avatar":"https://static001.geekbang.org/account/avatar/00/19/fd/36/f947c340.jpg","nickname":"Rogerå®‡","note":"","ucode":"CBA23C01409349","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":300840,"discussion_content":"åŒæ„Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598280081,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":257732,"ip_address":""},"score":300840,"extra":""}]},{"author":{"id":1440394,"avatar":"https://static001.geekbang.org/account/avatar/00/15/fa/8a/d5eaa5c4.jpg","nickname":"Doï¼","note":"","ucode":"C80C0B4C9B6B2A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":245116,"discussion_content":"æˆ‘å¯¹æ­¤ä¹Ÿæœ‰ç–‘é—®ï¼šæºç ä¸­è¯´çš„æ˜¯physicalPosition == 0çš„è¯ï¼ŒKafka éœ€è¦è®°å½•è¦å†™å…¥æ¶ˆæ¯é›†åˆçš„æœ€å¤§æ—¶é—´æˆ³ï¼Œå¹¶å°†å…¶ä½œä¸ºåé¢æ–°å¢æ—¥å¿—æ®µå€’è®¡æ—¶çš„ä¾æ®ã€‚å¹¶æ²¡æœ‰æåˆ°å¦‚æœrecords.sizeInBytes=0æ‰è¿›è¡Œä¸Šé¢æ“ä½œã€‚æ‰€ä»¥physicalPosition == 0æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1587650776,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":206879,"user_name":"Kvicii.Y","can_delete":false,"product_type":"c1","uid":1442588,"ip_address":"","ucode":"446BFA633569EA","user_header":"https://static001.geekbang.org/account/avatar/00/16/03/1c/c9fe6738.jpg","comment_is_top":false,"comment_ctime":1586950022,"is_pvip":false,"replies":[{"id":"77316","content":"val truncated = log.sizeInBytes - validBytes<br>validBytesæ˜¯çœŸå®è¯»å–çš„å­—èŠ‚æ•°ï¼Œä»¥è¿™ä¸ªæ•°ä¸ºå‡†","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1587003031,"ip_address":"","comment_id":206879,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1586950022","product_id":100050101,"comment_content":"1.â€œéå†æ‰§è¡Œå®Œæˆåï¼ŒKafka ä¼šå°†æ—¥å¿—æ®µå½“å‰æ€»å­—èŠ‚æ•°å’Œåˆšåˆšç´¯åŠ çš„å·²è¯»å–å­—èŠ‚æ•°è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœå‘ç°å‰è€…æ¯”åè€…å¤§ï¼Œè¯´æ˜æ—¥å¿—æ®µå†™å…¥äº†ä¸€äº›éæ³•æ¶ˆæ¯ï¼Œéœ€è¦æ‰§è¡Œæˆªæ–­æ“ä½œï¼Œå°†æ—¥å¿—æ®µå¤§å°è°ƒæ•´å›åˆæ³•çš„æ•°å€¼â€<br>è¿™ä¸ªéš¾é“ä¸æ˜¯å·²è¯»å–çš„æ¯”æ€»å­—èŠ‚æ•°å¤§æ‰æœ‰é—®é¢˜å—ï¼Ÿä¸æ˜¯å¾ˆç†è§£<br>2.è€å¸ˆä¸å»å¼€ç­æ•™è‹±è¯­å¯æƒœäº†ğŸ¤£ğŸ¤£ğŸ¤£","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":491933,"discussion_content":"val truncated = log.sizeInBytes - validBytes\nvalidBytesæ˜¯çœŸå®è¯»å–çš„å­—èŠ‚æ•°ï¼Œä»¥è¿™ä¸ªæ•°ä¸ºå‡†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587003031,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":206734,"user_name":"Jonah","can_delete":false,"product_type":"c1","uid":1079507,"ip_address":"","ucode":"2C4799BD2FF0DE","user_header":"https://static001.geekbang.org/account/avatar/00/10/78/d3/1dc40aa2.jpg","comment_is_top":false,"comment_ctime":1586923468,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1586923468","product_id":100050101,"comment_content":"å¦‚æœtargetSizeè¶…è¿‡äº†originSizeï¼Œè¯¥æ–¹æ³•ä¼šæŠ¥é”™KafkaException","like_count":0},{"had_liked":false,"id":206634,"user_name":"lujg","can_delete":false,"product_type":"c1","uid":1054963,"ip_address":"","ucode":"6CCCD89A29B06D","user_header":"https://static001.geekbang.org/account/avatar/00/10/18/f3/cd07e64c.jpg","comment_is_top":false,"comment_ctime":1586912408,"is_pvip":true,"replies":[{"id":"77333","content":"æ²¡é”™ï¼","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1587003852,"ip_address":"","comment_id":206634,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1586912408","product_id":100050101,"comment_content":"è¯¾åè®¨è®ºé—®é¢˜ï¼šæŒ‡å®šçš„ä½ç§»å€¼å¤§äºæ—¥å¿—æ®µæœ¬èº«ä¿å­˜çš„æœ€å¤§ä½ç§»å€¼æ—¶ï¼Œæ”¹æ–¹æ³•ä¸ä¼šæœ‰å…¶ä»–åŠ¨ä½œã€‚åœ¨translateOffsetæ–¹æ³•ä¸­å¦‚æœoffsetå¤§äºæ—¥å¿—æ®µæœ€å¤§ä½ç§»æ—¶ä¼šè¿”å›nullã€‚","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":491845,"discussion_content":"æ²¡é”™ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587003852,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":206615,"user_name":"xinxin","can_delete":false,"product_type":"c1","uid":1285617,"ip_address":"","ucode":"52C5D688B10968","user_header":"https://static001.geekbang.org/account/avatar/00/13/9d/f1/05da9c09.jpg","comment_is_top":false,"comment_ctime":1586910773,"is_pvip":false,"replies":[{"id":"77334","content":"åˆ«æ€¥ï¼Œä¸“æ åé¢æœ‰ä¸“é—¨è®²è§£ï¼Œç´¢å¼•éƒ¨åˆ†çš„é©¬ä¸Šå°±æ¥äº†~","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1587003895,"ip_address":"","comment_id":206615,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1586910773","product_id":100050101,"comment_content":"æ±‚åŠ©è€å¸ˆè®²è§£ä¸€ä¸‹æ›´æ–°ç´¢å¼•é¡¹æ–¹æ³•offsetIndex.append(largestOffset, physicalPosition)ä¸­çš„ç»†èŠ‚","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":491842,"discussion_content":"åˆ«æ€¥ï¼Œä¸“æ åé¢æœ‰ä¸“é—¨è®²è§£ï¼Œç´¢å¼•éƒ¨åˆ†çš„é©¬ä¸Šå°±æ¥äº†~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587003895,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":206019,"user_name":"è¿›åŒ–è®º","can_delete":false,"product_type":"c1","uid":1124107,"ip_address":"","ucode":"2865A23392B9F9","user_header":"https://static001.geekbang.org/account/avatar/00/11/27/0b/12dee5ed.jpg","comment_is_top":false,"comment_ctime":1586774244,"is_pvip":true,"replies":[{"id":"76989","content":"åœ¨è¯·æ±‚æ¨¡å—éƒ¨åˆ†ä¼šæœ‰éƒ¨åˆ†æ¶‰åŠ","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1586827781,"ip_address":"","comment_id":206019,"utype":1}],"discussion_count":3,"race_medal":0,"score":"1586774244","product_id":100050101,"comment_content":"è€å¸ˆä¼šè®²è§£kafkaåè®®å®ç°å—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":491643,"discussion_content":"åœ¨è¯·æ±‚æ¨¡å—éƒ¨åˆ†ä¼šæœ‰éƒ¨åˆ†æ¶‰åŠ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586827781,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1433189,"avatar":"https://static001.geekbang.org/account/avatar/00/15/de/65/51147fb6.jpg","nickname":"åŒ—çº¬8â„ƒ","note":"","ucode":"4999F2E037C93C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":233411,"discussion_content":"è€å¸ˆè€å¸ˆèƒ½ç»„å»ºä¸ªè¯»è€…ç¾¤ä¸ï¼Œåƒä¿ºè¿™ç§kafkaæºç éƒ½ä¸‹ä¸ä¸‹æ¥çš„å°ç™½ï¼Œå¸Œæœ›èƒ½å¯»æ±‚å¸®åŠ©ğŸ˜‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586924042,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1453053,"avatar":"https://static001.geekbang.org/account/avatar/00/16/2b/fd/7013289d.jpg","nickname":"æ¸©æ•…è€ŒçŸ¥æ–°å¯ä»¥ä¸ºå¸ˆçŸ£","note":"","ucode":"FADCDFA9F9E5E8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1433189,"avatar":"https://static001.geekbang.org/account/avatar/00/15/de/65/51147fb6.jpg","nickname":"åŒ—çº¬8â„ƒ","note":"","ucode":"4999F2E037C93C","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":286609,"discussion_content":"å¯èƒ½æ€§æ˜¯0","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1593243887,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":233411,"ip_address":""},"score":286609,"extra":""}]}]}]}