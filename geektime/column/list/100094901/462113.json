{"id":462113,"title":"16 | å†…å­˜æ¨¡å‹ï¼šæœ‰äº†MESIä¸ºä»€ä¹ˆè¿˜éœ€è¦å†…å­˜å±éšœï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯æµ·çº³ã€‚</p><p>ä¸Šä¸€èŠ‚è¯¾ï¼Œæˆ‘ä»¬å­¦ä¹ äº†MESIåè®®ï¼Œæˆ‘ä»¬äº†è§£åˆ°ï¼ŒMESIåè®®èƒ½å¤Ÿè§£å†³å¤šæ ¸ CPUä½“ç³»ä¸­ï¼Œå¤šä¸ªCPUä¹‹é—´ç¼“å­˜æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚ä½†æ˜¯ï¼Œå¦‚æœCPUä¸¥æ ¼æŒ‰ç…§MESIåè®®è¿›è¡Œæ ¸é—´é€šè®¯å’ŒåŒæ­¥ï¼Œæ ¸é—´åŒæ­¥å°±ä¼šç»™CPUå¸¦æ¥æ€§èƒ½é—®é¢˜ã€‚æ—¢è¦éµå®ˆåè®®ï¼Œåˆè¦æå‡æ€§èƒ½ï¼Œè¿™å°±å¯¹CPUçš„è®¾è®¡äººå‘˜æå‡ºäº†å·¨å¤§çš„æŒ‘æˆ˜ã€‚</p><p>é‚£ä¸¥æ ¼éµå®ˆMESIåè®®çš„CPUä¼šæœ‰ä»€ä¹ˆæ ·çš„æ€§èƒ½é—®é¢˜å‘¢ï¼Ÿæˆ‘ä»¬åˆå¯ä»¥æ€ä¹ˆæ¥è§£å†³è¿™äº›é—®é¢˜å‘¢ï¼Ÿä»Šå¤©æˆ‘ä»¬å°±æ¥ä»”ç»†åˆ†æä¸€ä¸‹ã€‚ææ¸…æ¥šäº†è¿™äº›é—®é¢˜ï¼Œä½ ä¼šå¯¹C++å†…å­˜æ¨¡å‹å’ŒJavaå†…å­˜æ¨¡å‹æœ‰æ›´åŠ æ·±å…¥çš„ç†è§£ï¼Œåœ¨åˆ†æå¹¶å‘é—®é¢˜æ—¶èƒ½å¤Ÿåšåˆ°æœ‰çš„æ”¾çŸ¢ã€‚</p><h2>ä¸¥å®ˆMESIåè®®çš„CPUä¼šæœ‰å•¥é—®é¢˜ï¼Ÿ</h2><p>æˆ‘ä»¬ä¸ŠèŠ‚è¯¾è¯´è¿‡ï¼ŒMESIä»£è¡¨çš„æ˜¯Modifiedã€Exclusiveã€Sharedã€Invalidè¿™å››ç§ç¼“å­˜çŠ¶æ€ï¼Œéµå®ˆMESIåè®®çš„CPUç¼“å­˜ä¼šåœ¨è¿™å››ç§çŠ¶æ€ä¹‹é—´ç›¸äº’åˆ‡æ¢ã€‚è¿™ç§CPUç¼“å­˜ä¹‹é—´çš„å…³ç³»æ˜¯è¿™æ ·çš„ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/1d/57/1dabf3dccd6113d76b29c05dd3ea3c57.jpg?wh=2284x1407\" alt=\"\"></p><p>ä»ä¸Šé¢è¿™å¼ å›¾ä½ å¯ä»¥çœ‹åˆ°ï¼ŒCacheå’Œä¸»å†…å­˜(Memory)æ˜¯ç›´æ¥ç›¸è¿çš„ã€‚ä¸€ä¸ªCPUçš„æ‰€æœ‰å†™æ“ä½œéƒ½ä¼šæŒ‰ç…§çœŸå®çš„æ‰§è¡Œé¡ºåºåŒæ­¥åˆ°ä¸»å­˜å’Œå…¶ä»–CPUçš„cacheä¸­ã€‚</p><p>ä¸¥æ ¼éµå®ˆMESIåè®®çš„CPUè®¾è®¡ï¼Œåœ¨å®ƒçš„æŸä¸€ä¸ªæ ¸åœ¨å†™ä¸€å—ç¼“å­˜æ—¶ï¼Œå®ƒéœ€è¦é€šçŸ¥æ‰€æœ‰çš„åŒä¼´ï¼šæˆ‘è¦å†™è¿™å—ç¼“å­˜äº†ï¼Œå¦‚æœä½ ä»¬è°æœ‰è¿™å—ç¼“å­˜çš„å‰¯æœ¬ï¼Œè¯·æŠŠå®ƒç½®æˆInvalidçŠ¶æ€ã€‚InvalidçŠ¶æ€æ„å‘³ç€è¯¥ç¼“å­˜å¤±æ•ˆï¼Œå¦‚æœå…¶ä»–CPUå†è®¿é—®è¿™ä¸€ç¼“å­˜åŒºæ—¶ï¼Œå°±ä¼šä»ä¸»å­˜ä¸­åŠ è½½æ­£ç¡®çš„å€¼ã€‚</p><!-- [[[read_end]]] --><p><strong>å‘èµ·å†™è¯·æ±‚çš„CPUä¸­çš„ç¼“å­˜çŠ¶æ€å¯èƒ½æ˜¯Exclusiveã€Modifiedå’ŒShareï¼Œæ¯ä¸ªçŠ¶æ€ä¸‹çš„å¤„ç†æ˜¯ä¸ä¸€æ ·çš„ã€‚</strong></p><p>å¦‚æœç¼“å­˜çŠ¶æ€æ˜¯Exclusiveå’ŒModifiedï¼Œé‚£ä¹ˆCPUä¸€ä¸ªæ ¸ä¿®æ”¹ç¼“å­˜æ—¶ä¸éœ€è¦é€šçŸ¥å…¶ä»–æ ¸ï¼Œè¿™æ˜¯æ¯”è¾ƒå®¹æ˜“çš„ã€‚</p><p>ä½†æ˜¯åœ¨ShareçŠ¶æ€ä¸‹ï¼Œå¦‚æœä¸€ä¸ªæ ¸æƒ³ç‹¬å ç¼“å­˜è¿›è¡Œä¿®æ”¹ï¼Œå°±éœ€è¦å…ˆç»™æ‰€æœ‰ShareçŠ¶æ€çš„åŒä¼´å‘å‡ºInvalidæ¶ˆæ¯ï¼Œç­‰æ‰€æœ‰åŒä¼´ç¡®è®¤å¹¶å›å¤å®ƒâ€œInvalid acknowledgementâ€ä»¥åï¼Œå®ƒæ‰èƒ½æŠŠè¿™å—ç¼“å­˜çš„çŠ¶æ€æ›´æ”¹ä¸ºModifiedï¼Œè¿™æ˜¯ä¿æŒå¤šæ ¸ä¿¡æ¯åŒæ­¥çš„å¿…ç„¶è¦æ±‚ã€‚</p><p>è¿™ä¸ªè¿‡ç¨‹ç›¸å¯¹äºç›´æ¥åœ¨æ ¸å†…ç¼“å­˜é‡Œä¿®æ”¹ç¼“å­˜å†…å®¹ï¼Œéå¸¸æ¼«é•¿ã€‚è¿™ä¹Ÿå°±ä¼šå¯¼è‡´ï¼ŒæŸä¸ªæ ¸è¯·æ±‚ç‹¬å æ—¶é—´æ¯”è¾ƒé•¿ã€‚</p><p>é‚£æ€ä¹ˆæ¥è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ</p><h2>å†™ç¼“å†²ä¸å†™å±éšœ</h2><p>CPUçš„è®¾è®¡è€…ä¸ºæ¯ä¸ªæ ¸éƒ½æ·»åŠ äº†ä¸€ä¸ªåä¸º<strong>store buffer</strong>çš„ç»“æ„ï¼Œstore bufferæ˜¯ç¡¬ä»¶å®ç°çš„ç¼“å†²åŒºï¼Œå®ƒçš„è¯»å†™é€Ÿåº¦æ¯”ç¼“å­˜çš„é€Ÿåº¦æ›´å¿«ï¼Œæ‰€æœ‰é¢å‘ç¼“å­˜çš„å†™æ“ä½œéƒ½ä¼šå…ˆç»è¿‡store bufferã€‚</p><p>ä¸è¿‡ï¼Œç”±äºä¸­æ–‡ææ–™ä¸­ç»å¸¸å°†cacheå’Œbufferéƒ½ç¿»è¯‘æˆç¼“å†²ï¼Œæˆ–è€…ç¼“å­˜ï¼Œå¾ˆå®¹æ˜“æ··æ·†æ¦‚å¿µï¼Œæ‰€ä»¥åœ¨è¿™é‡Œï¼Œæˆ‘æƒ³å¼ºè°ƒä¸€ä¸‹cacheå’Œbufferçš„åŒºåˆ«ã€‚</p><p>cacheè¿™ä¸ªè¯ï¼Œå¾€å¾€æ„å‘³ç€å®ƒæ‰€å­˜å‚¨çš„ä¿¡æ¯æ˜¯å‰¯æœ¬ã€‚cacheä¸­çš„æ•°æ®å³ä½¿ä¸¢å¤±äº†ï¼Œä¹Ÿå¯ä»¥ä»å†…å­˜ä¸­æ‰¾åˆ°åŸå§‹æ•°æ®ï¼ˆä¸è€ƒè™‘è„æ•°æ®çš„æƒ…å†µï¼‰ï¼Œ<strong>cacheå­˜åœ¨çš„æ„ä¹‰æ˜¯åŠ é€ŸæŸ¥æ‰¾</strong>ã€‚</p><p><strong>ä½†æ˜¯bufferæ›´åƒæ˜¯è“„æ°´æ± </strong>ï¼Œä½ å¯ä»¥ç†è§£æˆå®ƒæ˜¯ä¸€ä¸ªæ”¶ä½œä¸šçš„è¯¾ä»£è¡¨ï¼Œè¯¾ä»£è¡¨ä¼šæŠŠæ‰€æœ‰åŒå­¦çš„ä½œä¸šéƒ½æ”¶é›†é½ä»¥åå†ä¸€æ¬¡æ€§åœ°äº¤åˆ°è€å¸ˆé‚£é‡Œã€‚bufferä¸­çš„æ•°æ®æ²¡æœ‰å‰¯æœ¬ï¼Œä¸€æ—¦ä¸¢å¤±å°±å½»åº•ä¸¢å¤±äº†ã€‚store bufferä¹Ÿæ˜¯åŒæ ·çš„é“ç†ï¼Œå®ƒä¼šæ”¶é›†å¤šæ¬¡å†™æ“ä½œï¼Œç„¶ååœ¨åˆé€‚çš„æ—¶æœºè¿›è¡Œæäº¤ã€‚</p><p>å¢åŠ äº†store bufferä»¥åçš„CPUç¼“å­˜ç»“æ„æ˜¯è¿™æ ·çš„ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/fd/a0/fdd8b173b8cea302fb1884a897fbaea0.jpg?wh=2284x1716\" alt=\"\"></p><p>åœ¨è¿™æ ·çš„ç»“æ„é‡Œï¼Œå¦‚æœCPUçš„æŸä¸ªæ ¸å†è¦å¯¹ä¸€ä¸ªå˜é‡è¿›è¡Œèµ‹å€¼ï¼Œå®ƒå°±ä¸å¿…ç­‰åˆ°æ‰€æœ‰çš„åŒä¼´éƒ½ç¡®è®¤å®Œï¼Œè€Œæ˜¯ç›´æ¥æŠŠæ–°çš„å€¼æ”¾å…¥store bufferï¼Œç„¶åå†ç”±store bufferæ…¢æ…¢åœ°å»åšæ ¸é—´åŒæ­¥ï¼Œå¹¶ä¸”å°†æ–°çš„å€¼åˆ·å…¥åˆ°cacheä¸­å»å°±å¥½äº†ã€‚è€Œä¸”ï¼Œæ¯ä¸ªæ ¸çš„store bufferéƒ½æ˜¯ç§æœ‰çš„ï¼Œå…¶ä»–æ ¸ä¸å¯è§ã€‚</p><p>ä¸ºäº†è®©ä½ æ›´å¥½ç†è§£æ ¸é—´åŒæ­¥çš„é—®é¢˜ï¼Œæˆ‘ä»¬ç°åœ¨æ¥ä¸¾ä¸ªä¾‹å­ã€‚æˆ‘ä»¬ä½¿ç”¨ä¸¤ä¸ªCPUï¼Œåˆ†åˆ«å«åšCPU0å’ŒCPU1ï¼Œå…¶ä¸­CPU0è´Ÿè´£å†™æ•°æ®ï¼Œè€ŒCPU1è´Ÿè´£è¯»æ•°æ®ï¼Œæˆ‘ä»¬çœ‹çœ‹åœ¨å¢åŠ äº†store bufferè¿™ä¸ªç»“æ„ä»¥åï¼Œå®ƒä»¬åœ¨è¿›è¡Œæ ¸é—´åŒæ­¥æ—¶ä¼šé‡åˆ°ä»€ä¹ˆé—®é¢˜ã€‚</p><p>å‡å¦‚CPU0åˆšåˆšæ›´æ–°äº†å˜é‡açš„å€¼ï¼Œå¹¶ä¸”å°†å®ƒæ”¾åˆ°äº†store bufferä¸­ï¼ŒCPU0è‡ªå·±æ¥ç€åˆè¦è¯»å–açš„å€¼ï¼Œæ­¤æ—¶ï¼Œå®ƒä¼šåœ¨è‡ªå·±çš„store bufferä¸­è¯»åˆ°æ­£ç¡®çš„å€¼ã€‚</p><p>é‚£å¦‚æœåœ¨è¿™ä¸€æ¬¡ä¿®æ”¹çš„aå€¼è¢«å†™å…¥cacheä¹‹å‰ï¼ŒCPU0åˆä¸€æ¬¡å¯¹aå€¼è¿›è¡Œäº†ä¿®æ”¹å‘¢ï¼Ÿé‚£ä¹Ÿæ²¡é—®é¢˜ï¼Œè¿™æ¬¡æ›´æ–°å°±å¯ä»¥ç›´æ¥å†™å…¥store bufferã€‚å› ä¸ºstore bufferæ˜¯CPU0ç§æœ‰çš„ï¼Œä¿®æ”¹å®ƒä¸æ¶‰åŠä»»ä½•æ ¸é—´åŒæ­¥å’Œç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ï¼Œæ‰€ä»¥æ•ˆç‡ä¹Ÿå¾—åˆ°äº†æ¯”è¾ƒå¤§çš„æå‡ã€‚</p><p>ä½†ç”¨store bufferä¹Ÿä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯<strong>å®ƒå¹¶ä¸èƒ½ä¿è¯å˜é‡å†™å…¥ç¼“å­˜å’Œä¸»å­˜çš„é¡ºåº</strong>ï¼Œä½ å…ˆæ¥çœ‹çœ‹ä¸‹é¢è¿™ä¸ªä»£ç ï¼š</p><pre><code>// CPU0\nvoid foo() {\n    a = 1;\n    b = 1;\n}\n\n// CPU1\nvoid bar() {\n    while (b == 0) continue;\n    assert(a == 1);\n}\n</code></pre><p>ä½ å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¿™ä¸ªä»£ç å—ä¸­ï¼ŒCPU0æ‰§è¡Œfooå‡½æ•°ï¼ŒCPU1æ‰§è¡Œbarå‡½æ•°ã€‚ä½†åœ¨å¯¹å˜é‡aå’Œbè¿›è¡Œèµ‹å€¼çš„æ—¶å€™ï¼Œæœ‰ä¸¤ç§æƒ…å†µä¼šå¯¼è‡´å®ƒä»¬çš„èµ‹å€¼é¡ºåºè¢«æ‰“ä¹±ã€‚</p><p><strong>ç¬¬ä¸€ç§æƒ…å†µæ˜¯CPUçš„ä¹±åºæ‰§è¡Œ</strong>ã€‚åœ¨Cacheçš„åŸºæœ¬åŸç†ä¸€è¯¾ä¸­ï¼Œæˆ‘ä»¬å·²ç»è®²è¿‡CPUä¸ºäº†æå‡è¿è¡Œæ•ˆç‡å’Œæé«˜ç¼“å­˜å‘½ä¸­ç‡ï¼Œé‡‡ç”¨äº†ä¹±åºæ‰§è¡Œã€‚</p><p><strong>ç¬¬äºŒç§æƒ…å†µæ˜¯store bufferåœ¨å†™å…¥æ—¶ï¼Œæœ‰å¯èƒ½bæ‰€å¯¹åº”çš„ç¼“å­˜è¡Œä¼šå…ˆäºaæ‰€å¯¹åº”çš„ç¼“å­˜è¡Œè¿›å…¥ç‹¬å çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯è¯´bä¼šå…ˆå†™å…¥ç¼“å­˜ã€‚</strong></p><p>è¿™ç§æƒ…å†µå®Œå…¨æ˜¯æœ‰å¯èƒ½çš„ã€‚ä½ æƒ³ï¼Œå¦‚æœaæ˜¯ShareçŠ¶æ€ï¼Œbæ˜¯ExclusiveçŠ¶æ€ï¼Œé‚£ä¹ˆå°½ç®¡CPU0åœ¨æ‰§è¡Œæ—¶æ²¡æœ‰ä¹±åºï¼Œè¿™ä¸¤ä¸ªå˜é‡ç”±store bufferå†™å…¥ç¼“å­˜æ—¶ä¹Ÿæ˜¯ä¸èƒ½ä¿è¯é¡ºåºçš„ã€‚</p><p>é‚£è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å‡è®¾CPU1å¼€å§‹æ‰§è¡Œæ—¶ï¼Œaå’Œbæ‰€å¯¹åº”çš„ç¼“å­˜è¡Œéƒ½æ˜¯InvalidçŠ¶æ€ã€‚å½“CPU1å¼€å§‹æ‰§è¡Œç¬¬9è¡Œçš„æ—¶å€™ï¼Œç”±äºbæ‰€å¯¹åº”çš„ç¼“å­˜åŒºåŸŸæ˜¯InvalidçŠ¶æ€ï¼Œå®ƒå°±ä¼šå‘æ€»çº¿å‘å‡ºBusRdè¯·æ±‚ï¼Œé‚£ä¹ˆCPU1å°±ä¼šå…ˆæŠŠbçš„æœ€æ–°å€¼è¯»åˆ°æœ¬åœ°ï¼Œå®Œæˆå˜é‡bçš„å€¼çš„æ›´æ–°ï¼Œä»è€Œè·³å‡ºç¬¬9è¡Œçš„å¾ªç¯ï¼Œç»§ç»­æ‰§è¡Œç¬¬10è¡Œã€‚</p><p>è¿™æ—¶ï¼ŒCPU1çš„aç¼“å­˜åŒºåŸŸä¹Ÿå¤„äºInvalidçŠ¶æ€ï¼Œå®ƒä¹Ÿä¼šäº§ç”ŸBusRdè¯·æ±‚ï¼Œä½†æˆ‘ä»¬å‰é¢åˆ†æè¿‡ï¼ŒCPU0ä¸­å¯¹açš„èµ‹å€¼å¯èƒ½ä¼šæ™šäºbï¼Œæ‰€ä»¥æ­¤æ—¶CPU1åœ¨è¯»å–å˜é‡açš„å€¼æ—¶ï¼ŒåŠ è½½çš„å°±å¯èƒ½æ˜¯è€çš„å€¼ï¼Œä¹Ÿå°±æ˜¯0ï¼Œé‚£è¿™ä¸ªæ—¶å€™ç¬¬10è¡Œçš„assertå°±ä¼šæ‰§è¡Œå¤±è´¥ã€‚</p><p>æˆ‘ä»¬å†ä¸¾ä¸€ä¸ªæ›´æç«¯çš„ä¾‹å­åˆ†æä¸€ä¸‹ï¼š</p><pre><code>// CPU0\nvoid foo() {\n    a = 1;\n    b = a;\n}\n</code></pre><p>è¿™ä¸ªä¾‹å­ä¸­ï¼Œbå’Œaä¹‹é—´å› ä¸ºæœ‰æ•°æ®ä¾èµ–ï¼Œæ˜¯ä¸å¯èƒ½ä¹±åºæ‰§è¡Œçš„ï¼Œè¿™å°±æ„å‘³ç€ä¸Šé¢æˆ‘ä»¬åˆ†æçš„æƒ…å†µä¸€æ˜¯ä¸ä¼šå‘ç”Ÿçš„ã€‚ä½†ç”±äºstore bufferçš„å­˜åœ¨ï¼Œæƒ…å†µäºŒä»ç„¶å¯èƒ½å‘ç”Ÿï¼Œå…¶ç»“æœå°±åƒæˆ‘ä»¬ä¸Šé¢åˆ†æçš„é‚£æ ·ï¼ŒCPUæ‰§è¡Œç¬¬10è¡Œæ—¶ä¼šå¤±è´¥ã€‚è¿™ä¼šè®©äººæ„Ÿåˆ°æ›´åŠ åŒªå¤·æ‰€æ€ã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒCPUè®¾è®¡è€…å°±å¼•å…¥äº†<strong>å†…å­˜å±éšœï¼Œå±éšœçš„ä½œç”¨æ˜¯å‰è¾¹çš„è¯»å†™æ“ä½œæœªå®Œæˆçš„æƒ…å†µä¸‹ï¼Œåé¢çš„è¯»å†™æ“ä½œä¸èƒ½å‘ç”Ÿ</strong>ã€‚è¿™å°±æ˜¯Armä¸ŠdmbæŒ‡ä»¤çš„ç”±æ¥ï¼Œå®ƒæ˜¯æ•°æ®å†…å­˜å±éšœï¼ˆData Memory Barrierï¼‰çš„ç¼©å†™ã€‚</p><p>æˆ‘ä»¬è¿˜æ˜¯ç»§ç»­æ²¿ç”¨å‰é¢CPU0å’ŒCPU1çš„ä¾‹å­ï¼Œä¸è¿‡è¿™ä¸€æ¬¡æˆ‘åŠ å…¥äº†å†…å­˜å±éšœï¼š</p><pre><code>// CPU0\nvoid foo() {\n    a = 1;\n    smp_mb();\n    b = 1;\n}\n\n// CPU1\nvoid bar() {\n    while (b == 0) continue;\n    assert(a == 1);\n}\n</code></pre><p>åœ¨è¿™é‡Œï¼Œsmp_mbå°±ä»£è¡¨äº†å¤šæ ¸ä½“ç³»ç»“æ„ä¸Šçš„å†…å­˜å±éšœã€‚ç”±äºåœ¨ä¸åŒçš„ä½“ç³»ç»“æ„ä¸Šï¼ŒæŒ‡ä»¤å„ä¸ç›¸åŒï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªå‡½æ•°å¯¹å®ƒè¿›è¡Œå°è£…ã€‚åŠ ä¸Šè¿™ä¸€é“å±éšœä»¥åï¼ŒCPUä¼šä¿è¯aå’Œbçš„èµ‹å€¼æŒ‡ä»¤ä¸ä¼šä¹±åºæ‰§è¡Œï¼ŒåŒæ—¶å†™å…¥cacheçš„é¡ºåºä¹Ÿä¸ç¨‹åºä»£ç ä¿æŒä¸€è‡´ã€‚</p><p><strong>æ‰€ä»¥è¯´ï¼Œå†…å­˜å±éšœä¿è¯äº†ï¼Œå…¶ä»–CPUèƒ½è§‚å¯Ÿåˆ°CPU0æŒ‰ç…§æˆ‘ä»¬æœŸæœ›çš„é¡ºåºæ›´æ–°å˜é‡</strong>ã€‚</p><p>æ€»çš„æ¥è¯´ï¼Œstore bufferçš„å­˜åœ¨æ˜¯ä¸ºæå‡å†™æ€§èƒ½ï¼Œæ”¾å¼ƒäº†ç¼“å­˜çš„é¡ºåºä¸€è‡´æ€§ï¼Œæˆ‘ä»¬æŠŠè¿™ç§ç°è±¡ç§°ä¸º<strong>å¼±ç¼“å­˜ä¸€è‡´æ€§</strong>ã€‚åœ¨æ­£å¸¸çš„ç¨‹åºä¸­ï¼Œå¤šä¸ªCPUä¸€èµ·æ“ä½œåŒä¸€ä¸ªå˜é‡çš„æƒ…å†µæ˜¯æ¯”è¾ƒå°‘çš„ï¼Œæ‰€ä»¥store bufferå¯ä»¥å¤§å¤§æå‡ç¨‹åºçš„è¿è¡Œæ€§èƒ½ã€‚ä½†åœ¨éœ€è¦æ ¸é—´åŒæ­¥çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¿˜æ˜¯éœ€è¦è¿™ç§ä¸€è‡´æ€§çš„ï¼Œè¿™å°±éœ€è¦è½¯ä»¶å·¥ç¨‹å¸ˆè‡ªå·±åœ¨åˆé€‚çš„åœ°æ–¹æ·»åŠ å†…å­˜å±éšœäº†ã€‚</p><p>å¥½äº†ï¼Œåˆ°è¿™é‡Œä½ å¯èƒ½ä¹Ÿå‘ç°äº†ï¼Œæˆ‘ä»¬å‰é¢è¯´çš„éƒ½æ˜¯CPUæ ¸é—´åŒæ­¥çš„â€œå†™â€çš„é—®é¢˜ï¼Œä½†æ˜¯æ ¸é—´åŒæ­¥è¿˜æœ‰å¦å¤–ä¸€ä¸ªç“¶é¢ˆï¼Œä¹Ÿå°±æ˜¯â€œè¯»â€çš„é—®é¢˜ã€‚é‚£è¿™ä¸ªåˆè¦æ€ä¹ˆè§£å†³å‘¢ï¼Ÿæˆ‘ä»¬ç°åœ¨å°±æ¥çœ‹çœ‹ã€‚</p><h2>å¤±æ•ˆé˜Ÿåˆ—ä¸è¯»å±éšœ</h2><p>æˆ‘ä»¬å‰é¢è¯´è¿‡ï¼Œå½“ä¸€ä¸ªCPUå‘åŒä¼´å‘å‡ºInvalidæ¶ˆæ¯çš„æ—¶å€™ï¼Œå®ƒçš„åŒä¼´è¦å…ˆæŠŠè‡ªå·±çš„ç¼“å­˜ç½®ä¸ºInvalidï¼Œç„¶åå†å‘å‡ºacknowledgementã€‚è¿™ä¸ªä»â€œæŠŠç¼“å­˜ç½®ä¸ºInvalidâ€åˆ°â€œå‘å‡ºacknowledgementâ€çš„è¿‡ç¨‹æ‰€éœ€è¦çš„æ—¶é—´ä¹Ÿæ˜¯æ¯”è¾ƒé•¿çš„ã€‚</p><p>è€Œä¸”ï¼Œç”±äºstore bufferçš„å­˜åœ¨æå‡äº†å†™å…¥é€Ÿåº¦ï¼Œé‚£ä¹ˆinvalidæ¶ˆæ¯ç¡®è®¤é€Ÿåº¦ç›¸æ¯”èµ·æ¥å°±æ…¢äº†ï¼Œè¿™å°±å¸¦æ¥äº†é€Ÿåº¦çš„ä¸åŒ¹é…ï¼Œå¾ˆå®¹æ˜“å¯¼è‡´store bufferçš„å†…å®¹è¿˜æ²¡æœ‰åŠæ—¶æ›´æ–°åˆ°cacheé‡Œï¼Œè‡ªå·±çš„å®¹é‡å°±è¢«æ’‘çˆ†äº†ï¼Œä»è€Œå¤±å»äº†åŠ é€Ÿçš„ä½œç”¨ã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒCPUè®¾è®¡è€…åˆå¼•å…¥äº†<strong>â€œinvalid queueâ€</strong>ï¼Œä¹Ÿå°±æ˜¯å¤±æ•ˆé˜Ÿåˆ—è¿™ä¸ªç»“æ„ã€‚åŠ å…¥äº†è¿™ä¸ªç»“æ„åï¼Œæ”¶åˆ°Invalidæ¶ˆæ¯çš„CPUï¼Œæ¯”å¦‚æˆ‘ä»¬ç§°å®ƒä¸ºCPU1ï¼Œåœ¨æ”¶åˆ°Invalidæ¶ˆæ¯æ—¶ç«‹å³å‘CPU0å‘å›ç¡®è®¤æ¶ˆæ¯ï¼Œä½†è¿™ä¸ªæ—¶å€™CPU1å¹¶æ²¡æœ‰æŠŠè‡ªå·±çš„cacheç”±Shareç½®ä¸ºInvalidï¼Œè€Œæ˜¯æŠŠè¿™ä¸ªå¤±æ•ˆçš„æ¶ˆæ¯æ”¾åˆ°ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œç­‰åˆ°ç©ºé—²çš„æ—¶å€™å†å»å¤„ç†å¤±æ•ˆæ¶ˆæ¯ï¼Œè¿™ä¸ªé˜Ÿåˆ—å°±æ˜¯invalid queueã€‚</p><p>ç»è¿‡è¿™æ ·çš„æ”¹è¿›åï¼ŒCPU1å“åº”å¤±æ•ˆæ¶ˆæ¯çš„é€Ÿåº¦å¤§å¤§æå‡äº†ï¼Œå¸¦æœ‰invalid queueçš„ç¼“å­˜ç»“æ„æ˜¯è¿™æ ·çš„ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/27/17/277a9efe9e9431c76499813b4f629317.jpg?wh=2284x1803\" alt=\"\"></p><p>æˆ‘ä»¬è¿˜æ˜¯ä»¥å‰é¢CPU0å’ŒCPU1ä¸­çš„ä¾‹å­æ¥åšè¯´æ˜ã€‚</p><p>å‡å¦‚ï¼ŒCPU0å’ŒCPU1çš„ç¼“å­˜ä¸­éƒ½æœ‰å˜é‡açš„å‰¯æœ¬ï¼Œä¹Ÿå°±æ˜¯è¯´å˜é‡aæ‰€å¯¹åº”çš„ç¼“å­˜è¡Œåœ¨CPU0å’ŒCPU1ä¸­éƒ½æ˜¯ShareçŠ¶æ€ã€‚CPU1ä¸­æ²¡æœ‰å˜é‡bçš„å‰¯æœ¬ï¼Œbæ‰€å¯¹åº”ç¼“å­˜åœ¨CPU0ä¸­æ˜¯ExclusiveçŠ¶æ€ã€‚</p><p>å½“CPU0åœ¨å°†å˜é‡aå†™å…¥ç¼“å­˜çš„æ—¶å€™ï¼Œä¼šäº§ç”ŸInvalidæ¶ˆæ¯ï¼Œè¿™ä¸ªæ¶ˆæ¯åˆ°è¾¾CPU1ä»¥åï¼ŒCPU1ä¸å†ç«‹å³å¤„ç†å®ƒäº†ï¼Œè€Œæ˜¯å°†è¿™ä¸ªæ¶ˆæ¯æ”¾å…¥invalid queueï¼Œå¹¶ä¸”ç«‹å³å‘CPU0å›å¤äº†invalid acknowledgementæ¶ˆæ¯ã€‚</p><p>CPU0åœ¨å¾—åˆ°è¿™ä¸ªç¡®è®¤æ¶ˆæ¯ä»¥åï¼Œå°±å¯ä»¥ç‹¬å è¯¥ç¼“å­˜äº†ï¼Œç›´æ¥å°†è¿™å—ç¼“å­˜å˜ä¸ºModifiedçŠ¶æ€ï¼Œç„¶åæŠŠaå†™å…¥ã€‚åœ¨aå†™å…¥ä»¥åï¼Œfooå‡½æ•°ä¸­çš„å†…å­˜å±éšœå°±å¯ä»¥é¡ºåˆ©é€šè¿‡äº†ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥å†™å…¥å˜é‡bçš„æ–°å€¼ã€‚ç”±äºbæ˜¯Exclusiveçš„ï¼Œå®ƒçš„æ›´æ–°æ¯”è¾ƒç®€å•ï¼Œä½ å¯ä»¥è‡ªå·±æ€è€ƒä¸€ä¸‹ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬å†çœ‹CPU1ä¸­çš„æ“ä½œã€‚</p><p>å½“CPU1å‘èµ·å¯¹bçš„è¯·æ±‚æ—¶ï¼Œç”±äºbä¸åœ¨ç¼“å­˜ä¸­ï¼Œæ‰€ä»¥å®ƒä¼šå‘æ€»çº¿å‘å‡ºBusRdè¯·æ±‚ï¼Œæ€»çº¿ä¼šæŠŠCPU0ç¼“å­˜ä¸­çš„bçš„æ–°å€¼1æ›´æ–°åˆ°CPU1ã€‚åŒæ—¶ï¼Œbæ‰€åœ¨çš„ç¼“å­˜è¡Œåœ¨ä¸¤ä¸ªCPUä¸­éƒ½å˜ä¸ºShareçŠ¶æ€ã€‚</p><p>CPU1å¾—åˆ°äº†bçš„æ–°å€¼ä»¥åï¼Œå°±å¯ä»¥é€€å‡ºç¬¬10è¡Œçš„whileå¾ªç¯ï¼Œç„¶åå¯¹açš„å€¼è¿›è¡Œåˆ¤æ–­ã€‚ä½†æ˜¯ç”±äºaçš„Invalidæ¶ˆæ¯è¿˜åœ¨invalid queueé‡Œï¼Œæ²¡æœ‰è¢«åŠæ—¶å¤„ç†ï¼ŒCPU1è¿˜æ˜¯ä¼šä½¿ç”¨è‡ªå·±çš„Cacheä¸­çš„açš„åŸæ¥çš„å€¼ï¼Œä¹Ÿå°±æ˜¯0ï¼Œè¿™å°±å‡ºé”™äº†ã€‚</p><p><strong>ä½ ä¼šå‘ç°ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œè™½ç„¶CPU1å¹¶æ²¡æœ‰ä¹±åºæ‰§è¡Œä¸¤æ¡è¯»æŒ‡ä»¤ï¼Œä½†æ˜¯å®é™…äº§ç”Ÿçš„æ•ˆæœå´å¥½åƒæ˜¯å…ˆè¯»åˆ°äº†bçš„å€¼ï¼Œåè¯»åˆ°äº†açš„å€¼</strong>ã€‚å¦‚æœæ˜¯åœ¨ä¸¥æ ¼éµå®ˆMESIåè®®çš„CPUä¸­ï¼ŒCPU0ä¸€å®šè¦ç¡®ä¿açš„å€¼å…ˆæ›´æ–°åˆ°CPU1ï¼Œç„¶åæ‰èƒ½ç»§ç»­å¯¹bèµ‹å€¼ã€‚ä½†æ˜¯æ”¾å®½äº†ç¼“å­˜ä¸€è‡´æ€§ä»¥åï¼Œè¿™æ®µä»£ç å°±æœ‰é—®é¢˜äº†ã€‚</p><p>è§£å†³çš„æ–¹æ³•å’Œå†™å±éšœçš„æ€è·¯æ˜¯ä¸€æ ·çš„ï¼Œæˆ‘ä»¬éœ€è¦å¼•å…¥ä¸€ä¸ªå†…å­˜å±éšœï¼Œå®ƒä¼šè®©CPUæš‚åœæ‰§è¡Œï¼Œç›´åˆ°å®ƒå¤„ç†å®Œinvalid queueä¸­çš„å¤±æ•ˆæ¶ˆæ¯ä¹‹åï¼ŒCPUæ‰ä¼šé‡æ–°å¼€å§‹æ‰§è¡Œï¼Œä¾‹å¦‚ï¼š</p><pre><code>// CPU0\nvoid foo() {\n    a = 1;\n    smp_mb();\n    b = 1;\n}\n\n// CPU1\nvoid bar() {\n    while (b == 0) continue;\n    smp_mb();\n    assert(a == 1);\n}\n</code></pre><p>ä½ çœ‹ï¼Œè¿™æ ·åœ¨barå‡½æ•°é‡Œå¢åŠ äº†å†…å­˜å±éšœä»¥åï¼Œæˆ‘ä»¬å°±å¯ä»¥ä¿è¯açš„æ–°å€¼æ˜¯ä¸€å®šèƒ½è¯»åˆ°çš„äº†ã€‚å¯è§smp_mbå¯ä»¥åŒæ—¶å¯¹store bufferå’Œinvalid queueæ–½åŠ å½±å“ã€‚</p><p>ä¸è¿‡å‘¢ï¼Œä½ å¯èƒ½ä¹Ÿä¼šå‘ç°ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå…¶å®æˆ‘ä»¬ä¹Ÿä¸éœ€è¦smp_mbæœ‰é‚£ä¹ˆå¤§çš„ä½œç”¨ã€‚æˆ‘ä»¬åªéœ€è¦åœ¨ç¬¬4è¡Œä¿è¯store bufferå†™å…¥çš„é¡ºåºï¼Œåœ¨ç¬¬11è¡Œä¿è¯invalid queueçš„é¡ºåºå°±å¥½äº†ã€‚æ‰€ä»¥smp_mbç›¸å¯¹äºæˆ‘ä»¬çš„éœ€æ±‚æ¥è¯´ï¼Œåšçš„äº‹æƒ…è¿‡å¤šäº†ï¼Œè¿™ä¹Ÿä¼šå¯¼è‡´ä¸å¿…è¦çš„æ€§èƒ½ä¸‹é™ã€‚é¢å¯¹è¿™ç§æƒ…å†µï¼ŒCPUçš„è®¾è®¡è€…ä¹Ÿè¿›ä¸€æ­¥æä¾›äº†å•ç‹¬çš„å†™å±éšœå’Œè¯»å±éšœã€‚</p><h2>è¯»å†™å±éšœåˆ†ç¦»</h2><p>åˆ†ç¦»çš„å†™å±éšœå’Œè¯»å±éšœçš„å‡ºç°ï¼Œæ˜¯ä¸ºäº†<strong>æ›´åŠ ç²¾ç»†åœ°æ§åˆ¶store bufferå’Œinvalid queueçš„é¡ºåº</strong>ã€‚</p><p>å†å…·ä½“ä¸€ç‚¹ï¼Œå†™å±éšœçš„ä½œç”¨æ˜¯è®©å±éšœå‰åçš„å†™æ“ä½œéƒ½ä¸èƒ½ç¿»è¿‡å±éšœã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå†™å±éšœä¹‹å‰çš„å†™æ“ä½œä¸€å®šä¼šæ¯”ä¹‹åçš„å†™æ“ä½œå…ˆå†™åˆ°ç¼“å­˜ä¸­ã€‚</p><p>è¯»å±éšœçš„ä½œç”¨ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œå°±æ˜¯ä¿è¯å±éšœå‰åçš„è¯»æ“ä½œéƒ½ä¸èƒ½ç¿»è¿‡å±éšœã€‚å‡å¦‚å±éšœçš„å‰åéƒ½æœ‰ç¼“å­˜å¤±æ•ˆçš„ä¿¡æ¯ï¼Œé‚£å±éšœä¹‹å‰çš„å¤±æ•ˆä¿¡æ¯ä¸€å®šä¼šä¼˜å…ˆå¤„ç†ï¼Œä¹Ÿå°±æ„å‘³ç€å˜é‡çš„æ–°å€¼ä¸€å®šä¼šè¢«ä¼˜å…ˆæ›´æ–°ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬è®¨è®ºçš„éƒ½æ˜¯è¯»å†™å±éšœå¯¹store bufferå’Œinvalid queueçš„å½±å“ã€‚å…¶å®ï¼Œè¿™é‡Œè¿˜éšå«äº†ä¸€ä¸ªäº‹å®ï¼Œé‚£å°±æ˜¯å¯¹CPUä¹±åºæ‰§è¡Œçš„å½±å“ï¼š<strong>å†™å±éšœä¼šç¦æ­¢å†™æ“ä½œçš„ä¹±åº</strong>ã€‚</p><p>è¿™ä¸ªè¦æ±‚è™½ç„¶æ˜¯éšå«çš„ï¼Œä½†ä»”ç»†æƒ³ä¸€ä¸‹å´æ˜¯æ˜¾ç„¶çš„ï¼Œç†ç”±å¾ˆç®€å•ã€‚ä½ æƒ³ï¼Œå¦‚æœæŸä¸ªCPUåœ¨è¿›è¡Œå†™æ“ä½œçš„æ—¶å€™ï¼Œå®é™…çš„æ‰§è¡Œé¡ºåºéƒ½æ˜¯ä¹±åºçš„è¯ï¼Œé‚£æˆ‘ä»¬æ ¹æœ¬å°±æ— æ³•è®¨è®ºæ–°çš„å€¼ä»€ä¹ˆæ—¶å€™ä¼ é€’åˆ°å…¶ä»–CPUã€‚</p><p>è€Œä¸”ï¼Œåˆ†ç¦»çš„è¯»å†™å±éšœè¿˜æœ‰ä¸€ä¸ªå¥½å¤„ï¼Œå°±æ˜¯å®ƒå¯ä»¥åœ¨éœ€è¦ä½¿ç”¨å†™å±éšœçš„æ—¶å€™åªä½¿ç”¨å†™å±éšœï¼Œä¸ä¼šç»™è¯»æ“ä½œå¸¦æ¥è´Ÿé¢çš„å½±å“ï¼Œè¿™ç§å±éšœä¹Ÿå¯ä»¥ç§°ä¸ºStoreStore barrierã€‚åŒç†ï¼Œåªä½¿ç”¨è¯»å±éšœä¹Ÿä¸ä¼šå¯¹å†™æ“ä½œé€ æˆå½±å“ï¼Œè¿™ç§å±éšœä¹Ÿå¯ä»¥ç§°ä¸ºLoadLoad barrierã€‚ä¾‹å¦‚æˆ‘ä»¬å‰é¢CPU0å’ŒCPU1çš„ä¾‹å­ï¼Œå°±å¯ä»¥è¿›ä¸€æ­¥ä¿®æ”¹æˆè¿™æ ·ï¼š</p><pre><code>// CPU0\nvoid foo() {\n    a = 1;\n    smp_wmb();\n    b = 1;\n}\n\n// CPU1\nvoid bar() {\n    while (b == 0) continue;\n    smp_rmb();\n    assert(a == 1);\n}\n</code></pre><p>å½“ç„¶ï¼Œè¿™ç§ä¿®æ”¹åªæœ‰åœ¨åŒºåˆ†è¯»å†™å±éšœçš„ä½“ç³»ç»“æ„é‡Œæ‰ä¼šæœ‰ä½œç”¨ï¼Œæ¯”å¦‚alphaç»“æ„ã€‚è€Œåœ¨X86å’ŒArmä¸­æ˜¯æ²¡æœ‰ä½œç”¨çš„ï¼Œè¿™æ˜¯å› ä¸ºX86é‡‡ç”¨çš„TSOæ¨¡å‹ä¸å­˜åœ¨ç¼“å­˜ä¸€è‡´æ€§çš„é—®é¢˜ï¼Œè€ŒArmåˆ™æ˜¯é‡‡ç”¨äº†å¦ä¸€ç§ç§°ä¸ºå•å‘å±éšœçš„åˆ†ç±»æ–¹å¼ã€‚è¿™ç§å•å‘å±éšœæ˜¯æ€æ ·çš„å‘¢ï¼Ÿæˆ‘ä»¬ä¹Ÿæ¥ç®€å•åˆ†æä¸€ä¸‹ã€‚</p><h2>å•å‘å±éšœ</h2><p>å•å‘å±éšœ(half-way barrier)ä¹Ÿæ˜¯ä¸€ç§å†…å­˜å±éšœï¼Œä½†å®ƒå¹¶ä¸æ˜¯ä»¥è¯»å†™æ¥åŒºåˆ†çš„ï¼Œè€Œæ˜¯<strong>åƒå•è¡Œé“ä¸€æ ·ï¼Œåªå…è®¸å•å‘é€šè¡Œ</strong>ï¼Œä¾‹å¦‚Armä¸­çš„stlrå’ŒldaræŒ‡ä»¤å°±æ˜¯è¿™æ ·ã€‚</p><p>stlrçš„å…¨ç§°æ˜¯store release registerï¼Œä¹Ÿå°±æ˜¯ä»¥releaseè¯­ä¹‰å°†å¯„å­˜å™¨çš„å€¼å†™å…¥å†…å­˜ï¼›ldarçš„å…¨ç§°æ˜¯load acquire registerï¼Œä¹Ÿå°±æ˜¯ä»¥acquireè¯­ä¹‰ä»å†…å­˜ä¸­å°†å€¼åŠ è½½å…¥å¯„å­˜å™¨ã€‚æˆ‘ä»¬é‡ç‚¹å°±æ¥çœ‹çœ‹releaseå’Œacquireè¯­ä¹‰ã€‚</p><p>é¦–å…ˆæ˜¯<strong>releaseè¯­ä¹‰</strong>ã€‚å¦‚æœæˆ‘ä»¬é‡‡ç”¨äº†å¸¦æœ‰releaseè¯­ä¹‰çš„å†™å†…å­˜æŒ‡ä»¤ï¼Œé‚£ä¹ˆè¿™ä¸ªå±éšœä¹‹å‰çš„æ‰€æœ‰è¯»å†™éƒ½ä¸èƒ½å‘ç”Ÿåœ¨è¿™æ¬¡å†™æ“ä½œä¹‹åï¼Œç›¸å½“äºåœ¨è¿™æ¬¡å†™æ“ä½œä¹‹å‰æ–½åŠ äº†ä¸€ä¸ªå†…å­˜å±éšœã€‚ä½†å®ƒå¹¶ä¸èƒ½ä¿è¯å±éšœä¹‹åçš„è¯»å†™æ“ä½œä¸ä¼šå‰ç§»ã€‚ç®€å•è¯´ï¼Œå®ƒçš„ç‰¹ç‚¹æ˜¯<strong>æŒ¡å‰ä¸æŒ¡å</strong>ã€‚</p><p>åœ¨æ”¯æŒä¹±åºæ‰§è¡Œçš„CPUï¼ˆå½“å‰é«˜æ€§èƒ½å¤šæ ¸CPUåŸºæœ¬éƒ½æ”¯æŒä¹±åºæ‰§è¡Œï¼‰ä¸­ï¼Œä½¿ç”¨releaseè¯­ä¹‰çš„å†™å†…å­˜æŒ‡ä»¤æ¯”ä½¿ç”¨å…¨é‡çš„dmbè¦æœ‰æ›´å¥½çš„æ€§èƒ½ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒstlræŒ‡ä»¤é™¤äº†å…·æœ‰StoreStoreçš„åŠŸèƒ½ï¼Œå®ƒåŒæ—¶è¿˜æœ‰LoadStoreçš„åŠŸèƒ½ã€‚LoadStore barrierå¯ä»¥è§£å†³çš„é—®é¢˜æ˜¯çœŸå®åœºæ™¯ä¸­æ¯”è¾ƒå°‘è§çš„ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œæˆ‘ä»¬å°±å…ˆä¸å…³å¿ƒå®ƒäº†ã€‚å¯¹äºæœ€å¸¸ç”¨çš„StoreStoreçš„é—®é¢˜ï¼Œæˆ‘ä»¬åœ¨Armä¸­ç»å¸¸ä½¿ç”¨stlrè¿™æ¡å¸¦æœ‰releaseè¯­ä¹‰çš„å†™æŒ‡ä»¤æ¥è§£å†³ï¼Œå°½ç®¡å®ƒçš„èƒ½åŠ›ç›¸æ¯”æˆ‘ä»¬çš„è¯‰æ±‚è¿˜æ˜¯å¤§äº†ä¸€äº›ã€‚</p><p>æ¥ç€æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹ä¸releaseè¯­ä¹‰ç›¸å¯¹åº”çš„<strong>acquireè¯­ä¹‰</strong>ã€‚å®ƒçš„ä½œç”¨æ˜¯è¿™ä¸ªå±éšœä¹‹åçš„æ‰€æœ‰è¯»å†™éƒ½ä¸èƒ½å‘ç”Ÿåœ¨barrierä¹‹å‰ï¼Œä½†å®ƒä¸ç®¡è¿™ä¸ªå±éšœä¹‹å‰çš„è¯»å†™æ“ä½œã€‚ç®€å•è¯´å°±æ˜¯<strong>æŒ¡åä¸æŒ¡å‰</strong>ã€‚</p><p>ä¸stlrç›¸å¯¹ç§°çš„æ˜¯ï¼Œå®ƒåŒæ—¶å…·å¤‡LoadLoad barrierçš„èƒ½åŠ›å’ŒStoreLoad barrierçš„èƒ½åŠ›ã€‚åœ¨å®é™…åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨æœ€å¤šçš„è¿˜æ˜¯LoadLoad barrierï¼Œæ­¤æ—¶æˆ‘ä»¬ä¼šä½¿ç”¨ldaræ¥ä»£æ›¿ã€‚</p><h2>æ€»ç»“</h2><p>å¥½äº†ï¼Œä»Šå¤©æˆ‘ä»¬è¿™èŠ‚è¯¾çš„å†…å®¹å°±è®²å®Œäº†ï¼Œæˆ‘ä»¬ç®€å•å›é¡¾ä¸€ä¸‹ã€‚</p><p>åœ¨è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬è®²è§£äº†åœ¨CPUçš„å…·ä½“å®ç°ä¸­ï¼Œé€šè¿‡æ”¾å®½MESIåè®®çš„é™åˆ¶æ¥è·å¾—æ€§èƒ½æå‡ã€‚å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬å¼•å…¥äº†store bufferå’Œ invalid queueï¼Œå®ƒä»¬é‡‡ç”¨æ”¾å®½MESIåè®®è¦æ±‚çš„åŠæ³•ï¼Œæå‡äº†å†™ç¼“å­˜æ ¸é—´åŒæ­¥çš„é€Ÿåº¦ï¼Œä»è€Œæå‡äº†ç¨‹åºæ•´ä½“çš„è¿è¡Œé€Ÿåº¦ã€‚</p><p>ä½†åœ¨è¿™æ”¾å®½çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿçœ‹åˆ°ä¼šä¸æ–­åœ°å‡ºç°æ–°çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªCPUçš„è¯»å†™æ“ä½œåœ¨å…¶ä»–CPUçœ‹æ¥å‡ºç°äº†ä¹±åºã€‚ç”šè‡³ï¼Œå³ä½¿æ‰§è¡Œå†™æ“ä½œçš„CPUå¹¶æ²¡æœ‰ä¹±åºæ‰§è¡Œï¼Œä½†æ˜¯å…¶ä»–CPUè§‚å¯Ÿåˆ°çš„å˜é‡æ›´æ–°é¡ºåºç¡®å®æ˜¯ä¹±åºçš„ã€‚è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±å¿…é¡»åŠ å…¥å†…å­˜å±éšœæ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><p>æœ€åæˆ‘ä»¬ä¹Ÿå­¦ä¹ äº†è¯»å†™å±éšœåˆ†ç¦»å’Œå•å‘å±éšœã€‚åœ¨ä¸åŒçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦çš„å†…å­˜å±éšœæ˜¯ä¸åŒçš„ã€‚ä½¿ç”¨åŠŸèƒ½å¼ºå¤§çš„å†…å­˜å±éšœä¼šç»™ç³»ç»Ÿå¸¦æ¥ä¸å¿…è¦çš„æ€§èƒ½ä¸‹é™ï¼Œä¸ºäº†æ›´ç²¾ç»†åœ°åŒºåˆ†ä¸åŒç±»å‹çš„å±éšœï¼ŒCPUçš„è®¾è®¡è€…ä»¬æä¾›äº†åˆ†ç¦»çš„è¯»å†™å±éšœ(alpha)ï¼Œæˆ–è€…æ˜¯å•å‘å±éšœ(Arm)ã€‚</p><p>å¦‚ä½•æ­£ç¡®åœ°ä½¿ç”¨å†…å­˜å±éšœæ˜¯ä¸€ä»¶å¾ˆè€ƒéªŒåŠŸåº•çš„äº‹æƒ…ï¼Œå¦‚æœè¯¥åŠ çš„åœ°æ–¹æ²¡åŠ ï¼Œä¼šå¸¦æ¥éå¸¸ä¸¥é‡çš„æ­£ç¡®æ€§é—®é¢˜ã€‚åœ¨æ“ä½œç³»ç»Ÿï¼Œæ•°æ®åº“ï¼Œç¼–è¯‘å™¨ç­‰é¢†åŸŸï¼Œä¼šäº§ç”Ÿéå¸¸æ·±è¿œçš„å½±å“ï¼Œå…¶ä»£ä»·ç”šè‡³æ˜¯å®Œå…¨æ— æ³•æ¥å—çš„ã€‚è€Œåœ¨ä¸éœ€è¦åŠ çš„åœ°æ–¹ï¼Œå¦‚æœä½ æ–½åŠ äº†æ¯”è¾ƒé‡çš„å±éšœåˆ™å¯èƒ½å¸¦æ¥æ€§èƒ½ä¸‹é™ï¼Œæˆä¸ºç³»ç»Ÿç“¶é¢ˆã€‚å…³äºè¯»å†™å±éšœæ›´å¤šçš„å®é™…åº”ç”¨æ¡ˆä¾‹ï¼Œä½ å¯ä»¥å‚è€ƒä¸‹æˆ‘ä»¬åä¸ºJDKå…¬ä¼—å·å‘å¸ƒçš„<a href=\"https://mp.weixin.qq.com/s/74c5PYvUC2UoacQKRmpNfw\">è¿™ç¯‡æ–‡ç« </a>ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>å‡å¦‚ä»¥ä¸‹ä»£ç æ˜¯Javaä»£ç ï¼Œä½ å¯ä»¥çœ‹åˆ°ï¼Œä»£ç ä¸­é‡‡ç”¨äº†full fenceæ¥ä¿è¯ç¼“å­˜ä¸€è‡´æ€§ã€‚è¯·é˜…è¯»Javaçš„<a href=\"http://openjdk.java.net/jeps/171\">ç›¸å…³APIæ–‡æ¡£</a>å¹¶æ€è€ƒï¼ŒfullFenceæ˜¯å¦åˆç†ï¼Ÿå¦‚æœä¸åˆç†ï¼Œåº”è¯¥ä½¿ç”¨å“ªä¸ªAPIå¯¹å®ƒè¿›è¡Œæ›¿ä»£å‘¢ï¼Ÿæ¬¢è¿åœ¨ç•™è¨€åŒºåˆ†äº«ä½ çš„æƒ³æ³•ï¼Œæˆ‘åœ¨ç•™è¨€åŒºç­‰ä½ ã€‚</p><pre><code>// CPU0\nvoid foo() {\n    a = 1;\n    unsafe.fullFence();\n    b = 1;\n}\n\n// CPU1\nvoid bar() {\n    while (b == 0) continue;\n    unsafe.fullFence();\n    assert(a == 1);\n}\n</code></pre><p>å…¶å®ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œä¸Šé¢è¿™æ®µä»£ç è¿˜æœ‰ä¸€ç§æ”¹æ³•ã€‚æˆ‘ç»™ä½ ä¸€ä¸ªå°æç¤ºï¼Œå°±æ˜¯ä½¿ç”¨volatileå…³é”®å­—ã€‚æˆ‘ä»¬ä¼šåœ¨ç¬¬17è¯¾å¯¹volatileå…³é”®å­—è¿›è¡Œè®²è§£ï¼Œå¦‚æœä½ æœ‰å…´è¶£ä¹Ÿå¯ä»¥æå‰é¢„ä¹ ä¸€ä¸‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/3d/5f/3da3d49a6f7f24889ff20902b2a0425f.jpg?wh=2284x1176\" alt=\"\"></p><p>æ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™æ›´å¤šå¯¹MESIåè®®å’Œå†…å­˜å±éšœæ„Ÿå…´è¶£çš„äººã€‚æˆ‘æ˜¯æµ·çº³ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ã€‚</p>","comments":[{"had_liked":false,"id":325764,"user_name":"è‹è¶…","can_delete":false,"product_type":"c1","uid":1025718,"ip_address":"","ucode":"46D659C89BA8C4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/a6/b6/27412d76.jpg","comment_is_top":false,"comment_ctime":1639122010,"is_pvip":false,"replies":[{"id":"118175","content":"æ€»ç»“å¾—å¾ˆå¥½å‘€ã€‚è¿™å°±æ˜¯æ•´ä¸ªç¡¬ä»¶ç¯‡çš„å†…åœ¨é€»è¾‘ã€‚æ„ŸåŠ¨~","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1360512","ctime":1639133291,"ip_address":"","comment_id":325764,"utype":1}],"discussion_count":1,"race_medal":0,"score":"53178729562","product_id":100094901,"comment_content":"CPU ä»å•æ ¸å‘å±•ä¸ºå¤šæ ¸ï¼Œå¢åŠ ç¼“å­˜ï¼Œå¯¼è‡´å‡ºç°äº†å¤šä¸ªæ ¸é—´çš„ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ --&gt; ä¸ºäº†è§£å†³ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ï¼Œæå‡ºäº† MESI åè®® --&gt; å®Œå…¨éµå®ˆ MESI åˆä¼šç»™ CPU å¸¦æ¥æ€§èƒ½é—®é¢˜ --&gt; CPU è®¾è®¡è€…åˆå¢åŠ  store buffer å’Œ invalid queue --&gt; åˆå¯¼è‡´äº†ç¼“å­˜çš„é¡ºåºä¸€è‡´æ€§å˜ä¸ºäº†å¼±ç¼“å­˜ä¸€è‡´æ€§ --&gt; éœ€è¦ç¼“å­˜çš„é¡ºåºä¸€è‡´æ€§çš„ï¼Œå°±éœ€è¦è½¯ä»¶å·¥ç¨‹å¸ˆè‡ªå·±åœ¨åˆé€‚çš„åœ°æ–¹æ·»åŠ å†…å­˜å±éšœ","like_count":12,"discussions":[{"author":{"id":1360512,"avatar":"https://static001.geekbang.org/account/avatar/00/14/c2/80/6ebf32e8.jpg","nickname":"æµ·çº³","note":"","ucode":"AB9F7ADB1428D2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":537665,"discussion_content":"æ€»ç»“å¾—å¾ˆå¥½å‘€ã€‚è¿™å°±æ˜¯æ•´ä¸ªç¡¬ä»¶ç¯‡çš„å†…åœ¨é€»è¾‘ã€‚æ„ŸåŠ¨~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639133291,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":325069,"user_name":".","can_delete":false,"product_type":"c1","uid":1335848,"ip_address":"","ucode":"C0541289C44AF8","user_header":"https://static001.geekbang.org/account/avatar/00/14/62/28/0356880b.jpg","comment_is_top":false,"comment_ctime":1638795636,"is_pvip":false,"replies":[{"id":"118023","content":"èµï¼è¿™å°±å­¦å¾—å¾ˆæ·±å…¥äº†ã€‚æˆ‘è¿™é‡Œç®€åŒ–äº†æè¿°ï¼ŒTSOæ¨¡å‹å”¯ä¸€éœ€è¦çš„æ˜¯StoreLoad    barrierï¼Œä½†å®ƒäº§ç”Ÿçš„åŸå› ä¸æ˜¯ç¼“å­˜ä¸€è‡´æ€§ã€‚ æ‰€ä»¥x86ä¸Šé‡åˆ°éœ€è¦StoreLoad barrierçš„åœ°æ–¹ï¼Œè¿˜è¦æ˜¯æ­£ç¡®æ·»åŠ æ‰å¯ä»¥ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1360512","ctime":1638869084,"ip_address":"","comment_id":325069,"utype":1}],"discussion_count":4,"race_medal":0,"score":"23113632116","product_id":100094901,"comment_content":"æˆ‘çœ‹äº†ä¸€äº›æ–‡çŒ®å…³äºX86ï¼ˆtotal store ordering ï¼‰åŠ ä¸Šè‡ªå·±çš„ç†è§£ï¼š<br><br>1ï¼‰ç”±äºä¸å­˜åœ¨invalidate queueä¸”è¯»å’Œè¯»ä¹‹é—´ä¸ä¼šé‡æ’åºåˆ‡è¯»çº¿ç¨‹ä¼šå…ˆè¯»å–store bufferï¼Œå› æ­¤LoadLoadå±éšœåœ¨x86æ˜¯æ— ç”¨çš„<br>2ï¼‰ç”±äºstore buffersæ˜¯é‡‡ç”¨é˜Ÿåˆ—ä¸”ä¸åŒåœ°å€çš„å†™æ˜¯ä¸ä¼šé‡æ’åºå› æ­¤StoreStore å¯ä¸å­˜åœ¨<br>3ï¼‰è¯»å¯ä»¥ä¸ä¹‹å‰åŒä½ç½®æ’åºï¼Œä½†ä¸èƒ½ä¸éåŒä½ç½®é‡æ’åºï¼ˆæˆ‘åœ¨wikiæœä¸åˆ°è¿™ä¸ªå±éšœå¤šçº¿ç¨‹é—®é¢˜ï¼Œå…³äºè¿™ä¸ªå¤šçº¿ç¨‹å®é™…åº”ç”¨åœºæ™¯ä¸æ˜ç¡®ï¼‰ LoadStoreä¹Ÿæ²¡æœ‰äº†æ„ä¹‰<br>4ï¼‰ä½†æ˜¯å†™å¯èƒ½ä¸ä¹‹å‰çš„è¯»é‡æ’åºå› æ­¤éœ€è¦ç‰¹åˆ«è€ƒè™‘è¿™ç§é‡æ’åºï¼ŒStoreLoadå­˜åœ¨æ„ä¹‰ ä¸”å­˜åœ¨å¯è¡Œæ€§é—®é¢˜ï¼ˆä½†æ˜¯è€å¸ˆè¯´TSOä¸å­˜åœ¨ç¼“å­˜ä¸€è‡´æ€§æˆ‘ä¸å¤§ç†è§£è¿™ä¸ªåœ¨StoreLoadæ˜¯å¦ä¹Ÿæ˜¯æˆç«‹ï¼‰","like_count":5,"discussions":[{"author":{"id":1360512,"avatar":"https://static001.geekbang.org/account/avatar/00/14/c2/80/6ebf32e8.jpg","nickname":"æµ·çº³","note":"","ucode":"AB9F7ADB1428D2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":536796,"discussion_content":"èµï¼è¿™å°±å­¦å¾—å¾ˆæ·±å…¥äº†ã€‚æˆ‘è¿™é‡Œç®€åŒ–äº†æè¿°ï¼ŒTSOæ¨¡å‹å”¯ä¸€éœ€è¦çš„æ˜¯StoreLoad    barrierï¼Œä½†å®ƒäº§ç”Ÿçš„åŸå› ä¸æ˜¯ç¼“å­˜ä¸€è‡´æ€§ã€‚ æ‰€ä»¥x86ä¸Šé‡åˆ°éœ€è¦StoreLoad barrierçš„åœ°æ–¹ï¼Œè¿˜è¦æ˜¯æ­£ç¡®æ·»åŠ æ‰å¯ä»¥ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1638869084,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1250406,"avatar":"https://static001.geekbang.org/account/avatar/00/13/14/66/70a6a206.jpg","nickname":"åè§†é•œ","note":"","ucode":"0975031017BA02","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":570303,"discussion_content":"æ„Ÿè°¢ğŸ™ï¼Œè¿˜æœ‰ä¸€äº›ç–‘é—®ï¼Œ\n1è¯»ä¸è¯»ä¹‹é—´ä¸ä¼šé‡æ–°æ’åºï¼Œæƒ³é—®æ˜¯å“ªé‡Œèµ„æ–™è¯´çš„ï¼ŸåŒç†ä¸åŒåœ°å€çš„å†™ï¼Ÿ\n2. TSOæ¨¡å‹æ˜¯å“ªé‡Œæœ‰æƒå¨ç‚¹çš„èµ„æ–™ï¼Œç½‘ä¸Šå†™çš„éƒ½å¾ˆé›¶æ•£ï¼Œæ€•è¯»é”™ã€‚è°¢è°¢äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1651729416,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1484455,"avatar":"https://static001.geekbang.org/account/avatar/00/16/a6/a7/b52de33e.jpg","nickname":"leving","note":"","ucode":"215FD6C57D689E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":537509,"discussion_content":"æ„Ÿè°¢è§£æƒ‘ï¼Œåˆšçœ‹åˆ°æ¥¼ä¸»è¯´å†…å­˜å±éšœåœ¨x86ä¸èµ·ä½œç”¨ï¼Œä¹Ÿæœ‰åŒæ ·ç–‘é—®ã€‚æ„Ÿè°¢ç­”ç–‘ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639088910,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1335848,"avatar":"https://static001.geekbang.org/account/avatar/00/14/62/28/0356880b.jpg","nickname":".","note":"","ucode":"C0541289C44AF8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":536672,"discussion_content":"æ‰“é”™å­—äº†ï¼Œä¿®æ­£ä¸Šè¿°æ–‡æ¡ˆï¼š.....ä¸”å­˜åœ¨å¯è§æ€§....","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638843908,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":324687,"user_name":"shenglin","can_delete":false,"product_type":"c1","uid":1487222,"ip_address":"","ucode":"0F9A8243EA800A","user_header":"","comment_is_top":false,"comment_ctime":1638545019,"is_pvip":false,"replies":[{"id":"117862","content":"å®Œå…¨æ­£ç¡®ï¼éå¸¸å¥½ï¼Œè¯´æ˜ä½ çœŸçš„æŒæ¡äº†ï¼","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1360512","ctime":1638720058,"ip_address":"","comment_id":324687,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14523446907","product_id":100094901,"comment_content":"æ€è€ƒé¢˜å®ä¾‹ä»£ç ä½¿ç”¨fullFence()æ­£ç¡®æ€§æ˜¯å¯ä»¥ä¿è¯çš„ï¼Œåªæ˜¯æ€§èƒ½ä¸‹é™ï¼Ÿ<br><br>&#47;&#47; CPU0<br>void foo() {<br>    a = 1;<br>    unsafe.storeFence();<br>    b = 1;<br>}<br><br>&#47;&#47; CPU1<br>void bar() {<br>    while (b == 0) continue;<br>    unsafe.loadFence();<br>    assert(a == 1);<br>}<br>å¯ä»¥æ”¹æˆè¿™æ ·ï¼Ÿå› ä¸ºç”±äºstore bufferçš„å­˜åœ¨ï¼Œfoo()å‡½æ•°è¦açš„æ–°å€¼å†™å…¥ç¼“å­˜ä¹‹åï¼Œbçš„æ–°å€¼æ‰èƒ½å†™å…¥ï¼Œæ‰€ä»¥è¦ä½¿ç”¨storeFenceå±éšœï¼› bar()å‡½æ•°è¦è¯»å–bå’Œaçš„æ–°å€¼ï¼Œä¸”ç”±äºinvalid_queueçš„å­˜åœ¨ï¼Œè¦åŠ å…¥loadFenceä¿è¯è¯»å–åˆ°açš„æ–°å€¼å‰invalid_queueçš„æ¶ˆæ¯å·²ç»è¢«å¤„ç†å®Œæˆï¼Œå³å°†CPU1çš„ç¼“å­˜ä¸­çš„aå€¼æ›´æ–°ã€‚è¿™æ ·å³ä¿è¯äº†æ­£ç¡®æ€§ï¼Œåˆå…¼é¡¾äº†æ€§èƒ½ï¼Œä¸çŸ¥é“è¿™æ ·ç†è§£å¯¹ä¸å¯¹ï¼Ÿ","like_count":3,"discussions":[{"author":{"id":1360512,"avatar":"https://static001.geekbang.org/account/avatar/00/14/c2/80/6ebf32e8.jpg","nickname":"æµ·çº³","note":"","ucode":"AB9F7ADB1428D2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":536244,"discussion_content":"å®Œå…¨æ­£ç¡®ï¼éå¸¸å¥½ï¼Œè¯´æ˜ä½ çœŸçš„æŒæ¡äº†ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638720058,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":324514,"user_name":"ä¸€å¡Œç³Šæ¶‚","can_delete":false,"product_type":"c1","uid":1106566,"ip_address":"","ucode":"B55DAEFB98D83C","user_header":"https://static001.geekbang.org/account/avatar/00/10/e2/86/90041355.jpg","comment_is_top":false,"comment_ctime":1638467015,"is_pvip":false,"replies":[{"id":"117790","content":"å¤šè°¢ã€‚è¿™äº›å†…å®¹æ˜¯ä»å¾ˆå¤šæ–‡ç« é‡Œä»¥åŠCPUæºæ–‡ä»¶ï¼Œè¿˜æœ‰å‘CPUè®¾è®¡è€…è¯·æ•™å¾—åˆ°çš„å¿ƒå¾—ã€‚æ‰€ä»¥ï¼Œæˆ‘ä¸€ä¸‹å­ä¹Ÿå¾ˆéš¾è¯´å¾—ä¸Šæ¥æœ‰ä»€ä¹ˆèµ„æ–™ã€‚æˆ‘è§‰å¾—è¿™ä¸ªä¸“æ æœ¬èº«å¯èƒ½å°±æ˜¯ç›®å‰çš„ä¸­æ–‡äº’è”ç½‘ä¸Šçš„ä¸€ä¸ªæ¯”è¾ƒå¥½çš„èµ„æ–™å§ã€‚è‡³äºè¯´è¿™ä¸€èŠ‚è¯¾çš„å†…å®¹ï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯æ¥è‡ªè¿™ç¯‡æ–‡ç« :ã€ŠMemory Barriers: a Hardware View for Software Hackersã€‹ï¼Œä½†æˆ‘å¹¶ä¸å»ºè®®ä½ å»çœ‹è¿™ç¯‡æ–‡ç« ï¼Œå› ä¸ºè¿™ç¯‡æ–‡ç« é‡Œåœ¨è®²åˆ°MESIçŠ¶æ€å˜åŒ–çš„æ—¶å€™è¿‡äºå¤æ‚äº†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1360512","ctime":1638532057,"ip_address":"","comment_id":324514,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14523368903","product_id":100094901,"comment_content":"å¿…é¡»èµï¼Œçœ‹è¿‡å¾ˆå¤šèµ„æ–™ï¼Œå”¯ä¸€èƒ½è®²æ˜ç™½çš„ï¼å¤§ç¥æ¨èç‚¹èµ„æ–™å§ã€‚","like_count":3,"discussions":[{"author":{"id":1360512,"avatar":"https://static001.geekbang.org/account/avatar/00/14/c2/80/6ebf32e8.jpg","nickname":"æµ·çº³","note":"","ucode":"AB9F7ADB1428D2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":535745,"discussion_content":"å¤šè°¢ã€‚è¿™äº›å†…å®¹æ˜¯ä»å¾ˆå¤šæ–‡ç« é‡Œä»¥åŠCPUæºæ–‡ä»¶ï¼Œè¿˜æœ‰å‘CPUè®¾è®¡è€…è¯·æ•™å¾—åˆ°çš„å¿ƒå¾—ã€‚æ‰€ä»¥ï¼Œæˆ‘ä¸€ä¸‹å­ä¹Ÿå¾ˆéš¾è¯´å¾—ä¸Šæ¥æœ‰ä»€ä¹ˆèµ„æ–™ã€‚æˆ‘è§‰å¾—è¿™ä¸ªä¸“æ æœ¬èº«å¯èƒ½å°±æ˜¯ç›®å‰çš„ä¸­æ–‡äº’è”ç½‘ä¸Šçš„ä¸€ä¸ªæ¯”è¾ƒå¥½çš„èµ„æ–™å§ã€‚è‡³äºè¯´è¿™ä¸€èŠ‚è¯¾çš„å†…å®¹ï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯æ¥è‡ªè¿™ç¯‡æ–‡ç« :ã€ŠMemory Barriers: a Hardware View for Software Hackersã€‹ï¼Œä½†æˆ‘å¹¶ä¸å»ºè®®ä½ å»çœ‹è¿™ç¯‡æ–‡ç« ï¼Œå› ä¸ºè¿™ç¯‡æ–‡ç« é‡Œåœ¨è®²åˆ°MESIçŠ¶æ€å˜åŒ–çš„æ—¶å€™è¿‡äºå¤æ‚äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638532057,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":325939,"user_name":"Vvin","can_delete":false,"product_type":"c1","uid":1459341,"ip_address":"","ucode":"664901060BDA33","user_header":"","comment_is_top":false,"comment_ctime":1639265117,"is_pvip":false,"replies":[{"id":"118509","content":"æ€»çº¿ä¼šåšè£å†³ã€‚æ€»çº¿æœ€åçœ‹åˆ°çš„æ˜¯è°å°±ç”¨è°çš„å€¼ã€‚æ‰€ä»¥ä¼šæœ‰ä¸€å®šçš„éšæœºæ€§ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1360512","ctime":1639488806,"ip_address":"","comment_id":325939,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5934232413","product_id":100094901,"comment_content":"ä½ å¥½ï¼è¯·é—®:å¦‚æœåœ¨æœ‰store bufferçš„æƒ…å†µï¼cup0 and cpu1éƒ½å†™åŒä¸€ä¸ªçŠ¶æ€ä¸ºsharedçš„aå˜é‡ï¼Œæ€ä¹ˆå¤„ç†ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1360512,"avatar":"https://static001.geekbang.org/account/avatar/00/14/c2/80/6ebf32e8.jpg","nickname":"æµ·çº³","note":"","ucode":"AB9F7ADB1428D2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":538700,"discussion_content":"æ€»çº¿ä¼šåšè£å†³ã€‚æ€»çº¿æœ€åçœ‹åˆ°çš„æ˜¯è°å°±ç”¨è°çš„å€¼ã€‚æ‰€ä»¥ä¼šæœ‰ä¸€å®šçš„éšæœºæ€§ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639488807,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":361212,"user_name":"Geek_dd538f","can_delete":false,"product_type":"c1","uid":2956145,"ip_address":"æµ™æ±Ÿ","ucode":"22961F37049DF6","user_header":"","comment_is_top":false,"comment_ctime":1667326641,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1667326641","product_id":100094901,"comment_content":"å¼•ç”¨ï¼š<br>â€œä½†æ˜¯åœ¨ Share çŠ¶æ€ä¸‹ï¼Œå¦‚æœä¸€ä¸ªæ ¸æƒ³ç‹¬å ç¼“å­˜è¿›è¡Œä¿®æ”¹ï¼Œå°±éœ€è¦å…ˆç»™æ‰€æœ‰ Share çŠ¶æ€çš„åŒä¼´å‘å‡º Invalid æ¶ˆæ¯ï¼Œç­‰æ‰€æœ‰åŒä¼´ç¡®è®¤å¹¶å›å¤å®ƒâ€œInvalid acknowledgementâ€ä»¥åï¼Œå®ƒæ‰èƒ½æŠŠè¿™å—ç¼“å­˜çš„çŠ¶æ€æ›´æ”¹ä¸º Modifiedï¼Œè¿™æ˜¯ä¿æŒå¤šæ ¸ä¿¡æ¯åŒæ­¥çš„å¿…ç„¶è¦æ±‚ã€‚â€<br><br>å¦‚æœæ˜¯ä¸¤ä¸ªæ ¸åŒæ—¶è¦ç‹¬å ç¼“å­˜å‘¢ï¼Ÿäº’ç›¸ç­‰å¾…åŒä¼´ç¡®è®¤å¹¶å›å¤ï¼Œè¿™æ ·å°±é€ æˆæ­»é”äº†å—ï¼Ÿ","like_count":0},{"had_liked":false,"id":356114,"user_name":"è‰æ²é£","can_delete":false,"product_type":"c1","uid":2622604,"ip_address":"å±±ä¸œ","ucode":"303A06CF1D3999","user_header":"https://static001.geekbang.org/account/avatar/00/28/04/8c/d8b757e0.jpg","comment_is_top":false,"comment_ctime":1661993948,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1661993948","product_id":100094901,"comment_content":"ä½œè€…å†™å¾—å¤ªæ£’äº†ï¼æ¨èä¸€ä¸‹https:&#47;&#47;www.chanmufeng.com&#47;posts&#47;concurrency&#47;%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7%E4%B8%8E%E5%86%85%E5%AD%98%E5%B1%8F%E9%9A%9C.htmlï¼Œå¸Œæœ›èƒ½å¸®åˆ°å¤§å®¶","like_count":0},{"had_liked":false,"id":344214,"user_name":"FRANK-MA","can_delete":false,"product_type":"c1","uid":2422500,"ip_address":"","ucode":"56E5FD13A0F519","user_header":"https://static001.geekbang.org/account/avatar/00/24/f6/e4/7ad3bba6.jpg","comment_is_top":false,"comment_ctime":1651374289,"is_pvip":true,"discussion_count":2,"race_medal":0,"score":"1651374289","product_id":100094901,"comment_content":"é€šè¿‡mesiåè®®æœ¬èº« æ˜¯ä¸æ˜¯å¯ä»¥è§£å†³çº¿ç¨‹é”ä¹‹é—´çš„é—®é¢˜äº†ï¼Ÿæ¯”å¦‚å¤šä¸ªçº¿ç¨‹åŒæ—¶æ“ä½œAå˜é‡ cpu0 å†™å®ŒAä»¥å ç›´æ¥æŠŠcpu1çš„A è®¾ç½®æˆinvaildäº†. å“ªä¸ºä»€ä¹ˆåƒjavaè¿™äº›è¯­è¨€è¿˜éœ€è¦åŠ é”å‘¢ï¼ŸåŠ é”éš¾é“ä¹Ÿæ˜¯å†…å­˜å±éšœçš„ä¸€ç§ ç”¨æ¥è§£å†³store buffer å’Œinvalid queueçš„ è¯»å†™é—®é¢˜ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1254864,"avatar":"https://static001.geekbang.org/account/avatar/00/13/25/d0/3d5696d8.jpg","nickname":"æ— å˜´å°å‘†å­","note":"","ucode":"4165B025F20929","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":590914,"discussion_content":"æ˜¾ç„¶ä¸èƒ½ï¼Œå¦åˆ™å°±æ²¡æœ‰å¤šçº¿ç¨‹åŒæ­¥é—®é¢˜äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1666165447,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"åŒ—äº¬"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1361159,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqJobg767PUeqrqQQ4B6YvMatj2SRyOicKZZ4gWTf30dMketiaj58Gc3RFTmckGxAXlL9ERSxGovq9g/132","nickname":"æ¶›å“¥å“¥","note":"","ucode":"329A1384E3AB5E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":570956,"discussion_content":"æ˜¯çš„ï¼ŒåŠ é”ä¹Ÿä¼šæœ‰å†…å­˜å±éšœ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1652005947,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":334162,"user_name":"ä¸€ä¸ªå·¥åŒ ","can_delete":false,"product_type":"c1","uid":1038449,"ip_address":"","ucode":"2168BA6F926074","user_header":"https://static001.geekbang.org/account/avatar/00/0f/d8/71/d6f79534.jpg","comment_is_top":false,"comment_ctime":1644786378,"is_pvip":true,"replies":[{"id":"122936","content":"mesiæ˜¯ä¸€ä¸ªåè®®ã€‚cpuçš„è®¾è®¡è€…å®Œå…¨éµå®ˆåè®®å°±ä¸€å®šèƒ½ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚ä½†æ˜¯å®Œå…¨éµå®ˆåè®®æ€§èƒ½ä½ï¼Œè¿™æ—¶å€™å°±æœ‰äººæƒ³ï¼Œæˆ‘æ”¾æ¾ä¸€ç‚¹è¦æ±‚ï¼Œæ€§èƒ½å°±å¯ä»¥å¾—åˆ°å¾ˆå¤§çš„æå‡ï¼Œä½†éœ€è¦è½¯ä»¶å·¥ç¨‹å¸ˆå¸®å¿™ã€‚æ€»çš„çœ‹æ¥è¿™ç§æ”¾æ¾æ˜¯æœ‰åˆ©çš„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1360512","ctime":1646124363,"ip_address":"","comment_id":334162,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1644786378","product_id":100094901,"comment_content":"åœ¨æ­£å¸¸çš„ç¨‹åºä¸­ï¼Œå¤šä¸ª CPU ä¸€èµ·æ“ä½œåŒä¸€ä¸ªå˜é‡çš„æƒ…å†µæ˜¯æ¯”è¾ƒå°‘çš„ï¼Œæ‰€ä»¥ store buffer å¯ä»¥å¤§å¤§æå‡ç¨‹åºçš„è¿è¡Œæ€§èƒ½ã€‚<br><br>è¿™ä¸€å—ä¸æ˜¯å¾ˆç†è§£ï¼Œå•ä¸ªcpuæ“ä½œåŒä¸€ä¸ªå˜é‡ä¸å°±ä¸éœ€è¦mesiäº†ä¹ˆï¼Ÿæ‰€ä»¥mesiå°±æ˜¯å¤„ç†å¤šæ ¸æ•°æ®è¯»å†™ä¸ä¸€è‡´é—®é¢˜è€Œå­˜åœ¨çš„ï¼Œå¹¶ä¸”å¯ä»¥è§£å†³ã€‚ä½†æ˜¯ä¼˜åŒ–ä¹‹åï¼Œåˆä¸å¯ä»¥è§£å†³äº†ï¼Œå¹¶ä¸”è¦è®©å¼€å‘äººå‘˜æ·»åŠ å±éšœè¿›ä¸€æ­¥è§£å†³ã€‚é‚£æ˜¯ä¸æ˜¯å¯ä»¥ç†è§£mesiæœ€åè¿˜æ˜¯æ²¡å®Œæˆâ€œå¤šæ ¸ç¼“å­˜ä¸€è‡´æ€§â€å·¥ä½œï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1360512,"avatar":"https://static001.geekbang.org/account/avatar/00/14/c2/80/6ebf32e8.jpg","nickname":"æµ·çº³","note":"","ucode":"AB9F7ADB1428D2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":553876,"discussion_content":"mesiæ˜¯ä¸€ä¸ªåè®®ã€‚cpuçš„è®¾è®¡è€…å®Œå…¨éµå®ˆåè®®å°±ä¸€å®šèƒ½ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚ä½†æ˜¯å®Œå…¨éµå®ˆåè®®æ€§èƒ½ä½ï¼Œè¿™æ—¶å€™å°±æœ‰äººæƒ³ï¼Œæˆ‘æ”¾æ¾ä¸€ç‚¹è¦æ±‚ï¼Œæ€§èƒ½å°±å¯ä»¥å¾—åˆ°å¾ˆå¤§çš„æå‡ï¼Œä½†éœ€è¦è½¯ä»¶å·¥ç¨‹å¸ˆå¸®å¿™ã€‚æ€»çš„çœ‹æ¥è¿™ç§æ”¾æ¾æ˜¯æœ‰åˆ©çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1646124363,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2839104,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/52/40/1fe5be2b.jpg","nickname":"è”é€š","note":"","ucode":"EAA1331CFAFDA3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":552316,"discussion_content":"CPU ä»å•æ ¸å‘å±•ä¸ºå¤šæ ¸ï¼Œå¢åŠ ç¼“å­˜ï¼Œå¯¼è‡´å‡ºç°äº†å¤šä¸ªæ ¸é—´çš„ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ --&gt; ä¸ºäº†è§£å†³ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ï¼Œæå‡ºäº† MESI åè®® --&gt; å®Œå…¨éµå®ˆ MESI åˆä¼šç»™ CPU å¸¦æ¥æ€§èƒ½é—®é¢˜ --&gt; CPU è®¾è®¡è€…åˆå¢åŠ  store buffer å’Œ invalid queue --&gt; åˆå¯¼è‡´äº†ç¼“å­˜çš„é¡ºåºä¸€è‡´æ€§å˜ä¸ºäº†å¼±ç¼“å­˜ä¸€è‡´æ€§ --&gt; éœ€è¦ç¼“å­˜çš„é¡ºåºä¸€è‡´æ€§çš„ï¼Œå°±éœ€è¦è½¯ä»¶å·¥ç¨‹å¸ˆè‡ªå·±åœ¨åˆé€‚çš„åœ°æ–¹æ·»åŠ å†…å­˜å±éšœ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1645409871,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":330012,"user_name":"é™ˆç‹„","can_delete":false,"product_type":"c1","uid":2011954,"ip_address":"","ucode":"456F00EB2EB43D","user_header":"https://static001.geekbang.org/account/avatar/00/1e/b3/32/0ee78a1a.jpg","comment_is_top":false,"comment_ctime":1641729589,"is_pvip":false,"replies":[{"id":"120893","content":"cpuä¼šä¿è¯çš„ï¼Œå½“é‡åˆ°dmbæŒ‡ä»¤çš„æ—¶å€™ï¼Œcpuä¼šåœä¸‹æ¥ï¼Œç›´åˆ°æ¡ä»¶æ»¡è¶³äº†æ‰ä¼šç»§ç»­æ‰§è¡Œã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1360512","ctime":1642385667,"ip_address":"","comment_id":330012,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1641729589","product_id":100094901,"comment_content":"è¯·é—®è€å¸ˆï¼Œã€Œå†…å­˜å±éšœçš„ä½œç”¨æ˜¯å±éšœå‰é¢çš„è¯»å†™æœªå®Œæˆï¼Œä¸ä¼šè¿›è¡Œå±éšœåé¢çš„è¯»å†™ã€ï¼Œæ€ä¹ˆåˆ¤æ–­store bufferï¼Œå°¤å…¶æ˜¯invalid queueé‡Œçš„æ•°æ®æ˜¯å±éšœå‰é¢æœªå®Œæˆçš„è¯»å†™ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1360512,"avatar":"https://static001.geekbang.org/account/avatar/00/14/c2/80/6ebf32e8.jpg","nickname":"æµ·çº³","note":"","ucode":"AB9F7ADB1428D2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546663,"discussion_content":"cpuä¼šä¿è¯çš„ï¼Œå½“é‡åˆ°dmbæŒ‡ä»¤çš„æ—¶å€™ï¼Œcpuä¼šåœä¸‹æ¥ï¼Œç›´åˆ°æ¡ä»¶æ»¡è¶³äº†æ‰ä¼šç»§ç»­æ‰§è¡Œã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642385667,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":325238,"user_name":"BlockQuant","can_delete":false,"product_type":"c1","uid":1155159,"ip_address":"","ucode":"A59F955BDE9FF3","user_header":"https://static001.geekbang.org/account/avatar/00/11/a0/57/c78b489b.jpg","comment_is_top":false,"comment_ctime":1638873134,"is_pvip":false,"replies":[{"id":"118071","content":"å“¦ã€‚è¿™æ˜¯æˆ‘ä»¬å‡è®¾çš„ä¸€ç§çŠ¶æ€ï¼Œæ¯”å¦‚çº¿ç¨‹1æ‰€åœ¨çš„CPUé‡Œæ—©å°±æœ‰äº†bçš„ç¼“å­˜ï¼Œè€Œçº¿ç¨‹2è¿˜æ²¡å¾—åˆ°è°ƒåº¦ï¼Œå®ƒçš„CPUé‡Œæ²¡æœ‰bçš„ç¼“å­˜ã€‚è¿™å‡ ç§å‡è®¾çŠ¶æ€éƒ½æ˜¯æœ‰å¯èƒ½çš„ã€‚æ‰€ä»¥æˆ‘ä»¬å†™çš„ä»£ç å¹¶ä¸æ˜¯ä¸€å®šå‡ºé—®é¢˜ï¼Œè€Œæ˜¯æœ‰æ¦‚ç‡å‡ºé—®é¢˜ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1360512","ctime":1638951974,"ip_address":"","comment_id":325238,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1638873134","product_id":100094901,"comment_content":"â€œCPU0 åœ¨å¾—åˆ°è¿™ä¸ªç¡®è®¤æ¶ˆæ¯ä»¥åï¼Œå°±å¯ä»¥ç‹¬å è¯¥ç¼“å­˜äº†ï¼Œç›´æ¥å°†è¿™å—ç¼“å­˜å˜ä¸º Modified çŠ¶æ€ï¼Œç„¶åæŠŠ a å†™å…¥ã€‚åœ¨ a å†™å…¥ä»¥åï¼Œfoo å‡½æ•°ä¸­çš„å†…å­˜å±éšœå°±å¯ä»¥é¡ºåˆ©é€šè¿‡äº†ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥å†™å…¥å˜é‡ b çš„æ–°å€¼ã€‚ç”±äº b æ˜¯ Exclusive çš„â€  è¿™ä¸ª b ä¸ºå•¥æ˜¯ E çŠ¶æ€ï¼ŒCPU1ä¹Ÿåœ¨ç”¨ï¼Œä¸åº”è¯¥æ˜¯ S å—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1360512,"avatar":"https://static001.geekbang.org/account/avatar/00/14/c2/80/6ebf32e8.jpg","nickname":"æµ·çº³","note":"","ucode":"AB9F7ADB1428D2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":537083,"discussion_content":"å“¦ã€‚è¿™æ˜¯æˆ‘ä»¬å‡è®¾çš„ä¸€ç§çŠ¶æ€ï¼Œæ¯”å¦‚çº¿ç¨‹1æ‰€åœ¨çš„CPUé‡Œæ—©å°±æœ‰äº†bçš„ç¼“å­˜ï¼Œè€Œçº¿ç¨‹2è¿˜æ²¡å¾—åˆ°è°ƒåº¦ï¼Œå®ƒçš„CPUé‡Œæ²¡æœ‰bçš„ç¼“å­˜ã€‚è¿™å‡ ç§å‡è®¾çŠ¶æ€éƒ½æ˜¯æœ‰å¯èƒ½çš„ã€‚æ‰€ä»¥æˆ‘ä»¬å†™çš„ä»£ç å¹¶ä¸æ˜¯ä¸€å®šå‡ºé—®é¢˜ï¼Œè€Œæ˜¯æœ‰æ¦‚ç‡å‡ºé—®é¢˜ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638951974,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":325155,"user_name":"é‚£æ—¶åˆ»","can_delete":false,"product_type":"c1","uid":1150927,"ip_address":"","ucode":"B0D150856C3A4A","user_header":"https://static001.geekbang.org/account/avatar/00/11/8f/cf/890f82d6.jpg","comment_is_top":false,"comment_ctime":1638844402,"is_pvip":false,"replies":[{"id":"118973","content":"è¿™èŠ‚è¯¾çš„å†…å®¹å…¶å®å’Œè¯­è¨€æ— å…³ã€‚å†…å­˜å±éšœéƒ½æ˜¯éœ€è¦çš„ï¼Œåªæ˜¯çœ‹è¿™é—¨è¯­è¨€æ˜¯ä»¥ä»€ä¹ˆæ ·çš„apiæš´éœ²ç»™ç”¨æˆ·ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1360512","ctime":1639929010,"ip_address":"","comment_id":325155,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1638844402","product_id":100094901,"comment_content":"è¯·é—®è€å¸ˆï¼Œå†…å­˜å±éšœå¯¹äºå…¶å®ƒè¯­è¨€ï¼Œæ¯”å¦‚goï¼Œæ˜¯å¦æ˜¯ä¸€è‡´çš„å‘¢ï¼Ÿ å¯¹äºå…¶å®ƒè¯­è¨€ï¼Œè¯»å†™å±éšœå¯ä»¥ä¿è¯ä»£ç çš„æ‰§è¡Œé¡ºåºæ˜¯ä¸€è‡´çš„","like_count":0,"discussions":[{"author":{"id":1360512,"avatar":"https://static001.geekbang.org/account/avatar/00/14/c2/80/6ebf32e8.jpg","nickname":"æµ·çº³","note":"","ucode":"AB9F7ADB1428D2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":540065,"discussion_content":"è¿™èŠ‚è¯¾çš„å†…å®¹å…¶å®å’Œè¯­è¨€æ— å…³ã€‚å†…å­˜å±éšœéƒ½æ˜¯éœ€è¦çš„ï¼Œåªæ˜¯çœ‹è¿™é—¨è¯­è¨€æ˜¯ä»¥ä»€ä¹ˆæ ·çš„apiæš´éœ²ç»™ç”¨æˆ·ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639929010,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":325065,"user_name":"dog_brother","can_delete":false,"product_type":"c1","uid":1619597,"ip_address":"","ucode":"9F64D3C6D815FB","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83er6OV33jHia3U9LYlZEx2HrpsELeh3KMlqFiaKpSAaaZeBttXRAVvDXUgcufpqJ60bJWGYGNpT7752w/132","comment_is_top":false,"comment_ctime":1638794091,"is_pvip":true,"replies":[{"id":"118022","content":"acquire&#47;releaseæ˜¯ä¸€æ ·çš„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1360512","ctime":1638868789,"ip_address":"","comment_id":325065,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1638794091","product_id":100094901,"comment_content":"è€å¸ˆï¼Œè¿™é‡Œè¯´çš„å†…å­˜å±éšœè·Ÿc++11çš„memory orderæ˜¯ä¸€å›äº‹ä¹ˆï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1360512,"avatar":"https://static001.geekbang.org/account/avatar/00/14/c2/80/6ebf32e8.jpg","nickname":"æµ·çº³","note":"","ucode":"AB9F7ADB1428D2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":536794,"discussion_content":"acquire/releaseæ˜¯ä¸€æ ·çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638868789,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":325051,"user_name":"Stormouble","can_delete":false,"product_type":"c1","uid":1234875,"ip_address":"","ucode":"3163D9BEBF053D","user_header":"https://static001.geekbang.org/account/avatar/00/12/d7/bb/dd4442ba.jpg","comment_is_top":false,"comment_ctime":1638787000,"is_pvip":false,"replies":[{"id":"118020","content":"ç¬¬ä¸€ä¸ªä¿è¯ä¸æ˜¯æ‰€æœ‰CPUéƒ½æœ‰çš„ã€‚å¼±å†…å­˜æ¨¡å‹çš„CPUæ™®éä¸åšè¿™ç§ä¿è¯ã€‚å¦å¤–ï¼Œæˆ‘ä»¬æ–‡ç« é‡Œè¯´äº†ï¼Œé™¤äº†CPUæœ¬èº«çš„ä¹±åºæ‰§è¡Œï¼Œå…¶ä»–CPUè§‚å¯Ÿåˆ°çš„ç¼“å­˜ä¿®æ”¹æ‰æ˜¯æœ€é‡è¦çš„åŸå› ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1360512","ctime":1638868745,"ip_address":"","comment_id":325051,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1638787000","product_id":100094901,"comment_content":"æœ‰ä¸ªé—®é¢˜æƒ³è¯·é—®ä¸€ä¸‹ï¼Œåœ¨ä¹±åºæ‰§è¡Œä¸‹ï¼Œä¸æ˜¯ä¼šä¿è¯æŒ‰åŸæœ‰é¡ºåºæäº¤å—ï¼ˆROBï¼‰ï¼Ÿé‚£ä¹ˆä¸ºä»€ä¹ˆè¿˜ä¼šå¯¼è‡´èµ‹å€¼é¡ºåºè¢«æ‰“ä¹±å‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1360512,"avatar":"https://static001.geekbang.org/account/avatar/00/14/c2/80/6ebf32e8.jpg","nickname":"æµ·çº³","note":"","ucode":"AB9F7ADB1428D2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":536791,"discussion_content":"ç¬¬ä¸€ä¸ªä¿è¯ä¸æ˜¯æ‰€æœ‰CPUéƒ½æœ‰çš„ã€‚å¼±å†…å­˜æ¨¡å‹çš„CPUæ™®éä¸åšè¿™ç§ä¿è¯ã€‚å¦å¤–ï¼Œæˆ‘ä»¬æ–‡ç« é‡Œè¯´äº†ï¼Œé™¤äº†CPUæœ¬èº«çš„ä¹±åºæ‰§è¡Œï¼Œå…¶ä»–CPUè§‚å¯Ÿåˆ°çš„ç¼“å­˜ä¿®æ”¹æ‰æ˜¯æœ€é‡è¦çš„åŸå› ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638868745,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":325046,"user_name":".","can_delete":false,"product_type":"c1","uid":1335848,"ip_address":"","ucode":"C0541289C44AF8","user_header":"https://static001.geekbang.org/account/avatar/00/14/62/28/0356880b.jpg","comment_is_top":false,"comment_ctime":1638785832,"is_pvip":false,"replies":[{"id":"118021","content":"éå¸¸å¥½~æˆ‘ä»¬ç¬¬18èŠ‚è¯¾å°±æ˜¯åœ¨è®²è¿™ä¸ªé—®é¢˜ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1360512","ctime":1638868765,"ip_address":"","comment_id":325046,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1638785832","product_id":100094901,"comment_content":"æ€è€ƒé¢˜ï¼š<br>ç»™båŠ ä¸Švolatileä¿®é¥°ï¼Œä»è€Œè§¦å‘javaçš„happen before åŸåˆ™ï¼Œè¿™ä¸ªåŸåˆ™æˆ‘è®°å¾—æ²¡é”™ä¹Ÿæœ‰é å†…å­˜å±éšœå®ç°","like_count":0,"discussions":[{"author":{"id":1360512,"avatar":"https://static001.geekbang.org/account/avatar/00/14/c2/80/6ebf32e8.jpg","nickname":"æµ·çº³","note":"","ucode":"AB9F7ADB1428D2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":536793,"discussion_content":"éå¸¸å¥½~æˆ‘ä»¬ç¬¬18èŠ‚è¯¾å°±æ˜¯åœ¨è®²è¿™ä¸ªé—®é¢˜ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638868765,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":324816,"user_name":"å…«å°ä¸Š","can_delete":false,"product_type":"c1","uid":1391143,"ip_address":"","ucode":"FB3D74B522C720","user_header":"https://static001.geekbang.org/account/avatar/00/15/3a/27/5d218272.jpg","comment_is_top":false,"comment_ctime":1638644188,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1638644188","product_id":100094901,"comment_content":"æƒ³é—®ä¸€ä¸‹åœ¨ç¨‹åºä¸­ä½¿ç”¨å„ç§é”é”ï¼Œå’Œæœ¬èŠ‚è®²çš„å†…å­˜å±éšœæœ‰ä»€ä¹ˆå…³ç³»å—","like_count":0,"discussions":[{"author":{"id":1304195,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKtlEYuHnR8VdRkNPcmkIqTM9DKahpcpicDdBvcmBWMIAAhBrd0QNWvl09slqrzB5TibryVcIfPmb7Q/132","nickname":"raisecomer","note":"","ucode":"32EA488E46471F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":536177,"discussion_content":"ä¸€èˆ¬è€Œè¨€ï¼ŒåŠ é”æˆåŠŸåè¦ä¿è¯acquireè¯­ä¹‰ï¼Œè§£é”æˆåŠŸåè¦ä¿è¯releaseè¯­ä¹‰ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638707631,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":324686,"user_name":"shenglin","can_delete":false,"product_type":"c1","uid":1487222,"ip_address":"","ucode":"0F9A8243EA800A","user_header":"","comment_is_top":false,"comment_ctime":1638544060,"is_pvip":false,"replies":[{"id":"117860","content":"storestoreå’±ä»¬è¯¾é‡Œä¸æ˜¯è¯´äº†ä¹ˆï¼Œå°±æ˜¯å†™æ“ä½œå’Œå†™æ“ä½œä¹‹é—´å¦‚æœæ’å…¥è¿™æ ·çš„åœ¨barrierçš„è¯ï¼Œcpuå°±ä¸èƒ½ä¹±åºæ‰§è¡Œï¼Œè€Œä¸”æ›´æ–°ç¼“å­˜çš„é¡ºåºä¹Ÿè¦ä¿è¯ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1360512","ctime":1638720004,"ip_address":"","comment_id":324686,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1638544060","product_id":100094901,"comment_content":"è¯·é—®ä¸€ä¸‹ï¼Œ StoreStore barrier, LoadStore barrier, LoadLoad barrier, StoreLoad barrierå…·ä½“å«ä¹‰æ˜¯ä»€ä¹ˆ","like_count":0,"discussions":[{"author":{"id":1360512,"avatar":"https://static001.geekbang.org/account/avatar/00/14/c2/80/6ebf32e8.jpg","nickname":"æµ·çº³","note":"","ucode":"AB9F7ADB1428D2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":536242,"discussion_content":"storestoreå’±ä»¬è¯¾é‡Œä¸æ˜¯è¯´äº†ä¹ˆï¼Œå°±æ˜¯å†™æ“ä½œå’Œå†™æ“ä½œä¹‹é—´å¦‚æœæ’å…¥è¿™æ ·çš„åœ¨barrierçš„è¯ï¼Œcpuå°±ä¸èƒ½ä¹±åºæ‰§è¡Œï¼Œè€Œä¸”æ›´æ–°ç¼“å­˜çš„é¡ºåºä¹Ÿè¦ä¿è¯ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638720004,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":324667,"user_name":".","can_delete":false,"product_type":"c1","uid":1335848,"ip_address":"","ucode":"C0541289C44AF8","user_header":"https://static001.geekbang.org/account/avatar/00/14/62/28/0356880b.jpg","comment_is_top":false,"comment_ctime":1638532311,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1638532311","product_id":100094901,"comment_content":"æˆ‘æ€»ç®—ç­‰åˆ°è¿™èŠ‚è¯¾ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚è€å¸ˆæ‰“ç®—å°±javaæ–¹é¢å‡ºç±»ä¼¼çš„æ•™ç¨‹å—ï¼Ÿåœ¨è¿™å—ç½‘ä¸Šçš„æ¯”è¾ƒé›¶æ•£ã€‚","like_count":0},{"had_liked":false,"id":324522,"user_name":"csyangchsh","can_delete":false,"product_type":"c1","uid":1002939,"ip_address":"","ucode":"8604F5C839710B","user_header":"https://static001.geekbang.org/account/avatar/00/0f/4d/bb/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1638491341,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1638491341","product_id":100094901,"comment_content":"è¿™ç¯‡æ–‡ç« å¾ˆæ£’ï¼Œå¦‚æœæ‰§è¡Œè¿‡ç¨‹åŠ ä¸Šå›¾ç¤ºä¹æ›´å¥½äº†ã€‚","like_count":0},{"had_liked":false,"id":324521,"user_name":"è´¹åŸçš„äºŒé¹","can_delete":false,"product_type":"c1","uid":1101293,"ip_address":"","ucode":"DE768A0CC3053D","user_header":"https://static001.geekbang.org/account/avatar/00/10/cd/ed/825d84ee.jpg","comment_is_top":false,"comment_ctime":1638491163,"is_pvip":false,"replies":[{"id":"117791","content":"æ˜¯ç­”æ¡ˆå‘€ã€‚ä½ çœ‹ä¸‹æ–‡çš„æç¤ºé‡Œæœ‰è®²çš„å“¦ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1360512","ctime":1638532082,"ip_address":"","comment_id":324521,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1638491163","product_id":100094901,"comment_content":"æ€è€ƒé¢˜ç¬¬ä¸€ç¬é—´æƒ³åˆ°çš„å°±æ˜¯ volatile ç»“æœå®ƒä¸æ˜¯ç­”æ¡ˆã€‚","like_count":0,"discussions":[{"author":{"id":1360512,"avatar":"https://static001.geekbang.org/account/avatar/00/14/c2/80/6ebf32e8.jpg","nickname":"æµ·çº³","note":"","ucode":"AB9F7ADB1428D2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":535746,"discussion_content":"æ˜¯ç­”æ¡ˆå‘€ã€‚ä½ çœ‹ä¸‹æ–‡çš„æç¤ºé‡Œæœ‰è®²çš„å“¦ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638532082,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}