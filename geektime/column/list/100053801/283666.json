{"id":283666,"title":"31 | é’ˆå¯¹æµ·é‡æ•°æ®ï¼Œå¦‚ä½•ä¼˜åŒ–æ€§èƒ½ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯æœˆå½±ã€‚</p><p>å‰ä¸¤èŠ‚è¯¾ï¼Œæˆ‘ä»¬ä¸€èµ·å­¦ä¹ äº†Canvas2Då’ŒWebGLæ€§èƒ½ä¼˜åŒ–çš„ä¸€äº›åŸºæœ¬åŸåˆ™å’Œå¤„ç†æ–¹æ³•ã€‚åœ¨æ­£ç¡®è¿ç”¨è¿™äº›æ–¹æ³•åï¼Œæˆ‘ä»¬èƒ½è®©æ¸²æŸ“æ€§èƒ½è¾¾åˆ°è¾ƒé«˜çš„ç¨‹åº¦ï¼Œæ»¡è¶³æˆ‘ä»¬é¡¹ç›®çš„éœ€è¦ã€‚</p><p>ä¸è¿‡ï¼Œåœ¨æ•°æ®é‡ç‰¹åˆ«å¤šçš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šé‡åˆ°äº›ç‰¹æ®Šçš„æ¸²æŸ“éœ€æ±‚ï¼Œæ¯”å¦‚ï¼Œè¦åœ¨ä¸€ä¸ªåœ°å›¾ä¸Šæ ‡è®°éå¸¸å¤šçš„åœ°ç†ä½ç½®ç‚¹ï¼ˆæ•°åƒåˆ°æ•°ä¸‡ï¼‰ï¼Œæˆ–è€…åœ¨åœ°å›¾ä¸ŠåŒæ—¶éœ€è¦æ¸²æŸ“å‡ ä¸‡æ¡é»‘å®¢æ”»å‡»å’Œé˜²å¾¡æ•°æ®ã€‚è¿™äº›éœ€æ±‚å¯èƒ½è¶…è¿‡äº†å¸¸è§„ä¼˜åŒ–æ‰‹æ®µæ‰€èƒ½è¾¾åˆ°çš„å±‚æ¬¡ï¼Œéœ€è¦æˆ‘ä»¬é’ˆå¯¹æ•°æ®å’Œæ¸²æŸ“çš„ç‰¹ç‚¹è¿›è¡Œæ€§èƒ½ä¼˜åŒ–ã€‚</p><p>ä»Šå¤©ï¼Œæˆ‘é€šè¿‡æ¸²æŸ“åŠ¨æ€åœ°ç†ä½ç½®çš„ä¾‹å­ï¼Œæ¥å’Œä½ è¯´è¯´å¦‚ä½•å¯¹ç‰¹æ®Šæ¸²æŸ“éœ€æ±‚è¿­ä»£ä¼˜åŒ–ã€‚ä¸è¿‡ï¼Œæˆ‘ä»Šå¤©ç”¨åˆ°ç‰¹æ®Šä¼˜åŒ–æ‰‹æ®µï¼Œåªæ˜¯ä¸€ç§å…·ä½“çš„æ–¹æ³•å’Œæ‰‹æ®µï¼Œä½ å¯ä»¥å€Ÿé‰´ä»–å»ç†è§£æ€è·¯ï¼Œä½†åƒä¸‡ä¸è¦é™·å…¥åˆ°æ€ç»´å®šå¼ä¸­ã€‚å› ä¸ºè§£å†³è¿™äº›ç‰¹æ®Šæ¸²æŸ“éœ€æ±‚ï¼Œå¹¶æ²¡æœ‰å›ºå®šçš„è·¯å¾„æˆ–æ–¹æ³•ï¼Œå®ƒæ˜¯ä¸€ä¸ªéœ€è¦è¿­ä»£ä¼˜åŒ–çš„è¿‡ç¨‹ï¼Œéœ€è¦æˆ‘ä»¬å¯¹WebGLçš„æ¸²æŸ“æœºåˆ¶éå¸¸äº†è§£ï¼Œå¹¶æ·±å…¥æ€è€ƒï¼Œæ‰èƒ½åˆ›é€ å‡ºæœ€é€‚åˆçš„æ–¹æ³•æ¥ã€‚åœ¨æˆ‘ä»¬å®é™…çš„å·¥ä½œé‡Œï¼Œè¿˜æœ‰è®¸å¤šå…¶ä»–çš„æ–¹æ³•å¯ä»¥ä½¿ç”¨ï¼Œä½ ä¸€å®šè¦æ ¹æ®è‡ªå·±çš„å®é™…æƒ…å†µéšæœºåº”å˜ã€‚</p><h2>æ¸²æŸ“åŠ¨æ€çš„åœ°ç†ä½ç½®</h2><p>æˆ‘å…ˆæ¥çœ‹ä»Šå¤©è¦å®ç°çš„ä¾‹å­ã€‚åœ¨åœ°å›¾å¯è§†åŒ–åº”ç”¨ä¸­ï¼Œæ¸²æŸ“åœ°ç†ä½ç½®ä¿¡æ¯æ˜¯ä¸€ç±»å¸¸è§çš„éœ€æ±‚ï¼Œä¾‹å¦‚åœ¨è¿™å¼ åœ°å›¾ä¸Šï¼Œæˆ‘ä»¬å°±ç”¨è®¸å¤šä¸åŒé¢œè‰²çš„å°åœ†ç‚¹æ ‡æ³¨å‡ºäº†ç¾å›½ä¸€äº›ä¸åŒçš„åœ°åŒºã€‚</p><!-- [[[read_end]]] --><p><img src=\"https://static001.geekbang.org/resource/image/ca/4a/caebcea9dd803d01fa4188faf98f9f4a.jpeg?wh=1920*1080\" alt=\"\"></p><p>å¦‚æœæˆ‘ä»¬è¦å®ç°è¿™äº›é™æ€çš„æ ‡å‡†ç‚¹ï¼Œæ–¹æ³•å…¶å®å¾ˆç®€å•ï¼Œç”¨Canvas2Dæˆ–è€…WebGLéƒ½å¯ä»¥è½»æ¾å®ç°ã€‚å°±ç®—ç‚¹æ•°é‡æ¯”è¾ƒå¤šä¹Ÿæ²¡å…³ç³»ï¼Œå› ä¸ºä¸€æ¬¡æ€§æ¸²æŸ“å¯¹æ€§èƒ½å½±å“ä¹Ÿä¸ä¼šå¾ˆå¤§ã€‚ä¸è¿‡ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è®©åœ†ç‚¹è¿åŠ¨èµ·æ¥ï¼Œæ¯”å¦‚ï¼Œåšå‡ºä¸€ç§é—ªçƒæˆ–è€…å‘¼å¸ç¯çš„æ•ˆæœï¼Œé‚£æˆ‘ä»¬å°±è¦è€ƒè™‘ç‚¹çš„æ•°é‡å¯¹æ€§èƒ½çš„å½±å“äº†ã€‚</p><p>é‚£é¢å¯¹è¿™ä¸€ç±»ç‰¹æ®Šçš„æ¸²æŸ“çš„éœ€æ±‚ï¼Œæˆ‘ä»¬è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿä¸‹é¢ï¼Œæˆ‘ä»¬å…ˆç”¨å¸¸è§„çš„åšæ³•æ¥å®ç°ï¼Œç„¶ååœ¨è¿™ä¸ªæ–¹æ³•ä¸Šä¸æ–­è¿­ä»£ä¼˜åŒ–ã€‚ä¸ºäº†æ–¹ä¾¿ä½ ç†è§£ï¼Œæˆ‘å°±ä¸ç»˜åˆ¶åœ°å›¾äº†ï¼Œåªç»˜åˆ¶è¿™äº›éšæœºçš„å°åœ†ç‚¹ã€‚</p><p>æœ€ç®€å•çš„åšæ³•å½“ç„¶æ˜¯ä¸€ä¸ªä¸€ä¸ªåœ†ç»˜åˆ¶ä¸Šå»ï¼Œä¹Ÿå°±æ˜¯å…ˆåˆ›å»ºåœ†çš„å‡ ä½•é¡¶ç‚¹æ•°æ®ï¼Œç„¶åå¯¹æ¯ä¸ªåœ†è®¾ç½®ä¸åŒçš„å‚æ•°æ¥åˆ†åˆ«ç»˜åˆ¶ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><pre><code>const canvas = document.querySelector('canvas');\nconst renderer = new GlRenderer(canvas);\n\nconst vertex = `\n  attribute vec2 a_vertexPosition;\n  uniform vec2 xy;\n  uniform float uTime;\n  uniform float bias;\n\n  void main() {\n    vec3 pos = vec3(a_vertexPosition, 1);\n    float scale = 0.7 + 0.3 * sin(6.28 * bias + 0.003 * uTime);\n    mat3 m = mat3(\n      scale, 0, 0,\n      0, scale, 0,\n      xy, 1\n    );\n    gl_Position = vec4(m * pos, 1);\n  }\n`;\n\nconst fragment = `\n  #ifdef GL_ES\n  precision highp float;\n  #endif\n\n  uniform vec4 u_color;\n  \n  void main() {\n    gl_FragColor = u_color;\n  }\n`;\nconst program = renderer.compileSync(fragment, vertex);\nrenderer.useProgram(program);\n\nfunction circle(radius = 0.05) {\n  const delta = 2 * Math.PI / 32;\n  const positions = [];\n  const cells = [];\n  for(let i = 0; i &lt; 32; i++) {\n    const angle = i * delta;\n    positions.push([radius * Math.sin(angle), radius * Math.cos(angle)]);\n    if(i &gt; 0 &amp;&amp; i &lt; 31) {\n      cells.push([0, i, i + 1]);\n    }\n  }\n  return {positions, cells};\n}\n\nconst COUNT = 500;\nfunction init() {\n  const meshData = [];\n  const {positions, cells} = circle();\n  for(let i = 0; i &lt; COUNT; i++) {\n    const x = 2 * Math.random() - 1;\n    const y = 2 * Math.random() - 1;\n    const rotation = 2 * Math.PI * Math.random();\n    const uniforms = {};\n\n    uniforms.u_color = [\n      Math.random(),\n      Math.random(),\n      Math.random(),\n      1];\n\n    uniforms.xy = [\n      2 * Math.random() - 1,\n      2 * Math.random() - 1,\n    ];\n\n    uniforms.bias = Math.random();\n\n    meshData.push({\n      positions,\n      cells,\n      uniforms,\n    });\n  }\n  renderer.uniforms.uTime = 0;\n  renderer.setMeshData(meshData);\n}\ninit();\n\nfunction update(t) {\n  renderer.uniforms.uTime = t;\n  renderer.render();\n  requestAnimationFrame(update);\n}\n\nupdate(0);\n</code></pre><p>ä¸Šé¢çš„ä»£ç éå¸¸ç®€å•ï¼Œå…³é”®æ€è·¯å°±æ˜¯ç”¨circleç”Ÿæˆé¡¶ç‚¹ä¿¡æ¯ï¼Œç„¶åå¯¹æ¯ä¸ªéœ€è¦ç»˜åˆ¶çš„åœ†åº”ç”¨circleé¡¶ç‚¹ä¿¡æ¯ï¼Œå¹¶è®¾ç½®ä¸åŒçš„unifomå‚æ•°ï¼Œæœ€ååœ¨shaderä¸­æ ¹æ®å‚æ•°è¿›è¡Œç»˜åˆ¶å°±å¯ä»¥äº†ã€‚</p><p>ä¸è¿‡å¦‚æœæˆ‘ä»¬è¿™ä¹ˆåšçš„è¯ï¼Œæ•´ä½“çš„æ€§èƒ½å°±ä¼šéå¸¸ä½ï¼Œæ¯”å¦‚åœ¨ç»˜åˆ¶500ä¸ªåœ†çš„æ—¶å€™ï¼Œæµè§ˆå™¨çš„å¸§ç‡å°±æ‰åˆ°åå‡ fpsäº†ã€‚é‚£æˆ‘ä»¬è¯¥æ€ä¹ˆä¼˜åŒ–å‘¢ï¼Ÿ</p><p><img src=\"https://static001.geekbang.org/resource/image/83/78/83f68759c4913bea230fc52d08ac9578.jpeg?wh=1920*1080\" alt=\"\"></p><h2>ä¼˜åŒ–å¤§æ•°æ®æ¸²æŸ“çš„å¸¸è§æ–¹æ³•</h2><p>æˆ‘ä»¬é€šè¿‡å‰é¢çš„å­¦ä¹ å·²ç»çŸ¥é“æ¸²æŸ“æ¬¡æ•°å’Œæ¯æ¬¡æ¸²æŸ“çš„é¡¶ç‚¹è®¡ç®—æ¬¡æ•°æ˜¯å½±å“æ¸²æŸ“æ€§èƒ½çš„è¦ç´ ï¼Œæ‰€ä»¥ä¼˜åŒ–å¤§æ•°æ®æ¸²æŸ“çš„æ€è·¯æ–¹å‘è‡ªç„¶å°±æ˜¯å‡å°‘æ¸²æŸ“æ¬¡æ•°å’Œå‡å°‘å‡ ä½•ä½“é¡¶ç‚¹æ•°äº†ã€‚</p><h3>1.  ä½¿ç”¨æ‰¹é‡æ¸²æŸ“ä¼˜åŒ–</h3><p>åœ¨å­¦å®ŒCanvaså’ŒWebGLçš„æ€§èƒ½ä¼˜åŒ–ä¹‹åï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œåœ¨ç»˜åˆ¶å¤§é‡åŒç§å‡ ä½•å›¾å½¢çš„æ—¶å€™ï¼Œé€šè¿‡å‡å°‘æ¸²æŸ“æ¬¡æ•°æ¥æå‡æ€§èƒ½æœ€å¥½çš„åšæ³•æ˜¯ç›´æ¥ä½¿ç”¨æ‰¹é‡æ¸²æŸ“ã€‚é’ˆå¯¹ä»Šå¤©çš„ä¾‹å­ä¹Ÿæ˜¯ä¸€æ ·ï¼Œæˆ‘ä»¬ç¨å¾®ä¿®æ”¹ä¸€ä¸‹ä¸Šé¢çš„ä»£ç ï¼Œç”¨å®ä¾‹æ¸²æŸ“æ¥ä»£æ›¿é€ä¸ªæ¸²æŸ“ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre><code>const canvas = document.querySelector('canvas');\nconst renderer = new GlRenderer(canvas);\n\nconst vertex = `\n  attribute vec2 a_vertexPosition;\n  attribute vec4 color;\n  attribute vec2 xy;\n  attribute float bias;\n  uniform float uTime;\n\n  varying vec4 vColor;\n\n  void main() {\n    vec3 pos = vec3(a_vertexPosition, 1);\n    float scale = 0.7 + 0.3 * sin(6.28 * bias + 0.003 * uTime);\n    mat3 m = mat3(\n      scale, 0, 0,\n      0, scale, 0,\n      xy, 1\n    );\n    vColor = color;\n    gl_Position = vec4(m * pos, 1);\n  }\n`;\n\nconst fragment = `\n  #ifdef GL_ES\n  precision highp float;\n  #endif\n\n\n  varying vec4 vColor;\n  \n  void main() {\n    gl_FragColor = vColor;\n  }\n`;\nconst program = renderer.compileSync(fragment, vertex);\nrenderer.useProgram(program);\n\nfunction circle(radius = 0.05) {\n  const delta = 2 * Math.PI / 32;\n  const positions = [];\n  const cells = [];\n  for(let i = 0; i &lt; 32; i++) {\n    const angle = i * delta;\n    positions.push([radius * Math.sin(angle), radius * Math.cos(angle)]);\n    if(i &gt; 0 &amp;&amp; i &lt; 31) {\n      cells.push([0, i, i + 1]);\n    }\n  }\n  return {positions, cells};\n}\n\nconst COUNT = 200000;\nfunction init() {\n  const {positions, cells} = circle();\n  const colors = [];\n  const pos = [];\n  const bias = [];\n  for(let i = 0; i &lt; COUNT; i++) {\n    const x = 2 * Math.random() - 1;\n    const y = 2 * Math.random() - 1;\n    const rotation = 2 * Math.PI * Math.random();\n\n    colors.push([\n      Math.random(),\n      Math.random(),\n      Math.random(),\n      1\n    ]);\n\n    pos.push([\n      2 * Math.random() - 1,\n      2 * Math.random() - 1\n    ]);\n\n    bias.push(\n      Math.random()\n    );\n  }\n  \n  renderer.uniforms.uTime = 0;\n  renderer.setMeshData({\n    positions,\n    cells,\n    instanceCount: COUNT,\n    attributes: {\n      color: {data: [...colors], divisor: 1},\n      xy: {data: [...pos], divisor: 1},\n      bias: {data: [...bias], divisor: 1},\n    },\n  });\n}\ninit();\n\nfunction update(t) {\n  renderer.uniforms.uTime = t;\n  renderer.render();\n  requestAnimationFrame(update);\n}\n\nupdate(0);\n</code></pre><p>ä½ å¯ä»¥æ¯”è¾ƒä¸€ä¸‹ä¸Šé¢çš„ä»£ç å’Œå‰ä¸€ä¸ªä¾‹å­ä»£ç çš„å·®å¼‚ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨å®ä¾‹æ¸²æŸ“å°†ä¹‹å‰çš„uniformå˜é‡æ›¿æ¢æˆattributeå˜é‡ï¼Œå…¶ä»–çš„é€»è¾‘å‡ ä¹ä¸å˜ã€‚æˆ‘ä»¬è¿™ä¹ˆåšäº†ä¹‹åï¼Œå³ä½¿æ¸²æŸ“100000ä¸ªç‚¹ï¼Œæµè§ˆå™¨çš„å¸§ç‡ä¹Ÿèƒ½è¾¾åˆ°30fpsä»¥ä¸Šï¼Œæ€§èƒ½æå‡äº†è¶…è¿‡2000å€ï¼</p><p><img src=\"https://static001.geekbang.org/resource/image/10/81/10cc6bc21a8d9d89e06760ddf4118381.jpeg?wh=1920*1080\" alt=\"\"></p><p>ä¹‹æ‰€ä»¥æ‰¹é‡æ¸²æŸ“çš„æ€§èƒ½æ¯”é€ä¸ªæ¸²æŸ“è¦é«˜å¾—å¤šï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬é€šè¿‡å‡å°‘ç»˜åˆ¶æ¬¡æ•°ï¼Œå¤§å¤§å‡å°‘äº†JavaScriptä¸WebGLåº•å±‚äº¤äº’çš„æ—¶é—´ã€‚ä¸è¿‡ï¼Œä½¿ç”¨æ‰¹é‡æ¸²æŸ“ç»˜åˆ¶20000ä¸ªç‚¹ï¼Œå°±è¾¾åˆ°æˆ‘ä»¬çš„æ€§èƒ½æé™äº†å—ï¼Ÿæ˜¾ç„¶æ²¡æœ‰ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è¿ç”¨å…¶ä»–çš„ä¼˜åŒ–æ‰‹æ®µã€‚</p><h3>2.  ä½¿ç”¨ç‚¹å›¾å…ƒä¼˜åŒ–</h3><p>ç»˜åˆ¶è§„åˆ™çš„å›¾å½¢ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ç‚¹å›¾å…ƒã€‚è¿˜è®°å¾—å—ï¼Ÿæˆ‘ä»¬è¯´è¿‡WebGLçš„åŸºæœ¬å›¾å…ƒåŒ…æ‹¬ç‚¹ã€çº¿ã€ä¸‰è§’å½¢ç­‰ç­‰ã€‚å‰é¢æˆ‘ä»¬ç»˜åˆ¶åœ†çš„æ—¶å€™ï¼Œéƒ½æ˜¯ç”¨circleå‡½æ•°ç”Ÿæˆä¸‰è§’ç½‘æ ¼ï¼Œç„¶åé€šè¿‡ä¸‰è§’å½¢ç»˜åˆ¶çš„ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬ç»˜åˆ¶ä¸€ä¸ªåœ†éœ€è¦è®¸å¤šé¡¶ç‚¹ã€‚ä½†å®é™…ä¸Šï¼Œè¿™ç§ç®€å•çš„å›¾å½¢ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ç›´æ¥é‡‡ç”¨ç‚¹å›¾å…ƒã€‚</p><p><strong>ç‚¹å›¾å…ƒé€ å‹</strong></p><p>åœ¨WebGLä¸­ï¼Œç‚¹å›¾å…ƒæ˜¯æœ€ç®€å•çš„å›¾å…ƒï¼Œå®ƒç”¨æ¥æ˜¾ç¤ºç”»å¸ƒä¸Šçš„ç‚¹ã€‚åœ¨é¡¶ç‚¹ç€è‰²å™¨é‡Œï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®gl_PointSizeæ¥æ”¹å˜ç‚¹å›¾å…ƒçš„å¤§å°ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±å¯ä»¥ç”¨ç‚¹å›¾å…ƒæ¥è¡¨ç¤ºä¸€ä¸ªçŸ©å½¢ã€‚æˆ‘ä»¬çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­ã€‚</p><pre><code>const canvas = document.querySelector('canvas');\nconst renderer = new GlRenderer(canvas);\n\nconst vertex = `\n  attribute vec2 a_vertexPosition;\n  uniform vec2 uResolution;\n\n  void main() {\n    gl_PointSize = 0.2 * uResolution.x;\n    gl_Position = vec4(a_vertexPosition, 1, 1);\n  }\n`;\n\nconst fragment = `\n  #ifdef GL_ES\n  precision highp float;\n  #endif\n  \n  void main() {\n    gl_FragColor = vec4(0, 0, 1, 1);\n  }\n`;\nconst program = renderer.compileSync(fragment, vertex);\nrenderer.useProgram(program);\n\nrenderer.uniforms.uResolution = [canvas.width, canvas.height];\nrenderer.setMeshData({\n  mode: renderer.gl.POINTS,\n  positions: [[0, 0]],\n});\n\nrenderer.render();\n</code></pre><p>å¦‚ä¸Šé¢ä»£ç æ‰€ç¤ºï¼Œæˆ‘ä»¬å°†meshDataçš„modeè®¾ä¸ºgl.POINTSï¼Œåªç»˜åˆ¶ä¸€ä¸ªç‚¹ï¼ˆ0, 0ï¼‰ã€‚åœ¨é¡¶ç‚¹ç€è‰²å™¨ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡gl_PointSizeæ¥è®¾ç½®é¡¶ç‚¹çš„å¤§å°ã€‚ç”±äºgl_PointSizeçš„å•ä½æ˜¯åƒç´ ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¼ ä¸€ä¸ªç”»å¸ƒå®½é«˜uResolutionè¿›å»ï¼Œç„¶åå°†gl_Positionè®¾ä¸º0.2 * uResolutionï¼Œè¿™å°±è®©è¿™ä¸ªç‚¹çš„å¤§å°è®¾ä¸ºç”»å¸ƒçš„20%ï¼Œæœ€ç»ˆåœ¨ç”»å¸ƒä¸Šå°±å‘ˆç°å‡ºä¸€ä¸ªè“è‰²çŸ©å½¢ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/47/fb/47b1af96385ce25571f0892b1474c6fb.jpeg?wh=1920*1080\" alt=\"\"></p><p>æ³¨æ„ï¼Œè¿™é‡Œä½ å¯ä»¥å›é¡¾ä¸€ä¸‹ä¹‹å‰æˆ‘ä»¬é‡‡ç”¨çš„å¸¸è§„çš„æ–¹æ³•ç»˜åˆ¶çš„çŸ©å½¢ï¼Œæˆ‘ä»¬æ˜¯å°†çŸ©å½¢å‰–åˆ†ä¸ºä¸¤ä¸ªä¸‰è§’å½¢ï¼Œç„¶åç”¨å¡«å……ä¸‰è§’å½¢æ¥ç»˜åˆ¶çš„ã€‚è€Œè¿™é‡Œï¼Œæˆ‘ä»¬ç”¨ç‚¹å›¾å…ƒï¼Œå¥½å¤„æ˜¯æˆ‘ä»¬åªéœ€è¦ä¸€ä¸ªé¡¶ç‚¹å°±å¯ä»¥ç»˜åˆ¶ï¼Œè€Œä¸éœ€è¦ç”¨å››ä¸ªé¡¶ç‚¹ã€ä¸¤ä¸ªä¸‰è§’å½¢æ¥å¡«å……ã€‚</p><p>ç°åœ¨ï¼Œæˆ‘ä»¬é€šè¿‡ç‚¹å›¾å…ƒï¼Œæ”¹å˜gl_PointSizeç»˜åˆ¶å‡ºäº†çŸ©å½¢ï¼Œé‚£æ€ä¹ˆæ‰èƒ½ç»˜åˆ¶å‡ºå…¶ä»–å›¾å½¢å‘¢ï¼Ÿå®é™…ä¸Šï¼Œç­”æ¡ˆåœ¨æˆ‘ä»¬å‰é¢å­¦è¿‡çš„è¯¾ç¨‹é‡Œâ€”â€”ä½¿ç”¨è·ç¦»åœºå’Œé€ å‹å‡½æ•°ã€‚</p><p>åœ¨ä¸Šé¢ä¾‹å­çš„åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹é¡¶ç‚¹ç€è‰²å™¨å’Œç‰‡å…ƒç€è‰²å™¨ã€‚å…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p><p>é¦–å…ˆæ˜¯é¡¶ç‚¹ç€è‰²å™¨ä»£ç ã€‚</p><pre><code>attribute vec2 a_vertexPosition;\n\nuniform vec2 uResolution;\nvarying vec2 vResolution;\nvarying vec2 vPos;\n\nvoid main() {\n  gl_PointSize = 0.2 * uResolution.x;\n  vResolution = uResolution;\n  vPos = a_vertexPosition;\n  gl_Position = vec4(a_vertexPosition, 1, 1);\n}\n</code></pre><p>ç„¶åæ˜¯ç‰‡å…ƒç€è‰²å™¨ä»£ç ã€‚</p><pre><code>#ifdef GL_ES\nprecision highp float;\n#endif\n\nvarying vec2 vResolution;\nvarying vec2 vPos;\n\nvoid main() {\n  vec2 st = gl_FragCoord.xy / vResolution;\n  st = 2.0 * st - 1.0;\n  float d = distance(st, vPos);\n  d = 1.0 - smoothstep(0.195, 0.2, d);\n  gl_FragColor = d * vec4(0, 0, 1, 1);\n}\n</code></pre><p>ç»è¿‡å‰é¢è¯¾ç¨‹çš„å­¦ä¹ ï¼Œä½ åº”è¯¥å¯¹é€ å‹å‡½æ•°çš„å®ç°åŸç†æ¯”è¾ƒç†Ÿæ‚‰äº†ï¼Œè¿™é‡Œæˆ‘ä»¬å°±æ˜¯é€šè¿‡è®¡ç®—åˆ°åœ†å¿ƒçš„è·ç¦»å¾—å‡ºè·ç¦»åœºï¼Œç„¶åé€šè¿‡smoothstepå°†ä¸€å®šè·ç¦»å†…çš„å›¾å½¢ç»˜åˆ¶å‡ºæ¥ï¼Œè¿™æ ·å°±å¾—åˆ°ä¸€ä¸ªè“è‰²çš„åœ†ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/62/35/6220f0e98ae2cfc95189df136d59bb35.jpeg?wh=1920*1080\" alt=\"\"></p><p>ç”¨è¿™æ ·çš„æ€è·¯å‘¢ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°æ–°çš„ç»˜åˆ¶å¤§é‡åœ†çš„æ–¹æ³•äº†ã€‚è¿™ç§æ€è·¯å®ç°åœ†çš„ä»£ç å¦‚ä¸‹ï¼š</p><pre><code>const canvas = document.querySelector('canvas');\nconst renderer = new GlRenderer(canvas);\n\nconst vertex = `\n  attribute vec2 a_vertexPosition;\n  attribute vec4 color;\n  attribute float bias;\n\n  uniform float uTime;\n  uniform vec2 uResolution;\n\n  varying vec4 vColor;\n  varying vec2 vPos;\n  varying vec2 vResolution;\n  varying float vScale;\n\n  void main() {\n    float scale = 0.7 + 0.3 * sin(6.28 * bias + 0.003 * uTime);\n    gl_PointSize = 0.05 * uResolution.x * scale;\n    vColor = color;\n    vPos = a_vertexPosition;\n    vResolution = uResolution;\n    vScale = scale;\n    gl_Position = vec4(a_vertexPosition, 1, 1);\n  }\n`;\n\n\nconst fragment = `\n  #ifdef GL_ES\n  precision highp float;\n  #endif\n\n  varying vec4 vColor;\n  varying vec2 vPos;\n  varying vec2 vResolution;\n  varying float vScale;\n  \n  void main() {\n    vec2 st = gl_FragCoord.xy / vResolution;\n    st = 2.0 * st - vec2(1);\n    float d = step(distance(vPos, st), 0.05 * vScale);\n    gl_FragColor = d * vColor;\n  }\n`;\nconst program = renderer.compileSync(fragment, vertex);\nrenderer.useProgram(program);\n\nconst COUNT = 200000;\nfunction init() {\n  const colors = [];\n  const pos = [];\n  const bias = [];\n  for(let i = 0; i &lt; COUNT; i++) {\n    const x = 2 * Math.random() - 1;\n    const y = 2 * Math.random() - 1;\n    const rotation = 2 * Math.PI * Math.random();\n\n    colors.push([\n      Math.random(),\n      Math.random(),\n      Math.random(),\n      1\n    ]);\n\n    pos.push([\n      2 * Math.random() - 1,\n      2 * Math.random() - 1\n    ]);\n\n    bias.push(\n      Math.random()\n    );\n  }\n\n  renderer.uniforms.uTime = 0;\n  renderer.uniforms.uResolution = [canvas.width, canvas.height];\n\n  renderer.setMeshData({\n    mode: renderer.gl.POINTS,\n    enableBlend: true,\n    positions: pos,\n    attributes: {\n      color: {data: [...colors]},\n      bias: {data: [...bias]},\n    },\n  });\n}\ninit();\n\n\nfunction update(t) {\n  renderer.uniforms.uTime = t;\n  renderer.render();\n  requestAnimationFrame(update);\n}\n\nupdate(0);\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬æ²¡æœ‰é‡‡ç”¨å‰é¢é‚£æ ·é€šè¿‡circleå‡½æ•°æ¥ç”Ÿæˆåœ†çš„é¡¶ç‚¹æ•°æ®ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨gl.POINTSæ¥ç»˜åˆ¶ï¼Œå¹¶åœ¨ç€è‰²å™¨ä¸­ç”¨è·ç¦»åœºå’Œé€ å‹å‡½æ•°æ¥ç”»åœ†ã€‚è¿™ä¹ˆåšä¹‹åï¼Œæˆ‘ä»¬å¤§å¤§å‡å°‘äº†é¡¶ç‚¹çš„è¿ç®—ï¼ŒåŸå…ˆæˆ‘ä»¬æ¯ç»˜åˆ¶ä¸€ä¸ªåœ†ï¼Œéœ€è¦32ä¸ªé¡¶ç‚¹ã€30ä¸ªä¸‰è§’å½¢ï¼Œè€Œç°åœ¨ç”¨ä¸€ä¸ªç‚¹å°±è§£å†³äº†é—®é¢˜ã€‚è¿™æ ·ä¸€æ¥ï¼Œå°±ç®—æˆ‘ä»¬è¦æ¸²æŸ“200000ä¸ªç‚¹ï¼Œå¸§ç‡ä¹Ÿå¯ä»¥ä¿æŒåœ¨50fpsä»¥ä¸Šï¼Œæ€§èƒ½åˆæå‡äº†è¶…è¿‡ä¸€å€ï¼</p><p><img src=\"https://static001.geekbang.org/resource/image/9f/a7/9fa5964587dbb8edf192d3de95c938a7.jpeg?wh=1920*1080\" alt=\"\"></p><h2>å…¶ä»–æ–¹æ³•</h2><p>è¿™é‡Œä¸¾ä¸Šé¢çš„è¿™ä¸ªä¾‹å­ï¼Œä¸»è¦æ˜¯æƒ³è¯´æ˜ä¸€ä¸ªé—®é¢˜ï¼šå³ä½¿æ˜¯ä½¿ç”¨WebGLï¼Œä¸åŒçš„æ¸²æŸ“æ–¹å¼ï¼Œæ€§èƒ½çš„å·®åˆ«ä¹Ÿä¼šå¾ˆå¤§ï¼Œç”šè‡³ä¼šè¾¾åˆ°æ•°åƒå€çš„å·®åˆ«ã€‚å› æ­¤ï¼Œåœ¨å¯è§†åŒ–ä¸šåŠ¡ä¸­ï¼Œæˆ‘ä»¬ä¸€å®šè¦å­¦ä¼š<strong>æ ¹æ®ä¸åŒçš„åº”ç”¨åœºæ™¯æ¥æœ‰é’ˆå¯¹æ€§åœ°è¿›è¡Œä¼˜åŒ–</strong>ã€‚è¯´èµ·æ¥ç®€å•ï¼Œè¦åšåˆ°è¿™ä¸€ç‚¹å¹¶ä¸å®¹æ˜“ï¼Œä½ éœ€è¦å¯¹WebGLæœ¬èº«éå¸¸ç†Ÿæ‚‰ï¼Œè€Œä¸”å¯¹äºGPUçš„ä½¿ç”¨ã€æ¸²æŸ“ç®¡çº¿ç­‰åŸºæœ¬åŸç†æœ‰ç€æ¯”è¾ƒæ·±åˆ»çš„ç†è§£ã€‚è¿™ä¸æ˜¯ä¸€æœä¸€å¤•å¯ä»¥åšåˆ°çš„ï¼Œéœ€è¦æŒç»­ä¸æ–­åœ°å­¦ä¹ å’Œç§¯ç´¯ã€‚</p><p>å°±åƒæœ‰äº›åŒå­¦ä½¿ç”¨ç»˜å›¾åº“ThreeJSæˆ–è€…SpriteJSæ¥ç»˜å›¾çš„æ—¶å€™ï¼Œåšå‡ºæ¥çš„åº”ç”¨æ€§èƒ½å¾ˆå·®ï¼Œå°±ä¼šæ€€ç–‘æ˜¯å›¾å½¢åº“æœ¬èº«çš„é—®é¢˜ã€‚å®é™…ä¸Šï¼Œè¿™äº›é—®é¢˜å¾ˆå¯èƒ½ä¸æ˜¯åº“æœ¬èº«çš„é—®é¢˜ï¼Œè€Œæ˜¯æˆ‘ä»¬ä½¿ç”¨æ–¹æ³•ä¸Šçš„é—®é¢˜ã€‚æ¢å¥è¯è¯´ï¼Œæ˜¯æˆ‘ä»¬ä½¿ç”¨çš„ç»˜å›¾æ–¹å¼å¹¶ä¸æ˜¯æœ€é€‚ç”¨äºå½“å‰çš„ä¸šåŠ¡åœºæ™¯ã€‚è€ŒThreeJSã€SpriteJSè¿™äº›é€šç”¨çš„ç»˜å›¾åº“ï¼Œä¹Ÿå¹¶ä¸ä¼šè‡ªå·±é’ˆå¯¹ç‰¹å®šåœºæ™¯æ¥ä¼˜åŒ–ã€‚</p><p>å› æ­¤ï¼Œå•çº¯ä½¿ç”¨å›¾å½¢åº“ï¼Œæˆ‘ä»¬ç»˜åˆ¶å‡ºæ¥çš„å›¾å½¢å°±æ²¡æ³•çœŸæ­£è¾¾åˆ°æ€§èƒ½æè‡´ã€‚ä¹Ÿæ­£æ˜¯å› ä¸ºè¿™ä¸ªåŸå› ï¼Œæˆ‘æ²¡æœ‰æŠŠè¿™é—¨è¯¾ç¨‹çš„é‡ç‚¹æ”¾åœ¨åº“çš„APIçš„ä½¿ç”¨ä¸Šï¼Œè€Œæ˜¯æ·±å…¥åˆ°å›¾å½¢æ¸²æŸ“çš„åº•å±‚åŸç†ã€‚åªæœ‰æŒæ¡äº†è¿™äº›ï¼Œä½ æ‰èƒ½çœŸæ­£å­¦ä¼šå¦‚ä½•é©¾é©­å›¾å½¢åº“ï¼Œåšå‡ºé«˜æ€§èƒ½çš„å¯è§†åŒ–è§£å†³æ–¹æ¡ˆæ¥ã€‚</p><p>é’ˆå¯¹åœºæ™¯çš„æ€§èƒ½ä¼˜åŒ–æ–¹æ³•å…¶å®éå¸¸å¤šï¼Œæˆ‘åˆšæ‰è®²çš„ä¹Ÿåªæ˜¯å‡ ç§å…¸å‹çš„æƒ…å†µã€‚ä¸ºäº†å¸®åŠ©ä½ åœ¨å®æˆ˜ä¸­æ…¢æ…¢é¢†æ‚Ÿï¼Œæˆ‘å†ä¸¾å‡ ä¸ªä¾‹å­ã€‚ä¸è¿‡æˆ‘è¦æå‰è¯´ä¸€ä¸‹ï¼Œæˆ‘ä¸ä¼šå…·ä½“å»è®²è¿™äº›ä¾‹å­çš„ä»£ç ï¼Œåªä¼šé‡ç‚¹å¼ºè°ƒå¸¸ç”¨çš„æ€è·¯ã€‚å­¦ä¼šè¿™äº›æ–¹æ³•ä¹‹åï¼Œä½ å†åœ¨å®è·µä¸­æ…¢æ…¢åº”ç”¨å’Œä½“ä¼šå°±ä¼šå®¹æ˜“å¾ˆå¤šäº†ã€‚</p><p><strong>1.  ä½¿ç”¨åæœŸå¤„ç†é€šé“ä¼˜åŒ–</strong></p><p>æˆ‘ä»¬å·²ç»å­¦ä¹ è¿‡ä½¿ç”¨åæœŸå¤„ç†é€šé“çš„åŸºæœ¬æ–¹æ³•ã€‚å®é™…ä¸Šï¼ŒåæœŸå¤„ç†é€šé“ååˆ†å¼ºå¤§ï¼Œå®ƒæœ€é‡è¦çš„ç‰¹æ€§å°±æ˜¯å¯ä»¥æŠŠå„ç§æ•°æ®å­˜å‚¨åœ¨çº¹ç†å›¾ç‰‡ä¸­ã€‚è¿™æ ·åœ¨è¿­ä»£å¤„ç†çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”¨GPUå°†è¿™äº›æ•°æ®å¹¶è¡Œåœ°è¯»å–å’Œå¤„ç†ï¼Œä»è€Œè¾¾åˆ°éå¸¸é«˜æ•ˆåœ°æ¸²æŸ“ã€‚</p><p>è¿™é‡Œæ˜¯ä¸€ä¸ªOGLå®˜ç½‘ä¸Š<a href=\"https://oframe.github.io/ogl/examples/?src=post-fluid-distortion.html\">ä¾‹å­</a>ï¼Œå®ƒå°±æ˜¯ç”¨åæœŸå¤„ç†é€šé“å®ç°äº†ç²’å­æµçš„æ•ˆæœã€‚è¿™æ ·çš„æ•ˆæœï¼Œåœ¨å…¶ä»–å›¾å½¢ç³»ç»Ÿä¸­ï¼Œæˆ–è€…WebGLä¸ä½¿ç”¨åæœŸå¤„ç†é€šé“æ˜¯ä¸å¯èƒ½åšåˆ°çš„ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/88/2d/886d5b36c0ab94294yy378ab67f0ea2d.gif?wh=480*339\" alt=\"\"></p><p>è¿™é‡Œçš„å…·ä½“å®ç°æ¯”è¾ƒå¤æ‚ï¼Œä½†å…¶ä¸­æœ€å…³é”®çš„ä¸€ç‚¹æ˜¯ï¼Œæˆ‘ä»¬è¦å°†æ¯ä¸ªåƒç´ ç‚¹çš„é€Ÿåº¦å€¼ä¿å­˜åˆ°çº¹ç†å›¾ç‰‡ä¸­ï¼Œç„¶ååˆ©ç”¨GPUå¹¶è¡Œè®¡ç®—çš„èƒ½åŠ›ï¼Œå¯¹æ¯ä¸ªåƒç´ ç‚¹åŒæ—¶è¿›è¡Œå¤„ç†ã€‚</p><p><strong>2.  ä½¿ç”¨GPGPUä¼˜åŒ–</strong></p><p>è¿˜æœ‰ä¸€ç§ä¼˜åŒ–æ€è·¯å’ŒåæœŸå¤„ç†é€šé“å¾ˆåƒï¼Œåˆšå¥½OGLå®˜ç½‘ä¹Ÿæœ‰è¿™ä¸ªä¾‹å­ï¼Œå®ƒä½¿ç”¨äº†ä¸€ç§å«åšGPGPUçš„æ–¹å¼ï¼Œä¹Ÿå«åšé€šç”¨GPUæ–¹å¼ï¼Œå°±æ˜¯æŠŠæ¯ä¸ªç²’å­çš„é€Ÿåº¦ä¿å­˜åˆ°çº¹ç†å›¾ç‰‡é‡Œï¼Œå®ç°åŒæ—¶æ¸²æŸ“å‡ ä¸‡ä¸ªç²’å­å¹¶äº§ç”Ÿè¿åŠ¨çš„æ•ˆæœã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/07/d6/07ed4788452a2e214c61fb634fcdd8d6.gif?wh=678*480\" alt=\"\"></p><p><strong>3.  ä½¿ç”¨æœåŠ¡ç«¯æ¸²æŸ“ä¼˜åŒ–</strong></p><p>æœ€åä¸€ç§ä¼˜åŒ–æ€è·¯ï¼Œæ˜¯ä»æˆ‘ä¹‹å‰åšè¿‡çš„ä¸€ä¸ªå¯è§†åŒ–é¡¹ç›®ä¸­æå–å‡ºæ¥çš„ã€‚å½“æ—¶ï¼Œæˆ‘éœ€è¦æ¸²æŸ“æ•°åä¸‡æ¡å†å²æ•°æ®çš„è®°å½•ï¼Œå¦‚æœå•çº¯åœ¨å‰ç«¯æ¸²æŸ“ï¼Œæ€§èƒ½ä¼šæˆä¸ºç“¶é¢ˆã€‚ä½†ç”±äºè¿™äº›æ•°æ®éƒ½æ˜¯å†å²æ•°æ®ï¼Œå› æ­¤é’ˆå¯¹è¿™ä¸ªåœºæ™¯æˆ‘ä»¬å¯ä»¥åœ¨æœåŠ¡ç«¯è¿›è¡Œæ¸²æŸ“ï¼Œç„¶åç›´æ¥å°†æ¸²æŸ“åçš„å›¾ç‰‡è¾“å‡ºç»™å‰ç«¯ã€‚</p><p>è¦ä½¿ç”¨æœåŠ¡ç«¯æ¸²æŸ“ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <a href=\"https://github.com/akira-cn/node-canvas-webgl\">Node-canvas-webgl</a> è¿™ä¸ªåº“ï¼Œå®ƒå¯ä»¥åœ¨Node.jsä¸­å¯åŠ¨ä¸€ä¸ªCanvas2Då’ŒWebGLç¯å¢ƒï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨æœåŠ¡ç«¯è¿›è¡Œæ¸²æŸ“ï¼Œç„¶åå†å°†ç»“æœç¼“å­˜èµ·æ¥ç›´æ¥æä¾›ç»™å®¢æˆ·ç«¯ã€‚</p><h2>è¦ç‚¹æ€»ç»“</h2><p>è¿™èŠ‚è¯¾æˆ‘ä»¬ä¸»è¦è®²äº†é’ˆå¯¹ä¸šåŠ¡çš„ä¸åŒåº”ç”¨åœºæ™¯è¿›è¡Œæ€§èƒ½ä¼˜åŒ–çš„æ€è·¯å’Œæ–¹æ³•ã€‚å°¤å…¶æ˜¯åœ¨æµ·é‡æ•°æ®çš„æƒ…å†µä¸‹ï¼Œç‰¹å®šä¼˜åŒ–æ‰‹æ®µæ˜¾å¾—ååˆ†é‡è¦ï¼Œç”šè‡³æœ‰å¯èƒ½äº§ç”Ÿä¸Šåƒå€çš„æ€§èƒ½å·®è·ã€‚</p><p>ç»“åˆä»Šå¤©çš„ä¾‹å­ï¼Œå¯¹äºè¦ç»˜åˆ¶å¤§é‡åœ†å½¢çš„åœºæ™¯ï¼Œæˆ‘ä»¬ç”¨å¸¸è§„çš„å¤„ç†æ–¹æ³•ï¼Œæ¸²æŸ“500ä¸ªå…ƒç´ éƒ½æ¯”è¾ƒåƒåŠ›ï¼Œä¸€æ—¦æˆ‘ä»¬ä½¿ç”¨äº†æ‰¹é‡æ¸²æŸ“ï¼Œå°±å¯ä»¥æŠŠæ€§èƒ½ä¸€ä¸‹å­æå‡ä¸¤åƒå€ä»¥ä¸Šï¼Œèƒ½å¤Ÿè½»æ¾æ¸²æŸ“10ä¸‡ä¸ªå…ƒç´ ï¼Œå¦‚æœæˆ‘ä»¬å†ä½¿ç”¨ç‚¹å›¾å…ƒç»“åˆé€ å‹å‡½æ•°çš„æ–¹æ³•ï¼Œå°±èƒ½è½»æ¾æ¸²æŸ“20ä¸‡ä¸ªä»¥ä¸Šçš„å…ƒç´ äº†ã€‚åƒè¿™æ ·çš„ä¼˜åŒ–æ–¹æ³•ï¼Œéœ€è¦æˆ‘ä»¬ç†è§£ä¸šåŠ¡åœºæ™¯ï¼Œå¹¶å¯¹WebGLå’ŒGPUã€æ¸²æŸ“ç®¡çº¿ç­‰æœ‰æ·±å…¥çš„ç†è§£ï¼Œå†åœ¨é¡¹ç›®å®è·µä¸­æ…¢æ…¢ç§¯ç´¯ã€‚</p><p>é™¤æ­¤ä»¥å¤–ï¼Œæˆ‘ä»¬è¿˜ç®€å•ä»‹ç»äº†å…¶ä»–çš„ä¸€äº›ä¼˜åŒ–æ‰‹æ®µï¼ŒåŒ…æ‹¬ä½¿ç”¨åæœŸå¤„ç†é€šé“ã€ä½¿ç”¨GPGPUå’Œä½¿ç”¨æœåŠ¡ç«¯æ¸²æŸ“ã€‚ä½ å¯ä»¥ç»“åˆæˆ‘ç»™å‡ºçš„ä¾‹å­å»æ·±å…¥ç†è§£ã€‚</p><h2>å°è¯•ç‰›åˆ€</h2><p>ä»Šå¤©ï¼Œæˆ‘ä»¬ä½¿ç”¨ç‚¹å›¾å…ƒç»“åˆé€ å‹å‡½æ•°çš„æ€è·¯ï¼Œç»˜åˆ¶äº†æ­£æ–¹å½¢å’Œåœ†ï¼Œä½ è¿˜èƒ½ç»˜åˆ¶å‡ºå…¶ä»–ä¸åŒå›¾å½¢å—ï¼Ÿæ¯”å¦‚åœ†ã€æ­£æ–¹å½¢ã€è±å½¢ã€èŠ±ç“£ã€è‹¹æœæˆ–è‘«èŠ¦ç­‰ç­‰ã€‚</p><p>æ¬¢è¿åœ¨ç•™è¨€åŒºå’Œæˆ‘è®¨è®ºï¼Œåˆ†äº«ä½ çš„ç­”æ¡ˆå’Œæ€è€ƒï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™ä½ çš„æœ‹å‹ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ï¼</p><hr><h2><span class=\"reference\">æºç </span></h2><p><span class=\"reference\"><a href=\"https://github.com/akira-cn/graphics/tree/master/performance-more\">è¯¾ç¨‹ä¸­å®Œæ•´ç¤ºä¾‹ä»£ç </a></span></p><h2><span class=\"reference\">æ¨èé˜…è¯»</span></h2><p><span class=\"reference\">[1] <a href=\"https://oframe.github.io/ogl/examples/post-fluid-distortion.html\">Post Fluid Distortion</a></span></p><p><span class=\"reference\">[2] <a href=\"https://oframe.github.io/ogl/examples/gpgpu-particles.html\">GPGPU Particles (General-Purpose computing on Graphics Processing Units)</a></span></p><p><span class=\"reference\">[3] <a href=\"https://github.com/akira-cn/node-canvas-webgl\">Node-canvas-webgl</a></span></p>","comments":[{"had_liked":false,"id":260469,"user_name":"swtgeo","can_delete":false,"product_type":"c1","uid":2071211,"ip_address":"","ucode":"4DF64AC45FBCEA","user_header":"","comment_is_top":false,"comment_ctime":1605016803,"is_pvip":false,"replies":[{"id":"94951","content":"å¯ä»¥çš„ï¼Œä½ å¯ä»¥è¯•ç€ç”¨node-canvas-webgl+spritejsæ¥æ¸²æŸ“ï¼Œè¿™ä¸¤ä¸ªåº“éƒ½åœ¨githubä¸Šå¼€æºçš„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"æœˆå½±","uid":"1159792","ctime":1605492403,"ip_address":"","comment_id":260469,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10194951395","product_id":100053801,"comment_content":"è¯·é—®æœ‰æ²¡æœ‰å…³äºåœ¨æœåŠ¡ç«¯è¿›è¡Œæ¸²æŸ“ï¼Œç„¶åç›´æ¥å°†æ¸²æŸ“åçš„å›¾ç‰‡è¾“å‡ºç»™å‰ç«¯å¯è§†åŒ–çš„å‚è€ƒé¡¹ç›®å®ä¾‹å‘¢ï¼Ÿé¥æ„Ÿå½±åƒèƒ½ä¸èƒ½åœ¨åç«¯åŠ¨æ€åˆ‡ç‰‡æ¸²æŸ“ï¼Œç„¶åè¾“å‡ºåˆ°å‰ç«¯æ˜¾ç¤ºå‘¢ï¼Œçœç•¥åˆ‡ç‰‡ç¼“å­˜çš„è¿‡ç¨‹ã€‚","like_count":3,"discussions":[{"author":{"id":1159792,"avatar":"https://static001.geekbang.org/account/avatar/00/11/b2/70/ba9cecc6.jpg","nickname":"æœˆå½±","note":"","ucode":"298582FA7DBF27","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":509203,"discussion_content":"å¯ä»¥çš„ï¼Œä½ å¯ä»¥è¯•ç€ç”¨node-canvas-webgl+spritejsæ¥æ¸²æŸ“ï¼Œè¿™ä¸¤ä¸ªåº“éƒ½åœ¨githubä¸Šå¼€æºçš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605492403,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":251312,"user_name":"æœ¨ç“œ777","can_delete":false,"product_type":"c1","uid":1512537,"ip_address":"","ucode":"FC52A499AF6374","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/aFAYPyw7ywC1xE9h1qibnTBwtWn2ClJqlicy5cMomhZVaruMyqSq76wMkS279mUaGhrLGwWo9ZnW0WCWfmMovlXw/132","comment_is_top":false,"comment_ctime":1601458225,"is_pvip":false,"replies":[{"id":"94958","content":"ç‰‡å…ƒç€è‰²å™¨é‡Œå¤„ç†çš„æ˜¯å…‰æ …åŒ–åçš„åæ ‡ï¼Œä¸‰ç»´åæ ‡å¯ä»¥åœ¨é¡¶ç‚¹ç€è‰²å™¨ä¸­å¤„ç†ï¼Œæ¯”è¾ƒå¤æ‚ï¼Œä½†æ˜¯æ€è·¯ä¸Šæ˜¯ç±»ä¼¼çš„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"æœˆå½±","uid":"1159792","ctime":1605492871,"ip_address":"","comment_id":251312,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5896425521","product_id":100053801,"comment_content":"è·ç¦»åœº èƒ½ä¸èƒ½ å®ç° ç»˜åˆ¶ çƒ å•Šï¼Ÿ å¦‚æœå¯ä»¥ï¼Œèƒ½ä¸èƒ½æä¾›ä¸‹æ€è·¯ï¼Ÿ ç¤ºä¾‹ä¸­ float d = distance(st, vPos);  å…¶ä¸­ vPos å¦‚æœæ˜¯ä¸‰ç»´åæ ‡ è¯¥å¦‚ä½•å¤„ç†ï¼Ÿ<br>","like_count":1,"discussions":[{"author":{"id":1159792,"avatar":"https://static001.geekbang.org/account/avatar/00/11/b2/70/ba9cecc6.jpg","nickname":"æœˆå½±","note":"","ucode":"298582FA7DBF27","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":506446,"discussion_content":"ç‰‡å…ƒç€è‰²å™¨é‡Œå¤„ç†çš„æ˜¯å…‰æ …åŒ–åçš„åæ ‡ï¼Œä¸‰ç»´åæ ‡å¯ä»¥åœ¨é¡¶ç‚¹ç€è‰²å™¨ä¸­å¤„ç†ï¼Œæ¯”è¾ƒå¤æ‚ï¼Œä½†æ˜¯æ€è·¯ä¸Šæ˜¯ç±»ä¼¼çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605492871,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":313349,"user_name":"æˆ‘æ‰§","can_delete":false,"product_type":"c1","uid":1372261,"ip_address":"","ucode":"54A052C54BDE91","user_header":"https://static001.geekbang.org/account/avatar/00/14/f0/65/e1340d42.jpg","comment_is_top":false,"comment_ctime":1632385361,"is_pvip":false,"replies":[{"id":"114127","content":"é™ä½ç²¾åº¦ï¼Œå¯ä»¥ç”¨ç‚¹æŠ½ç¨€ç®—æ³•ï¼Œå…·ä½“ä½ å¯ä»¥æœä¸€ä¸‹ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"æœˆå½±","uid":"1159792","ctime":1633749985,"ip_address":"","comment_id":313349,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1632385361","product_id":100053801,"comment_content":"å¤§ä½¬ï¼Œ é’ˆå¯¹ geojson è¿‡å¤§æœ‰å“ªäº›ä¼˜åŒ–æ–¹æ¡ˆå‘¢ï¼Ÿ<br>æˆ‘ç°åœ¨è¿™è¾¹é‡åˆ°çš„éœ€æ±‚æ˜¯ æ¸²æŸ“æ‘çº§ è½®å»“ï¼Œ ä½†æ˜¯æ‹¿åˆ°çš„ä¸€ä¸ªå¸‚geojson æœ‰70å¤šMã€‚ <br>åç«¯gisåœ¨å½“å‰èŠ‚ç‚¹å®ç°å‘¨æœŸå¤ªé•¿ï¼Œ æˆ‘è¿™è¾¹åœ¨å¯»æ‰¾å•ç‹¬å‰ç«¯çš„çªç ´ç‚¹<br>1. ä¹‹å‰æ‰¾åˆ° echarts é’ˆå¯¹ geojsonçš„ å‹ç¼©æ–¹æ³•ï¼Œ å°è¯•ä½¿ç”¨ï¼Œ å¹¶å¯¹æ•°æ®åˆ†ç‰‡åŠ è½½ï¼Œ æœ‰ä¸€å®šæ•ˆæœï¼Œä½†æ˜¯è¿˜æ˜¯ä¸å¤Ÿ<br>2. çœ‹åˆ°äº†è¿™ç¯‡ä¸“æ äº†è§£åˆ°äº† topojson ï¼Œ å°è¯•ä½¿ç”¨ï¼Œ å¹¶å¯¹æ•°æ®åˆ†ç‰‡åŠ è½½ï¼Œ ä¹Ÿæ•ˆæœä¸å¤Ÿ<br>æœ€åèƒ½æƒ³åˆ°çš„è¿˜æ˜¯ é’ˆå¯¹åŸå§‹çš„ geojson å»åšå¤„ç†ï¼Œ çœ‹èƒ½ä¸èƒ½é™ä½ç²¾åº¦ã€‚ ä½†æ˜¯æ²¡æœ‰æ‰¾åˆ°ç›¸åº”èµ„æ–™ï¼Œ å¸Œæœ›å¤§ä½¬èƒ½æä¾›ä¸€å®šè§£å†³æ€è·¯","like_count":0,"discussions":[{"author":{"id":1159792,"avatar":"https://static001.geekbang.org/account/avatar/00/11/b2/70/ba9cecc6.jpg","nickname":"æœˆå½±","note":"","ucode":"298582FA7DBF27","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527321,"discussion_content":"é™ä½ç²¾åº¦ï¼Œå¯ä»¥ç”¨ç‚¹æŠ½ç¨€ç®—æ³•ï¼Œå…·ä½“ä½ å¯ä»¥æœä¸€ä¸‹ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633749985,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":267850,"user_name":"Zack","can_delete":false,"product_type":"c1","uid":1758012,"ip_address":"","ucode":"758511DF7D6D17","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eokhlnrZO1G1SnxWka7hSeqwHnIcuQKugQDBDKUDXc2ZDXKsibHTNviaG6CiaqBiaK5Bwcu37xakaFthw/132","comment_is_top":false,"comment_ctime":1607952753,"is_pvip":false,"replies":[{"id":"101094","content":"å¯ä»¥ä½¿ç”¨å‘€ï¼Œnodeæ”¯æŒ","user_name":"ä½œè€…å›å¤","user_name_real":"æœˆå½±","uid":"1159792","ctime":1612875922,"ip_address":"","comment_id":267850,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1607952753","product_id":100053801,"comment_content":"æœåŠ¡ç«¯æ¸²æŸ“é‡Œæ²¡åŠæ³•ä½¿ç”¨gpuå§ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1159792,"avatar":"https://static001.geekbang.org/account/avatar/00/11/b2/70/ba9cecc6.jpg","nickname":"æœˆå½±","note":"","ucode":"298582FA7DBF27","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":511762,"discussion_content":"å¯ä»¥ä½¿ç”¨å‘€ï¼Œnodeæ”¯æŒ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1612875922,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":247626,"user_name":"ä¸œä¸œ","can_delete":false,"product_type":"c1","uid":1358525,"ip_address":"","ucode":"266C0985FB595F","user_header":"https://static001.geekbang.org/account/avatar/00/14/ba/bd/446a2876.jpg","comment_is_top":false,"comment_ctime":1599782678,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1599782678","product_id":100053801,"comment_content":"å‰å®³ğŸ‘ğŸ»","like_count":0}]}