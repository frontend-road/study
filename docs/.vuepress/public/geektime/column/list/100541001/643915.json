{"id":643915,"title":"06｜ChatGPT来了，让我们快速做个AI应用","content":"<p>你好，我是徐文浩。</p><p>过去的两讲，我带着你通过OpenAI提供的Embedding接口，完成了文本分类的功能。那么，这一讲里，我们重新回到Completion接口。而且这一讲里，我们还会快速搭建出一个有界面的聊天机器人来给你用。在这个过程里，你也会第一次使用 HuggingFace 这个平台。</p><p>HuggingFace 是现在最流行的深度模型的社区，你可以在里面下载到最新开源的模型，以及看到别人提供的示例代码。</p><h2>ChatGPT来了，更快的速度更低的价格</h2><p>我在<a href=\"https://time.geekbang.org/column/article/642197\">第03讲</a>里，已经给你看了如何通过Completion的接口，实现一个聊天机器人的功能。在那个时候，我们采用的是自己将整个对话拼接起来，将整个上下文都发送给OpenAI的Completion API的方式。不过，在3月2日，因为ChatGPT的火热，OpenAI放出了一个直接可以进行对话聊天的接口。这个接口叫做 <strong>ChatCompletion</strong>，对应的模型叫做gpt-3.5-turbo，不但用起来更容易了，速度还快，而且价格也是我们之前使用的 text-davinci-003 的十分之一，可谓是物美价廉了。</p><pre><code class=\"language-python\">import openai\nopenai.ChatCompletion.create(\n  model=\"gpt-3.5-turbo\",\n  messages=[\n        {\"role\": \"system\", \"content\": \"You are a helpful assistant.\"},\n        {\"role\": \"user\", \"content\": \"Who won the world series in 2020?\"},\n        {\"role\": \"assistant\", \"content\": \"The Los Angeles Dodgers won the World Series in 2020.\"},\n        {\"role\": \"user\", \"content\": \"Where was it played?\"}\n    ]\n)\n</code></pre><!-- [[[read_end]]] --><p><span class=\"reference\">注：点击在这个<a href=\"https://platform.openai.com/docs/guides/chat\">链接</a>你可以看到接口调用示例。</span></p><p>在OpenAI的官方文档里，可以看到这个接口也非常简单。你需要传入的参数，从一段Prompt变成了一个数组，数组的每个元素都有role和content两个字段。</p><ol>\n<li>role这个字段一共有三个角色可以选择，其中 system 代表系统，user代表用户，而assistant则代表AI的回答。</li>\n<li>当role是system的时候，content里面的内容代表我们给AI的一个指令，也就是告诉AI应该怎么回答用户的问题。比如我们希望AI都通过中文回答，我们就可以在content里面写“你是一个只会用中文回答问题的助理”，这样即使用户问的问题都是英文的，AI的回复也都会是中文的。</li>\n<li>而当role是user或者assistant的时候，content里面的内容就代表用户和AI对话的内容。和我们在<a href=\"https://time.geekbang.org/column/article/642197\">第03讲</a>里做的聊天机器人一样，你需要把历史上的对话一起发送给OpenAI的接口，它才能有理解整个对话的上下文的能力。</li>\n</ol><p>有了这个接口，我们就很容易去封装一个聊天机器人了，我把代码放在了下面，我们一起来看一看。</p><pre><code class=\"language-python\">import openai\nimport os\n\nopenai.api_key = os.environ.get(\"OPENAI_API_KEY\")\n\nclass Conversation:\n    def __init__(self, prompt, num_of_round):\n        self.prompt = prompt\n        self.num_of_round = num_of_round\n        self.messages = []\n        self.messages.append({\"role\": \"system\", \"content\": self.prompt})\n\n    def ask(self, question):\n        try:\n            self.messages.append({\"role\": \"user\", \"content\": question})\n            response = openai.ChatCompletion.create(\n                model=\"gpt-3.5-turbo\",\n                messages=self.messages,\n                temperature=0.5,\n                max_tokens=2048,\n                top_p=1,\n            )\n        except Exception as e:\n            print(e)\n            return e\n\n        message = response[\"choices\"][0][\"message\"][\"content\"]\n        self.messages.append({\"role\": \"assistant\", \"content\": message})\n\n        if len(self.messages) &gt; self.num_of_round*2 + 1:\n            del self.messages[1:3] //Remove the first round conversation left.\n        return message\n</code></pre><ol>\n<li>我们封装了一个Conversation类，它的构造函数 <strong>init</strong> 会接受两个参数，prompt 作为 system的content，代表我们对这个聊天机器人的指令，num_of_round 代表每次向ChatGPT发起请求的时候，保留过去几轮会话。</li>\n<li>Conversation类本身只有一个ask函数，输入是一个string类型的question，返回结果也是string类型的一条message。</li>\n<li>每次调用ask函数，都会向ChatGPT发起一个请求。在这个请求里，我们都会把最新的问题拼接到整个对话数组的最后，而在得到ChatGPT的回答之后也会把回答拼接上去。如果回答完之后，发现会话的轮数超过我们设置的num_of_round，我们就去掉最前面的一轮会话。</li>\n</ol><p>下面，我们就来试一试这个Conversation类好不好使。</p><pre><code class=\"language-python\">prompt = \"\"\"你是一个中国厨师，用中文回答做菜的问题。你的回答需要满足以下要求:\n1. 你的回答必须是中文\n2. 回答限制在100个字以内\"\"\"\nconv1 = Conversation(prompt, 2)\nquestion1 = \"你是谁？\"\nprint(\"User : %s\" % question1)\nprint(\"Assistant : %s\\n\" % conv1.ask(question1))\n\nquestion2 = \"请问鱼香肉丝怎么做？\"\nprint(\"User : %s\" % question2)\nprint(\"Assistant : %s\\n\" % conv1.ask(question2))\n\nquestion3 = \"那蚝油牛肉呢？\"\nprint(\"User : %s\" % question3)\nprint(\"Assistant : %s\\n\" % conv1.ask(question3))\n</code></pre><ol>\n<li>我们给到了ChatGPT一个指令，告诉它它是一个中国厨子，用中文回答问题，而且回答在100个字以内，并且我们设定了AI只记住过去3轮的对话。</li>\n<li>然后，我们按照顺序问了他，“你是谁”，“鱼香肉丝怎么做”以及“那蚝油牛肉呢”这三个问题。</li>\n<li>可以看到，在回答里它说自己可以回答做菜的问题，而且回答都在100个字以内。</li>\n<li>并且，我们问他“那蚝油牛肉呢”的时候，它也的确记住了上下文，知道我们问的是菜的做法，而不是价格或者其他信息。</li>\n</ol><pre><code class=\"language-python\">User : 你是谁？\nAssistant : 我是一个AI语言模型，可以回答你的做菜问题。\nUser : 请问鱼香肉丝怎么做？\nAssistant : 鱼香肉丝的做法：\n1. 瘦猪肉切丝，用盐、淀粉、料酒腌制；\n2. 香葱、姜、蒜切末备用；\n3. 青红椒切丝备用；\n4. 热锅凉油，放入肉丝煸炒至变色；\n5. 放入葱姜蒜末和青红椒丝煸炒；\n6. 加入适量盐、糖、醋、酱油、料酒、水淀粉翻炒均匀；\n7. 淋上少许香油即可。\nUser : 那蚝油牛肉呢？\nAssistant : 蚝油牛肉的做法：\n1. 牛肉切薄片，加入盐、生抽、淀粉腌制20分钟；\n2. 青红椒切丝，姜蒜切末备用；\n3. 热锅冷油，下姜蒜末煸炒出香味；\n4. 加入牛肉片快速翻炒至变色；\n5. 加入青红椒丝翻炒均匀；\n6. 倒入蚝油、生抽、糖、水淀粉调味；\n7. 翻炒均匀，收汁后淋上香油即可。\n</code></pre><p>在问完了3个问题之后，我们又问了它第四个问题，也就是我们问它的第一个问题是什么。这个时候，它因为记录了过去第1-3轮的对话，所以还能正确地回答出来，我们问的是“你是谁”。</p><pre><code class=\"language-python\">question4 = \"我问你的第一个问题是什么？\"\nprint(\"User : %s\" % question4)\nprint(\"Assistant : %s\\n\" % conv1.ask(question4))\n</code></pre><p>输出结果：</p><pre><code class=\"language-python\">User : 我问你的第一个问题是什么？\nAssistant : 你问我：“你是谁？”\n</code></pre><p>而这个时候，如果我们重新再问一遍“我问你的第一个问题是什么”，你会发现回答变了。因为啊，上一轮已经是第四轮了，而我们设置记住的num_of_round是3。在上一轮的问题回答完了之后，第一轮的关于“你是谁”的问答，被我们从ChatGPT的对话历史里去掉了。所以这个时候，它会告诉我们，第一个问题是“鱼香肉丝怎么做”。</p><pre><code class=\"language-python\">question5 = \"我问你的第一个问题是什么？\"\nprint(\"User : %s\" % question5)\nprint(\"Assistant : %s\\n\" % conv1.ask(question5))\n</code></pre><p>输出结果：</p><pre><code class=\"language-python\">User : 我问你的第一个问题是什么？\nAssistant : 你问我：“请问鱼香肉丝怎么做？”\n</code></pre><h2>计算聊天机器人的成本</h2><p>无论是在<a href=\"https://time.geekbang.org/column/article/642197\">第03讲</a>里，还是这一讲里，我们每次都要发送一大段之前的聊天记录给到OpenAI。这是由OpenAI的GPT-3系列的大语言模型的原理所决定的。GPT-3系列的模型能够实现的功能非常简单，它就是根据你给他的一大段文字去续写后面的内容。而为了能够方便地为所有人提供服务，OpenAI也没有在服务器端维护整个对话过程自己去拼接，所以就不得不由你来拼接了。</p><p>即使ChatGPT的接口是把对话分成了一个数组，但是实际上，<strong>最终发送给模型的还是拼接到一起的字符串</strong>。OpenAI在它的Python库里面提供了一个叫做 <a href=\"https://github.com/openai/openai-python/blob/main/chatml.md\">ChatML</a> 的格式，其实就是ChatGPT的API的底层实现。OpenAI实际做的，就是根据一个定义好特定分隔符的格式，将你提供的多轮对话的内容拼接在一起，提交给 gpt-3.5-turbo 这个模型。</p><pre><code class=\"language-python\">&lt;|im_start|&gt;system\nYou are ChatGPT, a large language model trained by OpenAI. Answer as concisely as possible.\nKnowledge cutoff: 2021-09-01\nCurrent date: 2023-03-01&lt;|im_end|&gt;\n&lt;|im_start|&gt;user\nHow are you&lt;|im_end|&gt;\n&lt;|im_start|&gt;assistant\nI am doing well!&lt;|im_end|&gt;\n&lt;|im_start|&gt;user\nHow are you now?&lt;|im_end|&gt;\n</code></pre><p><span class=\"reference\">注：chatml的文档里，你可以看到你的对话，就是通过 &lt;|im_start|&gt;system|user|assistant、&lt;|im_end|&gt; 这些分隔符分割拼装的字符串。底层仍然是一个内容续写的大语言模型。</span></p><p>ChatGPT的对话模型用起来很方便，但是也有一点需要注意。就是在这个需要传送大量上下文的情况下，这个费用会比你想象的高。OpenAI是通过模型处理的Token数量来收费的，但是要注意，这个收费是“双向收费”。它是按照你发送给它的上下文，加上它返回给你的内容的总Token数来计算花费的Token数量的。</p><p>这个从模型的原理上是合理的，因为每一个Token，无论是你发给它的，还是它返回给你的，都需要通过GPU或者CPU运算。所以你发的上下文越长，它消耗的资源也越多。但是在使用中，你可能觉得我来了10轮对话，一共1000个Token，就只会收1000个Token的费用。而实际上，第一轮对话是只消耗了100个Token，但是第二轮因为要把前面的上下文都发送出去，所以需要200个，这样10轮下来，是需要花费5500个Token，比前面说的1000个可多了不少。</p><p>所以，如果做了应用要计算花费的成本，你就需要学会计算Token数。下面，我给了你一段示例代码，看看在ChatGPT的对话模型下，怎么计算Token数量。</p><h3>通过API计算Token数量</h3><p>第一种计算Token数量的方式，是从API返回的结果里面获取。我们修改一下刚才的Conversation类，重新创建一个Conversation2类。和之前只有一个不同，ask函数除了返回回复的消息之外，还会返回这次请求消耗的Token数。</p><pre><code class=\"language-python\">class Conversation2:\n    def __init__(self, prompt, num_of_round):\n        self.prompt = prompt\n        self.num_of_round = num_of_round\n        self.messages = []\n        self.messages.append({\"role\": \"system\", \"content\": self.prompt})\n\n    def ask(self, question):\n        try:\n            self.messages.append( {\"role\": \"user\", \"content\": question})\n            response = openai.ChatCompletion.create(\n                model=\"gpt-3.5-turbo\",\n                messages=self.messages,\n                temperature=0.5,\n                max_tokens=2048,\n                top_p=1,\n            )\n        except Exception as e:\n            print(e)\n            return e\n\n        message = response[\"choices\"][0][\"message\"][\"content\"]\n        num_of_tokens = response['usage']['total_tokens']\n        self.messages.append({\"role\": \"assistant\", \"content\": message})\n        \n        if len(self.messages) &gt; self.num_of_round*2 + 1:\n            del self.messages[1:3]\n        return message, num_of_tokens\n</code></pre><p>然后我们还是问一遍之前的问题，看看每一轮问答消耗的Token数量。</p><pre><code class=\"language-python\">conv2 = Conversation2(prompt, 3)\nquestions = [question1, question2, question3, question4, question5]\nfor question in questions:\n    answer, num_of_tokens = conv2.ask(question)\n    print(\"询问 {%s} 消耗的token数量是 : %d\" % (question, num_of_tokens))输出结果：\n</code></pre><p>输出结果：</p><pre><code class=\"language-python\">询问 {你是谁？} 消耗的token数量是 : 108\n询问 {请问鱼香肉丝怎么做？} 消耗的token数量是 : 410\n询问 {那蚝油牛肉呢？} 消耗的token数量是 : 733\n询问 {我问你的第一个问题是什么？} 消耗的token数量是 : 767\n询问 {我问你的第一个问题是什么？} 消耗的token数量是 : 774\n</code></pre><p>可以看到，前几轮的Token消耗数量在逐渐增多，但是最后3轮是一样的。这是因为我们代码里只使用过去3轮的对话内容向ChatGPT发起请求。</p><h3>通过Tiktoken库计算Token数量</h3><p>第二种方式，我们在上一讲用过，就是使用Tiktoken这个Python库，将文本分词，然后数一数Token的数量。</p><p>需要注意，使用不同的GPT模型，对应着不同的Tiktoken的编码器模型。对应的文档，可以查询这个链接：<a href=\"https://github.com/openai/openai-cookbook/blob/main/examples/How_to_count_tokens_with_tiktoken.ipynb\">https://github.com/openai/openai-cookbook/blob/main/examples/How_to_count_tokens_with_tiktoken.ipynb</a></p><p>我们使用的ChatGPT，采用的是cl100k_base的编码，我们也可以试着用它计算一下第一轮对话使用的Token数量。</p><pre><code class=\"language-python\">import tiktoken\nencoding = tiktoken.get_encoding(\"cl100k_base\")\n\nconv2 = Conversation2(prompt, 3)\nquestion1 = \"你是谁？\"\nanswer1, num_of_tokens = conv2.ask(question1)\nprint(\"总共消耗的token数量是 : %d\" % (num_of_tokens))\n\nprompt_count = len(encoding.encode(prompt))\nquestion1_count = len(encoding.encode(question1))\nanswer1_count = len(encoding.encode(answer1))\ntotal_count = prompt_count + question1_count + answer1_count\nprint(\"Prompt消耗 %d Token, 问题消耗 %d Token，回答消耗 %d Token，总共消耗 %d Token\" % (prompt_count, question1_count, answer1_count, total_count))\n</code></pre><p>输出结果：</p><pre><code class=\"language-python\">总共消耗的token数量是 : 104\nPrompt消耗 65 Token, 问题消耗 5 Token，回答消耗 20 Token，总共消耗 90 Token\n</code></pre><p>我们通过API获得了消耗的Token数，然后又通过Tiktoken分别计算了System的指示内容、用户的问题和AI生成的回答，发现了两者还有小小的差异。这个是因为，我们没有计算OpenAI去拼接它们内部需要的格式的Token数量。很多时候，我们都需要通过Tiktoken预先计算一下Token数量，避免提交的内容太多，导致API返回报错。</p><h2>Gradio帮你快速搭建一个聊天界面</h2><p>我们已经有了一个封装好的聊天机器人了。但是，现在这个机器人，我们只能自己在Python Notebook里面玩，每次问点问题还要调用代码。那么，接下来我们就给我们封装好的Convesation接口开发一个界面。</p><p>我们直接选用Gradio这个Python库来开发这个聊天机器人的界面，因为它有这样几个好处。</p><ol>\n<li>我们现有的代码都是用Python实现的，你不需要再去学习JavaScript、TypeScript以及相关的前端框架了。</li>\n<li>Gradio渲染出来的界面可以直接在Jupyter Notebook里面显示出来，对于不了解技术的同学，也不再需要解决其他环境搭建的问题。</li>\n<li>Gradio这个公司，已经被目前最大的开源机器学习模型社区HuggingFace收购了。你可以免费把Gradio的应用部署到HuggingFace上。我等一下就教你怎么部署，你可以把你自己做出来的聊天机器人部署上去给你的朋友们用。</li>\n<li>在后面的课程里，有些时候我们也会使用一些开源的模型，这些模型往往也托管在HuggingFace上。所以使用HuggingFace+Gradio的部署方式，特别方便我们演示给其他人看。</li>\n</ol><p><span class=\"reference\">注：Gradio官方也有用其他开源预训练模型创建Chatbot的教程<a href=\"https://gradio.app/creating-a-chatbot/\">https://gradio.app/creating-a-chatbot/</a></span></p><p>在实际开发之前，还是按照惯例我们先安装一下Python的Gradio的包。</p><pre><code class=\"language-python\">conda install -c conda-forge gradio\n</code></pre><p>Gradio应用的代码我也列在了下面，对应的逻辑也非常简单。</p><ol>\n<li>首先，我们定义好了system这个系统角色的提示语，创建了一个Conversation对象。</li>\n<li>然后，我们定义了一个answer方法，简单封装了一下Conversation的ask方法。主要是通过history维护了整个会话的历史记录。并且通过responses，将用户和AI的对话分组。然后将它们两个作为函数的返回值。这个函数的签名是为了符合Gradio里Chatbot组件的函数签名的需求。</li>\n<li>最后，我们通过一段with代码，创建了对应的聊天界面。Gradio提供了一个现成的Chatbot组件，我们只需要调用它，然后提供一个文本输入框就好了。</li>\n</ol><pre><code class=\"language-python\">import gradio as gr\nprompt = \"\"\"你是一个中国厨师，用中文回答做菜的问题。你的回答需要满足以下要求:\n1. 你的回答必须是中文\n2. 回答限制在100个字以内\"\"\"\n\nconv = Conversation(prompt, 10)\n\ndef answer(question, history=[]):\n    history.append(question)\n    response = conv.ask(question)\n    history.append(response)\n    responses = [(u,b) for u,b in zip(history[::2], history[1::2])]\n    return responses, history\n\nwith gr.Blocks(css=\"#chatbot{height:300px} .overflow-y-auto{height:500px}\") as demo:\n    chatbot = gr.Chatbot(elem_id=\"chatbot\")\n    state = gr.State([])\n\n    with gr.Row():\n        txt = gr.Textbox(show_label=False, placeholder=\"Enter text and press enter\").style(container=False)\n\n    txt.submit(answer, [txt, state], [chatbot, state])\n\ndemo.launch()\n</code></pre><p>你直接在Colab或者你本地的Jupyter Notebook里面，执行一下这一讲到目前的所有代码，就得到了一个可以和ChatGPT聊天的机器人了。</p><p><img src=\"https://static001.geekbang.org/resource/image/a5/02/a57a0f1197de3b8b8e625d9cfe506502.png?wh=754x485\" alt=\"图片\"></p><h2>把机器人部署到HuggingFace上去</h2><p>有了一个可以聊天的机器人，相信你已经迫不及待地想让你的朋友也能用上它了。那么我们就把它部署到 <a href=\"https://huggingface.co/\">HuggingFace</a> 上去。</p><ol>\n<li>首先你需要注册一个HuggingFace的账号，点击左上角的头像，然后点击 “+New Space” 创建一个新的项目空间。</li>\n</ol><p><img src=\"https://static001.geekbang.org/resource/image/50/b1/5073d7572f5d62ab8cd3bd708bba33b1.png?wh=1268x426\" alt=\"\"></p><ol start=\"2\">\n<li>在接下来的界面里，给你的Space取一个名字，然后在Select the Space SDK里面，选择第二个Gradio。硬件我们在这里就选择免费的，项目我们在这里选择public，让其他人也能够看到。不过要注意，public的space，是连你后面上传的代码也能够看到的。</li>\n</ol><p><img src=\"https://static001.geekbang.org/resource/image/a8/c5/a8a502a4a6b6d6a6fc4aebbee7ayy7c5.png?wh=692x1172\" alt=\"\"></p><ol start=\"3\">\n<li>创建成功后，会跳转到HuggingFace的App界面。里面给了你如何Clone当前的space，然后提交代码部署App的方式。我们只需要通过Git把当前space下载下来，然后提交两个文件就可以了，分别是：</li>\n</ol><ul>\n<li>app.py 包含了我们的Gradio应用；</li>\n<li>requirements.txt 包含了这个应用依赖的Python包，这里我们只依赖OpenAI这一个包。</li>\n</ul><p><img src=\"https://static001.geekbang.org/resource/image/e2/52/e24d1f90f9a67a61182dbb4e20899852.png?wh=1014x358\" alt=\"\" title=\"你可以得到这个HuggingFace space的Git地址\"><br>\n<img src=\"https://static001.geekbang.org/resource/image/30/c6/30c7739844201fee8da9e86752ea4ec6.png?wh=1013x165\" alt=\"\"></p><p>代码提交之后，HuggingFace的页面会自动刷新，你可以直接看到对应的日志和Chatbot的应用。不过这个时候，我们还差一步工作。</p><ol start=\"4\">\n<li>因为我们的代码里是通过环境变量获取OpenAI的API Key的，所以我们还要在这个HuggingFace的Space里设置一下这个环境变量。</li>\n</ol><ul>\n<li>你可以点击界面里面的Settings，然后往下找到Repository secret。<br>\n<img src=\"https://static001.geekbang.org/resource/image/75/d9/7576e32270d02302c4397254d9deb5d9.png?wh=1014x177\" alt=\"\"><br>\n<img src=\"https://static001.geekbang.org/resource/image/41/75/4165279b0c1580da31e5fd152f23d875.png?wh=1009x414\" alt=\"图片\"></li>\n</ul><p>在Name这里输入 <span class=\"orange\">OPENAI_API_KEY</span>，然后在Secret value里面填入你的OpenAI的密钥。</p><ul>\n<li>设置完成之后，你还需要点击一下Restart this space确保这个应用重新加载一遍，以获取到新设置的环境变量。</li>\n</ul><p><img src=\"https://static001.geekbang.org/resource/image/c2/fc/c29226b9bf2490a7cb7dc0b84eccdbfc.png?wh=999x997\" alt=\"图片\"></p><p>好啦，这个时候，你可以重新点击App这个Tab页面，试试你的聊天机器人是否可以正常工作了。</p><p><img src=\"https://static001.geekbang.org/resource/image/46/0a/46d4b47402e78d54718a5738f005700a.png?wh=1015x489\" alt=\"\"></p><p>我把今天给你看到的Chatbot应用放到了HuggingFace上，你可以直接复制下来试一试。</p><p>地址：<a href=\"https://huggingface.co/spaces/xuwenhao83/simple_chatbot\">https://huggingface.co/spaces/xuwenhao83/simple_chatbot</a></p><h2>小结</h2><p>希望通过这一讲，你已经学会了怎么使用ChatGPT的接口来实现一个聊天机器人了。我们分别实现了只保留固定轮数的对话，并且体验了它的效果。我们也明白了为什么我们总是需要把所有的上下文都发送给OpenAI的接口。然后我们通过Gradio这个库开发了一个聊天机器人界面。最后，我们将这个简单的聊天机器人部署到了HuggingFace上，让你可以分享给自己的朋友使用。希望你玩得高兴！</p><h2>课后练习</h2><p>在这一讲里，我们的Chatbot只能维护过去N轮的对话。这意味着如果对话很长的话，我们一开始对话的信息就被丢掉了。有一种方式是我们不设定轮数，只限制传入的上下文的Token数量。</p><ol>\n<li>你能根据这一讲学到的内容，修改一下代码，让这个聊天机器人不限制轮数，只在Token数量要超标的时候再删减最开始的对话么？</li>\n<li>除了“忘记”开始的几轮，你还能想到什么办法让AI尽可能多地记住上下文吗？</li>\n</ol><p>期待能在评论区看到你的思考，也欢迎你把这节课分享给感兴趣的朋友，我们下一讲再见。</p>","comments":[{"had_liked":false,"id":386962,"user_name":"Geek_19eca2","can_delete":false,"product_type":"c1","uid":1655161,"ip_address":"浙江","ucode":"7A910AB1386532","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/ajNVdqHZLLAD2YLZnuaicxibvPo6SEC3VoZ9Yra2g7HXDeqkWodb4nUvfRkhaOJxechJjUHBib4Ih1ryymCOW7AkQ/132","comment_is_top":true,"comment_ctime":1706002614,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100541001,"comment_content":"最新代码： \nimport os\n\nfrom openai import OpenAI\nclient = OpenAI()\n\nclass Conversation:\n    def __init__(self, prompt, num_of_round):\n        self.prompt = prompt\n        self.num_of_round = num_of_round\n        self.messages = []\n        self.messages.append({&quot;role&quot;: &quot;system&quot;, &quot;content&quot;: self.prompt})\n\n    def ask(self, question):\n        try:\n            self.messages.append({&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: question})\n            response = client.chat.completions.create(\n                model=&quot;gpt-3.5-turbo&quot;,\n                messages=self.messages,\n                temperature=0.5,\n                max_tokens=2048,\n                top_p=1,\n            )\n        except Exception as e:\n            print(e)\n            return e\n\n        message = response.choices[0].message.content\n        self.messages.append({&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: message})\n\n        if len(self.messages) &gt; self.num_of_round*2 + 1:\n            del self.messages[1:3] # Remove the first round conversation left.\n        return message\n\n\n不然跑不过去。。openai改了。。。\n","like_count":6},{"had_liked":false,"id":371563,"user_name":"我自己带盐","can_delete":false,"product_type":"c1","uid":1933777,"ip_address":"广东","ucode":"40ACC81C8131BA","user_header":"https://static001.geekbang.org/account/avatar/00/1d/81/d1/c06ba7a2.jpg","comment_is_top":false,"comment_ctime":1680068681,"is_pvip":false,"replies":[{"id":135723,"content":"👍","user_name":"作者回复","user_name_real":"编辑","uid":1053568,"ctime":1680582060,"ip_address":"上海","comment_id":371563,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100541001,"comment_content":"可以认模型总结一下，全部的对话，再发过去","like_count":29,"discussions":[{"author":{"id":1053568,"avatar":"https://static001.geekbang.org/account/avatar/00/10/13/80/8de66543.jpg","nickname":"徐文浩","note":"","ucode":"1D39AC564172E9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":612222,"discussion_content":"👍","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1680582060,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1121758,"avatar":"https://static001.geekbang.org/account/avatar/00/11/1d/de/62bfa83f.jpg","nickname":"aoe","note":"","ucode":"1C6201EDB4E954","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":612982,"discussion_content":"不愧是自己带盐的","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1681050689,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"浙江","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":371546,"user_name":"黄琨","can_delete":false,"product_type":"c1","uid":1089706,"ip_address":"北京","ucode":"786BF74290B25A","user_header":"https://static001.geekbang.org/account/avatar/00/10/a0/aa/a4c1fa31.jpg","comment_is_top":false,"comment_ctime":1680055728,"is_pvip":false,"replies":[{"id":135780,"content":"👍","user_name":"作者回复","user_name_real":"编辑","uid":1053568,"ctime":1680589083,"ip_address":"上海","comment_id":371546,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100541001,"comment_content":"问题1: 为了防止超标，可能需要在对话开始前设置一个允许最大的token阈值，比如 MAX_TOKEN_LIMIT = 2000，再设置一个小于某个数量就需要提醒的警告值，比如 MIN_TOKEN_LIMIT = 200，对话前初始化一个最大值，对话过程中减去每轮所消耗的token数量，当结果少于最小值的时候，再调用删减对话数组的代码。\n\n问题2: 限制文本长度。或许可以把对话中的大段文本缩减为精简摘要，以减少token数量，比如把“鱼香肉丝的做法是......”这种精简后的文本带入到上下文中去。别的暂时想不到 =_=!","like_count":16,"discussions":[{"author":{"id":1053568,"avatar":"https://static001.geekbang.org/account/avatar/00/10/13/80/8de66543.jpg","nickname":"徐文浩","note":"","ucode":"1D39AC564172E9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":612291,"discussion_content":"👍","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1680589084,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":371627,"user_name":"LiuHu","can_delete":false,"product_type":"c1","uid":1039768,"ip_address":"江苏","ucode":"284E2025C554BB","user_header":"https://static001.geekbang.org/account/avatar/00/0f/dd/98/883c42b4.jpg","comment_is_top":false,"comment_ctime":1680132828,"is_pvip":false,"replies":[{"id":135760,"content":"对话场景用这个方式其实不太合适。专门的确定的资料库这样做可以。","user_name":"作者回复","user_name_real":"编辑","uid":1053568,"ctime":1680587040,"ip_address":"上海","comment_id":371627,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100541001,"comment_content":"用向量数据库把历史回话保存到本地，新的问题先转向量，从向量库中搜出相关内容，再把搜出的内容作为上下文+新问题一起带过去","like_count":9,"discussions":[{"author":{"id":1053568,"avatar":"https://static001.geekbang.org/account/avatar/00/10/13/80/8de66543.jpg","nickname":"徐文浩","note":"","ucode":"1D39AC564172E9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":612266,"discussion_content":"对话场景用这个方式其实不太合适。专门的确定的资料库这样做可以。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1680587041,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":2028238,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/f2/ce/791d0f5e.jpg","nickname":"张开元","note":"","ucode":"455838B89BF154","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1053568,"avatar":"https://static001.geekbang.org/account/avatar/00/10/13/80/8de66543.jpg","nickname":"徐文浩","note":"","ucode":"1D39AC564172E9","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":626817,"discussion_content":"为什么呀？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1693399817,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":612266,"ip_address":"北京","group_id":0},"score":626817,"extra":""}]}]},{"had_liked":false,"id":371762,"user_name":"浩仔是程序员","can_delete":false,"product_type":"c1","uid":1104601,"ip_address":"广东","ucode":"A7E5CF9E1571A2","user_header":"https://static001.geekbang.org/account/avatar/00/10/da/d9/f051962f.jpg","comment_is_top":false,"comment_ctime":1680280113,"is_pvip":false,"replies":[{"id":135716,"content":"是的，这是由现在的GPT类型模型的原理决定的。","user_name":"作者回复","user_name_real":"编辑","uid":1053568,"ctime":1680581533,"ip_address":"上海","comment_id":371762,"utype":1}],"discussion_count":4,"race_medal":0,"score":2,"product_id":100541001,"comment_content":"目前chatGPT的上下文功能也是这么实现的吗？每次都要发之前的问题和答案，感觉很蠢","like_count":6,"discussions":[{"author":{"id":1053568,"avatar":"https://static001.geekbang.org/account/avatar/00/10/13/80/8de66543.jpg","nickname":"徐文浩","note":"","ucode":"1D39AC564172E9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":612215,"discussion_content":"是的，这是由现在的GPT类型模型的原理决定的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1680581533,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1811277,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/a3/4d/59390ba9.jpg","nickname":"排骨","note":"","ucode":"A413CF46211E1F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":645758,"discussion_content":"我觉得这样更好，直接无状态化了，简单方便","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1716692433,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1358045,"avatar":"https://static001.geekbang.org/account/avatar/00/14/b8/dd/37726c34.jpg","nickname":"小马哥","note":"","ucode":"B2C0FF38F8C9BC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":640621,"discussion_content":"你觉得, 如果让OpenAI在服务器记录所有在线用户的上下文, 这件事情相比客户端传递上下文, 实现起来容易吗? ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1711670314,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2409553,"avatar":"https://static001.geekbang.org/account/avatar/00/24/c4/51/5bca1604.jpg","nickname":"aLong","note":"","ucode":"11DB1B9C579811","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":638501,"discussion_content":"我觉得可以这么理解，他专职做的事情是生成内容的服务。你提到的记录是需要另外服务去做的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1709636543,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":371554,"user_name":"胡萝卜","can_delete":false,"product_type":"c1","uid":2456594,"ip_address":"上海","ucode":"54DF5159C1704C","user_header":"https://static001.geekbang.org/account/avatar/00/25/7c/12/7b9a2efb.jpg","comment_is_top":false,"comment_ctime":1680059669,"is_pvip":false,"replies":[{"id":135775,"content":"👍 这个技巧也是很有用的。","user_name":"作者回复","user_name_real":"编辑","uid":1053568,"ctime":1680588005,"ip_address":"上海","comment_id":371554,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100541001,"comment_content":"输入文本超长时需要不能直接截断，不然可能不听指令直接续写。截断后把最后一个句子去掉，并以句号结尾防止出现奇怪的回复。","like_count":6,"discussions":[{"author":{"id":1053568,"avatar":"https://static001.geekbang.org/account/avatar/00/10/13/80/8de66543.jpg","nickname":"徐文浩","note":"","ucode":"1D39AC564172E9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":612286,"discussion_content":"👍 这个技巧也是很有用的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1680588005,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":372223,"user_name":"Allan","can_delete":false,"product_type":"c1","uid":1310388,"ip_address":"北京","ucode":"8DA4DBECC2C45C","user_header":"https://static001.geekbang.org/account/avatar/00/13/fe/b4/295338e7.jpg","comment_is_top":false,"comment_ctime":1680856497,"is_pvip":false,"replies":[{"id":135875,"content":"所有代码都以Jupyter Notebook的文件格式放在 https:&#47;&#47;github.com&#47;xuwenhao&#47;geektime-ai-course 里\n\n导读那一讲里放了对应的链接。","user_name":"作者回复","user_name_real":"编辑","uid":1053568,"ctime":1680973610,"ip_address":"日本","comment_id":372223,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100541001,"comment_content":"老师可以把每节课的项目都放到一个工程里面吗？然后我们可以下载这样是不是方便一些。","like_count":3,"discussions":[{"author":{"id":1053568,"avatar":"https://static001.geekbang.org/account/avatar/00/10/13/80/8de66543.jpg","nickname":"徐文浩","note":"","ucode":"1D39AC564172E9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":612870,"discussion_content":"所有代码都以Jupyter Notebook的文件格式放在 https://github.com/xuwenhao/geektime-ai-course 里\n\n导读那一讲里放了对应的链接。","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1680973610,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"日本","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":371933,"user_name":"new one","can_delete":false,"product_type":"c1","uid":3582142,"ip_address":"江苏","ucode":"870D6195E1815E","user_header":"https://static001.geekbang.org/account/avatar/00/36/a8/be/e98383cc.jpg","comment_is_top":false,"comment_ctime":1680529356,"is_pvip":false,"replies":[{"id":135778,"content":"感觉还是SSL握手失败，先在Colab上看看能不能跑通？再看看简单HTTPS请求别的网站是否正常来定位问题？","user_name":"作者回复","user_name_real":"编辑","uid":1053568,"ctime":1680588897,"ip_address":"上海","comment_id":371933,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100541001,"comment_content":" 出现SSL握手失败的问题，请教一下应该怎么解决，问了chatgpt，使用了：\nimport ssl\ncontext = ssl.create_default_context()\ncontext.load_verify_locations(&quot;D:\\Anaconda\\Library\\ssl\\cert.pem&quot;)\n并没有得到解决\n\n具体报错如下：\nError communicating with OpenAI: HTTPSConnectionPool(host=&#39;api.openai.com&#39;, port=443): Max retries exceeded with url: &#47;v1&#47;chat&#47;completions (Caused by SSLError(SSLError(1, &#39;[SSL: SSLV3_ALERT_HANDSHAKE_FAILURE] sslv3 alert handshake failure (_ssl.c:1129)&#39;)))\nAssistant : Error communicating with OpenAI: HTTPSConnectionPool(host=&#39;api.openai.com&#39;, port=443): Max retries exceeded with url: &#47;v1&#47;chat&#47;completions (Caused by SSLError(SSLError(1, &#39;[SSL: SSLV3_ALERT_HANDSHAKE_FAILURE] sslv3 alert handshake failure (_ssl.c:1129)&#39;)))","like_count":1,"discussions":[{"author":{"id":1053568,"avatar":"https://static001.geekbang.org/account/avatar/00/10/13/80/8de66543.jpg","nickname":"徐文浩","note":"","ucode":"1D39AC564172E9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":612289,"discussion_content":"感觉还是SSL握手失败，先在Colab上看看能不能跑通？再看看简单HTTPS请求别的网站是否正常来定位问题？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1680588898,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":371724,"user_name":"川月","can_delete":false,"product_type":"c1","uid":3579438,"ip_address":"四川","ucode":"CAB1218259CFC5","user_header":"https://static001.geekbang.org/account/avatar/00/36/9e/2e/e46ab171.jpg","comment_is_top":false,"comment_ctime":1680234246,"is_pvip":false,"replies":[{"id":135736,"content":"正好你可以试着把问题扔给ChatGPT看看它会怎么解答？","user_name":"作者回复","user_name_real":"编辑","uid":1053568,"ctime":1680583323,"ip_address":"上海","comment_id":371724,"utype":1}],"discussion_count":6,"race_medal":0,"score":2,"product_id":100541001,"comment_content":"    del self.messages[1:3] &#47;&#47;Remove the first round conversation left.\n        ^\nSyntaxError: cannot delete operator 为什么这个报错啊","like_count":1,"discussions":[{"author":{"id":1053568,"avatar":"https://static001.geekbang.org/account/avatar/00/10/13/80/8de66543.jpg","nickname":"徐文浩","note":"","ucode":"1D39AC564172E9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":612236,"discussion_content":"正好你可以试着把问题扔给ChatGPT看看它会怎么解答？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1680583323,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1899757,"avatar":"","nickname":"yanyu-xin","note":"","ucode":"3AA389F9E4C236","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":611827,"discussion_content":"将&#34;//&#34; 改为 ”#“","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1680345920,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1698770,"avatar":"https://static001.geekbang.org/account/avatar/00/19/eb/d2/3d51e170.jpg","nickname":"枫","note":"","ucode":"759FC1885B07A5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":627836,"discussion_content":"copy在colab我也遇到这个问题，习惯性从评论区找结论，chatgpt的回答看不懂，结果一看我要消息，注释的符号不一样，真的要笑死！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1694593738,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1452167,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJcwXucibksEYRSYg6icjibzGa7efcMrCsGec2UwibjTd57icqDz0zzkEEOM2pXVju60dibzcnQKPfRkN9g/132","nickname":"Geek_93970d","note":"","ucode":"52AC308BEC7737","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":619320,"discussion_content":"chatgtp 建议这样改:\nself.messages = self.messages[:1] + self.messages[3:]. \n，但是为啥要留着 index=0 的元素呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1684982006,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1559128,"avatar":"https://static001.geekbang.org/account/avatar/00/17/ca/58/6fe1854c.jpg","nickname":"金","note":"","ucode":"48D0B5CB8E5F9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":613912,"discussion_content":"我拷贝这个代码到pycharm, 发现两个问题\n1. //不是python的注释方法\n2. 这个注释变成了多行","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1681599828,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"湖南","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1911235,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/29/c3/791d0f5e.jpg","nickname":"渣渣辉","note":"","ucode":"730838D9161579","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":612441,"discussion_content":"这个报错我看了半天才弄明白笑死","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1680691187,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"日本","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":371663,"user_name":"Bonnenult丶凉煜","can_delete":false,"product_type":"c1","uid":1448629,"ip_address":"中国台湾","ucode":"9CF78FCAE98AC3","user_header":"https://static001.geekbang.org/account/avatar/00/16/1a/b5/9635696d.jpg","comment_is_top":false,"comment_ctime":1680161626,"is_pvip":false,"replies":[{"id":135746,"content":"👍","user_name":"作者回复","user_name_real":"编辑","uid":1053568,"ctime":1680586077,"ip_address":"上海","comment_id":371663,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100541001,"comment_content":"安装gradio需要使用这个命令conda install -c conda-forge gradio","like_count":1,"discussions":[{"author":{"id":1053568,"avatar":"https://static001.geekbang.org/account/avatar/00/10/13/80/8de66543.jpg","nickname":"徐文浩","note":"","ucode":"1D39AC564172E9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":612252,"discussion_content":"👍","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1680586077,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":374535,"user_name":"陈鹏","can_delete":false,"product_type":"c1","uid":1574748,"ip_address":"立陶宛","ucode":"777F23D9178A6A","user_header":"https://static001.geekbang.org/account/avatar/00/18/07/5c/2b75c836.jpg","comment_is_top":false,"comment_ctime":1684160550,"is_pvip":false,"replies":[{"id":136807,"content":"有的，可以设置对应的参数，看一下后面介绍Visual ChatGPT的部分有一个设置可以设置没有人用多长时间会自动停止。","user_name":"作者回复","user_name_real":"编辑","uid":1053568,"ctime":1684725428,"ip_address":"新加坡","comment_id":374535,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100541001,"comment_content":"成功运行，开心。\n请教老师一个问题：用hugging face 自己搭建的app，会一直运行吗？平台是否有策略到一定时间后停止我的app？","like_count":0,"discussions":[{"author":{"id":1053568,"avatar":"https://static001.geekbang.org/account/avatar/00/10/13/80/8de66543.jpg","nickname":"徐文浩","note":"","ucode":"1D39AC564172E9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":618952,"discussion_content":"有的，可以设置对应的参数，看一下后面介绍Visual ChatGPT的部分有一个设置可以设置没有人用多长时间会自动停止。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1684725428,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"新加坡","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":374366,"user_name":"王石磊","can_delete":false,"product_type":"c1","uid":1905809,"ip_address":"土耳其","ucode":"CD8E0C5CF120E1","user_header":"https://static001.geekbang.org/account/avatar/00/1d/14/91/794687ef.jpg","comment_is_top":false,"comment_ctime":1684033611,"is_pvip":false,"replies":[{"id":136842,"content":"看起来还像是代理的问题？在Colab上能运行成功么？","user_name":"作者回复","user_name_real":"编辑","uid":1053568,"ctime":1684748613,"ip_address":"上海","comment_id":374366,"utype":1}],"discussion_count":3,"race_medal":0,"score":3,"product_id":100541001,"comment_content":"我的示例报错现象是这样的，程序代码中设置了 API_KEY 和 网路代理，运行其他前面的代码正常，本节课的代码出现了。下面的问题。不存在API_KEY 费用不足或谷歌不能访问的情况。\nopenai.api_key = os.environ[&quot;OPENAI_API_KEY&quot;]\nos.environ[&quot;http_proxy&quot;] = &quot;socks5:&#47;&#47;127.0.0.1:xxx&quot;\nos.environ[&quot;https_proxy&quot;] = &quot;socks5:&#47;&#47;127.0.0.1:xxx&quot;\nTraceback (most recent call last):\n  File &quot;D:\\Python3810\\lib\\site-packages\\urllib3\\connectionpool.py&quot;, line 703, in urlopen\n    httplib_response = self._make_request(\n  File &quot;D:\\Python3810\\lib\\site-packages\\urllib3\\connectionpool.py&quot;, line 449, in _make_request\n    six.raise_from(e, None)\n  File &quot;&lt;string&gt;&quot;, line 3, in raise_from\n  File &quot;D:\\Python3810\\lib\\site-packages\\urllib3\\connectionpool.py&quot;, line 444, in _make_request\n    httplib_response = conn.getresponse()\n  File &quot;D:\\Python3810\\lib\\http\\client.py&quot;, line 1344, in getresponse\n    response.begin()\n  File &quot;D:\\Python3810\\lib\\http\\client.py&quot;, line 307, in begin\n    version, status, reason = self._read_status()\n  File &quot;D:\\Python3810\\lib\\http\\client.py&quot;, line 276, in _read_status\n    raise RemoteDisconnected(&quot;Remote end closed connection without&quot;\nhttp.client.RemoteDisconnected: Remote end closed connection without response\n\nDuring handling of the above exception, another exception occurred:","like_count":0,"discussions":[{"author":{"id":1053568,"avatar":"https://static001.geekbang.org/account/avatar/00/10/13/80/8de66543.jpg","nickname":"徐文浩","note":"","ucode":"1D39AC564172E9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":619020,"discussion_content":"看起来还像是代理的问题？在Colab上能运行成功么？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1684748613,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1905809,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/14/91/794687ef.jpg","nickname":"王石磊","note":"","ucode":"CD8E0C5CF120E1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":618328,"discussion_content":"通过其他代理工具，可以完成，目前已确定时v2ray的Bug","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1684195858,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1905809,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/14/91/794687ef.jpg","nickname":"王石磊","note":"","ucode":"CD8E0C5CF120E1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":618147,"discussion_content":"基本确定了是个人代理工具(V2ray)的问题，下面需要解决代理工具的问题了\n2023/05/15 13:09:27 [Warning] [2069902137] app/proxyman/inbound: connection ends &gt; proxy/http: failed to read http request &gt; malformed HTTP request &#34;\\x05\\x01\\x00&#34;\n2023/05/15 13:09:32 [Warning] [3570874343] app/proxyman/inbound: connection ends &gt; proxy/http: failed to read http request &gt; malformed HTTP request &#34;\\x05\\x01\\x00&#34;","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1684127458,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":373974,"user_name":"陈鹏","can_delete":false,"product_type":"c1","uid":1574748,"ip_address":"中国台湾","ucode":"777F23D9178A6A","user_header":"https://static001.geekbang.org/account/avatar/00/18/07/5c/2b75c836.jpg","comment_is_top":false,"comment_ctime":1683429031,"is_pvip":false,"replies":[{"id":136865,"content":"我们是在每轮结束的时候通过 &gt; 判断，而且index从0起步，所以应该是 2 没问题啊","user_name":"作者回复","user_name_real":"编辑","uid":1053568,"ctime":1684752908,"ip_address":"上海","comment_id":373974,"utype":1}],"discussion_count":2,"race_medal":0,"score":3,"product_id":100541001,"comment_content":"老师，第一段代码示例中的num_of_round=2，是不是要改为3？  感觉 前后内容对应不上，前面num_of_round设为2，虽然第三轮对话能练习上下文，但是问了问题3后，第一个问题和回答已经删除了","like_count":0,"discussions":[{"author":{"id":1053568,"avatar":"https://static001.geekbang.org/account/avatar/00/10/13/80/8de66543.jpg","nickname":"徐文浩","note":"","ucode":"1D39AC564172E9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":619051,"discussion_content":"我们是在每轮结束的时候通过 &gt; 判断，而且index从0起步，所以应该是 2 没问题啊","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1684752908,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1138460,"avatar":"https://static001.geekbang.org/account/avatar/00/11/5f/1c/abb7bfe3.jpg","nickname":"西口径","note":"","ucode":"19B203A560BB6B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":617336,"discussion_content":"是的，可能笔误啦，没注意到。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1683513211,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":373171,"user_name":"勇.Max","can_delete":false,"product_type":"c1","uid":1248128,"ip_address":"澳大利亚","ucode":"AE5DBC10805A9B","user_header":"https://static001.geekbang.org/account/avatar/00/13/0b/80/a0533acb.jpg","comment_is_top":false,"comment_ctime":1682214349,"is_pvip":false,"replies":[{"id":136525,"content":"没有直接在jupyter内显示出来gradio的应用么？\n\n我没有m1所以不好说。","user_name":"作者回复","user_name_real":"编辑","uid":1053568,"ctime":1683094003,"ip_address":"上海","comment_id":373171,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100541001,"comment_content":"gradio应用代码，我在jupyter-lab上运行，左下角一直显示Busy，卡着不动。\n我电脑配置并不低（macbook pro m1），网络也没问题。请问老师这种问题如何解决呢？","like_count":0,"discussions":[{"author":{"id":1053568,"avatar":"https://static001.geekbang.org/account/avatar/00/10/13/80/8de66543.jpg","nickname":"徐文浩","note":"","ucode":"1D39AC564172E9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":616766,"discussion_content":"没有直接在jupyter内显示出来gradio的应用么？\n\n我没有m1所以不好说。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1683094003,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":373139,"user_name":"绘世浮夸 つ","can_delete":false,"product_type":"c1","uid":1763933,"ip_address":"江苏","ucode":"6A3960195753BA","user_header":"https://static001.geekbang.org/account/avatar/00/1a/ea/5d/ccb4c205.jpg","comment_is_top":false,"comment_ctime":1682087061,"is_pvip":false,"replies":[{"id":136489,"content":"花钱变成付费用户……","user_name":"作者回复","user_name_real":"编辑","uid":1053568,"ctime":1683086992,"ip_address":"上海","comment_id":373139,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100541001,"comment_content":"对于现在api做了限制每分钟只能提问三次怎么解决老师","like_count":0,"discussions":[{"author":{"id":1053568,"avatar":"https://static001.geekbang.org/account/avatar/00/10/13/80/8de66543.jpg","nickname":"徐文浩","note":"","ucode":"1D39AC564172E9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":616725,"discussion_content":"花钱变成付费用户……","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1683086993,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":373112,"user_name":"Geek_053159","can_delete":false,"product_type":"c1","uid":3603126,"ip_address":"四川","ucode":"6435D4A6D83FAE","user_header":"","comment_is_top":false,"comment_ctime":1682059080,"is_pvip":false,"replies":[{"id":136514,"content":"没有特殊指令，你可以自己判别一下用户意图来做这个，但是我觉得没有必要\n\n可以往后看看14-17讲，有更多使用memory的方式","user_name":"作者回复","user_name_real":"编辑","uid":1053568,"ctime":1683091764,"ip_address":"上海","comment_id":373112,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100541001,"comment_content":"老师 chatGPT 理解上下文都是需要把每次的会话全部传递给它 那如果是下面这种场景有没有处理办法呢 即我在和它的前面四次会话中我需要它记住上下文 在第五次会话中 为了节约token消耗和不影响回答的效果 我需要它忘记前面四次的会话 这种场景有没有特殊的指令可以实现 比如直接让告诉chatgpt ：忘记前面的对话","like_count":0,"discussions":[{"author":{"id":1053568,"avatar":"https://static001.geekbang.org/account/avatar/00/10/13/80/8de66543.jpg","nickname":"徐文浩","note":"","ucode":"1D39AC564172E9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":616755,"discussion_content":"没有特殊指令，你可以自己判别一下用户意图来做这个，但是我觉得没有必要\n\n可以往后看看14-17讲，有更多使用memory的方式","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1683091764,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":372483,"user_name":"独立思考","can_delete":false,"product_type":"c1","uid":2309581,"ip_address":"俄罗斯","ucode":"A49E977C4682F2","user_header":"https://static001.geekbang.org/account/avatar/00/23/3d/cd/65e6b3d3.jpg","comment_is_top":false,"comment_ctime":1681195629,"is_pvip":false,"replies":[{"id":135967,"content":"pip install -U openai\n\n升级一下openai的sdk版本，你应该是之前在ChatGPT API还没有出来的时候就安装过openai的sdk了","user_name":"作者回复","user_name_real":"编辑","uid":1053568,"ctime":1681262917,"ip_address":"上海","comment_id":372483,"utype":1}],"discussion_count":2,"race_medal":0,"score":3,"product_id":100541001,"comment_content":"报错：module &#39;openai&#39; has no attribute &#39;ChatCompletion&#39;，如何解决？","like_count":0,"discussions":[{"author":{"id":1053568,"avatar":"https://static001.geekbang.org/account/avatar/00/10/13/80/8de66543.jpg","nickname":"徐文浩","note":"","ucode":"1D39AC564172E9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":613308,"discussion_content":"pip install -U openai\n\n升级一下openai的sdk版本，你应该是之前在ChatGPT API还没有出来的时候就安装过openai的sdk了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1681262917,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1023293,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/9d/3d/2a39752e.jpg","nickname":"水他","note":"","ucode":"B67105561CFA71","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":614060,"discussion_content":"requrements.txt里写成 openai==0.27.0","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1681654324,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":372427,"user_name":"东方奇骥","can_delete":false,"product_type":"c1","uid":1354850,"ip_address":"四川","ucode":"DEE7085F7E55A4","user_header":"https://static001.geekbang.org/account/avatar/00/14/ac/62/37912d51.jpg","comment_is_top":false,"comment_ctime":1681126127,"is_pvip":false,"replies":[{"id":135948,"content":"每新增一轮对话，我们只是要删掉最前面的一轮对话，数组里index为1和2的两天记录呀。","user_name":"作者回复","user_name_real":"编辑","uid":1053568,"ctime":1681142370,"ip_address":"上海","comment_id":372427,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100541001,"comment_content":"del self.messages[1: 3] 为什么是3呢？理解应该是 del self.messages[1: self.num_of_round + 1]？","like_count":0,"discussions":[{"author":{"id":1053568,"avatar":"https://static001.geekbang.org/account/avatar/00/10/13/80/8de66543.jpg","nickname":"徐文浩","note":"","ucode":"1D39AC564172E9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":613168,"discussion_content":"每新增一轮对话，我们只是要删掉最前面的一轮对话，数组里index为1和2的两天记录呀。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1681142370,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":372159,"user_name":"徐连振","can_delete":false,"product_type":"c1","uid":1634661,"ip_address":"浙江","ucode":"42745EB93851DA","user_header":"https://static001.geekbang.org/account/avatar/00/18/f1/65/b6508936.jpg","comment_is_top":false,"comment_ctime":1680788793,"is_pvip":false,"replies":[{"id":135877,"content":"看一下 https:&#47;&#47;github.com&#47;openai&#47;openai-cookbook&#47;blob&#47;main&#47;examples&#47;How_to_count_tokens_with_tiktoken.ipynb\n\n部分编码有\nhttps:&#47;&#47;github.com&#47;hyunwoongko&#47;gpt2-tokenizer-java\n\n","user_name":"作者回复","user_name_real":"编辑","uid":1053568,"ctime":1680973752,"ip_address":"日本","comment_id":372159,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100541001,"comment_content":"老师您好！计算gpt-3.5-turbo模型的token数有对应的Java库吗？因为我们的应用是Java写的，写的也比较复杂和成熟了，不想再部署一个Python服务，有计算token数Java对应的库吗？求推荐","like_count":0,"discussions":[{"author":{"id":1053568,"avatar":"https://static001.geekbang.org/account/avatar/00/10/13/80/8de66543.jpg","nickname":"徐文浩","note":"","ucode":"1D39AC564172E9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":612872,"discussion_content":"看一下 https://github.com/openai/openai-cookbook/blob/main/examples/How_to_count_tokens_with_tiktoken.ipynb\n\n部分编码有\nhttps://github.com/hyunwoongko/gpt2-tokenizer-java\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1680973752,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"日本","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":372082,"user_name":"渣渣辉","can_delete":false,"product_type":"c1","uid":1911235,"ip_address":"日本","ucode":"730838D9161579","user_header":"https://static001.geekbang.org/account/avatar/00/1d/29/c3/791d0f5e.jpg","comment_is_top":false,"comment_ctime":1680691599,"is_pvip":false,"replies":[{"id":135900,"content":"Sorry，但是我没有理解你的问题是什么？能更具体一点举个例子么？","user_name":"作者回复","user_name_real":"编辑","uid":1053568,"ctime":1680975255,"ip_address":"日本","comment_id":372082,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100541001,"comment_content":"我这里有个疑问，如果老师已经讲过了的话十分抱歉。在老师给的代码里提示词prompt不会因为达到最大token被删除掉。因此我得出在实际的使用上prompt是要求不可以被删掉的参数。我的结论对吗？","like_count":0,"discussions":[{"author":{"id":1053568,"avatar":"https://static001.geekbang.org/account/avatar/00/10/13/80/8de66543.jpg","nickname":"徐文浩","note":"","ucode":"1D39AC564172E9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":612896,"discussion_content":"Sorry，但是我没有理解你的问题是什么？能更具体一点举个例子么？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1680975255,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"日本","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":372031,"user_name":"王昊翔Harry","can_delete":false,"product_type":"c1","uid":3573206,"ip_address":"英国","ucode":"D4B5FDFF6E1A50","user_header":"https://static001.geekbang.org/account/avatar/00/36/85/d6/0221579f.jpg","comment_is_top":false,"comment_ctime":1680607479,"is_pvip":false,"replies":[{"id":135889,"content":"这个应该是前面的代码你没有运行\n\n去 https:&#47;&#47;github.com&#47;xuwenhao&#47;geektime-ai-course 拿到原始的notebook，从上往下运行就好了。","user_name":"作者回复","user_name_real":"编辑","uid":1053568,"ctime":1680974452,"ip_address":"日本","comment_id":372031,"utype":1}],"discussion_count":2,"race_medal":0,"score":4,"product_id":100541001,"comment_content":"没有编程的新手，在跑代码的时候常常出现 NameError                                 Traceback (most recent call last)\n&lt;ipython-input-12-a8673c85e21c&gt; in &lt;cell line: 4&gt;()\n      2 1. 你的回答必须是中文\n      3 2. 回答限制在100个字以内&quot;&quot;&quot;\n----&gt; 4 conv1 = Conversation(prompt, 2)\n      5 question1 = &quot;你是谁？&quot;\n      6 print(&quot;User : %s&quot; % question1)\n\nNameError: name &#39;Conversation&#39; is not defined\n这一类问题。但是没有具体的解释。Pandas一些下载的方式也有些迷茫。无法推进","like_count":0,"discussions":[{"author":{"id":1053568,"avatar":"https://static001.geekbang.org/account/avatar/00/10/13/80/8de66543.jpg","nickname":"徐文浩","note":"","ucode":"1D39AC564172E9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":612885,"discussion_content":"这个应该是前面的代码你没有运行\n\n去 https://github.com/xuwenhao/geektime-ai-course 拿到原始的notebook，从上往下运行就好了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1680974452,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"日本","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2354198,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKib5EEL89P7Mpz2ib8QYmUwibiblzeziacHYCeIRCWv43l8E0FPPLtoDibsJ5xO56XSGLBaOFoSIA6dQ5A/132","nickname":"115121","note":"","ucode":"1DDB6FCA0788A5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":612520,"discussion_content":"你这里没有声明就直接调用了Conversation函数。你要在执行这段代码之前，先执行上边那个class Conversation:xxxxxx那一段","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1680766590,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":371901,"user_name":"Zhang.Q.W","can_delete":false,"product_type":"c1","uid":2865804,"ip_address":"新加坡","ucode":"3F8A2B4C143AB3","user_header":"https://static001.geekbang.org/account/avatar/00/2b/ba/8c/c57520b3.jpg","comment_is_top":false,"comment_ctime":1680508217,"is_pvip":false,"replies":[{"id":135707,"content":"看一下是在什么环境运行的，可能需要重启一下jupyter notebook的kernel。环境问题最简单的方式是看一下在Colab上是否可以运行，如果可以的话，多半是本地环境哪里启动的时候没有切到合适的env或者需要重启一下jupyter notebook","user_name":"作者回复","user_name_real":"编辑","uid":1053568,"ctime":1680580999,"ip_address":"上海","comment_id":371901,"utype":1}],"discussion_count":1,"race_medal":0,"score":4,"product_id":100541001,"comment_content":"请教一下：\n运行时\nimport gradio as gr\n\n报错\nModuleNotFoundError: No module named &#39;gradio&#39;\n\n在运行 pip install gradio 和pip list 也可以查看到gradio，在运行时 依然报错ModuleNotFoundError","like_count":0,"discussions":[{"author":{"id":1053568,"avatar":"https://static001.geekbang.org/account/avatar/00/10/13/80/8de66543.jpg","nickname":"徐文浩","note":"","ucode":"1D39AC564172E9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":612206,"discussion_content":"看一下是在什么环境运行的，可能需要重启一下jupyter notebook的kernel。环境问题最简单的方式是看一下在Colab上是否可以运行，如果可以的话，多半是本地环境哪里启动的时候没有切到合适的env或者需要重启一下jupyter notebook","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1680580999,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":371871,"user_name":"智勇双全","can_delete":false,"product_type":"c1","uid":1335421,"ip_address":"广东","ucode":"8A9931139D199A","user_header":"https://static001.geekbang.org/account/avatar/00/14/60/7d/adf4f7c3.jpg","comment_is_top":false,"comment_ctime":1680451586,"is_pvip":false,"replies":[{"id":135719,"content":"把需要的代码提取出来，变成一个.py文件，就当成一个普通的python程序去部署就好了。","user_name":"作者回复","user_name_real":"编辑","uid":1053568,"ctime":1680581690,"ip_address":"上海","comment_id":371871,"utype":1}],"discussion_count":3,"race_medal":0,"score":4,"product_id":100541001,"comment_content":"想部署到自己的腾讯云上该如何操作呢","like_count":0,"discussions":[{"author":{"id":1053568,"avatar":"https://static001.geekbang.org/account/avatar/00/10/13/80/8de66543.jpg","nickname":"徐文浩","note":"","ucode":"1D39AC564172E9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":612218,"discussion_content":"把需要的代码提取出来，变成一个.py文件，就当成一个普通的python程序去部署就好了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1680581690,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1559128,"avatar":"https://static001.geekbang.org/account/avatar/00/17/ca/58/6fe1854c.jpg","nickname":"金","note":"","ucode":"48D0B5CB8E5F9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":613910,"discussion_content":"腾讯云可以访问外网吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1681597052,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"湖南","group_id":0},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1335421,"avatar":"https://static001.geekbang.org/account/avatar/00/14/60/7d/adf4f7c3.jpg","nickname":"智勇双全","note":"","ucode":"8A9931139D199A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1559128,"avatar":"https://static001.geekbang.org/account/avatar/00/17/ca/58/6fe1854c.jpg","nickname":"金","note":"","ucode":"48D0B5CB8E5F9E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":615447,"discussion_content":"可以→_→","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1682263065,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":613910,"ip_address":"广东","group_id":0},"score":615447,"extra":""}]}]},{"had_liked":false,"id":371702,"user_name":"zhihai.tu","can_delete":false,"product_type":"c1","uid":1045888,"ip_address":"上海","ucode":"61371EA3EF6988","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f5/80/baddf03b.jpg","comment_is_top":false,"comment_ctime":1680192551,"is_pvip":true,"replies":[{"id":135731,"content":"应该是我放的一个免费的API Key的额度用完了。\n\n还是在本地跑起来Gradio用自己的Key吧。","user_name":"作者回复","user_name_real":"编辑","uid":1053568,"ctime":1680582527,"ip_address":"上海","comment_id":371702,"utype":1}],"discussion_count":10,"race_medal":0,"score":4,"product_id":100541001,"comment_content":"老师好，https:&#47;&#47;huggingface.co&#47;spaces&#47;xuwenhao83&#47;simple_chatbot这个链接我试了下，好像输入问题后按回车没有反应，是什么原因啊？","like_count":0,"discussions":[{"author":{"id":1053568,"avatar":"https://static001.geekbang.org/account/avatar/00/10/13/80/8de66543.jpg","nickname":"徐文浩","note":"","ucode":"1D39AC564172E9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":612230,"discussion_content":"应该是我放的一个免费的API Key的额度用完了。\n\n还是在本地跑起来Gradio用自己的Key吧。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1680582527,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":3,"child_discussions":[{"author":{"id":3601762,"avatar":"https://static001.geekbang.org/account/avatar/00/36/f5/62/65f811cc.jpg","nickname":"阿阮呀","note":"","ucode":"3B1D6E16BB917C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1053568,"avatar":"https://static001.geekbang.org/account/avatar/00/10/13/80/8de66543.jpg","nickname":"徐文浩","note":"","ucode":"1D39AC564172E9","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":614815,"discussion_content":"Gradio用自己的Key，也一样按回车键没有结果，请问是什么原因呀？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1681913853,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":612230,"ip_address":"北京","group_id":0},"score":614815,"extra":""},{"author":{"id":2011138,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/b0/02/98f8b0ee.jpg","nickname":"方华Elton","note":"","ucode":"180D03AADB5D2C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":3601762,"avatar":"https://static001.geekbang.org/account/avatar/00/36/f5/62/65f811cc.jpg","nickname":"阿阮呀","note":"","ucode":"3B1D6E16BB917C","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":618863,"discussion_content":"我也是，同学你解决了吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1684658440,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":614815,"ip_address":"美国","group_id":0},"score":618863,"extra":""},{"author":{"id":2011138,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/b0/02/98f8b0ee.jpg","nickname":"方华Elton","note":"","ucode":"180D03AADB5D2C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1053568,"avatar":"https://static001.geekbang.org/account/avatar/00/10/13/80/8de66543.jpg","nickname":"徐文浩","note":"","ucode":"1D39AC564172E9","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":618866,"discussion_content":"老师遇到了一个问题，就是gradio在本地pycharm中运行，最后的交互界面一直产生不了结果，然后在colab上运行就可以运行。疑惑原因是什么，本地pycharm环境不安装gradio界面可以正常运行，但是到交互界面上却不能运行。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1684659794,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":612230,"ip_address":"辽宁","group_id":0},"score":618866,"extra":""}]},{"author":{"id":1023093,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/9c/75/525e53b1.jpg","nickname":"Hobby","note":"","ucode":"8954830380D44F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":615283,"discussion_content":"我用老师https://huggingface.co/spaces/xuwenhao83/simple_chatbot/blob/main/app.py的可以。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1682165842,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1001745,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/49/11/75a31d88.jpg","nickname":"LunaElf","note":"","ucode":"22E002C13C6EF2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":612185,"discussion_content":"指定 requirements.txt 中的 openai 版本，例如 openai==0.27.2。因为 ChatCompletion 在 0.27.0 版本及以上才有。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1680573545,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"浙江","group_id":0},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1023093,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/9c/75/525e53b1.jpg","nickname":"Hobby","note":"","ucode":"8954830380D44F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1001745,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/49/11/75a31d88.jpg","nickname":"LunaElf","note":"","ucode":"22E002C13C6EF2","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":615281,"discussion_content":"这个不对的话，Building应该就fail了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1682165496,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":612185,"ip_address":"上海","group_id":0},"score":615281,"extra":""}]},{"author":{"id":2160005,"avatar":"https://static001.geekbang.org/account/avatar/00/20/f5/85/5cd2ce4c.jpg","nickname":"仗剑走天涯","note":"","ucode":"DC7E2484065C33","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":611667,"discussion_content":"我试了也是同样的问题，Enter以后就闪一下，没有结果，麻烦老师帮忙看看","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1680230349,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"山西","group_id":0},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1270612,"avatar":"https://static001.geekbang.org/account/avatar/00/13/63/54/84e7c168.jpg","nickname":"g4","note":"","ucode":"EFA0709EFDF4DE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2160005,"avatar":"https://static001.geekbang.org/account/avatar/00/20/f5/85/5cd2ce4c.jpg","nickname":"仗剑走天涯","note":"","ucode":"DC7E2484065C33","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":612788,"discussion_content":"我也是一样的问题，在colab里是OK的，部署到huggingface上不行  看日志 也没报错","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1680942069,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":611667,"ip_address":"四川","group_id":0},"score":612788,"extra":""},{"author":{"id":3579262,"avatar":"https://static001.geekbang.org/account/avatar/00/36/9d/7e/83524ccd.jpg","nickname":"王尼玛","note":"","ucode":"0F48004336502A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1270612,"avatar":"https://static001.geekbang.org/account/avatar/00/13/63/54/84e7c168.jpg","nickname":"g4","note":"","ucode":"EFA0709EFDF4DE","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":617542,"discussion_content":"看下是不对应的conversion类不对，老师的教程里创建过两个，有一个会返回两个值：回答和对应的token， 需要使用那个只return答案的conversion类，我遇到的是这个情况，可以看下\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1683638121,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":612788,"ip_address":"北京","group_id":0},"score":617542,"extra":""}]}]},{"had_liked":false,"id":371579,"user_name":"代码五花肉","can_delete":false,"product_type":"c1","uid":3295685,"ip_address":"韩国","ucode":"F7AAD5E7A15F7B","user_header":"https://static001.geekbang.org/account/avatar/00/32/49/c5/80c33529.jpg","comment_is_top":false,"comment_ctime":1680077174,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100541001,"comment_content":"设置一个阈值，如果超过阈值的话，就让AI总结一下，限定字数，然后清空对话记录，假如总结的这段话作为过往聊天记录再一起发送，缺点是要多调用API，多消耗token。","like_count":4},{"had_liked":false,"id":374212,"user_name":"Geek_b83fff","can_delete":false,"product_type":"c1","uid":2902752,"ip_address":"广东","ucode":"AFA20C90BCBF02","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJaaRiaBo5xtYPib3az6lBtSG8ibebDUVGgSMRPD3nGn9hr0Iz8dDZXxMzsUV2M7uiaicBg9HdBxcSFic7g/132","comment_is_top":false,"comment_ctime":1683712294,"is_pvip":false,"replies":null,"discussion_count":2,"race_medal":0,"score":4,"product_id":100541001,"comment_content":"成功运行，app.py 和require.txt； 老师没有展开说明，不是开发人员可能这一步会卡主","like_count":2,"discussions":[{"author":{"id":1452167,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJcwXucibksEYRSYg6icjibzGa7efcMrCsGec2UwibjTd57icqDz0zzkEEOM2pXVju60dibzcnQKPfRkN9g/132","nickname":"Geek_93970d","note":"","ucode":"52AC308BEC7737","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":619340,"discussion_content":"requirements.txt 里放上 openai","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1685003013,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1182967,"avatar":"https://static001.geekbang.org/account/avatar/00/12/0c/f7/d6547adb.jpg","nickname":"努力努力再努力","note":"","ucode":"F71E16290CB58C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":619528,"discussion_content":"只要跟下来的，应该没问题的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1685242455,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":371557,"user_name":"小掌柜","can_delete":false,"product_type":"c1","uid":2141953,"ip_address":"山东","ucode":"D9C21E6690CF77","user_header":"https://static001.geekbang.org/account/avatar/00/20/af/01/44fb3104.jpg","comment_is_top":false,"comment_ctime":1680061614,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100541001,"comment_content":"没有视频吗？","like_count":1},{"had_liked":false,"id":394685,"user_name":"Mamba","can_delete":false,"product_type":"c1","uid":1475049,"ip_address":"湖北","ucode":"8B3EC90736B8EB","user_header":"https://static001.geekbang.org/account/avatar/00/16/81/e9/d131dd81.jpg","comment_is_top":false,"comment_ctime":1727595744,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100541001,"comment_content":"你能根据这一讲学到的内容，修改一下代码，让这个聊天机器人不限制轮数，只在 Token 数量要超标的时候再删减最开始的对话么？除了“忘记”开始的几轮，你还能想到什么办法让 AI 尽可能多地记住上下文吗？\n把两个需求一起解决，限制tokens数量，当要超标了的时候，将前文对话总结并替换掉之前的对话，然后就可以使得AI“记住”更多的上下文信息\nclass Conversation:\n    def __init__(self, prompt, tokens):\n        self.prompt = prompt\n        self.instruct = &#39;请用简短的话总结目前对话的所有内容。&#39;\n        self.tokens = tokens\n        # self.num_of_round = num_of_round\n        self.messages = []\n        self.messages.append({&quot;role&quot;: &quot;system&quot;, &quot;content&quot;: self.prompt})\n\n    def ask(self, question):\n        try:\n            self.messages.append({&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: question})\n            response = client.chat.completions.create(\n                model=&quot;gpt-4o-mini&quot;,\n                messages=self.messages,\n                temperature=0.5,\n                max_tokens=1024,\n                top_p=1,\n            )\n        except Exception as e:\n            print(e)\n            return e\n\n        message = response.choices[0].message.content\n        self.messages.append({&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: message})\n        # 统计tokens\n        num_of_tokens = response.usage.total_tokens\n\n        # 如果超过一定tokens额度就把前面的对话总结并替换\n        if num_of_tokens &gt; self.tokens:\n            self.messages.append({&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: self.instruct})\n            summary = response.choices[0].message.content\n            del self.messages[1:]\n            # print(summary)\n            self.messages.append({&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: summary})\n            \n        # if len(self.messages) &gt; self.num_of_round*2 + 1:  # sytem+n*(user+assistant)\n        #     del self.messages[1:3] #Remove the first round conversation left.\n        return message,num_of_tokens","like_count":0},{"had_liked":false,"id":394085,"user_name":"Mamba","can_delete":false,"product_type":"c1","uid":1475049,"ip_address":"美国","ucode":"8B3EC90736B8EB","user_header":"https://static001.geekbang.org/account/avatar/00/16/81/e9/d131dd81.jpg","comment_is_top":false,"comment_ctime":1725776658,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100541001,"comment_content":"太棒了，发布了第一个属于自己的gpt！虽然只是一个demo，感觉很多地方可以拓展，比如外观界面，上下文长度，调用外部接口……开始在自己本地测试总是不行，不知道是代理哪里没设置正确，但部署之后就可以正常使用了！","like_count":0},{"had_liked":false,"id":393368,"user_name":"林晨晨","can_delete":false,"product_type":"c1","uid":2363025,"ip_address":"广东","ucode":"E81CFAA2240F1A","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKuAaicIfRL8yyG4MZ64DoBhFrJS2TXAYs4hS8ibicoAHlSt3wx7xKMEloncnjgWbwzGqCq3IENvOvWw/132","comment_is_top":false,"comment_ctime":1723610790,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100541001,"comment_content":"我能不能让ai帮忙把所有的对话概括写一下，然后再重新喂到提示中去？","like_count":0},{"had_liked":false,"id":386960,"user_name":"Geek_19eca2","can_delete":false,"product_type":"c1","uid":1655161,"ip_address":"浙江","ucode":"7A910AB1386532","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/ajNVdqHZLLAD2YLZnuaicxibvPo6SEC3VoZ9Yra2g7HXDeqkWodb4nUvfRkhaOJxechJjUHBib4Ih1ryymCOW7AkQ/132","comment_is_top":false,"comment_ctime":1706001496,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":5,"product_id":100541001,"comment_content":"You tried to access openai.ChatCompletion, but this is no longer supported in openai&gt;=1.0.0 - see the README at https:&#47;&#47;github.com&#47;openai&#47;openai-python for the API.  这个错误怎么解决？ \n","like_count":0},{"had_liked":false,"id":386143,"user_name":"杨逸林","can_delete":false,"product_type":"c1","uid":1167233,"ip_address":"浙江","ucode":"4BF3CF3E2F1AC7","user_header":"https://static001.geekbang.org/account/avatar/00/11/cf/81/96f656ef.jpg","comment_is_top":false,"comment_ctime":1704187671,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":5,"product_id":100541001,"comment_content":"最新的 ChatGPT 调用已经改了，总的代码换成我下面这个。不然用新的 openai 的 API 会报错。\n\n```python\nimport gradio as gr\nfrom openai import OpenAI\nimport os\n\n\napi_key = os.environ.get(&quot;OPENAI_API_KEY&quot;)\nclient = OpenAI(api_key=api_key)\n\nclass Conversation:\n    def __init__(self, prompt, num_of_round):\n        self.prompt = prompt\n        self.num_of_round = num_of_round\n        self.messages = []\n        self.messages.append({&quot;role&quot;: &quot;system&quot;, &quot;content&quot;: self.prompt})\n\n    def ask(self, question):\n        try:\n            self.messages.append({&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: question})\n            completion = client.chat.completions.create(\n                model=&quot;gpt-3.5-turbo&quot;,\n                messages=self.messages,\n                temperature=0.5,\n                max_tokens=2048,\n                top_p=1,\n            )\n        except Exception as e:\n            print(e)\n            return e\n\n        message = completion.choices[0].message.content\n        self.messages.append({&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: message})\n\n        if len(self.messages) &gt; self.num_of_round*2 + 1:\n            del self.messages[1:3]\n        return message\n\n\n\nprompt = &quot;&quot;&quot;你是一个中国厨师，用中文回答做菜的问题。你的回答需要满足以下要求:\n1. 你的回答必须是中文\n2. 回答限制在100个字以内&quot;&quot;&quot;\n\nconv = Conversation(prompt, 10)\n\ndef answer(question, history=[]):\n    history.append(question)\n    response = conv.ask(question)\n    history.append(response)\n    responses = [(u,b) for u,b in zip(history[::2], history[1::2])]\n    return responses, history\n\nwith gr.Blocks(css=&quot;#chatbot{height:300px} .overflow-y-auto{height:500px}&quot;) as demo:\n    chatbot = gr.Chatbot(elem_id=&quot;chatbot&quot;)\n    state = gr.State([])\n\n    with gr.Row():\n        txt = gr.Textbox(show_label=False, placeholder=&quot;Enter text and press enter&quot;)\n\n    txt.submit(answer, [txt, state], [chatbot, state])\n\ndemo.launch()\n```","like_count":0},{"had_liked":false,"id":384514,"user_name":"ShawnWu","can_delete":false,"product_type":"c1","uid":1253140,"ip_address":"北京","ucode":"A3E8397FDD20D6","user_header":"https://static001.geekbang.org/account/avatar/00/13/1f/14/57cb7926.jpg","comment_is_top":false,"comment_ctime":1701078795,"is_pvip":true,"replies":null,"discussion_count":0,"race_medal":1,"score":5,"product_id":100541001,"comment_content":"现在api key都获取不到了，咋整啊","like_count":0},{"had_liked":false,"id":381082,"user_name":"枫","can_delete":false,"product_type":"c1","uid":1698770,"ip_address":"广东","ucode":"759FC1885B07A5","user_header":"https://static001.geekbang.org/account/avatar/00/19/eb/d2/3d51e170.jpg","comment_is_top":false,"comment_ctime":1694658315,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":5,"product_id":100541001,"comment_content":"我们只需要通过 Git 把当前 space 下载下来，然后提交两个文件\n各位大佬，有人知道git clone空间是在哪里早错吗，电脑的终端，还是colab（我一直在用colab）\n以及提交两个文件是在哪操作呢？（我理解也是colab）","like_count":0},{"had_liked":false,"id":379535,"user_name":"jeff","can_delete":false,"product_type":"c1","uid":1026894,"ip_address":"河北","ucode":"68456DD035BDF4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ab/4e/82e9657c.jpg","comment_is_top":false,"comment_ctime":1692077453,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":5,"product_id":100541001,"comment_content":"gradio 是哪个版本，目前安装的3.23.0，总是提示：RuntimeError: Attempted to use SOCKS support, but the `socksio` package is not installed. Use &#39;pip install httpcore[socks]&#39;.\n","like_count":0},{"had_liked":false,"id":377868,"user_name":"Qweasd","can_delete":false,"product_type":"c1","uid":3003302,"ip_address":"广东","ucode":"1157FC1EE1E9B4","user_header":"https://static001.geekbang.org/account/avatar/00/2d/d3/a6/cb3d35fc.jpg","comment_is_top":false,"comment_ctime":1689408630,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":5,"product_id":100541001,"comment_content":"为什么那个聊天界面，按回车都没反应的","like_count":0},{"had_liked":false,"id":377708,"user_name":"小理想。","can_delete":false,"product_type":"c1","uid":2238528,"ip_address":"北京","ucode":"EDC35A907570DB","user_header":"https://static001.geekbang.org/account/avatar/00/22/28/40/82d748e6.jpg","comment_is_top":false,"comment_ctime":1689066395,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":5,"product_id":100541001,"comment_content":"colab快速开发小小的机器人，赞","like_count":0},{"had_liked":false,"id":377238,"user_name":"许益","can_delete":false,"product_type":"c1","uid":3010834,"ip_address":"江苏","ucode":"FEECA2203E5A52","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoToJnYyiaCt3iaNnmiaN4dYzoAymt4WR9FibQAqdhdseicX8mwibqCqSSwhBOSicLFEwVuEsGEb6ZrNq1Mg/132","comment_is_top":false,"comment_ctime":1688115447,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":5,"product_id":100541001,"comment_content":"请问一下，本地起gradio，chrome浏览器打开聊天交互页面没问题。但是进行聊天时，我输入“你好”报错，错误是：FileNotFoundError: [Errno 2] No such file or directory: &#39;你好！有什么我可以帮助你的呢？&#39;。也就是gpt已经回复：你好！有什么我可以帮助你的呢。但是gradio并没有正常返回答案。老师可以帮忙看看具体什么原因吗？","like_count":0,"discussions":[{"author":{"id":1052643,"avatar":"https://static001.geekbang.org/account/avatar/00/10/0f/e3/c49aa508.jpg","nickname":"鲸鱼","note":"","ucode":"71437C1C601040","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":622479,"discussion_content":"看一下你的Conversation类的ask函数返回值，是不是多返回了两个结果","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1688310611,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"日本","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":377171,"user_name":"许益","can_delete":false,"product_type":"c1","uid":3010834,"ip_address":"江苏","ucode":"FEECA2203E5A52","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoToJnYyiaCt3iaNnmiaN4dYzoAymt4WR9FibQAqdhdseicX8mwibqCqSSwhBOSicLFEwVuEsGEb6ZrNq1Mg/132","comment_is_top":false,"comment_ctime":1688024407,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":5,"product_id":100541001,"comment_content":"这课程越学越上头，很久没有这样的充电体验了！","like_count":0},{"had_liked":false,"id":376278,"user_name":"whhbbq","can_delete":false,"product_type":"c1","uid":1018494,"ip_address":"浙江","ucode":"4A93F3E375CB44","user_header":"","comment_is_top":false,"comment_ctime":1686638159,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":5,"product_id":100541001,"comment_content":"成功运行。但一个问题30s才响应，崩溃","like_count":0},{"had_liked":false,"id":376249,"user_name":"张冶国","can_delete":false,"product_type":"c1","uid":2038954,"ip_address":"北京","ucode":"45088436A0CE65","user_header":"https://static001.geekbang.org/account/avatar/00/1f/1c/aa/b3440242.jpg","comment_is_top":false,"comment_ctime":1686587224,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":6,"product_id":100541001,"comment_content":"老师好，开启stream=True的时候，使用tiktoken计算token数的时候会返回&#39;generator&#39; object is not subscriptable，我既想要保持流式返回，也想要计算token数该如何解决？谢谢老师解答","like_count":0},{"had_liked":false,"id":375972,"user_name":"auscarᶘ ᵒᴥᵒᶅ","can_delete":false,"product_type":"c1","uid":1073756,"ip_address":"广东","ucode":"639D40557863BE","user_header":"https://static001.geekbang.org/account/avatar/00/10/62/5c/550fb243.jpg","comment_is_top":false,"comment_ctime":1686194958,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":6,"product_id":100541001,"comment_content":"老师，请教一个问题，我用的是Azure的openai服务，即使用了流式返回，数据最快也要 3～7 秒的时候才能返回结果，这个问题有办法改善吗？以前我直接调用openai的api时，大概是1～2秒就能返回结果","like_count":0,"discussions":[{"author":{"id":2120663,"avatar":"https://static001.geekbang.org/account/avatar/00/20/5b/d7/d88c1850.jpg","nickname":"和某欢","note":"","ucode":"5E0F27533597F1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":620538,"discussion_content":"同问，azure有时候响应超过30秒","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1686273255,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"四川","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":375519,"user_name":"Geek_7ee455","can_delete":false,"product_type":"c1","uid":1527581,"ip_address":"浙江","ucode":"76C69F26B0F653","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/270T9KAFd4oCxXXB1giaMDaJuTQVib8gPt77VkM5dbS3hW60kwTNnxMYpVibwWVdnASCrymBbwT7HI77URia0KUylw/132","comment_is_top":false,"comment_ctime":1685590001,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":6,"product_id":100541001,"comment_content":"现在好像能记忆的对话轮次变多了很多","like_count":0},{"had_liked":false,"id":375137,"user_name":"Geek_93970d","can_delete":false,"product_type":"c1","uid":1452167,"ip_address":"北京","ucode":"52AC308BEC7737","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJcwXucibksEYRSYg6icjibzGa7efcMrCsGec2UwibjTd57icqDz0zzkEEOM2pXVju60dibzcnQKPfRkN9g/132","comment_is_top":false,"comment_ctime":1684975174,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":6,"product_id":100541001,"comment_content":"That model is currently overloaded with other requests. You can retry your request, or contact us through our help center at help.openai.com if the error persists. (Please include the request ID 5ba226322800e158aeeb81b25ccfa933 in your message.)","like_count":0},{"had_liked":false,"id":372770,"user_name":"金","can_delete":false,"product_type":"c1","uid":1559128,"ip_address":"湖南","ucode":"48D0B5CB8E5F9E","user_header":"https://static001.geekbang.org/account/avatar/00/17/ca/58/6fe1854c.jpg","comment_is_top":false,"comment_ctime":1681605387,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":6,"product_id":100541001,"comment_content":"搭好了 但是好像用了几次就用不了了 看来还得找平替","like_count":0},{"had_liked":false,"id":371939,"user_name":"LunaElf","can_delete":false,"product_type":"c1","uid":1001745,"ip_address":"浙江","ucode":"22E002C13C6EF2","user_header":"https://static001.geekbang.org/account/avatar/00/0f/49/11/75a31d88.jpg","comment_is_top":false,"comment_ctime":1680533845,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":6,"product_id":100541001,"comment_content":"question4 和 question5 的回答都是「你的第一个问题是：“请问鱼香肉丝怎么做？”」\n\n有一定的几率会这么回答。","like_count":0,"discussions":[{"author":{"id":3579262,"avatar":"https://static001.geekbang.org/account/avatar/00/36/9d/7e/83524ccd.jpg","nickname":"王尼玛","note":"","ucode":"0F48004336502A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":617540,"discussion_content":"对，我也是这样的情况，感觉是因为上下文里有一样的问题，gpt就在上下文里找到对应的答案","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1683637761,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":371866,"user_name":"Rocky_zd","can_delete":false,"product_type":"c1","uid":3014658,"ip_address":"广东","ucode":"2C0629236B1884","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJ6a62xdMTZ3jibIoWGRj3trQIB3LAXNA6CNHRWszMdJpkGfXdANm7TLD4d8StZRw90OQ43sIEMx1A/132","comment_is_top":false,"comment_ctime":1680446899,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":6,"product_id":100541001,"comment_content":"作为一个门外汉，跟着老师能把例子实现出来，蛮好玩的","like_count":0}]}