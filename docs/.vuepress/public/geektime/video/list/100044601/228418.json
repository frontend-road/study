{"id":228418,"title":"42 | 网关与BFF：使用JWT来实现身份认证与授权","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/NET-Core\">https://gitee.com/geektime-geekbang/NET-Core</a></p>","comments":[{"had_liked":false,"id":210731,"user_name":"SuperSnow","can_delete":false,"product_type":"c3","uid":1065351,"ip_address":"","ucode":"84C89AA8083E6A","user_header":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","comment_is_top":false,"comment_ctime":1587816518,"is_pvip":false,"replies":[{"id":79661,"content":"认证和授权如果在网关上做，那么网关就必须知晓每个接口需要的权限是什么，而这部分本身实际上是微服务负责定义的。\n对于通常的业务系统，建议微服务自己负责授权，认证可以考虑网关做。\n\n对于API开放平台性质的系统，可以考虑网关负责认证和授权，因为这类系统的授权机制是可以与接口本身解耦的","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1588944074,"ip_address":"","comment_id":210731,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"肖老师，有一个问题，既然网关已经有了认证部分，那微服务部分就没有必要再加上一层认证了吧，毕竟所有的微服务都是通过网关暴露出去的。当然如果有微服务部分加上认证也有一个好处，就是可以根据payload信息来获取当前用户的相关指标，这样的确是比通过向微服务的各个api接口传用户相关指标要好多了。难倒在微服务上加认证就是为了这个吗？","like_count":2,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493095,"discussion_content":"认证和授权如果在网关上做，那么网关就必须知晓每个接口需要的权限是什么，而这部分本身实际上是微服务负责定义的。\n对于通常的业务系统，建议微服务自己负责授权，认证可以考虑网关做。\n\n对于API开放平台性质的系统，可以考虑网关负责认证和授权，因为这类系统的授权机制是可以与接口本身解耦的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588944074,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":221801,"user_name":"image","can_delete":false,"product_type":"c3","uid":1039069,"ip_address":"","ucode":"A45BFF284F8933","user_header":"https://static001.geekbang.org/account/avatar/00/0f/da/dd/1e5e7b0c.jpg","comment_is_top":false,"comment_ctime":1590593382,"is_pvip":false,"replies":[{"id":82225,"content":"推荐使用 identityserver4 ","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1591006696,"ip_address":"","comment_id":221801,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"auth2  实现sso  支持高并发有什么推荐方案吗？","like_count":1,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":496577,"discussion_content":"推荐使用 identityserver4 ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591006696,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":227169,"user_name":"Geek_09f05a","can_delete":false,"product_type":"c3","uid":1621322,"ip_address":"","ucode":"28ABA543BE59CE","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKLKIWfKoMNv3KpUe2IML2m4dXn9N1XZgWJHDH0lP2USfWQLY1BLN1mibO8YxXjiayGicU7ycvFRX6jw/132","comment_is_top":false,"comment_ctime":1592304146,"is_pvip":false,"replies":[{"id":86009,"content":"jwt是认证token的一种方式，子系统的场景要看你怎么组织api，也要看子系统的业务关系。要么共享jwttoken，要么分别颁发","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1594223149,"ip_address":"","comment_id":227169,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"老师好，用户登录用jwt实现的，那我们有好多子系统，怎么保护api接口呢","like_count":0,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":498522,"discussion_content":"jwt是认证token的一种方式，子系统的场景要看你怎么组织api，也要看子系统的业务关系。要么共享jwttoken，要么分别颁发","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594223149,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":225292,"user_name":"1122","can_delete":false,"product_type":"c3","uid":2029296,"ip_address":"","ucode":"74F3121BE608E3","user_header":"https://static001.geekbang.org/account/avatar/00/1e/f6/f0/221ae921.jpg","comment_is_top":false,"comment_ctime":1591707635,"is_pvip":false,"replies":[{"id":83284,"content":"使用jwt的话，刷新由前端来控制，推荐使用refreshToken来处理","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1591949917,"ip_address":"","comment_id":225292,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"老师，我想问一下jwt刷新Token问题，让客户感觉不到。我目前想到的就下面两个，请问老师还有更好地解决方案吗？\n1.过期发送异常，前端判断异常，请求refreshToken，在重新调用这个ajax。\n2.后端加个拦截器，在认证成功的前提下，刷新token，添加到header返回前端，前端每一个ajax请求成功都对比本地token，然后更新。","like_count":0,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":497799,"discussion_content":"使用jwt的话，刷新由前端来控制，推荐使用refreshToken来处理","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591949917,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1157517,"avatar":"","nickname":"Geek_acbb4f","note":"","ucode":"ACF1085DCBE5D2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":386360,"discussion_content":"每次请求都判断，可以提前(30分钟)，将jwt有效期刷新(通过前端)，这样不会抛异常。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627548917,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":218597,"user_name":"学习者","can_delete":false,"product_type":"c3","uid":1880838,"ip_address":"","ucode":"7B176FAE22C9E6","user_header":"https://static001.geekbang.org/account/avatar/00/1c/b3/06/ab52e221.jpg","comment_is_top":false,"comment_ctime":1589839916,"is_pvip":false,"replies":[{"id":81339,"content":"services.AddAuthentication(CookieAuthenticationDefaults.AuthenticationScheme)\nstartup类中，类似下列写法                \nAddCookie(CookieAuthenticationDefaults.AuthenticationScheme, options =&gt;\n                {\n                    options.LoginPath = &quot;&#47;account&#47;login&quot;;\n                    options.Cookie.HttpOnly = true;\n}\n                });","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1590235989,"ip_address":"","comment_id":218597,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"肖老师，在没有登录时，访问BankAccountController，系统是如何跳转到 account&#47;login 这个api的？在哪里配置的？","like_count":0,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":495521,"discussion_content":"services.AddAuthentication(CookieAuthenticationDefaults.AuthenticationScheme)\nstartup类中，类似下列写法                \nAddCookie(CookieAuthenticationDefaults.AuthenticationScheme, options =&amp;gt;\n                {\n                    options.LoginPath = &amp;quot;/account/login&amp;quot;;\n                    options.Cookie.HttpOnly = true;\n}\n                });","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590235989,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2029296,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/f6/f0/221ae921.jpg","nickname":"1122","note":"","ucode":"74F3121BE608E3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":281298,"discussion_content":"没有登录，token验证不通过，返回给前端，前端判断是不是授权的异常，做一个导航到登录页不就行了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591707795,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":214677,"user_name":"stg609","can_delete":false,"product_type":"c3","uid":1073025,"ip_address":"","ucode":"FB70A75A891BB8","user_header":"https://static001.geekbang.org/account/avatar/00/10/5f/81/1c614f4a.jpg","comment_is_top":false,"comment_ctime":1588780453,"is_pvip":false,"replies":[{"id":79634,"content":"一般是为每个微服务配置一条","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1588939087,"ip_address":"","comment_id":214677,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"Ocelot 一般如何配置reroute？是直接使用everything 这种模式匹配一堆action呢？还是为每个下游的action都单独配一个reroute? ","like_count":0,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":494169,"discussion_content":"一般是为每个微服务配置一条","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588939087,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":214675,"user_name":"stg609","can_delete":false,"product_type":"c3","uid":1073025,"ip_address":"","ucode":"FB70A75A891BB8","user_header":"https://static001.geekbang.org/account/avatar/00/10/5f/81/1c614f4a.jpg","comment_is_top":false,"comment_ctime":1588780321,"is_pvip":false,"replies":[{"id":79635,"content":"即使网关进行了授权认证，微服务的api还是要进行授权判断的，因此你可以根据自己的实际场景来决定授权工作在那一层。\n一般来讲，网关只负责入口路由，不负责业务（认证与授权）比较适合微服务架构。\n\n如果你的网关是为了暴露开放平台的接口，这种场景，可以考虑网关负责认证授权，而微服务不需要关心授权问题","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1588939256,"ip_address":"","comment_id":214675,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"是否考虑直接使用 Ocelot 自身支持的 authentication 方式呢？","like_count":0,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":494168,"discussion_content":"即使网关进行了授权认证，微服务的api还是要进行授权判断的，因此你可以根据自己的实际场景来决定授权工作在那一层。\n一般来讲，网关只负责入口路由，不负责业务（认证与授权）比较适合微服务架构。\n\n如果你的网关是为了暴露开放平台的接口，这种场景，可以考虑网关负责认证授权，而微服务不需要关心授权问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588939256,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":210384,"user_name":"Geek_7a97f9","can_delete":false,"product_type":"c3","uid":1810088,"ip_address":"","ucode":"FD028642FA28D1","user_header":"","comment_is_top":false,"comment_ctime":1587733776,"is_pvip":false,"replies":[{"id":80607,"content":"需要服务端与客户端定义约定，由客户端发起续约","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1589685364,"ip_address":"","comment_id":210384,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"jwt我一直在想该怎么管理自动续签问题，老师有什么好的办法吗","like_count":0,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493011,"discussion_content":"需要服务端与客户端定义约定，由客户端发起续约","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589685364,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":247517,"discussion_content":"在获取token的时候，判断一下是否进入失效预警范围，如果进入了这个范围，可以产生一个新的token。这个还有其他方法，比如可以再带着另外一个token，当然这些都是有最后失效时间的，如果失效的很彻底了，那只能最后再登录了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587816282,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}