{"id":622743,"title":"16｜自动构建：如何使用 GitHub Action 构建镜像？","content":"<p>你好，我是王炜。</p><p>前面几节课，我们一起学习了容器化的最佳实践。从本质上来说，我们一直都在学习编写 Dockerfile 的技巧，以及如何构建出更适合生产环境的镜像。</p><p>在之前的课程中，我们编写完 Dockerfile 之后，会在本地通过 docker build 命令来构建镜像，然后把它推送到 Docker Hub 的镜像仓库中。不过实际上，在完整的 GitOps 的环节中，我们并不会用这种手动的方式来构建镜像，通常我们会使用工具完成自动构建。</p><p>如果你熟悉 DevOps 流程，会知道在提交代码之后会触发一个自动化流程，<strong>它就是我们常说的 CI (Continuous integration)，持续集成</strong>。持续集成会自动帮助我们做一些编译、构建、测试和打包工作。在将业务进行容器化改造之后，我们会有更多构建 Docker 镜像的工作，所以为了提高效率，在 GitOps 工作流中，我们同样可以在持续集成的阶段实现自动化的镜像构建。</p><p>所以，从这节课开始，我将带你学习 GitOps 工作流中的第一个自动化阶段：自动构建镜像。</p><p>这节课我会以 K8s 极简实战中的示例应用为例，带你从零开始配置 GitHub Action 自动构建镜像的工作流，<strong>它是组成 GitOps 工作流中的重要的一环</strong>。</p><!-- [[[read_end]]] --><h2>什么是 GitHub Action？</h2><p>在正式使用 GitHub Action 自动构建镜像之前，你需要先了解一些基本概念，我们直入主题，重点介绍这节课会涉及的概念和用法。</p><p>为了帮助你更好地理解 GitHub Action，我为你画了一张示意图。</p><p><img src=\"https://static001.geekbang.org/resource/image/6b/c7/6bb3d5a619a352c89be6356d1220edc7.jpg?wh=1863x1026\" alt=\"图片\"></p><p>这张图中出现了几个基本概念：Workflow、Event、Job 和 Step，我们分开来讲解。</p><h3>Workflow</h3><p>Workflow 也叫做工作流。其实，GitHub Action 本质上是一个是一个 CI/CD 工作流，要使用工作流，我们首先需要先定义它。和 K8s Manifest 一样，GitHub Action 工作流是通过 YAML 来描述的，你可以在任何 GitHub 仓库创建 .github/workflows 目录，并创建 YAML 文件来定义工作流。</p><p>所有在 .github/workflows 目录创建的工作流文件，都将被 GitHub 自动扫描。在工作流中，通常我们会进一步定义 Event、Job 和 Step 字段，它们被用来定义工作流的触发时机和具体行为。</p><h3>Event</h3><p>Event 从字面上的理解是“事件”的意思，你可以简单地把它理解为定义了“什么时候运行工作流”，也就是工作流的触发器。</p><p>在定义自动化构建镜像的工作流时，我们通常会把 Event 的触发器配置成“当指定分支有新的提交时，自动触发镜像构建”。</p><h3>Jobs</h3><p>Jobs 的字面意思是一个具体的任务，它是一个抽象概念。在工作流中，它并不能直接工作，而是需要通过 Step 来定义具体的行为。此外，你还可以为 Job 定义它的运行的环境，例如 ubuntu。</p><p>在一个 Workflow 当中，你可以定义多个 Job，多个 Job 之间可以并行运行，也可以定义相互依赖关系。在自动构建镜像环节，通常我们只需要定义一个 Job 就够了，所以在上面的示意图中，我只画出了一个 Job。</p><h3>Step</h3><p>Step 隶属于 Jobs，它是工作流中最小的粒度，也是最重要的部分。通常来说，Step 的具体行为是执行一段 Shell 来完成一个功能。在同一个 Job 里，一般我们需要定义多个 Step 才能完成一个完整的 Job，由于它们是在同一个环境下运行的，所以当它们运行时，就等同于在同一台设备上执行一段 Shell。</p><p>以自动构建镜像为例，我们可能需要在 1 个 Job 中定义 3 个 Step。</p><ul>\n<li>Step1，克隆仓库的源码。</li>\n<li>Step2，运行 docker build 来构建镜像。</li>\n<li>Step3，推送到镜像仓库。</li>\n</ul><h3>费用</h3><p>GitHub Action 在使用上虽然很方便，但天下并没有免费的午餐。对于 GitHub 免费账户，每个月有 2000 分钟的 GitHub Action 时长可供使用（Linux 环境），超出时长则需要按量付费，你可以在<a href=\"https://docs.github.com/en/billing/managing-billing-for-github-actions/about-billing-for-github-actions#calculating-minute-and-storage-spending\">这里</a>查看详细的计费策略。</p><h2>为示例应用创建 GitHub Action Workflow</h2><p>了解了 GitHub Action 的相关概念，<strong>接下来我们就进入到实战环节了</strong>。</p><p>我以 K8s 极简实战模块的示例应用为例，看看如何配置自动构建示例应用的前后端镜像工作流。在这个例子中，我们创建的工作流将实现以下这些步骤。</p><ul>\n<li>当 main 分支有新的提交时，触发工作流。</li>\n<li>克隆代码。</li>\n<li>初始化 Docker 构建工具链。</li>\n<li>登录 Docker Hub。</li>\n<li>构建前后端应用镜像，并使用 commit id 作为镜像的 tag。</li>\n<li>推送到 Docker Hub 镜像仓库。</li>\n</ul><p>下面，我们来为示例应用创建工作流。</p><h3>创建 build.yaml 文件</h3><p>首先，我们要将示例应用仓库克隆到本地。</p><pre><code class=\"language-yaml\">$ git clone https://github.com/lyzhang1999/kubernetes-example.git\n</code></pre><p>进入 kubernetes-example 目录。</p><pre><code class=\"language-yaml\">$ cd kubernetes-example\n</code></pre><p>然后，在当前目录下新建 .github/workflows 目录。</p><pre><code class=\"language-yaml\">$ mkdir -p .github/workflows\n</code></pre><p>接下来，将下面的内容保存到 .github/workflows/build.yaml 文件内。</p><pre><code class=\"language-yaml\">name: build\n\non:\n  push:\n    branches:\n      - 'main'\n\nenv:\n  DOCKERHUB_USERNAME: lyzhang1999\n\njobs:\n  docker:\n    runs-on: ubuntu-latest\n    steps:\n      - name: Checkout\n        uses: actions/checkout@v3\n      - name: Set outputs\n        id: vars\n        run: echo \"::set-output name=sha_short::$(git rev-parse --short HEAD)\"\n      - name: Set up QEMU\n        uses: docker/setup-qemu-action@v2\n      - name: Set up Docker Buildx\n        uses: docker/setup-buildx-action@v2\n      - name: Login to Docker Hub\n        uses: docker/login-action@v2\n        with:\n          username: ${{ env.DOCKERHUB_USERNAME }}\n          password: ${{ secrets.DOCKERHUB_TOKEN }}\n      - name: Build backend and push\n        uses: docker/build-push-action@v3\n        with:\n          context: backend\n          push: true\n          tags: ${{ env.DOCKERHUB_USERNAME }}/backend:${{ steps.vars.outputs.sha_short }}\n      - name: Build frontend and push\n        uses: docker/build-push-action@v3\n        with:\n          context: frontend\n          push: true\n          tags: ${{ env.DOCKERHUB_USERNAME }}/frontend:${{ steps.vars.outputs.sha_short }}\n</code></pre><p>请注意，<strong>你需要将上面的 env.DOCKERHUB_USERNAME 环境变量替换为你的 Docker Hub 用户名</strong>。</p><p>我简单介绍一下这个工作流。</p><p>这里的 name 字段是工作流的名称，它会展示在 GitHub 网页上。</p><p>on.push.branches 字段的值为 main，这代表当 main 分支有新的提交之后，会触发工作流。</p><p>env.DOCKERHUB_USERNAME 是我们为 Job 配置的全局环境变量，用作镜像 Tag 的前缀。</p><p>jobs.docker 字段定义了一个任务，它的运行环境是 ubuntu-latest，并且由 7 个 Step 组成。</p><p>jobs.docker.steps 字段定义了 7 个具体的执行阶段。要特别注意的是，uses 字段代表使用 GitHub Action 的某个插件，例如 actions/checkout@v3 插件会帮助我们检出代码。</p><p>在这个工作流中，这 7 个阶段会具体执行下面几件事。</p><ol>\n<li>“Checkout”阶段负责将代码检出到运行环境。</li>\n<li>“Set outputs”阶段会输出 sha_short 环境变量，值为 short commit id，这可以方便在后续阶段引用。</li>\n<li>“Set up QEMU”和“Set up Docker Buildx”阶段负责初始化 Docker 构建工具链。</li>\n<li>“Login to Docker Hub”阶段通过 docker login 来登录到 Docker Hub，以便获得推送镜像的权限。要注意的是，with 字段是向插件传递参数的，在这里我们传递了 username 和 password，值的来源分别是我们定义的环境变量 DOCKERHUB_USERNAME 和 GitHub Action Secret，后者我们还会在稍后进行配置。</li>\n<li>“Build backend and push”和“Build frontend and push”阶段负责构建前后端镜像，并且将镜像推送到 Docker Hub，在这个阶段中，我们传递了 context、push 和 tags 参数，context 和 tags 实际上就是 docker build 的参数。在 tags 参数中，我们通过表达式 <code>${{ env.DOCKERHUB_USERNAME }}</code> 和 <code>${{ steps.vars.outputs.sha_short }}</code> 分别读取了 在 YAML 中预定义的 Docker Hub 的用户名，以及在“Set outputs”阶段输出的 short commit id。</li>\n</ol><h3>创建 GitHub 仓库并推送</h3><p>创建完 build.yaml 文件后，接下来，我们要把示例应用推送到 GitHub 上。首先，你需要通过<a href=\"https://github.com/new\">这个页面</a>来为自己创建新的代码仓库，仓库名设置为 kubernetes-example。</p><p><img src=\"https://static001.geekbang.org/resource/image/d7/32/d7a01ee80ef7d4cyy58d6b04393d3632.png?wh=1590x1074\" alt=\"图片\"></p><p>创建完成后，将刚才克隆的 kubernetes-example 仓库的 remote url 配置为你刚才创建仓库的 Git 地址。</p><pre><code class=\"language-yaml\">$ git remote set-url origin YOUR_GIT_URL\n</code></pre><p>然后，将 kubernetes-example 推送到你的仓库。在这之前，你可能还需要配置 SSH Key，你可以参考<a href=\"https://docs.github.com/cn/authentication/connecting-to-github-with-ssh/adding-a-new-ssh-key-to-your-github-account\">这个链接</a>来配置，这里就不再赘述了。</p><pre><code class=\"language-yaml\">$ git add .\n$ git commit -a -m 'first commit'\n$ git branch -M main\n$ git push -u origin main\n</code></pre><h3>创建 Docker Hub Secret</h3><p>创建完 build.yaml 文件后，接下来，我们需要创建 Docker Hub Secret，它将会为工作流提供推送镜像的权限。</p><p>首先，使用你注册的账号密码登录 <a href=\"https://hub.docker.com/\">https://hub.docker.com/</a>。然后，点击右上角的“用户名”，选择“Account Settings”，并进入左侧的“Security”菜单。</p><p><img src=\"https://static001.geekbang.org/resource/image/b7/16/b70fea1a316d6212c858eayyacb67316.png?wh=1920x879\" alt=\"图片\"></p><p>下一步点击右侧的“New Access Token”按钮，创建一个新的 Token。</p><p><img src=\"https://static001.geekbang.org/resource/image/a1/ba/a11f8af16b193fe8f194133d2634e5ba.png?wh=1472x1114\" alt=\"图片\"></p><p>输入描述，然后点击“Genarate”按钮生成 Token。</p><p><img src=\"https://static001.geekbang.org/resource/image/dc/13/dc0d5c4a9bff3c49d81b3d4ab1a8f513.png?wh=1470x1146\" alt=\"图片\"></p><p>点击“Copy and Close”将 Token 复制到剪贴板。<strong>请注意，当窗口关闭后，Token 无法再次查看，所以请在其他地方先保存刚才生成的 Token。</strong></p><h3>创建 GitHub Action Secret</h3><p>创建完 Docker Hub Token 之后，接下来我们就可以创建 GitHub Action Secret 了，也就是说我们要为 Workflow 提供 secrets.DOCKERHUB_TOKEN 变量值。</p><p>进入 kubernetes-example 仓库的 Settings 页面，点击左侧的“Secrets”，进入“Actions”菜单，然后点击右侧“New repository secret”创建新的 Secret。</p><p><img src=\"https://static001.geekbang.org/resource/image/cy/f6/cyy66105ccd814e72bea4729322744f6.png?wh=1920x877\" alt=\"图片\"></p><p>在 Name 输入框中输入 DOCKERHUB_TOKEN，这样在 GitHub Action 的 Step 中，<strong>就可以通过 ${{ secrets.DOCKERHUB_TOKEN }} 表达式来获取它的值</strong>。</p><p>在 Secret 输入框中输入刚才我们复制的 Docker Hub Token，点击“Add secret”创建。</p><h3>触发 GitHub Action Workflow</h3><p>到这里，准备工作已经全部完成了，接下来我们尝试触发 GitHub Action 工作流。还记得我们在工作流配置的 on.push.branches 字段吗？它的值为 main，代表当有新的提交到 main 分支时触发工作流。</p><p>首先，我们向仓库提交一个空 commit。</p><pre><code class=\"language-yaml\">$ git commit --allow-empty -m \"Trigger Build\"\n</code></pre><p>然后，使用 git push 来推送到仓库，<strong>这将触发工作流</strong>。</p><pre><code class=\"language-yaml\">$ git push origin main\n</code></pre><p>接下来，进入 kubernetes-example 仓库的“Actions”页面，你将看到我们刚才触发的工作流。</p><p><img src=\"https://static001.geekbang.org/resource/image/17/fc/17e36a14d86485585ed1e283fa22cffc.png?wh=1920x879\" alt=\"图片\"></p><p>你可以点击工作流的标题进入工作流详情页面。</p><p><img src=\"https://static001.geekbang.org/resource/image/74/ec/7401326152f418e6dc59182753yycdec.png?wh=1920x876\" alt=\"图片\"></p><p>在工作流的详情页面，我们能看到工作流的每一个 Step 的状态及其运行时输出的日志。</p><p>当工作流运行完成后，进入到 Docker Hub frontend 或者 backend 镜像的详情页，你将看到刚才 GitHub Action 自动构建并推送的新版本镜像。</p><p><img src=\"https://static001.geekbang.org/resource/image/e3/94/e3c7aa048fd003222bc2258d4d35f994.png?wh=1920x877\" alt=\"图片\"></p><p>到这里，我们便完成了使用 GitHub Action 自动构建镜像的全过程。最终实现效果是，当我们向 main 分支提交代码时，GitHub 工作流将自动构建 frontend 和 backend 镜像，<strong>并且每一个 commit id 对应一个镜像版本。</strong></p><h2>总结</h2><p>总结一下，这节课，我为你介绍了构成 GitOps 工作流的第一个自动化阶段：自动化构建镜像。为了实现自动化构建镜像，我们学习了 GitHub Action 工作流及其基本概念，例如 Workflow、Event、Jobs 和 Steps。</p><p>在介绍 GitHub Action 相关概念时，我故意精简了一部分概念，比如 Runner、多个 Jobs 以及 Jobs 相互依赖的情况。在现阶段，我们只需要掌握最简单的自动构建镜像的 YAML 写法以及相关概念就足够了。</p><p>在实战环节，我们创建了一个 build.yaml 文件用来定义 GitHub Action 工作流，总结来说，它定义了工作流的：</p><ol>\n<li>工作流名称</li>\n<li>在什么时候触发</li>\n<li>在什么环境下运行</li>\n<li>具体执行的步骤是什么</li>\n</ol><p>需要注意的是，在创建 build.yaml 文件后，你需要创建自己的仓库，并将 kubernetes-example 的内容推送到你的仓库中，以便进行触发工作流的实验。其次，为了给 GitHub Action 工作流赋予镜像仓库的推送权限，我们还需要在 Docker Hub 中创建 Token，并将其配置到仓库的 Secrets 中。在配置时，需要注意 Secret Name 和工作流 Step 中的 ${{ secrets.DOCKERHUB_TOKEN }} 表达式相互对应，以便工作流能够获取到正确的 Secrets。</p><p>配置完成后，当我们向 Main 分支推送新的提交时，GitHub Action 工作流将会被自动触发，工作流会自动构建 frontend 和 backend 镜像，并且会使用当前的 short commit id 作为镜像的 Tag 推送到 Docker Hub 中。</p><p><strong>这意味着，每一个提交都会生成一个 Docker 镜像，实现了代码和制品的对应关系。</strong>这种对应关系给我们带来了非常大的好处，例如当我们要回滚或更新应用时，只需要找到代码的 commit id 就能够找到对应的镜像版本。</p><h2>思考题</h2><p>最后，给你留一道简单的思考题吧。</p><p>docker/build-push-action 插件还有其他的一些高级配置，请你结合 docker/build-push-action@v3 <a href=\"https://github.com/docker/build-push-action/blob/master/docs/advanced/multi-platform.md\">插件文档</a>，尝试改造 build.yaml，使其同时支持构建 linux/amd64 和 linux/arm64 两个平台的镜像，并和我分享改动之后的 YAML。</p><p>欢迎你给我留言交流讨论，你也可以把这节课分享给更多的朋友一起阅读。我们下节课见。</p>","neighbors":{"left":{"article_title":"15｜容器化：如何选择最适合业务的基础镜像？","id":622063},"right":{"article_title":"17｜自动构建：如何使用 GitLab CI 构建镜像？","id":623358}},"comments":[{"had_liked":false,"id":366288,"user_name":"GAC·DU","can_delete":false,"product_type":"c1","uid":1385403,"ip_address":"北京","ucode":"7847FBE1C13740","user_header":"https://static001.geekbang.org/account/avatar/00/15/23/bb/a1a61f7c.jpg","comment_is_top":false,"comment_ctime":1673562924,"is_pvip":false,"replies":[{"id":133465,"content":"我们的实践是生产镜像用一个特殊的 prefix 标识，比如 release-v1.0.0，其他的用 commit id 作为 tag。\n\n这里固定的规范，结合 CI 和自动化，选择适合团队的实践就可以了。","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1673575188,"ip_address":"广东","comment_id":366288,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"老师，您在日常工作中，镜像版本是如何定义的？有特殊的规范吗？","like_count":6,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":599511,"discussion_content":"我们的实践是生产镜像用一个特殊的 prefix 标识，比如 release-v1.0.0，其他的用 commit id 作为 tag。\n\n这里固定的规范，结合 CI 和自动化，选择适合团队的实践就可以了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1673575189,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":366315,"user_name":"农民园丁","can_delete":false,"product_type":"c1","uid":1155913,"ip_address":"内蒙古","ucode":"6A91EBBC9DCE6C","user_header":"https://static001.geekbang.org/account/avatar/00/11/a3/49/4a488f4c.jpg","comment_is_top":false,"comment_ctime":1673577786,"is_pvip":false,"replies":[{"id":133480,"content":"我的课程源码里构建了两个平台的镜像，你可以尝试删除.github&#47;workflows&#47;build.yaml 文件里定义的 platforms 字段，这样就只会构建单个平台的镜像了。","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1673581268,"ip_address":"广东","comment_id":366315,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"跟着老师的教程做了实验，发现生成了2个镜像，分别是linux&#47;amd64和linux&#47;arm64，这是怎么做到的？","like_count":2,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":599551,"discussion_content":"我的课程源码里构建了两个平台的镜像，你可以尝试删除.github/workflows/build.yaml 文件里定义的 platforms 字段，这样就只会构建单个平台的镜像了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1673581268,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":366306,"user_name":"jeffery","can_delete":false,"product_type":"c1","uid":1219972,"ip_address":"陕西","ucode":"35E2DAA386FB86","user_header":"https://static001.geekbang.org/account/avatar/00/12/9d/84/171b2221.jpg","comment_is_top":false,"comment_ctime":1673571448,"is_pvip":false,"replies":[{"id":133472,"content":"回答正确👍🏻\n\nUSERNAME 可以从 env 里读取，也可以配置 github secret 读取。\n\n在这个例子中我们是用 env 读的。","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1673575859,"ip_address":"广东","comment_id":366306,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"应该需要这个platforms: linux&#47;amd64,linux&#47;arm64。\n官网地址：https:&#47;&#47;docs.docker.com&#47;build&#47;ci&#47;github-actions&#47;examples&#47;#multi-platform-images\n不知道这块...\n        with:\n          username: ${{ secrets.DOCKERHUB_USERNAME }}\n          password: ${{ secrets.DOCKERHUB_TOKEN }}\n是不是写错了\nwith: \nusername: ${{ env.DOCKERHUB_USERNAME }} \npassword: ${{ secrets.DOCKERHUB_TOKEN }}\nname: ci\n\non:\n  push:\n    branches:\n      - &quot;main&quot;\n\njobs:\n  docker:\n    runs-on: ubuntu-latest\n    steps:\n      -\n        name: Checkout\n        uses: actions&#47;checkout@v3\n      -\n        name: Set up QEMU\n        uses: docker&#47;setup-qemu-action@v2\n      -\n        name: Set up Docker Buildx\n        uses: docker&#47;setup-buildx-action@v2\n      -\n        name: Login to Docker Hub\n        uses: docker&#47;login-action@v2\n        with:\n          username: ${{ secrets.DOCKERHUB_USERNAME }}\n          password: ${{ secrets.DOCKERHUB_TOKEN }}\n      -\n        name: Build and push\n        uses: docker&#47;build-push-action@v3\n        with:\n          context: .\n          platforms: linux&#47;amd64,linux&#47;arm64\n          push: true\n          tags: user&#47;app:latest\n","like_count":2,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":599523,"discussion_content":"回答正确👍🏻\n\nUSERNAME 可以从 env 里读取，也可以配置 github secret 读取。\n\n在这个例子中我们是用 env 读的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1673575859,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":369476,"user_name":"dva","can_delete":false,"product_type":"c1","uid":2101988,"ip_address":"广东","ucode":"EE27DAFCBF198D","user_header":"https://static001.geekbang.org/account/avatar/00/20/12/e4/57ade29a.jpg","comment_is_top":false,"comment_ctime":1677576249,"is_pvip":false,"replies":[{"id":134668,"content":"在阶段中输出 sha_short 变量，以便在后续阶段可以通过表达式 ${{ steps.vars.outputs.sha_short }} 来获取这个值。\n此外，你还可以用这个写法来在阶段中输出值：https:&#47;&#47;docs.github.com&#47;en&#47;actions&#47;using-jobs&#47;defining-outputs-for-jobs","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1677638492,"ip_address":"广东","comment_id":369476,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"老师你好，能详细解释一下这个语句是什么意思吗？双冒号是什么特殊写法？\nrun: echo &quot;::set-output name=sha_short::$(git rev-parse --short HEAD)&quot;","like_count":1,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":607138,"discussion_content":"在阶段中输出 sha_short 变量，以便在后续阶段可以通过表达式 ${{ steps.vars.outputs.sha_short }} 来获取这个值。\n此外，你还可以用这个写法来在阶段中输出值：https://docs.github.com/en/actions/using-jobs/defining-outputs-for-jobs","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1677638492,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1259323,"avatar":"https://static001.geekbang.org/account/avatar/00/13/37/3b/495e2ce6.jpg","nickname":"陈斯佳","note":"","ucode":"C236F874FC767A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":615848,"discussion_content":"这个写法在2023年6月1日之后就会被禁止了，详情参见https://github.blog/changelog/2022-10-11-github-actions-deprecating-save-state-and-set-output-commands/","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1682474142,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"加拿大","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":367956,"user_name":"gyl1989113","can_delete":false,"product_type":"c1","uid":1363213,"ip_address":"四川","ucode":"B7F2860B3FB101","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/cBh6rmNsSIbHEAGKiaq25yz9tqGuJEjbIYn2K0uFBLEe8lBNjL3SUOicibPbAO5SdH6TxV65kcCpK6FOB1hBr3PBQ/132","comment_is_top":false,"comment_ctime":1675764231,"is_pvip":false,"replies":[{"id":133986,"content":"是的。","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1675777401,"ip_address":"广东","comment_id":367956,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"@v2 @v3是啥意思呢。。插件版本嘛","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":602487,"discussion_content":"是的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1675777402,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":366390,"user_name":"奕","can_delete":false,"product_type":"c1","uid":1005391,"ip_address":"广东","ucode":"73CEA468CE70C3","user_header":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","comment_is_top":false,"comment_ctime":1673688888,"is_pvip":false,"replies":[{"id":133509,"content":"可以用 ${{ github.repositoryUrl }} 获取，另外所有可用的内置变量可以在这个文档里查询：https:&#47;&#47;docs.github.com&#47;en&#47;actions&#47;learn-github-actions&#47;contexts","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1673740632,"ip_address":"广东","comment_id":366390,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"怎么读取  默认的环境变量？ 使用 ${{env. GITHUB_REPOSITORY}} 读取不到","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":599718,"discussion_content":"可以用 ${{ github.repositoryUrl }} 获取，另外所有可用的内置变量可以在这个文档里查询：https://docs.github.com/en/actions/learn-github-actions/contexts","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1673740632,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":366292,"user_name":"无名无姓","can_delete":false,"product_type":"c1","uid":2621412,"ip_address":"北京","ucode":"487BD5AA2CD305","user_header":"https://static001.geekbang.org/account/avatar/00/27/ff/e4/927547a9.jpg","comment_is_top":false,"comment_ctime":1673568607,"is_pvip":false,"replies":[{"id":133469,"content":"Gitlab 自动构建在下一节课会介绍哦。","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1673575399,"ip_address":"广东","comment_id":366292,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"这个在gitlab上面可以使用么？","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":599517,"discussion_content":"Gitlab 自动构建在下一节课会介绍哦。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1673575399,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":366287,"user_name":"GAC·DU","can_delete":false,"product_type":"c1","uid":1385403,"ip_address":"北京","ucode":"7847FBE1C13740","user_header":"https://static001.geekbang.org/account/avatar/00/15/23/bb/a1a61f7c.jpg","comment_is_top":false,"comment_ctime":1673562776,"is_pvip":false,"replies":[{"id":133473,"content":"回答正确，两个镜像都配置了不同的平台👍🏻","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1673575905,"ip_address":"广东","comment_id":366287,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"\nname: build\n\non:\n  push:\n    branches:\n      - &#39;main&#39;\n\nenv:\n  DOCKERHUB_USERNAME: lyzhang1999\n\njobs:\n  docker:\n    runs-on: ubuntu-latest\n    steps:\n      - name: Checkout\n        uses: actions&#47;checkout@v3\n      - name: Set outputs\n        id: vars\n        run: echo &quot;::set-output name=sha_short::$(git rev-parse --short HEAD)&quot;\n      - name: Set up QEMU\n        uses: docker&#47;setup-qemu-action@v2\n      - name: Set up Docker Buildx\n        uses: docker&#47;setup-buildx-action@v2\n      - name: Login to Docker Hub\n        uses: docker&#47;login-action@v2\n        with:\n          username: ${{ env.DOCKERHUB_USERNAME }}\n          password: ${{ secrets.DOCKERHUB_TOKEN }}\n      - name: Build backend and push\n        uses: docker&#47;build-push-action@v3\n        with:\n          context: backend\n          platforms: linux&#47;amd64,linux&#47;arm64\n          push: true\n          tags: ${{ env.DOCKERHUB_USERNAME }}&#47;backend:${{ steps.vars.outputs.sha_short }}\n      - name: Build frontend and push\n        uses: docker&#47;build-push-action@v3\n        with:\n          context: frontend\n          platforms: linux&#47;amd64,linux&#47;arm64\n          push: true\n          tags: ${{ env.DOCKERHUB_USERNAME }}&#47;frontend:${{ steps.vars.outputs.sha_short }}","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":599524,"discussion_content":"回答正确，两个镜像都配置了不同的平台👍🏻","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1673575905,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":392808,"user_name":"。","can_delete":false,"product_type":"c1","uid":1796130,"ip_address":"广东","ucode":"AD9CD56391FB73","user_header":"https://static001.geekbang.org/account/avatar/00/1b/68/22/5762476a.jpg","comment_is_top":false,"comment_ctime":1721835843,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"老师你好，如果因为docker hub 国内无法访问的网络原因导致镜像拉不下来如何处理，报错如下：\nPulling binfmt Docker image\n  &#47;usr&#47;local&#47;bin&#47;docker pull docker.io&#47;tonistiigi&#47;binfmt:latest\n  latest: Pulling from tonistiigi&#47;binfmt\n  8d4d64c318a5: Pulling fs layer\n  e9c608ddc3cb: Pulling fs layer\n  e9c608ddc3cb: Downloading\n  e9c608ddc3cb: Retrying in 5 seconds\n  8d4d64c318a5: Retrying in 5 seconds\n  e9c608ddc3cb: Retrying in 4 seconds\n  8d4d64c318a5: Retrying in 4 seconds\n  e9c608ddc3cb: Retrying in 3 seconds\n  8d4d64c318a5: Retrying in 3 seconds\n  8d4d64c318a5: Retrying in 2 seconds\n  e9c608ddc3cb: Retrying in 2 seconds\n  e9c608ddc3cb: Retrying in 1 second\n  8d4d64c318a5: Retrying in 1 second\n  8d4d64c318a5: Retrying in 10 seconds\n  e9c608ddc3cb: Retrying in 10 seconds\n  8d4d64c318a5: Retrying in 9 seconds\n  e9c608ddc3cb: Retrying in 9 seconds\n  8d4d64c318a5: Retrying in 8 seconds\n  e9c608ddc3cb: Retrying in 8 seconds\n  8d4d64c318a5: Retrying in 7 seconds\n  e9c608ddc3cb: Retrying in 7 seconds\n  8d4d64c318a5: Retrying in 6 seconds\n  e9c608ddc3cb: Retrying in 6 seconds\n  8d4d64c318a5: Retrying in 5 seconds\n  e9c608ddc3cb: Retrying in 5 seconds\n  8d4d64c318a5: Retrying in 4 seconds\n  e9c608ddc3cb: Retrying in 4 seconds\n  8d4d64c318a5: Retrying in 3 seconds\n  e9c608ddc3cb: Retrying in 3 seconds\n  8d4d64c318a5: Retrying in 2 seconds\n  e9c608ddc3cb: Retrying in 2 seconds\n  8d4d64c318a5: Retrying in 1 second\n  e9c608ddc3cb: Retrying in 1 second\n  error pulling image configuration: download failed after attempts=6: net&#47;http: TLS handshake timeout","like_count":0},{"had_liked":false,"id":388549,"user_name":"哈尔","can_delete":false,"product_type":"c1","uid":1939451,"ip_address":"中国香港","ucode":"1D074B5FD74AC7","user_header":"https://static001.geekbang.org/account/avatar/00/1d/97/fb/9607bdda.jpg","comment_is_top":false,"comment_ctime":1710383679,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"name: build\n\non:\n  push:\n    branches:\n      - &#39;main&#39;\n\nenv:\n  DOCKERHUB_USERNAME: lyzhang1999\n\njobs:\n  docker:\n    runs-on: ubuntu-latest\n    steps:\n      - name: Checkout\n        uses: actions&#47;checkout@v3\n      - name: Set outputs\n        id: vars\n        run: echo &quot;::set-output name=sha_short::$(git rev-parse --short HEAD)&quot;\n      - name: Set up QEMU\n        uses: docker&#47;setup-qemu-action@v2\n      - name: Set up Docker Buildx\n        uses: docker&#47;setup-buildx-action@v2\n      - name: Login to Docker Hub\n        uses: docker&#47;login-action@v2\n        with:\n          username: ${{ env.DOCKERHUB_USERNAME }}\n          password: ${{ secrets.DOCKERHUB_TOKEN }}\n      - name: Build backend and push\n        uses: docker&#47;build-push-action@v3\n        with:\n          context: backend\n          platforms: linux&#47;amd64,linux&#47;arm64\n          push: true\n          tags: ${{ env.DOCKERHUB_USERNAME }}&#47;backend:${{ steps.vars.outputs.sha_short }}\n      - name: Build frontend and push\n        uses: docker&#47;build-push-action@v3\n        with:\n          context: frontend\n          platforms: linux&#47;amd64,linux&#47;arm64\n          push: true\n          tags: ${{ env.DOCKERHUB_USERNAME }}&#47;frontend:${{ steps.vars.outputs.sha_short }}","like_count":0},{"had_liked":false,"id":382518,"user_name":"BertGeek","can_delete":false,"product_type":"c1","uid":1452799,"ip_address":"陕西","ucode":"8E1D72C9F9778C","user_header":"https://static001.geekbang.org/account/avatar/00/16/2a/ff/a9d72102.jpg","comment_is_top":false,"comment_ctime":1697514618,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100312001,"comment_content":"github action 自动化就是方便，但构建镜像慢，小项目还好，\n大项目，仓库多，维护起来也费劲","like_count":0}]}