{"id":101706,"title":"12 | é«˜æ‰‹ç§˜è¯€ï¼šè¯†åˆ«Luaçš„ç‹¬æœ‰æ¦‚å¿µå’Œå‘","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯æ¸©é“­ã€‚</p><p>ä¸Šä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä¸€èµ·äº†è§£äº† LuaJIT ä¸­ table ç›¸å…³çš„åº“å‡½æ•°ã€‚é™¤äº†è¿™äº›å¸¸ç”¨çš„å‡½æ•°å¤–ï¼Œä»Šå¤©æˆ‘å†ä¸ºä½ ä»‹ç»ä¸€äº›Lua ç‹¬æœ‰çš„æˆ–ä¸å¤ªå¸¸ç”¨çš„æ¦‚å¿µï¼Œä»¥åŠ OpenResty ä¸­å¸¸è§çš„ Lua çš„å‘ã€‚</p><h2>å¼±è¡¨</h2><p>é¦–å…ˆæ˜¯ <code>å¼±è¡¨</code>ï¼ˆweak tableï¼‰ï¼Œå®ƒæ˜¯ Lua ä¸­å¾ˆç‹¬ç‰¹çš„ä¸€ä¸ªæ¦‚å¿µï¼Œå’Œåƒåœ¾å›æ”¶ç›¸å…³ã€‚å’Œå…¶ä»–é«˜çº§è¯­è¨€ä¸€æ ·ï¼ŒLua æ˜¯è‡ªåŠ¨åƒåœ¾å›æ”¶çš„ï¼Œä½ ä¸ç”¨å…³å¿ƒå…·ä½“çš„å®ç°ï¼Œä¹Ÿä¸ç”¨æ˜¾å¼ GCã€‚æ²¡æœ‰è¢«å¼•ç”¨åˆ°çš„ç©ºé—´ï¼Œä¼šè¢«åƒåœ¾æ”¶é›†å™¨è‡ªåŠ¨å®Œæˆå›æ”¶ã€‚</p><p>ä½†ç®€å•çš„å¼•ç”¨è®¡æ•°è¿˜ä¸å¤ªå¤Ÿç”¨ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦ä¸€ç§æ›´çµæ´»çš„æœºåˆ¶ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬æŠŠä¸€ä¸ª Lua çš„å¯¹è±¡ <code>Foo</code>ï¼ˆtable æˆ–è€…å‡½æ•°ï¼‰æ’å…¥åˆ° table <code>tb</code> ä¸­ï¼Œè¿™å°±ä¼šäº§ç”Ÿå¯¹è¿™ä¸ªå¯¹è±¡ <code>Foo</code> çš„å¼•ç”¨ã€‚å³ä½¿æ²¡æœ‰å…¶ä»–åœ°æ–¹å¼•ç”¨ <code>Foo</code>ï¼Œ<code>tb</code> å¯¹å®ƒçš„å¼•ç”¨ä¹Ÿè¿˜ä¸€ç›´å­˜åœ¨ï¼Œé‚£ä¹ˆ GC å°±æ²¡æœ‰åŠæ³•å›æ”¶ <code>Foo</code> æ‰€å ç”¨çš„å†…å­˜ã€‚è¿™æ—¶å€™ï¼Œæˆ‘ä»¬å°±åªæœ‰ä¸¤ç§é€‰æ‹©ï¼š</p><ul>\n<li>ä¸€æ˜¯æ‰‹å·¥é‡Šæ”¾ <code>Foo</code>ï¼›</li>\n<li>äºŒæ˜¯è®©å®ƒå¸¸é©»å†…å­˜ã€‚</li>\n</ul><p>æ¯”å¦‚ä¸‹é¢è¿™æ®µä»£ç ï¼š</p><pre><code>$ resty -e 'local tb = {}\ntb[1] = {red}\ntb[2] = function() print(&quot;func&quot;) end\nprint(#tb) -- 2\n\ncollectgarbage()\nprint(#tb) -- 2\n\ntable.remove(tb, 1)\nprint(#tb) -- 1\n</code></pre><p>ä¸è¿‡ï¼Œä½ è‚¯å®šä¸å¸Œæœ›ï¼Œå†…å­˜ä¸€ç›´è¢«ç”¨ä¸åˆ°çš„å¯¹è±¡å ç”¨ç€å§ï¼Œç‰¹åˆ«æ˜¯ LuaJIT ä¸­è¿˜æœ‰ 2G å†…å­˜çš„ä¸Šé™ã€‚è€Œæ‰‹å·¥é‡Šæ”¾çš„æ—¶æœºå¹¶ä¸å¥½æŠŠæ¡ï¼Œä¹Ÿä¼šå¢åŠ ä»£ç çš„å¤æ‚åº¦ã€‚</p><p>é‚£ä¹ˆè¿™æ—¶å€™ï¼Œå°±è½®åˆ°å¼±è¡¨æ¥å¤§æ˜¾èº«æ‰‹äº†ã€‚çœ‹å®ƒçš„åå­—ï¼Œå¼±è¡¨ï¼Œé¦–å…ˆå®ƒæ˜¯ä¸€ä¸ªè¡¨ï¼Œç„¶åè¿™ä¸ªè¡¨é‡Œé¢çš„æ‰€æœ‰å…ƒç´ éƒ½æ˜¯å¼±å¼•ç”¨ã€‚æ¦‚å¿µæ€»æ˜¯æŠ½è±¡çš„ï¼Œè®©æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€æ®µç¨åŠ ä¿®æ”¹åçš„ä»£ç ï¼š</p><!-- [[[read_end]]] --><pre><code>$ resty -e 'local tb = {}\ntb[1] = {red}\ntb[2] = function() print(&quot;func&quot;) end\nsetmetatable(tb, {__mode = &quot;v&quot;})\nprint(#tb)  -- 2\n\ncollectgarbage()\nprint(#tb) -- 0\n'\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œæ²¡æœ‰è¢«ä½¿ç”¨çš„å¯¹è±¡éƒ½è¢« GC äº†ã€‚è¿™å…¶ä¸­ï¼Œæœ€é‡è¦çš„å°±æ˜¯ä¸‹é¢è¿™ä¸€è¡Œä»£ç ï¼š</p><pre><code>setmetatable(tb, {__mode = &quot;v&quot;})\n</code></pre><p>æ˜¯ä¸æ˜¯ä¼¼æ›¾ç›¸è¯†ï¼Ÿè¿™ä¸å°±æ˜¯å…ƒè¡¨çš„æ“ä½œå—ï¼æ²¡é”™ï¼Œå½“ä¸€ä¸ª table çš„å…ƒè¡¨ä¸­å­˜åœ¨ <code>__mode</code> å­—æ®µæ—¶ï¼Œè¿™ä¸ª table å°±æ˜¯å¼±è¡¨ï¼ˆweak tableï¼‰äº†ã€‚</p><ul>\n<li>å¦‚æœ <code>__mode</code> çš„å€¼æ˜¯ <code>k</code>ï¼Œé‚£å°±æ„å‘³ç€è¿™ä¸ª table çš„ <code>é”®</code> æ˜¯å¼±å¼•ç”¨ã€‚</li>\n<li>å¦‚æœ <code>__mode</code> çš„å€¼æ˜¯ <code>v</code>ï¼Œé‚£å°±æ„å‘³ç€è¿™ä¸ª table çš„ <code>å€¼</code> æ˜¯å¼±å¼•ç”¨ã€‚</li>\n<li>å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥è®¾ç½®ä¸º <code>kv</code>ï¼Œè¡¨æ˜è¿™ä¸ªè¡¨çš„é”®å’Œå€¼éƒ½æ˜¯å¼±å¼•ç”¨ã€‚</li>\n</ul><p>è¿™ä¸‰è€…ä¸­çš„ä»»æ„ä¸€ç§å¼±è¡¨ï¼Œåªè¦å®ƒçš„ <code>é”®</code> æˆ–è€… <code>å€¼</code> è¢«å›æ”¶äº†ï¼Œé‚£ä¹ˆå¯¹åº”çš„<strong>æ•´ä¸ª</strong><code>é”®å€¼</code> å¯¹è±¡éƒ½ä¼šè¢«å›æ”¶ã€‚</p><p>åœ¨ä¸Šé¢çš„ä»£ç ç¤ºä¾‹ä¸­ï¼Œ<code>__mode</code> çš„å€¼ <code>v</code>ï¼Œè€Œ<code>tb</code> æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„çš„ <code>value</code> åˆ™æ˜¯ table å’Œå‡½æ•°å¯¹è±¡ï¼Œæ‰€ä»¥å¯ä»¥è¢«è‡ªåŠ¨å›æ”¶ã€‚ä¸è¿‡ï¼Œå¦‚æœä½ æŠŠ<code>__mode</code> çš„å€¼æ”¹ä¸º <code>k</code>ï¼Œå°±ä¸ä¼š GC äº†ï¼Œæ¯”å¦‚çœ‹ä¸‹é¢è¿™æ®µä»£ç ï¼š</p><pre><code>$ resty -e 'local tb = {}\ntb[1] = {red}\ntb[2] = function() print(&quot;func&quot;) end\nsetmetatable(tb, {__mode = &quot;k&quot;})\nprint(#tb)  -- 2\n\ncollectgarbage()\nprint(#tb) -- 2\n'\n</code></pre><p>è¯·æ³¨æ„ï¼Œè¿™é‡Œæˆ‘ä»¬åªæ¼”ç¤ºäº† <code>value</code> ä¸ºå¼±å¼•ç”¨çš„å¼±è¡¨ï¼Œä¹Ÿå°±æ˜¯æ•°ç»„ç±»å‹çš„å¼±è¡¨ã€‚è‡ªç„¶ï¼Œä½ åŒæ ·å¯ä»¥æŠŠå¯¹è±¡ä½œä¸º <code>key</code>ï¼Œæ¥æ„å»ºå“ˆå¸Œè¡¨ç±»å‹çš„å¼±è¡¨ï¼Œæ¯”å¦‚ä¸‹é¢è¿™æ ·å†™ï¼š</p><pre><code>$ resty -e 'local tb = {}\ntb[{color = red}] = &quot;red&quot;\nlocal fc = function() print(&quot;func&quot;) end\ntb[fc] = &quot;func&quot;\nfc = nil\n\nsetmetatable(tb, {__mode = &quot;k&quot;})\nfor k,v in pairs(tb) do\n     print(v)\nend\n\ncollectgarbage()\nprint(&quot;----------&quot;)\nfor k,v in pairs(tb) do\n     print(v)\nend\n'\n</code></pre><p>åœ¨æ‰‹åŠ¨è°ƒç”¨ <code>collectgarbage()</code> è¿›è¡Œå¼ºåˆ¶ GC åï¼Œ<code>tb</code> æ•´ä¸ª table é‡Œé¢çš„å…ƒç´ ï¼Œå°±å·²ç»å…¨éƒ¨è¢«å›æ”¶äº†ã€‚å½“ç„¶ï¼Œåœ¨å®é™…çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¤§å¯ä¸å¿…æ‰‹åŠ¨è°ƒç”¨ <code>collectgarbage()</code>ï¼Œå®ƒä¼šåœ¨åå°è‡ªåŠ¨è¿è¡Œï¼Œæ— é¡»æˆ‘ä»¬æ‹…å¿ƒã€‚</p><p>ä¸è¿‡ï¼Œæ—¢ç„¶æåˆ°äº† <code>collectgarbage()</code> è¿™ä¸ªå‡½æ•°ï¼Œæˆ‘å°±å†å¤šè¯´å‡ å¥ã€‚è¿™ä¸ªå‡½æ•°å…¶å®å¯ä»¥ä¼ å…¥å¤šä¸ªä¸åŒçš„é€‰é¡¹ï¼Œä¸”é»˜è®¤æ˜¯ <code>collect</code>ï¼Œå³å®Œæ•´çš„ GCã€‚å¦ä¸€ä¸ªæ¯”è¾ƒæœ‰ç”¨çš„æ˜¯ <code>count</code>ï¼Œå®ƒå¯ä»¥è¿”å› Lua å ç”¨çš„å†…å­˜ç©ºé—´å¤§å°ã€‚è¿™ä¸ªç»Ÿè®¡æ•°æ®å¾ˆæœ‰ç”¨ï¼Œå¯ä»¥è®©ä½ çœ‹å‡ºæ˜¯å¦å­˜åœ¨å†…å­˜æ³„æ¼ï¼Œä¹Ÿå¯ä»¥æé†’æˆ‘ä»¬ä¸è¦æ¥è¿‘ 2G çš„ä¸Šé™å€¼ã€‚</p><p>å¼±è¡¨ç›¸å…³çš„ä»£ç ï¼Œåœ¨å®é™…åº”ç”¨ä¸­ä¼šå†™å¾—æ¯”è¾ƒå¤æ‚ï¼Œä¸å¤ªå®¹æ˜“ç†è§£ï¼Œç›¸å¯¹åº”çš„ï¼Œä¹Ÿä¼šéšè—æ›´å¤šçš„ bugã€‚å…·ä½“æœ‰å“ªäº›å‘¢ï¼Ÿä¸å¿…ç€æ€¥ï¼Œåé¢å†…å®¹ï¼Œæˆ‘ä¼šä¸“é—¨ä»‹ç»ä¸€ä¸ªå¼€æºé¡¹ç›®ä¸­ï¼Œä½¿ç”¨å¼±è¡¨å¸¦æ¥çš„å†…å­˜æ³„æ¼é—®é¢˜ã€‚</p><h2>é—­åŒ…å’Œ upvalue</h2><p>å†æ¥çœ‹é—­åŒ…å’Œ upvalueã€‚å‰é¢æˆ‘å¼ºè°ƒè¿‡ï¼Œåœ¨ Lua ä¸­ï¼Œæ‰€æœ‰çš„å€¼éƒ½æ˜¯ä¸€ç­‰å…¬æ°‘ï¼ŒåŒ…å«å‡½æ•°ä¹Ÿæ˜¯ã€‚è¿™å°±æ„å‘³ç€å‡½æ•°å¯ä»¥ä¿å­˜åœ¨å˜é‡ä¸­ï¼Œå½“ä½œå‚æ•°ä¼ é€’ï¼Œä»¥åŠä½œä¸ºå¦ä¸€ä¸ªå‡½æ•°çš„è¿”å›å€¼ã€‚æ¯”å¦‚åœ¨ä¸Šé¢å¼±è¡¨ä¸­å‡ºç°çš„è¿™æ®µç¤ºä¾‹ä»£ç ï¼š</p><pre><code>tb[2] = function() print(&quot;func&quot;) end\n</code></pre><p>å…¶å®å°±æ˜¯æŠŠä¸€ä¸ªåŒ¿åå‡½æ•°ï¼Œä½œä¸º table çš„å€¼ç»™å­˜å‚¨äº†èµ·æ¥ã€‚</p><p>åœ¨ Lua ä¸­ï¼Œä¸‹é¢è¿™æ®µä»£ç ä¸­åŠ¨ä¸¤ä¸ªå‡½æ•°çš„å®šä¹‰æ˜¯å®Œå…¨ç­‰ä»·çš„ã€‚ä¸è¿‡æ³¨æ„ï¼Œåè€…æ˜¯æŠŠå‡½æ•°èµ‹å€¼ç»™ä¸€ä¸ªå˜é‡ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬ç»å¸¸ä¼šç”¨åˆ°çš„ä¸€ç§æ–¹å¼ï¼š</p><pre><code>local function foo() print(&quot;foo&quot;) end\nlocal foo = fuction() print(&quot;foo&quot;) end\n</code></pre><p>å¦å¤–ï¼ŒLua æ”¯æŒæŠŠä¸€ä¸ªå‡½æ•°å†™åœ¨å¦å¤–ä¸€ä¸ªå‡½æ•°é‡Œé¢ï¼Œå³åµŒå¥—å‡½æ•°ï¼Œæ¯”å¦‚ä¸‹é¢çš„ç¤ºä¾‹ä»£ç ï¼š</p><pre><code>$ resty -e '\nlocal function foo()\n     local i = 1\n     local function bar()\n         i = i + 1\n         print(i)\n     end\n     return bar\nend\n\nlocal fn = foo()\nprint(fn()) -- 2\n'\n</code></pre><p>ä½ å¯ä»¥çœ‹åˆ°ï¼Œ <code>bar</code> è¿™ä¸ªå‡½æ•°å¯ä»¥è¯»å–å‡½æ•° <code>foo</code> é‡Œé¢çš„å±€éƒ¨å˜é‡ <code>i</code>ï¼Œå¹¶ä¿®æ”¹å®ƒçš„å€¼ï¼Œå³ä½¿è¿™ä¸ªå˜é‡å¹¶ä¸åœ¨ <code>bar</code> é‡Œé¢å®šä¹‰ã€‚è¿™ä¸ªç‰¹æ€§å«åšè¯æ³•ä½œç”¨åŸŸï¼ˆlexical scopingï¼‰ã€‚</p><p>äº‹å®ä¸Šï¼ŒLua çš„è¿™äº›ç‰¹æ€§æ­£æ˜¯é—­åŒ…çš„åŸºç¡€ã€‚æ‰€è°“<code>é—­åŒ…</code> ï¼Œç®€å•åœ°ç†è§£ï¼Œå®ƒå…¶å®æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä¸è¿‡å®ƒè®¿é—®äº†å¦å¤–ä¸€ä¸ªå‡½æ•°è¯æ³•ä½œç”¨åŸŸä¸­çš„å˜é‡ã€‚</p><p>å¦‚æœæŒ‰ç…§é—­åŒ…çš„å®šä¹‰æ¥çœ‹ï¼ŒLua çš„æ‰€æœ‰å‡½æ•°å®é™…ä¸Šéƒ½æ˜¯é—­åŒ…ï¼Œå³ä½¿ä½ æ²¡æœ‰åµŒå¥—ã€‚è¿™æ˜¯å› ä¸º Lua ç¼–è¯‘å™¨ä¼šæŠŠ Lua è„šæœ¬å¤–é¢ï¼Œå†åŒ…è£…ä¸€å±‚ä¸»å‡½æ•°ã€‚æ¯”å¦‚ä¸‹é¢è¿™å‡ è¡Œç®€å•çš„ä»£ç æ®µï¼š</p><pre><code>local foo, bar\nlocal function fn()\n     foo = 1\n     bar = 2\nend\n</code></pre><p>åœ¨ç¼–è¯‘åï¼Œå°±ä¼šå˜ä¸ºä¸‹é¢çš„æ ·å­ï¼š</p><pre><code>function main(...)\n     local foo, bar\n     local function fn()\n         foo = 1\n         bar = 2\n     end\nend\n</code></pre><p>è€Œå‡½æ•° <code>fn</code> æ•è·äº†ä¸»å‡½æ•°çš„ä¸¤ä¸ªå±€éƒ¨å˜é‡ï¼Œå› æ­¤ä¹Ÿæ˜¯é—­åŒ…ã€‚</p><p>å½“ç„¶ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œå¾ˆå¤šè¯­è¨€ä¸­éƒ½æœ‰é—­åŒ…çš„æ¦‚å¿µï¼Œå®ƒå¹¶é Lua ç‹¬æœ‰ï¼Œä½ ä¹Ÿå¯ä»¥å¯¹æ¯”ç€æ¥åŠ æ·±ç†è§£ã€‚åªæœ‰ç†è§£äº†é—­åŒ…ï¼Œä½ æ‰èƒ½æ˜ç™½æˆ‘ä»¬æ¥ä¸‹æ¥è¦è®²çš„ upvalueã€‚</p><p>upvalue å°±æ˜¯ Lua ä¸­ç‹¬æœ‰çš„æ¦‚å¿µäº†ã€‚ä»å­—é¢æ„æ€æ¥çœ‹ï¼Œå¯ä»¥ç¿»è¯‘æˆ <code>ä¸Šé¢çš„å€¼</code>ã€‚å®é™…ä¸Šï¼Œupvalue å°±æ˜¯é—­åŒ…ä¸­æ•è·çš„è‡ªå·±è¯æ³•ä½œç”¨åŸŸå¤–çš„é‚£ä¸ªå˜é‡ã€‚è¿˜æ˜¯ç»§ç»­çœ‹ä¸Šé¢é‚£æ®µä»£ç ï¼š</p><pre><code>local foo, bar\nlocal function fn()\n     foo = 1\n     bar = 2\nend\n</code></pre><p>ä½ å¯ä»¥çœ‹åˆ°ï¼Œå‡½æ•° <code>fn</code> æ•è·äº†ä¸¤ä¸ªä¸åœ¨è‡ªå·±è¯æ³•ä½œç”¨åŸŸçš„å±€éƒ¨å˜é‡ <code>foo</code> å’Œ <code>bar</code>ï¼Œè€Œè¿™ä¸¤ä¸ªå˜é‡ï¼Œå®é™…ä¸Šå°±æ˜¯å‡½æ•° <code>fn</code> çš„ upvalueã€‚</p><h2>å¸¸è§çš„å‘</h2><p>ä»‹ç»äº† Lua ä¸­çš„å‡ ä¸ªæ¦‚å¿µåï¼Œæˆ‘å†æ¥è¯´è¯´ï¼Œåœ¨ OpenResty å¼€å‘ä¸­é‡åˆ°çš„é‚£äº›å’Œ Lua ç›¸å…³çš„å‘ã€‚</p><p>åœ¨å‰é¢å†…å®¹ä¸­ï¼Œæˆ‘ä»¬æåˆ°äº†ä¸€äº› Lua å’Œå…¶ä»–å¼€å‘è¯­è¨€ä¸åŒçš„ç‚¹ï¼Œæ¯”å¦‚ä¸‹æ ‡ä» 1 å¼€å§‹ã€é»˜è®¤å…¨å±€å˜é‡ç­‰ç­‰ã€‚åœ¨ OpenResty å®é™…çš„ä»£ç å¼€å‘ä¸­ï¼Œæˆ‘ä»¬è¿˜ä¼šé‡åˆ°æ›´å¤šå’Œ Luaã€ LuaJIT ç›¸å…³çš„é—®é¢˜ç‚¹ï¼Œ ä¸‹é¢æˆ‘ä¼šè®²å…¶ä¸­ä¸€äº›æ¯”è¾ƒå¸¸è§çš„ã€‚</p><p>è¿™é‡Œè¦å…ˆæé†’ä¸€ä¸‹ï¼Œå³ä½¿ä½ çŸ¥é“äº†æ‰€æœ‰çš„ <code>å‘</code>ï¼Œä½†ä¸å¯é¿å…çš„ï¼Œä¼°è®¡è¿˜æ˜¯è¦è‡ªå·±è¸©è¿‡ä¹‹åæ‰èƒ½å°è±¡æ·±åˆ»ã€‚å½“ç„¶ï¼Œä¸åŒçš„æ˜¯ï¼Œä½ èƒ½å¤Ÿæ›´å—åœ°ä»å‘é‡Œé¢çˆ¬å‡ºæ¥ï¼Œå¹¶æ‰¾åˆ°ç—‡ç»“æ‰€åœ¨ã€‚</p><h3>ä¸‹æ ‡ä» 0 å¼€å§‹è¿˜æ˜¯ä» 1 å¼€å§‹</h3><p>ç¬¬ä¸€ä¸ªå‘ï¼ŒLua çš„ä¸‹æ ‡æ˜¯ä» 1 å¼€å§‹çš„ï¼Œè¿™ç‚¹æˆ‘ä»¬ä¹‹å‰åå¤æåŠè¿‡ã€‚ä½†æˆ‘ä¸å¾—ä¸è¯´ï¼Œè¿™å¹¶éäº‹å®çš„å…¨éƒ¨ã€‚</p><p>å› ä¸ºåœ¨ LuaJIT ä¸­ï¼Œä½¿ç”¨ <code>ffi.new</code> åˆ›å»ºçš„æ•°ç»„ï¼Œä¸‹æ ‡åˆæ˜¯ä» 0 å¼€å§‹çš„:</p><pre><code>local buf = ffi_new(&quot;char[?]&quot;, 128)\n</code></pre><p>æ‰€ä»¥ï¼Œå¦‚æœä½ è¦è®¿é—®ä¸Šé¢è¿™æ®µä»£ç ä¸­ <code>buf</code> è¿™ä¸ª cdataï¼Œè¯·è®°å¾—ä¸‹æ ‡ä» 0 å¼€å§‹ï¼Œè€Œä¸æ˜¯ 1ã€‚åœ¨ä½¿ç”¨ FFI å’Œ C äº¤äº’çš„æ—¶å€™ï¼Œä¸€å®šè¦ç‰¹åˆ«æ³¨æ„è¿™ä¸ªåœ°æ–¹ã€‚</p><h3>æ­£åˆ™æ¨¡å¼åŒ¹é…</h3><p>ç¬¬äºŒä¸ªå‘ï¼Œæ­£åˆ™æ¨¡å¼åŒ¹é…é—®é¢˜ã€‚OpenResty ä¸­å¹¶è¡Œç€ä¸¤å¥—å­—ç¬¦ä¸²åŒ¹é…æ–¹æ³•ï¼šLua è‡ªå¸¦çš„ <code>sting</code> åº“ï¼Œä»¥åŠ OpenResty æä¾›çš„ <code>ngx.re.*</code> APIã€‚</p><p>å…¶ä¸­ï¼Œ Lua æ­£åˆ™æ¨¡å¼åŒ¹é…æ˜¯è‡ªå·±ç‹¬æœ‰çš„æ ¼å¼ï¼Œå’Œ PCRE çš„å†™æ³•ä¸åŒã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼š</p><pre><code>resty -e 'print(string.match(&quot;foo 123 bar&quot;, &quot;%d%d%d&quot;))'  â€” 123\n</code></pre><p>è¿™æ®µä»£ç ä»å­—ç¬¦ä¸²ä¸­æå–äº†æ•°å­—éƒ¨åˆ†ï¼Œä½ ä¼šå‘ç°ï¼Œå®ƒå’Œæˆ‘ä»¬çš„ç†Ÿæ‚‰çš„æ­£åˆ™è¡¨è¾¾å¼å®Œå…¨ä¸åŒã€‚Lua è‡ªå¸¦çš„æ­£åˆ™åŒ¹é…åº“ï¼Œä¸ä»…ä»£ç ç»´æŠ¤æˆæœ¬é«˜ï¼Œè€Œä¸”æ€§èƒ½ä½â€”â€”ä¸èƒ½è¢« JITï¼Œè€Œä¸”è¢«ç¼–è¯‘è¿‡ä¸€æ¬¡çš„æ¨¡å¼ä¹Ÿä¸ä¼šè¢«ç¼“å­˜ã€‚</p><p>æ‰€ä»¥ï¼Œåœ¨ä½ ä½¿ç”¨ Lua å†…ç½®çš„ string åº“å»åš findã€match ç­‰æ“ä½œæ—¶ï¼Œå¦‚æœæœ‰ç±»ä¼¼æ­£åˆ™è¿™æ ·çš„éœ€æ±‚ï¼Œä¸ç”¨çŠ¹è±«ï¼Œè¯·ç›´æ¥ä½¿ç”¨ OpenResty æä¾›çš„ <code>ngx.re</code> æ¥æ›¿ä»£ã€‚åªæœ‰åœ¨æŸ¥æ‰¾å›ºå®šå­—ç¬¦ä¸²çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ‰è€ƒè™‘ä½¿ç”¨ plain æ¨¡å¼æ¥è°ƒç”¨ string åº“ã€‚</p><p><strong>è¿™é‡Œæˆ‘æœ‰ä¸€ä¸ªå»ºè®®ï¼šåœ¨ OpenResty ä¸­ï¼Œæˆ‘ä»¬æ€»æ˜¯ä¼˜å…ˆä½¿ç”¨ OpenResty çš„ APIï¼Œç„¶åæ˜¯ LuaJIT çš„ APIï¼Œä½¿ç”¨ Lua åº“åˆ™éœ€è¦æ…ä¹‹åˆæ…</strong>ã€‚</p><h3>json ç¼–ç æ—¶æ— æ³•åŒºåˆ† array å’Œ dict</h3><p>ç¬¬ä¸‰ä¸ªå‘ï¼Œjson ç¼–ç æ—¶æ— æ³•åŒºåˆ† array å’Œ dictã€‚ç”±äº Lua ä¸­åªæœ‰ table è¿™ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œæ‰€ä»¥åœ¨ json å¯¹ç©º table ç¼–ç çš„æ—¶å€™ï¼Œè‡ªç„¶å°±æ— æ³•ç¡®å®šç¼–ç ä¸ºæ•°ç»„è¿˜æ˜¯å­—å…¸ï¼š</p><pre><code>resty -e 'local cjson = require &quot;cjson&quot;\nlocal t = {}\nprint(cjson.encode(t))\n'\n</code></pre><p>æ¯”å¦‚ä¸Šé¢è¿™æ®µä»£ç ï¼Œå®ƒçš„è¾“å‡ºæ˜¯ <code>{}</code>ï¼Œç”±æ­¤å¯è§ï¼Œ OpenResty çš„ cjson åº“ï¼Œé»˜è®¤æŠŠç©º table å½“åšå­—å…¸æ¥ç¼–ç ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>encode_empty_table_as_object</code> è¿™ä¸ªå‡½æ•°ï¼Œæ¥ä¿®æ”¹è¿™ä¸ªå…¨å±€çš„é»˜è®¤å€¼ï¼š</p><pre><code>resty -e 'local cjson = require &quot;cjson&quot;\ncjson.encode_empty_table_as_object(false)\nlocal t = {}\nprint(cjson.encode(t))\n'\n</code></pre><p>è¿™æ¬¡ï¼Œç©º table å°±è¢«ç¼–ç ä¸ºäº†æ•°ç»„ï¼š<code>[]</code>ã€‚</p><p>ä¸è¿‡ï¼Œå…¨å±€è¿™ç§è®¾ç½®çš„å½±å“é¢æ¯”è¾ƒå¤§ï¼Œé‚£èƒ½ä¸èƒ½æŒ‡å®šæŸä¸ª table çš„ç¼–ç è§„åˆ™å‘¢ï¼Ÿç­”æ¡ˆè‡ªç„¶æ˜¯å¯ä»¥çš„ï¼Œæˆ‘ä»¬æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥åšåˆ°ã€‚</p><p>ç¬¬ä¸€ç§æ–¹æ³•ï¼ŒæŠŠ <code>cjson.empty_array</code> è¿™ä¸ª userdata èµ‹å€¼ç»™æŒ‡å®š tableã€‚è¿™æ ·ï¼Œåœ¨ json ç¼–ç çš„æ—¶å€™ï¼Œå®ƒå°±ä¼šè¢«å½“åšç©ºæ•°ç»„æ¥å¤„ç†ï¼š</p><pre><code>$ resty -e 'local cjson = require &quot;cjson&quot;\nlocal t = cjson.empty_array\nprint(cjson.encode(t))\n'\n</code></pre><p>ä¸è¿‡ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬å¹¶ä¸ç¡®å®šï¼Œè¿™ä¸ªæŒ‡å®šçš„ table æ˜¯å¦ä¸€ç›´ä¸ºç©ºã€‚æˆ‘ä»¬å¸Œæœ›å½“å®ƒä¸ºç©ºçš„æ—¶å€™ç¼–ç ä¸ºæ•°ç»„ï¼Œé‚£ä¹ˆå°±è¦ç”¨åˆ° <code>cjson.empty_array_mt</code> è¿™ä¸ªå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„ç¬¬äºŒä¸ªæ–¹æ³•ã€‚</p><p>å®ƒä¼šæ ‡è®°å¥½æŒ‡å®šçš„ tableï¼Œå½“ table ä¸ºç©ºæ—¶ç¼–ç ä¸ºæ•°ç»„ã€‚ä»<code>cjson.empty_array_mt</code> è¿™ä¸ªå‘½åä½ ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œå®ƒæ˜¯é€šè¿‡ metatable çš„æ–¹å¼è¿›è¡Œè®¾ç½®çš„ï¼Œæ¯”å¦‚ä¸‹é¢è¿™æ®µä»£ç æ“ä½œï¼š</p><pre><code>$ resty -e 'local cjson = require &quot;cjson&quot;\nlocal t = {}\nsetmetatable(t, cjson.empty_array_mt)\nprint(cjson.encode(t))\nt = {123}\nprint(cjson.encode(t))\n'\n</code></pre><p>ä½ å¯ä»¥åœ¨æœ¬åœ°æ‰§è¡Œä¸€ä¸‹è¿™æ®µä»£ç ï¼Œçœ‹çœ‹è¾“å‡ºå’Œä½ é¢„æœŸçš„æ˜¯å¦ä¸€è‡´ã€‚</p><h3>å˜é‡çš„ä¸ªæ•°é™åˆ¶</h3><p>å†æ¥çœ‹ç¬¬å››ä¸ªå‘ï¼Œå˜é‡çš„ä¸ªæ•°é™åˆ¶é—®é¢˜ã€‚ Lua ä¸­ï¼Œä¸€ä¸ªå‡½æ•°çš„å±€éƒ¨å˜é‡çš„ä¸ªæ•°ï¼Œå’Œ upvalue çš„ä¸ªæ•°éƒ½æ˜¯æœ‰ä¸Šé™çš„ï¼Œä½ å¯ä»¥ä» Lua çš„æºç ä¸­å¾—åˆ°å°è¯ï¼š</p><pre><code>\n/*\n@@ LUAI_MAXVARS is the maximum number of local variables per function\n@* (must be smaller than 250).\n*/\n#define LUAI_MAXVARS            200\n\n\n/*\n@@ LUAI_MAXUPVALUES is the maximum number of upvalues per function\n@* (must be smaller than 250).\n*/\n#define LUAI_MAXUPVALUES        60\n</code></pre><p>è¿™ä¸¤ä¸ªé˜ˆå€¼ï¼Œåˆ†åˆ«è¢«ç¡¬ç¼–ç ä¸º 200 å’Œ 60ã€‚è™½è¯´ä½ å¯ä»¥æ‰‹åŠ¨ä¿®æ”¹æºç æ¥è°ƒæ•´è¿™ä¸¤ä¸ªå€¼ï¼Œä¸è¿‡æœ€å¤§ä¹Ÿåªèƒ½è®¾ç½®ä¸º 250ã€‚</p><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸ä¼šè¶…è¿‡è¿™ä¸ªé˜ˆå€¼ï¼Œä½†å†™ OpenResty ä»£ç çš„æ—¶å€™ï¼Œä½ è¿˜æ˜¯è¦ç•™æ„è¿™ä¸ªäº‹æƒ…ï¼Œä¸è¦è¿‡å¤šåœ°ä½¿ç”¨å±€éƒ¨å˜é‡å’Œ upvalueï¼Œè€Œæ˜¯è¦å°½å¯èƒ½åœ°ä½¿ç”¨ <code>do .. end</code> åšä¸€å±‚å°è£…ï¼Œæ¥å‡å°‘å±€éƒ¨å˜é‡å’Œ upvalue çš„ä¸ªæ•°ã€‚</p><p>æ¯”å¦‚æˆ‘ä»¬æ¥çœ‹ä¸‹é¢è¿™æ®µä¼ªç ï¼š</p><pre><code>local re_find = ngx.re.find\n  function foo() ... end\nfunction bar() ... end\nfunction fn() ... end\n</code></pre><p>å¦‚æœåªæœ‰å‡½æ•° <code>foo</code> ä½¿ç”¨åˆ°äº† <code>re_find</code>ï¼Œ é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è¿™æ ·æ”¹é€ ä¸‹ï¼š</p><pre><code>do\n     local re_find = ngx.re.find\n     function foo() ... end\nend\nfunction bar() ... end\nfunction fn() ... end\n</code></pre><p>è¿™æ ·ä¸€æ¥ï¼Œåœ¨ <code>main</code> å‡½æ•°çš„å±‚é¢ä¸Šï¼Œå°±å°‘äº† <code>re_find</code> è¿™ä¸ªå±€éƒ¨å˜é‡ã€‚è¿™åœ¨å•ä¸ªçš„å¤§çš„ Lua æ–‡ä»¶ä¸­ï¼Œç®—æ˜¯ä¸€ä¸ªä¼˜åŒ–æŠ€å·§ã€‚</p><h2>å†™åœ¨æœ€å</h2><p>ä»â€œå¤šé—®å‡ ä¸ªä¸ºä»€ä¹ˆâ€çš„è§’åº¦å‡ºå‘ï¼ŒLua ä¸­ 250 è¿™ä¸ªé˜ˆå€¼æ˜¯ä»ä½•è€Œæ¥çš„å‘¢ï¼Ÿè¿™ç®—æ˜¯æˆ‘ä»¬ä»Šå¤©çš„æ€è€ƒé¢˜ï¼Œæ¬¢è¿ä½ ç•™è¨€è¯´ä¸‹ä½ çš„çœ‹æ³•ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™ç¯‡æ–‡ç« åˆ†äº«ç»™ä½ çš„åŒäº‹ã€æœ‹å‹ï¼Œæˆ‘ä»¬ä¸€èµ·äº¤æµï¼Œä¸€èµ·è¿›æ­¥ã€‚</p>","neighbors":{"left":{"article_title":"11 | å‰–æLuaå”¯ä¸€çš„æ•°æ®ç»“æ„tableå’Œmetatableç‰¹æ€§","id":101086},"right":{"article_title":"13 | [è§†é¢‘]å®æˆ˜ï¼šåŸºäºFFIå®ç°çš„lua-resty-lrucache","id":101890}},"comments":[{"had_liked":false,"id":109298,"user_name":"ç‡•ç¾½é˜³","can_delete":false,"product_type":"c1","uid":1015063,"ip_address":"","ucode":"AF9430187F66EE","user_header":"https://static001.geekbang.org/account/avatar/00/0f/7d/17/179b24f4.jpg","comment_is_top":false,"comment_ctime":1561994462,"is_pvip":false,"replies":[{"id":"39754","content":"ğŸ‘ è¿™äº›è®¾è®¡åˆ° Lua è™šæ‹ŸæœºæŒ‡ä»¤ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦æ¨èçœ‹çœ‹å¼ ç§€å®è€å¸ˆå†™çš„ã€Šè‡ªå·±åŠ¨æ‰‹å®ç°Luaï¼šè™šæ‹Ÿæœºã€ç¼–è¯‘å™¨å’Œæ ‡å‡†åº“ã€‹","user_name":"ä½œè€…å›å¤","comment_id":109298,"uid":"1017955","ip_address":"","utype":1,"ctime":1562114207,"user_name_real":"æ¸©é“­@OpenResty"}],"discussion_count":1,"race_medal":0,"score":"44511667422","product_id":100028301,"comment_content":"luaæŒ‡ä»¤æ˜¯32ä½ï¼Œå…¶ä¸­6ä½ä½œä¸ºæ“ä½œç ï¼Œ8ä½ä½œä¸ºæœ¬åœ°å˜é‡å’Œupvalueå¯»å€ï¼ˆå³256ä¸ªï¼‰ã€‚ç±»ä¼¼çš„é™åˆ¶è¿˜æœ‰å‡½æ•°ä¸­åªèƒ½å®šä¹‰262144ä¸ªå¸¸é‡ï¼ˆ2^18ï¼‰","like_count":11,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":456342,"discussion_content":"ğŸ‘ è¿™äº›è®¾è®¡åˆ° Lua è™šæ‹ŸæœºæŒ‡ä»¤ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦æ¨èçœ‹çœ‹å¼ ç§€å®è€å¸ˆå†™çš„ã€Šè‡ªå·±åŠ¨æ‰‹å®ç°Luaï¼šè™šæ‹Ÿæœºã€ç¼–è¯‘å™¨å’Œæ ‡å‡†åº“ã€‹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562114207,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":107386,"user_name":"HelloBug","can_delete":false,"product_type":"c1","uid":1249598,"ip_address":"","ucode":"E61A4AD5C2F724","user_header":"https://static001.geekbang.org/account/avatar/00/13/11/3e/925aa996.jpg","comment_is_top":false,"comment_ctime":1561525346,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"10151459938","product_id":100028301,"comment_content":"ä¸ºä»€ä¹ˆtableçš„ä¸‹æ ‡æ˜¯æ•°å­—æ—¶ï¼Œè®¾ç½®å¼±è¡¨å±æ€§æ˜¯keyï¼Œä¸ä¼šå¯¹å…¶è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œè€Œæ˜¯tableå’Œfunctionæ—¶ä¼šå¯¹å…¶è¿›è¡Œåƒåœ¾å›æ”¶ï¼Ÿ","like_count":2},{"had_liked":false,"id":107385,"user_name":"HelloBug","can_delete":false,"product_type":"c1","uid":1249598,"ip_address":"","ucode":"E61A4AD5C2F724","user_header":"https://static001.geekbang.org/account/avatar/00/13/11/3e/925aa996.jpg","comment_is_top":false,"comment_ctime":1561525339,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"10151459931","product_id":100028301,"comment_content":"å¼€ç¯‡è®²è§£å¼±è¡¨çš„ä¾‹å­ä¸­ï¼Œå¦‚æœtableä¸­æœ‰å¯¹Fooçš„å¼•ç”¨ï¼Œä¸æ˜¯è¯´æ˜Fooå ç”¨çš„å†…å­˜æ˜¯æœ‰ç”¨çš„å—ï¼Ÿä¸ºä»€ä¹ˆè¦é‡Šæ”¾Fooå ç”¨çš„å†…å­˜ï¼Ÿä»€ä¹ˆæ—¶å€™ä¼šå¯¹å…¶è¿›è¡Œäº†å¼•ç”¨ï¼Œåå€’å¸Œæœ›è®¾ç½®å¼±è¡¨å±æ€§ï¼Œå¸Œæœ›GCå¯¹å…¶è¿›è¡Œåƒåœ¾å›æ”¶å‘¢ï¼Ÿ","like_count":2},{"had_liked":false,"id":201734,"user_name":"Joshua","can_delete":false,"product_type":"c1","uid":1348231,"ip_address":"","ucode":"6823D5F0EC5D10","user_header":"https://static001.geekbang.org/account/avatar/00/14/92/87/15931e41.jpg","comment_is_top":false,"comment_ctime":1585827897,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1585827897","product_id":100028301,"comment_content":"è€å¸ˆã€‚æœ‰ä¸ªé—®é¢˜ï¼Œæ—¢ç„¶ä¼˜å…ˆä½¿ç”¨ OpenResty çš„ APIï¼Œæ–‡ä¸­æåˆ°<br>â€åœ¨æŸ¥æ‰¾å›ºå®šå­—ç¬¦ä¸²çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ‰è€ƒè™‘ä½¿ç”¨ plain æ¨¡å¼æ¥è°ƒç”¨ string åº“â€œ<br>è¿™ç§æ—¶å€™ä¸ºä»€ä¹ˆè¿˜è¦è€ƒè™‘ä½¿ç”¨ plain æ¨¡å¼æ¥è°ƒç”¨ string åº“å‘¢ï¼Œä¹Ÿç›´æ¥ä½¿ç”¨ngx.re.findä¸å°±å¯ä»¥äº†ï¼Œåæ­£æˆ‘ä»¬ä¼˜å…ˆä½¿ç”¨ OpenResty çš„ API","like_count":1},{"had_liked":false,"id":175661,"user_name":"å®ä»”","can_delete":false,"product_type":"c1","uid":1013493,"ip_address":"","ucode":"A0F17DFF99DB21","user_header":"https://static001.geekbang.org/account/avatar/00/0f/76/f5/e3f5bd8d.jpg","comment_is_top":false,"comment_ctime":1580794190,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1580794190","product_id":100028301,"comment_content":"è€å¸ˆï¼Œæˆ‘é€šè¿‡resty -e å»æµ‹è¯•çš„æ—¶å€™å‘ç°upvalueæ˜¯æœ‰60çš„é™åˆ¶ï¼Œä½†æ˜¯æˆ‘ç”¨ç›¸åŒçš„ä»£ç é€šè¿‡lua test.luaè¿™ç§è¿è¡Œæ–¹å¼å»æµ‹è¯•ï¼Œå‘ç°upvalueæ²¡æœ‰60é™åˆ¶ï¼Œå‡½æ•°å†…éƒ¨çš„å±€éƒ¨å˜é‡ä¸¤ç§è¿è¡Œæ–¹å¼åˆ°æ˜¯éƒ½æœ‰200é™åˆ¶çš„ã€‚<br>luaç¯å¢ƒå¦‚ä¸‹ï¼š<br>$ lua -v<br>Lua 5.2.4  Copyright (C) 1994-2015 Lua.org, PUC-Rio<br>openrestyç¯å¢ƒå¦‚ä¸‹ï¼š<br>$ resty -v<br>resty 0.23<br>nginx version: openresty&#47;1.15.8.1<br>built by clang 10.0.0 (clang-1000.10.44.4)<br>built with OpenSSL 1.1.0j  20 Nov 2018<br>è¿™æ˜¯å› ä¸ºluajitå’Œluaçš„åŸå› å—","like_count":0},{"had_liked":false,"id":122267,"user_name":"fjpcode","can_delete":false,"product_type":"c1","uid":1306092,"ip_address":"","ucode":"C32C5E3ECB9A90","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJ61zTDmLk7IhLJn6seBPOwsVaKIWUWaxk5YmsdYBZUOYMQCsyl9iaQVSg9U5qJVLLOCFUoLUuYnRA/132","comment_is_top":false,"comment_ctime":1565327490,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1565327490","product_id":100028301,"comment_content":"æ—¢ç„¶å‡½æ•°æ˜¯ä¸€ç­‰å…¬æ°‘ï¼Œå’Œå˜é‡ä¸€æ ·ï¼Œé‚£ä¹ˆåœ¨ä¸€ä¸ªå‡½æ•°ä¸­è°ƒç”¨å¦ä¸€ä¸ªå‡½æ•°æ˜¯å¦ä¹Ÿå±äºé—­åŒ…çš„èŒƒç•´ã€‚å…¨å±€å˜é‡æ˜¯å¦ä¹Ÿå±äºupvalueã€‚","like_count":0},{"had_liked":false,"id":112758,"user_name":"è‹±é›„","can_delete":false,"product_type":"c1","uid":1546612,"ip_address":"","ucode":"D1033C83C6CDE9","user_header":"https://static001.geekbang.org/account/avatar/00/17/99/74/0203bf17.jpg","comment_is_top":false,"comment_ctime":1562817096,"is_pvip":false,"replies":[{"id":"41175","content":"è¿™æ˜¯æŠŠ cjson è¿™ä¸ªæ¨¡å—çš„ empty_array å‡½æ•°ï¼Œèµ‹å€¼ç»™äº† t è¿™ä¸ªå˜é‡ã€‚åœ¨ Lua ä¸­å‡½æ•°æ˜¯ä¸€ç­‰å…¬æ°‘ï¼Œå¯ä»¥åƒå˜é‡ä¸€æ ·ä½¿ç”¨","user_name":"ä½œè€…å›å¤","comment_id":112758,"uid":"1017955","ip_address":"","utype":1,"ctime":1562904546,"user_name_real":"æ¸©é“­@OpenResty"}],"discussion_count":1,"race_medal":0,"score":"1562817096","product_id":100028301,"comment_content":"local t = cjson.empty_array<br>è¿™è¡Œä»£ç æ²¡çœ‹æ‡‚","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457898,"discussion_content":"è¿™æ˜¯æŠŠ cjson è¿™ä¸ªæ¨¡å—çš„ empty_array å‡½æ•°ï¼Œèµ‹å€¼ç»™äº† t è¿™ä¸ªå˜é‡ã€‚åœ¨ Lua ä¸­å‡½æ•°æ˜¯ä¸€ç­‰å…¬æ°‘ï¼Œå¯ä»¥åƒå˜é‡ä¸€æ ·ä½¿ç”¨","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562904546,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":112011,"user_name":"LeonğŸ“·","can_delete":false,"product_type":"c1","uid":1219496,"ip_address":"","ucode":"B9BBD1EFAAE5A2","user_header":"https://static001.geekbang.org/account/avatar/00/12/9b/a8/6a391c66.jpg","comment_is_top":false,"comment_ctime":1562653410,"is_pvip":false,"replies":[{"id":"40856","content":"èƒ½å¦è´´ä¸‹å…·ä½“çš„ä»£ç ï¼Ÿç»™ä¸ª github çš„ gist åœ°å€å°±è¡Œ","user_name":"ä½œè€…å›å¤","comment_id":112011,"uid":"1017955","ip_address":"","utype":1,"ctime":1562723108,"user_name_real":"æ¸©é“­@OpenResty"}],"discussion_count":1,"race_medal":0,"score":"1562653410","product_id":100028301,"comment_content":"coroutine 0:<br>  &#47;usr&#47;local&#47;openresty&#47;nginx&#47;lua&#47;hello.lua: in main chunk, client: 127.0.0.1, server: localhost, request: &quot;GET &#47;lua HTTP&#47;1.1&quot;, host: &quot;localhost&quot;<br>2019&#47;07&#47;09 14:21:09 [error] 854136#854136: *16 lua entry thread aborted: runtime error: &#47;usr&#47;local&#47;openresty&#47;nginx&#47;lua&#47;hello.lua:17: attempt to index global &#39;cjson&#39; (a nil v<br>stack traceback,è€å¸ˆï¼Œè¿™ä¸ªæ˜¯æ€ä¹ˆå›äº‹","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457540,"discussion_content":"èƒ½å¦è´´ä¸‹å…·ä½“çš„ä»£ç ï¼Ÿç»™ä¸ª github çš„ gist åœ°å€å°±è¡Œ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562723108,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":109658,"user_name":"å°é£å“¥ â€è¶…ç´šæœƒå“¡","can_delete":false,"product_type":"c1","uid":1110049,"ip_address":"","ucode":"417F9563B3005B","user_header":"https://static001.geekbang.org/account/avatar/00/10/f0/21/104b9565.jpg","comment_is_top":false,"comment_ctime":1562072701,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1562072701","product_id":100028301,"comment_content":"ä¸Šé¢æœ‰ä¸ªä¾‹å­ï¼Œ å‘ç°æ˜¯æœ‰ä¸¤ä¸ªç»“æœçš„ï¼Œ ä¸€ä¸ªæ˜¯2ï¼Œ å¦ä¸€ä¸ªç»“æœæ˜¯ç©ºï¼Œ è€Œä¾‹å­åªåˆ—å‡ºä¸€ä¸ªç»“æœï¼Œ è€Œ ç¬¬ä¸€ä¸ªprint æ‰æ˜¯2ï¼Œ ç¬¬äºŒä¸ªprint æ˜¯ç©ºã€‚<br><br>localhost: ~&#47;geektime&#47;lua $ resty -e &#39;<br>&gt; local function foo()<br>&gt;      local i = 1<br>&gt;      local function bar()<br>&gt;          i = i + 1<br>&gt;          print(i)<br>&gt;      end<br>&gt;      return bar<br>&gt; end<br>&gt; local fn = foo()<br>&gt; print(fn())<br>&gt; &#39;<br>2<br>","like_count":0},{"had_liked":false,"id":107387,"user_name":"HelloBug","can_delete":false,"product_type":"c1","uid":1249598,"ip_address":"","ucode":"E61A4AD5C2F724","user_header":"https://static001.geekbang.org/account/avatar/00/13/11/3e/925aa996.jpg","comment_is_top":false,"comment_ctime":1561525353,"is_pvip":true,"replies":[{"id":"38894","content":"å¤šè°¢åé¦ˆï¼Œå·²ç»ä¿®æ”¹ï¼šï¼‰","user_name":"ä½œè€…å›å¤","comment_id":107387,"uid":"1017955","ip_address":"","utype":1,"ctime":1561550058,"user_name_real":"æ¸©é“­@OpenResty"}],"discussion_count":1,"race_medal":0,"score":"1561525353","product_id":100028301,"comment_content":"è€å¸ˆï¼Œtypoï¼šâ€å³ä½¿è¿™ä¸ªå˜é‡å¹¶ä¸åœ¨ foo é‡Œé¢å®šä¹‰â€œï¼Œåº”è¯¥æ˜¯â€å³ä½¿è¿™ä¸ªå˜é‡å¹¶ä¸åœ¨ bar é‡Œé¢å®šä¹‰â€œ~~","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":455494,"discussion_content":"å¤šè°¢åé¦ˆï¼Œå·²ç»ä¿®æ”¹ï¼šï¼‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561550058,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":106801,"user_name":"soooldier","can_delete":false,"product_type":"c1","uid":1000746,"ip_address":"","ucode":"04EC4C01DD06FD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/45/2a/c4413de4.jpg","comment_is_top":false,"comment_ctime":1561387619,"is_pvip":false,"replies":[{"id":"38909","content":"å¯ä»¥çœ‹ Lua ä½œè€…å†™çš„é‚£æœ¬ä¹¦ï¼Œå°±æ˜¯ã€ŠLua ç¨‹åºè®¾è®¡ã€‹ï¼Œé‡Œé¢ä¸“é—¨æœ‰è®² weak table","user_name":"ä½œè€…å›å¤","comment_id":106801,"uid":"1017955","ip_address":"","utype":1,"ctime":1561551552,"user_name_real":"æ¸©é“­@OpenResty"}],"discussion_count":1,"race_medal":0,"score":"1561387619","product_id":100028301,"comment_content":"çœ‹å®Œåå¯¹week tableè¿˜æ˜¯å®Œå…¨æ‡µçš„ï¼Œæœ‰æ²¡æœ‰æ›´æµ…æ˜¾æ˜“æ‡‚çš„æ–‡ç« å‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":455228,"discussion_content":"å¯ä»¥çœ‹ Lua ä½œè€…å†™çš„é‚£æœ¬ä¹¦ï¼Œå°±æ˜¯ã€ŠLua ç¨‹åºè®¾è®¡ã€‹ï¼Œé‡Œé¢ä¸“é—¨æœ‰è®² weak table","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561551552,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":106210,"user_name":"å°é£å“¥ â€è¶…ç´šæœƒå“¡","can_delete":false,"product_type":"c1","uid":1110049,"ip_address":"","ucode":"417F9563B3005B","user_header":"https://static001.geekbang.org/account/avatar/00/10/f0/21/104b9565.jpg","comment_is_top":false,"comment_ctime":1561207578,"is_pvip":false,"replies":[{"id":"38907","content":"æ˜¯çš„ï¼Œé™¤éä½ åœ¨ do end ä¹‹å‰é¢„å®šä¹‰äº†ä¸€ä¸ªå˜é‡ï¼Œæ¯”å¦‚ï¼š<br>local f<br>do <br>function f()<br>...<br>end<br><br>end -- do","user_name":"ä½œè€…å›å¤","comment_id":106210,"uid":"1017955","ip_address":"","utype":1,"ctime":1561551435,"user_name_real":"æ¸©é“­@OpenResty"}],"discussion_count":1,"race_medal":0,"score":"1561207578","product_id":100028301,"comment_content":"å†™åœ¨æœ€åçš„do end æ˜¯ä¸æ˜¯è¡¨ç¤ºä»£ç å—çš„æ„æ€ï¼Ÿ<br>do  endå°è£…åæ˜¯ä¸æ˜¯å…¶å®ƒfunctionæ˜¯æ— æ³•è®¿é—®çš„ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":455002,"discussion_content":"æ˜¯çš„ï¼Œé™¤éä½ åœ¨ do end ä¹‹å‰é¢„å®šä¹‰äº†ä¸€ä¸ªå˜é‡ï¼Œæ¯”å¦‚ï¼š\nlocal f\ndo \nfunction f()\n...\nend\n\nend -- do","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561551435,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":106061,"user_name":"ä¸€æ­¥","can_delete":false,"product_type":"c1","uid":1005391,"ip_address":"","ucode":"73CEA468CE70C3","user_header":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","comment_is_top":false,"comment_ctime":1561162208,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1561162208","product_id":100028301,"comment_content":"local cjson = require(&#39;cjson&#39;)<br>local tb1 = {}<br>setmetatable(tb1, cjson.empty_array_mt)<br>print(cjson.encode(tb1))<br>tb1[&#39;key&#39;] = &#39;11&#39;<br>print(cjson.encode(tb1))<br><br>è€å¸ˆè¿™æ ·å†™ä¹‹åæ‰“å°å‡ºæ¥ 4ä¸ª [] ç©ºæ•°ç»„ï¼Œæœ€åé‚£ä¸ªé‚£ä¸ªä¸æ˜¯èµ‹å€¼äº†å—ï¼Ÿ ä¸ºä»€ä¹ˆè¿˜æ˜¯ç©ºæ•°ç»„å‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1142524,"avatar":"https://static001.geekbang.org/account/avatar/00/11/6e/fc/b25150d7.jpg","nickname":"jawe","note":"","ucode":"6DB8BF50767629","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":413389,"discussion_content":"empty_array_mt åªèƒ½ç”¨äºæ•°ç»„è¡¨","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1636461870,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":106018,"user_name":"ç½å¤´ç“¶å­","can_delete":false,"product_type":"c1","uid":1283945,"ip_address":"","ucode":"B14CAA526AB01A","user_header":"https://static001.geekbang.org/account/avatar/00/13/97/69/80945634.jpg","comment_is_top":false,"comment_ctime":1561128613,"is_pvip":false,"replies":[{"id":"38904","content":"å…¶å®ä¸Šé™æ˜¯ 256ï¼Œ è¿™ä¸ªæ˜¯ Lua è™šæ‹Ÿæœºçš„æŒ‡ä»¤å ç”¨çš„å¤§å°å†³å®šçš„ã€‚è¶…è¿‡ 256 çš„è¯ï¼ŒLua è™šæ‹Ÿæœºå°±ä¸æ”¯æŒäº†ã€‚","user_name":"ä½œè€…å›å¤","comment_id":106018,"uid":"1017955","ip_address":"","utype":1,"ctime":1561551168,"user_name_real":"æ¸©é“­@OpenResty"}],"discussion_count":1,"race_medal":0,"score":"1561128613","product_id":100028301,"comment_content":"upvalue ä¸Šçº¿250è¿™ä¸ªæ˜¯è€ƒè™‘åˆ°å˜é‡æŸ¥æ‰¾æ•ˆç‡çš„é—®é¢˜ï¼Ÿå¦‚æœlocalå˜é‡è¿‡å¤šå¯ä»¥æ”¾åœ¨tableé‡Œé¢åŠ å¿«æŸ¥æ‰¾æ•ˆç‡ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":454918,"discussion_content":"å…¶å®ä¸Šé™æ˜¯ 256ï¼Œ è¿™ä¸ªæ˜¯ Lua è™šæ‹Ÿæœºçš„æŒ‡ä»¤å ç”¨çš„å¤§å°å†³å®šçš„ã€‚è¶…è¿‡ 256 çš„è¯ï¼ŒLua è™šæ‹Ÿæœºå°±ä¸æ”¯æŒäº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561551168,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":105824,"user_name":"helloworld","can_delete":false,"product_type":"c1","uid":1105161,"ip_address":"","ucode":"1EECCA0F43E278","user_header":"https://static001.geekbang.org/account/avatar/00/10/dd/09/feca820a.jpg","comment_is_top":false,"comment_ctime":1561088655,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1561088655","product_id":100028301,"comment_content":"è€å¸ˆï¼Œæˆ‘è¿™ä¹ˆç†è§£å¯¹ä¸å¯¹ï¼š<br>OpenRestyçš„APIåŒ…æ‹¬Nginx APIå’ŒLuaJIT APIï¼ŒNginx APIä¸»è¦æ˜¯lua-nginx-moduleç­‰*-nginx-module Cæ¨¡å—æä¾›çš„APIï¼Œè€ŒLuaJIT APIä¸»è¦æ˜¯lua-resty-*å„ç§Luaåº“æ‰€æä¾›çš„API","like_count":0},{"had_liked":false,"id":105786,"user_name":"helloworld","can_delete":false,"product_type":"c1","uid":1105161,"ip_address":"","ucode":"1EECCA0F43E278","user_header":"https://static001.geekbang.org/account/avatar/00/10/dd/09/feca820a.jpg","comment_is_top":false,"comment_ctime":1561083913,"is_pvip":false,"replies":[{"id":"38901","content":"OpenResty çš„ API æŒ‡çš„æ˜¯lua-nginx-moduleå’Œlua-resty-coreæä¾›çš„æ¥å£ï¼Œéƒ½æ˜¯ `ngx` æ¥å¤´çš„ï¼›LuaJIT çš„ API æ˜¯æ‰©å±•äº† Lua å†…ç½®çš„åº“ï¼Œæ¯”å¦‚ `table.new` è¿™ç§","user_name":"ä½œè€…å›å¤","comment_id":105786,"uid":"1017955","ip_address":"","utype":1,"ctime":1561551050,"user_name_real":"æ¸©é“­@OpenResty"}],"discussion_count":2,"race_medal":0,"score":"1561083913","product_id":100028301,"comment_content":"è€å¸ˆï¼Œæ–‡ä¸­æåˆ°çš„OpenRestyçš„APIå’ŒLuaJITçš„APIï¼Œä½ çœ‹æˆ‘è¿™ä¹ˆç†è§£å¯¹ä¸å¯¹ï¼š<br>OpenRestyçš„APIï¼Œæ˜¯æŒ‡lua-nginx-moduleæ¨¡å—æä¾›çš„API<br>LuaJITçš„APIï¼Œæ˜¯æŒ‡lua-resty-coreå’Œå„ç§lua-resty-*é¡¹ç›®ä¸­æä¾›çš„API","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":454808,"discussion_content":"OpenResty çš„ API æŒ‡çš„æ˜¯lua-nginx-moduleå’Œlua-resty-coreæä¾›çš„æ¥å£ï¼Œéƒ½æ˜¯ `ngx` æ¥å¤´çš„ï¼›LuaJIT çš„ API æ˜¯æ‰©å±•äº† Lua å†…ç½®çš„åº“ï¼Œæ¯”å¦‚ `table.new` è¿™ç§","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561551050,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1159196,"avatar":"https://static001.geekbang.org/account/avatar/00/11/b0/1c/2e30eeb8.jpg","nickname":"æ—ºæ—º","note":"","ucode":"FE2CF90F446BFB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":91,"discussion_content":"åäº†å§","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561090474,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":105717,"user_name":"xindoo","can_delete":false,"product_type":"c1","uid":1101718,"ip_address":"","ucode":"AEAF3208E644BC","user_header":"https://static001.geekbang.org/account/avatar/00/10/cf/96/251c0cee.jpg","comment_is_top":false,"comment_ctime":1561078293,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1561078293","product_id":100028301,"comment_content":"æˆ‘ç«‹å³luaä¸­çš„å¼±è¡¨å’Œjavaä¸­çš„WeakHashMapç±»ä¼¼","like_count":0},{"had_liked":false,"id":105700,"user_name":"ä¸€æ­¥","can_delete":false,"product_type":"c1","uid":1005391,"ip_address":"","ucode":"73CEA468CE70C3","user_header":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","comment_is_top":false,"comment_ctime":1561076917,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1561076917","product_id":100028301,"comment_content":"å½“ __mode = k æ—¶ ï¼Œtable çš„é”®kæ˜¯å¼±å¼•ç”¨, è¿™å¥è¯ä¸çŸ¥é“æ€ä¹ˆç†è§£ï¼Œ é”®ä¹Ÿå¯ä»¥è®¡æ•°å—ï¼Ÿ é”®ä¹Ÿå¯ä»¥å¼±å¼•ç”¨å—ï¼Ÿ<br>table çš„ å€¼ væ˜¯å¼±å¼•ç”¨, å¯ä»¥ç†è§£çš„ï¼Œ å½“å›æ”¶çš„æ—¶å€™ èµ‹å€¼ä¸º nil","like_count":0},{"had_liked":false,"id":105697,"user_name":"ä¸€æ­¥","can_delete":false,"product_type":"c1","uid":1005391,"ip_address":"","ucode":"73CEA468CE70C3","user_header":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","comment_is_top":false,"comment_ctime":1561076704,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1561076704","product_id":100028301,"comment_content":"lua weak table  å¯ä»¥ç±»æ¯” js çš„ weak set ,å…¶ä¸­çš„å…ƒç´ ä¸ä¼šåŠ å…¥å¼•ç”¨è®¡æ•°ï¼Œå½“å…ƒç´ æ²¡æœ‰å…¶ä»–å¼•ç”¨çš„æ—¶å€™ï¼Œå°±ä¼šè¢« gc æ‰","like_count":0}]}