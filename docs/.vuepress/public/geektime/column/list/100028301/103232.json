{"id":103232,"title":"16 | ç§’æ€å¤§å¤šæ•°å¼€å‘é—®é¢˜çš„ä¸¤ä¸ªåˆ©å™¨ï¼šæ–‡æ¡£å’Œæµ‹è¯•æ¡ˆä¾‹","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯æ¸©é“­ã€‚åœ¨å­¦ä¹ äº† OpenResty çš„åŸç†å’Œå‡ ä¸ªé‡è¦æ¦‚å¿µåï¼Œæˆ‘ä»¬ç»ˆäºè¦å¼€å§‹ API çš„å­¦ä¹ äº†ã€‚</p><p>ä»æˆ‘ä¸ªäººçš„ç»éªŒæ¥çœ‹ï¼Œå­¦ä¹  OpenResty çš„ API æ˜¯ç›¸å¯¹å®¹æ˜“çš„ï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰å ç”¨æœ¬ä¸“æ å¤ªå¤šçš„ç¯‡å¹…ã€‚ä½ å¯ä»¥ä¼šç–‘æƒ‘ï¼šAPI ä¸æ˜¯æœ€å¸¸ç”¨ã€æœ€é‡è¦çš„éƒ¨åˆ†å—ï¼Œä¸ºä»€ä¹ˆèŠ±çš„ç¬”å¢¨ä¸å¤šï¼Ÿ</p><p>å…¶å®ï¼Œè¿™ä¸»è¦æ˜¯å‡ºäºä¸¤ä¸ªæ–¹é¢çš„è€ƒè™‘ã€‚</p><p>ç¬¬ä¸€ï¼ŒOpenResty æä¾›äº†éå¸¸è¯¦å°½çš„æ–‡æ¡£ã€‚å’Œå¾ˆå¤šå…¶ä»–çš„å¼€å‘è¯­è¨€æˆ–è€…å¹³å°ç›¸æ¯”ï¼ŒOpenResty é™¤äº†ä¼šæä¾› API çš„å‚æ•°ã€è¿”å›å€¼å®šä¹‰ï¼Œè¿˜ä¼šæä¾›å®Œæ•´çš„ã€å¯è¿è¡Œçš„ä»£ç ç¤ºä¾‹ï¼Œæ¸…æ¥šåœ°å‘Šè¯‰ä½ API æ˜¯å¦‚ä½•å¤„ç†å„ç§è¾¹ç•Œæ¡ä»¶çš„ã€‚</p><p>è¿™ç§åœ¨ API å®šä¹‰ä¸‹é¢ç´§è·Ÿç€ç¤ºä¾‹ä»£ç å’Œæ³¨æ„äº‹é¡¹çš„åšæ³•ï¼Œå°±æ˜¯ OpenResty æ–‡æ¡£çš„ä¸€è´¯é£æ ¼ã€‚è¿™æ ·ä¸€æ¥ï¼Œåœ¨çœ‹å®Œ API æè¿°åï¼Œä½ å°±å¯ä»¥ç«‹å³åœ¨è‡ªå·±çš„ç¯å¢ƒä¸‹è¿è¡Œç¤ºä¾‹ä»£ç ï¼Œå¹¶ä¿®æ”¹å‚æ•°æ¥å’Œæ–‡æ¡£äº’ç›¸å°è¯ï¼ŒåŠ æ·±è®°å¿†å’Œç†è§£ã€‚</p><p>ç¬¬äºŒï¼Œåœ¨æ–‡æ¡£ä¹‹å¤–ï¼ŒOpenRestyè¿˜æä¾›äº†é«˜è¦†ç›–åº¦çš„æµ‹è¯•æ¡ˆä¾‹é›†ã€‚åˆšåˆšæˆ‘æåˆ°è¿‡ï¼ŒOpenRestyæ–‡æ¡£ä¸­æä¾›äº† API çš„ä»£ç ç¤ºä¾‹ï¼Œä½†ç»ˆç©¶ç¯‡å¹…æœ‰é™ï¼Œå¤šä¸ª API ä¹‹é—´å¦‚ä½•é…åˆä½¿ç”¨ã€å„ç§å¼‚å¸¸æƒ…å†µä¸‹çš„æŠ¥é”™å’Œå¤„ç†ç­‰ï¼Œåœ¨æ–‡æ¡£ä¸­å¹¶æ²¡æœ‰å‘ˆç°ã€‚</p><p>ä¸è¿‡ï¼Œä¸ç”¨æ‹…å¿ƒï¼Œè¿™äº›å†…å®¹ä½ å¤§éƒ½å¯ä»¥åœ¨æµ‹è¯•æ¡ˆä¾‹é›†é‡Œæ‰¾åˆ°ã€‚</p><p>å¯¹äº OpenResty çš„å¼€å‘è€…æ¥è¯´ï¼Œæœ€å¥½çš„ API å­¦ä¹ èµ„æ–™å°±æ˜¯å®˜æ–¹æ–‡æ¡£å’Œæµ‹è¯•æ¡ˆä¾‹ï¼Œå®ƒä»¬è¶³å¤Ÿä¸“ä¸šå’Œå‹å¥½ã€‚åœ¨è¿™ä¸ªå‰æä¸‹ï¼Œå¦‚æœæˆ‘å•çº¯åœ°æŠŠæ–‡æ¡£ç¿»è¯‘æˆä¸­æ–‡å†æ”¾åœ¨ä¸“æ ä¸­æ¥è®²ï¼Œå°±æ²¡æœ‰å¤ªå¤§æ„ä¹‰äº†ã€‚</p><!-- [[[read_end]]] --><p>æˆäººä»¥é±¼ä¸å¦‚æˆä¹‹ä»¥æ¸”ï¼Œæˆ‘æ›´å¸Œæœ›æ•™ç»™ä½ çš„æ˜¯é€šç”¨çš„æ–¹æ³•å’Œç»éªŒã€‚è®©æˆ‘ä»¬ç”¨ä¸€ä¸ªçœŸå®çš„ä¾‹å­æ¥ä½“éªŒä¸‹ï¼Œåœ¨ OpenResty çš„å¼€å‘ä¸­ï¼Œå¦‚ä½•è®©æ–‡æ¡£å’Œæµ‹è¯•æ¡ˆä¾‹é›†å‘æŒ¥æ›´å¤§çš„å¨åŠ›ã€‚</p><h2>shdict get API</h2><p>shared dictï¼ˆå…±äº«å­—å…¸ï¼‰æ˜¯åŸºäº NGINX å…±äº«å†…å­˜åŒºçš„ Lua å­—å…¸å¯¹è±¡ï¼Œå®ƒå¯ä»¥è·¨å¤šä¸ª worker æ¥å­˜å–æ•°æ®ï¼Œä¸€èˆ¬ç”¨æ¥å­˜æ”¾é™æµã€é™é€Ÿã€ç¼“å­˜ç­‰æ•°æ®ã€‚shared dict ç›¸å…³çš„ API æœ‰ 20 å¤šä¸ªï¼Œæ˜¯ OpenResty ä¸­æœ€å¸¸ç”¨ä¹Ÿæ˜¯æœ€é‡è¦çš„ä¸€ç»„ APIã€‚</p><p>æˆ‘ä»¬ä»¥æœ€ç®€å•çš„ get æ“ä½œä¸ºä¾‹ï¼Œä½ å¯ä»¥ç‚¹å¼€  <a href=\"https://github.com/openresty/lua-nginx-module/#ngxshareddictget\">æ–‡æ¡£é“¾æ¥</a>  åšä¸ºå¯¹ç…§ã€‚ä¸‹é¢çš„æœ€å°åŒ–çš„ä»£ç ç¤ºä¾‹ï¼Œæ­£æ˜¯ç”±å®˜æ–¹æ–‡æ¡£æ”¹ç¼–è€Œæ¥ï¼š</p><pre><code>  http {\n      lua_shared_dict dogs 10m;\n      server {\n          location /demo {\n              content_by_lua_block {\n                  local dogs = ngx.shared.dogs\n         dogs:set(&quot;Jim&quot;, 8)\n         local v = dogs:get(&quot;Jim&quot;)\n                  ngx.say(v)\n              }\n          }\n      }\n  }\n</code></pre><p>ç®€å•è¯´æ˜ä¸€ä¸‹ï¼Œåœ¨Lua ä»£ç ä¸­ä½¿ç”¨ shared dict ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ nginx.conf ä¸­ç”¨ <code>lua_shared_dict</code> æŒ‡ä»¤å¢åŠ ä¸€å—å†…å­˜ç©ºé—´ï¼Œå®ƒçš„åå­—æ˜¯ dogsï¼Œå¤§å°ä¸º 10Mã€‚ä¿®æ”¹å®Œ nginx.confåï¼Œä½ è¿˜éœ€è¦é‡å¯è¿›ç¨‹ï¼Œç”¨æµè§ˆå™¨æˆ–è€… curl è®¿é—®æ‰èƒ½çœ‹åˆ°ç»“æœã€‚</p><p>è¿™æ­¥éª¤çœ‹èµ·æ¥æ˜¯ä¸æ˜¯æœ‰äº›ç¹çå‘¢ï¼Ÿè®©æˆ‘ä»¬ç”¨ä¸€ç§æ›´ç›´æ¥çš„æ–¹å¼æ”¹é€ ä¸€ä¸‹ã€‚ä½ å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨ resty CLI çš„è¿™ç§æ–¹å¼ï¼Œå’Œåœ¨ nginx.conf ä¸­åµŒå…¥ä»£ç çš„æ•ˆæœæ˜¯ä¸€è‡´çš„ã€‚</p><pre><code>$ resty --shdict 'dogs 10m' -e 'local dogs = ngx.shared.dogs\n dogs:set(&quot;Jim&quot;, 8)\n local v = dogs:get(&quot;Jim&quot;)\n ngx.say(v)\n '\n</code></pre><p>ä½ ç°åœ¨å·²ç»çŸ¥é“ nginx.conf å’Œ Lua ä»£ç æ˜¯å¦‚ä½•é…åˆçš„ï¼Œä¹ŸæˆåŠŸè¿è¡Œäº† shared dict çš„ set å’Œ get æ–¹æ³•ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå¤§éƒ¨åˆ†å¼€å‘è€…ä¹Ÿå°±æ­¤æ­¢æ­¥ï¼Œä¸å†æ·±ç©¶äº†ã€‚</p><p>äº‹å®ä¸Šï¼Œè¿™é‡Œè¿˜æ˜¯æœ‰å‡ ä¸ªå€¼å¾—æ³¨æ„çš„åœ°æ–¹ï¼Œæ¯”å¦‚ï¼š</p><ol>\n<li>å“ªäº›é˜¶æ®µä¸èƒ½ä½¿ç”¨å…±äº«å†…å­˜ç›¸å…³çš„ API å‘¢ï¼Ÿ</li>\n<li>æˆ‘ä»¬åœ¨ç¤ºä¾‹ä»£ç ä¸­çœ‹åˆ° get å‡½æ•°åªæœ‰ä¸€ä¸ªè¿”å›å€¼ï¼Œé‚£ä»€ä¹ˆæƒ…å†µä¸‹ä¼šæœ‰å¤šä¸ªè¿”å›å€¼å‘¢ï¼Ÿ</li>\n<li>get å‡½æ•°çš„å…¥å‚æ˜¯ä»€ä¹ˆç±»å‹ï¼Ÿæ˜¯å¦æœ‰é•¿åº¦é™åˆ¶ï¼Ÿ</li>\n</ol><p>ä¸è¦å°çœ‹è¿™å‡ ä¸ªé—®é¢˜ï¼Œçª¥ä¸€æ–‘è€Œè§å…¨è±¹ï¼Œå®ƒä»¬å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´å¥½çš„æ·±å…¥ OpenRestyã€‚æ¥ä¸‹æ¥æˆ‘å°±å¸¦ä½ ä¸€ä¸€è§£è¯»ã€‚</p><h2>å“ªäº›é˜¶æ®µä¸èƒ½ä½¿ç”¨å…±äº«å†…å­˜ç›¸å…³çš„ API ï¼Ÿ</h2><p>å…ˆæ¥çœ‹ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œç­”æ¡ˆå¾ˆç›´æ¥ï¼Œæ–‡æ¡£ä¸­ä¸“é—¨æœ‰ä¸€ä¸ª <code>context</code> ï¼ˆå³ä¸Šä¸‹æ–‡éƒ¨åˆ†ï¼‰ï¼Œé‡Œé¢åˆ—å‡ºäº†åœ¨ä»€ä¹ˆç¯å¢ƒä¸‹å¯ä»¥ä½¿ç”¨è¿™ä¸ª APIï¼š</p><pre><code>context: set_by_lua*, rewrite_by_lua*, access_by_lua*, content_by_lua*, header_filter_by_lua*, body_filter_by_lua*, log_by_lua*, ngx.timer.*, balancer_by_lua*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*, ssl_session_store_by_lua*\n</code></pre><p>å¯ä»¥çœ‹å‡ºï¼Œ <code>init</code> å’Œ <code>init_worker</code> ä¸¤ä¸ªé˜¶æ®µä¸åœ¨å…¶ä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå…±äº«å†…å­˜çš„ get API ä¸èƒ½åœ¨è¿™ä¸¤ä¸ªé˜¶æ®µä½¿ç”¨ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ¯ä¸ªå…±äº«å†…å­˜çš„ API å¯ä»¥ä½¿ç”¨çš„é˜¶æ®µå¹¶ä¸å®Œå…¨ç›¸åŒï¼Œæ¯”å¦‚ set API å°±å¯ä»¥åœ¨ <code>init</code> é˜¶æ®µä½¿ç”¨ã€‚</p><p>æ‰€ä»¥ï¼Œåƒä¸‡ä¸è¦æƒ³å½“ç„¶ï¼Œè¿˜æ˜¯é‚£å¥è¯ï¼Œä½¿ç”¨æ—¶å¤šç¿»é˜…æ–‡æ¡£ã€‚å½“ç„¶äº†ï¼Œå°½ä¿¡ä¹¦ä¸å¦‚æ— ä¹¦ï¼ŒOpenResty çš„æ–‡æ¡£æœ‰æ—¶å€™ä¹Ÿä¼šå‡ºç°é”™æ¼ï¼Œè¿™æ—¶å€™ä½ å°±éœ€è¦ç”¨å®é™…çš„æµ‹è¯•æ¥éªŒè¯äº†ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬ä¿®æ”¹ä¸‹æµ‹è¯•æ¡ˆä¾‹é›†ï¼Œæ¥ç¡®å®šä¸‹ <code>init</code> é˜¶æ®µæ˜¯å¦å¯ä»¥è¿è¡Œ shared dict çš„ get APIã€‚</p><p>é‚£è¯¥å¦‚ä½•æ‰¾åˆ°å’Œå…±äº«å†…å­˜ç›¸å…³çš„æµ‹è¯•æ¡ˆä¾‹é›†å‘¢ï¼Ÿäº‹å®ä¸Šï¼ŒOpenResty çš„æµ‹è¯•æ¡ˆä¾‹éƒ½æ”¾åœ¨ <code>/t</code> ç›®å½•ä¸‹ï¼Œå¹¶ä¸”å‘½åä¹Ÿæ˜¯æœ‰è§„å¾‹çš„ï¼Œå³<code>è‡ªå¢æ•°å­—-åŠŸèƒ½å.t</code>ã€‚æœç´¢<code>shdict</code>ï¼Œä½ å¯ä»¥æ‰¾åˆ° <code>043-shdict.t</code>ï¼Œè€Œè¿™å°±æ˜¯å…±äº«å†…å­˜çš„æµ‹è¯•æ¡ˆä¾‹é›†äº†ï¼Œå®ƒé‡Œé¢æœ‰æ¥è¿‘ 100 ä¸ªæµ‹è¯•æ¡ˆä¾‹ï¼ŒåŒ…å«å„ç§æ­£å¸¸å’Œå¼‚å¸¸æƒ…å†µçš„æµ‹è¯•ã€‚</p><p>æˆ‘ä»¬æ¥è¯•ç€ä¿®æ”¹ä¸‹ç¬¬ä¸€ä¸ªæµ‹è¯•æ¡ˆä¾‹ã€‚</p><p>ä½ å¯ä»¥æŠŠ content é˜¶æ®µæ”¹ä¸º init é˜¶æ®µï¼Œå¹¶ç²¾ç®€æ‰æ— å…³ä»£ç ï¼Œçœ‹çœ‹ get æ¥å£èƒ½å¦è¿è¡Œã€‚è¿™é‡Œæˆ‘éœ€è¦æé†’ä¸€ç‚¹ï¼Œåœ¨ç°é˜¶æ®µï¼Œä½ ä¸ç”¨éå¾—ææ˜ç™½æµ‹è¯•æ¡ˆä¾‹æ˜¯å¦‚ä½•ç¼–å†™ã€ç»„ç»‡å’Œè¿è¡Œçš„ï¼Œä½ åªè¦çŸ¥é“å®ƒæ˜¯åœ¨æµ‹è¯• get æ¥å£å°±å¯ä»¥äº†ï¼š</p><pre><code>=== TEST 1: string key, int value\n --- http_config\n     lua_shared_dict dogs 1m;\n --- config\n     location = /test {\n         init_by_lua '\n             local dogs = ngx.shared.dogs\n             local val = dogs:get(&quot;foo&quot;)\n             ngx.say(val)\n         ';\n     }\n --- request\n GET /test\n --- response_body\n 32\n --- no_error_log\n [error]\n --- ONLY\n</code></pre><p>ä½ åº”è¯¥æ³¨æ„åˆ°äº†ï¼Œåœ¨æµ‹è¯•æ¡ˆä¾‹çš„æœ€åï¼Œæˆ‘åŠ äº† <code>--ONLY</code> æ ‡è®°ï¼Œè¿™è¡¨ç¤ºå¿½ç•¥å…¶ä»–æ‰€æœ‰æµ‹è¯•æ¡ˆä¾‹ï¼Œåªè¿è¡Œè¿™ä¸€ä¸ªæµ‹è¯•æ¡ˆä¾‹ï¼Œä»¥æé«˜è¿è¡Œé€Ÿåº¦ã€‚åé¢åœ¨æµ‹è¯•éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä¼šä¸“é—¨è®²è§£å„ç§å„æ ·çš„æ ‡è®°ï¼Œä½ å…ˆè®°ä½è¿™é‡Œå°±å¯ä»¥äº†ã€‚</p><p>ä¿®æ”¹å®Œä»¥åï¼Œæˆ‘ä»¬ç”¨ prove å‘½ä»¤ï¼Œå°±å¯ä»¥è¿è¡Œè¿™ä¸ªæµ‹è¯•æ¡ˆä¾‹ï¼š</p><pre><code>$ prove t/043-shdict.t\n</code></pre><p>ç„¶åï¼Œä½ ä¼šå¾—åˆ°ä¸€ä¸ªæŠ¥é”™ï¼Œè¿™ä¹Ÿå°±å°è¯äº†æ–‡æ¡£ä¸­æè¿°çš„é˜¶æ®µé™åˆ¶ã€‚</p><pre><code>nginx: [emerg] &quot;init_by_lua&quot; directive is not allowed here\n</code></pre><h2>get å‡½æ•°ä½•æ—¶ä¼šæœ‰å¤šä¸ªè¿”å›å€¼ï¼Ÿ</h2><p>æˆ‘ä»¬å†æ¥çœ‹ç¬¬äºŒä¸ªé—®é¢˜ï¼Œå®ƒå¯ä»¥ä»å®˜æ–¹æ–‡æ¡£ä¸­æ€»ç»“å‡ºæ¥ã€‚æ–‡æ¡£æœ€å¼€å§‹å°±æ˜¯è¿™ä¸ªæ¥å£çš„<code>syntax</code> è¯­æ³•æè¿°éƒ¨åˆ†ï¼š</p><pre><code>value, flags = ngx.shared.DICT:get(key)\n</code></pre><p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œ</p><ul>\n<li>ç¬¬ä¸€ä¸ªå‚æ•°<code>value</code> è¿”å›çš„æ˜¯å­—å…¸ä¸­ key å¯¹åº”çš„å€¼ï¼›ä½†å½“ key ä¸å­˜åœ¨æˆ–è€…è¿‡æœŸæ—¶ï¼Œ<code>value</code> çš„å€¼ä¸º nilã€‚</li>\n<li>ç¬¬äºŒä¸ªå‚æ•° <code>flags</code> å°±ç¨å¾®å¤æ‚ä¸€äº›äº†ï¼Œå¦‚æœ set æ¥å£è®¾ç½®äº† flagsï¼Œå°±è¿”å›ï¼Œå¦åˆ™ä¸è¿”å›ã€‚</li>\n</ul><p>ä¸€æ—¦ API è°ƒç”¨å‡ºé”™ï¼Œ<code>value</code> è¿”å› nilï¼Œ<code>flags</code> è¿”å›å…·ä½“çš„é”™è¯¯ä¿¡æ¯ã€‚</p><p>ä»æ–‡æ¡£æ€»ç»“çš„ä¿¡æ¯æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œ<code>local v = dogs:get(\"Jim\")</code> è¿™ç§åªæœ‰ä¸€ä¸ªæ¥æ”¶å‚æ•°çš„å†™æ³•å¹¶ä¸å®Œå–„ï¼Œå› ä¸ºå®ƒåªè¦†ç›–äº†æ™®é€šçš„ä½¿ç”¨åœºæ™¯ï¼Œæ²¡æœ‰æ¥æ”¶ç¬¬äºŒä¸ªå‚æ•°ï¼Œä¹Ÿæ²¡æœ‰åšå¼‚å¸¸å¤„ç†ã€‚æˆ‘ä»¬å¯ä»¥æŠŠå®ƒä¿®æ”¹ä¸ºä¸‹é¢è¿™æ ·ï¼š</p><pre><code>local data, err = dogs:get(&quot;Jim&quot;)\nif data == nil and err then\n    ngx.say(&quot;get not ok: &quot;, err)\n    return\nend\n</code></pre><p>å’Œç¬¬ä¸€ä¸ªé—®é¢˜ä¸€æ ·ï¼Œæˆ‘ä»¬å¯ä»¥åˆ°æµ‹è¯•æ¡ˆä¾‹é›†é‡Œæœç´¢ä¸€ä¸‹ï¼Œå°è¯ä¸‹æˆ‘ä»¬å¯¹æ–‡æ¡£çš„ç†è§£ï¼š</p><pre><code>=== TEST 65: get nil key\n --- http_config\n     lua_shared_dict dogs 1m;\n --- config\n     location = /test {\n         content_by_lua '\n             local dogs = ngx.shared.dogs\n             local ok, err = dogs:get(nil)\n             if not ok then\n                 ngx.say(&quot;not ok: &quot;, err)\n                 return\n             end\n             ngx.say(&quot;ok&quot;)\n         ';\n     }\n --- request\n GET /test\n --- response_body\n not ok: nil key\n --- no_error_log\n [error]\n</code></pre><p>åœ¨è¿™ä¸ªæµ‹è¯•æ¡ˆä¾‹ä¸­ï¼Œget æ¥å£çš„å…¥å‚ä¸º nilï¼Œè¿”å›çš„ err ä¿¡æ¯æ˜¯ <code>nil key</code>ã€‚è¿™ä¸€æ–¹é¢éªŒè¯äº†æˆ‘ä»¬å¯¹æ–‡æ¡£çš„åˆ†ææ˜¯æ­£ç¡®çš„ï¼Œå¦ä¸€æ–¹é¢ï¼Œä¹Ÿä¸ºç¬¬ä¸‰ä¸ªé—®é¢˜æä¾›äº†éƒ¨åˆ†ç­”æ¡ˆâ€”â€”èµ·ç ï¼Œget çš„å…¥å‚ä¸èƒ½æ˜¯ nilã€‚</p><h2>get å‡½æ•°çš„å…¥å‚æ˜¯ä»€ä¹ˆç±»å‹ï¼Ÿ</h2><p>è‡³äºç¬¬ä¸‰ä¸ªé—®é¢˜ï¼Œ get çš„å…¥å‚å¯ä»¥æ˜¯ä»€ä¹ˆç±»å‹çš„å‘¢ï¼Ÿæˆ‘ä»¬æŒ‰ç…§è€è§„çŸ©å…ˆæŸ¥çœ‹æ–‡æ¡£ï¼Œä¸è¿‡å¾ˆå¯æƒœï¼Œä½ ä¼šå‘ç°ï¼Œæ–‡æ¡£é‡Œå¹¶æ²¡æœ‰æ³¨æ˜ key çš„åˆæ³•ç±»å‹æœ‰å“ªäº›ã€‚è¿™æ—¶è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ</p><p>åˆ«ç€æ€¥ï¼Œè‡³å°‘æˆ‘ä»¬çŸ¥é“ key å¯ä»¥æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œå¹¶ä¸”ä¸èƒ½ä¸º nilã€‚ä¸çŸ¥é“ä½ è¿˜è®°å¾— Lua ä¸­çš„æ•°æ®ç±»å‹å—ï¼Ÿé™¤äº†å­—ç¬¦ä¸²å’Œ nilï¼Œè¿˜æœ‰æ•°å­—ã€æ•°ç»„ã€å¸ƒå°”ç±»å‹å’Œå‡½æ•°ã€‚åé¢ä¸¤ä¸ªæ˜¾ç„¶æ²¡æœ‰ä½œä¸º key çš„å¿…è¦æ€§ï¼Œæˆ‘ä»¬åªéœ€è¦éªŒè¯å‰ä¸¤ä¸ªã€‚ä¸å¦¨å…ˆå»æµ‹è¯•æ–‡ä»¶ä¸­æœç´¢ä¸€ä¸‹ï¼Œæ˜¯å¦æœ‰æ•°å­—ä½œä¸º key çš„æ¡ˆä¾‹ï¼š</p><pre><code>=== TEST 4: number keys, string values\n</code></pre><p>é€šè¿‡è¿™ä¸ªæµ‹è¯•æ¡ˆä¾‹ï¼Œä½ å¯ä»¥æ¸…æ¥šçœ‹åˆ°ï¼Œæ•°å­—ä¹Ÿå¯ä»¥ä½œä¸º key ï¼Œå†…éƒ¨ä¼šå°†æ•°å­—è½¬ä¸ºå­—ç¬¦ä¸²ã€‚é‚£ä¹ˆæ•°ç»„å‘¢ï¼Ÿå¾ˆé—æ†¾ï¼Œæµ‹è¯•æ¡ˆä¾‹å¹¶æ²¡æœ‰è¦†ç›–åˆ°ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå·±åŠ¨æ‰‹è¯•ä¸€ä¸‹ï¼š</p><pre><code>$ resty --shdict 'dogs 10m' -e 'local dogs = ngx.shared.dogs\n dogs:get({})\n '\n</code></pre><p>ä¸å‡ºæ„æ–™ï¼Œæœç„¶æŠ¥é”™äº†ï¼š</p><pre><code>ERROR: (command line -e):2: bad argument #1 to 'get' (string expected, got table)\n</code></pre><p>ç»¼ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®ºï¼šget API æ¥å—çš„ key ç±»å‹ä¸ºå­—ç¬¦ä¸²å’Œæ•°å­—ã€‚</p><p>é‚£ä¹ˆå…¥å‚ key çš„é•¿åº¦æ˜¯å¦æœ‰é™åˆ¶å‘¢ï¼Ÿè¿™é‡Œå…¶å®ä¹Ÿæœ‰ä¸€ä¸ªå¯¹åº”çš„æµ‹è¯•æ¡ˆä¾‹ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸€ä¸‹ï¼š</p><pre><code>=== TEST 67: get a too-long key\n --- http_config\n     lua_shared_dict dogs 1m;\n --- config\n     location = /test {\n         content_by_lua '\n             local dogs = ngx.shared.dogs\n             local ok, err = dogs:get(string.rep(&quot;a&quot;, 65536))\n             if not ok then\n                 ngx.say(&quot;not ok: &quot;, err)\n                 return\n             end\n             ngx.say(&quot;ok&quot;)\n         ';\n     }\n --- request\n GET /test\n --- response_body\n not ok: key too long\n --- no_error_log\n [error]\n</code></pre><p>å¾ˆæ˜¾ç„¶ï¼Œå­—ç¬¦ä¸²é•¿åº¦ä¸º 65536 çš„æ—¶å€™ï¼Œå°±ä¼šè¢«æç¤º key å¤ªé•¿äº†ã€‚ä½ å¯ä»¥è¯•ä¸‹æŠŠé•¿åº¦æ”¹ä¸º 65535ï¼Œè™½ç„¶åªå°‘äº†1ä¸ªå­—èŠ‚ï¼Œå´ä¸ä¼šå†æŠ¥é”™äº†ã€‚è¿™å°±è¯´æ˜ï¼Œkey çš„æœ€å¤§é•¿åº¦æ­£æ˜¯ 65535ã€‚</p><h2>å†™åœ¨æœ€å</h2><p>OpenResty ç°åœ¨çš„å®˜æ–¹æ–‡æ¡£åªæœ‰è‹±æ–‡ç‰ˆæœ¬ï¼Œå›½å†…å·¥ç¨‹å¸ˆåœ¨é˜…è¯»æ—¶ï¼Œéš¾å…ä¼šå› ä¸ºè¯­è¨€é—®é¢˜ï¼ŒæŠ“ä¸ä½é‡ç‚¹ï¼Œç”šè‡³è¯¯è§£å…¶ä¸­çš„å†…å®¹ã€‚ä½†è¶Šæ˜¯è¿™æ ·ï¼Œè¶Šæ²¡æœ‰æ·å¾„å¯èµ°ï¼Œä½ æ›´åº”è¯¥ä»”ç»†åœ°æŠŠæ–‡æ¡£ä»å¤´åˆ°å°¾è¯»å®Œï¼Œå¹¶åœ¨æœ‰ç–‘é—®æ—¶ï¼Œç»“åˆæµ‹è¯•æ¡ˆä¾‹é›†å’Œè‡ªå·±çš„å°è¯•ï¼Œå»ç¡®å®šå‡ºç­”æ¡ˆã€‚è¿™æ‰æ˜¯è¾…åŠ©æˆ‘ä»¬å­¦ä¹  OpenResty çš„æ­£ç¡®é€”å¾„ã€‚</p><p>æœ€åï¼Œæˆ‘æƒ³æé†’ä¸€ä¸‹ï¼Œåœ¨ OpenResty çš„ API ä¸­ï¼Œå‡¡æ˜¯è¿”å›å€¼ä¸­å¸¦æœ‰é”™è¯¯ä¿¡æ¯çš„ï¼Œéƒ½å¿…é¡»æœ‰å˜é‡æ¥æ¥æ”¶å¹¶åšé”™è¯¯å¤„ç†ï¼Œå¦åˆ™å‰æ–¹ä¸€å®šä¼šæœ‰å‘ç­‰ä½ è·³è¿›å»ã€‚æ¯”å¦‚æŠŠå‡ºé”™çš„è¿æ¥æ”¾å…¥äº†è¿æ¥æ± ï¼Œæˆ–è€…åœ¨ API è°ƒç”¨å¤±è´¥çš„æƒ…å†µä¸‹ç»§ç»­åé¢çš„é€»è¾‘ï¼Œæ€»ä¹‹ä¸€å®šè®©äººå«è‹¦ä¸è¿­ã€‚</p><p>é‚£ä¹ˆï¼Œä½ åœ¨å†™ OpenResty ä»£ç çš„æ—¶å€™ï¼Œå¦‚æœé‡åˆ°é—®é¢˜ï¼Œä¸€èˆ¬æ˜¯é€šè¿‡ä»€ä¹ˆæ–¹å¼æ¥è§£å†³çš„ï¼Ÿæ˜¯æ–‡æ¡£ã€é‚®ä»¶åˆ—è¡¨ã€QQ ç¾¤ï¼Œè¿˜æ˜¯å…¶ä»–æ¸ é“å‘¢ï¼Ÿ</p><p>æ¬¢è¿ç•™è¨€ä¸€èµ·æ¢è®¨ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™ç¯‡æ–‡ç« åˆ†äº«ç»™ä½ çš„åŒäº‹ã€æœ‹å‹ï¼Œæˆ‘ä»¬ä¸€èµ·äº¤æµï¼Œä¸€èµ·è¿›æ­¥ã€‚</p><p></p>","neighbors":{"left":{"article_title":"15 | OpenResty å’Œåˆ«çš„å¼€å‘å¹³å°æœ‰ä»€ä¹ˆä¸åŒï¼Ÿ","id":102113},"right":{"article_title":"17 | ä¸ºä»€ä¹ˆèƒ½æˆä¸ºæ›´å¥½çš„WebæœåŠ¡å™¨ï¼ŸåŠ¨æ€å¤„ç†è¯·æ±‚å’Œå“åº”æ˜¯å…³é”®","id":103481}},"comments":[{"had_liked":false,"id":109480,"user_name":"helloworld","can_delete":false,"product_type":"c1","uid":1105161,"ip_address":"","ucode":"1EECCA0F43E278","user_header":"https://static001.geekbang.org/account/avatar/00/10/dd/09/feca820a.jpg","comment_is_top":false,"comment_ctime":1562039858,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"78871451186","product_id":100028301,"comment_content":"é©±åŠ¨æµ‹è¯•æ¡ˆä¾‹ï¼š<br>1. å®‰è£…ç›¸å…³æ¨¡å—<br>sudo yum install cpan -y<br>sudo cpan YAML<br>sudo cpan Test::Nginx<br><br>2. test æµ‹è¯•æ¡ˆä¾‹<br>git clone git@github.com:openresty&#47;lua-nginx-module.git<br>cd lua-nginx-module&#47;<br>prove  t&#47;043-shdict.t <br>","like_count":19},{"had_liked":false,"id":109477,"user_name":"helloworld","can_delete":false,"product_type":"c1","uid":1105161,"ip_address":"","ucode":"1EECCA0F43E278","user_header":"https://static001.geekbang.org/account/avatar/00/10/dd/09/feca820a.jpg","comment_is_top":false,"comment_ctime":1562039714,"is_pvip":false,"replies":[{"id":"39719","content":"æ˜¯çš„ï¼Œç¡®å®å†™é”™äº†ï¼ŒæŠ±æ­‰ï¼Œæˆ‘å»ä¿®æ”¹ä¸‹ã€‚å¤šè°¢æŒ‡æ­£ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1562084115,"ip_address":"","comment_id":109477,"utype":1}],"discussion_count":1,"race_medal":0,"score":"48806679970","product_id":100028301,"comment_content":"è€å¸ˆï¼ŒæŒ‡å‡ºæ–‡ç« ä¸­å¯èƒ½çš„ä¸€å¤„é”™è¯¯ï¼š&quot;å“ªäº›é˜¶æ®µä¸èƒ½ä½¿ç”¨å…±äº«å†…å­˜ç›¸å…³çš„ APIï¼Ÿ&quot; è¿™ä¸ªä¾‹å­ä¸¾çš„è²Œä¼¼ä¸å¤ªå¯¹ã€‚<br>restydoc -s ngx.shared å¯çŸ¥å…±äº«å†…å­˜çš„ç›¸å…³APIæ˜¯æ”¯æŒinit_by_luaå’Œinit_worker_by_luaé˜¶æ®µçš„ï¼Œä½ åœ¨043-shdict.tçš„ç¬¬ä¸€ä¸ªæµ‹è¯•æ¡ˆä¾‹ä¸­å°†content_by_luaä¿®æ”¹ä¸ºinit_by_luaï¼Œæ‰§è¡Œæµ‹è¯•æŠ¥é”™ï¼Œè¯´æ˜çš„æ˜¯init_by_luaæŒ‡ä»¤ä¸èƒ½åœ¨locationé‡Œï¼Œè€Œä¸æ˜¯è¯´æ˜å…±äº«å†…å­˜APIçš„é—®é¢˜ã€‚é€šè¿‡restydoc -s init_by_lua  æŸ¥çœ‹ï¼Œå¯çŸ¥ï¼Œinit_by_luaæŒ‡ä»¤çš„ä¸Šä¸‹æ–‡åªèƒ½æ˜¯httpã€‚","like_count":12,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":456431,"discussion_content":"æ˜¯çš„ï¼Œç¡®å®å†™é”™äº†ï¼ŒæŠ±æ­‰ï¼Œæˆ‘å»ä¿®æ”¹ä¸‹ã€‚å¤šè°¢æŒ‡æ­£ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562084115,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":109443,"user_name":"HelloBug","can_delete":false,"product_type":"c1","uid":1249598,"ip_address":"","ucode":"E61A4AD5C2F724","user_header":"https://static001.geekbang.org/account/avatar/00/13/11/3e/925aa996.jpg","comment_is_top":false,"comment_ctime":1562033287,"is_pvip":true,"replies":[{"id":"39718","content":"è¿™æ˜¯ä¸ªå¥½é—®é¢˜ï¼Œæˆ‘å’Œä½ çš„æ„Ÿè§‰æ˜¯ä¸€æ ·çš„ã€‚æˆ‘åœ¨è‡ªå·±çš„é¡¹ç›®ä¸­éƒ½æ˜¯ç”¨ no_shuffleï¼Œä¸¥æ ¼æŒ‰ç…§é¡ºåºæ¥æ‰§è¡Œã€‚<br>è¿™æ˜¯å› ä¸ºæµ‹è¯•æ¡ˆä¾‹å¯èƒ½ä¼šä¾èµ–å¤–éƒ¨çš„æŒä¹…åŒ–å­˜å‚¨ï¼Œæ¯”å¦‚ redisã€memcachedã€postgres ç­‰ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™éšæœºè¿è¡Œæµ‹è¯•å°±å¯èƒ½å‡ºé”™ã€‚<br>æ‰€ä»¥ï¼Œæˆ‘ä¹Ÿä¸å¤ªç†è§£ä¸ºä»€ä¹ˆé»˜è®¤è¦ç”¨shuffleçš„æ–¹å¼è¿è¡Œã€‚<br>æˆ‘èƒ½æƒ³åˆ°çš„ä¸€ä¸ªåŸå› ï¼Œå¯èƒ½æ˜¯åœ¨æŠŠ TEST_NGINX_FORCE_RESTART_ON_TEST è®¾ç½®ä¸º 0 çš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯åœ¨é…ç½®æ–‡ä»¶ä¸å˜åŒ–çš„æ—¶å€™ä¸é‡å¯ nginxï¼Œè¿™ä¸ªæ—¶å€™éšæœºå°±æœ‰æ„ä¹‰äº†ã€‚<br>å¦å¤–ï¼Œå¦‚æœTEST_NGINX_FORCE_RESTART_ON_TESTè®¾ç½®ä¸º 0ï¼Œ å¹¶ä¸” TEST_NGINX_BENCHMARK è®¾ç½®ä¸º 1ï¼Œé‚£ä¹ˆå°±ä¼šåœ¨ä¸é‡å¯å’Œå¤§å‹åŠ›çš„æƒ…å†µä¸‹å»åšéšæœºæµ‹è¯•ã€‚<br>test::nginx æœ‰å¾ˆå¤šç§ç»„åˆçš„æ¨¡å¼ï¼Œæˆ‘è§‰å¾—æœ‰äº›è®¾è®¡çš„è¿‡äºçµæ´»å’Œå¤æ‚äº†ï¼Œä¸ªäººè§è§£ï¼Œæ¬¢è¿äº¤æµã€‚<br>è¡¥å……ä¸€å¥å“ˆï¼Œè¿˜æœ‰ TEST_NGINX_USE_HUP è¿™ä¸ªç¯å¢ƒå˜é‡ï¼Œå¯ä»¥ä¿è¯æµ‹è¯•æ¡ˆä¾‹é—´çš„ shared dict ä¸è¢«æ¸…ç©ºã€‚<br>","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1562084021,"ip_address":"","comment_id":109443,"utype":1}],"discussion_count":2,"race_medal":0,"score":"23036869767","product_id":100028301,"comment_content":"æ¸©é“­è€å¸ˆï¼Œä½ å¥½~<br>çœ‹äº†https:&#47;&#47;openresty.gitbooks.io&#47;programming-openresty&#47;content&#47;testingé‡Œé¢çš„test-nginxæ–‡æ¡£ã€‚ä»Šå¤©çœ‹åˆ°çš„éƒ¨åˆ†æœ‰ä¸€ä¸ªç–‘é—®ï¼Œåœ¨RunningTestä¸€èŠ‚è®²ä¸€ä¸ªtest fileé‡Œçš„test blocké»˜è®¤æ˜¯shuffleæ–¹å¼éšæœºè¿è¡Œçš„ï¼Œä»¥ä¾¿åœ¨ä¸åŒçš„æ‰§è¡Œé¡ºåºä¸‹å¯èƒ½å‡ºç°çš„bugè¢«é—æ¼ã€‚ç„¶ååœ¨PreparingTestä¸€èŠ‚é‡Œè®²åˆ°ï¼Œæ¯ä¸ªtest blockéƒ½ä¼šç”Ÿæˆä¸€ä¸ªnginx.confï¼Œç”Ÿæˆnginxè¿›ç¨‹æ‰§è¡Œï¼Œæ‰§è¡Œä¸‹ä¸€ä¸ªtest blockæ—¶ï¼Œä¼šå…³é—­ä¹‹å‰è¿›ç¨‹ï¼Œé‡æ–°å¯åŠ¨æ–°çš„è¿›ç¨‹ã€‚è¿™æ ·æ‰“ä¹±test blockå’Œä¸æ‰“ä¹±ä¸å°±æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«äº†å—ï¼Ÿ","like_count":6,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":456412,"discussion_content":"è¿™æ˜¯ä¸ªå¥½é—®é¢˜ï¼Œæˆ‘å’Œä½ çš„æ„Ÿè§‰æ˜¯ä¸€æ ·çš„ã€‚æˆ‘åœ¨è‡ªå·±çš„é¡¹ç›®ä¸­éƒ½æ˜¯ç”¨ no_shuffleï¼Œä¸¥æ ¼æŒ‰ç…§é¡ºåºæ¥æ‰§è¡Œã€‚\nè¿™æ˜¯å› ä¸ºæµ‹è¯•æ¡ˆä¾‹å¯èƒ½ä¼šä¾èµ–å¤–éƒ¨çš„æŒä¹…åŒ–å­˜å‚¨ï¼Œæ¯”å¦‚ redisã€memcachedã€postgres ç­‰ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™éšæœºè¿è¡Œæµ‹è¯•å°±å¯èƒ½å‡ºé”™ã€‚\næ‰€ä»¥ï¼Œæˆ‘ä¹Ÿä¸å¤ªç†è§£ä¸ºä»€ä¹ˆé»˜è®¤è¦ç”¨shuffleçš„æ–¹å¼è¿è¡Œã€‚\næˆ‘èƒ½æƒ³åˆ°çš„ä¸€ä¸ªåŸå› ï¼Œå¯èƒ½æ˜¯åœ¨æŠŠ TEST_NGINX_FORCE_RESTART_ON_TEST è®¾ç½®ä¸º 0 çš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯åœ¨é…ç½®æ–‡ä»¶ä¸å˜åŒ–çš„æ—¶å€™ä¸é‡å¯ nginxï¼Œè¿™ä¸ªæ—¶å€™éšæœºå°±æœ‰æ„ä¹‰äº†ã€‚\nå¦å¤–ï¼Œå¦‚æœTEST_NGINX_FORCE_RESTART_ON_TESTè®¾ç½®ä¸º 0ï¼Œ å¹¶ä¸” TEST_NGINX_BENCHMARK è®¾ç½®ä¸º 1ï¼Œé‚£ä¹ˆå°±ä¼šåœ¨ä¸é‡å¯å’Œå¤§å‹åŠ›çš„æƒ…å†µä¸‹å»åšéšæœºæµ‹è¯•ã€‚\ntest::nginx æœ‰å¾ˆå¤šç§ç»„åˆçš„æ¨¡å¼ï¼Œæˆ‘è§‰å¾—æœ‰äº›è®¾è®¡çš„è¿‡äºçµæ´»å’Œå¤æ‚äº†ï¼Œä¸ªäººè§è§£ï¼Œæ¬¢è¿äº¤æµã€‚\nè¡¥å……ä¸€å¥å“ˆï¼Œè¿˜æœ‰ TEST_NGINX_USE_HUP è¿™ä¸ªç¯å¢ƒå˜é‡ï¼Œå¯ä»¥ä¿è¯æµ‹è¯•æ¡ˆä¾‹é—´çš„ shared dict ä¸è¢«æ¸…ç©ºã€‚\n","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1562084021,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1249598,"avatar":"https://static001.geekbang.org/account/avatar/00/13/11/3e/925aa996.jpg","nickname":"HelloBug","note":"","ucode":"E61A4AD5C2F724","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1250,"discussion_content":"è°¢è°¢è€å¸ˆçš„å›å¤ï¼Œå—ç›Š~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562471516,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":109012,"user_name":"åˆ˜ä¸¹","can_delete":false,"product_type":"c1","uid":1081922,"ip_address":"","ucode":"66594D1C957E15","user_header":"https://static001.geekbang.org/account/avatar/00/10/82/42/8b04d489.jpg","comment_is_top":false,"comment_ctime":1561948529,"is_pvip":false,"discussion_count":3,"race_medal":0,"score":"5856915825","product_id":100028301,"comment_content":"è¯·é—®OpenRestyçš„æµ‹è¯•ç¯å¢ƒè¦æ€æ ·æ­å»ºï¼Ÿè¿è¡Œprove t1.t å‘½ä»¤å‡ºé”™:<br>t1.t .. Can&#39;t locate Test&#47;Nginx&#47;Socket&#47;Lua.pm in @INC (@INC contains: &#47;usr&#47;local&#47;lib64&#47;perl5 &#47;usr&#47;local&#47;share&#47;perl5 &#47;usr&#47;lib64&#47;perl5&#47;vendor_perl &#47;usr&#47;share&#47;perl5&#47;vendor_perl &#47;usr&#47;lib64&#47;perl5 &#47;usr&#47;share&#47;perl5 .) at t1.t line 2.<br>BEGIN failed--compilation aborted at t1.t line 2.<br>t1.t .. Dubious, test returned 2 (wstat 512, 0x200)<br>No subtests run<br><br>Test Summary Report<br>-------------------<br>t1.t (Wstat: 512 Tests: 0 Failed: 0)<br>  Non-zero exit status: 2<br>  Parse errors: No plan found in TAP output<br>Files=1, Tests=0,  0 wallclock secs ( 0.02 usr +  0.00 sys =  0.02 CPU)<br>Result: FAIL","like_count":1,"discussions":[{"author":{"id":1219195,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/2xoGmvlQ9qfSibVpPJyyaEriavuWzXnuECrJITmGGHnGVuTibUuBho43Uib3Y5qgORHeSTxnOOSicxs0FV3HGvTpF0A/132","nickname":"psoracle","note":"","ucode":"26F9B166508BBA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1034,"discussion_content":"æœ€ç®€å•çš„æ–¹å¼æ˜¯é€šè¿‡openrestyçš„RPMæºæ¥å®‰è£…\nyum -y install perl-Test-Nginx","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562255889,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1219195,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/2xoGmvlQ9qfSibVpPJyyaEriavuWzXnuECrJITmGGHnGVuTibUuBho43Uib3Y5qgORHeSTxnOOSicxs0FV3HGvTpF0A/132","nickname":"psoracle","note":"","ucode":"26F9B166508BBA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1033,"discussion_content":"å¯ä»¥è¯•ä¸‹cpanmæ¥å®‰è£…\nyum -y install -y install perl-App-cpanminus.noarch\ncpanm --mirror http://mirrors.163.com/cpan --mirror-only YAML\ncpanm --mirror http://mirrors.163.com/cpan --mirror-only Test::Nginx","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562255145,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1013283,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/76/23/31e5e984.jpg","nickname":"ç©ºçŸ¥","note":"","ucode":"C448E98238DD36","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":699,"discussion_content":"å¾—å®‰è£… test::nginx \nhttps://github.com/openresty/test-nginx#installation","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1561969396,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":109005,"user_name":"å¼ ä»•å","can_delete":false,"product_type":"c1","uid":1054248,"ip_address":"","ucode":"8D41E96A5889FC","user_header":"https://static001.geekbang.org/account/avatar/00/10/16/28/c11e7aae.jpg","comment_is_top":false,"comment_ctime":1561947207,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5856914503","product_id":100028301,"comment_content":"èµèµèµ","like_count":1},{"had_liked":false,"id":344739,"user_name":"nil","can_delete":false,"product_type":"c1","uid":1198808,"ip_address":"","ucode":"52E48324112210","user_header":"https://static001.geekbang.org/account/avatar/00/12/4a/d8/21cf3642.jpg","comment_is_top":false,"comment_ctime":1651743205,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1651743205","product_id":100028301,"comment_content":"```shell<br>resty --shdict &#39;dogs 10m&#39; \\<br>-e &#39;local dogs = ngx.shared.dogs<br>local v, err = dogs:get({})<br>  if v == nil and err then<br>    ngx.say(&quot;not ok: &quot;, err)<br>  else<br>    ngx.say(&quot;got: &quot;, v)<br>end&#39;<br><br># got:<br>```<br><br>æ²¡æœ‰æŠ¥é”™ï¼Œæ˜¯ä¸æ˜¯ç°åœ¨ get API æ¥å— table ç±»å‹çš„å…¥å‚äº†","like_count":0},{"had_liked":false,"id":271065,"user_name":"nobia","can_delete":false,"product_type":"c1","uid":2394287,"ip_address":"","ucode":"1D3D0F808765EE","user_header":"https://static001.geekbang.org/account/avatar/00/24/88/af/bea4327e.jpg","comment_is_top":false,"comment_ctime":1609390851,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1609390851","product_id":100028301,"comment_content":"resty --shdict &#39;dogs 10m&#39; -e &#39;local dogs = ngx.shared.dogs dogs:get({}) &#39;<br>è¿è¡Œè¿™ä¸ªæ²¡æœ‰æŠ¥é”™<br>resty -V<br>resty 0.27<br>nginx version: openresty&#47;1.19.3.1<br>built by gcc 8.3.1 20191121 (Red Hat 8.3.1-5) (GCC) <br>built with OpenSSL 1.1.1h  22 Sep 2020 (running with OpenSSL 1.1.1i  8 Dec 2020)","like_count":0},{"had_liked":false,"id":255396,"user_name":"çº³å…°å®¹è‹¥","can_delete":false,"product_type":"c1","uid":1605876,"ip_address":"","ucode":"2E1EA2CDFDA1A9","user_header":"https://static001.geekbang.org/account/avatar/00/18/80/f4/564209ea.jpg","comment_is_top":false,"comment_ctime":1603335523,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1603335523","product_id":100028301,"comment_content":"éº»çƒ¦é—®ä¸€ä¸‹ å®‰è£…å®ŒTest::Nginx<br>è¿è¡Œæ—¶æç¤ºï¼šBailout called.  Further testing stopped:  Failed to get the version of the Nginx in PATH","like_count":0,"discussions":[{"author":{"id":1142524,"avatar":"https://static001.geekbang.org/account/avatar/00/11/6e/fc/b25150d7.jpg","nickname":"jawe","note":"","ucode":"6DB8BF50767629","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":352440,"discussion_content":"éœ€è¦å°†nginxçš„å¯æ‰§è¡Œè·¯å¾„åŠ å…¥åˆ°ç¯å¢ƒå˜é‡ä¸­ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1614738203,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":157908,"user_name":"scaat","can_delete":false,"product_type":"c1","uid":1112954,"ip_address":"","ucode":"D313F9063B69A4","user_header":"https://static001.geekbang.org/account/avatar/00/10/fb/7a/5397e0e7.jpg","comment_is_top":false,"comment_ctime":1575280718,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1575280718","product_id":100028301,"comment_content":"resty --shdict &#39;dogs 10m&#39; -e &#39;local dogs = ngx.shared.dogs dogs:get({}) &#39;<br>åœ¨æˆ‘çš„ nginx version: openresty&#47;1.15.8.1 ä¸­ï¼Œå¹¶æ²¡æœ‰å‡ºç°æŠ¥é”™ã€‚<br>è¯·é—®è€å¸ˆï¼Œè¿™æ˜¯æ–°ç‰ˆæœ¬ get å‡½æ•°æ”¯æŒ key çš„ç±»å‹ä¸ºæ•°ç»„äº†ï¼Ÿè¿˜æ˜¯æˆ‘é—æ¼äº†ä»€ä¹ˆï¼Ÿè¿˜æœ›è€å¸ˆèƒ½æŒ‡ç‚¹è¿·æ´¥ã€‚","like_count":0},{"had_liked":false,"id":110364,"user_name":"J.Smile","can_delete":false,"product_type":"c1","uid":1336475,"ip_address":"","ucode":"C4D98DFDBF7584","user_header":"https://static001.geekbang.org/account/avatar/00/14/64/9b/0b578b08.jpg","comment_is_top":false,"comment_ctime":1562242438,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1562242438","product_id":100028301,"comment_content":"å‘¦å‘¦åˆ‡å…‹é—¹","like_count":0},{"had_liked":false,"id":109597,"user_name":"ğŸ˜‘","can_delete":false,"product_type":"c1","uid":1595077,"ip_address":"","ucode":"87FAC0D2DE20FD","user_header":"https://static001.geekbang.org/account/avatar/00/18/56/c5/b19b8fec.jpg","comment_is_top":false,"comment_ctime":1562064167,"is_pvip":false,"replies":[{"id":"40896","content":"ä¸ç”¨è‡ªå·±åŠ é”å“ˆï¼Œshared dict çš„æ“ä½œéƒ½æ˜¯åŸå­æ€§çš„ï¼Œè¿™ç§ç±»ä¼¼åŠ é”çš„å¤„ç†å·²ç»å¸®ä½ è€ƒè™‘åˆ°äº†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1562737013,"ip_address":"","comment_id":109597,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1562064167","product_id":100028301,"comment_content":"æ¸©è€å¸ˆï¼Œå¦‚æœå¤šä¸ªworkerå¹¶å‘å­˜æ•°æ®ï¼Œæ˜¯ä¸æ˜¯éœ€è¦åŠ é”ï¼Œä¾‹å¦‚è¿™æ ·<br>resty --shdict &#39;dogs 10m&#39; -e &#39;local dogs = ngx.shared.dogs<br>local lock= ngx.xxxx.lock<br>lock.lock()<br> dogs:set(&quot;Jim&quot;, 8)<br>lock.unlock()<br> local v = dogs:get(&quot;Jim&quot;)<br> ngx.say(v)<br> &#39;<br>é‚£ä¹ˆä»¥åçš„è¯¾ç¨‹ä¸­ä¼šè®²è§£åˆ°opçš„é”å—ï¼Ÿå‡ºç°æ­»é”æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":456483,"discussion_content":"ä¸ç”¨è‡ªå·±åŠ é”å“ˆï¼Œshared dict çš„æ“ä½œéƒ½æ˜¯åŸå­æ€§çš„ï¼Œè¿™ç§ç±»ä¼¼åŠ é”çš„å¤„ç†å·²ç»å¸®ä½ è€ƒè™‘åˆ°äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562737013,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1081922,"avatar":"https://static001.geekbang.org/account/avatar/00/10/82/42/8b04d489.jpg","nickname":"åˆ˜ä¸¹","note":"","ucode":"66594D1C957E15","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":837,"discussion_content":"shdictå†…éƒ¨å·²ç»åŠ äº†é”","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1562114142,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":109465,"user_name":"å…­ç»´","can_delete":false,"product_type":"c1","uid":1022887,"ip_address":"","ucode":"EB1C15AC06A8DF","user_header":"https://static001.geekbang.org/account/avatar/00/0f/9b/a7/440aff07.jpg","comment_is_top":false,"comment_ctime":1562037561,"is_pvip":false,"replies":[{"id":"40898","content":"lua_shared_dict dogs 10m æ”¾åœ¨ nginx.conf ä¸­æ˜¯å¯¹çš„ã€‚ä½ åœ¨ä»£ç ä¸­æ˜¯å¦‚ä½•å¼•ç”¨ dogs è¿™ä¸ªå…±äº«å­—å…¸çš„å‘¢ï¼Ÿ","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1562737164,"ip_address":"","comment_id":109465,"utype":1}],"discussion_count":3,"race_medal":0,"score":"1562037561","product_id":100028301,"comment_content":"lua_shared_dict dogs 10m; è¿™ä¸€å¥åº”è¯¥æ”¾åœ¨å“ªé‡Œå‘¢ï¼ŸæŒ‰æ–‡ä¸­æè¿°ï¼Œæ”¾åœ¨www&#47;conf&#47;nginx.conf,é€šè¿‡http:&#47;&#47;www.chrono.com&#47;demoè®¿é—®ï¼Œå‡ºç°é”™è¯¯æç¤ºï¼š2019&#47;07&#47;02 11:16:12 [error] 11184#3284: *3 lua entry thread aborted: runtime error: content_by_lua(http.conf:32):2: attempt to index global &#39;dogs&#39; (a nil value)<br>stack traceback:<br>coroutine 0:<br>\tcontent_by_lua(http.conf:32): in main chunk, client: 127.0.0.1, server: localhost, request: &quot;GET &#47;demo HTTP&#47;1.1&quot;, host: &quot;www.chrono.com&quot;","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":456422,"discussion_content":"lua_shared_dict dogs 10m æ”¾åœ¨ nginx.conf ä¸­æ˜¯å¯¹çš„ã€‚ä½ åœ¨ä»£ç ä¸­æ˜¯å¦‚ä½•å¼•ç”¨ dogs è¿™ä¸ªå…±äº«å­—å…¸çš„å‘¢ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562737164,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1105161,"avatar":"https://static001.geekbang.org/account/avatar/00/10/dd/09/feca820a.jpg","nickname":"helloworld","note":"","ucode":"1EECCA0F43E278","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":754,"discussion_content":"restydoc -s lua_shared_dict ä¼šå‘Šè¯‰ä½ è¯¥æ”¾åœ¨é‚£é‡Œ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562042917,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1022452,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/99/f4/e0484cac.jpg","nickname":"å´”ä¼Ÿå","note":"","ucode":"ACDEEDF2A10999","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1105161,"avatar":"https://static001.geekbang.org/account/avatar/00/10/dd/09/feca820a.jpg","nickname":"helloworld","note":"","ucode":"1EECCA0F43E278","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1408,"discussion_content":"åº”è¯¥æ˜¯æ”¾åœ¨httpå—çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562602328,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":754,"ip_address":""},"score":1408,"extra":""}]}]},{"had_liked":false,"id":109440,"user_name":"HelloBug","can_delete":false,"product_type":"c1","uid":1249598,"ip_address":"","ucode":"E61A4AD5C2F724","user_header":"https://static001.geekbang.org/account/avatar/00/13/11/3e/925aa996.jpg","comment_is_top":false,"comment_ctime":1562032902,"is_pvip":true,"discussion_count":2,"race_medal":0,"score":"1562032902","product_id":100028301,"comment_content":"é€šå¸¸é€šè¿‡æœ¬åœ°è°ƒè¯•ã€æ–‡æ¡£ã€ç½‘ä¸Šæœç´¢ã€é‚®ä»¶åˆ—è¡¨è¿™äº›æ–¹å¼è§£å†³~","like_count":0,"discussions":[{"author":{"id":1950389,"avatar":"","nickname":"æ— å…³é£æœˆ","note":"","ucode":"F5979EB048F7FE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":559706,"discussion_content":"è¯·é—®è°ƒè¯•ç”¨çš„ä»€ä¹ˆå·¥å…·","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1648890110,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1661704,"avatar":"https://static001.geekbang.org/account/avatar/00/19/5b/08/b0b0db05.jpg","nickname":"ä¸ä¸å†é™©è®°","note":"","ucode":"A43829E454C067","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":228929,"discussion_content":"æŠ¥é”™ï¼Œç„¶åå„ç§è’™b .\nt/043-shdict.t .. Can&#39;t locate Test/Nginx/Socket/Lua.pm in @INC (@INC contains: /usr/local/lib64/perl5 /usr/local/share/perl5 /usr/lib64/perl5/vendor_perl /usr/share/perl5/vendor_perl /usr/lib64/perl5 /usr/share/perl5 .) at t/043-shdict.t line 2.\nBEGIN failed--compilation aborted at t/043-shdict.t line 2.\nt/043-shdict.t .. Dubious, test returned 2 (wstat 512, 0x200)\nNo subtests run \n\nTest Summary Report\n-------------------\nt/043-shdict.t (Wstat: 512 Tests: 0 Failed: 0)\n  Non-zero exit status: 2\n  Parse errors: No plan found in TAP output\nFiles=1, Tests=0,  0 wallclock secs ( 0.02 usr +  0.00 sys =  0.02 CPU)\nResult: FAIL\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586591408,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":108923,"user_name":"manatee","can_delete":false,"product_type":"c1","uid":1041112,"ip_address":"","ucode":"708D90E7A265BD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/e2/d8/f0562ede.jpg","comment_is_top":false,"comment_ctime":1561938560,"is_pvip":false,"replies":[{"id":"39725","content":"æ˜¯çš„","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1562084671,"ip_address":"","comment_id":108923,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1561938560","product_id":100028301,"comment_content":"æƒ³è¯·é—®ä¸€ä¸‹è€å¸ˆè®²openrestyçš„å®˜æ–¹æ–‡æ¡£æ˜¯æŒ‡å“ªé‡Œçš„å†…å®¹å‘¢ï¼Ÿæ˜¯githubä¸­æ¯ä¸ªæ¨¡å—readmeçš„éƒ¨åˆ†å—","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":456168,"discussion_content":"æ˜¯çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562084671,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}