{"id":41017,"title":"18 | 深入理解StatefulSet（一）：拓扑状态","content":"<p>你好，我是张磊。今天我和你分享的主题是：深入理解StatefulSet之拓扑状态。</p><p>在上一篇文章中，我在结尾处讨论到了Deployment实际上并不足以覆盖所有的应用编排问题。</p><p>造成这个问题的根本原因，在于Deployment对应用做了一个简单化假设。</p><p>它认为，一个应用的所有Pod，是完全一样的。所以，它们互相之间没有顺序，也无所谓运行在哪台宿主机上。需要的时候，Deployment就可以通过Pod模板创建新的Pod；不需要的时候，Deployment就可以“杀掉”任意一个Pod。</p><p>但是，在实际的场景中，并不是所有的应用都可以满足这样的要求。</p><p>尤其是分布式应用，它的多个实例之间，往往有依赖关系，比如：主从关系、主备关系。</p><p>还有就是数据存储类应用，它的多个实例，往往都会在本地磁盘上保存一份数据。而这些实例一旦被杀掉，即便重建出来，实例与数据之间的对应关系也已经丢失，从而导致应用失败。</p><p>所以，这种实例之间有不对等关系，以及实例对外部数据有依赖关系的应用，就被称为“有状态应用”（Stateful Application）。</p><p>容器技术诞生后，大家很快发现，它用来封装“无状态应用”（Stateless Application），尤其是Web服务，非常好用。但是，一旦你想要用容器运行“有状态应用”，其困难程度就会直线上升。而且，这个问题解决起来，单纯依靠容器技术本身已经无能为力，这也就导致了很长一段时间内，“有状态应用”几乎成了容器技术圈子的“忌讳”，大家一听到这个词，就纷纷摇头。</p><!-- [[[read_end]]] --><p>不过，Kubernetes项目还是成为了“第一个吃螃蟹的人”。</p><p>得益于“控制器模式”的设计思想，Kubernetes项目很早就在Deployment的基础上，扩展出了对“有状态应用”的初步支持。这个编排功能，就是：StatefulSet。</p><p>StatefulSet的设计其实非常容易理解。它把真实世界里的应用状态，抽象为了两种情况：</p><ol>\n<li>\n<p><strong>拓扑状态</strong>。这种情况意味着，应用的多个实例之间不是完全对等的关系。这些应用实例，必须按照某些顺序启动，比如应用的主节点A要先于从节点B启动。而如果你把A和B两个Pod删除掉，它们再次被创建出来时也必须严格按照这个顺序才行。并且，新创建出来的Pod，必须和原来Pod的网络标识一样，这样原先的访问者才能使用同样的方法，访问到这个新Pod。</p>\n</li>\n<li>\n<p><strong>存储状态</strong>。这种情况意味着，应用的多个实例分别绑定了不同的存储数据。对于这些应用实例来说，Pod A第一次读取到的数据，和隔了十分钟之后再次读取到的数据，应该是同一份，哪怕在此期间Pod A被重新创建过。这种情况最典型的例子，就是一个数据库应用的多个存储实例。</p>\n</li>\n</ol><p>所以，<strong>StatefulSet的核心功能，就是通过某种方式记录这些状态，然后在Pod被重新创建时，能够为新Pod恢复这些状态。</strong></p><p>在开始讲述StatefulSet的工作原理之前，我就必须<span class=\"orange\">先为你讲解一个Kubernetes项目中非常实用的概念：Headless Service。</span></p><p>我在和你一起讨论Kubernetes架构的时候就曾介绍过，Service是Kubernetes项目中用来将一组Pod暴露给外界访问的一种机制。比如，一个Deployment有3个Pod，那么我就可以定义一个Service。然后，用户只要能访问到这个Service，它就能访问到某个具体的Pod。</p><p>那么，这个Service又是如何被访问的呢？</p><p><strong>第一种方式，是以Service的VIP（Virtual IP，即：虚拟IP）方式</strong>。比如：当我访问10.0.23.1这个Service的IP地址时，10.0.23.1其实就是一个VIP，它会把请求转发到该Service所代理的某一个Pod上。这里的具体原理，我会在后续的Service章节中进行详细介绍。</p><p><strong>第二种方式，就是以Service的DNS方式</strong>。比如：这时候，只要我访问“my-svc.my-namespace.svc.cluster.local”这条DNS记录，就可以访问到名叫my-svc的Service所代理的某一个Pod。</p><p>而在第二种Service DNS的方式下，具体还可以分为两种处理方法：</p><p>第一种处理方法，是Normal Service。这种情况下，你访问“my-svc.my-namespace.svc.cluster.local”解析到的，正是my-svc这个Service的VIP，后面的流程就跟VIP方式一致了。</p><p>而第二种处理方法，正是Headless Service。这种情况下，你访问“my-svc.my-namespace.svc.cluster.local”解析到的，直接就是my-svc代理的某一个Pod的IP地址。<strong>可以看到，这里的区别在于，Headless Service不需要分配一个VIP，而是可以直接以DNS记录的方式解析出被代理Pod的IP地址。</strong></p><p>那么，这样的设计又有什么作用呢？</p><p>想要回答这个问题，我们需要从Headless Service的定义方式看起。</p><p>下面是一个标准的Headless Service对应的YAML文件：</p><pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: nginx\n  labels:\n    app: nginx\nspec:\n  ports:\n  - port: 80\n    name: web\n  clusterIP: None\n  selector:\n    app: nginx\n</code></pre><p>可以看到，所谓的Headless Service，其实仍是一个标准Service的YAML文件。只不过，它的clusterIP字段的值是：None，即：这个Service，没有一个VIP作为“头”。这也就是Headless的含义。所以，这个Service被创建后并不会被分配一个VIP，而是会以DNS记录的方式暴露出它所代理的Pod。</p><p>而它所代理的Pod，依然是采用我在前面第12篇文章<a href=\"https://time.geekbang.org/column/article/40008\">《牛刀小试：我的第一个容器化应用》</a>中提到的Label Selector机制选择出来的，即：所有携带了app=nginx标签的Pod，都会被这个Service代理起来。</p><p>然后关键来了。</p><p>当你按照这样的方式创建了一个Headless Service之后，它所代理的所有Pod的IP地址，都会被绑定一个这样格式的DNS记录，如下所示：</p><pre><code>&lt;pod-name&gt;.&lt;svc-name&gt;.&lt;namespace&gt;.svc.cluster.local\n</code></pre><p>这个DNS记录，正是Kubernetes项目为Pod分配的唯一的“可解析身份”（Resolvable Identity）。</p><p>有了这个“可解析身份”，只要你知道了一个Pod的名字，以及它对应的Service的名字，你就可以非常确定地通过这条DNS记录访问到Pod的IP地址。</p><p>那么，<span class=\"orange\">StatefulSet又是如何使用这个DNS记录来维持Pod的拓扑状态的呢？</span></p><p>为了回答这个问题，现在我们就来编写一个StatefulSet的YAML文件，如下所示：</p><pre><code>apiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: web\nspec:\n  serviceName: &quot;nginx&quot;\n  replicas: 2\n  selector:\n    matchLabels:\n      app: nginx\n  template:\n    metadata:\n      labels:\n        app: nginx\n    spec:\n      containers:\n      - name: nginx\n        image: nginx:1.9.1\n        ports:\n        - containerPort: 80\n          name: web\n</code></pre><p>这个YAML文件，和我们在前面文章中用到的nginx-deployment的唯一区别，就是多了一个serviceName=nginx字段。</p><p>这个字段的作用，就是告诉StatefulSet控制器，在执行控制循环（Control Loop）的时候，请使用nginx这个Headless Service来保证Pod的“可解析身份”。</p><p>所以，当你通过kubectl create创建了上面这个Service和StatefulSet之后，就会看到如下两个对象：</p><pre><code>$ kubectl create -f svc.yaml\n$ kubectl get service nginx\nNAME      TYPE         CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE\nnginx     ClusterIP    None         &lt;none&gt;        80/TCP    10s\n\n$ kubectl create -f statefulset.yaml\n$ kubectl get statefulset web\nNAME      DESIRED   CURRENT   AGE\nweb       2         1         19s\n</code></pre><p>这时候，如果你手比较快的话，还可以通过kubectl的-w参数，即：Watch功能，实时查看StatefulSet创建两个有状态实例的过程：</p><blockquote>\n<p>备注：如果手不够快的话，Pod很快就创建完了。不过，你依然可以通过这个StatefulSet的Events看到这些信息。</p>\n</blockquote><pre><code>$ kubectl get pods -w -l app=nginx\nNAME      READY     STATUS    RESTARTS   AGE\nweb-0     0/1       Pending   0          0s\nweb-0     0/1       Pending   0         0s\nweb-0     0/1       ContainerCreating   0         0s\nweb-0     1/1       Running   0         19s\nweb-1     0/1       Pending   0         0s\nweb-1     0/1       Pending   0         0s\nweb-1     0/1       ContainerCreating   0         0s\nweb-1     1/1       Running   0         20s\n</code></pre><p>通过上面这个Pod的创建过程，我们不难看到，StatefulSet给它所管理的所有Pod的名字，进行了编号，编号规则是：<code>&lt;statefulset name&gt;-&lt;ordinal index&gt;</code>。</p><p>而且这些编号都是从0开始累加，与StatefulSet的每个Pod实例一一对应，绝不重复。</p><p>更重要的是，这些Pod的创建，也是严格按照编号顺序进行的。比如，在web-0进入到Running状态、并且细分状态（Conditions）成为Ready之前，web-1会一直处于Pending状态。</p><blockquote>\n<p>备注：Ready状态再一次提醒了我们，为Pod设置livenessProbe和readinessProbe的重要性。</p>\n</blockquote><p>当这两个Pod都进入了Running状态之后，你就可以查看到它们各自唯一的“网络身份”了。</p><p>我们使用kubectl exec命令进入到容器中查看它们的hostname：</p><pre><code>$ kubectl exec web-0 -- sh -c 'hostname'\nweb-0\n$ kubectl exec web-1 -- sh -c 'hostname'\nweb-1\n</code></pre><p>可以看到，这两个Pod的hostname与Pod名字是一致的，都被分配了对应的编号。接下来，我们再试着以DNS的方式，访问一下这个Headless Service：</p><pre><code>$ kubectl run -i --tty --image busybox:1.28.4 dns-test --restart=Never --rm /bin/sh \n</code></pre><p>通过这条命令，我们启动了一个一次性的Pod，因为--rm意味着Pod退出后就会被删除掉。然后，在这个Pod的容器里面，我们尝试用nslookup命令，解析一下Pod对应的Headless Service：</p><pre><code>$ kubectl run -i --tty --image busybox:1.28.4 dns-test --restart=Never --rm /bin/sh\n$ nslookup web-0.nginx\nServer:    10.0.0.10\nAddress 1: 10.0.0.10 kube-dns.kube-system.svc.cluster.local\n\nName:      web-0.nginx\nAddress 1: 10.244.1.7\n\n$ nslookup web-1.nginx\nServer:    10.0.0.10\nAddress 1: 10.0.0.10 kube-dns.kube-system.svc.cluster.local\n\nName:      web-1.nginx\nAddress 1: 10.244.2.7\n</code></pre><p>从nslookup命令的输出结果中，我们可以看到，在访问web-0.nginx的时候，最后解析到的，正是web-0这个Pod的IP地址；而当访问web-1.nginx的时候，解析到的则是web-1的IP地址。</p><p>这时候，如果你在另外一个Terminal里把这两个“有状态应用”的Pod删掉：</p><pre><code>$ kubectl delete pod -l app=nginx\npod &quot;web-0&quot; deleted\npod &quot;web-1&quot; deleted\n</code></pre><p>然后，再在当前Terminal里Watch一下这两个Pod的状态变化，就会发现一个有趣的现象：</p><pre><code>$ kubectl get pod -w -l app=nginx\nNAME      READY     STATUS              RESTARTS   AGE\nweb-0     0/1       ContainerCreating   0          0s\nNAME      READY     STATUS    RESTARTS   AGE\nweb-0     1/1       Running   0          2s\nweb-1     0/1       Pending   0         0s\nweb-1     0/1       ContainerCreating   0         0s\nweb-1     1/1       Running   0         32s\n</code></pre><p>可以看到，当我们把这两个Pod删除之后，Kubernetes会按照原先编号的顺序，创建出了两个新的Pod。并且，Kubernetes依然为它们分配了与原来相同的“网络身份”：web-0.nginx和web-1.nginx。</p><p>通过这种严格的对应规则，<strong>StatefulSet就保证了Pod网络标识的稳定性</strong>。</p><p>比如，如果web-0是一个需要先启动的主节点，web-1是一个后启动的从节点，那么只要这个StatefulSet不被删除，你访问web-0.nginx时始终都会落在主节点上，访问web-1.nginx时，则始终都会落在从节点上，这个关系绝对不会发生任何变化。</p><p>所以，如果我们再用nslookup命令，查看一下这个新Pod对应的Headless Service的话：</p><pre><code>$ kubectl run -i --tty --image busybox dns-test --restart=Never --rm /bin/sh \n$ nslookup web-0.nginx\nServer:    10.0.0.10\nAddress 1: 10.0.0.10 kube-dns.kube-system.svc.cluster.local\n\nName:      web-0.nginx\nAddress 1: 10.244.1.8\n\n$ nslookup web-1.nginx\nServer:    10.0.0.10\nAddress 1: 10.0.0.10 kube-dns.kube-system.svc.cluster.local\n\nName:      web-1.nginx\nAddress 1: 10.244.2.8\n</code></pre><p>我们可以看到，在这个StatefulSet中，这两个新Pod的“网络标识”（比如：web-0.nginx和web-1.nginx），再次解析到了正确的IP地址（比如：web-0 Pod的IP地址10.244.1.8）。</p><p>通过这种方法，<strong>Kubernetes就成功地将Pod的拓扑状态（比如：哪个节点先启动，哪个节点后启动），按照Pod的“名字+编号”的方式固定了下来</strong>。此外，Kubernetes还为每一个Pod提供了一个固定并且唯一的访问入口，即：这个Pod对应的DNS记录。</p><p>这些状态，在StatefulSet的整个生命周期里都会保持不变，绝不会因为对应Pod的删除或者重新创建而失效。</p><p>不过，相信你也已经注意到了，尽管web-0.nginx这条记录本身不会变，但它解析到的Pod的IP地址，并不是固定的。这就意味着，对于“有状态应用”实例的访问，你必须使用DNS记录或者hostname的方式，而绝不应该直接访问这些Pod的IP地址。</p><h2>总结</h2><p>在今天这篇文章中，我首先和你分享了StatefulSet的基本概念，解释了什么是应用的“状态”。</p><p>紧接着 ，我为你分析了StatefulSet如何保证应用实例之间“拓扑状态”的稳定性。</p><p>如果用一句话来总结的话，你可以这么理解这个过程：</p><blockquote>\n<p>StatefulSet这个控制器的主要作用之一，就是使用Pod模板创建Pod的时候，对它们进行编号，并且按照编号顺序逐一完成创建工作。而当StatefulSet的“控制循环”发现Pod的“实际状态”与“期望状态”不一致，需要新建或者删除Pod进行“调谐”的时候，它会严格按照这些Pod编号的顺序，逐一完成这些操作。</p>\n</blockquote><p>所以，StatefulSet其实可以认为是对Deployment的改良。</p><p>与此同时，通过Headless Service的方式，StatefulSet为每个Pod创建了一个固定并且稳定的DNS记录，来作为它的访问入口。</p><p>实际上，在部署“有状态应用”的时候，应用的每个实例拥有唯一并且稳定的“网络标识”，是一个非常重要的假设。</p><p>在下一篇文章中，我将会继续为你剖析StatefulSet如何处理存储状态。</p><h2>思考题</h2><p>你曾经运维过哪些有拓扑状态的应用呢（比如：主从、主主、主备、一主多从等结构）？你觉得这些应用实例之间的拓扑关系，能否借助这种为Pod实例编号的方式表达出来呢？如果不能，你觉得Kubernetes还应该为你提供哪些支持来管理这个拓扑状态呢？</p><p>感谢你的收听，欢迎你给我留言，也欢迎分享给更多的朋友一起阅读。</p>","neighbors":{"left":{"article_title":"17 | 经典PaaS的记忆：作业副本与水平扩展","id":40906},"right":{"article_title":"19 | 深入理解StatefulSet（二）：存储状态","id":41154}},"comments":[{"had_liked":false,"id":32095,"user_name":"我来也","can_delete":false,"product_type":"c1","uid":1205253,"ip_address":"","ucode":"773D6104F56767","user_header":"https://static001.geekbang.org/account/avatar/00/12/64/05/6989dce6.jpg","comment_is_top":false,"comment_ctime":1539413259,"is_pvip":false,"replies":[{"id":"11620","content":"看来这个镜像确实有问题","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1539429157,"ip_address":"","comment_id":32095,"utype":1}],"discussion_count":4,"race_medal":0,"score":"431036142859","product_id":100015201,"comment_content":"今天按文章中的内容来, 确实也遇到了nslookup 反馈失败的状况.<br>** server can&#39;t find web-0.nginx: NXDOMAIN<br>*** Can&#39;t find web-0.nginx: No answer<br>但是直接ping  web-0.nginx 是可以获取真实ip地址的.<br>确实是如楼下的同学所说, 需要用 busybox:1.28.4 的镜像. 这个是最新版busybox的问题.<br>kubectl run -i --tty --image busybox:1.28.4 dns-test --restart=Never --rm &#47;bin&#47;sh<br>这样就可获得期待的结果了.<br>我也是google到了 https:&#47;&#47;github.com&#47;kubernetes&#47;kubernetes&#47;issues&#47;66924 才知道的.<br>再看楼下的评论,才发现有其他同学也遇到了,且在几天前已经给出了解决方案. 👍<br>新技术确实变化太快了,作者在写文章时用的没问题,也许隔一天因为某个默认镜像修改了,就会出现新的状况.","like_count":101,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426633,"discussion_content":"看来这个镜像确实有问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539429157,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1320487,"avatar":"https://static001.geekbang.org/account/avatar/00/14/26/27/eba94899.jpg","nickname":"罗杰","note":"","ucode":"96BAFAA147341F","race_medal":2,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":362415,"discussion_content":"现在使用最新版本的直接是 connection timed out；使用 1.28.4 can&#39;t resolve &#39;web-0.nginx&#39;","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1616938724,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1205253,"avatar":"https://static001.geekbang.org/account/avatar/00/12/64/05/6989dce6.jpg","nickname":"我来也","note":"","ucode":"773D6104F56767","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1320487,"avatar":"https://static001.geekbang.org/account/avatar/00/14/26/27/eba94899.jpg","nickname":"罗杰","note":"","ucode":"96BAFAA147341F","race_medal":2,"user_type":1,"is_pvip":false},"discussion":{"id":362495,"discussion_content":"其实不同时期，镜像tag相同，实际内容也可能不同的。\n感谢你的反馈，也建议把你的解决办法分享出来哟。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1616947373,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":362415,"ip_address":""},"score":362495,"extra":""}]},{"author":{"id":1435577,"avatar":"https://static001.geekbang.org/account/avatar/00/15/e7/b9/fd311b4e.jpg","nickname":"能猫振振 ","note":"","ucode":"321D18C3A11147","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":588010,"discussion_content":"搞了半天,在外网搜索回来这里了\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1663466072,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":30795,"user_name":"along2018","can_delete":false,"product_type":"c1","uid":1109053,"ip_address":"","ucode":"181A4C5266DCFE","user_header":"https://static001.geekbang.org/account/avatar/00/10/ec/3d/a8b38ce3.jpg","comment_is_top":false,"comment_ctime":1538998931,"is_pvip":false,"replies":[{"id":"11075","content":"对的","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1539004416,"ip_address":"","comment_id":30795,"utype":1}],"discussion_count":5,"race_medal":0,"score":"242057167507","product_id":100015201,"comment_content":"创建statefulset必须要先创建一个headless的service?分两步操作？","like_count":57,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426101,"discussion_content":"对的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539004416,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1702769,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTImicSGGrnTWbXu3snxpYJ1yMGhtwckV3sZq7K1YmscXxDBj2YOTGPA9t5hicGiaJjx3Zvm7ibickGynzg/132","nickname":"武神","note":"","ucode":"EB424DA42D52B1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":398573,"discussion_content":"statefulset非必须使用无头service，前提是没有通过dns访问具体pod的需求","likes_number":5,"is_delete":false,"is_hidden":false,"ctime":1632814615,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1323652,"avatar":"","nickname":"sibyl","note":"","ucode":"0D142011860D69","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":41493,"discussion_content":"headless service给statefulset有状态pod提供了稳定的统一域名，这是有状态服务的重要条件，至于为啥，接着看吧，老师后面一定会讲的，哈哈哈","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1572440277,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1837179,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/08/7b/7f086546.jpg","nickname":"Alex","note":"","ucode":"70806CEA9AB15E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":354901,"discussion_content":"这个是必须的","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1615359492,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1013003,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/75/0b/553d4ec4.jpg","nickname":"逍遥","note":"","ucode":"570969BCFC96EF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":563370,"discussion_content":"我也暂时还没明白为什么正常 svc 不行","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649986624,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":29715,"user_name":"Dillion","can_delete":false,"product_type":"c1","uid":1219687,"ip_address":"","ucode":"502EDF7ECA5569","user_header":"https://static001.geekbang.org/account/avatar/00/12/9c/67/c0128e6c.jpg","comment_is_top":false,"comment_ctime":1538500001,"is_pvip":false,"replies":[{"id":"10847","content":"任何一次pod的更新都会触发statefulset 滚动更新，更新一定会按编号顺序。但如果只是删除那就直接重建当前pod就够了，这并不破坏拓扑状态。当然，必要的时候，你的pod启动命令要能够区分第一次启动和重启，见下一节。","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1538694738,"ip_address":"","comment_id":29715,"utype":1}],"discussion_count":4,"race_medal":0,"score":"169042224545","product_id":100015201,"comment_content":"在上面的例子中，web-0、web-1启动后，此时如果web-0挂了，那在创建web-0的过程中，web-1也会被重新创建一次么？？？也就是如果一个StatefulSet中只有某个Pod挂了，在重启它的时候，如何确保文中说的Pod启动顺序呢？？","like_count":40,"discussions":[{"author":{"id":1837179,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/08/7b/7f086546.jpg","nickname":"Alex","note":"","ucode":"70806CEA9AB15E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":354902,"discussion_content":"有状态应用中有主从节点之分，如果删除主节点，从节点不会变为主节点，而是会重新创建主节点，比如，web-0是主节点，删除后，k8s会重新创建web-0","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1615359619,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":425696,"discussion_content":"任何一次pod的更新都会触发statefulset 滚动更新，更新一定会按编号顺序。但如果只是删除那就直接重建当前pod就够了，这并不破坏拓扑状态。当然，必要的时候，你的pod启动命令要能够区分第一次启动和重启，见下一节。","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1538694738,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2326134,"avatar":"https://static001.geekbang.org/account/avatar/00/23/7e/76/368394bf.jpg","nickname":"哦","note":"","ucode":"C776659DED9D79","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":582122,"discussion_content":"所以这种拓扑关系只是保证pod在启动的时候按照顺序并且名称不变.单个pod在重建的时候并不会影响整个的拓扑关系,所以应该不用重建所有的pods","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1659245938,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2030670,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLrbCic7BckSd3xrawFH5KW0yYtI1uSsIEPFh0FIHxvHv9u6XBKgZCqH13qPbZDHTdqgevXLdGQlEw/132","nickname":"Geek_2a4536","note":"","ucode":"640A0D228B275C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":296929,"discussion_content":"我试着删除了web-0，发现k8s只创建了web-0，正在疑惑呢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596706861,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":30968,"user_name":"千寻","can_delete":false,"product_type":"c1","uid":1058635,"ip_address":"","ucode":"44A559E38819C0","user_header":"https://static001.geekbang.org/account/avatar/00/10/27/4b/170654bb.jpg","comment_is_top":false,"comment_ctime":1539054491,"is_pvip":false,"replies":[{"id":"11142","content":"这咋还跟镜像有关系呢？","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1539057719,"ip_address":"","comment_id":30968,"utype":1}],"discussion_count":1,"race_medal":0,"score":"134683040667","product_id":100015201,"comment_content":"说dns访问不到那个童鞋，不要用latest标签的busybox，用busybox:1.28.4这个tag的就可以了，我也是这样。","like_count":32,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426162,"discussion_content":"这咋还跟镜像有关系呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539057719,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":30354,"user_name":"巩夫建","can_delete":false,"product_type":"c1","uid":1222958,"ip_address":"","ucode":"6B06A4399D2338","user_header":"https://static001.geekbang.org/account/avatar/00/12/a9/2e/01b2839e.jpg","comment_is_top":false,"comment_ctime":1538806305,"is_pvip":false,"replies":[{"id":"10995","content":"只能访问到固定的一个pod。所以说headless service不能替代normal service ","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1538873567,"ip_address":"","comment_id":30354,"utype":1}],"discussion_count":6,"race_medal":0,"score":"104618021409","product_id":100015201,"comment_content":"Headless Service中不通过vip，外部访问的时候，是轮询还是随机还是热备的方式访问到web-0和web-1，dns解析好像没有轮询随机概念吧。","like_count":25,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":425955,"discussion_content":"只能访问到固定的一个pod。所以说headless service不能替代normal service ","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1538873567,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1365153,"avatar":"https://static001.geekbang.org/account/avatar/00/14/d4/a1/84b64b4e.jpg","nickname":"ethan","note":"","ucode":"C2E0C39659D4C5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":385102,"discussion_content":"ping service的域名发现是能够解析到多个pod的ip的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1626880048,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1136329,"avatar":"https://static001.geekbang.org/account/avatar/00/11/56/c9/7b3cd3e0.jpg","nickname":"马振","note":"","ucode":"94234F533219C1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":381882,"discussion_content":"那statefulset中replicas: 2不是毫无意义？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625276504,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1837179,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/08/7b/7f086546.jpg","nickname":"Alex","note":"","ucode":"70806CEA9AB15E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":354903,"discussion_content":"我也有这样的疑惑","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1615359664,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1027343,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ad/0f/cac1535a.jpg","nickname":"大水牛","note":"","ucode":"9CF2B21BA75C0D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1837179,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/08/7b/7f086546.jpg","nickname":"Alex","note":"","ucode":"70806CEA9AB15E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":531852,"discussion_content":"同问","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637423905,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":354903,"ip_address":""},"score":531852,"extra":"{\"user_type\":1}"},{"author":{"id":1261493,"avatar":"https://static001.geekbang.org/account/avatar/00/13/3f/b5/5fe77e16.jpg","nickname":"不经意间","note":"","ucode":"C39D98697ACB8B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1027343,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ad/0f/cac1535a.jpg","nickname":"大水牛","note":"","ucode":"9CF2B21BA75C0D","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":533353,"discussion_content":"这都不是一个场景吧。statefulset描述的是一个不平等关系的拓扑。为啥要轮询呢","likes_number":6,"is_delete":false,"is_hidden":false,"ctime":1637844526,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":531852,"ip_address":""},"score":533353,"extra":"{\"user_type\":1}"}]}]},{"had_liked":false,"id":29761,"user_name":"fldhmily63319","can_delete":false,"product_type":"c1","uid":1220331,"ip_address":"","ucode":"6FFD779498970F","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/PUiby8MibibKcMd88OtDq1c0myEILZjap46fyiaOlML0UlNWzj9NTIEXOhXCCR1tcUibG0I6UoGp59Zj8H5EYwzkY9g/132","comment_is_top":false,"comment_ctime":1538533208,"is_pvip":false,"replies":[{"id":"10739","content":"是，必须用headless service","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1538613649,"ip_address":"","comment_id":29761,"utype":1}],"discussion_count":5,"race_medal":0,"score":"83142911832","product_id":100015201,"comment_content":"我也想问， &quot;Normal Service&quot;和&quot;Headless Service“的应用场景是什么？<br><br>根据文章所说的，”Headless Service不需要分配一个 VIP，而是可以直接以 DNS 记录的方式解析出被代理 Pod 的 IP 地址“，同时由于其编号的严格规定，会按照编号顺序完成创建工作。<br><br>这样是不是说，如果在部署StatefulSet的时候，大部分是推荐使用&quot;Headless Service&quot; ，而不是&quot;Normal Service”呢？","like_count":20,"discussions":[{"author":{"id":1702769,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTImicSGGrnTWbXu3snxpYJ1yMGhtwckV3sZq7K1YmscXxDBj2YOTGPA9t5hicGiaJjx3Zvm7ibickGynzg/132","nickname":"武神","note":"","ucode":"EB424DA42D52B1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":398977,"discussion_content":"这个回答有点不严谨，无头service在statefulset对象下非必须的。除非有强需求需要通过dns访问具体的pod","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1632882534,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":425707,"discussion_content":"是，必须用headless service","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1538613649,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1113864,"avatar":"https://static001.geekbang.org/account/avatar/00/10/ff/08/7c18d8a4.jpg","nickname":"团","note":"","ucode":"D56ABBCE4E4D90","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":414190,"discussion_content":"之前用normal service的方式部署的elasticsearch的statefulset，好像也没什么问题，一直用到现在了。而且看作者的原文，好像也没说statefulset按编号启动pod和headless service有必然关系。搭建的es集群没用headless service，更新时也是按照编号启动的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1636685547,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1027343,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ad/0f/cac1535a.jpg","nickname":"大水牛","note":"","ucode":"9CF2B21BA75C0D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1113864,"avatar":"https://static001.geekbang.org/account/avatar/00/10/ff/08/7c18d8a4.jpg","nickname":"团","note":"","ucode":"D56ABBCE4E4D90","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":531855,"discussion_content":"同疑惑","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637423999,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":414190,"ip_address":""},"score":531855,"extra":"{\"user_type\":1}"}]},{"author":{"id":1201009,"avatar":"https://static001.geekbang.org/account/avatar/00/12/53/71/a4e9f20e.jpg","nickname":"言午木杉","note":"","ucode":"300BEDC1B07DF1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":393070,"discussion_content":"Headless Service 主要是针对 statefulSet 部署的时候提出的概念，有状态的pod主要是指：拓补关系，网络，存储。比如有部署先后关系的pod，有需要特殊绑定pod的 hostname 的网络需求，再或者这个pod的必须绑定一个特定持久化存储，这些都会用到有状态的 statefulSet 部署。而无状态应用，比如web分布式应用这些，不在乎流量落入哪个pod的，直接用 deployment 部署就行了。我理解这两者的区别在这里","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631240207,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":29914,"user_name":"刘欣洲","can_delete":false,"product_type":"c1","uid":1020871,"ip_address":"","ucode":"767B7D80D01623","user_header":"https://static001.geekbang.org/account/avatar/00/0f/93/c7/1640226d.jpg","comment_is_top":false,"comment_ctime":1538604803,"is_pvip":false,"replies":[{"id":"10757","content":"dns是默认插件。你按我前面的部署流程、也就是官方的部署流程，是必然有dns的。看看pod列表debug一下吧。","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1538618207,"ip_address":"","comment_id":29914,"utype":1}],"discussion_count":2,"race_medal":0,"score":"61668146947","product_id":100015201,"comment_content":"访问不到啊<br>&#47; # nslookup web-0.nginx<br>Server:\t\t10.96.0.10<br>Address:\t10.96.0.10:53<br><br>** server can&#39;t find web-0.nginx: NXDOMAIN<br><br>*** Can&#39;t find web-0.nginx: No answer<br><br>是不是需要DNS插件啊， 该如何启动呢？","like_count":15,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":425777,"discussion_content":"dns是默认插件。你按我前面的部署流程、也就是官方的部署流程，是必然有dns的。看看pod列表debug一下吧。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1538618207,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1676966,"avatar":"https://static001.geekbang.org/account/avatar/00/19/96/a6/32a286e0.jpg","nickname":"大雄","note":"","ucode":"5FCFDD3A940801","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":52439,"discussion_content":"我也是这样的问题，你后面解决了吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574051323,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":36726,"user_name":"jssfy","can_delete":false,"product_type":"c1","uid":1137238,"ip_address":"","ucode":"F16353CFE607B7","user_header":"https://static001.geekbang.org/account/avatar/00/11/5a/56/115c6433.jpg","comment_is_top":false,"comment_ctime":1541287162,"is_pvip":false,"replies":[{"id":"13035","content":"pod镜像是一样，但启动pod的命令和初始化流程可以完全不一样啊。可以参考后面的完整案例","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1541338720,"ip_address":"","comment_id":36726,"utype":1}],"discussion_count":1,"race_medal":0,"score":"57375862010","product_id":100015201,"comment_content":"通过这种方法，Kubernetes 就成功地将 Pod 的拓扑状态（比如：哪个节点先启动，哪个节点后启动），按照 Pod 的“名字 + 编号”的方式固定了下来。<br>如上所述，<br>1. 是否可以这样理解：sts在这里只是保留了“名字 + 编号”这种网络身份，而不同网络身份对应的pod其实本质上是一样的，都是同一个模板replicate出来的？<br>2. 这里sts的主要意义是什么呢：仅仅是保证不同网络身份的启动顺序？","like_count":14,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":427983,"discussion_content":"pod镜像是一样，但启动pod的命令和初始化流程可以完全不一样啊。可以参考后面的完整案例","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1541338720,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":44711,"user_name":"Lukri","can_delete":false,"product_type":"c1","uid":1224659,"ip_address":"","ucode":"31495D68FF0897","user_header":"https://static001.geekbang.org/account/avatar/00/12/af/d3/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1543479546,"is_pvip":false,"discussion_count":3,"race_medal":0,"score":"35903217914","product_id":100015201,"comment_content":"加上namespace就可以了。<br>&#47; # ping web-0.nginx.default.svc.cluster.local<br>PING web-0.nginx.default.svc.cluster.local (10.44.0.2): 56 data bytes<br>64 bytes from 10.44.0.2: seq=0 ttl=64 time=0.138 ms<br>64 bytes from 10.44.0.2: seq=1 ttl=64 time=0.089 ms<br>64 bytes from 10.44.0.2: seq=2 ttl=64 time=0.091 ms<br>64 bytes from 10.44.0.2: seq=3 ttl=64 time=0.090 ms<br>64 bytes from 10.44.0.2: seq=4 ttl=64 time=0.093 ms<br>64 bytes from 10.44.0.2: seq=5 ttl=64 time=0.128 ms<br>64 bytes from 10.44.0.2: seq=6 ttl=64 time=0.093 ms<br>64 bytes from 10.44.0.2: seq=7 ttl=64 time=0.091 ms<br>^C<br>--- web-0.nginx.default.svc.cluster.local ping statistics ---<br>8 packets transmitted, 8 packets received, 0% packet loss<br>round-trip min&#47;avg&#47;max = 0.089&#47;0.101&#47;0.138 ms<br>&#47; # nslookup web-0.nginx.default.svc.cluster.local<br>Server:    10.96.0.10<br>Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local<br><br>Name:      web-0.nginx.default.svc.cluster.local<br>Address 1: 10.44.0.2 web-0.nginx.default.svc.cluster.local","like_count":9,"discussions":[{"author":{"id":1037514,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/d4/ca/bdb348db.jpg","nickname":"law","note":"","ucode":"3B664E2667ED63","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":179214,"discussion_content":"我也是能ping，但nslookup不行，好奇怪。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582210385,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2441261,"avatar":"https://static001.geekbang.org/account/avatar/00/25/40/2d/9a766753.jpg","nickname":"郭贻铖","note":"","ucode":"B14B1DB14031F2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1037514,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/d4/ca/bdb348db.jpg","nickname":"law","note":"","ucode":"3B664E2667ED63","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":351012,"discussion_content":"用busybox:1.28.4的镜像就可以了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1614096434,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":179214,"ip_address":""},"score":351012,"extra":""}]},{"author":{"id":1244496,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q3auHgzwzM49ONuR097wB6LqR8nn5kWiaQiaPic1y8UznibDOScQergTj5qeL6zQ4bIicYEkqlMiash3CUCAYmSt9tQA/132","nickname":"哈希碰撞","note":"","ucode":"DF82678E60095D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":2608,"discussion_content":"在pods内能ping通，但是nslookup 不行.\n\n[root@kube1 ~]# kubectl run -i --tty --image busybox dns-test --restart=Never --rm /bin/sh \n\n/ # ping web-0.nginx.default.svc.cluster.local \nPING web-0.nginx.default.svc.cluster.local (10.0.128.8): 56 data bytes\n64 bytes from 10.0.128.8: seq=0 ttl=64 time=0.417 ms\n64 bytes from 10.0.128.8: seq=1 ttl=64 time=0.225 ms\n64 bytes from 10.0.128.8: seq=2 ttl=64 time=0.188 ms\n^C\n--- web-0.nginx.default.svc.cluster.local ping statistics ---\n3 packets transmitted, 3 packets received, 0% packet loss\nround-trip min/avg/max = 0.188/0.276/0.417 ms\n/ # nslookup web-0.nginx.default.svc.cluster.local\nServer:         10.96.0.10\nAddress:        10.96.0.10:53\n\nName:   web-0.nginx.default.svc.cluster.local\nAddress: 10.0.128.8\n\n*** Can&#39;t find web-0.nginx.default.svc.cluster.local: No answer\n\n/ # \n\n\n在物理机上将DNS加到/etc/resolv.conf，尝试dig 、nslookup、ping 一切正常。\necho &#39;nameserver 10.96.0.10&#39; >/etc/resolv.conf\n\n[root@kube3 ~]# dig web-0.nginx.default.svc.cluster.local\n\n; <<>> DiG 9.9.4-RedHat-9.9.4-74.el7_6.1 <<>> web-0.nginx.default.svc.cluster.local\n;; global options: +cmd\n;; Got answer:\n;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 45306\n;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1\n;; WARNING: recursion requested but not available\n\n;; OPT PSEUDOSECTION:\n; EDNS: version: 0, flags:; udp: 4096\n;; QUESTION SECTION:\n;web-0.nginx.default.svc.cluster.local. IN A\n\n;; ANSWER SECTION:\nweb-0.nginx.default.svc.cluster.local. 5 IN A   10.0.128.8\n\n;; Query time: 1 msec\n;; SERVER: 10.96.0.10#53(10.96.0.10)\n;; WHEN: Mon Jul 22 17:11:05 CST 2019\n;; MSG SIZE  rcvd: 119\n\n[root@kube3 ~]# \n[root@kube3 ~]# \n[root@kube3 ~]# nslookup web-0.nginx.default.svc.cluster.local\nServer:         10.96.0.10\nAddress:        10.96.0.10#53\n\nNon-authoritative answer:\nName:   web-0.nginx.default.svc.cluster.local\nAddress: 10.0.128.8\n\n[root@kube3 ~]# \n\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563786682,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":29951,"user_name":"Tim Zhang","can_delete":false,"product_type":"c1","uid":1214499,"ip_address":"","ucode":"4956AC5FE45EE1","user_header":"https://static001.geekbang.org/account/avatar/00/12/88/23/a0966b4d.jpg","comment_is_top":false,"comment_ctime":1538614109,"is_pvip":false,"replies":[{"id":"10755","content":"因为有太多人是自己拿二进制文件DIY部署的，不按kubeadm的流程来","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1538618046,"ip_address":"","comment_id":29951,"utype":1}],"discussion_count":2,"race_medal":0,"score":"31603385181","product_id":100015201,"comment_content":"既然默认有安装dns 为啥还要开启dns插件呢","like_count":8,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":425785,"discussion_content":"因为有太多人是自己拿二进制文件DIY部署的，不按kubeadm的流程来","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1538618046,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1845394,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/28/92/436735f5.jpg","nickname":"晞月520","note":"","ucode":"4F05E02A5C1608","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":284846,"discussion_content":"我是二进制部署的，用了coredns ，k8s 内部服务发现必须要用 dns 来实现。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592659548,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":33716,"user_name":"Plantegg","can_delete":false,"product_type":"c1","uid":1140931,"ip_address":"","ucode":"4C2B78D41C7820","user_header":"https://static001.geekbang.org/account/avatar/00/11/68/c3/8e1a8dbf.jpg","comment_is_top":false,"comment_ctime":1539860476,"is_pvip":false,"replies":[{"id":"12112","content":"busybox就是这么做出来的，正常","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1539876008,"ip_address":"","comment_id":33716,"utype":1}],"discussion_count":1,"race_medal":0,"score":"27309664252","product_id":100015201,"comment_content":"首先busybox镜像的&#47;bin&#47; 下几百个可执行命令的md5签名都是一样的。不能按照正常的ping、nslookup逻辑来理解了。 也就是md5sum &#47;bin&#47;ping 和 md5sum &#47;bin&#47;nslookup 签名一样，我猜测这个可执行命令都是空架子，会被拦截下来。<br>另外就是1.28.4和1.29.3（latest) 的 nslookup 签名也不一样了","like_count":7,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":427034,"discussion_content":"busybox就是这么做出来的，正常","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539876008,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":30011,"user_name":"vx:jiancheng_goon","can_delete":false,"product_type":"c1","uid":1218615,"ip_address":"","ucode":"FD34901B061825","user_header":"https://static001.geekbang.org/account/avatar/00/12/98/37/7f575aec.jpg","comment_is_top":false,"comment_ctime":1538623851,"is_pvip":false,"replies":[{"id":"10793","content":"kubernetes 当然允许你自定义域名了","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1538648773,"ip_address":"","comment_id":30011,"utype":1}],"discussion_count":1,"race_medal":0,"score":"27308427627","product_id":100015201,"comment_content":"service里的dns信息是存在etcd里的嘛？有些应用的pod的域名是自己定义的。而不是k8s创建出来的带有local的域名。我可以更改service里的dns信息嘛？","like_count":6,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":425813,"discussion_content":"kubernetes 当然允许你自定义域名了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1538648773,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":51182,"user_name":"Geek_6bab38","can_delete":false,"product_type":"c1","uid":1261301,"ip_address":"","ucode":"118ED65D80A6B5","user_header":"https://static001.geekbang.org/account/avatar/00/13/3e/f5/ba756775.jpg","comment_is_top":false,"comment_ctime":1545126681,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"23019963161","product_id":100015201,"comment_content":"教程中两个nginx是一块启动：<br>如果是有顺序的，比如redis先启动，然后启动在启动nginx这样子，需要怎样设置呢","like_count":5,"discussions":[{"author":{"id":1635895,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/dQZH4oEsCUjunqCIs4ls8nujhJKxjyJCibk5aXznM2dK2QdxZgLuZXnUZdjxb8XagD0yEPzXDnqFhoZDtpYIHiag/132","nickname":"Ironshuai","note":"","ucode":"392F5DE3762024","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":339329,"discussion_content":"这个可能得需要自己设计按顺序启动的CRD了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609636992,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1218285,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/ed/56731acd.jpg","nickname":"瑞","note":"","ucode":"26F7ABACE0CE69","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":294220,"discussion_content":"这个已经脱离了容器编排的范畴了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595832783,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":30957,"user_name":"IOVE.-Minn","can_delete":false,"product_type":"c1","uid":1227784,"ip_address":"","ucode":"9C637EEEF64057","user_header":"https://static001.geekbang.org/account/avatar/00/12/bc/08/c43f85d9.jpg","comment_is_top":false,"comment_ctime":1539052750,"is_pvip":false,"replies":[{"id":"11148","content":"这说明你不需要通过带编号的dns名字访问这个节点呗，没啥奇怪的","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1539059594,"ip_address":"","comment_id":30957,"utype":1}],"discussion_count":2,"race_medal":0,"score":"23013889230","product_id":100015201,"comment_content":"请教张大佬，当我跑jenkins in k8s的时候是用的statefulset部署的jenkins的master，我关联的service但是却不是无头服务啊，  spec.ports 是用的nodeport  也没有用clusterIP：none这样。但是整个服务也是正常的。这不是和你讲的statefulset必须是关联headless service违背了么？","like_count":6,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426157,"discussion_content":"这说明你不需要通过带编号的dns名字访问这个节点呗，没啥奇怪的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539059594,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1113864,"avatar":"https://static001.geekbang.org/account/avatar/00/10/ff/08/7c18d8a4.jpg","nickname":"团","note":"","ucode":"D56ABBCE4E4D90","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":414216,"discussion_content":"之前通过statefulset搭建的elasticsearch集群也没用headless service，也没什么问题。像老师说的，这时不需要通过带编号的dns名字访问节点。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1636693213,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":29813,"user_name":"兽医","can_delete":false,"product_type":"c1","uid":1182170,"ip_address":"","ucode":"F6C3ADAA409245","user_header":"https://static001.geekbang.org/account/avatar/00/12/09/da/2fbd0760.jpg","comment_is_top":false,"comment_ctime":1538551133,"is_pvip":false,"replies":[{"id":"10742","content":"当然","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1538613746,"ip_address":"","comment_id":29813,"utype":1}],"discussion_count":1,"race_medal":0,"score":"23013387613","product_id":100015201,"comment_content":"请问当需要对StatefulSet进行缩容后，再扩容到原有规模。在涉及变动的Pod中，状态也会被保持吗？","like_count":6,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":425726,"discussion_content":"当然","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1538613746,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":29775,"user_name":"虎虎❤️","can_delete":false,"product_type":"c1","uid":1086535,"ip_address":"","ucode":"157F261E80291A","user_header":"https://static001.geekbang.org/account/avatar/00/10/94/47/75875257.jpg","comment_is_top":false,"comment_ctime":1538537814,"is_pvip":false,"replies":[{"id":"10740","content":"滚动更新的结果一定是版本一样，你说的这个状态只可能是中间状态","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1538613705,"ip_address":"","comment_id":29775,"utype":1}],"discussion_count":1,"race_medal":0,"score":"23013374294","product_id":100015201,"comment_content":"您好。滚动升级的时候，如果新的web-0和老的web-2同时ready，但新老版本不兼容怎么办？","like_count":6,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":425713,"discussion_content":"滚动更新的结果一定是版本一样，你说的这个状态只可能是中间状态","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1538613705,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":95298,"user_name":"Rodinian","can_delete":false,"product_type":"c1","uid":1096181,"ip_address":"","ucode":"10A4E6138B838A","user_header":"https://static001.geekbang.org/account/avatar/00/10/b9/f5/ffc2bb23.jpg","comment_is_top":false,"comment_ctime":1558013397,"is_pvip":false,"replies":[{"id":"36302","content":"service部分会讲解","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1559619346,"ip_address":"","comment_id":95298,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18737882581","product_id":100015201,"comment_content":"一直很好奇，normal service和headless service都可以指定DNS name。那两者的区别是什么？","like_count":5,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":450407,"discussion_content":"service部分会讲解","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1559619346,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":57780,"user_name":"凌","can_delete":false,"product_type":"c1","uid":1257995,"ip_address":"","ucode":"41369B360C794F","user_header":"https://static001.geekbang.org/account/avatar/00/13/32/0b/81ae214b.jpg","comment_is_top":false,"comment_ctime":1546909689,"is_pvip":false,"replies":[{"id":"20978","content":"ip改成用service vip或者dns名字即可","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1547019327,"ip_address":"","comment_id":57780,"utype":1}],"discussion_count":3,"race_medal":0,"score":"18726778873","product_id":100015201,"comment_content":"我们的服务都是通过固定ip+tcp的方式访问的，如果按照kubernetes的理念应该每次先用服务命取得一次ip在建连访问？","like_count":5,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435756,"discussion_content":"ip改成用service vip或者dns名字即可","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547019327,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1005431,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/57/77/046d310b.jpg","nickname":"明月出","note":"","ucode":"F61BC34FDA802D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":389264,"discussion_content":"还有用固定IP的？IP变更的时候怎么办？所有服务替换新IP吗？域名多爽啊改个解析就行","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629196465,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1027343,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ad/0f/cac1535a.jpg","nickname":"大水牛","note":"","ucode":"9CF2B21BA75C0D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1005431,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/57/77/046d310b.jpg","nickname":"明月出","note":"","ucode":"F61BC34FDA802D","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":531858,"discussion_content":"redis- cluster就得绑定监听ip","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637424334,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":389264,"ip_address":""},"score":531858,"extra":"{\"user_type\":1}"}]}]},{"had_liked":false,"id":30210,"user_name":"vx:jiancheng_goon","can_delete":false,"product_type":"c1","uid":1218615,"ip_address":"","ucode":"FD34901B061825","user_header":"https://static001.geekbang.org/account/avatar/00/12/98/37/7f575aec.jpg","comment_is_top":false,"comment_ctime":1538726985,"is_pvip":false,"replies":[{"id":"10903","content":"自己编写网络插件。为什么不能用这个固定的DNS名字替代IP？","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1538794804,"ip_address":"","comment_id":30210,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18718596169","product_id":100015201,"comment_content":"每次pod被重新创建后，都能够保证原来的网络标示，那有什么办法，能够固定ip呢？","like_count":3,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":425897,"discussion_content":"自己编写网络插件。为什么不能用这个固定的DNS名字替代IP？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1538794804,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":34300,"user_name":"zoroyouxi","can_delete":false,"product_type":"c1","uid":1224745,"ip_address":"","ucode":"E0F0B0C5AAEBDF","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIacvl2hoQU10YHABicE8cTu2IKiagWw9wXPiaRcvJfF1tL2ticJVzHGqd7LmTaDuIScvPDhhMOucjUtg/132","comment_is_top":false,"comment_ctime":1540093308,"is_pvip":false,"replies":[{"id":"12250","content":"因为它也依赖于容器自动重启来恢复实例状态。sts其实就是个改造后的deployment。","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1540103679,"ip_address":"","comment_id":34300,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14424995196","product_id":100015201,"comment_content":"实践中有一点疑问，既然sts是pod的实际所有者并不经过rs，那为什么sts声明下的pod的restartpolicy也只能设置成always呢?希望张老师解答谢谢","like_count":4,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":427168,"discussion_content":"因为它也依赖于容器自动重启来恢复实例状态。sts其实就是个改造后的deployment。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1540103679,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":32018,"user_name":"rnn","can_delete":false,"product_type":"c1","uid":1169811,"ip_address":"","ucode":"9DC14B9DCF477D","user_header":"https://static001.geekbang.org/account/avatar/00/11/d9/93/43c876e8.jpg","comment_is_top":false,"comment_ctime":1539385009,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"14424286897","product_id":100015201,"comment_content":"eureka 需要用到stateful set","like_count":4},{"had_liked":false,"id":29849,"user_name":"Tim Zhang","can_delete":false,"product_type":"c1","uid":1214499,"ip_address":"","ucode":"4956AC5FE45EE1","user_header":"https://static001.geekbang.org/account/avatar/00/12/88/23/a0966b4d.jpg","comment_is_top":false,"comment_ctime":1538560978,"is_pvip":false,"replies":[{"id":"10743","content":"kubernetes的dns早就已经是默认安装的了","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1538613790,"ip_address":"","comment_id":29849,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14423462866","product_id":100015201,"comment_content":"statefulset通过dns访问pod 是否必须要启动dns插件？","like_count":3,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":425738,"discussion_content":"kubernetes的dns早就已经是默认安装的了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1538613790,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":29777,"user_name":"虎虎❤️","can_delete":false,"product_type":"c1","uid":1086535,"ip_address":"","ucode":"157F261E80291A","user_header":"https://static001.geekbang.org/account/avatar/00/10/94/47/75875257.jpg","comment_is_top":false,"comment_ctime":1538537919,"is_pvip":false,"replies":[{"id":"10741","content":"用户访问service第一步碰到的东西","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1538613736,"ip_address":"","comment_id":29777,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14423439807","product_id":100015201,"comment_content":"service没有VIP作为头。这个头到底怎么理解呢？还是不太懂什么是头。","like_count":3,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":425714,"discussion_content":"用户访问service第一步碰到的东西","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1538613736,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":198354,"user_name":"Geek__5a7058c04741","can_delete":false,"product_type":"c1","uid":1459027,"ip_address":"","ucode":"2935CC8CEFD8D6","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eq5t5gxISDXa8kQ4enCotKzZfP12U52slq73MApKAy4hVq8y9uoqxmr23zRAEptHSMtBDySAsxl0g/132","comment_is_top":false,"comment_ctime":1585446973,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10175381565","product_id":100015201,"comment_content":"kubectl run -it --image busybox:1.28.4 dns-test --restart=Never --rm &#47;bin&#47;sh<br>运行这个可以正常解析","like_count":2},{"had_liked":false,"id":57174,"user_name":"小西几","can_delete":false,"product_type":"c1","uid":1286375,"ip_address":"","ucode":"ED1DDE17534508","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJjzTQ6HPGw2LWLiaiciaibfdMMlmxEwBkBjxOPxeYynZlBKCf6U1b0ezM9IZYibB6yKR7HpRuAOdtj29Q/132","comment_is_top":false,"comment_ctime":1546672128,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"10136606720","product_id":100015201,"comment_content":"说一个我的经验哈:<br><br>环境(一个master, 一个node, coredns)<br>1. busybox的版本要控制在1.28.4以下  <br> kubectl run -i --tty --image busybox:1.28.4 dns-test --restart=Never --rm &#47;bin&#47;sh  <br>2. 主从节点时间要一致  <br>3. 从节点拷贝主节点的admin.conf文件到从节点  <br>4. 重启kubelet docker  <br>完了之后发现 两天解析不到的dns 竟然成功了 ????","like_count":2,"discussions":[{"author":{"id":1069133,"avatar":"https://static001.geekbang.org/account/avatar/00/10/50/4d/db91e218.jpg","nickname":"sam700000","note":"","ucode":"C2ABDDC56B2D50","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":4746,"discussion_content":"多谢，我直接重启三个节点，然后重装plugin就好了，也不知道是不是之前更改内核的net.bridge.bridge-nf-call-iptables需要重启才行… 我觉得是和这个或者是某个配置需要重启有关","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565701350,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":34504,"user_name":"徐骋","can_delete":false,"product_type":"c1","uid":1223167,"ip_address":"","ucode":"92B63EEE5BB0C8","user_header":"https://static001.geekbang.org/account/avatar/00/12/a9/ff/6b0260e1.jpg","comment_is_top":false,"comment_ctime":1540193277,"is_pvip":false,"replies":[{"id":"12358","content":"对的","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1540260611,"ip_address":"","comment_id":34504,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10130127869","product_id":100015201,"comment_content":"既然Headless service没有VIP，是不是说只能在Kubernetes内部访问通过service name它？","like_count":2,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":427231,"discussion_content":"对的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1540260611,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":34453,"user_name":"Pixar","can_delete":false,"product_type":"c1","uid":1197659,"ip_address":"","ucode":"E653387BA8EA16","user_header":"https://static001.geekbang.org/account/avatar/00/12/46/5b/07858c33.jpg","comment_is_top":false,"comment_ctime":1540176839,"is_pvip":false,"replies":[{"id":"12363","content":"主是正常的当然不用。重启取决于主是不是进入异常了。","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1540260792,"ip_address":"","comment_id":34453,"utype":1}],"discussion_count":2,"race_medal":0,"score":"10130111431","product_id":100015201,"comment_content":"张老师, 还是有个疑问 &quot;statefulset中的pod template都是一样的，那比如说对于主从结构，应用如何知道自己是主还是从呢？而且一旦从挂掉了，为了保证启动顺序，主也要重启？&quot;  这个问题您的回答是 主也要重启. 有一个疑问, 为什么主也要重启, 主是好的呀 RUNNING &amp;&amp; Ready, 这个时候满足了从的启动条件, 从直接启动不就好了吗? 为什么主也要跟着启动一次?","like_count":2,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":427214,"discussion_content":"主是正常的当然不用。重启取决于主是不是进入异常了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1540260792,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1837179,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/08/7b/7f086546.jpg","nickname":"Alex","note":"","ucode":"70806CEA9AB15E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":354909,"discussion_content":"主异常了的话，从要跟着重启吗？\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1615360238,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":30099,"user_name":"北卡","can_delete":false,"product_type":"c1","uid":1218128,"ip_address":"","ucode":"2D947A61689FC6","user_header":"https://static001.geekbang.org/account/avatar/00/12/96/50/bde525b1.jpg","comment_is_top":false,"comment_ctime":1538661629,"is_pvip":false,"replies":[{"id":"10846","content":"具体更新哪个pod，控制循环会决定。如果只是删除操作，那肯定重建当前的pod就够了。但你的pod的启动命令要需要区分第一次启动和重启，下一节会讲。这就是headless service跟normal service的不同。所以你必然要用etcd-0.etcd。","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1538694120,"ip_address":"","comment_id":30099,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10128596221","product_id":100015201,"comment_content":"有两点不太明白的，请教一下。<br>“任何pod的变化都会触发一次statefulset的滚动更新。”<br>这句话怎么理解呢？实际使用上，比如我用statefulset创建了一个3个pod的etcd集群，我删掉etcd-1,etcd-1会马上重新启动，但etcd-0和etcd-2并不会被删掉重建啊。<br><br>headless server是不是只适合于这种用来做集群节点的发现使用，不适合像service那样用来开放服务访问？<br>用nslookup来查看headless server, nslookup etcd, 会返回3个对应pod的ip地址， 但直接去ping etcd的话，每次都会返回同一个pod的ip地址，其他两个地址永远不会被ping到。<br>那我建立集群的时候，去发现节点的ip时，是不是就不能直接简单配置为etcd了呢，而要配置etcd-0.etcd, etcd-1.etcd这样每个都去配置呢？<br><br>","like_count":2,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":425854,"discussion_content":"具体更新哪个pod，控制循环会决定。如果只是删除操作，那肯定重建当前的pod就够了。但你的pod的启动命令要需要区分第一次启动和重启，下一节会讲。这就是headless service跟normal service的不同。所以你必然要用etcd-0.etcd。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1538694120,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":194261,"user_name":"Geek_c22199","can_delete":false,"product_type":"c1","uid":1441876,"ip_address":"","ucode":"1CE5B65513E360","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI2vn8hyjICTCletGs0omz28lhriaZKX2XX9icYzAEon2IEoRnlXqyOia2bEPP0j7T6xexTnr77JJic8w/132","comment_is_top":false,"comment_ctime":1585043244,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5880010540","product_id":100015201,"comment_content":"第二遍看了，很轻松so easy ","like_count":1},{"had_liked":false,"id":63214,"user_name":"Leon📷","can_delete":false,"product_type":"c1","uid":1219496,"ip_address":"","ucode":"B9BBD1EFAAE5A2","user_header":"https://static001.geekbang.org/account/avatar/00/12/9b/a8/6a391c66.jpg","comment_is_top":false,"comment_ctime":1548299807,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5843267103","product_id":100015201,"comment_content":"老师，我在busybox查看statefulset的两个容器web-0， web-1，的地址解析<br>&#47; # nslookup web-0.nginx.test.svc.cluster.local<br>Server:\t\t10.62.45.10<br>Address:\t10.62.45.10:53<br><br>Name:\tweb-0.nginx.test.svc.cluster.local<br>Address: 10.128.31.25<br><br>*** Can&#39;t find web-0.nginx.test.svc.cluster.local: No answer<br><br>&#47; # ^C<br>&#47; # nslookup web-1.nginx.test.svc.cluster.local<br>Server:\t\t10.62.45.10<br>Address:\t10.62.45.10:53<br><br>Name:\tweb-1.nginx.test.svc.cluster.local<br>Address: 10.128.177.140<br><br>*** Can&#39;t find web-1.nginx.test.svc.cluster.local: No answer<br>这个是到底是解析出来了还是没解析出来啊","like_count":1,"discussions":[{"author":{"id":1224659,"avatar":"https://static001.geekbang.org/account/avatar/00/12/af/d3/abb7bfe3.jpg","nickname":"Lukri","note":"","ucode":"31495D68FF0897","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":117475,"discussion_content":"确保每个节点上都有coredns pod。我就是master节点上没有coredns。然后busybox起在master节点上了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578119549,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":46936,"user_name":"Adam","can_delete":false,"product_type":"c1","uid":1305633,"ip_address":"","ucode":"338BA720880E4F","user_header":"https://static001.geekbang.org/account/avatar/00/13/ec/21/b0fe1bfd.jpg","comment_is_top":false,"comment_ctime":1544004571,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5838971867","product_id":100015201,"comment_content":"busybox  latest的这个标签确实不能正常解析，改成1.28.4就可以正常解析。怪了。","like_count":1},{"had_liked":false,"id":31368,"user_name":"IOVE.-Minn","can_delete":false,"product_type":"c1","uid":1227784,"ip_address":"","ucode":"9C637EEEF64057","user_header":"https://static001.geekbang.org/account/avatar/00/12/bc/08/c43f85d9.jpg","comment_is_top":false,"comment_ctime":1539162045,"is_pvip":false,"replies":[{"id":"11288","content":"statefulset 还给pod编号了，这就是拓扑状态啊","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1539173698,"ip_address":"","comment_id":31368,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5834129341","product_id":100015201,"comment_content":"请问，“有状态的是pv，不是副本控制器，statefulset不用pv创建的pod是无状态”这句话是对的么？  是不是其实statefulset是无状态的，其实是给有状态的服务扩容和伸缩？ 那么initcontainer其实只是维护了有状态服务的拓扑状态？<br><br>","like_count":1,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426309,"discussion_content":"statefulset 还给pod编号了，这就是拓扑状态啊","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539173698,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":30555,"user_name":"huan","can_delete":false,"product_type":"c1","uid":1012286,"ip_address":"","ucode":"46CB95F6E4E5FF","user_header":"https://static001.geekbang.org/account/avatar/00/0f/72/3e/534db55d.jpg","comment_is_top":false,"comment_ctime":1538921720,"is_pvip":false,"replies":[{"id":"11064","content":"service部分讲解可以关注一下","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1538998817,"ip_address":"","comment_id":30555,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5833889016","product_id":100015201,"comment_content":"关于nslookup无法解析的问题，debug了下dnspod的log。使用命令 `kubectl logs -f kube-dns-86f4d74b45-28xdg kubedns -n kube-system` 来监视dns pod的log。<br>当 `kubectl delete -f svc.yaml` 的时候，会有一个log出现：<br>`I1007 14:12:32.818523       1 dns.go:555] Could not find endpoints for service &quot;nginx&quot; in namespace &quot;default&quot;. DNS records will be created once endpoints show up.`<br>期待这个问题会随着k8s的学习深入得到解决。<br>","like_count":1,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426035,"discussion_content":"service部分讲解可以关注一下","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1538998817,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":30377,"user_name":"huan","can_delete":false,"product_type":"c1","uid":1012286,"ip_address":"","ucode":"46CB95F6E4E5FF","user_header":"https://static001.geekbang.org/account/avatar/00/0f/72/3e/534db55d.jpg","comment_is_top":false,"comment_ctime":1538816186,"is_pvip":false,"replies":[{"id":"10997","content":"看看dns pod的log？","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1538876584,"ip_address":"","comment_id":30377,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5833783482","product_id":100015201,"comment_content":"同楼上的问题，我这里是按照kubeadm安装的（kube-system中也添加了weave-net），但是nslookup也是报错，不知道为什么。<br><br>不过我在dsn-test的pod中运行 `ping web-1.nginx` 或者 `ping web-1.nginx.default.svc.cluster.local` 都是可以找得到对应的ip的。","like_count":1,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":425967,"discussion_content":"看看dns pod的log？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1538876584,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":30365,"user_name":"extraterrestrial！！","can_delete":false,"product_type":"c1","uid":1017987,"ip_address":"","ucode":"74AE07CA68F6B6","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/GDYkD2X7pXSKUSaUFC8u3TBPaakaibnOBV2NYDc2TNfb8Su9icFMwSod6iaQX5iaGU2gT6xkPuhXeWvY8KaVEZAYzg/132","comment_is_top":false,"comment_ctime":1538809552,"is_pvip":true,"replies":[{"id":"10974","content":"看后面的实践部份","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1538840059,"ip_address":"","comment_id":30365,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5833776848","product_id":100015201,"comment_content":"有同样的问题，statefulset的template配置没有指定主从的选项，要怎么配置主从？ 比如配一个redis的主从？","like_count":1,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":425960,"discussion_content":"看后面的实践部份","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1538840059,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":29850,"user_name":"Tim Zhang","can_delete":false,"product_type":"c1","uid":1214499,"ip_address":"","ucode":"4956AC5FE45EE1","user_header":"https://static001.geekbang.org/account/avatar/00/12/88/23/a0966b4d.jpg","comment_is_top":false,"comment_ctime":1538561006,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5833528302","product_id":100015201,"comment_content":"通过dns访问 必须开启dns插件吗","like_count":1},{"had_liked":false,"id":29752,"user_name":"小小笑儿","can_delete":false,"product_type":"c1","uid":1040354,"ip_address":"","ucode":"CA63CC50DC2091","user_header":"https://static001.geekbang.org/account/avatar/00/0f/df/e2/823a04b4.jpg","comment_is_top":false,"comment_ctime":1538530539,"is_pvip":false,"replies":[{"id":"10738","content":"当然","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1538613613,"ip_address":"","comment_id":29752,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5833497835","product_id":100015201,"comment_content":"statefulset中的pod template都是一样的，那比如说对于主从结构，应用如何知道自己是主还是从呢？而且一旦从挂掉了，为了保证启动顺序，主也要重启？","like_count":1,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":425702,"discussion_content":"当然","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1538613613,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":29741,"user_name":"asdf100","can_delete":false,"product_type":"c1","uid":1043738,"ip_address":"","ucode":"39D8D71453E575","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ed/1a/ce7f7d54.jpg","comment_is_top":false,"comment_ctime":1538528336,"is_pvip":false,"replies":[{"id":"10705","content":"service相关见后面讲解","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1538541089,"ip_address":"","comment_id":29741,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5833495632","product_id":100015201,"comment_content":"那么两种service模式应用场景通常有哪些？","like_count":1,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":425699,"discussion_content":"service相关见后面讲解","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1538541089,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":333667,"user_name":"Geek_a121ad","can_delete":false,"product_type":"c1","uid":1476022,"ip_address":"","ucode":"C102E85AE5F457","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIRiaWicYyZvuH6ROCAsbRjzGYVAvsGbLCUfcII5x3Z8SxhxPBEqm434g1TEUxhCztTJrJ7aR1068rw/132","comment_is_top":false,"comment_ctime":1644464325,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1644464325","product_id":100015201,"comment_content":"如果是headless代理的deployment的方式，dig myPodName.myService.myNameSpace.svc.cluster.local解析不到记录。","like_count":1},{"had_liked":false,"id":330057,"user_name":"无名无姓","can_delete":false,"product_type":"c1","uid":2621412,"ip_address":"","ucode":"487BD5AA2CD305","user_header":"https://static001.geekbang.org/account/avatar/00/27/ff/e4/927547a9.jpg","comment_is_top":false,"comment_ctime":1641779415,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1641779415","product_id":100015201,"comment_content":"也就是说通过DNS进行标识有状态的服务","like_count":0},{"had_liked":false,"id":329826,"user_name":"Chino","can_delete":false,"product_type":"c1","uid":1347181,"ip_address":"","ucode":"0240D89E5F74B4","user_header":"https://static001.geekbang.org/account/avatar/00/14/8e/6d/c68e07ef.jpg","comment_is_top":false,"comment_ctime":1641555498,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1641555498","product_id":100015201,"comment_content":"k8s 1.23.1<br>前面一直苦于nslookup: can&#39;t resolve &#39;web-0.nginx&#39;<br><br>找了一番解决了。 是coredns的问题<br>可以先通过kubectl logs coredns-bf74ffdcb-2gklm -n kube-system（替换自己的pod）<br>看coredns的日志。我这里显示超时了<br>[ERROR] plugin&#47;errors: 2 2444215914457103011.8452912407871087454. HINFO: read udp 10.32.0.3:36779-&gt;183.60.83.19:53: i&#47;o timeout<br>于是我重启了一波coredns，用kubectl rollout restart deployment coredns（替换自己的deployment）<br>接着就好了","like_count":1,"discussions":[{"author":{"id":1125834,"avatar":"https://static001.geekbang.org/account/avatar/00/11/2d/ca/02b0e397.jpg","nickname":"fomy","note":"","ucode":"CD87EA03B1F327","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":560978,"discussion_content":"kubectl rollout restart deployment coredns -n kube-system","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649506535,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1525420,"avatar":"https://static001.geekbang.org/account/avatar/00/17/46/ac/9c324436.jpg","nickname":"抖腿冠军","note":"","ucode":"66162C20658284","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":550493,"discussion_content":"多谢大佬","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644568202,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":329358,"user_name":"孙同学","can_delete":false,"product_type":"c1","uid":1676238,"ip_address":"","ucode":"C6C82400D15336","user_header":"https://static001.geekbang.org/account/avatar/00/19/93/ce/092acd6a.jpg","comment_is_top":false,"comment_ctime":1641300262,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1641300262","product_id":100015201,"comment_content":"两个pod是一样的 保持顺序有什么意义呢","like_count":0},{"had_liked":false,"id":315105,"user_name":"陈斯佳","can_delete":false,"product_type":"c1","uid":1259323,"ip_address":"","ucode":"C236F874FC767A","user_header":"https://static001.geekbang.org/account/avatar/00/13/37/3b/495e2ce6.jpg","comment_is_top":false,"comment_ctime":1633688987,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1633688987","product_id":100015201,"comment_content":"第十八课:深入理解StatefulSet（一）:拓扑状态<br>通过改良deployment,形成了另一个可以用于“有状态”应用的部署的控制器:StatefulSet.它通过Headless service的方式为每个Pod创建了一个固定的DNS记录，来作为访问路口","like_count":0},{"had_liked":false,"id":314898,"user_name":"火娃儿","can_delete":false,"product_type":"c1","uid":1252132,"ip_address":"","ucode":"2704841763FD70","user_header":"https://static001.geekbang.org/account/avatar/00/13/1b/24/1006c208.jpg","comment_is_top":false,"comment_ctime":1633536800,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1633536800","product_id":100015201,"comment_content":"StatefulSet 这个控制器的主要作用之一，就是使用 Pod 模板创建 Pod 的时候，对它们进行编号，并且按照编号顺序逐一完成创建工作。而当 StatefulSet 的“控制循环”发现 Pod 的“实际状态”与“期望状态”不一致，需要新建或者删除 Pod 进行“调谐”的时候，它会严格按照这些 Pod 编号的顺序，逐一完成这些操作。","like_count":0},{"had_liked":false,"id":314598,"user_name":"凡俗","can_delete":false,"product_type":"c1","uid":1977570,"ip_address":"","ucode":"47FBCD66BE5AD4","user_header":"https://static001.geekbang.org/account/avatar/00/1e/2c/e2/afa3867c.jpg","comment_is_top":false,"comment_ctime":1633248601,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1633248601","product_id":100015201,"comment_content":"我们目前使用statefulset的场景多利用了主机名固定的特性，之前有个数据收集服务，其本身使用了消息队列；自己生产然后自己消费，但是它不能只创建一个队列，否则多副本工作时会有重复消费的情况；所以利用主机名我们建了不同的队列，各自生产各自消费","like_count":0},{"had_liked":false,"id":313276,"user_name":"刘強","can_delete":false,"product_type":"c1","uid":1035612,"ip_address":"","ucode":"B2E41BB894A727","user_header":"https://static001.geekbang.org/account/avatar/00/0f/cd/5c/e09eac13.jpg","comment_is_top":false,"comment_ctime":1632362477,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1632362477","product_id":100015201,"comment_content":"这两个个pod的顺序启动什么时候指定了？看大家留言，没有这个疑问吗？","like_count":0},{"had_liked":false,"id":311032,"user_name":"窝窝头","can_delete":false,"product_type":"c1","uid":1063866,"ip_address":"","ucode":"5C2635ED6484F8","user_header":"https://static001.geekbang.org/account/avatar/00/10/3b/ba/3b30dcde.jpg","comment_is_top":false,"comment_ctime":1631025556,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1631025556","product_id":100015201,"comment_content":"几种拓扑状态基本都能通过编号标识，但是我觉得主主就没必要了吧，只需要有headless service就行了吧，没必要有statefulset吧","like_count":0},{"had_liked":false,"id":304943,"user_name":"凉凉","can_delete":false,"product_type":"c1","uid":1325256,"ip_address":"","ucode":"FCCF976E41EF71","user_header":"https://static001.geekbang.org/account/avatar/00/14/38/c8/972a5024.jpg","comment_is_top":false,"comment_ctime":1627713896,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1627713896","product_id":100015201,"comment_content":"Kubernetes 还为每一个 Pod 提供了一个固定并且唯一的访问入口，即：这个 Pod 对应的 DNS 记录。 这个 DNS 存在哪里呢？存在etcd中？","like_count":1},{"had_liked":false,"id":301982,"user_name":"梧桐树","can_delete":false,"product_type":"c1","uid":1349650,"ip_address":"","ucode":"D375A5223CC8E5","user_header":"https://static001.geekbang.org/account/avatar/00/14/98/12/b82dd35b.jpg","comment_is_top":false,"comment_ctime":1626008684,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1626008684","product_id":100015201,"comment_content":"有一个问题百思不得其解。直接在宿主机，即K8S节点上去解析web-1.nginx为啥不成功呢？","like_count":0,"discussions":[{"author":{"id":1272730,"avatar":"https://static001.geekbang.org/account/avatar/00/13/6b/9a/786b1ed8.jpg","nickname":"果粒橙","note":"","ucode":"000B15E28C68B6","race_medal":4,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":415198,"discussion_content":"dns地址没有指定为k8s的kube-dns的地址吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637025628,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":296879,"user_name":"Geek_04e22a","can_delete":false,"product_type":"c1","uid":1184505,"ip_address":"","ucode":"B64FF12EA28BA6","user_header":"https://static001.geekbang.org/account/avatar/00/12/12/f9/7e6e3ac6.jpg","comment_is_top":false,"comment_ctime":1623209149,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1623209149","product_id":100015201,"comment_content":"两个问题<br>1.statefulset如何确认主从<br>2.假设mysql有多组主从，这个需要多个statefulset","like_count":0,"discussions":[{"author":{"id":2179383,"avatar":"https://static001.geekbang.org/account/avatar/00/21/41/37/b89f3d67.jpg","nickname":"我在睡觉","note":"","ucode":"6503B611151D3C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539965,"discussion_content":"这个问题只用statefulset是无法解决的需要一些更高级的特性，比如crd","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639901762,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":291145,"user_name":"董永刚","can_delete":false,"product_type":"c1","uid":1169147,"ip_address":"","ucode":"ADA792B226A6CD","user_header":"https://static001.geekbang.org/account/avatar/00/11/d6/fb/837af7bf.jpg","comment_is_top":false,"comment_ctime":1620050053,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1620050053","product_id":100015201,"comment_content":"通过这个组合<br>&lt;pod-name&gt;.&lt;svc-name&gt;.&lt;namespace&gt;.svc.cluster.local<br>我解析出来为啥是家里宽带的地址<br>我是用的vm虚拟机安装的k8s集群","like_count":0},{"had_liked":false,"id":287029,"user_name":"夜行趁天开","can_delete":false,"product_type":"c1","uid":1605567,"ip_address":"","ucode":"C4FE4617174415","user_header":"https://static001.geekbang.org/account/avatar/00/18/7f/bf/32e380e6.jpg","comment_is_top":false,"comment_ctime":1617751671,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1617751671","product_id":100015201,"comment_content":"老师，如何确定POD的启动顺序？","like_count":0,"discussions":[{"author":{"id":1025679,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a6/8f/12cfdaf8.jpg","nickname":"墙壁上的壁虎","note":"","ucode":"05B8AF3F5B9B9B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":378459,"discussion_content":"-w  watch，模式可以看到pod的启动顺序","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1623231753,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":285469,"user_name":"liyinda0000","can_delete":false,"product_type":"c1","uid":1198421,"ip_address":"","ucode":"12D5C62716DAB6","user_header":"https://static001.geekbang.org/account/avatar/00/12/49/55/b6c9c0f4.jpg","comment_is_top":false,"comment_ctime":1616830597,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1616830597","product_id":100015201,"comment_content":"您好，我测试一下headless service，发现甩headless service任然可以访问，statefulset是推荐使用headless service的吧？原因是防止浪费clusterIP吗？","like_count":0},{"had_liked":false,"id":283509,"user_name":"涂","can_delete":false,"product_type":"c1","uid":1247775,"ip_address":"","ucode":"DC9F3B99A0B4E5","user_header":"https://static001.geekbang.org/account/avatar/00/13/0a/1f/cfeb036d.jpg","comment_is_top":false,"comment_ctime":1615801379,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1615801379","product_id":100015201,"comment_content":"&#47; # nslookup web-1.nginx<br>Server:         10.1.0.10<br>Address:        10.1.0.10:53<br><br>** server can&#39;t find web-1.nginx: NXDOMAIN<br><br>*** Can&#39;t find web-1.nginx: No answer","like_count":0},{"had_liked":false,"id":274931,"user_name":"大雄","can_delete":false,"product_type":"c1","uid":1676966,"ip_address":"","ucode":"5FCFDD3A940801","user_header":"https://static001.geekbang.org/account/avatar/00/19/96/a6/32a286e0.jpg","comment_is_top":false,"comment_ctime":1611220382,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1611220382","product_id":100015201,"comment_content":"老师，我遇到一个问题。 用dns方式访问不到。ip地址是可行的<br><br>[root@master01 Headless-Service]# kubectl exec -it web-0 -- bash<br>root@web-0:&#47;# more &#47;etc&#47;hosts <br># Kubernetes-managed hosts file.<br>127.0.0.1\tlocalhost<br>::1\tlocalhost ip6-localhost ip6-loopback<br>fe00::0\tip6-localnet<br>fe00::0\tip6-mcastprefix<br>fe00::1\tip6-allnodes<br>fe00::2\tip6-allrouters<br>192.168.241.87\tweb-0.nginx.default.svc.cluster.local\tweb-0<br>root@web-0:&#47;# exit<br>[root@master01 Headless-Service]# ping web-0.nginx.default.svc.cluster.local<br><br>^C<br>[root@master01 Headless-Service]# ping 192.168.241.87<br>PING 192.168.241.87 (192.168.241.87) 56(84) bytes of data.<br>64 bytes from 192.168.241.87: icmp_seq=1 ttl=64 time=0.057 ms<br>^C<br>--- 192.168.241.87 ping statistics ---<br>1 packets transmitted, 1 received, 0% packet loss, time 0ms<br>rtt min&#47;avg&#47;max&#47;mdev = 0.057&#47;0.057&#47;0.057&#47;0.000 ms","like_count":0},{"had_liked":false,"id":271783,"user_name":"JackYap","can_delete":false,"product_type":"c1","uid":1693865,"ip_address":"","ucode":"A24F4A944E3541","user_header":"https://wx.qlogo.cn/mmopen/vi_32/WKnAJ3VFxaBHmZR0IMZWic7QcjjNcBCY3NtToTC2LmROZA3OJzPHDT9WbNRplmxtTrrZNAzibsiaGzXlclUIbXksA/132","comment_is_top":false,"comment_ctime":1609809187,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1609809187","product_id":100015201,"comment_content":"请问statefulset在滚动部署的过程中，是按照web-1,web-0这样删除，然后再按web-0,web-1这样创建吗？那在部署的过程中会不会影响到业务的可用性？","like_count":0},{"had_liked":false,"id":268111,"user_name":"Cutler","can_delete":false,"product_type":"c1","uid":1228136,"ip_address":"","ucode":"2EDECFE039845B","user_header":"https://static001.geekbang.org/account/avatar/00/12/bd/68/3fd6428d.jpg","comment_is_top":false,"comment_ctime":1608076646,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1608076646","product_id":100015201,"comment_content":"区块链作为典型的有状态应用，每个节点的配置不一样，节点的启动顺序也有要求，如果用k8s来部署是否能满足需求，与手动部署对比又有什么优势？希望老师能解答一下，谢谢！","like_count":0},{"had_liked":false,"id":253406,"user_name":"Geek_fe4ca5","can_delete":false,"product_type":"c1","uid":2157510,"ip_address":"","ucode":"A4EA5E11904D9A","user_header":"","comment_is_top":false,"comment_ctime":1602729242,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1602729242","product_id":100015201,"comment_content":"老师，源码中，在缩容时有这样一个判断<br>if !isRunningAndReady(condemned[target]) &amp;&amp; monotonic &amp;&amp; condemned[target] != firstUnhealthyPod {<br>\t\t\tklog.V(4).Infof(<br>\t\t\t\t&quot;StatefulSet %s&#47;%s is waiting for Pod %s to be Running and Ready prior to scale down&quot;,<br>\t\t\t\tset.Namespace,<br>\t\t\t\tset.Name,<br>\t\t\t\tfirstUnhealthyPod.Name)<br>\t\t\treturn &amp;status, nil<br>\t\t}<br>if err := ssc.podControl.DeleteStatefulPod(set, condemned[target])<br><br>这意思是，只要当前 pod 是健康的，就可以直接删除吗？不需要等待之前的所有 Pod 都变为 runningAndReady 状态？<br>","like_count":0},{"had_liked":false,"id":250307,"user_name":"Geek_8c2731","can_delete":false,"product_type":"c1","uid":1928194,"ip_address":"","ucode":"A87F938209D65A","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJkGGBK46EQpqE6zWCncMs14Jw95s191Y6pk3x3gQpNrvSc2YWoFEgUxmJWicibGp7XsFFKaZxuTSnA/132","comment_is_top":false,"comment_ctime":1601018700,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1601018700","product_id":100015201,"comment_content":"If you don&#39;t see a command prompt, try pressing enter.<br>&#47; # nslookup web-0.nginx<br>Server:    10.96.0.10<br>Address 1: 10.96.0.10<br><br>nslookup: can&#39;t resolve &#39;web-0.nginx&#39;<br>我出现这个该怎么解决了，所以的方法都尝试了，还是不行，配置什么的都一摸一样了改的","like_count":0},{"had_liked":false,"id":248791,"user_name":"M1racle","can_delete":false,"product_type":"c1","uid":1057144,"ip_address":"","ucode":"CFA981F34AFDA8","user_header":"https://static001.geekbang.org/account/avatar/00/10/21/78/732a2e33.jpg","comment_is_top":false,"comment_ctime":1600311970,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1600311970","product_id":100015201,"comment_content":"请问，在创建 headless service的时候已经通过 matchlabels 指明了要管理的 pod 标签，那么为什么在创建 deployment 的时候还需要指明 serviceName 呢？是只有指明了这个才是 stateful set 模式，才能在创建的时候保持有序么？","like_count":0},{"had_liked":false,"id":233628,"user_name":"YshShiHaoRen","can_delete":false,"product_type":"c1","uid":1267091,"ip_address":"","ucode":"CAD431D770CBB1","user_header":"https://static001.geekbang.org/account/avatar/00/13/55/93/b6968520.jpg","comment_is_top":false,"comment_ctime":1594370857,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1594370857","product_id":100015201,"comment_content":"排查了自己搭建 nslookup 无法访问提情况：<br> kubectl log 查看 coredns pod 的日志，发现有 panic<br>===<br>E0708 13:59:36.600498       1 runtime.go:78] Observed a panic: &quot;invalid memory address or nil pointer dereference&quot; (runtime error: invalid memory address or nil pointer dereference)<br>goroutine 47 [running]:<br>k8s.io&#47;apimachinery&#47;pkg&#47;util&#47;runtime.logPanic(0x19b3740, 0x2d784f0)<br>        &#47;tmp&#47;tmp.GOqnnMkoud&#47;g&#47;pkg&#47;mod&#47;k8s.io&#47;apimachinery@v0.17.2&#47;pkg&#47;util&#47;runtime&#47;runtime.go:74 +0xa3<br>k8s.io&#47;apimachinery&#47;pkg&#47;util&#47;runtime.HandleCrash(0x0, 0x0, 0x0)<br>        &#47;tmp&#47;tmp.GOqnnMkoud&#47;g&#47;pkg&#47;mod&#47;k8s.io&#47;apimachinery@v0.17.2&#47;pkg&#47;util&#47;runtime&#47;runtime.go:48 +0x82<br>panic(0x19b3740, 0x2d784f0)<br>        &#47;tmp&#47;tmp.GOqnnMkoud&#47;go&#47;src&#47;runtime&#47;panic.go:679 +0x1b2<br>github.com&#47;coredns&#47;coredns&#47;plugin&#47;kubernetes&#47;object.(*Endpoints).GetNamespace(0x0, 0x0, 0x7fbfefefc840)<br>====<br>重启了 coredns 的容器后，nslookup 能够正常返回了。","like_count":0},{"had_liked":false,"id":205622,"user_name":"Andy","can_delete":false,"product_type":"c1","uid":1119133,"ip_address":"","ucode":"4BCA899B8E4E85","user_header":"https://static001.geekbang.org/account/avatar/00/11/13/9d/0ff43179.jpg","comment_is_top":false,"comment_ctime":1586689359,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1586689359","product_id":100015201,"comment_content":"打卡。我们开发web应用网络拓扑很简单，一般都是主从。","like_count":0},{"had_liked":false,"id":202862,"user_name":"张伟","can_delete":false,"product_type":"c1","uid":1481715,"ip_address":"","ucode":"854C5A482B6E8F","user_header":"https://static001.geekbang.org/account/avatar/00/16/9b/f3/53706b7e.jpg","comment_is_top":false,"comment_ctime":1586077875,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1586077875","product_id":100015201,"comment_content":"有个细节没看懂，<br>statefulset里面<br>ports: - containerPort: 80 name: web，这里的name是端口的名字？ 这个80端口是开在pod上的？ <br><br>上面已经指定container.name=nginx，为什么pod的名字是web-0而不是nginx-0？<br><br>还有service里面定义的 ports:<br>  - port: 80<br>    name: web<br>这里面的80是service提供服务的端口，对吗？ name=web是这个service的名字？ <br>这里面定义的selector是标记选择了所有app=nginx的pod会被归纳到这个服务下来管理，那statfulset里面的selector定义和service下的selector定义是否有什么关联关系？ ","like_count":0,"discussions":[{"author":{"id":1610260,"avatar":"https://static001.geekbang.org/account/avatar/00/18/92/14/6ca50b3b.jpg","nickname":"大G来了呦","note":"","ucode":"97711D9CCA73B0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":305605,"discussion_content":"颗粒度不用那么小，他是通过statefulset控制的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600014950,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":189354,"user_name":"星期八","can_delete":false,"product_type":"c1","uid":1185504,"ip_address":"","ucode":"34A37F73A48E7F","user_header":"https://static001.geekbang.org/account/avatar/00/12/16/e0/7abad3cc.jpg","comment_is_top":false,"comment_ctime":1584504523,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1584504523","product_id":100015201,"comment_content":"headlessservice的dns记录是在访问了一个pod的时候，始终只会访问到固定的节点上，这样就保证了节点状态不一样，而访问到另一个节点，造成数据不一致的吗？","like_count":0},{"had_liked":false,"id":178606,"user_name":"天影之刃","can_delete":false,"product_type":"c1","uid":1042532,"ip_address":"","ucode":"DBC3B8DD48EDCF","user_header":"https://static001.geekbang.org/account/avatar/00/0f/e8/64/5c9eeb29.jpg","comment_is_top":false,"comment_ctime":1581758245,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1581758245","product_id":100015201,"comment_content":"1、StatefulSet创建之前，无法使用web-0.nginx.default.svc.cluster.local解析域名<br>2、StatefulSet创建之后，其实是用的是&lt;statefulset-name&gt;.&lt;svc-name&gt;.&lt;namespace&gt;.svc.cluster.local解析的域名，如将StatefulSet中的metadata\\ name: web改成metadata\\ name: webs，域名就变成webs-0.nginx.default.svc.cluster.local了<br>因此正文中的“&lt;pod-name&gt;.&lt;svc-name&gt;.&lt;namespace&gt;.svc.cluster.local”是不是有点歧义啊。","like_count":0},{"had_liked":false,"id":155835,"user_name":"helloworld","can_delete":false,"product_type":"c1","uid":1397271,"ip_address":"","ucode":"B62BEA525A64A1","user_header":"https://static001.geekbang.org/account/avatar/00/15/52/17/083d67fb.jpg","comment_is_top":false,"comment_ctime":1574764164,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1574764164","product_id":100015201,"comment_content":"apiVersion: v1<br>kind: Service<br>app: nginx<br>...（省略）<br>---<br>apiVersion: apps&#47;v1<br>kind: StatefulSet<br>serviceName: &quot;nginx&quot;<br>...（省略）<br>您好，请问像这种Yaml, 内容里有两个kind, 如果我通过 rest api（比如 java client） 调用的话，是只能调两次吗？ 还是有一次调用批量处理接口, 如果我分两次调的话，会不会有问题呢。 ","like_count":0},{"had_liked":false,"id":152617,"user_name":"大雄","can_delete":false,"product_type":"c1","uid":1676966,"ip_address":"","ucode":"5FCFDD3A940801","user_header":"https://static001.geekbang.org/account/avatar/00/19/96/a6/32a286e0.jpg","comment_is_top":false,"comment_ctime":1574051166,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1574051166","product_id":100015201,"comment_content":"[root@k8s-master ~]# kubectl get statefulset<br>NAME   READY   AGE<br>web    1&#47;1     16m<br>[root@k8s-master ~]# kubectl get svc<br>NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE<br>kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443&#47;TCP   3d21h<br>nginx        ClusterIP   None         &lt;none&gt;        80&#47;TCP    40m<br>[root@k8s-master ~]# kubectl get svc nginx<br>NAME    TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE<br>nginx   ClusterIP   None         &lt;none&gt;        80&#47;TCP    40m<br>[root@k8s-master ~]# kubectl get statefulset<br>NAME   READY   AGE<br>web    1&#47;1     16m<br>[root@k8s-master ~]# kubectl exec web-0 -- sh -c &#39;hostname&#39;<br>web-0<br>[root@k8s-master ~]#  kubectl run -i --tty --image busybox dns-test --restart=Never --rm &#47;bin&#47;sh<br>&#47; # nslookup web-0.nginx<br>Server:         10.96.0.10<br>Address:        10.96.0.10:53<br><br>** server can&#39;t find web-0.nginx: NXDOMAIN<br><br>*** Can&#39;t find web-0.nginx: No answer<br><br><br>求问，上面这个报错是什么问题？","like_count":0,"discussions":[{"author":{"id":1311001,"avatar":"https://static001.geekbang.org/account/avatar/00/14/01/19/f4da2829.jpg","nickname":"一秒","note":"","ucode":"F149B7F60620BD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":352271,"discussion_content":"指定busybox的版本","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1614670437,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":148391,"user_name":"凯文1985","can_delete":false,"product_type":"c1","uid":1036921,"ip_address":"","ucode":"9A42344649072B","user_header":"https://static001.geekbang.org/account/avatar/00/0f/d2/79/0a432fde.jpg","comment_is_top":false,"comment_ctime":1573001617,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1573001617","product_id":100015201,"comment_content":"对于pod的template基本都是一样的 那么k8s在启动pod的时候只是按照了顺序去启动三个pod 比如0，1，2 那么是怎么决定哪个是master的呢 自己编写脚本来判断如果是0编号就是master吗","like_count":0},{"had_liked":false,"id":146148,"user_name":"sibyl","can_delete":false,"product_type":"c1","uid":1323652,"ip_address":"","ucode":"0D142011860D69","user_header":"","comment_is_top":false,"comment_ctime":1572440153,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1572440153","product_id":100015201,"comment_content":"headless service就像dns一样,能通过它翻译出目标pod的ip，域名就是pod name +service name。而statefulset的pod name的编号是依次的，例如statefulsetName-0,statefulsetName-1，这和deployment的随机编号不同，因此目标pod域名就可认为是固定的了！","like_count":0},{"had_liked":false,"id":139970,"user_name":"MarkFeng","can_delete":false,"product_type":"c1","uid":1220152,"ip_address":"","ucode":"82968C267E4D21","user_header":"https://static001.geekbang.org/account/avatar/00/12/9e/38/2dbe5f46.jpg","comment_is_top":false,"comment_ctime":1570777092,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1570777092","product_id":100015201,"comment_content":"没有按照文章的示例去nslookup，创建了一个2 pod deployment类型的wordpress，一个normal类型的svc。<br>发现deployment的pod hostname 也是pod name，然后，nslookup &lt;pod 2-name&gt;.&lt;normal svc-name&gt;，也能够正确解析出这个pod 2的ip<br>如果这么看，只要controller能够保证pod name不变，normal svc也能保证你通过&lt;pod-name&gt;.&lt;svc-name&gt;解析到pod ip，为何还要强调headless svc呢？","like_count":0},{"had_liked":false,"id":138342,"user_name":"张若初","can_delete":false,"product_type":"c1","uid":1575256,"ip_address":"","ucode":"143B6016CA06D5","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epT7abaupjJFDn2WuwRNY2PzD5gNVpWaclZWNYclUKPm16uyKMrON8wQUicKU2evgpduEDf5CxoFyg/132","comment_is_top":false,"comment_ctime":1570173000,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1570173000","product_id":100015201,"comment_content":"老师，我只买了一门课，但这是我买的质量第三高的课程。","like_count":0,"discussions":[{"author":{"id":1361556,"avatar":"https://static001.geekbang.org/account/avatar/00/14/c6/94/48ca3281.jpg","nickname":"奔跑","note":"","ucode":"A64A0DCA50D9FA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":235353,"discussion_content":"求教另外两高课程是什么","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587037722,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":130946,"user_name":"myriad","can_delete":false,"product_type":"c1","uid":1137781,"ip_address":"","ucode":"9FBBCDE0E13B6B","user_header":"https://static001.geekbang.org/account/avatar/00/11/5c/75/e1ceedf2.jpg","comment_is_top":false,"comment_ctime":1567582051,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1567582051","product_id":100015201,"comment_content":"使用新版本k8s1.15 实验时，发现执行 kubectl delete pod -l app=nginx 后，重新创建的Pod，IP地址也是固定的没变（猜测是当IP地址没有被其他pod使用时，会重新获取delete之前的IP地址）。<br>","like_count":0},{"had_liked":false,"id":130638,"user_name":"火箭","can_delete":false,"product_type":"c1","uid":1202064,"ip_address":"","ucode":"ED7BA0479EAB16","user_header":"https://static001.geekbang.org/account/avatar/00/12/57/90/7a8fbf69.jpg","comment_is_top":false,"comment_ctime":1567499357,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1567499357","product_id":100015201,"comment_content":"nslookup web-0.nginx.default.svc.cluster.local,这样可以解析得到","like_count":0},{"had_liked":false,"id":129620,"user_name":"tuyu","can_delete":false,"product_type":"c1","uid":1448863,"ip_address":"","ucode":"B235325B541408","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/BIRpwViaN51yynIeFonD7QRlwDCVtKibrG956NTxzEqibOZZVjhMMgibOPmd3VicfYxpknZsic1oJq8KicZvXkmmiajuQg/132","comment_is_top":false,"comment_ctime":1567174324,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1567174324","product_id":100015201,"comment_content":"我感觉这个busybox拉不下来, 就算打tag也没有用","like_count":0},{"had_liked":false,"id":123559,"user_name":"sam700000","can_delete":false,"product_type":"c1","uid":1069133,"ip_address":"","ucode":"C2ABDDC56B2D50","user_header":"https://static001.geekbang.org/account/avatar/00/10/50/4d/db91e218.jpg","comment_is_top":false,"comment_ctime":1565701914,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1565701914","product_id":100015201,"comment_content":"我这边在nslookup的时候也遇到了即使是使用busybox:1.28.4镜像也无法解析的问题，并且也ping不到web-0.nginx或者web-0.nginx.default.svc.cluster.local 看了留意的bat2man兄重启解决，我估计是某个配置需要重启才生效，因为我的几个节点在第11节部署k8s之后一直没有重启过，所以就想重启所有节点，这时候我才意识到我不知道如何用合适的方式重启k8s集群…，不过也没管这么多就直接init 6重启了三个节点，重启完之后cpu的使用率很高，估计应用都在不断寻找服务，主要是apiserver etcd这些服务不知道是不是顺序启动的，看到很多对象的状态都是失败的就按照11节重新把plugin都删掉，把无法启动的容器删掉，看到master的基础服务正常后，把plugin重装了，看到服务都正常后，再重复上面的步骤，nslookup就正常了<br>由于对k8s的认识只到18节，先不管了，继续学下去就好…","like_count":0},{"had_liked":false,"id":117321,"user_name":"胡家鹏","can_delete":false,"product_type":"c1","uid":1109940,"ip_address":"","ucode":"1636F84062948B","user_header":"https://static001.geekbang.org/account/avatar/00/10/ef/b4/61fb4dba.jpg","comment_is_top":false,"comment_ctime":1564023826,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1564023826","product_id":100015201,"comment_content":"这种状态保存，只是通过DNS找到指定Pod，而不能保留旧Pod里原有的状态，滚动升级策略没变都是生成一个全新的Pod","like_count":0},{"had_liked":false,"id":115653,"user_name":"shawguo","can_delete":false,"product_type":"c1","uid":1124753,"ip_address":"","ucode":"67AEDBDAFE3F47","user_header":"https://static001.geekbang.org/account/avatar/00/11/29/91/9813a63b.jpg","comment_is_top":false,"comment_ctime":1563683914,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1563683914","product_id":100015201,"comment_content":"“不过，相信你也已经注意到了，尽管 web-0.nginx 这条记录本身不会变，但它解析到的 Pod 的 IP 地址，并不是固定的。这就意味着，对于“有状态应用”实例的访问，你必须使用 DNS 记录或者 hostname 的方式，而绝不应该直接访问这些 Pod 的 IP 地址。”<br>问题：客户端DNS通常刷新频率较低，StatefulSet后端Pod IP发生变化后，会不会存在客户端仍然访问废弃Pod IP的问题？ Kube针对这种情况有什么建议解决方案吗","like_count":0},{"had_liked":false,"id":115650,"user_name":"shawguo","can_delete":false,"product_type":"c1","uid":1124753,"ip_address":"","ucode":"67AEDBDAFE3F47","user_header":"https://static001.geekbang.org/account/avatar/00/11/29/91/9813a63b.jpg","comment_is_top":false,"comment_ctime":1563683677,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1563683677","product_id":100015201,"comment_content":"“与此同时，通过 Headless Service 的方式，StatefulSet 为每个 Pod 创建了一个固定并且稳定的 DNS 记录，来作为它的访问入口。”<br>问题：使用DNS作为StatefulSet的稳定入口但是Pod Ip","like_count":0},{"had_liked":false,"id":91816,"user_name":"HOMO-SUM","can_delete":false,"product_type":"c1","uid":1510465,"ip_address":"","ucode":"F942E464817A9C","user_header":"https://static001.geekbang.org/account/avatar/00/17/0c/41/34654d9f.jpg","comment_is_top":false,"comment_ctime":1557113734,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1557113734","product_id":100015201,"comment_content":"我怎么解析两个pod的ip是一样的？<br>```<br>If you don&#39;t see a command prompt, try pressing enter.<br>&#47; # nslookup web-0.nginx<br>Server:\t\t10.96.0.10<br>Address:\t10.96.0.10:53<br><br>** server can&#39;t find web-0.nginx: NXDOMAIN<br><br>*** Can&#39;t find web-0.nginx: No answer<br><br>&#47; # nslookup web-1.nginx<br>Server:\t\t10.96.0.10<br>Address:\t10.96.0.10:53<br><br>** server can&#39;t find web-1.nginx: NXDOMAIN<br><br>*** Can&#39;t find web-1.nginx: No answer<br><br>&#47; # nslookup web-0.nginx<br>Server:\t\t10.96.0.10<br>Address:\t10.96.0.10:53<br><br>** server can&#39;t find web-0.nginx: NXDOMAIN<br><br>*** Can&#39;t find web-0.nginx: No answer<br><br>&#47; # nslookup web-1.nginx<br>Server:\t\t10.96.0.10<br>Address:\t10.96.0.10:53<br><br>** server can&#39;t find web-1.nginx: NXDOMAIN<br><br>*** Can&#39;t find web-1.nginx: No answer<br><br>&#47; # pod &quot;dns-test&quot; deleted<br>```","like_count":0,"discussions":[{"author":{"id":1146700,"avatar":"https://static001.geekbang.org/account/avatar/00/11/7f/4c/57ecb2de.jpg","nickname":"at三月","note":"","ucode":"DD59AE4EBE8271","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1211,"discussion_content":"需要加上namespace，$ nslookup web-0.nginx.default.svc.cluster.local","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562403457,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":90125,"user_name":"cuikt","can_delete":false,"product_type":"c1","uid":1242702,"ip_address":"","ucode":"9A1DB426CEFEEA","user_header":"https://static001.geekbang.org/account/avatar/00/12/f6/4e/0066303c.jpg","comment_is_top":false,"comment_ctime":1556421139,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1556421139","product_id":100015201,"comment_content":"CNI 使用的是calico，按照本文档部署nginx,通过busybox(用了最新版本，1.28，1.27都这个问题) 验证域名解析，nslookup web-0.nginx 始终无法解析。通过tcpdump 抓取 busybox 网络包，发现其&#47;etc&#47;resolv.conf 配置中options ndots:5 并未启作用，直接通过coredns 做了递归查询（A? web-0.nginx.）。非常遗憾为什么会这样子，怀疑与其内核网络栈有关。后通过tutum&#47;dnsutils 镜像验证解析正常。困扰了两天。希望对后人有些帮助。","like_count":0},{"had_liked":false,"id":53646,"user_name":"xfan","can_delete":false,"product_type":"c1","uid":1315147,"ip_address":"","ucode":"48ED8D498D7F56","user_header":"https://static001.geekbang.org/account/avatar/00/14/11/4b/fa64f061.jpg","comment_is_top":false,"comment_ctime":1545704898,"is_pvip":false,"replies":[{"id":"19524","content":"咋学出这么个结论来……再反复研习一下？","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1545751552,"ip_address":"","comment_id":53646,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1545704898","product_id":100015201,"comment_content":"这个好像很难用在真实场景，我想让pod以指定的顺序启动怎么办，这个好像也是每个pod的状态相同，只是在启动后被statefulset规定的拓扑，然后按照拓扑来运作，很迷惑","like_count":0,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434213,"discussion_content":"咋学出这么个结论来……再反复研习一下？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545751552,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":51091,"user_name":"小谢同学","can_delete":false,"product_type":"c1","uid":1032544,"ip_address":"","ucode":"E809E6BC470631","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c1/60/fc3689d0.jpg","comment_is_top":false,"comment_ctime":1545112978,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1545112978","product_id":100015201,"comment_content":"请问作者为何我用kunectl run创建的busybox 默认nslookup 是53端口而解析不到service域名呢？","like_count":0},{"had_liked":false,"id":49942,"user_name":"龚松","can_delete":false,"product_type":"c1","uid":1024491,"ip_address":"","ucode":"1DDC6BEC5257DF","user_header":"https://static001.geekbang.org/account/avatar/00/0f/a1/eb/8bc935e2.jpg","comment_is_top":false,"comment_ctime":1544794277,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1544794277","product_id":100015201,"comment_content":"这里有个疑问，为何通过序号0、1就固定拓扑关系，是否业务逻辑关系的如何通过序号映射先后顺序的原则暂时未表？","like_count":0},{"had_liked":false,"id":46427,"user_name":"小谢同学","can_delete":false,"product_type":"c1","uid":1032544,"ip_address":"","ucode":"E809E6BC470631","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c1/60/fc3689d0.jpg","comment_is_top":false,"comment_ctime":1543923214,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1543923214","product_id":100015201,"comment_content":"请问可以从node解析headless service 么？","like_count":0},{"had_liked":false,"id":45808,"user_name":"johnson.skiii","can_delete":false,"product_type":"c1","uid":1316924,"ip_address":"","ucode":"F1B6E71B54046C","user_header":"https://static001.geekbang.org/account/avatar/00/14/18/3c/b5a00c1a.jpg","comment_is_top":false,"comment_ctime":1543798858,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1543798858","product_id":100015201,"comment_content":"这个字段的作用，就是告诉 StatefulSet 控制器，在执行控制循环（Control Loop）的时候，请使用 Nginx这个headless service保证POD的“可解析身份”<br><br>张大，上面这句话的意思是不是说，在StatefulSet在进行控制循环的时候，判断的依据是通过Nginx这个headless service去访问“每个按顺序启动的POD”，如果能访问解析（“可解析身份”）则表示控制循环器不需采取措施；","like_count":0},{"had_liked":false,"id":43422,"user_name":"牛逼但","can_delete":false,"product_type":"c1","uid":1318525,"ip_address":"","ucode":"82408296E3F47E","user_header":"","comment_is_top":false,"comment_ctime":1543225141,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1543225141","product_id":100015201,"comment_content":"老师请问下，按照例子创建statefulset之后，执行kubectl get rs，返回No resources found。但是例子中是有replicas:2的，","like_count":0,"discussions":[{"author":{"id":1311254,"avatar":"https://static001.geekbang.org/account/avatar/00/14/02/16/6fe3fe44.jpg","nickname":"tangzc1","note":"","ucode":"78CB596D2F33DC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":4017,"discussion_content":"replicaSet和replica是两回事。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565061055,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":41507,"user_name":"小谢同学","can_delete":false,"product_type":"c1","uid":1032544,"ip_address":"","ucode":"E809E6BC470631","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c1/60/fc3689d0.jpg","comment_is_top":false,"comment_ctime":1542795763,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1542795763","product_id":100015201,"comment_content":"stateful set 直接管理pod而没有rs的话，那么滚动升级或者ab测试这种如何灵活实现？","like_count":0},{"had_liked":false,"id":40001,"user_name":"勤劳的小胖子-libo","can_delete":false,"product_type":"c1","uid":1158344,"ip_address":"","ucode":"5BB20CD5A56568","user_header":"https://static001.geekbang.org/account/avatar/00/11/ac/c8/4b1c0d40.jpg","comment_is_top":false,"comment_ctime":1542434680,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1542434680","product_id":100015201,"comment_content":"一个问题：<br>这里面的kube-dns就是之前安装的coredns吗？<br>NAME                               READY   STATUS    RESTARTS   AGE   IP             NODE         NOMINATED NODE<br>coredns-576cbf47c7-9qcb8           1&#47;1     Running   0          28h   10.244.0.2     kubeadm1     &lt;none&gt;<br>coredns-576cbf47c7-cxfvf           1&#47;1     Running   0          28h   10.244.0.3     kubeadm1     &lt;none&gt;<br><br>一个建议：可以把文章里面的yaml文件弄成代码模式方便大家直接复制吗？","like_count":0},{"had_liked":false,"id":37657,"user_name":"宋晓明","can_delete":false,"product_type":"c1","uid":1146507,"ip_address":"","ucode":"DC866DCE2FBA9E","user_header":"https://static001.geekbang.org/account/avatar/00/11/7e/8b/3cc461b3.jpg","comment_is_top":false,"comment_ctime":1541667688,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1541667688","product_id":100015201,"comment_content":"更新了那么多有点落后了哈，老师，我在删除pod时候发现两个pod的状态同时都是Terminating，并没有老师说的先启动两个正常的pod，再删除停止的pod的情况，是不是跟网络插件有关？我的用kube-router","like_count":0},{"had_liked":false,"id":35348,"user_name":"Caesar","can_delete":false,"product_type":"c1","uid":1253220,"ip_address":"","ucode":"0319C9E19387CD","user_header":"https://static001.geekbang.org/account/avatar/00/13/1f/64/54458855.jpg","comment_is_top":false,"comment_ctime":1540522523,"is_pvip":true,"replies":[{"id":"12619","content":"因为你的case里单独删除pod并不会使其它pod失败啊。","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1540592728,"ip_address":"","comment_id":35348,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1540522523","product_id":100015201,"comment_content":"不管是单独删除web-0，还是单独删除web-1.在我的环境上都没有体现主从这一思想啊，删除web-0，重建的时候也只重建了web-0，而且pod的restart字段也显示为0？","like_count":0,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":427519,"discussion_content":"因为你的case里单独删除pod并不会使其它pod失败啊。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1540592728,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":32723,"user_name":"Yiliu","can_delete":false,"product_type":"c1","uid":1068884,"ip_address":"","ucode":"2CF20B138244B7","user_header":"https://static001.geekbang.org/account/avatar/00/10/4f/54/552bde40.jpg","comment_is_top":false,"comment_ctime":1539679635,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1539679635","product_id":100015201,"comment_content":"...<br>抱歉是我的问题.<br>我以为上面headless的yml是个实例.<br>原来是要执行的创建service的yml.<br>现在可以了, 多谢老师~","like_count":0},{"had_liked":false,"id":32722,"user_name":"Yiliu","can_delete":false,"product_type":"c1","uid":1068884,"ip_address":"","ucode":"2CF20B138244B7","user_header":"https://static001.geekbang.org/account/avatar/00/10/4f/54/552bde40.jpg","comment_is_top":false,"comment_ctime":1539679525,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1539679525","product_id":100015201,"comment_content":"可以看到pod是生成成功的, 并且是running状态.<br>但是service nginx的确是获取不到.<br>但是yml文件里的确有service的定义<br>我试了下去掉双引号结果也一样, 也不是引号的问题.<br><br>delete后重新再apply还是一样的状态.<br>上一个留言写错了, 版本号是1.12.1.<br><br>课程很棒, 边听录音边看文章效率很高, 赞!","like_count":0},{"had_liked":false,"id":32714,"user_name":"Yiliu","can_delete":false,"product_type":"c1","uid":1068884,"ip_address":"","ucode":"2CF20B138244B7","user_header":"https://static001.geekbang.org/account/avatar/00/10/4f/54/552bde40.jpg","comment_is_top":false,"comment_ctime":1539676165,"is_pvip":false,"replies":[{"id":"11916","content":"你确定create过这个service？","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1539677335,"ip_address":"","comment_id":32714,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1539676165","product_id":100015201,"comment_content":"运行了上面的yml文件<br>再# kubectl get service nginx的时候<br>找不到对应的service<br>Error from server (NotFound): services &quot;nginx&quot; not found<br><br>是否是我环境的问题?<br>我现在用的vmware跑了个centos, 用minikube安装的环境.<br>kubernetes版本是12.1.1.","like_count":0,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426866,"discussion_content":"你确定create过这个service？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539677335,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":30100,"user_name":"北卡","can_delete":false,"product_type":"c1","uid":1218128,"ip_address":"","ucode":"2D947A61689FC6","user_header":"https://static001.geekbang.org/account/avatar/00/12/96/50/bde525b1.jpg","comment_is_top":false,"comment_ctime":1538661995,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1538661995","product_id":100015201,"comment_content":"我看了网上etcd集群的yaml,确实是用脚本直接去配置pod的dns name的。","like_count":0},{"had_liked":false,"id":30046,"user_name":"Majorin_Che","can_delete":false,"product_type":"c1","uid":1131906,"ip_address":"","ucode":"22D3B0A20D4D1F","user_header":"https://static001.geekbang.org/account/avatar/00/11/45/82/164b9073.jpg","comment_is_top":false,"comment_ctime":1538635370,"is_pvip":false,"replies":[{"id":"10833","content":"namespace也不是形同虚设啊","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1538659553,"ip_address":"","comment_id":30046,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1538635370","product_id":100015201,"comment_content":"headless根据label选择pod，那如果另外一个namespace的某个pod有相同的label，会不会被选中","like_count":0,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":425832,"discussion_content":"namespace也不是形同虚设啊","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1538659553,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}