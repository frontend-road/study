{"id":85957,"title":"28 | 任务的取消","content":"<h1>课件及源代码地址</h1><p><a href=\"https://gitee.com/geektime-geekbang/go_learning\">https://gitee.com/geektime-geekbang/go_learning</a></p><h2>书目推荐</h2><p><a href=\"time://mall?url=https%3A%2F%2Fh5.youzan.com%2Fv2%2Fgoods%2F1ycmk3uob0ryw\">《计算机程序的构造和解释》</a></p>","comments":[{"had_liked":false,"id":79014,"user_name":"亚东","can_delete":false,"product_type":"c3","uid":1207629,"ip_address":"","ucode":"D76E7F593D6CBA","user_header":"https://static001.geekbang.org/account/avatar/00/12/6d/4d/ada0aa8a.jpg","comment_is_top":false,"comment_ctime":1553323184,"is_pvip":false,"replies":[{"id":28829,"content":"struct{}表示空结构，第二个表示实例化这个空结构","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1553347809,"ip_address":"","comment_id":79014,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"strict{}{}，作为赋值的时候，为什么有两个{}?","like_count":12,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":444325,"discussion_content":"struct{}表示空结构，第二个表示实例化这个空结构","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1553347809,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1105161,"avatar":"https://static001.geekbang.org/account/avatar/00/10/dd/09/feca820a.jpg","nickname":"helloworld","note":"","ucode":"1EECCA0F43E278","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":47324,"discussion_content":"mark","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573312788,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":137233,"user_name":"Aiden","can_delete":false,"product_type":"c3","uid":1397688,"ip_address":"","ucode":"B29CB52C2512A7","user_header":"https://static001.geekbang.org/account/avatar/00/15/53/b8/dee6b4f6.jpg","comment_is_top":false,"comment_ctime":1569662141,"is_pvip":false,"replies":[{"id":52940,"content":"func isCancelled(cancelChan chan struct{}) bool {\n\tselect {\n\tcase &lt;-cancelChan:\n\t\treturn true\n\tdefault:\n\t\treturn false\n\t}\n}\n\nclose(cancelChan)会使所有处于处于阻塞等待状态的，消息接收者（&lt;-cancelChan)返回，所以上面的代码case &lt;-cancelChan分支就会执行下去，返回true","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1569836641,"ip_address":"","comment_id":137233,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"老师您好，\nfunc cancel_1传给channel一个值，isCancelled取出一个值返回true容易理解，\n在func cancel_2中，函数close了channel后，为什么isCancelled函数依然返回true？\n我改写了该程序如下，&lt;-cancelCh自己返回的bool值在close的情况下返回的就是false，这里应该怎么理解？\nfunc TestCancel(t *testing.T) {\n\tcancelChan := make(chan int, 0)\n\tfor i := 0; i &lt; 5; i++ {\n\t\tgo func(i int, cancelCh chan int) {\n\t\t\tfor {\n\t\t\t\tif _, ok := &lt;-cancelCh; !ok {&#47;&#47;这里ok=false？\n\t\t\t\t\tbreak\n\t\t\t\t}\n\t\t\t\ttime.Sleep(time.Millisecond * 5)\n\t\t\t}\n\t\t\tfmt.Println(i, &quot;Cancelled&quot;)\n\t\t}(i, cancelChan)\n\t}\n\tclose(cancelChan)\n\ttime.Sleep(time.Second * 1)\n}","like_count":3,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":468994,"discussion_content":"func isCancelled(cancelChan chan struct{}) bool {\n\tselect {\n\tcase &amp;lt;-cancelChan:\n\t\treturn true\n\tdefault:\n\t\treturn false\n\t}\n}\n\nclose(cancelChan)会使所有处于处于阻塞等待状态的，消息接收者（&amp;lt;-cancelChan)返回，所以上面的代码case &amp;lt;-cancelChan分支就会执行下去，返回true","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1569836641,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1491655,"avatar":"https://static001.geekbang.org/account/avatar/00/16/c2/c7/670f8b6c.jpg","nickname":"Van","note":"","ucode":"35E576FD0AD79B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":191540,"discussion_content":"close(cancelChan) 促使所有处于阻塞等待状态的消息接收者返回，即使没有消息产生接收者也会返回对应类型的空值，这么理解对吗？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1582994543,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1400034,"avatar":"https://static001.geekbang.org/account/avatar/00/15/5c/e2/0c9380cb.jpg","nickname":"志铭","note":"","ucode":"64672FFF635853","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1491655,"avatar":"https://static001.geekbang.org/account/avatar/00/16/c2/c7/670f8b6c.jpg","nickname":"Van","note":"","ucode":"35E576FD0AD79B","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":548678,"discussion_content":"package cancel_chan\n\nimport (\n\t&#34;fmt&#34;\n\t&#34;testing&#34;\n\t&#34;time&#34;\n)\n\nfunc IsCancel(ch chan struct{}) bool {\n\tselect {\n\tcase ret, ok := &lt;-ch:\n\t\tfmt.Println(ret, ok)\n\t\treturn true\n\tdefault:\n\t\treturn false\n\t}\n}\n\nfunc cancel1(ch chan struct{}) {\n\tclose(ch)\n}\n\nfunc cancel2(ch chan struct{}) {\n\tch &lt;- struct{}{}\n}\n\nfunc TestCancelTask(t *testing.T) {\n\tch := make(chan struct{})\n\tfor i := 0; i &lt; 5; i++ {\n\t\tgo func(ch chan struct{}, i int) {\n\t\t\tfor {\n\t\t\t\tif IsCancel(ch) {\n\t\t\t\t\tbreak\n\t\t\t\t}\n\t\t\t\ttime.Sleep(time.Microsecond * 100)\n\t\t\t}\n\t\t\tfmt.Println(i, &#34;Done&#34;)\n\t\t}(ch, i)\n\t}\n\tcancel1(ch)\n\ttime.Sleep(time.Second * 2)\n}\n\n--------------------------------------------------------\n结果\n=== RUN   TestCancelTask\n{} false\n4 Done\n{} false\n{} false\n2 Done\n{} false\n3 Done\n1 Done\n{} false\n0 Done\n--- PASS: TestCancelTask (2.00s)\nPASS\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1643304364,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":191540,"ip_address":"","group_id":0},"score":548678,"extra":""}]}]},{"had_liked":false,"id":250947,"user_name":"Geek_427d0c","can_delete":false,"product_type":"c3","uid":1876823,"ip_address":"","ucode":"D7A04138C4B8CB","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/X4ib36ADEvj76XaKD4OUY9k15KqWCAVCwibPicBxz6BBUfDrVolpYInn8zFOw3JBPtVw3L4Lkibaf2eLPemwGKzAXA/132","comment_is_top":false,"comment_ctime":1601287743,"is_pvip":false,"replies":[{"id":91842,"content":"这是因为ch&lt;-&quot;Hi&quot;这一句就被阻塞了，都没有办法执行到下面的接收部分","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1601386249,"ip_address":"","comment_id":250947,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"老师好，请教一下，为什么下面的程序会一直卡住直到go test的启动超时参数超时：\nfunc TestA(t *testing.T) {\nch := make(chan string)\nch &lt;- &quot;Hi&quot;\nselect {\n  case ret:= &lt;-ch:\n    fmt.Println(&quot;channel receives&quot;, ret)\n  default:\n    t.Log(&quot;default&quot;)\n}\n}","like_count":2,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":506343,"discussion_content":"这是因为ch&amp;lt;-&amp;quot;Hi&amp;quot;这一句就被阻塞了，都没有办法执行到下面的接收部分","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1601386249,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":187418,"user_name":"Kvicii.Y","can_delete":false,"product_type":"c3","uid":1442588,"ip_address":"","ucode":"446BFA633569EA","user_header":"https://static001.geekbang.org/account/avatar/00/16/03/1c/c9fe6738.jpg","comment_is_top":false,"comment_ctime":1584105666,"is_pvip":false,"replies":[{"id":74522,"content":"第一个是方法定义（这里没有入参定义），第二个代表方法调用","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1585358423,"ip_address":"","comment_id":187418,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"func TestChannel(t *testing.T) {\n\n\tchannel := make(chan struct{}, 0)\n\n\tfor i := 0; i &lt; 5; i++ {\n\t\tgo func() {\n\t\t\tfor {\n\t\t\t\tif isCanceled(ch) {\n\t\t\t\t\tbreak\n\t\t\t\t}\n\t\t\t\ttime.Sleep(time.Millisecond * 5)\n\t\t\t}\n\t\t\tfmt.Println(i, &quot;cancel&quot;)\n\t\t}()\n\t}\n\t&#47;&#47; cancel_1(channel)\n\tcancel_2(channel)\n\ttime.Sleep(time.Millisecond * 1)\n}\n我没有在go func()中传入参数也是可以运行的，go func(){}()前后的()有什么意义呢？后一个()代表外部传入参数？第一个()代表形参类型所以需要完全声明？","like_count":2,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":487102,"discussion_content":"第一个是方法定义（这里没有入参定义），第二个代表方法调用","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585358423,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":300258,"user_name":"Roy","can_delete":false,"product_type":"c3","uid":2633127,"ip_address":"","ucode":"2B1675B084D3A6","user_header":"https://static001.geekbang.org/account/avatar/00/28/2d/a7/c7b0c34e.jpg","comment_is_top":false,"comment_ctime":1625065667,"is_pvip":false,"replies":[{"id":108925,"content":"赞啊。给大家分享一下。","user_name":"作者回复","user_name_real":"蔡超","uid":1008262,"ctime":1625276141,"ip_address":"","comment_id":300258,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"老师，您这个用 sleep() 的方案不好，我结合前面学的知识，用 sync.WaitGroup 写了一个优化版，我测试了一下是ok的，老师看看 ok 不？","like_count":1,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":522691,"discussion_content":"赞啊。给大家分享一下。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625276141,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":235918,"user_name":"宝仔","can_delete":false,"product_type":"c3","uid":1013493,"ip_address":"","ucode":"A0F17DFF99DB21","user_header":"https://static001.geekbang.org/account/avatar/00/0f/76/f5/e3f5bd8d.jpg","comment_is_top":false,"comment_ctime":1595243400,"is_pvip":false,"replies":[{"id":87553,"content":"func isCancelled(cancelChan chan struct{}) bool {\n\tselect {\n\tcase &lt;-cancelChan:\n\t\treturn true\n\tdefault:\n\t\treturn false\n\t}\n}\n\n注意一下 select下的default，&lt;-cancelChan阻塞的时候，就会立即运行default分支","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1595598907,"ip_address":"","comment_id":235918,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"通过select来判断任务是否被取消的话，下面的代码都被阻塞了老师，这样time.Sleep(time.Millisecond * 5000)还有什么意义，望老师回答","like_count":0,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":501880,"discussion_content":"func isCancelled(cancelChan chan struct{}) bool {\n\tselect {\n\tcase &amp;lt;-cancelChan:\n\t\treturn true\n\tdefault:\n\t\treturn false\n\t}\n}\n\n注意一下 select下的default，&amp;lt;-cancelChan阻塞的时候，就会立即运行default分支","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595598907,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1013493,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/76/f5/e3f5bd8d.jpg","nickname":"宝仔","note":"","ucode":"A0F17DFF99DB21","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":293696,"discussion_content":"嗯嗯，明白了！谢谢老师百忙之中抽时间回答","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595644691,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":234058,"user_name":"鹤涵","can_delete":false,"product_type":"c3","uid":1021825,"ip_address":"","ucode":"22CBBC13FC97A9","user_header":"https://static001.geekbang.org/account/avatar/00/0f/97/81/c457def1.jpg","comment_is_top":false,"comment_ctime":1594567647,"is_pvip":false,"replies":[{"id":87660,"content":"close chan也会使得等待读取操作马上返回","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1595766794,"ip_address":"","comment_id":234058,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"func isCanceled(cancelCh chan struct{}) bool {\n\tselect {\n\tcase &lt;-cancelCh:\n\t\treturn true\n\tdefault:\n\t\treturn false\n\t}\n}\nchannel close 也会触发select case &lt;-cancelCh 为什么呢","like_count":0,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":501259,"discussion_content":"close chan也会使得等待读取操作马上返回","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595766794,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":90143,"user_name":"二师兄","can_delete":false,"product_type":"c3","uid":1073298,"ip_address":"","ucode":"28D831095D69D5","user_header":"https://static001.geekbang.org/account/avatar/00/10/60/92/ab4f40f6.jpg","comment_is_top":false,"comment_ctime":1556428772,"is_pvip":false,"replies":[{"id":32384,"content":"应该没有问题的，看看你是不是把cancel后面的sleep删除了","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1556508777,"ip_address":"","comment_id":90143,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"```go\nfunc TestCancel(t *testing.T) {\n\tcancelCh := make(chan struct{}, 0)\n\n\tfor i := 0; i &lt; 3; i++ {\n\t\tgo func(i int, cc chan struct{}) {\n\t\t\tfor {\n\t\t\t\tif isCancelled(cc) {\n\t\t\t\t\tbreak\n\t\t\t\t} else {\n\t\t\t\t\tfmt.Println(i, &quot;Not Yet&quot;)\n\t\t\t\t}\n\t\t\t\ttime.Sleep(time.Millisecond * 5)\n\t\t\t}\n\t\t\tfmt.Println(i, &quot;Canceled&quot;)\n\t\t}(i, cancelCh)\n\t}\n\ttime.Sleep(time.Millisecond * 100) &#47;&#47; ???? 如果加上这一行, 就看不到Canceled的输出\n\tcancel2(cancelCh)\n}\n```\n\n如果我在cancel2调用之前, 增加一个sleep, 则只会输出“Not Yet”, 不会看到“Canceled”, 请问老师这是什么原因呢?","like_count":0,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":448403,"discussion_content":"应该没有问题的，看看你是不是把cancel后面的sleep删除了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1556508777,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1056807,"avatar":"https://static001.geekbang.org/account/avatar/00/10/20/27/a6932fbe.jpg","nickname":"虢國技醬","note":"","ucode":"5A192262AA037E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":4185,"discussion_content":"验证了下 有输出的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565195812,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":87381,"user_name":"Ian","can_delete":false,"product_type":"c3","uid":1239054,"ip_address":"","ucode":"E025D2686E673F","user_header":"https://static001.geekbang.org/account/avatar/00/12/e8/0e/8caa9608.jpg","comment_is_top":false,"comment_ctime":1555580017,"is_pvip":false,"replies":[{"id":31417,"content":"close有一种类似广播的效果，所有处于接收等待状态的接收者都会立即返回。你在仔细看一遍视频，并试试示例代码就清楚了。","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1555592635,"ip_address":"","comment_id":87381,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"func cancel_2(cancelChan chan struct{}){\n\tclose(cancelChan)\n}\n这里，为什么都会收到？没弄明白。本节课也听的有点糊涂。","like_count":0,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":447419,"discussion_content":"close有一种类似广播的效果，所有处于接收等待状态的接收者都会立即返回。你在仔细看一遍视频，并试试示例代码就清楚了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1555592635,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":89758,"user_name":"张先森、","can_delete":false,"product_type":"c3","uid":1449299,"ip_address":"","ucode":"CEE436F2F34DE2","user_header":"https://static001.geekbang.org/account/avatar/00/16/1d/53/a7d86ab3.jpg","comment_is_top":false,"comment_ctime":1556257085,"is_pvip":false,"replies":null,"discussion_count":8,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"为什么每次都是4 Canceled ,不应该是从这5个协程里面随机选一个吗？","like_count":9,"discussions":[{"author":{"id":1099379,"avatar":"https://static001.geekbang.org/account/avatar/00/10/c6/73/abb7bfe3.jpg","nickname":"疯琴","note":"","ucode":"82ACAA4A27753D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":53903,"discussion_content":"我也每次都是&#34;4 Done&#34;，我觉得应该跟cpu频率有关系吧，5个协程撒出去以后，cancel_1 执行的时候正好第4个协程逮到 cancel 了，我试了如果在 cancel_1 之前加一点等待时间，就不一定是 4 Done 了。","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1574231282,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1491655,"avatar":"https://static001.geekbang.org/account/avatar/00/16/c2/c7/670f8b6c.jpg","nickname":"Van","note":"","ucode":"35E576FD0AD79B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1099379,"avatar":"https://static001.geekbang.org/account/avatar/00/10/c6/73/abb7bfe3.jpg","nickname":"疯琴","note":"","ucode":"82ACAA4A27753D","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":191546,"discussion_content":"老哥，稳～","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1582994780,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":53903,"ip_address":"","group_id":0},"score":191546,"extra":""}]},{"author":{"id":1198883,"avatar":"https://static001.geekbang.org/account/avatar/00/12/4b/23/eb028d06.jpg","nickname":"AKA_Ares🎤","note":"","ucode":"03DF5ADDE9D772","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":151947,"discussion_content":"根据goroutine的MPG调度模型确实按照理论上应该是随机调度的,在for 循环之前加上fmt.Printf(&#34;go routine:%v \\n&#34;, i)的打印你就能很清晰的看到确实是随机调度的而且也是随机cancel","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1579922234,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1325498,"avatar":"https://static001.geekbang.org/account/avatar/00/14/39/ba/a2b48904.jpg","nickname":"Min","note":"","ucode":"068EBBA531BB21","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":368294,"discussion_content":"我测试了一下，可以多执行几次，4 不一定是第一个 Done。或者将将协程个数改为 1000 每次执行的顺序不见得一样。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618645908,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1020525,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/92/6d/becd841a.jpg","nickname":"escray","note":"","ucode":"1F4204930E47C4","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":366290,"discussion_content":"加一点等待时间，排除缓存对程序的影响，似乎还是会成为一个相对固定的值","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618021875,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1017289,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKDe7Ep3YW87sWJLc9GzgA2z1CSyHI3iaZQpCLzM2O1e30CQywGsMj5cQyh6pTGybvFgN0bTuWE8nA/132","nickname":"风骑","note":"","ucode":"D96526F7F37442","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":140022,"discussion_content":"这块弄明白了么，我也不是很理解，而且不止这个，前几节有个问题也是，按说应该是随机出现的，但都是跟第一次执行的结果一样","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579341607,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1019807,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/8f/9f/e49b68ea.jpg","nickname":"幽弥狂","note":"","ucode":"5AECEA7D6ADF33","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1017289,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKDe7Ep3YW87sWJLc9GzgA2z1CSyHI3iaZQpCLzM2O1e30CQywGsMj5cQyh6pTGybvFgN0bTuWE8nA/132","nickname":"风骑","note":"","ucode":"D96526F7F37442","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":241367,"discussion_content":"我也好多没弄明白，表示这些只能跟着代码敲。原理不明所以","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587399199,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":140022,"ip_address":"","group_id":0},"score":241367,"extra":""},{"author":{"id":1020525,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/92/6d/becd841a.jpg","nickname":"escray","note":"","ucode":"1F4204930E47C4","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1017289,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKDe7Ep3YW87sWJLc9GzgA2z1CSyHI3iaZQpCLzM2O1e30CQywGsMj5cQyh6pTGybvFgN0bTuWE8nA/132","nickname":"风骑","note":"","ucode":"D96526F7F37442","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":366288,"discussion_content":"有的可能是因为程序被缓存了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618021831,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":140022,"ip_address":"","group_id":0},"score":366288,"extra":""}]}]},{"had_liked":false,"id":213870,"user_name":"flow","can_delete":false,"product_type":"c3","uid":1081987,"ip_address":"","ucode":"0AD565ECBF461E","user_header":"https://static001.geekbang.org/account/avatar/00/10/82/83/b96a8b7a.jpg","comment_is_top":false,"comment_ctime":1588580849,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"应该说明一下：这个示例只是单纯利用广播机制达成任务的取消，这个channel是不负责传输数据的","like_count":7,"discussions":[{"author":{"id":1435172,"avatar":"https://static001.geekbang.org/account/avatar/00/15/e6/24/30806a88.jpg","nickname":"right-chen","note":"","ucode":"E0E940E80E7A2D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583140,"discussion_content":"对，当channel关闭时，多个协程监听端获得关闭的状态，执行走一种操作，也是一种广播机制。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659928610,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":300259,"user_name":"Roy","can_delete":false,"product_type":"c3","uid":2633127,"ip_address":"","ucode":"2B1675B084D3A6","user_header":"https://static001.geekbang.org/account/avatar/00/28/2d/a7/c7b0c34e.jpg","comment_is_top":false,"comment_ctime":1625065695,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"package cancel_by_close\n\nimport (\n\t&quot;fmt&quot;\n\t&quot;sync&quot;\n\t&quot;testing&quot;\n\t&quot;time&quot;\n)\n\n&#47;&#47;任务是否已被取消\n&#47;&#47;实现原理：\n&#47;&#47;检查是否从 channel 收到一个消息，如果收到一个消息，我们就返回 true，代表任务已经被取消了\n&#47;&#47;当没有收到消息，channel 会被阻塞，多路选择机制就会走到 default 分支上去。\nfunc isCanceled(cancelChan chan struct{}) bool {\n\tselect {\n\tcase &lt;-cancelChan:\n\t\treturn true\n\tdefault:\n\t\treturn false\n\t}\n}\n\n&#47;&#47;执行任务取消\n&#47;&#47;因为 close() 是一个广播机制，所以所有的协程都会收到消息\nfunc execCancel(cancelChan chan struct{})  {\n\t&#47;&#47; close(cancelChan)会使所有处于处于阻塞等待状态的消息接收者（&lt;-cancelChan)收到消息\n\tclose(cancelChan)\n}\n\n&#47;&#47;利用 CSP, 多路选择机制和 channel 的关闭与广播实现任务取消功能\nfunc TestCancel(t *testing.T) {\n\tvar wg sync.WaitGroup\n\tcancelChan := make(chan struct{}, 0)\n\n\t&#47;&#47;启动 5 个协程\n\tfor i := 0; i &lt; 5; i++ {\n\t\twg.Add(1)\n\t\tgo func(i int, cancelChan chan struct{}, wg *sync.WaitGroup) {\n\t\t\t&#47;&#47;做一个 while(true) 的循环，一直检查任务是否有被取消\n\t\t\tfor {\n\t\t\t\tif isCanceled(cancelChan) {\n\t\t\t\t\tfmt.Println(i, &quot;is Canceled&quot;)\n\t\t\t\t\twg.Done()\n\t\t\t\t\tbreak;\n\t\t\t\t} else {\n\t\t\t\t\t&#47;&#47;其它正常业务逻辑\n\t\t\t\t\ttime.Sleep(time.Millisecond * 5)\n\t\t\t\t}\n\t\t\t}\n\t\t}(i, cancelChan, &amp;wg)\n\t}\n\t&#47;&#47;执行任务取消\n\texecCancel(cancelChan)\n\twg.Wait()\n}\n&#47;*\n=== RUN   TestCancel\n4 is Canceled\n0 is Canceled\n1 is Canceled\n2 is Canceled\n3 is Canceled\n--- PASS: TestCancel (0.00s)\nPASS\n*&#47;","like_count":3,"discussions":[{"author":{"id":1657039,"avatar":"https://static001.geekbang.org/account/avatar/00/19/48/cf/8c88e6c0.jpg","nickname":"Nemo","note":"","ucode":"2B11D18D6FA2AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":611933,"discussion_content":"更清晰了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1680426238,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":133112,"user_name":"方勇(gopher)","can_delete":false,"product_type":"c3","uid":1290625,"ip_address":"","ucode":"D199911C4CFEF5","user_header":"https://static001.geekbang.org/account/avatar/00/13/b1/81/13f23d1e.jpg","comment_is_top":false,"comment_ctime":1568363027,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"这些小例子希望老师能分享一下使用场景，一般情况很少有死循环执行一个任务，等待处理信号，我能想到的应用场景就是做心跳检测，主进程管理子进程，心跳探测异常，所有子进程停止工作。还有多路破解验证码，其他一路成功后，可以通知其他任务停止工作。多路爬虫，搜索，一旦有成功，取消其他任务","like_count":1},{"had_liked":false,"id":100863,"user_name":"李孙科！","can_delete":false,"product_type":"c3","uid":1447691,"ip_address":"","ucode":"B8A16CD1B7A327","user_header":"https://static001.geekbang.org/account/avatar/00/16/17/0b/a29fa2c0.jpg","comment_is_top":false,"comment_ctime":1559657896,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"每次都是4 Canceled 是不是说 cancel_1方法 结束的chan 是不是最后一个启动还在跑的协程","like_count":1},{"had_liked":false,"id":353926,"user_name":"right-chen","can_delete":false,"product_type":"c3","uid":1435172,"ip_address":"北京","ucode":"E0E940E80E7A2D","user_header":"https://static001.geekbang.org/account/avatar/00/15/e6/24/30806a88.jpg","comment_is_top":false,"comment_ctime":1659928989,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"&#47;&#47;改sleep为waitGroup等待\n\nfunc channel_is_cancel(ch chan int) bool {\n\tselect {\n\tcase &lt;-ch:\n\t\treturn true\n\tdefault:\n\t\treturn false\n\t}\n}\n\nfunc cancel_channel(ch chan int) {\n\tclose(ch)\n}\n\n&#47;**\n取消任务\n*&#47;\nfunc TestTaskCancel(t *testing.T) {\n\n\ttask_channel := make(chan int, 100)\n\tvar wg sync.WaitGroup\n\tfor i := 0; i &lt; 5; i++ {\n\t\twg.Add(1)\n\t\tgo func(i int, task_channel chan int) {\n\n\t\t\tfor {\n\t\t\t\tif channel_is_cancel(task_channel) {\n\t\t\t\t\tbreak\n\t\t\t\t}\n\t\t\t\ttime.Sleep(1 * time.Second)\n\t\t\t}\n\t\t\tfmt.Println(&quot;任务&quot;, i, &quot;取消了&quot;)\n\t\t\twg.Done()\n\t\t}(i, task_channel)\n\t}\n\n\tcancel_channel(task_channel)\n\twg.Wait()\n}","like_count":0},{"had_liked":false,"id":346089,"user_name":"水滴","can_delete":false,"product_type":"c3","uid":2914526,"ip_address":"","ucode":"39AD019C0EC22E","user_header":"https://static001.geekbang.org/account/avatar/00/2c/78/de/34a13f85.jpg","comment_is_top":false,"comment_ctime":1652835177,"is_pvip":true,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"代码的git仓库看不了了，昨天还可以看的","like_count":0},{"had_liked":false,"id":287540,"user_name":"escray","can_delete":false,"product_type":"c3","uid":1020525,"ip_address":"","ucode":"1F4204930E47C4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/92/6d/becd841a.jpg","comment_is_top":false,"comment_ctime":1618021902,"is_pvip":true,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"其实 Channel 取消操作和上一讲的 关闭 close 和广播 是密切相关的。Channel 关闭之后，会通知所有和它有关的 Receiver。\n\n比较有意思的地方在于课后的一个留言，为什么总是 channel 4 先被取消？\n\n如果不在调用 cancel 前增加 sleep 的话，我试着把循环中 i &lt; 5 改为其他的值，那么首先被取消的都是最后一个协程。\n\n加一点等待时间，排除缓存对程序的影响，似乎还是会成为一个相对固定的值。\n\n此处必有蹊跷。","like_count":0},{"had_liked":false,"id":121739,"user_name":"虢國技醬","can_delete":false,"product_type":"c3","uid":1056807,"ip_address":"","ucode":"5A192262AA037E","user_header":"https://static001.geekbang.org/account/avatar/00/10/20/27/a6932fbe.jpg","comment_is_top":false,"comment_ctime":1565196238,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"看来老师的课程学会了一个技巧，用test来写一些验证、测试等等demo来运行，以前中是用一个个main包的形式，IDE各种提示main存在等等。而且这样慢慢的对写测试更加熟悉","like_count":0},{"had_liked":false,"id":78702,"user_name":"忽然之间","can_delete":false,"product_type":"c3","uid":1052876,"ip_address":"","ucode":"CA6CF7883735DE","user_header":"https://static001.geekbang.org/account/avatar/00/10/10/cc/9226d3c8.jpg","comment_is_top":false,"comment_ctime":1553220436,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"追课进行时：）","like_count":0,"discussions":[{"author":{"id":1105246,"avatar":"https://static001.geekbang.org/account/avatar/00/10/dd/5e/ddbdde5a.jpg","nickname":"邢宇超","note":"","ucode":"3113F55E60ADE9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":387684,"discussion_content":"老师能手敲一敲代码么。都是复制粘贴有意思么","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628345369,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}