{"id":40743,"title":"06 | 秒杀系统“减库存”设计的核心逻辑","content":"<p>如果要设计一套秒杀系统，那我想你的老板肯定会先对你说：千万不要超卖，这是大前提。</p>\n<p>如果你第一次接触秒杀，那你可能还不太理解，库存100件就卖100件，在数据库里减到0就好了啊，这有什么麻烦的？是的，理论上是这样，但是具体到业务场景中，“减库存”就不是这么简单了。</p>\n<p>例如，我们平常购物都是这样，看到喜欢的商品然后下单，但并不是每个下单请求你都最后付款了。你说系统是用户下单了就算这个商品卖出去了，还是等到用户真正付款了才算卖出了呢？这的确是个问题！</p>\n<p>我们可以先根据减库存是发生在下单阶段还是付款阶段，把减库存做一下划分。</p>\n<h2>减库存有哪几种方式</h2>\n<p>在正常的电商平台购物场景中，用户的实际购买过程一般分为两步：下单和付款。你想买一台iPhone手机，在商品页面点了“立即购买”按钮，核对信息之后点击“提交订单”，这一步称为下单操作。下单之后，你只有真正完成付款操作才能算真正购买，也就是俗话说的“落袋为安”。</p>\n<p>那如果你是架构师，你会在哪个环节完成减库存的操作呢？总结来说，减库存操作一般有如下几个方式：</p>\n<ul>\n<li><strong>下单减库存</strong>，即当买家下单后，在商品的总库存中减去买家购买数量。下单减库存是最简单的减库存方式，也是控制最精确的一种，下单时直接通过数据库的事务机制控制商品库存，这样一定不会出现超卖的情况。但是你要知道，有些人下完单可能并不会付款。</li>\n<li><strong>付款减库存</strong>，即买家下单后，并不立即减库存，而是等到有用户付款后才真正减库存，否则库存一直保留给其他买家。但因为付款时才减库存，如果并发比较高，有可能出现买家下单后付不了款的情况，因为可能商品已经被其他人买走了。</li>\n<li><strong>预扣库存</strong>，这种方式相对复杂一些，买家下单后，库存为其保留一定的时间（如10分钟），超过这个时间，库存将会自动释放，释放后其他买家就可以继续购买。在买家付款前，系统会校验该订单的库存是否还有保留：如果没有保留，则再次尝试预扣；如果库存不足（也就是预扣失败）则不允许继续付款；如果预扣成功，则完成付款并实际地减去库存。</li>\n</ul><!-- [[[read_end]]] -->\n<p>以上这几种减库存的方式都会存在一些问题，下面我们一起来看下。</p>\n<h2>减库存可能存在的问题</h2>\n<p>由于购物过程中存在两步或者多步的操作，因此在不同的操作步骤中减库存，就会存在一些可能被恶意买家利用的漏洞，例如发生恶意下单的情况。</p>\n<p>假如我们采用“下单减库存”的方式，即用户下单后就减去库存，正常情况下，买家下单后付款的概率会很高，所以不会有太大问题。但是有一种场景例外，就是当卖家参加某个活动时，此时活动的有效时间是商品的黄金售卖时间，如果有竞争对手通过恶意下单的方式将该卖家的商品全部下单，让这款商品的库存减为零，那么这款商品就不能正常售卖了。要知道，这些恶意下单的人是不会真正付款的，这正是“下单减库存”方式的不足之处。</p>\n<p>既然“下单减库存”可能导致恶意下单，从而影响卖家的商品销售，那么有没有办法解决呢？你可能会想，采用“付款减库存”的方式是不是就可以了？的确可以。但是，“付款减库存”又会导致另外一个问题：库存超卖。</p>\n<p>假如有100件商品，就可能出现300人下单成功的情况，因为下单时不会减库存，所以也就可能出现下单成功数远远超过真正库存数的情况，这尤其会发生在做活动的热门商品上。这样一来，就会导致很多买家下单成功但是付不了款，买家的购物体验自然比较差。</p>\n<p>可以看到，不管是“下单减库存”还是“付款减库存”，都会导致商品库存不能完全和实际售卖情况对应起来的情况，看来要把商品准确地卖出去还真是不容易啊！</p>\n<p>那么，既然“下单减库存”和“付款减库存”都有缺点，我们能否把两者相结合，将两次操作进行前后关联起来，下单时先预扣，在规定时间内不付款再释放库存，即采用“预扣库存”这种方式呢？</p>\n<p>这种方案确实可以在一定程度上缓解上面的问题。但是否就彻底解决了呢？其实没有！针对恶意下单这种情况，虽然把有效的付款时间设置为10分钟，但是恶意买家完全可以在10分钟后再次下单，或者采用一次下单很多件的方式把库存减完。针对这种情况，解决办法还是要结合安全和反作弊的措施来制止。</p>\n<p>例如，给经常下单不付款的买家进行识别打标（可以在被打标的买家下单时不减库存）、给某些类目设置最大购买件数（例如，参加活动的商品一人最多只能买3件），以及对重复下单不付款的操作进行次数限制等。</p>\n<p>针对“库存超卖”这种情况，在10分钟时间内下单的数量仍然有可能超过库存数量，遇到这种情况我们只能区别对待：对普通的商品下单数量超过库存数量的情况，可以通过补货来解决；但是有些卖家完全不允许库存为负数的情况，那只能在买家付款时提示库存不足。</p>\n<h2>大型秒杀中如何减库存？</h2>\n<p>目前来看，业务系统中最常见的就是预扣库存方案，像你在买机票、买电影票时，下单后一般都有个“有效付款时间”，超过这个时间订单自动释放，这都是典型的预扣库存方案。而具体到秒杀这个场景，应该采用哪种方案比较好呢？</p>\n<p>由于参加秒杀的商品，一般都是“抢到就是赚到”，所以成功下单后却不付款的情况比较少，再加上卖家对秒杀商品的库存有严格限制，所以秒杀商品采用“下单减库存”更加合理。另外，理论上由于“下单减库存”比“预扣库存”以及涉及第三方支付的“付款减库存”在逻辑上更为简单，所以性能上更占优势。</p>\n<p>“下单减库存”在数据一致性上，主要就是保证大并发请求时库存数据不能为负数，也就是要保证数据库中的库存字段值不能为负数，一般我们有多种解决方案：一种是在应用程序中通过事务来判断，即保证减后库存不能为负数，否则就回滚；另一种办法是直接设置数据库的字段数据为无符号整数，这样减后库存字段值小于零时会直接执行SQL语句来报错；再有一种就是使用CASE WHEN判断语句，例如这样的SQL语句：</p>\n<p><code>UPDATE item SET inventory = CASE WHEN inventory &gt;= xxx THEN inventory-xxx ELSE inventory END</code></p>\n<h2>秒杀减库存的极致优化</h2>\n<p>在交易环节中，“库存”是个关键数据，也是个热点数据，因为交易的各个环节中都可能涉及对库存的查询。但是，我在前面介绍分层过滤时提到过，秒杀中并不需要对库存有精确的一致性读，把库存数据放到缓存（Cache）中，可以大大提升读性能。</p>\n<p>解决大并发读问题，可以采用LocalCache（即在秒杀系统的单机上缓存商品相关的数据）和对数据进行分层过滤的方式，但是像减库存这种大并发写无论如何还是避免不了，这也是秒杀场景下最为核心的一个技术难题。</p>\n<p><strong>因此，这里我想专门来说一下秒杀场景下减库存的极致优化思路，包括如何在缓存中减库存以及如何在数据库中减库存</strong>。</p>\n<p>秒杀商品和普通商品的减库存还是有些差异的，例如商品数量比较少，交易时间段也比较短，因此这里有一个大胆的假设，即能否把秒杀商品减库存直接放到缓存系统中实现，也就是直接在缓存中减库存或者在一个带有持久化功能的缓存系统（如Redis）中完成呢？</p>\n<p>如果你的秒杀商品的减库存逻辑非常单一，比如没有复杂的SKU库存和总库存这种联动关系的话，我觉得完全可以。但是如果有比较复杂的减库存逻辑，或者需要使用事务，你还是必须在数据库中完成减库存。</p>\n<p>由于MySQL存储数据的特点，同一数据在数据库里肯定是一行存储（MySQL），因此会有大量线程来竞争InnoDB行锁，而并发度越高时等待线程会越多，TPS（Transaction Per Second，即每秒处理的消息数）会下降，响应时间（RT）会上升，数据库的吞吐量就会严重受影响。</p>\n<p>这就可能引发一个问题，就是单个热点商品会影响整个数据库的性能， 导致0.01%的商品影响99.99%的商品的售卖，这是我们不愿意看到的情况。一个解决思路是遵循前面介绍的原则进行隔离，把热点商品放到单独的热点库中。但是这无疑会带来维护上的麻烦，比如要做热点数据的动态迁移以及单独的数据库等。</p>\n<p>而分离热点商品到单独的数据库还是没有解决并发锁的问题，我们应该怎么办呢？要解决并发锁的问题，有两种办法：</p>\n<ul>\n<li><strong>应用层做排队</strong>。按照商品维度设置队列顺序执行，这样能减少同一台机器对数据库同一行记录进行操作的并发度，同时也能控制单个商品占用数据库连接的数量，防止热点商品占用太多的数据库连接。</li>\n<li><strong>数据库层做排队</strong>。应用层只能做到单机的排队，但是应用机器数本身很多，这种排队方式控制并发的能力仍然有限，所以如果能在数据库层做全局排队是最理想的。阿里的数据库团队开发了针对这种MySQL的InnoDB层上的补丁程序（patch），可以在数据库层上对单行记录做到并发排队。</li>\n</ul>\n<p>你可能有疑问了，排队和锁竞争不都是要等待吗，有啥区别？</p>\n<p>如果熟悉MySQL的话，你会知道InnoDB内部的死锁检测，以及MySQL Server和InnoDB的切换会比较消耗性能，淘宝的MySQL核心团队还做了很多其他方面的优化，如COMMIT_ON_SUCCESS和ROLLBACK_ON_FAIL的补丁程序，配合在SQL里面加提示（hint），在事务里不需要等待应用层提交（COMMIT），而在数据执行完最后一条SQL后，直接根据TARGET_AFFECT_ROW的结果进行提交或回滚，可以减少网络等待时间（平均约0.7ms）。据我所知，目前阿里MySQL团队已经将包含这些补丁程序的MySQL开源。</p>\n<p>另外，数据更新问题除了前面介绍的热点隔离和排队处理之外，还有些场景（如对商品的lastmodifytime字段的）更新会非常频繁，在某些场景下这些多条SQL是可以合并的，一定时间内只要执行最后一条SQL就行了，以便减少对数据库的更新操作。</p>\n<h2>总结一下</h2>\n<p>今天，我围绕商品减库存的场景，介绍了减库存的三种实现方案，以及分别存在的问题和可能的缓解办法。最后，我又聚焦秒杀这个场景说了如何实现减库存，以及在这个场景下做到极致优化的一些思路。</p>\n<p>当然减库存还有很多细节问题，例如预扣的库存超时后如何进行库存回补，再比如目前都是第三方支付，如何在付款时保证减库存和成功付款时的状态一致性，这些都是很大的挑战。</p>\n<p>如果你也有实现减库存的经验或者问题，欢迎留言与我分享。</p>\n<p></p>\n","neighbors":{"left":{"article_title":"05 | 影响性能的因素有哪些？又该如何提高系统的性能？","id":40742},"right":{"article_title":"07 | 准备Plan B：如何设计兜底方案?","id":40744}},"comments":[{"had_liked":false,"id":108321,"user_name":"Null","can_delete":false,"product_type":"c1","uid":1271604,"ip_address":"","ucode":"6269E292E2B3C8","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/7GSdRJMUvkzRQiav8ibdZy59a9fUoX12bd1ramONpKQDHKGrl2mV79sSXfRWUaVvA1C8TollSaQ9B9Eu73KUGkpg/132","comment_is_top":false,"comment_ctime":1561717678,"is_pvip":true,"discussion_count":43,"race_medal":0,"score":"950749490094","product_id":100017501,"comment_content":"兄台，我看过你的书，感觉你的这个主题和你的书一样，都写的相当的泛，尤其是减库存这个地方，更泛，看了之后依然没办法对一些稍微细节的实现处理作出判断，能麻烦写的稍微细点吗？ ","like_count":222,"discussions":[{"author":{"id":1080653,"avatar":"https://static001.geekbang.org/account/avatar/00/10/7d/4d/d98865b2.jpg","nickname":"老实人Honey","note":"","ucode":"EA4AB5C0C33090","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":356298,"discussion_content":"我接受不了啊 可以退款吗","likes_number":21,"is_delete":false,"is_hidden":false,"ctime":1615560306,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1481811,"avatar":"https://static001.geekbang.org/account/avatar/00/16/9c/53/ade0afb0.jpg","nickname":"ub8","note":"","ucode":"0D937C3EAEB781","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":118585,"discussion_content":"唉，这大哥估计多年没在一线干了，处于养老状态","likes_number":21,"is_delete":false,"is_hidden":false,"ctime":1578155540,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1793962,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/5f/aa/63e641c1.jpg","nickname":"H","note":"","ucode":"04D7D030245E27","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":324952,"discussion_content":"否则怎么做p8，就是要抽象","likes_number":15,"is_delete":false,"is_hidden":false,"ctime":1605194640,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1245956,"avatar":"https://static001.geekbang.org/account/avatar/00/13/03/04/44692930.jpg","nickname":"Rick","note":"","ucode":"E088D8AA9E985F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":203429,"discussion_content":"“据我所知，目前阿里 MySQL 团队已经将包含这些补丁程序的 MySQL 开源。” 既然这是知识付费，您也是出身阿里，能不能麻烦直接告诉我们是什么。而且各个点你都只说个大概，你这样干脆说：“百度是个好东西，你自己去搜吧”比较好","likes_number":15,"is_delete":false,"is_hidden":false,"ctime":1584027749,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1196886,"avatar":"https://static001.geekbang.org/account/avatar/00/12/43/56/62c38c36.jpg","nickname":"欧阳","note":"","ucode":"2612576E262813","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":285794,"discussion_content":"要么是作者没水平，要么是纯粹忽悠我们","likes_number":10,"is_delete":false,"is_hidden":false,"ctime":1592955754,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":3,"child_discussions":[{"author":{"id":1435845,"avatar":"https://static001.geekbang.org/account/avatar/00/15/e8/c5/8bdb0bba.jpg","nickname":"DarKnight","note":"","ucode":"B04AFD03768827","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1196886,"avatar":"https://static001.geekbang.org/account/avatar/00/12/43/56/62c38c36.jpg","nickname":"欧阳","note":"","ucode":"2612576E262813","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":324147,"discussion_content":"我觉得嘛，许老师为大家讲解的知识和经验，都是经过高度抽象的设计与实现理念，是通用的思想，具体落地到每一种场景，肯定会有差异和细分，例如，老师已经提到了“预付扣存”的解决方案，进而在数据库层面如何做到非负保障，再到数据库高并发操作的锁性能问题的排队优化思路（应用层+数据库层），我们需要学习不就是这种抽象的思路与方案吗？难道需要知道的是排队代码应该怎么写？这恐怕就不是这个专栏的目的了","likes_number":5,"is_delete":false,"is_hidden":false,"ctime":1605061510,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":285794,"ip_address":""},"score":324147,"extra":""},{"author":{"id":1009554,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/67/92/abb7bfe3.jpg","nickname":"wilson","note":"","ucode":"F582F485FD44CF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1435845,"avatar":"https://static001.geekbang.org/account/avatar/00/15/e8/c5/8bdb0bba.jpg","nickname":"DarKnight","note":"","ucode":"B04AFD03768827","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":363601,"discussion_content":"只是方案思路，把大象放进冰箱的思路分为三步","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1617244295,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":324147,"ip_address":""},"score":363601,"extra":""},{"author":{"id":1642586,"avatar":"https://static001.geekbang.org/account/avatar/00/19/10/5a/3411221e.jpg","nickname":"Heidi","note":"","ucode":"2751FD284068AA","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1435845,"avatar":"https://static001.geekbang.org/account/avatar/00/15/e8/c5/8bdb0bba.jpg","nickname":"DarKnight","note":"","ucode":"B04AFD03768827","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":579665,"discussion_content":"我服了，差就是差，承认有这么难么？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1657606369,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":324147,"ip_address":""},"score":579665,"extra":""}]},{"author":{"id":2416188,"avatar":"","nickname":"Geek_086c3b","note":"","ucode":"D9950EEA13391B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":352040,"discussion_content":"我也是这种感觉，看了等于白看，真正想了解的就是不讲。","likes_number":8,"is_delete":false,"is_hidden":false,"ctime":1614581520,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1517406,"avatar":"https://wx.qlogo.cn/mmopen/vi_32/Z5V09vdJqA2CCatibiaarlibia2zmdoEKFE911N0Miaz0k1he0b6heBh6Icb6HayrtUGCAfmXULcTV4RIUoSYoHHCfw/132","nickname":"Geek_d6353d","note":"","ucode":"E596B648209298","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":262001,"discussion_content":"我也是这种感觉，不知道具体的技术方案","likes_number":8,"is_delete":false,"is_hidden":false,"ctime":1589031518,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2238387,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/wB6ibFsgf7rpPjtuxPjmxs5LkQIrmxmvPEJ0uYgksURvicmdpRBicneibDicl7Q5lfrLWvVic0xKbn69t5DWsgqtjnxA/132","nickname":"Geek_2a7cab","note":"","ucode":"2C1550A895E8DC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":351089,"discussion_content":"就靠这头衔来骗的","likes_number":6,"is_delete":false,"is_hidden":false,"ctime":1614152018,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1445744,"avatar":"https://static001.geekbang.org/account/avatar/00/16/0f/70/f59db672.jpg","nickname":"槑·先生","note":"","ucode":"897F0475592E3A","race_medal":2,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":260891,"discussion_content":"我也有这种感觉，似懂非懂","likes_number":6,"is_delete":false,"is_hidden":false,"ctime":1588910511,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1306238,"avatar":"https://static001.geekbang.org/account/avatar/00/13/ee/7e/955b686d.jpg","nickname":"AA星星点灯","note":"","ucode":"684C7FACCA4192","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":209571,"discussion_content":"感觉没啥用……忽悠人呢","likes_number":6,"is_delete":false,"is_hidden":false,"ctime":1584637353,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1645857,"avatar":"","nickname":"三旬老汉","note":"","ucode":"B59ABAACF83DBE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":208892,"discussion_content":"并发减库存连最基本的CAS都没讲到，很失望","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1584588138,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1138369,"avatar":"https://static001.geekbang.org/account/avatar/00/11/5e/c1/cd721d46.jpg","nickname":"_yiunia##远","note":"","ucode":"AF508C3D0EB954","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1645857,"avatar":"","nickname":"三旬老汉","note":"","ucode":"B59ABAACF83DBE","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":210582,"discussion_content":"不是说了数据库事务么","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584754352,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":208892,"ip_address":""},"score":210582,"extra":""},{"author":{"id":1008926,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/65/1e/083be80c.jpg","nickname":"摇滚代码","note":"","ucode":"99194B80D85F18","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1645857,"avatar":"","nickname":"三旬老汉","note":"","ucode":"B59ABAACF83DBE","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539810,"discussion_content":"你真是搞笑","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639844594,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":208892,"ip_address":""},"score":539810,"extra":""}]},{"author":{"id":1643652,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIzGGthScz54oQ77KgdOc89G3Z6U1Q7a8zppXogVzJu0lrmXxuISlZ6uicfKZibOVAl6lHDleMwffBg/132","nickname":"lud","note":"","ucode":"AA82BA49D2EF3F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":373776,"discussion_content":"明白人还是多，水的受不了","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1620870737,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2351949,"avatar":"https://static001.geekbang.org/account/avatar/00/23/e3/4d/8a26dbb2.jpg","nickname":"枫中浪子","note":"","ucode":"860BEA32059B37","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":341123,"discussion_content":"水","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1610299661,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1734992,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/79/50/4f0ef60a.jpg","nickname":"zy","note":"","ucode":"E37C9D642281B1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":69358,"discussion_content":"是的，别总搞太多理论，需要更多的实践","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1575283015,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1499254,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e0/76/77afa881.jpg","nickname":"公众号：业余草","note":"","ucode":"2C9E201BC09960","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":2737,"discussion_content":"对，我们更需要的是代码实战","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1563890134,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":3,"child_discussions":[{"author":{"id":1210699,"avatar":"https://static001.geekbang.org/account/avatar/00/12/79/4b/740f91ca.jpg","nickname":"-W.LI-","note":"","ucode":"3556786538664F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1499254,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e0/76/77afa881.jpg","nickname":"公众号：业余草","note":"","ucode":"2C9E201BC09960","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":11677,"discussion_content":"你需要的CV。。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1568423283,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":2737,"ip_address":""},"score":11677,"extra":""},{"author":{"id":1284659,"avatar":"https://static001.geekbang.org/account/avatar/00/13/9a/33/de01b796.jpg","nickname":"胖狐狸","note":"","ucode":"810DFA27C80837","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1499254,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e0/76/77afa881.jpg","nickname":"公众号：业余草","note":"","ucode":"2C9E201BC09960","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":267179,"discussion_content":"其实你们就是想抄代码","likes_number":5,"is_delete":false,"is_hidden":false,"ctime":1589612449,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":2737,"ip_address":""},"score":267179,"extra":""},{"author":{"id":1085152,"avatar":"https://static001.geekbang.org/account/avatar/00/10/8e/e0/847348b1.jpg","nickname":"爱学习的大叔","note":"","ucode":"91F9ABF1EC98D0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1284659,"avatar":"https://static001.geekbang.org/account/avatar/00/13/9a/33/de01b796.jpg","nickname":"胖狐狸","note":"","ucode":"810DFA27C80837","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":267198,"discussion_content":"哈哈哈哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589615081,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":267179,"ip_address":""},"score":267198,"extra":""}]},{"author":{"id":2758138,"avatar":"","nickname":"Geek_8d9a5d","note":"","ucode":"C0C05C0200EDC1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":392390,"discussion_content":"rnm，退钱","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1630989936,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1932894,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/7e/5e/48c47d20.jpg","nickname":"fjigww","note":"","ucode":"0DFE5466BCDBFE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":541582,"discussion_content":"思想太高太抽象，太泛了，感觉就是对领导的ppt，和博客的泛泛而谈差不多了","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1640452638,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1335806,"avatar":"https://static001.geekbang.org/account/avatar/00/14/61/fe/278ff785.jpg","nickname":"文艺的小逗比","note":"","ucode":"92AADA1F0C4593","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":389741,"discussion_content":"骗钱的","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1629420179,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1642472,"avatar":"https://static001.geekbang.org/account/avatar/00/19/0f/e8/a3c08232.jpg","nickname":"连腾宇","note":"","ucode":"DB3E5771BA90A9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375889,"discussion_content":"太泛了，无法接受这样的课程质量","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1621856985,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1765541,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/f0/a5/ff758400.jpg","nickname":"belief","note":"","ucode":"563EDA9F2C9214","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":339650,"discussion_content":"如何减库存，可以更细致一些，附上demo更好了","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1609753002,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1285478,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erXgjPOkuSIIhkeWcIeAWO2FjLHjNdsAca4icjjZcfPMguSEdaUibkj123Ijr8c1j3yER6W0M6wKEmw/132","nickname":"婉约的冰西瓜","note":"","ucode":"8BA2D933D1BE82","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":310500,"discussion_content":"同感同感，看完之后，就是知道有三个阶段可以扣库存，怎么扣，具体的细节还是不知道","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1601880302,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":4,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2063114,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/7b/0a/b65e1fae.jpg","nickname":"不要挑战自己的智商","note":"","ucode":"4910FF07C35DC5","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":306275,"discussion_content":"他要是真的写一本书那么长的篇幅，大家也未必会去看吧","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1600238283,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":4,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1072064,"avatar":"https://static001.geekbang.org/account/avatar/00/10/5b/c0/4f4143cb.jpg","nickname":"朵爱潘","note":"","ucode":"710A69074F4E13","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2063114,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/7b/0a/b65e1fae.jpg","nickname":"不要挑战自己的智商","note":"","ucode":"4910FF07C35DC5","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":396591,"discussion_content":"为什么不会","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632458271,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":306275,"ip_address":""},"score":396591,"extra":""}]},{"author":{"id":1254772,"avatar":"http://thirdwx.qlogo.cn/mmopen/Q3auHgzwzM65SVeCJLGTkwpjypqPTI5mcAtMoe6dbH2JbCPDliaBob0IkGLSezzdKhDrWu2PFnGdX6LPPUiaU8Xw/132","nickname":"jkbxiao","note":"","ucode":"819EE5F289A09D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":289908,"discussion_content":"有些东西估计不方便说。其实还是有料的。只是逻辑衔接和当时遇到的实际业务问题没有表达清楚，所以我们只能猜测和交流","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1594264874,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":4,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1584787,"avatar":"https://static001.geekbang.org/account/avatar/00/18/2e/93/029eee99.jpg","nickname":"阿维","note":"","ucode":"84CBFDBD016806","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":286976,"discussion_content":"感觉没有具体的实现方案啊","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1593337965,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":4,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1110723,"avatar":"https://static001.geekbang.org/account/avatar/00/10/f2/c3/f18e4507.jpg","nickname":"远鹏","note":"","ucode":"37B06413D88BEC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":216598,"discussion_content":"更多的是在没有遇到这种情况的时候无法想象这样一个场景","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1585469121,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":4,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1222803,"avatar":"https://static001.geekbang.org/account/avatar/00/12/a8/93/5912bd84.jpg","nickname":"恒","note":"","ucode":"1A0AC6664085A6","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":573910,"discussion_content":"太模糊了，最重要的反而是阿里的Mysql的patch，但是也完全不讲思路怎么做！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1653727359,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":4,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1018132,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/89/14/71bcd25e.jpg","nickname":"风","note":"","ucode":"6FCC11027BBE7A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1222803,"avatar":"https://static001.geekbang.org/account/avatar/00/12/a8/93/5912bd84.jpg","nickname":"恒","note":"","ucode":"1A0AC6664085A6","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":576017,"discussion_content":"这个阿里都没有开源，而且是mysql底层做的优化，外面的公司也用不了吧，就当作了解好了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655242373,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":573910,"ip_address":""},"score":576017,"extra":""}]},{"author":{"id":2287054,"avatar":"https://static001.geekbang.org/account/avatar/00/22/e5/ce/ec20f087.jpg","nickname":"July、","note":"","ucode":"EB55DDB5E364BB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":564170,"discussion_content":"同感，没啥东西","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1650175752,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":4,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1018706,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/8b/52/6659dc1b.jpg","nickname":"黑米","note":"","ucode":"E7DBEA7867862A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":390872,"discussion_content":"同感","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630113094,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":4,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1675882,"avatar":"https://static001.geekbang.org/account/avatar/00/19/92/6a/dd37a054.jpg","nickname":"张y .","note":"","ucode":"85918469492F4C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":388997,"discussion_content":"确实一点也不细，跟博客描述的差不多，看完并不知道具体代码细节怎么实现","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629085634,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":4,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1041465,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/e4/39/a06ade33.jpg","nickname":"极客雷","note":"","ucode":"0DBAC4CB9C7BCD","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":388549,"discussion_content":"哈哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628830530,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":4,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1698307,"avatar":"https://static001.geekbang.org/account/avatar/00/19/ea/03/7d325c12.jpg","nickname":"mk","note":"","ucode":"2F1437152D2AF7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":380604,"discussion_content":"纯科普性质的文章，毫无深度可言，都不能叫做课程","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1624602538,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":5,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1210699,"avatar":"https://static001.geekbang.org/account/avatar/00/12/79/4b/740f91ca.jpg","nickname":"-W.LI-","note":"","ucode":"3556786538664F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":11682,"discussion_content":"这个和业务场景挂钩，没法提供一套通吃的代码吧。比较不是框架或者底层的经典源码，几年几十年不变的，需要针对不同的场景做调整的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1568423393,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":5,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1006789,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/5c/c5/1231d633.jpg","nickname":"梁中华","note":"","ucode":"52FE40242CBAD0","race_medal":1,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":5613,"discussion_content":"这个需要经验，需要实践，需要思考.....","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566380035,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":5,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":30477,"user_name":"周龙亭","can_delete":false,"product_type":"c1","uid":1004577,"ip_address":"","ucode":"21BD0DD15CFCA3","user_header":"https://static001.geekbang.org/account/avatar/00/0f/54/21/8c13a2b4.jpg","comment_is_top":false,"comment_ctime":1538882474,"is_pvip":false,"replies":[{"id":"11204","content":"可以分两步来做，先创建订单但是先不生效，然后减库存，如果减库存成功后再生效订单，否则订单不生效","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1539087375,"ip_address":"","comment_id":30477,"utype":1}],"discussion_count":9,"race_medal":0,"score":"134682868650","product_id":100017501,"comment_content":"下单和扣库存两个操作的事务性是怎么做的？","like_count":31,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426018,"discussion_content":"可以分两步来做，先创建订单但是先不生效，然后减库存，如果减库存成功后再生效订单，否则订单不生效","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539087375,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1723864,"avatar":"","nickname":"Geek_857","note":"","ucode":"08DB59885AE0CD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":72130,"discussion_content":"tcc模型和消息中间件，实现事务","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1575470755,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1210699,"avatar":"https://static001.geekbang.org/account/avatar/00/12/79/4b/740f91ca.jpg","nickname":"-W.LI-","note":"","ucode":"3556786538664F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":11676,"discussion_content":"这么搞得话在扣件库存的库还得记录，哪个订单扣的库存做好幂等是么?","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1568423212,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1254953,"avatar":"https://static001.geekbang.org/account/avatar/00/13/26/29/352d1ce6.jpg","nickname":"崇拜","note":"","ucode":"8EC2C04ACB638B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":334518,"discussion_content":"分布式事务了解一下，2PC、TCC","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1607870210,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1139455,"avatar":"https://static001.geekbang.org/account/avatar/00/11/62/ff/f71034e9.jpg","nickname":"悟空WuKong","note":"","ucode":"49AFD2B048C1BA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":217539,"discussion_content":"先减库存再创建订单不行吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585568594,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":4,"child_discussions":[{"author":{"id":2063114,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/7b/0a/b65e1fae.jpg","nickname":"不要挑战自己的智商","note":"","ucode":"4910FF07C35DC5","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1139455,"avatar":"https://static001.geekbang.org/account/avatar/00/11/62/ff/f71034e9.jpg","nickname":"悟空WuKong","note":"","ucode":"49AFD2B048C1BA","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":306277,"discussion_content":"估计是减库存的动作响应太慢，为了用户体验，所以先创建订单","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600238576,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":217539,"ip_address":""},"score":306277,"extra":""},{"author":{"id":1253652,"avatar":"https://static001.geekbang.org/account/avatar/00/13/21/14/423a821f.jpg","nickname":"Steven","note":"","ucode":"3FE64459842015","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1139455,"avatar":"https://static001.geekbang.org/account/avatar/00/11/62/ff/f71034e9.jpg","nickname":"悟空WuKong","note":"","ucode":"49AFD2B048C1BA","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":387149,"discussion_content":"我也觉得应该先减库存再创建订单。\n创建订单虽然只是添加操作但也是要落库的，这性能能好得了吗？还是说你在前面放一个队列，数据库慢慢消化？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628005406,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":217539,"ip_address":""},"score":387149,"extra":""},{"author":{"id":1498155,"avatar":"https://static001.geekbang.org/account/avatar/00/16/dc/2b/b16aa5b6.jpg","nickname":"intelliYY","note":"","ucode":"375B28CE130CBE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1253652,"avatar":"https://static001.geekbang.org/account/avatar/00/13/21/14/423a821f.jpg","nickname":"Steven","note":"","ucode":"3FE64459842015","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":568034,"discussion_content":"我也觉得，秒杀如果不先确定能不能减库存就创建订单不是会创建大量无效订单","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1651049039,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":387149,"ip_address":""},"score":568034,"extra":""}]}]},{"had_liked":false,"id":52409,"user_name":"刘小刘","can_delete":false,"product_type":"c1","uid":1345729,"ip_address":"","ucode":"BFCC66632DCEE5","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTK1FIicjLKiaibJLFM9T5hicwyV3BDcHj5NUUcxwLklKpLNbevdWMlrTYOhHoxpJRNvOHzFTmTZfloVoA/132","comment_is_top":false,"comment_ctime":1545377584,"is_pvip":false,"replies":[{"id":"19661","content":"解决的办法就是尽可能避免产生锁，比如根据商品ID进行分库分表设计；再有就是减少锁的粒度例如阿里对MySQL做了定制优化，可以提升MySQL的并发度","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1545826524,"ip_address":"","comment_id":52409,"utype":1}],"discussion_count":2,"race_medal":0,"score":"83149756208","product_id":100017501,"comment_content":"老师，我觉得你讲的不太明白，你并没有说实际情况下同步是怎样解决并发的，没看到您给的方案，只看到您在评论回复里否定了队列异步处理的方式","like_count":19,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433863,"discussion_content":"解决的办法就是尽可能避免产生锁，比如根据商品ID进行分库分表设计；再有就是减少锁的粒度例如阿里对MySQL做了定制优化，可以提升MySQL的并发度","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545826524,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1121758,"avatar":"https://static001.geekbang.org/account/avatar/00/11/1d/de/62bfa83f.jpg","nickname":"aoe","note":"","ucode":"1C6201EDB4E954","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":18851,"discussion_content":"尽可能避免锁：actor模型了解一下","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1569115044,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":30399,"user_name":"公号-技术夜未眠","can_delete":false,"product_type":"c1","uid":1013683,"ip_address":"","ucode":"83825B57CBD952","user_header":"https://static001.geekbang.org/account/avatar/00/0f/77/b3/991f3f9b.jpg","comment_is_top":false,"comment_ctime":1538825971,"is_pvip":true,"replies":[{"id":"11005","content":"实际上，商品都是进行分库分表的，例如根据商品id进行水平拆分<br><br>分库分表就是提高吞吐量","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1538903861,"ip_address":"","comment_id":30399,"utype":1}],"discussion_count":4,"race_medal":0,"score":"48783466227","product_id":100017501,"comment_content":"许老师好，我有一个想法，只是没有在实践中这样做过，请指教:<br>能否借用&quot;数据库水平拆分&quot;的思想？<br>具体思路如下:<br>库存在数据库的表中就只有一行数据，上面的方案都是对这一条记录进行频繁更新，是非常&quot;热&quot;的热点数据。我们能否将该行数据拆分到不同的数据库中，这些数据库的库存记录之和就是原始库存数量。这样能否会降低数据库的写压力，提高吞吐量？","like_count":11,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":425981,"discussion_content":"实际上，商品都是进行分库分表的，例如根据商品id进行水平拆分\n\n分库分表就是提高吞吐量","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1538903861,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1499254,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e0/76/77afa881.jpg","nickname":"公众号：业余草","note":"","ucode":"2C9E201BC09960","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":2736,"discussion_content":"回答的不是一个问题","likes_number":5,"is_delete":false,"is_hidden":false,"ctime":1563890091,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1121758,"avatar":"https://static001.geekbang.org/account/avatar/00/11/1d/de/62bfa83f.jpg","nickname":"aoe","note":"","ucode":"1C6201EDB4E954","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":18856,"discussion_content":"理论上可行，但放在缓存中不是更容易吗，拆数据库多麻烦。也可以借助响应式编程，所有请求都发消息出来，通过Java的stream对实时消息统计处理，每秒确定一批数据，然后更新数据库。用消息中间件抗住流量，1秒同步一次库存，应该没压力","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1569115913,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1006789,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/5c/c5/1231d633.jpg","nickname":"梁中华","note":"","ucode":"52FE40242CBAD0","race_medal":1,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":5614,"discussion_content":"同一个数据放到多个表中，是能提升并发度，但是读起来会比较麻烦，你需要同时读很多表，然后汇总。另外还可能出现有些表库存已经为0了，另一张表还有库存。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566380214,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":32828,"user_name":"Geek_c19c96","can_delete":false,"product_type":"c1","uid":1068023,"ip_address":"","ucode":"FAAC71ACB4056B","user_header":"https://static001.geekbang.org/account/avatar/00/10/4b/f7/6c715fce.jpg","comment_is_top":false,"comment_ctime":1539699947,"is_pvip":false,"replies":[{"id":"12235","content":"😉","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1540096849,"ip_address":"","comment_id":32828,"utype":1}],"discussion_count":9,"race_medal":0,"score":"44489372907","product_id":100017501,"comment_content":"我们的库存都放在redis里面，读和减库存都在redis里面操作，redis会定时将库存放到mysql中做备份，","like_count":11,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426897,"discussion_content":"😉","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1540096849,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1235266,"avatar":"https://static001.geekbang.org/account/avatar/00/12/d9/42/85a15324.jpg","nickname":"田魁","note":"","ucode":"851044BB0CA105","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":588526,"discussion_content":"才用redis 的lua 脚本， 实现事务。异步同步到db","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1663814266,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"湖南"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2063114,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/7b/0a/b65e1fae.jpg","nickname":"不要挑战自己的智商","note":"","ucode":"4910FF07C35DC5","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":306279,"discussion_content":"文章说了“如果你的秒杀商品的减库存逻辑非常单一，比如没有复杂的 SKU 库存和总库存这种联动关系的话，我觉得完全可以。但是如果有比较复杂的减库存逻辑，或者需要使用事务，你还是必须在数据库中完成减库存。”\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600239148,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1185590,"avatar":"https://static001.geekbang.org/account/avatar/00/12/17/36/ece951b4.jpg","nickname":"恋雪","note":"","ucode":"B0D8870130A314","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":269202,"discussion_content":"如果redis挂了，此时定时任务还没有将数据更新到mysql，这种情况会怎么处理？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589877903,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":5,"child_discussions":[{"author":{"id":2033730,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/08/42/b14f3a32.jpg","nickname":"Geek_2ecc5d","note":"","ucode":"4B6D777B754A80","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1185590,"avatar":"https://static001.geekbang.org/account/avatar/00/12/17/36/ece951b4.jpg","nickname":"恋雪","note":"","ucode":"B0D8870130A314","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":285588,"discussion_content":"那数据库挂了怎么处理？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592885392,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":269202,"ip_address":""},"score":285588,"extra":""},{"author":{"id":2063114,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/7b/0a/b65e1fae.jpg","nickname":"不要挑战自己的智商","note":"","ucode":"4910FF07C35DC5","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1185590,"avatar":"https://static001.geekbang.org/account/avatar/00/12/17/36/ece951b4.jpg","nickname":"恋雪","note":"","ucode":"B0D8870130A314","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":306280,"discussion_content":"文章说了redis有持久化功能。那应该是即使挂了再重启，数据还在。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600239188,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":269202,"ip_address":""},"score":306280,"extra":""},{"author":{"id":1253652,"avatar":"https://static001.geekbang.org/account/avatar/00/13/21/14/423a821f.jpg","nickname":"Steven","note":"","ucode":"3FE64459842015","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2063114,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/7b/0a/b65e1fae.jpg","nickname":"不要挑战自己的智商","note":"","ucode":"4910FF07C35DC5","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":386956,"discussion_content":"redis 即使回写策略用的 Always，也是有可能丢失数据的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627909553,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":306280,"ip_address":""},"score":386956,"extra":""}]}]},{"had_liked":false,"id":30353,"user_name":"Coder4","can_delete":false,"product_type":"c1","uid":1048453,"ip_address":"","ucode":"71DAC6B3D112DB","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJcvQzf86HsxOkPcRpibBdCxDW0IK9wel9TmkEhicHPUHPRhzKna8wecDcJcVbNHNSrUMt4GHLxY3iaA/132","comment_is_top":false,"comment_ctime":1538806174,"is_pvip":false,"replies":[{"id":"11679","content":"数据库层不都是串行操作吗😊","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1539496279,"ip_address":"","comment_id":30353,"utype":1}],"discussion_count":14,"race_medal":0,"score":"44488479134","product_id":100017501,"comment_content":"这种无只能在串行隔离级别才能用吧，不然肯定超售。。。UPDATE item SET inventory = CASE WHEN inventory &gt;= xxx THEN inventory-xxx ELSE inventory END","like_count":10,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":425954,"discussion_content":"数据库层不都是串行操作吗😊","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539496279,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1138369,"avatar":"https://static001.geekbang.org/account/avatar/00/11/5e/c1/cd721d46.jpg","nickname":"_yiunia##远","note":"","ucode":"AF508C3D0EB954","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":210584,"discussion_content":"默认可重复读隔离级别，update语句触发出发的写锁当前读，所以是没问题的。不需要数据库串行隔离级别。","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1584754594,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2016906,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqSORgqrTv1PElfYGwxeG8lRvQibPBW0mNh4J12MicAwIGGLM2icwbD3gvkLpoPcAMGEzpnjVoxogUiaw/132","nickname":"企鹅","note":"","ucode":"C5D525B880DBDE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":333889,"discussion_content":"UPDATE item SET inventory-xxx  WHERE inventory >= xxx\n然后判断返回修改行数。\n就行了吧，没必要用CASE WHEN","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1607662769,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1110915,"avatar":"https://static001.geekbang.org/account/avatar/00/10/f3/83/e2612d81.jpg","nickname":"锐","note":"","ucode":"A245BA96C9471F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":324328,"discussion_content":"这样能支持高并发么","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605092835,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1307973,"avatar":"https://static001.geekbang.org/account/avatar/00/13/f5/45/da792b47.jpg","nickname":"萧子然","note":"","ucode":"1B0263F4E71183","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1110915,"avatar":"https://static001.geekbang.org/account/avatar/00/10/f3/83/e2612d81.jpg","nickname":"锐","note":"","ucode":"A245BA96C9471F","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":558225,"discussion_content":"不能吧，UPDATE会加排斥锁，在秒杀这种高并发场景下，这么多请求都修改同一行数据，必定会产生很多锁等待","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1648138500,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":324328,"ip_address":""},"score":558225,"extra":""}]},{"author":{"id":2086960,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/d8/30/840b64fa.jpg","nickname":"Frank木风","note":"","ucode":"8DAA325F19E00E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":301333,"discussion_content":"只想说和隔离级别没关系，就算是read uncommit，这个也没问题。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598491763,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1108761,"avatar":"https://static001.geekbang.org/account/avatar/00/10/eb/19/76b0b98c.jpg","nickname":"torres","note":"","ucode":"34DABCFC7B74EA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":293650,"discussion_content":"这里使用的是数据库的原子性操作。 一条sql语句的操作是原子性的，就像一条事务一样","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595605068,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1043546,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ec/5a/1c68c5a7.jpg","nickname":"公众号-微观技术","note":"","ucode":"BD0E46A9CF97E9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":193186,"discussion_content":"重复读并不能保证线程安全，需要采用字段自增或减的方式，update ... set amount = amount - 1 where id = $id and amount - 1 >=0\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583135108,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1981223,"avatar":"","nickname":"雒根雄","note":"","ucode":"895923AD3F55DD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1043546,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ec/5a/1c68c5a7.jpg","nickname":"公众号-微观技术","note":"","ucode":"BD0E46A9CF97E9","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":292087,"discussion_content":"这么操作应该也有问题，这在数据库层其实是两句，先读amount，再set. 但前面的读是不加锁的","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1595078964,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":193186,"ip_address":""},"score":292087,"extra":""},{"author":{"id":1590953,"avatar":"https://static001.geekbang.org/account/avatar/00/18/46/a9/70fa676f.jpg","nickname":"Luke","note":"","ucode":"2C8A1FAB8B6301","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1981223,"avatar":"","nickname":"雒根雄","note":"","ucode":"895923AD3F55DD","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":321350,"discussion_content":"怎么可能呢，update查找数据时就会加锁，它读到的值别的线程无法修改","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604567882,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":292087,"ip_address":""},"score":321350,"extra":""}]},{"author":{"id":1049798,"avatar":"https://static001.geekbang.org/account/avatar/00/10/04/c6/60e21baa.jpg","nickname":"stronghearted","note":"","ucode":"569C52E01AB0EF","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":53413,"discussion_content":"作者说是一行数据的更新，当然是串行的。没说事务隔离级别。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574166620,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1205866,"avatar":"https://static001.geekbang.org/account/avatar/00/12/66/6a/80f0d85b.jpg","nickname":"q.deng","note":"","ucode":"EE1D6DD6849A08","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":41288,"discussion_content":"这么水，默认重复读，最高一级才是串行","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572395031,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1387444,"avatar":"https://static001.geekbang.org/account/avatar/00/15/2b/b4/19a3f802.jpg","nickname":"xiaoxing","note":"","ucode":"CBB59C1BBEF33A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":2636,"discussion_content":"并不是默认串行","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563803864,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1590953,"avatar":"https://static001.geekbang.org/account/avatar/00/18/46/a9/70fa676f.jpg","nickname":"Luke","note":"","ucode":"2C8A1FAB8B6301","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1387444,"avatar":"https://static001.geekbang.org/account/avatar/00/15/2b/b4/19a3f802.jpg","nickname":"xiaoxing","note":"","ucode":"CBB59C1BBEF33A","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":321351,"discussion_content":"作者的意思是修改一行记录在数据库层面是原子的（串行的，没有其他线程可以同时修改这行记录），并不是指数据库的隔离级别是串行。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604567996,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":2636,"ip_address":""},"score":321351,"extra":""}]}]},{"had_liked":false,"id":30293,"user_name":"永光","can_delete":false,"product_type":"c1","uid":1102702,"ip_address":"","ucode":"0C54531ABED1B0","user_header":"https://static001.geekbang.org/account/avatar/00/10/d3/6e/281b85aa.jpg","comment_is_top":false,"comment_ctime":1538778024,"is_pvip":false,"replies":[{"id":"11207","content":"前面有个同学的类似的问题回答过，可以看一下","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1539088093,"ip_address":"","comment_id":30293,"utype":1}],"discussion_count":1,"race_medal":0,"score":"44488450984","product_id":100017501,"comment_content":"老师，你好，<br>你提到秒杀商品减库存直接放到缓存系统中实现，也就是直接在缓存中减库存或者在一个带有持久化功能的缓存系统（如 Redis）中完成。这种实现并发读写怎样保持数据一致？以及是不是要用分布式缓存？","like_count":10,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":425928,"discussion_content":"前面有个同学的类似的问题回答过，可以看一下","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539088093,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":32221,"user_name":"shawn","can_delete":false,"product_type":"c1","uid":1053716,"ip_address":"","ucode":"8F7CE170AE1F57","user_header":"","comment_is_top":false,"comment_ctime":1539487416,"is_pvip":false,"replies":[{"id":"11654","content":"说实话，没看出来哪里性能会更好😄<br>不过提前下单的思路还比较新颖，你的思路我理解，但是这样就把一个事情分两次来做，会增加了复杂度，有可能导致得不偿失","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1539489490,"ip_address":"","comment_id":32221,"utype":1}],"discussion_count":6,"race_medal":0,"score":"40194193080","product_id":100017501,"comment_content":"个人做法，<br>针对确定库存，提前下好单，下单人留空，订单短时间内失效<br>订单id压入Redis队列，<br>请求来到，订单队列lpop，队空则返回失败，<br>pop出来的订单补充下单人为当前用户，<br>如果订单过期失效则再次下同一商品的空单存入队列<br><br>这个设计可以考虑单个Redis不够用的时候将队列分组，利用轮转或时间戳hash将请求分配到不同队列，<br><br>想问下老师，这个和扣数字库存相比，会不会有更好的并发性能呢？","like_count":9,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426686,"discussion_content":"说实话，没看出来哪里性能会更好😄\n不过提前下单的思路还比较新颖，你的思路我理解，但是这样就把一个事情分两次来做，会增加了复杂度，有可能导致得不偿失","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539489490,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2416188,"avatar":"","nickname":"Geek_086c3b","note":"","ucode":"D9950EEA13391B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":352042,"discussion_content":"你这个不会提升性能，而且很复杂，更新订单并不会比插入全新订单更快。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1614581785,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1003259,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/4e/fb/1c905e7c.jpg","nickname":"张阿力","note":"","ucode":"7A611AD287CD6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":300956,"discussion_content":"针对队列的出队操作，针对表中一个行数据的锁，并发的时候感觉区别并不大，而且这里前置的操作只是提前写好订单，但其实写订单不是真正麻烦的地方，写订单只需要发消息异步写订单就可以了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598340943,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1723864,"avatar":"","nickname":"Geek_857","note":"","ucode":"08DB59885AE0CD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":72154,"discussion_content":"之前做的随机红包就是预生成红包，再把红包与请求的人绑定！支付系统这样做麻烦了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1575471062,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1394531,"avatar":"https://static001.geekbang.org/account/avatar/00/15/47/63/c68fac04.jpg","nickname":"被时间推开","note":"","ucode":"9EDA747409B6F9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":47308,"discussion_content":"这思路不错，把耗时的操作提前处理了，受教了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573310909,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1210699,"avatar":"https://static001.geekbang.org/account/avatar/00/12/79/4b/740f91ca.jpg","nickname":"-W.LI-","note":"","ucode":"3556786538664F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":11695,"discussion_content":"确实新颖，把对库存的并发减操作转换成了队列出队操作。先拿订单号设置归属人，收到支付成功回调以后订单生效。如果没收到还得取出来放回队列，还要考虑幂等补偿，太复杂了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1568424032,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":30381,"user_name":"一笑奈何","can_delete":false,"product_type":"c1","uid":1007709,"ip_address":"","ucode":"33FE23DF749936","user_header":"https://static001.geekbang.org/account/avatar/00/0f/60/5d/f6350fce.jpg","comment_is_top":false,"comment_ctime":1538817432,"is_pvip":false,"replies":[{"id":"11006","content":"我印象中单实例一般能抗7-8k左右","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1538903942,"ip_address":"","comment_id":30381,"utype":1}],"discussion_count":2,"race_medal":0,"score":"40193523096","product_id":100017501,"comment_content":"老师，问下单机mysql  1s内能抗大约多大的QPS? 大约。","like_count":9,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":425971,"discussion_content":"我印象中单实例一般能抗7-8k左右","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1538903942,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1018706,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/8b/52/6659dc1b.jpg","nickname":"黑米","note":"","ucode":"E7DBEA7867862A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":390873,"discussion_content":"你都没说什么硬件性能，这怎么给你算QPS啊","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630113341,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":184398,"user_name":"宇宙浪子","can_delete":false,"product_type":"c1","uid":1492089,"ip_address":"","ucode":"388AFFE9577F17","user_header":"https://static001.geekbang.org/account/avatar/00/16/c4/79/f07698c6.jpg","comment_is_top":false,"comment_ctime":1583307634,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"35943046002","product_id":100017501,"comment_content":"减库存是秒杀系统的难点，尤其是涉及到跨集群时如何既要满足性能又要做到数据一致性，整篇文章只是泛泛而谈，具体细节和核心难点都没讲解决方法。希望能讲的细致些，泛泛而谈没啥意义","like_count":8},{"had_liked":false,"id":47141,"user_name":"宁宁","can_delete":false,"product_type":"c1","uid":1083057,"ip_address":"","ucode":"C6BDF1F05A33EB","user_header":"https://static001.geekbang.org/account/avatar/00/10/86/b1/4b5d3a3b.jpg","comment_is_top":false,"comment_ctime":1544062480,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"35903800848","product_id":100017501,"comment_content":"下单减库存的方式存在问题是有些用户下单缺不付款，有一个补偿方案就是付款设置超时时间，一旦超时取消订单，同时发送消息到消息对列，库存服务订阅消息，把库存加回去！","like_count":8},{"had_liked":false,"id":32045,"user_name":"我是李香兰小朋友","can_delete":false,"product_type":"c1","uid":1155349,"ip_address":"","ucode":"84239A65A4D686","user_header":"https://static001.geekbang.org/account/avatar/00/11/a1/15/b7284d60.jpg","comment_is_top":false,"comment_ctime":1539395021,"is_pvip":false,"replies":[{"id":"11658","content":"“按照商品维度设置队列顺序执行”的意思就是，为了防止同一个商品对数据库的操作占用太多的数据库资源，所以采用队列的方式，让其他商品也有公平的机会得到数据的响应，例如如果秒杀的时候，秒杀商品肯定占用大量的请求，数据库的连接池有可能都被秒杀商品占用了，如果不做队列的话，那么其他商品就得不到数据库执行机会了。加入我们分10个队列，那么秒杀商品就会落在这10个队列中的一个，那么最多也就占用机器10分之一的资源。","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1539490270,"ip_address":"","comment_id":32045,"utype":1}],"discussion_count":1,"race_medal":0,"score":"35899133389","product_id":100017501,"comment_content":"“按照商品维度设置队列顺序执行”这句话是什么意思？可以举例说明一下吗？谢谢老师","like_count":8,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426619,"discussion_content":"“按照商品维度设置队列顺序执行”的意思就是，为了防止同一个商品对数据库的操作占用太多的数据库资源，所以采用队列的方式，让其他商品也有公平的机会得到数据的响应，例如如果秒杀的时候，秒杀商品肯定占用大量的请求，数据库的连接池有可能都被秒杀商品占用了，如果不做队列的话，那么其他商品就得不到数据库执行机会了。加入我们分10个队列，那么秒杀商品就会落在这10个队列中的一个，那么最多也就占用机器10分之一的资源。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1539490270,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":31976,"user_name":"大麦","can_delete":false,"product_type":"c1","uid":1032051,"ip_address":"","ucode":"8F398D86C8D57E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/bf/73/a39394cf.jpg","comment_is_top":false,"comment_ctime":1539346649,"is_pvip":false,"replies":[{"id":"11659","content":"异步下单的方式，也是一个思路，例如在一些场景下其实已经在使用，例如一些支付场景中，付了款以后，前端页面中会有一个转圈，等个几秒钟再告诉你结果。<br><br>这种方式我个人觉得对用户不太友好，就是要让用户等个几秒钟，而不是像同步的方式能及时得到反馈结果","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1539490736,"ip_address":"","comment_id":31976,"utype":1}],"discussion_count":3,"race_medal":0,"score":"31604117721","product_id":100017501,"comment_content":"秒杀是短时间大量请求，使用下单即锁库存方式，可以通过一个 redis 队列记录下单，一个redis key 记录数量 num，超出的库存下单失败，这样大量请求在 redis 层即可被处理。<br>通过 num 与库存的判断来解决无效订单。<br>下单端通过队列异步消费下单。<br>对于前端，用户下单成功，即进入redis 队列的，响应给前端可以轮询。<br>没有的，直接提示抢购失败。<br>","like_count":7,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426589,"discussion_content":"异步下单的方式，也是一个思路，例如在一些场景下其实已经在使用，例如一些支付场景中，付了款以后，前端页面中会有一个转圈，等个几秒钟再告诉你结果。\n\n这种方式我个人觉得对用户不太友好，就是要让用户等个几秒钟，而不是像同步的方式能及时得到反馈结果","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539490736,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2063114,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/7b/0a/b65e1fae.jpg","nickname":"不要挑战自己的智商","note":"","ucode":"4910FF07C35DC5","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":306288,"discussion_content":"对于支付这种场景，即便同步的方式，客户端也要等上好几秒吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600240033,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1253732,"avatar":"https://static001.geekbang.org/account/avatar/00/13/21/64/4bd7f522.jpg","nickname":"Kevin","note":"","ucode":"328E37E2579B03","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2063114,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/7b/0a/b65e1fae.jpg","nickname":"不要挑战自己的智商","note":"","ucode":"4910FF07C35DC5","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":369566,"discussion_content":"这种异步的方式主要是针对比较耗时的业务，比如启动某台机器，机器开机要自检比较耗时，同步的方式请求就会一直hang在那里等待，浪费资源。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619082804,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":306288,"ip_address":""},"score":369566,"extra":""}]}]},{"had_liked":false,"id":30617,"user_name":"moliniao","can_delete":false,"product_type":"c1","uid":1155414,"ip_address":"","ucode":"D38D159E960FFA","user_header":"https://static001.geekbang.org/account/avatar/00/11/a1/56/ad5dba39.jpg","comment_is_top":false,"comment_ctime":1538961264,"is_pvip":false,"replies":[{"id":"11205","content":"秒杀web请求一般不用排队，谁先到谁先执行。<br>排队一般更多是在服务端的内部请求时发生，而且是在异步请求时通过消息队列来处理","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1539087750,"ip_address":"","comment_id":30617,"utype":1}],"discussion_count":1,"race_medal":0,"score":"31603732336","product_id":100017501,"comment_content":"老师，使用应用排队方式，入队后返回，然后app端轮询请求下单结果吗？","like_count":7,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426048,"discussion_content":"秒杀web请求一般不用排队，谁先到谁先执行。\n排队一般更多是在服务端的内部请求时发生，而且是在异步请求时通过消息队列来处理","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539087750,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":33612,"user_name":"诗泽","can_delete":false,"product_type":"c1","uid":1031865,"ip_address":"","ucode":"F28BE01C3FD12F","user_header":"https://static001.geekbang.org/account/avatar/00/0f/be/b9/f2481c2c.jpg","comment_is_top":false,"comment_ctime":1539835253,"is_pvip":false,"replies":[{"id":"12228","content":"大家对请求队列这块问的比较多，后面相关的问题我统一回答一下吧","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1540094751,"ip_address":"","comment_id":33612,"utype":1}],"discussion_count":1,"race_medal":0,"score":"27309639029","product_id":100017501,"comment_content":"看到有同学说下单排队可以用请求队列来做，想问一下请求队列里存放的是请求数据吧，即用户请求数据入队列之后请求立即返回，后台异步处理请求数据，那处理的结果如何告知用户？是前端发起轮训请求吗？如果是轮训的话又会占用服务器不少连接资源吧？<br>如果请求队列里直接存的是http 请求的话服务器端也是会持有大量未释放的http 长连接。<br>所以请教一下实际当中一般请求队列这部分是怎么做的呢？","like_count":6,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":427012,"discussion_content":"大家对请求队列这块问的比较多，后面相关的问题我统一回答一下吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1540094751,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":32384,"user_name":"约书亚","can_delete":false,"product_type":"c1","uid":1046714,"ip_address":"","ucode":"81EA27ADD9EC1A","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f8/ba/14e05601.jpg","comment_is_top":false,"comment_ctime":1539563715,"is_pvip":false,"replies":[{"id":"12242","content":"早期用过😉","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1540098015,"ip_address":"","comment_id":32384,"utype":1}],"discussion_count":3,"race_medal":0,"score":"27309367491","product_id":100017501,"comment_content":"好多同学提到基于redis减库存，我看阿里云的文档时，里面也提到了阿里双11秒杀就用的这种方式，不知道是不是真的？","like_count":6,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426750,"discussion_content":"早期用过😉","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1540098015,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1067763,"avatar":"https://static001.geekbang.org/account/avatar/00/10/4a/f3/3ca6ed87.jpg","nickname":"zxj_gk","note":"","ucode":"C5755160B26C18","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":339509,"discussion_content":"早起用redis，现在用什么？为何不用了？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609697050,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1253732,"avatar":"https://static001.geekbang.org/account/avatar/00/13/21/64/4bd7f522.jpg","nickname":"Kevin","note":"","ucode":"328E37E2579B03","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1067763,"avatar":"https://static001.geekbang.org/account/avatar/00/10/4a/f3/3ca6ed87.jpg","nickname":"zxj_gk","note":"","ucode":"C5755160B26C18","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":369567,"discussion_content":"应该是现在的物理设备性能强大了，同时阿里优化了mysql","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1619082925,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":339509,"ip_address":""},"score":369567,"extra":""}]}]},{"had_liked":false,"id":36318,"user_name":"null","can_delete":false,"product_type":"c1","uid":1024294,"ip_address":"","ucode":"F9039EFED6B55D","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaELZPnUAiajaR5C25EDLWeJURggyiaOP5GGPe2qlwpQcm5e3ybib8OsP4tvddFDLVRSNNGL5I3SFPJHsA/132","comment_is_top":false,"comment_ctime":1541036534,"is_pvip":false,"replies":[{"id":"13015","content":"如果方法一有后续的超时回补库存，那么就差不多了","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1541239803,"ip_address":"","comment_id":36318,"utype":1}],"discussion_count":1,"race_medal":0,"score":"23015873014","product_id":100017501,"comment_content":"方法一和方法三是不是没啥区别？<br><br>方法一：下单减库存，但是用户不支付，订单超时释放库存<br>方法三：预扣库存，用户下单时扣库存，超时释放库存<br><br>区别是不是在“超时”时长？但这个也是人为决定的，所以方法一和方法三是同一种方案？","like_count":5,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":427829,"discussion_content":"如果方法一有后续的超时回补库存，那么就差不多了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1541239803,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":30419,"user_name":"对方正在输入......","can_delete":false,"product_type":"c1","uid":1256518,"ip_address":"","ucode":"762E0C65C972BE","user_header":"https://static001.geekbang.org/account/avatar/00/13/2c/46/04a470cf.jpg","comment_is_top":false,"comment_ctime":1538835691,"is_pvip":false,"replies":[{"id":"11200","content":"预扣是有预定的意思，如果未付款还会补回来<br>而扣库存就实际的减去库存了<br><br>每次预扣都可以创建一条记录，如果这条记录超时了就删掉，剩下的库存就是总库存减去预扣的库存","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1539086809,"ip_address":"","comment_id":30419,"utype":1}],"discussion_count":1,"race_medal":0,"score":"23013672171","product_id":100017501,"comment_content":"预扣库存和扣库存有什么区别？怎么预扣库存？","like_count":5,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":425990,"discussion_content":"预扣是有预定的意思，如果未付款还会补回来\n而扣库存就实际的减去库存了\n\n每次预扣都可以创建一条记录，如果这条记录超时了就删掉，剩下的库存就是总库存减去预扣的库存","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539086809,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":131221,"user_name":"坏坏的举哥","can_delete":false,"product_type":"c1","uid":1084636,"ip_address":"","ucode":"98D1BAA79DC0C0","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJQsyr2Ge5iaKwEUQibeWDAa9sU5w3xmbBTBa4u9mibkKTia2DfDVdRCKL69rYradbmxBzQsPsNrPBic8A/132","comment_is_top":false,"comment_ctime":1567674391,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"18747543575","product_id":100017501,"comment_content":"库存分为三种，可售库存、未付款库存、未发货库存，三者想加是总库存；<br>下单时，可售库存减，未付款库存加；付款后，未付款库存减，未发货库存加；<br>库存操作使用数据库乐观锁机制；<br>针对秒杀场景，可以针对sku进行合并扣减库存，先放在多队列进行合并数目，然后再一次写到库中；<br>这才是实际可行方案。","like_count":4},{"had_liked":false,"id":52389,"user_name":"Runlion","can_delete":false,"product_type":"c1","uid":1336945,"ip_address":"","ucode":"2801D35CB5343D","user_header":"","comment_is_top":false,"comment_ctime":1545374209,"is_pvip":true,"replies":[{"id":"19630","content":"haha，有意思，不过我们的商品库存本来就是分库分表的，不同的商品库存本身就不在一台机器上的。","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1545822596,"ip_address":"","comment_id":52389,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18725243393","product_id":100017501,"comment_content":"我又一个想法：就是讲总库存分成几批分别储存在不同的服务器上，比如100个商品分别放在5台服务器abcd，每台放20个商品，用户通过抢购进入网关，我们可以制定一个路由策略比如用户id等于1-100的去a抢购，id等于201-300去b抢购，以此类推，整个抢购活动结束后在整体同步到数据库，这样做减少了数据的并发计算，由于是抢购也不存在单台服务商品库存过剩的情况，您觉得这个思路怎么样？","like_count":4,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433856,"discussion_content":"haha，有意思，不过我们的商品库存本来就是分库分表的，不同的商品库存本身就不在一台机器上的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545822596,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":36505,"user_name":"葫芦堂","can_delete":false,"product_type":"c1","uid":1015520,"ip_address":"","ucode":"CD29DE163CCE18","user_header":"https://static001.geekbang.org/account/avatar/00/0f/7e/e0/6f976978.jpg","comment_is_top":false,"comment_ctime":1541134368,"is_pvip":false,"replies":[{"id":"13012","content":"第三方支付我不知道有没有提供在真正支付之前有没有回调接口，就是在输了支付密码后再调用一次减库存接口，如果这时失败了就判断没有库存了。但是由于支付系统始终不是内部系统，所以不能方便的做事物控制。所以可能是存在极端情况下的超卖。","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1541239360,"ip_address":"","comment_id":36505,"utype":1}],"discussion_count":5,"race_medal":0,"score":"18721003552","product_id":100017501,"comment_content":"许老师，系统支付中遇到一个问题，特向您请教：<br>系统说明：系统主要是户外旅游报名，报名成功与否，以支付为准，即「支付减库存」，下单后有效支付时间是15分钟，对接了微信、支付宝支付。<br>问题描述：有时出现名额超报1-2名。例如：一个活动还剩2个名额，这时用户A报名2人并下单后选择支付宝去支付（打开支付宝页面前做了人数判断）；这时，用户B也报名1人下单后选择微信支付（打开微信页面之前也做了人数判断），结果可能由于网速或其他原因，用户B先支付成功了，接着30秒后，用户A也支付成功了，这样导致最终活动超报1人。<br>为此，我看了您讲的「秒杀系统减库存设计逻辑」，还是没有具体解决思路，望您给予指导，谢谢","like_count":4,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":427893,"discussion_content":"第三方支付我不知道有没有提供在真正支付之前有没有回调接口，就是在输了支付密码后再调用一次减库存接口，如果这时失败了就判断没有库存了。但是由于支付系统始终不是内部系统，所以不能方便的做事物控制。所以可能是存在极端情况下的超卖。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1541239360,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1723864,"avatar":"","nickname":"Geek_857","note":"","ucode":"08DB59885AE0CD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":72188,"discussion_content":"先减库存，生成预订单，超时再加回去，你这个旅游的报名，宁可少人，也不能多人。没有库存了，但是有未支付的订单，页面可以提示有多少人在排队中，排队的可能支付超时，有一个库存就显示库存，没有就显示排队人数","likes_number":7,"is_delete":false,"is_hidden":false,"ctime":1575471542,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1028212,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b0/74/f553f094.jpg","nickname":"Enjoystudy","note":"","ucode":"179ECDFA5F518B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":46729,"discussion_content":"你应该不管有没有支付成功先减库存，然后通过Delay Queue去check每笔订单的支付状态，比如最长支付时间是15min，如果15min后还没成功支付就把库存再加回去，同时把这笔交易关闭或者取消","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1573198823,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1935411,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/88/33/3b38c662.jpg","nickname":"小张同学","note":"","ucode":"8A5EA9EAD431E8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":295326,"discussion_content":"微信，支付宝这种支付结果通知都是异步的，只要去申请支付后就需要先删减库存，然后设置一个超时时间，过了超时时间以后就加回去","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1596165330,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1190236,"avatar":"https://static001.geekbang.org/account/avatar/00/12/29/5c/6e2e1ffd.jpg","nickname":"蓝白之间","note":"","ucode":"FE50E0D4B05FC1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":210680,"discussion_content":"这个其实就是应该采用预扣库存的方案。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1584760626,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":32539,"user_name":"oyhk","can_delete":false,"product_type":"c1","uid":1263917,"ip_address":"","ucode":"B64A75FBC120FC","user_header":"https://static001.geekbang.org/account/avatar/00/13/49/2d/0914ee90.jpg","comment_is_top":false,"comment_ctime":1539604941,"is_pvip":true,"replies":[{"id":"12240","content":"我建议使用redis的主备模式就行了，不需要分布式锁，让同一个商品的库存只在一个实例中，用分布式锁可能相对数据库优势可能不大了","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1540097972,"ip_address":"","comment_id":32539,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18719474125","product_id":100017501,"comment_content":"如果把库存放在redis中做扣减，再配合redis分布式锁是否可以实现？","like_count":4,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426810,"discussion_content":"我建议使用redis的主备模式就行了，不需要分布式锁，让同一个商品的库存只在一个实例中，用分布式锁可能相对数据库优势可能不大了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1540097972,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":30351,"user_name":"Bigming","can_delete":false,"product_type":"c1","uid":1110656,"ip_address":"","ucode":"D3445D1E0B0D95","user_header":"https://static001.geekbang.org/account/avatar/00/10/f2/80/06b34656.jpg","comment_is_top":false,"comment_ctime":1538804265,"is_pvip":false,"replies":[{"id":"11008","content":"自动解冻可以在应用程序中设置一个定时器来定时扫描数据库的下单时间，来比较是否已经超时<br><br>延时一点问题也不大，因为超时时间也是人为主观设置的","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1538904751,"ip_address":"","comment_id":30351,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18718673449","product_id":100017501,"comment_content":"预扣库存方案中如何确保十分钟后库存自动解冻？定时任务还是会有延迟吧？","like_count":4,"discussions":[{"author":{"id":1018706,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/8b/52/6659dc1b.jpg","nickname":"黑米","note":"","ucode":"E7DBEA7867862A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":390874,"discussion_content":"可以用rocketmq的延时消息队列","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630113611,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":30337,"user_name":"Laputa","can_delete":false,"product_type":"c1","uid":1079345,"ip_address":"","ucode":"64C157042CF138","user_header":"https://static001.geekbang.org/account/avatar/00/10/78/31/c7f8d1db.jpg","comment_is_top":false,"comment_ctime":1538798521,"is_pvip":false,"replies":[{"id":"10946","content":"库存不足时也就是秒杀结束时了，即使再有一次磁盘操作问题也不大了<br>看这个语句应该也可以","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1538820247,"ip_address":"","comment_id":30337,"utype":1}],"discussion_count":4,"race_medal":0,"score":"18718667705","product_id":100017501,"comment_content":"请问文中扣库存的case when语句:<br>UPDATE item SET inventory = CASE WHEN inventory &gt;= xxx THEN inventory-xxx ELSE inventory END<br>当库存不足时，是不是还会执行一次更新操作，即多一次磁盘写操作？<br>如果改成这样:<br>UPDATE item SET inventory = inventory-xxx where inventory - xxx &gt;= 0<br>是否可行？谢谢","like_count":4,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":425948,"discussion_content":"库存不足时也就是秒杀结束时了，即使再有一次磁盘操作问题也不大了\n看这个语句应该也可以","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1538820247,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1030049,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b7/a1/992481b9.jpg","nickname":"路飞","note":"","ucode":"9F2F47ABD60149","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":5450,"discussion_content":"UPDATE item SET inventory = CASE WHEN inventory >= xxx THEN inventory-xxx ELSE inventory END 这种写法执行后返回修改行数为1，代码里面如何判断是否减库存成功呢？ UPDATE item SET inventory = inventory-xxx where inventory - xxx >= 0这种写法在减库存失败的时候执行结果就是影响0行。请指教，谢谢","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1566280586,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1083167,"avatar":"https://static001.geekbang.org/account/avatar/00/10/87/1f/eae2af5a.jpg","nickname":"pmgcat","note":"","ucode":"C773924AEEB580","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1030049,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b7/a1/992481b9.jpg","nickname":"路飞","note":"","ucode":"9F2F47ABD60149","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":336988,"discussion_content":"值不变那就是没有影响，即失败时返回为0","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608738728,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":5450,"ip_address":""},"score":336988,"extra":""}]},{"author":{"id":1113874,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83er2rgam9XfHbuSIZB4S3UG2GLrf9CLkiatDG62eEMicT4yprYdSAZET3kfqQBPxqBHkZw2KRhMdJX4Q/132","nickname":"啸歌","note":"","ucode":"D8C8963BB940F6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":259025,"discussion_content":"我也是觉得老师的sql有问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588751878,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":91857,"user_name":"如果可以改变","can_delete":false,"product_type":"c1","uid":1427946,"ip_address":"","ucode":"64AB9E200AD7AC","user_header":"https://static001.geekbang.org/account/avatar/00/15/c9/ea/08c2cc5b.jpg","comment_is_top":false,"comment_ctime":1557120904,"is_pvip":true,"replies":[{"id":"34292","content":"保证减redis库存，发消息时写入mysql都是原子性，还不如直接在MySQL里减库存","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1558246544,"ip_address":"","comment_id":91857,"utype":1}],"discussion_count":4,"race_medal":0,"score":"14442022792","product_id":100017501,"comment_content":"老师，你好，现在项目中使用了redis预扣库存，同时使用了rabbitmq来异步下单，问题在于，先预扣库存，同时为了保证消息一定发送成功，将消息写入mqsql，以用于定时任务扫描，确保消息一定发送出去。遇到一个很棘手的问题，要保证减redis库存，发消息时写入mysql都是原子性的，要么都成功，要么都失败，可以讲一下阿里早期是怎么实现的吗？","like_count":3,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":449060,"discussion_content":"保证减redis库存，发消息时写入mysql都是原子性，还不如直接在MySQL里减库存","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1558246544,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1139455,"avatar":"https://static001.geekbang.org/account/avatar/00/11/62/ff/f71034e9.jpg","nickname":"悟空WuKong","note":"","ucode":"49AFD2B048C1BA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":217552,"discussion_content":"rabbitmq也能保证可靠送达，你存mysql是多余的操作。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1585569656,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1723864,"avatar":"","nickname":"Geek_857","note":"","ucode":"08DB59885AE0CD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":72222,"discussion_content":"你们要是数据库少可以这样做，老师他们用的数据库太多，分库分表把流量都分散了，直接操作库就行，库少减轻库的压力就得损失性能","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1575472199,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1723864,"avatar":"","nickname":"Geek_857","note":"","ucode":"08DB59885AE0CD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":72230,"discussion_content":"换个mq，使用Rocketmq的事物机制","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1575472382,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":84989,"user_name":"Geek_0bf600","can_delete":false,"product_type":"c1","uid":1438017,"ip_address":"","ucode":"823A1DBBCA1911","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJMDso6t36OSGLEQGHtzsHC4UekSEjq1sZW7cssnCsUicxicmunVicgEJpSibH0bWcxxSeia7VRxChBJDg/132","comment_is_top":false,"comment_ctime":1554952958,"is_pvip":false,"replies":[{"id":"34285","content":"丢弃☺️","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1558245856,"ip_address":"","comment_id":84989,"utype":1}],"discussion_count":3,"race_medal":0,"score":"14439854846","product_id":100017501,"comment_content":"如果并发很大，应用层队列很可能导致内存溢出，何解？","like_count":3,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":446519,"discussion_content":"丢弃☺️","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1558245856,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1121758,"avatar":"https://static001.geekbang.org/account/avatar/00/11/1d/de/62bfa83f.jpg","nickname":"aoe","note":"","ucode":"1C6201EDB4E954","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":18867,"discussion_content":"Kafka、流处理、批处理也可以","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1569116439,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1195258,"avatar":"https://static001.geekbang.org/account/avatar/00/12/3c/fa/e2990931.jpg","nickname":"文敦复","note":"","ucode":"B8F4A6BD5D7805","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":199214,"discussion_content":"流量接入的地方，通过令牌通之类的，先限流一次吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583570789,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":61363,"user_name":"锐","can_delete":false,"product_type":"c1","uid":1110915,"ip_address":"","ucode":"A245BA96C9471F","user_header":"https://static001.geekbang.org/account/avatar/00/10/f3/83/e2612d81.jpg","comment_is_top":false,"comment_ctime":1547686593,"is_pvip":false,"replies":[{"id":"22004","content":"用缓存来存放库存信息是有你说的风险，当然我们要做些措施来保证缓存不会轻易挂掉，例如做限流保护、做多机房备份（第7节介绍了很多兜底方案）。当然如果出现最极端的情况，那就只能停止秒杀该商品了。","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1547982069,"ip_address":"","comment_id":61363,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14432588481","product_id":100017501,"comment_content":"没人回答问题了么。想知道减库存在缓存中操作，如果还没持久化之前缓存挂了，数据丢失了，实际库存没减，该怎么补救呢？或者这篇都是基于缓存不会挂的情况下设计的？","like_count":3,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":436849,"discussion_content":"用缓存来存放库存信息是有你说的风险，当然我们要做些措施来保证缓存不会轻易挂掉，例如做限流保护、做多机房备份（第7节介绍了很多兜底方案）。当然如果出现最极端的情况，那就只能停止秒杀该商品了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547982069,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":36311,"user_name":"null","can_delete":false,"product_type":"c1","uid":1024294,"ip_address":"","ucode":"F9039EFED6B55D","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaELZPnUAiajaR5C25EDLWeJURggyiaOP5GGPe2qlwpQcm5e3ybib8OsP4tvddFDLVRSNNGL5I3SFPJHsA/132","comment_is_top":false,"comment_ctime":1541034671,"is_pvip":false,"replies":[{"id":"13016","content":"如果秒到了，用户不支付，那么剩下的就只能继续卖了😁","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1541239952,"ip_address":"","comment_id":36311,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14425936559","product_id":100017501,"comment_content":"许老师，您好！<br>秒杀结束后被释放的库存，如何继续卖？<br><br>例如抢“真香”手机，1000 台秒完后，用户都散了，秒杀结束。这时支付超时所释放的库存，如何处理？不卖了还是继续组织秒杀？<br><br>谢谢！<br>","like_count":3,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":427824,"discussion_content":"如果秒到了，用户不支付，那么剩下的就只能继续卖了😁","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1541239952,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":32243,"user_name":"shawn","can_delete":false,"product_type":"c1","uid":1053716,"ip_address":"","ucode":"8F7CE170AE1F57","user_header":"","comment_is_top":false,"comment_ctime":1539494005,"is_pvip":false,"replies":[{"id":"11697","content":"没有绝对的对错，每个方案都有有缺点<br>具体到实际中要评估下这么做是否优点大与缺点就行","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1539497909,"ip_address":"","comment_id":32243,"utype":1}],"discussion_count":2,"race_medal":0,"score":"14424395893","product_id":100017501,"comment_content":"没法回复自己的留言，补一条评论，<br>提前下单把下单分两步做，主要是为了把一部分业务前置做完，抢购的时候不用处理和人无关的业务逻辑，把抢下单变成抢订单，<br>另外因为库存已经全部扣完，无需同步库存，也就不存在冲突域竞争问题，可以把订单分布到多个机器上均衡负载，机器上订单抢完就下线，剩下有订单剩余的继续服务，没有可服务的机器时直接返回失败，不用加减库存<br><br>做法的缺陷确实是下单变成两步完成，加大了复杂度，但只要控制下单人员的逻辑维护在可持久化的缓存的话，可以完全不写入任何订单表数据，再支付完成后一次性更新就行，本质上节省了整个下单的逻辑执行消耗<br>不过确实越复杂的系统越容易出错<br><br>以上望老师指正<br>","like_count":3,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426695,"discussion_content":"没有绝对的对错，每个方案都有有缺点\n具体到实际中要评估下这么做是否优点大与缺点就行","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539497909,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2170038,"avatar":"https://static001.geekbang.org/account/avatar/00/21/1c/b6/949b691a.jpg","nickname":"草帽","note":"","ucode":"2B1340A680176B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":305570,"discussion_content":"库存全部扣减完，如果订单数量不对，会不会存在数据不一致问题。比如我卖10件，结果只有5个人付款了，那么是不是库存要加回去？或者redis宕机了，恢复之后，秒杀活动也结束了，库存如何回滚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600003227,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":30548,"user_name":"公号-技术夜未眠","can_delete":false,"product_type":"c1","uid":1013683,"ip_address":"","ucode":"83825B57CBD952","user_header":"https://static001.geekbang.org/account/avatar/00/0f/77/b3/991f3f9b.jpg","comment_is_top":false,"comment_ctime":1538919621,"is_pvip":true,"replies":[{"id":"11196","content":"减库存的幂等是在创建订单时保证的<br>幂等一般都是保证不会有重复提交发生","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1539085653,"ip_address":"","comment_id":30548,"utype":1}],"discussion_count":3,"race_medal":0,"score":"14423821509","product_id":100017501,"comment_content":"许老师好，减库存的操作是否需要考虑操作的幂等性？如果要考虑，如何实现？","like_count":3,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426033,"discussion_content":"减库存的幂等是在创建订单时保证的\n幂等一般都是保证不会有重复提交发生","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539085653,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1121758,"avatar":"https://static001.geekbang.org/account/avatar/00/11/1d/de/62bfa83f.jpg","nickname":"aoe","note":"","ucode":"1C6201EDB4E954","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":18864,"discussion_content":"如何实现？下单的时候领个令牌？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1569116317,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2063114,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/7b/0a/b65e1fae.jpg","nickname":"不要挑战自己的智商","note":"","ucode":"4910FF07C35DC5","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":306292,"discussion_content":"什么情况下会有重复提交呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600240457,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":30407,"user_name":"李明成","can_delete":false,"product_type":"c1","uid":1256488,"ip_address":"","ucode":"E44922559132EB","user_header":"https://static001.geekbang.org/account/avatar/00/13/2c/28/bff8f0c4.jpg","comment_is_top":false,"comment_ctime":1538829638,"is_pvip":false,"replies":[{"id":"11678","content":"逻辑上差别不大，只是秒杀可能会简化一些，比如秒杀才用下单减库存，其他商品目前大多采用预扣的方式","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1539496166,"ip_address":"","comment_id":30407,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14423731526","product_id":100017501,"comment_content":"这跟非秒杀系统，减库存也没有什么区别","like_count":3,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":425984,"discussion_content":"逻辑上差别不大，只是秒杀可能会简化一些，比如秒杀才用下单减库存，其他商品目前大多采用预扣的方式","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539496166,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":30338,"user_name":"λ-Drive","can_delete":false,"product_type":"c1","uid":1007176,"ip_address":"","ucode":"E6A91B142BF7E1","user_header":"https://static001.geekbang.org/account/avatar/00/0f/5e/48/4ad04a37.jpg","comment_is_top":false,"comment_ctime":1538798718,"is_pvip":false,"replies":[{"id":"10937","content":"肯定要分布式，但是需要通过一致性hash来把同一个商品的库存路由到同一台缓存中，这样并发写操作都在同一个缓存实例中完成了。","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1538818781,"ip_address":"","comment_id":30338,"utype":1}],"discussion_count":2,"race_medal":0,"score":"14423700606","product_id":100017501,"comment_content":"老师，你好，<br>你提到秒杀商品减库存直接放到缓存系统中实现，也就是直接在缓存中减库存或者在一个带有持久化功能的缓存系统（如 Redis）中完成。这种实现并发读写怎样保持数据一致？以及是不是要用分布式缓存？<br>同问。","like_count":3,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":425949,"discussion_content":"肯定要分布式，但是需要通过一致性hash来把同一个商品的库存路由到同一台缓存中，这样并发写操作都在同一个缓存实例中完成了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1538818781,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2063114,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/7b/0a/b65e1fae.jpg","nickname":"不要挑战自己的智商","note":"","ucode":"4910FF07C35DC5","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":306293,"discussion_content":"万一那1台缓存挂了。。。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600240552,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":136956,"user_name":"跃然","can_delete":false,"product_type":"c1","uid":1634828,"ip_address":"","ucode":"A7102EE599F57E","user_header":"https://static001.geekbang.org/account/avatar/00/18/f2/0c/c6bec9ff.jpg","comment_is_top":false,"comment_ctime":1569566239,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10159500831","product_id":100017501,"comment_content":"秒杀场景下减库存如果按照老师说的按照下单即减库存的做法去做，不还是会出现恶意卖家，大量下单不买的问题吗？","like_count":2},{"had_liked":false,"id":90683,"user_name":"Geek_41d472","can_delete":false,"product_type":"c1","uid":1247965,"ip_address":"","ucode":"DEC2B6329460CF","user_header":"https://static001.geekbang.org/account/avatar/00/13/0a/dd/88fa7b52.jpg","comment_is_top":false,"comment_ctime":1556609377,"is_pvip":false,"replies":[{"id":"34290","content":"看起来是可行的，就是操作起来复杂了","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1558246306,"ip_address":"","comment_id":90683,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10146543969","product_id":100017501,"comment_content":"我有个长想法，如果是基于mysql做减库存操作，比如某个商品，其实就是直接对这行数据的库存减1操作，mysql的行锁会存在锁净增，假设这个商品库存是1000，那么把这条数据可以拆成20条库存数据，每条库存量是500，这样可以极大的避免锁竞争，通过hash用户id去这20行数据更新减库存,当然了如果某行数据库存减到0了，再hash到剩余的行减库存，这样可以吗","like_count":2,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":448614,"discussion_content":"看起来是可行的，就是操作起来复杂了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1558246306,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":35045,"user_name":"诗泽","can_delete":false,"product_type":"c1","uid":1031865,"ip_address":"","ucode":"F28BE01C3FD12F","user_header":"https://static001.geekbang.org/account/avatar/00/0f/be/b9/f2481c2c.jpg","comment_is_top":false,"comment_ctime":1540388592,"is_pvip":false,"replies":[{"id":"12635","content":"是的，适时会单独整理QA文章","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1540640341,"ip_address":"","comment_id":35045,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10130323184","product_id":100017501,"comment_content":"请求队列的相关问题会在哪里统一回答呢？是会新增篇Q&amp;A文章吗？","like_count":2,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":427425,"discussion_content":"是的，适时会单独整理QA文章","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1540640341,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":299032,"user_name":"浩然","can_delete":false,"product_type":"c1","uid":1295043,"ip_address":"","ucode":"D1FB4E3E7ADE5F","user_header":"https://static001.geekbang.org/account/avatar/00/13/c2/c3/da31c9c2.jpg","comment_is_top":false,"comment_ctime":1624432594,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5919399890","product_id":100017501,"comment_content":"我以为的：比较详细的方案<br>实际的：缓存、排队","like_count":1,"discussions":[{"author":{"id":1882517,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/b9/95/cabab54b.jpg","nickname":"tong","note":"","ucode":"966DEDE81081D0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":391444,"discussion_content":"一点不落地，花的钱不够吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630466285,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":240776,"user_name":"刘锡铭","can_delete":false,"product_type":"c1","uid":1237272,"ip_address":"","ucode":"95EC10A37743CC","user_header":"https://static001.geekbang.org/account/avatar/00/12/e1/18/4df900c6.jpg","comment_is_top":false,"comment_ctime":1597061338,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5892028634","product_id":100017501,"comment_content":"请问redis加减库存怎么保证数据准确性？比如网络超时等err，无法判断库存操作实际是成功了还是失败了。","like_count":1,"discussions":[{"author":{"id":1180092,"avatar":"https://static001.geekbang.org/account/avatar/00/12/01/bc/f917aa92.jpg","nickname":"爽歪歪","note":"","ucode":"D32824F5BB6A17","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":358548,"discussion_content":"我觉得可以通过lua实现一个幂等的减库存操作    用户进来的时候先判断有没有抢成功   如果成功了  直接返回抢购成功   如果没这个用户的抢购记录  则尝试减库存    减成功之后  记录这个用户抢购成功   否则返回抢购失败   ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1615992954,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":75323,"user_name":"不学习就失业","can_delete":false,"product_type":"c1","uid":1458001,"ip_address":"","ucode":"0ED9C67EE933C9","user_header":"https://static001.geekbang.org/account/avatar/00/16/3f/51/0860fa6f.jpg","comment_is_top":false,"comment_ctime":1552378683,"is_pvip":false,"replies":[{"id":"30099","content":"缓存和MySQL的数据一致性不可能做到神同步的，没必要一直纠结这个问题，你要思考的是缓存是用来干啥的，你要做的就是评估出现不一致时到底对业务有啥影响，如何保证最终一致性。","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1554533604,"ip_address":"","comment_id":75323,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5847345979","product_id":100017501,"comment_content":"再补充一下，异步消息库存失效，而不是decr操作。那么失效以后新的数据不是依旧又继续要从mysql查吗？？？秒杀刚开始的时候库存老是减少，redis不停失效，那和直接查mysql有什么区别呢","like_count":1,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":442860,"discussion_content":"缓存和MySQL的数据一致性不可能做到神同步的，没必要一直纠结这个问题，你要思考的是缓存是用来干啥的，你要做的就是评估出现不一致时到底对业务有啥影响，如何保证最终一致性。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1554533604,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":65202,"user_name":"9080","can_delete":false,"product_type":"c1","uid":1114072,"ip_address":"","ucode":"D4DFBBC1B8394D","user_header":"https://static001.geekbang.org/account/avatar/00/10/ff/d8/fa77b4eb.jpg","comment_is_top":false,"comment_ctime":1549102436,"is_pvip":false,"replies":[{"id":"23146","content":"看返回更新的行数","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1549165110,"ip_address":"","comment_id":65202,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5844069732","product_id":100017501,"comment_content":"许老师请教个问题，UPDATE item SET inventory = CASE WHEN inventory &gt;= xxx THEN inventory-xxx ELSE inventory END 这个sql语句当库存不足的时候，也是会执行成功的吧，那么这样应用程序根据什么来抛出库存不足的错误呢","like_count":1,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438358,"discussion_content":"看返回更新的行数","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1549165110,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":48136,"user_name":"飞天小侠","can_delete":false,"product_type":"c1","uid":1309949,"ip_address":"","ucode":"F771AAF558DDAA","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLBWb8MQOy1NIBlqRJ3hfGe4XB7sLZpgpGA5KRpZoOQfzXW3rV3RLYGePS1PGUARR5WdH7ODMicjnQ/132","comment_is_top":false,"comment_ctime":1544366305,"is_pvip":false,"replies":[{"id":"19645","content":"异步减在正常情况下都是可以的，关键是要考虑异常情况怎么处理，比如异步减失败了怎么办，如何保证数据一致性 是个很复杂的事情，应用层简单的办法就是同步调用两个都成功了才算成功，但是比较耗性能，一般都采用最终一致性，就是异步去减然后保证最终一定会减成功，当然数据要以数据库为准。","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1545825408,"ip_address":"","comment_id":48136,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5839333601","product_id":100017501,"comment_content":"老师好，我想问下，把减库存的操作放缓存里，同时我想在缓存里减库存的时候，想办法也把数据库中的库存也减掉，保证数据库中的库存是准确的，你有什么好的方案么？比如我的想法是，每次缓存中减库存的时候异步发个消息去通知数数据库减库存这样可以么？一般有什么好的方案保证数据库中库存的准确性","like_count":1,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432043,"discussion_content":"异步减在正常情况下都是可以的，关键是要考虑异常情况怎么处理，比如异步减失败了怎么办，如何保证数据一致性 是个很复杂的事情，应用层简单的办法就是同步调用两个都成功了才算成功，但是比较耗性能，一般都采用最终一致性，就是异步去减然后保证最终一定会减成功，当然数据要以数据库为准。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545825408,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":31838,"user_name":"五年","can_delete":false,"product_type":"c1","uid":1081224,"ip_address":"","ucode":"28A6F945FB0626","user_header":"https://static001.geekbang.org/account/avatar/00/10/7f/88/c4263c58.jpg","comment_is_top":false,"comment_ctime":1539309684,"is_pvip":false,"replies":[{"id":"11615","content":"判断超卖就看是否库存减为负数就行了，这样更简单","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1539420006,"ip_address":"","comment_id":31838,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5834276980","product_id":100017501,"comment_content":"如果使用 redis 来进行减库存的话; <br>INCR key 这种原子级操作(原子级加 然后 对比总库存 )可以来作为判断超卖的依据吗 ; 是否还需要其他辅助手段?<br>","like_count":1,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426534,"discussion_content":"判断超卖就看是否库存减为负数就行了，这样更简单","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539420006,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":322473,"user_name":"扭断翅膀的猪","can_delete":false,"product_type":"c1","uid":1251238,"ip_address":"","ucode":"E94AE44B950C91","user_header":"https://static001.geekbang.org/account/avatar/00/13/17/a6/fae3dd91.jpg","comment_is_top":false,"comment_ctime":1637404133,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1637404133","product_id":100017501,"comment_content":"实现支付才扣减库存时库存不足进行后续马上的失败或者退款处理就好了. 也不会有严格的超卖问题","like_count":0},{"had_liked":false,"id":304539,"user_name":"silent","can_delete":false,"product_type":"c1","uid":1082550,"ip_address":"","ucode":"33BBC7AC2E3B48","user_header":"https://static001.geekbang.org/account/avatar/00/10/84/b6/3cf7b56c.jpg","comment_is_top":false,"comment_ctime":1627471216,"is_pvip":false,"discussion_count":0,"race_medal":1,"score":"1627471216","product_id":100017501,"comment_content":"这个排队等待这个<br>在应用端做, 是不是可以认为其实就是应用再访问数据库执行sql的时候加了限流,<br>在数据库端做, 是不是可以认为其实就是数据库在处理接受到的sql请求也做一层限流","like_count":0},{"had_liked":false,"id":282729,"user_name":"废材姑娘","can_delete":false,"product_type":"c1","uid":1047537,"ip_address":"","ucode":"6AFB48B2A4939A","user_header":"https://static001.geekbang.org/account/avatar/00/0f/fb/f1/a2cde35e.jpg","comment_is_top":false,"comment_ctime":1615380815,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1615380815","product_id":100017501,"comment_content":"最想看的实际咋做的没有","like_count":0},{"had_liked":false,"id":282330,"user_name":"扬眉剑出鞘","can_delete":false,"product_type":"c1","uid":1215123,"ip_address":"","ucode":"F24328705698B3","user_header":"https://static001.geekbang.org/account/avatar/00/12/8a/93/53b2ecc9.jpg","comment_is_top":false,"comment_ctime":1615198228,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1615198228","product_id":100017501,"comment_content":"订单和库存一般都是不同的子系统吧，这里减库存如何支持同一个订单重入？","like_count":0},{"had_liked":false,"id":262800,"user_name":"escray","can_delete":false,"product_type":"c1","uid":1020525,"ip_address":"","ucode":"1F4204930E47C4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/92/6d/becd841a.jpg","comment_is_top":false,"comment_ctime":1605846523,"is_pvip":true,"discussion_count":0,"race_medal":2,"score":"1605846523","product_id":100017501,"comment_content":"减库存的三种方式：下单减库存、付款减库存、预扣库存，我觉的一般的电商网站，采用下单减库存就可以，相对比较简单。而秒杀系统可能需要预扣库存，但是保留时间可能比较短（比如 1 分钟）。<br><br>看到文中提到的恶意下单情况，那么一般的业务系统也需要预扣库存了。而文中推荐秒杀系统采用下单减库存的方式，与我之前的想象，完全相反。<br><br>减库存这一篇似乎是整个系列里面留言最多的。<br><br>看完了几乎所有留言，@坏坏的举哥 的方案，将库存分为可售库存、未付款库存和未发货库存，看上去的确很好。","like_count":0},{"had_liked":false,"id":236965,"user_name":"torres","can_delete":false,"product_type":"c1","uid":1108761,"ip_address":"","ucode":"34DABCFC7B74EA","user_header":"https://static001.geekbang.org/account/avatar/00/10/eb/19/76b0b98c.jpg","comment_is_top":false,"comment_ctime":1595605877,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1595605877","product_id":100017501,"comment_content":"据我所知，目前阿里 MySQL 团队已经将包含这些补丁程序的 MySQL 开源。<br><br>请问老师，说的是够是 Alisql?<br><br>https:&#47;&#47;github.com&#47;alibaba&#47;AliSQL","like_count":0},{"had_liked":false,"id":229356,"user_name":"泥豆","can_delete":false,"product_type":"c1","uid":1109839,"ip_address":"","ucode":"DCB7CCE396B710","user_header":"https://static001.geekbang.org/account/avatar/00/10/ef/4f/4655dfb9.jpg","comment_is_top":false,"comment_ctime":1592971983,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1592971983","product_id":100017501,"comment_content":"活动系统要独立出来<br>活动商品数据表库存值字段不能为负<br>只处理库存对应数量的请求","like_count":0},{"had_liked":false,"id":228143,"user_name":"despacito","can_delete":false,"product_type":"c1","uid":1237056,"ip_address":"","ucode":"FF6ACB4447C934","user_header":"https://static001.geekbang.org/account/avatar/00/12/e0/40/3301e490.jpg","comment_is_top":false,"comment_ctime":1592566268,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1592566268","product_id":100017501,"comment_content":"库存保留是怎么保留？会实际数据库减去库存，如果释放库存再次更新数据库吗。","like_count":0},{"had_liked":false,"id":219143,"user_name":"山猫","can_delete":false,"product_type":"c1","uid":1466682,"ip_address":"","ucode":"004F622AEDA906","user_header":"https://static001.geekbang.org/account/avatar/00/16/61/3a/a259c187.jpg","comment_is_top":false,"comment_ctime":1589955102,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1589955102","product_id":100017501,"comment_content":"之前看过类似的文章说到关于如何扣减的办法，一种思路是先减库存，后生成订单。另一种是生成订单，再减库存。都是在同一个事务里完成。不知道哪个更好，或者说和场景有关呢？","like_count":0},{"had_liked":false,"id":217792,"user_name":"爱学习的大叔","can_delete":false,"product_type":"c1","uid":1085152,"ip_address":"","ucode":"91F9ABF1EC98D0","user_header":"https://static001.geekbang.org/account/avatar/00/10/8e/e0/847348b1.jpg","comment_is_top":false,"comment_ctime":1589614943,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1589614943","product_id":100017501,"comment_content":"阿里的数据库团队开发了针对这种 MySQL 的 InnoDB 层上的补丁程序（patch），可以在数据库层上对单行记录做到并发排队。<br><br>这个牛逼啊","like_count":0},{"had_liked":false,"id":203514,"user_name":"InfoQ_e077cb303519","can_delete":false,"product_type":"c1","uid":1390669,"ip_address":"","ucode":"2CCA309DB2EF46","user_header":"https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLAK6F4BFT5ewhJEeZrjmRx5HxP8tvnNpJcpLlotHiadp0s6aL3d7LfMHEuQP6tibu80wUy8micVu4oQ/132","comment_is_top":false,"comment_ctime":1586225096,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1586225096","product_id":100017501,"comment_content":"把库存放到redis存储，然后递减为零，如果为零不再出单，后面应用层和数据库操作异步消息处理，老师你看可以不有没有弊端","like_count":0,"discussions":[{"author":{"id":1180092,"avatar":"https://static001.geekbang.org/account/avatar/00/12/01/bc/f917aa92.jpg","nickname":"爽歪歪","note":"","ucode":"D32824F5BB6A17","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":358554,"discussion_content":"如果一个用户抢购了  实际成功了   但是网络原因给你返回了err  怎么处理？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1615993083,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":192119,"user_name":"第一装甲集群司令克莱斯特","can_delete":false,"product_type":"c1","uid":1265707,"ip_address":"","ucode":"4E8FBB23AD860B","user_header":"https://static001.geekbang.org/account/avatar/00/13/50/2b/2344cdaa.jpg","comment_is_top":false,"comment_ctime":1584839646,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1584839646","product_id":100017501,"comment_content":"12306不就是预扣库存嘛，下单后，30分钟的付款时间，不付款，票不算抢到啦了。","like_count":0},{"had_liked":false,"id":192086,"user_name":"Mango","can_delete":false,"product_type":"c1","uid":1734886,"ip_address":"","ucode":"EC2D20BD322E22","user_header":"","comment_is_top":false,"comment_ctime":1584837083,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1584837083","product_id":100017501,"comment_content":"12306的减库存好复杂，因为乘客可能从每一站上车或下车，设计一个可行又人性化的抢票方案很重要","like_count":0},{"had_liked":false,"id":175681,"user_name":"Cest La Vie🤩","can_delete":false,"product_type":"c1","uid":1177849,"ip_address":"","ucode":"EDABE70BB796AC","user_header":"https://static001.geekbang.org/account/avatar/00/11/f8/f9/5d983b88.jpg","comment_is_top":false,"comment_ctime":1580797991,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1580797991","product_id":100017501,"comment_content":"单商品并发的扣减请求，无法避免行锁的竞争，我们的场景下，目前做了请求合并。","like_count":0},{"had_liked":false,"id":168841,"user_name":"Eco","can_delete":false,"product_type":"c1","uid":1373230,"ip_address":"","ucode":"5459B494753183","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/x86UN2kFbJGGwiaw7yeVtyaf05y5eZmdOciaAF09WEBRVicbPGsej1b62UAH3icjeJqvibVc6aqB0EuFwDicicKKcF47w/132","comment_is_top":false,"comment_ctime":1578196619,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1578196619","product_id":100017501,"comment_content":"这里的商品数据存在数据库中可不可以分多行存储，就能增大数据库的并发量呢，这种方式问题就在需要分流，将不同的请求分到不同的行。","like_count":0},{"had_liked":false,"id":163661,"user_name":"AAA_叶子","can_delete":false,"product_type":"c1","uid":1325994,"ip_address":"","ucode":"1E93617D308EE0","user_header":"https://static001.geekbang.org/account/avatar/00/14/3b/aa/e8dfcd7e.jpg","comment_is_top":false,"comment_ctime":1576762777,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1576762777","product_id":100017501,"comment_content":"我们是使用 redis +lua 脚本的方式减库存， 用lua脚本保证redis的查询和修改操作的原子性。","like_count":0},{"had_liked":false,"id":133161,"user_name":"-W.LI-","can_delete":false,"product_type":"c1","uid":1210699,"ip_address":"","ucode":"3556786538664F","user_header":"https://static001.geekbang.org/account/avatar/00/12/79/4b/740f91ca.jpg","comment_is_top":false,"comment_ctime":1568424383,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1568424383","product_id":100017501,"comment_content":"老师好!能对订单库存进行锁分段么，同一个订单库存在多个表里面都维护库存。总库存就是加起来的。并发写的效率可以高一点。不过均匀分布不太好做","like_count":0},{"had_liked":false,"id":118297,"user_name":"想当上帝的司机","can_delete":false,"product_type":"c1","uid":1239378,"ip_address":"","ucode":"D8251388854911","user_header":"https://static001.geekbang.org/account/avatar/00/12/e9/52/f07e9001.jpg","comment_is_top":false,"comment_ctime":1564313467,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1564313467","product_id":100017501,"comment_content":"数据库层上对单行记录做到并发排队  这个sql功能合并进mysql了吗 有具体的链接介绍吗","like_count":0},{"had_liked":false,"id":107883,"user_name":"Geek_a20f57","can_delete":false,"product_type":"c1","uid":1464650,"ip_address":"","ucode":"8F21B6641C74BA","user_header":"","comment_is_top":false,"comment_ctime":1561628666,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1561628666","product_id":100017501,"comment_content":"挺好的","like_count":0},{"had_liked":false,"id":102908,"user_name":"kjson","can_delete":false,"product_type":"c1","uid":1059015,"ip_address":"","ucode":"E7886969205A77","user_header":"https://static001.geekbang.org/account/avatar/00/10/28/c7/e9f4bf77.jpg","comment_is_top":false,"comment_ctime":1560326706,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1560326706","product_id":100017501,"comment_content":"老师好，我设计秒杀系统遇到了库存回滚的问题，比如用户抢到秒杀，库存减一，如果5分钟内不支付，就会把库存加一，那么在并发高的情况下库存就会回滚多了，目前我是按照订单数来限制，比如200库存，那么订单最多200个，这样限制回滚操作，不过原因和最佳解决方法没找到","like_count":0},{"had_liked":false,"id":97226,"user_name":"左。","can_delete":false,"product_type":"c1","uid":1150013,"ip_address":"","ucode":"998F88B31535FC","user_header":"https://static001.geekbang.org/account/avatar/00/11/8c/3d/658bdf0b.jpg","comment_is_top":false,"comment_ctime":1558615236,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1558615236","product_id":100017501,"comment_content":"借用前面一个人说的，因为下单和付款涉及到很多查询和写库。这种情况下，我是不是可以预估一下这个产品的销量。然后提前下单，提前付款。等用户来买了，只要把这个订单给他就行了。这个时候的读写库操作可能仅仅是更新一个字段。 ？","like_count":0,"discussions":[{"author":{"id":1190236,"avatar":"https://static001.geekbang.org/account/avatar/00/12/29/5c/6e2e1ffd.jpg","nickname":"蓝白之间","note":"","ucode":"FE50E0D4B05FC1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":210695,"discussion_content":"这个不适用于秒杀，而且提前付款这操作吓人。没有发生真正的付款，就记录了付款成功，支付系统的真实性如何保证？财务如何了解这些？如果这些订单有剩余那不是要删除支付成功记录？这个对于预付款有可行性。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584761630,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":95908,"user_name":"AmosWooo","can_delete":false,"product_type":"c1","uid":1191605,"ip_address":"","ucode":"481780ABC37013","user_header":"https://static001.geekbang.org/account/avatar/00/12/2e/b5/5f1c7ae1.jpg","comment_is_top":false,"comment_ctime":1558253189,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1558253189","product_id":100017501,"comment_content":"许老师，您好。<br>秒杀场景，假设库存相关操作都放在redis中处理，采用主备方式。为了提高读性能 可能 采用主从读写分离。<br>如果采用，那将面临数据短时间不一致问题； 不采用的话，就需要提前做好限流措施，避免redis主实例承受过大并发读写而出现性能瓶颈。<br>如果是您，您会如何折中?<br>谢谢回答～","like_count":0},{"had_liked":false,"id":93224,"user_name":"如果可以改变","can_delete":false,"product_type":"c1","uid":1427946,"ip_address":"","ucode":"64AB9E200AD7AC","user_header":"https://static001.geekbang.org/account/avatar/00/15/c9/ea/08c2cc5b.jpg","comment_is_top":false,"comment_ctime":1557443024,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1557443024","product_id":100017501,"comment_content":"老师，UPDATE secKill.sk_secKill_goods<br>SET secKill_stock_count = CASE<br>                            WHEN secKill_stock_count &gt;= 1 THEN secKill_stock_count - 1<br>                            ELSE secKill_stock_count END where id=125354546566;<br>不管是否执行减库存，都是返回1，如何没有减值返回0呢","like_count":0,"discussions":[{"author":{"id":1033630,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/c5/9e/d6fce09c.jpg","nickname":"暴走的🐌","note":"","ucode":"804381D877E53C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":334080,"discussion_content":"jdbcUrl里加上useAffectedRows=true","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1607738314,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":90041,"user_name":"蚂蚁内推+v","can_delete":false,"product_type":"c1","uid":1050508,"ip_address":"","ucode":"24B10AEE54B3FD","user_header":"https://static001.geekbang.org/account/avatar/00/10/07/8c/0d886dcc.jpg","comment_is_top":false,"comment_ctime":1556377221,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1556377221","product_id":100017501,"comment_content":"感觉极致优化小节里面主要是讲怎么保证其他非秒杀商品的可用性，避免因为秒杀占用太多的数据库链接资源。具体秒杀场景扣库存怎么做到更高并发且不出错，这个还是不太明白。","like_count":0},{"had_liked":false,"id":83649,"user_name":"小谢同学","can_delete":false,"product_type":"c1","uid":1032544,"ip_address":"","ucode":"E809E6BC470631","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c1/60/fc3689d0.jpg","comment_is_top":false,"comment_ctime":1554690345,"is_pvip":false,"replies":[{"id":"34284","content":"如果请求量不大的话，可以尝试。如果量大，会导致消息积压，体验较差","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1558245797,"ip_address":"","comment_id":83649,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1554690345","product_id":100017501,"comment_content":"可否在应用层对用户请求进行排队？比如写入到mq里，如果秒杀商品就100件，那就先到先得，并且下单就要付款，后续的用户直接返回结束页面？","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":446115,"discussion_content":"如果请求量不大的话，可以尝试。如果量大，会导致消息积压，体验较差","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1558245797,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":75730,"user_name":"不似旧日","can_delete":false,"product_type":"c1","uid":1161271,"ip_address":"","ucode":"DF4C5E3AB9570C","user_header":"https://static001.geekbang.org/account/avatar/00/11/b8/37/98991aeb.jpg","comment_is_top":false,"comment_ctime":1552460156,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1552460156","product_id":100017501,"comment_content":"解决库存超卖: 将数据库字段类型设为无符号整数","like_count":0},{"had_liked":false,"id":75321,"user_name":"不学习就失业","can_delete":false,"product_type":"c1","uid":1458001,"ip_address":"","ucode":"0ED9C67EE933C9","user_header":"https://static001.geekbang.org/account/avatar/00/16/3f/51/0860fa6f.jpg","comment_is_top":false,"comment_ctime":1552378499,"is_pvip":false,"replies":[{"id":"30098","content":"缓存没有必要极致追求数据的准确性，只要保证最终一致性。缓存本身为了减少数据库的压力，后面的章节也介绍了数据的准确性和一致性由数据库来保证。<br>重复下单问题是个常识性问题，解决方案网上有很多，可以随便搜一下就有答案","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1554533329,"ip_address":"","comment_id":75321,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1552378499","product_id":100017501,"comment_content":"还是不太明白，后续如何能保证mysql和redis里的库存数量是一模一样的。看评论好像是mysql更新成功后发一个异步消息再去更新redis的库存，那样还是有不少时间差。<br>还有一个问题，如果下单扣库存都是实时的，因为频繁点击导致的重复下单之类的是怎么排除的呢？？<br>文章写得略范，具体的操作细节看不到","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":442859,"discussion_content":"缓存没有必要极致追求数据的准确性，只要保证最终一致性。缓存本身为了减少数据库的压力，后面的章节也介绍了数据的准确性和一致性由数据库来保证。\n重复下单问题是个常识性问题，解决方案网上有很多，可以随便搜一下就有答案","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1554533329,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":69193,"user_name":"李强Belo","can_delete":false,"product_type":"c1","uid":1209754,"ip_address":"","ucode":"5D3E9A4769037C","user_header":"https://static001.geekbang.org/account/avatar/00/12/75/9a/e55cabf8.jpg","comment_is_top":false,"comment_ctime":1550675576,"is_pvip":false,"replies":[{"id":"26124","content":"你可以再继续分析一下这么做有啥优点和缺点","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1551525591,"ip_address":"","comment_id":69193,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1550675576","product_id":100017501,"comment_content":"可以把比如1个商品100的库存拆成10个子商品，每个商品10个库存的思路吗","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":439993,"discussion_content":"你可以再继续分析一下这么做有啥优点和缺点","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551525591,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":67879,"user_name":"Do","can_delete":false,"product_type":"c1","uid":1313480,"ip_address":"","ucode":"EA11EBD6439D1B","user_header":"https://static001.geekbang.org/account/avatar/00/14/0a/c8/dae4a360.jpg","comment_is_top":false,"comment_ctime":1550307962,"is_pvip":false,"replies":[{"id":"26118","content":"实时发现的热点数据做数据库测过的迁移是比较难的，因为数据迁移比较复杂，容易出错，所以不建议做","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1551525092,"ip_address":"","comment_id":67879,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1550307962","product_id":100017501,"comment_content":"你好，请问下。热点数据是在数据库层做了隔离，那么如果是实时发现的热点数据呢，是发现后将数据迁移到热点数据库集群吗？迁移的过程中，该商品可以扣减库存吗？","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":439408,"discussion_content":"实时发现的热点数据做数据库测过的迁移是比较难的，因为数据迁移比较复杂，容易出错，所以不建议做","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551525092,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":67141,"user_name":"williamcai","can_delete":false,"product_type":"c1","uid":1158294,"ip_address":"","ucode":"B158F52C2D39BC","user_header":"https://static001.geekbang.org/account/avatar/00/11/ac/96/46b13896.jpg","comment_is_top":false,"comment_ctime":1550102982,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1550102982","product_id":100017501,"comment_content":"预扣库存，为了保证库存最终一致性，如何在各层做库存校验","like_count":0},{"had_liked":false,"id":64326,"user_name":"咖啡控","can_delete":false,"product_type":"c1","uid":1124728,"ip_address":"","ucode":"E8D994E2E80266","user_header":"https://static001.geekbang.org/account/avatar/00/11/29/78/1eea1af1.jpg","comment_is_top":false,"comment_ctime":1548747180,"is_pvip":false,"replies":[{"id":"23144","content":"我印象中应该是默认的repeatable-read吧，准确的可能要问下我们的dba同学了，后面见到他们我再问问：）","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1549164586,"ip_address":"","comment_id":64326,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1548747180","product_id":100017501,"comment_content":"请问老师,减库存db事务隔离级别是？","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437960,"discussion_content":"我印象中应该是默认的repeatable-read吧，准确的可能要问下我们的dba同学了，后面见到他们我再问问：）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1549164586,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":60973,"user_name":"锐","can_delete":false,"product_type":"c1","uid":1110915,"ip_address":"","ucode":"A245BA96C9471F","user_header":"https://static001.geekbang.org/account/avatar/00/10/f3/83/e2612d81.jpg","comment_is_top":false,"comment_ctime":1547600052,"is_pvip":false,"replies":[{"id":"22002","content":"可以看看第7节介绍的内容","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1547981762,"ip_address":"","comment_id":60973,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1547600052","product_id":100017501,"comment_content":"大佬们，如果缓存挂了要怎么做。","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":436690,"discussion_content":"可以看看第7节介绍的内容","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547981762,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":59574,"user_name":"歪头儿在帝都","can_delete":false,"product_type":"c1","uid":1220330,"ip_address":"","ucode":"ADF272E86CDDDB","user_header":"https://static001.geekbang.org/account/avatar/00/12/9e/ea/f556db9a.jpg","comment_is_top":false,"comment_ctime":1547387847,"is_pvip":false,"replies":[{"id":"22001","content":"在第8节你去看看","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1547981653,"ip_address":"","comment_id":59574,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1547387847","product_id":100017501,"comment_content":"许老师您好，我从评论中看到关心秒杀请求放到消息队列后如何通知客户端的伙伴比较多？ 这个问题会单独开一节专栏讲解么？ ","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":436358,"discussion_content":"在第8节你去看看","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547981653,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":57338,"user_name":"swortect","can_delete":false,"product_type":"c1","uid":1288071,"ip_address":"","ucode":"A8C294E590C1B6","user_header":"https://static001.geekbang.org/account/avatar/00/13/a7/87/4f2fa359.jpg","comment_is_top":false,"comment_ctime":1546754821,"is_pvip":false,"replies":[{"id":"21994","content":"带上这个uid=0的条件，是啥用意？","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1547978656,"ip_address":"","comment_id":57338,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1546754821","product_id":100017501,"comment_content":"我们在抢红包这样的活动中是每一个红包都在红包表里有一个记录，更新数据库的时候带上条件uid =0，更新失败就是没抢到。请问在大厂会用这种方法么","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435531,"discussion_content":"带上这个uid=0的条件，是啥用意？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547978656,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":57336,"user_name":"swortect","can_delete":false,"product_type":"c1","uid":1288071,"ip_address":"","ucode":"A8C294E590C1B6","user_header":"https://static001.geekbang.org/account/avatar/00/13/a7/87/4f2fa359.jpg","comment_is_top":false,"comment_ctime":1546754523,"is_pvip":false,"replies":[{"id":"21993","content":"库存表包括哪些内容要看你业务的需要，这个我没法给你一个标准答案的呢！","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1547978592,"ip_address":"","comment_id":57336,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1546754523","product_id":100017501,"comment_content":"库存表一般怎么设计合理呢，需要包含哪些内容呢","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435529,"discussion_content":"库存表包括哪些内容要看你业务的需要，这个我没法给你一个标准答案的呢！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547978592,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":54379,"user_name":"Y.P.C","can_delete":false,"product_type":"c1","uid":1303055,"ip_address":"","ucode":"0496F78739B044","user_header":"https://static001.geekbang.org/account/avatar/00/13/e2/0f/274e12bf.jpg","comment_is_top":false,"comment_ctime":1545837222,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1545837222","product_id":100017501,"comment_content":"老师请问UPDATE item SET inventory = CASE WHEN inventory &gt;= xxx THEN inventory-xxx ELSE inventory END这个减库存语句和UPDATE item SET inventory=inventory-xxx WHERE inventory&gt;xxx有什么区别？","like_count":0},{"had_liked":false,"id":54375,"user_name":"Y.P.C","can_delete":false,"product_type":"c1","uid":1303055,"ip_address":"","ucode":"0496F78739B044","user_header":"https://static001.geekbang.org/account/avatar/00/13/e2/0f/274e12bf.jpg","comment_is_top":false,"comment_ctime":1545836751,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1545836751","product_id":100017501,"comment_content":"老师请问应用层做排队，怎么做？","like_count":0},{"had_liked":false,"id":53691,"user_name":"zk_207","can_delete":false,"product_type":"c1","uid":1183552,"ip_address":"","ucode":"196D92ECC8540D","user_header":"https://static001.geekbang.org/account/avatar/00/12/0f/40/e838871e.jpg","comment_is_top":false,"comment_ctime":1545711831,"is_pvip":false,"replies":[{"id":"19628","content":"目前防止超卖和少卖的成熟方案就是采用预扣库存的方案。缓存和DB同步我在最后一篇有介绍","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1545822176,"ip_address":"","comment_id":53691,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1545711831","product_id":100017501,"comment_content":"许老师，请问一下有没有什么特别好的方案防止少卖或者超卖呢？我看您这里没有给出具体的实现方案，比如放在缓存中，怎么做缓存和DB同步","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434221,"discussion_content":"目前防止超卖和少卖的成熟方案就是采用预扣库存的方案。缓存和DB同步我在最后一篇有介绍","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545822176,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":51431,"user_name":"D.L","can_delete":false,"product_type":"c1","uid":1339142,"ip_address":"","ucode":"E6DA186C4BB972","user_header":"https://static001.geekbang.org/account/avatar/00/14/6f/06/82d8bdfb.jpg","comment_is_top":false,"comment_ctime":1545182738,"is_pvip":false,"replies":[{"id":"19633","content":"MySQL的优化我不是很专业知识，建议订阅隔壁的MySQL课程:)","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1545823518,"ip_address":"","comment_id":51431,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1545182738","product_id":100017501,"comment_content":"针对最后阿里得mysql优化，是否麻烦您再多介绍一下，是如何知道这是事务中最后一条sql的？","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433451,"discussion_content":"MySQL的优化我不是很专业知识，建议订阅隔壁的MySQL课程:)","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545823518,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49156,"user_name":"张三丰","can_delete":false,"product_type":"c1","uid":1155275,"ip_address":"","ucode":"3A6215A40B3B21","user_header":"https://static001.geekbang.org/account/avatar/00/11/a0/cb/aab3b3e7.jpg","comment_is_top":false,"comment_ctime":1544612777,"is_pvip":false,"replies":[{"id":"19637","content":"在数据库中减库存就是通常的数据库更新数据的逻辑题（例如：库存－1）","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1545824521,"ip_address":"","comment_id":49156,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544612777","product_id":100017501,"comment_content":"如果你的秒杀商品的减库存逻辑非常单一，比如没有复杂的 SKU 库存和总库存这种联动关系的话，我觉得完全可以。但是如果有比较复杂的减库存逻辑，或者需要使用事务，你还是必须在数据库中完成减库存。<br><br><br>具体怎么做？","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432505,"discussion_content":"在数据库中减库存就是通常的数据库更新数据的逻辑题（例如：库存－1）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545824521,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":48713,"user_name":"食指可爱多","can_delete":false,"product_type":"c1","uid":1045721,"ip_address":"","ucode":"B918E07F55AB9E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f4/d9/e572ae4d.jpg","comment_is_top":false,"comment_ctime":1544520656,"is_pvip":true,"replies":[{"id":"19642","content":"如果非要只能用MySQL的话，那确实也没有什么好办法，可以用阿里经过优化的MySQL版本性能应该会好一点 :)","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1545824795,"ip_address":"","comment_id":48713,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544520656","product_id":100017501,"comment_content":"请问老师，某个单品库存很大又是一个爆品，扣库存时存在MySQL单点写瓶颈，如何应对呢？","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432323,"discussion_content":"如果非要只能用MySQL的话，那确实也没有什么好办法，可以用阿里经过优化的MySQL版本性能应该会好一点 :)","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545824795,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":48138,"user_name":"李冬辉","can_delete":false,"product_type":"c1","uid":1197302,"ip_address":"","ucode":"1F8A6CCC166960","user_header":"https://static001.geekbang.org/account/avatar/00/12/44/f6/3284e7cc.jpg","comment_is_top":false,"comment_ctime":1544366424,"is_pvip":false,"replies":[{"id":"19643","content":"早期我记得库存只是商品上的一个字段，后面越来越复杂了就单独拆成表来存储了。","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1545825100,"ip_address":"","comment_id":48138,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544366424","product_id":100017501,"comment_content":"老师您好以前没涉及到库存的管理，对于库存，是单独建表还是用字段存比较好，<br>建表即是比如100个商品food,生成100条商品数据在表里，<br>而存字段则是留存个库存字段只需要存值100即可","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432044,"discussion_content":"早期我记得库存只是商品上的一个字段，后面越来越复杂了就单独拆成表来存储了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545825100,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":42877,"user_name":"与你为邻","can_delete":false,"product_type":"c1","uid":1266803,"ip_address":"","ucode":"19D82053B1915E","user_header":"https://static001.geekbang.org/account/avatar/00/13/54/73/4c3179ab.jpg","comment_is_top":false,"comment_ctime":1543070430,"is_pvip":false,"replies":[{"id":"16249","content":"是的，加不加锁还是根据自己的场景来选择","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1543724013,"ip_address":"","comment_id":42877,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1543070430","product_id":100017501,"comment_content":"如果减库存放到redis里，需要加锁吗，加锁的话性能不好，不加锁，不就超买了","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":430226,"discussion_content":"是的，加不加锁还是根据自己的场景来选择","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1543724013,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1253652,"avatar":"https://static001.geekbang.org/account/avatar/00/13/21/14/423a821f.jpg","nickname":"Steven","note":"","ucode":"3FE64459842015","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":387899,"discussion_content":"redis 单条操作是原子的，不用加锁。如果还有附加逻辑可以用 Lua 脚本保证原子性","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628493728,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":42256,"user_name":"Olicawa","can_delete":false,"product_type":"c1","uid":1135432,"ip_address":"","ucode":"5DD67EC75112C6","user_header":"https://static001.geekbang.org/account/avatar/00/11/53/48/8183bbc3.jpg","comment_is_top":false,"comment_ctime":1542935988,"is_pvip":false,"replies":[{"id":"16247","content":"说实话比较难😳","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1543723768,"ip_address":"","comment_id":42256,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1542935988","product_id":100017501,"comment_content":"大额第三方支付的异步返回不及时导致实际减库存不准确的问题有什么好的方法吗？特别像银联，极端情况下1-2天才返回支付成功","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":430027,"discussion_content":"说实话比较难😳","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1543723768,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":41733,"user_name":"王肖武","can_delete":false,"product_type":"c1","uid":1282385,"ip_address":"","ucode":"561AF05284EBE2","user_header":"https://static001.geekbang.org/account/avatar/00/13/91/51/234f9a73.jpg","comment_is_top":false,"comment_ctime":1542847489,"is_pvip":false,"replies":[{"id":"16246","content":"看执行结果啊","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1543723720,"ip_address":"","comment_id":41733,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1542847489","product_id":100017501,"comment_content":"UPDATE item SET inventory = CASE WHEN inventory &gt;= xxx THEN inventory-xxx ELSE inventory END<br><br>SQL这样写怎知道减库存是成功的还是失败了","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":429882,"discussion_content":"看执行结果啊","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1543723720,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":38801,"user_name":"汪炜","can_delete":false,"product_type":"c1","uid":1307404,"ip_address":"","ucode":"64B548B9D06404","user_header":"https://static001.geekbang.org/account/avatar/00/13/f3/0c/b46fb155.jpg","comment_is_top":false,"comment_ctime":1542129512,"is_pvip":false,"replies":[{"id":"14445","content":"缓存的数据库数据同步一般都是最终一致性，用锁同步代价太大，得不偿失","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1542527444,"ip_address":"","comment_id":38801,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1542129512","product_id":100017501,"comment_content":"想了解一下，缓存和数据库一致性问题，看老师的留言说，数据库库存数据变更，失效缓存，那下一次线程库存扣减，是缓存要同步库吗？那大并发的情况下，应该要用分布式锁同步，那缓存不就失去意义了吗？","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":428814,"discussion_content":"缓存的数据库数据同步一般都是最终一致性，用锁同步代价太大，得不偿失","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1542527444,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":38760,"user_name":"钱","can_delete":false,"product_type":"c1","uid":1009652,"ip_address":"","ucode":"2C92A243A463D4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg","comment_is_top":false,"comment_ctime":1542121923,"is_pvip":false,"replies":[{"id":"14446","content":"虽然没太明白你说的逻辑，但是我想说下单付款的逻辑要尽量简单一点，不然会容易产生瓶颈","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1542527801,"ip_address":"","comment_id":38760,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1542121923","product_id":100017501,"comment_content":"从付款的角度来考虑，订单一般是分为先款订和后款订单的，针对后款订单应该下单后减库存，针对先款订单应使用付款后减库存，是否更好一些？<br>在缓存中建立秒杀商品的队列，根据商品的付款类型进行对应商品队列在不同环节进行库存的扣减操作，并且为了进一步防止超卖针对先款订单，建立一个临时的队列做扣减的操作，当付款后再针对真实的队列进行扣减处理","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":428801,"discussion_content":"虽然没太明白你说的逻辑，但是我想说下单付款的逻辑要尽量简单一点，不然会容易产生瓶颈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1542527801,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":38723,"user_name":"杨康","can_delete":false,"product_type":"c1","uid":1179356,"ip_address":"","ucode":"B9BAE2DCE50CAC","user_header":"https://static001.geekbang.org/account/avatar/00/11/fe/dc/3c025f83.jpg","comment_is_top":false,"comment_ctime":1542115031,"is_pvip":false,"replies":[{"id":"14449","content":"令牌锁有点像vip卡吗😊，但是我觉得在web端做排队没必要，建议看下最后一篇文章","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1542528148,"ip_address":"","comment_id":38723,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1542115031","product_id":100017501,"comment_content":"对于大量请求用令牌锁做过滤，然后用队列来保护集群，ng通过ip去hash队列中的请求。这样就不会有超卖的情况。是否售空也可以通过令牌数来判断","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":428783,"discussion_content":"令牌锁有点像vip卡吗😊，但是我觉得在web端做排队没必要，建议看下最后一篇文章","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1542528148,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":38336,"user_name":"鹏鹏","can_delete":false,"product_type":"c1","uid":1147167,"ip_address":"","ucode":"71D6760513BDEF","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKkArlpiaIrFcArautVD6hSlkaTcKJN802c3yJ0yGJZuyPZMcCP5wibtFX31OUcjZuCll0WM1PFI0qw/132","comment_is_top":false,"comment_ctime":1542023309,"is_pvip":true,"replies":[{"id":"14454","content":"如果redis和mysql都有数据，要以mysql为准。不过你的意思是以redis数据为准的话，如果只是秒杀商品的话，就只能停止秒杀了","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1542528471,"ip_address":"","comment_id":38336,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1542023309","product_id":100017501,"comment_content":"您好，如果库存放redis里面，然后异步减MySQL库存，如果redis减完库存突然挂了，2者就不同步了，这种情况会怎么处理？","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":428674,"discussion_content":"如果redis和mysql都有数据，要以mysql为准。不过你的意思是以redis数据为准的话，如果只是秒杀商品的话，就只能停止秒杀了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1542528471,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":38091,"user_name":"敏敏","can_delete":false,"product_type":"c1","uid":1120596,"ip_address":"","ucode":"28C8E8899F74D8","user_header":"https://static001.geekbang.org/account/avatar/00/11/19/54/4341f5b7.jpg","comment_is_top":false,"comment_ctime":1541930790,"is_pvip":false,"replies":[{"id":"14468","content":"可以把问题再详细一点","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1542529857,"ip_address":"","comment_id":38091,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1541930790","product_id":100017501,"comment_content":"在数据库用cas即乐观锁解决一致性问题吧","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":428597,"discussion_content":"可以把问题再详细一点","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1542529857,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":36801,"user_name":"大魔王汪汪","can_delete":false,"product_type":"c1","uid":1010680,"ip_address":"","ucode":"4B205CB52FC95F","user_header":"https://static001.geekbang.org/account/avatar/00/0f/6b/f8/b4da7936.jpg","comment_is_top":false,"comment_ctime":1541336840,"is_pvip":false,"replies":[{"id":"14466","content":"这是直接到mysql，读走缓存","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1542529747,"ip_address":"","comment_id":36801,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1541336840","product_id":100017501,"comment_content":"淘宝在实践秒杀时，mysql集群是否可以直接扛住秒杀时的写压力呢？还是前面都有一个缓存撑着，当缓存集群不可用时，流量会限流打倒mysql集群吗？","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":428025,"discussion_content":"这是直接到mysql，读走缓存","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1542529747,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":35084,"user_name":"茎待佳阴","can_delete":false,"product_type":"c1","uid":1042464,"ip_address":"","ucode":"21A7DC2C3EA389","user_header":"https://static001.geekbang.org/account/avatar/00/0f/e8/20/3374ea9e.jpg","comment_is_top":false,"comment_ctime":1540398800,"is_pvip":false,"replies":[{"id":"12631","content":"对秒杀商品来说，如果把库存放到cache里去减库存，他的库存是有限的例如就10件，放在cache中，减完库存秒杀就结束了，也就不需要同步到数据库了","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1540630749,"ip_address":"","comment_id":35084,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1540398800","product_id":100017501,"comment_content":"把减库存的操作放缓存里，怎么保证缓存跟mysql里数据的一致性呢？更新缓存跟mysql谁先谁后？","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":427439,"discussion_content":"对秒杀商品来说，如果把库存放到cache里去减库存，他的库存是有限的例如就10件，放在cache中，减完库存秒杀就结束了，也就不需要同步到数据库了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1540630749,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":33560,"user_name":"Michael","can_delete":false,"product_type":"c1","uid":1094791,"ip_address":"","ucode":"0B19245EBD5996","user_header":"https://static001.geekbang.org/account/avatar/00/10/b4/87/6882f5f6.jpg","comment_is_top":false,"comment_ctime":1539825393,"is_pvip":false,"replies":[{"id":"12229","content":"排队我们可以做人为的控制，例如把那些需求访问同一资源的请求进行排队，让他们串行执行。减少由于资源冲突导致的锁竞争<br><br>而锁竞争不经会影响用户处理时间，还是消耗比较多的服务器资源，所以要尽量通过在应用层排队的方式避免产生锁竞争","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1540095392,"ip_address":"","comment_id":33560,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1539825393","product_id":100017501,"comment_content":"你可能有疑问了，排队和锁竞争不都是要等待吗，有啥区别？<br><br>这个地方的区别还是没太明白，可否细致的再解释下，谢谢许老师","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426996,"discussion_content":"排队我们可以做人为的控制，例如把那些需求访问同一资源的请求进行排队，让他们串行执行。减少由于资源冲突导致的锁竞争\n\n而锁竞争不经会影响用户处理时间，还是消耗比较多的服务器资源，所以要尽量通过在应用层排队的方式避免产生锁竞争","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1540095392,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":33255,"user_name":"曾斌","can_delete":false,"product_type":"c1","uid":1108573,"ip_address":"","ucode":"E6CEA931C3DEBC","user_header":"https://static001.geekbang.org/account/avatar/00/10/ea/5d/8f7b20a1.jpg","comment_is_top":false,"comment_ctime":1539766006,"is_pvip":false,"replies":[{"id":"12232","content":"缓存失效失败这个属于系统的异常处理了，比如redis写数据失败应该怎么处理？这个是类似的解决办法<br><br>Github上应该有，你找找","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1540096450,"ip_address":"","comment_id":33255,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1539766006","product_id":100017501,"comment_content":"1. 如果监控mysql binlog，发现字段变更消息通知应用将缓存失效，如果缓存失效失败怎么处理，缓存和数据库还是不一致？<br>2. alisql如何实现数据库排队，有网址学习吗？","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426955,"discussion_content":"缓存失效失败这个属于系统的异常处理了，比如redis写数据失败应该怎么处理？这个是类似的解决办法\n\nGithub上应该有，你找找","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1540096450,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":32579,"user_name":"皇甫","can_delete":false,"product_type":"c1","uid":1126865,"ip_address":"","ucode":"6856B2508661E0","user_header":"https://static001.geekbang.org/account/avatar/00/11/31/d1/dc1f9b95.jpg","comment_is_top":false,"comment_ctime":1539614385,"is_pvip":false,"replies":[{"id":"12238","content":"大家对请求队列这块问的比较多，后面相关的问题我找个时间统一回答一下吧。","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1540097768,"ip_address":"","comment_id":32579,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1539614385","product_id":100017501,"comment_content":"许老师，请问如果使用缓存来扣库存的话，当缓存里面扣了一件，我将这个信息发到消息队列中，然后直接给用户返回抢夺成功的页面。而系统后台异步处理，我通过消息的可靠消费来实现一定的下单成功。请问这样的方案可行吗？ <br>如果不可行的话，请问其他类似方案可选吗？","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426823,"discussion_content":"大家对请求队列这块问的比较多，后面相关的问题我找个时间统一回答一下吧。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1540097768,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":32260,"user_name":"方扯淡","can_delete":false,"product_type":"c1","uid":1101870,"ip_address":"","ucode":"6D3BD28626A6D5","user_header":"https://static001.geekbang.org/account/avatar/00/10/d0/2e/6a07ee70.jpg","comment_is_top":false,"comment_ctime":1539503389,"is_pvip":false,"replies":[{"id":"11759","content":"阿里的数据库已经开源了，叫alisql你可以搜一下","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1539528909,"ip_address":"","comment_id":32260,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1539503389","product_id":100017501,"comment_content":"阿里的mysql  的  patch叫什么？<br>","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426703,"discussion_content":"阿里的数据库已经开源了，叫alisql你可以搜一下","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539528909,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":31420,"user_name":"秋天","can_delete":false,"product_type":"c1","uid":1057056,"ip_address":"","ucode":"A7E1D953EF7E17","user_header":"https://static001.geekbang.org/account/avatar/00/10/21/20/1299e137.jpg","comment_is_top":false,"comment_ctime":1539175966,"is_pvip":true,"replies":[{"id":"11666","content":"数据层排队是比较好的一个方案，当然也可以在应用层实现，例如有很多多语言环境数据库层前面一般都有proxy层，在Proxy层排队也是一个思路，不过如果Proxy太多，排队也就和应用层本身排队差不多了，所以可以在应用层对请求适当的进行路由，让请求固定的落在部分的proxy上。","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1539495018,"ip_address":"","comment_id":31420,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1539175966","product_id":100017501,"comment_content":"如果没有说的阿里的那个数据库中间件数据库1排队这个方案还能考虑吗？有什么其他办法","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426329,"discussion_content":"数据层排队是比较好的一个方案，当然也可以在应用层实现，例如有很多多语言环境数据库层前面一般都有proxy层，在Proxy层排队也是一个思路，不过如果Proxy太多，排队也就和应用层本身排队差不多了，所以可以在应用层对请求适当的进行路由，让请求固定的落在部分的proxy上。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539495018,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":30973,"user_name":"彳","can_delete":false,"product_type":"c1","uid":1101973,"ip_address":"","ucode":"5ACE4746E2913B","user_header":"https://static001.geekbang.org/account/avatar/00/10/d0/95/f3283c31.jpg","comment_is_top":false,"comment_ctime":1539055424,"is_pvip":false,"replies":[{"id":"11188","content":"存储过程也可以实际测试一下试试性能如何","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1539084522,"ip_address":"","comment_id":30973,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1539055424","product_id":100017501,"comment_content":"下单记录和减库存用数据库存储过程也会快点吧？反正秒杀商品可以隔离到单独的数据库，可以减少一点行级锁锁定时间","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426166,"discussion_content":"存储过程也可以实际测试一下试试性能如何","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539084522,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":30896,"user_name":"肖建一","can_delete":false,"product_type":"c1","uid":1133414,"ip_address":"","ucode":"E3413BE9EF2D7E","user_header":"https://static001.geekbang.org/account/avatar/00/11/4b/66/71b5bcff.jpg","comment_is_top":false,"comment_ctime":1539045007,"is_pvip":false,"replies":[{"id":"11189","content":"排队本身就要牺牲一部分体验，因为延时会增加","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1539084598,"ip_address":"","comment_id":30896,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1539045007","product_id":100017501,"comment_content":"许老师，你好！<br>使用应用排队方式，入队后返回，如何保证用户体验？","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426137,"discussion_content":"排队本身就要牺牲一部分体验，因为延时会增加","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539084598,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":30739,"user_name":"Bigming","can_delete":false,"product_type":"c1","uid":1110656,"ip_address":"","ucode":"D3445D1E0B0D95","user_header":"https://static001.geekbang.org/account/avatar/00/10/f2/80/06b34656.jpg","comment_is_top":false,"comment_ctime":1538986629,"is_pvip":false,"replies":[{"id":"11195","content":"你说的这个情况是存在的<br><br>订单没有生成就就不能付款，所以超过一定时间预扣会自动释放","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1539085423,"ip_address":"","comment_id":30739,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1538986629","product_id":100017501,"comment_content":"下单过程中rpc调用库存冻结操作，这时候库存冻结成功了但是rpc返回超时了，导致订单创建失败，这种情况下怎么样解冻库存比较好，个人感觉订单没有生成，可以重试冻结或者是库存系统本身需要对冻结类型的订单在一定时间内看有没有解冻操作判断？","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426078,"discussion_content":"你说的这个情况是存在的\n\n订单没有生成就就不能付款，所以超过一定时间预扣会自动释放","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539085423,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":30626,"user_name":"Rosso","can_delete":false,"product_type":"c1","uid":1259309,"ip_address":"","ucode":"28845E04A77B0F","user_header":"https://static001.geekbang.org/account/avatar/00/13/37/2d/822fed5b.jpg","comment_is_top":false,"comment_ctime":1538961993,"is_pvip":false,"replies":[{"id":"11203","content":"就是把一些商品单独放到一个数据库实例里","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1539087045,"ip_address":"","comment_id":30626,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1538961993","product_id":100017501,"comment_content":"在淘宝的秒杀里，分离热点商品到单独的数据库这个优化方法到底有没有使用呢","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426052,"discussion_content":"就是把一些商品单独放到一个数据库实例里","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539087045,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":30439,"user_name":"永光","can_delete":false,"product_type":"c1","uid":1102702,"ip_address":"","ucode":"0C54531ABED1B0","user_header":"https://static001.geekbang.org/account/avatar/00/10/d3/6e/281b85aa.jpg","comment_is_top":false,"comment_ctime":1538864195,"is_pvip":false,"replies":[{"id":"11004","content":"单商品的库存并发写肯定要在同一个实例完成，一般都是在mysql中完成，在缓存中理论上要比mysql性能更高<br><br>单点问题是通过通过备库解决，不管是mysql还是缓存都需要有备库","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1538903656,"ip_address":"","comment_id":30439,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1538864195","product_id":100017501,"comment_content":"老师，你好<br>你说，“肯定要分布式，但是需要通过一致性hash来把同一个商品的库存路由到同一台缓存中，这样并发写操作都在同一个缓存实例中完成了”<br>我的疑问是<br>1.同一个缓存实例完成，并发读写并发能达到多少？会不会有瓶颈呀？<br>2.同一个缓存实例完成就会有单点故障了吧？<br>希望老师解答，谢谢。","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426002,"discussion_content":"单商品的库存并发写肯定要在同一个实例完成，一般都是在mysql中完成，在缓存中理论上要比mysql性能更高\n\n单点问题是通过通过备库解决，不管是mysql还是缓存都需要有备库","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1538903656,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":30363,"user_name":"kucoll","can_delete":false,"product_type":"c1","uid":1252487,"ip_address":"","ucode":"BB0334238EBF44","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKjbB3e9vSSgOfUfnrzwiaDfnHFqIibJe3KloA6BF1weklaBREIG8hEceWuH5T8cnWtRWcGMarVYlqg/132","comment_is_top":false,"comment_ctime":1538808772,"is_pvip":false,"replies":[{"id":"11009","content":"你可以按照你的想法实践一下试试😏","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1538904825,"ip_address":"","comment_id":30363,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1538808772","product_id":100017501,"comment_content":"最后其实是分布式如何保持秒杀商品读写一致性，整个秒杀的相关信息放到redis，redis在开启活动前将数据预热，配合前后端限流，风控系统拦截，将过滤后的有限个请求压入redis，再通过一个woker服务器程序每过固定的时间去将redis持久化到数据库，客户端异步查询redis中的持久化结果。这样不就可以了吗？   是不是我想简单了😂","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":425959,"discussion_content":"你可以按照你的想法实践一下试试😏","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1538904825,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":30330,"user_name":"MinFrog","can_delete":false,"product_type":"c1","uid":1254273,"ip_address":"","ucode":"AC9978B0087D4E","user_header":"https://static001.geekbang.org/account/avatar/00/13/23/81/6be4d122.jpg","comment_is_top":false,"comment_ctime":1538795528,"is_pvip":false,"replies":[{"id":"10938","content":"缓存需要和数据库一致，主要是通过数据库数据更新了就失效缓存来实现。<br>失效缓存一般主要是通过监控数据库数据字段的变更，一旦变更，就发一条失效消息失效缓存","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1538819161,"ip_address":"","comment_id":30330,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1538795528","product_id":100017501,"comment_content":"我尝试回答一下@永光的问题，如果引入缓存系统（如redis）并且读写都是通过redis，然么redis的单进程单线程特性确保了读写的一致性问题。<br>然后我的问题是如果引入缓存系统，并且要求保证缓存和数据库的读写一致，有没有什么好的方案？谢谢！","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":425945,"discussion_content":"缓存需要和数据库一致，主要是通过数据库数据更新了就失效缓存来实现。\n失效缓存一般主要是通过监控数据库数据字段的变更，一旦变更，就发一条失效消息失效缓存","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1538819161,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}