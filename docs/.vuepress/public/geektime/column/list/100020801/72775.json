{"id":72775,"title":"14 | count(*)这么慢，我该怎么办？","content":"<p>在开发系统的时候，你可能经常需要计算一个表的行数，比如一个交易系统的所有变更记录总数。这时候你可能会想，一条select count(*) from t 语句不就解决了吗？</p><p>但是，你会发现随着系统中记录数越来越多，这条语句执行得也会越来越慢。然后你可能就想了，MySQL怎么这么笨啊，记个总数，每次要查的时候直接读出来，不就好了吗。</p><p>那么今天，我们就来聊聊count(*)语句到底是怎样实现的，以及MySQL为什么会这么实现。然后，我会再和你说说，如果应用中有这种频繁变更并需要统计表行数的需求，业务设计上可以怎么做。</p><h1>count(*)的实现方式</h1><p>你首先要明确的是，在不同的MySQL引擎中，count(*)有不同的实现方式。</p><ul>\n<li>MyISAM引擎把一个表的总行数存在了磁盘上，因此执行count(*)的时候会直接返回这个数，效率很高；</li>\n<li>而InnoDB引擎就麻烦了，它执行count(*)的时候，需要把数据一行一行地从引擎里面读出来，然后累积计数。</li>\n</ul><p>这里需要注意的是，我们在这篇文章里讨论的是没有过滤条件的count(*)，如果加了where 条件的话，MyISAM表也是不能返回得这么快的。</p><p>在前面的文章中，我们一起分析了为什么要使用InnoDB，因为不论是在事务支持、并发能力还是在数据安全方面，InnoDB都优于MyISAM。我猜你的表也一定是用了InnoDB引擎。这就是当你的记录数越来越多的时候，计算一个表的总行数会越来越慢的原因。</p><!-- [[[read_end]]] --><p>那<strong>为什么InnoDB不跟MyISAM一样，也把数字存起来呢？</strong></p><p>这是因为即使是在同一个时刻的多个查询，由于多版本并发控制（MVCC）的原因，InnoDB表“应该返回多少行”也是不确定的。这里，我用一个算count(*)的例子来为你解释一下。</p><p>假设表t中现在有10000条记录，我们设计了三个用户并行的会话。</p><ul>\n<li>会话A先启动事务并查询一次表的总行数；</li>\n<li>会话B启动事务，插入一行后记录后，查询表的总行数；</li>\n<li>会话C先启动一个单独的语句，插入一行记录后，查询表的总行数。</li>\n</ul><p>我们假设从上到下是按照时间顺序执行的，同一行语句是在同一时刻执行的。</p><p><img src=\"https://static001.geekbang.org/resource/image/5e/97/5e716ba1d464c8224c1c1f36135d0e97.png?wh=943*362\" alt=\"\"></p><center><span class=\"reference\">图1 会话A、B、C的执行流程</span></center><p>你会看到，在最后一个时刻，三个会话A、B、C会同时查询表t的总行数，但拿到的结果却不同。</p><p>这和InnoDB的事务设计有关系，可重复读是它默认的隔离级别，在代码上就是通过多版本并发控制，也就是MVCC来实现的。每一行记录都要判断自己是否对这个会话可见，因此对于count(*)请求来说，InnoDB只好把数据一行一行地读出依次判断，可见的行才能够用于计算“基于这个查询”的表的总行数。</p><blockquote>\n<p>备注：如果你对MVCC记忆模糊了，可以再回顾下第3篇文章<a href=\"https://time.geekbang.org/column/article/68963\">《事务隔离：为什么你改了我还看不见？》</a>和第8篇文章<a href=\"https://time.geekbang.org/column/article/70562\">《事务到底是隔离的还是不隔离的？》</a>中的相关内容。</p>\n</blockquote><p>当然，现在这个看上去笨笨的MySQL，在执行count(*)操作的时候还是做了优化的。</p><p>你知道的，InnoDB是索引组织表，主键索引树的叶子节点是数据，而普通索引树的叶子节点是主键值。所以，普通索引树比主键索引树小很多。对于count(*)这样的操作，遍历哪个索引树得到的结果逻辑上都是一样的。因此，MySQL优化器会找到最小的那棵树来遍历。<strong>在保证逻辑正确的前提下，尽量减少扫描的数据量，是数据库系统设计的通用法则之一。</strong></p><p>如果你用过show table status 命令的话，就会发现这个命令的输出结果里面也有一个TABLE_ROWS用于显示这个表当前有多少行，这个命令执行挺快的，那这个TABLE_ROWS能代替count(*)吗？</p><p>你可能还记得在第10篇文章<a href=\"https://time.geekbang.org/column/article/71173\">《 MySQL为什么有时候会选错索引？》</a>中我提到过，索引统计的值是通过采样来估算的。实际上，TABLE_ROWS就是从这个采样估算得来的，因此它也很不准。有多不准呢，官方文档说误差可能达到40%到50%。<strong>所以，show table status命令显示的行数也不能直接使用。</strong></p><p>到这里我们小结一下：</p><ul>\n<li>MyISAM表虽然count(*)很快，但是不支持事务；</li>\n<li>show table status命令虽然返回很快，但是不准确；</li>\n<li>InnoDB表直接count(*)会遍历全表，虽然结果准确，但会导致性能问题。</li>\n</ul><p>那么，回到文章开头的问题，如果你现在有一个页面经常要显示交易系统的操作记录总数，到底应该怎么办呢？答案是，我们只能自己计数。</p><p>接下来，我们讨论一下，看看自己计数有哪些方法，以及每种方法的优缺点有哪些。</p><p>这里，我先和你说一下这些方法的基本思路：你需要自己找一个地方，把操作记录表的行数存起来。</p><h1>用缓存系统保存计数</h1><p>对于更新很频繁的库来说，你可能会第一时间想到，用缓存系统来支持。</p><p>你可以用一个Redis服务来保存这个表的总行数。这个表每被插入一行Redis计数就加1，每被删除一行Redis计数就减1。这种方式下，读和更新操作都很快，但你再想一下这种方式存在什么问题吗？</p><p>没错，缓存系统可能会丢失更新。</p><p>Redis的数据不能永久地留在内存里，所以你会找一个地方把这个值定期地持久化存储起来。但即使这样，仍然可能丢失更新。试想如果刚刚在数据表中插入了一行，Redis中保存的值也加了1，然后Redis异常重启了，重启后你要从存储redis数据的地方把这个值读回来，而刚刚加1的这个计数操作却丢失了。</p><p>当然了，这还是有解的。比如，Redis异常重启以后，到数据库里面单独执行一次count(*)获取真实的行数，再把这个值写回到Redis里就可以了。异常重启毕竟不是经常出现的情况，这一次全表扫描的成本，还是可以接受的。</p><p>但实际上，<strong>将计数保存在缓存系统中的方式，还不只是丢失更新的问题。即使Redis正常工作，这个值还是逻辑上不精确的。</strong></p><p>你可以设想一下有这么一个页面，要显示操作记录的总数，同时还要显示最近操作的100条记录。那么，这个页面的逻辑就需要先到Redis里面取出计数，再到数据表里面取数据记录。</p><p>我们是这么定义不精确的：</p><ol>\n<li>\n<p>一种是，查到的100行结果里面有最新插入记录，而Redis的计数里还没加1；</p>\n</li>\n<li>\n<p>另一种是，查到的100行结果里没有最新插入的记录，而Redis的计数里已经加了1。</p>\n</li>\n</ol><p>这两种情况，都是逻辑不一致的。</p><p>我们一起来看看这个时序图。</p><p><img src=\"https://static001.geekbang.org/resource/image/39/33/39898af053695dad37227d71ae288e33.png?wh=731*268\" alt=\"\"></p><center><span class=\"reference\">图2 会话A、B执行时序图</span></center><p>图2中，会话A是一个插入交易记录的逻辑，往数据表里插入一行R，然后Redis计数加1；会话B就是查询页面显示时需要的数据。</p><p>在图2的这个时序里，在T3时刻会话B来查询的时候，会显示出新插入的R这个记录，但是Redis的计数还没加1。这时候，就会出现我们说的数据不一致。</p><p>你一定会说，这是因为我们执行新增记录逻辑时候，是先写数据表，再改Redis计数。而读的时候是先读Redis，再读数据表，这个顺序是相反的。那么，如果保持顺序一样的话，是不是就没问题了？我们现在把会话A的更新顺序换一下，再看看执行结果。</p><p><img src=\"https://static001.geekbang.org/resource/image/5c/db/5c2f786beae1d8917cdc5033b7bf0bdb.png?wh=741*323\" alt=\"\"></p><center><span class=\"reference\">图3 调整顺序后，会话A、B的执行时序图</span></center><p>你会发现，这时候反过来了，会话B在T3时刻查询的时候，Redis计数加了1了，但还查不到新插入的R这一行，也是数据不一致的情况。</p><p>在并发系统里面，我们是无法精确控制不同线程的执行时刻的，因为存在图中的这种操作序列，所以，我们说即使Redis正常工作，这个计数值还是逻辑上不精确的。</p><h1>在数据库保存计数</h1><p>根据上面的分析，用缓存系统保存计数有丢失数据和计数不精确的问题。那么，<strong>如果我们把这个计数直接放到数据库里单独的一张计数表C中，又会怎么样呢？</strong></p><p>首先，这解决了崩溃丢失的问题，InnoDB是支持崩溃恢复不丢数据的。</p><blockquote>\n<p>备注：关于InnoDB的崩溃恢复，你可以再回顾一下第2篇文章<a href=\"https://time.geekbang.org/column/article/68633\">《日志系统：一条SQL更新语句是如何执行的？》</a>中的相关内容。</p>\n</blockquote><p>然后，我们再看看能不能解决计数不精确的问题。</p><p>你会说，这不一样吗？无非就是把图3中对Redis的操作，改成了对计数表C的操作。只要出现图3的这种执行序列，这个问题还是无解的吧？</p><p>这个问题还真不是无解的。</p><p>我们这篇文章要解决的问题，都是由于InnoDB要支持事务，从而导致InnoDB表不能把count(*)直接存起来，然后查询的时候直接返回形成的。</p><p>所谓以子之矛攻子之盾，现在我们就利用“事务”这个特性，把问题解决掉。</p><p><img src=\"https://static001.geekbang.org/resource/image/9e/e3/9e4170e2dfca3524eb5e92adb8647de3.png?wh=719*392\" alt=\"\"></p><center><span class=\"reference\">图4 会话A、B的执行时序图</span></center><p>我们来看下现在的执行结果。虽然会话B的读操作仍然是在T3执行的，但是因为这时候更新事务还没有提交，所以计数值加1这个操作对会话B还不可见。</p><p>因此，会话B看到的结果里， 查计数值和“最近100条记录”看到的结果，逻辑上就是一致的。</p><h1>不同的count用法</h1><p>在前面文章的评论区，有同学留言问到：在select count(?) from t这样的查询语句里面，count(*)、count(主键id)、count(字段)和count(1)等不同用法的性能，有哪些差别。今天谈到了count(*)的性能问题，我就借此机会和你详细说明一下这几种用法的性能差别。</p><p>需要注意的是，下面的讨论还是基于InnoDB引擎的。</p><p>这里，首先你要弄清楚count()的语义。count()是一个聚合函数，对于返回的结果集，一行行地判断，如果count函数的参数不是NULL，累计值就加1，否则不加。最后返回累计值。</p><p>所以，count(*)、count(主键id)和count(1) 都表示返回满足条件的结果集的总行数；而count(字段），则表示返回满足条件的数据行里面，参数“字段”不为NULL的总个数。</p><p>至于分析性能差别的时候，你可以记住这么几个原则：</p><ol>\n<li>\n<p>server层要什么就给什么；</p>\n</li>\n<li>\n<p>InnoDB只给必要的值；</p>\n</li>\n<li>\n<p>现在的优化器只优化了count(*)的语义为“取行数”，其他“显而易见”的优化并没有做。</p>\n</li>\n</ol><p>这是什么意思呢？接下来，我们就一个个地来看看。</p><p><strong>对于count(主键id)来说</strong>，InnoDB引擎会遍历整张表，把每一行的id值都取出来，返回给server层。server层拿到id后，判断是不可能为空的，就按行累加。</p><p><strong>对于count(1)来说</strong>，InnoDB引擎遍历整张表，但不取值。server层对于返回的每一行，放一个数字“1”进去，判断是不可能为空的，按行累加。</p><p>单看这两个用法的差别的话，你能对比出来，count(1)执行得要比count(主键id)快。因为从引擎返回id会涉及到解析数据行，以及拷贝字段值的操作。</p><p><strong>对于count(字段)来说</strong>：</p><ol>\n<li>\n<p>如果这个“字段”是定义为not null的话，一行行地从记录里面读出这个字段，判断不能为null，按行累加；</p>\n</li>\n<li>\n<p>如果这个“字段”定义允许为null，那么执行的时候，判断到有可能是null，还要把值取出来再判断一下，不是null才累加。</p>\n</li>\n</ol><p>也就是前面的第一条原则，server层要什么字段，InnoDB就返回什么字段。</p><p><strong>但是count(*)是例外</strong>，并不会把全部字段取出来，而是专门做了优化，不取值。count(*)肯定不是null，按行累加。</p><p>看到这里，你一定会说，优化器就不能自己判断一下吗，主键id肯定非空啊，为什么不能按照count(*)来处理，多么简单的优化啊。</p><p>当然，MySQL专门针对这个语句进行优化，也不是不可以。但是这种需要专门优化的情况太多了，而且MySQL已经优化过count(*)了，你直接使用这种用法就可以了。</p><p>所以结论是：按照效率排序的话，count(字段)&lt;count(主键id)&lt;count(1)≈count(*)，所以我建议你，尽量使用count(*)。</p><h1>小结</h1><p>今天，我和你聊了聊MySQL中获得表行数的两种方法。我们提到了在不同引擎中count(*)的实现方式是不一样的，也分析了用缓存系统来存储计数值存在的问题。</p><p>其实，把计数放在Redis里面，不能够保证计数和MySQL表里的数据精确一致的原因，是<strong>这两个不同的存储构成的系统，不支持分布式事务，无法拿到精确一致的视图。</strong>而把计数值也放在MySQL中，就解决了一致性视图的问题。</p><p>InnoDB引擎支持事务，我们利用好事务的原子性和隔离性，就可以简化在业务开发时的逻辑。这也是InnoDB引擎备受青睐的原因之一。</p><p>最后，又到了今天的思考题时间了。</p><p>在刚刚讨论的方案中，我们用了事务来确保计数准确。由于事务可以保证中间结果不被别的事务读到，因此修改计数值和插入新记录的顺序是不影响逻辑结果的。但是，从并发系统性能的角度考虑，你觉得在这个事务序列里，应该先插入操作记录，还是应该先更新计数表呢？</p><p>你可以把你的思考和观点写在留言区里，我会在下一篇文章的末尾给出我的参考答案。感谢你的收听，也欢迎你把这篇文章分享给更多的朋友一起阅读。</p><h1>上期问题时间</h1><p>上期我给你留的问题是，什么时候使用alter table t engine=InnoDB会让一个表占用的空间反而变大。</p><p>在这篇文章的评论区里面，大家都提到了一个点，就是这个表，本身就已经没有空洞的了，比如说刚刚做过一次重建表操作。</p><p>在DDL期间，如果刚好有外部的DML在执行，这期间可能会引入一些新的空洞。</p><p>@飞翔 提到了一个更深刻的机制，是我们在文章中没说的。在重建表的时候，InnoDB不会把整张表占满，每个页留了1/16给后续的更新用。也就是说，其实重建表之后不是“最”紧凑的。</p><p>假如是这么一个过程：</p><ol>\n<li>\n<p>将表t重建一次；</p>\n</li>\n<li>\n<p>插入一部分数据，但是插入的这些数据，用掉了一部分的预留空间；</p>\n</li>\n<li>\n<p>这种情况下，再重建一次表t，就可能会出现问题中的现象。</p>\n</li>\n</ol><p>评论区留言点赞板：</p><blockquote>\n<p>@W_T 等同学提到了数据表本身紧凑的情况；<br>\n@undifined 提了一个好问题， @帆帆帆帆帆帆帆帆 同学回答了这个问题；<br>\n@陈飞 @郜 @wang chen wen 都提了很不错的问题，大家可以去看看。</p>\n</blockquote><p></p>","comments":[{"had_liked":false,"id":49584,"user_name":"包包up","can_delete":false,"product_type":"c1","uid":1073495,"ip_address":"","ucode":"A6F51A62A8B362","user_header":"https://static001.geekbang.org/account/avatar/00/10/61/57/6f3c81dd.jpg","comment_is_top":true,"comment_ctime":1544723076,"is_pvip":false,"replies":[{"id":"17872","content":"好几个同学说对，你第一个标明出处👍🏿","user_name":"作者回复","comment_id":49584,"uid":"1264162","ip_address":"","utype":1,"ctime":1544750424,"user_name_real":"林晓斌"}],"discussion_count":14,"race_medal":0,"score":"9.2233747699987005e+18","product_id":100020801,"comment_content":"从并发系统性能的角度考虑，应该先插入操作记录，再更新计数表。<br><br>知识点在《行锁功过：怎么减少行锁对性能的影响？》<br>因为更新计数表涉及到行锁的竞争，先插入再更新能最大程度地减少了事务之间的锁等待，提升了并发度。","like_count":637,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432670,"discussion_content":"好几个同学说对，你第一个标明出处👍🏿","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544750424,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1489177,"avatar":"https://static001.geekbang.org/account/avatar/00/16/b9/19/f4ef2c9a.jpg","nickname":"秦穆之","note":"","ucode":"709C49BFCBB776","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":211015,"discussion_content":"要把最容易引发冲突的锁往后放","likes_number":32,"is_delete":false,"is_hidden":false,"ctime":1584799546,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1210505,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLUz2nCCzSKibFJibtoAJXo2lP3tmeRUe2EqmQr4kYbCv5q4eexhfN3XicynSx5uZ5EREumRwZxqHjGw/132","nickname":"小跳蛙","note":"","ucode":"6C4DADD8414F9D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":223687,"discussion_content":"我也想到了，但是我看的晚。难受","likes_number":20,"is_delete":false,"is_hidden":false,"ctime":1586246060,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":4,"child_discussions":[{"author":{"id":1254801,"avatar":"https://static001.geekbang.org/account/avatar/00/13/25/91/46600294.jpg","nickname":"猴哥一一 cium","note":"","ucode":"38EC64F8D1A0B4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1210505,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLUz2nCCzSKibFJibtoAJXo2lP3tmeRUe2EqmQr4kYbCv5q4eexhfN3XicynSx5uZ5EREumRwZxqHjGw/132","nickname":"小跳蛙","note":"","ucode":"6C4DADD8414F9D","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":312633,"discussion_content":"那我给你赞一个吧������","likes_number":5,"is_delete":false,"is_hidden":false,"ctime":1602753954,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":223687,"ip_address":""},"score":312633,"extra":""},{"author":{"id":1058015,"avatar":"https://static001.geekbang.org/account/avatar/00/10/24/df/645f8087.jpg","nickname":"Yayu","note":"","ucode":"5E7842458D8229","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1210505,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLUz2nCCzSKibFJibtoAJXo2lP3tmeRUe2EqmQr4kYbCv5q4eexhfN3XicynSx5uZ5EREumRwZxqHjGw/132","nickname":"小跳蛙","note":"","ucode":"6C4DADD8414F9D","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":324236,"discussion_content":"小跳蛙真棒","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1605076161,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":223687,"ip_address":""},"score":324236,"extra":""},{"author":{"id":1251835,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/oiboHpgukqib2ASXeU0H7W1ibgRMqyrNE5KaWicicPEDy0ia8YdoneZAtvW0EFIiaqZJp2OS4dnweOgXaJ5EjJicicEqic5A/132","nickname":"覃钰栋","note":"","ucode":"19080C463658EF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1210505,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLUz2nCCzSKibFJibtoAJXo2lP3tmeRUe2EqmQr4kYbCv5q4eexhfN3XicynSx5uZ5EREumRwZxqHjGw/132","nickname":"小跳蛙","note":"","ucode":"6C4DADD8414F9D","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":407384,"discussion_content":"并列第一","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1634997173,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":223687,"ip_address":""},"score":407384,"extra":""}]},{"author":{"id":1143536,"avatar":"https://static001.geekbang.org/account/avatar/00/11/72/f0/abb7bfe3.jpg","nickname":"Mcnulty","note":"","ucode":"3DD71D84B58A16","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":377109,"discussion_content":"插入数据也会获取间隙锁，需要评估间隙锁和行锁的加锁时间","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1622510454,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1295609,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJRFRX8kNzNet7FibNvtavbVpAwK09AhIhrib9k762qWtH6mre8ickP7hM5mgZC4ytr8NnmIfmAhxMSQ/132","nickname":"老大不小","note":"","ucode":"35BCDD3CB13467","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":586434,"discussion_content":"从另外一个角度来想，也是先插入后更新。因为更新是先删除再插入，操作比插入多，所以应该把更新放到最后。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1662210558,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1162562,"avatar":"https://static001.geekbang.org/account/avatar/00/11/bd/42/c7120b7f.jpg","nickname":"人不学习是🐷","note":"","ucode":"6B8979F46706FF","race_medal":1,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":585196,"discussion_content":"最容易造成冲突的操作，尽量靠近事务提交来做","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661392990,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2032894,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/04/fe/60db4684.jpg","nickname":"菜波","note":"","ucode":"DA7DED66709FA2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":396066,"discussion_content":"是的，要把最容易引起冲突的锁往后放","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632388446,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1255277,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLDVXsv6JOOficLK07867AkAb21eoG5KBgYFmwhMXKJooU5B6iaIZwyDxExicokVQSiaKEwZ4qPicqVFcg/132","nickname":"拼yin世界","note":"","ucode":"9571428A12B72A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":349797,"discussion_content":"牛逼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1613553381,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1810156,"avatar":"","nickname":"poordickey","note":"","ucode":"2A436EC813AF97","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":334381,"discussion_content":"这个情况会不会引起大量死锁","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1607832721,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1015189,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/7d/95/dd73022c.jpg","nickname":"我是曾经那个少年","note":"","ucode":"9F02F7FF147D14","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1810156,"avatar":"","nickname":"poordickey","note":"","ucode":"2A436EC813AF97","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":334731,"discussion_content":"不会死锁，只会等当持有锁的那个事务，死锁是因为互相依赖持有的资源，就是我等你释放资源，你等我释放资源。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1607953473,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":334381,"ip_address":""},"score":334731,"extra":""}]}]},{"had_liked":false,"id":50064,"user_name":"倪大人","can_delete":false,"product_type":"c1","uid":1193052,"ip_address":"","ucode":"4798D69F3E86FB","user_header":"https://static001.geekbang.org/account/avatar/00/12/34/5c/6b4757a0.jpg","comment_is_top":true,"comment_ctime":1544856594,"is_pvip":false,"replies":[{"id":"18012","content":"这些都不叫幻读，幻读的意思是“用一个事务里面，后一个请求看到的比之前相同请求看到的，多了记录出来”。<br>改了不算<br><br>大家关注一下这个问题。<br>好问题<br>","user_name":"作者回复","comment_id":50064,"uid":"1264162","ip_address":"","utype":1,"ctime":1544869444,"user_name_real":"林晓斌"}],"discussion_count":15,"race_medal":0,"score":"9.2233723089825997e+18","product_id":100020801,"comment_content":"看到有同学说会话A是幻读，其实图一的会话B才是幻读吧？","like_count":64,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432861,"discussion_content":"这些都不叫幻读，幻读的意思是“用一个事务里面，后一个请求看到的比之前相同请求看到的，多了记录出来”。\n改了不算\n\n大家关注一下这个问题。\n好问题\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544869444,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2176736,"avatar":"https://static001.geekbang.org/account/avatar/00/21/36/e0/2d0b4d64.jpg","nickname":"Paranoia °","note":"","ucode":"5FC91C698FA145","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":307821,"discussion_content":"幻读是后读取比之前多了数据（insert），数据改变了删除属于不可重复读（update和delete）,rr使用间隙锁解决了幻读，mvcc感觉是解决不可重复读的","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1600766265,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1014441,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/7a/a9/62a71245.jpg","nickname":"latecomer","note":"","ucode":"8D17798AE7D0AF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":171409,"discussion_content":"同一个事务里面，后一个请求看到的比之前少了记录算幻读么？很多地方讲到幻读都已增加记录为例，没谈到过记录删除的情况。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581696094,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":12,"child_discussions":[{"author":{"id":1335293,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKR3ibELhjgVicCNShZCBwvaDxibnzibggG4wUzVkS2mkDxUBZyIs87nDEdJ7PiahJBVoZcuhQ84RxAziag/132","nickname":"周治慧","note":"","ucode":"7D56C4E66BEE17","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1014441,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/7a/a9/62a71245.jpg","nickname":"latecomer","note":"","ucode":"8D17798AE7D0AF","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":187617,"discussion_content":"删除和增加都是幻读,在rr下是不会存在幻读的因为有间隙锁,间隙间插入不了数据","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1582756495,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":171409,"ip_address":""},"score":187617,"extra":""},{"author":{"id":1324986,"avatar":"https://wx.qlogo.cn/mmopen/vi_32/sj5FNib6wGL6lZoS9ZlhCyWehRmByToksrJicgJia05iaGEcSp9uthmJKlXuMGn1CUBicfdpj4XoMsgyJibquAGwIqIw/132","nickname":"艾瑞克","note":"","ucode":"3886599F102FE7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1335293,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKR3ibELhjgVicCNShZCBwvaDxibnzibggG4wUzVkS2mkDxUBZyIs87nDEdJ7PiahJBVoZcuhQ84RxAziag/132","nickname":"周治慧","note":"","ucode":"7D56C4E66BEE17","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":213556,"discussion_content":"rr下没有完全解决幻读吧，之前的文章里举过例子，线程A查询数据，线程B插入数据4，线程A再插入数据后报错。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585105310,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":187617,"ip_address":""},"score":213556,"extra":""},{"author":{"id":1897833,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/f5/69/84987a60.jpg","nickname":"Nevermore","note":"","ucode":"CAAD4D2F285890","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1324986,"avatar":"https://wx.qlogo.cn/mmopen/vi_32/sj5FNib6wGL6lZoS9ZlhCyWehRmByToksrJicgJia05iaGEcSp9uthmJKlXuMGn1CUBicfdpj4XoMsgyJibquAGwIqIw/132","nickname":"艾瑞克","note":"","ucode":"3886599F102FE7","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":214944,"discussion_content":"线程a查询的时候用for update即可，会对可能insert的位置加上间隙锁，防止产生新的记录。\n所以如果是快照读确实是没有解决你说的那种情况，但如果是当前读（加for update）就是完全解决了幻读","likes_number":7,"is_delete":false,"is_hidden":false,"ctime":1585251925,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":213556,"ip_address":""},"score":214944,"extra":""}]}]},{"had_liked":false,"id":49923,"user_name":"果然如此","can_delete":false,"product_type":"c1","uid":1210003,"ip_address":"","ucode":"C7543BD0A67505","user_header":"https://static001.geekbang.org/account/avatar/00/12/76/93/c78a132a.jpg","comment_is_top":true,"comment_ctime":1544789955,"is_pvip":false,"replies":[{"id":"18023","content":"1. 好问题，不会还是没解决我们说的一致性问题。如果在3、4之间插入了 Session B的逻辑呢<br><br>2. 我估计就是启动事务（执行begin),结束时提交（执行commit)吧，没有了解过所有框架，不确定哈","user_name":"作者回复","comment_id":49923,"uid":"1264162","ip_address":"","utype":1,"ctime":1544876376,"user_name_real":"林晓斌"}],"discussion_count":15,"race_medal":0,"score":"9.2233721414787994e+18","product_id":100020801,"comment_content":"一、请问计数用这个MySQL+redis方案如何：<br>1.开启事务（程序中的事务）<br>2.MySQL插入数据<br>3.原子更新redis计数<br>4.如果redis更新成功提交事务，如果redis更新失败回滚事务。<br><br>二、.net和java程序代码的事务和MySQL事务是什么关系，有什么相关性？","like_count":25,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432800,"discussion_content":"1. 好问题，不会还是没解决我们说的一致性问题。如果在3、4之间插入了 Session B的逻辑呢\n\n2. 我估计就是启动事务（执行begin),结束时提交（执行commit)吧，没有了解过所有框架，不确定哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544876376,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1644104,"avatar":"https://static001.geekbang.org/account/avatar/00/19/16/48/09493874.jpg","nickname":"茶没喝完","note":"","ucode":"D72D88C42A1258","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":307982,"discussion_content":"最关键的地方是：redis的更新和mysql的插入，不是原子的。解决这个问题，可以加分布式锁，但是这样并行数就是1了，非常影响性能","likes_number":11,"is_delete":false,"is_hidden":false,"ctime":1600820888,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1780797,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/2c/3d/0bd58aa4.jpg","nickname":"Em","note":"","ucode":"32012A5C603C8A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1986739,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/50/b3/9269cd59.jpg","nickname":"LWD","note":"","ucode":"DDA444DB113C01","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576984,"discussion_content":"所以要保证原子性不能直接让redis立即可见....","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655877230,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":557183,"ip_address":""},"score":576984,"extra":""}]},{"author":{"id":1104997,"avatar":"https://static001.geekbang.org/account/avatar/00/10/dc/65/61e5b176.jpg","nickname":"八月柒秋叶初凉","note":"","ucode":"615AF90D16A0E2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":215621,"discussion_content":"咸鱼就是这样实现的,定时的将数据全量同步到离线库中进行批处理，实时在线上对增量数据保持统计，最终合并两者的结果得到精准计数值\nhttp://www.itpub.net/2019/09/27/3252/","likes_number":11,"is_delete":false,"is_hidden":false,"ctime":1585362434,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1104997,"avatar":"https://static001.geekbang.org/account/avatar/00/10/dc/65/61e5b176.jpg","nickname":"八月柒秋叶初凉","note":"","ucode":"615AF90D16A0E2","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":371400,"discussion_content":"场景不一样吧","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1619755457,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":215621,"ip_address":""},"score":371400,"extra":""}]},{"author":{"id":2035912,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/10/c8/325f1463.jpg","nickname":"叫练","note":"","ucode":"ABAFDFE0FAFEA2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":287606,"discussion_content":"你说的原子更新只能保证共享变量的可见性，比如redis计数，但是程序并发，两个session并发，数据的一致性没办法保障，也是老师那句话，mysql和redis组成的分布式没办法达成一致性","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1593490914,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1033578,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/c5/6a/7f858f1f.jpg","nickname":"白不吃","note":"","ucode":"F019914D8819C2","race_medal":4,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":380581,"discussion_content":"框架本身不提供事物，所有框架的事物都是数据库本身的事物","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1624591181,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2562181,"avatar":"https://static001.geekbang.org/account/avatar/00/27/18/85/83ac977e.jpg","nickname":"半年 2号","note":"","ucode":"7F23C4532A5513","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":535446,"discussion_content":"session A还没提交事务，session B就读取到了计数，造成不一致问题","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1638444838,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2219318,"avatar":"https://static001.geekbang.org/account/avatar/00/21/dd/36/d51828e5.jpg","nickname":"鱼香","note":"","ucode":"CA62DE1768F551","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":545517,"discussion_content":"计数的异常场景影响了正常业务，你觉的合理吗，从设计的角度上来看，计数和业务逻辑应该完全解耦才对","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641980565,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1502074,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKb5BzdGZbSYHxq88kicdDtBh0yBtJpDAD81wruIsTsLdBysDZztrm8tYb4mBYvAI1ZE4lorKuvmgw/132","nickname":"java_lunsong","note":"","ucode":"180EEE6C8BCAA8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":312294,"discussion_content":"就是redis更新成功了，提交事务期间，有其他session操作，是没办法控制redis的可见性的，也就回到了先写redis，再写mysql的那种情况","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1602655652,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1371646,"avatar":"https://static001.geekbang.org/account/avatar/00/14/ed/fe/83da25ef.jpg","nickname":"幸福由自己决定","note":"","ucode":"03103F36AE0E3E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":311043,"discussion_content":"果然如此","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1602201197,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1622448,"avatar":"https://static001.geekbang.org/account/avatar/00/18/c1/b0/b52d9ade.jpg","nickname":"苏彧","note":"","ucode":"C016B28DF7449C","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":301331,"discussion_content":"MySQL事务和redis不冲突","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598491270,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1793962,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/5f/aa/63e641c1.jpg","nickname":"H","note":"","ucode":"04D7D030245E27","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":289896,"discussion_content":"没太懂。事务不是可以保证其他事务不可见吗，方便解析一下吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594261203,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1793962,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/5f/aa/63e641c1.jpg","nickname":"H","note":"","ucode":"04D7D030245E27","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":371396,"discussion_content":"她说的事务是程序的事务，跟mysql中的事务不同，","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619754244,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":289896,"ip_address":""},"score":371396,"extra":""},{"author":{"id":1033578,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/c5/6a/7f858f1f.jpg","nickname":"白不吃","note":"","ucode":"F019914D8819C2","race_medal":4,"user_type":1,"is_pvip":true},"reply_author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":380583,"discussion_content":"程序本身是没有事务的，就像spring事务其实就是利用aop回滚数据库的事务","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1624591264,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":371396,"ip_address":""},"score":380583,"extra":""}]}]},{"had_liked":false,"id":50072,"user_name":"发条橙子 。","can_delete":false,"product_type":"c1","uid":1259218,"ip_address":"","ucode":"ED076F4534FFED","user_header":"https://static001.geekbang.org/account/avatar/00/13/36/d2/c7357723.jpg","comment_is_top":true,"comment_ctime":1544859139,"is_pvip":false,"replies":[{"id":"18010","content":"1. 如果有索引用到这个字段的话，比较大可能会用到这个索引，比主键索引小<br><br>2. 索引字段就算是NULL，上面的id也不是的<br><br>3.  进了Buffer pool 的原因吧<br><br>4. 嗯，rc用得挺多的，但是原因可能只是因为“以前是这么用的”。 使用rc可能有问题，也可能没问题。但是我觉得DBA不知道为什么这么选，这个是问题。<br><br>rc本身的问题其实前面我们说过一些，比如不是一致性读。后面也会有文章说到。","user_name":"作者回复","comment_id":50072,"uid":"1264162","ip_address":"","utype":1,"ctime":1544869223,"user_name_real":"林晓斌"}],"discussion_count":14,"race_medal":0,"score":"9.2233721157089997e+18","product_id":100020801,"comment_content":"老师 ，我这边有几个问题  ：<br><br>1. 看到老师回复评论说 count(id) 也是走普通索引 ，那是不是也算是优化了 ， 我以为 count(字段) 是走的聚集索引 。老师的意思是 count(字段) 是走二级索引，但是不一定是数据最少的索引树的意思是么 <br><br>2. count(*) 的话， innodb 还会有取数判空这样的判断逻辑么 ，还是直接取行数 +1 了 ， 还是按所取索引类型分情况。 允许为 null 的索引是不是行数比较少， 取的总数会不会有问题呢<br><br>3.  我这边试了一下 ， 库里总共 30w 数据 。 第一次用 count(*) 是 120多ms , 第二次就是 60多 ms 。 第三次用了 count(1) ，也是60多ms 。 请问 count(*) 这两次的前后时间差是什么原因，也会走缓存 ？<br><br>4. 另一个问题是一个题外话 ，我看老师的例子事务级别应该都是 rr 。 我偶然看到我们公司事务隔离级别是  rc 。 我比较惊讶，就去问 DBA 为什么是 rc 而不是默认的 rr 。 她说一般都是用的 rc  ，我想问现在公司一般都是 rc 么， 请问老师现在用的隔离级别是什么 ？？ 在我的印象里 ，rr 保证事务的隔离性会更好一些吧 。 我google 了一下， rc 会不会在某些场景下出现一些问题，但是没有查出来相关结果。老师能不能讲解一下，rc 的话会在哪些场景下会踩坑么 。 （我之前码代码都是按照 rr 级别下的思维码的代码）","like_count":19,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432864,"discussion_content":"1. 如果有索引用到这个字段的话，比较大可能会用到这个索引，比主键索引小\n\n2. 索引字段就算是NULL，上面的id也不是的\n\n3.  进了Buffer pool 的原因吧\n\n4. 嗯，rc用得挺多的，但是原因可能只是因为“以前是这么用的”。 使用rc可能有问题，也可能没问题。但是我觉得DBA不知道为什么这么选，这个是问题。\n\nrc本身的问题其实前面我们说过一些，比如不是一致性读。后面也会有文章说到。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544869223,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1110677,"avatar":"https://static001.geekbang.org/account/avatar/00/10/f2/95/538d0348.jpg","nickname":"wrp000000","note":"","ucode":"4860119F2276FE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":342468,"discussion_content":"DBA不知道为什么这么选，这个是问题  这句话说得好","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1610690190,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1071601,"avatar":"https://static001.geekbang.org/account/avatar/00/10/59/f1/8909b9e0.jpg","nickname":"叉歪叉","note":"","ucode":"2C1AFC6335FF0E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":309300,"discussion_content":"DBA是她？","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1601255492,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2033067,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/pbXZL4jicmXCSF7jIDTibuQqGic84SKCMotQjWSh70B7iaicTOI1RTac8ZxrxEqiapIIbJpXyJk7KHbusr6KqoPQY1pg/132","nickname":"杰夫·王盖茨","note":"","ucode":"FF4C49D98885AB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1071601,"avatar":"https://static001.geekbang.org/account/avatar/00/10/59/f1/8909b9e0.jpg","nickname":"叉歪叉","note":"","ucode":"2C1AFC6335FF0E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":332928,"discussion_content":"你这是个好问题","likes_number":5,"is_delete":false,"is_hidden":false,"ctime":1607396821,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":309300,"ip_address":""},"score":332928,"extra":""}]},{"author":{"id":2753834,"avatar":"https://static001.geekbang.org/account/avatar/00/2a/05/2a/cfbcb0b2.jpg","nickname":"Donkey","note":"","ucode":"3DB4DFF6D99035","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":558302,"discussion_content":"InnoDB handles SELECT COUNT(*) and SELECT COUNT(1) operations in the same way. There is no performance difference.","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1648199448,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2781015,"avatar":"","nickname":"Geek_082afe","note":"","ucode":"4D867B42DFC550","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":402622,"discussion_content":"oracle,sqlserver,postgresql的默认隔离级别是RC。RC级别，一个事务中的两个相同的读取操作，其结果可能不同。也就是，会读取到其他事务commit的数据。mysql的默认隔离级别是RR，这样会样mysql比其他数据库更高级吗？不会的。RR级别的并发能力比RC要弱一个等级。RC够用才是其他数据库选择为默认隔离级别的原因。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1633923080,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2015438,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/c0/ce/eb1b4ae1.jpg","nickname":"可圈可丶","note":"","ucode":"EB527E176EDE91","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2781015,"avatar":"","nickname":"Geek_082afe","note":"","ucode":"4D867B42DFC550","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":581367,"discussion_content":"实践证明，阿里云RDS mysql版的隔离级别也是RC","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1658743868,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":402622,"ip_address":""},"score":581367,"extra":""}]},{"author":{"id":1115724,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLwSoTjHPX5tm4whBSfoZLX6toZxrZGUaLABQywKNf4MDc9toK3QSV7Z99ATcGicFCysoleQ5ISzmw/132","nickname":"乘风","note":"","ucode":"0420C5535DACB7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":47072,"discussion_content":"oracle 默认就是rc","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1573268313,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1935838,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/n1gS0knXOF4D8Oo5ocQicCCtwNibmNz4ODrmVg8icobVgap9to11t7ahFm4U81K4MDcavibMNxib39mzm5ibAJR4DdzA/132","nickname":"Ly","note":"","ucode":"0A7A27C8126ACF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":388368,"discussion_content":"count(*)的结果会进buffer pool吗，buffer pool中的链表不是缓存的数据页吗，count(*)的结果也没在数据页里呀？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628734563,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1780797,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/2c/3d/0bd58aa4.jpg","nickname":"Em","note":"","ucode":"32012A5C603C8A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1935838,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/n1gS0knXOF4D8Oo5ocQicCCtwNibmNz4ODrmVg8icobVgap9to11t7ahFm4U81K4MDcavibMNxib39mzm5ibAJR4DdzA/132","nickname":"Ly","note":"","ucode":"0A7A27C8126ACF","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576986,"discussion_content":"count(*)总得先索引B+树吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655877488,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":388368,"ip_address":""},"score":576986,"extra":""}]},{"author":{"id":2142240,"avatar":"https://static001.geekbang.org/account/avatar/00/20/b0/20/6d0f4587.jpg","nickname":"美好的未来","note":"","ucode":"2E2432913874D4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":387884,"discussion_content":"我说下我遇到的一个问题吧，A服务开启事务，在事务中调用B服务的rpc插入了数据，更新完成后A直接查库（还在事务中），如果是RR，就会查不到数据。因为B服务插入数据的事务比A服务的事务新，MVCC让A服务查不到最新的数据。\n这种问题一般是在系统拆分微服务的时候会出现，正常情况是没有的，因为如果是B服务提供插入数据的能力，那必然也需要提供查询数据的能力。\n其实我个人感觉啊，当微服务拆分之后，原来的一个事务其实分散在各处，也只能是每次读最新的数据了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628486396,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1461374,"avatar":"https://static001.geekbang.org/account/avatar/00/16/4c/7e/4771d8a4.jpg","nickname":"彭发红","note":"","ucode":"9BAC208700791E","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":305348,"discussion_content":"饿","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599885980,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1115724,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLwSoTjHPX5tm4whBSfoZLX6toZxrZGUaLABQywKNf4MDc9toK3QSV7Z99ATcGicFCysoleQ5ISzmw/132","nickname":"乘风","note":"","ucode":"0420C5535DACB7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":47073,"discussion_content":"正如楼上所说rc没有nkl,但是会存在不可重复读,对于强一致性的业务会存在问题,但大部分业务没这个影响","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573268399,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1142674,"avatar":"https://static001.geekbang.org/account/avatar/00/11/6f/92/535160b0.jpg","nickname":"商瞿逆","note":"","ucode":"FA9522CEDA5635","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":15703,"discussion_content":"rr要加gap lock，如果你们公司大部分业务rc就够了的话，没必要用rr，rc有更好的性能","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1568825277,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":50068,"user_name":"李二木","can_delete":false,"product_type":"c1","uid":1103091,"ip_address":"","ucode":"30E03BB84ADB27","user_header":"https://static001.geekbang.org/account/avatar/00/10/d4/f3/129d6dfe.jpg","comment_is_top":false,"comment_ctime":1544858788,"is_pvip":true,"replies":[{"id":"18011","content":"😄 来得及来得及","user_name":"作者回复","comment_id":50068,"uid":"1264162","ip_address":"","utype":1,"ctime":1544869317,"user_name_real":"林晓斌"}],"discussion_count":16,"race_medal":0,"score":"456811392164","product_id":100020801,"comment_content":"一直以为带*查询效率是最差的，平时查询特意加了 count(ID) 查询。罪过啊。","like_count":107,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432863,"discussion_content":"😄 来得及来得及","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544869317,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1454272,"avatar":"https://static001.geekbang.org/account/avatar/00/16/30/c0/761ec683.jpg","nickname":"faker","note":"","ucode":"15212F3641253F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":276100,"discussion_content":"框架的orm使用一般是count(*)？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1590817137,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1812970,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/a9/ea/5bfce6c5.jpg","nickname":"mgs2002","note":"","ucode":"F5931108BD509B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":218256,"discussion_content":"一直用的count(*)","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1585638643,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1618289,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b1/71/d5df5dc1.jpg","nickname":"张缘","note":"","ucode":"8A05C57E46ED87","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":202591,"discussion_content":"我一直用count（1），觉得count（*）是最差的。被我的入门师傅带偏了","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1583935307,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":2369545,"avatar":"https://static001.geekbang.org/account/avatar/00/24/28/09/0ac42cff.jpg","nickname":"慕苏","note":"","ucode":"7ED14D00429C21","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1618289,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b1/71/d5df5dc1.jpg","nickname":"张缘","note":"","ucode":"8A05C57E46ED87","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":336268,"discussion_content":"之前学校老师也这样教说：count(*)最差 ...","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608542919,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":202591,"ip_address":""},"score":336268,"extra":""},{"author":{"id":1649057,"avatar":"https://static001.geekbang.org/account/avatar/00/19/29/a1/41607383.jpg","nickname":"hello","note":"","ucode":"4F42DAA5DB5C38","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1618289,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b1/71/d5df5dc1.jpg","nickname":"张缘","note":"","ucode":"8A05C57E46ED87","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":341636,"discussion_content":"不知道那是哪个版本的数据库了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1610467957,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":202591,"ip_address":""},"score":341636,"extra":""}]},{"author":{"id":1986739,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/50/b3/9269cd59.jpg","nickname":"LWD","note":"","ucode":"DDA444DB113C01","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":587452,"discussion_content":"count(1) 和 count(*)效率一样；但是count(*)是通用语法，是规范","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1663062805,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1618289,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b1/71/d5df5dc1.jpg","nickname":"张缘","note":"","ucode":"8A05C57E46ED87","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":368086,"discussion_content":"我以前以为count（1）效率最高。。。。。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618563562,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1575571,"avatar":"https://static001.geekbang.org/account/avatar/00/18/0a/93/a189ec16.jpg","nickname":"Eric","note":"","ucode":"7EB511C384BD7B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1618289,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b1/71/d5df5dc1.jpg","nickname":"张缘","note":"","ucode":"8A05C57E46ED87","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":393862,"discussion_content":"本来不就是么。。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1631620487,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":368086,"ip_address":""},"score":393862,"extra":""}]},{"author":{"id":1047537,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/fb/f1/a2cde35e.jpg","nickname":"废材姑娘","note":"","ucode":"6AFB48B2A4939A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":323695,"discussion_content":"我咋记得在哪看过不让用*，蒙圈了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604983012,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":3,"child_discussions":[{"author":{"id":2280126,"avatar":"https://static001.geekbang.org/account/avatar/00/22/ca/be/3771706c.jpg","nickname":"卖火柴的加菲猫","note":"","ucode":"9146C9E232A156","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1047537,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/fb/f1/a2cde35e.jpg","nickname":"废材姑娘","note":"","ucode":"6AFB48B2A4939A","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":328304,"discussion_content":"你那是查询的时候不让用*，只查自己需要的字段","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1606122143,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":323695,"ip_address":""},"score":328304,"extra":""},{"author":{"id":2232546,"avatar":"https://static001.geekbang.org/account/avatar/00/22/10/e2/35f2fc23.jpg","nickname":"吉法师","note":"","ucode":"F1E3F4F526CA13","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1047537,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/fb/f1/a2cde35e.jpg","nickname":"废材姑娘","note":"","ucode":"6AFB48B2A4939A","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":345931,"discussion_content":"查询最好不用*，一方面MySQL得遍历表去查有哪些字段，另一方面别人读你的代码不知道你在查哪些字段，用哪些字段","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1611817278,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":323695,"ip_address":""},"score":345931,"extra":""},{"author":{"id":2438545,"avatar":"https://static001.geekbang.org/account/avatar/00/25/35/91/d523a803.jpg","nickname":"PRETEXT","note":"","ucode":"BBA18231EE4EDA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2232546,"avatar":"https://static001.geekbang.org/account/avatar/00/22/10/e2/35f2fc23.jpg","nickname":"吉法师","note":"","ucode":"F1E3F4F526CA13","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":571247,"discussion_content":"不需要吧，你这样说就感觉count (*)效率极其低了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1652155639,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":345931,"ip_address":""},"score":571247,"extra":""}]},{"author":{"id":2076283,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/ae/7b/47200692.jpg","nickname":"贺子","note":"","ucode":"A64DC9D9CF7CCD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":308863,"discussion_content":"如果表没有主键，那应该是count（1）比count((*)好","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1601102080,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":2083033,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/c8/d9/51288e15.jpg","nickname":"安畅","note":"","ucode":"03855E154A1AD3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2076283,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/ae/7b/47200692.jpg","nickname":"贺子","note":"","ucode":"A64DC9D9CF7CCD","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":316076,"discussion_content":"count（1）怎么理解呀？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603355477,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":308863,"ip_address":""},"score":316076,"extra":""},{"author":{"id":1892268,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q3auHgzwzM6fGV3BcHQHyNibzRhsPr6KqYzOtMF8G9fiaNvYUavdlhdqMugcHWggWGBbIibkYTibIXramEXsvg4aXA/132","nickname":"肖海涛","note":"","ucode":"5E4C20D5A69BEC","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":2076283,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/ae/7b/47200692.jpg","nickname":"贺子","note":"","ucode":"A64DC9D9CF7CCD","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":588975,"discussion_content":"如果没有指定主键，引擎也会给你创建一个内置的主键，换句话说，所有的表都有主键","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1664276027,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":308863,"ip_address":"北京"},"score":588975,"extra":""}]}]},{"had_liked":false,"id":65057,"user_name":"菜鸡一只","can_delete":false,"product_type":"c1","uid":1336004,"ip_address":"","ucode":"5FBA9A68E0E9B9","user_header":"https://static001.geekbang.org/account/avatar/00/14/62/c4/98a9e594.jpg","comment_is_top":false,"comment_ctime":1549014360,"is_pvip":false,"replies":[{"id":"23063","content":"count(id)可能会选择最小的索引来遍历<br>而count(字段)的话，如果字段上没有索引，就只能选主键索引","user_name":"作者回复","comment_id":65057,"uid":"1264162","ip_address":"","utype":1,"ctime":1549038395,"user_name_real":"林晓斌"}],"discussion_count":9,"race_medal":0,"score":"345146398040","product_id":100020801,"comment_content":"count（id）和count（这段）都是要把每一行的该字段值取出来，然后判断是否为空，那为什么count（id）的效率要高？","like_count":81,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438301,"discussion_content":"count(id)可能会选择最小的索引来遍历\n而count(字段)的话，如果字段上没有索引，就只能选主键索引","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1549038395,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1254801,"avatar":"https://static001.geekbang.org/account/avatar/00/13/25/91/46600294.jpg","nickname":"猴哥一一 cium","note":"","ucode":"38EC64F8D1A0B4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":312636,"discussion_content":"count(id)也可能会选择最小的索引来遍历的嘛,\n那跟count(*)一样了?","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1602754275,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2278559,"avatar":"https://static001.geekbang.org/account/avatar/00/22/c4/9f/a01e4bd1.jpg","nickname":"海浪","note":"","ucode":"091941B3556B4B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1254801,"avatar":"https://static001.geekbang.org/account/avatar/00/13/25/91/46600294.jpg","nickname":"猴哥一一 cium","note":"","ucode":"38EC64F8D1A0B4","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":326346,"discussion_content":"但是count(*)不用把字段取出来","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1605582073,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":312636,"ip_address":""},"score":326346,"extra":""}]},{"author":{"id":1644104,"avatar":"https://static001.geekbang.org/account/avatar/00/19/16/48/09493874.jpg","nickname":"茶没喝完","note":"","ucode":"D72D88C42A1258","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":307983,"discussion_content":"好问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600821197,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1066508,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/0c/773ba2f3.jpg","nickname":"下个目标45k","note":"","ucode":"193BA8C3AA9A61","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1644104,"avatar":"https://static001.geekbang.org/account/avatar/00/19/16/48/09493874.jpg","nickname":"茶没喝完","note":"","ucode":"D72D88C42A1258","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":334607,"discussion_content":"这是不是意味着一定count (id)一定会走普通索引呢？只要列数大于3主键索引数据肯定比普通索引大","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1607916174,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":307983,"ip_address":""},"score":334607,"extra":""},{"author":{"id":2350043,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/sFkJYPdIIjHfxgCxAh1D4Pyk1jAueicu7egY1PUvR8egs12gAXxmO51YT6Bk7NianYRyMRPTpd3kKWXvZ8TEkRyw/132","nickname":"Geek_7794e2","note":"","ucode":"2F749554FEA20D","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1066508,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/0c/773ba2f3.jpg","nickname":"下个目标45k","note":"","ucode":"193BA8C3AA9A61","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":411002,"discussion_content":"看占用的字节数啊","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635823782,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":334607,"ip_address":""},"score":411002,"extra":""}]},{"author":{"id":1307497,"avatar":"https://static001.geekbang.org/account/avatar/00/13/f3/69/7039d03f.jpg","nickname":"书策稠浊","note":"","ucode":"A29875CE15FDA3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":6025,"discussion_content":"最小的索引和主键索引查出来的数据会不会不同呢。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566619292,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1453053,"avatar":"https://static001.geekbang.org/account/avatar/00/16/2b/fd/7013289d.jpg","nickname":"温故而知新可以为师矣","note":"","ucode":"FADCDFA9F9E5E8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1307497,"avatar":"https://static001.geekbang.org/account/avatar/00/13/f3/69/7039d03f.jpg","nickname":"书策稠浊","note":"","ucode":"A29875CE15FDA3","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":120949,"discussion_content":"最终都是那些数据，不同的组织方式而已，所以不会，只是速度快些","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1578306611,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":6025,"ip_address":""},"score":120949,"extra":""},{"author":{"id":1780797,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/2c/3d/0bd58aa4.jpg","nickname":"Em","note":"","ucode":"32012A5C603C8A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1453053,"avatar":"https://static001.geekbang.org/account/avatar/00/16/2b/fd/7013289d.jpg","nickname":"温故而知新可以为师矣","note":"","ucode":"FADCDFA9F9E5E8","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576994,"discussion_content":"索引可能为null吧   会不会少数据","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655877921,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":120949,"ip_address":""},"score":576994,"extra":""}]}]},{"had_liked":false,"id":49589,"user_name":"北天魔狼","can_delete":false,"product_type":"c1","uid":1188144,"ip_address":"","ucode":"C22623ECEB8DBA","user_header":"https://static001.geekbang.org/account/avatar/00/12/21/30/8ecce1e1.jpg","comment_is_top":false,"comment_ctime":1544741456,"is_pvip":true,"discussion_count":3,"race_medal":0,"score":"203408204368","product_id":100020801,"comment_content":"老师说过：事务开启后，更新操作放到最后。较少锁等待时间的影响","like_count":48,"discussions":[{"author":{"id":1453053,"avatar":"https://static001.geekbang.org/account/avatar/00/16/2b/fd/7013289d.jpg","nickname":"温故而知新可以为师矣","note":"","ucode":"FADCDFA9F9E5E8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":120936,"discussion_content":"应该是“可能产生行锁等待的更新语句”放到最后在更准确。","likes_number":12,"is_delete":false,"is_hidden":false,"ctime":1578305790,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2369545,"avatar":"https://static001.geekbang.org/account/avatar/00/24/28/09/0ac42cff.jpg","nickname":"慕苏","note":"","ucode":"7ED14D00429C21","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":336270,"discussion_content":"应该是 “容易产生行锁导致阻塞的语句” 放在最后","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608543012,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2287841,"avatar":"https://static001.geekbang.org/account/avatar/00/22/e8/e1/6045b299.jpg","nickname":"LPF","note":"","ucode":"036C552D7251E9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":328089,"discussion_content":"应该是“易产生冲突的语句”放在最后","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606052753,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":109027,"user_name":"钱","can_delete":false,"product_type":"c1","uid":1009652,"ip_address":"","ucode":"2C92A243A463D4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg","comment_is_top":false,"comment_ctime":1561950691,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"139000904163","product_id":100020801,"comment_content":"1：又刷新了认知，先给结论(之前不知从哪看的，以为count(主键id)性能最佳)<br>按照效率排序的话，count(字段)&lt;count(主键 id)&lt;count(1)≈count(*)，所以老师建议，尽量使用 count(*)。<br>2：count(*)这么慢，我该怎么办？<br>要么忍，要么自己动手记录，如果自己记录的话，老师建议使用数据库来弄，感觉使用数据库自己弄的思路可以建议MySQL实现一下？<br>3：count()的语义是啥？<br>首先，不同的存储引擎实现方式不同<br>MyISAM 引擎把一个表的总行数存在了磁盘上，因此执行 count(*) 的时候会直接返回这个数，效率很高；<br>而 InnoDB 引擎就麻烦了，它执行 count(*) 的时候，需要把数据一行一行地从引擎里面读出来，然后累积计数。<br>以下针对innodb来说<br>count() 是一个聚合函数，对于返回的结果集，一行行地判断，如果 count 函数的参数不是 NULL，累计值就加 1，否则不加，最后返回累计值。<br>4：count(字段)怎么计数？<br>4-1：如果这个“字段”是定义为 not null 的话，一行行地从记录里面读出这个字段，判断不能为 null，按行累加；<br>4-2：如果这个“字段”定义允许为 null，那么执行的时候，判断到有可能是 null，还要把值取出来再判断一下，不是 null 才累加。<br>从引擎返回的字段会涉及到解析数据行，以及拷贝字段值的操作。<br>5：count(主键 id)怎么计数？<br>对于 count(主键 id) 来说，InnoDB 引擎会遍历整张表，把每一行的 id 值都取出来，返回给 server 层。server 层拿到 id 后，判断是不可能为空的，就按行累加。从引擎返回的 主键id 会涉及到解析数据行，以及拷贝字段值的操作。<br>6：count(1)怎么计数？<br>对于 count(1) 来说，InnoDB 引擎遍历整张表，但不取值。server 层对于返回的每一行，放一个数字“1”进去，判断是不可能为空的，按行累加。<br>7：count(*)怎么计数？<br>对于count(*)来说，并不会把全部字段取出来，而是专门做了优化，不取值。count(*) 肯定不是 null，按行累加。<br>8：现在终于弄明白这些count()背后的计算原理啦！非常感谢！另外，分析这些count()的原则如下：<br>8-1：server 层要什么就给什么；<br>8-2：InnoDB 只给必要的值；<br>8-3：现在的优化器只优化了 count(*) 的语义为“取行数”，其他“显而易见”的优化并没有做。<br>这几条原则对别的性能差别的分析也是OK的吧？<br>达到同样的目标，谁绕的弯越多做的事情越多就会越慢，性能自然不咋滴！不过知道每种达到目的的路径轨迹是一个难点，如果知道谁不喜欢走捷径呢？","like_count":32,"discussions":[{"author":{"id":2054611,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEKBENQekdV3e9XwRQ5kpO9Y9d81sEMm52qcwJWbFbWbW2rniaTFYCChoR0ibZ0E3soQqod9rvfmBibmQ/132","nickname":"校歌","note":"","ucode":"CD257668BB1A33","race_medal":1,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":339684,"discussion_content":"count(*)做了优化?能说下做了什么优化吗？跟count(1)有什么区别？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609757549,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2290089,"avatar":"","nickname":"二姐","note":"","ucode":"3451748DE3895F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2054611,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEKBENQekdV3e9XwRQ5kpO9Y9d81sEMm52qcwJWbFbWbW2rniaTFYCChoR0ibZ0E3soQqod9rvfmBibmQ/132","nickname":"校歌","note":"","ucode":"CD257668BB1A33","race_medal":1,"user_type":1,"is_pvip":true},"discussion":{"id":362065,"discussion_content":"老版本的count(*)会把整行数据取出来返回给server层，这个数据传输和解析需要时间，有性能开销。优化后的count(*)不需要取出数据，而且只要能取出行就肯定不为null，所以就根本不用判断是否为null，每行直接累加就好了。这个就是优化点。","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1616837980,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":339684,"ip_address":""},"score":362065,"extra":""}]}]},{"had_liked":false,"id":49799,"user_name":"某、人","can_delete":false,"product_type":"c1","uid":1308784,"ip_address":"","ucode":"ADB42AA12A11C1","user_header":"https://static001.geekbang.org/account/avatar/00/13/f8/70/f3a33a14.jpg","comment_is_top":false,"comment_ctime":1544771457,"is_pvip":false,"replies":[{"id":"17937","content":"1. 对，这个是个bug, 从库上会全表扫描。MariaDB 的版本有解决这个问题。生产上我们最好不允许没有主键的表<br><br>2. 按照你问的,gap锁没问题了。delete 被锁是因为行锁吧。从库重放就是因为走全表扫描按行锁下来触发的<br><br>3. 出现这个问题肯定是binlog设置了row格式。<br>这样binlog里面有所有值。如果你有主键的话，就是主键查，没有的话…就是全表了","user_name":"作者回复","comment_id":49799,"uid":"1264162","ip_address":"","utype":1,"ctime":1544772490,"user_name_real":"林晓斌"}],"discussion_count":6,"race_medal":0,"score":"100329019265","product_id":100020801,"comment_content":"老师我先问个本章之外的问题:<br>1.rr模式下,一张表上没有主键和唯一键,有二级索引c.如果是一张大表,删除一条数据delete t where c=1.<br>在主库上利用二级索引,在根据虚拟的主键列回表删除还挺快.但是在备库上回放特别慢,而且状态是system lock,是因为binlog event里没有包含虚拟主键列.导致在备库回放的时候,必须全表扫描,耗时特别久?还是其他原因<br><br>2.回放过程中,在备库delete一条语句是被阻塞的,insert又是可以的,说明只在记录上的X锁没有gap锁。<br>但是如果在主库session A begin,delete where c=1.在开启一个session B,在主库上操作也是delete阻塞,insert正常.不过等session A执行完成,不提交.insert都阻塞了,说明最后上了gap锁。有点没明白这儿的上锁逻辑是什么？<br><br>3.还有就是备库回放binlog,相对于主库的一条update语句流程来说,从库回放哪些流程是省略了的啊,<br>server层的应该都省略了,应该主要是引擎层的回放,这里有点模糊从库是怎么回放的binlog event?<br>因为第一个问题从库回放的时候,从库上的二级索引貌似没起作用,直接就在聚簇索引上做的更新。<br><br>感谢老师","like_count":23,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432778,"discussion_content":"1. 对，这个是个bug, 从库上会全表扫描。MariaDB 的版本有解决这个问题。生产上我们最好不允许没有主键的表\n\n2. 按照你问的,gap锁没问题了。delete 被锁是因为行锁吧。从库重放就是因为走全表扫描按行锁下来触发的\n\n3. 出现这个问题肯定是binlog设置了row格式。\n这样binlog里面有所有值。如果你有主键的话，就是主键查，没有的话…就是全表了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544772490,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1285652,"avatar":"","nickname":"mycat","note":"","ucode":"6878BD32D042F2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":305114,"discussion_content":"我们有一个主从环境，某天发现从比住慢了3个小时，经排查，主库有一个人表没有主键，且这个表发生了大量的delete操作，但是从上看状态是双yes，只是延迟很严重。后和业务人员沟通后，增加了一个字增主键在这个发生delete 的表上，主从延迟解决了。这个应该和你说的第一点一样。","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1599787569,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1692320,"avatar":"https://static001.geekbang.org/account/avatar/00/19/d2/a0/c8714628.jpg","nickname":"独一无二","note":"","ucode":"A7DE0EA2BD8FE3","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":53002,"discussion_content":"老师还是没有说row模式下从库是如何回放的。😂😂😂","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1574122969,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2677691,"avatar":"https://static001.geekbang.org/account/avatar/00/28/db/bb/ef74f6ba.jpg","nickname":"katahili","note":"","ucode":"7D164E1DC9C9E1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":381965,"discussion_content":"请问主从复制在哪能学啊？我一头雾水","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625320434,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1147895,"avatar":"https://static001.geekbang.org/account/avatar/00/11/83/f7/a24b7242.jpg","nickname":"简单","note":"","ucode":"19A01CB4B9ED8C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":370315,"discussion_content":"没有主键的表索引是不是没有生效。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619360838,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1014665,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/7b/89/34f2cbcc.jpg","nickname":"杨宇","note":"","ucode":"EB74DF6E269F03","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":319032,"discussion_content":"对于无主键的表，其默认主键rowid不能起到主键索引的作用吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603930498,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":50278,"user_name":"WL","can_delete":false,"product_type":"c1","uid":1173771,"ip_address":"","ucode":"6277DCD776B87E","user_header":"https://static001.geekbang.org/account/avatar/00/11/e9/0b/1171ac71.jpg","comment_is_top":false,"comment_ctime":1544942393,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"91739255609","product_id":100020801,"comment_content":"把该讲内容总结为几个问题, 大家复习的时候可以先尝试回答这些问题检查自己的掌握程度:<br>\t1. <br>count(*)的实现方式在MySAM引擎和InnoDB引擎的实现方式各是怎么样的? 为什么会有这种不同?<br>\t2. <br>使用缓存保存count总数存在什么问题?<br>\t3. <br>如果使用一场单独的表来记录其他各张表的记录数的话,是怎么解决统计结果不精确的问题的?<br>\t4. <br>count(字段),count(id),count(1), count(*)各自是怎么样的执行机制, 效率排序是怎么样的?<br><br>","like_count":22,"discussions":[{"author":{"id":2668694,"avatar":"https://static001.geekbang.org/account/avatar/00/28/b8/96/716ba431.jpg","nickname":"苏成","note":"","ucode":"80A8E7B243DD73","race_medal":1,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":574340,"discussion_content":"WL老哥yyds","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1653984478,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2846808,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/70/58/69e4ae1c.jpg","nickname":"Jav","note":"","ucode":"2562623ADD4BC1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":559011,"discussion_content":"问题提的太好了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1648559316,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49754,"user_name":"斜面镜子 Bill","can_delete":false,"product_type":"c1","uid":1305242,"ip_address":"","ucode":"B5505F94540D52","user_header":"https://static001.geekbang.org/account/avatar/00/13/ea/9a/02d589f9.jpg","comment_is_top":false,"comment_ctime":1544764083,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"91739077299","product_id":100020801,"comment_content":"先插入操作纪录，再更新计数表，因为计数表相当于热点行，加锁时间需要考虑足够短！","like_count":22},{"had_liked":false,"id":62638,"user_name":"小动物很困","can_delete":false,"product_type":"c1","uid":1133936,"ip_address":"","ucode":"49A727277A37E1","user_header":"https://static001.geekbang.org/account/avatar/00/11/4d/70/7d736d5f.jpg","comment_is_top":false,"comment_ctime":1548123416,"is_pvip":false,"replies":[{"id":"22172","content":"是的，咱们专栏07篇也有类似的介绍😆","user_name":"作者回复","comment_id":62638,"uid":"1264162","ip_address":"","utype":1,"ctime":1548128654,"user_name_real":"林晓斌"}],"discussion_count":3,"race_medal":0,"score":"87447469336","product_id":100020801,"comment_content":"我记得有一个并发插入的方法,就是说计数表对同一个表开很多行,然后计数增加对这些数据随机做加法,当做count操作的时候取sum,这样对行锁竞争会削弱.","like_count":20,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437284,"discussion_content":"是的，咱们专栏07篇也有类似的介绍😆","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548128654,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1780797,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/2c/3d/0bd58aa4.jpg","nickname":"Em","note":"","ucode":"32012A5C603C8A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576996,"discussion_content":"减少行竞争, 统计总金额      只增不减的情况很适合","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1655878374,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":3004698,"avatar":"https://static001.geekbang.org/account/avatar/00/2d/d9/1a/f5bb1a23.jpg","nickname":"LL","note":"","ucode":"1E498475B2D9EC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":575916,"discussion_content":"mark","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655187327,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49872,"user_name":"csoulsi","can_delete":false,"product_type":"c1","uid":1227336,"ip_address":"","ucode":"96C9BBE9097FB3","user_header":"https://static001.geekbang.org/account/avatar/00/12/ba/48/c892a35b.jpg","comment_is_top":false,"comment_ctime":1544782790,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"74559226822","product_id":100020801,"comment_content":"老师：<br>1.count(*) 不取值，<br>         InnoDB还做遍历表的操作吗，也不用给server层返回值吗？<br>2.count(1) 不取值，<br>        但是要遍历表。原文中：<br>        “server 层对于返回的每一行，放一个数字“1”进去”<br>        这个“返回的每一行” ：到底返回的啥？是每一行记录吗？还是形式的返回空行，然后用1填充？<br><br>3. count(1),count(*),count(主键id)<br>       这三个做比较，哪个会快？时间消耗在哪个环节？<br>      是否遍历表；是否取值；返回给server层内容    细节上从哪个角度考虑？<br>         ","like_count":17,"discussions":[{"author":{"id":2843604,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/63/d4/b63373c3.jpg","nickname":"金金","note":"","ucode":"807EDDCDB2E939","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":560302,"discussion_content":"1.innodb肯定还是要遍历表的，否则怎么知道有多少行，这里应该返回的也是空行\n2.空行\n3.三者都会遍历表,count(1)、count(*)不取值，count(主键id)要取值","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1649255031,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":54238,"user_name":"不忘初心","can_delete":false,"product_type":"c1","uid":1302204,"ip_address":"","ucode":"5BC8A5DD41012F","user_header":"https://static001.geekbang.org/account/avatar/00/13/de/bc/1245cd12.jpg","comment_is_top":false,"comment_ctime":1545813893,"is_pvip":false,"replies":[{"id":"19611","content":"嗯，代码就是这么写的 我也觉得可以优化一下… 不过现在就这样😓","user_name":"作者回复","comment_id":54238,"uid":"1264162","ip_address":"","utype":1,"ctime":1545815105,"user_name_real":"林晓斌"}],"discussion_count":1,"race_medal":0,"score":"61675356037","product_id":100020801,"comment_content":"对于 count(主键 id) ，server层拿到ID，判断ID是不可能为空的按行累加。这个地方，是不是又点问题，既然是主键ID，是一定不会为空的，这个server层还需要判断不为空吗","like_count":14,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434402,"discussion_content":"嗯，代码就是这么写的 我也觉得可以优化一下… 不过现在就这样😓","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545815105,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":50275,"user_name":"某、人","can_delete":false,"product_type":"c1","uid":1308784,"ip_address":"","ucode":"ADB42AA12A11C1","user_header":"https://static001.geekbang.org/account/avatar/00/13/f8/70/f3a33a14.jpg","comment_is_top":false,"comment_ctime":1544941922,"is_pvip":false,"discussion_count":5,"race_medal":0,"score":"35904680290","product_id":100020801,"comment_content":"谈谈自己的理解,有不对之处还请老师指出:<br>数据一致性问题目前来说主要分为三类<br>1.主从不一致<br>解决办法:半同步复制after_commit,after_sync,MGR(after_prepare)。但是都不能完成满足完全实时一致,由于等待的ack点不同,相对来说一致性的强度是递增.<br>2.数据库与缓存的不一致<br>解决办法:读操作直接读缓存,写操作先更新到数据库,淘汰缓存(程序需要保证两个操作的原子性).由于该key的缓存已经清理掉,那么下次读的时候需要先读数据库,在重建缓存.<br>由于redis是单线程,保证了一个操作的原子性.可以通过设置appendfsync always来保证每次操作都把该操作记录并落盘到aof文件里(不过一般redis该值为everysec),毕竟使用redis的目的不是为了保证acid.还是要根据业务来选择<br>3.一个事务跨多个节点或者多种数据库(分库分表和银行转账这种例子)<br>目前好像都是通过2pc,3pc来保证的。<br><br>count(字段值):如果该字段上有null值.每行的行头有一个标记位,标记该行是否为null.所以多了一层判断。相对更耗时<br>count(主键id):即便是选择的有null值的二级索引,但是也可以挺快的正确计数。因为null的话字段值虽然为null,但是该行上主键id以及指向聚簇索引该id的指针还是存在的,所以不影响计数,也不用做判断,直接遍历该二级索引,取出id值,按行累加就行。<br>count(1)和count(*):看官方文档上说是5.7.18版本之前是扫描聚簇索引,之后是二级索引。虽然不取值,只计数。但是二级索引比聚簇索引需要扫描的页数相对来说更少,这应该也是一种优化,不过我做测试percona版本的5.6都是选择了二级索引<br>这期干货挺多的,学会了如果某表上有count比较多的操作,最好是用count(1)或者count(*),然后选择一列占用字节数最少的建立索引(比如tinyint类型)<br><br>还有个问题请教下老师:<br>1.如果某列设置为not null建立索引.那么是不是count(id)走该索引和count(该列)效率是不是一样的？都不用做判断,两者都是需要把整个二级索引传给server层计数?还是说count(id)只需要传id,而count(字段)只需要传字段值给server层做计数？","like_count":8,"discussions":[{"author":{"id":1335293,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKR3ibELhjgVicCNShZCBwvaDxibnzibggG4wUzVkS2mkDxUBZyIs87nDEdJ7PiahJBVoZcuhQ84RxAziag/132","nickname":"周治慧","note":"","ucode":"7D56C4E66BEE17","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":187620,"discussion_content":"文中错误地方:\n1.主从同步时半同步复制时可以保证实时的一致性的,因为写时写主和从之后才响应只不过这样写的并发上不去;其他访问有强制读主,消息中间件路由读主,缓存是否失效来读主\n2.缓存和数据库一致性,应该是先删除缓存在去更新db,删除缓存失败直接返回,此时缓存和数据库都是旧数据一致性得到保证;删除缓存成功,更新db失败,直接返回此时缓存为空不影响一致性;删除缓存成功,db更新成功,缓存为空,db成功,缓存等待下一次读更新但是要防止读的是从库,可能主从之间还未同步完成\n","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1582757419,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1014665,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/7b/89/34f2cbcc.jpg","nickname":"杨宇","note":"","ucode":"EB74DF6E269F03","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1335293,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKR3ibELhjgVicCNShZCBwvaDxibnzibggG4wUzVkS2mkDxUBZyIs87nDEdJ7PiahJBVoZcuhQ84RxAziag/132","nickname":"周治慧","note":"","ucode":"7D56C4E66BEE17","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":319038,"discussion_content":"先写库，再淘汰缓存，如果淘汰失败则发一条消息异步淘汰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603930926,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":187620,"ip_address":""},"score":319038,"extra":""},{"author":{"id":1986739,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/50/b3/9269cd59.jpg","nickname":"LWD","note":"","ucode":"DDA444DB113C01","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1335293,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKR3ibELhjgVicCNShZCBwvaDxibnzibggG4wUzVkS2mkDxUBZyIs87nDEdJ7PiahJBVoZcuhQ84RxAziag/132","nickname":"周治慧","note":"","ucode":"7D56C4E66BEE17","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":587457,"discussion_content":"半同步只能保证一主一从","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1663064757,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":187620,"ip_address":"广东"},"score":587457,"extra":""}]},{"author":{"id":1115724,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLwSoTjHPX5tm4whBSfoZLX6toZxrZGUaLABQywKNf4MDc9toK3QSV7Z99ATcGicFCysoleQ5ISzmw/132","nickname":"乘风","note":"","ucode":"0420C5535DACB7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":47099,"discussion_content":"中间提到过innoDB与server交互定义:\ninnoDB只返回server需要的数据,意味着count(id)返回给server层的是id列,而具体判断非空是server去判断.\n\n","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1573271386,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":158074,"discussion_content":"count(字段）的效率依旧比count(id）差。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580548611,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49678,"user_name":"wljs","can_delete":false,"product_type":"c1","uid":1306543,"ip_address":"","ucode":"6B88A664972AD2","user_header":"https://static001.geekbang.org/account/avatar/00/13/ef/af/ba786593.jpg","comment_is_top":false,"comment_ctime":1544751829,"is_pvip":false,"replies":[{"id":"17913","content":"跟show table status是一样的","user_name":"作者回复","comment_id":49678,"uid":"1264162","ip_address":"","utype":1,"ctime":1544762704,"user_name_real":"林晓斌"}],"discussion_count":1,"race_medal":0,"score":"31609522901","product_id":100020801,"comment_content":"为何没说在information_schema.tables也可以查看表记录数。","like_count":7,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432716,"discussion_content":"跟show table status是一样的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544762704,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49637,"user_name":"陈天境","can_delete":false,"product_type":"c1","uid":1100792,"ip_address":"","ucode":"FF9EA3ACAAF864","user_header":"https://static001.geekbang.org/account/avatar/00/10/cb/f8/f4adadcb.jpg","comment_is_top":false,"comment_ctime":1544748842,"is_pvip":true,"replies":[{"id":"17861","content":"索引条件过滤完后还多少行？如果行数少（几百行？）就没关系直接执行了","user_name":"作者回复","comment_id":49637,"uid":"1264162","ip_address":"","utype":1,"ctime":1544749511,"user_name_real":"林晓斌"}],"discussion_count":5,"race_medal":0,"score":"31609519914","product_id":100020801,"comment_content":"碰到大部分情形都是带条件查询的count,，这个怎么解？","like_count":7,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432697,"discussion_content":"索引条件过滤完后还多少行？如果行数少（几百行？）就没关系直接执行了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544749511,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1986739,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/50/b3/9269cd59.jpg","nickname":"LWD","note":"","ucode":"DDA444DB113C01","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":587458,"discussion_content":"这个可以考虑业务上入手；大于1000条显示1000+；小于1000才显示具体数值；sql通过limit1000做限制","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1663064854,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1211178,"avatar":"https://static001.geekbang.org/account/avatar/00/12/7b/2a/7d8b5943.jpg","nickname":"LH","note":"","ucode":"819B9B2409E834","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":392902,"discussion_content":"有条件就算了，关键还有模糊查询，结果还几百万条。是不是该换数据库了⊙﹏⊙","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631172915,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1780797,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/2c/3d/0bd58aa4.jpg","nickname":"Em","note":"","ucode":"32012A5C603C8A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1211178,"avatar":"https://static001.geekbang.org/account/avatar/00/12/7b/2a/7d8b5943.jpg","nickname":"LH","note":"","ucode":"819B9B2409E834","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576997,"discussion_content":"存redis吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655878471,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":392902,"ip_address":""},"score":576997,"extra":""}]},{"author":{"id":1669916,"avatar":"","nickname":"蒋超","note":"","ucode":"BB37A2ED77C06D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":195841,"discussion_content":"如果是查出来行数很多，有没有什么办法","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583314982,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":226384,"user_name":"。","can_delete":false,"product_type":"c1","uid":1236620,"ip_address":"","ucode":"089148414D59D2","user_header":"https://static001.geekbang.org/account/avatar/00/12/de/8c/bd9d1868.jpg","comment_is_top":false,"comment_ctime":1592058076,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"27361861852","product_id":100020801,"comment_content":"老师，您好！<br>今天翻了下文档，按照MySQL innodb版本情况，文档已明确给出了以下说明：InnoDB handles SELECT COUNT(*) and SELECT COUNT(1) operations in the same way. There is no performance difference。<br>【https:&#47;&#47;dev.mysql.com&#47;doc&#47;refman&#47;5.7&#47;en&#47;group-by-functions.html#function_count】是否可以至少认为在5.7.18版本以后count(1)=count(*)呢【因为MySQL 文档没有明确指明具体版本，猜测下大概版本】2个方法的性能完全一致.但是如果是这样，那么count(1)还是像老师您说的那样：InnoDB 引擎遍历整张表，但不取值。server 层对于返回的每一行，放一个数字“1”进去，判断是不可能为空的，按行累加。还成立吗？<br>第二问题，想请教您一下，2-3个表join之后，添加各种条件的count()计算什么方案会更好些呢，单方面的缓存，感觉并不是十分有效啊，因为条件的组合排列会很多","like_count":6,"discussions":[{"author":{"id":2057210,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/63/fa/cf90b566.jpg","nickname":"沉淀","note":"","ucode":"1A87FDA3637D94","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":549871,"discussion_content":"5.6 5.7 8.0都有这一句话InnoDB handles SELECT COUNT(*) and SELECT COUNT(1) operations in the same way. There is no performance difference.","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644285439,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":107165,"user_name":"2009532140","can_delete":false,"product_type":"c1","uid":1311063,"ip_address":"","ucode":"B642DE795FB5A8","user_header":"https://static001.geekbang.org/account/avatar/00/14/01/57/13fd8e5a.jpg","comment_is_top":false,"comment_ctime":1561471371,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"27331275147","product_id":100020801,"comment_content":"关键，很多查询不仅仅是单表的计数。大部分情况下是对表联合查询的计数。是不是没有特殊好的思路了","like_count":6,"discussions":[{"author":{"id":1254801,"avatar":"https://static001.geekbang.org/account/avatar/00/13/25/91/46600294.jpg","nickname":"猴哥一一 cium","note":"","ucode":"38EC64F8D1A0B4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":312641,"discussion_content":"嗯,统计的是数据","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1602754533,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":158071,"discussion_content":"像这种加条件的，一般就只能直接执行计数了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580548522,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":105051,"user_name":"李威","can_delete":false,"product_type":"c1","uid":1460961,"ip_address":"","ucode":"3409A9390BD1FD","user_header":"https://static001.geekbang.org/account/avatar/00/16/4a/e1/2a498473.jpg","comment_is_top":false,"comment_ctime":1560908759,"is_pvip":false,"discussion_count":4,"race_medal":0,"score":"18740777943","product_id":100020801,"comment_content":"后台有很多表格形式的报表，分页是需要展示总页数的，当数据很多，但查询条件过滤掉的数据比较少时，查询速度就很慢(10几秒)，这个怎么解？","like_count":4,"discussions":[{"author":{"id":1062848,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83ersGSic8ib7OguJv6CJiaXY0s4n9C7Z51sWxTTljklFpq3ZAIWXoFTPV5oLo0GMTkqW5sYJRRnibNqOJQ/132","nickname":"walle斌","note":"","ucode":"0DB3243004951F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":293292,"discussion_content":"分页一般可以加上上次页数的offset  也可以是指id，下一次查询带上这个id  速度会快很多。还有如果你们那读写分离，建议count计算与分页查询并行查询，速度会快很多，当然缺点就是 count判断不需要下一页的时候，多一次分页查询。这些都可以在业务上规避","likes_number":5,"is_delete":false,"is_hidden":false,"ctime":1595499337,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2403312,"avatar":"https://static001.geekbang.org/account/avatar/00/24/ab/f0/12b18bba.jpg","nickname":"Vincent段","note":"","ucode":"36A764BAEF53A4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1062848,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83ersGSic8ib7OguJv6CJiaXY0s4n9C7Z51sWxTTljklFpq3ZAIWXoFTPV5oLo0GMTkqW5sYJRRnibNqOJQ/132","nickname":"walle斌","note":"","ucode":"0DB3243004951F","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":340061,"discussion_content":"mark","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609895827,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":293292,"ip_address":""},"score":340061,"extra":""}]},{"author":{"id":1453053,"avatar":"https://static001.geekbang.org/account/avatar/00/16/2b/fd/7013289d.jpg","nickname":"温故而知新可以为师矣","note":"","ucode":"FADCDFA9F9E5E8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":121047,"discussion_content":"是否可以考虑分批获取在内存计算总条数","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578309979,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1066508,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/0c/773ba2f3.jpg","nickname":"下个目标45k","note":"","ucode":"193BA8C3AA9A61","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1453053,"avatar":"https://static001.geekbang.org/account/avatar/00/16/2b/fd/7013289d.jpg","nickname":"温故而知新可以为师矣","note":"","ucode":"FADCDFA9F9E5E8","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":334613,"discussion_content":"把问题复杂化了，一楼的方案可行。要快的本质是减少扫描行数。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1607917095,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":121047,"ip_address":""},"score":334613,"extra":""}]}]},{"had_liked":false,"id":72451,"user_name":"XD","can_delete":false,"product_type":"c1","uid":1079293,"ip_address":"","ucode":"DC9DCFB3841A4E","user_header":"https://static001.geekbang.org/account/avatar/00/10/77/fd/c6619535.jpg","comment_is_top":false,"comment_ctime":1551628770,"is_pvip":false,"replies":[{"id":"26247","content":"可以理解为，返回了一行，但是0个字段","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1551656114,"ip_address":"","comment_id":72451,"utype":1}],"discussion_count":3,"race_medal":0,"score":"18731497954","product_id":100020801,"comment_content":"对于 count(1) 来说，InnoDB 引擎遍历整张表，但不取值。<br><br>老师，有点好奇innodb不取值的话，返回给执行器的数据是啥？我猜是一个类似endOfLine的标识？<br>那如果返回数据带值的话，这个数据格式怎么样的呢？类似json的kv对，还是类似excel的先有一行表头，后面跟着数据呢？<br><br>我本来觉得更像后者，这样在做count(1)和count(id)的时候只开头多一次表头判断就好了。但是看文章中的描述好像是每一行都要判断一次？那似乎更像是kv了。","like_count":4,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":441594,"discussion_content":"可以理解为，返回了一行，但是0个字段","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551656114,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1526355,"avatar":"https://static001.geekbang.org/account/avatar/00/17/4a/53/063f9d17.jpg","nickname":"moonfox","note":"","ucode":"902BFF40EFA9FA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":536916,"discussion_content":"&#34;作者回复: 可以理解为，返回了一行，但是0个字段&#34; 居然和我猜的一样，哈哈哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638891390,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1543162,"avatar":"https://static001.geekbang.org/account/avatar/00/17/8b/fa/103e6900.jpg","nickname":"山鬼谣","note":"","ucode":"E25F498B85A01B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":405202,"discussion_content":"我觉得，KV是不可能的，因为占位置；我估计是按位置存放的数据，第一个放什么，第二个放什么；需要判断的字段，统一 放最前面 或者 最后面。\n\n对返回给执行器的数据，我也有这方面的疑问；不取值，返回的是什么数据呢？老师回复为空行，那么就只能想象为txt文件那种的空行了。一个虚无的感觉，哈哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634528612,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49877,"user_name":"Bin","can_delete":false,"product_type":"c1","uid":1304406,"ip_address":"","ucode":"26BA010D2990C4","user_header":"https://static001.geekbang.org/account/avatar/00/13/e7/56/87f45704.jpg","comment_is_top":false,"comment_ctime":1544783659,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"18724652843","product_id":100020801,"comment_content":"答：先插入操作记录，再更新计数表。<br>       在InnoDB事务中，行锁是在需要的时候才加上, 等到事务结束(commit)的时候才释放。<br>       案例中的更新操作很多时候都是更新同一个数据对象, 如果是先更新计数表，那么持有的锁时间会更长.","like_count":4},{"had_liked":false,"id":54917,"user_name":"Ruian","can_delete":false,"product_type":"c1","uid":1318776,"ip_address":"","ucode":"39112092A920F1","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIyn6s0CNx9F9Uu4nia6z7ZldUo8XdXEF4ia4ojfTRCvMT8IZgjRcpFulYqZjq4IvtrE5yYfzpgzMWA/132","comment_is_top":false,"comment_ctime":1545981553,"is_pvip":false,"replies":[{"id":"19891","content":"你这个是笛卡尔积肯定慢的…你的业务需求是啥，这个语句的业务意义是什么","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545994730,"ip_address":"","comment_id":54917,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14430883441","product_id":100020801,"comment_content":"老师，我有一个问题请教下您。我的mysql数据库 有一张表project_des (850万数据) count(1) 只要0.05s   和从表project（6500条数据）关联后需要15s       查看执行计划发现都走索引了。不知道为啥这么慢？<br>查询语句 select count(1) from project_des a,project b where a.project_id=b.id 我换exists 和in 也这么慢","like_count":3,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434611,"discussion_content":"你这个是笛卡尔积肯定慢的…你的业务需求是啥，这个语句的业务意义是什么","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545994730,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":54211,"user_name":"萧萧木叶","can_delete":false,"product_type":"c1","uid":1309279,"ip_address":"","ucode":"F80561580DD40F","user_header":"","comment_is_top":false,"comment_ctime":1545807273,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"14430709161","product_id":100020801,"comment_content":"歪个楼请教个业务中遇到的问题：<br>表结构如下：<br> CREATE TABLE `tablename` (<br>  `id` int(10) NOT NULL AUTO_INCREMENT,<br>  `uid` bigint(20) NOT NULL DEFAULT &#39;0&#39;,<br>  `status` tinyint(1) NOT NULL DEFAULT &#39;1&#39; ,<br>  `date` varchar(8) NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;日期&#39;,<br>  `source` varchar(20) NOT NULL DEFAULT &#39;&#39; COMMENT &#39;来源&#39;,<br>  `ctime` datetime NOT NULL DEFAULT &#39;0000-00-00 00:00:00&#39; COMMENT &#39;创建时间&#39;,<br>  `etime` datetime NOT NULL DEFAULT &#39;0000-00-00 00:00:00&#39; COMMENT &#39;更新时间&#39;,<br>  PRIMARY KEY (`id`),<br>  UNIQUE KEY `idx_uid_date` (`uid`,`date`),<br>  KEY `idx_ctime` (`ctime`)<br>) ENGINE=InnoDB AUTO_INCREMENT=685725 DEFAULT CHARSET=utf8<br><br>其中 UNIQUE KEY `idx_uid_date` (`uid`,`date`)<br><br>查询指定date下uid个数：<br>方式一：select count(uid) from tablename where date = &#39;20181201&#39;;<br>+------------+<br>| count(uid) |<br>+------------+<br>|       8330 |<br>+------------+<br>方式二：select count(distinct uid) from tablename where date = &#39;20181201&#39;;<br>+---------------------+<br>| count(distinct uid) |<br>+---------------------+<br>|                8243         <br>+---------------------+<br>方式三：<br>select count(*) from (select distinct uid from tablename where date = &#39;20181201&#39;) as t;<br>+----------+<br>| count(*) |<br>+----------+<br>|     8330 |<br>+----------+<br>与方式一查询结果一致<br><br>问题：为何方式二和方式一、三的结果不一样呢？","like_count":3,"discussions":[{"author":{"id":1019568,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/8e/b0/ef201991.jpg","nickname":"CcczzZ","note":"","ucode":"5F46DA5053D2BB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":319739,"discussion_content":"方式二和方式三结果应该是是一样才对吧，都是去重之后的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604110570,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49665,"user_name":"帆帆帆帆帆帆帆帆","can_delete":false,"product_type":"c1","uid":1304645,"ip_address":"","ucode":"0CB732FFD07463","user_header":"https://static001.geekbang.org/account/avatar/00/13/e8/45/c58cb283.jpg","comment_is_top":false,"comment_ctime":1544751086,"is_pvip":false,"replies":[{"id":"17915","content":"还是的。<br><br>注意：count(id)也是可以使用普通索引的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544762806,"ip_address":"","comment_id":49665,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14429652974","product_id":100020801,"comment_content":"如果字段上有索引，且字段非空，count(字段)的效率就不是最差的了吧。","like_count":3,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432710,"discussion_content":"还是的。\n\n注意：count(id)也是可以使用普通索引的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544762806,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49593,"user_name":"慧鑫coming","can_delete":false,"product_type":"c1","uid":1324385,"ip_address":"","ucode":"7BAC9CA255630E","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLE4LYb3jrH63ZV98Zpc8DompwDgb1O3nffMoZCmiaibauRyEFv6NDNsST9RWxZExvMLMWb50zaanoQ/132","comment_is_top":false,"comment_ctime":1544744055,"is_pvip":false,"replies":[{"id":"17871","content":"好问题，<br>不对…<br>如果是这样这个方案就废了😄 可以并发执行，<br><br>没有一个”count”锁，count 就是一行行读数据，这个是一致性读（或者叫做快照度），不加锁的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544750379,"ip_address":"","comment_id":49593,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14429645943","product_id":100020801,"comment_content":"晓斌老师，图4中会话B会等待会话A提交后再执行吧？A中拿了count的写锁，我分析的对吧？","like_count":3,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432675,"discussion_content":"好问题，\n不对…\n如果是这样这个方案就废了😄 可以并发执行，\n\n没有一个”count”锁，count 就是一行行读数据，这个是一致性读（或者叫做快照度），不加锁的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544750379,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":62652,"user_name":"Zzz","can_delete":false,"product_type":"c1","uid":1116272,"ip_address":"","ucode":"4AA47797F48315","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIu1n1DhUGGKTjelrQaLYOSVK2rsFeia0G8ASTIftib5PTOx4pTqdnfwb0NiaEFGRgS661nINyZx9sUg/132","comment_is_top":false,"comment_ctime":1548124942,"is_pvip":false,"replies":[{"id":"22176","content":"为什么会呢？不会的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1548128895,"ip_address":"","comment_id":62652,"utype":1}],"discussion_count":3,"race_medal":0,"score":"10138059534","product_id":100020801,"comment_content":"老师，对于自增主键，批量插入是否会存在阻塞的情况？","like_count":2,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437290,"discussion_content":"为什么会呢？不会的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548128895,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1115724,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLwSoTjHPX5tm4whBSfoZLX6toZxrZGUaLABQywKNf4MDc9toK3QSV7Z99ATcGicFCysoleQ5ISzmw/132","nickname":"乘风","note":"","ucode":"0420C5535DACB7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":47078,"discussion_content":"批量插入是顺序取锁,并发插入可能会存在阻塞,获取计数器锁时导致的上边界竞争情况","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1573268769,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1127109,"avatar":"https://static001.geekbang.org/account/avatar/00/11/32/c5/38a59795.jpg","nickname":"逍遥子","note":"","ucode":"777CF0635970E1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375025,"discussion_content":"有个参数可以设置 ，是否会产生自增锁的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621438268,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":56857,"user_name":"Ivy","can_delete":false,"product_type":"c1","uid":1131135,"ip_address":"","ucode":"78156E0D5DEC52","user_header":"","comment_is_top":false,"comment_ctime":1546569225,"is_pvip":false,"replies":[{"id":"20528","content":"嗯，我的看法跟你一样，不过MySQL 现在就是这么做的😓","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1546573353,"ip_address":"","comment_id":56857,"utype":1}],"discussion_count":2,"race_medal":0,"score":"10136503817","product_id":100020801,"comment_content":"老师，你好，<br>如果这个“字段”是定义为 not null 的话，一行行地从记录里面读出这个字段，判断不能为 null，按行累加；<br>这段话没读懂，既然已经知道not null为何还要再次判断不能为 null？直接读出来累加不就可以了吗？另外是否我对引擎层面的数据读取有误解，是否说无论使用哪种 count 方式，引擎都一定要逐行去读只是在是否使用索引和是否返回给server层具体数据的区别？","like_count":2,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435281,"discussion_content":"嗯，我的看法跟你一样，不过MySQL 现在就是这么做的😓","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546573353,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1940779,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/9d/2b/6da5a8bf.jpg","nickname":"疯清俊","note":"","ucode":"8466D86EC173EE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":540892,"discussion_content":"老师您好！这个怎么查看ＭｙＳＱＬ的执行方式？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640187976,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":344560,"user_name":"好好学习","can_delete":false,"product_type":"c1","uid":1110299,"ip_address":"","ucode":"327552B5924389","user_header":"https://static001.geekbang.org/account/avatar/00/10/f1/1b/d3165de8.jpg","comment_is_top":false,"comment_ctime":1651648672,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5946615968","product_id":100020801,"comment_content":"如果采用自己做计数器表，是不是应该采用同一个表用多行记录求和来做这个计数器，避免高并发场景下锁竞争激烈。","like_count":1},{"had_liked":false,"id":344553,"user_name":"好好学习","can_delete":false,"product_type":"c1","uid":1110299,"ip_address":"","ucode":"327552B5924389","user_header":"https://static001.geekbang.org/account/avatar/00/10/f1/1b/d3165de8.jpg","comment_is_top":false,"comment_ctime":1651647202,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5946614498","product_id":100020801,"comment_content":"关于innodb没有像myisam一样有内置计数器，应该是综合取舍的结果吧，光看实现的话，也是可以增加个计数器的。比如计数器只记录当前最小活跃事务提交后总数，其他事务获取这个count时 需要这个记录+当前事务中的操作来推算。那执行效率肯定也会比一行行读取要高。","like_count":1},{"had_liked":false,"id":308820,"user_name":"sundy","can_delete":false,"product_type":"c1","uid":1073049,"ip_address":"","ucode":"610A54CEA6CB34","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIyZfj0vzMrnDjAQulSnlXBd1tFQhnf1R8uCfR5ZemHhRWicAHktveTTeqPswPEYfiau5aSyy8QOkXA/132","comment_is_top":false,"comment_ctime":1629811052,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5924778348","product_id":100020801,"comment_content":"count的时候，如果数据只是写到了redolog和binlog里面，这个count是怎么工作的","like_count":1,"discussions":[{"author":{"id":1015184,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/7d/90/abb7bfe3.jpg","nickname":"fourge","note":"","ucode":"F3E3FFC4990358","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":582998,"discussion_content":"如果没有提交，不就是不可见的吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659867279,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":307632,"user_name":"Geek_9ee170","can_delete":false,"product_type":"c1","uid":2739334,"ip_address":"","ucode":"273408D8885694","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/CV9kk5M26pdxvFhbrkicjZVuYxSG4vLNcqBzlESUUz2g9mavJ9cf0R4rbow27ZMLXqNted3dKmel8W83Kb2geLw/132","comment_is_top":false,"comment_ctime":1629185159,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5924152455","product_id":100020801,"comment_content":"请教下，下面的语句在单机的情况下表C中的计数和表D的行数是一致的，但是在分布式高并发情况下还能保证数据一致吗<br>begin;<br>表C中计数加1;<br>表D中插入一行数据;<br>commit;","like_count":1},{"had_liked":false,"id":286729,"user_name":"罗选东","can_delete":false,"product_type":"c1","uid":2015657,"ip_address":"","ucode":"7E844804319E3B","user_header":"https://static001.geekbang.org/account/avatar/00/1e/c1/a9/ece95406.jpg","comment_is_top":false,"comment_ctime":1617528368,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5912495664","product_id":100020801,"comment_content":"<br>有个难以理解的问题：<br>count（字段）<br>1.如果这个“字段”是定义为 not null 的话，一行行地从记录里面读出这个字段，判断不能为 null，按行累加；<br>2。如果这个“字段”定义允许为 null，那么执行的时候，判断到有可能是 null，还要把值取出来再判断一下，不是 null 才累加。<br><br>问题1：一行一行从记录读出字段，判断不能为Null，这里是判断字段的值不能为Null吗？不然这个读出的字段是什么？读出什么？<br>问题2：如果这个“字段”定义允许为 null，那么执行的时候，判断到有可能是 null，还要把值取出来再判断一下，不是 null 才累加。这里的判断又是什么，？？？？？？？<br>问题3：这里一行一行取出记录，是遍历主键索引吗？如果这个字段是一个普通索引呢？<br><br>","like_count":1},{"had_liked":false,"id":275518,"user_name":"Aibo","can_delete":false,"product_type":"c1","uid":2115387,"ip_address":"","ucode":"2CE3E77BD2D014","user_header":"https://static001.geekbang.org/account/avatar/00/20/47/3b/70198ceb.jpg","comment_is_top":false,"comment_ctime":1611569042,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5906536338","product_id":100020801,"comment_content":"想请问一下，对于一个not in筛选，not in集合会持续增大；都查出来，放内存里处理好，还是就用not in好","like_count":1},{"had_liked":false,"id":271689,"user_name":"校歌","can_delete":false,"product_type":"c1","uid":2054611,"ip_address":"","ucode":"CD257668BB1A33","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEKBENQekdV3e9XwRQ5kpO9Y9d81sEMm52qcwJWbFbWbW2rniaTFYCChoR0ibZ0E3soQqod9rvfmBibmQ/132","comment_is_top":false,"comment_ctime":1609758086,"is_pvip":true,"discussion_count":0,"race_medal":1,"score":"5904725382","product_id":100020801,"comment_content":"InnoDB handles SELECT COUNT(*) and SELECT COUNT(1) operations in the same way. There is no performance difference.<br>参考mysql官网：<br>https:&#47;&#47;dev.mysql.com&#47;doc&#47;refman&#47;5.7&#47;en&#47;aggregate-functions.html#function_count","like_count":1},{"had_liked":false,"id":262108,"user_name":"玄真","can_delete":false,"product_type":"c1","uid":2237677,"ip_address":"","ucode":"D21A7096AFB816","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLg04lnicnUNWVmohBVoWiaKPpuYu8j0CHVIjjurfO3YcJqicHZBMYFqjoEpiaa3jrNmRzyzXiaPPt29cA/132","comment_is_top":false,"comment_ctime":1605613786,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5900581082","product_id":100020801,"comment_content":"记得上次你说要把引起锁的语句尽量放在事务尾部，应该先插入再修改全局计数表吧。","like_count":1},{"had_liked":false,"id":257954,"user_name":"无名道长","can_delete":false,"product_type":"c1","uid":1387960,"ip_address":"","ucode":"0F694D17459CC0","user_header":"https://static001.geekbang.org/account/avatar/00/15/2d/b8/7e49a241.jpg","comment_is_top":false,"comment_ctime":1604222428,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5899189724","product_id":100020801,"comment_content":"应该先插入操作然后更新计数表，因为要把容易产生锁冲突的语句放到离结束事务最近的地方，然后如果并发量非常大的话这个语句可能成为瓶颈，可以将表计数拆成多行，减少单行并发量","like_count":1},{"had_liked":false,"id":217018,"user_name":"LovePeace","can_delete":false,"product_type":"c1","uid":1010319,"ip_address":"","ucode":"5BA5B11FAF953E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/6a/8f/5b224f54.jpg","comment_is_top":false,"comment_ctime":1589385657,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5884352953","product_id":100020801,"comment_content":"请教一下 老师文中说：对于 count(*) 这样的操作，遍历哪个索引树得到的结果逻辑上都是一样的。因此，MySQL 优化器会找到最小的那棵树来遍历。如果一个普通索引的值有为空的话那得到的数据是不是就不准确了呢？","like_count":1},{"had_liked":false,"id":189228,"user_name":"哈密锅儿","can_delete":false,"product_type":"c1","uid":1792142,"ip_address":"","ucode":"35B34503F530AB","user_header":"https://static001.geekbang.org/account/avatar/00/1b/58/8e/97b20eb3.jpg","comment_is_top":false,"comment_ctime":1584491148,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5879458444","product_id":100020801,"comment_content":"先不考虑MySQL选择用什么优化，单纯的比较几个count()，从效率上来说，count (*)≈count(1)&gt;count(二级索引列)&gt;count(主键)&gt;count(非索引列)，因为查询时，MySQL需要把索引数据读到内存中，主键索引包含存储的实际数据，所以一般比二级索引列要大，这样，性能就比不上二级索引列，所以MySQL官网才会说使用主键count 的时候，会优先选择最小的二级索引列，如果没有，再用主键count 。对于没有索引的列做count ，需要把全表数据读入内存，然后根据主键回表查询这一列数据判断是否为null，所以性能是最差的。这样的分析有问题吗，老师。","like_count":1},{"had_liked":false,"id":130473,"user_name":"alioo","can_delete":false,"product_type":"c1","uid":1022507,"ip_address":"","ucode":"F36A38C1F5FFAB","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqOpANMwDibLmj5IGJh6dTw300sZ1BHM5sG3sZv1A1rvCHOiblPD3jgFOiaMVVujtctWnQbVFoNPpRgw/132","comment_is_top":false,"comment_ctime":1567471590,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"5862438886","product_id":100020801,"comment_content":"知识点：count(id) 也是走普通索引 ，普通索引比主键索引要小，遍历起来更快","like_count":1,"discussions":[{"author":{"id":1451640,"avatar":"https://static001.geekbang.org/account/avatar/00/16/26/78/ed0252c2.jpg","nickname":"ddddd🐳","note":"","ucode":"EFEA2FBB27ECFE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":560540,"discussion_content":"普通索引里可不一定包含全部id","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649385292,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2287841,"avatar":"https://static001.geekbang.org/account/avatar/00/22/e8/e1/6045b299.jpg","nickname":"LPF","note":"","ucode":"036C552D7251E9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":328096,"discussion_content":"普通索引中的最小索引树","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606053956,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":120280,"user_name":"辉煌码农","can_delete":false,"product_type":"c1","uid":1332799,"ip_address":"","ucode":"09779C2E06EA52","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIy5ULaodUwsLoPuk1wd22hqXsaBbibNEqXM0kgrCTYDGKYQkZICYEyH9wMj4hyUicuQwHdDuOKRj0g/132","comment_is_top":false,"comment_ctime":1564819210,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5859786506","product_id":100020801,"comment_content":"老师 有个问题，需要您解答下。由于数据库存储总行数在更新过程中没办法保证原子性递增&#47;递减，需要用到乐观锁。但如果并发特别大，修改计数表的操作就可能执行多次才会成功，会影响业务表的读写效率吧。<br>数据库保存总行数的方法确实可以保证准确性和一致性，但也可能会对业务表的写效率呢","like_count":1,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":158077,"discussion_content":"那实在不行你就加个消息队列，将并发压力变成顺序操作数据库，这样就行了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580548775,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":100975,"user_name":"王麒","can_delete":false,"product_type":"c1","uid":1265260,"ip_address":"","ucode":"330017C5A911B6","user_header":"https://static001.geekbang.org/account/avatar/00/13/4e/6c/71020c59.jpg","comment_is_top":false,"comment_ctime":1559697440,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5854664736","product_id":100020801,"comment_content":"如果行数还是比较多呢，有其他优化方案吗？","like_count":1,"discussions":[{"author":{"id":1066508,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/0c/773ba2f3.jpg","nickname":"下个目标45k","note":"","ucode":"193BA8C3AA9A61","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":334614,"discussion_content":"行数多的话可以并行查询，最终合并一下。将大事务拆成小事务。\n\n但是可以从业务角度考虑一下是不是需要这么多数据呢？报表业务一般从大数据平台出不会直接从业务库导出","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1607917446,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":72905,"user_name":"念你如昔","can_delete":false,"product_type":"c1","uid":1323531,"ip_address":"","ucode":"FCAD88AB57D084","user_header":"https://static001.geekbang.org/account/avatar/00/14/32/0b/981b4e93.jpg","comment_is_top":false,"comment_ctime":1551753259,"is_pvip":false,"replies":[{"id":"26694","content":"是的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1551876512,"ip_address":"","comment_id":72905,"utype":1}],"discussion_count":3,"race_medal":0,"score":"5846720555","product_id":100020801,"comment_content":"老师，我这边explain 看 select count(primary_id) count(1) count(*) 都是遍历的最小索引树，没有遍历全表的情况。是不是count(1) 和count(*) 虽遍历最小索引树，但是并没有扫描树里的数据，而count（id）扫描了树里的数据，所以比他俩慢？关于这个谁快谁慢的问题，真的是众说纷纭，，，","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":441818,"discussion_content":"是的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551876512,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1209939,"avatar":"https://static001.geekbang.org/account/avatar/00/12/76/53/21d62a23.jpg","nickname":"鲁·本","note":"","ucode":"F1DEB30C21B48E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576967,"discussion_content":"老师,有个疑问, 如果扫描的是二级索引树, 不读实际的数据的话, 如何判断可见性呢?","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655869827,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1453053,"avatar":"https://static001.geekbang.org/account/avatar/00/16/2b/fd/7013289d.jpg","nickname":"温故而知新可以为师矣","note":"","ucode":"FADCDFA9F9E5E8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1209939,"avatar":"https://static001.geekbang.org/account/avatar/00/12/76/53/21d62a23.jpg","nickname":"鲁·本","note":"","ucode":"F1DEB30C21B48E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":579220,"discussion_content":"不取数据，应该也要取行上的trx_id和上一个版本的指针吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1657257021,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":576967,"ip_address":""},"score":579220,"extra":""}]}]},{"had_liked":false,"id":72606,"user_name":"Demter","can_delete":false,"product_type":"c1","uid":1158439,"ip_address":"","ucode":"BE3B6F726916CE","user_header":"https://static001.geekbang.org/account/avatar/00/11/ad/27/5556ae50.jpg","comment_is_top":false,"comment_ctime":1551677035,"is_pvip":false,"replies":[{"id":"26826","content":"没有返回“整行”数据呀","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1551940036,"ip_address":"","comment_id":72606,"utype":1}],"discussion_count":3,"race_medal":0,"score":"5846644331","product_id":100020801,"comment_content":"count(1)虽然不取值，到时要返回整行数据，，这样返回的数据量大啊，对性能没影响吗??","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":441655,"discussion_content":"没有返回“整行”数据呀","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551940036,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":371430,"discussion_content":"走哪个索引就返回哪个数据","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619767938,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1762602,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/e5/2a/38e4c07e.jpg","nickname":"ZHI","note":"","ucode":"573BB83EC7086D","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":534084,"discussion_content":"因该是直接返回统计结果吧？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1638090624,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":371430,"ip_address":""},"score":534084,"extra":""}]}]},{"had_liked":false,"id":64448,"user_name":"苦行僧","can_delete":false,"product_type":"c1","uid":1055334,"ip_address":"","ucode":"726024A9A9CF44","user_header":"https://static001.geekbang.org/account/avatar/00/10/1a/66/2d9db9ed.jpg","comment_is_top":false,"comment_ctime":1548805324,"is_pvip":false,"replies":[{"id":"22816","content":"哈哈，对对👍","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1548808577,"ip_address":"","comment_id":64448,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5843772620","product_id":100020801,"comment_content":"二话不说 先把代码中count改成count(* ）","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438002,"discussion_content":"哈哈，对对👍","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548808577,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":63248,"user_name":"po","can_delete":false,"product_type":"c1","uid":1234627,"ip_address":"","ucode":"2810E5CF7FC799","user_header":"https://static001.geekbang.org/account/avatar/00/12/d6/c3/09a4b5eb.jpg","comment_is_top":false,"comment_ctime":1548311169,"is_pvip":false,"replies":[{"id":"22400","content":"实时改变","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1548313479,"ip_address":"","comment_id":63248,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5843278465","product_id":100020801,"comment_content":"老师你说Myisam引擎的总行数是写在磁盘上的，但是如果更新了数据，这个总行数的值是会时事改变，还是他有什么其他的策略。","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437519,"discussion_content":"实时改变","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548313479,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":56860,"user_name":"Ivy","can_delete":false,"product_type":"c1","uid":1131135,"ip_address":"","ucode":"78156E0D5DEC52","user_header":"","comment_is_top":false,"comment_ctime":1546569752,"is_pvip":false,"replies":[{"id":"20522","content":"就是返回一个空行，但是高度server层“不是空值，可以计数”<br><br>过程上，其实是server层调用引擎接口，一行一行取","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1546571211,"ip_address":"","comment_id":56860,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5841537048","product_id":100020801,"comment_content":"老师，文章中反复强调不取值，这是什么概念呢？引擎不取值server怎么拿到数据又怎么计数呢？能不能大概解释一下引擎读取数据返回给server的过程呀？","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435283,"discussion_content":"就是返回一个空行，但是高度server层“不是空值，可以计数”\n\n过程上，其实是server层调用引擎接口，一行一行取","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546571211,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":54617,"user_name":"运斤成风","can_delete":false,"product_type":"c1","uid":1350812,"ip_address":"","ucode":"BAFF69C29FDFA5","user_header":"https://static001.geekbang.org/account/avatar/00/14/9c/9c/e02a0daf.jpg","comment_is_top":false,"comment_ctime":1545915122,"is_pvip":false,"replies":[{"id":"19822","content":"是的，但是你写count(*)的时候，MySQL 自己会选这个合理的索引的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545920077,"ip_address":"","comment_id":54617,"utype":1}],"discussion_count":3,"race_medal":0,"score":"5840882418","product_id":100020801,"comment_content":"老师好，Count（字段），若字段是二级索引，又添加了非空约束。这样的话应该是遍历小树（仅遍历二级索引就能取得正确记数），遍历的叶子结点要比主键的全遍少很多。应该效率比主键快吧？谢谢","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434513,"discussion_content":"是的，但是你写count(*)的时候，MySQL 自己会选这个合理的索引的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545920077,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":158192,"discussion_content":"不会，count(id)也是走普通索引，所以还是比count(字段)快。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580560481,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2256446,"avatar":"https://static001.geekbang.org/account/avatar/00/22/6e/3e/4e67a110.jpg","nickname":"24k","note":"","ucode":"FFE5B04D0B7BD7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":369811,"discussion_content":"如果他们都选择了同一个二级索引，是不是效率就一样了？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619162728,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":158192,"ip_address":""},"score":369811,"extra":""}]}]},{"had_liked":false,"id":53194,"user_name":"可凡不凡","can_delete":false,"product_type":"c1","uid":1296289,"ip_address":"","ucode":"9D42D6C5274D48","user_header":"https://static001.geekbang.org/account/avatar/00/13/c7/a1/273bff58.jpg","comment_is_top":false,"comment_ctime":1545614975,"is_pvip":false,"replies":[{"id":"19262","content":"是选中一个索引，走全索引的扫描","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545615979,"ip_address":"","comment_id":53194,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5840582271","product_id":100020801,"comment_content":"老师 count() 不管有没有索引 一定会走全表扫描吗","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434060,"discussion_content":"是选中一个索引，走全索引的扫描","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545615979,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":52068,"user_name":"马若飞","can_delete":false,"product_type":"c1","uid":1046394,"ip_address":"","ucode":"3D0327329A10AE","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","comment_is_top":false,"comment_ctime":1545304724,"is_pvip":false,"replies":[{"id":"18840","content":"嗯，列存尤其不建议用* <br><br>当然行存也不建议","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545306927,"ip_address":"","comment_id":52068,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5840272020","product_id":100020801,"comment_content":"对于infobright这种列式存储的引擎，是不是就不能用*了","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433728,"discussion_content":"嗯，列存尤其不建议用* \n\n当然行存也不建议","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545306927,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":50617,"user_name":"Bennet","can_delete":false,"product_type":"c1","uid":1022801,"ip_address":"","ucode":"C85C47A75BA412","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIXYib4bOBtUeLniaqjMNaOY4gDPPbL4hYmv1HYHSPibyHVQlAeWhabABIy0YL7qgOqaa8EibxGSoiaw1w/132","comment_is_top":false,"comment_ctime":1545016907,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"5839984203","product_id":100020801,"comment_content":"count(字段)<br>1. 如果这个“字段”是定义为 not null 的话，一行行地从记录里面读出这个字段，判断不能为 null，按行累加；<br>2. 如果这个“字段”定义允许为 null，那么执行的时候，判断到有可能是 null，还要把值取出来再判断一下，不是 null 才累加。<br>--------------------------------------------<br>没有理解区别，看上去不管“字段”是否为 null，都需要读记录的字段值，判断不是null，然后计数。","like_count":1,"discussions":[{"author":{"id":1171004,"avatar":"https://static001.geekbang.org/account/avatar/00/11/de/3c/96c1bc62.jpg","nickname":"卢建文","note":"","ucode":"900A0CE253F2BF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375300,"discussion_content":"都需要判断是否为null吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621566799,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":158196,"discussion_content":"是的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580560653,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":354249,"user_name":"吃水不用钱","can_delete":false,"product_type":"c1","uid":1797135,"ip_address":"广东","ucode":"8A5D5978F0D4E5","user_header":"https://static001.geekbang.org/account/avatar/00/1b/6c/0f/7d242cc2.jpg","comment_is_top":false,"comment_ctime":1660215326,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1660215326","product_id":100020801,"comment_content":"先插入数据，再更新计数表。计数表多个事务都要修改，存在行锁，把需要加锁的行放到最后，可以降低锁的竞争","like_count":0},{"had_liked":false,"id":352292,"user_name":"夏帆","can_delete":false,"product_type":"c1","uid":3033735,"ip_address":"","ucode":"D4C9DCD01E85AD","user_header":"https://static001.geekbang.org/account/avatar/00/2e/4a/87/791d0f5e.jpg","comment_is_top":false,"comment_ctime":1658504769,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1658504769","product_id":100020801,"comment_content":"用缓存系统保存计数的问题，解决问题的关键是不是让插入数据和Redis数据变化这两个操作构成一个原子操作呢？对于其他线程来说，就只能看到他们都没完成和一起完成后的数据了","like_count":0},{"had_liked":false,"id":351752,"user_name":"2Years","can_delete":false,"product_type":"c1","uid":2633486,"ip_address":"","ucode":"9CC611009FCA4E","user_header":"https://static001.geekbang.org/account/avatar/00/28/2f/0e/d61a9a47.jpg","comment_is_top":false,"comment_ctime":1658153109,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1658153109","product_id":100020801,"comment_content":"一个几千万的表，count(*)确实很慢，可以怎么优化呢？ 因为mybatis分页查询，每次都会count(*)， 效果很差。老师有什么解决办法吗， 如果不分库分表的话。 ","like_count":0},{"had_liked":false,"id":350593,"user_name":"很大的勇气","can_delete":false,"product_type":"c1","uid":1695608,"ip_address":"","ucode":"7871D1C1E22F3F","user_header":"https://static001.geekbang.org/account/avatar/00/19/df/78/d4946736.jpg","comment_is_top":false,"comment_ctime":1657026625,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1657026625","product_id":100020801,"comment_content":"先updata计数表，然后在insert业务表。<br>因为insert所操作的表是一个频繁执行dml语句的表，所以尽可能的将该表的操作放在后面。而计数表只有业务表发生insert是才会updata，所以相对来说不频繁，因此建议先updata计数表，然后在往业务表里执行insert。<br>","like_count":0},{"had_liked":false,"id":350592,"user_name":"Unknown element","can_delete":false,"product_type":"c1","uid":2028277,"ip_address":"","ucode":"34A129800D0238","user_header":"https://static001.geekbang.org/account/avatar/00/1e/f2/f5/b82f410d.jpg","comment_is_top":false,"comment_ctime":1657026342,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1657026342","product_id":100020801,"comment_content":"老师问下“server 层对于返回的每一行，放一个数字“1”进去，判断是不可能为空的，按行累加。”<br>这里“放一个数字1进去”怎么理解？","like_count":0},{"had_liked":false,"id":349282,"user_name":"鲁·本","can_delete":false,"product_type":"c1","uid":1209939,"ip_address":"","ucode":"F1DEB30C21B48E","user_header":"https://static001.geekbang.org/account/avatar/00/12/76/53/21d62a23.jpg","comment_is_top":false,"comment_ctime":1655864587,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1655864587","product_id":100020801,"comment_content":"老师, 如果mysql 只有主键索引, 没有其他索引的情况下, select count(*) 做主键索引的扫描, 是不是就相当于做了全表扫描了?","like_count":0,"discussions":[{"author":{"id":1453053,"avatar":"https://static001.geekbang.org/account/avatar/00/16/2b/fd/7013289d.jpg","nickname":"温故而知新可以为师矣","note":"","ucode":"FADCDFA9F9E5E8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":579224,"discussion_content":"可能就是“取不取数据”的差别吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1657258053,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":345583,"user_name":"幸福朵朵","can_delete":false,"product_type":"c1","uid":1099834,"ip_address":"","ucode":"A0783D165BE26A","user_header":"https://static001.geekbang.org/account/avatar/00/10/c8/3a/f7359b82.jpg","comment_is_top":false,"comment_ctime":1652412990,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1652412990","product_id":100020801,"comment_content":"老师，有个地方理解不了，麻烦问下：文章前面说innodb考虑不同事务中读到的count可能不一样所以innodb没有像myisam一样存储count值，“在数据库保存计数”里说可以将count值存储在一张单独的表中，我理解表还是存储在数据库中，为什么innodb不能将count值存储在系统表中？","like_count":0},{"had_liked":false,"id":345419,"user_name":"whyly","can_delete":false,"product_type":"c1","uid":1798882,"ip_address":"","ucode":"D34D6B7164C982","user_header":"https://static001.geekbang.org/account/avatar/00/1b/72/e2/95b0543c.jpg","comment_is_top":false,"comment_ctime":1652259817,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1652259817","product_id":100020801,"comment_content":"从并发的角度出发，应该先插入后更新计数表，InnoDB行锁支持两阶段锁协议，在需要的时候加锁，但并不是不需要就释放，要到事务提交后才释放，所以应该把容易产生资源竞争的操作往后放。","like_count":0},{"had_liked":false,"id":341804,"user_name":"核桃","can_delete":false,"product_type":"c1","uid":1385204,"ip_address":"","ucode":"7AB05270CBCCCB","user_header":"https://static001.geekbang.org/account/avatar/00/15/22/f4/9fd6f8f0.jpg","comment_is_top":false,"comment_ctime":1649837341,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1649837341","product_id":100020801,"comment_content":"思考题那里，很多人都提到了回答，这里从另外一个角度来思考吧，除了数据库，文件系统其实也是面临这样的问题，当很多数据写入的时候，这时候文件的元数据信息也是需要更新的。因此一般都是先让数据写入，使用cow，然后再定时更新或者客户端发起更新来修改文件元数据信息。","like_count":0},{"had_liked":false,"id":341653,"user_name":"눈_눈","can_delete":false,"product_type":"c1","uid":1248249,"ip_address":"","ucode":"8277EC25B39038","user_header":"https://static001.geekbang.org/account/avatar/00/13/0b/f9/471bb35d.jpg","comment_is_top":false,"comment_ctime":1649752615,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1649752615","product_id":100020801,"comment_content":"想问一下，如果业务对数量有限制，例如不能超过100条数据那还应该先插入行吗？如果插入行之后，更新count，发现count变了，是否还要再查一下count有没有超过限制，如果超过了限制，要触发回滚事务，是不是成本特别高？","like_count":0},{"had_liked":false,"id":337436,"user_name":"我不是码农","can_delete":false,"product_type":"c1","uid":1874999,"ip_address":"","ucode":"EB4BB711CC54B6","user_header":"https://static001.geekbang.org/account/avatar/00/1c/9c/37/253ea895.jpg","comment_is_top":false,"comment_ctime":1646823972,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1646823972","product_id":100020801,"comment_content":"这么看来，count聚合函数其实是由server层实现的。盲猜其他函数应该也是这样吧。","like_count":0,"discussions":[{"author":{"id":1453053,"avatar":"https://static001.geekbang.org/account/avatar/00/16/2b/fd/7013289d.jpg","nickname":"温故而知新可以为师矣","note":"","ucode":"FADCDFA9F9E5E8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":579225,"discussion_content":"函数都是在server层，引擎层只负责存取数据。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1657258235,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2843604,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/63/d4/b63373c3.jpg","nickname":"金金","note":"","ucode":"807EDDCDB2E939","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":560307,"discussion_content":"像这种函数都是由上层的计算层实现的，存储引擎实际上只有读数据和写数据的功能，像所谓的事务实际上也是为读写数据进行服务的。而存储引擎一般是没有计算功能的，有的话也之后一些比较简单的过滤操作，目的是为了减少计算层和存储层之间的数据量交互","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649256204,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":337141,"user_name":"清风","can_delete":false,"product_type":"c1","uid":1142539,"ip_address":"","ucode":"ED1B6DECC3A102","user_header":"https://static001.geekbang.org/account/avatar/00/11/6f/0b/06480912.jpg","comment_is_top":false,"comment_ctime":1646645316,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1646645316","product_id":100020801,"comment_content":"count(*)不取数据，直接统计行数，有一个疑问，在RR和RC模式下，有隔离性的存在。不判断数据版本吗","like_count":0,"discussions":[{"author":{"id":1015184,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/7d/90/abb7bfe3.jpg","nickname":"fourge","note":"","ucode":"F3E3FFC4990358","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":582999,"discussion_content":"就是在会话中可见范围内的统计数量的吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659867467,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1209939,"avatar":"https://static001.geekbang.org/account/avatar/00/12/76/53/21d62a23.jpg","nickname":"鲁·本","note":"","ucode":"F1DEB30C21B48E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576968,"discussion_content":"同问?","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655869883,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":327610,"user_name":"疯清俊","can_delete":false,"product_type":"c1","uid":1940779,"ip_address":"","ucode":"8466D86EC173EE","user_header":"https://static001.geekbang.org/account/avatar/00/1d/9d/2b/6da5a8bf.jpg","comment_is_top":false,"comment_ctime":1640188698,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1640188698","product_id":100020801,"comment_content":"老师您好！怎么查看MySQL中的count(?)具体是如何执行的呢？单从语句的执行时间来看、无法看出执行效率的优先级？<br><br>SELECT count(*) from test    -- 2145280    0.557s<br>SELECT count(batch_task_id) from test   -- batch_task_id 为主键    2145280  0.420s<br>SELECT count(task_id) from test        -- task_id 为非空字段      2145280  0.420s<br>SELECT count(execute_type) from test    -- execute 可为空字段      1763328  1.090s","like_count":0},{"had_liked":false,"id":326589,"user_name":"林鹏","can_delete":false,"product_type":"c1","uid":2688498,"ip_address":"","ucode":"FC2AA9B8E7DF99","user_header":"https://static001.geekbang.org/account/avatar/00/29/05/f2/3a0f7f60.jpg","comment_is_top":false,"comment_ctime":1639572714,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1639572714","product_id":100020801,"comment_content":"对于计数，我有个疑惑，既然我们能够利用事务 + 独自创建表来解决，那么MySQL本身是不是也可以这样解决？","like_count":0},{"had_liked":false,"id":325846,"user_name":"建强","can_delete":false,"product_type":"c1","uid":1397126,"ip_address":"","ucode":"62B03D0E0C64EC","user_header":"https://static001.geekbang.org/account/avatar/00/15/51/86/b5fd8dd8.jpg","comment_is_top":false,"comment_ctime":1639191372,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1639191372","product_id":100020801,"comment_content":"思考题，先更新计数表，再插入记录，更新计数表时间较短，插入记录相对时间较长，先执行时间短的，再执行时间长的，可以尽快释放资源，性能也会更好","like_count":0},{"had_liked":false,"id":324975,"user_name":"吉尔瓦伦丁","can_delete":false,"product_type":"c1","uid":2714921,"ip_address":"","ucode":"A1D9F8E3FEA089","user_header":"https://static001.geekbang.org/account/avatar/00/29/6d/29/8f0654df.jpg","comment_is_top":false,"comment_ctime":1638764586,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1638764586","product_id":100020801,"comment_content":"先插入新数据，再修改计数。<br>因为修改计数会涉及到行锁的竞争，应该最大程度降低事务之间的锁等待，提高并发。","like_count":0},{"had_liked":false,"id":324738,"user_name":"张云翔","can_delete":false,"product_type":"c1","uid":1384729,"ip_address":"","ucode":"7D2E7F13B48664","user_header":"https://static001.geekbang.org/account/avatar/00/15/21/19/50085e26.jpg","comment_is_top":false,"comment_ctime":1638596559,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1638596559","product_id":100020801,"comment_content":"如果这张表的主键id设置为自增 并且永远不删除数据 那直接max(id) 就可以获得当前的行数 且不是全表扫描","like_count":0,"discussions":[{"author":{"id":1015184,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/7d/90/abb7bfe3.jpg","nickname":"fourge","note":"","ucode":"F3E3FFC4990358","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583000,"discussion_content":"但是通常的业务查询场景下，并不是直接count整张表，而是带有where条件的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659867551,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":321155,"user_name":"信天游","can_delete":false,"product_type":"c1","uid":1678523,"ip_address":"","ucode":"786A45A9139434","user_header":"https://static001.geekbang.org/account/avatar/00/19/9c/bb/88f41cba.jpg","comment_is_top":false,"comment_ctime":1636690973,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1636690973","product_id":100020801,"comment_content":"使用mysql计数表在实际场景中是不是意义不大，往往查询都是带条件的","like_count":0},{"had_liked":false,"id":320692,"user_name":"MichaelChen","can_delete":false,"product_type":"c1","uid":1184259,"ip_address":"","ucode":"FAD745F3220AE0","user_header":"https://static001.geekbang.org/account/avatar/00/12/12/03/c657c350.jpg","comment_is_top":false,"comment_ctime":1636453913,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1636453913","product_id":100020801,"comment_content":"自己维护计数器，只能适用于整个列表的合计。基于WHERE的COUNT(*)又应该如何优化呢？我们在列表中，总是会有字段的搜索，然后通用分页类就需要count筛选后的条数，这种情况下是否真的无解？","like_count":0},{"had_liked":false,"id":319439,"user_name":"CJJ","can_delete":false,"product_type":"c1","uid":1194060,"ip_address":"","ucode":"7E02A6A8547559","user_header":"https://static001.geekbang.org/account/avatar/00/12/38/4c/5426e2e0.jpg","comment_is_top":false,"comment_ctime":1635815989,"is_pvip":true,"discussion_count":0,"race_medal":1,"score":"1635815989","product_id":100020801,"comment_content":"老师，我有个问题想问一下，表数据几百万几千万的话，经常count总数有点慢，但是很多时候会带不同的条件查询，那么这个count就不能保存起来了吧，因为条件不同count的数量也不一样，这种该怎么优化呀？😔","like_count":0},{"had_liked":false,"id":314585,"user_name":"WithSunny","can_delete":false,"product_type":"c1","uid":2679228,"ip_address":"","ucode":"76AE8C4E5CC5FF","user_header":"https://static001.geekbang.org/account/avatar/00/28/e1/bc/fc0cbd08.jpg","comment_is_top":false,"comment_ctime":1633243047,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1633243047","product_id":100020801,"comment_content":"若在多版本中都存放行数，是否可以保证查询效率呢？不过会浪费一些空间。","like_count":0},{"had_liked":false,"id":310820,"user_name":"Eternal","can_delete":false,"product_type":"c1","uid":1188023,"ip_address":"","ucode":"EA6FE7CC98F740","user_header":"https://static001.geekbang.org/account/avatar/00/12/20/b7/bdb3bcf0.jpg","comment_is_top":false,"comment_ctime":1630922332,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1630922332","product_id":100020801,"comment_content":"如果事务中第一步是计数更新，第二步是插入，如果大量并发请求过来，计数操作的行锁竞争会非常激烈；<br>如果反过来，第一步是插入，第二步是更新计数，插入数据竞争没有那么激烈，且执行的时间也是不一致的，等待插入数据完毕后再更新计数，那么就大大降低了计数操作的行锁竞争，因此效率更高","like_count":0},{"had_liked":false,"id":310638,"user_name":"宙斯","can_delete":false,"product_type":"c1","uid":2041396,"ip_address":"","ucode":"80DF36BAD298AD","user_header":"https://static001.geekbang.org/account/avatar/00/1f/26/34/891dd45b.jpg","comment_is_top":false,"comment_ctime":1630814924,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1630814924","product_id":100020801,"comment_content":"问题：由于事务可以保证中间结果不被别的事务读到，因此修改计数值和插入新记录的顺序是不影响逻辑结果的。但是，从并发系统性能的角度考虑，你觉得在这个事务序列里，应该先插入操作记录，还是应该先更新计数表呢？<br>回答：应该放在后面（即将释放的时候），事务间存在读一致和写当前的情况，在这个过程中，写会加锁，且锁定时间直到事务版本不再使用（通常可以认为是提交以后），而总数字段是一个热更字段，若靠前这种加锁时间明显更长，因此将其放在靠近事务提交或比较接近事务提交。<br>","like_count":0},{"had_liked":false,"id":310107,"user_name":"Geek_24d27b","can_delete":false,"product_type":"c1","uid":1625645,"ip_address":"","ucode":"B52AB6E73F6A0E","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Gf2QrwPGnMzia7UbNZvAqDOHZZXFyibnUUsc7JrLggqUC2Mw0UneEBP9KicP8Dic30O22XrOz1cB3DatE4NxGpbIlA/132","comment_is_top":false,"comment_ctime":1630487134,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1630487134","product_id":100020801,"comment_content":"老师：<br>1，count(*)，innodb引擎是直接将行数返回给server层，还是像count(1)一样，先将数据返回给server层，再由server层给每一行放一个1呢？<br>2，我看mysql官方文档（8.0），说innodb引擎处理count(*)和count(1)的方式是一样的，没有任何性能差异。既然这样，为什么还要区分count(*)和count(1)呢？","like_count":0},{"had_liked":false,"id":309517,"user_name":"Geek_24d27b","can_delete":false,"product_type":"c1","uid":1625645,"ip_address":"","ucode":"B52AB6E73F6A0E","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Gf2QrwPGnMzia7UbNZvAqDOHZZXFyibnUUsc7JrLggqUC2Mw0UneEBP9KicP8Dic30O22XrOz1cB3DatE4NxGpbIlA/132","comment_is_top":false,"comment_ctime":1630208106,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1630208106","product_id":100020801,"comment_content":"innodb引擎，使用count(*),   数据库引擎给server层返回的到底是什么？是所选择的索引中的一条记录，还是？","like_count":0},{"had_liked":false,"id":308274,"user_name":"草莓味的旺仔","can_delete":false,"product_type":"c1","uid":2724523,"ip_address":"","ucode":"4E5D2DA5DF12AC","user_header":"https://static001.geekbang.org/account/avatar/00/29/92/ab/023e2453.jpg","comment_is_top":false,"comment_ctime":1629510640,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1629510640","product_id":100020801,"comment_content":"按照效率排序的话，count(字段)&lt;count(主键 id)&lt;count(1)≈count(*)，所以我建议你，尽量使用 count(*)。<br>------对于这一段，我之前遇到过一个问题，有个表大概四五百万的数据，用count(*)是20多秒，用count（1）是18秒，为什么count(1)比count（*）还快了好几秒呢","like_count":0},{"had_liked":false,"id":306916,"user_name":"杨义","can_delete":false,"product_type":"c1","uid":2017649,"ip_address":"","ucode":"9F3FB567FA1D07","user_header":"https://static001.geekbang.org/account/avatar/00/1e/c9/71/83da8abe.jpg","comment_is_top":false,"comment_ctime":1628774943,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1628774943","product_id":100020801,"comment_content":"老师你好，最近在看8.0的文档，看到这句InnoDB handles and operations in the same way. There is no performance difference. SELECT COUNT(*)SELECT COUNT(1)。和老师讲的有些出入，是版本问题造成的么","like_count":0},{"had_liked":false,"id":305605,"user_name":"张素华","can_delete":false,"product_type":"c1","uid":1944374,"ip_address":"","ucode":"AB2B788B7130C7","user_header":"https://static001.geekbang.org/account/avatar/00/1d/ab/36/106a30d4.jpg","comment_is_top":false,"comment_ctime":1628068165,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1628068165","product_id":100020801,"comment_content":"老师，如果利用一张表用来存所有表的总行数，是不是可以利用这张记录总数的表的mvcc性质，InnoDB 就可以跟 MyISAM 一样，也把数字存起来了。","like_count":0},{"had_liked":false,"id":305495,"user_name":"二凡","can_delete":false,"product_type":"c1","uid":2134167,"ip_address":"","ucode":"97CE9CBE511CBA","user_header":"https://static001.geekbang.org/account/avatar/00/20/90/97/d4bbb6ed.jpg","comment_is_top":false,"comment_ctime":1627996622,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1627996622","product_id":100020801,"comment_content":"更新需要加写锁，插入不需要加锁，所以应该先插入数据，再更新技术，这样拿锁到事务提交锁释放时间变短","like_count":0},{"had_liked":false,"id":304961,"user_name":"Rui","can_delete":false,"product_type":"c1","uid":2705422,"ip_address":"","ucode":"995E914B6DFAE5","user_header":"https://static001.geekbang.org/account/avatar/00/29/48/0e/ea42eaf8.jpg","comment_is_top":false,"comment_ctime":1627718457,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1627718457","product_id":100020801,"comment_content":"老师，我有个问题不是很理解，<br>将count(*)存在innodb里，和我们单独找一张表寸count(*),<br>后者比起前者，除了性能上的优势，还解决了什么问题吗？<br>因为我觉得他们其实都是逻辑一致的，并且因为MVCC,他们都不确定应该返回多少行","like_count":0},{"had_liked":false,"id":301531,"user_name":"somenzz","can_delete":false,"product_type":"c1","uid":1187197,"ip_address":"","ucode":"EA59A170DF8910","user_header":"https://static001.geekbang.org/account/avatar/00/12/1d/7d/368df396.jpg","comment_is_top":false,"comment_ctime":1625730323,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1625730323","product_id":100020801,"comment_content":"先计数加一，再插入记录，因为插入记录会申请并占有行锁或表锁，占有的时间约少越好","like_count":0,"discussions":[{"author":{"id":2843604,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/63/d4/b63373c3.jpg","nickname":"金金","note":"","ucode":"807EDDCDB2E939","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":560314,"discussion_content":"错误的哟，要先插入记录再计数。判断哪句话应该放在后面需要根据引发冲突的概率和时间来判断。计数的表由于是要操作同一行，在有多行插入的时候，就存在需要update同一行的情况，此时肯定是会频繁的在计数的这一行上加锁的。但是insert into除非是间隙锁这种，否则多行是不会有并发的影响的。不知道你怎么得出这个结论的，但凡做个实验就会发现，在两个事务里是可以同时insert into的，这两个事务都不会被阻塞，但是修改同一行其中一个事务就会被阻塞。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649256760,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":296001,"user_name":"油纸伞","can_delete":false,"product_type":"c1","uid":2212143,"ip_address":"","ucode":"C2655B9F8874E2","user_header":"https://static001.geekbang.org/account/avatar/00/21/c1/2f/5c8167aa.jpg","comment_is_top":false,"comment_ctime":1622699490,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1622699490","product_id":100020801,"comment_content":"count(1)怎么计数？<br>对于 count(1) 来说，InnoDB 引擎遍历整张表，但不取值。server 层对于返回的每一行，放一个数字“1”进去，判断是不可能为空的，按行累加<br><br>这句话怎么理解呢？innodb不取值，返回什么？返回遍历的每行数据？数字1放进去哪里？和什么判断？<br>","like_count":0,"discussions":[{"author":{"id":2843604,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/63/d4/b63373c3.jpg","nickname":"金金","note":"","ucode":"807EDDCDB2E939","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":560316,"discussion_content":"你可以认为返回的是一个空的数组，比如命名为table。虽然是空的，但是可以遍历这个数组，并针对每一行进行判断。count在判断的时候会依次取出数组中的值进行判断。像count(1)，server层就会往数组里面放1，这样在判断的时候table[i]判断就是真也就不为空，那就可以执行累加的操作。如果是count(字段)这种，table数组里面本身存放的就是具体的字段值，这样在进行判断的时候首先判断字段本身是不是空，比如age字段就先判断age是不是not null，如果是的话后面的判断就可以不做了直接累加；如果不是的话，还要判断table[i]是不是为空，也就是取出每一行的该字段的值是不是为空。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649257266,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":293598,"user_name":"good boby","can_delete":false,"product_type":"c1","uid":2387358,"ip_address":"","ucode":"1471E2E499412C","user_header":"https://static001.geekbang.org/account/avatar/00/24/6d/9e/6a82a5ea.jpg","comment_is_top":false,"comment_ctime":1621439629,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1621439629","product_id":100020801,"comment_content":"个人看法：<br>1、redis存储count可以达到最终一致性。<br>2、mysql事务将count存储在数据表达到精准一致性。<br><br>对于分布式系统，可能redis方案使用的场景会更多。基于以下2方面考虑。<br>1、如果数据表涉及大量数据的插入，数据库表中存储count会有性能损失。(redis并发量在10W级别，而mysql达到3000已经算很幸运。）<br>2、针对黑客攻击，大量并发性的获取数据表行数，则非常可能导致数据库挂掉。如果r表行数存储在redis缓存，则根据redis相关策略可以避免，例如布隆过滤。<br>3、<br>","like_count":0},{"had_liked":false,"id":292939,"user_name":"大草原","can_delete":false,"product_type":"c1","uid":1301925,"ip_address":"","ucode":"F2FB4DD3E58694","user_header":"https://static001.geekbang.org/account/avatar/00/13/dd/a5/308c23cb.jpg","comment_is_top":false,"comment_ctime":1621088511,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1621088511","product_id":100020801,"comment_content":"老师，innodb引擎不像myisam引擎，直接记录表的总行数，是因为mvcc，每个session得到的总数值不一样。这种场景是因为count(*)是基于session。我们假设count(*)是基于全局的，基于RC隔离级别。不管那个session做了写入，删除，只要没有commit，我就不认为总数需要加1。","like_count":0},{"had_liked":false,"id":290779,"user_name":"lleft","can_delete":false,"product_type":"c1","uid":1970443,"ip_address":"","ucode":"D573EB509455AE","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","comment_is_top":false,"comment_ctime":1619749868,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1619749868","product_id":100020801,"comment_content":"MyISAM存储引擎把表的总行数存储在磁盘上的什么地方？MYD数据文件中还是ibdata1共享表空间里面？","like_count":0},{"had_liked":false,"id":285489,"user_name":"二姐","can_delete":false,"product_type":"c1","uid":2290089,"ip_address":"","ucode":"3451748DE3895F","user_header":"","comment_is_top":false,"comment_ctime":1616837516,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1616837516","product_id":100020801,"comment_content":"基本原理：行锁是事务在需要的时候去获取的，并不是事务开启的时候获取的，同时也不是用完就释放，而是事务commit了之后才能释放。<br>根据如上基本原理，应该是先插入操作记录，再更新计数表。原因：更新计数表会涉及行锁竞争，如果先更新计数表（此时获取行锁），再插入操作记录，然后提交事务，这样的话在“获取行锁”到提交事务之间还有一个“插入操作记录”的操作，这会延长锁的持有时间。所以应该是先插入操作记录，然后更新计数表，这样提高并发度。","like_count":0},{"had_liked":false,"id":284819,"user_name":"红高粱","can_delete":false,"product_type":"c1","uid":2365564,"ip_address":"","ucode":"0DD331C8E01A81","user_header":"https://static001.geekbang.org/account/avatar/00/24/18/7c/91d6dd83.jpg","comment_is_top":false,"comment_ctime":1616485908,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1616485908","product_id":100020801,"comment_content":"讲的不错  看着舒服。","like_count":0},{"had_liked":false,"id":283642,"user_name":"依逝往昔","can_delete":false,"product_type":"c1","uid":1336581,"ip_address":"","ucode":"5C62D22DD939D2","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJM1M1iboffpY17I2eSJjlcyC4ibCJrNeB1EDMjticKospDeTOvZHdheib1tiadEicxGfyInzvJSn7PPqpA/132","comment_is_top":false,"comment_ctime":1615862866,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1615862866","product_id":100020801,"comment_content":"在5.7官方文档12.20.1节中，讲count()函数时，有句话: InnoDB handles SELECT COUNT(*) and SELECT COUNT(1) operations in the same way. There is no performance difference.即count(1)和count(*)没有性能差异，所以count(1)=count(*),不知道文章中说的是不是之前版本？","like_count":0},{"had_liked":false,"id":282981,"user_name":"maybe","can_delete":false,"product_type":"c1","uid":1475528,"ip_address":"","ucode":"93D160F617E750","user_header":"https://static001.geekbang.org/account/avatar/00/16/83/c8/5ce842f6.jpg","comment_is_top":false,"comment_ctime":1615509440,"is_pvip":false,"discussion_count":0,"race_medal":4,"score":"1615509440","product_id":100020801,"comment_content":"在 InnoDB 事务中，行锁是在需要的时候才加上的，但并不是不需要了就立刻释放，而是要等到事务结束时才释放。这个就是两阶段锁协议。<br>知道了这个设定，对我们使用事务有什么帮助呢？那就是，如果你的事务中需要锁多个行，要把最可能造成锁冲突、最可能影响并发度的锁尽量往后放。<br><br>按照这个思路，先插入后更新","like_count":0},{"had_liked":false,"id":281858,"user_name":"Yayu","can_delete":false,"product_type":"c1","uid":1058015,"ip_address":"","ucode":"5E7842458D8229","user_header":"https://static001.geekbang.org/account/avatar/00/10/24/df/645f8087.jpg","comment_is_top":false,"comment_ctime":1614928539,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1614928539","product_id":100020801,"comment_content":"各位会在什么情况下使用不带 where 条件查询表的总行数？我平日接触的需要计算行数的大多需要携带 where 条件，请问这种情况又改如何改进 count(*) 的性能呢？","like_count":0},{"had_liked":false,"id":281652,"user_name":"zhangyi","can_delete":false,"product_type":"c1","uid":1507024,"ip_address":"","ucode":"0C4CAE9DA878F3","user_header":"https://static001.geekbang.org/account/avatar/00/16/fe/d0/e80e4a7e.jpg","comment_is_top":false,"comment_ctime":1614840427,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1614840427","product_id":100020801,"comment_content":"带筛选条件的count值,如何记录呢","like_count":0},{"had_liked":false,"id":279598,"user_name":"sotondolphin","can_delete":false,"product_type":"c1","uid":1307088,"ip_address":"","ucode":"42198CE9B201FD","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/QZBHia4nXtspEaRibpmMIMVcDA2HHkNypfvVJ2IllQC3FeFCt7f9iaHW7z5yQ4lcB79ibJwia6tNtpuFroufntMhc2g/132","comment_is_top":false,"comment_ctime":1613840203,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1613840203","product_id":100020801,"comment_content":"当然是先插入操作记录再更新计数表啦，因为如果插入操作记录失败的话，插入计数表就变成多余和错误的操作","like_count":0},{"had_liked":false,"id":278076,"user_name":"超级蛋蛋饭","can_delete":false,"product_type":"c1","uid":1249616,"ip_address":"","ucode":"AD2BECE789B365","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/wiaQmkQdIh84RibSLrDkIA3HtibAR4IibpnP3VEmiaLzvpiaibXJQEb2LLUrCD4dM7DjvOFD65IbdZm2Mn68O71FxiaAow/132","comment_is_top":false,"comment_ctime":1612751302,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1612751302","product_id":100020801,"comment_content":"图4更新c表不会加行锁吗？","like_count":0},{"had_liked":false,"id":277256,"user_name":"雾林","can_delete":false,"product_type":"c1","uid":2312368,"ip_address":"","ucode":"1DD4B1E1676388","user_header":"https://static001.geekbang.org/account/avatar/00/23/48/b0/49a591c2.jpg","comment_is_top":false,"comment_ctime":1612334815,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1612334815","product_id":100020801,"comment_content":"看完文章后我还是不知道如何高效解决count查询慢的问题啊，建一个innodb表里面用一个字段单独存表的行数?是这么解决吗，innodb表带条件查询行数还是很慢的","like_count":0},{"had_liked":false,"id":276788,"user_name":"夏天出走远飞","can_delete":false,"product_type":"c1","uid":2427711,"ip_address":"","ucode":"3D830BB7346E45","user_header":"https://static001.geekbang.org/account/avatar/00/25/0b/3f/0d96b3b3.jpg","comment_is_top":false,"comment_ctime":1612117998,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1612117998","product_id":100020801,"comment_content":"在数据库保存计数，添加数据时加1 ，删除时减1，在触发器数据添加&#47;删除时实现可以吗？这样更新是否有触发事务？谢谢！","like_count":0},{"had_liked":false,"id":273892,"user_name":"龙晓","can_delete":false,"product_type":"c1","uid":1043325,"ip_address":"","ucode":"FAF34F1C65D103","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/c9xpiakQ3OC1AlfCeW03lLnnb7mj5v35Hib8YDs66zpnVib2n2qFichFmFp2Ec4QDPR0dKh38MkBBLyD3bE4NiaanZQ/132","comment_is_top":false,"comment_ctime":1610707707,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1610707707","product_id":100020801,"comment_content":"如果字段为null的行会包含在索引中吗，oracle是不包含的，从count(*)可以从任意二级索引计数来，mysql中应该是包含的？","like_count":0},{"had_liked":false,"id":268291,"user_name":"为梦终醒","can_delete":false,"product_type":"c1","uid":2008722,"ip_address":"","ucode":"9784EB870F413B","user_header":"","comment_is_top":false,"comment_ctime":1608126662,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1608126662","product_id":100020801,"comment_content":"redis也是支持事务的吧，redis开启事务不也一样能解决问题吗？比较疑问","like_count":0},{"had_liked":false,"id":267239,"user_name":"sayiamfun","can_delete":false,"product_type":"c1","uid":1617528,"ip_address":"","ucode":"10AD51C9447498","user_header":"https://static001.geekbang.org/account/avatar/00/18/ae/78/b4f7ef7d.jpg","comment_is_top":false,"comment_ctime":1607656848,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1607656848","product_id":100020801,"comment_content":"老师你好，我现在有一张表，表中数据32W行左右，为什么<br>count(*) 和count（1）的速度为2秒多，但count(status)的速度反而更快呢只需要零点几秒，explain结果是一模一样的，都显示用了status_index索引<br>mysql 版本是 8<br>建表语句是<br>create table test.user<br>(<br> id bigint auto_increment<br>  primary key,<br> name varchar(25) not null,<br> email varchar(200) not null,<br> age int not null,<br> address varchar(255) null,<br> head_img varchar(255) null,<br> company varchar(200) null,<br> token varchar(255) not null,<br> password varchar(200) not null,<br> create_time datetime default CURRENT_TIMESTAMP null,<br> update_time datetime default CURRENT_TIMESTAMP null on update CURRENT_TIMESTAMP,<br> status tinyint default 0 null<br>);<br><br>create index age_index<br> on test.user (age);<br><br>create index id_index<br> on test.user (age);<br><br>create index status_index<br> on test.user (status);<br><br>希望老师帮忙解答一下","like_count":0,"discussions":[{"author":{"id":1171004,"avatar":"https://static001.geekbang.org/account/avatar/00/11/de/3c/96c1bc62.jpg","nickname":"卢建文","note":"","ucode":"900A0CE253F2BF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375303,"discussion_content":"因为缓冲池的原因吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621566918,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":265920,"user_name":"李抗","can_delete":false,"product_type":"c1","uid":1473540,"ip_address":"","ucode":"C2DD63CA346839","user_header":"https://static001.geekbang.org/account/avatar/00/16/7c/04/53e75bc7.jpg","comment_is_top":false,"comment_ctime":1607068588,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1607068588","product_id":100020801,"comment_content":"想请问下老师，如果某个二级索引，默认可以为null，那么在该二级索引树中，值为null的这一项是存储在哪里的？ 叶子节点的最左边？ ","like_count":0},{"had_liked":false,"id":265081,"user_name":"nocturne","can_delete":false,"product_type":"c1","uid":1207810,"ip_address":"","ucode":"7A008066F2D4CB","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/gOLHDzIiaAeOF96qNnmK1CMwibsicsRucsyUknkv9lw2r0amibHynTiaTtQRuPbtk6vmiaBRzpm8SbiclDMZFH6JibyjeA/132","comment_is_top":false,"comment_ctime":1606754605,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1606754605","product_id":100020801,"comment_content":"首先说结论，应该首先更新计数，因为innodb是行锁，如果首先更新数据，则该记录就会锁的时间=该记录锁的时间+更新计数锁的时间，也就是说锁的时间加长。","like_count":0},{"had_liked":false,"id":264953,"user_name":"liujinmai","can_delete":false,"product_type":"c1","uid":1204927,"ip_address":"","ucode":"E7CEAB726ABB44","user_header":"https://static001.geekbang.org/account/avatar/00/12/62/bf/ca41b5af.jpg","comment_is_top":false,"comment_ctime":1606719987,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1606719987","product_id":100020801,"comment_content":"老师   我觉得谁前谁后并不能影响最终执行时间啊   因为最终都要涉及到竞争锁","like_count":0},{"had_liked":false,"id":264836,"user_name":"Geek_2aae91","can_delete":false,"product_type":"c1","uid":2344740,"ip_address":"","ucode":"999EC3BCFBF5A2","user_header":"","comment_is_top":false,"comment_ctime":1606665610,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1606665610","product_id":100020801,"comment_content":"如果扫描二级索引count，一般会Using index，那如何通过MVCC避免幻读？","like_count":0},{"had_liked":false,"id":256851,"user_name":"陈狄","can_delete":false,"product_type":"c1","uid":2011954,"ip_address":"","ucode":"456F00EB2EB43D","user_header":"https://static001.geekbang.org/account/avatar/00/1e/b3/32/0ee78a1a.jpg","comment_is_top":false,"comment_ctime":1603766233,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1603766233","product_id":100020801,"comment_content":"总结：因为有mvcc，count(*)统计行数需要一行一行按照当前事务的可以看到的行数来统计，所以行数没办法直接保存，需要动态获取。<br>count(字段)会有一个字段解析，判断非空的过程，所以比count(*)要慢。<br>课后问题：应该先插入新纪录，修改计数值是修改同一行记录，会有一个行锁竞争","like_count":0},{"had_liked":false,"id":255125,"user_name":"dbtiger","can_delete":false,"product_type":"c1","uid":1324202,"ip_address":"","ucode":"05E8447593318C","user_header":"https://static001.geekbang.org/account/avatar/00/14/34/aa/431de942.jpg","comment_is_top":false,"comment_ctime":1603270245,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1603270245","product_id":100020801,"comment_content":"redis没用过，还需要学习学习redis的机制","like_count":0,"discussions":[{"author":{"id":2237677,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLg04lnicnUNWVmohBVoWiaKPpuYu8j0CHVIjjurfO3YcJqicHZBMYFqjoEpiaa3jrNmRzyzXiaPPt29cA/132","nickname":"玄真","note":"","ucode":"D21A7096AFB816","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":326542,"discussion_content":"赵乐？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605614766,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":253528,"user_name":"人间乐园","can_delete":false,"product_type":"c1","uid":1350559,"ip_address":"","ucode":"4A203AB47FCF3C","user_header":"https://static001.geekbang.org/account/avatar/00/14/9b/9f/2cbc2a4f.jpg","comment_is_top":false,"comment_ctime":1602765081,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1602765081","product_id":100020801,"comment_content":"两阶段锁协议，先插入数据可以减少更新计数的锁时间。","like_count":0},{"had_liked":false,"id":252556,"user_name":" 尿布","can_delete":false,"product_type":"c1","uid":1476323,"ip_address":"","ucode":"D1C8BDA7540962","user_header":"https://static001.geekbang.org/account/avatar/00/16/86/e3/a31f6869.jpg","comment_is_top":false,"comment_ctime":1602381617,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1602381617","product_id":100020801,"comment_content":"获益匪浅啊","like_count":0},{"had_liked":false,"id":247980,"user_name":"Geek_04168","can_delete":false,"product_type":"c1","uid":2112008,"ip_address":"","ucode":"F125ADD877952E","user_header":"","comment_is_top":false,"comment_ctime":1599966379,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1599966379","product_id":100020801,"comment_content":"请问既然count(*)是遍历索引不取值，那索引的数据量是如何影响该语句的性能的呢？","like_count":0,"discussions":[{"author":{"id":1303322,"avatar":"https://static001.geekbang.org/account/avatar/00/13/e3/1a/061e77b6.jpg","nickname":"亢星东","note":"","ucode":"5E4063E83B2BB9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":319095,"discussion_content":"有主键索引 普通索引 不同索引树大小不一样 ，小的肯定耗时少","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603941321,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":246172,"user_name":"Magic","can_delete":false,"product_type":"c1","uid":1272047,"ip_address":"","ucode":"FD9CEDAA419EB0","user_header":"https://static001.geekbang.org/account/avatar/00/13/68/ef/6264ca3d.jpg","comment_is_top":false,"comment_ctime":1599198432,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1599198432","product_id":100020801,"comment_content":"应该先更新计数表再插入数据。因为计数表更新是热点行，应尽量减少锁持有时间","like_count":0},{"had_liked":false,"id":237932,"user_name":"坏淡一个","can_delete":false,"product_type":"c1","uid":1118181,"ip_address":"","ucode":"D9C39F4133D9D6","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eplMzkLgvebhLujCZI0DZAWS7MQGvYGHb4yeoDHdITVWpbSicvoVKw0dISm9ib3vYU7BqxrmuTV666g/132","comment_is_top":false,"comment_ctime":1596008851,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1596008851","product_id":100020801,"comment_content":"报表分页，需要展示总条数，总条数随查询条件变化而变化，数据量大的时候count(*)，效率就很低，这种有什么好办法吗？","like_count":0},{"had_liked":false,"id":236743,"user_name":"hahahhh","can_delete":false,"product_type":"c1","uid":1392326,"ip_address":"","ucode":"ED94DDF526F94D","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/7KvTibLByic8Eht03jsera25gTIoJEKnajulAVyRibaFic34rNjCSd3DBpjwWInJ72gBMuo1RNNoFdiay0PUSy8971Q/132","comment_is_top":false,"comment_ctime":1595515163,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1595515163","product_id":100020801,"comment_content":"先插入操作记录，再更新计数，因为更新计数，需要竞争锁，放在后面，可以持有锁的时间短一点","like_count":0},{"had_liked":false,"id":234902,"user_name":"周","can_delete":false,"product_type":"c1","uid":1269903,"ip_address":"","ucode":"EE475D1CFC46D6","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/qzricN4j5oafQ5MB6pd6uRjhrO05jibuibthBvgFkeQFcedFqKyOXGNj0eNw5KL8kozV1Yty7SWek8hIoyeviaSmXw/132","comment_is_top":false,"comment_ctime":1594823227,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1594823227","product_id":100020801,"comment_content":"老师，您好， 最近才购买了您的课程，看到这一章节的时候，有个另外的疑问， 有一张日志表，查询的条件有用户名、日志内容，这样的分页并统计总数，还有什么方式优化？","like_count":0,"discussions":[{"author":{"id":1127785,"avatar":"https://static001.geekbang.org/account/avatar/00/11/35/69/8cbab11a.jpg","nickname":"HJW","note":"","ucode":"794E01C5F2B395","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":376573,"discussion_content":"我也遇到了，加了条件就不能直接使用redis存的总数了。你那边解决了吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1622197581,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":234539,"user_name":"Garwen","can_delete":false,"product_type":"c1","uid":1045062,"ip_address":"","ucode":"C76346E1734AB8","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f2/46/09c457eb.jpg","comment_is_top":false,"comment_ctime":1594715607,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1594715607","product_id":100020801,"comment_content":"老师老师，对于count（字段）的这两句话，我读了很久也没理解，总觉的他们的意思是一样的，您能再多说明一下吗，谢谢。<br>如果这个“字段”是定义为 not null 的话，一行行地从记录里面读出这个字段，判断不能为 null，按行累加；<br>如果这个“字段”定义允许为 null，那么执行的时候，判断到有可能是 null，还要把值取出来再判断一下，不是 null 才累加。","like_count":0},{"had_liked":false,"id":233979,"user_name":"王瑞强","can_delete":false,"product_type":"c1","uid":1829090,"ip_address":"","ucode":"DEE4EB5E23433F","user_header":"https://static001.geekbang.org/account/avatar/00/1b/e8/e2/2bcaef68.jpg","comment_is_top":false,"comment_ctime":1594543712,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1594543712","product_id":100020801,"comment_content":"普通索引字段如果可以为空，count（id）应该不会走普通索引吧。进一步问一下，字段为null在索引树中是如何存储的","like_count":0},{"had_liked":false,"id":232268,"user_name":"Wch","can_delete":false,"product_type":"c1","uid":1309374,"ip_address":"","ucode":"AC876A96389B65","user_header":"https://static001.geekbang.org/account/avatar/00/13/fa/be/23b540ed.jpg","comment_is_top":false,"comment_ctime":1593939039,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1593939039","product_id":100020801,"comment_content":"redis维护的计数器和近100条记录可以使用pipeline实现原子更新，从而保证其他会话的读一致了吗？","like_count":0},{"had_liked":false,"id":227407,"user_name":"蛤蟆先生","can_delete":false,"product_type":"c1","uid":1125703,"ip_address":"","ucode":"8353492D68DBBF","user_header":"https://static001.geekbang.org/account/avatar/00/11/2d/47/7c3baa15.jpg","comment_is_top":false,"comment_ctime":1592374647,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1592374647","product_id":100020801,"comment_content":"有个问题请教下老师，目前系统里有一个查询接口，底层 SQL 是: SELECT count(*) from A inner join  B on A.id = B.id where  A.deleted = 0  and B.deleted = 0。目前的情况是这样的，测试环境有 40W 左右数据，查询时间在 3 s 左右，生产环境 400W 数据，查询耗时到 18 s 左右，但是感觉没有什么地方可以优化的啊（是我水平太低了...）","like_count":0},{"had_liked":false,"id":227095,"user_name":"小袁","can_delete":false,"product_type":"c1","uid":1811495,"ip_address":"","ucode":"3F5D8721F577D9","user_header":"https://static001.geekbang.org/account/avatar/00/1b/a4/27/15e75982.jpg","comment_is_top":false,"comment_ctime":1592284372,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1592284372","product_id":100020801,"comment_content":"如果count(*)要取一行，再查可见性视图的话。为啥索引能满足用户的select需求，因为一样数据有多个版本，索引树怎么确定要用什么key来正确回表？","like_count":0},{"had_liked":false,"id":226095,"user_name":"图灵机","can_delete":false,"product_type":"c1","uid":2034632,"ip_address":"","ucode":"EB02DB653AD591","user_header":"https://static001.geekbang.org/account/avatar/00/1f/0b/c8/15f055d3.jpg","comment_is_top":false,"comment_ctime":1591949722,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1591949722","product_id":100020801,"comment_content":"全表的count(*)可以通过增加表记录优化，假如有where 多条件的count(*)该怎么优化啊，如果范围内的数据量特别大，这好像就没办法了呀","like_count":0},{"had_liked":false,"id":226089,"user_name":"图灵机","can_delete":false,"product_type":"c1","uid":2034632,"ip_address":"","ucode":"EB02DB653AD591","user_header":"https://static001.geekbang.org/account/avatar/00/1f/0b/c8/15f055d3.jpg","comment_is_top":false,"comment_ctime":1591948887,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1591948887","product_id":100020801,"comment_content":"激动，终于看到count(*)讲解了","like_count":0},{"had_liked":false,"id":223341,"user_name":"Geek_55e386","can_delete":false,"product_type":"c1","uid":1795793,"ip_address":"","ucode":"5A727F1323C2D0","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/zxkns28cIAUZIt3WjDb8G26qiccT84d9GMr9ZpbYR60TU1ibqSj9NoYVHlJvGF1kOltkqNDmEfJCqPuYVkue3WHg/132","comment_is_top":false,"comment_ctime":1591067359,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1591067359","product_id":100020801,"comment_content":"1、在更新数据的时候开启事务，先插入数据库，然后在写入redis；在一个事务里面；<br>这时候是不是可以保证 读的数据一致了","like_count":0},{"had_liked":false,"id":223291,"user_name":"15216769624","can_delete":false,"product_type":"c1","uid":1344208,"ip_address":"","ucode":"C5D6F13F02AC93","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoB0vTIoGqianmDuY7EDHvmmjT96phwxblianV3q0iaib9qtaG9ia8ibTJaWgsQR6WoA0c6xKZicgWrr8LYA/132","comment_is_top":false,"comment_ctime":1591057033,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1591057033","product_id":100020801,"comment_content":"你知道的，InnoDB 是索引组织表，主键索引树的叶子节点是数据，而普通索引树的叶子节点是主键值。所以，普通索引树比主键索引树小很多。对于 count(*) 这样的操作，遍历哪个索引树得到的结果逻辑上都是一样的。因此，MySQL 优化器会找到最小的那棵树来遍历。在保证逻辑正确的前提下，尽量减少扫描的数据量，是数据库系统设计的通用法则之一。<br><br>老师，关于上面那句对于count(*)这样的操作，遍历哪个索引树得到的结果都是一样的，因此会选用最小树来遍历，我有个疑问，我们的事务隔离级别是rr，而二级索引里面并没有保存数据的多版本信息，这个只在主键里面才有，所以它需要回表，那是不是意味着其实直接扫描主键才是最快的，而不是其他二级索引？","like_count":0,"discussions":[{"author":{"id":1209939,"avatar":"https://static001.geekbang.org/account/avatar/00/12/76/53/21d62a23.jpg","nickname":"鲁·本","note":"","ucode":"F1DEB30C21B48E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576969,"discussion_content":"同问, 希望老师帮忙解答下!!!!!","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655870288,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":214648,"user_name":"林炳强","can_delete":false,"product_type":"c1","uid":1033021,"ip_address":"","ucode":"B1DA2D7D4AC177","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c3/3d/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1588776596,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1588776596","product_id":100020801,"comment_content":"应该是先插入记录，然后再更新计数表，理由是之前文章里面说过的，要把有资源竞争的语句放到最后。","like_count":0},{"had_liked":false,"id":214210,"user_name":"星期八","can_delete":false,"product_type":"c1","uid":1440429,"ip_address":"","ucode":"D8C66E7F61B0D1","user_header":"https://static001.geekbang.org/account/avatar/00/15/fa/ad/3fa02ac7.jpg","comment_is_top":false,"comment_ctime":1588676767,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1588676767","product_id":100020801,"comment_content":"count 实时数据一致问题<br>1、单表count(*),事务级别是可重复读级别，session数据不一致<br>2、新加一个张表统计tableName和对应的count，事务级别是read commit，可以保证session数据一致<br>3、使用缓存，但是必须保持两个事务级别是read commit，通过业务来保障session数据一致","like_count":0},{"had_liked":false,"id":214206,"user_name":"星期八","can_delete":false,"product_type":"c1","uid":1440429,"ip_address":"","ucode":"D8C66E7F61B0D1","user_header":"https://static001.geekbang.org/account/avatar/00/15/fa/ad/3fa02ac7.jpg","comment_is_top":false,"comment_ctime":1588676522,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1588676522","product_id":100020801,"comment_content":"count的数据一致性<br>1、单表隔离级别是rr，所以不能做到多个session一致<br>2、如果单独一个张表记录tablename和count，这样可以使用read commit控制数据一致性，从而达到大数据量的实时数据一致<br>3、缓存一致<br>如果缓存事务和数据库提交事务能做到read commit 级别，也是可以做到实时数据的一致性的。@","like_count":0},{"had_liked":false,"id":212874,"user_name":"dream","can_delete":false,"product_type":"c1","uid":1117793,"ip_address":"","ucode":"65B33D32FA8BE9","user_header":"https://static001.geekbang.org/account/avatar/00/11/0e/61/ae68f8eb.jpg","comment_is_top":false,"comment_ctime":1588230109,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1588230109","product_id":100020801,"comment_content":"老师在文中提到 “但是 count(*) 是例外，并不会把全部字段取出来，而是专门做了优化，不取值。”    但是mysql是具体怎么优化 count(*) 的呢？","like_count":0},{"had_liked":false,"id":212447,"user_name":"达达队长","can_delete":false,"product_type":"c1","uid":1117597,"ip_address":"","ucode":"1C3F2E4F6B7637","user_header":"https://static001.geekbang.org/account/avatar/00/11/0d/9d/58d09086.jpg","comment_is_top":false,"comment_ctime":1588125298,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1588125298","product_id":100020801,"comment_content":"老师求回答啊，上结课说到删除的记录只是发一个标记，那么count（id）的时候应该回去判断删除了没，但是二级索引没有标记删除啊，那么如果count（id）选择了二级索引，他是怎么保证没有把标记为删除的数据取出来呢","like_count":0},{"had_liked":false,"id":211421,"user_name":"路人佳","can_delete":false,"product_type":"c1","uid":1449346,"ip_address":"","ucode":"2E8E7B8A79B67E","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIFvkUVWscC7rNIIDy79zKPafoYa5Myn3Am8M42Be6kHhCOsup58T88yl9Mm7jPlxaJKTYYP3tMiaQ/132","comment_is_top":false,"comment_ctime":1587960874,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1587960874","product_id":100020801,"comment_content":"老师我这个语句，我建了create_date和person_count 的联合索引，他只用到了create_date部分 <br>select a.* from loan_sys_subgroup_record a inner join  (select id from loan_sys_subgroup_record where `algorithm` = 2 and person_count&gt;10 and create_date &gt; &#39;2020-03-01&#39; and create_date &lt;&#39;2020-03-18&#39; order by DATE_FORMAT(create_date,&#39;yyyy-MM-dd&#39;) desc,person_count desc  limit 1001,10 ) b on a.id = b.id <br>执行计划EXTRA显示where index filesort","like_count":0},{"had_liked":false,"id":211374,"user_name":"陈年风褛","can_delete":false,"product_type":"c1","uid":1967573,"ip_address":"","ucode":"D806A6F06D8CD1","user_header":"https://static001.geekbang.org/account/avatar/00/1e/05/d5/ee6f94f5.jpg","comment_is_top":false,"comment_ctime":1587954325,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1587954325","product_id":100020801,"comment_content":"有两个问题请教一下:<br>1) 我认为, Redis计数+MySQL插入数据表记录的方案中,可参考事务在过程中添加一个两阶段提交的操作保证Redis和MySQL的数据一致性,具体过程如下: 先更新Redis计数,并标记为未提交状态,然后再插入MySQL表数据,插入成功,更新Redis计数状态为commit,若插入表失败,则回滚Redis计数; 但有个问题,高并发情况下,无法解决高并发请求导致的数据不一致的问题; 高并发情况下,我目前能想到的是借助锁&#47;分布式锁(如借助zookeeper等), 希望老师可以讲解下高并发下数据不一致的保证机制和原理,谢谢啦<br><br>2) 第二个问题和上面第一个问题的后半部分类似,也是高于并发情况下的解决方案,具体问题如下:<br>计数表tb_count,记录数据库所有表的总数,每张表占用一行,高并发时,上述的解决方案中,如何保证事务中的一致性,因为多个事务同时update操作表tb_user行数这一行数据,且update是当前读,是否会导致更新后tb_user是错误的;上述情况如何解决呢,是否只能借助锁锁保证并发下的数据一致性<br><br>请赐教","like_count":0},{"had_liked":false,"id":203395,"user_name":"否极泰来","can_delete":false,"product_type":"c1","uid":1439355,"ip_address":"","ucode":"C249173266251A","user_header":"https://static001.geekbang.org/account/avatar/00/15/f6/7b/b6abcbbe.jpg","comment_is_top":false,"comment_ctime":1586183870,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1586183870","product_id":100020801,"comment_content":"先插入记录在更新吧，因为之前说过更新数据会加行锁，当事务提交或者回滚的时候才会释放锁，update放到最后比较合适","like_count":0},{"had_liked":false,"id":198953,"user_name":"王立","can_delete":false,"product_type":"c1","uid":1904760,"ip_address":"","ucode":"44A4EF95403731","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKWiaZb7a2JAcDQ0kYYy2knpK8sTqicvG2Ukb1HdeE0fMMSINiagU401uibLicbIXVwRG7coDyDTOuYCSA/132","comment_is_top":false,"comment_ctime":1585474312,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1585474312","product_id":100020801,"comment_content":"先插入，再更新计数","like_count":0},{"had_liked":false,"id":198830,"user_name":"Ryan","can_delete":false,"product_type":"c1","uid":1667987,"ip_address":"","ucode":"95BBBEE5B23878","user_header":"https://static001.geekbang.org/account/avatar/00/19/73/93/0a3a1e5b.jpg","comment_is_top":false,"comment_ctime":1585469898,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1585469898","product_id":100020801,"comment_content":"按照效率排序的话，count(字段)&lt;count( 主键id)&lt;count(1)~~count(*)<br>之前一直以为 count(1)效率最高","like_count":0},{"had_liked":false,"id":194273,"user_name":"喻茂","can_delete":false,"product_type":"c1","uid":1318661,"ip_address":"","ucode":"C8BD8086A17365","user_header":"https://static001.geekbang.org/account/avatar/00/14/1f/05/8a06692e.jpg","comment_is_top":false,"comment_ctime":1585044582,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1585044582","product_id":100020801,"comment_content":"先插入记录，再更新计数表。因为计数表多个事务之间会加行锁","like_count":0},{"had_liked":false,"id":189532,"user_name":"转角遇到橙","can_delete":false,"product_type":"c1","uid":1920727,"ip_address":"","ucode":"08C303C72E0959","user_header":"https://static001.geekbang.org/account/avatar/00/1d/4e/d7/c6152ede.jpg","comment_is_top":false,"comment_ctime":1584525843,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1584525843","product_id":100020801,"comment_content":"那么问题来了，如果我是针对一个数据库带条件查询的时候，count星问题也是这么解决么，求大师指点","like_count":0},{"had_liked":false,"id":187020,"user_name":"编程界的小学生","can_delete":false,"product_type":"c1","uid":1593289,"ip_address":"","ucode":"4A5BE9A5E877FA","user_header":"https://static001.geekbang.org/account/avatar/00/18/4f/c9/9f51fd27.jpg","comment_is_top":false,"comment_ctime":1583992550,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1583992550","product_id":100020801,"comment_content":"这个COUNT(*)的优化区分版本吗？","like_count":0},{"had_liked":false,"id":185232,"user_name":"WulalaOlala","can_delete":false,"product_type":"c1","uid":1532794,"ip_address":"","ucode":"39E2501F42D052","user_header":"https://static001.geekbang.org/account/avatar/00/17/63/7a/e91c3771.jpg","comment_is_top":false,"comment_ctime":1583540860,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1583540860","product_id":100020801,"comment_content":"新增一列也会alter table，会触发表重建么？","like_count":0},{"had_liked":false,"id":183939,"user_name":"乔丹","can_delete":false,"product_type":"c1","uid":1217413,"ip_address":"","ucode":"D832A9F97A0C7E","user_header":"https://static001.geekbang.org/account/avatar/00/12/93/85/f5d9474c.jpg","comment_is_top":false,"comment_ctime":1583164908,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1583164908","product_id":100020801,"comment_content":"有个疑问，就是mysql数据库删除一条数据时，主键索引会删除掉这条数据吗？","like_count":0},{"had_liked":false,"id":181993,"user_name":"ipofss","can_delete":false,"product_type":"c1","uid":1018620,"ip_address":"","ucode":"DE3061C9259F9E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8a/fc/d1dd57dd.jpg","comment_is_top":false,"comment_ctime":1582689020,"is_pvip":false,"replies":[{"id":"70466","content":"官方版本的5.6&#47;5.7版本，加列都是要重建主键索引的。<br>加普通索引不用","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1582693642,"ip_address":"","comment_id":181993,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1582689020","product_id":100020801,"comment_content":"老师，我问一个题外话：对于一个MySQL的表结构的修改，需要重建主键索引吗？<br>我平时用Navicat，导出的sql语句，会自动带上drop主键索引，然后又add主键索引，然后结合你前面讲的，我认为对于新加的列，如果不重建索引，那么对于旧数据，主键索引树上的叶子节点，就不会有新加的列的数据，所以我认为应该是需要重建主键索引的。<br>我的理解对吗？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":485191,"discussion_content":"官方版本的5.6/5.7版本，加列都是要重建主键索引的。\n加普通索引不用","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582693642,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":176739,"user_name":"torres","can_delete":false,"product_type":"c1","uid":1108761,"ip_address":"","ucode":"34DABCFC7B74EA","user_header":"https://static001.geekbang.org/account/avatar/00/10/eb/19/76b0b98c.jpg","comment_is_top":false,"comment_ctime":1581152685,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1581152685","product_id":100020801,"comment_content":"茅塞顿开","like_count":0},{"had_liked":false,"id":176516,"user_name":"律飛","can_delete":false,"product_type":"c1","uid":1462608,"ip_address":"","ucode":"65394E437AD2DF","user_header":"https://static001.geekbang.org/account/avatar/00/16/51/50/f5f2a121.jpg","comment_is_top":false,"comment_ctime":1581079193,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1581079193","product_id":100020801,"comment_content":"1：按照效率排序的话，count(字段)&lt;count(主键 id)&lt;count(1)≈count(*)，所以老师建议，尽量使用 count(*)。<br>2：count(*)这么慢，怎么办？<br>要么忍，要么自己动手记录，如果自己记录的话，老师建议使用数据库来弄，感觉使用数据库自己弄的思路可以建议MySQL实现一下？<br>3：count()的语义是啥？<br>首先，不同的存储引擎实现方式不同<br>MyISAM 引擎把一个表的总行数存在了磁盘上，因此执行 count(*) 的时候会直接返回这个数，效率很高；<br>而 InnoDB 引擎就麻烦了，它执行 count(*) 的时候，需要把数据一行一行地从引擎里面读出来，然后累积计数。<br>以下针对innodb来说<br>count() 是一个聚合函数，对于返回的结果集，一行行地判断，如果 count 函数的参数不是 NULL，累计值就加 1，否则不加，最后返回累计值。<br>4：count(字段)怎么计数？<br>如果这个“字段”是定义为 not null 的话，一行行地从记录里面读出这个字段，判断不能为 null，按行累加；<br>如果这个“字段”定义允许为 null，那么执行的时候，判断到有可能是 null，还要把值取出来再判断一下，不是 null 才累加。<br>从引擎返回的字段会涉及到解析数据行，以及拷贝字段值的操作。<br>5：count(主键 id)怎么计数？<br>对于 count(主键 id) 来说，InnoDB 引擎会遍历整张表，把每一行的 id 值都取出来，返回给 server 层。server 层拿到 id 后，判断是不可能为空的，就按行累加。从引擎返回的 主键id 会涉及到解析数据行，以及拷贝字段值的操作。<br>6：count(1)怎么计数？<br>对于 count(1) 来说，InnoDB 引擎遍历整张表，但不取值。server 层对于返回的每一行，放一个数字“1”进去，判断是不可能为空的，按行累加。<br>7：count(*)怎么计数？<br>对于count(*)来说，并不会把全部字段取出来，而是专门做了优化，不取值。count(*) 肯定不是 null，按行累加。<br>8：分析这些count()的原则如下：<br>server 层要什么就给什么；<br>InnoDB 只给必要的值；<br>现在的优化器只优化了 count(*) 的语义为“取行数”，其他“显而易见”的优化并没有做。","like_count":0},{"had_liked":false,"id":171989,"user_name":"Zhaoyang","can_delete":false,"product_type":"c1","uid":1037190,"ip_address":"","ucode":"131D83AC2566D2","user_header":"https://static001.geekbang.org/account/avatar/00/0f/d3/86/b5d72c87.jpg","comment_is_top":false,"comment_ctime":1579063314,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1579063314","product_id":100020801,"comment_content":"我觉得是应该先写redis计数吧。否则是否会出现超卖的情况呢？？","like_count":0,"discussions":[{"author":{"id":1303322,"avatar":"https://static001.geekbang.org/account/avatar/00/13/e3/1a/061e77b6.jpg","nickname":"亢星东","note":"","ucode":"5E4063E83B2BB9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":319098,"discussion_content":"可以预留一些货物","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1603941526,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":158084,"discussion_content":"真实业务其实既不能超卖，也不能有人想买，但卖完了，但实际上还有剩余。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1580549273,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":171988,"user_name":"Zhaoyang","can_delete":false,"product_type":"c1","uid":1037190,"ip_address":"","ucode":"131D83AC2566D2","user_header":"https://static001.geekbang.org/account/avatar/00/0f/d3/86/b5d72c87.jpg","comment_is_top":false,"comment_ctime":1579062958,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1579062958","product_id":100020801,"comment_content":"先计数，比较好吧","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":158088,"discussion_content":"不好","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580549506,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":169544,"user_name":"zmysang","can_delete":false,"product_type":"c1","uid":1642663,"ip_address":"","ucode":"8A98057E7819DD","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/tjhOILHBAmlx6YiaTZJzqzxn1uyB6XpdvGDIZhBn127TYEcoLLzxRiaKvtVd3HllQqPx7cqf2YmibyBUgGGGJPDkw/132","comment_is_top":false,"comment_ctime":1578376386,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1578376386","product_id":100020801,"comment_content":"对于 count(字段) 来说：如果这个“字段”是定义为 not null 的话，一行行地从记录里面读出这个字段，判断不能为 null，按行累加；如果这个“字段”定义允许为 null，那么执行的时候，判断到有可能是 null，还要把值取出来再判断一下，不是 null 才累加。<br>关于这一段，请问一下，如果字段时定义为非空，这里判断非空的操作是server做的吗？如果字段定义允许空时，这时是InnoDB自己会做一次非空的判断了，再将非空的数据提交到server（InnoDB只给必要的值），然后server再做一次非空判断吗？","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":158089,"discussion_content":"判断非空是在server层做的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580549549,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":167798,"user_name":"小码渣","can_delete":false,"product_type":"c1","uid":1723655,"ip_address":"","ucode":"8432409D9616D1","user_header":"https://static001.geekbang.org/account/avatar/00/1a/4d/07/7d331b04.jpg","comment_is_top":false,"comment_ctime":1577936000,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1577936000","product_id":100020801,"comment_content":"老师 这一章的标题是 ‘count(*)这么慢，我该怎么办？’ ，但是我看完整篇看到的是 count（1），count（*），count（字段），count（id） 的对比，好像并没有讲到 count（*）慢的解决办法，是我没理解到位码 ？ ","like_count":0,"discussions":[{"author":{"id":1453053,"avatar":"https://static001.geekbang.org/account/avatar/00/16/2b/fd/7013289d.jpg","nickname":"温故而知新可以为师矣","note":"","ucode":"FADCDFA9F9E5E8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":121050,"discussion_content":"引子而已，不用纠结，另外文章不也给出了redis，mysql加计数表的方案了吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578310187,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":167022,"user_name":"阿杜","can_delete":false,"product_type":"c1","uid":1066705,"ip_address":"","ucode":"349D3572F5ABE7","user_header":"https://static001.geekbang.org/account/avatar/00/10/46/d1/a1ddf49f.jpg","comment_is_top":false,"comment_ctime":1577671500,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1577671500","product_id":100020801,"comment_content":"并发情况下，为了减少锁等待的时间，事物中占用锁时间越多的放在越后执行，更新统计数涉及锁竞争，所以会锁等待，故在插入一行数据后执行。","like_count":0},{"had_liked":false,"id":165055,"user_name":"听雨","can_delete":false,"product_type":"c1","uid":1254493,"ip_address":"","ucode":"252754F9FCFF0C","user_header":"https://static001.geekbang.org/account/avatar/00/13/24/5d/65e61dcb.jpg","comment_is_top":false,"comment_ctime":1577153641,"is_pvip":false,"replies":[{"id":"62894","content":"不能，explain是估算值，而且很不准","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1577156247,"ip_address":"","comment_id":165055,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1577153641","product_id":100020801,"comment_content":"老师，生产中可以用explain替代count优化吗","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":479007,"discussion_content":"不能，explain是估算值，而且很不准","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577156247,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":159322,"user_name":"小萝卜","can_delete":false,"product_type":"c1","uid":1743846,"ip_address":"","ucode":"1E7BD767DBD46C","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI9tOiaKOSA3RakexswPIzAzlwFrJzVhL2icLfyZcPKY0emWh12Bibp2slGTOQuJoUgDVzDXyfROzs6w/132","comment_is_top":false,"comment_ctime":1575598871,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1575598871","product_id":100020801,"comment_content":"在求行数的时候能不能单独为一张表设置一个变量,每新增一条数据就自增一,来达到获取总表的行数","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":158099,"discussion_content":"想的美好，落地没有。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580550855,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":151046,"user_name":"anchor","can_delete":false,"product_type":"c1","uid":1083124,"ip_address":"","ucode":"24EECD40CC54C2","user_header":"https://static001.geekbang.org/account/avatar/00/10/86/f4/331f33a7.jpg","comment_is_top":false,"comment_ctime":1573647347,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1573647347","product_id":100020801,"comment_content":"请问老师  count(distinct 字段)的原理是怎样的","like_count":0,"discussions":[{"author":{"id":1453053,"avatar":"https://static001.geekbang.org/account/avatar/00/16/2b/fd/7013289d.jpg","nickname":"温故而知新可以为师矣","note":"","ucode":"FADCDFA9F9E5E8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":121061,"discussion_content":"加个hash判断是否已返回之类？也可能有诸如“去重B+树”之类的东西？猜测。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578310398,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":149889,"user_name":"Flash","can_delete":false,"product_type":"c1","uid":1236163,"ip_address":"","ucode":"E285075C9E0B02","user_header":"https://static001.geekbang.org/account/avatar/00/12/dc/c3/e4ba51d5.jpg","comment_is_top":false,"comment_ctime":1573430202,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1573430202","product_id":100020801,"comment_content":"思考题:<br>从性能考虑，先插入记录，再更新计数。<br>因为更新的计数应该是同一行记录，会用到行锁，并发时，更新计数放后面，可以减少行锁锁住的时间，提高并发度。<br>提问:<br>老师，请问count(*)是从哪个版本开始优化的？","like_count":0,"discussions":[{"author":{"id":1602218,"avatar":"https://static001.geekbang.org/account/avatar/00/18/72/aa/7b80f622.jpg","nickname":"土豆稀饭","note":"","ucode":"C045CE79B458BF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":69281,"discussion_content":"从5.7版本进行的优化，老版本mysql 还是用count(1) 比较快","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1575278533,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":149530,"user_name":"乘风","can_delete":false,"product_type":"c1","uid":1115724,"ip_address":"","ucode":"0420C5535DACB7","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLwSoTjHPX5tm4whBSfoZLX6toZxrZGUaLABQywKNf4MDc9toK3QSV7Z99ATcGicFCysoleQ5ISzmw/132","comment_is_top":false,"comment_ctime":1573267821,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1573267821","product_id":100020801,"comment_content":"先插入后更新,因为更新计数表会存在锁,而锁是事务结束后才释放.若遇到插入时因为nextkeylock导致阻塞,则计数器表的锁也会被长期持有而不被释放.<br><br>","like_count":0},{"had_liked":false,"id":148901,"user_name":"Geek_55a272","can_delete":false,"product_type":"c1","uid":1674602,"ip_address":"","ucode":"7B12A9B322B3BF","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJPHfGiaByESiaHPWbfQicjgap3unxDsxlG6JuUCNvEFJNLibNjeX4CQYNtsvXBXqTpBERUIPyiagGBXbg/132","comment_is_top":false,"comment_ctime":1573106638,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1573106638","product_id":100020801,"comment_content":"先插入新记录再更新计数值<br>因为如果更新计数值了<br>那么根据mvcc 其他事务是可以得到这个计数值的<br>但是 新记录是无法查询的","like_count":0},{"had_liked":false,"id":144276,"user_name":"天亮前说晚安","can_delete":false,"product_type":"c1","uid":1541014,"ip_address":"","ucode":"1D82EE562A7C71","user_header":"https://static001.geekbang.org/account/avatar/00/17/83/96/73ff13a0.jpg","comment_is_top":false,"comment_ctime":1571886281,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1571886281","product_id":100020801,"comment_content":"但是很多情况下，都是带条件的啊，这个时候怎么优化？比如分页查询，某种条件下的总记录数。这种还不能从表结构上来做优化，就像案例中说的，专门一个字段来存储。","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":158102,"discussion_content":"像这种加条件的，一般就只能直接执行计数了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580550980,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":140084,"user_name":"心有林夕","can_delete":false,"product_type":"c1","uid":1172145,"ip_address":"","ucode":"BC6E1AE557BFF4","user_header":"https://static001.geekbang.org/account/avatar/00/11/e2/b1/d00399c0.jpg","comment_is_top":false,"comment_ctime":1570803681,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1570803681","product_id":100020801,"comment_content":"晓斌哥，读了几遍文章还是有些不明白，想请教下：<br>1.在介绍count()语意的时候说，“对于返回的结果集，一行行地判断，count 函数的参数是不是 NULL。”<br>在介绍count(*)的时候说，“不会把全部字段取出来，而是专门做了优化，不取值。count(*) 肯定不是 null，按行累加。” 感觉两者有些矛盾<br>想问下，对count(*)，server层是否还需要对每行，判断not null这步操作呢？<br>2. 在介绍count(*)优化的时候，提到Mysql优化器会选择最小的索引。但是对于count(*)函数来说，innodb是不取值的，那这个叶子节点大小和查询效率有关系么？这个优化要怎么理解呢？<br><br>提问较晚，希望看到可以解答下，感谢~","like_count":0,"discussions":[{"author":{"id":1453053,"avatar":"https://static001.geekbang.org/account/avatar/00/16/2b/fd/7013289d.jpg","nickname":"温故而知新可以为师矣","note":"","ucode":"FADCDFA9F9E5E8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":121081,"discussion_content":"1：不矛盾，判断NULL是针对select(普通列)且普通列定义为NULL的情况，count(*)找到一行就可以“+1”了。（我认为count（*）只需要给server最终的结果就行了个人理解）。\n2：“小的索引”每个数据页的数据也就多，因此&#34;IO&#34;次数就也少，占用内存也少，消耗CPU也少，因此效率就高。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1578310907,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":139867,"user_name":"⛽️🦆","can_delete":false,"product_type":"c1","uid":1674059,"ip_address":"","ucode":"7D952CAFDBBD99","user_header":"https://static001.geekbang.org/account/avatar/00/19/8b/4b/9e0d334f.jpg","comment_is_top":false,"comment_ctime":1570758209,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1570758209","product_id":100020801,"comment_content":"老师，有一个问题。比如大量的计数操作，那么用mysql的话会频繁的写入，这对性能是不是有影响啊。","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":158103,"discussion_content":"还好吧，如果太多，可以在架构上做文章，比如加队列。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580551198,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":139351,"user_name":"happiness","can_delete":false,"product_type":"c1","uid":1026587,"ip_address":"","ucode":"C5F25D57C7A1DC","user_header":"https://static001.geekbang.org/account/avatar/00/0f/aa/1b/b43c8519.jpg","comment_is_top":false,"comment_ctime":1570617762,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1570617762","product_id":100020801,"comment_content":"先插入再更新 更新需要持有行锁 我们需要尽量减少每个线程持锁的时间来提升整体并发性","like_count":0},{"had_liked":false,"id":135226,"user_name":"行者","can_delete":false,"product_type":"c1","uid":1618607,"ip_address":"","ucode":"8179D167D99CB9","user_header":"https://static001.geekbang.org/account/avatar/00/18/b2/af/81303f5a.jpg","comment_is_top":false,"comment_ctime":1569071347,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1569071347","product_id":100020801,"comment_content":"记得老师说过全表扫描会走默认主键索引，但是count(字段)这个操作，我的实验中发现该字段没有创建索引，用EXPLAIN命令看到的结果中key值为空，说明没有使用索引，那么我的疑问来了：<br>1：全表扫描是否走主键索引，如何验证呢<br>2：count（字段）操作，当这个字段没有创建索引的时候，MySQL如何处理，是全表扫描吗","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":158104,"discussion_content":"1、全表扫描就是走主键索引表吧。\n2、是的，一行行扫描，并进行null判断。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580551319,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":134039,"user_name":"#160","can_delete":false,"product_type":"c1","uid":1195835,"ip_address":"","ucode":"0C0A2C5494B252","user_header":"https://static001.geekbang.org/account/avatar/00/12/3f/3b/6f3cf0af.jpg","comment_is_top":false,"comment_ctime":1568727141,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1568727141","product_id":100020801,"comment_content":"老师可以分析一下这个语句吗？拿到的行数了show table status一样吗？<br> &quot;select TABLE_SCHEMA, table_name, table_rows from `TABLES` where TABLE_SCHEMA not in (&#39;information_schema&#39;,&#39;sys&#39;,&#39;test&#39;,&#39;performance_schema&#39;,&#39;mysql&#39;)&quot;","like_count":0},{"had_liked":false,"id":131691,"user_name":"单小灰","can_delete":false,"product_type":"c1","uid":1067354,"ip_address":"","ucode":"59C4523FF1B5DB","user_header":"https://static001.geekbang.org/account/avatar/00/10/49/5a/67b5f0b1.jpg","comment_is_top":false,"comment_ctime":1567847504,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1567847504","product_id":100020801,"comment_content":"老师，有个问题，如果在图4当中会话A的插入一行数据R和commit发生在会话B的读表C计数值和查询最近100条记录之间，那不是还是会出现逻辑上不精确的现象吗？因为会话B读到的计数值是+1之前的值，而读到的数据记录是插入数据之后的。","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":158107,"discussion_content":"可再看一下第8章，版本已提交，但是是在视图创建后提交的，不可见；","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580551580,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":130476,"user_name":"alioo","can_delete":false,"product_type":"c1","uid":1022507,"ip_address":"","ucode":"F36A38C1F5FFAB","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqOpANMwDibLmj5IGJh6dTw300sZ1BHM5sG3sZv1A1rvCHOiblPD3jgFOiaMVVujtctWnQbVFoNPpRgw/132","comment_is_top":false,"comment_ctime":1567472259,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1567472259","product_id":100020801,"comment_content":"老师提到的count(*)优化是从哪个mysql版本开始支持的啊？之前一直都是以为是最慢的，惭愧","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":158108,"discussion_content":"5.7之后，之前count(1)快","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580551605,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":130470,"user_name":"alioo","can_delete":false,"product_type":"c1","uid":1022507,"ip_address":"","ucode":"F36A38C1F5FFAB","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqOpANMwDibLmj5IGJh6dTw300sZ1BHM5sG3sZv1A1rvCHOiblPD3jgFOiaMVVujtctWnQbVFoNPpRgw/132","comment_is_top":false,"comment_ctime":1567471443,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1567471443","product_id":100020801,"comment_content":"从并发系统性能的角度考虑，你觉得在这个事务序列里，应该先插入操作记录，还是应该先更新计数表呢？<br>&gt;&gt; 更新计数表一定会加锁，所以要控制锁的时间，让它距离commit更近，即后更新计数表更合适（晚点执行，快点提交）","like_count":0},{"had_liked":false,"id":129085,"user_name":"-W.LI-","can_delete":false,"product_type":"c1","uid":1210699,"ip_address":"","ucode":"3556786538664F","user_header":"https://static001.geekbang.org/account/avatar/00/12/79/4b/740f91ca.jpg","comment_is_top":false,"comment_ctime":1567040484,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1567040484","product_id":100020801,"comment_content":"带where条件的count(*)mysiam是不是也得一行一行统计?","like_count":0},{"had_liked":false,"id":127239,"user_name":"书策稠浊","can_delete":false,"product_type":"c1","uid":1307497,"ip_address":"","ucode":"A29875CE15FDA3","user_header":"https://static001.geekbang.org/account/avatar/00/13/f3/69/7039d03f.jpg","comment_is_top":false,"comment_ctime":1566618307,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1566618307","product_id":100020801,"comment_content":"count的时候遍历整张表是遍历索引树吧，然后count1的时候不返回数据是什么意思，怎么做到不返回数据，但是server层又能按行统计呢。","like_count":0},{"had_liked":false,"id":125897,"user_name":"Geek_544e36","can_delete":false,"product_type":"c1","uid":1450625,"ip_address":"","ucode":"AE7D01F2BA3D65","user_header":"https://static001.geekbang.org/account/avatar/00/16/22/81/3115e3eb.jpg","comment_is_top":false,"comment_ctime":1566269423,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1566269423","product_id":100020801,"comment_content":"先插入操作记录，再更新计数表。因为计数表更新涉及行锁竞争。应该尽量把有行锁竞争的语句放在后面，以减少锁占用时间，从而提高并发度。","like_count":0},{"had_liked":false,"id":121532,"user_name":"条","can_delete":false,"product_type":"c1","uid":1203836,"ip_address":"","ucode":"6F8679175256E3","user_header":"https://static001.geekbang.org/account/avatar/00/12/5e/7c/94af3f5e.jpg","comment_is_top":false,"comment_ctime":1565154044,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1565154044","product_id":100020801,"comment_content":"老师，mysql对count(*)的优化是从哪个版本引入的?","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":158110,"discussion_content":"5.7之后，之前count(1)快","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1580551797,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":119868,"user_name":"张珂","can_delete":false,"product_type":"c1","uid":1249512,"ip_address":"","ucode":"E0AFA940BEAC1C","user_header":"https://static001.geekbang.org/account/avatar/00/13/10/e8/172b5915.jpg","comment_is_top":false,"comment_ctime":1564715227,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1564715227","product_id":100020801,"comment_content":"“看到这里，你一定会说，优化器就不能自己判断一下吗，主键 id肯定非空啊，为什么不能按照 count(*) 来处理，多么简单的优化啊。”<br><br>老师，这里的假设推理，count(*)应该是count(id)吧？或者改成count(1)?这样才符合有些同学的推理思维吧","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":158111,"discussion_content":"不是吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580551820,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":114183,"user_name":"lmtoo","can_delete":false,"product_type":"c1","uid":1133918,"ip_address":"","ucode":"FCD5B9C941D448","user_header":"https://static001.geekbang.org/account/avatar/00/11/4d/5e/c5c62933.jpg","comment_is_top":false,"comment_ctime":1563246800,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1563246800","product_id":100020801,"comment_content":"SELECT SQL_CALC_FOUND_ROWS * FROM (table ) temp LIMIT :offset , :pageSize ；SQL_CALC_FOUND_ROWS 这个是不是就不用重新发起计算总数的查询了","like_count":0},{"had_liked":false,"id":111174,"user_name":"yhui","can_delete":false,"product_type":"c1","uid":1512714,"ip_address":"","ucode":"1AAAF47E41FFB8","user_header":"https://static001.geekbang.org/account/avatar/00/17/15/0a/c450e565.jpg","comment_is_top":false,"comment_ctime":1562498108,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1562498108","product_id":100020801,"comment_content":"很多情况下，只要一个预估的总数就行了 是不是用 explain 来分析 rows行数来获得总行数使用呢？","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":158113,"discussion_content":"你这样会被老板吊打的，哈哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580551856,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1453053,"avatar":"https://static001.geekbang.org/account/avatar/00/16/2b/fd/7013289d.jpg","nickname":"温故而知新可以为师矣","note":"","ucode":"FADCDFA9F9E5E8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":121091,"discussion_content":"记得老师之前的一个例子吗，本来10000，explain出3万多。。。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578311215,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":110463,"user_name":"王志杰","can_delete":false,"product_type":"c1","uid":1074791,"ip_address":"","ucode":"DAC170C33EDDCF","user_header":"https://static001.geekbang.org/account/avatar/00/10/66/67/85709c6b.jpg","comment_is_top":false,"comment_ctime":1562283932,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1562283932","product_id":100020801,"comment_content":"要是在大表中多条件查询总数呢？这个又该如何优化？","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":158114,"discussion_content":"像这种加条件的，一般就只能直接执行计数了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580551905,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":90687,"user_name":"赵金帅","can_delete":false,"product_type":"c1","uid":1357392,"ip_address":"","ucode":"158A05AA523990","user_header":"https://static001.geekbang.org/account/avatar/00/14/b6/50/99bfa911.jpg","comment_is_top":false,"comment_ctime":1556610089,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1556610089","product_id":100020801,"comment_content":"老师，您好：<br>    在现实的业务当中，查询count(*)大部分都是按照条件，并且连表查询的，这种情况不能再像您说的那种放在redis或者数据库中了吧？您说的那种是整张表的计数放在单独的数据表中吧？","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":158115,"discussion_content":"像这种加条件的，一般就只能直接执行计数了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580551921,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":88813,"user_name":"~玲玲玲~子~哥~","can_delete":false,"product_type":"c1","uid":1302741,"ip_address":"","ucode":"89379F3A0427EA","user_header":"https://static001.geekbang.org/account/avatar/00/13/e0/d5/7485e51f.jpg","comment_is_top":false,"comment_ctime":1556006979,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1556006979","product_id":100020801,"comment_content":"老师您好,二刷时看了学完还是有些疑问<br><br>1.count(*)和count(1)都是不取值,区别只是count(1)返回server层需要判断是否不为空?<br><br>2.如果表里有唯一索引,也会想主键索引判断不为空吗? 只有count(*)才不会做非空判断?<br><br>3.文章里count(主键 id),我理解是id是主键. 那count(id)还会走别的索引吗?比如长度最小的索引? 个人感觉只走id索引, 走别的索引是count(字段)来判断这个字段是否有索引","like_count":0},{"had_liked":false,"id":87922,"user_name":"逗逼师父","can_delete":false,"product_type":"c1","uid":1017863,"ip_address":"","ucode":"ECC2D82F83CBE6","user_header":"https://static001.geekbang.org/account/avatar/00/0f/88/07/7804f4cc.jpg","comment_is_top":false,"comment_ctime":1555754510,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1555754510","product_id":100020801,"comment_content":"实际业务里还是带where条件的场景比较多呀，比如列表过滤，然后给总条数，分页，这种场景是不是就只能强行count(*)了？","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":158116,"discussion_content":"像这种加条件的，一般就只能直接执行计数了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580551950,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":84250,"user_name":"Lucus","can_delete":false,"product_type":"c1","uid":1198800,"ip_address":"","ucode":"CE8EB70CB9D9F1","user_header":"https://static001.geekbang.org/account/avatar/00/12/4a/d0/d319c44a.jpg","comment_is_top":false,"comment_ctime":1554812848,"is_pvip":false,"replies":[{"id":"30753","content":"大家注意了，下次面试官如果是徐先生，要复习这个题，手动调皮😝","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1555147789,"ip_address":"","comment_id":84250,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1554812848","product_id":100020801,"comment_content":"个人感觉count(*),count(1),count(id)哪个效率更好是个很好的面试题","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":446293,"discussion_content":"大家注意了，下次面试官如果是徐先生，要复习这个题，手动调皮😝","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1555147789,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":81708,"user_name":"思忆","can_delete":false,"product_type":"c1","uid":1199451,"ip_address":"","ucode":"26B307A6C4F35C","user_header":"https://static001.geekbang.org/account/avatar/00/12/4d/5b/3ed7df22.jpg","comment_is_top":false,"comment_ctime":1554015504,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1554015504","product_id":100020801,"comment_content":"先更新数据行数，在进行业务数据的修改。目的是在可重复读隔离级别下可以减少行锁竞争，避免产生死锁","like_count":0},{"had_liked":false,"id":81495,"user_name":"Eason Tai","can_delete":false,"product_type":"c1","uid":1200676,"ip_address":"","ucode":"4707577CC9C9E9","user_header":"https://static001.geekbang.org/account/avatar/00/12/52/24/bd63c4de.jpg","comment_is_top":false,"comment_ctime":1553927006,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1553927006","product_id":100020801,"comment_content":"这边的最后速度比较，会不会有一些问题。比如，count(*) 会读取整行数据，但是，不会返回整行数据count(primaryid)会读取主键列，判断一次主键不为空，直接返回主键值。那么，我想，如果列70个的时候，应该是count(primaryid)效果更好一些吧。<br><br>不知道认知是否有误。请抽空指正","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":158118,"discussion_content":"还是count(*)效果好","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580552018,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1200676,"avatar":"https://static001.geekbang.org/account/avatar/00/12/52/24/bd63c4de.jpg","nickname":"Eason Tai","note":"","ucode":"4707577CC9C9E9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":252820,"discussion_content":"这个结论是猜测还是有依据？有做进一步验证吗？我在一个26g单表试了试。count(id)显然是快的。因为，索引也是表。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588180312,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":158118,"ip_address":""},"score":252820,"extra":""}]}]},{"had_liked":false,"id":77104,"user_name":"阳明","can_delete":false,"product_type":"c1","uid":1052818,"ip_address":"","ucode":"BA0F5AF0E5A27A","user_header":"https://static001.geekbang.org/account/avatar/00/10/10/92/760f0964.jpg","comment_is_top":false,"comment_ctime":1552834386,"is_pvip":true,"discussion_count":2,"race_medal":0,"score":"1552834386","product_id":100020801,"comment_content":"所以结论是：按照效率排序的话，count(字段)&lt;count(主键 id)&lt;count(1)≈count(*)，所以我建议你，尽量使用 count(*)。这个不太理解，使用count（A）统计，并且A字段有索引，而且是最小的一个索引树，这种情况下，count（A）的效率，应该大于count（主键Id）的效率吧","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":158121,"discussion_content":"不是，count(id) 也是走普通索引 ，普通索引比主键索引要小，遍历起来更快。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580552112,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1086093,"avatar":"https://static001.geekbang.org/account/avatar/00/10/92/8d/ab469ad5.jpg","nickname":"黄强","note":"","ucode":"20231AC29CFD53","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":116,"discussion_content":"如果不是唯一索引，一个索引项可能会多个记录的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561110840,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":71420,"user_name":"哈哈哈","can_delete":false,"product_type":"c1","uid":1248876,"ip_address":"","ucode":"C40ABE7161EFAE","user_header":"https://static001.geekbang.org/account/avatar/00/13/0e/6c/1f3b1372.jpg","comment_is_top":false,"comment_ctime":1551338537,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1551338537","product_id":100020801,"comment_content":"赞👍🏻","like_count":0},{"had_liked":false,"id":68898,"user_name":"胡小珊","can_delete":false,"product_type":"c1","uid":1308031,"ip_address":"","ucode":"A367C885310F7E","user_header":"https://static001.geekbang.org/account/avatar/00/13/f5/7f/81b3f5ec.jpg","comment_is_top":false,"comment_ctime":1550626664,"is_pvip":false,"replies":[{"id":"24472","content":"嗯，这种特别难办，主要是看看能不能通过优化，用索引提升条件的过滤性，索引命中以后少扫描些行","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1550640808,"ip_address":"","comment_id":68898,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1550626664","product_id":100020801,"comment_content":"如果是多表关联并有很多where条件查询，此时count虽然走了索引，但还是特别慢，具体业务是页面查询条件与显示需要关联这些表，并做条件查询","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":439864,"discussion_content":"嗯，这种特别难办，主要是看看能不能通过优化，用索引提升条件的过滤性，索引命中以后少扫描些行","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550640808,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":68467,"user_name":"huolang","can_delete":false,"product_type":"c1","uid":1346708,"ip_address":"","ucode":"FDC4A6B6151C5E","user_header":"https://static001.geekbang.org/account/avatar/00/14/8c/94/5282994c.jpg","comment_is_top":false,"comment_ctime":1550503938,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1550503938","product_id":100020801,"comment_content":"老师你好，我有一个案例需要请教，有以下这样一个表<br>CREATE TABLE `cameras` (<br>    `id` int NOT NULL AUTO_INCREMENT,<br>    `uuid` varchar(64) NOT NULL,<br>    `zone_uuid` varchar(64) NOT NULL,<br>    `device_id` varchar(256) NOT NULL,<br>    `platform_id` int DEFAULT &#39;0&#39;,<br>    PRIMARY KEY (`id`),<br>    UNIQUE KEY `index_cameras_on_zone_uuid_and_uuid` (`zone_uuid`, `uuid`),<br>    UNIQUE KEY `index_cameras_on_platform_id_and_device_id` (`platform_id`, `device_id`)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;<br><br>explain select count(1) from cameras where zone_uuid = &quot;xxx&quot;时，extra 显示的是&quot;using where;using index&quot;， 用上了唯一索引`index_cameras_on_zone_uuid_and_uuid`。<br><br>explain select count(1) from cameras where platform_id = 1时， extra显示的是using index，用上了唯一索引`index_cameras_on_platform_id_and_device_id`。<br><br>然后使用platform_id作为条件select count时比使用zone_uuid作为条件select count时要快不少，这应该是因为使用zone_uuid作为条件select count时需要&quot;using where&quot;。<br><br>但是为什么使用zone_uuid作为条件select count时需要&quot;using where&quot;呢？我没有想明白，烦请老师指教一下。","like_count":0},{"had_liked":false,"id":63707,"user_name":"张汉桂-东莞","can_delete":false,"product_type":"c1","uid":1116277,"ip_address":"","ucode":"38657ABA59382A","user_header":"https://static001.geekbang.org/account/avatar/00/11/08/75/512b9f26.jpg","comment_is_top":false,"comment_ctime":1548470978,"is_pvip":false,"replies":[{"id":"22537","content":"如果放在事务里面，其实对其他线程来说是一样的哦 （这两个更新是同时出现的），所以先后关系倒不是主要的考察因素","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1548484028,"ip_address":"","comment_id":63707,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1548470978","product_id":100020801,"comment_content":"我觉得应该先插入再更新计数表。因为先有记录，再有统计数。这样做逻辑上更合理","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437689,"discussion_content":"如果放在事务里面，其实对其他线程来说是一样的哦 （这两个更新是同时出现的），所以先后关系倒不是主要的考察因素","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548484028,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":55339,"user_name":"寂寞红尘","can_delete":false,"product_type":"c1","uid":1080886,"ip_address":"","ucode":"C17D389D051E51","user_header":"https://static001.geekbang.org/account/avatar/00/10/7e/36/7c5503d9.jpg","comment_is_top":false,"comment_ctime":1546138422,"is_pvip":false,"replies":[{"id":"20054","content":"还是不行哦。你看一下我们例子中的场景","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1546171423,"ip_address":"","comment_id":55339,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1546138422","product_id":100020801,"comment_content":"插入数据的时候加入分布式锁，事务完成后且redis加一后再释放锁；获取计数的时候也同样获取相同的分布式锁。这样是不是能解决redis计数不准确的问题。","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434745,"discussion_content":"还是不行哦。你看一下我们例子中的场景","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546171423,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":55206,"user_name":"Ruian","can_delete":false,"product_type":"c1","uid":1318776,"ip_address":"","ucode":"39112092A920F1","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIyn6s0CNx9F9Uu4nia6z7ZldUo8XdXEF4ia4ojfTRCvMT8IZgjRcpFulYqZjq4IvtrE5yYfzpgzMWA/132","comment_is_top":false,"comment_ctime":1546066246,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1546066246","product_id":100020801,"comment_content":"老师您好，上次我这边问了您一个问题，您这边做了回复，我这边做了补充和回答，并有新的疑惑，再次请教下老师。。<br><br>老师，我有一个问题请教下您。我的mysql数据库 有一张表project_des (850万数据) count(1) 只要0.05s 和从表project（6500条数据）关联后需要15s 查看执行计划发现都走索引了。不知道为啥这么慢？<br>查询语句 select count(1) from project_des a,project b where a.project_id=b.id 我换exists 和in 也这么慢<br>2018-12-28<br> 作者回复<br>你这个是笛卡尔积肯定慢的…你的业务需求是啥，这个语句的业务意义是什么<br><br>答：业务需求是这样的，页面需要显示出两张表关联后的某些字段，还需要显示关联后的总数。<br>      老师上面说笛卡尔积肯定是慢的，我这边把数据导入oracle数据库做了比较。结果如下：<br>       请教老师mysql为啥会比较慢，跟哪些因素有关？<br><br><br><br>mysql 环境下<br>select count(*) from project; --11616条记录  0.045s<br>select count(*) from project_des; --3712995条记录  0.045s<br>select count(*) from project_des a, project b where a.project_id=b.id  --3152651条记录  17.71s<br>select count(*) from project_des a where a.project_id in (select b.id from project b where a.project_id=b.id) --3152651条记录  17.66s<br>select count(*) from project_des a where  exists(select 1 from project b where a.project_id=b.id)  --3152651条记录  42.06s<br><br><br>oracle 环境下<br>select count(*) from project; --11616条记录  0.04s<br>select count(*) from project_des; --3712995条记录  0.16s<br>select count(*) from project_des a, project b where a.project_id=b.id  --3152651条记录  0.82s<br>select count(*) from project_des a where a.project_id in (select b.id from project b where a.project_id=b.id) --3152651条记录  0.93s<br>select count(*) from project_des a where  exists(select 1 from project b where a.project_id=b.id)  --3152651条记录  0.91s","like_count":0},{"had_liked":false,"id":55104,"user_name":"alias cd=rm -rf","can_delete":false,"product_type":"c1","uid":1318325,"ip_address":"","ucode":"E7B27D76305B75","user_header":"https://static001.geekbang.org/account/avatar/00/14/1d/b5/971261fd.jpg","comment_is_top":false,"comment_ctime":1546045099,"is_pvip":false,"replies":[{"id":"19992","content":"对的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1546045983,"ip_address":"","comment_id":55104,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1546045099","product_id":100020801,"comment_content":"先插入，在更新。因为更新会锁数据影响性能","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434673,"discussion_content":"对的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546045983,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":54676,"user_name":"毒草","can_delete":false,"product_type":"c1","uid":1026090,"ip_address":"","ucode":"DBD67DD3517190","user_header":"https://static001.geekbang.org/account/avatar/00/0f/a8/2a/316b8f17.jpg","comment_is_top":false,"comment_ctime":1545930890,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1545930890","product_id":100020801,"comment_content":"一直用count(id)，自以为效率比*高呢，学到了。","like_count":0},{"had_liked":false,"id":52031,"user_name":"风中奇缘","can_delete":false,"product_type":"c1","uid":1019206,"ip_address":"","ucode":"43DE1F63483411","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8d/46/fd0bd694.jpg","comment_is_top":false,"comment_ctime":1545297776,"is_pvip":false,"replies":[{"id":"18827","content":"嗯，这个是特例，条件多，确实没有银弹的方案<br>","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545299149,"ip_address":"","comment_id":52031,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1545297776","product_id":100020801,"comment_content":"放到数据库里单独的一张计数表 C也不是一个好的方案，我这边当时有个需求是需要按照各种条件搜索来统计总个数的，计数表C估计罗列不完各种条件搜索。","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433711,"discussion_content":"嗯，这个是特例，条件多，确实没有银弹的方案\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545299149,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":51576,"user_name":"未来已来","can_delete":false,"product_type":"c1","uid":1187130,"ip_address":"","ucode":"3A21ACFD53CB9C","user_header":"https://static001.geekbang.org/account/avatar/00/12/1d/3a/cdf9c55f.jpg","comment_is_top":false,"comment_ctime":1545202429,"is_pvip":false,"replies":[{"id":"18683","content":"嗯嗯，这是一种可能的情况","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545215336,"ip_address":"","comment_id":51576,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1545202429","product_id":100020801,"comment_content":"不知道是不是自己理解错了：上期的问题，感觉应该是一张表是紧凑的，并且使用了一部分预留空间，然后重建表的时候，这部分预留空间被重新腾出来了，多余的数据被加到新的页上，导致重建表的时候反而占用了更多的空间。","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433520,"discussion_content":"嗯嗯，这是一种可能的情况","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545215336,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":50958,"user_name":"王虹凯","can_delete":false,"product_type":"c1","uid":1018862,"ip_address":"","ucode":"CA01E64E125CFF","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8b/ee/56823fd7.jpg","comment_is_top":false,"comment_ctime":1545093531,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1545093531","product_id":100020801,"comment_content":"这个redis或者用表存总数的区别，我觉得区别不大。如果前者两个步骤能做到一个事务，跟表存没啥区别。只不过用后者可以有些异常策略巧妙利用mysql解决，前者需要自己维护，要求较高些。彼此的优点其实就是对方的缺点。在特定的场景，可以考虑相应的方案。","like_count":0},{"had_liked":false,"id":50876,"user_name":"404","can_delete":false,"product_type":"c1","uid":1313407,"ip_address":"","ucode":"2E7815DDCBA8AB","user_header":"","comment_is_top":false,"comment_ctime":1545059348,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1545059348","product_id":100020801,"comment_content":"老师你举得这个例子是不是可以引申出来，redis 和mysql 如何保持数据同步问题呢？这个也是面试经常会问的一个问题吧？老师你遇到过redis 和mysql 数据同步的问题吗？是怎么解决的，或者说这个问题有什么好的解决方案呢？","like_count":0},{"had_liked":false,"id":50735,"user_name":"路人小草","can_delete":false,"product_type":"c1","uid":1310400,"ip_address":"","ucode":"B8AA31EB63E172","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLUhiadpGmT6ZJb0CZLm3OjHJQCkHibTkVxVibHUOyWjHS9uOhptEerFxUpHVTEvicDRueya8kEYWXZ1A/132","comment_is_top":false,"comment_ctime":1545036586,"is_pvip":false,"replies":[{"id":"18203","content":"还是得看机器压力，count(*)是一个比较简单的逻辑，可能还是因为数据库所在机器压力大了…<br>","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545041397,"ip_address":"","comment_id":50735,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1545036586","product_id":100020801,"comment_content":"老师，你好，七千多万条数据使用count（*）用了4分钟正常吗？感觉好慢。","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433077,"discussion_content":"还是得看机器压力，count(*)是一个比较简单的逻辑，可能还是因为数据库所在机器压力大了…\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545041397,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":50611,"user_name":"郭刚","can_delete":false,"product_type":"c1","uid":1292032,"ip_address":"","ucode":"22CB8ECE8E3DCA","user_header":"https://static001.geekbang.org/account/avatar/00/13/b7/00/12149f4e.jpg","comment_is_top":false,"comment_ctime":1545016416,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1545016416","product_id":100020801,"comment_content":"SELECT VERSION();<br>VERSION()  <br>-----------<br>5.6.36  <br>本地有一张表，id为主键，START_TIME上面建了一个普通索引，比较了count(*),COUNT(1)和count(主键)，三者的执行计划是一样，我觉得三种性能没有区别。<br>EXPLAIN<br>SELECT COUNT(*) FROM ic_order;<br>    id  select_type  TABLE          TYPE    possible_keys  KEY                         key_len  ref       ROWS  Extra        <br>------  -----------  -------------  ------  -------------  --------------------------  -------  ------  ------  -------------<br>     1  SIMPLE       ic_order  INDEX   (NULL)         IDX_ORDER_START_TIME  6        (NULL)  109908  USING INDEX  <br><br>EXPLAIN<br>SELECT COUNT(id) FROM ic_order;<br>    id  select_type  TABLE          TYPE    possible_keys  KEY                         key_len  ref       ROWS  Extra        <br>------  -----------  -------------  ------  -------------  --------------------------  -------  ------  ------  -------------<br>     1  SIMPLE       ic_order  INDEX   (NULL)         IDX_ORDER_START_TIME  6        (NULL)  109908  USING INDEX  <br>EXPLAIN<br>SELECT COUNT(1) FROM ic_order;<br>    id  select_type  TABLE          TYPE    possible_keys  KEY                         key_len  ref       ROWS  Extra        <br>------  -----------  -------------  ------  -------------  --------------------------  -------  ------  ------  -------------<br>     1  SIMPLE       ic_order  INDEX   (NULL)         IDX_ORDER_START_TIME  6        (NULL)  109908  USING INDEX  <br>","like_count":0},{"had_liked":false,"id":50606,"user_name":"郭刚","can_delete":false,"product_type":"c1","uid":1292032,"ip_address":"","ucode":"22CB8ECE8E3DCA","user_header":"https://static001.geekbang.org/account/avatar/00/13/b7/00/12149f4e.jpg","comment_is_top":false,"comment_ctime":1545015897,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1545015897","product_id":100020801,"comment_content":"Oracle的索引不会存null值，MySQL会存吗？","like_count":0},{"had_liked":false,"id":50398,"user_name":"臧天霸","can_delete":false,"product_type":"c1","uid":1302804,"ip_address":"","ucode":"F53FB15E7BD17A","user_header":"https://static001.geekbang.org/account/avatar/00/13/e1/14/006e8b9b.jpg","comment_is_top":false,"comment_ctime":1544966506,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1544966506","product_id":100020801,"comment_content":"从并发系统性能的角度考虑，在这个事务序列里，应该先更新计数表。因为计数表只有一条记录，或很少几条记录，由于经常被update，所以对应的数据块肯定被cache在内存中，这样，每次更新这条记录时只需更新内存块，代价很小。","like_count":0},{"had_liked":false,"id":50277,"user_name":"WL","can_delete":false,"product_type":"c1","uid":1173771,"ip_address":"","ucode":"6277DCD776B87E","user_header":"https://static001.geekbang.org/account/avatar/00/11/e9/0b/1171ac71.jpg","comment_is_top":false,"comment_ctime":1544942363,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1544942363","product_id":100020801,"comment_content":"思考题: 我认为应该是先插入, 再更新C表, 因为C表可能会记录库中所有表的总行数, 任何一张表有插入都会导致C表更新, 所以C表会比较容易出现竞争关系, 所以对C表的更新操作应该更后面的获得锁.","like_count":0},{"had_liked":false,"id":50246,"user_name":"路过","can_delete":false,"product_type":"c1","uid":1316401,"ip_address":"","ucode":"7152C19ED024CC","user_header":"https://static001.geekbang.org/account/avatar/00/14/16/31/ae8adf82.jpg","comment_is_top":false,"comment_ctime":1544931711,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1544931711","product_id":100020801,"comment_content":"我在服务器MySQL5.7.17上，使用第10次课中的存储过程calldata()向表t中写入数据时，用另外一个mysql客户端连接到MySQL上，select * from t可以看到表t中的数据一直在增加。我查看隔离级别是RR，不同session，不是要等到calldata()结束后才能看到数据么？<br>另外，我在执行calldata()过程中，使用pkill直接结束mysqld。重启MySQL后，发现表t中已经被插入了数据，感觉没有执行完的事务calldata()并没有回滚。<br>我 写入数据的MySQL是master，通过GTID复制到slave。在slave上执行show processlist，提示如下内容：<br>Waiting for dependent transaction to commit<br>此时，master和slave上表t的数据不一致。并且查看show slave status,也提示相同的内容：<br>Slave_SQL_Running_State: Waiting for dependent transaction to commit<br>另外，master和slave之间也无法进行数据同步了。<br>请老师解惑，感谢！","like_count":0},{"had_liked":false,"id":50243,"user_name":"路过","can_delete":false,"product_type":"c1","uid":1316401,"ip_address":"","ucode":"7152C19ED024CC","user_header":"https://static001.geekbang.org/account/avatar/00/14/16/31/ae8adf82.jpg","comment_is_top":false,"comment_ctime":1544931456,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1544931456","product_id":100020801,"comment_content":"我在服务器MySQL5.7.17上，使用第10次课中的存储过程calldata()向表t中写入数据时，用另外一个mysql客户端连接到MySQL上，可以看到表t中的数据一直在增加。我查看隔离级别是RR，不同session，不是要等到calldata()结束后才能看到数据么？<br>另外，我在执行calldata()过程中，使用pkill直接结束mysqld。重启MySQL后，发现表t中已经被插入了数据，感觉没有执行完的事务calldata()并没有回滚。<br>","like_count":0},{"had_liked":false,"id":50201,"user_name":"天王","can_delete":false,"product_type":"c1","uid":1239337,"ip_address":"","ucode":"C074B2F9A5F007","user_header":"https://static001.geekbang.org/account/avatar/00/12/e9/29/629d9bb0.jpg","comment_is_top":false,"comment_ctime":1544917385,"is_pvip":false,"replies":[{"id":"18038","content":"对的，磁盘也少读，内存也少占","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544928936,"ip_address":"","comment_id":50201,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544917385","product_id":100020801,"comment_content":"请教个问题1 非聚集索引树比聚集索引树小，count(*)会找最小的索引树，根本上是，每一个数据页上存储一定量的数据，因为非聚集索引叶子几点存的是主键索引，占用的空间比较小，每一页存的数据量比较固定的情况下，占用的页数少，count(*)读的比较快，我是这样理解的，是这样吗？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432914,"discussion_content":"对的，磁盘也少读，内存也少占","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544928936,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":50142,"user_name":"bluefantasy3","can_delete":false,"product_type":"c1","uid":1299930,"ip_address":"","ucode":"9D6FF2811F7465","user_header":"","comment_is_top":false,"comment_ctime":1544878209,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1544878209","product_id":100020801,"comment_content":"老师好：什么时候讲一下MySQL的集群方案呀？网上看到集群方案有很多，每个方案都有缺点。而且感觉现在一般公司没有使用MySQL集群。请老师讲一下。","like_count":0},{"had_liked":false,"id":50053,"user_name":"王子鹏","can_delete":false,"product_type":"c1","uid":1296763,"ip_address":"","ucode":"2B0494362E68A8","user_header":"https://static001.geekbang.org/account/avatar/00/13/c9/7b/a89761ce.jpg","comment_is_top":false,"comment_ctime":1544851393,"is_pvip":false,"replies":[{"id":"18015","content":"你问着了，16、17就是说这个","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544874599,"ip_address":"","comment_id":50053,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544851393","product_id":100020801,"comment_content":"我想问下后面的课程能讲下mysql什么时候会创建临时表吗，有时候order by会创建临时表，有时候又不会，不太懂","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432859,"discussion_content":"你问着了，16、17就是说这个","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544874599,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49991,"user_name":"当下","can_delete":false,"product_type":"c1","uid":1304326,"ip_address":"","ucode":"2B8B003F94BC07","user_header":"https://static001.geekbang.org/account/avatar/00/13/e7/06/76ee65a1.jpg","comment_is_top":false,"comment_ctime":1544827751,"is_pvip":false,"replies":[{"id":"18007","content":"并发插入之间并不会，但是会影响update语句","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544846206,"ip_address":"","comment_id":49991,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544827751","product_id":100020801,"comment_content":"并发插入会产生锁阻塞吗？如果有是怎么导致的;如果没有锁阻塞，并发插入对表的其他操作有什么影响?","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432830,"discussion_content":"并发插入之间并不会，但是会影响update语句","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544846206,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49990,"user_name":"当下","can_delete":false,"product_type":"c1","uid":1304326,"ip_address":"","ucode":"2B8B003F94BC07","user_header":"https://static001.geekbang.org/account/avatar/00/13/e7/06/76ee65a1.jpg","comment_is_top":false,"comment_ctime":1544827375,"is_pvip":false,"replies":[{"id":"18016","content":"其实主要就是一致性问题","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544874654,"ip_address":"","comment_id":49990,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544827375","product_id":100020801,"comment_content":"应用中经常有多表联接不同维度不粒度count,sum数据计算和统计，粒度越细计算越复杂，却又要时实性。用redis或者数据库缓存数据要怎么实现，又要注意什么事项?<br><br>","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432829,"discussion_content":"其实主要就是一致性问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544874654,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49959,"user_name":"银太","can_delete":false,"product_type":"c1","uid":1051765,"ip_address":"","ucode":"B505D15F7CB839","user_header":"https://static001.geekbang.org/account/avatar/00/10/0c/75/e7c6c403.jpg","comment_is_top":false,"comment_ctime":1544798215,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1544798215","product_id":100020801,"comment_content":"实际场景中基本没遇到不加条件查行数的业务，这种有什么好的建议吗？","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":158199,"discussion_content":"像这种加条件的，一般就只能直接执行计数了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580560949,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49954,"user_name":"君子幽幽","can_delete":false,"product_type":"c1","uid":1125551,"ip_address":"","ucode":"4C4841813945C4","user_header":"https://static001.geekbang.org/account/avatar/00/11/2c/af/1817e787.jpg","comment_is_top":false,"comment_ctime":1544797417,"is_pvip":false,"replies":[{"id":"17990","content":"不是… 这个跟幻读无关哦","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544800609,"ip_address":"","comment_id":49954,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544797417","product_id":100020801,"comment_content":"以前看书说可重复还是会出现幻读。但是现在A会话前后两次都读取1000。是不是MySQL 的可重复读已经不会出现幻读了？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432814,"discussion_content":"不是… 这个跟幻读无关哦","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544800609,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49935,"user_name":"陈天境","can_delete":false,"product_type":"c1","uid":1100792,"ip_address":"","ucode":"FF9EA3ACAAF864","user_header":"https://static001.geekbang.org/account/avatar/00/10/cb/f8/f4adadcb.jpg","comment_is_top":false,"comment_ctime":1544792798,"is_pvip":true,"replies":[{"id":"17978","content":"其实上万还好，如果再更多，就要考虑另外计数了，不过这种就没有固定方法了…","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544797495,"ip_address":"","comment_id":49935,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544792798","product_id":100020801,"comment_content":"索引条件过滤完后还多少行？如果行数少（几百行？）就没关系直接执行了<br>——还有上万行，这种怎么处理？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432808,"discussion_content":"其实上万还好，如果再更多，就要考虑另外计数了，不过这种就没有固定方法了…","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544797495,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49915,"user_name":"Ryoma","can_delete":false,"product_type":"c1","uid":1130590,"ip_address":"","ucode":"7F692369239692","user_header":"https://static001.geekbang.org/account/avatar/00/11/40/5e/b8fada94.jpg","comment_is_top":false,"comment_ctime":1544788886,"is_pvip":true,"replies":[{"id":"17980","content":"对，只要就是不准，不满足一致性条件","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544797562,"ip_address":"","comment_id":49915,"utype":1}],"discussion_count":1,"race_medal":2,"score":"1544788886","product_id":100020801,"comment_content":"我的意思是InnoDB为什么不像MyISAM一样，把count(*)的结果存储在磁盘上；然后通过事务id这种机制，在查询时能够返回当前事务能看见数据的行数——这个只是我的脑洞<br>是不是因为这个count(*)的意义不大，所以在InnoDB没有做这个实现","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432799,"discussion_content":"对，只要就是不准，不满足一致性条件","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544797562,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49874,"user_name":"Justin","can_delete":false,"product_type":"c1","uid":1305601,"ip_address":"","ucode":"D49723FEA66731","user_header":"https://static001.geekbang.org/account/avatar/00/13/ec/01/978d54af.jpg","comment_is_top":false,"comment_ctime":1544782938,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1544782938","product_id":100020801,"comment_content":"一直想问一个问题 如果在数据量很大的表中增加一个字段 innodb底层是怎么处理的呢 ？","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":158201,"discussion_content":"MDL写锁，表阻塞","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580561085,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49863,"user_name":"☞","can_delete":false,"product_type":"c1","uid":1302793,"ip_address":"","ucode":"6FAEF05F234D2A","user_header":"https://static001.geekbang.org/account/avatar/00/13/e1/09/9483f537.jpg","comment_is_top":false,"comment_ctime":1544781229,"is_pvip":false,"replies":[{"id":"18020","content":"没看懂，文章地址发下","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544875776,"ip_address":"","comment_id":49863,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544781229","product_id":100020801,"comment_content":"老师您好：<br>      之前看到文章说在5.7对于count(*)做了一次内部handler函数调用，可以快速获得表总数，不需要去遍历所有行数，这种情况能给提一下吗，也和count(1)效果差不多吗？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432792,"discussion_content":"没看懂，文章地址发下","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544875776,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49862,"user_name":"燕羽阳","can_delete":false,"product_type":"c1","uid":1015063,"ip_address":"","ucode":"AF9430187F66EE","user_header":"https://static001.geekbang.org/account/avatar/00/0f/7d/17/179b24f4.jpg","comment_is_top":false,"comment_ctime":1544781160,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1544781160","product_id":100020801,"comment_content":"count(*)操作<br>如果只有主键索引，由于主键索引下是行数据，会导致全表扫描，大量读盘。<br>如果有二级索引，由于二级索引下是主键和行字段，数据量很小。此时count会很快。<br>我这边测试没加二级索引，需要4分半<br>加了二级索引，只需要0.13秒","like_count":0},{"had_liked":false,"id":49853,"user_name":"坏淡一个","can_delete":false,"product_type":"c1","uid":1118181,"ip_address":"","ucode":"D9C39F4133D9D6","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eplMzkLgvebhLujCZI0DZAWS7MQGvYGHb4yeoDHdITVWpbSicvoVKw0dISm9ib3vYU7BqxrmuTV666g/132","comment_is_top":false,"comment_ctime":1544779962,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1544779962","product_id":100020801,"comment_content":"如果经过where条件筛选的数据，数据量仍然很大怎么办呢？比如管理台有很多查询条件，像省市县，只选了某个省，还有几百万的数据，虽然分页了，但还需要统计总数count(*)，速度很慢怎么办呢？这种情况一直没想到有什么完美的解决方案，只能从业务上入手吗？","like_count":0},{"had_liked":false,"id":49848,"user_name":"燕羽阳","can_delete":false,"product_type":"c1","uid":1015063,"ip_address":"","ucode":"AF9430187F66EE","user_header":"https://static001.geekbang.org/account/avatar/00/0f/7d/17/179b24f4.jpg","comment_is_top":false,"comment_ctime":1544779422,"is_pvip":false,"replies":[{"id":"18021","content":"统计主键索引数目 就是全表扫描呀😄","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544875852,"ip_address":"","comment_id":49848,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544779422","product_id":100020801,"comment_content":"count(*) 不可以直接统计主键索引的数量么？ 为何还要全表扫描？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432788,"discussion_content":"统计主键索引数目 就是全表扫描呀😄","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544875852,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49834,"user_name":"mongo","can_delete":false,"product_type":"c1","uid":1113124,"ip_address":"","ucode":"F39FE783793A17","user_header":"https://static001.geekbang.org/account/avatar/00/10/fc/24/7d43d807.jpg","comment_is_top":false,"comment_ctime":1544777746,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1544777746","product_id":100020801,"comment_content":"请问一个问题：我很想搞明白mysql这个程序的组成部分，最基本的增删改查功能的实现流程，内部的表文件和索引文件等都是怎么存储和怎么使用的。这个专栏很全面，但是我看的很吃力，很多基础知识我还没有掌握，我想请问有什么参考书籍推荐？","like_count":0},{"had_liked":false,"id":49803,"user_name":"念","can_delete":false,"product_type":"c1","uid":1113818,"ip_address":"","ucode":"866A800D49C498","user_header":"https://static001.geekbang.org/account/avatar/00/10/fe/da/01cfbdc6.jpg","comment_is_top":false,"comment_ctime":1544771811,"is_pvip":false,"replies":[{"id":"17942","content":"额其实我是为了展开文章说明后面的方案，方法应该还有的，你建议一个😄","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544777647,"ip_address":"","comment_id":49803,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544771811","product_id":100020801,"comment_content":"解决效率问题只有上面说的那种写表加redis方法了吗，没有其他的方法了吗","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432781,"discussion_content":"额其实我是为了展开文章说明后面的方案，方法应该还有的，你建议一个😄","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544777647,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49801,"user_name":"蚂蚁内推+v","can_delete":false,"product_type":"c1","uid":1050508,"ip_address":"","ucode":"24B10AEE54B3FD","user_header":"https://static001.geekbang.org/account/avatar/00/10/07/8c/0d886dcc.jpg","comment_is_top":false,"comment_ctime":1544771536,"is_pvip":false,"replies":[{"id":"17943","content":"就是跟count(*)一样","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544777666,"ip_address":"","comment_id":49801,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544771536","product_id":100020801,"comment_content":"老师  conunt(1) 的作用是什么方便解释下吗？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432780,"discussion_content":"就是跟count(*)一样","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544777666,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49793,"user_name":"布衣骇客","can_delete":false,"product_type":"c1","uid":1256280,"ip_address":"","ucode":"5226B0F67090D1","user_header":"https://static001.geekbang.org/account/avatar/00/13/2b/58/11c05ccb.jpg","comment_is_top":false,"comment_ctime":1544770264,"is_pvip":false,"replies":[{"id":"17945","content":"😁 印证了就好哈","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544777744,"ip_address":"","comment_id":49793,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544770264","product_id":100020801,"comment_content":"答案在评论区，想自己写下的，看完忍不住往下拉，还是多多看看评论了，嘿嘿","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432776,"discussion_content":"😁 印证了就好哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544777744,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49790,"user_name":"james","can_delete":false,"product_type":"c1","uid":1049208,"ip_address":"","ucode":"5701899403917C","user_header":"https://static001.geekbang.org/account/avatar/00/10/02/78/23c56bce.jpg","comment_is_top":false,"comment_ctime":1544769628,"is_pvip":false,"replies":[{"id":"17946","content":"哪本书… ","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544777761,"ip_address":"","comment_id":49790,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1544769628","product_id":100020801,"comment_content":"老师, 书上说 count(*) 会锁表是真的吗? ","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432775,"discussion_content":"哪本书… ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544777761,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":371438,"discussion_content":"这个锁是MDL锁吧，count(*)之后，别的会话就不能对表进行DDL操作了","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1619768923,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49786,"user_name":"老马世界","can_delete":false,"product_type":"c1","uid":1318643,"ip_address":"","ucode":"4DED3B5B36FFA6","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLWew5n1eKsUF308Gzq9LSn3oW029oAwqB8NicaVpZmeVVlDv6ynqaU6nmUCkXAbiaiaZ5nNpHFhNg0Q/132","comment_is_top":false,"comment_ctime":1544769325,"is_pvip":false,"replies":[{"id":"17938","content":"没有这种说法呀，如果col上有索引，然后满足=‘value’的又不多的话。吗，这样写没问题。<br><br>","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544772590,"ip_address":"","comment_id":49786,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544769325","product_id":100020801,"comment_content":"老师 能不能讲解一下有条件的count()查询原理。还有尽量减少 SELECT COUNT(*) FROM tablename WHERE COL = &#39;value’ 这种查询，这种说法对吗？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432772,"discussion_content":"没有这种说法呀，如果col上有索引，然后满足=‘value’的又不多的话。吗，这样写没问题。\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544772590,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49783,"user_name":"james","can_delete":false,"product_type":"c1","uid":1049208,"ip_address":"","ucode":"5701899403917C","user_header":"https://static001.geekbang.org/account/avatar/00/10/02/78/23c56bce.jpg","comment_is_top":false,"comment_ctime":1544768833,"is_pvip":false,"replies":[{"id":"17947","content":"嗯你说的方法就是文章中我们讨论的方法呀。<br><br>MySQL 不具备原子更新是啥意思","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544777828,"ip_address":"","comment_id":49783,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544768833","product_id":100020801,"comment_content":"计数表只有一行, 会有并发, 如果更新后, 事务不提交, 那么将阻塞别的事务更新总数, 而先插入数据则不会有这个问题, 别的事务仍然可以插入数据到同一张表, 因此我认为先插表, 后更新总数. <br>另外: MySQL 并不具备原子更新操作, 因此不会有人用 mysql 来记录总数, 而是用 redis 的原子自增 incr 来实现这个业务, 而且 redis 的 RDB + AOF 是可以持久化存储的","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432771,"discussion_content":"嗯你说的方法就是文章中我们讨论的方法呀。\n\nMySQL 不具备原子更新是啥意思","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544777828,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49765,"user_name":"wjz1991","can_delete":false,"product_type":"c1","uid":1311687,"ip_address":"","ucode":"D82D744F5A4E6D","user_header":"https://static001.geekbang.org/account/avatar/00/14/03/c7/563345e1.jpg","comment_is_top":false,"comment_ctime":1544765902,"is_pvip":false,"replies":[{"id":"17949","content":"就是bug ...","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544777902,"ip_address":"","comment_id":49765,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544765902","product_id":100020801,"comment_content":"老师，你能解释一下为什么吗？为什么优化器会选择错误的索引？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432764,"discussion_content":"就是bug ...","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544777902,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49764,"user_name":"流浪在寂寞古城","can_delete":false,"product_type":"c1","uid":1105678,"ip_address":"","ucode":"FE90DCD5DC3A20","user_header":"https://static001.geekbang.org/account/avatar/00/10/df/0e/4e2b06d5.jpg","comment_is_top":false,"comment_ctime":1544765801,"is_pvip":false,"replies":[{"id":"17950","content":"你这个问题会在后面的文章中说到哈","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544777944,"ip_address":"","comment_id":49764,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544765801","product_id":100020801,"comment_content":"问您个问题，我们查询的时候需要用到连表查询，都是比较大的表。一下子查出来数量太大了，很慢，内存也没那么大。于是我们采取把小的表读到内存中，大的主表按照时间来读，但还是很慢。这样的问题怎么解决呢？如果把整张表dump 到本地，然后全量自己排除不满足条件的。这样可行吗？有没有更好的办法呢<br>","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432763,"discussion_content":"你这个问题会在后面的文章中说到哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544777944,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49756,"user_name":"毛立凡","can_delete":false,"product_type":"c1","uid":1067251,"ip_address":"","ucode":"7B3BD84187D39D","user_header":"https://static001.geekbang.org/account/avatar/00/10/48/f3/e7f9a26b.jpg","comment_is_top":false,"comment_ctime":1544764211,"is_pvip":false,"replies":[{"id":"17952","content":"额，怕引起数据库之争，general 的对比就不做了。<br>如果有具体场景我会提到的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544778023,"ip_address":"","comment_id":49756,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544764211","product_id":100020801,"comment_content":"工作中使用较多的是PostgreSQL，但是也能在这个课程里学到很多东西，比如Innodb的东西，还有些设计原理等都是相通的，谢谢老师的精彩讲解。另外希望老师对于mysql独有的重要的特性，可以强调一下，如果能对比一下其他数据库，那就更好了。","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432760,"discussion_content":"额，怕引起数据库之争，general 的对比就不做了。\n如果有具体场景我会提到的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544778023,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49750,"user_name":"pandas","can_delete":false,"product_type":"c1","uid":1306672,"ip_address":"","ucode":"B680D836D6460E","user_header":"https://static001.geekbang.org/account/avatar/00/13/f0/30/bef112d3.jpg","comment_is_top":false,"comment_ctime":1544762576,"is_pvip":false,"replies":[{"id":"17918","content":"😄 嗯，希望不同关注点的同学都能有收获","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544763091,"ip_address":"","comment_id":49750,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544762576","product_id":100020801,"comment_content":"菜鸟的万精油:所以结论是：按照效率排序的话，count(字段)&lt;count(主键 id)&lt;count(1)≈count(*)，所以我建议你，尽量使用 count(*)。","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432759,"discussion_content":"😄 嗯，希望不同关注点的同学都能有收获","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544763091,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49739,"user_name":"Goal","can_delete":false,"product_type":"c1","uid":1307012,"ip_address":"","ucode":"C337CD4C7E07B0","user_header":"https://static001.geekbang.org/account/avatar/00/13/f1/84/7d21bd9e.jpg","comment_is_top":false,"comment_ctime":1544759552,"is_pvip":false,"replies":[{"id":"17922","content":"你可以理解为返回一个“空的行”","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544763443,"ip_address":"","comment_id":49739,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544759552","product_id":100020801,"comment_content":"老师好：有个问题不太理解：<br>1.  在保证逻辑正确的前提下，尽量减少扫描的数据量，是数据库系统设计的通用法则之一。也就是所 count(*) 相比于主键索引去扫描二级索引<br>2.  count(*) 是例外，并不会把全部字段取出来，而是专门做了优化，不取值。count(*) 肯定不是 null，按行累加。<br><br>这俩句话，感觉有点冲突，这里的不去取值，那怎么做到的统计呢？<br>","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432752,"discussion_content":"你可以理解为返回一个“空的行”","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544763443,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49736,"user_name":"wjz1991","can_delete":false,"product_type":"c1","uid":1311687,"ip_address":"","ucode":"D82D744F5A4E6D","user_header":"https://static001.geekbang.org/account/avatar/00/14/03/c7/563345e1.jpg","comment_is_top":false,"comment_ctime":1544759076,"is_pvip":false,"replies":[{"id":"17923","content":"建一个(is_delete,shop_price)的联合索引吧","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544763952,"ip_address":"","comment_id":49736,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544759076","product_id":100020801,"comment_content":"老师，还是想咨询一下mysql选错索引的问题，eload_goods表是没什么更新的，也做了alter table eload_goods engine=innodb操作，还是出现如下现象，老师能否对这个选错索引的专题进行更全面的讲解吗？<br>is_delete 是tinyint类型，shop_price是decimal类型<br>admin@buyinggoods_db 03:26&gt;explain select * from eload_goods where is_delete = 0   AND shop_price between 5 and 9.9 ;<br><br>| id | select_type | table       | type | possible_keys      | key       | key_len | ref   | rows    | Extra       |<br>+----+-------------+-------------+------+--------------------+-----------+---------+-------+---------+-------------+<br>|  1 | SIMPLE      | eload_goods | ref  | is_delete,idx_test | is_delete | 1       | const | 1100043 | Using where |<br><br>1 row in set (0.00 sec)<br><br>admin@buyinggoods_db 03:26&gt;explain select * from eload_goods where shop_price between 5 and 9.9 ;<br><br>| id | select_type | table       | type  | possible_keys | key      | key_len | ref  | rows   | Extra                 |<br>+----+-------------+-------------+-------+---------------+----------+---------+------+--------+-----------------------+<br>|  1 | SIMPLE      | eload_goods | range | idx_test      | idx_test | 5       | NULL | 522330 | Using index condition |<br><br>1 row in set (0.00 sec)<br><br>admin@buyinggoods_db 03:33&gt;select count(1) from eload_goods;<br>+----------+<br>| count(1) |<br>+----------+<br>|  2467784 |<br>+----------+<br>1 row in set (0.45 sec)<br><br>admin@buyinggoods_db 03:34&gt;select count(1) from eload_goods where is_delete = 0;<br><br>| count(1) |<br>+----------+<br>|  2466778 |<br><br>1 row in set (0.60 sec)<br><br>admin@buyinggoods_db 03:34&gt;select count(1) from eload_goods where shop_price between 5 and 9.9 ;<br><br>| count(1) |<br>+----------+<br>|   261113 |<br><br>1 row in set (0.12 sec)<br><br>admin@buyinggoods_db 03:35&gt;select count(1) from eload_goods force index(idx_test)  where is_delete = 0   AND shop_price between 5 and 9.9 ;<br><br>| count(1) |<br>+----------+<br>|   260978 |<br><br>1 row in set (1.30 sec)<br><br>admin@buyinggoods_db 03:38&gt;select count(1) from eload_goods where is_delete = 0   AND shop_price between 5 and 9.9 ;<br><br>| count(1) |<br>+----------+<br>|   260978 |<br><br>1 row in set (7.02 sec)","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432750,"discussion_content":"建一个(is_delete,shop_price)的联合索引吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544763952,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49735,"user_name":"user","can_delete":false,"product_type":"c1","uid":1307295,"ip_address":"","ucode":"3AA2D3DA955B4A","user_header":"https://static001.geekbang.org/account/avatar/00/13/f2/9f/b4af181c.jpg","comment_is_top":false,"comment_ctime":1544758788,"is_pvip":false,"replies":[{"id":"17920","content":"是因为二级索引小呀，这几个语句确实是优先选小的索引","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544763288,"ip_address":"","comment_id":49735,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544758788","product_id":100020801,"comment_content":"COUNT(*)，COUNT(id)， COUNT(1) 这部分的解释我有点儿疑问，在5.7的环境下，我去count的这三种情况的执行计划都是走的该表下面的一个二级索引，由于聚集索引和辅助索引是一对一的关系，null值在辅助索引里面有一个特殊的标记，所有在count的时候走二级索引是最优的。","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432749,"discussion_content":"是因为二级索引小呀，这几个语句确实是优先选小的索引","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544763288,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49715,"user_name":"WilliamX","can_delete":false,"product_type":"c1","uid":1295476,"ip_address":"","ucode":"E915091A891873","user_header":"https://static001.geekbang.org/account/avatar/00/13/c4/74/27cf551a.jpg","comment_is_top":false,"comment_ctime":1544756562,"is_pvip":false,"replies":[{"id":"17906","content":"要是细究的话，还要看是不是null, 以及字段大小。<br><br>还是count(*)吧😄","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544761372,"ip_address":"","comment_id":49715,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544756562","product_id":100020801,"comment_content":"如果count的字段，正好有索引，是不是可以和count（ID）等同?","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432741,"discussion_content":"要是细究的话，还要看是不是null, 以及字段大小。\n\n还是count(*)吧😄","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544761372,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49710,"user_name":"Ryoma","can_delete":false,"product_type":"c1","uid":1130590,"ip_address":"","ucode":"7F692369239692","user_header":"https://static001.geekbang.org/account/avatar/00/11/40/5e/b8fada94.jpg","comment_is_top":false,"comment_ctime":1544756027,"is_pvip":true,"replies":[{"id":"17921","content":"你是说查询语句里面带上？主要是客户端拿不到这个事务ID…","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544763389,"ip_address":"","comment_id":49710,"utype":1}],"discussion_count":1,"race_medal":2,"score":"1544756027","product_id":100020801,"comment_content":"有一个想法，数据表行数能结合事务id一起使用么，这样在查询行数的时候，根据事务当前的id做一个重放操作","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432737,"discussion_content":"你是说查询语句里面带上？主要是客户端拿不到这个事务ID…","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544763389,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49705,"user_name":"古娜拉黑暗之神·巴啦啦能量·堕落达","can_delete":false,"product_type":"c1","uid":1185642,"ip_address":"","ucode":"080BBCEF7DE985","user_header":"https://static001.geekbang.org/account/avatar/00/12/17/6a/c979163e.jpg","comment_is_top":false,"comment_ctime":1544755060,"is_pvip":false,"replies":[{"id":"17908","content":"1. 后面马上跟了一个有效查询，就简化写成begin了，比如session B 就是在“读C的记数值”<br><br>2. 一直就是这样，判断的话，只要你用的是&gt;=5.5就优化的。如果版本不满足，那应该升级了😄","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544762238,"ip_address":"","comment_id":49705,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544755060","product_id":100020801,"comment_content":"老师，看了这节课之后，有两个疑问，望能解答一下：<br>第一：您在《08-事务到底是隔离的还是不隔离的？》中讲过，begin&#47;start transaction;并不是一个事务的起点，所以本节 图1 中的“begin;”是不是应该是“start transaction with consistent snapshot”这个命令？<br>第二：MySQL专门针对 count(*) 做了优化，那么这个优化是在哪个版本加入的呢？如果公司使用的是优化之前的版本，是不是还是 count(1) 效率最高？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432734,"discussion_content":"1. 后面马上跟了一个有效查询，就简化写成begin了，比如session B 就是在“读C的记数值”\n\n2. 一直就是这样，判断的话，只要你用的是&amp;gt;=5.5就优化的。如果版本不满足，那应该升级了😄","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544762238,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49693,"user_name":"XD","can_delete":false,"product_type":"c1","uid":1079293,"ip_address":"","ucode":"DC9DCFB3841A4E","user_header":"https://static001.geekbang.org/account/avatar/00/10/77/fd/c6619535.jpg","comment_is_top":false,"comment_ctime":1544753097,"is_pvip":false,"replies":[{"id":"17909","content":"1. 只返回必须的字段<br><br>2. Server层知道呀，表结构就能判断","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544762306,"ip_address":"","comment_id":49693,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544753097","product_id":100020801,"comment_content":"对于 count(字段) 来说：<br><br>如果这个“字段”是定义为 not null 的话，一行行地从记录里面读出这个字段，判断不能为 null，按行累加；<br><br>如果这个“字段”定义允许为 null，那么执行的时候，判断到有可能是 null，还要把值取出来再判断一下，不是 null 才累加。<br><br>也就是前面的第一条原则，server 层要什么字段，InnoDB 就返回什么字段。<br><br>----<br><br>老师请教2个问题。<br>1，innodb返回的每一行记录里只有指定字段的值对吗？<br>2，如果innodb只返回数据的话，sever层并不知道这个字段是否限制了not null，那它在计数的时候是不是只能都取出来判断一次呢？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432727,"discussion_content":"1. 只返回必须的字段\n\n2. Server层知道呀，表结构就能判断","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544762306,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49690,"user_name":"峰","can_delete":false,"product_type":"c1","uid":1056019,"ip_address":"","ucode":"C53CB64E8E7D19","user_header":"https://static001.geekbang.org/account/avatar/00/10/1d/13/31ea1b0b.jpg","comment_is_top":false,"comment_ctime":1544752916,"is_pvip":true,"replies":[{"id":"17911","content":"没理解你说的，这样增加挺大的额外存储成本","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544762641,"ip_address":"","comment_id":49690,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544752916","product_id":100020801,"comment_content":"问题 为什么不可以换种思路实现表总体记录总数的持久化存储呢？比如表记录是一个只会加或减的统计指标，并且更新不需要再读取它，所以我只需记录某事务增加一条记录，某事务减少多少条记录，coun(*)在这个基础上采用mvcc去得到当前会话下的表记录总数不是用不着扫描全表。当然这样做，无疑增加了代码的复杂度，算是一种定制优化。而且增多了插入删除的操作。<br><br>老师，偶觉得不一样，核心不同在于上诉方案不用加锁，不是进行count=count+x操作，而是记录+x，当然后面肯定要合并，比如通过checkpoint。","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432725,"discussion_content":"没理解你说的，这样增加挺大的额外存储成本","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544762641,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49686,"user_name":"AstonPutting","can_delete":false,"product_type":"c1","uid":1303239,"ip_address":"","ucode":"1DB579A7922964","user_header":"https://static001.geekbang.org/account/avatar/00/13/e2/c7/d6a0927a.jpg","comment_is_top":false,"comment_ctime":1544752516,"is_pvip":false,"replies":[{"id":"17910","content":"都有","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544762333,"ip_address":"","comment_id":49686,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544752516","product_id":100020801,"comment_content":"老师，请问普通索引的叶子节点是只带有主键值还是带有主键值和索引所在列的数据。","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432722,"discussion_content":"都有","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544762333,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49680,"user_name":"kafka","can_delete":false,"product_type":"c1","uid":1310147,"ip_address":"","ucode":"D8189D71C0F3C6","user_header":"https://static001.geekbang.org/account/avatar/00/13/fd/c3/565f0c57.jpg","comment_is_top":false,"comment_ctime":1544751994,"is_pvip":false,"replies":[{"id":"17914","content":"那有点可怕了… ","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544762733,"ip_address":"","comment_id":49680,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544751994","product_id":100020801,"comment_content":"因为每个会话所能看到的count（*）不一致，我们用redis缓存记录count（*）计数值的时候，是不是需要对于每个会话都有一份count（*）缓存？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432717,"discussion_content":"那有点可怕了… ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544762733,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49664,"user_name":"慧鑫coming","can_delete":false,"product_type":"c1","uid":1324385,"ip_address":"","ucode":"7BAC9CA255630E","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLE4LYb3jrH63ZV98Zpc8DompwDgb1O3nffMoZCmiaibauRyEFv6NDNsST9RWxZExvMLMWb50zaanoQ/132","comment_is_top":false,"comment_ctime":1544750810,"is_pvip":false,"replies":[{"id":"17916","content":"普通select查询， 读不加读锁的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544762956,"ip_address":"","comment_id":49664,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544750810","product_id":100020801,"comment_content":"不好意思，晓斌老师，是我没讲清楚😂，是事务A要对计数值这个字段进行读操作，而此时事务B要对计数值这个字段进行＋1操作，(应该是同一行数据吧)，这样会不会A拿了计数值这行的读锁，事务B要等待它释放","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432709,"discussion_content":"普通select查询， 读不加读锁的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544762956,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49648,"user_name":"郭健","can_delete":false,"product_type":"c1","uid":1102204,"ip_address":"","ucode":"169645EBF3B46C","user_header":"https://static001.geekbang.org/account/avatar/00/10/d1/7c/4639f22c.jpg","comment_is_top":false,"comment_ctime":1544749715,"is_pvip":false,"replies":[{"id":"17879","content":"Redis跟MySQL 两个不同系统，你是怎么实现分布式事务的。说下你的设计","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544750649,"ip_address":"","comment_id":49648,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544749715","product_id":100020801,"comment_content":"老师，redis记录count的我有点疑问，在代码实现的，将redis和添加语句放在一个事务里不可以吗？两个都添加完在进行commit，外面就看不见不一致的问题了。","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432701,"discussion_content":"Redis跟MySQL 两个不同系统，你是怎么实现分布式事务的。说下你的设计","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544750649,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49631,"user_name":"Geek_477c02","can_delete":false,"product_type":"c1","uid":1218578,"ip_address":"","ucode":"CB9A714A50B977","user_header":"https://static001.geekbang.org/account/avatar/00/12/98/12/a169bdcd.jpg","comment_is_top":false,"comment_ctime":1544748464,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1544748464","product_id":100020801,"comment_content":"先插入再更新","like_count":0},{"had_liked":false,"id":49618,"user_name":"amazon1011","can_delete":false,"product_type":"c1","uid":1001032,"ip_address":"","ucode":"BD745BDCBD7059","user_header":"https://static001.geekbang.org/account/avatar/00/0f/46/48/e959b1e0.jpg","comment_is_top":false,"comment_ctime":1544747443,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1544747443","product_id":100020801,"comment_content":"先插入操作记录再更新记数表，减少计数表行锁的持有时间，但是这个计数表还是面临阻塞问题在高并发的情况下降低了系统的吞吐量","like_count":0},{"had_liked":false,"id":49612,"user_name":"handylin","can_delete":false,"product_type":"c1","uid":1318193,"ip_address":"","ucode":"23EC4EFDB5FFE6","user_header":"https://static001.geekbang.org/account/avatar/00/14/1d/31/dc8ea649.jpg","comment_is_top":false,"comment_ctime":1544747024,"is_pvip":false,"replies":[{"id":"17863","content":"默认的隔离级别是可重复读，<br>当然是可以手动改成读提交<br>","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544749706,"ip_address":"","comment_id":49612,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544747024","product_id":100020801,"comment_content":"为什么又说可重复读是innodb事务的级别呢， 不是读提交吗？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432686,"discussion_content":"默认的隔离级别是可重复读，\n当然是可以手动改成读提交\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544749706,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49607,"user_name":"峰","can_delete":false,"product_type":"c1","uid":1056019,"ip_address":"","ucode":"C53CB64E8E7D19","user_header":"https://static001.geekbang.org/account/avatar/00/10/1d/13/31ea1b0b.jpg","comment_is_top":false,"comment_ctime":1544746956,"is_pvip":true,"replies":[{"id":"17866","content":"我细细思考了一下你这个方案，<br>感觉本质上跟我们文中的方案是一致的…<br>","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544750086,"ip_address":"","comment_id":49607,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544746956","product_id":100020801,"comment_content":"更新计数应该后做，因为它的访问更新的并发度更大，应该尽量缩减占锁时间。<br><br>问题  为什么不可以换种思路实现表总体记录总数的持久化存储呢？比如表记录是一个只会加或减的统计指标，并且更新不需要再读取它，所以我只需记录某事务增加一条记录，某事务减少多少条记录，coun(*)在这个基础上采用mvcc去得到当前会话下的表记录总数不是用不着扫描全表。当然这样做，无疑增加了代码的复杂度，算是一种定制优化。而且增多了插入删除的操作。","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432685,"discussion_content":"我细细思考了一下你这个方案，\n感觉本质上跟我们文中的方案是一致的…\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544750086,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49595,"user_name":"Geek_06c355","can_delete":false,"product_type":"c1","uid":1181547,"ip_address":"","ucode":"238E29DC994E6F","user_header":"https://static001.geekbang.org/account/avatar/00/12/07/6b/a0a99de6.jpg","comment_is_top":false,"comment_ctime":1544744727,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1544744727","product_id":100020801,"comment_content":"先写入数据，后更新，因为更新表记录数是表纬度的热点操作，尽量少占用事务时间","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":158218,"discussion_content":"先插入再更新能最大程度减少事务之间的锁等待。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1580561978,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}