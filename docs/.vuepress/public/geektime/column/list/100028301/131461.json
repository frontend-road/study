{"id":131461,"title":"44 | OpenResty çš„æ€æ‰‹é”ï¼šåŠ¨æ€","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯æ¸©é“­ã€‚</p><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œå’Œ OpenResty æ€§èƒ½ç›¸å…³çš„å†…å®¹ï¼Œæˆ‘å°±å·®ä¸å¤šå¿«è¦ä»‹ç»å®Œäº†ã€‚æˆ‘ç›¸ä¿¡ï¼ŒæŒæ¡å¹¶çµæ´»è¿ç”¨å¥½è¿™äº›ä¼˜åŒ–æŠ€å·§ï¼Œä¸€å®šå¯ä»¥è®©ä½ çš„ä»£ç æ€§èƒ½æå‡ä¸€ä¸ªæ•°é‡çº§ã€‚ä»Šå¤©ï¼Œåœ¨æ€§èƒ½ä¼˜åŒ–çš„æœ€åä¸€ä¸ªéƒ¨åˆ†ï¼Œæˆ‘æ¥è®²ä¸€è®² OpenResty ä¸­è¢«æ™®éä½ä¼°çš„ä¸€ç§èƒ½åŠ›ï¼šåŠ¨æ€ã€‚</p><p>è®©æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ä»€ä¹ˆæ˜¯åŠ¨æ€ï¼Œä»¥åŠå®ƒå’Œæ€§èƒ½ä¹‹é—´æœ‰ä»€ä¹ˆæ ·çš„å…³ç³»ã€‚</p><p>è¿™é‡Œçš„åŠ¨æ€ï¼ŒæŒ‡çš„æ˜¯ç¨‹åºå¯ä»¥åœ¨è¿è¡Œæ—¶ã€åœ¨ä¸é‡æ–°åŠ è½½çš„æƒ…å†µä¸‹ï¼Œå»ä¿®æ”¹å‚æ•°ã€é…ç½®ï¼Œä¹ƒè‡³ä¿®æ”¹è‡ªèº«çš„ä»£ç ã€‚å…·ä½“åˆ° Nginx å’Œ OpenResty é¢†åŸŸï¼Œä½ å»ä¿®æ”¹ä¸Šæ¸¸ã€SSL è¯ä¹¦ã€é™æµé™é€Ÿé˜ˆå€¼ï¼Œè€Œä¸ç”¨é‡å¯æœåŠ¡ï¼Œå°±å±äºå®ç°äº†åŠ¨æ€ã€‚è‡³äºåŠ¨æ€å’Œæ€§èƒ½ä¹‹é—´çš„å…³ç³»ï¼Œå¾ˆæ˜¾ç„¶ï¼Œå¦‚æœè¿™å‡ ç±»æ“ä½œä¸èƒ½åŠ¨æ€åœ°å®Œæˆï¼Œé‚£ä¹ˆé¢‘ç¹çš„ reload Nginx æœåŠ¡ï¼Œè‡ªç„¶å°±ä¼šå¸¦æ¥æ€§èƒ½çš„æŸè€—ã€‚</p><p>ä¸è¿‡ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œå¼€æºç‰ˆæœ¬çš„ Nginx å¹¶ä¸æ”¯æŒåŠ¨æ€ç‰¹æ€§ï¼Œæ‰€ä»¥ï¼Œä½ è¦å¯¹ä¸Šæ¸¸ã€SSL è¯ä¹¦åšå˜æ›´ï¼Œå°±å¿…é¡»é€šè¿‡ä¿®æ”¹é…ç½®æ–‡ä»¶ã€é‡å¯æœåŠ¡çš„æ–¹å¼æ‰èƒ½ç”Ÿæ•ˆã€‚è€Œå•†ä¸šç‰ˆæœ¬çš„ Nginx Plus æä¾›äº†éƒ¨åˆ†åŠ¨æ€çš„èƒ½åŠ›ï¼Œä½ å¯ä»¥ç”¨ REST API æ¥å®Œæˆæ›´æ–°ï¼Œä½†è¿™æœ€å¤šç®—æ˜¯ä¸€ä¸ªä¸å¤Ÿå½»åº•çš„æ”¹è‰¯ã€‚</p><p>ä½†æ˜¯ï¼Œåœ¨ OpenResty ä¸­ï¼Œè¿™äº›æ¡æ¢éƒ½æ˜¯ä¸å­˜åœ¨çš„ï¼ŒåŠ¨æ€å¯ä»¥è¯´å°±æ˜¯ OpenResty çš„æ€æ‰‹é”ã€‚ä½ å¯èƒ½çº³é—·å„¿ï¼Œä¸ºä»€ä¹ˆåŸºäº Nginx çš„ OpenResty å´å¯ä»¥æ”¯æŒåŠ¨æ€å‘¢ï¼ŸåŸå› ä¹Ÿå¾ˆç®€å•ï¼ŒNginx çš„é€»è¾‘æ˜¯é€šè¿‡ C æ¨¡å—æ¥å®Œæˆçš„ï¼Œè€Œ OpenResty æ˜¯é€šè¿‡è„šæœ¬è¯­è¨€ Lua æ¥å®Œæˆçš„â€”â€”è„šæœ¬è¯­è¨€çš„ä¸€å¤§ä¼˜åŠ¿ï¼Œä¾¿æ˜¯è¿è¡Œæ—¶å¯ä»¥å»åšåŠ¨æ€åœ°æ”¹å˜ã€‚</p><!-- [[[read_end]]] --><h2>åŠ¨æ€åŠ è½½ä»£ç </h2><p>ä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹çœ‹ï¼Œå¦‚ä½•åœ¨ OpenResty ä¸­åŠ¨æ€åœ°åŠ è½½ Lua ä»£ç ï¼š</p><pre><code>resty -e 'local s = [[ngx.say(&quot;hello world&quot;)]]\nlocal func, err = loadstring(s)\nfunc()'\n</code></pre><p>ä½ æ²¡æœ‰çœ‹é”™ï¼Œåªè¦çŸ­çŸ­çš„ä¸¤ä¸‰è¡Œä»£ç ï¼Œå°±å¯ä»¥æŠŠä¸€ä¸ªå­—ç¬¦ä¸²å˜ä¸ºä¸€ä¸ª Lua å‡½æ•°ï¼Œå¹¶è¿è¡Œèµ·æ¥ã€‚æˆ‘ä»¬è¿›ä¸€æ­¥ä»”ç»†çœ‹ä¸‹è¿™å‡ è¡Œä»£ç ï¼Œæˆ‘æ¥ç®€å•è§£è¯»ä¸€ä¸‹ï¼š</p><ul>\n<li>é¦–å…ˆï¼Œæˆ‘ä»¬å£°æ˜äº†ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå®ƒçš„å†…å®¹æ˜¯ä¸€æ®µåˆæ³•çš„ Lua ä»£ç ï¼ŒæŠŠ <code>hello world</code> æ‰“å°å‡ºæ¥ï¼›</li>\n<li>ç„¶åï¼Œä½¿ç”¨ Lua ä¸­çš„ <code>loadstring</code> å‡½æ•°ï¼ŒæŠŠå­—ç¬¦ä¸²å¯¹è±¡è½¬ä¸ºå‡½æ•°å¯¹è±¡<code>func</code>ï¼›</li>\n<li>æœ€åï¼Œåœ¨å‡½æ•°åçš„åé¢åŠ ä¸Šæ‹¬å·ï¼ŒæŠŠ <code>func</code> æ‰§è¡Œèµ·æ¥ï¼Œæ‰“å°å‡º <code>hello world</code> æ¥ã€‚</li>\n</ul><p>å½“ç„¶ï¼Œåœ¨è¿™æ®µä»£ç çš„åŸºç¡€ä¹‹ä¸Šï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æ‰©å±•å‡ºæ›´å¤šå¥½ç©å’Œå®ç”¨çš„åŠŸèƒ½ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘å°±å¸¦ä½ ä¸€èµ·æ¥â€œå°å°é²œâ€ã€‚</p><h2>åŠŸèƒ½ä¸€ï¼šFaaS</h2><p>é¦–å…ˆæ˜¯å‡½æ•°å³æœåŠ¡ï¼Œè¿™æ˜¯è¿‘å¹´æ¥å¾ˆçƒ­é—¨çš„æŠ€æœ¯æ–¹å‘ï¼Œæˆ‘ä»¬çœ‹ä¸‹åœ¨ OpenResty ä¸­å¦‚ä½•å®ç°ã€‚åœ¨åˆšåˆšçš„ä»£ç ä¸­ï¼Œå­—ç¬¦ä¸²æ˜¯ä¸€æ®µ Lua ä»£ç ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æŠŠå®ƒæ”¹æˆä¸€ä¸ª Lua å‡½æ•°ï¼š</p><pre><code>local s = [[\n return function()\n     ngx.say(&quot;hello world&quot;)\nend\n]]\n</code></pre><p>æˆ‘ä»¬è®²è¿‡ï¼Œå‡½æ•°åœ¨ Lua ä¸­æ˜¯ä¸€ç­‰å…¬æ°‘ï¼Œè¿™æ®µä»£ç ä¾¿æ˜¯è¿”å›äº†ä¸€ä¸ªåŒ¿åå‡½æ•°ã€‚åœ¨æ‰§è¡Œè¿™ä¸ªåŒ¿åå‡½æ•°æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>pcall</code> åšäº†ä¸€å±‚ä¿æŠ¤ã€‚<code>pcall</code> ä¼šåœ¨ä¿æŠ¤æ¨¡å¼ä¸‹è¿è¡Œå‡½æ•°ï¼Œå¹¶æ•è·å…¶ä¸­çš„å¼‚å¸¸ï¼Œå¦‚æœæ­£å¸¸å°±è¿”å› true å’Œæ‰§è¡Œçš„ç»“æœï¼Œå¦‚æœå¤±è´¥å°±è¿”å› false å’Œé”™è¯¯ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯ä¸‹é¢è¿™æ®µä»£ç ï¼š</p><pre><code>local func1, err = loadstring(s)\nlocal ret, func = pcall(func1)\n</code></pre><p>è‡ªç„¶ï¼ŒæŠŠä¸Šé¢çš„ä¸¤éƒ¨åˆ†ç»“åˆèµ·æ¥ï¼Œå°±ä¼šå¾—åˆ°å®Œæ•´çš„ã€å¯è¿è¡Œçš„ç¤ºä¾‹ï¼š</p><pre><code>resty -e 'local s = [[\n return function()\n    ngx.say(&quot;hello world&quot;)\nend\n]]\nlocal  func1 = loadstring(s)\nlocal ret, func = pcall(func1)\nfunc()'\n</code></pre><p>æ›´æ·±å…¥ä¸€æ­¥ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æŠŠ <code>s</code> è¿™ä¸ªåŒ…å«å‡½æ•°çš„å­—ç¬¦ä¸²ï¼Œæ”¹æˆå¯ä»¥ç”±ç”¨æˆ·æŒ‡å®šçš„å½¢å¼ï¼Œå¹¶åŠ ä¸Šæ‰§è¡Œå®ƒçš„æ¡ä»¶ï¼Œè¿™æ ·å…¶å®å°±æ˜¯ FaaS çš„åŸå‹äº†ã€‚è¿™é‡Œï¼Œæˆ‘æä¾›äº†ä¸€ä¸ªå®Œæ•´çš„<a href=\"https://github.com/apache/incubator-apisix/blob/master/apisix/plugins/serverless.lua\">å®ç°</a>ï¼Œå¦‚æœä½ å¯¹FaaSæ„Ÿå…´è¶£ï¼Œæƒ³è¦ç»§ç»­ç ”ç©¶ï¼Œæ¨èä½ é€šè¿‡è¿™ä¸ªé“¾æ¥æ·±å…¥å­¦ä¹ ã€‚</p><h2>åŠŸèƒ½äºŒï¼šè¾¹ç¼˜è®¡ç®—</h2><p>OpenResty çš„åŠ¨æ€ä¸ä»…å¯ä»¥ç”¨äº FaaSï¼Œè®©è„šæœ¬è¯­è¨€çš„åŠ¨æ€ç»†åŒ–åˆ°å‡½æ•°çº§åˆ«ï¼Œè¿˜å¯ä»¥åœ¨è¾¹ç¼˜è®¡ç®—ä¸Šå‘æŒ¥åŠ¨æ€çš„ä¼˜åŠ¿ã€‚</p><p>å¾—ç›Šäº Nginx å’Œ LuaJIT è‰¯å¥½çš„å¤šå¹³å°æ”¯æŒç‰¹æ€§ï¼ŒOpenResty ä¸ä»…èƒ½è¿è¡Œåœ¨ X86 æ¶æ„ä¸‹ï¼Œå¯¹äº ARM çš„æ”¯æŒä¹Ÿå¾ˆå®Œå–„ã€‚åŒæ—¶ï¼Œ OpenResty æ”¯æŒä¸ƒå±‚å’Œå››å±‚çš„ä»£ç†ï¼Œè¿™æ ·ä¸€æ¥ï¼Œå¸¸è§çš„å„ç§åè®®éƒ½å¯ä»¥è¢« OpenResty è§£æå’Œä»£ç†ï¼Œè¿™å…¶ä¸­ä¹ŸåŒ…æ‹¬äº† IoT ä¸­çš„å‡ ç§åè®®ã€‚</p><p>å› ä¸ºè¿™äº›ä¼˜åŠ¿ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥æŠŠ OpenResty çš„è§¦è§’ï¼Œä» API ç½‘å…³ã€WAFã€web æœåŠ¡å™¨ç­‰æœåŠ¡ç«¯çš„é¢†åŸŸï¼Œä¼¸å±•åˆ°ç‰©è”ç½‘è®¾å¤‡ã€CDN è¾¹ç¼˜èŠ‚ç‚¹ã€è·¯ç”±å™¨ç­‰æœ€é è¿‘ç”¨æˆ·çš„è¾¹ç¼˜èŠ‚ç‚¹ä¸Šå»ã€‚</p><p>è¿™å¹¶éåªæ˜¯ä¸€ç§ç•…æƒ³ï¼Œäº‹å®ä¸Šï¼ŒOpenResty å·²ç»åœ¨ä¸Šè¿°é¢†åŸŸä¸­è¢«å¤§é‡ä½¿ç”¨äº†ã€‚ä»¥ CDN çš„è¾¹ç¼˜èŠ‚ç‚¹ä¸ºä¾‹ï¼ŒOpenResty çš„æœ€å¤§ä½¿ç”¨è€… CloudFlare å¾ˆæ—©å°±å€ŸåŠ© OpenResty çš„åŠ¨æ€ç‰¹æ€§ï¼Œå®ç°äº†å¯¹äº CDN è¾¹ç¼˜èŠ‚ç‚¹çš„åŠ¨æ€æ§åˆ¶ã€‚</p><p>CloudFlare çš„åšæ³•å’Œä¸Šé¢åŠ¨æ€åŠ è½½ä»£ç çš„åŸç†æ˜¯ç±»ä¼¼çš„ï¼Œå¤§æ¦‚å¯ä»¥åˆ†ä¸ºä¸‹é¢å‡ ä¸ªæ­¥éª¤ï¼š</p><ul>\n<li>é¦–å…ˆï¼Œä»é”®å€¼æ•°æ®åº“é›†ç¾¤ä¸­è·å–åˆ°æœ‰å˜åŒ–çš„ä»£ç æ–‡ä»¶ï¼Œè·å–çš„æ–¹å¼å¯ä»¥æ˜¯åå° timer è½®è¯¢ï¼Œä¹Ÿå¯ä»¥æ˜¯ç”¨â€œå‘å¸ƒ-è®¢é˜…â€çš„æ¨¡å¼æ¥ç›‘å¬ï¼›</li>\n<li>ç„¶åï¼Œç”¨æ›´æ–°çš„ä»£ç æ–‡ä»¶æ›¿æ¢æœ¬åœ°ç£ç›˜çš„æ—§æ–‡ä»¶ï¼Œç„¶åä½¿ç”¨ <code>loadstring</code> å’Œ <code>pcall</code>çš„æ–¹å¼ï¼Œæ¥æ›´æ–°å†…å­˜ä¸­åŠ è½½çš„ç¼“å­˜ï¼›</li>\n</ul><p>è¿™æ ·ï¼Œä¸‹ä¸€ä¸ªè¢«å¤„ç†çš„ç»ˆç«¯è¯·æ±‚ï¼Œå°±ä¼šèµ°æ›´æ–°åçš„ä»£ç é€»è¾‘ã€‚</p><p>å½“ç„¶ï¼Œå®é™…çš„åº”ç”¨è¦æ¯”ä¸Šé¢çš„æ­¥éª¤è€ƒè™‘æ›´å¤šçš„ç»†èŠ‚ï¼Œæ¯”å¦‚ç‰ˆæœ¬çš„æ§åˆ¶å’Œå›é€€ã€å¼‚å¸¸çš„å¤„ç†ã€ç½‘ç»œçš„ä¸­æ–­ã€è¾¹ç¼˜èŠ‚ç‚¹çš„é‡å¯ç­‰ï¼Œä½†æ•´ä½“çš„æµç¨‹æ˜¯ä¸å˜çš„ã€‚</p><p>å¦‚æœæŠŠ CloudFlare çš„è¿™å¥—åšæ³•ï¼Œä» CDN è¾¹ç¼˜èŠ‚ç‚¹æŒªç§»åˆ°å…¶ä»–è¾¹ç¼˜çš„åœºæ™¯ä¸‹ï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥æŠŠå¾ˆå¤šè®¡ç®—èƒ½åŠ›åŠ¨æ€åœ°èµ‹äºˆè¾¹ç¼˜èŠ‚ç‚¹çš„è®¾å¤‡ã€‚è¿™ä¸ä»…å¯ä»¥å……åˆ†åˆ©ç”¨è¾¹ç¼˜èŠ‚ç‚¹çš„è®¡ç®—èƒ½åŠ›ï¼Œä¹Ÿå¯ä»¥è®©ç”¨æˆ·è¯·æ±‚å¾—åˆ°æ›´å¿«é€Ÿçš„å“åº”ã€‚å› ä¸ºè¾¹ç¼˜èŠ‚ç‚¹ä¼šæŠŠåŸå§‹æ•°æ®å¤„ç†è¿‡åï¼Œå†æ±‡æ€»ç»™è¿œç«¯çš„æœåŠ¡å™¨ï¼Œè¿™å°±å¤§å¤§å‡å°‘äº†æ•°æ®çš„ä¼ è¾“é‡ã€‚</p><p>ä¸è¿‡ï¼Œè¦æŠŠ FaaS å’Œè¾¹ç¼˜è®¡ç®—åšå¥½ï¼ŒOpenResty çš„åŠ¨æ€åªæ˜¯ä¸€ä¸ªè‰¯å¥½çš„åŸºç¡€ï¼Œä½ è¿˜éœ€è¦è€ƒè™‘è‡ªèº«å‘¨è¾¹ç”Ÿæ€çš„å®Œå–„å’Œå‚å•†çš„åŠ å…¥ï¼Œè¿™å°±ä¸ä»…ä»…æ˜¯æŠ€æœ¯çš„èŒƒç•´äº†ã€‚</p><h2>åŠ¨æ€ä¸Šæ¸¸</h2><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬æŠŠæ€ç»ªæ‹‰å›åˆ° OpenResty ä¸Šæ¥ï¼Œä¸€èµ·æ¥çœ‹å¦‚ä½•å®ç°åŠ¨æ€ä¸Šæ¸¸ã€‚<code>lua-resty-core</code> æä¾›äº† <code>ngx.balancer</code> è¿™ä¸ªåº“æ¥è®¾ç½®ä¸Šæ¸¸ï¼Œå®ƒéœ€è¦æ”¾åˆ° OpenResty çš„ <code>balancer</code> é˜¶æ®µæ¥è¿è¡Œï¼š</p><pre><code>balancer_by_lua_block {\n    local balancer = require &quot;ngx.balancer&quot;\n    local host = &quot;127.0.0.2&quot;\n    local port = 8080\n\n    local ok, err = balancer.set_current_peer(host, port)\n    if not ok then\n        ngx.log(ngx.ERR, &quot;failed to set the current peer: &quot;, err)\n        return ngx.exit(500)\n    end\n}\n</code></pre><p>æˆ‘æ¥ç®€å•è§£é‡Šä¸€ä¸‹ã€‚<code>set_current_peer</code> å‡½æ•°ï¼Œå°±æ˜¯ç”¨æ¥è®¾ç½®ä¸Šæ¸¸çš„ IP åœ°å€å’Œç«¯å£çš„ã€‚ä¸è¿‡è¦æ³¨æ„ï¼Œè¿™é‡Œå¹¶ä¸æ”¯æŒåŸŸåï¼Œä½ éœ€è¦ä½¿ç”¨ <code>lua-resty-dns</code> åº“æ¥ä¸ºåŸŸåå’Œ IP åšä¸€å±‚è§£æã€‚</p><p>ä¸è¿‡ï¼Œ<code>ngx.balancer</code> è¿˜æ¯”è¾ƒåº•å±‚ï¼Œè™½ç„¶å®ƒæœ‰è®¾ç½®ä¸Šæ¸¸çš„èƒ½åŠ›ï¼Œä½†åŠ¨æ€ä¸Šæ¸¸çš„å®ç°è¿œéå¦‚æ­¤ç®€å•ã€‚æ‰€ä»¥ï¼Œåœ¨ <code>ngx.balancer</code> å‰é¢è¿˜éœ€è¦ä¸¤ä¸ªåŠŸèƒ½ï¼š</p><ul>\n<li>ä¸€æ˜¯ä¸Šæ¸¸çš„é€‰æ‹©ç®—æ³•ï¼Œç©¶ç«Ÿæ˜¯ä¸€è‡´æ€§å“ˆå¸Œï¼Œè¿˜æ˜¯ roundrobinï¼›</li>\n<li>äºŒæ˜¯ä¸Šæ¸¸çš„å¥åº·æ£€æŸ¥æœºåˆ¶ï¼Œè¿™ä¸ªæœºåˆ¶éœ€è¦å‰”é™¤æ‰ä¸å¥åº·çš„ä¸Šæ¸¸ï¼Œå¹¶ä¸”éœ€è¦åœ¨ä¸å¥åº·çš„ä¸Šæ¸¸å˜å¥åº·çš„æ—¶å€™ï¼Œé‡æ–°æŠŠå®ƒåŠ å…¥è¿›æ¥ã€‚</li>\n</ul><p>è€ŒOpenResty å®˜æ–¹çš„ <code>lua-resty-balancer</code> <a href=\"https://github.com/openresty/lua-resty-balancer\">è¿™ä¸ªåº“</a>ä¸­ï¼Œåˆ™åŒ…å«äº† <code>resty.chash</code> å’Œ <code>resty.roundrobin</code> ä¸¤ç±»ç®—æ³•æ¥å®Œæˆç¬¬ä¸€ä¸ªåŠŸèƒ½ï¼Œå¹¶ä¸”æœ‰ <code>lua-resty-upstream-healthcheck</code> æ¥å°è¯•å®Œæˆç¬¬äºŒä¸ªåŠŸèƒ½ã€‚</p><p>ä¸è¿‡ï¼Œè¿™å…¶ä¸­è¿˜æ˜¯æœ‰ä¸¤ä¸ªé—®é¢˜ã€‚</p><p>ç¬¬ä¸€ç‚¹ï¼Œç¼ºå°‘æœ€åä¸€å…¬é‡Œçš„å®Œæ•´å®ç°ã€‚æŠŠ <code>ngx.balancer</code>ã€<code>lua-resty-balancer</code> å’Œ <code>lua-resty-upstream-healthcheck</code> æ•´åˆå¹¶å®ç°åŠ¨æ€ä¸Šæ¸¸çš„åŠŸèƒ½ï¼Œè¿˜æ˜¯éœ€è¦ä¸€äº›å·¥ä½œé‡çš„ï¼Œè¿™å°±æ‹¦ä½äº†å¤§éƒ¨åˆ†çš„å¼€å‘è€…ã€‚</p><p>ç¬¬äºŒç‚¹ï¼Œ<code>lua-resty-upstream-healthcheck</code> çš„å®ç°å¹¶ä¸å®Œæ•´ï¼Œåªæœ‰è¢«åŠ¨çš„å¥åº·æ£€æŸ¥ï¼Œè€Œæ²¡æœ‰ä¸»åŠ¨çš„å¥åº·æ£€æŸ¥ã€‚</p><p>ç®€å•è§£é‡Šä¸€ä¸‹ï¼Œè¿™é‡Œçš„è¢«åŠ¨å¥åº·æ£€æŸ¥ï¼Œæ˜¯æŒ‡ç”±ç»ˆç«¯çš„è¯·æ±‚è§¦å‘ï¼Œè¿›è€Œåˆ†æä¸Šæ¸¸çš„è¿”å›å€¼æ¥ä½œä¸ºå¥åº·ä¸å¦çš„åˆ¤æ–­æ¡ä»¶ã€‚å¦‚æœæ²¡æœ‰ç»ˆç«¯è¯·æ±‚ï¼Œé‚£ä¹ˆä¸Šæ¸¸æ˜¯å¦å¥åº·å°±æ— ä»å¾—çŸ¥äº†ã€‚è€Œä¸»åŠ¨å¥åº·æ£€æŸ¥å°±å¯ä»¥å¼¥è¡¥è¿™ä¸ªç¼ºé™·ï¼Œå®ƒä½¿ç”¨ <code>ngx.timer</code> å®šæ—¶å»è½®è¯¢æŒ‡å®šçš„ä¸Šæ¸¸æ¥å£ï¼Œæ¥æ£€æµ‹å¥åº·çŠ¶æ€ã€‚</p><p>æ‰€ä»¥ï¼Œåœ¨å®é™…çš„å®è·µä¸­ï¼Œæˆ‘ä»¬é€šå¸¸æ¨èä½¿ç”¨ <code>lua-resty-healthcheck</code> è¿™ä¸ª<a href=\"https://github.com/Kong/lua-resty-healthcheck\">åº“</a>ï¼Œæ¥å®Œæˆä¸Šæ¸¸çš„å¥åº·æ£€æŸ¥ã€‚å®ƒçš„ä¼˜ç‚¹æ˜¯åŒ…å«äº†ä¸»åŠ¨å’Œè¢«åŠ¨çš„å¥åº·æ£€æŸ¥ï¼Œè€Œä¸”åœ¨å¤šä¸ªé¡¹ç›®ä¸­éƒ½ç»è¿‡äº†éªŒè¯ï¼Œå¯é æ€§æ›´é«˜ã€‚</p><p>æ›´è¿›ä¸€æ­¥ï¼Œæ–°å…´çš„å¾®æœåŠ¡ API ç½‘å…³APISIXï¼Œåœ¨ <code>lua-resty-healthcheck</code> çš„åŸºç¡€ä¹‹ä¸Šï¼Œå¯¹åŠ¨æ€ä¸Šæ¸¸åšäº†å®Œæ•´çš„å®ç°ã€‚æˆ‘ä»¬å¯ä»¥å‚è€ƒå®ƒçš„<a href=\"https://github.com/iresty/apisix/blob/master/lua/apisix/http/balancer.lua\">å®ç°</a>ï¼Œæ€»å…±åªæœ‰ 200 å¤šè¡Œä»£ç ï¼Œä½ å¯ä»¥å¾ˆè½»æ¾åœ°æŠŠå®ƒå‰¥ç¦»å‡ºæ¥ï¼Œæ”¾åˆ°ä½ çš„è‡ªå·±çš„é¡¹ç›®ä¸­ä½¿ç”¨ã€‚</p><h2>å†™åœ¨æœ€å</h2><p>è®²äº†è¿™ä¹ˆå¤šï¼Œæœ€åï¼Œç»™ä½ ç•™ä¸€ä¸ªæ€è€ƒé¢˜ã€‚å…³äºOpenResty çš„åŠ¨æ€ï¼Œä½ è§‰å¾—è¿˜å¯ä»¥åœ¨å“ªäº›é¢†åŸŸå’Œåœºæ™¯æ¥å‘æŒ¥å®ƒçš„è¿™ç§ä¼˜åŠ¿å‘¢ï¼Ÿæé†’ä¸€ä¸‹ï¼Œè¿™ä¸ªç« èŠ‚ä¸­ä»‹ç»çš„æ¯éƒ¨åˆ†çš„å†…å®¹ï¼Œä½ éƒ½å¯ä»¥å±•å¼€æ¥åšæ›´è¯¦ç»†å’Œæ·±å…¥çš„åˆ†æã€‚</p><p>æ¬¢è¿ç•™è¨€å’Œæˆ‘è®¨è®ºï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™ç¯‡æ–‡ç« åˆ†äº«å‡ºå»ï¼Œå’Œæ›´å¤šçš„äººä¸€èµ·å­¦ä¹ ã€è¿›æ­¥ã€‚</p>","neighbors":{"left":{"article_title":"43 | çµæ´»å®ç°åŠ¨æ€é™æµé™é€Ÿï¼Œå…¶å®æ²¡æœ‰é‚£ä¹ˆéš¾","id":129955},"right":{"article_title":"45 | ä¸å¾—ä¸æçš„èƒ½åŠ›å¤–å»¶ï¼šOpenRestyå¸¸ç”¨çš„ç¬¬ä¸‰æ–¹åº“","id":131665}},"comments":[{"had_liked":false,"id":130849,"user_name":"FF","can_delete":false,"product_type":"c1","uid":1001615,"ip_address":"","ucode":"26349F32B406D7","user_header":"https://static001.geekbang.org/account/avatar/00/0f/48/8f/7ecd4eed.jpg","comment_is_top":false,"comment_ctime":1567559822,"is_pvip":false,"replies":[{"id":"49036","content":"ç»™ä½ ä¸€ä¸ªæ›´å…·ä½“çš„ç¤ºä¾‹ï¼š<br>resty -e &#39;local s = [[<br>local ngx = ngx<br>local _M = {}<br>function _M.f()<br>\tngx.say(&quot;hello world&quot;)<br>end<br>return _M<br>]]<br>local lua = loadstring(s)<br>local ret, func = pcall(lua)<br>func.f()&#39;<br><br>è¿™é‡Œçš„ `s` å°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„ Lua æ¨¡å—ï¼Œåœ¨å‘ç°å˜åŒ–çš„æ—¶å€™ï¼Œä½ å¯ä»¥ç”¨ loadstring æˆ–è€… loadfile é‡å¯åŠ è½½ã€‚ä½ ä¹ŸæŠŠå¯ä»¥æŠŠè·å–å˜åŒ–å’Œé‡æ–°åŠ è½½ç”¨ code_loader å‡½æ•°åšä¸€å±‚åŒ…è£…ï¼š<br>```<br>local func = code_loader(name)<br>```<br>è€Œåœ¨ code_loader ä¸­æˆ‘ä»¬ä¸€èˆ¬ä¼šç”¨ lru cache å¯¹ `s` åšä¸€å±‚ç¼“å­˜ã€‚<br>è¿™å·®ä¸å¤šå°±æ˜¯å®Œæ•´çš„å®ç°äº†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1567583779,"ip_address":"","comment_id":130849,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10157494414","product_id":100028301,"comment_content":"å…³äºCloudFlare å®ç°çš„åŠ¨æ€åŠ è½½æœ‰ä¸ªç–‘é—®ï¼šCloudFlare åœ¨å®Œæˆæ–°æ–‡ä»¶æ›¿æ¢åï¼Œå¦‚ä½•ç”¨ loadstring å‡½æ•°å®Œæˆæ–°æ–‡ä»¶çš„åŠ è½½å‘¢ ï¼Ÿloadstring åªèƒ½åŠ è½½å­—ç¬¦ä¸²ï¼Œå°±ç®—æŠŠæ–‡ä»¶å†…å®¹è½¬æˆå­—ç¬¦ä¸²ä½œä¸º loadstring çš„å…¥å‚ï¼Œä¹Ÿä¸è¡Œå§ï¼Œå®ƒçš„è¿”å›å€¼æ˜¯å‡½æ•°å¼•ç”¨ã€‚é‚£åŠ¨æ€åŠ è½½ lua æ–‡ä»¶&#47;æ¨¡å—ï¼ŒOR æ˜¯å¦‚ä½•åšçš„ ï¼Ÿæ¸©è€å¸ˆèƒ½å¦å…·ä½“è®²è®²è¿™å—ï¼Œæˆ–è€… CloudFlare å…·æ˜¯å¦‚ä½•å®ç°çš„ ï¼Ÿ<br><br>å¦‚æœè¦é‡æ–°åŠ è½½ä¸€ä¸ª lua æ–‡ä»¶&#47;æ¨¡å—ï¼Œä»¥æˆ‘ç›®å‰å¯¹ OR çš„æŒæ¡åªèƒ½æƒ³åŠæ³•é‡æ–°æ‰§è¡Œ require ï¼Œä½†è²Œä¼¼ç”¨è¿™ç§æ–¹å¼åšä¸åˆ°ï¼Œå…·ä½“å®ç°æ–¹å¼ä¸çŸ¥æ˜¯å¦‚ä½• ï¼Ÿ<br><br>æ„Ÿè°¢ã€‚","like_count":2,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":466154,"discussion_content":"ç»™ä½ ä¸€ä¸ªæ›´å…·ä½“çš„ç¤ºä¾‹ï¼š\nresty -e &amp;#39;local s = [[\nlocal ngx = ngx\nlocal _M = {}\nfunction _M.f()\n\tngx.say(&amp;quot;hello world&amp;quot;)\nend\nreturn _M\n]]\nlocal lua = loadstring(s)\nlocal ret, func = pcall(lua)\nfunc.f()&amp;#39;\n\nè¿™é‡Œçš„ `s` å°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„ Lua æ¨¡å—ï¼Œåœ¨å‘ç°å˜åŒ–çš„æ—¶å€™ï¼Œä½ å¯ä»¥ç”¨ loadstring æˆ–è€… loadfile é‡å¯åŠ è½½ã€‚ä½ ä¹ŸæŠŠå¯ä»¥æŠŠè·å–å˜åŒ–å’Œé‡æ–°åŠ è½½ç”¨ code_loader å‡½æ•°åšä¸€å±‚åŒ…è£…ï¼š\n```\nlocal func = code_loader(name)\n```\nè€Œåœ¨ code_loader ä¸­æˆ‘ä»¬ä¸€èˆ¬ä¼šç”¨ lru cache å¯¹ `s` åšä¸€å±‚ç¼“å­˜ã€‚\nè¿™å·®ä¸å¤šå°±æ˜¯å®Œæ•´çš„å®ç°äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567583779,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":130881,"user_name":"Netfeel","can_delete":false,"product_type":"c1","uid":1545509,"ip_address":"","ucode":"E92F9ED37849A0","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/cnNBSrNVDiagXWXkdWPnRxFh4D8oIbgnbiaA8WhIMkfI2vmemzTX3001YibnaPXHMRmCP5S6cGA7oHHLPHRBricr8g/132","comment_is_top":false,"comment_ctime":1567563925,"is_pvip":false,"replies":[{"id":"49026","content":"è¦çœ‹è°ƒç”¨æ¬¡æ•°çš„ï¼Œçƒ­ä»£ç æ‰æœ‰ JIT çš„å¿…è¦æ€§ã€‚loadstring å¹¶ä¸æ˜¯ä¸€ä¸ªé¢‘ç¹çš„æ“ä½œï¼Œä¸ä¼šæœ‰æ€§èƒ½é—®é¢˜çš„","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1567580911,"ip_address":"","comment_id":130881,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5862531221","product_id":100028301,"comment_content":"loadstring åœ¨NYIåˆ—è¡¨æ˜¯neverï¼Œä¼šä¸ä¼šå¯¹æ€§èƒ½æœ‰å¾ˆå¤§å½±å“ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":466173,"discussion_content":"è¦çœ‹è°ƒç”¨æ¬¡æ•°çš„ï¼Œçƒ­ä»£ç æ‰æœ‰ JIT çš„å¿…è¦æ€§ã€‚loadstring å¹¶ä¸æ˜¯ä¸€ä¸ªé¢‘ç¹çš„æ“ä½œï¼Œä¸ä¼šæœ‰æ€§èƒ½é—®é¢˜çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567580911,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1545509,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/cnNBSrNVDiagXWXkdWPnRxFh4D8oIbgnbiaA8WhIMkfI2vmemzTX3001YibnaPXHMRmCP5S6cGA7oHHLPHRBricr8g/132","nickname":"Netfeel","note":"","ucode":"E92F9ED37849A0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":7602,"discussion_content":"æ„æ€æ˜¯loadstringåç¼“å­˜åœ¨lrucacheé‡Œï¼Œæœ‰å˜åŒ–å†loadstring","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567582522,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":130803,"user_name":"manatee","can_delete":false,"product_type":"c1","uid":1041112,"ip_address":"","ucode":"708D90E7A265BD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/e2/d8/f0562ede.jpg","comment_is_top":false,"comment_ctime":1567555315,"is_pvip":false,"replies":[{"id":"49055","content":"å¤šè°¢æŒ‡æ­£ï¼Œç¡®å®è¿™é‡Œå¼„é”™äº†ã€‚lua-resty-upstream-healthcheckå¸¦çš„æ˜¯ ngx.timer.at è¿™ç§ä¸»åŠ¨å¥åº·æ£€æŸ¥çš„æ–¹å¼ï¼Œè€Œæ²¡æœ‰è¢«åŠ¨å¥åº·æ£€æŸ¥ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1567584922,"ip_address":"","comment_id":130803,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5862522611","product_id":100028301,"comment_content":"lua-resty-upstream-healthcheckæ˜¯ä¸æ˜¯è¯´åäº†ï¼Œåº”è¯¥åªæœ‰ä¸»åŠ¨å¥åº·æ£€æŸ¥æ²¡æœ‰è¢«åŠ¨å¥åº·æ£€æŸ¥","like_count":1,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":466137,"discussion_content":"å¤šè°¢æŒ‡æ­£ï¼Œç¡®å®è¿™é‡Œå¼„é”™äº†ã€‚lua-resty-upstream-healthcheckå¸¦çš„æ˜¯ ngx.timer.at è¿™ç§ä¸»åŠ¨å¥åº·æ£€æŸ¥çš„æ–¹å¼ï¼Œè€Œæ²¡æœ‰è¢«åŠ¨å¥åº·æ£€æŸ¥ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567584922,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":351191,"user_name":"Geek_838843","can_delete":false,"product_type":"c1","uid":2142320,"ip_address":"","ucode":"5B2D92A4FA3059","user_header":"","comment_is_top":false,"comment_ctime":1657599188,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1657599188","product_id":100028301,"comment_content":"è€å¸ˆä½ å¥½ï¼Œå¯¹äºåŠ¨æ€è¿˜æ˜¯æ²¡æœ‰ååˆ†æ˜ç™½ã€‚ä¸¾ä¸ªä¾‹å­: æ¯”å¦‚ç°åœ¨æœ‰ä¸ªè¿æ¥æ± åŠŸèƒ½ï¼Œç”±äºç°æœ‰è¿æ¥æ•°ä¸å¤Ÿäº†ï¼Œéœ€è¦å¢åŠ ä¸€äº›è¿æ¥æ•°ï¼Œå¹¶ä¸”ä¸èƒ½å½±å“æ­£åœ¨è·‘çš„çº¿ä¸Šä¸šåŠ¡ã€‚è¿™äº›é…ç½®ç°åœ¨åœ¨é¡¹ç›®çš„é…ç½®æ–‡ä»¶é‡Œé…å¥½äº†ï¼Œè¿™æ—¶å€™éœ€è¦åŠ¨æ€å‘å¸ƒï¼Œè¿™æ—¶å€™è¿™ä¸ªåŠ¨æ€è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ","like_count":0},{"had_liked":false,"id":274137,"user_name":"Varphp","can_delete":false,"product_type":"c1","uid":1590892,"ip_address":"","ucode":"889550391E3F75","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTImmLJCKerl9CI4sTpPDNCUgswp04ybsJ4J6mpJmMlHh43Iibp1RPOLam5PpOv2ZDGcjvGrY94lNRw/132","comment_is_top":false,"comment_ctime":1610870544,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1610870544","product_id":100028301,"comment_content":"åŠ¨æ€ä»£ç†æ€ä¹ˆåšï¼Ÿ ä¸æ˜¯è·³è½¬301 302å°±æ˜¯åŠ¨æ€åå‘ä»£ç† æƒ³è¦é€šè¿‡redisæ¥å®šä¹‰è·¯ç”±  è¿™ç§æœ‰å¯èƒ½å®ç°å—ğŸ˜‚","like_count":0,"discussions":[{"author":{"id":1532404,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEIvUlicgrWtibbDzwhLw5cQrDSy2JuE1mVvmXq11KQIwpLicgDuWfpp9asE0VCN6HhibPDWn7wBc2lfmA/132","nickname":"aã€","note":"","ucode":"590FE8DB111492","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":577269,"discussion_content":"å¯ä»¥å®ç°çš„ï¼ŒæŠŠè·¯ç”±è§„åˆ™æ”¾åœ¨redisï¼Œç„¶ååœ¨balanceé˜¶æ®µï¼Œä»rediså–å‡ºè·¯ç”±è§„åˆ™ï¼Œå†é€šè¿‡æœ¬èŠ‚è€å¸ˆè¯´çš„å»è®¾ç½®ä¸Šæ¸¸ï¼Œå°±å¯ä»¥äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655996850,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":211593,"user_name":"é’›åˆé‡‘çŒªå¤´","can_delete":false,"product_type":"c1","uid":1277041,"ip_address":"","ucode":"5919ACDA6739E2","user_header":"https://static001.geekbang.org/account/avatar/00/13/7c/71/ecfde294.jpg","comment_is_top":false,"comment_ctime":1587987021,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1587987021","product_id":100028301,"comment_content":"è€å¸ˆï¼Œæˆ‘æƒ³å®ç° ç±»ä¼¼ tengine ä¸­çš„ ngx_http_upstream_check_moduleï¼Œè¿™æ ·ä¸€æ—¦æ£€æµ‹åˆ° unhealthyï¼Œå°±è‡ªåŠ¨æŠŠè¿™ä¸ªunhealthyçš„èŠ‚ç‚¹è¸¢æ‰ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å‚è€ƒçš„å—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1189580,"avatar":"https://static001.geekbang.org/account/avatar/00/12/26/cc/719aec6d.jpg","nickname":"24","note":"","ucode":"F09DF49B6254E8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":312886,"discussion_content":"å“¥ä»¬ï¼Œæˆ‘ä¹Ÿæœ‰ç±»ä¼¼çš„éœ€æ±‚ï¼Œä¸ä»‹æ„çš„è¯ï¼Œä¸€èµ·äº¤æµä¸€ä¸‹ï¼ŒåŠ æˆ‘QQ 799765235","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1602844580,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":131658,"user_name":"è®¸ç«¥ç«¥","can_delete":false,"product_type":"c1","uid":1003005,"ip_address":"","ucode":"4B799C0C6BC678","user_header":"https://static001.geekbang.org/account/avatar/00/0f/4d/fd/0aa0e39f.jpg","comment_is_top":false,"comment_ctime":1567838416,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1567838416","product_id":100028301,"comment_content":"è€å¸ˆçš„æ–‡ç« å¾ˆæ£’ã€‚","like_count":0},{"had_liked":false,"id":131309,"user_name":"helloworld","can_delete":false,"product_type":"c1","uid":1105161,"ip_address":"","ucode":"1EECCA0F43E278","user_header":"https://static001.geekbang.org/account/avatar/00/10/dd/09/feca820a.jpg","comment_is_top":false,"comment_ctime":1567699379,"is_pvip":false,"replies":[{"id":"50714","content":"å¯ä»¥å†™åœ¨ ngx.timer é‡Œé¢ï¼Œåˆ°æ•°æ®åº“ä¸­å®šæœŸçš„å»æ£€æµ‹ç‰ˆæœ¬å·æˆ–è€…ä¿®æ”¹æ—¶é—´æ˜¯å¦æœ‰å˜åŒ–ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1568172005,"ip_address":"","comment_id":131309,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1567699379","product_id":100028301,"comment_content":"è€å¸ˆï¼Œloadstringæˆ–loadfileè¿™ç§çƒ­æ›´æ–°ç›¸å…³çš„ä»£ç ï¼Œæˆ‘ä»¬è¯¥å†™åœ¨å“ªé‡Œï¼Œå°±æ˜¯æ€ä¹ˆè§¦å‘ï¼Ÿé€šè¿‡restyå‘½ä»¤å—","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":466382,"discussion_content":"å¯ä»¥å†™åœ¨ ngx.timer é‡Œé¢ï¼Œåˆ°æ•°æ®åº“ä¸­å®šæœŸçš„å»æ£€æµ‹ç‰ˆæœ¬å·æˆ–è€…ä¿®æ”¹æ—¶é—´æ˜¯å¦æœ‰å˜åŒ–ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1568172005,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":131057,"user_name":"ç©ºçŸ¥","can_delete":false,"product_type":"c1","uid":1013283,"ip_address":"","ucode":"C448E98238DD36","user_header":"https://static001.geekbang.org/account/avatar/00/0f/76/23/31e5e984.jpg","comment_is_top":false,"comment_ctime":1567611790,"is_pvip":false,"replies":[{"id":"49338","content":"ç®—çš„ï¼Œè¿™æ˜¯ Nginx&#47;OpenResty è‡ªèº«çš„å‡çº§ã€‚ä½†è¿™ä¸ªè¿‡ç¨‹ä¼šå…³é—­æ—§çš„ workersï¼Œå¯åŠ¨æ–°çš„ workersï¼Œå¯èƒ½è€—æ—¶æ¯”è¾ƒä¹…ï¼Œè€Œä¸”ä¼šä¸¢å¤±ç¼“å­˜ã€‚è¿™ç§äºŒçº§åˆ¶çƒ­å‡çº§åº”è¯¥ä¿æŒä¸€ä¸ªå¾ˆä½é¢‘çš„æ“ä½œã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1567650169,"ip_address":"","comment_id":131057,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1567611790","product_id":100028301,"comment_content":"äºŒè¿›åˆ¶çƒ­å‡çº§ ä¹Ÿæ²¡æœ‰åœæ­¢æœåŠ¡ å¯åŠ¨æ–°çš„é…ç½®çš„ç¨‹åºï¼Œä¸ç®—åŠ¨æ€å—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":466267,"discussion_content":"ç®—çš„ï¼Œè¿™æ˜¯ Nginx/OpenResty è‡ªèº«çš„å‡çº§ã€‚ä½†è¿™ä¸ªè¿‡ç¨‹ä¼šå…³é—­æ—§çš„ workersï¼Œå¯åŠ¨æ–°çš„ workersï¼Œå¯èƒ½è€—æ—¶æ¯”è¾ƒä¹…ï¼Œè€Œä¸”ä¼šä¸¢å¤±ç¼“å­˜ã€‚è¿™ç§äºŒçº§åˆ¶çƒ­å‡çº§åº”è¯¥ä¿æŒä¸€ä¸ªå¾ˆä½é¢‘çš„æ“ä½œã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567650169,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":130800,"user_name":"manatee","can_delete":false,"product_type":"c1","uid":1041112,"ip_address":"","ucode":"708D90E7A265BD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/e2/d8/f0562ede.jpg","comment_is_top":false,"comment_ctime":1567554664,"is_pvip":false,"replies":[{"id":"49058","content":"ä½ å¯ä»¥ä½¿ç”¨ checker:add_target æ¥è®¾ç½®å¤šä¸ªä¸Šæ¸¸èŠ‚ç‚¹çš„ ip å’Œç«¯å£ï¼Œå°±åƒè¿™ä¸ªæµ‹è¯•æ¡ˆä¾‹ä¸€æ ·ï¼šhttps:&#47;&#47;github.com&#47;Kong&#47;lua-resty-healthcheck&#47;blob&#47;master&#47;t&#47;06-report_http_status.t#L69<br>","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1567585133,"ip_address":"","comment_id":130800,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1567554664","product_id":100028301,"comment_content":"åœ¨ä½¿ç”¨resty-healthcheckè¿™ä¸ªåº“æ—¶ï¼Œå¦‚ä½•æ£€è·å–æ‰€æœ‰çœŸå®æœåŠ¡å™¨çš„å¥åº·çŠ¶æ€å‘¢","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":466135,"discussion_content":"ä½ å¯ä»¥ä½¿ç”¨ checker:add_target æ¥è®¾ç½®å¤šä¸ªä¸Šæ¸¸èŠ‚ç‚¹çš„ ip å’Œç«¯å£ï¼Œå°±åƒè¿™ä¸ªæµ‹è¯•æ¡ˆä¾‹ä¸€æ ·ï¼šhttps://github.com/Kong/lua-resty-healthcheck/blob/master/t/06-report_http_status.t#L69\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567585133,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1041112,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/e2/d8/f0562ede.jpg","nickname":"manatee","note":"","ucode":"708D90E7A265BD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":7686,"discussion_content":"å¥½çš„ï¼Œæˆ‘åŸæœ‰çš„æƒ³æ³•æ˜¯æŸ¥çœ‹å¥åº·æ£€æŸ¥ç”¨åˆ°çš„sharedict. æˆ‘å…ˆçœ‹çœ‹æ‚¨çš„è¿™ä¸ªç¤ºä¾‹ï¼Œéå¸¸æ„Ÿè°¢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567612409,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":130798,"user_name":"manatee","can_delete":false,"product_type":"c1","uid":1041112,"ip_address":"","ucode":"708D90E7A265BD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/e2/d8/f0562ede.jpg","comment_is_top":false,"comment_ctime":1567554461,"is_pvip":false,"replies":[{"id":"49062","content":"balancer_by_lua å¯ä»¥è®©ç”¨æˆ·é€‰æ‹©è´Ÿè½½å‡è¡¡çš„ç®—æ³•æ˜¯roundrobin è¿˜æ˜¯ chashï¼Œæˆ–è€…æ˜¯å…¶ä»–çš„ç®—æ³•ï¼Œæ¯”è¾ƒè‡ªç”±ã€‚å¦å¤–ï¼Œåœ¨ä½ çš„å®ç°ä¸­ï¼Œä¸Šæ¸¸å¥åº·æ£€æŸ¥ä¹Ÿéœ€è¦è‡ªå·±æ¥å®ç°ï¼Œæœ‰ä¸å°‘é¢å¤–çš„å·¥ä½œé‡ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1567585382,"ip_address":"","comment_id":130798,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1567554461","product_id":100028301,"comment_content":"åŠ¨æ€ä¸Šæ¸¸è¿™å—ï¼Œæˆ‘çš„åšæ³•æ˜¯ä¸ºä¸€ä¸ªæœåŠ¡è®¾ç½®2ä¸ªupstreamï¼Œç„¶åæ ¹æ®è·¯ç”±æ¡ä»¶é€‰æ‹©ä¸åŒçš„upstreamï¼Œå½“æœºå™¨ipæœ‰å˜åŒ–ä¿®æ”¹upstreamä¸­çš„ipå³å¯ï¼Œè¯·é—®è¿™æ ·å’Œç›´æ¥ä½¿ç”¨balancer_by_luaæœ‰ä»€ä¹ˆåŠ£åŠ¿æˆ–å‘å—","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":466133,"discussion_content":"balancer_by_lua å¯ä»¥è®©ç”¨æˆ·é€‰æ‹©è´Ÿè½½å‡è¡¡çš„ç®—æ³•æ˜¯roundrobin è¿˜æ˜¯ chashï¼Œæˆ–è€…æ˜¯å…¶ä»–çš„ç®—æ³•ï¼Œæ¯”è¾ƒè‡ªç”±ã€‚å¦å¤–ï¼Œåœ¨ä½ çš„å®ç°ä¸­ï¼Œä¸Šæ¸¸å¥åº·æ£€æŸ¥ä¹Ÿéœ€è¦è‡ªå·±æ¥å®ç°ï¼Œæœ‰ä¸å°‘é¢å¤–çš„å·¥ä½œé‡ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567585382,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}