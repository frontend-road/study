{"id":247812,"title":"18 | å¦‚ä½•é€šè¿‡gRPCå®ç°é«˜æ•ˆè¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯é™¶è¾‰ã€‚</p><p>è¿™ä¸€è®²æˆ‘ä»¬å°†ä»¥ä¸€ä¸ªå®æˆ˜æ¡ˆä¾‹ï¼ŒåŸºäºå‰ä¸¤è®²æåˆ°çš„HTTP/2å’ŒProtoBufåè®®ï¼Œçœ‹çœ‹gRPCå¦‚ä½•å°†ç»“æ„åŒ–æ¶ˆæ¯ç¼–ç ä¸ºç½‘ç»œæŠ¥æ–‡ã€‚</p><p>ç›´æ¥æ“ä½œç½‘ç»œåè®®ç¼–ç¨‹ï¼Œå®¹æ˜“è®©ä¸šåŠ¡å¼€å‘è¿‡ç¨‹é™·å…¥å¤æ‚çš„ç½‘ç»œå¤„ç†ç»†èŠ‚ã€‚RPCæ¡†æ¶ä»¥ç¼–ç¨‹è¯­è¨€ä¸­çš„æœ¬åœ°å‡½æ•°è°ƒç”¨å½¢å¼ï¼Œå‘åº”ç”¨å¼€å‘è€…æä¾›ç½‘ç»œè®¿é—®èƒ½åŠ›ï¼Œè¿™æ—¢å°è£…äº†æ¶ˆæ¯çš„ç¼–è§£ç ï¼Œä¹Ÿé€šè¿‡çº¿ç¨‹æ¨¡å‹å°è£…äº†å¤šè·¯å¤ç”¨ï¼Œå¯¹ä¸šåŠ¡å¼€å‘å¾ˆå‹å¥½ã€‚</p><p>å…¶ä¸­ï¼ŒGoogleæ¨å‡ºçš„gRPCæ˜¯æ€§èƒ½æœ€å¥½çš„RPCæ¡†æ¶ä¹‹ä¸€ï¼Œå®ƒæ”¯æŒJavaã€JavaScriptã€Pythonã€GoLangã€C++ã€Object-Cã€Androidã€Rubyç­‰å¤šç§ç¼–ç¨‹è¯­è¨€ï¼Œè¿˜æ”¯æŒå®‰å…¨éªŒè¯ç­‰ç‰¹æ€§ï¼Œå¾—åˆ°äº†å¹¿æ³›çš„åº”ç”¨ï¼Œæ¯”å¦‚å¾®æœåŠ¡ä¸­çš„Envoyã€åˆ†å¸ƒå¼æœºå™¨å­¦ä¹ ä¸­çš„TensorFlowï¼Œç”šè‡³åä¸ºå»å¹´æ¨å‡ºé‡æ„äº’è”ç½‘çš„New IPæŠ€æœ¯ï¼Œéƒ½ä½¿ç”¨äº†gRPCæ¡†æ¶ã€‚</p><p>ç„¶è€Œï¼Œç½‘ç»œä¸Šæ•™ä½ ä½¿ç”¨gRPCæ¡†æ¶çš„æ•™ç¨‹å¾ˆå¤šï¼Œå´å¾ˆå°‘å»è°ˆgRPCæ˜¯å¦‚ä½•ç¼–ç æ¶ˆæ¯çš„ã€‚è¿™æ ·ï¼Œä¸€æ—¦åœ¨å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å‡ºç°ç–‘éš¾æ‚ç—‡ï¼Œéœ€è¦é€šè¿‡ç½‘ç»œæŠ¥æ–‡å»å®šä½é—®é¢˜å‘ç”Ÿåœ¨å“ªä¸ªç³»ç»Ÿã€ä¸»æœºã€è¿›ç¨‹ä¸­æ—¶ï¼Œä½ å°±ä¼šæ¯«æ— å¤´ç»ªã€‚å³ä½¿æˆ‘ä»¬æŒæ¡äº†HTTP/2å’ŒProtobufåè®®ï¼Œä½†è‹¥ä¸æ¸…æ¥šgRPCçš„ç¼–ç è§„åˆ™ï¼Œè¿˜æ˜¯æ— æ³•åˆ†ææŠ“å–åˆ°çš„gRPCæŠ¥æ–‡ã€‚è€Œä¸”ï¼ŒgRPCæ”¯æŒå•å‘ã€åŒå‘çš„æµå¼RPCè°ƒç”¨ï¼Œç¼–ç¨‹ç›¸å¯¹å¤æ‚ä¸€äº›ï¼Œå®šä½æµå¼RPCè°ƒç”¨å¼•å‘çš„bugæ—¶ï¼Œæ›´éœ€è¦æˆ‘ä»¬æŒæ¡gRPCçš„ç¼–ç åŸç†ã€‚</p><!-- [[[read_end]]] --><p>è¿™ä¸€è®²ï¼Œæˆ‘å°±å°†ä»¥gRPCå®˜æ–¹æä¾›çš„exampleï¼š<a href=\"https://github.com/grpc/grpc/tree/master/examples/python/data_transmission\">data_transmisstion</a> ä¸ºä¾‹ï¼Œä»‹ç»gRPCçš„ç¼–ç æµç¨‹ã€‚åœ¨è¿™ä¸€è¿‡ç¨‹ä¸­ï¼Œä¼šé¡ºå¸¦å›é¡¾HTTP/2å’ŒProtobufåè®®ï¼ŒåŠ æ·±ä½ å¯¹å®ƒä»¬çš„ç†è§£ã€‚è™½ç„¶è¿™ä¸ªç¤ºä¾‹ä½¿ç”¨çš„æ˜¯Pythonè¯­è¨€ï¼Œä½†åŸºäºgRPCæ¡†æ¶ï¼Œä½ å¯ä»¥è½»æ¾åœ°å°†å®ƒä»¬è½¬æ¢ä¸ºå…¶ä»–ç¼–ç¨‹è¯­è¨€ã€‚</p><h2>å¦‚ä½•ä½¿ç”¨gRPCæ¡†æ¶å®ç°è¿œç¨‹è°ƒç”¨ï¼Ÿ</h2><p>æˆ‘ä»¬å…ˆæ¥ç®€å•åœ°çœ‹ä¸‹gRPCæ¡†æ¶åˆ°åº•æ˜¯ä»€ä¹ˆã€‚RPCçš„å…¨ç§°æ˜¯Remote Procedure Callï¼Œå³è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼Œå®ƒé€šè¿‡æœ¬åœ°å‡½æ•°è°ƒç”¨ï¼Œå°è£…äº†è·¨ç½‘ç»œã€è·¨å¹³å°ã€è·¨è¯­è¨€çš„æœåŠ¡è®¿é—®ï¼Œå¤§å¤§ç®€åŒ–äº†åº”ç”¨å±‚ç¼–ç¨‹ã€‚å…¶ä¸­ï¼Œå‡½æ•°çš„å…¥å‚æ˜¯è¯·æ±‚ï¼Œè€Œå‡½æ•°çš„è¿”å›å€¼åˆ™æ˜¯å“åº”ã€‚</p><p>gRPCå°±æ˜¯ä¸€ç§RPCæ¡†æ¶ï¼Œåœ¨ä½ å®šä¹‰å¥½æ¶ˆæ¯æ ¼å¼åï¼Œé’ˆå¯¹ä½ é€‰æ‹©çš„ç¼–ç¨‹è¯­è¨€ï¼ŒgRPCä¸ºå®¢æˆ·ç«¯ç”Ÿæˆå‘èµ·RPCè¯·æ±‚çš„Stubç±»ï¼Œä»¥åŠä¸ºæœåŠ¡å™¨ç”Ÿæˆå¤„ç†RPCè¯·æ±‚çš„Serviceç±»ï¼ˆæœåŠ¡å™¨åªéœ€è¦ç»§æ‰¿ã€å®ç°ç±»ä¸­å¤„ç†è¯·æ±‚çš„å‡½æ•°å³å¯ï¼‰ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¾ˆæ˜æ˜¾ï¼ŒgRPCä¸»è¦æœåŠ¡äºé¢å‘å¯¹è±¡çš„ç¼–ç¨‹è¯­è¨€ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/c2/a1/c20e6974a05b5e71823aec618fc824a1.jpg?wh=1682*1182\" alt=\"\"></p><p>gRPCæ”¯æŒQUICã€HTTP/1ç­‰å¤šç§åè®®ï¼Œä½†é‰´äºHTTP/2åè®®æ€§èƒ½å¥½ï¼Œåº”ç”¨åœºæ™¯åˆå¹¿æ³›ï¼Œå› æ­¤HTTP/2æ˜¯gRPCçš„é»˜è®¤ä¼ è¾“åè®®ã€‚gRPCä¹Ÿæ”¯æŒJSONç¼–ç æ ¼å¼ï¼Œä½†åœ¨å¿½ç•¥ç¼–ç ç»†èŠ‚çš„RPCè°ƒç”¨ä¸­ï¼Œé«˜æ•ˆçš„Protobufæ‰æ˜¯æœ€ä½³é€‰æ‹©ï¼å› æ­¤ï¼Œè¿™ä¸€è®²ä»…åŸºäºHTTP/2å’ŒProtobufï¼Œä»‹ç»gRPCçš„ç”¨æ³•ã€‚</p><p>gRPCå¯ä»¥ç®€å•åœ°åˆ†ä¸ºä¸‰å±‚ï¼ŒåŒ…æ‹¬åº•å±‚çš„æ•°æ®ä¼ è¾“å±‚ï¼Œä¸­é—´çš„æ¡†æ¶å±‚ï¼ˆæ¡†æ¶å±‚åˆåŒ…æ‹¬Cè¯­è¨€å®ç°çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œä»¥åŠä¸Šå±‚çš„ç¼–ç¨‹è¯­è¨€æ¡†æ¶ï¼‰ï¼Œä»¥åŠæœ€ä¸Šå±‚ç”±æ¡†æ¶å±‚è‡ªåŠ¨ç”Ÿæˆçš„Stubå’ŒServiceç±»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><a href=\"https://platformlab.stanford.edu/Seminar%20Talks/gRPC.pdf\"><img src=\"https://static001.geekbang.org/resource/image/2a/4a/2a3f82f3eaabd440bf1ee449e532944a.png?wh=1380*557\" alt=\"\" title=\"å›¾ç‰‡æ¥æºï¼šhttps://platformlab.stanford.edu/Seminar%20Talks/gRPC.pdf\"></a></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä»¥å®˜ç½‘ä¸Šçš„<a href=\"https://github.com/grpc/grpc/tree/master/examples/python/data_transmission\">data_transmisstion</a> ä¸ºä¾‹ï¼Œå…ˆçœ‹çœ‹å¦‚ä½•ä½¿ç”¨gRPCã€‚</p><p>æ„å»ºPythonè¯­è¨€çš„gRPCç¯å¢ƒå¾ˆç®€å•ï¼Œä½ å¯ä»¥å‚è€ƒå®˜ç½‘ä¸Šçš„<a href=\"https://grpc.io/docs/quickstart/python/\">QuickStart</a>ã€‚</p><p>ä½¿ç”¨gRPCå‰ï¼Œå…ˆè¦æ ¹æ®Protobufè¯­æ³•ï¼Œç¼–å†™å®šä¹‰æ¶ˆæ¯æ ¼å¼çš„protoæ–‡ä»¶ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­åªæœ‰1ç§è¯·æ±‚å’Œ1ç§å“åº”ï¼Œä¸”å®ƒä»¬å¾ˆç›¸ä¼¼ï¼Œå„å«æœ‰1ä¸ªæ•´å‹æ•°å­—å’Œ1ä¸ªå­—ç¬¦ä¸²ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>package demo;\n\nmessage Request {\n    int64 client_id = 1;\n    string request_data = 2;\n} \n\nmessage Response {\n    int64 server_id = 1;\n    string response_data = 2;\n}\n</code></pre><p>è¯·æ³¨æ„ï¼Œè¿™é‡Œçš„åŒ…ådemoä»¥åŠå­—æ®µåºå·1ã€2ï¼Œéƒ½ä¸åç»­çš„gRPCæŠ¥æ–‡åˆ†æç›¸å…³ã€‚</p><p>æ¥ç€å®šä¹‰serviceï¼Œæ‰€æœ‰çš„RPCæ–¹æ³•éƒ½è¦æ”¾ç½®åœ¨serviceä¸­ï¼Œè¿™é‡Œå°†å®ƒå–åä¸ºGRPCDemoã€‚GRPCDemoä¸­æœ‰4ä¸ªæ–¹æ³•ï¼Œåé¢3ä¸ªæµå¼è®¿é—®çš„ä¾‹å­æˆ‘ä»¬å‘†ä¼šå†è°ˆï¼Œå…ˆæ¥çœ‹ç®€å•çš„ä¸€å…ƒè®¿é—®æ¨¡å¼SimpleMethod æ–¹æ³•ï¼Œå®ƒå®šä¹‰äº†1ä¸ªè¯·æ±‚å¯¹åº”1ä¸ªå“åº”çš„è®¿é—®å½¢å¼ã€‚å…¶ä¸­ï¼ŒSimpleMethodçš„å‚æ•°Requestæ˜¯è¯·æ±‚ï¼Œè¿”å›å€¼Responseæ˜¯å“åº”ã€‚æ³¨æ„ï¼Œåˆ†ææŠ¥æ–‡æ—¶ä¼šç”¨åˆ°è¿™é‡Œçš„ç±»åGRPCDemoä»¥åŠæ–¹æ³•åSimpleMethodã€‚</p><pre><code>service GRPCDemo {\n    rpc SimpleMethod (Request) returns (Response);\n}\n</code></pre><p>ç”¨grpc_toolsä¸­çš„protocå‘½ä»¤ï¼Œå°±å¯ä»¥é’ˆå¯¹åˆšåˆšå®šä¹‰çš„serviceï¼Œç”Ÿæˆå«æœ‰GRPCDemoStubç±»å’ŒGRPCDemoServicerç±»çš„demo_pb2_grpc.pyæ–‡ä»¶ï¼ˆå®é™…ä¸Šè¿˜åŒ…æ‹¬å®ŒæˆProtobufç¼–è§£ç çš„demo_pb2.pyï¼‰ï¼Œåº”ç”¨å±‚å°†ä½¿ç”¨è¿™ä¸¤ä¸ªç±»å®ŒæˆRPCè®¿é—®ã€‚æˆ‘ç®€åŒ–äº†å®˜ç½‘ä¸Šçš„Pythonå®¢æˆ·ç«¯ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>with grpc.insecure_channel(&quot;localhost:23333&quot;) as channel:\n    stub = demo_pb2_grpc.GRPCDemoStub(channel)\n    request = demo_pb2.Request(client_id=1,\n            request_data=&quot;called by Python client&quot;)\n    response = stub.SimpleMethod(request)\n</code></pre><p>ç¤ºä¾‹ä¸­å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨éƒ½åœ¨åŒä¸€å°æœºå™¨ä¸Šï¼Œé€šè¿‡23333ç«¯å£è®¿é—®ã€‚å®¢æˆ·ç«¯é€šè¿‡Stubå¯¹è±¡çš„SimpleMethodæ–¹æ³•å®Œæˆäº†RPCè®¿é—®ã€‚è€ŒæœåŠ¡å™¨ç«¯çš„å®ç°ä¹Ÿå¾ˆç®€å•ï¼Œåªéœ€è¦å®ç°GRPCDemoServicerçˆ¶ç±»çš„SimpleMethodæ–¹æ³•ï¼Œè¿”å›responseå“åº”å³å¯ï¼š</p><pre><code>class DemoServer(demo_pb2_grpc.GRPCDemoServicer):\n    def SimpleMethod(self, request, context):\n        response = demo_pb2.Response(\n            server_id=1,\n            response_data=&quot;Python server SimpleMethod Ok!!!!&quot;)\n        return response\n</code></pre><p>å¯è§ï¼ŒgRPCçš„å¼€å‘æ•ˆç‡éå¸¸é«˜ï¼æ¥ä¸‹æ¥æˆ‘ä»¬åˆ†æè¿™æ¬¡RPCè°ƒç”¨ä¸­ï¼Œæ¶ˆæ¯æ˜¯æ€æ ·ç¼–ç çš„ã€‚</p><h2>gRPCæ¶ˆæ¯æ˜¯å¦‚ä½•ç¼–ç çš„ï¼Ÿ</h2><p><strong>å®šä½å¤æ‚çš„ç½‘ç»œé—®é¢˜ï¼Œéƒ½éœ€è¦æŠ“å–ã€åˆ†æç½‘ç»œæŠ¥æ–‡ã€‚</strong>å¦‚æœä½ åœ¨Windowsä¸ŠæŠ“å–ç½‘ç»œæŠ¥æ–‡ï¼Œå¯ä»¥ä½¿ç”¨Wiresharkå·¥å…·ï¼ˆå¯å‚è€ƒ<a href=\"https://time.geekbang.org/course/detail/175-100973\">ã€ŠWebåè®®è¯¦è§£ä¸æŠ“åŒ…å®æˆ˜ã€‹ç¬¬37è¯¾</a>ï¼‰ï¼Œå¦‚æœåœ¨Linuxä¸ŠæŠ“åŒ…å¯ä»¥ä½¿ç”¨tcpdumpå·¥å…·ï¼ˆå¯å‚è€ƒ<a href=\"https://time.geekbang.org/course/detail/175-118169\">ç¬¬87è¯¾</a>ï¼‰ã€‚å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥ä»<a href=\"https://github.com/russelltao/geektime_distrib_perf/blob/master/18-gRPC/data_transmission.pkt\">è¿™é‡Œ</a>ä¸‹è½½æˆ‘æŠ“å–å¥½çš„ç½‘ç»œæŠ¥æ–‡ï¼Œç”¨Wiresharkæ‰“å¼€å®ƒã€‚éœ€è¦æ³¨æ„ï¼Œ23333ä¸æ˜¯HTTPå¸¸ç”¨çš„80æˆ–è€…443ç«¯å£ï¼Œæ‰€ä»¥Wiresharké»˜è®¤ä¸ä¼šæŠŠå®ƒè§£æä¸ºHTTP/2åè®®ã€‚ä½ éœ€è¦é¼ æ ‡å³é”®ç‚¹å‡»æŠ¥æ–‡ï¼Œé€‰æ‹©â€œè§£ç ä¸ºâ€ï¼ˆDecode asï¼‰ï¼Œå°†23333ç«¯å£çš„æŠ¥æ–‡è®¾ç½®ä¸ºHTTP/2è§£ç å™¨ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/74/f7/743e5038dc22676a0d48b56c453c1af7.png?wh=1241*425\" alt=\"\"></p><p>å›¾ä¸­è“è‰²æ–¹æ¡†ä¸­ï¼ŒTCPè¿æ¥çš„å»ºç«‹è¿‡ç¨‹è¯·å‚è§<a href=\"https://time.geekbang.org/column/article/237612\">[ç¬¬9è®²]</a>ï¼Œè€ŒHTTP/2ä¼šè¯çš„å»ºç«‹å¯å‚è§<a href=\"https://time.geekbang.org/course/detail/175-105608\">ã€ŠWebåè®®è¯¦è§£ä¸æŠ“åŒ…å®æˆ˜ã€‹ç¬¬52è¯¾</a>ï¼ˆè¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œå¦‚æœä½ éƒ½æ¸…æ¥šå°±å¯ä»¥ç›´æ¥ç•¥è¿‡ï¼‰ã€‚æˆ‘ä»¬é‡ç‚¹çœ‹çº¢è‰²æ–¹æ¡†ä¸­çš„gRPCè¯·æ±‚ä¸å“åº”ï¼Œç‚¹å¼€è¯·æ±‚ï¼Œå¯ä»¥çœ‹åˆ°ä¸‹å›¾ä¸­çš„ä¿¡æ¯ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/ba/41/ba4d9e9a6ce212e94a4ced829eeeca41.png?wh=906*844\" alt=\"\"></p><p>å…ˆæ¥åˆ†æè“è‰²æ–¹æ¡†ä¸­çš„HTTP/2å¤´éƒ¨ã€‚è¯·æ±‚ä¸­æœ‰2ä¸ªå…³é”®çš„HTTPå¤´éƒ¨ï¼Œpathå’Œcontent-typeï¼Œå®ƒä»¬å†³å®šäº†RPCæ–¹æ³•å’Œå…·ä½“çš„æ¶ˆæ¯ç¼–ç æ ¼å¼ã€‚pathçš„å€¼ä¸ºâ€œ/demo.GRPCDemo/SimpleMethodâ€ï¼Œé€šè¿‡â€œ/åŒ…å.æœåŠ¡å/æ–¹æ³•åâ€çš„å½¢å¼ç¡®å®šäº†RPCæ–¹æ³•ã€‚content-typeçš„å€¼ä¸ºâ€œapplication/grpcâ€ï¼Œç¡®å®šæ¶ˆæ¯ç¼–ç ä½¿ç”¨Protobufæ ¼å¼ã€‚å¦‚æœä½ å¯¹å…¶ä»–å¤´éƒ¨çš„å«ä¹‰æ„Ÿå…´è¶£ï¼Œå¯ä»¥çœ‹ä¸‹è¿™ä¸ª<a href=\"https://github.com/grpc/grpc/blob/master/doc/PROTOCOL-HTTP2.md\">æ–‡æ¡£</a>ï¼Œæ³¨æ„è¿™é‡Œä½¿ç”¨äº†ABNFå…ƒæ•°æ®å®šä¹‰è¯­è¨€ï¼ˆå¦‚æœä½ è¿˜ä¸äº†è§£ABNFï¼Œå¯ä»¥çœ‹ä¸‹<a href=\"https://time.geekbang.org/course/detail/175-93589\">ã€ŠWebåè®®è¯¦è§£ä¸æŠ“åŒ…å®æˆ˜ã€‹ç¬¬4è¯¾</a>ï¼‰ã€‚</p><p>HTTP/2åŒ…ä½“å¹¶ä¸ä¼šç›´æ¥å­˜æ”¾Protobufæ¶ˆæ¯ï¼Œè€Œæ˜¯å…ˆè¦æ·»åŠ 5ä¸ªå­—èŠ‚çš„Length-Prefixed Messageå¤´éƒ¨ï¼Œå…¶ä¸­ç”¨4ä¸ªå­—èŠ‚æ˜ç¡®Protobufæ¶ˆæ¯çš„é•¿åº¦ï¼ˆ1ä¸ªå­—èŠ‚è¡¨ç¤ºæ¶ˆæ¯æ˜¯å¦åšè¿‡å‹ç¼©ï¼‰ï¼Œå³ä¸Šå›¾ä¸­çš„æ¡”è‰²æ–¹æ¡†ã€‚ä¸ºä»€ä¹ˆè¦å¤šæ­¤ä¸€ä¸¾å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºï¼ŒgRPCæ”¯æŒæµå¼æ¶ˆæ¯ï¼Œå³åœ¨HTTP/2çš„1æ¡Streamä¸­ï¼Œé€šè¿‡DATAå¸§å‘é€å¤šä¸ªgRPCæ¶ˆæ¯ï¼Œè€ŒLength-Prefixed Messageå°±å¯ä»¥å°†ä¸åŒçš„æ¶ˆæ¯åˆ†ç¦»å¼€ã€‚å…³äºæµå¼æ¶ˆæ¯ï¼Œæˆ‘ä»¬åœ¨ä»‹ç»å®Œä¸€å…ƒæ¨¡å¼åï¼Œå†åŠ ä»¥åˆ†æã€‚</p><p>æœ€ååˆ†æProtobufæ¶ˆæ¯ï¼Œè¿™é‡Œä»…ä»¥client_idå­—æ®µä¸ºä¾‹ï¼Œå¯¹ä¸Šä¸€è®²çš„å†…å®¹åšä¸ªå›é¡¾ã€‚åœ¨protoæ–‡ä»¶ä¸­client_idå­—æ®µçš„åºå·ä¸º1ï¼Œå› æ­¤é¦–å­—èŠ‚00001000ä¸­å‰5ä½è¡¨ç¤ºåºå·ä¸º1çš„client_idå­—æ®µï¼Œå3ä½è¡¨ç¤ºå­—æ®µçš„å€¼ç±»å‹æ˜¯varintæ ¼å¼çš„æ•°å­—ï¼Œå› æ­¤éšåçš„å­—èŠ‚00000001è¡¨ç¤ºå­—æ®µå€¼ä¸º1ã€‚åºå·ä¸º2çš„request_dataå­—æ®µè¯·ä½ ç»“åˆä¸Šä¸€è®²çš„å†…å®¹ï¼Œè¯•ç€åšä¸€ä¸‹è§£æï¼Œçœ‹çœ‹å­—ç¬¦ä¸²â€œcalled by Python clientâ€æ˜¯æ€æ ·ç¼–ç çš„ã€‚</p><p>å†æ¥çœ‹æœåŠ¡å™¨å‘å›çš„å“åº”ï¼Œç‚¹å¼€Wiresharkä¸­çš„å“åº”æŠ¥æ–‡åå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/b8/cf/b8e71a1b956286b2def457c2fae78bcf.png?wh=962*723\" alt=\"\"></p><p>å…¶ä¸­DATAå¸§åŒæ ·åŒ…æ‹¬Length-Prefixed Messageå’ŒProtobufï¼Œä¸RPCè¯·æ±‚å¦‚å‡ºä¸€è¾™ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°äº†ï¼Œæˆ‘ä»¬é‡ç‚¹çœ‹ä¸‹HTTP/2å¤´éƒ¨ã€‚ä½ å¯èƒ½ç•™æ„åˆ°ï¼Œå“åº”å¤´éƒ¨è¢«æ‹†æˆäº†2ä¸ªéƒ¨åˆ†ï¼Œå…¶ä¸­grpc-statuså’Œgrpc-messageæ˜¯åœ¨DATAå¸§åå‘é€çš„ï¼Œè¿™æ ·å°±å…è®¸æœåŠ¡å™¨åœ¨å‘é€å®Œæ¶ˆæ¯åå†ç»™å‡ºé”™è¯¯ç ã€‚å…³äºgRPCçš„å®˜æ–¹é”™è¯¯ç ä»¥åŠmessageæè¿°ä¿¡æ¯æ˜¯å¦‚ä½•å–å€¼çš„ï¼Œä½ å¯ä»¥å‚è€ƒ<a href=\"https://github.com/grpc/grpc/blob/master/doc/statuscodes.md\">è¿™ä¸ªæ–‡æ¡£ã€‚</a></p><p>è¿™ç§å°†éƒ¨åˆ†HTTPå¤´éƒ¨æ”¾åœ¨åŒ…ä½“åå‘é€çš„æŠ€æœ¯å«åšTrailerï¼Œ<a href=\"https://tools.ietf.org/html/rfc7230#page-39\">RFC7230æ–‡æ¡£</a>å¯¹æ­¤æœ‰è¯¦ç»†çš„ä»‹ç»ã€‚å…¶ä¸­ï¼ŒRPCè¯·æ±‚ä¸­çš„TE: trailerså¤´éƒ¨ï¼Œå°±è¯´æ˜å®¢æˆ·ç«¯æ”¯æŒTrailerå¤´éƒ¨ã€‚åœ¨RPCå“åº”ä¸­ï¼Œgrpc-statuså¤´éƒ¨éƒ½ä¼šæ”¾åœ¨æœ€åå‘é€ï¼Œå› æ­¤å®ƒçš„å¸§flagsçš„EndStreamæ ‡å¿—ä½ä¸º1ã€‚</p><p>å¯ä»¥çœ‹åˆ°ï¼ŒgRPCä¸­çš„HTTPå¤´éƒ¨ä¸æ™®é€šçš„HTTPè¯·æ±‚å®Œå…¨ä¸€è‡´ï¼Œå› æ­¤ï¼Œå®ƒå…¼å®¹å½“ä¸‹äº’è”ç½‘ä¸­å„ç§ä¸ƒå±‚è´Ÿè½½å‡è¡¡ï¼Œè¿™ä½¿å¾—gRPCå¯ä»¥è½»æ¾åœ°è·¨è¶Šå…¬ç½‘ä½¿ç”¨ã€‚</p><h2>gRPCæµæ¨¡å¼çš„åè®®ç¼–ç </h2><p>è¯´å®Œä¸€å…ƒæ¨¡å¼ï¼Œæˆ‘ä»¬å†æ¥çœ‹æµæ¨¡å¼RPCè°ƒç”¨çš„ç¼–ç æ–¹å¼ã€‚</p><p>æ‰€è°“æµæ¨¡å¼ï¼Œæ˜¯æŒ‡RPCé€šè®¯çš„ä¸€æ–¹å¯ä»¥åœ¨1æ¬¡RPCè°ƒç”¨ä¸­ï¼ŒæŒç»­ä¸æ–­åœ°å‘é€æ¶ˆæ¯ï¼Œè¿™å¯¹è®¢é˜…ã€æ¨é€ç­‰åœºæ™¯å¾ˆæœ‰ç”¨ã€‚æµæ¨¡å¼å…±æœ‰3ç§ç±»å‹ï¼ŒåŒ…æ‹¬å®¢æˆ·ç«¯æµæ¨¡å¼ã€æœåŠ¡å™¨ç«¯æµæ¨¡å¼ï¼Œä»¥åŠä¸¤ç«¯åŒå‘æµæ¨¡å¼ã€‚åœ¨<a href=\"https://github.com/grpc/grpc/tree/master/examples/python/data_transmission\">data_transmisstion</a> å®˜æ–¹ç¤ºä¾‹ä¸­ï¼Œå¯¹è¿™3ç§æµæ¨¡å¼éƒ½å®šä¹‰äº†RPCæ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>service GRPCDemo {\n    rpc ClientStreamingMethod (stream Request) returns Response);\n    \n    rpc ServerStreamingMethod (Request) returns (stream Response);\n\n    rpc BidirectionalStreamingMethod (stream Request) returns (stream Response);\n}\n</code></pre><p>ä¸åŒçš„ç¼–ç¨‹è¯­è¨€å¤„ç†æµæ¨¡å¼çš„ä»£ç å¾ˆä¸ä¸€æ ·ï¼Œè¿™é‡Œå°±ä¸ä¸€ä¸€åˆ—ä¸¾äº†ï¼Œä½†é€šè®¯å±‚çš„æµæ¨¡å¼æ¶ˆæ¯ç¼–ç æ˜¯ä¸€æ ·çš„ï¼Œè€Œä¸”å¾ˆç®€å•ã€‚è¿™æ˜¯å› ä¸ºï¼ŒHTTP/2åè®®ä¸­æ¯ä¸ªStreamå°±æ˜¯å¤©ç„¶çš„1æ¬¡RPCè¯·æ±‚ï¼Œæ¯ä¸ªRPCæ¶ˆæ¯åˆå·²ç»é€šè¿‡Length-Prefixed Messageå¤´éƒ¨ç¡®ç«‹äº†è¾¹ç•Œï¼Œè¿™æ ·ï¼Œåœ¨Streamä¸­è¿ç»­åœ°å‘é€å¤šä¸ªDATAå¸§ï¼Œå°±å¯ä»¥å®ç°æµæ¨¡å¼RPCã€‚æˆ‘ç”»äº†ä¸€å¼ ç¤ºæ„å›¾ï¼Œä½ å¯ä»¥å¯¹ç…§å®ƒç†è§£æŠ“å–åˆ°çš„æµæ¨¡å¼æŠ¥æ–‡ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/4b/e0/4b1b9301b5cbf0e0544e522c2a8133e0.jpg?wh=1538*1400\" alt=\"\"></p><h2>å°ç»“</h2><p>è¿™ä¸€è®²ä»‹ç»äº†gRPCæ€æ ·ä½¿ç”¨HTTP/2å’ŒProtobufåè®®ç¼–ç æ¶ˆæ¯ã€‚</p><p>åœ¨å®šä¹‰å¥½æ¶ˆæ¯æ ¼å¼ï¼Œä»¥åŠserviceç±»ä¸­çš„RPCæ–¹æ³•åï¼ŒgRPCæ¡†æ¶å¯ä»¥ä¸ºç¼–ç¨‹è¯­è¨€ç”ŸæˆStubå’ŒServiceç±»ï¼Œè€Œç±»ä¸­çš„æ–¹æ³•å°±å°è£…äº†ç½‘ç»œè°ƒç”¨ï¼Œå…¶ä¸­æ–¹æ³•çš„å‚æ•°æ˜¯è¯·æ±‚ï¼Œè€Œæ–¹æ³•çš„è¿”å›å€¼åˆ™æ˜¯å“åº”ã€‚</p><p>å‘èµ·RPCè°ƒç”¨åï¼Œæˆ‘ä»¬å¯ä»¥è¿™ä¹ˆåˆ†ææŠ“å–åˆ°çš„ç½‘ç»œæŠ¥æ–‡ã€‚é¦–å…ˆï¼Œåˆ†æåº”ç”¨å±‚æœ€å¤–å±‚çš„HTTP/2å¸§ï¼Œæ ¹æ®Stream IDæ‰¾å‡ºä¸€æ¬¡RPCè°ƒç”¨ã€‚å®¢æˆ·ç«¯HTTPå¤´éƒ¨çš„pathå­—æ®µæŒ‡æ˜äº†serviceå’ŒRPCæ–¹æ³•åï¼Œè€Œcontent-typeåˆ™æŒ‡æ˜äº†æ¶ˆæ¯çš„ç¼–ç æ ¼å¼ã€‚æœåŠ¡å™¨ç«¯çš„HTTPå¤´éƒ¨è¢«åˆ†æˆ2æ¬¡å‘é€ï¼Œå…¶ä¸­DATAå¸§å‘é€å®Œæ¯•åï¼Œæ‰ä¼šå‘é€grpc-statuså¤´éƒ¨ï¼Œè¿™æ ·å¯ä»¥æ˜ç¡®æœ€ç»ˆçš„é”™è¯¯ç ã€‚</p><p>å…¶æ¬¡ï¼Œåˆ†æåŒ…ä½“æ—¶ï¼Œå¯ä»¥é€šè¿‡Streamä¸­Length-Prefixed Messageå¤´éƒ¨ï¼Œç¡®è®¤DATAå¸§ä¸­å«æœ‰å¤šå°‘ä¸ªæ¶ˆæ¯ï¼Œå› æ­¤å¯ä»¥ç¡®å®šè¿™æ˜¯ä¸€å…ƒæ¨¡å¼è¿˜æ˜¯æµå¼è°ƒç”¨ã€‚åœ¨Length-Prefixed Messageå¤´éƒ¨åï¼Œåˆ™æ˜¯Protobufæ¶ˆæ¯ï¼ŒæŒ‰ç…§ä¸Šä¸€è®²çš„å†…å®¹è¿›è¡Œåˆ†æå³å¯ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>æœ€åï¼Œç•™ç»™ä½ ä¸€é“ç»ƒä¹ é¢˜ã€‚gRPCé»˜è®¤å¹¶ä¸ä¼šå‹ç¼©å­—ç¬¦ä¸²ï¼Œä½ å¯ä»¥é€šè¿‡åœ¨è·å–channelå¯¹è±¡æ—¶åŠ å…¥grpc.default_compression_algorithmå‚æ•°çš„å½¢å¼ï¼Œè¦æ±‚gRPCå‹ç¼©æ¶ˆæ¯ï¼Œæ­¤æ—¶Length-Prefixed Messageä¸­1ä¸ªå­—èŠ‚çš„å‹ç¼©ä½å°†ä¼šç”±0å˜ä¸º1ã€‚ä½ å¯ä»¥è§‚å¯Ÿä¸‹æ‰§è¡Œå‹ç¼©åçš„gRPCæ¶ˆæ¯æœ‰ä½•ä¸åŒï¼Œæ¬¢è¿ä½ åœ¨ç•™è¨€åŒºä¸å¤§å®¶ä¸€èµ·æ¢è®¨ã€‚</p><p>æ„Ÿè°¢é˜…è¯»ï¼Œå¦‚æœä½ è§‰å¾—è¿™èŠ‚è¯¾å¯¹ä½ æœ‰ä¸€äº›å¯å‘ï¼Œä¹Ÿæ¬¢è¿æŠŠå®ƒåˆ†äº«ç»™ä½ çš„æœ‹å‹ã€‚</p>","comments":[{"had_liked":false,"id":226770,"user_name":"è¿œæ–¹çš„é£","can_delete":false,"product_type":"c1","uid":1043699,"ip_address":"","ucode":"DBF48C03E4F8FD","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eovXluTbBvyjZQ5zY8e3AZLONj6Qx5mcF4G7ZWYVbeicDzOlakFj4dKh6jCFHfqXvrLccuiaxYicmTxg/132","comment_is_top":false,"comment_ctime":1592200194,"is_pvip":false,"replies":[{"id":"83642","content":"ä½ å¥½è¿œæ–¹çš„é£ï¼Œä¸ç”¨ç€æ€¥ï¼Œèƒ½é—®å‡ºè¿™é—®é¢˜ï¼Œå°±è¡¨ç¤ºä½ åœ¨æœè¿™ä¸ªæ–¹å‘è¿›å‘ï¼Œå®ƒéœ€è¦æ—¶é—´ã€‚<br>æˆ‘å»ºè®®è¿™ä¹ˆåŠ å¿«é€Ÿåº¦ï¼šåœ¨å®è·µä¸­é‡åˆ°é—®é¢˜æ—¶ï¼Œå¤šé—®è‡ªå·±å‡ ä¸ªä¸ºä»€ä¹ˆï¼Œå°±ä¼šé¡ºç€æ‹ä¸‹æ¥ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæœ‰äº›è¶…è¿‡è‡ªå·±è¾¹ç•Œçš„é—®é¢˜ï¼Œå¿…é¡»è¦å¢åŠ å¹¿åº¦ï¼Œæ‰èƒ½ææ˜ç™½â€œä¸ºä»€ä¹ˆâ€ã€‚<br>æ¯”å¦‚åšgRPCåº”ç”¨å¼€å‘æ—¶ï¼Œå¦‚æœæƒ³ææ˜ç™½gRPCä¸ºä»€ä¹ˆå¯ä»¥ç”Ÿæˆstubä»£ç ï¼Œå°±å¾—å…ˆå¢åŠ å¹¿åº¦å»å­¦ä¸€å­¦ç¼–è¯‘åŸç†","user_name":"ä½œè€…å›å¤","user_name_real":"é™¶è¾‰","uid":"1283912","ctime":1592284688,"ip_address":"","comment_id":226770,"utype":1}],"discussion_count":1,"race_medal":0,"score":"83196578818","product_id":100051201,"comment_content":"è€å¸ˆçš„å¹¿åº¦å’Œæ·±åº¦æ˜¯å¦‚ä½•ç»ƒæˆçš„å‘¢ï¼Œæ˜¯çœ‹ä¹¦ï¼Œè¿˜æ˜¯å®é™…å·¥ä½œä¸­éƒ½æœ‰æ¶‰åŠï¼Ÿä¸€å¼€å§‹æwebå¼€å‘çš„ï¼Œå¯¹åº•å±‚è¿™äº›ç ”ç©¶çš„å°±æ²¡è¿™ä¹ˆæ·±äº†","like_count":19,"discussions":[{"author":{"id":1283912,"avatar":"https://static001.geekbang.org/account/avatar/00/13/97/48/550271b0.jpg","nickname":"é™¶è¾‰","note":"","ucode":"F81A9087435953","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":498358,"discussion_content":"ä½ å¥½è¿œæ–¹çš„é£ï¼Œä¸ç”¨ç€æ€¥ï¼Œèƒ½é—®å‡ºè¿™é—®é¢˜ï¼Œå°±è¡¨ç¤ºä½ åœ¨æœè¿™ä¸ªæ–¹å‘è¿›å‘ï¼Œå®ƒéœ€è¦æ—¶é—´ã€‚\næˆ‘å»ºè®®è¿™ä¹ˆåŠ å¿«é€Ÿåº¦ï¼šåœ¨å®è·µä¸­é‡åˆ°é—®é¢˜æ—¶ï¼Œå¤šé—®è‡ªå·±å‡ ä¸ªä¸ºä»€ä¹ˆï¼Œå°±ä¼šé¡ºç€æ‹ä¸‹æ¥ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæœ‰äº›è¶…è¿‡è‡ªå·±è¾¹ç•Œçš„é—®é¢˜ï¼Œå¿…é¡»è¦å¢åŠ å¹¿åº¦ï¼Œæ‰èƒ½ææ˜ç™½â€œä¸ºä»€ä¹ˆâ€ã€‚\næ¯”å¦‚åšgRPCåº”ç”¨å¼€å‘æ—¶ï¼Œå¦‚æœæƒ³ææ˜ç™½gRPCä¸ºä»€ä¹ˆå¯ä»¥ç”Ÿæˆstubä»£ç ï¼Œå°±å¾—å…ˆå¢åŠ å¹¿åº¦å»å­¦ä¸€å­¦ç¼–è¯‘åŸç†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592284688,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":246949,"user_name":"æœ¨å¤´å‘èŠ½","can_delete":false,"product_type":"c1","uid":1419723,"ip_address":"","ucode":"657B381C5DA963","user_header":"https://static001.geekbang.org/account/avatar/00/15/a9/cb/a431bde5.jpg","comment_is_top":false,"comment_ctime":1599537382,"is_pvip":false,"replies":[{"id":"90749","content":"è°¢è°¢æœ¨å¤´å‘èŠ½åŒå­¦çš„å®æˆ˜åˆ†äº«ï¼","user_name":"ä½œè€…å›å¤","user_name_real":"é™¶è¾‰","uid":"1283912","ctime":1599616046,"ip_address":"","comment_id":246949,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14484439270","product_id":100051201,"comment_content":"å…¬å¸æ‰€æœ‰é¡¹ç›®(å°ç¨‹åºç«¯é™¤å¤–)éƒ½é€‰å‹ç”¨äº†gRPC,ä¸æ­¢å¾®æœåŠ¡ä¹‹é—´è¿˜åŒ…æ‹¬äº†ç§»åŠ¨ç«¯,webç«¯åˆ°æœåŠ¡å™¨çš„é€šä¿¡.<br>18å¹´å¼€å§‹ä½¿ç”¨æ—¶è¿˜é‡åˆ°ä¸å°çš„é˜»åŠ›,ç‰¹åˆ«æ˜¯å®¢æˆ·ç«¯ç¦»å¼€äº†http+jsonçš„èˆ’é€‚åŒºè½¬åˆ°gRpc+pb è¦ç ”ç©¶æ€ä¹ˆä½¿ç”¨.ä¹Ÿé‡åˆ°äº†ä¸å°‘å‘æ¯”å¦‚:<br>iOSçš„protocç¼–å‡ºçš„ä»£ç æ— æ³•å»ºç«‹tlsè¿æ¥ä¸€è‡´å¡åœ¨è¯ä¹¦æ ¡éªŒæ­¥éª¤.<br>grpc-webåœ¨æµè§ˆå™¨http1.1è½¬http2çš„é—®é¢˜.<br>envoyåšä»£ç†å’Œè´Ÿè½½å‡è¡¡å¯¼è‡´å¤§é‡è¿æ¥å¤„äºclosedçŠ¶æ€çš„é—®é¢˜.<br>åœ¨èµ°å®Œä¸€éå,åé¢å°±ç”¨èµ·æ¥éå¸¸çš„çˆ½äº†.<br><br>ä¸è¿‡æµçš„ç”¨æ³•è¿˜æ²¡å®è·µ,é€šè¿‡è¿™èŠ‚è¯¾åˆåŠ æ·±äº†ä¸€äº›,æ‰¾ä¸ªç‰ˆæœ¬ä½¿ç”¨ä¸€ä¸‹æµæ–¹å¼çš„æ¥å£.","like_count":4,"discussions":[{"author":{"id":1283912,"avatar":"https://static001.geekbang.org/account/avatar/00/13/97/48/550271b0.jpg","nickname":"é™¶è¾‰","note":"","ucode":"F81A9087435953","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":505269,"discussion_content":"è°¢è°¢æœ¨å¤´å‘èŠ½åŒå­¦çš„å®æˆ˜åˆ†äº«ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599616046,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":233051,"user_name":"å¤å“¥","can_delete":false,"product_type":"c1","uid":2053749,"ip_address":"","ucode":"E0B2C6F35EB0FD","user_header":"https://static001.geekbang.org/account/avatar/00/1f/56/75/6bf38a1e.jpg","comment_is_top":false,"comment_ctime":1594204030,"is_pvip":false,"replies":[{"id":"90729","content":"è°¢è°¢å¤å“¥^_^","user_name":"ä½œè€…å›å¤","user_name_real":"é™¶è¾‰","uid":"1283912","ctime":1599557714,"ip_address":"","comment_id":233051,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10184138622","product_id":100051201,"comment_content":"é™¶å“¥ï¼Œä½ çš„æŠ€æœ¯çœŸä¸ç®€å•äº†ï¼Œä¹°äº†ç¬¬äºŒé—¨webåè®®è®²è¯¾ç¨‹ï¼Œå¸Œæœ›èƒ½è·Ÿéšä½ çš„æ­¥ä¼æˆé•¿ï¼Œä½ æ¯”æˆ‘è€å¤§æ›´ç‰›","like_count":2,"discussions":[{"author":{"id":1283912,"avatar":"https://static001.geekbang.org/account/avatar/00/13/97/48/550271b0.jpg","nickname":"é™¶è¾‰","note":"","ucode":"F81A9087435953","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":500872,"discussion_content":"è°¢è°¢å¤å“¥^_^","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599557714,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":232670,"user_name":"J.Smile","can_delete":false,"product_type":"c1","uid":1336475,"ip_address":"","ucode":"C4D98DFDBF7584","user_header":"https://static001.geekbang.org/account/avatar/00/14/64/9b/0b578b08.jpg","comment_is_top":false,"comment_ctime":1594084063,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5889051359","product_id":100051201,"comment_content":"â€œåˆ†æåŒ…ä½“æ—¶ï¼Œå¯ä»¥é€šè¿‡ Stream ä¸­ Length-Prefixed Message å¤´éƒ¨ï¼Œç¡®è®¤ DATA å¸§ä¸­å«æœ‰å¤šå°‘ä¸ªæ¶ˆæ¯ï¼Œå› æ­¤å¯ä»¥ç¡®å®šè¿™æ˜¯ä¸€å…ƒæ¨¡å¼è¿˜æ˜¯æµå¼è°ƒç”¨â€<br>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”<br>è€å¸ˆå¥½ï¼ŒLength-Prefixed Message å¤´éƒ¨ä¸æ˜¯åªæœ‰é•¿åº¦å’Œæ˜¯å¦å‹ç¼©å—ï¼Ÿæ€ä¹ˆèƒ½ç¡®è®¤æœ‰å¤šå°‘ä¸ªæ¶ˆæ¯çš„ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1133945,"avatar":"https://static001.geekbang.org/account/avatar/00/11/4d/79/803537db.jpg","nickname":"æ…¢åŠ¨ä½œ","note":"","ucode":"62C944F4A4D8AC","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":381248,"discussion_content":"åº”è¯¥æ˜¯æŒ‡ä¸€ä¸ªæ¶ˆæ¯æœ‰ä¸€ä¸ªï¼Œå‡ ä¸ªå°±å‡ ä¸ªæ¶ˆæ¯","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1624967975,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":227026,"user_name":"å”æœé¦–éƒ½","can_delete":false,"product_type":"c1","uid":1081233,"ip_address":"","ucode":"F72655AE0AE4CA","user_header":"https://static001.geekbang.org/account/avatar/00/10/7f/91/962eba1a.jpg","comment_is_top":false,"comment_ctime":1592269180,"is_pvip":true,"replies":[{"id":"83639","content":"æ²¡é”™ï¼","user_name":"ä½œè€…å›å¤","user_name_real":"é™¶è¾‰","uid":"1283912","ctime":1592284041,"ip_address":"","comment_id":227026,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5887236476","product_id":100051201,"comment_content":"åŸºæœ¬åŸç†+å·¥å…·ä½¿ç”¨ï¼Œç†è®ºç»“åˆå®è·µæ‰èƒ½æŠŠè¿™äº›åè®®ææ¸…æ¥šå‘€ï¼","like_count":1,"discussions":[{"author":{"id":1283912,"avatar":"https://static001.geekbang.org/account/avatar/00/13/97/48/550271b0.jpg","nickname":"é™¶è¾‰","note":"","ucode":"F81A9087435953","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":498462,"discussion_content":"æ²¡é”™ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592284041,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":226654,"user_name":"å®‰æ’","can_delete":false,"product_type":"c1","uid":1260026,"ip_address":"","ucode":"F78CFA9624CAEF","user_header":"https://static001.geekbang.org/account/avatar/00/13/39/fa/a7edbc72.jpg","comment_is_top":false,"comment_ctime":1592180130,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5887147426","product_id":100051201,"comment_content":"clientæµæ¨¡å¼ä¸­æ˜¯ä¸æ˜¯æ¯ä¸€ä¸ªrpcè¯·æ±‚æ¶ˆæ¯çš„ç¬¬ä¸€ä¸ªdataå¸§ä¸­æ‰æœ‰Length-Prefixed Message ï¼Œç„¶åä¸‹ä¸€ä¸ªdataå¸§åªæœ‰protobufæ•°æ®ï¼Œç›´åˆ°è¿™ä¸ªrpcè¯·æ±‚æ¶ˆæ¯å‘å®Œã€‚ç„¶ååŒä¸€ä¸ªstreamä¸Šçš„ä¸‹ä¸€ä¸ªrpcæ¶ˆæ¯çš„ç¬¬ä¸€ä¸ªdataå¸§å†åŠ å…¥Length-Prefixed Message ã€‚ä»¥æ­¤ç±»æ¨ã€‚","like_count":1,"discussions":[{"author":{"id":1205253,"avatar":"https://static001.geekbang.org/account/avatar/00/12/64/05/6989dce6.jpg","nickname":"æˆ‘æ¥ä¹Ÿ","note":"","ucode":"773D6104F56767","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":283449,"discussion_content":"ä»Šå¤©è¯•äº†ä¸€ä¸‹,æµæ¨¡å¼ä¸‹,æ¯ä¸ªrpcè¯·æ±‚æ¶ˆæ¯çš„å“åº”ä¸­,ç¬¬ä¸€ä¸ªæ˜¯Type: HEADERS, åé¢çš„æ¶ˆæ¯çš„Type: DATA,æ¶ˆæ¯ä¼šæœ‰å¾ˆå¤š.ä½†æ˜¯å¤´åªæœ‰ä¸€ä¸ª.\nStream: HEADERS, Stream ID: 1, Length 97, POST /routeguide.RouteGuide/RouteChat\n  Length: 97\n  Type: HEADERS (1)\n  Flags: 0x04\n    .... ...0 = End Stream: False\n    .... .1.. = End Headers: True\n    .... 0... = Padded: False\n    ..0. .... = Priority: False\n    00.0 ..0. = Unused: 0x00\n  0... .... .... .... .... .... .... .... = Reserved: 0x0\n  .000 0000 0000 0000 0000 0000 0000 0001 = Stream Identifier: 1\n  [Pad Length: 0]\n  Header Block Fragment: 8386459762c3da92cd69a42afb4f6a4b8ad34856369ed496â€¦\n  [Header Length: 234]\n  [Header Count: 8]\n  Header: :method: POST\n  Header: :scheme: http\n  Header: :path: /routeguide.RouteGuide/RouteChat\n  Header: :authority: 127.0.0.1:10000\n  Header: content-type: application/grpc\n  Header: user-agent: grpc-go/1.20.0-dev\n  Header: te: trailers\n  Header: grpc-timeout: 9997330u\nStream: DATA, Stream ID: 1, Length 24 (partial entity body)\n  Length: 24\n  Type: DATA (0)\n  Flags: 0x00\n    .... ...0 = End Stream: False\n    .... 0... = Padded: False\n    0000 .00. = Unused: 0x00\n  0... .... .... .... .... .... .... .... = Reserved: 0x0\n  .000 0000 0000 0000 0000 0000 0000 0001 = Stream Identifier: 1\n  [Pad Length: 0]\n  Reassembled body in frame: 404\n  Data: 00000000130a021001120d4669727374206d657373616765\nStream: DATA, Stream ID: 1, Length 25 (partial entity body)\n  Length: 25\n  Type: DATA (0)\n  Flags: 0x00\n    .... ...0 = End Stream: False\n    .... 0... = Padded: False\n    0000 .00. = Unused: 0x00\n  0... .... .... .... .... .... .... .... = Reserved: 0x0\n  .000 0000 0000 0000 0000 0000 0000 0001 = Stream Identifier: 1\n  [Pad Length: 0]\n  Reassembled body in frame: 404\n  Data: 00000000140a021002120e5365636f6e64206d6573736167â€¦\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592275917,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":349469,"user_name":"æœ¨å‡ ä¸¶","can_delete":false,"product_type":"c1","uid":2420294,"ip_address":"","ucode":"FFDB958DA64F8C","user_header":"https://static001.geekbang.org/account/avatar/00/24/ee/46/7d65ae37.jpg","comment_is_top":false,"comment_ctime":1655983440,"is_pvip":true,"discussion_count":0,"race_medal":2,"score":"1655983440","product_id":100051201,"comment_content":"è€å¸ˆï¼Œä»æŠ“åŒ…çœ‹ï¼Œgrpcä¸‰æ¬¡æ¡æ‰‹åå‡çº§ä¸ºHTTP2åè®®ï¼Œä¸ºä»€ä¹ˆæ—¢æ²¡æœ‰åŸºäºTCPçš„101çŠ¶æ€ç å‡çº§ï¼Œä¹Ÿæ²¡æœ‰åŸºäºTLSæ¡æ‰‹å‡çº§å‘¢ï¼Ÿç›´æ¥å°±å¼€å§‹å‘é€MAGICå¸§äº†","like_count":0},{"had_liked":false,"id":272683,"user_name":"ç–¯ç´","can_delete":false,"product_type":"c1","uid":1099379,"ip_address":"","ucode":"82ACAA4A27753D","user_header":"https://static001.geekbang.org/account/avatar/00/10/c6/73/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1610201567,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1610201567","product_id":100051201,"comment_content":"è€å¸ˆï¼Œæˆ‘åˆè¯•äº†ä¸€ä¸‹ï¼Œå¦‚æœæ¶ˆæ¯å†…å®¹æ¯”è¾ƒå¤§ï¼Œå‹ç¼©ä¼šç¼©å°å°ºå¯¸ï¼Œå¦‚æœæ¶ˆæ¯å†…å®¹æ¯”è¾ƒå°ï¼Œå‹ç¼©åè€Œä¼šå¢å¤§å°ºå¯¸ã€‚","like_count":0},{"had_liked":false,"id":272681,"user_name":"ç–¯ç´","can_delete":false,"product_type":"c1","uid":1099379,"ip_address":"","ucode":"82ACAA4A27753D","user_header":"https://static001.geekbang.org/account/avatar/00/10/c6/73/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1610200643,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1610200643","product_id":100051201,"comment_content":"è€å¸ˆï¼Œè¿™ä¸¤èŠ‚è¯¾å—ç›ŠåŒªæµ…ï¼Œè‡ªå·±å®è·µäº†ä¸€ä¸‹ã€‚æˆ‘çš„æ¶ˆæ¯å†…å®¹åªæœ‰ä¸€ä¸ª7ä¸ªå­—èŠ‚çš„å­—ç¬¦ä¸²ï¼ŒåŠ ä¸Šåºå·å’Œç±»å‹æ˜¯9ä¸ªå­—èŠ‚ï¼Œå¦‚æœä¸å‹ç¼©ï¼Œæ¶ˆæ¯ä½“å°±æ˜¯9ä¸ªå­—èŠ‚ï¼Œå¦‚æœå‹ç¼©ï¼Œåœ¨grpcæ¶ˆæ¯ä¸­æœ‰è¿™ä¹ˆä¸€æ¡ï¼šMessage-encoded entity body (gzip): 33 bytes -&gt; 9 bytesï¼Œæ¶ˆæ¯ä½“è¿˜æ˜¯ä¸€æ ·çš„ï¼Œè¿™33å­—èŠ‚æ˜¯æ€ä¹ˆæ¥çš„å‘¢ï¼Ÿä¸ºä»€ä¹ˆ9ä¸ªå­—èŠ‚çš„bodyä¹Ÿæ²¡æœ‰å˜åŒ–å‘¢ï¼Ÿ","like_count":0},{"had_liked":false,"id":232671,"user_name":"J.Smile","can_delete":false,"product_type":"c1","uid":1336475,"ip_address":"","ucode":"C4D98DFDBF7584","user_header":"https://static001.geekbang.org/account/avatar/00/14/64/9b/0b578b08.jpg","comment_is_top":false,"comment_ctime":1594084335,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1594084335","product_id":100051201,"comment_content":"è®°å¾—ä»¥å‰çœ‹åˆ°è¯´ï¼Œ å¸§çš„æœ€å4ä¸ªå­—èŠ‚å°±æ˜¯StreamIdï¼Œæ¥æ”¶æ–¹é€šè¿‡StreamIdä»ä¹±åºçš„å¸§ä¸­è¯†åˆ«å‡ºç›¸åŒStreamIdçš„å¸§åºåˆ—ï¼ŒæŒ‰ç…§é¡ºåºç»„è£…èµ·æ¥å°±å®ç°äº†è™šæ‹Ÿçš„â€œæµâ€ã€‚<br>","like_count":0},{"had_liked":false,"id":230023,"user_name":"ä¸ä¼šé£çš„æµ·ç‡•","can_delete":false,"product_type":"c1","uid":2029872,"ip_address":"","ucode":"76EEACB32735F8","user_header":"https://static001.geekbang.org/account/avatar/00/1e/f9/30/54c71bf9.jpg","comment_is_top":false,"comment_ctime":1593243345,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1593243345","product_id":100051201,"comment_content":"è€å¸ˆæœ‰grpcæ–¹é¢çš„ä¼˜åŒ–ï¼Œæ·±åº¦å®šåˆ¶æ¡ˆä¾‹ ä»‹ç»å—","like_count":0},{"had_liked":false,"id":228529,"user_name":"ğŸ§é‡è¿”å½’é€”","can_delete":false,"product_type":"c1","uid":1991518,"ip_address":"","ucode":"33F748AE188B07","user_header":"https://static001.geekbang.org/account/avatar/00/1e/63/5e/799cd6dc.jpg","comment_is_top":false,"comment_ctime":1592726463,"is_pvip":false,"replies":[{"id":"84355","content":"protobufæ˜¯ä¸€ç§ç¼–ç æ ¼å¼ï¼Œä»è¿™ç§è§’åº¦ä¸Šï¼ŒæŠŠå®ƒä¸jsonã€XMLä½œæ¯”è¾ƒæ˜¯åˆé€‚çš„","user_name":"ä½œè€…å›å¤","user_name_real":"é™¶è¾‰","uid":"1283912","ctime":1592808033,"ip_address":"","comment_id":228529,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1592726463","product_id":100051201,"comment_content":"protobufæ˜¯å±äºåè®®è¿˜æ˜¯æ–‡ä»¶æ ¼å¼ï¼Œçœ‹åˆ°æœ‰èµ„æ–™è¯´æŠŠprotobufå’Œjsonå’Œxmlä½œæ¯”è¾ƒï¼Ÿåˆé€‚ä¹ˆï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1283912,"avatar":"https://static001.geekbang.org/account/avatar/00/13/97/48/550271b0.jpg","nickname":"é™¶è¾‰","note":"","ucode":"F81A9087435953","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":499066,"discussion_content":"protobufæ˜¯ä¸€ç§ç¼–ç æ ¼å¼ï¼Œä»è¿™ç§è§’åº¦ä¸Šï¼ŒæŠŠå®ƒä¸jsonã€XMLä½œæ¯”è¾ƒæ˜¯åˆé€‚çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592808033,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":226815,"user_name":"èš‚èšå†…æ¨+v","can_delete":false,"product_type":"c1","uid":1050508,"ip_address":"","ucode":"24B10AEE54B3FD","user_header":"https://static001.geekbang.org/account/avatar/00/10/07/8c/0d886dcc.jpg","comment_is_top":false,"comment_ctime":1592208979,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1592208979","product_id":100051201,"comment_content":"ä»http1.1 å‡çº§åˆ° http2.0 è¦å“ªäº›åœ°æ–¹æ”¹é€ å‘¢ï¼Œå°±æ”¹ä¸ªversionCode å—","like_count":0}]}