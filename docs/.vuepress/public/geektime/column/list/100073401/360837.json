{"id":360837,"title":"13 | å¹¿æ’­å˜é‡ï¼ˆäºŒï¼‰ï¼šå¦‚ä½•è®©Spark SQLé€‰æ‹©Broadcast Joinsï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å´ç£Šã€‚</p><p>ä¸Šä¸€è®²æˆ‘ä»¬è¯´åˆ°ï¼Œåœ¨æ•°æ®å…³è”åœºæ™¯ä¸­ï¼Œå¹¿æ’­å˜é‡æ˜¯å…‹åˆ¶Shuffleçš„æ€æ‰‹é”ï¼Œç”¨Broadcast Joinså–ä»£Shuffle Joinså¯ä»¥å¤§å¹…æå‡æ‰§è¡Œæ€§èƒ½ã€‚ä½†æ˜¯ï¼Œå¾ˆå¤šåŒå­¦åªä¼šä½¿ç”¨é»˜è®¤çš„å¹¿æ’­å˜é‡ï¼Œä¸ä¼šå»è°ƒä¼˜ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬è¯¥æ€ä¹ˆä¿è¯Sparkåœ¨è¿è¡Œæ—¶ä¼˜å…ˆé€‰æ‹©Broadcast Joinsç­–ç•¥å‘¢ï¼Ÿ</p><p>ä»Šå¤©è¿™ä¸€è®²ï¼Œæˆ‘å°±å›´ç»•ç€æ•°æ®å…³è”åœºæ™¯ï¼Œä»é…ç½®é¡¹å’Œå¼€å‘APIä¸¤ä¸ªæ–¹é¢ï¼Œå¸®ä½ æ¢³ç†å‡ºä¸¤ç±»è°ƒä¼˜æ‰‹æ®µï¼Œè®©ä½ èƒ½å¤Ÿæ¸¸åˆƒæœ‰ä½™åœ°è¿ç”¨å¹¿æ’­å˜é‡ã€‚</p><h2>åˆ©ç”¨é…ç½®é¡¹å¼ºåˆ¶å¹¿æ’­</h2><p>æˆ‘ä»¬å…ˆæ¥ä»é…ç½®é¡¹çš„è§’åº¦è¯´ä¸€è¯´ï¼Œæœ‰å“ªäº›åŠæ³•å¯ä»¥è®©Sparkä¼˜å…ˆé€‰æ‹©Broadcast Joinsã€‚åœ¨Spark SQLé…ç½®é¡¹é‚£ä¸€è®²ï¼Œæˆ‘ä»¬æåˆ°è¿‡spark.sql.autoBroadcastJoinThresholdè¿™ä¸ªé…ç½®é¡¹ã€‚å®ƒçš„è®¾ç½®å€¼æ˜¯å­˜å‚¨å¤§å°ï¼Œé»˜è®¤æ˜¯10MBã€‚å®ƒçš„å«ä¹‰æ˜¯ï¼Œ<strong>å¯¹äºå‚ä¸Joinçš„ä¸¤å¼ è¡¨æ¥è¯´ï¼Œä»»æ„ä¸€å¼ è¡¨çš„å°ºå¯¸å°äº10MBï¼ŒSparkå°±åœ¨è¿è¡Œæ—¶é‡‡ç”¨Broadcast Joinsçš„å®ç°æ–¹å¼å»åšæ•°æ®å…³è”ã€‚</strong>å¦å¤–ï¼ŒAQEåœ¨è¿è¡Œæ—¶å°è¯•åŠ¨æ€è°ƒæ•´Joinç­–ç•¥æ—¶ï¼Œä¹Ÿæ˜¯åŸºäºè¿™ä¸ªå‚æ•°æ¥åˆ¤å®šè¿‡æ»¤åçš„æ•°æ®è¡¨æ˜¯å¦è¶³å¤Ÿå°ï¼Œä»è€ŒæŠŠåŸæœ¬çš„Shuffle Joinsè°ƒæ•´ä¸ºBroadcast Joinsã€‚</p><!-- [[[read_end]]] --><p><img src=\"https://static001.geekbang.org/resource/image/69/89/697cccb272fc8863f40bb7c465f53c89.jpeg?wh=1785*348\" alt=\"\"></p><p>ä¸ºäº†æ–¹ä¾¿ä½ ç†è§£ï¼Œæˆ‘æ¥ä¸¾ä¸ªä¾‹å­ã€‚åœ¨æ•°æ®ä»“åº“ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šçœ‹åˆ°ä¸¤å¼ è¡¨ï¼šä¸€å¼ æ˜¯è®¢å•äº‹å®è¡¨ï¼Œä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä»¬æŠŠå®ƒè®°æˆFactï¼›å¦ä¸€å¼ æ˜¯ç”¨æˆ·ç»´åº¦è¡¨ï¼Œè®°æˆDimã€‚äº‹å®è¡¨ä½“é‡å¾ˆå¤§åœ¨100GBé‡çº§ï¼Œç»´åº¦è¡¨å¾ˆå°åœ¨1GBå·¦å³ã€‚ä¸¤å¼ è¡¨çš„Schemaå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>//è®¢å•äº‹å®è¡¨Schema\norderID: Int\nuserID: Int\ntrxDate: Timestamp\nproductId: Int\nprice: Float\nvolume: Int\n \n//ç”¨æˆ·ç»´åº¦è¡¨Schema\nuserID: Int\nname: String\nage: Int\ngender: String\n</code></pre><p>å½“Factè¡¨å’ŒDimè¡¨åŸºäºuserIDåšå…³è”çš„æ—¶å€™ï¼Œç”±äºä¸¤å¼ è¡¨çš„å°ºå¯¸å¤§å°éƒ½è¿œè¶…spark.sql.autoBroadcastJoinThresholdå‚æ•°çš„é»˜è®¤å€¼10MBï¼Œå› æ­¤Sparkä¸å¾—ä¸é€‰æ‹©Shuffle Joinsçš„å®ç°æ–¹å¼ã€‚ä½†å¦‚æœæˆ‘ä»¬æŠŠè¿™ä¸ªå‚æ•°çš„å€¼è°ƒæ•´ä¸º2GBï¼Œå› ä¸ºDimè¡¨çš„å°ºå¯¸æ¯”2GBå°ï¼Œæ‰€ä»¥ï¼ŒSparkåœ¨è¿è¡Œæ—¶ä¼šé€‰æ‹©æŠŠDimè¡¨å°è£…åˆ°å¹¿æ’­å˜é‡é‡Œï¼Œå¹¶é‡‡ç”¨Broadcast Joinçš„æ–¹å¼æ¥å®Œæˆä¸¤å¼ è¡¨çš„æ•°æ®å…³è”ã€‚</p><p>æ˜¾ç„¶ï¼Œå¯¹äºç»å¤§å¤šæ•°çš„Joinåœºæ™¯æ¥è¯´ï¼ŒautoBroadcastJoinThresholdå‚æ•°çš„é»˜è®¤å€¼10MBå¤ªä½äº†ï¼Œå› ä¸ºç°åœ¨ä¼ä¸šçš„æ•°æ®ä½“é‡éƒ½åœ¨TBï¼Œç”šè‡³PBçº§åˆ«ã€‚å› æ­¤ï¼Œæƒ³è¦æœ‰æ•ˆåœ°åˆ©ç”¨Broadcast Joinsï¼Œæˆ‘ä»¬éœ€è¦æŠŠå‚æ•°å€¼è°ƒå¤§ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œ2GBå·¦å³æ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ã€‚</p><p>ç°åœ¨æˆ‘ä»¬å·²ç»çŸ¥é“äº†ï¼Œ<strong>ä½¿ç”¨å¹¿æ’­é˜ˆå€¼é…ç½®é¡¹è®©Sparkä¼˜å…ˆé€‰æ‹©Broadcast Joinsçš„å…³é”®ï¼Œå°±æ˜¯è¦ç¡®ä¿è‡³å°‘æœ‰ä¸€å¼ è¡¨çš„å­˜å‚¨å°ºå¯¸å°äºå¹¿æ’­é˜ˆå€¼</strong>ã€‚</p><p>ä½†æ˜¯ï¼Œåœ¨è®¾ç½®å¹¿æ’­é˜ˆå€¼çš„æ—¶å€™ï¼Œä¸å°‘åŒå­¦éƒ½è·Ÿæˆ‘æŠ±æ€¨ï¼šâ€œæˆ‘çš„æ•°æ®é‡æ˜æ˜å°äºautoBroadcastJoinThresholdå‚æ•°è®¾å®šçš„å¹¿æ’­é˜ˆå€¼ï¼Œä¸ºä»€ä¹ˆSpark SQLåœ¨è¿è¡Œæ—¶å¹¶æ²¡æœ‰é€‰æ‹©Broadcast Joinså‘¢ï¼Ÿâ€</p><p>è¯¦ç»†äº†è§£åæˆ‘æ‰çŸ¥é“ï¼Œè¿™äº›åŒå­¦æ‰€è¯´çš„æ•°æ®é‡ï¼Œ<strong>å…¶å®æŒ‡çš„æ˜¯æ•°æ®è¡¨åœ¨ç£ç›˜ä¸Šçš„å­˜å‚¨å¤§å°</strong>ï¼Œæ¯”å¦‚ç”¨<code>ls</code>æˆ–æ˜¯<code>du -sh</code>ç­‰ç³»ç»Ÿå‘½ä»¤æŸ¥çœ‹æ–‡ä»¶å¾—åˆ°çš„ç»“æœã€‚è¦çŸ¥é“ï¼ŒåŒä¸€ä»½æ•°æ®åœ¨å†…å­˜ä¸­çš„å­˜å‚¨å¤§å°å¾€å¾€ä¼šæ¯”ç£ç›˜ä¸­çš„å­˜å‚¨å¤§å°è†¨èƒ€æ•°å€ï¼Œç”šè‡³åæ•°å€ã€‚è¿™ä¸»è¦æœ‰ä¸¤æ–¹é¢åŸå› ã€‚</p><p>ä¸€æ–¹é¢ï¼Œä¸ºäº†æå‡å­˜å‚¨å’Œè®¿é—®æ•ˆç‡ï¼Œå¼€å‘è€…ä¸€èˆ¬é‡‡ç”¨Parquetæˆ–æ˜¯ORCç­‰å‹ç¼©æ ¼å¼æŠŠæ•°æ®è½ç›˜ã€‚è¿™äº›é«˜å‹ç¼©æ¯”çš„ç£ç›˜æ•°æ®å±•å¼€åˆ°å†…å­˜ä¹‹åï¼Œæ•°æ®é‡å¾€å¾€ä¼šç¿»ä¸Šæ•°å€ã€‚</p><p>å¦ä¸€æ–¹é¢ï¼Œå—é™äºå¯¹è±¡ç®¡ç†æœºåˆ¶ï¼Œåœ¨å †å†…å†…å­˜ä¸­ï¼ŒJVMå¾€å¾€éœ€è¦æ¯”æ•°æ®åŸå§‹å°ºå¯¸æ›´å¤§çš„å†…å­˜ç©ºé—´æ¥å­˜å‚¨å¯¹è±¡ã€‚</p><p>æˆ‘ä»¬æ¥ä¸¾ä¸ªä¾‹å­ï¼Œå­—ç¬¦ä¸²â€œabcdâ€æŒ‰ç†è¯´åªéœ€è¦æ¶ˆè€—4ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯ï¼ŒJVMåœ¨å †å†…å­˜å‚¨è¿™4ä¸ªå­—ç¬¦ä¸²æ€»å…±éœ€è¦æ¶ˆè€—48ä¸ªå­—èŠ‚ï¼é‚£åœ¨è¿è¡Œæ—¶ï¼Œä¸€ä»½çœ‹ä¸Šå»ä¸å¤§çš„ç£ç›˜æ•°æ®å±•å¼€åˆ°å†…å­˜ï¼Œç¿»ä¸Šä¸ª4ã€5å€å¹¶ä¸ç¨€å¥‡ã€‚å› æ­¤ï¼Œå¦‚æœä½ æŒ‰ç…§ç£ç›˜ä¸Šçš„å­˜å‚¨å¤§å°å»é…ç½®autoBroadcastJoinThresholdå¹¿æ’­é˜ˆå€¼ï¼Œå¤§æ¦‚ç‡ä¹Ÿä¼šé‡åˆ°åŒæ ·çš„çª˜å¢ƒã€‚</p><p><strong>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œæœ‰ä»€ä¹ˆåŠæ³•èƒ½å‡†ç¡®åœ°é¢„ä¼°ä¸€å¼ è¡¨åœ¨å†…å­˜ä¸­çš„å­˜å‚¨å¤§å°å‘¢ï¼Ÿ</strong></p><p>é¦–å…ˆï¼Œæˆ‘ä»¬è¦é¿å¼€ä¸€ä¸ªå‘ã€‚æˆ‘å‘ç°ï¼Œæœ‰å¾ˆå¤šèµ„æ–™æ¨èç”¨Sparkå†…ç½®çš„SizeEstimatorå»é¢„ä¼°åˆ†å¸ƒå¼æ•°æ®é›†çš„å­˜å‚¨å¤§å°ã€‚ç»“åˆå¤šæ¬¡å®æˆ˜å’Œè¸©å‘ç»éªŒï¼Œå’±ä»¬å¿…é¡»è¦æŒ‡å‡ºï¼Œ<strong>SizeEstimatorçš„ä¼°ç®—ç»“æœä¸å‡†ç¡®</strong>ã€‚å› æ­¤ï¼Œä½ å¯ä»¥ç›´æ¥è·³è¿‡è¿™ç§æ–¹æ³•ï¼Œè¿™ä¹Ÿèƒ½èŠ‚çœä½ è°ƒä¼˜çš„æ—¶é—´å’Œç²¾åŠ›ã€‚</p><p>æˆ‘è®¤ä¸ºæ¯”è¾ƒé è°±çš„åŠæ³•æ˜¯ï¼š<strong>ç¬¬ä¸€æ­¥ï¼ŒæŠŠè¦é¢„ä¼°å¤§å°çš„æ•°æ®è¡¨ç¼“å­˜åˆ°å†…å­˜ï¼Œæ¯”å¦‚ç›´æ¥åœ¨DataFrameæˆ–æ˜¯Datasetä¸Šè°ƒç”¨cacheæ–¹æ³•ï¼›ç¬¬äºŒæ­¥ï¼Œè¯»å–Spark SQLæ‰§è¡Œè®¡åˆ’çš„ç»Ÿè®¡æ•°æ®</strong>ã€‚è¿™æ˜¯å› ä¸ºï¼ŒSpark SQLåœ¨è¿è¡Œæ—¶ï¼Œå°±æ˜¯é è¿™äº›ç»Ÿè®¡æ•°æ®æ¥åˆ¶å®šå’Œè°ƒæ•´æ‰§è¡Œç­–ç•¥çš„ã€‚</p><pre><code>val df: DataFrame = _\ndf.cache.count\n \nval plan = df.queryExecution.logical\nval estimated: BigInt = spark\n.sessionState\n.executePlan(plan)\n.optimizedPlan\n.stats\n.sizeInBytes\n</code></pre><p>ä½ å¯èƒ½ä¼šè¯´ï¼šâ€œè¿™ç§åŠæ³•è™½ç„¶ç²¾ç¡®ï¼Œä½†æ˜¯è¿™ä¹ˆåšï¼Œå®é™…ä¸Šå·²ç»æ˜¯åœ¨è¿è¡Œæ—¶è¿›è¡Œè°ƒä¼˜äº†ã€‚æŠŠæ•°æ®å…ˆç¼“å­˜åˆ°å†…å­˜ï¼Œå†å»è®¡ç®—å®ƒçš„å­˜å‚¨å°ºå¯¸ï¼Œå½“ç„¶æ›´å‡†ç¡®äº†ã€‚â€æ²¡é”™ï¼Œé‡‡ç”¨è¿™ç§è®¡ç®—æ–¹å¼ï¼Œè°ƒä¼˜æ‰€éœ€èŠ±è´¹çš„æ—¶é—´å’Œç²¾åŠ›ç¡®å®æ›´å¤šï¼Œä½†åœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼Œå°¤å…¶æ˜¯Shuffle Joinsçš„æ‰§è¡Œæ•ˆç‡è®©ä½ ç—›ä¸æ¬²ç”Ÿçš„æ—¶å€™ï¼Œè¿™æ ·çš„ä»˜å‡ºæ˜¯å€¼å¾—çš„ã€‚</p><h2>åˆ©ç”¨APIå¼ºåˆ¶å¹¿æ’­</h2><p>æ—¢ç„¶æ•°æ®é‡çš„é¢„ä¼°è¿™ä¹ˆéº»çƒ¦ï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆåŠæ³•ï¼Œä¸éœ€è¦é…ç½®å¹¿æ’­é˜ˆå€¼ï¼Œå°±å¯ä»¥è®©Spark SQLé€‰æ‹©Broadcast Joinsï¼Ÿè¿˜çœŸæœ‰ï¼Œè€Œä¸”åŠæ³•è¿˜ä¸æ­¢ä¸€ç§ã€‚</p><p>å¼€å‘è€…å¯ä»¥é€šè¿‡Join Hintsæˆ–æ˜¯SQL functionsä¸­çš„broadcastå‡½æ•°ï¼Œæ¥å¼ºåˆ¶Spark SQLåœ¨è¿è¡Œæ—¶é‡‡ç”¨Broadcast Joinsçš„æ–¹å¼åšæ•°æ®å…³è”ã€‚ä¸‹é¢æˆ‘å°±æ¥åˆ†åˆ«è®²ä¸€è®²å®ƒä»¬çš„å«ä¹‰å’Œä½œç”¨ï¼Œä»¥åŠè¯¥å¦‚ä½•ä½¿ç”¨ã€‚å¿…é¡»è¦è¯´æ˜çš„æ˜¯ï¼Œè¿™ä¸¤ç§æ–¹å¼æ˜¯ç­‰ä»·çš„ï¼Œå¹¶æ— ä¼˜åŠ£ä¹‹åˆ†ï¼Œåªä¸è¿‡æœ‰äº†å¤šæ ·åŒ–çš„é€‰æ‹©ä¹‹åï¼Œä½ å°±å¯ä»¥æ ¹æ®è‡ªå·±çš„åå¥½å’Œä¹ æƒ¯æ¥çµæ´»åœ°è¿›è¡Œå¼€å‘ã€‚</p><h3>ç”¨Join Hintså¼ºåˆ¶å¹¿æ’­</h3><p>Join Hintsä¸­çš„Hintsè¡¨ç¤ºâ€œæç¤ºâ€ï¼Œå®ƒæŒ‡çš„æ˜¯åœ¨å¼€å‘è¿‡ç¨‹ä¸­ä½¿ç”¨ç‰¹æ®Šçš„è¯­æ³•ï¼Œæ˜ç¡®å‘ŠçŸ¥Spark SQLåœ¨è¿è¡Œæ—¶é‡‡ç”¨å“ªç§Joinç­–ç•¥ã€‚ä¸€æ—¦ä½ å¯ç”¨äº†Join Hintsï¼Œä¸ç®¡ä½ çš„æ•°æ®è¡¨æ˜¯ä¸æ˜¯æ»¡è¶³å¹¿æ’­é˜ˆå€¼ï¼ŒSpark SQLéƒ½ä¼šå°½å¯èƒ½åœ°å°Šé‡ä½ çš„æ„æ„¿å’Œé€‰æ‹©ï¼Œä½¿ç”¨Broadcast Joinså»å®Œæˆæ•°æ®å…³è”ã€‚</p><p>æˆ‘ä»¬æ¥ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾æœ‰ä¸¤å¼ è¡¨ï¼Œä¸€å¼ è¡¨çš„å†…å­˜å¤§å°åœ¨100GBé‡çº§ï¼Œå¦ä¸€å¼ å°ä¸€äº›ï¼Œ2GBå·¦å³ã€‚åœ¨å¹¿æ’­é˜ˆå€¼è¢«è®¾ç½®ä¸º2GBçš„æƒ…å†µä¸‹ï¼Œå¹¶æ²¡æœ‰è§¦å‘Broadcast Joinsï¼Œä½†æˆ‘ä»¬åˆä¸æƒ³èŠ±è´¹æ—¶é—´å’Œç²¾åŠ›å»ç²¾ç¡®è®¡ç®—å°è¡¨çš„å†…å­˜å ç”¨åˆ°åº•æ˜¯å¤šå¤§ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”¨Join Hintsæ¥å¸®æˆ‘ä»¬åšä¼˜åŒ–ï¼Œä»…ä»…å‡ å¥æç¤ºå°±å¯ä»¥å¸®æˆ‘ä»¬è¾¾åˆ°ç›®çš„ã€‚</p><pre><code>val table1: DataFrame = spark.read.parquet(path1)\nval table2: DataFrame = spark.read.parquet(path2)\ntable1.createOrReplaceTempView(&quot;t1&quot;)\ntable2.createOrReplaceTempView(&quot;t2&quot;)\n \nval query: String = â€œselect /*+ broadcast(t2) */ * from t1 inner join t2 on t1.key = t2.keyâ€\nval queryResutls: DataFrame = spark.sql(query)\n</code></pre><p>ä½ çœ‹ï¼Œåœ¨ä¸Šé¢çš„ä»£ç ç¤ºä¾‹ä¸­ï¼Œåªè¦åœ¨SQLç»“æ„åŒ–æŸ¥è¯¢è¯­å¥é‡Œé¢åŠ ä¸Šä¸€å¥<code>/*+ broadcast(t2) */</code>æç¤ºï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼ºåˆ¶Spark SQLå¯¹å°è¡¨t2è¿›è¡Œå¹¿æ’­ï¼Œåœ¨è¿è¡Œæ—¶é€‰æ‹©Broadcast Joinsçš„å®ç°æ–¹å¼ã€‚æç¤ºè¯­å¥ä¸­çš„å…³é”®å­—ï¼Œé™¤äº†ä½¿ç”¨broadcastå¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ç”¨broadcastjoinæˆ–è€…mapjoinï¼Œå®ƒä»¬å®ç°çš„æ•ˆæœéƒ½ä¸€æ ·ã€‚</p><p>å¦‚æœä½ ä¸å–œæ¬¢ç”¨SQLç»“æ„åŒ–æŸ¥è¯¢è¯­å¥ï¼Œå°¤å…¶ä¸æƒ³é¢‘ç¹åœ°åœ¨Spark SQLä¸Šä¸‹æ–‡ä¸­æ³¨å†Œæ•°æ®è¡¨ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨DataFrameçš„DSLè¯­æ³•ä¸­ä½¿ç”¨Join Hintsã€‚</p><pre><code>table1.join(table2.hint(â€œbroadcastâ€), Seq(â€œkeyâ€), â€œinnerâ€)\n\n</code></pre><p>åœ¨ä¸Šé¢çš„DSLè¯­å¥ä¸­ï¼Œæˆ‘ä»¬åªè¦åœ¨table2ä¸Šè°ƒç”¨hintæ–¹æ³•ï¼Œç„¶åæŒ‡å®šbroadcastå…³é”®å­—ï¼Œå°±å¯ä»¥åŒæ ·è¾¾åˆ°å¼ºåˆ¶å¹¿æ’­è¡¨2çš„æ•ˆæœã€‚</p><p>æ€»ä¹‹ï¼ŒJoin Hintsè®©å¼€å‘è€…å¯ä»¥çµæ´»åœ°é€‰æ‹©è¿è¡Œæ—¶çš„Joinç­–ç•¥ï¼Œå¯¹äºç†Ÿæ‚‰ä¸šåŠ¡ã€äº†è§£æ•°æ®çš„åŒå­¦æ¥è¯´ï¼ŒJoin Hintså…è®¸å¼€å‘è€…æŠŠä¸“å®¶ç»éªŒå‡Œé©¾äºSpark SQLçš„ä¼˜åŒ–å¼•æ“ä¹‹ä¸Šï¼Œæ›´å¥½åœ°æœåŠ¡ä¸šåŠ¡ã€‚</p><p>ä¸è¿‡ï¼ŒJoin Hintsä¹Ÿæœ‰ä¸ªå°ç¼ºé™·ã€‚å¦‚æœå…³é”®å­—æ‹¼å†™é”™è¯¯ï¼ŒSpark SQLåœ¨è¿è¡Œæ—¶å¹¶ä¸ä¼šæ˜¾ç¤ºåœ°æŠ›å‡ºå¼‚å¸¸ï¼Œè€Œæ˜¯é»˜é»˜åœ°å¿½ç•¥æ‰æ‹¼å†™é”™è¯¯çš„hintsï¼Œå‡è£…å®ƒå‹æ ¹ä¸å­˜åœ¨ã€‚å› æ­¤ï¼Œåœ¨ä½¿ç”¨Join Hintsçš„æ—¶å€™ï¼Œéœ€è¦æˆ‘ä»¬åœ¨ç¼–è¯‘æ—¶è‡ªè¡Œç¡®è®¤Debugå’Œçº é”™ã€‚</p><h3>ç”¨broadcastå‡½æ•°å¼ºåˆ¶å¹¿æ’­</h3><p>å¦‚æœä½ ä¸æƒ³ç­‰åˆ°è¿è¡Œæ—¶æ‰å‘ç°é—®é¢˜ï¼Œæƒ³è®©ç¼–è¯‘å™¨å¸®ä½ æ£€æŸ¥ç±»ä¼¼çš„æ‹¼å†™é”™è¯¯ï¼Œé‚£ä¹ˆä½ å¯ä»¥ä½¿ç”¨å¼ºåˆ¶å¹¿æ’­çš„ç¬¬äºŒç§æ–¹å¼ï¼šbroadcastå‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°æ˜¯ç±»åº“org.apache.spark.sql.functionsä¸­çš„broadcastå‡½æ•°ã€‚è°ƒç”¨æ–¹å¼éå¸¸ç®€å•ï¼Œæ¯”Join Hintsè¿˜è¦æ–¹ä¾¿ï¼Œåªéœ€è¦ç”¨broadcastå‡½æ•°å°è£…éœ€è¦å¹¿æ’­çš„æ•°æ®è¡¨å³å¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>import org.apache.spark.sql.functions.broadcast\ntable1.join(broadcast(table2), Seq(â€œkeyâ€), â€œinnerâ€)\n</code></pre><p>ä½ å¯èƒ½ä¼šé—®ï¼šâ€œæ—¢ç„¶å¼€å‘è€…å¯ä»¥é€šè¿‡Join Hintså’Œbroadcastå‡½æ•°å¼ºåˆ¶Spark SQLé€‰æ‹©Broadcast Joinsï¼Œé‚£æˆ‘æ˜¯ä¸æ˜¯å°±å¯ä»¥ä¸ç”¨ç†ä¼šå¹¿æ’­é˜ˆå€¼çš„é…ç½®é¡¹äº†ï¼Ÿâ€å…¶å®è¿˜çœŸä¸æ˜¯ã€‚æˆ‘è®¤ä¸ºï¼Œ<strong>ä»¥å¹¿æ’­é˜ˆå€¼é…ç½®ä¸ºä¸»ï¼Œä»¥å¼ºåˆ¶å¹¿æ’­ä¸ºè¾…</strong>ï¼Œå¾€å¾€æ˜¯ä¸é”™çš„é€‰æ‹©ã€‚</p><p><strong>å¹¿æ’­é˜ˆå€¼çš„è®¾ç½®ï¼Œæ›´å¤šçš„æ˜¯æŠŠé€‰æ‹©æƒäº¤ç»™Spark SQLï¼Œå°¤å…¶æ˜¯åœ¨AQEçš„æœºåˆ¶ä¸‹ï¼ŒåŠ¨æ€Joinç­–ç•¥è°ƒæ•´éœ€è¦è¿™æ ·çš„è®¾ç½®åœ¨è¿è¡Œæ—¶åšå‡ºé€‰æ‹©ã€‚å¼ºåˆ¶å¹¿æ’­æ›´å¤šçš„æ˜¯å¼€å‘è€…ä»¥ä¸“å®¶ç»éªŒå»æŒ‡å¯¼Spark SQLè¯¥å¦‚ä½•é€‰æ‹©è¿è¡Œæ—¶ç­–ç•¥ã€‚</strong>äºŒè€…ç›¸è¾…ç›¸æˆï¼Œå¹¶ä¸å†²çªï¼Œå¼€å‘è€…çµæ´»åœ°è¿ç”¨å°±èƒ½å¹³è¡¡Spark SQLä¼˜åŒ–ç­–ç•¥ä¸ä¸“å®¶ç»éªŒåœ¨åº”ç”¨ä¸­çš„æ¯”ä¾‹ã€‚</p><h2>å¹¿æ’­å˜é‡ä¸æ˜¯é“¶å¼¹</h2><p>ä¸è¿‡ï¼Œè™½ç„¶æˆ‘ä»¬ä¸€ç›´åœ¨å¼ºè°ƒï¼Œæ•°æ®å…³è”åœºæ™¯ä¸­å¹¿æ’­å˜é‡æ˜¯å…‹åˆ¶Shuffleçš„æ€æ‰‹é”ï¼Œä½†å¹¿æ’­å˜é‡å¹¶ä¸æ˜¯é“¶å¼¹ã€‚</p><p>å°±åƒæœ‰çš„åŒå­¦ä¼šè¯´ï¼šâ€œå¼€å‘è€…æœ‰è¿™ä¹ˆå¤šé€‰é¡¹ï¼Œç”šè‡³å¯ä»¥å¼ºåˆ¶Sparké€‰æ‹©Broadcast Joinsï¼Œé‚£æˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥æŠŠæ‰€æœ‰Joinæ“ä½œéƒ½ç”¨Broadcast Joinsæ¥å®ç°ï¼Ÿâ€ç­”æ¡ˆå½“ç„¶æ˜¯å¦å®šçš„ï¼Œå¹¿æ’­å˜é‡ä¸èƒ½è§£å†³æ‰€æœ‰çš„æ•°æ®å…³è”é—®é¢˜ã€‚</p><p><strong>é¦–å…ˆï¼Œä»æ€§èƒ½ä¸Šæ¥è®²ï¼ŒDriveråœ¨åˆ›å»ºå¹¿æ’­å˜é‡çš„è¿‡ç¨‹ä¸­ï¼Œéœ€è¦æ‹‰å–åˆ†å¸ƒå¼æ•°æ®é›†æ‰€æœ‰çš„æ•°æ®åˆ†ç‰‡ã€‚</strong>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œç½‘ç»œå¼€é”€å’ŒDriverå†…å­˜ä¼šæˆä¸ºæ€§èƒ½éšæ‚£ã€‚å¹¿æ’­å˜é‡å°ºå¯¸è¶Šå¤§ï¼Œé¢å¤–å¼•å…¥çš„æ€§èƒ½å¼€é”€å°±ä¼šè¶Šå¤šã€‚æ›´ä½•å†µï¼Œå¦‚æœå¹¿æ’­å˜é‡å¤§å°è¶…è¿‡8GBï¼ŒSparkä¼šç›´æ¥æŠ›å¼‚å¸¸ä¸­æ–­ä»»åŠ¡æ‰§è¡Œã€‚</p><p><strong>å…¶æ¬¡ï¼Œä»åŠŸèƒ½ä¸Šæ¥è®²ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„Joinsç±»å‹éƒ½å¯ä»¥è½¬æ¢ä¸ºBroadcast Joinsã€‚</strong>ä¸€æ¥ï¼ŒBroadcast Joinsä¸æ”¯æŒå…¨è¿æ¥ï¼ˆFull Outer Joinsï¼‰ï¼›äºŒæ¥ï¼Œåœ¨æ‰€æœ‰çš„æ•°æ®å…³è”ä¸­ï¼Œæˆ‘ä»¬ä¸èƒ½å¹¿æ’­åŸºè¡¨ã€‚æˆ–è€…è¯´ï¼Œå³ä¾¿å¼€å‘è€…å¼ºåˆ¶å¹¿æ’­åŸºè¡¨ï¼Œä¹Ÿæ— æµäºäº‹ã€‚æ¯”å¦‚è¯´ï¼Œåœ¨å·¦è¿æ¥ï¼ˆLeft Outer Joinï¼‰ä¸­ï¼Œæˆ‘ä»¬åªèƒ½å¹¿æ’­å³è¡¨ï¼›åœ¨å³è¿æ¥ï¼ˆRight Outer Joinï¼‰ä¸­ï¼Œæˆ‘ä»¬åªèƒ½å¹¿æ’­å·¦è¡¨ã€‚åœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œå³ä¾¿æˆ‘ä»¬å¼ºåˆ¶ç”¨broadcastå‡½æ•°è¿›è¡Œå¹¿æ’­ï¼ŒSpark SQLåœ¨è¿è¡Œæ—¶è¿˜æ˜¯ä¼šé€‰æ‹©Shuffle Joinsã€‚</p><pre><code>import org.apache.spark.sql.functions.broadcast\nbroadcast (table1).join(table2, Seq(â€œkeyâ€), â€œleftâ€)\ntable1.join(broadcast(table2), Seq(â€œkeyâ€), â€œrightâ€)\n</code></pre><h2>å°ç»“</h2><p>è¿™ä¸€è®²ï¼Œæˆ‘ä»¬æ€»ç»“äº†2ç§æ–¹æ³•ï¼Œè®©Spark SQLåœ¨è¿è¡Œæ—¶èƒ½å¤Ÿé€‰æ‹©Broadcast Joinsç­–ç•¥ï¼Œåˆ†åˆ«æ˜¯è®¾ç½®é…ç½®é¡¹å’Œç”¨APIå¼ºåˆ¶å¹¿æ’­ã€‚</p><p><strong>é¦–å…ˆï¼Œè®¾ç½®é…ç½®é¡¹ä¸»è¦æ˜¯è®¾ç½®autoBroadcastJoinThresholdé…ç½®é¡¹ã€‚</strong>å¼€å‘è€…é€šè¿‡è¿™ä¸ªé…ç½®é¡¹æŒ‡ç¤ºSpark SQLä¼˜åŒ–å™¨ã€‚åªè¦å‚ä¸Joinçš„ä¸¤å¼ è¡¨ä¸­ï¼Œæœ‰ä¸€å¼ è¡¨çš„å°ºå¯¸å°äºè¿™ä¸ªå‚æ•°å€¼ï¼Œå°±åœ¨è¿è¡Œæ—¶é‡‡ç”¨Broadcast Joinsçš„å®ç°æ–¹å¼ã€‚</p><p>ä¸ºäº†è®©Spark SQLé‡‡ç”¨Broadcast Joinsï¼Œå¼€å‘è€…è¦åšçš„ï¼Œå°±æ˜¯è®©æ•°æ®è¡¨åœ¨å†…å­˜ä¸­çš„å°ºå¯¸å°äºautoBroadcastJoinThresholdå‚æ•°çš„è®¾å®šå€¼ã€‚</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œåœ¨è®¾ç½®å¹¿æ’­é˜ˆå€¼çš„æ—¶å€™ï¼Œå› ä¸ºç£ç›˜æ•°æ®å±•å¼€åˆ°å†…å­˜çš„æ—¶å€™ï¼Œå­˜å‚¨å¤§å°ä¼šæˆå€å¢åŠ ï¼Œå¾€å¾€å¯¼è‡´Spark SQLæ— æ³•é‡‡ç”¨Broadcast Joinsçš„ç­–ç•¥ã€‚å› æ­¤ï¼Œæˆ‘ä»¬åœ¨åšæ•°æ®å…³è”çš„æ—¶å€™ï¼Œè¿˜è¦å…ˆé¢„ä¼°ä¸€å¼ è¡¨åœ¨å†…å­˜ä¸­çš„å­˜å‚¨å¤§å°ã€‚ä¸€ç§ç²¾ç¡®çš„é¢„ä¼°æ–¹æ³•æ˜¯å…ˆæŠŠDataFrameç¼“å­˜ï¼Œç„¶åè¯»å–æ‰§è¡Œè®¡åˆ’çš„ç»Ÿè®¡æ•°æ®ã€‚</p><p><strong>å…¶æ¬¡ï¼Œç”¨APIå¼ºåˆ¶å¹¿æ’­æœ‰ä¸¤ç§æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯è®¾ç½®Join Hintså’Œç”¨broadcastå‡½æ•°ã€‚</strong>è®¾ç½®Join Hintsçš„æ–¹æ³•å°±æ˜¯åœ¨SQLç»“æ„åŒ–æŸ¥è¯¢è¯­å¥é‡Œé¢åŠ ä¸Šä¸€å¥â€œ/*+ broadcast(æŸè¡¨) */â€çš„æç¤ºå°±å¯ä»¥äº†ï¼Œè¿™é‡Œçš„broadcastå…³é”®å­—ä¹Ÿå¯ä»¥æ¢æˆbroadcastjoinæˆ–è€…mapjoinã€‚å¦å¤–ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨DataFrameçš„DSLè¯­æ³•ä¸­ä½¿ç”¨è°ƒç”¨hintæ–¹æ³•ï¼ŒæŒ‡å®šbroadcastå…³é”®å­—ï¼Œæ¥è¾¾åˆ°åŒæ ·çš„æ•ˆæœã€‚è®¾ç½®broadcastå‡½æ•°çš„æ–¹æ³•éå¸¸ç®€å•ï¼Œåªè¦ç”¨broadcastå‡½æ•°å°è£…éœ€è¦å¹¿æ’­çš„æ•°æ®è¡¨å°±å¯ä»¥äº†ã€‚</p><p>æ€»çš„æ¥è¯´ï¼Œä¸ç®¡æ˜¯è®¾ç½®é…ç½®é¡¹è¿˜æ˜¯ç”¨APIå¼ºåˆ¶å¹¿æ’­éƒ½æœ‰å„è‡ªçš„ä¼˜ç¼ºç‚¹ï¼Œæ‰€ä»¥ï¼Œ<strong>ä»¥å¹¿æ’­é˜ˆå€¼é…ç½®ä¸ºä¸»ã€å¼ºåˆ¶å¹¿æ’­ä¸ºè¾…</strong>ï¼Œå¾€å¾€æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚</p><p>æœ€åï¼Œä¸è¿‡ï¼Œæˆ‘ä»¬ä¹Ÿè¦æ³¨æ„ï¼Œå¹¿æ’­å˜é‡ä¸æ˜¯é“¶å¼¹ï¼Œå®ƒå¹¶ä¸èƒ½è§£å†³æ‰€æœ‰çš„æ•°æ®å…³è”é—®é¢˜ï¼Œæ‰€ä»¥åœ¨æ—¥å¸¸çš„å¼€å‘å·¥ä½œä¸­ï¼Œä½ è¦æ³¨æ„é¿å…æ»¥ç”¨å¹¿æ’­ã€‚</p><h2>æ¯æ—¥ä¸€ç»ƒ</h2><ol>\n<li>é™¤äº†broadcastå…³é”®å­—å¤–ï¼Œåœ¨Spark 3.0ç‰ˆæœ¬ä¸­ï¼ŒJoin Hintsè¿˜æ”¯æŒå“ªäº›å…³è”ç±»å‹å’Œå…³é”®å­—ï¼Ÿ</li>\n<li>DataFrameå¯ä»¥ç”¨sparkContext.broadcastå‡½æ•°æ¥å¹¿æ’­å—ï¼Ÿå®ƒå’Œorg.apache.spark.sql.functions.broadcastå‡½æ•°ä¹‹é—´çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ</li>\n</ol><p>æœŸå¾…åœ¨ç•™è¨€åŒºçœ‹åˆ°ä½ çš„æ€è€ƒå’Œç­”æ¡ˆï¼Œæˆ‘ä»¬ä¸‹ä¸€è®²è§ï¼</p>","comments":[{"had_liked":false,"id":287848,"user_name":"kingcall","can_delete":false,"product_type":"c1","uid":1056982,"ip_address":"","ucode":"508884DC684B5B","user_header":"https://static001.geekbang.org/account/avatar/00/10/20/d6/b9513db0.jpg","comment_is_top":false,"comment_ctime":1618194651,"is_pvip":false,"replies":[{"id":"104550","content":"Perfect x 2ï¼ä¸¤é“é¢˜éƒ½æ˜¯æ»¡åˆ†ğŸ’¯~<br><br>ä¸è¿‡ï¼Œç¬¬ä¸€é¢˜ï¼Œæˆ‘å†è¿½é—®ä¸€å¥ï¼Œå½“ç„¶ï¼Œè¿™ä¹ˆè¿½é—®æœ‰ç‚¹è¿‡åˆ†ï¼Œå“ˆå“ˆï¼Œæ¯•ç«Ÿå’±ä»¬è¿™èŠ‚è¯¾è¿˜æ²¡æœ‰è®²ä¸åŒJoinçš„å®ç°æ–¹å¼ï¼ˆ26è®²ä¼šå±•å¼€ï¼‰ã€‚è¿½é—®çš„é—®é¢˜æ˜¯ï¼š<br>SHUFFLE_MERGE,<br>SHUFFLE_HASH,<br>SHUFFLE_REPLICATE_NL<br>è¿™å‡ ä¸ªhintsçš„ä½œç”¨å’Œæ•ˆæœï¼Œåˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿä»–ä»¬åˆ†åˆ«é€‚åˆå“ªäº›åœºæ™¯ï¼Ÿä¸å¦¨æå‰æ€è€ƒä¸€ä¸‹ï¼Œç­‰åˆ°äº†26è®²ï¼Œå’±ä»¬å†ç»†èŠå“ˆ~","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1618221062,"ip_address":"","comment_id":287848,"utype":1}],"discussion_count":3,"race_medal":0,"score":"104697409755","product_id":100073401,"comment_content":"ç¬¬ä¸€é¢˜ï¼šå¯ä»¥å‚è€ƒJoinStrategyHint.scala <br>    BROADCAST,<br>    SHUFFLE_MERGE,<br>    SHUFFLE_HASH,<br>    SHUFFLE_REPLICATE_NL<br>ç¬¬äºŒé¢˜:æœ¬è´¨ä¸Šæ˜¯ä¸€æ ·çš„ï¼Œsql çš„broadcastè¿”å›å€¼æ˜¯ä¸€ä¸ªDataset[T]ï¼Œè€ŒsparkContext.broadcastçš„è¿”å›å€¼æ˜¯ä¸€ä¸ªBroadcast[T] ç±»å‹å€¼ï¼Œéœ€è¦è°ƒç”¨valueæ–¹æ³•ï¼Œæ‰èƒ½è¿”å›è¢«å¹¿æ’­å‡ºå»çš„å˜é‡,æ‰€ä»¥äºŒè€…åœ¨ä½¿ç”¨çš„ä½¿ç”¨çš„ä½“ç°å½¢å¼ä¸Šï¼ŒsparkContext.broadcast éœ€è¦ä½ è°ƒç”¨ä¸€æ¬¡value æ–¹æ³•æ‰èƒ½å’Œå…¶ä»–DF è¿›è¡Œjoin,ä¸‹é¢æä¾›ä¸€ä¸ªdemo è¿›è¡Œè¯´æ˜<br><br>    import org.apache.spark.sql.functions.broadcast<br><br>    val transactionsDF: DataFrame = sparksession.range(100).toDF(&quot;userID&quot;)<br>    val userDF: DataFrame = sparksession.range(10, 20).toDF(&quot;userID&quot;)<br><br>    val bcUserDF = broadcast(userDF)<br>    val bcUserDF2 = sparkContext.broadcast(userDF)<br>    val dataFrame = transactionsDF.join(bcUserDF, Seq(&quot;userID&quot;), &quot;inner&quot;)<br>    dataFrame.show()<br>    val dataFrame2 = transactionsDF.join(bcUserDF2.value, Seq(&quot;userID&quot;), &quot;inner&quot;)<br>    dataFrame2.show()<br>","like_count":25,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":518441,"discussion_content":"Perfect x 2ï¼ä¸¤é“é¢˜éƒ½æ˜¯æ»¡åˆ†ğŸ’¯~\n\nä¸è¿‡ï¼Œç¬¬ä¸€é¢˜ï¼Œæˆ‘å†è¿½é—®ä¸€å¥ï¼Œå½“ç„¶ï¼Œè¿™ä¹ˆè¿½é—®æœ‰ç‚¹è¿‡åˆ†ï¼Œå“ˆå“ˆï¼Œæ¯•ç«Ÿå’±ä»¬è¿™èŠ‚è¯¾è¿˜æ²¡æœ‰è®²ä¸åŒJoinçš„å®ç°æ–¹å¼ï¼ˆ26è®²ä¼šå±•å¼€ï¼‰ã€‚è¿½é—®çš„é—®é¢˜æ˜¯ï¼š\nSHUFFLE_MERGE,\nSHUFFLE_HASH,\nSHUFFLE_REPLICATE_NL\nè¿™å‡ ä¸ªhintsçš„ä½œç”¨å’Œæ•ˆæœï¼Œåˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿä»–ä»¬åˆ†åˆ«é€‚åˆå“ªäº›åœºæ™¯ï¼Ÿä¸å¦¨æå‰æ€è€ƒä¸€ä¸‹ï¼Œç­‰åˆ°äº†26è®²ï¼Œå’±ä»¬å†ç»†èŠå“ˆ~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618221062,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1564645,"avatar":"https://static001.geekbang.org/account/avatar/00/17/df/e5/65e37812.jpg","nickname":"å¿«è·‘","note":"","ucode":"90ED7E6D40C58E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":368010,"discussion_content":"è¿½é—®çš„ï¼Œæ­£æ˜¯æƒ³è¦é—®çš„ã€‚å°¤å…¶SHUFFLE_REPLICATE_NL","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618538929,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":1564645,"avatar":"https://static001.geekbang.org/account/avatar/00/17/df/e5/65e37812.jpg","nickname":"å¿«è·‘","note":"","ucode":"90ED7E6D40C58E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375668,"discussion_content":"è¿™å—å¯ä»¥å‚è€ƒç¬¬26è®²ï¼Œé‚£é‡Œä¼šå›ç­”ä¸Šé¢çš„é—®é¢˜~\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621809394,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":368010,"ip_address":""},"score":375668,"extra":""}]}]},{"had_liked":false,"id":288584,"user_name":"YJ","can_delete":false,"product_type":"c1","uid":1368790,"ip_address":"","ucode":"D75733726E39C6","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaELOB7pvNfq404zOrBt7OfibficJmfaTHbd14w0Om7VRUakQWnEzmbbpJHGTmRYp0ibA31oJAZUVruatA/132","comment_is_top":false,"comment_ctime":1618551487,"is_pvip":false,"replies":[{"id":"104757","content":"å¥½é—®é¢˜ï¼Œ è¿™ç§å†™æ³•ï¼ŒSparkä¸ä¼šå¤ç”¨å…ˆå‰çš„å¹¿æ’­å˜é‡ï¼Œæ‰€ä»¥ç¬¬äºŒæ¬¡çš„Broadcastä¼šé‡å¤è®¡ç®—ã€‚<br><br>å¤ç”¨å¹¿æ’­æœ€ä¿é™©çš„æ–¹å¼ï¼Œæ˜¯è¿™ç§å†™æ³•ï¼š<br>val bcSmallTable = sparkContext.broadcast(smallTable)<br>  <br>bigTableA.Join(bcSmallTable.value, ...);<br>bigTableB.Join(bcSmallTable.value, ...);  ","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1618585585,"ip_address":"","comment_id":288584,"utype":1}],"discussion_count":3,"race_medal":0,"score":"53158159039","product_id":100073401,"comment_content":"è€å¸ˆï¼Œæˆ‘æœ‰ä¸€ä¸ªé—®é¢˜ã€‚ <br>bigTableA.Join(broadcast(smallTable), ...);<br>bigTableB.Join(broadsast(smallTable), ...);<br>bigTableA.Join(bigTableB, ...);<br>è¿™é‡Œ å¹¿æ’­äº†çš„smallTable ä¼šè¢«ç¬¬äºŒä¸ªjoiné‡ç”¨å—ï¼Ÿ è¿˜æ˜¯è¯´ä¼šè¢«å¹¿æ’­ä¸¤æ¬¡ï¼Ÿ","like_count":13,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":518673,"discussion_content":"å¥½é—®é¢˜ï¼Œ è¿™ç§å†™æ³•ï¼ŒSparkä¸ä¼šå¤ç”¨å…ˆå‰çš„å¹¿æ’­å˜é‡ï¼Œæ‰€ä»¥ç¬¬äºŒæ¬¡çš„Broadcastä¼šé‡å¤è®¡ç®—ã€‚\n\nå¤ç”¨å¹¿æ’­æœ€ä¿é™©çš„æ–¹å¼ï¼Œæ˜¯è¿™ç§å†™æ³•ï¼š\nval bcSmallTable = sparkContext.broadcast(smallTable)\n  \nbigTableA.Join(bcSmallTable.value, ...);\nbigTableB.Join(bcSmallTable.value, ...);  ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618585585,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":369117,"discussion_content":"å¯¹ï¼Œä½ è¯´çš„è¿™äº›æ–¹æ³•ï¼Œéƒ½ä¸ä¼šå¤ç”¨å¹¿æ’­ï¼Œval bcSmallTable = sparkContext.broadcast(smallTable)ï¼Œè¿™ç§æ–¹æ³•æ˜¯æœ€ç¨³å¦¥çš„ã€‚è°ƒç”¨valueæ²¡æœ‰é—®é¢˜~","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1618930854,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1368790,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaELOB7pvNfq404zOrBt7OfibficJmfaTHbd14w0Om7VRUakQWnEzmbbpJHGTmRYp0ibA31oJAZUVruatA/132","nickname":"YJ","note":"","ucode":"D75733726E39C6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":368309,"discussion_content":"è¿½é—®ä¸€ä¸‹ï¼Œæ‰€ä»¥è¯´ä½¿ç”¨spark sqlçš„Broadcast()æˆ–hintæˆ–autoBroadcastéƒ½ä¸ä¼šé‡ç”¨ï¼Œä¸€å®šè¦ç”¨spark coreæ–¹æ³•åˆ‡å®çš„å¹¿æ’­ã€‚   å¦å¤–val bcSmallTable = spaekContext.broadcast(smallTable).value;  å†ç›´æ¥ä½¿ç”¨è¿™ä¸ªvalueå»joinä¼šæœ‰é—®é¢˜å—ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618651163,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":293327,"user_name":"Geek_d794f8","can_delete":false,"product_type":"c1","uid":2485585,"ip_address":"","ucode":"1E20DA4FF8B800","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIiaeebUYxl7e4jicPshDRKMbiculHUjKgZZ2ygDibn2S7bbsjeqYIdsEUdVyoryKNa43ZGnDQmWjv3ibQ/132","comment_is_top":false,"comment_ctime":1621336548,"is_pvip":false,"replies":[{"id":"106615","content":"å¥½é—®é¢˜~<br><br>è¿™é‡Œæˆ‘å…ˆè¯´å£°æŠ±æ­‰ï¼Œçœ‹åˆ°ä½ è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘æ„è¯†åˆ°æˆ‘åŸæ–‡æ²¡æœ‰è¯´æ¸…æ¥šã€‚æ˜¯è¿™æ ·çš„ï¼Œæˆ‘ä»¬åˆ†ä¸¤ç§æƒ…å†µæ¥è¯´ã€‚ä¸ºäº†å™è¿°æ–¹ä¾¿ï¼Œæˆ‘æŠŠä½ çš„æ•°æ®é›†è®°ä¸ºDï¼Œä¹Ÿå°±æ˜¯ç£ç›˜ä¸­133.4MBï¼Œå±•å¼€åˆ°å†…å­˜æ˜¯1000MBã€‚<br><br>ç¬¬ä¸€ç§æƒ…å†µï¼Œæ•°æ®é›†Dä¸Šä¸å­˜åœ¨Cacheï¼Œè¿™ä¸ªæ—¶å€™é‚£Dç›´æ¥å‚ä¸åç»­çš„è®¡ç®—ï¼Œæ¯”å¦‚Joinï¼Œç”±äºSpark SQLæ— ä»åˆ¤æ–­Dåœ¨å†…å­˜ä¸­çš„å¤§å°ï¼Œå› æ­¤å®ƒä¼šâ€œå·æ‡’â€åœ°ç›´æ¥æ‹¿ç£ç›˜å¤§å°ä½œä¸ºåˆ¤æ–­ä¾æ®ï¼Œä¹Ÿå°±æ˜¯ä½ ä¸Šé¢è¯´çš„é‚£ç§æƒ…å†µï¼Œå¹¿æ’­é˜ˆå€¼å¤§äº133.4MBï¼Œå°±å¯ä»¥å¹¿æ’­ï¼Œåä¹‹åˆ™ä¸è¡Œã€‚ä¸å¾—ä¸è¯´ï¼Œè¿™ä¸ªâ€œæ‡’â€å·çš„æœ‰ç‚¹è¿‡åˆ†ï¼Œä¸è¿‡ç°é˜¶æ®µSpark SQLå°±æ˜¯è¿™ä¹ˆåšçš„ï¼Œè¿™ä¸ªå’ŒSparkçš„ç‰ˆæœ¬æ²¡æœ‰å…³ç³»ï¼Œ3.0ä¸­Spark SQLä¹Ÿæ˜¯è¿™ä¹ˆå¤„ç†çš„ã€‚<br><br>ç¬¬äºŒç§æƒ…å†µï¼Œæ•°æ®é›†ä¹‹ä¸Šæœ‰Cacheï¼Œè¿™ä¸ªæ—¶å€™ï¼ŒSpark SQLåˆ¤å®šçš„ä¾æ®ï¼Œå°±æ˜¯Cacheä¸­çš„å­˜å‚¨å¤§å°ï¼Œä¹Ÿå°±æ˜¯1000MBï¼Œæ‰€ä»¥ä½ ä¸å¦¨å†åšä¸ªå®éªŒï¼Œä¹Ÿå°±æ˜¯ç”¨Cacheè¿‡åçš„Då†å»åšJoinï¼Œè¿™ä¸ªæ—¶å€™ï¼Œä½ ä¼šå‘ç°ï¼Œå¹¿æ’­é˜ˆå€¼å¿…é¡»è¦å¤§äº1000MBæ‰è¡Œã€‚<br><br>æ€»ç»“ä¸‹æ¥ï¼Œå¯¹äºæ•°æ®é›†å¤§å°çš„åˆ¤å®šï¼ŒCacheä¸å¦å®Œå…¨ä¸åŒï¼Œä¸Cacheåˆ™ç›´æ¥ç”¨ç£ç›˜å­˜å‚¨å¤§å°ï¼ŒCacheè¿‡ååˆ™ä½¿ç”¨Cacheä¸­çš„å­˜å‚¨å¤§å°ã€‚éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œç¬¬ä¸€ç§æƒ…å†µï¼Œä¹Ÿå°±æ˜¯ä¸åŠ Cacheçš„æ—¶å€™ï¼ŒSpark SQLç®€å•ç²—æš´åœ°ç›´æ¥ç”¨ç£ç›˜å­˜å‚¨å¤§å°ï¼Œå¦ç™½è®²æ˜¯å­˜åœ¨éšæ‚£çš„ï¼Œä¹Ÿå°±æ˜¯åˆ›å»ºå¹¿æ’­å˜é‡åˆ›å»ºè¿‡ç¨‹ä¸­Driverç«¯çš„OOMé—®é¢˜ï¼Œæˆ–æ˜¯å¹¿æ’­å˜é‡åˆ›å»ºè¿‡ç¨‹ä¸­çš„Time outé—®é¢˜ã€‚å› æ­¤ï¼Œå³ä¾¿åœ¨é‚£ç§æƒ…å†µä¹‹ä¸‹ï¼ŒSpark SQLä¼šé€‰æ‹©å‚è€ƒç£ç›˜å­˜å‚¨å¤§å°ï¼Œä½†æ˜¯æˆ‘çš„å»ºè®®è¿˜æ˜¯äº‹å…ˆä¼°ç®—å¥½æ•°æ®é›†åœ¨å†…å­˜ä¸­çš„å­˜å‚¨å¤§å°ï¼Œåšåˆ°æœ‰å¤‡æ— æ‚£ã€‚<br>","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1621691389,"ip_address":"","comment_id":293327,"utype":1}],"discussion_count":4,"race_medal":0,"score":"48865976804","product_id":100073401,"comment_content":"è€å¸ˆæˆ‘åšäº†ä¸€ä¸ªæµ‹è¯•ï¼Œæˆ‘çš„è¡¨æ•°æ®æ˜¯parquetå­˜å‚¨ï¼Œsnappyå‹ç¼©çš„ï¼Œç£ç›˜çš„å­˜å‚¨å¤§å°ä¸º133.4Mã€‚æˆ‘å°†å¹¿æ’­å˜é‡çš„é˜ˆå€¼è°ƒåˆ°äº†134Mï¼Œå®ƒå´å¯ä»¥è‡ªåŠ¨å¹¿æ’­ï¼›å½“æˆ‘å°†é˜ˆå€¼è°ƒåˆ°132Mï¼Œåˆ™ä¸ä¼šè‡ªåŠ¨å¹¿æ’­ã€‚<br>æˆ‘ç”¨è€å¸ˆçš„æ–¹æ³•åšäº†ä¸€ä¸ªæ•°æ®åœ¨å†…å­˜å±•å¼€çš„é¢„ä¼°ï¼Œå¤§æ¦‚1000Må·¦å³ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆæˆ‘æŒ‰ç…§ç£ç›˜çš„å¤§å°è®¾å®šå¹¿æ’­é˜ˆå€¼ï¼Œå®ƒèƒ½å¤Ÿå¹¿æ’­å‘¢ï¼Ÿ","like_count":12,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":520161,"discussion_content":"å¥½é—®é¢˜~\n\nè¿™é‡Œæˆ‘å…ˆè¯´å£°æŠ±æ­‰ï¼Œçœ‹åˆ°ä½ è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘æ„è¯†åˆ°æˆ‘åŸæ–‡æ²¡æœ‰è¯´æ¸…æ¥šã€‚æ˜¯è¿™æ ·çš„ï¼Œæˆ‘ä»¬åˆ†ä¸¤ç§æƒ…å†µæ¥è¯´ã€‚ä¸ºäº†å™è¿°æ–¹ä¾¿ï¼Œæˆ‘æŠŠä½ çš„æ•°æ®é›†è®°ä¸ºDï¼Œä¹Ÿå°±æ˜¯ç£ç›˜ä¸­133.4MBï¼Œå±•å¼€åˆ°å†…å­˜æ˜¯1000MBã€‚\n\nç¬¬ä¸€ç§æƒ…å†µï¼Œæ•°æ®é›†Dä¸Šä¸å­˜åœ¨Cacheï¼Œè¿™ä¸ªæ—¶å€™é‚£Dç›´æ¥å‚ä¸åç»­çš„è®¡ç®—ï¼Œæ¯”å¦‚Joinï¼Œç”±äºSpark SQLæ— ä»åˆ¤æ–­Dåœ¨å†…å­˜ä¸­çš„å¤§å°ï¼Œå› æ­¤å®ƒä¼šâ€œå·æ‡’â€åœ°ç›´æ¥æ‹¿ç£ç›˜å¤§å°ä½œä¸ºåˆ¤æ–­ä¾æ®ï¼Œä¹Ÿå°±æ˜¯ä½ ä¸Šé¢è¯´çš„é‚£ç§æƒ…å†µï¼Œå¹¿æ’­é˜ˆå€¼å¤§äº133.4MBï¼Œå°±å¯ä»¥å¹¿æ’­ï¼Œåä¹‹åˆ™ä¸è¡Œã€‚ä¸å¾—ä¸è¯´ï¼Œè¿™ä¸ªâ€œæ‡’â€å·çš„æœ‰ç‚¹è¿‡åˆ†ï¼Œä¸è¿‡ç°é˜¶æ®µSpark SQLå°±æ˜¯è¿™ä¹ˆåšçš„ï¼Œè¿™ä¸ªå’ŒSparkçš„ç‰ˆæœ¬æ²¡æœ‰å…³ç³»ï¼Œ3.0ä¸­Spark SQLä¹Ÿæ˜¯è¿™ä¹ˆå¤„ç†çš„ã€‚\n\nç¬¬äºŒç§æƒ…å†µï¼Œæ•°æ®é›†ä¹‹ä¸Šæœ‰Cacheï¼Œè¿™ä¸ªæ—¶å€™ï¼ŒSpark SQLåˆ¤å®šçš„ä¾æ®ï¼Œå°±æ˜¯Cacheä¸­çš„å­˜å‚¨å¤§å°ï¼Œä¹Ÿå°±æ˜¯1000MBï¼Œæ‰€ä»¥ä½ ä¸å¦¨å†åšä¸ªå®éªŒï¼Œä¹Ÿå°±æ˜¯ç”¨Cacheè¿‡åçš„Då†å»åšJoinï¼Œè¿™ä¸ªæ—¶å€™ï¼Œä½ ä¼šå‘ç°ï¼Œå¹¿æ’­é˜ˆå€¼å¿…é¡»è¦å¤§äº1000MBæ‰è¡Œã€‚\n\næ€»ç»“ä¸‹æ¥ï¼Œå¯¹äºæ•°æ®é›†å¤§å°çš„åˆ¤å®šï¼ŒCacheä¸å¦å®Œå…¨ä¸åŒï¼Œä¸Cacheåˆ™ç›´æ¥ç”¨ç£ç›˜å­˜å‚¨å¤§å°ï¼ŒCacheè¿‡ååˆ™ä½¿ç”¨Cacheä¸­çš„å­˜å‚¨å¤§å°ã€‚éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œç¬¬ä¸€ç§æƒ…å†µï¼Œä¹Ÿå°±æ˜¯ä¸åŠ Cacheçš„æ—¶å€™ï¼ŒSpark SQLç®€å•ç²—æš´åœ°ç›´æ¥ç”¨ç£ç›˜å­˜å‚¨å¤§å°ï¼Œå¦ç™½è®²æ˜¯å­˜åœ¨éšæ‚£çš„ï¼Œä¹Ÿå°±æ˜¯åˆ›å»ºå¹¿æ’­å˜é‡åˆ›å»ºè¿‡ç¨‹ä¸­Driverç«¯çš„OOMé—®é¢˜ï¼Œæˆ–æ˜¯å¹¿æ’­å˜é‡åˆ›å»ºè¿‡ç¨‹ä¸­çš„Time outé—®é¢˜ã€‚å› æ­¤ï¼Œå³ä¾¿åœ¨é‚£ç§æƒ…å†µä¹‹ä¸‹ï¼ŒSpark SQLä¼šé€‰æ‹©å‚è€ƒç£ç›˜å­˜å‚¨å¤§å°ï¼Œä½†æ˜¯æˆ‘çš„å»ºè®®è¿˜æ˜¯äº‹å…ˆä¼°ç®—å¥½æ•°æ®é›†åœ¨å†…å­˜ä¸­çš„å­˜å‚¨å¤§å°ï¼Œåšåˆ°æœ‰å¤‡æ— æ‚£ã€‚\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621691389,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1504510,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/t1aR8h117KxusZQHQ9urp6hr3jMA9icnWR3tLlYZ5M1wbgXIqRTKfLHJ9iciaTgliaPhfV5s5fYrARMZySKHltMlUg/132","nickname":"Gti","note":"","ucode":"21995DFB1AAFB3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":388225,"discussion_content":"å¦‚æœæ˜¯åˆ†å¸ƒå¼çš„æ•°æ®é›†ï¼Œç£ç›˜å¤§å°æ˜¯æ€ä¹ˆä¼°ç®—çš„ï¼Ÿæ‰€æœ‰æ•°æ®åˆ†ç‰‡çš„å¤§å°ä¹‹å’Œï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628661961,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1598796,"avatar":"https://static001.geekbang.org/account/avatar/00/18/65/4c/f7f86496.jpg","nickname":"welldo","note":"","ucode":"D38E75364CD2E3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375457,"discussion_content":"è¯·æ•™ä¸€ä¸‹, æˆ‘ä¹Ÿåšäº†ç±»ä¼¼çš„æµ‹è¯•, ä½†æ˜¯æˆ‘çœ‹æ—¥å¿—æ—¶,æˆ‘ä¸çŸ¥é“å¦‚ä½•ç¡®è®¤sparkæ˜¯å¦åšäº†&#34;è‡ªåŠ¨å¹¿æ’­&#34;, è¯·é—®ä¸€ä¸‹å¦‚ä½•ç¡®è®¤å‘¢?","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621669500,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":1598796,"avatar":"https://static001.geekbang.org/account/avatar/00/18/65/4c/f7f86496.jpg","nickname":"welldo","note":"","ucode":"D38E75364CD2E3","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375670,"discussion_content":"å¯ä»¥ç”¨explainæˆ–æ˜¯Spark UIæŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ï¼Œå…¶ä¸­ä¼šæ˜ç¡®æ˜¯å¦åšäº†Broadcast joinï¼Œæœç´¢Broadcast exchangeã€Broadcast Hash Joinå…³é”®å­—å³å¯","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621809691,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":375457,"ip_address":""},"score":375670,"extra":""}]}]},{"had_liked":false,"id":309730,"user_name":"Geek1185","can_delete":false,"product_type":"c1","uid":2028954,"ip_address":"","ucode":"47BEE492EF4C1A","user_header":"https://static001.geekbang.org/account/avatar/00/1e/f5/9a/63dc81a2.jpg","comment_is_top":false,"comment_ctime":1630315076,"is_pvip":false,"replies":[{"id":"112651","content":"å¥½é—®é¢˜~ è¿™ä¸»è¦æ˜¯å› ä¸ºleft joinçš„è®¡ç®—é€»è¾‘ã€‚ç®€å•çš„å›ç­”æ˜¯ï¼Œå¹¿æ’­å·¦è¡¨ã€æˆ–è€…è¯´åŸºè¡¨ï¼Œæ²¡ç”¨ï¼<br><br>ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Œä½ ä¸å¦¨ä»”ç»†æƒ³æƒ³left joinçš„åŸç†ã€‚å®ƒæ˜¯æŠŠinner joinçš„ç»“æœï¼Œå†åŠ ä¸Šä¸æ»¡è¶³å…³è”æ¡ä»¶çš„ç»“æœã€‚<br><br>å¦‚æœæ˜¯å¹¿æ’­å³è¡¨çš„è¯ï¼Œå·¦è¡¨çš„æ•°æ®åˆ†åŒºï¼Œèƒ½çœ‹åˆ°å³è¡¨çš„å…¨é‡æ•°æ®ï¼Œä¸ç®¡æ˜¯æ»¡è¶³å…³è”æ¡ä»¶å’Œä¸æ»¡è¶³å…³è”æ¡ä»¶ï¼Œå·¦è¡¨çš„æ•°æ®åˆ†åŒºéƒ½èƒ½ç«‹å³å¾—åˆ°ç­”æ¡ˆã€‚<br><br>ä½†æ˜¯ï¼Œåè¿‡æ¥ä¸è¡Œï¼Œæ¯”å¦‚æŠŠå·¦è¡¨å¹¿æ’­äº†ï¼Œå³è¡¨â€œå¾…åœ¨åŸåœ°ã€ä¿æŒä¸åŠ¨â€ï¼Œé‚£å¯¹äºå·¦è¡¨æ¥è¯´ï¼Œå¯¹äºæ¯ä¸€ä¸ªå³è¡¨çš„æ•°æ®åˆ†åŒºæ¥è¯´ï¼Œå·¦è¡¨æ²¡æœ‰å…¨å±€è§†è§’ï¼Œå®ƒåªèƒ½çŸ¥é“å“ªäº›å³è¡¨åˆ†åŒºçš„æ•°æ®æ»¡è¶³å…³è”æ¡ä»¶ï¼Œä½†æ˜¯ï¼Œå®ƒä¸çŸ¥é“åœ¨å…¨å±€æƒ…å†µä¸‹ï¼Œåˆ°åº•æœ‰æ²¡æœ‰ä¸æ»¡è¶³å…³è”æ¡ä»¶ã€éœ€è¦ç”Ÿæˆnullçš„æ•°æ®è®°å½•ã€‚<br><br>å¯èƒ½è¯´çš„æœ‰ç‚¹ç»•ï¼Œä½ ä¸å¦¨ä»”ç»†æƒ³æƒ³left joinçš„è®¡ç®—åŸç†ï¼Œå°±èƒ½æ˜ç™½ï¼Œåœ¨left joinä¸‹ï¼Œå¹¿æ’­å·¦è¡¨æ˜¯æ²¡æœ‰ç”¨çš„ï¼›åŒç†ï¼Œright joinï¼Œå¹¿æ’­å³è¡¨ï¼Œä¹Ÿæ²¡æœ‰ç”¨ã€‚å› ä¸ºä»–ä»¬éƒ½ä¸èƒ½å®ç°left&#47;right joinåŸæœ¬çš„è®¡ç®—é€»è¾‘~","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1630939940,"ip_address":"","comment_id":309730,"utype":1}],"discussion_count":2,"race_medal":0,"score":"27400118852","product_id":100073401,"comment_content":"ä¸ºä»€ä¹ˆleft joinçš„æ—¶å€™ä¸èƒ½å¹¿æ’­å·¦è¾¹çš„å°è¡¨å‘¢ï¼Ÿå‡ ç™¾è¡Œçš„è¡¨å·¦è¿æ¥å‡ äº¿è¡Œçš„è¡¨ï¼ˆä¸šåŠ¡ä¸Šè¦æ±‚å³ä¾¿æ²¡å…³è”ä¸Šä¹Ÿè¦ä¿ç•™å·¦è¡¨çš„è®°å½•ï¼‰ã€‚<br>å°±åƒä¸ºä»€ä¹ˆleft joinæ—¶ï¼Œå·¦è¡¨åœ¨onçš„è°“è¯ä¸èƒ½ä¸‹æ¨ï¼Ÿ<br>æˆ‘ä¸å¤ªæ˜ç™½ï¼Œå¸Œæœ›è€å¸ˆè§£ç­”","like_count":7,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":525986,"discussion_content":"å¥½é—®é¢˜~ è¿™ä¸»è¦æ˜¯å› ä¸ºleft joinçš„è®¡ç®—é€»è¾‘ã€‚ç®€å•çš„å›ç­”æ˜¯ï¼Œå¹¿æ’­å·¦è¡¨ã€æˆ–è€…è¯´åŸºè¡¨ï¼Œæ²¡ç”¨ï¼\n\nä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Œä½ ä¸å¦¨ä»”ç»†æƒ³æƒ³left joinçš„åŸç†ã€‚å®ƒæ˜¯æŠŠinner joinçš„ç»“æœï¼Œå†åŠ ä¸Šä¸æ»¡è¶³å…³è”æ¡ä»¶çš„ç»“æœã€‚\n\nå¦‚æœæ˜¯å¹¿æ’­å³è¡¨çš„è¯ï¼Œå·¦è¡¨çš„æ•°æ®åˆ†åŒºï¼Œèƒ½çœ‹åˆ°å³è¡¨çš„å…¨é‡æ•°æ®ï¼Œä¸ç®¡æ˜¯æ»¡è¶³å…³è”æ¡ä»¶å’Œä¸æ»¡è¶³å…³è”æ¡ä»¶ï¼Œå·¦è¡¨çš„æ•°æ®åˆ†åŒºéƒ½èƒ½ç«‹å³å¾—åˆ°ç­”æ¡ˆã€‚\n\nä½†æ˜¯ï¼Œåè¿‡æ¥ä¸è¡Œï¼Œæ¯”å¦‚æŠŠå·¦è¡¨å¹¿æ’­äº†ï¼Œå³è¡¨â€œå¾…åœ¨åŸåœ°ã€ä¿æŒä¸åŠ¨â€ï¼Œé‚£å¯¹äºå·¦è¡¨æ¥è¯´ï¼Œå¯¹äºæ¯ä¸€ä¸ªå³è¡¨çš„æ•°æ®åˆ†åŒºæ¥è¯´ï¼Œå·¦è¡¨æ²¡æœ‰å…¨å±€è§†è§’ï¼Œå®ƒåªèƒ½çŸ¥é“å“ªäº›å³è¡¨åˆ†åŒºçš„æ•°æ®æ»¡è¶³å…³è”æ¡ä»¶ï¼Œä½†æ˜¯ï¼Œå®ƒä¸çŸ¥é“åœ¨å…¨å±€æƒ…å†µä¸‹ï¼Œåˆ°åº•æœ‰æ²¡æœ‰ä¸æ»¡è¶³å…³è”æ¡ä»¶ã€éœ€è¦ç”Ÿæˆnullçš„æ•°æ®è®°å½•ã€‚\n\nå¯èƒ½è¯´çš„æœ‰ç‚¹ç»•ï¼Œä½ ä¸å¦¨ä»”ç»†æƒ³æƒ³left joinçš„è®¡ç®—åŸç†ï¼Œå°±èƒ½æ˜ç™½ï¼Œåœ¨left joinä¸‹ï¼Œå¹¿æ’­å·¦è¡¨æ˜¯æ²¡æœ‰ç”¨çš„ï¼›åŒç†ï¼Œright joinï¼Œå¹¿æ’­å³è¡¨ï¼Œä¹Ÿæ²¡æœ‰ç”¨ã€‚å› ä¸ºä»–ä»¬éƒ½ä¸èƒ½å®ç°left/right joinåŸæœ¬çš„è®¡ç®—é€»è¾‘~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630939940,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2955154,"avatar":"https://static001.geekbang.org/account/avatar/00/2d/17/92/0af520ef.jpg","nickname":"åæœˆ","note":"","ucode":"95877CD3753595","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":570723,"discussion_content":"â€œç®€å•çš„å›ç­”æ˜¯ï¼Œå¹¿æ’­å·¦è¡¨ã€æˆ–è€…è¯´åŸºè¡¨ï¼Œæ²¡ç”¨ï¼â€ è¿™å¥è¯å’Œæ­£æ–‡ä¸­çš„â€œäºŒæ¥ï¼Œåœ¨æ‰€æœ‰çš„æ•°æ®å…³è”ä¸­ï¼Œæˆ‘ä»¬ä¸èƒ½å¹¿æ’­åŸºè¡¨ã€‚â€è¿™å¥è¯ä¸­çš„åŸºè¡¨æ˜¯ä¸æ˜¯è¯¯å°†é©±åŠ¨è¡¨å†™æˆåŸºè¡¨äº†å‘¢ï¼ŸåŸºè¡¨é€šå¸¸ä¸åº”è¯¥æ˜¯è¾ƒå°çš„è¡¨ä¹ˆï¼Œå¹¶ä¸”è€å¸ˆåœ¨åŸºç¡€ç¯‡çš„ç¬¬17è®²ä¸­ç»™å‡ºè¿‡å®šä¹‰ï¼šâ€œåœ¨æ¢è®¨å…³è”æœºåˆ¶çš„æ—¶å€™ï¼Œæˆ‘ä»¬åˆå¸¸å¸¸æŠŠå·¦è¡¨ç§°ä½œæ˜¯â€œé©±åŠ¨è¡¨â€ï¼Œè€ŒæŠŠå³è¡¨ç§°ä¸ºâ€œåŸºè¡¨â€â€ï¼Œå¾€è€å¸ˆè§£ç­”","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1651892610,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":307596,"user_name":"å‘¨ä¿Š","can_delete":false,"product_type":"c1","uid":2723993,"ip_address":"","ucode":"018FF939002C0B","user_header":"https://static001.geekbang.org/account/avatar/00/29/90/99/24cccca5.jpg","comment_is_top":false,"comment_ctime":1629169113,"is_pvip":true,"replies":[{"id":"111548","content":"æ˜¯è¿™æ ·çš„ï¼Œæ¯ä¸ªå¹¿æ’­çš„ä¸Šé™æ˜¯8Gï¼Œè¶…è¿‡è¿™ä¸ªé™åˆ¶ï¼ŒSparkç›´æ¥æŠ›å¼‚å¸¸ã€‚æ‰€ä»¥ï¼Œè¿™ä¸ª8Gæ˜¯ä»¥å¹¿æ’­å˜é‡ä¸ºç²’åº¦çš„ã€‚15ä¸ªå°è¡¨çš„è¯ï¼Œåªè¦ä»–ä»¬å„è‡ªä¸è¶…è¿‡8Gå°±æ²¡äº‹ã€‚ä¸è¿‡ï¼Œè¯è¯´ï¼ŒåŒæ—¶æ15ä¸ªå¹¿æ’­å˜é‡ï¼ŒDriverä¸ä¸€å®šå—å¾—äº†~ å½“ç„¶ï¼Œè¦çœ‹ä½ çš„æ¯ä¸ªå¹¿æ’­å˜é‡æœ‰å¤šå¤§äº†ã€‚<br><br>ä¸è¿‡anywayï¼Œåªè¦ä½ Driverå†…å­˜è¶³å¤Ÿå¤§ï¼Œæ¯ä¸ªå¹¿æ’­åˆä¸è¶…è¿‡8Gï¼Œå°±æ²¡äº‹ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1629368977,"ip_address":"","comment_id":307596,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10219103705","product_id":100073401,"comment_content":"è€å¸ˆï¼Œå‡è®¾æˆ‘æœ‰16å¼ è¡¨éœ€è¦è¿æ¥ï¼Œå…¶ä½™15å¼ éƒ½æ˜¯å°è¡¨ï¼Œå¦‚æœæˆ‘å°†15å¼ å°è¡¨éƒ½åšæˆå¹¿æ’­å˜é‡ï¼Œå‡è®¾ä»–ä»¬çš„æ€»æ•°æ®é‡è¶…è¿‡äº†8Gï¼Œæ˜¯ä¸æ˜¯ä¼šç›´æ¥OOMå‘€ï¼Œè¿˜æ˜¯è¯´åªè¦æ¯ä¸€ä¸ªå¹¿æ’­å˜é‡ä¸è¶…è¿‡8g,å°±ä¸ä¼šæœ‰é—®é¢˜ã€‚","like_count":3,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":525208,"discussion_content":"æ˜¯è¿™æ ·çš„ï¼Œæ¯ä¸ªå¹¿æ’­çš„ä¸Šé™æ˜¯8Gï¼Œè¶…è¿‡è¿™ä¸ªé™åˆ¶ï¼ŒSparkç›´æ¥æŠ›å¼‚å¸¸ã€‚æ‰€ä»¥ï¼Œè¿™ä¸ª8Gæ˜¯ä»¥å¹¿æ’­å˜é‡ä¸ºç²’åº¦çš„ã€‚15ä¸ªå°è¡¨çš„è¯ï¼Œåªè¦ä»–ä»¬å„è‡ªä¸è¶…è¿‡8Gå°±æ²¡äº‹ã€‚ä¸è¿‡ï¼Œè¯è¯´ï¼ŒåŒæ—¶æ15ä¸ªå¹¿æ’­å˜é‡ï¼ŒDriverä¸ä¸€å®šå—å¾—äº†~ å½“ç„¶ï¼Œè¦çœ‹ä½ çš„æ¯ä¸ªå¹¿æ’­å˜é‡æœ‰å¤šå¤§äº†ã€‚\n\nä¸è¿‡anywayï¼Œåªè¦ä½ Driverå†…å­˜è¶³å¤Ÿå¤§ï¼Œæ¯ä¸ªå¹¿æ’­åˆä¸è¶…è¿‡8Gï¼Œå°±æ²¡äº‹ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629368977,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":294404,"user_name":"ç¬¨å°å­©","can_delete":false,"product_type":"c1","uid":1799778,"ip_address":"","ucode":"9C43C0BEA34F4C","user_header":"https://static001.geekbang.org/account/avatar/00/1b/76/62/74e6d2d1.jpg","comment_is_top":false,"comment_ctime":1621930061,"is_pvip":false,"replies":[{"id":"106839","content":"ä¸ä¼šçš„~ å’Œè¯­æ³•æ²¡ä»€ä¹ˆå…³ç³»ï¼Œä¸»è¦æ˜¯çœ‹è¡¨å¤§å°ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1621952522,"ip_address":"","comment_id":294404,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10211864653","product_id":100073401,"comment_content":"è€å¸ˆä½ å¥½  åœ¨SparkSqlä¸­ä½¿ç”¨ç±»ä¼¼with  as  è¿™æ ·çš„è¯­æ³•  ä¼šè‡ªåŠ¨å¹¿æ’­è¿™å¼ è¡¨å˜›","like_count":2,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":520641,"discussion_content":"ä¸ä¼šçš„~ å’Œè¯­æ³•æ²¡ä»€ä¹ˆå…³ç³»ï¼Œä¸»è¦æ˜¯çœ‹è¡¨å¤§å°ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621952522,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":288935,"user_name":"Jefitar","can_delete":false,"product_type":"c1","uid":1370659,"ip_address":"","ucode":"D7ED9F32ADA5B1","user_header":"https://static001.geekbang.org/account/avatar/00/14/ea/23/508f71e3.jpg","comment_is_top":false,"comment_ctime":1618793526,"is_pvip":false,"replies":[{"id":"104877","content":"å…·ä½“ç»†èŠ‚å¯ä»¥å‚è€ƒè¿™é‡Œå“ˆï¼šhttps:&#47;&#47;databricks.com&#47;blog&#47;2015&#47;04&#47;28&#47;project-tungsten-bringing-spark-closer-to-bare-metal.html<br><br>java.lang.String object internals:<br>OFFSET  SIZE   TYPE DESCRIPTION                    VALUE<br>     0     4        (object header)                ...<br>     4     4        (object header)                ...<br>     8     4        (object header)                ...<br>    12     4 char[] String.value                   []<br>    16     4    int String.hash                    0<br>    20     4    int String.hash32                  0<br>Instance size: 24 bytes (reported by Instrumentation API)","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1618814044,"ip_address":"","comment_id":288935,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10208728118","product_id":100073401,"comment_content":"è€å¸ˆï¼Œæœ‰ä¸ªé—®é¢˜ï¼Œå­—ç¬¦ä¸²â€œabcdâ€åªéœ€è¦æ¶ˆè€— 4 ä¸ªå­—èŠ‚ï¼Œä¸ºä»€ä¹ˆJVM åœ¨å †å†…å­˜å‚¨è¿™ 4 ä¸ªå­—ç¬¦ä¸²æ€»å…±éœ€è¦æ¶ˆè€— 48 ä¸ªå­—èŠ‚ï¼Ÿ","like_count":3,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":518774,"discussion_content":"å…·ä½“ç»†èŠ‚å¯ä»¥å‚è€ƒè¿™é‡Œå“ˆï¼šhttps://databricks.com/blog/2015/04/28/project-tungsten-bringing-spark-closer-to-bare-metal.html\n\njava.lang.String object internals:\nOFFSET  SIZE   TYPE DESCRIPTION                    VALUE\n     0     4        (object header)                ...\n     4     4        (object header)                ...\n     8     4        (object header)                ...\n    12     4 char[] String.value                   []\n    16     4    int String.hash                    0\n    20     4    int String.hash32                  0\nInstance size: 24 bytes (reported by Instrumentation API)","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618814044,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":311133,"user_name":"é­æµ·éœ","can_delete":false,"product_type":"c1","uid":2438607,"ip_address":"","ucode":"961DED8B696936","user_header":"https://static001.geekbang.org/account/avatar/00/25/35/cf/aa4f9c65.jpg","comment_is_top":false,"comment_ctime":1631083578,"is_pvip":true,"replies":[{"id":"112912","content":"èƒ½æŠŠæ‰§è¡Œè®¡åˆ’è´´å‡ºæ¥å—ï¼Ÿï¼ˆå¯ä»¥åœ¨joinå®Œæˆä¹‹åçš„DataFrameä¹‹ä¸Šè°ƒç”¨explainï¼‰<br><br>æˆ‘æƒ³çŸ¥é“è¿™4å¼ è¡¨çš„å…³è”é¡ºåºï¼Œè®²é“ç†ï¼Œåº”è¯¥æ˜¯:<br>((a inner join b) inner join c) left join d<br>è¿™æ˜¯æˆ‘çš„ç†è§£ï¼Œå¦‚æœæ˜¯è¿™æ ·çš„è¯ï¼Œç†è®ºä¸Šåº”è¯¥éƒ½æ˜¯Broadcast Joinæ‰å¯¹ï¼Œå¯ä»¥æŠŠexplainæ‰§è¡Œè®¡åˆ’è´´å‡ºæ¥ç¡®è®¤ä¸€ä¸‹~<br><br>","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1631345773,"ip_address":"","comment_id":311133,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5926050874","product_id":100073401,"comment_content":"è€å¸ˆæ‚¨å¥½ï¼Œç”¨sparksqlå¼€å‘ï¼Œé‡åˆ°ä¸€ä¸ªå†™äº†hintä¹Ÿä¸èµ°broadcastçš„æƒ…å†µã€‚å…·ä½“æƒ…å†µæ˜¯è¿™æ ·çš„ï¼ŒAè¡¨æ˜¯ä¸ªå¤§è¡¨,æœ‰20å¤šäº¿æ¡è®°å½•ï¼Œb,c,déƒ½æ˜¯å°è¡¨ï¼Œè¡¨å°±å‡ ä¸ªå­—æ®µï¼Œæ•°æ®æœ€å¤šä¹Ÿå°±3000å¤šæ¡ï¼Œselect &#47;*+ broadcast(b,c,d) from a join b jion c left join d<br>æ‰§è¡Œè®¡åˆ’é‡Œb céƒ½ç”¨çš„æ˜¯BroadcastHashJOIN,dè¡¨æ˜¯SortMergeJoinã€‚dè¡¨ä¸èµ°bhjçš„åŸå› å¤§æ¦‚æ˜¯ä»€ä¹ˆï¼Ÿèƒ½ç»™ä¸ªæ€è·¯å—ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":526486,"discussion_content":"èƒ½æŠŠæ‰§è¡Œè®¡åˆ’è´´å‡ºæ¥å—ï¼Ÿï¼ˆå¯ä»¥åœ¨joinå®Œæˆä¹‹åçš„DataFrameä¹‹ä¸Šè°ƒç”¨explainï¼‰\n\næˆ‘æƒ³çŸ¥é“è¿™4å¼ è¡¨çš„å…³è”é¡ºåºï¼Œè®²é“ç†ï¼Œåº”è¯¥æ˜¯:\n((a inner join b) inner join c) left join d\nè¿™æ˜¯æˆ‘çš„ç†è§£ï¼Œå¦‚æœæ˜¯è¿™æ ·çš„è¯ï¼Œç†è®ºä¸Šåº”è¯¥éƒ½æ˜¯Broadcast Joinæ‰å¯¹ï¼Œå¯ä»¥æŠŠexplainæ‰§è¡Œè®¡åˆ’è´´å‡ºæ¥ç¡®è®¤ä¸€ä¸‹~\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631345773,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2438607,"avatar":"https://static001.geekbang.org/account/avatar/00/25/35/cf/aa4f9c65.jpg","nickname":"é­æµ·éœ","note":"","ucode":"961DED8B696936","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":393582,"discussion_content":"æ‰§è¡Œé¡ºåºå°±æ˜¯è€å¸ˆå†™çš„å…³è”é¡ºåº\næˆ‘çš„è¿™ä¸ªå°è¡¨æ˜¯ä¸€ä¸ªå‹ç¼©è¡¨ï¼Œå‹ç¼©ç­–ç•¥æ˜¯snappy,æˆ‘ä»¬ç»™å®ƒæ”¹æˆäº†æ–‡æœ¬è¡¨ï¼Œç„¶åå®ƒå°±èµ°äº†broadcastäº†ã€‚è™½ç„¶æ‰§è¡Œè®¡åˆ’å¯¹äº†ï¼Œä½†æ˜¯åŸç†æˆ‘æ²¡æœ‰æƒ³æ˜ç™½","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631503207,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":331703,"user_name":"Sampson","can_delete":false,"product_type":"c1","uid":1418226,"ip_address":"","ucode":"BA78CA29A6D898","user_header":"https://static001.geekbang.org/account/avatar/00/15/a3/f2/ab8c5183.jpg","comment_is_top":false,"comment_ctime":1642731920,"is_pvip":true,"replies":[{"id":"121207","content":"è¿™ä¸ªé…ç½®é¡¹spark.sql.autoBroadcastJoinThresholdï¼Œå®ƒçš„å«ä¹‰æ˜¯ï¼Œsizeä¸å¤§äºè¿™ä¸ªè®¾ç½®çš„æ•°æ®é›†ï¼Œå¯ä»¥è¢«å¹¿æ’­ã€‚ä»logæ¥çœ‹ï¼Œä½ çš„å¹¿æ’­å˜é‡å°äº1Gï¼Œæ‰€ä»¥æ²¡æœ‰é—®é¢˜~ å¹¶ä¸æ˜¯è¯´ä½ è®¾ç½®å¤šå°‘ï¼Œå¹¿æ’­å˜é‡å¤§å°å°±æ˜¯å¤šå°‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1043100","ctime":1642780693,"ip_address":"","comment_id":331703,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1642731920","product_id":100073401,"comment_content":"ç£Šå“¥ä½ å¥½ ï¼Œè¯·æ•™ä¸€ä¸‹ï¼Œæˆ‘åœ¨æˆ‘çš„ä»»åŠ¡ä¸­è®¾ç½®çš„å¦‚ä¸‹çš„å‚æ•°æäº¤Sparkä»»åŠ¡ï¼Œ<br>--master yarn --deploy-mode cluster --num-executors 20 --executor-cores 1 --executor-memory 5G --driver-memory 2G  --conf spark.yarn.executor.memoryOverhead=2048M --conf spark.sql.shuffle.partitions=30 --conf spark.default.parallelism=30 --conf spark.sql.autoBroadcastJoinThreshold=1024 <br><br>æŒ‰ç…§ä¸Šæ–‡ä¸­è®²åˆ°çš„æˆ‘è®¾ç½®äº†å¹¿æ’­å˜é‡çš„é˜€å€¼æ˜¯ 1024 = 1G ï¼Œä½†æ˜¯çœ‹ä»»åŠ¡è¿è¡Œä¸­çš„æ—¥å¿— <br><br>storage.BlockManagerInfo: Added broadcast_4_piece0 in memory on miai7:38123 (size: 14.5 KB, free: 2.5 GB)<br>storage.BlockManagerInfo: Added broadcast_4_piece0 in memory on miai9:38938 (size: 14.5 KB, free: 2.5 GB)<br>storage.BlockManagerInfo: Added broadcast_4_piece0 in memory on miai5:39487 (size: 14.5 KB, free: 2.5 GB)<br>storage.BlockManagerInfo: Added broadcast_4_piece0 in memory on miai7:46429 (size: 14.5 KB, free: 2.5 GB)<br>storage.BlockManagerInfo: Added broadcast_4_piece0 in memory on miai5:41456 (size: 14.5 KB, free: 2.5 GB)<br>storage.BlockManagerInfo: Added broadcast_4_piece0 in memory on miai7:40246 (size: 14.5 KB, free: 2.5 GB)<br>storage.BlockManagerInfo: Added broadcast_4_piece0 in memory on miai5:45320 (size: 14.5 KB, free: 2.5 GB)<br>storage.BlockManagerInfo: Added broadcast_4_piece0 in memory on miai4:41769 (size: 14.5 KB, free: 2.5 GB)<br>storage.BlockManagerInfo: Added broadcast_4_piece0 in memory on miai4:38896 (size: 14.5 KB, free: 2.5 GB)<br>storage.BlockManagerInfo: Added broadcast_4_piece0 in memory on miai4:35351 (size: 14.5 KB, free: 2.5 GB)<br><br>å¹¶ä¸æ˜¯æˆ‘è®¾ç½®çš„1Gå‘€ ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ ï¼Ÿ<br><br>","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":547655,"discussion_content":"è¿™ä¸ªé…ç½®é¡¹spark.sql.autoBroadcastJoinThresholdï¼Œå®ƒçš„å«ä¹‰æ˜¯ï¼Œsizeä¸å¤§äºè¿™ä¸ªè®¾ç½®çš„æ•°æ®é›†ï¼Œå¯ä»¥è¢«å¹¿æ’­ã€‚ä»logæ¥çœ‹ï¼Œä½ çš„å¹¿æ’­å˜é‡å°äº1Gï¼Œæ‰€ä»¥æ²¡æœ‰é—®é¢˜~ å¹¶ä¸æ˜¯è¯´ä½ è®¾ç½®å¤šå°‘ï¼Œå¹¿æ’­å˜é‡å¤§å°å°±æ˜¯å¤šå°‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642780693,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":329626,"user_name":"Unknown element","can_delete":false,"product_type":"c1","uid":2028277,"ip_address":"","ucode":"34A129800D0238","user_header":"https://static001.geekbang.org/account/avatar/00/1e/f2/f5/b82f410d.jpg","comment_is_top":false,"comment_ctime":1641451962,"is_pvip":false,"replies":[{"id":"120202","content":"æœ€æ—©åœ¨å“ªé‡Œçœ‹åˆ°çš„ï¼Œè¯´å®è¯æˆ‘ä¹Ÿå¿˜äº†[å…æ‚²]ï¼Œå¤ªä¹…äº†ã€‚ä¸è¿‡è¿™ä¸ªæ–¹æ³•ä¸€å®šæ˜¯åˆ‡å®å¯è¡Œçš„ï¼Œæ—¥å¸¸çš„å·¥ä½œä¸­éªŒè¯æ— æ•°æ¬¡äº†å“ˆ~<br><br>éœ€è¦æé†’çš„æ˜¯ï¼Œè¦é¢„ä¼°æ•°æ®é›†çš„å†…å­˜å ç”¨ï¼Œéœ€è¦å…ˆæŠŠæ•°æ®é›†cacheèµ·æ¥ï¼Œå¦åˆ™çš„è¯ï¼ŒsizeInBytesç»™å‡ºçš„ï¼Œå®é™…ä¸Šæºæ–‡ä»¶åœ¨ç£ç›˜ä¸Šçš„å­˜å‚¨å¤§å°ï¼Œåˆ‡è®°åˆ‡è®°","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1043100","ctime":1641722102,"ip_address":"","comment_id":329626,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1641451962","product_id":100073401,"comment_content":"è€å¸ˆæ‚¨å¥½ è¯·é—®<br>val plan = df.queryExecution.logicalval estimated: BigInt = spark.sessionState.executePlan(plan).optimizedPlan.stats.sizeInBytes<br>è¿™ä¸ªæŸ¥çœ‹å†…å­˜å ç”¨çš„æ–¹æ³•æ˜¯åœ¨å“ªé‡Œçœ‹åˆ°çš„å‘¢ï¼Ÿæˆ‘åœ¨å®˜æ–¹æ–‡æ¡£ <br>https:&#47;&#47;spark.apache.org&#47;docs&#47;2.4.0&#47;api&#47;scala&#47;index.html#org.apache.spark.sql.DataFrameNaFunctions é‡ŒæŠŠè¿™äº›æ–¹æ³•éƒ½æœäº†ä¸€éæ²¡æœ‰æœåˆ°QAQ","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":544814,"discussion_content":"æœ€æ—©åœ¨å“ªé‡Œçœ‹åˆ°çš„ï¼Œè¯´å®è¯æˆ‘ä¹Ÿå¿˜äº†[å…æ‚²]ï¼Œå¤ªä¹…äº†ã€‚ä¸è¿‡è¿™ä¸ªæ–¹æ³•ä¸€å®šæ˜¯åˆ‡å®å¯è¡Œçš„ï¼Œæ—¥å¸¸çš„å·¥ä½œä¸­éªŒè¯æ— æ•°æ¬¡äº†å“ˆ~\n\néœ€è¦æé†’çš„æ˜¯ï¼Œè¦é¢„ä¼°æ•°æ®é›†çš„å†…å­˜å ç”¨ï¼Œéœ€è¦å…ˆæŠŠæ•°æ®é›†cacheèµ·æ¥ï¼Œå¦åˆ™çš„è¯ï¼ŒsizeInBytesç»™å‡ºçš„ï¼Œå®é™…ä¸Šæºæ–‡ä»¶åœ¨ç£ç›˜ä¸Šçš„å­˜å‚¨å¤§å°ï¼Œåˆ‡è®°åˆ‡è®°","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641722102,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":306674,"user_name":"çŒ¿é¸½å›","can_delete":false,"product_type":"c1","uid":1991951,"ip_address":"","ucode":"8562D8C5AD3D1E","user_header":"https://static001.geekbang.org/account/avatar/00/1e/65/0f/7b9f27f2.jpg","comment_is_top":false,"comment_ctime":1628667185,"is_pvip":false,"replies":[{"id":"111186","content":"ä½ è¯´çš„æ˜¯DataFrame.statä¸‹é¢çš„é‚£äº›ç»Ÿè®¡å‡½æ•°å—ï¼Ÿæ¯”å¦‚ï¼š<br>approxQuantile   bloomFilter   corr   countMinSketch   cov   crosstab   freqItems   sampleByï¼Ÿ<br><br>æˆ‘è¿™è¾¹3.0è¯•äº†ä¸éœ€è¦SQLConfã€‚<br><br>å¦å¤–ï¼Œå¦‚æœä½ æƒ³è·å–å’Œæ‰§è¡Œè®¡åˆ’æœ‰å…³çš„ä¿¡æ¯ï¼Œè¿˜å¯ä»¥ç”¨DataFrame.queryExecution.* ä¸‹é¢çš„é‚£äº›å‡½æ•°ï¼Œæ¯”å¦‚executedPlanã€optimizedPlanã€sparkPlanï¼Œç­‰ç­‰ã€‚å½“ç„¶ï¼Œè¿™äº›éƒ½æ˜¯äº›ä¸åŒé˜¶æ®µçš„æ‰§è¡Œè®¡åˆ’ï¼Œæ²¡æœ‰ä½ è¯´çš„ç»Ÿè®¡æ•°æ®ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1628838176,"ip_address":"","comment_id":306674,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1628667185","product_id":100073401,"comment_content":"è€å¸ˆå¥½ã€‚æˆ‘ä»¬sparkæ˜¯2.2.0ï¼Œsparksqlæ˜¯2.11ã€‚æˆ‘æƒ³æ¨¡æ‹Ÿè¯»å– Spark SQL æ‰§è¡Œè®¡åˆ’çš„ç»Ÿè®¡æ•°æ®æ—¶ã€‚åœ¨è°ƒç”¨statsæ—¶å´éœ€è¦ä¼ ä¸€ä¸ªSQLConfç±»å‹çš„å‚æ•°ã€‚è¯·é—®è¿™æ˜¯ç‰ˆæœ¬çš„é—®é¢˜å—ï¼Ÿæœ‰ä»€ä¹ˆæ›¿ä»£çš„æ–¹æ³•ï¼Ÿæ„Ÿè°¢","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":524865,"discussion_content":"ä½ è¯´çš„æ˜¯DataFrame.statä¸‹é¢çš„é‚£äº›ç»Ÿè®¡å‡½æ•°å—ï¼Ÿæ¯”å¦‚ï¼š\napproxQuantile   bloomFilter   corr   countMinSketch   cov   crosstab   freqItems   sampleByï¼Ÿ\n\næˆ‘è¿™è¾¹3.0è¯•äº†ä¸éœ€è¦SQLConfã€‚\n\nå¦å¤–ï¼Œå¦‚æœä½ æƒ³è·å–å’Œæ‰§è¡Œè®¡åˆ’æœ‰å…³çš„ä¿¡æ¯ï¼Œè¿˜å¯ä»¥ç”¨DataFrame.queryExecution.* ä¸‹é¢çš„é‚£äº›å‡½æ•°ï¼Œæ¯”å¦‚executedPlanã€optimizedPlanã€sparkPlanï¼Œç­‰ç­‰ã€‚å½“ç„¶ï¼Œè¿™äº›éƒ½æ˜¯äº›ä¸åŒé˜¶æ®µçš„æ‰§è¡Œè®¡åˆ’ï¼Œæ²¡æœ‰ä½ è¯´çš„ç»Ÿè®¡æ•°æ®ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628838176,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":301207,"user_name":"è‡»æœçˆ¸çˆ¸","can_delete":false,"product_type":"c1","uid":1021794,"ip_address":"","ucode":"03DC9615B024A4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/97/62/1a2d7825.jpg","comment_is_top":false,"comment_ctime":1625574701,"is_pvip":false,"replies":[{"id":"109179","content":"2ä¸ªæ€è·¯å“ˆ~<br><br>1ï¼‰ç»“åˆä½ è¯´çš„ç°è±¡ï¼Œå°±æ˜¯åªæœ‰ä¸€ä¸ªtaskæ˜¯long runningï¼Œé‚£ä¹ˆå¤§æ¦‚ç‡æ˜¯æœ‰æ•°æ®å€¾æ–œé—®é¢˜ï¼Œå› æ­¤ä¸å¦¨å…ˆçœ‹çœ‹ï¼Œæ•°æ®é›†åœ¨å“ªé‡Œå‘ç”Ÿdata skewï¼Œç„¶åå®šå‘åœ°å»é™¤å€¾æ–œé—®é¢˜ã€‚æ•°æ®å€¾æ–œçš„åº”å¯¹åŠæ³•ï¼Œæˆ‘ä»¬åœ¨29è®²æ•°æ®å€¾æ–œé‚£ä¸ªéƒ¨åˆ†æœ‰è¯¦ç»†å±•å¼€ï¼Œä¸å¦¨å…³æ³¨ä¸€ä¸‹<br><br>2ï¼‰æ—¢ç„¶å®šä½åˆ°æ˜¯GCé—®é¢˜ï¼Œé‚£ä¹ˆä¸å¦¨é€šè¿‡JVMå‚æ•°(spark.driver.extraJavaOptionsä¸­æ·»åŠ -XX:+PrintGCDetails)ï¼Œæ¥è®°å½•GCæ—¥å¿—ï¼Œç„¶åé€šè¿‡ä¸€äº›å¯è§†åŒ–å·¥å…·æ¥æ£€æŸ¥GCè¡Œä¸ºï¼Œæ¯”å¦‚æ˜¯æ–°ç”Ÿä»£çš„å¤šï¼Œè¿˜æ˜¯è€å¹´ä»£çš„å¤šã€‚å°±ä½ è¿™ä¸ªCaseæ¥è¯´ï¼Œæˆ‘çŒœæµ‹ï¼Œå¤§æ¦‚ç‡æ˜¯è€å¹´ä»£çš„å¤šï¼Œé‚£ä½ å°±è¦çœ‹ï¼Œæ˜¯ä¸æ˜¯CacheåŠ çš„å¤ªå¤šäº†ï¼Œè¿˜æ˜¯å…¶ä»–ä»€ä¹ˆä¸œè¥¿å ç”¨å†…å­˜å¤ªä¹…äº†ï¼Œæ²¡èƒ½åŠæ—¶æ¸…ç†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1625801909,"ip_address":"","comment_id":301207,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1625574701","product_id":100073401,"comment_content":"spark sqlæ‰§è¡Œæ—¶ï¼Œæœ‰ä¸€ä¸ªtaskä¸€ç›´runningï¼Œä½†æ˜¯æ‰§è¡Œè€—æ—¶ç­‰sparkuiå‚æ•°éƒ½ä¸º0ï¼Œåªæœ‰gcæ—¶é—´ä¸€ç›´åœ¨å¢åŠ ï¼Œæƒ³é—®ä¸‹è¿™ä¸ªæ€ä¹ˆæ’æŸ¥ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":522929,"discussion_content":"2ä¸ªæ€è·¯å“ˆ~\n\n1ï¼‰ç»“åˆä½ è¯´çš„ç°è±¡ï¼Œå°±æ˜¯åªæœ‰ä¸€ä¸ªtaskæ˜¯long runningï¼Œé‚£ä¹ˆå¤§æ¦‚ç‡æ˜¯æœ‰æ•°æ®å€¾æ–œé—®é¢˜ï¼Œå› æ­¤ä¸å¦¨å…ˆçœ‹çœ‹ï¼Œæ•°æ®é›†åœ¨å“ªé‡Œå‘ç”Ÿdata skewï¼Œç„¶åå®šå‘åœ°å»é™¤å€¾æ–œé—®é¢˜ã€‚æ•°æ®å€¾æ–œçš„åº”å¯¹åŠæ³•ï¼Œæˆ‘ä»¬åœ¨29è®²æ•°æ®å€¾æ–œé‚£ä¸ªéƒ¨åˆ†æœ‰è¯¦ç»†å±•å¼€ï¼Œä¸å¦¨å…³æ³¨ä¸€ä¸‹\n\n2ï¼‰æ—¢ç„¶å®šä½åˆ°æ˜¯GCé—®é¢˜ï¼Œé‚£ä¹ˆä¸å¦¨é€šè¿‡JVMå‚æ•°(spark.driver.extraJavaOptionsä¸­æ·»åŠ -XX:+PrintGCDetails)ï¼Œæ¥è®°å½•GCæ—¥å¿—ï¼Œç„¶åé€šè¿‡ä¸€äº›å¯è§†åŒ–å·¥å…·æ¥æ£€æŸ¥GCè¡Œä¸ºï¼Œæ¯”å¦‚æ˜¯æ–°ç”Ÿä»£çš„å¤šï¼Œè¿˜æ˜¯è€å¹´ä»£çš„å¤šã€‚å°±ä½ è¿™ä¸ªCaseæ¥è¯´ï¼Œæˆ‘çŒœæµ‹ï¼Œå¤§æ¦‚ç‡æ˜¯è€å¹´ä»£çš„å¤šï¼Œé‚£ä½ å°±è¦çœ‹ï¼Œæ˜¯ä¸æ˜¯CacheåŠ çš„å¤ªå¤šäº†ï¼Œè¿˜æ˜¯å…¶ä»–ä»€ä¹ˆä¸œè¥¿å ç”¨å†…å­˜å¤ªä¹…äº†ï¼Œæ²¡èƒ½åŠæ—¶æ¸…ç†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625801909,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":297210,"user_name":"é—¯é—¯","can_delete":false,"product_type":"c1","uid":1544692,"ip_address":"","ucode":"D32958F8EF26BD","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83errHypG6kuO0V0bRwp74rm8srjoQ4zXUBNNLMcY19uNdz8Ea3rOFuBJibXMHWePMwBYpGsyyxiav0ibw/132","comment_is_top":false,"comment_ctime":1623378758,"is_pvip":false,"replies":[{"id":"107956","content":"quoteï¼šâ€œè¿™è¯´æ˜æ˜¯ä¸æ˜¯å¯ä»¥ç®€åŒ–å‘¢ã€‚â€<br><br>å…·ä½“æŒ‡çš„æ˜¯ç®€åŒ–ä»€ä¹ˆå‘¢ï¼Ÿ","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1623395609,"ip_address":"","comment_id":297210,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1623378758","product_id":100073401,"comment_content":"è€å¸ˆæœ‰ä¸ªç–‘é—®ï¼Œçœ‹äº†æ‚¨çš„æ–‡ç« åï¼ŒåŠ¨æ‰‹è¯•äº†ä¸‹ï¼š<br>df.queryExecution.optimizedPlan.stats.sizeInBytes<br>è¿™æ®µä»£ç ä¹Ÿæ˜¯èƒ½å¤Ÿè·å–ç»Ÿè®¡ä¿¡æ¯çš„ã€‚è¿™è¯´æ˜æ˜¯ä¸æ˜¯å¯ä»¥ç®€åŒ–å‘¢ã€‚çœ‹äº†æºç å‘ç°ï¼Œè¿™ä¸ªä¾‹å­è·Ÿæ‚¨çš„ä¾‹å­è°ƒç”¨ optimizedPlan æ˜¯åŒä¸€æ®µä»£ç ","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":521761,"discussion_content":"quoteï¼šâ€œè¿™è¯´æ˜æ˜¯ä¸æ˜¯å¯ä»¥ç®€åŒ–å‘¢ã€‚â€\n\nå…·ä½“æŒ‡çš„æ˜¯ç®€åŒ–ä»€ä¹ˆå‘¢ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1623395609,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":291792,"user_name":"Geek_01eb83","can_delete":false,"product_type":"c1","uid":1637240,"ip_address":"","ucode":"15E5A8D93BA470","user_header":"https://static001.geekbang.org/account/avatar/00/18/fb/78/dc5a1035.jpg","comment_is_top":false,"comment_ctime":1620485298,"is_pvip":false,"replies":[{"id":"105737","content":"èƒ½æä¾›æ›´å¤šç»†èŠ‚å—ï¼Ÿæ¯”å¦‚ç¤ºä¾‹ä»£ç ã€‚å¦‚æœä»…ä»…æ˜¯åœ¨æ¯ä¸€æ¬¡sqlContext.sql()è°ƒç”¨ä¹‹åæ·»åŠ countï¼Œå°±å¯ä»¥æå‡æ‰§è¡Œæ€§èƒ½ï¼Œè¿™ä¸ªå®åœ¨æ˜¯è§£é‡Šä¸è¿‡å»ã€‚å¦‚æœcountä¹‹å‰ï¼Œåˆ†å¸ƒå¼æ•°æ®é›†åŠ äº†Cacheï¼Œè¿˜æƒ…æœ‰å¯åŸï¼Œä½†å¦‚æœä»€ä¹ˆéƒ½æ²¡æœ‰ï¼Œå•çº¯é åŠ countæå‡æ€§èƒ½ï¼Œå¦ç™½è¯´ï¼Œæˆ‘çœŸçš„å¾ˆå¥½å¥‡è¿™æ˜¯æ€ä¹ˆåšåˆ°çš„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1620656698,"ip_address":"","comment_id":291792,"utype":1}],"discussion_count":3,"race_medal":0,"score":"1620485298","product_id":100073401,"comment_content":"è€å¸ˆï¼Œæ‚¨å¥½ï¼è¯·æ•™ä¸€ä¸ªé—®é¢˜ï¼Œæœ€è¿‘ç”¨DataFrameç¼–å†™sparkç¨‹åºï¼Œç¨‹åºä¸­é€šè¿‡sqlContext.sql()çš„æ–¹å¼å¤„ç†Hiveä¸Šçš„æ•°æ®ï¼Œå‘ç°é€Ÿåº¦å¾ˆæ…¢ï¼ˆæ•´ä¸ªç¨‹åºå¾ˆé•¿ï¼Œç”¨äº†å¾ˆå¤šæ¬¡sqlContext.sql()ï¼Œå¹¶ä¸”æ³¨å†Œäº†ä¸´æ—¶è¡¨ï¼‰ã€‚æœ€ååœ¨æ¯ä¸€æ­¥çš„sqlContext.sql()è¯­å¥åé¢åŠ ä¸Šäº†countï¼ˆä¹Ÿå³æ˜¯actionç®—å­ï¼‰ï¼Œå…¶ä»–æ²¡æœ‰æ”¹åŠ¨ï¼Œè¿™æ ·æ•´ä¸ªç¨‹åºå¿«äº†å¾ˆå¤šã€‚æƒ³éº»çƒ¦é—®ä¸‹è¿™æ˜¯ä»€ä¹ˆåŸå› ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":519572,"discussion_content":"èƒ½æä¾›æ›´å¤šç»†èŠ‚å—ï¼Ÿæ¯”å¦‚ç¤ºä¾‹ä»£ç ã€‚å¦‚æœä»…ä»…æ˜¯åœ¨æ¯ä¸€æ¬¡sqlContext.sql()è°ƒç”¨ä¹‹åæ·»åŠ countï¼Œå°±å¯ä»¥æå‡æ‰§è¡Œæ€§èƒ½ï¼Œè¿™ä¸ªå®åœ¨æ˜¯è§£é‡Šä¸è¿‡å»ã€‚å¦‚æœcountä¹‹å‰ï¼Œåˆ†å¸ƒå¼æ•°æ®é›†åŠ äº†Cacheï¼Œè¿˜æƒ…æœ‰å¯åŸï¼Œä½†å¦‚æœä»€ä¹ˆéƒ½æ²¡æœ‰ï¼Œå•çº¯é åŠ countæå‡æ€§èƒ½ï¼Œå¦ç™½è¯´ï¼Œæˆ‘çœŸçš„å¾ˆå¥½å¥‡è¿™æ˜¯æ€ä¹ˆåšåˆ°çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620656698,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1637240,"avatar":"https://static001.geekbang.org/account/avatar/00/18/fb/78/dc5a1035.jpg","nickname":"Geek_01eb83","note":"","ucode":"15E5A8D93BA470","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":376857,"discussion_content":"val df1 = sqlContext.sql().persist()\nval df2 = sqlContext.sql().persist()\nval df3 = df1.join(df2).persist()\nval df4 = sqlContext.sql().persist()\nval df = df3.join(df4)\nç±»ä¼¼è¿™ç§ä»£ç ï¼Œé‡Œé¢åŠ äº†æŒºå¤šç¼“å­˜çš„ï¼Œç”¨çš„æ˜¯persistå‡½æ•°ã€‚\n        æˆ‘çš„ç†è§£æ˜¯ï¼Œæ¯ä¸ªdfä¸‹é¢åŠ äº†countè¿™ç§æ‰§è¡Œç®—å­åï¼Œå¼ºåˆ¶æŠŠDataFrameæ‰§è¡Œäº†ï¼Œç„¶åæŠŠç»“æœç¼“å­˜èµ·æ¥ã€‚ä½†æ˜¯ï¼Œä¸å¤ªç†è§£çš„æ˜¯ï¼Œä¸ºå•¥ä¸åŠ æ‰§è¡Œç®—å­å°±æ…¢ï¼Ÿæ˜¯ä¸æ˜¯ä¸åŠ æ‰§è¡Œç®—å­åsparkä¼˜åŒ–æ‰§è¡Œè®¡åˆ’çš„æ—¶å€™å‡ºäº†é—®é¢˜ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1622383687,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1549032,"avatar":"","nickname":"Zzz","note":"","ucode":"9323254354868B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1637240,"avatar":"https://static001.geekbang.org/account/avatar/00/18/fb/78/dc5a1035.jpg","nickname":"Geek_01eb83","note":"","ucode":"15E5A8D93BA470","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":388752,"discussion_content":"æœ‰å¯èƒ½ä¸¤è€…çš„æ‰§è¡Œè®¡åˆ’æœ‰åŒºåˆ«ï¼Œéœ€è¦å…·ä½“å¯¹æ¯”ä¸‹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628935204,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":376857,"ip_address":""},"score":388752,"extra":""}]}]},{"had_liked":false,"id":289204,"user_name":"è€³ä¸œ","can_delete":false,"product_type":"c1","uid":1266059,"ip_address":"","ucode":"70F69C219EF10B","user_header":"https://static001.geekbang.org/account/avatar/00/13/51/8b/29ed1c41.jpg","comment_is_top":false,"comment_ctime":1618915357,"is_pvip":false,"replies":[{"id":"104943","content":"å…ˆè¯´joinå½¢å¼ï¼Œleft joinï¼Œä¸€å®šæ˜¯å¤§è¡¨æ”¾å·¦è¾¹ï¼Œå°è¡¨æ”¾å³è¾¹ã€‚right joinï¼Œåè¿‡æ¥ï¼Œä¸€å®šæ˜¯å°è¡¨æ”¾å·¦è¾¹ï¼Œå¤§è¡¨æ”¾å³è¾¹~ è¿™ä¸ªæ˜¯å…³è”å½¢å¼å†³å®šçš„ï¼Œä¸ç„¶å¹²å˜›å«â€œå·¦â€ã€â€œå³â€è¿æ¥å‘¢ï¼Ÿ<br><br>å†è¯´Broadcast Joinsï¼Œå‚ä¸å…³è”çš„ä¸¤å¼ è¡¨ï¼Œè¦å¹¿æ’­çš„è¯ï¼Œä¸€å®šæ˜¯å¹¿æ’­å°è¡¨ï¼ŒåŸå› è™½ç„¶æˆ‘ä»¬æœ¬è®²æ²¡æœ‰ç›´æ¥è¯´ï¼Œä¸è¿‡ç»“åˆä¸Šä¸€è®²Broadcast Joinå’ŒShuffle Joinsçš„è®¡ç®—è¿‡ç¨‹å’ŒåŸç†ï¼Œå…¶å®å¯ä»¥è‡ªè¡Œæ¨å¯¼å‡ºæ¥å“ˆ~<br><br>ä¸å¦¨åå‘æ€ç»´ï¼Œå¦‚æœä½ å¼ºè¡Œå¹¿æ’­å¤§è¡¨ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿå¹¿æ’­å¤§è¡¨çš„æ”¶ç›Šæ˜¯ä»€ä¹ˆï¼Ÿå¹¿æ’­å¤§è¡¨çš„æ”¶ç›Šï¼Œæ˜¯å¦å¤§äºåŸShuffle Joinsçš„æ‰§è¡Œæ€§èƒ½ï¼Ÿä¸å¦¨æƒ³ä¸€æƒ³å“ˆ~","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1618917953,"ip_address":"","comment_id":289204,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1618915357","product_id":100073401,"comment_content":"åœ¨å·¦è¿æ¥ï¼ˆLeft Outer Joinï¼‰ä¸­ï¼Œæˆ‘ä»¬åªèƒ½å¹¿æ’­å³è¡¨ï¼›åœ¨å³è¿æ¥ï¼ˆRight Outer Joinï¼‰ä¸­ï¼Œæˆ‘ä»¬åªèƒ½å¹¿æ’­å·¦è¡¨ã€‚  è¿™æ®µçš„æ„æ€æ˜¯æŒ‡åœ¨ left outer joinæ—¶ å¤§è¡¨æ”¾å·¦è¾¹ ï¼Œå°è¡¨æ”¾å³è¾¹å— ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":518849,"discussion_content":"å…ˆè¯´joinå½¢å¼ï¼Œleft joinï¼Œä¸€å®šæ˜¯å¤§è¡¨æ”¾å·¦è¾¹ï¼Œå°è¡¨æ”¾å³è¾¹ã€‚right joinï¼Œåè¿‡æ¥ï¼Œä¸€å®šæ˜¯å°è¡¨æ”¾å·¦è¾¹ï¼Œå¤§è¡¨æ”¾å³è¾¹~ è¿™ä¸ªæ˜¯å…³è”å½¢å¼å†³å®šçš„ï¼Œä¸ç„¶å¹²å˜›å«â€œå·¦â€ã€â€œå³â€è¿æ¥å‘¢ï¼Ÿ\n\nå†è¯´Broadcast Joinsï¼Œå‚ä¸å…³è”çš„ä¸¤å¼ è¡¨ï¼Œè¦å¹¿æ’­çš„è¯ï¼Œä¸€å®šæ˜¯å¹¿æ’­å°è¡¨ï¼ŒåŸå› è™½ç„¶æˆ‘ä»¬æœ¬è®²æ²¡æœ‰ç›´æ¥è¯´ï¼Œä¸è¿‡ç»“åˆä¸Šä¸€è®²Broadcast Joinå’ŒShuffle Joinsçš„è®¡ç®—è¿‡ç¨‹å’ŒåŸç†ï¼Œå…¶å®å¯ä»¥è‡ªè¡Œæ¨å¯¼å‡ºæ¥å“ˆ~\n\nä¸å¦¨åå‘æ€ç»´ï¼Œå¦‚æœä½ å¼ºè¡Œå¹¿æ’­å¤§è¡¨ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿå¹¿æ’­å¤§è¡¨çš„æ”¶ç›Šæ˜¯ä»€ä¹ˆï¼Ÿå¹¿æ’­å¤§è¡¨çš„æ”¶ç›Šï¼Œæ˜¯å¦å¤§äºåŸShuffle Joinsçš„æ‰§è¡Œæ€§èƒ½ï¼Ÿä¸å¦¨æƒ³ä¸€æƒ³å“ˆ~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618917953,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2028954,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/f5/9a/63dc81a2.jpg","nickname":"Geek1185","note":"","ucode":"47BEE492EF4C1A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":391146,"discussion_content":"ä¸åº”å®šleft joinå·¦è¾¹è¦æ”¾å¤§è¡¨å§ï¼Œæ¯”å¦‚æˆ‘æƒ³çœ‹æŸä¸ªäººç¾¤çš„è¿åŠ¨è½¨è¿¹ï¼Œå·¦è¡¨æ˜¯äººç¾¤ï¼ˆå‡ åƒä¸ªï¼‰ï¼Œå³è¡¨æ˜¯è½¨è¿¹ï¼ˆå‡ ç™¾äº¿ï¼‰ï¼Œæ²¡æœ‰è½¨è¿¹çš„äººä¹Ÿè¦ä¿ç•™ï¼Œå°±ç”¨left joinï¼Œé‚£æ­¤æ—¶å·¦è¡¨ä¸ºä»€ä¹ˆä¸èƒ½å¹¿æ’­å‘¢ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630314860,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":288550,"user_name":"è¾°","can_delete":false,"product_type":"c1","uid":2172635,"ip_address":"","ucode":"2E898EAC5AA141","user_header":"https://static001.geekbang.org/account/avatar/00/21/26/db/27724a6f.jpg","comment_is_top":false,"comment_ctime":1618536616,"is_pvip":false,"replies":[{"id":"104752","content":"3.0ä¹‹å‰åªæ”¯æŒBroadcast hintï¼Œ3.0ä¹‹åæ”¯æŒçš„å°±å¤šäº†ï¼š<br>BROADCAST<br>MERGE<br>SHUFFLE_HASH<br>SHUFFLE_REPLICATE_NL","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1618566806,"ip_address":"","comment_id":288550,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1618536616","product_id":100073401,"comment_content":"Hintå¥½åƒæ˜¯spark2.4ç‰ˆæœ¬ä¹‹åæ‰ä¼šæœ‰çš„å§ï¼Œæˆ‘å…¬å¸ç‰ˆæœ¬æ˜¯2.2ï¼Œä½†æ˜¯æˆ‘ä¹‹å‰ä½¿ç”¨broadcastä¸ç®¡ç”¨ï¼Œç„¶åè¯•äº†ä¸€ä¸‹hint,å±…ç„¶ç”Ÿæ•ˆäº†","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":518657,"discussion_content":"3.0ä¹‹å‰åªæ”¯æŒBroadcast hintï¼Œ3.0ä¹‹åæ”¯æŒçš„å°±å¤šäº†ï¼š\nBROADCAST\nMERGE\nSHUFFLE_HASH\nSHUFFLE_REPLICATE_NL","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618566806,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}