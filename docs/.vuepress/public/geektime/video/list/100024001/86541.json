{"id":86541,"title":"30 | 只运行一次","content":"<h1>课件及源代码地址</h1><p><a href=\"https://gitee.com/geektime-geekbang/go_learning\">https://gitee.com/geektime-geekbang/go_learning</a></p><h2>书目推荐</h2><p><a href=\"time://mall?url=https%3A%2F%2Fh5.youzan.com%2Fv2%2Fgoods%2F1ycmk3uob0ryw\">《计算机程序的构造和解释》</a></p>","comments":[{"had_liked":false,"id":117757,"user_name":"我还是不懂","can_delete":false,"product_type":"c3","uid":1145651,"ip_address":"","ucode":"995DCA35151140","user_header":"https://wx.qlogo.cn/mmopen/vi_32/ajNVdqHZLLCSARGdN0NI90E7VKY7B3GibjeINk8wpQRp3C7qQuRCtrtWLxxcKtAGDaZMutyiauzWvR7pwEm1oUaw/132","comment_is_top":false,"comment_ctime":1564125085,"is_pvip":false,"replies":[{"id":43157,"content":"其实obj已经是一个指针变量了，你可以看看GetSingleObj的返回值定义，所以&amp;obj就不对了，变成了指向指针的指针。","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1564148001,"ip_address":"","comment_id":117757,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"为什么不能这样写不是取地址么，地址还不同\nfunc TestSingle(t *testing.T) {\n\tvar wg sync.WaitGroup\n\tfor i := 0; i &lt; 10; i++ {\n\t\twg.Add(1)\n\t\tgo func() {\n\t\t\tobj := GetSingleObj()\n\t\t\t&#47;&#47;fmt.Printf(&quot;%x\\n&quot;, unsafe.Pointer(obj))\n\t\t\tfmt.Println(&amp;obj)\n\t\t\twg.Done()\n\t\t}()\n\t}\n\twg.Wait()\n}\n\n=== RUN   TestSingle\ncreate obj\n0xc0000b2000\n0xc000006040\n0xc000006048\n0xc000006050\n0xc000006058\n0xc000006060\n0xc000006068\n0xc000006080\n0xc000006070\n0xc000006078\n--- PASS: TestSingle (0.00s)\nPASS\n","like_count":7,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":460105,"discussion_content":"其实obj已经是一个指针变量了，你可以看看GetSingleObj的返回值定义，所以&amp;amp;obj就不对了，变成了指向指针的指针。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564148001,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":205623,"user_name":"真名不叫黄金","can_delete":false,"product_type":"c3","uid":1174066,"ip_address":"","ucode":"FB611FC98F5BA7","user_header":"https://static001.geekbang.org/account/avatar/00/11/ea/32/1fd102ec.jpg","comment_is_top":false,"comment_ctime":1586689629,"is_pvip":false,"replies":[{"id":78405,"content":"不会的。 第二次的调用会被阻塞，直到初始化过程完成。","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1587777430,"ip_address":"","comment_id":205623,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"感谢老师，讲得很好~\n有一个小问题想请教：\n这个单例的例子，应该是存在return的obj为未初始化的情况对吗？因为once.Do中如果执行耗时操作，那么在这个function被第二次调用时，可能初始化还未完成，但是并不会运行第二次Once中的代码，那么返回的就是未初始化的object。因此实际生产中应该不能够这样使用是吗","like_count":2,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":491532,"discussion_content":"不会的。 第二次的调用会被阻塞，直到初始化过程完成。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587777430,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1890825,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/da/09/5fc3b526.jpg","nickname":"郭泽鑫🐤","note":"","ucode":"40B9981EEC524F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":652058,"discussion_content":"sync.Once 是一个结构体，内部有一个布尔值和一个互斥锁，用于确保初始化操作只有一次","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1728179754,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":272026,"user_name":"小寞子。(≥3≤)","can_delete":false,"product_type":"c3","uid":1206545,"ip_address":"","ucode":"6D978BDCBB2862","user_header":"https://static001.geekbang.org/account/avatar/00/12/69/11/831cec7d.jpg","comment_is_top":false,"comment_ctime":1609913098,"is_pvip":false,"replies":[{"id":99521,"content":"粘贴一下你的代码看看。","user_name":"作者回复","user_name_real":"蔡超","uid":1008262,"ctime":1610891381,"ip_address":"","comment_id":272026,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"我把singleton 传值给另一个 func, 然后里面修改singleton 但是在外面却并没体现出新值。 而且地址也变了。","like_count":0,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":513124,"discussion_content":"粘贴一下你的代码看看。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1610891381,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":187804,"user_name":"张sir","can_delete":false,"product_type":"c3","uid":1209431,"ip_address":"","ucode":"52958DF6705208","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJSmAhbvPia1msvk91m5rQLTpicY85f2moFMCcAibictL3OeiaaVREadpHN2O3FwicmylwiclTUJJa1peS1Q/132","comment_is_top":false,"comment_ctime":1584246976,"is_pvip":false,"replies":[{"id":74521,"content":"可以用在类似于单例模式的场景。避免资源的反复初始化等","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1585358345,"ip_address":"","comment_id":187804,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"您好，我想问下，sync.once都用在哪些场景下，能举个例子吗","like_count":0,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":487247,"discussion_content":"可以用在类似于单例模式的场景。避免资源的反复初始化等","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585358345,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":82453,"user_name":"manatee","can_delete":false,"product_type":"c3","uid":1041112,"ip_address":"","ucode":"708D90E7A265BD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/e2/d8/f0562ede.jpg","comment_is_top":false,"comment_ctime":1554216498,"is_pvip":false,"replies":[{"id":30000,"content":"前期代码的章节划分和视频有所不一致。你要以代码章节里的子目录的名称来找一下。代码会尽快联系平台上传","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1554421875,"ip_address":"","comment_id":82453,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"麻烦老师把20课后的代码上传一下github,另外想请问下视频中fmt.Printf(&quot;%x\\n&quot;, unsafe.Pointer(obj))unsafe.Pointer的用法是怎么样的呢","like_count":0,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":445596,"discussion_content":"前期代码的章节划分和视频有所不一致。你要以代码章节里的子目录的名称来找一下。代码会尽快联系平台上传","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1554421875,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1020525,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/92/6d/becd841a.jpg","nickname":"escray","note":"","ucode":"1F4204930E47C4","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":366317,"discussion_content":"我的理解 unsafe.Pointer 就是取对象的地址\n官方文档有更详细的解释\nhttps://golang.org/pkg/unsafe/#Pointer","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618027689,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":82347,"user_name":"Vincent","can_delete":false,"product_type":"c3","uid":1437404,"ip_address":"","ucode":"EC72C58FE32369","user_header":"https://static001.geekbang.org/account/avatar/00/15/ee/dc/67838c05.jpg","comment_is_top":false,"comment_ctime":1554188726,"is_pvip":false,"replies":null,"discussion_count":6,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"就Griffin和PlaN｛Zn｝的留言，做了下实验，结果是这样：\n如果type Singleton struct {} 定义的是空结构体，那么无论用不用once.Do()，最后得到的obj地址都是一样的。当然不用once.Do()时，除了输出10个相同的地址，还会输出10次“Create obj“。\n将Singleton结构体里添加内容后，比如type Singleton struct {a bool}，再做实验，每次运行就会得到不同的地址了。","like_count":12,"discussions":[{"author":{"id":1664296,"avatar":"https://static001.geekbang.org/account/avatar/00/19/65/28/1da308e3.jpg","nickname":"Kai","note":"","ucode":"84BABA6845AA13","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":152265,"discussion_content":"https://www.golangtc.com/t/575442b8b09ecc02f7000057","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1579955735,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1210890,"avatar":"https://static001.geekbang.org/account/avatar/00/12/7a/0a/0ce5c232.jpg","nickname":"吕","note":"","ucode":"8F08E2CB81C4C3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583696,"discussion_content":"对，这个地方不能用空结构体来做测试","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660295951,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1073236,"avatar":"https://static001.geekbang.org/account/avatar/00/10/60/54/b3eb605b.jpg","nickname":"阿牛","note":"","ucode":"DC8C189FCF3289","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":232999,"discussion_content":"我的代码为什么都是一个地址呀 @Vincent","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586883306,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1614014,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/1ZcgbSZ1Q0eARic4sFq9PRO0rT55MAYUAcBVNK3dE6ficOQViblBlzUTnMJyK2bZbU3IsewnDxKD5Wtrq01DeHnWQ/132","nickname":"Geek_338030","note":"","ucode":"6F2ACB3C528BAA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":12437,"discussion_content":"刚发现singleinstance是全局变量","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1568529836,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1614014,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/1ZcgbSZ1Q0eARic4sFq9PRO0rT55MAYUAcBVNK3dE6ficOQViblBlzUTnMJyK2bZbU3IsewnDxKD5Wtrq01DeHnWQ/132","nickname":"Geek_338030","note":"","ucode":"6F2ACB3C528BAA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":12432,"discussion_content":"空结构体和不是空结构体为什么会有区别呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1568529445,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1027507,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epS4BWsMOb1Bq28XGZkwmrKiczb5QgRor6kjXRUaDqF10pqomriazaheFCZjaXe8aOPibItU4EeTep9g/132","nickname":"小欢子","note":"","ucode":"387DEBAAAF414A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1614014,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/1ZcgbSZ1Q0eARic4sFq9PRO0rT55MAYUAcBVNK3dE6ficOQViblBlzUTnMJyK2bZbU3IsewnDxKD5Wtrq01DeHnWQ/132","nickname":"Geek_338030","note":"","ucode":"6F2ACB3C528BAA","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":268218,"discussion_content":"空结构不占空间","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589731478,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":12432,"ip_address":"","group_id":0},"score":268218,"extra":""}]}]},{"had_liked":false,"id":83461,"user_name":"强哥","can_delete":false,"product_type":"c3","uid":1206726,"ip_address":"","ucode":"3B8DC780FE4EF9","user_header":"https://static001.geekbang.org/account/avatar/00/12/69/c6/513df085.jpg","comment_is_top":false,"comment_ctime":1554609302,"is_pvip":false,"replies":null,"discussion_count":5,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"这个视频里，例子中的java单例不是线程安全的，缺少volatile修饰共享变量的。需要禁止重排序。","like_count":11,"discussions":[{"author":{"id":1811277,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/a3/4d/59390ba9.jpg","nickname":"排骨","note":"","ucode":"A413CF46211E1F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":598202,"discussion_content":"java8已经可以保证new的时候线程安全不会出现指令重排的情况了","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1672665404,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1876823,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/X4ib36ADEvj76XaKD4OUY9k15KqWCAVCwibPicBxz6BBUfDrVolpYInn8zFOw3JBPtVw3L4Lkibaf2eLPemwGKzAXA/132","nickname":"Geek_427d0c","note":"","ucode":"D7A04138C4B8CB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":309576,"discussion_content":"ibm文中的观点，似乎是说在Java5以前的内存模型有你说的这个问题。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1601352196,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1876823,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/X4ib36ADEvj76XaKD4OUY9k15KqWCAVCwibPicBxz6BBUfDrVolpYInn8zFOw3JBPtVw3L4Lkibaf2eLPemwGKzAXA/132","nickname":"Geek_427d0c","note":"","ucode":"D7A04138C4B8CB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":309575,"discussion_content":"https://www.ibm.com/developerworks/java/library/j-dcl/index.html    ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1601352032,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1354850,"avatar":"https://static001.geekbang.org/account/avatar/00/14/ac/62/37912d51.jpg","nickname":"东方奇骥","note":"","ucode":"DEE7085F7E55A4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":163569,"discussion_content":"另一个设计模式专栏里，争哥讲了，高版本的Java不需要加volatile关键字是可以的，JVM做了优化。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1581085699,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1082190,"avatar":"https://static001.geekbang.org/account/avatar/00/10/83/4e/17e23752.jpg","nickname":"kkkkkk","note":"","ucode":"70E5CCF8525F08","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1354850,"avatar":"https://static001.geekbang.org/account/avatar/00/14/ac/62/37912d51.jpg","nickname":"东方奇骥","note":"","ucode":"DEE7085F7E55A4","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":306538,"discussion_content":"大部分公司还是在用Java 8，也没有都有Java 15","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600313492,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":163569,"ip_address":"","group_id":0},"score":306538,"extra":""}]}]},{"had_liked":false,"id":124418,"user_name":"虢國技醬","can_delete":false,"product_type":"c3","uid":1056807,"ip_address":"","ucode":"5A192262AA037E","user_header":"https://static001.geekbang.org/account/avatar/00/10/20/27/a6932fbe.jpg","comment_is_top":false,"comment_ctime":1565880766,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"fmt.Printf(&quot;%p\\n&quot;, obj) 也可以输出地址\n","like_count":9},{"had_liked":false,"id":80105,"user_name":"Griffin","can_delete":false,"product_type":"c3","uid":1087329,"ip_address":"","ucode":"CF766B92A65261","user_header":"https://static001.geekbang.org/account/avatar/00/10/97/61/34a0da09.jpg","comment_is_top":false,"comment_ctime":1553606147,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"感觉取地址有点问题，多次运行得到的地址每次都一样。","like_count":6},{"had_liked":false,"id":80539,"user_name":"PlaN｛Zn｝","can_delete":false,"product_type":"c3","uid":1058941,"ip_address":"","ucode":"DCE554A2B2CDC2","user_header":"https://static001.geekbang.org/account/avatar/00/10/28/7d/2681da13.jpg","comment_is_top":false,"comment_ctime":1553677917,"is_pvip":false,"replies":null,"discussion_count":3,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"把once.do注释掉之后，“Create obj”是输出了多次，但是singleInstance的地址依然都是一样的","like_count":2,"discussions":[{"author":{"id":1216486,"avatar":"https://static001.geekbang.org/account/avatar/00/12/8f/e6/932e8a90.jpg","nickname":"Jake","note":"","ucode":"DA16FA2ADA9EAC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":342846,"discussion_content":"\nfunc TestSingleton(t *testing.T) {\n\tvar wg sync.WaitGroup\n\tfor i := 0; i < 10; i++ {\n\t\twg.Add(1)\n\t\tgo func() {\n\t\t\tobj := GetSingletonObj()\n\t\t\tfmt.Printf(&#34;%x\\n&#34;, unsafe.Pointer(obj))\n\t\t\t// fmt.Printf(&#34;%p\\n&#34;, obj)\n\t\t\twg.Done()\n\t\t}()\n\t}\n\n\twg.Wait()\n}\n\ntype Singleton struct {\n}\n\nvar singleInstance *Singleton\nvar once sync.Once\n\nfunc GetSingletonObj() *Singleton {\n\t// once.Do(func() {\n\tfmt.Println(&#34;Create Obj&#34;)\n\tsingleInstance = new(Singleton)\n\t// })\n\treturn singleInstance\n}\n\n\n输出\nCreate Obj\nCreate Obj\n1255790\n1255790\nCreate Obj\nCreate Obj\n1255790\nCreate Obj\n1255790\nCreate Obj\nCreate Obj\nCreate Obj\n1255790\n1255790\n1255790\n1255790\nCreate Obj\n1255790\nCreate Obj\n1255790\n\n确实一样","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1610848580,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2640817,"avatar":"","nickname":"罗俊聪","note":"","ucode":"1B0E51A8AC8A70","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1216486,"avatar":"https://static001.geekbang.org/account/avatar/00/12/8f/e6/932e8a90.jpg","nickname":"Jake","note":"","ucode":"DA16FA2ADA9EAC","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":389416,"discussion_content":"跟你定义的结构体Singleton是空的有关，参考 @Vincent留言，如果结构体不是空的，输出的是10个不相同的地址","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1629271829,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":342846,"ip_address":"","group_id":0},"score":389416,"extra":""}]},{"author":{"id":1082190,"avatar":"https://static001.geekbang.org/account/avatar/00/10/83/4e/17e23752.jpg","nickname":"kkkkkk","note":"","ucode":"70E5CCF8525F08","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":306544,"discussion_content":"    25singleInstance_test.go:31: address:  0xc0000a61b8\nCreate single instance...\nCreate single instance...\n    25singleInstance_test.go:31: address:  0xc0000160e0\n    25singleInstance_test.go:31: address:  0xc00010c000\n    25singleInstance_test.go:31: address:  0xc0000160e1\n    25singleInstance_test.go:31: address:  0xc00010c001\n    25singleInstance_test.go:31: address:  0xc00010c002\n    25singleInstance_test.go:31: address:  0xc0000a61d8\n    25singleInstance_test.go:31: address:  0xc000192000\n    25singleInstance_test.go:31: address:  0xc000192001\n    25singleInstance_test.go:31: address:  0xc000214000\n--- PASS: TestSingleton (0.00s)\n\n\n\n并没有","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600314531,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":287559,"user_name":"escray","can_delete":false,"product_type":"c3","uid":1020525,"ip_address":"","ucode":"1F4204930E47C4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/92/6d/becd841a.jpg","comment_is_top":false,"comment_ctime":1618028227,"is_pvip":true,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"在 @Vincent 的留言及其回复里面，学到了有关的空结构体 empty struct 的概念\n\nhttps:&#47;&#47;dave.cheney.net&#47;2014&#47;03&#47;25&#47;the-empty-struct\nhttps:&#47;&#47;www.golangtc.com&#47;t&#47;575442b8b09ecc02f7000057\n\n另外关于 unsafe.Pointer\n\nhttps:&#47;&#47;golang.org&#47;pkg&#47;unsafe&#47;#Pointer\nhttps:&#47;&#47;go101.org&#47;article&#47;unsafe.html","like_count":1},{"had_liked":false,"id":353763,"user_name":"jqshang","can_delete":false,"product_type":"c3","uid":1987031,"ip_address":"广东","ucode":"7435E482BBF9A7","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKgGCPd19I41yruZyvppnQJk8I1rHGiaUj54z3ibGXQnGJicJMwhZ2vJKxpmEvpyL8Ut7YOpIZlwEndg/132","comment_is_top":false,"comment_ctime":1659755936,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"这个里面的DCL有bug，INSTANCE变量需要volatile修饰才行。","like_count":0},{"had_liked":false,"id":338921,"user_name":"涛","can_delete":false,"product_type":"c3","uid":1174992,"ip_address":"","ucode":"0839908E458151","user_header":"https://static001.geekbang.org/account/avatar/00/11/ed/d0/2f18a78b.jpg","comment_is_top":false,"comment_ctime":1647788478,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"老师的例子都非常经典，希望能出高级版本的go课程.","like_count":0},{"had_liked":false,"id":291747,"user_name":"幻影霸者","can_delete":false,"product_type":"c3","uid":1033534,"ip_address":"","ucode":"09850FD9E61A63","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c5/3e/41339003.jpg","comment_is_top":false,"comment_ctime":1620460491,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"Java单例没加volatile","like_count":0},{"had_liked":false,"id":234197,"user_name":"Damo","can_delete":false,"product_type":"c3","uid":1599197,"ip_address":"","ucode":"F332EA67F5A40C","user_header":"https://static001.geekbang.org/account/avatar/00/18/66/dd/c9f17139.jpg","comment_is_top":false,"comment_ctime":1594617471,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"type Singleton struct{}\n\nvar singleton *Singleton\nvar once sync.Once\n\nfunc GetSingleton() *Singleton {\n\tonce.Do(func() {\n\t\tfmt.Println(&quot;once&quot;)\n\t\tsingleton = new(Singleton)\n\t})\n\treturn singleton\n}\n\nfunc TestRunByOnce(t *testing.T) {\n\tvar wg sync.WaitGroup\n\tfor i := 0; i &lt; 10; i++ {\n\t\twg.Add(1)\n\t\tgo func(i int) {\n\t\t\tdefer wg.Done()\n\t\t\tsingleton := GetSingleton()\n\t\t\tfmt.Printf(&quot;%v %p \\n&quot;, i, singleton)\n\t\t}(i)\n\t}\n\twg.Wait()\n}","like_count":0},{"had_liked":false,"id":93444,"user_name":"坤","can_delete":false,"product_type":"c3","uid":1010922,"ip_address":"","ucode":"74E6838226A405","user_header":"https://static001.geekbang.org/account/avatar/00/0f/6c/ea/ce9854a5.jpg","comment_is_top":false,"comment_ctime":1557472116,"is_pvip":false,"replies":null,"discussion_count":3,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"如果只是运行一次，其他协程中应该不能创建新的实例才对。如果可以打印出多个相同地址的实例，是因为协程中共享内存吗？","like_count":0,"discussions":[{"author":{"id":1073236,"avatar":"https://static001.geekbang.org/account/avatar/00/10/60/54/b3eb605b.jpg","nickname":"阿牛","note":"","ucode":"DC8C189FCF3289","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":233004,"discussion_content":"我个人认为，MPG中的M是线程的，内存共享的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586883683,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1442588,"avatar":"https://static001.geekbang.org/account/avatar/00/16/03/1c/c9fe6738.jpg","nickname":"Kvicii.Y","note":"","ucode":"446BFA633569EA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":203974,"discussion_content":"实例是只被创建了一次，猜测应该是由于共享内存吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584107408,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1614014,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/1ZcgbSZ1Q0eARic4sFq9PRO0rT55MAYUAcBVNK3dE6ficOQViblBlzUTnMJyK2bZbU3IsewnDxKD5Wtrq01DeHnWQ/132","nickname":"Geek_338030","note":"","ucode":"6F2ACB3C528BAA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":12427,"discussion_content":"同问，望解答","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1568528932,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}