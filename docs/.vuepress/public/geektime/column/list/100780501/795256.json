{"id":795256,"title":"11ï½œå­˜å‚¨ï¼šé€šè¿‡æ•°æ®å·æŒä¹…åŒ–å­˜å‚¨æ–‡ä»¶","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯é›ªé£ã€‚</p><p>ç½‘ç»œè®¿é—®çš„é—®é¢˜è§£å†³äº†ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹å­˜å‚¨å§ã€‚åº”ç”¨ä¸­å¤„ç†æ•°æ®å­˜å‚¨ä¸»è¦æœ‰ä¸¤ä¸ªåœºæ™¯ï¼šä¸€æ˜¯å°†æ•°æ®ä¿å­˜åˆ°æ•°æ®åº“ä¸­ï¼Œé€šè¿‡ä»£ç è¿æ¥åˆ°æ•°æ®åº“æœåŠ¡ï¼Œç„¶åä½¿ç”¨æ•°æ®åº“ SQL è¯­å¥è¯»å†™æ•°æ®ï¼Œè¿™ç§æ–¹å¼ä¸éœ€è¦ K8s é›†ç¾¤æä¾›å­˜å‚¨ï¼›äºŒæ˜¯æ–‡ä»¶å­˜å‚¨ï¼Œç”±äº Pod ä¸­çš„å®¹å™¨æ¯æ¬¡é‡å¯åï¼Œéƒ½ä¼šé‡æ–°ç”Ÿæˆå®¹å™¨å†…çš„æ–‡ä»¶ç³»ç»Ÿï¼Œæ‰€ä»¥åº”ç”¨åœ¨å®¹å™¨ä¸­ä¿å­˜çš„æ–‡ä»¶éƒ½æ— æ³•åœ¨ä¸‹æ¬¡é‡å¯åä¿ç•™ã€‚ä½†æ˜¯åº”ç”¨åˆéœ€è¦æŠŠæŸäº›æ–‡ä»¶ï¼ˆå¦‚æ—¥å¿—ã€ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶ç­‰ï¼‰é•¿æœŸä¿å­˜ï¼Œä»¥ä¾¿ä¸‹æ¬¡é‡å¯å®¹å™¨åè¿˜èƒ½å†æ¬¡è®¿é—®ä½¿ç”¨ï¼Œè¿™å°±æ˜¯æ–‡ä»¶çš„æŒä¹…åŒ–å­˜å‚¨é—®é¢˜ï¼Œè¿™ç§åœºæ™¯éœ€è¦ K8s é›†ç¾¤æ¥æä¾›å­˜å‚¨æ–¹æ¡ˆã€‚</p><h2>è®¤è¯†æ•°æ®å·ï¼ˆVolumeï¼‰</h2><p>K8s ä½¿ç”¨ä¸€ä¸ªæŠ½è±¡çš„æ•°æ®å·ï¼ˆVolumeï¼‰æ¥è§£å†³æ–‡ä»¶çš„æŒä¹…åŒ–å­˜å‚¨é—®é¢˜ã€‚åœ¨ Pod ä¸­æˆ‘ä»¬å…ˆå®šä¹‰äº†ä»£è¡¨æŸç§å­˜å‚¨ç©ºé—´çš„ Volumeï¼Œç„¶ååœ¨ Pod çš„å®¹å™¨ä¸­ï¼Œé€šè¿‡æŠŠè¿™ä¸ª Volume æŒ‚è½½åˆ°å®¹å™¨ä¸­çš„æŸä¸ªç›®å½•ï¼Œå°±å¯ä»¥å»ºç«‹ä¸€ä¸ªç©ºé—´æ˜ å°„å…³ç³»ï¼Œä¹‹ååœ¨å®¹å™¨ä¸­æ“ä½œè¿™ä¸ªç›®å½•ï¼ˆä¾‹å¦‚åˆ›å»ºç›®å½•ã€è¯»å†™æ–‡ä»¶ç­‰ï¼‰ï¼Œå°±ç›¸å½“äºåœ¨è¯¥å­˜å‚¨ç©ºé—´ä¸­è¿›è¡Œæ“ä½œï¼Œæ‰€ä»¥è¿™äº›æ“ä½œç»“æœå°±è‡ªç„¶åœ°ä¿ç•™åˆ°äº†è¯¥å­˜å‚¨ç©ºé—´ä¸­ï¼Œä»è€Œå®ç°äº†æŒä¹…åŒ–å­˜å‚¨ã€‚</p><p>æ•°æ®å·æœ‰å¤šç§ç±»å‹ï¼Œä»¥ä¸‹æ˜¯å¸¸ç”¨çš„å‡ ç§ï¼š</p><ul>\n<li><strong>èŠ‚ç‚¹æœ¬åœ°å­˜å‚¨ï¼š</strong>è¿™ç±»å­˜å‚¨æ˜¯åœ¨ Pod æ‰€åœ¨çš„èŠ‚ç‚¹å®¿ä¸»æœºæœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸Šè¿›è¡Œæ–‡ä»¶å­˜å‚¨ï¼Œå¦‚ emptyDir å’Œ hostPath ç±»å‹ã€‚</li>\n<li><strong>ç½‘ç»œå…±äº«å­˜å‚¨ï¼š</strong>è¿™ç±»å­˜å‚¨ç›´æ¥ä½¿ç”¨å…±äº«çš„ç½‘ç»œå­˜å‚¨æœåŠ¡ï¼Œå¦‚ NFS å’Œ Ceph ç­‰ç±»å‹ã€‚</li>\n<li><strong>ConfigMap å’Œ Secretï¼š</strong>è¿™ä¸¤ç§èµ„æºå¯¹è±¡ä¹Ÿå¯ä»¥ä½œä¸º Volumeï¼Œä»¥é…ç½®æ–‡ä»¶çš„å½¢å¼æŒ‚è½½åˆ° Pod ä¸­ä½¿ç”¨ã€‚ä¹‹å‰å·²ç»ä»‹ç»è¿‡å®ƒä»¬ã€‚</li>\n<li><strong>persistentVolumeï¼ˆPVï¼‰å’Œ persistentVolumeClaim</strong><strong>ï¼ˆPVCï¼‰ï¼š</strong>å®ƒä»¬æ˜¯ K8s æä¾›çš„ç”¨æ¥è§£è€¦å®é™…å­˜å‚¨ç©ºé—´å’Œå­˜å‚¨éœ€æ±‚çš„èµ„æºå¯¹è±¡ã€‚PV ä»£è¡¨äº†æŸäº›å­˜å‚¨ç©ºé—´ï¼Œè€Œ PVC ä»£è¡¨ Pod å¯¹å­˜å‚¨çš„éœ€æ±‚ï¼ŒK8s ä¼šè‡ªåŠ¨æ ¹æ®å­˜å‚¨éœ€æ±‚ PVC æ¥é€‰æ‹©åˆé€‚çš„å­˜å‚¨ç©ºé—´ PV è¿›è¡Œç»‘å®šï¼Œç„¶å Pod å°±å¯ä»¥åœ¨å®¹å™¨ä¸­æŒ‚è½½ PVC ä»è€Œä½¿ç”¨ PV ä»£è¡¨çš„å­˜å‚¨ç©ºé—´ã€‚è¿™ä¸ªæœºåˆ¶å®ç°äº†å­˜å‚¨ç©ºé—´ç®¡ç†å’Œä½¿ç”¨çš„åˆ†ç¦»ã€‚</li>\n</ul><!-- [[[read_end]]] --><p>è¿™äº›æ•°æ®å·ä¸ºæˆ‘ä»¬åº”ç”¨çš„æŒä¹…åŒ–å­˜å‚¨éœ€æ±‚æä¾›äº†ä¸°å¯Œçš„é€‰æ‹©ã€‚é¦–å…ˆï¼Œæˆ‘æ¥ä»‹ç»ä¸¤ç§æœ€ç®€å•çš„èŠ‚ç‚¹æœ¬åœ°å­˜å‚¨çš„æ–¹å¼ï¼šemptyDir å’Œ hostPathã€‚</p><h2>èŠ‚ç‚¹æœ¬åœ°å­˜å‚¨</h2><h4>emptyDir å·</h4><p>emptyDir å·æ˜¯ä¸€ç§ä¸´æ—¶å­˜å‚¨ï¼Œå®ƒä¼šåœ¨ Pod æ‰€åœ¨çš„èŠ‚ç‚¹å®¿ä¸»æœºä¸Šåˆ›å»ºä¸€ä¸ªç›®å½•ï¼Œç”¨äº Pod å†…éƒ¨å®¹å™¨çš„ä¸´æ—¶æ•°æ®äº¤æ¢ã€‚å°±åƒåå­—æ„æ€ä¸€æ ·ï¼ŒemptyDir&nbsp;å·åˆ›å»ºæ—¶æ˜¯ç©ºçš„ã€‚Pod ä¸­å®¹å™¨éƒ½å¯ä»¥è¯»å†™ emptyDir&nbsp;å·ä¸­çš„æ–‡ä»¶ã€‚å½“ Pod ä»èŠ‚ç‚¹ä¸Šåˆ é™¤æ—¶ï¼ŒemptyDir å·ä¸­çš„æ•°æ®ä¹Ÿä¼šè¢«æ°¸ä¹…æ¸…ç©ºã€‚å½“ç„¶ï¼ŒPod ä¸­å®¹å™¨å´©æºƒå¹¶ä¸ä¼šå¯¼è‡´ Pod ä»èŠ‚ç‚¹ä¸Šç§»é™¤ï¼Œå› æ­¤å®¹å™¨å´©æºƒæœŸé—´&nbsp;emptyDir&nbsp;å·ä¸­çš„æ•°æ®æ˜¯å®‰å…¨çš„ã€‚æˆ‘ä¹‹å‰åœ¨ä»‹ç» Pod çš„å®¹å™¨å…±äº«å­˜å‚¨æ—¶å°±ä½¿ç”¨äº† emptyDir å·ï¼Œè¿™é‡Œå°±ä¸å†ä¸¾ä¾‹ã€‚</p><h4>hostPath å·</h4><p>hostPath å·ä¹Ÿæ˜¯ä¸€ç§èŠ‚ç‚¹æœ¬åœ°å­˜å‚¨ï¼Œå®ƒå…è®¸ä½ å°† Pod æ‰€åœ¨èŠ‚ç‚¹å®¿ä¸»æœºä¸Šçš„æ–‡ä»¶ç›®å½•æŒ‚è½½åˆ°å®¹å™¨ä¸­ä½¿ç”¨ã€‚é€šè¿‡ä½¿ç”¨ hostPath å·ï¼Œå®¹å™¨ä¸­åº”ç”¨å¯ä»¥ç›´æ¥æ“ä½œèŠ‚ç‚¹æ–‡ä»¶ç³»ç»Ÿä¸­çš„ç›®å½•å’Œæ–‡ä»¶ï¼Œå°±åƒå®ƒä»¬æ˜¯å®¹å™¨å†…éƒ¨æ–‡ä»¶ç³»ç»Ÿç›®å½•å’Œæ–‡ä»¶ä¸€æ ·ã€‚</p><p>hostPath å·é€šå¸¸ç”¨äºå®¹å™¨ä¸­çš„åº”ç”¨éœ€è¦è®¿é—®å®¿ä¸»æœºä¸Šçš„æ—¥å¿—æˆ–é…ç½®æ–‡ä»¶ã€‚hostPath å·ä¼šå­˜åœ¨ä¸€äº›å®‰å…¨é£é™©ï¼Œå› ä¸ºå®ƒå¯ä»¥å…è®¸å®¹å™¨ä¸­çš„åº”ç”¨ä¿®æ”¹å®¿ä¸»æœºä¸Šçš„æ•æ„Ÿæ–‡ä»¶ã€‚æ­¤å¤–ï¼Œä½¿ç”¨ hostPath å·ä¹Ÿä¼šå¯¼è‡´å¯¹å®¿ä¸»æœºç¯å¢ƒçš„ä¾èµ–ï¼Œä»è€Œå½±å“åº”ç”¨çš„å¯ç§»æ¤æ€§å’Œä¸€è‡´æ€§ã€‚å› æ­¤ï¼Œå¦‚æœå¿…é¡»ä½¿ç”¨ hostPath å·æ—¶ï¼Œåº”å°†å…¶ä½¿ç”¨èŒƒå›´é™åˆ¶åœ¨å¿…è¦çš„æ–‡ä»¶æˆ–ç›®å½•ï¼Œå¹¶ä¸”ä»¥åªè¯»æ–¹å¼æŒ‚è½½ï¼Œä»¥ç¡®ä¿å®‰å…¨æ€§å’Œç¨³å®šæ€§ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ª hostPath å·çš„ YAML æ–‡ä»¶ï¼ˆmy-hostpath.yamlï¼‰ç¤ºä¾‹ã€‚æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª hostPath å·ï¼Œå¹¶å°†å…¶æŒ‚è½½åˆ° busybox å®¹å™¨å†…çš„ â€œ/data/tmpâ€ ç›®å½•ã€‚è¿™æ ·ï¼Œå°±å¯ä»¥åœ¨å®¹å™¨å†…æ“ä½œèŠ‚ç‚¹å®¿ä¸»æœºä¸Šå¯¹åº”çš„ hostPath ç›®å½•ï¼ŒåŒ…æ‹¬åˆ›å»ºå­ç›®å½•ã€è¯»å†™æ–‡ä»¶ç­‰ç­‰ã€‚</p><pre><code class=\"language-yaml\"># my-hostpath.yaml&nbsp;\napiVersion: v1\nkind: Pod\nmetadata:\n&nbsp; name: my-hostpath-pod\nspec:\n&nbsp; containers:\n&nbsp; - name: busybox\n&nbsp; &nbsp; image: busybox\n    command: [\"/bin/sh\",\"-c\",\"sleep 3600\"]\n&nbsp; &nbsp; volumeMounts:\n&nbsp; &nbsp; - name: host-path-volume\n&nbsp; &nbsp; &nbsp; mountPath: /data/tmp\n    # readOnly: true    # å¦‚æœæŒ‚è½½çš„æ˜¯æ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ readOnly é™åˆ¶åªè¯»æ–‡ä»¶\n&nbsp; volumes:\n&nbsp; - name: host-path-volume\n&nbsp; &nbsp; hostPath:\n&nbsp; &nbsp; &nbsp; path: /tmp\n&nbsp; &nbsp; &nbsp; type: Directory   # è¯´æ˜æŒ‚è½½è·¯å¾„çš„æ˜¯ç›®å½•ï¼ˆDirectoryï¼‰è¿˜æ˜¯æ–‡ä»¶\n</code></pre><ul>\n<li><strong>volumeMounts</strong>ï¼šè¡¨ç¤ºå®¹å™¨ä¸­æŒ‚è½½çš„æ•°æ®å·ä¿¡æ¯ï¼ŒåŒ…å«è¦æŒ‚è½½çš„æ•°æ®å·åç§°ï¼ˆnameï¼‰å’ŒæŒ‚è½½åˆ°å®¹å™¨å†…éƒ¨æ–‡ä»¶ç³»ç»Ÿçš„è·¯å¾„ï¼ˆmountPathï¼‰ï¼Œæ³¨æ„è¿™ä¸ªå±æ€§çš„å±‚çº§æ˜¯åœ¨å®¹å™¨å†…éƒ¨ï¼Œè€Œä¸”å®ƒæ˜¯åˆ—è¡¨ï¼Œå¯ä»¥åŒæ—¶æŒ‚è½½å¤šä¸ªæ•°æ®å·ã€‚</li>\n<li><strong>volumes</strong>ï¼šè¡¨ç¤ºåˆ›å»ºæ•°æ®å·ï¼Œæ³¨æ„è¿™ä¸ªå±æ€§çš„å±‚çº§æ˜¯å’Œå®¹å™¨ç›¸åŒï¼Œè€Œä¸”å®ƒæ˜¯åˆ—è¡¨ï¼Œå¯ä»¥åŒæ—¶åˆ›å»ºå¤šä¸ªä¸åŒç§ç±»çš„æ•°æ®å·ã€‚volumes å’Œ volumeMounts æˆå¯¹å‡ºç°ï¼Œå…±åŒå®Œæˆå®¹å™¨æŒ‚è½½å­˜å‚¨ç©ºé—´çš„è¿‡ç¨‹ã€‚</li>\n</ul><p>Pod éƒ¨ç½²æˆåŠŸåï¼Œåœ¨ busybox å®¹å™¨å†…å°±å¯ä»¥ç›´æ¥ä½¿ç”¨ â€œ/data/tmpâ€ æ–‡ä»¶ç›®å½•ã€‚æˆ‘ä»¬è¿›å…¥å®¹å™¨å†…éƒ¨å¹¶åˆ›å»ºä¸€ä¸ª â€œaaa.txtâ€ æ–‡ä»¶ï¼Œç„¶åæŸ¥çœ‹ä¸€ä¸‹è¿™ä¸ª Pod è¢«è°ƒåº¦åˆ°çš„èŠ‚ç‚¹æ˜¯ k8s-worker1ã€‚</p><pre><code class=\"language-yaml\">[root@k8s-master ~]# kubectl apply -f my-hostpath.yaml&nbsp;\npod/my-hostpath-pod created\n# è¿›å…¥å®¹å™¨ busybox ä¸­æŸ¥çœ‹æŒ‚è½½çš„æ–‡ä»¶ç›®å½•\n[root@k8s-master ~]# kubectl exec -it my-hostpath-pod -c busybox -- sh\n/ # cd data/tmp\n/data/tmp # echo \"Hello hostpath!\" &gt; aaa.txt\n/data/tmp # cat aaa.txt\nHello hostpath!\n/data/tmp # exit\n[root@k8s-master ~]# kubectl get pod -o wide\nNAME&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; READY&nbsp; &nbsp;STATUS&nbsp; &nbsp; RESTARTS&nbsp; &nbsp;AGE&nbsp; &nbsp; IP&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;NODE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NOMINATED NODE&nbsp; &nbsp;READINESS GATES\nmy-hostpath-pod&nbsp; &nbsp;1/1&nbsp; &nbsp; &nbsp;Running&nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2m1s&nbsp; &nbsp;10.244.194.126&nbsp; &nbsp;k8s-worker1&nbsp; &nbsp;&lt;none&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;none&gt;\n</code></pre><p>è¿™æ—¶ï¼Œæˆ‘ä»¬è¿œç¨‹è¿æ¥åˆ° k8s-worker1 èŠ‚ç‚¹ä¸Šï¼ŒæŸ¥çœ‹ â€œ/tmpâ€ ç›®å½•ï¼Œå°±å¯ä»¥çœ‹åˆ° â€œaaa.txtâ€ æ–‡ä»¶ã€‚è¿™è¡¨æ˜äº† hostPath å·æˆåŠŸå°†å®¿ä¸»æœºçš„ç›®å½•æ˜ å°„åˆ°äº†å®¹å™¨å†…éƒ¨ã€‚</p><pre><code class=\"language-bash\">[root@k8s-worker1 ~]# cd /tmp\n[root@k8s-worker1 tmp]# cat aaa.txt\nHello hostpath!\n</code></pre><h2>ç½‘ç»œå…±äº«å­˜å‚¨</h2><p>èŠ‚ç‚¹æœ¬åœ°å­˜å‚¨çš„ä¸¤ç§æ•°æ®å·ç”¨èµ·æ¥éå¸¸ç®€å•æ–¹ä¾¿ï¼Œä½†æ˜¯æ— æ³•è§£å†³ä¸åŒèŠ‚ç‚¹çš„å¤šä¸ª Pod ä¹‹é—´å¯¹æ–‡ä»¶çš„å…±äº«åœºæ™¯ã€‚ä¾‹å¦‚ï¼Œé€šè¿‡ Deployment éƒ¨ç½²äº†å¤šä¸ª Pod åº”ç”¨ï¼Œä½ é¦–æ¬¡è®¿é—® Pod æ—¶ä¸Šä¼ äº†ä¸€ä¸ªæ–‡ä»¶ï¼Œå­˜å‚¨åœ¨è¿™ä¸ª Pod æ‰€åœ¨çš„ k8s-worker1 èŠ‚ç‚¹ä¸Šï¼Œä½†æ˜¯è¿‡ä¸€ä¼šä½ è¦è¯»æ–‡ä»¶æ—¶ï¼ŒService è´Ÿè½½å‡è¡¡æŠŠè¯·æ±‚å‘é€åˆ° k8s-worker2 èŠ‚ç‚¹ä¸Šçš„å¦ä¸€ä¸ª Pod å‰¯æœ¬ï¼Œè¿™æ—¶ä½ è‚¯å®šæ— æ³•å†è¯»å–åˆ°ä¹‹å‰ä¸Šä¼ çš„æ–‡ä»¶ã€‚æ˜¾ç„¶ï¼Œè¿™å¹¶ä¸æ˜¯æˆ‘ä»¬æœŸæœ›çš„ç»“æœã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ–‡ä»¶å…±äº«å­˜å‚¨è§£å†³æ–¹æ¡ˆã€‚ä¸‹é¢æˆ‘å°±ä»‹ç»ä¸€ä¸‹æœ€å¸¸ç”¨çš„ NFS æ–‡ä»¶å…±äº«å­˜å‚¨æœåŠ¡ã€‚</p><h4>NFS å·</h4><p>NFSï¼ˆNetwork File Systemï¼‰æ˜¯ä¸€ç§ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒå…è®¸å¤šä¸ª Pod ä¸­çš„å®¹å™¨è®¿é—®åŒä¸€ä¸ªç½‘ç»œæ–‡ä»¶ç³»ç»Ÿï¼Œæ‰€æœ‰çš„æ–‡ä»¶éƒ½å­˜å‚¨åœ¨ç½‘ç»œæ–‡ä»¶ç³»ç»ŸæœåŠ¡ç«¯çš„å…±äº«ç›®å½•ä¸­ï¼Œè€Œä¸æ˜¯åœ¨ Pod æ‰€åœ¨èŠ‚ç‚¹å®¿ä¸»æœºä¸Šï¼Œæ‰€ä»¥éå¸¸é€‚åˆéœ€è¦æ–‡ä»¶å…±äº«æˆ–æŒä¹…åŒ–å­˜å‚¨çš„åœºæ™¯ã€‚</p><p>NFS ç»„æˆåˆ†ä¸ºæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¸¤éƒ¨åˆ†ï¼Œå…¶ä¸­æœåŠ¡ç«¯è´Ÿè´£æä¾›å…±äº«æ–‡ä»¶ç›®å½•ï¼Œå®¢æˆ·ç«¯è´Ÿè´£è¿æ¥åˆ°æœåŠ¡ç«¯å¹¶ä½¿ç”¨æœåŠ¡ç«¯æä¾›çš„å…±äº«ç›®å½•ã€‚æ‰€ä»¥ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿå®ç°äº†å¤šä¸ªå®¢æˆ·ç«¯é€šè¿‡ç½‘ç»œä¼ è¾“æ¥å…±äº«æœåŠ¡ç«¯çš„æ–‡ä»¶ç›®å½•ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/08/82/08be30986147415cf3cf340e604f7182.jpg?wh=834x413\" alt=\"å›¾ç‰‡\"></p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘å¸¦ä½ æ­å»ºä¸€ä¸ª NFSã€‚é€šå¸¸ NFS æœåŠ¡ç«¯åº”è¯¥éƒ¨ç½²åœ¨ K8s é›†ç¾¤å¤–éƒ¨æœåŠ¡å™¨ä¸Šã€‚ä¸ºäº†èŠ‚çœèµ„æºï¼Œæˆ‘ä»¬é€‰æ‹©é›†ç¾¤ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ k8s-worker2 ä½œä¸º NFS æœåŠ¡ç«¯ï¼Œå°† k8s-worker1 å’Œ k8s-master ä½œä¸º NFS å®¢æˆ·ç«¯ï¼Œä»¥ä¸‹æ˜¯æ­å»ºè¿‡ç¨‹ã€‚</p><pre><code class=\"language-bash\"># 1ã€å®‰è£… NFS æœåŠ¡ï¼ŒæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯éƒ½éœ€è¦å®‰è£…ã€‚\nyum install nfs-utils\n\n# 2ã€åœ¨æœåŠ¡ç«¯åˆ›å»ºä¸€ä¸ªå…±äº«ç›®å½•ï¼Œæˆ‘è¿™é‡Œç”¨ç›®å½• \"/nfs/k8s/shared\"\n[root@k8s-worker2 ~]# mkdir -p /nfs/k8s/shared\n\n# 3ã€ç¼–è¾‘ä¿®æ”¹æœåŠ¡ç«¯ä¸Šçš„ \"/etc/exports\"&nbsp;æ–‡ä»¶ï¼Œé…ç½®ä½¿ç”¨è¿™ä¸ªå…±äº«æ–‡ä»¶ç›®å½•\n[root@k8s-worker2 ~]# vi /etc/exports\n/nfs/k8s/shared *(rw,no_root_squash)  # åœ¨é…ç½®æ–‡ä»¶ä¸­å¢åŠ ä¸€æ¡è®°å½•\n# /nfs/k8s/shared æ˜¯å…±äº«æ–‡ä»¶ç›®å½•\n# * è¡¨ç¤ºæ‰€æœ‰ IP çš„å®¢æˆ·ç«¯éƒ½å¯ä»¥è®¿é—®\n# rw è¡¨ç¤ºå¯ä»¥å®¢æˆ·ç«¯å¯ä»¥è¯»å†™ç›®å½•\n# no_root_squash è¡¨ç¤ºä¿æŒå®¢æˆ·ç«¯è®¿é—®ç›®å½•çš„ root ç”¨æˆ·æƒé™ï¼Œæ–¹ä¾¿å®¢æˆ·ç«¯æ“ä½œå…±äº«ç›®å½•\n\n# 4ã€ç”Ÿæ•ˆé…ç½®\n[root@k8s-worker2 ~]# exportfs -arv\nexporting *:/nfs/k8s/shared\n\n# 5ã€åœ¨æœåŠ¡ç«¯ä¸Šå¼€å¯ NFS æœåŠ¡\n[root@k8s-worker2 ~]# systemctl start nfs\n[root@k8s-worker2 ~]# systemctl enable nfs   # è®¾ç½®ä¸ºå¼€æœºå¯åŠ¨\nCreated symlink from /etc/systemd/system/multi-user.target.wants/nfs-server.service to /usr/lib/systemd/system/nfs-server.service.\n</code></pre><p><strong>æ³¨æ„ï¼š</strong></p><ol>\n<li>å¦‚æœä½ çš„ NFS æœåŠ¡å™¨å¼€äº†é˜²ç«å¢™æˆ–ä½¿ç”¨äº†äº‘æœåŠ¡å•†çš„é˜²ç«å¢™ï¼Œéœ€è¦å¼€æ”¾ 2049ã€111ã€635ã€892 ç«¯å£ï¼ˆTCP/UDP åè®®éƒ½éœ€è¦å¼€æ”¾ï¼‰ï¼Œå¦åˆ™ä¼šæ— æ³•è®¿é—® NFS æœåŠ¡å™¨ã€‚</li>\n<li>é›†ç¾¤çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½è¦å®‰è£… nfs-utils å·¥å…·ï¼Œä»¥ç¡®ä¿æ— è®º Pod è¢«è°ƒåº¦åˆ°å“ªä¸ªèŠ‚ç‚¹ï¼Œéƒ½å¯ä»¥é€šè¿‡ NFS å·¥å…·è¿æ¥åˆ° NFS æœåŠ¡å¹¶æ­£å¸¸ä½¿ç”¨ã€‚</li>\n</ol><p>NFS æ­å»ºå®Œæˆåï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦åœ¨ K8s é›†ç¾¤ä¸­é€šè¿‡ YAML æ–‡ä»¶ï¼ˆmy-nfs-deployment.yamlï¼‰æ¥ä½¿ç”¨ NFS å·ã€‚</p><pre><code class=\"language-yaml\"># my-nfs-deployment.yaml&nbsp;\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: my-nfs-deployment\nspec:\n  selector:\n    matchLabels:\n      app: busybox-pod\n  replicas: 3\n  template:\n    metadata:\n      labels:\n        app: busybox-pod\n    spec:\n      containers:\n      - name: busybox-c\n        image: busybox\n        command: [\"/bin/sh\",\"-c\",\"sleep 3600\"]\n        volumeMounts:\n        - name: nfs-shared-data\n          mountPath: /tmp/data\n      volumes:\n      - name: nfs-shared-data\n        nfs:\n          server: k8s-worker2   # NFS æœåŠ¡å™¨ IPã€åŸŸåæˆ–è€…ä¸»æœºå\n          path: /nfs/k8s/shared   # å…±äº«ç›®å½•\n</code></pre><p>åœ¨ YAML æ–‡ä»¶çš„ volumes å±æ€§ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªåç§°ä¸º â€œnfs-shared-dataâ€ çš„ NFS å·ï¼Œç„¶åæŠŠ NFS å…±äº«ç›®å½• â€œ/nfs/k8s/sharedâ€ æŒ‚è½½åˆ°å®¹å™¨çš„ â€œ/tmp/dataâ€ ç›®å½•ï¼Œä»è€Œå®ç° Deployment çš„å¤šä¸ª Pod å‰¯æœ¬å…±äº«è¯¥ç›®å½•ã€‚éƒ¨ç½² Deploymentï¼ŒæŸ¥çœ‹éƒ¨ç½²æˆåŠŸåçš„ä¸‰ä¸ª Pod å‰¯æœ¬ã€‚</p><pre><code class=\"language-bash\">[root@k8s-master ~]# kubectl apply -f my-nfs-deployment.yaml\ndeployment.apps/my-nfs-deployment created\n[root@k8s-master ~]# kubectl get pod  # æŸ¥çœ‹ Pod\nNAME&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;READY&nbsp; &nbsp;STATUS&nbsp; &nbsp; RESTARTS&nbsp; &nbsp; AGE\nmy-nfs-deployment-6f594bb4c5-fzt7j&nbsp; &nbsp;1/1&nbsp; &nbsp; &nbsp;Running&nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;67s\nmy-nfs-deployment-6f594bb4c5-q6dr2&nbsp; &nbsp;1/1&nbsp; &nbsp; &nbsp;Running&nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;67s\nmy-nfs-deployment-6f594bb4c5-r9smm&nbsp; &nbsp;1/1&nbsp; &nbsp; &nbsp;Running&nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;67s\n</code></pre><p>æˆ‘ä»¬è¿›å…¥å…¶ä¸­ä¸€ä¸ª Pod çš„å®¹å™¨ä¸­æ“ä½œ â€œ/tmp/dataâ€ ç›®å½•ï¼Œåˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œç„¶åè¿›å…¥åˆ°å…¶ä»–å®¹å™¨ä¸­æŸ¥çœ‹è¯¥æ–‡ä»¶ï¼Œä»ç»“æœä¸­å¯ä»¥çœ‹å‡ºï¼Œä¸‰ä¸ª Pod çš„å®¹å™¨ç¡®å®éƒ½å¯ä»¥å…±äº«è¯¥ç›®å½•ã€‚</p><pre><code class=\"language-bash\">[root@k8s-master ~]# kubectl exec -it my-nfs-deployment-6f594bb4c5-fzt7j -c busybox-c -- sh\n/ # cd /tmp/data/\n/tmp/data # echo \"Hello NFS!\" &gt; aaa.txt  # å†™å…¥æ–‡ä»¶åˆ°NFSç›®å½•\n/tmp/data # exit\n[root@k8s-master ~]# kubectl exec -it my-nfs-deployment-6f594bb4c5-q6dr2 -c busybox-c -- sh\n/ # cd /tmp/data/\n/tmp/data # cat aaa.txt  # è¯»å–å…±äº«æ–‡ä»¶\nHello NFS!\n</code></pre><p>å³ä½¿åˆ é™¤äº† Deployment å’Œ Podï¼ŒNFS æœåŠ¡ç«¯å…±äº«ç›®å½•ä¸­çš„æ–‡ä»¶ä¾æ—§å­˜åœ¨ï¼Œä¸ä¼šéš Pod åˆ é™¤è€Œæ¶ˆå¤±ã€‚</p><pre><code class=\"language-bash\">[root@k8s-master ~]# kubectl delete -f my-nfs-deployment.yaml\ndeployment.apps \"my-nfs-deployment\" deleted\n</code></pre><p>æŸ¥çœ‹ k8s-worker2 æœåŠ¡ç«¯ä¸Šçš„å…±äº«ç›®å½•ï¼Œä»ç„¶å¯ä»¥çœ‹åˆ°åœ¨å®¹å™¨ä¸­åˆ›å»ºçš„æ–‡ä»¶ã€‚</p><pre><code class=\"language-bash\">[root@k8s-worker2 ~]# cd /nfs/k8s/shared/\n[root@k8s-worker2 shared]# cat aaa.txt\nHello NFS!\n</code></pre><h2>PV ä¸ PVC</h2><p>ä½¿ç”¨ NFS å…±äº«å­˜å‚¨è™½ç„¶æ–¹ä¾¿ï¼Œä½†è‹¥å„åº”ç”¨çš„ Pod æ— é™åˆ¶åœ°è¯»å†™å­˜å‚¨èµ„æºï¼Œé•¿æœŸä¸‹æ¥å¯èƒ½å¯¼è‡´ç£ç›˜ç®¡ç†æ··ä¹±ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒK8s é›†ç¾¤å¼•å…¥äº† PV å’Œ PVC èµ„æºå¯¹è±¡ï¼Œé¿å… Pod ç›´æ¥æŒ‚è½½å„ç§å­˜å‚¨ç©ºé—´ï¼Œä»è€Œå¯¹å­˜å‚¨èµ„æºçš„ç®¡ç†å’Œä½¿ç”¨åšäº†è§£è€¦éš”ç¦»ã€‚</p><p>PVï¼ˆPersistentVolumeï¼ŒæŒä¹…å·ï¼‰ä¸»è¦ç”¨äºç®¡ç†å­˜å‚¨èµ„æºï¼ŒPV ä¸­æŒ‡å®šäº†å­˜å‚¨ç±»å‹ã€å­˜å‚¨ç©ºé—´å¤§å°å’Œè¯»å†™æ¨¡å¼ç­‰ä¿¡æ¯ã€‚PV å¯ä»¥ç”±è¿ç»´äººå‘˜é¢„å…ˆåˆ†é…ï¼Œæˆ–è€…é€šè¿‡å­˜å‚¨ç±»ï¼ˆStorage Classï¼‰åŠ¨æ€åˆ†é…ã€‚PV æ”¯æŒçš„å­˜å‚¨èµ„æºç±»å‹ä»¥æ’ä»¶çš„å½¢å¼å®ç°ï¼ŒK8s é»˜è®¤æ”¯æŒ HostPath å·ã€NFS å·ã€Local&nbsp;å·ï¼ˆèŠ‚ç‚¹ä¸ŠæŒ‚è½½çš„æœ¬åœ°å­˜å‚¨è®¾å¤‡ï¼‰ç­‰ï¼Œä½ ä¹Ÿå¯ä»¥å®‰è£… CSI é©±åŠ¨æ’ä»¶ä»è€Œæ”¯æŒæ›´å¤šçš„å­˜å‚¨èµ„æºç±»å‹ã€‚</p><p>PVCï¼ˆPersistentVolumeClaimï¼ŒæŒä¹…å·å£°æ˜ï¼‰è¡¨è¾¾äº† Pod å¯¹å­˜å‚¨èµ„æºçš„éœ€æ±‚ï¼Œä¾‹å¦‚å­˜å‚¨ç©ºé—´å¤§å°ã€è¯»å†™æ¨¡å¼ç­‰ã€‚å½“ Pod éœ€è¦å­˜å‚¨ç©ºé—´æ—¶ï¼Œå°±å¯ä»¥åˆ›å»ºå¹¶æŒ‚è½½  PVCï¼Œæ­¤æ—¶ K8s ä¼šç»™è¿™ä¸ª PVC è‡ªåŠ¨é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„ PV è¿›è¡Œç»‘å®šã€‚ä¸€æ—¦ç»‘å®šæˆåŠŸï¼ŒPod å°±å¯ä»¥ä½¿ç”¨ PV æŒ‡å®šçš„å­˜å‚¨èµ„æºäº†ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒPod ä¸èƒ½ç›´æ¥æŒ‚è½½ PVï¼Œè€Œæ˜¯é€šè¿‡ PVC æ¥é—´æ¥ä½¿ç”¨ PV çš„å­˜å‚¨ç©ºé—´ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/07/e1/07280c5f5928392131afbd39f7c75ae1.jpg?wh=902x708\" alt=\"å›¾ç‰‡\"></p><p>å¦‚å›¾æ‰€ç¤ºï¼ŒPV + PVC è¿™ç§æ¨¡å¼ç¬¦åˆç ”å‘å’Œè¿ç»´å›¢é˜Ÿçš„ç»„ç»‡æ¶æ„éœ€æ±‚ï¼Œå…¶ä¸­ PV ç”±è¿ç»´äººå‘˜é¢„å…ˆåˆ†é…å¹¶ç®¡ç†ï¼Œè€Œ Pod çš„å®é™…å­˜å‚¨ç©ºé—´æ˜¯é€šè¿‡ PVC æ¥ç”³è¯·ï¼Œæ‰€ä»¥ PVC ç”±ç ”å‘äººå‘˜ç»´æŠ¤ï¼Œä»è€Œç¡®ä¿äº†ä¸¤ä¸ªå›¢é˜Ÿåˆ†å·¥å’ŒèŒè´£çš„æ˜ç¡®æ€§ï¼Œæé«˜äº†å­˜å‚¨èµ„æºç®¡ç†çš„æ•ˆç‡å’Œçµæ´»æ€§ã€‚</p><h2>éƒ¨ç½² PV ä¸ PVC</h2><p>ä¸‹é¢æˆ‘ä»¬åŠ¨æ‰‹å®éªŒä¸€ä¸‹ï¼Œåˆ›å»ºä¸€ä¸ª PV å’Œ PVCï¼Œç„¶ååœ¨ Pod ä¸­æŒ‚è½½ PVC æ¥ä½¿ç”¨å­˜å‚¨ç©ºé—´ã€‚</p><h4>éƒ¨ç½² PV</h4><p>PV çš„éƒ¨ç½²ä¹Ÿæ˜¯é€šè¿‡ YAML æ–‡ä»¶ï¼ˆmy-pv.yamlï¼‰æ¥å®ç°çš„ã€‚</p><pre><code class=\"language-yaml\"># my-pv.yaml&nbsp;\napiVersion: v1\nkind: PersistentVolume\nmetadata:\n&nbsp; name: my-pv-100m # è‡ªå®šä¹‰PVåå­—\nspec:\n&nbsp; capacity:\n&nbsp; &nbsp; storage: 100M # å®šä¹‰è¿™ä¸ªPVçš„å­˜å‚¨å¤§å°\n&nbsp; accessModes:\n&nbsp; &nbsp; - ReadWriteMany # è®¿é—®æ¨¡å¼\n  persistentVolumeReclaimPolicy: Retain  # é»˜è®¤Retain\n&nbsp; nfs:\n    server: k8s-worker2 # æŒ‡å®šNFSä¸»æœºçš„IPåœ°å€æˆ–è€…ä¸»æœºå\n&nbsp; &nbsp; path: /nfs/k8s/shared # ç»‘å®šä¸»æœºçš„çš„è·¯å¾„\n</code></pre><ul>\n<li><strong>capacity</strong>ï¼šå®šä¹‰ PV çš„å­˜å‚¨ç©ºé—´çš„å®¹é‡å¤§å°ã€‚</li>\n<li><strong>accessModesï¼š</strong>è®¾ç½® PV çš„è®¿é—®æ¨¡å¼ï¼ŒæŒ‡å®šåº”ç”¨ä½¿ç”¨ PV æ—¶å¯¹å­˜å‚¨èµ„æºçš„è®¿é—®æƒé™ï¼Œè®¿é—®æƒé™åŒ…æ‹¬ä¸‹é¢å‡ ç§æ–¹å¼ï¼š\n<ul>\n<li>ReadWriteOnceï¼ˆRWOï¼‰ï¼šè¯»å†™æƒé™ï¼Œä½†æ˜¯åªèƒ½è¢«å•ä¸ªèŠ‚ç‚¹æŒ‚è½½ã€‚</li>\n<li>ReadOnlyManyï¼ˆROXï¼‰ï¼šåªè¯»æƒé™ï¼Œå¯ä»¥è¢«å¤šä¸ªèŠ‚ç‚¹æŒ‚è½½ã€‚</li>\n<li>ReadWriteManyï¼ˆRWXï¼‰ï¼šè¯»å†™æƒé™ï¼Œå¯ä»¥è¢«å¤šä¸ªèŠ‚ç‚¹æŒ‚è½½ã€‚</li>\n</ul>\n</li>\n<li><strong>persistentVolumeReclaimPolicy</strong>ï¼šæŒ‡å®š PV å›æ”¶ç­–ç•¥ï¼Œé»˜è®¤ä¸º Retainï¼Œä¸‹ä¸€è¯¾ä¼šå†è¯¦ç»†ä»‹ç» PV çš„å›æ”¶ç­–ç•¥ã€‚</li>\n</ul><p>éƒ¨ç½² PVï¼Œç„¶åæŸ¥çœ‹ PV çš„çŠ¶æ€ã€‚</p><pre><code class=\"language-bash\">[root@k8s-master ~]# kubectl apply -f my-pv.yaml&nbsp;\npersistentvolume/my-pv-100m created\n[root@k8s-master ~]# kubectl get pv\nNAME&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;CAPACITY&nbsp; &nbsp;ACCESS MODES&nbsp; &nbsp;RECLAIM POLICY&nbsp; &nbsp;STATUS&nbsp; &nbsp; &nbsp; CLAIM&nbsp; &nbsp;STORAGECLASS&nbsp; &nbsp;REASON&nbsp; &nbsp;AGE\nmy-pv-100m&nbsp; &nbsp;100M&nbsp; &nbsp; &nbsp; &nbsp;RWX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Retain&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Available&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;7s\n</code></pre><p>åœ¨è¿”å›ç»“æœä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°å·²ç»æˆåŠŸéƒ¨ç½²äº† PVï¼Œå…¶ä¸­ STATUS çŠ¶æ€ä¸º Available ï¼Œè¡¨ç¤ºå¯ä»¥ä½¿ç”¨ã€‚</p><h4>éƒ¨ç½² PVC</h4><p>ç¼–å†™ä¸€ä¸ª PVC çš„ YAML æ–‡ä»¶ï¼ˆmy-pvc.yamlï¼‰ï¼Œç”³è¯·ä¸€ä¸ª 100M å®¹é‡çš„å¯ä»¥è¢«å¤šä¸ª Pod æŒ‚è½½çš„å­˜å‚¨ç©ºé—´ã€‚</p><pre><code class=\"language-yaml\"># my-pvc.yaml\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: my-pvc-100m # è‡ªå®šä¹‰pvcåå­—\nspec:\n  accessModes:\n    - ReadWriteMany  # è®¿é—®æ¨¡å¼\n  resources:\n    requests:\n      storage: 100M # å®šä¹‰è¦ç”³è¯·çš„ç©ºé—´å¤§å°\n</code></pre><p>éƒ¨ç½² PVCï¼Œç„¶åæŸ¥çœ‹ PVC çš„çŠ¶æ€ã€‚</p><pre><code class=\"language-bash\">[root@k8s-master ~]# kubectl apply -f my-pvc.yaml&nbsp;\npersistentvolumeclaim/my-pvc-100m created\n[root@k8s-master ~]# kubectl get pvc\nNAME&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; STATUS&nbsp; &nbsp;VOLUME&nbsp; &nbsp; &nbsp; &nbsp;CAPACITY&nbsp; &nbsp;ACCESS MODES&nbsp; &nbsp;STORAGECLASS&nbsp; &nbsp;AGE\nmy-pvc-100m&nbsp; &nbsp;Bound&nbsp; &nbsp; my-pv-100m&nbsp; &nbsp;100M&nbsp; &nbsp; &nbsp; &nbsp;RWX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;9s\n</code></pre><p>å¯ä»¥çœ‹å‡ºï¼Œéƒ¨ç½² PVC çš„æ—¶å€™ï¼ŒK8s ä¼šè‡ªåŠ¨å¯»æ‰¾å¹¶ç»‘å®šæ»¡è¶³æ¡ä»¶çš„ PVã€‚ç›®å‰ï¼ŒSTATUS çŠ¶æ€æ˜¾ç¤ºä¸º Boundï¼ˆå·²ç»‘å®šï¼‰ï¼ŒVOLUME æ˜¾ç¤ºå·²ç»‘å®šåä¸º â€œmy-pv-100mâ€ çš„ PV å·ï¼Œè¿™ä¸ªå°±æ˜¯ä¸Šé¢éƒ¨ç½²å¥½çš„ PVã€‚æ­¤æ—¶ï¼Œè¿™ä¸ª PVC å°±å¯ä»¥è¢« Pod æŒ‚è½½å¹¶ä½¿ç”¨äº†ã€‚</p><h4>æŒ‚è½½ PVC</h4><p>æˆ‘ä»¬é€šè¿‡ YAML æ–‡ä»¶ï¼ˆmy-pvc-deployment.yamlï¼‰éƒ¨ç½²ä¸€ä¸ª Deploymentï¼Œå®ƒçš„ Pod ä¸­çš„å®¹å™¨ä¼šæŒ‚è½½å·²ç»éƒ¨ç½²å¥½çš„ PVCã€‚</p><pre><code class=\"language-yaml\"># my-pvc-deployment.yaml&nbsp;\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: my-pvc-deployment\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: pvc-busybox-pod\n  template:\n    metadata:\n      labels:\n        app: pvc-busybox-pod\n    spec:\n      containers:\n      - name: busybox-c\n        image: busybox\n        command: [\"/bin/sh\",\"-c\",\"sleep 3600\"]\n        volumeMounts:\n        - name: pvc-shared-data\n          mountPath: /tmp/data\n      volumes:\n        - name: pvc-shared-data\n          persistentVolumeClaim:\n            claimName: my-pvc-100m  # éƒ¨ç½²å¥½çš„PVC\n</code></pre><p>éƒ¨ç½²å¥½ Deployment åï¼Œæˆ‘ä»¬å¯ä»¥è¿›å…¥åˆ°ä»»æ„ Pod çš„å®¹å™¨ï¼Œå°±åƒä¸Šé¢ Pod ç›´æ¥æŒ‚è½½ NFS å·çš„ç¤ºä¾‹ä¸€æ ·ï¼Œé€šè¿‡æ“ä½œ â€œ/tmp/dataâ€ ç›®å½•æ¥ä½¿ç”¨æŒ‚è½½çš„å…±äº«ç©ºé—´ã€‚</p><pre><code class=\"language-bash\">[root@k8s-master ~]# kubectl apply -f my-pvc-deployment.yaml\ndeployment.apps/my-pvc-deployment created\n</code></pre><h2><strong>å°ç»“</strong></h2><p>ä»Šå¤©ï¼Œæˆ‘ä»‹ç»äº† K8s ä¸­çš„æ–‡ä»¶æŒä¹…åŒ–å­˜å‚¨æ–¹å¼ï¼šæŒ‚è½½æ•°æ®å· Volumeã€‚åœ¨ Pod ä¸­å…ˆå®šä¹‰ä»£è¡¨æŸç§å­˜å‚¨ç©ºé—´çš„ Volumeï¼Œç„¶ååœ¨ Pod çš„å®¹å™¨ä¸­ï¼Œé€šè¿‡æŠŠè¿™ä¸ª Volume æŒ‚è½½åˆ°å®¹å™¨çš„æŸä¸ªç›®å½•ï¼Œä»è€Œåœ¨å®¹å™¨ä¸­ä½¿ç”¨è¿™ä¸ªç›®å½•ï¼Œå®ç°äº†æŒä¹…åŒ–å­˜å‚¨ã€‚</p><p>æ•°æ®å·ä¸»è¦æœ‰èŠ‚ç‚¹æœ¬åœ°å­˜å‚¨ã€ç½‘ç»œå…±äº«å­˜å‚¨ã€ConfigMap å’Œ Secret èµ„æºå¯¹è±¡ï¼Œä»¥åŠ PV å’Œ PVCã€‚æ¥ç€æˆ‘å¸¦ä½ æ­å»ºäº†ä¸€ä¸ª NFS ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿå¹¶åˆ›å»ºäº†å…±äº«ç›®å½•ï¼Œç„¶åéƒ¨ç½²äº†å¤šä¸ª Pod å‰¯æœ¬çš„ Deploymentï¼Œè¿™äº› Pod é€šè¿‡æŒ‚è½½ NFS çš„å…±äº«ç›®å½•å®ç°äº†æ–‡ä»¶çš„å…±äº«å’ŒæŒä¹…åŒ–å­˜å‚¨ã€‚</p><p>ä¹‹åï¼Œæˆ‘ä»¬è¯¦ç»†è®¤è¯†äº† PV å’Œ PVC ä¸¤ç§èµ„æºå¯¹è±¡ã€‚PVï¼ˆPersistentVolumeï¼ŒæŒä¹…å·ï¼‰æ˜¯é¢„å…ˆé…ç½®çš„å­˜å‚¨èµ„æºï¼ŒPVCï¼ˆPersistentVolumeClaimï¼ŒæŒä¹…å·å£°æ˜ï¼‰æ˜¯åº”ç”¨å¯¹å­˜å‚¨èµ„æºçš„éœ€æ±‚ï¼Œå½“ Pod éœ€è¦å­˜å‚¨ç©ºé—´æ—¶ï¼Œå°±å¯ä»¥åˆ›å»ºå¹¶åŠ è½½ PVCï¼Œæ­¤æ—¶ K8s ä¼šç»™è¿™ä¸ª PVC è‡ªåŠ¨é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„ PV è¿›è¡Œç»‘å®šã€‚ä¸€æ—¦ç»‘å®šæˆåŠŸï¼ŒPod å°±å¯ä»¥ä½¿ç”¨ PV æä¾›çš„å­˜å‚¨èµ„æºäº†ã€‚</p><p>æœ€åé€šè¿‡ä¸€ä¸ªå®éªŒï¼Œæˆ‘å¸¦ä½ äº†è§£äº† PV å’Œ PVC çš„ YAML æ–‡ä»¶åŠä½¿ç”¨æ–¹å¼ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>è¿™å°±æ˜¯ä»Šå¤©çš„å…¨éƒ¨å†…å®¹ï¼Œåœ¨ CKA ä¸­ä¹Ÿä¼šè€ƒåˆ°ç›¸å…³çš„çŸ¥è¯†ç‚¹ã€‚æˆ‘ç»™ä½ ç•™ä¸€é“ç»ƒä¹ é¢˜ã€‚</p><ul>\n<li>åˆ›å»ºä¸€ä¸ª hostPath ç±»å‹çš„ PVï¼Œå­˜å‚¨ç©ºé—´ 10Mï¼Œè¯»å†™æ¨¡å¼ä¸º ReadWriteManyï¼Œå®¿ä¸»æœºç›®å½•ä¸º â€œ/host/dataâ€ã€‚</li>\n<li>åˆ›å»ºä¸€ä¸ª Pod å¹¶æŒ‚è½½ä¸€ä¸ª PVCï¼ŒPVC çš„å­˜å‚¨ç©ºé—´è¦æ±‚ 20Mï¼Œè¯»å†™æ¨¡å¼ä¸º ReadWriteManyï¼ŒPod å®¹å™¨æŒ‚è½½ç›®å½•ä¸º â€œ/tmpâ€ã€‚</li>\n</ul><p>åŠ¨æ‰‹å®è·µä¸€ä¸‹ï¼Œçœ‹çœ‹ Pod æ˜¯å¦å¯ä»¥æˆåŠŸä½¿ç”¨ PV çš„å­˜å‚¨ç©ºé—´ï¼Œå¦‚æœä¸è¡Œï¼Œéœ€è¦æ€æ ·ä¿®æ”¹æ‰èƒ½æˆåŠŸï¼Ÿç›¸ä¿¡ç»è¿‡åŠ¨æ‰‹å®è·µï¼Œä¼šè®©ä½ å¯¹çŸ¥è¯†çš„ç†è§£æ›´åŠ æ·±åˆ»ã€‚</p>","neighbors":{"left":{"article_title":"10ï½œç½‘ç»œç¯‡ï¼šé€šè¿‡Ingressæä¾›URLè®¿é—®","id":794715},"right":{"article_title":"12ï½œå­˜å‚¨ï¼šPVçš„ç”Ÿå‘½å‘¨æœŸä¸åŠ¨æ€ä¾›åº”","id":795522}},"comments":[{"had_liked":false,"id":393160,"user_name":"Y","can_delete":false,"product_type":"c1","uid":1179432,"ip_address":"å¹¿ä¸œ","ucode":"952AA9B2CD91CE","user_header":"https://static001.geekbang.org/account/avatar/00/11/ff/28/040f6f01.jpg","comment_is_top":false,"comment_ctime":1723022502,"is_pvip":true,"replies":[{"id":142833,"content":"ğŸ‘ğŸ»","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1209006,"ctime":1723442147,"ip_address":"åŒ—äº¬","comment_id":393160,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100780501,"comment_content":"ç¬¬ä¸€é¢˜ï¼š\n# my-pv-hostpath.yaml \napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: my-pv-hostpath-10m # è‡ªå®šä¹‰PVåå­—\nspec:\n  capacity:\n    storage: 10M # å®šä¹‰è¿™ä¸ªPVçš„å­˜å‚¨å¤§å°\n  accessModes:\n    - ReadWriteMany # è®¿é—®æ¨¡å¼\n  persistentVolumeReclaimPolicy: Retain  # é»˜è®¤Retain\n  hostPath:\n    path: &#47;host&#47;data \n\nç¬¬äºŒé¢˜ï¼š\n\n# my-pv.yaml \napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: my-pv-20m # è‡ªå®šä¹‰PVåå­—\nspec:\n  capacity:\n    storage: 20M # å®šä¹‰è¿™ä¸ªPVçš„å­˜å‚¨å¤§å°\n  accessModes:\n    - ReadWriteMany # è®¿é—®æ¨¡å¼\n  persistentVolumeReclaimPolicy: Retain  # é»˜è®¤Retain\n  nfs:\n    server: k8s-worker2 # æŒ‡å®šNFSä¸»æœºçš„IPåœ°å€æˆ–è€…ä¸»æœºå\n    path: &#47;nfs&#47;k8s&#47;shared # ç»‘å®šä¸»æœºçš„çš„è·¯å¾„\n\n# my-pvc-20m.yaml\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: my-pvc-20m # è‡ªå®šä¹‰pvcåå­—\nspec:\n  accessModes:\n    - ReadWriteMany  # è®¿é—®æ¨¡å¼\n  resources:\n    requests:\n      storage: 20M # å®šä¹‰è¦ç”³è¯·çš„ç©ºé—´å¤§å°\n\n# my-pvc-deployment.yaml \napiVersion: apps&#47;v1\nkind: Deployment\nmetadata:\n  name: my-pvc-deployment-20m\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: pvc-busybox-pod\n  template:\n    metadata:\n      labels:\n        app: pvc-busybox-pod\n    spec:\n      containers:\n      - name: busybox-c\n        image: swr.cn-north-4.myhuaweicloud.com&#47;ddn-k8s&#47;docker.io&#47;library&#47;busybox:1.28\n        command: [&quot;&#47;bin&#47;sh&quot;,&quot;-c&quot;,&quot;sleep 3600&quot;]\n        volumeMounts:\n        - name: pvc-shared-data\n          mountPath: &#47;tmp&#47;data\n      volumes:\n        - name: pvc-shared-data\n          persistentVolumeClaim:\n            claimName: my-pvc-20m  # éƒ¨ç½²å¥½çš„PVC","like_count":0,"discussions":[{"author":{"id":1209006,"avatar":"https://static001.geekbang.org/account/avatar/00/12/72/ae/cef8a848.jpg","nickname":"é›ªé£","note":"","ucode":"36BDFD1E35E9DA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":649461,"discussion_content":"ğŸ‘ğŸ»","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1723442148,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":392729,"user_name":"å¥”è·‘çš„é˜¿é£","can_delete":false,"product_type":"c1","uid":1135314,"ip_address":"æµ™æ±Ÿ","ucode":"E4850EC5BFBBC3","user_header":"https://static001.geekbang.org/account/avatar/00/11/52/d2/a0a800e9.jpg","comment_is_top":false,"comment_ctime":1721636627,"is_pvip":false,"replies":[{"id":142706,"content":"æ²¡é—®é¢˜ğŸ‘ğŸ»ï¼Œä½ è¿è¡Œä¸€ä¸‹è¯•è¯•ï¼Œè¿™ä¸ªPVCå¯ä»¥æˆåŠŸç»‘å®šè¿™ä¸ªPVå—ï¼Ÿ","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1209006,"ctime":1721786163,"ip_address":"åŒ—äº¬","comment_id":392729,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100780501,"comment_content":"æ¯”è‘«èŠ¦ç”»ç“¢ã€‚\nç¬¬ä¸€é¢˜\n# my-pv-10m.yaml \napiVersion: v1\nkind: hostPath\nmetadata:\n  name: my-pv-10m \nspec:\n  capacity:\n    storage: 10M \n  accessModes:\n    - ReadWriteMany \n  persistentVolumeReclaimPolicy: Retain  # é»˜è®¤Retain\nvolumes:  \n- name: host-path-volume    \n\thostPath:      \n\tpath: &#47;host&#47;data      \n\ttype: Directory \n\t  \nç¬¬äºŒé¢˜\t  \n# my-pvc-20m.yaml\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: my-pvc-20m # è‡ªå®šä¹‰pvcåå­—\nspec:\n  accessModes:\n    - ReadWriteMany  # è®¿é—®æ¨¡å¼\n  resources:\n    requests:\n      storage: 20M # å®šä¹‰è¦ç”³è¯·çš„ç©ºé—´å¤§å°\n\n\n\n# my-pvc-deployment-20m.yaml \napiVersion: apps&#47;v1\nkind: Deployment\nmetadata:\n  name: my-pvc-deployment-20m\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: pvc-busybox-pod\n  template:\n    metadata:\n      labels:\n        app: pvc-busybox-pod\n    spec:\n      containers:\n      - name: busybox-c\n        image: busybox\n        command: [&quot;&#47;bin&#47;sh&quot;,&quot;-c&quot;,&quot;sleep 3600&quot;]\n        volumeMounts:\n        - name: pvc-shared-data\n          mountPath: &#47;tmp\n      volumes:\n        - name: pvc-shared-data\n          persistentVolumeClaim:\n            claimName: my-pvc-20m  # éƒ¨ç½²å¥½çš„PVC","like_count":0,"discussions":[{"author":{"id":1209006,"avatar":"https://static001.geekbang.org/account/avatar/00/12/72/ae/cef8a848.jpg","nickname":"é›ªé£","note":"","ucode":"36BDFD1E35E9DA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":648548,"discussion_content":"æ²¡é—®é¢˜ğŸ‘ğŸ»ï¼Œä½ è¿è¡Œä¸€ä¸‹è¯•è¯•ï¼Œè¿™ä¸ªPVCå¯ä»¥æˆåŠŸç»‘å®šè¿™ä¸ªPVå—ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1721786163,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":396627,"user_name":"æ‘©ç¾¯","can_delete":false,"product_type":"c1","uid":1111167,"ip_address":"æ²³å—","ucode":"15811EA603312D","user_header":"https://static001.geekbang.org/account/avatar/00/10/f4/7f/c3d6b4bc.jpg","comment_is_top":false,"comment_ctime":1735115186,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100780501,"comment_content":" ReadWriteOnceï¼ˆRWOï¼‰ï¼šè¯»å†™æƒé™ï¼Œä½†æ˜¯åªèƒ½è¢«å•ä¸ªèŠ‚ç‚¹æŒ‚è½½\nPVC  å’Œ  PV  éƒ½æœ‰è¿™ä¸ªå±æ€§ã€‚è¿™é‡Œçš„èŠ‚ç‚¹æŒ‡çš„æ˜¯ k8s çš„èŠ‚ç‚¹å—ï¼ŸåŒä¸€ä¸ªèŠ‚ç‚¹çš„å¤šä¸ªä¸åŒpodå¯ä»¥è¯»å†™åŒä¸€ä¸ªpvï¼Ÿè¿™ç§æƒ…å†µä¸‹ï¼Œè¿˜æ˜¯å®¹æ˜“å‡ºç° nfs ç›¸åŒçš„é—®é¢˜å§ï¼Ÿ","like_count":0},{"had_liked":false,"id":396625,"user_name":"æ‘©ç¾¯","can_delete":false,"product_type":"c1","uid":1111167,"ip_address":"æ²³å—","ucode":"15811EA603312D","user_header":"https://static001.geekbang.org/account/avatar/00/10/f4/7f/c3d6b4bc.jpg","comment_is_top":false,"comment_ctime":1735114972,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100780501,"comment_content":"ReadWriteOnceï¼ˆRWOï¼‰ï¼šè¯»å†™æƒé™ï¼Œä½†æ˜¯åªèƒ½è¢«å•ä¸ªèŠ‚ç‚¹æŒ‚è½½","like_count":0}]}