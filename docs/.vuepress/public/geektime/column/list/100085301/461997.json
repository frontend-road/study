{"id":461997,"title":"41ï½œé˜¶æ®µå®æ“ï¼ˆ6ï¼‰ï¼šæ„å»ºä¸€ä¸ªç®€å•çš„KV server-å¼‚æ­¥å¤„ç†","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯é™ˆå¤©ã€‚</p><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»ä¸€èµ·å®Œæˆäº†ä¸€ä¸ªç›¸å¯¹å®Œå–„çš„ KV serverã€‚è¿˜è®°å¾—æ˜¯æ€ä¹ˆä¸€æ­¥æ­¥æ„å»ºè¿™ä¸ªæœåŠ¡çš„ä¹ˆï¼Ÿ</p><p>åŸºç¡€ç¯‡å­¦å®Œï¼Œæˆ‘ä»¬æ­å¥½äº†KV server çš„åŸºç¡€åŠŸèƒ½ï¼ˆ<a href=\"https://time.geekbang.org/column/article/425001\">21è®²</a>ã€<a href=\"https://time.geekbang.org/column/article/425005\">22è®²</a>ï¼‰ï¼Œæ„é€ äº†å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨é—´äº¤äº’çš„ protobufï¼Œç„¶åè®¾è®¡äº† CommandService trait å’Œ Storage traitï¼Œåˆ†åˆ«å¤„ç†å®¢æˆ·ç«¯å‘½ä»¤å’Œå­˜å‚¨ã€‚</p><p>åœ¨è¿›é˜¶ç¯‡æŒæ¡äº†traitçš„å®æˆ˜ä½¿ç”¨æŠ€å·§ä¹‹åï¼Œï¼ˆ<a href=\"https://time.geekbang.org/column/article/429666\">26è®²</a>ï¼‰æˆ‘ä»¬è¿›ä¸€æ­¥æ„é€ äº† Service æ•°æ®ç»“æ„ï¼Œæ¥æ”¶ CommandRequestï¼Œæ ¹æ®å…¶ç±»å‹è°ƒç”¨ç›¸åº”çš„ CommandService å¤„ç†ï¼Œå¹¶åšåˆé€‚çš„äº‹ä»¶é€šçŸ¥ï¼Œæœ€åè¿”å› CommandResponseã€‚</p><p><strong>ä½†æ‰€æœ‰è¿™ä¸€åˆ‡éƒ½å‘ç”Ÿåœ¨åŒæ­¥çš„ä¸–ç•Œ</strong>ï¼šä¸ç®¡æ•°æ®æ˜¯æ€ä¹ˆè·å¾—çš„ï¼Œæ•°æ®å·²ç»åœ¨é‚£é‡Œï¼Œæˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯æŠŠä¸€ç§æ•°æ®ç±»å‹è½¬æ¢æˆå¦ä¸€ç§æ•°æ®ç±»å‹çš„è¿ç®—è€Œå·²ã€‚</p><p>ä¹‹åæˆ‘ä»¬æ¶‰è¶³ç½‘ç»œçš„ä¸–ç•Œã€‚ï¼ˆ<a href=\"https://time.geekbang.org/column/article/446948\">36è®²</a>ï¼‰ä¸º KV server æ„é€ äº†è‡ªå·±çš„ frameï¼šä¸€ä¸ªåŒ…å«é•¿åº¦å’Œæ˜¯å¦å‹ç¼©çš„ä¿¡æ¯çš„ 4 å­—èŠ‚çš„å¤´ï¼Œä»¥åŠå®é™…çš„ payloadï¼›è¿˜è®¾è®¡äº†ä¸€ä¸ª FrameCoder æ¥å¯¹ frame è¿›è¡Œå°åŒ…å’Œæ‹†åŒ…ï¼Œè¿™ä¸ºæ¥ä¸‹æ¥æ„é€ ç½‘ç»œæ¥å£æ‰“ä¸‹äº†åšå®çš„åŸºç¡€ã€‚è€ƒè™‘åˆ°ç½‘ç»œå®‰å…¨ï¼Œï¼ˆ<a href=\"https://time.geekbang.org/column/article/446949\">37è®²</a>ï¼‰æˆ‘ä»¬æä¾›äº† TLS çš„æ”¯æŒã€‚</p><!-- [[[read_end]]] --><p>åœ¨æ„å»º ProstStream çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¼€å§‹å¤„ç†å¼‚æ­¥ï¼šProstStream å†…éƒ¨çš„ stream éœ€è¦æ”¯æŒ AsyncRead + AsyncWriteï¼Œè¿™å¯ä»¥è®© ProstStream é€‚é…åŒ…æ‹¬ TcpStream å’Œ TlsStream åœ¨å†…çš„ä¸€åˆ‡å®ç°äº† AsyncRead å’Œ AsyncWrite çš„å¼‚æ­¥ç½‘ç»œæ¥å£ã€‚</p><p>è‡³æ­¤ï¼Œæˆ‘ä»¬æ‰“é€šäº†ä»è¿œç«¯å¾—åˆ°ä¸€ä¸ªå‘½ä»¤ï¼Œå†ç» TCPã€TLSï¼Œç„¶åè¢« FrameCoder è§£å‡ºæ¥ä¸€ä¸ª CommandRequestï¼Œäº¤ç”± Service æ¥å¤„ç†çš„è¿‡ç¨‹ã€‚<strong>æŠŠåŒæ­¥ä¸–ç•Œå’Œå¼‚æ­¥ä¸–ç•Œè¿æ¥èµ·æ¥çš„ï¼Œå°±æ˜¯ ProstServerStream è¿™ä¸ªç»“æ„</strong>ã€‚</p><p>è¿™ä¸ªä»æ”¶åŒ…å¤„ç†åˆ°å¤„ç†å®Œæˆåå‘åŒ…çš„å®Œæ•´æµç¨‹å’Œç³»ç»Ÿç»“æ„ï¼Œå¯ä»¥çœ‹ä¸‹å›¾ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/82/2c/82da823b4eb16935fdeyy727e3b3262c.jpg?wh=1920x1145\" alt=\"å›¾ç‰‡\"></p><h2>ä»Šå¤©åšç‚¹ä»€ä¹ˆï¼Ÿ</h2><p>è™½ç„¶æˆ‘ä»¬å¾ˆæ—©å°±å·²ç»æ’°å†™äº†ä¸å°‘å¼‚æ­¥æˆ–è€…å’Œå¼‚æ­¥æœ‰å…³çš„ä»£ç ã€‚ä½†æ˜¯æœ€èƒ½ä½“ç° Rust å¼‚æ­¥æœ¬è´¨çš„ poll()ã€poll_read()ã€poll_next() è¿™æ ·çš„å¤„ç†å‡½æ•°è¿˜æ²¡æœ‰æ€ä¹ˆå†™è¿‡ï¼Œä¹‹å‰æµ‹è¯•å¼‚æ­¥çš„ read_frame() å†™è¿‡ä¸€ä¸ª DummyStreamï¼Œç®—æ˜¯ä½“éªŒäº†ä¸€ä¸‹åº•å±‚çš„å¼‚æ­¥å¤„ç†å‡½æ•°çš„å¤æ‚æ¥å£ã€‚ä¸è¿‡åœ¨ DummyStream é‡Œï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰åšä»»ä½•å¤æ‚çš„åŠ¨ä½œï¼š</p><pre><code class=\"language-rust\">struct DummyStream {\n    buf: BytesMut,\n}\n\nimpl AsyncRead for DummyStream {\n    fn poll_read(\n        self: std::pin::Pin&lt;&amp;mut Self&gt;,\n        _cx: &amp;mut std::task::Context&lt;'_&gt;,\n        buf: &amp;mut tokio::io::ReadBuf&lt;'_&gt;,\n    ) -&gt; std::task::Poll&lt;std::io::Result&lt;()&gt;&gt; {\n        // çœ‹çœ‹ ReadBuf éœ€è¦å¤šå¤§çš„æ•°æ®\n        let len = buf.capacity();\n        // split å‡ºè¿™ä¹ˆå¤§çš„æ•°æ®\n        let data = self.get_mut().buf.split_to(len);\n        // æ‹·è´ç»™ ReadBuf\n        buf.put_slice(&amp;data);\n        // ç›´æ¥å®Œå·¥\n        std::task::Poll::Ready(Ok(()))\n    }\n}\n</code></pre><p>ä¸Šä¸€è®²æˆ‘ä»¬å­¦ä¹ äº†å¼‚æ­¥ IOï¼Œè¿™å ‚è¯¾æˆ‘ä»¬å°±å­¦ä»¥è‡´ç”¨ï¼Œå¯¹ç°æœ‰çš„ä»£ç åšäº›é‡æ„ï¼Œè®©æ ¸å¿ƒçš„ ProstStream æ›´ç¬¦åˆ Rust çš„å¼‚æ­¥ IO æ¥å£é€»è¾‘ã€‚å…·ä½“è¦åšç‚¹ä»€ä¹ˆå‘¢ï¼Ÿ</p><p>çœ‹ä¹‹å‰å†™çš„ ProstServerStream çš„ process() å‡½æ•°ï¼Œæ¯”è¾ƒä¸€ä¸‹å®ƒå’Œ async_prost åº“çš„ AsyncProst çš„è°ƒç”¨é€»è¾‘ï¼š</p><pre><code class=\"language-rust\">// process() å‡½æ•°çš„å†…åœ¨é€»è¾‘\nwhile let Ok(cmd) = self.recv().await {\n    info!(\"Got a new command: {:?}\", cmd);\n    let res = self.service.execute(cmd);\n    self.send(res).await?;\n}\n\n// async_prost åº“çš„ AsyncProst çš„è°ƒç”¨é€»è¾‘\nwhile let Some(Ok(cmd)) = stream.next().await {\n    info!(\"Got a new command: {:?}\", cmd);\n    let res = svc.execute(cmd);\n    stream.send(res).await.unwrap();\n}\n</code></pre><p>å¯ä»¥çœ‹åˆ°ç”±äº AsyncProst å®ç°äº† <a href=\"https://docs.rs/futures/0.3.17/futures/stream/trait.Stream.html\">Stream</a> å’Œ <a href=\"https://docs.rs/futures/0.3.17/futures/sink/trait.Sink.html\">Sink</a>ï¼Œèƒ½æ›´åŠ è‡ªç„¶åœ°è°ƒç”¨ <a href=\"https://docs.rs/futures/0.3.17/futures/stream/trait.StreamExt.html\">StreamExt</a> trait çš„ next() æ–¹æ³•å’Œ <a href=\"https://docs.rs/futures/0.3.17/futures/sink/trait.SinkExt.html\">SinkExt</a> trait çš„ send() æ–¹æ³•ï¼Œæ¥å¤„ç†æ•°æ®çš„æ”¶å‘ï¼Œè€Œ ProstServerStream åˆ™è‡ªå·±é¢å¤–å®ç°äº†å‡½æ•° recv() å’Œ send()ã€‚</p><p>è™½ç„¶ä»ä»£ç å¯¹æ¯”çš„è§’åº¦ï¼Œè¿™ä¸¤æ®µä»£ç å‡ ä¹ä¸€æ ·ï¼Œä½†æœªæ¥çš„å¯æ‰©å±•æ€§ï¼Œå’Œæ•´ä¸ªå¼‚æ­¥ç”Ÿæ€çš„èæ´½æ€§ä¸Šï¼ŒAsyncProst è¿˜æ˜¯æ›´èƒœä¸€ç­¹ã€‚</p><p>æ‰€ä»¥ä»Šå¤©æˆ‘ä»¬å°±æ„é€ ä¸€ä¸ª ProstStream ç»“æ„ï¼Œè®©å®ƒå®ç° Stream å’Œ Sink è¿™ä¸¤ä¸ª traitï¼Œç„¶åè®© ProstServerStream å’Œ ProstClientStream ä½¿ç”¨å®ƒã€‚</p><h2>åˆ›å»º ProstStream</h2><p>åœ¨å¼€å§‹é‡æ„ä¹‹å‰ï¼Œå…ˆæ¥ç®€å•å¤ä¹ ä¸€ä¸‹ Stream trait å’Œ Sink traitï¼š</p><pre><code class=\"language-rust\">// å¯ä»¥ç±»æ¯” Iterator\npub trait Stream {\n    // ä» Stream ä¸­è¯»å–åˆ°çš„æ•°æ®ç±»å‹\n    type Item;\n\n\t// ä» stream é‡Œè¯»å–ä¸‹ä¸€ä¸ªæ•°æ®\n    fn poll_next(\n\t\tself: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;\n    ) -&gt; Poll&lt;Option&lt;Self::Item&gt;&gt;;\n}\n\n// \npub trait Sink&lt;Item&gt; {\n    type Error;\n    fn poll_ready(\n        self: Pin&lt;&amp;mut Self&gt;, \n        cx: &amp;mut Context&lt;'_&gt;\n    ) -&gt; Poll&lt;Result&lt;(), Self::Error&gt;&gt;;\n    fn start_send(self: Pin&lt;&amp;mut Self&gt;, item: Item) -&gt; Result&lt;(), Self::Error&gt;;\n    fn poll_flush(\n        self: Pin&lt;&amp;mut Self&gt;, \n        cx: &amp;mut Context&lt;'_&gt;\n    ) -&gt; Poll&lt;Result&lt;(), Self::Error&gt;&gt;;\n    fn poll_close(\n        self: Pin&lt;&amp;mut Self&gt;, \n        cx: &amp;mut Context&lt;'_&gt;\n    ) -&gt; Poll&lt;Result&lt;(), Self::Error&gt;&gt;;\n}\n</code></pre><p>é‚£ä¹ˆ ProstStream å…·ä½“éœ€è¦åŒ…å«ä»€ä¹ˆç±»å‹å‘¢ï¼Ÿ</p><p>å› ä¸ºå®ƒçš„ä¸»è¦èŒè´£æ˜¯ä»åº•ä¸‹çš„ stream ä¸­è¯»å–æˆ–è€…å‘é€æ•°æ®ï¼Œæ‰€ä»¥ä¸€ä¸ªæ”¯æŒ AsyncRead å’Œ AsyncWrite çš„æ³›å‹å‚æ•° S æ˜¯å¿…ç„¶éœ€è¦çš„ã€‚</p><p>å¦å¤– Stream trait å’Œ Sink éƒ½å„éœ€è¦ä¸€ä¸ª Item ç±»å‹ï¼Œå¯¹äºæˆ‘ä»¬çš„ç³»ç»Ÿæ¥è¯´ï¼ŒItem æ˜¯ CommandRequest æˆ–è€… CommandResponseï¼Œä½†ä¸ºäº†çµæ´»æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ In å’Œ Out è¿™ä¸¤ä¸ªæ³›å‹å‚æ•°æ¥è¡¨ç¤ºã€‚</p><p>å½“ç„¶ï¼Œåœ¨å¤„ç† Stream å’Œ Sink æ—¶è¿˜éœ€è¦ read buffer å’Œ write bufferã€‚</p><p>ç»¼ä¸Šæ‰€è¿°ï¼Œæˆ‘ä»¬çš„ ProstStream ç»“æ„çœ‹ä¸Šå»æ˜¯è¿™æ ·å­çš„ï¼š</p><pre><code class=\"language-rust\">pub struct ProstStream&lt;S, In, Out&gt; {\n    // innner stream\n    stream: S,\n    // å†™ç¼“å­˜\n    wbuf: BytesMut,\n    // è¯»ç¼“å­˜\n    rbuf: BytesMut,\n}\n</code></pre><p>ç„¶è€Œï¼ŒRust ä¸å…è®¸æ•°æ®ç»“æ„æœ‰è¶…å‡ºéœ€è¦çš„æ³›å‹å‚æ•°ã€‚æ€ä¹ˆåŠï¼Ÿåˆ«æ€¥ï¼Œå¯ä»¥ç”¨ <a href=\"https://doc.rust-lang.org/std/marker/struct.PhantomData.html\">PhantomData<t></t></a>ï¼Œä¹‹å‰è®²è¿‡å®ƒæ˜¯ä¸€ä¸ªé›¶å­—èŠ‚å¤§å°çš„å ä½ç¬¦ï¼Œå¯ä»¥è®©æˆ‘ä»¬çš„æ•°æ®ç»“æ„æºå¸¦æœªä½¿ç”¨çš„æ³›å‹å‚æ•°ã€‚</p><p>å¥½ï¼Œç°åœ¨æœ‰è¶³å¤Ÿçš„æ€è·¯äº†ï¼Œæˆ‘ä»¬åˆ›å»º src/network/stream.rsï¼Œæ·»åŠ å¦‚ä¸‹ä»£ç ï¼ˆè®°å¾—åœ¨ src/network/mod.rs æ·»åŠ å¯¹ <a href=\"http://stream.rs\">stream.rs</a> çš„å¼•ç”¨ï¼‰ï¼š</p><pre><code class=\"language-rust\">use bytes::BytesMut;\nuse futures::{Sink, Stream};\nuse std::{\n    marker::PhantomData,\n    pin::Pin,\n    task::{Context, Poll},\n};\nuse tokio::io::{AsyncRead, AsyncWrite};\n\nuse crate::{FrameCoder, KvError};\n\n/// å¤„ç† KV server prost frame çš„ stream\npub struct ProstStream&lt;S, In, Out&gt; where {\n    // innner stream\n    stream: S,\n    // å†™ç¼“å­˜\n    wbuf: BytesMut,\n    // è¯»ç¼“å­˜\n    rbuf: BytesMut,\n\n    // ç±»å‹å ä½ç¬¦\n    _in: PhantomData&lt;In&gt;,\n    _out: PhantomData&lt;Out&gt;,\n}\n\nimpl&lt;S, In, Out&gt; Stream for ProstStream&lt;S, In, Out&gt;\nwhere\n    S: AsyncRead + AsyncWrite + Unpin + Send,\n    In: Unpin + Send + FrameCoder,\n    Out: Unpin + Send,\n{\n    /// å½“è°ƒç”¨ next() æ—¶ï¼Œå¾—åˆ° Result&lt;In, KvError&gt;\n    type Item = Result&lt;In, KvError&gt;;\n\n    fn poll_next(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Option&lt;Self::Item&gt;&gt; {\n        todo!()\n    }\n}\n\n/// å½“è°ƒç”¨ send() æ—¶ï¼Œä¼šæŠŠ Out å‘å‡ºå»\nimpl&lt;S, In, Out&gt; Sink&lt;Out&gt; for ProstStream&lt;S, In, Out&gt;\nwhere\n    S: AsyncRead + AsyncWrite + Unpin,\n    In: Unpin + Send,\n    Out: Unpin + Send + FrameCoder,\n{\n    /// å¦‚æœå‘é€å‡ºé”™ï¼Œä¼šè¿”å› KvError\n    type Error = KvError;\n\n    fn poll_ready(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Result&lt;(), Self::Error&gt;&gt; {\n        todo!()\n    }\n\n    fn start_send(self: Pin&lt;&amp;mut Self&gt;, item: Out) -&gt; Result&lt;(), Self::Error&gt; {\n        todo!()\n    }\n\n    fn poll_flush(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Result&lt;(), Self::Error&gt;&gt; {\n        todo!()\n    }\n\n    fn poll_close(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Result&lt;(), Self::Error&gt;&gt; {\n        todo!()\n    }\n}\n</code></pre><p>è¿™æ®µä»£ç åŒ…å«äº†ä¸º ProstStream å®ç° Stream å’Œ Sink çš„éª¨æ¶ä»£ç ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±ä¸€ä¸ªä¸ªå¤„ç†ã€‚æ³¨æ„å¯¹äº In å’Œ Out å‚æ•°ï¼Œè¿˜ä¸ºå…¶çº¦æŸäº† FrameCoderï¼Œè¿™æ ·ï¼Œåœ¨å®ç°é‡Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ decode_frame() å’Œ encode_frame() æ¥è·å–ä¸€ä¸ª Item æˆ–è€… encode ä¸€ä¸ª Itemã€‚</p><h3>Stream çš„å®ç°</h3><p>å…ˆæ¥å®ç° Stream çš„ poll_next() æ–¹æ³•ã€‚</p><p>poll_next() å¯ä»¥ç›´æ¥è°ƒç”¨æˆ‘ä»¬ä¹‹å‰å†™å¥½çš„ read_frame()ï¼Œç„¶åå†ç”¨ decode_frame() æ¥è§£åŒ…ï¼š</p><pre><code class=\"language-rust\">fn poll_next(mut self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Option&lt;Self::Item&gt;&gt; {\n    // ä¸Šä¸€æ¬¡è°ƒç”¨ç»“æŸå rbuf åº”è¯¥ä¸ºç©º\n    assert!(self.rbuf.len() == 0);\n\n    // ä» rbuf ä¸­åˆ†ç¦»å‡º restï¼ˆæ‘†è„±å¯¹ self çš„å¼•ç”¨ï¼‰\n    let mut rest = self.rbuf.split_off(0);\n\n    // ä½¿ç”¨ read_frame æ¥è·å–æ•°æ®\n    let fut = read_frame(&amp;mut self.stream, &amp;mut rest);\n    ready!(Box::pin(fut).poll_unpin(cx))?;\n\n    // æ‹¿åˆ°ä¸€ä¸ª frame çš„æ•°æ®ï¼ŒæŠŠ buffer åˆå¹¶å›å»\n    self.rbuf.unsplit(rest);\n\n    // è°ƒç”¨ decode_frame è·å–è§£åŒ…åçš„æ•°æ®\n    Poll::Ready(Some(In::decode_frame(&amp;mut self.rbuf)))\n}\n</code></pre><p>è¿™ä¸ªä¸éš¾ç†è§£ï¼Œä½†ä¸­é—´è¿™æ®µéœ€è¦ç¨å¾®è§£é‡Šä¸€ä¸‹ï¼š</p><pre><code class=\"language-rust\"> // ä½¿ç”¨ read_frame æ¥è·å–æ•°æ®\nlet fut = read_frame(&amp;mut self.stream, &amp;mut rest);\nready!(Box::pin(fut).poll_unpin(cx))?;\n</code></pre><p>å› ä¸º poll_xxx() æ–¹æ³•å·²ç»æ˜¯ async/await çš„åº•å±‚ API å®ç°ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ poll_xxx() æ–¹æ³•ä¸­ï¼Œæ˜¯ä¸èƒ½ç›´æ¥ä½¿ç”¨å¼‚æ­¥å‡½æ•°çš„ï¼Œéœ€è¦æŠŠå®ƒçœ‹ä½œä¸€ä¸ª futureï¼Œç„¶åè°ƒç”¨ future çš„ poll å‡½æ•°ã€‚å› ä¸º future æ˜¯ä¸€ä¸ª traitï¼Œæ‰€ä»¥éœ€è¦ Box å°†å…¶å¤„ç†æˆä¸€ä¸ªåœ¨å †ä¸Šçš„ trait objectï¼Œè¿™æ ·å°±å¯ä»¥è°ƒç”¨ FutureExt çš„ <a href=\"https://docs.rs/futures/0.3.17/futures/future/trait.FutureExt.html#method.poll_unpin\">poll_unpin()</a> æ–¹æ³•äº†ã€‚Box::pin ä¼šç”Ÿæˆ Pin&lt;Box<t>&gt;ã€‚</t></p><p>è‡³äº ready! å®ï¼Œå®ƒä¼šåœ¨ Pending æ—¶ç›´æ¥ return Pendingï¼Œè€Œåœ¨ Ready æ—¶ï¼Œè¿”å› Ready çš„å€¼ï¼š</p><pre><code class=\"language-rust\">macro_rules! ready {\n    ($e:expr $(,)?) =&gt; {\n        match $e {\n            $crate::task::Poll::Ready(t) =&gt; t,\n            $crate::task::Poll::Pending =&gt; return $crate::task::Poll::Pending,\n        }\n    };\n}\n</code></pre><p>Stream æˆ‘ä»¬å°±å®ç°å¥½äº†ï¼Œæ˜¯ä¸æ˜¯ä¹Ÿæ²¡æœ‰é‚£ä¹ˆå¤æ‚ï¼Ÿ</p><h3>Sink çš„å®ç°</h3><p>å†å†™Sinkï¼Œçœ‹ä¸Šå»è¦å®ç°å¥½å‡ ä¸ªæ–¹æ³•ï¼Œå…¶å®ä¹Ÿä¸ç®—å¤æ‚ã€‚å››ä¸ªæ–¹æ³• poll_readyã€start_send()ã€poll_flush å’Œ poll_close æˆ‘ä»¬å†å›é¡¾ä¸€ä¸‹ã€‚</p><p><a href=\"https://docs.rs/futures/0.3.17/futures/prelude/trait.Sink.html#tymethod.poll_ready\">poll_ready()</a> æ˜¯åšèƒŒå‹çš„ï¼Œä½ å¯ä»¥æ ¹æ®è´Ÿè½½æ¥å†³å®šè¦ä¸è¦è¿”å› Poll::Readyã€‚å¯¹äºæˆ‘ä»¬çš„ç½‘ç»œå±‚æ¥è¯´ï¼Œå¯ä»¥å…ˆä¸å…³å¿ƒèƒŒå‹ï¼Œä¾é æ“ä½œç³»ç»Ÿçš„ TCP åè®®æ ˆæä¾›èƒŒå‹å¤„ç†å³å¯ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥è¿”å› Poll::Ready(Ok(()))ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸Šå±‚æƒ³å†™æ•°æ®ï¼Œå¯ä»¥éšæ—¶å†™ã€‚</p><pre><code class=\"language-rust\">fn poll_ready(self: Pin&lt;&amp;mut Self&gt;, _cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Result&lt;(), Self::Error&gt;&gt; {\n    Poll::Ready(Ok(()))\n}\n</code></pre><p>å½“ poll_ready() è¿”å› Ready åï¼ŒSink å°±èµ°åˆ° <a href=\"https://docs.rs/futures/0.3.17/futures/prelude/trait.Sink.html#tymethod.start_send\">start_send()</a>ã€‚æˆ‘ä»¬åœ¨ start_send() é‡Œå°±æŠŠå¿…è¦çš„æ•°æ®å‡†å¤‡å¥½ã€‚è¿™é‡ŒæŠŠ item å°åŒ…æˆå­—èŠ‚æµï¼Œå­˜å…¥ wbuf ä¸­ï¼š</p><pre><code class=\"language-rust\">fn start_send(self: Pin&lt;&amp;mut Self&gt;, item: Out) -&gt; Result&lt;(), Self::Error&gt; {\n    let this = self.get_mut();\n    item.encode_frame(&amp;mut this.wbuf)?;\n\n    Ok(())\n}\n</code></pre><p>ç„¶ååœ¨ <a href=\"https://docs.rs/futures/0.3.17/futures/prelude/trait.Sink.html#tymethod.poll_flush\">poll_flush()</a> ä¸­ï¼Œæˆ‘ä»¬å¼€å§‹å†™æ•°æ®ã€‚è¿™é‡Œéœ€è¦è®°å½•å½“å‰å†™åˆ°å“ªé‡Œï¼Œæ‰€ä»¥éœ€è¦åœ¨ ProstStream é‡ŒåŠ ä¸€ä¸ªå­—æ®µ writtenï¼Œè®°å½•å†™å…¥äº†å¤šå°‘å­—èŠ‚ï¼š</p><pre><code class=\"language-rust\">/// å¤„ç† KV server prost frame çš„ stream\npub struct ProstStream&lt;S, In, Out&gt; {\n    // innner stream\n    stream: S,\n    // å†™ç¼“å­˜\n    wbuf: BytesMut,\n    // å†™å…¥äº†å¤šå°‘å­—èŠ‚\n    written: usize,\n    // è¯»ç¼“å­˜\n    rbuf: BytesMut,\n\n    // ç±»å‹å ä½ç¬¦\n    _in: PhantomData&lt;In&gt;,\n    _out: PhantomData&lt;Out&gt;,\n}\n</code></pre><p>æœ‰äº†è¿™ä¸ª written å­—æ®µï¼Œ å°±å¯ä»¥å¾ªç¯å†™å…¥ï¼š</p><pre><code class=\"language-rust\">fn poll_flush(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Result&lt;(), Self::Error&gt;&gt; {\n    let this = self.get_mut();\n\n    // å¾ªç¯å†™å…¥ stream ä¸­\n    while this.written != this.wbuf.len() {\n        let n = ready!(Pin::new(&amp;mut this.stream).poll_write(cx, &amp;this.wbuf[this.written..]))?;\n        this.written += n;\n    }\n\n    // æ¸…é™¤ wbuf\n    this.wbuf.clear();\n    this.written = 0;\n\n    // è°ƒç”¨ stream çš„ poll_flush ç¡®ä¿å†™å…¥\n    ready!(Pin::new(&amp;mut this.stream).poll_flush(cx)?);\n    Poll::Ready(Ok(()))\n}\n</code></pre><p>æœ€åæ˜¯ <a href=\"https://docs.rs/futures/0.3.17/futures/prelude/trait.Sink.html#tymethod.poll_close\">poll_close()</a>ï¼Œæˆ‘ä»¬åªéœ€è¦è°ƒç”¨ stream çš„ flush å’Œ shutdown æ–¹æ³•ï¼Œç¡®ä¿æ•°æ®å†™å®Œå¹¶ä¸” stream å…³é—­ï¼š</p><pre><code class=\"language-rust\">fn poll_close(mut self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Result&lt;(), Self::Error&gt;&gt; {\n    // è°ƒç”¨ stream çš„ poll_flush ç¡®ä¿å†™å…¥\n    ready!(self.as_mut().poll_flush(cx))?;\n\n    // è°ƒç”¨ stream çš„ poll_shutdown ç¡®ä¿ stream å…³é—­\n    ready!(Pin::new(&amp;mut self.stream).poll_shutdown(cx))?;\n    Poll::Ready(Ok(()))\n}\n</code></pre><h3>ProstStream çš„åˆ›å»º</h3><p>æˆ‘ä»¬çš„ ProstStream ç›®å‰å·²ç»å®ç°äº† Stream å’Œ Sinkï¼Œä¸ºäº†æ–¹ä¾¿ä½¿ç”¨ï¼Œå†æ„å»ºä¸€äº›è¾…åŠ©æ–¹æ³•ï¼Œæ¯”å¦‚ new()ï¼š</p><pre><code class=\"language-rust\">impl&lt;S, In, Out&gt; ProstStream&lt;S, In, Out&gt;\nwhere\n    S: AsyncRead + AsyncWrite + Send + Unpin,\n{\n    /// åˆ›å»ºä¸€ä¸ª ProstStream\n    pub fn new(stream: S) -&gt; Self {\n        Self {\n            stream,\n            written: 0,\n            wbuf: BytesMut::new(),\n            rbuf: BytesMut::new(),\n            _in: PhantomData::default(),\n            _out: PhantomData::default(),\n        }\n    }\n}\n\n// ä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æœæˆ‘ä»¬çš„ Stream æ˜¯ Unpinï¼Œæœ€å¥½å®ç°ä¸€ä¸‹\nimpl&lt;S, Req, Res&gt; Unpin for ProstStream&lt;S, Req, Res&gt; where S: Unpin {}\n</code></pre><p>æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜ä¸ºå…¶å®ç° Unpin traitï¼Œè¿™ä¼šç»™åˆ«äººåœ¨ä½¿ç”¨ä½ çš„ä»£ç æ—¶å¸¦æ¥å¾ˆå¤šæ–¹ä¾¿ã€‚<strong>ä¸€èˆ¬æ¥è¯´ï¼Œä¸ºå¼‚æ­¥æ“ä½œè€Œåˆ›å»ºçš„æ•°æ®ç»“æ„ï¼Œå¦‚æœä½¿ç”¨äº†æ³›å‹å‚æ•°ï¼Œé‚£ä¹ˆåªè¦å†…éƒ¨æ²¡æœ‰è‡ªå¼•ç”¨æ•°æ®ï¼Œå°±åº”è¯¥å®ç° Unpin</strong>ã€‚</p><h3>æµ‹è¯•ï¼</h3><p>åˆåˆ°äº†é‡è¦çš„æµ‹è¯•ç¯èŠ‚ã€‚æˆ‘ä»¬éœ€è¦å†™ç‚¹æµ‹è¯•æ¥ç¡®ä¿ ProstStream èƒ½æ­£å¸¸å·¥ä½œã€‚å› ä¸ºä¹‹å‰åœ¨ src/network/<a href=\"http://frame.rs\">frame.rs</a> ä¸­å†™äº†ä¸ª DummyStreamï¼Œå®ç°äº† AsyncReadï¼Œæˆ‘ä»¬åªéœ€è¦æ‰©å±•å®ƒï¼Œè®©å®ƒå†å®ç° AsyncWriteã€‚</p><p>ä¸ºäº†è®©å®ƒå¯ä»¥è¢«å¤ç”¨ï¼Œæˆ‘ä»¬å°†å…¶ä» <a href=\"http://frame.rs\">frame.rs</a> ä¸­ç§»å‡ºæ¥ï¼Œæ”¾åœ¨ src/network/mod.rs ä¸­ï¼Œå¹¶ä¿®æ”¹æˆä¸‹é¢çš„æ ·å­ï¼ˆè®°å¾—åœ¨ <a href=\"http://frame.rs\">frame.rs</a> çš„æµ‹è¯•é‡Œ use æ–°çš„ DummyStreamï¼‰ï¼š</p><pre><code class=\"language-rust\">#[cfg(test)]\npub mod utils {\n\t\tuse bytes::{BufMut, BytesMut};\n    use std::task::Poll;\n    use tokio::io::{AsyncRead, AsyncWrite};\n\n    pub struct DummyStream {\n        pub buf: BytesMut,\n    }\n\n    impl AsyncRead for DummyStream {\n        fn poll_read(\n            self: std::pin::Pin&lt;&amp;mut Self&gt;,\n            _cx: &amp;mut std::task::Context&lt;'_&gt;,\n            buf: &amp;mut tokio::io::ReadBuf&lt;'_&gt;,\n        ) -&gt; Poll&lt;std::io::Result&lt;()&gt;&gt; {\n            let len = buf.capacity();\n            let data = self.get_mut().buf.split_to(len);\n            buf.put_slice(&amp;data);\n            Poll::Ready(Ok(()))\n        }\n    }\n\n    impl AsyncWrite for DummyStream {\n        fn poll_write(\n            self: std::pin::Pin&lt;&amp;mut Self&gt;,\n            _cx: &amp;mut std::task::Context&lt;'_&gt;,\n            buf: &amp;[u8],\n        ) -&gt; Poll&lt;Result&lt;usize, std::io::Error&gt;&gt; {\n            self.get_mut().buf.put_slice(buf);\n            Poll::Ready(Ok(buf.len()))\n        }\n\n        fn poll_flush(\n            self: std::pin::Pin&lt;&amp;mut Self&gt;,\n            _cx: &amp;mut std::task::Context&lt;'_&gt;,\n        ) -&gt; Poll&lt;Result&lt;(), std::io::Error&gt;&gt; {\n            Poll::Ready(Ok(()))\n        }\n\n        fn poll_shutdown(\n            self: std::pin::Pin&lt;&amp;mut Self&gt;,\n            _cx: &amp;mut std::task::Context&lt;'_&gt;,\n        ) -&gt; Poll&lt;Result&lt;(), std::io::Error&gt;&gt; {\n            Poll::Ready(Ok(()))\n        }\n    }\n}\n</code></pre><p>å¥½ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨ src/network/stream.rs ä¸‹å†™ä¸ªæµ‹è¯•äº†ï¼š</p><pre><code class=\"language-rust\">#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::{utils::DummyStream, CommandRequest};\n    use anyhow::Result;\n    use futures::prelude::*;\n\n    #[tokio::test]\n    async fn prost_stream_should_work() -&gt; Result&lt;()&gt; {\n        let buf = BytesMut::new();\n        let stream = DummyStream { buf };\n        let mut stream = ProstStream::&lt;_, CommandRequest, CommandRequest&gt;::new(stream);\n        let cmd = CommandRequest::new_hdel(\"t1\", \"k1\");\n        stream.send(cmd.clone()).await?;\n        if let Some(Ok(s)) = stream.next().await {\n            assert_eq!(s, cmd);\n        } else {\n            assert!(false);\n        }\n        Ok(())\n    }\n}\n</code></pre><p>è¿è¡Œ <code>cargo test</code> ï¼Œä¸€åˆ‡æµ‹è¯•é€šè¿‡ï¼ï¼ˆå¦‚æœä½ ç¼–è¯‘é”™è¯¯ï¼Œå¯èƒ½ç¼ºå°‘ use çš„é—®é¢˜ï¼Œå¯ä»¥è‡ªè¡Œä¿®æ”¹ï¼Œæˆ–è€…å‚è€ƒ GitHub ä¸Šçš„å®Œæ•´ä»£ç ï¼‰ã€‚</p><h2>ä½¿ç”¨ ProstStream</h2><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥è®© ProstServerStream å’Œ ProstClientStream ä½¿ç”¨æ–°å®šä¹‰çš„ ProstStream äº†ï¼Œä½ å¯ä»¥å‚è€ƒä¸‹é¢çš„å¯¹æ¯”ï¼Œçœ‹çœ‹äºŒè€…çš„åŒºåˆ«ï¼š</p><pre><code class=\"language-rust\">// æ—§çš„æ¥å£\n// pub struct ProstServerStream&lt;S&gt; {\n//     inner: S,\n//     service: Service,\n// }\n\npub struct ProstServerStream&lt;S&gt; {\n    inner: ProstStream&lt;S, CommandRequest, CommandResponse&gt;,\n    service: Service,\n}\n\n// æ—§çš„æ¥å£\n// pub struct ProstClientStream&lt;S&gt; {\n//     inner: S,\n// }\n\npub struct ProstClientStream&lt;S&gt; {\n    inner: ProstStream&lt;S, CommandResponse, CommandRequest&gt;,\n}\n</code></pre><p>ç„¶ååˆ é™¤ send() / recv() å‡½æ•°ï¼Œå¹¶ä¿®æ”¹ process() / execute() å‡½æ•°ä½¿å…¶ä½¿ç”¨ next() æ–¹æ³•å’Œ send() æ–¹æ³•ã€‚ä¸»è¦çš„æ”¹åŠ¨å¦‚ä¸‹ï¼š</p><pre><code class=\"language-rust\">/// å¤„ç†æœåŠ¡å™¨ç«¯çš„æŸä¸ª accept ä¸‹æ¥çš„ socket çš„è¯»å†™\npub struct ProstServerStream&lt;S&gt; {\n    inner: ProstStream&lt;S, CommandRequest, CommandResponse&gt;,\n    service: Service,\n}\n\n/// å¤„ç†å®¢æˆ·ç«¯ socket çš„è¯»å†™\npub struct ProstClientStream&lt;S&gt; {\n    inner: ProstStream&lt;S, CommandResponse, CommandRequest&gt;,\n}\n\nimpl&lt;S&gt; ProstServerStream&lt;S&gt;\nwhere\n    S: AsyncRead + AsyncWrite + Unpin + Send,\n{\n    pub fn new(stream: S, service: Service) -&gt; Self {\n        Self {\n            inner: ProstStream::new(stream),\n            service,\n        }\n    }\n\n    pub async fn process(mut self) -&gt; Result&lt;(), KvError&gt; {\n        let stream = &amp;mut self.inner;\n        while let Some(Ok(cmd)) = stream.next().await {\n            info!(\"Got a new command: {:?}\", cmd);\n            let res = self.service.execute(cmd);\n            stream.send(res).await.unwrap();\n        }\n\n        Ok(())\n    }\n}\n\nimpl&lt;S&gt; ProstClientStream&lt;S&gt;\nwhere\n    S: AsyncRead + AsyncWrite + Unpin + Send,\n{\n    pub fn new(stream: S) -&gt; Self {\n        Self {\n            inner: ProstStream::new(stream),\n        }\n    }\n\n    pub async fn execute(&amp;mut self, cmd: CommandRequest) -&gt; Result&lt;CommandResponse, KvError&gt; {\n        let stream = &amp;mut self.inner;\n        stream.send(cmd).await?;\n\n        match stream.next().await {\n            Some(v) =&gt; v,\n            None =&gt; Err(KvError::Internal(\"Didn't get any response\".into())),\n        }\n    }\n}\n</code></pre><p>å†æ¬¡è¿è¡Œ <code>cargo test</code> ï¼Œæ‰€æœ‰çš„æµ‹è¯•åº”è¯¥éƒ½èƒ½é€šè¿‡ã€‚åŒæ ·å¦‚æœæœ‰ç¼–è¯‘é”™è¯¯ï¼Œå¯èƒ½æ˜¯ç¼ºå°‘äº†å¼•ç”¨ã€‚</p><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰“å¼€ä¸€ä¸ªå‘½ä»¤è¡Œçª—å£ï¼Œè¿è¡Œï¼š<code>RUST_LOG=info cargo run --bin kvs --quiet</code>ã€‚ç„¶ååœ¨å¦ä¸€ä¸ªå‘½ä»¤è¡Œçª—å£ï¼Œè¿è¡Œï¼š<code>RUST_LOG=info cargo run --bin kvc --quiet</code>ã€‚æ­¤æ—¶ï¼ŒæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯éƒ½æ”¶åˆ°äº†å½¼æ­¤çš„è¯·æ±‚å’Œå“åº”ï¼Œå¹¶ä¸”å¤„ç†æ­£å¸¸ï¼</p><p>æˆ‘ä»¬é‡æ„äº† ProstServerStream å’Œ ProstClientStream çš„ä»£ç ï¼Œä½¿å…¶å†…éƒ¨ä½¿ç”¨æ›´ç¬¦åˆ futures åº“é‡Œ Stream / Sink trait çš„ç”¨æ³•ï¼Œæ•´ä½“ä»£ç æ”¹åŠ¨ä¸å°ï¼Œä½†æ˜¯å†…éƒ¨å®ç°çš„å˜æ›´å¹¶ä¸å½±å“ç³»ç»Ÿçš„å…¶å®ƒéƒ¨åˆ†ï¼è¿™ç®€ç›´å¤ªæ£’äº†ï¼</p><h2>å°ç»“</h2><p>åœ¨å®é™…å¼€å‘ä¸­ï¼Œè¿›è¡Œé‡æ„æ¥æ”¹å–„æ—¢æœ‰ä»£ç çš„è´¨é‡æ˜¯å¿…ä¸å¯å°‘çš„ã€‚ä¹‹å‰åœ¨å¼€å‘ KV server çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬åœ¨ä¸æ–­åœ°è¿›è¡Œä¸€äº›å°çš„é‡æ„ã€‚</p><p>ä»Šå¤©æˆ‘ä»¬åšäº†ä¸ªç¨å¾®å¤§ä¸€äº›çš„é‡æ„ï¼Œä¸ºå·²æœ‰çš„ä»£ç æä¾›æ›´åŠ ç¬¦åˆå¼‚æ­¥ IO æ¥å£çš„åŠŸèƒ½ã€‚ä»å¯¹å¤–ä½¿ç”¨çš„è§’åº¦æ¥è¯´ï¼Œå®ƒå¹¶æ²¡æœ‰æä¾›æˆ–è€…æ»¡è¶³ä»»ä½•é¢å¤–çš„éœ€æ±‚ï¼Œä½†æ˜¯ä»ä»£ç ç»“æ„å’Œè´¨é‡çš„è§’åº¦ï¼Œå®ƒä½¿å¾—æˆ‘ä»¬çš„ ProstStream å¯ä»¥æ›´æ–¹ä¾¿å’Œæ›´ç›´è§‚åœ°è¢«å…¶å®ƒæ¥å£è°ƒç”¨ï¼Œä¹Ÿæ›´å®¹æ˜“è·Ÿæ•´ä¸ª Rust çš„ç°æœ‰ç”Ÿæ€ç»“åˆèµ·æ¥ã€‚</p><p>ä½ å¯èƒ½ä¼šå¥½å¥‡ï¼Œä¸ºä»€ä¹ˆå¯ä»¥è¿™ä¹ˆè‡ªç„¶åœ°è¿›è¡Œä»£ç é‡æ„ï¼Ÿè¿™æ˜¯å› ä¸ºæˆ‘ä»¬æœ‰è¶³å¤Ÿçš„å•å…ƒæµ‹è¯•è¦†ç›–æ¥æ‰“åº•ã€‚</p><p>å°±åƒç”Ÿç‰©çš„è¿›åŒ–ä¸€æ ·ï¼Œå¥½çš„ä»£ç æ˜¯åœ¨è‰¯æ€§çš„é‡æ„ä¸­ä¸æ–­æ¼”è¿›å‡ºæ¥çš„ï¼Œ<strong>è€Œè‰¯æ€§çš„é‡æ„ï¼Œæ˜¯åœ¨ä¼˜ç§€çš„å•å…ƒæµ‹è¯•çš„ç›‘ç®¡ä¸‹ï¼Œä½¿ä»£ç æœç€æ­£ç¡®æ–¹å‘è¿ˆå‡ºçš„æ­¥ä¼</strong>ã€‚åœ¨è¿™é‡Œï¼Œå•å…ƒæµ‹è¯•æ‰®æ¼”ç€ç”Ÿç‰©è¿›åŒ–ä¸­è‡ªç„¶ç¯å¢ƒçš„è§’è‰²ï¼ŒæŠŠé‡æ„è¿‡ç¨‹ä¸­çš„é”™è¯¯ä¸€ä¸€æ‰¼æ€ã€‚</p><h3>æ€è€ƒé¢˜</h3><ol>\n<li>ä¸ºä»€ä¹ˆåœ¨åˆ›å»º ProstStream æ—¶ï¼Œè¦åœ¨æ•°æ®ç»“æ„ä¸­æ”¾ wbuf / rbuf å’Œ written å­—æ®µï¼Ÿä¸ºä»€ä¹ˆä¸èƒ½ç”¨å±€éƒ¨å˜é‡ï¼Ÿ</li>\n<li>ä»”ç»†é˜…è¯» <a href=\"https://docs.rs/futures/0.3.17/futures/prelude/trait.Stream.html\">Stream</a> å’Œ <a href=\"https://docs.rs/futures/0.3.17/futures/prelude/trait.Sink.html#\">Sink</a> çš„æ–‡æ¡£ã€‚å°è¯•å†™ä»£ç æ„é€ å®ç° Stream å’Œ Sink çš„ç®€å•æ•°æ®ç»“æ„ã€‚</li>\n</ol><p>æ¬¢è¿åœ¨ç•™è¨€åŒºåˆ†äº«ä½ çš„æ€è€ƒå’Œå­¦ä¹ æ”¶è·ï¼Œæ„Ÿè°¢ä½ çš„æ”¶å¬ï¼Œä½ å·²ç»å®Œæˆäº†Rustå­¦ä¹ çš„ç¬¬41æ¬¡æ‰“å¡å•¦ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ã€‚</p>","neighbors":{"left":{"article_title":"40ï½œå¼‚æ­¥å¤„ç†ï¼šå¦‚ä½•å¤„ç†å¼‚æ­¥IOï¼Ÿ","id":461695},"right":{"article_title":"42ï½œé˜¶æ®µå®æ“ï¼ˆ7ï¼‰ï¼šæ„å»ºä¸€ä¸ªç®€å•çš„KV server-å¦‚ä½•åšå¤§çš„é‡æ„ï¼Ÿ","id":461999}},"comments":[{"had_liked":false,"id":324528,"user_name":"ç½—æ°","can_delete":false,"product_type":"c1","uid":1320487,"ip_address":"","ucode":"96BAFAA147341F","user_header":"https://static001.geekbang.org/account/avatar/00/14/26/27/eba94899.jpg","comment_is_top":false,"comment_ctime":1638492913,"is_pvip":false,"replies":[{"id":"118865","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1079375","ctime":1639848684,"ip_address":"","comment_id":324528,"utype":1}],"discussion_count":1,"race_medal":2,"score":"10228427505","product_id":100085301,"comment_content":"å‰ä¸¤èŠ‚æ„Ÿè§‰ç†è§£æœ‰äº›åƒåŠ›äº†ï¼Œä»Šå¤©çš„å®æ“çªç„¶åˆè®©æˆ‘è§‰å¾—å¥½åƒä¹Ÿæ²¡é‚£ä¹ˆéš¾äº†ã€‚è€å¸ˆå®æ“é˜¶æ®µçš„ä»£ç çœŸæ˜¯èµå¿ƒæ‚¦ç›®ã€‚æˆ‘è¦åŠ¨æ‰‹å¥½å¥½ç†è§£ä¸€ä¸‹ã€‚","like_count":3,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539825,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639848684,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":336042,"user_name":"å•¦å•¦å•¦å•¦å•¦å•¦å•¦","can_delete":false,"product_type":"c1","uid":1470066,"ip_address":"","ucode":"220DC1DF76454F","user_header":"https://static001.geekbang.org/account/avatar/00/16/6e/72/f8e5b97e.jpg","comment_is_top":false,"comment_ctime":1645863580,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1645863580","product_id":100085301,"comment_content":"ä¸ºæ–¹ä¾¿åœ¨ sink å’Œ stream ä¸­å¯¹ stream æ“ä½œï¼Ÿå› ä¸ºæ˜¯å¼‚æ­¥ç¯å¢ƒä¸­ä½¿ç”¨ï¼Œä½¿ç”¨å±€éƒ¨å˜é‡æ—¶ä¼šä¸¢å¤±æ•°æ®å§","like_count":0},{"had_liked":false,"id":331198,"user_name":"Geek_64affe","can_delete":false,"product_type":"c1","uid":2415213,"ip_address":"","ucode":"17F255ACC29717","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epWuRmpg9jWibtRH3mO9I0Sc9Y86fJpiaJDdLia39eib89R1raTkxMg9AOkjb0OTRkmXiaialJgHC5ve59g/132","comment_is_top":false,"comment_ctime":1642481777,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1642481777","product_id":100085301,"comment_content":"å°è¯•å›ç­”ç¬¬ä¸€ä¸ªé—®é¢˜ï¼šå› ä¸ºå½“pollè¿”å›çš„æ˜¯Pendingï¼Œä¼šç›´æ¥è¿”å›å‡ºå»ï¼Œå¦‚æœä½¿ç”¨å±€éƒ¨å˜é‡ï¼Œæ¯æ¬¡è¿›åˆ°pollé‡Œé¢éƒ½ä¼šè¢«é‡ç½®ï¼Œå¯¼è‡´é€»è¾‘é”™è¯¯","like_count":0,"discussions":[{"author":{"id":2415213,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epWuRmpg9jWibtRH3mO9I0Sc9Y86fJpiaJDdLia39eib89R1raTkxMg9AOkjb0OTRkmXiaialJgHC5ve59g/132","nickname":"Geek_64affe","note":"","ucode":"17F255ACC29717","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":571221,"discussion_content":"è¡¥å……ä¸€ä¸‹ï¼Œè¿™é‡Œçš„pollæŒ‡çš„æ˜¯stream.poll_writeï¼ˆä»£ç ç¬¬6è¡Œï¼‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1652145293,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":324526,"user_name":"ç½—åŒå­¦","can_delete":false,"product_type":"c1","uid":1649119,"ip_address":"","ucode":"909B9EC768B9AD","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/vHujib2CCrUYNBaia32eIwTyJoAcl27vASZ9KGjSdnH1dJhD7CrSUicBib19Tf8nDibWaHjzIsvIfdqcXX6vGrH8bicw/132","comment_is_top":false,"comment_ctime":1638492562,"is_pvip":false,"replies":[{"id":"118866","content":"å¯¹äºè¿™ä¸ªç‰¹å®šçš„ä¾‹å­ï¼Œä¸ä¼šæœ‰æ˜¾è‘—æå‡ï¼Œå› ä¸ºä¹‹å‰ä¹Ÿå·²ç»æ˜¯å¼‚æ­¥å¤„ç†ï¼Œåªæ˜¯æ¥å£å¹¶æ²¡æœ‰å…¼å®¹ stream&#47;sinkã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1079375","ctime":1639848789,"ip_address":"","comment_id":324526,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1638492562","product_id":100085301,"comment_content":"åˆ©ç”¨å¼‚æ­¥io é‡æ„å process ,æ€§èƒ½ä¼šä¸ä¼šæœ‰ä¸€å®šæå‡å‘¢?","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539826,"discussion_content":"å¯¹äºè¿™ä¸ªç‰¹å®šçš„ä¾‹å­ï¼Œä¸ä¼šæœ‰æ˜¾è‘—æå‡ï¼Œå› ä¸ºä¹‹å‰ä¹Ÿå·²ç»æ˜¯å¼‚æ­¥å¤„ç†ï¼Œåªæ˜¯æ¥å£å¹¶æ²¡æœ‰å…¼å®¹ stream/sinkã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639848789,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1462209,"avatar":"https://static001.geekbang.org/account/avatar/00/16/4f/c1/7f596aba.jpg","nickname":"ç»™æˆ‘ç‚¹é˜³å…‰å°±ç¿çƒ‚","note":"","ucode":"F3B0439BE0D062","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":536386,"discussion_content":"è¿™æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„è¯¯åŒºï¼Œå°±æ˜¯ç”¨äº†å¼‚æ­¥ä¸€å®šæ¯”åŒæ­¥å¿«ï¼Œå®é™…ä¸Šä¸æ˜¯çš„ã€‚å¼‚æ­¥ç›¸æ¯”äºåŒæ­¥çš„å¹¶å‘ï¼Œå¼‚æ­¥å¹¶å‘æ‹¥æœ‰æ›´å¤§çš„çº¿ç¨‹æ± ï¼Œè™½ç„¶æ˜¯ç»¿è‰²çº¿ç¨‹ï¼Œä½†è°ƒåº¦èµ·æ¥æ¯ä¸ªç»¿è‰²çº¿ç¨‹åˆ†é…åˆ°çš„è¿è¡Œæ—¶é—´ä¹Ÿä¼šå‡å°‘ï¼Œæ‰€ä»¥å¼‚æ­¥é€‚åˆç”¨äºwebï¼Œä½†æ˜¯åˆ°äº†éœ€è¦è¿›è¡ŒCPU-bound çš„è®¡ç®—æ—¶ï¼Œæ¯”å¦‚kb mbçº§åŠä»¥ä¸Šçš„æ•°æ®å‹ç¼©ï¼Œæ•°æ®åŠ å¯†æ—¶ï¼Œä½¿ç”¨å¼‚æ­¥çº¿ç¨‹åè€Œä¼šè®©ç¨‹åºå˜æ…¢ï¼Œè¿™ç±»åœºæ™¯è¿˜æ˜¯è¦ç»§ç»­ä½¿ç”¨åŒæ­¥çš„éç»¿è‰²çº¿ç¨‹ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆrustç¼–å†™çš„ å­˜å‚¨å¼•æ“æ²¡æœ‰ç”¨å¼‚æ­¥çš„åŸå› ã€‚æ‰€ä»¥å¼‚æ­¥å¹¶å‘ä¸æ˜¯ä¸ºäº†å–ä»£åŒæ­¥çš„çº¿ç¨‹ï¼Œè€Œæ˜¯è®©å¤§å®¶æœ‰äº†æ›´å¤šçš„é€‰æ‹©ï¼Œä¸åƒgoä¸€æ ·åªèƒ½å¯ç”¨ç»¿è‰²çº¿ç¨‹ï¼ŒæŒ‰åœºæ™¯è¿›è¡Œåˆé€‚çš„åŒæ­¥å¼‚æ­¥ç»“åˆï¼Œæ¥è¾¾åˆ°æ›´å¥½çš„æ€§èƒ½","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1638775874,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}