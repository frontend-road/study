{"id":323325,"title":"16 | å®¹å™¨ç½‘ç»œé…ç½®ï¼ˆ1ï¼‰ï¼šå®¹å™¨ç½‘ç»œä¸é€šäº†è¦æ€ä¹ˆè°ƒè¯•?","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯ç¨‹è¿œã€‚</p><p>åœ¨ä¸Šä¸€è®²ï¼Œæˆ‘ä»¬è®²äº†Network Namespaceéš”ç¦»äº†ç½‘ç»œè®¾å¤‡ï¼ŒIPåè®®æ ˆå’Œè·¯ç”±è¡¨ï¼Œä»¥åŠé˜²ç«å¢™è§„åˆ™ï¼Œé‚£å®¹å™¨Network Namespaceé‡Œçš„å‚æ•°æ€ä¹ˆå»é…ç½®ï¼Œæˆ‘ä»¬ç°åœ¨å·²ç»å¾ˆæ¸…æ¥šäº†ã€‚</p><p>å…¶å®å¯¹äºç½‘ç»œé…ç½®çš„é—®é¢˜ï¼Œæˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ªæœ€éœ€è¦å…³å¿ƒçš„å†…å®¹ï¼Œé‚£å°±æ˜¯å®¹å™¨å’Œå¤–é¢çš„å®¹å™¨æˆ–è€…èŠ‚ç‚¹æ˜¯æ€ä¹ˆé€šè®¯çš„ï¼Œè¿™å°±æ¶‰åŠåˆ°äº†å®¹å™¨ç½‘ç»œæ¥å£é…ç½®çš„é—®é¢˜äº†ã€‚</p><p>æ‰€ä»¥è¿™ä¸€è®²å‘¢ï¼Œæˆ‘ä»¬å°±æ¥èŠä¸€èŠï¼Œå®¹å™¨Network Namespaceé‡Œå¦‚ä½•é…ç½®ç½‘ç»œæ¥å£ï¼Œè¿˜æœ‰å½“å®¹å™¨ç½‘ç»œä¸é€šçš„æ—¶å€™ï¼Œæˆ‘ä»¬åº”è¯¥æ€ä¹ˆå»åšä¸€ä¸ªç®€å•è°ƒè¯•ã€‚</p><h2>é—®é¢˜å†ç°</h2><p>åœ¨å‰é¢çš„è¯¾ç¨‹é‡Œï¼Œæˆ‘ä»¬ä¸€ç›´æ˜¯ç”¨ <code>docker run</code> è¿™ä¸ªå‘½ä»¤æ¥å¯åŠ¨å®¹å™¨çš„ã€‚å®¹å™¨å¯åŠ¨äº†ä¹‹åï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œåœ¨å®¹å™¨é‡Œé¢æœ‰ä¸€ä¸ª\"eth0\"çš„ç½‘ç»œæ¥å£ï¼Œæ¥å£ä¸Šä¹Ÿé…ç½®äº†ä¸€ä¸ªIPåœ°å€ã€‚</p><p>ä¸è¿‡å‘¢ï¼Œå¦‚æœæˆ‘ä»¬æƒ³ä»å®¹å™¨é‡Œè®¿é—®å¤–é¢çš„ä¸€ä¸ªIPåœ°å€ï¼Œæ¯”å¦‚è¯´39.106.233.176ï¼ˆè¿™ä¸ªæ˜¯æå®¢æ—¶é—´ç½‘å€å¯¹åº”çš„IPï¼‰ï¼Œç»“æœå°±å‘ç°æ˜¯ä¸èƒ½pingé€šçš„ã€‚</p><p>è¿™æ—¶æˆ‘ä»¬å¯èƒ½ä¼šæƒ³åˆ°ï¼Œåˆ°åº•æ˜¯ä¸æ˜¯å®¹å™¨å†…å‡ºäº†é—®é¢˜ï¼Œåœ¨å®¹å™¨é‡Œæ— æ³•è®¿é—®ï¼Œä¼šä¸ä¼šå®¿ä¸»æœºä¹Ÿä¸€æ ·ä¸è¡Œå‘¢ï¼Ÿ</p><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦éªŒè¯ä¸€ä¸‹ï¼Œé¦–å…ˆæˆ‘ä»¬é€€å‡ºå®¹å™¨ï¼Œç„¶ååœ¨å®¿ä¸»æœºçš„Network Namespaceä¸‹ï¼Œå†è¿è¡Œ <code>ping 39.106.233.176</code>ï¼Œç»“æœå°±ä¼šå‘ç°åœ¨å®¿ä¸»æœºä¸Šï¼Œå´æ˜¯å¯ä»¥è¿é€šè¿™ä¸ªåœ°å€çš„ã€‚</p><!-- [[[read_end]]] --><pre><code class=\"language-shell\"># docker run -d --name if-test centos:8.1.1911 sleep 36000\n244d44f94dc2931626194c6fd3f99cec7b7c4bf61aafc6c702551e2c5ca2a371\n# docker exec -it if-test bash\n \n[root@244d44f94dc2 /]# ip addr\n1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n808: eth0@if809: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default\n    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff link-netnsid 0\n    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0\n       valid_lft forever preferred_lft forever\n \n[root@244d44f94dc2 /]# ping 39.106.233.176       ### å®¹å™¨ä¸­æ— æ³•pingé€š\nPING 39.106.233.176 (39.106.233.176) 56(84) bytes of data.\n^C\n--- 39.106.233.176 ping statistics ---\n9 packets transmitted, 0 received, 100% packet loss, time 185ms\n \n[root@244d44f94dc2 /]# exit             ###é€€å‡ºå®¹å™¨\nexit\n \n# ping 39.106.233.176                        ### å®¿ä¸»æœºä¸Šå¯ä»¥pingé€š\nPING 39.106.233.176 (39.106.233.176) 56(84) bytes of data.\n64 bytes from 39.106.233.176: icmp_seq=1 ttl=78 time=296 ms\n64 bytes from 39.106.233.176: icmp_seq=2 ttl=78 time=306 ms\n64 bytes from 39.106.233.176: icmp_seq=3 ttl=78 time=303 ms\n^C\n--- 39.106.233.176 ping statistics ---\n4 packets transmitted, 3 received, 25% packet loss, time 7ms\nrtt min/avg/max/mdev = 296.059/301.449/305.580/4.037 ms\n</code></pre><p>é‚£ä¹ˆç¢°åˆ°è¿™ç§å®¹å™¨å†…ç½‘ç»œä¸é€šçš„é—®é¢˜ï¼Œæˆ‘ä»¬åº”è¯¥æ€ä¹ˆåˆ†æè°ƒè¯•å‘¢ï¼Ÿæˆ‘ä»¬è¿˜æ˜¯éœ€è¦å…ˆæ¥ç†è§£ä¸€ä¸‹ï¼Œå®¹å™¨Network Namespaceé‡Œçš„ç½‘ç»œæ¥å£æ˜¯æ€ä¹ˆé…ç½®çš„ã€‚</p><h2>åŸºæœ¬æ¦‚å¿µ</h2><p>åœ¨è®²è§£å®¹å™¨çš„ç½‘ç»œæ¥å£é…ç½®ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå»ºç«‹ä¸€ä¸ªæ•´ä½“çš„è®¤è¯†ï¼Œææ¸…æ¥šå®¹å™¨ç½‘ç»œæ¥å£åœ¨ç³»ç»Ÿæ¶æ„ä¸­å¤„äºå“ªä¸ªä½ç½®ã€‚</p><p>ä½ å¯ä»¥çœ‹ä¸€ä¸‹æˆ‘ç»™ä½ ç”»çš„è¿™å¼ å›¾ï¼Œå›¾é‡Œå±•ç¤ºçš„æ˜¯å®¹å™¨æœ‰è‡ªå·±çš„Network Namespaceï¼Œeth0 æ˜¯è¿™ä¸ªNetwork Namespaceé‡Œçš„ç½‘ç»œæ¥å£ã€‚è€Œå®¿ä¸»æœºä¸Šä¹Ÿæœ‰è‡ªå·±çš„eth0ï¼Œå®¿ä¸»æœºä¸Šçš„eth0å¯¹åº”ç€çœŸæ­£çš„ç‰©ç†ç½‘å¡ï¼Œå¯ä»¥å’Œå¤–é¢é€šè®¯ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/68/98/6848619c9d4db810560fe1a712fb2d98.jpeg?wh=1920*1408\" alt=\"\"></p><p>é‚£ä½ å¯ä»¥å…ˆæƒ³æƒ³ï¼Œæˆ‘ä»¬è¦è®©å®¹å™¨Network Namespaceä¸­çš„æ•°æ®åŒ…æœ€ç»ˆå‘é€åˆ°ç‰©ç†ç½‘å¡ä¸Šï¼Œéœ€è¦å®Œæˆå“ªäº›æ­¥éª¤å‘¢ï¼Ÿä»å›¾ä¸Šçœ‹ï¼Œæˆ‘ä»¬å¤§è‡´å¯ä»¥çŸ¥é“åº”è¯¥åŒ…æ‹¬è¿™ä¸¤æ­¥ã€‚</p><p><strong>ç¬¬ä¸€æ­¥ï¼Œå°±æ˜¯è¦è®©æ•°æ®åŒ…ä»å®¹å™¨çš„Network Namespaceå‘é€åˆ°Host Network Namespaceä¸Šã€‚</strong></p><p><strong>ç¬¬äºŒæ­¥ï¼Œæ•°æ®åŒ…å‘åˆ°äº†Host Network Namespaceä¹‹åï¼Œè¿˜è¦è§£å†³æ•°æ®åŒ…æ€ä¹ˆä»å®¿ä¸»æœºä¸Šçš„eth0å‘é€å‡ºå»çš„é—®é¢˜ã€‚</strong></p><p>å¥½ï¼Œæ•´ä½“çš„æ€è·¯å·²ç»ç†æ¸…æ¥šäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬åšå…·ä½“åˆ†æã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ç¬¬ä¸€æ­¥ï¼Œæ€ä¹ˆè®©æ•°æ®åŒ…ä»å®¹å™¨çš„Network Namespaceå‘é€åˆ°Host Network Namespaceä¸Šé¢ã€‚</p><p>ä½ å¯ä»¥æŸ¥çœ‹ä¸€ä¸‹<a href=\"https://docs.docker.com/network/\">Docker ç½‘ç»œçš„æ–‡æ¡£</a>æˆ–è€…<a href=\"https://kubernetes.io/docs/concepts/cluster-administration/networking/\">Kubernetesç½‘ç»œçš„æ–‡æ¡£</a>ï¼Œè¿™äº›æ–‡æ¡£é‡Œé¢ä»‹ç»äº†å¾ˆå¤šç§å®¹å™¨ç½‘ç»œé…ç½®çš„æ–¹å¼ã€‚</p><p>ä¸è¿‡å¯¹äºå®¹å™¨ä»è‡ªå·±çš„Network Namespaceè¿æ¥åˆ°Host Network Namespaceçš„æ–¹æ³•ï¼Œä¸€èˆ¬æ¥è¯´å°±åªæœ‰ä¸¤ç±»è®¾å¤‡æ¥å£ï¼šä¸€ç±»æ˜¯<a href=\"https://man7.org/linux/man-pages/man4/veth.4.html\">veth</a>ï¼Œå¦å¤–ä¸€ç±»æ˜¯macvlan/ipvlanã€‚</p><p>åœ¨è¿™äº›æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨æœ€å¤šçš„å°±æ˜¯vethçš„æ–¹å¼ï¼Œç”¨Dockerå¯åŠ¨çš„å®¹å™¨ç¼ºçœçš„ç½‘ç»œæ¥å£ç”¨çš„ä¹Ÿæ˜¯è¿™ä¸ªvethã€‚æ—¢ç„¶å®ƒè¿™ä¹ˆå¸¸è§ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±ç”¨vethä½œä¸ºä¾‹å­æ¥è¯¦ç»†è®²è§£ã€‚è‡³äºå¦å¤–ä¸€ç±»macvlan/ipvlançš„æ–¹å¼ï¼Œæˆ‘ä»¬åœ¨ä¸‹ä¸€è®²é‡Œä¼šè®²åˆ°ã€‚</p><p>é‚£ä»€ä¹ˆæ˜¯vethå‘¢ï¼Ÿä¸ºäº†æ–¹ä¾¿ä½ æ›´å¥½åœ°ç†è§£ï¼Œæˆ‘ä»¬å…ˆæ¥æ¨¡æ‹Ÿä¸€ä¸‹Dockerä¸ºå®¹å™¨å»ºç«‹eth0ç½‘ç»œæ¥å£çš„è¿‡ç¨‹ï¼ŒåŠ¨æ‰‹æ“ä½œä¸€ä¸‹ï¼Œè¿™æ ·å‘¢ï¼Œä½ å°±å¯ä»¥å¾ˆå¿«æ˜ç™½ä»€ä¹ˆæ˜¯vethäº†ã€‚</p><p>å¯¹äºè¿™ä¸ªæ¨¡æ‹Ÿæ“ä½œå‘¢ï¼Œæˆ‘ä»¬ä¸»è¦ç”¨åˆ°çš„æ˜¯<a href=\"https://man7.org/linux/man-pages/man8/ip-netns.8.html\">ip netns</a> è¿™ä¸ªå‘½ä»¤ï¼Œé€šè¿‡å®ƒæ¥å¯¹Network Namespaceåšæ“ä½œã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆå¯åŠ¨ä¸€ä¸ªä¸å¸¦ç½‘ç»œé…ç½®çš„å®¹å™¨ï¼Œå’Œæˆ‘ä»¬ä¹‹å‰çš„å‘½ä»¤æ¯”è¾ƒï¼Œä¸»è¦æ˜¯å¤šåŠ ä¸Šäº†\"--network none\"å‚æ•°ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™æ ·åœ¨å¯åŠ¨çš„å®¹å™¨ä¸­ï¼ŒNetwork Namespaceé‡Œå°±åªæœ‰loopbackä¸€ä¸ªç½‘ç»œè®¾å¤‡ï¼Œè€Œæ²¡æœ‰äº†eth0ç½‘ç»œè®¾å¤‡äº†ã€‚</p><pre><code class=\"language-shell\"># docker run -d --name if-test --network none centos:8.1.1911 sleep 36000\ncf3d3105b11512658a025f5b401a09c888ed3495205f31e0a0d78a2036729472\n# docker exec -it if-test ip addr\n1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n</code></pre><p>å®Œæˆåˆšæ‰çš„è®¾ç½®ä»¥åï¼Œæˆ‘ä»¬å°±åœ¨è¿™ä¸ªå®¹å™¨çš„Network Namespaceé‡Œå»ºç«‹vethï¼Œä½ å¯ä»¥æ‰§è¡Œä¸€ä¸‹åé¢çš„è¿™ä¸ªè„šæœ¬ã€‚</p><pre><code class=\"language-shell\">pid=$(ps -ef | grep \"sleep 36000\" | grep -v grep | awk '{print $2}')\necho $pid\nln -s /proc/$pid/ns/net /var/run/netns/$pid\n \n# Create a pair of veth interfaces\nip link add name veth_host type veth peer name veth_container\n# Put one of them in the new net ns\nip link set veth_container netns $pid\n \n# In the container, setup veth_container\nip netns exec $pid ip link set veth_container name eth0\nip netns exec $pid ip addr add 172.17.1.2/16 dev eth0\nip netns exec $pid ip link set eth0 up\nip netns exec $pid ip route add default via 172.17.0.1\n \n# In the host, set veth_host up\nip link set veth_host up\n</code></pre><p>æˆ‘åœ¨è¿™é‡Œè§£é‡Šä¸€ä¸‹ï¼Œè¿™ä¸ªvethçš„å»ºç«‹è¿‡ç¨‹æ˜¯ä»€ä¹ˆæ ·çš„ã€‚</p><p>é¦–å…ˆå‘¢ï¼Œæˆ‘ä»¬å…ˆæ‰¾åˆ°è¿™ä¸ªå®¹å™¨é‡Œè¿è¡Œçš„è¿›ç¨‹\"sleep 36000\"çš„pidï¼Œé€šè¿‡ \"/proc/$pid/ns/net\"è¿™ä¸ªæ–‡ä»¶å¾—åˆ°Network Namespaceçš„IDï¼Œè¿™ä¸ªNetwork Namespace IDæ—¢æ˜¯è¿™ä¸ªè¿›ç¨‹çš„ï¼Œä¹ŸåŒæ—¶å±äºè¿™ä¸ªå®¹å™¨ã€‚</p><p>ç„¶åæˆ‘ä»¬åœ¨\"/var/run/netns/\"çš„ç›®å½•ä¸‹å»ºç«‹ä¸€ä¸ªç¬¦å·é“¾æ¥ï¼ŒæŒ‡å‘è¿™ä¸ªå®¹å™¨çš„Network Namespaceã€‚å®Œæˆè¿™æ­¥æ“ä½œä¹‹åï¼Œåœ¨åé¢çš„\"ip netns\"æ“ä½œé‡Œï¼Œå°±å¯ä»¥ç”¨pidçš„å€¼ä½œä¸ºè¿™ä¸ªå®¹å™¨çš„Network Namesapceçš„æ ‡è¯†äº†ã€‚</p><p>æ¥ä¸‹æ¥å‘¢ï¼Œæˆ‘ä»¬ç”¨ <code>ip link</code> å‘½ä»¤æ¥å»ºç«‹ä¸€å¯¹vethçš„è™šæ‹Ÿè®¾å¤‡æ¥å£ï¼Œåˆ†åˆ«æ˜¯veth_containerå’Œveth_hostã€‚ä»åå­—å°±å¯ä»¥çœ‹å‡ºæ¥ï¼Œveth_containerè¿™ä¸ªæ¥å£ä¼šè¢«æ”¾åœ¨å®¹å™¨Network Namespaceé‡Œï¼Œè€Œveth_hostä¼šæ”¾åœ¨å®¿ä¸»æœºçš„Host Network Namespaceã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬åé¢çš„å‘½ä»¤ä¹Ÿå¾ˆå¥½ç†è§£äº†ï¼Œå°±æ˜¯ç”¨ <code>ip link set veth_container netns $pid</code> æŠŠveth_containerè¿™ä¸ªæ¥å£æ”¾å…¥åˆ°å®¹å™¨çš„Network Namespaceä¸­ã€‚</p><p>å†ç„¶åæˆ‘ä»¬è¦æŠŠveth_containeré‡æ–°å‘½åä¸ºeth0ï¼Œå› ä¸ºè¿™æ—¶å€™æ¥å£å·²ç»åœ¨å®¹å™¨çš„Network Namesapceé‡Œäº†ï¼Œeth0å°±ä¸ä¼šå’Œå®¿ä¸»æœºä¸Šçš„eth0å†²çªäº†ã€‚</p><p>æœ€åå¯¹å®¹å™¨å†…çš„eht0ï¼Œæˆ‘ä»¬è¿˜è¦åšåŸºæœ¬çš„ç½‘ç»œIPå’Œç¼ºçœè·¯ç”±é…ç½®ã€‚å› ä¸ºveth_hostå·²ç»åœ¨å®¿ä¸»æœºçš„Host Network Namespaceäº†ï¼Œå°±ä¸éœ€è¦æˆ‘ä»¬åšä»€ä¹ˆäº†ï¼Œè¿™æ—¶æˆ‘ä»¬åªéœ€è¦upä¸€ä¸‹è¿™ä¸ªæ¥å£å°±å¯ä»¥äº†ã€‚</p><p>é‚£åˆšæ‰è¿™äº›æ“ä½œå®Œæˆä»¥åï¼Œæˆ‘ä»¬å°±å»ºç«‹äº†ä¸€å¯¹vethè™šæ‹Ÿè®¾å¤‡æ¥å£ã€‚æˆ‘ç»™ä½ ç”»äº†ä¸€å¼ ç¤ºæ„å›¾ï¼Œå›¾é‡Œç›´è§‚å±•ç¤ºäº†è¿™å¯¹æ¥å£åœ¨å®¹å™¨å’Œå®¿ä¸»æœºä¸Šçš„ä½ç½®ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/56/89/569287c365c99d3778858b7bc42b5989.jpeg?wh=1920*1339\" alt=\"\"></p><p>ç°åœ¨ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹vethçš„å®šä¹‰äº†ï¼Œå…¶å®å®ƒä¹Ÿå¾ˆç®€å•ã€‚vethå°±æ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„ç½‘ç»œè®¾å¤‡ï¼Œä¸€èˆ¬éƒ½æ˜¯æˆå¯¹åˆ›å»ºï¼Œè€Œä¸”è¿™å¯¹è®¾å¤‡æ˜¯ç›¸äº’è¿æ¥çš„ã€‚å½“æ¯ä¸ªè®¾å¤‡åœ¨ä¸åŒçš„Network Namespacesçš„æ—¶å€™ï¼ŒNamespaceä¹‹é—´å°±å¯ä»¥ç”¨è¿™å¯¹vethè®¾å¤‡æ¥è¿›è¡Œç½‘ç»œé€šè®¯äº†ã€‚</p><p>æ¯”å¦‚è¯´ï¼Œä½ å¯ä»¥æ‰§è¡Œä¸‹é¢çš„è¿™æ®µä»£ç ï¼Œè¯•è¯•åœ¨veth_hostä¸ŠåŠ ä¸Šä¸€ä¸ªIPï¼Œ172.17.1.1/16ï¼Œç„¶åä»å®¹å™¨é‡Œå°±å¯ä»¥pingé€šè¿™ä¸ªIPäº†ã€‚è¿™ä¹Ÿè¯æ˜äº†ä»å®¹å™¨åˆ°å®¿ä¸»æœºå¯ä»¥åˆ©ç”¨è¿™å¯¹vethæ¥å£æ¥é€šè®¯äº†ã€‚</p><pre><code class=\"language-shell\"># ip addr add 172.17.1.1/16 dev veth_host\n# docker exec -it if-test ping 172.17.1.1\nPING 172.17.1.1 (172.17.1.1) 56(84) bytes of data.\n64 bytes from 172.17.1.1: icmp_seq=1 ttl=64 time=0.073 ms\n64 bytes from 172.17.1.1: icmp_seq=2 ttl=64 time=0.092 ms\n^C\n--- 172.17.1.1 ping statistics ---\n2 packets transmitted, 2 received, 0% packet loss, time 30ms\nrtt min/avg/max/mdev = 0.073/0.082/0.092/0.013 ms\n</code></pre><p>å¥½äº†ï¼Œè¿™æ ·æˆ‘ä»¬å®Œæˆäº†ç¬¬ä¸€æ­¥ï¼Œé€šè¿‡ä¸€å¯¹vethè™šæ‹Ÿè®¾å¤‡ï¼Œå¯ä»¥è®©æ•°æ®åŒ…ä»å®¹å™¨çš„ Network Namespaceå‘é€åˆ°Host Network Namespaceä¸Šã€‚</p><p>é‚£ä¸‹é¢æˆ‘ä»¬å†æ¥çœ‹ç¬¬äºŒæ­¥ï¼Œ æ•°æ®åŒ…åˆ°äº†Host Network Namespaceä¹‹åå‘¢ï¼Œæ€ä¹ˆæŠŠå®ƒä»å®¿ä¸»æœºä¸Šçš„eth0å‘é€å‡ºå»?</p><p>å…¶å®è¿™ä¸€æ­¥å‘¢ï¼Œå°±æ˜¯ä¸€ä¸ªæ™®é€šLinuxèŠ‚ç‚¹ä¸Šæ•°æ®åŒ…è½¬å‘çš„é—®é¢˜äº†ã€‚è¿™é‡Œæˆ‘ä»¬è§£å†³é—®é¢˜çš„æ–¹æ³•æœ‰å¾ˆå¤šç§ï¼Œæ¯”å¦‚è¯´ç”¨natæ¥åšä¸ªè½¬å‘ï¼Œæˆ–è€…å»ºç«‹Overlayç½‘ç»œå‘é€ï¼Œä¹Ÿå¯ä»¥é€šè¿‡é…ç½®proxy arpåŠ è·¯ç”±çš„æ–¹æ³•æ¥å®ç°ã€‚</p><p>å› ä¸ºè€ƒè™‘åˆ°ç½‘ç»œç¯å¢ƒçš„é…ç½®ï¼ŒåŒæ—¶Dockerç¼ºçœä½¿ç”¨çš„æ˜¯ <strong>bridge + nat</strong>çš„è½¬å‘æ–¹å¼ï¼Œ é‚£æˆ‘ä»¬å°±åœ¨åˆšæ‰è®²çš„ç¬¬ä¸€æ­¥åŸºç¡€ä¸Šï¼Œå†æ‰‹åŠ¨å®ç°ä¸€ä¸‹bridge+natçš„è½¬å‘æ–¹å¼ã€‚å¯¹äºå…¶ä»–çš„é…ç½®æ–¹æ³•ï¼Œä½ å¯ä»¥çœ‹ä¸€ä¸‹Dockeræˆ–è€…Kubernetesç›¸å…³çš„æ–‡æ¡£ã€‚</p><p>Dockerç¨‹åºåœ¨èŠ‚ç‚¹ä¸Šå®‰è£…å®Œä¹‹åï¼Œå°±ä¼šè‡ªåŠ¨å»ºç«‹äº†ä¸€ä¸ªdocker0çš„bridge interfaceã€‚æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦æŠŠç¬¬ä¸€æ­¥ä¸­å»ºç«‹çš„veth_hostè¿™ä¸ªè®¾å¤‡ï¼Œæ¥å…¥åˆ°docker0è¿™ä¸ªbridgeä¸Šã€‚</p><p>è¿™é‡Œæˆ‘è¦æé†’ä½ æ³¨æ„ä¸€ä¸‹ï¼Œå¦‚æœä¹‹å‰ä½ åœ¨veth_hostä¸Šè®¾ç½®äº†IPçš„ï¼Œå°±éœ€å…ˆè¿è¡Œä¸€ä¸‹\"ip addr delete 172.17.1.1/16 dev veth_host\"ï¼ŒæŠŠIPä»veth_hostä¸Šåˆ é™¤ã€‚</p><pre><code># ip addr delete 172.17.1.1/16 dev veth_host \nip link set veth_host master docker0\n</code></pre><p>è¿™ä¸ªå‘½ä»¤æ‰§è¡Œå®Œä¹‹åï¼Œå®¹å™¨å’Œå®¿ä¸»æœºçš„ç½‘ç»œé…ç½®å°±ä¼šå‘ç”Ÿå˜åŒ–ï¼Œè¿™ç§é…ç½®æ˜¯ä»€ä¹ˆæ ·å‘¢ï¼Ÿä½ å¯ä»¥å‚è€ƒä¸€ä¸‹é¢è¿™å¼ å›¾çš„æè¿°ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/a0/69/a006f0707d02d38917983523c9356869.jpeg?wh=1920*1331\" alt=\"\"></p><p>ä»è¿™å¼ ç¤ºæ„å›¾ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ¥ï¼Œå®¹å™¨å’Œdocker0ç»„æˆäº†ä¸€ä¸ªå­ç½‘ï¼Œdocker0ä¸Šçš„IPå°±æ˜¯è¿™ä¸ªå­ç½‘çš„ç½‘å…³IPã€‚</p><p>å¦‚æœæˆ‘ä»¬è¦è®©å­ç½‘é€šè¿‡å®¿ä¸»æœºä¸Šeth0å»è®¿é—®å¤–ç½‘çš„è¯ï¼Œé‚£ä¹ˆåŠ ä¸Šiptablesçš„è§„åˆ™å°±å¯ä»¥äº†ï¼Œä¹Ÿå°±æ˜¯ä¸‹é¢è¿™æ¡è§„åˆ™ã€‚</p><pre><code>iptables -P FORWARD ACCEPT\n</code></pre><p>å¥½äº†ï¼Œè¿›è¡Œåˆ°è¿™é‡Œï¼Œæˆ‘ä»¬é€šè¿‡bridge+natçš„é…ç½®ï¼Œä¼¼ä¹å·²ç»å®Œæˆäº†ç¬¬äºŒæ­¥â€”â€”è®©æ•°æ®ä»å®¿ä¸»æœºçš„eth0å‘é€å‡ºå»ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬è¿™æ ·é…ç½®ï¼ŒçœŸçš„å¯ä»¥è®©å®¹å™¨é‡Œå‘é€æ•°æ®åŒ…åˆ°å¤–ç½‘äº†å—ï¼Ÿè¿™éœ€è¦æˆ‘ä»¬åšä¸ªæµ‹è¯•ï¼Œå†é‡æ–°å°è¯•ä¸‹è¿™ä¸€è®²å¼€å§‹çš„æ“ä½œï¼Œä»å®¹å™¨é‡Œpingå¤–ç½‘çš„IPï¼Œè¿™æ—¶å€™ï¼Œä½ ä¼šå‘ç°è¿˜æ˜¯pingä¸é€šã€‚</p><p>å…¶å®å‘¢ï¼Œåšåˆ°è¿™ä¸€æ­¥ï¼Œæˆ‘ä»¬é€šè¿‡è‡ªå·±çš„é€æ­¥æ“ä½œå‘¢ï¼Œé‡ç°äº†è¿™ä¸€è®²äº†æœ€å¼€å§‹çš„é—®é¢˜ã€‚</p><h2>è§£å†³é—®é¢˜</h2><p>æ—¢ç„¶ç°åœ¨æˆ‘ä»¬æ¸…æ¥šäº†ï¼Œåœ¨è¿™ä¸ªèŠ‚ç‚¹ä¸Šå®¹å™¨å’Œå®¿ä¸»æœºä¸Šçš„ç½‘ç»œé…ç½®æ˜¯æ€ä¹ˆä¸€å›äº‹ã€‚é‚£ä¹ˆè¦è°ƒè¯•è¿™ä¸ªé—®é¢˜å‘¢ï¼Œä¹Ÿæœ‰äº†æ€è·¯ï¼Œå…³é”®å°±æ˜¯æ‰¾åˆ°æ•°æ®åŒ…ä¼ åˆ°å“ªä¸ªç¯èŠ‚æ—¶å‘ç”Ÿäº†ä¸­æ–­ã€‚</p><p>é‚£æœ€ç›´æ¥çš„æ–¹æ³•å‘¢ï¼Œå°±æ˜¯åœ¨å®¹å™¨ä¸­ç»§ç»­pingå¤–ç½‘çš„IP 39.106.233.176ï¼Œç„¶ååœ¨å®¹å™¨çš„eth0 (veth_container)ï¼Œå®¹å™¨å¤–çš„veth_hostï¼Œdocker0ï¼Œå®¿ä¸»æœºçš„eth0è¿™ä¸€æ¡æ•°æ®åŒ…çš„è·¯å¾„ä¸Šè¿è¡Œtcpdumpã€‚</p><p>è¿™æ ·å°±å¯ä»¥æŸ¥åˆ°ï¼Œåˆ°åº•åœ¨å“ªä¸ªè®¾å¤‡æ¥å£ä¸Šæ²¡æœ‰æ”¶åˆ°pingçš„icmpåŒ…ã€‚æˆ‘æŠŠtcpdumpè¿è¡Œçš„ç»“æœæˆ‘åˆ—åˆ°äº†ä¸‹é¢ã€‚</p><p>å®¹å™¨çš„eth0ï¼š</p><pre><code class=\"language-shell\"># ip netns exec $pid tcpdump -i eth0 host 39.106.233.176 -nn\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes\n00:47:29.934294 IP 172.17.1.2 &gt; 39.106.233.176: ICMP echo request, id 71, seq 1, length 64\n00:47:30.934766 IP 172.17.1.2 &gt; 39.106.233.176: ICMP echo request, id 71, seq 2, length 64\n00:47:31.958875 IP 172.17.1.2 &gt; 39.106.233.176: ICMP echo request, id 71, seq 3, length 64\n</code></pre><p>veth_hostï¼š</p><pre><code class=\"language-shell\"># tcpdump -i veth_host host 39.106.233.176 -nn\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on veth_host, link-type EN10MB (Ethernet), capture size 262144 bytes\n00:48:01.654720 IP 172.17.1.2 &gt; 39.106.233.176: ICMP echo request, id 71, seq 32, length 64\n00:48:02.678752 IP 172.17.1.2 &gt; 39.106.233.176: ICMP echo request, id 71, seq 33, length 64\n00:48:03.702827 IP 172.17.1.2 &gt; 39.106.233.176: ICMP echo request, id 71, seq 34, length 64\n</code></pre><p>docker0ï¼š</p><pre><code class=\"language-shell\"># tcpdump -i docker0 host 39.106.233.176 -nn\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on docker0, link-type EN10MB (Ethernet), capture size 262144 bytes\n00:48:20.086841 IP 172.17.1.2 &gt; 39.106.233.176: ICMP echo request, id 71, seq 50, length 64\n00:48:21.110765 IP 172.17.1.2 &gt; 39.106.233.176: ICMP echo request, id 71, seq 51, length 64\n00:48:22.134839 IP 172.17.1.2 &gt; 39.106.233.176: ICMP echo request, id 71, seq 52, length 64\n</code></pre><p>host eth0ï¼š</p><pre><code class=\"language-shell\"># tcpdump -i eth0 host 39.106.233.176 -nn\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes\n^C\n0 packets captured\n0 packets received by filter\n0 packets dropped by kernel\n</code></pre><p>é€šè¿‡ä¸Šé¢çš„è¾“å‡ºç»“æœï¼Œæˆ‘ä»¬å‘ç°icmpåŒ…åˆ°è¾¾äº†docker0ï¼Œä½†æ˜¯æ²¡æœ‰åˆ°è¾¾å®¿ä¸»æœºä¸Šçš„eth0ã€‚</p><p>å› ä¸ºæˆ‘ä»¬å·²ç»é…ç½®äº†iptables natçš„è½¬å‘ï¼Œè¿™ä¸ªä¹Ÿå¯ä»¥é€šè¿‡æŸ¥çœ‹iptablesçš„natè¡¨ç¡®è®¤ä¸€ä¸‹ï¼Œæ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œå…·ä½“çš„æ“ä½œå‘½ä»¤å¦‚ä¸‹ï¼š</p><pre><code class=\"language-shell\"># iptables -L  -t nat\nChain PREROUTING (policy ACCEPT)\ntarget     prot opt source               destination\nDOCKER     all  --  anywhere             anywhere             ADDRTYPE match dst-type LOCAL\n \nChain INPUT (policy ACCEPT)\ntarget     prot opt source               destination\n \nChain POSTROUTING (policy ACCEPT)\ntarget     prot opt source               destination\nMASQUERADE  all  --  172.17.0.0/16        anywhere\n \nChain OUTPUT (policy ACCEPT)\ntarget     prot opt source               destination\nDOCKER     all  --  anywhere            !127.0.0.0/8          ADDRTYPE match dst-type LOCAL\n \nChain DOCKER (2 references)\ntarget     prot opt source               destination\nRETURN     all  --  anywhere             anywhere\n</code></pre><p>é‚£ä¹ˆä¼šæ˜¯ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿå› ä¸ºè¿™é‡Œéœ€è¦åšä¸¤ä¸ªç½‘ç»œè®¾å¤‡æ¥å£ä¹‹é—´çš„æ•°æ®åŒ…è½¬å‘ï¼Œä¹Ÿå°±æ˜¯ä»docker0æŠŠæ•°æ®åŒ…è½¬å‘åˆ°eth0ä¸Šï¼Œä½ å¯èƒ½æƒ³åˆ°äº†Linuxåè®®æ ˆé‡Œçš„ä¸€ä¸ªå¸¸ç”¨å‚æ•°ip_forwardã€‚</p><p>æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹ï¼Œå®ƒçš„å€¼æ˜¯0ï¼Œå½“æˆ‘ä»¬æŠŠå®ƒæ”¹æˆ1ä¹‹åï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ä»å®¹å™¨ä¸­pingé€šå¤–ç½‘39.106.233.176è¿™ä¸ªIPäº†ï¼</p><pre><code class=\"language-shell\"># cat /proc/sys/net/ipv4/ip_forward\n0\n# echo 1 &gt; /proc/sys/net/ipv4/ip_forward\n \n# docker exec -it if-test ping 39.106.233.176\nPING 39.106.233.176 (39.106.233.176) 56(84) bytes of data.\n64 bytes from 39.106.233.176: icmp_seq=1 ttl=77 time=359 ms\n64 bytes from 39.106.233.176: icmp_seq=2 ttl=77 time=346 ms\n^C\n--- 39.106.233.176 ping statistics ---\n2 packets transmitted, 2 received, 0% packet loss, time 1ms\nrtt min/avg/max/mdev = 345.889/352.482/359.075/6.593 ms\n</code></pre><h2>é‡ç‚¹å°ç»“</h2><p>è¿™ä¸€è®²ï¼Œæˆ‘ä»¬ä¸»è¦è§£å†³çš„é—®é¢˜æ˜¯å¦‚ä½•ç»™å®¹å™¨é…ç½®ç½‘ç»œæ¥å£ï¼Œè®©å®¹å™¨å¯ä»¥å’Œå¤–é¢é€šè®¯ï¼›åŒæ—¶æˆ‘ä»¬è¿˜å­¦ä¹ äº†å½“å®¹å™¨ç½‘ç»œä¸é€šçš„æ—¶å€™ï¼Œæˆ‘ä»¬åº”è¯¥æ€ä¹ˆæ¥åšä¸€ä¸ªç®€å•è°ƒè¯•ã€‚</p><p>è§£å†³å®¹å™¨ä¸å¤–ç•Œé€šè®¯çš„é—®é¢˜å‘¢ï¼Œä¸€å…±éœ€è¦å®Œæˆä¸¤æ­¥ã€‚ç¬¬ä¸€æ­¥æ˜¯ï¼Œæ€ä¹ˆè®©æ•°æ®åŒ…ä»å®¹å™¨çš„Network Namespaceå‘é€åˆ°Host Network Namespaceä¸Šï¼›ç¬¬äºŒæ­¥ï¼Œæ•°æ®åŒ…åˆ°äº†Host Network Namespaceä¹‹åï¼Œè¿˜éœ€è¦è®©å®ƒå¯ä»¥ä»å®¿ä¸»æœºçš„eth0å‘é€å‡ºå»ã€‚</p><p>æˆ‘ä»¬æƒ³è®©æ•°æ®ä»å®¹å™¨Netowrk Namespaceå‘é€åˆ°Host Network Namespaceï¼Œå¯ä»¥ç”¨é…ç½®ä¸€å¯¹vethè™šæ‹Ÿç½‘ç»œè®¾å¤‡çš„æ–¹æ³•å®ç°ã€‚è€Œè®©æ•°æ®åŒ…ä»å®¿ä¸»æœºçš„eth0å‘é€å‡ºå»ï¼Œå°±ç”¨å¯bridge+natçš„æ–¹å¼å®Œæˆã€‚</p><p>è¿™é‡Œæˆ‘è®²çš„æ˜¯æœ€åŸºæœ¬çš„ä¸€ç§é…ç½®ï¼Œä½†å®ƒä¹Ÿæ˜¯å¾ˆå¸¸ç”¨çš„ä¸€ä¸ªç½‘ç»œé…ç½®ã€‚é’ˆå¯¹å…¶ä»–ä¸åŒéœ€è¦ï¼Œå®¹å™¨ç½‘ç»œè¿˜æœ‰å¾ˆå¤šç§ã€‚é‚£ä½ å­¦ä¹ å®Œè¿™ä¸€è®²ï¼Œäº†è§£äº†åŸºæœ¬çš„æ¦‚å¿µå’Œæ“ä½œä¹‹åå‘¢ï¼Œè¿˜å¯ä»¥æŸ¥çœ‹æ›´å¤šçš„ç½‘ä¸Šèµ„æ–™ï¼Œå­¦ä¹ ä¸åŒçš„ç½‘ç»œé…ç½®ã€‚</p><p>é‡åˆ°å®¹å™¨ä¸­ç½‘ç»œä¸é€šçš„æƒ…å†µï¼Œæˆ‘ä»¬å…ˆè¦ç†è§£è‡ªå·±çš„å®¹å™¨ä»¥åŠå®¹å™¨åœ¨å®¿ä¸»æœºä¸Šçš„é…ç½®ï¼Œé€šè¿‡å¯¹ä¸»è¦è®¾å¤‡ä¸Šåštcpdumpå¯ä»¥æ‰¾åˆ°å…·ä½“åœ¨å“ªä¸€æ­¥æ•°æ®åŒ…åœæ­¢äº†è½¬å‘ã€‚</p><p>ç„¶åæˆ‘ä»¬ç»“åˆå†…æ ¸ç½‘ç»œé…ç½®å‚æ•°ï¼Œè·¯ç”±è¡¨ä¿¡æ¯ï¼Œé˜²ç«å¢™è§„åˆ™ï¼Œä¸€èˆ¬éƒ½å¯ä»¥å®šä½å‡ºæ ¹æœ¬åŸå› ï¼Œæœ€ç»ˆè§£å†³è¿™ç§ç½‘ç»œå®Œå…¨ä¸é€šçš„é—®é¢˜ã€‚</p><p>ä½†æ˜¯å¦‚æœæ˜¯ç½‘ç»œå¶å°”ä¸¢åŒ…çš„é—®é¢˜ï¼Œè¿™ä¸ªå°±éœ€è¦ç”¨åˆ°å…¶ä»–çš„ä¸€äº›å·¥å…·æ¥åšåˆ†æäº†ï¼Œè¿™ä¸ªæˆ‘ä»¬ä¼šåœ¨ä¹‹åçš„ç« èŠ‚åšè®²è§£ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>æˆ‘ä»¬è¿™ä¸€è®²çš„ä¾‹å­å‘¢ï¼Œå®ç°äº†ä»å®¹å™¨è®¿é—®å¤–é¢çš„IPã€‚é‚£ä¹ˆå¦‚æœè¦å®ç°èŠ‚ç‚¹å¤–çš„ç¨‹åºæ¥è®¿é—®å®¹å™¨çš„IPï¼Œæˆ‘ä»¬åº”è¯¥æ€ä¹ˆé…ç½®ç½‘ç»œå‘¢ï¼Ÿ</p><p>æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºåˆ†äº«ä½ çš„æ€è€ƒå’Œé—®é¢˜ã€‚å¦‚æœè¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¯å‘ï¼Œä¹Ÿæ¬¢è¿åˆ†äº«ç»™ä½ çš„æœ‹å‹ï¼Œä¸€èµ·å­¦ä¹ è¿›æ­¥ã€‚</p>","comments":[{"had_liked":false,"id":269052,"user_name":"è‰¯å‡¯å°”","can_delete":false,"product_type":"c1","uid":1806492,"ip_address":"","ucode":"8204DA338BA8F4","user_header":"https://static001.geekbang.org/account/avatar/00/1b/90/9c/288e4db2.jpg","comment_is_top":false,"comment_ctime":1608511428,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"96097791940","product_id":100063801,"comment_content":"å®ç°èŠ‚ç‚¹å¤–çš„ç¨‹åºæ¥è®¿é—®å®¹å™¨ï¼š<br><br>iptables -t nat -A PREROUTING -d ã€å®¿ä¸»æœºipã€‘ -p tcp -m tcp --dport ã€å®¿ä¸»æœºæ˜ å°„ç«¯å£ã€‘ -j DNAT --to-destination ã€å®¹å™¨ipã€‘:ã€å®¹å™¨ç«¯å£ã€‘<br><br>åˆ©ç”¨DNATï¼Œè®¿é—®å®¿ä¸»æœºip+å®¿ä¸»æœºæ˜ å°„ç«¯å£ï¼Œå³å¯è®¿é—®å®¹å™¨<br>","like_count":21},{"had_liked":false,"id":271750,"user_name":"æˆ‘æ¥ä¹Ÿ","can_delete":false,"product_type":"c1","uid":1205253,"ip_address":"","ucode":"773D6104F56767","user_header":"https://static001.geekbang.org/account/avatar/00/12/64/05/6989dce6.jpg","comment_is_top":false,"comment_ctime":1609776024,"is_pvip":false,"replies":[{"id":"98642","content":"@æˆ‘æ¥ä¹Ÿ<br>æŠŠè°ƒè¯•å·¥å…·éƒ½æ”¾åˆ°ä¸€ä¸ªåŸºç¡€å®¹å™¨ä¸­ä¹ŸæŒºå¥½çš„ã€‚<br>","user_name":"ä½œè€…å›å¤","user_name_real":"CY","uid":"2070138","ctime":1609939922,"ip_address":"","comment_id":271750,"utype":1}],"discussion_count":4,"race_medal":0,"score":"40264481688","product_id":100063801,"comment_content":"è€å¸ˆä¸€è·¯tcpdumpçš„æ“ä½œå¾ˆçŠ€åˆ©ï¼Œç‰¹åˆ«æ˜¯æŠ“å®¹å™¨ä¸­çš„æ•°æ®åŒ…çš„é‚£ä¸ªæ“ä½œï¼š<br><br>  ip netns exec $pid tcpdump -i eth0 host 39.106.233.176 -nn<br><br>ä»¥å‰ä¸ºäº†åœ¨å®¹å™¨ä¸­æŠ“åŒ…ï¼Œè¿˜è¦åœ¨å®¹å™¨ä¸­å®‰è£…tcpdumpï¼Œä»å›½å¤–çš„æºæ‹‰æ•°æ®åˆæ…¢ï¼Œå³ä½¿æ¢äº†å›½å†…çš„æºï¼Œä½†æ¯æ¬¡é‡å»ºå®¹å™¨ååˆå¾—å†æ¥ä¸€æ¬¡ã€‚<br>æçš„æˆ‘ä¸“é—¨å‡†å¤‡äº†ä¸€ä¸ªè°ƒè¯•ç”¨çš„åŸºç¡€å®¹å™¨ï¼ŒæŠŠå„ç§å¸¸ç”¨çš„å·¥å…·éƒ½ç»™è£…ä¸Šï¼ŒåŒ…æ‹¬æˆ‘çš„vimã€‚ğŸ˜„","like_count":10,"discussions":[{"author":{"id":2070138,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/96/7a/8a14d008.jpg","nickname":"CY","note":"","ucode":"4AF98230985918","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":513032,"discussion_content":"@æˆ‘æ¥ä¹Ÿ\næŠŠè°ƒè¯•å·¥å…·éƒ½æ”¾åˆ°ä¸€ä¸ªåŸºç¡€å®¹å™¨ä¸­ä¹ŸæŒºå¥½çš„ã€‚\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609939922,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2314854,"avatar":"https://static001.geekbang.org/account/avatar/00/23/52/66/3e4d4846.jpg","nickname":"includestdio.h","note":"","ucode":"5027BACE9319CD","race_medal":1,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576218,"discussion_content":"k8såœºæ™¯ä¸‹å¯ä»¥æ’å…¥debugå®¹å™¨è¿›è¡Œè°ƒè¯•ï¼Œè¿™æ ·åŸºç¡€é•œåƒä¹Ÿä¸ç”¨å˜åŠ¨äº†","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1655358054,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1205253,"avatar":"https://static001.geekbang.org/account/avatar/00/12/64/05/6989dce6.jpg","nickname":"æˆ‘æ¥ä¹Ÿ","note":"","ucode":"773D6104F56767","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2314854,"avatar":"https://static001.geekbang.org/account/avatar/00/23/52/66/3e4d4846.jpg","nickname":"includestdio.h","note":"","ucode":"5027BACE9319CD","race_medal":1,"user_type":1,"is_pvip":true},"discussion":{"id":576311,"discussion_content":"å—¯ï¼Œå¥½åƒæ˜¯æœ€è¿‘å‡ ä¸ªç‰ˆæœ¬æ‰åŠ å…¥çš„åŠŸèƒ½ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655426139,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":576218,"ip_address":""},"score":576311,"extra":""}]},{"author":{"id":1262144,"avatar":"https://static001.geekbang.org/account/avatar/00/13/42/40/c7444091.jpg","nickname":"tofu","note":"","ucode":"93BFF835968A03","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":572376,"discussion_content":"è¿˜æœ‰è¿™ç§æ€è·¯ å­¦åˆ°äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1652752536,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":277490,"user_name":"é™ˆæ–¯ä½³","can_delete":false,"product_type":"c1","uid":1259323,"ip_address":"","ucode":"C236F874FC767A","user_header":"https://static001.geekbang.org/account/avatar/00/13/37/3b/495e2ce6.jpg","comment_is_top":false,"comment_ctime":1612429902,"is_pvip":false,"replies":[{"id":"100827","content":"@é™ˆæ–¯ä½³<br>æ˜¯è¿™æ ·çš„ï¼","user_name":"ä½œè€…å›å¤","user_name_real":"CY","uid":"2070138","ctime":1612620761,"ip_address":"","comment_id":277490,"utype":1}],"discussion_count":1,"race_medal":0,"score":"23087266382","product_id":100063801,"comment_content":"è¿™ç¯‡ç½‘ç»œè°ƒè¯•å¤ªç¡¬æ ¸äº†ï¼ï¼ä¸€ç›´è§‰å¾—ï¼Œå®¹å™¨å°±æ˜¯Linuxçš„é«˜çº§çŸ¥è¯†ï¼Œå®¹å™¨é€šäº†ï¼ŒLinuxçš„å†…å®¹ä½ å°±æ‰€å‘æŠ«é¡äº†","like_count":6,"discussions":[{"author":{"id":2070138,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/96/7a/8a14d008.jpg","nickname":"CY","note":"","ucode":"4AF98230985918","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":515069,"discussion_content":"@é™ˆæ–¯ä½³\næ˜¯è¿™æ ·çš„ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1612620761,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":270239,"user_name":"äº‰å…‰ Alan","can_delete":false,"product_type":"c1","uid":1336328,"ip_address":"","ucode":"338534F909AF03","user_header":"https://static001.geekbang.org/account/avatar/00/14/64/08/0287f41f.jpg","comment_is_top":false,"comment_ctime":1608999328,"is_pvip":false,"replies":[{"id":"98084","content":"&gt; 1<br>å¯¹çš„ä½ å¯ä»¥ç†è§£ä¸ºdocker0æ˜¯ä¸€ä¸ªL2äº¤æ¢æœºã€‚<br><br>&gt; 2<br>ip_forwardå°±æ˜¯æ‰“å¼€Linuxç±»ä¼¼è·¯ç”±å™¨çš„åŠŸèƒ½ï¼Œå…è®¸æ•°æ®åŒ…ä»ä¸€ä¸ªæ¥å£è¿›å…¥ï¼Œæ ¹æ®è·¯ç”±ä»å¦å¤–ä¸€ä¸ªæ¥å£å‡ºå»ã€‚è¿™ä¸ªå’Œä½ è¯´çš„iptablesé‡Œçš„postrouting&#47;forwardé“¾æ²¡æœ‰å…³ç³»","user_name":"ä½œè€…å›å¤","user_name_real":"CY","uid":"2070138","ctime":1609130252,"ip_address":"","comment_id":270239,"utype":1}],"discussion_count":4,"race_medal":0,"score":"23083835808","product_id":100063801,"comment_content":"ä½ å¥½ï¼Œè€å¸ˆï¼Œæˆ‘ç½‘ç»œæ¯”è¾ƒå¼±ï¼Œçœ‹äº†æ–‡ç« æœ‰ä¸¤ä¸ªåœ°æ–¹æ²¡çœ‹æ‡‚<br>1.docker0 å’Œvethè¿æ¥ï¼Œæ˜¯å¯ä»¥ç†è§£ä¸ºdocker0æ˜¯ä¸ªäº¤æ¢æœºï¼Œæ‰€æœ‰è¿æ¥docker0çš„ç½‘å¡å¯ä»¥äºŒå±‚é€šä¿¡ï¼Ÿ<br><br>2.ä¸ºä»€ä¹ˆè¿æ¥åˆ°docker0ï¼Œå¼€å¯forwardå°±é€šäº†ï¼Ÿèƒ½è®²ä¸€ä¸‹åŸç†å—ï¼Ÿ æ˜¯åˆ°è¾¾docker0çš„åŒ…ä¼šç»è¿‡postroutingé“¾ï¼Œç„¶åç»è¿‡æœ¬åœ°è·¯ç”±åï¼Œéœ€è¦èµ°forwardé“¾å‡ºå»ï¼Œæ‰€ä»¥éœ€è¦å¼€forwardä¸ºacceptå¹¶ä¸”å¼€å¯forwardå—ï¼Ÿ","like_count":6,"discussions":[{"author":{"id":2070138,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/96/7a/8a14d008.jpg","nickname":"CY","note":"","ucode":"4AF98230985918","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":512566,"discussion_content":"&amp;gt; 1\nå¯¹çš„ä½ å¯ä»¥ç†è§£ä¸ºdocker0æ˜¯ä¸€ä¸ªL2äº¤æ¢æœºã€‚\n\n&amp;gt; 2\nip_forwardå°±æ˜¯æ‰“å¼€Linuxç±»ä¼¼è·¯ç”±å™¨çš„åŠŸèƒ½ï¼Œå…è®¸æ•°æ®åŒ…ä»ä¸€ä¸ªæ¥å£è¿›å…¥ï¼Œæ ¹æ®è·¯ç”±ä»å¦å¤–ä¸€ä¸ªæ¥å£å‡ºå»ã€‚è¿™ä¸ªå’Œä½ è¯´çš„iptablesé‡Œçš„postrouting/forwardé“¾æ²¡æœ‰å…³ç³»","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609130252,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1139121,"avatar":"https://static001.geekbang.org/account/avatar/00/11/61/b1/1261c177.jpg","nickname":"èƒ–èƒ–è™","note":"","ucode":"9CA8F99CC82944","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":337910,"discussion_content":"bridgeæœ¬èº«æ˜¯ä¸€ä¸ªäºŒå±‚è®¾å¤‡ï¼Œä¸ä¼šå‚ä¸åˆ°è·¯ç”±è¿‡ç¨‹ä¸­ã€‚ä»¥Docker0ä¸ºä¾‹ï¼Œå¦‚æœdocker0ä»…ä»…æ˜¯ä¸€ä¸ªå•çº¯çš„ç½‘æ¡¥ï¼Œé‚£ä¹ˆæ‰€æœ‰è¿æ¥åˆ°docker0ä¸Šé¢çš„vethç›¸äº’ä¹‹é—´æ˜¯å¯ä»¥é€šè®¯çš„ï¼Œä½†æ˜¯ä»–ä»¬çš„æµé‡æ˜¯æ— æ³•åˆ°172.18.0.0/16ç½‘ç»œä¹‹å¤–çš„ã€‚å¦‚æœæƒ³å®ç°å‘å¤–é€šè®¯å…¶å®æœ‰ä¸¤ç§æ–¹æ³•ï¼š\n1. å°†ä¸»æœºç‰©ç†ç½‘å¡ä¹ŸåŠ å…¥åˆ°æ¡¥ä¸Šæ¥ï¼Œå®ç°äºŒå±‚äº¤æ¢ã€‚ä¸è¿‡è¿™æ ·çš„è¯ï¼Œç”±äºvethéƒ½æ˜¯172.18.0.0/16ç½‘æ®µï¼Œè¿™è¦æ±‚å¤–é¢é€šè®¯çš„åœ°å€ä¹Ÿæ˜¯è¿™ä¸ªç½‘æ®µï¼Œæœ‰è¾ƒå¤§é™åˆ¶ã€‚\n2. ç½‘æ¡¥docker0ä¸Šå…¶å®æœ‰ä¸€ä¸ªéšè—çš„è™šæ‹Ÿç½‘ç»œè®¾å¤‡ï¼Œåå­—ä¹Ÿæ˜¯docker0ã€‚\n~$ ifconfig docker0\ndocker0: flags=4099<UP,BROADCAST,MULTICAST>  mtu 1500\n        inet 172.18.0.1  netmask 255.255.0.0  broadcast 172.18.255.255\n        inet6 fe80::42:e7ff:fef2:61e1  prefixlen 64  scopeid 0x20<link>\n        ether 02:42:e7:f2:61:e1  txqueuelen 0  (Ethernet)\n        RX packets 300291  bytes 22659457 (22.6 MB)\n        RX errors 0  dropped 0  overruns 0  frame 0\n        TX packets 452412  bytes 541108573 (541.1 MB)\n        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0\n\nå½“docker0ä¸Šè®¾ç½®äº†åœ°å€ä¹‹åï¼Œå®ƒå°±æˆä¸ºäº†ä¸€ä¸ªå¯ä»¥å‚ä¸è·¯ç”±çš„ç½‘ç»œæ¥å£èŠ‚ç‚¹ã€‚é€šè¿‡route -nå¯ä»¥çœ‹åˆ°ï¼š\n~$ route -n\nKernel IP routing table\nDestination     Gateway         Genmask         Flags Metric Ref    Use Iface\n0.0.0.0         172.17.1.1      0.0.0.0         UG    0      0        0 ens160\n172.17.1.0      0.0.0.0         255.255.255.0   U     0      0        0 ens160\n172.18.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0\n\nç½‘æ¡¥è®¾å¤‡çš„è½¬å‘è§„åˆ™å¦‚ä¸‹ï¼š\n1. åŒ…ç›®çš„MACä¸ºBridgeæœ¬èº«MACåœ°å€(å½“docker0è®¾ç½®æœ‰IPåœ°å€)ï¼Œä»MACåœ°å€è¿™ä¸€å±‚æ¥çœ‹ï¼Œæ”¶åˆ°å‘å¾€ä¸»æœºè‡ªèº«çš„æ•°æ®åŒ…ï¼Œäº¤ç»™ä¸Šå±‚åè®®æ ˆ\n2. å¹¿æ’­åŒ…ï¼Œè½¬å‘åˆ°Bridgeä¸Šçš„æ‰€æœ‰æ¥å£(docker0,tap0,tap1,tapâ€¦)\n3. å•æ’­&amp;&amp;å­˜åœ¨äºMACç«¯å£æ˜ å°„è¡¨ï¼ŒæŸ¥è¡¨ç›´æ¥è½¬å‘åˆ°å¯¹åº”æ¥å£\n4. å•æ’­&amp;&amp;ä¸å­˜åœ¨äºMACç«¯å£æ˜ å°„è¡¨ï¼Œæ³›æ´ªåˆ°Bridgeè¿æ¥çš„æ‰€æœ‰æ¥å£(docker0,tap0,tap1,tapâ€¦)\n5. æ•°æ®åŒ…ç›®çš„åœ°å€æ¥å£ä¸æ˜¯ç½‘æ¡¥æ¥å£ï¼Œæ¡¥ä¸å¤„ç†ï¼Œäº¤ç»™ä¸Šå±‚åè®®æ ˆ\n\næœ‰äº†è¿™ä¸ªç½‘ç»œæ¥å£ä»¥åï¼Œé€šè¿‡docker0é€šè”çš„è™šæ‹Ÿç½‘å¡çš„ç½‘ç»œåŒ…å°±å¯ä»¥é€šè¿‡è™šæ‹Ÿè®¾å¤‡docker0å‚ä¸åˆ°3å±‚è·¯ç”±ä¸Šäº†ã€‚\nå½“ç„¶ï¼Œè¿˜æ˜¯éœ€è¦æ‰“å¼€iptablesä¸­çš„è½¬å‘è§„åˆ™ï¼šiptables -P FORWARD ACCEPT\n","likes_number":9,"is_delete":false,"is_hidden":false,"ctime":1609122724,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1139121,"avatar":"https://static001.geekbang.org/account/avatar/00/11/61/b1/1261c177.jpg","nickname":"èƒ–èƒ–è™","note":"","ucode":"9CA8F99CC82944","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":337911,"discussion_content":"å†å¾€ä¸Šå±‚å°±æ˜¯å®¿ä¸»æœºè‡ªå·±çš„è·¯ç”±å’ŒNATè®¾ç½®äº†ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1609123153,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2384580,"avatar":"https://static001.geekbang.org/account/avatar/00/24/62/c4/be92518b.jpg","nickname":"ğŸ­","note":"","ucode":"E5CA01ACAEDFC1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":387154,"discussion_content":"ä¸ºå•¥éœ€è¦æ‰“å¼€iptablesè½¬å‘ä¹ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628006715,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":269202,"user_name":"è°¢å“ˆå“ˆ","can_delete":false,"product_type":"c1","uid":2326880,"ip_address":"","ucode":"5AADE70B5AFE27","user_header":"https://static001.geekbang.org/account/avatar/00/23/81/60/71ed6ac7.jpg","comment_is_top":false,"comment_ctime":1608555961,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"14493457849","product_id":100063801,"comment_content":"1ï¼Œå®¿ä¸»æœºä¸Šé…ç½®å®¹å™¨ç½‘æ®µçš„è·¯ç”±<br>2ï¼ŒDNATï¼Œåœ¨natè¡¨çš„PREROUTINGé“¾åšå¥½åŒ…ä¼ªè£…åˆ°è¾¾å®¹å™¨","like_count":3,"discussions":[{"author":{"id":1138499,"avatar":"https://static001.geekbang.org/account/avatar/00/11/5f/43/3799a0f3.jpg","nickname":"magina","note":"","ucode":"9546701896A09F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":338675,"discussion_content":"docker runé»˜è®¤æ˜¯æŒ‚åœ¨docker0ç½‘æ¡¥ä¸Šçš„ï¼Œpingå¤–é¢æ¥å°±æ˜¯é€šçš„å‘€ï¼Ÿï¼Ÿï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609336848,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":298537,"user_name":"kissingers","can_delete":false,"product_type":"c1","uid":1135299,"ip_address":"","ucode":"615151808CF628","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKzqiaZnBw2myRWY802u48Rw3W2zDtKoFQ6vN63m4FdyjibM21FfaOYe8MbMpemUdxXJeQH6fRdVbZA/132","comment_is_top":false,"comment_ctime":1624181080,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5919148376","product_id":100063801,"comment_content":"å¦‚æœeth0 ä¹ŸåŠ åˆ°docker0 bridgeï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™æ˜¯é€šè¿‡äºŒå±‚è½¬å‘æˆ–è€…æ´ªæ³›çš„æ–¹å¼è¿é€šå¤–ç½‘ã€‚å¦‚æœeth0ä¸åŠ åˆ°docker0çš„è¯é‚£ä¹ˆåˆ©ç”¨çš„æ˜¯host çš„è·¯ç”±è½¬å‘äº†ã€‚è¿™æ ·ç†è§£å¯¹å—ï¼Ÿ","like_count":1},{"had_liked":false,"id":282501,"user_name":"Geek_c2089d","can_delete":false,"product_type":"c1","uid":1489545,"ip_address":"","ucode":"C66D345042525F","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/4Lprf2mIWpJOPibgibbFCicMtp5bpIibyLFOnyOhnBGbusrLZC0frG0FGWqdcdCkcKunKxqiaOHvXbCFE7zKJ8TmvIA/132","comment_is_top":false,"comment_ctime":1615282049,"is_pvip":false,"replies":[{"id":"102734","content":"127.0.0.1 æ˜¯ localhost IP, æ¯ä¸ªnamespaceé‡Œéƒ½æœ‰ä¸€ä¸ªã€‚å¦‚æœä»å®¿ä¸»æœºçš„host network namespaceé‡Œå»è®¿é—®127.0.0.1åªæ˜¯ host network namespaceé‡Œçš„ï¼Œä¸ä¼šè®¿é—®åˆ°å®¹å™¨ network namespaceçš„127.0.0.1","user_name":"ä½œè€…å›å¤","user_name_real":"CY","uid":"2070138","ctime":1615640087,"ip_address":"","comment_id":282501,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5910249345","product_id":100063801,"comment_content":"è€å¸ˆæœ‰ä¸ªé—®é¢˜æƒ³å’¨è¯¢ä¸€ä¸‹ä½ ï¼Œæˆ‘æœ‰ä¸ªFTPçš„å®¹å™¨ï¼Œftpçš„é…ç½®æ˜¯é…ç½®äº†127.0.0.1åœ°å€ï¼Œè€Œæˆ‘å®¿ä¸»æœºæ˜¯192.168.1.21çš„ipï¼Œæˆ‘è¿æ¥ftpæœåŠ¡çš„æ—¶å€™ç”¨å®¿ä¸»æœºçš„ipå»è¿æ¥ä¼šæœ‰é—®é¢˜ï¼Ÿï¼Ÿï¼Ÿæˆ‘ç°åœ¨æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯è¢«åŠ¨æ¨¡å¼è¿æ¥ä¸Šå»ä½†LISTå‘½ä»¤æ•°æ®æ²¡è¿”å›ï¼Œä½†æ˜¯ä¸»åŠ¨æ¨¡å¼å¯ä»¥ï¼Œæƒ³é—®ä¸‹å’Œä¸Šé¢é…ç½®æœ‰å…³ç³»ï¼Ÿï¼Ÿå¦‚æœæ²¡å…³ç³»æˆ‘ä¸Šé¢çš„é…ç½®ä¼šå¼•èµ·ä»€ä¹ˆé—®é¢˜ï¼Ÿï¼Ÿ","like_count":1,"discussions":[{"author":{"id":2070138,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/96/7a/8a14d008.jpg","nickname":"CY","note":"","ucode":"4AF98230985918","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":516766,"discussion_content":"127.0.0.1 æ˜¯ localhost IP, æ¯ä¸ªnamespaceé‡Œéƒ½æœ‰ä¸€ä¸ªã€‚å¦‚æœä»å®¿ä¸»æœºçš„host network namespaceé‡Œå»è®¿é—®127.0.0.1åªæ˜¯ host network namespaceé‡Œçš„ï¼Œä¸ä¼šè®¿é—®åˆ°å®¹å™¨ network namespaceçš„127.0.0.1","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1615640087,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":281131,"user_name":"moonberry","can_delete":false,"product_type":"c1","uid":1106785,"ip_address":"","ucode":"4A8EF8705AC2A6","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqzh2c5OGpQSPx4SNC9L7q2bgnncjlPfUXk48FuE8ud7LzkH4fhrPw0ENwueqh7UkuU8DibhoCz5iaw/132","comment_is_top":false,"comment_ctime":1614589944,"is_pvip":false,"replies":[{"id":"102399","content":"éœ€è¦è‡ªå·±åŠ ä¸€æ¡ â€œiptables -P FORWARD ACCEPTâ€ï¼Œ å…¶å®ƒçš„æ˜¯é»˜è®¤çš„é…ç½®ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"CY","uid":"2070138","ctime":1615038954,"ip_address":"","comment_id":281131,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5909557240","product_id":100063801,"comment_content":"è€å¸ˆæ‚¨å¥½ï¼Œè¯·é—®iptables åˆ—å‡ºçš„NATè¡¨æ˜¯dockeré»˜è®¤é…ç½®çš„å—ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":2070138,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/96/7a/8a14d008.jpg","nickname":"CY","note":"","ucode":"4AF98230985918","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":516301,"discussion_content":"éœ€è¦è‡ªå·±åŠ ä¸€æ¡ â€œiptables -P FORWARD ACCEPTâ€ï¼Œ å…¶å®ƒçš„æ˜¯é»˜è®¤çš„é…ç½®ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1615038954,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":271566,"user_name":"Geek_ba556d","can_delete":false,"product_type":"c1","uid":2187528,"ip_address":"","ucode":"FF3A00C32D2874","user_header":"","comment_is_top":false,"comment_ctime":1609716268,"is_pvip":false,"replies":[{"id":"98647","content":"@Geek_ba556d<br>ä¸å¥½æ„æ€ï¼Œè¿™ä¸ªéœ€è¦çœ‹åˆ°ç°åœºç¯å¢ƒæ‰èƒ½è¿›ä¸€æ­¥åˆ†æã€‚ä¸è¿‡ï¼Œä½ è¯´arpå‡ºé—®é¢˜ï¼Œé‚£ä¹ˆå¯ä»¥å…ˆåœ¨ä¸»è¦æ¥å£dumpä¸€ä¸‹arp request æˆ–è€… arp replyçš„åŒ…ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"CY","uid":"2070138","ctime":1609941627,"ip_address":"","comment_id":271566,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5904683564","product_id":100063801,"comment_content":"è€å¸ˆï¼Œèƒ½å¸®å¿™è§£å†³ä¸€ä¸‹ï¼Œæˆ‘åœ¨ä¸¤å°vmwareworkè™šæ‹Ÿæœºå®‰è£…centos7.6ï¼Œåˆ†åˆ«åˆ›å»ºç‰©ç†ç½‘å¡å­æ¥å£ï¼Œå¹¶å…³è”äº†macvlanï¼Œä½†æ˜¯ARPä¼ è¾“ä¸€ç›´å‡ºé—®é¢˜ï¼Œç»‘å®šé™æ€å°±å¯ä»¥pingé€šï¼Œä¸çŸ¥æ˜¯ä»€ä¹ˆåŸå› ï¼Œèƒ½å¸®å¿™è§£ç­”ä¸€ä¸‹å—ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":2070138,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/96/7a/8a14d008.jpg","nickname":"CY","note":"","ucode":"4AF98230985918","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":512962,"discussion_content":"@Geek_ba556d\nä¸å¥½æ„æ€ï¼Œè¿™ä¸ªéœ€è¦çœ‹åˆ°ç°åœºç¯å¢ƒæ‰èƒ½è¿›ä¸€æ­¥åˆ†æã€‚ä¸è¿‡ï¼Œä½ è¯´arpå‡ºé—®é¢˜ï¼Œé‚£ä¹ˆå¯ä»¥å…ˆåœ¨ä¸»è¦æ¥å£dumpä¸€ä¸‹arp request æˆ–è€… arp replyçš„åŒ…ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609941627,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2187528,"avatar":"","nickname":"Geek_ba556d","note":"","ucode":"FF3A00C32D2874","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":340318,"discussion_content":"ç½‘ç»œå‡ºæ¥å£æ˜¯ARPåŠ VLANIDæ²¡é—®é¢˜ï¼Œä½†æ˜¯ä¼ åˆ°å…¥æ¥å£å°±æˆäº†æ— æ•ˆåŒ…äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609975254,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":354460,"user_name":"JianXu","can_delete":false,"product_type":"c1","uid":1033219,"ip_address":"ä¸Šæµ·","ucode":"2A61BDBB573BDC","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c4/03/f753fda7.jpg","comment_is_top":false,"comment_ctime":1660440282,"is_pvip":false,"replies":[{"id":"129206","content":"æˆ‘ä»¬ç”¨bpf trace ä¸»è¦çš„å†…æ ¸stackçš„æ”¶å‘å‡½æ•°ï¼Œdumpå‡ºnetwork namespace idå’Œdevice nameï¼Œ å°±å¯ä»¥çœ‹å‡ºè¿™æ¡è·¯å¾„äº†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"2070138","ctime":1661084784,"ip_address":"ä¸Šæµ·","comment_id":354460,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1660440282","product_id":100063801,"comment_content":"ä»¥æˆ‘ä»¬è®¾è®¡çš„system diagnostics ä¸ºä¾‹å­ï¼Œæˆ‘ä»¬æ˜¯æ€ä¹ˆè‡ªåŠ¨æ¨ç®—å‡º æ•°æ®è·¯å¾„æ˜¯ container vethâ€”&gt; host veth â€”&gt; docker 0 â€”&gt; host eth0 å‘¢ï¼Ÿä»è€Œåœ¨è¿™æ¡è·¯å¾„ä¸Šåšæ¶ˆæ¯æå–å‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":2070138,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/96/7a/8a14d008.jpg","nickname":"CY","note":"","ucode":"4AF98230985918","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":584754,"discussion_content":"æˆ‘ä»¬ç”¨bpf trace ä¸»è¦çš„å†…æ ¸stackçš„æ”¶å‘å‡½æ•°ï¼Œdumpå‡ºnetwork namespace idå’Œdevice nameï¼Œ å°±å¯ä»¥çœ‹å‡ºè¿™æ¡è·¯å¾„äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661084784,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"ä¸Šæµ·"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":345740,"user_name":"PageNotFound","can_delete":false,"product_type":"c1","uid":2070840,"ip_address":"","ucode":"43AE16F29EFEBD","user_header":"https://static001.geekbang.org/account/avatar/00/1f/99/38/37b8a8c8.jpg","comment_is_top":false,"comment_ctime":1652539668,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1652539668","product_id":100063801,"comment_content":"å¤–éƒ¨ç½‘ç»œè®¿é—®å®¹å™¨å†…æœåŠ¡ï¼š<br>sudo iptables -t nat -A DOCKER ! -i docker0 -p tcp -m tcp --dport [hostPort] -j DNAT --to-destination [containerIP]:[containerPort]","like_count":0},{"had_liked":false,"id":325854,"user_name":"å¾å–†","can_delete":false,"product_type":"c1","uid":1202663,"ip_address":"","ucode":"E83AAD2D6338FB","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKhKicPfmH6FDtria1aViaaiaDC0n9nwsuh5LnSJlVvLkMrVZYoXnYT19ZdJ3lh8BUyYSDox1ibTAxnzjw/132","comment_is_top":false,"comment_ctime":1639197806,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1639197806","product_id":100063801,"comment_content":"è€å¸ˆï¼Œæˆ‘åšå®éªŒçš„æ—¶å€™è·Ÿç€åšå‘ç°pingä¸é€šå¤–ç½‘ï¼Œåæ¥æŠŠveth_hostæ¡¥æ¥åˆ°docker0ç½‘ç»œé€šäº†ï¼Œæ˜¯è€å¸ˆåœ¨è¯¾ç¨‹é‡Œæ²¡å†™ä¸Šè¿˜æ˜¯å…¶ä»–åŸå› ï¼Œæ±‚æ•™ä¸€ä¸‹","like_count":0},{"had_liked":false,"id":311624,"user_name":"è¶…çº§èŠ’æœå†°","can_delete":false,"product_type":"c1","uid":1188976,"ip_address":"","ucode":"97480FBFA4F699","user_header":"https://static001.geekbang.org/account/avatar/00/12/24/70/4e7751f3.jpg","comment_is_top":false,"comment_ctime":1631348181,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1631348181","product_id":100063801,"comment_content":"è€å¸ˆï¼Œvethæ˜¯æ€ä¹ˆé…å¯¹çš„ï¼Œåˆ›å»ºä¹‹åè‡ªåŠ¨é…å¯¹å—ã€‚å¦‚æœå»ºäº†4ä¸ªvethï¼Œé…å¯¹è§„åˆ™æ˜¯æ€ä¹ˆæ ·çš„","like_count":0},{"had_liked":false,"id":305637,"user_name":"Demon.Lee","can_delete":false,"product_type":"c1","uid":1052859,"ip_address":"","ucode":"7F0E5493A8E345","user_header":"https://static001.geekbang.org/account/avatar/00/10/10/bb/f1061601.jpg","comment_is_top":false,"comment_ctime":1628079836,"is_pvip":false,"replies":[{"id":"110966","content":"@Demon.Lee<br>ä½ æè¿°äº†k8s é›†ç¾¤èŠ‚ç‚¹ï¼Œä¸è¿‡æ²¡æœ‰æè¿°podç½‘ç»œé…ç½®æ–¹å¼ã€‚åœ¨åˆ†æè¿™ä¸ªé—®é¢˜å‰ï¼Œä½ å¯ä»¥æŠŠé›†ç¾¤çš„ç½‘ç»œæ‹“æ‰‘å’Œpodåœ¨èŠ‚ç‚¹ä¸Šçš„ç½‘ç»œæ‹“æ‰‘åˆ†æä¸€éï¼Œç„¶åå†åˆ†æå…·ä½“çš„é—®é¢˜ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"CY","uid":"2070138","ctime":1628598879,"ip_address":"","comment_id":305637,"utype":1}],"discussion_count":1,"race_medal":1,"score":"1628079836","product_id":100063801,"comment_content":"è¯·æ•™è€å¸ˆå’Œå°ä¼™ä¼´ä»¬ä¸€ä¸ªé—®é¢˜ï¼Œä¸çŸ¥é“ä½ ä»¬æ˜¯å¦é‡åˆ°è¿‡ï¼š<br>ä¸€ä¸ªç®€å•çš„ k8s é›†ç¾¤ï¼ˆ1ä¸ª master ï¼Œ2ä¸ª workerï¼‰ ï¼Œmaster çš„ ip ä¸º 10.5.xx.xxï¼Œ2 ä¸ª worker çš„ ip ä¸º 192.168.100.xxã€‚<br><br>æœ‰ä¸€ä¸ª pod æš´éœ²äº†ä¸€ä¸ª https ç«¯å£ï¼ˆæ¯”å¦‚443ï¼‰ï¼Œç„¶å é€šè¿‡ curl https:&#47;&#47;xxx:443&#47;apis&#47;xxx è®¿é—®ï¼ˆè°ƒç”¨æ˜¯ä¼šå¸¦ä¸Štokenï¼‰ï¼Œå¦‚æœè¿™ä¸ª pod ä¸åœ¨ master èŠ‚ç‚¹ä¸Šï¼Œé‚£ä¹ˆåœ¨ master èŠ‚ç‚¹ä¸Šå‘èµ·è¯·æ±‚åä¸€ç›´æ²¡ååº”ï¼Œç›´åˆ°è¶…æ—¶ã€‚è€Œåœ¨ 2 ä¸ª worker èŠ‚ç‚¹å‘èµ·è¯·æ±‚ï¼Œåˆ™å¯ä»¥æ­£å¸¸è¿”å›ã€‚<br>å¦‚æœå°†è¿™ä¸ª pod å¼ºåˆ¶è°ƒåº¦åˆ° master èŠ‚ç‚¹ä¸Šï¼Œé‚£ä¹ˆåœ¨ master èŠ‚ç‚¹ä¸Šå‘èµ·è¯·æ±‚ï¼Œå¯ä»¥æ­£å¸¸è¿”å›ï¼Œä½†åœ¨  2 ä¸ª worker èŠ‚ç‚¹å‘èµ·è¯·æ±‚ï¼Œä¼šè¶…æ—¶æ— å“åº”ã€‚","like_count":0,"discussions":[{"author":{"id":2070138,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/96/7a/8a14d008.jpg","nickname":"CY","note":"","ucode":"4AF98230985918","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":524460,"discussion_content":"@Demon.Lee\nä½ æè¿°äº†k8s é›†ç¾¤èŠ‚ç‚¹ï¼Œä¸è¿‡æ²¡æœ‰æè¿°podç½‘ç»œé…ç½®æ–¹å¼ã€‚åœ¨åˆ†æè¿™ä¸ªé—®é¢˜å‰ï¼Œä½ å¯ä»¥æŠŠé›†ç¾¤çš„ç½‘ç»œæ‹“æ‰‘å’Œpodåœ¨èŠ‚ç‚¹ä¸Šçš„ç½‘ç»œæ‹“æ‰‘åˆ†æä¸€éï¼Œç„¶åå†åˆ†æå…·ä½“çš„é—®é¢˜ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628598879,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":301295,"user_name":"å¾å°‘æ–‡","can_delete":false,"product_type":"c1","uid":1670331,"ip_address":"","ucode":"8E35B10DA44EE3","user_header":"https://static001.geekbang.org/account/avatar/00/19/7c/bb/635a2710.jpg","comment_is_top":false,"comment_ctime":1625624204,"is_pvip":false,"replies":[{"id":"111139","content":"@å¾å°‘æ–‡<br>å¯ä»¥æ‰¾ä¸€äº›iptablesç›¸å…³çš„æ–‡æ¡£çœ‹ä¸€ä¸‹ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"CY","uid":"2070138","ctime":1628774130,"ip_address":"","comment_id":301295,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1625624204","product_id":100063801,"comment_content":"è€å¸ˆçš„æ€è·¯æˆ‘çœ‹æ˜ç™½äº†ã€‚æˆ‘å·²ç»è‡ªå·±å®ç°äº†ä¸€ä¸ªå®¹å™¨æ²™ç®±ï¼Œç”¨net namespaceè¿›è¡Œäº†ç½‘ç»œçš„éš”ç¦»ï¼Œç°åœ¨æƒ³é…ç½®å®ƒçš„ç½‘ç»œåŠŸèƒ½ã€‚å®¿ä¸»æœºå·²ç»å¯ä»¥è¿é€šå¤–ç½‘ï¼Œæˆ‘åœ¨hostä¸Šåˆ›å»ºäº†ä¸€ä¸ªç½‘æ¡¥ï¼Œç„¶ååœ¨hostå’Œæ²™ç®±é‡Œæ”¾ç½®äº†veth0å’Œveth1ã€‚ä½†æ˜¯è¿˜æ²¡æœ‰è®¾ç½®hostä¸Šçš„SNATå’ŒDNATã€‚ç°åœ¨æ²™ç®±å’Œhostå·²ç»å¯ä»¥pingé€šï¼Œä¹Ÿå¯ä»¥é€šè¿‡tcpé€šä¿¡ã€‚ä½†æ˜¯æ²™ç®±å†…è¿˜æ˜¯æ— æ³•è®¿é—®å¤–ç½‘ï¼Œä½†æ˜¯ä¸çŸ¥é“å…·ä½“å¦‚ä½•è®¾ç½®SNATå’ŒDNATï¼Œè€å¸ˆèƒ½ç»™ç‚¹æŒ‡å¯¼å—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":2070138,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/96/7a/8a14d008.jpg","nickname":"CY","note":"","ucode":"4AF98230985918","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":522960,"discussion_content":"@å¾å°‘æ–‡\nå¯ä»¥æ‰¾ä¸€äº›iptablesç›¸å…³çš„æ–‡æ¡£çœ‹ä¸€ä¸‹ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628774130,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":293660,"user_name":"ç™¾é‡Œè‹±éª","can_delete":false,"product_type":"c1","uid":2323212,"ip_address":"","ucode":"236C3F51967EDE","user_header":"https://static001.geekbang.org/account/avatar/00/23/73/0c/214bbd5e.jpg","comment_is_top":false,"comment_ctime":1621480825,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1621480825","product_id":100063801,"comment_content":"èŠ‚ç‚¹å¤–è®¿é—®å®¹å™¨å†…ipï¼š<br>1. å‰ææ˜¯æ­£å¸¸å¯åŠ¨å®¹å™¨å’Œå®¿ä¸»æœºå¯ä»¥é€šè¿‡VETHå’Œdocker0ç½‘æ¡¥äº’é€šï¼Œä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´äº’é€š<br>2. åœ¨å¤–éƒ¨çš„èŠ‚ç‚¹é…ç½®iptables(DNAT)è§„åˆ™ï¼š<br>sudo iptables -t nat -A PREROUTING -d 172.17.0.10(å®¹å™¨çš„çœŸå®ip) -j DNAT --to-destination 172.31.27.61(èŠ‚ç‚¹çš„çœŸå®ip)<br>3.ä¹‹åå³å¯ä»å¤–éƒ¨æœºå™¨ç›´æ¥ä¸containerå†…ipäº¤äº’<br><br>åè¿‡æ¥éœ€è¦ï¼Œå®¹å™¨èŠ‚ç‚¹æœ¬åœ°åšSNATï¼Œå¦åˆ™æ•°æ®åŒ…åªèƒ½è¿‡å»å›ä¸æ¥","like_count":0},{"had_liked":false,"id":289856,"user_name":"Geek_c2089d","can_delete":false,"product_type":"c1","uid":1489545,"ip_address":"","ucode":"C66D345042525F","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/4Lprf2mIWpJOPibgibbFCicMtp5bpIibyLFOnyOhnBGbusrLZC0frG0FGWqdcdCkcKunKxqiaOHvXbCFE7zKJ8TmvIA/132","comment_is_top":false,"comment_ctime":1619232399,"is_pvip":false,"replies":[{"id":"105121","content":"ç”¨&quot;ip link show type bridge&quot;å‘½ä»¤çœ‹ä¸€ä¸‹ docker0 interfaceæ˜¯ä¸æ˜¯å­˜åœ¨ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"CY","uid":"2070138","ctime":1619269518,"ip_address":"","comment_id":289856,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1619232399","product_id":100063801,"comment_content":"è€å¸ˆï¼Œè¿™æ®µæ—¶é—´é‡åˆ°è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼Œæƒ³é—®ä¸‹é‡åˆ°è¿™ç§é—®é¢˜åº”è¯¥æ€ä¹ˆæ‰¾åŸå› :ä»€ä¹ˆæ—¥å¿—éƒ½çœ‹ä¸äº†<br><br>adding interface vethbad9e82 to bridge docker0 failed: could not find bridge docker0: no such network interface&quot;","like_count":0,"discussions":[{"author":{"id":2070138,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/96/7a/8a14d008.jpg","nickname":"CY","note":"","ucode":"4AF98230985918","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":519033,"discussion_content":"ç”¨&amp;quot;ip link show type bridge&amp;quot;å‘½ä»¤çœ‹ä¸€ä¸‹ docker0 interfaceæ˜¯ä¸æ˜¯å­˜åœ¨ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619269518,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1489545,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/4Lprf2mIWpJOPibgibbFCicMtp5bpIibyLFOnyOhnBGbusrLZC0frG0FGWqdcdCkcKunKxqiaOHvXbCFE7zKJ8TmvIA/132","nickname":"Geek_c2089d","note":"","ucode":"C66D345042525F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":370147,"discussion_content":"æŸ¥çœ‹docker0æ˜¯å­˜åœ¨çš„ï¼Œæ¯æ¬¡docker restart å°±ä¼šå‡ºç°ï¼Œä½†æ˜¯rebootæœºå™¨å°±å¥½äº†ï¼Œdockerç‰ˆæœ¬æ˜¯1.3,å†…æ ¸ç‰ˆæœ¬æ˜¯2.6","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619312841,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":285986,"user_name":"Roy Liang","can_delete":false,"product_type":"c1","uid":1098898,"ip_address":"","ucode":"1DF5FC831A35DA","user_header":"https://static001.geekbang.org/account/avatar/00/10/c4/92/338b5609.jpg","comment_is_top":false,"comment_ctime":1617093635,"is_pvip":false,"replies":[{"id":"104447","content":"èµï¼","user_name":"ä½œè€…å›å¤","user_name_real":"CY","uid":"2070138","ctime":1618058547,"ip_address":"","comment_id":285986,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1617093635","product_id":100063801,"comment_content":"ç”¨tcpdumpæŠ“åŒ…æ’æŸ¥é—®é¢˜çš„æ€è·¯å€¼å¾—å‚è€ƒï¼ŒåŒæ—¶ç†è§£äº†ç¤ºæ„å›¾ä¸Šçš„æ•°æ®é“¾è·¯ä¸­æ¯ä¸€ä¸ªèŠ‚ç‚¹çš„ä½œç”¨","like_count":0,"discussions":[{"author":{"id":2070138,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/96/7a/8a14d008.jpg","nickname":"CY","note":"","ucode":"4AF98230985918","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":517841,"discussion_content":"èµï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618058547,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":281490,"user_name":"Geek_41a96e","can_delete":false,"product_type":"c1","uid":2346399,"ip_address":"","ucode":"48095B46C0A63C","user_header":"","comment_is_top":false,"comment_ctime":1614763875,"is_pvip":false,"replies":[{"id":"102398","content":"æ˜¯çš„ï¼Œå¦‚æœ&#47;var&#47;run&#47;netns ä¸å­˜åœ¨ï¼Œäº‹å…ˆå»ºä¸€ä¸‹ã€‚ `mkdir -p &#47;var&#47;run&#47;netns`","user_name":"ä½œè€…å›å¤","user_name_real":"CY","uid":"2070138","ctime":1615036610,"ip_address":"","comment_id":281490,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1614763875","product_id":100063801,"comment_content":"[root@tyy-node06 ~]# ln -s &#47;proc&#47;$pid&#47;ns&#47;net &#47;var&#47;run&#47;netns&#47;$pid<br>ln: failed to create symbolic link â€˜&#47;var&#47;run&#47;netns&#47;24847â€™: No such file or directoryï¼Œç›®å½•&#47;var&#47;run&#47;netns&#47;ä¸å­˜åœ¨è¦æ‰‹åŠ¨åˆ›å»ºå—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":2070138,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/96/7a/8a14d008.jpg","nickname":"CY","note":"","ucode":"4AF98230985918","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":516416,"discussion_content":"æ˜¯çš„ï¼Œå¦‚æœ/var/run/netns ä¸å­˜åœ¨ï¼Œäº‹å…ˆå»ºä¸€ä¸‹ã€‚ `mkdir -p /var/run/netns`","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1615036610,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":270240,"user_name":"äº‰å…‰ Alan","can_delete":false,"product_type":"c1","uid":1336328,"ip_address":"","ucode":"338534F909AF03","user_header":"https://static001.geekbang.org/account/avatar/00/14/64/08/0287f41f.jpg","comment_is_top":false,"comment_ctime":1609000195,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1609000195","product_id":100063801,"comment_content":"æˆ‘çš„ç†è§£<br>å¤–éƒ¨è®¿é—®å®¹å™¨ï¼Œä¸€ä¸ªåŒ…åœ¨ä¸»æœºä¸Šçš„å¤„ç†å¤§æ¦‚æ˜¯<br>ç»è¿‡postroutingé“¾ï¼Œæœ¬åœ°è·¯ç”±ï¼Œinput&#47;forwordã€‚ã€‚ã€‚<br><br>æ‰€ä»¥å¦‚æœéœ€è¦ä¸»æœºè®¿é—®å®¹å™¨<br>æ–¹æ¡ˆä¸€<br>1.å¯ä»¥åœ¨postroutingé“¾å¢åŠ ç›®çš„åœ°æ˜¯docker0çš„ç½‘ç»œæ¥æ”¶<br>2.ç»è¿‡è·¯ç”±çš„æ—¶å€™ï¼Œå­˜åœ¨docker0ç›´é€šè·¯ç”±ï¼Œä¼šæ¥æ”¶å¤„ç†<br>ä½†è¿™æ ·åªèƒ½æ˜¯æœ¬ä¸»æœºè®¿é—®ï¼Œå¦‚æœæ˜¯å…¶ä»–ä¸»æœºï¼Œè¿˜éœ€è¦åœ¨å…¶ä»–ä¸»æœºé…ç½®ï¼ŒæŠŠåˆ°è¯¥docker0çš„åŒ…å‘è¿‡æ¥(æ¯”å¦‚å€ŸåŠ©overlayç­‰)<br><br>æ–¹æ¡ˆäºŒ<br>åšnatï¼Œè®¿é—®ä¸»æœºæŸç«¯å£çš„æµé‡è½¬ç»™å®¹å™¨çš„æŸä¸ªç«¯å£ï¼Œåˆ™<br>1.åœ¨postroutingé“¾å¢åŠ dnatå³å¯<br><br>è€å¸ˆå¯¹å—ï¼Ÿ","like_count":0},{"had_liked":false,"id":269824,"user_name":"Geek_ba556d","can_delete":false,"product_type":"c1","uid":2187528,"ip_address":"","ucode":"FF3A00C32D2874","user_header":"","comment_is_top":false,"comment_ctime":1608800178,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1608800178","product_id":100063801,"comment_content":"[root@localhost ~]# route -n<br>Kernel IP routing table<br>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface<br>0.0.0.0         192.168.128.2   0.0.0.0         UG    0      0        0 ens33<br>169.254.0.0     0.0.0.0         255.255.0.0     U     1002   0        0 ens33<br>172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0<br>172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 veth_host<br>192.168.128.0   0.0.0.0         255.255.255.0   U     0      0        0 ens33<br><br>å¦‚æœveth_hostæœ¬åœ°ç½‘å¡é…ç½®éƒ½æ˜¯16ä½ï¼Œä¼šå‡ºç°pingä¸é€šçš„æƒ…å†µ","like_count":0,"discussions":[{"author":{"id":3166673,"avatar":"https://static001.geekbang.org/account/avatar/00/30/51/d1/ad847b1d.jpg","nickname":"äºŒé˜¶å¯¼","note":"","ucode":"4B09AA0875224B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":585546,"discussion_content":"ç¡®å®ï¼Œæˆ‘ä¹Ÿé‡åˆ°äº†è¿™ç§æƒ…å†µã€‚veth_hosté…ç½®æˆ24ä½å€’æ˜¯å¯ä»¥pingé€š","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661674903,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å¹¿ä¸œ"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":269551,"user_name":"Helios","can_delete":false,"product_type":"c1","uid":1380758,"ip_address":"","ucode":"BE6B98EE8F0D09","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKJrOl63enWXCRxN0SoucliclBme0qrRb19ATrWIOIvibKIz8UAuVgicBMibIVUznerHnjotI4dm6ibODA/132","comment_is_top":false,"comment_ctime":1608699325,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1608699325","product_id":100063801,"comment_content":"ä»¥å‰è™šæ‹Ÿæœºæ—¶ä»£ï¼Œåœ¨è·¯ç”±å™¨ä¸Šé…ç½®æŸä¸ªç½‘æ®µçš„è®¾å¤‡éƒ½å‘é€ç»™ä¸€å°æœºå™¨ï¼Œç„¶åç”±è¿™ä¸ªæœºå™¨åœ¨åšè·¯ç”±è½¬å‘","like_count":0}]}