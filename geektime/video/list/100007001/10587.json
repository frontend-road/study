{"id":10587,"title":"59 | Zuul网关生产部署实践","content":"无","comments":[{"had_liked":false,"id":81955,"user_name":"DZ","can_delete":false,"product_type":"c3","uid":1047376,"ip_address":"","ucode":"58BF0042E31449","user_header":"https://static001.geekbang.org/account/avatar/00/0f/fb/50/04071be6.jpg","comment_is_top":false,"comment_ctime":1554087510,"is_pvip":true,"replies":[{"id":29690,"content":"你好，consul + nginx + consul template可以实现nginx动态负载均衡，因为nginx是基于配置文件的，配置文件变更可以出发reload。zuul原生是不支持配置文件（除非定制），但是zuul + ribbon + consul应该也可以实现动态负载均衡，这个是基于内存方式的，具体参考spring cloud的官方文档：https:&#47;&#47;cloud.spring.io&#47;spring-cloud-consul&#47;spring-cloud-consul.html。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1554122805,"ip_address":"","comment_id":81955,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"杨老师，请教下nginx和zuul集群之间是否也可以通过consul template来做动态的负载均衡？","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":445406,"discussion_content":"你好，consul + nginx + consul template可以实现nginx动态负载均衡，因为nginx是基于配置文件的，配置文件变更可以出发reload。zuul原生是不支持配置文件（除非定制），但是zuul + ribbon + consul应该也可以实现动态负载均衡，这个是基于内存方式的，具体参考spring cloud的官方文档：https://cloud.spring.io/spring-cloud-consul/spring-cloud-consul.html。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1554122805,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":38988,"user_name":"kong","can_delete":false,"product_type":"c3","uid":1299514,"ip_address":"","ucode":"4020CA7830FF5E","user_header":"https://static001.geekbang.org/account/avatar/00/13/d4/3a/61770858.jpg","comment_is_top":false,"comment_ctime":1542167372,"is_pvip":false,"replies":[{"id":15529,"content":"这个要看企业的具体微服务架构是怎么做的，有些企是用eureka做服务注册发现的，这时服务提供方起动时需要注册到eureka，服务消费方（包括网关）从eureka发现服务并发起调用。有些企业没有用eureka做服务发现，而是用传统DNS+nginx，这时服务地址就不是自动注册的，而是一般由运维静态配置，这种方案也可以工作，也是微服务的一种架构方式，当然自动化程度和灵活性要比前一种差一点。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1543237721,"ip_address":"","comment_id":38988,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"波波老师：请教一个问题，部署图中微服务不需要和eureka发现服务通信吗？我的理解是微服务启动时通过向eureka注册服务，网关处理路由时向eureka查询到微服务地址后进行转发的。","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":428873,"discussion_content":"这个要看企业的具体微服务架构是怎么做的，有些企是用eureka做服务注册发现的，这时服务提供方起动时需要注册到eureka，服务消费方（包括网关）从eureka发现服务并发起调用。有些企业没有用eureka做服务发现，而是用传统DNS+nginx，这时服务地址就不是自动注册的，而是一般由运维静态配置，这种方案也可以工作，也是微服务的一种架构方式，当然自动化程度和灵活性要比前一种差一点。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1543237721,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":34345,"user_name":"Sam_Deep_Thinking","can_delete":false,"product_type":"c3","uid":1001152,"ip_address":"","ucode":"8E4EF6F24B821B","user_header":"https://static001.geekbang.org/account/avatar/00/0f/46/c0/106d98e7.jpg","comment_is_top":false,"comment_ctime":1540119966,"is_pvip":false,"replies":[{"id":12659,"content":"zuul本身无状态，以集群部署保证HA，前面一般需负载均衡器LB，如硬件F5或软件lvs&#47;nginx等。如果没有LB一层，客户端直连zuul，zuul只布一台就会成单点瓶颈。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1540732822,"ip_address":"","comment_id":34345,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"杨老师，在zuul网关之前，为啥一定的得有ngnix？ 能不能客户端（例如小程序端、手机端）直接对接zuul网关呢？从而减少一层转发。","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":427181,"discussion_content":"zuul本身无状态，以集群部署保证HA，前面一般需负载均衡器LB，如硬件F5或软件lvs/nginx等。如果没有LB一层，客户端直连zuul，zuul只布一台就会成单点瓶颈。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1540732822,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":164836,"user_name":"千里不留行","can_delete":false,"product_type":"c3","uid":1099957,"ip_address":"","ucode":"7F9C518E6E0DFD","user_header":"https://static001.geekbang.org/account/avatar/00/10/c8/b5/b32ff06d.jpg","comment_is_top":false,"comment_ctime":1577098193,"is_pvip":false,"replies":[{"id":63272,"content":"zuul前置有nginx反向代理集群，域名指向nginx集群，nginx上可以配置域名到后台zuul集群ip地址列表的映射关系。\n\n网关如果挂了，nginx有自动健康检查和摘除功能。\n\n","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1577357182,"ip_address":"","comment_id":164836,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"波波老师，您好，有个问题请教下。\n域名是怎么对应到网关集群中的网关服务的？这块是不是做了dns轮询处理？如果集群中某个网关服务挂掉了是怎么避免请求转到该网关服务上？","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":478913,"discussion_content":"zuul前置有nginx反向代理集群，域名指向nginx集群，nginx上可以配置域名到后台zuul集群ip地址列表的映射关系。\n\n网关如果挂了，nginx有自动健康检查和摘除功能。\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577357182,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":108534,"user_name":"又双叒叕是一年啊","can_delete":false,"product_type":"c3","uid":1000015,"ip_address":"","ucode":"E067320E537DEE","user_header":"https://static001.geekbang.org/account/avatar/00/0f/42/4f/ff1ac464.jpg","comment_is_top":false,"comment_ctime":1561795068,"is_pvip":false,"replies":[{"id":39532,"content":"filter存储没有特别的要求，Netflix Zuul原生支持的Cassandra这种K&#47;V存储，实际用Mysql之类数据库也可以。Zuul可以对接Eureka，做服务发现和LB，可以直接看Spring Cloud的文档，Zuul通过Ribbon对接Eureka。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1561982456,"ip_address":"","comment_id":108534,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"波波老师 ， 请问 过滤器管理站点 找个 过滤器存储一般采用什么存储？  另外 zuul可以对接 eureka 做后端微服务的 注册发现 和 负载均衡？","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":456029,"discussion_content":"filter存储没有特别的要求，Netflix Zuul原生支持的Cassandra这种K/V存储，实际用Mysql之类数据库也可以。Zuul可以对接Eureka，做服务发现和LB，可以直接看Spring Cloud的文档，Zuul通过Ribbon对接Eureka。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561982456,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":63374,"user_name":"hunterlodge","can_delete":false,"product_type":"c3","uid":1069755,"ip_address":"","ucode":"5B83A79E784161","user_header":"https://static001.geekbang.org/account/avatar/00/10/52/bb/225e70a6.jpg","comment_is_top":false,"comment_ctime":1548335698,"is_pvip":false,"replies":[{"id":22558,"content":"你好，我们之前的生产实践，zuul集群实例是运维在nginx上静态配置的（也有集中可视化配置界面），因为zuul集群扩容并不频繁，所以这种静态配置ok。如果你要做成动态，需要对nginx做扩展，比如点评开源的camel，可以提供API操作nginx，或者你可以考虑kong，也提供可编程API，然后你可以将zuul和eureka集成动态发现，eureka再对接camel&#47;kong这种方式（中间需要开发一个协调器），可以做到动态配置zuul集群。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1548508595,"ip_address":"","comment_id":63374,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"杨老师，nginx和zuul集群之间的负载均衡一般是怎么工作以及配置的呢？又是如何做到动态变化的呢？谢谢！","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437566,"discussion_content":"你好，我们之前的生产实践，zuul集群实例是运维在nginx上静态配置的（也有集中可视化配置界面），因为zuul集群扩容并不频繁，所以这种静态配置ok。如果你要做成动态，需要对nginx做扩展，比如点评开源的camel，可以提供API操作nginx，或者你可以考虑kong，也提供可编程API，然后你可以将zuul和eureka集成动态发现，eureka再对接camel/kong这种方式（中间需要开发一个协调器），可以做到动态配置zuul集群。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548508595,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":31999,"user_name":"成","can_delete":false,"product_type":"c3","uid":1053969,"ip_address":"","ucode":"514D161041B5B2","user_header":"https://static001.geekbang.org/account/avatar/00/10/15/11/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1539353882,"is_pvip":false,"replies":[{"id":11726,"content":"恩赞👍，配置中心和CAT相对比较容易落地，能对系统稳定性和灵活性带来立竿见影效果","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1539514944,"ip_address":"","comment_id":31999,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"感谢杨老师这么认真的做课程，配置中心和cat已经用到了我的项目中了，给项目带来了很实在的好处。","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426604,"discussion_content":"恩赞👍，配置中心和CAT相对比较容易落地，能对系统稳定性和灵活性带来立竿见影效果","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539514944,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":345862,"user_name":"死磕郎一世","can_delete":false,"product_type":"c3","uid":1272996,"ip_address":"","ucode":"86C1197C3FB2A0","user_header":"https://static001.geekbang.org/account/avatar/00/13/6c/a4/7f7c1955.jpg","comment_is_top":false,"comment_ctime":1652661164,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"波波老师：不同类型的客户端请求的域名应该是一样的吧，如果域名一样，图中nginx这一层是怎么识别客户端的请求是无线还是H5还是PC？","like_count":0}]}