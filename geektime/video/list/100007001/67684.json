{"id":67684,"title":"134 | Prometheus 监控最佳实践","content":"无","comments":[{"had_liked":false,"id":103141,"user_name":"💀WILL-beta💀","can_delete":false,"product_type":"c3","uid":1044424,"ip_address":"","ucode":"22DA1271C705B3","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ef/c8/9d9581cb.jpg","comment_is_top":false,"comment_ctime":1560387500,"is_pvip":false,"replies":[{"id":37702,"content":"不直接支持，除非你定制Prometheus的源码。建议开发一个SideCar(比如用java)，这个SideCar和Prometheus住在一个机器上，两个进程，这个SideCar可以对接读取Apollo的配置，然后更新Prometheus的本地配置文件，Promethues可以感知配置文件的变化并动态加载。这个工作量不是很大。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1560678459,"ip_address":"","comment_id":103141,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"请问老师：Prometheus支持通过Apollo实现动态配置吗？","like_count":2,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":453751,"discussion_content":"不直接支持，除非你定制Prometheus的源码。建议开发一个SideCar(比如用java)，这个SideCar和Prometheus住在一个机器上，两个进程，这个SideCar可以对接读取Apollo的配置，然后更新Prometheus的本地配置文件，Promethues可以感知配置文件的变化并动态加载。这个工作量不是很大。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1560678459,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":103712,"user_name":"又双叒叕是一年啊","can_delete":false,"product_type":"c3","uid":1000015,"ip_address":"","ucode":"E067320E537DEE","user_header":"https://static001.geekbang.org/account/avatar/00/0f/42/4f/ff1ac464.jpg","comment_is_top":false,"comment_ctime":1560496418,"is_pvip":false,"replies":[{"id":37710,"content":"AlertManager一般弄一台就够了(它是有状态的一般不能部两个)，挂了暂时没有告警，如果不放心，可以做一套元监控，也就是单独再搭一套Prometheus+AlertManager，由它去监控原来那套Prometheus+AlertManager。Grafana也不太要紧，一般部两个做HA躲在nginx后面即可(https:&#47;&#47;grafana.com&#47;docs&#47;tutorials&#47;ha_setup&#47;)。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1560682454,"ip_address":"","comment_id":103712,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"老师您好，想请问下 Prometheus 3种方式高可用架构 其中 Altermanager 单独部署一台就可以了是吗？还有 Grafana 要怎么部署有推荐方案吗","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":453975,"discussion_content":"AlertManager一般弄一台就够了(它是有状态的一般不能部两个)，挂了暂时没有告警，如果不放心，可以做一套元监控，也就是单独再搭一套Prometheus+AlertManager，由它去监控原来那套Prometheus+AlertManager。Grafana也不太要紧，一般部两个做HA躲在nginx后面即可(https://grafana.com/docs/tutorials/ha_setup/)。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1560682454,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":214625,"user_name":"张爽","can_delete":false,"product_type":"c3","uid":1021129,"ip_address":"","ucode":"ED2969DA26E8E0","user_header":"https://static001.geekbang.org/account/avatar/00/0f/94/c9/374a69f2.jpg","comment_is_top":false,"comment_ctime":1588774457,"is_pvip":false,"replies":[{"id":79673,"content":"数据不会重复，因为每个Prometheus都有自己独立存储，这样做只是一种简单HA做法，只是会重复拉取两次。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1588949274,"ip_address":"","comment_id":214625,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"Prometheus是pull的模式，如果启两台去pull应用的metrics，会存在重复抓取的情况，HA只是在接收请求才有意义，不太明白这种HA如何保证只抓取一次数据","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":494144,"discussion_content":"数据不会重复，因为每个Prometheus都有自己独立存储，这样做只是一种简单HA做法，只是会重复拉取两次。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588949274,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":181064,"user_name":"天空大海","can_delete":false,"product_type":"c3","uid":1007748,"ip_address":"","ucode":"CF625DF1D89856","user_header":"https://static001.geekbang.org/account/avatar/00/0f/60/84/354dafcb.jpg","comment_is_top":false,"comment_ctime":1582468741,"is_pvip":false,"replies":[{"id":70411,"content":"看一个东西是否有状态，你就看它是否能水平无状态扩容。如果你有一个Promethues服务，然后部署多个AlertManager，实际Promethues可以配其中一个AlertManager作为告警信息接受者，那么其它多部署的AlertManager就没用浪费了；你也可以把这个Prometheus配置所有的AlertManager作为告警信息接收者，那么当Promethues触发告警时，这时这些AlertManager会发送重复的告警通知。具体判断AlertManager有状态。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1582637869,"ip_address":"","comment_id":181064,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"波波老师，AlertManager是有状态的吧具体都指哪些地方？","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":484904,"discussion_content":"看一个东西是否有状态，你就看它是否能水平无状态扩容。如果你有一个Promethues服务，然后部署多个AlertManager，实际Promethues可以配其中一个AlertManager作为告警信息接受者，那么其它多部署的AlertManager就没用浪费了；你也可以把这个Prometheus配置所有的AlertManager作为告警信息接收者，那么当Promethues触发告警时，这时这些AlertManager会发送重复的告警通知。具体判断AlertManager有状态。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582637869,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1007748,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/60/84/354dafcb.jpg","nickname":"天空大海","note":"","ucode":"CF625DF1D89856","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":185826,"discussion_content":"没明白，配多个nginx也会带来重复流量啊，配一个其他部署的nginx也浪费了，但nginx是无状态的吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582641003,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":103143,"user_name":"💀WILL-beta💀","can_delete":false,"product_type":"c3","uid":1044424,"ip_address":"","ucode":"22DA1271C705B3","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ef/c8/9d9581cb.jpg","comment_is_top":false,"comment_ctime":1560387742,"is_pvip":false,"replies":[{"id":37703,"content":"两个方案，一个是采用Promethues的服务发现ServiceDiscovery机制，可以发现具体的服务实例然后采集metrics，可能需要针对云服务的API进行扩展，具体可以参考https:&#47;&#47;github.com&#47;prometheus&#47;prometheus&#47;tree&#47;master&#47;discovery，这里已经有一些云服务对接支持。第二方案是采用push模式，让客户端直接把metrics push出来到Promethues的Push Gateway，这个Promethues也是支持的。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1560678879,"ip_address":"","comment_id":103143,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"请问老师：Prometheus如何支持隐藏在一个域名后的多个实例呢？比如各云厂商提供的WebAPP的PaaS，一个域名后有多个实例，貌似不能让Prometheus去拉各个实例的Metrics数据。只能自己写exporter对吧？","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":453753,"discussion_content":"两个方案，一个是采用Promethues的服务发现ServiceDiscovery机制，可以发现具体的服务实例然后采集metrics，可能需要针对云服务的API进行扩展，具体可以参考https://github.com/prometheus/prometheus/tree/master/discovery，这里已经有一些云服务对接支持。第二方案是采用push模式，让客户端直接把metrics push出来到Promethues的Push Gateway，这个Promethues也是支持的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1560678879,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}