{"id":731043,"title":"19ï½œRustçš„å®ä½“ç³»ï¼šä¸ºè‡ªå·±çš„é¡¹ç›®å†™ä¸€ä¸ªç®€å•çš„å£°æ˜å®","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯Mikeï¼Œä»Šå¤©æˆ‘ä»¬ä¸€èµ·æ¥å­¦ä¹ Rustè¯­è¨€ä¸­æœ‰å…³å®çš„çŸ¥è¯†ã€‚</p><p>å®æ˜¯ä¸€å¥—é¢„å¤„ç†è®¾æ–½ã€‚å®ƒçš„è¾“å…¥æ˜¯ä»£ç æœ¬èº«ï¼Œå¯¹ä»£ç è¿›è¡Œå˜æ¢ç„¶åè¾“å‡ºæ–°çš„ä»£ç ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè¾“å‡ºçš„æ–°ä»£ç å¿…é¡»æ˜¯åˆæ³•çš„å½“å‰è¯­è¨€çš„ä»£ç ï¼Œç”¨æ¥å–‚ç»™å½“å‰è¯­è¨€çš„ç¼–è¯‘å™¨è¿›è¡Œç¼–è¯‘ã€‚</p><p>å®ä¸æ˜¯ä¸€é—¨è¯­è¨€çš„å¿…å¤‡é€‰é¡¹ï¼ŒJavaã€Goç­‰è¯­è¨€å°±æ²¡æœ‰å®ï¼Œè€ŒCã€CPPã€Rustç­‰è¯­è¨€æœ‰å®ï¼Œè€Œä¸”å®ƒä»¬çš„å®å·¥ä½œæ–¹å¼ä¸ä¸€æ ·ã€‚</p><p>åœ¨Rustè¯­è¨€ä¸­ï¼Œå®ä¹Ÿå±äºè¯­è¨€çš„å¤–å›´åŠŸèƒ½ï¼Œç”¨æ¥å¢å¼ºRustè¯­è¨€çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œè®©Rustè¯­è¨€å˜å¾—æ›´æ–¹ä¾¿å¥½ç”¨ã€‚å®ä¸å±äºRustè¯­è¨€çš„æ ¸å¿ƒï¼Œä½†è¿™å¹¶ä¸æ˜¯è¯´å®åœ¨Rustä¸­ä¸é‡è¦ã€‚å…¶å®åœ¨Rustä»£ç ä¸­ï¼Œå®éšå¤„å¯è§ï¼ŒæŒæ¡å®çš„åŸç†å’Œç”¨æ³•ï¼Œæœ‰åŠ©äºæˆ‘ä»¬ç¼–å†™æ›´é«˜æ•ˆçš„Rustä»£ç ã€‚</p><p>åœ¨Rustä¸­ï¼Œå®çš„è§£æå’Œæ‰§è¡Œæ˜¯åœ¨Rustä»£ç çš„ç¼–è¯‘é˜¶æ®µä¹‹å‰ã€‚ä½ å¯ä»¥ç†è§£æˆï¼Œåœ¨Rustä»£ç ç¼–è¯‘ä¹‹å‰æœ‰ä¸€ä¸ªå®å±•å¼€çš„è¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹çš„è¾“å‡ºç»“æœå°±æ˜¯å®Œæ•´ç‰ˆçš„Rustä»£ç ï¼Œç„¶åRustç¼–è¯‘å™¨å†æ¥ç¼–è¯‘è¿™ä¸ªè¾“å‡ºçš„ä»£ç ã€‚</p><h2>Rustè¯­è¨€ä¸­çš„å®</h2><p>å½“å‰ç‰ˆæœ¬çš„Rustä¸­æœ‰ä¸¤å¤§ç±»å®ï¼šå£°æ˜å®ï¼ˆdeclarative macroï¼‰å’Œè¿‡ç¨‹å®ï¼ˆprocedure macroï¼‰ï¼Œè€Œè¿‡ç¨‹å®åˆç»†åˆ†æˆä¸‰ç§ï¼šæ´¾ç”Ÿå®ã€å±æ€§å®å’Œå‡½æ•°å®ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬åˆ†åˆ«ä»‹ç»ä¸€ä¸‹å®ƒä»¬ã€‚</p><!-- [[[read_end]]] --><h3>å£°æ˜å®</h3><p>å£°æ˜å®æ˜¯ç”¨ <code>macro_rules!</code> å®šä¹‰çš„å®ï¼Œæˆ‘ä»¬å¸¸è§çš„ <code>println!()</code>ã€<code>vec![]</code> éƒ½æ˜¯è¿™ç§å®ã€‚æ¯”å¦‚ <code>vec![]</code> æ˜¯æŒ‰ç±»ä¼¼ä¸‹é¢è¿™ç§æ–¹å¼å®šä¹‰çš„ï¼š</p><pre><code class=\"language-plain\">#[macro_export]\nmacro_rules! vec {\n    ( $( $x:expr ),* ) =&gt; {\n        {\n            let mut temp_vec = Vec::new();\n            $(\n                temp_vec.push($x);\n            )*\n            temp_vec\n        }\n    };\n}\n</code></pre><p><span class=\"reference\">æ³¨ï¼šä»£ç æ¥è‡ªå®˜æ–¹ The Bookï¼Œè¿™æ˜¯ä¸€ä¸ªæ¼”ç¤ºç‰ˆçš„å®šä¹‰ï¼Œå®é™…çš„ <code>vec!</code> çš„å®šä¹‰æ¯”è¿™ä¸ªè¦å¤æ‚å¾—å¤šã€‚</span></p><p>è¿™æ˜¯ä»€ä¹ˆä»£ç ï¼Ÿå®Œå…¨çœ‹ä¸æ‡‚ï¼Œä¸æ˜¯æ­£å¸¸çš„Rustä»£ç å§ï¼Ÿæ˜¯çš„ï¼Œä¸ºäº†å¯¹Rustä»£ç æœ¬èº«è¿›è¡Œæ“ä½œï¼Œéœ€è¦é‡æ–°å®šä¹‰ä¸€å¥—è¯­æ³•å½¢å¼ï¼Œè€Œè¿™ç§è¯­æ³•å½¢å¼ï¼Œåªåœ¨ <code>macro_rules!</code> é‡Œæœ‰æ•ˆã€‚</p><p>å®æ•´ä½“ä¸Šæ¥è¯´ï¼Œä½¿ç”¨äº†ä¸€ç§<strong>ä»£ç åŒ¹é… + ç”Ÿæˆæœºåˆ¶</strong>æ¥ç”Ÿæˆæ–°çš„ä»£ç ã€‚ä¸Šé¢ä»£ç é‡Œçš„ <code>$()</code> ç”¨æ¥åŒ¹é…ä»£ç æ¡ç›®ã€‚<code>$x:expr</code> è¡¨ç¤ºåŒ¹é…çš„æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼ŒåŒ¹é…åçš„æ¡ç›®ç”¨ <code>$x</code> ä»£æ›¿ã€‚<code>*</code> è¡¨ç¤ºå‰é¢è¿™ä¸ªæ¨¡å¼å¯ä»¥é‡å¤0æ¬¡æˆ–è€…1æ¬¡ä»¥ä¸Šï¼Œè¿™ä¸ªæ¨¡å¼å°±æ˜¯ <code>$( $x:expr ),</code>ï¼Œæ³¨æ„ <code>$()</code> åé¢æœ‰ä¸ª<code>ï¼Œ</code>å·ï¼Œè¿™ä¸ªé€—å·ä¹Ÿæ˜¯è¿™ä¸ªæ¨¡å¼ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œåœ¨åŒ¹é…çš„æ—¶å€™æ˜¯ä¸€ä¸ªå¯é€‰é¡¹ï¼Œæœ‰å°±åŒ¹é…ï¼Œé‡åˆ°æœ€åä¸€ä¸ªåŒ¹é…é¡¹çš„æ—¶å€™ï¼Œå°±å¿½ç•¥å®ƒã€‚<code>=&gt;</code> å‰é¢æ˜¯èµ·åŒ¹é…ä½œç”¨çš„éƒ¨åˆ†ï¼Œ<code>=&gt;</code> åé¢æ˜¯ç”Ÿæˆä»£ç çš„éƒ¨åˆ†ã€‚</p><p>åœ¨ç”Ÿæˆä»£ç çš„éƒ¨åˆ†ä¸­ï¼Œ<code>$()</code> å·å’Œ <code>=&gt;</code> å‰é¢é‚£ä¸ª <code>$()</code> çš„ä½œç”¨å·®ä¸å¤šï¼Œå°±æ˜¯è¡¨æ˜è¢«åŒ…èµ·æ¥çš„è¿™å—ä»£ç æ˜¯å¯é‡å¤çš„ã€‚ç´§è·Ÿçš„ <code>*</code> è¡¨ç¤ºè¿™ä¸ªä»£ç å—å¯ä»¥é‡å¤0æ¬¡åˆ°å¤šæ¬¡ã€‚å…·ä½“æ¬¡æ•°ç­‰äº <code>=&gt;</code> å·å‰é¢çš„ <code>*</code> å·æ‰€ä»£è¡¨çš„æ¬¡æ•°ï¼Œä¸¤ä¸ªä¸€è‡´ã€‚ä¸‹é¢æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ‹¥æœ‰ä¸‰ä¸ªæ•´æ•°å…ƒç´ çš„Vecã€‚</p><pre><code class=\"language-plain\">let v = vec![1,2,3];\n</code></pre><p>ä»£ç å±•å¼€åå®é™…å°±æ˜¯ï¼š</p><pre><code class=\"language-plain\">{\n    let mut temp_vec = Vec::new();\n    temp_vec.push(1);\n    temp_vec.push(2);\n    temp_vec.push(3);\n    temp_vec\n}\n</code></pre><p>ä½ å¯ä»¥çœ‹åˆ°ï¼Œ<code>temp_vec.push();</code> é‡å¤äº†3æ¬¡ï¼Œè¿™æ˜¯å› ä¸º <code>1,2,3</code> åŒ¹é… <code>$x: expr</code>ï¼ŒåŒ¹é…äº†3æ¬¡ï¼Œåˆ†åˆ«åŒ¹é…å‡º 1ã€2ã€3 ä¸‰ä¸ªæ•´æ•°ã€‚ç„¶åå°±ç”Ÿæˆäº†ä¸‰è¡Œ <code>temp_vec.push();</code>ã€‚</p><p>ä½ å¯èƒ½ä¼šé—®ï¼Œ<code>vec![]</code> è¿™å¯¹ä¸­æ‹¬å·å“ªé‡Œå»äº†ï¼Ÿå…¶å®åœ¨Rustä¸­ï¼Œä½ ç”¨ ()ã€[]ã€{} éƒ½å¯ä»¥ï¼Œæ¯”å¦‚ï¼š</p><pre><code class=\"language-plain\">let a = vec!(0, 1, 2);\nlet b = vec![0, 1, 2];\nlet c = vec! { 0, 1, 2 };\n</code></pre><p>ä¸è¿‡ä¹Ÿç¡®å®å­˜åœ¨ä¸€äº›ä¹ æƒ¯æ€§çš„è¡¨è¿°ï¼Œæ¯”å¦‚å¯¹äºVecè¿™ç§åˆ—è¡¨ï¼Œç”¨ [] æ˜¾å¾—æ›´åœ°é“ï¼Œå…¶ä»–è¯­è¨€ä¹Ÿå¤šç”¨ []ï¼Œè¿™æ ·èƒ½å¤Ÿå’Œç¨‹åºå‘˜çš„ä¹ æƒ¯ä¿æŒä¸€è‡´ã€‚å¯¹äºç±»å‡½æ•°å¼çš„è°ƒç”¨ï¼Œä½¿ç”¨ () æ›´åœ°é“ã€‚å¯¹äºæ„å»ºç»“æ„ä½“ä¹‹ç±»çš„å®æˆ–è€…å­˜åœ¨å¤§æ®µä»£ç è¾“å…¥çš„æƒ…å†µï¼Œç”¨ {} æ›´åˆé€‚ã€‚</p><p>ç°åœ¨ä½ æ˜¯ä¸æ˜¯èƒ½è¯»æ‡‚ä¸€ç‚¹äº†ï¼Ÿ</p><p>ä¸Šé¢ä»£ç é‡Œçš„exprè¡¨ç¤ºè¦åŒ¹é…çš„itemæ˜¯ä¸ªè¡¨è¾¾å¼ã€‚å¸¸è§çš„åŒ¹é…æ–¹å¼æœ‰7ç§ã€‚</p><ul>\n<li>exprï¼šåŒ¹é…è¡¨è¾¾å¼</li>\n<li>tyï¼šåŒ¹é…ç±»å‹</li>\n<li>stmtï¼šåŒ¹é…è¯­å¥</li>\n<li>itemï¼šåŒ¹é…ä¸€ä¸ªitem</li>\n<li>identï¼šåŒ¹é…ä¸€ä¸ªæ ‡è¯†ç¬¦</li>\n<li>pathï¼šåŒ¹é…ä¸€ä¸ªpath</li>\n<li>ttï¼šåŒ¹é…ä¸€ä¸ªtoken tree</li>\n</ul><p>å®Œæ•´çš„è¯´æ˜ï¼Œä½ å¯ä»¥çœ‹æˆ‘ç»™å‡ºçš„å‚è€ƒ<a href=\"https://doc.rust-lang.org/stable/reference/macros-by-example.html\">é“¾æ¥</a>ã€‚</p><p>å¸¸è§çš„é‡å¤ç¬¦å·æœ‰3ä¸ªã€‚</p><ul>\n<li><code>*</code> è¡¨ç¤ºé‡å¤0åˆ°å¤šæ¬¡ã€‚</li>\n<li><code>+</code> è¡¨ç¤ºé‡å¤1åˆ°å¤šæ¬¡ã€‚</li>\n<li><code>?</code> è¡¨ç¤ºé‡å¤0æ¬¡æˆ–1æ¬¡ã€‚</li>\n</ul><p>åˆ©ç”¨åˆšåˆšå­¦åˆ°çš„çŸ¥è¯†ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±åŠ¨æ‰‹å†™ä¸€ä¸ªå£°æ˜å®ã€‚</p><h3>è‡ªå·±åŠ¨æ‰‹å†™ä¸€ä¸ªå£°æ˜å®</h3><p><strong>ç›®æ ‡ï¼š</strong>å®ç°ä¸€ä¸ªåŠ æ³•å® <code>add!(1,2)</code>ï¼Œè¾“å‡ºç»“æœ 3ã€‚</p><p>ä½ å¯ä»¥çœ‹ä¸€ä¸‹ç¤ºä¾‹ä»£ç ã€‚</p><pre><code class=\"language-plain\">macro_rules! add {\n&nbsp; &nbsp; // ç¬¬ä¸€ä¸ªåˆ†æ”¯ï¼ŒåŒ¹é…ä¸¤ä¸ªå…ƒç´ çš„åŠ æ³•\n&nbsp; &nbsp; ($a:expr, $b:expr)=&gt;{\n&nbsp; &nbsp; &nbsp; &nbsp; {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $a+$b\n&nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; };\n&nbsp; &nbsp; // ç¬¬äºŒä¸ªåˆ†æ”¯ï¼šå½“åªæœ‰ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œä¹Ÿåº”è¯¥å¤„ç†ï¼Œè¿™æ˜¯è¾¹ç•Œæƒ…å†µ\n&nbsp; &nbsp; ($a:expr)=&gt;{\n&nbsp; &nbsp; &nbsp; &nbsp; {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $a\n&nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; }\n}\n\nfn main(){\n&nbsp; &nbsp; let x=0;\n&nbsp; &nbsp; let sum = add!(1,2);&nbsp; // è°ƒç”¨å®\n&nbsp; &nbsp; let sum = add!(x);\n}\n</code></pre><p>é€šè¿‡ç¤ºä¾‹æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå£°æ˜å®é‡Œé¢å¯ä»¥å†™å¤šä¸ªåŒ¹é…åˆ†æ”¯ï¼ŒRustä¼šæ ¹æ®åŒ¹é…åˆ°çš„æ¨¡å¼è‡ªåŠ¨é€‰æ‹©é€‚é…çš„åˆ†æ”¯è¿›è¡Œå¥—ç”¨ã€‚</p><p>æˆ‘ä»¬å¯ä»¥ç”¨ <code>cargo expand</code> æ¥å±•å¼€è¿™ä¸ªä»£ç ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/4b/e8/4bc66a9c6a378c89cd119e0acc189ee8.png?wh=2879x1643\" alt=\"\"></p><p>å±•å¼€åå®é™…æ˜¯ä¸‹é¢è¿™ä¸ªæ ·å­ã€‚</p><pre><code class=\"language-plain\">#![feature(prelude_import)]\n#[prelude_import]\nuse std::prelude::rust_2021::*;\n#[macro_use]\nextern crate std;\nmacro_rules! add {\n    ($a : expr, $b : expr) =&gt;\n    {\n        {\n            $a + $b\n            // ç¬¬ä¸€ä¸ªåˆ†æ”¯ï¼ŒåŒ¹é…ä¸¤ä¸ªå…ƒç´ çš„åŠ æ³•\n        }\n    } ; ($a : expr) =&gt;\n    {\n        {\n            $a\n            // ç¬¬äºŒä¸ªåˆ†æ”¯ï¼šå½“åªæœ‰ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œä¹Ÿåº”è¯¥å¤„ç†ï¼Œè¿™æ˜¯è¾¹ç•Œæƒ…å†µ\n        }\n    }\n}\nfn main() {\n    let x = 0;\n    let sum = { 1 + 2 }; // è°ƒç”¨å®\n    let sum = { x };\n}\n</code></pre><p>è¯·ä½ ä»”ç»†å¯¹æ¯”å±•å¼€å‰åçš„ä»£ç ï¼Œå¥½å¥½ç†è§£ä¸€ä¸‹ã€‚ä¸è¿‡ï¼Œä»…ä»…æ˜¯ä¸¤ä¸ªå…ƒç´ çš„ç›¸åŠ ï¼Œå†™ä¸ªå®å¥½åƒå¤šæ­¤ä¸€ä¸¾äº†ã€‚ä¸‹é¢æˆ‘ä»¬æŠŠå®ƒæ‰©å±•åˆ°å¤šä¸ªæ•°å­—çš„åŠ æ³•ã€‚</p><pre><code class=\"language-plain\">macro_rules! add {\n&nbsp; &nbsp; ( $($a:expr),* ) =&gt; {\n&nbsp; &nbsp; &nbsp; &nbsp;{&nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// å¼€å¤´è¦æœ‰ä¸ª0ï¼Œå¤„ç†æ²¡æœ‰ä»»ä½•å‚æ•°ä¼ å…¥çš„æƒ…å†µ\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// é‡å¤çš„å—\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;$( + $a )*\n&nbsp; &nbsp; &nbsp; &nbsp;}\n&nbsp; &nbsp; }\n}\n\nfn main(){\n&nbsp; &nbsp; let sum = add!();\n&nbsp; &nbsp; let sum = add!(1,2,3,4);\n}\n</code></pre><p>ä½ å¯ä»¥çœ‹ä¸€ä¸‹å®ƒå±•å¼€åçš„æ ·å­ã€‚</p><pre><code class=\"language-plain\">#![feature(prelude_import)]\n#[prelude_import]\nuse std::prelude::rust_2021::*;\n#[macro_use]\nextern crate std;\nmacro_rules! add {\n    ($($a : expr), *) =&gt;\n    {\n        {\n            0 $(+ $a) *\n            // å¼€å¤´è¦æœ‰ä¸ª0ï¼Œå¤„ç†æ²¡æœ‰ä»»ä½•å‚æ•°ä¼ å…¥çš„æƒ…å†µ\n            // é‡å¤çš„å—\n        }\n    }\n}\nfn main() { let sum = { 0 }; let sum = { 0 + 1 + 2 + 3 + 4 }; }\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œç»è¿‡ç®€å•çš„æ”¹é€ ï¼Œæˆ‘ä»¬çš„ <code>add!()</code> å®ç°åœ¨èƒ½å¤„ç†æ— é™å¤šçš„ç›¸åŠ é¡¹äº†ã€‚å¦‚æœæœ‰æ—¶é—´ï¼Œä½ å¯ä»¥è¿›ä¸€æ­¥è€ƒè™‘å¦‚ä½•å¤„ç†æ€»å’Œæº¢å‡ºçš„é—®é¢˜ã€‚</p><p>æˆ‘ä»¬å¯ä»¥å…ˆä»è¿™ç§ç®€å•çš„å®å…¥æ‰‹ï¼Œè¾¹å†™è¾¹å±•å¼€çœ‹æ•ˆæœï¼Œå®ç°ä¸€ä¸ªå£°æ˜å®å¹¶ä¸éš¾ã€‚</p><h3>macro_export</h3><p>åœ¨ä¸€ä¸ªæ¨¡å—ä¸­å†™å¥½å£°æ˜å®åï¼Œæƒ³è¦æä¾›ç»™å…¶ä»–æ¨¡å—ä½¿ç”¨çš„è¯ï¼Œä½ å¾—ä½¿ç”¨ <code>#[macro_export]</code> å¯¼å‡ºï¼Œæ¯”å¦‚ï¼š</p><pre><code class=\"language-plain\">mod inner {\n    super::m!();\n    crate::m!();\n}\nmod toexport {\n    #[macro_export]    // è¯·æ³¨æ„è¿™ä¸€å¥ï¼ŒæŠŠm!()å¯¼å‡ºåˆ°å½“å‰crate rootä¸‹äº†\n    macro_rules! m {\n        () =&gt; {};\n    }\n}\nfn foo() {\n    self::m!();  // mainå‡½æ•°åœ¨å½“å‰crateæ ¹ä¸‹ï¼Œå¯è¿™æ ·è°ƒç”¨m!()\n    m!();        // ç›´æ¥è°ƒç”¨ä¹Ÿæ˜¯å¯ä»¥çš„\n}\n</code></pre><p><code>#[macro_export]</code> å¯ä»¥æŠŠä½ å®šä¹‰çš„å®å¯¼å‡ºåˆ°å½“å‰ crate æ ¹ä¸‹ï¼Œè¿™æ ·åœ¨ crate é‡Œå¯ä»¥ç”¨ <code>crate::macro_name!</code> è®¿é—®ï¼ˆä¾‹å­é‡Œçš„ç¬¬3è¡Œ <code>crate::m!()</code>ï¼‰ï¼Œåœ¨å…¶ä»–crateä¸­å¯ä»¥ä½¿ç”¨ <code>use crate_name::macro_name</code> å¯¼å…¥ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬å‡è®¾ä¸Šé¢ä»£ç é‡Œcrateçš„åå­—æ˜¯ mycrateï¼Œåœ¨å¦ä¸€ä¸ªç¨‹åºé‡Œå¯ä»¥è¿™æ ·å¯¼å…¥è¿™ä¸ªå®ã€‚</p><pre><code class=\"language-plain\">use mycrate::m;\n\nfn bar() {\n    m!();\n}\n</code></pre><h3>macro_use</h3><p>å‰é¢æˆ‘ä»¬ä½¿ç”¨äº† <code>use mycrate::m</code> è¿™ç§ç²¾ç¡®çš„è·¯å¾„æ¥å¯¼å…¥ mycrate ä¸­çš„ <code>m!()</code> å®ã€‚å¦‚æœä¸€ä¸ªcrateé‡Œçš„å®æ¯”è¾ƒå¤šï¼Œæˆ‘ä»¬æƒ³ä¸€æ¬¡æ€§å…¨éƒ¨å¯¼å…¥ï¼Œå¯ä»¥ä½¿ç”¨ <code>#[macro_use]</code> å±æ€§ï¼Œä¸€æ¬¡å¯¼å…¥ä¸€ä¸ªcrateä¸­æ‰€æœ‰å·²å¯¼å‡ºçš„å®ï¼Œåƒä¸‹é¢è¿™ç§å†™æ³•ï¼š</p><pre><code class=\"language-plain\">#[macro_use] extern crate rocket;\n</code></pre><p>ä¸è¿‡è¿™ç§å†™æ³•ç®—æ˜¯Rustæ—©æœŸçš„é—ç•™å†™æ³•äº†ï¼Œæ›´æ¨èçš„è¿˜æ˜¯ç”¨åˆ°å“ªä¸ªå®å°±å¼•å…¥å“ªä¸ªå®ã€‚æœ‰äº›ä»£ç åº“ä¸­è¿˜ä¼šæœ‰è¿™ç§å†™æ³•å‡ºç°ï¼Œä½ çœ‹åˆ°äº†éœ€è¦çŸ¥é“æ˜¯ä»€ä¹ˆæ„æ€ã€‚</p><h3>è®¤è¯†è¿‡ç¨‹å®ä¹‹æ´¾ç”Ÿå®</h3><p>å¸¸è§çš„ç»“æ„ä½“ä¸Šçš„deriveæ ‡æ³¨ï¼Œå°±æ˜¯æ´¾ç”Ÿå®ã€‚æ¯”å¦‚æˆ‘ä»¬<a href=\"https://time.geekbang.org/column/article/729009?utm_campaign=geektime_search&utm_content=geektime_search&utm_medium=geektime_search&utm_source=geektime_search&utm_term=geektime_search\">ä¸Šä¸€èŠ‚è¯¾</a>è®²åˆ°çš„ thiserror æä¾›çš„ Error æ´¾ç”Ÿå®ã€‚</p><pre><code class=\"language-plain\">use thiserror::Error;\n\n#[derive(Error, Debug)]  // æ´¾ç”Ÿå®\npub enum DataStoreError {\n    #[error(\"data store disconnected\")]  // å±æ€§å®\n    Disconnect(#[from] io::Error),       // å±æ€§å®\n    #[error(\"the data for key `{0}` is not available\")]  // å±æ€§å®\n    Redaction(String),\n    #[error(\"invalid header (expected {expected:?}, found {found:?})\")]  // å±æ€§å®\n    InvalidHeader {\n        expected: String,\n        found: String,\n    },\n    #[error(\"unknown data store error\")]   // å±æ€§å®\n    Unknown,\n}\n</code></pre><p>ä¸Šé¢ç¤ºä¾‹ä¸­çš„ Debug å’Œ Error å°±æ˜¯æ´¾ç”Ÿå®ã€‚Debug å®ç”±stdæä¾›ï¼ŒErrorç”±thiserror crate æä¾›ã€‚ä½¿ç”¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬å…ˆä½¿ç”¨useå°†å®å¯¼å…¥åˆ°å½“å‰crateçš„scopeã€‚ç„¶ååœ¨ <code>#[derive()]</code> ä¸­ä½¿ç”¨å®ƒã€‚</p><pre><code class=\"language-plain\">#[derive(Error, Debug)]\n</code></pre><p>å®ƒä¼šä½œç”¨åœ¨ä¸‹é¢ç´§è·Ÿç€çš„ enum DataStoreError è¿™ä¸ªç±»å‹ä¸Šé¢ï¼Œå¯¹è¿™ä¸ªç±»å‹è¿›è¡ŒæŸç§ä»£ç å˜æ¢æ“ä½œã€‚æœ€åçš„å®ç°æ•ˆæœå°±æ˜¯å¸®åŠ©æˆ‘ä»¬å®ç°äº† <code>std::error::Error</code> è¿™ä¸ªtraitï¼Œä»¥åŠå¯¹åº”çš„ Debugã€Display ç­‰traitã€‚åœ¨æˆ‘ä»¬çœ‹æ¥ï¼Œå†™ä¸Šè¿™ä¸€å¥è¯ï¼Œå°±å¥½åƒRustè‡ªåŠ¨å¸®æˆ‘ä»¬å®Œæˆäº†é‚£äº›å®ç°ï¼Œç»™æˆ‘ä»¬çœäº†å¾ˆå¤šåŠ›æ°”ã€‚</p><p>æƒ³çœ‹å®ƒåˆ°åº•åœ¨ enum DataStoreError ç±»å‹ä¸Šæ–½åŠ äº†å“ªäº›é­”æ³•ï¼Œåªéœ€è¦è¿è¡Œ <code>cargo expand</code> å±•å¼€å®ƒå°±å¯ä»¥äº†ã€‚ä½ å¯ä»¥è‡ªå·±åŠ¨æ‰‹åšä¸€ä¸‹å®éªŒã€‚</p><p>åœ¨è¿™ä¸ªenum DataStoreErroré‡Œçš„å˜ä½“ä¸Šï¼Œæˆ‘ä»¬è¿˜å¯ä»¥çœ‹åˆ°å¦å¤–ä¸¤ä¸ªå® <code>#[error()]</code> å’Œ <code>#[from]</code>ï¼Œå®ƒä»¬ä¸æ˜¯æ´¾ç”Ÿå®ï¼Œè€Œæ˜¯è¿‡ç¨‹å®ä¸­çš„å±æ€§å®ã€‚</p><h3>è®¤è¯†è¿‡ç¨‹å®ä¹‹å±æ€§å®</h3><p>Rustç¼–è¯‘å™¨æä¾›äº†ä¸€äº›å±æ€§ï¼ˆAttributesï¼‰ï¼Œå±æ€§æ˜¯æ–½åŠ åœ¨æ¨¡å—ã€crateæˆ–itemä¸Šçš„å…ƒæ•°æ®ã€‚è¿™äº›å…ƒæ•°æ®å¯ç”¨äºå¾ˆå¤šåœ°æ–¹ã€‚</p><ul>\n<li>ä»£ç æ¡ä»¶ç¼–è¯‘ï¼›</li>\n<li>è®¾ç½® crate åå­—ï¼Œç‰ˆæœ¬å·å’Œç±»å‹ï¼ˆæ˜¯äºŒè¿›åˆ¶ç¨‹åºè¿˜æ˜¯åº“ï¼‰ï¼›</li>\n<li>ç¦æ­¢ä»£ç æç¤ºï¼›</li>\n<li>å¼€å¯ç¼–è¯‘å™¨ç‰¹æ€§ï¼ˆå®ã€å…¨å±€å¯¼å…¥ç­‰ï¼‰ï¼›</li>\n<li>é“¾æ¥åˆ°å¤–éƒ¨åº“ï¼›</li>\n<li>æ ‡è®°å‡½æ•°ä¸ºå•å…ƒæµ‹è¯•ï¼›</li>\n<li>æ ‡è®°å‡½æ•°ä¸ºæ€§èƒ½è¯„æµ‹çš„ä¸€éƒ¨åˆ†ï¼›</li>\n<li>å±æ€§å®ï¼›</li>\n<li>â€¦â€¦</li>\n</ul><p>è¦æŠŠå±æ€§æ–½åŠ åˆ°æ•´ä¸ªcrateï¼Œè¯­æ³•æ˜¯åœ¨crateå…¥å£ï¼Œæ¯”å¦‚åœ¨ lib.rs æˆ– main.rs çš„ç¬¬ä¸€è¡Œå†™ä¸Š <code>#![crate_attribute]</code>ã€‚</p><p>å¦‚æœåªæƒ³æŠŠå±æ€§æ–½åŠ åˆ°æŸä¸ªæ¨¡å—æˆ–è€…itemä¸Šï¼Œå°±æŠŠ <code>!</code> å»æ‰ã€‚</p><pre><code class=\"language-plain\">#[item_attribute]\n</code></pre><p>å±æ€§ä¸Šé¢è¿˜å¯ä»¥æºå¸¦å‚æ•°ï¼Œå¯ä»¥å†™æˆä¸‹é¢å‡ ç§å½¢å¼ï¼š</p><ul>\n<li><code>#[attribute = \"value\"]</code></li>\n<li><code>#[attribute(key = \"value\")]</code></li>\n<li><code>#[attribute(value)]</code></li>\n</ul><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å…·ä½“çš„ä¾‹å­ã€‚</p><pre><code class=\"language-plain\">// å£°æ˜è¿™ä¸ª crate ä¸º libï¼Œæ˜¯å…¨å±€æ€§çš„å±æ€§\n#![crate_type = \"lib\"]\n\n// å£°æ˜ä¸‹é¢è¿™ä¸ªå‡½æ•°ä¸ºå•å…ƒæµ‹è¯•å‡½æ•°ï¼Œè¿™ä¸ªå±æ€§åªä½œç”¨åœ¨test_foo()å‡½æ•°ä¸Š\n#[test]\nfn test_foo() {\n    /* ... */\n}\n\n// æ¡ä»¶ç¼–è¯‘å±æ€§ï¼Œè¿™å—æ·±å…¥ä¸‹å»ç»†èŠ‚éå¸¸å¤š\n#[cfg(target_os = \"linux\")]\nmod bar {\n    /* ... */\n}\n\n// æ­£å¸¸æ¥è¯´ï¼ŒRustä¸­çš„ç±»å‹åéœ€è¦æ˜¯Int8Tè¿™ç§å†™æ³•ï¼Œä¸‹é¢è¿™ä¸ªç¤ºä¾‹è®©ç¼–è¯‘å™¨ä¸è¦å‘è­¦å‘Š\n#[allow(non_camel_case_types)]\ntype int8_t = i8;\n\n// ä½œç”¨åœ¨æ•´ä¸ªå‡½æ•°å†…éƒ¨ï¼Œå¯¹æœªä½¿ç”¨çš„å˜é‡ä¸è¦æŠ¥è­¦\nfn some_unused_variables() {\n  #![allow(unused_variables)]\n\n  let x = ();\n  let y = ();\n  let z = ();\n}\n</code></pre><p>å¦‚æœä½ å¼€å§‹å†™åŸå‹ä»£ç çš„æ—¶å€™ï¼Œç»å¸¸å‡ºç°å˜é‡æˆ–å‡½æ•°æœªä½¿ç”¨çš„æƒ…å†µï¼ŒRustç¼–è¯‘å™¨ä¼šæç¤ºä¸€å †ï¼Œæœ‰æ—¶çœ‹ç€å¿ƒçƒ¦ï¼Œä½ å¯ä»¥åœ¨crateå…¥å£æ–‡ä»¶å¤´å†™ä¸Šä¸¤è¡Œå†…å®¹ã€‚</p><pre><code class=\"language-plain\">#![allow(unused_variables)]\n#![allow(dead_code)]\n\nfn foo() {\n    let a = 10;\n    let b = 20;\n}\n</code></pre><p>å®ƒä¼šå‹åˆ¶Rustç¼–è¯‘å™¨ï¼Œè®©Rustç¼–è¯‘å™¨â€œæ”¾æ”¾æ°´â€ã€‚ä½ å¯ä»¥è¯•ç€æŠŠå‰é¢ä¸¤è¡Œæ³¨é‡Šæ‰ï¼Œçœ‹çœ‹Rustç¼–è¯‘å™¨ä¼šæç¤ºä»€ä¹ˆã€‚ä½†æ˜¯å¯¹äºä¸€ä¸ªä¸¥è‚ƒçš„é¡¹ç›®æ¥è¯´ï¼Œåº”è¯¥å°½å¯èƒ½åœ°æ¶ˆé™¤è¿™äº›â€œæœªä½¿ç”¨â€çš„è­¦å‘Šï¼Œæ‰€ä»¥é¡¹ç›®å†™åˆ°ä¸€å®šç¨‹åº¦ï¼Œå°±è¦æŠŠè¿™ç§å…¨å±€å±æ€§å»æ‰ã€‚</p><p>Rustä¸­æœ‰éå¸¸ä¸°å¯Œçš„å±æ€§ï¼Œå®ƒä»¬ç»™Rustç¼–è¯‘å™¨æä¾›äº†éå¸¸å¼ºå¤§çš„é…ç½®èƒ½åŠ›ã€‚è¦æŒæ¡å®ƒä»¬ï¼Œéœ€è¦èŠ±è´¹å¤§é‡çš„æ—¶é—´ï¼Œä½ å¯ä»¥çœ‹ä¸€ä¸‹ <a href=\"https://doc.rust-lang.org/reference/attributes.html#attributes\">Attributes</a> ç›¸å…³èµ„æ–™ã€‚è¿™ä¹Ÿå°è¯äº†Rustçš„é€‚ç”¨é¢æå…¶å¹¿æ³›ã€‚å³ä½¿ä¸€ä¸ªç†Ÿç»ƒçš„ç¨‹åºå‘˜ï¼Œä¹Ÿæ²¡å¿…è¦æŒæ¡å…¨éƒ¨ï¼Œåªéœ€è¦äº†è§£å…¶ä¸­çš„å¸¸è§å±æ€§å°±å¯ä»¥ã€‚ç„¶ååœ¨é‡åˆ°ä¸€äº›å…·ä½“çš„åœºæ™¯æ—¶ï¼Œå†æ·±å…¥ç ”ç©¶é‚£äº›é…ç½®ã€‚</p><p>è€Œå¦‚æœæˆ‘ä»¬è¦å®šä¹‰è‡ªå·±çš„â€œå±æ€§â€ï¼Œå°±éœ€è¦é€šè¿‡å±æ€§å®æ¥å®ç°ã€‚è¿™å±äºåé«˜çº§è€Œä¸”ç”¨å¾—æ¯”è¾ƒå°‘çš„å†…å®¹ï¼Œéœ€è¦çš„æ—¶å€™å†å»å­¦ä¹ ä¹Ÿæ¥å¾—åŠã€‚å…·ä½“çš„å®ç°å¯ä»¥å‚è€ƒæˆ‘ç»™å‡ºçš„é“¾æ¥ã€‚</p><ul>\n<li><a href=\"https://earthly.dev/blog/rust-macros/\">https://earthly.dev/blog/rust-macros/</a></li>\n<li><a href=\"https://doc.rust-lang.org/beta/reference/procedural-macros.html\">https://doc.rust-lang.org/beta/reference/procedural-macros.html</a></li>\n</ul><p>æ¯”å¦‚è‘—åçš„Webå¼€å‘æ¡†æ¶Rocketï¼Œå°±ä½¿ç”¨å±æ€§å®æ¥é…ç½®URL mappingã€‚</p><pre><code class=\"language-plain\">#[macro_use] extern crate rocket;\n\n#[get(\"/&lt;name&gt;/&lt;age&gt;\")]      // å±æ€§å®\nfn hello(name: &amp;str, age: u8) -&gt; String {\n    format!(\"Hello, {} year old named {}!\", age, name)\n}\n\n#[launch]      // å±æ€§å®\nfn rocket() -&gt; _ {\n    rocket::build().mount(\"/hello\", routes![hello])\n}\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œæœ‰äº†å±æ€§å®çš„åŠ æŒï¼ŒRustä»£ç åœ¨ç»“æ„ä¸Šå˜å¾—ç›¸å½“ç´§å‡‘è€Œæœ‰ç¾æ„Ÿï¼Œè·ŸJavaçš„Springæ¡†æ¶æœ‰ç‚¹ç›¸ä¼¼äº†ã€‚</p><h3>è®¤è¯†è¿‡ç¨‹å®ä¹‹å‡½æ•°å®</h3><p>åœ¨æŸäº›ç‰¹å®šçš„æƒ…å†µä¸‹ï¼Œå‡½æ•°å®èƒ½æ›´å¥½åœ°è¡¨è¾¾ä¸šåŠ¡éœ€æ±‚ï¼Œæ¯”å¦‚å†™SQLè¯­å¥ã€‚æˆ‘ä»¬åœ¨Rustä¸­æ’°å†™SQLè¯­å¥ï¼Œå¿…é¡»ç¬¦åˆRustçš„è¯­æ³•ï¼Œå› æ­¤ï¼Œä¸€èˆ¬ä½¿ç”¨å­—ç¬¦ä¸²æ¥æ„é€ å’Œä¼ é€’SQLè¯­å¥ï¼Œæ¯”å¦‚ï¼š</p><pre><code class=\"language-plain\">fn foo() {\n    let sql = \"select title, content from article where id='1111111';\";\n}\n</code></pre><p>å…¶å®å°±ä¸æ˜¯é‚£ä¹ˆæ–¹ä¾¿ï¼Œè¿˜å®¹æ˜“å‡ºé”™ã€‚å¦‚æœç”¨å‡½æ•°å®æ¥å®ç°çš„è¯ï¼Œå¯ä»¥åšåˆ°å¦‚ä¸‹æ•ˆæœï¼š</p><pre><code class=\"language-plain\">// è¿™æ˜¯ä¼ªä»£ç \nuse sql_macros::sqlbuilder;\n\nfn foo() {\n    sqlbuilder!(select title, content from article where id='1111111';);\n}\n</code></pre><p>è¿™æ ·å†™ï¼Œå°±å¥½åƒåœ¨ä¸€ä¸ªåœ¨SQLç¼–è¾‘å™¨é‡Œé¢å†™SQLè¯­å¥ä¸€æ ·ï¼Œéå¸¸è‡ªç„¶ï¼Œè€Œä¸æ˜¯æŠŠSQLè¯­å¥å†™æˆå­—ç¬¦ä¸²çš„å½¢å¼äº†ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯ä»¥åœ¨Rustä»£ç ä¸­å†™éRustè¯­æ³•çš„ä»£ç ï¼Œæœ‰æ²¡æœ‰æ„Ÿè§‰å¾ˆç¥å¥‡ã€‚å½“ä½ æƒ³è‡ªå·±é€ ä¸€ä¸ªDSLï¼ˆé¢†åŸŸç‰¹å®šè¯­è¨€ Domain Specific Language ï¼‰æ—¶ï¼Œå‡½æ•°å®å°±å¯ä»¥æ´¾ä¸Šç”¨åœºäº†ã€‚</p><p>å‡½æ•°å®æ˜¯è¿‡ç¨‹å®çš„ä¸€ç§ï¼Œä¹Ÿä½¿ç”¨è¿‡ç¨‹å®çš„æ–¹å¼æ¥å®ç°ï¼Œç›¸å…³ä¿¡æ¯å¯å‚è€ƒæˆ‘ç»™å‡ºçš„<a href=\"https://veykril.github.io/tlborm/proc-macros/methodical/function-like.html\">é“¾æ¥</a>ã€‚ç›®å‰ç¤¾åŒºä¸­å…³äºè¿‡ç¨‹å®å®Œæ•´è€Œç»†è‡´çš„æ•™ç¨‹å¹¶ä¸å¤šï¼Œåé¢æˆ‘ä¼šå‡ºä¸€ç³»åˆ—è¿™æ–¹é¢çš„ä¸“é¢˜æ•™ç¨‹ã€‚</p><h2>å®çš„åº”ç”¨</h2><p>ç»¼ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåˆ©ç”¨å®å¯ä»¥åšåˆ°ä»¥ä¸‹å‡ æ–¹é¢çš„äº‹æƒ…ã€‚</p><ol>\n<li>å‡å°‘é‡å¤ä»£ç ã€‚å¦‚æœæœ‰å¤§é‡çš„æ ·æ¿ä»£ç ï¼Œå¯ä»¥ä½¿ç”¨å£°æ˜å®æˆ–æ´¾ç”Ÿå®è®©ä»£ç å˜å¾—æ›´ç®€æ´ã€ç´§å‡‘ã€‚</li>\n<li>ä¸ºç±»å‹æ·»åŠ é¢å¤–èƒ½åŠ›ã€‚è¿™æ˜¯æ´¾ç”Ÿå®å’Œå±æ€§å®çš„å¼ºå¤§å¨åŠ›ã€‚</li>\n<li>åˆ›å»ºDSLã€‚å¯ä»¥è‡ªå·±åˆ›å»ºä¸€ç§æ–°çš„è¯­è¨€ï¼Œåˆ©ç”¨Rustç¼–è¯‘å™¨åœ¨Rustä¸­ç¼–è¯‘è¿è¡Œï¼Œè€Œä¸éœ€è¦ä½ è‡ªå·±å†å»å†™ä¸€ä¸ªå•ç‹¬çš„ç¼–è¯‘å™¨æˆ–è§£é‡Šå™¨äº†ã€‚</li>\n<li>å˜æ¢ä»£ç å®ç°ä»»æ„è‡ªå®šä¹‰ç›®æ ‡ã€‚æœ¬è´¨ä¸Šæ¥è¯´ï¼Œå®å°±æ˜¯å¯¹ä»£ç çš„å˜æ¢ï¼Œå¹¶ä¸”æ˜¯åœ¨çœŸæ­£çš„ç¼–è¯‘é˜¶æ®µä¹‹å‰å®Œæˆçš„ï¼Œå› æ­¤ä½ å¯ä»¥ç”¨å®å®ç°ä»»æ„å¤©é©¬è¡Œç©ºçš„æƒ³æ³•ã€‚</li>\n</ol><h2>å°ç»“</h2><p><img src=\"https://static001.geekbang.org/resource/image/10/03/10317a770528e280a4176d0fbd877c03.jpg?wh=1712x952\" alt=\"\"></p><p>å®åœ¨Rusté‡Œæ— å¤„ä¸åœ¨ï¼Œæˆ‘ä»¬å­¦ä¹ çš„ç¬¬ä¸€æ­¥æ˜¯è¦è®¤è¯†å®ƒä»¬ï¼ŒçŸ¥é“å®ƒä»¬çš„ä½œç”¨ï¼Œç†Ÿæ‚‰å¸¸è§å®çš„æ„ä¹‰å’Œç”¨æ³•ã€‚ç„¶åè¦åˆæ­¥æŒæ¡å†™ç®€å•çš„å£°æ˜å®çš„å†™æ³•ï¼Œè¿™æ ·èƒ½æœ‰æ•ˆåœ°æå‡ä½ ç²¾ç®€ä¸šåŠ¡ä»£ç çš„èƒ½åŠ›ã€‚ä½†åŒæ—¶ä¹Ÿè¦æ³¨æ„ï¼Œä½¿ç”¨å®ä¸èƒ½è¿‡åº¦ï¼Œå®çš„ç¼ºç‚¹æ˜¯æ¯”è¾ƒéš¾è°ƒè¯•ï¼ŒIDEå¯¹å®ƒçš„æ”¯æŒå¯èƒ½ä¹Ÿä¸å®Œç¾ã€‚æ»¥ç”¨å®ä¼šå¯¼è‡´ä»£ç éš¾ä»¥ç†è§£ã€‚</p><p>è¿‡ç¨‹å®çš„èƒ½åŠ›éå¸¸å¼ºï¼Œä¹¦å†™çš„éš¾åº¦ä¹Ÿæ¯”è¾ƒå¤§ï¼Œæˆ‘ä»¬ç›®å‰ä¸éœ€è¦æŒæ¡å®ƒçš„å†™æ³•ã€‚å½“ä½ é‡åˆ°ä¸€ä¸ªè¿‡ç¨‹å®çš„æ—¶å€™ï¼Œä½ å¯ä»¥å…ˆæŸ¥é˜…æ–‡æ¡£ï¼ŒçŸ¥é“å®ƒçš„ä½œç”¨ï¼Œåšåˆ°ä¼šç”¨ã€‚ç­‰é‡åˆ°éœ€è¦çš„åœºæ™¯çš„æ—¶å€™ï¼Œå†å»æ·±å…¥é’»ç ”ã€‚</p><p>è¿™èŠ‚è¯¾æˆ‘ä»¬è¿˜æåˆ°äº†ä¸€ä¸ªç”¨æ¥å±•å¼€å®ä»£ç çš„å·¥å…·cargo expandï¼Œç»å¸¸ä½¿ç”¨å®ƒï¼Œå¯¹ä½ å­¦ä¹ å®ä¼šæœ‰å¾ˆå¤§å¸®åŠ©ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>å­¦å®Œè¿™èŠ‚è¯¾çš„å†…å®¹ï¼Œä½ å¯ä»¥æŸ¥é˜…ä¸€ä¸‹ç›¸å…³èµ„æ–™ï¼Œè¯´ä¸€è¯´ <code>allow</code>ã€<code>warn</code>ã€<code>deny</code>ã€<code>forbid</code> å‡ ä¸ªå±æ€§çš„æ„ä¹‰å’Œç”¨æ³•ã€‚æ¬¢è¿ä½ æŠŠæŸ¥é˜…åˆ°çš„å†…å®¹åˆ†äº«åˆ°è¯„è®ºåŒºï¼Œå¦‚æœè§‰å¾—æœ‰æ”¶è·çš„è¯ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾çš„å†…å®¹åˆ†äº«ç»™å…¶ä»–æœ‹å‹ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼</p>","comments":[{"had_liked":false,"id":384738,"user_name":"Noya","can_delete":false,"product_type":"c1","uid":1519230,"ip_address":"æµ™æ±Ÿ","ucode":"52EEB72E80BAF8","user_header":"https://static001.geekbang.org/account/avatar/00/17/2e/7e/a15b477c.jpg","comment_is_top":false,"comment_ctime":1701417519,"is_pvip":false,"replies":[{"id":140306,"content":"å¯¹çš„","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1701523499,"ip_address":"é‡åº†","comment_id":384738,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"allowã€warnã€denyã€forbid: ç¼–è¯‘å™¨çš„è­¦å‘Šçº§åˆ«","like_count":3,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":632884,"discussion_content":"å¯¹çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1701523499,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":384709,"user_name":"Distance","can_delete":false,"product_type":"c1","uid":1109780,"ip_address":"åŒ—äº¬","ucode":"B30FAFE1F64D3D","user_header":"https://static001.geekbang.org/account/avatar/00/10/ef/14/83867b58.jpg","comment_is_top":false,"comment_ctime":1701362324,"is_pvip":false,"replies":[{"id":140310,"content":"éå¸¸ç»†å¿ƒï¼ğŸ‘ã€‚ç¬¬äºŒä¸ªåˆ†æ”¯åé¢ä¹Ÿå¯ä»¥åŠ åˆ†å·çš„ã€‚åˆ†å·çš„ä½œç”¨ç”¨æ¥é—´éš”å¤šä¸ªåˆ†æ”¯ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1701556755,"ip_address":"é‡åº†","comment_id":384709,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"macro_rules! add {\n    &#47;&#47; ç¬¬ä¸€ä¸ªåˆ†æ”¯ï¼ŒåŒ¹é…ä¸¤ä¸ªå…ƒç´ çš„åŠ æ³•\n    ($a:expr, $b:expr)=&gt;{\n        {\n            $a+$b\n        }\n    };\n    &#47;&#47; ç¬¬äºŒä¸ªåˆ†æ”¯ï¼šå½“åªæœ‰ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œä¹Ÿåº”è¯¥å¤„ç†ï¼Œè¿™æ˜¯è¾¹ç•Œæƒ…å†µ\n    ($a:expr)=&gt;{\n        {\n            $a\n        }\n    }\n}\n\nä¸ºä»€ä¹ˆç¬¬äºŒä¸ªåˆ†æ”¯åŒ¹é…ä¸éœ€è¦åˆ†å·å‘¢ï¼Ÿ æˆ‘çœ‹ç¬¬ä¸€ä¸ªç¤ºä¾‹åªæœ‰å•ä¸ªåŒ¹é…ä¹Ÿæ˜¯åˆ†å·ç»“å°¾çš„","like_count":3,"discussions":[{"author":{"id":1519230,"avatar":"https://static001.geekbang.org/account/avatar/00/17/2e/7e/a15b477c.jpg","nickname":"Noya","note":"","ucode":"52EEB72E80BAF8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":632836,"discussion_content":"æˆ‘å°è¯•äº†ä¸€ä¸‹, å¦‚æœæœ‰å¤šä¸ªåˆ†æ”¯åŒ¹é…, é™¤äº†æœ€åä¸€ä¸ªå¯åŠ å¯ä¸åŠ , å…¶ä»–éƒ½è¦åŠ ; å¦‚æœåªæœ‰ä¸€ä¸ªåˆ†æ”¯, é‚£å°±å¯åŠ å¯ä¸åŠ ","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1701413852,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":632892,"discussion_content":"éå¸¸ç»†å¿ƒï¼ğŸ‘ã€‚ç¬¬äºŒä¸ªåˆ†æ”¯åé¢ä¹Ÿå¯ä»¥åŠ åˆ†å·çš„ã€‚åˆ†å·çš„ä½œç”¨ç”¨æ¥é—´éš”å¤šä¸ªåˆ†æ”¯ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1701556755,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":387373,"user_name":"å¥•","can_delete":false,"product_type":"c1","uid":1005391,"ip_address":"å¹¿ä¸œ","ucode":"73CEA468CE70C3","user_header":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","comment_is_top":false,"comment_ctime":1707105310,"is_pvip":false,"replies":[{"id":141250,"content":"play.rust-lang.org","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1708627446,"ip_address":"åŠ æ‹¿å¤§","comment_id":387373,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"cargo expand å®å±•å¼€è¿™ä¸ªç½‘ç«™åœ°å€æ˜¯ä»€ä¹ˆå•Š","like_count":0,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":637561,"discussion_content":"play.rust-lang.org","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1708627446,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŠ æ‹¿å¤§","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2918708,"avatar":"https://static001.geekbang.org/account/avatar/00/2c/89/34/cd862ef6.jpg","nickname":"Vincent_Li","note":"","ucode":"7E020B698650D7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":646193,"discussion_content":"æœäº†ä¸‹. cargo install cargo-expand å¯ä»¥å®‰è£…ä¸ºæœ¬åœ°å‘½ä»¤ , å‚è€ƒ https://docs.rs/crate/cargo-expand/0.1.3/source/README.md","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1717515174,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å››å·","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1203049,"avatar":"https://static001.geekbang.org/account/avatar/00/12/5b/69/7ace1ddb.jpg","nickname":"ç‹¬é’“å¯’æ±Ÿ","note":"","ucode":"2C81906FD88C8C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":643388,"discussion_content":"ä¹‹å‰åŒæœ‰æ­¤é—®ï¼Œä»”ç»†çœ‹äº†ä¸€ä¸‹ï¼ŒçŒœå¤§æ¦‚æ˜¯è¿™ä¸ªç½‘ç«™ï¼Œè§‰å¾—åœ¨åŸæ–‡åŠ ä¸€å¥è¡¥å……è¯´æ˜æ¯”è¾ƒå¥½","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1714277059,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":384773,"user_name":"Taozi","can_delete":false,"product_type":"c1","uid":1021926,"ip_address":"ä¸Šæµ·","ucode":"DD6567A31B3E33","user_header":"","comment_is_top":false,"comment_ctime":1701503670,"is_pvip":false,"replies":[{"id":140308,"content":"å¯¹çš„ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1701523536,"ip_address":"é‡åº†","comment_id":384773,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"è¿‡ç¨‹å®æœ¬è´¨ä¸Šæ˜¯ç¼–è¯‘å™¨çš„æ‰©å±•æ’ä»¶","like_count":0,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":632886,"discussion_content":"å¯¹çš„ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1701523536,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":384711,"user_name":"ä¼¯é˜³","can_delete":false,"product_type":"c1","uid":1596631,"ip_address":"åŒ—äº¬","ucode":"DBDC8735AA54AD","user_header":"https://static001.geekbang.org/account/avatar/00/18/5c/d7/3b92bb0d.jpg","comment_is_top":false,"comment_ctime":1701381064,"is_pvip":false,"replies":[{"id":140309,"content":"å±æ€§å®å’Œæ³¨è§£æœ‰ç‚¹åƒ","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1701523560,"ip_address":"é‡åº†","comment_id":384711,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"æ„Ÿè§‰å’Œæ³¨è§£æœ‰ç‚¹åƒ","like_count":0,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":632887,"discussion_content":"å±æ€§å®å’Œæ³¨è§£æœ‰ç‚¹åƒ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1701523560,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":389987,"user_name":"Calvin","can_delete":false,"product_type":"c1","uid":1603004,"ip_address":"å¹¿ä¸œ","ucode":"0EEF5B207623B5","user_header":"https://static001.geekbang.org/account/avatar/00/18/75/bc/89d88775.jpg","comment_is_top":false,"comment_ctime":1714038700,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"macro_export çš„ç¤ºä¾‹ä»£ç ä¸­çš„ inner æ¨¡å—çš„å®è°ƒç”¨ä»£ç æœ‰ç‚¹é—®é¢˜ï¼Œéœ€è¦åœ¨å‡½æ•°æˆ–æ–¹æ³•ä¸­ï¼š\nmod inner {\n    super::m!();\n    crate::m!();\n}\nåº”è¯¥ç±»ä¼¼äºï¼š\nmod inner {\n    pub fn foo() {\n        super::m!();\n        crate::m!();\n    }\n}","like_count":0}]}