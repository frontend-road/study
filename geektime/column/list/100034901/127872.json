{"id":127872,"title":"01 | 架构与特性：一个完整的IM系统是怎样的？","content":"<p>你好，我是袁武林。在接下来的一段时间里，我将和你一起探索IM的相关知识。今天是第一节课，我们就先从IM的相关概念开始着手。</p><p>说起IM，我估计你会先愣一下，“IM是QQ或者微信这样的即时聊天系统吗？它是不是很庞大，也很复杂？”</p><p>今天我们以一个简单的App聊天系统为例，来看下一个简单的聊天系统都有哪些构成要素，以此来了解一个完整的IM系统是什么样的。</p><h2>从一个简单的聊天系统说起</h2><p>我们可以从使用者和开发者两个角度来看一下。</p><h3>1. 使用者眼中的聊天系统</h3><p>如果我们站在一个使用者的角度从直观体验上来看，一个简单的聊天系统大概由以下元素组成：用户账号、账号关系、联系人列表、消息、聊天会话。我在这里画了一个简单的示意图：</p><p><img src=\"https://static001.geekbang.org/resource/image/34/76/34af761c49b7ce6ddf5830db93adfc76.png?wh=700*500\" alt=\"\"></p><p>这个应该不难理解，我来解释一下。</p><ul>\n<li>聊天的参与需要用户，所以需要有一个<strong>用户账号</strong>，用来给用户提供唯一标识，以及头像、昵称等可供设置的选项。</li>\n<li>账号和账号之间通过某些方式（比如加好友、互粉等）构成账号间的<strong>关系链</strong>。</li>\n<li>你的好友列表或者聊天对象的列表，我们称为<strong>联系人的列表</strong>，其中你可以选择一个联系人进行聊天互动等操作。</li>\n<li>在聊天互动这个环节产生了<strong>消息</strong>。</li>\n<li>同时你和对方之间的聊天消息记录就组成了一个<strong>聊天会话</strong>，在会话里能看到你们之间所有的互动消息。</li>\n</ul><!-- [[[read_end]]] --><h3>2. 开发者眼中的聊天系统</h3><p>从一个IM系统开发者的角度看，聊天系统大概由这几大部分组成：客户端、接入服务、业务处理服务、存储服务和外部接口服务。</p><p>下面，我大概讲一讲每一个部分主要的职责。</p><p><img src=\"https://static001.geekbang.org/resource/image/6a/a2/6a20a4af19e3205201ab315b4680bca2.png?wh=886*656\" alt=\"\"></p><p><strong>首先是客户端。</strong>客户端一般是用户用于收发消息的终端设备，内置的客户端程序和服务端进行网络通信，用来承载用户的互动请求和消息接收功能。我们可以把客户端想象为邮局业务的前台，它负责把你的信收走，放到传输管道中。</p><p><strong>其次是接入服务。</strong>接入服务可以认为是服务端的门户，为客户端提供消息收发的出入口。发送的消息先由客户端通过网络给到接入服务，然后再由接入服务递交到业务层进行处理。</p><p>接入服务主要有四块功能：连接保持、协议解析、Session维护和消息推送。</p><p>我们可以把接入服务想象成一个信件管道，联通了邮局的前台和信件分拨中心。但是实际上，接入服务的作用很大，不仅仅只有保持连接和消息传递功能。</p><p>当服务端有消息需要推送给客户端时，也是将经过业务层处理的消息先递交给接入层，再由接入层通过网络发送到客户端。</p><p>此外，在很多基于私有通信协议的IM系统实现中，接入服务还提供协议的编解码工作，编解码实际主要是为了节省网络流量，系统会针对传输的内容进行紧凑的编码（比如Protobuf），为了让业务处理时不需要关心这些业务无关的编解码工作，一般由接入层来处理。</p><p>另外，还有session维护的工作很多时候也由接入服务来实现，session的作用是标识“哪个用户在哪个TCP连接”，用于后续的消息推送能够知道，如何找到接收人对应的连接来发送。</p><p>另外，接入服务还负责最终消息的推送执行，也就是通过网络连接把最终的消息从服务器传输送达到用户的设备上。</p><p><strong>之后是业务处理服务。</strong>业务处理服务是真正的消息业务逻辑处理层，比如消息的存储、未读数变更、更新最近联系人等，这些内容都是业务处理的范畴。</p><p>我们可以想象得到，业务处理服务是整个IM系统的中枢大脑，负责各种复杂业务逻辑的处理。</p><p>就好比你的信到达分拨中心后，分拨中心可能需要给接收人发条短信告知一下，或者分拨中心发现接收人告知过要拒绝接收这个发送者的任何信件，因此会在这里直接把信件退回给发信人。</p><p><strong>接着是存储服务。</strong>这个比较好理解，账号信息、关系链，以及消息本身，都需要进行持久化存储。</p><p>另外一般还会有一些用户消息相关的设置，也会进行服务端存储，比如：用户可以设置不接收某些人的消息。我们可以把它理解成辖区内所有人的通信地址簿，以及储存信件的仓库。</p><p><strong>最后是外部接口服务。</strong>由于手机操作系统的限制，以及资源优化的考虑，大部分App在进程关闭，或者长时间后台运行时，App和IM服务端的连接会被手机操作系统断开。这样当有新的消息产生时，就没法通过IM服务再触达用户，因而会影响用户体验。</p><p>为了让用户在App未打开时，或者在后台运行时，也能接收到新消息，我们会将消息给到<strong>第三方外部接口服务</strong>，来通过手机操作系统自身的公共连接服务来进行操作系统级的“消息推送”，通过这种方式下发的消息一般会在手机的“通知栏”对用户进行提醒和展示。</p><p>这种最常用的第三方系统推送服务有苹果手机自带的APNs（Apple Push Notification service）服务、安卓手机内置的谷歌公司的GCM（Google Cloud Messaging）服务等。</p><p>但GCM服务在国内无法使用，为此很多国内手机厂商在各自手机系统中，也提供类似的公共系统推送服务，如小米、华为、OPPO、vivo等手机厂商都有相应的SDK提供支持。</p><p>为了便于理解，我们还是用上面的例子来说：假如收信人现在不在家，而是在酒店参加某个私人聚会，分拨中心这时只能把信交给酒店门口的安保人员，由他代为送达到收信人手中。在这里我们可以把外部接口服务理解成非邮局员工的酒店门口的安保人员。</p><p><strong>这里，我想请你来思考一个架构问题：为什么接入服务和业务处理服务要独立拆分呢？</strong></p><p>我们前面讲到，接入服务的主要是为客户端提供消息收发的出入口，而业务处理服务主要是处理各种聊天消息的业务逻辑，这两个服务理论上进行合并好像也没有什么不妥，但大部分IM系统的实现上，却基本上都会按照这种方式进行拆分。</p><p>我认为，接入服务和业务处理服务独立拆分，有以下几点原因。</p><p><strong>第一点是接入服务作为消息收发的出入口，必须是一个高可用的服务，保持足够的稳定性是一个必要条件。</strong></p><p>试想一下，如果连接服务总处于不稳定状态，老是出现连不上或者频繁断连的情况，一定会大大影响聊天的流畅性和用户体验。</p><p>而业务处理服务由于随着产品需求迭代，变更非常频繁，随时有新业务需要上线重启。</p><p>如果消息收发接入和业务逻辑处理都在一起，势必会让接入模块随着业务逻辑的变更上线，而频繁起停，导致已通过网络接入的客户端连接经常性地断连、重置、重连。</p><p>这种连接层的不稳定性会导致消息下推不及时、消息发送流畅性差，甚至会导致消息发送失败，从而降低用户消息收发的体验。</p><p>所以，将“只负责网络通道维持，不参与业务逻辑，不需要频繁变更的接入层”抽离出来，不管业务逻辑如何调整变化，都不需要接入层进行变更，这样能保证连接层的稳定性，从而整体上提升消息收发的用户体验。</p><p><strong>第二点是从业务开发人员的角度看，接入服务和业务处理服务进行拆分有助于提升业务开发效率，降低业务开发门槛。</strong></p><p>模块拆分后，接入服务负责处理一切网络通信相关的部分，比如网络的稳定性、通信协议的编解码等。这样负责业务开发的同事就可以更加专注于业务逻辑的处理，而不用关心让人头痛的网络问题，也不用关心“天书般的通信协议”了。</p><h2>IM系统都有哪些特性？</h2><p>上面我们从使用者和从业者两个角度，分别了解一个完整IM系统的构成，接下来我们和其他系统对比着来看一下，从业务需求出发，IM系统都有哪些不一样的特性。</p><h3>1. 实时性</h3><p>对于一个实时消息系统，“实时”二字很好地表达了这个系统的基本要求。</p><p>通过微信和你的好友聊天，结果等半天对方才收到，基本上也没有意愿聊了；直播场景下，如果主播的互动消息房间里的粉丝要等很长时间才能收到，也很难让粉丝们有积极参与的欲望。</p><p>了解到“实时性”在实时消息场景下的重要性后，在技术方面，我们会采用哪些手段来提升和保证这一特性呢？细节暂不展开，在第3篇“轮询与长连接：如何解决消息实时到达问题”中，我会和你继续探讨“保证消息实时性”的几种方案。</p><h3>2. 可靠性</h3><p>如果说“实时性”是即时消息被广泛应用于各种社交、互动领域的基本前置条件，那么消息的可靠性则是实时消息服务可以“被信赖”的另一个重要特性。</p><p>这里的可靠性通俗来讲，一般包括两个方面。</p><ul>\n<li><strong>不丢消息。</strong>“丢消息”是互动中让人难以接受的Bug，某些场景下可能导致业务可用性差，甚至不可用的情况。比如直播间“全员禁言”的信令消息丢失，就可能导致直播室不可控的一些情况。</li>\n<li><strong>消息不重复。</strong>消息重复不仅会对用户造成不必要的骚扰和困惑，可能还会导致比较严重的业务异常，比如直播间“送礼物”的消息由于某种原因被重复发出，处理不妥的话可能会导致用户损失。</li>\n</ul><p>那么如何做到“不丢消息”的同时，还能解决“消息重复”问题呢？对于IM系统可靠性的解决方案，我会在接下来的第4篇“ACK机制：如何保证消息的可靠投递”，和你一起探讨。</p><h3>3. 一致性</h3><p>消息的一致性一般来是指：同一条消息，在多人、多终端需要保证展现顺序的一致性。</p><p>比如，对于单聊场景，一致性是指希望发送方的消息发送顺序和接收方的接收顺序保持一致；而对于一个群的某一条消息，我们希望群里其他人接收到的消息顺序都是一致的；对于同一个用户的多台终端设备，我们希望发送给这个用户的消息在多台设备上也能保持一致性。</p><p>缺少“一致性”保障的IM系统，经常会导致双方沟通过程中出现一些“奇妙的误会”，语言乱序相关的“惨案”。网络上，你可以想象一下发给下属、领导或合作方的几条重要工作内容，如果消息错乱了，后果可能会比较严重。</p><p>保证“消息的一致性”，也是考验即时消息系统的重要指标，那么具体在实战中都有哪些通用的技术能实现这个特性，我会后续第5篇“消息序号生成器：如何保证你的消息不会乱序”中详细展开。</p><h3>4. 安全性</h3><p>由于即时消息被广泛应用于各种私密社交和小范围圈子社交，因此用户对于系统的隐私保护能力要求也相对较高。</p><p>从系统使用安全性的角度来看，首先是要求“数据传输安全”，其次是要求“数据存储安全”，最后就是“消息内容安全”。</p><p>每一个方面实际上业界也都有比较成熟的应对方案，具体如何从这几方面入手来保障系统的整体安全性，我在第6篇“HttpDNS和TLS：你的消息聊天内容真的安全吗”中也会一一细述。</p><p>除了以上四大特性，作为一个相对高频使用的系统，消息系统在节能省电、省流量这些方面也增加了众多锦上添花的功能，在后续课程中，关于这些特点在实战方面如何落地，我也会穿插进行讲解。</p><h2>小结</h2><p>今天，我们先从“使用者的直观体验”和“实现上的系统构成”的两个角度，和你一起了解一个较完整的IM系统都应该有什么。</p><p>之后，我们又从即时消息系统所适用的业务场景需求，了解了即时消息有别于其他业务系统的四大特性。</p><ul>\n<li>实时性，保证消息实时触达是互动场景的必备能力。</li>\n<li>可靠性，“不丢消息”和“消息不重复”是系统值得信赖的前置条件。</li>\n<li>一致性，“多用户”“多终端”的一致性体验能大幅提升IM系统的使用体验。</li>\n<li>安全性，“数据传输安全”“数据存储安全”“消息内容安全”三大保障方面提供全面隐私保护。</li>\n</ul><p>在后续课程中，我会逐步细述在主流IM系统的设计实现上是具体如何落地去实现“实时性”“可靠性”“一致性”“安全性”的要求。</p><p>最后，留给你一个思考题。消息一定需要在服务端的存储服务里进行存储吗？</p><p>欢迎你给我留言，我们一起讨论。</p>","comments":[{"had_liked":false,"id":128708,"user_name":"恰同学少年","can_delete":false,"product_type":"c1","uid":1494856,"ip_address":"","ucode":"AFA497A2172E52","user_header":"https://static001.geekbang.org/account/avatar/00/16/cf/48/032d6dfc.jpg","comment_is_top":false,"comment_ctime":1566953489,"is_pvip":false,"replies":[{"id":"47827","content":"👍","user_name":"作者回复","user_name_real":"coldwalker","uid":"1297490","ctime":1566968834,"ip_address":"","comment_id":128708,"utype":1}],"discussion_count":1,"race_medal":0,"score":"177660612625","product_id":100034901,"comment_content":"存储在服务端的作用:<br>1.会话一方用户不在线，上线时进行消息推送。<br>2.内容审查，监管，电子证据，法律要求。<br>3.数据分析，舆情分析。<br>暂时想到这些😊<br>是否要在服务端存储消息还是由业务与法律法规所决定的。","like_count":42,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465070,"discussion_content":"👍","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566968834,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":129076,"user_name":"newzai","can_delete":false,"product_type":"c1","uid":1102367,"ip_address":"","ucode":"D5E34D427D65FD","user_header":"https://static001.geekbang.org/account/avatar/00/10/d2/1f/2ef2514b.jpg","comment_is_top":false,"comment_ctime":1567039593,"is_pvip":false,"replies":[{"id":"48050","content":"1. 接入层和业务层可以通过rpc或者mq来进行对接。<br>2. 推送时，可以在用户上线时维护一个全局的uid到接入网关的映射来做到定向推送，对于超大群或者直播互动场景可以不区分某一个用户落在哪个接入网关，而是让所有网关获取后来下推连到本机的用户。你想想这种方式的优势是什么呢？","user_name":"作者回复","user_name_real":"coldwalker","uid":"1297490","ctime":1567050486,"ip_address":"","comment_id":129076,"utype":1}],"discussion_count":7,"race_medal":0,"score":"48811679849","product_id":100034901,"comment_content":"业务模块与接入模块的通信链路是如何设计的。接入模块收到一个消息后，通过什么方式，udp，or tcp等推送到业务模块？业务模块下发消息给用户时，怎么知道用户处于接入模块的那一个实例服务（接入模块肯定是有多个实例同时运行的）","like_count":11,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465264,"discussion_content":"1. 接入层和业务层可以通过rpc或者mq来进行对接。\n2. 推送时，可以在用户上线时维护一个全局的uid到接入网关的映射来做到定向推送，对于超大群或者直播互动场景可以不区分某一个用户落在哪个接入网关，而是让所有网关获取后来下推连到本机的用户。你想想这种方式的优势是什么呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567050486,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1102367,"avatar":"https://static001.geekbang.org/account/avatar/00/10/d2/1f/2ef2514b.jpg","nickname":"newzai","note":"","ucode":"D5E34D427D65FD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":6794,"discussion_content":"接入层只有一层，业务层如果存在多层的时候，消息的请求和应答路径是否要保持一致，类似从那条路来就从那条路回去，还是从那里来就从那里回去（只关注起始和目的服务），但是还需要考虑内部机房网络可达性问题。例如一条消息经过接入层后丢给了业务服务A，B，C等最后C处理完成后把结果直接通过接入层回复用户呢，还是沿着C，B，A，接入层的路径返回呢？如果是直接丢给接入层，要考虑C与接入层的网络可通性问题，如果是通过C，B，A返回，需要涉及到路由信息，路由信息又该如何保存处理呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567125170,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1010018,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/69/62/b874af21.jpg","nickname":"颛顼","note":"","ucode":"4A6139389C62EA","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":6788,"discussion_content":"接入层肯定是有状态的，要想把消息推送给用户，还是要让维持连接的那个实例进行处理，那用户uid和连接的映射关系可以存入redis中作为全局信息，那还是要有一层处理uid和连接的映射，这逻辑是放哪里合适","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567121329,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":3,"child_discussions":[{"author":{"id":1102367,"avatar":"https://static001.geekbang.org/account/avatar/00/10/d2/1f/2ef2514b.jpg","nickname":"newzai","note":"","ucode":"D5E34D427D65FD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1010018,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/69/62/b874af21.jpg","nickname":"颛顼","note":"","ucode":"4A6139389C62EA","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":6850,"discussion_content":"存入redis，那么redis就会成为下发消息的一个瓶颈的地方了，，一旦redis出问题， 呵呵，后果你知道的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567140680,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":6788,"ip_address":""},"score":6850,"extra":""},{"author":{"id":1010018,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/69/62/b874af21.jpg","nickname":"颛顼","note":"","ucode":"4A6139389C62EA","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1102367,"avatar":"https://static001.geekbang.org/account/avatar/00/10/d2/1f/2ef2514b.jpg","nickname":"newzai","note":"","ucode":"D5E34D427D65FD","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":6860,"discussion_content":"那这个全局信息需要放在哪里的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567146667,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":6850,"ip_address":""},"score":6860,"extra":""},{"author":{"id":1439908,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/IPdZZXuHVMibwfZWmm7NiawzeEFGsaRoWjhuN99iaoj5amcRkiaOePo6rH1KJ3jictmNlic4OibkF4I20vOGfwDqcBxfA/132","nickname":"鱼向北游","note":"","ucode":"580EC7DCE57E9A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1010018,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/69/62/b874af21.jpg","nickname":"颛顼","note":"","ucode":"4A6139389C62EA","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":41348,"discussion_content":"一般单播处理 a发给业务，业务再发给b，有两种处理方式，一是业务端通过查b在哪个网关，然后发过去，这需要一个全局的在线中心；另外是业务的处理是哪个网关给业务，业务就丢给哪个网关，由网关判断b的状态决定下步走向，这里也可以用全局在线中心，也可以向每个网关广播消息，然后再缓存下b的节点信息，下次就是转发了。全局在线中心适合大厂，因为要考虑数据一致性、高可用、性能。我比较建议用广播+缓存单播模式，实现起来简单，性能也还可以。\n对于大房间广播处理，暂时没有太好方法，就只能把这条广播消息发到所有网关，由网关来分拣到底发给谁。或者结合用客户端定时拉消息模式","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1572403819,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":6860,"ip_address":""},"score":41348,"extra":""}]},{"author":{"id":1205253,"avatar":"https://static001.geekbang.org/account/avatar/00/12/64/05/6989dce6.jpg","nickname":"我来也","note":"","ucode":"773D6104F56767","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":6769,"discussion_content":"老师问的第二个问题，我觉得是分场景。如果是广播类的消息为主，比如直播，可能更适合网关拉取后推送给自己所属的用户。反之，像普通的聊天","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567091039,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":129255,"user_name":"summer","can_delete":false,"product_type":"c1","uid":1642614,"ip_address":"","ucode":"E7D59171F02142","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/QVJXUUzrteibRXDjbPz2aNmMSTfO9NcHK7VAribLcYPNAxo4Wq2xEO4Xt1jBJr6Q3HdM7JZEf36XCBAicCVbTgOoQ/132","comment_is_top":false,"comment_ctime":1567071440,"is_pvip":false,"replies":[{"id":"48119","content":"问题1接入层避免业务也可以考虑使用统一协议的header，body部分直接透传二进制，或者把body的编码分委托给其他的编解码api。另外对于pb还不够紧凑的问题可以再gzip一下后再下推客户端。<br>问题2一般先落db，然后写离线buffer。db全量，buffer定长或者按时间过期。redis和pika一般比较适合做离线buffer，mysql和hbase一般由于消息的db存储。","user_name":"作者回复","user_name_real":"coldwalker","uid":"1297490","ctime":1567088808,"ip_address":"","comment_id":129255,"utype":1}],"discussion_count":2,"race_medal":0,"score":"40221777104","product_id":100034901,"comment_content":"问题1: 接入层要避免业务 如果用protobuf 怎么定义协议 避免各种业务变动影响就要把内容做抽象一些，就要用字符串  这样就失去protobuf 的效果了怎么办? <br>问题2  之前问过的 想知道具体一点。是要多端同步的。  收到消息就存入mysql吗？然后在从mysql取出发给用户吗？redis，pika hbase他们的角色是什么样的？","like_count":9,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465363,"discussion_content":"问题1接入层避免业务也可以考虑使用统一协议的header，body部分直接透传二进制，或者把body的编码分委托给其他的编解码api。另外对于pb还不够紧凑的问题可以再gzip一下后再下推客户端。\n问题2一般先落db，然后写离线buffer。db全量，buffer定长或者按时间过期。redis和pika一般比较适合做离线buffer，mysql和hbase一般由于消息的db存储。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567088808,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2741173,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJS9tcl7EictB16WVgZ1Zhx25DFIuQHicFwwkxmxPvaNW4ndsUsAcgbLmG5EJUbIY2S5Sq7icPY3bneA/132","nickname":"Geek_fe56ba","note":"","ucode":"60B17CD9633EB9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":389563,"discussion_content":"我们公司就是这样做的，二进制作body","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629340046,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":128765,"user_name":"QQ怪","can_delete":false,"product_type":"c1","uid":1211223,"ip_address":"","ucode":"1A39B8433D9208","user_header":"https://static001.geekbang.org/account/avatar/00/12/7b/57/a9b04544.jpg","comment_is_top":false,"comment_ctime":1566959531,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"35926697899","product_id":100034901,"comment_content":"腾讯的微信好像是不存服务器的，但我觉得估计是存了的，只是没开放给我们","like_count":8},{"had_liked":false,"id":128731,"user_name":"云师兄","can_delete":false,"product_type":"c1","uid":1010459,"ip_address":"","ucode":"4475AF1598FBFD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/6b/1b/4b397b80.jpg","comment_is_top":false,"comment_ctime":1566954947,"is_pvip":false,"replies":[{"id":"47829","content":"是个好问题，如果消息只存储在客户端，实现多终端消息同步基本上就会非常困难。","user_name":"作者回复","user_name_real":"coldwalker","uid":"1297490","ctime":1566968994,"ip_address":"","comment_id":128731,"utype":1}],"discussion_count":1,"race_medal":0,"score":"27336758723","product_id":100034901,"comment_content":"存储在客户端，多终端登录时候如何同步（历史）消息的？","like_count":6,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465079,"discussion_content":"是个好问题，如果消息只存储在客户端，实现多终端消息同步基本上就会非常困难。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566968994,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":154202,"user_name":"蒙","can_delete":false,"product_type":"c1","uid":1737343,"ip_address":"","ucode":"9D8031D6477952","user_header":"https://static001.geekbang.org/account/avatar/00/1a/82/7f/28a05a0a.jpg","comment_is_top":false,"comment_ctime":1574390563,"is_pvip":false,"replies":[{"id":"59887","content":"感谢支持","user_name":"作者回复","user_name_real":"coldwalker","uid":"1297490","ctime":1574771984,"ip_address":"","comment_id":154202,"utype":1}],"discussion_count":1,"race_medal":0,"score":"23049227043","product_id":100034901,"comment_content":"想比其他专供大厂面试的课程，这个实战的im是真的符合我的口味哈哈哈，买对课程了，im不仅仅是im，里面的技术可以营销平台，网关等出现","like_count":5,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":475407,"discussion_content":"感谢支持","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574771984,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":128973,"user_name":"Curry","can_delete":false,"product_type":"c1","uid":1644300,"ip_address":"","ucode":"0C5B475104AD96","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKDic46swlunhrnw8p3So5ibGycZGWE6Y6CWzibCXZpUbL9xZibgSv5EFIrgNPuLibCf9WiaAgZtfDAATgg/132","comment_is_top":false,"comment_ctime":1566998561,"is_pvip":false,"replies":[{"id":"48046","content":"对，你说的这种方式其实是通过队列来异步化解耦消息存储逻辑。","user_name":"作者回复","user_name_real":"coldwalker","uid":"1297490","ctime":1567049997,"ip_address":"","comment_id":128973,"utype":1}],"discussion_count":1,"race_medal":0,"score":"23041835041","product_id":100034901,"comment_content":"我觉得即时消息可以放到MQ中，或者缓存中，使用数据抽取工具周期性的将数据提交服务器，进行持久化。服务器存储历史数据和近实时的数据。","like_count":6,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465201,"discussion_content":"对，你说的这种方式其实是通过队列来异步化解耦消息存储逻辑。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567049997,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":128862,"user_name":"许童童","can_delete":false,"product_type":"c1","uid":1003005,"ip_address":"","ucode":"4B799C0C6BC678","user_header":"https://static001.geekbang.org/account/avatar/00/0f/4d/fd/0aa0e39f.jpg","comment_is_top":false,"comment_ctime":1566977932,"is_pvip":false,"replies":[{"id":"48042","content":"是的，服务端可以只是维护一个用于暂存消息和信令的离线buffer，至于存多久和产品需求以及监管需求相关。","user_name":"作者回复","user_name_real":"coldwalker","uid":"1297490","ctime":1567047476,"ip_address":"","comment_id":128862,"utype":1}],"discussion_count":1,"race_medal":0,"score":"23041814412","product_id":100034901,"comment_content":"思考题:我觉得是需要的，如果消息接受方不在线，消息总要有一个地方存储，不是存服务器就是存发送方，存发送方显然是不行的，因为那就相当于没有发送。所以最终还是要存到服务器的，但存储形式不限于存储服务，可以是去中心化的，或者是一种缓存机制只保存几天。","like_count":5,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465141,"discussion_content":"是的，服务端可以只是维护一个用于暂存消息和信令的离线buffer，至于存多久和产品需求以及监管需求相关。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567047476,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":128687,"user_name":"一步","can_delete":false,"product_type":"c1","uid":1005391,"ip_address":"","ucode":"73CEA468CE70C3","user_header":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","comment_is_top":false,"comment_ctime":1566950728,"is_pvip":true,"replies":[{"id":"47826","content":"对，是指网关层服务。","user_name":"作者回复","user_name_real":"coldwalker","uid":"1297490","ctime":1566968787,"ip_address":"","comment_id":128687,"utype":1}],"discussion_count":2,"race_medal":0,"score":"23041787208","product_id":100034901,"comment_content":"接入服务层是不是就相当于网关层服务的？","like_count":5,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465057,"discussion_content":"对，是指网关层服务。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566968787,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1367129,"avatar":"","nickname":"hanxx","note":"","ucode":"89ABED1BFD9791","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":6535,"discussion_content":"接入服务器，我们游戏一般叫网关服务器","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566959932,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":129033,"user_name":"漩涡鸣人","can_delete":false,"product_type":"c1","uid":1108346,"ip_address":"","ucode":"A39A8D88BFB125","user_header":"https://static001.geekbang.org/account/avatar/00/10/e9/7a/f5246858.jpg","comment_is_top":false,"comment_ctime":1567012827,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"18746882011","product_id":100034901,"comment_content":"对im很感兴趣，给老师点个赞✺◟(∗❛ัᴗ❛ั∗)◞✺","like_count":4},{"had_liked":false,"id":128758,"user_name":"东林路易斯","can_delete":false,"product_type":"c1","uid":1112990,"ip_address":"","ucode":"37DE064C45660D","user_header":"https://static001.geekbang.org/account/avatar/00/10/fb/9e/682c41d3.jpg","comment_is_top":false,"comment_ctime":1566957880,"is_pvip":false,"replies":[{"id":"47830","content":"嗯，也要考虑监管方面的需求，多端同步方案合理的话不会导致冲突。","user_name":"作者回复","user_name_real":"coldwalker","uid":"1297490","ctime":1566969337,"ip_address":"","comment_id":128758,"utype":1}],"discussion_count":2,"race_medal":0,"score":"18746827064","product_id":100034901,"comment_content":"存不存看需求吧。<br>1. 消息一定要经过服务端进行过滤验证的，用异步存储性能消耗也不大。<br>2. 只是存着拿来做什么，多端消息记录同步？历史记录搜索？<br>3. 多端同步会容易导致设备本地消息记录冲突混乱吧？历史记录搜索也不现实，数据量太大但使用率太低，有点浪费资源。<br>4. 就算存起来可能真的拿来自己玩，不可能对外提供服务的。例如不合法言论多重扫描鉴别，纠纷记录凭证，大数据进行关键词热点分析等等各种不可描述的商业操作。","like_count":4,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465090,"discussion_content":"嗯，也要考虑监管方面的需求，多端同步方案合理的话不会导致冲突。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566969337,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1691181,"avatar":"https://static001.geekbang.org/account/avatar/00/19/ce/2d/33fdd230.jpg","nickname":"Sophia","note":"","ucode":"069868B84FBF40","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":25191,"discussion_content":"目前工信部要求所有消息必须存储，而且不能随意加密。不是厂商想不想存的问题~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1570449643,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":144818,"user_name":"影随","can_delete":false,"product_type":"c1","uid":1088169,"ip_address":"","ucode":"48BC4CFCAD3C2F","user_header":"https://static001.geekbang.org/account/avatar/00/10/9a/a9/ae10f6cd.jpg","comment_is_top":false,"comment_ctime":1572062782,"is_pvip":false,"replies":[{"id":"56360","content":"如果m n x都需要接收同样的消息，可以让接入服务器通过消息队列来订阅业务层产生的所有消息就可以啦，就不需要业务层找机器了。","user_name":"作者回复","user_name_real":"coldwalker","uid":"1297490","ctime":1572437786,"ip_address":"","comment_id":144818,"utype":1}],"discussion_count":2,"race_medal":0,"score":"14456964670","product_id":100034901,"comment_content":"老师您好,我这边有个Netty做websocket服务器的问题,望您解惑,问题如下：<br><br>用Netty创建的websocket服务,此时有Netty服务器集群,机器A,B,C<br>假设客户端 m,n,x 分别这样(m-A,n-B,x-C)连上了服务器,产生一个channel 。<br>如果我要通过服务器,通过后台管理系统,向m,n,x客户端一次性推送一次相同的消息。<br>问题是,我需要先找到m,n,x所对应的通道机器,找到机器后再根据channel进行推送呢？还是？<br>业务逻辑找机器感觉有点奇怪,望老师指点迷津。","like_count":3,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":472123,"discussion_content":"如果m n x都需要接收同样的消息，可以让接入服务器通过消息队列来订阅业务层产生的所有消息就可以啦，就不需要业务层找机器了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572437786,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1018620,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/8a/fc/d1dd57dd.jpg","nickname":"ipofss","note":"","ucode":"DE3061C9259F9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":290921,"discussion_content":"我是从业务层做的，去找机器，然后进行下发。看了老师的回复，还可以用消息队列，让服务器去订阅，开眼界了。具体细节我还不了解，希望能再详细些","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594642215,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":129004,"user_name":"javaworker","can_delete":false,"product_type":"c1","uid":1056209,"ip_address":"","ucode":"ABF9DDDBD3BDBF","user_header":"https://static001.geekbang.org/account/avatar/00/10/1d/d1/f427b83e.jpg","comment_is_top":false,"comment_ctime":1567005359,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"14451907247","product_id":100034901,"comment_content":"老师讲的很棒啊，豁然开朗，公司以前就是做及时通讯的，前些年公司产品活跃用户很高，后来被微信打败了，哎，老同事都说公司及时通讯架构太老了，听老师一讲，各个部分都能对上号，很期待后面的课程，辛苦老师啦","like_count":3},{"had_liked":false,"id":128890,"user_name":"冷笑的花猫","can_delete":false,"product_type":"c1","uid":1119029,"ip_address":"","ucode":"6C368FBB577470","user_header":"https://static001.geekbang.org/account/avatar/00/11/13/35/45391914.jpg","comment_is_top":false,"comment_ctime":1566980707,"is_pvip":false,"replies":[{"id":"48043","content":"期中左右会有一个简单版的IM的代码实现，架构图的我尽量去细化的讲，大家有问题的也可以随时给我留言提问。","user_name":"作者回复","user_name_real":"coldwalker","uid":"1297490","ctime":1567047586,"ip_address":"","comment_id":128890,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14451882595","product_id":100034901,"comment_content":"请问后续老师会逐一用代码或者伪代码分解这些知识点吗？架构图会不会讲解？毕竟只是文字的话不是那么好理解，谢谢。","like_count":3,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465157,"discussion_content":"期中左右会有一个简单版的IM的代码实现，架构图的我尽量去细化的讲，大家有问题的也可以随时给我留言提问。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567047586,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":128662,"user_name":"sam","can_delete":false,"product_type":"c1","uid":1000417,"ip_address":"","ucode":"8D48F4B9045947","user_header":"https://static001.geekbang.org/account/avatar/00/0f/43/e1/b7be5560.jpg","comment_is_top":false,"comment_ctime":1566938622,"is_pvip":false,"replies":[{"id":"47825","content":"服务端存储需要更多考虑成本和数据安全，也和产品定位有关，比如不需要支持消息多终端同步的应用，可以不在服务端进行存储。当然，还需要考虑国内监管机制是否允许的问题。","user_name":"作者回复","user_name_real":"coldwalker","uid":"1297490","ctime":1566968759,"ip_address":"","comment_id":128662,"utype":1}],"discussion_count":7,"race_medal":0,"score":"14451840510","product_id":100034901,"comment_content":"微信没有将消息存储在服务器上;<br>Telegram将消息存储在服务器上了;<br>要不要进行服务端存储考虑的因素有哪些？我想产品根据自身特性和存储成本等因素来考量吧<br>有一个说法是（不知是否真假），腾讯不想承担大量消息存储的硬件成本，而选择不在服务端存储消息。","like_count":3,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465045,"discussion_content":"服务端存储需要更多考虑成本和数据安全，也和产品定位有关，比如不需要支持消息多终端同步的应用，可以不在服务端进行存储。当然，还需要考虑国内监管机制是否允许的问题。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566968759,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1178756,"avatar":"https://static001.geekbang.org/account/avatar/00/11/fc/84/9f8afa9b.jpg","nickname":"瑜斌","note":"","ucode":"171FAF5736F334","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":6554,"discussion_content":"问过微信服务端朋友，是存服务端的。","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1566969384,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1642447,"avatar":"","nickname":"Geek_c1c44a","note":"","ucode":"F1C1DB564C335D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":6931,"discussion_content":" 同事发送小晚与xx的微信，直接被微信过滤了.消息命中关键词，直接丢弃. 牛逼啊。微信必然存服务器","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1567178153,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1205253,"avatar":"https://static001.geekbang.org/account/avatar/00/12/64/05/6989dce6.jpg","nickname":"我来也","note":"","ucode":"773D6104F56767","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":6768,"discussion_content":"微信服务器不存储消息，如何多端同步？如果之前pc端离线，手机在线，然后手机先离线，pc再上线，pc怎么去同步离线过程中的消息？有消息的手机端此时根本就不在线！","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1567090804,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1206833,"avatar":"https://static001.geekbang.org/account/avatar/00/12/6a/31/83e2fe48.jpg","nickname":"HOTPOOR-@xialiwei","note":"","ucode":"E51B83A875B6B1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":8067,"discussion_content":"有这么一种设计，消息是是需要等到mobile端获取后再从缓存db中拿走的，比较有意思的观察，微信手机端换设备，期间消息都会有，网页、pc和pad客户端，会存在丢消息。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567771753,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1005391,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","nickname":"一步","note":"","ucode":"73CEA468CE70C3","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":6507,"discussion_content":"我感觉腾讯是在服务端存储了消息，因为你可以去腾讯本部申请调取你的消息记录，之前还有流言说：政府是可以调取查看用户的微信的聊天记录的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566950041,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1027781,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ae/c5/09c2dd48.jpg","nickname":"M$画像","note":"","ucode":"B7298F0CC7ADC8","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":6503,"discussion_content":"那用户换了机器也能回复聊天记录是怎么回事？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566947825,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":197885,"user_name":"0xTang","can_delete":false,"product_type":"c1","uid":1019659,"ip_address":"","ucode":"82F5282EF3044B","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8f/0b/a438de52.jpg","comment_is_top":false,"comment_ctime":1585402074,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"10175336666","product_id":100034901,"comment_content":"接入服务和业务服务的通信，可以有几个，同步的有http和rpc，异步的可以使用mq","like_count":3,"discussions":[{"author":{"id":1066508,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/0c/773ba2f3.jpg","nickname":"下个目标45k","note":"","ucode":"193BA8C3AA9A61","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":298544,"discussion_content":"同步的话http性能跟不上，还是长连接吧","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1597322477,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":131293,"user_name":"行云","can_delete":false,"product_type":"c1","uid":1311147,"ip_address":"","ucode":"412B45ACCD86FD","user_header":"https://static001.geekbang.org/account/avatar/00/14/01/ab/2a5388b1.jpg","comment_is_top":false,"comment_ctime":1567696515,"is_pvip":false,"replies":[{"id":"49863","content":"有session维护就可以做到：知道这个用户的连接在哪台网关机上，这样处理完之后就能通过session进行response回推了。","user_name":"作者回复","user_name_real":"coldwalker","uid":"1297490","ctime":1567768566,"ip_address":"","comment_id":131293,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10157631107","product_id":100034901,"comment_content":"数据还是要存的，用途很多，比如分析，监管调取等。有个问题，如果接入层只做接入，怎么在长链接中原路返回业务响应呢？","like_count":2,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":466375,"discussion_content":"有session维护就可以做到：知道这个用户的连接在哪台网关机上，这样处理完之后就能通过session进行response回推了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567768566,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":129095,"user_name":"楠木","can_delete":false,"product_type":"c1","uid":1645288,"ip_address":"","ucode":"D58444777224F2","user_header":"https://static001.geekbang.org/account/avatar/00/19/1a/e8/0af69054.jpg","comment_is_top":false,"comment_ctime":1567041779,"is_pvip":false,"replies":[{"id":"48052","content":"web端也是可以的呀，思路是一样的，现在H5支持的很好了，websocket基本是标配，也是长连接的支持服务端推送的。","user_name":"作者回复","user_name_real":"coldwalker","uid":"1297490","ctime":1567050548,"ip_address":"","comment_id":129095,"utype":1}],"discussion_count":2,"race_medal":0,"score":"10156976371","product_id":100034901,"comment_content":"老师<br>你好，这个可以做基于web网页的即时通讯功能吗","like_count":2,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465273,"discussion_content":"web端也是可以的呀，思路是一样的，现在H5支持的很好了，websocket基本是标配，也是长连接的支持服务端推送的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567050548,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1421920,"avatar":"https://static001.geekbang.org/account/avatar/00/15/b2/60/ae8240aa.jpg","nickname":"","note":"","ucode":"5E97D5D6E7D89F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":6690,"discussion_content":"同问","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567051077,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":129069,"user_name":"ly","can_delete":false,"product_type":"c1","uid":1221628,"ip_address":"","ucode":"5E2B85252DABF3","user_header":"https://static001.geekbang.org/account/avatar/00/12/a3/fc/379387a4.jpg","comment_is_top":false,"comment_ctime":1567038743,"is_pvip":false,"replies":[{"id":"48047","content":"1. 是，接入层指的是客户端连接的网关服务，一般用于连接保持、编解码、session维护等。<br>2. 接收方不在线时是需要服务端进行消息和信令暂存的，存多久由产品需求和监管需求决定。","user_name":"作者回复","user_name_real":"coldwalker","uid":"1297490","ctime":1567050212,"ip_address":"","comment_id":129069,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10156973335","product_id":100034901,"comment_content":"感觉IM消息的几点特性和MQ的相似，什么可靠性、顺序性、一致性，都好像。可能实现的手段应该都是类似的。<br>另外咨询一下老师，接入层是不是主要就是对用户的socket进行持有，包括收发请求等，最近在学网络编程、nio这一块的东西，所以对这一层特感兴趣！<br>一般情况下，消息是可以不储存的，例如一般的QQ用户，只会存在客户端，但是有个开通漫游消息的付费功能，这个功能应该是会储存消息的。总体还是看业务需求吧！","like_count":2,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465257,"discussion_content":"1. 是，接入层指的是客户端连接的网关服务，一般用于连接保持、编解码、session维护等。\n2. 接收方不在线时是需要服务端进行消息和信令暂存的，存多久由产品需求和监管需求决定。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567050212,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":128843,"user_name":"leslie","can_delete":false,"product_type":"c1","uid":1324255,"ip_address":"","ucode":"798E7C1CC98CC2","user_header":"https://static001.geekbang.org/account/avatar/00/14/34/df/64e3d533.jpg","comment_is_top":false,"comment_ctime":1566973698,"is_pvip":false,"replies":[{"id":"48041","content":"个人觉得倒是和是否是CS、BS架构关系不太大，这个主要还是看产品层面的需求吧，不考虑监管的情况下，如果产品层面不需要支持消息多终端同步，服务端可以只对接收到的消息和信令进行短时间的暂存（比如几天），有终端上线取走后就删掉；对于需要支持多终端消息同步的场景，有一端取走后消息还是需要保留一定时间。另外，用户量小、保留时间短的话这个buffer可以放内存。","user_name":"作者回复","user_name_real":"coldwalker","uid":"1297490","ctime":1567047278,"ip_address":"","comment_id":128843,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10156908290","product_id":100034901,"comment_content":"对于老师的问题：个人觉得不一定；看实际需求。<br>1.一些临时会话，g统消息完全没必要保留许多天，几天就足够了<br>3.系统架构和服务器情况：如果只是传统的CS或BS架构没办法；可是当使用了内存库和消息队列之后，内存容易足够大的情况下完全可以只把部分消息存入服务器存储<br>这是个人对学习的一些见解：请老师提点。","like_count":2,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465130,"discussion_content":"个人觉得倒是和是否是CS、BS架构关系不太大，这个主要还是看产品层面的需求吧，不考虑监管的情况下，如果产品层面不需要支持消息多终端同步，服务端可以只对接收到的消息和信令进行短时间的暂存（比如几天），有终端上线取走后就删掉；对于需要支持多终端消息同步的场景，有一端取走后消息还是需要保留一定时间。另外，用户量小、保留时间短的话这个buffer可以放内存。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567047278,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":128658,"user_name":"寒冰","can_delete":false,"product_type":"c1","uid":1125673,"ip_address":"","ucode":"83D2E57191B5A0","user_header":"https://static001.geekbang.org/account/avatar/00/11/2d/29/009202d8.jpg","comment_is_top":false,"comment_ctime":1566927455,"is_pvip":false,"replies":[{"id":"47824","content":"服务端存储需要更多考虑成本和数据安全，也和产品定位有关，比如不需要支持消息多终端同步的应用，可以不在服务端进行存储。当然，还需要考虑国内监管机制是否允许的问题。","user_name":"作者回复","user_name_real":"coldwalker","uid":"1297490","ctime":1566968643,"ip_address":"","comment_id":128658,"utype":1}],"discussion_count":2,"race_medal":0,"score":"10156862047","product_id":100034901,"comment_content":"传统的IM肯定是需要在服务端存储的，但是现在新的一些技术，点对点以及区块链之类的技术加入后，可以不放在服务器，去中心化，这样信息安全性更好","like_count":2,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465043,"discussion_content":"服务端存储需要更多考虑成本和数据安全，也和产品定位有关，比如不需要支持消息多终端同步的应用，可以不在服务端进行存储。当然，还需要考虑国内监管机制是否允许的问题。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566968643,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1061161,"avatar":"https://static001.geekbang.org/account/avatar/00/10/31/29/44b9e36a.jpg","nickname":"zack","note":"","ucode":"DC5E2354E0EC78","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":6844,"discussion_content":"那什么情况下 不需要消息对多终端 同步呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567136596,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":165625,"user_name":"禽兽先生","can_delete":false,"product_type":"c1","uid":1440946,"ip_address":"","ucode":"B07A9F4E77ED8F","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI2Wlrqc7yzjylWHv63iad42t1ykDpZejWycL63QKMFzI7TwfUia2HlGXZbDYiaU6F4ziaY78Tt0w6bmA/132","comment_is_top":false,"comment_ctime":1577271463,"is_pvip":false,"replies":[{"id":"63284","content":"这里接入服务逻辑和业务逻辑分开只是让接入服务不涉及业务细节，但业务本身的执行还是需要依赖接入服务来完成和客户端的交互。","user_name":"作者回复","user_name_real":"coldwalker","uid":"1297490","ctime":1577364521,"ip_address":"","comment_id":165625,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5872238759","product_id":100034901,"comment_content":"老师，接入服务逻辑和业务处理逻辑分开，是说业务逻辑和长链接并不是依赖关系吗？就比如说我长链接断了，还能获取好友列表吗","like_count":1,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":479235,"discussion_content":"这里接入服务逻辑和业务逻辑分开只是让接入服务不涉及业务细节，但业务本身的执行还是需要依赖接入服务来完成和客户端的交互。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577364521,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":147903,"user_name":"康斯坦丁","can_delete":false,"product_type":"c1","uid":1368096,"ip_address":"","ucode":"C130E800E8D5C9","user_header":"https://static001.geekbang.org/account/avatar/00/14/e0/20/003190c1.jpg","comment_is_top":false,"comment_ctime":1572918216,"is_pvip":false,"replies":[{"id":"57204","content":"这个看具体业务需要哈，有的app不需要多终端消息漫游，这种场景实际上可以不进行永久存储，只需要buffer一定时间的离线消息就可以。","user_name":"作者回复","user_name_real":"coldwalker","uid":"1297490","ctime":1573035520,"ip_address":"","comment_id":147903,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5867885512","product_id":100034901,"comment_content":"<br>最后，留给你一个思考题。消息一定需要在服务端的存储服务里进行存储吗？<br><br>一定需要，一个是离线消息拉取、一个是多端漫游，一个是app重装都会导致客户端存储的消息失效","like_count":1,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":473331,"discussion_content":"这个看具体业务需要哈，有的app不需要多终端消息漫游，这种场景实际上可以不进行永久存储，只需要buffer一定时间的离线消息就可以。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573035520,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":136395,"user_name":"null","can_delete":false,"product_type":"c1","uid":1024294,"ip_address":"","ucode":"F9039EFED6B55D","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaELZPnUAiajaR5C25EDLWeJURggyiaOP5GGPe2qlwpQcm5e3ybib8OsP4tvddFDLVRSNNGL5I3SFPJHsA/132","comment_is_top":false,"comment_ctime":1569422437,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5864389733","product_id":100034901,"comment_content":"如果在客户端存储消息，一致性和安全性就难以保障？！！","like_count":1},{"had_liked":false,"id":131993,"user_name":"Geek_123","can_delete":false,"product_type":"c1","uid":1643832,"ip_address":"","ucode":"6041CD3C786A66","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/2jNKZqm7nMHmU567L4TrAbDZTxA0uhERx16icb2fSxso54RgkAOMJSI1FFsrwxfDxCAuAnpmSVd7X1k8DRIW9YA/132","comment_is_top":false,"comment_ctime":1568000765,"is_pvip":false,"replies":[{"id":"50517","content":"这个专栏主要是针对IM技术中比较重要和有难度的点来详细展开。会涉及到xmpp和mqtt相关的知识，但不会太深入讲解协议的内容和格式。","user_name":"作者回复","user_name_real":"coldwalker","uid":"1297490","ctime":1568037491,"ip_address":"","comment_id":131993,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5862968061","product_id":100034901,"comment_content":"老师，请问这套课程中是否涉及了IM的类似XMPP和MQTT消息协议的相关内容，及IM通讯框架相关技术？","like_count":1,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":466717,"discussion_content":"这个专栏主要是针对IM技术中比较重要和有难度的点来详细展开。会涉及到xmpp和mqtt相关的知识，但不会太深入讲解协议的内容和格式。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1568037491,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":131231,"user_name":"苏近之","can_delete":false,"product_type":"c1","uid":1614419,"ip_address":"","ucode":"C431369E44B926","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/41OnicB5R5ofibpEX4kbqH6ebibZW1dVImfKSkeaHw4D9nnvyoLmDSX0e1OmhoDlL9ZMEhgpopxPt53KW6BNpXibWQ/132","comment_is_top":false,"comment_ctime":1567675945,"is_pvip":false,"replies":[{"id":"49540","content":"网约车里面应该也有很多IM的场景，比如：司机和乘客的聊天，实时位置更新等。","user_name":"作者回复","user_name_real":"coldwalker","uid":"1297490","ctime":1567684297,"ip_address":"","comment_id":131231,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5862643241","product_id":100034901,"comment_content":"实际的项目需要做网约车，这是不是和im原理相同，所以我选择学习这门课程？","like_count":1,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":466343,"discussion_content":"网约车里面应该也有很多IM的场景，比如：司机和乘客的聊天，实时位置更新等。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567684297,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1614419,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/41OnicB5R5ofibpEX4kbqH6ebibZW1dVImfKSkeaHw4D9nnvyoLmDSX0e1OmhoDlL9ZMEhgpopxPt53KW6BNpXibWQ/132","nickname":"苏近之","note":"","ucode":"C431369E44B926","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":7826,"discussion_content":"我们准备使用阿里云的mqtt来降低开发成本","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567685139,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":130905,"user_name":"段先森","can_delete":false,"product_type":"c1","uid":1310788,"ip_address":"","ucode":"90251BB8BF8DDB","user_header":"https://static001.geekbang.org/account/avatar/00/14/00/44/d5cf762b.jpg","comment_is_top":false,"comment_ctime":1567569930,"is_pvip":false,"replies":[{"id":"49168","content":"这个需要看具体数据包大小和用户的活跃程度哈~","user_name":"作者回复","user_name_real":"coldwalker","uid":"1297490","ctime":1567597863,"ip_address":"","comment_id":130905,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5862537226","product_id":100034901,"comment_content":"老师 就您的经验看日活40万的话需要多少带宽比较合适呢","like_count":2,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":466189,"discussion_content":"这个需要看具体数据包大小和用户的活跃程度哈~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567597863,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":130723,"user_name":"煜","can_delete":false,"product_type":"c1","uid":1650785,"ip_address":"","ucode":"3C5A9A55A65FC9","user_header":"https://static001.geekbang.org/account/avatar/00/19/30/61/50e24e09.jpg","comment_is_top":false,"comment_ctime":1567519484,"is_pvip":false,"replies":[{"id":"48948","content":"一般没见过这么存的，当然，如果支持按使用场景来快速写入和查询也是可以的哈","user_name":"作者回复","user_name_real":"coldwalker","uid":"1297490","ctime":1567521801,"ip_address":"","comment_id":130723,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5862486780","product_id":100034901,"comment_content":"消息可以通过logstash+elasticsearch进行存储吗","like_count":1,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":466090,"discussion_content":"一般没见过这么存的，当然，如果支持按使用场景来快速写入和查询也是可以的哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567521801,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":130716,"user_name":"cookieswolf","can_delete":false,"product_type":"c1","uid":1031153,"ip_address":"","ucode":"A2843B4F3D1977","user_header":"https://static001.geekbang.org/account/avatar/00/0f/bb/f1/0e323ea7.jpg","comment_is_top":false,"comment_ctime":1567517096,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5862484392","product_id":100034901,"comment_content":"服务器端存储与否，是要看产品的定位以及实际的需求。我个人认为，服务端的存储介入是需要的。<br>但主要针对的是保证系统的一致性以及实时性，而进行的存储。而不是狭义的认为，保存用户之间的通讯内容。","like_count":1},{"had_liked":false,"id":129876,"user_name":"王兴强","can_delete":false,"product_type":"c1","uid":1249679,"ip_address":"","ucode":"3E3E71496BABCF","user_header":"https://static001.geekbang.org/account/avatar/00/13/11/8f/70ea4196.jpg","comment_is_top":false,"comment_ctime":1567310556,"is_pvip":false,"replies":[{"id":"48450","content":"没有具体用过这款软件，远程控制这些功能是比较适合使用IM的解决方案来实现的，可以尝试一下呀。","user_name":"作者回复","user_name_real":"coldwalker","uid":"1297490","ctime":1567324298,"ip_address":"","comment_id":129876,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5862277852","product_id":100034901,"comment_content":"老师，TeamViewer这款远程连接软件不知您用过没有，您这们课程学习完成后是否可以自己实现这种远程连接软件应用，从客户端和服务端都能做一个简单的实现。我看课程里面有远程监控和远程连接的内容。","like_count":1,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465689,"discussion_content":"没有具体用过这款软件，远程控制这些功能是比较适合使用IM的解决方案来实现的，可以尝试一下呀。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567324298,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":129483,"user_name":"不负","can_delete":false,"product_type":"c1","uid":1238323,"ip_address":"","ucode":"147F5860711811","user_header":"https://static001.geekbang.org/account/avatar/00/12/e5/33/ff5c52ad.jpg","comment_is_top":false,"comment_ctime":1567136769,"is_pvip":true,"replies":[{"id":"48349","content":"websocket只是一个支持服务端推送的通信协议，和发布订阅没有关系哈。IM的推送是可以基于websocket协议来实现的，连接方面的问题就需要具体case来分析了。","user_name":"作者回复","user_name_real":"coldwalker","uid":"1297490","ctime":1567178334,"ip_address":"","comment_id":129483,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5862104065","product_id":100034901,"comment_content":"App中的消息推送也是采用 IM 即时通讯技术？此时是多对多场景，目前项目的推送使用的是WebSocket进行发布订阅，使用可能出现连接等问题，体验不好，IM 的推送是基于WebSocket发布订阅 进行改进，还是采用其他的发布订阅模式？","like_count":2,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465498,"discussion_content":"websocket只是一个支持服务端推送的通信协议，和发布订阅没有关系哈。IM的推送是可以基于websocket协议来实现的，连接方面的问题就需要具体case来分析了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567178334,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":129463,"user_name":"不负","can_delete":false,"product_type":"c1","uid":1238323,"ip_address":"","ucode":"147F5860711811","user_header":"https://static001.geekbang.org/account/avatar/00/12/e5/33/ff5c52ad.jpg","comment_is_top":false,"comment_ctime":1567133318,"is_pvip":true,"replies":[{"id":"48348","content":"这里指的是：消息不需要在服务端持久化。","user_name":"作者回复","user_name_real":"coldwalker","uid":"1297490","ctime":1567178081,"ip_address":"","comment_id":129463,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5862100614","product_id":100034901,"comment_content":"“是否一定要在服务端存储服务中存储”，是指有的消息不需要持久化还是有别的存储方式？","like_count":1,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465483,"discussion_content":"这里指的是：消息不需要在服务端持久化。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567178081,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":129430,"user_name":"Red Cape","can_delete":false,"product_type":"c1","uid":1245056,"ip_address":"","ucode":"12B69514E3EE11","user_header":"https://static001.geekbang.org/account/avatar/00/12/ff/80/382e46b6.jpg","comment_is_top":false,"comment_ctime":1567128367,"is_pvip":false,"replies":[{"id":"48345","content":"对于上行通道的发送方的发消息行为来说，一般存储完DB甚至只存储完cache就会立即响应，不会等到MQ处理再回写。","user_name":"作者回复","user_name_real":"coldwalker","uid":"1297490","ctime":1567177655,"ip_address":"","comment_id":129430,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5862095663","product_id":100034901,"comment_content":"老师，请问如果拆分接入服务与业务服务，上面有提到用MQ做消息链路，那业务服务处理后的数据也是重新回写到MQ吗？","like_count":1,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465464,"discussion_content":"对于上行通道的发送方的发消息行为来说，一般存储完DB甚至只存储完cache就会立即响应，不会等到MQ处理再回写。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567177655,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2037540,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/qgbQytfwErGXuIZaRzA28iagmfnZDHKMYIGwZ7sJ6NAicVicDewic8S266eA9L4wO2q1y4XwcMGE6urK9L6vuQBpMA/132","nickname":"Geek_6e6dba","note":"","ucode":"E7B1A5DC90760D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":283498,"discussion_content":"老师还在关注这个课的留言吗？如果“不会等到MQ处理再回写” 那怎么跟接入层交互呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592283887,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":129238,"user_name":"王棕生","can_delete":false,"product_type":"c1","uid":1337944,"ip_address":"","ucode":"901BD0447A871E","user_header":"https://static001.geekbang.org/account/avatar/00/14/6a/58/f2c6d65b.jpg","comment_is_top":false,"comment_ctime":1567068999,"is_pvip":false,"replies":[{"id":"48116","content":"是的，存储时限由需求决定","user_name":"作者回复","user_name_real":"coldwalker","uid":"1297490","ctime":1567087876,"ip_address":"","comment_id":129238,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5862036295","product_id":100034901,"comment_content":"消息是否存储由具体业务对消息的可靠性要求决定的：一般要求不能丢的消息，如p2p的私信消息，必须要持久化，这样可以做到离线处理和历史拉取; 一般要求允许丢的消息，可以不存储，如广播消息，不存储可以减轻服务端压力，用户收不到也无妨！","like_count":1,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465350,"discussion_content":"是的，存储时限由需求决定","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567087876,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1337944,"avatar":"https://static001.geekbang.org/account/avatar/00/14/6a/58/f2c6d65b.jpg","nickname":"王棕生","note":"","ucode":"901BD0447A871E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":6826,"discussion_content":"感谢老师的回复！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567132283,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":129166,"user_name":"Biao","can_delete":false,"product_type":"c1","uid":1212891,"ip_address":"","ucode":"10F8DE91ED4B07","user_header":"https://static001.geekbang.org/account/avatar/00/12/81/db/e6baf13c.jpg","comment_is_top":false,"comment_ctime":1567053777,"is_pvip":false,"replies":[{"id":"48113","content":"下一节课程会讲到服务端消息存储的设计，后面代码实战部分也会有相关简易示例代码。","user_name":"作者回复","user_name_real":"coldwalker","uid":"1297490","ctime":1567087685,"ip_address":"","comment_id":129166,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5862021073","product_id":100034901,"comment_content":"老师会详细讲一下消息存储，目前我们的系统是需要存储的","like_count":1,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465317,"discussion_content":"下一节课程会讲到服务端消息存储的设计，后面代码实战部分也会有相关简易示例代码。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567087685,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":128993,"user_name":"落霞与孤鹜","can_delete":false,"product_type":"c1","uid":1111004,"ip_address":"","ucode":"1F06EB86DD2E6B","user_header":"https://static001.geekbang.org/account/avatar/00/10/f3/dc/e7e5c159.jpg","comment_is_top":false,"comment_ctime":1567002971,"is_pvip":false,"discussion_count":3,"race_medal":0,"score":"5861970267","product_id":100034901,"comment_content":"我们做的客服系统，消息是存储在服务端的，用作历史会话查询，客服甄别服务质量等。我们消息是从接入端发送到kafka，业务端消费kafka，同时业务端按业务对主题做进一步细分。","like_count":1,"discussions":[{"author":{"id":1210265,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Gswh7ibY4tubXhp0BXOmV2pXZ3XsXic1d942ZMAEgWrRSF99bDskOTsG1g172ibORXxSCWTn9HWUX5vSSUVWU5I4A/132","nickname":"奔奔奔跑","note":"","ucode":"F86EC205DCAACE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":41994,"discussion_content":"我们用mq做的，经常出现中断连接","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572567952,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1642796,"avatar":"https://static001.geekbang.org/account/avatar/00/19/11/2c/a0de4b8a.jpg","nickname":"爱学习的盖茨比","note":"","ucode":"1C1AFBDDBC0957","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":7077,"discussion_content":"我也是做客服系统的，想请问你们用户连接接入系统的失败率多高？消息到达率多高？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567341928,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1111004,"avatar":"https://static001.geekbang.org/account/avatar/00/10/f3/dc/e7e5c159.jpg","nickname":"落霞与孤鹜","note":"","ucode":"1F06EB86DD2E6B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1642796,"avatar":"https://static001.geekbang.org/account/avatar/00/19/11/2c/a0de4b8a.jpg","nickname":"爱学习的盖茨比","note":"","ucode":"1C1AFBDDBC0957","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":7216,"discussion_content":"我们的失败是用户进入排队了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567420377,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":7077,"ip_address":""},"score":7216,"extra":""}]}]},{"had_liked":false,"id":128936,"user_name":"韩博恒","can_delete":false,"product_type":"c1","uid":1119917,"ip_address":"","ucode":"00919C9D748CD0","user_header":"https://static001.geekbang.org/account/avatar/00/11/16/ad/553dc35c.jpg","comment_is_top":false,"comment_ctime":1566988295,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5861955591","product_id":100034901,"comment_content":"就看产品的定位，消息是否重要或有价值，有必要，还是要存，至少保证数据的持久性","like_count":1},{"had_liked":false,"id":128892,"user_name":"Gary","can_delete":false,"product_type":"c1","uid":1079429,"ip_address":"","ucode":"11CFE13D83E5F5","user_header":"https://static001.geekbang.org/account/avatar/00/10/78/85/e5d3cfd8.jpg","comment_is_top":false,"comment_ctime":1566980887,"is_pvip":false,"replies":[{"id":"48044","content":"嗯，接收方不在线时是需要服务端进行消息和信令暂存的，存多久由产品需求和监管需求决定。","user_name":"作者回复","user_name_real":"coldwalker","uid":"1297490","ctime":1567047759,"ip_address":"","comment_id":128892,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5861948183","product_id":100034901,"comment_content":"我觉得大部分还是要存的，大部分都会存，只是存多久的问题","like_count":1,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465158,"discussion_content":"嗯，接收方不在线时是需要服务端进行消息和信令暂存的，存多久由产品需求和监管需求决定。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567047759,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":128773,"user_name":"哈","can_delete":false,"product_type":"c1","uid":1130578,"ip_address":"","ucode":"36733D24917941","user_header":"https://static001.geekbang.org/account/avatar/00/11/40/52/7266ee09.jpg","comment_is_top":false,"comment_ctime":1566960504,"is_pvip":false,"replies":[{"id":"47832","content":"嗯，有一些数据还是需要同步给服务器进行存储的，比如通讯录。类似这种“重客户端”的模式也有很多好处，比如搜索、比如未读数计算这些。","user_name":"作者回复","user_name_real":"coldwalker","uid":"1297490","ctime":1566969737,"ip_address":"","comment_id":128773,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5861927800","product_id":100034901,"comment_content":"不一定，微信客户端有数据库，一些消息，设置是存在客户端的，但是我认为本地数据还是会定期同步到服务器上，本地的数据相当于一个缓存，一些操作可以不经过服务器返回就能获得。不知道我理解的对不对，开始研究的微信，现在在研究telegram，对于一个im的设计整体框架还再学习用。希望老师能够在文章中解决我的问题","like_count":1,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465096,"discussion_content":"嗯，有一些数据还是需要同步给服务器进行存储的，比如通讯录。类似这种“重客户端”的模式也有很多好处，比如搜索、比如未读数计算这些。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566969737,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":128755,"user_name":"刘天鹏","can_delete":false,"product_type":"c1","uid":1632015,"ip_address":"","ucode":"FB146250578911","user_header":"https://static001.geekbang.org/account/avatar/00/18/e7/0f/fa840c1b.jpg","comment_is_top":false,"comment_ctime":1566957424,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5861924720","product_id":100034901,"comment_content":"好的吧  不然服务重启了，那些离线消息不就丢了","like_count":1,"discussions":[{"author":{"id":1182731,"avatar":"https://static001.geekbang.org/account/avatar/00/12/0c/0b/1ccc90b7.jpg","nickname":"-Violet Evergarden-","note":"","ucode":"B483A3ACFB36F8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":7185,"discussion_content":"离线未同步消息肯定是要存的，已同步消息就看情况了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567418184,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":351511,"user_name":"张新成","can_delete":false,"product_type":"c1","uid":2895565,"ip_address":"","ucode":"922389935AA34B","user_header":"https://static001.geekbang.org/account/avatar/00/2c/2e/cd/0638eaa8.jpg","comment_is_top":false,"comment_ctime":1657856533,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1657856533","product_id":100034901,"comment_content":"也可以在客户端进行本地存储","like_count":0},{"had_liked":false,"id":262278,"user_name":"Michael","can_delete":false,"product_type":"c1","uid":1104070,"ip_address":"","ucode":"791264A204A1D5","user_header":"https://static001.geekbang.org/account/avatar/00/10/d8/c6/f35f9668.jpg","comment_is_top":false,"comment_ctime":1605683322,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1605683322","product_id":100034901,"comment_content":"最近才看到这篇文章，感觉写的非常详细！也有一些疑问。<br><br>聊天系统大概由这几大部分组成：客户端、接入服务、业务处理服务、存储服务和外部接口服务。<br><br>存储服务是专门做DB存储的吗？我看业务处理服务里面也有存储处理，这与存储服务又有什么区别呢？业务处理服务跟存储服务都会操作DB吗？","like_count":0},{"had_liked":false,"id":214353,"user_name":"mickey","can_delete":false,"product_type":"c1","uid":1051663,"ip_address":"","ucode":"8B490C2DDE4010","user_header":"https://static001.geekbang.org/account/avatar/00/10/0c/0f/93d1c8eb.jpg","comment_is_top":false,"comment_ctime":1588728571,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1588728571","product_id":100034901,"comment_content":"看具体的业务需求，如果是阅后即焚的话，存缓存就可以了；有拉历史记录的，可以先存缓存，然后待机落盘。","like_count":0},{"had_liked":false,"id":193949,"user_name":"聪","can_delete":false,"product_type":"c1","uid":1009831,"ip_address":"","ucode":"9D672A8580A945","user_header":"https://static001.geekbang.org/account/avatar/00/0f/68/a7/c3fd1fd9.jpg","comment_is_top":false,"comment_ctime":1585006030,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1585006030","product_id":100034901,"comment_content":"telegram 是因为服务器放在海外，所以不受中国监管吗？如果要监管，有什么措施可以？","like_count":0,"discussions":[{"author":{"id":1066508,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/0c/773ba2f3.jpg","nickname":"下个目标45k","note":"","ucode":"193BA8C3AA9A61","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":298545,"discussion_content":"端对端加密解不了，只能从法律层面解决了","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1597322571,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":178754,"user_name":"尔冬橙","can_delete":false,"product_type":"c1","uid":1225224,"ip_address":"","ucode":"0B013A49BC18DA","user_header":"https://static001.geekbang.org/account/avatar/00/12/b2/08/92f42622.jpg","comment_is_top":false,"comment_ctime":1581817407,"is_pvip":false,"replies":[{"id":"72281","content":"后面有具体的代码示例可以参考一下。","user_name":"作者回复","user_name_real":"coldwalker","uid":"1297490","ctime":1584084201,"ip_address":"","comment_id":178754,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1581817407","product_id":100034901,"comment_content":"如果基于netty实现IM消息系统，接入服务是bossgroup实现，业务处理服务是workergroup实现？老师我这样理解有没有问题？","like_count":0,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":483949,"discussion_content":"后面有具体的代码示例可以参考一下。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584084201,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":150252,"user_name":"尔冬橙","can_delete":false,"product_type":"c1","uid":1225224,"ip_address":"","ucode":"0B013A49BC18DA","user_header":"https://static001.geekbang.org/account/avatar/00/12/b2/08/92f42622.jpg","comment_is_top":false,"comment_ctime":1573484900,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1573484900","product_id":100034901,"comment_content":"老师，能否从tcpip五层网络来讲下一条qq消息是如何传输的","like_count":0},{"had_liked":false,"id":142412,"user_name":"柯柯西55","can_delete":false,"product_type":"c1","uid":1250349,"ip_address":"","ucode":"A334FCA61E337E","user_header":"https://static001.geekbang.org/account/avatar/00/13/14/2d/94b8bc8e.jpg","comment_is_top":false,"comment_ctime":1571364527,"is_pvip":false,"replies":[{"id":"55010","content":"对客户端开发了解不多哈，个人理解对于客户端开发来说，只需要管理少量连接，原生的socket应该就够用啦。","user_name":"作者回复","user_name_real":"coldwalker","uid":"1297490","ctime":1571405358,"ip_address":"","comment_id":142412,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1571364527","product_id":100034901,"comment_content":"老师，小白请教一个问题。ios端、安卓端和服务器连接的nio框架都有什么？如何根据使用场景选择？","like_count":0,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":471113,"discussion_content":"对客户端开发了解不多哈，个人理解对于客户端开发来说，只需要管理少量连接，原生的socket应该就够用啦。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571405358,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":131863,"user_name":"Geek_123","can_delete":false,"product_type":"c1","uid":1643832,"ip_address":"","ucode":"6041CD3C786A66","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/2jNKZqm7nMHmU567L4TrAbDZTxA0uhERx16icb2fSxso54RgkAOMJSI1FFsrwxfDxCAuAnpmSVd7X1k8DRIW9YA/132","comment_is_top":false,"comment_ctime":1567941064,"is_pvip":false,"replies":[{"id":"50505","content":"不会讲具体的io框架哈，只涉及通用的IM知识。","user_name":"作者回复","user_name_real":"coldwalker","uid":"1297490","ctime":1568036208,"ip_address":"","comment_id":131863,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1567941064","product_id":100034901,"comment_content":"老师 请问这套课程有没有介绍一般ims系统采用的底层通讯框架技术呢？","like_count":0,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":466651,"discussion_content":"不会讲具体的io框架哈，只涉及通用的IM知识。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1568036208,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":129364,"user_name":"wuqilv","can_delete":false,"product_type":"c1","uid":1169314,"ip_address":"","ucode":"B9C4A2C2FF32AE","user_header":"https://static001.geekbang.org/account/avatar/00/11/d7/a2/5f6b90a9.jpg","comment_is_top":false,"comment_ctime":1567097367,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1567097367","product_id":100034901,"comment_content":"微信把聊天记录存本地了。。。。。。","like_count":0},{"had_liked":false,"id":129199,"user_name":"polk","can_delete":false,"product_type":"c1","uid":1165455,"ip_address":"","ucode":"1B6E948BA4DFAF","user_header":"https://static001.geekbang.org/account/avatar/00/11/c8/8f/e13a6552.jpg","comment_is_top":false,"comment_ctime":1567061636,"is_pvip":false,"replies":[{"id":"48115","content":"都会有的哦","user_name":"作者回复","user_name_real":"coldwalker","uid":"1297490","ctime":1567087760,"ip_address":"","comment_id":129199,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1567061636","product_id":100034901,"comment_content":"来点实战的架构图，关键的代码实现","like_count":0,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465328,"discussion_content":"都会有的哦","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567087760,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":128960,"user_name":"杜子","can_delete":false,"product_type":"c1","uid":1045942,"ip_address":"","ucode":"DC9FA67EF7B490","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f5/b6/294dafbb.jpg","comment_is_top":false,"comment_ctime":1566994970,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1566994970","product_id":100034901,"comment_content":"存不存服务器主要还是看需求吧，也可以先存再定期清理这样子吧","like_count":0},{"had_liked":false,"id":128954,"user_name":"墙角儿的花","can_delete":false,"product_type":"c1","uid":1258474,"ip_address":"","ucode":"EE5CAD76175CCF","user_header":"","comment_is_top":false,"comment_ctime":1566992525,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1566992525","product_id":100034901,"comment_content":"服务端存储不是必须的，取决于产品定位和法规。但通常要经过公网中继，除了可以p2p 的场景。","like_count":0},{"had_liked":false,"id":128726,"user_name":"Cola","can_delete":false,"product_type":"c1","uid":1048859,"ip_address":"","ucode":"67A27A8DEF42E2","user_header":"https://static001.geekbang.org/account/avatar/00/10/01/1b/24db90c7.jpg","comment_is_top":false,"comment_ctime":1566954754,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1566954754","product_id":100034901,"comment_content":"没接触过im系统，个人认为需要放在存储层服务里，原因是用户量级上来后，这部分数据会非常庞大，而为了保证消息传达的可靠性需要一个专门存储的模块来存储历史信息","like_count":0},{"had_liked":false,"id":128679,"user_name":"而立斋","can_delete":false,"product_type":"c1","uid":1087258,"ip_address":"","ucode":"5FED6E9E148195","user_header":"https://static001.geekbang.org/account/avatar/00/10/97/1a/389eab84.jpg","comment_is_top":false,"comment_ctime":1566950170,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1566950170","product_id":100034901,"comment_content":"有p2p的即时消息系统，飞鸽，挺好玩","like_count":0,"discussions":[{"author":{"id":1206833,"avatar":"https://static001.geekbang.org/account/avatar/00/12/6a/31/83e2fe48.jpg","nickname":"HOTPOOR-@xialiwei","note":"","ucode":"E51B83A875B6B1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":8070,"discussion_content":"局域网的吧是？udp给255发自己的当ip，然后找到后出列表，多个跨路由器没成功。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567772043,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":128671,"user_name":"M$画像","can_delete":false,"product_type":"c1","uid":1027781,"ip_address":"","ucode":"B7298F0CC7ADC8","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ae/c5/09c2dd48.jpg","comment_is_top":false,"comment_ctime":1566947907,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1566947907","product_id":100034901,"comment_content":"N年前腾讯的rtx就是把消息存储在客户端的了","like_count":0}]}