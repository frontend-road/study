{"id":168358,"title":"37 | 调优参数：调整System参数夯实基础","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/geek_netty\">https://gitee.com/geektime-geekbang/geek_netty</a></p>","comments":[{"had_liked":false,"id":153993,"user_name":"fancion","can_delete":false,"product_type":"c3","uid":1121584,"ip_address":"","ucode":"9000895F6BE0E4","user_header":"https://static001.geekbang.org/account/avatar/00/11/1d/30/4a82c7af.jpg","comment_is_top":false,"comment_ctime":1574344257,"is_pvip":false,"replies":[{"id":59443,"content":"先定个小目标：100万，因为这个不应该成为你程序的瓶颈，但是定太大，意义也不大，因为比如1000万，那光这些连接的占用就几十G，所以程序受不了。而且超过100多万的时候，就需要调整别的参数了，所以100万比较合适。","user_name":"作者回复","user_name_real":"Geek_9bc307","uid":1638649,"ctime":1574577106,"ip_address":"","comment_id":153993,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"请教老师文件句柄设置多少合理？怎么进行压测合理设置？","like_count":9,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":475346,"discussion_content":"先定个小目标：100万，因为这个不应该成为你程序的瓶颈，但是定太大，意义也不大，因为比如1000万，那光这些连接的占用就几十G，所以程序受不了。而且超过100多万的时候，就需要调整别的参数了，所以100万比较合适。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574577106,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":153749,"user_name":"鱼向北游","can_delete":false,"product_type":"c3","uid":1439908,"ip_address":"","ucode":"580EC7DCE57E9A","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/IPdZZXuHVMibwfZWmm7NiawzeEFGsaRoWjhuN99iaoj5amcRkiaOePo6rH1KJ3jictmNlic4OibkF4I20vOGfwDqcBxfA/132","comment_is_top":false,"comment_ctime":1574301987,"is_pvip":false,"replies":[{"id":59081,"content":"是的，还不如名字叫 tcp_delay，稍微转了一道，就认知摩擦了。","user_name":"作者回复","user_name_real":"Geek_9bc307","uid":1638649,"ctime":1574304879,"ip_address":"","comment_id":153749,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"netty的tcp_nodelay参数设置为true应该是关闭nagle算法吧，这参数从字面意义和nagle算法的标志是反的，老让人记错","like_count":4,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":475257,"discussion_content":"是的，还不如名字叫 tcp_delay，稍微转了一道，就认知摩擦了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574304879,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1337030,"avatar":"https://static001.geekbang.org/account/avatar/00/14/66/c6/d779dfb6.jpg","nickname":"松松","note":"","ucode":"EB2A80CF7BCA4B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":269050,"discussion_content":"有点儿绕……默认开启算法，算法会造成delay，一般默认flag是false，false时delay的话，true就是nodelay了。\n真费劲。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589860518,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1243982,"avatar":"https://static001.geekbang.org/account/avatar/00/12/fb/4e/2b272c1f.jpg","nickname":"酥酥","note":"","ucode":"C17B2A052D49DA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":54844,"discussion_content":"可能是因为默认都不开启。所以就改成tcp_nodelay，设置的时候 不开启=>是的。\n所以默认也是关闭","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574319271,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":157130,"user_name":"成都小郭","can_delete":false,"product_type":"c3","uid":1493899,"ip_address":"","ucode":"4399AA8C64DF21","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/hWjwsc6FgZfNkKiacOSUZicscNGFgdqvoo08QFQlfrg39srZJlZicbBP9zsLcDnKAkBfia2lZoKJ8h7QwTYiboiaRT6g/132","comment_is_top":false,"comment_ctime":1575038148,"is_pvip":false,"replies":[{"id":61838,"content":"如果非要调整的话，可以了解下BDP的概念，也就是2倍的B（bandwidth:带宽）* D（delay:延时）的积（Product）,为什么是2倍，因为数据发送是需要ACK的，所以来回各1次，所以另外一种简单算法：带宽*RTT(往返时延，类似一个Ping的来回)；\n另外附上一个如此计算的依据法则：\n利特尔法则（Little’s Law）：在一个稳定的系统中，长期的平均客户人数（N）等于客户抵达速度（X）乘以客户在这个系统中平均处理时间（W），也就是说 N=XW。\n","user_name":"作者回复","user_name_real":"stroller","uid":1638649,"ctime":1576559032,"ip_address":"","comment_id":157130,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"老师，请问tcp数据发送接受缓冲区大小应该根据什么样的条件决定呢。","like_count":1,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":476337,"discussion_content":"如果非要调整的话，可以了解下BDP的概念，也就是2倍的B（bandwidth:带宽）* D（delay:延时）的积（Product）,为什么是2倍，因为数据发送是需要ACK的，所以来回各1次，所以另外一种简单算法：带宽*RTT(往返时延，类似一个Ping的来回)；\n另外附上一个如此计算的依据法则：\n利特尔法则（Little’s Law）：在一个稳定的系统中，长期的平均客户人数（N）等于客户抵达速度（X）乘以客户在这个系统中平均处理时间（W），也就是说 N=XW。\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576559032,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":341972,"user_name":"江南布衣","can_delete":false,"product_type":"c3","uid":2341425,"ip_address":"","ucode":"F8C4D22AC27F33","user_header":"https://static001.geekbang.org/account/avatar/00/23/ba/31/37ba5a5d.jpg","comment_is_top":false,"comment_ctime":1649936598,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"请问SO_BACKLOG真的是最大的等待连接数量吗？\n我看man listen中说：\n从 Linux 2.2 开始，backlog 的参数行为在 Linux 2.2 中发生了变化，现在它指定等待接受的完全建立的套接字的队列长度，而不是不完整的连接请求的数量。 不完整套接字队列的最大长度可以使用 &#47;proc&#47;sys&#47;net&#47;ipv4&#47;tcp_max_syn_backlog 设置，默认值为 128。\n backlog 参数大小则受限于于 &#47;proc&#47;sys&#47;net&#47;core&#47;somaxconn，如果 backlog 参数大于 &#47;proc&#47;sys&#47;net&#47;core&#47;somaxconn 中的值，那么它会被静默截断为值128","like_count":1},{"had_liked":false,"id":366451,"user_name":"Geek_f39659","can_delete":false,"product_type":"c3","uid":1636568,"ip_address":"美国","ucode":"2206A8C590423C","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q3auHgzwzM6iagw7ct4ca3niaSEFNicu2wy2KuCibO6eiaRzoRGJb50WTrbkKQib9mTArnTr8jJUazO9O2ibLZNfjjl35cfCHkBPs7N/132","comment_is_top":false,"comment_ctime":1673821253,"is_pvip":false,"replies":null,"discussion_count":2,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"关于tcp_nodelay 我怀疑老师是不是口误了，我认为对大多数应用来说应该设置成 false. 尽量多用batch 来提升吞吐量。","like_count":0,"discussions":[{"author":{"id":1195258,"avatar":"https://static001.geekbang.org/account/avatar/00/12/3c/fa/e2990931.jpg","nickname":"文敦复","note":"","ucode":"B8F4A6BD5D7805","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":623386,"discussion_content":"对于IM/RPC调用，希望的尽快的消息返回，所以延时更看重，吞吐量其次，tcp_nodelay改为true。离线任务或者流式处理更看重吞吐量，此时可以设为false","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1689399265,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2175243,"avatar":"https://static001.geekbang.org/account/avatar/00/21/31/0b/91f317a0.jpg","nickname":"Belizer","note":"","ucode":"17DA133DC0BDDF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":606068,"discussion_content":"代码编写的都是writeAndFlush，口误可能性不大。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1676899900,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":342521,"user_name":"DZZ","can_delete":false,"product_type":"c3","uid":1516167,"ip_address":"","ucode":"C8E4C4B089BCE2","user_header":"https://static001.geekbang.org/account/avatar/00/17/22/87/e7bd2acf.jpg","comment_is_top":false,"comment_ctime":1650326329,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"傅老师，netty如何可以配置调整epoll_wait的timeout参数？背景是我也有一个用netty做网关的项目，压测时发现CPU使用率较高，基本耗费在执行epollwait方法里了","like_count":0},{"had_liked":false,"id":245878,"user_name":"lisong","can_delete":false,"product_type":"c3","uid":1151978,"ip_address":"","ucode":"B8018C53FD091C","user_header":"https://static001.geekbang.org/account/avatar/00/11/93/ea/071fa8bf.jpg","comment_is_top":false,"comment_ctime":1599100278,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"ServerSocketChannel的SO_RCVBUF是为了在accept创建Socket之时给Socket设置的参数,这个在哪设置的,找代码没找见","like_count":0},{"had_liked":false,"id":239837,"user_name":"易","can_delete":false,"product_type":"c3","uid":1996765,"ip_address":"","ucode":"D6CA82A57FEF02","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83ep74kPF5y5NnmKVH2N95W9RobhxkiacPhypTOHOmcNbRtiaokhr4bPacl5NtJib41RJqPCGvWZgibordw/132","comment_is_top":false,"comment_ctime":1596675350,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"对于参数而言，非理勿动，非理务视，非理务听\n\n没有理解不要乱动\n没有理解一定要多听多看多思考","like_count":0},{"had_liked":false,"id":233848,"user_name":"邶屿-","can_delete":false,"product_type":"c3","uid":1694997,"ip_address":"","ucode":"115B05D3834A6F","user_header":"https://static001.geekbang.org/account/avatar/00/19/dd/15/39722756.jpg","comment_is_top":false,"comment_ctime":1594476256,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"老师你好，我想问个问题。我现在的项目使用的是protobuf,想用ProtobufDecoder 来进行解码，但是我们使用了多个类型，如果一个一个写太麻烦了，有什么比较优雅的方式吗？\nch.pipeline().addLast(new LtyFrameDecoder());\n                            ch.pipeline().addLast(new LtyProtocolDecoder());\n                            ch.pipeline().addLast(new ProtobufDecoder(LtyProtoBuf.NetNeighbor.getDefaultInstance())); &#47;&#47; 这个位置\nLtyProtoBuf 下有许多协议\n                            ch.pipeline().addLast(new LtyClientHandler());","like_count":0}]}