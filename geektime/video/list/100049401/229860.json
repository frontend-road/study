{"id":229860,"title":"20 | 熔断：“秒杀”场景下的过载保护是如何实现的？","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/geektime-servicemesh\">https://gitee.com/geektime-geekbang/geektime-servicemesh</a></p>","comments":[{"had_liked":false,"id":298193,"user_name":"覃士林","can_delete":false,"product_type":"c3","uid":1245907,"ip_address":"","ucode":"821AEDB08BE14C","user_header":"https://static001.geekbang.org/account/avatar/00/13/02/d3/8fd2c1aa.jpg","comment_is_top":false,"comment_ctime":1623941051,"is_pvip":false,"replies":[{"id":108521,"content":"有，通过envoyfilter，具体见官方文档","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1624534826,"ip_address":"","comment_id":298193,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"限流功能会在istio后续版本添加进来吗","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":522050,"discussion_content":"有，通过envoyfilter，具体见官方文档","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1624534826,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":245462,"user_name":"Geek_66dcc6","can_delete":false,"product_type":"c3","uid":1317851,"ip_address":"","ucode":"0EC9C087C5008B","user_header":"","comment_is_top":false,"comment_ctime":1598949359,"is_pvip":false,"replies":[{"id":90293,"content":"看一下你的interval和ejectiontime设置的多少，如果比较短，假设只有10s，你两次操作之间超过了10s，那么熔断会进入半开状态。\n另外istio的熔断并不是标准意义上基于请求数的熔断，是有一定偏差的，官网熔断相关页面有说明：“It’s interesting to see that almost all requests made it through! The istio-proxy does allow for some leeway.”\n","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1598972075,"ip_address":"","comment_id":245462,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"关于连接错误次数，我有一个疑问，当consecuitiveErrors=1 时，代表有一个连续错误，就会触发熔断，当我使用“”kubectl  exec fortio-deploy-7cb865f87f-z4s69 -c fortio -- &#47;usr&#47;bin&#47;fortio load -c 3 -qps 0 -n 30 -loglevel Warning http:&#47;&#47;httpbin:8000&#47;get\n“” 命令时，有百分之三十以上的503 ，一定是有至少一个连续错误了。但是此时，我使用kubectl exec fortio-deploy-7cb865f87f-z4s69  -c fortio -- &#47;usr&#47;bin&#47;fortio curl -quiet http:&#47;&#47;httpbin:8000&#47;get\n单个访问请求，预期的结果是不是应该直接被拒绝，因为熔断被触发到了？我的访问仍然是200OK 的返回，想知道是不是我理解错了熔断机制。","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":504888,"discussion_content":"看一下你的interval和ejectiontime设置的多少，如果比较短，假设只有10s，你两次操作之间超过了10s，那么熔断会进入半开状态。\n另外istio的熔断并不是标准意义上基于请求数的熔断，是有一定偏差的，官网熔断相关页面有说明：“It’s interesting to see that almost all requests made it through! The istio-proxy does allow for some leeway.”\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598972075,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1317851,"avatar":"","nickname":"Geek_66dcc6","note":"","ucode":"0EC9C087C5008B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":302624,"discussion_content":"interval的的时间可以详细解释一下吗？不怎么理解","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598972319,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1069849,"avatar":"https://static001.geekbang.org/account/avatar/00/10/53/19/dec74631.jpg","nickname":"谢清","note":"","ucode":"31B2862A790CEB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1317851,"avatar":"","nickname":"Geek_66dcc6","note":"","ucode":"0EC9C087C5008B","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":380497,"discussion_content":"https://linlshare.gitbook.io/programming/cloud-native/istio 可以看看这个","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1624531393,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":302624,"ip_address":"","group_id":0},"score":380497,"extra":""}]}]},{"had_liked":false,"id":237743,"user_name":"Season","can_delete":false,"product_type":"c3","uid":1683622,"ip_address":"","ucode":"39D47A8211E48C","user_header":"https://static001.geekbang.org/account/avatar/00/19/b0/a6/fd99443c.jpg","comment_is_top":false,"comment_ctime":1595939925,"is_pvip":true,"replies":[{"id":88181,"content":"因为mixer被砍掉，限流功能暂时缺失，只支持连接数限制。不过可以直接通过envoy filter的方式引入，那样就不算是istio原生了","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1596280435,"ip_address":"","comment_id":237743,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"如何做限流呢？针对用户做限流，不是直接熔断服务","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":502524,"discussion_content":"因为mixer被砍掉，限流功能暂时缺失，只支持连接数限制。不过可以直接通过envoy filter的方式引入，那样就不算是istio原生了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596280435,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":235320,"user_name":"明仔君","can_delete":false,"product_type":"c3","uid":1004267,"ip_address":"","ucode":"CADFDD12FDCF7F","user_header":"https://static001.geekbang.org/account/avatar/00/0f/52/eb/7317c325.jpg","comment_is_top":false,"comment_ctime":1594973256,"is_pvip":false,"replies":[{"id":87116,"content":"优秀！","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1595235903,"ip_address":"","comment_id":235320,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"對於文末最後的思考題，應該至少需要考慮以下 2 點- \n1. 服務發現的實現 - 比如大家都熟悉的Eureka &#47; Consul, 用來提供統一的服務查詢中心\n2. 緩存和容錯 - 對於某些服務，出於業務的需求，即使出現熔斷之後也不能直接報錯，而是需要提供cache值來防止業務中斷.這個就需要服務之間的契約設計到位.\n\n歡迎指點交流.","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":501687,"discussion_content":"优秀！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595235903,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":217308,"user_name":"Jepsenwan","can_delete":false,"product_type":"c3","uid":1220569,"ip_address":"","ucode":"FEED052E0C10F5","user_header":"","comment_is_top":false,"comment_ctime":1589462309,"is_pvip":false,"replies":[{"id":80355,"content":"你进入envoy查看下日志里response_flags是什么值。还可以查一下pending的指标。看上去应该是触发了熔断，和配置有关。","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1589470663,"ip_address":"","comment_id":217308,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"创建Destination rule 和 fortio后，测试出现503，但是istio-system  ns里面的pod都正常。。\n\nkubectl exec -it $FORTIO_POD -c fortio -- &#47;usr&#47;bin&#47;fortio load -curl http:&#47;&#47;httpbin:8000&#47;get\n07:19:06 W http_client.go:679&gt; Parsed non ok code 503 (HTTP&#47;1.1 503)\nHTTP&#47;1.1 503 Service Unavailable\ncontent-length: 19\ncontent-type: text&#47;plain\ndate: Thu, 14 May 2020 07:19:06 GMT\nserver: envoy\n\nno healthy upstream07:19:06 E commonflags.go:130&gt; Error status 503 : HTTP&#47;1.1 503 Service Unavailable\\r\\ncontent-length: 19\\r\\ncontent-type: text&#47;plain\\r\\ndate: Thu, 14 May 2020 07:19:06 GMT\\r\\nserver: envoy\\r\\n\\r\\nno healthy upstream\ncommand terminated with exit code 1\n","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":495106,"discussion_content":"你进入envoy查看下日志里response_flags是什么值。还可以查一下pending的指标。看上去应该是触发了熔断，和配置有关。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589470663,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":213743,"user_name":"zzZZ","can_delete":false,"product_type":"c3","uid":1061388,"ip_address":"","ucode":"BB247CCB3A7350","user_header":"https://static001.geekbang.org/account/avatar/00/10/32/0c/24424172.jpg","comment_is_top":false,"comment_ctime":1588548514,"is_pvip":false,"replies":[{"id":79330,"content":"看看什么错误输出。加上 -- 是标准写法。","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1588694272,"ip_address":"","comment_id":213743,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"FORTIO_POD=$(kubectl get pod | grep fortio | awk &#39;{ print $1 }&#39;)\nkubectl exec -it $FORTIO_POD  -c fortio &#47;usr&#47;bin&#47;fortio -- load -curl  http:&#47;&#47;httpbin:8000&#47;get\n\n不知道是不是我的 kubectl 版本太高了，必须这样执行才能正常：kubectl exec -it $FORTIO_POD  -c fortio -- &#47;usr&#47;bin&#47;fortio load -curl  http:&#47;&#47;httpbin:8000&#47;get\n\n才能正常。\n\nClient Version: version.Info{Major:&quot;1&quot;, Minor:&quot;18&quot;, GitVersion:&quot;v1.18.1&quot;, GitCommit:&quot;7879fc12a63337efff607952a323df90cdc7a335&quot;, GitTreeState:&quot;clean&quot;, BuildDate:&quot;2020-04-15T01:55:22Z&quot;, GoVersion:&quot;go1.14.2&quot;, Compiler:&quot;gc&quot;, Platform:&quot;darwin&#47;amd64&quot;}\nServer Version: version.Info{Major:&quot;1&quot;, Minor:&quot;15&quot;, GitVersion:&quot;v1.15.5&quot;, GitCommit:&quot;20c265fef0741dd71a66480e35bd69f18351daea&quot;, GitTreeState:&quot;clean&quot;, BuildDate:&quot;2019-10-15T19:07:57Z&quot;, GoVersion:&quot;go1.12.10&quot;, Compiler:&quot;gc&quot;, Platform:&quot;linux&#47;amd64&quot;}\n","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493859,"discussion_content":"看看什么错误输出。加上 -- 是标准写法。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588694272,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":244818,"user_name":"上天的恩赐","can_delete":false,"product_type":"c3","uid":1365413,"ip_address":"","ucode":"A42B43AB342160","user_header":"https://static001.geekbang.org/account/avatar/00/14/d5/a5/88f722cd.jpg","comment_is_top":false,"comment_ctime":1598689892,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"20 熔断，视频中是 kubectl exec -it fortio-deploy-6dc9b4d7d9-xc9x5  -c fortio &#47;usr&#47;bin&#47;fortio -- load -curl  http:&#47;&#47;httpbin:8000&#47;get \n正确的应该是：\nkubectl exec -it fortio-deploy-6dc9b4d7d9-xc9x5  -c fortio -- &#47;usr&#47;bin&#47;fortio load -curl  http:&#47;&#47;httpbin:8000&#47;get\n这里的 “--”，应该在contrainer后面","like_count":6},{"had_liked":false,"id":341998,"user_name":"仗剑走天涯","can_delete":false,"product_type":"c3","uid":2672548,"ip_address":"","ucode":"A2AE89C898812C","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q3auHgzwzM515NwYnQ3H0K1yiaGYO4JDyKenLTtzXDUEGTBGQzES4X5y1F17ibj67TR7wQ37FwiajzoiaoUtibJTVqA/132","comment_is_top":false,"comment_ctime":1649946340,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"kubectl exec -it $FORTIO_POD  -c fortio &#47;usr&#47;bin&#47;fortio -- load -curl  http:&#47;&#47;httpbin:8000&#47;get\n运行后显示\nOCI runtime exec failed: exec failed: container_linux.go:348: starting container process caused &quot;exec: \\&quot;load\\&quot;: executable file not found in $PATH&quot;: unknown\ncommand terminated with exit code 126\n是什么问题呀 谢谢老师","like_count":0,"discussions":[{"author":{"id":3070455,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eo7GV7aAc9ow1xXUibbve0sCOThyEbraPg1ia3JNYF1PApprr1Tn2tYibhLAVvF8Q1N2Zv1HQz4ZKAjw/132","nickname":"Geek_398fa0","note":"","ucode":"99859234369909","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":584722,"discussion_content":"kubectl exec -it $FORTIO_POD  -c fortio -- /usr/bin/fortio load -curl  http://httpbin:8000/get","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661065196,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}