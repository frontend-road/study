{"id":411663,"title":"40 | è½¯ä»¶éƒ¨ç½²å®æˆ˜ï¼ˆä¸Šï¼‰ï¼šéƒ¨ç½²æ–¹æ¡ˆåŠè´Ÿè½½å‡è¡¡ã€é«˜å¯ç”¨ç»„ä»¶ä»‹ç»","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å­”ä»¤é£ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±è¿›å…¥åˆ°è¿™é—¨è¯¾çš„æœ€åä¸€ä¸ªæ¨¡å—ï¼ŒæœåŠ¡éƒ¨ç½²éƒ¨åˆ†çš„å­¦ä¹ ã€‚åœ¨è¿™ä¸€æ¨¡å—ä¸­ï¼Œæˆ‘ä¼šå¸¦ç€ä½ ä¸€æ­¥ä¸€æ­¥åœ°éƒ¨ç½²ä¸€ä¸ªç”Ÿäº§çº§å¯ç”¨çš„IAMåº”ç”¨ã€‚</p><p>åœ¨ <a href=\"https://time.geekbang.org/column/article/378082\">03è®²</a> ä¸­ï¼Œæˆ‘ä»¬å¿«é€Ÿåœ¨å•æœºä¸Šéƒ¨ç½²äº†IAMç³»ç»Ÿï¼Œä½†è¿™æ ·çš„ç³»ç»Ÿç¼ºå°‘é«˜å¯ç”¨ã€å¼¹æ€§æ‰©å®¹ç­‰èƒ½åŠ›ï¼Œæ˜¯å¾ˆè„†å¼±çš„ï¼Œé‡åˆ°æµé‡æ³¢å³°ã€å‘å¸ƒå˜æ›´å¾ˆå®¹æ˜“å‡ºé—®é¢˜ã€‚åœ¨ç³»ç»ŸçœŸæ­£ä¸Šçº¿å‰ï¼Œæˆ‘ä»¬éœ€è¦é‡æ–°è°ƒæ•´éƒ¨ç½²æ¶æ„ï¼Œæ¥ä¿è¯æˆ‘ä»¬çš„ç³»ç»Ÿå…·æœ‰è´Ÿè½½å‡è¡¡ã€é«˜å¯ç”¨ã€å¼¹æ€§ä¼¸ç¼©ç­‰æ ¸å¿ƒè¿ç»´èƒ½åŠ›ã€‚</p><p>è€ƒè™‘åˆ°ä½ æ‰‹ä¸­çš„ç³»ç»Ÿèµ„æºæœ‰é™ï¼Œè¿™ä¸€æ¨¡å—ä¼šå°½é‡ç®€å•åœ°å±•ç¤ºå¦‚ä½•éƒ¨ç½²ä¸€ä¸ªç›¸å¯¹é«˜å¯ç”¨çš„IAMç³»ç»Ÿã€‚æŒ‰ç…§æˆ‘è®²çš„éƒ¨ç½²æ–¹æ³•ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥ä¸Šçº¿ä¸€ä¸ªä¸­å°å‹çš„ç³»ç»Ÿã€‚</p><p>åœ¨è¿™ä¸€æ¨¡å—ä¸­ï¼Œæˆ‘ä¼šä»‹ç»ä¸¤ç§éƒ¨ç½²æ–¹å¼ã€‚</p><p>ç¬¬ä¸€ç§æ˜¯ä¼ ç»Ÿçš„éƒ¨ç½²æ–¹å¼ï¼ŒåŸºäºç‰©ç†æœº/è™šæ‹Ÿæœºæ¥éƒ¨ç½²ï¼Œå®¹ç¾ã€å¼¹æ€§ä¼¸ç¼©èƒ½åŠ›è¦éƒ¨ç½²äººå‘˜è‡ªå·±å®ç°ã€‚ç¬¬äºŒç§æ˜¯å®¹å™¨åŒ–éƒ¨ç½²æ–¹å¼ï¼ŒåŸºäºDockerã€Kubernetesæ¥éƒ¨ç½²ï¼Œå®¹ç¾ã€å¼¹æ€§ä¼¸ç¼©ç­‰èƒ½åŠ›ï¼Œå¯ä»¥å€ŸåŠ©Kubernetesè‡ªå¸¦çš„èƒ½åŠ›æ¥å®ç°ã€‚</p><p>æ¥ä¸‹æ¥çš„ä¸‰è®²ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ä¼ ç»Ÿçš„éƒ¨ç½²æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯å¦‚ä½•åŸºäºè™šæ‹Ÿæœºæ¥éƒ¨ç½²IAMåº”ç”¨ã€‚ä»Šå¤©æˆ‘ä¸»è¦è®²è·ŸIAMéƒ¨ç½²ç›¸å…³çš„ä¸¤ä¸ªç»„ä»¶ï¼ŒNginx + Keepalivedçš„ç›¸å…³åŠŸèƒ½ã€‚</p><h2>éƒ¨ç½²æ–¹æ¡ˆ</h2><p>å…ˆæ¥æ•´ä½“çœ‹ä¸‹æˆ‘ä»¬çš„éƒ¨ç½²æ–¹æ¡ˆã€‚</p><p>è¿™é‡Œï¼Œæˆ‘é‡‡ç”¨Nginx + Keepalivedæ¥éƒ¨ç½²ä¸€ä¸ªé«˜å¯ç”¨çš„æ¶æ„ï¼ŒåŒæ—¶å°†ç»„ä»¶éƒ½éƒ¨ç½²åœ¨å†…ç½‘ï¼Œæ¥ä¿è¯æœåŠ¡çš„å®‰å…¨å’Œæ€§èƒ½ã€‚</p><!-- [[[read_end]]] --><p>éƒ¨ç½²éœ€è¦ä¸¤å°ç‰©ç†æœº/è™šæ‹Ÿæœºï¼Œç»„ä»¶ä¹‹é—´é€šè¿‡å†…ç½‘è®¿é—®ã€‚æ‰€éœ€çš„æœåŠ¡å™¨å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/e0/1d/e0a3323831768fbe7f45085ca4a53a1d.jpg?wh=1920x719\" alt=\"å›¾ç‰‡\"></p><p>ä¸¤å°æœåŠ¡å™¨å‡ä¸ºè…¾è®¯äº‘CVMï¼ŒVIPï¼ˆVirtual IPï¼Œè™šæ‹ŸIPï¼‰ä¸º<code>10.0.4.99</code>ã€‚éƒ¨ç½²æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/fc/9d/fc5331a780d45a7de6223d6ff3c86f9d.jpg?wh=1920x1197\" alt=\"å›¾ç‰‡\"></p><p>è¿™é‡Œæˆ‘æ¥å…·ä½“ä»‹ç»ä¸‹å›¾ä¸­çš„éƒ¨ç½²æ¶æ„ã€‚éƒ¨ç½²é‡‡ç”¨çš„è¿™ä¸¤å°CVMæœåŠ¡å™¨ï¼Œä¸€ä¸»ä¸€å¤‡ï¼Œå®ƒä»¬å…±äº«åŒä¸€ä¸ªVIPã€‚åŒä¸€æ—¶åˆ»ï¼ŒVIPåªåœ¨ä¸€å°ä¸»è®¾å¤‡ä¸Šç”Ÿæ•ˆï¼Œå½“ä¸»æœåŠ¡å™¨å‡ºç°æ•…éšœæ—¶ï¼Œå¤‡ç”¨æœåŠ¡å™¨ä¼šè‡ªåŠ¨æ¥ç®¡VIPï¼Œç»§ç»­æä¾›æœåŠ¡ã€‚</p><p>ä¸»æœåŠ¡å™¨ä¸Šéƒ¨ç½²äº†<code>iam-apiserver</code>ã€<code>iam-authz-server</code>ã€<code>iam-pump</code>å’Œæ•°æ®åº“<code>mongodb</code>ã€<code>redis</code>ã€<code>mysql</code>ã€‚å¤‡æœåŠ¡å™¨éƒ¨ç½²äº†<code>iam-apiserver</code>ã€<code>iam-authz-server</code>å’Œ<code>iam-pump</code>ã€‚å¤‡æœåŠ¡å™¨ä¸­çš„ç»„ä»¶é€šè¿‡å†…ç½‘<code>10.0.4.20</code>è®¿é—®ä¸»æœåŠ¡å™¨ä¸­çš„æ•°æ®åº“ç»„ä»¶ã€‚</p><p>ä¸»å¤‡æœåŠ¡å™¨åŒæ—¶å®‰è£…äº†Keepalivedå’ŒNginxï¼Œé€šè¿‡Nginxçš„åå‘ä»£ç†åŠŸèƒ½å’Œè´Ÿè½½å‡è¡¡åŠŸèƒ½ï¼Œå®ç°åç«¯æœåŠ¡<code>iam-apiserver</code>å’Œ<code>iam-authz-server</code>çš„é«˜å¯ç”¨ï¼Œé€šè¿‡Keepalivedå®ç°Nginxçš„é«˜å¯ç”¨ã€‚</p><p>æˆ‘ä»¬é€šè¿‡ç»™è™šæ‹ŸIPç»‘å®šè…¾è®¯äº‘å¼¹æ€§å…¬ç½‘IPï¼Œä»è€Œä½¿å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡å¤–ç½‘IPè®¿é—®å†…ç½‘çš„NginxæœåŠ¡å™¨ï¼ˆ<code>443</code>ç«¯å£ï¼‰ï¼Œå¦‚æœæƒ³é€šè¿‡åŸŸåè®¿é—®å†…ç½‘ï¼Œè¿˜å¯ä»¥ç”³è¯·åŸŸåæŒ‡å‘è¯¥å¼¹æ€§å…¬ç½‘IPã€‚</p><p>é€šè¿‡ä»¥ä¸Šéƒ¨ç½²æ–¹æ¡ˆï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ä¸€ä¸ªå…·æœ‰è¾ƒé«˜å¯ç”¨æ€§çš„IAMç³»ç»Ÿï¼Œå®ƒä¸»è¦å…·å¤‡ä¸‹é¢è¿™å‡ ä¸ªèƒ½åŠ›ã€‚</p><ul>\n<li>é«˜æ€§èƒ½ï¼šå¯ä»¥é€šè¿‡Nginxçš„è´Ÿè½½å‡è¡¡åŠŸèƒ½ï¼Œæ°´å¹³æ‰©å®¹IAMæœåŠ¡ï¼Œä»è€Œå®ç°é«˜æ€§èƒ½ã€‚</li>\n<li>å…·å¤‡å®¹ç¾èƒ½åŠ›ï¼šé€šè¿‡Nginxå®ç°IAMæœåŠ¡çš„é«˜å¯ç”¨ï¼Œé€šè¿‡Keepalivedå®ç°Nginxçš„é«˜å¯ç”¨ï¼Œä»è€Œå®ç°æ ¸å¿ƒç»„ä»¶çš„é«˜å¯ç”¨ã€‚</li>\n<li>å…·å¤‡æ°´å¹³æ‰©å®¹èƒ½åŠ›ï¼šé€šè¿‡Nginxçš„è´Ÿè½½å‡è¡¡åŠŸèƒ½ï¼Œå®ç°IAMæœåŠ¡çš„æ°´å¹³æ‰©å®¹ã€‚</li>\n<li>é«˜å®‰å…¨æ€§ï¼šå°†æ‰€æœ‰ç»„ä»¶éƒ¨ç½²åœ¨å†…ç½‘ï¼Œå®¢æˆ·ç«¯åªèƒ½é€šè¿‡<code>VIP:443</code>ç«¯å£è®¿é—®NginxæœåŠ¡ï¼Œå¹¶ä¸”é€šè¿‡å¼€å¯TLSè®¤è¯å’ŒJWTè®¤è¯ï¼Œä¿éšœæœåŠ¡æœ‰ä¸€ä¸ªæ¯”è¾ƒé«˜çš„å®‰å…¨æ€§ã€‚å› ä¸ºæ˜¯è…¾è®¯äº‘CVMï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥å€ŸåŠ©è…¾è®¯äº‘çš„èƒ½åŠ›å†æ¬¡æé«˜æœåŠ¡å™¨çš„å®‰å…¨æ€§ï¼Œæ¯”å¦‚å®‰å…¨ç»„ã€DDoSé˜²æŠ¤ã€ä¸»æœºå®‰å…¨é˜²æŠ¤ã€äº‘ç›‘æ§ã€äº‘é˜²ç«å¢™ç­‰ã€‚</li>\n</ul><p>è¿™é‡Œè¯´æ˜ä¸‹ï¼Œä¸ºäº†ç®€åŒ–IAMåº”ç”¨çš„å®‰è£…é…ç½®è¿‡ç¨‹ï¼Œæ–¹ä¾¿ä½ ä¸Šæ‰‹å®æ“ï¼Œæœ‰äº›èƒ½åŠ›ï¼Œä¾‹å¦‚æ•°æ®åº“é«˜å¯ç”¨ã€è¿›ç¨‹ç›‘æ§å’Œå‘Šè­¦ã€è‡ªåŠ¨ä¼¸ç¼©ç­‰èƒ½åŠ›çš„æ„å»ºæ–¹å¼ï¼Œè¿™é‡Œæ²¡æœ‰æ¶‰åŠåˆ°ã€‚è¿™äº›èƒ½åŠ›çš„æ„å»ºæ–¹å¼ï¼Œä½ å¯ä»¥åœ¨æ—¥åçš„å·¥ä½œä¸­æ…¢æ…¢å­¦ä¹ å’ŒæŒæ¡ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹ä¸‹è¿™ä¸ªéƒ¨ç½²æ–¹æ¡ˆä¸­ç”¨åˆ°çš„ä¸¤ä¸ªæ ¸å¿ƒç»„ä»¶ï¼ŒNginxå’ŒKeepalivedã€‚æˆ‘ä¼šä»‹ç»ä¸‹å®ƒä»¬çš„å®‰è£…å’Œé…ç½®æ–¹æ³•ï¼Œä¸ºä½ ä¸‹ä¸€è®²çš„å­¦ä¹ åšå‡†å¤‡ã€‚</p><h2>Nginxå®‰è£…å’Œé…ç½®</h2><h3>NginxåŠŸèƒ½ç®€ä»‹</h3><p>è¿™é‡Œå…ˆç®€å•ä»‹ç»ä¸‹Nginxã€‚Nginxæ˜¯ä¸€ä¸ªè½»é‡çº§ã€é«˜æ€§èƒ½ã€å¼€æºçš„HTTPæœåŠ¡å™¨å’Œåå‘ä»£ç†æœåŠ¡å™¨ã€‚IAMç³»ç»Ÿä½¿ç”¨äº†Nginxåå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡çš„åŠŸèƒ½ï¼Œä¸‹é¢æˆ‘å°±æ¥åˆ†åˆ«ä»‹ç»ä¸‹ã€‚</p><p>ä¸ºä»€ä¹ˆéœ€è¦åå‘ä»£ç†å‘¢ï¼Ÿåœ¨å®é™…çš„ç”Ÿäº§ç¯å¢ƒä¸­ï¼ŒæœåŠ¡éƒ¨ç½²çš„ç½‘ç»œï¼ˆå†…ç½‘ï¼‰è·Ÿå¤–éƒ¨ç½‘ç»œï¼ˆå¤–ç½‘ï¼‰é€šå¸¸æ˜¯ä¸é€šçš„ï¼Œè¿™å°±éœ€è¦ä¸€å°æ—¢èƒ½å¤Ÿè®¿é—®å†…ç½‘åˆèƒ½å¤Ÿè®¿é—®å¤–ç½‘çš„æœåŠ¡å™¨æ¥åšä¸­è½¬ï¼Œè¿™ç§æœåŠ¡å™¨å°±æ˜¯åå‘ä»£ç†æœåŠ¡å™¨ã€‚Nginxä½œä¸ºåå‘ä»£ç†æœåŠ¡å™¨ï¼Œç®€å•çš„é…ç½®å¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">server {\n&nbsp; &nbsp; listen&nbsp; &nbsp; &nbsp; 80;\n&nbsp; &nbsp; server_name&nbsp; iam.marmotedu.com;\n&nbsp; &nbsp; client_max_body_size 1024M;\n\n&nbsp; &nbsp; location / {\n&nbsp; &nbsp; &nbsp; &nbsp; proxy_set_header Host $http_host;\n&nbsp; &nbsp; &nbsp; &nbsp; proxy_set_header X-Forwarded-Host $http_host;\n&nbsp; &nbsp; &nbsp; &nbsp; proxy_set_header X-Real-IP $remote_addr;\n&nbsp; &nbsp; &nbsp; &nbsp; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n&nbsp; &nbsp; &nbsp; &nbsp; proxy_pass&nbsp; http://127.0.0.1:8080/;\n&nbsp; &nbsp; &nbsp; &nbsp; client_max_body_size 100m;\n&nbsp; &nbsp; }\n}\n</code></pre><p>Nginxçš„åå‘ä»£ç†åŠŸèƒ½ï¼Œèƒ½å¤Ÿæ ¹æ®ä¸åŒçš„é…ç½®è§„åˆ™è½¬å‘åˆ°ä¸åŒçš„åç«¯æœåŠ¡å™¨ä¸Šã€‚å‡å¦‚æˆ‘ä»¬åœ¨IPä¸º<code>x.x.x.x</code>çš„æœåŠ¡å™¨ä¸Šï¼Œç”¨ä¸Šé¢è¯´çš„Nginxé…ç½®å¯åŠ¨Nginxï¼Œå½“æˆ‘ä»¬è®¿é—®<code>http://x.x.x.x:80/</code>æ—¶ï¼Œä¼šå°†è¯·æ±‚è½¬å‘åˆ°<code>http://127.0.0.1:8080/</code>ã€‚<code>listen      80</code>æŒ‡å®šäº†NginxæœåŠ¡å™¨çš„ç›‘å¬ç«¯å£ï¼Œ<code>proxy_pass  http://127.0.0.1:8080/</code>åˆ™æŒ‡å®šäº†è½¬å‘è·¯å¾„ã€‚</p><p>Nginxå¦ä¸€ä¸ªå¸¸ç”¨çš„åŠŸèƒ½æ˜¯ä¸ƒå±‚è´Ÿè½½å‡è¡¡ã€‚æ‰€è°“çš„è´Ÿè½½å‡è¡¡ï¼Œå°±æ˜¯æŒ‡å½“Nginxæ”¶åˆ°ä¸€ä¸ªHTTPè¯·æ±‚åï¼Œä¼šæ ¹æ®è´Ÿè½½ç­–ç•¥å°†è¯·æ±‚è½¬å‘åˆ°ä¸åŒçš„åç«¯æœåŠ¡å™¨ä¸Šã€‚æ¯”å¦‚iam-apiserveréƒ¨ç½²åœ¨ä¸¤å°æœåŠ¡å™¨Aå’ŒBä¸Šï¼Œå½“è¯·æ±‚åˆ°è¾¾Nginxåï¼ŒNginxä¼šæ ¹æ®Aå’ŒBæœåŠ¡å™¨ä¸Šçš„è´Ÿè½½æƒ…å†µï¼Œå°†è¯·æ±‚è½¬å‘åˆ°è´Ÿè½½è¾ƒå°çš„é‚£å°æœåŠ¡å™¨ä¸Šã€‚</p><p>è¿™é‡Œè¦æ±‚iam-apiserveræ˜¯æ— çŠ¶æ€çš„æœåŠ¡ã€‚Nginxæœ‰å¤šç§è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œå¯ä»¥æ»¡è¶³ä¸åŒåœºæ™¯ä¸‹çš„è´Ÿè½½å‡è¡¡éœ€æ±‚ã€‚</p><h3><strong>Nginxå®‰è£…æ­¥éª¤</strong></h3><p>æ¥ä¸‹æ¥ï¼Œæˆ‘å°±æ¥ä»‹ç»ä¸‹å¦‚ä½•å®‰è£…å’Œé…ç½®Nginxã€‚</p><p>æˆ‘ä»¬åˆ†åˆ«åœ¨<code>10.0.4.20</code>å’Œ<code>10.0.4.21</code>æœåŠ¡å™¨ä¸Šæ‰§è¡Œå¦‚ä¸‹æ­¥éª¤ï¼Œå®‰è£…Nginxã€‚</p><p>åœ¨CentOS 8.xç³»ç»Ÿä¸Šï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨yumå‘½ä»¤æ¥å®‰è£…ï¼Œå…·ä½“å®‰è£…è¿‡ç¨‹å¯ä»¥åˆ†ä¸ºä¸‹é¢4ä¸ªæ­¥éª¤ã€‚</p><p>ç¬¬ä¸€æ­¥ï¼Œå®‰è£…Nginxï¼š</p><pre><code class=\"language-bash\">$ sudo yum -y install nginx\n</code></pre><p>ç¬¬äºŒæ­¥ï¼Œç¡®è®¤Nginxå®‰è£…æˆåŠŸï¼š</p><pre><code class=\"language-bash\">$ nginx -v\nnginx version: nginx/1.14.1\n</code></pre><p>ç¬¬ä¸‰æ­¥ï¼Œå¯åŠ¨Nginxï¼Œå¹¶è®¾ç½®å¼€æœºå¯åŠ¨ï¼š</p><pre><code class=\"language-bash\">$ sudo systemctl start nginx\n$ sudo systemctl enable nginx\n</code></pre><p>Nginxé»˜è®¤ç›‘å¬<code>80</code>ç«¯å£ï¼Œå¯åŠ¨Nginxå‰è¦ç¡®ä¿<code>80</code>ç«¯å£æ²¡æœ‰è¢«å ç”¨ã€‚å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥é€šè¿‡ä¿®æ”¹Nginxé…ç½®æ–‡ä»¶<code>/etc/nginx/nginx.conf</code>ä¿®æ”¹Nginxç›‘å¬ç«¯å£ã€‚</p><p>ç¬¬å››æ­¥ï¼ŒæŸ¥çœ‹Nginxå¯åŠ¨çŠ¶æ€ï¼š</p><pre><code class=\"language-bash\">$ systemctl status nginx\n</code></pre><p>è¾“å‡ºä¸­æœ‰<code>active (running)</code>å­—ç¬¦ä¸²ï¼Œè¯´æ˜æˆåŠŸå¯åŠ¨ã€‚å¦‚æœNginxå¯åŠ¨å¤±è´¥ï¼Œä½ å¯ä»¥æŸ¥çœ‹<code>/var/log/nginx/error.log</code>æ—¥å¿—æ–‡ä»¶ï¼Œå®šä½é”™è¯¯åŸå› ã€‚</p><h2>Keepalivedå®‰è£…å’Œé…ç½®</h2><p>Nginxè‡ªå¸¦è´Ÿè½½å‡è¡¡åŠŸèƒ½ï¼Œå¹¶ä¸”å½“Nginxåç«¯æŸä¸ªæœåŠ¡å™¨æ•…éšœåï¼ŒNginxä¼šè‡ªåŠ¨å‰”é™¤è¯¥æœåŠ¡å™¨ï¼Œå°†è¯·æ±‚è½¬å‘åˆ°å¯ç”¨çš„æœåŠ¡å™¨ï¼Œé€šè¿‡è¿™ç§æ–¹å¼å®ç°åç«¯APIæœåŠ¡çš„é«˜å¯ç”¨ã€‚ä½†æ˜¯ Nginxæ˜¯å•ç‚¹çš„ï¼Œå¦‚æœNginxæŒ‚äº†ï¼Œåç«¯çš„æ‰€æœ‰æœåŠ¡å™¨å°±éƒ½ä¸èƒ½è®¿é—®ï¼Œæ‰€ä»¥åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä¹Ÿéœ€è¦å¯¹Nginxåšé«˜å¯ç”¨ã€‚</p><p>ä¸šç•Œæœ€æ™®éé‡‡ç”¨çš„æ–¹æ³•æ˜¯é€šè¿‡Keepalivedå¯¹å‰ç«¯Nginxå®ç°é«˜å¯ç”¨ã€‚Keepalived + Nginxçš„é«˜å¯ç”¨æ–¹æ¡ˆå…·æœ‰æœåŠ¡åŠŸèƒ½å¼ºå¤§ã€ç»´æŠ¤ç®€å•ç­‰ç‰¹ç‚¹ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹å¦‚ä½•å®‰è£…å’Œé…ç½®Keepalivedã€‚</p><h3>Keepalivedå®‰è£…æ­¥éª¤</h3><p>æˆ‘ä»¬åˆ†åˆ«åœ¨<code>10.0.4.20</code>å’Œ<code>10.0.4.21</code>æœåŠ¡å™¨ä¸Šæ‰§è¡Œä¸‹é¢5ä¸ªæ­¥éª¤ï¼Œå®‰è£…Keepalivedã€‚</p><p>ç¬¬ä¸€æ­¥ï¼Œä¸‹è½½Keepalivedçš„æœ€æ–°ç‰ˆæœ¬ï¼ˆè¿™é—¨è¯¾å®‰è£…äº†å½“å‰çš„æœ€æ–°ç‰ˆæœ¬ <code>2.1.5</code>ï¼‰ï¼š</p><pre><code class=\"language-bash\">$ wget https://www.keepalived.org/software/keepalived-2.1.5.tar.gz\n</code></pre><p>ç¬¬äºŒæ­¥ï¼Œå®‰è£…Keepalivedï¼š</p><pre><code class=\"language-bash\">$ sudo yum -y install openssl-devel # keepalivedä¾èµ–OpenSSLï¼Œå…ˆå®‰è£…ä¾èµ–\n$ tar -xvzf keepalived-2.1.5.tar.gz\n$ cd keepalived-2.1.5\n$ ./configure --prefix=/usr/local/keepalived\n$ make\n$ sudo make install\n</code></pre><p>ç¬¬ä¸‰æ­¥ï¼Œé…ç½®Keepalivedï¼š</p><pre><code class=\"language-bash\">$ sudo mkdir /etc/keepalived # å®‰è£…åï¼Œé»˜è®¤æ²¡æœ‰åˆ›å»º/etc/keepalivedç›®å½•\n$ sudo cp /usr/local/keepalived/etc/keepalived/keepalived.conf  /etc/keepalived/keepalived.conf\n$ sudo cp /usr/local/keepalived/etc/sysconfig/keepalived /etc/sysconfig/keepalived\n</code></pre><p>Keepalivedçš„systemd uinté…ç½®ï¼Œé»˜è®¤ä½¿ç”¨äº†<code>/usr/local/keepalived/etc/sysconfig/keepalived</code>ä½œä¸ºå…¶<code>EnvironmentFile</code>ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æŠŠå®ƒä¿®æ”¹ä¸º<code>/etc/sysconfig/keepalived</code>æ–‡ä»¶ã€‚ç¼–è¾‘<code>/lib/systemd/system/keepalived.service</code>æ–‡ä»¶ï¼Œè®¾ç½®<code>EnvironmentFile</code>ï¼Œå€¼å¦‚ä¸‹ï¼š</p><pre><code class=\"language-bash\">EnvironmentFile=-/etc/sysconfig/keepalived\n</code></pre><p>ç¬¬å››æ­¥ï¼Œå¯åŠ¨Keepalivedï¼Œå¹¶è®¾ç½®å¼€æœºå¯åŠ¨ï¼š</p><pre><code class=\"language-bash\">$ sudo systemctl start keepalived\n$ sudo systemctl enable keepalived\n</code></pre><p>è¿™é‡Œè¦æ³¨æ„ï¼ŒKeepalivedå¯åŠ¨æ—¶ä¸ä¼šæ ¡éªŒé…ç½®æ–‡ä»¶æ˜¯å¦æ­£ç¡®ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å°å¿ƒä¿®æ”¹é…ç½®ï¼Œé˜²æ­¢å‡ºç°æ„æƒ³ä¸åˆ°çš„é—®é¢˜ã€‚</p><p>ç¬¬äº”æ­¥ï¼ŒæŸ¥çœ‹Keepalivedçš„å¯åŠ¨çŠ¶æ€ï¼š</p><pre><code class=\"language-bash\">$ systemctl status keepalived\n</code></pre><p>è¾“å‡ºä¸­æœ‰<code>active (running)</code>å­—ç¬¦ä¸²ï¼Œè¯´æ˜æˆåŠŸå¯åŠ¨ã€‚Keepalivedçš„æ—¥å¿—ä¿å­˜åœ¨<code>/var/log/messages</code>ä¸­ï¼Œä½ æœ‰éœ€è¦çš„è¯å¯ä»¥æŸ¥çœ‹ã€‚</p><h3>Keepalivedé…ç½®æ–‡ä»¶è§£æ</h3><p>Keepalivedçš„é»˜è®¤é…ç½®æ–‡ä»¶ä¸º<code>/etc/keepalived/keepalived.conf</code>ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªKeepalivedé…ç½®ï¼š</p><pre><code class=\"language-plain\"># å…¨å±€å®šä¹‰ï¼Œå®šä¹‰å…¨å±€çš„é…ç½®é€‰é¡¹\nglobal_defs {\n# æŒ‡å®škeepalivedåœ¨å‘ç”Ÿåˆ‡æ¢æ“ä½œæ—¶å‘é€emailï¼Œå‘é€ç»™å“ªäº›email\n# å»ºè®®åœ¨keepalived_notify.shä¸­å‘é€é‚®ä»¶\n&nbsp; notification_email {\n&nbsp; &nbsp; acassen@firewall.loc\n&nbsp; }\n&nbsp; notification_email_from Alexandre.Cassen@firewall.loc # å‘é€emailæ—¶é‚®ä»¶æºåœ°å€\n&nbsp; &nbsp; smtp_server 192.168.200.1 # å‘é€emailæ—¶smtpæœåŠ¡å™¨åœ°å€\n&nbsp; &nbsp; smtp_connect_timeout 30 # è¿æ¥smtpçš„è¶…æ—¶æ—¶é—´\n&nbsp; &nbsp; router_id VM-4-21-centos # æœºå™¨æ ‡è¯†ï¼Œé€šå¸¸å¯ä»¥è®¾ç½®ä¸ºhostname\n&nbsp; &nbsp; vrrp_skip_check_adv_addr # å¦‚æœæ¥æ”¶åˆ°çš„æŠ¥æ–‡å’Œä¸Šä¸€ä¸ªæŠ¥æ–‡æ¥è‡ªåŒä¸€ä¸ªè·¯ç”±å™¨ï¼Œåˆ™ä¸æ‰§è¡Œæ£€æŸ¥ã€‚é»˜è®¤æ˜¯è·³è¿‡æ£€æŸ¥\n&nbsp; &nbsp; vrrp_garp_interval 0 # å•ä½ç§’ï¼Œåœ¨ä¸€ä¸ªç½‘å¡ä¸Šæ¯ç»„gratuitous arpæ¶ˆæ¯ä¹‹é—´çš„å»¶è¿Ÿæ—¶é—´ï¼Œé»˜è®¤ä¸º0\n&nbsp; &nbsp; vrrp_gna_interval 0 # å•ä½ç§’ï¼Œåœ¨ä¸€ä¸ªç½‘å¡ä¸Šæ¯ç»„naæ¶ˆæ¯ä¹‹é—´çš„å»¶è¿Ÿæ—¶é—´ï¼Œé»˜è®¤ä¸º0\n}\n# æ£€æµ‹è„šæœ¬é…ç½®\nvrrp_script checkhaproxy\n{\n&nbsp; script \"/etc/keepalived/check_nginx.sh\" # æ£€æµ‹è„šæœ¬è·¯å¾„\n&nbsp; &nbsp; interval 5 # æ£€æµ‹æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰\n&nbsp; &nbsp; weight 0 # æ ¹æ®è¯¥æƒé‡æ”¹å˜priorityï¼Œå½“å€¼ä¸º0æ—¶ï¼Œä¸æ”¹å˜å®ä¾‹çš„ä¼˜å…ˆçº§\n}\n# VRRPå®ä¾‹é…ç½®\nvrrp_instance VI_1 {\n&nbsp; state BACKUP&nbsp; # è®¾ç½®åˆå§‹çŠ¶æ€ä¸º'å¤‡ä»½'\n&nbsp; &nbsp; interface eth0 # è®¾ç½®ç»‘å®šVIPçš„ç½‘å¡ï¼Œä¾‹å¦‚eth0\n&nbsp; &nbsp; virtual_router_id 51&nbsp; # é…ç½®é›†ç¾¤VRIDï¼Œäº’ä¸ºä¸»å¤‡çš„VRIDéœ€è¦æ˜¯ç›¸åŒçš„å€¼\n&nbsp; &nbsp; nopreempt&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# è®¾ç½®éæŠ¢å æ¨¡å¼ï¼Œåªèƒ½è®¾ç½®åœ¨stateä¸ºbackupçš„èŠ‚ç‚¹ä¸Š\n&nbsp; &nbsp; priority 50 # è®¾ç½®ä¼˜å…ˆçº§ï¼Œå€¼èŒƒå›´0ï½254ï¼Œå€¼è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼Œæœ€é«˜çš„ä¸ºmaster\n&nbsp; &nbsp; advert_int 1 # ç»„æ’­ä¿¡æ¯å‘é€æ—¶é—´é—´éš”ï¼Œä¸¤ä¸ªèŠ‚ç‚¹å¿…é¡»è®¾ç½®ä¸€æ ·ï¼Œé»˜è®¤ä¸º1ç§’\n# éªŒè¯ä¿¡æ¯ï¼Œä¸¤ä¸ªèŠ‚ç‚¹å¿…é¡»ä¸€è‡´\n&nbsp; &nbsp; authentication {\n&nbsp; &nbsp; &nbsp; auth_type PASS # è®¤è¯æ–¹å¼ï¼Œå¯ä»¥æ˜¯PASSæˆ–AHä¸¤ç§è®¤è¯æ–¹å¼\n&nbsp; &nbsp; &nbsp; &nbsp; auth_pass 1111 # è®¤è¯å¯†ç \n&nbsp; &nbsp; }\n&nbsp; unicast_src_ip 10.0.4.21&nbsp; # è®¾ç½®æœ¬æœºå†…ç½‘IPåœ°å€\n&nbsp; &nbsp; unicast_peer {\n&nbsp; &nbsp; &nbsp; 10.0.4.20&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# å¯¹ç«¯è®¾å¤‡çš„IPåœ°å€\n&nbsp; &nbsp; }\n# VIPï¼Œå½“stateä¸ºmasteræ—¶æ·»åŠ ï¼Œå½“stateä¸ºbackupæ—¶åˆ é™¤\n&nbsp; virtual_ipaddress {\n&nbsp; &nbsp; 10.0.4.99 # è®¾ç½®é«˜å¯ç”¨è™šæ‹ŸVIPï¼Œå¦‚æœæ˜¯è…¾è®¯äº‘çš„CVMï¼Œéœ€è¦å¡«å†™æ§åˆ¶å°ç”³è¯·åˆ°çš„HAVIPåœ°å€ã€‚\n&nbsp; }\n&nbsp; notify_master \"/etc/keepalived/keepalived_notify.sh MASTER\" # å½“åˆ‡æ¢åˆ°masterçŠ¶æ€æ—¶æ‰§è¡Œè„šæœ¬\n&nbsp; &nbsp; notify_backup \"/etc/keepalived/keepalived_notify.sh BACKUP\" # å½“åˆ‡æ¢åˆ°backupçŠ¶æ€æ—¶æ‰§è¡Œè„šæœ¬\n&nbsp; &nbsp; notify_fault \"/etc/keepalived/keepalived_notify.sh FAULT\" # å½“åˆ‡æ¢åˆ°faultçŠ¶æ€æ—¶æ‰§è¡Œè„šæœ¬\n&nbsp; &nbsp; notify_stop \"/etc/keepalived/keepalived_notify.sh STOP\" # å½“åˆ‡æ¢åˆ°stopçŠ¶æ€æ—¶æ‰§è¡Œè„šæœ¬\n&nbsp; &nbsp; garp_master_delay 1&nbsp; &nbsp; # è®¾ç½®å½“åˆ‡ä¸ºä¸»çŠ¶æ€åå¤šä¹…æ›´æ–°ARPç¼“å­˜\n&nbsp; &nbsp; garp_master_refresh 5&nbsp; &nbsp;# è®¾ç½®ä¸»èŠ‚ç‚¹å‘é€ARPæŠ¥æ–‡çš„æ—¶é—´é—´éš”\n&nbsp; &nbsp; # è·Ÿè¸ªæ¥å£ï¼Œé‡Œé¢ä»»æ„ä¸€å—ç½‘å¡å‡ºç°é—®é¢˜ï¼Œéƒ½ä¼šè¿›å…¥æ•…éšœ(FAULT)çŠ¶æ€\n&nbsp; &nbsp; track_interface {\n&nbsp; &nbsp; &nbsp; eth0\n&nbsp; &nbsp; }\n&nbsp; # è¦æ‰§è¡Œçš„æ£€æŸ¥è„šæœ¬\n&nbsp; track_script {\n&nbsp; &nbsp; checkhaproxy\n&nbsp; }\n}\n</code></pre><p>è¿™é‡Œè§£æä¸‹é…ç½®æ–‡ä»¶ï¼Œå¤§è‡´åˆ†ä¸ºä¸‹é¢4ä¸ªéƒ¨åˆ†ã€‚</p><ul>\n<li>global_defsï¼šå…¨å±€å®šä¹‰ï¼Œå®šä¹‰å…¨å±€çš„é…ç½®é€‰é¡¹ã€‚</li>\n<li>vrrp_script checkhaproxyï¼šæ£€æµ‹è„šæœ¬é…ç½®ã€‚</li>\n<li>vrrp_instance VI_1ï¼šVRRPå®ä¾‹é…ç½®ã€‚</li>\n<li>virtual_serverï¼šLVSé…ç½®ã€‚å¦‚æœæ²¡æœ‰é…ç½®LVS+Keepalivedï¼Œå°±ä¸ç”¨è®¾ç½®è¿™ä¸ªé€‰é¡¹ã€‚è¿™é—¨è¯¾ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨Nginxä»£æ›¿LVSï¼Œæ‰€ä»¥æ— éœ€é…ç½®<code>virtual_server</code>ï¼ˆé…ç½®ç¤ºä¾‹ä¸­ä¸å†å±•ç¤ºï¼‰ã€‚</li>\n</ul><p>åªæœ‰åœ¨ç½‘ç»œæ•…éšœæˆ–è€…è‡ªèº«å‡ºé—®é¢˜æ—¶ï¼ŒKeepalivedæ‰ä¼šè¿›è¡ŒVIPåˆ‡æ¢ã€‚ä½†å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬å¾€å¾€ä½¿ç”¨Keepalivedæ¥ç›‘æ§å…¶ä»–è¿›ç¨‹ï¼Œå½“ä¸šåŠ¡è¿›ç¨‹å‡ºæ•…éšœæ—¶åˆ‡æ¢VIPï¼Œä»è€Œä¿éšœä¸šåŠ¡è¿›ç¨‹çš„é«˜å¯ç”¨ã€‚</p><p>ä¸ºäº†è®©Keepalivedæ„ŸçŸ¥åˆ°Nginxçš„è¿è¡ŒçŠ¶å†µï¼Œæˆ‘ä»¬éœ€è¦æŒ‡å®š<code>vrrp_script</code>è„šæœ¬ï¼Œ<code>vrrp_script</code>è„šæœ¬å¯ä»¥æ ¹æ®é€€å‡ºç ï¼Œåˆ¤æ–­Nginxè¿›ç¨‹æ˜¯å¦æ­£å¸¸ï¼Œ<code>0</code>æ­£å¸¸ï¼Œé<code>0</code>ä¸æ­£å¸¸ã€‚å½“ä¸æ­£å¸¸æ—¶ï¼ŒKeepalivedä¼šè¿›è¡ŒVIPåˆ‡æ¢ã€‚ä¸ºäº†å®ç°ä¸šåŠ¡è¿›ç¨‹çš„ç›‘æ§ï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®<code>vrrp_script</code>å’Œ<code>track_script</code>ï¼š</p><pre><code class=\"language-plain\">vrrp_script checkhaproxy\n{\n&nbsp; &nbsp; script \"/etc/keepalived/check_nginx.sh\"\n&nbsp; &nbsp; interval 3\n&nbsp; &nbsp; weight -20\n}\n\nvrrp_instance test\n{\n&nbsp; &nbsp; ...\n&nbsp; &nbsp; track_script\n&nbsp; &nbsp; {\n&nbsp; &nbsp; &nbsp; &nbsp; checkhaproxy\n&nbsp; &nbsp; }\n&nbsp; &nbsp; ...\n}\n</code></pre><p>è¿™é‡Œï¼Œæˆ‘ä»‹ç»ä¸‹ä¸Šé¢é…ç½®ä¸­çš„ä¸€äº›é…ç½®é¡¹ã€‚</p><ul>\n<li>scriptï¼šæŒ‡å®šè„šæœ¬è·¯å¾„ã€‚</li>\n<li>intervalï¼šè¡¨ç¤ºKeepalivedæ‰§è¡Œè„šæœ¬çš„æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰ã€‚</li>\n<li>weightï¼šæ£€æµ‹æƒé‡ï¼Œå¯ä»¥æ”¹å˜<code>priority</code>çš„å€¼ã€‚ä¾‹å¦‚ï¼Œ<code>-20</code>è¡¨ç¤ºæ£€æµ‹å¤±è´¥æ—¶ï¼Œä¼˜å…ˆçº§<code>-20</code>ï¼ŒæˆåŠŸæ—¶ä¸å˜ã€‚<code>20</code>è¡¨ç¤ºæ£€æµ‹æˆåŠŸæ—¶ï¼Œä¼˜å…ˆçº§<code>+20</code>ï¼Œå¤±è´¥æ—¶ä¸å˜ã€‚</li>\n</ul><h2>æ€»ç»“</h2><p>ä»Šå¤©æˆ‘ä¸»è¦è®²äº†è·ŸIAMéƒ¨ç½²ç›¸å…³çš„ä¸¤ä¸ªç»„ä»¶ï¼ŒNginx + Keepalivedçš„ç›¸å…³åŠŸèƒ½ã€‚</p><p>æˆ‘ä»¬å¯ä»¥åŸºäºç‰©ç†æœº/è™šæ‹Ÿæœºæ¥éƒ¨ç½²IAMåº”ç”¨ï¼Œåœ¨éƒ¨ç½²IAMåº”ç”¨æ—¶ï¼Œéœ€è¦ç¡®ä¿æ•´ä¸ªåº”ç”¨å…·å¤‡é«˜å¯ç”¨å’Œå¼¹æ€§æ‰©ç¼©å®¹èƒ½åŠ›ã€‚ä½ å¯ä»¥é€šè¿‡Nginxçš„åå‘ä»£ç†åŠŸèƒ½å’Œè´Ÿè½½å‡è¡¡åŠŸèƒ½å®ç°åç«¯æœåŠ¡iam-apiserverå’Œiam-authz-serverçš„é«˜å¯ç”¨ï¼Œé€šè¿‡Keepalivedå®ç°Nginxçš„é«˜å¯ç”¨ï¼Œé€šè¿‡Nginx + Keepalivedç»„åˆï¼Œæ¥å®ç°IAMåº”ç”¨çš„é«˜å¯ç”¨å’Œå¼¹æ€§ä¼¸ç¼©èƒ½åŠ›ã€‚</p><h2>è¯¾åç»ƒä¹ </h2><ol>\n<li>Keepalivedçš„ä¸»å¤‡æœåŠ¡å™¨è¦æ¥åœ¨åŒä¸€ä¸ªäº¤æ¢æœºä¸Šã€‚æ€è€ƒä¸‹ï¼Œå¦‚æœäº¤æ¢æœºæ•…éšœï¼Œå¦‚ä½•å®ç°æ•´ä¸ªç³»ç»Ÿçš„é«˜å¯ç”¨ï¼Ÿ</li>\n<li>iam-pumpæ˜¯æœ‰çŠ¶æ€çš„æœåŠ¡ï¼Œæ€è€ƒä¸‹ï¼Œå¦‚ä½•å®ç°iam-pumpçš„é«˜å¯ç”¨ï¼Ÿ</li>\n</ol><p>æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºä¸æˆ‘äº¤æµè®¨è®ºï¼Œæˆ‘ä»¬ä¸‹ä¸€è®²è§ã€‚</p>","comments":[{"had_liked":false,"id":309074,"user_name":"Realm","can_delete":false,"product_type":"c1","uid":1081299,"ip_address":"","ucode":"30CBEBE619D1A2","user_header":"https://static001.geekbang.org/account/avatar/00/10/7f/d3/b5896293.jpg","comment_is_top":false,"comment_ctime":1629934895,"is_pvip":true,"replies":[{"id":"112017","content":"é«˜æŠ¬ä¸é€šäº¤æ¢æœºçš„æœºå™¨ï¼Œä¸€å°å‡ºæ•…éšœï¼Œå¦ä¸€å°å¯ä»¥æ‰‹åŠ¨åˆ‡æ¢","user_name":"ä½œè€…å›å¤","user_name_real":"CK1.0","uid":"1167883","ctime":1630112994,"ip_address":"","comment_id":309074,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18809804079","product_id":100079601,"comment_content":"1 å¯ä»¥æŠŠäº¤æ¢æœºææˆå †å æ¨¡å¼ï¼ŒæœåŠ¡å™¨åˆ†åˆ«æ¥åœ¨ä¸¤ä¸ªä¸åŒçš„äº¤æ¢æœºä¸Šï¼Œå¯ä»¥å‡å°‘å•ç‚¹æ•…éšœã€‚å¯ä»¥çœ‹çœ‹è¿™ç¯‡æ–‡ç« https:&#47;&#47;blog.51cto.com&#47;netlt&#47;2589364<br><br>2 æœ‰çŠ¶æ€ä¸€èˆ¬æ˜¯cookieæˆ–è€…sessionï¼Œè´Ÿè½½å‡è¡¡æ”¯æŒåŸºäºcookieçš„ä¼šè¯ä¿æŒï¼Œå¼€å¯åï¼Œç›¸åŒcookieçš„httpè¯·æ±‚ï¼Œå§‹ç»ˆæ‰“åˆ°æŸä¸€ä¸ªæœåŠ¡ç«¯.<br><br>è¯·è€å¸ˆæŒ‡ç‚¹ï¼","like_count":4,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"å­”ä»¤é£","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":525734,"discussion_content":"é«˜æŠ¬ä¸é€šäº¤æ¢æœºçš„æœºå™¨ï¼Œä¸€å°å‡ºæ•…éšœï¼Œå¦ä¸€å°å¯ä»¥æ‰‹åŠ¨åˆ‡æ¢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630112994,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":309248,"user_name":"daz2yy","can_delete":false,"product_type":"c1","uid":1008723,"ip_address":"","ucode":"639A67961EC893","user_header":"https://static001.geekbang.org/account/avatar/00/0f/64/53/c93b8110.jpg","comment_is_top":false,"comment_ctime":1630021387,"is_pvip":false,"replies":[{"id":"112013","content":"Nginxä¸å¸¦VIPçš„èƒ½åŠ›ã€‚Keepalivedçš„é«˜å¯ç”¨é€šè¿‡VRRPæŠ€æœ¯æ¥å®ç°çš„","user_name":"ä½œè€…å›å¤","user_name_real":"CK1.0","uid":"1167883","ctime":1630112768,"ip_address":"","comment_id":309248,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10219955979","product_id":100079601,"comment_content":"Nginx ç¡®ä¿æœåŠ¡çš„é«˜å¯ç”¨ï¼›<br>Keepalived ç¡®ä¿ Nginx çš„é«˜å¯ç”¨ï¼›<br>è°æ¥ä¿è¯ Keepalived çš„é«˜å¯ç”¨å‘¢ï¼Ÿæ„Ÿè§‰å¦‚æœèƒ½ç¡®ä¿ Keepalived çš„é«˜å¯ç”¨ï¼Œé‚£ä¹ˆå»æ‰è¿™ä¸€å±‚ï¼ŒæŠŠä¿è¯ Keepalived é«˜å¯ç”¨çš„æ–¹å¼åº”ç”¨åˆ°ä¿è¯ Nginx çš„é«˜å¯ç”¨ä¸Šä¸æ˜¯ç®€å•ä¸€äº›å—ï¼Ÿ","like_count":2,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"å­”ä»¤é£","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":525798,"discussion_content":"Nginxä¸å¸¦VIPçš„èƒ½åŠ›ã€‚Keepalivedçš„é«˜å¯ç”¨é€šè¿‡VRRPæŠ€æœ¯æ¥å®ç°çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630112768,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":333853,"user_name":"å¼ é–","can_delete":false,"product_type":"c1","uid":1243566,"ip_address":"","ucode":"18AF868CCAA9D6","user_header":"https://static001.geekbang.org/account/avatar/00/12/f9/ae/ca227c21.jpg","comment_is_top":false,"comment_ctime":1644563744,"is_pvip":true,"replies":[{"id":"123449","content":"6666","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1167883","ctime":1647039633,"ip_address":"","comment_id":333853,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1644563744","product_id":100079601,"comment_content":"iam-pump ä¸ªäººç†è§£ï¼Œè¿˜æ²¡æœ‰çœ‹æœåŠ¡ç›¸å…³æºç ï¼Œå¦‚æœæ˜¯æœ‰çŠ¶æ€çš„æ¯”å¦‚session,å¯ä»¥é€šè¿‡sessionåŒæ­¥æˆ–å¼‚æ­¥å¤åˆ¶ã€‚ æˆ–è€…é€šè¿‡ä¸€è‡´æ€§hash åœ¨å›ºå®šèŠ‚ç‚¹å¤„ç†<br><br>é¸¡è›‹ç¯®å­ç†è®ºï¼Œé«˜å¯ç”¨ä¸€èˆ¬éƒ½æ˜¯å¤šå‰¯æœ¬çš„ï¼Œé‡‡ç”¨Quorum æœºåˆ¶ æ§åˆ¶å¤šå‰¯æœ¬æ•°æ®ä¸€è‡´æ€§ï¼Œä¿è¯åŠæ•°å†™å…¥","like_count":0,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"å­”ä»¤é£","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":555709,"discussion_content":"6666","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1647039633,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":324798,"user_name":"yandongxiao","can_delete":false,"product_type":"c1","uid":1017700,"ip_address":"","ucode":"D397F4DB0109C8","user_header":"https://static001.geekbang.org/account/avatar/00/0f/87/64/3882d90d.jpg","comment_is_top":false,"comment_ctime":1638630287,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1638630287","product_id":100079601,"comment_content":"æ€»ç»“ï¼š<br>ä¸ºäº†å®ç°IAMåº”ç”¨çš„é«˜å¯ç”¨ï¼Œä»¥ä¼ ç»Ÿçš„æ–¹å¼ï¼Œéƒ¨ç½²å¹¶é…ç½®Nginx å’Œ Keepalivedã€‚<br>Keepalivedä¿è¯äº†NginxæœåŠ¡çš„é«˜å¯ç”¨ï¼›Nginxä¿è¯äº†IAMåº”ç”¨çš„é«˜å¯ç”¨ã€‚<br>Nginxçš„ä¸¤å¤§åŠŸèƒ½ï¼š1. è¿”ç°ä»£ç†ï¼›2. è´Ÿè½½å‡è¡¡ã€‚","like_count":0},{"had_liked":false,"id":323961,"user_name":"é˜¿ç”˜","can_delete":false,"product_type":"c1","uid":1057843,"ip_address":"","ucode":"BC93175B70E05D","user_header":"https://static001.geekbang.org/account/avatar/00/10/24/33/bcf37f50.jpg","comment_is_top":false,"comment_ctime":1638241021,"is_pvip":true,"replies":[{"id":"117674","content":"è¿™ä¸ªæ˜¯keepalivedçš„é™åˆ¶ï¼Œæš‚æ—¶åº”è¯¥æ²¡æ³•é¿å…å§ã€‚<br><br>å¯ä»¥è¿™ä¹ˆæ¥ï¼ŒåŒæœºæ¶ä½¿ç”¨keepalivedåšçƒ­å¤‡ã€‚ä¸åŒæœºæ¶æ‰‹åŠ¨åˆ‡ï¼ˆå†·å¤‡ï¼‰","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1167883","ctime":1638361869,"ip_address":"","comment_id":323961,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1638241021","product_id":100079601,"comment_content":"è€å¸ˆä½ å¥½ï¼Œä½¿ç”¨KeepalivedåšVIP failoverè¦æ±‚VIPå’Œåç«¯RIPså¿…é¡»åœ¨åŒä¸€ä¸ªç½‘æ®µï¼Œä½†æ˜¯æœ‰æ—¶å€™MASTERå’ŒBACKUPå¯èƒ½å°±ä¸åœ¨ä¸€ä¸ªç½‘æ®µï¼Œæ¯”å¦‚å‡ºäºå®¹ç¾çš„éœ€è¦ï¼ŒMASTERå’ŒBACKUPä½äºä¸åŒçš„æœºæ¶ï¼Œè¿™æ—¶å€™ä»–ä»¬å°±ä¸ä¼šå¤„äºåŒä¸€ä¸ªå­ç½‘ä¸­ã€‚é‚£ä¹ˆè¿™ç§æƒ…å†µä¸‹ï¼Œæ€æ ·ä½¿ç”¨KeepalivedåšVIP failoverå‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"å­”ä»¤é£","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":535152,"discussion_content":"è¿™ä¸ªæ˜¯keepalivedçš„é™åˆ¶ï¼Œæš‚æ—¶åº”è¯¥æ²¡æ³•é¿å…å§ã€‚\n\nå¯ä»¥è¿™ä¹ˆæ¥ï¼ŒåŒæœºæ¶ä½¿ç”¨keepalivedåšçƒ­å¤‡ã€‚ä¸åŒæœºæ¶æ‰‹åŠ¨åˆ‡ï¼ˆå†·å¤‡ï¼‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638361869,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":316929,"user_name":"æˆäººä»¥ğŸŸï¼Œä¸å¦‚æˆäººä»¥æ¸”","can_delete":false,"product_type":"c1","uid":1193874,"ip_address":"","ucode":"BD53829E924B66","user_header":"https://static001.geekbang.org/account/avatar/00/12/37/92/961ba560.jpg","comment_is_top":false,"comment_ctime":1634616140,"is_pvip":true,"replies":[{"id":"114910","content":"è¿™é‡Œçš„VIPè¿˜ä¸ä¸€å®šæ˜¯å…¬ç½‘ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯å†…ç½‘ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å­”ä»¤é£","uid":"1167883","ctime":1634736489,"ip_address":"","comment_id":316929,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1634616140","product_id":100079601,"comment_content":"ã€Œå®¢æˆ·ç«¯åªèƒ½é€šè¿‡VIP:443ç«¯å£è®¿é—® Nginx æœåŠ¡ã€æ˜¯å¦å¯ä¿®æ”¹ä¸ºï¼šã€Œå®¢æˆ·ç«¯åªèƒ½é€šè¿‡å…¬ç½‘IP:443ç«¯å£è®¿é—® Nginx æœåŠ¡ã€?","like_count":0,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"å­”ä»¤é£","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":528574,"discussion_content":"è¿™é‡Œçš„VIPè¿˜ä¸ä¸€å®šæ˜¯å…¬ç½‘ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯å†…ç½‘ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634736489,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":311316,"user_name":"éšé£è€Œè¿‡","can_delete":false,"product_type":"c1","uid":2654999,"ip_address":"","ucode":"FFD17BAA3B2312","user_header":"https://static001.geekbang.org/account/avatar/00/28/83/17/df99b53d.jpg","comment_is_top":false,"comment_ctime":1631169822,"is_pvip":false,"replies":[{"id":"113692","content":"æ˜¯ä¸ªæ–¹æ¡ˆ","user_name":"ä½œè€…å›å¤","user_name_real":"CK1.0","uid":"1167883","ctime":1632760193,"ip_address":"","comment_id":311316,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1631169822","product_id":100079601,"comment_content":"å¤šå°äº¤æ¢æœºåšå¤‡ç”¨ï¼Œç›‘æµ‹äº¤æ¢æœºçŠ¶æ€","like_count":0,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"å­”ä»¤é£","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":526558,"discussion_content":"æ˜¯ä¸ªæ–¹æ¡ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632760193,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":309282,"user_name":"kkgo","can_delete":false,"product_type":"c1","uid":1199356,"ip_address":"","ucode":"AFCCBFD96CFA21","user_header":"https://static001.geekbang.org/account/avatar/00/12/4c/fc/0e887697.jpg","comment_is_top":false,"comment_ctime":1630030650,"is_pvip":false,"replies":[{"id":"112012","content":"è€å“¥ï¼Œè¯·çœ‹ä¸‹ä¸€è®²","user_name":"ä½œè€…å›å¤","user_name_real":"CK1.0","uid":"1167883","ctime":1630112607,"ip_address":"","comment_id":309282,"utype":1}],"discussion_count":1,"race_medal":1,"score":"1630030650","product_id":100079601,"comment_content":"æ€ä¹ˆåšnginxè´Ÿè½½å‡è¡¡ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"å­”ä»¤é£","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":525811,"discussion_content":"è€å“¥ï¼Œè¯·çœ‹ä¸‹ä¸€è®²","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630112607,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":309209,"user_name":"XI","can_delete":false,"product_type":"c1","uid":2187234,"ip_address":"","ucode":"2CEBC094EA1E87","user_header":"https://static001.geekbang.org/account/avatar/00/21/5f/e2/e6d3d9bf.jpg","comment_is_top":false,"comment_ctime":1629986068,"is_pvip":false,"replies":[{"id":"112014","content":"å…·ä½“è¦çœ‹æœºå™¨é…ç½®äº†ã€‚ä½ å¯ä»¥å‚è€ƒ2C8Gçš„å¹¶å‘","user_name":"ä½œè€…å›å¤","user_name_real":"CK1.0","uid":"1167883","ctime":1630112801,"ip_address":"","comment_id":309209,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1629986068","product_id":100079601,"comment_content":"è€å¸ˆï¼Œå•å°ginæ¡†æ¶åº”è¯¥èµ·å¤šå°‘goroutineæ€§èƒ½æ‰æ˜¯æœ€ä¼˜çš„å•Šï¼Œ100 ä¸ª1000ä¸ªï¼Ÿï¼Œå•å°æœåŠ¡å™¨èµ·èƒ½æŠ—ä½å¤šå°‘çš„å¹¶å‘å•Šï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"å­”ä»¤é£","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":525787,"discussion_content":"å…·ä½“è¦çœ‹æœºå™¨é…ç½®äº†ã€‚ä½ å¯ä»¥å‚è€ƒ2C8Gçš„å¹¶å‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630112801,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":309105,"user_name":"é‚£æ—¶åˆ»","can_delete":false,"product_type":"c1","uid":1150927,"ip_address":"","ucode":"B0D150856C3A4A","user_header":"https://static001.geekbang.org/account/avatar/00/11/8f/cf/890f82d6.jpg","comment_is_top":false,"comment_ctime":1629945199,"is_pvip":false,"replies":[{"id":"112015","content":"å¯¹çš„ï¼Œåªèƒ½é‡‡ç”¨å†·å¤‡äº†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"CK1.0","uid":"1167883","ctime":1630112825,"ip_address":"","comment_id":309105,"utype":1}],"discussion_count":1,"race_medal":1,"score":"1629945199","product_id":100079601,"comment_content":"å¯¹äºå¦‚æœäº¤æ¢æœºæ•…éšœï¼Œå¦‚ä½•å®ç°æ•´ä¸ªç³»ç»Ÿçš„é«˜å¯ç”¨ï¼Ÿ<br><br>å…¶ä¸€é‡‡ç”¨å¤‡ä»½äº¤æ¢æœºï¼Œå½“äº‘è§£æåˆ°ä¸»äº¤æ¢æœºä¸åŒä¹‹åï¼ŒæŠŠè¯·æ±‚è·¯ç”±åˆ°å¤‡ä»½äº¤æ¢æœºä¸Šï¼Œä¸»äº¤æ¢æœºå’Œå¤‡ä»½äº¤æ¢æœºéƒ½æŒ‡å‘åŒä¸€åå°æœåŠ¡å™¨<br><br>å…¶äºŒå¯ä»¥é‡‡ç”¨å¤‡ä»½æœåŠ¡å™¨é›†ç¾¤ï¼Œä¸ä¸»æœåŠ¡å™¨é›†ç¾¤ä¸€è‡´ï¼Œå¤‡ç¾ä½¿ç”¨","like_count":0,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"å­”ä»¤é£","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":525742,"discussion_content":"å¯¹çš„ï¼Œåªèƒ½é‡‡ç”¨å†·å¤‡äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630112825,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}