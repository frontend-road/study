{"id":11940,"title":"第31讲 | 容器网络之Calico：为高效说出善意的谎言","content":"<p>上一节我们讲了Flannel如何解决容器跨主机互通的问题，这个解决方式其实和虚拟机的网络互通模式是差不多的，都是通过隧道。但是Flannel有一个非常好的模式，就是给不同的物理机设置不同网段，这一点和虚拟机的Overlay的模式完全不一样。</p><p>在虚拟机的场景下，整个网段在所有的物理机之间都是可以“飘来飘去”的。网段不同，就给了我们做路由策略的可能。</p><h2>Calico网络模型的设计思路</h2><p>我们看图中的两台物理机。它们的物理网卡是同一个二层网络里面的。由于两台物理机的容器网段不同，我们完全可以将两台物理机配置成为路由器，并按照容器的网段配置路由表。</p><p><img src=\"https://static001.geekbang.org/resource/image/19/37/1957b75dd689127c4621b5460c356137.jpg?wh=2250*1165\" alt=\"\"></p><p>例如，在物理机A中，我们可以这样配置：要想访问网段172.17.9.0/24，下一跳是192.168.100.101，也即到物理机B上去。</p><p>这样在容器A中访问容器B，当包到达物理机A的时候，就能够匹配到这条路由规则，并将包发给下一跳的路由器，也即发给物理机B。在物理机B上也有路由规则，要访问172.17.9.0/24，从docker0的网卡进去即可。</p><p>当容器B返回结果的时候，在物理机B上，可以做类似的配置：要想访问网段172.17.8.0/24，下一跳是192.168.100.100，也即到物理机A上去。</p><!-- [[[read_end]]] --><p>当包到达物理机B的时候，能够匹配到这条路由规则，将包发给下一跳的路由器，也即发给物理机A。在物理机A上也有路由规则，要访问172.17.8.0/24，从docker0的网卡进去即可。</p><p>这就是<strong>Calico网络的大概思路</strong>，<strong>即不走Overlay网络，不引入另外的网络性能损耗，而是将转发全部用三层网络的路由转发来实现</strong>，只不过具体的实现和上面的过程稍有区别。</p><p>首先，如果全部走三层的路由规则，没必要每台机器都用一个docker0，从而浪费了一个IP地址，而是可以直接用路由转发到veth pair在物理机这一端的网卡。同样，在容器内，路由规则也可以这样设定：把容器外面的veth pair网卡算作默认网关，下一跳就是外面的物理机。</p><p>于是，整个拓扑结构就变成了这个图中的样子。</p><p><img src=\"https://static001.geekbang.org/resource/image/f4/58/f4fab81e3f981827577aa7790b78dc58.jpg?wh=2552*1558\" alt=\"\"></p><h2>Calico网络的转发细节</h2><p>我们来看其中的一些细节。</p><p>容器A1的IP地址为172.17.8.2/32，这里注意，不是/24，而是/32，将容器A1作为一个单点的局域网了。</p><p>容器A1里面的默认路由，Calico配置得比较有技巧。</p><pre><code>default via 169.254.1.1 dev eth0 \n169.254.1.1 dev eth0 scope link \n</code></pre><p>这个IP地址169.254.1.1是默认的网关，但是整个拓扑图中没有一张网卡是这个地址。那如何到达这个地址呢？</p><p>前面我们讲网关的原理的时候说过，当一台机器要访问网关的时候，首先会通过ARP获得网关的MAC地址，然后将目标MAC变为网关的MAC，而网关的IP地址不会在任何网络包头里面出现，也就是说，没有人在乎这个地址具体是什么，只要能找到对应的MAC，响应ARP就可以了。</p><p>ARP本地有缓存，通过ip neigh命令可以查看。</p><pre><code>169.254.1.1 dev eth0 lladdr ee:ee:ee:ee:ee:ee STALE\n</code></pre><p>这个MAC地址是Calico硬塞进去的，但是没有关系，它能响应ARP，于是发出的包的目标MAC就是这个MAC地址。</p><p>在物理机A上查看所有网卡的MAC地址的时候，我们会发现veth1就是这个MAC地址。所以容器A1里发出的网络包，第一跳就是这个veth1这个网卡，也就到达了物理机A这个路由器。</p><p>在物理机A上有三条路由规则，分别是去两个本机的容器的路由，以及去172.17.9.0/24，下一跳为物理机B。</p><pre><code>172.17.8.2 dev veth1 scope link \n172.17.8.3 dev veth2 scope link \n172.17.9.0/24 via 192.168.100.101 dev eth0 proto bird onlink\n</code></pre><p>同理，物理机B上也有三条路由规则，分别是去两个本机的容器的路由，以及去172.17.8.0/24，下一跳为物理机A。</p><pre><code>172.17.9.2 dev veth1 scope link \n172.17.9.3 dev veth2 scope link \n172.17.8.0/24 via 192.168.100.100 dev eth0 proto bird onlink\n</code></pre><p>如果你觉得这些规则过于复杂，我将刚才的拓扑图转换为这个更加容易理解的图。</p><p><img src=\"https://static001.geekbang.org/resource/image/5f/47/5f23071c1e1b17cc46f1cb8955084247.jpg?wh=3070*1131\" alt=\"\"></p><p>在这里，物理机化身为路由器，通过路由器上的路由规则，将包转发到目的地。在这个过程中，没有隧道封装解封装，仅仅是单纯的路由转发，性能会好很多。但是，这种模式也有很多问题。</p><h2>Calico的架构</h2><h3>路由配置组件Felix</h3><p>如果只有两台机器，每台机器只有两个容器，而且保持不变。我手动配置一下，倒也没啥问题。但是如果容器不断地创建、删除，节点不断地加入、退出，情况就会变得非常复杂。</p><p><img src=\"https://static001.geekbang.org/resource/image/f2/31/f29027cca71f3dfbba8c2f1a35c29331.jpg?wh=1895*876\" alt=\"\"></p><p>就像图中，有三台物理机，两两之间都需要配置路由，每台物理机上对外的路由就有两条。如果有六台物理机，则每台物理机上对外的路由就有五条。新加入一个节点，需要通知每一台物理机添加一条路由。</p><p>这还是在物理机之间，一台物理机上，每创建一个容器，也需要多配置一条指向这个容器的路由。如此复杂，肯定不能手动配置，需要每台物理机上有一个agent，当创建和删除容器的时候，自动做这件事情。这个agent在Calico中称为Felix。</p><h3>路由广播组件BGP Speaker</h3><p>当Felix配置了路由之后，接下来的问题就是，如何将路由信息，也即将“如何到达我这个节点，访问我这个节点上的容器”这些信息，广播出去。</p><p>能想起来吗？这其实就是路由协议啊！路由协议就是将“我能到哪里，如何能到我”的信息广播给全网传出去，从而客户端可以一跳一跳地访问目标地址的。路由协议有很多种，Calico使用的是BGP协议。</p><p>在Calico中，每个Node上运行一个软件BIRD，作为BGP的客户端，或者叫作BGP Speaker，将“如何到达我这个Node，访问我这个Node上的容器”的路由信息广播出去。所有Node上的BGP Speaker 都互相建立连接，就形成了全互连的情况，这样每当路由有所变化的时候，所有节点就都能够收到了。</p><h3>安全策略组件</h3><p>Calico中还实现了灵活配置网络策略Network Policy，可以灵活配置两个容器通或者不通。这个怎么实现呢？</p><p><img src=\"https://static001.geekbang.org/resource/image/dd/f2/ddae28956780cc3e45fde76ae96701f2.jpg?wh=3516*1434\" alt=\"\"></p><p>虚拟机中的安全组，是用iptables实现的。Calico中也是用iptables实现的。这个图里的内容是iptables在内核处理网络包的过程中可以嵌入的处理点。Calico也是在这些点上设置相应的规则。</p><p><img src=\"https://static001.geekbang.org/resource/image/8f/3f/8f2be6638615fc5501c460d1206bff3f.jpg?wh=3977*1818\" alt=\"\"></p><p>当网络包进入物理机上的时候，进入PREOUTING规则，这里面有一个规则是cali-fip-dnat，这是实现浮动IP（Floating IP）的场景，主要将外网的IP地址dnat作为容器内的IP地址。在虚拟机场景下，路由器的网络namespace里面有一个外网网卡上，也设置过这样一个DNAT规则。</p><p>接下来可以根据路由判断，是到本地的，还是要转发出去的。</p><p>如果是本地的，走INPUT规则，里面有个规则是cali-wl-to-host，wl的意思是workload，也即容器，也即这是用来判断从容器发到物理机的网络包是否符合规则的。这里面内嵌一个规则cali-from-wl-dispatch，也是匹配从容器来的包。如果有两个容器，则会有两个容器网卡，这里面内嵌有详细的规则“cali-fw-cali网卡1”和“cali-fw-cali网卡2”，fw就是from workload，也就是匹配从容器1来的网络包和从容器2来的网络包。</p><p>如果是转发出去的，走FORWARD规则，里面有个规则cali-FORWARD。这里面分两种情况，一种是从容器里面发出来，转发到外面的；另一种是从外面发进来，转发到容器里面的。</p><p>第一种情况匹配的规则仍然是cali-from-wl-dispatch，也即from workload。第二种情况匹配的规则是cali-to-wl-dispatch，也即to workload。如果有两个容器，则会有两个容器网卡，在这里面内嵌有详细的规则“cali-tw-cali网卡1”和“cali-tw-cali网卡2”，tw就是to workload，也就是匹配发往容器1的网络包和发送到容器2的网络包。</p><p>接下来是匹配OUTPUT规则，里面有cali-OUTPUT。接下来是POSTROUTING规则，里面有一个规则是cali-fip-snat，也即发出去的时候，将容器网络IP转换为浮动IP地址。在虚拟机场景下，路由器的网络namespace里面有一个外网网卡上，也设置过这样一个SNAT规则。</p><p>至此为止，Calico的所有组件基本凑齐。来看看我汇总的图。</p><p><img src=\"https://static001.geekbang.org/resource/image/71/07/71f22fd9e8336c7e10c8ff7bd276af07.jpg?wh=3098*3650\" alt=\"\"></p><h2>全连接复杂性与规模问题</h2><p>这里面还存在问题，就是BGP全连接的复杂性问题。</p><p>你看刚才的例子里只有六个节点，BGP的互连已经如此复杂，如果节点数据再多，这种全互连的模式肯定不行，到时候都成蜘蛛网了。于是多出了一个组件BGP Route Reflector，它也是用BIRD实现的。有了它，BGP Speaker就不用全互连了，而是都直连它，它负责将全网的路由信息广播出去。</p><p>可是问题来了，规模大了，大家都连它，它受得了吗？这个BGP Router Reflector会不会成为瓶颈呢？</p><p>所以，肯定不能让一个BGP Router Reflector管理所有的路由分发，而是应该有多个BGP Router Reflector，每个BGP Router Reflector管一部分。</p><p>多大算一部分呢？咱们讲述数据中心的时候，说服务器都是放在机架上的，每个机架上最顶端有个TOR交换机。那将机架上的机器连在一起，这样一个机架是不是可以作为一个单元，让一个BGP Router Reflector来管理呢？如果要跨机架，如何进行通信呢？这就需要BGP Router Reflector也直接进行路由交换。它们之间的交换和一个机架之间的交换有什么关系吗？</p><p>有没有觉得在这个场景下，一个机架就像一个数据中心，可以把它设置为一个AS，而BGP Router Reflector有点儿像数据中心的边界路由器。在一个AS内部，也即服务器和BGP Router Reflector之间使用的是数据中心内部的路由协议iBGP，BGP Router Reflector之间使用的是数据中心之间的路由协议eBGP。</p><p><img src=\"https://static001.geekbang.org/resource/image/47/a0/474cb05d5536f11d75baeb6332d788a0.jpg?wh=3918*2408\" alt=\"\"></p><p>这个图中，一个机架上有多台机器，每台机器上面启动多个容器，每台机器上都有可以到达这些容器的路由。每台机器上都启动一个BGP Speaker，然后将这些路由规则上报到这个Rack上接入交换机的BGP Route Reflector，将这些路由通过iBGP协议告知到接入交换机的三层路由功能。</p><p>在接入交换机之间也建立BGP连接，相互告知路由，因而一个Rack里面的路由可以告知另一个Rack。有多个核心或者汇聚交换机将接入交换机连接起来，如果核心和汇聚起二层互通的作用，则接入和接入之间之间交换路由即可。如果核心和汇聚交换机起三层路由的作用，则路由需要通过核心或者汇聚交换机进行告知。</p><h2>跨网段访问问题</h2><p>上面的Calico模式还有一个问题，就是跨网段问题，这里的跨网段是指物理机跨网段。</p><p>前面我们说的那些逻辑成立的条件，是我们假设物理机可以作为路由器进行使用。例如物理机A要告诉物理机B，你要访问172.17.8.0/24，下一跳是我192.168.100.100；同理，物理机B要告诉物理机A，你要访问172.17.9.0/24，下一跳是我192.168.100.101。</p><p>之所以能够这样，是因为物理机A和物理机B是同一个网段的，是连接在同一个交换机上的。那如果物理机A和物理机B不是在同一个网段呢？</p><p><img src=\"https://static001.geekbang.org/resource/image/58/89/58bb1d0965c383b1eaac06946998f089.jpg?wh=2773*1756\" alt=\"\"><br>\n<img src=\"https://static001.geekbang.org/resource/image/1b/37/1b4514ed6d0e952a9d14f55yy36c0937.jpg?wh=3047*1018\" alt=\"\"></p><p>例如，物理机A的网段是192.168.100.100/24，物理机B的网段是192.168.200.101/24，这样两台机器就不能通过二层交换机连接起来了，需要在中间放一台路由器，做一次路由转发，才能跨网段访问。</p><p>本来物理机A要告诉物理机B，你要访问172.17.8.0/24，下一跳是我192.168.100.100的，但是中间多了一台路由器，下一跳不是我了，而是中间的这台路由器了，这台路由器的再下一跳，才是我。这样之前的逻辑就不成立了。</p><p>我们看刚才那张图的下半部分。物理机B上的容器要访问物理机A上的容器，第一跳就是物理机B，IP为192.168.200.101，第二跳是中间的物理路由器右面的网口，IP为192.168.200.1，第三跳才是物理机A，IP为192.168.100.100。</p><p>这是咱们通过拓扑图看到的，关键问题是，在系统中物理机A如何告诉物理机B，怎么让它才能到我这里？物理机A根本不可能知道从物理机B出来之后的下一跳是谁，况且现在只是中间隔着一个路由器这种简单的情况，如果隔着多个路由器呢？谁能把这一串的路径告诉物理机B呢？</p><p>我们能想到的第一种方式是，让中间所有的路由器都来适配Calico。本来它们互相告知路由，只互相告知物理机的，现在还要告知容器的网段。这在大部分情况下，是不可能的。</p><p>第二种方式，还是在物理机A和物理机B之间打一个隧道，这个隧道有两个端点，在端点上进行封装，将容器的IP作为乘客协议放在隧道里面，而物理主机的IP放在外面作为承载协议。这样不管外层的IP通过传统的物理网络，走多少跳到达目标物理机，从隧道两端看起来，物理机A的下一跳就是物理机B，这样前面的逻辑才能成立。</p><p>这就是Calico的<strong>IPIP模式</strong>。使用了IPIP模式之后，在物理机A上，我们能看到这样的路由表：</p><pre><code>172.17.8.2 dev veth1 scope link \n172.17.8.3 dev veth2 scope link \n172.17.9.0/24 via 192.168.200.101 dev tun0 proto bird onlink\n</code></pre><p>这和原来模式的区别在于，下一跳不再是同一个网段的物理机B了，IP为192.168.200.101，并且不是从eth0跳，而是建立一个隧道的端点tun0，从这里才是下一跳。</p><p>如果我们在容器A1里面的172.17.8.2，去ping容器B1里面的172.17.9.2，首先会到物理机A。在物理机A上根据上面的规则，会转发给tun0，并在这里对包做封装：</p><ul>\n<li>\n<p>内层源IP为172.17.8.2；</p>\n</li>\n<li>\n<p>内层目标IP为172.17.9.2；</p>\n</li>\n<li>\n<p>外层源IP为192.168.100.100；</p>\n</li>\n<li>\n<p>外层目标IP为192.168.200.101。</p>\n</li>\n</ul><p>将这个包从eth0发出去，在物理网络上会使用外层的IP进行路由，最终到达物理机B。在物理机B上，tun0会解封装，将内层的源IP和目标IP拿出来，转发给相应的容器。</p><h2>小结</h2><p>好了，这一节就到这里，我们来总结一下。</p><ul>\n<li>\n<p>Calico推荐使用物理机作为路由器的模式，这种模式没有虚拟化开销，性能比较高。</p>\n</li>\n<li>\n<p>Calico的主要组件包括路由、iptables的配置组件Felix、路由广播组件BGP Speaker，以及大规模场景下的BGP Route Reflector。</p>\n</li>\n<li>\n<p>为解决跨网段的问题，Calico还有一种IPIP模式，也即通过打隧道的方式，从隧道端点来看，将本来不是邻居的两台机器，变成相邻的机器。</p>\n</li>\n</ul><p>最后，给你留两个思考题：</p><ol>\n<li>\n<p>将Calico部署在公有云上的时候，经常会选择使用IPIP模式，你知道这是为什么吗？</p>\n</li>\n<li>\n<p>容器是用来部署微服务的，微服务之间的通信，除了网络要互通，还需要高效地传输信息，例如下单的商品、价格、数量、支付的钱等等，这些要通过什么样的协议呢？</p>\n</li>\n</ol><p>我们的专栏更新到第31讲，不知你掌握得如何？每节课后我留的思考题，你都有没有认真思考，并在留言区写下答案呢？我会从<strong>已发布的文章中选出一批认真留言的同学</strong>，赠送<span class=\"orange\">学习奖励礼券</span>和我整理的<span class=\"orange\">独家网络协议知识图谱</span>。</p><p>欢迎你留言和我讨论。趣谈网络协议，我们下期见！</p>","neighbors":{"left":{"article_title":"第30讲 | 容器网络之Flannel：每人一亩三分地","id":11643},"right":{"article_title":"第32讲 | RPC协议综述：远在天边，近在眼前","id":12230}},"comments":[{"had_liked":false,"id":17436,"user_name":"sunlight001","can_delete":false,"product_type":"c1","uid":1126975,"ip_address":"","ucode":"A72C4274D5DE8A","user_header":"https://static001.geekbang.org/account/avatar/00/11/32/3f/fa4ac035.jpg","comment_is_top":false,"comment_ctime":1532650860,"is_pvip":false,"discussion_count":3,"race_medal":0,"score":"955015390572","product_id":100007101,"comment_content":"工作中接触不到，现在完全看不明白的举个手！","like_count":223,"discussions":[{"author":{"id":1226953,"avatar":"https://static001.geekbang.org/account/avatar/00/12/b8/c9/e41f409d.jpg","nickname":"Jahn","note":"","ucode":"63729B07663D11","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":122830,"discussion_content":"但你以后会发现这是最关键的部分","likes_number":7,"is_delete":false,"is_hidden":false,"ctime":1578375928,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1018611,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/8a/f3/fc992148.jpg","nickname":"kitsdk","note":"","ucode":"A3570300D8A48C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":367107,"discussion_content":"要学k8s这两讲要好好学习，不然cni就搞不清楚了","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1618273396,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1657948,"avatar":"https://static001.geekbang.org/account/avatar/00/19/4c/5c/9ea0f752.jpg","nickname":"程序猿不圆","note":"","ucode":"BC8926A84A07C8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375515,"discussion_content":"正在学k8s，这几讲看得很爽。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1621700421,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":63243,"user_name":"小谢同学","can_delete":false,"product_type":"c1","uid":1032544,"ip_address":"","ucode":"E809E6BC470631","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c1/60/fc3689d0.jpg","comment_is_top":false,"comment_ctime":1548308302,"is_pvip":false,"replies":[{"id":"25814","content":"是的","user_name":"作者回复","user_name_real":"刘超@网易云","uid":"1001590","ctime":1551423918,"ip_address":"","comment_id":63243,"utype":1}],"discussion_count":4,"race_medal":0,"score":"91742621518","product_id":100007101,"comment_content":"请问老师，在IPIP模式下，原本的性能优势是否又回退到了overlay类似呢？","like_count":21,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"刘超","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437517,"discussion_content":"是的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551423918,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2976412,"avatar":"https://static001.geekbang.org/account/avatar/00/2d/6a/9c/de8f9280.jpg","nickname":"刚毅坚卓","note":"","ucode":"6D16E587400F6F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":572710,"discussion_content":"还要封包和解封包","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1652925836,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2976412,"avatar":"https://static001.geekbang.org/account/avatar/00/2d/6a/9c/de8f9280.jpg","nickname":"刚毅坚卓","note":"","ucode":"6D16E587400F6F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":572709,"discussion_content":"又走隧道了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1652925822,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1018724,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/8b/64/d8bf2f6f.jpg","nickname":"旻言","note":"","ucode":"563E6A83A50EC9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":342396,"discussion_content":"如果能在路由器上自动配置去各个容器网络的路由规则，是不是垮网段访问的问题就不成立，就不会有IPIP这种overlay带来的开销呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1610672790,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":17587,"user_name":"张稀虹","can_delete":false,"product_type":"c1","uid":1000690,"ip_address":"","ucode":"7AD988FE8450E8","user_header":"https://static001.geekbang.org/account/avatar/00/0f/44/f2/e7158fa0.jpg","comment_is_top":false,"comment_ctime":1532760481,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"61662302625","product_id":100007101,"comment_content":"提个建议 老师能不能在下一期文章出来的时候在前一期文章中更新问题的答案，感觉比较深的话题讨论区的讨论就比较少了","like_count":14},{"had_liked":false,"id":17442,"user_name":"mgxian","can_delete":false,"product_type":"c1","uid":1014806,"ip_address":"","ucode":"7B7E77E6A83B87","user_header":"https://static001.geekbang.org/account/avatar/00/0f/7c/16/4d1e5cc1.jpg","comment_is_top":false,"comment_ctime":1532651792,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"48777292048","product_id":100007101,"comment_content":"1.因为公有云中的虚拟机之间 不直接通过交换机互通 中间有路由 使用VPC有可能可以实现<br>2.微服务数据交换现在有两种主流方式 http 和 rpc","like_count":11},{"had_liked":false,"id":32166,"user_name":"斜月浮云","can_delete":false,"product_type":"c1","uid":1008933,"ip_address":"","ucode":"25CECBB175DA02","user_header":"https://static001.geekbang.org/account/avatar/00/0f/65/25/c6de04bc.jpg","comment_is_top":false,"comment_ctime":1539450786,"is_pvip":false,"replies":[{"id":"11850","content":"使用路由，汇聚到物理路由器，物理路由器之间打通","user_name":"作者回复","user_name_real":"刘超@网易云","uid":"1001590","ctime":1539606729,"ip_address":"","comment_id":32166,"utype":1}],"discussion_count":2,"race_medal":1,"score":"31604221858","product_id":100007101,"comment_content":"现在提问还来得及吗？问下ipip模式中，隧道是点到点的？那么如果服务部署到两个或多个局域网，每个局域网有n台机器，那么为了保证互相跨网互通，是否需求全部点对点打隧道？是否资源损毁太大了？怎么优化？","like_count":7,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"刘超","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426661,"discussion_content":"使用路由，汇聚到物理路由器，物理路由器之间打通","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539606729,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1083600,"avatar":"https://static001.geekbang.org/account/avatar/00/10/88/d0/6e75f766.jpg","nickname":"有朋自远方来","note":"","ucode":"23A12829DEB119","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":45033,"discussion_content":"汇聚到物理路由器，也会存在建立隧道过多的问题吧？\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573001195,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":87109,"user_name":"kissingers","can_delete":false,"product_type":"c1","uid":1135299,"ip_address":"","ucode":"615151808CF628","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKzqiaZnBw2myRWY802u48Rw3W2zDtKoFQ6vN63m4FdyjibM21FfaOYe8MbMpemUdxXJeQH6fRdVbZA/132","comment_is_top":false,"comment_ctime":1555512814,"is_pvip":false,"replies":[{"id":"49614","content":"对啊，中间的都适配calico，但是公司网管肯定不干","user_name":"作者回复","user_name_real":"刘超@网易云","uid":"1001590","ctime":1567692996,"ip_address":"","comment_id":87109,"utype":1}],"discussion_count":2,"race_medal":0,"score":"23030349294","product_id":100007101,"comment_content":"我们能想到的第一种方式是，让中间所有的路由器都来适配 Calico。本来它们互相告知路由，只互相告知物理机的，现在还要告知容器的网段。<br><br>这种情况为什么不行?  BGP也能交换容器网段和路由信息吧","like_count":5,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"刘超","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":447314,"discussion_content":"对啊，中间的都适配calico，但是公司网管肯定不干","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567692996,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1073369,"avatar":"https://static001.geekbang.org/account/avatar/00/10/60/d9/829ac53b.jpg","nickname":"fangxuan","note":"","ucode":"3870F2BF5679A2","race_medal":1,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":3373,"discussion_content":"容器都是私网ip，其路由不能在公网上传播吧","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1564446698,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":87888,"user_name":"Tendrun","can_delete":false,"product_type":"c1","uid":1225728,"ip_address":"","ucode":"86AB3C3A7D8381","user_header":"https://static001.geekbang.org/account/avatar/00/12/b4/00/bfc101ee.jpg","comment_is_top":false,"comment_ctime":1555743509,"is_pvip":true,"replies":[{"id":"49578","content":"A-router-B，这样的话，B肯定会告诉A，如果想访问某个容器，router是下一跳，但问题是包到了router，router是物理的呀，他又不知道容器的那个段，他往哪里转发呀。除非router也配置了bgp","user_name":"作者回复","user_name_real":"刘超@网易云","uid":"1001590","ctime":1567689923,"ip_address":"","comment_id":87888,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14440645397","product_id":100007101,"comment_content":"老师您好，不太明白为什么当物理机A、B跨网断中间有多个路由器时不可用。如果路由器都支持BGP的话，且A、B之间可通。那么把A、B配置成bgp对端，应该就可以分发容器的路由，然后跨节点的容器就可以通信了吧","like_count":3,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"刘超","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":447637,"discussion_content":"A-router-B，这样的话，B肯定会告诉A，如果想访问某个容器，router是下一跳，但问题是包到了router，router是物理的呀，他又不知道容器的那个段，他往哪里转发呀。除非router也配置了bgp","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567689923,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":36112,"user_name":"$(CF_HB)","can_delete":false,"product_type":"c1","uid":1135886,"ip_address":"","ucode":"B9665AD85BD96D","user_header":"https://static001.geekbang.org/account/avatar/00/11/55/0e/7c64101d.jpg","comment_is_top":false,"comment_ctime":1540946492,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"14425848380","product_id":100007101,"comment_content":"不是很明白，回去公司打开个wireshark分析一下网络。分析一下路由协议。","like_count":3},{"had_liked":false,"id":24207,"user_name":"silenceper","can_delete":false,"product_type":"c1","uid":1014803,"ip_address":"","ucode":"465FCB5DC8DF7C","user_header":"https://static001.geekbang.org/account/avatar/00/0f/7c/13/58bcac86.jpg","comment_is_top":false,"comment_ctime":1536844186,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10126778778","product_id":100007101,"comment_content":"不支持bgp协议，是不是就用不了calico?","like_count":2},{"had_liked":false,"id":17657,"user_name":"balancer","can_delete":false,"product_type":"c1","uid":1145758,"ip_address":"","ucode":"A865FAFF2FE1FA","user_header":"https://static001.geekbang.org/account/avatar/00/11/7b/9e/37d69ff0.jpg","comment_is_top":false,"comment_ctime":1532848491,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"10122783083","product_id":100007101,"comment_content":"老师，网络数据包到达网卡的时候，内核怎么定位这个数据包属于哪个进程的那个socketfd？","like_count":2,"discussions":[{"author":{"id":1281551,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/pZ5ibu3jOPTfWVtzTeNTiaL2PiabGT2Y2yKd2TNDcZMkIY34T5fhGcSnBjgpkd54Q3S6b3gRW3yYTxZk0QHYB0qnw/132","nickname":"啊树","note":"","ucode":"F1072F4610B6F8","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":581388,"discussion_content":"网卡不管进程的吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1658749027,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":273761,"user_name":"旻言","can_delete":false,"product_type":"c1","uid":1018724,"ip_address":"","ucode":"563E6A83A50EC9","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8b/64/d8bf2f6f.jpg","comment_is_top":false,"comment_ctime":1610672807,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5905640103","product_id":100007101,"comment_content":"<br>如果能在路由器上自动配置去各个容器网络的路由规则，是不是垮网段访问的问题就不成立，就不会有IPIP这种overlay带来的开销呢？","like_count":1},{"had_liked":false,"id":262550,"user_name":"赛飞","can_delete":false,"product_type":"c1","uid":1372006,"ip_address":"","ucode":"189B7A3231B06C","user_header":"https://static001.geekbang.org/account/avatar/00/14/ef/66/dc3f4555.jpg","comment_is_top":false,"comment_ctime":1605765836,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5900733132","product_id":100007101,"comment_content":"作为一名前端工程师，表示听的有点懵了😂","like_count":1},{"had_liked":false,"id":249596,"user_name":"星星⭐","can_delete":false,"product_type":"c1","uid":1531391,"ip_address":"","ucode":"087FF8B7F810F0","user_header":"https://static001.geekbang.org/account/avatar/00/17/5d/ff/b58dd422.jpg","comment_is_top":false,"comment_ctime":1600700222,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5895667518","product_id":100007101,"comment_content":"刘老师，是tun0还是tunl0?","like_count":1,"discussions":[{"author":{"id":1220775,"avatar":"https://static001.geekbang.org/account/avatar/00/12/a0/a7/db7a7c50.jpg","nickname":"送普选","note":"","ucode":"AB2C98BB9C3A5D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":553349,"discussion_content":"应该是tunl0","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1645858153,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":135245,"user_name":"Geek_042531","can_delete":false,"product_type":"c1","uid":1541870,"ip_address":"","ucode":"A42530B8592C77","user_header":"","comment_is_top":false,"comment_ctime":1569082056,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5864049352","product_id":100007101,"comment_content":"公有云使用ipip这样的overlay 技术：1.实现大二层网络，构建突破vlan 4K的限制，2.容器跨3层迁移","like_count":1},{"had_liked":false,"id":57399,"user_name":"俊飞","can_delete":false,"product_type":"c1","uid":1137490,"ip_address":"","ucode":"A67B07520E0715","user_header":"https://static001.geekbang.org/account/avatar/00/11/5b/52/fea5ec99.jpg","comment_is_top":false,"comment_ctime":1546781278,"is_pvip":false,"replies":[{"id":"25768","content":"后来flannel也支持calico的所有模式了","user_name":"作者回复","user_name_real":"刘超@网易云","uid":"1001590","ctime":1551421800,"ip_address":"","comment_id":57399,"utype":1}],"discussion_count":3,"race_medal":0,"score":"5841748574","product_id":100007101,"comment_content":"听了老师讲解明白多了，我们的k8s1.13.0集群里面用到的就是擦calico网络，当时还在纳闷k8s怎么不用flannel网络了，现在明白了，calico网络性能要比flannel高很多，采用ip-in-ip的方式进行隧道通信，安全性也提高不少。","like_count":1,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"刘超","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435561,"discussion_content":"后来flannel也支持calico的所有模式了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551421800,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1256437,"avatar":"https://static001.geekbang.org/account/avatar/00/13/2b/f5/fb28c713.jpg","nickname":"胡文","note":"","ucode":"691082B0C2106E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":233864,"discussion_content":"作者回复: 后来flannel也支持calico的所有模式了 \n\n老师 这块怎么理解？flannel也支持路由模式了吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586949809,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1748520,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/ae/28/95956b48.jpg","nickname":"Fee","note":"","ucode":"662E5BD7A93DBE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1256437,"avatar":"https://static001.geekbang.org/account/avatar/00/13/2b/f5/fb28c713.jpg","nickname":"胡文","note":"","ucode":"691082B0C2106E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":302261,"discussion_content":"对的 现在flannel也支持路由模式的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598861762,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":233864,"ip_address":""},"score":302261,"extra":""}]}]},{"had_liked":false,"id":18036,"user_name":"blackpiglet","can_delete":false,"product_type":"c1","uid":1032928,"ip_address":"","ucode":"58AA8329C91767","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c2/e0/7188aa0a.jpg","comment_is_top":false,"comment_ctime":1533095972,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5828063268","product_id":100007101,"comment_content":"1. 公有云上跨网段的现象很常见，而且如果涉及到跨数据中心，中间会经过很多路由设备，只能通过隧道方式打通连接。<br>2. 微服务间的信息交互主要是 RPC 和 RESTful。","like_count":1},{"had_liked":false,"id":355435,"user_name":"Geek_93970d","can_delete":false,"product_type":"c1","uid":1452167,"ip_address":"北京","ucode":"52AC308BEC7737","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJcwXucibksEYRSYg6icjibzGa7efcMrCsGec2UwibjTd57icqDz0zzkEEOM2pXVju60dibzcnQKPfRkN9g/132","comment_is_top":false,"comment_ctime":1661389767,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1661389767","product_id":100007101,"comment_content":"和 vxlan 有何区别？vxlan 用 udp，IPIP 呢？<br>vxlan 的乘客协议是 二层协议，承载协议是 UDP，通常用于解决具有相同网段但是分布在不同物理机上的 docker 之间的通信（当然如果docker网段不同也是可以的，比如 Flannel）。<br>IPIP 的乘客协议和承载协议都是 IP，即用 IP 封装 IP，用于解决不同物理机上不同网段的 docker 之间的通信，因为是不同网段，所以必然需要通过路由转发，通过两种方式可以实现：要么用物理机当路由器使，要么通过 IPIP 隧道，前一种方式需要限制物理机必须同网段，所以才产生后一种方式。","like_count":0},{"had_liked":false,"id":348511,"user_name":"章潘","can_delete":false,"product_type":"c1","uid":2630632,"ip_address":"","ucode":"1A24E1B3084450","user_header":"https://static001.geekbang.org/account/avatar/00/28/23/e8/9f445339.jpg","comment_is_top":false,"comment_ctime":1655166448,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1655166448","product_id":100007101,"comment_content":"虚拟机网络场景与容器场景其中一个比较大的区别是虚拟机采用了绝对的网络隔离技术，如vlan，vxlan等，所以虚拟机网段重叠很普遍。","like_count":0},{"had_liked":false,"id":322833,"user_name":"linker","can_delete":false,"product_type":"c1","uid":1803259,"ip_address":"","ucode":"6C5799F2FC2C82","user_header":"https://static001.geekbang.org/account/avatar/00/1b/83/fb/621adceb.jpg","comment_is_top":false,"comment_ctime":1637629160,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1637629160","product_id":100007101,"comment_content":"思考题1  有的公有云使用ARP代答，所以获取到的对端虚拟机的Mac地址不是真实的Mac，不能把虚拟机作为一个路由器使用，使用要连接隧道","like_count":0},{"had_liked":false,"id":313895,"user_name":"hao","can_delete":false,"product_type":"c1","uid":1980191,"ip_address":"","ucode":"1FA69BBF5F624C","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erCibehm9W3tbhKic1RnbTvPVCgWDmludx9YQ97BneVRhyegkr13R6vrFPYol4IYEF98s07MicgOtS0g/132","comment_is_top":false,"comment_ctime":1632730427,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1632730427","product_id":100007101,"comment_content":"刘老师，如果用阿里云，需要考虑这些吗？","like_count":0},{"had_liked":false,"id":305181,"user_name":"大方方","can_delete":false,"product_type":"c1","uid":1354013,"ip_address":"","ucode":"621AD8F1485753","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/6cyOoRd2dROgiblAJkW6RLhUyH1wwU0NNibIIuV930eQ9TiaNT41K61kBSVkvYoDYg7mJtuEoCQY1awBmV0WW6BFg/132","comment_is_top":false,"comment_ctime":1627870481,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1627870481","product_id":100007101,"comment_content":"非网络专业从业者，实话实说从第三模块的第五讲开始就已经完全out了，现在都是硬着头皮去尝试理解大概的思路，力争刷过第一遍以后二刷细嚼。","like_count":0},{"had_liked":false,"id":280321,"user_name":"Wheat","can_delete":false,"product_type":"c1","uid":1260141,"ip_address":"","ucode":"7D99EA149B6DE8","user_header":"https://static001.geekbang.org/account/avatar/00/13/3a/6d/910b2445.jpg","comment_is_top":false,"comment_ctime":1614159409,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1614159409","product_id":100007101,"comment_content":"想问下，Calico的IPIP模式，如果每两个物理机都要建立隧道的话，会导致隧道过多成网状结构吗","like_count":0},{"had_liked":false,"id":253930,"user_name":"戴宇","can_delete":false,"product_type":"c1","uid":1185158,"ip_address":"","ucode":"66A56B2D742903","user_header":"https://static001.geekbang.org/account/avatar/00/12/15/86/cd97bf7e.jpg","comment_is_top":false,"comment_ctime":1602949895,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1602949895","product_id":100007101,"comment_content":"我觉得第二个图是不是画得不太准确，和后面那个全连接的图也对不上，从物理机A经过路由规则到172.17.9.0&#47;24不能直接连到物理机B上面吧。这样看起来这个网络包发出去都没有经过物理机A自己的网卡。这里是性能损耗是不是指从docker0到eth0出去做SNAT的性能损耗？","like_count":0},{"had_liked":false,"id":253928,"user_name":"戴宇","can_delete":false,"product_type":"c1","uid":1185158,"ip_address":"","ucode":"66A56B2D742903","user_header":"https://static001.geekbang.org/account/avatar/00/12/15/86/cd97bf7e.jpg","comment_is_top":false,"comment_ctime":1602949550,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1602949550","product_id":100007101,"comment_content":"有疑问，这个calico还是不是overlay 网络， 我查了https:&#47;&#47;docs.projectcalico.org&#47;networking&#47;vxlan-ipip，上面还是说这个calico ipip是一个overlay网络，我也觉得是，因为跨网段要建立隧道，这个隧道就很像GRE。","like_count":0},{"had_liked":false,"id":239828,"user_name":"连边","can_delete":false,"product_type":"c1","uid":1391748,"ip_address":"","ucode":"54B5DA38449728","user_header":"https://static001.geekbang.org/account/avatar/00/15/3c/84/608f679b.jpg","comment_is_top":false,"comment_ctime":1596673988,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1596673988","product_id":100007101,"comment_content":"我觉得，要去部署一下微服务环境，然后回过头来看这些文章，才会有感触。","like_count":0},{"had_liked":false,"id":236276,"user_name":"侯聪","can_delete":false,"product_type":"c1","uid":1170187,"ip_address":"","ucode":"AF64D50054A5BA","user_header":"https://static001.geekbang.org/account/avatar/00/11/db/0b/6aa6f653.jpg","comment_is_top":false,"comment_ctime":1595383043,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1595383043","product_id":100007101,"comment_content":"IPIP模式下的包封装是直接把容器A发出来的payload作为应用层内容吗？ <br>这样的话在物理路由器上不需要支持VXLAN或者Geneve等overlay封装协议了","like_count":0},{"had_liked":false,"id":232638,"user_name":"chenhz","can_delete":false,"product_type":"c1","uid":1078160,"ip_address":"","ucode":"485420EA3282D4","user_header":"https://static001.geekbang.org/account/avatar/00/10/73/90/9118f46d.jpg","comment_is_top":false,"comment_ctime":1594075842,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1594075842","product_id":100007101,"comment_content":"问题1:公有云分配到的 ip 可能不是同一网段的，通过IPIP模式的隧道模式可以实现跨网段的物理机里的容器互联互通；<br>问题2:微服务之间通信协议主要为TCP和HTTP，序列化和反序列化主流方案为为 protobuf 和 JSON，通过注册中心服务发现的机制，通过服务名访问。","like_count":0},{"had_liked":false,"id":230047,"user_name":"老兵","can_delete":false,"product_type":"c1","uid":1471109,"ip_address":"","ucode":"F004F8EC90E5B0","user_header":"https://static001.geekbang.org/account/avatar/00/16/72/85/c337e9a1.jpg","comment_is_top":false,"comment_ctime":1593247103,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1593247103","product_id":100007101,"comment_content":"1. Calico部署到公网使用IPIP模式，主要因为容器或者应用之间可能分布着很多路由，两个应用，或者两个容器无法知道从物理机出来的下一跳是不是目标物理机，所以使用IPIP模式，在机器之间启动一个tunnel。<br>2. 微服务间的传输主要是 RPC 和 RESTful","like_count":0},{"had_liked":false,"id":218645,"user_name":"jackwu","can_delete":false,"product_type":"c1","uid":1192052,"ip_address":"","ucode":"E8192DBF7E2075","user_header":"","comment_is_top":false,"comment_ctime":1589849861,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1589849861","product_id":100007101,"comment_content":"请问 ipip 模式丢包问题有同学遇到过吗？","like_count":0},{"had_liked":false,"id":212784,"user_name":"马以","can_delete":false,"product_type":"c1","uid":1344431,"ip_address":"","ucode":"3FEA06CA14DE28","user_header":"https://static001.geekbang.org/account/avatar/00/14/83/af/1cb42cd3.jpg","comment_is_top":false,"comment_ctime":1588210884,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1588210884","product_id":100007101,"comment_content":"&quot;将这个包从 eth0 发出去，在物理网络上会使用外层的 IP 进行路由，最终到达物理机 B。在物理机 B 上，tun0 会解封装，将内层的源 IP 和目标 IP 拿出来，转发给相应的容器。”<br>最后一段这里，包是从eth0发出去走传统的路由，还是走tun0通道，直接到达物理机B，这里是笔误还是什么？求解答～","like_count":0},{"had_liked":false,"id":195354,"user_name":"King-ZJ","can_delete":false,"product_type":"c1","uid":1915385,"ip_address":"","ucode":"7448A4BBB5A118","user_header":"https://static001.geekbang.org/account/avatar/00/1d/39/f9/b946719a.jpg","comment_is_top":false,"comment_ctime":1585183023,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1585183023","product_id":100007101,"comment_content":"容器跨主机跨网段访问，Calico应用的组合知识点来解决这些通信问题，不管是iptables的还是BGP中，最终组合起来形成解决方案。","like_count":0},{"had_liked":false,"id":153912,"user_name":"fangxuan","can_delete":false,"product_type":"c1","uid":1073369,"ip_address":"","ucode":"3870F2BF5679A2","user_header":"https://static001.geekbang.org/account/avatar/00/10/60/d9/829ac53b.jpg","comment_is_top":false,"comment_ctime":1574329533,"is_pvip":false,"discussion_count":0,"race_medal":1,"score":"1574329533","product_id":100007101,"comment_content":"老师，calico中的bird是不是有限制，如果bgp通告过来的路由下一跳不是bgp邻居的ip，就会把路由标记为不可达？","like_count":0},{"had_liked":false,"id":150360,"user_name":"lyonger","can_delete":false,"product_type":"c1","uid":1313840,"ip_address":"","ucode":"E89A75DADEA2A1","user_header":"https://static001.geekbang.org/account/avatar/00/14/0c/30/bb4bfe9d.jpg","comment_is_top":false,"comment_ctime":1573522784,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1573522784","product_id":100007101,"comment_content":"越到后面越抽象了，要实践老师讲的知识，估计需要从事云计算或容器相关岗位，有业务场景才能理解更深刻。","like_count":0,"discussions":[{"author":{"id":1069452,"avatar":"https://static001.geekbang.org/account/avatar/00/10/51/8c/05aafa1a.jpg","nickname":"mellon","note":"","ucode":"F69C95B3493169","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":65921,"discussion_content":"是的，用到 k8s 的时候会用到 Calico，vxlan 什么的，那时候再理解这些不迟。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1575035013,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":142340,"user_name":"manatee","can_delete":false,"product_type":"c1","uid":1041112,"ip_address":"","ucode":"708D90E7A265BD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/e2/d8/f0562ede.jpg","comment_is_top":false,"comment_ctime":1571357592,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1571357592","product_id":100007101,"comment_content":"想请教一下老师，这个讲的网络都是容器与容器之间的网络，那容器与虚拟机，虚拟机与容器之间的网络是怎么样的呢","like_count":0},{"had_liked":false,"id":129258,"user_name":"程序员大天地","can_delete":false,"product_type":"c1","uid":1249001,"ip_address":"","ucode":"7A21F15FEE2D5B","user_header":"https://static001.geekbang.org/account/avatar/00/13/0e/e9/98b6ea61.jpg","comment_is_top":false,"comment_ctime":1567071813,"is_pvip":false,"replies":[{"id":"48744","content":"很容易自己搭建一个的","user_name":"作者回复","user_name_real":"刘超@网易云","uid":"1001590","ctime":1567493258,"ip_address":"","comment_id":129258,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1567071813","product_id":100007101,"comment_content":"没接触过，看来只有等后面用到才能看懂","like_count":0,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"刘超","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465365,"discussion_content":"很容易自己搭建一个的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567493258,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1367776,"avatar":"https://static001.geekbang.org/account/avatar/00/14/de/e0/54929e12.jpg","nickname":"lx1036","note":"","ucode":"C33D6972930265","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":289940,"discussion_content":"用两台同一网段的虚拟机，都分别部署了docker nginx container，但是想部署calico让这两个nginx container互联互通。搞了很久，没部署成功。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594276389,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":120459,"user_name":"yandongxiao","can_delete":false,"product_type":"c1","uid":1017700,"ip_address":"","ucode":"D397F4DB0109C8","user_header":"https://static001.geekbang.org/account/avatar/00/0f/87/64/3882d90d.jpg","comment_is_top":false,"comment_ctime":1564906721,"is_pvip":false,"replies":[{"id":"46363","content":"谢谢","user_name":"作者回复","user_name_real":"刘超@网易云","uid":"1001590","ctime":1566297134,"ip_address":"","comment_id":120459,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1564906721","product_id":100007101,"comment_content":"超哥给的信息量真的是太大了，越品越精彩。","like_count":0,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"刘超","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":461342,"discussion_content":"谢谢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566297134,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":107840,"user_name":"灯盖","can_delete":false,"product_type":"c1","uid":1482839,"ip_address":"","ucode":"0F8455A593D60C","user_header":"https://static001.geekbang.org/account/avatar/00/16/a0/57/3a729755.jpg","comment_is_top":false,"comment_ctime":1561621253,"is_pvip":false,"discussion_count":0,"race_medal":1,"score":"1561621253","product_id":100007101,"comment_content":"强大","like_count":0},{"had_liked":false,"id":100019,"user_name":"功夫","can_delete":false,"product_type":"c1","uid":1470091,"ip_address":"","ucode":"6F06B5F67E262C","user_header":"https://static001.geekbang.org/account/avatar/00/16/6e/8b/60095195.jpg","comment_is_top":false,"comment_ctime":1559391371,"is_pvip":false,"replies":[{"id":"49213","content":"对的，但是原理还是那么多","user_name":"作者回复","user_name_real":"刘超@网易云","uid":"1001590","ctime":1567603487,"ip_address":"","comment_id":100019,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1559391371","product_id":100007101,"comment_content":"容器 网络越来越抽象类","like_count":0,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"刘超","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":452374,"discussion_content":"对的，但是原理还是那么多","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567603487,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":84705,"user_name":"超超","can_delete":false,"product_type":"c1","uid":1476077,"ip_address":"","ucode":"D0751F29553481","user_header":"https://static001.geekbang.org/account/avatar/00/16/85/ed/905b052f.jpg","comment_is_top":false,"comment_ctime":1554896515,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1554896515","product_id":100007101,"comment_content":"回答问题一：ipip模式由于是走隧道协议，安全性比较好！<br>回答问题二：RPC","like_count":0},{"had_liked":false,"id":77231,"user_name":"江南皮革厂研发中心保安队长","can_delete":false,"product_type":"c1","uid":1099584,"ip_address":"","ucode":"231419643A5CC5","user_header":"https://static001.geekbang.org/account/avatar/00/10/c7/40/66a203cd.jpg","comment_is_top":false,"comment_ctime":1552893557,"is_pvip":false,"replies":[{"id":"50239","content":"现在用restful的多了","user_name":"作者回复","user_name_real":"刘超@网易云","uid":"1001590","ctime":1567827643,"ip_address":"","comment_id":77231,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1552893557","product_id":100007101,"comment_content":"服务之间的通信我们自己http RESTful 风格的比较多 ","like_count":0,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"刘超","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":443647,"discussion_content":"现在用restful的多了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567827643,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1121758,"avatar":"https://static001.geekbang.org/account/avatar/00/11/1d/de/62bfa83f.jpg","nickname":"aoe","note":"","ucode":"1C6201EDB4E954","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":274633,"discussion_content":"老板真的跑了吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590594769,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":76744,"user_name":"丁丁","can_delete":false,"product_type":"c1","uid":1066850,"ip_address":"","ucode":"9D955ED6F547E6","user_header":"https://static001.geekbang.org/account/avatar/00/10/47/62/25a4aeae.jpg","comment_is_top":false,"comment_ctime":1552699806,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1552699806","product_id":100007101,"comment_content":"觉得很高深，学会了会提升好多啊","like_count":0},{"had_liked":false,"id":65468,"user_name":"Dangdang","can_delete":false,"product_type":"c1","uid":1124563,"ip_address":"","ucode":"7042925FBF8CCA","user_header":"https://static001.geekbang.org/account/avatar/00/11/28/d3/85b6534d.jpg","comment_is_top":false,"comment_ctime":1549378578,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1549378578","product_id":100007101,"comment_content":"弱弱的问一句，l2，l3，几层是怎么分的？？？","like_count":0},{"had_liked":false,"id":21805,"user_name":"小宇宙","can_delete":false,"product_type":"c1","uid":1029649,"ip_address":"","ucode":"BBFFC39CB9E26F","user_header":"https://static001.geekbang.org/account/avatar/00/0f/b6/11/e8506a04.jpg","comment_is_top":false,"comment_ctime":1535345609,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1535345609","product_id":100007101,"comment_content":"1 公有云厂商不一定实现大二层网络，容器的宿主机也不一定放在同一个vlan或者网段中，因此要建隧道了，还有一点，建隧道以后还可以实现容器自由迁移，保持容器的mac地址和ip地址不变。","like_count":0},{"had_liked":false,"id":21011,"user_name":"饼子","can_delete":false,"product_type":"c1","uid":1085953,"ip_address":"","ucode":"981A44836A5216","user_header":"https://static001.geekbang.org/account/avatar/00/10/92/01/c723d180.jpg","comment_is_top":false,"comment_ctime":1534864414,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1534864414","product_id":100007101,"comment_content":"1 公有云上面会夸机房使用<br>2 微服务通信，基于tcp的rpc 调用，","like_count":0}]}