{"id":127775,"title":"77 | 将Staffjoy部署到本地Kubernetes环境(上)","content":"<ul>\n<li>\n<p>代码：<a href=\"https://gitee.com/geektime-geekbang/staffjoy\">https://gitee.com/geektime-geekbang/staffjoy</a></p>\n</li>\n<li>\n<p>课件：<a href=\"https://pan.baidu.com/s/1Q7eP3yZ1Vm8J2nhle5RzTQ\">https://pan.baidu.com/s/1Q7eP3yZ1Vm8J2nhle5RzTQ</a> 提取码: 1aeh</p>\n</li>\n</ul>","comments":[{"had_liked":false,"id":273475,"user_name":"草裡菌","can_delete":false,"product_type":"c3","uid":1241514,"ip_address":"","ucode":"E11C630ABA4370","user_header":"https://static001.geekbang.org/account/avatar/00/12/f1/aa/c29def94.jpg","comment_is_top":false,"comment_ctime":1610609081,"is_pvip":false,"replies":[{"id":99755,"content":"谢谢你的Fix⛽️","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1611242580,"ip_address":"","comment_id":273475,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"用了目前（20210113）最新的docker-desktop-for-windows与配套的k8s，用源码中的k8s配置在“kubectl apply -f test”时无法正常执行。最终解决方法是将除了mysql-svc的9个配置文件更改了部分，以faraday-svc.yaml为例：\napiVersion: apps&#47;v1\nkind: Deployment\nmetadata:\n  name: faraday-svc-deployment\nspec:\n  selector:\n    matchLabels:\n      app: faraday-svc\n  replicas: 1\n...\n\n* 更改了apiVersion；增加了spec.selector.matchLabels.app","like_count":5,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":513612,"discussion_content":"谢谢你的Fix⛽️","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1611242580,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1008312,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/b8/0e1b655e.jpg","nickname":"fireshort","note":"","ucode":"10550CA9C6C730","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":594604,"discussion_content":"波波老师，这个为什么不直接更新到git呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1669203809,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":258680,"user_name":"是你","can_delete":false,"product_type":"c3","uid":1597387,"ip_address":"","ucode":"6186AABF20910A","user_header":"https://static001.geekbang.org/account/avatar/00/18/5f/cb/cd5e2f97.jpg","comment_is_top":false,"comment_ctime":1604538607,"is_pvip":false,"replies":[{"id":94572,"content":"这个光从描述很难讲。有可能压测造成服务器过载，然后服务器响应不过来，或者底层网络过载，开始丢包连不通，也可能OS&#47;容器&#47;K8s系统过载。。。。\n\n建议：\n1. 确保测试环境服务器足够强，网络带宽足够，可以考虑用阿里云环境。\n2. 请运维对服务器&#47;网络资源&#47;K8s&#47;容器&#47;JVM性能情况进行监控，还有应用最好加上指标和调用链监控，这样可以更清晰排查具体问题。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1605014279,"ip_address":"","comment_id":258680,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"老师,我们有个springboot服务接口,只是简单的从redis计数. 这个服务如果直接启动 或者运行在docker容器中, 压测这个服务,都没有什么问题. 但是我们部署到k8s中之后, 压测一段时间,应用就收不到请求了,然后过一段时间又接受请求,然后又卡住,如此反复.导致压测性能非常不理想. 这种请求接受不到,会是什么原因呢","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":508725,"discussion_content":"这个光从描述很难讲。有可能压测造成服务器过载，然后服务器响应不过来，或者底层网络过载，开始丢包连不通，也可能OS/容器/K8s系统过载。。。。\n\n建议：\n1. 确保测试环境服务器足够强，网络带宽足够，可以考虑用阿里云环境。\n2. 请运维对服务器/网络资源/K8s/容器/JVM性能情况进行监控，还有应用最好加上指标和调用链监控，这样可以更清晰排查具体问题。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605014279,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":207745,"user_name":"庞小辉","can_delete":false,"product_type":"c3","uid":1381456,"ip_address":"","ucode":"393EF369DDEC7B","user_header":"https://static001.geekbang.org/account/avatar/00/15/14/50/f0e91f78.jpg","comment_is_top":false,"comment_ctime":1587172897,"is_pvip":false,"replies":[{"id":77937,"content":"ES&#47;kibana可以用，可以住在k8s外面，也可以住在k8s里头。\n\n可以参考我在B站上的补充视频《k8s和微服务监控体系》https:&#47;&#47;www.bilibili.com&#47;video&#47;BV1Qi4y1b79r","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1587393346,"ip_address":"","comment_id":207745,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"老师，用了 k8s 部署服务，是不是 es 和 kibana 都不用了？","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492229,"discussion_content":"ES/kibana可以用，可以住在k8s外面，也可以住在k8s里头。\n\n可以参考我在B站上的补充视频《k8s和微服务监控体系》https://www.bilibili.com/video/BV1Qi4y1b79r","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587393346,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":157885,"user_name":"冷吟閑酔","can_delete":false,"product_type":"c3","uid":1214223,"ip_address":"","ucode":"00C535388B488F","user_header":"https://static001.geekbang.org/account/avatar/00/12/87/0f/96f6e2e7.jpg","comment_is_top":false,"comment_ctime":1575276714,"is_pvip":false,"replies":[{"id":60514,"content":"谢谢你提供的热心建议！","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1575286248,"ip_address":"","comment_id":157885,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"连不上数据库的同学看这里:\n记得修改my.conf 配置文件, 并在 bind-address = 127.0.0.1 这一行前面加上#(注释)\n#bind-address = 127.0.0.1\n再重新启动mysqld 就可以成功连接了\n\n如果你使用 macOS , 并且用homebrew 安装的mysql my.conf 会在 &#47;usr&#47;local&#47;etc&#47; 下\n","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":476560,"discussion_content":"谢谢你提供的热心建议！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1575286248,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1193852,"avatar":"https://static001.geekbang.org/account/avatar/00/12/37/7c/ffa62584.jpg","nickname":"猩猩","note":"","ucode":"102ADA39C145CF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":281539,"discussion_content":"用docker启动的mysql怎么弄呢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591761630,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":135013,"user_name":"rabbit","can_delete":false,"product_type":"c3","uid":1651697,"ip_address":"","ucode":"9685AA437E4D49","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIzd8iaqqwRtlFcNyY3Jpb5PobjUaYK2yumibJicrLrVKF2DR7ckWWQEV9VjlXgybyS5JYh6M3qP0Crg/132","comment_is_top":false,"comment_ctime":1568978269,"is_pvip":false,"replies":[{"id":51824,"content":"你好，确认mysql-svc.yaml里头的ip地址更新为你的本机ip地址了吗？\n\n如果还不行，一个变通的方法，可以发布两个mysql服务在k8s中(添加两个mysql的发布文件，注意修改config中的连接字符串)，这样服务和mysql的容器都跑在k8s中，访问应该没有问题。 关于如何在k8s中以Service形式发布mysql容器，可以查一下网上相关资料很多，也可以参考这里的auth-db&#47;movie-db发布文件：https:&#47;&#47;github.com&#47;jskillcloud&#47;MovieApp&#47;tree&#47;master&#47;k8s&#47;testing","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1568984168,"ip_address":"","comment_id":135013,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"波波，我所有 k8s 都启动起来，所有的 deployment 中，只有company-svc-deployment和account-svc-deployment启动不来，好像是mysql-svc 访问有问题。可是本地数据库已经加入本机 ip 权限，对应的 mysql-svc配置的 ip 也已经修改了。不知道为什么...","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":467999,"discussion_content":"你好，确认mysql-svc.yaml里头的ip地址更新为你的本机ip地址了吗？\n\n如果还不行，一个变通的方法，可以发布两个mysql服务在k8s中(添加两个mysql的发布文件，注意修改config中的连接字符串)，这样服务和mysql的容器都跑在k8s中，访问应该没有问题。 关于如何在k8s中以Service形式发布mysql容器，可以查一下网上相关资料很多，也可以参考这里的auth-db/movie-db发布文件：https://github.com/jskillcloud/MovieApp/tree/master/k8s/testing","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1568984168,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1651697,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIzd8iaqqwRtlFcNyY3Jpb5PobjUaYK2yumibJicrLrVKF2DR7ckWWQEV9VjlXgybyS5JYh6M3qP0Crg/132","nickname":"rabbit","note":"","ucode":"9685AA437E4D49","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":19566,"discussion_content":"波波老师，我找到问题所在了。本地数据库启动的时候，默认绑定的是127.0.0.1的 IP 地址，这个样子本地访问没什么问题，但是 k8s  mysql-svc 作service后访问，会报：The last packet sent successfully to the server was 0 milliseconds ago. The driver has not received any packets from the server。只需要将本地 mysql 的绑定地址修改为 0.0.0.0 重启后，问题解决。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1569207315,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":133138,"user_name":"不是云不飘","can_delete":false,"product_type":"c3","uid":1099591,"ip_address":"","ucode":"54DB6199556C49","user_header":"https://static001.geekbang.org/account/avatar/00/10/c7/47/30d4b61e.jpg","comment_is_top":false,"comment_ctime":1568382283,"is_pvip":false,"replies":[{"id":51319,"content":"你有改config.yaml里头的字符？看看是否引入了特殊字符，可以用kubectl apply --dry-run --validate -f config.yaml校验一下","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1568640051,"ip_address":"","comment_id":133138,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"波波老师我在执行kubectl apply -f config.yaml报\nError from server (BadRequest): error when creating &quot;config.yaml&quot;: ConfigMap in version &quot;v1&quot; cannot be handled as a ConfigMap: v1.ConfigMap.Data: ReadString: expects &quot; or n, but found 1, error found in #10 byte of ...|ASSWORD&quot;:123456,&quot;ACC|..., bigger context ...|sion&quot;:&quot;v1&quot;,&quot;data&quot;:{&quot;ACCOUNT_DATASOURCE_PASSWORD&quot;:123456,&quot;ACCOUNT_DATASOURCE_URL&quot;:&quot;jdbc:mysql:&#47;&#47;mysql|...","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":467269,"discussion_content":"你有改config.yaml里头的字符？看看是否引入了特殊字符，可以用kubectl apply --dry-run --validate -f config.yaml校验一下","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1568640051,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1099591,"avatar":"https://static001.geekbang.org/account/avatar/00/10/c7/47/30d4b61e.jpg","nickname":"不是云不飘","note":"","ucode":"54DB6199556C49","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":11458,"discussion_content":"找到问题是mysql密码全数字引起的加个单引号就没问题了。","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1568383819,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1193852,"avatar":"https://static001.geekbang.org/account/avatar/00/12/37/7c/ffa62584.jpg","nickname":"猩猩","note":"","ucode":"102ADA39C145CF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1099591,"avatar":"https://static001.geekbang.org/account/avatar/00/10/c7/47/30d4b61e.jpg","nickname":"不是云不飘","note":"","ucode":"54DB6199556C49","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":281541,"discussion_content":"优秀！！！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591761881,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":11458,"ip_address":"","group_id":0},"score":281541,"extra":""}]}]},{"had_liked":false,"id":131486,"user_name":"JefferLiu","can_delete":false,"product_type":"c3","uid":1213125,"ip_address":"","ucode":"3186C9CCC8AEF6","user_header":"https://static001.geekbang.org/account/avatar/00/12/82/c5/bf83a009.jpg","comment_is_top":false,"comment_ctime":1567764734,"is_pvip":false,"replies":[{"id":49884,"content":"k8s内pod要访问外网的服务，一般都可以采用Service&#47;Endpoints映射方式，具体要看是使用ip还是域名访问，可以参考gcp文档(要翻墙):\n\nhttps:&#47;&#47;cloud.google.com&#47;blog&#47;products&#47;gcp&#47;kubernetes-best-practices-mapping-external-services\n","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1567775061,"ip_address":"","comment_id":131486,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"mysql在远程互联网上怎么办呢？就是pod访问外网该怎么处理呢？\n","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":466478,"discussion_content":"k8s内pod要访问外网的服务，一般都可以采用Service/Endpoints映射方式，具体要看是使用ip还是域名访问，可以参考gcp文档(要翻墙):\n\nhttps://cloud.google.com/blog/products/gcp/kubernetes-best-practices-mapping-external-services\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567775061,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":348928,"user_name":"黄百训","can_delete":false,"product_type":"c3","uid":1003717,"ip_address":"","ucode":"13C4E5F0BDBE98","user_header":"https://static001.geekbang.org/account/avatar/00/0f/50/c5/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1655561424,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"WSL2 ubuntu  &amp; minikube ,  端口转发需要的格式如下：\n\nkubectl -E port-forward {faraday_pod_id} 80:80\n\n否则报错：\n\nkubectl port-forward pod&#47;faraday-svc-deployment-7f56896ddf-q5lv7 80:80\nUnable to listen on port 80: Listeners failed to create with the following errors: [unable to create listener: Error listen tcp4 127.0.0.1:80: bind: permission denied unable to create listener: Error listen tcp6 [::1]:80: bind: permission denied]","like_count":0,"discussions":[{"author":{"id":1132448,"avatar":"https://static001.geekbang.org/account/avatar/00/11/47/a0/f12115b7.jpg","nickname":"Sam.张朝","note":"","ucode":"FB20554D94B250","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":590979,"discussion_content":"fedora  报一样的错误","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1666193010,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":341094,"user_name":"开坦克的贝塔","can_delete":false,"product_type":"c3","uid":1400908,"ip_address":"","ucode":"A0C220A02115E9","user_header":"https://static001.geekbang.org/account/avatar/00/15/60/4c/f2f1cf73.jpg","comment_is_top":false,"comment_ctime":1649342328,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"问一下老师本地mac配置怎么样 内存多大？","like_count":0},{"had_liked":false,"id":336708,"user_name":"你好，Java","can_delete":false,"product_type":"c3","uid":2281842,"ip_address":"","ucode":"4FA103B707B78D","user_header":"","comment_is_top":false,"comment_ctime":1646303243,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"老師應該將mysql也包成鏡像，這樣才能實現一鍵安裝，照這個步驟應該是裝不起來，會讓人生氣","like_count":0}]}