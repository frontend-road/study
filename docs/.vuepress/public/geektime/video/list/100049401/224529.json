{"id":224529,"title":"14 | 网关：用Gateway管理进入网格的流量","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/geektime-servicemesh\">https://gitee.com/geektime-geekbang/geektime-servicemesh</a></p>","comments":[{"had_liked":false,"id":268840,"user_name":"Geek_b70b14","can_delete":false,"product_type":"c3","uid":2184195,"ip_address":"","ucode":"B6B47589E77BCF","user_header":"","comment_is_top":false,"comment_ctime":1608367612,"is_pvip":false,"replies":[{"id":97636,"content":"可能我没说清楚。DR是定义子集的，VS是定义路由的，如果在VS里定义的路由要把请求指向不同的子集，就需要和DR关联起来，那么关联的点就是：\nVS里的route.destination.host -&gt; DR的host。具体仔细看看文档的说明。\nhttps:&#47;&#47;istio.io&#47;latest&#47;docs&#47;reference&#47;config&#47;networking&#47;virtual-service&#47;#Destination\n另外，如果要给一个Gateway关联一个VS，那它们的关联点就是：\ngateway.servers.hosts -&gt; VS.spec.hosts (可以一个和多个)。真实的生产环境一般这样配，gw里的hosts是多个（如多个二级域名对应不同的子系统），而每一个域名对应一个VS（根据path把请求打到不同的api）。","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1608561482,"ip_address":"","comment_id":268840,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"老师您好, 上节留言里看到您说&quot;VS里的hosts指向的就是DR的host&quot;, 而这里VS里的hosts(&quot;abc.k8s.com&quot;)明显与DR的host(details)不一样啊, 希望老师解答下这两个具体什么意思, 有时VS的hosts指的是K8s的Service, 这里又是指定可以进行访问的主机域名, ...， 懵了...","like_count":1,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":512058,"discussion_content":"可能我没说清楚。DR是定义子集的，VS是定义路由的，如果在VS里定义的路由要把请求指向不同的子集，就需要和DR关联起来，那么关联的点就是：\nVS里的route.destination.host -&amp;gt; DR的host。具体仔细看看文档的说明。\nhttps://istio.io/latest/docs/reference/config/networking/virtual-service/#Destination\n另外，如果要给一个Gateway关联一个VS，那它们的关联点就是：\ngateway.servers.hosts -&amp;gt; VS.spec.hosts (可以一个和多个)。真实的生产环境一般这样配，gw里的hosts是多个（如多个二级域名对应不同的子系统），而每一个域名对应一个VS（根据path把请求打到不同的api）。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608561482,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":222531,"user_name":"骨汤鸡蛋面","can_delete":false,"product_type":"c3","uid":1050002,"ip_address":"","ucode":"2AC141A523E710","user_header":"https://static001.geekbang.org/account/avatar/00/10/05/92/b609f7e3.jpg","comment_is_top":false,"comment_ctime":1590829355,"is_pvip":false,"replies":[{"id":82139,"content":"可以，但是你就丧失了对pod的流控能力了。istio流控的核心依赖就是service","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1590915202,"ip_address":"","comment_id":222531,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"老师请教一个问题，从ingress-gateway的原理可以看到，ingress-gateway pod 只是用了下 k8s service的数据，数据包流转并没有真正使用 k8s service，那能够不用 k8s service呢，我们公司内网 pod ip 是直接跟物理机互通的，创建大量的k8s service以及 iptables 有点浪费性能了","like_count":1,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":496831,"discussion_content":"可以，但是你就丧失了对pod的流控能力了。istio流控的核心依赖就是service","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590915202,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1050002,"avatar":"https://static001.geekbang.org/account/avatar/00/10/05/92/b609f7e3.jpg","nickname":"骨汤鸡蛋面","note":"","ucode":"2AC141A523E710","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":276967,"discussion_content":"那我使用headless service可以嘛","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590975793,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":219745,"user_name":"k8svip","can_delete":false,"product_type":"c3","uid":1043470,"ip_address":"","ucode":"89F02243735432","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ec/0e/d64d4663.jpg","comment_is_top":false,"comment_ctime":1590073427,"is_pvip":false,"replies":[{"id":81398,"content":"默认应该是LoadBalancer类型，NodePort是你自己改的？另外这个ip 1.65.15.140是哪里来的我没看到。\n2 个方法，进入kiali去验证下配置有什么问题；\n进入对应pod的envoy（istio-proxy)查看一下浏览器的请求log是什么","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1590306238,"ip_address":"","comment_id":219745,"utype":1}],"discussion_count":5,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"本期作业请老师协助分析下：\n1.  使用的NodePort 方式 访问 istio-ingressgateway  service服务 如下:\n[root@master01 istio]# kubectl get svc -n istio-system |grep ingress\nistio-ingressgateway        NodePort    10.97.147.165    &lt;none&gt;        15020:30474&#47;TCP,80:31356&#47;TCP,443:30789&#47;TCP,15029:31429&#47;TCP,15030:30642&#47;TCP,15031:30512&#47;TCP,15032:31178&#47;TCP,31400:30820&#47;TCP,15443:32566&#47;TCP   13h\n[root@master01 istio]#\n2. 仅允许域名访问\n[root@master01 istio]# cat c-3-3.yaml\napiVersion: networking.istio.io&#47;v1alpha3\nkind: Gateway\nmetadata:\n  name: test-gateway\nspec:\n  selector:\n    istio: ingressgateway\n  servers:\n  - port:\n      number: 80\n      name: http\n      protocol: HTTP\n    hosts:\n    - &quot;abc.k8s.com&quot;\n---\napiVersion: networking.istio.io&#47;v1alpha3\nkind: VirtualService\nmetadata:\n  name: test-gateway\nspec:\n  hosts:\n  - &quot;abc.k8s.com&quot;\n  gateways:\n  - test-gateway\n  http:\n  - match:\n    - uri:\n        prefix: &#47;details\n    - uri:\n        exact: &#47;health\n    route:\n    - destination:\n        host: details\n        port:\n          number: 9080\n[root@master01 istio]#\n这里只允许 abc.k8s.com 访问；\n\n3.  使用curl 访问正常\ncurl -H &quot;Host: abc.k8s.com&quot; http:&#47;&#47;1.65.15.140:31356&#47;health\n{&quot;status&quot;:&quot;Details is healthy&quot;}\n\ncurl -H &quot;Host: abc.k8s.com&quot; http:&#47;&#47;1.65.15.140:31356&#47;details&#47;0\n{&quot;id&quot;:0,&quot;author&quot;:&quot;William Shakespeare&quot;,&quot;year&quot;:1595,&quot;type&quot;:&quot;paperback&quot;,&quot;pages&quot;:200,&quot;publisher&quot;:&quot;PublisherA&quot;,&quot;language&quot;:&quot;English&quot;,&quot;ISBN-10&quot;:&quot;1234567890&quot;,&quot;ISBN-13&quot;:&quot;123-1234567890&quot;}\n\n4. 把IP与域名绑定后，使用浏览器 http:&#47;&#47;abc.k8s.com:31356&#47;details&#47;0 访问404；\n5. 日志写下一个留言\n","like_count":1,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":495930,"discussion_content":"默认应该是LoadBalancer类型，NodePort是你自己改的？另外这个ip 1.65.15.140是哪里来的我没看到。\n2 个方法，进入kiali去验证下配置有什么问题；\n进入对应pod的envoy（istio-proxy)查看一下浏览器的请求log是什么","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590306238,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2184195,"avatar":"","nickname":"Geek_b70b14","note":"","ucode":"B6B47589E77BCF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":334759,"discussion_content":"老师您好, 上节留言里看到您说&#34;VS里的hosts指向的就是DR的host&#34;, 而这里VS里的hosts(&#34;abc.k8s.com&#34;)明显与DR的host(details)不一样啊, 希望老师解答下这两个具体什么意思, 有时VS的hosts指的是K8s的Service, 这里又是指定可以进行访问的主机域名, ...， 懵了... ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1607960772,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1336951,"avatar":"https://static001.geekbang.org/account/avatar/00/14/66/77/194ba21d.jpg","nickname":"ileruza","note":"","ucode":"C3D83DF4230109","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2184195,"avatar":"","nickname":"Geek_b70b14","note":"","ucode":"B6B47589E77BCF","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576291,"discussion_content":"看看官网文档，应该都指的是k8s里的service","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1655395458,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":334759,"ip_address":"","group_id":0},"score":576291,"extra":""}]},{"author":{"id":1954540,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/d2/ec/27de7020.jpg","nickname":"zzz","note":"","ucode":"DF8939F2D953BE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":301746,"discussion_content":"因为没有可解析的DNS\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598623965,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1966619,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/02/1b/4a87b7ce.jpg","nickname":"zf","note":"","ucode":"49FADCB97CD8C9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":283649,"discussion_content":"同学你找到原因了吗？方便加个微信吗？我的微信号FeiLiWei881218","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592320237,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":275590,"user_name":"Geek_b70b14","can_delete":false,"product_type":"c3","uid":2184195,"ip_address":"","ucode":"B6B47589E77BCF","user_header":"","comment_is_top":false,"comment_ctime":1611591257,"is_pvip":false,"replies":[{"id":100096,"content":"VS、DR里不需要设置selector，我理解你说的应该是gateway这个crd里的selector，它对应的是一个叫ingressgateway，本质上是一个LoadBalancer类型的service。","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1611715809,"ip_address":"","comment_id":275590,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"老师请问VS和DR或者其它kind资源类型里的 spec.selector标签指的是deployment, service, pod三者哪个的标签. 非常感谢","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":514409,"discussion_content":"VS、DR里不需要设置selector，我理解你说的应该是gateway这个crd里的selector，它对应的是一个叫ingressgateway，本质上是一个LoadBalancer类型的service。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1611715809,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":273856,"user_name":"b1ue_sky","can_delete":false,"product_type":"c3","uid":1516730,"ip_address":"","ucode":"A041BED5B5C71B","user_header":"https://static001.geekbang.org/account/avatar/00/17/24/ba/d01d8f70.jpg","comment_is_top":false,"comment_ctime":1610697145,"is_pvip":false,"replies":[{"id":99584,"content":"针对整个网格，如果你的集群都由网格覆盖，那2者一致。\n你可以简单的把它理解为和K8s 的Ingress没什么区别","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1610980017,"ip_address":"","comment_id":273856,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"老师，这个网关是针对整个集群的么？整个集群的入流量都经过网关？","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":513835,"discussion_content":"针对整个网格，如果你的集群都由网格覆盖，那2者一致。\n你可以简单的把它理解为和K8s 的Ingress没什么区别","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1610980017,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":265080,"user_name":"Harold","can_delete":false,"product_type":"c3","uid":1168849,"ip_address":"","ucode":"313F3F5869E76B","user_header":"https://static001.geekbang.org/account/avatar/00/11/d5/d1/42de06de.jpg","comment_is_top":false,"comment_ctime":1606754584,"is_pvip":false,"replies":[{"id":96260,"content":"1. 不敢下绝对的结论。但多个实践表明并没有性能问题\n2. 是的","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1606791987,"ip_address":"","comment_id":265080,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"老师，目前生产环境中使用的是nginx ingress。 两个问题\n1. istio gateway+ vs 这种形式在性能和稳定性上可以替代 nginx ingress 了吗？\n2. 出于兼容考虑，如果网关层继续使用nginx ingress，ingress的规则是否不需要变动，还是 ingress -&gt; k8s svc ，需要多做的是为每个应用定义一套 vs + dr 的规则？","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":510794,"discussion_content":"1. 不敢下绝对的结论。但多个实践表明并没有性能问题\n2. 是的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606791987,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":257608,"user_name":"无需昵称","can_delete":false,"product_type":"c3","uid":1686247,"ip_address":"","ucode":"CD0C2D8E611C32","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIuhXBviaVUj8PEIoAjdmnMMUkzI1xVUvxm2icu3DWkszjmLVkXjKGF2RpAER8ztklyVhTCTvnxxfgQ/132","comment_is_top":false,"comment_ctime":1604042163,"is_pvip":false,"replies":[{"id":93856,"content":"kubectl get gw,vs -o yaml 查看一下gateway和virtualservice的配置，贴出来看看，感觉没配置好。","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1604147108,"ip_address":"","comment_id":257608,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"老师， 我的网关工作是正常的，我的sample看起来也是都是正常的，为什么http:&#47;&#47;localhost&#47;productpage 一直是404呢？\nkubectl get svc -n istio-system\nNAME                   TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)                                                      AGE\nistio-ingressgateway   LoadBalancer   10.103.247.147   localhost     15021:31129&#47;TCP,80:32605&#47;TCP,443:32036&#47;TCP,15443:30882&#47;TCP   22h","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":508390,"discussion_content":"kubectl get gw,vs -o yaml 查看一下gateway和virtualservice的配置，贴出来看看，感觉没配置好。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604147108,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":255720,"user_name":"钦开","can_delete":false,"product_type":"c3","uid":1130877,"ip_address":"","ucode":"DE66D83B7F9124","user_header":"https://static001.geekbang.org/account/avatar/00/11/41/7d/21f7f458.jpg","comment_is_top":false,"comment_ctime":1603418062,"is_pvip":false,"replies":[{"id":93496,"content":"是的，你可以通过 k get svc -n istio-system 查看到这个ingressgateway就是一个LoadBalancer类型的service，只不过k8s里你是用ingress-nginx，它这个用的是envoy。","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1603781261,"ip_address":"","comment_id":255720,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"老师，在gateway里面会有一个spec.selector选择为istio:ingressgateway，这个就是我们在istio-system命名空间里面的istio-ingressgateway资源对象，这个东西的作用其实就是我们以前的ingress-nginx吗？用于转发请求的","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":507812,"discussion_content":"是的，你可以通过 k get svc -n istio-system 查看到这个ingressgateway就是一个LoadBalancer类型的service，只不过k8s里你是用ingress-nginx，它这个用的是envoy。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603781261,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":236146,"user_name":"光","can_delete":false,"product_type":"c3","uid":1284618,"ip_address":"","ucode":"BDA7F41566E4FE","user_header":"https://static001.geekbang.org/account/avatar/00/13/9a/0a/6c74e932.jpg","comment_is_top":false,"comment_ctime":1595328507,"is_pvip":false,"replies":[{"id":87525,"content":"Kong做ingress gateway管理入流量，istio管理mesh内部流量，我觉得是比较合理的方案。目前没看到业界有相关的实践，你可以参考下着两篇文章：\nhttps:&#47;&#47;konghq.com&#47;blog&#47;kong-ingress-controller-0-6-released-istio-support-admission-controller-support&#47;\n\nhttps:&#47;&#47;kubernetes.io&#47;blog&#47;2020&#47;03&#47;18&#47;kong-ingress-controller-and-istio-service-mesh&#47;","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1595572286,"ip_address":"","comment_id":236146,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"问下kong怎么和istio结合呢。","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":501961,"discussion_content":"Kong做ingress gateway管理入流量，istio管理mesh内部流量，我觉得是比较合理的方案。目前没看到业界有相关的实践，你可以参考下着两篇文章：\nhttps://konghq.com/blog/kong-ingress-controller-0-6-released-istio-support-admission-controller-support/\n\nhttps://kubernetes.io/blog/2020/03/18/kong-ingress-controller-and-istio-service-mesh/","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595572286,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1336951,"avatar":"https://static001.geekbang.org/account/avatar/00/14/66/77/194ba21d.jpg","nickname":"ileruza","note":"","ucode":"C3D83DF4230109","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576293,"discussion_content":"kong做鉴权，istio做内部流控","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655396063,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":229616,"user_name":"Geek_涛","can_delete":false,"product_type":"c3","uid":1644595,"ip_address":"","ucode":"F1E8C397963E9D","user_header":"","comment_is_top":false,"comment_ctime":1593074891,"is_pvip":false,"replies":[{"id":85007,"content":"“显示给用户看的网页内容” - 我理解你说的是前端的页面吧？这要看你这个页面所获取的数据来自于哪个服务，那么通常它就应该属于这个服务。","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1593333861,"ip_address":"","comment_id":229616,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"老师，我想请问一下，一个web网站里有用户管理，用户管理是一个微服务，显示给用户看的网页内容是不是也需要单独做一个微服务，来调用用户管理这个微服务，谢谢","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":499564,"discussion_content":"“显示给用户看的网页内容” - 我理解你说的是前端的页面吧？这要看你这个页面所获取的数据来自于哪个服务，那么通常它就应该属于这个服务。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1593333861,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":219748,"user_name":"k8svip","can_delete":false,"product_type":"c3","uid":1043470,"ip_address":"","ucode":"89F02243735432","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ec/0e/d64d4663.jpg","comment_is_top":false,"comment_ctime":1590073587,"is_pvip":false,"replies":[{"id":81396,"content":"直接在curl 通过-H试试？日志中NR表示找不到路由","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1590299037,"ip_address":"","comment_id":219748,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100049401,"comment_content":"curl 的日志：\n[2020-05-21T14:58:00.232Z] &quot;GET &#47;details&#47;0 HTTP&#47;1.1&quot; 200 - &quot;-&quot; &quot;-&quot; 0 178 1 1 &quot;192.168.244.128&quot; &quot;curl&#47;7.54.0&quot; &quot;4fcc781c-0fdf-9889-b752-b6e3de8df336&quot; &quot;abc.k8s.com&quot; &quot;192.168.244.74:9080&quot; outbound|9080||details.default.svc.cluster.local 192.168.244.67:49680 192.168.244.67:80 192.168.244.128:52995 - -\n\n# 绑定host后使用浏览器后访问的日志\n[2020-05-21T15:01:42.877Z] &quot;GET &#47;details&#47;0 HTTP&#47;1.1&quot; 404 NR &quot;-&quot; &quot;-&quot; 0 0 0 - &quot;192.168.244.128&quot; &quot;Mozilla&#47;5.0 (Macintosh; Intel Mac OS X 10_14_3) AppleWebKit&#47;537.36 (KHTML, like Gecko) Chrome&#47;81.0.4044.129 Safari&#47;537.36&quot; &quot;a0f3482c-0280-976e-9c47-ad4a0207d351&quot; &quot;abc.k8s.com:31356&quot; &quot;-&quot; - - 192.168.244.67:80 192.168.244.128:54128 - -\n\n原因是什么呢？ 请老师解答下，先谢谢了。","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":495932,"discussion_content":"直接在curl 通过-H试试？日志中NR表示找不到路由","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590299037,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":214412,"user_name":"谭公子","can_delete":false,"product_type":"c3","uid":1351191,"ip_address":"","ucode":"3B58196C5BEFCC","user_header":"https://static001.geekbang.org/account/avatar/00/14/9e/17/0d4575a6.jpg","comment_is_top":false,"comment_ctime":1588743092,"is_pvip":false,"replies":[{"id":79432,"content":"我理解你可能是想这样做：\napiVersion: networking.istio.io&#47;v1alpha3\nkind: Gateway\nmetadata:\n  name: my-gateway\n  namespace: xxx\nspec:\n  selector:\n    app: my-gateway-controller  # your service\n  servers:\n  - port:\n      number: 8080\n      name: http\n      protocol: HTTP\n    hosts:\n    - &quot;*&quot;\n","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1588772892,"ip_address":"","comment_id":214412,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100049401,"comment_content":"这里用了默认安装的网关Service来为Gateway对接外部的，因此要使用80端口。现在如果我不想用80端口，那要怎么处理？我如何在istio1.5里自定义网关的Service？","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":494046,"discussion_content":"我理解你可能是想这样做：\napiVersion: networking.istio.io/v1alpha3\nkind: Gateway\nmetadata:\n  name: my-gateway\n  namespace: xxx\nspec:\n  selector:\n    app: my-gateway-controller  # your service\n  servers:\n  - port:\n      number: 8080\n      name: http\n      protocol: HTTP\n    hosts:\n    - &amp;quot;*&amp;quot;\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588772892,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":214260,"user_name":"Geek_965dd3","can_delete":false,"product_type":"c3","uid":1523169,"ip_address":"","ucode":"5F69938878300B","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/2OmKwqCd8Ma5aib1pbtM9R773G0zoCQQZA7SdIXiaicD1ZIVDibSia41sxu9Hrp43eiceImSre3hVqRLGF7TiajqHIPHA/132","comment_is_top":false,"comment_ctime":1588686827,"is_pvip":false,"replies":[{"id":79419,"content":"可以了解一下gloo","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1588767644,"ip_address":"","comment_id":214260,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100049401,"comment_content":"istio提供的网关是router模式的envoy，本身不像kong等拥有完整的网关能力。目前我看到比较靠谱的做法是kong + envoy实现外部流量治理，这方面还是蛮麻烦的。","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":494004,"discussion_content":"可以了解一下gloo","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588767644,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":210423,"user_name":"傻笑","can_delete":false,"product_type":"c3","uid":1612872,"ip_address":"","ucode":"7949B793497841","user_header":"https://static001.geekbang.org/account/avatar/00/18/9c/48/74ab50a0.jpg","comment_is_top":false,"comment_ctime":1587742423,"is_pvip":false,"replies":[{"id":78419,"content":"鉴权会在后面的安全课程中介绍。\n你所说的APP版本控制是具体想控制什么呢？路由还是？","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1587805402,"ip_address":"","comment_id":210423,"utype":1}],"discussion_count":3,"race_medal":0,"score":3,"product_id":100049401,"comment_content":"老师，你好。网络入口除了基础的通讯功能之外，还有一些其他的应用层功能需求，如：用户鉴权、APP版本控制等怎么处理？","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493020,"discussion_content":"鉴权会在后面的安全课程中介绍。\n你所说的APP版本控制是具体想控制什么呢？路由还是？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587805402,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1612872,"avatar":"https://static001.geekbang.org/account/avatar/00/18/9c/48/74ab50a0.jpg","nickname":"傻笑","note":"","ucode":"7949B793497841","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":248609,"discussion_content":"app端每次访问header会携带版本号的信息。想在网关层面拦截判断是否需要强制升级，需要访问版本微服务","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587880519,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1087243,"avatar":"https://static001.geekbang.org/account/avatar/00/10/97/0b/a943bcb3.jpg","nickname":"zhou","note":"","ucode":"E1CE8575B3F106","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1612872,"avatar":"https://static001.geekbang.org/account/avatar/00/18/9c/48/74ab50a0.jpg","nickname":"傻笑","note":"","ucode":"7949B793497841","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":594470,"discussion_content":"这个我觉得你程序自己判断比较合适，不然每次发布都要修改网关里的版本转发规则","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1669076733,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":248609,"ip_address":"浙江","group_id":0},"score":594470,"extra":""}]}]},{"had_liked":false,"id":349921,"user_name":"七步","can_delete":false,"product_type":"c3","uid":1139113,"ip_address":"","ucode":"F7ECEB9250B7CB","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/W2O5VwL8wN6VIGPGCHIBIFuzhwG3Jic5Y90E049bLmxst9L67fhIDUNVlRpVqBfAG3Ykn2Rzl8EFiczWv0IVcLVw/132","comment_is_top":false,"comment_ctime":1656427525,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100049401,"comment_content":"老师问一下，book应用部署到其他命名空间是否可以","like_count":0},{"had_liked":false,"id":328019,"user_name":"Alfie","can_delete":false,"product_type":"c3","uid":2377584,"ip_address":"","ucode":"5B91B9D850E12A","user_header":"https://static001.geekbang.org/account/avatar/00/24/47/70/38df97ac.jpg","comment_is_top":false,"comment_ctime":1640484323,"is_pvip":false,"replies":null,"discussion_count":2,"race_medal":0,"score":3,"product_id":100049401,"comment_content":"视频中讲到select指向网关 Pod，但我查看其实指向 svc\n# kubectl apply -f - &lt;&lt;EOF\napiVersion: networking.istio.io&#47;v1alpha3\nkind: Gateway\nmetadata:\n  name: test-gateway          # 网关名称\nspec:\n  selector:                   \n    istio: ingressgateway\n  servers:\n\n# kubectl get svc -n istio-system  --show-labels \nistio-ingressgateway   NodePort    10.43.85.74     &lt;none&gt;        15021:31732&#47;TCP,80:32291&#47;TCP,443:30262&#47;TCP,31400:31810&#47;TCP,15443:31154&#47;TCP   12h   app=istio-ingressgateway,install.operator.istio.io&#47;owning-resource-namespace=istio-system,install.operator.istio.io&#47;owning-resource=unknown,istio.io&#47;rev=default,istio=ingressgateway,operator.istio.io&#47;component=IngressGateways,operator.istio.io&#47;managed=Reconcile,operator.istio.io&#47;version=1.12.1,release=istio","like_count":0,"discussions":[{"author":{"id":1087243,"avatar":"https://static001.geekbang.org/account/avatar/00/10/97/0b/a943bcb3.jpg","nickname":"zhou","note":"","ucode":"E1CE8575B3F106","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":594469,"discussion_content":"肯定svc，pod名字会发生变化的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1669076089,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"浙江","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":544018,"discussion_content":"是的，口误","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641380089,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}