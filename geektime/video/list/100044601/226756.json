{"id":226756,"title":"36 | HttpClientFactory：管理向外请求的最佳实践","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/NET-Core\">https://gitee.com/geektime-geekbang/NET-Core</a></p>","comments":[{"had_liked":false,"id":212681,"user_name":"dao","can_delete":false,"product_type":"c3","uid":1087879,"ip_address":"","ucode":"4181FB270462CF","user_header":"https://static001.geekbang.org/account/avatar/00/10/99/87/5066026c.jpg","comment_is_top":false,"comment_ctime":1588174835,"is_pvip":false,"replies":[{"id":80596,"content":"对于DNS几乎不变更的内部服务，可以设置长一些，太短的话，链接会频繁回收重建，对性能有比较大的影响","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1589684025,"ip_address":"","comment_id":212681,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"老师,问一下 SetHandlerLifetime(TimeSpan.FromMinutes(10)),这个设置会有什么影响?高并发的情况下,设置多长时间适宜?","like_count":2,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493581,"discussion_content":"对于DNS几乎不变更的内部服务，可以设置长一些，太短的话，链接会频繁回收重建，对性能有比较大的影响","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589684025,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":229898,"user_name":"胡晗","can_delete":false,"product_type":"c3","uid":2043889,"ip_address":"","ucode":"47291A5D08FC5B","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/2ZJdH4WibYqvK4fRyk2KqibJicDqlXsCsWJLcNEvQjrKmkBcLVFJWlj2IH5ZiczFFSbHm5ibydtLKngFl0RicicSL5lhg/132","comment_is_top":false,"comment_ctime":1593181030,"is_pvip":false,"replies":[{"id":86001,"content":"不会的，httpclient的大部分请求方法都是线程安全的","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1594222138,"ip_address":"","comment_id":229898,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"老师你好，type模式里 直接使用httpclient会不会有并发的问题呢？在FrameWork框架下httpclient的并发支持不是很好，在core下会存在这个问题吗","like_count":1,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":499688,"discussion_content":"不会的，httpclient的大部分请求方法都是线程安全的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594222138,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":226661,"user_name":"Geek_47ee54","can_delete":false,"product_type":"c3","uid":2035909,"ip_address":"","ucode":"209906F7DFD460","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJOUjOGRlYNY0fjcw9geZ72W8KHL2Phn90iasWK5DpdW7P3h2qrINwZdXVX21Q5EpHXdbABFTu7VlQ/132","comment_is_top":false,"comment_ctime":1592181335,"is_pvip":false,"replies":[{"id":86007,"content":"数据库结构ef core可以自动生成，因此没有放","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1594222854,"ip_address":"","comment_id":226661,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"请问下，github上有没有数据库文件","like_count":1,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":498323,"discussion_content":"数据库结构ef core可以自动生成，因此没有放","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594222854,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":216328,"user_name":"沈","can_delete":false,"product_type":"c3","uid":1045368,"ip_address":"","ucode":"6BB452D97C50A5","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f3/78/258fdd1f.jpg","comment_is_top":false,"comment_ctime":1589243081,"is_pvip":false,"replies":[{"id":80582,"content":"baseAddress表示一个客户端，不同的服务，你要构造不同的client，分别配置baseAddress。\n配置放在配置文件或者配置中心。","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1589682398,"ip_address":"","comment_id":216328,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"生产环境中也是这样固化baseAddresss？","like_count":1,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":494776,"discussion_content":"baseAddress表示一个客户端，不同的服务，你要构造不同的client，分别配置baseAddress。\n配置放在配置文件或者配置中心。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589682398,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":209250,"user_name":"Geek_7c4953","can_delete":false,"product_type":"c3","uid":1809168,"ip_address":"","ucode":"359745D4725D4F","user_header":"","comment_is_top":false,"comment_ctime":1587523762,"is_pvip":false,"replies":[{"id":79664,"content":"可以构造一个options对象，这个在第一部分讲解过使用选项框架，将配置的信息强类型化注入进去","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1588944292,"ip_address":"","comment_id":209250,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"当TypedXxxServiceClient需要其他参数参数的时候，要怎么注入参数呢？比如说请求需要key和secret交换的token，key和secret要怎么注入进这个Client？","like_count":1,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492750,"discussion_content":"可以构造一个options对象，这个在第一部分讲解过使用选项框架，将配置的信息强类型化注入进去","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588944292,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":244782,"discussion_content":"参数注入是啥意思？如果是想传token的话，可以直接传给相应的client，或者搞一个注解做处理。不知道是不是这个意思。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587630178,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":208819,"user_name":"公号:阿Q看世界","can_delete":false,"product_type":"c3","uid":1095682,"ip_address":"","ucode":"5BB20D829789D6","user_header":"https://static001.geekbang.org/account/avatar/00/10/b8/02/b2268557.jpg","comment_is_top":false,"comment_ctime":1587443013,"is_pvip":false,"replies":[{"id":79647,"content":"类型化的模式，就不直接依赖httpclientfactory，但实际上你注入进去的httpclient实例，仍然是由httpclientfactory构造的。","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1588942361,"ip_address":"","comment_id":208819,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"推荐使用type模式，那不需要使用httpclientfactory进行管理了吗？？","like_count":1,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492637,"discussion_content":"类型化的模式，就不直接依赖httpclientfactory，但实际上你注入进去的httpclient实例，仍然是由httpclientfactory构造的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588942361,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1809168,"avatar":"","nickname":"Geek_7c4953","note":"","ucode":"359745D4725D4F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":243158,"discussion_content":"内部还是httpclientfactory进行分配","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1587525077,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":244791,"discussion_content":"内部还是基于httpclientfactory进行分配","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587631039,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":208988,"user_name":"Amy","can_delete":false,"product_type":"c3","uid":1151869,"ip_address":"","ucode":"22ABF84ACD1F77","user_header":"https://static001.geekbang.org/account/avatar/00/11/93/7d/177bf48a.jpg","comment_is_top":false,"comment_ctime":1587478371,"is_pvip":true,"replies":[{"id":79644,"content":"感谢支持","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1588941952,"ip_address":"","comment_id":208988,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"终于等到啦。。。","like_count":0,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492694,"discussion_content":"感谢支持","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588941952,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":208644,"user_name":"西航","can_delete":false,"product_type":"c3","uid":1210722,"ip_address":"","ucode":"1C8DDAA947D9E9","user_header":"https://static001.geekbang.org/account/avatar/00/12/79/62/871148de.jpg","comment_is_top":false,"comment_ctime":1587395556,"is_pvip":false,"replies":[{"id":79648,"content":"感谢支持","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1588942370,"ip_address":"","comment_id":208644,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"终于等到你","like_count":0,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492558,"discussion_content":"感谢支持","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588942370,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":208631,"user_name":"鄢国平 Bryan","can_delete":false,"product_type":"c3","uid":1604591,"ip_address":"","ucode":"0596BE7237FB8A","user_header":"https://static001.geekbang.org/account/avatar/00/18/7b/ef/db327aa3.jpg","comment_is_top":false,"comment_ctime":1587393232,"is_pvip":false,"replies":[{"id":79649,"content":"感谢支持","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1588942375,"ip_address":"","comment_id":208631,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"👍","like_count":0,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492549,"discussion_content":"感谢支持","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588942375,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":208462,"user_name":"一起跑圈","can_delete":false,"product_type":"c3","uid":1876689,"ip_address":"","ucode":"22F42FAD38021B","user_header":"","comment_is_top":false,"comment_ctime":1587364399,"is_pvip":false,"replies":[{"id":79650,"content":"感谢支持","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1588942380,"ip_address":"","comment_id":208462,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"终于等到你，哈哈😄","like_count":0,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492465,"discussion_content":"感谢支持","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588942380,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":234636,"user_name":"Geek_1d4f70","can_delete":false,"product_type":"c3","uid":1808484,"ip_address":"","ucode":"9A814621A2BC50","user_header":"","comment_is_top":false,"comment_ctime":1594739014,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100044601,"comment_content":"httpclient请求的API访求要求有入参的，怎么处理？","like_count":1},{"had_liked":false,"id":389465,"user_name":"喻","can_delete":false,"product_type":"c3","uid":2759619,"ip_address":"上海","ucode":"D9A5993592A2E5","user_header":"https://static001.geekbang.org/account/avatar/00/2a/1b/c3/a979d3c8.jpg","comment_is_top":false,"comment_ctime":1712668030,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100044601,"comment_content":"github","like_count":0},{"had_liked":false,"id":330430,"user_name":"果冻栋吖","can_delete":false,"product_type":"c3","uid":1808764,"ip_address":"","ucode":"900817D966C3E4","user_header":"https://static001.geekbang.org/account/avatar/00/1b/99/7c/abcd36bb.jpg","comment_is_top":false,"comment_ctime":1641975870,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100044601,"comment_content":"老师我这边有个问题，就是使用这种方式的时候，过一段时间，就会报错。\n我的代码是：https:&#47;&#47;github.com&#47;jellydong&#47;LJDAPP\n报错信息为：\nSystem.InvalidOperationException:“The &#39;InnerHandler&#39; property must be null. &#39;DelegatingHandler&#39; instances provided to &#39;HttpMessageHandlerBuilder&#39; must not be reused or cached.\nHandler: &#39;Ly.Admin.Web.DelegatingHandlers.LyAdminRequestDelegatingHandler&#39;”","like_count":0},{"had_liked":false,"id":317264,"user_name":"娟子","can_delete":false,"product_type":"c3","uid":1743677,"ip_address":"","ucode":"9C422F4D3E6EE2","user_header":"https://static001.geekbang.org/account/avatar/00/1a/9b/3d/5ae9d35d.jpg","comment_is_top":false,"comment_ctime":1634727015,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100044601,"comment_content":"老师，请教一个问题：当我们的一个api通过httpclient调用一个第三方api时，出现connection reset by peer的问题，请问原因会是什么呢？谢谢！","like_count":0}]}