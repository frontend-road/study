{"id":399700,"title":"34 | ä»“åº“ç®¡ç†ï¼šå¦‚ä½•å®ç°æ–‡ä»¶çš„å…­å¤§åŸºæœ¬æ“ä½œï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯LMOSã€‚</p><p>æˆ‘ä»¬åœ¨ä¸Šä¸€èŠ‚è¯¾ä¸­ï¼Œå·²ç»å»ºç«‹äº†ä»“åº“ï¼Œå¹¶å¯¹ä»“åº“è¿›è¡Œäº†åˆ’åˆ†ï¼Œå°±æ˜¯æ–‡ä»¶ç³»ç»Ÿçš„æ ¼å¼åŒ–ã€‚æœ‰äº†ä»“åº“å°±éœ€è¦å¾€é‡Œé¢å­˜å–ä¸œè¥¿ï¼Œå¯¹äºæˆ‘ä»¬çš„ä»“åº“æ¥è¯´ï¼Œå°±æ˜¯å­˜å–åº”ç”¨ç¨‹åºçš„æ–‡ä»¶ã€‚</p><p>æ‰€ä»¥ä»Šå¤©æˆ‘ä»¬è¦ç»™ä»“åº“å¢åŠ ä¸€äº›ç›¸å…³çš„æ“ä½œï¼Œè¿™äº›æ“ä½œä¸»è¦ç”¨äºæ–°å»ºã€æ‰“å¼€ã€å…³é—­ã€è¯»å†™æ–‡ä»¶ï¼Œå®ƒä»¬ä¹Ÿæ˜¯æ–‡ä»¶ç³»ç»Ÿçš„æ ‡å‡†åŠŸèƒ½ï¼Œè‡ªç„¶å³ä½¿æˆ‘ä»¬è¿™ä¸ªæœ€å°çš„æ–‡ä»¶ç³»ç»Ÿï¼Œä¹Ÿå¿…é¡»è¦æ”¯æŒã€‚</p><p>å¥½äº†ï¼Œè¯ä¸å¤šè¯´ï¼Œæˆ‘ä»¬å¼€å§‹å§ã€‚è¿™èŠ‚è¯¾çš„é…å¥—ä»£ç ï¼Œä½ å¯ä»¥ä»<a href=\"https://gitee.com/lmos/cosmos/tree/master/lesson34/Cosmos\">è¿™é‡Œ</a>ä¸‹è½½ã€‚</p><h2>è¾…åŠ©æ“ä½œ</h2><p>é€šè¿‡ä¸Šä¸€èŠ‚è¯¾çš„å­¦ä¹ ï¼Œæˆ‘ä»¬äº†è§£äº†æ–‡ä»¶ç³»ç»Ÿæ ¼å¼åŒ–æ“ä½œï¼Œä¸éš¾å‘ç°æ–‡ä»¶ç³»ç»Ÿæ ¼å¼åŒ–å¹¶ä¸å¤æ‚ï¼Œä½†æ˜¯å®ƒä»¬éœ€è¦å¤§é‡çš„è¾…åŠ©å‡½æ•°ã€‚åŒæ ·çš„ï¼Œå®Œæˆæ–‡ä»¶ç›¸å…³çš„æ“ä½œï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦å¤§é‡çš„è¾…åŠ©å‡½æ•°ã€‚ä¸ºäº†è®©ä½ æ›´åŠ æ¸…æ¥šæ¯ä¸ªå®ç°ç»†èŠ‚ï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆæ¥å®ç°æ–‡ä»¶æ“ä½œç›¸å…³çš„è¾…åŠ©å‡½æ•°ã€‚</p><h3>æ“ä½œæ ¹ç›®å½•æ–‡ä»¶</h3><p>æ ¹æ®æˆ‘ä»¬æ–‡ä»¶ç³»ç»Ÿçš„è®¾è®¡ï¼Œä¸ç®¡æ˜¯æ–°å»ºã€åˆ é™¤ã€æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œé¦–å…ˆéƒ½è¦æ‰¾åˆ°ä¸è¯¥æ–‡ä»¶å¯¹åº”çš„rfsdir_tç»“æ„ã€‚</p><p>åœ¨æˆ‘ä»¬çš„æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œä¸€ä¸ªæ–‡ä»¶çš„rfsdir_tç»“æ„å°±å‚¨å­˜åœ¨æ ¹ç›®å½•æ–‡ä»¶ä¸­ï¼Œæ‰€ä»¥æƒ³è¦è¯»å–æ–‡ä»¶å¯¹åº”çš„rfsdir_tç»“æ„ï¼Œé¦–å…ˆå°±è¦è·å–å’Œé‡Šæ”¾æ ¹ç›®å½•æ–‡ä»¶ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬æ¥å®ç°è·å–å’Œé‡Šæ”¾æ ¹ç›®å½•æ–‡ä»¶çš„å‡½æ•°ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>//è·å–æ ¹ç›®å½•æ–‡ä»¶\nvoid* get_rootdirfile_blk(device_t* devp)\n{\n    void* retptr = NULL;  \n    rfsdir_t* rtdir = get_rootdir(devp);//è·å–æ ¹ç›®å½•æ–‡ä»¶çš„rfsdir_tç»“æ„\n    //åˆ†é…4KBå¤§å°çš„ç¼“å†²åŒºå¹¶æ¸…é›¶\n    void* buf = new_buf(FSYS_ALCBLKSZ);\n    hal_memset(buf, FSYS_ALCBLKSZ, 0);\n    //è¯»å–æ ¹ç›®å½•æ–‡ä»¶çš„é€»è¾‘å‚¨å­˜å—åˆ°ç¼“å†²åŒºä¸­\n    read_rfsdevblk(devp, buf, rtdir-&gt;rdr_blknr)\n    retptr = buf;//è®¾ç½®ç¼“å†²åŒºçš„é¦–åœ°å€ä¸ºè¿”å›å€¼\n    goto errl1;\nerrl:\n    del_buf(buf, FSYS_ALCBLKSZ);\nerrl1:\n    del_rootdir(devp, rtdir);//é‡Šæ”¾æ ¹ç›®å½•æ–‡ä»¶çš„rfsdir_tç»“æ„\n    return retptr;\n}\n//é‡Šæ”¾æ ¹ç›®å½•æ–‡ä»¶\nvoid del_rootdirfile_blk(device_t* devp,void* blkp)\n{\n    //å› ä¸ºé€»è¾‘å‚¨å­˜å—çš„å¤´512å­—èŠ‚çš„ç©ºé—´ä¸­ï¼Œä¿å­˜çš„å°±æ˜¯fimgrhd_tç»“æ„\n    fimgrhd_t* fmp = (fimgrhd_t*)blkp;\n    //æŠŠæ ¹ç›®å½•æ–‡ä»¶å›å†™åˆ°å‚¨å­˜è®¾å¤‡ä¸­å»ï¼Œå—å·ä¸ºfimgrhd_tç»“æ„è‡ªèº«æ‰€åœ¨çš„å—å·\n    write_rfsdevblk(devp, blkp, fmp-&gt;fmd_sfblk)\n    //é‡Šæ”¾ç¼“å†²åŒº\n    del_buf(blkp, FSYS_ALCBLKSZ); \n    return;\n}\n</code></pre><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œget_rootdirå‡½æ•°çš„ä½œç”¨å°±æ˜¯è¯»å–æ–‡ä»¶ç³»ç»Ÿè¶…çº§å—ä¸­rfsdir_tç»“æ„åˆ°ä¸€ä¸ªç¼“å†²åŒºä¸­ï¼Œdel_rootdirå‡½æ•°åˆ™æ˜¯ç”¨æ¥é‡Šæ”¾è¿™ä¸ªç¼“å†²åŒºï¼Œå…¶ä»£ç éå¸¸ç®€å•ï¼Œæˆ‘å·²ç»å¸®ä½ å†™å¥½äº†ã€‚</p><!-- [[[read_end]]] --><p>è·å–æ ¹ç›®å½•æ–‡ä»¶çš„æ–¹æ³•ä¹Ÿå¾ˆå®¹æ˜“ï¼Œæ ¹æ®è¶…çº§å—ä¸­çš„rfsdir_tç»“æ„ä¸­çš„ä¿¡æ¯ï¼Œè¯»å–æ ¹ç›®å½•æ–‡ä»¶çš„é€»è¾‘å‚¨å­˜å—å°±è¡Œäº†ã€‚è€Œé‡Šæ”¾æ ¹ç›®å½•æ–‡ä»¶ï¼Œå°±æ˜¯æŠŠæ ¹ç›®å½•æ–‡ä»¶çš„å‚¨å­˜å—å›å†™åˆ°å‚¨å­˜è®¾å¤‡ä¸­å»ï¼Œæœ€åé‡Šæ”¾å¯¹åº”çš„ç¼“å†²åŒºå°±å¯ä»¥äº†ã€‚</p><h3>è·å–æ–‡ä»¶å</h3><p>ä¸‹é¢æˆ‘ä»¬æ¥å®ç°è·å–æ–‡ä»¶åï¼Œåœ¨æˆ‘ä»¬çš„å°è±¡ä¸­ï¼Œä¸€ä¸ªå®Œæ•´çš„æ–‡ä»¶ååº”è¯¥æ˜¯è¿™æ ·çš„â€œ/cosmos/drivers/drvrfs.câ€ï¼Œè¿™æ ·çš„æ–‡ä»¶ååŒ…å«äº†å®Œæ•´ç›®å½•è·¯å¾„ã€‚</p><p>é™¤äº†ç¬¬ä¸€ä¸ªâ€œ/â€æ˜¯æ ¹ç›®å½•å¤–ï¼Œå…¶å®ƒçš„â€œ/â€åªæ˜¯ä¸€ä¸ªç›®å½•è·¯å¾„åˆ†éš”ç¬¦ã€‚ç„¶è€Œï¼Œåœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼Œæˆ‘ä»¬é€šå¸¸éœ€è¦æŠŠç›®å½•è·¯å¾„åˆ†éš”ç¬¦å»é™¤ï¼Œæå–å…¶ä¸­çš„ç›®å½•åç§°æˆ–è€…æ–‡ä»¶åç§°ã€‚ä¸ºäº†ç®€åŒ–é—®é¢˜ï¼Œæˆ‘ä»¬å¯¹æ–‡ä»¶ç³»ç»Ÿæ¥ç‚¹é™åˆ¶ï¼Œæˆ‘ä»¬çš„æ–‡ä»¶ååªèƒ½æ˜¯â€œ/xxxxâ€è¿™ç§ç±»å‹çš„ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬å°±æ¥å®ç°å»é™¤è·¯å¾„åˆ†éš”ç¬¦æå–æ–‡ä»¶åç§°çš„å‡½æ•°ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>//æ£€æŸ¥æ–‡ä»¶è·¯å¾„å\nsint_t rfs_chkfilepath(char_t* fname)\n{\n    char_t* chp = fname;\n    //æ£€æŸ¥æ–‡ä»¶è·¯å¾„åçš„ç¬¬ä¸€ä¸ªå­—ç¬¦æ˜¯å¦ä¸ºâ€œ/â€ï¼Œä¸æ˜¯åˆ™è¿”å›2\n    if(chp[0] != '/') { return 2; }\n    for(uint_t i = 1; ; i++)\n    {\n        //æ£€æŸ¥é™¤ç¬¬1ä¸ªå­—ç¬¦å¤–å…¶å®ƒå­—ç¬¦ä¸­è¿˜æœ‰æ²¡æœ‰ä¸ºâ€œ/â€çš„ï¼Œæœ‰å°±è¿”å›3\n        if(chp[i] == '/') { return 3; }\n        //å¦‚æœè¿™é‡Œiå¤§äºç­‰äºæ–‡ä»¶åç§°çš„æœ€å¤§é•¿åº¦ï¼Œå°±è¿”å›4\n        if(i &gt;= DR_NM_MAX) { return 4; }\n        //åˆ°æ–‡ä»¶è·¯å¾„å­—ç¬¦ä¸²çš„æœ«å°¾å°±è·³å‡ºå¾ªç¯\n        if(chp[i] == 0 &amp;&amp; i &gt; 1) { break; }\n    }\n    //è¿”å›0è¡¨ç¤ºæ­£ç¡®\n    return 0;\n}\n//æå–çº¯æ–‡ä»¶å\nsint_t rfs_ret_fname(char_t* buf,char_t* fpath)\n{\n    //æ£€æŸ¥æ–‡ä»¶è·¯å¾„åæ˜¯ä¸æ˜¯â€œ/xxxxâ€çš„å½¢å¼\n    sint_t stus = rfs_chkfilepath(fpath);\n    //å¦‚æœä¸ä¸º0å°±ç›´æ¥è¿”å›è¿™ä¸ªçŠ¶æ€å€¼è¡¨ç¤ºé”™è¯¯\n    if(stus != 0) { return stus; }\n    //ä»è·¯å¾„åå­—ç¬¦ä¸²çš„ç¬¬2ä¸ªå­—ç¬¦å¼€å§‹å¤åˆ¶å­—ç¬¦åˆ°bufä¸­\n    rfs_strcpy(&amp;fpath[1], buf);\n    return 0;\n}\n</code></pre><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œå®Œæˆè·å–æ–‡ä»¶åçš„æ˜¯rfs_ret_fnameå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å¯ä»¥æŠŠfpathæŒ‡å‘çš„è·¯å¾„åä¸­çš„æ–‡ä»¶åæå–å‡ºæ¥ï¼Œæ”¾åˆ°bufæŒ‡å‘çš„ç¼“å†²åŒºä¸­ï¼Œä½†åœ¨è¿™ä¹‹å‰ï¼Œéœ€è¦å…ˆè°ƒç”¨rfs_chkfilepathå‡½æ•°æ£€æŸ¥è·¯å¾„åæ˜¯ä¸æ˜¯â€œ/xxxxâ€çš„å½¢å¼ï¼Œè¿™æ˜¯è¿™ä¸ªåŠŸèƒ½æ­£å¸¸å®ç°çš„å¿…è¦æ¡ä»¶ã€‚</p><h3>åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨</h3><p>è·å–äº†æ–‡ä»¶åç§°ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å®ç°è¿™æ ·ä¸€ä¸ªåŠŸèƒ½ï¼šåˆ¤æ–­ä¸€ä¸ªæ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€‚å› ä¸ºæ–°å»ºå’Œåˆ é™¤æ–‡ä»¶ï¼Œè¦å…ˆåˆ¤æ–­å‚¨å­˜è®¾å¤‡é‡Œæ˜¯ä¸æ˜¯å­˜åœ¨ç€è¿™ä¸ªæ–‡ä»¶ã€‚å…·ä½“æ¥è¯´ï¼Œæ–°å»ºæ–‡ä»¶æ—¶ï¼Œæ— æ³•æ–°å»ºç›¸åŒæ–‡ä»¶åçš„æ–‡ä»¶ï¼›åˆ é™¤æ–‡ä»¶æ—¶ï¼Œä¸èƒ½åˆ é™¤ä¸å­˜åœ¨çš„æ–‡ä»¶ã€‚</p><p>æˆ‘ä»¬ä¸€èµ·é€šè¿‡åé¢è¿™ä¸ªå‡½æ•°è¿˜å®Œæˆè¿™ä¸ªåŠŸèƒ½ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>sint_t rfs_chkfileisindev(device_t* devp,char_t* fname)\n{\n    sint_t rets = 6;\n    sint_t ch = rfs_strlen(fname);//è·å–æ–‡ä»¶åçš„é•¿åº¦ï¼Œæ³¨æ„ä¸æ˜¯æ–‡ä»¶è·¯å¾„å\n    //æ£€æŸ¥æ–‡ä»¶åçš„é•¿åº¦æ˜¯ä¸æ˜¯åˆä¹è¦æ±‚\n    if(ch &lt; 1 || ch &gt;= (sint_t)DR_NM_MAX) { return 4; }\n    void* rdblkp = get_rootdirfile_blk(devp);\n    fimgrhd_t* fmp = (fimgrhd_t*)rdblkp;\n    //æ£€æŸ¥è¯¥fimgrhd_tç»“æ„çš„ç±»å‹æ˜¯ä¸æ˜¯FMD_DIR_TYPEï¼Œå³è¿™ä¸ªæ–‡ä»¶æ˜¯ä¸æ˜¯ç›®å½•æ–‡ä»¶\n    if(fmp-&gt;fmd_type != FMD_DIR_TYPE) { rets = 3; goto err; }\n    //æ£€æŸ¥æ ¹ç›®å½•æ–‡ä»¶æ˜¯ä¸æ˜¯ä¸ºç©ºï¼Œå³æ²¡æœ‰å†™å…¥ä»»ä½•æ•°æ®ï¼Œæ‰€ä»¥è¿”å›0ï¼Œè¡¨ç¤ºæ ¹ç›®å½•ä¸‹æ²¡æœ‰å¯¹åº”çš„æ–‡ä»¶\n    if(fmp-&gt;fmd_curfwritebk == fmp-&gt;fmd_fleblk[0].fb_blkstart &amp;&amp;\n fmp-&gt;fmd_curfinwbkoff == fmp-&gt;fmd_fileifstbkoff) {\n        rets = 0; goto err;\n    }\n    rfsdir_t* dirp = (rfsdir_t*)((uint_t)(fmp) + fmp-&gt;fmd_fileifstbkoff);//æŒ‡å‘æ ¹ç›®å½•æ–‡ä»¶çš„ç¬¬ä¸€ä¸ªå­—èŠ‚\n    //æŒ‡å‘æ ¹ç›®å½•æ–‡ä»¶çš„ç»“æŸåœ°å€\n    void* maxchkp = (void*)((uint_t)rdblkp + FSYS_ALCBLKSZ - 1);\n    //å½“å‰çš„rfsdir_tç»“æ„çš„æŒ‡é’ˆæ¯”æ ¹ç›®å½•æ–‡ä»¶çš„ç»“æŸåœ°å€å°ï¼Œå°±ç»§ç»­å¾ªç¯    \n    for(;(void*)dirp &lt; maxchkp;) {\n        //å¦‚æœè¿™ä¸ªrfsdir_tç»“æ„çš„ç±»å‹æ˜¯RDR_FIL_TYPEï¼Œè¯´æ˜å®ƒå¯¹åº”çš„æ˜¯æ–‡ä»¶è€Œä¸æ˜¯ç›®å½•ï¼Œæ‰€ä»¥ä¸‹é¢å°±ç»§ç»­æ¯”è¾ƒå…¶æ–‡ä»¶å\n        if(dirp-&gt;rdr_type == RDR_FIL_TYPE) {\n            if(rfs_strcmp(dirp-&gt;rdr_name,fname) == 1) {//æ¯”è¾ƒå…¶æ–‡ä»¶å\n                rets = 1; goto err;\n            }\n        }\n        dirp++;\n    }\n    rets = 0; //åˆ°äº†è¿™é‡Œè¯´æ˜æ²¡æœ‰æ‰¾åˆ°ç›¸åŒçš„æ–‡ä»¶\nerr:\n    del_rootdirfile_blk(devp,rdblkp);//é‡Šæ”¾æ ¹ç›®å½•æ–‡ä»¶\n    return rets;\n}\n</code></pre><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œrfs_chkfileisindevå‡½æ•°é€»è¾‘å¾ˆç®€å•ã€‚é¦–å…ˆæ˜¯æ£€æŸ¥æ–‡ä»¶åçš„é•¿åº¦ï¼Œæ¥ç€è·å–äº†æ ¹ç›®å½•æ–‡ä»¶ï¼Œç„¶åéå†æ ¹å…¶ä¸­çš„æ‰€æœ‰rfsdir_tç»“æ„å¹¶æ¯”è¾ƒæ–‡ä»¶åæ˜¯å¦ç›¸åŒï¼Œç›¸åŒå°±è¿”å›1ï¼Œä¸åŒå°±è¿”å›å…¶å®ƒå€¼ï¼Œæœ€åé‡Šæ”¾äº†æ ¹ç›®å½•æ–‡ä»¶ã€‚</p><p>å› ä¸ºget_rootdirfile_blkå‡½æ•°å·²ç»æŠŠæ ¹ç›®å½•æ–‡ä»¶è¯»å–åˆ°å†…å­˜é‡Œäº†ï¼Œæ‰€ä»¥å¯ä»¥ç”¨dirpæŒ‡é’ˆå’ŒmaxchkpæŒ‡é’ˆæ“ä½œå…¶ä¸­çš„æ•°æ®ã€‚</p><p>å¥½äº†ï¼Œæ“ä½œæ ¹ç›®å½•æ–‡ä»¶ã€è·å–æ–‡ä»¶åã€åˆ¤æ–­ä¸€ä¸ªæ–‡ä»¶æ˜¯å¦å­˜åœ¨çš„ä¸‰å¤§å‡½æ•°å°±å®ç°äº†ï¼Œæœ‰äº†å®ƒä»¬ï¼Œå†å»å®ç°æ–‡ä»¶ç›¸å…³çš„å…¶å®ƒæ“ä½œå°±æ–¹ä¾¿å¤šäº†ï¼Œæˆ‘ä»¬æ¥ç€æ¢ç´¢ã€‚</p><h2>æ–‡ä»¶ç›¸å…³çš„æ“ä½œ</h2><p>ç›´åˆ°ç°åœ¨ï¼Œæˆ‘ä»¬è¿˜æ²¡å¯¹ä»»ä½•æ–‡ä»¶è¿›è¡Œæ“ä½œï¼Œè€Œæˆ‘ä»¬å®ç°æ–‡ä»¶ç³»ç»Ÿï¼Œå°±æ˜¯ä¸ºäº†åº”ç”¨ç¨‹åºæ›´å¥½åœ°å­˜æ”¾è‡ªå·±çš„â€œåŠ³åŠ¨æˆæœâ€â€”â€”æ–‡ä»¶ï¼Œå› æ­¤ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿå¿…é¡»è¦æ”¯æŒä¸€äº›æ–‡ä»¶æ“ä½œã€‚</p><p>ä¸‹é¢æˆ‘ä»¬å°†ä¾æ¬¡å®ç°æ–°å»ºã€åˆ é™¤ã€æ‰“å¼€ã€è¯»å†™ä»¥åŠå…³é—­æ–‡ä»¶ï¼Œè¿™å‡ å¤§æ–‡ä»¶æ“ä½œï¼Œè¿™ä¹Ÿæ˜¯æ–‡ä»¶ç³»ç»Ÿéœ€è¦æä¾›çš„æœ€åŸºæœ¬çš„åŠŸèƒ½ã€‚</p><h3>æ–°å»ºæ–‡ä»¶</h3><p>åœ¨æ²¡æœ‰æ–‡ä»¶ä¹‹å‰ï¼Œå¯¹ä»»ä½•æ–‡ä»¶æœ¬èº«çš„æ“ä½œéƒ½æ˜¯æ— æ•ˆçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬é¦–å…ˆå°±è¦å®ç°æ–°å»ºæ–‡ä»¶è¿™ä¸ªåŠŸèƒ½ã€‚</p><p>åœ¨å†™ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜æ˜¯å…ˆæ¥çœ‹ä¸€çœ‹å¦‚ä½•æ–°å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œä¸€å…±å¯ä»¥åˆ†æˆåé¢è¿™4æ­¥ã€‚</p><p>1.ä»æ–‡ä»¶è·¯å¾„åä¸­æå–å‡ºçº¯æ–‡ä»¶åï¼Œæ£€æŸ¥å‚¨å­˜è®¾å¤‡ä¸Šæ˜¯å¦å·²ç»å­˜åœ¨è¿™ä¸ªæ–‡ä»¶ã€‚<br>\n2.åˆ†é…ä¸€ä¸ªç©ºé—²çš„é€»è¾‘å‚¨å­˜å—ï¼Œå¹¶åœ¨æ ¹ç›®å½•æ–‡ä»¶çš„æœ«å°¾å†™å…¥è¿™ä¸ªæ–°å»ºæ–‡ä»¶å¯¹åº”çš„rfsdir_tç»“æ„ã€‚<br>\n3.åœ¨ä¸€ä¸ªæ–°çš„4KBå¤§å°çš„ç¼“å†²åŒºä¸­ï¼Œåˆå§‹åŒ–æ–°å»ºæ–‡ä»¶å¯¹åº”çš„fimgrhd_tç»“æ„ã€‚<br>\n4.æŠŠç¬¬3æ­¥å¯¹åº”çš„ç¼“å†²åŒºé‡Œçš„æ•°æ®ï¼Œå†™å…¥åˆ°å…ˆå‰åˆ†é…çš„ç©ºé—²é€»è¾‘å‚¨å­˜å—ä¸­ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬å…ˆæ¥å†™å¥½æ–°å»ºæ–‡ä»¶çš„æ¥å£å‡½æ•°ã€‚</p><pre><code>//æ–°å»ºæ–‡ä»¶çš„æ¥å£å‡½æ•°\ndrvstus_t rfs_new_file(device_t* devp, char_t* fname, uint_t flg)\n{\n    //åœ¨æ ˆä¸­åˆ†é…ä¸€ä¸ªå­—ç¬¦ç¼“å†²åŒºå¹¶æ¸…é›¶\n    char_t fne[DR_NM_MAX];\n    hal_memset((void*)fne, DR_NM_MAX, 0);\n    //ä»æ–‡ä»¶è·¯å¾„åä¸­æå–å‡ºçº¯æ–‡ä»¶å\n    if(rfs_ret_fname(fne, fname) != 0) { return DFCERRSTUS; }\n    //æ£€æŸ¥å‚¨å­˜ä»‹è´¨ä¸Šæ˜¯å¦å·²ç»å­˜åœ¨è¿™ä¸ªæ–°å»ºçš„æ–‡ä»¶ï¼Œå¦‚æœæ˜¯åˆ™è¿”å›é”™è¯¯\n    if(rfs_chkfileisindev(devp, fne) != 0) {return DFCERRSTUS; }\n    //è°ƒç”¨å®é™…å»ºç«‹æ–‡ä»¶çš„å‡½æ•°\n    return rfs_new_dirfileblk(devp, fne, RDR_FIL_TYPE, 0);\n}\n</code></pre><p>æˆ‘ä»¬åœ¨æ–°å»ºæ–‡ä»¶çš„æ¥å£å‡½æ•°ä¸­ï¼Œå°±å®ç°äº†å‰é¢ç¬¬ä¸€æ­¥ï¼Œå®Œæˆäº†æå–æ–‡ä»¶åå’Œæ£€æŸ¥æ–‡ä»¶æ˜¯å¦åœ¨å‚¨å­˜è®¾å¤‡ä¸­å­˜åœ¨çš„å·¥ä½œã€‚æ¥ç€æˆ‘ä»¬æ¥å®ç°çœŸæ­£æ–°å»ºæ–‡ä»¶çš„å‡½æ•°ï¼Œå°±æ˜¯ä¸Šè¿°ä»£ç ä¸­rfs_new_dirfileblkå‡½æ•°ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>drvstus_t rfs_new_dirfileblk(device_t* devp,char_t* fname,uint_t flgtype,uint_t val)\n{\n    drvstus_t rets = DFCERRSTUS;\n    void* buf = new_buf(FSYS_ALCBLKSZ);//åˆ†é…ä¸€ä¸ª4KBå¤§å°çš„ç¼“å†²åŒº    \n    hal_memset(buf, FSYS_ALCBLKSZ, 0);//æ¸…é›¶è¯¥ç¼“å†²åŒº\n    uint_t fblk = rfs_new_blk(devp);//åˆ†é…ä¸€ä¸ªæ–°çš„ç©ºé—²é€»è¾‘å‚¨å­˜å—\n    void* rdirblk = get_rootdirfile_blk(devp);//è·å–æ ¹ç›®å½•æ–‡ä»¶\n    fimgrhd_t* fmp = (fimgrhd_t*)rdirblk;\n    //æŒ‡å‘æ–‡ä»¶å½“å‰çš„å†™å…¥åœ°å€ï¼Œå› ä¸ºæ ¹ç›®å½•æ–‡ä»¶å·²ç»è¢«è¯»å–åˆ°å†…å­˜ä¸­äº†\n    rfsdir_t* wrdirp = (rfsdir_t*)((uint_t)rdirblk + fmp-&gt;fmd_curfinwbkoff);\n    //å¯¹æ–‡ä»¶å½“å‰çš„å†™å…¥åœ°å€è¿›è¡Œæ£€æŸ¥\n    if(((uint_t)wrdirp) &gt;= ((uint_t)rdirblk + FSYS_ALCBLKSZ)) {\n        rets=DFCERRSTUS; goto err;\n    }\n    wrdirp-&gt;rdr_stus = 0;\n    wrdirp-&gt;rdr_type = flgtype;//è®¾ä¸ºæ–‡ä»¶ç±»å‹\n    wrdirp-&gt;rdr_blknr = fblk;//è®¾ä¸ºåˆšåˆšåˆ†é…çš„ç©ºé—²é€»è¾‘å‚¨å­˜å—\n    rfs_strcpy(fname, wrdirp-&gt;rdr_name);//æŠŠæ–‡ä»¶åå¤åˆ¶åˆ°rfsdir_tç»“æ„\n    fmp-&gt;fmd_filesz += (uint_t)(sizeof(rfsdir_t));//å¢åŠ æ ¹ç›®å½•æ–‡ä»¶çš„å¤§å°\n    //å¢åŠ æ ¹ç›®å½•æ–‡ä»¶å½“å‰çš„å†™å…¥åœ°å€ï¼Œä¿è¯ä¸‹æ¬¡ä¸è¢«è¦†ç›–\n    fmp-&gt;fmd_curfinwbkoff += (uint_t)(sizeof(rfsdir_t));\n    fimgrhd_t* ffmp = (fimgrhd_t*)buf;//æŒ‡å‘æ–°åˆ†é…çš„ç¼“å†²åŒº\n    fimgrhd_t_init(ffmp);//è°ƒç”¨fimgrhd_tç»“æ„é»˜è®¤çš„åˆå§‹åŒ–å‡½æ•°\n    ffmp-&gt;fmd_type = FMD_FIL_TYPE;//å› ä¸ºå»ºç«‹çš„æ˜¯æ–‡ä»¶ï¼Œæ‰€ä»¥è®¾ä¸ºæ–‡ä»¶ç±»å‹\n    ffmp-&gt;fmd_sfblk = fblk;//æŠŠè‡ªèº«æ‰€åœ¨çš„å—ï¼Œè®¾ä¸ºåˆ†é…çš„é€»è¾‘å‚¨å­˜å—\n    ffmp-&gt;fmd_curfwritebk = fblk;//æŠŠå½“å‰å†™å…¥çš„å—ï¼Œè®¾ä¸ºåˆ†é…çš„é€»è¾‘å‚¨å­˜å—\n    ffmp-&gt;fmd_curfinwbkoff = 0x200;//æŠŠå½“å‰å†™å…¥å—çš„å†™å…¥åç§»é‡è®¾ä¸º512\n    //æŠŠæ–‡ä»¶å‚¨å­˜å—æ•°ç»„çš„ç¬¬1ä¸ªå…ƒç´ çš„å¼€å§‹å—ï¼Œè®¾ä¸ºåˆšåˆšåˆ†é…çš„ç©ºé—²é€»è¾‘å‚¨å­˜å—\n    ffmp-&gt;fmd_fleblk[0].fb_blkstart = fblk;\n    //å› ä¸ºåªåˆ†é…äº†ä¸€ä¸ªé€»è¾‘å‚¨å­˜å—ï¼Œæ‰€ä»¥è®¾ä¸º1\n    ffmp-&gt;fmd_fleblk[0].fb_blknr = 1;\n    //æŠŠç¼“å†²åŒºä¸­çš„æ•°æ®å†™å…¥åˆ°åˆšåˆšåˆ†é…çš„ç©ºé—²é€»è¾‘å‚¨å­˜å—ä¸­\n    if(write_rfsdevblk(devp, buf, fblk) == DFCERRSTUS) { \t\t\t\n        rets = DFCERRSTUS; goto err;\n    }\n    rets = DFCOKSTUS;\nerr:\n    del_rootdirfile_blk(devp, rdirblk);//é‡Šæ”¾æ ¹ç›®å½•æ–‡ä»¶\nerr1:\n    del_buf(buf, FSYS_ALCBLKSZ);//é‡Šæ”¾ç¼“å†²åŒº\n    return rets;\n}\n</code></pre><p>çœ‹å®Œä¸Šè¿°ä»£ç ï¼Œæˆ‘æƒ³æé†’ä½ ï¼Œåœ¨rfs_new_dirfileblkå‡½æ•°ä¸­æœ‰ä¸¤ç‚¹å¾ˆå…³é”®ã€‚</p><p>ç¬¬ä¸€ï¼Œå‰é¢åå¤æåˆ°çš„ç›®å½•æ–‡ä»¶ä¸­å­˜æ”¾çš„å°±æ˜¯<strong>ä¸€ç³»åˆ—çš„rfsdir_tç»“æ„</strong>ã€‚</p><p>ç¬¬äºŒï¼Œfmpå’Œffmpè¿™ä¸¤ä¸ªæŒ‡é’ˆå¾ˆé‡è¦ã€‚fmpæŒ‡é’ˆæŒ‡å‘çš„æ˜¯æ ¹ç›®å½•æ–‡ä»¶çš„fimgrhd_tç»“æ„ï¼Œå› ä¸ºè¦å†™å…¥ä¸€ä¸ªæ–°çš„rfsdir_tç»“æ„ï¼Œæ‰€ä»¥è¦è·å–å¹¶æ”¹å†™æ ¹ç›®å½•æ–‡ä»¶çš„fimgrhd_tç»“æ„ä¸­çš„æ•°æ®ã€‚è€ŒffmpæŒ‡é’ˆæŒ‡å‘çš„æ˜¯æ–°å»ºæ–‡ä»¶çš„fimgrhd_tç»“æ„ï¼Œå¹¶ä¸”åˆå§‹åŒ–äº†å…¶ä¸­çš„ä¸€äº›æ•°æ®ã€‚æœ€åï¼Œè¯¥å‡½æ•°æŠŠè¿™ä¸ªç¼“å†²åŒºä¸­çš„æ•°æ®å†™å…¥åˆ°åˆ†é…çš„ç©ºé—²é€»è¾‘å‚¨å­˜å—ä¸­ï¼ŒåŒæ—¶é‡Šæ”¾äº†æ ¹ç›®å½•æ–‡ä»¶å’Œç¼“å†²åŒºã€‚</p><h3>åˆ é™¤æ–‡ä»¶</h3><p>æ–°å»ºæ–‡ä»¶çš„æ“ä½œå®Œæˆäº†ï¼Œä¸‹é¢æˆ‘ä»¬æ¥å®ç°åˆ é™¤æ–‡ä»¶çš„æ“ä½œã€‚</p><p>å¦‚æœåªèƒ½æ–°å»ºæ–‡ä»¶è€Œä¸èƒ½åˆ é™¤æ–‡ä»¶ï¼Œé‚£ä¹ˆå‚¨å­˜è®¾å¤‡çš„ç©ºé—´æœ€ç»ˆä¼šè€—å°½ï¼Œæ‰€ä»¥æ–‡ä»¶ç³»ç»Ÿå°±å¿…é¡»æ”¯æŒåˆ é™¤æ–‡ä»¶çš„æ“ä½œã€‚</p><p>åŒæ ·çš„ï¼Œè¿˜æ˜¯å…ˆæ¥äº†è§£åˆ é™¤æ–‡ä»¶çš„æ–¹æ³•ã€‚åˆ é™¤æ–‡ä»¶å¯ä»¥é€šè¿‡åé¢è¿™4æ­¥æ¥å®ç°ã€‚</p><p>1.ä»æ–‡ä»¶è·¯å¾„åä¸­æå–å‡ºçº¯æ–‡ä»¶åã€‚<br>\n2.è·å–æ ¹ç›®å½•æ–‡ä»¶ï¼Œä»æ ¹ç›®å½•æ–‡ä»¶ä¸­æŸ¥æ‰¾å¾…åˆ é™¤æ–‡ä»¶çš„rfsdir_tç»“æ„ï¼Œç„¶åé‡Šæ”¾è¯¥æ–‡ä»¶å ç”¨çš„é€»è¾‘å‚¨å­˜å—ã€‚<br>\n3.åˆå§‹åŒ–ä¸å¾…åˆ é™¤æ–‡ä»¶ç›¸å¯¹åº”çš„rfsdir_tç»“æ„ï¼Œå¹¶è®¾ç½®rfsdir_tç»“æ„çš„ç±»å‹ä¸ºRDR_DEL_TYPEã€‚<br>\n4.é‡Šæ”¾æ ¹ç›®å½•æ–‡ä»¶ã€‚</p><p>è¿™æ¬¡æˆ‘ä»¬ç”¨ä¸‰ä¸ªå‡½æ•°æ¥å®ç°è¿™äº›æ­¥éª¤ï¼Œåˆ é™¤æ–‡ä»¶çš„æ¥å£å‡½æ•°çš„ä»£ç å¦‚ä¸‹ã€‚</p><pre><code>//æ–‡ä»¶åˆ é™¤çš„æ¥å£å‡½æ•°\ndrvstus_t rfs_del_file(device_t* devp, char_t* fname, uint_t flg)\n{\n    if(flg != 0) {\n        return DFCERRSTUS;\n    }\n    return rfs_del_dirfileblk(devp, fname, RDR_FIL_TYPE, 0);\n}\n</code></pre><p>åˆ é™¤æ–‡ä»¶çš„æ¥å£å‡½æ•°éå¸¸ä¹‹ç®€å•ï¼Œå°±æ˜¯åˆ¤æ–­ä¸€ä¸‹æ ‡å¿—ï¼Œæ¥ç€è°ƒç”¨äº†rfs_del_dirfileblkå‡½æ•°ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥å†™å¥½è¿™ä¸ªrfs_del_dirfileblkå‡½æ•°ã€‚</p><pre><code>drvstus_t rfs_del_dirfileblk(device_t* devp, char_t* fname, uint_t flgtype, uint_t val)\n{\n    if(flgtype != RDR_FIL_TYPE || val != 0) { return DFCERRSTUS; }\n    char_t fne[DR_NM_MAX];\n    hal_memset((void*)fne, DR_NM_MAX, 0);\n    //æå–çº¯æ–‡ä»¶å\n    if(rfs_ret_fname(fne,fname) != 0) { return DFCERRSTUS; }\n    //è°ƒç”¨åˆ é™¤æ–‡ä»¶çš„æ ¸å¿ƒå‡½æ•°\n    if(del_dirfileblk_core(devp, fne) != 0) { return DFCERRSTUS; }\n    return DFCOKSTUS;\n}\n</code></pre><p>rfs_del_dirfileblkå‡½æ•°åªæ˜¯æå–äº†æ–‡ä»¶åï¼Œç„¶åè°ƒç”¨äº†ä¸€ä¸ªåˆ é™¤æ–‡ä»¶çš„æ ¸å¿ƒå‡½æ•°ï¼Œè¿™ä¸ªæ ¸å¿ƒå‡½æ•°å°±æ˜¯del_dirfileblk_coreå‡½æ•°ï¼Œå®ƒçš„å®ç°ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>//åˆ é™¤æ–‡ä»¶çš„æ ¸å¿ƒå‡½æ•°\nsint_t del_dirfileblk_core(device_t* devp, char_t* fname)\n{\n    sint_t rets = 6;\n    void* rblkp=get_rootdirfile_blk(devp);//è·å–æ ¹ç›®å½•æ–‡ä»¶\n    fimgrhd_t* fmp = (fimgrhd_t*)rblkp;\n    if(fmp-&gt;fmd_type!=FMD_DIR_TYPE) { //æ£€æŸ¥æ ¹ç›®å½•æ–‡ä»¶çš„ç±»å‹\n        rets=4; goto err;\n    }\n    if(fmp-&gt;fmd_curfwritebk == fmp-&gt;fmd_fleblk[0].fb_blkstart &amp;&amp; fmp-&gt;fmd_curfinwbkoff == fmp-&gt;fmd_fileifstbkoff) { //æ£€æŸ¥æ ¹ç›®å½•æ–‡ä»¶ä¸­æœ‰æ²¡æœ‰æ•°æ®\n        rets = 3; goto err;\n    }\n    rfsdir_t* dirp = (rfsdir_t*)((uint_t)(fmp) + fmp-&gt;fmd_fileifstbkoff);\n    void* maxchkp = (void*)((uint_t)rblkp + FSYS_ALCBLKSZ-1);\n    for(;(void*)dirp &lt; maxchkp;) {\n        if(dirp-&gt;rdr_type == RDR_FIL_TYPE) {//æ£€æŸ¥å…¶ç±»å‹æ˜¯å¦ä¸ºæ–‡ä»¶ç±»å‹\n            //å¦‚æœæ–‡ä»¶åç›¸åŒï¼Œå°±æ‰§è¡Œä»¥ä¸‹åˆ é™¤åŠ¨ä½œ\n            if(rfs_strcmp(dirp-&gt;rdr_name, fname) == 1) {\n                //é‡Šæ”¾rfsdir_tç»“æ„çš„rdr_blknrä¸­æŒ‡å‘çš„é€»è¾‘å‚¨å­˜å—\n                rfs_del_blk(devp, dirp-&gt;rdr_blknr);\n                //åˆå§‹åŒ–rfsdir_tç»“æ„ï¼Œå®é™…ä¸Šæ˜¯æ¸…é™¤å…¶ä¸­çš„æ•°æ®\n                rfsdir_t_init(dirp);\n                //è®¾ç½®rfsdir_tç»“æ„çš„ç±»å‹ä¸ºåˆ é™¤ç±»å‹ï¼Œè¡¨ç¤ºå®ƒå·²ç»åˆ é™¤\n                dirp-&gt;rdr_type = RDR_DEL_TYPE;\n                rets = 0; goto err;\n            }\n        }\n        dirp++;//ä¸‹ä¸€ä¸ªrfsdir_t\n    }\n    rets=1;\nerr:\n    del_rootdirfile_blk(devp,rblkp);//é‡Šæ”¾æ ¹ç›®å½•æ–‡ä»¶\n    return rets;\n}\n</code></pre><p>ä¸Šè¿°ä»£ç ä¸­çš„del_dirfileblk_coreå‡½æ•°ï¼Œå®ƒä¸»è¦æ˜¯éå†æ ¹ç›®å½•æ–‡ä»¶ä¸­æ‰€æœ‰çš„rfsdir_tç»“æ„ï¼Œå¹¶æ¯”è¾ƒå…¶æ–‡ä»¶åï¼Œçœ‹çœ‹åˆ é™¤çš„æ–‡ä»¶åç§°æ˜¯å¦ç›¸åŒï¼Œç›¸åŒå°±é‡Šæ”¾è¯¥rfsdir_tç»“æ„çš„rdr_blknrå­—æ®µå¯¹åº”çš„é€»è¾‘å‚¨å­˜å—ï¼Œæ¸…é™¤è¯¥rfsdir_tç»“æ„ä¸­çš„æ•°æ®ï¼ŒåŒæ—¶è®¾ç½®è¯¥rfsdir_tç»“æ„çš„ç±»å‹ä¸ºåˆ é™¤ç±»å‹ã€‚</p><p>ä½ å¯ä»¥è¿™æ ·ç†è§£ï¼šåˆ é™¤ä¸€ä¸ªæ–‡ä»¶ï¼Œå°±æ˜¯æŠŠè¿™ä¸ªæ–‡ä»¶å¯¹åº”çš„rfsdir_tç»“æ„ä¸­çš„æ•°æ®æ¸…ç©ºï¼Œè¿™æ ·å°±æ— æ³•æŸ¥æ‰¾åˆ°è¿™ä¸ªæ–‡ä»¶äº†ã€‚åŒæ—¶ï¼Œä¹Ÿè¦é‡Šæ”¾è¯¥æ–‡ä»¶å ç”¨çš„é€»è¾‘å‚¨å­˜å—ã€‚å› ä¸ºæ²¡æœ‰æ¸…ç©ºæ–‡ä»¶æ•°æ®ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡ååˆ é™¤è½¯ä»¶æ‰¾å›æ–‡ä»¶ã€‚</p><h3>æ‰“å¼€æ–‡ä»¶</h3><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±è¦å®ç°æ‰“å¼€æ–‡ä»¶æ“ä½œäº†ã€‚ä¸€ä¸ªå·²ç»å­˜åœ¨çš„æ–‡ä»¶ï¼Œè¦å¯¹å®ƒè¿›è¡Œè¯»å†™æ“ä½œï¼Œé¦–å…ˆå°±åº”è¯¥æ‰“å¼€è¿™ä¸ªæ–‡ä»¶ã€‚</p><p>åœ¨å®ç°è¿™ä¸ªæ‰“å¼€æ–‡ä»¶æ“ä½œä¹‹å‰ï¼Œæˆ‘ä»¬ä¸å¦¨å…ˆå›å¿†ä¸€ä¸‹å‰é¢è¯¾ç¨‹é‡Œæåˆ°çš„<a href=\"https://time.geekbang.org/column/article/395772\">objnode_tç»“æ„</a>ã€‚</p><p>Cosmoså†…æ ¸ä¸Šå±‚ç»„ä»¶è°ƒç”¨è®¾å¤‡é©±åŠ¨ç¨‹åºæ—¶ï¼Œéƒ½éœ€è¦å»ºç«‹ä¸€ä¸ªç›¸åº”çš„objnode_tç»“æ„ï¼ŒæŠŠè¿™ä¸ªI/OåŒ…å‘é€ç»™ç›¸åº”çš„é©±åŠ¨ç¨‹åºï¼Œä½†æ˜¯objnode_tç»“æ„ä¸ä»…ä»…æ˜¯ç”¨äºé©±åŠ¨ç¨‹åºï¼Œå®ƒè¿˜ç”¨äºè¡¨ç¤ºè¿›ç¨‹ä½¿ç”¨äº†å“ªäº›èµ„æºï¼Œä¾‹å¦‚æ‰“å¼€äº†å“ªäº›è®¾å¤‡æˆ–è€…æ–‡ä»¶ï¼Œè€Œæ¯æ‰“å¼€ä¸€ä¸ªè®¾å¤‡æˆ–è€…æ–‡ä»¶å°±å»ºç«‹ä¸€ä¸ªobjnode_tç»“æ„ï¼Œæ”¾åœ¨ç‰¹å®šè¿›ç¨‹çš„èµ„æºè¡¨ä¸­ã€‚</p><p>ä¸ºäº†é€‚åº”æ–‡ä»¶ç³»ç»Ÿè®¾å¤‡é©±åŠ¨ç¨‹åºï¼Œåœ¨cosmos/include/krlinc/krlobjnode_t.hæ–‡ä»¶ä¸­ï¼Œéœ€è¦åœ¨objnode_tç»“æ„ä¸­å¢åŠ ä¸€äº›ä¸œè¥¿ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>#define OBJN_TY_DEV 1//è®¾å¤‡ç±»å‹\n#define OBJN_TY_FIL 2//æ–‡ä»¶ç±»å‹\n#define OBJN_TY_NUL 0//é»˜è®¤ç±»å‹\ntypedef struct s_OBJNODE\n{\n    spinlock_t  on_lock;\n    list_h_t    on_list;\n    sem_t       on_complesem;\n    uint_t      on_flgs;\n    uint_t      on_stus;\n    //â€¦â€¦\n    void*       on_fname;//æ–‡ä»¶è·¯å¾„åæŒ‡é’ˆ\n    void*       on_finode;//æ–‡ä»¶å¯¹åº”çš„fimgrhd_tç»“æ„æŒ‡é’ˆ\n    void*       on_extp;//æ‰©å±•æ‰€ç”¨\n}objnode_t;\n</code></pre><p>ä¸Šè¿°ä»£ç ä¸­objnode_tç»“æ„é‡Œå¢åŠ äº†ä¸¤ä¸ªå­—æ®µï¼Œä¸€ä¸ªæ˜¯æŒ‡å‘æ–‡ä»¶è·¯å¾„åçš„æŒ‡é’ˆï¼Œè¡¨ç¤ºæ‰“å¼€å“ªä¸ªæ–‡ä»¶ã€‚å› ä¸ºè¦çŸ¥é“ä¸€ä¸ªæ–‡ä»¶çš„æ‰€æœ‰ä¿¡æ¯ï¼Œæ‰€ä»¥å¢åŠ äº†æŒ‡å‘å¯¹åº”æ–‡ä»¶çš„fimgrhd_tç»“æ„æŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¢åŠ çš„ç¬¬äºŒä¸ªå­—æ®µã€‚</p><p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹çœ‹æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶çš„æµç¨‹ã€‚ä¸€å…±ä¹Ÿæ˜¯4æ­¥ã€‚</p><p>1.ä»objnode_tç»“æ„çš„æ–‡ä»¶è·¯å¾„æå–æ–‡ä»¶åã€‚<br>\n2.è·å–æ ¹ç›®å½•æ–‡ä»¶ï¼Œåœ¨è¯¥æ–‡ä»¶ä¸­æœç´¢å¯¹åº”çš„rfsdir_tç»“æ„ï¼Œçœ‹çœ‹æ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€‚<br>\n3.åˆ†é…ä¸€ä¸ª4KBç¼“å­˜åŒºï¼ŒæŠŠè¯¥æ–‡ä»¶å¯¹åº”çš„rfsdir_tç»“æ„ä¸­æŒ‡å‘çš„é€»è¾‘å‚¨å­˜å—è¯»å–åˆ°ç¼“å­˜åŒºä¸­ï¼Œç„¶åé‡Šæ”¾æ ¹ç›®å½•æ–‡ä»¶ã€‚<br>\n4.æŠŠç¼“å†²åŒºä¸­çš„fimgrhd_tç»“æ„çš„åœ°å€ï¼Œä¿å­˜åˆ°objnode_tç»“æ„çš„on_finodeåŸŸä¸­ã€‚</p><p>ä¸‹é¢æ¥å†™ä¸¤ä¸ªå‡½æ•°å®ç°è¿™äº›æµç¨‹ï¼ŒåŒæ ·æˆ‘ä»¬éœ€è¦å…ˆå†™å¥½æ¥å£å‡½æ•°ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>//æ‰“å¼€æ–‡ä»¶çš„æ¥å£å‡½æ•°\ndrvstus_t rfs_open_file(device_t* devp, void* iopack)\n{\n    objnode_t* obp = (objnode_t*)iopack;\n    //æ£€æŸ¥objnode_tä¸­çš„æ–‡ä»¶è·¯å¾„å\n    if(obp-&gt;on_fname == NULL) {\n        return DFCERRSTUS;\n    }\n    //è°ƒç”¨æ‰“å¼€æ–‡ä»¶çš„æ ¸å¿ƒå‡½æ•°\n    void* fmdp = rfs_openfileblk(devp, (char_t*)obp-&gt;on_fname);\n    if(fmdp == NULL) {\n        return DFCERRSTUS;\n    }\n    //æŠŠè¿”å›çš„fimgrhd_tç»“æ„çš„åœ°å€ä¿å­˜åˆ°objnode_tä¸­çš„on_finodeå­—æ®µä¸­\n    obp-&gt;on_finode = fmdp;\n    return DFCOKSTUS;\n}\n</code></pre><p>æ¥å£å‡½æ•°rfs_open_fileä¸­åªæ˜¯å¯¹å‚æ•°è¿›è¡Œäº†æ£€æŸ¥ã€‚ç„¶åè°ƒç”¨äº†æ ¸å¿ƒå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å°±æ˜¯rfs_openfileblkï¼Œå®ƒçš„ä»£ç å®ç°å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>//æ‰“å¼€æ–‡ä»¶çš„æ ¸å¿ƒå‡½æ•°\nvoid* rfs_openfileblk(device_t *devp, char_t* fname)\n{\n    char_t fne[DR_NM_MAX]; void* rets = NULL,*buf = NULL;\n    hal_memset((void*)fne,DR_NM_MAX,0);\n    if(rfs_ret_fname(fne, fname) != 0) {//ä»æ–‡ä»¶è·¯å¾„åä¸­æå–çº¯æ–‡ä»¶å\n        return NULL;\n    }\n    void* rblkp = get_rootdirfile_blk(devp); //è·å–æ ¹ç›®å½•æ–‡ä»¶\n    fimgrhd_t* fmp = (fimgrhd_t*)rblkp;\n    if(fmp-&gt;fmd_type != FMD_DIR_TYPE) {//åˆ¤æ–­æ ¹ç›®å½•æ–‡ä»¶çš„ç±»å‹æ˜¯å¦åˆç† \n        rets = NULL; goto err;\n    }\n    //åˆ¤æ–­æ ¹ç›®å½•æ–‡ä»¶é‡Œæœ‰æ²¡æœ‰æ•°æ®\n    if(fmp-&gt;fmd_curfwritebk == fmp-&gt;fmd_fleblk[0].fb_blkstart &amp;&amp; \nfmp-&gt;fmd_curfinwbkoff == fmp-&gt;fmd_fileifstbkoff) { \n        rets = NULL; goto err;\n    }\n    rfsdir_t* dirp = (rfsdir_t*)((uint_t)(fmp) + fmp-&gt;fmd_fileifstbkoff); \n    void* maxchkp = (void*)((uint_t)rblkp + FSYS_ALCBLKSZ - 1);\n    for(;(void*)dirp &lt; maxchkp;) {//å¼€å§‹éå†æ–‡ä»¶å¯¹åº”çš„rfsdir_tç»“æ„\n        if(dirp-&gt;rdr_type == RDR_FIL_TYPE) {\n            //å¦‚æœæ–‡ä»¶åç›¸åŒå°±è·³è½¬åˆ°opfblkæ ‡å·å¤„è¿è¡Œ\n            if(rfs_strcmp(dirp-&gt;rdr_name, fne) == 1) {\n                goto opfblk;\n            }\n        }\n        dirp++;\n    }\n    //å¦‚æœåˆ°è¿™é‡Œè¯´æ˜æ²¡æœ‰æ‰¾åˆ°è¯¥æ–‡ä»¶å¯¹åº”çš„rfsdir_tç»“æ„ï¼Œæ‰€ä»¥è®¾ç½®è¿”å›å€¼ä¸ºNULL\n    rets = NULL; goto err;\nopfblk:\n    buf = new_buf(FSYS_ALCBLKSZ);//åˆ†é…4KBå¤§å°çš„ç¼“å†²åŒº\n    //è¯»å–è¯¥æ–‡ä»¶å ç”¨çš„é€»è¾‘å‚¨å­˜å—\n    if(read_rfsdevblk(devp, buf, dirp-&gt;rdr_blknr) == DFCERRSTUS) {\n        rets = NULL; goto err1;\n    }\n    fimgrhd_t* ffmp = (fimgrhd_t*)buf;\n    if(ffmp-&gt;fmd_type == FMD_NUL_TYPE || ffmp-&gt;fmd_fileifstbkoff != 0x200) {//åˆ¤æ–­å°†è¦æ‰“å¼€çš„æ–‡ä»¶æ˜¯å¦åˆæ³•\n        rets = NULL; goto err1;\n    }\n    rets = buf; goto err;//è®¾ç½®ç¼“å†²åŒºé¦–åœ°å€ä¸ºè¿”å›å€¼\nerr1:\n    del_buf(buf, FSYS_ALCBLKSZ); //ä¸Šé¢çš„æ­¥éª¤è‹¥å‡ºç°é—®é¢˜å°±è¦é‡Šæ”¾ç¼“å†²åŒº\nerr:\n    del_rootdirfile_blk(devp, rblkp); //é‡Šæ”¾æ ¹ç›®å½•æ–‡ä»¶\n    return rets;\n}\n</code></pre><p>ç»“åˆä¸Šé¢çš„ä»£ç æˆ‘ä»¬èƒ½å¤Ÿçœ‹åˆ°ï¼Œé€šè¿‡rfs_openfileblkå‡½æ•°ä¸­çš„forå¾ªç¯ï¼Œå¯ä»¥éå†è¦æ‰“å¼€çš„æ–‡ä»¶åœ¨æ ¹ç›®å½•æ–‡ä»¶ä¸­å¯¹åº”çš„rfsdir_tç»“æ„ï¼Œç„¶åæŠŠå¯¹åº”æ–‡ä»¶å ç”¨çš„é€»è¾‘å‚¨å­˜å—è¯»å–åˆ°ç¼“å†²åŒºä¸­ï¼Œæœ€åè¿”å›è¿™ä¸ªç¼“å†²åŒºçš„é¦–åœ°å€ã€‚</p><p>å› ä¸ºè¿™ä¸ªç¼“å†²åŒºå¼€å§‹çš„ç©ºé—´ä¸­ï¼Œå°±å­˜æ”¾ç€å…¶æ–‡ä»¶å¯¹åº”çš„fimgrhd_tç»“æ„ï¼Œæ‰€ä»¥è¿”å›fimgrhd_tç»“æ„çš„åœ°å€ï¼Œæ•´ä¸ªæ‰“å¼€æ–‡ä»¶çš„æµç¨‹å°±ç»“æŸäº†ã€‚</p><h3>è¯»å†™æ–‡ä»¶</h3><p>åˆšæ‰æˆ‘ä»¬å·²ç»å®ç°äº†æ‰“å¼€æ–‡ä»¶ï¼Œ è€Œæ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œå°±æ˜¯ä¸ºäº†å¯¹è¿™ä¸ªæ–‡ä»¶è¿›è¡Œè¯»å†™ã€‚</p><p>å…¶å®å¯¹æ–‡ä»¶çš„è¯»å†™åŒ…å«ä¸¤ä¸ªæ“ä½œï¼Œä¸€ä¸ªæ˜¯ä»å‚¨å­˜è®¾å¤‡ä¸­è¯»å–æ–‡ä»¶çš„æ•°æ®ï¼Œå¦ä¸€ä¸ªæ˜¯æŠŠæ–‡ä»¶çš„æ•°æ®å†™å…¥åˆ°å‚¨å­˜è®¾å¤‡ä¸­ã€‚</p><p>å’±ä»¬å…ˆæ¥çœ‹çœ‹å¦‚ä½•è¯»å–å·²ç»æ‰“å¼€çš„æ–‡ä»¶ä¸­çš„æ•°æ®ï¼Œå¤§è‡´çš„æµç¨‹å¦‚ä¸‹ã€‚</p><p>1.æ£€æŸ¥objnode_tç»“æ„ä¸­ç”¨äºå­˜æ”¾æ–‡ä»¶æ•°æ®çš„ç¼“å†²åŒºåŠå…¶å¤§å°ã€‚<br>\n2.æ£€æŸ¥imgrhd_tç»“æ„ä¸­æ–‡ä»¶ç›¸å…³çš„ä¿¡æ¯ã€‚<br>\n3.æŠŠæ–‡ä»¶çš„æ•°æ®è¯»å–åˆ°objnode_tç»“æ„ä¸­æŒ‡å‘çš„ç¼“å†²åŒºä¸­ã€‚</p><p>é€šè¿‡åé¢çš„ä»£ç ï¼Œæˆ‘ä»¬æŠŠè¯»æ–‡ä»¶çš„æ¥å£å‡½æ•°è·Ÿæ ¸å¿ƒå‡½æ•°ä¸€èµ·å®ç°ã€‚</p><pre><code>//è¯»å–æ–‡ä»¶æ•°æ®çš„æ¥å£å‡½æ•°\ndrvstus_t rfs_read_file(device_t* devp,void* iopack)\n{\n    objnode_t* obp = (objnode_t*)iopack;\n    //æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²ç»æ‰“å¼€ï¼Œä»¥åŠç”¨äºå­˜æ”¾æ–‡ä»¶æ•°æ®çš„ç¼“å†²åŒºå’Œå®ƒçš„å¤§å°æ˜¯å¦åˆç†\n    if(obp-&gt;on_finode == NULL || obp-&gt;on_buf == NULL || obp-&gt;on_bufsz != FSYS_ALCBLKSZ) { \n        return DFCERRSTUS; \n    }\n    return rfs_readfileblk(devp, (fimgrhd_t*)obp-&gt;on_finode, obp-&gt;on_buf, obp-&gt;on_len);\n}\n//å®é™…è¯»å–æ–‡ä»¶æ•°æ®çš„å‡½æ•°\ndrvstus_t rfs_readfileblk(device_t* devp, fimgrhd_t* fmp, void* buf, uint_t len)\n{\n    //æ£€æŸ¥æ–‡ä»¶çš„ç›¸å…³ä¿¡æ¯æ˜¯å¦åˆç†\n    if(fmp-&gt;fmd_sfblk != fmp-&gt;fmd_curfwritebk || fmp-&gt;fmd_curfwritebk != fmp-&gt;fmd_fleblk[0].fb_blkstart) {\n        return DFCERRSTUS;\n    }\n    //æ£€æŸ¥è¯»å–æ–‡ä»¶æ•°æ®çš„é•¿åº¦æ˜¯å¦å¤§äºï¼ˆ4096-512ï¼‰\n    if(len &gt; (FSYS_ALCBLKSZ - fmp-&gt;fmd_fileifstbkoff)) {\n        return DFCERRSTUS;\n    }\n    //æŒ‡å‘æ–‡ä»¶æ•°æ®çš„å¼€å§‹åœ°å€\n    void* wrp = (void*)((uint_t)fmp + fmp-&gt;fmd_fileifstbkoff);\n    //æŠŠæ–‡ä»¶å¼€å§‹å¤„çš„æ•°æ®å¤åˆ¶lenä¸ªå­—èŠ‚åˆ°bufæŒ‡å‘çš„ç¼“å†²åŒºä¸­\n    hal_memcpy(wrp, buf, len); \n    return DFCOKSTUS;\n}\n</code></pre><p>ä¸Šè¿°ä»£ç ä¸­è¯»å–æ–‡ä»¶æ•°æ®çš„å‡½æ•°å¾ˆç®€å•ï¼Œå…³é”®æ˜¯è¦æ˜ç™½å‰é¢é‚£ä¸ªæ‰“å¼€æ–‡ä»¶çš„å‡½æ•°ï¼Œå› ä¸ºåœ¨é‚£é‡Œå®ƒå·²ç»æŠŠæ–‡ä»¶æ•°æ®å¤åˆ¶åˆ°ä¸€ä¸ªç¼“å†²åŒºä¸­äº†ï¼Œrfs_readfileblkå‡½æ•°ä¸­çš„å‚æ•°bufã€lenéƒ½æ˜¯æ¥å£å‡½æ•°rfs_read_fileä»objnode_tç»“æ„ä¸­æå–å‡ºæ¥çš„ï¼Œå…¶å®ƒçš„éƒ¨åˆ†æˆ‘å·²ç»é€šè¿‡æ³¨é‡Šå·²ç»è¯´æ˜äº†ã€‚</p><p>å¥½äº†ï¼Œæˆ‘ä»¬ä¸‹é¢å°±æ¥å®ç°æ€ä¹ˆå‘æ–‡ä»¶ä¸­å†™å…¥æ•°æ®ï¼Œå’Œè¯»å–æ–‡ä»¶çš„æµç¨‹ä¸€æ ·ï¼Œåªä¸è¿‡è¦å°†è¦å†™å…¥çš„æ•°æ®å¤åˆ¶åˆ°æ‰“å¼€æ–‡ä»¶æ—¶ä¸ºå…¶åˆ†é…çš„ç¼“å†²åŒºä¸­ï¼Œæœ€åè¿˜è¦æŠŠæ‰“å¼€æ–‡ä»¶æ—¶ä¸ºå…¶åˆ†é…çš„ç¼“å†²åŒºä¸­çš„æ•°æ®ï¼Œå†™å…¥åˆ°ç›¸åº”çš„é€»è¾‘å‚¨å­˜å—ä¸­ã€‚</p><p>æˆ‘ä»¬è¿˜æ˜¯æŠŠå†™æ–‡ä»¶çš„æ¥å£å‡½æ•°å’Œæ ¸å¿ƒå‡½æ•°ä¸€èµ·å®ç°ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>//å†™å…¥æ–‡ä»¶æ•°æ®çš„æ¥å£å‡½æ•°\ndrvstus_t rfs_write_file(device_t* devp, void* iopack)\n{\n    objnode_t* obp = (objnode_t*)iopack;\n    //æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²ç»æ‰“å¼€ï¼Œä»¥åŠç”¨äºå­˜æ”¾æ–‡ä»¶æ•°æ®çš„ç¼“å†²åŒºå’Œå®ƒçš„å¤§å°æ˜¯å¦åˆç†\n    if(obp-&gt;on_finode == NULL || obp-&gt;on_buf == NULL || obp-&gt;on_bufsz != FSYS_ALCBLKSZ) {\n        return DFCERRSTUS;\n    }\n    return rfs_writefileblk(devp, (fimgrhd_t*)obp-&gt;on_finode, obp-&gt;on_buf, obp-&gt;on_len);\n}\n//å®é™…å†™å…¥æ–‡ä»¶æ•°æ®çš„å‡½æ•°\ndrvstus_t rfs_writefileblk(device_t* devp, fimgrhd_t* fmp, void* buf, uint_t len)\n{\n    //æ£€æŸ¥æ–‡ä»¶çš„ç›¸å…³ä¿¡æ¯æ˜¯å¦åˆç†\n    if(fmp-&gt;fmd_sfblk != fmp-&gt;fmd_curfwritebk || fmp-&gt;fmd_curfwritebk != fmp-&gt;fmd_fleblk[0].fb_blkstart) {\n        return DFCERRSTUS;\n    }\n    //æ£€æŸ¥å½“å‰å°†è¦å†™å…¥æ•°æ®çš„åç§»é‡åŠ ä¸Šå†™å…¥æ•°æ®çš„é•¿åº¦ï¼Œæ˜¯å¦å¤§äºç­‰äº4KB\n    if((fmp-&gt;fmd_curfinwbkoff + len) &gt;= FSYS_ALCBLKSZ) {\n        return DFCERRSTUS;\n    }\n    //æŒ‡å‘å°†è¦å†™å…¥æ•°æ®çš„å†…å­˜ç©ºé—´\n    void* wrp = (void*)((uint_t)fmp + fmp-&gt;fmd_curfinwbkoff);\n    //æŠŠbufç¼“å†²åŒºä¸­çš„æ•°æ®å¤åˆ¶lenä¸ªå­—èŠ‚åˆ°wrpæŒ‡å‘çš„å†…å­˜ç©ºé—´ä¸­å»\n    hal_memcpy(buf, wrp, len);\n    fmp-&gt;fmd_filesz += len;//å¢åŠ æ–‡ä»¶å¤§å°\n    //ä½¿fmd_curfinwbkoffæŒ‡å‘ä¸‹ä¸€æ¬¡å°†è¦å†™å…¥æ•°æ®çš„ä½ç½®\n    fmp-&gt;fmd_curfinwbkoff += len;\n    //æŠŠæ–‡ä»¶æ•°æ®å†™å…¥åˆ°ç›¸åº”çš„é€»è¾‘å‚¨å­˜å—ä¸­ï¼Œå®Œæˆæ•°æ®åŒæ­¥\n    write_rfsdevblk(devp, (void*)fmp, fmp-&gt;fmd_curfwritebk);\n    return DFCOKSTUS;\n}\n</code></pre><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œä½ è¦æ³¨æ„çš„æ˜¯ï¼Œ<strong>rfs_writefileblkå‡½æ•°æ°¸è¿œéƒ½æ˜¯ä»fimgrhd_t ç»“æ„çš„fmd_curfinwbkoffå­—æ®µä¸­çš„åç§»é‡å¼€å§‹å†™å…¥æ–‡ä»¶æ•°æ®çš„</strong>ï¼Œæ¯”å¦‚å‘ç©ºæ–‡ä»¶ä¸­å†™å…¥2ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆå…¶fmd_curfinwbkoffå­—æ®µçš„å€¼å°±æ˜¯2ï¼Œå› ä¸ºç¬¬0ã€1ä¸ªå­—èŠ‚ç©ºé—´å·²ç»è¢«å ç”¨äº†ï¼Œè¿™å°±æ˜¯<strong>è¿½åŠ å†™å…¥æ•°æ®</strong>çš„æ–¹å¼ã€‚</p><p>rfs_writefileblkå‡½æ•°æœ€åè°ƒç”¨write_rfsdevblkå‡½æ•°æŠŠæ–‡ä»¶æ•°æ®å†™å…¥åˆ°ç›¸åº”çš„é€»è¾‘å‚¨å­˜å—ä¸­ï¼Œå®Œæˆæ•°æ®åŒæ­¥ã€‚æˆ‘ä»¬å‘ç°åªè¦æ‰“å¼€æ–‡ä»¶äº†ï¼Œè¯»å†™æ–‡ä»¶è¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œæœ€åè¿˜è¦å®ç°å…³é—­æ–‡ä»¶çš„æ“ä½œã€‚</p><h3>å…³é—­æ–‡ä»¶</h3><p>æœ‰æ‰“å¼€æ–‡ä»¶çš„æ“ä½œï¼Œå°±éœ€è¦æœ‰å…³é—­æ–‡ä»¶çš„æ“ä½œï¼Œå› ä¸ºæ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œä¼šä¸ºæ­¤åˆ†é…ä¸€ä¸ªç¼“å†²åŒºï¼Œè¿™äº›éƒ½æ˜¯ç³»ç»Ÿèµ„æºï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªå…³é—­æ–‡ä»¶çš„æ“ä½œæ¥é‡Šæ”¾è¿™äº›èµ„æºï¼Œä»¥é˜²æ­¢ç³»ç»Ÿèµ„æºæ³„æ¼ã€‚</p><p>å…³é—­æ–‡ä»¶çš„æµç¨‹å¾ˆç®€å•ï¼Œé¦–å…ˆæ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²ç»æ‰“å¼€ã€‚ç„¶åæŠŠæ–‡ä»¶å†™å…¥åˆ°å¯¹åº”çš„é€»è¾‘å‚¨å­˜å—ä¸­ï¼Œå®Œæˆæ•°æ®çš„åŒæ­¥ã€‚æœ€åé‡Šæ”¾æ–‡ä»¶æ•°æ®å ç”¨çš„ç¼“å†²åŒºã€‚ä¸‹é¢æˆ‘ä»¬å¼€å§‹å†™ä»£ç å®ç°ï¼Œæˆ‘ä»¬ä¾ç„¶æŠŠæ¥å£å’Œæ ¸å¿ƒå‡½æ•°æ”¾åœ¨ä¸€èµ·å®ç°ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>//å…³é—­æ–‡ä»¶çš„æ¥å£å‡½æ•°\ndrvstus_t rfs_close_file(device_t* devp, void* iopack)\n{\n    objnode_t* obp = (objnode_t*)iopack;\n    //æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²ç»æ‰“å¼€äº†\n    if(obp-&gt;on_finode == NULL) { \n        return DFCERRSTUS;\n    }\n    return rfs_closefileblk(devp, obp-&gt;on_finode);\n}\n//å…³é—­æ–‡ä»¶çš„æ ¸å¿ƒå‡½æ•°\ndrvstus_t rfs_closefileblk(device_t *devp, void* fblkp)\n{\n    //æŒ‡å‘æ–‡ä»¶çš„fimgrhd_tç»“æ„\n    fimgrhd_t* fmp = (fimgrhd_t*)fblkp;\n    //å®Œæˆæ–‡ä»¶æ•°æ®çš„åŒæ­¥\n    write_rfsdevblk(devp, fblkp, fmp-&gt;fmd_sfblk);\n    //é‡Šæ”¾ç¼“å†²åŒº\n    del_buf(fblkp, FSYS_ALCBLKSZ);\n    return DFCOKSTUS;\n}\n</code></pre><p>ä¸Šè¿°ä»£ç æ˜¯éå¸¸ç®€å•çš„ï¼Œä½†åœ¨ç›®å‰çš„æƒ…å†µä¸‹ï¼Œrfs_closefileblkå‡½æ•°ä¸­æ˜¯æ²¡æœ‰å¿…è¦è°ƒç”¨write_rfsdevblkå‡½æ•°çš„ï¼Œå› ä¸ºå‰é¢åœ¨å†™å…¥æ–‡ä»¶æ•°æ®çš„åŒæ—¶ï¼Œå°±å·²ç»æŠŠæ–‡ä»¶çš„æ•°æ®å†™å…¥åˆ°é€»è¾‘å‚¨å­˜å—ä¸­å»äº†ã€‚æœ€åé‡Šæ”¾äº†å…ˆå‰æ‰“å¼€æ–‡ä»¶æ—¶åˆ†é…çš„ç¼“å†²åŒºï¼Œè€Œobjnode_tç»“æ„ä¸åº”è¯¥åœ¨æ­¤é‡Šæ”¾ï¼Œå®ƒæ˜¯ç”±Cosmoså†…æ ¸ä¸Šå±‚ç»„ä»¶è¿›è¡Œé‡Šæ”¾çš„ã€‚</p><h2>ä¸²è”æ•´åˆ</h2><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å®ç°äº†æ–‡ä»¶ç›¸å…³çš„æ“ä½œï¼Œå¹¶ä¸”æä¾›äº†æ¥å£å‡½æ•°ï¼Œä½†æ˜¯æˆ‘ä»¬çš„æ–‡ä»¶ç³»ç»Ÿæ˜¯ä»¥è®¾å¤‡çš„å½¢å¼å­˜åœ¨çš„ï¼Œæ‰€ä»¥æ–‡ä»¶æ“ä½œçš„æ¥å£ï¼Œå¿…é¡»è¦ä¸²è”æ•´åˆåˆ°æ–‡ä»¶ç³»ç»Ÿè®¾å¤‡é©±åŠ¨ç¨‹åºä¹‹ä¸­ï¼Œæ–‡ä»¶ç³»ç»Ÿæ‰èƒ½çœŸæ­£å·¥ä½œã€‚</p><p>ä¸‹é¢æˆ‘ä»¬å°±å»æ•´åˆè”ä¸²æ–‡ä»¶ç³»ç»Ÿè®¾å¤‡é©±åŠ¨ç¨‹åºã€‚é¦–å…ˆæ¥ä¸²è”æ•´åˆæ–‡ä»¶ç³»ç»Ÿçš„æ‰“å¼€æ–‡ä»¶æ“ä½œå’Œæ–°å»ºæ–‡ä»¶æ“ä½œï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>drvstus_t rfs_open(device_t* devp, void* iopack)\n{\n    objnode_t* obp=(objnode_t*)iopack;\n    //æ ¹æ®objnode_tç»“æ„ä¸­çš„è®¿é—®æ ‡å¿—è¿›è¡Œåˆ¤æ–­\n    if(obp-&gt;on_acsflgs == FSDEV_OPENFLG_OPEFILE) {\n        return rfs_open_file(devp, iopack);\n    }\n    if(obp-&gt;on_acsflgs == FSDEV_OPENFLG_NEWFILE) {\n        return rfs_new_file(devp, obp-&gt;on_fname, 0);\n    }\n    return DFCERRSTUS;\n}\n</code></pre><p>ä¸Šè¿°ä»£ç ä¸­rfs_openå‡½æ•°å¯¹åº”äºè®¾å¤‡é©±åŠ¨ç¨‹åºçš„æ‰“å¼€åŠŸèƒ½æ´¾å‘å‡½æ•°ï¼Œä½†æ²¡æœ‰ç›¸åº”çš„æ–°å»ºåŠŸèƒ½æ´¾å‘å‡½æ•°ï¼Œäºæ˜¯æˆ‘ä»¬å°±æ ¹æ®objnode_tç»“æ„ä¸­è®¿é—®æ ‡å¿—åŸŸè®¾ç½®ä¸åŒçš„ç¼–ç ï¼Œæ¥è¿›è¡Œåˆ¤æ–­ã€‚</p><p>æ¥ç€æˆ‘ä»¬æ¥ä¸²è”æ•´åˆå…³é—­æ–‡ä»¶çš„æ“ä½œã€‚è¿™æ¬¡è¦ç®€å•ä¸€äº›ï¼Œå› ä¸ºè®¾å¤‡é©±åŠ¨ç¨‹åºæœ‰å¯¹åº”çš„å…³é—­åŠŸèƒ½æ´¾å‘å‡½æ•°ï¼Œç›´æ¥è°ƒç”¨å…³é—­æ–‡ä»¶æ“ä½œçš„æ¥å£å‡½æ•°å°±å¯ä»¥äº†ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>drvstus_t rfs_close(device_t* devp, void* iopack)\n{\n    return rfs_close_file(devp, iopack);\n}\n</code></pre><p>ç„¶åæ˜¯æ–‡ä»¶è¯»å†™æ“ä½œçš„ä¸²è”æ•´åˆï¼Œè®¾å¤‡é©±åŠ¨ç¨‹åºä¹Ÿæœ‰å¯¹åº”çš„è¯»å†™åŠŸèƒ½æ´¾å‘å‡½æ•°ï¼ŒåŒæ ·ä¹Ÿæ˜¯ç›´æ¥è°ƒç”¨æ–‡ä»¶è¯»å†™æ“ä½œçš„æ¥å£å‡½æ•°å³å¯ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>drvstus_t rfs_read(device_t* devp, void* iopack)\n{\n    //è°ƒç”¨è¯»æ–‡ä»¶æ“ä½œçš„æ¥å£å‡½æ•°\n    return rfs_read_file(devp, iopack);\n}\ndrvstus_t rfs_write(device_t* devp, void* iopack)\n{\n    //è°ƒç”¨å†™æ–‡ä»¶æ“ä½œçš„æ¥å£å‡½æ•°\n    return rfs_write_file(devp, iopack);\n}\n</code></pre><p>æœ€åï¼Œæ¥ä¸²è”æ•´åˆç¨å¾®æœ‰ç‚¹å¤æ‚çš„åˆ é™¤æ–‡ä»¶æ“ä½œï¼Œè¿™æ˜¯å› ä¸ºè®¾å¤‡é©±åŠ¨ç¨‹åºæ²¡æœ‰å¯¹åº”çš„åŠŸèƒ½æ´¾å‘å‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç”¨åˆ°è®¾å¤‡é©±åŠ¨ç¨‹åºçš„æ§åˆ¶åŠŸèƒ½æ´¾å‘å‡½æ•°ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>drvstus_t rfs_ioctrl(device_t* devp, void* iopack)\n{\n    objnode_t* obp = (objnode_t*)iopack;\n    //æ ¹æ®objnode_tç»“æ„ä¸­çš„æ§åˆ¶ç è¿›è¡Œåˆ¤æ–­\n    if(obp-&gt;on_ioctrd == FSDEV_IOCTRCD_DELFILE)\n    {\n        //è°ƒç”¨åˆ é™¤æ–‡ä»¶æ“ä½œçš„æ¥å£å‡½æ•°\n        return rfs_del_file(devp, obp-&gt;on_fname, 0);\n    }\n    return DFCERRSTUS;\n}\n</code></pre><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬ç»™æ–‡ä»¶ç³»ç»Ÿè®¾å¤‡åˆ†é…äº†ä¸€ä¸ªFSDEV_IOCTRCD_DELFILEï¼ˆä¸€ä¸ªæ•´æ•°ï¼‰æ§åˆ¶ç ï¼ŒCosmoså†…æ ¸ä¸Šå±‚ç»„ä»¶çš„ä»£ç å°±å¯ä»¥æ ¹æ®éœ€è¦ï¼Œè®¾ç½®objnode_tç»“æ„ä¸­çš„æ§åˆ¶ç å°±èƒ½è¾¾åˆ°ç›¸åº”çš„ç›®çš„äº†ã€‚</p><p>ç°åœ¨ï¼Œæ–‡ä»¶ç›¸å…³çš„æ“ä½œå·²ç»ä¸²è”æ•´åˆå¥½äº†ã€‚</p><h2>æµ‹è¯•</h2><p>å‰é¢å®ç°äº†æ–‡ä»¶ç³»ç»Ÿçš„6ç§æœ€å¸¸ç”¨çš„æ–‡ä»¶æ“ä½œï¼Œå¹¶ä¸”å·²ç»æ•´åˆåˆ°æ–‡ä»¶ç³»ç»Ÿè®¾å¤‡é©±åŠ¨ç¨‹åºæ¡†æ¶ä»£ç ä¸­å»äº†ï¼Œå¯æ˜¯è¿™äº›ä»£ç ç©¶ç«Ÿå¯¹ä¸å¯¹ï¼Œæµ‹è¯•è¿è¡Œäº†æ‰çŸ¥é“ã€‚</p><p>ä¸‹é¢æ¥å†™å¥½æµ‹è¯•ä»£ç ã€‚è¦æ³¨æ„çš„æ˜¯ï¼ŒCosmosä¸‹çš„ä»»ä½•è®¾å¤‡é©±åŠ¨ç¨‹åº<strong>éƒ½å¿…é¡»è¦æœ‰objnode_tç»“æ„æ‰èƒ½è¿è¡Œ</strong>ã€‚æ‰€ä»¥ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨å»ºç«‹ä¸€ä¸ªobjnode_tç»“æ„å¹¶è®¾ç½®å¥½å…¶ä¸­çš„å­—æ®µï¼Œæ¨¡æ‹Ÿä¸€ä¸‹Cosmosä¸Šå±‚ç»„ä»¶è°ƒç”¨è®¾å¤‡é©±åŠ¨ç¨‹åºçš„è¿‡ç¨‹ã€‚</p><p>è¿™ä¸€è¿‡ç¨‹æˆ‘ä»¬å¯ä»¥å†™ä¸ªtest_fsyså‡½æ•°æ¥å®ç°ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>void test_fsys(device_t *devp)\n{\n    kprint(&quot;å¼€å§‹æ–‡ä»¶æ“ä½œæµ‹è¯•\\n&quot;);\n    void *rwbuf = new_buf(FSYS_ALCBLKSZ);//åˆ†é…ç¼“å†²åŒº\n    //æŠŠç¼“å†²åŒºä¸­çš„æ‰€æœ‰å­—èŠ‚éƒ½ç½®ä¸º0xff\n    hal_memset(rwbuf, 0xff, FSYS_ALCBLKSZ);\n    objnode_t *ondp = krlnew_objnode();//æ–°å»ºä¸€ä¸ªobjnode_tç»“æ„\n    ondp-&gt;on_acsflgs = FSDEV_OPENFLG_NEWFILE;//è®¾ç½®æ–°å»ºæ–‡ä»¶æ ‡å¿—\n    ondp-&gt;on_fname = &quot;/testfile&quot;;//è®¾ç½®æ–°å»ºæ–‡ä»¶å\n    ondp-&gt;on_buf = rwbuf;//è®¾ç½®ç¼“å†²åŒº\n    ondp-&gt;on_bufsz = FSYS_ALCBLKSZ;//è®¾ç½®ç¼“å†²åŒºå¤§å°\n    ondp-&gt;on_len = 512;//è®¾ç½®è¯»å†™å¤šå°‘å­—èŠ‚\n    ondp-&gt;on_ioctrd = FSDEV_IOCTRCD_DELFILE;//è®¾ç½®æ§åˆ¶ç \n    if (rfs_open(devp, ondp) == DFCERRSTUS) {//æ–°å»ºæ–‡ä»¶\n        hal_sysdie(&quot;æ–°å»ºæ–‡ä»¶é”™è¯¯&quot;);\n    }\n    ondp-&gt;on_acsflgs = FSDEV_OPENFLG_OPEFILE;//è®¾ç½®æ‰“å¼€æ–‡ä»¶æ ‡å¿—\n    if (rfs_open(devp, ondp) == DFCERRSTUS) {//æ‰“å¼€æ–‡ä»¶\n        hal_sysdie(&quot;æ‰“å¼€æ–‡ä»¶é”™è¯¯&quot;);\n    }\n    if (rfs_write(devp, ondp) == DFCERRSTUS) {//æŠŠæ•°æ®å†™å…¥æ–‡ä»¶\n        hal_sysdie(&quot;å†™å…¥æ–‡ä»¶é”™è¯¯&quot;);\n    }\n    hal_memset(rwbuf, 0, FSYS_ALCBLKSZ);//æ¸…é›¶ç¼“å†²åŒº\n    if (rfs_read(devp, ondp) == DFCERRSTUS) {//è¯»å–æ–‡ä»¶æ•°æ®\n        hal_sysdie(&quot;è¯»å–æ–‡ä»¶é”™è¯¯&quot;);\n    }\n    if (rfs_close(devp, ondp) == DFCERRSTUS) {//å…³é—­æ–‡ä»¶\n        hal_sysdie(&quot;å…³é—­æ–‡ä»¶é”™è¯¯&quot;);\n    }\n    u8_t *cb = (u8_t *)rwbuf;//æŒ‡å‘ç¼“å†²åŒº\n    for (uint_t i = 0; i &lt; 512; i++) {//æ£€æŸ¥ç¼“å†²åŒºç©ºé—´ä¸­çš„å¤´512ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œæ˜¯å¦ä¸º0xff\n        if (cb[i] != 0xff) {//å¦‚æœä¸ç­‰äº0xffå°±æ­»æœº\n            hal_sysdie(&quot;æ£€æŸ¥æ–‡ä»¶å†…å®¹é”™è¯¯&quot;);\n        }\n        kprint(&quot;testfileæ–‡ä»¶ç¬¬[%x]ä¸ªå­—èŠ‚æ•°æ®:%x\\n&quot;, i, (uint_t)cb[i]);//æ‰“å°æ–‡ä»¶å†…å®¹\n    }\n    if (rfs_ioctrl(devp, ondp) == DFCERRSTUS){//åˆ é™¤æ–‡ä»¶\n        hal_sysdie(&quot;åˆ é™¤æ–‡ä»¶é”™è¯¯&quot;);\n    }\n    ondp-&gt;on_acsflgs = FSDEV_OPENFLG_OPEFILE;//å†æ¬¡è®¾ç½®æ‰“å¼€æ–‡ä»¶æ ‡å¿—\n    if (rfs_open(devp, ondp) == DFCERRSTUS) {//å†æ¬¡æ‰“å¼€æ–‡ä»¶\n        hal_sysdie(&quot;å†æ¬¡æ‰“å¼€æ–‡ä»¶å¤±è´¥&quot;);\n    }\n    hal_sysdie(&quot;ç»“æŸæ–‡ä»¶æ“ä½œæµ‹è¯•&quot;);\n    return;\n}\n</code></pre><p>ä¸Šè¿°ä»£ç è™½ç„¶æœ‰ç‚¹é•¿ï¼Œå› ä¸ºæˆ‘ä»¬ä¸€ä¸‹å­æµ‹è¯•äº†å…³äºæ–‡ä»¶çš„6å¤§æ“ä½œã€‚æ¯ä¸ªæ–‡ä»¶æ“ä½œå¤±è´¥åéƒ½ä¼šæ­»æœºï¼Œä¸ä¼šç»§ç»­å‘ä¸‹è¿è¡Œã€‚</p><p>æµ‹è¯•é€»è¾‘å¾ˆç®€å•ï¼šå¼€å§‹ä¼šå»ºç«‹å¹¶æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œæ¥ç€å†™å…¥æ•°æ®ï¼Œç„¶åè¯»å–æ–‡ä»¶ä¸­æ•°æ®è¿›è¡Œæ¯”è¾ƒï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯å’Œä¹‹å‰å†™å…¥çš„æ•°æ®ç›¸ç­‰ï¼Œæœ€ååˆ é™¤è¿™ä¸ªæ–‡ä»¶å¹¶å†æ¬¡æ‰“å¼€ï¼Œçœ‹æ˜¯å¦ä¼šå‡ºé”™ã€‚å› ä¸ºæ–‡ä»¶å·²ç»åˆ é™¤äº†ï¼Œæ‰“å¼€ä¸€ä¸ªå·²ç»åˆ é™¤çš„æ–‡ä»¶è‡ªç„¶è¦å‡ºé”™ï¼Œå‡ºé”™å°±è¯´æ˜æµ‹è¯•æˆåŠŸã€‚</p><p>ç°åœ¨æˆ‘ä»¬æŠŠtest_fsyså‡½æ•°æ”¾åœ¨rfs_entryå‡½æ•°çš„æœ€åè°ƒç”¨ï¼Œç„¶åæ‰“å¼€ç»ˆç«¯åˆ‡æ¢åˆ°cosmosç›®å½•ä¸‹æ‰§è¡Œmake vboxtest å‘½ä»¤ï¼Œæœ€åä¸å‡ºæ„å¤–çš„è¯ï¼Œä½ ä¼šçœ‹åˆ°å¦‚ä¸‹å›¾æ‰€ç¤ºçš„æƒ…å†µã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/ed/d4/eddb4f92fd55c34113ba55c81e2b95d4.jpg?wh=1044x921\" alt=\"\" title=\"æ–‡ä»¶æ“ä½œæµ‹è¯•ç¤ºæ„å›¾\"></p><p>ä»å›¾é‡Œæˆ‘ä»¬èƒ½çœ‹åˆ°ï¼Œæ–‡ä»¶ä¸­çš„æ•°æ®å’Œæœ€åé‡æ–°æ‰“å¼€å·²ç»åˆ é™¤æ–‡ä»¶æ—¶å‡ºç°çš„é”™è¯¯ï¼Œè¿™è¯´æ˜äº†æˆ‘ä»¬çš„ä»£ç æ˜¯æ­£ç¡®æ— è¯¯çš„ã€‚</p><p>è‡³æ­¤ ï¼Œæµ‹è¯•äº†æ–‡ä»¶ç›¸å…³çš„6å¤§æ“ä½œçš„ä»£ç ï¼Œä»£ç è´¨é‡éƒ½æ˜¯ç›¸å½“é«˜çš„ï¼Œéƒ½è¾¾åˆ°äº†æˆ‘ä»¬çš„é¢„æœŸï¼Œä¸€ä¸ªç®€å•ã€æœ‰è¯¸å¤šé™åˆ¶ä½†å´äº”è„ä¿±å…¨çš„æ–‡ä»¶ç³»ç»Ÿå°±å®ç°äº†ã€‚</p><h2>é‡ç‚¹å›é¡¾</h2><p>è¿™èŠ‚è¯¾å‘Šä¸€æ®µè½ï¼Œæ­å–œä½ åšæŒåˆ°è¿™é‡Œã€‚</p><p>æ–‡ä»¶ç³»ç»Ÿè™½ç„¶å¤æ‚ï¼Œä½†æˆ‘ä»¬å‘ç°åªè¦åšå¾—è¶³å¤Ÿâ€œå°â€ï¼Œå°±èƒ½å¤§å¤§é™ä½äº†å®ç°çš„éš¾åº¦ã€‚è™½ç„¶é™ä½äº†å®ç°çš„éš¾åº¦ï¼Œä½†æˆ‘ä»¬çš„rfsæ–‡ä»¶ç³»ç»Ÿä¾ç„¶åŒ…å«äº†ä¸€ä¸ªæ­£å¸¸æ–‡ä»¶ç³»ç»Ÿæ‰€å…·æœ‰çš„åŠŸèƒ½ç‰¹æ€§ï¼Œç°åœ¨æˆ‘æ¥ä¸ºä½ æ¢³ç†ä¸€ä¸‹æœ¬èŠ‚è¯¾çš„é‡ç‚¹ï¼š</p><p>1.é¦–å…ˆæ˜¯æ–‡ä»¶ç³»ç»Ÿçš„è¾…åŠ©æ“ä½œï¼Œå› ä¸ºæ–‡ä»¶ç³»ç»Ÿçš„å¤æ‚æ€§ï¼Œæ‰€ä»¥å¿…é¡»è¦å®ç°ä¸€äº›å¦‚è·å–ä¸é‡Šæ”¾æ ¹ç›®å½•æ–‡ä»¶ã€è·å–æ–‡ä»¶åã€åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨ç­‰åŸºç¡€è¾…åŠ©æ“ä½œå‡½æ•°ã€‚</p><p>2.ç„¶åå®ç°äº†æ–‡ä»¶ç³»ç»Ÿå¿…é¡»è¦æä¾›çš„6å¤§æ–‡ä»¶æ“ä½œï¼š<strong>æ–°å»ºæ–‡ä»¶ã€åˆ é™¤æ–‡ä»¶ã€æ‰“å¼€æ–‡ä»¶ã€è¯»å†™æ–‡ä»¶ã€å…³é—­æ–‡ä»¶</strong>ã€‚</p><p>3.æœ€åæŠŠè¿™äº›æ–‡ä»¶æ“ä½œå…¨éƒ¨ä¸²è”æ•´åˆåˆ°æ–‡ä»¶ç³»ç»Ÿè®¾å¤‡é©±åŠ¨ç¨‹åºä¹‹ä¸­ï¼Œå¹¶ä¸”è¿›è¡Œäº†æµ‹è¯•ï¼Œç¡®è®¤ä»£ç æ­£ç¡®æ— è¯¯ã€‚</p><p>ä»Šå¤©è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬åˆå®ç°äº†Cosmoså†…æ ¸çš„ä¸€ä¸ªåŸºç¡€ç»„ä»¶ï¼Œå³æ–‡ä»¶ç³»ç»Ÿï¼Œä¸è¿‡å®ƒæ˜¯ä»¥<strong>è®¾å¤‡çš„å½¢å¼</strong>å­˜åœ¨çš„ï¼Œè¿™æ ·åšæ˜¯ä¸ºäº†æ–¹ä¾¿ä»¥åçš„æ‰©å±•å’Œç§»æ¤ã€‚</p><p>ç°åœ¨æ–‡ä»¶ç³»ç»Ÿæ˜¯å®ç°äº†ï¼Œä¸è¿‡è¿˜ä¸å¤Ÿå®Œå–„ã€‚ä½ å¯èƒ½åœ¨æƒ³ï¼Œæˆ‘ä»¬æ–‡ä»¶ç³»ç»Ÿåœ¨å†…å­˜ä¸­ï¼Œä¸€æ–­ç”µæ•°æ®å°±å…¨å®Œäº†ã€‚æ˜¯çš„ï¼Œä¸è¿‡ä½ å¯ä»¥å°è¯•å†™å¥½ç¡¬ç›˜é©±åŠ¨ï¼Œç„¶åæŠŠå†…å­˜ä¸­çš„é€»è¾‘å‚¨å­˜å—å†™å…¥åˆ°ç¡¬ç›˜ä¸­å°±è¡Œäº†ï¼ŒæœŸå¾…ä½ çš„å®ç°ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>è¯·ä½ æƒ³ä¸€æƒ³ï¼Œæˆ‘ä»¬è¿™ä¸ªç®€å•çš„ã€å°çš„ï¼Œå´äº”è„ä¿±å…¨çš„æ–‡ä»¶ç³»ç»Ÿæœ‰å“ªäº›é™åˆ¶ï¼Ÿ</p><p>æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºè®°å½•ä½ çš„æ”¶è·æˆ–ç–‘é—®ï¼Œä¹Ÿé¼“åŠ±ä½ è¾¹å­¦è¾¹ç»ƒï¼Œå¤šå¤šåŠ¨æ‰‹å®è·µã€‚åŒæ—¶æˆ‘æ¨èä½ æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™èº«è¾¹çš„æœ‹å‹ï¼Œè·Ÿä»–ä¸€èµ·å­¦ä¹ è¿›æ­¥ã€‚</p><p>å¥½ï¼Œæˆ‘æ˜¯LMOSï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ã€‚</p>","comments":[{"had_liked":false,"id":306105,"user_name":"neohope","can_delete":false,"product_type":"c1","uid":1043475,"ip_address":"","ucode":"C0268F6E7E2B6E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg","comment_is_top":true,"comment_ctime":1628351484,"is_pvip":false,"replies":[{"id":"110840","content":"æ€»ç»“åˆ°ä½ ","user_name":"ä½œè€…å›å¤","user_name_real":"LMOS","uid":"1345199","ctime":1628478180,"ip_address":"","comment_id":306105,"utype":1}],"discussion_count":1,"race_medal":0,"score":"9.2233720470730998e+18","product_id":100078401,"comment_content":"å››ã€æ–‡ä»¶ç³»ç»Ÿä½¿ç”¨ã€1ã€åªæœ‰ä¸€çº§ç›®å½•ï¼›2ã€æ–‡ä»¶ç®¡ç†ç»“æ„+æ–‡ä»¶å¤§å°&lt;=4Kã€‘<br>1ã€åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨<br>è®¡ç®—å¾—åˆ°æ–‡ä»¶å<br>æ‰¾åˆ°æ ¹ç›®å½•æ–‡ä»¶å—<br>è·³è¿‡ç®¡ç†ç»“æ„ï¼Œéå†å…¨éƒ¨rfsdir_tç›®å½•ç»“æ„ï¼Œå¦‚æœæœ‰é‡åçš„å°±è¿”å›ï¼Œæ²¡æœ‰å°±å¤±è´¥<br><br>2ã€æ–°å»ºæ–‡ä»¶<br>Aã€ç¡®è®¤æ–‡ä»¶å¹¶ä¸å­˜åœ¨ï¼Œå­˜åœ¨å°±æŠ¥é”™<br>Bã€æ‰¾åˆ°æ ¹ç›®å½•æ–‡ä»¶å—<br>Cã€ç”³è¯·ä¸€ä¸ªé€»è¾‘å—<br>Dã€è·³è¿‡ç®¡ç†ç»“æ„ï¼Œæ–°å¢ä¸€ä¸ªrfsdir_tç›®å½•ç»“æ„ï¼Œå¹¶æŒ‡å‘æ–°ç”³è¯·çš„é€»è¾‘å—<br>Eã€åœ¨é€»è¾‘å—å¼€å§‹å»ºç«‹æ–°çš„fimgrhd_tæ–‡ä»¶ç®¡ç†ç»“æ„<br><br>3ã€åˆ é™¤æ–‡ä»¶<br>Aã€æ‰¾åˆ°æ ¹ç›®å½•æ–‡ä»¶å¿«<br>Bã€è·³è¿‡ç®¡ç†ç»“æ„ï¼Œéå†å…¨éƒ¨rfsdir_tç›®å½•ç»“æ„ï¼Œå¦‚æœæ²¡æœ‰å°±å¤±è´¥<br>Cã€å°†rfsdir_tæ ‡è¯†ä¸ºåˆ é™¤<br>Dã€å›æ”¶é€»è¾‘å—<br><br>4ã€æ‰“å¼€æ–‡ä»¶<br>Aã€æ‰¾åˆ°æ ¹ç›®å½•æ–‡ä»¶å¿«<br>Bã€è·³è¿‡ç®¡ç†ç»“æ„ï¼Œéå†å…¨éƒ¨rfsdir_tç›®å½•ç»“æ„ï¼Œå¦‚æœæ²¡æœ‰å°±å¤±è´¥<br>Cã€è¯»å–é€»è¾‘å—ï¼Œè¿”å›<br><br>5ã€è¯»å–æ–‡ä»¶<br>Aã€åˆ¤æ–­æ–‡ä»¶å·²æ‰“å¼€<br>Bã€æ ¹æ®æ–‡ä»¶åç§»åŠè¯»å–é•¿åº¦ï¼Œè¿”å›æ•°æ®<br><br>6ã€å†™å…¥æ–‡ä»¶<br>Aã€åˆ¤æ–­æ–‡ä»¶å·²æ‰“å¼€<br>Bã€æ•°æ®è¿½åŠ åˆ°ç¼“å­˜ä¸­<br>Cã€ç¼“å­˜å†™å…¥åˆ°è®¾å¤‡ä¸­<br><br>7ã€å…³é—­è®¾å¤‡<br>Aã€åˆ¤æ–­æ–‡ä»¶å·²æ‰“å¼€<br>Bã€ç¼“å­˜å†™å…¥åˆ°è®¾å¤‡ä¸­<br>Cã€é‡Šæ”¾ç¼“å­˜","like_count":2,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":524631,"discussion_content":"æ€»ç»“åˆ°ä½ ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628478180,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":304102,"user_name":"pedro","can_delete":false,"product_type":"c1","uid":1200704,"ip_address":"","ucode":"F40C839DDFD599","user_header":"https://static001.geekbang.org/account/avatar/00/12/52/40/e57a736e.jpg","comment_is_top":false,"comment_ctime":1627256555,"is_pvip":false,"replies":[{"id":"110043","content":"å“ˆå“ˆæ˜¯çš„ï¼Œä½ æœ‰èƒ½åŠ›å¯ä»¥å†™ä¸ªç¡¬ç›˜é©±åŠ¨ï¼Œåœ¨rfsè¿™ä¸ªé©±åŠ¨ä¸­ï¼Œå°†IOåŒ…ç»§ç»­ä¸‹å‘ç»™ç¡¬ç›˜é©±åŠ¨ï¼Œè®©ç¡¬ç›˜é©±åŠ¨å†™å…¥åˆ°ç¡¬ç›˜ï¼Œç”±æ­¤ï¼Œæœ‰å±‚å±‚é©±åŠ¨å †å çš„IOæ ˆå°±å½¢æˆäº† ","user_name":"ä½œè€…å›å¤","user_name_real":"LMOS","uid":"1345199","ctime":1627262365,"ip_address":"","comment_id":304102,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14512158443","product_id":100078401,"comment_content":"é™åˆ¶1ï¼šä¸å¯æŒä¹…åŒ–ï¼Œä¸æ”¯æŒcrashæ¢å¤ï¼Œåº”åŠ å…¥ç£ç›˜å—çš„å†™å…¥ï¼Œå†…å­˜ä¸­æœ‰ä¸€å®šæ–‡ä»¶å—çš„ç¼“å­˜ï¼Œæ”¯æŒæ—¥å¿—ï¼Œé˜²æ­¢ç³»ç»Ÿå´©æºƒï¼Œæ–‡ä»¶æ•°æ®ä¸¢å¤±ã€‚<br>é™åˆ¶2ï¼šç¼ºå°‘æŠ½è±¡å±‚ï¼Œæ— æ³•æ”¯æŒå¤šç§æ ¼å¼çš„æ–‡ä»¶ã€‚<br>é™åˆ¶3ï¼šå°é‡å†…å­˜å¼æ–‡ä»¶ç³»ç»Ÿï¼Œæ²¡æœ‰ä½¿ç”¨ç£ç›˜ï¼Œä¸æ”¯æŒ mount ç­‰éªšæ“ä½œã€‚<br>ç­‰ç­‰â€¦â€¦","like_count":3,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":523931,"discussion_content":"å“ˆå“ˆæ˜¯çš„ï¼Œä½ æœ‰èƒ½åŠ›å¯ä»¥å†™ä¸ªç¡¬ç›˜é©±åŠ¨ï¼Œåœ¨rfsè¿™ä¸ªé©±åŠ¨ä¸­ï¼Œå°†IOåŒ…ç»§ç»­ä¸‹å‘ç»™ç¡¬ç›˜é©±åŠ¨ï¼Œè®©ç¡¬ç›˜é©±åŠ¨å†™å…¥åˆ°ç¡¬ç›˜ï¼Œç”±æ­¤ï¼Œæœ‰å±‚å±‚é©±åŠ¨å †å çš„IOæ ˆå°±å½¢æˆäº† ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627262365,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":304104,"user_name":"LDxy","can_delete":false,"product_type":"c1","uid":1188710,"ip_address":"","ucode":"956432CE7B7761","user_header":"https://static001.geekbang.org/account/avatar/00/12/23/66/413c0bb5.jpg","comment_is_top":false,"comment_ctime":1627257680,"is_pvip":false,"replies":[{"id":"110042","content":"å¯¹ï¼Œæ²¡æœ‰å®ç°","user_name":"ä½œè€…å›å¤","user_name_real":"LMOS","uid":"1345199","ctime":1627262170,"ip_address":"","comment_id":304104,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10217192272","product_id":100078401,"comment_content":"å¥½åƒè¿˜ç¼ºå°‘seekæ“ä½œ","like_count":2,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":523933,"discussion_content":"å¯¹ï¼Œæ²¡æœ‰å®ç°","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627262170,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":317266,"user_name":"Kinco.","can_delete":false,"product_type":"c1","uid":2436224,"ip_address":"","ucode":"D73F24903CD379","user_header":"https://static001.geekbang.org/account/avatar/00/25/2c/80/20632858.jpg","comment_is_top":false,"comment_ctime":1634727407,"is_pvip":false,"replies":[{"id":"115370","content":"æ˜¯çš„ æ˜¯çš„","user_name":"ä½œè€…å›å¤","user_name_real":"LMOS","uid":"1345199","ctime":1635211971,"ip_address":"","comment_id":317266,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5929694703","product_id":100078401,"comment_content":"1. ä¸æ”¯æŒå¤šç§æ ¼å¼çš„æ–‡ä»¶ï¼›<br>2. ä¸æ”¯æŒå¤šå±‚ç›®å½•ï¼›<br>3. ä¸æ”¯æŒseekæ“ä½œã€‚","like_count":1,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":528741,"discussion_content":"æ˜¯çš„ æ˜¯çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635211971,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":345515,"user_name":"è‰¾æ©å‡","can_delete":false,"product_type":"c1","uid":2950704,"ip_address":"","ucode":"F2B81BF4F0106A","user_header":"https://static001.geekbang.org/account/avatar/00/2d/06/30/c26ea06a.jpg","comment_is_top":false,"comment_ctime":1652345127,"is_pvip":false,"replies":[{"id":"126512","content":"æ˜¯çš„ æ”¯æŒå¤šçº§ ç›®å½• ä»£ç ä¼šæ›´åŠ å¤æ‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1345199","ctime":1653618325,"ip_address":"","comment_id":345515,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1652345127","product_id":100078401,"comment_content":"æ‰“å¡ï¼Œæœç„¶ä¸æ”¯æŒå¤šçº§ç›®å½•ï¼Œæ›´å¤šçš„æ˜¯ä½“ä¼šä¸€ä¸‹ï¼Œosä¸­çš„æ–‡ä»¶æ“ä½œ","like_count":0,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":573723,"discussion_content":"æ˜¯çš„ æ”¯æŒå¤šçº§ ç›®å½• ä»£ç ä¼šæ›´åŠ å¤æ‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1653618326,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":344978,"user_name":"MONKEYG","can_delete":false,"product_type":"c1","uid":2519235,"ip_address":"","ucode":"81C780AA899A9E","user_header":"https://static001.geekbang.org/account/avatar/00/26/70/c3/cc46c55a.jpg","comment_is_top":false,"comment_ctime":1651911045,"is_pvip":false,"replies":[{"id":"125959","content":"æ²¡æœ‰è¿™ä¸ªå‡½æ•°å•Š","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1345199","ctime":1652065392,"ip_address":"","comment_id":344978,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1651911045","product_id":100078401,"comment_content":"æˆ‘æƒ³è¯·é—®ä¸‹ï¼Œè¿™ä¸ªtry_entryæ˜¯è°åœ¨è°ƒç”¨çš„ğŸ˜‚ğŸ˜‚","like_count":0,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":571065,"discussion_content":"æ²¡æœ‰è¿™ä¸ªå‡½æ•°å•Š","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1652065392,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":335487,"user_name":"if...else...","can_delete":false,"product_type":"c1","uid":2550743,"ip_address":"","ucode":"D0565908C99695","user_header":"https://static001.geekbang.org/account/avatar/00/26/eb/d7/90391376.jpg","comment_is_top":false,"comment_ctime":1645536614,"is_pvip":false,"replies":[{"id":"122559","content":"å—¯å—¯","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1345199","ctime":1645582160,"ip_address":"","comment_id":335487,"utype":1}],"discussion_count":1,"race_medal":4,"score":"1645536614","product_id":100078401,"comment_content":"æ–‡ä»¶æŸ¥è¯¢","like_count":0,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":552734,"discussion_content":"å—¯å—¯","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1645582161,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":329664,"user_name":"kocgockohgohç‹è£’","can_delete":false,"product_type":"c1","uid":2617112,"ip_address":"","ucode":"35EFABDE0D713D","user_header":"https://static001.geekbang.org/account/avatar/00/27/ef/18/6a620733.jpg","comment_is_top":false,"comment_ctime":1641461298,"is_pvip":false,"replies":[{"id":"120233","content":"æ˜¯çš„","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1345199","ctime":1641779361,"ip_address":"","comment_id":329664,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1641461298","product_id":100078401,"comment_content":"è¯·é—®åˆ é™¤æ–‡ä»¶çš„æ—¶å€™ æ˜¯ä¸æ˜¯åœ¨æ ¹ç›®å½•æ–‡ä»¶äº§ç”Ÿç©ºæ´å•Š æ–°å»ºæ–‡ä»¶æ€»æ˜¯ä»æ ¹ç›®å½•æ–‡ä»¶æœ«å°¾æ“ä½œ","like_count":0,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":544913,"discussion_content":"æ˜¯çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641779361,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":305476,"user_name":"al_åŸ¹é¾™","can_delete":false,"product_type":"c1","uid":1039597,"ip_address":"","ucode":"C8E9D775D28D91","user_header":"https://static001.geekbang.org/account/avatar/00/0f/dc/ed/3fe13e55.jpg","comment_is_top":false,"comment_ctime":1627986377,"is_pvip":false,"replies":[{"id":"110596","content":"å¯¹ å¯¹ å¯¹  ","user_name":"ä½œè€…å›å¤","user_name_real":"LMOS","uid":"1345199","ctime":1628128270,"ip_address":"","comment_id":305476,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1627986377","product_id":100078401,"comment_content":"å¥½åƒä¸æ”¯æŒå¤šçº§ç›®å½•å§","like_count":0,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":524396,"discussion_content":"å¯¹ å¯¹ å¯¹  ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628128270,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2308439,"avatar":"https://static001.geekbang.org/account/avatar/00/23/39/57/b1e6b147.jpg","nickname":"ç¯ç«é˜‘çŠ","note":"","ucode":"75FBF8552A92DB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":537671,"discussion_content":"ä½ æ˜¯æ€ä¹ˆå‘ç°çš„ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639134999,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}