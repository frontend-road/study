{"id":471138,"title":"27ï½œå³å­¦å³ç»ƒï¼šè·Ÿè¸ªå‡½æ•°è°ƒç”¨é“¾ï¼Œç†è§£ä»£ç æ›´ç›´è§‚","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯Tony Baiã€‚</p><p>æ—¶é—´è¿‡å¾—çœŸå¿«ï¼è½¬çœ¼é—´æˆ‘ä»¬å·²ç»å®Œæˆäº†è¿™é—¨è¯¾åŸºç¡€ç¯‡Goè¯­æ³•éƒ¨åˆ†çš„å­¦ä¹ ã€‚åœ¨è¿™ä¸€éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬ä»å˜é‡å£°æ˜å¼€å§‹ï¼Œä¸€ç›´å­¦åˆ°äº†Goå‡½æ•°ä¸æ–¹æ³•çš„è®¾è®¡ï¼Œä¸çŸ¥é“ä½ æŒæ¡å¾—æ€ä¹ˆæ ·å‘¢ï¼ŸåŸºç¡€ç¯‡çš„é‡ç‚¹æ˜¯<strong>å¯¹GoåŸºç¡€è¯­æ³•éƒ¨åˆ†çš„ç†è§£</strong>ï¼Œåªæœ‰ç†è§£é€äº†ï¼Œæˆ‘ä»¬æ‰èƒ½åœ¨åŠ¨æ‰‹å®è·µçš„ç¯èŠ‚è¿ç”¨è‡ªå¦‚ã€‚</p><p>åŒæ—¶ï¼ŒåŸºç¡€ç¯‡ä¹Ÿæ˜¯æ•´ä¸ªè¯¾ç¨‹ç¯‡å¹…æœ€å¤šçš„éƒ¨åˆ†ï¼Œæƒ³å¿…å­¦åˆ°è¿™é‡Œï¼Œä½ å·®ä¸å¤šä¹Ÿè¿›å…¥äº†ä¸€ä¸ªâ€œç–²åŠ³æœŸâ€ã€‚ä¸ºäº†ç»™ä½ çš„å¤§è„‘â€œå……å……ç”µâ€ï¼Œæˆ‘åœ¨è¿™ä¸€è®²ï¼Œä¹Ÿå°±æ˜¯åŸºç¡€ç¯‡çš„æœ€åä¸€è®²ä¸­å®‰æ’äº†ä¸€ä¸ªå°å®æˆ˜é¡¹ç›®ï¼Œé€‚å½“æ”¾æ¾ä¸€ä¸‹ï¼Œä¹Ÿå¸Œæœ›ä½ åœ¨å®ç°è¿™ä¸ªå®æˆ˜é¡¹ç›®çš„è¿‡ç¨‹ä¸­ï¼Œèƒ½å¯¹åŸºç¡€ç¯‡æ‰€å­¦çš„å†…å®¹åšä¸€ä¸ªå›é¡¾ä¸æ€»ç»“ï¼Œå¤¯å®ä¸€ä¸‹Goçš„è¯­æ³•åŸºç¡€ã€‚</p><h2>å¼•å­</h2><p>åœ¨å‰é¢çš„<a href=\"https://time.geekbang.org/column/article/464273\">ç¬¬23è®²</a>ä¸­ï¼Œæˆ‘æ›¾ç•™è¿‡è¿™æ ·çš„ä¸€é“æ€è€ƒé¢˜ï¼šâ€œé™¤äº†æ•æ‰panicã€å»¶è¿Ÿé‡Šæ”¾èµ„æºå¤–ï¼Œæˆ‘ä»¬æ—¥å¸¸ç¼–ç ä¸­è¿˜æœ‰å“ªäº›ä½¿ç”¨deferçš„å°æŠ€å·§å‘¢ï¼Ÿâ€</p><p>è¿™ä¸ªæ€è€ƒé¢˜å¾—åˆ°äº†åŒå­¦ä»¬çš„çƒ­çƒˆå“åº”ï¼Œæœ‰åŒå­¦åœ¨ç•™è¨€åŒºæåˆ°ï¼š<strong>ä½¿ç”¨deferå¯ä»¥è·Ÿè¸ªå‡½æ•°çš„æ‰§è¡Œè¿‡ç¨‹</strong>ã€‚æ²¡é”™ï¼è¿™çš„ç¡®æ˜¯deferçš„ä¸€ä¸ªå¸¸è§çš„ä½¿ç”¨æŠ€å·§ï¼Œå¾ˆå¤šGoæ•™ç¨‹åœ¨è®²è§£deferæ—¶ä¹Ÿä¼šç»å¸¸ä½¿ç”¨è¿™ä¸ªç”¨é€”ä¸¾ä¾‹ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬å…·ä½“æ˜¯æ€ä¹ˆç”¨deferæ¥å®ç°å‡½æ•°æ‰§è¡Œè¿‡ç¨‹çš„è·Ÿè¸ªå‘¢ï¼Ÿè¿™é‡Œï¼Œæˆ‘ç»™å‡ºäº†ä¸€ä¸ªæœ€ç®€å•çš„å®ç°ï¼š</p><pre><code class=\"language-plain\">// trace.go\npackage main\n  \nfunc Trace(name string) func() {\n    println(\"enter:\", name)\n    return func() {\n        println(\"exit:\", name)\n    }\n}\n\nfunc foo() {\n    defer Trace(\"foo\")()\n    bar()\n}\n\nfunc bar() {\n    defer Trace(\"bar\")()\n}\n\nfunc main() {\n    defer Trace(\"main\")()\n    foo()\n}\n</code></pre><!-- [[[read_end]]] --><p>åœ¨è®²è§£è¿™æ®µä»£ç çš„åŸç†ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹è¿™æ®µä»£ç çš„æ‰§è¡Œç»“æœï¼Œç›´è§‚æ„Ÿå—ä¸€ä¸‹ä»€ä¹ˆæ˜¯<strong>å‡½æ•°è°ƒç”¨è·Ÿè¸ª</strong>ï¼š</p><pre><code class=\"language-plain\">enter: main\nenter: foo\nenter: bar\nexit: bar\nexit: foo\nexit: main\n</code></pre><p>æˆ‘ä»¬çœ‹åˆ°ï¼Œè¿™ä¸ªGoç¨‹åºçš„å‡½æ•°è°ƒç”¨çš„å…¨è¿‡ç¨‹ä¸€ç›®äº†ç„¶åœ°å±•ç°åœ¨äº†æˆ‘ä»¬é¢å‰ï¼šç¨‹åºæŒ‰<code>main -&gt; foo -&gt; bar</code>çš„å‡½æ•°è°ƒç”¨æ¬¡åºæ‰§è¡Œï¼Œä»£ç åœ¨å‡½æ•°çš„å…¥å£ä¸å‡ºå£å¤„åˆ†åˆ«è¾“å‡ºäº†è·Ÿè¸ªæ—¥å¿—ã€‚</p><p>é‚£è¿™æ®µä»£ç æ˜¯æ€ä¹ˆåšåˆ°çš„å‘¢ï¼Ÿæˆ‘ä»¬ç®€è¦åˆ†æä¸€ä¸‹ã€‚</p><p>åœ¨è¿™æ®µå®ç°ä¸­ï¼Œæˆ‘ä»¬åœ¨æ¯ä¸ªå‡½æ•°çš„å…¥å£å¤„éƒ½ä½¿ç”¨deferè®¾ç½®äº†ä¸€ä¸ªdeferredå‡½æ•°ã€‚æ ¹æ®<a href=\"https://time.geekbang.org/column/article/464273\">ç¬¬23è®²</a>ä¸­è®²è§£çš„deferçš„è¿ä½œæœºåˆ¶ï¼ŒGoä¼šåœ¨deferè®¾ç½®deferredå‡½æ•°æ—¶å¯¹deferåé¢çš„è¡¨è¾¾å¼è¿›è¡Œæ±‚å€¼ã€‚</p><p>æˆ‘ä»¬ä»¥fooå‡½æ•°ä¸­çš„<code>defer Trace(\"foo\")()</code>è¿™è¡Œä»£ç ä¸ºä¾‹ï¼ŒGoä¼šå¯¹deferåé¢çš„è¡¨è¾¾å¼<code>Trace(\"foo\")()</code>è¿›è¡Œæ±‚å€¼ã€‚ç”±äºè¿™ä¸ªè¡¨è¾¾å¼åŒ…å«ä¸€ä¸ªå‡½æ•°è°ƒç”¨<code>Trace(\"foo\")</code>ï¼Œæ‰€ä»¥è¿™ä¸ªå‡½æ•°ä¼šè¢«æ‰§è¡Œã€‚</p><p>ä¸Šé¢çš„Traceå‡½æ•°åªæ¥å—ä¸€ä¸ªå‚æ•°ï¼ŒË™è¿™ä¸ªå‚æ•°ä»£è¡¨å‡½æ•°åï¼ŒTraceä¼šé¦–å…ˆæ‰“å°è¿›å…¥æŸå‡½æ•°çš„æ—¥å¿—ï¼Œæ¯”å¦‚ï¼š<code>â€œenter: fooâ€</code>ã€‚ç„¶åè¿”å›ä¸€ä¸ªé—­åŒ…å‡½æ•°ï¼Œè¿™ä¸ªé—­åŒ…å‡½æ•°ä¸€æ—¦è¢«æ‰§è¡Œï¼Œå°±ä¼šè¾“å‡ºç¦»å¼€æŸå‡½æ•°çš„æ—¥å¿—ã€‚åœ¨fooå‡½æ•°ä¸­ï¼Œè¿™ä¸ªç”±Traceå‡½æ•°è¿”å›çš„é—­åŒ…å‡½æ•°å°±è¢«è®¾ç½®ä¸ºäº†deferredå‡½æ•°ï¼Œäºæ˜¯å½“fooå‡½æ•°è¿”å›åï¼Œè¿™ä¸ªé—­åŒ…å‡½æ•°å°±ä¼šè¢«æ‰§è¡Œï¼Œè¾“å‡º<code>â€œexit: fooâ€</code>çš„æ—¥å¿—ã€‚</p><p>ææ¸…æ¥šä¸Šé¢è·Ÿè¸ªå‡½æ•°è°ƒç”¨é“¾çš„å®ç°åŸç†åï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹è¿™ä¸ªå®ç°ã€‚æˆ‘ä»¬ä¼šå‘ç°è¿™é‡Œè¿˜æ˜¯æœ‰ä¸€äº›<strong>â€œç‘•ç–µâ€</strong>ï¼Œä¹Ÿå°±æ˜¯ç¦»æˆ‘ä»¬æœŸæœ›çš„â€œè·Ÿè¸ªå‡½æ•°è°ƒç”¨é“¾â€çš„å®ç°è¿˜æœ‰ä¸€äº›ä¸è¶³ä¹‹å¤„ã€‚è¿™é‡Œæˆ‘åˆ—ä¸¾äº†å‡ ç‚¹ï¼š</p><ul>\n<li>è°ƒç”¨Traceæ—¶éœ€æ‰‹åŠ¨æ˜¾å¼ä¼ å…¥è¦è·Ÿè¸ªçš„å‡½æ•°åï¼›</li>\n<li>å¦‚æœæ˜¯å¹¶å‘åº”ç”¨ï¼Œä¸åŒGoroutineä¸­å‡½æ•°é“¾è·Ÿè¸ªæ··åœ¨ä¸€èµ·æ— æ³•åˆ†è¾¨ï¼›</li>\n<li>è¾“å‡ºçš„è·Ÿè¸ªç»“æœç¼ºå°‘å±‚æ¬¡æ„Ÿï¼Œè°ƒç”¨å…³ç³»ä¸æ˜“è¯†åˆ«ï¼›</li>\n<li>å¯¹è¦è·Ÿè¸ªçš„å‡½æ•°ï¼Œéœ€æ‰‹åŠ¨è°ƒç”¨Traceå‡½æ•°ã€‚</li>\n</ul><p>é‚£ä¹ˆï¼Œè¿™ä¸€è®²æˆ‘ä»¬çš„ä»»åŠ¡å°±æ˜¯é€ä¸€åˆ†æå¹¶è§£å†³ä¸Šé¢æå‡ºçš„è¿™å‡ ç‚¹é—®é¢˜è¿›è¡Œï¼Œç»è¿‡é€æ­¥åœ°ä»£ç æ¼”è¿›ï¼Œæœ€ç»ˆ<strong>å®ç°ä¸€ä¸ªè‡ªåŠ¨æ³¨å…¥è·Ÿè¸ªä»£ç ï¼Œå¹¶è¾“å‡ºæœ‰å±‚æ¬¡æ„Ÿçš„å‡½æ•°è°ƒç”¨é“¾è·Ÿè¸ªå‘½ä»¤è¡Œå·¥å…·</strong>ã€‚</p><p>å¥½ï¼Œä¸‹é¢æˆ‘ä»¬å…ˆæ¥è§£å†³ç¬¬ä¸€ä¸ªé—®é¢˜ã€‚</p><h2>è‡ªåŠ¨è·å–æ‰€è·Ÿè¸ªå‡½æ•°çš„å‡½æ•°å</h2><p>è¦è§£å†³â€œè°ƒç”¨Traceæ—¶éœ€è¦æ‰‹åŠ¨æ˜¾å¼ä¼ å…¥è¦è·Ÿè¸ªçš„å‡½æ•°åâ€çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯è¦è®©æˆ‘ä»¬çš„Traceå‡½æ•°èƒ½å¤Ÿè‡ªåŠ¨è·å–åˆ°å®ƒè·Ÿè¸ªå‡½æ•°çš„å‡½æ•°åä¿¡æ¯ã€‚æˆ‘ä»¬ä»¥è·Ÿè¸ªfooä¸ºä¾‹ï¼Œçœ‹çœ‹è¿™æ ·åšèƒ½ç»™æˆ‘ä»¬å¸¦æ¥ä»€ä¹ˆå¥½å¤„ã€‚</p><p>åœ¨æ‰‹åŠ¨æ˜¾å¼ä¼ å…¥çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ç”¨ä¸‹é¢è¿™ä¸ªä»£ç å¯¹fooè¿›è¡Œè·Ÿè¸ªï¼š</p><pre><code class=\"language-plain\">defer Trace(\"foo\")()\n</code></pre><p>ä¸€æ—¦å®ç°äº†è‡ªåŠ¨è·å–å‡½æ•°åï¼Œæ‰€æœ‰æ”¯æŒå‡½æ•°è°ƒç”¨é“¾è·Ÿè¸ªçš„å‡½æ•°éƒ½åªéœ€ä½¿ç”¨ä¸‹é¢è°ƒç”¨å½¢å¼çš„Traceå‡½æ•°å°±å¯ä»¥äº†ï¼š</p><pre><code class=\"language-plain\">defer Trace()()\n</code></pre><p>è¿™ç§ä¸€è‡´çš„Traceå‡½æ•°è°ƒç”¨æ–¹å¼ä¹Ÿä¸ºåç»­çš„è‡ªåŠ¨å‘ä»£ç ä¸­æ³¨å…¥Traceå‡½æ•°å¥ å®šäº†åŸºç¡€ã€‚é‚£ä¹ˆå¦‚ä½•å®ç°Traceå‡½æ•°å¯¹å®ƒè·Ÿè¸ªå‡½æ•°åçš„è‡ªåŠ¨è·å–å‘¢ï¼Ÿæˆ‘ä»¬éœ€è¦å€ŸåŠ©Goæ ‡å‡†åº“runtimeåŒ…çš„å¸®åŠ©ã€‚</p><p>è¿™é‡Œï¼Œæˆ‘ç»™å‡ºäº†æ–°ç‰ˆTraceå‡½æ•°çš„å®ç°ä»¥åŠå®ƒçš„ä½¿ç”¨æ–¹æ³•ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ï¼š</p><pre><code class=\"language-plain\">// trace1/trace.go\n\nfunc Trace() func() {\n    pc, _, _, ok := runtime.Caller(1)\n    if !ok {\n        panic(\"not found caller\")\n    }\n\n    fn := runtime.FuncForPC(pc)\n    name := fn.Name()\n\n    println(\"enter:\", name)\n    return func() { println(\"exit:\", name) }\n}\n\nfunc foo() {\n    defer Trace()()\n    bar()\n}\n\nfunc bar() {\n    defer Trace()()\n}\n\nfunc main() {\n    defer Trace()()\n    foo()\n}\n</code></pre><p>åœ¨è¿™ä¸€ç‰ˆTraceå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡runtime.Callerå‡½æ•°è·å¾—å½“å‰Goroutineçš„å‡½æ•°è°ƒç”¨æ ˆä¸Šçš„ä¿¡æ¯ï¼Œruntime.Callerçš„å‚æ•°æ ‡è¯†çš„æ˜¯è¦è·å–çš„æ˜¯å“ªä¸€ä¸ªæ ˆå¸§çš„ä¿¡æ¯ã€‚å½“å‚æ•°ä¸º0æ—¶ï¼Œè¿”å›çš„æ˜¯Callerå‡½æ•°çš„è°ƒç”¨è€…çš„å‡½æ•°ä¿¡æ¯ï¼Œåœ¨è¿™é‡Œå°±æ˜¯Traceå‡½æ•°ã€‚ä½†æˆ‘ä»¬éœ€è¦çš„æ˜¯Traceå‡½æ•°çš„è°ƒç”¨è€…çš„ä¿¡æ¯ï¼Œäºæ˜¯æˆ‘ä»¬ä¼ å…¥1ã€‚</p><p>Callerå‡½æ•°æœ‰å››ä¸ªè¿”å›å€¼ï¼šç¬¬ä¸€ä¸ªè¿”å›å€¼ä»£è¡¨çš„æ˜¯ç¨‹åºè®¡æ•°ï¼ˆpcï¼‰ï¼›ç¬¬äºŒä¸ªå’Œç¬¬ä¸‰ä¸ªå‚æ•°ä»£è¡¨å¯¹åº”å‡½æ•°æ‰€åœ¨çš„æºæ–‡ä»¶åä»¥åŠæ‰€åœ¨è¡Œæ•°ï¼Œè¿™é‡Œæˆ‘ä»¬æš‚æ—¶ä¸éœ€è¦ï¼›æœ€åä¸€ä¸ªå‚æ•°ä»£è¡¨æ˜¯å¦èƒ½æˆåŠŸè·å–è¿™äº›ä¿¡æ¯ï¼Œå¦‚æœè·å–å¤±è´¥ï¼Œæˆ‘ä»¬æŠ›å‡ºpanicã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é€šè¿‡runtime.FuncForPCå‡½æ•°å’Œç¨‹åºè®¡æ•°å™¨ï¼ˆPCï¼‰å¾—åˆ°è¢«è·Ÿè¸ªå‡½æ•°çš„å‡½æ•°åç§°ã€‚æˆ‘ä»¬è¿è¡Œä¸€ä¸‹æ”¹é€ åä»£ç ï¼š</p><pre><code class=\"language-plain\">enter: main.main\nenter: main.foo\nenter: main.bar\nexit: main.bar\nexit: main.foo\nexit: main.main\n</code></pre><p>æˆ‘ä»¬çœ‹åˆ°ï¼Œruntime.FuncForPCè¿”å›çš„åç§°ä¸­ä¸ä»…ä»…åŒ…å«å‡½æ•°åï¼Œè¿˜åŒ…å«äº†è¢«è·Ÿè¸ªå‡½æ•°æ‰€åœ¨çš„åŒ…åã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬ç¬¬ä¸€ä¸ªé—®é¢˜å·²ç»åœ†æ»¡è§£å†³äº†ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥è§£å†³ç¬¬äºŒä¸ªé—®é¢˜ï¼Œä¹Ÿå°±æ˜¯å½“ç¨‹åºä¸­æœ‰å¤šGoroutineæ—¶ï¼ŒTraceè¾“å‡ºçš„è·Ÿè¸ªä¿¡æ¯æ··æ‚åœ¨ä¸€èµ·éš¾ä»¥åˆ†è¾¨çš„é—®é¢˜ã€‚</p><h2>å¢åŠ Goroutineæ ‡è¯†</h2><p>ä¸Šé¢çš„Traceå‡½æ•°åœ¨é¢å¯¹åªæœ‰ä¸€ä¸ªGoroutineçš„æ—¶å€™ï¼Œè¿˜æ˜¯å¯ä»¥æ”¯æ’‘çš„ï¼Œä½†å½“ç¨‹åºä¸­å¹¶å‘è¿è¡Œå¤šä¸ªGoroutineçš„æ—¶å€™ï¼Œå¤šä¸ªå‡½æ•°è°ƒç”¨é“¾çš„å‡ºå…¥å£ä¿¡æ¯è¾“å‡ºå°±ä¼šæ··æ‚åœ¨ä¸€èµ·ï¼Œæ— æ³•åˆ†è¾¨ã€‚</p><p>é‚£ä¹ˆï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¿˜ç»§ç»­å¯¹Traceå‡½æ•°è¿›è¡Œæ”¹é€ ï¼Œè®©å®ƒæ”¯æŒå¤šGoroutineå‡½æ•°è°ƒç”¨é“¾çš„è·Ÿè¸ªã€‚æˆ‘ä»¬çš„æ–¹æ¡ˆå°±æ˜¯<strong>åœ¨è¾“å‡ºçš„å‡½æ•°å‡ºå…¥å£ä¿¡æ¯æ—¶ï¼Œå¸¦ä¸Šä¸€ä¸ªåœ¨ç¨‹åºæ¯æ¬¡æ‰§è¡Œæ—¶èƒ½å”¯ä¸€åŒºåˆ†Goroutineçš„Goroutine ID</strong>ã€‚</p><p>åˆ°è¿™é‡Œï¼Œä½ å¯èƒ½ä¼šè¯´ï¼ŒGoroutineä¹Ÿæ²¡æœ‰IDä¿¡æ¯å•Šï¼çš„ç¡®å¦‚æ­¤ï¼ŒGoæ ¸å¿ƒå›¢é˜Ÿä¸ºäº†é¿å…<a href=\"https://groups.google.com/g/golang-nuts/c/0HGyCOrhuuI/m/BjkXjGkMJrgJ\">Goroutine IDçš„æ»¥ç”¨</a>ï¼Œæ•…æ„æ²¡æœ‰å°†Goroutine IDæš´éœ²ç»™å¼€å‘è€…ã€‚ä½†åœ¨Goæ ‡å‡†åº“çš„h2_bundle.goä¸­ï¼Œæˆ‘ä»¬å´å‘ç°äº†ä¸€ä¸ªè·å–Goroutine IDçš„æ ‡å‡†æ–¹æ³•ï¼Œçœ‹ä¸‹é¢ä»£ç ï¼š</p><pre><code class=\"language-plain\">// $GOROOT/src/net/http/h2_bundle.go\nvar http2goroutineSpace = []byte(\"goroutine \")\n\nfunc http2curGoroutineID() uint64 {\n    bp := http2littleBuf.Get().(*[]byte)\n    defer http2littleBuf.Put(bp)\n    b := *bp\n    b = b[:runtime.Stack(b, false)]\n    // Parse the 4707 out of \"goroutine 4707 [\"\n    b = bytes.TrimPrefix(b, http2goroutineSpace)\n    i := bytes.IndexByte(b, ' ')\n    if i &lt; 0 {\n        panic(fmt.Sprintf(\"No space found in %q\", b))\n    }\n    b = b[:i]\n    n, err := http2parseUintBytes(b, 10, 64)\n    if err != nil {\n        panic(fmt.Sprintf(\"Failed to parse goroutine ID out of %q: %v\", b, err))\n    }\n    return n\n}\n</code></pre><p>ä¸è¿‡ï¼Œç”±äºhttp2curGoroutineIDä¸æ˜¯ä¸€ä¸ªå¯¼å‡ºå‡½æ•°ï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥ä½¿ç”¨ã€‚æˆ‘ä»¬å¯ä»¥æŠŠå®ƒå¤åˆ¶å‡ºæ¥æ”¹é€ ä¸€ä¸‹ï¼š</p><pre><code class=\"language-plain\">// trace2/trace.go\nvar goroutineSpace = []byte(\"goroutine \")\n\nfunc curGoroutineID() uint64 {\n    b := make([]byte, 64)\n    b = b[:runtime.Stack(b, false)]\n    // Parse the 4707 out of \"goroutine 4707 [\"\n    b = bytes.TrimPrefix(b, goroutineSpace)\n    i := bytes.IndexByte(b, ' ')\n    if i &lt; 0 {\n        panic(fmt.Sprintf(\"No space found in %q\", b))\n    }\n    b = b[:i]\n    n, err := strconv.ParseUint(string(b), 10, 64)\n    if err != nil {\n        panic(fmt.Sprintf(\"Failed to parse goroutine ID out of %q: %v\", b, err))\n    }\n    return n\n}\n</code></pre><p>è¿™é‡Œï¼Œæˆ‘ä»¬æ”¹é€ äº†ä¸¤ä¸ªåœ°æ–¹ã€‚ä¸€ä¸ªåœ°æ–¹æ˜¯é€šè¿‡ç›´æ¥åˆ›å»ºä¸€ä¸ªbyteåˆ‡ç‰‡èµ‹å€¼ç»™bï¼Œæ›¿ä»£åŸhttp2curGoroutineIDå‡½æ•°ä¸­ä»ä¸€ä¸ªpoolæ± è·å–byteåˆ‡ç‰‡çš„æ–¹å¼ï¼Œå¦å¤–ä¸€ä¸ªæ˜¯ä½¿ç”¨strconv.ParseUintæ›¿ä»£äº†åŸå…ˆçš„http2parseUintBytesã€‚æ”¹é€ åï¼Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥ä½¿ç”¨curGoroutineIDå‡½æ•°æ¥è·å–Goroutineçš„IDä¿¡æ¯äº†ã€‚</p><p>å¥½ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åœ¨Traceå‡½æ•°ä¸­æ·»åŠ Goroutine IDä¿¡æ¯çš„è¾“å‡ºï¼š</p><pre><code class=\"language-plain\">// trace2/trace.go\nfunc Trace() func() {\n    pc, _, _, ok := runtime.Caller(1)\n    if !ok {\n        panic(\"not found caller\")\n    }\n\n    fn := runtime.FuncForPC(pc)\n    name := fn.Name()\n\n    gid := curGoroutineID()\n    fmt.Printf(\"g[%05d]: enter: [%s]\\n\", gid, name)\n    return func() { fmt.Printf(\"g[%05d]: exit: [%s]\\n\", gid, name) }\n}\n</code></pre><p>ä»ä¸Šé¢ä»£ç çœ‹åˆ°ï¼Œæˆ‘ä»¬åœ¨å‡ºå…¥å£è¾“å‡ºçš„è·Ÿè¸ªä¿¡æ¯ä¸­åŠ å…¥äº†Goroutine IDä¿¡æ¯ï¼Œæˆ‘ä»¬è¾“å‡ºçš„Goroutine IDä¸º5ä½æ•°å­—ï¼Œå¦‚æœIDå€¼ä¸è¶³5ä½ï¼Œåˆ™å·¦è¡¥é›¶ï¼Œè¿™ä¸€åˆ‡éƒ½æ˜¯Printfå‡½æ•°çš„æ ¼å¼æ§åˆ¶å­—ç¬¦ä¸²â€œ%05dâ€å¸®åŠ©æˆ‘ä»¬å®ç°çš„ã€‚è¿™æ ·å¯¹é½Goroutine IDçš„ä½æ•°ï¼Œä¸ºçš„æ˜¯è¾“å‡ºä¿¡æ¯æ ¼å¼çš„ä¸€è‡´æ€§æ›´å¥½ã€‚å¦‚æœä½ çš„Goç¨‹åºä¸­Goroutineçš„æ•°é‡è¶…è¿‡äº†5ä½æ•°å¯ä»¥è¡¨ç¤ºçš„æ•°å€¼èŒƒå›´ï¼Œä¹Ÿå¯ä»¥è‡ªè¡Œè°ƒæ•´æ§åˆ¶å­—ç¬¦ä¸²ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¹Ÿè¦å¯¹ç¤ºä¾‹è¿›è¡Œä¸€äº›è°ƒæ•´ï¼Œå°†è¿™ä¸ªç¨‹åºç”±å•Goroutineæ”¹ä¸ºå¤šGoroutineå¹¶å‘çš„ï¼Œè¿™æ ·æ‰èƒ½éªŒè¯æ”¯æŒå¤šGoroutineçš„æ–°ç‰ˆTraceå‡½æ•°æ˜¯å¦å¥½ç”¨ï¼š</p><pre><code class=\"language-plain\">// trace2/trace.go\nfunc A1() {\n    defer Trace()()\n    B1()\n}\n\nfunc B1() {\n    defer Trace()()\n    C1()\n}\n\nfunc C1() {\n    defer Trace()()\n    D()\n}\n\nfunc D() {\n    defer Trace()()\n}\n\nfunc A2() {\n    defer Trace()()\n    B2()\n}\nfunc B2() {\n    defer Trace()()\n    C2()\n}\nfunc C2() {\n    defer Trace()()\n    D()\n}\n\nfunc main() {\n    var wg sync.WaitGroup\n    wg.Add(1)\n    go func() {\n        A2()\n        wg.Done()\n    }()\n\n    A1()\n    wg.Wait()\n}\n</code></pre><p>æ–°ç¤ºä¾‹ç¨‹åºå…±æœ‰ä¸¤ä¸ªGoroutineï¼Œmain groutineçš„è°ƒç”¨é“¾ä¸º<code>A1 -&gt; B1 -&gt; C1 -&gt; D</code>ï¼Œè€Œå¦å¤–ä¸€ä¸ªGoroutineçš„å‡½æ•°è°ƒç”¨é“¾ä¸º<code>A2 -&gt; B2 -&gt; C2 -&gt; D</code>ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªç¨‹åºçš„æ‰§è¡Œç»“æœæ˜¯å¦å’ŒåŸä»£ç ä¸­ä¸¤ä¸ªGoroutineçš„è°ƒç”¨é“¾ä¸€è‡´ï¼š</p><pre><code class=\"language-plain\">g[00001]: enter: [main.A1]\ng[00001]: enter: [main.B1]\ng[00018]: enter: [main.A2]\ng[00001]: enter: [main.C1]\ng[00001]: enter: [main.D]\ng[00001]: exit: [main.D]\ng[00001]: exit: [main.C1]\ng[00001]: exit: [main.B1]\ng[00001]: exit: [main.A1]\ng[00018]: enter: [main.B2]\ng[00018]: enter: [main.C2]\ng[00018]: enter: [main.D]\ng[00018]: exit: [main.D]\ng[00018]: exit: [main.C2]\ng[00018]: exit: [main.B2]\ng[00018]: exit: [main.A2]\n</code></pre><p>æˆ‘ä»¬çœ‹åˆ°ï¼Œæ–°ç¤ºä¾‹ç¨‹åºè¾“å‡ºäº†å¸¦æœ‰Goroutine IDçš„å‡ºå…¥å£è·Ÿè¸ªä¿¡æ¯ï¼Œé€šè¿‡Goroutine IDæˆ‘ä»¬å¯ä»¥å¿«é€Ÿç¡®è®¤æŸä¸€è¡Œè¾“å‡ºæ˜¯å±äºå“ªä¸ªGoroutineçš„ã€‚</p><p>ä½†ç”±äºGoè¿è¡Œæ—¶å¯¹Goroutineè°ƒåº¦é¡ºåºçš„ä¸ç¡®å®šæ€§ï¼Œå„ä¸ªGoroutineçš„è¾“å‡ºè¿˜æ˜¯ä¼šå­˜åœ¨äº¤ç»‡åœ¨ä¸€èµ·çš„é—®é¢˜ï¼Œè¿™ä¼šç»™ä½ æŸ¥çœ‹æŸä¸ªGoroutineçš„å‡½æ•°è°ƒç”¨é“¾è·Ÿè¸ªä¿¡æ¯å¸¦æ¥é˜»ç¢ã€‚è¿™é‡Œæˆ‘æä¾›ä¸€ä¸ª<strong>å°æŠ€å·§</strong>ï¼šä½ å¯ä»¥å°†ç¨‹åºçš„è¾“å‡ºé‡å®šå‘åˆ°ä¸€ä¸ªæœ¬åœ°æ–‡ä»¶ä¸­ï¼Œç„¶åé€šè¿‡Goroutine IDè¿‡æ»¤å‡ºï¼ˆå¯ä½¿ç”¨grepå·¥å…·ï¼‰ä½ æƒ³æŸ¥çœ‹çš„groutineçš„å…¨éƒ¨å‡½æ•°è·Ÿè¸ªä¿¡æ¯ã€‚</p><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±å®ç°äº†è¾“å‡ºå¸¦æœ‰Goroutine IDçš„å‡½æ•°è·Ÿè¸ªä¿¡æ¯ï¼Œä¸è¿‡ï¼Œä½ æ˜¯ä¸æ˜¯ä¹Ÿè§‰å¾—è¾“å‡ºçš„å‡½æ•°è°ƒç”¨é“¾ä¿¡æ¯è¿˜æ˜¯ä¸å¤Ÿç¾è§‚ï¼Œç¼ºå°‘å±‚æ¬¡æ„Ÿï¼Œä½“éªŒä¾æ—§ä¸é‚£ä¹ˆä¼˜ç§€å‘¢ï¼Ÿè‡³å°‘æˆ‘æ˜¯è¿™ä¹ˆè§‰å¾—çš„ã€‚æ‰€ä»¥ä¸‹é¢æˆ‘ä»¬å°±æ¥ç¾åŒ–ä¸€ä¸‹ä¿¡æ¯çš„è¾“å‡ºå½¢å¼ã€‚</p><h2>è®©è¾“å‡ºçš„è·Ÿè¸ªä¿¡æ¯æ›´å…·å±‚æ¬¡æ„Ÿ</h2><p>å¯¹äºç¨‹åºå‘˜æ¥è¯´ï¼Œç¼©è¿›æ˜¯æœ€èƒ½ä½“ç°å‡ºâ€œå±‚æ¬¡æ„Ÿâ€çš„æ–¹æ³•ï¼Œå¦‚æœæˆ‘ä»¬å°†ä¸Šé¢ç¤ºä¾‹ä¸­Goroutine 00001çš„å‡½æ•°è°ƒç”¨è·Ÿè¸ªä¿¡æ¯ä»¥ä¸‹é¢çš„å½¢å¼å±•ç¤ºå‡ºæ¥ï¼Œå‡½æ•°çš„è°ƒç”¨é¡ºåºæ˜¯ä¸æ˜¯æ›´åŠ ä¸€ç›®äº†ç„¶äº†å‘¢ï¼Ÿ</p><pre><code class=\"language-plain\">g[00001]:    -&gt;main.A1\ng[00001]:        -&gt;main.B1\ng[00001]:            -&gt;main.C1\ng[00001]:                -&gt;main.D\ng[00001]:                &lt;-main.D\ng[00001]:            &lt;-main.C1\ng[00001]:        &lt;-main.B1\ng[00001]:    &lt;-main.A1\n</code></pre><p>é‚£ä¹ˆæˆ‘ä»¬å°±ä»¥è¿™ä¸ªå½¢å¼ä¸ºç›®æ ‡ï¼Œè€ƒè™‘å¦‚ä½•å®ç°è¾“å‡ºè¿™ç§å¸¦ç¼©è¿›çš„å‡½æ•°è°ƒç”¨è·Ÿè¸ªä¿¡æ¯ã€‚æˆ‘ä»¬è¿˜æ˜¯ç›´æ¥ä¸Šä»£ç å§ï¼š</p><pre><code class=\"language-plain\">// trace3/trace.go\n\nfunc printTrace(id uint64, name, arrow string, indent int) {\n    indents := \"\"\n    for i := 0; i &lt; indent; i++ {\n        indents += \"    \"\n    }\n    fmt.Printf(\"g[%05d]:%s%s%s\\n\", id, indents, arrow, name)\n}\n\nvar mu sync.Mutex\nvar m = make(map[uint64]int)\n\nfunc Trace() func() {\n    pc, _, _, ok := runtime.Caller(1)\n    if !ok {\n        panic(\"not found caller\")\n    }\n\n    fn := runtime.FuncForPC(pc)\n    name := fn.Name()\n    gid := curGoroutineID()\n\n    mu.Lock()\n    indents := m[gid]    // è·å–å½“å‰gidå¯¹åº”çš„ç¼©è¿›å±‚æ¬¡\n    m[gid] = indents + 1 // ç¼©è¿›å±‚æ¬¡+1åå­˜å…¥map\n    mu.Unlock()\n    printTrace(gid, name, \"-&gt;\", indents+1)\n    return func() {\n        mu.Lock()\n        indents := m[gid]    // è·å–å½“å‰gidå¯¹åº”çš„ç¼©è¿›å±‚æ¬¡\n        m[gid] = indents - 1 // ç¼©è¿›å±‚æ¬¡-1åå­˜å…¥map\n        mu.Unlock()\n        printTrace(gid, name, \"&lt;-\", indents)\n    }\n}\n</code></pre><p>åœ¨ä¸Šé¢è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªmapç±»å‹å˜é‡mæ¥ä¿å­˜æ¯ä¸ªGoroutineå½“å‰çš„ç¼©è¿›ä¿¡æ¯ï¼šmçš„keyä¸ºGoroutineçš„IDï¼Œå€¼ä¸ºç¼©è¿›çš„å±‚æ¬¡ã€‚ç„¶åï¼Œè€ƒè™‘åˆ°Traceå‡½æ•°å¯èƒ½åœ¨å¹¶å‘ç¯å¢ƒä¸­è¿è¡Œï¼Œæ ¹æ®æˆ‘ä»¬åœ¨<a href=\"https://time.geekbang.org/column/article/446032\">ç¬¬16è®²</a>ä¸­æåˆ°çš„â€œmapä¸æ”¯æŒå¹¶å‘å†™â€çš„æ³¨æ„äº‹é¡¹ï¼Œæˆ‘ä»¬å¢åŠ äº†ä¸€ä¸ªsync.Mutexå®ä¾‹muç”¨äºåŒæ­¥å¯¹mçš„å†™æ“ä½œã€‚</p><p>è¿™æ ·ï¼Œå¯¹äºä¸€ä¸ªGoroutineæ¥è¯´ï¼Œæ¯æ¬¡åˆšè¿›å…¥ä¸€ä¸ªå‡½æ•°è°ƒç”¨ï¼Œæˆ‘ä»¬å°±åœ¨è¾“å‡ºå…¥å£è·Ÿè¸ªä¿¡æ¯ä¹‹å‰ï¼Œå°†ç¼©è¿›å±‚æ¬¡åŠ ä¸€ï¼Œå¹¶è¾“å‡ºå…¥å£è·Ÿè¸ªä¿¡æ¯ï¼ŒåŠ ä¸€åçš„ç¼©è¿›å±‚æ¬¡å€¼ä¹Ÿä¿å­˜åˆ°mapä¸­ã€‚ç„¶åï¼Œåœ¨å‡½æ•°é€€å‡ºå‰ï¼Œæˆ‘ä»¬å–å‡ºå½“å‰ç¼©è¿›å±‚æ¬¡å€¼å¹¶è¾“å‡ºå‡ºå£è·Ÿè¸ªä¿¡æ¯ï¼Œä¹‹åå†å°†ç¼©è¿›å±‚æ¬¡å‡ä¸€åä¿å­˜åˆ°mapä¸­ã€‚</p><p>é™¤äº†å¢åŠ ç¼©è¿›å±‚æ¬¡ä¿¡æ¯å¤–ï¼Œåœ¨è¿™ä¸€ç‰ˆçš„Traceå‡½æ•°å®ç°ä¸­ï¼Œæˆ‘ä»¬ä¹ŸæŠŠè¾“å‡ºå‡ºå…¥å£è·Ÿè¸ªä¿¡æ¯çš„æ“ä½œæå–åˆ°äº†ä¸€ä¸ªç‹¬ç«‹çš„å‡½æ•°printTraceä¸­ï¼Œè¿™ä¸ªå‡½æ•°ä¼šæ ¹æ®ä¼ å…¥çš„Goroutine IDã€å‡½æ•°åã€ç®­å¤´ç±»å‹ä¸ç¼©è¿›å±‚æ¬¡å€¼ï¼ŒæŒ‰é¢„å®šçš„æ ¼å¼æ‹¼æ¥è·Ÿè¸ªä¿¡æ¯å¹¶è¾“å‡ºã€‚</p><p>è¿è¡Œæ–°ç‰ˆç¤ºä¾‹ä»£ç ï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°ä¸‹é¢çš„ç»“æœï¼š</p><pre><code class=\"language-plain\">g[00001]:    -&gt;main.A1\ng[00001]:        -&gt;main.B1\ng[00001]:            -&gt;main.C1\ng[00001]:                -&gt;main.D\ng[00001]:                &lt;-main.D\ng[00001]:            &lt;-main.C1\ng[00001]:        &lt;-main.B1\ng[00001]:    &lt;-main.A1\ng[00018]:    -&gt;main.A2\ng[00018]:        -&gt;main.B2\ng[00018]:            -&gt;main.C2\ng[00018]:                -&gt;main.D\ng[00018]:                &lt;-main.D\ng[00018]:            &lt;-main.C2\ng[00018]:        &lt;-main.B2\ng[00018]:    &lt;-main.A2\n</code></pre><p>æ˜¾ç„¶ï¼Œé€šè¿‡è¿™ç§å¸¦æœ‰ç¼©è¿›å±‚æ¬¡çš„å‡½æ•°è°ƒç”¨è·Ÿè¸ªä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥æ›´å®¹æ˜“åœ°è¯†åˆ«æŸä¸ªGoroutineçš„å‡½æ•°è°ƒç”¨å…³ç³»ã€‚</p><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬çš„å‡½æ•°è°ƒç”¨é“¾è·Ÿè¸ªå·²ç»æ”¯æŒäº†å¤šGoroutineï¼Œå¹¶ä¸”å¯ä»¥è¾“å‡ºæœ‰å±‚æ¬¡æ„Ÿçš„è·Ÿè¸ªä¿¡æ¯äº†ï¼Œä½†å¯¹äºTraceç‰¹æ€§çš„ä½¿ç”¨è€…è€Œè¨€ï¼Œä»–ä»¬ä¾ç„¶éœ€è¦æ‰‹å·¥åœ¨è‡ªå·±çš„å‡½æ•°ä¸­æ·»åŠ å¯¹Traceå‡½æ•°çš„è°ƒç”¨ã€‚é‚£ä¹ˆæˆ‘ä»¬æ˜¯å¦å¯ä»¥å°†Traceç‰¹æ€§è‡ªåŠ¨æ³¨å…¥ç‰¹å®šé¡¹ç›®ä¸‹çš„å„ä¸ªæºç æ–‡ä»¶ä¸­å‘¢ï¼Ÿæ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­æ¥æ”¹è¿›æˆ‘ä»¬çš„Traceå·¥å…·ã€‚</p><h2>åˆ©ç”¨ä»£ç ç”Ÿæˆè‡ªåŠ¨æ³¨å…¥Traceå‡½æ•°</h2><p>è¦å®ç°å‘ç›®æ ‡ä»£ç ä¸­çš„å‡½æ•°/æ–¹æ³•è‡ªåŠ¨æ³¨å…¥Traceå‡½æ•°ï¼Œæˆ‘ä»¬é¦–å…ˆè¦åšçš„å°±æ˜¯å°†ä¸Šé¢Traceå‡½æ•°ç›¸å…³çš„ä»£ç æ‰“åŒ…åˆ°ä¸€ä¸ªmoduleä¸­ä»¥æ–¹ä¾¿å…¶ä»–moduleå¯¼å…¥ã€‚ä¸‹é¢æˆ‘ä»¬å°±å…ˆæ¥çœ‹çœ‹å°†Traceå‡½æ•°æ”¾å…¥ä¸€ä¸ªç‹¬ç«‹çš„moduleä¸­çš„æ­¥éª¤ã€‚</p><h3>å°†Traceå‡½æ•°æ”¾å…¥ä¸€ä¸ªç‹¬ç«‹çš„moduleä¸­</h3><p>æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåä¸ºinstrument_traceçš„ç›®å½•ï¼Œè¿›å…¥è¿™ä¸ªç›®å½•åï¼Œé€šè¿‡go mod initå‘½ä»¤åˆ›å»ºä¸€ä¸ªåä¸ºgithub.com/bigwhite/instrument_traceçš„moduleï¼š</p><pre><code class=\"language-plain\">$mkdir instrument_trace\n$cd instrument_trace\n$go mod init github.com/bigwhite/instrument_trace\ngo: creating new go.mod: module github.com/bigwhite/instrument_trace\n</code></pre><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æœ€æ–°ç‰ˆçš„trace.goæ”¾å…¥åˆ°è¯¥ç›®å½•ä¸‹ï¼Œå°†åŒ…åæ”¹ä¸ºtraceï¼Œå¹¶ä»…ä¿ç•™Traceå‡½æ•°ã€Traceä½¿ç”¨çš„å‡½æ•°ä»¥åŠåŒ…çº§å˜é‡ï¼Œå…¶ä»–å‡½æ•°ä¸€å¾‹åˆ é™¤æ‰ã€‚è¿™æ ·ï¼Œä¸€ä¸ªç‹¬ç«‹çš„traceåŒ…å°±æå–å®Œæ¯•äº†ã€‚</p><p><strong>ä½œä¸ºtraceåŒ…çš„ä½œè€…ï¼Œæˆ‘ä»¬æœ‰ä¹‰åŠ¡å‘Šè¯‰å¤§å®¶å¦‚ä½•ä½¿ç”¨traceåŒ…ã€‚</strong>åœ¨Goä¸­ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šç”¨ä¸€ä¸ªexample_test.goæ–‡ä»¶æ¥ç¼–å†™ä½¿ç”¨traceåŒ…çš„æ¼”ç¤ºä»£ç ï¼Œä¸‹é¢å°±æ˜¯æˆ‘ä»¬ä¸ºtraceåŒ…æä¾›çš„example_test.goæ–‡ä»¶ï¼š</p><pre><code class=\"language-plain\">// instrument_trace/example_test.go\npackage trace_test\n  \nimport (\n    trace \"github.com/bigwhite/instrument_trace\"\n)\n\nfunc a() {\n    defer trace.Trace()()\n    b()\n}\n\nfunc b() {\n    defer trace.Trace()()\n    c()\n}\n\nfunc c() {\n    defer trace.Trace()()\n    d()\n}\n\nfunc d() {\n    defer trace.Trace()()\n}\n\nfunc ExampleTrace() {\n    a()\n    // Output:\n    // g[00001]:    -&gt;github.com/bigwhite/instrument_trace_test.a\n    // g[00001]:        -&gt;github.com/bigwhite/instrument_trace_test.b\n    // g[00001]:            -&gt;github.com/bigwhite/instrument_trace_test.c\n    // g[00001]:                -&gt;github.com/bigwhite/instrument_trace_test.d\n    // g[00001]:                &lt;-github.com/bigwhite/instrument_trace_test.d\n    // g[00001]:            &lt;-github.com/bigwhite/instrument_trace_test.c\n    // g[00001]:        &lt;-github.com/bigwhite/instrument_trace_test.b\n    // g[00001]:    &lt;-github.com/bigwhite/instrument_trace_test.a\n}\n</code></pre><p>åœ¨example_test.goæ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬ç”¨ExampleXXXå½¢å¼çš„å‡½æ•°è¡¨ç¤ºä¸€ä¸ªç¤ºä¾‹ï¼Œgo testå‘½ä»¤ä¼šæ‰«æexample_test.goä¸­çš„ä»¥Exampleä¸ºå‰ç¼€çš„å‡½æ•°å¹¶æ‰§è¡Œè¿™äº›å‡½æ•°ã€‚</p><p>æ¯ä¸ªExampleXXXå‡½æ•°éœ€è¦åŒ…å«é¢„æœŸçš„è¾“å‡ºï¼Œå°±åƒä¸Šé¢ExampleTraceå‡½æ•°å°¾éƒ¨é‚£æ ·ï¼Œæˆ‘ä»¬åœ¨ä¸€å¤§æ®µæ³¨é‡Šä¸­æä¾›è¿™ä¸ªå‡½æ•°æ‰§è¡Œåçš„é¢„æœŸè¾“å‡ºï¼Œé¢„æœŸè¾“å‡ºçš„å†…å®¹ä»<code>// Output:</code>çš„ä¸‹ä¸€è¡Œå¼€å§‹ã€‚go testä¼šå°†ExampleTraceçš„è¾“å‡ºä¸é¢„æœŸè¾“å‡ºå¯¹æ¯”ï¼Œå¦‚æœä¸ä¸€è‡´ï¼Œä¼šæŠ¥æµ‹è¯•é”™è¯¯ã€‚ä»è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºexample_test.goä¹Ÿæ˜¯traceåŒ…å•å…ƒæµ‹è¯•çš„ä¸€éƒ¨åˆ†ã€‚</p><p>ç°åœ¨Traceå‡½æ•°å·²ç»è¢«æ”¾å…¥åˆ°ç‹¬ç«‹çš„åŒ…ä¸­äº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥çœ‹çœ‹å¦‚ä½•å°†å®ƒè‡ªåŠ¨æ³¨å…¥åˆ°è¦è·Ÿè¸ªçš„å‡½æ•°ä¸­å»ã€‚</p><h3>è‡ªåŠ¨æ³¨å…¥Traceå‡½æ•°</h3><p>ç°åœ¨ï¼Œæˆ‘ä»¬åœ¨instrument_trace moduleä¸‹é¢å¢åŠ ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œè¿™ä¸ªå·¥å…·å¯ä»¥ä»¥ä¸€ä¸ªGoæºæ–‡ä»¶ä¸ºå•ä½ï¼Œè‡ªåŠ¨å‘è¿™ä¸ªGoæºæ–‡ä»¶ä¸­çš„æ‰€æœ‰å‡½æ•°æ³¨å…¥Traceå‡½æ•°ã€‚</p><p>æˆ‘ä»¬å†æ ¹æ®<a href=\"https://time.geekbang.org/column/article/429143\">05è®²</a>ä¸­ä»‹ç»çš„å¸¦æœ‰å¯æ‰§è¡Œæ–‡ä»¶çš„Goé¡¹ç›®å¸ƒå±€ï¼Œåœ¨instrument_trace moduleä¸­å¢åŠ cmd/instrumentç›®å½•ï¼Œè¿™ä¸ªå·¥å…·çš„mainåŒ…å°±æ”¾åœ¨è¿™ä¸ªç›®å½•ä¸‹ï¼Œè€ŒçœŸæ­£å®ç°è‡ªåŠ¨æ³¨å…¥Traceå‡½æ•°çš„ä»£ç å‘¢ï¼Œè¢«æˆ‘ä»¬æ”¾åœ¨äº†instrumenterç›®å½•ä¸‹ã€‚</p><p>ä¸‹é¢æ˜¯å˜åŒ–åçš„instrument_trace moduleçš„ç›®å½•ç»“æ„ï¼š</p><pre><code class=\"language-plain\">$tree ./instrument_trace -F\n./instrument_trace\nâ”œâ”€â”€ Makefile\nâ”œâ”€â”€ cmd/\nâ”‚&nbsp;&nbsp; â””â”€â”€ instrument/\nâ”‚&nbsp;&nbsp;     â””â”€â”€ main.go  # instrumentå‘½ä»¤è¡Œå·¥å…·çš„mainåŒ…\nâ”œâ”€â”€ example_test.go\nâ”œâ”€â”€ go.mod\nâ”œâ”€â”€ go.sum\nâ”œâ”€â”€ instrumenter/    # è‡ªåŠ¨æ³¨å…¥é€»è¾‘çš„ç›¸å…³ç»“æ„\nâ”‚&nbsp;&nbsp; â”œâ”€â”€ ast/\nâ”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â””â”€â”€ ast.go\nâ”‚&nbsp;&nbsp; â””â”€â”€ instrumenter.go\nâ””â”€â”€ trace.go\n</code></pre><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹cmd/instrument/main.goæºç ï¼Œç„¶åè‡ªä¸Šè€Œä¸‹æ²¿ç€mainå‡½æ•°çš„è°ƒç”¨é€»è¾‘é€ä¸€çœ‹ä¸€ä¸‹è¿™ä¸ªåŠŸèƒ½çš„å®ç°ã€‚ä¸‹é¢æ˜¯main.goçš„æºç ï¼š</p><pre><code class=\"language-plain\">//  instrument_trace/cmd/instrument/main.go\n\n... ...\n\nvar (\n    wrote bool\n)\n\nfunc init() {\n    flag.BoolVar(&amp;wrote, \"w\", false, \"write result to (source) file instead of stdout\")\n}\n\nfunc usage() {\n    fmt.Println(\"instrument [-w] xxx.go\")\n    flag.PrintDefaults()\n}\n\nfunc main() {\n    fmt.Println(os.Args)\n    flag.Usage = usage\n    flag.Parse() // è§£æå‘½ä»¤è¡Œå‚æ•°\n\n    if len(os.Args) &lt; 2 { // å¯¹å‘½ä»¤è¡Œå‚æ•°ä¸ªæ•°è¿›è¡Œæ ¡éªŒ\n        usage()\n        return\n    }\n\n    var file string\n    if len(os.Args) == 3 {\n        file = os.Args[2]\n    }\n\n    if len(os.Args) == 2 {\n        file = os.Args[1]\n    }\n    if filepath.Ext(file) != \".go\" { // å¯¹æºæ–‡ä»¶æ‰©å±•åè¿›è¡Œæ ¡éªŒ\n        usage()\n        return\n    }\n\n    var ins instrumenter.Instrumenter // å£°æ˜instrumenter.Instrumenteræ¥å£ç±»å‹å˜é‡\n    \n    // åˆ›å»ºä»¥astæ–¹å¼å®ç°Instrumenteræ¥å£çš„ast.instrumenterå®ä¾‹\n    ins = ast.New(\"github.com/bigwhite/instrument_trace\", \"trace\", \"Trace\") \n    newSrc, err := ins.Instrument(file) // å‘Goæºæ–‡ä»¶æ‰€æœ‰å‡½æ•°æ³¨å…¥Traceå‡½æ•°\n    if err != nil {\n        panic(err)\n    }\n\n    if newSrc == nil {\n        // add nothing to the source file. no change\n        fmt.Printf(\"no trace added for %s\\n\", file)\n        return\n    }\n\n    if !wrote {\n        fmt.Println(string(newSrc))  // å°†ç”Ÿæˆçš„æ–°ä»£ç å†…å®¹è¾“å‡ºåˆ°stdoutä¸Š\n        return\n    }\n\n    // å°†ç”Ÿæˆçš„æ–°ä»£ç å†…å®¹å†™å›åŸGoæºæ–‡ä»¶\n    if err = ioutil.WriteFile(file, newSrc, 0666); err != nil {\n        fmt.Printf(\"write %s error: %v\\n\", file, err)\n        return\n    }\n    fmt.Printf(\"instrument trace for %s ok\\n\", file)\n}\n</code></pre><p>ä½œä¸ºå‘½ä»¤è¡Œå·¥å…·ï¼Œinstrumentä½¿ç”¨æ ‡å‡†åº“çš„flagåŒ…å®ç°å¯¹å‘½ä»¤è¡Œå‚æ•°ï¼ˆè¿™é‡Œæ˜¯-wï¼‰çš„è§£æï¼Œé€šè¿‡os.Argsè·å–å¾…æ³¨å…¥çš„Goæºæ–‡ä»¶è·¯å¾„ã€‚åœ¨å®Œæˆå¯¹å‘½ä»¤è¡Œå‚æ•°ä¸ªæ•°ä¸å€¼çš„æ ¡éªŒåï¼Œinstrumentç¨‹åºå£°æ˜äº†ä¸€ä¸ªinstrumenter.Instrumenteræ¥å£ç±»å‹å˜é‡insï¼Œç„¶ååˆ›å»ºäº†ä¸€ä¸ªå®ç°äº†Instrumenteræ¥å£ç±»å‹çš„ast.instrumenterç±»å‹çš„å®ä¾‹ï¼Œå¹¶èµ‹å€¼ç»™å˜é‡insã€‚</p><p>instrumenter.Instrumenteræ¥å£ç±»å‹çš„å£°æ˜æ”¾åœ¨äº†instrumenter/instrumenter.goä¸­ï¼š</p><pre><code class=\"language-plain\">type Instrumenter interface {\n    Instrument(string) ([]byte, error)\n}\n</code></pre><p>è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°ï¼Œè¿™ä¸ªæ¥å£ç±»å‹çš„æ–¹æ³•åˆ—è¡¨ä¸­åªæœ‰ä¸€ä¸ªæ–¹æ³•Instrumentï¼Œè¿™ä¸ªæ–¹æ³•æ¥å—ä¸€ä¸ªGoæºæ–‡ä»¶è·¯å¾„ï¼Œè¿”å›æ³¨å…¥äº†Traceå‡½æ•°çš„æ–°æºæ–‡ä»¶å†…å®¹ä»¥åŠä¸€ä¸ªerrorç±»å‹å€¼ï¼Œä½œä¸ºé”™è¯¯çŠ¶æ€æ ‡è¯†ã€‚æˆ‘ä»¬ä¹‹æ‰€ä»¥è¦æŠ½è±¡å‡ºä¸€ä¸ªæ¥å£ç±»å‹ï¼Œè€ƒè™‘çš„å°±æ˜¯æ³¨å…¥Traceå‡½æ•°çš„å®ç°æ–¹æ³•ä¸ä¸€ï¼Œä¸ºåç»­çš„æ‰©å±•åšå¥½é¢„ç•™ã€‚</p><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é»˜è®¤æä¾›äº†ä¸€ç§è‡ªåŠ¨æ³¨å…¥Traceå‡½æ•°çš„å®ç°ï¼Œé‚£å°±æ˜¯ast.instrumenterï¼Œå®ƒæ³¨å…¥Traceçš„å®ç°åŸç†æ˜¯è¿™æ ·çš„ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/5b/a8/5be0efb3920c39cd9f252af0b26e7ca8.jpg?wh=1980x1080\" alt=\"\"></p><p>ä»åŸç†å›¾ä¸­æˆ‘ä»¬å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°ï¼Œåœ¨è¿™ä¸€å®ç°æ–¹æ¡ˆä¸­ï¼Œæˆ‘ä»¬å…ˆå°†ä¼ å…¥çš„Goæºç è½¬æ¢ä¸º<strong>æŠ½è±¡è¯­æ³•æ ‘</strong>ã€‚</p><p>åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ï¼ŒæŠ½è±¡è¯­æ³•æ ‘ï¼ˆabstract syntax treeï¼ŒASTï¼‰æ˜¯æºä»£ç çš„æŠ½è±¡è¯­æ³•ç»“æ„çš„æ ‘çŠ¶è¡¨ç°å½¢å¼ï¼Œæ ‘ä¸Šçš„æ¯ä¸ªèŠ‚ç‚¹éƒ½è¡¨ç¤ºæºä»£ç ä¸­çš„ä¸€ç§ç»“æ„ã€‚å› ä¸ºGoè¯­è¨€æ˜¯å¼€æºç¼–ç¨‹è¯­è¨€ï¼Œæ‰€ä»¥å®ƒçš„æŠ½è±¡è¯­æ³•æ ‘çš„æ“ä½œåŒ…ä¹Ÿå’Œè¯­è¨€ä¸€èµ·å¼€æ”¾ç»™äº†Goå¼€å‘äººå‘˜ï¼Œæˆ‘ä»¬å¯ä»¥åŸºäºGoæ ‡å‡†åº“ä»¥åŠ<a href=\"https://golang.org/x/tools\">Goå®éªŒå·¥å…·åº“</a>æä¾›çš„astç›¸å…³åŒ…ï¼Œå¿«é€Ÿåœ°æ„å»ºåŸºäºASTçš„åº”ç”¨ï¼Œè¿™é‡Œçš„ast.instrumenterå°±æ˜¯ä¸€ä¸ªåº”ç”¨ASTçš„å…¸å‹ä¾‹å­ã€‚</p><p>ä¸€æ—¦æˆ‘ä»¬é€šè¿‡astç›¸å…³åŒ…è§£æGoæºç å¾—åˆ°ç›¸åº”çš„æŠ½è±¡è¯­æ³•æ ‘åï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥æ“ä½œè¿™æ£µè¯­æ³•æ ‘ï¼Œå¹¶æŒ‰æˆ‘ä»¬çš„é€»è¾‘åœ¨è¯­æ³•æ ‘ä¸­æ³¨å…¥æˆ‘ä»¬çš„Traceå‡½æ•°ï¼Œæœ€åæˆ‘ä»¬å†å°†ä¿®æ”¹åçš„æŠ½è±¡è¯­æ³•æ ‘è½¬æ¢ä¸ºGoæºç ï¼Œå°±å®Œæˆäº†æ•´ä¸ªè‡ªåŠ¨æ³¨å…¥çš„å·¥ä½œäº†ã€‚</p><p>äº†è§£äº†åŸç†åï¼Œæˆ‘ä»¬å†çœ‹ä¸€ä¸‹å…·ä½“çš„ä»£ç å®ç°ã€‚ä¸‹é¢æ˜¯ast.instrumenterçš„Instructmentæ–¹æ³•çš„ä»£ç ï¼š</p><pre><code class=\"language-plain\">// instrument_trace/instrumenter/ast/ast.go\n\nfunc (a instrumenter) Instrument(filename string) ([]byte, error) {\n    fset := token.NewFileSet()\n    curAST, err := parser.ParseFile(fset, filename, nil, parser.ParseComments) // è§£æGoæºç ï¼Œå¾—åˆ°AST\n    if err != nil {\n        return nil, fmt.Errorf(\"error parsing %s: %w\", filename, err)\n    }\n\n    if !hasFuncDecl(curAST) { // å¦‚æœæ•´ä¸ªæºç éƒ½ä¸åŒ…å«å‡½æ•°å£°æ˜ï¼Œåˆ™æ— éœ€æ³¨å…¥æ“ä½œï¼Œç›´æ¥è¿”å›ã€‚\n        return nil, nil\n    }\n\n    // åœ¨ASTä¸Šæ·»åŠ åŒ…å¯¼å…¥è¯­å¥\n    astutil.AddImport(fset, curAST, a.traceImport)\n\n    // å‘ASTä¸Šçš„æ‰€æœ‰å‡½æ•°æ³¨å…¥Traceå‡½æ•°\n    a.addDeferTraceIntoFuncDecls(curAST)\n\n    buf := &amp;bytes.Buffer{}\n    err = format.Node(buf, fset, curAST) // å°†ä¿®æ”¹åçš„ASTè½¬æ¢å›Goæºç \n    if err != nil {\n        return nil, fmt.Errorf(\"error formatting new code: %w\", err)\n    }\n    return buf.Bytes(), nil // è¿”å›è½¬æ¢åçš„Goæºç \n}\n</code></pre><p>é€šè¿‡ä»£ç ï¼Œæˆ‘ä»¬çœ‹åˆ°Instrumentæ–¹æ³•çš„åŸºæœ¬æ­¥éª¤ä¸ä¸Šé¢åŸç†å›¾å¤§åŒå°å¼‚ã€‚Instrumenté¦–å…ˆé€šè¿‡go/paserçš„ParserFileå‡½æ•°å¯¹ä¼ å…¥çš„Goæºæ–‡ä»¶ä¸­çš„æºç è¿›è¡Œè§£æï¼Œå¹¶å¾—åˆ°å¯¹åº”çš„æŠ½è±¡è¯­æ³•æ ‘ASTï¼Œç„¶åå‘ASTä¸­å¯¼å…¥Traceå‡½æ•°æ‰€åœ¨çš„åŒ…ï¼Œå¹¶å‘è¿™ä¸ªASTçš„æ‰€æœ‰å‡½æ•°å£°æ˜æ³¨å…¥Traceå‡½æ•°è°ƒç”¨ã€‚</p><p>å®é™…çš„æ³¨å…¥æ“ä½œå‘ç”Ÿåœ¨instrumenterçš„addDeferTraceIntoFuncDeclsæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•çš„å®ç°ï¼š</p><pre><code class=\"language-plain\">// instrument_trace/instrumenter/ast/ast.go\n\nfunc (a instrumenter) addDeferTraceIntoFuncDecls(f *ast.File) {\n    for _, decl := range f.Decls { // éå†æ‰€æœ‰å£°æ˜è¯­å¥\n        fd, ok := decl.(*ast.FuncDecl) // ç±»å‹æ–­è¨€ï¼šæ˜¯å¦ä¸ºå‡½æ•°å£°æ˜\n        if ok { \n            // å¦‚æœæ˜¯å‡½æ•°å£°æ˜ï¼Œåˆ™æ³¨å…¥è·Ÿè¸ªè®¾æ–½\n            a.addDeferStmt(fd)\n        }\n    }\n}\n</code></pre><p>è¿™ä¸ªæ–¹æ³•çš„é€»è¾‘ååˆ†æ¸…æ™°ï¼Œå°±æ˜¯éå†è¯­æ³•æ ‘ä¸Šæ‰€æœ‰å£°æ˜è¯­å¥ï¼Œå¦‚æœæ˜¯å‡½æ•°å£°æ˜ï¼Œå°±è°ƒç”¨instrumenterçš„addDeferStmtæ–¹æ³•è¿›è¡Œæ³¨å…¥ï¼Œå¦‚æœä¸æ˜¯ï¼Œå°±ç›´æ¥è¿”å›ã€‚addDeferStmtæ–¹æ³•çš„å®ç°å¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">// instrument_trace/instrumenter/ast/ast.go\n\nfunc (a instrumenter) addDeferStmt(fd *ast.FuncDecl) (added bool) {\n    stmts := fd.Body.List\n\n    // åˆ¤æ–­\"defer trace.Trace()()\"è¯­å¥æ˜¯å¦å·²ç»å­˜åœ¨\n    for _, stmt := range stmts {\n        ds, ok := stmt.(*ast.DeferStmt)\n        if !ok {\n            // å¦‚æœä¸æ˜¯deferè¯­å¥ï¼Œåˆ™ç»§ç»­forå¾ªç¯\n            continue\n        }\n\n        // å¦‚æœæ˜¯deferè¯­å¥ï¼Œåˆ™è¦è¿›ä¸€æ­¥åˆ¤æ–­æ˜¯å¦æ˜¯defer trace.Trace()()\n        ce, ok := ds.Call.Fun.(*ast.CallExpr)\n        if !ok {\n            continue\n        }\n\n        se, ok := ce.Fun.(*ast.SelectorExpr)\n        if !ok {\n            continue\n        }\n\n        x, ok := se.X.(*ast.Ident)\n        if !ok {\n            continue\n        }\n        if (x.Name == a.tracePkg) &amp;&amp; (se.Sel.Name == a.traceFunc) {\n            // defer trace.Trace()()å·²å­˜åœ¨ï¼Œè¿”å›\n            return false\n        }\n    }\n\n    // æ²¡æœ‰æ‰¾åˆ°\"defer trace.Trace()()\"ï¼Œæ³¨å…¥ä¸€ä¸ªæ–°çš„è·Ÿè¸ªè¯­å¥\n    // åœ¨ASTä¸Šæ„é€ ä¸€ä¸ªdefer trace.Trace()()\n    ds := &amp;ast.DeferStmt{\n        Call: &amp;ast.CallExpr{\n            Fun: &amp;ast.CallExpr{\n                Fun: &amp;ast.SelectorExpr{\n                    X: &amp;ast.Ident{\n                        Name: a.tracePkg,\n                    },\n                    Sel: &amp;ast.Ident{\n                        Name: a.traceFunc,\n                    },\n                },\n            },\n        },\n    }\n\n    newList := make([]ast.Stmt, len(stmts)+1)\n    copy(newList[1:], stmts)\n    newList[0] = ds // æ³¨å…¥æ–°æ„é€ çš„deferè¯­å¥\n    fd.Body.List = newList\n    return true\n}\n</code></pre><p>è™½ç„¶addDeferStmtå‡½æ•°ä½“ç•¥é•¿ï¼Œä½†é€»è¾‘ä¹Ÿå¾ˆæ¸…æ™°ï¼Œå°±æ˜¯å…ˆåˆ¤æ–­å‡½æ•°æ˜¯å¦å·²ç»æ³¨å…¥äº†Traceï¼Œå¦‚æœæœ‰ï¼Œåˆ™ç•¥è¿‡ï¼›å¦‚æœæ²¡æœ‰ï¼Œå°±æ„é€ ä¸€ä¸ªTraceè¯­å¥èŠ‚ç‚¹ï¼Œå¹¶å°†å®ƒæ’å…¥åˆ°ASTä¸­ã€‚</p><p>Instrumentçš„æœ€åä¸€æ­¥å°±æ˜¯å°†æ³¨å…¥Traceåçš„ASTé‡æ–°è½¬æ¢ä¸ºGoä»£ç ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬æœŸæœ›å¾—åˆ°çš„å¸¦æœ‰Traceç‰¹æ€§çš„Goä»£ç äº†ã€‚</p><h3>åˆ©ç”¨instrumentå·¥å…·æ³¨å…¥è·Ÿè¸ªä»£ç </h3><p>æœ‰äº†instrumentå·¥å…·åï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹å¦‚ä½•ä½¿ç”¨è¿™ä¸ªå·¥å…·ï¼Œåœ¨ç›®æ ‡Goæºæ–‡ä»¶ä¸­è‡ªåŠ¨æ³¨å…¥è·Ÿè¸ªè®¾æ–½ã€‚</p><p>è¿™é‡Œï¼Œæˆ‘åœ¨instrument_traceé¡¹ç›®çš„examplesç›®å½•ä¸‹å»ºç«‹äº†ä¸€ä¸ªåä¸ºdemoçš„é¡¹ç›®ï¼Œæˆ‘ä»¬å°±æ¥çœ‹çœ‹å¦‚ä½•ä½¿ç”¨instrumentå·¥å…·ä¸ºdemoé¡¹ç›®ä¸‹çš„demo.goæ–‡ä»¶è‡ªåŠ¨æ³¨å…¥è·Ÿè¸ªè®¾æ–½ã€‚demo.goæ–‡ä»¶å†…å®¹å¾ˆç®€å•ï¼š</p><pre><code class=\"language-plain\">// instrument_trace/examples/demo/demo.go\n\npackage main\n\nfunc foo() {\n    bar()\n}\n\nfunc bar() {\n}\n\nfunc main() {\n    foo()\n}\n</code></pre><p>æˆ‘ä»¬é¦–å…ˆæ„å»ºä¸€ä¸‹instrument_traceä¸‹çš„instrumentå·¥å…·ï¼š</p><pre><code class=\"language-plain\">$cd instrument_trace\n$go build github.com/bigwhite/instrument_trace/cmd/instrument\n$instrument version \n[instrument version]\ninstrument [-w] xxx.go\n  -w\twrite result to (source) file instead of stdout\n</code></pre><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä½¿ç”¨instrumentå·¥å…·å‘examples/demo/demo.goæºæ–‡ä»¶ä¸­çš„å‡½æ•°è‡ªåŠ¨æ³¨å…¥è·Ÿè¸ªè®¾æ–½ï¼š</p><pre><code class=\"language-plain\">$instrument -w  examples/demo/demo.go\n[instrument -w examples/demo/demo.go]\ninstrument trace for examples/demo/demo.go ok\n</code></pre><p>æ³¨å…¥åçš„demo.goæ–‡ä»¶å˜ä¸ºäº†ä¸‹é¢è¿™ä¸ªæ ·å­ï¼š</p><pre><code class=\"language-plain\">// instrument_trace/examples/demo/demo.go\n\npackage main\n  \nimport \"github.com/bigwhite/instrument_trace\"\n\nfunc foo() {\n    defer trace.Trace()()\n    bar()\n}\n\nfunc bar() {\n    defer trace.Trace()()\n}\n\nfunc main() {\n    defer trace.Trace()()\n    foo()\n}\n</code></pre><p>æ­¤æ—¶ï¼Œå¦‚æœæˆ‘ä»¬å†å¯¹å·²æ³¨å…¥Traceå‡½æ•°çš„demo.goæ‰§è¡Œä¸€æ¬¡instrumentå‘½ä»¤ï¼Œç”±äºinstrumentä¼šåˆ¤æ–­demo.goå„ä¸ªå‡½æ•°å·²ç»æ³¨å…¥äº†Traceï¼Œdemo.goçš„å†…å®¹å°†ä¿æŒä¸å˜ã€‚</p><p>ç”±äºgithub.com/bigwhite/instrument_traceå¹¶æ²¡æœ‰çœŸæ­£ä¸Šä¼ åˆ°github.comä¸Šï¼Œæ‰€ä»¥å¦‚æœä½ è¦è¿è¡Œdemo.goï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºå®ƒé…ç½®ä¸€ä¸ªä¸‹é¢è¿™æ ·çš„go.modï¼š</p><pre><code class=\"language-plain\">\n\n// instrument_trace/examples/demo/go.mod\n\nmodule demo\n\ngo 1.17\n\nrequire github.com/bigwhite/instrument_trace v1.0.0\n\nreplace github.com/bigwhite/instrument_trace v1.0.0 =&gt; ../../\n</code></pre><p>è¿™æ ·è¿è¡Œdemo.goå°±ä¸ä¼šé‡åˆ°éšœç¢äº†ï¼š</p><pre><code class=\"language-plain\">$go run demo.go\ng[00001]:    -&gt;main.main\ng[00001]:        -&gt;main.foo\ng[00001]:            -&gt;main.bar\ng[00001]:            &lt;-main.bar\ng[00001]:        &lt;-main.foo\ng[00001]:    &lt;-main.main\n</code></pre><h2>å°ç»“</h2><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»å®ç°äº†è¿™èŠ‚è¯¾å¼€å§‹æ—¶è®¾å®šçš„ç›®æ ‡ï¼šå®ç°ä¸€ä¸ªè‡ªåŠ¨æ³¨å…¥è·Ÿè¸ªä»£ç å¹¶è¾“å‡ºæœ‰å±‚æ¬¡æ„Ÿçš„å‡½æ•°è°ƒç”¨é“¾è·Ÿè¸ªå‘½ä»¤è¡Œå·¥å…·ã€‚</p><p>å›é¡¾ä¸€ä¸‹è¿™ä¸ªå·¥å…·çš„å®ç°æ€è·¯ï¼šæˆ‘ä»¬å…ˆåŸºäºdeferå®ç°äº†ä¸€ä¸ªæœ€ç®€å•çš„å‡½æ•°è·Ÿè¸ªæœºåˆ¶ï¼Œç„¶åé’ˆå¯¹è¿™ä¸ªæœ€ç®€å•çš„å®ç°æå‡ºè‹¥å¹²é—®é¢˜ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬é€ä¸€æŠŠè¿™äº›é—®é¢˜è§£å†³æ‰äº†ï¼Œæœ€ç»ˆå°†ç¬¬ä¸€ç‰ˆç›¸å¯¹ç²—ç³™çš„ä»£ç å®ç°æ¼”è¿›é‡æ„ä¸ºä¸€ä¸ªç›¸å¯¹å®Œå–„çš„å‘½ä»¤è¡Œå·¥å…·ã€‚</p><p>å…³äºè¿™ä¸ªå®æˆ˜é¡¹ç›®ï¼Œæœ‰ä¸¤ç‚¹æ³¨æ„äº‹é¡¹è¦å’Œä½ äº¤ä»£æ¸…æ¥šï¼š</p><p>ç¬¬ä¸€ï¼Œåœ¨ä»£ç ä¸­æ³¨å…¥å‡½æ•°è°ƒç”¨è·Ÿè¸ªä»£ç ä»…é€‚ç”¨äºæ—¥å¸¸è°ƒè¯•ä»£ç å’Œé˜…è¯»ç†è§£ä»£ç æ—¶ä½¿ç”¨ï¼Œè¢«æ³¨å…¥äº†è·Ÿè¸ªè®¾æ–½çš„ä»£ç æ˜¯ä¸é€‚åˆä¸Šç”Ÿäº§ç¯å¢ƒçš„ï¼›</p><p>ç¬¬äºŒï¼Œæˆ‘åœ¨è¿™é‡Œä½¿ç”¨åˆ°äº†Goæ ¸å¿ƒå›¢é˜Ÿä¸æ¨èä½¿ç”¨çš„Goroutine idï¼Œè¿™ä¹Ÿæ˜¯ç”±è¿™ä¸ªå®æˆ˜é¡¹ç›®çš„æ€§è´¨æ‰€å†³å®šçš„ã€‚å¦‚æœä½ çš„ä»£ç æ˜¯ä¸Šç”Ÿäº§ï¼Œæˆ‘å»ºè®®è¿˜æ˜¯å°½é‡å¬ä»Goæ ¸å¿ƒå›¢é˜Ÿçš„å»ºè®®ï¼Œ<strong>ä¸è¦ä¾èµ–Goroutine ID</strong>ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>é€šè¿‡instrumentå‘½ä»¤è¡Œå·¥å…·å¯¹Goæºæ–‡ä»¶è¿›è¡Œæ³¨å…¥åï¼Œdefer trace.Trace()()å°±ä¼šæˆä¸ºGoæºç çš„ä¸€éƒ¨åˆ†è¢«ç¼–è¯‘è¿›æœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶ä¸­ã€‚æˆ‘ä»¬åœ¨å°ç»“ä¸­ä¹Ÿæåˆ°äº†ï¼Œå¼€å¯äº†Traceçš„ä»£ç ä¸è¦ä¸Šç”Ÿäº§ç¯å¢ƒï¼Œè¿™æ ·æˆ‘ä»¬åœ¨æ„å»ºä¸Šç”Ÿäº§çš„åº”ç”¨ä¹‹å‰éœ€è¦æ‰‹å·¥åˆ æ‰è¿™äº›Traceä»£ç ï¼Œæ“ä½œèµ·æ¥ååˆ†ç¹çæ˜“é”™ã€‚</p><p>æ‰€ä»¥ï¼Œè¿™é‡Œæˆ‘æƒ³è¯·ä½ ä¸ºTraceå¢åŠ ä¸€ä¸ªå¼€å…³åŠŸèƒ½ï¼Œæœ‰äº†è¿™ä¸ªå¼€å…³åï¼Œæ—¥å¸¸å¼€å‘è°ƒè¯•è¿‡ç¨‹ä¸­ç¼–è¯‘å‡ºçš„ç¨‹åºä¸­çš„Traceæ˜¯èµ·ä½œç”¨çš„ï¼Œä½†ä¸ºç”Ÿäº§ç¯å¢ƒç¼–è¯‘å‡ºçš„å¯æ‰§è¡Œç¨‹åºä¸­è™½ç„¶ä¹ŸåŒ…å«Traceï¼Œä½†Traceä¸ä¼šçœŸæ­£èµ·ä½œç”¨ï¼ˆæç¤ºï¼šä½¿ç”¨build tagï¼‰ã€‚</p><p>æ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™æ›´å¤šå¯¹Goè¯­è¨€æ„Ÿå…´è¶£çš„æœ‹å‹ã€‚æˆ‘æ˜¯Tony Baiï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ã€‚</p><h4><a href=\"https://github.com/bigwhite/publication/tree/master/column/timegeek/go-first-course/27/instrument_trace\">è¿™ä¸ªé¡¹ç›®çš„æºç åœ¨è¿™é‡Œï¼</a></h4>","neighbors":{"left":{"article_title":"26ï½œæ–¹æ³•ï¼šå¦‚ä½•ç”¨ç±»å‹åµŒå…¥æ¨¡æ‹Ÿå®ç°â€œç»§æ‰¿â€ï¼Ÿ","id":467225},"right":{"article_title":"ç”¨æˆ·æ•…äº‹ï½œç½—æ°ï¼šæˆ‘çš„Goè¯­è¨€å­¦ä¹ ä¹‹è·¯","id":472588}},"comments":[{"had_liked":false,"id":327859,"user_name":"Darren","can_delete":false,"product_type":"c1","uid":1254968,"ip_address":"","ucode":"CCD2B2C492BE9A","user_header":"https://static001.geekbang.org/account/avatar/00/13/26/38/ef063dc2.jpg","comment_is_top":false,"comment_ctime":1640332045,"is_pvip":true,"replies":[{"id":"120355","content":"goåŸç”Ÿä¸æ”¯æŒæ³¨è§£åŠŸèƒ½ã€‚å®˜æ–¹å¯¹æ­¤åŸå› æ²¡æœ‰ä»»ä½•è¯´æ˜ã€‚goæ”¯æŒstruct tagï¼Œä¸€å®šç¨‹åº¦å…·å¤‡äº†annotationçš„æ€§è´¨ã€‚","user_name":"ä½œè€…å›å¤","comment_id":327859,"uid":"1026224","ip_address":"","utype":1,"ctime":1641894670,"user_name_real":"ç¼–è¾‘"}],"discussion_count":4,"race_medal":0,"score":"23115168525","product_id":100093501,"comment_content":"è€å¸ˆï¼Œé—®ä¸ªå°ç™½çš„é—®é¢˜å“ˆï¼Œå°±æ˜¯Javaå’ŒPythonéƒ½æ”¯æŒæ³¨è§£å¢åŠ èƒ½åŠ›ï¼Œä¸ä¼šä¿®æ”¹æºä»£ç ã€‚<br>æˆ‘çœ‹æ‚¨è¿™èŠ‚è¯¾çš„æœ€ç»ˆç‰ˆæœ¬ï¼Œå°±æ˜¯å·¥å…·ä¿®æ”¹æºä»£ç ï¼Œé‚£ä¹ˆgoæœ‰æ²¡æœ‰ç±»ä¼¼Javaå’ŒPythoné‚£ç§æ³¨è§£çš„å¢å¼ºèƒ½åŠ›ï¼Ÿå¦‚æœæ²¡æœ‰ï¼Œé‚£ä¹ˆæ˜¯å› ä¸ºä»€ä¹ˆåŸå› ä¸æ”¯æŒå‘€ï¼Ÿ","like_count":5,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":545289,"discussion_content":"goåŸç”Ÿä¸æ”¯æŒæ³¨è§£åŠŸèƒ½ã€‚å®˜æ–¹å¯¹æ­¤åŸå› æ²¡æœ‰ä»»ä½•è¯´æ˜ã€‚goæ”¯æŒstruct tagï¼Œä¸€å®šç¨‹åº¦å…·å¤‡äº†annotationçš„æ€§è´¨ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641894670,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1254968,"avatar":"https://static001.geekbang.org/account/avatar/00/13/26/38/ef063dc2.jpg","nickname":"Darren","note":"","ucode":"CCD2B2C492BE9A","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":545614,"discussion_content":"å¥½çš„ï¼Œè°¢è°¢è€å¸ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642002910,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":545289,"ip_address":""},"score":545614,"extra":""}]},{"author":{"id":1447496,"avatar":"https://static001.geekbang.org/account/avatar/00/16/16/48/01567df1.jpg","nickname":"éƒ‘æ³½æ´²","note":"","ucode":"EA1B540A040875","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":553220,"discussion_content":"åŠ¨æ€è¯­è¨€å’Œé™æ€è¯­è¨€é£æ ¼ä¸Šçš„åŒºåˆ«å§ã€‚Javaå’ŒPythoné‚£ç§æ³¨è§£çš„å¢å¼ºèƒ½åŠ›æ˜¯è™šæ‹Ÿæœºæ”¯æŒçš„ï¼Œç”¨ä¸­é—´ç å°±æ˜¯è¿™å¥½å¤„ã€‚golangéƒ½æ˜¯ç›´æ¥ç¼–è¯‘æˆæœºå™¨ç çš„ï¼Œä¸åŠ¨ä»£ç çš„æƒ…å†µä¸‹æ”¯æŒæ³¨è§£æœ‰å›°éš¾ã€‚","likes_number":6,"is_delete":false,"is_hidden":false,"ctime":1645771398,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1254968,"avatar":"https://static001.geekbang.org/account/avatar/00/13/26/38/ef063dc2.jpg","nickname":"Darren","note":"","ucode":"CCD2B2C492BE9A","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1447496,"avatar":"https://static001.geekbang.org/account/avatar/00/16/16/48/01567df1.jpg","nickname":"éƒ‘æ³½æ´²","note":"","ucode":"EA1B540A040875","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":553245,"discussion_content":"ç»™å¤§ä½¬ğŸ‘","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1645781718,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":553220,"ip_address":""},"score":553245,"extra":""}]}]},{"had_liked":false,"id":327725,"user_name":"æœ¨æœ¨","can_delete":false,"product_type":"c1","uid":2704565,"ip_address":"","ucode":"86820F26A27308","user_header":"https://static001.geekbang.org/account/avatar/00/29/44/b5/7eba5a0e.jpg","comment_is_top":false,"comment_ctime":1640252401,"is_pvip":false,"replies":[{"id":"120343","content":"waitgroupæ˜¯goæ ‡å‡†åº“syncåŒ…æä¾›çš„ä¸€ä¸ªåŠŸèƒ½ç‰¹æ€§ï¼Œå¸¸ç”¨ç”¨äºç­‰å¾…ä¸€ç»„å­goroutineçš„é€€å‡ºã€‚å¯ä»¥çœ‹çœ‹goå®˜æ–¹ç›¸å…³æ–‡æ¡£ä»¥åŠæ–‡æ¡£ä¸­çš„ç”¨æ³•ã€‚","user_name":"ä½œè€…å›å¤","comment_id":327725,"uid":"1026224","ip_address":"","utype":1,"ctime":1641889889,"user_name_real":"ç¼–è¾‘"}],"discussion_count":2,"race_medal":0,"score":"18820121585","product_id":100093501,"comment_content":"æ„Ÿè°¢ï¼Œè¿™èŠ‚è¯¾è§‰å¾—å­¦åˆ°äº†å¾ˆå¤šã€‚æœ‰ä¸ªé—®é¢˜ï¼Œåœ¨æ–‡ä¸­æ¼”ç¤ºå¦‚ä½•è·å¾— Goroutine IDçš„traceä¾‹ç¨‹é‡Œï¼ŒwaitGroupçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿæˆ‘æœ¬æ¥ä»¥ä¸ºæ˜¯åƒä¿¡å·é‡ä¸€æ ·çš„åŒæ­¥æ‰‹æ®µï¼Œä½†æ˜¯æƒ³äº†ä¸€æƒ³å‘ç°å¹¶ä¸æ˜¯ï¼Œå› ä¸ºwaitåœ¨A1ï¼ˆï¼‰ä¹‹åã€‚å¦‚æœwaitåœ¨A1ï¼ˆï¼‰ä¹‹å‰çš„è¯ï¼Œå¯ä»¥ä¿è¯è®©A2å…ˆæ‰§è¡Œå®Œå†æ‰§è¡ŒA1ã€‚æ–‡ä¸­è¿™ç§åœ¨A1ï¼ˆï¼‰ä¹‹åwaitï¼ˆï¼‰çš„åŸå› æ˜¯ä»€ä¹ˆï¼Ÿ","like_count":4,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":545264,"discussion_content":"waitgroupæ˜¯goæ ‡å‡†åº“syncåŒ…æä¾›çš„ä¸€ä¸ªåŠŸèƒ½ç‰¹æ€§ï¼Œå¸¸ç”¨ç”¨äºç­‰å¾…ä¸€ç»„å­goroutineçš„é€€å‡ºã€‚å¯ä»¥çœ‹çœ‹goå®˜æ–¹ç›¸å…³æ–‡æ¡£ä»¥åŠæ–‡æ¡£ä¸­çš„ç”¨æ³•ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641889889,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1344431,"avatar":"https://static001.geekbang.org/account/avatar/00/14/83/af/1cb42cd3.jpg","nickname":"é©¬ä»¥","note":"","ucode":"3FEA06CA14DE28","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":570342,"discussion_content":"ç›²çŒœå‘å±•åˆ°ä¸€å®šç¨‹åº¦ï¼Œgoå°±æ”¯æŒæ³¨è§£äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1651737875,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":327622,"user_name":"Geralt","can_delete":false,"product_type":"c1","uid":1184102,"ip_address":"","ucode":"2F31ED777D06A0","user_header":"https://static001.geekbang.org/account/avatar/00/12/11/66/ac631a36.jpg","comment_is_top":false,"comment_ctime":1640203301,"is_pvip":true,"replies":[{"id":"120341","content":"éƒ½ç”¨build tagäº†ï¼Œåº”è¯¥å°±ä¸éœ€è¦shouldprintäº†å§ã€‚","user_name":"ä½œè€…å›å¤","comment_id":327622,"uid":"1026224","ip_address":"","utype":1,"ctime":1641889411,"user_name_real":"ç¼–è¾‘"}],"discussion_count":2,"race_medal":0,"score":"18820072485","product_id":100093501,"comment_content":"æ€è€ƒé¢˜çš„ä¸€ä¸ªæ€è·¯ï¼š<br>åœ¨instrument_traceç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªconfigç›®å½•ï¼Œé‡Œé¢æœ‰dev.goå’Œprod.goä¸¤ä¸ªæ–‡ä»¶ï¼š<br>dev.go<br>&#47;&#47;go:build dev<br>package config<br><br>const ShouldPrint = true<br>------<br>prod.go<br><br>&#47;&#47;go:build prod<br>package config<br><br>const ShouldPrint = false<br><br>------<br><br>ä¿®æ”¹Trace()å‡½æ•°ï¼Œåœ¨æ–¹æ³•ä½“å†…å…ˆåˆ¤æ–­ShouldPrintçš„å€¼ï¼Œè‹¥ä¸ºfalseåˆ™è¿”å›ä¸€ä¸ªç©ºçš„åŒ¿åå‡½æ•°ã€‚<br><br>é€šè¿‡go build -tags dev(prod) å¯ä»¥æŒ‡å®šconfigç›®å½•ä¸‹å“ªä¸ªæ–‡ä»¶å‚ä¸ç¼–è¯‘ã€‚","like_count":4,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":545259,"discussion_content":"éƒ½ç”¨build tagäº†ï¼Œåº”è¯¥å°±ä¸éœ€è¦shouldprintäº†å§ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641889411,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1184102,"avatar":"https://static001.geekbang.org/account/avatar/00/12/11/66/ac631a36.jpg","nickname":"Geralt","note":"","ucode":"2F31ED777D06A0","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":545270,"discussion_content":"æ˜¯çš„ï¼Œæœ‰ç‚¹ç”»è›‡æ·»è¶³äº†ï¼Œè°¢è°¢è€å¸ˆã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641890679,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":545259,"ip_address":""},"score":545270,"extra":""}]}]},{"had_liked":false,"id":327522,"user_name":"å¼ ç”³å‚²","can_delete":false,"product_type":"c1","uid":1182372,"ip_address":"","ucode":"22D46BC529BA8A","user_header":"https://static001.geekbang.org/account/avatar/00/12/0a/a4/828a431f.jpg","comment_is_top":false,"comment_ctime":1640160725,"is_pvip":true,"replies":[{"id":"120337","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","comment_id":327522,"uid":"1026224","ip_address":"","utype":1,"ctime":1641886392,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":1,"score":"18820029909","product_id":100093501,"comment_content":"å°±å–œæ¬¢è¿™ç§å®æˆ˜ï¼Œå¯ä»¥æŠŠå‰é¢çš„çŸ¥è¯†ç‚¹éƒ½ä¸²èµ·æ¥ï¼Œå¯¹äºåŠ æ·±ç†è§£å¾ˆæœ‰å¸®åŠ©~","like_count":4,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":545246,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641886392,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":327745,"user_name":"æœ¨æœ¨","can_delete":false,"product_type":"c1","uid":2704565,"ip_address":"","ucode":"86820F26A27308","user_header":"https://static001.geekbang.org/account/avatar/00/29/44/b5/7eba5a0e.jpg","comment_is_top":false,"comment_ctime":1640264501,"is_pvip":false,"replies":[{"id":"120342","content":"è¿™ä¸èƒ½æ€ªä½ ï¼Œå› ä¸ºè¿™é‡Œä½¿ç”¨äº†æ¥å£çš„ç±»å‹æ–­è¨€(type assert)è¯­æ³•ï¼Œå¯ä»¥å…ˆçœ‹çœ‹ç¬¬28è®²åï¼Œå†å›æ¥çœ‹è¿™æ®µä»£ç ã€‚","user_name":"ä½œè€…å›å¤","comment_id":327745,"uid":"1026224","ip_address":"","utype":1,"ctime":1641889740,"user_name_real":"ç¼–è¾‘"}],"discussion_count":2,"race_medal":0,"score":"14525166389","product_id":100093501,"comment_content":"ä¸€ä¸ªé—®é¢˜ï¼šè€å¸ˆä»£ç é‡Œå¥½å‡ å¤„ç”¨åˆ°äº†ç±»ä¼¼ fd, ok :=decl.(*ast.FuncDecl) è¿™ç§å†™æ³•ï¼Œçœ‹äº†ä¸€ä¸‹ï¼Œastæ˜¯packageï¼ŒFuncDeclæ˜¯ä¸€ä¸ªstructï¼Œdeclæ˜¯ä¸€ä¸ªast.Declç±»å‹çš„å˜é‡ï¼Œç»™æˆ‘ææ™•äº†ã€‚è¯·é—®ç­‰å·å³è¾¹çš„æ„æ€æ˜¯ä»€ä¹ˆï¼Ÿ ","like_count":3,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":545262,"discussion_content":"è¿™ä¸èƒ½æ€ªä½ ï¼Œå› ä¸ºè¿™é‡Œä½¿ç”¨äº†æ¥å£çš„ç±»å‹æ–­è¨€(type assert)è¯­æ³•ï¼Œå¯ä»¥å…ˆçœ‹çœ‹ç¬¬28è®²åï¼Œå†å›æ¥çœ‹è¿™æ®µä»£ç ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641889740,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1133041,"avatar":"https://static001.geekbang.org/account/avatar/00/11/49/f1/bd61dbb1.jpg","nickname":"Ransang","note":"","ucode":"DB67566A627DF2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":543686,"discussion_content":"ç±»å‹æ–­è¨€ switché‚£èŠ‚æœ‰è®²è¿‡","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641270516,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":327500,"user_name":"qinsi","can_delete":false,"product_type":"c1","uid":1667175,"ip_address":"","ucode":"090D9C4068FF12","user_header":"https://static001.geekbang.org/account/avatar/00/19/70/67/0c1359c2.jpg","comment_is_top":false,"comment_ctime":1640151874,"is_pvip":true,"replies":[{"id":"120336","content":"1. goçš„mapç±»å‹å¦‚æœå‘ç°å¤šä¸ªgoroutineå°è¯•å¯¹å…¶è¿›è¡Œå†™æ“ä½œï¼Œä½†æ²¡æœ‰åŠ é”ï¼Œå°±å¯èƒ½æŠ›å‡ºpanic <br>2. æ€è·¯ä¸é”™ï¼Œä½†æˆ‘å¯¹ssa iräº†è§£ä¸å¤šï¼Œå¦‚æœä½ å¯¹ssa irå¾ˆäº†è§£ï¼Œå»ºè®®ä½ å°è¯•ä¸€ä¸‹ï¼Œæœ‰æˆæœåä¹Ÿå¯ä»¥åˆ†äº«å‡ºæ¥ã€‚","user_name":"ä½œè€…å›å¤","comment_id":327500,"uid":"1026224","ip_address":"","utype":1,"ctime":1641886334,"user_name_real":"ç¼–è¾‘"}],"discussion_count":7,"race_medal":0,"score":"14525053762","product_id":100093501,"comment_content":"ä¸€äº›ç–‘é—®ï¼š<br><br>1. åœ¨è¾“å‡ºå¸¦ç¼©è¿›çš„è·Ÿè¸ªä¿¡æ¯æ—¶ï¼Œç”¨ä¸€ä¸ªmapä¿å­˜äº†ä¸åŒgoroutineçš„å½“å‰ç¼©è¿›ã€‚ä½†ä¼¼ä¹æ¯ä¸ªgoroutineéƒ½åªä¼šè®¿é—®è‡ªå·±çš„idå¯¹åº”çš„kvï¼Œä¸å­˜åœ¨ä¸åŒçš„goroutineè®¿é—®åŒä¸€ä¸ªkeyçš„æƒ…å†µã€‚è¿™ç§æƒ…å†µä¸‹èƒ½å¦ä¸åŠ é”å‘¢ï¼Ÿ<br><br>2. åœ¨å…¶ä»–è¯­è¨€çš„ç”Ÿæ€ä¸­ï¼Œå®ç°æ— ä¾µå…¥çš„é“¾è·¯è·Ÿè¸ªé€šå¸¸éƒ½æ˜¯åœ¨è¯­è¨€çš„ä¸­é—´è¡¨ç¤ºä¸Šåšæ–‡ç« ï¼Œæ¯”å¦‚JVMå­—èŠ‚ç æˆ–æ˜¯LLVM IRã€‚æŸ¥äº†ä¸‹goä¼¼ä¹ä¹Ÿæœ‰è‡ªå·±çš„ä¸€ç§ssa irï¼Œé‚£ä¹ˆæ˜¯å¦æœ‰å¯èƒ½ä¹Ÿåœ¨è¿™ç§irä¸Šåšåšæ–‡ç« ï¼Ÿ","like_count":3,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":545245,"discussion_content":"1. goçš„mapç±»å‹å¦‚æœå‘ç°å¤šä¸ªgoroutineå°è¯•å¯¹å…¶è¿›è¡Œå†™æ“ä½œï¼Œä½†æ²¡æœ‰åŠ é”ï¼Œå°±å¯èƒ½æŠ›å‡ºpanic \n2. æ€è·¯ä¸é”™ï¼Œä½†æˆ‘å¯¹ssa iräº†è§£ä¸å¤šï¼Œå¦‚æœä½ å¯¹ssa irå¾ˆäº†è§£ï¼Œå»ºè®®ä½ å°è¯•ä¸€ä¸‹ï¼Œæœ‰æˆæœåä¹Ÿå¯ä»¥åˆ†äº«å‡ºæ¥ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641886334,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2831263,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/33/9f/b7f6087a.jpg","nickname":"é˜¿ç™½","note":"","ucode":"118CEDC8373CE3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":540777,"discussion_content":"ä¸èƒ½ä¸åŠ é”è®¿é—®ï¼Œmapæºç é‡Œåªè¦åœ¨è¯»å†™ä¼šè®¾ç½®mapåº•å±‚ç»“æ„ä½“çš„ä¸€ä¸ªæ ‡å¿—ä½ï¼Œåç»­çš„è¯»å†™æ“ä½œéƒ½ä¼šæ£€æŸ¥è¿™ä¸ªæ ‡å¿—ä½æ¥åˆ¤æ–­å¹¶å‘è¯»å†™ï¼Œè€Œä¸æ˜¯é€šè¿‡æ£€æµ‹å¤šä¸ªgoroutineè¯»å†™åŒä¸€ä¸ªkeyæ¥åˆ¤æ–­å¹¶å‘è¯»å†™çš„","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1640165363,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":5,"child_discussions":[{"author":{"id":1667175,"avatar":"https://static001.geekbang.org/account/avatar/00/19/70/67/0c1359c2.jpg","nickname":"qinsi","note":"","ucode":"090D9C4068FF12","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":2831263,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/33/9f/b7f6087a.jpg","nickname":"é˜¿ç™½","note":"","ucode":"118CEDC8373CE3","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":540867,"discussion_content":"é‚£è¿™ä¸ªmapå¥½åƒæœ‰ç‚¹å¼±å“¦ï¼Œæ˜æ˜æƒ³è®¿é—®çš„æ•°æ®åœ¨é€»è¾‘ä¸Šéƒ½æ˜¯ç›¸äº’ç‹¬ç«‹çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640185853,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":540777,"ip_address":""},"score":540867,"extra":""},{"author":{"id":1184102,"avatar":"https://static001.geekbang.org/account/avatar/00/12/11/66/ac631a36.jpg","nickname":"Geralt","note":"","ucode":"2F31ED777D06A0","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1667175,"avatar":"https://static001.geekbang.org/account/avatar/00/19/70/67/0c1359c2.jpg","nickname":"qinsi","note":"","ucode":"090D9C4068FF12","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":540922,"discussion_content":"ä½†æ˜¯mapæœ¬èº«æ˜¯å…±äº«çš„ï¼Œæ‰€ä»¥ä½ è¯´çš„æ‰€è°“çš„â€œåœ¨é€»è¾‘ä¸Šéƒ½æ˜¯ç›¸äº’ç‹¬ç«‹â€çš„è¯´æ³•æ˜¯ä¸å¯¹çš„ã€‚mapä½œä¸ºä¸€ä¸ªç»å¸¸ä½¿ç”¨åˆ°çš„æ•°æ®ç»“æ„ï¼Œå¤§å¤šæ•°åœºæ™¯ä¸‹éƒ½æ˜¯ä¸éœ€è¦å¹¶å‘å®‰å…¨çš„ã€‚å¦‚æœéœ€è¦å¹¶å‘å®‰å…¨çš„mapï¼Œå¯ä»¥è‡ªè¡Œå®ç°æˆ–è€…ä½¿ç”¨å¼€æºåº“ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640202347,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":540867,"ip_address":""},"score":540922,"extra":""},{"author":{"id":1667175,"avatar":"https://static001.geekbang.org/account/avatar/00/19/70/67/0c1359c2.jpg","nickname":"qinsi","note":"","ucode":"090D9C4068FF12","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1184102,"avatar":"https://static001.geekbang.org/account/avatar/00/12/11/66/ac631a36.jpg","nickname":"Geralt","note":"","ucode":"2F31ED777D06A0","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":540945,"discussion_content":"é‚£ä¸ç”¨mapç”¨æ•°ç»„æ˜¯ä¸æ˜¯å¯ä»¥ä¸åŠ é”å‘¢ï¼Ÿä¹Ÿæ˜¯å…±äº«äº†ä¸€ä¸ªæ•°ç»„ï¼Œä½†è¯»å†™çš„éƒ½æ˜¯æ•°ç»„ä¸­ä¸åŒçš„ä½ç½®","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640221257,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":540922,"ip_address":""},"score":540945,"extra":""}]}]},{"had_liked":false,"id":345213,"user_name":"è·¯è¾¹çš„çŒª","can_delete":false,"product_type":"c1","uid":2057354,"ip_address":"","ucode":"92F7C082E44FC4","user_header":"https://static001.geekbang.org/account/avatar/00/1f/64/8a/bc8cb43c.jpg","comment_is_top":false,"comment_ctime":1652115541,"is_pvip":true,"replies":[{"id":"126054","content":"å—¯ï¼Œä¸é”™çš„æ€è·¯ã€‚","user_name":"ä½œè€…å›å¤","comment_id":345213,"uid":"1026224","ip_address":"","utype":1,"ctime":1652190351,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"10242050133","product_id":100093501,"comment_content":"var mgroup = make(map[uint64]int)<br>var mutex sync.Mutex<br><br>func Trace() func() {<br>\tpc, _, _, ok := runtime.Caller(1)<br>\tif !ok {<br>\t\tfmt.Println(&quot;æŠ¥é”™&quot;)<br>\t}<br>\tfuncccc := runtime.FuncForPC(pc)<br>\tfunname := funcccc.Name()<br>\tgid := curGoroutineID()<br><br>\tmutex.Lock()<br>\tindex := mgroup[gid]<br>\tmgroup[gid] = index + 1<br>\tmutex.Unlock()<br>\ts := &quot;&quot;<br>\tfor i := 0; i &lt;= index; i++ {<br>\t\ts = s + &quot;    &quot;<br>\t}<br>\tfmt.Printf(&quot;g[%05d]:%s-&gt; enter:%s\\n&quot;, gid, s, funname)<br>\treturn func() {<br>\t\tfmt.Printf(&quot;g[%05d]:%s&lt;- exit :%s\\n&quot;, gid, s, funname)<br>\t}<br>}<br><br>åˆ©ç”¨deferåé¢çš„è¡¨è¾¾å¼åœ¨å…¥æ ˆæ—¶æ±‚å€¼è¿™ä¸€ç‰¹æ€§ï¼Œç”¨ä¸€ä¸ªç¼©ç´§å˜é‡å°±è¡Œäº†ï¼Œé—­åŒ…ä¸­çš„ indents -1 æœ‰ç‚¹å¤šæ­¤ä¸€ä¸¾å§ï¼Ÿ","like_count":2,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":571385,"discussion_content":"å—¯ï¼Œä¸é”™çš„æ€è·¯ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1652190351,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":348656,"user_name":"KingOfDark","can_delete":false,"product_type":"c1","uid":2790875,"ip_address":"","ucode":"F13D3A1287495B","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/kHoDdV15McW26tMCNnU8GSsUib9UWboAjVSe4nop5nPVt7qZNcUicCic3W50uaDHj0ibupXQtpvOUG4YaomBqHicVmg/132","comment_is_top":false,"comment_ctime":1655282234,"is_pvip":false,"replies":[{"id":"126992","content":"1. å…³äºgoå¢é‡ç¼–è¯‘ï¼Œå¯ä»¥äº†è§£ä¸€ä¸‹ https:&#47;&#47;tonybai.com&#47;2022&#47;03&#47;21&#47;go-native-support-incremental-build <br>2. ç¬¬ä¸€ä¸ªæ€è·¯âœ…ã€‚ç¬¬äºŒç§æ€è·¯ç»´æŠ¤èµ·æ¥è¿‡äºéº»çƒ¦äº†ã€‚","user_name":"ä½œè€…å›å¤","comment_id":348656,"uid":"1026224","ip_address":"","utype":1,"ctime":1655342658,"user_name_real":"ç¼–è¾‘"}],"discussion_count":2,"race_medal":0,"score":"5950249530","product_id":100093501,"comment_content":"1. å¯¹äºgo buildçš„ç¼–è¯‘è¿‡ç¨‹ï¼Œæœ‰ç‚¹ç–‘é—®ï¼Œå°±æ¯”å¦‚è¿™é‡Œç¼–è¯‘ go build demo.go ï¼Œä¼šæŠŠä¾èµ–çš„åŒ…ä¹Ÿéƒ½ç»™é‡æ–°ç¼–è¯‘å—ï¼Ÿ è¿˜æ˜¯è¯´ä¾èµ–åŒ…çš„éƒ½æ˜¯æå‰ç¼–è¯‘å¥½çš„ï¼ˆæˆ–è€…è¯´åªä¼šæœ‰ä¸€æ¬¡ç¼–è¯‘ï¼Œä¹‹åä¸ä¼šé‡æ–°ç¼–è¯‘äº†ï¼Œåªéœ€è¦åœ¨é“¾æ¥å³å¯ï¼Ÿï¼‰<br><br>2. å¯¹äºæ€è€ƒé¢˜çš„ä½¿ç”¨build tagsï¼Œæœ‰ä¸¤ç§æ€è·¯ï¼š<br>ç¬¬ä¸€ç§æ€è·¯ï¼Œæ˜¯ trace.go æœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼ˆæ–‡ä»¶åå¯ä»¥åˆ†åˆ«ä¸º dev_trace.goï¼Œ prod_trace.goï¼‰ï¼Œdev ç‰ˆæœ¬çš„trace æ˜¯æ­£å¸¸çš„æ‰“å°é€»è¾‘ï¼Œprod ç‰ˆæœ¬ç›´æ¥è¿”å›ç©ºå‡½æ•°ä½“<br>ç¬¬äºŒç§æ€è·¯ï¼Œæ˜¯ è¦ç¼–è¯‘&#47;è¿½è¸ªçš„goæºæ–‡ä»¶æœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼Œä¸€ä¸ªå¸¦æœ‰traceå‡½æ•°ï¼Œä¸€ä¸ªä¸å¸¦traceå‡½æ•°ï¼ˆè¿™ä¸ªæ–¹æ³•å¥½åƒç”¨ä¸åˆ° build tag äº†ï¼Œä½†æ˜¯è¿™æ ·å¥½åƒæŠŠdeferçš„å¼€é”€ä¹Ÿçœå»äº†ï¼‰<br>","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576176,"discussion_content":"1. å…³äºgoå¢é‡ç¼–è¯‘ï¼Œå¯ä»¥äº†è§£ä¸€ä¸‹ https://tonybai.com/2022/03/21/go-native-support-incremental-build \n2. ç¬¬ä¸€ä¸ªæ€è·¯âœ…ã€‚ç¬¬äºŒç§æ€è·¯ç»´æŠ¤èµ·æ¥è¿‡äºéº»çƒ¦äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655342658,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1156153,"avatar":"https://static001.geekbang.org/account/avatar/00/11/a4/39/a3e452cd.jpg","nickname":"a115","note":"","ucode":"0C733004371E29","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576744,"discussion_content":"m","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655774749,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":327910,"user_name":"lesserror","can_delete":false,"product_type":"c1","uid":1351076,"ip_address":"","ucode":"25A54D1165FCF6","user_header":"https://static001.geekbang.org/account/avatar/00/14/9d/a4/e481ae48.jpg","comment_is_top":false,"comment_ctime":1640356415,"is_pvip":false,"replies":[{"id":"120399","content":"1. è¿™é‡Œæ‰€è°“çš„fooå‡½æ•°è¿”å›åï¼ŒæŒ‡çš„æ˜¯deferå‡½æ•°è¢«æ‰§è¡Œï¼Œdeferredå‡½æ•°å³æ˜¯é‚£ä¸ªé—­åŒ…å‡½æ•°ã€‚<br>2.pcæ˜¯ç¨‹åºè®¡æ•°å™¨ï¼Œå†¯ Â·è¯ºä¼Šæ›¼è®¡ç®—æœºä½“ç³»ç»“æ„ä¸­çš„ä¸€ä¸ªå¯„å­˜å™¨ã€‚å¯ä»¥è‡ªè¡Œgoogleæˆ–baiduä¸€ä¸‹ã€‚<br>3. go buildåï¼Œinstrumentç¨‹åºä¼šå‡ºç°åœ¨å½“å‰ç›®å½•ä¸‹ã€‚<br>4. æœ€å¤§åŸå› è¿˜æ˜¯é¿å…è¢«æ»¥ç”¨ã€‚é¿å…å†™å‡ºå¼ºä¾èµ–goroutine idçš„ä»£ç ã€‚å› ä¸ºå¼ºä¾èµ–goroutineå°†å¯¼è‡´ä»£ç ä¸å¥½ç§»æ¤ï¼ŒåŒæ—¶ä¹Ÿä¼šå¯¼è‡´å¹¶å‘æ¨¡å‹å¤æ‚åŒ–ã€‚<br>5. æç¤ºé‡Œæœ‰ï¼Œä½¿ç”¨build tagã€‚å…³äºbuild tagç”¨æ³•ï¼Œå¯ä»¥å‚è€ƒgoå®˜æ–¹æ–‡æ¡£ã€‚","user_name":"ä½œè€…å›å¤","comment_id":327910,"uid":"1026224","ip_address":"","utype":1,"ctime":1641994761,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"5935323711","product_id":100093501,"comment_content":"æ„Ÿè°¢å¤§ç™½è€å¸ˆï¼Œè¿™ä¸€è®²çš„å†…å®¹å¾ˆæœ‰å¯å‘æ€§ã€‚æœ‰å‡ ä¸ªå°ç–‘é—®ï¼ŒåŠ³çƒ¦æœ‰æ—¶é—´å›å¤ä¸€ä¸‹ï¼š<br><br>1. æ–‡ä¸­è¯´ï¼šâ€œäºæ˜¯å½“ foo å‡½æ•°è¿”å›åï¼Œè¿™ä¸ªé—­åŒ…å‡½æ•°å°±ä¼šè¢«æ‰§è¡Œã€‚â€ æˆ‘æƒ³çš„æ˜¯ï¼Œè¿™é‡Œæ˜¯ä¸æ˜¯ foo å‡½æ•°è¿”å›ä¹‹å‰ï¼Œé—­åŒ…å‡½æ•°å°±ä¼šè¢«æ‰§è¡Œå‘¢ï¼Ÿ   foo å‡½æ•°è¿”å›åï¼Œæ˜¯ä¸æ˜¯ä»£è¡¨è¿™ä¸ªå‡½æ•°å·²ç»æ‰§è¡Œå®Œæ¯•äº†ï¼Ÿ<br><br>2. ç¬¬ä¸€ä¸ªè¿”å›å€¼ä»£è¡¨çš„æ˜¯ç¨‹åºè®¡æ•°ï¼ˆpc)ã€‚æˆ‘æ‰“å°pcå˜é‡ï¼Œå‡ºæ¥çš„æ˜¯ç±»ä¼¼ï¼š 17343465ã€17343241ã€17343369Â·Â·Â·Â·Â·Â·ï¼Œè¿™ä¸ªè®¡æ•°ç©¶ç«Ÿæ˜¯ä»€ä¹ˆå‘¢ï¼Œå†…å­˜åœ°å€å—ï¼Ÿ<br><br>3. æ–‡ä¸­çš„è¿™ä¸¤æ­¥æ“ä½œï¼š$go build github.com&#47;bigwhite&#47;instrument_trace&#47;cmd&#47;instrument<br>                               $instrument version<br>æˆ‘çš„ç†è§£æ˜¯ç¼–è¯‘ç”Ÿæˆäº†å¯æ‰§è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶åï¼Œéœ€è¦æ”¾åˆ° ç±»ä¼¼ binç›®å½•ä¸­ï¼Œæ‰èƒ½å…¨å±€ æ‰§è¡Œ â€œinstrument versionâ€ å‘½ä»¤å§ï¼Ÿ æ„Ÿè§‰è€å¸ˆè¿™é‡Œè¿˜å°‘äº†ä¸€æ­¥æ“ä½œã€‚<br><br>4. ä¸å»ºè®®ä½¿ç”¨ Goroutine IDçš„æœ€å¤§åŸå› æ˜¯ä»€ä¹ˆï¼Ÿ æ–‡ä¸­é“¾æ¥ä¸­çš„è®¨è®ºç»„å†…å®¹æ²¡æœ‰ä»”ç»†çœ‹å®Œã€‚<br><br>5. è¯¾åé—®é¢˜çš„æ¯”è¾ƒä¼˜è¶Šçš„å®ç°æ–¹æ¡ˆæ˜¯ä»€ä¹ˆï¼Ÿæƒ³å¬åˆ°è€å¸ˆçš„ç­”æ¡ˆã€‚<br><br>psï¼šé—®é¢˜æœ‰ç‚¹å¤šï¼Œä½†æ˜¯ç¡®å®å±äºæˆ‘è¿™èŠ‚è¯¾çœ‹å®Œåçš„ç–‘æƒ‘ï¼Œè°¢è°¢è€å¸ˆè§£ç­”ã€‚","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":545547,"discussion_content":"1. è¿™é‡Œæ‰€è°“çš„fooå‡½æ•°è¿”å›åï¼ŒæŒ‡çš„æ˜¯deferå‡½æ•°è¢«æ‰§è¡Œï¼Œdeferredå‡½æ•°å³æ˜¯é‚£ä¸ªé—­åŒ…å‡½æ•°ã€‚\n2.pcæ˜¯ç¨‹åºè®¡æ•°å™¨ï¼Œå†¯ Â·è¯ºä¼Šæ›¼è®¡ç®—æœºä½“ç³»ç»“æ„ä¸­çš„ä¸€ä¸ªå¯„å­˜å™¨ã€‚å¯ä»¥è‡ªè¡Œgoogleæˆ–baiduä¸€ä¸‹ã€‚\n3. go buildåï¼Œinstrumentç¨‹åºä¼šå‡ºç°åœ¨å½“å‰ç›®å½•ä¸‹ã€‚\n4. æœ€å¤§åŸå› è¿˜æ˜¯é¿å…è¢«æ»¥ç”¨ã€‚é¿å…å†™å‡ºå¼ºä¾èµ–goroutine idçš„ä»£ç ã€‚å› ä¸ºå¼ºä¾èµ–goroutineå°†å¯¼è‡´ä»£ç ä¸å¥½ç§»æ¤ï¼ŒåŒæ—¶ä¹Ÿä¼šå¯¼è‡´å¹¶å‘æ¨¡å‹å¤æ‚åŒ–ã€‚\n5. æç¤ºé‡Œæœ‰ï¼Œä½¿ç”¨build tagã€‚å…³äºbuild tagç”¨æ³•ï¼Œå¯ä»¥å‚è€ƒgoå®˜æ–¹æ–‡æ¡£ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641994761,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":327525,"user_name":"å·¦è€³æœµä¸œ","can_delete":false,"product_type":"c1","uid":1160678,"ip_address":"","ucode":"60134ACF12BB52","user_header":"https://static001.geekbang.org/account/avatar/00/11/b5/e6/c67f12bd.jpg","comment_is_top":false,"comment_ctime":1640161506,"is_pvip":false,"replies":[{"id":"120338","content":"demoä¸‹çš„go.modä¸­å†…å®¹æ˜¯å¦æ­£ç¡®ï¼Ÿ","user_name":"ä½œè€…å›å¤","comment_id":327525,"uid":"1026224","ip_address":"","utype":1,"ctime":1641888374,"user_name_real":"ç¼–è¾‘"}],"discussion_count":3,"race_medal":0,"score":"5935128802","product_id":100093501,"comment_content":"æˆ‘ç”Ÿæˆçš„ demo.go æ–‡ä»¶å’Œè€å¸ˆä¸€æ ·ï¼Œä½†æ‰§è¡Œçš„æ—¶å€™ä¸ºä»€ä¹ˆæŠ¥é”™ï¼š<br>examples\\demo\\demo.go:3:8: imported and not used: &quot;instrument_trace&quot;<br>examples\\demo\\demo.go:6:8: undefined: trace<br>examples\\demo\\demo.go:11:8: undefined: trace<br>examples\\demo\\demo.go:15:8: undefined: trace","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":545251,"discussion_content":"demoä¸‹çš„go.modä¸­å†…å®¹æ˜¯å¦æ­£ç¡®ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641888374,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1313498,"avatar":"https://static001.geekbang.org/account/avatar/00/14/0a/da/dcf8f2b1.jpg","nickname":"qiutian","note":"","ucode":"99658A8E342498","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":575089,"discussion_content":"æˆ‘ä¹Ÿé‡åˆ°äº†è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘å‘ç°æ˜¯æˆ‘çš„trace.goæ–‡ä»¶çš„ç¬¬ä¸€è¡Œçš„åŒ…åå†™é”™äº†ï¼Œåº”è¯¥æ˜¯package traceï¼Œè¿™æ ·åœ¨demo.goä¸­æ‰ä¼šè¯†åˆ«çš„åˆ°ï¼Œå¦åˆ™demo.goä¸­çš„trace.Trace()()è¿™ä¸ªæ˜¯æ‰¾ä¸åˆ°traceåŒ…çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1654588975,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1351076,"avatar":"https://static001.geekbang.org/account/avatar/00/14/9d/a4/e481ae48.jpg","nickname":"lesserror","note":"","ucode":"25A54D1165FCF6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":541397,"discussion_content":"æ„Ÿè§‰æ˜¯ä½ instrument_traceé¡¹ç›®ç›®å½•ä¸‹çš„go.modæ–‡ä»¶ä¸­çš„moduleå£°æ˜æœ‰é—®é¢˜ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640355155,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":327508,"user_name":"bearlu","can_delete":false,"product_type":"c1","uid":1030862,"ip_address":"","ucode":"14F260C8B24E27","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ba/ce/fd45714f.jpg","comment_is_top":false,"comment_ctime":1640156655,"is_pvip":true,"replies":[{"id":"120398","content":"ä¸å»ºè®®ä½¿ç”¨ã€‚","user_name":"ä½œè€…å›å¤","comment_id":327508,"uid":"1026224","ip_address":"","utype":1,"ctime":1641994136,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"5935123951","product_id":100093501,"comment_content":"è€å¸ˆï¼Œè¿˜æœ‰å…¶ä»–æ–¹å¼è·å–Goroutine IDï¼Ÿè¿˜æ˜¯ä¸å»ºè®®ä½¿ç”¨Goroutine IDï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":545545,"discussion_content":"ä¸å»ºè®®ä½¿ç”¨ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641994136,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":327481,"user_name":"ç½—æ°","can_delete":false,"product_type":"c1","uid":1320487,"ip_address":"","ucode":"96BAFAA147341F","user_header":"https://static001.geekbang.org/account/avatar/00/14/26/27/eba94899.jpg","comment_is_top":false,"comment_ctime":1640144038,"is_pvip":false,"replies":[{"id":"120372","content":"å—¯ï¼Œå¯ä»¥å¯¹æ¯”ä¸€ä¸‹ä¸¤ç§æ–¹æ³•å“ªä¸ªæ›´é€‚åˆã€‚","user_name":"ä½œè€…å›å¤","comment_id":327481,"uid":"1026224","ip_address":"","utype":1,"ctime":1641957162,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":2,"score":"5935111334","product_id":100093501,"comment_content":"å¹²è´§æ»¡æ»¡ï¼Œè¿™èŠ‚çš„ä»£ç æœ€å¥½æ‰‹åŠ¨ç å‡ºæ¥ï¼Œäº²è‡ªå¥½å¥½æ„Ÿå—ä¸€ä¸‹ã€‚æˆ‘ä»¬çº¿ä¸Šçš„ç¯å¢ƒåŸºæœ¬ä¸Šéƒ½æ˜¯ç¯å¢ƒå˜é‡æ§åˆ¶ï¼Œgo build å€’æ˜¯ä»æ¥æ²¡æœ‰ä½¿ç”¨è¿‡ï¼Œè¿™ä¸ªä¹Ÿå¯ä»¥å°è¯•ä¸€ä¸‹ã€‚","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":545431,"discussion_content":"å—¯ï¼Œå¯ä»¥å¯¹æ¯”ä¸€ä¸‹ä¸¤ç§æ–¹æ³•å“ªä¸ªæ›´é€‚åˆã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1641957162,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":359676,"user_name":"pythonbug","can_delete":false,"product_type":"c1","uid":1487274,"ip_address":"è¾½å®","ucode":"1A70CA92FFF8EB","user_header":"https://wx.qlogo.cn/mmopen/vi_32/wgMMrp1hvSB3E30KqZvMsj3KQdAI3T1uQM77LT7hZ65nVSjPGRg3AbUOyiahnssA6AIT5PAkyHFmlTBzUH9gdyQ/132","comment_is_top":false,"comment_ctime":1665741308,"is_pvip":true,"replies":[{"id":"130859","content":"ç¬¬23è®² è®²deferæ—¶è¯´è¿‡ä¸€ç‚¹ï¼šâ€œdefer å…³é”®å­—åé¢çš„è¡¨è¾¾å¼ï¼Œæ˜¯åœ¨å°† deferred å‡½æ•°æ³¨å†Œåˆ° deferred å‡½æ•°æ ˆçš„æ—¶å€™è¿›è¡Œæ±‚å€¼çš„ã€‚â€<br><br>è¿™ä¸€è®²ï¼Œdefer Trace(&quot;main&quot;)() &lt;=&gt; defer f()ï¼Œè€Œfå…¶å®æ˜¯Trace(&quot;main&quot;)çš„è¿”å›å€¼ï¼Œåœ¨æ³¨å†Œdeferredå‡½æ•°æ—¶ï¼Œä¼šå¯¹Trace(&quot;main&quot;)è¿›è¡Œæ±‚å€¼ï¼Œæ±‚å€¼ç»“æœä¸ºä¸€ä¸ªé—­åŒ…å‡½æ•°ã€‚ç»“æœå°±æ˜¯ï¼šè¿™ä¸ªé—­åŒ…å‡½æ•°è¢«æ³¨å†Œåˆ° deferred å‡½æ•°æ ˆä¸­äº†ã€‚","user_name":"ä½œè€…å›å¤","comment_id":359676,"uid":"1026224","ip_address":"è¾½å®","utype":1,"ctime":1665836642,"user_name_real":"ç¼–è¾‘"}],"discussion_count":2,"race_medal":0,"score":"1665741308","product_id":100093501,"comment_content":"è€å¸ˆå¥½ï¼Œæˆ‘ä¸€å¼€å§‹å°±æ²¡çœ‹æ‡‚ã€‚ã€‚ã€‚å°±æ˜¯Trace(name string)è¿™ä¸ªä½œä¸ºdeferredå‡½æ•°ï¼Œä¸ºå•¥ä¼šå…ˆæ‰§è¡Œprintlnã€‚ä¸æ˜¯åº”è¯¥ç­‰å‡½æ•°æ‰§è¡Œåï¼Œå†æ‰§è¡Œé‡Œé¢çš„å†…å®¹ä¹ˆã€‚éš¾é“æ˜¯å› ä¸ºTrace(name string)è¿™ä¸ªå‡½æ•°çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªé—­åŒ…å‡½æ•°ï¼Œæ‰€ä»¥ä¸ä¸€æ ·å—","like_count":0,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":590522,"discussion_content":"ç¬¬23è®² è®²deferæ—¶è¯´è¿‡ä¸€ç‚¹ï¼šâ€œdefer å…³é”®å­—åé¢çš„è¡¨è¾¾å¼ï¼Œæ˜¯åœ¨å°† deferred å‡½æ•°æ³¨å†Œåˆ° deferred å‡½æ•°æ ˆçš„æ—¶å€™è¿›è¡Œæ±‚å€¼çš„ã€‚â€\n\nè¿™ä¸€è®²ï¼Œdefer Trace(&#34;main&#34;)() &lt;=&gt; defer f()ï¼Œè€Œfå…¶å®æ˜¯Trace(&#34;main&#34;)çš„è¿”å›å€¼ï¼Œåœ¨æ³¨å†Œdeferredå‡½æ•°æ—¶ï¼Œä¼šå¯¹Trace(&#34;main&#34;)è¿›è¡Œæ±‚å€¼ï¼Œæ±‚å€¼ç»“æœä¸ºä¸€ä¸ªé—­åŒ…å‡½æ•°ã€‚ç»“æœå°±æ˜¯ï¼šè¿™ä¸ªé—­åŒ…å‡½æ•°è¢«æ³¨å†Œåˆ° deferred å‡½æ•°æ ˆä¸­äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1665836643,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"è¾½å®"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1487274,"avatar":"https://wx.qlogo.cn/mmopen/vi_32/wgMMrp1hvSB3E30KqZvMsj3KQdAI3T1uQM77LT7hZ65nVSjPGRg3AbUOyiahnssA6AIT5PAkyHFmlTBzUH9gdyQ/132","nickname":"pythonbug","note":"","ucode":"1A70CA92FFF8EB","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":590573,"discussion_content":"æ„Ÿè°¢å¤§ä½¬ï¼Œæ˜ç™½äº†ï¼Œå¤šè°¢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1665895280,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":590522,"ip_address":"æ±Ÿè‹"},"score":590573,"extra":""}]}]},{"had_liked":false,"id":355017,"user_name":"è èå¹é›ªâ€”Code","can_delete":false,"product_type":"c1","uid":1650378,"ip_address":"åŒ—äº¬","ucode":"A5B2FC661EE17D","user_header":"https://static001.geekbang.org/account/avatar/00/19/2e/ca/469f7266.jpg","comment_is_top":false,"comment_ctime":1660982686,"is_pvip":true,"replies":[{"id":"129212","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","comment_id":355017,"uid":"1026224","ip_address":"åŒ—äº¬","utype":1,"ctime":1661135549,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"1660982686","product_id":100093501,"comment_content":"æ‰“å¡","like_count":0,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":584785,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661135549,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":343651,"user_name":"Geek_as","can_delete":false,"product_type":"c1","uid":1534500,"ip_address":"","ucode":"AB7B70DBC2B5F8","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/qhonwcQle1RBufvLdTm4MgSNl554GBXUZtNNH65oYajbbRLxKsZX4hM9vFtrLLpDM0H93ZNWRFAZSrIZC7yAsQ/132","comment_is_top":false,"comment_ctime":1650966783,"is_pvip":true,"replies":[{"id":"125493","content":"runtimeå±‚é¢å¯¹mapå¹¶å‘è¯»å†™çš„æ£€æµ‹æ˜¯æ•´ä½“çš„ï¼Œä¸ä¼šè€ƒè™‘goroutineæ˜¯å¦å„è‡ªè®¿é—®è‡ªå·±çš„æ•°æ®ã€‚","user_name":"ä½œè€…å›å¤","comment_id":343651,"uid":"1026224","ip_address":"","utype":1,"ctime":1651050554,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"1650966783","product_id":100093501,"comment_content":"è€å¸ˆï¼Œæˆ‘è§‰å¾—é‚£ä¸ªmapåŠ é”å¥½åƒä¸éœ€è¦ï¼Œmapçš„ç¡®æ˜¯ä¸æ”¯æŒå¹¶å‘å†™ï¼Œä½†æˆ‘è§‰å¾—è¿™ä¸ªå¹¶å‘å†™ï¼Œåº”è¯¥æ˜¯ä¸æ”¯æŒå¤šä¸ªgorunineå¯¹åŒä¸€ä¸ªkeyå†™ï¼Œä½†æ˜¯ç°åœ¨è¿™ä¸ªé¡¹ç›®ï¼Œæ¯ä¸ªgorunineæ˜¯å¯¹å±äºè‡ªå·±çš„keyè¿›è¡Œæ“ä½œï¼Œå³æ¯ä¸ªkeyä»»ä½•æ—¶åˆ»æœ€å¤šåªä¼šè¢«ä¸€ä¸ªgorunineå†™ï¼Œä¸å­˜åœ¨å¹¶å‘é—®é¢˜","like_count":0,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":568039,"discussion_content":"runtimeå±‚é¢å¯¹mapå¹¶å‘è¯»å†™çš„æ£€æµ‹æ˜¯æ•´ä½“çš„ï¼Œä¸ä¼šè€ƒè™‘goroutineæ˜¯å¦å„è‡ªè®¿é—®è‡ªå·±çš„æ•°æ®ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1651050555,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":338895,"user_name":"Rayjun","can_delete":false,"product_type":"c1","uid":1002514,"ip_address":"","ucode":"61A3D1A3D03569","user_header":"https://static001.geekbang.org/account/avatar/00/0f/4c/12/f0c145d4.jpg","comment_is_top":false,"comment_ctime":1647779744,"is_pvip":true,"replies":[{"id":"123917","content":"åœ¨æˆ‘çš„åˆè¡·é‡Œï¼Œç”Ÿäº§ç¯å¢ƒæ˜¯ä¸åº”è¯¥å¼€å¯è¯¥Traceçš„ï¼Œè¯¥Traceæ›´å¤šæ˜¯åœ¨æ—¥å¸¸dev&#47;debug&#47;read source codeæ—¶ä½¿ç”¨ã€‚å¯ä»¥é€šè¿‡go build -tagæ–¹å¼å¼€å¯å’Œå…³é—­Traceã€‚","user_name":"ä½œè€…å›å¤","comment_id":338895,"uid":"1026224","ip_address":"","utype":1,"ctime":1647904596,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"1647779744","product_id":100093501,"comment_content":"åœ¨æ—¥å¿—é‡Œé¢åŠ é”ä¹Ÿä¸æ˜¯ä¸€ä¸ªå¥½çš„æ–¹æ¡ˆå§","like_count":0,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":557618,"discussion_content":"åœ¨æˆ‘çš„åˆè¡·é‡Œï¼Œç”Ÿäº§ç¯å¢ƒæ˜¯ä¸åº”è¯¥å¼€å¯è¯¥Traceçš„ï¼Œè¯¥Traceæ›´å¤šæ˜¯åœ¨æ—¥å¸¸dev/debug/read source codeæ—¶ä½¿ç”¨ã€‚å¯ä»¥é€šè¿‡go build -tagæ–¹å¼å¼€å¯å’Œå…³é—­Traceã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1647904596,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":336662,"user_name":"äºŒåˆ€ç”°","can_delete":false,"product_type":"c1","uid":1360554,"ip_address":"","ucode":"1854DA6F1017E5","user_header":"https://static001.geekbang.org/account/avatar/00/14/c2/aa/fbff810a.jpg","comment_is_top":false,"comment_ctime":1646278360,"is_pvip":true,"replies":[{"id":"123104","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","comment_id":336662,"uid":"1026224","ip_address":"","utype":1,"ctime":1646469337,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"1646278360","product_id":100093501,"comment_content":"çœ‹å®Œè¿™ç« ï¼Œæœ‰ç§é…£ç•…æ·‹æ¼“çš„æ„Ÿè§‰","like_count":0,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":554566,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1646469337,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":335893,"user_name":"é¡·","can_delete":false,"product_type":"c1","uid":1132878,"ip_address":"","ucode":"096B6859C1FA80","user_header":"https://static001.geekbang.org/account/avatar/00/11/49/4e/8798cd01.jpg","comment_is_top":false,"comment_ctime":1645758940,"is_pvip":true,"replies":[{"id":"122778","content":"ä½ æ˜¯ç”¨go 1.17ï¼Œå¹¶åœ¨ç»ˆç«¯å‘½ä»¤è¡Œä¸­è·‘çš„ä¹ˆï¼Ÿè¿˜æ˜¯åœ¨ä¸€äº›IDEä¸­è¿è¡Œçš„ï¼Ÿ","user_name":"ä½œè€…å›å¤","comment_id":335893,"uid":"1026224","ip_address":"","utype":1,"ctime":1645837851,"user_name_real":"ç¼–è¾‘"}],"discussion_count":3,"race_medal":0,"score":"1645758940","product_id":100093501,"comment_content":"è€å¸ˆæˆ‘1.17  ç¬¬ä¸€ä¸ªä¾‹å­è·‘å‡ºæ¥ä¸ºå•¥æ˜¯<br>enterï¼š foo<br>enterï¼š bar<br>exit:  bar<br>exit:  foo<br>enterï¼š main","like_count":0,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":553301,"discussion_content":"ä½ æ˜¯ç”¨go 1.17ï¼Œå¹¶åœ¨ç»ˆç«¯å‘½ä»¤è¡Œä¸­è·‘çš„ä¹ˆï¼Ÿè¿˜æ˜¯åœ¨ä¸€äº›IDEä¸­è¿è¡Œçš„ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1645837851,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":2,"child_discussions":[{"author":{"id":1132878,"avatar":"https://static001.geekbang.org/account/avatar/00/11/49/4e/8798cd01.jpg","nickname":"é¡·","note":"","ucode":"096B6859C1FA80","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":553573,"discussion_content":"æ£€æŸ¥äº†å‡ éï¼Œå‘ç°æ˜¯æœ‰ä¸€è¡Œæ˜¯è°ƒç”¨defer Trace(&#34;main&#34;)   è€Œä¸æ˜¯defer Trace(&#34;main&#34;)ï¼ˆï¼‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1645968336,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":553301,"ip_address":""},"score":553573,"extra":""},{"author":{"id":1132878,"avatar":"https://static001.geekbang.org/account/avatar/00/11/49/4e/8798cd01.jpg","nickname":"é¡·","note":"","ucode":"096B6859C1FA80","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":553578,"discussion_content":"æ€è€ƒé¢˜ï¼šæˆ‘å»ºç«‹äº†ä¸€ä¸ªtrace_dev.go  ä¸€ä¸ªtrace_prod.go ,ä¸ºä»€ä¹ˆé‡å†™çš„demo.go \næ–‡ä»¶æç¤ºimport github.com/xxx/instrument_trace åŒ…ä»…å«æµ‹è¯•æ–‡ä»¶ è¿è¡Œä¸äº†å‘¢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1645969996,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":553301,"ip_address":""},"score":553578,"extra":""}]}]},{"had_liked":false,"id":334263,"user_name":"Geek_2337af","can_delete":false,"product_type":"c1","uid":2847330,"ip_address":"","ucode":"54B135EB7E70F1","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83ep7c7UKsjRiclaAqD9vMHSUXayzrvRhvic3Lm6ibX82L3DibJnCCtDmB3OfxbuVjetpT6Qa8IuwqZCWlw/132","comment_is_top":false,"comment_ctime":1644833395,"is_pvip":false,"replies":[{"id":"122150","content":"å¥½é—®é¢˜ï¼å¦‚æœæ˜¯åƒç”¨go build xxx&#47;yyy æ„å»ºmainåŒ…ï¼Œé‚£ä¹ˆgo buildä¼šç”Ÿæˆåä¸ºyyyçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚å¦‚æœmainåŒ…ä¸‹é¢æœ‰å¾ˆå¤šæºæ–‡ä»¶ï¼Œä¹Ÿæ˜¯å¯ä»¥è¿™ä¹ˆæ„å»ºçš„ã€‚<br> ","user_name":"ä½œè€…å›å¤","comment_id":334263,"uid":"1026224","ip_address":"","utype":1,"ctime":1644917898,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"1644833395","product_id":100093501,"comment_content":"è€å¸ˆè§£è¯»ä¸€ä¸‹go build github.com&#47;bigwhite&#47;instrument_trace&#47;cmd&#47;instrumentï¼Œè¿™æ ·æ˜¯æ•´ä¸ªåŒ…æ„å»ºçš„å—ï¼Œç„¶åç”Ÿæˆçš„æ–‡ä»¶åé»˜è®¤æ˜¯åŒ…åinstrumentï¼Œå¦‚æœinstrumentåŒ…é‡Œé¢è¿˜æœ‰main.goä¾èµ–çš„æºç æ–‡ä»¶ï¼Œè¿˜è¿™æ ·è¿™æ ·æ„å»ºå¯ä»¥å—","like_count":0,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":551178,"discussion_content":"å¥½é—®é¢˜ï¼å¦‚æœæ˜¯åƒç”¨go build xxx/yyy æ„å»ºmainåŒ…ï¼Œé‚£ä¹ˆgo buildä¼šç”Ÿæˆåä¸ºyyyçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚å¦‚æœmainåŒ…ä¸‹é¢æœ‰å¾ˆå¤šæºæ–‡ä»¶ï¼Œä¹Ÿæ˜¯å¯ä»¥è¿™ä¹ˆæ„å»ºçš„ã€‚\n ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644917898,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":330484,"user_name":"lemon","can_delete":false,"product_type":"c1","uid":2323716,"ip_address":"","ucode":"47626025C55E5E","user_header":"https://static001.geekbang.org/account/avatar/00/23/75/04/d26cd437.jpg","comment_is_top":false,"comment_ctime":1641993093,"is_pvip":false,"replies":[{"id":"121544","content":"ä»€ä¹ˆosï¼Ÿç”¨.&#47;instrumentå‘¢ï¼Ÿ","user_name":"ä½œè€…å›å¤","comment_id":330484,"uid":"1026224","ip_address":"","utype":1,"ctime":1643443054,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"1641993093","product_id":100093501,"comment_content":"è€å¸ˆï¼Œæˆ‘è¿™è¾¹æŒ‰ç…§æ­¥éª¤å†™å®Œä»£ç buildä¹‹åæ˜¾ç¤ºcommand not found: instrumentï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘€ï¼Œä»GitHubä¸Šcloneä¸‹æ¥è€å¸ˆæ‚¨çš„ä»£ç buildä¹‹åä¹Ÿä¸è¡Œ...å¾ˆå¥‡æ€ª","like_count":0,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":548909,"discussion_content":"ä»€ä¹ˆosï¼Ÿç”¨./instrumentå‘¢ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1643443054,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":329706,"user_name":"hcyycb","can_delete":false,"product_type":"c1","uid":1226968,"ip_address":"","ucode":"77FF6CA41F9E66","user_header":"https://static001.geekbang.org/account/avatar/00/12/b8/d8/f81b5604.jpg","comment_is_top":false,"comment_ctime":1641483471,"is_pvip":true,"replies":[{"id":"120482","content":"æˆ‘æŒ‰ç…§ä½ çš„æ€è·¯ä¿®æ”¹äº†ä¸€ä¸‹å¹¶è¿è¡Œexample_test.goï¼Œå¾—åˆ°ç»“æœ:<br><br>g[00001]:    -&gt;instrument_trace_test.a<br>g[00001]:        -&gt;instrument_trace_test.b<br>g[00001]:            -&gt;instrument_trace_test.c<br>g[00001]:                -&gt;instrument_trace_test.d<br>g[00001]:                &lt;-instrument_trace_test.d<br>g[00001]:            &lt;-instrument_trace_test.c<br>g[00001]:        &lt;-instrument_trace_test.b<br>g[00001]:    &lt;-instrument_trace_test.a<br><br>macos go 1.17<br><br>æ²¡æœ‰é‡åˆ°ä½ æ‰€æåˆ°çš„æƒ…å†µã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1026224","ctime":1642041958,"ip_address":"","comment_id":329706,"utype":1}],"discussion_count":3,"race_medal":0,"score":"1641483471","product_id":100093501,"comment_content":"è·Ÿç»ƒæ¨¡æ‹Ÿ instrument_trace çš„ç»ƒä¹ ã€‚<br>æˆ‘åœ¨ go mod init çš„æ—¶å€™ï¼Œçœç•¥äº†â€œgithub.com&#47;bigwhite&#47;â€ ã€‚<br>ç›´æ¥ç”¨ go mod init instrument_trace,<br>è¾“å‡ºçš„ç»“æœæ˜¯ï¼š<br>g[00001]:    -&gt;command-line-arguments_test.a<br>è·å–ä¸åˆ°æŠ¥åã€‚æœ¬æ¥çš„æœŸæœ›å€¼åº”è¯¥æ˜¯ï¼š<br>g[00001]:    -&gt;instrument_trace_test.a<br><br>ä¸çŸ¥æœ‰æ²¡æœ‰åŒå­¦é‡åˆ°ç›¸ä¼¼çš„æŠ¥é”™ç»å†ï¼Ÿ<br>","like_count":0,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":545701,"discussion_content":"æˆ‘æŒ‰ç…§ä½ çš„æ€è·¯ä¿®æ”¹äº†ä¸€ä¸‹å¹¶è¿è¡Œexample_test.goï¼Œå¾—åˆ°ç»“æœ:\n\ng[00001]:    -&gt;instrument_trace_test.a\ng[00001]:        -&gt;instrument_trace_test.b\ng[00001]:            -&gt;instrument_trace_test.c\ng[00001]:                -&gt;instrument_trace_test.d\ng[00001]:                &lt;-instrument_trace_test.d\ng[00001]:            &lt;-instrument_trace_test.c\ng[00001]:        &lt;-instrument_trace_test.b\ng[00001]:    &lt;-instrument_trace_test.a\n\nmacos go 1.17\n\næ²¡æœ‰é‡åˆ°ä½ æ‰€æåˆ°çš„æƒ…å†µã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642041958,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1226968,"avatar":"https://static001.geekbang.org/account/avatar/00/12/b8/d8/f81b5604.jpg","nickname":"hcyycb","note":"","ucode":"77FF6CA41F9E66","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":545953,"discussion_content":"è°¢è°¢è€å¸ˆã€‚æˆ‘è¿™é‡Œçš„å‡ºé”™çš„åŸå› æ˜¯ç”¨äº†vscodeé‡Œçš„ç»ˆç«¯è¿è¡Œã€‚å¦‚æœç”¨ç³»ç»Ÿè‡ªå¸¦çš„ç»ˆç«¯è¿è¡Œæµ‹è¯•ç¨‹åºï¼Œæ˜¯å¯ä»¥å¾—åˆ°è¯¾ç¨‹é‡Œçš„å®éªŒç»“æœçš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642089947,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":545701,"ip_address":""},"score":545953,"extra":""}]},{"author":{"id":1045910,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f5/96/0cf9f3c7.jpg","nickname":"Aeins","note":"","ucode":"D5BF220767541D","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":574317,"discussion_content":"çŒœæµ‹ä½ æ˜¯è¿™ä¹ˆæ‰§è¡Œæµ‹è¯•æ–‡ä»¶çš„ï¼š go test example_test.go\nå¦‚ä¸‹å‘½ä»¤æ‰§è¡Œå°±æ²¡é—®é¢˜ï¼š go test","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1653974329,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":329029,"user_name":"aoe","can_delete":false,"product_type":"c1","uid":1121758,"ip_address":"","ucode":"1C6201EDB4E954","user_header":"https://static001.geekbang.org/account/avatar/00/11/1d/de/62bfa83f.jpg","comment_is_top":false,"comment_ctime":1641036652,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1641036652","product_id":100093501,"comment_content":"æŠ½è±¡è¯­æ³•æ ‘çœ‹ä¸Šå»å¾ˆå‰å®³å•Šï¼","like_count":0},{"had_liked":false,"id":328067,"user_name":"è¿›åŒ–èŒ","can_delete":false,"product_type":"c1","uid":1276861,"ip_address":"","ucode":"B30A5F78BB4171","user_header":"https://static001.geekbang.org/account/avatar/00/13/7b/bd/ccb37425.jpg","comment_is_top":false,"comment_ctime":1640513129,"is_pvip":true,"discussion_count":0,"race_medal":5,"score":"1640513129","product_id":100093501,"comment_content":"æœ‰ç‚¹å¥½å¥‡çš„æ˜¯ï¼Œide debugèƒ½è°ƒè¯•goroutineå—ï¼Ÿåªèƒ½è¾“å‡ºæ—¥å¿—æ¥æŸ¥çœ‹å—","like_count":0}]}