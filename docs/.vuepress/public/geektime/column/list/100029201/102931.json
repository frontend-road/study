{"id":102931,"title":"11 | 无消息丢失配置怎么实现？","content":"<p>你好，我是胡夕。今天我要和你分享的主题是：如何配置Kafka无消息丢失。</p><p>一直以来，很多人对于Kafka丢失消息这件事情都有着自己的理解，因而也就有着自己的解决之道。在讨论具体的应对方法之前，我觉得我们首先要明确，在Kafka的世界里什么才算是消息丢失，或者说Kafka在什么情况下能保证消息不丢失。这点非常关键，因为很多时候我们容易混淆责任的边界，如果搞不清楚事情由谁负责，自然也就不知道由谁来出解决方案了。</p><p>那Kafka到底在什么情况下才能保证消息不丢失呢？</p><p><strong>一句话概括，Kafka只对“已提交”的消息（committed message）做有限度的持久化保证。</strong></p><p>这句话里面有两个核心要素，我们一一来看。</p><p>第一个核心要素是“<strong>已提交的消息</strong>”。什么是已提交的消息？当Kafka的若干个Broker成功地接收到一条消息并写入到日志文件后，它们会告诉生产者程序这条消息已成功提交。此时，这条消息在Kafka看来就正式变为“已提交”消息了。</p><p>那为什么是若干个Broker呢？这取决于你对“已提交”的定义。你可以选择只要有一个Broker成功保存该消息就算是已提交，也可以是令所有Broker都成功保存该消息才算是已提交。不论哪种情况，Kafka只对已提交的消息做持久化保证这件事情是不变的。</p><!-- [[[read_end]]] --><p>第二个核心要素就是“<strong>有限度的持久化保证</strong>”，也就是说Kafka不可能保证在任何情况下都做到不丢失消息。举个极端点的例子，如果地球都不存在了，Kafka还能保存任何消息吗？显然不能！倘若这种情况下你依然还想要Kafka不丢消息，那么只能在别的星球部署Kafka Broker服务器了。</p><p>现在你应该能够稍微体会出这里的“有限度”的含义了吧，其实就是说Kafka不丢消息是有前提条件的。假如你的消息保存在N个Kafka Broker上，那么这个前提条件就是这N个Broker中至少有1个存活。只要这个条件成立，Kafka就能保证你的这条消息永远不会丢失。</p><p>总结一下，Kafka是能做到不丢失消息的，只不过这些消息必须是已提交的消息，而且还要满足一定的条件。当然，说明这件事并不是要为Kafka推卸责任，而是为了在出现该类问题时我们能够明确责任边界。</p><h2><strong>“消息丢失”案例</strong></h2><p>好了，理解了Kafka是怎样做到不丢失消息的，那接下来我带你复盘一下那些常见的“Kafka消息丢失”案例。注意，这里可是带引号的消息丢失哦，其实有些时候我们只是冤枉了Kafka而已。</p><p><strong>案例1：生产者程序丢失数据</strong></p><p>Producer程序丢失消息，这应该算是被抱怨最多的数据丢失场景了。我来描述一个场景：你写了一个Producer应用向Kafka发送消息，最后发现Kafka没有保存，于是大骂：“Kafka真烂，消息发送居然都能丢失，而且还不告诉我？！”如果你有过这样的经历，那么请先消消气，我们来分析下可能的原因。</p><p>目前Kafka Producer是异步发送消息的，也就是说如果你调用的是producer.send(msg)这个API，那么它通常会立即返回，但此时你不能认为消息发送已成功完成。</p><p>这种发送方式有个有趣的名字，叫“fire and forget”，翻译一下就是“发射后不管”。这个术语原本属于导弹制导领域，后来被借鉴到计算机领域中，它的意思是，执行完一个操作后不去管它的结果是否成功。调用producer.send(msg)就属于典型的“fire and forget”，因此如果出现消息丢失，我们是无法知晓的。这个发送方式挺不靠谱吧，不过有些公司真的就是在使用这个API发送消息。</p><p>如果用这个方式，可能会有哪些因素导致消息没有发送成功呢？其实原因有很多，例如网络抖动，导致消息压根就没有发送到Broker端；或者消息本身不合格导致Broker拒绝接收（比如消息太大了，超过了Broker的承受能力）等。这么来看，让Kafka“背锅”就有点冤枉它了。就像前面说过的，Kafka不认为消息是已提交的，因此也就没有Kafka丢失消息这一说了。</p><p>不过，就算不是Kafka的“锅”，我们也要解决这个问题吧。实际上，解决此问题的方法非常简单：<strong>Producer永远要使用带有回调通知的发送API，也就是说不要使用producer.send(msg)，而要使用producer.send(msg, callback)</strong>。不要小瞧这里的callback（回调），它能准确地告诉你消息是否真的提交成功了。一旦出现消息提交失败的情况，你就可以有针对性地进行处理。</p><p>举例来说，如果是因为那些瞬时错误，那么仅仅让Producer重试就可以了；如果是消息不合格造成的，那么可以调整消息格式后再次发送。总之，处理发送失败的责任在Producer端而非Broker端。</p><p>你可能会问，发送失败真的没可能是由Broker端的问题造成的吗？当然可能！如果你所有的Broker都宕机了，那么无论Producer端怎么重试都会失败的，此时你要做的是赶快处理Broker端的问题。但之前说的核心论据在这里依然是成立的：Kafka依然不认为这条消息属于已提交消息，故对它不做任何持久化保证。</p><p><strong>案例2：消费者程序丢失数据</strong></p><p>Consumer端丢失数据主要体现在Consumer端要消费的消息不见了。Consumer程序有个“位移”的概念，表示的是这个Consumer当前消费到的Topic分区的位置。下面这张图来自于官网，它清晰地展示了Consumer端的位移数据。</p><p><img src=\"https://static001.geekbang.org/resource/image/0c/37/0c97bed3b6350d73a9403d9448290d37.png?wh=2041*1243\" alt=\"\"></p><p>比如对于Consumer A而言，它当前的位移值就是9；Consumer B的位移值是11。</p><p>这里的“位移”类似于我们看书时使用的书签，它会标记我们当前阅读了多少页，下次翻书的时候我们能直接跳到书签页继续阅读。</p><p>正确使用书签有两个步骤：第一步是读书，第二步是更新书签页。如果这两步的顺序颠倒了，就可能出现这样的场景：当前的书签页是第90页，我先将书签放到第100页上，之后开始读书。当阅读到第95页时，我临时有事中止了阅读。那么问题来了，当我下次直接跳到书签页阅读时，我就丢失了第96～99页的内容，即这些消息就丢失了。</p><p>同理，Kafka中Consumer端的消息丢失就是这么一回事。要对抗这种消息丢失，办法很简单：<strong>维持先消费消息（阅读），再更新位移（书签）的顺序</strong>即可。这样就能最大限度地保证消息不丢失。</p><p>当然，这种处理方式可能带来的问题是消息的重复处理，类似于同一页书被读了很多遍，但这不属于消息丢失的情形。在专栏后面的内容中，我会跟你分享如何应对重复消费的问题。</p><p>除了上面所说的场景，其实还存在一种比较隐蔽的消息丢失场景。</p><p>我们依然以看书为例。假设你花钱从网上租借了一本共有10章内容的电子书，该电子书的有效阅读时间是1天，过期后该电子书就无法打开，但如果在1天之内你完成阅读就退还租金。</p><p>为了加快阅读速度，你把书中的10个章节分别委托给你的10个朋友，请他们帮你阅读，并拜托他们告诉你主旨大意。当电子书临近过期时，这10个人告诉你说他们读完了自己所负责的那个章节的内容，于是你放心地把该书还了回去。不料，在这10个人向你描述主旨大意时，你突然发现有一个人对你撒了谎，他并没有看完他负责的那个章节。那么很显然，你无法知道那一章的内容了。</p><p>对于Kafka而言，这就好比Consumer程序从Kafka获取到消息后开启了多个线程异步处理消息，而Consumer程序自动地向前更新位移。假如其中某个线程运行失败了，它负责的消息没有被成功处理，但位移已经被更新了，因此这条消息对于Consumer而言实际上是丢失了。</p><p>这里的关键在于Consumer自动提交位移，与你没有确认书籍内容被全部读完就将书归还类似，你没有真正地确认消息是否真的被消费就“盲目”地更新了位移。</p><p>这个问题的解决方案也很简单：<strong>如果是多线程异步处理消费消息，Consumer程序不要开启自动提交位移，而是要应用程序手动提交位移</strong>。在这里我要提醒你一下，单个Consumer程序使用多线程来消费消息说起来容易，写成代码却异常困难，因为你很难正确地处理位移的更新，也就是说避免无消费消息丢失很简单，但极易出现消息被消费了多次的情况。</p><h2><strong>最佳实践</strong></h2><p>看完这两个案例之后，我来分享一下Kafka无消息丢失的配置，每一个其实都能对应上面提到的问题。</p><ol>\n<li>\n<p>不要使用producer.send(msg)，而要使用producer.send(msg, callback)。记住，一定要使用带有回调通知的send方法。</p>\n</li>\n<li>\n<p>设置acks = all。acks是Producer的一个参数，代表了你对“已提交”消息的定义。如果设置成all，则表明所有副本Broker都要接收到消息，该消息才算是“已提交”。这是最高等级的“已提交”定义。</p>\n</li>\n<li>\n<p>设置retries为一个较大的值。这里的retries同样是Producer的参数，对应前面提到的Producer自动重试。当出现网络的瞬时抖动时，消息发送可能会失败，此时配置了retries &gt; 0的Producer能够自动重试消息发送，避免消息丢失。</p>\n</li>\n<li>\n<p>设置unclean.leader.election.enable = false。这是Broker端的参数，它控制的是哪些Broker有资格竞选分区的Leader。如果一个Broker落后原先的Leader太多，那么它一旦成为新的Leader，必然会造成消息的丢失。故一般都要将该参数设置成false，即不允许这种情况的发生。</p>\n</li>\n<li>\n<p>设置replication.factor &gt;= 3。这也是Broker端的参数。其实这里想表述的是，最好将消息多保存几份，毕竟目前防止消息丢失的主要机制就是冗余。</p>\n</li>\n<li>\n<p>设置min.insync.replicas &gt; 1。这依然是Broker端参数，控制的是消息至少要被写入到多少个副本才算是“已提交”。设置成大于1可以提升消息持久性。在实际环境中千万不要使用默认值1。</p>\n</li>\n<li>\n<p>确保replication.factor &gt; min.insync.replicas。如果两者相等，那么只要有一个副本挂机，整个分区就无法正常工作了。我们不仅要改善消息的持久性，防止数据丢失，还要在不降低可用性的基础上完成。推荐设置成replication.factor = min.insync.replicas + 1。</p>\n</li>\n<li>\n<p>确保消息消费完成再提交。Consumer端有个参数enable.auto.commit，最好把它设置成false，并采用手动提交位移的方式。就像前面说的，这对于单Consumer多线程处理的场景而言是至关重要的。</p>\n</li>\n</ol><h2><strong>小结</strong></h2><p>今天，我们讨论了Kafka无消息丢失的方方面面。我们先从什么是消息丢失开始说起，明确了Kafka持久化保证的责任边界，随后以这个规则为标尺衡量了一些常见的数据丢失场景，最后通过分析这些场景，我给出了Kafka无消息丢失的“最佳实践”。总结起来，我希望你今天能有两个收获：</p><ul>\n<li>明确Kafka持久化保证的含义和限定条件。</li>\n<li>熟练配置Kafka无消息丢失参数。</li>\n</ul><p><img src=\"https://static001.geekbang.org/resource/image/3f/5a/3fc09aa33dc1022e867df4930054ce5a.jpg?wh=2069*2560\" alt=\"\"></p><h2><strong>开放讨论</strong></h2><p>其实，Kafka还有一种特别隐秘的消息丢失场景：增加主题分区。当增加主题分区后，在某段“不凑巧”的时间间隔后，Producer先于Consumer感知到新增加的分区，而Consumer设置的是“从最新位移处”开始读取消息，因此在Consumer感知到新分区前，Producer发送的这些消息就全部“丢失”了，或者说Consumer无法读取到这些消息。严格来说这是Kafka设计上的一个小缺陷，你有什么解决的办法吗？</p><p>欢迎写下你的思考和答案，我们一起讨论。如果你觉得有所收获，也欢迎把文章分享给你的朋友。</p><p></p>","neighbors":{"left":{"article_title":"10 | 生产者压缩算法面面观","id":102132},"right":{"article_title":"12 | 客户端都有哪些不常见但是很高级的功能？","id":103397}},"comments":[{"had_liked":false,"id":107619,"user_name":"阳明","can_delete":false,"product_type":"c1","uid":1052818,"ip_address":"","ucode":"BA0F5AF0E5A27A","user_header":"https://static001.geekbang.org/account/avatar/00/10/10/92/760f0964.jpg","comment_is_top":false,"comment_ctime":1561565588,"is_pvip":true,"replies":[{"id":"38933","content":"其实不冲突。如果ISR中只有1个副本了，acks=all也就相当于acks=1了，引入min.insync.replicas的目的就是为了做一个下限的限制：不能只满足于ISR全部写入，还要保证ISR中的写入个数不少于min.insync.replicas。","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1561596091,"ip_address":"","comment_id":107619,"utype":1}],"discussion_count":25,"race_medal":0,"score":"375223720340","product_id":100029201,"comment_content":"总结里的的第二条ack=all和第六条的说明是不是有冲突","like_count":88,"discussions":[{"author":{"id":1003253,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/4e/f5/abb7bfe3.jpg","nickname":"王志强","note":"","ucode":"40AEF8FD41C7A5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":373101,"discussion_content":"简单解释：replication.refactor是副本replica总数， min.insync.replicas是要求确保至少有多少个replica副本写入后才算是提交成功，这个参数是个硬指标；acks=all是个动态指标，确保当前能正常工作的replica副本都写入后才算是提交成功。举个例子：比如，此时副本总数3，即replication.refactor = 3，设置min.insync.replicas=2，acks=all，那如果所有副本都正常工作，消息要都写入三个副本，才算提交成功，此时这个min.insync.replicas=2下限值不起作用。如果其中一个副本因为某些原因挂了，此时acks=all的动态约束就是写入两个副本即可，触达了min.insync.replicas=2这个下限约束。如果三个副本挂了两个，此时ack=all的约束就变成了1个副本，但是因为有min.insync.replicas=2这个下限约束，写入就会不成功。","likes_number":68,"is_delete":false,"is_hidden":false,"ctime":1620614145,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1690729,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/WAb1u6cvzNK8HbarnCZVlUickibPicNbBS4D42dzKt7q6osgsiczy6nicS8ypqOUPrp7fSJich7iclDqceej74RJAYiaGg/132","nickname":"Geek_435016","note":"","ucode":"43929D4E7D8205","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":105908,"discussion_content":"可以看看kafka权威指南里的解释，生产者指定ack=all, 是要求同步副本（min.insync.replicas指定的就是最小同步副本个数），而不是分区的所有副本（replication.factor指定的是副本数目），都接收到消息，才算成功。建议老师在文章中增加对同步副本的讲解。","likes_number":27,"is_delete":false,"is_hidden":false,"ctime":1577498777,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":4,"child_discussions":[{"author":{"id":1486895,"avatar":"https://static001.geekbang.org/account/avatar/00/16/b0/2f/e2096905.jpg","nickname":"马成","note":"","ucode":"664F2BAA2E0F0B","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1690729,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/WAb1u6cvzNK8HbarnCZVlUickibPicNbBS4D42dzKt7q6osgsiczy6nicS8ypqOUPrp7fSJich7iclDqceej74RJAYiaGg/132","nickname":"Geek_435016","note":"","ucode":"43929D4E7D8205","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":243074,"discussion_content":"看完你的解释才理解为什么replication.factor>min.insync.replicas","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1587519057,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":105908,"ip_address":""},"score":243074,"extra":""},{"author":{"id":1759325,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/d8/5d/07dfb3b5.jpg","nickname":"杯莫停","note":"","ucode":"4FA1D5CBBEF702","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1486895,"avatar":"https://static001.geekbang.org/account/avatar/00/16/b0/2f/e2096905.jpg","nickname":"马成","note":"","ucode":"664F2BAA2E0F0B","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":302530,"discussion_content":"replication.factor>min.insync.replicas是因为如果等于的话只要有一个副本宕机，就永远无法达到ack=all的要求，从而永远无法callback success","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1598946266,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":243074,"ip_address":""},"score":302530,"extra":""},{"author":{"id":1339409,"avatar":"https://static001.geekbang.org/account/avatar/00/14/70/11/42cf8f9d.jpg","nickname":"chenjia","note":"","ucode":"61983C29FF4987","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1759325,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/d8/5d/07dfb3b5.jpg","nickname":"杯莫停","note":"","ucode":"4FA1D5CBBEF702","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":366675,"discussion_content":"对！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618149763,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":302530,"ip_address":""},"score":366675,"extra":""}]},{"author":{"id":1729855,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKeA6Awf2hRPJlRa4ZWo6fq3EQRlNowxjkJ48aicsHiapyCtgBy5e6t3DEiadMY92c46wwlrOibOcoNCw/132","nickname":"来焕明","note":"","ucode":"C9A71D22FAB7A4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":344165,"discussion_content":"acks\nThe number of acknowledgments the producer requires the leader to have received before considering a request complete. This controls the durability of records that are sent. The following settings are allowed:\n\nacks=0 If set to zero then the producer will not wait for any acknowledgment from the server at all. The record will be immediately added to the socket buffer and considered sent. No guarantee can be made that the server has received the record in this case, and the retries configuration will not take effect (as the client won&#39;t generally know of any failures). The offset given back for each record will always be set to -1.\nacks=1 This will mean the leader will write the record to its local log but will respond without awaiting full acknowledgement from all followers. In this case should the leader fail immediately after acknowledging the record but before the followers have replicated it then the record will be lost.\nacks=all This means the leader will wait for the full set of in-sync replicas to acknowledge the record. This guarantees that the record will not be lost as long as at least one in-sync replica remains alive. This is the strongest available guarantee. This is equivalent to the acks=-1 setting.\nType:\tstring\nDefault:\t1\nValid Values:\t[all, -1, 0, 1]\nImportance:\thigh\n\nacks = 0/1/all 是指 接收/落盘/ISR同步，三个步骤，而不是指副本数量，你不能设置acks = 5的。","likes_number":14,"is_delete":false,"is_hidden":false,"ctime":1611308358,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1339409,"avatar":"https://static001.geekbang.org/account/avatar/00/14/70/11/42cf8f9d.jpg","nickname":"chenjia","note":"","ucode":"61983C29FF4987","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1729855,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKeA6Awf2hRPJlRa4ZWo6fq3EQRlNowxjkJ48aicsHiapyCtgBy5e6t3DEiadMY92c46wwlrOibOcoNCw/132","nickname":"来焕明","note":"","ucode":"C9A71D22FAB7A4","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":366671,"discussion_content":"看看，这才是专业的","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1618148954,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":344165,"ip_address":""},"score":366671,"extra":""},{"author":{"id":2649276,"avatar":"https://static001.geekbang.org/account/avatar/00/28/6c/bc/f751786b.jpg","nickname":"Leo","note":"","ucode":"CEBAD9CDCFC2A3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1729855,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKeA6Awf2hRPJlRa4ZWo6fq3EQRlNowxjkJ48aicsHiapyCtgBy5e6t3DEiadMY92c46wwlrOibOcoNCw/132","nickname":"来焕明","note":"","ucode":"C9A71D22FAB7A4","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":390789,"discussion_content":"我也这么觉得，尤其 acks = all 指的应该是在ISR集内所有的副本全部写入成功才算成功，而不是所有的副本，这有个前提一定要是ISR集内的副本；","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630047325,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":344165,"ip_address":""},"score":390789,"extra":""}]},{"author":{"id":1260856,"avatar":"https://static001.geekbang.org/account/avatar/00/13/3d/38/d5d51797.jpg","nickname":"尚可为(Kewei Shang)","note":"","ucode":"19B6922A995959","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":21204,"discussion_content":"如果replication.refactor=3, min.insync.replicas=2, acks=all,那么在producer发送消息的时候，即使有一个broker挂了，也没有关系，只要消息提交到2个副本（包括leader），leader就回复producer消息提交ok了。如果两个follower brokers都挂了，leader就回复NOT_ENOUGH_REPLICAS异常。","likes_number":12,"is_delete":false,"is_hidden":false,"ctime":1569450717,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1103208,"avatar":"https://static001.geekbang.org/account/avatar/00/10/d5/68/2201b6b9.jpg","nickname":"归零","note":"","ucode":"C99B8E93009A46","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1260856,"avatar":"https://static001.geekbang.org/account/avatar/00/13/3d/38/d5d51797.jpg","nickname":"尚可为(Kewei Shang)","note":"","ucode":"19B6922A995959","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":333859,"discussion_content":"看了以后瞬间明白了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1607654497,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":21204,"ip_address":""},"score":333859,"extra":""}]},{"author":{"id":1054963,"avatar":"https://static001.geekbang.org/account/avatar/00/10/18/f3/cd07e64c.jpg","nickname":"lujg","note":"","ucode":"6CCCD89A29B06D","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":179748,"discussion_content":"官方文档中的解释：acks=all This means the leader will wait for the full set of in-sync replicas to acknowledge the record. This guarantees that the record will not be lost as long as at least one in-sync replica remains alive. This is the strongest available guarantee. This is equivalent to the acks=-1 setting.\nmin.insync.replicas: When a producer sets acks to &#34;all&#34; (or &#34;-1&#34;), this configuration specifies the minimum number of replicas that must acknowledge a write for the write to be considered successful. If this minimum cannot be met, then the producer will raise an exception (either NotEnoughReplicas or NotEnoughReplicasAfterAppend).\n也就是说对于两个同时配置的话，broker收到 min.insync.replicas-1 个follower的ack以后就认为满足了 acks=all的条件，就可以给producer回复ack消息了","likes_number":8,"is_delete":false,"is_hidden":false,"ctime":1582250233,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1361746,"avatar":"https://static001.geekbang.org/account/avatar/00/14/c7/52/c5adf218.jpg","nickname":"喜欢地球的阿培同学","note":"","ucode":"5F97037585F857","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1054963,"avatar":"https://static001.geekbang.org/account/avatar/00/10/18/f3/cd07e64c.jpg","nickname":"lujg","note":"","ucode":"6CCCD89A29B06D","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":267838,"discussion_content":"不对，如果ack=all，且ISR同步副本是10个，min.insync.replicas=5，那么broker还是需要同步给其他10个副本才会返回成功，这个min.insync.replicas=5代表的是，整个ISR同步副本至少要有5个，不然producer就会报错。","likes_number":23,"is_delete":false,"is_hidden":false,"ctime":1589698776,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":179748,"ip_address":""},"score":267838,"extra":""}]},{"author":{"id":1090470,"avatar":"https://static001.geekbang.org/account/avatar/00/10/a3/a6/cd893765.jpg","nickname":"christagger","note":"","ucode":"B65542DA54831E","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":66581,"discussion_content":"个人理解是ack=all是指ISR副本中的所有副本个数，而不是指replication.factor指定的副本个数，感觉只有这样理解才能说得通","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1575087496,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":4,"child_discussions":[{"author":{"id":1759325,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/d8/5d/07dfb3b5.jpg","nickname":"杯莫停","note":"","ucode":"4FA1D5CBBEF702","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1090470,"avatar":"https://static001.geekbang.org/account/avatar/00/10/a3/a6/cd893765.jpg","nickname":"christagger","note":"","ucode":"B65542DA54831E","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":302534,"discussion_content":"ISR只是去掉AR中那些落后太多剩下的，作为leader的候选人；ack=all 指的是min.insync.replicas要求满足指定个数的副本同步成功后才算消息commit成功，我觉得这两个概念完全没关系。","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1598946756,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":66581,"ip_address":""},"score":302534,"extra":""},{"author":{"id":1736462,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/7f/0e/e3a8dbd9.jpg","nickname":"Liujun","note":"","ucode":"3DB1F3CA57B5B3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1090470,"avatar":"https://static001.geekbang.org/account/avatar/00/10/a3/a6/cd893765.jpg","nickname":"christagger","note":"","ucode":"B65542DA54831E","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":389661,"discussion_content":"作为Kafka重度用户告诉你，你的理解是对的","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1629369696,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":66581,"ip_address":""},"score":389661,"extra":""},{"author":{"id":2649276,"avatar":"https://static001.geekbang.org/account/avatar/00/28/6c/bc/f751786b.jpg","nickname":"Leo","note":"","ucode":"CEBAD9CDCFC2A3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1090470,"avatar":"https://static001.geekbang.org/account/avatar/00/10/a3/a6/cd893765.jpg","nickname":"christagger","note":"","ucode":"B65542DA54831E","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":390791,"discussion_content":"没错，ack=all/-1指的是ISR集中的副本，而不是所有的副本；文章中表述的不清楚，这点不好；","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630047873,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":66581,"ip_address":""},"score":390791,"extra":""}]},{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":455589,"discussion_content":"其实不冲突。如果ISR中只有1个副本了，acks=all也就相当于acks=1了，引入min.insync.replicas的目的就是为了做一个下限的限制：不能只满足于ISR全部写入，还要保证ISR中的写入个数不少于min.insync.replicas。","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1561596091,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1008348,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/dc/8876c73b.jpg","nickname":"moooofly","note":"","ucode":"4A20795C281B6F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":198020,"discussion_content":"我觉得问题的关键是，&#34;acks=all&#34; 的主语是 leader ，而 &#34;min.insync.replicas&#34; 的主语是 producer","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1583462991,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1736462,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/7f/0e/e3a8dbd9.jpg","nickname":"Liujun","note":"","ucode":"3DB1F3CA57B5B3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1008348,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/dc/8876c73b.jpg","nickname":"moooofly","note":"","ucode":"4A20795C281B6F","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":389659,"discussion_content":"错","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629369563,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":198020,"ip_address":""},"score":389659,"extra":""}]},{"author":{"id":1493286,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoCl6Nxf9oW9sDOoibA7p8lKf0jqjPeDszqI4e7iavicQHtbtyibHIhLibyXYAaT02l7GRQvM9BJUxh6yQ/132","nickname":"昀溪","note":"","ucode":"BFAF31542BC24A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":20129,"discussion_content":"既然ISR全部写入了 那还去满足什么个数 不是挺矛盾么 请老师讲清楚一些 有点不明白","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1569282201,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1398177,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/980yvj8VpgQPndXvibiaomic6JWWyqu12lmOnnIsdtXgukNiaY14dxV9zic9RcibkvMcLPr9WuCYic8EJAhCmDRlNk3ibg/132","nickname":"我只是个孩子","note":"","ucode":"216FE41B898AAE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1493286,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoCl6Nxf9oW9sDOoibA7p8lKf0jqjPeDszqI4e7iavicQHtbtyibHIhLibyXYAaT02l7GRQvM9BJUxh6yQ/132","nickname":"昀溪","note":"","ucode":"BFAF31542BC24A","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":36532,"discussion_content":"acks=all是确认一个分区的所有副本都收到消息，min.insync.replicas是保证副本的数量下限","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1571390002,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":20129,"ip_address":""},"score":36532,"extra":""},{"author":{"id":1759325,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/d8/5d/07dfb3b5.jpg","nickname":"杯莫停","note":"","ucode":"4FA1D5CBBEF702","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1493286,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoCl6Nxf9oW9sDOoibA7p8lKf0jqjPeDszqI4e7iavicQHtbtyibHIhLibyXYAaT02l7GRQvM9BJUxh6yQ/132","nickname":"昀溪","note":"","ucode":"BFAF31542BC24A","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":302540,"discussion_content":"follower从leader拉取数据是主动的，也就是说只要满足min.insync.replicas要求的副本个数同步成功，就可以回复producer这条消息发送成功了，而你follower没拉取完的继续拉取并不影响这个过程。","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1598947699,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":20129,"ip_address":""},"score":302540,"extra":""}]},{"author":{"id":1579066,"avatar":"https://static001.geekbang.org/account/avatar/00/18/18/3a/b407889c.jpg","nickname":"Geek_817ea4","note":"","ucode":"D1194D33C4DC11","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":905,"discussion_content":"我觉得必须配合request.required.acks=-1/all使用，不然这个参数不生效，变得毫无意义","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562145901,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":110789,"user_name":"ヾ(◍°∇°◍)ﾉﾞ","can_delete":false,"product_type":"c1","uid":1044175,"ip_address":"","ucode":"89545632BDA56E","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJOBwR7MCVqwZbPA5RQ2mjUjd571jUXUcBCE7lY5vSMibWn8D5S4PzDZMaAhRPdnRBqYbVOBTJibhJg/132","comment_is_top":false,"comment_ctime":1562335456,"is_pvip":false,"discussion_count":9,"race_medal":0,"score":"229195602144","product_id":100029201,"comment_content":"新建分区丢失是因为没有offset就从lastest开始读取，可以改成没有offset的时候从ealiest读取应该就可以了","like_count":53,"discussions":[{"author":{"id":2059131,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/6b/7b/727c1741.jpg","nickname":"陈强","note":"","ucode":"EF836A811D844A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":370915,"discussion_content":"那当消费者感知到新的分区存在后，如何知道当前分区是新建的分区，还是原来宕机再恢复过来的分区呢？如果设置为ealiest那么对于宕机恢复过来的分区来说，就会重复消费大量消息","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1619579549,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1054827,"avatar":"https://static001.geekbang.org/account/avatar/00/10/18/6b/a1448af1.jpg","nickname":"贝影","note":"","ucode":"19545C8DCBF8A2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2059131,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/6b/7b/727c1741.jpg","nickname":"陈强","note":"","ucode":"EF836A811D844A","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":543943,"discussion_content":"对，所以最灵活的地方也是最麻烦的地方，我把从哪里消费放在配置中，每次改完配置还要改回去，就怕服务宕机了从错误的地方开始读","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1641365506,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":370915,"ip_address":""},"score":543943,"extra":""},{"author":{"id":2223167,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/mQddXC7nRiaKHTwdficicTB3bH0q5ic5UoSab51Omic7eyLBz0SNcvbLpQnNib7zP1yJFm7xxx4ia81iahfibRVnbTwHmhw/132","nickname":"浮石沉木","note":"","ucode":"D585768321B84A","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":2059131,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/6b/7b/727c1741.jpg","nickname":"陈强","note":"","ucode":"EF836A811D844A","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":574997,"discussion_content":"重点在于提交的位移记录保存在哪有无持久化，如果位移量没丢，用earlist也不会导致重复消费啊","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1654515067,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":370915,"ip_address":""},"score":574997,"extra":""}]},{"author":{"id":1415619,"avatar":"https://static001.geekbang.org/account/avatar/00/15/99/c3/e4f408d4.jpg","nickname":"陌兮","note":"","ucode":"00CE47CAECD5CD","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":363123,"discussion_content":"mark","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1617113944,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2817448,"avatar":"","nickname":"Geek_f3ab76","note":"","ucode":"7720A9A91E1CF0","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":579071,"discussion_content":"但是要消息消费的幂等性","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1657164094,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1813614,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/ac/6e/c13d131c.jpg","nickname":"她微笑的脸y","note":"","ucode":"E3B559B10B4A70","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":573617,"discussion_content":"这个是consumer设置的吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1653550347,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2860851,"avatar":"","nickname":"Geek_e78fa5","note":"","ucode":"713677ED3B5745","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539484,"discussion_content":"马克","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639727933,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1997465,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/7a/99/4ac1d891.jpg","nickname":"猴子胖胖","note":"","ucode":"EFFE195C126E00","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":383128,"discussion_content":"mark","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625916399,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1134861,"avatar":"https://static001.geekbang.org/account/avatar/00/11/51/0d/fc1652fe.jpg","nickname":"James","note":"","ucode":"48B0F2A334D1C1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":49426,"discussion_content":"马克","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573578352,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":108680,"user_name":"曹伟雄","can_delete":false,"product_type":"c1","uid":1400754,"ip_address":"","ucode":"9740E426C0742C","user_header":"https://static001.geekbang.org/account/avatar/00/15/5f/b2/c4780c10.jpg","comment_is_top":false,"comment_ctime":1561853984,"is_pvip":false,"replies":[{"id":"39435","content":"写过一两篇，https:&#47;&#47;www.cnblogs.com&#47;huxi2b&#47;p&#47;7089854.html，<br><br>但总觉得不太完美。如果你想深入了解的话，推荐读一下Flink Kafka Connector的源码","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1561946475,"ip_address":"","comment_id":108680,"utype":1}],"discussion_count":2,"race_medal":0,"score":"113231003680","product_id":100029201,"comment_content":"单个 Consumer 程序使用多线程来消费消息说起来容易，写成代码却异常困难，因为你很难正确地处理位移的更新，也就是说避免无消费消息丢失很简单，但极易出现消息被消费了多次的情况。<br>关于这个问题，老师能否提供个java代码的最佳实践?  谢谢!","like_count":26,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":456077,"discussion_content":"写过一两篇，https://www.cnblogs.com/huxi2b/p/7089854.html，\n\n但总觉得不太完美。如果你想深入了解的话，推荐读一下Flink Kafka Connector的源码","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561946475,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1048314,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/fe/fa/2a046821.jpg","nickname":"人间四月天","note":"","ucode":"11BE219C23EEBC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":405286,"discussion_content":"看了下博客里面的胡老师说的问题，是不是可以采用hdfs里面的写edit log的设计思路，把offset做成顺序提交，唯一要考虑的风险就是当中间某个线程提交失败的时候，其他线程会产生空转的消耗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634549120,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":170141,"user_name":"陈国林","can_delete":false,"product_type":"c1","uid":1438037,"ip_address":"","ucode":"83D12F3E79F197","user_header":"https://static001.geekbang.org/account/avatar/00/15/f1/55/8ac4f169.jpg","comment_is_top":false,"comment_ctime":1578537638,"is_pvip":false,"replies":[{"id":"66077","content":"不生效，min.insync.replicas只有在acks=-1时才生效","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1578619212,"ip_address":"","comment_id":170141,"utype":1}],"discussion_count":3,"race_medal":0,"score":"100362785446","product_id":100029201,"comment_content":"老师好，请教一个问题，ack=1的时候，min.insync.replicas还会生效吗？或者说还有必要吗，感谢 🤝","like_count":23,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":480856,"discussion_content":"不生效，min.insync.replicas只有在acks=-1时才生效","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1578619212,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2109853,"avatar":"","nickname":"beifengzhishen001","note":"","ucode":"77D42B7DD9E754","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":362685,"discussion_content":"好问题，我也有这个疑问，如果主需要主副本写入成功，确实没必要再在意有多少个从副本写入成功了","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1617010406,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2275396,"avatar":"","nickname":"13549804879","note":"","ucode":"303DFF7082E504","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":373074,"discussion_content":"如果主需要主副本写入成功 --- 万一该broker 炸了。怎么办","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620608149,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":107638,"user_name":"cricket1981","can_delete":false,"product_type":"c1","uid":1001715,"ip_address":"","ucode":"758262F5958DA4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/48/f3/f1034ffd.jpg","comment_is_top":false,"comment_ctime":1561589675,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"96050870187","product_id":100029201,"comment_content":"consumer改用&quot;从最早位置&quot;读解决新加分区造成的问题","like_count":22,"discussions":[{"author":{"id":1736462,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/7f/0e/e3a8dbd9.jpg","nickname":"Liujun","note":"","ucode":"3DB1F3CA57B5B3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":389663,"discussion_content":"某些时候会出现严重的重复消费，实际情况几乎都会从最新位置开始消费，老师说的那种情况，属于扯淡情况","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629369846,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1054827,"avatar":"https://static001.geekbang.org/account/avatar/00/10/18/6b/a1448af1.jpg","nickname":"贝影","note":"","ucode":"19545C8DCBF8A2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1736462,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/7f/0e/e3a8dbd9.jpg","nickname":"Liujun","note":"","ucode":"3DB1F3CA57B5B3","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":543945,"discussion_content":"不好说，某些指标需要通过kafka的消息来算，如果丢了那指标就不准了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641365641,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":389663,"ip_address":""},"score":543945,"extra":""}]}]},{"had_liked":false,"id":107806,"user_name":"lmtoo","can_delete":false,"product_type":"c1","uid":1133918,"ip_address":"","ucode":"FCD5B9C941D448","user_header":"https://static001.geekbang.org/account/avatar/00/11/4d/5e/c5c62933.jpg","comment_is_top":false,"comment_ctime":1561613512,"is_pvip":false,"replies":[{"id":"39132","content":"如果你配置了auto.offset.reset=latest就会这样的<br>","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1561680865,"ip_address":"","comment_id":107806,"utype":1}],"discussion_count":2,"race_medal":0,"score":"83165992136","product_id":100029201,"comment_content":"最后一个问题，难道新增分区之后，producer先感知并发送数据，消费者后感知，消费者的offset会定位到新分区的最后一条消息？消费者没有提交offset怎么会从最后一条开始的呢？","like_count":19,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":455681,"discussion_content":"如果你配置了auto.offset.reset=latest就会这样的\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561680865,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2860851,"avatar":"","nickname":"Geek_e78fa5","note":"","ucode":"713677ED3B5745","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539485,"discussion_content":"马克","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639728153,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":120373,"user_name":"ban","can_delete":false,"product_type":"c1","uid":1034204,"ip_address":"","ucode":"E523CE97E48266","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c7/dc/9408c8c2.jpg","comment_is_top":false,"comment_ctime":1564847344,"is_pvip":false,"replies":[{"id":"44246","content":"min.insync.replicas是保证下限的。acks=all的含义是producer会等ISR中所有副本都写入成功才返回，但如果不设置min.insync.replicas = 5，默认是1，那么假设ISR中只有1个副本，只要写入这个副本成功producer也算其正常写入，因此min.insync.replicas保证的写入副本的下限。","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1564965888,"ip_address":"","comment_id":120373,"utype":1}],"discussion_count":7,"race_medal":0,"score":"74579291376","product_id":100029201,"comment_content":"老师，<br>如果我有10个副本，isr=10，然后我配置ack=all，min.insync.replicas=5，<br>这时候这两个参数以谁为准，生产一个消息，必须是全部副本都同步才算提交，还是只要5个副本才算提交？","like_count":17,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":461304,"discussion_content":"min.insync.replicas是保证下限的。acks=all的含义是producer会等ISR中所有副本都写入成功才返回，但如果不设置min.insync.replicas = 5，默认是1，那么假设ISR中只有1个副本，只要写入这个副本成功producer也算其正常写入，因此min.insync.replicas保证的写入副本的下限。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564965888,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1361746,"avatar":"https://static001.geekbang.org/account/avatar/00/14/c7/52/c5adf218.jpg","nickname":"喜欢地球的阿培同学","note":"","ucode":"5F97037585F857","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":267835,"discussion_content":"这个问题的答案应该是 必须是全部副本都同步才算提交且ISR副本数最少要有5个","likes_number":9,"is_delete":false,"is_hidden":false,"ctime":1589698503,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2109853,"avatar":"","nickname":"beifengzhishen001","note":"","ucode":"77D42B7DD9E754","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":362686,"discussion_content":"按照&amp;&amp;操作来看待这两个参数，都需要满足","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617010485,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1270262,"avatar":"https://static001.geekbang.org/account/avatar/00/13/61/f6/1d6b548a.jpg","nickname":"wang","note":"","ucode":"C1A3BCACCB188E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":258132,"discussion_content":"所以min.insync.replicas 在ack=all 的情况下， 其实作用不大，主要还是取决于isr 的参数值，是这样的莫？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588651146,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":3,"child_discussions":[{"author":{"id":1134861,"avatar":"https://static001.geekbang.org/account/avatar/00/11/51/0d/fc1652fe.jpg","nickname":"James","note":"","ucode":"48B0F2A334D1C1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1270262,"avatar":"https://static001.geekbang.org/account/avatar/00/13/61/f6/1d6b548a.jpg","nickname":"wang","note":"","ucode":"C1A3BCACCB188E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":265436,"discussion_content":"说反了吧.不设置下限的话,ack=all好像没什么用","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589386318,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":258132,"ip_address":""},"score":265436,"extra":""},{"author":{"id":1762252,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/e3/cc/0947ff0b.jpg","nickname":"nestle","note":"","ucode":"469800BED81B54","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1270262,"avatar":"https://static001.geekbang.org/account/avatar/00/13/61/f6/1d6b548a.jpg","nickname":"wang","note":"","ucode":"C1A3BCACCB188E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":301448,"discussion_content":"不是吧，isr是动态变化的，isr配置的10也有可能变成1的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598529770,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":258132,"ip_address":""},"score":301448,"extra":""},{"author":{"id":1603004,"avatar":"https://static001.geekbang.org/account/avatar/00/18/75/bc/e24e181e.jpg","nickname":"Calvin","note":"","ucode":"0EEF5B207623B5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1270262,"avatar":"https://static001.geekbang.org/account/avatar/00/13/61/f6/1d6b548a.jpg","nickname":"wang","note":"","ucode":"C1A3BCACCB188E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":348074,"discussion_content":"我理解应该是这样，默认全部的 10 个副本都正常时，要 10 个，但是如果其中有部分不正常，至少需要保证有 5 个，才能认为是提交成功。","likes_number":8,"is_delete":false,"is_hidden":false,"ctime":1612422370,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":258132,"ip_address":""},"score":348074,"extra":""}]}]},{"had_liked":false,"id":153671,"user_name":"redis","can_delete":false,"product_type":"c1","uid":1066278,"ip_address":"","ucode":"91C54605384F51","user_header":"https://static001.geekbang.org/account/avatar/00/10/45/26/f54c9888.jpg","comment_is_top":false,"comment_ctime":1574295929,"is_pvip":false,"replies":[{"id":"59161","content":"其实，有可能在落盘之前就被消费了。能否被消费不是看是否flush到磁盘，而是看leader副本的高水位是否越过了该条消息","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1574383833,"ip_address":"","comment_id":153671,"utype":1}],"discussion_count":6,"race_medal":0,"score":"61703838073","product_id":100029201,"comment_content":"你好胡老师，想问一下 kafka是在落地刷盘之后，同步副本成功后，才能会被消费吗？","like_count":14,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":475243,"discussion_content":"其实，有可能在落盘之前就被消费了。能否被消费不是看是否flush到磁盘，而是看leader副本的高水位是否越过了该条消息","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574383833,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1066278,"avatar":"https://static001.geekbang.org/account/avatar/00/10/45/26/f54c9888.jpg","nickname":"redis","note":"","ucode":"91C54605384F51","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":55571,"discussion_content":"那如果此时刷盘失败，消息消费了，数据丢失了？这种情况kafka有容错吗？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1574384787,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1762252,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/e3/cc/0947ff0b.jpg","nickname":"nestle","note":"","ucode":"469800BED81B54","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1066278,"avatar":"https://static001.geekbang.org/account/avatar/00/10/45/26/f54c9888.jpg","nickname":"redis","note":"","ucode":"91C54605384F51","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":301447,"discussion_content":"靠副本吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598529610,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":55571,"ip_address":""},"score":301447,"extra":""},{"author":{"id":1116807,"avatar":"https://static001.geekbang.org/account/avatar/00/11/0a/87/56b07589.jpg","nickname":"nearzk","note":"","ucode":"CDEA6841E5F54C","race_medal":1,"user_type":1,"is_pvip":false},"reply_author":{"id":1066278,"avatar":"https://static001.geekbang.org/account/avatar/00/10/45/26/f54c9888.jpg","nickname":"redis","note":"","ucode":"91C54605384F51","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":355020,"discussion_content":"参考KIP-101 ：https://cwiki.apache.org/confluence/display/KAFKA/KIP-101+-+Alter+Replication+Protocol+to+use+Leader+Epoch+rather+than+High+Watermark+for+Truncation#KIP101AlterReplicationProtocoltouseLeaderEpochratherthanHighWatermarkforTruncation-LeaderEpoch","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1615375666,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":55571,"ip_address":""},"score":355020,"extra":""}]},{"author":{"id":2860851,"avatar":"","nickname":"Geek_e78fa5","note":"","ucode":"713677ED3B5745","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539486,"discussion_content":"马克","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639728251,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1051563,"avatar":"https://static001.geekbang.org/account/avatar/00/10/0b/ab/0e2857e5.jpg","nickname":"Coding小先","note":"","ucode":"965B1CC757E026","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":329007,"discussion_content":"HW 高水位决定的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606296614,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":107856,"user_name":"永光","can_delete":false,"product_type":"c1","uid":1102702,"ip_address":"","ucode":"0C54531ABED1B0","user_header":"https://static001.geekbang.org/account/avatar/00/10/d3/6e/281b85aa.jpg","comment_is_top":false,"comment_ctime":1561623884,"is_pvip":false,"replies":[{"id":"39128","content":"acks=all表示消息要写入所有ISR副本，但没要求ISR副本有多少个。min.insync.replicas做了这样的保证","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1561680670,"ip_address":"","comment_id":107856,"utype":1}],"discussion_count":6,"race_medal":0,"score":"57396198732","product_id":100029201,"comment_content":"看了评论区回答还是不太理解，第二条ack=all与第六条min.insync.replicas 怎样协调工作的，总感觉是有冲突的。<br>问题是：<br>第二条的“已提交”和第六条的“已提交”是同一个意思吗？如果是同一个意思，那定义为什么不一样呀？<br><br>","like_count":13,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":455708,"discussion_content":"acks=all表示消息要写入所有ISR副本，但没要求ISR副本有多少个。min.insync.replicas做了这样的保证","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561680670,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1445399,"avatar":"https://static001.geekbang.org/account/avatar/00/16/0e/17/e16e679f.jpg","nickname":"guoyinbo2019","note":"","ucode":"19D86CB3E42839","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":528,"discussion_content":"同问，个人理解：感觉ack=all 的含义是动态的，当副本数=3时，ack=all则需要3个副本同步后才算“已提交”，当有一个副本挂机时候，此时ack=all则需要2个副本同步后就认为“已提交”。而min.insync.replicas含义是不变的，一旦指定min.insync.replicas=1，则无论什么情况下，都需要保证ISR中至少1个副本同步后，才算“已提交”。纯属个人理解，还请胡老师指正。","likes_number":12,"is_delete":false,"is_hidden":false,"ctime":1561641927,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1579066,"avatar":"https://static001.geekbang.org/account/avatar/00/18/18/3a/b407889c.jpg","nickname":"Geek_817ea4","note":"","ucode":"D1194D33C4DC11","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":913,"discussion_content":"ack=all，是要写入isr中全部副本，而min.insync.replicas是isr中必须存在多少个副本，只有ack=all时候，min.insync.replicas才起作用，不然ack=1时候，就相当于min.insync.replicas=1。列如我设置10个副本，但是我isr只有5个，ack=all就是5个要全部写入，而不是10个，min.insync.replicas设置8，但是我isr只有5个，就会报错","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1562147448,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1025067,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a4/2b/3ba9f64b.jpg","nickname":"Devin","note":"","ucode":"7BDCD517BD8DD2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":4483,"discussion_content":"不知道理解的对不对，确保 acks=all （1） 和 replication.factor > min.insync.replicas  （2） 的目的是同一个，但 2 是“最保险手段”，1和2不能说是“冲突”，应该说配置了2，1不配置也可以达到目的。但1和2都配置又不会累死，万一以后改配置了呢，都配置也算是个“双重保险”吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565456031,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1130590,"avatar":"https://static001.geekbang.org/account/avatar/00/11/40/5e/b8fada94.jpg","nickname":"Ryoma","note":"","ucode":"7F692369239692","race_medal":2,"user_type":1,"is_pvip":true},"reply_author":{"id":1025067,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a4/2b/3ba9f64b.jpg","nickname":"Devin","note":"","ucode":"7BDCD517BD8DD2","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":170171,"discussion_content":"这两个配置是搭配使用，比如说有5个副本，replication.factor 配置为 4。在未配置 acks 的前提下，写入 4 个副本即可；但如果配置了 all，即 5 个副本都要提交完成。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581673524,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":4483,"ip_address":""},"score":170171,"extra":""}]},{"author":{"id":1273993,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/wonzX0yIia5NFoB0TZPdIPqVicIuSvzMtowownIkO9VwYpkPWJP2tpEcv5RXMn0ayuEGkAp2GBualL5sFQs0ibQJQ/132","nickname":"gogogo","note":"","ucode":"D7B7A9AA2D4CE5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1024,"discussion_content":"all的语义是要求所有当前存活的副本broker已提交","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562245069,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":154984,"user_name":"美美","can_delete":false,"product_type":"c1","uid":1148422,"ip_address":"","ucode":"44CC95C45AF345","user_header":"https://static001.geekbang.org/account/avatar/00/11/86/06/72b01bb7.jpg","comment_is_top":false,"comment_ctime":1574608978,"is_pvip":false,"replies":[{"id":"59505","content":"使用幂等producer","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1574644219,"ip_address":"","comment_id":154984,"utype":1}],"discussion_count":6,"race_medal":0,"score":"48819249234","product_id":100029201,"comment_content":"胡老师 还有一种消息重复的情况希望帮忙分析下。producer发送消息后，broker成功写入消息了，但是ack因为网络问题没有到达producer，生产者可能会重试发送这条消息。<br>这种问题如何避免重复消费呢","like_count":11,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":475629,"discussion_content":"使用幂等producer","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574644219,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1054827,"avatar":"https://static001.geekbang.org/account/avatar/00/10/18/6b/a1448af1.jpg","nickname":"贝影","note":"","ucode":"19545C8DCBF8A2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":543946,"discussion_content":"幂等producer是自己写幂等逻辑吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641365797,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":475629,"ip_address":""},"score":543946,"extra":""}]},{"author":{"id":1116807,"avatar":"https://static001.geekbang.org/account/avatar/00/11/0a/87/56b07589.jpg","nickname":"nearzk","note":"","ucode":"CDEA6841E5F54C","race_medal":1,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":354997,"discussion_content":"幂等，就是对同一条消息，无论producer发送多少次，都是一样的效果。一旦写入一次，第N次重复写入，都不会在broker产生新的message","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1615374124,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1158349,"avatar":"https://static001.geekbang.org/account/avatar/00/11/ac/cd/fda6374f.jpg","nickname":"Louis","note":"","ucode":"BC667839F17937","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":540443,"discussion_content":"应该是幂等consumer吧？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640057863,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1316926,"avatar":"https://static001.geekbang.org/account/avatar/00/14/18/3e/f8632713.jpg","nickname":"EveryDayIsNew","note":"","ucode":"776B81EF6830FA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":341657,"discussion_content":"生产者所在机器重启了呢，一般发送，生产者是要保证一定发成功的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1610497934,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1116807,"avatar":"https://static001.geekbang.org/account/avatar/00/11/0a/87/56b07589.jpg","nickname":"nearzk","note":"","ucode":"CDEA6841E5F54C","race_medal":1,"user_type":1,"is_pvip":false},"reply_author":{"id":1316926,"avatar":"https://static001.geekbang.org/account/avatar/00/14/18/3e/f8632713.jpg","nickname":"EveryDayIsNew","note":"","ucode":"776B81EF6830FA","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":355000,"discussion_content":"kafka有限度的保证消息持久化成功，限度之一就是必须是已提交的消息","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1615374224,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":341657,"ip_address":""},"score":355000,"extra":""}]}]},{"had_liked":false,"id":110162,"user_name":"Andy","can_delete":false,"product_type":"c1","uid":1515145,"ip_address":"","ucode":"0EF2D58B46D7C3","user_header":"https://static001.geekbang.org/account/avatar/00/17/1e/89/25b12054.jpg","comment_is_top":false,"comment_ctime":1562202911,"is_pvip":false,"replies":[{"id":"39925","content":"In-Sync Replicas，这是一个副本集合，里面的所有副本都是和Leader副本保持同步的","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1562203636,"ip_address":"","comment_id":110162,"utype":1}],"discussion_count":2,"race_medal":0,"score":"44511875871","product_id":100029201,"comment_content":"留言中ISR是什么？","like_count":10,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":456753,"discussion_content":"In-Sync Replicas，这是一个副本集合，里面的所有副本都是和Leader副本保持同步的","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1562203636,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1339409,"avatar":"https://static001.geekbang.org/account/avatar/00/14/70/11/42cf8f9d.jpg","nickname":"chenjia","note":"","ucode":"61983C29FF4987","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":366684,"discussion_content":"我也是看的一脸懵逼，不知道大家在说什么，感觉自己与大家丢失了消息同步。。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1618150418,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":146703,"user_name":"浪迹人生","can_delete":false,"product_type":"c1","uid":1058409,"ip_address":"","ucode":"5BA475C8687503","user_header":"https://static001.geekbang.org/account/avatar/00/10/26/69/51d5e6bd.jpg","comment_is_top":false,"comment_ctime":1572612225,"is_pvip":false,"replies":[{"id":"56781","content":"在生产者服务器上生成的。个人感觉不可以，毕竟每个producer服务器上的时钟不是实时同步的。事实上，用时钟来保证同步性是一件非常不靠谱的事情","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1572769359,"ip_address":"","comment_id":146703,"utype":1}],"discussion_count":3,"race_medal":0,"score":"40227317889","product_id":100029201,"comment_content":"请问消息的createTimestamp 是在生产者服务器上生成的，还是在进入不同partition 后生成的？我能不能根据这个时间戳来判断不同分区的消息原始全局顺序？谢谢🙏","like_count":9,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":472985,"discussion_content":"在生产者服务器上生成的。个人感觉不可以，毕竟每个producer服务器上的时钟不是实时同步的。事实上，用时钟来保证同步性是一件非常不靠谱的事情","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572769359,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2860851,"avatar":"","nickname":"Geek_e78fa5","note":"","ucode":"713677ED3B5745","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539487,"discussion_content":"马克","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639728286,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1032345,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/c0/99/259a412f.jpg","nickname":"Geeker","note":"","ucode":"9937127DE96D78","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":386279,"discussion_content":"如果生产者服务器只有一个那或许可以，但一般现在都是多实例部署，而且也可能存在多个不同的应用充当生产者的情况。\n这么理解没错吧？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627492932,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":237759,"user_name":"多襄丸","can_delete":false,"product_type":"c1","uid":1074310,"ip_address":"","ucode":"1AA1497C5A293C","user_header":"https://static001.geekbang.org/account/avatar/00/10/64/86/f5a9403a.jpg","comment_is_top":false,"comment_ctime":1595944554,"is_pvip":false,"replies":[{"id":"87881","content":"我觉得是很好的办法。值得一试：）","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1596005173,"ip_address":"","comment_id":237759,"utype":1}],"discussion_count":3,"race_medal":0,"score":"35955682922","product_id":100029201,"comment_content":"老师，我针对您的提问思考并查阅了一下相关资料，说一下我的思考哈：<br><br>我们假设有且仅有一个producer只在这个consumer感知到之前，新的partition分区只写了那么几条记录，不会再有其他producer写数据到这个新的partition中。<br><br>新增partition的情况，rebalance时由于我们默认offset.auto.reset=lastest，因此在使用了这个默认配置之下，producer较consumer先感知到新的partition将数据发送到新的partition，而consumer之后才感知到这个consumer，此时由于这个新的partition的offset是第一次消费，没有已提交的offset，所以使用latest从最新的位移开始读取，也就是producer写入消息offset + 1的那个位置开始读取，因此也就读取不到数据。<br><br>latest：有提交位移就从提交位移开始处理，没有提交位移就从最新的位移开始处理。<br><br>earlist: 有提交位移就从提交位移开始处理，没有提交位移就从最早的位移开始处理。<br><br>current: 从当前的提交位移开始处理。<br><br>因此，碰到上述情况，我们可以使用seekToBegin从这个新分区的开始位置读即可。<br><br>我能想到的办法是，实现一个ConsumerRebalanceListener，重写onPartitionsAssigned方法，在这个方法里我们每次都从自己维护的数据库系统里取offset，能取到说明这个partition是之前就存在的，按已有的offset继续消费就可以了，没有取到的记录表示是新增的partition，那么就从0开始消费并且保存当前offset到数据库。不论是不是新的，都可以seek到指定的位置，只是我们有没有维护到这个partition的offset记录的区别。也就不用针对这个新分区指定offset.auto.rset=earlist了吧？<br><br>希望得到胡老师的交流哈~","like_count":8,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":502528,"discussion_content":"我觉得是很好的办法。值得一试：）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596005173,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1702117,"avatar":"https://static001.geekbang.org/account/avatar/00/19/f8/e5/119d5c15.jpg","nickname":"山海","note":"","ucode":"77FA9967E58FA3","race_medal":1,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":346621,"discussion_content":"本质上感觉这个和对指定分区设置offset.auto.reset=earlist 没有区别， 我们假设设置offset.auto.rset=latest是为了避免消费之前kafka已有的数据。 但是当消费者第一次启动的时候，去查询数据库，发现没有offset， 然后从0开始，变相的就等于实现了offset.auto.reset=earlist 。 这样不如直接设置offset.auto.reset=earlist 更加简单直接, 亦或者设置offset从某个时间戳进行消费， 将时间戳设置成启动时。 ","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1612008166,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1054827,"avatar":"https://static001.geekbang.org/account/avatar/00/10/18/6b/a1448af1.jpg","nickname":"贝影","note":"","ucode":"19545C8DCBF8A2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":543947,"discussion_content":"其实不止是这rebalence这种情况，很多场景我都考虑过要不要记录offset。如果要记录offset说明每次提交offset之前就要记录一次，这就是涉及到可能需要两阶段提交了。另外就是高峰期时，记录offset绝对是无形中又拖慢了当前这批数据的处理速度的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641366306,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":182050,"user_name":"毛毛鸦","can_delete":false,"product_type":"c1","uid":1633938,"ip_address":"","ucode":"DDC7AD57882A3F","user_header":"https://static001.geekbang.org/account/avatar/00/18/ee/92/18884647.jpg","comment_is_top":false,"comment_ctime":1582700121,"is_pvip":false,"replies":[{"id":"70487","content":"没有说不可以相等。如果都是2，挂掉一个副本，producer也就无法写入了，因为不满足min.insync.replicas的要求了","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1582707556,"ip_address":"","comment_id":182050,"utype":1}],"discussion_count":2,"race_medal":0,"score":"31647471193","product_id":100029201,"comment_content":"老师好，第七条没太理解啊， replication.factor 和 min.insync.replicas为什么不能相等呢，假如都是2，不可以吗，挂掉一个副本还有一个副本可用啊。","like_count":7,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":485208,"discussion_content":"没有说不可以相等。如果都是2，挂掉一个副本，producer也就无法写入了，因为不满足min.insync.replicas的要求了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582707556,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1126482,"avatar":"https://static001.geekbang.org/account/avatar/00/11/30/52/7880dcf0.jpg","nickname":"阿毅","note":"","ucode":"5B006F905A1FDE","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":337530,"discussion_content":"看到大佬的这条评论，才懂了replication.factor 和 min.insync.replicas为什么不能相等呢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608964096,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":134844,"user_name":"云师兄","can_delete":false,"product_type":"c1","uid":1010459,"ip_address":"","ucode":"4475AF1598FBFD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/6b/1b/4b397b80.jpg","comment_is_top":false,"comment_ctime":1568942140,"is_pvip":false,"replies":[{"id":"51729","content":"嗯，是的。当然如果一直不成功，最终producer请求会超时","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1568943799,"ip_address":"","comment_id":134844,"utype":1}],"discussion_count":1,"race_medal":0,"score":"31633713212","product_id":100029201,"comment_content":"acks=all表示消息要写入所有ISR副本，但没要求ISR副本有多少个。min.insync.replicas做了这样的保证<br><br>如果min.insync.replicas的参数设置比实际的isr副本多，producer的消息必须阻塞等broker的isr数量达到min.insync.replicas才提交成功吗","like_count":7,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":467921,"discussion_content":"嗯，是的。当然如果一直不成功，最终producer请求会超时","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1568943799,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":108337,"user_name":"快跑","can_delete":false,"product_type":"c1","uid":1564645,"ip_address":"","ucode":"90ED7E6D40C58E","user_header":"https://static001.geekbang.org/account/avatar/00/17/df/e5/65e37812.jpg","comment_is_top":false,"comment_ctime":1561722432,"is_pvip":false,"replies":[{"id":"39448","content":"1. 不是。如果配置了retries，即使调用send(msg)也是会重试的。这是Kafka producer自己实现的机制，不需要用户干预<br>2. Broker发送response给producer，里面会保存error信息以及那个(些)batch出错了","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1561947553,"ip_address":"","comment_id":108337,"utype":1}],"discussion_count":5,"race_medal":0,"score":"31626493504","product_id":100029201,"comment_content":"老师，你好。仔细阅读文稿后，仍有一些困惑<br>1、如果只用 send()方法（fire and forget），  即使配置retries，producer也是不知道消息状态，是不会重试的。所以说配置retries，要搭配send(msg, callback)，这么理解正确么？<br>2、配置了retries,   producer是怎么知道哪条消息发送失败了，然后重试","like_count":7,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":455922,"discussion_content":"1. 不是。如果配置了retries，即使调用send(msg)也是会重试的。这是Kafka producer自己实现的机制，不需要用户干预\n2. Broker发送response给producer，里面会保存error信息以及那个(些)batch出错了","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1561947553,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1282575,"avatar":"https://static001.geekbang.org/account/avatar/00/13/92/0f/cff30522.jpg","nickname":"江湖夜雨","note":"","ucode":"C64913C7000899","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":67548,"discussion_content":"配置了retries,岂不是消息会有重复？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1575131491,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2037282,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erpYAcOqrNNxmMuKsd6Dh69BzxiaXjJRh6IMnQlxOqBFiae1EMic32Wv6aFESWytliaL7uniaZ4DgNUwxg/132","nickname":"黄序","note":"","ucode":"C8C2749E2DE72B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":394125,"discussion_content":"这里的逻辑应该是，如果不使用callback，broker处理失败后会将error信息以及batch信息给到producer，producer也是执行retries，但是最终结果不可控。如果增加了callback则可以在业务侧进行一定的兜底方案，比如说broker不可用，则可以将数据在本地进行处理。或者多次重试失败，也进行本地处理等","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631753934,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1011062,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/6d/76/a80ca784.jpg","nickname":"wushuang5112","note":"","ucode":"D1F2AF2CD7D837","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":49125,"discussion_content":"如果调用了callback是不是就不用设置retries了，默认有回调是不是就默认会retries消息了？\n如果不是，那么retries为多少合适？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573558490,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1111899,"avatar":"https://static001.geekbang.org/account/avatar/00/10/f7/5b/d2e7c2c4.jpg","nickname":"时隐时现","note":"","ucode":"DA4D622FF84920","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":7997,"discussion_content":"有个疑问：1、调用了send(msg)，producer如何判断何时进行retry，这个触发场景是什么？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567751085,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":108112,"user_name":"nightmare","can_delete":false,"product_type":"c1","uid":1056314,"ip_address":"","ucode":"EF2E51C2122A86","user_header":"https://static001.geekbang.org/account/avatar/00/10/1e/3a/5b21c01c.jpg","comment_is_top":false,"comment_ctime":1561683360,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"31626454432","product_id":100029201,"comment_content":"多线程消费这么确保手动提交offset管理不会丢失呢，期待老师给一个消费端最佳实践","like_count":7},{"had_liked":false,"id":107909,"user_name":"Geek_986289","can_delete":false,"product_type":"c1","uid":1182717,"ip_address":"","ucode":"503FE134FCC109","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKtYGLkKnh186Ynyx3bPvOMI7ViaWia2l8DD8eomDkE6AKNwW7l1a00CiaaiaiapibZY5JlQlxqQEQuSYFg/132","comment_is_top":false,"comment_ctime":1561632311,"is_pvip":false,"replies":[{"id":"39125","content":"就我碰到的实际场景，影响还是很大的。acks=all时，大部分的请求处理延时都花在了follower同步上。<br><br>是的，acks=all表明所有ISR中的副本都要同步。","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1561680579,"ip_address":"","comment_id":107909,"utype":1}],"discussion_count":1,"race_medal":0,"score":"27331436087","product_id":100029201,"comment_content":"设置 acks = all。表明所有副本 Broker 都要接收到消息，该消息才算是“已提交”。如果所有的Broker都要收到消息才能算作已提交，会不会对系统的吞吐量影响很大？另外这里的副本指的是不是仅仅是ISR?","like_count":6,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":455740,"discussion_content":"就我碰到的实际场景，影响还是很大的。acks=all时，大部分的请求处理延时都花在了follower同步上。\n\n是的，acks=all表明所有ISR中的副本都要同步。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561680579,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":107722,"user_name":"AA","can_delete":false,"product_type":"c1","uid":1103583,"ip_address":"","ucode":"CADCB958D6DA1B","user_header":"https://static001.geekbang.org/account/avatar/00/10/d6/df/1e4ecd94.jpg","comment_is_top":false,"comment_ctime":1561599916,"is_pvip":false,"replies":[{"id":"39139","content":"只要位移没有越界以及有提交的位移，那么就不会出现这种场景。","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1561681226,"ip_address":"","comment_id":107722,"utype":1}],"discussion_count":3,"race_medal":0,"score":"27331403692","product_id":100029201,"comment_content":"如果consumer改用&quot;从最早位置&quot;读解决新加分区造成的问题，那会不会导致旧的分区里的已被消费过的消息重新全部被消费一次","like_count":6,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":455638,"discussion_content":"只要位移没有越界以及有提交的位移，那么就不会出现这种场景。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561681226,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1073027,"avatar":"https://static001.geekbang.org/account/avatar/00/10/5f/83/bb728e53.jpg","nickname":"Douglas","note":"","ucode":"CFDE3D76B9DAE6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":332420,"discussion_content":"每个消费者需要自己记录消费的位置么，比如记录到redis,避免消费者重启后不知道从哪里开始消费","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1607185638,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1104245,"avatar":"https://static001.geekbang.org/account/avatar/00/10/d9/75/3598e0de.jpg","nickname":"Icedmaze","note":"","ucode":"DC05117685CAB5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":468,"discussion_content":"不会，对于已经有消费位移的分区，优先根据记录的消费位移来，只有找不到消费位移的时候才会根据消费策略选择是从“最早位移消费”还是“最新位移消费”\n个人理解是这样的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561604652,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":107643,"user_name":"明翼","can_delete":false,"product_type":"c1","uid":1068361,"ip_address":"","ucode":"E77F86BEB3D5C1","user_header":"https://static001.geekbang.org/account/avatar/00/10/4d/49/28e73b9c.jpg","comment_is_top":false,"comment_ctime":1561591518,"is_pvip":false,"replies":[{"id":"38943","content":"嗯嗯，是的。本来就是为了更强的消息持久化保证，只能牺牲一点高可用性了~~","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1561596946,"ip_address":"","comment_id":107643,"utype":1}],"discussion_count":3,"race_medal":0,"score":"27331395294","product_id":100029201,"comment_content":"这个问题我想个办法就是程序停止再增加分区，如果不能停止那就找个通知机制了。请教一个问题min.insync.replicas这个参数如果设置成3，假设副本数设置为4，那岂不是只支持一台broker坏掉的情况？本来支持三台坏掉的，老师我理解的对不对","like_count":6,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":455602,"discussion_content":"嗯嗯，是的。本来就是为了更强的消息持久化保证，只能牺牲一点高可用性了~~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561596946,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1134861,"avatar":"https://static001.geekbang.org/account/avatar/00/11/51/0d/fc1652fe.jpg","nickname":"James","note":"","ucode":"48B0F2A334D1C1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":49424,"discussion_content":"马克","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573578157,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1542987,"avatar":"https://static001.geekbang.org/account/avatar/00/17/8b/4b/fa52d222.jpg","nickname":"行则将至","note":"","ucode":"DB972F2DF059C4","race_medal":1,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":3374,"discussion_content":"这种方式应该是支持坏掉2台吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564447092,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":203905,"user_name":"咸淡一首诗","can_delete":false,"product_type":"c1","uid":1435869,"ip_address":"","ucode":"FEE5A9B5139BF1","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLl9nj9b6RydKADq82ZwOad0fQcvXWyQKk5U5RFC2kzHGI4GjIQsIZvHsEm7mFELgMiaGx3lGq9vag/132","comment_is_top":false,"comment_ctime":1586304215,"is_pvip":false,"replies":[{"id":"76533","content":"是的。min.insync.replicas=2，而ISR size = 1且acks=all，那么producer肯定无法生产任何消息给这个分区了","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1586482067,"ip_address":"","comment_id":203905,"utype":1}],"discussion_count":2,"race_medal":0,"score":"23061140695","product_id":100029201,"comment_content":"老师，好，请教一个问题，如果acks=all，min.insync.replicas=2，如果持续高吞吐量导致ISR中只剩下leader，那么由于min.insync.replicas=2设置了最少需要写入2个副本，此时是不是该分区就写不进去了？","like_count":5,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":490997,"discussion_content":"是的。min.insync.replicas=2，而ISR size = 1且acks=all，那么producer肯定无法生产任何消息给这个分区了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586482067,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1339409,"avatar":"https://static001.geekbang.org/account/avatar/00/14/70/11/42cf8f9d.jpg","nickname":"chenjia","note":"","ucode":"61983C29FF4987","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":366690,"discussion_content":"其他不变，只修改asks=1，这样还是写不进去吧？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618151200,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":152214,"user_name":"亮","can_delete":false,"product_type":"c1","uid":1031695,"ip_address":"","ucode":"4F8B9F5ABA2D52","user_header":"https://static001.geekbang.org/account/avatar/00/0f/be/0f/82db5e65.jpg","comment_is_top":false,"comment_ctime":1573916902,"is_pvip":false,"replies":[{"id":"58589","content":"callback可以处理消息发送之后的逻辑，不一定就是失败的逻辑。retries是预防那种瞬时错误的，比如网络抖动这种问题，让Kafka自动重试一下会比较方便不是吗","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1574039151,"ip_address":"","comment_id":152214,"utype":1}],"discussion_count":1,"race_medal":0,"score":"23048753382","product_id":100029201,"comment_content":"老师好，有个问题，就是：retries 和 send里面的callback，是什么关系？因为有说retries是kafka自动重试的次数，那么还要callback干吗，callback的意义在哪里呢？ 如果一定要坚持用send(callback)api，那么retries是用来干吗的呢？ 这两者之间的关系是什么呢？谢谢。","like_count":5,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":474751,"discussion_content":"callback可以处理消息发送之后的逻辑，不一定就是失败的逻辑。retries是预防那种瞬时错误的，比如网络抖动这种问题，让Kafka自动重试一下会比较方便不是吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574039151,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":113601,"user_name":"杰锅不是锅","can_delete":false,"product_type":"c1","uid":1595192,"ip_address":"","ucode":"62D045F6A0680E","user_header":"https://static001.geekbang.org/account/avatar/00/18/57/38/e5b8b766.jpg","comment_is_top":false,"comment_ctime":1563091778,"is_pvip":false,"replies":[{"id":"41415","content":"通常情况下能够保障每个consumer消费一个分区。如果消费慢，需要看到底是哪里慢？是Kafka给你消息的速度慢还是你自己处理消息的速度慢。可以适当增加max.poll.interval.ms看看","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1563156592,"ip_address":"","comment_id":113601,"utype":1}],"discussion_count":1,"race_medal":0,"score":"23037928258","product_id":100029201,"comment_content":"老师，我想问个问题，假如一个topic有3个partion ，我有三个消费端去消费topic，这三个消费端，是怎么去对应三个partion?曾经在线上遇到过消费太慢，导致消息重新均衡，重复消费了，有好的解决方法吗？","like_count":5,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":458300,"discussion_content":"通常情况下能够保障每个consumer消费一个分区。如果消费慢，需要看到底是哪里慢？是Kafka给你消息的速度慢还是你自己处理消息的速度慢。可以适当增加max.poll.interval.ms看看","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563156592,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":136731,"user_name":"wei.li","can_delete":false,"product_type":"c1","uid":1105002,"ip_address":"","ucode":"0FD34DB6CF7F4F","user_header":"https://static001.geekbang.org/account/avatar/00/10/dc/6a/85ab92ae.jpg","comment_is_top":false,"comment_ctime":1569500370,"is_pvip":false,"replies":[{"id":"52501","content":"在producer端是这样的，在consumer端是通过控制消费数据和提交位移的时机来实现","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1569548145,"ip_address":"","comment_id":136731,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18749369554","product_id":100029201,"comment_content":"至少一次&#47;至多一次的语义是通过ack可retires参数配置吗？","like_count":4,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":468778,"discussion_content":"在producer端是这样的，在consumer端是通过控制消费数据和提交位移的时机来实现","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1569548145,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":108681,"user_name":"曹伟雄","can_delete":false,"product_type":"c1","uid":1400754,"ip_address":"","ucode":"9740E426C0742C","user_header":"https://static001.geekbang.org/account/avatar/00/15/5f/b2/c4780c10.jpg","comment_is_top":false,"comment_ctime":1561854350,"is_pvip":false,"replies":[{"id":"39433","content":"你可以选择将offset保存在外部持久化设备中，不过更常见的做法是使用consumer API保存在Kafka里面。常见的API包括commitSync和commitAsync","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1561946422,"ip_address":"","comment_id":108681,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18741723534","product_id":100029201,"comment_content":"老师你好，请教个问题。关于offset，有必要外部持久化记录吗？ 出问题后查出来继续消费。你说的更新offset是怎么处理? 是直接调用它的api更新吗？ 谢谢","like_count":4,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":456078,"discussion_content":"你可以选择将offset保存在外部持久化设备中，不过更常见的做法是使用consumer API保存在Kafka里面。常见的API包括commitSync和commitAsync","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561946422,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":108103,"user_name":"Alan","can_delete":false,"product_type":"c1","uid":1119761,"ip_address":"","ucode":"F263C5A01A6377","user_header":"https://static001.geekbang.org/account/avatar/00/11/16/11/45e7b64e.jpg","comment_is_top":false,"comment_ctime":1561682572,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"18741551756","product_id":100029201,"comment_content":"1 外部持久化每个topic的每个消费者组的每个patition的offset。<br><br>2 程序重启时继续上一次的offset<br><br>3 监控每个partition的offset，每次的from offset和to offset是不是线性连续的消费<br><br>4 允许重复消费，在消费端去重","like_count":4},{"had_liked":false,"id":107999,"user_name":"快跑","can_delete":false,"product_type":"c1","uid":1564645,"ip_address":"","ucode":"90ED7E6D40C58E","user_header":"https://static001.geekbang.org/account/avatar/00/17/df/e5/65e37812.jpg","comment_is_top":false,"comment_ctime":1561645686,"is_pvip":false,"replies":[{"id":"39120","content":"可以。retries是producer自动帮你重试。callback中你可以做一些处理之后再重试。","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1561680162,"ip_address":"","comment_id":107999,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18741514870","product_id":100029201,"comment_content":"老师，你好！<br>producer.send(msg, callback)中callback主要用来做什么？可以用来重新发送数据么？如果可以的话，跟producer的配置retries是不是功能重复了","like_count":4,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":455779,"discussion_content":"可以。retries是producer自动帮你重试。callback中你可以做一些处理之后再重试。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561680162,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":107980,"user_name":"z.l","can_delete":false,"product_type":"c1","uid":1181055,"ip_address":"","ucode":"805CC5784D3F76","user_header":"https://static001.geekbang.org/account/avatar/00/12/05/7f/d35ab9a1.jpg","comment_is_top":false,"comment_ctime":1561643409,"is_pvip":false,"replies":[{"id":"39121","content":"不冲突。对于可重试的错误，retries才会触发，否则直接 进入到callback","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1561680225,"ip_address":"","comment_id":107980,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18741512593","product_id":100029201,"comment_content":"在“producer.send(msg, callback)的callback方法中重试，和设置retries参数重试，会不会冲突？2个都设置以哪个为准？","like_count":4,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":455772,"discussion_content":"不冲突。对于可重试的错误，retries才会触发，否则直接 进入到callback","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561680225,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":112600,"user_name":"Jason_鹏","can_delete":false,"product_type":"c1","uid":1179329,"ip_address":"","ucode":"4A3DCAAC531724","user_header":"https://static001.geekbang.org/account/avatar/00/11/fe/c1/6c99fff4.jpg","comment_is_top":false,"comment_ctime":1562768842,"is_pvip":false,"replies":[{"id":"40975","content":"1. 不可以<br>2. 不会丢失，但可能会重复消费","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1562803971,"ip_address":"","comment_id":112600,"utype":1}],"discussion_count":5,"race_medal":0,"score":"14447670730","product_id":100029201,"comment_content":"有两个问题<br>1、acks=all 分区副本的个数为3，producer将消息发送给Leader分区后，两个Follower分区还未同步，或者由于网络延时问题迟迟没有同步，这时消息者是否可以消费Leader分区上的这条消息，如果可以话，就会出现producer因为超时没有接收到ack，进行重发消息，那消费者就会出现重复消费的情况<br><br>2、我们正常的线上环境，对于同一个主题有多台消费者机器，比如对于主题T1，现在的情况是消费者C1消费的分区是P1，消费者C2消费的分区是P2，P1，P2是主题T1的两个分区，这时候线上的发版，消费者C1和C2都会进行重启，重启后如果C1变成消费分区P2，C2变成消费分区P1，offset是记录在消费端，那会不会照成消息丢失的情况","like_count":3,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457813,"discussion_content":"1. 不可以\n2. 不会丢失，但可能会重复消费","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562803971,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1547667,"avatar":"https://static001.geekbang.org/account/avatar/00/17/9d/93/4159edaa.jpg","nickname":"朴素柠檬c","note":"","ucode":"2D4CBB70D801B1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":328673,"discussion_content":"就算重启 原消费者也会去消费原分区吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606208181,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1005098,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/56/2a/82f4252c.jpg","nickname":"Liliya","note":"","ucode":"386569F3A0BA38","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":312325,"discussion_content":"是以消费组（group）来管理消费的，每个消费组会记录topic各分区的offset，重启消费组消费进程不会影响offset，所以不会造成消息丢失","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1602664771,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1043558,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ec/66/0eab4211.jpg","nickname":"Ryan","note":"","ucode":"96D4716E5E6C66","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":25276,"discussion_content":"如果c1和c2都是手动提交offset的，会不会有问题？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1570495600,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1054827,"avatar":"https://static001.geekbang.org/account/avatar/00/10/18/6b/a1448af1.jpg","nickname":"贝影","note":"","ucode":"19545C8DCBF8A2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1043558,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ec/66/0eab4211.jpg","nickname":"Ryan","note":"","ucode":"96D4716E5E6C66","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":543952,"discussion_content":"也不会有问题，顶多重复消费","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641366811,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":25276,"ip_address":""},"score":543952,"extra":""}]}]},{"had_liked":false,"id":107762,"user_name":"空知","can_delete":false,"product_type":"c1","uid":1013283,"ip_address":"","ucode":"C448E98238DD36","user_header":"https://static001.geekbang.org/account/avatar/00/0f/76/23/31e5e984.jpg","comment_is_top":false,"comment_ctime":1561604207,"is_pvip":false,"replies":[{"id":"39134","content":"是因为不满足min.insync.replicas的要求了。比如该参数=2，当前ISR中只剩1个副本了，那么producer就没法生产新的消息了。","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1561680978,"ip_address":"","comment_id":107762,"utype":1}],"discussion_count":2,"race_medal":0,"score":"14446506095","product_id":100029201,"comment_content":"老师问下 <br>第7条 一个副本挂掉 整个分区不能用了 是因为每次都必须保证可用副本个数 必须跟提交时候一致 才可以正常使用,又没有冗余副本导致的嘛?","like_count":3,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":455662,"discussion_content":"是因为不满足min.insync.replicas的要求了。比如该参数=2，当前ISR中只剩1个副本了，那么producer就没法生产新的消息了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561680978,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1161209,"avatar":"https://static001.geekbang.org/account/avatar/00/11/b7/f9/a8f26b10.jpg","nickname":"jacke","note":"","ucode":"05F355E1FF88C5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":861,"discussion_content":"问下,如果这种情况下request.required.acks设置为1,消息能到达ISR剩下的一个副本， producer可以正常发送吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562125511,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":107631,"user_name":"AA","can_delete":false,"product_type":"c1","uid":1103583,"ip_address":"","ucode":"CADCB958D6DA1B","user_header":"https://static001.geekbang.org/account/avatar/00/10/d6/df/1e4ecd94.jpg","comment_is_top":false,"comment_ctime":1561573138,"is_pvip":false,"replies":[{"id":"38931","content":"新增加了分区之后consumer和producer不会立即感知，通常可能会等待一段时间。如果producer先感知到了并向新分区发送消息，那么consumer后感知到之后直接从最新位移开始读取消息，那么之前发送的消息就不会被消费了。 ","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1561595902,"ip_address":"","comment_id":107631,"utype":1}],"discussion_count":7,"race_medal":0,"score":"14446475026","product_id":100029201,"comment_content":"老师，最后一段新增分区导致消息全部丢失，这个不是很明白","like_count":3,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":455594,"discussion_content":"新增加了分区之后consumer和producer不会立即感知，通常可能会等待一段时间。如果producer先感知到了并向新分区发送消息，那么consumer后感知到之后直接从最新位移开始读取消息，那么之前发送的消息就不会被消费了。 ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561595902,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1003624,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/50/68/7a8aa1e1.jpg","nickname":"saup007","note":"","ucode":"5BE1CA2E482E96","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":290895,"discussion_content":"如果 consumer 默认是 earliest 这种场景就不会丢了吧，如果是latest会丢。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594634282,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1009652,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg","nickname":"钱","note":"","ucode":"2C92A243A463D4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":4802,"discussion_content":"有同样的疑惑","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565745976,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1137879,"avatar":"https://static001.geekbang.org/account/avatar/00/11/5c/d7/e4673fde.jpg","nickname":"October","note":"","ucode":"CEDA78F4A5F8B1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":459,"discussion_content":"还是不理解。consumer位移的提交不是每个分区的位移单独提交吗？在未感知到新的分区之前，consumer对于新增加的分区的消费位移不应该是0吗。当感知到新增加的分区，就会从0开始消费，为什么会造成数据丢失？","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1561602022,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":3,"child_discussions":[{"author":{"id":1154101,"avatar":"https://static001.geekbang.org/account/avatar/00/11/9c/35/9dc79371.jpg","nickname":"你好旅行者","note":"","ucode":"5C72A428DC28F3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1137879,"avatar":"https://static001.geekbang.org/account/avatar/00/11/5c/d7/e4673fde.jpg","nickname":"October","note":"","ucode":"CEDA78F4A5F8B1","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":466,"discussion_content":"附议，我也不是很理解为什么不是从0开始拉取消息","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561602723,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":459,"ip_address":""},"score":466,"extra":""},{"author":{"id":1109449,"avatar":"https://static001.geekbang.org/account/avatar/00/10/ed/c9/57d571a3.jpg","nickname":"凯","note":"","ucode":"E3F5993C2FDCB7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1137879,"avatar":"https://static001.geekbang.org/account/avatar/00/11/5c/d7/e4673fde.jpg","nickname":"October","note":"","ucode":"CEDA78F4A5F8B1","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":494,"discussion_content":"不知道是不是因为有可能消费的起点默认使用的是largest","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561620136,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":459,"ip_address":""},"score":494,"extra":""},{"author":{"id":1762252,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/e3/cc/0947ff0b.jpg","nickname":"nestle","note":"","ucode":"469800BED81B54","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1137879,"avatar":"https://static001.geekbang.org/account/avatar/00/11/5c/d7/e4673fde.jpg","nickname":"October","note":"","ucode":"CEDA78F4A5F8B1","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":301453,"discussion_content":"新分区不是0，而是由配置auto.offset.reset决定。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598530450,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":459,"ip_address":""},"score":301453,"extra":""}]}]},{"had_liked":false,"id":296493,"user_name":"非洲黑猴子","can_delete":false,"product_type":"c1","uid":2639724,"ip_address":"","ucode":"F5FEAC07D562E0","user_header":"https://static001.geekbang.org/account/avatar/00/28/47/6c/78184d19.jpg","comment_is_top":false,"comment_ctime":1623003569,"is_pvip":true,"replies":[{"id":"107772","content":"“consumer自己建一个队列然后多线程来消费” —— 这个绝对是可行的方案。事实上，Kafka consumer从未要求使用者不能使用多线程来处理poll回来的消息。难以处理位移提交不代表不能正确处理。<br>1、单个Consumer所负担的消息太多怎么办？<br>--- 使用多个consumer或多个线程<br>2、看看这个帖子：https:&#47;&#47;www.cnblogs.com&#47;huxi2b&#47;p&#47;13668061.html","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1623120025,"ip_address":"","comment_id":296493,"utype":1}],"discussion_count":0,"race_medal":5,"score":"10212938161","product_id":100029201,"comment_content":"李玥老师聊消息队列的讲座里说不可以consumer自己建一个队列然后多线程来消费，因为那样一旦宕机就会丢失队列里的消息。这样线程池似乎也就不能用了，因为她里面就有一个LinkedBlockingQueue。请问胡老师两个问题： <br>1. 单个Consumer所负担的消息太多怎么办？<br>2. 有没有什么方法可以让多线程处理单个Consumer的逻辑和代码变得简单优雅些？我能想到的是处理逻辑保证幂等，避免重复消费产生的影响。<br>谢谢🙏","like_count":2},{"had_liked":false,"id":205036,"user_name":"李先生","can_delete":false,"product_type":"c1","uid":1237614,"ip_address":"","ucode":"D9039715F7D290","user_header":"https://static001.geekbang.org/account/avatar/00/12/e2/6e/0a300829.jpg","comment_is_top":false,"comment_ctime":1586512485,"is_pvip":false,"replies":[{"id":"76727","content":"1. Java FileChannel的transferTo方法底层调用sendfile，实现Zero Copy。详细信息你可以查看这个jdk ticket：https:&#47;&#47;bugs.openjdk.java.net&#47;browse&#47;JDK-4474736<br>2. 是的，你说的这种情况是会出现消息丢失，所以Kafka保证不丢消息是有条件的，即ISR中至少有一个副本同步了该消息且存活。不可能无条件地保证消息不丢失。","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1586609988,"ip_address":"","comment_id":205036,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10176447077","product_id":100029201,"comment_content":"胡哥，有两个问题：<br>1:kafka还使用了sendfile技术，能简单介绍下吗？<br>2:acks=all，只是保证消息被存储到所有broker的pagecache中就认为消息成功，如果再此时间点，所有broker全部异常停机，那么pagecache中的消息就不会被异步拉取到磁盘，当重启之后，消息就丢失了。这种情况如何考虑呢？","like_count":2,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":491360,"discussion_content":"1. Java FileChannel的transferTo方法底层调用sendfile，实现Zero Copy。详细信息你可以查看这个jdk ticket：https://bugs.openjdk.java.net/browse/JDK-4474736\n2. 是的，你说的这种情况是会出现消息丢失，所以Kafka保证不丢消息是有条件的，即ISR中至少有一个副本同步了该消息且存活。不可能无条件地保证消息不丢失。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586609988,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":173861,"user_name":"yic","can_delete":false,"product_type":"c1","uid":1201577,"ip_address":"","ucode":"C8DC471B7C28B8","user_header":"https://static001.geekbang.org/account/avatar/00/12/55/a9/5282a560.jpg","comment_is_top":false,"comment_ctime":1579744373,"is_pvip":false,"replies":[{"id":"67907","content":"应该是一种不错的思路：）","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1580368455,"ip_address":"","comment_id":173861,"utype":1}],"discussion_count":3,"race_medal":0,"score":"10169678965","product_id":100029201,"comment_content":"胡老师，课后题：<br>在消费者端管理每个partition的offset是否可以解决？如果消费者是集群形式，那可以公共缓存统一存储每个partition的offset。缓存中没有partition的offset记录，则从最新消息处开始读消息。","like_count":2,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":482221,"discussion_content":"应该是一种不错的思路：）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580368455,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1201577,"avatar":"https://static001.geekbang.org/account/avatar/00/12/55/a9/5282a560.jpg","nickname":"yic","note":"","ucode":"C8DC471B7C28B8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":172388,"discussion_content":"嗯嗯，是的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581777401,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1130590,"avatar":"https://static001.geekbang.org/account/avatar/00/11/40/5e/b8fada94.jpg","nickname":"Ryoma","note":"","ucode":"7F692369239692","race_medal":2,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":171839,"discussion_content":"严格意义上应该叫集中存储，这部分数据是需要进行持久化的且不能丢失，当然为了提高响应速度可以引入缓存机制。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581752286,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":120784,"user_name":"DC","can_delete":false,"product_type":"c1","uid":1250344,"ip_address":"","ucode":"EC0E7E86056FA6","user_header":"https://static001.geekbang.org/account/avatar/00/13/14/28/9e3edef0.jpg","comment_is_top":false,"comment_ctime":1564995416,"is_pvip":false,"replies":[{"id":"44458","content":"可以设置topic级别的参数来覆盖全局参数","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1565051099,"ip_address":"","comment_id":120784,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10154930008","product_id":100029201,"comment_content":"以前在callback里做过对Kafka的熔断逻辑，并且可以自动恢复熔断，防止Kafka集群问题影响应用<br>有一个疑问：就是看到这里发现会对kafka集群都会有一份自己的broker配置，如果我不同业务比如日志业务和订单业务可能对Kafka集群的配置需求不一样，是推荐部署两台Kafka集群吗？","like_count":2,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":461478,"discussion_content":"可以设置topic级别的参数来覆盖全局参数","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565051099,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":109985,"user_name":"Geek_817ea4","can_delete":false,"product_type":"c1","uid":1579066,"ip_address":"","ucode":"D1194D33C4DC11","user_header":"https://static001.geekbang.org/account/avatar/00/18/18/3a/b407889c.jpg","comment_is_top":false,"comment_ctime":1562145760,"is_pvip":false,"replies":[{"id":"39908","content":"不是的。如你所说replication.factor = 3，isr存在一个l和2个f。如果一个f被踢出，此时ISR副本数变成2，即使是acks=all的producer依然可以正常写入消息，因为2依然大于min.insync.replicas(1)。但如果再挂一个副本，ISR副本就变为1了 ，不大于min.insync.replicas了，此时producer不能写入数据。<br><br>min.insync.replicas和acks=all结合使用来标识是否能写入消息","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1562202046,"ip_address":"","comment_id":109985,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10152080352","product_id":100029201,"comment_content":"min.insync.replicas=1,是指默认isr中只要存在一个leader副本即可吗？这个参数是指isr中副本数吧，而不是写入数据，比如我设置这个参数3，isr存在一个l和2个f，如果一个f被踢出isr就会报错，而不是写入数据。","like_count":2,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":456669,"discussion_content":"不是的。如你所说replication.factor = 3，isr存在一个l和2个f。如果一个f被踢出，此时ISR副本数变成2，即使是acks=all的producer依然可以正常写入消息，因为2依然大于min.insync.replicas(1)。但如果再挂一个副本，ISR副本就变为1了 ，不大于min.insync.replicas了，此时producer不能写入数据。\n\nmin.insync.replicas和acks=all结合使用来标识是否能写入消息","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562202046,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":108998,"user_name":"Geek_Sue","can_delete":false,"product_type":"c1","uid":1580774,"ip_address":"","ucode":"B2C9400D72BB1D","user_header":"","comment_is_top":false,"comment_ctime":1561945533,"is_pvip":false,"replies":[{"id":"39453","content":"Kafka Streams后台就是多线程的处理机制（Stream Thread)，而且Kafka Streams的确是推荐方案之一。","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1561948099,"ip_address":"","comment_id":108998,"utype":1}],"discussion_count":2,"race_medal":0,"score":"10151880125","product_id":100029201,"comment_content":"胡老师，您好，不知道您后面有没有计划针对单Consumer多线程处理的方式进行详细说明？我这边工作中恰好有这样的场景，现在是利用kafka stream来处理的，没有利用到多线程。","like_count":2,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":456202,"discussion_content":"Kafka Streams后台就是多线程的处理机制（Stream Thread)，而且Kafka Streams的确是推荐方案之一。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561948099,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1580774,"avatar":"","nickname":"Geek_Sue","note":"","ucode":"B2C9400D72BB1D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":679,"discussion_content":"胡老师，您说的Stream Thread是不是指StreamsConfig.NUM_STREAM_THREADS_CONFIG这个参数？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561954510,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":108172,"user_name":"你好旅行者","can_delete":false,"product_type":"c1","uid":1154101,"ip_address":"","ucode":"5C72A428DC28F3","user_header":"https://static001.geekbang.org/account/avatar/00/11/9c/35/9dc79371.jpg","comment_is_top":false,"comment_ctime":1561690412,"is_pvip":false,"replies":[{"id":"39452","content":"坦率来说，我是希望大家一起讨论，而且这个没有绝对的解决方案。能想到的一个简单方法是让consumer端缓存订阅信息，如果发现新的订阅分区出现，手动调整位移到最开始处执行（比如consumer.seekToBeginning） ","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1561948011,"ip_address":"","comment_id":108172,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10151625004","product_id":100029201,"comment_content":"老师好！抱歉我之前表述的不够清楚，请问老师可以贴出官方社区对增加主题分区以后Consumer无法读取到部分新消息这个问题的解决方案吗，就是您在最后的开放讨论里提出的这个问题，我想更深入地学习一下，谢谢老师！","like_count":2,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":455854,"discussion_content":"坦率来说，我是希望大家一起讨论，而且这个没有绝对的解决方案。能想到的一个简单方法是让consumer端缓存订阅信息，如果发现新的订阅分区出现，手动调整位移到最开始处执行（比如consumer.seekToBeginning） ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561948011,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":108021,"user_name":"QQ怪","can_delete":false,"product_type":"c1","uid":1211223,"ip_address":"","ucode":"1A39B8433D9208","user_header":"https://static001.geekbang.org/account/avatar/00/12/7b/57/a9b04544.jpg","comment_is_top":false,"comment_ctime":1561648329,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10151582921","product_id":100029201,"comment_content":"不知道是不是可以这样，生产者感知到了有新分区加入立即通知broke端下的消费者不能消费消息，直到消费端都感应到了加入的新分区之后，生产者和消费者才继续工作","like_count":2},{"had_liked":false,"id":312018,"user_name":"最摇摆的鱼","can_delete":false,"product_type":"c1","uid":1255574,"ip_address":"","ucode":"DA19F4C4224719","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqgVXa8DyW0YsrdYtPNMOdGH6hfdwfjwyBPRyoc9yuS4Ml18l0kApOoOKwYkF6NlDPYpX1bVEWomw/132","comment_is_top":false,"comment_ctime":1631594362,"is_pvip":true,"replies":[{"id":"114443","content":"会的","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1634004721,"ip_address":"","comment_id":312018,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5926561658","product_id":100029201,"comment_content":"retries会不会改变消息的顺序呢？如果第一条消息失败，第二条消息成功，再重发第一条消息成功。这样第二条消息就在第一条消息的前面了？","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":526832,"discussion_content":"会的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634004721,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":221054,"user_name":"张洋","can_delete":false,"product_type":"c1","uid":1182914,"ip_address":"","ucode":"549BE5DEEF8417","user_header":"https://static001.geekbang.org/account/avatar/00/12/0c/c2/bad34a50.jpg","comment_is_top":false,"comment_ctime":1590393365,"is_pvip":true,"replies":[{"id":"81554","content":" replication.factor是分区下的副本数。min.insync.replicas是指消息必须被写入到ISR的这么多个副本才算成功。如果replication.factor = min.insync.replicas，说明Kafka要求消息要被写入到所有副本中才算成功。自然如果挂了一个副本，分区就没法成功写入消息了。","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1590417857,"ip_address":"","comment_id":221054,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5885360661","product_id":100029201,"comment_content":"老师这个参数的含义还是没太明白 replication.factor &gt;= 3 是消息写入的副本数量吗，还是在每个副本上保存的份数（我现在的理解是这种含义），但是 这个参数的配置  replication.factor &gt; min.insync.replicas。如果两者相等，那么只要有一个副本挂机，整个分区就无法正常工作了。没想太明白为什么 配置相等就无法工作了。","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":496312,"discussion_content":" replication.factor是分区下的副本数。min.insync.replicas是指消息必须被写入到ISR的这么多个副本才算成功。如果replication.factor = min.insync.replicas，说明Kafka要求消息要被写入到所有副本中才算成功。自然如果挂了一个副本，分区就没法成功写入消息了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590417857,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1547667,"avatar":"https://static001.geekbang.org/account/avatar/00/17/9d/93/4159edaa.jpg","nickname":"朴素柠檬c","note":"","ucode":"2D4CBB70D801B1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":328894,"discussion_content":"所以使用kafka需要强大的运维团队支撑，参数太多 ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606268673,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":217108,"user_name":"Treagzhao","can_delete":false,"product_type":"c1","uid":1109643,"ip_address":"","ucode":"906C3A7F33040C","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqKurYDna034zK0ibDIWicybibQhiaM6afgla2zVFqBrAemLgCh3WoibjACnic5ibiaYMd29tMB26cjaGaPoA/132","comment_is_top":false,"comment_ctime":1589421235,"is_pvip":false,"replies":[{"id":"80317","content":"这么看来，是以生产者为准","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1589458549,"ip_address":"","comment_id":217108,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5884388531","product_id":100029201,"comment_content":"老师，我有一个问题想不明白。ack参数是设置在生产者上的，不同的生产者可以有不同的参数值，那是不是同一个主题不同的生产者&quot;已提交&quot;的定义是不一样的？这个定义是以生产者为准的？还是以服务器设置为准的？","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":495039,"discussion_content":"这么看来，是以生产者为准","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589458549,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":210507,"user_name":"渊虹","can_delete":false,"product_type":"c1","uid":1197459,"ip_address":"","ucode":"A041AD241B8E3F","user_header":"https://static001.geekbang.org/account/avatar/00/12/45/93/6ad60b12.jpg","comment_is_top":false,"comment_ctime":1587781063,"is_pvip":false,"replies":[{"id":"78459","content":"对于消费者而言，就是先消费然后再提交位移","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1587866050,"ip_address":"","comment_id":210507,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5882748359","product_id":100029201,"comment_content":"老师，有个问题请教下。维持先消费消息（阅读），再更新位移（书签）的顺序。是如何做的","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493039,"discussion_content":"对于消费者而言，就是先消费然后再提交位移","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587866050,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":201050,"user_name":"Geek_9d0e04","can_delete":false,"product_type":"c1","uid":1902220,"ip_address":"","ucode":"F5560CE5BDB125","user_header":"","comment_is_top":false,"comment_ctime":1585709629,"is_pvip":false,"replies":[{"id":"75362","content":"写到page cache中","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1585792265,"ip_address":"","comment_id":201050,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5880676925","product_id":100029201,"comment_content":"broker上成功保存该消息，是指持久化到磁盘，还是只是写到page cache中？","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":490225,"discussion_content":"写到page cache中","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585792265,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":180791,"user_name":"Phil","can_delete":false,"product_type":"c1","uid":1617421,"ip_address":"","ucode":"CBD45271013B2A","user_header":"https://static001.geekbang.org/account/avatar/00/18/ae/0d/3e89877b.jpg","comment_is_top":false,"comment_ctime":1582389451,"is_pvip":false,"replies":[{"id":"70212","content":"是可能的，所以有max.in.flight.requests.per.connection这个参数，","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1582455476,"ip_address":"","comment_id":180791,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5877356747","product_id":100029201,"comment_content":"异步发送消息，如果retry，是否会造成消息乱序？","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":484792,"discussion_content":"是可能的，所以有max.in.flight.requests.per.connection这个参数，","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582455476,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":173144,"user_name":"ezekiel","can_delete":false,"product_type":"c1","uid":1158795,"ip_address":"","ucode":"AB4AB6FA8612D8","user_header":"https://static001.geekbang.org/account/avatar/00/11/ae/8b/43ce01ca.jpg","comment_is_top":false,"comment_ctime":1579436699,"is_pvip":false,"replies":[{"id":"67159","content":"这个需求太太宽泛了。。。。每个生产环境的需求都可能不同。如果寻找共性的代码，可以去Kafka的Javadoc上看看示例代码：<br>https:&#47;&#47;kafka.apache.org&#47;23&#47;javadoc&#47;index.html?org&#47;apache&#47;kafka&#47;clients&#47;consumer&#47;KafkaConsumer.html<br>和<br>https:&#47;&#47;kafka.apache.org&#47;23&#47;javadoc&#47;org&#47;apache&#47;kafka&#47;clients&#47;producer&#47;KafkaProducer.html","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1579482493,"ip_address":"","comment_id":173144,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5874403995","product_id":100029201,"comment_content":"老师您好！<br><br>是否可以给一份在生产环境使用的kafka生产者和消费者demo？","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":481971,"discussion_content":"这个需求太太宽泛了。。。。每个生产环境的需求都可能不同。如果寻找共性的代码，可以去Kafka的Javadoc上看看示例代码：\nhttps://kafka.apache.org/23/javadoc/index.html?org/apache/kafka/clients/consumer/KafkaConsumer.html\n和\nhttps://kafka.apache.org/23/javadoc/org/apache/kafka/clients/producer/KafkaProducer.html","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579482493,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":160552,"user_name":"jfwwlong","can_delete":false,"product_type":"c1","uid":1351597,"ip_address":"","ucode":"215753DB23A02A","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJM2Y17W5mKU1icTg4OTKd3xYMhANenFDsYewjBlzWMujIh3vA2Yj9yG8ibr6WQMqUjjTgeNicXTp9kw/132","comment_is_top":false,"comment_ctime":1575973337,"is_pvip":true,"replies":[{"id":"61311","content":"future.get()相当于同步发送了，使用callback实现的是异步发送。到底使用哪个取决于你的选择了","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1576025302,"ip_address":"","comment_id":160552,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5870940633","product_id":100029201,"comment_content":"可以用send里的future.get来代替callback吗","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":477414,"discussion_content":"future.get()相当于同步发送了，使用callback实现的是异步发送。到底使用哪个取决于你的选择了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576025302,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":157246,"user_name":"杰洛特","can_delete":false,"product_type":"c1","uid":1098146,"ip_address":"","ucode":"46D0574654F8AC","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqEacia8yO1dR5Tal9B7w8PzTRrViajlAvDph96OqcuBGe29icbXOibhibGmaBcO7BfpVia0Y8ksZwsuAYQ/132","comment_is_top":false,"comment_ctime":1575096604,"is_pvip":false,"replies":[{"id":"60321","content":"通常在Callback中只需要处理严重错误就可以了。回调的处理逻辑以具体场景而定，没有特定有意义的示例代码","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1575112626,"ip_address":"","comment_id":157246,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5870063900","product_id":100029201,"comment_content":"老师，请问如果配置了 retries&gt;0，还需要在带回调的callback里显示处理可重试异常吗？还是只需处理不可重试异常就可以了？有回调的示例代码吗？","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":476373,"discussion_content":"通常在Callback中只需要处理严重错误就可以了。回调的处理逻辑以具体场景而定，没有特定有意义的示例代码","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1575112626,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":145450,"user_name":"注定非凡","can_delete":false,"product_type":"c1","uid":1113597,"ip_address":"","ucode":"80673056E131B7","user_header":"https://static001.geekbang.org/account/avatar/00/10/fd/fd/326be9bb.jpg","comment_is_top":false,"comment_ctime":1572274818,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"5867242114","product_id":100029201,"comment_content":"1：什么是不丢失<br>Kafka只对“已提交”的消息（committed message）做有限度持久化保证。<br>        A：“已提交”的定义：Kafka的若干个（可自定义配置为一个或全部）Broker成功接收到，并写入日志后即为以成功提交。<br>       B：有限度的持久化保证：kafka的消息不丢失的前提是N个Broker中至少有一个存活。<br><br>2：消息丢失场景<br>\tA：生产者丢失消息：<br>\t\t（1）：Kafka Producer是异步发送消息，使用producer.send(msg)发送消息，可以立即得到响应，但不能确定是否真的发送成功。<br>\t\t（2）：网络抖动，消息本身不合格都会导致Broker无法正常接收消息<br>\t解决：使用带有回调的producer.send(msg，callback)，回调可以准确的告诉我们消息是否真的发送成功。<br>\t<br>\tB：消费者丢失消息：<br>\t\t（1）Consumer端的位移数据出现异常，导致消息被略过<br>解决：先消费消息，在更新位移记录（这个可能会导致重复消费问题）<br>\t\t（2）多个Consumer实例同时消费，但部分实例消费失败，原因是每个确认消息是否成功消费，位移数据就已经被更新。<br>\t\t\t解决：如果是多线程异步处理消费消息，consumer，程序就不要开启自动提交位移，让应用程序手动提交。<br><br>3：最佳实践<br>\tA：使用带回调通知的方法，发送消息<br>\tB：Producer端设置相关参数：<br>（1）设置acks=all，表示所有副本Broker都要接收到该消息，才算提交成功。<br>（2）设置retries&gt;0，表示Producer能够自动重试消息发送，避免消息丢失。<br>\tC：Broker端设置相关参数：<br>\t\t（1）：设置unclean.leader.election.enable = false，控制Broker有资格竞选分区的leader，禁止落后原Leader的太多Broker参加竞选，避免成为新的Leader，造成消息丢失。<br>\t\t（2）：设置 replication.factor &gt;=3，表示将消息多备份几份。<br>\t\t（3）：设置 min.insync.replicas &gt;1，控制消息至少要被写入到多少个副本才算是“已提交”。这个设置成大于1可以提升消息持久性。生产环境不可以设置为默认值1。<br>\t\t（4）：设置replication.factor = min.insync.replicas + 1， 确保replication.factor&gt;min.insync.replicas，若两者相等，那么只要有一个副本挂机，整个分区都无法正常工作。<br>\tD：Consumer端设置相关参数：<br>\t\t（1）设置enable.auto.commit=false，表示关闭自动提交，使用手动提交位移方式。<br>","like_count":1},{"had_liked":false,"id":145066,"user_name":"Geek_9577e8","can_delete":false,"product_type":"c1","uid":1643916,"ip_address":"","ucode":"6888DAD84BA992","user_header":"https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLqHftpcZg7icWktaUiaCXSc0e8OwcjPqiatIhxJ77JclUH22qrjxYqZcJ46f7wtoqEIYSx3UJ26OZ4g/132","comment_is_top":false,"comment_ctime":1572178373,"is_pvip":false,"replies":[{"id":"55955","content":"<br>“每个生产环境机器都对应一个consumer” ——不一定啊<br><br>在消费者组机制下，消费者实例的数量最好不要超过分区数，否则会有消费者实例消费不到分区，但不会出现多个消费者消费一个分区的情况。<br><br>这里的实例可以位于不同的线程、进程甚至是不同的机器上。<br>","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1572224976,"ip_address":"","comment_id":145066,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5867145669","product_id":100029201,"comment_content":"老师有个问题想请教下。我们公司kafka一般这么使用，我申请一个topic和一个consumergroup，写好consumer代码然后发到生产环境机器集群中。我理解每个生产环境机器都对应一个consumer？如果是这样，那生产环境消费者机器数量是不是不能超过partition数量，否则会出现多个消费者消费一个partition的情况？","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":472229,"discussion_content":"\n“每个生产环境机器都对应一个consumer” ——不一定啊\n\n在消费者组机制下，消费者实例的数量最好不要超过分区数，否则会有消费者实例消费不到分区，但不会出现多个消费者消费一个分区的情况。\n\n这里的实例可以位于不同的线程、进程甚至是不同的机器上。\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572224976,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":134922,"user_name":"miwucc","can_delete":false,"product_type":"c1","uid":1326429,"ip_address":"","ucode":"7935BD907119AE","user_header":"https://static001.geekbang.org/account/avatar/00/14/3d/5d/ac666969.jpg","comment_is_top":false,"comment_ctime":1568955025,"is_pvip":false,"replies":[{"id":"51957","content":"1. 没有收到acks，producer会重试，导致重复发送而不是丢失消息<br>2. 第二个问题对broker而言不是丢失消息场景，因为都没有发送到broker端。","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1569201414,"ip_address":"","comment_id":134922,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5863922321","product_id":100029201,"comment_content":"这个不丢失消息的方法还有两个问题没有解决：<br>1.网络问题导致客户端没有收到ack消息<br>2.发送端在缓存中的消息还没发出去的时候进程被杀掉了<br>要解决这两个问题是不是必须自己实现发送消息持久化？没收到ack就重发？<br>但是如果是异步重发的话又会引起消息顺序问题。","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":467957,"discussion_content":"1. 没有收到acks，producer会重试，导致重复发送而不是丢失消息\n2. 第二个问题对broker而言不是丢失消息场景，因为都没有发送到broker端。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1569201414,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":129693,"user_name":"Geek_b809ff","can_delete":false,"product_type":"c1","uid":1288329,"ip_address":"","ucode":"F3F17E99F3AA0B","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoPY23R9RRSfBeTJUlyc612VlodjAaWWBNiay9tPydkrd6b9NA8GNibdibnFibTsx94ItHE4jvQwprNzA/132","comment_is_top":false,"comment_ctime":1567221531,"is_pvip":false,"replies":[{"id":"48515","content":"1. 不是，是因为每个线程无法顾忌其他线程的消费进度<br>2. 单线程不会的，毕竟只有一个线程嘛。<br>3. 自动提交简单方便，还能够自动重试","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1567386172,"ip_address":"","comment_id":129693,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5862188827","product_id":100029201,"comment_content":"老师，关于多线程消费的问题我一直不太明白<br>1、为什么自动提交会导致消息丢失，是因为自动提交不管消费者端有没有完全消费成功都会提交offset吗？<br>2、如果是这样的话，那么单线程的自动提交也会导致消息丢失吧，一样的道理，如果消费者端因为业务异常消费失败了，它也把offset上传了。<br>3、如果是这样的话，自动提交还有什么业务价值呢？<br>求老师解惑，谢谢","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465606,"discussion_content":"1. 不是，是因为每个线程无法顾忌其他线程的消费进度\n2. 单线程不会的，毕竟只有一个线程嘛。\n3. 自动提交简单方便，还能够自动重试","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567386172,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":127529,"user_name":"安静","can_delete":false,"product_type":"c1","uid":1212634,"ip_address":"","ucode":"7C4DB6D81A48EB","user_header":"https://static001.geekbang.org/account/avatar/00/12/80/da/9c0c458c.jpg","comment_is_top":false,"comment_ctime":1566735154,"is_pvip":false,"replies":[{"id":"47264","content":"自动提交有其应用的场景。如果你并不在乎消息重复的话，使用自动提交是很省事的做法。","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1566780996,"ip_address":"","comment_id":127529,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5861702450","product_id":100029201,"comment_content":"问个问题，为什么强调只有在多线程消费的时候要将自动提交改成手动提交，按照我的理解消费程序其实都应该将自动提交改成手动提交，这边有什么考虑吗？","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":464536,"discussion_content":"自动提交有其应用的场景。如果你并不在乎消息重复的话，使用自动提交是很省事的做法。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566780996,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":127330,"user_name":"知行合一","can_delete":false,"product_type":"c1","uid":1090784,"ip_address":"","ucode":"563C4A71D80DA1","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJwQvLGE4dMsF4JU0svW3DtGbodpjskbY65FdwF13JdtBYZfgL2IXHlHrdejWzHdjT0RibEIfib4QYA/132","comment_is_top":false,"comment_ctime":1566656360,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5861623656","product_id":100029201,"comment_content":"老师，课后问题会出一节课统一解答吗","like_count":1,"discussions":[{"author":{"id":1134861,"avatar":"https://static001.geekbang.org/account/avatar/00/11/51/0d/fc1652fe.jpg","nickname":"James","note":"","ucode":"48B0F2A334D1C1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":49427,"discussion_content":"即可时间专栏基本不会","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573578377,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":123711,"user_name":"钱","can_delete":false,"product_type":"c1","uid":1009652,"ip_address":"","ucode":"2C92A243A463D4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg","comment_is_top":false,"comment_ctime":1565746075,"is_pvip":false,"replies":[{"id":"45641","content":"最新位移就是1了，因为此时分区1的最新位移已经变更为1了","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1565876516,"ip_address":"","comment_id":123711,"utype":1}],"discussion_count":3,"race_medal":0,"score":"5860713371","product_id":100029201,"comment_content":"当增加主题分区后，在某段“不凑巧”的时间间隔后，Producer 先于 Consumer 感知到新增加的分区，而 Consumer 设置的是“从最新位移处”开始读取消息，因此在 Consumer 感知到新分区前，Producer 发送的这些消息就全部“丢失”了，或者说 Consumer 无法读取到这些消息。<br>这段描述没太明白，假如现在只有一个分区0，新增了一个分区1，并且producer先感知且向这个分区写入了一个消息，在分区的开始位置0，consumer随后也感知到了，从最新位移处开始读，这个最新位移处指哪里？consumer不是从分区1的位置0消费消息的嘛？","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":462782,"discussion_content":"最新位移就是1了，因为此时分区1的最新位移已经变更为1了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565876516,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1134861,"avatar":"https://static001.geekbang.org/account/avatar/00/11/51/0d/fc1652fe.jpg","nickname":"James","note":"","ucode":"48B0F2A334D1C1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":49428,"discussion_content":"马克","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573578659,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1009652,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg","nickname":"钱","note":"","ucode":"2C92A243A463D4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":5031,"discussion_content":"多谢老师的答疑","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565881793,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":116824,"user_name":"燕羽阳","can_delete":false,"product_type":"c1","uid":1015063,"ip_address":"","ucode":"AF9430187F66EE","user_header":"https://static001.geekbang.org/account/avatar/00/0f/7d/17/179b24f4.jpg","comment_is_top":false,"comment_ctime":1563929898,"is_pvip":false,"replies":[{"id":"42900","content":"无法知道了。。。","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1564015802,"ip_address":"","comment_id":116824,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5858897194","product_id":100029201,"comment_content":"老师，请教一个问题，producer发送一条消息，broker正常commit，但是由于producer挂了，producer没收到响应。producer重新启动后，如何知道上次消息的发送结果?","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":459697,"discussion_content":"无法知道了。。。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564015802,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":114997,"user_name":"野性力量","can_delete":false,"product_type":"c1","uid":1578718,"ip_address":"","ucode":"B6C152FA332B14","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/diaGeaLuw3oTAcyFMnkiaVur33RXdUZL8z1LtfHibIyh4r629YSexJQz5JXYjBH7v9rwHH7ham5CzqDZF75QnGIwg/132","comment_is_top":false,"comment_ctime":1563446603,"is_pvip":false,"replies":[{"id":"41997","content":"发送失败后会拉取最新的元数据，然后获知新的leader","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1563458849,"ip_address":"","comment_id":114997,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5858413899","product_id":100029201,"comment_content":"producer实例化的时候需要指定所有topic相关的leader broker的IP，那么发生重新选主，producer如何知道新主的IP并进行路由呢？","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":458921,"discussion_content":"发送失败后会拉取最新的元数据，然后获知新的leader","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563458849,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":113055,"user_name":"外星人","can_delete":false,"product_type":"c1","uid":1132861,"ip_address":"","ucode":"D8469B13F2AB37","user_header":"https://static001.geekbang.org/account/avatar/00/11/49/3d/4ac37cc2.jpg","comment_is_top":false,"comment_ctime":1562892361,"is_pvip":false,"replies":[{"id":"41137","content":"1. 可以设置成2，只是任何副本就不能挂了，否则就不能用了<br>2. 感觉是flink对kafka leader变更没有生效导致的，和kafka关系不大","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1562893974,"ip_address":"","comment_id":113055,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5857859657","product_id":100029201,"comment_content":"你好，有两个问题请教下您。<br>1. 我们生产上有的topic的replica是2，那min.insync.replica是不是就不适合设置为2了？<br>2. 我们在用flink两阶段提交时，发现，在重启broker时，任务会报错：the server is not the leader for that topic-partition，请问下是为什么啊？我看逻辑开始事务retries会设置为int.max，我们的客户端版本是011","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":458037,"discussion_content":"1. 可以设置成2，只是任何副本就不能挂了，否则就不能用了\n2. 感觉是flink对kafka leader变更没有生效导致的，和kafka关系不大","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562893974,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":109301,"user_name":"王志杰","can_delete":false,"product_type":"c1","uid":1074791,"ip_address":"","ucode":"DAC170C33EDDCF","user_header":"https://static001.geekbang.org/account/avatar/00/10/66/67/85709c6b.jpg","comment_is_top":false,"comment_ctime":1561994864,"is_pvip":false,"replies":[{"id":"39590","content":"嗯嗯，实际使用过程中的确延时会增加很多，主要是follower异步拉取需要花费很长的时间","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1562028007,"ip_address":"","comment_id":109301,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5856962160","product_id":100029201,"comment_content":"acks=all，那性能不是下降很厉害了？","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":456344,"discussion_content":"嗯嗯，实际使用过程中的确延时会增加很多，主要是follower异步拉取需要花费很长的时间","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562028007,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":107968,"user_name":"guoyinbo2019","can_delete":false,"product_type":"c1","uid":1445399,"ip_address":"","ucode":"19D86CB3E42839","user_header":"https://static001.geekbang.org/account/avatar/00/16/0e/17/e16e679f.jpg","comment_is_top":false,"comment_ctime":1561642283,"is_pvip":false,"replies":[{"id":"39123","content":"1、replication.factor用于确定副本数。该参数本身不会减少。#ISR  &lt; replication.factor时也是可以正常工作的，只要#ISR &gt;= min.insync.replicas即可。<br>2、min.insync.replicas限定了最少要写入ISR副本的个数，它 和acks=all不矛盾。<br>3、嗯嗯，差不多。关键是这种情况下我们到底应该提交哪个位移合适？提交1，那么offset=2的消息有可能重试；提交2，那么offset=1的消息可能丢失。","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1561680443,"ip_address":"","comment_id":107968,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5856609579","product_id":100029201,"comment_content":"胡老师，我有以下两个疑问<br>一、关于最佳实践<br>2、设置ack=all，这里的all指的任一时刻下所有存活的follower 么?比如开始follower=3，当有一台副本挂掉是，ack=all意味着follower=2<br>5、  replication.factor &gt;= 3，设置副本个数吧，如果由于副本所在broker挂了，这个参数检测会自动减少么？<br>例如：设置replication.factor = 3，有3台broker，若有一台broker挂了，kafka会如何处理，会按照replication.factor = 2进行同步数据么， 还是当发现副本数&lt; replication.factor的时候就不能正常工作， 还是其他什么策略呢？<br>6、min.insync.replicas &gt; 1 这个会和上面参数矛盾么<br>以上几个 参数都参与的“已提交”的定义，当参数不能全部满足的时候，这个“已提交”是怎么定义的呢，<br>各参数在“已提交”定义中是否有优先级呢，如有，优先级是什么呢？<br>二、关于单consumer，多线程消费问题<br>对于老师说的“避免无消费消息丢失很简单，但极易出现消息被消费了多次的情况。”有些不理解<br>我认为单consumer，多线程消费时候容易产生消息丢失<br>例如一个consumer2个线程，thread1消费offset=1 消息，thread2消费offset=2 消息，thread2很快处理完了消息并成功提交了offset, 但是thread1由于某种原因处理失败了，此时offset=1 的消息对于consumer来说就丢了。<br>不知道理解的对不对，还请老师解答。<br>","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":455765,"discussion_content":"1、replication.factor用于确定副本数。该参数本身不会减少。#ISR  &amp;lt; replication.factor时也是可以正常工作的，只要#ISR &amp;gt;= min.insync.replicas即可。\n2、min.insync.replicas限定了最少要写入ISR副本的个数，它 和acks=all不矛盾。\n3、嗯嗯，差不多。关键是这种情况下我们到底应该提交哪个位移合适？提交1，那么offset=2的消息有可能重试；提交2，那么offset=1的消息可能丢失。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561680443,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1547667,"avatar":"https://static001.geekbang.org/account/avatar/00/17/9d/93/4159edaa.jpg","nickname":"朴素柠檬c","note":"","ucode":"2D4CBB70D801B1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":328907,"discussion_content":"老师 第三个回答 就是 其实多线程消费 offset根本不固定，可能出现丢失和重复消费","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606269721,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":107744,"user_name":"Icedmaze","can_delete":false,"product_type":"c1","uid":1104245,"ip_address":"","ucode":"DC05117685CAB5","user_header":"https://static001.geekbang.org/account/avatar/00/10/d9/75/3598e0de.jpg","comment_is_top":false,"comment_ctime":1561602849,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5856570145","product_id":100029201,"comment_content":"目前想到的方法有两种<br>一种是在消费端初始化的时候配置“从新位移处开始消费”，当各个分区记录了位移信息后，再将配置改为“从最早位移处开始消费”策略，利用已产生了标志位的分区不受消费策略影响的特性，保证在之后的业务中，新增分区都不会产生“丢失”问题。<br>第二种方法是当新增分区后，利用消费端会产生rebalance事件的特性，可以在rebalance的时候判断该分区有无消费位移，如果无位移位，则强制将位移位设置为0从头开始消费。（该方法纯属猜测）","like_count":1,"discussions":[{"author":{"id":1104245,"avatar":"https://static001.geekbang.org/account/avatar/00/10/d9/75/3598e0de.jpg","nickname":"Icedmaze","note":"","ucode":"DC05117685CAB5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":469,"discussion_content":"还有评论中提到的新增分区的的时候，暂停消费端的方法，个人认为并不是一个很好的选择，因为本质上这会导致每次新增一个分区，都需要对消费端进行暂停操作，如果该主题有许多消费者的话，每次新增分区都会很容易出现问题。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561605004,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":107662,"user_name":"黑崽","can_delete":false,"product_type":"c1","uid":1024159,"ip_address":"","ucode":"F31A4102EE4DA8","user_header":"https://static001.geekbang.org/account/avatar/00/0f/a0/9f/71345740.jpg","comment_is_top":false,"comment_ctime":1561594654,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5856561950","product_id":100029201,"comment_content":"好问题.很多人没有意识到这个问题，解决方案两种，一个是从最老消费者，另外可以rebalance时候做。由从最老消费在首次启动可能导致pagecache in&#47;out增多，吞吐下降，所以我们选择在rebalance时候做","like_count":1},{"had_liked":false,"id":107656,"user_name":"坤蛰","can_delete":false,"product_type":"c1","uid":1285244,"ip_address":"","ucode":"48C1616B27A99F","user_header":"https://static001.geekbang.org/account/avatar/00/13/9c/7c/c92f8a53.jpg","comment_is_top":false,"comment_ctime":1561594043,"is_pvip":false,"replies":[{"id":"38928","content":"它们都是帮助提升消息持久化程度用的","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1561595741,"ip_address":"","comment_id":107656,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5856561339","product_id":100029201,"comment_content":"老师，ack是不是针对的broker级别，而min.insync.replica 针对的是分区下的副本？","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":455609,"discussion_content":"它们都是帮助提升消息持久化程度用的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561595741,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":107651,"user_name":"玉剑冰锋","can_delete":false,"product_type":"c1","uid":1214202,"ip_address":"","ucode":"8EA56A71BA5B22","user_header":"https://static001.geekbang.org/account/avatar/00/12/86/fa/4bcd7365.jpg","comment_is_top":false,"comment_ctime":1561593284,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5856560580","product_id":100029201,"comment_content":"老师好，针对producer为filebeat有什么是建议配置的吗？我们生产好像没有配置这方面的参数","like_count":1},{"had_liked":false,"id":357836,"user_name":"tuyu","can_delete":false,"product_type":"c1","uid":1448863,"ip_address":"浙江","ucode":"B235325B541408","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/BIRpwViaN51yynIeFonD7QRlwDCVtKibrG956NTxzEqibOZZVjhMMgibOPmd3VicfYxpknZsic1oJq8KicZvXkmmiajuQg/132","comment_is_top":false,"comment_ctime":1663670267,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1663670267","product_id":100029201,"comment_content":"&quot;假如你的消息保存在 N 个 Kafka Broker 上，那么这个前提条件就是这 N 个 Broker 中至少有 1 个存活。只要这个条件成立，Kafka 就能保证你的这条消息永远不会丢失&quot;, 如果是leader挂了, 那岂不是要丢失, 只有一个follower存活","like_count":0},{"had_liked":false,"id":346746,"user_name":"有点怀旧","can_delete":false,"product_type":"c1","uid":2727663,"ip_address":"","ucode":"C774EEF86D181B","user_header":"https://static001.geekbang.org/account/avatar/00/29/9e/ef/b5c9f52e.jpg","comment_is_top":false,"comment_ctime":1653395072,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1653395072","product_id":100029201,"comment_content":"老师有没有利用python来实现利用kafka的学习资料","like_count":0},{"had_liked":false,"id":344724,"user_name":"小菜鸟","can_delete":false,"product_type":"c1","uid":1256026,"ip_address":"","ucode":"3210C8528E1912","user_header":"https://static001.geekbang.org/account/avatar/00/13/2a/5a/da723ac4.jpg","comment_is_top":false,"comment_ctime":1651739145,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1651739145","product_id":100029201,"comment_content":"有个疑问，看文章说到的消息丢失主要还是“使用姿势”不对的原因导致的，但从broker落盘机制看，写入pagecache,系统刷盘以前，如果出现宕机，不也会造成消息丢失么","like_count":0},{"had_liked":false,"id":339809,"user_name":"i_chase","can_delete":false,"product_type":"c1","uid":1795511,"ip_address":"","ucode":"09C41C863F4EA3","user_header":"https://static001.geekbang.org/account/avatar/00/1b/65/b7/058276dc.jpg","comment_is_top":false,"comment_ctime":1648397120,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1648397120","product_id":100029201,"comment_content":"最后的思考题有答案吗","like_count":0},{"had_liked":false,"id":339460,"user_name":"夏天","can_delete":false,"product_type":"c1","uid":2542376,"ip_address":"","ucode":"5F224DDAC94DFF","user_header":"https://static001.geekbang.org/account/avatar/00/26/cb/28/21a8a29e.jpg","comment_is_top":false,"comment_ctime":1648112820,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1648112820","product_id":100029201,"comment_content":"acks<br>The number of acknowledgments the producer requires the leader to have received before considering a request complete. This controls the durability of records that are sent. The following settings are allowed:<br><br>acks=0 If set to zero then the producer will not wait for any acknowledgment from the server at all. The record will be immediately added to the socket buffer and considered sent. No guarantee can be made that the server has received the record in this case, and the retries configuration will not take effect (as the client won&#39;t generally know of any failures). The offset given back for each record will always be set to -1.<br>acks=1 This will mean the leader will write the record to its local log but will respond without awaiting full acknowledgement from all followers. In this case should the leader fail immediately after acknowledging the record but before the followers have replicated it then the record will be lost.<br>acks=all This means the leader will wait for the full set of in-sync replicas to acknowledge the record. This guarantees that the record will not be lost as long as at least one in-sync replica remains alive. This is the strongest available guarantee. This is equivalent to the acks=-1 setting.<br><br>acks 0 表示 producer 不等待确认。写到缓冲区就返回。<br><br>acks 1 表示 partion leader 落盘后返回<br><br>acks all（-1） 表示 partion leader 落盘 + followers 同步后返回","like_count":0},{"had_liked":false,"id":336581,"user_name":"王大喵","can_delete":false,"product_type":"c1","uid":1109528,"ip_address":"","ucode":"C14AAE3ED964DE","user_header":"https://static001.geekbang.org/account/avatar/00/10/ee/18/65e89d9c.jpg","comment_is_top":false,"comment_ctime":1646224401,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1646224401","product_id":100029201,"comment_content":"consumer在进行分区rebalance时，如果是新增分区，先去获取offset值，如果没有就从最早的开始消费。<br>","like_count":0},{"had_liked":false,"id":327028,"user_name":"松鼠鱼","can_delete":false,"product_type":"c1","uid":1815185,"ip_address":"","ucode":"C0E87CCF71DB44","user_header":"","comment_is_top":false,"comment_ctime":1639854705,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1639854705","product_id":100029201,"comment_content":"老师，当producer因为网络抖动retry某一条消息的时候，是不是消息的顺序就没办法保证了？","like_count":0},{"had_liked":false,"id":325440,"user_name":"追风筝的人","can_delete":false,"product_type":"c1","uid":1488020,"ip_address":"","ucode":"2993D60F94C396","user_header":"https://static001.geekbang.org/account/avatar/00/16/b4/94/2796de72.jpg","comment_is_top":false,"comment_ctime":1638957209,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1638957209","product_id":100029201,"comment_content":"设置 acks = all<br>使用 producer.send(msg, callback)","like_count":0},{"had_liked":false,"id":325427,"user_name":"追风筝的人","can_delete":false,"product_type":"c1","uid":1488020,"ip_address":"","ucode":"2993D60F94C396","user_header":"https://static001.geekbang.org/account/avatar/00/16/b4/94/2796de72.jpg","comment_is_top":false,"comment_ctime":1638955521,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1638955521","product_id":100029201,"comment_content":"Kafka 只对“已提交”的消息（committed message）做有限度的持久化保证。","like_count":0},{"had_liked":false,"id":324408,"user_name":"独孤九剑","can_delete":false,"product_type":"c1","uid":2230909,"ip_address":"","ucode":"6C1253E2B8C1D4","user_header":"https://static001.geekbang.org/account/avatar/00/22/0a/7d/ac715471.jpg","comment_is_top":false,"comment_ctime":1638418574,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1638418574","product_id":100029201,"comment_content":"消息无丢失.配置(生产者&amp;消费者&amp;服务端).关键点总结为一句话：发送+接收+写入+冗余+不要自动提交“消费位移”","like_count":0},{"had_liked":false,"id":321446,"user_name":"Geek_f9d469","can_delete":false,"product_type":"c1","uid":2842794,"ip_address":"","ucode":"0A14D20CB927F6","user_header":"","comment_is_top":false,"comment_ctime":1636880704,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1636880704","product_id":100029201,"comment_content":"老师，请教个问题：<br>问题背景：有一个 topic 开了三个分区，有两个消费组 g1 和 g2，每个消费组有三个 KafkaConsumer，最开始启动消费组 g1 消费，offset 设置成 earliest。消费一段时间后，开启了消费组 g2，offset 设置成 <br> lastest。消费组 g1 和 g2 共同消费了一段时间后， 把消费组 g1 关闭，剩下 g2 在消费，但此时出现了消息丢失的情况。<br>请教下老师，这个是什么原因导致的消息丢失的，总感觉这种思路不会出现消息丢失的情况。 ","like_count":0},{"had_liked":false,"id":320896,"user_name":"👀","can_delete":false,"product_type":"c1","uid":1979938,"ip_address":"","ucode":"6CE9845298DC4D","user_header":"https://static001.geekbang.org/account/avatar/00/1e/36/22/c0b183ab.jpg","comment_is_top":false,"comment_ctime":1636546536,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1636546536","product_id":100029201,"comment_content":"Kafka 消费者是处理完消息才提交位移吧，所以自动提交不会出现丢消息","like_count":0},{"had_liked":false,"id":317728,"user_name":"KW💤","can_delete":false,"product_type":"c1","uid":1109389,"ip_address":"","ucode":"290DD7016F4EE0","user_header":"https://static001.geekbang.org/account/avatar/00/10/ed/8d/377c106a.jpg","comment_is_top":false,"comment_ctime":1634905228,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1634905228","product_id":100029201,"comment_content":"最后那个问题可以通过配置让producer先不发消息到新增的分区，待comsumer感应到了新分区，再放开producer。不然只能zk记录每个consumer group消费的消息位移量。但其实这是个业务问题，你很难说清楚正确性，假如我现在新加一个consumer group，这个新业务是希望处理从2021年12月12日12时12分开始的新数据的，你从11分开始部署消费端应用，预计11分30秒启动完成，11分30秒到12分这段数据通过消息业务时间戳过滤掉，但实际启动完成却是13分了，那12-13分的数据你怎么获取，这个偏移量很难确定","like_count":0},{"had_liked":false,"id":309325,"user_name":"Leo","can_delete":false,"product_type":"c1","uid":2649276,"ip_address":"","ucode":"CEBAD9CDCFC2A3","user_header":"https://static001.geekbang.org/account/avatar/00/28/6c/bc/f751786b.jpg","comment_is_top":false,"comment_ctime":1630048436,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1630048436","product_id":100029201,"comment_content":"1. ack=all&#47;-1指的是ISR集中的副本，而不是所有的副本；只要让ISR集中的副本全部写入就算成功，注意不是所有副本，这点文章中表述的不够清楚； <br>2. 一定要让 replication.factor（所有副本数量） &gt; min.insync.replicas（ISR集中最小数量）是因为：如果这两数相等，那么当ack = all时，有一个副本宕机了，从而达不到min.insync.replicas的数量就永远不会call back success;<br>3. 一般来说min.insync.replicas &gt;= 2的，因为ISR集中若只有一个副本那么就无法组成Leader-Follow,一台副本若写入后宕机了那么数据丢失，就不是高可用了；","like_count":0},{"had_liked":false,"id":305039,"user_name":"Geek6784","can_delete":false,"product_type":"c1","uid":2131762,"ip_address":"","ucode":"89F7946E503F45","user_header":"","comment_is_top":false,"comment_ctime":1627787662,"is_pvip":false,"replies":[{"id":"112541","content":"嗯嗯，是的，因为本来也不是要说这两件事","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1630810948,"ip_address":"","comment_id":305039,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1627787662","product_id":100029201,"comment_content":"这里说的太浅了。异步发送的原理和实现是如何 高低水位也没说","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":524257,"discussion_content":"嗯嗯，是的，因为本来也不是要说这两件事","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630810948,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":304288,"user_name":"tofree p","can_delete":false,"product_type":"c1","uid":1406870,"ip_address":"","ucode":"87803554C253EA","user_header":"https://static001.geekbang.org/account/avatar/00/15/77/96/20eac387.jpg","comment_is_top":false,"comment_ctime":1627316005,"is_pvip":false,"replies":[{"id":"110338","content":"max.in.flight.requests.per.connection = 1<br>","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1627784626,"ip_address":"","comment_id":304288,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1627316005","product_id":100029201,"comment_content":"老师，你好，我想请教一个问题，就是kafka有批量发送功能，如果ack=1，在批量发送中如果发生了错误，导致某一条消息重新发送，这样的话消息的顺序乱了，有没有办法能用批量发送并且保证消息不乱呢","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":524002,"discussion_content":"max.in.flight.requests.per.connection = 1\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627784626,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":302466,"user_name":"出卖灵魂的教练Kerry","can_delete":false,"product_type":"c1","uid":1807943,"ip_address":"","ucode":"8C64517DA556FE","user_header":"https://static001.geekbang.org/account/avatar/00/1b/96/47/93838ff7.jpg","comment_is_top":false,"comment_ctime":1626232183,"is_pvip":true,"replies":[{"id":"110336","content":"针对的是多个副本能够增加高可用这件事","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1627784500,"ip_address":"","comment_id":302466,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1626232183","product_id":100029201,"comment_content":"老师你好，总结中56不是很明白，6针对的是ISR，那5呢？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":523317,"discussion_content":"针对的是多个副本能够增加高可用这件事","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627784500,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":299453,"user_name":"沐紫流光","can_delete":false,"product_type":"c1","uid":1950907,"ip_address":"","ucode":"ECD078ADAF0711","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83er6REjFuP7zicRdA4sm4w8H046bgNpCQ6odSJLxDV3FicRaxDzQTk2fviaGnKFAGUcFQcOZ5WANqEZDQ/132","comment_is_top":false,"comment_ctime":1624631328,"is_pvip":true,"discussion_count":0,"race_medal":1,"score":"1624631328","product_id":100029201,"comment_content":"关于acks = all 和 min.insync.replicas 的问题<br>实际副本（ISR） &gt; min.insync.replicas，acks = all起作用<br>实际副本 (ISR) &lt; min.insync.replicas，min.insync.replicas 起作用","like_count":0},{"had_liked":false,"id":289788,"user_name":"liian2019","can_delete":false,"product_type":"c1","uid":1503741,"ip_address":"","ucode":"22F639944F0EA0","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epvjpicXzEv02d9ztRzIWIicbejyFTTtRA5K6oYmdicq9HQgGfRn3DLytTHQ6CHspb0TibqFkMibhBXj2g/132","comment_is_top":false,"comment_ctime":1619174809,"is_pvip":true,"replies":[{"id":"105283","content":"没有提交位移；位移数据被删除","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1619599814,"ip_address":"","comment_id":289788,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1619174809","product_id":100029201,"comment_content":"想请教一下，某个partition 的consumer offset 自动重置为0了，可能会是哪些方面的原因","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":519019,"discussion_content":"没有提交位移；位移数据被删除","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619599814,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":285803,"user_name":"beifengzhishen001","can_delete":false,"product_type":"c1","uid":2109853,"ip_address":"","ucode":"77D42B7DD9E754","user_header":"","comment_is_top":false,"comment_ctime":1617016825,"is_pvip":false,"replies":[{"id":"104161","content":"“该方法返回意味着producer只做了一次写操作，可能成功也可能失败，如果失败也会立刻返回send方法，producer会在随后静默地尝试重传（这样似乎就偏离了客户端写程序的主逻辑了，感觉应该不是后一种处理）”  --- 目前的设计更加贴合你的这种说法。","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1617671269,"ip_address":"","comment_id":285803,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1617016825","product_id":100029201,"comment_content":"【目前 Kafka Producer 是异步发送消息的，也就是说如果你调用的是 producer.send(msg) 这个 API，那么它通常会立即返回，但此时你不能认为消息发送已成功完成。】<br>这里我有个疑惑，当send(msg)返回时，是否意味着即使中间发生了失败，producer也已经按照重试参数的配置做了重写的操作，只是producer并不知道重试后最终有没有写入成功？还是说，该方法返回意味着producer只做了一次写操作，可能成功也可能失败，如果失败也会立刻返回send方法，producer会在随后静默地尝试重传（这样似乎就偏离了客户端写程序的主逻辑了，感觉应该不是后一种处理）？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":517786,"discussion_content":"“该方法返回意味着producer只做了一次写操作，可能成功也可能失败，如果失败也会立刻返回send方法，producer会在随后静默地尝试重传（这样似乎就偏离了客户端写程序的主逻辑了，感觉应该不是后一种处理）”  --- 目前的设计更加贴合你的这种说法。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617671269,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":285002,"user_name":"鸣己","can_delete":false,"product_type":"c1","uid":2313382,"ip_address":"","ucode":"4FC0C37457F21A","user_header":"https://static001.geekbang.org/account/avatar/00/23/4c/a6/e6f1d773.jpg","comment_is_top":false,"comment_ctime":1616574659,"is_pvip":false,"replies":[{"id":"103530","content":"从最早消费是比较安全和保守的做法","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1616721445,"ip_address":"","comment_id":285002,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1616574659","product_id":100029201,"comment_content":"当增加主题分区后，在某段“不凑巧”的时间间隔后，Producer 先于 Consumer 感知到新增加的分区，而 Consumer 设置的是“从最新位移处”开始读取消息，因此在 Consumer 感知到新分区前，Producer 发送的这些消息就全部“丢失”了，或者说 Consumer 无法读取到这些消息？<br><br>1）从最早消费；<br>2）假如现在三个分区，分别有三个消费者分配到每个分区；我要增加2个分区；可不可以提前多启动两个空闲消费者等待消费？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":517548,"discussion_content":"从最早消费是比较安全和保守的做法","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1616721445,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":284241,"user_name":"猪大强","can_delete":false,"product_type":"c1","uid":1542577,"ip_address":"","ucode":"2DD393D247798C","user_header":"https://static001.geekbang.org/account/avatar/00/17/89/b1/9f9cfc19.jpg","comment_is_top":false,"comment_ctime":1616133311,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1616133311","product_id":100029201,"comment_content":"还未flush到磁盘就返回还是flush到磁盘才返回，如果flush到磁盘才返回，明显性能有问题","like_count":0},{"had_liked":false,"id":281586,"user_name":"沈杰","can_delete":false,"product_type":"c1","uid":1330032,"ip_address":"","ucode":"17E314B07844F4","user_header":"https://static001.geekbang.org/account/avatar/00/14/4b/70/33137826.jpg","comment_is_top":false,"comment_ctime":1614820488,"is_pvip":false,"replies":[{"id":"102224","content":"后面又写了一篇，可以看下：https:&#47;&#47;www.cnblogs.com&#47;huxi2b&#47;p&#47;13668061.html","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1614821620,"ip_address":"","comment_id":281586,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1614820488","product_id":100029201,"comment_content":"单应用多线程提交的场景使用应该挺多的吧，有没有最佳实践啊","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":516446,"discussion_content":"后面又写了一篇，可以看下：https://www.cnblogs.com/huxi2b/p/13668061.html","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1614821620,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":269655,"user_name":"Geek_c1529b","can_delete":false,"product_type":"c1","uid":2109369,"ip_address":"","ucode":"499C770AA15ADA","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eo2nk9s8GOOf9YRlp25PIiaLjib3X6XwY7AnTibHDc0AibZlmtWKaYtlSkQsmicclf5mNGyYZcXEOFhGhQ/132","comment_is_top":false,"comment_ctime":1608728752,"is_pvip":false,"replies":[{"id":"97801","content":"你把超时时间设置成了0了吗？","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1608772671,"ip_address":"","comment_id":269655,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1608728752","product_id":100029201,"comment_content":"生产者会有“failed to update metadata after 0 ms”异常，请问可能会是什么原因呀？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":512346,"discussion_content":"你把超时时间设置成了0了吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608772671,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":266917,"user_name":"闪闪电电","can_delete":false,"product_type":"c1","uid":1140876,"ip_address":"","ucode":"FA5520FA98F739","user_header":"https://static001.geekbang.org/account/avatar/00/11/68/8c/b1f277a5.jpg","comment_is_top":false,"comment_ctime":1607525034,"is_pvip":true,"replies":[{"id":"96917","content":"主要是哪方面的性能下降呢？能欧服详细说说","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1607561983,"ip_address":"","comment_id":266917,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1607525034","product_id":100029201,"comment_content":"老师您好！请教下，我有个单机版kafka环境在实际运行一段时间后，性能明显降低，重启kafka进程之后又能明显提升性能，这里的原因是什么？ 属于那个章节的知识点？希望能提点下。感谢。<br>","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":511444,"discussion_content":"主要是哪方面的性能下降呢？能欧服详细说说","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1607561983,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":263014,"user_name":"那么丶神秘美丽","can_delete":false,"product_type":"c1","uid":1388334,"ip_address":"","ucode":"58B6F2182E946B","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLhxLmNxIbicllknrM46np5h2jpTZt1COP6X3aica1cbgsge5woIJP70HG3hMFyBmTRHn3zj9jXrdPg/132","comment_is_top":false,"comment_ctime":1605948084,"is_pvip":false,"replies":[{"id":"96053","content":"1. 是的<br>2. “Leader是指领导者副本的那个Broker吗？” -- 是的。“是指一个Broker上的追随者副本落后领导者副本太多吗” -- 是的<br>3. 分区不是为了高可用，副本机制才是。也就是一个分区会有多个副本，每个副本保存相同的内容。追随者副本会被动地同步leader副本中的数据","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1606699565,"ip_address":"","comment_id":263014,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1605948084","product_id":100029201,"comment_content":"老师，我有三个问题：<br>1：当 Kafka 的若干个 Broker 成功地接收到一条消息并写入到日志文件后，它们会告诉生产者程序这条消息已成功提交-这里面提到的多个Broker成功接收到一条消息，是指，其中一个Broker是领导者副本，剩下的Broker是追随者副本吗？<br>2：这是 Broker 端的参数，它控制的是哪些 Broker 有资格竞选分区的 Leader。如果一个 Broker 落后原先的 Leader 太多，那么它一旦成为新的 Leader，必然会造成消息的丢失-Leader是指领导者副本的那个Broker吗？这里的落后太多，是指一个Broker上的追随者副本落后领导者副本太多吗？<br>3：我对分区和副本的理解是这样的-类比Redis的Cluster，所有的数据根据一定规则被存放在不同的实例上，为了保证每个实例的高可用，每个实例会配一个从库。对于Kafka，数据存放在不用的分区上，为了保证高可用，分区存放于不同的Broker上，每个分区的数据在配置至少一个追随者副本。不过，我看老师02章最后的图，每个分区的追随者副本会复用其他的Broker","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":510070,"discussion_content":"1. 是的\n2. “Leader是指领导者副本的那个Broker吗？” -- 是的。“是指一个Broker上的追随者副本落后领导者副本太多吗” -- 是的\n3. 分区不是为了高可用，副本机制才是。也就是一个分区会有多个副本，每个副本保存相同的内容。追随者副本会被动地同步leader副本中的数据","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606699565,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":259042,"user_name":"慎独明强","can_delete":false,"product_type":"c1","uid":1965699,"ip_address":"","ucode":"DC2F7F2C0C8F60","user_header":"https://static001.geekbang.org/account/avatar/00/1d/fe/83/df562574.jpg","comment_is_top":false,"comment_ctime":1604622897,"is_pvip":false,"replies":[{"id":"94220","content":"嗯嗯，实际场景还是以测试结果为准：）<br>","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1604625266,"ip_address":"","comment_id":259042,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1604622897","product_id":100029201,"comment_content":"对于老师最后的一个隐秘丢消息场景，还需要自己去看资料去验证。如果按上述场景，那么就出现新的topic上线时，消费者没启动，这段时间的消息不会积压，直接就丢了。没有消费进度就应该从头开始消费(磁盘现存有消息的第一条消息开始)。  如果真有这种场景，先启动consumer服务器，再上线producer服务来规避这种情况。","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":508823,"discussion_content":"嗯嗯，实际场景还是以测试结果为准：）\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604625266,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":250993,"user_name":"timmy21","can_delete":false,"product_type":"c1","uid":1174860,"ip_address":"","ucode":"9D6DED247B1F38","user_header":"https://static001.geekbang.org/account/avatar/00/11/ed/4c/8674b6ad.jpg","comment_is_top":false,"comment_ctime":1601300747,"is_pvip":false,"replies":[{"id":"91821","content":"提交的位移会过期。一旦被清理，从哪里消费取决于auto.offset.reset参数值","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1601343230,"ip_address":"","comment_id":250993,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1601300747","product_id":100029201,"comment_content":"如果长时间不消费，提交的位移会过期吗？或者提交的位移的数据被清理了，下次启动重新消费时从什么位移开始消费？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":506358,"discussion_content":"提交的位移会过期。一旦被清理，从哪里消费取决于auto.offset.reset参数值","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1601343230,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":245451,"user_name":"杯莫停","can_delete":false,"product_type":"c1","uid":1759325,"ip_address":"","ucode":"4FA1D5CBBEF702","user_header":"https://static001.geekbang.org/account/avatar/00/1a/d8/5d/07dfb3b5.jpg","comment_is_top":false,"comment_ctime":1598947796,"is_pvip":true,"replies":[{"id":"90398","content":"是的","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1599096259,"ip_address":"","comment_id":245451,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1598947796","product_id":100029201,"comment_content":"min.insync.replicas是包括Leader在内的吗？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":504883,"discussion_content":"是的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599096259,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":244394,"user_name":"nestle","can_delete":false,"product_type":"c1","uid":1762252,"ip_address":"","ucode":"469800BED81B54","user_header":"https://static001.geekbang.org/account/avatar/00/1a/e3/cc/0947ff0b.jpg","comment_is_top":false,"comment_ctime":1598503448,"is_pvip":false,"replies":[{"id":"90150","content":"有关系。acks=1的话，消息只要写入leader副本就算是已提交。如果等于-1或all，那么必须要写入ISR所有副本才算是已提交","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1598836747,"ip_address":"","comment_id":244394,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1598503448","product_id":100029201,"comment_content":"请教个问题，消息已提交的定义应该是明确的，就是所有ISR写成功，是不是跟acks没太多关系呢？acks配置应该是定义了Producer发送成功的标准吧？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":504572,"discussion_content":"有关系。acks=1的话，消息只要写入leader副本就算是已提交。如果等于-1或all，那么必须要写入ISR所有副本才算是已提交","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598836747,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":242989,"user_name":"单朋荣","can_delete":false,"product_type":"c1","uid":1272662,"ip_address":"","ucode":"8AD121BEDD9675","user_header":"https://static001.geekbang.org/account/avatar/00/13/6b/56/37a4cea7.jpg","comment_is_top":false,"comment_ctime":1597912409,"is_pvip":false,"replies":[{"id":"89603","content":"嗯，可行的。其实就是看producer和consumer怎么协调了。关键是不要丢失数据：）","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1597971509,"ip_address":"","comment_id":242989,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1597912409","product_id":100029201,"comment_content":"开发讨论：如果我是设计者，我会比对下“新建”topic时，Producer感知（看作写入）时间戳，以及感知该topic的时间戳，如果前者小于后者，就重头读；否则，就从“最新位置处”读。这样设计的原因时，producer、consumer不会相互通信，要是借助引擎来协调会麻烦；所以，直接在消费端处理，会更有效些，胡老师觉得呢？？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":504149,"discussion_content":"嗯，可行的。其实就是看producer和consumer怎么协调了。关键是不要丢失数据：）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597971509,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":242647,"user_name":"88591","can_delete":false,"product_type":"c1","uid":1254656,"ip_address":"","ucode":"04CE3E46455185","user_header":"https://static001.geekbang.org/account/avatar/00/13/25/00/3afbab43.jpg","comment_is_top":false,"comment_ctime":1597803835,"is_pvip":false,"replies":[{"id":"89546","content":"写入page cache即算成功。Kafka无法得知OS何时落盘","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1597885523,"ip_address":"","comment_id":242647,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1597803835","product_id":100029201,"comment_content":"老师，写入日志成功，是算写入page cache 成功，还是数据落盘成功。因为数据存盘可能是异步的","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":504061,"discussion_content":"写入page cache即算成功。Kafka无法得知OS何时落盘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597885523,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":234574,"user_name":"见南山","can_delete":false,"product_type":"c1","uid":1118111,"ip_address":"","ucode":"6A8BB82B7573CA","user_header":"https://static001.geekbang.org/account/avatar/00/11/0f/9f/f4b06bd5.jpg","comment_is_top":false,"comment_ctime":1594724293,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1594724293","product_id":100029201,"comment_content":"request. required. acks=all时表示的是isr中所有副本都收到消息，isr是保证follower和follower的数据一致性的。可能本身有10个副本，但是isr中是5个，acks=all就意味着这5个副本都收到消息。<br>min. in sync. replicas=n则表示的是最小同步副本球，只有在acks=all时生效，此时min. in sync. replicas=6时，它必须同步6个才行，不会只同步isr中数据就返回结果的","like_count":0},{"had_liked":false,"id":227494,"user_name":"正是那朵玫瑰","can_delete":false,"product_type":"c1","uid":1048261,"ip_address":"","ucode":"73D630B654573F","user_header":"https://static001.geekbang.org/account/avatar/00/0f/fe/c5/3467cf94.jpg","comment_is_top":false,"comment_ctime":1592392534,"is_pvip":false,"replies":[{"id":"83831","content":"嗯，所以Kafka还提供了软件机制来保证高可靠性，比如多副本机制","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1592403090,"ip_address":"","comment_id":227494,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1592392534","product_id":100029201,"comment_content":"kafka消息的已提交，也只是写入pagecache，并没有刷盘，如果在没有刷盘之前broker挂了，不也丢消息了么","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":498665,"discussion_content":"嗯，所以Kafka还提供了软件机制来保证高可靠性，比如多副本机制","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592403090,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":216686,"user_name":"行则将至","can_delete":false,"product_type":"c1","uid":1542987,"ip_address":"","ucode":"DB972F2DF059C4","user_header":"https://static001.geekbang.org/account/avatar/00/17/8b/4b/fa52d222.jpg","comment_is_top":false,"comment_ctime":1589328904,"is_pvip":false,"replies":[{"id":"80174","content":"一种简单的思路是在consumer端记录订阅的分区，。如果消费时碰到了新的分区，那么谨慎地对待它，比如把它调整到最开始的位移处开始消费","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1589332069,"ip_address":"","comment_id":216686,"utype":1}],"discussion_count":1,"race_medal":1,"score":"1589328904","product_id":100029201,"comment_content":"浏览了一遍留言，没有发现课后题的答案，老师能不能给出一个解答。应该不是简单的配置成earilst吧","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":494912,"discussion_content":"一种简单的思路是在consumer端记录订阅的分区，。如果消费时碰到了新的分区，那么谨慎地对待它，比如把它调整到最开始的位移处开始消费","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589332069,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":152383,"user_name":"sun","can_delete":false,"product_type":"c1","uid":1062757,"ip_address":"","ucode":"98F10FD0D881DA","user_header":"https://static001.geekbang.org/account/avatar/00/10/37/65/e8af4917.jpg","comment_is_top":false,"comment_ctime":1573987551,"is_pvip":false,"replies":[{"id":"58588","content":"在这台broker上消息的确算丢失了，不过Kafka在软件层面提供了副本机制可以预防这种情况","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1574039103,"ip_address":"","comment_id":152383,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1573987551","product_id":100029201,"comment_content":"broker已经写到页缓存，此时如果broker挂了，消息算丢失吗？该怎么处理呢？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":474800,"discussion_content":"在这台broker上消息的确算丢失了，不过Kafka在软件层面提供了副本机制可以预防这种情况","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574039103,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":146175,"user_name":"朱东旭","can_delete":false,"product_type":"c1","uid":1242338,"ip_address":"","ucode":"C48DD620A63868","user_header":"https://static001.geekbang.org/account/avatar/00/12/f4/e2/dbc4a5f2.jpg","comment_is_top":false,"comment_ctime":1572447559,"is_pvip":false,"replies":[{"id":"56437","content":"如果max.in.flight.requests.per.connection设置成大于0的数，那么的确有可能的。","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1572482912,"ip_address":"","comment_id":146175,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1572447559","product_id":100029201,"comment_content":"您好，胡夕老师，retries是否会导致消息乱序呢?","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":472738,"discussion_content":"如果max.in.flight.requests.per.connection设置成大于0的数，那么的确有可能的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572482912,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1156148,"avatar":"https://static001.geekbang.org/account/avatar/00/11/a4/34/0ab08db6.jpg","nickname":"swift","note":"","ucode":"B243DCD10B04F0","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":229662,"discussion_content":"应该是大于1吧？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586679254,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":136048,"user_name":"蒙开强","can_delete":false,"product_type":"c1","uid":1317706,"ip_address":"","ucode":"61B3183781B9F7","user_header":"https://static001.geekbang.org/account/avatar/00/14/1b/4a/f9df2d06.jpg","comment_is_top":false,"comment_ctime":1569335830,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1569335830","product_id":100029201,"comment_content":"老师，你好，kafka的leader副本与Follower副本之间，如果leader挂了，follower副本与leader副本落下的数据不是太大，这个时候切换follower副本选举为leader，这个时候就会有消息丢失，这么看来kafka不能保证百分之百的不丢数据。","like_count":0,"discussions":[{"author":{"id":1317706,"avatar":"https://static001.geekbang.org/account/avatar/00/14/1b/4a/f9df2d06.jpg","nickname":"蒙开强","note":"","ucode":"61B3183781B9F7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":200152,"discussion_content":"有参数设置么？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583661746,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1130590,"avatar":"https://static001.geekbang.org/account/avatar/00/11/40/5e/b8fada94.jpg","nickname":"Ryoma","note":"","ucode":"7F692369239692","race_medal":2,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":171847,"discussion_content":"如果有这种需求，可以考虑在写入时保证除了 leader 写入之外，有 follower 副本也写入成功","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581752564,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":135539,"user_name":"miwucc","can_delete":false,"product_type":"c1","uid":1326429,"ip_address":"","ucode":"7935BD907119AE","user_header":"https://static001.geekbang.org/account/avatar/00/14/3d/5d/ac666969.jpg","comment_is_top":false,"comment_ctime":1569206651,"is_pvip":false,"replies":[{"id":"51991","content":"取决于你配置的retries，如果就是3，那么producer会被显式告知发送失败，你可以在回调中处理失败逻辑。","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1569230267,"ip_address":"","comment_id":135539,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1569206651","product_id":100029201,"comment_content":"发送端的消息持久化如何处理？比如我发的时候连续重试3次都错，这个时候这个消息还不能抛弃，或者是这个时候发送端被重启了","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":468239,"discussion_content":"取决于你配置的retries，如果就是3，那么producer会被显式告知发送失败，你可以在回调中处理失败逻辑。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1569230267,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1050508,"avatar":"https://static001.geekbang.org/account/avatar/00/10/07/8c/0d886dcc.jpg","nickname":"蚂蚁内推+v","note":"","ucode":"24B10AEE54B3FD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":83316,"discussion_content":"我理解你的意思是，Producer还未将消息发送出去，即还未调用producer.send(msg, callback)这个API的时候，突然重启，那么这条未发送的消息就可能会丢失。解决办法就是在发送之前先将消息持久化，取决于消息的重要程度。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576421689,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":135538,"user_name":"miwucc","can_delete":false,"product_type":"c1","uid":1326429,"ip_address":"","ucode":"7935BD907119AE","user_header":"https://static001.geekbang.org/account/avatar/00/14/3d/5d/ac666969.jpg","comment_is_top":false,"comment_ctime":1569206557,"is_pvip":false,"replies":[{"id":"51992","content":"不确定100%理解了你的持久化的意思。通常我们指消息保存在了broker端这件事情为持久化。如果是这样的话，你最好设置acks=all就好了","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1569230339,"ip_address":"","comment_id":135538,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1569206557","product_id":100029201,"comment_content":"老师，消息发送没有持久化，比如发送的时候重启了，怎办保证发送的消息不丢失？只能自己做持久化？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":468238,"discussion_content":"不确定100%理解了你的持久化的意思。通常我们指消息保存在了broker端这件事情为持久化。如果是这样的话，你最好设置acks=all就好了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1569230339,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":134836,"user_name":"云师兄","can_delete":false,"product_type":"c1","uid":1010459,"ip_address":"","ucode":"4475AF1598FBFD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/6b/1b/4b397b80.jpg","comment_is_top":false,"comment_ctime":1568941192,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1568941192","product_id":100029201,"comment_content":"已提交但是会丢失的情况，应该还有前面章节提到的page cache未同步到磁盘前宕机的情况吧？而这种情况不属于kafka应用的缺陷","like_count":0},{"had_liked":false,"id":133547,"user_name":"miwucc","can_delete":false,"product_type":"c1","uid":1326429,"ip_address":"","ucode":"7935BD907119AE","user_header":"https://static001.geekbang.org/account/avatar/00/14/3d/5d/ac666969.jpg","comment_is_top":false,"comment_ctime":1568602359,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1568602359","product_id":100029201,"comment_content":"retries在开启batch提交的时候会导致发送顺序错乱","like_count":0,"discussions":[{"author":{"id":1011062,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/6d/76/a80ca784.jpg","nickname":"wushuang5112","note":"","ucode":"D1F2AF2CD7D837","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":49137,"discussion_content":"给出具体的场景和代码啊！！！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573559284,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":133538,"user_name":"英耀","can_delete":false,"product_type":"c1","uid":1113425,"ip_address":"","ucode":"5E886F004BF6C2","user_header":"https://static001.geekbang.org/account/avatar/00/10/fd/51/7f75a232.jpg","comment_is_top":false,"comment_ctime":1568599418,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1568599418","product_id":100029201,"comment_content":"胡老师您好，对于您在&quot;最佳实践&quot;小节第4点提到的“如果一个 Broker 落后原先的 Leader 太多，那么它一旦成为新的 Leader，必然会造成消息的丢失”存在疑问。我理解分区中的数据副本之间是通过共识算法来保证一致性的，对常见的两种共识算法Raft和Paxos（不知道kafka使用的是哪一种），都不会出现上述的问题。对Raft而言，leader election时会选择log index最长的follower作为新的leader，顾不存在上述问题；Paxos而言，对于被多数派commit的日志&#47;实例，在新leader选举的propose阶段会进行日志回放，它会询问其他节点并选择已被多数派committed的日志重新执行算法，因此即使新的leader的日志落后很多，但也不会存在日志丢失的问题，只是日志回放的时间会更长而已。不知道是不是我理解的层面或者角度跟老师您不一致，才会导致这样的疑惑，希望老师答疑。","like_count":0},{"had_liked":false,"id":124725,"user_name":"willmeng","can_delete":false,"product_type":"c1","uid":1157065,"ip_address":"","ucode":"37367A728ABF88","user_header":"https://static001.geekbang.org/account/avatar/00/11/a7/c9/67bd5906.jpg","comment_is_top":false,"comment_ctime":1565952595,"is_pvip":false,"replies":[{"id":"45824","content":"内部主题__consumer_offsets的replication factor（rf）不够，或者说，这个主题的rf值小于offsets.topic.replication.factor值","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1566020805,"ip_address":"","comment_id":124725,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1565952595","product_id":100029201,"comment_content":"胡大，您好。 broker三个节点，Kafka版本：kafka_2.12-2.3.0。我配置了#replication.factor=3，#min.insync.replicas=2，创建topic的时候能成功，用命令从写入消息也成功。但是消费的时候会报错。<br>kafka_2.12-2.3.0]# [2019-08-16 18:32:41,201] INFO [GroupCoordinator 1]: Member consumer-1-6524b252-55f4-4fe8-8fe9-7ab05de683b1 in group console-consumer-18018 has failed, removing it from the group (kafka.coordinator.group.GroupCoordinator)<br>[2019-08-16 18:32:41,202] INFO [GroupCoordinator 1]: Group console-consumer-18018 with generation 44 is now empty (__consumer_offsets-29) (kafka.coordinator.group.GroupCoordinator)<br>[2019-08-16 18:32:41,203] ERROR [ReplicaManager broker=1] Error processing append operation on partition __consumer_offsets-29 (kafka.server.ReplicaManager)<br>org.apache.kafka.common.errors.NotEnoughReplicasException: The size of the current ISR Set(1) is insufficient to satisfy the min.isr requirement of 2 for partition __consumer_offsets-29<br>[2019-08-16 18:32:41,203] WARN [GroupCoordinator 1]: Failed to write empty metadata for group console-consumer-18018: The coordinator is not available. (kafka.coordinator.group.GroupCoordinator)<br>创建topic的参数是--replication-factor 3 --partitions 3 <br>只要注释了这两个配置就一切正常。麻烦给提示一下问题。<br>","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":463297,"discussion_content":"内部主题__consumer_offsets的replication factor（rf）不够，或者说，这个主题的rf值小于offsets.topic.replication.factor值","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566020805,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1157065,"avatar":"https://static001.geekbang.org/account/avatar/00/11/a7/c9/67bd5906.jpg","nickname":"willmeng","note":"","ucode":"37367A728ABF88","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":5232,"discussion_content":"多谢，多谢，问题解决了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566099318,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":117704,"user_name":"翡冷翠","can_delete":false,"product_type":"c1","uid":1326971,"ip_address":"","ucode":"42FFE0F7501D56","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIcmZIPiaKWfMosmDmkejiac8TDhJKz3cygJ2pRJIBHmoeUCNUssSmjETAV9dyozW6c0y8TibNCXqd8Q/132","comment_is_top":false,"comment_ctime":1564114385,"is_pvip":false,"replies":[{"id":"43219","content":"只对可重试异常进行重试。<br>是的，收不到response自然会重试","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1564216394,"ip_address":"","comment_id":117704,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1564114385","product_id":100029201,"comment_content":"请问下设置了ack=all， retires参数可以控制哪些情况下的失败， 设置了retires还有必要再在procduer.send的回调里再次回忆失败重试吗<br>还有如果borker的ack响应丢失掉了， 客户端是怎么做重试的， 超过一定时间收不到ack就重新发送吗","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":460089,"discussion_content":"只对可重试异常进行重试。\n是的，收不到response自然会重试","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564216394,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":117415,"user_name":"百越平民","can_delete":false,"product_type":"c1","uid":1194846,"ip_address":"","ucode":"1F26D94EC757D6","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epc3H0jvwelJoMUbPdcXDibTkdnjlytYW9KiaNoUG8XHxtoWkkia6kfTLLHrEmMGQkFVZuqY1QBvz8jg/132","comment_is_top":false,"comment_ctime":1564043028,"is_pvip":false,"replies":[{"id":"43010","content":"都是一样的","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1564061982,"ip_address":"","comment_id":117415,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1564043028","product_id":100029201,"comment_content":"是不是队列和主题（发布&#47;订阅），consumer对于offset的记录方式是不一样的？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":459956,"discussion_content":"都是一样的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564061982,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":115445,"user_name":"易水寒","can_delete":false,"product_type":"c1","uid":1238961,"ip_address":"","ucode":"F5D8127ED4754E","user_header":"https://static001.geekbang.org/account/avatar/00/12/e7/b1/5c63be67.jpg","comment_is_top":false,"comment_ctime":1563589963,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1563589963","product_id":100029201,"comment_content":"min.insync.replicas &gt; 1这个和producer的参数ack=all，是不是只要有min.insync.replicas这些个副本同步了数据，就是all语义了","like_count":0},{"had_liked":false,"id":112677,"user_name":"james","can_delete":false,"product_type":"c1","uid":1049208,"ip_address":"","ucode":"5701899403917C","user_header":"https://static001.geekbang.org/account/avatar/00/10/02/78/23c56bce.jpg","comment_is_top":false,"comment_ctime":1562805758,"is_pvip":false,"replies":[{"id":"41136","content":"Broker端上的内部主题保存了每个consumer的信息","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1562893391,"ip_address":"","comment_id":112677,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1562805758","product_id":100029201,"comment_content":"从最早位置开始消费，如果consumer挂了重启后就消费之前数据了，broker是如何标示每个consumer的呢？k8s环境下如果不控制绑定，那么启动后就在新节点了 ","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457851,"discussion_content":"Broker端上的内部主题保存了每个consumer的信息","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562893391,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":111690,"user_name":"柯察金","can_delete":false,"product_type":"c1","uid":1115149,"ip_address":"","ucode":"F722BF8FCD2C47","user_header":"https://static001.geekbang.org/account/avatar/00/11/04/0d/3dc5683a.jpg","comment_is_top":false,"comment_ctime":1562584647,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1562584647","product_id":100029201,"comment_content":"我都是使用自动提交的。。。","like_count":0},{"had_liked":false,"id":111402,"user_name":"曹伟雄","can_delete":false,"product_type":"c1","uid":1400754,"ip_address":"","ucode":"9740E426C0742C","user_header":"https://static001.geekbang.org/account/avatar/00/15/5f/b2/c4780c10.jpg","comment_is_top":false,"comment_ctime":1562552490,"is_pvip":false,"replies":[{"id":"40694","content":"使用seek重新消费","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1562636733,"ip_address":"","comment_id":111402,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1562552490","product_id":100029201,"comment_content":"老师，在请教个问题，因kafka不支持消费重试机制，如果在消费时处理消息失败（例如数据库约束失败或消息格式无效），如何设计一个可以重试的消费机制？ 谢谢","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457336,"discussion_content":"使用seek重新消费","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562636733,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":110692,"user_name":"JasonK","can_delete":false,"product_type":"c1","uid":1184135,"ip_address":"","ucode":"14BB7522FAECE7","user_header":"https://static001.geekbang.org/account/avatar/00/12/11/87/43744994.jpg","comment_is_top":false,"comment_ctime":1562315505,"is_pvip":false,"replies":[{"id":"40300","content":"嗯嗯，国内可能访问不了http:&#47;&#47;archive.apache.org&#47;dist&#47;kafka&#47;<br><br>有的公司应该是买了合法的VPN可以访问，问问吧：）","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1562370928,"ip_address":"","comment_id":110692,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1562315505","product_id":100029201,"comment_content":"你好，胡老师，http:&#47;&#47;kafka.apache.org 官网上的kafka的历史版本都下载不了，请问有什么好的方法嘛","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457011,"discussion_content":"嗯嗯，国内可能访问不了http://archive.apache.org/dist/kafka/\n\n有的公司应该是买了合法的VPN可以访问，问问吧：）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562370928,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1587619,"avatar":"https://static001.geekbang.org/account/avatar/00/18/39/a3/6ab4b32a.jpg","nickname":"DouDi","note":"","ucode":"33AA45A0F00287","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1184,"discussion_content":"请移步到： https://archive.apache.org/dist/kafka/","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562345804,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":110419,"user_name":"曹伟雄","can_delete":false,"product_type":"c1","uid":1400754,"ip_address":"","ucode":"9740E426C0742C","user_header":"https://static001.geekbang.org/account/avatar/00/15/5f/b2/c4780c10.jpg","comment_is_top":false,"comment_ctime":1562252666,"is_pvip":false,"replies":[{"id":"40156","content":"要看怎么个失败了。比如fail-fast吗？如果是，consumer重启回来的确会从上次提交处继续消费；如果不是，比如你仅仅是记录了一个log，那么consumer就正常往下消费了。<br><br>还是要看你打算怎么处理失败","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1562287427,"ip_address":"","comment_id":110419,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1562252666","product_id":100029201,"comment_content":"老师，你好，有个问题请教， 开启手动提交offset场景，如果业务处理失败了（这时没有提交offset），终止操作。下次还会继续消费这条记录吗？auto.offset.reset=eaily， 如果会，消费还是处理失败（这时没有提交offset），这样是不是就死循环了，还是说kafka有机制，一条记录最多消费几次?  类似这种场景，老师有什么好的建议吗？ 谢谢!","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":456872,"discussion_content":"要看怎么个失败了。比如fail-fast吗？如果是，consumer重启回来的确会从上次提交处继续消费；如果不是，比如你仅仅是记录了一个log，那么consumer就正常往下消费了。\n\n还是要看你打算怎么处理失败","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562287427,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":109884,"user_name":"jacke","can_delete":false,"product_type":"c1","uid":1161209,"ip_address":"","ucode":"05F355E1FF88C5","user_header":"https://static001.geekbang.org/account/avatar/00/11/b7/f9/a8f26b10.jpg","comment_is_top":false,"comment_ctime":1562124683,"is_pvip":false,"replies":[{"id":"39912","content":"acks只能是1或-1或0，不能指定任意个数。<br>“一条消息提交成功在broker端和producer端应该一致的吧？” ---- 不太明白什么意思 。。。","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1562202294,"ip_address":"","comment_id":109884,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1562124683","product_id":100029201,"comment_content":"胡老师,关于配置参数的一些疑问.<br>我的理解:replication.factor是不是broker端备份的个数,min.insync.replica表示broker要达到“已提交”最少需要写入的备份的个数.就是在broker端:<br>一条消息写入的个数&gt;=min.insync.replica的个数就视为“已提交” 也就是在 prodcer.send(msg, callback) 里面的callback回复提交的信息成功 疑问：callback 里面提示的“提交成功&quot;是这样意思吗?<br>acks是producer的参数：<br>表示一条消息发给broker之后有多少个回复才是producer端视为“已提交” 疑问：是这样的吗？<br>下面有几个配置组合的例子<br>replication.factor(broker) min.insync.replica(broker) acks(producer)<br> 5                      4               \t\t\t\tall <br> 5                      4               \t\t\t\t 1<br> 5\t                    5                                3<br> 5                      4                                5 <br>胡老师能说下上面配置情况下，prodcer.send(msg, callback) callback对提交成功的意义吗？<br>一条消息提交成功在broker端和producer端应该一致的吧？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":456623,"discussion_content":"acks只能是1或-1或0，不能指定任意个数。\n“一条消息提交成功在broker端和producer端应该一致的吧？” ---- 不太明白什么意思 。。。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562202294,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":109113,"user_name":"燃烧的M豆","can_delete":false,"product_type":"c1","uid":1355000,"ip_address":"","ucode":"BEDA9FC8852F5D","user_header":"https://static001.geekbang.org/account/avatar/00/14/ac/f8/a56b7475.jpg","comment_is_top":false,"comment_ctime":1561964416,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1561964416","product_id":100029201,"comment_content":"最佳实践 5 这个 replication.factor 是 topic 级别的参数是可以在创建 topic 的时候带上的。<br>最佳实践 4 这个 unclean.leader.election.enable 应该才是 broker 级别的参数？","like_count":0},{"had_liked":false,"id":109107,"user_name":"天天向上","can_delete":false,"product_type":"c1","uid":1031113,"ip_address":"","ucode":"5948D359734193","user_header":"https://static001.geekbang.org/account/avatar/00/0f/bb/c9/37924ad4.jpg","comment_is_top":false,"comment_ctime":1561963003,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1561963003","product_id":100029201,"comment_content":"其实 auto.offset.reset这个配置也很重要 对于不自动提交，且忘记手动提交的场景来说 也是个困惑的因素","like_count":0},{"had_liked":false,"id":109026,"user_name":"Geek_jacky","can_delete":false,"product_type":"c1","uid":1564542,"ip_address":"","ucode":"F6ABD94A03BE7B","user_header":"","comment_is_top":false,"comment_ctime":1561950580,"is_pvip":false,"replies":[{"id":"39536","content":"你可以设置max.poll.records =  10，消费完了之后再提交位移。","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1561982640,"ip_address":"","comment_id":109026,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1561950580","product_id":100029201,"comment_content":"你好，胡老师，我想每次隔10条记录进去消费一次，如果只有1个partition怎么做，如果有多个partition应该如何处理呢？个人认为可以手动在offset上进行处理，那么多个partition中的数据也只能保证每个partition中的消息间隔为10条，总感觉挺笨的，还有没有其他的办法？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":456217,"discussion_content":"你可以设置max.poll.records =  10，消费完了之后再提交位移。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561982640,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":108547,"user_name":"lmtoo","can_delete":false,"product_type":"c1","uid":1133918,"ip_address":"","ucode":"FCD5B9C941D448","user_header":"https://static001.geekbang.org/account/avatar/00/11/4d/5e/c5c62933.jpg","comment_is_top":false,"comment_ctime":1561798200,"is_pvip":false,"replies":[{"id":"39440","content":"停止broker的命令是kafka-server-stop，你说的情况的确会发生，好在Kafka提供了副本机制在软件层面上保证消息持久性。","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1561946652,"ip_address":"","comment_id":108547,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1561798200","product_id":100029201,"comment_content":"我还有一个疑问，broker接收到消息直接交给操作系统的虚拟内存了，然后Producer以为是提交成功了，这个时候突然断电，那在虚拟内存里的消息不就丢了吗？不管配置什么参数，也是没法保证消息不丢失的呀，如果用kill -9 杀掉broker的进程，是不是虚拟内存里的消息也就不持久化到磁盘了？正确停止broker而又不会丢失消息的命令是什么？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":456036,"discussion_content":"停止broker的命令是kafka-server-stop，你说的情况的确会发生，好在Kafka提供了副本机制在软件层面上保证消息持久性。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561946652,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":108072,"user_name":"在路上","can_delete":false,"product_type":"c1","uid":1143372,"ip_address":"","ucode":"335960F683C23C","user_header":"https://static001.geekbang.org/account/avatar/00/11/72/4c/4d636a23.jpg","comment_is_top":false,"comment_ctime":1561679938,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1561679938","product_id":100029201,"comment_content":"如果是多线程异步处理消费消息，Consumer 程序不要开启自动提交位移，而是要应用程序手动提交位移，这里的手动提交位移是什么意思啊，不太明白？","like_count":0},{"had_liked":false,"id":107992,"user_name":"z.l","can_delete":false,"product_type":"c1","uid":1181055,"ip_address":"","ucode":"805CC5784D3F76","user_header":"https://static001.geekbang.org/account/avatar/00/12/05/7f/d35ab9a1.jpg","comment_is_top":false,"comment_ctime":1561644877,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1561644877","product_id":100029201,"comment_content":"另外想请教下，单个 Consumer 程序使用多线程来消费消息的情况下，应该怎样自动提交offest？以java客户端为例，我把消息放到一个线程池中异步处理，此时consumer也不知道线程池中的任务是否执行成功，如果用future+同步提交又会阻塞consumer线程。所以是不是用多consumer线程同步消费+同步提交的方式比较合理？？","like_count":0},{"had_liked":false,"id":107894,"user_name":"Xiao","can_delete":false,"product_type":"c1","uid":1179212,"ip_address":"","ucode":"71FFCCEEDE09E1","user_header":"https://static001.geekbang.org/account/avatar/00/11/fe/4c/46eb517a.jpg","comment_is_top":false,"comment_ctime":1561630748,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1561630748","product_id":100029201,"comment_content":"胡老师，broker在持久化的时候理论上也存在数据丢失的情况吧。","like_count":0,"discussions":[{"author":{"id":1008348,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/dc/8876c73b.jpg","nickname":"moooofly","note":"","ucode":"4A20795C281B6F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":202291,"discussion_content":"是的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583892166,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":107832,"user_name":"振超","can_delete":false,"product_type":"c1","uid":1103529,"ip_address":"","ucode":"D55B896810DBBF","user_header":"https://static001.geekbang.org/account/avatar/00/10/d6/a9/ffd70fdc.jpg","comment_is_top":false,"comment_ctime":1561619459,"is_pvip":false,"replies":[{"id":"39129","content":"嗯嗯，但从用户的角度而言，我在producer无宕机的情形下增加了分区，producer正常生产的消息不应该不能被消费，对吧？","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1561680723,"ip_address":"","comment_id":107832,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1561619459","product_id":100029201,"comment_content":"设置从最新 offset 处开始消费，实际上默认就接受允许丢失一部分消息，这应该不算是缺陷","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":455693,"discussion_content":"嗯嗯，但从用户的角度而言，我在producer无宕机的情形下增加了分区，producer正常生产的消息不应该不能被消费，对吧？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561680723,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1103529,"avatar":"https://static001.geekbang.org/account/avatar/00/10/d6/a9/ffd70fdc.jpg","nickname":"振超","note":"","ucode":"D55B896810DBBF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":601,"discussion_content":"从这个角度去理解也是合情合理的，对于新增的分区，offset topic 中没有记录当前消费者所属 group 对于该分区的消费记录，是否能够基于这一特征增加一个配置，在遇到这种场景时即使消费者指定从 latest 位置开始消费也无效。新增的分区到消费者通过 rebalance 感知期间的时间间隔较小，所以消息量也不会很大，即使设置从 earliest 开始消费，堆积也不会很严重。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561778639,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":107820,"user_name":"张庆","can_delete":false,"product_type":"c1","uid":1050284,"ip_address":"","ucode":"17AE1E23B83304","user_header":"https://static001.geekbang.org/account/avatar/00/10/06/ac/604de2e8.jpg","comment_is_top":false,"comment_ctime":1561617387,"is_pvip":false,"replies":[{"id":"39131","content":"自动提交不会出现这个问题。主要是针对手动提交哦。而且这里的消费其实指的是你执行真正的消息处理逻辑，而不是指从kafka中获取消息。<br><br>Kafka默认提供至少一次语义。设想如果你想实现最多一次处理语义怎么做？就是要先提交位移，再处理消息。对吧？","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1561680836,"ip_address":"","comment_id":107820,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1561617387","product_id":100029201,"comment_content":"胡夕大拿 您好，关于消费者数据丢失的第一种情况，我不是很明白，在什么情况下读书和更新书签的顺序是颠倒的啊？我理解的如果设置为自动提交了，就是定时间隔的位移提交，在这个间隔时间里面，如果正在消费数据，此时宕机了，还没有提交位移，如果重启了，可能会出现重复消费。不理解消息丢失的场景是什么样子的？您能详细解释一下吗？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":455687,"discussion_content":"自动提交不会出现这个问题。主要是针对手动提交哦。而且这里的消费其实指的是你执行真正的消息处理逻辑，而不是指从kafka中获取消息。\n\nKafka默认提供至少一次语义。设想如果你想实现最多一次处理语义怎么做？就是要先提交位移，再处理消息。对吧？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561680836,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":107742,"user_name":"你好旅行者","can_delete":false,"product_type":"c1","uid":1154101,"ip_address":"","ucode":"5C72A428DC28F3","user_header":"https://static001.geekbang.org/account/avatar/00/11/9c/35/9dc79371.jpg","comment_is_top":false,"comment_ctime":1561602597,"is_pvip":false,"replies":[{"id":"39136","content":"哪个问题？<br>","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1561681092,"ip_address":"","comment_id":107742,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1561602597","product_id":100029201,"comment_content":"老师可以贴出官方社区对这个问题的解答吗，我想更深入地了解一下这个问题","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":455649,"discussion_content":"哪个问题？\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561681092,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":107737,"user_name":"刚子","can_delete":false,"product_type":"c1","uid":1017080,"ip_address":"","ucode":"7B55EC80A7A4A9","user_header":"https://static001.geekbang.org/account/avatar/00/0f/84/f8/c22d32b4.jpg","comment_is_top":false,"comment_ctime":1561601681,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1561601681","product_id":100029201,"comment_content":"broker的配置、producer和consumer的配置如此多和复杂，不容易记忆。需要后期根据业务需求进行相应调整，是否有模版的配置参数或者自感应的功能，可以帮助开发和运维快速正确的使用Kafka","like_count":0},{"had_liked":false,"id":107720,"user_name":"13761642169","can_delete":false,"product_type":"c1","uid":1232334,"ip_address":"","ucode":"68137695FC2120","user_header":"","comment_is_top":false,"comment_ctime":1561599525,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1561599525","product_id":100029201,"comment_content":"如果消息是随机发送，对于消费者来说，可以使用暂停消费，新分区有消息进来和消费实例注册新分区完成，启用消费。这是我认为的想法","like_count":0},{"had_liked":false,"id":107719,"user_name":"AA","can_delete":false,"product_type":"c1","uid":1103583,"ip_address":"","ucode":"CADCB958D6DA1B","user_header":"https://static001.geekbang.org/account/avatar/00/10/d6/df/1e4ecd94.jpg","comment_is_top":false,"comment_ctime":1561599433,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1561599433","product_id":100029201,"comment_content":"改用&quot;从最早位置&quot;读，又会导致什么问题","like_count":0},{"had_liked":false,"id":107713,"user_name":"13761642169","can_delete":false,"product_type":"c1","uid":1232334,"ip_address":"","ucode":"68137695FC2120","user_header":"","comment_is_top":false,"comment_ctime":1561598724,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1561598724","product_id":100029201,"comment_content":"其实很好解决，在发送端用分区hash一个分区key，指定分区发送，增加分区之后，在确保kafka消费者实例注册上新分区后，将发送端重启。","like_count":0},{"had_liked":false,"id":107710,"user_name":"刘朋","can_delete":false,"product_type":"c1","uid":1075141,"ip_address":"","ucode":"7B7B8E4776C22E","user_header":"https://static001.geekbang.org/account/avatar/00/10/67/c5/63b09189.jpg","comment_is_top":false,"comment_ctime":1561598644,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1561598644","product_id":100029201,"comment_content":"思考讨论:<br>在业务场景允许暂停的的情况下,在增加主题分区前,先暂停Producer端的写入;然后增加主题分区;其次重启或等待Consumer端;最后启动Producer端.<br><br>在业务场景不允暂停的情况下,需要有个地方(redis&#47;zookeeper)缓存一个配置信息.里面分别记录Producer端和Consumer端 主题分区信息.<br><br>比如，Producer topic_partitions: M ,Consumper topic_partitions: N<br><br>Producer端每次消费消息前,<br>首先,会判断Topic的分区数,如果有变更,会及时更新 Producer topic_partitions: M<br>其次,会判断  M 是否等于 N.<br>如果 M = N,则写入数据;<br>如果 M &gt; N,则循环等待,不写入数据;<br>如果 M &lt; N,则会更新配置文件(Producer topic_partitions:N),然后写入数据<br><br>Consumper端每次消费消息前,会判断Topic的分区数,如果有变更,会及时更新 Consumper topic_partitions: N<br><br>缺点,可能会增加一定的检测时长.是否增加此检测步骤后会影响到业务提交&#47;消费需要根据业务特性进行压测检验.","like_count":0},{"had_liked":false,"id":107701,"user_name":"dream","can_delete":false,"product_type":"c1","uid":1117793,"ip_address":"","ucode":"65B33D32FA8BE9","user_header":"https://static001.geekbang.org/account/avatar/00/11/0e/61/ae68f8eb.jpg","comment_is_top":false,"comment_ctime":1561597669,"is_pvip":false,"replies":[{"id":"39141","content":"是的。实际场景中非常明显。。。","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1561681246,"ip_address":"","comment_id":107701,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1561597669","product_id":100029201,"comment_content":"broker端的asks=all虽然保证了无消息丢失的实现，但是会使broker响应producer的时间变长吧...","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":455629,"discussion_content":"是的。实际场景中非常明显。。。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561681246,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1445399,"avatar":"https://static001.geekbang.org/account/avatar/00/16/0e/17/e16e679f.jpg","nickname":"guoyinbo2019","note":"","ucode":"19D86CB3E42839","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":524,"discussion_content":"我认为会的，毕竟同步数据是需要时间的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561641293,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":107675,"user_name":"风中花","can_delete":false,"product_type":"c1","uid":1085237,"ip_address":"","ucode":"067E0A1E116844","user_header":"https://static001.geekbang.org/account/avatar/00/10/8f/35/f1839bb2.jpg","comment_is_top":false,"comment_ctime":1561595588,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1561595588","product_id":100029201,"comment_content":"刚收到推送就这么多留言啦！厉害了我的哥们","like_count":0},{"had_liked":false,"id":107668,"user_name":"杨俊","can_delete":false,"product_type":"c1","uid":1158214,"ip_address":"","ucode":"3CAE634618D924","user_header":"https://static001.geekbang.org/account/avatar/00/11/ac/46/7e24bad6.jpg","comment_is_top":false,"comment_ctime":1561594936,"is_pvip":true,"replies":[{"id":"38927","content":"也可以的，flume kafka sink也有对应的参数设置方法","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1561595610,"ip_address":"","comment_id":107668,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1561594936","product_id":100029201,"comment_content":"如果是flume组件对接kafka，producer端参数应该设置不了这么全吧","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":455618,"discussion_content":"也可以的，flume kafka sink也有对应的参数设置方法","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561595610,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":107658,"user_name":"mini希","can_delete":false,"product_type":"c1","uid":1043539,"ip_address":"","ucode":"54DFFE0CE0C7EF","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ec/53/dcec6fdc.jpg","comment_is_top":false,"comment_ctime":1561594127,"is_pvip":true,"discussion_count":0,"race_medal":4,"score":"1561594127","product_id":100029201,"comment_content":"是否可以每次往前读一次，最新位移-1，看是否消费过了","like_count":0},{"had_liked":false,"id":107655,"user_name":"＼（－－）／未来的首席架构师","can_delete":false,"product_type":"c1","uid":1410456,"ip_address":"","ucode":"706558518C9318","user_header":"https://static001.geekbang.org/account/avatar/00/15/85/98/5469f1db.jpg","comment_is_top":false,"comment_ctime":1561593961,"is_pvip":false,"replies":[{"id":"38930","content":"可能的。acks=all表示要等待ISR中的副本全部写入成功，非ISR的副本依然可能落后leader","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1561595781,"ip_address":"","comment_id":107655,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1561593961","product_id":100029201,"comment_content":"设置成ack=all，还会出现第四条的场景吗？消息还会落后？？？？？？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":455608,"discussion_content":"可能的。acks=all表示要等待ISR中的副本全部写入成功，非ISR的副本依然可能落后leader","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561595781,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":107636,"user_name":"Leon📷","can_delete":false,"product_type":"c1","uid":1219496,"ip_address":"","ucode":"B9BBD1EFAAE5A2","user_header":"https://static001.geekbang.org/account/avatar/00/12/9b/a8/6a391c66.jpg","comment_is_top":false,"comment_ctime":1561588814,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1561588814","product_id":100029201,"comment_content":"增加新的分区的时候让消费的给生产者发一个确认，生产者收到确认之后才会向新的分区里面写数据。","like_count":0}]}