{"id":174552,"title":"14 | JSON文档模型设计特点","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/geektime-mongodb-course\">https://gitee.com/geektime-geekbang/geektime-mongodb-course</a></p>","comments":[{"had_liked":false,"id":165692,"user_name":"firek","can_delete":false,"product_type":"c3","uid":1273501,"ip_address":"","ucode":"FFFDBFB34688EF","user_header":"https://static001.geekbang.org/account/avatar/00/13/6e/9d/29feea6f.jpg","comment_is_top":false,"comment_ctime":1577283110,"is_pvip":false,"replies":[{"id":65210,"content":"MongoDB的GridFS 不是一个真正的filesystem。它其实是一个api sugarcoating。实现是在驱动端（不是mongodb服务器！），提供一个字节流的API， 允许你把二进制文件通过这个接口提交给MongoDB 驱动，或者从这个接口读取二进制文件流。然后驱动会把这个文件分块，每一块作为一个mongodb的文档插入到集合里。 当你需要的时候，mongodb驱动会把所有相关的切块读出来，拼成一整个文件，返回给应用程序。\n\n所以这个不是真的文件系统，只是提供了一个虚拟的文件接口供应用进行文件存储和读取。优点是可以用到mongo的分布式能力，做海量的二进制文件管理和高可用等。\n","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1577970715,"ip_address":"","comment_id":165692,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师，mongodb除了collection之外还有一个功能可以存附件，比如文件，视频，音频等。这个是和普通关系型数据库有区别的地方吧，还有就是以前面试的时候，面试官也拿mongodb和fastdfs提问，两者有什么区别，老师你可以用之前的项目经验解答下么？","like_count":9,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":479261,"discussion_content":"MongoDB的GridFS 不是一个真正的filesystem。它其实是一个api sugarcoating。实现是在驱动端（不是mongodb服务器！），提供一个字节流的API， 允许你把二进制文件通过这个接口提交给MongoDB 驱动，或者从这个接口读取二进制文件流。然后驱动会把这个文件分块，每一块作为一个mongodb的文档插入到集合里。 当你需要的时候，mongodb驱动会把所有相关的切块读出来，拼成一整个文件，返回给应用程序。\n\n所以这个不是真的文件系统，只是提供了一个虚拟的文件接口供应用进行文件存储和读取。优点是可以用到mongo的分布式能力，做海量的二进制文件管理和高可用等。\n","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1577970715,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":187683,"user_name":"fomy","can_delete":false,"product_type":"c3","uid":1125834,"ip_address":"","ucode":"CD87EA03B1F327","user_header":"https://static001.geekbang.org/account/avatar/00/11/2d/ca/02b0e397.jpg","comment_is_top":false,"comment_ctime":1584192530,"is_pvip":false,"replies":[{"id":73186,"content":"不用一个个改，可以是一个update语句，更新所有匹配项","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1584625043,"ip_address":"","comment_id":187683,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"数据冗余时，当有数据要更新时岂不是很麻烦？比如原来组A叫“同是”，但是后面发现“同是”错了，应该是“同事”。比如有很多这样的数据，岂不是要一个一个去改？","like_count":2,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":487199,"discussion_content":"不用一个个改，可以是一个update语句，更新所有匹配项","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584625043,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":173542,"user_name":"高宇","can_delete":false,"product_type":"c3","uid":1036266,"ip_address":"","ucode":"5241E28C7744C5","user_header":"https://static001.geekbang.org/account/avatar/00/0f/cf/ea/6fb0b225.jpg","comment_is_top":false,"comment_ctime":1579592106,"is_pvip":false,"replies":[{"id":67371,"content":"么有太大区别，性能上也不会有什么差别，除了你自己要保证这个_id的唯一性。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1579701766,"ip_address":"","comment_id":173542,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师好，我这边有个疑问，MongoDB默认生成的 _id 类型是 ObjectId，在做查询时，经常需要考虑做类型转换处理，不然会碰到查不到数据的问题。\n虽然ORM框架可以处理这个问题，但我想确认一个问题就是如果每次插入数据的时候都提前 new ObjectID，然后设置一个 string 类型的主键，和原生 ObjectID 相比是否有什么不好的地方，比如说性能是否会差一些","like_count":2,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":482108,"discussion_content":"么有太大区别，性能上也不会有什么差别，除了你自己要保证这个_id的唯一性。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579701766,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":240936,"user_name":"奔跑的脑细胞","can_delete":false,"product_type":"c3","uid":2059107,"ip_address":"","ucode":"84D3DCDE2C96BE","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/cabLXAUXiavUplEOz3rdXFmbiary8v28mrE3f0IEDYogiarKCGFWiaMUTWJBOJ71osicT5r1MFpAQIAm4l43I6QYvBw/132","comment_is_top":false,"comment_ctime":1597126632,"is_pvip":false,"replies":[{"id":89362,"content":"Linux 有个命令叫tail，如果你理解那个的用法，就知道这个名词的由来了。\n\ntail -f  debug.log\n\n这个命令会打印debug.log 的内容，然后不会退出，会在那里监听debug.log文件是否有新的日志写入，一旦有新的，就会马上在控制台打印出来。\n\n使用tailable cursor, 你的程序不会退出，读完cursor最后一条以后会block，等待下一条数据过来后继续。很多时候可以用来做一些类似Java里面 observer pattern的事情或者传统数据库里触发器的事情。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1597625900,"ip_address":"","comment_id":240936,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师，在学习过程中遇到一个概念Tailable Cursor，这个应该怎么理解呢？","like_count":1,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":503597,"discussion_content":"Linux 有个命令叫tail，如果你理解那个的用法，就知道这个名词的由来了。\n\ntail -f  debug.log\n\n这个命令会打印debug.log 的内容，然后不会退出，会在那里监听debug.log文件是否有新的日志写入，一旦有新的，就会马上在控制台打印出来。\n\n使用tailable cursor, 你的程序不会退出，读完cursor最后一条以后会block，等待下一条数据过来后继续。很多时候可以用来做一些类似Java里面 observer pattern的事情或者传统数据库里触发器的事情。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597625900,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2059107,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/cabLXAUXiavUplEOz3rdXFmbiary8v28mrE3f0IEDYogiarKCGFWiaMUTWJBOJ71osicT5r1MFpAQIAm4l43I6QYvBw/132","nickname":"奔跑的脑细胞","note":"","ucode":"84D3DCDE2C96BE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":303037,"discussion_content":"谢谢老师，tail命令我理解，这样的话，我大致能理解这个Tailable Cursor是什么样的概念了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599119540,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":167489,"user_name":"第一装甲集群司令克莱斯特","can_delete":false,"product_type":"c3","uid":1265707,"ip_address":"","ucode":"4E8FBB23AD860B","user_header":"https://static001.geekbang.org/account/avatar/00/13/50/2b/2344cdaa.jpg","comment_is_top":false,"comment_ctime":1577841802,"is_pvip":false,"replies":[{"id":65193,"content":"新增表字段，就会引来上亿流量冲击 -  这个能详细说下是什么样的一个情况吗？我脑补不上\n\n上亿流量是一天？一个小时？取决于时间周期，这个大概率不是什么问题。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1577967269,"ip_address":"","comment_id":167489,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"我们知道，要给oracle数据库的表新增字段以适应业务需求，并投入生产环境，这是需要评估的，因为新增表字段，投入生产环境会面对上亿流量的冲击，关系型数据库是否扛的住，是个风险。那么作为文档型的Mongo数据库，为了适应业务，也拓展模型，新增dto以及字段并投入生产面对大流量考验，会有什么隐患么？说白了，业务扩展，加字段投生产，Mongo扛得住生产环境么？","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":479881,"discussion_content":"新增表字段，就会引来上亿流量冲击 -  这个能详细说下是什么样的一个情况吗？我脑补不上\n\n上亿流量是一天？一个小时？取决于时间周期，这个大概率不是什么问题。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577967269,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":194931,"user_name":"追忆似水年华","can_delete":false,"product_type":"c3","uid":1160192,"ip_address":"","ucode":"C1D7C0DD7E7411","user_header":"https://static001.geekbang.org/account/avatar/00/11/b4/00/661fb98d.jpg","comment_is_top":false,"comment_ctime":1585121444,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"这前后几节关于设计模式的课程看下来，印象最深的一点，就是MongoDB虽然很方便，但开发者还是需要多学习、多思考，尽量在前期用良好的设计，来避免之后因设计不周所产生的各种问题，而不能因为工具、产品的方便，就降低了对自己的要求。","like_count":4},{"had_liked":false,"id":192190,"user_name":"依乐祝","can_delete":false,"product_type":"c3","uid":1320243,"ip_address":"","ucode":"0FAE2C7FE1ECDB","user_header":"https://static001.geekbang.org/account/avatar/00/14/25/33/290fcb42.jpg","comment_is_top":false,"comment_ctime":1584842459,"is_pvip":false,"replies":null,"discussion_count":2,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"T老师,你好。想问几个问题：1.我这边有一个表好几十亿数据，在查询的时候根据条件进行分页展示的时候，count发现会很慢，有没有好的思路提供下啊？我目前都准备把mongodb数据通过oplog实时迁移到ES中，再利用ES来进行查询的优化了！2. 如果我这边有两个MongoDB库，假设是A库与B库 。这时候我页面上有一个页面需要用到AB两个库里面的集合来组合显示列表数据，这时候有什么好的建议吗？目前想到的是准备利用ES父子文档来进行优化。希望T老师能提供下新的思路！非常感谢","like_count":4,"discussions":[{"author":{"id":1133194,"avatar":"https://static001.geekbang.org/account/avatar/00/11/4a/8a/c1069412.jpg","nickname":"makermade","note":"","ucode":"03386B90CB8F20","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":364480,"discussion_content":"➕1","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617501125,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1167452,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d0/5c/ab27aeaf.jpg","nickname":"少年音","note":"","ucode":"C42960606585AF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":299772,"discussion_content":"同问，坐等T老师回复","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597812268,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":331254,"user_name":"李一","can_delete":false,"product_type":"c3","uid":1524952,"ip_address":"","ucode":"EEB7C5099C566C","user_header":"https://static001.geekbang.org/account/avatar/00/17/44/d8/708a0932.jpg","comment_is_top":false,"comment_ctime":1642503952,"is_pvip":true,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"咨询个问题，关于子文档能否建立唯一索引","like_count":0},{"had_liked":false,"id":328154,"user_name":"刘永臣","can_delete":false,"product_type":"c3","uid":2033098,"ip_address":"","ucode":"31426CE31CA514","user_header":"https://static001.geekbang.org/account/avatar/00/1f/05/ca/eefef69b.jpg","comment_is_top":false,"comment_ctime":1640575768,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"满满的干货，很值！","like_count":0},{"had_liked":false,"id":314703,"user_name":"聆听","can_delete":false,"product_type":"c3","uid":1490169,"ip_address":"","ucode":"D7232626C6394D","user_header":"https://static001.geekbang.org/account/avatar/00/16/bc/f9/f4345ea6.jpg","comment_is_top":false,"comment_ctime":1633336848,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"大佬好，这个mongodb 里面自增id 只能用数据库新增加1的那种吗？还是大家用mongodb都是用的_id当唯一主键使用？","like_count":0}]}