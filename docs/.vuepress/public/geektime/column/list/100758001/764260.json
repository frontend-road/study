{"id":764260,"title":"06ï½œäº‘ç¯å¢ƒå®æˆ˜ï¼šå¿«é€Ÿå¯åŠ¨Kubernetesé›†ç¾¤","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯æ½˜é‡ã€‚</p><p>å‰é¢çš„è¯¾ç¨‹é‡Œï¼Œæˆ‘ä»¬å­¦ä¹ äº†äº‘åŸç”Ÿçš„åŸºæœ¬ç»„æˆæŠ€æœ¯ï¼Œç°ä»£åŒ–çš„äº‘åŸç”ŸæŠ€æœ¯æ¶æ„å¦‚ä½•ç®¡ç†ä»¥åŠå…¬æœ‰äº‘çš„åŸºæœ¬ç‰¹ç‚¹ç­‰å†…å®¹ã€‚ä½ å¯èƒ½è§‰å¾—å‰é¢çš„çŸ¥è¯†åç†è®ºï¼Œçœ¼ç›çœ‹ä¼šäº†ã€è„‘è¢‹æ˜ç™½äº†ï¼Œä½†æ˜¯æ‰‹è¿˜ä¸ä¼šã€‚</p><p>ä»è¿™ä¸€ç« å¼€å§‹ï¼Œæˆ‘ä¸ºä½ è®¾è®¡äº†ä¸€ç³»åˆ—çš„å®éªŒï¼Œä»æ˜“åˆ°éš¾ã€å¾ªåºæ¸è¿›åœ°å¸¦ä½ å®æˆ˜æ¼”ç»ƒï¼Œæœ€ç»ˆå½¢æˆä¸€å¥—å¯ä»¥ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒçš„åŸºç¡€æ¶æ„è‡ªåŠ¨åŒ–ç®¡ç†æ–¹å¼ã€‚é™¤äº†æé«˜å®è·µæ°´å¹³ï¼Œä½ è¿˜èƒ½åŠ æ·±å¯¹ä¸å¯å˜åŸºç¡€è®¾æ–½ã€æ··åˆäº‘ç®¡ç†ç­‰ç†è®ºçš„ç†è§£ã€‚</p><p>è¿™ä¸€è®²æˆ‘ä»¬ä¼šåˆ©ç”¨Terraformå·¥å…·ï¼Œåœ¨AWSä¸­å¯åŠ¨ä¸€ä¸ªKubernetesé›†ç¾¤ï¼Œå¸®ä½ å°½å¿«ç†Ÿæ‚‰ç°ä»£IaCé¢å‘èµ„æºçš„ç®¡ç†æ–¹å¼ã€‚</p><h2>å‰æœŸå‡†å¤‡å·¥ä½œ</h2><p>ä¸ºä»€ä¹ˆæˆ‘ä»¬é€‰æ‹©å…¬æœ‰äº‘AWSä½œä¸ºè¯¾ç¨‹çš„å®è·µç¯å¢ƒå‘¢ï¼Ÿ</p><p>å› ä¸ºå®ƒæä¾›äº†å®Œæ•´çš„IaaS APIä¸æ–‡æ¡£ï¼Œæ›´æ–¹ä¾¿æˆ‘ä»¬å­¦ä¹ å®è·µã€‚è€Œä¸”æ— è®ºæ˜¯å“ªä¸ªäº‘å‚å•†ï¼Œæä¾›çš„åŠŸèƒ½éƒ½å·®ä¸å¤šã€‚å³ä¾¿ä½ æ‰€åœ¨çš„å›¢é˜Ÿæ˜¯è‡ªå»ºæœºæˆ¿ï¼Œå¤šæ•°ä¹Ÿä¼šé‡‡ç”¨åƒOpenstackã€VMwareè¿™æ ·çš„IaaSè§£å†³æ–¹æ¡ˆï¼Œå“ªæ€•APIæˆ–æ“ä½œè·Ÿå…¬æœ‰äº‘ç•¥æœ‰å·®åˆ«ï¼Œä½¿ç”¨æ–¹æ³•å’Œæ€è·¯ä¹ŸåŸºæœ¬ä¸€è‡´ã€‚</p><p>å¥½ï¼Œä¸‹é¢æ­£å¼è¿›å…¥å®æˆ˜ç¯èŠ‚ï¼Œæˆ‘ä»¬å…ˆä»é…ç½®æœ¬åœ°ç¯å¢ƒå¼€å§‹ã€‚æˆ‘ä»¬é€‰ç”¨ä¸€å°Ubuntu 22.04çš„è™šæ‹Ÿæœºä½œä¸ºåŸºç¡€æ“ä½œç¯å¢ƒã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å®‰è£…AWSçš„å‘½ä»¤è¡Œå·¥å…·AWS CLIã€‚å¦‚æœä½ ä½¿ç”¨çš„æ˜¯Mac OSæˆ–è€…Windowsç³»ç»Ÿï¼Œå¯ä»¥å‚ç…§AWSçš„<a href=\"https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html\">å®˜æ–¹æ–‡æ¡£</a>æ¥é…ç½®ä½ çš„ç¯å¢ƒï¼Œè¿™é‡Œæˆ‘ä»¬åªåˆ—å‡ºLinuxç¯å¢ƒçš„é…ç½®å‘½ä»¤ã€‚</p><!-- [[[read_end]]] --><pre><code class=\"language-plain\">curl \"https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip\" -o \"awscliv2.zip\"\nunzip awscliv2.zip\nsudo ./aws/install\n</code></pre><p>å½“AWS CLIå·¥å…·å®‰è£…æˆåŠŸä¹‹åï¼Œåˆ«å¿˜äº†æ£€æŸ¥ä¸€ä¸‹ç‰ˆæœ¬è¾“å‡ºã€‚</p><pre><code class=\"language-plain\">root@devops:~/aws# /usr/local/bin/aws --version\naws-cli/2.8.1 Python/3.9.11 Linux/5.15.0-48-generic exe/x86_64.ubuntu.22 prompt/off\n</code></pre><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åœ¨IAMä¸­æ–°å»ºä¸€ä¸ªUSERï¼Œå¹¶ä¸”ç”Ÿæˆä¸€ä¸ªaccess keyã€‚AWS çš„ IAM æ˜¯èº«ä»½å’Œè®¿é—®ç®¡ç†çš„ç¼©å†™ï¼Œæ˜¯ä¸€ç§ Web æœåŠ¡ï¼Œå¯ä»¥å¸®åŠ©ä½ å®‰å…¨åœ°æ§åˆ¶å¯¹ AWS èµ„æºçš„è®¿é—®ã€‚æˆ‘ä»¬å€ŸåŠ© IAMï¼Œå¯ä»¥é›†ä¸­ç®¡ç†æ§åˆ¶ç”¨æˆ·å¯è®¿é—®å“ªäº› AWS èµ„æºçš„æƒé™ã€‚</p><p>å¯¹äºåˆæ¬¡æ¥è§¦å…¬æœ‰äº‘ç¯å¢ƒçš„åŒå­¦ï¼Œæˆ‘å»ºè®®ä½¿ç”¨adminæƒé™ï¼Œè¿™æ ·èƒ½å¸®ä½ åœ¨åç»­å­¦ä¹ ä¸­å‡å°‘ä¸€äº›æƒé™é—®é¢˜ã€‚<strong>ä½†æ˜¯è¦æ³¨æ„ï¼Œè¿™å¹¶ä¸æ˜¯ä¸€ä¸ªæ­£ç¡®çš„åšæ³•ï¼Œä¸èƒ½åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ã€‚</strong>å…³äºIAMçš„å®‰å…¨éƒ¨åˆ†ï¼Œåç»­ç« èŠ‚æˆ‘å†è¯¦ç»†è®²è§£ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/b6/0d/b66a1086ea54f80215788a96c9b04b0d.jpg?wh=2900x1836\" alt=\"\"></p><p>å½“ä½ å®Œæˆäº†æ–°ç”¨æˆ·çš„åˆ›å»ºä»¥åŠèµ‹æƒä¹‹åï¼Œå°±éœ€è¦åœ¨AWS CLIå·¥å…·ä¸­å®Œæˆé…ç½®ã€‚é…ç½®çš„å†…å®¹ä¹Ÿå¾ˆç®€å•ï¼Œå°†ä½ ä¸Šä¸€æ­¥è·å–åˆ°çš„Access IDå’ŒKeyå¡«å…¥å³å¯ã€‚</p><pre><code class=\"language-plain\">root@devops:~# aws configure\nAWS Access Key ID [None]: AKIAY6CN....\nAWS Secret Access Key [None]: 482iR9LP3bbCV.....BmZi/Q\nDefault region name [None]: us-east-2\nDefault output format [None]:\n</code></pre><h2>ä½¿ç”¨tfenvç®¡ç†Terraformç‰ˆæœ¬</h2><p>ä¹‹å‰çš„è¯¾ç¨‹é‡Œï¼Œæˆ‘ä»¬è™½ç„¶äº†è§£äº†Terraformçš„ä¸€äº›åŸºæœ¬æ“ä½œï¼Œä½†æ˜¯åœ¨å®é™…å·¥ä½œä¸­ï¼Œå½“ä½ æ¥æ‰‹å‰äººçš„ä»£ç ï¼Œè¿˜æ˜¯ä¼šé‡åˆ°åé¢è¿™ç±»å›°éš¾ã€‚</p><ul>\n<li>å› ä¸ºTerraformåœ¨ä¸åŒçš„ç‰ˆæœ¬å­˜åœ¨ä¸€äº›å…¼å®¹æ€§é—®é¢˜ï¼Œåœ¨version.tfä¸­éœ€è¦ä½¿ç”¨æŸä¸ªç‰¹å®šç‰ˆæœ¬çš„Terraformã€‚</li>\n<li>ä»£ç å¹´ä¹…å¤±ä¿®ï¼Œä»åœ¨ä½¿ç”¨æŸä¸ªå¾ˆè€çš„Terraformç‰ˆæœ¬ï¼Œç¼ºå°‘ä¸€äº›æ–°ç‰ˆæœ¬çš„ç‰¹æ€§ã€‚</li>\n</ul><p>è¿™æ—¶å€™ä½ å°±éœ€è¦ä¸€ä¸ªTerraformç‰ˆæœ¬ç®¡ç†å·¥å…·ï¼Œå¸®åŠ©ä½ åœ¨ä¸åŒçš„ç‰ˆæœ¬ä¸­åˆ‡æ¢ã€‚è¿™é‡Œæˆ‘ä»¬éœ€è¦ç”¨åˆ° <code>tfenv</code> æ¥å¸®åŠ©æˆ‘ä»¬ç®¡ç†Terraformçš„ç‰ˆæœ¬ï¼Œå®ƒçš„GitHubçš„åœ°å€æ˜¯è¿™ä¸ªï¼š<a href=\"https://github.com/tfutils/tfenv\">https://github.com/tfutils/tfenv</a>ã€‚</p><p>å¦‚æœä½ æ²¡æœ‰ç”¨è¿‡tfenvï¼Œå¯ä»¥å‚è€ƒ<a href=\"https://github.com/tfutils/tfenv#manual\">å®˜æ–¹æä¾›çš„æ–¹æ³•</a>è¿›è¡Œå®‰è£…ã€‚tfenvçš„æ ¸å¿ƒç”¨æ³•å°±æ˜¯å°†è¿œç¨‹çš„ä¸åŒç‰ˆæœ¬Terraformä¸‹è½½ä¸‹æ¥ï¼Œç„¶åé€šè¿‡æ”¹å˜ç¯å¢ƒå˜é‡æ¥åˆ‡æ¢æˆæŒ‡å®šç‰ˆæœ¬ã€‚å½“ä½ è£…å¥½tfenvä¹‹åï¼Œå¯ä»¥ä½¿ç”¨list-remoteå‚æ•°æ¥æŸ¥çœ‹æ‰€æœ‰çš„terraformçš„ç‰ˆæœ¬å·ï¼Œå¹¶æŒ‡å®šæ‰€éœ€è¦çš„ç‰ˆæœ¬ã€‚</p><pre><code class=\"language-plain\">root@devops:~# tfenv list-remote\n</code></pre><p>ç„¶åï¼Œä½ å¯ä»¥ä½¿ç”¨latestçš„å‚æ•°å®‰è£…æœ€æ–°ç‰ˆæœ¬ï¼Œä¹Ÿå¯ä»¥å®‰è£…æŒ‡å®šç‰ˆæœ¬ã€‚</p><pre><code class=\"language-plain\">root@devops:~# tfenv install latest\nInstalling Terraform v1.3.2\nDownloading release tarball from https://releases.hashicorp.com/terraform/1.3.2/terraform_1.3.2_linux_amd64.zip\n############################################################################################################################################################################################## 100.0%\nDownloading SHA hash file from https://releases.hashicorp.com/terraform/1.3.2/terraform_1.3.2_SHA256SUMS\nNot instructed to use Local PGP (/root/.tfenv/use-{gpgv,gnupg}) &amp; No keybase install found, skipping OpenPGP signature verification\nArchive:&nbsp; /tmp/tfenv_download.cTS98Z/terraform_1.3.2_linux_amd64.zip\n&nbsp; inflating: /root/.tfenv/versions/1.3.2/terraform\nInstallation of terraform v1.3.2 successful. To make this your default version, run 'tfenv use 1.3.2'\n</code></pre><pre><code class=\"language-plain\">root@devops:~/infra-automation/terraform/eks/example# tfenv install 1.2.0\nInstalling Terraform v1.2.0\nDownloading release tarball from https://releases.hashicorp.com/terraform/1.2.0/terraform_1.2.0_linux_amd64.zip\n############################################################################################################################################################################################## 100.0%\nDownloading SHA hash file from https://releases.hashicorp.com/terraform/1.2.0/terraform_1.2.0_SHA256SUMS\nNot instructed to use Local PGP (/root/.tfenv/use-{gpgv,gnupg}) &amp; No keybase install found, skipping OpenPGP signature verification\nArchive:&nbsp; /tmp/tfenv_download.TpmQi9/terraform_1.2.0_linux_amd64.zip\n&nbsp; inflating: /root/.tfenv/versions/1.2.0/terraform\nInstallation of terraform v1.2.0 successful. To make this your default version, run 'tfenv use 1.2.0'\nroot@devops:~/infra-automation/terraform/eks/example# tfenv use 1.2.0\nSwitching default version to v1.2.0\nDefault version (when not overridden by .terraform-version or TFENV_TERRAFORM_VERSION) is now: 1.2.0\nroot@devops:~/infra-automation/terraform/eks/example#\n</code></pre><h2>è¯¾ç¨‹ä»£ç çš„æ¦‚è¿°</h2><p>æˆ‘åœ¨GitHubä¸Šå»ºç«‹äº†ä¸€ä¸ªcloudnative-automationçš„ç»„ç»‡ï¼Œæ‰€æœ‰çš„è¯¾ç¨‹ä»£ç ï¼Œå®ç°æ–¹å¼éƒ½ä¼šå±•ç°åœ¨è¿™ä¸ªç»„ç»‡ä¸­ã€‚</p><p>é¦–å…ˆï¼Œä½ éœ€è¦ä»GitHubä¸Šå°†è¯¾ç¨‹ä»£ç cloneåˆ°æœ¬åœ°ï¼Œé“¾æ¥æ˜¯<a href=\"https://github.com/cloudnative-automation/eks-cluster/tree/example\">https://github.com/cloudnative-automation/eks-cluster/tree/example</a>ã€‚</p><p>æˆ‘ç»™ä½ ç®€å•è®²è§£ä¸‹exampleé‡Œçš„æ–‡ä»¶åˆ†åˆ«æ˜¯ä»€ä¹ˆä½œç”¨ã€‚</p><p><code>versions.tf</code> å®šä¹‰äº†ä¸Terraformç›¸å…³çš„å‚æ•°ï¼Œæ¯”å¦‚ç‰ˆæœ¬å·ã€ä½¿ç”¨æ¨¡å—çš„ç‰ˆæœ¬ç­‰ç­‰ï¼Œè¿™é‡Œæˆ‘ä»¬å°†Terraformçš„ç‰ˆæœ¬è®¾ç½®ä¸º1.2ï¼ŒAWSæ¨¡å—çš„ç‰ˆæœ¬è®¾ç½®ä¸º4.15ã€‚</p><pre><code class=\"language-plain\">terraform {\n&nbsp; required_providers {\n&nbsp;&nbsp;&nbsp; aws = {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; source&nbsp; = \"hashicorp/aws\"\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; version = \"~&gt; 4.15.0\"\n&nbsp;&nbsp;&nbsp; }\n\n&nbsp;&nbsp;&nbsp; random = {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; source&nbsp; = \"hashicorp/random\"\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; version = \"3.1.0\"\n&nbsp;&nbsp;&nbsp; }\n&nbsp; }\n\n&nbsp; required_version = \"~&gt; 1.2.0\"\n}\n</code></pre><p><code>variables.tf</code> åŒ…å«ä¸€ä¸ªåŒºåŸŸå˜é‡ï¼Œæ§åˆ¶ç€åœ¨å“ªé‡Œåˆ›å»ºEKSé›†ç¾¤ã€‚è¿™é‡Œé¢æœ‰ä¸€äº›å‚æ•°æˆ‘ä»¬åœ¨å‰é¢çš„aws configureé‡Œé…ç½®è¿‡ï¼Œé‚£ä¹ˆåœ¨<code>variables.tf</code> é…ç½®çš„å‚æ•°ä¼šå»è¦†ç›–å‰é¢aws configureé…ç½®çš„å‚æ•°ã€‚</p><p>å†æ¥çœ‹ <code>vpc.tf</code> ï¼Œå®ƒèƒ½ä¸ºæˆ‘ä»¬æä¾›ä¸€ä¸ªVPCã€å­ç½‘å’Œå¯ç”¨åŒºã€‚ä¸ºäº†ä¸å½±å“ç”¨æˆ·ç°æœ‰çš„äº‘ç¯å¢ƒå’Œèµ„æºï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨vpc.tfåˆ›å»ºä¸€ä¸ªæ–°çš„VPCã€‚</p><p>åœ¨vpc.tfä¸­æˆ‘ä»¬éœ€è¦é…ç½®ä¸¤ä¸ªç½‘æ®µï¼Œä¸€ä¸ªä¸“é—¨ä¸ºå†…ç½‘æœåŠ¡ï¼Œå¦ä¸€ä¸ªä¸ºå¤–ç½‘æœåŠ¡ï¼Œä½†æ˜¯æœ‰ä¸¤ä¸ªåœ°æ–¹è¦æ³¨æ„ã€‚</p><ol>\n<li>ç½‘æ®µä¸èƒ½é‡å¤ã€‚</li>\n<li>å­ç½‘æ©ç å»ºè®®ä¸è¦ä½äº24ï¼ŒEKSçš„CNIç½‘ç»œä¼šä»VPCçš„subneté‡Œå–IPï¼Œæ‰€ä»¥é›†ç¾¤è¶Šå¤§ï¼Œéœ€è¦çš„IPè¶Šå¤šã€‚</li>\n</ol><pre><code class=\"language-plain\">&nbsp; private_subnets = [\"10.0.1.0/24\", \"10.0.2.0/24\", \"10.0.3.0/24\"]\n&nbsp; public_subnets&nbsp; = [\"10.0.4.0/24\", \"10.0.5.0/24\", \"10.0.6.0/24\"]\n</code></pre><p>æ¥ç€æ˜¯ <code>security-groups.tf</code> ï¼Œå®ƒè§„å®šäº†EKSé›†ç¾¤å°†ä½¿ç”¨çš„å®‰å…¨ç»„ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä¸ºæ¯ä¸ªnode groupéƒ½é…ç½®äº†è§„åˆ™ç­–ç•¥ï¼Œä½ å¯ä»¥æ ¹æ®ä½ å®é™…éœ€æ±‚æ¥æ”¾è¡Œç«¯å£ï¼Œæ¯”å¦‚è¿™ä¸ªä¾‹å­é‡Œæ”¾è¡Œçš„å°±æ˜¯22ç«¯å£ã€‚</p><pre><code class=\"language-plain\">resource \"aws_security_group\" \"node_group_one\" {\n&nbsp; name_prefix = \"node_group_one\"\n&nbsp; vpc_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = module.vpc.vpc_id\n&nbsp; ingress {\n&nbsp;&nbsp;&nbsp; from_port = 22\n&nbsp;&nbsp;&nbsp; to_port&nbsp;&nbsp; = 22\n&nbsp;&nbsp;&nbsp; protocol&nbsp; = \"tcp\"\n&nbsp;&nbsp;&nbsp; cidr_blocks = [\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \"10.0.0.0/8\",\n&nbsp;&nbsp;&nbsp; ]\n&nbsp; }\n}\n</code></pre><p>æœ€åæ¥çœ‹ <code>eks-cluster.tf</code> ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨AWS EKSæ¨¡å—æ¥é…ç½®EKSé›†ç¾¤å’Œå…¶ä»–æ‰€éœ€èµ„æºï¼ŒåŒ…æ‹¬è‡ªåŠ¨æ‰©å±•ç»„ã€å®‰å…¨ç»„ã€IAMè§’è‰²å’ŒIAMç­–ç•¥ã€‚</p><p>è¿™é‡Œé¢æœ‰å‡ ä¸ªå‚æ•°éœ€è¦ä½ æ³¨æ„ã€‚</p><p><code>cluster_version</code> å®šä¹‰äº†è¿™ä¸ªé›†ç¾¤çš„ç‰ˆæœ¬ï¼Œæˆ‘ä»¬éœ€è¦åœ¨AWSä¸Šç¡®è®¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å“ªäº›ç‰ˆæœ¬ã€‚åœ¨æ ·ä¾‹ä¸­æˆ‘ä½¿ç”¨çš„æ˜¯1.22è¿™ä¸ªå¤§ç‰ˆæœ¬ã€‚</p><p><code>ami_type</code> è¡¨ç¤ºä½ è¦é€‰æ‹©ä»€ä¹ˆç±»å‹çš„æ“ä½œç³»ç»Ÿé•œåƒã€‚æˆ‘æ›¾åœ¨ç¬¬ä¸‰è®²å¸¦ä½ äº†è§£è¿‡ä¸“é—¨ä¸ºå®¹å™¨è®¾è®¡çš„æ“ä½œç³»ç»Ÿâ€”â€” Bottlerocketï¼Œå»ºè®®åœ¨è¿™é‡Œé€‰æ‹©ä½¿ç”¨Bottlerocketã€‚å¦‚æœä½ å¯¹å®¹å™¨è¿˜ä¸å¤ªç†Ÿæ‚‰ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©Amazon Linuxä½œä¸ºæ“ä½œç³»ç»Ÿã€‚</p><p><code>instance_types</code> æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œä½ å¯ä»¥åŠ å…¥å¤šç§æœºå‹ã€‚è¿™é‡Œæ³¨æ„ï¼Œå°½ç®¡å…¬æœ‰äº‘å‚å•†å‡†å¤‡äº†å¤§é‡çš„æœåŠ¡å™¨ï¼Œä½†æ˜¯å®ƒä»¬ä¸æ˜¯ä¸‡èƒ½çš„ã€‚æˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°åœ¨æŸä¸ªregionã€æŸç§æœºå‹å¯ä»¥è´­ä¹°çš„æ•°é‡åƒç´§çš„çŠ¶å†µï¼Œæ‰€ä»¥å»ºè®®å¤šåŠ å‡ ç§ç±»å‹çš„æœºå™¨ã€‚</p><p><code>min_size, max_size, desired_size</code> å®šä¹‰äº†é›†ç¾¤æœ€å°‘æœºå™¨æ•°é‡ã€æœ€å¤šæœºå™¨æ•°é‡ä»¥åŠé»˜è®¤æœºå™¨æ•°é‡ã€‚</p><h2>å¯åŠ¨é›†ç¾¤</h2><p>åœ¨è®²è§£å®Œä»£ç ä¹‹åï¼Œæˆ‘ä»¬æ¥å¯åŠ¨ä¸€ä¸ªKubernetesé›†ç¾¤ã€‚</p><p>é¦–å…ˆé€šè¿‡å‘½ä»¤è¡Œè¿›å…¥exampleçš„ç›®å½•ï¼Œæ‰§è¡Œ <code>terraform init</code> è¿™æ¡å‘½ä»¤ã€‚initå‘½ä»¤ä¼šæ ¹æ®ä½ é…ç½®æ–‡ä»¶é‡Œçš„è¦æ±‚ï¼Œå°†ç›¸å¯¹åº”çš„Terraformæ¨¡å—ä¸‹è½½åˆ°æœ¬åœ°ã€‚</p><pre><code class=\"language-plain\">root@devops:~/infra-automation/terraform/eks/example# terraform init\nInitializing modules...\nDownloading registry.terraform.io/terraform-aws-modules/eks/aws 18.26.6 for eks...\n- eks in .terraform/modules/eks\n- eks.eks_managed_node_group in .terraform/modules/eks/modules/eks-managed-node-group\n- eks.eks_managed_node_group.user_data in .terraform/modules/eks/modules/_user_data\n- eks.fargate_profile in .terraform/modules/eks/modules/fargate-profile\nDownloading registry.terraform.io/terraform-aws-modules/kms/aws 1.0.2 for eks.kms...\n- eks.kms in .terraform/modules/eks.kms\n- eks.self_managed_node_group in .terraform/modules/eks/modules/self-managed-node-group\n- eks.self_managed_node_group.user_data in .terraform/modules/eks/modules/_user_data\nDownloading registry.terraform.io/terraform-aws-modules/vpc/aws 3.14.2 for vpc...\n- vpc in .terraform/modules/vpc\n\nInitializing the backend...\n\nInitializing provider plugins...\n- Reusing previous version of hashicorp/tls from the dependency lock file\n- Reusing previous version of hashicorp/cloudinit from the dependency lock file\n- Reusing previous version of hashicorp/aws from the dependency lock file\n- Reusing previous version of hashicorp/random from the dependency lock file\n- Reusing previous version of hashicorp/kubernetes from the dependency lock file\n- Installing hashicorp/cloudinit v2.2.0...\n- Installed hashicorp/cloudinit v2.2.0 (signed by HashiCorp)\n- Installing hashicorp/aws v4.15.1...\n- Installed hashicorp/aws v4.15.1 (signed by HashiCorp)\n- Installing hashicorp/random v3.1.0...\n- Installed hashicorp/random v3.1.0 (signed by HashiCorp)\n- Installing hashicorp/kubernetes v2.12.1...\n- Installed hashicorp/kubernetes v2.12.1 (signed by HashiCorp)\n- Installing hashicorp/tls v3.4.0...\n- Installed hashicorp/tls v3.4.0 (signed by HashiCorp)\n\nTerraform has made some changes to the provider dependency selections recorded\nin the .terraform.lock.hcl file. Review those changes and commit them to your\nversion control system if they represent changes you intended to make.\n\nTerraform has been successfully initialized!\n\nYou may now begin working with Terraform. Try running \"terraform plan\" to see\nany changes that are required for your infrastructure. All Terraform commands\nshould now work.\n\nIf you ever set or change modules or backend configuration for Terraform,\nrerun this command to reinitialize your working directory. If you forget, other\ncommands will detect it and remind you to do so if necessary.\n</code></pre><p>å½“æ¨¡å—åˆå§‹åŒ–å®Œæ¯•ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ <code>terraform apply</code> å‘½ä»¤æ¥åˆ›å»ºä¸€ä¸ªEKSé›†ç¾¤ã€‚è¿™æ­¥åŠ¨ä½œå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿåˆ°åå‡ åˆ†é’Ÿä¸ç­‰ï¼Œæ—¶é•¿å–å†³äºæ•´ä¸ªç¯å¢ƒåœ¨å‰é¢æ˜¯å¦æœ‰è¿‡åˆå§‹åŒ–ã€‚</p><pre><code class=\"language-plain\">root@devops:~/infra-automation/terraform/eks/example# terraform apply\nPlan: 56 to add, 0 to change, 0 to destroy.\n\nChanges to Outputs:\n&nbsp; + cluster_endpoint&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = (known after apply)\n&nbsp; + cluster_id&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = (known after apply)\n&nbsp; + cluster_name&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = (known after apply)\n&nbsp; + cluster_security_group_id = (known after apply)\n&nbsp; + region&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = \"us-east-2\"\n\nDo you want to perform these actions?\n&nbsp; Terraform will perform the actions described above.\n&nbsp; Only 'yes' will be accepted to approve.\n\n&nbsp; Enter a value: yes\n\nrandom_string.suffix: Creating...\nrandom_string.suffix: Creation complete after 0s [id=4hrTXxaD]\n</code></pre><p>å®ŒæˆapplyåŠ¨ä½œä»¥åï¼Œterraformä¼šå°†é›†ç¾¤çš„åœ°å€ã€IDã€nameéƒ½æ‰“å°åœ¨ç»ˆç«¯ã€‚æ­¤æ—¶éœ€è¦ä½ è®°å½•ä¸‹è¿™äº›ä¿¡æ¯ã€‚å› ä¸ºä¹‹åæˆ‘ä»¬è¦ç”¨åˆ°è¿™äº›ä¿¡æ¯æ¥ç”Ÿæˆkubeconfigï¼Œä»è€Œè¿æ¥é›†ç¾¤ã€‚</p><pre><code class=\"language-plain\">Apply complete! Resources: 56 added, 0 changed, 0 destroyed.\n\nOutputs:\n\ncluster_endpoint = \"https://4D58C6B2B0213AA1FB0925F950CEB497.gr7.us-east-2.eks.amazonaws.com\"\ncluster_id = \"education-eks-4hrTXxaD\"\ncluster_name = \"education-eks-4hrTXxaD\"\ncluster_security_group_id = \"sg-0ffee9cb0c254f781\"\nregion = \"us-east-2\"\nroot@devops:~/infra-automation/terraform/eks/example#\n</code></pre><p>åŒæ—¶ï¼Œæˆ‘ä»¬åœ¨AWSçš„consoleä¸ŠæŸ¥è¯¢ä¸€ä¸‹ï¼Œçœ‹çœ‹é›†ç¾¤æ˜¯å¦å»ºç«‹æˆåŠŸã€‚å¦‚æœå‡ºç°åé¢è¿™æ ·çš„æˆªå›¾å°±è¡¨ç¤ºå»ºç«‹æˆåŠŸäº†ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/a7/d9/a7010443833d593dc1e46fc176f920d9.jpg?wh=1027x504\" alt=\"\"></p><p>å½“æˆ‘ä»¬çœ‹åˆ°é›†ç¾¤çš„çŠ¶æ€æ˜¯ç»¿è‰²æ ‡è®°â€œæ´»åŠ¨â€çš„æ—¶å€™ï¼Œä»£è¡¨æ­¤æ—¶æˆ‘ä»¬å·²ç»è·å¾—äº†ä¸€ä¸ªå¯ä»¥ä½¿ç”¨çš„Kubernetesé›†ç¾¤ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥é…ç½®é›†ç¾¤çš„kubeconfigï¼Œæ­¤æ—¶æˆ‘ä»¬éœ€è¦ç”¨åˆ°AWS CLIè¿™ä¸ªå·¥å…·ï¼Œå®ƒä¼šå¸®æˆ‘ä»¬æŠŠEKSçš„é…ç½®ä¸‹è½½åˆ°æœ¬åœ° <code>.kube/config</code> ä¸­ã€‚</p><pre><code class=\"language-plain\">root@devops:~# aws eks --region us-east-2 update-kubeconfig --name education-eks-4hrTXxaD\nAdded new context arn:aws:eks:us-east-2:614342226570:cluster/education-eks-4hrTXxaD to /root/.kube/conroot@devops:~/infra-automation/terraform/eks/example# terraform initfig\n</code></pre><p>ç°åœ¨ï¼Œä½ ç”¨kubectlè¿™ä¸ªå‘½ä»¤å°±å¯ä»¥çœ‹åˆ°è¿™ä¸ªé›†ç¾¤æƒ…å†µäº†ã€‚</p><pre><code class=\"language-plain\">root@devops:~# kubectl get node\nNAME&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;STATUS&nbsp; &nbsp;ROLES&nbsp; &nbsp; AGE&nbsp; &nbsp; &nbsp;VERSION\nip-10-0-1-65.us-east-2.compute.internal&nbsp; &nbsp; Ready&nbsp; &nbsp; &lt;none&gt;&nbsp; &nbsp;4m9s&nbsp; &nbsp; v1.22.12-eks-ba74326\nip-10-0-2-92.us-east-2.compute.internal&nbsp; &nbsp; Ready&nbsp; &nbsp; &lt;none&gt;&nbsp; &nbsp;4m24s&nbsp; &nbsp;v1.22.12-eks-ba74326\nip-10-0-3-141.us-east-2.compute.internal&nbsp; &nbsp;Ready&nbsp; &nbsp; &lt;none&gt;&nbsp; &nbsp;4m19s&nbsp; &nbsp;v1.22.12-eks-ba74326\nroot@devops:~#\n</code></pre><p>è¿™æ ·æˆ‘ä»¬å°±é€šè¿‡IaCçš„æ–¹å¼å¾—åˆ°äº†ä¸€ä¸ªå…¨æ–°çš„Kuberentesé›†ç¾¤ã€‚</p><h2>é›†ç¾¤å‡çº§</h2><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç»§ç»­ç»“åˆå®ä¾‹ï¼Œçœ‹çœ‹å¦‚ä½•ç»™é›†ç¾¤å‡çº§ï¼Œè¿™æ˜¯Kubernetesé›†ç¾¤ç®¡ç†çš„é«˜é¢‘æ“ä½œã€‚</p><p>ä¹‹å‰çš„é…ç½®ä¸­ï¼Œ <code>cluster_version</code> æ˜¯1.22ã€‚éœ€è¦å‡çº§é›†ç¾¤æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦æ”¹å†™ä¸‹é¢çš„é…ç½®ï¼Œå°†cluster_versionä»1.22æ”¹æˆ1.23ã€‚</p><pre><code class=\"language-plain\">&nbsp; version = \"18.26.6\"\n\n&nbsp; cluster_name&nbsp; &nbsp; = local.cluster_name\n&nbsp; cluster_version = \"1.23\"\n\n&nbsp; vpc_id&nbsp; &nbsp; &nbsp;= module.vpc.vpc_id\n</code></pre><p>ç„¶åï¼Œæˆ‘ä»¬å†è·‘ä¸€æ¬¡terraform applyï¼Œå³å¯è‡ªåŠ¨å®Œæˆé›†ç¾¤ç‰ˆæœ¬çš„å‡çº§ã€‚</p><pre><code class=\"language-plain\">root@devops:~/infra-automation/terraform/eks/example# terraform apply\n\n... (çœç•¥äº†ä¸€äº›è¾“å‡º)...\n\nDo you want to perform these actions?\n&nbsp; Terraform will perform the actions described above.\n&nbsp; Only 'yes' will be accepted to approve.\n\n&nbsp; Enter a value: yes\n\nmodule.eks.aws_eks_cluster.this[0]: Modifying... [id=education-eks-4hrTXxaD]\nmodule.eks.aws_eks_cluster.this[0]: Still modifying... [id=education-eks-4hrTXxaD, 10s elapsed]\nmodule.eks.aws_eks_cluster.this[0]: Still modifying... [id=education-eks-4hrTXxaD, 20s elapsed]\nmodule.eks.aws_eks_cluster.this[0]: Still modifying... [id=education-eks-4hrTXxaD, 30s elapsed]\nmodule.eks.aws_eks_cluster.this[0]: Still modifying... [id=education-eks-4hrTXxaD, 40s elapsed]\nmodule.eks.aws_eks_cluster.this[0]: Still modifying... [id=education-eks-4hrTXxaD, 50s elapsed]\nmodule.eks.aws_eks_cluster.this[0]: Still modifying... [id=education-eks-4hrTXxaD, 1m0s elapsed]\nmodule.eks.aws_eks_cluster.this[0]: Still modifying... [id=education-eks-4hrTXxaD, 1m10s elapsed]\nmodule.eks.aws_eks_cluster.this[0]: Still modifying... [id=education-eks-4hrTXxaD, 1m20s elapsed]\nmodule.eks.aws_eks_cluster.this[0]: Still modifying... [id=education-eks-4hrTXxaD, 1m30s elapsed]\n</code></pre><p>æˆ‘ä»¬åœ¨AWSçš„Consoleä¸Šå¯ä»¥è§‚å¯Ÿåˆ°ï¼Œé›†ç¾¤ç°åœ¨çš„çŠ¶æ€æ˜¯æ­£åœ¨æ›´æ–°ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/0c/b9/0cc4024b819ae9f9f651a462cc373fb9.jpg?wh=2900x1404\" alt=\"\"></p><p>å› ä¸ºAWSçš„EKSå‡çº§çš„åŸç†æ˜¯åŠ ä¸€å°æ–°çš„EC2èŠ‚ç‚¹ï¼Œç„¶åå°†è€çš„EC2èŠ‚ç‚¹ä¸‹çº¿ï¼Œæ‰€ä»¥æ•´ä¸ªå‡çº§çš„æ—¶é—´å–å†³äºä½ é›†ç¾¤çš„å¤§å°ã€‚é›†ç¾¤è¶Šå¤§ï¼Œå‡çº§æ—¶é—´è¶Šä¹…ã€‚</p><p>ç­‰å¾…ä¸€æ®µæ—¶é—´åï¼Œé›†ç¾¤å°±é¡ºåˆ©å‡çº§åˆ°1.23è¿™ä¸ªç‰ˆæœ¬äº†ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/0c/75/0cc9d1255535de6fcf948f50422a9975.jpg?wh=2900x1308\" alt=\"\"></p><h2>æ€»ç»“</h2><p>å¦‚æœä½ åœ¨AWSçš„é¡µé¢é‡Œæ¢ç´¢è¿‡ï¼Œå°±ä¼šå‘ç°ä½ å‡ ä¹ä¸å¯èƒ½åœ¨é¡µé¢ä¸Šé€šè¿‡ç‚¹ç‚¹ç‚¹çš„æ–¹å¼ï¼Œé¡ºåˆ©ç‚¹å‡ºä¸€ä¸ªEKSé›†ç¾¤ã€‚è¿™æ˜¯å› ä¸ºAWSåœ¨è®¾è®¡ä¸Šï¼Œå€¾å‘è®©ç”¨æˆ·ä½¿ç”¨ä»£ç æ¥ç®¡ç†äº‘ä¸Šçš„èµ„æºã€‚</p><p>è¿™ä¸€è®²æˆ‘ä»¬é€šè¿‡Terraformè¿™ä¸ªå·¥å…·ï¼Œç†Ÿæ‚‰äº†ç®¡ç†<strong>äº‘èµ„æºçš„ä»£ç ç»“æ„å’Œå…³é”®å‚æ•°</strong>ï¼ŒæˆåŠŸåˆ›å»ºäº†ä¸€ä¸ªEKSé›†ç¾¤ã€‚ç„¶è€Œå¯¹åˆå­¦è€…æ¥è¯´ï¼Œè¿˜æ˜¯ä¼šå¡åœ¨æ€ä¹ˆå†™æ¨¡å—ã€æ€ä¹ˆçœ‹æ‡‚ä»£ç ä¸Šã€‚è¿™ä¸€è®²æˆ‘é‡ç‚¹å¸¦ä½ ç†Ÿæ‚‰äº†æ ¸å¿ƒä»£ç å’Œå…³é”®å‚æ•°ã€‚æ›´è¯¦ç»†çš„ä»£ç è§£é‡Šå’Œåˆ†æï¼Œä½ å¯ä»¥å‚è€ƒæˆ‘ä¸ºä½ å‡†å¤‡çš„ <a href=\"https://github.com/cloudnative-automation/eks-cluster\">GitHubä»£ç </a>ï¼Œè¿˜å¯ä»¥è‡ªè¡ŒæŸ¥é˜…<a href=\"https://developer.hashicorp.com/terraform/tutorials?product_intent=terraform\">Terraformå®˜æ–¹æ–‡æ¡£</a>ã€‚</p><p>é™¤äº†Terraformä¹‹å¤–ï¼Œç¤¾åŒºé‡Œè¿˜æœ‰ä¸å°‘å·¥å…·èƒ½å¸®æˆ‘ä»¬ç”¨ä»£ç æ–¹å¼ç®¡ç†äº‘ä¸Šèµ„æºã€‚æ¯”å¦‚åèµ·ä¹‹ç§€ <a href=\"https://www.pulumi.com\">Pulumi</a>ï¼ŒåŸºäºKubernetesæ–¹å¼ <a href=\"https://www.crossplane.io/\">Crossplane</a>ï¼Œå®ƒä»¬éƒ½å¯ä»¥åšåˆ°ä¸€å¥—ä»£ç ç®¡ç†å¤šäº‘çš„æ–¹å¼ã€‚ä½ å¦‚æœæ„Ÿå…´è¶£å¯ä»¥è¯¾åè‡ªè¡Œæ¢ç´¢ã€‚</p><p>å…¶å®æ— è®ºæ˜¯å“ªç§å·¥å…·ï¼ŒåŸºæœ¬æ€è·¯éƒ½æ˜¯<strong>ä½¿ç”¨ä»£ç æè¿°å¦‚ä½•åˆ†é…å’Œä½¿ç”¨èµ„æºï¼Œç„¶åé€šè¿‡å·¥å…·æ¡†æ¶è°ƒç”¨</strong></p><p><strong>IaaS APIï¼Œæœ€ç»ˆè·å¾—æˆ‘ä»¬æ‰€éœ€çš„èµ„æº</strong>ã€‚å¸Œæœ›ä½ èƒ½ä¸¾ä¸€åä¸‰ï¼Œå‚è€ƒè¿™ä¸€è®²å­¦åˆ°çš„ç®¡ç†æ€è·¯ï¼Œå¥—ç”¨åˆ°å…¶ä»–å…¬ç”¨äº‘ç”šè‡³ç§æœ‰äº‘çš„èµ„æºç®¡ç†ä¸Šã€‚</p><p>ç°åœ¨æˆ‘ä»¬æ˜¯æ‰‹åŠ¨æ‰§è¡Œä»£ç æ¥è·å¾—èµ„æºçš„ï¼Œè¿™æ˜¾ç„¶å¹¶æ²¡å®Œå…¨è¾¾åˆ°è‡ªåŠ¨åŒ–çš„è¦æ±‚ã€‚é‚£å¦‚æœæˆ‘ä»¬æƒ³é€šè¿‡ä¸€äº›æ‰‹æ®µï¼Œæ¯”å¦‚DevOpsçš„CI/CDæ¥è‡ªåŠ¨åŒ–æ‰§è¡Œè¿™äº›ä»£ç è·å¾—èµ„æºï¼Œè¯¥æ€ä¹ˆåšå‘¢ï¼Ÿåç»­è¯¾ç¨‹é‡Œæˆ‘ä¼šç»§ç»­å’Œä½ æ¢è®¨è¿™ä¸ªè¯é¢˜ï¼Œæ•¬è¯·æœŸå¾…ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>ä»Šå¤©ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†Terraformåœ¨å…¬æœ‰äº‘ä¸­å¯åŠ¨äº†ä¸€ä¸ªKubernetesé›†ç¾¤ã€‚ä½†å®é™…å·¥ä½œä¸­ï¼Œå…¬å¸é‡Œåªæœ‰ä¸€ä¸ªé›†ç¾¤çš„æƒ…å†µæå°‘ï¼Œå¾€å¾€æˆ‘ä»¬é¢å¯¹åå¤šä¸ªã€ç”šè‡³ä¸Šç™¾ä¸ªKubernetesé›†ç¾¤ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¦å¦‚ä½•ç®¡ç†å¤šä¸ªé›†ç¾¤çš„Terraformä»£ç å‘¢ï¼Ÿ</p><p>æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºå’Œæˆ‘äº¤æµæ¢è®¨ï¼Œæˆ‘ä»¬ä¸‹ä¸€è®²è§ï¼</p>","comments":[{"had_liked":false,"id":389517,"user_name":"Geek_45a572","can_delete":false,"product_type":"c1","uid":3654504,"ip_address":"é™•è¥¿","ucode":"B0503B2F0D8A6D","user_header":"","comment_is_top":false,"comment_ctime":1712761020,"is_pvip":false,"replies":[{"id":141698,"content":"Hi åŒå­¦ä½ å¥½\n\næˆ‘åœ¨è¯¾ç¨‹ä¸­çš„æ¡ˆä¾‹æ˜¯ä¸ºäº†èƒ½å¤Ÿè®©è®¡ç®—&#47;ç½‘ç»œ&#47;å­˜å‚¨ä¸‰å—å†…å®¹åœ¨ä¸€ä¸ªä¾‹å­ä¸­ä½“ç°ï¼Œæ‰€ä»¥æ”¾åœ¨äº†eksçš„æ¨¡å—ä¸­ã€‚\n\nåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæˆ‘å»ºè®®ä½ å°†ç½‘ç»œç›¸å…³çš„é…ç½®å•ç‹¬æ”¾åœ¨ä¸€ä¸ªç›®å½•ï¼Œå•ç‹¬è¿è¡ŒCI&#47;CDç®¡ç†å’Œé…ç½®ï¼Œeksé€šè¿‡å˜é‡æˆ–è€…hard codeä¹Ÿå¯ä»¥å¼•ç”¨ä½ å»ºå¥½çš„VPC&#47;subnetï¼Œå› ä¸ºVPC&#47;subnetçš„åœ¨å»ºå¥½ä¹‹åé…ç½®å˜åŠ¨å¾ˆå°ã€‚é‚£RDSä¹ŸåŒç†ã€‚\n\nä½ å¯ä»¥æŒ‰éœ€æ‹†ä»½ï¼Œä¹Ÿå¯ä»¥æŒ‰éœ€åˆå¹¶ï¼Œæ¯”å¦‚ä½ å¯ç”¨ä¸€ä¸ªeksé›†ç¾¤ï¼Œè¿™ä¸ªé›†ç¾¤ä¸­çš„åº”ç”¨æ˜¯éœ€è¦S3 bucketï¼Œä½ ä¹Ÿå¯ä»¥å°†ekså’Œbucketæ”¾åœ¨ä¸€ä¸ªæ¨¡å—ä¸­ç®¡ç†ã€‚\n\næˆ‘ä»¬åŸºäºGitOpsçš„æ¨¡å¼ï¼Œç²¾ç»†ç®¡ç†äº‘èµ„æºé…ç½®ï¼Œå„ç±»èµ„æºçš„ç®¡ç†æ–¹å¼æ˜¯éå¸¸ç±»ä¼¼çš„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1043450,"ctime":1712767239,"ip_address":"ä¸Šæµ·","comment_id":389517,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100758001,"comment_content":"è€å¸ˆæ‚¨å¥½ï¼Œæœ‰ä¸€ä¸ªåœºæ™¯ï¼Œæˆ‘çš„vpcä½¿ç”¨tfåˆ›å»ºä¹‹åã€‚åˆ›å»ºäº†rdsä¹Ÿä½¿ç”¨äº†è¿™ä¸ªvpc.  å› ä¸ºæ˜¯åœ¨eksåˆ›å»ºçš„è„šæœ¬ä¸­å†™çš„vpc. æˆ‘æ­¤æ—¶é‡Šæ”¾eksï¼Œé‚£ä¹ˆè¿™ä¸ªvpcä¹Ÿè¢«é‡Šæ”¾äº†è¿™ä¸ªé—®é¢˜åº”è¯¥å¦‚ä½•å¤„ç†ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1043450,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/eb/fa/5dc2bcae.jpg","nickname":"æ½˜é‡","note":"","ucode":"5B60CCA6C00359","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":641567,"discussion_content":"Hi åŒå­¦ä½ å¥½\n\næˆ‘åœ¨è¯¾ç¨‹ä¸­çš„æ¡ˆä¾‹æ˜¯ä¸ºäº†èƒ½å¤Ÿè®©è®¡ç®—/ç½‘ç»œ/å­˜å‚¨ä¸‰å—å†…å®¹åœ¨ä¸€ä¸ªä¾‹å­ä¸­ä½“ç°ï¼Œæ‰€ä»¥æ”¾åœ¨äº†eksçš„æ¨¡å—ä¸­ã€‚\n\nåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæˆ‘å»ºè®®ä½ å°†ç½‘ç»œç›¸å…³çš„é…ç½®å•ç‹¬æ”¾åœ¨ä¸€ä¸ªç›®å½•ï¼Œå•ç‹¬è¿è¡ŒCI/CDç®¡ç†å’Œé…ç½®ï¼Œeksé€šè¿‡å˜é‡æˆ–è€…hard codeä¹Ÿå¯ä»¥å¼•ç”¨ä½ å»ºå¥½çš„VPC/subnetï¼Œå› ä¸ºVPC/subnetçš„åœ¨å»ºå¥½ä¹‹åé…ç½®å˜åŠ¨å¾ˆå°ã€‚é‚£RDSä¹ŸåŒç†ã€‚\n\nä½ å¯ä»¥æŒ‰éœ€æ‹†ä»½ï¼Œä¹Ÿå¯ä»¥æŒ‰éœ€åˆå¹¶ï¼Œæ¯”å¦‚ä½ å¯ç”¨ä¸€ä¸ªeksé›†ç¾¤ï¼Œè¿™ä¸ªé›†ç¾¤ä¸­çš„åº”ç”¨æ˜¯éœ€è¦S3 bucketï¼Œä½ ä¹Ÿå¯ä»¥å°†ekså’Œbucketæ”¾åœ¨ä¸€ä¸ªæ¨¡å—ä¸­ç®¡ç†ã€‚\n\næˆ‘ä»¬åŸºäºGitOpsçš„æ¨¡å¼ï¼Œç²¾ç»†ç®¡ç†äº‘èµ„æºé…ç½®ï¼Œå„ç±»èµ„æºçš„ç®¡ç†æ–¹å¼æ˜¯éå¸¸ç±»ä¼¼çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1712767239,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":389649,"user_name":"å‘æ¡æ©™","can_delete":false,"product_type":"c1","uid":3875922,"ip_address":"ä¸Šæµ·","ucode":"F52E4EB1F9A3C9","user_header":"https://static001.geekbang.org/account/avatar/00/3b/24/52/4e1f33d0.jpg","comment_is_top":false,"comment_ctime":1713168369,"is_pvip":false,"replies":[{"id":141773,"content":"Hiï¼ŒåŒå­¦ä½ å¥½\n\næŠ¥é”™ä¸­å…³é”®è¯æ˜¯InvalidClientTokenIdï¼Œå†æ£€æŸ¥æ£€æŸ¥access tokenå’Œkey","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1043450,"ctime":1713200630,"ip_address":"ä¸Šæµ·","comment_id":389649,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100758001,"comment_content":"$ terraform apply\nâ•·\nâ”‚ Error: error configuring Terraform AWS Provider: error validating provider credentials: error calling sts:GetCallerIdentity: operation error STS: GetCallerIdentity, https response error StatusCode: 403, RequestID: afe63bae-7f5f-45b2-a3b5-80364f4a5f34, api error InvalidClientTokenId: The security token included in the request is invalid.\nâ”‚ \nâ”‚   with provider[&quot;registry.terraform.io&#47;hashicorp&#47;aws&quot;],\nâ”‚   on main.tf line 11, in provider &quot;aws&quot;:\nâ”‚   11: provider &quot;aws&quot; {\n","like_count":0,"discussions":[{"author":{"id":1043450,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/eb/fa/5dc2bcae.jpg","nickname":"æ½˜é‡","note":"","ucode":"5B60CCA6C00359","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":642003,"discussion_content":"Hiï¼ŒåŒå­¦ä½ å¥½\n\næŠ¥é”™ä¸­å…³é”®è¯æ˜¯InvalidClientTokenIdï¼Œå†æ£€æŸ¥æ£€æŸ¥access tokenå’Œkey","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1713200630,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1057056,"avatar":"https://static001.geekbang.org/account/avatar/00/10/21/20/1299e137.jpg","nickname":"ç§‹å¤©","note":"","ucode":"A7E1D953EF7E17","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":653526,"discussion_content":"ä¹Ÿé‡åˆ°äº†è¿™ä¸ªé—®é¢˜ï¼Œè§£å†³ä¸äº†ï¼Œtokenå’Œkeyæ²¡é—®é¢˜","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1731058678,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å¤©æ´¥","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":3875922,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/24/52/4e1f33d0.jpg","nickname":"å‘æ¡æ©™","note":"","ucode":"F52E4EB1F9A3C9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":642133,"discussion_content":"æ£€æŸ¥äº†æ˜¯å¯¹çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1713338311,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":389433,"user_name":"Eason Lau","can_delete":false,"product_type":"c1","uid":1035123,"ip_address":"ä¸Šæµ·","ucode":"51C987C477F1F0","user_header":"https://static001.geekbang.org/account/avatar/00/0f/cb/73/9eb7c992.jpg","comment_is_top":false,"comment_ctime":1712547422,"is_pvip":false,"replies":[{"id":141682,"content":"Hi Eason,\n\nåœ¨nodegroupé‡Œå¯ä»¥æŒ‡å®šæ•°é‡ï¼Œå¤§å°ï¼Œä»£ç è§è¿™é‡Œ\nhttps:&#47;&#47;github.com&#47;cloudnative-automation&#47;eks-cluster&#47;blob&#47;main&#47;eks-cluster.tf#L20-L28\n\neksåšå®Œå®éªŒä¹‹åå¯ä»¥ç”¨terraform destroyåˆ æ‰ï¼Œç”¨çš„æ—¶å€™å†applyã€‚ä¸è¿‡eksçš„ç¡®ä¸åƒazureçš„aksæœ‰å…³é—­é›†ç¾¤çš„åŠŸèƒ½ï¼Œä¸ç”¨çš„æ—¶å€™å…³æ‰ï¼Œåªæ”¶å–ä¸€äº›ç£ç›˜çš„è´¹ç”¨ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1043450,"ctime":1712670657,"ip_address":"ä¸Šæµ·","comment_id":389433,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100758001,"comment_content":"è€å¸ˆè¯·é—®ä½ åœ¨åˆ›å»ºè¿‡ç¨‹ä¸­æœ‰åœ¨å“ªé‡ŒæŒ‡å®šnodeçš„æ•°é‡ä¹ˆï¼Ÿ\nå¦å¤–å°±æ˜¯eksé›†ç¾¤æ˜¯ä¸æ˜¯å¾—æŒºè´µå•Šï¼Ÿè‡ªå·±åšå®éªŒçš„è¯ğŸ˜­","like_count":0,"discussions":[{"author":{"id":1043450,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/eb/fa/5dc2bcae.jpg","nickname":"æ½˜é‡","note":"","ucode":"5B60CCA6C00359","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":641466,"discussion_content":"Hi Eason,\n\nåœ¨nodegroupé‡Œå¯ä»¥æŒ‡å®šæ•°é‡ï¼Œå¤§å°ï¼Œä»£ç è§è¿™é‡Œ\nhttps://github.com/cloudnative-automation/eks-cluster/blob/main/eks-cluster.tf#L20-L28\n\neksåšå®Œå®éªŒä¹‹åå¯ä»¥ç”¨terraform destroyåˆ æ‰ï¼Œç”¨çš„æ—¶å€™å†applyã€‚ä¸è¿‡eksçš„ç¡®ä¸åƒazureçš„aksæœ‰å…³é—­é›†ç¾¤çš„åŠŸèƒ½ï¼Œä¸ç”¨çš„æ—¶å€™å…³æ‰ï¼Œåªæ”¶å–ä¸€äº›ç£ç›˜çš„è´¹ç”¨ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1712670657,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":389415,"user_name":"ğŸ­ ğŸ¹ ğŸ­ ğŸ¹ ğŸ­","can_delete":false,"product_type":"c1","uid":2772251,"ip_address":"æ²³å—","ucode":"44B3C088B96C12","user_header":"https://static001.geekbang.org/account/avatar/00/2a/4d/1b/062941b4.jpg","comment_is_top":false,"comment_ctime":1712481925,"is_pvip":false,"replies":[{"id":141685,"content":"Hiï¼ŒåŒå­¦ä½ å¥½\n\næ–‡ç« ä¸­ä¸¾ä¾‹æ˜¯ä»¥å•é›†ç¾¤ä¸ºä¾‹ï¼Œå¤šä¸ªé›†ç¾¤å…¶å®æ–¹æ³•ä¸€æ ·ï¼Œåªä¸è¿‡åŠ å…¥ä¸åŒçš„å˜é‡å³å¯ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1043450,"ctime":1712671192,"ip_address":"ä¸Šæµ·","comment_id":389415,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100758001,"comment_content":"ä¸ºä»€ä¹ˆç°åœ¨é‡åˆ°çš„åœºæ™¯åŸºæœ¬ä¸Šæ˜¯ä¸€ä¸ªé›†ç¾¤å‘¢ï¼Ÿæ˜¯å› ä¸ºç§æœ‰äº‘çš„åŸå› å—","like_count":0,"discussions":[{"author":{"id":1043450,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/eb/fa/5dc2bcae.jpg","nickname":"æ½˜é‡","note":"","ucode":"5B60CCA6C00359","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":641469,"discussion_content":"Hiï¼ŒåŒå­¦ä½ å¥½\n\næ–‡ç« ä¸­ä¸¾ä¾‹æ˜¯ä»¥å•é›†ç¾¤ä¸ºä¾‹ï¼Œå¤šä¸ªé›†ç¾¤å…¶å®æ–¹æ³•ä¸€æ ·ï¼Œåªä¸è¿‡åŠ å…¥ä¸åŒçš„å˜é‡å³å¯ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1712671192,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":390108,"user_name":"é¦–å¯Œæ‰‹è®°","can_delete":false,"product_type":"c1","uid":1286588,"ip_address":"æ±Ÿè‹","ucode":"879DED4078303C","user_header":"https://static001.geekbang.org/account/avatar/00/13/a1/bc/ef0f26fa.jpg","comment_is_top":false,"comment_ctime":1714376647,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100758001,"comment_content":"å¤šé›†ç¾¤ç®¡ç†çš„æ—¶å€™ï¼Œå°±æŠŠæ¯ä¸ªé›†ç¾¤çš„å·®å¼‚åœ°æ–¹æŠ½å‡ºæ¥ ç”¨å˜é‡çš„æ–¹å¼æ¥ç®¡ç†åº”è¯¥å°±å¯ä»¥äº†","like_count":0},{"had_liked":false,"id":389385,"user_name":"è‰¯å‡¯å°”","can_delete":false,"product_type":"c1","uid":1806492,"ip_address":"å¹¿ä¸œ","ucode":"8204DA338BA8F4","user_header":"https://static001.geekbang.org/account/avatar/00/1b/90/9c/288e4db2.jpg","comment_is_top":false,"comment_ctime":1712371324,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100758001,"comment_content":"é’ˆå¯¹Kubernetesé›†ç¾¤çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œæ¯”å¦‚è¯´éƒ¨ç½²é›†ç¾¤ã€æ‰©å®¹èŠ‚ç‚¹ç­‰ç­‰æ“ä½œï¼Œä½¿ç”¨Kubernetes SIGs çš„ Cluster APIï¼ˆåŸºäºk8s CRDçš„æ–¹å¼æ¥ç®¡ç†Kubernetesé›†ç¾¤ï¼‰ä¼šæ›´åŠ æ–¹ä¾¿ï¼Œä¼—å¤šäº‘å‚å•†éƒ½æä¾›äº†è‡ªå·±çš„providerï¼Œä½¿å¾—å¯ä»¥åŸºäºä¸åŒäº‘å‚å•†çš„åŸºç¡€è®¾æ–½æ¥éƒ¨ç½²Kubernetesé›†ç¾¤ï¼›    ","like_count":0}]}