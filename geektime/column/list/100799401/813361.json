{"id":813361,"title":"23ï½œ10+ SQLæ‰§è¡Œæ€§èƒ½ä¸ä½³çš„çœŸå®æ¡ˆä¾‹ï¼ˆä¸Šï¼‰","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯ä¿Šè¾¾ã€‚</p><p>åœ¨ç¬¬äºŒç«  SQLä¼˜åŒ–ç¯‡çš„å‰é¢å‡ è®²ä¸­ï¼Œæˆ‘ä»¬æ¯”è¾ƒç³»ç»Ÿåœ°å­¦ä¹ äº†MySQLä¸­SQLä¼˜åŒ–çš„åŸºç¡€çŸ¥è¯†ï¼ŒåŒ…æ‹¬ç´¢å¼•è®¿é—®çš„åŸç†ã€ä¼˜åŒ–å™¨æˆæœ¬æ¨¡å‹ã€è¡¨è¿æ¥çš„å‡ ç§ç®—æ³•ã€è¡¨è¿æ¥é¡ºåºçš„è®¡ç®—ã€å­æŸ¥è¯¢çš„ä¼˜åŒ–ç­–ç•¥ã€‚åœ¨è¿™ä¸€è®²é‡Œï¼Œæˆ‘æ•´ç†äº†å·¥ä½œä¸­é‡åˆ°è¿‡çš„åå¤šç§ä¸åŒç±»å‹çš„SQLæ€§èƒ½é—®é¢˜ï¼Œä»¥æ¡ˆä¾‹çš„å½¢å¼æ¥è®²è§£SQLä¼˜åŒ–çš„ä¸€äº›æ€è·¯ã€‚</p><h2>æ¡ˆä¾‹ä¸€ï¼šç´¢å¼•ç¼ºå¤±å¼•èµ·çš„å…¨è¡¨æ‰«æ</h2><p>è¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„SQLã€‚</p><pre><code class=\"language-plain\">SELECT *\nFROM template\nWHERE templet_id = 2 AND status = 1\n</code></pre><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªSQLçš„æ‰§è¡Œè®¡åˆ’ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/yy/08/yy7f412082be832d1e643795fe93f408.png?wh=534x464\" alt=\"å›¾ç‰‡\"></p><p>ä»è¿™ä¸ªæ‰§è¡Œè®¡åˆ’é‡Œï¼Œæˆ‘ä»¬è¦å…³æ³¨è¿™äº›ä¿¡æ¯ï¼š</p><ul>\n<li>\n<p><strong>table</strong>ï¼šè®¿é—®çš„è¡¨ï¼Œè¿™é‡Œæ˜¯templateè¡¨ã€‚</p>\n</li>\n<li>\n<p><strong>type</strong>ï¼šALLï¼Œè¡¨ç¤ºå…¨è¡¨æ‰«æã€‚</p>\n</li>\n<li>\n<p><strong>possible_keys</strong>ï¼šè¿™ä¸ªæŸ¥è¯¢æ²¡æœ‰ç´¢å¼•å¯ä»¥ä½¿ç”¨ã€‚</p>\n</li>\n<li>\n<p><strong>key</strong>ï¼šæŸ¥è¯¢æ²¡æœ‰ä½¿ç”¨ç´¢å¼•ã€‚</p>\n</li>\n<li>\n<p><strong>key_len</strong>ï¼šä½¿ç”¨åˆ°çš„ç´¢å¼•é•¿åº¦ã€‚</p>\n</li>\n<li>\n<p><strong>rows</strong>ï¼šé¢„ä¼°éœ€è¦è®¿é—®çš„æ•°æ®ï¼Œè¿™é‡Œæ˜¯3.6ä¸‡å¤šã€‚</p>\n</li>\n</ul><p>ä»æ‰§è¡Œè®¡åˆ’å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªæŸ¥è¯¢éœ€è¦æ‰«æ3.6ä¸‡è¡Œæ•°æ®ï¼Œæ²¡æœ‰ä»»ä½•ç´¢å¼•å¯ä»¥ä½¿ç”¨ã€‚å¯¹äºè¿™ç§åœºæ™¯ï¼Œæˆ‘ä»¬å¯ä»¥ç»™è¿‡æ»¤æ€§é«˜çš„æ¡ä»¶å»ºç«‹ç´¢å¼•ã€‚</p><pre><code class=\"language-plain\">alter table template\n    add key idx_templateid_status(templet_id, status);\n</code></pre><!-- [[[read_end]]] --><p>è¿™é‡Œçš„å…³é”®æ˜¯è¿‡æ»¤æ€§ï¼Œå¦‚æœè¿‡æ»¤æ€§ä¸é«˜ï¼Œé‚£ä¹ˆå»ºäº†ç´¢å¼•ä¹Ÿä¸ä¸€å®šèƒ½æå‡æ€§èƒ½ã€‚</p><p>è¿‡æ»¤æ€§æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿå¯ä»¥ç†è§£ä¸ºä½¿ç”¨ç»™å®šçš„whereæ¡ä»¶è¿‡æ»¤å‡ºæ¥çš„è®°å½•æ•°å æ€»è®°å½•æ•°çš„æ¯”ä¾‹ï¼Œè¿™ä¸ªæ¯”ä¾‹è¶Šå°ï¼Œé‚£ä¹ˆä½¿ç”¨ç´¢å¼•çš„æ•ˆæœè¶Šå¥½ã€‚æˆ‘ä»¬å¯ä»¥ç”¨ä¸‹é¢è¿™ä¸ªSQLæ¥åˆ†æä¸€ä¸ªå­—æ®µæˆ–å¤šä¸ªå­—æ®µçš„è¿‡æ»¤æ€§ã€‚</p><pre><code class=\"language-plain\">select 1 / count(distinct c) from tab;\n</code></pre><p>å­—æ®µçš„å”¯ä¸€å€¼è¶Šå¤šï¼Œé‚£ä¹ˆä¸Šé¢è¿™ä¸ªSQLçš„æŸ¥è¯¢å€¼å°±è¶Šå°ï¼Œè¿‡æ»¤æ€§è¶Šé«˜ã€‚å¦‚æœè¿‡æ»¤æ€§ä¸º1ï¼Œå°±è¯´æ˜è¿™ä¸ªå­—æ®µçš„æ•°æ®éƒ½æ˜¯ç›¸åŒçš„ã€‚</p><p>åœ¨æœ‰äº›ä¸šåŠ¡åœºæ™¯ä¸‹ï¼Œå¯èƒ½ä¼šå­˜åœ¨æ•°æ®å€¾æ–œï¼ŒæŸäº›å€¼çš„æ•°æ®ç‰¹åˆ«å¤šã€‚å¯ä»¥ç”¨ä¸‹é¢è¿™ä¸ªSQLæ¥åˆ†ææ˜¯å¦å­˜åœ¨æ•°æ®å€¾æ–œã€‚</p><pre><code class=\"language-plain\">select col, count(*) \nfrom tab\ngroup by col \norder by count(*)\ndesc limit 10\n</code></pre><p>å¦‚æœæœ‰æ•°æ®å€¾æ–œï¼Œé‚£ä¹ˆç´¢å¼•æ˜¯å¦æœ‰æ•ˆï¼Œå–å†³äºwhereæ¡ä»¶ä¸­çš„ä¼ å…¥çš„å€¼çš„è¿‡æ»¤æ€§ï¼Œè¿‡æ»¤æ€§é«˜çš„æ¡ä»¶ç»„åˆå¯ä»¥ç”¨ç´¢å¼•æ¥æå‡æŸ¥è¯¢æ•ˆç‡ã€‚åœ¨è¿™ä¸ªæ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬å»ºç«‹äº†ä¸€ä¸ªç»„åˆç´¢å¼•ï¼š</p><pre><code class=\"language-plain\">idx_templateid_status(templet_id, status)\n</code></pre><p>ç»„åˆç´¢å¼•ä¸­å­—æ®µçš„é¡ºåºå¾ˆé‡è¦ï¼Œè¦ç»“åˆä¸šåŠ¡ç³»ç»Ÿä¸­çš„å…¶ä»–SQLæ¥ç»¼åˆè€ƒè™‘ã€‚å½“ç„¶ä»…ä»…å°±æˆ‘ä»¬æ¡ˆä¾‹ä¸­çš„è¿™ä¸ªSQLæ¥è¯´ï¼Œå­—æ®µé¡ºåºå–ï¼ˆtemplet_id, statusï¼‰æˆ–ï¼ˆstatus, templet_idï¼‰éƒ½å¯ä»¥ã€‚</p><h2>æ¡ˆä¾‹äºŒï¼šä¼˜åŒ–æ’åºæ“ä½œ</h2><p>åº”ç”¨ç¨‹åºç»å¸¸éœ€è¦å¯¹è®¿é—®çš„æ•°æ®è¿›è¡Œæ’åºã€‚ä¸‹é¢è¿™ä¸ªSQLä¸­ï¼Œä½¿ç”¨äº†order byã€‚</p><pre><code class=\"language-plain\">SELECT *\nFROM audit_log \nWHERE user_id = ?\nAND log_type = ?\nORDER BY gmt_create DESC\n</code></pre><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ‰§è¡Œè®¡åˆ’ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/20/56/20712798fd7b8ab10ffd62fafc05c956.png?wh=698x386\" alt=\"å›¾ç‰‡\"></p><ul>\n<li>\n<p><strong>key</strong>: idx_userid_logtypeï¼Œä½¿ç”¨äº†idx_userid_logtypeç´¢å¼•ã€‚</p>\n</li>\n<li>\n<p><strong>key_len</strong>: 8ï¼Œuser_idä¸ºbigint</p>\n</li>\n<li>\n<p><strong>ref</strong>: constã€‚</p>\n</li>\n<li>\n<p><strong>Extra</strong>: Using where; Using filesortã€‚</p>\n</li>\n</ul><p>ä»æ‰§è¡Œè®¡åˆ’ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒSQLä½¿ç”¨äº†æ–‡ä»¶æ’åºï¼ˆfilesortï¼‰ã€‚æ’åºä¼šæ¶ˆè€—CPUå’Œå†…å­˜èµ„æºã€‚å¦‚æœå¾…æ’åºçš„æ•°æ®è¶…è¿‡äº†sort_buffer_sizeï¼Œéœ€è¦å°†æ•°æ®å†™å…¥ä¸´æ—¶æ–‡ä»¶ï¼Œè¿›è¡ŒçœŸæ­£çš„æ–‡ä»¶æ’åºã€‚</p><p>ç±»ä¼¼ä¸Šé¢çš„è¿™ä¸ªSQLï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ç´¢å¼•çš„æœ‰åºæ€§æ¥é¿å…æ’åºã€‚åœ¨ç´¢å¼•ä¸­åŠ ä¸Šæ’åºå­—æ®µgmt_createã€‚</p><pre><code class=\"language-plain\">alter table audit_log\n   drop key idx_userid_logtype,\n   add KEY `idx_userid_logtype` (\n     `user_id`,`log_type`,`gmt_create`);\n</code></pre><p>æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ï¼Œå¯ä»¥çœ‹åˆ°Extraä¸­æ²¡æœ‰äº†filesortäº†ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/5a/6d/5ac9de9d4aca3a0b99ed854b3a0ee36d.png?wh=626x370\" alt=\"å›¾ç‰‡\"></p><p>SQLéœ€è¦æ»¡è¶³å‡ ä¸ªæ¡ä»¶ï¼Œæ‰èƒ½ä½¿ç”¨ç´¢å¼•æ¥æ¶ˆé™¤æ’åºã€‚</p><ol>\n<li>\n<p>æ’åºå­—æ®µå‰é¢çš„å­—æ®µï¼ˆè¿™ä¸ªä¾‹å­ä¸­æ˜¯user_id, log_type)ï¼Œéœ€è¦ä»¥ç­‰å€¼æ¡ä»¶ä¼ å…¥åˆ°whereæ¡ä»¶ä¸­ï¼ˆuser_id=xx and log_type=xx)ã€‚</p>\n</li>\n<li>\n<p>å¦‚æœæŒ‰å¤šä¸ªå­—æ®µæ’åº (order by col_1, col_2)ï¼Œé‚£ä¹ˆç´¢å¼•ä¸­è¿™å‡ ä¸ªå­—æ®µä¹Ÿè¦ä»¥åŒæ ·çš„é¡ºåºå»ºç«‹ï¼Œidx(col_1, col_2)ã€‚</p>\n</li>\n</ol><p>å¯¹äºä¾‹å­ä¸­çš„è¿™ä¸ªç´¢å¼• idx(user_id, log_type, gmt_create)ï¼Œå¦‚æœSQLç¼ºå°‘log_typeçš„æ¡ä»¶ï¼Œå°±æ— æ³•ä½¿ç”¨ç´¢å¼•æ¥æ¶ˆé™¤æ’åºäº†ã€‚</p><pre><code class=\"language-plain\">SELECT ï¼Š\nFROM audit_log \nWHERE user_id = ?\nORDER BY gmt_create DESC\n</code></pre><h2>æ¡ˆä¾‹ä¸‰ï¼šå‡½æ•°è¿ç®—å¯¼è‡´æ— æ³•ä½¿ç”¨ç´¢å¼•</h2><p>æœ‰çš„æ—¶å€™ï¼Œæ˜æ˜å­—æ®µä¸Šå·²ç»å»ºç«‹äº†ç´¢å¼•ï¼Œä½†æ˜¯æŸ¥è¯¢è¿˜æ˜¯æ— æ³•ä½¿ç”¨ç´¢å¼•ã€‚å…¶ä¸­æœ‰ä¸€ç§æƒ…å†µæ˜¯å› ä¸ºSQLä¸­å¯¹ç´¢å¼•å­—æ®µè¿›è¡Œäº†å‡½æ•°è¿ç®—ã€‚ä¸‹é¢å°±æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¸¸è§çš„ä¾‹å­ï¼ŒSQLåœ¨gmt_modifiedå­—æ®µä¸Šä½¿ç”¨äº†dateå‡½æ•°ï¼Œç”¨æ¥æŸ¥è¯¢å½“å¤©ä¿®æ”¹è¿‡çš„æ•°æ®ã€‚</p><pre><code class=\"language-plain\">select * from user\nwhere date(gmt_modified) = date(now())\n</code></pre><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ‰§è¡Œè®¡åˆ’ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/a0/d5/a0a9b84abc3016c33e5afdccdf97c6d5.png?wh=534x380\" alt=\"å›¾ç‰‡\"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œpossible_keysæ˜¯ç©ºçš„ï¼Œæ²¡æœ‰ä»»ä½•ç´¢å¼•å¯ç”¨ã€‚å®é™…ä¸Šgmt_modifiedä¸Šæ˜¯æœ‰ç´¢å¼•çš„ã€‚ä½†æ˜¯ç”±äºwhereæ¡ä»¶ä¸­å¯¹gmt_modifiedåšäº†å‡½æ•°è¿ç®—ï¼Œå¯¼è‡´æ— æ³•ä½¿ç”¨ç´¢å¼•ã€‚æˆ‘ä»¬éœ€è¦æ”¹å†™SQLï¼Œé¿å…åœ¨ç´¢å¼•å­—æ®µä¸Šä½¿ç”¨å‡½æ•°ï¼ŒåŒæ—¶è¿˜è¦ä¿æŒSQLçš„é€»è¾‘ä¸å˜ã€‚</p><p>è¿™ä¸ªæ¡ˆä¾‹ä¸­ï¼ŒSQLå¯ä»¥è¿™ä¹ˆæ”¹ã€‚</p><pre><code class=\"language-plain\">select * from user \nwhere gmt_modified &gt;= date(now()) \nand gmt_modified &lt; date(date_add(now(), interval 1 day))\n</code></pre><p>è¿™2ä¸ªSQLçš„é€»è¾‘ä¸€æ ·ï¼Œéƒ½æ˜¯è·å–ä¿®æ”¹æ—¶é—´ä¸ºå½“å¤©çš„ç”¨æˆ·ä¿¡æ¯ã€‚</p><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ”¹å†™åçš„æ‰§è¡Œè®¡åˆ’ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/19/19/194fe29a702c2f8f2081735a4e7b2119.png?wh=776x374\" alt=\"å›¾ç‰‡\"><br>\nå¯ä»¥çœ‹åˆ°ï¼ŒSQLä½¿ç”¨äº†idx_gmt_modifiedç´¢å¼•ï¼Œæ‰«æçš„è®°å½•æ•°ä¸º3119ã€‚è€Œä¹‹å‰å…¨è¡¨æ‰«æéœ€è¦è®¿é—®2.8ä¸‡è¡Œæ•°æ®ã€‚</p><p>MySQL 8.0æ”¯æŒå‡½æ•°ç´¢å¼•ï¼Œä¸Šé¢è¿™ä¸ªSQLï¼Œä¹Ÿèƒ½ç”¨å‡½æ•°ç´¢å¼•æ¥ä¼˜åŒ–ã€‚æˆ‘ä»¬æ¥åšä¸€ä¸ªç®€å•çš„éªŒè¯ï¼Œå…ˆåˆ›å»ºä¸€ä¸ªè¡¨ï¼Œå†™å…¥ä¸€äº›æµ‹è¯•æ•°æ®ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªå‡½æ•°ç´¢å¼•ã€‚</p><pre><code class=\"language-plain\">mysql&gt; create table t_date(\n  id int not null auto_increment, \n  create_time datetime, \n  padding varchar(2000),\n  primary key(id)\n) engine=innodb;\n\n\nmysql&gt; insert into t_date(create_time, padding) \n  select date_add('2024-06-01 00:00:00', interval n hour), \n      rpad('x', 1000, 'abcd ') \n  from numbers;\n\nmysql&gt; alter table t_date \n    add key idx_createtime((date(create_time)));\n</code></pre><p>ä¸‹é¢è¿™ä¸ªSQLä¸­ï¼Œå¯¹ç´¢å¼•å­—æ®µè¿›è¡Œäº†å‡½æ•°è¿ç®—ã€‚ä»æ‰§è¡Œè®¡åˆ’é‡Œå¯ä»¥çœ‹åˆ°ï¼ŒSQLç”¨åˆ°äº†ç´¢å¼•ã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain select * from t_date \n    where date(create_time) = '2024-06-01';\n+----+-------------+--------+------+----------------+----------------+---------+-------+------+----------+-------+\n| id | select_type | table  | type | possible_keys  | key            | key_len | ref   | rows | filtered | Extra |\n+----+-------------+--------+------+----------------+----------------+---------+-------+------+----------+-------+\n|  1 | SIMPLE      | t_date | ref  | idx_createtime | idx_createtime | 4       | const |   24 |   100.00 | NULL  |\n+----+-------------+--------+------+----------------+----------------+---------+-------+------+----------+-------+\n\n\nmysql&gt; show warnings\\G\n*************************** 1. row ***************************\n  Level: Note\n   Code: 1003\nMessage: /* select#1 */ \n  select `rep`.`t_date`.`id` AS `id`,\n    `rep`.`t_date`.`create_time` AS `create_time`,\n    `rep`.`t_date`.`padding` AS `padding` \n  from `rep`.`t_date` \n  where (cast(`create_time` as date) = '2024-06-01')\n</code></pre><p>ç´¢å¼•å­—æ®µä¸Šçš„å‡½æ•°è¿ç®—è¿˜ä¼šä»¥å…¶ä»–å½¢å¼å‡ºç°ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸¤ä¸ªSQLã€‚</p><pre><code class=\"language-plain\">select * from t1 where b+0 = ?;\nselect * from t1 where c||'' = ?;\n</code></pre><h2>æ¡ˆä¾‹å››ï¼šéšå¼ç±»å‹è½¬æ¢</h2><p>ä»ä¸Šä¸€ä¸ªæ¡ˆä¾‹ä¸­æˆ‘ä»¬å·²ç»çŸ¥é“ï¼Œå­—æ®µä¸Šçš„å‡½æ•°è¿ç®—ä¼šå¯¼è‡´SQLæ— æ³•ä½¿ç”¨ç´¢å¼•ã€‚æœ‰äº›æƒ…å†µä¸‹ï¼Œè™½ç„¶æ²¡æœ‰æ˜¾å¼åœ°å¯¹å­—æ®µè¿›è¡Œè¿ç®—ï¼Œä½†ç”±äºå­—æ®µå’Œä¼ å…¥çš„å‚æ•°çš„æ•°æ®ç±»å‹ä¸ä¸€è‡´ï¼Œæ•°æ®åº“ä¼šè¿›è¡Œéšå¼ç±»å‹è½¬æ¢ï¼Œè¿™ä¹Ÿä¼šå¯¼è‡´ç´¢å¼•ä¸å¯ç”¨ã€‚</p><p>ä¸‹é¢æ˜¯éšå¼ç±»å‹è½¬æ¢å¸¸è§çš„å‡ ç§æƒ…å†µã€‚</p><ol>\n<li>\n<p>å­—æ®µç±»å‹ä¸ºvarcharï¼Œå­˜å‚¨äº†æ•°å­—ï¼Œwhereæ¡ä»¶ä¸­ä¼ å…¥äº†æ•°å­—ç±»å‹çš„å‚æ•°ã€‚</p>\n</li>\n<li>\n<p>å­—æ®µç±»å‹ä¸ºvarcharï¼Œå­˜å‚¨äº†æ—¥æœŸä¿¡æ¯ï¼Œwhereæ¡ä»¶ä¸­ä¼ å…¥äº†æ—¥æœŸç±»å‹çš„å‚æ•°ã€‚</p>\n</li>\n<li>\n<p>å­—æ®µç±»å‹å’Œä¼ å…¥çš„å‚æ•°éƒ½æ˜¯varcharç±»å‹ï¼Œä½†æ˜¯å­—ç¬¦é›†ä¸åŒ¹é…ã€‚</p>\n</li>\n<li>\n<p>è¡¨è¿æ¥æ—¶ï¼Œè¿æ¥å­—æ®µåœ¨2ä¸ªè¡¨ä¸­çš„ç±»å‹ä¸ä¸€è‡´ï¼Œæˆ–å­—ç¬¦é›†ä¸ä¸€è‡´ã€‚</p>\n</li>\n</ol><p>æˆ‘ä»¬ç”¨ä¸€ä¸ªä¾‹å­æ¥éªŒè¯å“ªäº›æƒ…å†µä¸‹ï¼Œéšå¼ç±»å‹è½¬æ¢ä¼šå¯¼è‡´ç´¢å¼•ä¸å¯ç”¨ã€‚</p><pre><code class=\"language-plain\">CREATE TABLE `tab` (\n  `id` int NOT NULL AUTO_INCREMENT,\n  `phone` varchar(13) DEFAULT NULL,\n  `phone2` bigint DEFAULT NULL,\n  `create_time` varchar(20) DEFAULT NULL,\n  `create_time2` datetime DEFAULT NULL,\n  PRIMARY KEY (`id`),\n  KEY `idx_phone` (`phone`),\n  KEY `idx_phone2` (`phone2`),\n  KEY `idx_createtime` (`create_time`),\n  KEY `idx_createtime2` (`create_time2`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4\n</code></pre><p>æƒ…å†µ1ï¼šç´¢å¼•å­—æ®µä¸ºvarcharï¼Œä¼ å…¥æ•°å­—ç±»å‹çš„å‚æ•°ï¼Œç´¢å¼•ä¸å¯ç”¨ã€‚ä»warningä¿¡æ¯ä¸­å¯ä»¥çœ‹åˆ°ï¼Œç´¢å¼•ä¸å¯ç”¨çš„åŸå› æ˜¯å‘ç”Ÿäº†ç±»å‹è½¬æ¢ã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain  select * from tab where phone=13512345678;\n+----+-------------+-------+------+---------------+------+---------+------+------+----------+-------------+\n| id | select_type | table | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra       |\n+----+-------------+-------+------+---------------+------+---------+------+------+----------+-------------+\n|  1 | SIMPLE      | tab   | ALL  | idx_phone     | NULL | NULL    | NULL |    1 |   100.00 | Using where |\n+----+-------------+-------+------+---------------+------+---------+------+------+----------+-------------+\n1 row in set, 3 warnings (0.00 sec)\n\n\nmysql&gt; show warnings;\n+---------+------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| Level   | Code | Message                                                                                                                                                                                                                                                                  |\n+---------+------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| Warning | 1739 | Cannot use ref access on index 'idx_phone' due to type or collation conversion on field 'phone'                                                                                                                                                                          |\n| Warning | 1739 | Cannot use range access on index 'idx_phone' due to type or collation conversion on field 'phone'                                                                                                                                                                        |\n| Note    | 1003 | /* select#1 */ select `test`.`tab`.`id` AS `id`,`test`.`tab`.`phone` AS `phone`,`test`.`tab`.`phone2` AS `phone2`,`test`.`tab`.`create_time` AS `create_time`,`test`.`tab`.`create_time2` AS `create_time2` from `test`.`tab` where (`test`.`tab`.`phone` = 13512345678) |\n+---------+------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n3 rows in set (0.00 sec)\n</code></pre><p>å°†ä¼ å…¥çš„å‚æ•°æ”¹æˆå­—ç¬¦ä¸²ç±»å‹ï¼Œå°±å¯ä»¥ä½¿ç”¨åˆ°ç´¢å¼•ã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain  select * from tab where phone='13512345678';\n+----+-------------+-------+------+---------------+-----------+---------+-------+------+----------+-------+\n| id | select_type | table | type | possible_keys | key       | key_len | ref   | rows | filtered | Extra |\n+----+-------------+-------+------+---------------+-----------+---------+-------+------+----------+-------+\n|  1 | SIMPLE      | tab   | ref  | idx_phone     | idx_phone | 55      | const |    1 |   100.00 | NULL  |\n+----+-------------+-------+------+---------------+-----------+---------+-------+------+----------+-------+\n1 row in set, 1 warning (0.00 sec)\n</code></pre><p>æƒ…å†µ2ï¼šç´¢å¼•å­—æ®µç±»å‹ä¸ºvarcharï¼Œä¼ å…¥æ—¥æœŸç±»å‹çš„å‚æ•°ï¼Œç´¢å¼•ä¸å¯ç”¨ã€‚ä»warningä¿¡æ¯ä¸­å¯ä»¥çœ‹åˆ°ï¼Œç´¢å¼•ä¸å¯ç”¨çš„åŸå› æ˜¯å‘ç”Ÿäº†ç±»å‹è½¬æ¢ã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain  select * from tab where create_time = date(now());\n+----+-------------+-------+------+----------------+------+---------+------+------+----------+-------------+\n| id | select_type | table | type | possible_keys  | key  | key_len | ref  | rows | filtered | Extra       |\n+----+-------------+-------+------+----------------+------+---------+------+------+----------+-------------+\n|  1 | SIMPLE      | tab   | ALL  | idx_createtime | NULL | NULL    | NULL |    1 |   100.00 | Using where |\n+----+-------------+-------+------+----------------+------+---------+------+------+----------+-------------+\n1 row in set, 3 warnings (0.00 sec)\n\nmysql&gt; show warnings;\n+---------+------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| Level   | Code | Message                                                                                                                                                                                                                                                                                         |\n+---------+------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| Warning | 1739 | Cannot use ref access on index 'idx_createtime' due to type or collation conversion on field 'create_time'                                                                                                                                                                                      |\n| Warning | 1739 | Cannot use range access on index 'idx_createtime' due to type or collation conversion on field 'create_time'                                                                                                                                                                                    |\n| Note    | 1003 | /* select#1 */ select `test`.`tab`.`id` AS `id`,`test`.`tab`.`phone` AS `phone`,`test`.`tab`.`phone2` AS `phone2`,`test`.`tab`.`create_time` AS `create_time`,`test`.`tab`.`create_time2` AS `create_time2` from `test`.`tab` where (`test`.`tab`.`create_time` = &lt;cache&gt;(cast(now() as date))) |\n+---------+------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n3 rows in set (0.00 sec)\n</code></pre><p>æƒ…å†µ3ï¼šå­—æ®µç±»å‹ä¸ºæ•°å­—ï¼Œä¼ å…¥å­—ç¬¦ä¸²ç±»å‹çš„å‚æ•°ï¼Œæ˜¯å¦ä¹Ÿä¼šå¯¼è‡´ç´¢å¼•ä¸å¯ç”¨å‘¢ï¼Ÿ<br>\næˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹ã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain  select * from tab where phone2 = '13512345678';\n+----+-------------+-------+------+---------------+------------+---------+-------+------+----------+-----------------------+\n| id | select_type | table | type | possible_keys | key        | key_len | ref   | rows | filtered | Extra                 |\n+----+-------------+-------+------+---------------+------------+---------+-------+------+----------+-----------------------+\n|  1 | SIMPLE      | tab   | ref  | idx_phone2    | idx_phone2 | 9       | const |    1 |   100.00 | Using index condition |\n+----+-------------+-------+------+---------------+------------+---------+-------+------+----------+-----------------------+\n1 row in set, 1 warning (0.00 sec)\n\nmysql&gt; show warnings\\G\n*************************** 1. row ***************************\n  Level: Note\n   Code: 1003\nMessage: /* select#1 */ \nselect `test`.`tab`.`id` AS `id`,`test`.`tab`.`phone` AS `phone`,\n    `test`.`tab`.`phone2` AS `phone2`,`test`.`tab`.`create_time` AS `create_time`,\n    `test`.`tab`.`create_time2` AS `create_time2` \nfrom `test`.`tab` \nwhere (`test`.`tab`.`phone2` = 13512345678)\n</code></pre><p>ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œphone2ä¸ºæ•°å­—ç±»å‹ï¼ŒSQLä¸­ä¼ å…¥äº†å­—ç¬¦ä¸²ç±»å‹çš„å‚æ•°ï¼Œç´¢å¼•å¯ç”¨ï¼Œå› ä¸ºè¿™é‡Œç±»å‹è½¬æ¢å‘ç”Ÿåœ¨ä¼ å…¥çš„å‚æ•°ä¸Šã€‚ç±»ä¼¼çš„ï¼Œä¸‹é¢è¿™ç§æƒ…å†µä¹Ÿä¸å½±å“ç´¢å¼•çš„ä½¿ç”¨ã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain  select * from tab where create_time2 = '2023-01-01';\n+----+-------------+-------+------------+------+-----------------+---------+-------+------+----------+-------+\n| id | select_type | table | partitions | type | possible_keys   | key_len | ref   | rows | filtered | Extra |\n+----+-------------+-------+------------+------+-----------------+---------+-------+------+----------+-------+\n|  1 | SIMPLE      | tab   | NULL       | ref  | idx_createtime2 | 6       | const |    1 |   100.00 | NULL  |\n+----+-------------+-------+------------+------+-----------------+---------+-------+------+----------+-------+1 row in set, 1 warning (0.00 sec)\n\nmysql&gt; show warnings\\G\n*************************** 1. row ***************************\n  Level: Note\n   Code: 1003\nMessage: /* select#1 */ \nselect `test`.`tab`.`id` AS `id`,`test`.`tab`.`phone` AS `phone`,\n  `test`.`tab`.`phone2` AS `phone2`,`test`.`tab`.`create_time` AS `create_time`,\n  `test`.`tab`.`create_time2` AS `create_time2` \nfrom `test`.`tab` \nwhere (`test`.`tab`.`create_time2` = TIMESTAMP'2023-01-01 00:00:00')\n</code></pre><p>ä¸ºäº†é¿å…éšå¼ç±»å‹è½¬æ¢å¯¼è‡´ç´¢å¼•ä¸å¯ç”¨ï¼Œæˆ‘æœ‰ä»¥ä¸‹å‡ ç‚¹å»ºè®®ã€‚</p><ol>\n<li>\n<p>è®¾è®¡è¡¨ç»“æ„æ—¶ï¼Œæ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©ç²¾ç¡®çš„å­—æ®µç±»å‹ï¼Œä¸è¦ç”¨varcharç±»å‹å­˜å‚¨æ—¥æœŸå’Œæ•°å­—ã€‚</p>\n</li>\n<li>\n<p>åŒä¸€ä¸ªä¸šåŠ¡å­—æ®µï¼Œåœ¨ä¸åŒçš„è¡¨é‡Œé¢å­—æ®µç±»å‹è¦ä¿æŒä¸€è‡´ï¼Œå­—ç¬¦é›†ä¹Ÿè¦ä¿æŒä¸€è‡´ã€‚</p>\n</li>\n<li>\n<p>SQLä¸­ä¼ å…¥çš„å‚æ•°è¦å’Œå­—æ®µçš„æ•°æ®ç±»å‹ä¿æŒä¸€è‡´ã€‚</p>\n</li>\n</ol><h2>æ¡ˆä¾‹äº”ï¼šå­—ç¬¦é›†ä¸ä¸€è‡´å¯¼è‡´çš„éšå¼ç±»å‹è½¬æ¢</h2><p>æ‰§è¡Œè¡¨è¿æ¥æ—¶ï¼Œå¦‚æœè¿æ¥å­—æ®µåœ¨ä¸¤ä¸ªè¡¨ä¸­çš„å­—ç¬¦é›†ä¸ä¸€è‡´ï¼Œä¹Ÿä¼šå‘ç”Ÿéšå¼ç±»å‹è½¬æ¢ï¼Œä¹Ÿå¯èƒ½ä¼šå¯¼è‡´ç´¢å¼•ä¸å¯ç”¨ã€‚ä¸‹é¢è¿™ä¸ªä¾‹å­å°±æ˜¯è¿™ç§æƒ…å†µã€‚</p><pre><code class=\"language-plain\">SELECT * \nFROM funds\nWHERE  uuid  in ( \n    SELECT uuid \n    FROM patients \n    WHERE create_at != \"0000-00-00 00:00:00\" \n)\n</code></pre><p>å…ˆçœ‹ä¸€ä¸‹æ‰§è¡Œè®¡åˆ’ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/3f/e2/3f388ccd83c65d4007be11449cf701e2.png?wh=1920x384\" alt=\"å›¾ç‰‡\"></p><p>ä¼˜åŒ–å™¨å°†å­æŸ¥è¯¢è½¬æ¢æˆäº†åŠè¿æ¥ï¼Œå¹¶ä½¿ç”¨äº†ä¸´æ—¶è¡¨æ¥å»é‡ï¼ˆStart temporaryï¼ŒEnd temporaryï¼‰ã€‚è¢«é©±åŠ¨è¡¨fundsçš„uuidä¸Šæœ‰å”¯ä¸€ç´¢å¼•ï¼Œä½†æ˜¯æ‰§è¡Œè®¡åˆ’ä¸­æ˜¾ç¤ºè¿™ä¸ªè¡¨æ²¡æœ‰å¯ç”¨çš„ç´¢å¼•ã€‚æŸ¥è¯¢ä½¿ç”¨BNLè¿æ¥ç®—æ³•ï¼ˆBlock Nested Loopï¼‰ã€‚</p><p>æ‰§è¡Œexplain extendedåæŸ¥çœ‹warningsï¼ˆæ³¨ï¼š8.0å·²ç»ä¸æ”¯æŒexplain extendedäº†ï¼‰ï¼Œå‘ç°SQLä¸­æœ‰å­—ç¬¦é›†è½¬æ¢çš„æ“ä½œconvert(b.uuid using utf8mb4)ã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain extended \n    select b.*\n    from patients a, funds b\n    where a.create_at != \"0000-00-00 00:00:00\" \n    and a.uuid=b.uuid\n    \nmysql&gt; show warnings\nselect *\nfrom patients a\n     join funds b\nwhere((a.create_at &lt;&gt; '0000-00-00 00:00:00')\nand(a.uuid= convert(b.uuid using utf8mb4)))\n</code></pre><p>æ£€æŸ¥è¡¨ç»“æ„åå‘ç°ï¼Œä¸¤ä¸ªè¡¨ä¸­uuidçš„å­—ç¬¦é›†ä¸ä¸€æ ·ã€‚</p><pre><code class=\"language-plain\">CREATE TABLE `funds` ( \n     `id` int(11) NOT NULL AUTO_INCREMENT,  \n     `uuid` varchar(128) COLLATE utf8_unicode_ci NOT NULL DEFAULT '' COMMENT 'UUID',\n     ......,\n PRIMARY KEY (`id`),  \nUNIQUE KEY `uuid_idx` (`uuid`)) \nENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;\n\nCREATE TABLE `patients` ( \n     `id` int(11) NOT NULL AUTO_INCREMENT,  \n     `uuid` varchar(128) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT '' COMMENT 'é¡¹ç›®uuid',  \nPRIMARY KEY (`id`)) \nENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n</code></pre><p>fundsè¡¨ä¸­uuidçš„å­—ç¬¦é›†æ˜¯utf8ï¼Œpatientsè¡¨ä¸­uuidçš„å­—ç¬¦é›†æ˜¯utf8mb4ã€‚</p><p>æˆ‘ä»¬æ”¹å†™äº†SQLï¼Œä½¿ç”¨convertå‡½æ•°å°†patients.uuidè½¬æ¢æˆutf8ï¼Œè½½å»å’Œfundsè¡¨è¿æ¥ï¼Œè¿™æ ·å°±é¿å…äº†funds.uuidä¸Šçš„éšå¼ç±»å‹è½¬æ¢ã€‚</p><pre><code class=\"language-plain\">explain extended\n SELECT b.*\nFROM (select convert(uuid using utf8) COLLATE utf8_unicode_ci as uuid\n    from patients \n    where project_create_at != \"0000-00-00 00:00:00\") a, funds b\nWHERE a.uuid = b.uuid\n</code></pre><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹SQLæ”¹å†™åçš„æ‰§è¡Œè®¡åˆ’ï¼Œå¯ä»¥ç”¨åˆ°fundsè¡¨ä¸­uuidçš„å”¯ä¸€ç´¢å¼•äº†ï¼Œtypeä¸ºeq_refã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/3c/98/3cd709044bb710deb1b26fa026290098.png?wh=1920x444\" alt=\"å›¾ç‰‡\"></p><p>ä¸ºäº†é¿å…è¡¨è¿æ¥æ—¶å‘ç”Ÿéšå¼ç±»å‹è½¬æ¢ï¼Œæˆ‘å»ºè®®åŒä¸€ä¸ªä¸šåŠ¡å­—æ®µï¼Œåœ¨ä¸åŒçš„è¡¨é‡Œï¼Œæ•°æ®ç±»å‹å’Œå­—ç¬¦é›†è¦ä¿æŒä¸€è‡´ã€‚</p><p>ä¼˜åŒ–å™¨åœ¨è½¬æ¢å­—ç¬¦é›†æ—¶ï¼Œé€‰æ‹©äº†å°†utf8mb3è½¬æ¢æˆutf8mb4ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªæµ‹è¯•æ¡ˆä¾‹ï¼Œå¯ä»¥è¯´æ˜ä¼˜åŒ–å™¨çš„è¿™ä¸ªé€‰æ‹©ã€‚</p><p>å…ˆåˆ›å»ºä¸¤ä¸ªæµ‹è¯•è¡¨ã€‚</p><pre><code class=\"language-plain\">create table t_1(\n  id int not null auto_increment,\n\tuuid varchar(32),\n\tpadding varchar(2000),\n\tprimary key(id),\n\tkey idx_uuid(uuid)\n) engine=innodb charset utf8mb3;\n\n\ncreate table t_2(\n  id int not null auto_increment,\n\tuuid varchar(32),\n\tpadding varchar(2000),\n\tprimary key(id),\n\tkey idx_uuid(uuid)\n) engine=innodb charset utf8mb4;\n</code></pre><p>t_1è¡¨ä½¿ç”¨utf8mb3å­—ç¬¦é›†ï¼Œt_2è¡¨ä½¿ç”¨utf8mb4å­—ç¬¦é›†ã€‚ä»¥t_1è¡¨ä½œä¸ºé©±åŠ¨è¡¨æ—¶ï¼Œå¯ä»¥ä½¿ç”¨t_2è¡¨uuidçš„ç´¢å¼•ï¼Œå› ä¸ºt_2.uuidæ²¡æœ‰å‘ç”Ÿç±»å‹è½¬æ¢ã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain select * from t_1 straight_join t_2 on t_1.uuid = t_2.uuid;\n+----+-------------+-------+------+---------------+-----------+---------+--------------+------+----------+-----------------------+\n| id | select_type | table | type | possible_keys | key       | key_len | ref          | rows | filtered | Extra                 |\n+----+-------------+-------+------+---------------+-----------+---------+--------------+------+----------+-----------------------+\n|  1 | SIMPLE      | t_1   | ALL  | idx_uuid1     | NULL      | NULL    | NULL         |    1 |   100.00 | Using where           |\n|  1 | SIMPLE      | t_2   | ref  | idx_uuid2     | idx_uuid2 | 131     | rep.t_1.uuid |    1 |   100.00 | Using index condition |\n+----+-------------+-------+------+---------------+-----------+---------+--------------+------+----------+-----------------------+\n2 rows in set, 2 warnings (0.00 sec)\n\nmysql&gt; show warnings\\G\n*************************** 1. row ***************************\n  Level: Warning\n   Code: 1739\nMessage: Cannot use ref access on index 'idx_uuid1' due to type or \n collation conversion on field 'uuid'\n*************************** 2. row ***************************\n  Level: Note\n   Code: 1003\nMessage: /* select#1 */ \nselect `rep`.`t_1`.`id` AS `id`,`rep`.`t_1`.`uuid` AS `uuid`,\n  `rep`.`t_1`.`padding` AS `padding`,`rep`.`t_2`.`id` AS `id`,\n  `rep`.`t_2`.`uuid` AS `uuid`,`rep`.`t_2`.`padding` AS `padding` \n  from `rep`.`t_1` straight_join `rep`.`t_2` \n  where (`rep`.`t_1`.`uuid` = `rep`.`t_2`.`uuid`)\n</code></pre><p>ä»¥t_2è¡¨ä½œä¸ºé©±åŠ¨è¡¨æ—¶ï¼Œæ— æ³•ä½¿ç”¨t_1è¡¨uuidçš„ç´¢å¼•ï¼Œå› ä¸ºt_1.uuidå‘ç”Ÿäº†ç±»å‹è½¬æ¢ã€‚æ­¤æ—¶ä¼˜åŒ–å™¨ä½¿ç”¨äº†Hashè¿æ¥ã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain select * from t_2 straight_join t_1 on t_1.uuid = t_2.uuid;\n+----+-------------+-------+------+---------------+------+---------+------+------+----------+--------------------------------------------+\n| id | select_type | table | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra                                      |\n+----+-------------+-------+------+---------------+------+---------+------+------+----------+--------------------------------------------+\n|  1 | SIMPLE      | t_2   | ALL  | idx_uuid2     | NULL | NULL    | NULL |    1 |   100.00 | NULL                                       |\n|  1 | SIMPLE      | t_1   | ALL  | idx_uuid1     | NULL | NULL    | NULL |    1 |   100.00 | Using where; Using join buffer (hash join) |\n+----+-------------+-------+------+---------------+------+---------+------+------+----------+--------------------------------------------+\n2 rows in set, 3 warnings (0.00 sec)\n\nmysql&gt; show warnings\\G\n*************************** 1. row ***************************\n  Level: Warning\n   Code: 1739\nMessage: Cannot use ref access on index 'idx_uuid1' due to type or \n  collation conversion on field 'uuid'\n*************************** 2. row ***************************\n  Level: Warning\n   Code: 1739\nMessage: Cannot use range access on index 'idx_uuid1' due to type or \n  collation conversion on field 'uuid'\n*************************** 3. row ***************************\n  Level: Note\n   Code: 1003\nMessage: /* select#1 */ \nselect `rep`.`t_2`.`id` AS `id`,`rep`.`t_2`.`uuid` AS `uuid`,\n  `rep`.`t_2`.`padding` AS `padding`,`rep`.`t_1`.`id` AS `id`,\n  `rep`.`t_1`.`uuid` AS `uuid`,`rep`.`t_1`.`padding` AS `padding` \nfrom `rep`.`t_2` straight_join `rep`.`t_1` \nwhere (`rep`.`t_1`.`uuid` = `rep`.`t_2`.`uuid`)\n</code></pre><h2>æ¡ˆä¾‹å…­ï¼šä¼˜åŒ–oræ¡ä»¶</h2><p>å¾ˆå¤šæƒ…å†µä¸‹ï¼Œä¼˜åŒ–å™¨å¯ä»¥è‡ªåŠ¨é€‰æ‹©ä¸€ä¸ªæœ€ä¼˜çš„æ‰§è¡Œè®¡åˆ’ã€‚ä½†ç”±äºSQLçš„å†™æ³•å¾ˆå¤šï¼Œåœ¨ä¸€äº›åœºæ™¯ä¸‹ï¼Œä¼˜åŒ–å™¨é€‰æ‹©çš„æ‰§è¡Œè®¡åˆ’æ•ˆç‡å¹¶ä¸é«˜ã€‚è¿™æ—¶å°±å¯èƒ½éœ€è¦æ”¹å†™SQLï¼Œå¸®åŠ©ä¼˜åŒ–å™¨æ‰¾åˆ°æ›´å¥½çš„æ‰§è¡Œè®¡åˆ’ã€‚whereå­å¥ä¸­ä¸åŒçš„å­—æ®µä¸Šçš„æ¡ä»¶ä½¿ç”¨orç›¸è¿ï¼Œå°±æ¯”è¾ƒå®¹æ˜“å¼•èµ·æ€§èƒ½é—®é¢˜ã€‚</p><p>ä¸‹é¢è¿™ä¸ªSQLæ¥è‡ªä¸€ä¸ªçœŸå®çš„ä¸šåŠ¡ç³»ç»Ÿã€‚</p><pre><code class=\"language-plain\">SELECT count(1)\nFROM car\nWHERE is_deleted = 0 \nAND (seller_id = 100 \n     OR (creator = 200 AND seller_id = -1))\nAND car_id NOT IN (  \n    SELECT car_id \n    FROM product \n    WHERE product_type = 2 \n    AND source = 2)\n</code></pre><p>å…ˆçœ‹ä¸€ä¸‹æ‰§è¡Œè®¡åˆ’ï¼Œä¸»æŸ¥è¯¢ä¸­ä½¿ç”¨ç´¢å¼•è®¿é—®16ä¸‡è¡Œæ•°æ®ã€‚å­æŸ¥è¯¢è¿™é‡Œåªéœ€è¦æ‰§è¡Œä¸€æ¬¡ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/56/f2/56e105b9b5d29f8d924b3c11847f12f2.png?wh=1908x296\" alt=\"å›¾ç‰‡\"></p><p>ä¸Šé¢çš„SQLä¸­ï¼Œseller_id=100å’Œcreator = 200è¿™ä¸¤ä¸ªæ¡ä»¶çš„è¿‡æ»¤æ€§éƒ½ä¸é”™ï¼Œè€Œä¸”ä¹Ÿéƒ½å»ºäº†ç´¢å¼•ï¼Œä½†æ˜¯è¿™2ä¸ªæ¡ä»¶ä½¿ç”¨äº†ORã€‚ä¼˜åŒ–å™¨æœ€ç»ˆé€‰æ‹©äº†seller_idä¸Šçš„ç´¢å¼•ï¼Œä½†æ˜¯seller_id = -1è¿™ä¸ªæ¡ä»¶çš„è¿‡æ»¤æ€§å¹¶ä¸å¥½ã€‚</p><p>MySQLæ”¯æŒindex_mergeçš„æ‰§è¡Œè®¡åˆ’ï¼Œç†è®ºä¸Šå¯ä»¥ç”¨seller_id=100å’Œcreator=200è¿‡æ»¤æ•°æ®ï¼Œå†æŠŠæ•°æ®åˆå¹¶èµ·æ¥ï¼Œä½†æ˜¯è¿™é‡Œä¼˜åŒ–å™¨å¹¶æ²¡æœ‰é‡‡ç”¨è¿™ä¸ªæ‰§è¡Œè®¡åˆ’ã€‚å› æ­¤æˆ‘ä»¬å°†SQLåšäº†æ”¹å†™ï¼Œå°†SQLæ‹†åˆ†æˆ2ä¸ªéƒ¨åˆ†ï¼Œä½¿ç”¨union allåˆå¹¶æ•°æ®ã€‚</p><pre><code class=\"language-plain\"> SELECT sum(a) FROM (\n    SELECT count(1) as a FROM car WHERE is_deleted = 0 AND car_id NOT IN ( SELECT car_id  FROM product WHERE product_type = 2 AND source = 2)  \nAND (seller_id = 100)    \n    union all     \n    SELECT count(1) as a FROM car WHERE is_deleted = 0 AND car_id NOT IN (SELECT car_id  FROM product WHERE product_type = 2 AND source = 2)\nAND creator = 1000  AND seller_id = -1\n) t\n</code></pre><p>çœ‹ä¸€ä¸‹æ”¹å†™åçš„æ‰§è¡Œè®¡åˆ’ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/07/79/07d000e4fc188da8543f855fbe79e579.png?wh=1920x276\" alt=\"å›¾ç‰‡\"></p><p>æ”¹å†™ä¹‹åï¼Œunion allçš„2ä¸ªSQLç‰‡æ®µä½¿ç”¨äº†ä¸åŒçš„ç´¢å¼•ï¼Œæ‰«æçš„è¡Œæ•°åˆ†åˆ«æ˜¯1238å’Œ7130ï¼Œæ¯”æ”¹å†™ä¹‹å‰æå‡äº†ä¸€ä¸ªæ•°é‡çº§ã€‚è¿™æ ·æ”¹å†™ä¹‹åï¼Œæ‰§è¡Œè®¡åˆ’ä¹Ÿä¼šæ›´ç¨³å®šã€‚</p><h2>æ€»ç»“</h2><p>è¿™ä¸€è®²çš„å…­ä¸ªæ¡ˆä¾‹ï¼Œåœ¨å¹³æ—¶å·¥ä½œä¸­æ¯”è¾ƒå¸¸è§ï¼Œé€šå¸¸ä¹Ÿæ¯”è¾ƒå®¹æ˜“è§£å†³ã€‚é¦–å…ˆè¦ç†è§£ç´¢å¼•çš„é€‰æ‹©æ€§ï¼Œä¸ºæŸ¥è¯¢ä¸­è¿‡æ»¤æ€§é«˜çš„æ¡ä»¶åˆ›å»ºåˆé€‚çš„ç´¢å¼•ã€‚å¯¹äºéšå¼ç±»å‹è½¬æ¢ï¼Œæœ€é‡è¦çš„æ˜¯è¦åœ¨å»ºè¡¨çš„æ—¶å€™å°±é€‰æ‹©ç²¾ç¡®çš„æ•°æ®ç±»å‹ï¼Œé¿å…ä½¿ç”¨varcharæ¥å­˜å‚¨æ•°å­—ç±»çš„ã€æ—¥æœŸæ—¶é—´ç±»çš„æ•°æ®ã€‚å­—ç¬¦é›†ä¹Ÿè¦ä¿æŒä¸€è‡´ã€‚å¦‚æœè¡¨å·²ç»å»ºå¥½ï¼Œç³»ç»Ÿå·²ç»ä¸Šçº¿è¿è¡Œäº†ï¼Œé‚£å°±è¦åœ¨åº”ç”¨ä»£ç é‡Œä½¿ç”¨å’Œå­—æ®µç±»å‹åŒ¹é…çš„æ•°æ®ç±»å‹ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>æœ‰æ—¶å€™æˆ‘ä»¬ä¼šé‡åˆ°æ‰§è¡Œè®¡åˆ’é€‰æ‹©äº†é”™è¯¯çš„ç´¢å¼•ï¼Œå¯¼è‡´SQLæ€§èƒ½æ¯”è¾ƒå·®ã€‚ä¸€ä¸ªå¯èƒ½çš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨force indexå¼ºåˆ¶ç´¢å¼•ã€‚ä½¿ç”¨force indexå¯èƒ½ä¼šå­˜åœ¨å“ªäº›æ½œåœ¨çš„é£é™©ï¼Ÿæœ‰æ²¡æœ‰å…¶ä»–åŠæ³•æ¥é¿å…æ‰§è¡Œè®¡åˆ’é€‰é”™ç´¢å¼•ï¼Ÿ</p><p>æœŸå¾…ä½ çš„æ€è€ƒï¼Œæ¬¢è¿åœ¨ç•™è¨€åŒºä¸­ä¸æˆ‘äº¤æµã€‚å¦‚æœä»Šå¤©çš„è¯¾ç¨‹è®©ä½ æœ‰æ‰€æ”¶è·ï¼Œä¹Ÿæ¬¢è¿è½¬å‘ç»™æœ‰éœ€è¦çš„æœ‹å‹ã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼</p>","comments":[{"had_liked":false,"id":394938,"user_name":"é™ˆæ˜Ÿå®‡(2.11)","can_delete":false,"product_type":"c1","uid":1450562,"ip_address":"å››å·","ucode":"970E48260B7924","user_header":"https://static001.geekbang.org/account/avatar/00/16/22/42/11674804.jpg","comment_is_top":false,"comment_ctime":1728876408,"is_pvip":false,"replies":[{"id":143400,"content":"è¿™åº”è¯¥æ˜¯å¾ˆå¤šä¸šåŠ¡éƒ½ä¼šé‡åˆ°çš„é—®é¢˜ã€‚ä¸€èˆ¬è¦ç»“åˆä¸šåŠ¡å®é™…éœ€æ±‚ã€æŸ¥è¯¢å­—æ®µçš„è¿‡æ»¤æ€§ã€æ¯ä¸ªåœºæ™¯çš„æ‰§è¡Œé¢‘ç‡æ¥ç»¼åˆè€ƒè™‘ã€‚\n\nç»™æ‰§è¡Œé¢‘ç‡é«˜ã€è¿‡æ»¤æ€§é«˜çš„å­—æ®µæˆ–å­—æ®µç»„åˆå»ºç«‹ç´¢å¼•ã€‚\nä¹Ÿå¯ä»¥å‚è€ƒä¸‹20è®²ä¸­â€œè®¢å•åˆ—è¡¨â€è¿™ä¸ªåœºæ™¯çš„ç»„åˆç´¢å¼•è®¾è®¡ã€‚\n\nå¦‚æœä¸šåŠ¡çš„æŸ¥è¯¢åœºæ™¯æœ‰è¿™ä¹ˆå‡ ç§ï¼Œé¢‘ç‡éƒ½ä¸ä½ï¼Œcolumn_1ã€column_2éƒ½æœ‰ä¸€å®šçš„è¿‡æ»¤æ€§ã€‚\nselect * from tab where column_1 = ?\nselect * from tab where column_2 = ?\nselect * from tab where column_1 = ? and column_2 = ?\n\næˆ‘å¯èƒ½ä¼šå»º2ä¸ªç´¢å¼•ï¼š\nidx_c1c2(column_1, column_2)\nidx_c2(column_2)\n","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3898827,"ctime":1728888666,"ip_address":"æµ™æ±Ÿ","comment_id":394938,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100799401,"comment_content":"è€å¸ˆï¼Œè¯·æ•™ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ä¸šåŠ¡ä¸Šä¼šæœ‰å¾ˆå¤šæŸ¥è¯¢æ˜¯å¯ä»¥1ä¸ªæ¡ä»¶æˆ–è€…å¤šä¸ªæ¡ä»¶ï¼Œæ¯”å¦‚æ—¶é—´èŒƒå›´ï¼ŒçŠ¶æ€ï¼Œäººå‘˜åç§°ã€‚æ­£å¸¸å»ºä¸€ä¸ªè¿™3ä¸ªå­—æ®µçš„è”åˆç´¢å¼•å°±è¡Œï¼Œä½†æ˜¯æœ‰å¯èƒ½è¦†ç›–ä¸åˆ°å•ç‹¬ä½¿ç”¨ä¸€ä¸ªæ¡ä»¶çš„æŸ¥è¯¢ï¼Œè¿™ç§æˆ‘ä»¬ç°åœ¨éƒ½æ˜¯å•ç‹¬åœ¨æ¯ä¸ªå­—æ®µä¸Šå†å»ºç´¢å¼•ï¼Œå¯¼è‡´ç©ºé—´æµªè´¹ã€‚è¿™ç§æœ‰ä»€ä¹ˆå¥½çš„å»ºè®®å—ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":3898827,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/7d/cb/fa3dae58.jpg","nickname":"ä¿Šè¾¾","note":"","ucode":"F79BF9651AD086","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":652411,"discussion_content":"è¿™åº”è¯¥æ˜¯å¾ˆå¤šä¸šåŠ¡éƒ½ä¼šé‡åˆ°çš„é—®é¢˜ã€‚ä¸€èˆ¬è¦ç»“åˆä¸šåŠ¡å®é™…éœ€æ±‚ã€æŸ¥è¯¢å­—æ®µçš„è¿‡æ»¤æ€§ã€æ¯ä¸ªåœºæ™¯çš„æ‰§è¡Œé¢‘ç‡æ¥ç»¼åˆè€ƒè™‘ã€‚\n\nç»™æ‰§è¡Œé¢‘ç‡é«˜ã€è¿‡æ»¤æ€§é«˜çš„å­—æ®µæˆ–å­—æ®µç»„åˆå»ºç«‹ç´¢å¼•ã€‚\nä¹Ÿå¯ä»¥å‚è€ƒä¸‹20è®²ä¸­â€œè®¢å•åˆ—è¡¨â€è¿™ä¸ªåœºæ™¯çš„ç»„åˆç´¢å¼•è®¾è®¡ã€‚\n\nå¦‚æœä¸šåŠ¡çš„æŸ¥è¯¢åœºæ™¯æœ‰è¿™ä¹ˆå‡ ç§ï¼Œé¢‘ç‡éƒ½ä¸ä½ï¼Œcolumn_1ã€column_2éƒ½æœ‰ä¸€å®šçš„è¿‡æ»¤æ€§ã€‚\nselect * from tab where column_1 = ?\nselect * from tab where column_2 = ?\nselect * from tab where column_1 = ? and column_2 = ?\n\næˆ‘å¯èƒ½ä¼šå»º2ä¸ªç´¢å¼•ï¼š\nidx_c1c2(column_1, column_2)\nidx_c2(column_2)\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1728888666,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1450562,"avatar":"https://static001.geekbang.org/account/avatar/00/16/22/42/11674804.jpg","nickname":"é™ˆæ˜Ÿå®‡(2.11)","note":"","ucode":"970E48260B7924","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":652450,"discussion_content":"æ‰€ä»¥è¦åˆ é™¤é‡å¤ç´¢å¼•çš„é‡Šæ”¾ç©ºé—´çš„è¯ï¼Œå¦‚æœå­˜åœ¨indexa(a)å’Œindexab(a,b)ï¼Œindexb(bb,é‚£å…¶å®ä¸Šindexaå°±æ˜¯å¯ä»¥åˆ æ‰çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1728961885,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å››å·","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":394934,"user_name":"ç¾å¦™çš„ä»£ç ","can_delete":false,"product_type":"c1","uid":1111985,"ip_address":"å››å·","ucode":"9DADD72C193296","user_header":"https://static001.geekbang.org/account/avatar/00/10/f7/b1/982ea185.jpg","comment_is_top":false,"comment_ctime":1728868673,"is_pvip":true,"replies":[{"id":143398,"content":"è¿™ä¸ªé—®é¢˜æˆ‘æ˜¯è¿™ä¹ˆç†è§£çš„ã€‚\n\n1. æœ‰çš„æ—¶å€™ä¸šåŠ¡ä¸Šä½¿ç”¨åŠ¨æ€SQLï¼ˆæ¯”å¦‚mybatisï¼‰ï¼Œæ ¹æ®ä»£ç ä¸­ä¼ å…¥çš„å‚æ•°æ¥æ‹¼æ¥SQLã€‚åŠ äº†force indexåï¼Œå¯èƒ½ä¼šå¯¼è‡´æŸäº›æ¡ä»¶ç»„åˆä¸‹ä½¿ç”¨äº†ä¸åˆé€‚çš„ç´¢å¼•ï¼Œæˆ–æ— æ³•ä½¿ç”¨ç´¢å¼•ã€‚\n\n2. åŠ äº†force indexåï¼Œå¦‚æœæŠŠç´¢å¼•åˆ é™¤äº†ï¼Œæˆ–è€…æ”¹äº†ç´¢å¼•åç§°ï¼Œä¼šå¯¼è‡´SQLæŠ¥é”™ã€‚\n\nèµ°é”™ç´¢å¼•ï¼Œæœ‰çš„æ—¶å€™æ˜¯å› ä¸ºè¡¨ä¸Šå­˜åœ¨ç›¸ä¼¼çš„ç´¢å¼•ï¼Œæ¯”å¦‚è¡¨ä¸Šå­˜åœ¨å¤šä¸ªå‰ç¼€ä¸€æ ·çš„ç´¢å¼•ã€‚ä¸ºäº†é¿å…èµ°é”™ç´¢å¼•ï¼Œé¦–å…ˆè¦å°½é‡é¿å…ç›¸ä¼¼çš„ç´¢å¼•ã€‚\n\nå¦‚æœæŸä¸ªç‰¹å®šçš„åœºæ™¯ä¸‹ä¼˜åŒ–å™¨çœŸçš„é€‰ä¸åˆ°æœ€ä¼˜çš„ç´¢å¼•å’Œæ‰§è¡Œè®¡åˆ’ï¼Œå°±åªç»™è¿™ä¸ªç‰¹å®šåœºæ™¯çš„SQLåŠ force indexæç¤ºã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3898827,"ctime":1728885556,"ip_address":"æµ™æ±Ÿ","comment_id":394934,"utype":1}],"discussion_count":1,"race_medal":1,"score":2,"product_id":100799401,"comment_content":"è€å¸ˆï¼Œèƒ½è®²ä¸‹æ–‡ç« ç»“å°¾çš„é—®é¢˜ç­”æ¡ˆå—ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":3898827,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/7d/cb/fa3dae58.jpg","nickname":"ä¿Šè¾¾","note":"","ucode":"F79BF9651AD086","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":652409,"discussion_content":"è¿™ä¸ªé—®é¢˜æˆ‘æ˜¯è¿™ä¹ˆç†è§£çš„ã€‚\n\n1. æœ‰çš„æ—¶å€™ä¸šåŠ¡ä¸Šä½¿ç”¨åŠ¨æ€SQLï¼ˆæ¯”å¦‚mybatisï¼‰ï¼Œæ ¹æ®ä»£ç ä¸­ä¼ å…¥çš„å‚æ•°æ¥æ‹¼æ¥SQLã€‚åŠ äº†force indexåï¼Œå¯èƒ½ä¼šå¯¼è‡´æŸäº›æ¡ä»¶ç»„åˆä¸‹ä½¿ç”¨äº†ä¸åˆé€‚çš„ç´¢å¼•ï¼Œæˆ–æ— æ³•ä½¿ç”¨ç´¢å¼•ã€‚\n\n2. åŠ äº†force indexåï¼Œå¦‚æœæŠŠç´¢å¼•åˆ é™¤äº†ï¼Œæˆ–è€…æ”¹äº†ç´¢å¼•åç§°ï¼Œä¼šå¯¼è‡´SQLæŠ¥é”™ã€‚\n\nèµ°é”™ç´¢å¼•ï¼Œæœ‰çš„æ—¶å€™æ˜¯å› ä¸ºè¡¨ä¸Šå­˜åœ¨ç›¸ä¼¼çš„ç´¢å¼•ï¼Œæ¯”å¦‚è¡¨ä¸Šå­˜åœ¨å¤šä¸ªå‰ç¼€ä¸€æ ·çš„ç´¢å¼•ã€‚ä¸ºäº†é¿å…èµ°é”™ç´¢å¼•ï¼Œé¦–å…ˆè¦å°½é‡é¿å…ç›¸ä¼¼çš„ç´¢å¼•ã€‚\n\nå¦‚æœæŸä¸ªç‰¹å®šçš„åœºæ™¯ä¸‹ä¼˜åŒ–å™¨çœŸçš„é€‰ä¸åˆ°æœ€ä¼˜çš„ç´¢å¼•å’Œæ‰§è¡Œè®¡åˆ’ï¼Œå°±åªç»™è¿™ä¸ªç‰¹å®šåœºæ™¯çš„SQLåŠ force indexæç¤ºã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1728885556,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":394942,"user_name":"Geek_c37964","can_delete":false,"product_type":"c1","uid":3149658,"ip_address":"æ¹–åŒ—","ucode":"34AD65C5890958","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaELGRkoQwpl2jT3Zd1O7ibqYLRzeqo7OxRbRSRVYlJOTvz7KCDS0OqKlm2kibxPQtVzXJeZeRXT0JpgzJEWuYozsV6ziaZ62oIxJrIn5KhHSiaSZKg/132","comment_is_top":false,"comment_ctime":1728877840,"is_pvip":false,"replies":[{"id":143402,"content":"è¿™ä¸¤ç‚¹éƒ½æ˜¯æœ‰é“ç†çš„ã€‚ä¸€èˆ¬æˆ‘ä»¬éƒ½æ˜¯å°½é‡è®©ä¼˜åŒ–å™¨è‡ªå·±æ¥é€‰æ‹©æ‰§è¡Œè®¡åˆ’ã€‚\n\né€‰é”™ç´¢å¼•ï¼Œè¿˜è·ŸSQLçš„å†™æ³•å’Œæ•°æ®åˆ†å¸ƒæœ‰å…³ç³»ã€‚å¦‚æœSQLä¸­ç”¨äº†Order byå’ŒLimitï¼Œå¹¶ä¸”ç´¢å¼•è¿‡æ»¤æ€§æ¯”è¾ƒä½ï¼Œç›¸å¯¹æ¥è¯´ï¼Œé€‰é”™ç´¢å¼•çš„æ¦‚ç‡ä¼šæ›´å¤§ä¸€äº›ã€‚\n","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3898827,"ctime":1728890098,"ip_address":"æµ™æ±Ÿ","comment_id":394942,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100799401,"comment_content":"mysqlæ–°äººï¼ŒçŒœä¸€ä¸‹æ€è€ƒé¢˜çš„ç­”æ¡ˆ:)\nforce index è™½ç„¶æš‚æ—¶å¯ä»¥è®©ä¼˜åŒ–å™¨é€‰æ‹©æ­£ç¡®çš„ç´¢å¼•ï¼Œä½†æ˜¯å½“æ•°æ®çš„åˆ†å¸ƒç­‰å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå¯èƒ½å½“å‰çš„ç´¢å¼•å°±ä¸æ˜¯æœ€ä¼˜çš„äº†ï¼Œè€Œè¿™ä¹Ÿé˜»æ­¢äº†ä¼˜åŒ–å™¨è‡ªåŠ¨é€‰æ‹©åˆé€‚çš„ç´¢å¼•ã€‚\nä¼˜åŒ–å™¨é€‰é”™ç´¢å¼•çš„æƒ…å†µä¸€èˆ¬æ˜¯ç»Ÿè®¡ä¿¡æ¯ä¸å‡†ç¡®å¯¼è‡´çš„ï¼Œæ‰€ä»¥æ‰§è¡Œè¯­å¥å‰å¯ä»¥analyseä¸€ä¸‹åˆ·æ–°ç»Ÿè®¡ä¿¡æ¯ï¼Œä»è€Œè®©ä¼˜åŒ–å™¨é€‰æ‹©åˆé€‚çš„ç´¢å¼•ã€‚\nä¸çŸ¥é“æ€è€ƒçš„æ­£ä¸æ­£ç¡®ï¼Œè¿˜è¯·è€å¸ˆè§£ç­”ï¼","like_count":0,"discussions":[{"author":{"id":3898827,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/7d/cb/fa3dae58.jpg","nickname":"ä¿Šè¾¾","note":"","ucode":"F79BF9651AD086","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":652416,"discussion_content":"è¿™ä¸¤ç‚¹éƒ½æ˜¯æœ‰é“ç†çš„ã€‚ä¸€èˆ¬æˆ‘ä»¬éƒ½æ˜¯å°½é‡è®©ä¼˜åŒ–å™¨è‡ªå·±æ¥é€‰æ‹©æ‰§è¡Œè®¡åˆ’ã€‚\n\né€‰é”™ç´¢å¼•ï¼Œè¿˜è·ŸSQLçš„å†™æ³•å’Œæ•°æ®åˆ†å¸ƒæœ‰å…³ç³»ã€‚å¦‚æœSQLä¸­ç”¨äº†Order byå’ŒLimitï¼Œå¹¶ä¸”ç´¢å¼•è¿‡æ»¤æ€§æ¯”è¾ƒä½ï¼Œç›¸å¯¹æ¥è¯´ï¼Œé€‰é”™ç´¢å¼•çš„æ¦‚ç‡ä¼šæ›´å¤§ä¸€äº›ã€‚\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1728890098,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":394941,"user_name":"å¶æ˜","can_delete":false,"product_type":"c1","uid":1412429,"ip_address":"æ±Ÿè‹","ucode":"D0B4B7660DA766","user_header":"https://static001.geekbang.org/account/avatar/00/15/8d/4d/992070e8.jpg","comment_is_top":false,"comment_ctime":1728877640,"is_pvip":false,"replies":[{"id":143401,"content":"è¿™é‡Œæä¾›çš„å‡ ä¸ªæ–¹æ³•éƒ½éå¸¸å¥½ã€‚ğŸ‘ğŸ‘\n\nquery rewriteå’Œdbms_outln.add_index_outlineéƒ½æ˜¯å¾ˆå€¼å¾—å»å°è¯•çš„æŠ€æœ¯ã€‚\næ¯•ç«Ÿçº¿ä¸Šçš„é—®é¢˜ï¼Œæ”¹ä»£ç å†å‘å¸ƒï¼Œå¯èƒ½è¦èŠ±æ¯”è¾ƒé•¿çš„æ—¶é—´ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3898827,"ctime":1728889733,"ip_address":"æµ™æ±Ÿ","comment_id":394941,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100799401,"comment_content":"ä½¿ç”¨ force index å¯èƒ½ä¼šå­˜åœ¨å“ªäº›æ½œåœ¨çš„é£é™©ï¼Ÿ\né£é™©1ï¼Œç´¢å¼•é€‰æ‹©é”™è¯¯ï¼Œforce index é€‚åˆ SQL ä¸­å¿…å¸¦æŸäº›æŸ¥è¯¢å­—æ®µï¼Œç„¶è€Œç°å®ä¸­çš„ SQL å¹¶ä¸æ€»æ˜¯è¿™æ ·ï¼Œå¦‚æœå¼ºåˆ¶èµ°æŸä¸ªç´¢å¼•ï¼Œè€Œç´¢å¼•å‰ç¼€å­—æ®µæ°å¥½åœ¨æŸ¥è¯¢æ¡ä»¶ä¸­ä¸å­˜åœ¨ï¼Œè¿™ä¼šå¯¼è‡´ä½¿ç”¨å…¨ç´¢å¼•æ‰«æï¼Œæ¯”å…¨è¡¨æ‰«æè¿˜ç³Ÿç³•ã€‚\nmysql&gt; show create table t_jointab\\G\n*************************** 1. row ***************************\n       Table: t_jointab\nCreate Table: CREATE TABLE `t_jointab` (\n  `id` int NOT NULL AUTO_INCREMENT,\n  `a` int NOT NULL,\n  `b` int NOT NULL,\n  `c` varchar(4000) DEFAULT NULL,\n  PRIMARY KEY (`id`),\n  KEY `idx_a` (`a`,`b`),\n  KEY `idx_b` (`b`)\n) ENGINE=InnoDB AUTO_INCREMENT=16384 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci\n1 row in set (0.00 sec)\n\nmysql&gt; explain select id, a, b from t_jointab force index(idx_a) where b = 5;\n+----+-------------+-----------+------------+-------+---------------+-------+---------+------+------+----------+--------------------------+\n| id | select_type | table     | partitions | type  | possible_keys | key   | key_len | ref  | rows | filtered | Extra                    |\n+----+-------------+-----------+------------+-------+---------------+-------+---------+------+------+----------+--------------------------+\n|  1 | SIMPLE      | t_jointab | NULL       | index | idx_a         | idx_a | 8       | NULL | 8574 |     0.10 | Using where; Using index |\n\né£é™©2ï¼Œéœ€è¦ä¿®æ”¹åº”ç”¨ä»£ç ï¼Œæœ‰æ—¶é—´å·®ï¼Œæ•°æ®åº“çš„ CPU å¯èƒ½å·²ç»å‘Šè­¦ä¸€æ®µæ—¶é—´ï¼Œåº”ç”¨ä¸å¯ç”¨äº†ã€‚\n\næœ‰æ²¡æœ‰å…¶ä»–åŠæ³•æ¥é¿å…æ‰§è¡Œè®¡åˆ’é€‰é”™ç´¢å¼•ï¼Ÿ\næ–¹æ³•1ï¼Œforce index é‡Œå¤šæ”¾å‡ ä¸ªå¤‡é€‰ç´¢å¼•ï¼Œè®©ä¼˜åŒ–å™¨åœ¨è¿™å‡ ä¸ªæ¨èçš„ç´¢å¼•ä¸­é€‰æ‹©æ‰§è¡Œä»£ä»·æœ€å°çš„ï¼Œä¸è¿‡ DBA ç»´æŠ¤èµ·æ¥ä¸æ–¹ä¾¿ï¼Œæ¯•ç«Ÿåœ¨åº”ç”¨å±‚äº†ã€‚\næ–¹æ³•2ï¼Œignore index ä¹Ÿç»å¸¸ç”¨ï¼Œåœ¨ order by col_sort limit N åœºæ™¯ä¸­ï¼Œç»å¸¸é”™è¯¯é€‰æ‹© col_sort åˆ—æ¥æ’åºï¼Œè€Œä¸èµ°æŸ¥è¯¢æ¡ä»¶ä¸­åˆ—ä¸Šçš„ç´¢å¼•ã€‚ç”¨ ignore index æ¥å¿½ç•¥æ‰ col_sort ä¸Šçš„ç´¢å¼•\næ–¹æ³•3ï¼Œmysql æ’ä»¶ query rewrite æ’ä»¶ï¼Œè¿™ä¸ªé¿å…ä¸äº†æ‰§è¡Œè®¡åˆ’é€‰é”™ç´¢å¼•ï¼Œä½†èƒ½ç¼©çŸ­ä¸å¯ç”¨æ—¶é—´ï¼Œé˜¿é‡Œäº‘ä¹Ÿæœ‰å›ºå®šæ‰§è¡Œè®¡åˆ’çš„æ•°æ®åº“å±‚é¢çš„å·¥å…·ï¼šdbms_outln.add_index_outline","like_count":0,"discussions":[{"author":{"id":3898827,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/7d/cb/fa3dae58.jpg","nickname":"ä¿Šè¾¾","note":"","ucode":"F79BF9651AD086","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":652415,"discussion_content":"è¿™é‡Œæä¾›çš„å‡ ä¸ªæ–¹æ³•éƒ½éå¸¸å¥½ã€‚ğŸ‘ğŸ‘\n\nquery rewriteå’Œdbms_outln.add_index_outlineéƒ½æ˜¯å¾ˆå€¼å¾—å»å°è¯•çš„æŠ€æœ¯ã€‚\næ¯•ç«Ÿçº¿ä¸Šçš„é—®é¢˜ï¼Œæ”¹ä»£ç å†å‘å¸ƒï¼Œå¯èƒ½è¦èŠ±æ¯”è¾ƒé•¿çš„æ—¶é—´ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1728889733,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":394937,"user_name":"é™ˆæ˜Ÿå®‡(2.11)","can_delete":false,"product_type":"c1","uid":1450562,"ip_address":"å››å·","ucode":"970E48260B7924","user_header":"https://static001.geekbang.org/account/avatar/00/16/22/42/11674804.jpg","comment_is_top":false,"comment_ctime":1728876174,"is_pvip":false,"replies":[{"id":143397,"content":"å®é™…ä¸Šï¼Œå¦‚æœforce indexä¸­çš„ç´¢å¼•è¢«åˆ é™¤æˆ–æ”¹åäº†ï¼ŒSQLä¼šæŠ¥é”™ã€‚\n\nmysql&gt; select * from tab force index(idx_aa);\nERROR 1176 (42000): Key &#39;idx_aa&#39; doesn&#39;t exist in table &#39;tab&#39;","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3898827,"ctime":1728884813,"ip_address":"æµ™æ±Ÿ","comment_id":394937,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100799401,"comment_content":"ç”¨force indexä¼šå­˜åœ¨å¦‚æœç´¢å¼•åç§°å˜äº†ï¼Œä¼šå¯¼è‡´sqlæ€§èƒ½å‘ç”Ÿå˜åŒ–ã€‚","like_count":0,"discussions":[{"author":{"id":3898827,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/7d/cb/fa3dae58.jpg","nickname":"ä¿Šè¾¾","note":"","ucode":"F79BF9651AD086","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":652407,"discussion_content":"å®é™…ä¸Šï¼Œå¦‚æœforce indexä¸­çš„ç´¢å¼•è¢«åˆ é™¤æˆ–æ”¹åäº†ï¼ŒSQLä¼šæŠ¥é”™ã€‚\n\nmysql&gt; select * from tab force index(idx_aa);\nERROR 1176 (42000): Key &#39;idx_aa&#39; doesn&#39;t exist in table &#39;tab&#39;","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1728884814,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]}]}