{"id":108662,"title":"25 | ç­”ç–‘ï¼ˆäºŒï¼‰ï¼šç‰¹æƒè¿›ç¨‹çš„æƒé™åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯æ¸©é“­ã€‚</p><p>ä¸“æ æ›´æ–°åˆ°ç°åœ¨ï¼ŒOpenRestyç¬¬äºŒç‰ˆå— OpenResty API ç¯‡ï¼Œæˆ‘ä»¬å°±å·²ç»å­¦å®Œäº†ã€‚æ­å–œä½ æ²¡æœ‰æ‰é˜Ÿï¼Œä»ç„¶åœ¨ç§¯æå­¦ä¹ å’Œå®è·µæ“ä½œï¼Œå¹¶ä¸”çƒ­æƒ…åœ°ç•™ä¸‹äº†ä½ çš„æ€è€ƒã€‚</p><p>å¾ˆå¤šç•™è¨€æå‡ºçš„é—®é¢˜å¾ˆæœ‰ä»·å€¼ï¼Œå¤§éƒ¨åˆ†æˆ‘éƒ½å·²ç»åœ¨Appé‡Œå›å¤è¿‡ï¼Œä¸€äº›æ‰‹æœºä¸Šä¸æ–¹ä¾¿å›å¤çš„æˆ–è€…æ¯”è¾ƒå…¸å‹ã€æœ‰è¶£çš„é—®é¢˜ï¼Œæˆ‘ä¸“é—¨æ‘˜äº†å‡ºæ¥ï¼Œä½œä¸ºä»Šå¤©çš„ç­”ç–‘å†…å®¹ï¼Œé›†ä¸­å›å¤ã€‚å¦ä¸€æ–¹é¢ï¼Œä¹Ÿæ˜¯ä¸ºäº†ä¿è¯æ‰€æœ‰äººéƒ½ä¸æ¼æ‰ä»»ä½•ä¸€ä¸ªé‡ç‚¹ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä»Šå¤©çš„è¿™ 6 ä¸ªé—®é¢˜ã€‚</p><h2>ç¬¬ä¸€é—®ï¼Œç‰¹æƒè¿›ç¨‹çš„æƒé™</h2><p>Qï¼šæˆ‘æƒ³è¯·é—®ä¸‹ï¼Œç‰¹æƒè¿›ç¨‹æ˜¯æ€ä¹ˆå›äº‹ï¼Œå¦‚æœå¯åŠ¨ OpenResty çš„æœ¬èº«å°±æ˜¯æ™®é€šç”¨æˆ·ï¼Œå¦‚ä½•è·å–rootæƒé™å‘¢ï¼Ÿå¦å¤–ï¼Œè€å¸ˆå¯ä»¥ä»‹ç»ä¸‹ï¼Œç‰¹æƒè¿›ç¨‹çš„ä½¿ç”¨åœºæ™¯æœ‰å“ªäº›å—ï¼Ÿ</p><p>Aï¼šå…¶å®ï¼Œç‰¹æƒè¿›ç¨‹çš„æƒé™å’Œ master è¿›ç¨‹çš„æƒé™ä¿æŒä¸€æ ·ã€‚å¦‚æœä½ ç”¨æ™®é€šç”¨æˆ·èº«ä»½å¯åŠ¨ OpenRestyï¼Œé‚£ä¹ˆ master å°±æ˜¯æ™®é€šç”¨æˆ·çš„æƒé™ï¼Œè¿™æ—¶å€™ç‰¹æƒè¿›ç¨‹ä¹Ÿå°±æ²¡æœ‰ä»€ä¹ˆç‰¹æƒäº†ã€‚</p><p>è¿™ä¸€ç‚¹åº”è¯¥è¿˜æ˜¯å¾ˆå¥½ç†è§£çš„ï¼Œæ™®é€šç”¨æˆ·å¯åŠ¨çš„è¿›ç¨‹ï¼Œæ— è®ºå¦‚ä½•ä¹Ÿä¸ä¼šæœ‰ root æƒé™ã€‚</p><p>è‡³äºç‰¹æƒè¿›ç¨‹çš„ä½¿ç”¨åœºæ™¯ï¼Œæˆ‘ä»¬ä¸€èˆ¬ç”¨ç‰¹æƒè¿›ç¨‹æ¥å¤„ç†çš„æ˜¯æ¸…ç†æ—¥å¿—ã€é‡å¯ OpenResty è‡ªèº«ç­‰éœ€è¦é«˜æƒé™çš„ä»»åŠ¡ã€‚ä½ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸è¦æŠŠ worker è¿›ç¨‹çš„ä»»åŠ¡äº¤ç»™ç‰¹æƒè¿›ç¨‹æ¥å¤„ç†ã€‚è¿™å¹¶éå› ä¸ºç‰¹æƒè¿›ç¨‹ä¸èƒ½åšåˆ°ï¼Œè€Œæ˜¯å…¶å­˜åœ¨å®‰å…¨éšæ‚£ã€‚</p><!-- [[[read_end]]] --><p>æˆ‘è§åˆ°è¿‡ä¸€ä¸ªå¼€å‘è€…ï¼Œä»–æŠŠå®šæ—¶å™¨çš„ä»»åŠ¡éƒ½äº¤ç»™äº†ç‰¹æƒè¿›ç¨‹æ¥å¤„ç†ã€‚ä»–ä¸ºä»€ä¹ˆè¿™ä¹ˆåšå‘¢ï¼Ÿå› ä¸ºç‰¹æƒè¿›ç¨‹åªæœ‰ä¸€ä¸ªï¼Œè¿™æ · timer å°±ä¸ä¼šé‡å¤å¯åŠ¨ã€‚</p><p>æ˜¯ä¸æ˜¯è§‰å¾—è¿™çœ‹ä¸Šå»å¾ˆèªæ˜å‘€ï¼Œä¸ç”¨ worker.id è¿™ç§ç¬¨æ–¹æ³•å°±åšåˆ°äº†ã€‚ä½†æ˜¯ï¼Œåˆ«å¿˜äº†ï¼Œå¦‚æœå®šæ—¶å™¨çš„ä»»åŠ¡å’Œç”¨æˆ·çš„è¾“å…¥æœ‰å…³ï¼Œè¿™ä¸å°±ç­‰äºç•™äº†ä¸€ä¸ªåé—¨å—ï¼Ÿæ˜¾ç„¶æ˜¯éå¸¸å±é™©çš„ã€‚</p><h2>ç¬¬äºŒé—®ï¼Œé˜¶æ®µå’Œè°ƒè¯•</h2><p>Qï¼šè€å¸ˆï¼Œæ˜¯ä¸æ˜¯æ— è®ºåœ¨å“ªä¸ªé˜¶æ®µè¿è¡Œ<code>ngx.say('hello')</code>ï¼ŒOpenRestyéƒ½ä¼šåœ¨æ‰§è¡Œå®Œæœ¬é˜¶æ®µçš„å‰©ä½™ä»£ç åï¼Œç›´æ¥å“åº”ç»™å®¢æˆ·ç«¯ï¼Œè€Œä¸ä¼šç»§ç»­æ‰§è¡Œå…¶ä»–é˜¶æ®µäº†å‘¢ï¼Ÿæˆ‘æµ‹è¯•å‡ºæ¥æ˜¯è¿™æ ·çš„ã€‚</p><p>Aï¼šäº‹å®ä¸Šå¹¶éå¦‚æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æ¥çœ‹ä¸‹å®ƒçš„æ‰§è¡Œé˜¶æ®µçš„<a href=\"https://github.com/moonbingbing/openresty-best-practices/blob/master/images/openresty_phases.png\">é¡ºåºå›¾</a>ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/71/bf/71b24c95f042f0bf79ac34211e2dd0bf.png?wh=1005*910\" alt=\"\"></p><p>ä½ å¯ä»¥åšä¸ªæµ‹è¯•ï¼Œå…ˆåœ¨ content é‡Œé¢ <code>ngx.say</code>ï¼›ç„¶åï¼Œåœ¨ log æˆ–è€… body filter é˜¶æ®µä½¿ç”¨ <code>ngx.log</code> æ¥æ‰“å°ä¸‹æ—¥å¿—è¯•è¯•ã€‚</p><p>åœ¨ä¸“æ ä¸­ï¼Œæˆ‘å¹¶æ²¡æœ‰ä¸“é—¨æåˆ°åœ¨ OpenResty ä¸­åšä»£ç è°ƒè¯•çš„é—®é¢˜ï¼Œè¿™ä¹Ÿæ˜¯å¼€å‘è€…ç»å¸¸å›°æƒ‘çš„åœ°æ–¹ï¼Œæˆ‘æ­£å¥½é¡ºç€è¿™ä¸ªé—®é¢˜åœ¨ç­”ç–‘ä¸­èŠä¸€ä¸‹ã€‚</p><p>å…¶å®ï¼ŒOpenResty ä¸­çš„ä»£ç è°ƒè¯•ï¼Œå¹¶æ²¡æœ‰æ–­ç‚¹è¿™äº›é«˜çº§åŠŸèƒ½ï¼ˆç›¸åº”æœ‰ä¸€äº›ä»˜è´¹çš„æ’ä»¶ï¼Œä½†æˆ‘å¹¶æ²¡æœ‰ä½¿ç”¨è¿‡ï¼‰ï¼Œåªèƒ½ç”¨  <code>ngx.say</code> å’Œ<code>ngx.log</code> æ¥çœ‹è¾“å‡ºã€‚æˆ‘çŸ¥é“çš„å¼€å‘è€…ï¼ŒåŒ…æ‹¬ OpenResty çš„ä½œè€…å’Œè´¡çŒ®è€…ä»¬ï¼Œéƒ½æ˜¯è¿™æ ·æ¥åš debug çš„ã€‚æ‰€ä»¥ï¼Œä½ éœ€è¦æœ‰å¼ºæœ‰åŠ›çš„æµ‹è¯•æ¡ˆä¾‹å’Œè°ƒè¯•æ—¥å¿—æ¥ä½œä¸ºä¿è¯ã€‚</p><h2>ç¬¬ä¸‰é—®ï¼Œngx.exit å’ŒåŠ¨æ‰‹å®éªŒ</h2><p>Qï¼šè€å¸ˆï¼Œæ–‡ä¸­çš„è¿™å¥è¯ï¼Œâ€œOpenResty çš„ HTTP çŠ¶æ€ç ä¸­ï¼Œæœ‰ä¸€ä¸ªç‰¹åˆ«çš„å¸¸é‡ï¼š<code>ngx.OK</code>ã€‚å½“ <code>ngx.exit(ngx.OK)</code> æ—¶ï¼Œè¯·æ±‚ä¼šé€€å‡ºå½“å‰å¤„ç†é˜¶æ®µï¼Œè¿›å…¥ä¸‹ä¸€ä¸ªé˜¶æ®µï¼Œè€Œä¸æ˜¯ç›´æ¥è¿”å›ç»™å®¢æˆ·ç«¯ã€‚â€</p><p>æˆ‘è®°å¾—ï¼Œ<code>ngx.OK</code>åº”è¯¥ä¸èƒ½ç®—æ˜¯HTTPçŠ¶æ€ç ï¼Œå®ƒå¯¹åº”çš„å€¼æ˜¯0ã€‚æˆ‘çš„ç†è§£æ˜¯ï¼š</p><ul>\n<li><code>ngx.exit(ngx.OK)</code>ã€<code>ngx.exit(ngx.ERROR)</code>å’Œ<code>ngx.exit(ngx.DECLINED)</code>æ—¶ï¼Œè¯·æ±‚ä¼šé€€å‡ºå½“å‰å¤„ç†é˜¶æ®µï¼Œè¿›å…¥ä¸‹ä¸€ä¸ªé˜¶æ®µï¼›</li>\n<li>è€Œå½“<code>ngx.exit(ngx.HTTP_*)</code>ä»¥<code>ngx.HTTP_*</code>çš„å„ç§HTTPçŠ¶æ€ç ä½œä¸ºå‚æ•°æ—¶ï¼Œä¼šç›´æ¥å“åº”ç»™å®¢æˆ·ç«¯ã€‚</li>\n</ul><p>ä¸çŸ¥é“è¿™æ ·æƒ³å¯¹ä¸å¯¹å‘¢ï¼Ÿ</p><p>Aï¼šå…³äºä½ çš„ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œ<code>ngx.ok</code> ç¡®å®ä¸æ˜¯httpçŠ¶æ€ç ï¼Œå®ƒæ˜¯ OpenResty ä¸­çš„ä¸€ä¸ªå¸¸é‡ï¼Œå€¼æ˜¯0ã€‚</p><p>è‡³äºç¬¬äºŒä¸ªé—®é¢˜ï¼Œ<code>ngx.exit</code> çš„å®˜æ–¹æ–‡æ¡£å…¶å®æ­£å¥½å¯ä»¥è§£ç­”ï¼š</p><pre><code>When status &gt;= 200 (i.e., ngx.HTTP_OK and above), it will interrupt the execution of the current request and return status code to nginx.\n\nWhen status == 0 (i.e., ngx.OK), it will only quit the current phase handler (or the content handler if the content_by_lua* directive is used) and continue to run later phases (if any) for the current request.\n</code></pre><p>ä¸è¿‡ï¼Œæ–‡æ¡£é‡Œå¹¶æ²¡æœ‰æåˆ°ï¼Œ OpenRestyå¯¹äº<code>ngx.exit(ngx.ERROR)</code>å’Œ<code>ngx.exit(ngx.DECLINED)</code>æ˜¯å¦‚ä½•å¤„ç†çš„ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±æ¥åšä¸ªæµ‹è¯•ï¼Œæ¯”å¦‚ä¸‹é¢è¿™æ ·ï¼š</p><pre><code>location /lua {\n        rewrite_by_lua &quot;ngx.exit(ngx.ERROR)&quot;;\n        echo hello;\n    }\n</code></pre><p>æ˜¾ç„¶ï¼Œè®¿é—®è¿™ä¸ª locationï¼Œä½ å¯ä»¥çœ‹åˆ° http å“åº”ç ä¸ºç©ºï¼Œå“åº”ä½“ä¹Ÿæ˜¯ç©ºï¼Œå¹¶æ²¡æœ‰è¿›å…¥ä¸‹ä¸€ä¸ªæ‰§è¡Œé˜¶æ®µã€‚</p><p>å…¶å®ï¼Œè¿˜æ˜¯é‚£å¥è¯ï¼Œåœ¨ OpenResty çš„å­¦ä¹ è¿‡ç¨‹ä¸­ï¼Œéšç€ä½ é€æ­¥æ·±å…¥ï¼Œä¸€å®šä¼šåœ¨æŸä¸ªé˜¶æ®µå‘ç°ï¼Œæ–‡æ¡£å’Œæµ‹è¯•æ¡ˆä¾‹éƒ½æ— æ³•å›ç­”ä½ çš„é—®é¢˜ã€‚è¿™æ—¶å€™ï¼Œå°±éœ€è¦ä½ è‡ªå·±æ„å»ºæµ‹è¯•æ¡ˆä¾‹æ¥éªŒè¯ä½ çš„æƒ³æ³•äº†ã€‚ä½ å¯ä»¥æ‰‹åŠ¨æµ‹è¯•ï¼Œä¹Ÿå¯ä»¥æ·»åŠ åœ¨ <code>test::nginx</code> æ­å»ºçš„æµ‹è¯•æ¡ˆä¾‹é›†é‡Œé¢ã€‚</p><h2>ç¬¬å››é—®ï¼Œå˜é‡å’Œç«äº‰</h2><p>Qï¼šè€å¸ˆï¼Œä½ å¥½ï¼Œæˆ‘æœ‰ä¸‹é¢å‡ ä¸ªé—®é¢˜æƒ³è¯·æ•™ä¸€ä¸‹ã€‚</p><ol>\n<li>å‰é¢è®²è¿‡ï¼Œ<code>ngx.var</code>å˜é‡çš„ä½œç”¨åŸŸåœ¨nginx Cå’Œlua-nginx-moduleæ¨¡å—ä¹‹é—´ã€‚è¿™ä¸ªæˆ‘ä¸å¤ªç†è§£ï¼Œä»è¯·æ±‚çš„è§’åº¦æ¥çœ‹ï¼Œæ˜¯æŒ‡ä¸€ä¸ªå·¥ä½œè¿›ç¨‹ä¸­çš„å•ä¸ªè¯·æ±‚å—ï¼Ÿ</li>\n<li>æˆ‘çš„ç†è§£æ˜¯ï¼Œåœ¨æˆ‘ä»¬æ“ä½œæ¨¡å—å†…çš„å˜é‡æ—¶ï¼Œå¦‚æœä¸¤ä¸ªæ“ä½œä¹‹é—´æœ‰é˜»å¡æ“ä½œï¼Œå¯èƒ½ä¼šå‡ºç°ç«äº‰ã€‚é‚£ä¹ˆï¼Œå¦‚æœä¸¤ä¸ªæ“ä½œä¹‹é—´æ²¡æœ‰é˜»å¡æ“ä½œï¼Œæ°å¥½CPUæ—¶é—´åˆ°äº†åï¼Œå½“å‰è¿›ç¨‹è¿›å…¥å°±ç»ªé˜Ÿåˆ—ï¼Œè¿™æ ·å¯èƒ½äº§ç”Ÿç«äº‰å—ï¼Ÿ</li>\n</ol><p>Aï¼šæˆ‘ä»¬ä¾æ¬¡æ¥çœ‹è¿™å‡ ä¸ªé—®é¢˜ã€‚</p><p>ç¬¬ä¸€ï¼Œå…³äº<code>ngx.var</code> å˜é‡çš„é—®é¢˜ï¼Œä½ çš„ç†è§£æ˜¯æ­£ç¡®çš„ã€‚å®é™…ä¸Šï¼Œ<code>ngx.var</code> çš„ç”Ÿå‘½å‘¨æœŸå’Œè¯·æ±‚ä¸€è‡´ï¼Œè¯·æ±‚ç»“æŸå®ƒä¹Ÿå°±æ¶ˆå¤±äº†ã€‚ä½†å®ƒçš„ä¼˜åŠ¿ï¼Œæ˜¯æ•°æ®å¯ä»¥åœ¨ C æ¨¡å—å’Œ Lua ä»£ç ä¸­ä¼ é€’ã€‚è¿™æ˜¯å…¶ä»–å‡ ç§æ–¹å¼éƒ½æ— æ³•åšåˆ°çš„ã€‚</p><p>ç¬¬äºŒï¼Œå…³äºå˜é‡ç«äº‰çš„é—®é¢˜ï¼Œå…¶å®ï¼Œåªè¦ä¸¤ä¸ªæ“ä½œä¹‹é—´æœ‰ <code>yield æ“ä½œ</code>ï¼Œå°±å¯èƒ½å‡ºç°ç«äº‰ï¼Œè€Œä¸æ˜¯é˜»å¡æ“ä½œï¼›æœ‰é˜»å¡æ“ä½œæ—¶æ˜¯ä¸ä¼šå‡ºç°ç«äº‰çš„ã€‚æ¢å¥è¯è¯´ï¼Œåªè¦ä½ ä¸æŠŠä¸»åŠ¨æƒäº¤ç»™ Nginx çš„äº‹ä»¶å¾ªç¯ï¼Œå°±ä¸ä¼šæœ‰ç«äº‰ã€‚</p><h2>ç¬¬äº”é—®ï¼Œå…±äº«å­—å…¸æ“ä½œæ˜¯å¦éœ€è¦åŠ é”å‘¢ï¼Ÿ</h2><p>Qï¼šè€å¸ˆï¼Œå¦‚æœå¤šä¸ªworkerå¹¶å‘å­˜å‚¨æ•°æ®ï¼Œæ˜¯ä¸æ˜¯éœ€è¦åŠ é”å‘¢ï¼Ÿæ¯”å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š</p><pre><code>resty --shdict 'dogs 10m' -e 'local dogs = ngx.shared.dogs\nlocal lock= ngx.xxxx.lock\nlock.lock()\n dogs:set(&quot;Jim&quot;, 8)\nlock.unlock()\n local v = dogs:get(&quot;Jim&quot;)\n ngx.say(v)\n '\n</code></pre><p>Aï¼šå…¶å®è¿™é‡Œä¸ç”¨ä½ è‡ªå·±åŠ é”ï¼Œå…±äº«å­—å…¸ï¼ˆshared dictï¼‰çš„æ“ä½œéƒ½æ˜¯åŸå­æ€§çš„ï¼Œä¸ç®¡æ˜¯ get è¿˜æ˜¯ setã€‚è¿™ç§ç±»ä¼¼åŠ é”çš„å¤„ç†ï¼ŒOpenRestyå·²ç»å¸®ä½ è€ƒè™‘åˆ°äº†ã€‚</p><h2>ç¬¬å…­é—®ï¼ŒOpenResty ä¸­å¦‚ä½•æ›´æ–°æ—¶é—´ï¼Ÿ</h2><p>Qï¼š<code>ngx.now()</code>å–æ—¶é—´ï¼Œæ˜¯å‘ç”Ÿåœ¨resumeå‡½æ•°æ¢å¤å †æ ˆé˜¶æ®µå—ï¼Ÿ</p><p>Aï¼šNginx æ˜¯ä»¥æ€§èƒ½ä¼˜å…ˆä½œä¸ºè®¾è®¡ç†å¿µçš„ï¼Œå®ƒä¼šæŠŠæ—¶é—´ç¼“å­˜ä¸‹æ¥ã€‚è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬ä» <code>ngx.now</code> çš„æºç ä¸­å°±å¯ä»¥å¾—åˆ°å°è¯ï¼š</p><pre><code>static int\nngx_http_lua_ngx_now(lua_State *L)\n{\n    ngx_time_t              *tp;\n\n    tp = ngx_timeofday();\n\n    lua_pushnumber(L, (lua_Number) (tp-&gt;sec + tp-&gt;msec / 1000.0L));\n\n    return 1;\n}\n</code></pre><p>å¯ä»¥çœ‹å‡ºï¼Œ<code>ngx.now()</code>è¿™ä¸ªè·å–å½“å‰æ—¶é—´å‡½æ•°çš„èƒŒåï¼Œéšè—çš„å…¶å®æ˜¯ Nginx çš„ <code>ngx_timeofday</code> å‡½æ•°ã€‚è€Œ<code>ngx_timeofday</code> å‡½æ•°ï¼Œå…¶å®æ˜¯ä¸€ä¸ªå®å®šä¹‰ï¼š</p><pre><code>#define ngx_timeofday()      (ngx_time_t *) ngx_cached_time\n</code></pre><p>è¿™é‡Œ<code>ngx_cached_time</code> çš„å€¼ï¼Œåªåœ¨å‡½æ•° <code>ngx_time_update</code> ä¸­ä¼šæ›´æ–°ã€‚</p><p>æ‰€ä»¥ï¼Œè¿™ä¸ªé—®é¢˜å°±ç®€åŒ–æˆäº†ï¼Œ  <code>ngx_time_update</code>ä»€ä¹ˆæ—¶å€™ä¼šè¢«è°ƒç”¨ï¼Ÿå¦‚æœä½ åœ¨ Nginx çš„æºç ä¸­å»è·Ÿè¸ªå®ƒçš„è¯ï¼Œå°±ä¼šå‘ç°ï¼Œ  <code>ngx_time_update</code> çš„è°ƒç”¨éƒ½å‡ºç°åœ¨äº‹ä»¶å¾ªç¯ä¸­ï¼Œè¿™ä¸ªé—®é¢˜ä¹Ÿå°±æ˜ç™½äº†å§ã€‚</p><p>é€šè¿‡è¿™ä¸ªé—®é¢˜ä½ åº”è¯¥ä¹Ÿèƒ½å‘ç°ï¼Œå¼€æºé¡¹ç›®çš„å¥½å¤„å°±æ˜¯ï¼Œä½ å¯ä»¥æ ¹æ®è››ä¸é©¬è¿¹ï¼Œåœ¨æºç ä¸­å¯»æ‰¾ç­”æ¡ˆï¼Œé¢‡æœ‰ä¸€ç§ç ´æ¡ˆçš„æ„Ÿè§‰ã€‚</p><p>ä»Šå¤©ä¸»è¦è§£ç­”è¿™å‡ ä¸ªé—®é¢˜ã€‚æœ€åï¼Œæ¬¢è¿ä½ ç»§ç»­åœ¨ç•™è¨€åŒºå†™ä¸‹ä½ çš„ç–‘é—®ï¼Œæˆ‘ä¼šæŒç»­ä¸æ–­åœ°è§£ç­”ã€‚å¸Œæœ›å¯ä»¥é€šè¿‡äº¤æµå’Œç­”ç–‘ï¼Œå¸®ä½ æŠŠæ‰€å­¦è½¬åŒ–ä¸ºæ‰€å¾—ã€‚ä¹Ÿæ¬¢è¿ä½ æŠŠè¿™ç¯‡æ–‡ç« è½¬å‘å‡ºå»ï¼Œæˆ‘ä»¬ä¸€èµ·äº¤æµã€ä¸€èµ·è¿›æ­¥ã€‚</p><p></p>","comments":[{"had_liked":false,"id":115858,"user_name":"HelloBug","can_delete":false,"product_type":"c1","uid":1249598,"ip_address":"","ucode":"E61A4AD5C2F724","user_header":"https://static001.geekbang.org/account/avatar/00/13/11/3e/925aa996.jpg","comment_is_top":false,"comment_ctime":1563759168,"is_pvip":true,"replies":[{"id":"43750","content":"æˆ‘çš„ç†è§£å“ˆï¼Œå¤šä¸ª worker å…±äº«äº†åŒä¸€ä¸ª shared dictï¼Œä½ è¿™é‡Œçš„æè¿°æ›´åƒæ˜¯æ•°æ®åº“é‡Œé¢çš„äº‹åŠ¡ï¼Œè¦è¾¾åˆ°è¿™ä¸ªæ•ˆæœæœ‰ä¸¤ä¸ªæ–¹æ³•ï¼š<br>1. å¦‚æœç”¨ incr èƒ½å¤Ÿæ»¡è¶³ä½ çš„éœ€æ±‚çš„è¯ï¼Œå°±ä¸è¦ç”¨ setï¼›<br>2. å¦åˆ™å°±éœ€è¦ä½ è‡ªå·±å»æ‰‹å·¥åŠ é”ã€‚<br>å¦‚æœæ˜¯ lrucache çš„ get å’Œ set æ“ä½œå°±ä¸ä¼šæœ‰è¿™ä¸ªé—®é¢˜ï¼Œå› ä¸ºå®ƒåªå­˜åœ¨äºä¸€ä¸ª worker å†…ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1564544866,"ip_address":"","comment_id":115858,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5858726464","product_id":100028301,"comment_content":"è€å¸ˆï¼Œä½ å¥½ï¼Œå…³äºå…±äº«å†…å­˜åŠ é”åŠç«äº‰æ¡ä»¶æœ‰ä¸ªç–‘é—®~<br>å‡è®¾æœ‰è¿™æ ·çš„åœºæ™¯ï¼Œæ‰€æœ‰çš„å·¥ä½œè¿›ç¨‹éƒ½å¯ä»¥æ‰§è¡Œåˆ°å¦‚ä¸‹æ“ä½œåºåˆ—ï¼Œdict.get, dict.setã€‚è¿›ç¨‹1æ‰§è¡Œäº†dict.getä¹‹åï¼Œè¿›ç¨‹2è¿™æ—¶è·å¾—äº†å…±äº«å†…å­˜é”ï¼Œè¿™ä¸ªæ—¶å€™æ‰§è¡Œäº†dict.setï¼Œç„¶åè¿›ç¨‹1å†æ¬¡è·å¾—äº†å…±äº«å†…å­˜é”ï¼Œæ‰§è¡Œdict.setä¹‹å‰ï¼Œçœ‹åˆ°çš„å…¶å®å·²ç»æ˜¯å…±äº«å†…å­˜ä¸­æ¯”è¾ƒè€çš„æ•°æ®äº†ï¼Œç„¶åæ‰§è¡Œäº†dict.setæ“ä½œï¼Œè¦†ç›–äº†è¿›ç¨‹2çš„æ“ä½œã€‚è¿™é‡Œç­‰å¾…è·å¾—å…±äº«å†…å­˜é”çš„æ“ä½œï¼Œåº”è¯¥æ˜¯ä¸ªé˜»å¡æ“ä½œï¼ŒæŒ‰ç…§æ–‡ä¸­çš„è¯´æ³•ï¼Œé˜»å¡æ“ä½œåº”è¯¥ä¸ä¼šäº§ç”Ÿç«äº‰ã€‚å¯æ˜¯è¿™é‡Œåº”è¯¥æ˜¯äº§ç”Ÿäº†ç«äº‰äº†æ˜¯å§ï¼Ÿéš¾é“è¯´è¿™é‡Œæ¶‰åŠåˆ°æŠŠä¸»åŠ¨æƒäº¤ç»™nginxçš„äº‹ä»¶å¾ªç¯äº†å—ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":459316,"discussion_content":"æˆ‘çš„ç†è§£å“ˆï¼Œå¤šä¸ª worker å…±äº«äº†åŒä¸€ä¸ª shared dictï¼Œä½ è¿™é‡Œçš„æè¿°æ›´åƒæ˜¯æ•°æ®åº“é‡Œé¢çš„äº‹åŠ¡ï¼Œè¦è¾¾åˆ°è¿™ä¸ªæ•ˆæœæœ‰ä¸¤ä¸ªæ–¹æ³•ï¼š\n1. å¦‚æœç”¨ incr èƒ½å¤Ÿæ»¡è¶³ä½ çš„éœ€æ±‚çš„è¯ï¼Œå°±ä¸è¦ç”¨ setï¼›\n2. å¦åˆ™å°±éœ€è¦ä½ è‡ªå·±å»æ‰‹å·¥åŠ é”ã€‚\nå¦‚æœæ˜¯ lrucache çš„ get å’Œ set æ“ä½œå°±ä¸ä¼šæœ‰è¿™ä¸ªé—®é¢˜ï¼Œå› ä¸ºå®ƒåªå­˜åœ¨äºä¸€ä¸ª worker å†…ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564544866,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":146939,"user_name":"HelloTalk","can_delete":false,"product_type":"c1","uid":1618633,"ip_address":"","ucode":"F898E6A7C61D39","user_header":"https://static001.geekbang.org/account/avatar/00/18/b2/c9/b414a77c.jpg","comment_is_top":false,"comment_ctime":1572708798,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1572708798","product_id":100028301,"comment_content":"ç‰¹æƒè¿›ç¨‹çš„æƒé™å’Œ master è¿›ç¨‹çš„æƒé™ä¿æŒä¸€æ ·ã€‚<br><br>è¿™å¥è¯çš„æ„æ€æ˜¯è¯´ ç‰¹æƒè¿›ç¨‹ ä¸æ˜¯masterè¿›ç¨‹å—ï¼Ÿ<br>å¦‚åœ¨ workeræ•°é‡ä¸º4çš„æƒ…å†µ nginx<br>  nginx: worker process<br>  nginx: worker process<br>  nginx: worker process<br>  nginx: worker process<br>  nginx: cache manager process<br>  nginx: master process &#47;usr&#47;local&#47;openresty&#47;nginx&#47;sbin&#47;nginx -c  <br>æ€»å…±å°±è¿™6ä¸ªè¿›ç¨‹ï¼Œmaster å°±æ˜¯ç‰¹æƒè¿›ç¨‹å§","like_count":0},{"had_liked":false,"id":116685,"user_name":"é«˜è¿œ","can_delete":false,"product_type":"c1","uid":1022886,"ip_address":"","ucode":"BC84D5A3EA37A6","user_header":"https://static001.geekbang.org/account/avatar/00/0f/9b/a6/1f485c48.jpg","comment_is_top":false,"comment_ctime":1563890688,"is_pvip":true,"replies":[{"id":"42827","content":"ç½®é¡¶ï¼šï¼‰","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1563973401,"ip_address":"","comment_id":116685,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1563890688","product_id":100028301,"comment_content":"æ–­ç‚¹è°ƒè¯•åˆ«å¿˜äº†lua-resty-replå‘€ï½ğŸ˜","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":459640,"discussion_content":"ç½®é¡¶ï¼šï¼‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563973401,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":116214,"user_name":"wusiration","can_delete":false,"product_type":"c1","uid":1104438,"ip_address":"","ucode":"A9403377054F1E","user_header":"https://static001.geekbang.org/account/avatar/00/10/da/36/ac0ff6a7.jpg","comment_is_top":false,"comment_ctime":1563802912,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1563802912","product_id":100028301,"comment_content":"å—ç›Šè‰¯å¤šï¼Œè°¢è°¢è€å¸ˆçš„è§£ç­”","like_count":0}]}