{"id":461999,"title":"42ï½œé˜¶æ®µå®æ“ï¼ˆ7ï¼‰ï¼šæ„å»ºä¸€ä¸ªç®€å•çš„KV server-å¦‚ä½•åšå¤§çš„é‡æ„ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯é™ˆå¤©ã€‚</p><p>åœ¨è½¯ä»¶å¼€å‘çš„è¿‡ç¨‹ä¸­ï¼Œä¸€å¼€å§‹è®¾è®¡å¾—å†ç²¾è‰¯ï¼Œä¹Ÿæ‰›ä¸ä½æ— ç¼˜æ— æ•…çš„éœ€æ±‚å˜æ›´ã€‚æ‰€ä»¥æˆ‘ä»¬è¦å¦¥å–„åšæ¶æ„è®¾è®¡ï¼Œè®©å®ƒèƒ½æ»¡è¶³æ½œåœ¨çš„éœ€æ±‚ï¼›ä½†ä¹Ÿä¸èƒ½è¿‡åº¦è®¾è®¡ï¼Œè®©å®ƒå»é€‚åº”ä¸€äº›è™šæ— ç¼¥ç¼ˆçš„éœ€æ±‚ã€‚å¥½çš„å¼€å‘è€…ï¼Œè¦èƒ½å¤ŸæŠŠæ¡è¿™ä¸ªåº¦ã€‚</p><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬çš„ KV server å·²ç»ç¾½ç¿¼ä¸°æ»¡ï¼Œä½œä¸ºä¸€ä¸ªåŸºæœ¬çš„ KV å­˜å‚¨å¤Ÿç”¨äº†ã€‚</p><p>è¿™æ—¶å€™ï¼Œäº§å“ç»ç†çªç„¶æŠ½é£ï¼Œæƒ³è®©ä½ åœ¨è¿™ä¸ª Server ä¸ŠåŠ ä¸Šç±»ä¼¼ Redis çš„ Pub/Sub æ”¯æŒã€‚ä½ è¯´ï¼šåˆ«é—¹ï¼Œè¿™æ ¹æœ¬å°±æ˜¯ä¸¤ä¸ªäº§å“ã€‚äº§å“ç»ç†å›åº”ï¼š Redis ä¹Ÿæ”¯æŒ Pub/Subã€‚ä½ æ€¼å›å»ï¼šé‚£å¹²è„†ç”¨ Redis çš„ Pub/Sub å¾—äº†ã€‚äº§å“ç»ç†å¬äº†å“ˆå“ˆä¸€ç¬‘ï¼šè¡Œï¼Œç”¨ Redis æŒºå¥½ï¼Œæˆ‘ä»¬è¿˜èƒ½æŠŠä½ çš„å·¥é’±çœä¸‹æ¥å‘¢ã€‚å¤©éƒ½èŠåˆ°è¿™ä»½ä¸Šäº†ï¼Œä½ åªå¥½å¦¥åï¼šé‚£å•¥ï¼Œå§ï¼Œæˆ‘åšï¼Œæˆ‘åšè¿˜ä¸è¡Œä¹ˆï¼Ÿ</p><p>è¿™è™½æ˜¯ä¸ªè™šæ„çš„æ•…äº‹ï¼Œä½†ç±»ä¼¼çš„å¤§éœ€æ±‚å˜æ›´åœ¨æˆ‘ä»¬å¼€å‘è€…çš„æ—¥å¸¸å·¥ä½œä¸­ç›¸å½“å¸¸è§ã€‚æˆ‘ä»¬å°±ä»¥è¿™ä¸ªå…·å¤‡ä¸å°éš¾åº¦çš„æŒ‘æˆ˜ï¼Œæ¥çœ‹çœ‹ï¼Œå¦‚ä½•å¯¹ä¸€ä¸ªå·²ç»æˆå½¢çš„ç³»ç»Ÿè¿›è¡Œå¤§çš„é‡æ„ã€‚</p><h2>ç°æœ‰æ¶æ„åˆ†æ</h2><p>å…ˆç®€å•å›é¡¾ä¸€ä¸‹ Redis å¯¹ Pub/Sub çš„æ”¯æŒï¼šå®¢æˆ·ç«¯å¯ä»¥éšæ—¶å‘èµ· SUBSCRIBEã€PUBLISH å’Œ UNSUBSCRIBEã€‚å¦‚æœå®¢æˆ·ç«¯ A å’Œ B SUBSCRIBE äº†ä¸€ä¸ªå« lobby çš„ä¸»é¢˜ï¼Œå®¢æˆ·ç«¯ C å¾€ lobby é‡Œå‘äº† â€œhelloâ€ï¼ŒA å’Œ B éƒ½å°†ç«‹å³æ”¶åˆ°è¿™ä¸ªä¿¡æ¯ã€‚</p><!-- [[[read_end]]] --><p>ä½¿ç”¨èµ·æ¥æ˜¯è¿™ä¸ªæ ·å­çš„ï¼š</p><pre><code class=\"language-rust\">A: SUBSCRIBE \"lobby\"\nA: SUBSCRIBE \"ç‹è€…è£è€€\"\nB: SUBSCRIBE \"lobby\"\nC: PUBLISH \"lobby\" \"hello\"\n// A/B éƒ½æ”¶åˆ° \"hello\"\nB: UNSUBSCRIBE \"lobby\"\nB: SUBSCRIBE \"ç‹è€…è£è€€\"\nD: PUBLISH \"lobby\" \"goodbye\"\n// åªæœ‰ A æ”¶åˆ° \"goodbye\"\nC: PUBLISH \"ç‹è€…è£è€€\" \"good game\"\n// A/B éƒ½æ”¶åˆ° \"good game\"\n</code></pre><p>å¸¦ç€è¿™ä¸ªéœ€æ±‚ï¼Œæˆ‘ä»¬é‡æ–°å®¡è§†ç›®å‰çš„æ¶æ„ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/82/2c/82da823b4eb16935fdeyy727e3b3262c.jpg?wh=1920x1145\" alt=\"å›¾ç‰‡\"></p><p>è¦æ”¯æŒ Pub/Subï¼Œç°æœ‰æ¶æ„æœ‰ä¸¤ä¸ªå¾ˆå¤§çš„é—®é¢˜ã€‚</p><p><strong>é¦–å…ˆï¼ŒCommandService æ˜¯ä¸€ä¸ªåŒæ­¥çš„å¤„ç†</strong>ï¼Œæ¥ä¸€ä¸ªå‘½ä»¤ï¼Œç«‹åˆ»å°±èƒ½è®¡ç®—å‡ºä¸€ä¸ªå€¼è¿”å›ã€‚ä½†ç°åœ¨æ¥ä¸€ä¸ª SUBSCRIBE å‘½ä»¤ï¼Œå®ƒæœŸå¾…çš„ä¸æ˜¯ä¸€ä¸ªå€¼ï¼Œè€Œæ˜¯æœªæ¥å¯èƒ½äº§ç”Ÿçš„è‹¥å¹²ä¸ªå€¼ã€‚æˆ‘ä»¬è®²è¿‡ Stream ä»£è¡¨æœªæ¥å¯èƒ½äº§ç”Ÿçš„ä¸€ç³»åˆ—å€¼ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦è¿”å›ä¸€ä¸ªå¼‚æ­¥çš„ Streamã€‚</p><p>å› æ­¤ï¼Œæˆ‘ä»¬è¦ä¹ˆéœ€è¦ç‰ºç‰² CommandService è¿™ä¸ª trait æ¥é€‚åº”æ–°çš„éœ€æ±‚ï¼Œè¦ä¹ˆæ„å»ºä¸€ä¸ªæ–°çš„ã€å’Œ CommandService trait å¹¶åˆ—çš„ traitï¼Œæ¥å¤„ç†å’Œ Pub/Sub æœ‰å…³çš„å‘½ä»¤ã€‚</p><p>å…¶æ¬¡ï¼Œ<strong>å¦‚æœç›´æ¥åœ¨ TCP/TLS ä¹‹ä¸Šæ„å»º Pub/Sub çš„æ”¯æŒï¼Œæˆ‘ä»¬éœ€è¦åœ¨ Request å’Œ Response ä¹‹é—´å»ºç«‹â€œæµâ€çš„æ¦‚å¿µ</strong>ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p><p>ä¹‹å‰æˆ‘ä»¬çš„åè®®è¿è¡Œæ¨¡å¼æ˜¯åŒæ­¥çš„ï¼Œä¸€æ¥ä¸€å›ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/7b/68/7byy9cdb2c3651e4cd77bdda89a52968.jpg?wh=1920x998\" alt=\"å›¾ç‰‡\"></p><p>ä½†æ˜¯ï¼Œå¦‚æœç»§ç»­é‡‡ç”¨è¿™æ ·çš„æ–¹å¼ï¼Œå°±ä¼šæœ‰åº”ç”¨å±‚çš„ <a href=\"https://en.wikipedia.org/wiki/Head-of-line_blocking\">head of line blocking</a>ï¼ˆé˜Ÿå¤´é˜»å¡ï¼‰é—®é¢˜ï¼Œä¸€ä¸ª SUBSCRIBE å‘½ä»¤ï¼Œå› ä¸ºå…¶è¿”å›ç»“æœä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™æ‰ç»“æŸï¼Œä¼šé˜»å¡åç»­çš„æ‰€æœ‰å‘½ä»¤ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ä¸€ä¸ªè¿æ¥é‡Œï¼Œåˆ’åˆ†å‡ºå¾ˆå¤šå½¼æ­¤ç‹¬ç«‹çš„â€œæµâ€ï¼Œè®©å®ƒä»¬çš„æ”¶å‘ä¸å—å½±å“ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/67/db/67659457626d12eba6e26b37ayy08edb.jpg?wh=1920x998\" alt=\"å›¾ç‰‡\"></p><p>è¿™ç§æµå¼å¤„ç†çš„å…¸å‹åè®®æ˜¯ä½¿ç”¨äº†å¤šè·¯å¤ç”¨ï¼ˆmultiplexï¼‰çš„ HTTP/2ã€‚æ‰€ä»¥ï¼Œä¸€ç§æ–¹æ¡ˆæ˜¯æˆ‘ä»¬å¯ä»¥æŠŠ KV server æ„å»ºåœ¨ä½¿ç”¨ HTTP/2 çš„ gRPC ä¸Šã€‚ä¸è¿‡ï¼ŒHTTP æ˜¯ä¸ªå¤ªè¿‡åºæ‚çš„åè®®ï¼Œå¯¹äº KV server è¿™ç§æ€§èƒ½éå¸¸é‡è¦çš„æœåŠ¡æ¥è¯´ï¼Œä¸å¿…è¦çš„é¢å¤–å¼€é”€å¤ªå¤šï¼Œæ‰€ä»¥å®ƒä¸å¤ªé€‚åˆã€‚</p><p>å¦ä¸€ç§æ–¹å¼æ˜¯ä½¿ç”¨ <a href=\"https://github.com/hashicorp/yamux/blob/master/spec.md\">Yamux</a> åè®®ï¼Œä¹‹å‰ä»‹ç»è¿‡ï¼Œå®ƒæ˜¯ä¸€ä¸ªç®€å•çš„ã€å’Œ HTTP/2 å†…éƒ¨å¤šè·¯å¤ç”¨æœºåˆ¶éå¸¸ç±»ä¼¼çš„åè®®ã€‚å¦‚æœä½¿ç”¨å®ƒï¼Œæ•´ä¸ªåè®®çš„äº¤äº’çœ‹ä¸Šå»æ˜¯è¿™ä¸ªæ ·å­çš„ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/31/67/31f3efcd510ff6a3yy0caf32dbfd8667.jpg?wh=1920x998\" alt=\"å›¾ç‰‡\"></p><p>Yamux é€‚åˆä¸å¸Œæœ›å¼•å…¥ HTTP çš„ç¹æ–‡ç¼›èŠ‚ï¼ˆå¤§é‡çš„å¤´ä¿¡æ¯ï¼‰ï¼Œåœ¨ TCP å±‚åšå¤šè·¯å¤ç”¨çš„åœºæ™¯ï¼Œä»Šå¤©å°±ç”¨å®ƒæ¥æ”¯æŒæˆ‘ä»¬æ‰€è¦å®ç°çš„ Pub/Subã€‚</p><h2>ä½¿ç”¨ yamux åšå¤šè·¯å¤ç”¨</h2><p>Rust ä¸‹æœ‰ <a href=\"https://github.com/libp2p/rust-yamux\">rust-yamux</a> è¿™ä¸ªåº“ï¼Œæ¥æ”¯æŒ yamuxã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ tokio-utilï¼Œå®ƒæä¾›äº† tokio ä¸‹çš„ trait å’Œ futures ä¸‹çš„ trait çš„å…¼å®¹èƒ½åŠ›ã€‚åœ¨ Cargo.toml ä¸­å¼•å…¥å®ƒä»¬ï¼š</p><pre><code class=\"language-rust\">[dependencies]\n...\ntokio-util = { version = \"0.6\", features = [\"compat\"]} # tokio å’Œ futures çš„å…¼å®¹æ€§åº“\n...\nyamux = \"0.9\" # yamux å¤šè·¯å¤ç”¨æ”¯æŒ\n...\n</code></pre><p>ç„¶ååˆ›å»º src/network/multiplex.rsï¼ˆè®°å¾—åœ¨ <a href=\"http://mod.rs\">mod.rs</a> é‡Œå¼•ç”¨ï¼‰ï¼Œæ·»å…¥å¦‚ä¸‹ä»£ç ï¼š</p><pre><code class=\"language-rust\">use futures::{future, Future, TryStreamExt};\nuse std::marker::PhantomData;\nuse tokio::io::{AsyncRead, AsyncWrite};\nuse tokio_util::compat::{Compat, FuturesAsyncReadCompatExt, TokioAsyncReadCompatExt};\nuse yamux::{Config, Connection, ConnectionError, Control, Mode, WindowUpdateMode};\n\n/// Yamux æ§åˆ¶ç»“æ„\npub struct YamuxCtrl&lt;S&gt; {\n    /// yamux controlï¼Œç”¨äºåˆ›å»ºæ–°çš„ stream\n    ctrl: Control,\n    _conn: PhantomData&lt;S&gt;,\n}\n\nimpl&lt;S&gt; YamuxCtrl&lt;S&gt;\nwhere\n    S: AsyncRead + AsyncWrite + Unpin + Send + 'static,\n{\n    /// åˆ›å»º yamux å®¢æˆ·ç«¯\n    pub fn new_client(stream: S, config: Option&lt;Config&gt;) -&gt; Self {\n        Self::new(stream, config, true, |_stream| future::ready(Ok(())))\n    }\n\n    /// åˆ›å»º yamux æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯æˆ‘ä»¬éœ€è¦å…·ä½“å¤„ç† stream\n    pub fn new_server&lt;F, Fut&gt;(stream: S, config: Option&lt;Config&gt;, f: F) -&gt; Self\n    where\n        F: FnMut(yamux::Stream) -&gt; Fut,\n        F: Send + 'static,\n        Fut: Future&lt;Output = Result&lt;(), ConnectionError&gt;&gt; + Send + 'static,\n    {\n        Self::new(stream, config, false, f)\n    }\n\n    // åˆ›å»º YamuxCtrl\n    fn new&lt;F, Fut&gt;(stream: S, config: Option&lt;Config&gt;, is_client: bool, f: F) -&gt; Self\n    where\n        F: FnMut(yamux::Stream) -&gt; Fut,\n        F: Send + 'static,\n        Fut: Future&lt;Output = Result&lt;(), ConnectionError&gt;&gt; + Send + 'static,\n    {\n        let mode = if is_client {\n            Mode::Client\n        } else {\n            Mode::Server\n        };\n\n        // åˆ›å»º config\n        let mut config = config.unwrap_or_default();\n        config.set_window_update_mode(WindowUpdateMode::OnRead);\n\n        // åˆ›å»º configï¼Œyamux::Stream ä½¿ç”¨çš„æ˜¯ futures çš„ trait æ‰€ä»¥éœ€è¦ compat() åˆ° tokio çš„ trait\n        let conn = Connection::new(stream.compat(), config, mode);\n\n        // åˆ›å»º yamux ctrl\n        let ctrl = conn.control();\n\n        // pull æ‰€æœ‰ stream ä¸‹çš„æ•°æ®\n        tokio::spawn(yamux::into_stream(conn).try_for_each_concurrent(None, f));\n\n        Self {\n            ctrl,\n            _conn: PhantomData::default(),\n        }\n    }\n\n    /// æ‰“å¼€ä¸€ä¸ªæ–°çš„ stream\n    pub async fn open_stream(&amp;mut self) -&gt; Result&lt;Compat&lt;yamux::Stream&gt;, ConnectionError&gt; {\n        let stream = self.ctrl.open_stream().await?;\n        Ok(stream.compat())\n    }\n}\n</code></pre><p>è¿™æ®µä»£ç æä¾›äº† Yamux çš„åŸºæœ¬å¤„ç†ã€‚å¦‚æœæœ‰äº›åœ°æ–¹ä½ çœ‹ä¸æ˜ç™½ï¼Œæ¯”å¦‚ WindowUpdateModeï¼Œyamux::into_stream() ç­‰ï¼Œå¾ˆæ­£å¸¸ï¼Œéœ€è¦çœ‹çœ‹ <a href=\"https://github.com/libp2p/rust-yamux\">yamux crate </a>çš„æ–‡æ¡£å’Œä¾‹å­ã€‚</p><p>è¿™é‡Œæœ‰ä¸€ä¸ªå¤æ‚çš„æ¥å£ï¼Œæˆ‘ä»¬ç¨å¾®è§£é‡Šä¸€ä¸‹ï¼š</p><pre><code class=\"language-rust\">pub fn new_server&lt;F, Fut&gt;(stream: S, config: Option&lt;Config&gt;, f: F) -&gt; Self\nwhere\n    F: FnMut(yamux::Stream) -&gt; Fut,\n    F: Send + 'static,\n    Fut: Future&lt;Output = Result&lt;(), ConnectionError&gt;&gt; + Send + 'static,\n{\n    Self::new(stream, config, false, f)\n}\n</code></pre><p>å®ƒçš„æ„æ€æ˜¯ï¼Œå‚æ•° f æ˜¯ä¸€ä¸ª FnMut é—­åŒ…ï¼Œæ¥å—ä¸€ä¸ª yamux::Stream å‚æ•°ï¼Œè¿”å› Futureã€‚è¿™æ ·çš„ç»“æ„æˆ‘ä»¬ä¹‹å‰è§è¿‡ï¼Œä¹‹æ‰€ä»¥æ¥å£è¿™ä¹ˆå¤æ‚ï¼Œæ˜¯å› ä¸º Rust è¿˜æ²¡æœ‰æŠŠ async é—­åŒ…ç¨³å®šä¸‹æ¥ã€‚æ‰€ä»¥ï¼Œå¦‚æœè¦æƒ³å†™ä¸€ä¸ª <code>async || {}</code>ï¼Œè¿™æ˜¯æœ€ä½³çš„æ–¹å¼ã€‚</p><p>è¿˜æ˜¯å†™ä¸€æ®µæµ‹è¯•æµ‹ä¸€ä¸‹ï¼ˆç¯‡å¹…å…³ç³»ï¼Œå®Œæ•´çš„ä»£ç å°±ä¸æ”¾äº†ï¼Œä½ å¯ä»¥åˆ° GitHub repo ä¸‹å¯¹ç…§ diff_yamux çœ‹ä¿®æ”¹ï¼‰ï¼š</p><pre><code class=\"language-rust\">#[tokio::test]\nasync fn yamux_ctrl_client_server_should_work() -&gt; Result&lt;()&gt; {\n    // åˆ›å»ºä½¿ç”¨äº† TLS çš„ yamux server\n    let acceptor = tls_acceptor(false)?;\n    let addr = start_yamux_server(\"127.0.0.1:0\", acceptor, MemTable::new()).await?;\n\n    let connector = tls_connector(false)?;\n    let stream = TcpStream::connect(addr).await?;\n    let stream = connector.connect(stream).await?;\n    // åˆ›å»ºä½¿ç”¨äº† TLS çš„ yamux client\n    let mut ctrl = YamuxCtrl::new_client(stream, None);\n\n    // ä» client ctrl ä¸­æ‰“å¼€ä¸€ä¸ªæ–°çš„ yamux stream\n    let stream = ctrl.open_stream().await?;\n    // å°è£…æˆ ProstClientStream\n    let mut client = ProstClientStream::new(stream);\n\n    let cmd = CommandRequest::new_hset(\"t1\", \"k1\", \"v1\".into());\n    client.execute(cmd).await.unwrap();\n\n    let cmd = CommandRequest::new_hget(\"t1\", \"k1\");\n    let res = client.execute(cmd).await.unwrap();\n    assert_res_ok(res, &amp;[\"v1\".into()], &amp;[]);\n\n    Ok(())\n}\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œç»è¿‡ç®€å•çš„å°è£…ï¼Œyamux å°±å¾ˆè‡ªç„¶åœ°èå…¥åˆ°æˆ‘ä»¬ç°æœ‰çš„æ¶æ„ä¸­ã€‚å› ä¸º open_stream() å¾—åˆ°çš„æ˜¯ç¬¦åˆ tokio AsyncRead / AsyncWrite çš„ streamï¼Œæ‰€ä»¥å®ƒå¯ä»¥ç›´æ¥é…åˆ ProstClientStream ä½¿ç”¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬ç½‘ç»œå±‚åˆæ”¹åŠ¨äº†ä¸€ä¸‹ï¼Œä½†åé¢é€»è¾‘ä¾ç„¶ä¸ç”¨å˜ã€‚</p><p>è¿è¡Œ <code>cargo test</code> ï¼Œæ‰€æœ‰æµ‹è¯•éƒ½èƒ½é€šè¿‡ã€‚</p><h2>æ”¯æŒ pub/sub</h2><p>å¥½ï¼Œç°åœ¨ç½‘ç»œå±‚å·²ç»æ”¯æŒäº† yamuxï¼Œä¸ºå¤šè·¯å¤ç”¨æ‰“ä¸‹äº†åŸºç¡€ã€‚æˆ‘ä»¬æ¥çœ‹ pub/sub å…·ä½“æ€ä¹ˆå®ç°ã€‚</p><p>é¦–å…ˆä¿®æ”¹ abi.protoï¼ŒåŠ å…¥æ–°çš„å‡ ä¸ªå‘½ä»¤ï¼š</p><pre><code class=\"language-rust\">// æ¥è‡ªå®¢æˆ·ç«¯çš„å‘½ä»¤è¯·æ±‚\nmessage CommandRequest {\n  oneof request_data {\n    ...\n    Subscribe subscribe = 10;\n    Unsubscribe unsubscribe = 11;\n    Publish publish = 12;\n  }\n}\n\n// subscribe åˆ°æŸä¸ªä¸»é¢˜ï¼Œä»»ä½•å‘å¸ƒåˆ°è¿™ä¸ªä¸»é¢˜çš„æ•°æ®éƒ½ä¼šè¢«æ”¶åˆ°\n// æˆåŠŸåï¼Œç¬¬ä¸€ä¸ªè¿”å›çš„ CommandResponseï¼Œæˆ‘ä»¬è¿”å›ä¸€ä¸ªå”¯ä¸€çš„ subscription id\nmessage Subscribe { string topic = 1; }\n\n// å–æ¶ˆå¯¹æŸä¸ªä¸»é¢˜çš„è®¢é˜…\nmessage Unsubscribe {\n  string topic = 1;\n  uint32 id = 2;\n}\n\n// å‘å¸ƒæ•°æ®åˆ°æŸä¸ªä¸»é¢˜\nmessage Publish {\n  string topic = 1;\n  repeated Value data = 2;\n}\n</code></pre><p>å‘½ä»¤çš„å“åº”æˆ‘ä»¬ä¸ç”¨æ”¹å˜ã€‚å½“å®¢æˆ·ç«¯ Subscribe æ—¶ï¼Œè¿”å›çš„ stream é‡Œçš„ç¬¬ä¸€ä¸ªå€¼åŒ…å«è®¢é˜… IDï¼Œè¿™æ˜¯ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„ IDï¼Œè¿™æ ·ï¼Œå®¢æˆ·ç«¯åç»­å¯ä»¥ç”¨ Unsubscribe å–æ¶ˆã€‚</p><h3>Pub/Sub å¦‚ä½•è®¾è®¡ï¼Ÿ</h3><p>é‚£ä¹ˆï¼ŒPub/Sub è¯¥å¦‚ä½•å®ç°å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬å¯ä»¥ç”¨<strong>ä¸¤å¼ è¡¨</strong>ï¼šä¸€å¼  Topic Tableï¼Œå­˜æ”¾ä¸»é¢˜å’Œå¯¹åº”çš„è®¢é˜…åˆ—è¡¨ï¼›ä¸€å¼  Subscription Tableï¼Œå­˜æ”¾è®¢é˜… ID å’Œ channel çš„å‘é€ç«¯ã€‚</p><p>å½“ SUBSCRIBE æ—¶ï¼Œæˆ‘ä»¬è·å–ä¸€ä¸ªè®¢é˜… IDï¼Œæ’å…¥åˆ° Topic Tableï¼Œç„¶åå†åˆ›å»ºä¸€ä¸ª MPSC channelï¼ŒæŠŠ channel çš„å‘é€ç«¯å’Œè®¢é˜… ID å­˜å…¥ subscription tableã€‚</p><p>è¿™æ ·ï¼Œå½“æœ‰äºº PUBLISH æ—¶ï¼Œå¯ä»¥ä» Topic table ä¸­æ‰¾åˆ°å¯¹åº”çš„è®¢é˜… ID çš„åˆ—è¡¨ï¼Œç„¶åå¾ªç¯ä» subscription table ä¸­æ‰¾åˆ°å¯¹åº”çš„ Senderï¼Œå¾€é‡Œé¢å†™å…¥æ•°æ®ã€‚æ­¤æ—¶ï¼Œchannel çš„ Receiver ç«¯ä¼šå¾—åˆ°æ•°æ®ï¼Œè¿™ä¸ªæ•°æ®ä¼šè¢« yamux stream poll åˆ°ï¼Œç„¶åå‘ç»™å®¢æˆ·ç«¯ã€‚</p><p>æ•´ä¸ªæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/7c/30/7ce3046af823dbbdaa7b47d12d04ce30.jpg?wh=1920x1145\" alt=\"å›¾ç‰‡\"></p><p>æœ‰äº†è¿™ä¸ªåŸºæœ¬è®¾è®¡ï¼Œæˆ‘ä»¬å¯ä»¥ç€æ‰‹æ¥å£å’Œæ•°æ®ç»“æ„çš„æ„å»ºäº†ï¼š</p><pre><code class=\"language-rust\">/// ä¸‹ä¸€ä¸ª subscription id\nstatic NEXT_ID: AtomicU32 = AtomicU32::new(1);\n\n/// è·å–ä¸‹ä¸€ä¸ª subscription id\nfn get_next_subscription_id() -&gt; u32 {\n    NEXT_ID.fetch_add(1, Ordering::Relaxed)\n}\n\npub trait Topic: Send + Sync + 'static {\n    /// è®¢é˜…æŸä¸ªä¸»é¢˜\n    fn subscribe(self, name: String) -&gt; mpsc::Receiver&lt;Arc&lt;CommandResponse&gt;&gt;;\n    /// å–æ¶ˆå¯¹ä¸»é¢˜çš„è®¢é˜…\n    fn unsubscribe(self, name: String, id: u32);\n    /// å¾€ä¸»é¢˜é‡Œå‘å¸ƒä¸€ä¸ªæ•°æ®\n    fn publish(self, name: String, value: Arc&lt;CommandResponse&gt;);\n}\n\n/// ç”¨äºä¸»é¢˜å‘å¸ƒå’Œè®¢é˜…çš„æ•°æ®ç»“æ„\n#[derive(Default)]\npub struct Broadcaster {\n    /// æ‰€æœ‰çš„ä¸»é¢˜åˆ—è¡¨\n    topics: DashMap&lt;String, DashSet&lt;u32&gt;&gt;,\n    /// æ‰€æœ‰çš„è®¢é˜…åˆ—è¡¨\n    subscriptions: DashMap&lt;u32, mpsc::Sender&lt;Arc&lt;CommandResponse&gt;&gt;&gt;,\n}\n</code></pre><p>è¿™é‡Œï¼Œsubscription_id æˆ‘ä»¬ç”¨ä¸€ä¸ª AtomicU32 æ¥è¡¨è¿°ã€‚</p><p>å¯¹äºè¿™æ ·ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„ IDï¼Œå¾ˆå¤šåŒå­¦å–œæ¬¢ç”¨ UUID4 æ¥è¡¨è¿°ã€‚æ³¨æ„ä½¿ç”¨ UUID çš„è¯ï¼Œå­˜å‚¨æ—¶ä¸€å®šä¸è¦å­˜å®ƒçš„å­—ç¬¦ä¸²è¡¨ç°å½¢å¼ï¼Œå¤ªæµªè´¹å†…å­˜ä¸”æ¯æ¬¡éƒ½æœ‰é¢å¤–çš„å †åˆ†é…ï¼Œåº”è¯¥ç”¨å®ƒ u128 çš„è¡¨ç°å½¢å¼ã€‚</p><p>ä¸è¿‡å³ä¾¿ u128ï¼Œä¹Ÿæ¯” u32 æµªè´¹å¾ˆå¤šç©ºé—´ã€‚å‡è®¾æŸä¸ªä¸»é¢˜ M ä¸‹æœ‰ä¸€ä¸‡ä¸ªè®¢é˜…ï¼Œè¦å¾€è¿™ä¸ª M é‡Œå‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œå°±æ„å‘³ç€æ•´ä¸ª DashSet&lt;u32&gt; çš„ä¸€æ¬¡æ‹·è´ï¼Œä¹˜ä¸Šä¸€ä¸‡ï¼Œu32 çš„è¯åš 40k å†…å­˜çš„æ‹·è´ï¼Œè€Œ u128 è¦åš 160k å†…å­˜çš„æ‹·è´ã€‚è¿™ä¸ªæ€§èƒ½ä¸Šçš„å·®è·å°±å¾ˆæ˜æ˜¾äº†ã€‚</p><p>å¦å¤–ï¼Œæˆ‘ä»¬æŠŠ CommandResponse å°è£…è¿›äº†ä¸€ä¸ª Arcã€‚å¦‚æœä¸€æ¡æ¶ˆæ¯è¦å‘é€ç»™ä¸€ä¸‡ä¸ªå®¢æˆ·ç«¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸å¸Œæœ›è¿™æ¡æ¶ˆæ¯è¢«å¤åˆ¶åï¼Œå†è¢«å‘é€ï¼Œè€Œæ˜¯ç›´æ¥å‘é€åŒä¸€ä»½æ•°æ®ã€‚</p><p>è¿™é‡Œå¯¹ Pub/Sub çš„æ¥å£ï¼Œæ„å»ºäº†ä¸€ä¸ª Topic traitã€‚è™½ç„¶ç›®å‰æˆ‘ä»¬åªæœ‰ Broadcaster ä¼šå®ç° Topic traitï¼Œä½†æœªæ¥ä¹Ÿè®¸ä¼šæ¢ä¸åŒçš„å®ç°æ–¹å¼ï¼Œæ‰€ä»¥ï¼ŒæŠ½è±¡å‡º Topic trait å¾ˆæœ‰æ„ä¹‰ã€‚</p><h3>Pub/Sub çš„å®ç°</h3><p>å¥½ï¼Œæˆ‘ä»¬æ¥å†™ä»£ç ã€‚åˆ›å»º src/service/topic.rsï¼ˆè®°å¾—åœ¨ <a href=\"http://mod.rs\">mod.rs</a> é‡Œå¼•ç”¨ï¼‰ï¼Œå¹¶æ·»å…¥ï¼š</p><pre><code class=\"language-rust\">use dashmap::{DashMap, DashSet};\nuse std::sync::{\n    atomic::{AtomicU32, Ordering},\n    Arc,\n};\nuse tokio::sync::mpsc;\nuse tracing::{debug, info, warn};\n\nuse crate::{CommandResponse, Value};\n\n/// topic é‡Œæœ€å¤§å­˜æ”¾çš„æ•°æ®\nconst BROADCAST_CAPACITY: usize = 128;\n\n/// ä¸‹ä¸€ä¸ª subscription id\nstatic NEXT_ID: AtomicU32 = AtomicU32::new(1);\n\n/// è·å–ä¸‹ä¸€ä¸ª subscription id\nfn get_next_subscription_id() -&gt; u32 {\n    NEXT_ID.fetch_add(1, Ordering::Relaxed)\n}\n\npub trait Topic: Send + Sync + 'static {\n    /// è®¢é˜…æŸä¸ªä¸»é¢˜\n    fn subscribe(self, name: String) -&gt; mpsc::Receiver&lt;Arc&lt;CommandResponse&gt;&gt;;\n    /// å–æ¶ˆå¯¹ä¸»é¢˜çš„è®¢é˜…\n    fn unsubscribe(self, name: String, id: u32);\n    /// å¾€ä¸»é¢˜é‡Œå‘å¸ƒä¸€ä¸ªæ•°æ®\n    fn publish(self, name: String, value: Arc&lt;CommandResponse&gt;);\n}\n\n/// ç”¨äºä¸»é¢˜å‘å¸ƒå’Œè®¢é˜…çš„æ•°æ®ç»“æ„\n#[derive(Default)]\npub struct Broadcaster {\n    /// æ‰€æœ‰çš„ä¸»é¢˜åˆ—è¡¨\n    topics: DashMap&lt;String, DashSet&lt;u32&gt;&gt;,\n    /// æ‰€æœ‰çš„è®¢é˜…åˆ—è¡¨\n    subscriptions: DashMap&lt;u32, mpsc::Sender&lt;Arc&lt;CommandResponse&gt;&gt;&gt;,\n}\n\nimpl Topic for Arc&lt;Broadcaster&gt; {\n    fn subscribe(self, name: String) -&gt; mpsc::Receiver&lt;Arc&lt;CommandResponse&gt;&gt; {\n        let id = {\n            let entry = self.topics.entry(name).or_default();\n            let id = get_next_subscription_id();\n            entry.value().insert(id);\n            id\n        };\n\n        // ç”Ÿæˆä¸€ä¸ª mpsc channel\n        let (tx, rx) = mpsc::channel(BROADCAST_CAPACITY);\n\n        let v: Value = (id as i64).into();\n\n        // ç«‹åˆ»å‘é€ subscription id åˆ° rx\n        let tx1 = tx.clone();\n        tokio::spawn(async move {\n            if let Err(e) = tx1.send(Arc::new(v.into())).await {\n                // TODO: è¿™ä¸ªå¾ˆå°æ¦‚ç‡å‘ç”Ÿï¼Œä½†ç›®å‰æˆ‘ä»¬æ²¡æœ‰å–„å\n                warn!(\"Failed to send subscription id: {}. Error: {:?}\", id, e);\n            }\n        });\n\n        // æŠŠ tx å­˜å…¥ subscription table\n        self.subscriptions.insert(id, tx);\n        debug!(\"Subscription {} is added\", id);\n\n        // è¿”å› rx ç»™ç½‘ç»œå¤„ç†çš„ä¸Šä¸‹æ–‡\n        rx\n    }\n\n    fn unsubscribe(self, name: String, id: u32) {\n        if let Some(v) = self.topics.get_mut(&amp;name) {\n            // åœ¨ topics è¡¨é‡Œæ‰¾åˆ° topic çš„ subscription idï¼Œåˆ é™¤\n            v.remove(&amp;id);\n\n            // å¦‚æœè¿™ä¸ª topic ä¸ºç©ºï¼Œåˆ™ä¹Ÿåˆ é™¤ topic\n            if v.is_empty() {\n                info!(\"Topic: {:?} is deleted\", &amp;name);\n                drop(v);\n                self.topics.remove(&amp;name);\n            }\n        }\n\n        debug!(\"Subscription {} is removed!\", id);\n        // åœ¨ subscription è¡¨ä¸­åŒæ ·åˆ é™¤\n        self.subscriptions.remove(&amp;id);\n    }\n\n    fn publish(self, name: String, value: Arc&lt;CommandResponse&gt;) {\n        tokio::spawn(async move {\n            match self.topics.get(&amp;name) {\n                Some(chan) =&gt; {\n                    // å¤åˆ¶æ•´ä¸ª topic ä¸‹æ‰€æœ‰çš„ subscription id\n                    // è¿™é‡Œæˆ‘ä»¬æ¯ä¸ª id æ˜¯ u32ï¼Œå¦‚æœä¸€ä¸ª topic ä¸‹æœ‰ 10k è®¢é˜…ï¼Œå¤åˆ¶çš„æˆæœ¬\n                    // ä¹Ÿå°±æ˜¯ 40k å †å†…å­˜ï¼ˆå¤–åŠ ä¸€äº›æ§åˆ¶ç»“æ„ï¼‰ï¼Œæ‰€ä»¥æ•ˆç‡ä¸ç®—å·®\n                    // è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬ç”¨ NEXT_ID æ¥æ§åˆ¶ subscription id çš„ç”Ÿæˆ\n                    let chan = chan.value().clone();\n\n                    // å¾ªç¯å‘é€\n                    for id in chan.into_iter() {\n                        if let Some(tx) = self.subscriptions.get(&amp;id) {\n                            if let Err(e) = tx.send(value.clone()).await {\n                                warn!(\"Publish to {} failed! error: {:?}\", id, e);\n                            }\n                        }\n                    }\n                }\n                None =&gt; {}\n            }\n        });\n    }\n}\n</code></pre><p>è¿™æ®µä»£ç å°±æ˜¯ Pub/Sub çš„æ ¸å¿ƒåŠŸèƒ½äº†ã€‚ä½ å¯ä»¥å¯¹ç…§ç€ä¸Šé¢çš„è®¾è®¡å›¾å’Œä»£ç ä¸­çš„è¯¦ç»†æ³¨é‡Šå»ç†è§£ã€‚æˆ‘ä»¬æ¥å†™ä¸€ä¸ªæµ‹è¯•ç¡®ä¿å®ƒæ­£å¸¸å·¥ä½œï¼š</p><pre><code class=\"language-rust\">#[cfg(test)]\nmod tests {\n    use std::convert::TryInto;\n\n    use crate::assert_res_ok;\n\n    use super::*;\n\n    #[tokio::test]\n    async fn pub_sub_should_work() {\n        let b = Arc::new(Broadcaster::default());\n        let lobby = \"lobby\".to_string();\n\n        // subscribe\n        let mut stream1 = b.clone().subscribe(lobby.clone());\n        let mut stream2 = b.clone().subscribe(lobby.clone());\n\n        // publish\n        let v: Value = \"hello\".into();\n        b.clone().publish(lobby.clone(), Arc::new(v.clone().into()));\n\n        // subscribers åº”è¯¥èƒ½æ”¶åˆ° publish çš„æ•°æ®\n        let id1: i64 = stream1.recv().await.unwrap().as_ref().try_into().unwrap();\n        let id2: i64 = stream2.recv().await.unwrap().as_ref().try_into().unwrap();\n\n        assert!(id1 != id2);\n\n        let res1 = stream1.recv().await.unwrap();\n        let res2 = stream2.recv().await.unwrap();\n\n        assert_eq!(res1, res2);\n        assert_res_ok(&amp;res1, &amp;[v.clone()], &amp;[]);\n\n        // å¦‚æœ subscriber å–æ¶ˆè®¢é˜…ï¼Œåˆ™æ”¶ä¸åˆ°æ–°æ•°æ®\n        b.clone().unsubscribe(lobby.clone(), id1 as _);\n\n        // publish\n        let v: Value = \"world\".into();\n        b.clone().publish(lobby.clone(), Arc::new(v.clone().into()));\n\n        assert!(stream1.recv().await.is_none());\n        let res2 = stream2.recv().await.unwrap();\n        assert_res_ok(&amp;res2, &amp;[v.clone()], &amp;[]);\n    }\n}\n</code></pre><p>è¿™ä¸ªæµ‹è¯•éœ€è¦ä¸€ç³»åˆ—æ–°çš„æ”¹åŠ¨ï¼Œæ¯”å¦‚ assert_res_ok() çš„æ¥å£å˜åŒ–äº†ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ src/pb/mod.rs é‡Œæ·»åŠ æ–°çš„ TryFrom æ”¯æŒç­‰ç­‰ï¼Œè¯¦ç»†ä»£ç ä½ å¯ä»¥çœ‹ repo é‡Œçš„ diff_topicã€‚</p><h3>åœ¨å¤„ç†æµç¨‹ä¸­å¼•å…¥ Pub/Sub</h3><p>å¥½ï¼Œå†æ¥çœ‹å®ƒå’Œç”¨æˆ·ä¼ å…¥çš„ CommandRequest å¦‚ä½•å‘ç”Ÿå…³ç³»ã€‚æˆ‘ä»¬ä¹‹å‰è®¾è®¡äº† CommandService traitï¼Œå®ƒè™½ç„¶å¯ä»¥å¤„ç†å…¶å®ƒå‘½ä»¤ï¼Œä½†å¯¹ Pub/Sub ç›¸å…³çš„å‡ ä¸ªæ–°å‘½ä»¤æ— æ³•å¤„ç†ï¼Œå› ä¸ºæ¥å£æ²¡æœ‰ä»»ä½•å’Œ Topic æœ‰å…³çš„å‚æ•°ï¼š</p><pre><code class=\"language-rust\">/// å¯¹ Command çš„å¤„ç†çš„æŠ½è±¡\npub trait CommandService {\n    /// å¤„ç† Commandï¼Œè¿”å› Response\n    fn execute(self, store: &amp;impl Storage) -&gt; CommandResponse;\n}\n</code></pre><p>ä½†æ˜¯å¦‚æœç›´æ¥ä¿®æ”¹è¿™ä¸ªæ¥å£ï¼Œå¯¹å·²æœ‰çš„ä»£ç å°±éå¸¸ä¸å‹å¥½ã€‚æ‰€ä»¥æˆ‘ä»¬è¿˜æ˜¯å¯¹æ¯”ç€åˆ›å»ºä¸€ä¸ªæ–°çš„ traitï¼š</p><pre><code class=\"language-rust\">pub type StreamingResponse = Pin&lt;Box&lt;dyn Stream&lt;Item = Arc&lt;CommandResponse&gt;&gt; + Send&gt;&gt;;\npub trait TopicService {\n    /// å¤„ç† Commandï¼Œè¿”å› Response\n    fn execute&lt;T&gt;(self, chan: impl Topic) -&gt; StreamingResponse;\n}\n</code></pre><p>å› ä¸º Stream æ˜¯ä¸€ä¸ª traitï¼Œåœ¨ trait çš„æ–¹æ³•é‡Œæˆ‘ä»¬æ— æ³•è¿”å›ä¸€ä¸ª impl Streamï¼Œæ‰€ä»¥ç”¨ trait objectï¼š<code>Pin&lt;Box\\&lt;dyn Stream&gt;&gt;</code>ã€‚</p><p>å®ç°å®ƒå¾ˆç®€å•ï¼Œæˆ‘ä»¬åˆ›å»º src/service/topic_service.rsï¼ˆè®°å¾—åœ¨ <a href=\"http://mod.rs\">mod.rs</a> å¼•ç”¨ï¼‰ï¼Œç„¶åæ·»åŠ ï¼š</p><pre><code class=\"language-rust\">use futures::{stream, Stream};\nuse std::{pin::Pin, sync::Arc};\nuse tokio_stream::wrappers::ReceiverStream;\n\nuse crate::{CommandResponse, Publish, Subscribe, Topic, Unsubscribe};\n\npub type StreamingResponse = Pin&lt;Box&lt;dyn Stream&lt;Item = Arc&lt;CommandResponse&gt;&gt; + Send&gt;&gt;;\n\npub trait TopicService {\n    /// å¤„ç† Commandï¼Œè¿”å› Response\n    fn execute&lt;T, S&gt;(self, topic: impl Topic) -&gt; StreamingResponse;\n}\n\nimpl TopicService for Subscribe {\n    fn execute&lt;T, S&gt;(self, topic: impl Topic) -&gt; StreamingResponse {\n        let rx = topic.subscribe(self.topic);\n        Box::pin(ReceiverStream::new(rx))\n    }\n}\n\nimpl TopicService for Unsubscribe {\n    fn execute&lt;T, S&gt;(self, topic: impl Topic) -&gt; StreamingResponse {\n        topic.unsubscribe(self.topic, self.id);\n        Box::pin(stream::once(async { Arc::new(CommandResponse::ok()) }))\n    }\n}\n\nimpl TopicService for Publish {\n    fn execute&lt;T, S&gt;(self, topic: impl Topic) -&gt; StreamingResponse {\n        topic.publish(self.topic, Arc::new(self.data.into()));\n        Box::pin(stream::once(async { Arc::new(CommandResponse::ok()) }))\n    }\n}\n</code></pre><p>æˆ‘ä»¬ä½¿ç”¨äº† <a href=\"https://docs.rs/tokio-stream/0.1.7/tokio_stream/\">tokio-stream</a> çš„ wrapper æŠŠä¸€ä¸ª mpsc::Receiver è½¬æ¢æˆ ReceiverStreamã€‚è¿™æ · Subscribe çš„å¤„ç†å°±èƒ½è¿”å›ä¸€ä¸ª Streamã€‚å¯¹äº Unsubscribe å’Œ Publishï¼Œå®ƒä»¬éƒ½è¿”å›å•ä¸ªå€¼ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>stream::once</code> å°†å…¶ç»Ÿä¸€èµ·æ¥ã€‚</p><p>åŒæ ·åœ°ï¼Œè¦åœ¨ src/pb/mod.rs é‡Œæ·»åŠ ä¸€äº›æ–°çš„æ–¹æ³•ï¼Œæ¯”å¦‚ CommandResponse::ok()ï¼Œå®ƒè¿”å›ä¸€ä¸ªçŠ¶æ€ç æ˜¯ OK çš„ responseï¼š</p><pre><code class=\"language-rust\">impl CommandResponse {\n    pub fn ok() -&gt; Self {\n        let mut result = CommandResponse::default();\n        result.status = StatusCode::OK.as_u16() as _;\n        result\n    }\n}\n</code></pre><p>å¥½ï¼Œæ¥ä¸‹æ¥çœ‹ src/service/mod.rsï¼Œæˆ‘ä»¬å¯ä»¥å¯¹åº”ç€åŸæ¥çš„ dispatch åšä¸€ä¸ª dispatch_streamã€‚åŒæ ·åœ°ï¼Œå·²æœ‰çš„æ¥å£åº”è¯¥å°‘åŠ¨ï¼Œæˆ‘ä»¬å¹³è¡Œæ·»åŠ ä¸€ä¸ªæ–°çš„ï¼š</p><pre><code class=\"language-rust\">/// ä» Request ä¸­å¾—åˆ° Responseï¼Œç›®å‰å¤„ç†æ‰€æœ‰ HGET/HSET/HDEL/HEXIST\npub fn dispatch(cmd: CommandRequest, store: &amp;impl Storage) -&gt; CommandResponse {\n    match cmd.request_data {\n        Some(RequestData::Hget(param)) =&gt; param.execute(store),\n        Some(RequestData::Hgetall(param)) =&gt; param.execute(store),\n        Some(RequestData::Hmget(param)) =&gt; param.execute(store),\n        Some(RequestData::Hset(param)) =&gt; param.execute(store),\n        Some(RequestData::Hmset(param)) =&gt; param.execute(store),\n        Some(RequestData::Hdel(param)) =&gt; param.execute(store),\n        Some(RequestData::Hmdel(param)) =&gt; param.execute(store),\n        Some(RequestData::Hexist(param)) =&gt; param.execute(store),\n        Some(RequestData::Hmexist(param)) =&gt; param.execute(store),\n        None =&gt; KvError::InvalidCommand(\"Request has no data\".into()).into(),\n        // å¤„ç†ä¸äº†çš„è¿”å›ä¸€ä¸ªå•¥éƒ½ä¸åŒ…æ‹¬çš„ Responseï¼Œè¿™æ ·åç»­å¯ä»¥ç”¨ dispatch_stream å¤„ç†\n        _ =&gt; CommandResponse::default(),\n    }\n}\n\n/// ä» Request ä¸­å¾—åˆ° Responseï¼Œç›®å‰å¤„ç†æ‰€æœ‰ PUBLISH/SUBSCRIBE/UNSUBSCRIBE\npub fn dispatch_stream(cmd: CommandRequest, topic: impl Topic) -&gt; StreamingResponse {\n    match cmd.request_data {\n        Some(RequestData::Publish(param)) =&gt; param.execute(topic),\n        Some(RequestData::Subscribe(param)) =&gt; param.execute(topic),\n        Some(RequestData::Unsubscribe(param)) =&gt; param.execute(topic),\n        // å¦‚æœèµ°åˆ°è¿™é‡Œï¼Œå°±æ˜¯ä»£ç é€»è¾‘çš„é—®é¢˜ï¼Œç›´æ¥ crash å‡ºæ¥\n        _ =&gt; unreachable!(),\n    }\n}\n</code></pre><p>ä¸ºäº†ä½¿ç”¨è¿™ä¸ªæ–°çš„æ¥å£ï¼ŒService ç»“æ„ä¹Ÿéœ€è¦ç›¸åº”æ”¹åŠ¨ï¼š</p><pre><code class=\"language-rust\">/// Service æ•°æ®ç»“æ„\npub struct Service&lt;Store = MemTable&gt; {\n    inner: Arc&lt;ServiceInner&lt;Store&gt;&gt;,\n    broadcaster: Arc&lt;Broadcaster&gt;,\n}\n\nimpl&lt;Store&gt; Clone for Service&lt;Store&gt; {\n    fn clone(&amp;self) -&gt; Self {\n        Self {\n            inner: Arc::clone(&amp;self.inner),\n            broadcaster: Arc::clone(&amp;self.broadcaster),\n        }\n    }\n}\n\nimpl&lt;Store: Storage&gt; From&lt;ServiceInner&lt;Store&gt;&gt; for Service&lt;Store&gt; {\n    fn from(inner: ServiceInner&lt;Store&gt;) -&gt; Self {\n        Self {\n            inner: Arc::new(inner),\n            broadcaster: Default::default(),\n        }\n    }\n}\n\nimpl&lt;Store: Storage&gt; Service&lt;Store&gt; {\n    pub fn execute(&amp;self, cmd: CommandRequest) -&gt; StreamingResponse {\n        debug!(\"Got request: {:?}\", cmd);\n        self.inner.on_received.notify(&amp;cmd);\n        let mut res = dispatch(cmd, &amp;self.inner.store);\n\n        if res == CommandResponse::default() {\n            dispatch_stream(cmd, Arc::clone(&amp;self.broadcaster))\n        } else {\n            debug!(\"Executed response: {:?}\", res);\n            self.inner.on_executed.notify(&amp;res);\n            self.inner.on_before_send.notify(&amp;mut res);\n            if !self.inner.on_before_send.is_empty() {\n                debug!(\"Modified response: {:?}\", res);\n            }\n\n            Box::pin(stream::once(async { Arc::new(res) }))\n        }\n    }\n}\n</code></pre><p>è¿™é‡Œï¼Œä¸ºäº†å¤„ç† Pub/Subï¼Œæˆ‘ä»¬å¼•å…¥äº†ä¸€ä¸ªç ´åæ€§çš„æ›´æ–°ã€‚<strong>execute() æ–¹æ³•çš„è¿”å›å€¼å˜æˆäº† StreamingResponseï¼Œè¿™å°±æ„å‘³ç€æ‰€æœ‰å›´ç»•ç€è¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨ï¼ŒåŒ…æ‹¬æµ‹è¯•ï¼Œéƒ½éœ€è¦ç›¸åº”æ›´æ–°</strong>ã€‚è¿™æ˜¯è¿«ä¸å¾—å·²çš„ï¼Œä¸è¿‡é€šè¿‡æ„å»ºå’Œ CommandService  / dispatch å¹³è¡Œçš„ TopicService / dispatch_streamï¼Œæˆ‘ä»¬å·²ç»è®©è¿™ä¸ªç ´åæ€§æ›´æ–°å°½å¯èƒ½åœ°åœ¨æ¯”è¾ƒé«˜å±‚ï¼Œå¦åˆ™ï¼Œæ”¹åŠ¨ä¼šæ›´å¤§ã€‚</p><p>ç›®å‰ï¼Œä»£ç æ— æ³•ç¼–è¯‘é€šè¿‡ï¼Œè¿™æ˜¯å› ä¸ºå¦‚ä¸‹çš„ä»£ç ï¼Œres ç°åœ¨æ˜¯ä¸ª streamï¼Œæˆ‘ä»¬éœ€è¦å¤„ç†ä¸€ä¸‹ï¼š</p><pre><code class=\"language-rust\">let res = service.execute(CommandRequest::new_hget(\"t1\", \"k1\"));\nassert_res_ok(&amp;res, &amp;[\"v1\".into()], &amp;[]);\n\n// éœ€è¦å˜æ›´ä¸ºè¯»å– stream é‡Œçš„ä¸€ä¸ªå€¼\nlet res = service.execute(CommandRequest::new_hget(\"t1\", \"k1\"));\nlet data = res.next().await.unwrap();\nassert_res_ok(&amp;data, &amp;[\"v1\".into()], &amp;[]);\n</code></pre><p>å½“ç„¶ï¼Œè¿™æ ·çš„æ”¹åŠ¨ä¹Ÿæ„å‘³ç€ï¼ŒåŸæœ¬çš„å‡½æ•°éœ€è¦å˜æˆ asyncã€‚</p><p>å¦‚æœæ˜¯ä¸ª testï¼Œéœ€è¦ä½¿ç”¨ <code>#[tokio::test]</code>ã€‚ä½ å¯ä»¥è‡ªå·±è¯•ç€æŠŠæ‰€æœ‰ç›¸å…³çš„ä»£ç éƒ½æ”¹ä¸€ä¸‹ã€‚å½“ä½ æ”¹åˆ° src/network/mod.rs é‡Œ ProstServerStream çš„ process æ–¹æ³•æ—¶ï¼Œä¼šå‘ç° <code>stream.send(data)</code> æ—¶ï¼Œæˆ‘ä»¬ç›®å‰çš„ data æ˜¯ Arc&lt;CommandResponse&gt;ï¼š</p><pre><code class=\"language-rust\">impl&lt;S&gt; ProstServerStream&lt;S&gt;\nwhere\n    S: AsyncRead + AsyncWrite + Unpin + Send + 'static,\n{\n\t\t...\n\n    pub async fn process(mut self) -&gt; Result&lt;(), KvError&gt; {\n        let stream = &amp;mut self.inner;\n        while let Some(Ok(cmd)) = stream.next().await {\n            info!(\"Got a new command: {:?}\", cmd);\n            let mut res = self.service.execute(cmd);\n            while let Some(data) = res.next().await {\n\t\t\t\t\t\t\t\t// ç›®å‰ data æ˜¯ Arc&lt;CommandResponse&gt;ï¼Œ\n\t\t\t\t\t\t\t\t// æ‰€ä»¥æˆ‘ä»¬ send æœ€å¥½ç”¨ &amp;CommandResponse\n                stream.send(&amp;data).await.unwrap();\n            }\n        }\n        // info!(\"Client {:?} disconnected\", self.addr);\n        Ok(())\n    }\n}\n</code></pre><p>æ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦ç¨å¾®æ”¹åŠ¨ä¸€ä¸‹ src/network/stream.rsï¼š</p><pre><code class=\"language-rust\">// impl&lt;S, In, Out&gt; Sink&lt;Out&gt; for ProstStream&lt;S, In, Out&gt;\nimpl&lt;S, In, Out&gt; Sink&lt;&amp;Out&gt; for ProstStream&lt;S, In, Out&gt;\n</code></pre><p>è¿™ä¼šå¼•å‘ä¸€ç³»åˆ—çš„å˜åŠ¨ï¼Œä½ å¯ä»¥è¯•ç€è‡ªå·±æ”¹ä¸€ä¸‹ã€‚</p><p>å¦‚æœä½ æŠŠæ‰€æœ‰ç¼–è¯‘é”™è¯¯éƒ½æ”¹æ­£ï¼Œ<code>cargo test</code> ä¼šå…¨éƒ¨é€šè¿‡ã€‚ä½ ä¹Ÿå¯ä»¥çœ‹ repo é‡Œçš„ diff_serviceï¼Œçœ‹çœ‹æ‰€æœ‰æ”¹åŠ¨çš„ä»£ç ã€‚</p><h3>ç»§ç»­é‡æ„ï¼šå¼¥è¡¥è®¾è®¡ä¸Šçš„å°é—®é¢˜</h3><p>ç°åœ¨çœ‹ä¸Šå»å¤§åŠŸå‘Šæˆï¼Œä½†ä½ æœ‰æ²¡æœ‰æ³¨æ„ï¼Œæˆ‘ä»¬åœ¨æ’°å†™ src/service/topic_service.rs æ—¶ï¼Œæ²¡æœ‰å†™æµ‹è¯•ã€‚ä½ ä¹Ÿè®¸ä¼šè¯´ï¼šè¿™æ®µä»£ç å¦‚æ­¤ç®€å•ï¼Œè¿˜æœ‰å¿…è¦æµ‹è¯•ä¹ˆï¼Ÿ</p><p>è¿˜æ˜¯é‚£å¥è¯ï¼Œæµ‹è¯•æ˜¯ä½“éªŒå’Œæ„Ÿå—æ¥å£å®Œå¤‡æ€§çš„ä¸€ç§æ‰‹æ®µã€‚<strong>æµ‹è¯•å¹¶ä¸æ˜¯ä¸ºäº†æµ‹è¯•å®ç°æœ¬èº«ï¼Œè€Œæ˜¯çœ‹æ¥å£æ˜¯å¦å¥½ç”¨ï¼Œæ˜¯å¦é—æ¼äº†æŸäº›äº§å“éœ€æ±‚</strong>ã€‚</p><p>å½“å¼€å§‹å†™æµ‹è¯•çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±ä¼šæ€è€ƒï¼šunsubscribe æ¥å£å¦‚æœé‡åˆ°ä¸å­˜åœ¨çš„ subscriptionï¼Œè¦ä¸è¦è¿”å›ä¸€ä¸ª 404ï¼Ÿpublish çš„æ—¶å€™é‡åˆ°é”™è¯¯ï¼Œæ˜¯ä¸æ˜¯æ„å‘³ç€å®¢æˆ·ç«¯éæ­£å¸¸é€€å‡ºäº†ï¼Ÿæˆ‘ä»¬è¦ä¸è¦æŠŠå®ƒä» subscription ä¸­ç§»é™¤æ‰ï¼Ÿ</p><pre><code class=\"language-rust\">#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::{assert_res_error, assert_res_ok, dispatch_stream, Broadcaster, CommandRequest};\n    use futures::StreamExt;\n    use std::{convert::TryInto, time::Duration};\n    use tokio::time;\n\n    #[tokio::test]\n    async fn dispatch_publish_should_work() {\n        let topic = Arc::new(Broadcaster::default());\n        let cmd = CommandRequest::new_publish(\"lobby\", vec![\"hello\".into()]);\n        let mut res = dispatch_stream(cmd, topic);\n        let data = res.next().await.unwrap();\n        assert_res_ok(&amp;data, &amp;[], &amp;[]);\n    }\n\n    #[tokio::test]\n    async fn dispatch_subscribe_should_work() {\n        let topic = Arc::new(Broadcaster::default());\n        let cmd = CommandRequest::new_subscribe(\"lobby\");\n        let mut res = dispatch_stream(cmd, topic);\n        let id: i64 = res.next().await.unwrap().as_ref().try_into().unwrap();\n        assert!(id &gt; 0);\n    }\n\n    #[tokio::test]\n    async fn dispatch_subscribe_abnormal_quit_should_be_removed_on_next_publish() {\n        let topic = Arc::new(Broadcaster::default());\n        let id = {\n            let cmd = CommandRequest::new_subscribe(\"lobby\");\n            let mut res = dispatch_stream(cmd, topic.clone());\n            let id: i64 = res.next().await.unwrap().as_ref().try_into().unwrap();\n            drop(res);\n            id as u32\n        };\n\n        // publish æ—¶ï¼Œè¿™ä¸ª subscription å·²ç»å¤±æ•ˆï¼Œæ‰€ä»¥ä¼šè¢«åˆ é™¤\n        let cmd = CommandRequest::new_publish(\"lobby\", vec![\"hello\".into()]);\n        dispatch_stream(cmd, topic.clone());\n        time::sleep(Duration::from_millis(10)).await;\n\n        // å¦‚æœå†å°è¯•åˆ é™¤ï¼Œåº”è¯¥è¿”å› KvError\n        let result = topic.unsubscribe(\"lobby\".into(), id);\n        assert!(result.is_err());\n    }\n\n    #[tokio::test]\n    async fn dispatch_unsubscribe_should_work() {\n        let topic = Arc::new(Broadcaster::default());\n        let cmd = CommandRequest::new_subscribe(\"lobby\");\n        let mut res = dispatch_stream(cmd, topic.clone());\n        let id: i64 = res.next().await.unwrap().as_ref().try_into().unwrap();\n\n        let cmd = CommandRequest::new_unsubscribe(\"lobby\", id as _);\n        let mut res = dispatch_stream(cmd, topic);\n        let data = res.next().await.unwrap();\n\n        assert_res_ok(&amp;data, &amp;[], &amp;[]);\n    }\n\n    #[tokio::test]\n    async fn dispatch_unsubscribe_random_id_should_error() {\n        let topic = Arc::new(Broadcaster::default());\n\n        let cmd = CommandRequest::new_unsubscribe(\"lobby\", 9527);\n        let mut res = dispatch_stream(cmd, topic);\n        let data = res.next().await.unwrap();\n\n        assert_res_error(&amp;data, 404, \"Not found: subscription 9527\");\n    }\n}\n</code></pre><p>åœ¨æ’°å†™è¿™äº›æµ‹è¯•ï¼Œå¹¶è¯•å›¾ä½¿æµ‹è¯•é€šè¿‡çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬åˆè¿›ä¸€æ­¥é‡æ„äº†ä»£ç ã€‚å…·ä½“çš„ä»£ç å˜æ›´ï¼Œä½ å¯ä»¥å‚è€ƒ repo é‡Œçš„ diff_refactorã€‚</p><h3>è®©å®¢æˆ·ç«¯èƒ½æ›´å¥½åœ°ä½¿ç”¨æ–°çš„æ¥å£</h3><p>ç›®å‰ï¼Œæˆ‘ä»¬ ProstClientStream è¿˜æ˜¯ä¸€ä¸ªç»Ÿä¸€çš„ execute() æ–¹æ³•ï¼š</p><pre><code class=\"language-rust\">impl&lt;S&gt; ProstClientStream&lt;S&gt;\nwhere\n    S: AsyncRead + AsyncWrite + Unpin + Send,\n{\n\t  ...\n\n    pub async fn execute(&amp;mut self, cmd: CommandRequest) -&gt; Result&lt;CommandResponse, KvError&gt; {\n        let stream = &amp;mut self.inner;\n        stream.send(&amp;cmd).await?;\n\n        match stream.next().await {\n            Some(v) =&gt; v,\n            None =&gt; Err(KvError::Internal(\"Didn't get any response\".into())),\n        }\n    }\n}\n</code></pre><p>å®ƒå¹¶æ²¡æœ‰å¦¥å–„å¤„ç† SUBSCRIBEã€‚ä¸ºäº†æ”¯æŒ SUBSCRIBEï¼Œæˆ‘ä»¬éœ€è¦ä¸¤ä¸ªæ¥å£ï¼šexecute_unary å’Œ execute_streamingã€‚åœ¨ src/network/mod.rs ä¿®æ”¹è¿™ä¸ªä»£ç ï¼š</p><pre><code class=\"language-rust\">impl&lt;S&gt; ProstClientStream&lt;S&gt;\nwhere\n    S: AsyncRead + AsyncWrite + Unpin + Send + 'static,\n{\n    ...\n\n    pub async fn execute_unary(\n        &amp;mut self,\n        cmd: &amp;CommandRequest,\n    ) -&gt; Result&lt;CommandResponse, KvError&gt; {\n        let stream = &amp;mut self.inner;\n        stream.send(cmd).await?;\n\n        match stream.next().await {\n            Some(v) =&gt; v,\n            None =&gt; Err(KvError::Internal(\"Didn't get any response\".into())),\n        }\n    }\n\n    pub async fn execute_streaming(self, cmd: &amp;CommandRequest) -&gt; Result&lt;StreamResult, KvError&gt; {\n        let mut stream = self.inner;\n\n        stream.send(cmd).await?;\n        stream.close().await?;\n\n        StreamResult::new(stream).await\n    }\n}\n</code></pre><p>æ³¨æ„ï¼Œå› ä¸º execute_streaming é‡Œè¿”å› Box:pin(stream)ï¼Œæˆ‘ä»¬éœ€è¦å¯¹ ProstClientStream çš„ S é™åˆ¶æ˜¯ 'staticï¼Œå¦åˆ™ç¼–è¯‘å™¨ä¼šæŠ±æ€¨ã€‚è¿™ä¸ªæ”¹åŠ¨ä¼šå¯¼è‡´ä½¿ç”¨ execute() æ–¹æ³•çš„æµ‹è¯•éƒ½æ— æ³•ç¼–è¯‘ï¼Œä½ å¯ä»¥è¯•ç€ä¿®æ”¹æ‰å®ƒä»¬ã€‚</p><p>æ­¤å¤–æˆ‘ä»¬è¿˜åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„æ–‡ä»¶ src/network/stream_result.rsï¼Œç”¨æ¥å¸®åŠ©å®¢æˆ·ç«¯æ›´å¥½åœ°ä½¿ç”¨ execute_streaming() æ¥å£ã€‚æ‰€æœ‰æ”¹åŠ¨çš„å…·ä½“ä»£ç å¯ä»¥çœ‹ repo ä¸­çš„ diff_clientã€‚</p><p>ç°åœ¨ï¼Œä»£ç ä¸€åˆ‡å°±ç»ªã€‚æ‰“å¼€ä¸€ä¸ªå‘½ä»¤è¡Œçª—å£ï¼Œè¿è¡Œï¼š<code>RUST_LOG=info cargo run --bin kvs --quietï¼Œ</code>ç„¶ååœ¨å¦ä¸€ä¸ªå‘½ä»¤è¡Œçª—å£ï¼Œè¿è¡Œï¼š<code>RUST_LOG=info cargo run --bin kvc --quiet</code>ã€‚</p><p>æ­¤æ—¶ï¼ŒæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯éƒ½æ”¶åˆ°äº†å½¼æ­¤çš„è¯·æ±‚å’Œå“åº”ï¼Œå³ä¾¿æ··åˆ HSET/HGET å’Œ PUBLISH/SUBSCRIBE å‘½ä»¤ï¼Œä¸€åˆ‡éƒ½ä¾æ—§å¤„ç†æ­£å¸¸ï¼ä»Šå¤©æˆ‘ä»¬åšäº†ä¸€ä¸ªæ¯”è¾ƒå¤§çš„é‡æ„ï¼Œä½†æ¯”é¢„æƒ³ä¸­å¯¹åŸæœ‰ä»£ç çš„æ”¹åŠ¨è¦å°ï¼Œè¿™ç®€ç›´å¤ªæ£’äº†ï¼</p><h2>å°ç»“</h2><p>å½“ä¸€ä¸ªé¡¹ç›®è¶Šæ¥è¶Šå¤æ‚ï¼Œä¸”æ–°åŠ çš„åŠŸèƒ½å¹¶ä¸èƒ½å¾ˆå¥½åœ°èå…¥å·²æœ‰çš„ç³»ç»Ÿæ—¶ï¼Œå¤§çš„é‡æ„æ˜¯ä¸å¯é¿å…çš„ã€‚åœ¨é‡æ„çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸€å®šè¦é¦–å…ˆè¦å¼„æ¸…æ¥šç°æœ‰çš„æµç¨‹å’Œæ¶æ„ï¼Œç„¶åå†æ€è€ƒå¦‚ä½•é‡æ„ï¼Œè¿™æ ·å¯¹ç³»ç»Ÿçš„ä¾µå…¥æ‰æ˜¯æœ€å°çš„ã€‚</p><p>é‡æ„ä¸€èˆ¬ä¼šå¸¦æ¥å¯¹ç°æœ‰æµ‹è¯•çš„ç ´åï¼Œåœ¨ä¿®å¤è¢«ç ´åçš„æµ‹è¯•æ—¶ï¼Œæˆ‘ä»¬è¦æ³¨æ„ä¸è¦å˜åŠ¨åŸæœ‰æµ‹è¯•çš„é€»è¾‘ã€‚åœ¨åšå› ä¸ºæ–°åŠŸèƒ½æ·»åŠ å¯¼è‡´çš„é‡æ„æ—¶ï¼Œå¦‚æœä¼´éšç€å¤§é‡æµ‹è¯•çš„åˆ é™¤å’Œå¤§é‡æ–°æµ‹è¯•çš„æ·»åŠ ï¼Œé‚£ä¹ˆï¼Œè¯´æ˜è¦ä¹ˆåŸæ¥çš„æµ‹è¯•å†™å¾—å¾ˆæœ‰é—®é¢˜ï¼Œè¦ä¹ˆé‡æ„å¯¹åŸæœ‰ç³»ç»Ÿçš„ä¾µå…¥æ€§å¤ªå¼ºã€‚æˆ‘ä»¬è¦å°½é‡é¿å…è¿™ç§äº‹æƒ…å‘ç”Ÿã€‚</p><p><strong>åœ¨æ¶æ„å’Œè®¾è®¡éƒ½ç›¸å¯¹ä¸é”™çš„æƒ…å†µä¸‹ï¼Œæ’°å†™ä»£ç çš„ç»ˆæç›®æ ‡æ˜¯å¯¹ä½¿ç”¨è€…å‹å¥½çš„æŠ½è±¡</strong>ã€‚æ‰€è°“å¯¹ä½¿ç”¨è€…å‹å¥½çš„æŠ½è±¡ï¼Œæ˜¯æŒ‡è®©åˆ«äººè°ƒç”¨æˆ‘ä»¬å†™çš„æ¥å£æ—¶ï¼Œä¸ç”¨æƒ³å¤ªå¤šï¼Œæ¥å£æœ¬èº«å°±æ˜¯è‡ªè§£é‡Šçš„ã€‚</p><p>å¦‚æœä½ ä»”ç»†é˜…è¯» diff_clientï¼Œå¯ä»¥çœ‹åˆ°ç±»ä¼¼ StreamResult è¿™æ ·çš„æŠ½è±¡ã€‚å®ƒé¿å…äº†è°ƒç”¨è€…éœ€è¦äº†è§£å¦‚ä½•æ‰‹å·¥ä» Stream ä¸­å–ç¬¬ä¸€ä¸ªå€¼ä½œä¸º subscription_id è¿™æ ·çš„å®ç°ç»†èŠ‚ï¼Œç›´æ¥æ›¿è°ƒç”¨è€…å®Œæˆäº†è¿™ä¸ªå·¥ä½œï¼Œå¹¶ä»¥ä¸€ä¸ªä¼˜é›…çš„ ID æš´éœ²ç»™è°ƒç”¨è€…ã€‚</p><p>ä½ å¯ä»¥ä»”ç»†é˜…è¯»è¿™ä¸€è®²ä¸­çš„ä»£ç ï¼Œå¥½å¥½å“å‘³è¿™äº›æ¥å£çš„è®¾è®¡ã€‚å®ƒä»¬å¹¶éå®Œç¾ï¼Œä¸–ä¸Šæ²¡æœ‰å®Œç¾çš„ä»£ç ï¼Œåªæœ‰ä¸æ–­å®Œå–„çš„ä»£ç ã€‚å¦‚æœæŠŠä¸€è¡Œè¡Œä»£ç æ¯”ä½œä¸€æ®µæ®µæ–‡å­—ï¼Œèµ·ç å®ƒä»¬éƒ½éœ€è¦åŠªåŠ›åœ°æ¨æ•²å’Œä¸æ–­åœ°è¿­ä»£ã€‚</p><h3>æ€è€ƒé¢˜</h3><ol>\n<li>ç°åœ¨æˆ‘ä»¬çš„ç³»ç»Ÿå¯¹ Pub/Sub å·²ç»æœ‰æ¯”è¾ƒå®Œæ•´çš„æ”¯æŒï¼Œä½†ä½ æœ‰æ²¡æœ‰æ³¨æ„åˆ°ï¼Œæœ‰ä¸€ä¸ªæ½œåœ¨çš„å†…å­˜æ³„æ¼çš„ bugã€‚å¦‚æœå®¢æˆ·ç«¯ A subscribe äº† Topic Mï¼Œä½†å®¢æˆ·ç«¯æ„å¤–ç»ˆæ­¢ï¼Œä¸”éšåä¹Ÿæ²¡æœ‰ä»»ä½•äººå¾€ Topic M publish æ¶ˆæ¯ã€‚è¿™æ ·ï¼ŒA çš„ subscription å°±ä¸€ç›´æ”¾åœ¨è¡¨ä¸­ã€‚ä½ èƒ½åšä¸€ä¸ª GC æ¥å¤„ç†è¿™ç§æƒ…å†µä¹ˆï¼Ÿ</li>\n<li>Redis è¿˜æ”¯æŒ PSUBSCRIBEï¼Œä¹Ÿå°±æ˜¯è¯´é™¤äº†å¯ä»¥ subscribe â€œchatâ€ è¿™æ ·å›ºå®šçš„ topicï¼Œè¿˜å¯ä»¥æ˜¯ â€œchat.*â€ï¼Œä¸€å¹¶è®¢é˜…æ‰€æœ‰ â€œchatâ€ã€â€œchat.rustâ€ã€â€œchat.elixirâ€ ã€‚æƒ³æƒ³çœ‹ï¼Œå¦‚æœè¦æ”¯æŒ PSUBSCRIBEï¼Œä½ è¯¥æ€ä¹ˆè®¾è®¡ Broadcaster é‡Œçš„ä¸¤å¼ è¡¨ï¼Ÿ</li>\n</ol><p>æ¬¢è¿åœ¨ç•™è¨€åŒºåˆ†äº«ä½ çš„æ€è€ƒå’Œå­¦ä¹ æ„Ÿæ‚Ÿã€‚æ„Ÿè°¢ä½ çš„æ”¶å¬ï¼Œå¦‚æœè§‰å¾—æœ‰æ”¶è·ï¼Œä¹Ÿæ¬¢è¿åˆ†äº«ç»™ä½ èº«è¾¹çš„æœ‹å‹ï¼Œé‚€ä»–ä¸€èµ·è®¨è®ºã€‚æ­å–œä½ å®Œæˆäº†Rustå­¦ä¹ çš„ç¬¬42æ¬¡æ‰“å¡ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ã€‚</p>","comments":[{"had_liked":false,"id":324929,"user_name":"yyxxccc","can_delete":false,"product_type":"c1","uid":2759441,"ip_address":"","ucode":"BEC53F4F4922B8","user_header":"https://static001.geekbang.org/account/avatar/00/2a/1b/11/5e235665.jpg","comment_is_top":false,"comment_ctime":1638721374,"is_pvip":false,"replies":[{"id":"118855","content":"åœ¨åšæ–°åŠŸèƒ½æ—¶ï¼ŒåŒæ—¶æ¶‰åŠåˆ°çš„è€ç³»ç»Ÿçš„æ¨¡å—ä¸€ä¸ªä¸ªæ„å»ºå•å…ƒæµ‹è¯•ï¼Œç„¶åå†åœ¨å…¶ä¸Šå¼€å‘æ–°åŠŸèƒ½ï¼ˆä»¥åŠé€‚å½“çš„é‡æ„ï¼‰ï¼Œæ–°åŠŸèƒ½å¿…é¡»è¦æœ‰æ›´ä¸¥æ ¼çš„å•å…ƒæµ‹è¯•ã€‚è¿™æ ·è¿ä½œä¸€ä¸¤å¹´ï¼Œè€ç³»ç»Ÿçš„å•å…ƒæµ‹è¯•å°±é€æ¸è¡¥é½äº†ã€‚ä¸è¦è¯•å›¾ä¸€ä¸‹å­æŠŠè€ç³»ç»Ÿæ‰€æœ‰ç¼ºå¤±çš„å•å…ƒæµ‹è¯•éƒ½è¡¥é½ï¼Œå¾€å¾€è¿™æ ·çš„å·¥ä½œä¼šè¢«å† ä»¥ä¼˜å…ˆçº§ä¸é«˜è€Œè™å¤´è›‡å°¾ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1079375","ctime":1639847945,"ip_address":"","comment_id":324929,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14523623262","product_id":100085301,"comment_content":"å¾ˆå¤šæ—¶å€™ï¼Œå®é™…å·¥ä½œä¿®æ”¹è€ç³»ç»Ÿï¼Œè€ç³»ç»Ÿå•¥å•å…ƒæµ‹è¯•å•¥çš„éƒ½æ²¡æœ‰ğŸ˜‚ï¼ŒæœçœŸæ˜¯åŠ¨ä¸€è¡Œï¼Œå°±æ˜¯ç‰µä¸€å‘è€ŒåŠ¨å…¨èº«ï¼Œè¿™æ–¹é¢è€å¸ˆæœ‰ä»€ä¹ˆæŒ‡å¯¼æ€§åŸåˆ™ä¹ˆã€‚","like_count":3,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539815,"discussion_content":"åœ¨åšæ–°åŠŸèƒ½æ—¶ï¼ŒåŒæ—¶æ¶‰åŠåˆ°çš„è€ç³»ç»Ÿçš„æ¨¡å—ä¸€ä¸ªä¸ªæ„å»ºå•å…ƒæµ‹è¯•ï¼Œç„¶åå†åœ¨å…¶ä¸Šå¼€å‘æ–°åŠŸèƒ½ï¼ˆä»¥åŠé€‚å½“çš„é‡æ„ï¼‰ï¼Œæ–°åŠŸèƒ½å¿…é¡»è¦æœ‰æ›´ä¸¥æ ¼çš„å•å…ƒæµ‹è¯•ã€‚è¿™æ ·è¿ä½œä¸€ä¸¤å¹´ï¼Œè€ç³»ç»Ÿçš„å•å…ƒæµ‹è¯•å°±é€æ¸è¡¥é½äº†ã€‚ä¸è¦è¯•å›¾ä¸€ä¸‹å­æŠŠè€ç³»ç»Ÿæ‰€æœ‰ç¼ºå¤±çš„å•å…ƒæµ‹è¯•éƒ½è¡¥é½ï¼Œå¾€å¾€è¿™æ ·çš„å·¥ä½œä¼šè¢«å† ä»¥ä¼˜å…ˆçº§ä¸é«˜è€Œè™å¤´è›‡å°¾ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639847945,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":325616,"user_name":"ç½—åŒå­¦","can_delete":false,"product_type":"c1","uid":1649119,"ip_address":"","ucode":"909B9EC768B9AD","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/vHujib2CCrUYNBaia32eIwTyJoAcl27vASZ9KGjSdnH1dJhD7CrSUicBib19Tf8nDibWaHjzIsvIfdqcXX6vGrH8bicw/132","comment_is_top":false,"comment_ctime":1639044079,"is_pvip":false,"replies":[{"id":"118823","content":"yamux æ˜¯ä¸€ä¸ªå…·ä½“çš„ç½‘ç»œåè®®ï¼Œå®ƒåœ¨ TCP ä¹‹ä¸Šå¯ä»¥è¿è¡Œå¤šä¸ªäº’ä¸å¹²æ‰°çš„ streamï¼ˆå°±åƒ HTTP&#47;2ï¼‰ï¼›tokio æ˜¯ä¸€ä¸ªå¼‚æ­¥è¿è¡Œæ—¶ï¼Œå¯ä»¥åœ¨ N ä¸ªçº¿ç¨‹ä¸Šè·‘ M ä¸ª tokio taskã€‚æˆ‘ä»¬åˆ©ç”¨ tokio çš„å¼‚æ­¥èƒ½åŠ›æ¥æ‰¿è½½ Yamux åè®®ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1079375","ctime":1639805793,"ip_address":"","comment_id":325616,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10228978671","product_id":100085301,"comment_content":"æˆ‘æœ‰ä¸ªç–‘é—®, tokio æœ¬èº«ä¸å°±æ˜¯ æ”¯æŒäº†å¤šè·¯å¤ç”¨å—<br>ç”¨ yamuxæ¥æ•´åˆå¤šè·¯å¤ç”¨çš„æ„ä¹‰æ˜¯ä»€ä¹ˆ?","like_count":2,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539699,"discussion_content":"yamux æ˜¯ä¸€ä¸ªå…·ä½“çš„ç½‘ç»œåè®®ï¼Œå®ƒåœ¨ TCP ä¹‹ä¸Šå¯ä»¥è¿è¡Œå¤šä¸ªäº’ä¸å¹²æ‰°çš„ streamï¼ˆå°±åƒ HTTP/2ï¼‰ï¼›tokio æ˜¯ä¸€ä¸ªå¼‚æ­¥è¿è¡Œæ—¶ï¼Œå¯ä»¥åœ¨ N ä¸ªçº¿ç¨‹ä¸Šè·‘ M ä¸ª tokio taskã€‚æˆ‘ä»¬åˆ©ç”¨ tokio çš„å¼‚æ­¥èƒ½åŠ›æ¥æ‰¿è½½ Yamux åè®®ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639805793,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":360376,"user_name":"è¿›å‡»çš„Lancelot","can_delete":false,"product_type":"c1","uid":2620407,"ip_address":"å¹¿ä¸œ","ucode":"3BCC355801DC61","user_header":"https://static001.geekbang.org/account/avatar/00/27/fb/f7/88ab6f83.jpg","comment_is_top":false,"comment_ctime":1666518698,"is_pvip":true,"discussion_count":0,"race_medal":1,"score":"1666518698","product_id":100085301,"comment_content":"æ€è€ƒé¢˜1: ä¸»è¦è€ƒè™‘å¦‚ä½•æ£€æµ‹ receiver è¢« drop çš„æƒ…å†µä»¥åŠä½•æ—¶è§¦å‘ gc æ“ä½œï¼›å¯¹äºå¦‚ä½•æ£€æµ‹ channel è¢«å…³é—­æœ‰ä¸¤ç§æ–¹å¼ï¼š<br>1. æ¯ä¸ª sender å‘ä¸€æ¬¡æ¶ˆæ¯ä¾¿å¯çŸ¥é“ï¼Œè¿™ç§æ–¹æ³•ä½æ•ˆï¼Œè€Œä¸”ä¸€æ–¹é¢éœ€è¦è€ƒè™‘ç”¨äºæ£€æµ‹çš„æ¶ˆæ¯ä¸èƒ½å’Œç”¨æˆ·å¯èƒ½å‘é€çš„æ¶ˆæ¯å‡ºç°é‡åˆï¼Œå¦ä¸€æ–¹é¢å‘é€å‡ºå»çš„æ¶ˆæ¯è¿˜å¯èƒ½ä¼šè¢«ç”¨æˆ·çœ‹åˆ°ï¼Œä¸è€ƒè™‘è¿™ç§æ–¹å¼<br>2. tokio::mpsc::sender æä¾›äº† is_closed æ–¹æ³•æ¥åˆ¤æ–­ channel æ˜¯å¦å…³é—­ï¼Œç®€å•é«˜æ•ˆã€‚å¦‚æœä½¿ç”¨çš„ channel æ²¡æœ‰æä¾›è¿™ä¸ªæ–¹æ³•ï¼Œå¯ä»¥è€ƒè™‘ä»¿ç…§ç¬¬ 35 è®²ä¸­çš„ channel çš„å®ç°ï¼Œå¯¹ channel è¿›è¡ŒåŒ…è£…å¹¶å¢åŠ ä¸€ä¸ªåŸå­è®¡æ•°æ¥åˆ¤æ–­ receiver çš„æ•°é‡<br>æœ‰äº†æ£€æµ‹æ–¹å¼ï¼Œæ¥ä¸‹æ¥å°±æ˜¯è€ƒè™‘è§¦å‘æ—¶æœºï¼Œè€ƒè™‘åˆ°å¹¶å‘æƒ…å†µä¸‹ï¼Œè®¿é—® subscriptions ä¼šæœ‰é”çš„é—®é¢˜ï¼Œè€Œä¸”è¿™ç§æƒ…å†µä¸ä¼šå¤ªé¢‘ç¹ï¼Œå› æ­¤å¯ä»¥æ”¾åœ¨ unsubscribe çš„æ—¶å€™è¿›è¡Œæ£€æŸ¥å’Œæ¸…ç†ã€‚<br><br>æ€è€ƒé¢˜2ï¼šå¦‚æœè¦æä¾› PSUBSCRIBE åŠŸèƒ½ï¼Œè€ƒè™‘å¢åŠ ä¸€å¼  patter è¡¨ï¼ŒæŒ‰ç…§ glob::Pattern æ¥åŒ¹é…ï¼Œåˆ™è¡¨çš„å½¢å¼ä¸º patterns: DashMap&lt;Pattern, DashSet&lt;u32&gt;&gt;ï¼Œå…¶ä¸­ DashSet ç”¨äºä¿å­˜ subscription idã€‚åœ¨ publish æ—¶å€™ï¼Œéå† patterns å¹¶äº channel è¿›è¡ŒåŒ¹é…ï¼ŒåŒ¹é…æˆåŠŸåˆ™å–å‡º subscription id å¹¶å‘é€ä¸€æ¡æ¶ˆæ¯ã€‚<br><br>æ€è€ƒé¢˜çš„å®Œæ•´å®ç°å¯ä»¥å‚è€ƒï¼šhttps:&#47;&#47;github.com&#47;Phoenix500526&#47;simple_kv&#47;blob&#47;main&#47;src&#47;service&#47;topic.rs","like_count":0},{"had_liked":false,"id":355692,"user_name":"Geek_aa1610","can_delete":false,"product_type":"c1","uid":1129834,"ip_address":"æµ™æ±Ÿ","ucode":"C366F62437D81C","user_header":"https://static001.geekbang.org/account/avatar/00/11/3d/6a/70636993.jpg","comment_is_top":false,"comment_ctime":1661659283,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1661659283","product_id":100085301,"comment_content":"æœ‰ä¸€ä¸ªé—®é¢˜, å‡è®¾ä¸€ä¸ªclient subäº†å¾ˆå¤štopic (åŒæ—¶æœ‰å…¶ä»–clientåœ¨è¿™äº›topicä¸Šåšpublish) subçš„clientç«¯å¦‚ä½•åŒºåˆ†ä¸€æ¬¡responseæ˜¯ä¸Šä¸€æ¬¡subçš„CommnadResponse::okè¿˜æ˜¯ä¹‹å‰æŸæ¬¡subçš„topicä¸Špushæ¥çš„æ–°å†…å®¹?","like_count":0},{"had_liked":false,"id":354115,"user_name":"é˜³é˜³","can_delete":false,"product_type":"c1","uid":2716386,"ip_address":"åŒ—äº¬","ucode":"5E61EF18F08DF2","user_header":"https://static001.geekbang.org/account/avatar/00/29/72/e2/9a19b202.jpg","comment_is_top":false,"comment_ctime":1660102444,"is_pvip":false,"discussion_count":0,"race_medal":2,"score":"1660102444","product_id":100085301,"comment_content":"äºŒåˆ·ï¼Œç»ˆäºè·Ÿç€æŠŠä»£ç å†™ä¸‹æ¥äº†","like_count":0},{"had_liked":false,"id":326817,"user_name":"ç½—åŒå­¦","can_delete":false,"product_type":"c1","uid":1649119,"ip_address":"","ucode":"909B9EC768B9AD","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/vHujib2CCrUYNBaia32eIwTyJoAcl27vASZ9KGjSdnH1dJhD7CrSUicBib19Tf8nDibWaHjzIsvIfdqcXX6vGrH8bicw/132","comment_is_top":false,"comment_ctime":1639709503,"is_pvip":false,"replies":[{"id":"118775","content":"yamux æ˜¯ä¸ªåè®®ï¼Œæ¯”å¦‚ä½ å¯ä»¥ç”¨ nodejs client, python client è®¿é—®ã€‚ä½ å½“ç„¶éœ€è¦ä½¿ç”¨æ”¯æŒ yamux åè®®çš„åº“ï¼Œæ¯”å¦‚ https:&#47;&#47;www.npmjs.com&#47;package&#47;yamux-jsã€‚è¿™å°±è·Ÿä½ è¦è®¿é—® http serverï¼Œéœ€è¦ç¬¦åˆåè®®è§„èŒƒçš„ http client ä¸€æ ·ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1079375","ctime":1639792136,"ip_address":"","comment_id":326817,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1639709503","product_id":100085301,"comment_content":"æˆ‘ç°åœ¨æœ‰ä¸ªå›°æƒ‘  è¿™å‡ å¤©ä¸€ç›´æ²¡æƒ³åˆ°ç­”æ¡ˆ<br>æ¯”å¦‚è€å¸ˆè¯´çš„yamux æ¥åšè¿æ¥çš„å¤šè·¯å¤ç”¨<br>å¦‚æœå®¢æˆ·ç«¯ä¸èƒ½ç”¨rust æœ‰åŠæ³•å¯¹æ¥å—?<br>æˆ‘è¯•äº†ä¸€ä¸‹ å¦‚æœæœåŠ¡å™¨yamux è¿‡çš„æœåŠ¡<br>å¯¹æ–¹å¦‚æœä¸æ˜¯yamuxåŒ…è£…çš„ è¯·æ±‚ ä¼šæŠ¥é”™ å°±æ˜¯ä¸èƒ½å½“æˆå¸¸è§„çš„tcpè¿æ¥æ¥å¤„ç†","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539624,"discussion_content":"yamux æ˜¯ä¸ªåè®®ï¼Œæ¯”å¦‚ä½ å¯ä»¥ç”¨ nodejs client, python client è®¿é—®ã€‚ä½ å½“ç„¶éœ€è¦ä½¿ç”¨æ”¯æŒ yamux åè®®çš„åº“ï¼Œæ¯”å¦‚ https://www.npmjs.com/package/yamux-jsã€‚è¿™å°±è·Ÿä½ è¦è®¿é—® http serverï¼Œéœ€è¦ç¬¦åˆåè®®è§„èŒƒçš„ http client ä¸€æ ·ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639792136,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":325038,"user_name":"ç½—æ°","can_delete":false,"product_type":"c1","uid":1320487,"ip_address":"","ucode":"96BAFAA147341F","user_header":"https://static001.geekbang.org/account/avatar/00/14/26/27/eba94899.jpg","comment_is_top":false,"comment_ctime":1638784081,"is_pvip":false,"replies":[{"id":"118854","content":"å—¯","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1079375","ctime":1639847690,"ip_address":"","comment_id":325038,"utype":1}],"discussion_count":1,"race_medal":2,"score":"1638784081","product_id":100085301,"comment_content":"å†™æµ‹è¯•ä»£ç çš„ç¡®æœ‰åŠ©äºæˆ‘ä»¬æ€è€ƒï¼Œä»è€ŒæŠŠä»£ç å†™çš„æ›´å¥½ã€‚","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539814,"discussion_content":"å—¯","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639847691,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}