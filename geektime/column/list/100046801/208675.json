{"id":208675,"title":"06 | 如何用Elasticsearch构建商品搜索系统？","content":"<p>你好，我是李玥。</p><p>搜索这个特性可以说是无处不在，现在很少有网站或者系统不提供搜索功能了，所以，即使你不是一个专业做搜索的程序员，也难免会遇到一些搜索相关的需求。搜索这个东西，表面上看功能很简单，就是一个搜索框，输入关键字，然后搜出来想要的内容就好了。</p><p>搜索背后的实现，可以非常简单，简单到什么程度呢？我们就用一个SQL，LIKE一下就能实现；也可以很复杂，复杂到什么程度呢？不说百度谷歌这种专业做搜索的公司，其他非专业做搜索的互联网大厂，搜索团队大多是千人规模，这里面不仅有程序员，还有算法工程师、业务专家等等。二者的区别也仅仅是，搜索速度的快慢以及搜出来的内容好坏而已。</p><p>今天这节课，我们就以电商中的商品搜索作为例子，来讲一下，如何用ES(Elasticsearch)来快速、低成本地构建一个体验还不错的搜索系统。</p><h2>理解倒排索引机制</h2><p>刚刚我们说了，既然我们的数据大多都是存在数据库里，用SQL的LIKE也能实现匹配，也能搜出结果，为什么还要专门做一套搜索系统呢？我先来和你分析一下，为什么数据库不适合做搜索。</p><p>搜索的核心需求是全文匹配，对于全文匹配，数据库的索引是根本派不上用场的，那只能全表扫描。全表扫描已经非常慢了，这还不算，还需要在每条记录上做全文匹配，也就是一个字一个字的比对，这个速度就更慢了。所以，使用数据来做搜索，性能上完全没法满足要求。</p><!-- [[[read_end]]] --><p>那ES是怎么来解决搜索问题的呢？我们来举个例子说明一下，假设我们有这样两个商品，一个是烟台红富士苹果，一个是苹果手机iPhone XS Max。</p><p><img src=\"https://static001.geekbang.org/resource/image/28/0a/28a9b198c9b10a3b4d50a77d8fea6c0a.jpg?wh=4266*1233\" alt=\"\"></p><p>这个表里面的DOCID就是唯一标识一条记录的ID，和数据库里面的主键是类似的。</p><p>为了能够支持快速地全文搜索，ES中对于文本采用了一种特殊的索引：倒排索引（Inverted Index）。那我们看一下在ES中，这两条商品数据倒排索引长什么样？请看下面这个表。</p><p><img src=\"https://static001.geekbang.org/resource/image/6f/1c/6fcdd7e10c3e72b2abe635c8a5a6ff1c.jpg?wh=4266*2734\" alt=\"\"></p><p>可以看到，这个倒排索引的表，它是以单词作为索引的Key，然后每个单词的倒排索引的值是一个列表，这个列表的元素就是含有这个单词的商品记录的DOCID。</p><p>这个倒排索引怎么构建的呢？当我们往ES写入商品记录的时候，ES会先对需要搜索的字段，也就是商品标题进行<strong>分词</strong>。分词就是把一段连续的文本按照语义拆分成多个单词。然后ES按照单词来给商品记录做索引，就形成了上面那个表一样的倒排索引。</p><p>当我们搜索关键字“苹果手机”的时候，ES会对关键字也进行分词，比如说，“苹果手机”被分为“苹果”和“手机”。然后，ES会在倒排索引中去搜索我们输入的每个关键字分词，搜索结果应该是：</p><p><img src=\"https://static001.geekbang.org/resource/image/71/c2/7191b2ba0e28d8b7db9871213664a6c2.jpg?wh=4266*607\" alt=\"\"></p><p>666和888这两条记录都能匹配上搜索的关键词，但是888这个商品比666这个商品匹配度更高，因为它两个单词都能匹配上，所以按照匹配度把结果做一个排序，最终返回的搜索结果就是：</p><blockquote>\n<p><strong>苹果</strong>Apple iPhone XS Max (A2104) 256GB 金色 移动联通电信4G<strong>手机</strong>双卡双待</p>\n</blockquote><blockquote>\n<p>烟台红富士<strong>苹果</strong>5kg 一级铂金大果 单果230g以上 新鲜水果</p>\n</blockquote><p>看起来搜索的效果还是不错的。</p><p>为什么倒排索引可以做到快速搜索？我和你一起来分析一下上面这个例子的查找性能。</p><p>这个搜索过程，其实就是对上面的倒排索引做了二次查找，一次找“苹果”，一次找“手机”。<strong>注意，整个搜索过程中，我们没有做过任何文本的模糊匹配</strong>。ES的存储引擎存储倒排索引时，肯定不是像我们上面表格中展示那样存成一个二维表，实际上它的物理存储结构和MySQL的InnoDB的索引是差不多的，都是一颗查找树。</p><p>对倒排索引做两次查找，也就是对树进行二次查找，它的时间复杂度，类似于MySQL中的二次命中索引的查找。显然，这个查找速度，比用MySQL全表扫描加上模糊匹配的方式，要快好几个数量级。</p><h2>如何在ES中构建商品的索引?</h2><p>理解了倒排索引的原理之后，我们一起用ES构建一个商品索引，简单实现一个商品搜索系统。虽然ES是为搜索而生的，但本质上，它仍然是一个存储系统。ES里面的一些概念，基本上都可以在关系数据库中找到对应的名词，为了便于你快速理解这些概念，我把这些概念的对应关系列出来，你可以对照理解。</p><p><img src=\"https://static001.geekbang.org/resource/image/cd/df/cdbfcc01166ad3a1fd2a12791d0079df.jpg?wh=4266*1024\" alt=\"\"></p><p>在ES里面，数据的逻辑结构类似于MongoDB，每条数据称为一个<strong>DOCUMENT</strong>，简称DOC。DOC就是一个JSON对象，DOC中的每个JSON字段，在ES中称为<strong>FIELD</strong>，把一组具有相同字段的DOC存放在一起，存放它们的逻辑容器叫<strong>INDEX</strong>，这些DOC的JSON结构称为<strong>MAPPING</strong>。这里面最不好理解的就是这个INDEX，它实际上类似于MySQL中表的概念，而不是我们通常理解的用于查找数据的索引。</p><p>ES是一个用Java开发的服务端程序，除了Java以外就没有什么外部依赖了，安装部署都非常简单，具体你可以参照它的<a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/getting-started.html\">官方文档</a>先把ES安装好。我们这个示例中，使用的ES版本是目前的最新版本7.6。</p><p>另外，为了能让ES支持中文分词，需要给ES安装一个中文的分词插件<a href=\"https://github.com/medcl/elasticsearch-analysis-ik\">IK Analysis for Elasticsearch</a>，这个插件的作用就是告诉ES怎么对中文文本进行分词。</p><p>你可以直接执行下面的命令自动下载并安装：</p><pre><code>$elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.6.0/elasticsearch-analysis-ik-7.6.0.zip\n</code></pre><p>安装完成后，需要重启ES，验证一下是否安装成功：</p><pre><code>curl -X POST &quot;localhost:9200/_analyze?pretty&quot; -H 'Content-Type: application/json' -d '{ &quot;analyzer&quot;: &quot;ik_smart&quot;, &quot;text&quot;: &quot;极客时间&quot; }'\n{\n  &quot;tokens&quot; : [\n    {\n      &quot;token&quot; : &quot;极&quot;,\n      &quot;start_offset&quot; : 0,\n      &quot;end_offset&quot; : 1,\n      &quot;type&quot; : &quot;CN_CHAR&quot;,\n      &quot;position&quot; : 0\n    },\n    {\n      &quot;token&quot; : &quot;客&quot;,\n      &quot;start_offset&quot; : 1,\n      &quot;end_offset&quot; : 2,\n      &quot;type&quot; : &quot;CN_CHAR&quot;,\n      &quot;position&quot; : 1\n    },\n    {\n      &quot;token&quot; : &quot;时间&quot;,\n      &quot;start_offset&quot; : 2,\n      &quot;end_offset&quot; : 4,\n      &quot;type&quot; : &quot;CN_WORD&quot;,\n      &quot;position&quot; : 2\n    }\n  ]\n}\n</code></pre><p>可以看到，这个分词器把“极客时间”分成了“极”、“客”和“时间”，没认出来“极客”这个词，还是有改进空间的。</p><p>为了能实现商品搜索，我们需要先把商品信息存放到ES中，首先我们先定义存放在ES中商品的数据结构，也就是MAPPING。</p><p><img src=\"https://static001.geekbang.org/resource/image/e6/99/e6cadb1ad8311de9772e673161f94999.jpg?wh=4266*631\" alt=\"\"></p><p>我们这个MAPPING只要两个字段就够了，sku_id就是商品ID，title保存商品的标题，当用户在搜索商品的时候，我们在ES中来匹配商品标题，返回符合条件商品的sku_id列表。ES默认提供了标准的RESTful接口，不需要客户端，直接使用HTTP协议就可以访问，这里我们使用<a href=\"https://curl.haxx.se/docs/manpage.html\">curl</a>通过命令行来操作ES。</p><p>接下来我们使用上面这个MAPPING创建INDEX，类似于MySQL中创建一个表。</p><pre><code>curl -X PUT &quot;localhost:9200/sku&quot; -H 'Content-Type: application/json' -d '{\n        &quot;mappings&quot;: {\n                &quot;properties&quot;: {\n                        &quot;sku_id&quot;: {\n                                &quot;type&quot;: &quot;long&quot;\n                        },\n                        &quot;title&quot;: {\n                                &quot;type&quot;: &quot;text&quot;,\n                                &quot;analyzer&quot;: &quot;ik_max_word&quot;,\n                                &quot;search_analyzer&quot;: &quot;ik_max_word&quot;\n                        }\n                }\n        }\n}'\n{&quot;acknowledged&quot;:true,&quot;shards_acknowledged&quot;:true,&quot;index&quot;:&quot;sku&quot;}\n</code></pre><p>这里面，使用PUT方法创建一个INDEX，INDEX的名称是“sku”，直接写在请求的URL中。请求的BODY是一个JSON对象，内容就是我们上面定义的MAPPING，也就是数据结构。这里面需要注意一下，由于我们要在title这个字段上进行全文搜索，所以我们把数据类型定义为text，并指定使用我们刚刚安装的中文分词插件IK作为这个字段的分词器。</p><p>创建好INDEX之后，就可以往INDEX中写入商品数据，插入数据需要使用HTTP POST方法：</p><pre><code>curl -X POST &quot;localhost:9200/sku/_doc/&quot; -H 'Content-Type: application/json' -d '{\n        &quot;sku_id&quot;: 100002860826,\n        &quot;title&quot;: &quot;烟台红富士苹果 5kg 一级铂金大果 单果230g以上 新鲜水果&quot;\n}'\n{&quot;_index&quot;:&quot;sku&quot;,&quot;_type&quot;:&quot;_doc&quot;,&quot;_id&quot;:&quot;yxQVSHABiy2kuAJG8ilW&quot;,&quot;_version&quot;:1,&quot;result&quot;:&quot;created&quot;,&quot;_shards&quot;:{&quot;total&quot;:2,&quot;successful&quot;:1,&quot;failed&quot;:0},&quot;_seq_no&quot;:0,&quot;_primary_term&quot;:1}\n\ncurl -X POST &quot;localhost:9200/sku/_doc/&quot; -H 'Content-Type: application/json' -d '{\n        &quot;sku_id&quot;: 100000177760,\n        &quot;title&quot;: &quot;苹果 Apple iPhone XS Max (A2104) 256GB 金色 移动联通电信4G手机 双卡双待&quot;\n}'\n{&quot;_index&quot;:&quot;sku&quot;,&quot;_type&quot;:&quot;_doc&quot;,&quot;_id&quot;:&quot;zBQWSHABiy2kuAJGgim1&quot;,&quot;_version&quot;:1,&quot;result&quot;:&quot;created&quot;,&quot;_shards&quot;:{&quot;total&quot;:2,&quot;successful&quot;:1,&quot;failed&quot;:0},&quot;_seq_no&quot;:1,&quot;_primary_term&quot;:1}\n</code></pre><p>这里面我们插入了两条商品数据，一个烟台红富士，一个iPhone手机。然后就可以直接进行商品搜索了，搜索使用HTTP GET方法。</p><pre><code>curl -X GET 'localhost:9200/sku/_search?pretty' -H 'Content-Type: application/json' -d '{\n  &quot;query&quot; : { &quot;match&quot; : { &quot;title&quot; : &quot;苹果手机&quot; }}\n}'\n{\n  &quot;took&quot; : 23,\n  &quot;timed_out&quot; : false,\n  &quot;_shards&quot; : {\n    &quot;total&quot; : 1,\n    &quot;successful&quot; : 1,\n    &quot;skipped&quot; : 0,\n    &quot;failed&quot; : 0\n  },\n  &quot;hits&quot; : {\n    &quot;total&quot; : {\n      &quot;value&quot; : 2,\n      &quot;relation&quot; : &quot;eq&quot;\n    },\n    &quot;max_score&quot; : 0.8594865,\n    &quot;hits&quot; : [\n      {\n        &quot;_index&quot; : &quot;sku&quot;,\n        &quot;_type&quot; : &quot;_doc&quot;,\n        &quot;_id&quot; : &quot;zBQWSHABiy2kuAJGgim1&quot;,\n        &quot;_score&quot; : 0.8594865,\n        &quot;_source&quot; : {\n          &quot;sku_id&quot; : 100000177760,\n          &quot;title&quot; : &quot;苹果 Apple iPhone XS Max (A2104) 256GB 金色 移动联通电信4G手机 双卡双待&quot;\n        }\n      },\n      {\n        &quot;_index&quot; : &quot;sku&quot;,\n        &quot;_type&quot; : &quot;_doc&quot;,\n        &quot;_id&quot; : &quot;yxQVSHABiy2kuAJG8ilW&quot;,\n        &quot;_score&quot; : 0.18577608,\n        &quot;_source&quot; : {\n          &quot;sku_id&quot; : 100002860826,\n          &quot;title&quot; : &quot;烟台红富士苹果 5kg 一级铂金大果 单果230g以上 新鲜水果&quot;\n        }\n      }\n    ]\n  }\n}\n</code></pre><p>我们先看一下请求中的URL，其中的“sku”代表要在sku这个INDEX内进行查找，“_search”是一个关键字，表示要进行搜索，参数pretty表示格式化返回的JSON，这样方便阅读。再看一下请求BODY的JSON，query中的match表示要进行全文匹配，匹配的字段就是title，关键字是“苹果手机”。</p><p>可以看到，在返回结果中，匹配到了2条商品记录，和我们在前面讲解倒排索引时，预期返回的结果是一致的。</p><p>我们来回顾一下使用ES构建商品搜索服务的这个过程：首先安装ES并启动服务，然后创建一个INDEX，定义MAPPING，写入数据后，执行查询并返回查询结果，其实，这个过程和我们使用数据库时，先建表、插入数据然后查询的过程，就是一样的。所以，你就把ES当做一个支持全文搜索的数据库来使用就行了。</p><h2>小结</h2><p>ES本质上是一个支持全文搜索的分布式内存数据库，特别适合用于构建搜索系统。ES之所以能有非常好的全文搜索性能，最重要的原因就是采用了倒排索引。倒排索引是一种特别为搜索而设计的索引结构，倒排索引先对需要索引的字段进行分词，然后以分词为索引组成一个查找树，这样就把一个全文匹配的查找转换成了对树的查找，这是倒排索引能够快速进行搜索的根本原因。</p><p>但是，倒排索引相比于一般数据库采用的B树索引，它的写入和更新性能都比较差，因此倒排索引也只是适合全文搜索，不适合更新频繁的交易类数据。</p><h2>思考题</h2><p>我们在电商的搜索框中搜索商品时，它都有一个搜索提示的功能，比如我输入“苹果”还没有点击搜索按钮的时候，搜索框下面会提示“苹果手机”、“苹果11、苹果电脑”这些建议的搜索关键字，请你课后看一下ES的文档，想一下，如何用ES快速地实现这个搜索提示功能？</p><p>欢迎你在留言区与我讨论，如果你觉得今天的内容对你有帮助，也欢迎把它分享给你的朋友。</p>","comments":[{"had_liked":false,"id":186240,"user_name":"李玥","can_delete":false,"product_type":"c1","uid":1501046,"ip_address":"","ucode":"B19E91EE248591","user_header":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","comment_is_top":true,"comment_ctime":1583806181,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"9.2233722531869e+18","product_id":100046801,"comment_content":"Hi，我是李玥。<br><br>还是在这里回顾一下上节课的思考题：<br><br>2PC也有一些改进版本，比如3PC、TCC这些，它们大体的思想和2PC是差不多的，解决了2PC的一些问题，但是也会带来新的问题，实现起来也更复杂，限于篇幅我们没法每个都详细地去讲解。在理解了2PC的基础上，课后请你自行去学习一下3PC和TCC，然后对比一下，2PC、3PC和TCC分别适用于什么样的业务场景？<br><br>谈一下我的理解：<br><br>3PC相比于2PC做了两个改进，一是事务执行器也增加了超时机制，避免我们课程中提到的因为协调者宕机，导致执行器长时间卡死的问题，另外，3PC在2PC之前增加一个询问阶段，这个阶段事务执行器可以去尝试锁定资源（但不等待），这样避免像2PC那样直接去锁定资源，而资源不可用的情况下，一直等待资源而卡住事务的情况。<br><br>TCC可以理解为业务层面的2PC（也有观点主张TCC和2PC是完全不同的，我个人建议没必要在这些概念上较真，理解并正确使用才是关键），TCC同样分为Try和Confirm&#47;Cancel 两个阶段，在Try阶段锁定资源，但不执行任何更新操作，Confirm阶段来执行所有更新操作并提交，如果失败进入Cancel阶段。Cancel阶段就是收拾烂摊子，把Confirm阶段做的数据更新都改回去，把Try阶段锁定的资源都释放。相比于2PC，TCC可以不依赖于本地事务，但是Cancel阶段的业务逻辑比较难实现。","like_count":51,"discussions":[{"author":{"id":1235692,"avatar":"https://static001.geekbang.org/account/avatar/00/12/da/ec/779c1a78.jpg","nickname":"往事随风，顺其自然","note":"","ucode":"F266EC6B143E38","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":202861,"discussion_content":"Tcc具体怎么实现，代码上怎么实现提交之前的所有工作，怎么界定","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1583971685,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1500391,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e4/e7/31944ee7.jpg","nickname":"千军万马万马@","note":"","ucode":"0BDAD22123435A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":556075,"discussion_content":"赞","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1647186504,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":186184,"user_name":"Geek_c76e2d","can_delete":false,"product_type":"c1","uid":1298901,"ip_address":"","ucode":"663EDCA5A4618C","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIdsbpIiaryKso4qcjFfuWoMebCNM7jvC0N5GdOqks4waTiaZdgKwbwmyv5xiaVeHVKJzaOYXTZoL0OQ/132","comment_is_top":false,"comment_ctime":1583774356,"is_pvip":false,"replies":[{"id":"71958","content":"👍👍👍","user_name":"作者回复","user_name_real":"李玥","uid":"1501046","ctime":1583822023,"ip_address":"","comment_id":186184,"utype":1}],"discussion_count":5,"race_medal":0,"score":"727433247380","product_id":100046801,"comment_content":"因为用户每输入一个字都可能会发请求查询搜索框中的搜索推荐。所以搜索推荐的请求量远高于搜索框中的搜索。es针对这种情况提供了suggestion api，并提供的专门的数据结构应对搜索推荐，性能高于match，但它应用起来也有局限性，就是只能做前缀匹配。再结合pinyin分词器可以做到输入拼音字母就提示中文。如果想做非前缀匹配，可以考虑Ngram。不过Ngram有些复杂，需要开发者自定义分析器。比如有个网址www.geekbang.com，用户可能记不清具体网址了，只记得网址中有2个e，此时用户输入ee两个字母也是可以在搜索框提示出这个网址的。以上是我在工作中针对前缀搜索推荐和非前缀搜索推荐的实现方案。","like_count":170,"discussions":[{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":486663,"discussion_content":"👍👍👍","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583822023,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1260710,"avatar":"https://static001.geekbang.org/account/avatar/00/13/3c/a6/acaf5a24.jpg","nickname":"ccf2019","note":"","ucode":"E9D6F4066EB3DD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":342574,"discussion_content":"用es半年，今天又获收获，谢谢！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1610720141,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1083184,"avatar":"https://static001.geekbang.org/account/avatar/00/10/87/30/4626c8c0.jpg","nickname":"Fs","note":"","ucode":"0AD0EFB5544B9A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":213504,"discussion_content":"这条经验价值比较大","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585100023,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1004698,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/54/9a/76c0af70.jpg","nickname":"每天晒白牙","note":"","ucode":"A1B102CD933DEA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":205071,"discussion_content":"你好，有个问题请教一下，如果用 ES 做全文检索，需要把 title 的类型设置为 text，支持分词，这样就可以像老师在专栏中介绍的一样，用 “苹果手机”进行全文检索了。\n但是如果要实现思考题这种前缀推荐，需要 title 的类型为 completion。\n要想实现 title 既支持前缀推荐，又支持全文检索，但一个 field 只能设置一种类型，这种该怎么实现呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584259704,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1298901,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIdsbpIiaryKso4qcjFfuWoMebCNM7jvC0N5GdOqks4waTiaZdgKwbwmyv5xiaVeHVKJzaOYXTZoL0OQ/132","nickname":"Geek_c76e2d","note":"","ucode":"663EDCA5A4618C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1004698,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/54/9a/76c0af70.jpg","nickname":"每天晒白牙","note":"","ucode":"A1B102CD933DEA","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":207784,"discussion_content":"一个字段可以加很多个field，针对不同field使用不同的搜索语句，比如title这个字段，我会先设置一个ik分词器的text类型，再设置一个默认standard的text类型的field，field取名就叫standard，再设置一个keyword类型的field，取名叫keyword。搜索的时候match去找title字段，match phrase去找title.standard，term去找title.keyword。不论设置多少个field给title，返回值只会有一个title","likes_number":26,"is_delete":false,"is_hidden":false,"ctime":1584514280,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":205071,"ip_address":""},"score":207784,"extra":""}]}]},{"had_liked":false,"id":186227,"user_name":"hello","can_delete":false,"product_type":"c1","uid":1464199,"ip_address":"","ucode":"854500026E2187","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKhuGLVRYZibOTfMumk53Wn8Q0Rkg0o6DzTicbibCq42lWQoZ8lFeQvicaXuZa7dYsr9URMrtpXMVDDww/132","comment_is_top":false,"comment_ctime":1583805040,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"224922104432","product_id":100046801,"comment_content":"老师，能否来一篇加餐，讲讲ES、MySQL、MongoDB、RocketMQ&#47;Kafka、newSQL这些存储的对比，底层是基于什么原理擅长干哪些事，不擅长干哪些事？","like_count":52,"discussions":[{"author":{"id":1886331,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/c8/7b/153181d7.jpg","nickname":"夜辉","note":"","ucode":"9421385F51FF9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":366031,"discussion_content":"希望加餐再来一个总结","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617942940,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1271724,"avatar":"https://static001.geekbang.org/account/avatar/00/13/67/ac/af895343.jpg","nickname":"刘耳总","note":"","ucode":"6D157E6E960075","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":202837,"discussion_content":"支持！！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583964304,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":187854,"user_name":"每天晒白牙","can_delete":false,"product_type":"c1","uid":1004698,"ip_address":"","ucode":"A1B102CD933DEA","user_header":"https://static001.geekbang.org/account/avatar/00/0f/54/9a/76c0af70.jpg","comment_is_top":false,"comment_ctime":1584260458,"is_pvip":false,"replies":[{"id":"72787","content":"没毛病👍","user_name":"作者回复","user_name_real":"李玥","uid":"1501046","ctime":1584410604,"ip_address":"","comment_id":187854,"utype":1}],"discussion_count":4,"race_medal":0,"score":"121843344746","product_id":100046801,"comment_content":"老师，我刚刚问的那个问题，我这边找到了一个方案，但不知道是否是业界用的方案，还请老师指点一下<br>全文检索要把 title 的 type 设置为 text<br>前缀推荐要把 title 的 type 设置为 completion<br>想同时支持全文检索和前缀匹配推荐如何做？<br>用 fields <br><br>mapping 文件如下<br>PUT sku<br>{<br>  &quot;mappings&quot;: {<br>    &quot;properties&quot;: {<br>      &quot;sku_id&quot;:{<br>        &quot;type&quot;: &quot;long&quot;<br>      },<br>      &quot;title&quot;:{<br>        &quot;type&quot;: &quot;text&quot;,<br>        &quot;analyzer&quot;: &quot;ik_max_word&quot;,<br>        &quot;search_analyzer&quot;: &quot;ik_max_word&quot;,<br>        &quot;fields&quot;: {<br>          &quot;title_suggest&quot;:{<br>            &quot;type&quot;:&quot;completion&quot;<br>          }<br>        }<br>      }<br>    }<br>  }<br>}<br><br>支持全文检索<br>GET sku&#47;_search?pretty<br>{<br>  &quot;query&quot;: {<br>    &quot;match&quot;: {<br>      &quot;title&quot;: &quot;苹果手机&quot;<br>    }<br>  }<br>}<br><br>支持前缀匹配<br>POST sku&#47;_search?pretty<br>{<br>  &quot;size&quot;:0,<br>  &quot;suggest&quot;: {<br>    &quot;suggester&quot;: {<br>      &quot;prefix&quot;: &quot;烟台&quot;,<br>      &quot;completion&quot;: {<br>        &quot;field&quot;: &quot;title.title_suggest&quot;<br>      }<br>    }<br>  }<br>}","like_count":28,"discussions":[{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":487269,"discussion_content":"没毛病👍","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1584410604,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1139500,"avatar":"https://static001.geekbang.org/account/avatar/00/11/63/2c/ad20bc4b.jpg","nickname":"Nancys morning","note":"","ucode":"97CF02011F1407","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":530349,"discussion_content":"厉害","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637058866,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"user_type\":1}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1476323,"avatar":"https://static001.geekbang.org/account/avatar/00/16/86/e3/a31f6869.jpg","nickname":" 尿布","note":"","ucode":"D1C8BDA7540962","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":324734,"discussion_content":"厉害了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605162655,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1211223,"avatar":"https://static001.geekbang.org/account/avatar/00/12/7b/57/a9b04544.jpg","nickname":"QQ怪","note":"","ucode":"1A39B8433D9208","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":260242,"discussion_content":"厉害了👍","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588856904,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":196826,"user_name":"划过天空阿忠","can_delete":false,"product_type":"c1","uid":1036370,"ip_address":"","ucode":"9D9BEE73031E40","user_header":"https://static001.geekbang.org/account/avatar/00/0f/d0/52/014accaf.jpg","comment_is_top":false,"comment_ctime":1585316080,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"48829956336","product_id":100046801,"comment_content":"es这个结构化mapping感觉好麻烦，另外老师三俩句就把倒排索引给我讲清楚了，厉害！","like_count":11},{"had_liked":false,"id":190315,"user_name":"黄平","can_delete":false,"product_type":"c1","uid":1552345,"ip_address":"","ucode":"3AEFF39CCAC5C3","user_header":"https://static001.geekbang.org/account/avatar/00/17/af/d9/b1fc248c.jpg","comment_is_top":false,"comment_ctime":1584628583,"is_pvip":false,"replies":[{"id":"73505","content":"另外一个常见的用法是，作为在线分析型数据库来使用，做一些海量数据的实时查询。","user_name":"作者回复","user_name_real":"李玥","uid":"1501046","ctime":1584844714,"ip_address":"","comment_id":190315,"utype":1}],"discussion_count":3,"race_medal":0,"score":"31649399655","product_id":100046801,"comment_content":"老师，es除了做搜索，还有哪些业务场景可以使用呢？能简单列举下吗？","like_count":7,"discussions":[{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":487947,"discussion_content":"另外一个常见的用法是，作为在线分析型数据库来使用，做一些海量数据的实时查询。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584844714,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1010513,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/6b/51/abb7bfe3.jpg","nickname":"小乐天天","note":"","ucode":"1E3D6AB1C629D2","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":551343,"discussion_content":"ELK  日志监控","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644993004,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1980201,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/37/29/b3af57a7.jpg","nickname":"凯文小猪","note":"","ucode":"36D8AD0229547F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":365344,"discussion_content":"比方说你做了分库分表 那么两月内的数据还是可以用es查的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617780067,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":186804,"user_name":"大秦皇朝","can_delete":false,"product_type":"c1","uid":1301113,"ip_address":"","ucode":"0F72D0D2FAEAF2","user_header":"https://static001.geekbang.org/account/avatar/00/13/da/79/9b093890.jpg","comment_is_top":false,"comment_ctime":1583930186,"is_pvip":false,"replies":[{"id":"72250","content":"我没有专业做过搜索，我的朋友孙健（https:&#47;&#47;github.com&#47;ansjsun）老师，他是开源分词项目ansj（https:&#47;&#47;github.com&#47;NLPchina&#47;ansj_seg）的作者，建议你和他讨论一下这个问题。","user_name":"作者回复","user_name_real":"李玥","uid":"1501046","ctime":1584064830,"ip_address":"","comment_id":186804,"utype":1}],"discussion_count":1,"race_medal":0,"score":"31648701258","product_id":100046801,"comment_content":"李sir我还想再问下，根据我们不同的业务，选分词插件有啥讲究没？虽有点跑题，但是能不能简单说下，感谢~","like_count":7,"discussions":[{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":486880,"discussion_content":"我没有专业做过搜索，我的朋友孙健（https://github.com/ansjsun）老师，他是开源分词项目ansj（https://github.com/NLPchina/ansj_seg）的作者，建议你和他讨论一下这个问题。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584064830,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":186481,"user_name":"Jax","can_delete":false,"product_type":"c1","uid":1220215,"ip_address":"","ucode":"F32F8E996BD662","user_header":"https://static001.geekbang.org/account/avatar/00/12/9e/77/f9f1b47d.jpg","comment_is_top":false,"comment_ctime":1583851787,"is_pvip":true,"replies":[{"id":"72049","content":"你提的这些问题，我们在后面的课程中都会讲到。<br><br>比如，《11 | MySQL如何应对高并发（一）：使用缓存保护MySQL》《17 | 大厂都是怎么做MySQL to Redis同步的？》这两节会讲怎么来更快更准确的更新缓存。<br><br>《19 | 跨系统实时同步数据，分布式事务是唯一的解决方案吗？》这节课会讲如何在异构数据库之间来实时同步数据。<br>","user_name":"作者回复","user_name_real":"李玥","uid":"1501046","ctime":1583902696,"ip_address":"","comment_id":186481,"utype":1}],"discussion_count":2,"race_medal":0,"score":"18763720971","product_id":100046801,"comment_content":"老师您好，是否可以做一些电商这种海量数据下，后台管理系统存储方面的最佳实践。还有对于不同系统之间的数据同步，也希望得到一些比较好的实践方案或者工具。<br><br>以下是比较具体的点：<br><br>我在上家公司也是做电商系统的，不过我负责的是后台商品数据的维护系统。前台可以用各种缓存来提速，但是对于后台系统，该如何让系统变得比较快？尤其是后台管理系统往往会涉及大批量商品的价格，库存之类的更新，并且更新后业务团队希望能实时看到他们更新成功了，而且有不少更新的操作对丢数据的容忍度比较低，这种情况下缓存也很难做，所以想得到一些对于这种大批量数据后台管理系统的实践经验。<br><br>对于数据同步，主要是有的原始数据存储在传统数据库，而为了速度，会存储到一些no sql产品做缓存，但是我们在实践中，经常会有一些丢数据，或者未能及时同步的情况发生，希望能得到这方面的一些经验分享。","like_count":4,"discussions":[{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":486773,"discussion_content":"你提的这些问题，我们在后面的课程中都会讲到。\n\n比如，《11 | MySQL如何应对高并发（一）：使用缓存保护MySQL》《17 | 大厂都是怎么做MySQL to Redis同步的？》这两节会讲怎么来更快更准确的更新缓存。\n\n《19 | 跨系统实时同步数据，分布式事务是唯一的解决方案吗？》这节课会讲如何在异构数据库之间来实时同步数据。\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583902696,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1220215,"avatar":"https://static001.geekbang.org/account/avatar/00/12/9e/77/f9f1b47d.jpg","nickname":"Jax","note":"","ucode":"F32F8E996BD662","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":202578,"discussion_content":"感谢，期待更新","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583934548,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":186399,"user_name":"旅途","can_delete":false,"product_type":"c1","uid":1212902,"ip_address":"","ucode":"5022477E8E9441","user_header":"https://static001.geekbang.org/account/avatar/00/12/81/e6/6cafed37.jpg","comment_is_top":false,"comment_ctime":1583836221,"is_pvip":false,"replies":[{"id":"72046","content":"是的","user_name":"作者回复","user_name_real":"李玥","uid":"1501046","ctime":1583901588,"ip_address":"","comment_id":186399,"utype":1}],"discussion_count":2,"race_medal":0,"score":"18763705405","product_id":100046801,"comment_content":"老师 您说的二次查找是指在第一次的查找结果中继续查找吗","like_count":4,"discussions":[{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":486739,"discussion_content":"是的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583901588,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1500391,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e4/e7/31944ee7.jpg","nickname":"千军万马万马@","note":"","ucode":"0BDAD22123435A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":556076,"discussion_content":" 啊？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1647186757,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":200876,"user_name":"王超","can_delete":false,"product_type":"c1","uid":1107559,"ip_address":"","ucode":"653A7A49A3090F","user_header":"https://static001.geekbang.org/account/avatar/00/10/e6/67/59e81206.jpg","comment_is_top":false,"comment_ctime":1585665575,"is_pvip":true,"replies":[{"id":"75374","content":"这个取决于ES里面的这份订单数据服务什么业务。<br><br>比如，ES里面最常用的查询操作是查订单关联的商品，那就把订单表和订单商品表做成一张宽表。","user_name":"作者回复","user_name_real":"李玥","uid":"1501046","ctime":1585796306,"ip_address":"","comment_id":200876,"utype":1}],"discussion_count":2,"race_medal":0,"score":"14470567463","product_id":100046801,"comment_content":"老师，针对订单中心的表数据，业务库用mysql，同步到es做查询时，比如一个订单主表，关联5个子表，在es存的时候是以嵌套的形式存一个index，还是mysql一张表，对应es的一个index，然后维护父子关系？或者有更好的方案","like_count":3,"discussions":[{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":490162,"discussion_content":"这个取决于ES里面的这份订单数据服务什么业务。\n\n比如，ES里面最常用的查询操作是查订单关联的商品，那就把订单表和订单商品表做成一张宽表。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585796306,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1107559,"avatar":"https://static001.geekbang.org/account/avatar/00/10/e6/67/59e81206.jpg","nickname":"王超","note":"","ucode":"653A7A49A3090F","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":225283,"discussion_content":"老师，如果订单和商品表是一对多的情况，怎么做宽表，嵌套么，将商品以json数组形式作为宽表一个字段的value","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586354366,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":209322,"user_name":"yudidi","can_delete":false,"product_type":"c1","uid":1202482,"ip_address":"","ucode":"70283DE39D86F5","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/ydFhHonicUQibGlAfsAYBibNOfSxpCG5cJNp9oRibTJm3TrxM7Hj4WPPCRE3vluZJb0TGQqpKCaBWLdmra5Su1KF5Q/132","comment_is_top":false,"comment_ctime":1587535166,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"10177469758","product_id":100046801,"comment_content":"注意type这个概念在es6之后被逐渐移除了。<br>https:&#47;&#47;www.elastic.co&#47;guide&#47;en&#47;elasticsearch&#47;reference&#47;6.3&#47;getting-started-concepts.html#_type","like_count":2,"discussions":[{"author":{"id":1658413,"avatar":"https://static001.geekbang.org/account/avatar/00/19/4e/2d/06d3f9f5.jpg","nickname":"静✨","note":"","ucode":"1B33229C206339","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":587092,"discussion_content":"去年做了ES 2.4 → 7升级调查的人表示两眼泪汪汪😣","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662782747,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"浙江"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1886331,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/c8/7b/153181d7.jpg","nickname":"夜辉","note":"","ucode":"9421385F51FF9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":366054,"discussion_content":"在Elasticsearch 6.0.0或更高版本中创建的索引只能包含一个映射类型。在5.x中创建的具有多种映射类型的索引将继续像在Elasticsearch 6.x中一样工作。类型将在Elasticsearch 7.0.0中的API中弃用，并在8.0.0中完全删除。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617950642,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":206436,"user_name":"呦呦鹿鸣","can_delete":false,"product_type":"c1","uid":1238190,"ip_address":"","ucode":"BC80F2093CD6C3","user_header":"https://static001.geekbang.org/account/avatar/00/12/e4/ae/7b310c2d.jpg","comment_is_top":false,"comment_ctime":1586860700,"is_pvip":false,"replies":[{"id":"77857","content":"额……ES最不擅长的就是深分页了……所以，据我所知，没什么好的解决方案。","user_name":"作者回复","user_name_real":"李玥","uid":"1501046","ctime":1587353523,"ip_address":"","comment_id":206436,"utype":1}],"discussion_count":3,"race_medal":0,"score":"10176795292","product_id":100046801,"comment_content":"李老师好，请问下ES在做深度分页查询时的场景下有什么好的方案么","like_count":2,"discussions":[{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":491788,"discussion_content":"额……ES最不擅长的就是深分页了……所以，据我所知，没什么好的解决方案。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587353523,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1010914,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEIgYQgM25OaLGNWPUg5NSrQuCrPNicHqNgB9lsJGMalNU18sibF4cdYxKPuwgVsIc1m5ha5voHrY9Lg/132","nickname":"jacoffee","note":"","ucode":"B3BFD39138400B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":561555,"discussion_content":"可以尝试使用search_after去解决，之前在开发中使用它解决过一个批量取数的逻辑，可以参考 https://www.toutiao.com/article/6846769235620790795/","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649670246,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1768852,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/fd/94/8704d2b0.jpg","nickname":"spoofer","note":"","ucode":"6723F64ACC3F27","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":358912,"discussion_content":"业务上禁止就可以了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1616074482,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":204742,"user_name":"马晨阳","can_delete":false,"product_type":"c1","uid":1230031,"ip_address":"","ucode":"344ACC3BF7F14A","user_header":"https://static001.geekbang.org/account/avatar/00/12/c4/cf/6e1205cc.jpg","comment_is_top":false,"comment_ctime":1586448278,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10176382870","product_id":100046801,"comment_content":"对于分布式事务部分还是没太能理解，老师可否加个餐，展示一波代码看一下2pc和tcc具体的代码实战","like_count":2},{"had_liked":false,"id":194389,"user_name":"郭刚","can_delete":false,"product_type":"c1","uid":1292032,"ip_address":"","ucode":"22CB8ECE8E3DCA","user_header":"https://static001.geekbang.org/account/avatar/00/13/b7/00/12149f4e.jpg","comment_is_top":false,"comment_ctime":1585057265,"is_pvip":false,"replies":[{"id":"74081","content":"其实我见到一些业务，用ES来作为在线分析的数据库，实时的进行多表联查，性能也还可以。虽然从数据结构上来说，像你说的不太适合干这个活儿。但所谓“一力降十会”，因为ES它是内存数据库，加上原生分布式，自带Map-Reduce光环，很多情况实际表现还是不错的。你可以尝试一下。","user_name":"作者回复","user_name_real":"李玥","uid":"1501046","ctime":1585099347,"ip_address":"","comment_id":194389,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10174991857","product_id":100046801,"comment_content":"用ES有两个问题，1.它不适合多索引关联，就像关系数据库的多表关联，那关系数据库多表关联查询的情况是不是建一张中间表，把中间表的数据导入到es   2.要做到准实时的要求，有没有好的方式","like_count":2,"discussions":[{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":488818,"discussion_content":"其实我见到一些业务，用ES来作为在线分析的数据库，实时的进行多表联查，性能也还可以。虽然从数据结构上来说，像你说的不太适合干这个活儿。但所谓“一力降十会”，因为ES它是内存数据库，加上原生分布式，自带Map-Reduce光环，很多情况实际表现还是不错的。你可以尝试一下。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585099347,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":187851,"user_name":"每天晒白牙","can_delete":false,"product_type":"c1","uid":1004698,"ip_address":"","ucode":"A1B102CD933DEA","user_header":"https://static001.geekbang.org/account/avatar/00/0f/54/9a/76c0af70.jpg","comment_is_top":false,"comment_ctime":1584259790,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5879227086","product_id":100046801,"comment_content":"思考题需要把要支持前缀推荐的 field 的类型设置为  completion，现在只支持前缀匹配","like_count":1},{"had_liked":false,"id":187849,"user_name":"每天晒白牙","can_delete":false,"product_type":"c1","uid":1004698,"ip_address":"","ucode":"A1B102CD933DEA","user_header":"https://static001.geekbang.org/account/avatar/00/0f/54/9a/76c0af70.jpg","comment_is_top":false,"comment_ctime":1584259688,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5879226984","product_id":100046801,"comment_content":"老师，有个问题请教一下，如果用 ES 做全文检索，需要把 title 的类型设置为 text，支持分词，这样就可以像老师在专栏中介绍的一样，用 “苹果手机”进行全文检索了。<br>但是如果要实现思考题这种前缀推荐，需要 title 的类型为 completion。<br>要想实现 title 既支持前缀推荐，又支持全文检索，但一个 field 只能设置一种类型，这种该怎么实现呢？","like_count":1,"discussions":[{"author":{"id":2053679,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/56/2f/4518f8e1.jpg","nickname":"放不下荣华富贵","note":"","ucode":"9FE29C22B9ABE3","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":348837,"discussion_content":"再建立一个field","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1612749027,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":186752,"user_name":"大秦皇朝","can_delete":false,"product_type":"c1","uid":1301113,"ip_address":"","ucode":"0F72D0D2FAEAF2","user_header":"https://static001.geekbang.org/account/avatar/00/13/da/79/9b093890.jpg","comment_is_top":false,"comment_ctime":1583917162,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5878884458","product_id":100046801,"comment_content":"windows下测试避坑：<br>分词插件icu支持路径中带空格或者说是可以es放在Program Files下；如果用ik的话，建议路径不要带空格，网上很多说权限之类的，我把权限调整了也不行，路径不带空格立马OK。","like_count":1,"discussions":[{"author":{"id":1886331,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/c8/7b/153181d7.jpg","nickname":"夜辉","note":"","ucode":"9421385F51FF9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":366055,"discussion_content":"windows安装软件的目录不建议带中文和空格","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617950700,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":186445,"user_name":"发条橙子 。","can_delete":false,"product_type":"c1","uid":1259218,"ip_address":"","ucode":"ED076F4534FFED","user_header":"https://static001.geekbang.org/account/avatar/00/13/36/d2/c7357723.jpg","comment_is_top":false,"comment_ctime":1583846001,"is_pvip":false,"replies":[{"id":"72048","content":"也不能说MySQL就慢，ES就快，最终查询性能还是要取决于数据总量和存储结构，当然ES它是内存数据库，占一些优势。<br><br>后面我们会用几节课来讲，到底是什么因素影响查询快慢。","user_name":"作者回复","user_name_real":"李玥","uid":"1501046","ctime":1583902326,"ip_address":"","comment_id":186445,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5878813297","product_id":100046801,"comment_content":"老师 面试中经常会有问到几千万条数据列表的查询如何实现 ，本质就是考避免使用数据库而选择这种es来搜索是么 。 那几千万条数据在es中查询 “苹果” 是不是也会有性能之类的问题","like_count":2,"discussions":[{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":486757,"discussion_content":"也不能说MySQL就慢，ES就快，最终查询性能还是要取决于数据总量和存储结构，当然ES它是内存数据库，占一些优势。\n\n后面我们会用几节课来讲，到底是什么因素影响查询快慢。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583902326,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1980201,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/37/29/b3af57a7.jpg","nickname":"凯文小猪","note":"","ucode":"36D8AD0229547F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":365345,"discussion_content":"如果是几千万数据量直接扔内存里 这里你要考虑内存占用问题。我给你引子：假设一条完整的记录时1KB 那么一万条就是10MB 千万条就是几个G。所以直接扔在内存里仍然会慢 而且ES是java引用 很快就会full gc了。所以本质问题是如何先通过预筛选缩短数据量 之后再讨论是用ES还是mySQL","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1617780242,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":357143,"user_name":"Sun","can_delete":false,"product_type":"c1","uid":2150157,"ip_address":"四川","ucode":"1BA93A4267D151","user_header":"https://static001.geekbang.org/account/avatar/00/20/cf/0d/8a595ab0.jpg","comment_is_top":false,"comment_ctime":1662990644,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1662990644","product_id":100046801,"comment_content":"在电商中有一个常见的场景就是根据商品销量倒叙展示问题，销量试试变动，我现在是查询出来商品id再到数据库中查找库存排序，但是如果有分页客户体验特别差，没库存的或者缺货的会排在前面几页，老师请问有没有什么好的思路","like_count":0,"discussions":[{"author":{"id":1256821,"avatar":"https://static001.geekbang.org/account/avatar/00/13/2d/75/e7c29de4.jpg","nickname":"wkq2786130","note":"","ucode":"0F3A9DF9928C67","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":588758,"discussion_content":"用redis sorted set","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1664077950,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"北京"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":356555,"user_name":"Anxuan","can_delete":false,"product_type":"c1","uid":2462391,"ip_address":"广东","ucode":"F807A526F56DE6","user_header":"https://static001.geekbang.org/account/avatar/00/25/92/b7/f3f9eba5.jpg","comment_is_top":false,"comment_ctime":1662395408,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1662395408","product_id":100046801,"comment_content":"es不适合更新字段，那假如我需要修改内容，我是更新好还是删除后新增好。","like_count":0},{"had_liked":false,"id":337966,"user_name":"千军万马万马@","can_delete":false,"product_type":"c1","uid":1500391,"ip_address":"","ucode":"0BDAD22123435A","user_header":"https://static001.geekbang.org/account/avatar/00/16/e4/e7/31944ee7.jpg","comment_is_top":false,"comment_ctime":1647186437,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1647186437","product_id":100046801,"comment_content":"咋没人点赞啊","like_count":0},{"had_liked":false,"id":324822,"user_name":"JiaLong","can_delete":false,"product_type":"c1","uid":2084728,"ip_address":"","ucode":"608B611F02A846","user_header":"https://static001.geekbang.org/account/avatar/00/1f/cf/78/72c1545a.jpg","comment_is_top":false,"comment_ctime":1638668513,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1638668513","product_id":100046801,"comment_content":"老师，能不能再解释一下什么是倒排？，苹果的倒排是果苹，烟台，台烟？","like_count":0,"discussions":[{"author":{"id":1010914,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEIgYQgM25OaLGNWPUg5NSrQuCrPNicHqNgB9lsJGMalNU18sibF4cdYxKPuwgVsIc1m5ha5voHrY9Lg/132","nickname":"jacoffee","note":"","ucode":"B3BFD39138400B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":561556,"discussion_content":"不是的。 你可以这样理解，抛开倒排索引的底层实现，相较于正常的索引(farward index)，一般是按照文章查找内容。倒排索引(inverted index)强调的更多的是某个词出现了在哪些文章中，通过词来找到这些文章。它会把文章按照指定的算法分词，然后以word --&gt; docId的形式存储。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649671072,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":306580,"user_name":"Mine","can_delete":false,"product_type":"c1","uid":1253597,"ip_address":"","ucode":"85C3A3117FD9CB","user_header":"https://static001.geekbang.org/account/avatar/00/13/20/dd/82d8eff2.jpg","comment_is_top":false,"comment_ctime":1628613056,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1628613056","product_id":100046801,"comment_content":"就没有人说说多数据源异构同步至一个index如何处理吗😭😭😭。数据如何保证不丢失，如何保证同步的顺序选。","like_count":0,"discussions":[{"author":{"id":1844270,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJrZb9pm07aiciaNalQ0gRgMub2In4RQHYSd7VI2gvsTQMC1wSsYfcxxCYCeBmrs6Vic7GRf9jtNRqyA/132","nickname":"壮壮.java","note":"","ucode":"755C8C8A823B70","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":389901,"discussion_content":"是的吧 精华难点都不说","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629474689,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":282444,"user_name":"刘瓜瓜","can_delete":false,"product_type":"c1","uid":2103021,"ip_address":"","ucode":"0380FA51CB9950","user_header":"https://static001.geekbang.org/account/avatar/00/20/16/ed/2db68084.jpg","comment_is_top":false,"comment_ctime":1615254321,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1615254321","product_id":100046801,"comment_content":"为什么不用B+树，而要用B树呢，B+树搜索不是更好吗","like_count":0},{"had_liked":false,"id":253210,"user_name":"STOREFEE","can_delete":false,"product_type":"c1","uid":1594215,"ip_address":"","ucode":"CF660E3FF11D95","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIG2aw6bmrrxPkrwIyStmZsfaYVHzYbP05A8V9LCa8ZnKl7yYb4zHTyicN5grp03nnpRqgQicpsaTxg/132","comment_is_top":false,"comment_ctime":1602651379,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1602651379","product_id":100046801,"comment_content":"发现即使用了中文分词，查询也没有mysql那么准确呢？这个是怎么彻底解决呢？","like_count":0,"discussions":[{"author":{"id":1151028,"avatar":"https://static001.geekbang.org/account/avatar/00/11/90/34/68ae31ae.jpg","nickname":"影子-dxb","note":"","ucode":"13434C85D27EF1","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":331721,"discussion_content":"这个跟分词算法模型关系比较大吧，分不好，肯定搜不准","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606961947,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1594215,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIG2aw6bmrrxPkrwIyStmZsfaYVHzYbP05A8V9LCa8ZnKl7yYb4zHTyicN5grp03nnpRqgQicpsaTxg/132","nickname":"STOREFEE","note":"","ucode":"CF660E3FF11D95","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1151028,"avatar":"https://static001.geekbang.org/account/avatar/00/11/90/34/68ae31ae.jpg","nickname":"影子-dxb","note":"","ucode":"13434C85D27EF1","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":332247,"discussion_content":"你们用的中文算法是啥呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1607130594,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":331721,"ip_address":""},"score":332247,"extra":""}]}]},{"had_liked":false,"id":253058,"user_name":"丁丁历险记","can_delete":false,"product_type":"c1","uid":1661704,"ip_address":"","ucode":"A43829E454C067","user_header":"https://static001.geekbang.org/account/avatar/00/19/5b/08/b0b0db05.jpg","comment_is_top":false,"comment_ctime":1602580896,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1602580896","product_id":100046801,"comment_content":"linux 我用rpm 装的，装插件时，注意下版本，其它一切顺利","like_count":0},{"had_liked":false,"id":253011,"user_name":"亚林","can_delete":false,"product_type":"c1","uid":1018972,"ip_address":"","ucode":"4A5A6D24314B79","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8c/5c/3f164f66.jpg","comment_is_top":false,"comment_ctime":1602561862,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1602561862","product_id":100046801,"comment_content":"当需要调整MAPPING定义的时候，需要删除掉数据，然后重新灌数据到新的INDEX中吧","like_count":0},{"had_liked":false,"id":232680,"user_name":"Lywane","can_delete":false,"product_type":"c1","uid":1446512,"ip_address":"","ucode":"2B0027AA069CE9","user_header":"https://static001.geekbang.org/account/avatar/00/16/12/70/10faf04b.jpg","comment_is_top":false,"comment_ctime":1594087419,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1594087419","product_id":100046801,"comment_content":"老师有个问题哈，既然es适合做搜索是因为使用了倒排索引，那么应该也有一种方案：分词后将数据插入mysq，查询时，将关键词分词后再查询。为什么感觉几乎没人这样做呢，都是用es","like_count":0,"discussions":[{"author":{"id":1886331,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/c8/7b/153181d7.jpg","nickname":"夜辉","note":"","ucode":"9421385F51FF9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":366056,"discussion_content":"因为mysql底层不是用倒排索引存储\n可以实现这个功能，但底层是全文匹配","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617950834,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":204848,"user_name":"funnyx","can_delete":false,"product_type":"c1","uid":1115049,"ip_address":"","ucode":"A9B8E27919AE4D","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoZqcVJzUjfu5noOW6OPAh6ibrBicibLmicibnVyVLHdf7GwAzf2th5s1oQ9pUbLpmq2mlVBauUZn8QUnw/132","comment_is_top":false,"comment_ctime":1586482252,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1586482252","product_id":100046801,"comment_content":"老师您好，这个倒排表的实现方式在lucene好像是跳表来实现的，不知道我的理解对么？","like_count":0,"discussions":[{"author":{"id":1010513,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/6b/51/abb7bfe3.jpg","nickname":"小乐天天","note":"","ucode":"1E3D6AB1C629D2","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":551344,"discussion_content":"最后确认了吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644993200,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":204406,"user_name":"闫冬","can_delete":false,"product_type":"c1","uid":1109691,"ip_address":"","ucode":"1725E869D5A3D3","user_header":"https://static001.geekbang.org/account/avatar/00/10/ee/bb/7afd6824.jpg","comment_is_top":false,"comment_ctime":1586396559,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1586396559","product_id":100046801,"comment_content":"我理解的倒排索引就是先对查找的词预先分词，对每一个词建立索引与innodb的索引其实是类似的，但是innodb 无法对没每个词建索引，而且也意味这用空间换时间，mysql的全文索引不经常用也是这个原因，请老师指导","like_count":0},{"had_liked":false,"id":193588,"user_name":"1","can_delete":false,"product_type":"c1","uid":1895904,"ip_address":"","ucode":"44133D009755C7","user_header":"https://static001.geekbang.org/account/avatar/00/1c/ed/e0/c63d6a80.jpg","comment_is_top":false,"comment_ctime":1584930768,"is_pvip":false,"replies":[{"id":"73920","content":"像价格这类变动非常频繁的数据，不是很适合存在ES中。<br>但数据量和并发量不是特别大的话，ES还是可以胜任的。<br><br>至于按价格排序，主要看每次搜索的结果集是不是很大，如果结果集不大的话（几十条或几百条），可以先在ES查出来啊，再去关联价格表然后按价格排序。<br><br>如果结果集很大，那可能就得按照你的方法来实现了。","user_name":"作者回复","user_name_real":"李玥","uid":"1501046","ctime":1585025200,"ip_address":"","comment_id":193588,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1584930768","product_id":100046801,"comment_content":"比如商品搜索跟每个用户签了某些商品的价格，每个客户看到签的价格不一样，用es查询给每个用户都建一个index，还是有什么更好的方法？想让它可以按价格排序","like_count":0,"discussions":[{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":488595,"discussion_content":"像价格这类变动非常频繁的数据，不是很适合存在ES中。\n但数据量和并发量不是特别大的话，ES还是可以胜任的。\n\n至于按价格排序，主要看每次搜索的结果集是不是很大，如果结果集不大的话（几十条或几百条），可以先在ES查出来啊，再去关联价格表然后按价格排序。\n\n如果结果集很大，那可能就得按照你的方法来实现了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585025200,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":186237,"user_name":"每天晒白牙","can_delete":false,"product_type":"c1","uid":1004698,"ip_address":"","ucode":"A1B102CD933DEA","user_header":"https://static001.geekbang.org/account/avatar/00/0f/54/9a/76c0af70.jpg","comment_is_top":false,"comment_ctime":1583805875,"is_pvip":false,"replies":[{"id":"71957","content":"这个需求用ES很合适啊","user_name":"作者回复","user_name_real":"李玥","uid":"1501046","ctime":1583821974,"ip_address":"","comment_id":186237,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1583805875","product_id":100046801,"comment_content":"老师，请教个问题，比如一个商品搜索系统，给一些商品打标签，然后支持根据商品信息和标签搜索商品，有啥方案吗？","like_count":1,"discussions":[{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":486687,"discussion_content":"这个需求用ES很合适啊","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583821974,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1298901,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIdsbpIiaryKso4qcjFfuWoMebCNM7jvC0N5GdOqks4waTiaZdgKwbwmyv5xiaVeHVKJzaOYXTZoL0OQ/132","nickname":"Geek_c76e2d","note":"","ucode":"663EDCA5A4618C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":201670,"discussion_content":"在建立索引的时候，需要全文检索的字段使用text类型，配合分词器。需要精确匹配的标签使用keyword类型。查询的时候match去匹配text类型，同时term去匹配keyword。term查询可以放在filter里提高性能","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1583822797,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":186236,"user_name":"每天晒白牙","can_delete":false,"product_type":"c1","uid":1004698,"ip_address":"","ucode":"A1B102CD933DEA","user_header":"https://static001.geekbang.org/account/avatar/00/0f/54/9a/76c0af70.jpg","comment_is_top":false,"comment_ctime":1583805758,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1583805758","product_id":100046801,"comment_content":"应该输入的时候就会实时去 ES 中检索吧","like_count":0},{"had_liked":false,"id":186212,"user_name":"何妨","can_delete":false,"product_type":"c1","uid":1385377,"ip_address":"","ucode":"EC3983BFF7992A","user_header":"https://static001.geekbang.org/account/avatar/00/15/23/a1/b08f3ee7.jpg","comment_is_top":false,"comment_ctime":1583801039,"is_pvip":false,"replies":[{"id":"71956","content":"写入数据的时候。","user_name":"作者回复","user_name_real":"李玥","uid":"1501046","ctime":1583821883,"ip_address":"","comment_id":186212,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1583801039","product_id":100046801,"comment_content":"那一般什么时候来更新索引呢？是建立一个定时任务来更新么","like_count":0,"discussions":[{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":486679,"discussion_content":"写入数据的时候。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583821883,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":186191,"user_name":"ELLIOT","can_delete":false,"product_type":"c1","uid":1151709,"ip_address":"","ucode":"CBFAAD6CB9BCF9","user_header":"https://static001.geekbang.org/account/avatar/00/11/92/dd/39bddbce.jpg","comment_is_top":false,"comment_ctime":1583781443,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1583781443","product_id":100046801,"comment_content":"使用match query对商品名进行匹配，然后按score进行sort排序，选择前n项","like_count":0}]}