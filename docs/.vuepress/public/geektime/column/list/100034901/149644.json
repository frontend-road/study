{"id":149644,"title":"21 | æœŸæœ«å®æˆ˜ï¼šä¸ºä½ çš„ç®€çº¦ç‰ˆIMç³»ç»Ÿï¼ŒåŠ ä¸ŠåŠŸèƒ½","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯è¢æ­¦æ—ã€‚</p><p>åœ¨æœŸä¸­å®æˆ˜ä¸­ï¼Œæˆ‘ä»¬ä¸€èµ·å°è¯•å®ç°äº†ä¸€ä¸ªç®€æ˜“ç‰ˆçš„èŠå¤©ç³»ç»Ÿï¼Œå¹¶ä¸”ä¸ºè¿™ä¸ªèŠå¤©ç³»ç»Ÿå¢åŠ äº†ä¸€äº›åŸºæœ¬åŠŸèƒ½ã€‚æ¯”å¦‚ï¼Œç”¨æˆ·ç™»å½•ã€ç®€å•çš„æ–‡æœ¬æ¶ˆæ¯æ”¶å‘ã€æ¶ˆæ¯å­˜å‚¨è®¾è®¡ã€æœªè¯»æ•°æç¤ºã€æ¶ˆæ¯è‡ªåŠ¨æ›´æ–°ç­‰ã€‚</p><p>ä½†æ˜¯æœŸä¸­å®æˆ˜çš„ç›®çš„ï¼Œä¸»è¦æ˜¯è®©ä½ å¯¹IMç³»ç»Ÿçš„åŸºæœ¬åŠŸèƒ½æ„æˆæœ‰ä¸€ä¸ªç›´è§‚çš„äº†è§£ï¼Œæ‰€ä»¥åœ¨åŠŸèƒ½çš„å®ç°å±‚é¢ä¸Šæ¯”è¾ƒç®€å•ã€‚æ¯”å¦‚é’ˆå¯¹æ¶ˆæ¯çš„å®æ—¶æ€§ï¼ŒæœŸä¸­é‡‡ç”¨çš„æ˜¯åŸºäºHTTPçŸ­è½®è¯¢çš„æ–¹å¼æ¥å®ç°ã€‚</p><p>å› æ­¤ï¼Œåœ¨æœŸæœ«å®æˆ˜ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦çš„å·¥ä½œå°±æ˜¯é’ˆå¯¹æœŸä¸­å®æˆ˜é‡Œçš„æ¶ˆæ¯æ”¶å‘æ¥è¿›è¡ŒåŠŸèƒ½ä¼˜åŒ–ã€‚</p><p>æ¯”å¦‚ï¼Œæˆ‘ä»¬ä¼šé‡‡ç”¨WebSocketçš„é•¿è¿æ¥ï¼Œæ¥æ›¿ä»£ä¹‹å‰çš„HTTPçŸ­è½®è¯¢æ–¹å¼ï¼Œå¹¶ä¸”ä¼šåŠ ä¸Šä¸€äº›è¯¾ç¨‹ä¸­æœ‰è®²åˆ°çš„ç›¸å¯¹é«˜çº§çš„åŠŸèƒ½ï¼Œå¦‚åº”ç”¨å±‚å¿ƒè·³ã€ACKæœºåˆ¶ç­‰ã€‚</p><p>å¸Œæœ›é€šè¿‡æœŸæœ«æ•´ä½“æŠ€æœ¯å®ç°ä¸Šçš„å‡çº§ï¼Œä½ èƒ½æ›´æ·±åˆ»åœ°ä½“ä¼šåˆ°IMç³»ç»Ÿå‡çº§å‰åï¼Œå¯¹ä½¿ç”¨æ–¹å’ŒæœåŠ¡ç«¯å‹åŠ›çš„å·®å¼‚æ€§ã€‚ç›¸åº”çš„ç¤ºä¾‹ä»£ç æˆ‘æ”¾åœ¨äº†<a href=\"https://github.com/coldwalker/Sample\">GitHub</a>é‡Œï¼Œä½ å¯ä»¥ä½œä¸ºå‚è€ƒæ¥å­¦ä¹ å’Œå®ç°ã€‚</p><h2>åŠŸèƒ½ä»‹ç»</h2><p>å…³äºè¿™æ¬¡æœŸæœ«å®æˆ˜ï¼Œå¸Œæœ›ä½ èƒ½å¤Ÿå®Œæˆçš„åŠŸèƒ½ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š</p><ol>\n<li>æ”¯æŒåŸºäºWebSocketçš„é•¿è¿æ¥ã€‚</li>\n<li>æ¶ˆæ¯æ”¶å‘å‡é€šè¿‡é•¿è¿æ¥è¿›è¡Œé€šä¿¡ã€‚</li>\n<li>æ”¯æŒæ¶ˆæ¯æ¨é€çš„ACKæœºåˆ¶å’Œé‡æ¨æœºåˆ¶ã€‚</li>\n<li>æ”¯æŒå®¢æˆ·ç«¯çš„å¿ƒè·³æœºåˆ¶å’ŒåŒç«¯çš„idleè¶…æ—¶æ–­è¿ã€‚</li>\n<li>æ”¯æŒå®¢æˆ·ç«¯æ–­çº¿åçš„è‡ªåŠ¨é‡è¿ã€‚</li>\n</ol><h2>åŠŸèƒ½å®ç°æ‹†è§£</h2><!-- [[[read_end]]] --><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±é’ˆå¯¹ä»¥ä¸Šè¿™äº›éœ€è¦å‡çº§çš„åŠŸèƒ½å’Œæ–°å¢çš„ä¸»è¦åŠŸèƒ½ï¼Œæ¥è¿›è¡Œå®ç°ä¸Šçš„æ‹†è§£ã€‚</p><h3>WebSocketé•¿è¿æ¥</h3><p>é¦–å…ˆï¼ŒæœŸæœ«å®æˆ˜ä¸€ä¸ªæ¯”è¾ƒå¤§çš„æ”¹å˜å°±æ˜¯ï¼Œå°†ä¹‹å‰HTTPçŸ­è½®è¯¢çš„å®ç°ï¼Œæ”¹é€ æˆçœŸæ­£çš„é•¿è¿æ¥ã€‚ä¸ºäº†æ–¹ä¾¿Webç«¯çš„æ¼”ç¤ºï¼Œè¿™é‡Œæˆ‘å»ºè®®ä½ å¯ä»¥ä½¿ç”¨WebSocketæ¥å®ç°ã€‚</p><p>å¯¹äºWebSocketï¼Œæˆ‘ä»¬åœ¨å®¢æˆ·ç«¯JSï¼ˆJavaScriptï¼‰é‡Œä¸»è¦æ˜¯ä½¿ç”¨HTML5çš„åŸç”ŸAPIæ¥å®ç°ï¼Œå…¶æ ¸å¿ƒçš„å®ç°ä»£ç éƒ¨åˆ†å¦‚ä¸‹ï¼š</p><pre><code>if (window.WebSocket) {\n    websocket = new WebSocket(&quot;ws://127.0.0.1:8080&quot;);\n    websocket.onmessage = function (event) {\n        onmsg(event);\n    };\n\n    //è¿æ¥å»ºç«‹åçš„äº‹ä»¶ç›‘å¬\n    websocket.onopen = function () {\n        bind();\n        heartBeat.start();\n    }\n\n    //è¿æ¥å…³é—­åçš„äº‹ä»¶ç›‘å¬\n    websocket.onclose = function () {\n        reconnect();\n    };\n\n    //è¿æ¥å‡ºç°å¼‚å¸¸åçš„äº‹ä»¶ç›‘å¬\n    websocket.onerror = function () {\n        reconnect();\n    };\n\n} else {\n    alert(&quot;æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒWebSocketåè®®ï¼&quot;\n}\n</code></pre><p>é¡µé¢æ‰“å¼€æ—¶ï¼ŒJSå…ˆé€šè¿‡æœåŠ¡ç«¯çš„WebSocketåœ°å€å»ºç«‹é•¿è¿æ¥ã€‚è¦æ³¨æ„è¿™é‡ŒæœåŠ¡ç«¯è¿æ¥çš„åœ°å€æ˜¯ws://å¼€å¤´çš„ï¼Œä¸æ˜¯http://çš„äº†ï¼›å¦‚æœæ˜¯ä½¿ç”¨åŠ å¯†çš„WebSocketåè®®ï¼Œé‚£ä¹ˆç›¸åº”çš„åœ°å€åº”è¯¥æ˜¯ä»¥wss://å¼€å¤´çš„ã€‚</p><p>å»ºç«‹é•¿è¿ä¹‹åï¼Œè¦é’ˆå¯¹åˆ›å»ºçš„WebSocketå¯¹è±¡è¿›è¡Œäº‹ä»¶çš„ç›‘å¬ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨å„ç§äº‹ä»¶è§¦å‘çš„æ—¶å€™ï¼Œè¿›è¡Œå¯¹åº”çš„é€»è¾‘å¤„ç†å°±å¯ä»¥äº†ã€‚</p><p>æ¯”å¦‚ï¼ŒAPIä¸»è¦æ”¯æŒçš„å‡ ç§äº‹ä»¶æœ‰ï¼šé•¿è¿æ¥é€šé“å»ºç«‹å®Œæˆåï¼Œé€šè¿‡onopenäº‹ä»¶æ¥è¿›è¡Œç”¨æˆ·ä¿¡æ¯çš„ä¸ŠæŠ¥ç»‘å®šï¼›é€šè¿‡onmessageäº‹ä»¶ï¼Œå¯¹æ¥æ”¶åˆ°çš„æ‰€æœ‰è¯¥è¿æ¥ä¸Šçš„æ•°æ®è¿›è¡Œå¤„ç†ï¼Œè¿™ä¸ªä¹Ÿæ˜¯æˆ‘ä»¬æœ€æ ¸å¿ƒçš„æ¶ˆæ¯æ¨é€çš„å¤„ç†é€»è¾‘ï¼›å¦å¤–ï¼Œåœ¨é•¿è¿æ¥é€šé“å‘ç”Ÿå¼‚å¸¸é”™è¯¯ï¼Œæˆ–è€…è¿æ¥è¢«å…³é—­æ—¶ï¼Œå¯ä»¥åˆ†åˆ«é€šè¿‡onerrorå’Œoncloseä¸¤ä¸ªäº‹ä»¶æ¥è¿›è¡Œç›‘å¬å¤„ç†ã€‚</p><p>é™¤äº†é€šè¿‡äº‹ä»¶ç›‘å¬ï¼Œæ¥å¯¹é•¿è¿æ¥çš„çŠ¶æ€å˜åŒ–è¿›è¡Œé€»è¾‘å¤„ç†å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡è¿™ä¸ªWebSocketé•¿è¿æ¥ï¼Œå‘æœåŠ¡å™¨å‘é€æ•°æ®ï¼ˆæ¶ˆæ¯ï¼‰ã€‚è¿™ä¸ªåŠŸèƒ½åœ¨å®ç°ä¸Šä¹Ÿéå¸¸ç®€å•ï¼Œä½ åªéœ€è¦è°ƒç”¨WebSocketå¯¹è±¡çš„sendæ–¹æ³•å°±OKäº†ã€‚</p><p>é€šè¿‡é•¿è¿æ¥å‘é€æ¶ˆæ¯çš„ä»£ç è®¾è®¡å¦‚ä¸‹ï¼š</p><pre><code>var sendMsgJson = '{ &quot;type&quot;: 3, &quot;data&quot;: {&quot;senderUid&quot;:' + sender_id + ',&quot;recipientUid&quot;:' + recipient_id + ', &quot;content&quot;:&quot;' + msg_content + '&quot;,&quot;msgType&quot;:1  }}';\n\nwebsocket.send(sendMsgJson);\n</code></pre><p>æ­¤å¤–ï¼Œé’ˆå¯¹WebSocketåœ¨æœåŠ¡ç«¯çš„å®ç°ï¼Œå¦‚æœä½ æ˜¯ä½¿ç”¨JVMï¼ˆJava Virtual Machineï¼ŒJavaè™šæ‹Ÿæœºï¼‰ç³»åˆ—è¯­è¨€çš„è¯ï¼Œæˆ‘æ¨èä½ ä½¿ç”¨æ¯”è¾ƒæˆç†Ÿçš„Java NIOæ¡†æ¶Nettyæ¥åšå®ç°ã€‚</p><p>å› ä¸ºNettyæœ¬èº«å¯¹WebSocketçš„æ”¯æŒå°±å¾ˆå®Œå–„äº†ï¼Œå„ç§ç¼–è§£ç å™¨å’ŒWebSocketçš„å¤„ç†å™¨éƒ½æœ‰ï¼Œè¿™æ ·æˆ‘ä»¬åœ¨ä»£ç å®ç°ä¸Šå°±æ¯”è¾ƒç®€å•ã€‚</p><p>é‡‡ç”¨Nettyå®ç°WebSocket Serverçš„æ ¸å¿ƒä»£ç ï¼Œä½ å¯ä»¥å‚è€ƒä¸‹é¢çš„ç¤ºä¾‹ä»£ç ï¼š</p><pre><code>EventLoopGroup bossGroup =\n                    new EpollEventLoopGroup(serverConfig.bossThreads, new DefaultThreadFactory(&quot;WebSocketBossGroup&quot;, true));\n                    \nEventLoopGroup workerGroup =\n                    new EpollEventLoopGroup(serverConfig.workerThreads, new DefaultThreadFactory(&quot;WebSocketWorkerGroup&quot;, true));\n\nServerBootstrap serverBootstrap = new ServerBootstrap().group(bossGroup, workerGroup).channel(EpollServerSocketChannel.class);\n\nChannelInitializer&lt;SocketChannel&gt; initializer = new ChannelInitializer&lt;SocketChannel&gt;() {\n    @Override\n    protected void initChannel(SocketChannel ch) throws Exception {\n        ChannelPipeline pipeline = ch.pipeline();\n        //å…ˆæ·»åŠ WebSocketç›¸å…³çš„ç¼–è§£ç å™¨å’Œåè®®å¤„ç†å™¨\n        pipeline.addLast(new HttpServerCodec());\n        pipeline.addLast(new HttpObjectAggregator(65536));\n        pipeline.addLast(new LoggingHandler(LogLevel.DEBUG));\n        pipeline.addLast(new WebSocketServerProtocolHandler(&quot;/&quot;, null, true));\n        //å†æ·»åŠ æœåŠ¡ç«¯ä¸šåŠ¡æ¶ˆæ¯çš„æ€»å¤„ç†å™¨\n        pipeline.addLast(websocketRouterHandler);\n        //æœåŠ¡ç«¯æ·»åŠ ä¸€ä¸ªidleå¤„ç†å™¨ï¼Œå¦‚æœä¸€æ®µæ—¶é—´Socketä¸­æ²¡æœ‰æ¶ˆæ¯ä¼ è¾“ï¼ŒæœåŠ¡ç«¯ä¼šå¼ºåˆ¶æ–­å¼€\n        pipeline.addLast(new IdleStateHandler(0, 0, serverConfig.getAllIdleSecond()));\n        pipeline.addLast(closeIdleChannelHandler);\n    }\n}\n\nserverBootstrap.childHandler(initializer);\nserverBootstrap.bind(serverConfig.port).sync(\n</code></pre><p>é¦–å…ˆ<strong>åˆ›å»ºæœåŠ¡å™¨çš„ServerBootstrapå¯¹è±¡</strong>ã€‚Nettyä½œä¸ºæœåŠ¡ç«¯ï¼Œä»ServerBootstrapå¯åŠ¨ï¼ŒServerBootstrapå¯¹è±¡ä¸»è¦ç”¨äºåœ¨æœåŠ¡ç«¯çš„æŸä¸€ä¸ªç«¯å£è¿›è¡Œç›‘å¬ï¼Œå¹¶æ¥å—å®¢æˆ·ç«¯çš„è¿æ¥ã€‚</p><p>æ¥ç€ï¼Œ<strong>é€šè¿‡ChannelInitializerå¯¹è±¡ï¼Œåˆå§‹åŒ–è¿æ¥ç®¡é“ä¸­ç”¨äºå¤„ç†æ•°æ®çš„å„ç§ç¼–è§£ç å™¨å’Œä¸šåŠ¡é€»è¾‘å¤„ç†å™¨</strong>ã€‚æ¯”å¦‚è¿™é‡Œï¼Œæˆ‘ä»¬å°±éœ€è¦æ·»åŠ ä¸ºäº†å¤„ç†WebSocketåè®®ç›¸å…³çš„ç¼–è§£ç å™¨ï¼Œè¿˜è¦æ·»åŠ æœåŠ¡ç«¯æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯çš„ä¸šåŠ¡é€»è¾‘å¤„ç†å™¨ï¼Œå¹¶ä¸”è¿˜åŠ ä¸Šäº†ç”¨äºé€šé“idleè¶…æ—¶ç®¡ç†çš„å¤„ç†å™¨ã€‚</p><p>æœ€åï¼Œ<strong>æŠŠè¿™ä¸ªç®¡é“å¤„ç†å™¨é“¾æŒ‚åˆ°ServerBootstrapï¼Œå†é€šè¿‡bindå’Œsyncæ–¹æ³•ï¼Œå¯åŠ¨ServerBootstrapçš„ç«¯å£è¿›è¡Œç›‘å¬</strong>å°±å¯ä»¥äº†ã€‚</p><h3>æ ¸å¿ƒæ¶ˆæ¯æ”¶å‘é€»è¾‘å¤„ç†</h3><p>å»ºç«‹å¥½WebSocketé•¿è¿æ¥åï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹æœ€æ ¸å¿ƒçš„æ¶ˆæ¯æ”¶å‘æ˜¯æ€ä¹ˆå¤„ç†çš„ã€‚</p><p>åˆšæ‰è®²åˆ°ï¼Œå®¢æˆ·ç«¯å‘é€æ¶ˆæ¯çš„åŠŸèƒ½ï¼Œåœ¨å®ç°ä¸Šå…¶å®æ¯”è¾ƒç®€å•ã€‚æˆ‘ä»¬åªéœ€è¦é€šè¿‡WebSocketå¯¹è±¡çš„sendæ–¹æ³•ï¼Œå°±å¯ä»¥æŠŠæ¶ˆæ¯é€šè¿‡é•¿è¿æ¥å‘é€åˆ°æœåŠ¡ç«¯ã€‚</p><p>é‚£ä¹ˆï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹ä¸€ä¸‹æœåŠ¡ç«¯æ¥æ”¶åˆ°æ¶ˆæ¯åçš„é€»è¾‘å¤„ç†ã€‚</p><p>æ ¸å¿ƒçš„ä»£ç é€»è¾‘åœ¨WebSocketRouterHandlerè¿™ä¸ªå¤„ç†å™¨ä¸­ï¼Œæ¶ˆæ¯æ¥æ”¶å¤„ç†çš„ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p><pre><code> @Override\nprotected void channelRead0(ChannelHandlerContext ctx, WebSocketFrame frame) throws Exception {\n    //å¦‚æœæ˜¯æ–‡æœ¬ç±»å‹çš„WebSocketæ•°æ®\n    if (frame instanceof TextWebSocketFrame) {\n        //å…ˆè§£æå‡ºå…·ä½“çš„æ–‡æœ¬æ•°æ®å†…å®¹\n        String msg = ((TextWebSocketFrame) frame).text();\n        //å†ç”¨JSONæ¥å¯¹è¿™äº›æ•°æ®å†…å®¹è¿›è¡Œè§£æ\n        JSONObject msgJson = JSONObject.parseObject(msg);\n        int type = msgJson.getIntValue(&quot;type&quot;);\n        JSONObject data = msgJson.getJSONObject(&quot;data&quot;);\n        \n        long senderUid = data.getLong(&quot;senderUid&quot;);\n        long recipientUid = data.getLong(&quot;recipientUid&quot;);\n        String content = data.getString(&quot;content&quot;);\n        int msgType = data.getIntValue(&quot;msgType&quot;);\n        //è°ƒç”¨ä¸šåŠ¡å±‚çš„Serviceæ¥è¿›è¡ŒçœŸæ­£çš„å‘æ¶ˆæ¯é€»è¾‘å¤„ç†\n        MessageVO messageContent = messageService.sendNewMsg(senderUid, recipientUid, content, msgType);\n        \n        if (messageContent != null) {\n            JSONObject jsonObject = new JSONObject();\n            jsonObject.put(&quot;type&quot;, 3);\n            jsonObject.put(&quot;data&quot;, JSONObject.toJSON(messageContent));\n                        ctx.writeAndFlush(new TextWebSocketFrame(JSONObject.toJSONString(jsonObject)));\n        }\n    }\n}\n</code></pre><p>è¿™é‡Œçš„WebSocketRouterHandlerï¼Œæˆ‘ä»¬ä¹Ÿæ˜¯é‡‡ç”¨äº‹ä»¶ç›‘å¬æœºåˆ¶æ¥å®ç°ã€‚ç”±äºè¿™é‡Œéœ€è¦å¤„ç†â€œæ¥æ”¶åˆ°â€çš„æ¶ˆæ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦å®ç°channelRead0æ–¹æ³•å°±å¯ä»¥ã€‚</p><p>åœ¨å‰é¢çš„ç®¡é“å¤„ç†å™¨é“¾ä¸­ï¼Œå› ä¸ºæ·»åŠ äº†WebSocketç›¸å…³çš„ç¼–è§£ç å™¨ï¼Œæ‰€ä»¥è¿™é‡Œçš„WebSocketRouterHandleræ¥æ”¶åˆ°çš„éƒ½æ˜¯WebSocketFrameæ ¼å¼çš„æ•°æ®ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä»WebSocketFrameæ ¼å¼çš„æ•°æ®ä¸­ï¼Œè§£æå‡ºæ–‡æœ¬ç±»å‹çš„æ”¶å‘åŒæ–¹UIDå’Œå‘é€å†…å®¹ï¼Œå°±å¯ä»¥è°ƒç”¨åç«¯ä¸šåŠ¡æ¨¡å—çš„å‘æ¶ˆæ¯åŠŸèƒ½ï¼Œæ¥è¿›è¡Œæœ€ç»ˆçš„å‘æ¶ˆæ¯é€»è¾‘å¤„ç†äº†ã€‚</p><p>æœ€åï¼ŒæŠŠéœ€è¦è¿”å›ç»™æ¶ˆæ¯å‘é€æ–¹çš„å®¢æˆ·ç«¯çš„ä¿¡æ¯ï¼Œå†é€šè¿‡writeAndFlushæ–¹æ³•å†™å›å»ï¼Œå°±å®Œæˆæ¶ˆæ¯çš„å‘é€ã€‚</p><p>ä¸è¿‡ï¼Œä»¥ä¸Šçš„ä»£ç åªæ˜¯å¤„ç†æ¶ˆæ¯çš„å‘é€ï¼Œé‚£ä¹ˆé’ˆå¯¹æ¶ˆæ¯ä¸‹æ¨çš„é€»è¾‘å¤„ç†åˆæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ</p><p>åˆšåˆšè®²åˆ°ï¼Œå®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯ï¼Œä¼šé€šè¿‡åç«¯ä¸šåŠ¡æ¨¡å—æ¥è¿›è¡Œæœ€ç»ˆçš„å‘æ¶ˆæ¯é€»è¾‘å¤„ç†ï¼Œè¿™ä¸ªå¤„ç†è¿‡ç¨‹ä¹ŸåŒ…æ‹¬æ¶ˆæ¯çš„æ¨é€è§¦å‘ã€‚</p><p>å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨messageService.sendNewMsgæ–¹æ³•ä¸­ï¼Œç­‰å¾…æ¶ˆæ¯å­˜å‚¨ã€æœªè¯»å˜æ›´éƒ½å®Œæˆåï¼Œå†å¤„ç†å¾…æ¨é€ç»™æ¥æ”¶æ–¹çš„æ¶ˆæ¯ã€‚</p><p>ä½ å¯ä»¥å‚è€ƒä¸‹é¢çš„æ ¸å¿ƒä»£ç ï¼š</p><pre><code>private static final ConcurrentHashMap&lt;Long, Channel&gt; userChannel = new ConcurrentHashMap&lt;&gt;(15000);\n\n    @Override\n    protected void channelRead0(ChannelHandlerContext ctx, WebSocketFrame frame) throws Exception {\n        //å¤„ç†ä¸Šçº¿è¯·æ±‚\n        long loginUid = data.getLong(&quot;uid&quot;);\n        userChannel.put(loginUid, ctx.channel());\n    }\npublic void pushMsg(long recipientUid, JSONObject message) {\n    Channel channel = userChannel.get(recipientUid);\n    if (channel != null &amp;&amp; channel.isActive() &amp;&amp; channel.isWritable()) {\n        channel.writeAndFlush(new TextWebSocketFrame(message.toJSONString()));\n    }\n}\n</code></pre><p>é¦–å…ˆï¼Œæˆ‘ä»¬åœ¨å¤„ç†ç”¨æˆ·å»ºè¿ä¸Šçº¿çš„è¯·æ±‚æ—¶ï¼Œä¼šå…ˆåœ¨ç½‘å…³æœºå†…å­˜è®°å½•ä¸€ä¸ªâ€œå½“å‰è¿æ¥ç”¨æˆ·å’Œå¯¹åº”çš„è¿æ¥â€çš„æ˜ å°„ã€‚</p><p>å½“ç³»ç»Ÿæœ‰æ¶ˆæ¯éœ€è¦æ¨é€æ—¶ï¼Œæˆ‘ä»¬é€šè¿‡æŸ¥è¯¢è¿™ä¸ªæ˜ å°„å…³ç³»ï¼Œå°±èƒ½æ‰¾åˆ°å¯¹åº”çš„è¿æ¥ï¼Œç„¶åå°±å¯ä»¥é€šè¿‡è¿™ä¸ªè¿æ¥ï¼Œå°†æ¶ˆæ¯ä¸‹æ¨ä¸‹å»ã€‚</p><pre><code>public class NewMessageListener implements MessageListener {\n    @Override\n    public void onMessage(Message message, byte[] pattern) {\n        String topic = stringRedisSerializer.deserialize(message.getChannel());\n        //ä»è®¢é˜…åˆ°çš„Redisçš„æ¶ˆæ¯é‡Œè§£æå‡ºçœŸæ­£éœ€è¦çš„ä¸šåŠ¡æ•°æ®\n        String jsonMsg = valueSerializer.deserialize(message.getBody());\n        logger.info(&quot;Message Received --&gt; pattern: {}ï¼Œtopic:{}ï¼Œmessage: {}&quot;, new String(pattern), topic, jsonMsg);\n        JSONObject msgJson = JSONObject.parseObject(jsonMsg);\n        //è§£æå‡ºæ¶ˆæ¯æ¥æ”¶äººçš„UID\n        long otherUid = msgJson.getLong(&quot;otherUid&quot;);\n        JSONObject pushJson = new JSONObject();\n        pushJson.put(&quot;type&quot;, 4);\n        pushJson.put(&quot;data&quot;, msgJson);\n        \n        //æœ€ç»ˆè°ƒç”¨ç½‘å…³å±‚å¤„ç†å™¨å°†æ¶ˆæ¯çœŸæ­£ä¸‹æ¨ä¸‹å»\n        websocketRouterHandler.pushMsg(otherUid, pushJson);\n\n    }\n}\n\n@Override\npublic MessageVO sendNewMsg(long senderUid, long recipientUid, String content, int msgType) {\n    \n    //å…ˆå¯¹å‘é€æ¶ˆæ¯è¿›è¡Œå­˜å‚¨ã€åŠ æœªè¯»ç­‰æ“ä½œ\n    //...\n    // ç„¶åå°†å¾…æ¨é€æ¶ˆæ¯å‘å¸ƒåˆ°Redis\n    redisTemplate.convertAndSend(Constants.WEBSOCKET_MSG_TOPIC, JSONObject.toJSONString(messageVO));\n}\n</code></pre><p>ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥åŸºäºRedisçš„å‘å¸ƒ/è®¢é˜…ï¼Œå®ç°ä¸€ä¸ªæ¶ˆæ¯æ¨é€çš„å‘å¸ƒè®¢é˜…å™¨ã€‚</p><p>åœ¨ä¸šåŠ¡å±‚è¿›è¡Œå‘é€æ¶ˆæ¯é€»è¾‘å¤„ç†çš„æœ€åï¼Œä¼šå°†è¿™æ¡æ¶ˆæ¯å‘å¸ƒåˆ°Redisçš„ä¸€ä¸ªTopicä¸­ï¼Œè¿™ä¸ªTopicè¢«NewMessageListenerä¸€ç›´ç›‘å¬ç€ï¼Œå¦‚æœæœ‰æ¶ˆæ¯å‘å¸ƒï¼Œé‚£ä¹ˆç›‘å¬å™¨ä¼šé©¬ä¸Šæ„ŸçŸ¥åˆ°ï¼Œç„¶åå†å°†æ¶ˆæ¯æäº¤ç»™WebSocketRouterHandlerï¼Œæ¥è¿›è¡Œæœ€ç»ˆæ¶ˆæ¯çš„ä¸‹æ¨ã€‚</p><h3>æ¶ˆæ¯æ¨é€çš„ACK</h3><p>æˆ‘åœ¨<a href=\"https://time.geekbang.org/column/article/129751\">â€œ04 | ACKæœºåˆ¶ï¼šå¦‚ä½•ä¿è¯æ¶ˆæ¯çš„å¯é æŠ•é€’ï¼Ÿâ€</a>ä¸­æœ‰è®²åˆ°ï¼Œå½“ç³»ç»Ÿæœ‰æ¶ˆæ¯ä¸‹æ¨åï¼Œæˆ‘ä»¬ä¼šä¾èµ–å®¢æˆ·ç«¯å“åº”çš„ACKåŒ…ï¼Œæ¥ä¿è¯æ¶ˆæ¯æ¨é€çš„å¯é æ€§ã€‚å¦‚æœæ¶ˆæ¯ä¸‹æ¨åä¸€æ®µæ—¶é—´ï¼ŒæœåŠ¡ç«¯æ²¡æœ‰æ”¶åˆ°å®¢æˆ·ç«¯çš„ACKåŒ…ï¼Œé‚£ä¹ˆæœåŠ¡ç«¯ä¼šè®¤ä¸ºè¿™æ¡æ¶ˆæ¯æ²¡æœ‰æ­£å¸¸æŠ•é€’ä¸‹å»ï¼Œå°±ä¼šè§¦å‘é‡æ–°ä¸‹æ¨ã€‚</p><p>å…³äºACKæœºåˆ¶ç›¸åº”çš„æœåŠ¡ç«¯ä»£ç ï¼Œä½ å¯ä»¥å‚è€ƒä¸‹é¢çš„ç¤ºä¾‹ï¼š</p><pre><code>public void pushMsg(long recipientUid, JSONObject message) {\n    channel.writeAndFlush(new TextWebSocketFrame(message.toJSONString()));\n    //æ¶ˆæ¯æ¨é€ä¸‹å»åï¼Œå°†è¿™æ¡æ¶ˆæ¯åŠ å…¥åˆ°å¾…ACKåˆ—è¡¨ä¸­\n    addMsgToAckBuffer(channel, message);\n}\npublic void addMsgToAckBuffer(Channel channel, JSONObject msgJson) {\n    nonAcked.put(msgJson.getLong(&quot;tid&quot;), msgJson);\n    //å®šæ—¶å™¨é’ˆå¯¹ä¸‹æ¨çš„è¿™æ¡æ¶ˆæ¯åœ¨5såè¿›è¡Œ&quot;æ˜¯å¦ACK&quot;çš„æ£€æŸ¥\n    executorService.schedule(() -&gt; {\n        if (channel.isActive()) {\n            //æ£€æŸ¥æ˜¯å¦è¢«ACKï¼Œå¦‚æœæ²¡æœ‰æ”¶åˆ°ACKå›åŒ…ï¼Œä¼šè§¦å‘é‡æ¨\n            checkAndResend(channel, msgJson);\n        }\n    }, 5000, TimeUnit.MILLISECONDS);\n}\nlong tid = data.getLong(&quot;tid&quot;);\nnonAcked.remove(tid);\nprivate void checkAndResend(Channel channel, JSONObject msgJson) {\n    long tid = msgJson.getLong(&quot;tid&quot;);\n    //é‡æ¨2æ¬¡\n    int tryTimes = 2;                    \n    while (tryTimes &gt; 0) {\n        if (nonAcked.containsKey(tid) &amp;&amp; tryTimes &gt; 0) {\n            channel.writeAndFlush(new TextWebSocketFrame(msgJson.toJSONString()));\n            try {\n                Thread.sleep(2000);\n            } catch (InterruptedException e) {\n                e.printStackTrace();\n            }\n        }\n        tryTimes--;\n    }\n}\n</code></pre><p>ç”¨æˆ·åœ¨ä¸Šçº¿å®Œæˆåï¼ŒæœåŠ¡ç«¯ä¼šåœ¨è¿™ä¸ªè¿æ¥ç»´åº¦çš„å­˜å‚¨é‡Œï¼Œåˆå§‹åŒ–ä¸€ä¸ªèµ·å§‹å€¼ä¸º0çš„åºå·ï¼ˆtidï¼‰ï¼Œæ¯å½“æœ‰æ¶ˆæ¯æ¨é€ç»™å®¢æˆ·ç«¯æ—¶ï¼ŒæœåŠ¡ç«¯ä¼šé’ˆå¯¹è¿™ä¸ªåºå·è¿›è¡ŒåŠ 1æ“ä½œï¼Œä¸‹æ¨æ¶ˆæ¯æ—¶å°±ä¼šæºå¸¦è¿™ä¸ªåºå·è¿åŒæ¶ˆæ¯ä¸€èµ·æ¨ä¸‹å»ã€‚</p><p>æ¶ˆæ¯æ¨é€åï¼ŒæœåŠ¡ç«¯ä¼šå°†å½“å‰æ¶ˆæ¯åŠ å…¥åˆ°ä¸€ä¸ªâ€œå¾…ACK Bufferâ€ä¸­ï¼Œè¿™ä¸ªACK Bufferçš„å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°ç”¨ä¸€ä¸ªConcurrentHashMapæ¥å®ç°ï¼ŒKeyå°±æ˜¯è¿™æ¡æ¶ˆæ¯æºå¸¦çš„åºå·ï¼ŒValueæ˜¯æ¶ˆæ¯æœ¬èº«ã€‚</p><p>å½“æ¶ˆæ¯åŠ å…¥åˆ°è¿™ä¸ªâ€œå¾…ACK Bufferâ€æ—¶ï¼ŒæœåŠ¡ç«¯ä¼šåŒæ—¶åˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨ï¼Œåœ¨ä¸€å®šçš„æ—¶é—´åï¼Œä¼šè§¦å‘â€œæ£€æŸ¥å½“å‰æ¶ˆæ¯æ˜¯å¦è¢«ACKâ€çš„é€»è¾‘ï¼›å¦‚æœå®¢æˆ·ç«¯æœ‰å›ACKï¼Œé‚£ä¹ˆæœåŠ¡ç«¯å°±ä¼šä»è¿™ä¸ªâ€œå¾…ACK Bufferâ€ä¸­ç§»é™¤è¿™æ¡æ¶ˆæ¯ï¼Œå¦åˆ™å¦‚æœè¿™æ¡æ¶ˆæ¯æ²¡æœ‰è¢«ACKï¼Œé‚£ä¹ˆå°±ä¼šè§¦å‘æ¶ˆæ¯çš„é‡æ–°ä¸‹æ¨ã€‚</p><h3>åº”ç”¨å±‚å¿ƒè·³</h3><p>åœ¨äº†è§£äº†å¦‚ä½•é€šè¿‡WebSocketé•¿è¿æ¥ï¼Œæ¥å®Œæˆæœ€æ ¸å¿ƒçš„æ¶ˆæ¯æ”¶å‘åŠŸèƒ½ä¹‹åï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹ï¼Œé’ˆå¯¹è¿™ä¸ªé•¿è¿æ¥ï¼Œæˆ‘ä»¬å¦‚ä½•å®ç°æ–°å¢åŠ çš„åº”ç”¨å±‚å¿ƒè·³åŠŸèƒ½ã€‚</p><p>åº”ç”¨å±‚å¿ƒè·³çš„ä½œç”¨ï¼Œæˆ‘åœ¨<a href=\"https://time.geekbang.org/column/article/134231\">ç¬¬8è¯¾â€œæ™ºèƒ½å¿ƒè·³æœºåˆ¶ï¼šè§£å†³ç½‘ç»œçš„ä¸ç¡®å®šæ€§â€</a>ä¸­ä¹Ÿæœ‰è®²åˆ°è¿‡ï¼Œä¸»è¦æ˜¯ä¸ºäº†è§£å†³ç”±äºç½‘ç»œçš„ä¸ç¡®å®šæ€§ï¼Œè€Œå¯¼è‡´çš„è¿æ¥ä¸å¯ç”¨çš„é—®é¢˜ã€‚</p><p>å®¢æˆ·ç«¯å‘é€å¿ƒè·³åŒ…çš„ä¸»è¦ä»£ç è®¾è®¡å¦‚ä¸‹ï¼Œä¸è¿‡æˆ‘è¿™é‡Œçš„ç¤ºä¾‹ä»£ç åªæ˜¯ä¸€ä¸ªç®€å•çš„å®ç°ï¼Œä½ å¯ä»¥è‡ªè¡Œå‚è€ƒï¼Œç„¶åè‡ªå·±å»å°è¯•åŠ¨æ‰‹å®ç°ï¼š</p><pre><code>//æ¯2åˆ†é’Ÿå‘é€ä¸€æ¬¡å¿ƒè·³åŒ…ï¼Œæ¥æ”¶åˆ°æ¶ˆæ¯æˆ–è€…æœåŠ¡ç«¯çš„å“åº”åˆä¼šé‡ç½®æ¥é‡æ–°è®¡æ—¶ã€‚\nvar heartBeat = {\n    timeout: 120000,\n    timeoutObj: null,\n    serverTimeoutObj: null,\n    reset: function () {\n        clearTimeout(this.timeoutObj);\n        clearTimeout(this.serverTimeoutObj);\n        this.start();\n    },\n    start: function () {\n        var self = this;\n        this.timeoutObj = setTimeout(function () {\n            var sender_id = $(&quot;#sender_id&quot;).val();\n            var sendMsgJson = '{ &quot;type&quot;: 0, &quot;data&quot;: {&quot;uid&quot;:' + sender_id + ',&quot;timeout&quot;: 120000}}';\n            websocket.send(sendMsgJson);\n            self.serverTimeoutObj = setTimeout(function () {\n                websocket.close();\n                $(&quot;#ws_status&quot;).text(&quot;å¤±å»è¿æ¥ï¼&quot;);\n            }, self.timeout)\n        }, this.timeout)\n    },\n}\n</code></pre><p>å®¢æˆ·ç«¯é€šè¿‡ä¸€ä¸ªå®šæ—¶å™¨ï¼Œæ¯2åˆ†é’Ÿé€šè¿‡é•¿è¿æ¥ç»™æœåŠ¡ç«¯å‘é€ä¸€æ¬¡å¿ƒè·³åŒ…ï¼Œå¦‚æœåœ¨2åˆ†é’Ÿå†…æ¥æ”¶åˆ°æœåŠ¡ç«¯çš„æ¶ˆæ¯æˆ–è€…å“åº”ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯çš„ä¸‹æ¬¡2åˆ†é’Ÿå®šæ—¶å™¨çš„è®¡æ—¶ï¼Œä¼šè¿›è¡Œæ¸…é›¶é‡ç½®ï¼Œé‡æ–°è®¡ç®—ï¼›å¦‚æœå‘é€çš„å¿ƒè·³åŒ…åœ¨2åˆ†é’Ÿåæ²¡æœ‰æ”¶åˆ°æœåŠ¡ç«¯çš„å“åº”ï¼Œå®¢æˆ·ç«¯ä¼šæ–­å¼€å½“å‰è¿æ¥ï¼Œç„¶åå°è¯•é‡è¿ã€‚</p><p>æˆ‘åœ¨ä¸‹é¢çš„ä»£ç ç¤ºä¾‹ä¸­ï¼Œæä¾›çš„â€œæœåŠ¡ç«¯æ¥æ”¶åˆ°å¿ƒè·³åŒ…çš„å¤„ç†é€»è¾‘â€çš„å®ç°è¿‡ç¨‹ï¼Œå…¶å®éå¸¸ç®€å•ï¼Œåªæ˜¯å°è£…äº†ä¸€ä¸ªæ™®é€šå›åŒ…æ¶ˆæ¯è¿›è¡Œå“åº”ï¼Œä»£ç è®¾è®¡å¦‚ä¸‹ï¼š</p><pre><code>@Override\nprotected void channelRead0(ChannelHandlerContext ctx, WebSocketFrame frame) throws Exception {\n    long uid = data.getLong(&quot;uid&quot;);\n    long timeout = data.getLong(&quot;timeout&quot;);\n    logger.info(&quot;[heartbeat]: uid = {} , current timeout is {} ms, channel = {}&quot;, uid, timeout, ctx.channel());\n    ctx.writeAndFlush(new TextWebSocketFrame(&quot;{\\&quot;type\\&quot;:0,\\&quot;timeout\\&quot;:&quot; + timeout + &quot;}&quot;));\n}\n</code></pre><p>æˆ‘ä»¬å®é™…åœ¨çº¿ä¸Šå®ç°çš„æ—¶å€™ï¼Œå¯ä»¥é‡‡ç”¨å‰é¢ä»‹ç»çš„â€œæ™ºèƒ½å¿ƒè·³â€æœºåˆ¶ï¼Œé€šè¿‡æœåŠ¡ç«¯å¯¹å¿ƒè·³åŒ…çš„å“åº”ï¼Œæ¥è®¡ç®—æ–°çš„å¿ƒè·³é—´éš”ï¼Œç„¶åè¿”å›ç»™å®¢æˆ·ç«¯æ¥è¿›è¡Œè°ƒæ•´ã€‚</p><p>å¥½ï¼Œåˆ°è¿™é‡Œï¼ŒæœŸæœ«å®æˆ˜çš„ä¸»è¦æ ¸å¿ƒåŠŸèƒ½åŸºæœ¬ä¸Šä¹Ÿè®²è§£å¾—å·®ä¸å¤šäº†ï¼Œç»†èŠ‚æ–¹é¢ä½ å¯ä»¥å†ç¿»ä¸€ç¿»æˆ‘åœ¨<a href=\"https://github.com/coldwalker/Sample\">GitHub</a>ä¸Šæä¾›çš„ç¤ºä¾‹ä»£ç ã€‚</p><p>å¯¹äºå³æ—¶æ¶ˆæ¯åœºæ™¯çš„ä»£ç å®ç°æ¥è¯´ï¼Œå¦‚æœè¦çœŸæ­£è¾¾åˆ°çº¿ä¸Šä½¿ç”¨çš„ç¨‹åº¦ï¼Œç›¸åº”çš„ä»£ç é‡æ˜¯éå¸¸åºå¤§çš„ï¼›è€Œä¸”å¯¹äºåŒä¸€ä¸ªåŠŸèƒ½çš„å®ç°ï¼Œæ ¹æ®ä¸åŒçš„ä½¿ç”¨åœºæ™¯å’Œä¸šåŠ¡ç‰¹å¾ï¼Œå¾ˆå¤šä¸šåŠ¡åœ¨è®¾è®¡ä¸Šä¹Ÿä¼šæœ‰è¾ƒå¤§çš„å·®å¼‚æ€§ã€‚</p><p>æ‰€ä»¥ï¼Œå®æˆ˜è¯¾ç¨‹çš„è®¾è®¡å’Œç¤ºä¾‹ä»£ç åªèƒ½åšåˆ°æŒ‚ä¸€æ¼ä¸‡ï¼Œæˆ‘å°½é‡é€šè¿‡æœ€ç®€åŒ–çš„ä»£ç ï¼Œæ¥è®©ä½ çœŸæ­£äº†è§£æŸä¸€ä¸ªåŠŸèƒ½åœ¨å®ç°ä¸Šæœ€æ ¸å¿ƒçš„æ€æƒ³ã€‚å¹¶ä¸”ï¼Œé€šè¿‡æœŸä¸­å’ŒæœŸæœ«ä¸¤ä¸ªé˜¶æ®µçš„åŠŸèƒ½å‡çº§ä¸å·®å¼‚å¯¹æ¯”ï¼Œä½¿ä½ èƒ½æ„Ÿå—åˆ°è¿™äº›å·®å¼‚å¯¹äºä½¿ç”¨æ–¹ä½“éªŒå’ŒæœåŠ¡ç«¯å‹åŠ›çš„æ”¹å–„ï¼Œä»è€Œå¯ä»¥æ›´æ·±åˆ»åœ°ç†è§£å’ŒæŒæ¡å‰é¢è¯¾ç¨‹ä¸­ç›¸åº”çš„ç†è®ºç‚¹ã€‚</p><h2>å°ç»“</h2><p>ä»Šå¤©çš„æœŸæœ«å®æˆ˜ï¼Œæˆ‘ä»¬ä¸»è¦æ˜¯é’ˆå¯¹æœŸä¸­å®æˆ˜ä¸­IMç³»ç»Ÿè®¾è®¡çš„åŠŸèƒ½ï¼Œæ¥è¿›è¡Œä¼˜åŒ–æ”¹é€ ã€‚</p><p>æ¯”å¦‚ï¼Œ<strong>ä½¿ç”¨åŸºäºWebSocketçš„é•¿è¿æ¥</strong>ï¼Œä»£æ›¿åŸºäºHTTPçš„çŸ­è½®è¯¢ï¼Œæ¥æå‡æ¶ˆæ¯çš„å®æ—¶æ€§ï¼Œå¹¶å¢åŠ äº†<strong>åº”ç”¨å±‚å¿ƒè·³ã€ACKæœºåˆ¶</strong>ç­‰æ–°åŠŸèƒ½ã€‚</p><p>é€šè¿‡è¿™æ¬¡æ ¸å¿ƒä»£ç çš„è®²è§£ï¼Œæ˜¯æƒ³è®©ä½ èƒ½ç†è®ºç»“åˆå®é™…åœ°å»ç†è§£å‰é¢è¯¾ç¨‹è®²åˆ°çš„ï¼ŒIMç³»ç»Ÿè®¾è®¡ä¸­æœ€é‡è¦çš„éƒ¨åˆ†åŠŸèƒ½ï¼Œä¹Ÿå¸Œæœ›ä½ èƒ½è‡ªå·±å°è¯•å»åŠ¨æ‰‹å†™ä¸€å†™ã€‚å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥åŸºäºå·²æœ‰ä»£ç ï¼Œå»å¢åŠ ä¸€äº›ä¹‹å‰è¯¾ç¨‹ä¸­æœ‰è®²åˆ°ï¼Œä½†æ˜¯ç¤ºä¾‹ä»£ç ä¸­æ²¡æœ‰å®ç°çš„åŠŸèƒ½ï¼Œæ¯”å¦‚ç¦»çº¿æ¶ˆæ¯ã€ç¾¤èŠç­‰ã€‚</p><p>æœ€åå†ç»™ä½ ç•™ä¸€ä¸ªæ€è€ƒé¢˜ï¼š<strong>ACKæœºåˆ¶çš„å®ç°ä¸­ï¼Œå¦‚æœå°è¯•å¤šæ¬¡ä¸‹æ¨ä¹‹åä»ç„¶æ²¡æœ‰æˆåŠŸï¼ŒæœåŠ¡ç«¯åç»­åº”è¯¥è¿›è¡Œå“ªäº›å¤„ç†å‘¢ï¼Ÿ</strong></p><p>ä»¥ä¸Šå°±æ˜¯ä»Šå¤©è¯¾ç¨‹çš„å†…å®¹ï¼Œæ¬¢è¿ä½ ç»™æˆ‘ç•™è¨€ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç•™è¨€åŒºä¸€èµ·è®¨è®ºï¼Œæ„Ÿè°¢ä½ çš„æ”¶å¬ï¼Œæˆ‘ä»¬ä¸‹æœŸå†è§ã€‚</p>","neighbors":{"left":{"article_title":"20 | å­˜å‚¨å’Œå¹¶å‘ï¼šä¸‡äººç¾¤èŠç³»ç»Ÿè®¾è®¡ä¸­çš„å‡ ä¸ªéš¾ç‚¹","id":148308},"right":{"article_title":"22 | ç­”ç–‘è§£æƒ‘ï¼šä¸åŒå³æ—¶æ¶ˆæ¯åœºæ™¯ä¸‹æ¶æ„å®ç°ä¸Šçš„å¼‚åŒ","id":151075}},"comments":[{"had_liked":false,"id":140856,"user_name":"å¢™è§’å„¿çš„èŠ±","can_delete":false,"product_type":"c1","uid":1258474,"ip_address":"","ucode":"EE5CAD76175CCF","user_header":"","comment_is_top":false,"comment_ctime":1571061394,"is_pvip":false,"replies":[{"id":"54735","content":"ç½‘ç»œé˜»å¡å’Œæ»‘åŠ¨çª—å£éƒ½æ˜¯åº•å±‚ä¼ è¾“å±‚çš„äº‹æƒ…å‘€ï¼Œå’Œä¸Šå±‚çš„websocketæ²¡å•¥å…³ç³»ï¼Œå¦‚æœæœ‰ç”±äºä¼ è¾“å†…å®¹å¤§å¯¼è‡´æ‹¥å¡çš„é—®é¢˜éœ€è¦è§£å†³çš„æ˜¯websocketå°è£…çš„ä¸šåŠ¡å†…å®¹æ˜¯å¦è¶³å¤Ÿç²¾ç®€ï¼Œæ˜¯å¦éœ€è¦è¿›ä¸€æ­¥å‹ç¼©ï¼Œå’Œwebsocketæœ¬èº«æ— å…³ã€‚websocketè‡ªå¸¦çš„å¿ƒè·³æœºåˆ¶æµè§ˆå™¨å¾ˆå¤šå¹¶ä¸è‡ªåŠ¨æ”¯æŒï¼Œæ‰€ä»¥ä¸€èˆ¬éƒ½æ˜¯è‡ªå·±åº”ç”¨å±‚æ¥å®ç°ï¼Œè‡ªå¸¦çš„å¿ƒè·³æœºåˆ¶åªè¦æœåŠ¡ç«¯è¿‡æ»¤æ‰ä¹Ÿå¹¶ä¸ä¼šå½±å“è¿æ¥æœ¬èº«çš„ç¨³å®šæ€§ã€‚æ‰€ä»¥æœ€å¥½è¿˜æ˜¯é€šè¿‡åŒç«¯æŠ“åŒ…æ¥å…·ä½“åˆ†æï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯ç”±äºé“¾è·¯ä¸­é—´çš„åå‘ä»£ç†ç­‰æœåŠ¡å¯¼è‡´çš„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"coldwalker","uid":"1297490","ctime":1571225170,"ip_address":"","comment_id":140856,"utype":1}],"discussion_count":1,"race_medal":0,"score":"27340865170","product_id":100034901,"comment_content":"æœ‰ä¸ªå¤§ä½¬ç»™æˆ‘è®²ï¼Œç”¨websocketåœ¨å¼±ç½‘ä¸‹å› ä¸ºç½‘ç»œé˜»å¡ï¼Œtcpæ»‘åŠ¨çª—å£ï¼Œä¸æ–­æ–­ç½‘é‡è¿ï¼Œwebsocketè‡ªå·±åˆæœ‰è‡ªå·±çš„å¿ƒè·³æœºåˆ¶ï¼Œå¯¼è‡´æœåŠ¡ç«¯å‹åŠ›å¾ˆå¤§ï¼Œäº‘äº‘ï¼Œæˆ‘è¿˜æ²¡ææ˜ç™½ç©¶ç«Ÿä»€ä¹ˆæ„æ€ã€‚éš¾é“tcpæœ¬èº«ä¸ä¹Ÿæ˜¯è¿™æ ·ï¼Ÿ","like_count":7,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":470595,"discussion_content":"ç½‘ç»œé˜»å¡å’Œæ»‘åŠ¨çª—å£éƒ½æ˜¯åº•å±‚ä¼ è¾“å±‚çš„äº‹æƒ…å‘€ï¼Œå’Œä¸Šå±‚çš„websocketæ²¡å•¥å…³ç³»ï¼Œå¦‚æœæœ‰ç”±äºä¼ è¾“å†…å®¹å¤§å¯¼è‡´æ‹¥å¡çš„é—®é¢˜éœ€è¦è§£å†³çš„æ˜¯websocketå°è£…çš„ä¸šåŠ¡å†…å®¹æ˜¯å¦è¶³å¤Ÿç²¾ç®€ï¼Œæ˜¯å¦éœ€è¦è¿›ä¸€æ­¥å‹ç¼©ï¼Œå’Œwebsocketæœ¬èº«æ— å…³ã€‚websocketè‡ªå¸¦çš„å¿ƒè·³æœºåˆ¶æµè§ˆå™¨å¾ˆå¤šå¹¶ä¸è‡ªåŠ¨æ”¯æŒï¼Œæ‰€ä»¥ä¸€èˆ¬éƒ½æ˜¯è‡ªå·±åº”ç”¨å±‚æ¥å®ç°ï¼Œè‡ªå¸¦çš„å¿ƒè·³æœºåˆ¶åªè¦æœåŠ¡ç«¯è¿‡æ»¤æ‰ä¹Ÿå¹¶ä¸ä¼šå½±å“è¿æ¥æœ¬èº«çš„ç¨³å®šæ€§ã€‚æ‰€ä»¥æœ€å¥½è¿˜æ˜¯é€šè¿‡åŒç«¯æŠ“åŒ…æ¥å…·ä½“åˆ†æï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯ç”±äºé“¾è·¯ä¸­é—´çš„åå‘ä»£ç†ç­‰æœåŠ¡å¯¼è‡´çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571225170,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":140696,"user_name":"lecy_L","can_delete":false,"product_type":"c1","uid":1127659,"ip_address":"","ucode":"7C96DDBB3D1F7E","user_header":"https://static001.geekbang.org/account/avatar/00/11/34/eb/d00aedb0.jpg","comment_is_top":false,"comment_ctime":1571033301,"is_pvip":false,"replies":[{"id":"54467","content":"ç›´æ’­é‚£ä¸€ç« è¯¾ç¨‹é‡Œæœ‰è®²åˆ°å“ˆï¼Œç®€å•çš„è¯å°±ç”¨redisçš„å‘å¸ƒè®¢é˜…å°±å¯ä»¥ã€‚æ‰€æœ‰ç½‘å…³æœºè®¢é˜…æ‰€æœ‰æˆ¿é—´æ¶ˆæ¯ï¼Œå„ç½‘å…³æœºè®¤é¢†æœ¬æœºç»´æŠ¤çš„æˆ¿é—´ç”¨æˆ·ä¿¡æ¯å¹¶ä¸‹æ¨ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"coldwalker","uid":"1297490","ctime":1571058555,"ip_address":"","comment_id":140696,"utype":1}],"discussion_count":2,"race_medal":0,"score":"14455935189","product_id":100034901,"comment_content":"å’¨è¯¢ä¸ªé—®é¢˜ï¼Œæœ›è§£ç­”ã€‚<br>ç½‘å…³æœºè®°å½•ç”¨æˆ·å’Œé“¾æ¥çš„ä¿¡æ¯ï¼Œfinnalåœ¨jvmé‡Œé¢çš„ã€‚ç°åœ¨æˆ‘æœ‰ä¸€ä¸ªè¿™æ ·çš„åœºæ™¯ï¼Œä¸€ä¸ªæˆ¿é—´ï¼ˆç±»ä¼¼ç¾¤èŠï¼‰æœ‰Nä¸ªç”¨æˆ·ï¼ŒæŒ‰ç…§ä¸Šé¢çš„è¯´æ³•æˆ‘è¦æ€ä¹ˆé“¾æ¥åˆ°åŒä¸€ä¸ªæœåŠ¡å™¨ï¼ˆå¤šåº”ç”¨æƒ…å†µï¼‰ï¼Œæˆ–è€…æ˜¯æ€ä¹ˆé€šçŸ¥å…¶ä»–é“¾æ¥ï¼Ÿåœ¨çº¿ç­‰ï¼Œæ€¥","like_count":4,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":470513,"discussion_content":"ç›´æ’­é‚£ä¸€ç« è¯¾ç¨‹é‡Œæœ‰è®²åˆ°å“ˆï¼Œç®€å•çš„è¯å°±ç”¨redisçš„å‘å¸ƒè®¢é˜…å°±å¯ä»¥ã€‚æ‰€æœ‰ç½‘å…³æœºè®¢é˜…æ‰€æœ‰æˆ¿é—´æ¶ˆæ¯ï¼Œå„ç½‘å…³æœºè®¤é¢†æœ¬æœºç»´æŠ¤çš„æˆ¿é—´ç”¨æˆ·ä¿¡æ¯å¹¶ä¸‹æ¨ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571058555,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1127659,"avatar":"https://static001.geekbang.org/account/avatar/00/11/34/eb/d00aedb0.jpg","nickname":"lecy_L","note":"","ucode":"7C96DDBB3D1F7E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":33727,"discussion_content":"è€å¸ˆï¼Œæˆ‘ç°åœ¨æœ‰ä¸ªè¿™æ ·çš„åœ¨çº¿æ•™è‚²çš„åœºæ™¯ã€‚å®æ—¶æ€§è¦æ±‚æé«˜ï¼Œå»¶è¿Ÿè¦åœ¨200msä»¥ä¸‹ï¼Œç›´æ’­æ˜¯ç”¨ç¬¬ä¸‰æ–¹çš„é€šé“ï¼Œé¼ æ ‡äº’åŠ¨ç­‰æ˜¯è‡ªå·±çš„socketæœåŠ¡ã€‚å¦‚æœé‡‡ç”¨å‘å¸ƒè®¢é˜…æ¨¡å¼çš„è¯ï¼Œé˜Ÿåˆ—ä¼šæˆä¸ºå•ç‚¹ææœ‰å¯èƒ½å»¶è¿Ÿé«˜ï¼Œæœ‰å…¶ä»–çš„è®¾è®¡æ–¹æ¡ˆå‚è€ƒå—ï¼Ÿåœºæ™¯æ˜¯æˆ¿é—´æ•™å­¦ï¼Œä¸€ä¸ªæˆ¿é—´æœ‰å‡ ä¸ªæˆ–è€…10æ¥ä¸ªäºº","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571141245,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":140578,"user_name":"å¢™è§’å„¿çš„èŠ±","can_delete":false,"product_type":"c1","uid":1258474,"ip_address":"","ucode":"EE5CAD76175CCF","user_header":"","comment_is_top":false,"comment_ctime":1571011054,"is_pvip":false,"replies":[{"id":"54465","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"coldwalker","uid":"1297490","ctime":1571058246,"ip_address":"","comment_id":140578,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14455912942","product_id":100034901,"comment_content":"å›ç­”é—®é¢˜ï¼Œå…³é—­æ¸…é™¤å®¢æˆ·ç«¯è¿æ¥å’Œå¾…ACKåˆ—è¡¨","like_count":4,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":470450,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571058246,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":243591,"user_name":"Niud","can_delete":false,"product_type":"c1","uid":1573367,"ip_address":"","ucode":"4E9355D6F11F03","user_header":"https://static001.geekbang.org/account/avatar/00/18/01/f7/d3f3429b.jpg","comment_is_top":false,"comment_ctime":1598202450,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10188137042","product_id":100034901,"comment_content":"è€å¸ˆï¼Œwebsocketå’Œmqttå¼€å‘å³æ—¶é€šè®¯ï¼Œè¿™ä¸¤ç§æŠ€æœ¯ä¼˜ç¼ºç‚¹å¯ä»¥è¯´ä¸€ä¸‹å—ï¼Ÿåœ¨åšæŠ€æœ¯é€‰å‹","like_count":2},{"had_liked":false,"id":191130,"user_name":"hellojd_gk","can_delete":false,"product_type":"c1","uid":1679543,"ip_address":"","ucode":"319AF4C1AD568D","user_header":"https://static001.geekbang.org/account/avatar/00/19/a0/b7/1327ae60.jpg","comment_is_top":false,"comment_ctime":1584747317,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10174681909","product_id":100034901,"comment_content":"ä¸€ç›´å¯¹imæ„Ÿå…´è¶£ï¼Œæƒ³æ‰¾ä¸ªå¼€æºçš„é¡¹ç›®ç©ä¸€ä¸‹ã€‚githubçš„ç±»ä¼¼é¡¹ç›®éƒ½å·®ä¸å¤šï¼Œèƒ½æ¨èä¸ªå—ï¼Ÿ","like_count":2},{"had_liked":false,"id":140693,"user_name":"yangzi","can_delete":false,"product_type":"c1","uid":1589251,"ip_address":"","ucode":"83E02FD4C4AC08","user_header":"https://static001.geekbang.org/account/avatar/00/18/40/03/525a1e78.jpg","comment_is_top":false,"comment_ctime":1571032201,"is_pvip":false,"replies":[{"id":"54466","content":"æœ‰ç‚¹å°é—®é¢˜ï¼šç¦»çº¿æ¶ˆæ¯å»ºè®®åœ¨æ¶ˆæ¯å­˜å‚¨å®Œåå°±å­˜ä¸Šï¼Œè¿™æ ·ç¦»çº¿bufferé‡Œçš„æ¶ˆæ¯æ˜¯è¿ç»­çš„ï¼Œä¾¿äºåç»­æ£€æŸ¥è·å–ã€‚å¦å¤–è¿˜éœ€è¦æ¸…é™¤ å¾…ackåˆ—è¡¨ä¸­è¿™æ¡æ¶ˆæ¯ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"coldwalker","uid":"1297490","ctime":1571058416,"ip_address":"","comment_id":140693,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10160966793","product_id":100034901,"comment_content":"å›ç­”é—®é¢˜ï¼šå¦‚æœå¤šæ¬¡ä¸‹æ¨ä»ç„¶æ²¡æœ‰æˆåŠŸï¼Œå…³é—­å®¢æˆ·ç«¯è¿æ¥ï¼Œå°†æœªå›æ‰§çš„æ¶ˆæ¯å­˜å‚¨ä¸ºç¦»çº¿æ¶ˆæ¯ã€‚","like_count":2,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":470512,"discussion_content":"æœ‰ç‚¹å°é—®é¢˜ï¼šç¦»çº¿æ¶ˆæ¯å»ºè®®åœ¨æ¶ˆæ¯å­˜å‚¨å®Œåå°±å­˜ä¸Šï¼Œè¿™æ ·ç¦»çº¿bufferé‡Œçš„æ¶ˆæ¯æ˜¯è¿ç»­çš„ï¼Œä¾¿äºåç»­æ£€æŸ¥è·å–ã€‚å¦å¤–è¿˜éœ€è¦æ¸…é™¤ å¾…ackåˆ—è¡¨ä¸­è¿™æ¡æ¶ˆæ¯ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571058416,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":173580,"user_name":"ç‡ƒç€çš„åŠæ”¯çƒŸ","can_delete":false,"product_type":"c1","uid":1230837,"ip_address":"","ucode":"23C7B588F400A7","user_header":"https://static001.geekbang.org/account/avatar/00/12/c7/f5/4e9a82e9.jpg","comment_is_top":false,"comment_ctime":1579600314,"is_pvip":false,"replies":[{"id":"67350","content":"é’ˆå¯¹å‘é€æ–¹è®¾å¤‡ï¼Œä¸éœ€è¦å›æ¨è¿™æ¡æ¶ˆæ¯ï¼Œä½†æ˜¯éœ€è¦èƒ½æ›´æ–°æœ€æ–°ä¸€æ¡æ¶ˆæ¯çš„â€œç‰ˆæœ¬å·â€æˆ–è€…â€œæ—¶é—´æˆ³â€ï¼Œå› ä¸ºè¿™ä¸ªæ˜¯åœ¨æœåŠ¡ç«¯æ‰ç”Ÿæˆçš„ï¼Œè¿™æ ·å‘é€æ–¹è®¾å¤‡å°±å°±èƒ½æ­£ç¡®æ›´æ–°æœ¬åœ°çš„æ¶ˆæ¯â€œç‰ˆæœ¬å·â€äº†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"coldwalker","uid":"1297490","ctime":1579691091,"ip_address":"","comment_id":173580,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5874567610","product_id":100034901,"comment_content":"è€å¸ˆï¼Œå’¨è¯¢ä¸ªé—®é¢˜ã€‚ä¸ºå•¥ä»£ç ä¸­ï¼Œå³ä½¿ç”¨äº†æ¶ˆæ¯å‘é€ï¼Œä¹Ÿä½¿ç”¨äº†ä¸‹æ¨æ¶ˆæ¯ï¼ˆå‘é€redis topicï¼Œç„¶åç›‘å¬åˆ°äº†topicä¹‹åï¼Œä¸‹æ¨æ¶ˆæ¯ï¼‰ï¼Œé‚£è¿™æ ·å®¢æˆ·ç«¯å²‚ä¸æ˜¯ä¼šæ”¶åˆ°ä¸¤éæ¶ˆæ¯ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":482121,"discussion_content":"é’ˆå¯¹å‘é€æ–¹è®¾å¤‡ï¼Œä¸éœ€è¦å›æ¨è¿™æ¡æ¶ˆæ¯ï¼Œä½†æ˜¯éœ€è¦èƒ½æ›´æ–°æœ€æ–°ä¸€æ¡æ¶ˆæ¯çš„â€œç‰ˆæœ¬å·â€æˆ–è€…â€œæ—¶é—´æˆ³â€ï¼Œå› ä¸ºè¿™ä¸ªæ˜¯åœ¨æœåŠ¡ç«¯æ‰ç”Ÿæˆçš„ï¼Œè¿™æ ·å‘é€æ–¹è®¾å¤‡å°±å°±èƒ½æ­£ç¡®æ›´æ–°æœ¬åœ°çš„æ¶ˆæ¯â€œç‰ˆæœ¬å·â€äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579691091,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":141338,"user_name":"lecy_L","can_delete":false,"product_type":"c1","uid":1127659,"ip_address":"","ucode":"7C96DDBB3D1F7E","user_header":"https://static001.geekbang.org/account/avatar/00/11/34/eb/d00aedb0.jpg","comment_is_top":false,"comment_ctime":1571141275,"is_pvip":false,"discussion_count":8,"race_medal":0,"score":"5866108571","product_id":100034901,"comment_content":"è€å¸ˆï¼Œæˆ‘ç°åœ¨æœ‰ä¸ªè¿™æ ·çš„åœ¨çº¿æ•™è‚²çš„åœºæ™¯ã€‚å®æ—¶æ€§è¦æ±‚æé«˜ï¼Œå»¶è¿Ÿè¦åœ¨200msä»¥ä¸‹ï¼Œç›´æ’­æ˜¯ç”¨ç¬¬ä¸‰æ–¹çš„é€šé“ï¼Œé¼ æ ‡äº’åŠ¨ç­‰æ˜¯è‡ªå·±çš„socketæœåŠ¡ã€‚å¦‚æœé‡‡ç”¨å‘å¸ƒè®¢é˜…æ¨¡å¼çš„è¯ï¼Œé˜Ÿåˆ—ä¼šæˆä¸ºå•ç‚¹ææœ‰å¯èƒ½å»¶è¿Ÿé«˜ï¼Œæœ‰å…¶ä»–çš„è®¾è®¡æ–¹æ¡ˆå‚è€ƒå—ï¼Ÿåœºæ™¯æ˜¯æˆ¿é—´æ•™å­¦ï¼Œä¸€ä¸ªæˆ¿é—´æœ‰å‡ ä¸ªæˆ–è€…10æ¥ä¸ªäºº","like_count":1,"discussions":[{"author":{"id":1250775,"avatar":"https://static001.geekbang.org/account/avatar/00/13/15/d7/96e77edd.jpg","nickname":"é—®å¿ƒ","note":"","ucode":"6808568D61CE36","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":222888,"discussion_content":"å®æ—¶æ€§è¦æ±‚é«˜ï¼ŒéŸ³è§†é¢‘ç”¨çš„åº”è¯¥æ˜¯webrtcï¼Œæˆ–åŸºäºwebrtcåšçš„å§ã€‚webrtcé‡Œé¢æ˜¯æœ‰æ•°æ®é€šé“çš„ï¼Œç›´æ¥ç”¨ä»–ä»¬çš„æ•°æ®é€šé“å°±å¥½äº†ï¼Œè¿™æ ·å°±å¯ä»¥ä¿è¯éŸ³è§†é¢‘å’Œæ“ä½œåŒæ­¥äº†ã€‚å¦‚æœç”¨TCPé•¿è¿ï¼Œä¸€ä½†ç½‘ç»œæŠ–åŠ¨è‚¯å®šä¼šæœ‰å¡é¡¿å’Œå»¶è¿Ÿçš„ã€‚ç”¨UDPçš„è¯ï¼Œå°±æ˜¯çœ‹è°å¯¹åº•å±‚ç®—æ³•ä¼˜åŒ–çš„å¥½äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586179417,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":5,"child_discussions":[{"author":{"id":1127659,"avatar":"https://static001.geekbang.org/account/avatar/00/11/34/eb/d00aedb0.jpg","nickname":"lecy_L","note":"","ucode":"7C96DDBB3D1F7E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1250775,"avatar":"https://static001.geekbang.org/account/avatar/00/13/15/d7/96e77edd.jpg","nickname":"é—®å¿ƒ","note":"","ucode":"6808568D61CE36","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":224341,"discussion_content":"è€ƒè™‘è¿‡æ“ä½œåŒæ­¥å…±ç”¨éŸ³è§†é¢‘çš„é€šé“ï¼Œå£°ç½‘çš„ã€‚ä½†æ˜¯è¢«è€æ¿ç»™å›ç»äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586279901,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":222888,"ip_address":""},"score":224341,"extra":""},{"author":{"id":1250775,"avatar":"https://static001.geekbang.org/account/avatar/00/13/15/d7/96e77edd.jpg","nickname":"é—®å¿ƒ","note":"","ucode":"6808568D61CE36","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1127659,"avatar":"https://static001.geekbang.org/account/avatar/00/11/34/eb/d00aedb0.jpg","nickname":"lecy_L","note":"","ucode":"7C96DDBB3D1F7E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":224694,"discussion_content":"è€æ¿æ²¡è¯´å•¥åŸå› ä¹ˆï¼Ÿå°è±¡é‡Œå£°ç½‘æ˜¯æŒ‰æ—¶é—´æ”¶è´¹ï¼Œæ²¡æœ‰æŒ‰æ•°æ®é‡æ”¶è´¹çš„å§","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586323908,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":224341,"ip_address":""},"score":224694,"extra":""},{"author":{"id":1127659,"avatar":"https://static001.geekbang.org/account/avatar/00/11/34/eb/d00aedb0.jpg","nickname":"lecy_L","note":"","ucode":"7C96DDBB3D1F7E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1250775,"avatar":"https://static001.geekbang.org/account/avatar/00/13/15/d7/96e77edd.jpg","nickname":"é—®å¿ƒ","note":"","ucode":"6808568D61CE36","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":227102,"discussion_content":"æœ‰å…·ä½“èŠè¿‡è¿™ä¸ªé—®é¢˜ï¼Œè¿‡ç¨‹ä¸å¤ªè®°å¾—äº†ã€‚ç»“æœæ˜¯è¯´æœäº†æˆ‘çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586449076,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":224694,"ip_address":""},"score":227102,"extra":""}]},{"author":{"id":1010018,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/69/62/b874af21.jpg","nickname":"é¢›é¡¼","note":"","ucode":"4A6139389C62EA","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":216367,"discussion_content":"æ¯ä¸ªæˆ¿é—´äººéƒ½ä¸å¤šï¼Œredisä¿å­˜ä¸€ä¸ªæˆ¿é—´é‡Œäººå¾—åˆ—è¡¨ï¼Œäººåˆ°ç½‘å…³æœºæ˜ å°„ï¼Œç›´æ¥æŸ¥å‡ºæ¥åï¼Œé€šè¿‡ç½‘å…³æœºä¸‹æ¨å°±å¥½","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585442504,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1127659,"avatar":"https://static001.geekbang.org/account/avatar/00/11/34/eb/d00aedb0.jpg","nickname":"lecy_L","note":"","ucode":"7C96DDBB3D1F7E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1010018,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/69/62/b874af21.jpg","nickname":"é¢›é¡¼","note":"","ucode":"4A6139389C62EA","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":217154,"discussion_content":"å¦‚æœæ‰€æœ‰è¯·æ±‚ç»è¿‡ç½‘å…³æœºï¼Œé‚£ä¹ˆç½‘å…³æœºæ˜¯å¦å¯èƒ½å­˜åœ¨å•ç‚¹é—®é¢˜ï¼Œç°é˜¶æ®µæ¯ä¸ªé“¾æ¥æ¶ˆæ¯é¢‘ç‡æ˜¯60æ¡¢ã€‚å¦‚æœé‡‡ç”¨ç½‘çŠ¶èŠ‚ç‚¹ï¼Œæ¯å°æœºå­éƒ½åšæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¼šæ€æ ·å‘¢ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585503841,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":216367,"ip_address":""},"score":217154,"extra":""}]}]},{"had_liked":false,"id":290833,"user_name":"yuanjm","can_delete":false,"product_type":"c1","uid":1811213,"ip_address":"","ucode":"B0FD1AB91467A3","user_header":"https://static001.geekbang.org/account/avatar/00/1b/a3/0d/d2c302db.jpg","comment_is_top":false,"comment_ctime":1619774388,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1619774388","product_id":100034901,"comment_content":"å’¨è¯¢ä¸ªé—®é¢˜ï¼Œæœ›è§£ç­”ã€‚<br>acké‡æ¨æ—¶ï¼Œé€šè¿‡çº¿ç¨‹æ± çš„å»¶è¿Ÿä»»åŠ¡æ‰§è¡Œï¼Œå¦‚æœ5ç§’å†…æœ‰å¤§é‡æ¶ˆæ¯ï¼Œæ”¾å…¥å»¶è¿Ÿé˜Ÿåˆ—ä¼šä¸ä¼šå¯¼è‡´OOMï¼Œå¦‚æœé‡æ¨å¤±è´¥äº†ï¼Œä¼‘çœ 2ç§’å ç”¨äº†çº¿ç¨‹æ± çš„çº¿ç¨‹ï¼Œå¯¼è‡´å…¶ä»–åœ¨è¯¥æ‰§è¡Œçš„æ—¶é—´ç‚¹çš„éœ€è¦é‡æ¨çš„æ¶ˆæ¯æ’é˜Ÿç­‰å¾…ï¼Œå¯¼è‡´å»¶è¿Ÿé˜Ÿåˆ—è¶Šæ¥è¶Šé•¿ï¼Œè€Œä¸”å¯¼è‡´é‡è¯•æ—¶é—´ä¸€ç›´å»¶é•¿ã€‚<br>æœ‰æ²¡æœ‰æ›´è´´è¿‘ç”Ÿäº§ç¯å¢ƒçš„è®¾è®¡æ–¹æ¡ˆå•Šï¼Œç°åœ¨åœ¨ä¸ºacké‡ä¼ é—®é¢˜å‘æ„ã€‚","like_count":1,"discussions":[{"author":{"id":1649662,"avatar":"https://static001.geekbang.org/account/avatar/00/19/2b/fe/7925eb7e.jpg","nickname":"pdf","note":"","ucode":"A44250955878BB","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":551507,"discussion_content":"åŒå­¦ä½ è§£å†³äº†å—","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1645026660,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":254127,"user_name":"æ´»ç€","can_delete":false,"product_type":"c1","uid":1197612,"ip_address":"","ucode":"551E8A69503115","user_header":"https://static001.geekbang.org/account/avatar/00/12/46/2c/cb8477cd.jpg","comment_is_top":false,"comment_ctime":1603069824,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1603069824","product_id":100034901,"comment_content":"æœåŠ¡ç«¯æ¯ä¸ªç”¨æˆ·2åˆ†é’Ÿå¿ƒè·³æ£€æµ‹è®¡æ—¶ï¼Œæ€ä¹ˆç»´æŠ¤ï¼Œæ˜¯ä¸å¾ˆå ç”¨èµ„æºå‘¢","like_count":0},{"had_liked":false,"id":236934,"user_name":"æ€ç»ªèµ°äº†ç¬å…‰âœ¨","can_delete":false,"product_type":"c1","uid":1101661,"ip_address":"","ucode":"512DD0FA5C024C","user_header":"https://static001.geekbang.org/account/avatar/00/10/cf/5d/99756164.jpg","comment_is_top":false,"comment_ctime":1595592906,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1595592906","product_id":100034901,"comment_content":"è€å¸ˆæœ‰æ²¡æœ‰è¯»è¿‡netty-socketioè¿™ä¸ªæ¡†æ¶ï¼Œå…¶ä¸­çš„AckManagerçš„è®¾è®¡æ€æƒ³æ²¡æœ‰çœ‹æ‡‚ï¼Œå¦‚æœè°ƒç”¨client.sendEvent(String event,AckCallback&lt;?&gt; ackCallback,Object ... data) æ–¹æ³•ï¼ŒæœåŠ¡ç«¯æ²¡æœ‰æ”¶åˆ°å®¢æˆ·ç«¯çš„ack,æœåŠ¡ç«¯è¦å¦‚ä½•è®¾ç½®é‡å‘å‘¢ï¼Ÿ","like_count":0},{"had_liked":false,"id":214470,"user_name":"xuan","can_delete":false,"product_type":"c1","uid":1634582,"ip_address":"","ucode":"01892B5A2F3056","user_header":"https://static001.geekbang.org/account/avatar/00/18/f1/16/c3ae1a4c.jpg","comment_is_top":false,"comment_ctime":1588754213,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1588754213","product_id":100034901,"comment_content":"è€å¸ˆï¼Œè¯·é—®å¦‚æœå‘é€äº†ä¸€æ¡æ¶ˆæ¯ï¼Œæ¶ˆæ¯è¢«å‘å¸ƒåˆ°redisä¸Šåï¼Œå¦‚æœæ¥æ”¶æ–¹æ²¡æœ‰ä¸Šçº¿ï¼Œé‚£ä¹ˆå°±æ‰¾ä¸åˆ°æ¥æ”¶æ–¹çš„channelæ¥å‘é€ï¼Œæ€ä¹ˆåŠ","like_count":0},{"had_liked":false,"id":175439,"user_name":"greensky01","can_delete":false,"product_type":"c1","uid":1002581,"ip_address":"","ucode":"9C1B0EBFC603D1","user_header":"https://static001.geekbang.org/account/avatar/00/0f/4c/55/879a4443.jpg","comment_is_top":false,"comment_ctime":1580720886,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1580720886","product_id":100034901,"comment_content":"è€å¸ˆï¼Œâ€œåº”ç”¨å±‚å¿ƒè·³â€ä¸€èŠ‚ä¸­çš„ä»£ç ç¤ºä¾‹ï¼š<br><br>var self = this;<br>this.timeoutObj = setTimeout(function () {<br>    ...<br>    self.serverTimeoutObj = setTimeout(function () {<br>         ...}, self.timeout)<br>    }, this.timeout)<br>}<br><br>è¯·é—®è¿™é‡Œçš„å¤–å±‚çš„ self = this æ˜¯ä¸ºäº†ä»€ä¹ˆï¼Ÿ","like_count":0},{"had_liked":false,"id":168711,"user_name":"overland","can_delete":false,"product_type":"c1","uid":1208835,"ip_address":"","ucode":"609A463519E5F0","user_header":"https://static001.geekbang.org/account/avatar/00/12/72/03/da1fcc81.jpg","comment_is_top":false,"comment_ctime":1578145520,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1578145520","product_id":100034901,"comment_content":"è¿è¡Œèµ·æ¥ç°åœ¨å¿ƒè·³è¿™å—æ„Ÿè§‰æœ‰é—®é¢˜ï¼Œæ¯éš”å…­åˆ†é’Ÿå°±ä¸»åŠ¨æ–­å¼€è¿æ¥äº†ï¼Œé‚£è¿™æ ·å¿ƒè·³å°±æ²¡æ„ä¹‰äº†å§ï¼Œæœ‰è°èƒ½å¸®å¿™å›ç­”ä¸‹å—","like_count":0,"discussions":[{"author":{"id":1206833,"avatar":"https://static001.geekbang.org/account/avatar/00/12/6a/31/83e2fe48.jpg","nickname":"HOTPOOR-@xialiwei","note":"","ucode":"E51B83A875B6B1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":258120,"discussion_content":"æˆ‘çš„å®è·µä½“éªŒè¡¨æ˜ï¼Œå¦‚æœç”¨æˆ·æ˜¯VPNè¿‡æ¥ï¼Œéƒ¨åˆ†åªæœ‰30ç§’ï¼Œæ ¹æœ¬æ¥ä¸åŠå¿ƒè·³åŒ…ã€‚åªèƒ½èµ°é‡è¿ã€‚è¦ä¹ˆå°±æ˜¯é—´éš”æ›´çŸ­æ—¶é—´å‘å¿ƒè·³åŒ…ï¼Œä¿æ´»ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588649800,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":168554,"user_name":"overland","can_delete":false,"product_type":"c1","uid":1208835,"ip_address":"","ucode":"609A463519E5F0","user_header":"https://static001.geekbang.org/account/avatar/00/12/72/03/da1fcc81.jpg","comment_is_top":false,"comment_ctime":1578109875,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1578109875","product_id":100034901,"comment_content":"è¯·æ•™è€å¸ˆä¸ªé—®é¢˜ï¼Œdemoä¸Šçš„å°†æŸ¥è¯¢æ€»æœªè¯»æ•°åˆ æ‰ï¼Œç„¶åå¿ƒè·³æœºåˆ¶ï¼Œå°±å…­åˆ†é’Ÿè‡ªåŠ¨æ–­å¼€äº†ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Œå¿ƒè·³æ¯ä¸¤åˆ†é’Ÿå‘æ¶ˆæ¯ï¼Œéš¾é“ä¸æ˜¯æœ‰æ¶ˆæ¯ä¼ è¾“å—ï¼Œæ±‚è€å¸ˆè§£ç­”","like_count":0},{"had_liked":false,"id":148713,"user_name":"rachel.li","can_delete":false,"product_type":"c1","uid":1645001,"ip_address":"","ucode":"D326B61D8C0769","user_header":"https://static001.geekbang.org/account/avatar/00/19/19/c9/d0f2c32c.jpg","comment_is_top":false,"comment_ctime":1573053013,"is_pvip":false,"replies":[{"id":"57780","content":"ä½ è¯´çš„è¿™ä¸ªæ˜¯ç¤ºä¾‹ä»£ç è¿è¡Œçš„é—®é¢˜å—ï¼Ÿç¤ºä¾‹ä»£ç é»˜è®¤ä¼šé€šè¿‡embedded çš„æ–¹å¼åœ¨jvmé‡Œè‡ªåŠ¨å¯åŠ¨ä¸€ä¸ªå…¼å®¹redisåè®®çš„æ¨¡æ‹Ÿredisä¾›ä½¿ç”¨ã€‚å¦‚æœæœ¬æœºè¿˜é¢å¤–èµ·äº†redisçš„è¯éœ€è¦çœ‹ä¸‹ç«¯å£æ˜¯å¦å­˜åœ¨å†²çªã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"coldwalker","uid":"1297490","ctime":1573477185,"ip_address":"","comment_id":148713,"utype":1}],"discussion_count":3,"race_medal":0,"score":"1573053013","product_id":100034901,"comment_content":"è€å¸ˆä½ å¥½ï¼Œæˆ‘ç”µè„‘rediså·²ç»å¯åŠ¨ï¼Œä½†æ˜¯é¡¹ç›®å¯åŠ¨çš„æ—¶å€™æŠ¥é”™å¯åŠ¨ä¸äº†redisã€‚debugæŸ¥çœ‹äº†é”™è¯¯è¯´creating server tcp..........no such file or directoryï¼Œç„¶åè°·æ­Œäº†æŒ‰ç½‘ä¸Šçš„åŠæ³•é‡æ–°æŒ‰é¡ºåºé‡æ–°è¿æ¥redisï¼Œå¯åŠ¨é¡¹ç›®è¿˜æ˜¯æŠ¥é‚£ä¸ªé”™ï¼Œä½†æ˜¯æˆ‘å…¶ä»–é¡¹ç›®æ˜¯æ­£å¸¸çš„ã€‚æ‚¨æœ‰ä»€ä¹ˆæ€è·¯ä¸","like_count":0,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":473580,"discussion_content":"ä½ è¯´çš„è¿™ä¸ªæ˜¯ç¤ºä¾‹ä»£ç è¿è¡Œçš„é—®é¢˜å—ï¼Ÿç¤ºä¾‹ä»£ç é»˜è®¤ä¼šé€šè¿‡embedded çš„æ–¹å¼åœ¨jvmé‡Œè‡ªåŠ¨å¯åŠ¨ä¸€ä¸ªå…¼å®¹redisåè®®çš„æ¨¡æ‹Ÿredisä¾›ä½¿ç”¨ã€‚å¦‚æœæœ¬æœºè¿˜é¢å¤–èµ·äº†redisçš„è¯éœ€è¦çœ‹ä¸‹ç«¯å£æ˜¯å¦å­˜åœ¨å†²çªã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573477185,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1104869,"avatar":"https://static001.geekbang.org/account/avatar/00/10/db/e5/26c2f7de.jpg","nickname":"å¥”è·‘çš„å°é»„ç‰›","note":"","ucode":"C4E014CA41CB66","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":352079,"discussion_content":"æˆ‘æœ¬æœºæ²¡æœ‰å¯åŠ¨redisï¼Œä¹Ÿä¼šæœ‰è¿™ä¸ªé—®é¢˜","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1614596414,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1104869,"avatar":"https://static001.geekbang.org/account/avatar/00/10/db/e5/26c2f7de.jpg","nickname":"å¥”è·‘çš„å°é»„ç‰›","note":"","ucode":"C4E014CA41CB66","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":352078,"discussion_content":"ç¤ºä¾‹ä»£ç å¯åŠ¨æ—¶æŠ¥é”™ã€‚Error creating bean with name &#39;embededRedis&#39;: Invocation of init method failed; nested exception is java.lang.RuntimeException: Can&#39;t start redis server.\n\nè¯·é—®æ€ä¹ˆè§£å†³çš„ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1614596276,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":145231,"user_name":"é“æŸ±","can_delete":false,"product_type":"c1","uid":1221419,"ip_address":"","ucode":"86306660251EF3","user_header":"https://static001.geekbang.org/account/avatar/00/12/a3/2b/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1572233477,"is_pvip":false,"replies":[{"id":"56476","content":"å—¯ï¼Œçœ‹äº†ä¸€ä¸‹ç¡®å®å­˜åœ¨è¿™ä¸ªé—®é¢˜ï¼Œæ„Ÿè°¢åé¦ˆï¼Œæœ€æ–°ä»£ç å·²ç»ä¿®å¤è¿™ä¸ªé—®é¢˜å•¦ï¼ŒæŠŠå¾…ackåˆ—è¡¨æ”¾å…¥åˆ°channelçš„attré‡Œé¢äº†ï¼Œé¿å…å¤ç”¨å¯¼è‡´æ··ä¹±çš„é—®é¢˜ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"coldwalker","uid":"1297490","ctime":1572494586,"ip_address":"","comment_id":145231,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1572233477","product_id":100034901,"comment_content":"ackæœºåˆ¶é‡Œæåˆ°â€œæœåŠ¡ç«¯ä¼šåœ¨è¿™ä¸ªè¿æ¥ç»´åº¦çš„å­˜å‚¨é‡Œï¼Œåˆå§‹åŒ–ä¸€ä¸ªèµ·å§‹å€¼ä¸º 0 çš„åºå·ï¼ˆtidï¼‰â€ï¼Œä½†æ˜¯è€å¸ˆæ‚¨çš„ä»£ç é‡Œå®é™…ä¸Šæ‰€æœ‰çš„channelæ˜¯å…¬ç”¨ä¸€ä¸ªwebsockethandlerï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨åŒä¸€ä¸ªå¯¹è±¡ï¼Œé‚£ä¹ˆè¿™ä¸ªconcurrenhashmapå®é™…ä¸Šæ˜¯è¢«æ‰€æœ‰è¿æ¥å…±äº«çš„å§ï¼Œè¿™æ ·è®¾è®¡éš¾é“ä¸ä¼šé€ æˆackæ¶ˆæ¯ç¡®è®¤è¢«è¦†ç›–å—(eg:channel1ä¸­tidä¸º1çš„ackè¢«channel2ä¸­tidä¸º1çš„ackç¡®è®¤è¦†ç›–äº†)","like_count":0,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":472302,"discussion_content":"å—¯ï¼Œçœ‹äº†ä¸€ä¸‹ç¡®å®å­˜åœ¨è¿™ä¸ªé—®é¢˜ï¼Œæ„Ÿè°¢åé¦ˆï¼Œæœ€æ–°ä»£ç å·²ç»ä¿®å¤è¿™ä¸ªé—®é¢˜å•¦ï¼ŒæŠŠå¾…ackåˆ—è¡¨æ”¾å…¥åˆ°channelçš„attré‡Œé¢äº†ï¼Œé¿å…å¤ç”¨å¯¼è‡´æ··ä¹±çš„é—®é¢˜ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572494586,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":140768,"user_name":"joylee109","can_delete":false,"product_type":"c1","uid":1436426,"ip_address":"","ucode":"ACADE2A155BB04","user_header":"https://static001.geekbang.org/account/avatar/00/15/eb/0a/038d0954.jpg","comment_is_top":false,"comment_ctime":1571045645,"is_pvip":false,"replies":[{"id":"54469","content":"å¯¹äºç»è¿‡è®¤è¯çš„ç”¨æˆ·ï¼Œå®ç°ä¸Šå¯ä»¥ä¸éœ€è¦å†å¸¦ä¸Šå‘é€æ–¹uidï¼Œè¿™é‡Œæ˜¯æƒ³ç½‘å…³æœºä¸ä¾èµ–è®¤è¯ä¿¡æ¯ï¼Œå®ç°ä¸Šç½‘å…³æœºä»sessionè·å–å®Œå…¨æ²¡é—®é¢˜ã€‚å¦å¤–è¿™é‡Œåªæ˜¯ä¸ªæ¼”ç¤ºdemoï¼Œçº¿ä¸Šçš„è¯èµ·ç ä¼šèµ°tlsçš„wssåè®®ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"coldwalker","uid":"1297490","ctime":1571058825,"ip_address":"","comment_id":140768,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1571045645","product_id":100034901,"comment_content":"è€å¸ˆï¼Œä½ å¥½ã€‚websocket æƒ³æœåŠ¡å™¨ä¼ é€æ•°æ®çš„æ—¶å€™ï¼Œ sender_id æ˜¯æ˜æ–‡ä¼ é€å˜›ï¼Ÿç°åœ¨ç”¨æˆ·å·²ç»ç™»å½•äº†ç½‘ç«™ï¼Œè®¤è¯æ–¹å¼å¯èƒ½æ˜¯ï¼šsession ,æˆ–è€… jwt æ–¹å¼ï¼Œæˆ–è€…å…¶ä»–æ–¹å¼ã€‚æ—¢ç„¶ç”¨æˆ·å·²ç»ç™»å½•ï¼Œä¸ºä»€ä¹ˆè¿˜è¦åœ¨ä¼ é€æ•°æ®åˆ°åç«¯çš„æ—¶å€™ï¼Œå°†sender_id æ˜æ–‡å¸¦ä¸Šå‘¢ï¼Ÿæ„Ÿè§‰æ˜æ–‡ä¼ é€ sender_id åˆ°åç«¯ä¸å®‰å…¨ã€‚","like_count":0,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":470547,"discussion_content":"å¯¹äºç»è¿‡è®¤è¯çš„ç”¨æˆ·ï¼Œå®ç°ä¸Šå¯ä»¥ä¸éœ€è¦å†å¸¦ä¸Šå‘é€æ–¹uidï¼Œè¿™é‡Œæ˜¯æƒ³ç½‘å…³æœºä¸ä¾èµ–è®¤è¯ä¿¡æ¯ï¼Œå®ç°ä¸Šç½‘å…³æœºä»sessionè·å–å®Œå…¨æ²¡é—®é¢˜ã€‚å¦å¤–è¿™é‡Œåªæ˜¯ä¸ªæ¼”ç¤ºdemoï¼Œçº¿ä¸Šçš„è¯èµ·ç ä¼šèµ°tlsçš„wssåè®®ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571058825,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}