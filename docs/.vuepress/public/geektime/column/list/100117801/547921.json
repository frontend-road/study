{"id":547921,"title":"06｜手写CPU（一）：迷你CPU架构设计与取指令实现","content":"<p>你好，我是LMOS。</p><p>经过上一节课的学习，我们已经知道了一个基于RISC-V指令集设计的CPU，必须要实现哪些指令。从这节课开始，我们就可以着手设计和实现MiniCPU了。</p><p>我会先跟你讲讲什么是流水线，在CPU中使用流水线的好处是什么？然后，我们再以经典的五级流水线为例，讲解CPU流水线的五个阶段。接着设计出我们MiniCPU的总体结构，并根据规划的五级流水线，完成流水线的第一步——取指模块的设计。课程的配套代码可以从<a href=\"https://gitee.com/lmos/Geek-time-computer-foundation.git\">这里</a>下载。</p><p>话不多说，让我们正式开始今天的学习吧。</p><h2>什么是CPU流水线？</h2><p>说到流水线，你是否会马上想到我们打工人的工厂流水线？没错，高大上的CPU流水线其实和我们打工人的流水线是一样的。</p><p>假如我们在冰墩墩工厂上班，生产流水线分为五个步骤，如下图所示：</p><p><img src=\"https://static001.geekbang.org/resource/image/4e/e0/4e68e7b1f59cedb8723b32141ac12fe0.jpg?wh=1920x852\" alt=\"图片\"></p><p>在冰墩墩生产线上需要至少五个工人，各自负责模具制作、模具清洗、模具抛光、硅胶塑形和融入图案这五个环节中的一个。最简单的方法自然是：同一时刻只有一个冰墩墩在制作。但是冬奥会的热度让市场上的冰墩墩供应不足，为了早日实现“人手一墩”的目标，有什么提升生产效率的办法呢？</p><p>稍微想想就知道，生产线上一个人在制作冰墩墩的时候，另外四个工人都处于空闲状态，显然这是对人力资源的极大浪费。想要提高效率，我们不妨在第一个冰墩墩模具制作出来进入清洗阶段的时候，马上开始进行第二个冰墩墩模具的制作，而不是等到第一个冰墩墩全部步骤做完后，才开始制作下一个。</p><!-- [[[read_end]]] --><p>这样，后续生产中就能够保证五个工人一直处于工作状态，不会造成人员的闲置而产线的冰墩墩就好像流水一样源源不断地产出，因此我们称这种生产方式为流水线。</p><p>在CPU中也是使用类似的流水线作业。以经典的五级流水线为例，流水线中一条指令的生命周期分为五个阶段：</p><p><strong>取指阶段（Instruction Fetch）</strong>：取指阶段是指将指令从存储器中读取出来的过程。程序指针寄存器用来指定当前指令在存储器中的位置。读取一条指令后，程序指针寄存器会根据指令的长度自动递增，或者改写成指定的地址。</p><p><strong>译码阶段（Instruction Decode）</strong>：指令译码是指将存储器中取出的指令进行翻译的过程。指令译码器对指令进行拆分和解释，识别出指令类别以及所需的各种操作数。</p><p><strong>执行阶段（Instruction Execute）</strong>：指令执行是指对指令进行真正运算的过程。例如指令是一条加法运算指令，则对操作数进行相加操作；如果是一条乘法运算指令，则进行乘法运算。在“执行”阶段最关键的模块为算术逻辑单元（Arithmetic Logical Unit，ALU），它是实施具体运算的硬件功能单元。</p><p><strong>访存阶段（Memory Access）</strong>：访存是指存储器访问指令将数据从存储器中读出，或写入存储器的过程。</p><p><strong>写回阶段（Write-Back）</strong>：写回是指将指令执行的结果写回通用寄存器的过程。如果是普通运算指令，该结果值来自于“执行”阶段计算的结果；如果是存储器读指令，该结果来自于“访存”阶段从存储器中读取出来的数据。</p><p>和上述的冰墩墩生产线的流水作业一样，为了提高效率，CPU使用流水线也是为了提高处理器的性能。</p><p><img src=\"https://static001.geekbang.org/resource/image/c3/3a/c39053403fc1c3bf6e33392952d2c33a.jpg?wh=1920x906\" alt=\"图片\"></p><p>对照上图，CPU在第一个时钟周期T内完成取指操作。然后在第二个时钟周期2T内对上一条指令进行译码的同时，取下一条指令。接着在第三个时钟周期3T内就有取指、译码和执行3个操作同时进行……以此类推，五级流水线的CPU内就可以同时进行5个操作。这样平均下来，就相当于每条指令只需要五分之一的时钟周期时间来完成。</p><p>总体上看，流水线提高了指令的处理速度，缩短了程序执行的时间。</p><p>那我们能不能把流水线的思想，引入到我们的MiniCPU中呢？答案是肯定的。具体如何实现呢？我们接着往下看。</p><h2>MiniCPU的架构</h2><p>先明确一下我们想实现的目标：使用Verilog硬件描述语言，基于RV32I指令集，设计一个32位的经典五级流水线的处理器核。它将会支持运行大多数RV32I的基础指令。</p><p>那什么样的架构设计才能实现这个目标呢？参照CPU流水线的五个步骤，我们可以对处理器核的各个功能模块进行划分，主要模块包括指令提取单元、指令译码单元、整型执行单元、访问存储器和写回结果等单元模块。</p><p>根据上面的模块划分，我们可以设计出MiniCPU的整体框架，如下图所示：</p><p><img src=\"https://static001.geekbang.org/resource/image/31/dd/31b586c344cd7d0127775e7ff63711dd.jpg?wh=1920x1289\" alt=\"图片\"></p><p>这张图片中一个方框就表示一个模块，方框里面的文字就是模块的名字，箭头则表示模块与模块之间的信号传输关系。</p><p>从图中可以看到，我们要设计的不仅仅是一个CPU内核了，它更像是一个SOC（System on Chip的缩写）。</p><p>因为我们要对它进行一些仿真验证，就必须要包含存放指令、数据的ROM和RAM，还有一些简单的外设。比如用于串口通信的UART以及一些通用输入、输出端口GPIO都属于外设。CPU通过系统总线（System Bus）和这些外设进行通信。</p><p>下面我们先快速了解一下，在我们这个CPU架构中，体现五级流水线的主要模块有哪些。</p><p>首先我们来看 <strong>pre_if模块</strong>，这里我把它叫作分支预测或者预读取模块，因为它主要是先对上一个指令进行预处理，判断是不是分支跳转指令。如果是跳转指令，则产生跳转后的PC值，并对下一条指令进行预读取。</p><p>然后是取指通路模块，即 <strong>if_id模块</strong>。它是取指到译码之间的模块，上面的指令预读取之后就会首先送入if_id模块，如果当前流水线没有发出指令清除信号，if_id模块就会把指令送到译码模块。</p><p>接下来是 <strong>id_ex模块</strong>，它是译码到执行之间的模块，用于将完成指令译码之后的寄存器索引值，以及指令执行的功能信息，根据流水线控制模块的控制信号，选择性地发送给执行模块去执行。</p><p>指令译码之后便可以进行指令执行，<strong>ex_mem模块</strong>负责指令执行之后将数据写入存储器中或者从存储器中读出数据的过程。</p><p>最后由 <strong>mem_wb模块</strong>将指令执行的运算结果或者从存储器读出的数据，写回到通用寄存器。到这里，处理器流水线的总体结构就设计好啦。</p><p>接下来我们先完成流水线第一步，即取指模块的设计与实现。</p><h2>流水线的第一步：指令预读取</h2><p>我们的MiniCPU流水线的第一步是指令预读取，也就是先把指令从存储器中读出。</p><p>由于我们的指令长度是32位的，也就是一条指令在存储器中占有4个字节的空间，所以一般情况下，CPU中的程序计数器（PC）是以4递增的。</p><p>但是，如果你熟悉计算机程序就应该知道，我们的程序通常不是从头到尾执行一次就完事了，往往还需要调用函数或者循环执行某一段程序的操作。</p><p>而这样的操作，在硬件底层的CPU里面就涉及分支跳转指令了。为了实现程序分支跳转功能，就需要我们的预读取模块来处理。</p><p>我先把这个模块的Verilog代码给你展示一下，再具体给你讲解：</p><pre><code class=\"language-verilog\">module pre_if (\n&nbsp; &nbsp; input [31:0] instr,\n&nbsp; &nbsp; input [31:0] pc,\n\n&nbsp; &nbsp; output [31:0] pre_pc\n);\n\n&nbsp; &nbsp; wire is_bxx = (instr[6:0] == `OPCODE_BRANCH);&nbsp; &nbsp;//条件跳转指令的操作码\n&nbsp; &nbsp; wire is_jal = (instr[6:0] == `OPCODE_JAL) ;&nbsp; &nbsp; &nbsp;//无条件跳转指令的操作码\n&nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; //B型指令的立即数拼接\n&nbsp; &nbsp; wire [31:0] bimm&nbsp; = {{20{instr[31]}}, instr[7], instr[30:25], instr[11:8], 1'b0};\n&nbsp; &nbsp; //J型指令的立即数拼接\n&nbsp; &nbsp; wire [31:0] jimm&nbsp; = {{12{instr[31]}}, instr[19:12], instr[20], instr[30:21], 1'b0};\n\n&nbsp; &nbsp; //指令地址的偏移量\n&nbsp;   wire [31:0] adder = is_jal ? jimm : (is_bxx &amp; bimm[31]) ? bimm : 4;\n&nbsp; &nbsp; assign pre_pc = pc + adder;\n\nendmodule\n</code></pre><p>我们来看看第八行和第九行代码，分别是根据指令的低7位操作码，判断是否是条件跳转指令或是无条件跳转指令。</p><p>其实上一节课的RISC-V指令架构中，我们讲过RISC-V指令集中有两类分支跳转指令，分别是<strong>条件跳转指令</strong>和<strong>无条件跳转指令</strong>。</p><p>条件跳转指令格式如下表所示：</p><p><img src=\"https://static001.geekbang.org/resource/image/70/37/70c2682fbbd1f9f3f4d14d7f5d5cd337.jpg?wh=3960x1710\" alt=\"\"></p><p>从这张表格我们可以发现，条件跳转指令的操作码，也就是指令中的低7位数都是 7’b1100011。根据这一特点，我们就可以在指令解码之前，判断出接下来可能会发生跳转。</p><p>我们结合代码来看看。下面的Verilog语句就是跳转指令的判断，其中的`OPCODE_BRANCH 已经通过宏定义为 7’b1100011。</p><pre><code class=\"language-verilog\">&nbsp; &nbsp; wire is_bxx = (instr[6:0] == `OPCODE_BRANCH);&nbsp; &nbsp;//条件跳转指令的操作码\n</code></pre><p>条件跳转指令执行时是否发生跳转，要根据相关的数据来判断，这就需要指令执行之后才能知道是否需要跳转（具体如何判断，我们后面第十节课再展开）。</p><p><img src=\"https://static001.geekbang.org/resource/image/a0/09/a08a9d2a3e693e95bd035af3673bb009.jpg?wh=1920x812\" alt=\"图片\"></p><p>但是，我们的CPU是多级流水线架构，一条指令执行需要多个时钟周期。如果要等到跳转指令执行完成之后再去取下一条指令，就会降低我们的指令执行效率。</p><p>而指令预读取模块刚好可以解决这个问题。不管指令是否跳转，都提前把跳转之后的下一条指令从存储器中读取出来，以备流水线的下一阶段使用，这就提高了CPU的执行效率。</p><p>以下代码就是根据条件跳转指令的格式，对指令中的立即数进行拼接，为指令跳转时的PC提供偏移量。</p><pre><code class=\"language-verilog\">&nbsp;//B型指令的立即数拼接\nwire [31:0] bimm&nbsp; = {{20{instr[31]}}, instr[7], instr[30:25], instr[11:8], 1'b0};\n</code></pre><p>同样地，无条件跳转指令也用这种方式进行预处理。如下图的jal跳转指令的格式，它的操作码为7’b1101111。<br>\n<img src=\"https://static001.geekbang.org/resource/image/10/c4/1027ff24d1dc411c05670099e27fa8c4.jpg?wh=3905x710\" alt=\"\"></p><p>根据指令的操作码，预译码电路就可以判断出是否为无条件跳转指令。下面就是无条件跳转指令的判断的Verilog语句，其中的`OPCODE_BRANCH已经通过宏定义为 7’b1101111。</p><pre><code class=\"language-verilog\">&nbsp; &nbsp;wire is_jal = (instr[6:0] == `OPCODE_JAL) ;&nbsp; &nbsp; &nbsp;//无条件跳转指令的操作码\n</code></pre><p>顾名思义，无条件跳转指令就是不需要判断其他的任何条件，直接跳转。我们继续结合代码理解，这行代码的意思是，根据jal指令的格式对指令中的立即数进行拼接，为指令跳转时的PC提供偏移量。</p><pre><code class=\"language-verilog\">//J型指令的立即数拼接\nwire [31:0] jimm&nbsp; = {{12{instr[31]}}, instr[19:12], instr[20], instr[30:21], 1'b0};\n</code></pre><p>最后，预读取电路会根据当前的PC值和指令的偏移量相加，得到预测的PC值，并用预测的PC值提前读出下一条指令。其Verilog代码如下：</p><pre><code class=\"language-verilog\">&nbsp; //指令地址的偏移量\n&nbsp; wire [31:0] adder = is_jal ? jimm : (is_bxx &amp; bimm[31]) ? bimm : 4;\n&nbsp; assign pre_pc = pc + adder;\n</code></pre><h2>取指数据通路模块</h2><p>由上述的指令预读取模块把指令从存储器中读取之后，需要把它发送给译码模块进行翻译。但是，预读取模块读出的指令，并不是全部都能发送后续模块去执行。</p><p>例如上面的条件分支指令，在指令完成之前就把后续的指令预读取出来了。如果指令执行之后发现跳转的条件不成立，这时预读取的指令就是无效的，需要对流水线进行冲刷（flush），把无效的指令都清除掉。</p><p>取指通路模块 <strong>if_id</strong> 主要产生3个信号。首先是给后面解码模块提供的指令信号 <strong>reg_instr。</strong>如果流水线没有发生冲突，也就是没有发出清除信号flush，则把预读取的指令保存，否则把指令清“0”。</p><pre><code class=\"language-verilog\">  //指令通路\n  always @(posedge clock) begin\n    if (reset) begin \n      reg_instr &lt;= 32'h0; \n    end else if (flush) begin \n      reg_instr &lt;= 32'h0; \n    end else if (valid) begin \n      reg_instr &lt;= in_instr; \n    end\n  end\n</code></pre><p>第二个是更新PC值，如果指令清除信号flush=“0”，则把当前指令对应的PC值保存为<strong>reg_pc</strong>，否则就把reg_pc清“0”。</p><pre><code class=\"language-verilog\">&nbsp; //PC值通路\n&nbsp; always @(posedge clock) begin\"\"\n&nbsp; &nbsp; if (reset) begin&nbsp;\n&nbsp; &nbsp; &nbsp; reg_pc &lt;= 32'h0;&nbsp;\n&nbsp; &nbsp; end else if (flush) begin&nbsp;\n&nbsp; &nbsp; &nbsp; reg_pc &lt;= 32'h0;&nbsp;\n&nbsp; &nbsp; end else if (valid) begin&nbsp;\n&nbsp; &nbsp; &nbsp; reg_pc &lt;= in_pc;&nbsp;\n&nbsp; &nbsp; end\n&nbsp; end\n</code></pre><p>最后一个是流水线冲刷的标志信号 <strong>reg_noflush</strong>。当需要进行流水线冲刷时，reg_noflush=“0”，否则reg_noflush=“1”。</p><pre><code class=\"language-verilog\">&nbsp; //流水线冲刷标志位\n&nbsp; always @(posedge clock) begin&nbsp;&nbsp;\n&nbsp; &nbsp; if (reset) begin&nbsp;\n&nbsp; &nbsp; &nbsp; reg_noflush &lt;= 1'h0;&nbsp;\n&nbsp; &nbsp; end else if (flush) begin&nbsp;\n&nbsp; &nbsp; &nbsp; reg_noflush &lt;= 1'h0;&nbsp;\n&nbsp; &nbsp; end else if (valid) begin&nbsp;\n&nbsp; &nbsp; &nbsp; reg_noflush &lt;= in_noflush;&nbsp;\n&nbsp; &nbsp; end\n&nbsp; end\n</code></pre><p>以下就是if_id模块的完整代码：</p><pre><code class=\"language-verilog\">  //  IF_ID\nmodule if_id(           \n  input         clk,\n  input         reset,\n  input  [31:0] in_instr,\n  input  [31:0] in_pc,\n  input         flush,\n  input         valid,\n  output [31:0] out_instr,\n  output [31:0] out_pc,\n  output        out_noflush\n);\n\n  reg [31:0] reg_instr; \n  reg [31:0] reg_pc; \n  reg [31:0] reg_pc_next; \n  reg        reg_noflush; \n\n  assign out_instr = reg_instr; \n  assign out_pc = reg_pc; \n  assign out_noflush = reg_noflush; \n\n  //指令传递\n  always @(posedge clk or posedge reset) begin\n    if (reset) begin \n      reg_instr &lt;= 32'h0; \n    end else if (flush) begin \n      reg_instr &lt;= 32'h0; \n    end else if (valid) begin \n      reg_instr &lt;= in_instr; \n    end\n  end\n\n  //PC值转递\n  always @(posedge clk or posedge reset) begin\n    if (reset) begin \n      reg_pc &lt;= 32'h0; \n    end else if (flush) begin \n      reg_pc &lt;= 32'h0; \n    end else if (valid) begin \n      reg_pc &lt;= in_pc; \n    end\n  end\n\n  //流水线冲刷标志位\n  always @(posedge clk or posedge reset) begin  \n    if (reset) begin \n      reg_noflush &lt;= 1'h0; \n    end else if (flush) begin \n      reg_noflush &lt;= 1'h0; \n    end else if (valid) begin \n      reg_noflush &lt;= 1'h1; \n    end\n  end\nendmodule\n</code></pre><p>好了，到这里CPU流水线的第一步——取指，我们就讲完了。在取指阶段就是把存储器里的指令读出，并传递给后续的译码模块进行处理。</p><h2>重点回顾</h2><p>今天我们终于开启了MiniCPU的设计与实现之旅，为此我们做了很多准备，恭喜你坚持到这里。</p><p>在开始设计之前，我先带你了解了流水线的设计思想。工厂里的流水线设计在CPU里也可以借鉴，通过这种方法就能提高CPU的性能。</p><p>真正的CPU流水线要根据应用需求来设计，应用场景不一样，设计的流水线也不一样。为了让你在弄懂原理的基础上能快速上手，我们的MiniCPU采用了经典的五级流水线设计。这个流水线里一条指令的五个阶段分别是取指、译码、执行、访存和写回。</p><p>从MiniCPU的架构设计上也能看到，我们的重心放在了最能体现五级流水线的模块。不过麻雀虽小，五脏俱全，这个架构里已经包含了CPU内核，用于存放指令、数据的ROM和RAM以及一些简单的外设。CPU会通过系统总线（System Bus）和这些外设进行通信。</p><p>CPU架构里的五个主要模块，你可以参考后面的导图，其中前两个模块我们这节课已经拿下了，其它模块之后的课程里我们再展开学习。<br>\n<img src=\"https://static001.geekbang.org/resource/image/82/eb/82b3fyy2fd5b465256fyy76da8a58eeb.jpg?wh=2149x1714\" alt=\"\"></p><p>明确了设计思想和架构以后，我带你迈出了流水线的第一步，也就是取指令。</p><p>我们现实通过指令预读取模块，在程序发生分支跳转的之前，对指令进行分析，预测指令跳转的方向，并提前读取跳转后的指令。这么做能提高指令在流水线中执行效率。</p><p>最后，在if_id模块中，会根据是否需要进行流水线冲刷，来判断预读取的指令能否传递给后面的译码模块。如果指令在流水线中发生冲突，需要进行流水线冲刷，就把预读取的指令清除，否则就把预读取的指令传递给后续的译码模块。</p><p>那之后指令是如何译码的呢？译码是流水线很关键的一步，让我们下节课一起解锁这部分内容吧。</p><h2>思考题</h2><p>为什么要对指令进行预读取？直接取指然后译码、执行不可以吗？</p><p>欢迎你在留言区提问或者记录今天的收获，如果感觉这节课还不错，也推荐你分享给身边的朋友，和他一起手写CPU。</p>","neighbors":{"left":{"article_title":"05｜指令架构：RISC-V在CPU设计上到底有哪些优势？","id":546957},"right":{"article_title":"07｜手写CPU（二）：如何实现指令译码模块？","id":548002}},"comments":[{"had_liked":false,"id":353948,"user_name":"苏流郁宓","can_delete":false,"product_type":"c1","uid":2729645,"ip_address":"湖北","ucode":"AD07BD9CE03047","user_header":"https://static001.geekbang.org/account/avatar/00/29/a6/ad/e65aec4c.jpg","comment_is_top":false,"comment_ctime":1659947548,"is_pvip":false,"replies":[{"id":128901,"content":"正确 ","user_name":"作者回复","user_name_real":"编辑","uid":1345199,"ctime":1660319023,"ip_address":"湖北","comment_id":353948,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100117801,"comment_content":"预读取指令的好处是加强分支预测能力，减少无用功，但不仅仅于此，比如某些软件代码转汇编，为了对齐会增加一些无用的指令，比如x86的nop（它有时会夹在几个其它指令中），还有 复杂的指令可以通过微码进行转换为几个简单的指令，总之，cpu不是也不应该所有的指令全部都执行\n预读取指令，有利于提高cpu效率，在一开始不执行浪费的时间好过cpu做到一半，才发现是无用的指令强的啊，还有部分条件指令，可以跳过不执行（比如c语言提高if的权重，降低else if的权重就是代码优化的方法），所以提高cpu效率在软硬件结合一起努力的啊\n可以直接取指然后译码再执行，但那样效率会低很多！分支预测是配合cpu流水线工作的，主要是看应用场景，电脑手机等肯定用到分支预测等，但那些老旧或简单的计算器压根分支预测用不到呀\n一句话：看应用场景再决定造什么样的cpu？","like_count":13,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583738,"discussion_content":"正确 ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660319023,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"湖北","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":353922,"user_name":"=","can_delete":false,"product_type":"c1","uid":2600127,"ip_address":"湖北","ucode":"104232A8292220","user_header":"https://static001.geekbang.org/account/avatar/00/27/ac/bf/f549183e.jpg","comment_is_top":false,"comment_ctime":1659928273,"is_pvip":false,"replies":[{"id":128904,"content":"向前 向后 跳转","user_name":"作者回复","user_name_real":"编辑","uid":1345199,"ctime":1660319295,"ip_address":"湖北","comment_id":353922,"utype":1}],"discussion_count":4,"race_medal":0,"score":2,"product_id":100117801,"comment_content":"wire [31:0] adder = is_jal ? jimm : (is_bxx &amp; bimm[31]) ? bimm : 4;  assign pre_pc = pc + adder;\n在计算指令地址偏移量的时候，为什么写is_bxx &amp; bimm[31]，而不是直接写is_bxx呢？","like_count":4,"discussions":[{"author":{"id":3077660,"avatar":"https://static001.geekbang.org/account/avatar/00/2e/f6/1c/13eb6c3c.jpg","nickname":"ywt","note":"","ucode":"3C692240F904B5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583181,"discussion_content":"bimm如果是负数就转跳，如果是正数就不转跳。相当于只往回跳不往后跳，是一种分支预测","likes_number":8,"is_delete":false,"is_hidden":false,"ctime":1659941835,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"湖北","group_id":0},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2600127,"avatar":"https://static001.geekbang.org/account/avatar/00/27/ac/bf/f549183e.jpg","nickname":"=","note":"","ucode":"104232A8292220","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":3077660,"avatar":"https://static001.geekbang.org/account/avatar/00/2e/f6/1c/13eb6c3c.jpg","nickname":"ywt","note":"","ucode":"3C692240F904B5","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583205,"discussion_content":"谢谢😍","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659949067,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":583181,"ip_address":"江苏","group_id":0},"score":583205,"extra":""}]},{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583741,"discussion_content":"向前 向后 跳转","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1660319295,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"湖北","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":2041766,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/27/a6/03cc6a69.jpg","nickname":"西南风","note":"","ucode":"3E431881EC63CE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":628290,"discussion_content":"你好，想请教下，这个向前和向后是指？31位不是符号位嘛，如果是正数，31位是0，那么就会返回4，结果就是pc+4。这个和向前向后有什么联系，还是我理解错了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1695167822,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":583741,"ip_address":"广东","group_id":0},"score":628290,"extra":""}]}]},{"had_liked":false,"id":354394,"user_name":"伊宝峰","can_delete":false,"product_type":"c1","uid":1809580,"ip_address":"湖北","ucode":"6E0E99A9711605","user_header":"https://static001.geekbang.org/account/avatar/00/1b/9c/ac/4a488a4e.jpg","comment_is_top":false,"comment_ctime":1660357864,"is_pvip":false,"replies":[{"id":128947,"content":"是的","user_name":"作者回复","user_name_real":"编辑","uid":1345199,"ctime":1660523312,"ip_address":"湖北","comment_id":354394,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100117801,"comment_content":"对指令预读取，方便形成流水线，加快执行速度，因为从存储器中直接取指令会比较慢。","like_count":2,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583947,"discussion_content":"是的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660523312,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"湖北","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":363967,"user_name":"一笑千古","can_delete":false,"product_type":"c1","uid":3220050,"ip_address":"湖北","ucode":"372EFBAB7A3FC1","user_header":"https://static001.geekbang.org/account/avatar/00/31/22/52/49be0b7e.jpg","comment_is_top":false,"comment_ctime":1670398679,"is_pvip":false,"replies":[{"id":132433,"content":"因为数据是有符号的","user_name":"作者回复","user_name_real":"编辑","uid":1345199,"ctime":1670896535,"ip_address":"湖北","comment_id":363967,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100117801,"comment_content":"老师，我想问一下为什么要将立即数的最高位复制以满足32位寄存器的长度要求","like_count":0,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":596314,"discussion_content":"因为数据是有符号的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1670896536,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"湖北","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":363623,"user_name":"一个要强的男人","can_delete":false,"product_type":"c1","uid":2930994,"ip_address":"湖北","ucode":"CA2F51B5D37B24","user_header":"https://static001.geekbang.org/account/avatar/00/2c/b9/32/c6177eb3.jpg","comment_is_top":false,"comment_ctime":1669891284,"is_pvip":false,"replies":[{"id":132442,"content":"单核也是一样的 一个周期分成几个节拍 工作的 ","user_name":"作者回复","user_name_real":"编辑","uid":1345199,"ctime":1670897826,"ip_address":"湖北","comment_id":363623,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100117801,"comment_content":"老师，请问：对于单核cpu的流水线来说，如果在译码阶段占满了这个时钟周期，那么如何在对下一个任务进行取指呢？还是说在设计之初已经确定这个时钟周期肯定能执行完4个操作。这是我的疑问，对于单核来说，并没有像工人的流水线（有五个人在工作），这种怎么理解呀，搜索了很多资料都在拿工厂的流水线打比喻，没搞明白。","like_count":0,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":596324,"discussion_content":"单核也是一样的 一个周期分成几个节拍 工作的 ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1670897826,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"湖北","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2992138,"avatar":"https://static001.geekbang.org/account/avatar/00/2d/a8/0a/791d0f5e.jpg","nickname":"Nolan","note":"","ucode":"5AD365C5154F0E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":645034,"discussion_content":"强烈推荐《计算机组成与设计 软硬件接口（RISCV版）》，你会找到你想要的所有答案","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1715729774,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"四川","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1358045,"avatar":"https://static001.geekbang.org/account/avatar/00/14/b8/dd/37726c34.jpg","nickname":"小马哥","note":"","ucode":"B2C0FF38F8C9BC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":636255,"discussion_content":"即使单核, 一条指令的获取到执行总流程是由CPU的不同模块执行的, 所以也通过流水线来提高运行效率.","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1705912698,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":363240,"user_name":"雨巷","can_delete":false,"product_type":"c1","uid":2631849,"ip_address":"湖北","ucode":"DE25C003B3D407","user_header":"https://static001.geekbang.org/account/avatar/00/28/28/a9/4cf153a3.jpg","comment_is_top":false,"comment_ctime":1669389343,"is_pvip":false,"replies":[{"id":132463,"content":"嗯嗯","user_name":"作者回复","user_name_real":"编辑","uid":1345199,"ctime":1670922804,"ip_address":"湖北","comment_id":363240,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100117801,"comment_content":"请问老师，jalr指令没有进行分支预测是吧？","like_count":0,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":596375,"discussion_content":"嗯嗯","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1670922804,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"湖北","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":362442,"user_name":"小傅","can_delete":false,"product_type":"c1","uid":2616255,"ip_address":"湖北","ucode":"56B75C45A6C761","user_header":"https://static001.geekbang.org/account/avatar/00/27/eb/bf/8acfeaa6.jpg","comment_is_top":false,"comment_ctime":1668518647,"is_pvip":false,"replies":[{"id":131942,"content":"你学过verilog吗","user_name":"作者回复","user_name_real":"编辑","uid":1345199,"ctime":1668992554,"ip_address":"湖北","comment_id":362442,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100117801,"comment_content":"wire [31:0] bimm = {{20{instr[31]}}, instr[7], instr[30:25], instr[11:8], 1&#39;b0}; 这句怎么理解呢，{20{instr[31]}}这又是什么意思呢？","like_count":0,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":594325,"discussion_content":"你学过verilog吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1668992554,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"湖北","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":361813,"user_name":"Geek_489363","can_delete":false,"product_type":"c1","uid":3208598,"ip_address":"湖北","ucode":"939D2729EA4D4F","user_header":"","comment_is_top":false,"comment_ctime":1667887489,"is_pvip":false,"replies":[{"id":131740,"content":"b指令的数据格式 就是这样啊 ","user_name":"作者回复","user_name_real":"编辑","uid":1345199,"ctime":1668310758,"ip_address":"湖北","comment_id":361813,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100117801,"comment_content":"根据b型指令的格式，为什么会有得到{{20{instr[31]}}, instr[7], instr[30:25], instr[11:8], 1&#39;b0}？不是很理解","like_count":0,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":593515,"discussion_content":"b指令的数据格式 就是这样啊 ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1668310758,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"湖北","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":355237,"user_name":"吴建平","can_delete":false,"product_type":"c1","uid":2618440,"ip_address":"","ucode":"C6E578FB8627A3","user_header":"https://static001.geekbang.org/account/avatar/00/27/f4/48/2242bed9.jpg","comment_is_top":false,"comment_ctime":1661219506,"is_pvip":false,"replies":[{"id":129351,"content":"你的留言我们已经收到，已经跟LMOS确认啦。if_id模块的设计，老师考虑到代码简洁一些有助于初学用户理解，最新一版Gitee代码里已经把这段删掉了，且并不影响整体的功能。你可以拉取一下最新的代码。","user_name":"编辑回复","user_name_real":"编辑","uid":1501385,"ctime":1661402133,"ip_address":"","comment_id":355237,"utype":2}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100117801,"comment_content":"确实少了一段代码，下面这部分，gitee也没有。而且输入in_pc_next也没有在模块定义里看到。我的理解是，pre_id是if_id的伴生电路，他们俩其实都属于取指阶段，逻辑上属于同一个时钟周期。正常情况下（流水线正常运作），每次时钟跳变，根据next读取新的指令，pre_id就算出下一条指令地址，此时if_id就用此输出作为in_pc_next输入。所以pre_id比if_id要快半个周期。\n  &#47;&#47;下一条指令的PC\n  always @(posedge clock) begin\n    if (reset) begin \n      reg_pc_next &lt;= 32&#39;h0; \n    end else if (flush) begin \n      reg_pc_next &lt;= 32&#39;h0; \n    end else if (valid) begin \n      reg_pc_next &lt;= in_pc_next; \n    end\n  end","like_count":0,"discussions":[{"author":{"id":1501385,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e8/c9/59bcd490.jpg","nickname":"听水的湖","note":"","ucode":"B1759F90165D81","race_medal":0,"user_type":8,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":585216,"discussion_content":"你的留言我们已经收到，已经跟LMOS确认啦。if_id模块的设计，老师考虑到代码简洁一些有助于初学用户理解，最新一版Gitee代码里已经把这段删掉了，且并不影响整体的功能。你可以拉取一下最新的代码。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661402133,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":8}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":355236,"user_name":"吴建平","can_delete":false,"product_type":"c1","uid":2618440,"ip_address":"湖北","ucode":"C6E578FB8627A3","user_header":"https://static001.geekbang.org/account/avatar/00/27/f4/48/2242bed9.jpg","comment_is_top":false,"comment_ctime":1661219107,"is_pvip":false,"replies":[{"id":129447,"content":"我看看","user_name":"作者回复","user_name_real":"编辑","uid":1345199,"ctime":1661677866,"ip_address":"湖北","comment_id":355236,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100117801,"comment_content":"确实是少了一段代码，gitee下载的代码也没有。是reg_pc_next这部分，其输入不是out_pc_next","like_count":0,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":585567,"discussion_content":"我看看","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661677866,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"湖北","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":354748,"user_name":"小博(微信/手机号1849登录)","can_delete":false,"product_type":"c1","uid":3114449,"ip_address":"湖北","ucode":"58FA146873C268","user_header":"https://static001.geekbang.org/account/avatar/00/2f/85/d1/bfe4d1b2.jpg","comment_is_top":false,"comment_ctime":1660742059,"is_pvip":false,"replies":[{"id":129169,"content":"感谢支持","user_name":"作者回复","user_name_real":"编辑","uid":1345199,"ctime":1661051320,"ip_address":"湖北","comment_id":354748,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100117801,"comment_content":"老师讲的很棒呀，文档学习比视频省时间。","like_count":0,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":584685,"discussion_content":"感谢支持","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661051320,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"湖北","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":354676,"user_name":"Abcd","can_delete":false,"product_type":"c1","uid":1796908,"ip_address":"湖北","ucode":"274C7487FDDC21","user_header":"https://static001.geekbang.org/account/avatar/00/1b/6b/2c/b27eefc5.jpg","comment_is_top":false,"comment_ctime":1660661962,"is_pvip":false,"replies":[{"id":129181,"content":"clone 最新代码 ","user_name":"作者回复","user_name_real":"编辑","uid":1345199,"ctime":1661052622,"ip_address":"湖北","comment_id":354676,"utype":1}],"discussion_count":3,"race_medal":0,"score":3,"product_id":100117801,"comment_content":"if_id的代码不全啊老师，out_pc_next的那段是不是漏了？另外课程中的代码有Github仓库吗？","like_count":0,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":584701,"discussion_content":"clone 最新代码 ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661052622,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"湖北","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1501385,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e8/c9/59bcd490.jpg","nickname":"听水的湖","note":"","ucode":"B1759F90165D81","race_medal":0,"user_type":8,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":584248,"discussion_content":"完整代码在Gitee上https://gitee.com/lmos/Geek-time-computer-foundation，没有Github","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1660705362,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2618440,"avatar":"https://static001.geekbang.org/account/avatar/00/27/f4/48/2242bed9.jpg","nickname":"吴建平","note":"","ucode":"C6E578FB8627A3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":584861,"discussion_content":"好像是少了一段代码，gitee下载的代码也没有。是reg_pc_next这部分，不是out_pc_next","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661164065,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":354553,"user_name":"Geek_e0e3b8","can_delete":false,"product_type":"c1","uid":1509335,"ip_address":"湖北","ucode":"FE90DB5DC31167","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIOMGF5KoLP5t64epdsVAYBBSu5hZFMvl7vqDkDMt7rwIfTur8HYBqLozZxZC78QUI3vVTxENDycA/132","comment_is_top":false,"comment_ctime":1660535670,"is_pvip":false,"replies":[{"id":129457,"content":"可以 查看一下 指令位段相关的说明  ","user_name":"作者回复","user_name_real":"编辑","uid":1345199,"ctime":1661678610,"ip_address":"湖北","comment_id":354553,"utype":1}],"discussion_count":6,"race_medal":0,"score":3,"product_id":100117801,"comment_content":"&#47;&#47;B型指令的立即数拼接    \nwire [31:0] bimm  = {{20{instr[31]}}, instr[7], instr[30:25], instr[11:8], 1&#39;b0};\n&#47;&#47;J型指令的立即数拼接 \nwire [31:0] jimm  = {{12{instr[31]}}, instr[19:12], instr[20], instr[30:21], 1&#39;b0};\n请问两种指令的立即数拼接中{20{instr[31]}} 和 {12{instr[31]}} 该如何理解？有没有可能是写错了？希望能够给个具体指令范例详细说明下，谢谢~","like_count":0,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":585577,"discussion_content":"可以 查看一下 指令位段相关的说明  ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661678610,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"湖北","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":3068416,"avatar":"https://static001.geekbang.org/account/avatar/00/2e/d2/00/23784f62.jpg","nickname":"Geek_6a1eb9","note":"","ucode":"10AA5B12E0C8C4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":585332,"discussion_content":"可以看看这篇文章，希望能帮到你：https://edwardluo.wordpress.com/2015/04/16/verilog%E4%B8%AD%E6%8B%BC%E6%8E%A5%E8%BF%90%E7%AE%97%E7%AC%A6%E7%9A%84%E7%94%A8%E6%B3%95/","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1661485380,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"山东","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1608643,"avatar":"https://static001.geekbang.org/account/avatar/00/18/8b/c3/bf036d99.jpg","nickname":"砥砺奋进","note":"","ucode":"2F12FD10F749AD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":592465,"discussion_content":"果然万能的评论区","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1667434226,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2685179,"avatar":"https://static001.geekbang.org/account/avatar/00/28/f8/fb/b3ef94fc.jpg","nickname":"阿白","note":"","ucode":"15A30369FCC689","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":584921,"discussion_content":"应该没错，这是在做符号位扩展","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661225598,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":3068064,"avatar":"https://static001.geekbang.org/account/avatar/00/2e/d0/a0/569968d2.jpg","nickname":"Nereus","note":"","ucode":"193623DC164EF3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":584534,"discussion_content":"bimn[31:11]=instr[31](类似于20个1bit的instr[31]组成了bimn的高位部分),bimn[10]=instr[7],bimn[9:4]=instr[30:25],bimn[3:1]=instr[11:8],bimn[0]=1&#39;b0","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660897014,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"湖南","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1683139,"avatar":"https://static001.geekbang.org/account/avatar/00/19/ae/c3/d930693b.jpg","nickname":"LockedX","note":"","ucode":"19B82B910FC67F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":584103,"discussion_content":"我也有同样的疑问","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660632608,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":354496,"user_name":"你要有个信念","can_delete":false,"product_type":"c1","uid":3115320,"ip_address":"湖北","ucode":"CA9D3E9DC138EA","user_header":"https://static001.geekbang.org/account/avatar/00/2f/89/38/441bb99b.jpg","comment_is_top":false,"comment_ctime":1660464760,"is_pvip":false,"replies":[{"id":128949,"content":"寄存器位置是固定的","user_name":"作者回复","user_name_real":"编辑","uid":1345199,"ctime":1660523357,"ip_address":"湖北","comment_id":354496,"utype":1}],"discussion_count":2,"race_medal":0,"score":3,"product_id":100117801,"comment_content":"老师您好，我不太理解立即数为什么要以那样的格式拼接？ ","like_count":0,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583949,"discussion_content":"寄存器位置是固定的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660523357,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"湖北","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":3068416,"avatar":"https://static001.geekbang.org/account/avatar/00/2e/d2/00/23784f62.jpg","nickname":"Geek_6a1eb9","note":"","ucode":"10AA5B12E0C8C4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":585337,"discussion_content":"我是RISC-V和verilog的初学者，我也有这个问题，然后这个视频给了我一些更详细的解答，让我理解了这个问题，这是视频链接：https://www.bilibili.com/video/BV1cS4y1h73D/?spm_id_from=pageDriver&amp;vd_source=848d96f76bd7922d39f70343e2f35a57","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1661490579,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"山东","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":353993,"user_name":"skyline","can_delete":false,"product_type":"c1","uid":3077871,"ip_address":"湖北","ucode":"C4D9A2A2FA99AC","user_header":"https://static001.geekbang.org/account/avatar/00/2e/f6/ef/9d19893f.jpg","comment_is_top":false,"comment_ctime":1659992495,"is_pvip":false,"replies":[{"id":128906,"content":"偏移地址有符号","user_name":"作者回复","user_name_real":"编辑","uid":1345199,"ctime":1660319344,"ip_address":"湖北","comment_id":353993,"utype":1}],"discussion_count":3,"race_medal":0,"score":3,"product_id":100117801,"comment_content":"wire [31:0] adder = is_jal ? jimm : (is_bxx &amp; bimm[31]) ? bimm : 4;\n有小伙伴知道为啥要与上bimm的符号位么？","like_count":0,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583743,"discussion_content":"偏移地址有符号","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660319344,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"湖北","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":2942567,"avatar":"https://static001.geekbang.org/account/avatar/00/2c/e6/67/2a717a78.jpg","nickname":"咻咻咻","note":"","ucode":"D0F8BE3299CC94","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":589024,"discussion_content":"老师，针对于这一段，我可以理解为 bimm[31]=1 的时候 adder = bimm，  bimm[31]为0的时候 adder = 4 么？ 如果是这样，这个4 如何理解？ 我不太明白。","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1664348312,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":583743,"ip_address":"浙江","group_id":0},"score":589024,"extra":""}]},{"author":{"id":3220420,"avatar":"","nickname":"Geek_f26800","note":"","ucode":"FFB386E5B2078C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":594104,"discussion_content":"搭车同问","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1668787282,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广西","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":353985,"user_name":"陈-特-别","can_delete":false,"product_type":"c1","uid":1252500,"ip_address":"湖北","ucode":"224B68C6205152","user_header":"https://static001.geekbang.org/account/avatar/00/13/1c/94/bf891bb0.jpg","comment_is_top":false,"comment_ctime":1659971770,"is_pvip":false,"replies":[{"id":128900,"content":"靠 分支 预测 逻辑","user_name":"作者回复","user_name_real":"编辑","uid":1345199,"ctime":1660318910,"ip_address":"湖北","comment_id":353985,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100117801,"comment_content":"请问老师 上面说的如果跳转指令不成立的话 需要冲刷指令 那请问cpu是如何实现执行正确的指令的（跳转条件成立的指令）？","like_count":0,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583737,"discussion_content":"靠 分支 预测 逻辑","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660318910,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"湖北","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":362438,"user_name":"小傅","can_delete":false,"product_type":"c1","uid":2616255,"ip_address":"福建","ucode":"56B75C45A6C761","user_header":"https://static001.geekbang.org/account/avatar/00/27/eb/bf/8acfeaa6.jpg","comment_is_top":false,"comment_ctime":1668515077,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100117801,"comment_content":"请问MiniCPU 的整体框架是怎么设计出来的呢？","like_count":1},{"had_liked":false,"id":357889,"user_name":"秋天","can_delete":false,"product_type":"c1","uid":1057056,"ip_address":"日本","ucode":"A7E1D953EF7E17","user_header":"https://static001.geekbang.org/account/avatar/00/10/21/20/1299e137.jpg","comment_is_top":false,"comment_ctime":1663732066,"is_pvip":false,"replies":null,"discussion_count":2,"race_medal":0,"score":3,"product_id":100117801,"comment_content":"wire [31:0] bimm  = {{20{instr[31]}}, instr[7], instr[30:25], instr[11:8], 1&#39;b0};  这是 verilog 预发的规则吗 这么取值 还有这个取值 跟老师的那个图怎么对应看啊？？？","like_count":1,"discussions":[{"author":{"id":2616255,"avatar":"https://static001.geekbang.org/account/avatar/00/27/eb/bf/8acfeaa6.jpg","nickname":"小傅","note":"","ucode":"56B75C45A6C761","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":593779,"discussion_content":"20{instr[31]}表示20个instr[31]","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1668520727,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"福建","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":3208598,"avatar":"","nickname":"Geek_489363","note":"","ucode":"939D2729EA4D4F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":593010,"discussion_content":"同问","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1667887187,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"浙江","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":395365,"user_name":"嗨！探索者","can_delete":false,"product_type":"c1","uid":2709122,"ip_address":"上海","ucode":"A796FDEB4CA0AC","user_header":"https://static001.geekbang.org/account/avatar/00/29/56/82/d965a0f5.jpg","comment_is_top":false,"comment_ctime":1730441570,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100117801,"comment_content":"“访存阶段（Memory Access）：访存是指存储器访问指令将数据从存储器中读出，或写入存储器的过程。”\n是指令访问存储器呢还是存储器访问指令？","like_count":0},{"had_liked":false,"id":387120,"user_name":"小马哥","can_delete":false,"product_type":"c1","uid":1358045,"ip_address":"北京","ucode":"B2C0FF38F8C9BC","user_header":"https://static001.geekbang.org/account/avatar/00/14/b8/dd/37726c34.jpg","comment_is_top":false,"comment_ctime":1706522579,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100117801,"comment_content":"指令预读取可以减少流水线中的气泡（stalls），保持流水线的连续流动，从而提高处理器的整体性能。","like_count":0},{"had_liked":false,"id":384459,"user_name":"A君","can_delete":false,"product_type":"c1","uid":1940105,"ip_address":"上海","ucode":"FE96F089C2312C","user_header":"https://static001.geekbang.org/account/avatar/00/1d/9a/89/babe8b52.jpg","comment_is_top":false,"comment_ctime":1700974931,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100117801,"comment_content":"给取指模块增加预取功能，取指才能和其他组成流水线，否则就是同步操作了","like_count":0},{"had_liked":false,"id":366005,"user_name":"A君","can_delete":false,"product_type":"c1","uid":1940105,"ip_address":"上海","ucode":"FE96F089C2312C","user_header":"https://static001.geekbang.org/account/avatar/00/1d/9a/89/babe8b52.jpg","comment_is_top":false,"comment_ctime":1673317207,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100117801,"comment_content":"预取的概念有点不清，它是指取了一条指令发给译码器后再提前下N条指令？还是说，反正它会持续取指，如果遇到跳转就推定它一定沿着某个分支执行因此就沿着那个分支取指？","like_count":0}]}