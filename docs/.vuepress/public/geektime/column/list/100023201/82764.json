{"id":82764,"title":"JavaScript执行（一）：Promise里的代码为什么比setTimeout先执行？","content":"<p>你好，我是winter。这一部分我们来讲一讲JavaScript的执行。</p><p>首先我们考虑一下，如果我们是浏览器或者Node的开发者，我们该如何使用JavaScript引擎。</p><p>当拿到一段JavaScript代码时，浏览器或者Node环境首先要做的就是；传递给JavaScript引擎，并且要求它去执行。</p><p>然而，执行JavaScript并非一锤子买卖，宿主环境当遇到一些事件时，会继续把一段代码传递给JavaScript引擎去执行，此外，我们可能还会提供API给JavaScript引擎，比如setTimeout这样的API，它会允许JavaScript在特定的时机执行。</p><p>所以，我们首先应该形成一个感性的认知：一个JavaScript引擎会常驻于内存中，它等待着我们（宿主）把JavaScript代码或者函数传递给它执行。</p><p>在ES3和更早的版本中，JavaScript本身还没有异步执行代码的能力，这也就意味着，宿主环境传递给JavaScript引擎一段代码，引擎就把代码直接顺次执行了，这个任务也就是宿主发起的任务。</p><p>但是，在ES5之后，JavaScript引入了Promise，这样，不需要浏览器的安排，JavaScript引擎本身也可以发起任务了。</p><!-- [[[read_end]]] --><p>由于我们这里主要讲JavaScript语言，那么采纳JSC引擎的术语，我们把宿主发起的任务称为宏观任务，把JavaScript引擎发起的任务称为微观任务。</p><h2>宏观和微观任务</h2><p>JavaScript引擎等待宿主环境分配宏观任务，在操作系统中，通常等待的行为都是一个事件循环，所以在Node术语中，也会把这个部分称为事件循环。</p><p>不过，术语本身并非我们需要重点讨论的内容，我们在这里把重点放在事件循环的原理上。在底层的C/C++代码中，这个事件循环是一个跑在独立线程中的循环，我们用伪代码来表示，大概是这样的：</p><pre><code class=\"language-C\">while(TRUE) {\n    r = wait();\n    execute(r);\n}\n</code></pre><p>我们可以看到，整个循环做的事情基本上就是反复“等待-执行”。当然，实际的代码中并没有这么简单，还有要判断循环是否结束、宏观任务队列等逻辑，这里为了方便你理解，我就把这些都省略掉了。</p><p>这里每次的执行过程，其实都是一个宏观任务。我们可以大概理解：宏观任务的队列就相当于事件循环。</p><p>在宏观任务中，JavaScript的Promise还会产生异步代码，JavaScript必须保证这些异步代码在一个宏观任务中完成，因此，每个宏观任务中又包含了一个微观任务队列：</p><p><img src=\"https://static001.geekbang.org/resource/image/16/65/16f70a9a51a65d5302166b0d78414d65.jpg?wh=1398*1636\" alt=\"\"></p><p>有了宏观任务和微观任务机制，我们就可以实现JavaScript引擎级和宿主级的任务了，例如：Promise永远在队列尾部添加微观任务。setTimeout等宿主API，则会添加宏观任务。</p><p>接下来，我们来详细介绍一下Promise。</p><h2>Promise</h2><p>Promise是JavaScript语言提供的一种标准化的异步管理方式，它的总体思想是，需要进行io、等待或者其它异步操作的函数，不返回真实结果，而返回一个“承诺”，函数的调用方可以在合适的时机，选择等待这个承诺兑现（通过Promise的then方法的回调）。</p><p>Promise的基本用法示例如下：</p><pre><code>    function sleep(duration) {\n        return new Promise(function(resolve, reject) {\n            setTimeout(resolve,duration);\n        })\n    }\n    sleep(1000).then( ()=&gt; console.log(&quot;finished&quot;));\n</code></pre><p>这段代码定义了一个函数sleep，它的作用是等候传入参数指定的时长。</p><p>Promise的then回调是一个异步的执行过程，下面我们就来研究一下Promise函数中的执行顺序，我们来看一段代码示例：</p><pre><code>    var r = new Promise(function(resolve, reject){\n        console.log(&quot;a&quot;);\n        resolve()\n    });\n    r.then(() =&gt; console.log(&quot;c&quot;));\n    console.log(&quot;b&quot;)\n</code></pre><p>我们执行这段代码后，注意输出的顺序是 a b c。在进入console.log(“b”) 之前，毫无疑问 r 已经得到了resolve，但是Promise的resolve始终是异步操作，所以c无法出现在b之前。</p><p>接下来我们试试跟setTimeout混用的Promise。</p><p>在这段代码中，我设置了两段互不相干的异步操作：通过setTimeout执行console.log(“d”)，通过Promise执行console.log(“c”)。</p><pre><code>    var r = new Promise(function(resolve, reject){\n        console.log(&quot;a&quot;);\n        resolve()\n    });\n    setTimeout(()=&gt;console.log(&quot;d&quot;), 0)\n    r.then(() =&gt; console.log(&quot;c&quot;));\n    console.log(&quot;b&quot;)\n</code></pre><p>我们发现，不论代码顺序如何，d必定发生在c之后，因为Promise产生的是JavaScript引擎内部的微任务，而setTimeout是浏览器API，它产生宏任务。</p><p>为了理解微任务始终先于宏任务，我们设计一个实验：执行一个耗时1秒的Promise。</p><pre><code>    setTimeout(()=&gt;console.log(&quot;d&quot;), 0)\n    var r = new Promise(function(resolve, reject){\n        resolve()\n    });\n    r.then(() =&gt; { \n        var begin = Date.now();\n        while(Date.now() - begin &lt; 1000);\n        console.log(&quot;c1&quot;) \n        new Promise(function(resolve, reject){\n            resolve()\n        }).then(() =&gt; console.log(&quot;c2&quot;))\n    });\n</code></pre><p>这里我们强制了1秒的执行耗时，这样，我们可以确保任务c2是在d之后被添加到任务队列。</p><p>我们可以看到，即使耗时一秒的c1执行完毕，再enque的c2，仍然先于d执行了，这很好地解释了微任务优先的原理。</p><p>通过一系列的实验，我们可以总结一下如何分析异步执行的顺序：</p><ul>\n<li>首先我们分析有多少个宏任务；</li>\n<li>在每个宏任务中，分析有多少个微任务；</li>\n<li>根据调用次序，确定宏任务中的微任务执行次序；</li>\n<li>根据宏任务的触发规则和调用次序，确定宏任务的执行次序；</li>\n<li>确定整个顺序。</li>\n</ul><p>我们再来看一个稍微复杂的例子：</p><pre><code>    function sleep(duration) {\n        return new Promise(function(resolve, reject) {\n            console.log(&quot;b&quot;);\n            setTimeout(resolve,duration);\n        })\n    }\n    console.log(&quot;a&quot;);\n    sleep(5000).then(()=&gt;console.log(&quot;c&quot;));\n</code></pre><p>这是一段非常常用的封装方法，利用Promise把setTimeout封装成可以用于异步的函数。</p><p>我们首先来看，setTimeout把整个代码分割成了2个宏观任务，这里不论是5秒还是0秒，都是一样的。</p><p>第一个宏观任务中，包含了先后同步执行的 console.log(“a”); 和 console.log(“b”);。</p><p>setTimeout后，第二个宏观任务执行调用了resolve，然后then中的代码异步得到执行，所以调用了console.log(“c”)，最终输出的顺序才是： a b c。</p><p>Promise是JavaScript中的一个定义，但是实际编写代码时，我们可以发现，它似乎并不比回调的方式书写更简单，但是从ES6开始，我们有了async/await，这个语法改进跟Promise配合，能够有效地改善代码结构。</p><h2>新特性：async/await</h2><p>async/await是ES2016新加入的特性，它提供了用for、if等代码结构来编写异步的方式。它的运行时基础是Promise，面对这种比较新的特性，我们先来看一下基本用法。</p><p>async函数必定返回Promise，我们把所有返回Promise的函数都可以认为是异步函数。</p><p>async函数是一种特殊语法，特征是在function关键字之前加上async关键字，这样，就定义了一个async函数，我们可以在其中使用await来等待一个Promise。</p><pre><code>function sleep(duration) {\n    return new Promise(function(resolve, reject) {\n        setTimeout(resolve,duration);\n    })\n}\nasync function foo(){\n    console.log(&quot;a&quot;)\n    await sleep(2000)\n    console.log(&quot;b&quot;)\n}\n</code></pre><p>这段代码利用了我们之前定义的sleep函数。在异步函数foo中，我们调用sleep。</p><p>async函数强大之处在于，它是可以嵌套的。我们在定义了一批原子操作的情况下，可以利用async函数组合出新的async函数。</p><pre><code>function sleep(duration) {\n    return new Promise(function(resolve, reject) {\n        setTimeout(resolve,duration);\n    })\n}\nasync function foo(name){\n    await sleep(2000)\n    console.log(name)\n}\nasync function foo2(){\n    await foo(&quot;a&quot;);\n    await foo(&quot;b&quot;);\n}\n</code></pre><p>这里foo2用await调用了两次异步函数foo，可以看到，如果我们把sleep这样的异步操作放入某一个框架或者库中，使用者几乎不需要了解Promise的概念即可进行异步编程了。</p><p>此外，generator/iterator也常常被跟异步一起来讲，我们必须说明 generator/iterator 并非异步代码，只是在缺少async/await的时候，一些框架（最著名的要数co）使用这样的特性来模拟async/await。</p><p>但是generator并非被设计成实现异步，所以有了async/await之后，generator/iterator来模拟异步的方法应该被废弃。</p><h2>结语</h2><p>在今天的文章里，我们学习了JavaScript执行部分的知识，首先我们学习了JavaScript的宏观任务和微观任务相关的知识。我们把宿主发起的任务称为宏观任务，把JavaScript引擎发起的任务称为微观任务。许多的微观任务的队列组成了宏观任务。</p><p>除此之外，我们还展开介绍了用Promise来添加微观任务的方式，并且介绍了async/await这个语法的改进。</p><p>最后，留给你一个小练习：我们现在要实现一个红绿灯，把一个圆形div按照绿色3秒，黄色1秒，红色2秒循环改变背景色，你会怎样编写这个代码呢？欢迎你留言讨论。</p><p></p>","neighbors":{"left":{"article_title":"JavaScript对象：你知道全部的对象分类吗？","id":80011},"right":{"article_title":"JavaScript执行（二）：闭包和执行上下文到底是怎么回事？","id":83302}},"comments":[{"had_liked":false,"id":69886,"user_name":"杨学茂","can_delete":false,"product_type":"c1","uid":1377459,"ip_address":"","ucode":"C12DAA295CC945","user_header":"https://static001.geekbang.org/account/avatar/00/15/04/b3/3f0b69f9.jpg","comment_is_top":false,"comment_ctime":1550896537,"is_pvip":false,"replies":[{"id":"25838","content":"这个写的完全挑不出毛病，其它同学可以参考。","user_name":"作者回复","user_name_real":"winter","uid":"1268524","ctime":1551425286,"ip_address":"","comment_id":69886,"utype":1}],"discussion_count":14,"race_medal":0,"score":"2295063432601","product_id":100023201,"comment_content":"function sleep(duration){<br>    return new Promise(function(resolve){<br>        setTimeout(resolve, duration);<br>    })<br>}<br>async function changeColor(duration,color){<br>    document.getElementById(&quot;traffic-light&quot;).style.background = color;<br>    await sleep(duration);<br><br>}<br>async function main(){<br>    while(true){<br>        await changeColor(3000,&quot;green&quot;);<br>        await changeColor(1000, &quot;yellow&quot;);<br>        await changeColor(2000, &quot;red&quot;);<br>    }<br>}<br>main()","like_count":535,"discussions":[{"author":{"id":1268524,"avatar":"https://static001.geekbang.org/account/avatar/00/13/5b/2c/12bfd3cd.jpg","nickname":"winter","note":"","ucode":"2B068EDEAFEB56","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440332,"discussion_content":"这个写的完全挑不出毛病，其它同学可以参考。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551425286,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1126631,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/s0bx4WXQNkAJ3c3map0g6dlt3sKDgTtN7Ria96YoufjQcVVI8Shv5CN1jnK1ZTImNnlPcibRqvyiaUuhpIvV1TpnQ/132","nickname":"wingsico","note":"","ucode":"A91CB7B0497708","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":222494,"discussion_content":"changeColor和sleep耦合在一起了，不应该把sleep写在changeColor中，在main中应该使用如下方式：\n\n```js\nfunction changeColor(d, color) {\n    d.style.color = color\n}\n\nasync function main() {\n    while(true) {\n        changeColor(dom, &#39;green&#39;)\n        await sleep(3000)\n        changeColor(dom, &#39;yellow&#39;)\n        await sleep(1000)\n        changeColor(dom, &#39;red&#39;)\n        await sleep(2000)\n    }\n}\n```","likes_number":16,"is_delete":false,"is_hidden":false,"ctime":1586149351,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":4,"child_discussions":[{"author":{"id":1373792,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/mjBQmRMl11m8TYkFXlZNO5WEaGeWicHhxO64iaxpjfKcjzHPmehwmhM8ib6RszfomgZ4oXlbmaJicnGot39tnNicfVA/132","nickname":"许金星","note":"","ucode":"8CC38A6871B17D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1126631,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/s0bx4WXQNkAJ3c3map0g6dlt3sKDgTtN7Ria96YoufjQcVVI8Shv5CN1jnK1ZTImNnlPcibRqvyiaUuhpIvV1TpnQ/132","nickname":"wingsico","note":"","ucode":"A91CB7B0497708","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":271335,"discussion_content":"请问这样写比上面好在哪？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1590118745,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":222494,"ip_address":""},"score":271335,"extra":""},{"author":{"id":1665385,"avatar":"https://static001.geekbang.org/account/avatar/00/19/69/69/f7cde15c.jpg","nickname":"Albert.Ejiestein","note":"","ucode":"CC342398930C25","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1373792,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/mjBQmRMl11m8TYkFXlZNO5WEaGeWicHhxO64iaxpjfKcjzHPmehwmhM8ib6RszfomgZ4oXlbmaJicnGot39tnNicfVA/132","nickname":"许金星","note":"","ucode":"8CC38A6871B17D","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":275199,"discussion_content":"解耦","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1590676197,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":271335,"ip_address":""},"score":275199,"extra":""},{"author":{"id":1997806,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/7b/ee/53124b75.jpg","nickname":"东坡芝士","note":"","ucode":"FF267B7E865AD2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1126631,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/s0bx4WXQNkAJ3c3map0g6dlt3sKDgTtN7Ria96YoufjQcVVI8Shv5CN1jnK1ZTImNnlPcibRqvyiaUuhpIvV1TpnQ/132","nickname":"wingsico","note":"","ucode":"A91CB7B0497708","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":320542,"discussion_content":"changeColor(dom, &#39;green&#39;)\n        await sleep(3000)\n这两行再封装成一个方法 入参是时间和颜色 是不是更简洁，方法嵌套算耦合吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604394568,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":222494,"ip_address":""},"score":320542,"extra":""}]},{"author":{"id":1382913,"avatar":"https://static001.geekbang.org/account/avatar/00/15/1a/01/938ab37d.jpg","nickname":"寒夜","note":"","ucode":"45771EAA805409","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":242263,"discussion_content":"document.getElementById(&#34;traffic-light&#34;)最好缓存一下","likes_number":7,"is_delete":false,"is_hidden":false,"ctime":1587473107,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2328769,"avatar":"","nickname":"Geek_2b435a","note":"","ucode":"70A1A0D25EF386","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":327239,"discussion_content":"鸡蛋里挑骨头的话由于setTimeout会被加入到的队列末尾，实际上运行会超过3秒、2秒、1秒","likes_number":5,"is_delete":false,"is_hidden":false,"ctime":1605772679,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1383510,"avatar":"https://static001.geekbang.org/account/avatar/00/15/1c/56/b7329e72.jpg","nickname":"草舟","note":"","ucode":"41FE0F9AAA9285","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":544495,"discussion_content":"为什么要加wile(true) {...} ?","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641540749,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1374066,"avatar":"https://static001.geekbang.org/account/avatar/00/14/f7/72/2d35f80c.jpg","nickname":"xing.org1^","note":"","ucode":"C68AEA172B1623","race_medal":1,"user_type":1,"is_pvip":false},"reply_author":{"id":1383510,"avatar":"https://static001.geekbang.org/account/avatar/00/15/1c/56/b7329e72.jpg","nickname":"草舟","note":"","ucode":"41FE0F9AAA9285","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":584233,"discussion_content":"像大街上的🚥 一直变换颜色永不停息🙈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660701582,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":544495,"ip_address":"北京"},"score":584233,"extra":""}]},{"author":{"id":1802517,"avatar":"","nickname":"Geek_f1e564","note":"","ucode":"ABFE6F4FF647E8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":376087,"discussion_content":"还封装起来了，好棒","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621952987,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1946181,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/b2/45/b49a92f5.jpg","nickname":"后脑勺","note":"","ucode":"50704EC5545C4C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":232338,"discussion_content":"const trafficLight = document.querySelector(&#39;.traffic-lights&#39;)\n\nstart()\n\nasync function start(params) {\n  while (true) {\n    await generateLight(trafficLight, &#39;green&#39;, 3000)\n    await generateLight(trafficLight, &#39;yellow&#39;, 1000)\n    await generateLight(trafficLight, &#39;red&#39;, 2000)\n  }\n}\n\nfunction generateLight(el, color, duration) {\n  return new Promise(resolve => {\n    el.style.backgroundColor = color\n    setTimeout(resolve, duration)\n  })\n}\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586866845,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1453214,"avatar":"https://static001.geekbang.org/account/avatar/00/16/2c/9e/7e57f97c.jpg","nickname":"良纵","note":"","ucode":"234B6F9190A0AD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":148064,"discussion_content":"while(true){...}还是学单片机的时候才敢用的东西呢，不知道会在js中导致什么问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579688369,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1042089,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/e6/a9/b459efb7.jpg","nickname":"如故","note":"","ucode":"F6895792309942","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1453214,"avatar":"https://static001.geekbang.org/account/avatar/00/16/2c/9e/7e57f97c.jpg","nickname":"良纵","note":"","ucode":"234B6F9190A0AD","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":311129,"discussion_content":"因为单片机就是需要不断循环运行啊 这里如果也需要不断循环运行 也没啥问题吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1602232100,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":148064,"ip_address":""},"score":311129,"extra":""}]}]},{"had_liked":false,"id":72072,"user_name":"whatever","can_delete":false,"product_type":"c1","uid":1388132,"ip_address":"","ucode":"7CF85666425B65","user_header":"https://static001.geekbang.org/account/avatar/00/15/2e/64/10182523.jpg","comment_is_top":false,"comment_ctime":1551513582,"is_pvip":false,"discussion_count":11,"race_medal":0,"score":"791825496046","product_id":100023201,"comment_content":"https:&#47;&#47;jakearchibald.com&#47;2015&#47;tasks-microtasks-queues-and-schedules&#47;<br>为了更深入的理解宏任务和微任务，读了这篇。感觉文中说的微任务总是先于宏任务会让人产生误解，更准确的说法应该是微任务总会在下一个宏任务之前执行，在本身所属的宏任务结束后立即执行。","like_count":185,"discussions":[{"author":{"id":1996106,"avatar":"","nickname":"Geek_1e6198","note":"","ucode":"785EBE404903DD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":268622,"discussion_content":"执行主线程宏任务-->执行所有的微任务,直到清空微任务的队列-->执行一个宏任务--->执行微任务(因为这时候可能又产生了新的微任务)--一个宏-->所有微  然后一直循环往复直到结束","likes_number":13,"is_delete":false,"is_hidden":false,"ctime":1589808955,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1330852,"avatar":"https://static001.geekbang.org/account/avatar/00/14/4e/a4/433305bb.jpg","nickname":"卡洛斯(๑Ő௰Ő๑)","note":"","ucode":"6F311BF03B76FD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":6160,"discussion_content":"恩，确实会有歧义，事件循环的是宏观任务，微任务是在宏观任务里，所以说微观任务始终在宏观任务之前执行，是有歧义的，应该是每执行完一个宏观任务（包括微观任务），才会执行下个宏观任务，所以上面的例子是把微观任务加入到了当前宏观任务里了，必须等当前宏观任务（包括所有微观任务）执行完，才会执行 setTimeout 里的下一个宏观任务。","likes_number":11,"is_delete":false,"is_hidden":false,"ctime":1566734234,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1375156,"avatar":"https://static001.geekbang.org/account/avatar/00/14/fb/b4/afbaab2f.jpg","nickname":"徐三响","note":"","ucode":"6B30D451EBD60D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":79145,"discussion_content":"也不是宏任务结束后执行，而是宏任务里的同步代码执行完后立即遍历执行当前微任务列表。","likes_number":8,"is_delete":false,"is_hidden":false,"ctime":1576062038,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1376337,"avatar":"https://static001.geekbang.org/account/avatar/00/15/00/51/f5bffcde.jpg","nickname":"qyy","note":"","ucode":"1C402850653320","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1375156,"avatar":"https://static001.geekbang.org/account/avatar/00/14/fb/b4/afbaab2f.jpg","nickname":"徐三响","note":"","ucode":"6B30D451EBD60D","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":305669,"discussion_content":"对的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600052147,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":79145,"ip_address":""},"score":305669,"extra":""}]},{"author":{"id":1905171,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/12/13/e103a6e3.jpg","nickname":"扩散性百万咸面包","note":"","ucode":"6D703D51553B42","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":240479,"discussion_content":"我也觉得你是对的。\n\n    function sleep(duration) {\n        return new Promise(function(resolve, reject) {\n            console.log(&#34;b&#34;);\n            setTimeout(resolve,duration);\n        })\n    }\n    console.log(&#34;a&#34;);\n    sleep(5000).then(()=>console.log(&#34;c&#34;));\n应该说每一轮宏任务执行完了后都会去执行一遍微任务。\n结合看了其他帖子后，我对于这段代码的真正解释是：首先打印a, b没有问题，其次setTimeout把一个任务添加到宏任务队列，继续执行.then，把回调添加到微任务队列。script宏任务现在执行完毕，要去检查微任务队列，但是发现还没有resolve，不应该执行打印c，于是再跳回宏任务队列。宏任务和微任务都没办法执行，所以我估计JS会在宏队列和微队列反复横跳（Event Loop）。等到setTimeout执行完后，去执行微任务log c才成功。","likes_number":7,"is_delete":false,"is_hidden":false,"ctime":1587368214,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1011450,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/6e/fa/e217af92.jpg","nickname":"mgcnrx11","note":"","ucode":"C4EAA3DA82424B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1905171,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/12/13/e103a6e3.jpg","nickname":"扩散性百万咸面包","note":"","ucode":"6D703D51553B42","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":351537,"discussion_content":"首先打印a，b没有问题，但后续继续执行的then，我觉得then这里的作用只是注册一个函数给resolve的时候去使用，这里并没有“把回调添加到微任务队列”，因此也不应该是“检查微任务队列，但是发现还没有resolve，不应该执行打印c，于是再跳回宏任务队列”。在等到setTimeout的第二个宏任务执行resolve后，这个回调函数会被加入微任务队列，后续才会打印c。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1614320494,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":240479,"ip_address":""},"score":351537,"extra":""},{"author":{"id":2063532,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/7c/ac/482c6eb4.jpg","nickname":"老徐","note":"","ucode":"34566E3D28620C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1011450,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/6e/fa/e217af92.jpg","nickname":"mgcnrx11","note":"","ucode":"C4EAA3DA82424B","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":399551,"discussion_content":"感觉你是对的, 依稀记得then只是给resolve注册一个函数. 所以实际上回调函数是在真正resolve之后再加入到微任务队列","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632990192,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":351537,"ip_address":""},"score":399551,"extra":""}]},{"author":{"id":1592279,"avatar":"https://static001.geekbang.org/account/avatar/00/18/4b/d7/f46c6dfd.jpg","nickname":"William Ning","note":"","ucode":"4DB8D05E69E5F3","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":364745,"discussion_content":"可以参考隔壁专栏李兵老师的《浏览器原理与实践》事件循环宏观微观任务讲的很详细～","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1617591368,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1120997,"avatar":"https://static001.geekbang.org/account/avatar/00/11/1a/e5/6899701e.jpg","nickname":"favorlm","note":"","ucode":"CFD52127AA6E1D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":4534,"discussion_content":"你说的有道理","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565525159,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1057245,"avatar":"https://static001.geekbang.org/account/avatar/00/10/21/dd/f0a0f17b.jpg","nickname":"阳明","note":"","ucode":"BB2498A0EF75A6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1120997,"avatar":"https://static001.geekbang.org/account/avatar/00/11/1a/e5/6899701e.jpg","nickname":"favorlm","note":"","ucode":"CFD52127AA6E1D","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":5874,"discussion_content":"其实没有宏任务的说法都是翻译整出来的，都是直接叫的task和microTask，我很少看到有macroTask的说法。。。","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1566522114,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":4534,"ip_address":""},"score":5874,"extra":""},{"author":{"id":1013281,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/76/21/abb7bfe3.jpg","nickname":"Damon","note":"","ucode":"E07522227DE1E4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1057245,"avatar":"https://static001.geekbang.org/account/avatar/00/10/21/dd/f0a0f17b.jpg","nickname":"阳明","note":"","ucode":"BB2498A0EF75A6","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":309599,"discussion_content":"确实是","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1601364190,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":5874,"ip_address":""},"score":309599,"extra":""}]}]},{"had_liked":false,"id":227181,"user_name":"马克豚","can_delete":false,"product_type":"c1","uid":1999043,"ip_address":"","ucode":"2DE14669743258","user_header":"https://static001.geekbang.org/account/avatar/00/1e/80/c3/82923c17.jpg","comment_is_top":false,"comment_ctime":1592307222,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"233520541206","product_id":100023201,"comment_content":"宏任务和微任务的执行顺序其实很好理解。首先一个js脚本本身对于浏览器而言就是一个宏任务，也是第一个宏任务，而处于其中的代码可能有3种：非异步代码、产生微任务的异步代码（promise等）、产生宏任务的异步代码(settimeout、setinterval等)。<br>我们知道宏任务处于一个队列中，应当先执行完一个宏任务才会执行下一个宏任务，所以在js脚本中，会先执行非异步代码，再执行微任务代码，最后执行宏任务代码。这时候我们进行到了下一个宏任务中，又按照这个顺序执行。<br>微任务总是先于宏任务这个说法不准确，应该是处于同一级的情况下才能这么说。实际上微任务永远是宏任务的一部分，它处于一个大的宏任务内。<br><br><br>","like_count":55},{"had_liked":false,"id":69847,"user_name":"费马","can_delete":false,"product_type":"c1","uid":1190201,"ip_address":"","ucode":"BCAAF9C16F0CC5","user_header":"https://static001.geekbang.org/account/avatar/00/12/29/39/0aec7827.jpg","comment_is_top":false,"comment_ctime":1550885161,"is_pvip":false,"replies":[{"id":"25834","content":"这个写的不错，不过，既然都用到了await，是不是可以不用递归呢？","user_name":"作者回复","user_name_real":"winter","uid":"1268524","ctime":1551425027,"ip_address":"","comment_id":69847,"utype":1}],"discussion_count":5,"race_medal":0,"score":"151874740521","product_id":100023201,"comment_content":"const lightEle = document.getElementById(&#39;traffic-light&#39;);<br>function changeTrafficLight(color, duration) {<br>  return new Promise(function(resolve, reject) {<br>    lightEle.style.background = color;<br>    setTimeout(resolve, duration);<br>  })<br>}<br><br>async function trafficScheduler() {<br>  await changeTrafficLight(&#39;green&#39;, 3000);<br>  await changeTrafficLight(&#39;yellow&#39;, 1000);<br>  await changeTrafficLight(&#39;red&#39;, 2000);<br>  trafficScheduler();<br>}<br><br>trafficScheduler();","like_count":35,"discussions":[{"author":{"id":1268524,"avatar":"https://static001.geekbang.org/account/avatar/00/13/5b/2c/12bfd3cd.jpg","nickname":"winter","note":"","ucode":"2B068EDEAFEB56","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440314,"discussion_content":"这个写的不错，不过，既然都用到了await，是不是可以不用递归呢？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1551425027,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1953884,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/ukjhibz6ORn08JzfiaeicejOZHeoSRgo6r0acKMMjFOMibu0ic67dgCL3ia8Eic5PicD2rLtgMKG28Zr9ErGGlWPjr48WQ/132","nickname":"鲁黎明","note":"","ucode":"2A5CBCAD144187","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":227436,"discussion_content":"while(1)","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1586492600,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1515764,"avatar":"https://static001.geekbang.org/account/avatar/00/17/20/f4/eeb0ae3d.jpg","nickname":"紫de飒殇","note":"","ucode":"94064BBDF1F60E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":102446,"discussion_content":"那么顺势问个问题，递归和循环哪个效率更高呢？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1577346669,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1201350,"avatar":"https://static001.geekbang.org/account/avatar/00/12/54/c6/c2481790.jpg","nickname":"lisiur","note":"","ucode":"CEB2DBCE29CAA7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1515764,"avatar":"https://static001.geekbang.org/account/avatar/00/17/20/f4/eeb0ae3d.jpg","nickname":"紫de飒殇","note":"","ucode":"94064BBDF1F60E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":171870,"discussion_content":"一般情况下循环效率高吧，递归会产生函数调用，过多的函数调用还会造成栈溢出，so...","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581754535,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":102446,"ip_address":""},"score":171870,"extra":""}]},{"author":{"id":1376538,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epoDIyoOY3Iv5mxKtAQ0QwhMoiakFU3NyLRQoj89VibqibosfatYBaUemmUQ8FnBVbGibJAnhRibXJ4FiaQ/132","nickname":"超超","note":"","ucode":"19DE2A60A574AB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":27618,"discussion_content":"...","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1570671767,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":70821,"user_name":"deiphi","can_delete":false,"product_type":"c1","uid":1231746,"ip_address":"","ucode":"33B02A42BC9699","user_header":"https://static001.geekbang.org/account/avatar/00/12/cb/82/d01f40b4.jpg","comment_is_top":false,"comment_ctime":1551189957,"is_pvip":false,"replies":[{"id":"25923","content":"哈哈哈 这个硬核了啊……  结果倒是对的<br><br>不试试Promise吗？ 我讲了这么多呢……","user_name":"作者回复","user_name_real":"winter","uid":"1268524","ctime":1551432423,"ip_address":"","comment_id":70821,"utype":1}],"discussion_count":8,"race_medal":0,"score":"143285110725","product_id":100023201,"comment_content":"&#47;&#47; 比较原始的写法<br>function color () { <br>\tconsole.log(&#39;green&#39;);<br>\t<br>\tsetTimeout(() =&gt; {<br>\t\t\tconsole.log(&#39;yellow&#39;);<br>\t\t\t<br>\t\t\tsetTimeout(() =&gt; {<br>\t\t\t\tconsole.log(&#39;red&#39;);<br>\t\t\t\t<br>\t\t\t\tsetTimeout(color, 2000);<br>\t\t\t}, 1000)<br>\t}, 3000);<br>}<br>color();","like_count":33,"discussions":[{"author":{"id":1268524,"avatar":"https://static001.geekbang.org/account/avatar/00/13/5b/2c/12bfd3cd.jpg","nickname":"winter","note":"","ucode":"2B068EDEAFEB56","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440846,"discussion_content":"哈哈哈 这个硬核了啊……  结果倒是对的\n\n不试试Promise吗？ 我讲了这么多呢……","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551432423,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1388875,"avatar":"https://static001.geekbang.org/account/avatar/00/15/31/4b/0f5b3a0a.jpg","nickname":"Glee","note":"","ucode":"AA0D428E34D29E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":32458,"discussion_content":"原谅我笑出了猪叫声，太硬核了，好可爱~哈哈哈","likes_number":5,"is_delete":false,"is_hidden":false,"ctime":1571039106,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1081340,"avatar":"http://thirdqq.qlogo.cn/qqapp/101418266/26D1B956D260F4480FA4FF037DE840B9/100","nickname":"　　　","note":"","ucode":"E1D783DC763052","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1388875,"avatar":"https://static001.geekbang.org/account/avatar/00/15/31/4b/0f5b3a0a.jpg","nickname":"Glee","note":"","ucode":"AA0D428E34D29E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":41556,"discussion_content":"原谅我也想到的是这种方式_(:з」∠)_","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572450164,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":32458,"ip_address":""},"score":41556,"extra":""}]},{"author":{"id":1382731,"avatar":"https://static001.geekbang.org/account/avatar/00/15/19/4b/c30b6362.jpg","nickname":"周伟","note":"","ucode":"BE5DA105390106","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":392602,"discussion_content":"第一个思路就是这个，哈哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631068284,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2113186,"avatar":"https://static001.geekbang.org/account/avatar/00/20/3e/a2/67c01ee5.jpg","nickname":"Moxy","note":"","ucode":"33C14F3D510320","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":368100,"discussion_content":"hhhhh 好一个 Callback Hell ....","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618566509,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1765033,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/ee/a9/ccd0bd02.jpg","nickname":"追风少年","note":"","ucode":"2EC84A63290E82","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":308941,"discussion_content":"666","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1601127836,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1177430,"avatar":"https://static001.geekbang.org/account/avatar/00/11/f7/56/b82eeac7.jpg","nickname":"champ可口可乐了","note":"","ucode":"EA75C67E9124C7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":259975,"discussion_content":"循环呢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588834363,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1998206,"avatar":"","nickname":"拾梦者","note":"","ucode":"3A0F800005A1D4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1177430,"avatar":"https://static001.geekbang.org/account/avatar/00/11/f7/56/b82eeac7.jpg","nickname":"champ可口可乐了","note":"","ucode":"EA75C67E9124C7","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":264214,"discussion_content":"是循环 他递归了相当于","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589294536,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":259975,"ip_address":""},"score":264214,"extra":""}]}]},{"had_liked":false,"id":71268,"user_name":"奇奇","can_delete":false,"product_type":"c1","uid":1031906,"ip_address":"","ucode":"1AED63F069C040","user_header":"https://static001.geekbang.org/account/avatar/00/0f/be/e2/57d62270.jpg","comment_is_top":false,"comment_ctime":1551315100,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"113220464796","product_id":100023201,"comment_content":"怎么区分是宿主环境还是js引擎发起的任务呢","like_count":26,"discussions":[{"author":{"id":1484978,"avatar":"https://static001.geekbang.org/account/avatar/00/16/a8/b2/10ca1126.jpg","nickname":"尘埃🎈","note":"","ucode":"7DFA126EB1FCF9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":345152,"discussion_content":"可不可以这样理解：任务的产生是因为需要宿主需要在特定时机去传递给js引擎去执行，比如 setTimeout   setInterval 这样的api 称为宿主任务，这样的任务可能有 Promise这样 的异步代码，所以 微任务必须保证在同一个宏任务中执行","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1611671240,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1698735,"avatar":"https://static001.geekbang.org/account/avatar/00/19/eb/af/e49af9a8.jpg","nickname":"JC.彦","note":"","ucode":"E87C1420B140F4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":259407,"discussion_content":"如事件就是寄主环境发起的，Promise,await就是js引擎发起的。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1588776712,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":203202,"user_name":"wingsico","can_delete":false,"product_type":"c1","uid":1126631,"ip_address":"","ucode":"A91CB7B0497708","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/s0bx4WXQNkAJ3c3map0g6dlt3sKDgTtN7Ria96YoufjQcVVI8Shv5CN1jnK1ZTImNnlPcibRqvyiaUuhpIvV1TpnQ/132","comment_is_top":false,"comment_ctime":1586155211,"is_pvip":true,"discussion_count":3,"race_medal":0,"score":"70305631947","product_id":100023201,"comment_content":"这一节主要讲了一下JS的执行栈，从宿主环境到JS引擎，分为宏任务和微任务。但实际上并没有阐述的十分清楚，只是根据一些比较浅显的现象来说明了一下这些任务的执行机制。<br><br>对于为什么采用事件循环，以及多种宏任务队列以及浏览器渲染，IO，网络请求等均无涉及。<br><br>实际上事件循环依赖于宿主，是宿主需要事件循环来协调js中多种事件源进行交互。而事件循环并不是js本身具有的能力。<br><br>对于浏览器中的多种的宏任务队列，可分为页面渲染、用户交互、网络请求、History API以及计时器等，不同种类的宏任务队列之间的优先级不同，也跟实际执行的时机有关，不同时机得到的结果也会不同。<br><br>而浏览器中的事件循环与Node中的事件循环也有区别（原因上面说了），Node中没有DOM，没有页面渲染，但多了文件读取等。在Node11之前，Node中一次事件循环可以执行完所有宏任务后再进入下一次事件循环。在Node中，各种不同的宏任务之间也有优先级，并且是固定的，但跟执行的时机也有关系。所以我们也经常看到重复执行一段代码会得到不同的结果。但具体的一个运作机制我目前仍然没有搞清楚，翻看了很多资料也没有对这部分有着详细的阐述。<br><br>","like_count":17,"discussions":[{"author":{"id":2813740,"avatar":"https://static001.geekbang.org/account/avatar/00/2a/ef/2c/9f96ded7.jpg","nickname":"Ha0ran","note":"","ucode":"A36AD84DAC48B2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":573938,"discussion_content":"官网貌似有一篇关于Node的事件循环","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1653737410,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1564786,"avatar":"https://static001.geekbang.org/account/avatar/00/17/e0/72/6e0314e7.jpg","nickname":"Ace","note":"","ucode":"C77191A6B18845","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":310024,"discussion_content":"我也觉得时间循环没怎么讲清楚。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1601561130,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1163321,"avatar":"https://static001.geekbang.org/account/avatar/00/11/c0/39/16340f72.jpg","nickname":"zlxag","note":"","ucode":"136FB0201B64A3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":258630,"discussion_content":"可能是有些概念不清晰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588695863,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":201621,"user_name":"顾盼神飞👻","can_delete":false,"product_type":"c1","uid":1411966,"ip_address":"","ucode":"EB3579A3868D14","user_header":"https://static001.geekbang.org/account/avatar/00/15/8b/7e/f78e86a8.jpg","comment_is_top":false,"comment_ctime":1585813287,"is_pvip":false,"discussion_count":5,"race_medal":0,"score":"66010322727","product_id":100023201,"comment_content":"js 版本 最高赞同学够标准 来个 css 版本 哈哈<br>&lt;div class=&quot;toggle-color&quot;&gt;&lt;&#47;div&gt;<br>.toggle-color {<br>\t\t\twidth: 100px;<br>\t\t\theight: 100px;<br>\t\t\tanimation: toggle_color linear 6s infinite<br>\t\t}<br><br>\t\t@keyframes toggle_color {<br><br>\t\t\t0%,<br>\t\t\t50% {<br>\t\t\t\tbackground: green<br>\t\t\t}<br><br>\t\t\t51%,<br>\t\t\t67% {<br>\t\t\t\tbackground: yellow<br>\t\t\t}<br><br>\t\t\t68%,<br>\t\t\t100% {<br>\t\t\t\tbackground: red<br>\t\t\t}<br>\t\t}","like_count":15,"discussions":[{"author":{"id":1376539,"avatar":"https://static001.geekbang.org/account/avatar/00/15/01/1b/936b51bd.jpg","nickname":"埼玉","note":"","ucode":"7F60115E0651C3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":327219,"discussion_content":"秀儿","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1605770478,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1400998,"avatar":"https://static001.geekbang.org/account/avatar/00/15/60/a6/341c3e31.jpg","nickname":"不带布兜","note":"","ucode":"3BC07B89A3B058","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":341451,"discussion_content":"过渡效果能优化吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1610423405,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1289909,"avatar":"https://static001.geekbang.org/account/avatar/00/13/ae/b5/75daf3a2.jpg","nickname":"郭立leeจุ๊บ","note":"","ucode":"DB13454A74D502","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":321632,"discussion_content":"皮，同学们不要模仿, 有很多缺点\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604613640,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1365578,"avatar":"https://static001.geekbang.org/account/avatar/00/14/d6/4a/159db001.jpg","nickname":"。。。","note":"","ucode":"7F943EEB55560C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":311508,"discussion_content":"我警告你，你不要在这里油～～～～哈哈哈哈哈哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1602380626,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1910075,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/25/3b/a971fc8e.jpg","nickname":"阿感","note":"","ucode":"7BCB7E44A832D1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":253347,"discussion_content":"👏🏻css秀同学","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588228640,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":70072,"user_name":"许吉中","can_delete":false,"product_type":"c1","uid":1395219,"ip_address":"","ucode":"031FCB7DD2441F","user_header":"https://static001.geekbang.org/account/avatar/00/15/4a/13/42e02b09.jpg","comment_is_top":false,"comment_ctime":1550985504,"is_pvip":false,"replies":[{"id":"25846","content":"它产生Promise，当然是微观任务了","user_name":"作者回复","user_name_real":"winter","uid":"1268524","ctime":1551425655,"ip_address":"","comment_id":70072,"utype":1}],"discussion_count":2,"race_medal":0,"score":"57385560352","product_id":100023201,"comment_content":"async&#47;await函数属于宏观还是微观？","like_count":13,"discussions":[{"author":{"id":1268524,"avatar":"https://static001.geekbang.org/account/avatar/00/13/5b/2c/12bfd3cd.jpg","nickname":"winter","note":"","ucode":"2B068EDEAFEB56","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440428,"discussion_content":"它产生Promise，当然是微观任务了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551425655,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":3166573,"avatar":"https://static001.geekbang.org/account/avatar/00/30/51/6d/e4aed428.jpg","nickname":"%","note":"","ucode":"C5FC6B541307AE","race_medal":1,"user_type":1,"is_pvip":false},"reply_author":{"id":1268524,"avatar":"https://static001.geekbang.org/account/avatar/00/13/5b/2c/12bfd3cd.jpg","nickname":"winter","note":"","ucode":"2B068EDEAFEB56","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":588242,"discussion_content":"所以await后面的代码可以理解为都是async产生的promise的resolve微任务吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1663605282,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":440428,"ip_address":"上海"},"score":588242,"extra":""}]}]},{"had_liked":false,"id":70752,"user_name":"奥斯特洛夫斯基","can_delete":false,"product_type":"c1","uid":1379844,"ip_address":"","ucode":"9AFECAC3A1FCAD","user_header":"https://static001.geekbang.org/account/avatar/00/15/0e/04/d710d928.jpg","comment_is_top":false,"comment_ctime":1551174916,"is_pvip":false,"replies":[{"id":"25922","content":"应该说一个script标签是一个宏任务。","user_name":"作者回复","user_name_real":"winter","uid":"1268524","ctime":1551432365,"ip_address":"","comment_id":70752,"utype":1}],"discussion_count":1,"race_medal":0,"score":"44500847876","product_id":100023201,"comment_content":"同步的代码和setTimeout都是宏任务？","like_count":11,"discussions":[{"author":{"id":1268524,"avatar":"https://static001.geekbang.org/account/avatar/00/13/5b/2c/12bfd3cd.jpg","nickname":"winter","note":"","ucode":"2B068EDEAFEB56","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440809,"discussion_content":"应该说一个script标签是一个宏任务。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1551432365,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":84085,"user_name":"小孔","can_delete":false,"product_type":"c1","uid":1470304,"ip_address":"","ucode":"F76D25C5417F2D","user_header":"https://static001.geekbang.org/account/avatar/00/16/6f/60/edbb8b8a.jpg","comment_is_top":false,"comment_ctime":1554780490,"is_pvip":false,"replies":[{"id":"30358","content":"1. 对<br>2. 还是宏观任务，因为你调用到了引擎以外的API呀","user_name":"作者回复","user_name_real":"winter","uid":"1268524","ctime":1554804214,"ip_address":"","comment_id":84085,"utype":1}],"discussion_count":1,"race_medal":0,"score":"35914518858","product_id":100023201,"comment_content":"1. async&#47;await ，遇到await时就会退出执行，我想问下，退出之后是处于等待await执行完再开始之后吗？<br>2. 如果promise中产生setTimeout函数，那么在这里的setTimeout是处于微观任务对吗？因为这是js引擎直接发起的？<br>","like_count":8,"discussions":[{"author":{"id":1268524,"avatar":"https://static001.geekbang.org/account/avatar/00/13/5b/2c/12bfd3cd.jpg","nickname":"winter","note":"","ucode":"2B068EDEAFEB56","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":446248,"discussion_content":"1. 对\n2. 还是宏观任务，因为你调用到了引擎以外的API呀","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1554804214,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":94783,"user_name":"CaveShao","can_delete":false,"product_type":"c1","uid":1478271,"ip_address":"","ucode":"E45740787F82AB","user_header":"https://static001.geekbang.org/account/avatar/00/16/8e/7f/4ff4472f.jpg","comment_is_top":false,"comment_ctime":1557896784,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"27327700560","product_id":100023201,"comment_content":"   function func(color, duration) {<br>        return new Promise(function(resolve, reject) {<br>            light.style.backgroundColor = color;<br>            setTimeout(function() {<br>                it.next();<br>            }, duration)<br>        })<br>    }<br><br>    function* main() {<br>        while (1) {<br>            yield func(&#39;red&#39;,2000);<br>            yield func(&#39;yellow&#39;,1000);<br>            yield func(&#39;green&#39;,3000);<br>        }<br>    }<br><br>    var it = main();<br>    it.next();","like_count":6},{"had_liked":false,"id":78665,"user_name":"帅气小熊猫","can_delete":false,"product_type":"c1","uid":1022199,"ip_address":"","ucode":"88FE6B57F55063","user_header":"https://static001.geekbang.org/account/avatar/00/0f/98/f7/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1553215057,"is_pvip":false,"discussion_count":3,"race_medal":0,"score":"27323018833","product_id":100023201,"comment_content":"怎么确定这个微任务属于一个宏任务呢，js主线程跑下来，遇到setTImeout会放到异步队列宏任务中，那下面的遇到的promise怎么判断出它是属于这个宏任务呢？是不是只有这个宏任务没有从异步队列中取出，中间所碰到的所有微任务都属于这个宏任务？","like_count":6,"discussions":[{"author":{"id":1344810,"avatar":"https://static001.geekbang.org/account/avatar/00/14/85/2a/376dd985.jpg","nickname":"uccs","note":"","ucode":"93DF5B81AB170E","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":304356,"discussion_content":"宏任务有宏任务队列，微任务有微任务队列，一个宏任务会跟一个微任务队列，也就是说在当前宏任务执行结束前，会去执行当前宏任务产生的微任务队列，微任务队列执行完后，在从宏任务队列中取出一个宏任务执行，这个宏任务执行结束前，再执行这个宏任务中产生的微任务队列，一直这样重复执行，直到全部的宏任务和微任务执行完","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1599552490,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1201350,"avatar":"https://static001.geekbang.org/account/avatar/00/12/54/c6/c2481790.jpg","nickname":"lisiur","note":"","ucode":"CEB2DBCE29CAA7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":171878,"discussion_content":"我的理解是，宏任务和微任务是两个不相关队列，js是单线程的，所以任何时候，新加的任务不是宏任务就是微任务。执行顺序是：依次执行宏任务，但是执行下一个宏任务的前提是当前微任务队列为空。","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1581754874,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1113661,"avatar":"","nickname":"Geek_c0a663","note":"","ucode":"9DD00AFB8E65F8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":289688,"discussion_content":"既然下一个宏任务执行前微任务队列必为空，那就意味着微任务队列的更新必由当前宏任务执行过程中的逻辑触发","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594179829,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":70672,"user_name":"周序猿","can_delete":false,"product_type":"c1","uid":1374169,"ip_address":"","ucode":"C6D09DBAA22F94","user_header":"https://static001.geekbang.org/account/avatar/00/14/f7/d9/3014889f.jpg","comment_is_top":false,"comment_ctime":1551161583,"is_pvip":false,"replies":[{"id":"25919","content":"额 这个结果是对的 不过封装成这样 合适吗？","user_name":"作者回复","user_name_real":"winter","uid":"1268524","ctime":1551432117,"ip_address":"","comment_id":70672,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18731030767","product_id":100023201,"comment_content":"&#47;&#47; 另类的写法<br> var lightDiv = document.getElementById(&#39;light&#39;)<br>    function wait(seconds){<br>      return new Promise((resolve)=&gt;{<br>        setTimeout(resolve,seconds)<br>      })<br>    }<br><br>    function light(color, waitTime){<br>      this.color = color<br>      this.waitTime = waitTime<br>    }<br>    light.prototype.run = function(){<br>      lightDiv.style.backgroundColor = this.color<br>      return wait(this.waitTime).then(()=&gt;{<br>        return this.nextLight.run()<br>      })<br>    }<br><br>    let redLight = new light(&#39;red&#39;,2000)<br>    let yellowLight = new light(&#39;yellow&#39;,1000)<br>    let greenLight = new light(&#39;green&#39;,3000)<br><br>    redLight.nextLight = greenLight<br>    yellowLight.nextLight = redLight<br>    greenLight.nextLight = yellowLight<br><br>    redLight.run()","like_count":4,"discussions":[{"author":{"id":1268524,"avatar":"https://static001.geekbang.org/account/avatar/00/13/5b/2c/12bfd3cd.jpg","nickname":"winter","note":"","ucode":"2B068EDEAFEB56","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440761,"discussion_content":"额 这个结果是对的 不过封装成这样 合适吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551432117,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":69882,"user_name":"许童童","can_delete":false,"product_type":"c1","uid":1003005,"ip_address":"","ucode":"4B799C0C6BC678","user_header":"https://static001.geekbang.org/account/avatar/00/0f/4d/fd/0aa0e39f.jpg","comment_is_top":false,"comment_ctime":1550896078,"is_pvip":false,"replies":[{"id":"25837","content":"你这个有点问题，执行多了可能爆栈，改改试试？","user_name":"作者回复","user_name_real":"winter","uid":"1268524","ctime":1551425229,"ip_address":"","comment_id":69882,"utype":1}],"discussion_count":6,"race_medal":0,"score":"18730765262","product_id":100023201,"comment_content":"async function controlLoop () {<br>  await changeColor(&#39;green&#39;, 3000)<br>  await changeColor(&#39;yellow&#39;, 1000)<br>  await changeColor(&#39;red&#39;, 2000)<br>  await controlLoop()<br>}<br><br>async function changeColor (color, time) {<br>  console.log(color + &#39; begin&#39;)<br>  return new Promise((resolve) =&gt; {<br>    setTimeout(() =&gt; {<br>      console.log(color + &#39; end&#39;)<br>      resolve()<br>    }, time)<br>  })<br>}<br><br>controlLoop()","like_count":4,"discussions":[{"author":{"id":1268524,"avatar":"https://static001.geekbang.org/account/avatar/00/13/5b/2c/12bfd3cd.jpg","nickname":"winter","note":"","ucode":"2B068EDEAFEB56","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440329,"discussion_content":"你这个有点问题，执行多了可能爆栈，改改试试？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551425229,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1267308,"avatar":"https://static001.geekbang.org/account/avatar/00/13/56/6c/0e19dcbf.jpg","nickname":"jss","note":"","ucode":"DB0D2CA916EF17","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":286003,"discussion_content":"      let colorArr = [\n        { color: &#34;green&#34;, duration: 1 },\n        { color: &#34;yellow&#34;, duration: 1 },\n        { color: &#34;red&#34;, duration: 1 },\n      ];\n\n      let count = 0;\n\n      function autoRun() {\n        let color = colorArr[count % 3].color;\n        let duration = colorArr[(count + 1) % 3].duration;\n        return new Promise((resolve) => {\n          setTimeout(() => {\n            resolve()\n            setColor(color);\n          }, duration);\n        });\n      }\n\n      function setColor(color) {\n        document.querySelector(&#39;.color&#39;).style.backgroundColor = color\n        console.log(count, color);\n        count++;\n        autoRun()\n      }\n\n      autoRun();\n\n我这样试了一下执行20000次没有爆栈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1593010837,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1698448,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKwic6jhGhicZ99aYDhGvJQ6zz8EVbCJsTh1qfhors2FzCSZAO8z4ibArGnsyOl7Tc8e3Vr4240V7oqQ/132","nickname":"Geek_7cc450","note":"","ucode":"337CC3DEA138F4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":44487,"discussion_content":"是因为一直递归没有返回吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572953496,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1078023,"avatar":"https://static001.geekbang.org/account/avatar/00/10/73/07/c1a31ede.jpg","nickname":"刘先森","note":"","ucode":"87ACF0D9AFD52D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":37070,"discussion_content":"虽然用了递归但是没有引用任何变量，应该不会爆吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571494075,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1391613,"avatar":"https://static001.geekbang.org/account/avatar/00/15/3b/fd/37bf3990.jpg","nickname":"王冠","note":"","ucode":"DC1DF5FE36C7F0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":8102,"discussion_content":"为啥会爆栈+1","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567779337,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1374653,"avatar":"https://static001.geekbang.org/account/avatar/00/14/f9/bd/77862a22.jpg","nickname":"CHENJIAJIE","note":"","ucode":"11C522D35C9771","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":3804,"discussion_content":"能解答一下为什么会爆栈吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564824358,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":131752,"user_name":"dellyoung","can_delete":false,"product_type":"c1","uid":1133028,"ip_address":"","ucode":"3672FF1D1F8EFD","user_header":"https://static001.geekbang.org/account/avatar/00/11/49/e4/fb47bfcd.jpg","comment_is_top":false,"comment_ctime":1567874182,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"14452776070","product_id":100023201,"comment_content":"15行代码最简实现：<br>const changeNowColor = (time) =&gt; {<br>    setTimeout(() =&gt; {<br>        switch (document.getElementById(&#39;root&#39;).style.background) {<br>            case &#39;green&#39;:<br>                document.getElementById(&#39;root&#39;).style.background = &#39;yellow&#39;;<br>                return changeNowColor(1000);<br>            case &#39;yellow&#39;:<br>                document.getElementById(&#39;root&#39;).style.background = &#39;red&#39;;<br>                return changeNowColor(2000);<br>            case &#39;red&#39;:<br>                document.getElementById(&#39;root&#39;).style.background = &#39;green&#39;;<br>                return changeNowColor(3000);<br>        }<br>    }, time);<br>};<br>changeNowColor(3000);","like_count":4},{"had_liked":false,"id":111594,"user_name":"🇨🇳🇨🇳🇨🇳","can_delete":false,"product_type":"c1","uid":1023202,"ip_address":"","ucode":"814DE82B65007E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/9c/e2/368f6734.jpg","comment_is_top":false,"comment_ctime":1562570539,"is_pvip":false,"replies":[{"id":"58921","content":"这不是胡说呢么。","user_name":"作者回复","user_name_real":"winter","uid":"1268524","ctime":1574221132,"ip_address":"","comment_id":111594,"utype":1}],"discussion_count":2,"race_medal":0,"score":"14447472427","product_id":100023201,"comment_content":"async&#47;awiat 只是generator&#47;iterator的语法糖而已","like_count":3,"discussions":[{"author":{"id":1268524,"avatar":"https://static001.geekbang.org/account/avatar/00/13/5b/2c/12bfd3cd.jpg","nickname":"winter","note":"","ucode":"2B068EDEAFEB56","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457384,"discussion_content":"这不是胡说呢么。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1574221132,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1367464,"avatar":"https://static001.geekbang.org/account/avatar/00/14/dd/a8/a2c910b6.jpg","nickname":"katalya","note":"","ucode":"CCD1FE6C4F8C1E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":584414,"discussion_content":"阮一峰的网址也有这个说法，这给我干懵了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660810557,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":84758,"user_name":"拒绝第十七次🤤","can_delete":false,"product_type":"c1","uid":1170443,"ip_address":"","ucode":"B75CE9C1D29D30","user_header":"https://static001.geekbang.org/account/avatar/00/11/dc/0b/0baff83d.jpg","comment_is_top":false,"comment_ctime":1554903177,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"14439805065","product_id":100023201,"comment_content":"    let sleep = (color,deep)=&gt;{<br>      return new Promise(reslove=&gt;{<br>        setTimeout(()=&gt;reslove(color) ,deep)<br>      })<br>    }<br>    async function  changColor (color){<br>      await sleep (&#39;green&#39;,3000),<br>      await sleep (&#39;yellow&#39;,1000)<br>      await sleep (&#39;red&#39;,2000)<br>    }<br>    changColor();","like_count":3,"discussions":[{"author":{"id":1663917,"avatar":"https://static001.geekbang.org/account/avatar/00/19/63/ad/5e90bac7.jpg","nickname":"Amui","note":"","ucode":"4D76F86046B06A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":161169,"discussion_content":"只执行了一次啊","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580873648,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":72120,"user_name":"oillie","can_delete":false,"product_type":"c1","uid":1031714,"ip_address":"","ucode":"5907CE80C45CB5","user_header":"https://static001.geekbang.org/account/avatar/00/0f/be/22/8bb1640f.jpg","comment_is_top":false,"comment_ctime":1551525164,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"14436427052","product_id":100023201,"comment_content":"一个宏任务包含一个微任务队列？还是一个event loop里只有一个微任务队列，虽然不影响实际效果，但还是想确认下..","like_count":3,"discussions":[{"author":{"id":2813740,"avatar":"https://static001.geekbang.org/account/avatar/00/2a/ef/2c/9f96ded7.jpg","nickname":"Ha0ran","note":"","ucode":"A36AD84DAC48B2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":573939,"discussion_content":"事件循环里可以包含了多个宏任务，宏任务里可以包含多个微任务","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1653737487,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1113661,"avatar":"","nickname":"Geek_c0a663","note":"","ucode":"9DD00AFB8E65F8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":289689,"discussion_content":"主要还是概念理解为主，前者比较合适，整体理解比较方便；后者偏实现细节","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594180079,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":70824,"user_name":"Geek_e21f0d","can_delete":false,"product_type":"c1","uid":1386373,"ip_address":"","ucode":"B83F55322BF73B","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJEPMj69Hy9qq8SuEsiccKKaJQt20vvjl9Z9DMJxNmvrq6X3LrDMONTT6Jkg70kEVg13Lkdc6eMWlA/132","comment_is_top":false,"comment_ctime":1551190839,"is_pvip":false,"replies":[{"id":"25924","content":"封装不是越复杂越好，太复杂了还不如直接setTimeout了","user_name":"作者回复","user_name_real":"winter","uid":"1268524","ctime":1551432482,"ip_address":"","comment_id":70824,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14436092727","product_id":100023201,"comment_content":"let lightStates = [{<br>        color: &#39;green&#39;,<br>        duration: 3000<br>    },<br>    {<br>        color: &#39;yellow&#39;,<br>        duration: 1000<br>    },<br>    {<br>        color: &#39;red&#39;,<br>        duration: 2000<br>    }];<br>    let setLightColorAndVisibleDuration = function(color, duration) {<br>        &#47;&#47;set light color<br>        return new Promise((resolve) =&gt; {<br>            setTimeout(() =&gt; {<br>                resolve();<br>            }, duration);<br>        });<br>    }<br>    let startShowLight = async function() {<br>        let index = 0;<br>        while(index &lt;= lightStates.length - 1) {<br>            let nextState = lightStates[index];<br>            await setLightColorAndVisibleDuration(nextState.color, nextState.duration);<br>            index++;<br>        }<br>        <br>    };<br>    startShowLight();","like_count":3,"discussions":[{"author":{"id":1268524,"avatar":"https://static001.geekbang.org/account/avatar/00/13/5b/2c/12bfd3cd.jpg","nickname":"winter","note":"","ucode":"2B068EDEAFEB56","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440848,"discussion_content":"封装不是越复杂越好，太复杂了还不如直接setTimeout了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551432482,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":70669,"user_name":"Jurieo","can_delete":false,"product_type":"c1","uid":1382175,"ip_address":"","ucode":"A4ED90DC31F446","user_header":"https://static001.geekbang.org/account/avatar/00/15/17/1f/47868a4a.jpg","comment_is_top":false,"comment_ctime":1551161268,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"14436063156","product_id":100023201,"comment_content":"哈哈，我自己思考的执行顺序是 同步-异步-回调，成功正确输出了老师你上面的各个代码的答案。","like_count":3},{"had_liked":false,"id":69824,"user_name":"NeverEver","can_delete":false,"product_type":"c1","uid":1247966,"ip_address":"","ucode":"29194A962340A6","user_header":"https://static001.geekbang.org/account/avatar/00/13/0a/de/8c4810b0.jpg","comment_is_top":false,"comment_ctime":1550854674,"is_pvip":false,"replies":[{"id":"25830","content":"代码写写看呀。 动手是收获最大的。","user_name":"作者回复","user_name_real":"winter","uid":"1268524","ctime":1551424934,"ip_address":"","comment_id":69824,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14435756562","product_id":100023201,"comment_content":"我想到的方法是用Recursion。写一个函数setColor，需要一个参数color，函数里首先把div的backgroundColor设置color，然后用setTimeout来设置下一个颜色，根据传入的color相应更改时间和颜色即可","like_count":3,"discussions":[{"author":{"id":1268524,"avatar":"https://static001.geekbang.org/account/avatar/00/13/5b/2c/12bfd3cd.jpg","nickname":"winter","note":"","ucode":"2B068EDEAFEB56","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440303,"discussion_content":"代码写写看呀。 动手是收获最大的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551424934,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":307059,"user_name":"Friday","can_delete":false,"product_type":"c1","uid":1438506,"ip_address":"","ucode":"AAC10610CF848D","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJ9Y45QovHzGatCRAIdAaCmWuQIZv88zdDeWsbR8w58FX34a4g5PPdna4f5phodeKDia2kWNR9mjJA/132","comment_is_top":false,"comment_ctime":1628844203,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10218778795","product_id":100023201,"comment_content":"这一章关于宏任务和微任务的讲解很不清楚。第一并不是宏任务包含微任务。第二也不是微任务先于宏任务执行。老师的这一章真的讲的很乱。","like_count":2},{"had_liked":false,"id":213986,"user_name":"sh","can_delete":false,"product_type":"c1","uid":1428920,"ip_address":"","ucode":"720991D01D50D9","user_header":"https://static001.geekbang.org/account/avatar/00/15/cd/b8/14597b01.jpg","comment_is_top":false,"comment_ctime":1588608243,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"10178542835","product_id":100023201,"comment_content":"有一点没明白老师，js是单线程的 宏任务是由浏览器执行的 所以是异步，这个理解。但是微任务promise您这里说是js自身执行的，那么既然js是单线程，很好奇这里的异步是如何做到的呢？","like_count":2,"discussions":[{"author":{"id":2225061,"avatar":"https://static001.geekbang.org/account/avatar/00/21/f3/a5/b34f7074.jpg","nickname":"Hero","note":"","ucode":"1B916D1F98BEB6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":398327,"discussion_content":"js本身是一个单线程，但是浏览器是多线程。  异步线程和js线程都是浏览器众多线程中的一部分，浏览器总共有大概六七个线程。 印象中是这样的 你可以再去研究下哈。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632757582,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":104655,"user_name":"大力","can_delete":false,"product_type":"c1","uid":1364353,"ip_address":"","ucode":"1B2125C519443D","user_header":"https://static001.geekbang.org/account/avatar/00/14/d1/81/89ba9d81.jpg","comment_is_top":false,"comment_ctime":1560815470,"is_pvip":false,"replies":[{"id":"58944","content":"更乱了，很难分析","user_name":"作者回复","user_name_real":"winter","uid":"1268524","ctime":1574222298,"ip_address":"","comment_id":104655,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10150750062","product_id":100023201,"comment_content":"用了async, await后貌似宏观与微观任务分得没那么清晰了。","like_count":2,"discussions":[{"author":{"id":1268524,"avatar":"https://static001.geekbang.org/account/avatar/00/13/5b/2c/12bfd3cd.jpg","nickname":"winter","note":"","ucode":"2B068EDEAFEB56","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":454362,"discussion_content":"更乱了，很难分析","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574222298,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":84996,"user_name":"a小磊。จุ๊บ 🌹","can_delete":false,"product_type":"c1","uid":1291044,"ip_address":"","ucode":"9F9CE2C46BB7DB","user_header":"https://static001.geekbang.org/account/avatar/00/13/b3/24/1ee8fe0e.jpg","comment_is_top":false,"comment_ctime":1554953750,"is_pvip":false,"discussion_count":3,"race_medal":0,"score":"10144888342","product_id":100023201,"comment_content":"大佬们我有问题想不明白：<br>new Promise(function(resovle, reject) {<br>        setTimeout(resovle, duration);<br>      })<br>setTimeout(resovle, duration);和setTimeout(() =&gt; {resovle()}, duration);两者到底有什么区别，想不明白，求教","like_count":2,"discussions":[{"author":{"id":1910075,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/25/3b/a971fc8e.jpg","nickname":"阿感","note":"","ucode":"7BCB7E44A832D1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":253388,"discussion_content":"面试题你看看\nfunction sayHi(){\n    console.log(&#39;Hello,&#39;, this.name);\n}\nvar person1 = {\n    name: &#39;YvetteLau&#39;,\n    sayHi: function(){\n        setTimeout(function(){\n            console.log(&#39;Hello,&#39;,this.name);\n        })\n    }\n}\nvar person2 = {\n    name: &#39;Christina&#39;,\n    sayHi: sayHi\n}\nvar name=&#39;Wiliam&#39;;\nperson1.sayHi();\nsetTimeout(person2.sayHi,100);\nsetTimeout(function(){\n    person2.sayHi();\n},200);\n结果为:\n\nHello, Wiliam\nHello, Wiliam\nHello, Christina\n来自\nhttps://github.com/YvetteLau/Blog/issues/6","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1588231357,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1193745,"avatar":"https://static001.geekbang.org/account/avatar/00/12/37/11/423fa8c5.jpg","nickname":"一直很安静","note":"","ucode":"13154258644BD0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":306436,"discussion_content":"所以，整两种写法的this指向不是一样的吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600267910,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1910075,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/25/3b/a971fc8e.jpg","nickname":"阿感","note":"","ucode":"7BCB7E44A832D1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":253374,"discussion_content":"前几天看了有关this指向的问题，在setTimeout中this有时候变的奇怪。这里应该可以回答一个区别点……\nsetTimeout(myArray.myMethod, 1000); // prints &#34;[object Window]&#34; after 1 second\n若你想把this依旧指向myArray这个对象，一个通用的方法是用包装函数来设置this：\nsetTimeout(function(){myArray.myMethod()}, 2000); // prints &#34;zero,one,two&#34; after 2 seconds\n或者\nsetTimeout(() => {myArray.myMethod()}, 2000); // prints &#34;zero,one,two&#34; after 2 seconds\n来自\nhttps://developer.mozilla.org/zh-CN/docs/Web/API/Window/setTimeout\n\nsetTimeout(fn,delay) { fn(); } 实际上fn是一个参数传递的引用(fn=obj.cool),在fn=obj.cool这里，this的指向从obj变成了全局，（fn的调用者是window对象，所以this指向了window)  这几句话意思能够说明this的变化\n来自 https://segmentfault.com/q/1010000010340361\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588230622,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":83166,"user_name":"Geek_55d7cf","can_delete":false,"product_type":"c1","uid":1294267,"ip_address":"","ucode":"E2D10A487E399A","user_header":"https://static001.geekbang.org/account/avatar/00/13/bf/bb/c0e9847e.jpg","comment_is_top":false,"comment_ctime":1554447506,"is_pvip":false,"replies":[{"id":"30362","content":"很多啊 还有event","user_name":"作者回复","user_name_real":"winter","uid":"1268524","ctime":1554804841,"ip_address":"","comment_id":83166,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10144382098","product_id":100023201,"comment_content":"除了setTimeout还有哪些宏观任务呢？<br>","like_count":2,"discussions":[{"author":{"id":1268524,"avatar":"https://static001.geekbang.org/account/avatar/00/13/5b/2c/12bfd3cd.jpg","nickname":"winter","note":"","ucode":"2B068EDEAFEB56","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":445897,"discussion_content":"很多啊 还有event","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1554804841,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":72655,"user_name":"sura","can_delete":false,"product_type":"c1","uid":1375463,"ip_address":"","ucode":"B4EB11AA17C40B","user_header":"https://static001.geekbang.org/account/avatar/00/14/fc/e7/6454a621.jpg","comment_is_top":false,"comment_ctime":1551686432,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10141621024","product_id":100023201,"comment_content":"关于async await 推荐看这个 https:&#47;&#47;segmentfault.com&#47;q&#47;1010000016147496","like_count":2},{"had_liked":false,"id":69890,"user_name":"不曾潇洒","can_delete":false,"product_type":"c1","uid":1236542,"ip_address":"","ucode":"5084439B0BC796","user_header":"https://static001.geekbang.org/account/avatar/00/12/de/3e/2e87843c.jpg","comment_is_top":false,"comment_ctime":1550897276,"is_pvip":false,"replies":[{"id":"25839","content":"属于第二个宏任务，因为它在setTimeout之后执行。","user_name":"作者回复","user_name_real":"winter","uid":"1268524","ctime":1551425338,"ip_address":"","comment_id":69890,"utype":1}],"discussion_count":2,"race_medal":0,"score":"10140831868","product_id":100023201,"comment_content":"老师你好，看了这篇文章后受益匪浅，有个小问题:<br>在Promise段的最后一个例子中，最后一句代码:<br>sleep(5000).then(()=&gt;{console.log(&#39;c&#39;)})，<br>这里面的打印c是属于第一个宏任务还是属于setTime产生的第二个宏任务呢?","like_count":2,"discussions":[{"author":{"id":1268524,"avatar":"https://static001.geekbang.org/account/avatar/00/13/5b/2c/12bfd3cd.jpg","nickname":"winter","note":"","ucode":"2B068EDEAFEB56","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440334,"discussion_content":"属于第二个宏任务，因为它在setTimeout之后执行。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551425338,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1384028,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eplmzz3iccOAekzibWpSkMDlCE8oTujvy8aBMv0wANjTzuyyNXtfuiauGHMtfHtia9T0bd7w0B3lvg3zw/132","nickname":"王方园","note":"","ucode":"1E07EA4453B702","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":128435,"discussion_content":"恍然大悟","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578639108,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":69829,"user_name":"阿成","can_delete":false,"product_type":"c1","uid":1390032,"ip_address":"","ucode":"CEC3CD65FB9333","user_header":"https://static001.geekbang.org/account/avatar/00/15/35/d0/f2ac6d91.jpg","comment_is_top":false,"comment_ctime":1550879362,"is_pvip":false,"replies":[{"id":"25832","content":"嘿 这是借用了我的Sleep吗<br><br>不过我的sleep里单位可是毫秒啊……","user_name":"作者回复","user_name_real":"winter","uid":"1268524","ctime":1551424985,"ip_address":"","comment_id":69829,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10140813954","product_id":100023201,"comment_content":"略简陋...<br>&#47;&#47; sleep,green,red,yellow already defined<br>async function main () {<br>  while (true) {<br>    green()<br>    await sleep(3)<br>    yellow ()<br>    await sleep (1)<br>    red()<br>    await sleep(2)<br>  }<br>}<br>main()","like_count":2,"discussions":[{"author":{"id":1268524,"avatar":"https://static001.geekbang.org/account/avatar/00/13/5b/2c/12bfd3cd.jpg","nickname":"winter","note":"","ucode":"2B068EDEAFEB56","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440305,"discussion_content":"嘿 这是借用了我的Sleep吗\n\n不过我的sleep里单位可是毫秒啊……","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551424985,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":333768,"user_name":"电单车","can_delete":false,"product_type":"c1","uid":2859389,"ip_address":"","ucode":"21FE87326A8B9C","user_header":"https://static001.geekbang.org/account/avatar/00/2b/a1/7d/64ed0fdd.jpg","comment_is_top":false,"comment_ctime":1644504578,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"5939471874","product_id":100023201,"comment_content":"任务队列里的每个宏任务都有一个微任务队列用来保存当前宏任务执行期间产生的微任务，微任务是在当前宏任务的最后执行的，因为微任务也是当前宏任务的一部分，微任务主要就两种，promise的resolve和reject会产生一个微任务，mutationObserver也会生成一个微任务，并且微任务里产生的微任务会被加到当前为任务队列继续执行，所以微任务里循环产生微任务会导致主线程一直耗在当前宏任务的微任务队列，从而卡死页面渲染","like_count":1},{"had_liked":false,"id":273744,"user_name":"Vfeelit","can_delete":false,"product_type":"c1","uid":1501818,"ip_address":"","ucode":"F3FF2B069F347F","user_header":"https://static001.geekbang.org/account/avatar/00/16/ea/7a/d857723d.jpg","comment_is_top":false,"comment_ctime":1610668582,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5905635878","product_id":100023201,"comment_content":"不够通俗易懂 新手蒙圈 async await 到底做了什么魔法 没说明白","like_count":1},{"had_liked":false,"id":236355,"user_name":"William","can_delete":false,"product_type":"c1","uid":1047143,"ip_address":"","ucode":"C7CE9F8C840BD8","user_header":"https://static001.geekbang.org/account/avatar/00/0f/fa/67/1a8d096e.jpg","comment_is_top":false,"comment_ctime":1595397962,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5890365258","product_id":100023201,"comment_content":"function sleep (duration) {<br>    return new Promise((resolve, reject) =&gt; {<br>        setTimeout(resolve, duration)<br>    })<br>}<br>async function green(){<br>    await sleep(3000)<br>    return &#39;green&#39;<br>}<br>async function yellow(){<br>    await sleep(1000)<br>    return &#39;yellow&#39;<br>}<br>async function red(){<br>    await sleep(2000)<br>    return &#39;red&#39;<br>}<br>async function start(){<br>    document.body.style.backgroundColor = await green()<br>    document.body.style.backgroundColor = await yellow()<br>    document.body.style.backgroundColor = await red()<br>    start()<br>}<br>start()","like_count":1},{"had_liked":false,"id":112539,"user_name":"Y","can_delete":false,"product_type":"c1","uid":1555967,"ip_address":"","ucode":"4AA6170E230C0C","user_header":"https://static001.geekbang.org/account/avatar/00/17/bd/ff/f4f2ae6a.jpg","comment_is_top":false,"comment_ctime":1562754519,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5857721815","product_id":100023201,"comment_content":"function light(duration) {<br>    return new Promise((resolve) =&gt; {<br>        setTimeout(resolve,duration)<br>    })<br>}<br><br>async function show() {<br>    console.log(&quot;green&quot;);<br>    await light(3000);<br>    console.log(&quot;yellow&quot;);<br>    await light(1000);<br>    console.log(&quot;red&quot;);<br>    await light(2000);<br>    return true<br>}<br><br>async function cycle() {<br>    while(await show());<br>}<br><br>cycle()","like_count":1},{"had_liked":false,"id":104249,"user_name":"夏味","can_delete":false,"product_type":"c1","uid":1555103,"ip_address":"","ucode":"ADD7D1013D7D31","user_header":"https://static001.geekbang.org/account/avatar/00/17/ba/9f/01696794.jpg","comment_is_top":false,"comment_ctime":1560697581,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"5855664877","product_id":100023201,"comment_content":"function light(status, wait) {<br>    console.log(status);<br>    return new Promise(reslove =&gt; setTimeout(reslove, wait * 1000));<br>}<br><br>async function run () {<br>    while(true) {<br>        await light(&#39;green&#39;, 3)<br>        await light(&#39;yellow&#39;, 1)<br>        await light(&#39;red&#39;, 2);<br>    }<br>}<br><br>run()","like_count":1},{"had_liked":false,"id":94772,"user_name":"CaveShao","can_delete":false,"product_type":"c1","uid":1478271,"ip_address":"","ucode":"E45740787F82AB","user_header":"https://static001.geekbang.org/account/avatar/00/16/8e/7f/4ff4472f.jpg","comment_is_top":false,"comment_ctime":1557892776,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5852860072","product_id":100023201,"comment_content":"let light = document.querySelector(&#39;.light&#39;);<br><br>    function red() {<br>        return new Promise(function(resolve, reject) {<br>            light.style.backgroundColor = &#39;red&#39;;<br>            setTimeout(function() {<br>            \tresolve(green())<br>            }, 2000);<br>        })<br>    }<br><br>    function green() {<br>        return new Promise(function(resolve, reject) {<br>            light.style.backgroundColor = &#39;green&#39;;<br>            setTimeout(function() {<br>            \tresolve(yellow())<br>            }, 3000);<br>        })<br>    }<br><br>    function yellow() {<br>        return new Promise(function(resolve, reject) {<br>            light.style.backgroundColor = &#39;yellow&#39;;<br>            setTimeout(function() {<br>            \tresolve(red())<br>            }, 1000);<br>        })<br>    }<br>    <br>    red();","like_count":1},{"had_liked":false,"id":85086,"user_name":"王玄","can_delete":false,"product_type":"c1","uid":1394410,"ip_address":"","ucode":"E54ABB340D1E49","user_header":"https://static001.geekbang.org/account/avatar/00/15/46/ea/b86667b8.jpg","comment_is_top":false,"comment_ctime":1554975610,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5849942906","product_id":100023201,"comment_content":"        function changeColor() {<br>            console.time();<br>            const timer1 = setTimeout(function () {<br>                clearTimeout(timer1);<br>                console.timeEnd();<br>                console.log(&#39;green&#39;);<br><br>                console.time();<br>                const timer2 = setTimeout(function () {<br>                    clearTimeout(timer2);<br>                    console.timeEnd();<br>                    console.log(&#39;yellow&#39;);<br>                    console.time();<br>                    const timer3 = setTimeout(function () {<br>                        clearTimeout(timer3);<br>                        console.timeEnd();<br>                        console.log(&#39;red&#39;);<br>                        console.time();<br>                        const timer4 = setTimeout(function () {<br>                            clearTimeout(timer4);<br>                            console.timeEnd();<br>                        }, 1000);<br>                    }, 2000);<br>                }, 3000);<br>            }, 0);<br>        }","like_count":1},{"had_liked":false,"id":76614,"user_name":"sheeeeep","can_delete":false,"product_type":"c1","uid":1340246,"ip_address":"","ucode":"218AA77BAA73C8","user_header":"https://static001.geekbang.org/account/avatar/00/14/73/56/9cfb1e43.jpg","comment_is_top":false,"comment_ctime":1552643416,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5847610712","product_id":100023201,"comment_content":"var element = document.getElementsByClassName(&#39;lighter&#39;)[0]<br><br>function sleep(duration) {<br>    return new Promise((resolve, reject) =&gt; {<br>        var begin = Date.now();<br>        setTimeout(() =&gt; resolve(), duration);<br>    })<br>}<br><br>function changeColor(color) {<br>    element.style.backgroundColor = color;<br>}<br><br>async function change() {<br>    changeColor(&#39;green&#39;);<br>    await sleep(3000);<br>    changeColor(&#39;yellow&#39;);<br>    await sleep(1000);<br>    changeColor(&#39;red&#39;)<br>    await sleep(2000);<br>    return new Promise((resolve, reject) =&gt; {<br>        resolve();<br>    })<br>}<br><br>async function main() {<br>    while (true) {<br>        await change();<br>    }<br>}<br><br>main()<br><br><br><br>","like_count":1},{"had_liked":false,"id":70273,"user_name":"clannad-","can_delete":false,"product_type":"c1","uid":1384428,"ip_address":"","ucode":"917AF04B71FF35","user_header":"https://static001.geekbang.org/account/avatar/00/15/1f/ec/dede5cb2.jpg","comment_is_top":false,"comment_ctime":1551062220,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5846029516","product_id":100023201,"comment_content":"  const box = document.querySelector(&#39;.box&#39;);<br>  const oSpan = box.getElementsByTagName(&#39;span&#39;)[0];<br>  const arr = [&#39;green&#39;,&#39;yellow&#39;,&#39;red&#39;];<br>  oSpan.style.backgroundColor = arr[0];<br><br>  function changeColor (num,time){<br>    oSpan.style.backgroundColor = arr[num];<br>    return new Promise((resolve,reject) =&gt; {<br>      setTimeout(resolve,time )<br>    })<br>  }<br>  async function eventFn(){<br>      await changeColor(0,3*1000)<br>      await changeColor(1,1*1000)<br>      await changeColor(2,2*1000)<br>      eventFn()<br>  }<br>  eventFn()","like_count":1},{"had_liked":false,"id":70147,"user_name":"达达","can_delete":false,"product_type":"c1","uid":1103097,"ip_address":"","ucode":"19A236D444817B","user_header":"https://static001.geekbang.org/account/avatar/00/10/d4/f9/48da7701.jpg","comment_is_top":false,"comment_ctime":1551012828,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5845980124","product_id":100023201,"comment_content":"终于知道为什么要有宏任务和微任务得区分了","like_count":1},{"had_liked":false,"id":355569,"user_name":"人","can_delete":false,"product_type":"c1","uid":1471805,"ip_address":"江苏","ucode":"A46558DA3A6CD9","user_header":"https://static001.geekbang.org/account/avatar/00/16/75/3d/15e0cb84.jpg","comment_is_top":false,"comment_ctime":1661501634,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1661501634","product_id":100023201,"comment_content":"事件循环说的有些模糊。  说下我的理解。 宿主环境也就是浏览器在解析到script标签时，发现是一个脚本，就调用javascript引擎，去解析执行脚本。此时就开启了一个宏任务。 执行脚本过程中，碰到了setTimeout, 就会向宏任务队列添加一个任务。 如果碰到promise，就会向微任务队列添加一个任务。<br><br>当前scirpt脚本解析完毕后，会去查看微任务队列，如果有任务，就去执行。 执行完微任务， js引擎把控制权交还给浏览器去渲染，渲染完毕后，查看宏任务队列，依次循环，直至完成所有任务。","like_count":0},{"had_liked":false,"id":355163,"user_name":"Geek_d8c13d","can_delete":false,"product_type":"c1","uid":2788818,"ip_address":"北京","ucode":"92F4D269AFE597","user_header":"","comment_is_top":false,"comment_ctime":1661149114,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1661149114","product_id":100023201,"comment_content":"function sleep(duration) {<br>      return new Promise(function (resolve, reject) {<br>        console.log(&quot;b&quot;);<br>        setTimeout(() =&gt; {<br>          resolve()<br>          console.log(11111);<br>        }, duration);<br>      })<br>    }<br>    console.log(&quot;a&quot;);<br>    sleep(5000)<br>      .then(() =&gt; console.log(&quot;c&quot;))<br>这个为什么会先log1111，再logc呢","like_count":0,"discussions":[{"author":{"id":3166573,"avatar":"https://static001.geekbang.org/account/avatar/00/30/51/6d/e4aed428.jpg","nickname":"%","note":"","ucode":"C5FC6B541307AE","race_medal":1,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":588244,"discussion_content":"resolve就是() =&gt; console.log(&#34;c&#34;)","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1663606264,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"上海"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":3166573,"avatar":"https://static001.geekbang.org/account/avatar/00/30/51/6d/e4aed428.jpg","nickname":"%","note":"","ucode":"C5FC6B541307AE","race_medal":1,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":588243,"discussion_content":"因为setTimeOut整个回调是一个宏任务，resolve是里面的微任务，所以先执行了1111","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1663606238,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"上海"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":347138,"user_name":"Ha0ran","can_delete":false,"product_type":"c1","uid":2813740,"ip_address":"","ucode":"A36AD84DAC48B2","user_header":"https://static001.geekbang.org/account/avatar/00/2a/ef/2c/9f96ded7.jpg","comment_is_top":false,"comment_ctime":1653739300,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1653739300","product_id":100023201,"comment_content":"开头的有点难理解。把宏观任务和 JS 引擎分开了，对我来说，容易理解成 JS 引擎的都是微任务，而宏任务在 JS 引擎之外。希望有人能给点建议帮助我理解一下","like_count":0,"discussions":[{"author":{"id":2790781,"avatar":"https://static001.geekbang.org/account/avatar/00/2a/95/7d/2aaae850.jpg","nickname":"Janus","note":"","ucode":"1D8AEB85D92B86","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":574004,"discussion_content":"建议看隔壁李兵老师的讲解，更好懂。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1653793553,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":346571,"user_name":"Geek_6cd24e","can_delete":false,"product_type":"c1","uid":1747383,"ip_address":"","ucode":"7DD1B435EF2860","user_header":"https://static001.geekbang.org/account/avatar/00/1a/a9/b7/b1ae1deb.jpg","comment_is_top":false,"comment_ctime":1653234156,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1653234156","product_id":100023201,"comment_content":"    const el = document.querySelector(&quot;.trafficLight&quot;);<br><br>    function light(color, duration) {<br>      return new Promise(function (resolve, reject) {<br>        el.style.backgroundColor = color;<br>        setTimeout(() =&gt; {<br>          resolve();<br>        }, duration);<br>      });<br>    }<br><br>    async function compeleteLight() {<br>      await light(&quot;green&quot;, 3000);<br>      await light(&quot;yellow&quot;, 1000);<br>      await light(&quot;red&quot;, 2000);<br><br>      compeleteLight();<br>    }<br><br>    compeleteLight();","like_count":0},{"had_liked":false,"id":343802,"user_name":"docker","can_delete":false,"product_type":"c1","uid":2762850,"ip_address":"","ucode":"9B9E246E092B1C","user_header":"https://static001.geekbang.org/account/avatar/00/2a/28/62/f1ba1593.jpg","comment_is_top":false,"comment_ctime":1651061411,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1651061411","product_id":100023201,"comment_content":"let a;<br>function sleep(duration) {<br>  return new Promise(function(resolve, reject) {<br>    a = 2;<br>    setTimeout(() =&gt; {<br>      console.log(&quot;UUU&quot;);<br>    }, duration);<br>    return resolve;<br>  })<br>}<br>async function foo(){<br>  console.log(&quot;a&quot;)<br>  sleep(4000).then(r =&gt; console.log(&quot;b&quot;))<br>  console.log(&quot;c&quot;)<br>}<br>foo().then(r =&gt; console.log(a));<br>console.log(&quot;e&quot;);<br><br>为什么b没有打印出来呢","like_count":0},{"had_liked":false,"id":343551,"user_name":"Chousen","can_delete":false,"product_type":"c1","uid":1647604,"ip_address":"","ucode":"F6E7B26F9A0544","user_header":"https://static001.geekbang.org/account/avatar/00/19/23/f4/95ae3dda.jpg","comment_is_top":false,"comment_ctime":1650901925,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1650901925","product_id":100023201,"comment_content":"mutation observer 到底是个宿主API还是浏览器引擎api","like_count":0},{"had_liked":false,"id":343207,"user_name":"*飞","can_delete":false,"product_type":"c1","uid":1177558,"ip_address":"","ucode":"C60C936C350A8D","user_header":"https://static001.geekbang.org/account/avatar/00/11/f7/d6/07bb5633.jpg","comment_is_top":false,"comment_ctime":1650707624,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1650707624","product_id":100023201,"comment_content":"<br>class Lignt {<br>    constructor(color, duration) {<br>      this.color = color;<br>      this.duration = duration;<br>    }<br>    lightOn() {<br>      document<br>      .getElementById(&quot;xxxx&quot;)<br>      .setAttribute(&quot;style&quot;, `background: ${this.color};height:100px;width:100px;`);<br>    }<br>  }<br>  <br>  class RedLignt extends Lignt {<br>    constructor(machine, duration) {<br>      super(&quot;red&quot;, duration);<br>      this.machine = machine;<br>    }<br>    async lightOn() {<br>      super.lightOn()<br>      await lightOnTime(this.duration);<br>      this.machine.setMachineState(this.machine.GreenState);<br>    }<br>  }<br>  <br>  class GreenLignt extends Lignt {<br>    constructor(machine, duration) {<br>      super(&quot;green&quot;, duration);<br>      this.machine = machine;<br>    }<br>    async lightOn() {<br>      super.lightOn()<br>      await lightOnTime(this.duration);<br>      this.machine.setMachineState(this.machine.YellowState);<br>    }<br>  }<br>  <br>  class YellowLignt extends Lignt {<br>    constructor(machine, duration) {<br>      super(&quot;yellow&quot;, duration);<br>      this.machine = machine;<br>    }<br>    async lightOn() {<br>      super.lightOn()<br>      await lightOnTime(this.duration);<br>      this.machine.setMachineState(this.machine.RedState);<br>    }<br>  }<br>  <br>  class Machine {<br>    constructor() {<br>      this.GreenState = new GreenLignt(this, 3000);<br>      this.YellowState = new YellowLignt(this, 1000);<br>      this.RedState = new RedLignt(this, 2000);<br>      this.state = this.GreenState;<br>    }<br>    setMachineState(state) {<br>      this.state = state;<br>      this.start();<br>    }<br>    start() {<br>      this.state.lightOn();<br>    }<br>  }<br>  new Machine().start();<br>  <br>  function lightOnTime(duration) {<br>    return new Promise((reslove, reject) =&gt; {<br>      setTimeout(reslove, duration);<br>    });<br>  }","like_count":0},{"had_liked":false,"id":342178,"user_name":"阿超.","can_delete":false,"product_type":"c1","uid":1576230,"ip_address":"","ucode":"2B96DE690C98DB","user_header":"https://static001.geekbang.org/account/avatar/00/18/0d/26/73411dd3.jpg","comment_is_top":false,"comment_ctime":1650085360,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1650085360","product_id":100023201,"comment_content":"<br>&#47;&#47;最小颗粒化,单一职责;<br><br>&#47;&#47; 切换颜色<br>function changeColor(color) {<br>  console.log(&quot;切换颜色为:&quot;, color);<br>}<br><br>&#47;&#47; 控制器<br>function conFun(time) {<br>  switch (time) {<br>    case 0:<br>      changeColor(&#39;绿&#39;);<br>      break;<br>    case 3:<br>      changeColor(&#39;黄&#39;);<br>      break;<br>    case 5:<br>      changeColor(&#39;红&#39;);<br>      break;<br>  }<br>}<br><br>&#47;&#47; 主程序<br>function main() {<br>  let time = 0;<br>  conFun(time % 6);<br>  setInterval(() =&gt; {<br>    conFun(time++ % 6);<br>  }, 1000);<br>}<br><br>main();<br>","like_count":0},{"had_liked":false,"id":342177,"user_name":"阿超.","can_delete":false,"product_type":"c1","uid":1576230,"ip_address":"","ucode":"2B96DE690C98DB","user_header":"https://static001.geekbang.org/account/avatar/00/18/0d/26/73411dd3.jpg","comment_is_top":false,"comment_ctime":1650084796,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1650084796","product_id":100023201,"comment_content":"function changeColor(color) {<br>  console.log(&quot;切换颜色为:&quot;, color);<br>}<br><br>function conFun(time) {<br>  switch (time) {<br>    case 0:<br>      changeColor(&#39;绿&#39;)<br>      break<br>    case 3:<br>      changeColor(&#39;黄&#39;)<br>      break<br>    case 5:<br>      changeColor(&#39;红&#39;)<br>      break<br>  }<br>}<br><br>function start() {<br>  let time = 0;<br>  conFun(time % 6)<br>  setInterval(() =&gt; {<br>    time++<br>    conFun(time % 6)<br>  }, 1000);<br>}<br><br>start();<br>","like_count":0},{"had_liked":false,"id":339912,"user_name":"锐锐爱南球","can_delete":false,"product_type":"c1","uid":1158621,"ip_address":"","ucode":"7AA4CA355B9D69","user_header":"https://static001.geekbang.org/account/avatar/00/11/ad/dd/970e7b4a.jpg","comment_is_top":false,"comment_ctime":1648460443,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1648460443","product_id":100023201,"comment_content":"看完这篇之后真的醍醐灌顶，以前搞不太明白的宏观，微观任务都搞懂了。","like_count":0},{"had_liked":false,"id":337055,"user_name":"周胜","can_delete":false,"product_type":"c1","uid":1974266,"ip_address":"","ucode":"BAE27CC6F67BB9","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erw3icVIkgTwYx5H9gwOSHdVibjxvzrmSe8G3Cg7kOicjibkHaDeibkntE4kdhibj4KHM0zCzM07YlbbteA/132","comment_is_top":false,"comment_ctime":1646573531,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1646573531","product_id":100023201,"comment_content":"我们把宿主发起的任务称为宏观任务，把JavaScript引擎发起的任务称为微观任务。在宏观任务中，JavaScript 的 Promise 还会产生异步代码，JavaScript 必须保证这些异步代码在一个宏观任务中完成，因此，每个宏观任务中又包含了一个微观任务队列。<br><br>最后实现红绿灯<br><br>function light(ele, color, duration) {<br>  return new Promise(resolve, reject) {<br>    ele.style.backgroundColor = color;<br>    setTimeout(resolve, duration);<br>  }<br>}<br><br>setInterval(() =&gt; {<br>  await light(ele, &#39;green&#39;, 3000);<br>  await light(ele, &#39;yellow&#39;, 1000);<br>  await light(ele, &#39;red&#39;, 2000);<br>}, 6000)","like_count":0},{"had_liked":false,"id":335194,"user_name":"阿星","can_delete":false,"product_type":"c1","uid":1136547,"ip_address":"","ucode":"C5B7FA33365A28","user_header":"https://static001.geekbang.org/account/avatar/00/11/57/a3/09efc7cb.jpg","comment_is_top":false,"comment_ctime":1645401582,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1645401582","product_id":100023201,"comment_content":"我一直认为 async&#47;await 的背后就是用 generator+iterator 来实现的, 对吧?","like_count":0},{"had_liked":false,"id":333903,"user_name":"小小一只帆","can_delete":false,"product_type":"c1","uid":2152578,"ip_address":"","ucode":"38402FEC9EE899","user_header":"https://static001.geekbang.org/account/avatar/00/20/d8/82/f05df6b6.jpg","comment_is_top":false,"comment_ctime":1644574781,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1644574781","product_id":100023201,"comment_content":"    function sleep(duration){<br>        return new Promise(function(resolve){<br>            setTimeout(resolve, duration);<br>        })<br>    }<br><br>    async function changeColor(color, time) {<br>      document.querySelector(&#39;.light&#39;).style.background = color<br>      await sleep(time)<br>    } <br><br>    async function main(startTime, cb) {<br>      await changeColor(&#39;green&#39;, startTime)<br>      await changeColor(&#39;yellow&#39;, 3000)<br>      await changeColor(&#39;red&#39;, 1000)<br>      return main(2000)<br>    }<br><br>    main(0)","like_count":0},{"had_liked":false,"id":331351,"user_name":"pasico","can_delete":false,"product_type":"c1","uid":2595067,"ip_address":"","ucode":"FAC45A23621F2D","user_header":"https://static001.geekbang.org/account/avatar/00/27/98/fb/aa63be6f.jpg","comment_is_top":false,"comment_ctime":1642559380,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1642559380","product_id":100023201,"comment_content":"const config = [{<br>    color: &#39;green&#39;,<br>    duration: 3<br>},{<br>    color: &#39;yellow&#39;,<br>    duration: 1<br>},{<br>    color: &#39;red&#39;,<br>    duration: 2<br>}]<br>let index = -1<br>let duration = 0<br><br>setInterval(()=&gt;{<br>    if(duration === 0){<br>        index = (index+1)%config.length<br>        let c = config[index]<br>        console.log(c.color)<br>        duration = c.duration-1<br>    }else{<br>        duration--<br>        console.log(&#39;-&#39;)<br>    }<br>}, 1000)","like_count":0},{"had_liked":false,"id":330284,"user_name":"路名","can_delete":false,"product_type":"c1","uid":2832929,"ip_address":"","ucode":"3ABC31EFF5EC4D","user_header":"","comment_is_top":false,"comment_ctime":1641893432,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1641893432","product_id":100023201,"comment_content":"<br>    function sleep(duration) {<br>        return new Promise(function(resolve, reject) {<br>            console.log(&quot;b&quot;);<br>            resolve(duration);<br>            &#47;&#47; setTimeout(resolve,duration);<br>        })<br>    }<br>    console.log(&quot;a&quot;);<br>    sleep(0).then(()=&gt;console.log(&quot;c&quot;));<br>    console.log(&quot;d&quot;)<br>Promise函数里面没有宏观任务了.为什么c还是会比d慢?","like_count":0},{"had_liked":false,"id":330275,"user_name":"Geek_3cedc4","can_delete":false,"product_type":"c1","uid":2882197,"ip_address":"","ucode":"DAFC72DD926AD5","user_header":"","comment_is_top":false,"comment_ctime":1641889950,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1641889950","product_id":100023201,"comment_content":"&quot;在宏观任务中，JavaScript 的 Promise 还会产生异步代码，JavaScript 必须保证这些异步代码在一个宏观任务中完成，因此，每个宏观任务中又包含了一个微观任务队列&quot;<br>这个可以解释下为啥JavaScript 必须保证这些异步代码在一个宏观任务中完成吗？","like_count":0},{"had_liked":false,"id":328561,"user_name":"泷沁心","can_delete":false,"product_type":"c1","uid":1293186,"ip_address":"","ucode":"E811D9F1A17689","user_header":"https://static001.geekbang.org/account/avatar/00/13/bb/82/5a32de87.jpg","comment_is_top":false,"comment_ctime":1640772603,"is_pvip":false,"discussion_count":0,"race_medal":1,"score":"1640772603","product_id":100023201,"comment_content":"我来搞个花里胡哨的，控制台直接可以看效果，哈哈哈哈哈哈：<br><br>function sleep(duration = 0) {<br>  return new Promise(function (resolve, reject) {<br>    setTimeout(resolve, duration)<br>  })<br>}<br>const fontStyle = &#39;font-size: 24px;font-weight: bold;&#39;<br>const color = {<br>  green: { name: &#39;绿绿绿&#39;, time: 3000, style: `${fontStyle}color: green` },<br>  yellow: { name: &#39;黄黄黄&#39;, time: 1000, style: `${fontStyle}color: yellow` },<br>  red: { name: &#39;红红红&#39;, time: 2000, style: `${fontStyle}color: red` },<br>}<br>const logger = target =&gt; console.log(`%c${target.name}`, target.style)<br><br>const handleStart = async () =&gt; {<br>  while (true) {<br>    await sleep(color.green.time)<br>    logger(color.green)<br>    await sleep(color.yellow.time)<br>    logger(color.yellow)<br>    await sleep(color.red.time)<br>    logger(color.red)<br>  }<br>}<br><br>console.log(&#39;%cStart&#39;, fontStyle)<br>handleStart()","like_count":0},{"had_liked":false,"id":317686,"user_name":"邬昌明","can_delete":false,"product_type":"c1","uid":2393393,"ip_address":"","ucode":"30838A94D4D244","user_header":"","comment_is_top":false,"comment_ctime":1634889976,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1634889976","product_id":100023201,"comment_content":"function sleep(duration) { return new Promise(function(resolve, reject) { setTimeout(resolve,duration); }) }<br>let arr = [{color:&#39;green&#39;,time:3000},{color:&#39;yellow&#39;,time:1000},{color:&#39;red&#39;,time:2000}]<br>let div = document.getElementById(&#39;light&#39;)<br>let i = 0;<br>async function main() {<br>    await changeColor(div,arr[i])<br>    if(++i &gt;= arr.length) i = 0;<br>    main()<br>}<br>main()<br><br>async function changeColor(node,item) {<br>    node.style.backgroundColor = item.color;<br>    await sleep(item.time)<br>}","like_count":0},{"had_liked":false,"id":315331,"user_name":"forguo","can_delete":false,"product_type":"c1","uid":1386513,"ip_address":"","ucode":"AF7C6D8B352C81","user_header":"https://static001.geekbang.org/account/avatar/00/15/28/11/aa878061.jpg","comment_is_top":false,"comment_ctime":1633838980,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1633838980","product_id":100023201,"comment_content":"mounted() {<br>        &#47;&#47; 绿色 3 秒，黄色 1 秒，红色 2 秒循环改变背景色<br>        this.trafficSwitch();<br>    },<br>    methods: {<br>        async switchColor (color, delay) {<br>            this.color = color<br>            await this.switchCount(delay);<br>        },<br>        switchCount (delay) {<br>            return new Promise((resolve) =&gt; {<br>                setTimeout(() =&gt; {<br>                    resolve();<br>                }, delay);<br>            })<br>        },<br>        async switchGreen () {<br>            await this.switchColor(&#39;green&#39;, 3000);<br>            await this.switchYellow();<br>        },<br>        async switchYellow () {<br>            await this.switchColor(&#39;yellow&#39;, 1000);<br>            await this.switchRed();<br>        },<br>        async switchRed () {<br>            await this.switchColor(&#39;red&#39;, 2000);<br>            await this.switchGreen();<br>        },<br>        async trafficSwitch () {<br>            &#47;&#47; 绿色 3 秒，黄色 1 秒，红色 2 秒循环改变背景色<br>            await this.switchGreen();<br>        }<br>    }","like_count":0},{"had_liked":false,"id":298999,"user_name":"zgy","can_delete":false,"product_type":"c1","uid":1387798,"ip_address":"","ucode":"05EA6845199250","user_header":"https://static001.geekbang.org/account/avatar/00/15/2d/16/b525a71d.jpg","comment_is_top":false,"comment_ctime":1624420849,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1624420849","product_id":100023201,"comment_content":"  function fn (n, color) {<br>    return new Promise(receive =&gt; {<br>      document.querySelector(&#39;.box&#39;).style.background = color<br>      setTimeout(() =&gt; {<br>        receive()<br>      }, n)<br>    })<br>  }<br>  async function aFn () {<br>    await fn (3000, &#39;green&#39;)<br>    await fn (1000, &#39;yellow&#39;)<br>    await fn (2000, &#39;red&#39;)<br>    aFn ()<br>  }<br>  aFn ()","like_count":0},{"had_liked":false,"id":289385,"user_name":"Geek","can_delete":false,"product_type":"c1","uid":2575914,"ip_address":"","ucode":"CD2C5AB66EA7C4","user_header":"https://static001.geekbang.org/account/avatar/00/27/4e/2a/41db4a2c.jpg","comment_is_top":false,"comment_ctime":1618993674,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1618993674","product_id":100023201,"comment_content":"    async change(){<br>        const d = document.querySelector(&quot;.light&quot;);<br>        while(true) {<br>            d.style.background = &#39;green&#39;;<br>            await this.turnColor(3000);<br>            d.style.background = &#39;yellow&#39;;<br>            await this.turnColor(1000);<br>            d.style.background = &#39;red&#39;;<br>            await this.turnColor(2000);<br><br>        }<br>    }<br><br>    turnColor(duration){<br>        return new Promise(function(resolve, reject){<br>            setTimeout(resolve, duration);<br>        })<br>    }","like_count":0},{"had_liked":false,"id":289342,"user_name":"ZWS","can_delete":false,"product_type":"c1","uid":1033683,"ip_address":"","ucode":"89C9D92070F716","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c5/d3/d4b3e22c.jpg","comment_is_top":false,"comment_ctime":1618984874,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1618984874","product_id":100023201,"comment_content":"function sleep(duration, callback){<br>  const now = Date.now();<br>  while (Date.now() - now &lt; duration);<br>  return new Promise((resolve) =&gt; {<br>    callback();<br>    resolve();<br>  })<br>}<br><br>function turnColor(color){<br>  return function(){<br>    console.log(color);<br>  }<br>}<br><br>function traffic(){<br>  sleep(3000, turnColor(&#39;green&#39;));<br>  sleep(1000, turnColor(&#39;yellow&#39;));<br>  sleep(2000, turnColor(&#39;red&#39;));<br>  traffic();<br>}<br><br>traffic();","like_count":0},{"had_liked":false,"id":288718,"user_name":"别看了你帅不过我","can_delete":false,"product_type":"c1","uid":2561212,"ip_address":"","ucode":"93E628027649FA","user_header":"https://static001.geekbang.org/account/avatar/00/27/14/bc/26fa6643.jpg","comment_is_top":false,"comment_ctime":1618640155,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1618640155","product_id":100023201,"comment_content":"async function foo2(){<br>    await foo(&quot;a&quot;);<br>    await foo(&quot;b&quot;);<br>}<br>执行foo2()，为什么只打印了一个promise？不是两次await foo吗？","like_count":0},{"had_liked":false,"id":282871,"user_name":"王霸天","can_delete":false,"product_type":"c1","uid":1917769,"ip_address":"","ucode":"5DF357985CA483","user_header":"","comment_is_top":false,"comment_ctime":1615449016,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1615449016","product_id":100023201,"comment_content":"const sleep = (duration) =&gt; {<br>        return new Promise((resolve, reject) =&gt; {<br>            setTimeout(resolve, duration);<br>        });<br>    }<br>    const change = async() =&gt; {<br>        console.log(&#39;绿&#39;);<br>        await sleep(3000);<br>        console.log(&#39;黄&#39;);<br>        await sleep(1000);<br>        console.log(&#39;红&#39;);<br>        await sleep(2000);<br>        this.change();<br>    }<br>change();","like_count":0},{"had_liked":false,"id":282132,"user_name":"Alan He","can_delete":false,"product_type":"c1","uid":2033513,"ip_address":"","ucode":"A0780F4619D388","user_header":"https://static001.geekbang.org/account/avatar/00/1f/07/69/43cf2251.jpg","comment_is_top":false,"comment_ctime":1615102875,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1615102875","product_id":100023201,"comment_content":" var lightEl = document.getElementsByClassName(&#39;light&#39;)[0];<br><br>      function sleep(second) {<br>        return new Promise(function (resolve, reject) {<br>          window.setTimeout(function () {<br>            resolve();<br>          }, second * 1000);<br>        });<br>      }<br><br>      async function trafficLight() {<br>        lightEl.style.backgroundColor = &#39;green&#39;;<br>        await sleep(3);<br>        lightEl.style.backgroundColor = &#39;yellow&#39;;<br>        await sleep(1);<br>        lightEl.style.backgroundColor = &#39;red&#39;;<br>        await sleep(2);<br>      }<br><br>      async function main() {<br>        while (true) {<br>          await trafficLight();<br>        }<br>      }<br>      main();","like_count":0},{"had_liked":false,"id":275483,"user_name":"zgy","can_delete":false,"product_type":"c1","uid":1387798,"ip_address":"","ucode":"05EA6845199250","user_header":"https://static001.geekbang.org/account/avatar/00/15/2d/16/b525a71d.jpg","comment_is_top":false,"comment_ctime":1611560181,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1611560181","product_id":100023201,"comment_content":"    async function fn () {<br>      try {<br>        await f(3000, &#39;green&#39;)<br>        await f (1000, &#39;yellow&#39;)<br>        await f(2000, &#39;red&#39;)<br>        fn ()<br>      } catch {<br>        throw (new Error(&#39;错误&#39;))<br>      }<br>    }<br>    function f (time, color) {<br>      return new Promise((resolve) =&gt; {<br>        document.querySelector(&#39;.box&#39;).style.background = color<br>        setTimeout(resolve, time)<br>      })<br>    }<br>    fn ()","like_count":0},{"had_liked":false,"id":273020,"user_name":"不带布兜","can_delete":false,"product_type":"c1","uid":1400998,"ip_address":"","ucode":"3BC07B89A3B058","user_header":"https://static001.geekbang.org/account/avatar/00/15/60/a6/341c3e31.jpg","comment_is_top":false,"comment_ctime":1610414961,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1610414961","product_id":100023201,"comment_content":"var toGreen=async function(){<br>      document.querySelector(&#39;.light&#39;).style.background=&#39;green&#39;<br>      await setTimeout(toYellow,3000)<br>    } <br>    var toYellow=async function(){<br>      document.querySelector(&#39;.light&#39;).style.background=&#39;yellow&#39;<br>      await setTimeout(toRed,1000)<br>    }<br>    var toRed=async function(){<br>      document.querySelector(&#39;.light&#39;).style.background=&#39;red&#39;<br>      await setTimeout(toGreen,2000)<br>    }<br>    function openLight(){<br>      toGreen()<br>    }<br><br>    openLight()","like_count":0},{"had_liked":false,"id":269302,"user_name":"Steve","can_delete":false,"product_type":"c1","uid":2145313,"ip_address":"","ucode":"C921D4E486ACF5","user_header":"","comment_is_top":false,"comment_ctime":1608606709,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1608606709","product_id":100023201,"comment_content":"function green() {<br>\tdocument.getElementById(&quot;circle&quot;).style.backgroundColor = &#39;green&#39;;<br>}<br><br>function yellow() {<br>\tdocument.getElementById(&quot;circle&quot;).style.backgroundColor = &#39;yellow&#39;;<br>}<br><br>function red() {<br>\tdocument.getElementById(&quot;circle&quot;).style.backgroundColor = &#39;red&#39;;<br>}<br><br>function sleep(duration) {<br>\treturn new Promise((resolve) =&gt; {<br>  \tsetTimeout(resolve, duration);<br>  })<br>}<br><br>async function start() {<br>  green();<br>\tawait sleep(3000);<br>  yellow();<br>  await sleep(1000);<br>  red();<br>  await sleep(2000);<br>\tawait start();<br>}<br><br>start().then(() =&gt; {})","like_count":0},{"had_liked":false,"id":264255,"user_name":"君自兰芳","can_delete":false,"product_type":"c1","uid":2029706,"ip_address":"","ucode":"780F3AFEEB9B73","user_header":"https://static001.geekbang.org/account/avatar/00/1e/f8/8a/f7e7fd54.jpg","comment_is_top":false,"comment_ctime":1606391843,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1606391843","product_id":100023201,"comment_content":"&quot;Promise 永远在队列尾部添加微观任务&quot;<br>有个疑问，这里的队列尾部是指什么队列？是添加到微任务队列的尾部，还是整个宏任务队列的尾部？","like_count":0,"discussions":[{"author":{"id":2033513,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/07/69/43cf2251.jpg","nickname":"Alan He","note":"","ucode":"A0780F4619D388","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":353244,"discussion_content":"应该是微任务队列的尾部","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1615091927,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":263926,"user_name":"Winter","can_delete":false,"product_type":"c1","uid":1492258,"ip_address":"","ucode":"A6F398C4303713","user_header":"https://static001.geekbang.org/account/avatar/00/16/c5/22/aca9a785.jpg","comment_is_top":false,"comment_ctime":1606295935,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1606295935","product_id":100023201,"comment_content":"如果无限循环的话对于内存耗尽的问题要怎么解决呢","like_count":0},{"had_liked":false,"id":262598,"user_name":"Geek_2b435a","can_delete":false,"product_type":"c1","uid":2328769,"ip_address":"","ucode":"70A1A0D25EF386","user_header":"","comment_is_top":false,"comment_ctime":1605776147,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1605776147","product_id":100023201,"comment_content":"各位大佬可以看看这段失败的代码<br>(()=&gt; {<br>    let dom = document.getElementById(&#39;a&#39;);<br>    let backgroundColor = dom.style.backgroundColor;<br>    function changeColor(color) {<br>        let begin = Date.now();<br>        let afterColor = &#39;&#39;;<br>        switch(color) {<br>            case &#39;red&#39;:<br>                afterColor = &#39;green&#39;;<br>                while(Date.now() - begin &lt; 1000 * 2);<br>                dom.style.backgroundColor = afterColor;<br>                changeColor(afterColor);<br>                break;<br>            case &#39;green&#39;: <br>                afterColor = &#39;yellow&#39;;<br>                while(Date.now() - begin &lt; 1000 * 3);<br>                dom.style.backgroundColor = afterColor;<br>                changeColor(afterColor);<br>                break;<br>            case &#39;yellow&#39;:<br>                afterColor = &#39;red&#39;;<br>                while(Date.now() - begin &lt; 1000 * 1);<br>                dom.style.backgroundColor = afterColor;<br>                changeColor(afterColor);<br>                break;<br>            default: break;<br>        }<br>    }<br>    changeColor(backgroundColor);<br>})();<br>理解下渲染机制","like_count":0},{"had_liked":false,"id":262142,"user_name":"甘康艺","can_delete":false,"product_type":"c1","uid":1953633,"ip_address":"","ucode":"D06219B5C592CF","user_header":"https://static001.geekbang.org/account/avatar/00/1d/cf/61/f592700e.jpg","comment_is_top":false,"comment_ctime":1605622034,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1605622034","product_id":100023201,"comment_content":" function sleep(duration) {<br>            return new Promise(function (resolve) {<br>                setTimeout(resolve, duration);<br>            });<br><br>        }<br>        async function changeColor(color, duration) {<br><br>            await sleep(duration).then(() =&gt; document.getElementById(&quot;light&quot;).style.background = color);<br>            <br>        }<br><br>        async function cycleLightColor() {<br><br>            while (true) {<br>                await changeColor(&quot;#ffff00&quot;, 1000);<br>                await changeColor(&quot;#ff0000&quot;, 2000);<br>                await changeColor(&quot;#00ff00&quot;, 3000);<br>            }<br>        }<br>       cycleLightColor();","like_count":0},{"had_liked":false,"id":260978,"user_name":"风槐","can_delete":false,"product_type":"c1","uid":2068807,"ip_address":"","ucode":"85738351C986BE","user_header":"https://static001.geekbang.org/account/avatar/00/1f/91/47/996be32b.jpg","comment_is_top":false,"comment_ctime":1605165875,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1605165875","product_id":100023201,"comment_content":"function sleep(duration){<br>    return new Promise(function(resolve){<br>        setTimeout(resolve, duration);<br>    })<br>}<br>async function changeColor(duration,color){<br>    document.getElementById(&quot;traffic-light&quot;).style.background = color;<br>    await sleep(duration);<br><br>}<br>async function main(){<br>    while(true){<br>        await changeColor(3000,&quot;green&quot;);<br>        await changeColor(1000, &quot;yellow&quot;);<br>        await changeColor(2000, &quot;red&quot;);<br>    }<br>}<br>main()","like_count":0},{"had_liked":false,"id":257805,"user_name":"Neisun","can_delete":false,"product_type":"c1","uid":1925475,"ip_address":"","ucode":"FC6F52FA0729B0","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIhXibVTuCiaFaE03OHEj9jb4VxC41rDFnQRRjr4yheCdOppUDIciaGzZKmaciczVia4yKSUWxpM9dFf3w/132","comment_is_top":false,"comment_ctime":1604136451,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1604136451","product_id":100023201,"comment_content":"        function sleep(duration) {<br>            return new Promise((resolve,reject) =&gt; {<br>                setTimeout(resolve,duration)<br>            })<br>        }<br>        async function light() {<br>            console.log(&quot;绿灯亮&quot;)<br>            await sleep(3000)<br>            console.log(&quot;黄灯亮&quot;)<br>            await sleep(1000)<br>            console.log(&quot;红灯亮&quot;)<br>            await sleep(2000)<br>            light()<br>        }","like_count":0},{"had_liked":false,"id":255802,"user_name":"半橙汁","can_delete":false,"product_type":"c1","uid":1477902,"ip_address":"","ucode":"BB93BB9CCB7FA2","user_header":"https://static001.geekbang.org/account/avatar/00/16/8d/0e/5e97bbef.jpg","comment_is_top":false,"comment_ctime":1603434092,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1603434092","product_id":100023201,"comment_content":"宏观任务，微观任务，又有一堆名词术语列表要补习了~（PS：好担心俺的头发）","like_count":0},{"had_liked":false,"id":255445,"user_name":"直面挑战","can_delete":false,"product_type":"c1","uid":2226314,"ip_address":"","ucode":"7C6541B9EE1B04","user_header":"https://static001.geekbang.org/account/avatar/00/21/f8/8a/18b7f008.jpg","comment_is_top":false,"comment_ctime":1603346452,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1603346452","product_id":100023201,"comment_content":"问下老师，这一课理解起来有点吃力，是不是需要先找一本js的书籍学习一下？有推荐的书籍吗（看完以后能大概看懂本课程js部分代码）","like_count":0},{"had_liked":false,"id":255065,"user_name":"正经工程师","can_delete":false,"product_type":"c1","uid":1350996,"ip_address":"","ucode":"680B53F09A9CF5","user_header":"https://static001.geekbang.org/account/avatar/00/14/9d/54/d43922b6.jpg","comment_is_top":false,"comment_ctime":1603261774,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1603261774","product_id":100023201,"comment_content":"async function show(execute,time){<br>    execute();<br>    return new Promise((resolve,reject)=&gt;{<br>        setTimeout(resolve,time)<br>    })<br>}<br><br>async function main(){<br>    while(true){<br>        await show(()=&gt;{console.log(&#39;green&#39;)},3000)<br>        await show(()=&gt;{console.log(&#39;yellow&#39;)},1000)<br>        await show(()=&gt;{console.log(&#39;red&#39;)},2000)<br>    }<br>}<br>main()","like_count":0},{"had_liked":false,"id":254036,"user_name":"Geek_luo","can_delete":false,"product_type":"c1","uid":2190670,"ip_address":"","ucode":"0A7207157BD00F","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIbSS9mUibLF6aicw1SNL1AEBt3U8jcKUIfealiaRc9oBtRRkIS8wAPPeducahUzWVo1AeFOYAJklFibw/132","comment_is_top":false,"comment_ctime":1603025270,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1603025270","product_id":100023201,"comment_content":"class TrafficLight {<br>            constructor(dom) {<br>                this.light = dom<br>            }<br>            wait(time) {<br>                return new Promise(resolve =&gt; {<br>                    setTimeout(() =&gt; {<br>                        resolve()<br>                    }, time)<br>                })<br>            }<br>            async changeColor(color, time) {<br>                this.light.style.backgroundColor = color<br>                await this.wait(time)<br>            }<br>            async roll() {<br>                while(true) {<br>                    await this.changeColor(&#39;green&#39;, 3000)<br>                    await this.changeColor(&#39;yellow&#39;, 1000)<br>                    await this.changeColor(&#39;red&#39;, 2000)<br>                }<br>            }<br>        }<br>        new TrafficLight(document.querySelector(&#39;.light&#39;)).roll()","like_count":0},{"had_liked":false,"id":252907,"user_name":"ywding","can_delete":false,"product_type":"c1","uid":2188098,"ip_address":"","ucode":"17FA8552026B54","user_header":"https://static001.geekbang.org/account/avatar/00/21/63/42/31e0cb29.jpg","comment_is_top":false,"comment_ctime":1602512769,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1602512769","product_id":100023201,"comment_content":"来个不一样的吧，倒计时也顺便展示了；<br>let config = [{color: &quot;green&quot;, time: 6},<br>            {color: &quot;yellow&quot;, time: 3},<br>            {color: &quot;red&quot;, time: 9}];<br><br>        (function show({color, time }) {<br>            box.style.backgroundColor = color;<br>            box.innerHTML = time;<br>            let showInterval = setInterval(() =&gt; {<br>                box.innerHTML = --time<br>            }, 1000);<br>            setTimeout(() =&gt; {<br>                clearInterval(showInterval);<br>                config.push(config.shift());<br>                show(config[0])<br>            }, time * 1000);<br>        })(config[0])","like_count":0},{"had_liked":false,"id":252752,"user_name":"Geek_512c73","can_delete":false,"product_type":"c1","uid":2223895,"ip_address":"","ucode":"4A4CF0D2CE6B69","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Y3I7p9ry5Vo3CpSL5tETO7fyiaCC72CowPTWxeGrgzuvNhTN4yBJR05BGqUmyoYhzCYBPT9HFVz6pxPY3jAUMLw/132","comment_is_top":false,"comment_ctime":1602474527,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1602474527","product_id":100023201,"comment_content":"let timeout = function (delay){<br>        return new Promise(resolve =&gt; setTimeout(resolve,delay))<br>    }<br><br>    let change_bgColor = async function (el, color, duration){<br>        el.style.backgroundColor = color<br>        if(duration){<br>            await timeout(duration)<br>        }<br>    }<br><br>    let el = document.createElement(&quot;div&quot;)<br>    el.style.width = &quot;100px&quot;<br>    el.style.height = &quot;100px&quot;<br>    el.style.borderRadius = &quot;100px&quot;<br>    document.body.appendChild(el)<br><br>    let start = async function(){<br>        while (1){<br>            await change_bgColor(el, &quot;green&quot;, 3000)<br>            await change_bgColor(el, &quot;yellow&quot;, 1000)<br>            await change_bgColor(el, &quot;red&quot;, 2000)<br>        }<br>    }<br><br>    start()","like_count":0},{"had_liked":false,"id":252560,"user_name":"洪明伟","can_delete":false,"product_type":"c1","uid":1925056,"ip_address":"","ucode":"CAD0D845C93CA3","user_header":"","comment_is_top":false,"comment_ctime":1602382364,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1602382364","product_id":100023201,"comment_content":"function sleep(c,duration) {<br>    return new Promise(function (resolve, reject) {<br>         console.log(&#39;color is &#39;+c+&#39; time is &#39;+duration)<br>        setTimeout(resolve,duration);<br>    })<br>}<br>async function foo() {<br>            while (true) {<br>                await sleep(&#39;green&#39;, 3000)<br>                await sleep(&#39;yellow&#39;, 1000)<br>                await sleep(&#39;red&#39;, 2000)<br>            }<br>        }<br>        foo()","like_count":0},{"had_liked":false,"id":251456,"user_name":"土豆鸡块_o0","can_delete":false,"product_type":"c1","uid":1131629,"ip_address":"","ucode":"1003C0074B722E","user_header":"https://static001.geekbang.org/account/avatar/00/11/44/6d/10a6cc99.jpg","comment_is_top":false,"comment_ctime":1601575842,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1601575842","product_id":100023201,"comment_content":"我想问个问题，任务该怎么定义？<br> 下边的代码里 r=。。。这是定义，r.then是一个宏观任务，下边的clog c，应该是应该是一个宏观任务吗？ <br>   var r = new Promise(function(resolve, reject){<br>        console.log(&quot;a&quot;);<br>        resolve()<br>    });<br>    r.then(() =&gt; console.log(&quot;c&quot;));<br>    console.log(&quot;b&quot;)","like_count":0},{"had_liked":false,"id":251049,"user_name":"文艺不起来的我","can_delete":false,"product_type":"c1","uid":1015847,"ip_address":"","ucode":"11AE5CB9D0A700","user_header":"https://static001.geekbang.org/account/avatar/00/0f/80/27/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1601345057,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1601345057","product_id":100023201,"comment_content":"&lt;!DOCTYPE html&gt;<br>&lt;html lang=&quot;en&quot;&gt;<br>&lt;head&gt;<br>    &lt;meta charset=&quot;UTF-8&quot;&gt;<br>    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;<br>    &lt;title&gt;Document&lt;&#47;title&gt;<br>&lt;&#47;head&gt;<br>&lt;style&gt;<br>    #demo {<br>        width: 50px;<br>        height: 50px;<br>        border-radius: 25px;<br>    }<br>&lt;&#47;style&gt;<br>&lt;body&gt;<br>    &lt;div id=&quot;demo&quot;&gt;&lt;&#47;div&gt;<br>&lt;&#47;body&gt;<br>&lt;script&gt;<br><br>    let div = document.getElementById(&#39;demo&#39;)<br><br>    function sleep(wait) {<br>        return new Promise(function(resolve, reject) {<br>            setTimeout(resolve, wait)<br>        })<br>    }<br>    async function change() {<br>        while(1) {<br>            await sleep(3000)<br>            div.style.background = &#39;green&#39;<br>            await sleep(2000)<br>            div.style.background = &#39;red&#39;<br>            await sleep(1000)<br>            div.style.background = &#39;yellow&#39;<br>        }<br>        <br>    }<br><br>    change()<br><br>&lt;&#47;script&gt;<br>&lt;&#47;html&gt;","like_count":0},{"had_liked":false,"id":249872,"user_name":"filter","can_delete":false,"product_type":"c1","uid":1064585,"ip_address":"","ucode":"4559F7E9638E06","user_header":"https://static001.geekbang.org/account/avatar/00/10/3e/89/ce5c0938.jpg","comment_is_top":false,"comment_ctime":1600839199,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1600839199","product_id":100023201,"comment_content":"const colors = [&#39;yellow&#39;, &#39;red&#39;, &#39;green&#39;];<br>const circle = document.getElementById(&#39;circle&#39;)<br><br>const changeColor = (color) =&gt; {<br>  circle.style.backgroundColor = color<br>}<br><br><br>const delay = time =&gt; {<br>  return new Promise((resolve) =&gt; <br>    setTimeout(resolve, time)<br>  )<br>}<br><br>let index = 0;<br>const change = async () =&gt; {<br>  changeColor(colors[index])<br>  const r = await delay((index + 1) * 1000)<br>  index = (index === 2 ? 0 : index + 1);<br>  change()<br>}<br>change()<br>","like_count":0},{"had_liked":false,"id":247879,"user_name":"zly","can_delete":false,"product_type":"c1","uid":2175260,"ip_address":"","ucode":"BBBCA6CD16FFBF","user_header":"https://static001.geekbang.org/account/avatar/00/21/31/1c/51f4d08e.jpg","comment_is_top":false,"comment_ctime":1599900878,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1599900878","product_id":100023201,"comment_content":" function sleep(duration) {<br>     return new Promise((reslove) =&gt; {<br>         setTimeout(() =&gt; {<br>             reslove()<br>         }, duration)<br>     })<br> }<br><br> async function setLight(color, time) {<br>     console.log(`turnLight:${color}`)<br>     await sleep(time)<br> }<br><br> class Light{<br>    constructor(colorTimeList,initColor){<br>        this.colorTimeList=colorTimeList<br>        this.color=initColor<br>    }<br>    async LightInit(){<br>        let onColor=this.colorTimeList.find((item)=&gt;{<br>            return item.color==this.color<br>        })<br>        await setLight(this.color,onColor.time)<br>        this.color=onColor.next<br>        this.LightInit()<br>    }<br> }<br><br> let light=new Light([{color:&#39;green&#39;,time:3000,next:&#39;yellow&#39;},{color:&#39;yellow&#39;,time:1000,next:&#39;red&#39;},{color:&#39;red&#39;,time:2000,next:&#39;green&#39;}],&#39;green&#39;)<br> light.LightInit()","like_count":0},{"had_liked":false,"id":243022,"user_name":"Ys","can_delete":false,"product_type":"c1","uid":1587362,"ip_address":"","ucode":"087EA88667A90B","user_header":"https://static001.geekbang.org/account/avatar/00/18/38/a2/efe4d995.jpg","comment_is_top":false,"comment_ctime":1597921570,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1597921570","product_id":100023201,"comment_content":"JavaScript引擎通常处于空闲状态，当macrotask queue不为空时，从队头开始执行macrotask。当一个macrotask执行结束，会执行microtask queue中所有任务。如果宿主环境是浏览器，此时在开始执行以下一个macrotask之前，会重新渲染页面。","like_count":0},{"had_liked":false,"id":242506,"user_name":"美美","can_delete":false,"product_type":"c1","uid":1148422,"ip_address":"","ucode":"44CC95C45AF345","user_header":"https://static001.geekbang.org/account/avatar/00/11/86/06/72b01bb7.jpg","comment_is_top":false,"comment_ctime":1597744142,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1597744142","product_id":100023201,"comment_content":"置顶真的要挑错还是能有两处（见注释）。不过已经极其完美了。<br><br>async function sleep(duration){<br>        return new Promise((resolve)=&gt;{<br>            setTimeout(resolve, duration);<br>        })<br>    }<br>    &#47;&#47; 防止多次获取dom<br>    const trafficLight = document.querySelector(&#39;#traffic-light&#39;);<br>    function setColor(color){<br>        trafficLight.style.backgroundColor = color;<br>    }<br>    async function initTrafficLight(){<br>        &#47;&#47; sleep和设置颜色解耦<br>        while(true){<br>            setColor(&#39;green&#39;)<br>            await sleep(3000)<br>            setColor(&#39;yellow&#39;)<br>            await sleep(1000)<br>            setColor(&#39;red&#39;)<br>            await sleep(2000)<br>        }<br>    }<br>    initTrafficLight()","like_count":0},{"had_liked":false,"id":239731,"user_name":"不曾相识","can_delete":false,"product_type":"c1","uid":1607957,"ip_address":"","ucode":"0BEDA6BDCA5F56","user_header":"https://static001.geekbang.org/account/avatar/00/18/89/15/381ce65f.jpg","comment_is_top":false,"comment_ctime":1596626954,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1596626954","product_id":100023201,"comment_content":"&lt;body&gt;<br>    &lt;div class=&quot;l&quot;&gt;&lt;&#47;div&gt;<br>&lt;&#47;body&gt;<br>&lt;script&gt;<br>    &#47;&#47; 颜色变化规则<br>    var colorC = {<br><br>        redC() {<br>            return {<br>                color: &#39;red&#39;,<br>                during: 1,<br>            }<br>        },<br>        greenC() {<br>            return {<br>                color: &#39;green&#39;,<br>                during: 2,<br>            }<br>        },<br>        yellowC() {<br>            return {<br>                color: &#39;yellow&#39;,<br>                during: 3,<br>            }<br>        },<br>    }<br><br>    var l = document.querySelector(&#39;.l&#39;);<br>    console.dir(l,&#39;---l&#39;);<br>    <br>    var light = {<br>        color: &#39;red&#39;,<br>        changeColor({during, color},l) {<br>            return new Promise((resolve, reject) =&gt; {<br>                setTimeout(() =&gt; {<br>                    console.log(color,&#39;---color&#39;);<br>                    l.style.backgroundColor = color;<br>                    resolve()<br>                }, during * 1000);<br>            })<br>        },<br>    }<br>    <br>    var lightChange =async ()=&gt;{<br>        l.style.backgroundColor = light.color;<br>        await light.changeColor(colorC.greenC(),l);<br>        await light.changeColor(colorC.yellowC(),l);<br>        await light.changeColor(colorC.redC(),l)<br>    }<br>    lightChange();<br>    setInterval(() =&gt; {<br>        lightChange();<br>    }, (colorC.greenC().during+colorC.redC().during+colorC.yellowC().during)*1000);<br>默默学习...第一次发，见笑了，win大","like_count":0},{"had_liked":false,"id":233797,"user_name":"Geek_b68746","can_delete":false,"product_type":"c1","uid":1812972,"ip_address":"","ucode":"A1A7B41F8ED26A","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/tUyk7nlYNPFEPlI5KgtWazegUkicNIMkFMSl3OCb5Kic6KE1yQibJpojhc7JEIXC8WXlzYoRcIXhYxnUJKCsDLaQw/132","comment_is_top":false,"comment_ctime":1594455784,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1594455784","product_id":100023201,"comment_content":"&#47;&#47;模拟div元素color属性<br>const div = {<br>    color: &quot;&quot;<br>};<br>&#47;&#47;自定义样式<br>const colors = [<br>    {<br>        color: &quot;green&quot;,<br>        time: 3000<br>    },<br>    {<br>        color: &quot;yellow&quot;,<br>        time: 1000<br>    },<br>    {<br>        color: &quot;red&quot;,<br>        time: 2000<br>    }<br>];<br><br>&#47;&#47;js逻辑部分<br>function changeColor(colors) {<br>    &#47;&#47;封装红绿灯任务列表<br>    const tasks = [];<br>    colors.map(color =&gt; {<br>        tasks.push(() =&gt; {<br>            return new Promise((resolve, reject) =&gt; {<br>                div.color = color.color;<br>                console.log(`div 开启 ${div.color} 灯 ${Number(color.time &#47; 1000)} 秒`);<br>                setTimeout(() =&gt; {<br>                    flag = false;<br>                    resolve();<br>                }, color.time);<br>            })<br>        })<br>    });<br><br>    &#47;&#47;开启循环任务<br>    let index = 0;<br>    logic(tasks, index);<br><br>}<br><br>function logic(tasks, index) {<br>    const p1 = new Promise((resolve, reject) =&gt; {<br>        tasks[index]().then(() =&gt; {<br>            index++;<br>            if (index === colors.length) {<br>                index = 0;<br>            }<br>            resolve(index);<br>        });<br>    });<br>    p1.then(index =&gt; {<br>        logic(tasks, index);<br>    })<br>}<br><br>changeColor(colors);<br>&#47;&#47;输出：<br>div 开启 green 灯 3 秒<br>div 开启 yellow 灯 1 秒<br>div 开启 red 灯 2 秒<br>div 开启 green 灯 3 秒<br>div 开启 yellow 灯 1 秒<br>div 开启 red 灯 2 秒<br>","like_count":0},{"had_liked":false,"id":233010,"user_name":"Cander","can_delete":false,"product_type":"c1","uid":1381524,"ip_address":"","ucode":"838B8F877C7080","user_header":"https://static001.geekbang.org/account/avatar/00/15/14/94/7fcd4c89.jpg","comment_is_top":false,"comment_ctime":1594191720,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1594191720","product_id":100023201,"comment_content":"function show(color, duration) {<br>  return new Promise(r =&gt; {<br>    console.log(color);<br>    setTimeout(r, duration);<br>  })<br>}<br><br>async function loop() {<br>  await show(&#39;green&#39;, 3000)<br>  await show(&#39;yellow&#39;, 1000)<br>  await show(&#39;red&#39;, 2000)<br>  loop();<br>}<br><br>loop();<br>","like_count":0},{"had_liked":false,"id":232712,"user_name":"Kevin","can_delete":false,"product_type":"c1","uid":1923859,"ip_address":"","ucode":"89EA5FCF036C42","user_header":"https://static001.geekbang.org/account/avatar/00/1d/5b/13/6db9ba58.jpg","comment_is_top":false,"comment_ctime":1594096265,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1594096265","product_id":100023201,"comment_content":"&lt;body&gt;<br>  &lt;div id=&quot;box&quot; style=&quot;position:fixed;top:0;left:45%;width:150px;height:150px; border-radius:50%;&quot;&gt;&lt;&#47;div&gt;<br>&lt;&#47;body&gt;<br>&lt;&#47;html&gt;<br>&lt;script&gt;<br>  <br><br>  function changeColor(color, second){<br>    return new Promise((reslove, reject) =&gt; {<br>      let _box = document.getElementById(&#39;box&#39;);<br>      _box.style.backgroundColor = color;<br>      setTimeout(reslove, second)<br>    })<br>  }<br><br>  async function changeColorLoop(){<br>    await changeColor(&#39;green&#39;, 3000);<br>    await changeColor(&#39;yellow&#39;, 1000);<br>    await changeColor(&#39;red&#39;, 2000);<br>    await changeColorLoop();<br>  }<br>    onload = async () =&gt;{<br>      await changeColorLoop()<br>    }<br><br>&lt;&#47;script&gt;","like_count":0},{"had_liked":false,"id":232708,"user_name":"我五岁了呀","can_delete":false,"product_type":"c1","uid":1234802,"ip_address":"","ucode":"8B45200F1C65E0","user_header":"https://static001.geekbang.org/account/avatar/00/12/d7/72/deec1d6b.jpg","comment_is_top":false,"comment_ctime":1594093809,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1594093809","product_id":100023201,"comment_content":"const action = (time, color) =&gt; {<br>  return new Promise((res) =&gt; {<br>    changeColor(color)<br>    setTimeout(res, time * 1000)<br>  })<br>}<br><br>const changeColor = (color) =&gt; {<br>  document.getElementById(&#39;box&#39;).style.background = color<br>}<br><br>const main = async () =&gt; {<br>  while(true) {<br>    await action(3, &#39;green&#39;)<br>    await action(1, &#39;yellow&#39;)<br>    await action(2, &#39;red&#39;)<br>  }<br>}<br><br>main()","like_count":0},{"had_liked":false,"id":227113,"user_name":"LittleWorker","can_delete":false,"product_type":"c1","uid":1796818,"ip_address":"","ucode":"FD8C99BA4E7FBE","user_header":"https://static001.geekbang.org/account/avatar/00/1b/6a/d2/87bca0e6.jpg","comment_is_top":false,"comment_ctime":1592290142,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1592290142","product_id":100023201,"comment_content":"let colorList = [<br>  { color: &#39;green&#39;, duration: 3000 },<br>  { color: &#39;yellow&#39;, duration: 1000 },<br>  { color: &#39;red&#39;, duration: 2000 }<br>]<br>function showLight(color, duration) {<br>  return new Promise(resolve =&gt; {<br>    console.log(new Date().toLocaleTimeString(), &#39; current color =&gt;&#39;, color)<br>    setTimeout(() =&gt; {<br>      resolve()<br>    }, duration)<br>  })<br>}<br><br>async function doLight() {<br>  let index = 0<br>  while (true) {<br>    const { color, duration } = colorList[index % 3]<br>    await showLight(color, duration)<br>    index++<br>  }<br>}<br>doLight()","like_count":0},{"had_liked":false,"id":222541,"user_name":"都市夜归人","can_delete":false,"product_type":"c1","uid":1071909,"ip_address":"","ucode":"DFF59BE3D80B42","user_header":"https://static001.geekbang.org/account/avatar/00/10/5b/25/d78cc1fe.jpg","comment_is_top":false,"comment_ctime":1590830732,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1590830732","product_id":100023201,"comment_content":"在宏观任务中，JavaScript 的 Promise 还会产生异步代码。Promise 永远在队列尾部添加微观任务。setTimeout 等宿主 API，则会添加宏观任务。这两句感觉有点矛盾。可能是我理解的不到位。","like_count":0},{"had_liked":false,"id":222486,"user_name":"SuperFour","can_delete":false,"product_type":"c1","uid":1378323,"ip_address":"","ucode":"BBFEA454D107F1","user_header":"https://static001.geekbang.org/account/avatar/00/15/08/13/af055726.jpg","comment_is_top":false,"comment_ctime":1590819156,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1590819156","product_id":100023201,"comment_content":"const lightQuery = [{<br>    color:&#39;red&#39;,<br>    duration:2000,<br>},{<br>    color:&#39;yellow&#39;,<br>    duration:1000,<br>},{<br>    color:&#39;green&#39;,<br>    duration:3000,<br>}];<br>async function sleepTime(duration){<br>    return new Promise((resolve,reject) =&gt; {<br>        setTimeout(resolve,duration)<br>    })<br>    <br>}<br><br>async function main(){<br>    let $light = document.getElementById(&#39;light&#39;),value = null;<br>    let deltaTime = 20;<br>    let startTime = endTime = new Date().getTime()<br>    while(endTime - startTime &lt;= deltaTime * 1000){<br>        for(let i = 0; i &lt; lightQuery.length; i ++){<br>            value = lightQuery[i]<br>            console.log(value.color);<br>            $light.setAttribute(&#39;class&#39;,`light ${value.color}`)<br>            await sleepTime(value.duration)<br>        }<br>        endTime = new Date().getTime()<br>        console.log(&#39;endTime - startTime:&#39;,endTime - startTime);<br>    }<br>}<br><br>main()","like_count":0},{"had_liked":false,"id":221389,"user_name":"zgy","can_delete":false,"product_type":"c1","uid":1387798,"ip_address":"","ucode":"05EA6845199250","user_header":"https://static001.geekbang.org/account/avatar/00/15/2d/16/b525a71d.jpg","comment_is_top":false,"comment_ctime":1590488628,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1590488628","product_id":100023201,"comment_content":"setInterval(fn, 3000)<br>function delay(ms) { return new Promise(reslove) { setTimeout (reslove, ms)}};<br>async function fn() {<br>   this.color = &#39;red&#39;;<br>   await delay(1000);<br>   this.color = &#39;yellow&#39;;<br>   await delay(2000);<br>}<br>function main() {<br>while (true) {<br>  color = &#39;green&#39;;<br>  await delay(3000);<br>  color = &#39;yellow&#39;;<br>  await delay(1000);<br>  color = &#39;red&#39;;<br>  await delay(2000);<br>}<br>}","like_count":0},{"had_liked":false,"id":219158,"user_name":"李岩","can_delete":false,"product_type":"c1","uid":1793763,"ip_address":"","ucode":"A7E1259C5B81AB","user_header":"https://static001.geekbang.org/account/avatar/00/1b/5e/e3/da3167ff.jpg","comment_is_top":false,"comment_ctime":1589957226,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1589957226","product_id":100023201,"comment_content":"为什么async&#47;await 里 加上while(true) 就一直循环执行呢<br>","like_count":0,"discussions":[{"author":{"id":1469314,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/uFebicU5uiaOkAbJPdT8bwXc6YSvCz4KANoibpe8udF7tPGuhapxeMib21A9gG6npBEUvwbIBeH7dZwJmibVibvJVWzA/132","nickname":"fairy631","note":"","ucode":"96CF3E6137E971","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":289974,"discussion_content":"因为 true 永远为真,所以会一直循环","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594287633,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":217541,"user_name":"洛奇","can_delete":false,"product_type":"c1","uid":1624355,"ip_address":"","ucode":"662B4005721119","user_header":"https://static001.geekbang.org/account/avatar/00/18/c9/23/76511858.jpg","comment_is_top":false,"comment_ctime":1589530482,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1589530482","product_id":100023201,"comment_content":"let b = calc(20);<br>let c = calc(30);<br>let result=a+await b +await c;<br>和<br>let b = await calc(20);<br>let c = await calc(30);<br>let result = a + b + c;<br>如果calc函数内是sleep 2秒，为什么 前者是总共sleep 2秒 ，而后者是4秒？","like_count":0},{"had_liked":false,"id":216637,"user_name":"地球外地人","can_delete":false,"product_type":"c1","uid":1966404,"ip_address":"","ucode":"28457E37C632ED","user_header":"https://static001.geekbang.org/account/avatar/00/1e/01/44/3a9b2b69.jpg","comment_is_top":false,"comment_ctime":1589299589,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1589299589","product_id":100023201,"comment_content":"老师能讲讲在 async await 中的闭包问题吗？","like_count":0},{"had_liked":false,"id":215505,"user_name":"daisy小仙女","can_delete":false,"product_type":"c1","uid":1504233,"ip_address":"","ucode":"07BC6A944505A1","user_header":"https://static001.geekbang.org/account/avatar/00/16/f3/e9/3296bf51.jpg","comment_is_top":false,"comment_ctime":1589005365,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1589005365","product_id":100023201,"comment_content":"function sleep(duration) {<br>    return new Promise(function(resolve, reject) {<br>        setTimeout(resolve,duration);<br>    })<br>}<br>async function showColor(color, time){<br>    await sleep(time)<br>    console.log(color)<br>}<br>async function foo2(){<br>    await showColor(&quot;green&quot;, 3000);<br>    await showColor(&quot;yellow&quot;, 2000);<br>    await showColor(&quot;red&quot;, 1000);<br>}","like_count":0},{"had_liked":false,"id":215205,"user_name":"EmilyLucky","can_delete":false,"product_type":"c1","uid":1972343,"ip_address":"","ucode":"DBA5FE296CF473","user_header":"https://static001.geekbang.org/account/avatar/00/1e/18/77/d665f258.jpg","comment_is_top":false,"comment_ctime":1588929070,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1588929070","product_id":100023201,"comment_content":"const trafficLight = document.getElementById(&quot;trafficLight&quot;);<br>function changeColor(elem,color,delay){<br>   return new Promise((resolve,reject) =&gt; {<br>       elem.style.backgroundColor = color;<br>       setTimeout(resolve,delay);<br>   });<br>}<br>async function startTwinkle(){<br>    while(true){<br>        await changeColor(trafficLight,&quot;green&quot;,3000);<br>        await changeColor(trafficLight,&quot;yellow&quot;,1000);<br>        await changeColor(trafficLight,&quot;red&quot;,2000);<br>    }<br>}<br>startTwinkle();","like_count":0},{"had_liked":false,"id":209450,"user_name":"任祖雷","can_delete":false,"product_type":"c1","uid":1928073,"ip_address":"","ucode":"B741330D3EEF46","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJTPJHXTB9bmiaQEs56CmKYB5pn1uhk1wJibiatIdH2gia12XnxLjdtGoFWEWPgrC2DTUADgF9ic6TszEQ/132","comment_is_top":false,"comment_ctime":1587550966,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1587550966","product_id":100023201,"comment_content":"MutationObserver属于微任务吗？是JavaScript引擎发起的吗？","like_count":0},{"had_liked":false,"id":208487,"user_name":"扩散性百万咸面包","can_delete":false,"product_type":"c1","uid":1905171,"ip_address":"","ucode":"6D703D51553B42","user_header":"https://static001.geekbang.org/account/avatar/00/1d/12/13/e103a6e3.jpg","comment_is_top":false,"comment_ctime":1587368711,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1587368711","product_id":100023201,"comment_content":"<br>    setTimeout(()=&gt;console.log(&quot;d&quot;), 0)<br>    var r = new Promise(function(resolve, reject){<br>        resolve()<br>    });<br>    r.then(() =&gt; { <br>        var begin = Date.now();<br>        while(Date.now() - begin &lt; 1000);<br>        console.log(&quot;c1&quot;) <br>        new Promise(function(resolve, reject){<br>            resolve()<br>        }).then(() =&gt; console.log(&quot;c2&quot;))<br>    });<br><br>对于这一段代码也可以用同样的理论解释，首先.then添加到微队列后开始执行，这个过程中继续添加任务到微队列。要在跳回去执行宏任务队列前把所有微任务执行完，只好继续打印c2。<br><br>Source: https:&#47;&#47;jakearchibald.com&#47;2015&#47;tasks-microtasks-queues-and-schedules&#47;","like_count":0},{"had_liked":false,"id":208486,"user_name":"扩散性百万咸面包","can_delete":false,"product_type":"c1","uid":1905171,"ip_address":"","ucode":"6D703D51553B42","user_header":"https://static001.geekbang.org/account/avatar/00/1d/12/13/e103a6e3.jpg","comment_is_top":false,"comment_ctime":1587368478,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1587368478","product_id":100023201,"comment_content":"    function sleep(duration) {<br>        return new Promise(function(resolve, reject) {<br>            console.log(&quot;b&quot;);<br>            setTimeout(resolve,duration);<br>        })<br>    }<br>    console.log(&quot;a&quot;);<br>    sleep(5000).then(()=&gt;console.log(&quot;c&quot;));<br>正确说法应该是每一个宏任务执行完了后都会去执行所有在队列中的微任务。<br>结合看了其他帖子后，我对于这段代码的真正解释是：首先打印a, b没有问题，其次setTimeout把一个任务添加到宏任务队列，继续执行.then，把回调添加到微任务队列。script宏任务现在执行完毕，要去检查微任务队列，但是发现还没有resolve，不应该执行打印c，于是再跳回宏任务队列（这时候有个疑问，应该是阻塞在队列中等待任务完成？还是反复横跳？按照我的假设的话，必须要至少完成一个宏任务才能跳微任务，所以应该是阻塞了）。等到setTimeout执行完后，去执行微任务log c才成功。","like_count":0},{"had_liked":false,"id":206479,"user_name":"后脑勺","can_delete":false,"product_type":"c1","uid":1946181,"ip_address":"","ucode":"50704EC5545C4C","user_header":"https://static001.geekbang.org/account/avatar/00/1d/b2/45/b49a92f5.jpg","comment_is_top":false,"comment_ctime":1586867077,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1586867077","product_id":100023201,"comment_content":"const trafficLight = document.querySelector(&#39;.traffic-lights&#39;)<br><br>start()<br><br>async function start() {<br>  while (true) {<br>    await generateLight(trafficLight, &#39;green&#39;, 3000)<br>    await generateLight(trafficLight, &#39;yellow&#39;, 1000)<br>    await generateLight(trafficLight, &#39;red&#39;, 2000)<br>  }<br>}<br><br>function generateLight(el, color, duration) {<br>  return new Promise(resolve =&gt; {<br>    el.style.backgroundColor = color<br>    setTimeout(resolve, duration)<br>  })<br>}<br>","like_count":0},{"had_liked":false,"id":204696,"user_name":"曙光","can_delete":false,"product_type":"c1","uid":1476450,"ip_address":"","ucode":"04D65BF7F19845","user_header":"https://static001.geekbang.org/account/avatar/00/16/87/62/f99b5b05.jpg","comment_is_top":false,"comment_ctime":1586443134,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1586443134","product_id":100023201,"comment_content":"async 函数必定返回 Promise，我们把所有返回 Promise 的函数都可以认为是异步函数。<br>async function sleep1(duration) {<br>    setTimeout(function(){console.log(&quot;123&quot;);},duration);<br>}<br>async function foo2(){<br>    await foo(&quot;a&quot;);<br>    await foo(&quot;b&quot;);<br>    await sleep1(1000);<br>}<br>那么 await sleep1(1000);是返回Promise还是返回普通函数？","like_count":0},{"had_liked":false,"id":202072,"user_name":"sry","can_delete":false,"product_type":"c1","uid":1379091,"ip_address":"","ucode":"C2942BA09082EC","user_header":"https://static001.geekbang.org/account/avatar/00/15/0b/13/3d14f827.jpg","comment_is_top":false,"comment_ctime":1585898570,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1585898570","product_id":100023201,"comment_content":"const $trafficLight = document.getElementById(&#39;traffic-light&#39;);<br>function changeBg(color, duration) {<br>    $trafficLight.style.background = color;<br>    return new Promise((resolve, reject) =&gt; {<br>        setTimeout(() =&gt; {<br>            resolve()<br>        }, duration);<br>    });<br>}<br>async function start() {<br>    while(true) {<br>        await changeBg(&#39;green&#39;, 3000);<br>        await changeBg(&#39;yellow&#39;, 1000);<br>        await changeBg(&#39;red&#39;, 2000);<br>    }<br>}","like_count":0},{"had_liked":false,"id":199633,"user_name":"郑祺贤","can_delete":false,"product_type":"c1","uid":1375644,"ip_address":"","ucode":"7238FA6C9132A2","user_header":"https://static001.geekbang.org/account/avatar/00/14/fd/9c/7b2b494c.jpg","comment_is_top":false,"comment_ctime":1585492902,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1585492902","product_id":100023201,"comment_content":"原先对于js的这些基础不怎么深入的理解，现在来补课","like_count":0},{"had_liked":false,"id":195381,"user_name":"果然爸爸","can_delete":false,"product_type":"c1","uid":1467300,"ip_address":"","ucode":"0E5F031A0E6A69","user_header":"https://static001.geekbang.org/account/avatar/00/16/63/a4/e663c4d4.jpg","comment_is_top":false,"comment_ctime":1585184465,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1585184465","product_id":100023201,"comment_content":"javascript语言sdk 文档","like_count":0},{"had_liked":false,"id":191478,"user_name":"g1f9","can_delete":false,"product_type":"c1","uid":1912902,"ip_address":"","ucode":"94B9852BF1277D","user_header":"","comment_is_top":false,"comment_ctime":1584777066,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1584777066","product_id":100023201,"comment_content":"function delay(t){<br>  return new Promise((rs,rj)=&gt;{<br>    setTimeout(rs,t)<br>  })<br>}<br>function green(){<br>  console.log(&#39;green&#39;)<br>  return delay(3000)<br>}<br>function yellow(){<br>  console.log(&#39;yellow&#39;)<br>  return delay(1000)<br>}<br>function red(){<br>  console.log(&#39;red&#39;)<br>  return delay(2000)<br>}<br><br>function light(){<br>  green().then(yellow).then(red).then(light)<br>}","like_count":0,"discussions":[{"author":{"id":1910075,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/25/3b/a971fc8e.jpg","nickname":"阿感","note":"","ucode":"7BCB7E44A832D1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":253349,"discussion_content":"传统promise  .then   .then ……","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588228697,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":187954,"user_name":"hhk","can_delete":false,"product_type":"c1","uid":1138826,"ip_address":"","ucode":"72EC677FBDC79B","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/gvfibNc3Bol6DzLMG5ia9wSLVYseoq326iae7TczmgmBj9u3Jwt8c0hl9KSzY4GNTFn0ic9m1ibzicqJ3aGzeQemec2Q/132","comment_is_top":false,"comment_ctime":1584282699,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1584282699","product_id":100023201,"comment_content":"&gt; 但是 generator 并非被设计成实现异步，所以有了 async&#47;await 之后，generator&#47;iterator 来模拟异步的方法应该被废弃  <br>为什么这样说, 那redux-saga怎么讲","like_count":0},{"had_liked":false,"id":186031,"user_name":"负重前行","can_delete":false,"product_type":"c1","uid":1626236,"ip_address":"","ucode":"5C34FFA20F476D","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJTH83G2zVZb77xAECyrEia7agaibOT1UlqSjRiciae5OE8nicW9pTPPlfq6h6mBM7UhPk640c3ibMSOWmA/132","comment_is_top":false,"comment_ctime":1583744569,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1583744569","product_id":100023201,"comment_content":"&#47;&#47; vue中的实现<br>    function sleep(duration) {<br>      return new Promise(resolve =&gt; {<br>        setTimeout(resolve, duration);<br>      });<br>    }<br><br>    const fn = async () =&gt; {<br>      &#47;&#47; eslint-disable-next-line no-constant-condition<br>      while (true) {<br>        this.bgc = &#39;green&#39;<br>        await sleep(3000);<br>        this.bgc = &quot;yellow&quot;;<br>        await sleep(1000);<br>        this.bgc = &quot;red&quot;;<br>        await sleep(2000);<br>      }<br>    }<br>    fn()","like_count":0},{"had_liked":false,"id":184850,"user_name":"Bryant-cx","can_delete":false,"product_type":"c1","uid":1242146,"ip_address":"","ucode":"ED9A93A527F695","user_header":"https://static001.geekbang.org/account/avatar/00/12/f4/22/257e9e21.jpg","comment_is_top":false,"comment_ctime":1583418119,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1583418119","product_id":100023201,"comment_content":"document.addEventListener(&#39;DOMContentLoaded&#39;, function () {<br>  const div = document.querySelectorAll(&#39;div&#39;)[0]<br><br>  function repeat () {<br>    sleep(3000)<br>      .then(() =&gt; {<br>        div.style = &#39;background: #eab30c;&#39;<br>        return sleep(1000)<br>      })<br>      .then(() =&gt; {<br>        div.style = &#39;background: #f00;&#39;<br>        return sleep(2000)<br>      })<br>      .then(() =&gt; {<br>        div.style = &#39;background: #0f0;&#39;<br>        repeat()<br>      })<br>  }<br><br>  repeat()<br>})<br><br>function sleep (duration) {<br>  return new Promise((resolve, reject) =&gt; {<br>    setTimeout(resolve, duration)<br>  })<br>}","like_count":0},{"had_liked":false,"id":184393,"user_name":"👉 L.e👈","can_delete":false,"product_type":"c1","uid":1422959,"ip_address":"","ucode":"DC033198E84C95","user_header":"https://static001.geekbang.org/account/avatar/00/15/b6/6f/a952dac5.jpg","comment_is_top":false,"comment_ctime":1583305911,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1583305911","product_id":100023201,"comment_content":"function wait (duration, color) {<br>            return new Promise ((resolve, reject) =&gt; {<br>                setTimeout(() =&gt; {<br>                    resolve()<br>                }, duration)<br>                let circle = document.getElementById(&#39;circle&#39;)<br>                circle.style.background = color<br>            })<br>        }<br>        async function changeColor () {<br>            await wait(3000, &#39;green&#39;)<br>            await wait(1000, &#39;yellow&#39;)<br>            await wait(2000, &#39;red&#39;)<br>        }<br>        changeColor()","like_count":0},{"had_liked":false,"id":167382,"user_name":"Kravis","can_delete":false,"product_type":"c1","uid":1691885,"ip_address":"","ucode":"B52815536CEF2D","user_header":"https://static001.geekbang.org/account/avatar/00/19/d0/ed/bf0990ec.jpg","comment_is_top":false,"comment_ctime":1577781402,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1577781402","product_id":100023201,"comment_content":"const lightElement = document.querySelector(&#39;.traffic-light&#39;);<br><br>const setTrafficLight = (color, duration) =&gt; {<br>  lightElement.className = `traffic-light ${color}`;<br><br>  return new Promise((resolve) =&gt; {<br>    setTimeout(resolve, duration);<br>  });<br>};<br><br>const loop = async () =&gt; {<br>  while (true) {<br>    await setTrafficLight(&#39;green&#39;, 3000);<br>    await setTrafficLight(&#39;yellow&#39;, 1000);<br>    await setTrafficLight(&#39;red&#39;, 2000);<br>  }<br>};<br><br>loop();","like_count":0},{"had_liked":false,"id":161166,"user_name":"宋玉","can_delete":false,"product_type":"c1","uid":1465180,"ip_address":"","ucode":"75CC99DA84B0CF","user_header":"https://static001.geekbang.org/account/avatar/00/16/5b/5c/34905e98.jpg","comment_is_top":false,"comment_ctime":1576135479,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1576135479","product_id":100023201,"comment_content":"function changeColor(color,duration){<br>    return new Promise(function(resolve,reject){<br>        document.getElementById(&#39;trafficLight&#39;).style.background=color<br>        setTimeout(resolve,duration)<br>    })<br>}<br>async function test(){<br>    while(true){<br>        await changeColor(&#39;green&#39;,3000);<br>        await changeColor(&#39;yellow&#39;,1000);<br>        await changeColor(&#39;red&#39;,2000);<br>    }<br>}<br>test()","like_count":0},{"had_liked":false,"id":159052,"user_name":"gresen","can_delete":false,"product_type":"c1","uid":1381834,"ip_address":"","ucode":"F050CE6ED526EE","user_header":"https://wx.qlogo.cn/mmopen/vi_32/DYAIOgq83epLdWbztjssWulaNnFTaC4lJd12vZZgsz5cROnFrERY8YlBA4dW3QGHd6wU8HgC6IPwnIFcTo1lgA/132","comment_is_top":false,"comment_ctime":1575526198,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1575526198","product_id":100023201,"comment_content":"var lamp = document.getElementById(&quot;lamp&quot;);<br>\tfunction Fn(className, time) {<br>\t\tlamp.className = className<br>\t\treturn new Promise((resolve, reject) =&gt; {<br>\t\t\tsetTimeout(resolve, time)<br>\t\t})<br>\t};<br><br>\tasync function asyncFn() {<br>\t\twhile(true) {<br>\t\t\tawait Fn(&#39;green&#39;, 3000)<br>\t\t\tawait Fn(&#39;red&#39;, 1000)<br>\t\t\tawait Fn(&#39;yellow&#39;, 2000)<br>\t\t}<br>\t}<br>\tasyncFn();","like_count":0},{"had_liked":false,"id":158776,"user_name":"王天狗","can_delete":false,"product_type":"c1","uid":1376470,"ip_address":"","ucode":"C0832F5785F44D","user_header":"https://static001.geekbang.org/account/avatar/00/15/00/d6/3eff7492.jpg","comment_is_top":false,"comment_ctime":1575449355,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1575449355","product_id":100023201,"comment_content":"  function colors(color) {<br>    light.style.background = color;<br>    console.log(color);<br>  }<br>  <br>  function fn() {<br>    light.style.background = &#39;green&#39;;<br>    setTimeout(&quot;colors(&#39;red&#39;)&quot;,3000);<br>    setTimeout(&quot;colors(&#39;yellow&#39;)&quot;, 5000);<br>  }<br>  function xh() {<br>    setInterval(&quot;fn()&quot;, 6000);<br>  }<br>  xh();","like_count":0},{"had_liked":false,"id":155736,"user_name":"haha","can_delete":false,"product_type":"c1","uid":1392569,"ip_address":"","ucode":"F91C0B43A9F180","user_header":"https://static001.geekbang.org/account/avatar/00/15/3f/b9/eaba519e.jpg","comment_is_top":false,"comment_ctime":1574746319,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1574746319","product_id":100023201,"comment_content":"function sleep(duration){<br>    return new Promise(function(resolve){<br>        setTimeout(resolve, duration);<br>    })<br>}<br>async function changeColor(duration,color){<br>    document.getElementById(&quot;traffic-light&quot;).style.background = color;<br>    await sleep(duration);<br><br>}<br>async function main(){<br>  await changeColor(3000,&quot;green&quot;);<br>  await changeColor(1000, &quot;yellow&quot;);<br>  await changeColor(2000, &quot;red&quot;);<br>  await main();<br>}<br>main()","like_count":0},{"had_liked":false,"id":153340,"user_name":"猫总","can_delete":false,"product_type":"c1","uid":1510269,"ip_address":"","ucode":"610BFD3253B1BA","user_header":"","comment_is_top":false,"comment_ctime":1574220081,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1574220081","product_id":100023201,"comment_content":"    const testDom = document.getElementById(&#39;test&#39;)<br><br>    function changeColor (color, dur) {<br>      return new Promise(resolve =&gt; {<br>        setTimeout(() =&gt; {<br>          testDom.style.background = color<br>          resolve()<br>        }, dur);<br>      })<br>    }<br><br>    async function onece () {<br>      await changeColor(&#39;red&#39;, 3000)<br>      await changeColor(&#39;green&#39;, 2000)<br>      await changeColor(&#39;yellow&#39;, 1000)<br>    }<br><br>    function carousel() {<br>      onece().then(resolve =&gt; {<br>        carousel()<br>      })<br>    }<br><br>    carousel()","like_count":0},{"had_liked":false,"id":151476,"user_name":"李扬","can_delete":false,"product_type":"c1","uid":1376098,"ip_address":"","ucode":"9ABA00C143C34D","user_header":"https://static001.geekbang.org/account/avatar/00/14/ff/62/8c302aa5.jpg","comment_is_top":false,"comment_ctime":1573727759,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1573727759","product_id":100023201,"comment_content":"async function changeLight() {<br>  let _node = document.getElementById(&#39;light-wrap&#39;)<br>  await _change(3000, &#39;green&#39;)<br>  await _change(1000, &#39;yellow&#39;)<br>  await _change(2000, &#39;red&#39;)<br><br>  function _change(tms, _color) {<br>    return new Promise((resolve) =&gt; {<br>      _node.style.backgroundColor = _color;<br>      setTimeout(resolve, tms)<br>    })<br>  }<br>}<br><br>async function loop() {<br>  await changeLight()<br>  loop()<br>}<br><br>loop()","like_count":0},{"had_liked":false,"id":143932,"user_name":"涯渊","can_delete":false,"product_type":"c1","uid":1443237,"ip_address":"","ucode":"F364D121087F1F","user_header":"https://static001.geekbang.org/account/avatar/00/16/05/a5/69955c34.jpg","comment_is_top":false,"comment_ctime":1571808890,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1571808890","product_id":100023201,"comment_content":"对前端挺感兴趣的，学了课程受益良多，比较喜欢这种从原理层面去理解的，小练习做了下伪劣板的，<br>  function light(duration){<br>    return new Promise(function(resolve,reject){<br>      setTimeout(resolve,duration);<br>    })<br>  }<br>  async function dynamicTrafficLight(){<br>    while(true){<br>      console.log(&#39;green&#39;);<br>      await light(3000);<br>      console.log(&#39;yellow&#39;);<br>      await light(1000);<br>      console.log(&#39;red&#39;);<br>      await light(2000);<br>    }<br>  }<br>  dynamicTrafficLight();","like_count":0},{"had_liked":false,"id":143541,"user_name":"FC.@","can_delete":false,"product_type":"c1","uid":1383423,"ip_address":"","ucode":"A0E0111A25A113","user_header":"https://static001.geekbang.org/account/avatar/00/15/1b/ff/e60f7d17.jpg","comment_is_top":false,"comment_ctime":1571728576,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1571728576","product_id":100023201,"comment_content":"const ct = document.getElementById(&#39;ct&#39;)<br><br>function light(color, timer) {<br>    return new Promise((resolve, reject) =&gt; {<br>        setTimeout(() =&gt; {<br>            ct.style.background = color;<br>            resolve()<br>        }, timer)<br>    })<br>}<br><br>async function lighting() {<br>    await light(&#39;red&#39;, 3000)<br>    await light(&#39;yellow&#39;, 1000)<br>    await light(&#39;green&#39;, 2000)<br><br>    return lighting()<br>}<br>lighting()","like_count":0},{"had_liked":false,"id":120990,"user_name":"Hc_Zzz","can_delete":false,"product_type":"c1","uid":1009735,"ip_address":"","ucode":"85B8FB5E07E2B9","user_header":"https://static001.geekbang.org/account/avatar/00/0f/68/47/893fb1ba.jpg","comment_is_top":false,"comment_ctime":1565031199,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1565031199","product_id":100023201,"comment_content":"codepen 运行效果： https:&#47;&#47;codepen.io&#47;HanchengZhao-1471862086&#47;pen&#47;oKpNpm?editors=1111","like_count":0},{"had_liked":false,"id":116159,"user_name":"小瓶儿","can_delete":false,"product_type":"c1","uid":1375564,"ip_address":"","ucode":"BC40A5F600FC0F","user_header":"https://static001.geekbang.org/account/avatar/00/14/fd/4c/e405a855.jpg","comment_is_top":false,"comment_ctime":1563795347,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1563795347","product_id":100023201,"comment_content":"const changeColor = (color, duration) =&gt; {<br>  return new Promise((resolve, reject) =&gt; {<br>\tsetTimeout(resolve, duration, color)<br>  })<br>}<br>const colorArr = [{label: &#39;red&#39;, time: 2000}, {label: &#39;green&#39;, time: 3000}, {label: &#39;yellow&#39;, time: 1000}]; <br>colorArr.forEach(item =&gt; {<br>  changeColor(item.label, item.time).then(res =&gt; {console.log(`${res}灯来啦`)})<br>})","like_count":0},{"had_liked":false,"id":113621,"user_name":"siegfried","can_delete":false,"product_type":"c1","uid":1007931,"ip_address":"","ucode":"31673819DD2605","user_header":"https://static001.geekbang.org/account/avatar/00/0f/61/3b/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1563095809,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1563095809","product_id":100023201,"comment_content":"var trafficLight = () =&gt; {<br>\t&#47;&#47; 实现一个红绿灯，把一个圆形 div 按照绿色 3s，黄色 1s , 红色 2s. 循环输出<br>\tasync function exec() {<br>\t\tconst ts = [<br>\t\t\t{<br>\t\t\t\tduration: 3000,<br>\t\t\t\tcolor: &#39;green&#39;<br>\t\t\t},<br>\t\t\t{<br>\t\t\t\tduration: 1000,<br>\t\t\t\tcolor: &#39;yellow&#39;<br>\t\t\t},<br>\t\t\t{<br>\t\t\t\tduration: 2000,<br>\t\t\t\tcolor: &#39;red&#39;<br>\t\t\t}<br>\t\t];\t<br><br>\t\t&#47;&#47; 单次输出<br>\t\tfor (let i = 0; i &lt; ts.length; i++) {<br>\t\t\tawait light(ts[i].color, ts[i].duration)<br>\t\t}<br><br>\t\t&#47;&#47; 无限循环<br>\t\tlet i = 0;<br>\t\twhile (1) {<br>\t\t\tp = ts[i];<br>\t\t\tawait light(ts[i].color, ts[i].duration)<br>\t\t\t++i<br>\t\t\ti = (i % ts.length)<br>\t\t}<br><br>\t\t&#47;&#47; wrong forEach是并发执行的，不会继发执行<br>\t\tts.forEach(async function (t) {<br>\t\t\tawait light(t.color, t.duration)<br>\t\t})<br>\t}<br><br>\tfunction light(color, duration) {<br>\t\treturn new Promise(resolve =&gt; {<br>\t\t\tconsole.log(color)<br><br>\t\t\tsetTimeout(() =&gt; {<br>\t\t\t\tresolve()<br>\t\t\t}, duration)<br>\t\t})<br>\t}<br>}","like_count":0},{"had_liked":false,"id":113495,"user_name":"大力","can_delete":false,"product_type":"c1","uid":1364353,"ip_address":"","ucode":"1B2125C519443D","user_header":"https://static001.geekbang.org/account/avatar/00/14/d1/81/89ba9d81.jpg","comment_is_top":false,"comment_ctime":1563031538,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1563031538","product_id":100023201,"comment_content":"let changeColor = (div, duration, color) =&gt; {<br>\treturn new Promise((resolve, reject) =&gt; {<br>\t\tsetTimeout(resolve, duration * 1000);<br>\t})<br>\t.then(() =&gt; {<br>\t\tlet style = div.getAttribute(&#39;style&#39;);<br>\t\tstyle = style || {};<br>\t\tstyle[&#39;background-color&#39;] = color;<br>\t\tconsole.log(&#39;current color: &#39; + color);<br>\t});<br>};<br><br>let flash = async div =&gt; {<br>\twhile(true) {<br>\t\tawait changeColor(div, 3, &#39;green&#39;);<br>\t\tawait changeColor(div, 1, &#39;yellow&#39;);<br>\t\tawait changeColor(div, 2, &#39;red&#39;);<br>\t}<br>};<br><br>let div = document.createElement(&#39;div&#39;);<br>div.setAttribute(&#39;class&#39;, &#39;traffic-light&#39;);<br>flash(div);","like_count":0},{"had_liked":false,"id":111207,"user_name":"zker-non","can_delete":false,"product_type":"c1","uid":1388586,"ip_address":"","ucode":"5A1C3212ED0912","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/5tO3rCyAaJAnXITSxSnWhntTb5URuVh0nibtZ6oIXzeRqPG1MZVe6HpXxXOgrG4IiaYY2MzQlVTkxeOv228muCEQ/132","comment_is_top":false,"comment_ctime":1562510948,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1562510948","product_id":100023201,"comment_content":"function stay(time) {<br>\treturn new Promise(function(resolve) {<br>  \tsetTimeout(resolve, time);<br>  })<br>}<br><br>async function switchColorContinue(elem) {<br>\tlet colors = [&quot;green&quot;, &quot;yellow&quot;, &quot;red&quot;];<br>  let duration = {<br>  \tgreen: 3000,<br>    yellow: 1000,<br>    red: 2000<br>  }<br>  while(true) {<br>  \tfor (const color of colors) {<br>  \t\telem.style.backgroundColor = color;<br>    \tawait stay(duration[color])<br>  \t}<br>  }<br>  <br>  <br><br>}<br><br>let target = document.getElementById(&quot;circle&quot;);<br><br>switchColorContinue(target);","like_count":0},{"had_liked":false,"id":107108,"user_name":"奋逗的码农哥","can_delete":false,"product_type":"c1","uid":1582667,"ip_address":"","ucode":"46195536825201","user_header":"https://static001.geekbang.org/account/avatar/00/18/26/4b/d1fc46d6.jpg","comment_is_top":false,"comment_ctime":1561460508,"is_pvip":false,"replies":[{"id":"58935","content":"这个不太行，完全是回调，没有用上Promise的优势啊","user_name":"作者回复","user_name_real":"winter","uid":"1268524","ctime":1574221830,"ip_address":"","comment_id":107108,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1561460508","product_id":100023201,"comment_content":"&#47;&#47; 实现一个红绿灯，把一个圆形 div 按照绿色3 秒，黄色 1 秒，红色 2 秒循环改变背景色<br>&#47;&#47; 初始化创建元素<br>var div = document.createElement(&quot;div&quot;)<br>div.className = &#39;light&#39;<br>div.innerText=&#39;&#39;<br>div.style.backgroundColor = &#39;&#39;<br>div.align = &#39;center&#39;<br>div.style.fontSize = &#39;30px&#39;<br>div.style.lineHeight = &#39;100px&#39;<br>div.style.color = &#39;#fff&#39;<br>div.style.height = 100<br>div.style.width = 100<br>div.style.borderRadius = &#39;50px&#39;<br>document.body.appendChild(div)<br><br>var sleep = function (duration) {<br>    return new Promise(function(resolve, reject) {<br>        setTimeout(resolve,duration);<br>    })<br>}<br><br>&#47;&#47; 绿灯<br>var green = function () {<br>  document.querySelector(&#39;.light&#39;).style.backgroundColor = &#39;green&#39;<br>  sleep(3000).then(()=&gt; { yellow() });<br>}<br><br>&#47;&#47; 黄灯<br>var yellow = function () {<br>  document.querySelector(&#39;.light&#39;).style.backgroundColor = &#39;yellow&#39;<br>  sleep(1000).then(()=&gt; { red() });<br>}<br><br>&#47;&#47; 红灯<br>var red = function () {<br>  document.querySelector(&#39;.light&#39;).style.backgroundColor = &#39;red&#39;<br>  sleep(2000).then(()=&gt; { green() });<br>}<br><br>var init = function() {<br>  &#47;&#47; 绿灯启动<br>  green()<br>}<br><br>&#47;&#47; 执行<br>init()","like_count":0,"discussions":[{"author":{"id":1268524,"avatar":"https://static001.geekbang.org/account/avatar/00/13/5b/2c/12bfd3cd.jpg","nickname":"winter","note":"","ucode":"2B068EDEAFEB56","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":455367,"discussion_content":"这个不太行，完全是回调，没有用上Promise的优势啊","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574221830,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":104796,"user_name":"Geek_14c289","can_delete":false,"product_type":"c1","uid":1581042,"ip_address":"","ucode":"4BFE1658D17849","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLM6pIKfRqnNN0tb6ckakFXib6erRDWWMvaEPX2P9uCUo3qyM3ZQgicjIOcSNzAv0ZnKtJymqxFtRcQ/132","comment_is_top":false,"comment_ctime":1560840480,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1560840480","product_id":100023201,"comment_content":"&lt;!DOCTYPE html&gt;<br>&lt;html lang=&quot;en&quot;&gt;<br>&lt;head&gt;<br>    &lt;meta charset=&quot;UTF-8&quot;&gt;<br>    &lt;title&gt;Title&lt;&#47;title&gt;<br>    &lt;style&gt;<br>        .circle{<br>            width: 50px;<br>            height: 50px;<br>            border-radius: 25px;<br>            border: solid 1px #333333;<br>        }<br>        .green{<br>            background: green;<br>        }<br>        .yellow{<br>            background: yellow;<br>        }<br>        .red{<br>            background: red;<br>        }<br>    &lt;&#47;style&gt;<br>&lt;&#47;head&gt;<br>&lt;body&gt;<br>&lt;div class=&quot;circle&quot; id=&quot;circle1&quot;&gt;&lt;&#47;div&gt;<br>&lt;div class=&quot;circle&quot; id=&quot;circle2&quot;&gt;&lt;&#47;div&gt;<br>&lt;div class=&quot;circle&quot; id=&quot;circle3&quot;&gt;&lt;&#47;div&gt;<br>&lt;script&gt;<br>    var dom1 = document.getElementById(&#39;circle1&#39;);<br>    var dom2 = document.getElementById(&#39;circle2&#39;);<br>    var dom3 = document.getElementById(&#39;circle3&#39;);<br>    window.onload = function () {<br>        turnGreen();<br>    };<br>    function turnGreen() {<br>        dom1.className = &#39;circle green&#39;;<br>        dom2.className = &#39;circle&#39;;<br>        dom3.className = &#39;circle&#39;;<br>        setTimeout(function () {<br>            turnYellow();<br>        }, 3000);<br>    }<br>    function turnYellow() {<br>        dom1.className = &#39;circle&#39;;<br>        dom2.className = &#39;circle yellow&#39;;<br>        dom3.className = &#39;circle&#39;;<br>        setTimeout(function () {<br>            turnRed();<br>        }, 1000);<br>    }<br>    function turnRed() {<br>        dom1.className = &#39;circle&#39;;<br>        dom2.className = &#39;circle&#39;;<br>        dom3.className = &#39;circle red&#39;;<br>        setTimeout(function () {<br>            turnGreen();<br>        }, 2000);<br>    }<br>&lt;&#47;script&gt;<br>&lt;&#47;body&gt;<br>&lt;&#47;html&gt;","like_count":0},{"had_liked":false,"id":104442,"user_name":"码农","can_delete":false,"product_type":"c1","uid":1387777,"ip_address":"","ucode":"07EA25C61A8721","user_header":"https://static001.geekbang.org/account/avatar/00/15/2d/01/b201d82b.jpg","comment_is_top":false,"comment_ctime":1560755423,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1560755423","product_id":100023201,"comment_content":"function changeColor(color,duration){<br>      return new Promise((resolve,reject) =&gt; {<br>        setTimeout( () =&gt; {<br>                             document.getElementById(&#39;traffic-light&#39;).style.background=color;<br>          resolve();<br>        },duration);<br>      })<br>    }<br>    <br>    async function foo(){<br>      document.getElementById(&#39;traffic-light&#39;).style.background=&#39;green&#39;;<br>      while(true){<br>        await changeColor(&#39;yellow&#39;,3000);<br>        await changeColor(&#39;red&#39;,1000);<br>        await changeColor(&#39;green&#39;,2000);<br>      }<br>      <br>    }<br><br>    foo();","like_count":0},{"had_liked":false,"id":103425,"user_name":"Jaykey","can_delete":false,"product_type":"c1","uid":1167992,"ip_address":"","ucode":"535FEA1292D290","user_header":"https://static001.geekbang.org/account/avatar/00/11/d2/78/1f1b45f9.jpg","comment_is_top":false,"comment_ctime":1560432741,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1560432741","product_id":100023201,"comment_content":"function lightTime (duration) {<br>    return new Promise((resolve, reject) =&gt; {<br>        setTimeout(resolve, duration);<br>    })<br>}<br>async function light (color, time) {<br>    await lightTime(time)<br>    console.log(color)<br>}<br><br>async function crossRoad() {<br>\twhile(2&gt;1) {<br>        await light(&#39;green&#39;, 3000);<br>        await light(&#39;yellow&#39;, 1000);<br>        await light(&#39;red&#39;, 2000);<br>    }<br>}<br><br>crossRoad()","like_count":0},{"had_liked":false,"id":102911,"user_name":"gzj","can_delete":false,"product_type":"c1","uid":1380895,"ip_address":"","ucode":"688831FC7BAD88","user_header":"","comment_is_top":false,"comment_ctime":1560327263,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1560327263","product_id":100023201,"comment_content":"老师，问下第一个留言里 main函数中的 while(true){} 有什么用意吗？","like_count":0,"discussions":[{"author":{"id":1641179,"avatar":"","nickname":"三七二十几","note":"","ucode":"5E55B19DD04FDC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":6704,"discussion_content":"一直循环执行","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1567061089,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1485599,"avatar":"","nickname":"胡桃夹子","note":"","ucode":"EA58FBAD8143E7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":194787,"discussion_content":"确保三个单次定时器能永远执行下去","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583242708,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":101861,"user_name":"积微","can_delete":false,"product_type":"c1","uid":1378111,"ip_address":"","ucode":"373DF8B1DC002B","user_header":"https://static001.geekbang.org/account/avatar/00/15/07/3f/43872dff.jpg","comment_is_top":false,"comment_ctime":1559998902,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1559998902","product_id":100023201,"comment_content":"-macro-task包括：<br>script(整体代码), setTimeout, setInterval, setImmediate, I&#47;O, UI rendering。<br><br>micro-task包括：<br>process.nextTick, Promises, Object.observe, MutationObserver.<br><br>不知道有没有错误？","like_count":0},{"had_liked":false,"id":97460,"user_name":"少年","can_delete":false,"product_type":"c1","uid":1527279,"ip_address":"","ucode":"AE7BE546913C0E","user_header":"https://static001.geekbang.org/account/avatar/00/17/4d/ef/25dda3a4.jpg","comment_is_top":false,"comment_ctime":1558675877,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1558675877","product_id":100023201,"comment_content":"var light = document.getElementById(&#39;light&#39;);<br>function sleep(duration) {<br>\treturn new Promise((resolve, reject)=&gt;{<br>\t\tsetTimeout(resolve, duration);<br>\t});<br>}<br>async function change (duration, color) {<br>\tlight.style.background = color;<br>\tawait sleep(duration);<br>}<br>(async function run() {<br>\tawait change(3 * 1000, &#39;green&#39;);<br>\tawait change(1 * 1000, &#39;yellow&#39;);<br>\tawait change(2 * 1000, &#39;red&#39;);<br>\tawait run();<br>})();","like_count":0},{"had_liked":false,"id":97406,"user_name":"Roam","can_delete":false,"product_type":"c1","uid":1387678,"ip_address":"","ucode":"1CB7B8555AF16C","user_header":"https://static001.geekbang.org/account/avatar/00/15/2c/9e/b44ed40d.jpg","comment_is_top":false,"comment_ctime":1558665583,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1558665583","product_id":100023201,"comment_content":"function sleep (duration) {<br>  return new Promise(resolve =&gt; {<br>    setTimeout(resolve, duration)<br>  })<br>}<br><br>function changeBackgroundColor (el, color) {<br>  el.style.backgroundColor = color<br>}<br><br>async function loop (el, queue) {<br>  if (queue.length &lt; 1) return<br><br>  const item = queue.shift()<br><br>  queue.push(item)<br>  changeBackgroundColor(el, item.color)<br>  await sleep(item.duration)<br><br>  loop(el, queue)<br>}<br><br>function start () {<br>  const el = document.getElementById(&#39;el&#39;)<br>  const queue = [<br>    {<br>      color: &#39;green&#39;,<br>      duration: 3000<br>    },<br>    {<br>      color: &#39;yellow&#39;,<br>      duration: 1000<br>    },<br>    {<br>      color: &#39;red&#39;,<br>      duration: 2000<br>    }<br>  ]<br><br>  loop(el, queue)<br>}<br><br>start()","like_count":0},{"had_liked":false,"id":96463,"user_name":"释然","can_delete":false,"product_type":"c1","uid":1420287,"ip_address":"","ucode":"840244682A26CB","user_header":"https://static001.geekbang.org/account/avatar/00/15/ab/ff/a39e1ad7.jpg","comment_is_top":false,"comment_ctime":1558429624,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1558429624","product_id":100023201,"comment_content":"let light = document.getElementById(&#39;light&#39;);<br>function changeColor() {<br>\tsetTimeout(()=&gt; {<br>\t\tlight.style.background = &#39;yellow&#39;;<br>\t},3000)<br>\tsetTimeout(()=&gt; {<br>\t\tlight.style.background = &#39;red&#39;;<br>\t},4000)<br>\tsetTimeout(()=&gt; {<br>\t\tlight.style.background = &#39;green&#39;;<br>\t\tchange()<br>\t},6000)<br><br>}<br>changeColor()","like_count":0},{"had_liked":false,"id":94156,"user_name":"奥斯特洛夫斯基","can_delete":false,"product_type":"c1","uid":1379844,"ip_address":"","ucode":"9AFECAC3A1FCAD","user_header":"https://static001.geekbang.org/account/avatar/00/15/0e/04/d710d928.jpg","comment_is_top":false,"comment_ctime":1557734291,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1557734291","product_id":100023201,"comment_content":"可以讲讲浏览器中的事件循环和node中的事件循环的区别吗","like_count":0},{"had_liked":false,"id":91148,"user_name":"xuanyuan","can_delete":false,"product_type":"c1","uid":1113737,"ip_address":"","ucode":"1EC79B9372868F","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI2icbib62icXtibTkThtyRksbuJLoTLMts7zook2S30MiaBtbz0f5JskwYicwqXkhpYfvCpuYkcvPTibEaQ/132","comment_is_top":false,"comment_ctime":1556881902,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1556881902","product_id":100023201,"comment_content":"宏观认为和微观任务还是感觉没看明白","like_count":0},{"had_liked":false,"id":90174,"user_name":"Sher","can_delete":false,"product_type":"c1","uid":1462558,"ip_address":"","ucode":"9A6645FD2CD64A","user_header":"https://static001.geekbang.org/account/avatar/00/16/51/1e/0717c37a.jpg","comment_is_top":false,"comment_ctime":1556439583,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1556439583","product_id":100023201,"comment_content":"async&#47;await 是 应该是 ES2017 ，我配置 .eslintrc.json，这样才不会报错<br>&quot;parserOptions&quot;: {<br>        &quot;ecmaVersion&quot;: 2017,<br>        &quot;sourceType&quot;: &quot;module&quot;<br>    },","like_count":0},{"had_liked":false,"id":89774,"user_name":"Zkerhcy","can_delete":false,"product_type":"c1","uid":1231133,"ip_address":"","ucode":"43A883F6FB6070","user_header":"https://static001.geekbang.org/account/avatar/00/12/c9/1d/c7586cfc.jpg","comment_is_top":false,"comment_ctime":1556261742,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1556261742","product_id":100023201,"comment_content":"let sleep = duration =&gt;<br>  new Promise(function(resolve, reject) {<br>    setTimeout(resolve, duration)<br>  })<br>;(async function trafficLight() {<br>  while (true) {<br>    console.log(&quot;Green&quot;)<br>    await sleep(3000)<br>    console.log(&quot;Yellow&quot;)<br>    await sleep(1000)<br>    console.log(&quot;Red&quot;)<br>    await sleep(2000)<br>  }<br>})()<br>","like_count":0},{"had_liked":false,"id":87255,"user_name":"坚持下呢","can_delete":false,"product_type":"c1","uid":1434062,"ip_address":"","ucode":"12246A8DDAE92E","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epia1vHGsTDRTyfFcrsiabK2nIWITdhIEUDBw9ZHviaZSg82tsRiatIQ4BQ14p8AicbjYCleHH3I0YfPFQ/132","comment_is_top":false,"comment_ctime":1555553067,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1555553067","product_id":100023201,"comment_content":"function change(duration, bgcolor) {<br>    return new Promise(function(resolve, reject) {<br>        setTimeout(function(){<br>            document.getElementById(&#39;light&#39;).style.backgroundColor = bgcolor;<br>            resolve();<br>        }, duration);<br>    });<br>}<br>        <br>async function green() {<br>    await change(3000, &#39;yellow&#39;);<br>    yellow();<br>}<br><br>async function yellow() {<br>    await change(1000, &#39;red&#39;);<br>    red();<br>}<br><br>async function red() {<br>    await change(2000, &#39;green&#39;);<br>    green();<br>}<br><br>green();","like_count":0},{"had_liked":false,"id":86491,"user_name":"王玄","can_delete":false,"product_type":"c1","uid":1394410,"ip_address":"","ucode":"E54ABB340D1E49","user_header":"https://static001.geekbang.org/account/avatar/00/15/46/ea/b86667b8.jpg","comment_is_top":false,"comment_ctime":1555382727,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1555382727","product_id":100023201,"comment_content":"console promise是什么任务 还是什么？ 我有点不解","like_count":0},{"had_liked":false,"id":85626,"user_name":"Geek_0bb537","can_delete":false,"product_type":"c1","uid":1488361,"ip_address":"","ucode":"BE1A16372FC814","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJDSY5xBJ2PH4lqNtWJqhe1HcYkP7S9ibAXChONgCBX5pJ2gaU3icXhltQgqhzDyML3EzFicxPeE4Tiag/132","comment_is_top":false,"comment_ctime":1555147028,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1555147028","product_id":100023201,"comment_content":"winter老师 这个async&amp;&amp;await可否理解成generator和co模块的整合 然后扩展了一些功能","like_count":0},{"had_liked":false,"id":85401,"user_name":"chwech","can_delete":false,"product_type":"c1","uid":1469503,"ip_address":"","ucode":"C6F721086D80C7","user_header":"https://static001.geekbang.org/account/avatar/00/16/6c/3f/b83f0b5e.jpg","comment_is_top":false,"comment_ctime":1555053376,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1555053376","product_id":100023201,"comment_content":"var c = document.getElementsByClassName(&#39;box&#39;)[0]<br><br>  function turnColor(el, color, s) {<br>    return new Promise((resolve, reject) =&gt; {<br>      setTimeout(() =&gt; {<br>        el.style.background = color<br>        resolve()<br>      }, s)\t<br>    })<br>  }<br><br>  async function start(aa) {<br>    await turnColor(c, &#39;green&#39;, 3000)<br>    await turnColor(c, &#39;yellow&#39;, 1000)<br>    await turnColor(c, &#39;red&#39;, 2000)<br>    return start()<br>  }<br><br>  start()","like_count":0},{"had_liked":false,"id":84603,"user_name":"Cander","can_delete":false,"product_type":"c1","uid":1381524,"ip_address":"","ucode":"838B8F877C7080","user_header":"https://static001.geekbang.org/account/avatar/00/15/14/94/7fcd4c89.jpg","comment_is_top":false,"comment_ctime":1554883912,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1554883912","product_id":100023201,"comment_content":"<br>setTimeout(() =&gt; {<br>  console.log(1)<br>}, 0)<br><br>new Promise(r =&gt; {<br>  console.log(2)<br>  r()<br>}).then(r =&gt; {<br>  console.log(3)<br>  new Promise(s =&gt; {<br>    console.log(4)<br>    s()<br>  }).then(q =&gt; {<br>    console.log(5)<br>  })<br>})<br>老师, 我不明白为什么在微任务中添加微任务, 还是会早与宏任务执行? 可以帮我解答下吗?","like_count":0},{"had_liked":false,"id":84146,"user_name":"孙小垚","can_delete":false,"product_type":"c1","uid":1462889,"ip_address":"","ucode":"2309114BFE2123","user_header":"https://static001.geekbang.org/account/avatar/00/16/52/69/cd5147df.jpg","comment_is_top":false,"comment_ctime":1554793609,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1554793609","product_id":100023201,"comment_content":"let light = document.getElementById(&quot;light&quot;);<br><br>    function changeColor (await, color) {<br>      return new Promise((resolve, reject) =&gt; {<br>        light.className = color<br>        setTimeout(resolve, await)<br>      })<br>    }<br><br>    async function main () {<br>      while (!document.hidden) {<br>        await changeColor(3000, &quot;green&quot;);<br>        await changeColor(1000, &quot;yellow&quot;);<br>        await changeColor(2000, &quot;red&quot;);<br>      }<br>    }<br><br>    main();","like_count":0},{"had_liked":false,"id":83607,"user_name":"秦东","can_delete":false,"product_type":"c1","uid":1365487,"ip_address":"","ucode":"3E21D2777B1D3D","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIHiaJ01zhIap20ckTyMWg3NycAd2yTRVwJyKQfdCt7rR2MlnBak1yZOfuRfxq51lstxQJ9ic6df9icQ/132","comment_is_top":false,"comment_ctime":1554684716,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1554684716","product_id":100023201,"comment_content":"http:&#47;&#47;www.ruanyifeng.com&#47;blog&#47;2014&#47;10&#47;event-loop.html<br>阮大神讲解的更加透彻。宏观，微观，有点。。。","like_count":0},{"had_liked":false,"id":80039,"user_name":"理想两旬半.","can_delete":false,"product_type":"c1","uid":1378789,"ip_address":"","ucode":"3A9A963DAF380C","user_header":"https://static001.geekbang.org/account/avatar/00/15/09/e5/666ba844.jpg","comment_is_top":false,"comment_ctime":1553597785,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1553597785","product_id":100023201,"comment_content":"老师您好，下面这个自己练习的例子希望您能帮解答：<br><br>console.log(&#39;sync1&#39;);<br><br>    setTimeout(function () {<br>        console.log(&#39;setTimeout1&#39;)<br>    }, 0);<br><br>    var promise = new Promise(function (resolve, reject) {<br>        setTimeout(function () {<br>            console.log(&#39;setTimeoutPromise&#39;)<br>        }, 0);<br>        console.log(&#39;promise&#39;);<br>        resolve();<br>    });<br><br><br>    promise.then(() =&gt; {<br>        console.log(&#39;pro_then&#39;);<br>        setTimeout(() =&gt; {<br>            console.log(&#39;pro_timeout&#39;);<br>        }, 0)<br>    })<br><br>    setTimeout(function () {<br>        console.log(&#39;last_setTimeout&#39;)<br>    }, 0);<br>    console.log(&#39;sync2&#39;);<br><br>为什么 promise.then中的settimeout是最后打印的？<br>不用管是宏任务依次执行吗","like_count":0},{"had_liked":false,"id":80029,"user_name":"翰弟","can_delete":false,"product_type":"c1","uid":1144772,"ip_address":"","ucode":"42149ACC75AA08","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/EJZoM46wR6QqTeibhPZsO5wJTeUia4RndGicWfDZLw153WibjsnJXqEtGZICxAa8icb36pDkficTic3FViaySd1z9HmQBw/132","comment_is_top":false,"comment_ctime":1553596279,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1553596279","product_id":100023201,"comment_content":"        function sleep(duration) {<br>            return new Promise(function (resolve) {<br>                setTimeout(resolve, duration)<br>            })<br>        }<br>        function setColor(color) {<br>            document.querySelector(&#39;.box&#39;).style.backgroundColor = color;<br>        }<br><br>        async function showColor() {<br>            setColor(&quot;green&quot;)<br>            await sleep(3000).then(() =&gt; {<br>                setColor(&quot;yellow&quot;)<br>            })<br>            await sleep(1000).then(() =&gt; {<br>                setColor(&quot;blue&quot;)<br>            })<br>            await sleep(2000).then(() =&gt; {<br>                showColor()<br>            })<br>        }<br><br>        showColor()","like_count":0},{"had_liked":false,"id":79271,"user_name":"笨鸟","can_delete":false,"product_type":"c1","uid":1011000,"ip_address":"","ucode":"EE93B7BDD677E4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/6d/38/c951cb2e.jpg","comment_is_top":false,"comment_ctime":1553420589,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1553420589","product_id":100023201,"comment_content":"with 影响到 function 作用域是指 env 的值被更改了吧","like_count":0},{"had_liked":false,"id":79024,"user_name":"psaren","can_delete":false,"product_type":"c1","uid":1471497,"ip_address":"","ucode":"E1764DA7BBDB70","user_header":"https://wx.qlogo.cn/mmopen/vi_32/Ab0qA9O310giaLldWw1ibsD8tMNIHzspD0rHYqFkkFodK89zdOgfymSttqBfibM5N3u3Gf6G3unibicKyy96Z2JM1cA/132","comment_is_top":false,"comment_ctime":1553326065,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1553326065","product_id":100023201,"comment_content":"下面链接打开codeopen  <br>可以看到详细的 HTML、CSS、JS和实现效果<br>https:&#47;&#47;codepen.io&#47;psaren&#47;pen&#47;RdEzYL<br><br>const light = document.querySelector(&#39;#light&#39;)<br>function sleep(duration) {<br>  return new Promise(function(resolve, reject) {<br>    setTimeout(resolve, duration);<br>  }) <br>}<br>const lightup = async (lighType, duration) =&gt; {<br>  light.className = `light ${lighType}`<br>  await sleep(duration)<br>}<br>const init = async () =&gt; {<br>  while(true){<br>    await lightup(&#39;green&#39;, 3000);<br>    await lightup(&#39;yellow&#39;, 1000);<br>    await lightup(&#39;red&#39;, 2000);<br>  }<br>}<br>init()","like_count":0},{"had_liked":false,"id":78732,"user_name":"..","can_delete":false,"product_type":"c1","uid":1378900,"ip_address":"","ucode":"2054C3A3E90DBD","user_header":"https://static001.geekbang.org/account/avatar/00/15/0a/54/c659cca5.jpg","comment_is_top":false,"comment_ctime":1553225551,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1553225551","product_id":100023201,"comment_content":"function setColor(time , color) {<br>        return new Promise((resolve , reflect) =&gt; {<br>            document.getElementById(&#39;light&#39;).style.background = color;<br>            setTimeout(() =&gt; {<br>                resolve();<br>            }, time)<br>        })<br>    }<br>    async function setLight() {<br>        while (true) {<br>            await setColor(1000 , &#39;green&#39;)<br>            await setColor(2000 , &#39;red&#39;)<br>            await setColor(3000 , &#39;blue&#39;)<br>        }<br>    }<br>    setLight();","like_count":0},{"had_liked":false,"id":78298,"user_name":"Jy","can_delete":false,"product_type":"c1","uid":1027312,"ip_address":"","ucode":"B8D9382C1503E2","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ac/f0/5d52d73e.jpg","comment_is_top":false,"comment_ctime":1553127807,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1553127807","product_id":100023201,"comment_content":"为什么要设计micro task，我知道这样JS引擎可以自主地执行任务，但这样的好处是？提高性能？","like_count":0},{"had_liked":false,"id":78219,"user_name":"周飞","can_delete":false,"product_type":"c1","uid":1073374,"ip_address":"","ucode":"F85FA236EB0C0D","user_header":"https://static001.geekbang.org/account/avatar/00/10/60/de/5c67895a.jpg","comment_is_top":false,"comment_ctime":1553095010,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1553095010","product_id":100023201,"comment_content":"&lt;html&gt;<br>&lt;head&gt;&lt;&#47;head&gt;<br>&lt;body&gt;<br>\t&lt;div id=&quot;light&quot;&gt;&lt;&#47;div&gt;<br>\t&lt;script type=&quot;text&#47;javascript&quot;&gt;<br>\t\tsetColor(&#39;red&#39;);<br>\t\trun()<br>\t\tasync function run(){<br>\t\t   while(1){<br>\t\t\tawait sleep(3000).then(()=&gt;{setColor(&#39;yellow&#39;)});<br>\t\t\tawait sleep(1000).then(()=&gt;{setColor(&#39;green&#39;)});<br>\t\t\tawait sleep(2000).then(()=&gt;{setColor(&#39;red&#39;)});\t\t\t \t\t\t\t<br>\t\t   }<br>\t\t}\t\t<br><br>\t\tfunction setColor(color){\t\t\t<br>\t\t\tdocument.getElementById(&#39;light&#39;).style=`background-color:${color};width:100px;height:100px;border-radius: 50%;`;<br>\t\t}\t<br>\t\tfunction sleep(timeout){<br>\t\t\treturn new Promise(function(resolve,reject){<br>\t\t\t\tsetTimeout(resolve,timeout);<br>\t\t\t})<br>\t\t}\t<br>\t&lt;&#47;script&gt;<br>&lt;&#47;body&gt;<br>\t<br>&lt;&#47;html&gt;","like_count":0},{"had_liked":false,"id":76173,"user_name":"🚂🚂🚂","can_delete":false,"product_type":"c1","uid":1406838,"ip_address":"","ucode":"E4179F2648B296","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJByxt4cWqx8Aru7iaOPk2sibeWhwBfES6EKACnN2AvSyFC9DN5ibbWezicd6lA13Siaa3JyYjjSnY9BIg/132","comment_is_top":false,"comment_ctime":1552543517,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1552543517","product_id":100023201,"comment_content":"哈哈<br><br>function run(color,times){<br>   return setInterval(()=&gt;{<br>      &#47;&#47;change color<br>   },times)<br>}<br>let timerArr = [3000,1000,2000]<br>[&#39;green&#39;,&#39;yellow&#39;,red].forEach(function(color,key){<br>  run(color,timerArr[key])<br>})","like_count":0},{"had_liked":false,"id":75811,"user_name":"zhaizy","can_delete":false,"product_type":"c1","uid":1030249,"ip_address":"","ucode":"F77BF55E2CA57F","user_header":"https://static001.geekbang.org/account/avatar/00/0f/b8/69/bf6fffbe.jpg","comment_is_top":false,"comment_ctime":1552474545,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1552474545","product_id":100023201,"comment_content":"老师，还是没明白async await的实现原理。是否跟generator一样呢？","like_count":0},{"had_liked":false,"id":75672,"user_name":"子雅","can_delete":false,"product_type":"c1","uid":1011448,"ip_address":"","ucode":"AC0A63406EAA6B","user_header":"https://static001.geekbang.org/account/avatar/00/0f/6e/f8/bc90c8af.jpg","comment_is_top":false,"comment_ctime":1552447565,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1552447565","product_id":100023201,"comment_content":"getResult() {<br>        this.changeColor(&#39;red&#39;)<br>        let green = new Promise((resolve, reject)=&gt;{<br>            setTimeout(resolve, 3000)<br>        })<br>        green.then(()=&gt;{<br>          this.changeColor(&#39;orange&#39;)<br>          let orange = new Promise((resolve, reject)=&gt;{<br>            setTimeout(resolve, 1000)<br>          })<br>          orange.then(()=&gt;{<br>            this.changeColor(&#39;green&#39;)<br>            let red = new Promise((resolve, reject) =&gt;{<br>              setTimeout(resolve,2000)<br>            })<br>            red.then(()=&gt;{<br>              this.getResult()<br>            })<br>          })<br>        })<br>      }<br><br>     changeColor(col) {<br>       this.$refs.lamp.style.backgroundColor = col<br>     }<br><br>     getResult()","like_count":0},{"had_liked":false,"id":74757,"user_name":"undefined","can_delete":false,"product_type":"c1","uid":1378655,"ip_address":"","ucode":"2635757CFCF9EF","user_header":"https://static001.geekbang.org/account/avatar/00/15/09/5f/2937f890.jpg","comment_is_top":false,"comment_ctime":1552292786,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1552292786","product_id":100023201,"comment_content":"const div = document.querySelector(&#39;.div&#39;);<br>const conf = {<br>\tgreen: 3000,<br>\tred: 2000,<br>\tyellow: 1000<br>}<br>\t\t\t<br>function sleep(time, bg){<br>\treturn new Promise((resolve, reject) =&gt; {<br>\t\tdiv.style.backgroundColor = bg;<br>\t\tsetTimeout(() =&gt; {<br>\t\t\tresolve()<br>\t\t}, time)<br>\t})<br>}<br><br>while(true){<br>\tfor(let [key, value] of Object.entries(conf)){<br>\t\tawait sleep(value, key)<br>\t}<br>}","like_count":0},{"had_liked":false,"id":74647,"user_name":"存","can_delete":false,"product_type":"c1","uid":1293900,"ip_address":"","ucode":"66DDE719450B77","user_header":"https://static001.geekbang.org/account/avatar/00/13/be/4c/8d19d90a.jpg","comment_is_top":false,"comment_ctime":1552272245,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1552272245","product_id":100023201,"comment_content":"\t $(function(){<br>\t\t\t \tvar light=document.getElementById(&quot;light&quot;);<br>\t\t\t \t$(light).css(&quot;backgroundColor&quot;,&quot;red&quot;);<br>\t\t\t \tsetInterval(function(){<br>\t\t\t \t\tsetTimeout(function(){<br>\t\t\t \t\t\t$(light).css(&quot;backgroundColor&quot;,&quot;yellow&quot;);<br>\t\t\t \t\t},2000);<br>\t\t\t \t\tsetTimeout(function(){<br>\t\t\t \t\t\t$(light).css(&quot;backgroundColor&quot;,&quot;blue&quot;);<br>\t\t\t \t\t},3000);<br>\t\t\t \t\tsetTimeout(function(){<br>\t\t\t \t\t\t$(light).css(&quot;backgroundColor&quot;,&quot;red&quot;);<br>\t\t\t \t\t},6000);<br>\t\t\t \t},6000);<br>\t\t\t });","like_count":0},{"had_liked":false,"id":74562,"user_name":"存","can_delete":false,"product_type":"c1","uid":1293900,"ip_address":"","ucode":"66DDE719450B77","user_header":"https://static001.geekbang.org/account/avatar/00/13/be/4c/8d19d90a.jpg","comment_is_top":false,"comment_ctime":1552235937,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1552235937","product_id":100023201,"comment_content":"老师我发现 <br>setTimeout(()=&gt;console.log(&quot;d&quot;),0);<br>setTimeout(console.log(&quot;d&quot;),0);  的执行原理不同，老师能解释一下 吗？","like_count":0},{"had_liked":false,"id":74422,"user_name":"within〃","can_delete":false,"product_type":"c1","uid":1451554,"ip_address":"","ucode":"8F2219F0DC463C","user_header":"https://static001.geekbang.org/account/avatar/00/16/26/22/f826d202.jpg","comment_is_top":false,"comment_ctime":1552222535,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1552222535","product_id":100023201,"comment_content":"function sleep (duration) {<br>  return new Promise((resolve) =&gt; {<br>    setTimeout(resolve, duration)<br>  })<br>}<br><br>function changeDivColor (color) {<br>  document.querySelector(&#39;div&#39;).style.backgroundColor = color<br>}<br><br>async function asyncChangeDivColor (duration, color) {<br>  await sleep(duration)<br>  changeDivColor(color)<br>}<br><br>async function loopMain () {<br>  while (true) {<br>    await asyncChangeDivColor(1000, &#39;red&#39;)<br>    await asyncChangeDivColor(1000, &#39;yellow&#39;)<br>    await asyncChangeDivColor(1000, &#39;black&#39;)<br>  }<br>}<br><br>try {<br>  loopMain()<br>} catch (e) {<br>  errHandler(e)<br>}<br><br>function errHandler (err) {<br>  console.log(err)<br>}","like_count":0},{"had_liked":false,"id":74030,"user_name":"大树","can_delete":false,"product_type":"c1","uid":1390549,"ip_address":"","ucode":"0B4C9091520DFA","user_header":"https://static001.geekbang.org/account/avatar/00/15/37/d5/22299804.jpg","comment_is_top":false,"comment_ctime":1552089423,"is_pvip":false,"discussion_count":0,"race_medal":1,"score":"1552089423","product_id":100023201,"comment_content":"function f2() { };<br><br>var f3 = new Function(&#39;console.log(typeof f2);&#39;)<br>f3(); &#47;&#47; &#39;undefined&#39;<br><br>var f3 = function () { console.log(typeof f2); }<br>f3();&#47;&#47; &#39;function&#39;","like_count":0},{"had_liked":false,"id":73800,"user_name":"杨斌","can_delete":false,"product_type":"c1","uid":1382239,"ip_address":"","ucode":"AE5ACF205E7CD7","user_header":"https://static001.geekbang.org/account/avatar/00/15/17/5f/1911049c.jpg","comment_is_top":false,"comment_ctime":1552004566,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1552004566","product_id":100023201,"comment_content":"我关心的是 为什么会有promise async这种结构的出现，具体带来了什么优势，这个点好像稿子中没提到","like_count":0,"discussions":[{"author":{"id":1379378,"avatar":"https://static001.geekbang.org/account/avatar/00/15/0c/32/e0178185.jpg","nickname":"youngleish","note":"","ucode":"A1FEEEBBD3D18B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":303108,"discussion_content":"这个可以去看你不知道的JS中卷","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599143265,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":73570,"user_name":"西瓜炒杨梅","can_delete":false,"product_type":"c1","uid":1374870,"ip_address":"","ucode":"41ED188AFC7299","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/8YDz4aIA1oIVUEttAgWicDA9adEFBbEibykia2A4ajm6Jhj7CZiadIO63hnUeZR4zZGLibxPWHiaF322DehKLvXcEt3A/132","comment_is_top":false,"comment_ctime":1551927188,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1551927188","product_id":100023201,"comment_content":"有个问题没理解，<br>\t\tfunction sleep(duration) {<br>\t\t\treturn new Promise(function(resolve,reject) {<br>\t\t\t\tsetTimeout(resolve,duration);<br>\t\t\t})<br>\t\t}<br>\t\tasync function change(time,color) {<br>\t\t\tdiv.style.backgroundColor = color;<br>\t\t\tawait sleep(time);<br>\t\t}<br>\t\tasync function foo2() {<br>\t\t\t\tawait change(2000,&#39;green&#39;)<br>\t\t\t\tawait change(1500,&#39;yellow&#39;)<br>\t\t\t\tawait change(1000,&#39;red&#39;)<br>\t\t}<br><br>\t\twhile(true) {<br>\t\t\tfoo2()<br>\t        }<br>如注释，为什么我while写在外面不行呢","like_count":0},{"had_liked":false,"id":73560,"user_name":"如斯","can_delete":false,"product_type":"c1","uid":1393087,"ip_address":"","ucode":"62A6244C4717D0","user_header":"https://static001.geekbang.org/account/avatar/00/15/41/bf/3afa1344.jpg","comment_is_top":false,"comment_ctime":1551926323,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1551926323","product_id":100023201,"comment_content":"let transLamp = ( function(){<br>        let pos = 0, <br>            lightObjArr = [<br>                {<br>                    color: &#39;green&#39;,<br>                    time: 3000<br>                }, {<br>                    color: &#39;yellow&#39;,<br>                    time: 1000<br>                }, {<br>                    color: &#39;red&#39;,<br>                    time: 2000<br>                }<br>            ]<br>        <br>        function sleep(duration) {<br>            return new Promise( function (resolve, reject) {<br>                setTimeout(resolve, duration)<br>            })<br>        }<br>        function colorFn (color) {<br>            console.log(color)<br>        }<br><br>        return function light({color=&#39;green&#39;, time=3000}={}) {<br>            colorFn(color)<br>            sleep(time).then(function() {<br>                pos += 1<br>                return light(lightObjArr[pos % 3])<br>            })<br>        }<br>    }())<br>transLamp()<br>","like_count":0},{"had_liked":false,"id":73545,"user_name":"kovar","can_delete":false,"product_type":"c1","uid":1384697,"ip_address":"","ucode":"A9A6C929FF4BCC","user_header":"","comment_is_top":false,"comment_ctime":1551922767,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1551922767","product_id":100023201,"comment_content":"那么animation frame的更新是在哪个时间点呢?我遇到过setTimeout和requestAnimationFrame执行顺序问题","like_count":0},{"had_liked":false,"id":73360,"user_name":"[已重置]","can_delete":false,"product_type":"c1","uid":1380263,"ip_address":"","ucode":"7CE91D63AD9481","user_header":"https://static001.geekbang.org/account/avatar/00/15/0f/a7/783e4f88.jpg","comment_is_top":false,"comment_ctime":1551867806,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1551867806","product_id":100023201,"comment_content":"https:&#47;&#47;www.jianshu.com&#47;p&#47;12b9f73c5a4f 推荐一下这个写的比较详细","like_count":0},{"had_liked":false,"id":73213,"user_name":"uNeedSweetDouble","can_delete":false,"product_type":"c1","uid":1389442,"ip_address":"","ucode":"A2258F4AAD6924","user_header":"https://static001.geekbang.org/account/avatar/00/15/33/82/5bb2bacc.jpg","comment_is_top":false,"comment_ctime":1551841227,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1551841227","product_id":100023201,"comment_content":"老师, 怎么判断是有几个宏任务呢","like_count":0},{"had_liked":false,"id":72969,"user_name":"周明杰","can_delete":false,"product_type":"c1","uid":1229939,"ip_address":"","ucode":"EBD72A6D9EA4A9","user_header":"https://static001.geekbang.org/account/avatar/00/12/c4/73/cd06e186.jpg","comment_is_top":false,"comment_ctime":1551767453,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1551767453","product_id":100023201,"comment_content":"function changeColor(color, times) {<br>  return new Promise(function(resolve, reject){<br>    setTimeout(function(){<br>      document.getElementsByTagName(&#39;div&#39;)[0].style.backgroundColor = color;<br>      resolve();<br>    },times)<br>  })<br>}<br>async function loop() {<br>  while(true){<br>    await changeColor(&#39;green&#39;, 3000);<br>    await changeColor(&#39;yellow&#39;, 2000);<br>    await changeColor(&#39;red&#39;, 1000);<br>  }<br>}<br>loop();<br>","like_count":0},{"had_liked":false,"id":72779,"user_name":"梦若晨曦","can_delete":false,"product_type":"c1","uid":1298887,"ip_address":"","ucode":"046F4768C8EE1E","user_header":"https://static001.geekbang.org/account/avatar/00/13/d1/c7/68ba1061.jpg","comment_is_top":false,"comment_ctime":1551715846,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1551715846","product_id":100023201,"comment_content":"        const node = document.getElementById(&#39;light&#39;)<br>        function changeBgCol(color, duration) {<br>            return new Promise((resolve, reject) =&gt; {<br>                node.style.background = color;<br>                setTimeout(resolve, duration)<br>            })<br>        }<br>        async function main() {<br>            while(true) {<br>                await changeBgCol(&#39;#009688&#39;, 3000)<br>                await changeBgCol(&#39;#ffeb3b&#39;, 1000)<br>                await changeBgCol(&#39;#f44336&#39;, 3000)<br>            }<br>        }<br>        main()","like_count":0},{"had_liked":false,"id":72233,"user_name":"TY","can_delete":false,"product_type":"c1","uid":1042575,"ip_address":"","ucode":"DCCD035EAF5686","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/nD10dsXDZ07WyBbqheDtflyxqaR7QsuznhEgtTia0Pticf5fSjQhgSKUUTbibBozY5h2QAD0oYoBCNbvLGpHVeTow/132","comment_is_top":false,"comment_ctime":1551537871,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1551537871","product_id":100023201,"comment_content":"await 相当于写一个 then 然后把它底下所有的代码全部包进去, 然后把原先嵌套的 catch 给全部平级了, 然而 await 只能在 async 的 function 里面这一特性导致总会有一个 then 在最外面或者让最外面调用的 async 函数不返回值也处理好异常(让 resolve 和 reject 变得没有意义), 找了点东西看和自己验证了一下(一个今日头条的面试题), 不同的 chrome 版本输出的顺序还不一样<br><br>老实说, 虽然想不出来什么好的办法, 但是总觉得现在这个 await 解决方案带来的这个任务队列, 跟 go 里面的 defer 有点像, 我个人觉得它们带来的问题比它们想要解决的问题还要多","like_count":0},{"had_liked":false,"id":72176,"user_name":"TY","can_delete":false,"product_type":"c1","uid":1042575,"ip_address":"","ucode":"DCCD035EAF5686","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/nD10dsXDZ07WyBbqheDtflyxqaR7QsuznhEgtTia0Pticf5fSjQhgSKUUTbibBozY5h2QAD0oYoBCNbvLGpHVeTow/132","comment_is_top":false,"comment_ctime":1551531565,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1551531565","product_id":100023201,"comment_content":"对于一个非 js 的 coder 对这篇理解起来好费劲, 不是说加了 async 的 function 返回的是隐式的 Promise 么, 方法的返回会被封装成 resolve, 理解了半天, 我还是觉得在 sleep 里面的 setTimeout 那里没办法用 async, 必须用 Promise, 结果导致两种方式你中有我我中有你, 思维切换了好多次, 不是很懂这个特性的意义在哪, 貌似在 js 圈是一个很厉害的东西","like_count":0},{"had_liked":false,"id":72069,"user_name":"Vincent W","can_delete":false,"product_type":"c1","uid":1015794,"ip_address":"","ucode":"F4F839466FDB76","user_header":"https://static001.geekbang.org/account/avatar/00/0f/7f/f2/a9b71207.jpg","comment_is_top":false,"comment_ctime":1551512818,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1551512818","product_id":100023201,"comment_content":"async function fn1() {<br>    console.log(1)<br>    await console.log(2)<br>    console.log(3)<br>}<br><br>fn1()<br><br>new Promise((resolve, reject) =&gt; {<br>    console.log(1)<br>    resolve()<br>}).then(data =&gt;  console.log(4))<br><br>老师 await 后面的 的 console.log(3) 和 then 中的console.log(4) 执行顺序该怎么分析","like_count":0},{"had_liked":false,"id":71785,"user_name":"风吹一个大耳东","can_delete":false,"product_type":"c1","uid":1393383,"ip_address":"","ucode":"53918AD171F5C5","user_header":"https://static001.geekbang.org/account/avatar/00/15/42/e7/e5afadf7.jpg","comment_is_top":false,"comment_ctime":1551432203,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1551432203","product_id":100023201,"comment_content":"老师说我只跑一次，现在加上循环<br>function light(time,color) {<br>\treturn new Promise(function(resolve,reject) {<br>\t\tsetTimeout(()=&gt;{<br>\t\t\tresolve();console.log(color);<br>\t\t},time)<br>\t})<br>}<br>async function run() {<br>\tawait light(3000, &#39;green&#39;)<br>\tawait light(1000, &#39;red&#39;)<br>\tawait light(2000, &#39;yellow&#39;)<br>}<br><br>while(true) {<br>\tawait run()<br>}","like_count":0},{"had_liked":false,"id":70705,"user_name":"MarlboroKay","can_delete":false,"product_type":"c1","uid":1099304,"ip_address":"","ucode":"3F6B5861795A61","user_header":"https://static001.geekbang.org/account/avatar/00/10/c6/28/d6f49ec2.jpg","comment_is_top":false,"comment_ctime":1551167432,"is_pvip":false,"replies":[{"id":"25920","content":"用了 await 就不要then了啊。","user_name":"作者回复","user_name_real":"winter","uid":"1268524","ctime":1551432261,"ip_address":"","comment_id":70705,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1551167432","product_id":100023201,"comment_content":"function main(duration,color){<br>\t\t\treturn new Promise(function(resolve,reject){<br>\t\t\t\tsetTimeout(resolve,duration)<br>\t\t\t});<br>\t\t}<br>\t\tfunction changeColor(color){<br>\t\t\tvar lamp = document.getElementById(&#39;#lapm&#39;);<br>\t\t\tlapm.style.backgroundColor = color;<br>\t\t}<br><br>\t\tasync function change(){<br>\t\t\tawait main(3000).then(()=&gt;changeColor(&#39;yellow&#39;));<br>\t\t\tawait main(1000).then(()=&gt;changeColor(&#39;red&#39;));<br>\t\t\tawait main(2000).then(()=&gt;changeColor(&#39;green&#39;));<br>\t\t\treturn change();<br>\t\t}<br>\t\tchange();<br>PS:执行耗时1秒的Promis 代码段第5行：应该是 r1.then(...)","like_count":0,"discussions":[{"author":{"id":1268524,"avatar":"https://static001.geekbang.org/account/avatar/00/13/5b/2c/12bfd3cd.jpg","nickname":"winter","note":"","ucode":"2B068EDEAFEB56","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440785,"discussion_content":"用了 await 就不要then了啊。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551432261,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":70297,"user_name":"周小成","can_delete":false,"product_type":"c1","uid":1229260,"ip_address":"","ucode":"5B47835DE09E1A","user_header":"https://static001.geekbang.org/account/avatar/00/12/c1/cc/6b6bbd41.jpg","comment_is_top":false,"comment_ctime":1551066259,"is_pvip":false,"replies":[{"id":"25077","content":"谢谢你的提示，我们问问老师哈","user_name":"编辑回复","user_name_real":"马越","uid":"1003953","ctime":1551068516,"ip_address":"","comment_id":70297,"utype":2}],"discussion_count":1,"race_medal":0,"score":"1551066259","product_id":100023201,"comment_content":"讲的很通俗易懂，认识更清晰了。执行耗时1秒的Promise那里的代码有些小问题哦，r.then应该改成r1.then","like_count":0,"discussions":[{"author":{"id":1003953,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/51/b1/7d6879dc.jpg","nickname":"未设置","note":"","ucode":"9DFC368CA29EDC","race_medal":0,"user_type":4,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440551,"discussion_content":"谢谢你的提示，我们问问老师哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551068516,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":4}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":70270,"user_name":"风吹一个大耳东","can_delete":false,"product_type":"c1","uid":1393383,"ip_address":"","ucode":"53918AD171F5C5","user_header":"https://static001.geekbang.org/account/avatar/00/15/42/e7/e5afadf7.jpg","comment_is_top":false,"comment_ctime":1551062023,"is_pvip":false,"replies":[{"id":"25915","content":"你这个只有一遍啊  红绿灯这样可不行","user_name":"作者回复","user_name_real":"winter","uid":"1268524","ctime":1551431715,"ip_address":"","comment_id":70270,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1551062023","product_id":100023201,"comment_content":"function light(time, color) {<br>\treturn new Promise(function(resolve,reject) {<br>\t\tsetTimeout(()=&gt; {<br>\t\t\tresolve();<br>\t\t\tconsole.log(color)<br>\t\t}, time)<br>    })<br>}<br><br>async function run() {<br>\tawait light(3000, &#39;green&#39;)<br>\tawait light(1000, &#39;red&#39;)<br>\tawait light(2000, &#39;yellow&#39;)<br>}<br><br>run()","like_count":0,"discussions":[{"author":{"id":1268524,"avatar":"https://static001.geekbang.org/account/avatar/00/13/5b/2c/12bfd3cd.jpg","nickname":"winter","note":"","ucode":"2B068EDEAFEB56","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440534,"discussion_content":"你这个只有一遍啊  红绿灯这样可不行","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551431715,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":70090,"user_name":"xlm","can_delete":false,"product_type":"c1","uid":1382463,"ip_address":"","ucode":"DF8CA3B2F676D8","user_header":"https://static001.geekbang.org/account/avatar/00/15/18/3f/93e02812.jpg","comment_is_top":false,"comment_ctime":1550993358,"is_pvip":false,"replies":[{"id":"25848","content":"generator 和 async 是使用了一组共同基础设施的两种完全不同作用的函数。","user_name":"作者回复","user_name_real":"winter","uid":"1268524","ctime":1551425781,"ip_address":"","comment_id":70090,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1550993358","product_id":100023201,"comment_content":"async&#47;await的实现原理是Generator +Promise的语法糖😳 ？","like_count":0,"discussions":[{"author":{"id":1268524,"avatar":"https://static001.geekbang.org/account/avatar/00/13/5b/2c/12bfd3cd.jpg","nickname":"winter","note":"","ucode":"2B068EDEAFEB56","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440434,"discussion_content":"generator 和 async 是使用了一组共同基础设施的两种完全不同作用的函数。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551425781,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":70088,"user_name":"AICC","can_delete":false,"product_type":"c1","uid":1020746,"ip_address":"","ucode":"C1D18B1E8B2DCE","user_header":"https://static001.geekbang.org/account/avatar/00/0f/93/4a/de82f373.jpg","comment_is_top":false,"comment_ctime":1550992790,"is_pvip":false,"replies":[{"id":"25847","content":"哈哈 这个写错了<br><br>前面都很好，可惜调用的时候出了错。","user_name":"作者回复","user_name_real":"winter","uid":"1268524","ctime":1551425709,"ip_address":"","comment_id":70088,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1550992790","product_id":100023201,"comment_content":"function sleep(duration) {<br>  return new Promise(function(resolve, reject) {<br>      setTimeout(resolve,duration);<br>  })<br>}<br>async function foo(duration,name){<br>  console.log(name)<br>  await sleep(duration)<br>}<br>async function foo2(){<br>  await foo(3000,&quot;绿&quot;);<br>  await foo(1000,&quot;黄&quot;);<br>  await foo(2000,&quot;红&quot;);<br>}<br><br>while(true) {<br>  foo2()<br>}","like_count":0,"discussions":[{"author":{"id":1268524,"avatar":"https://static001.geekbang.org/account/avatar/00/13/5b/2c/12bfd3cd.jpg","nickname":"winter","note":"","ucode":"2B068EDEAFEB56","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440433,"discussion_content":"哈哈 这个写错了\n\n前面都很好，可惜调用的时候出了错。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551425709,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}