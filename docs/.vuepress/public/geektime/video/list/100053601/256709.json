{"id":256709,"title":"16 | Kafka的动态重平衡是如何工作的？（下）","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/geektime-distributed\">https://gitee.com/geektime-geekbang/geektime-distributed</a></p>","comments":[{"had_liked":false,"id":261860,"user_name":"杰哥长得帅","can_delete":false,"product_type":"c3","uid":1241993,"ip_address":"","ucode":"5A7FD1794F62D7","user_header":"https://static001.geekbang.org/account/avatar/00/12/f3/89/fcfecb46.jpg","comment_is_top":false,"comment_ctime":1605540830,"is_pvip":false,"replies":[{"id":95195,"content":"重平衡只要发生，不管多少次，所有消费者都要停下来，否则状态会乱。就像一堆人在干活，突然领导说大家都停下来，要重新分配任务，这个时候所有人都要停下来，因为他重新分配任务的时候，如果有人还在干，那么任务量这个状态就会一直变。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1605713603,"ip_address":"","comment_id":261860,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100053601,"comment_content":"连续三次被分配队列相同，才开启新的消费，这边是否表述有误？如果重平衡就一两次，那岂不是所有消费者就都停下来了？能否请大佬再详述一下流程？","like_count":3,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":509644,"discussion_content":"重平衡只要发生，不管多少次，所有消费者都要停下来，否则状态会乱。就像一堆人在干活，突然领导说大家都停下来，要重新分配任务，这个时候所有人都要停下来，因为他重新分配任务的时候，如果有人还在干，那么任务量这个状态就会一直变。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605713603,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1241993,"avatar":"https://static001.geekbang.org/account/avatar/00/12/f3/89/fcfecb46.jpg","nickname":"杰哥长得帅","note":"","ucode":"5A7FD1794F62D7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":327083,"discussion_content":"那 连续三次被分配队列相同，才开启新的消费 这句话怎么解释呢？消费者重平衡以后还要等一会看看还有没有重平衡吗？要等三次重平衡，而且这三次被分配队列要一样，这会不会太苛刻了……","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605746707,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":232138,"user_name":"tingye","can_delete":false,"product_type":"c3","uid":1391463,"ip_address":"","ucode":"54F7A44066DF5D","user_header":"https://static001.geekbang.org/account/avatar/00/15/3b/67/c188d3bc.jpg","comment_is_top":false,"comment_ctime":1593868482,"is_pvip":false,"replies":[{"id":85865,"content":"为了防止抖动啊。\n\n你想发布的时候，一台一台消费者滚动发布，如果不等一等，等到消费者数量稳定，就马上开始消费的话，可能一会儿消费者又加入，于是现有消费者又得停下重来(STOP THE WORLD)。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1594048914,"ip_address":"","comment_id":232138,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100053601,"comment_content":"不太明白为什么消费端要连续三次被分配队列相同，才开启新的消费？假如一个新消费端上线，触发一次重平衡，被分配了一个队列，却不消费，要等三次重平衡分配相同队列才消费，这样做是基于什么考虑呢？","like_count":3,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":500530,"discussion_content":"为了防止抖动啊。\n\n你想发布的时候，一台一台消费者滚动发布，如果不等一等，等到消费者数量稳定，就马上开始消费的话，可能一会儿消费者又加入，于是现有消费者又得停下重来(STOP THE WORLD)。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594048914,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1046552,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f8/18/3e5e7db3.jpg","nickname":"Lorgine","note":"","ucode":"DB64E85327A252","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":288874,"discussion_content":"有几个考虑，第一是一般启动的时候，会几个实例连着启动的，实际上每次启动都会触发一次重平衡操作，如果没次重平衡立马消费，会出现反复的启动与停止。第二为了保持一个稳定的状态，才开始消费。还有一个就是尽量减少重复消费。重平衡可能会出现重复消费。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1593919417,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":233272,"user_name":"小祺","can_delete":false,"product_type":"c3","uid":1193548,"ip_address":"","ucode":"2819BCA9E71C9F","user_header":"https://static001.geekbang.org/account/avatar/00/12/36/4c/46c43cce.jpg","comment_is_top":false,"comment_ctime":1594276525,"is_pvip":false,"replies":[{"id":86268,"content":"这个长连接的底层，还是依赖对DB表记录的轮训polling来实现的，也就是说实际状态还是存在DB中。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1594395739,"ip_address":"","comment_id":233272,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100053601,"comment_content":"既然消费者跟broker之间有长连接，为什么要通过数据库来触发动态充平衡呢？ 长连接建立和断开的时候触发可以吗？","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":500967,"discussion_content":"这个长连接的底层，还是依赖对DB表记录的轮训polling来实现的，也就是说实际状态还是存在DB中。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594395739,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1046552,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f8/18/3e5e7db3.jpg","nickname":"Lorgine","note":"","ucode":"DB64E85327A252","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":290582,"discussion_content":"因为需要看数据库来操作最终一致性，broker是无状态的，只是负责同步结果。","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1594540519,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}