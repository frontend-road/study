{"id":224784,"title":"17 | åˆ«ä»¥ä¸ºâ€œè‡ªåŠ¨æŒ¡â€å°±ä¸å¯èƒ½å‡ºç°OOM","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯æœ±æ™”ã€‚ä»Šå¤©ï¼Œæˆ‘è¦å’Œä½ åˆ†äº«çš„ä¸»é¢˜æ˜¯ï¼Œåˆ«ä»¥ä¸ºâ€œè‡ªåŠ¨æŒ¡â€å°±ä¸å¯èƒ½å‡ºç°OOMã€‚</p><p>è¿™é‡Œçš„â€œè‡ªåŠ¨æŒ¡â€ï¼Œæ˜¯æˆ‘å¯¹Javaè‡ªåŠ¨åƒåœ¾æ”¶é›†å™¨çš„æˆç§°ã€‚çš„ç¡®ï¼Œç»è¿‡è¿™ä¹ˆå¤šå¹´çš„å‘å±•ï¼ŒJavaçš„åƒåœ¾æ”¶é›†å™¨å·²ç»éå¸¸æˆç†Ÿäº†ã€‚æœ‰äº†è‡ªåŠ¨åƒåœ¾æ”¶é›†å™¨ï¼Œç»å¤§å¤šæ•°æƒ…å†µä¸‹æˆ‘ä»¬å†™ç¨‹åºæ—¶å¯ä»¥ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘ï¼Œæ— éœ€è¿‡å¤šè€ƒè™‘å¯¹è±¡çš„åˆ†é…å’Œé‡Šæ”¾ï¼Œä¸€èˆ¬ä¹Ÿä¸ä¼šå‡ºç°OOMã€‚</p><p>ä½†ï¼Œå†…å­˜ç©ºé—´å§‹ç»ˆæ˜¯æœ‰é™çš„ï¼ŒJavaçš„å‡ å¤§å†…å­˜åŒºåŸŸå§‹ç»ˆéƒ½æœ‰OOMçš„å¯èƒ½ã€‚ç›¸åº”åœ°ï¼ŒJavaç¨‹åºçš„å¸¸è§OOMç±»å‹ï¼Œå¯ä»¥åˆ†ä¸ºå †å†…å­˜çš„OOMã€æ ˆOOMã€å…ƒç©ºé—´OOMã€ç›´æ¥å†…å­˜OOMç­‰ã€‚å‡ ä¹æ¯ä¸€ç§OOMéƒ½å¯ä»¥ä½¿ç”¨å‡ è¡Œä»£ç æ¨¡æ‹Ÿï¼Œå¸‚é¢ä¸Šä¹Ÿæœ‰å¾ˆå¤šèµ„æ–™åœ¨å †ã€å…ƒç©ºé—´ã€ç›´æ¥å†…å­˜ä¸­åˆ†é…è¶…å¤§å¯¹è±¡æˆ–æ˜¯æ— é™åˆ†é…å¯¹è±¡ï¼Œå°è¯•åˆ›å»ºæ— é™ä¸ªçº¿ç¨‹æˆ–æ˜¯è¿›è¡Œæ–¹æ³•æ— é™é€’å½’è°ƒç”¨æ¥æ¨¡æ‹Ÿã€‚</p><p>ä½†å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬çš„ä¸šåŠ¡ä»£ç å¹¶ä¸ä¼šè¿™ä¹ˆå¹²ã€‚æ‰€ä»¥ä»Šå¤©ï¼Œæˆ‘ä¼šä»å†…å­˜åˆ†é…æ„è¯†çš„è§’åº¦é€šè¿‡ä¸€äº›æ¡ˆä¾‹ï¼Œå±•ç¤ºä¸šåŠ¡ä»£ç ä¸­å¯èƒ½å¯¼è‡´OOMçš„ä¸€äº›å‘ã€‚è¿™äº›å‘ï¼Œæˆ–æ˜¯å› ä¸ºæˆ‘ä»¬æ„è¯†ä¸åˆ°å¯¹è±¡çš„åˆ†é…ï¼Œæˆ–æ˜¯å› ä¸ºä¸åˆç†çš„èµ„æºä½¿ç”¨ï¼Œæˆ–æ˜¯æ²¡æœ‰æ§åˆ¶ç¼“å­˜çš„æ•°æ®é‡ç­‰ã€‚</p><p>åœ¨<a href=\"https://time.geekbang.org/column/article/210337\">ç¬¬3è®²</a>ä»‹ç»çº¿ç¨‹æ—¶ï¼Œæˆ‘ä»¬å·²ç»çœ‹åˆ°äº†ä¸¤ç§OOMçš„æƒ…å†µï¼Œä¸€æ˜¯å› ä¸ºä½¿ç”¨æ— ç•Œé˜Ÿåˆ—å¯¼è‡´çš„å †OOMï¼ŒäºŒæ˜¯å› ä¸ºä½¿ç”¨æ²¡æœ‰æœ€å¤§çº¿ç¨‹æ•°é‡é™åˆ¶çš„çº¿ç¨‹æ± å¯¼è‡´æ— é™åˆ›å»ºçº¿ç¨‹çš„OOMã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†ä¸€èµ·çœ‹çœ‹ï¼Œåœ¨å†™ä¸šåŠ¡ä»£ç çš„è¿‡ç¨‹ä¸­ï¼Œè¿˜æœ‰å“ªäº›æ„è¯†ä¸Šçš„ç–å¿½å¯èƒ½ä¼šå¯¼è‡´OOMã€‚</p><!-- [[[read_end]]] --><h2>å¤ªå¤šä»½ç›¸åŒçš„å¯¹è±¡å¯¼è‡´OOM</h2><p>æˆ‘è¦åˆ†äº«çš„ç¬¬ä¸€ä¸ªæ¡ˆä¾‹æ˜¯è¿™æ ·çš„ã€‚æœ‰ä¸€ä¸ªé¡¹ç›®åœ¨å†…å­˜ä¸­ç¼“å­˜äº†å…¨é‡ç”¨æˆ·æ•°æ®ï¼Œåœ¨æœç´¢ç”¨æˆ·æ—¶å¯ä»¥ç›´æ¥ä»ç¼“å­˜ä¸­è¿”å›ç”¨æˆ·ä¿¡æ¯ã€‚ç°åœ¨ä¸ºäº†æ”¹å–„ç”¨æˆ·ä½“éªŒï¼Œéœ€è¦å®ç°è¾“å…¥éƒ¨åˆ†ç”¨æˆ·åè‡ªåŠ¨åœ¨ä¸‹æ‹‰æ¡†æç¤ºè¡¥å…¨ç”¨æˆ·åçš„åŠŸèƒ½ï¼ˆä¹Ÿå°±æ˜¯æ‰€è°“çš„è‡ªåŠ¨å®ŒæˆåŠŸèƒ½ï¼‰ã€‚</p><p>åœ¨<a href=\"https://time.geekbang.org/column/article/216778\">ç¬¬10è®²</a>ä»‹ç»é›†åˆæ—¶ï¼Œæˆ‘æåˆ°å¯¹äºè¿™ç§å¿«é€Ÿæ£€ç´¢çš„éœ€æ±‚ï¼Œæœ€å¥½ä½¿ç”¨Mapæ¥å®ç°ï¼Œä¼šæ¯”ç›´æ¥ä»Listæœç´¢å¿«å¾—å¤šã€‚</p><p>ä¸ºå®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªHashMapæ¥å­˜æ”¾è¿™äº›ç”¨æˆ·æ•°æ®ï¼ŒKeyæ˜¯ç”¨æˆ·å§“åç´¢å¼•ï¼ŒValueæ˜¯ç´¢å¼•ä¸‹å¯¹åº”çš„ç”¨æˆ·åˆ—è¡¨ã€‚ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œå¦‚æœæœ‰ä¸¤ä¸ªç”¨æˆ·aaå’Œabï¼Œé‚£ä¹ˆKeyå°±æœ‰ä¸‰ä¸ªï¼Œåˆ†åˆ«æ˜¯aã€aaå’Œabã€‚ç”¨æˆ·è¾“å…¥å­—æ¯aæ—¶ï¼Œå°±èƒ½ä»Valueè¿™ä¸ªListä¸­æ‹¿åˆ°æ‰€æœ‰å­—æ¯aå¼€å¤´çš„ç”¨æˆ·ï¼Œå³aaå’Œabã€‚</p><p>åœ¨ä»£ç ä¸­ï¼Œåœ¨æ•°æ®åº“ä¸­å­˜å…¥1ä¸‡ä¸ªæµ‹è¯•ç”¨æˆ·ï¼Œç”¨æˆ·åç”±a~jè¿™6ä¸ªå­—æ¯éšæœºæ„æˆï¼Œç„¶åæŠŠæ¯ä¸€ä¸ªç”¨æˆ·åçš„å‰1ä¸ªå­—æ¯ã€å‰2ä¸ªå­—æ¯ä»¥æ­¤ç±»æ¨ç›´åˆ°å®Œæ•´ç”¨æˆ·åä½œä¸ºKeyå­˜å…¥ç¼“å­˜ä¸­ï¼Œç¼“å­˜çš„Valueæ˜¯ä¸€ä¸ªUserDTOçš„Listï¼Œå­˜æ”¾çš„æ˜¯æ‰€æœ‰ç›¸åŒçš„ç”¨æˆ·åç´¢å¼•ï¼Œä»¥åŠå¯¹åº”çš„ç”¨æˆ·ä¿¡æ¯ï¼š</p><pre><code>//è‡ªåŠ¨å®Œæˆçš„ç´¢å¼•ï¼ŒKeyæ˜¯ç”¨æˆ·è¾“å…¥çš„éƒ¨åˆ†ç”¨æˆ·åï¼ŒValueæ˜¯å¯¹åº”çš„ç”¨æˆ·æ•°æ®\nprivate ConcurrentHashMap&lt;String, List&lt;UserDTO&gt;&gt; autoCompleteIndex = new ConcurrentHashMap&lt;&gt;();\n\n@Autowired\nprivate UserRepository userRepository;\n\n@PostConstruct\npublic void wrong() {\n    //å…ˆä¿å­˜10000ä¸ªç”¨æˆ·åéšæœºçš„ç”¨æˆ·åˆ°æ•°æ®åº“ä¸­\n    userRepository.saveAll(LongStream.rangeClosed(1, 10000).mapToObj(i -&gt; new UserEntity(i, randomName())).collect(Collectors.toList()));\n\n    //ä»æ•°æ®åº“åŠ è½½æ‰€æœ‰ç”¨æˆ·\n    userRepository.findAll().forEach(userEntity -&gt; {\n        int len = userEntity.getName().length();\n        //å¯¹äºæ¯ä¸€ä¸ªç”¨æˆ·ï¼Œå¯¹å…¶ç”¨æˆ·åçš„å‰Nä½è¿›è¡Œç´¢å¼•ï¼ŒNå¯èƒ½æ˜¯1~6å…­ç§é•¿åº¦ç±»å‹\n        for (int i = 0; i &lt; len; i++) {\n            String key = userEntity.getName().substring(0, i + 1);\n            autoCompleteIndex.computeIfAbsent(key, s -&gt; new ArrayList&lt;&gt;())\n                    .add(new UserDTO(userEntity.getName()));\n        }\n    });\n    log.info(&quot;autoCompleteIndex size:{} count:{}&quot;, autoCompleteIndex.size(),\n            autoCompleteIndex.entrySet().stream().map(item -&gt; item.getValue().size()).reduce(0, Integer::sum));\n}\n</code></pre><p>å¯¹äºæ¯ä¸€ä¸ªç”¨æˆ·å¯¹è±¡UserDTOï¼Œé™¤äº†æœ‰ç”¨æˆ·åï¼Œæˆ‘ä»¬è¿˜åŠ å…¥äº†10Kå·¦å³çš„æ•°æ®æ¨¡æ‹Ÿå…¶ç”¨æˆ·ä¿¡æ¯ï¼š</p><pre><code>@Data\npublic class UserDTO {\n    private String name;\n    @EqualsAndHashCode.Exclude\n    private String payload;\n\n    public UserDTO(String name) {\n        this.name = name;\n        this.payload = IntStream.rangeClosed(1, 10_000)\n                .mapToObj(__ -&gt; &quot;a&quot;)\n                .collect(Collectors.joining(&quot;&quot;));\n    }\n}\n</code></pre><p>è¿è¡Œç¨‹åºåï¼Œæ—¥å¿—è¾“å‡ºå¦‚ä¸‹ï¼š</p><pre><code>[11:11:22.982] [main] [INFO ] [.t.c.o.d.UsernameAutoCompleteService:37  ] - autoCompleteIndex size:26838 count:60000\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œä¸€å…±æœ‰26838ä¸ªç´¢å¼•ï¼ˆä¹Ÿå°±æ˜¯æ‰€æœ‰ç”¨æˆ·åçš„1ä½ã€2ä½ä¸€ç›´åˆ°6ä½æœ‰26838ä¸ªç»„åˆï¼‰ï¼ŒHashMapçš„Valueï¼Œä¹Ÿå°±æ˜¯List<userdto>ä¸€å…±æœ‰1ä¸‡ä¸ªç”¨æˆ·*6=6ä¸‡ä¸ªUserDTOå¯¹è±¡ã€‚</userdto></p><p>ä½¿ç”¨å†…å­˜åˆ†æå·¥å…·MATæ‰“å¼€å †dumpå‘ç°ï¼Œ6ä¸‡ä¸ªUserDTOå ç”¨äº†çº¦1.2GBçš„å†…å­˜ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/d1/d2/d17fdb7d5123566312f7d3888ef82bd2.png?wh=1058*296\" alt=\"\"></p><p>çœ‹åˆ°è¿™é‡Œå‘ç°ï¼Œ<strong>è™½ç„¶çœŸæ­£çš„ç”¨æˆ·åªæœ‰1ä¸‡ä¸ªï¼Œä½†å› ä¸ºä½¿ç”¨éƒ¨åˆ†ç”¨æˆ·åä½œä¸ºç´¢å¼•çš„Keyï¼Œå¯¼è‡´ç¼“å­˜çš„Keyæœ‰26838ä¸ªï¼Œç¼“å­˜çš„ç”¨æˆ·ä¿¡æ¯å¤šè¾¾6ä¸‡ä¸ª</strong>ã€‚å¦‚æœæˆ‘ä»¬çš„ç”¨æˆ·åä¸æ˜¯6ä½è€Œæ˜¯10ä½ã€20ä½ï¼Œé‚£ä¹ˆç¼“å­˜çš„ç”¨æˆ·ä¿¡æ¯å¯èƒ½å°±æ˜¯10ä¸‡ã€20ä¸‡ä¸ªï¼Œå¿…ç„¶ä¼šäº§ç”Ÿå †OOMã€‚</p><p>å°è¯•è°ƒå¤§ç”¨æˆ·åçš„æœ€å¤§é•¿åº¦ï¼Œé‡å¯ç¨‹åºå¯ä»¥çœ‹åˆ°ç±»ä¼¼å¦‚ä¸‹çš„é”™è¯¯ï¼š</p><pre><code>[17:30:29.858] [main] [ERROR] [ringframework.boot.SpringApplication:826 ] - Application run failed\norg.springframework.beans.factory.BeanCreationException: Error creating bean with name 'usernameAutoCompleteService': Invocation of init method failed; nested exception is java.lang.OutOfMemoryError: Java heap space\n</code></pre><p>æˆ‘ä»¬å¯èƒ½ä¼šæƒ³å½“ç„¶åœ°è®¤ä¸ºï¼Œæ•°æ®åº“ä¸­æœ‰1ä¸‡ä¸ªç”¨æˆ·ï¼Œå†…å­˜ä¸­ä¹Ÿåº”è¯¥åªæœ‰1ä¸‡ä¸ªUserDTOå¯¹è±¡ï¼Œä½†å®ç°çš„æ—¶å€™æ¯æ¬¡éƒ½ä¼šnewå‡ºæ¥UserDTOåŠ å…¥ç¼“å­˜ï¼Œå½“ç„¶åœ¨å†…å­˜ä¸­éƒ½æ˜¯æ–°å¯¹è±¡ã€‚åœ¨å®é™…çš„é¡¹ç›®ä¸­ï¼Œç”¨æˆ·ä¿¡æ¯çš„ç¼“å­˜å¯èƒ½æ˜¯éšç€ç”¨æˆ·è¾“å…¥å¢é‡ç¼“å­˜çš„ï¼Œè€Œä¸æ˜¯åƒè¿™ä¸ªæ¡ˆä¾‹ä¸€æ ·åœ¨ç¨‹åºåˆå§‹åŒ–çš„æ—¶å€™å…¨é‡ç¼“å­˜ï¼Œæ‰€ä»¥é—®é¢˜æš´éœ²å¾—ä¸ä¼šè¿™ä¹ˆæ—©ã€‚</p><p>çŸ¥é“åŸå› åï¼Œè§£å†³èµ·æ¥å°±æ¯”è¾ƒç®€å•äº†ã€‚æŠŠæ‰€æœ‰UserDTOå…ˆåŠ å…¥HashSetä¸­ï¼Œå› ä¸ºUserDTOä»¥nameæ¥æ ‡è¯†å”¯ä¸€æ€§ï¼Œæ‰€ä»¥é‡å¤ç”¨æˆ·åä¼šè¢«è¿‡æ»¤æ‰ï¼Œæœ€ç»ˆåŠ å…¥HashSetçš„UserDTOå°±ä¸è¶³1ä¸‡ä¸ªã€‚</p><p>æœ‰äº†HashSetæ¥ç¼“å­˜æ‰€æœ‰å¯èƒ½çš„UserDTOä¿¡æ¯ï¼Œæˆ‘ä»¬å†æ„å»ºè‡ªåŠ¨å®Œæˆç´¢å¼•autoCompleteIndexè¿™ä¸ªHashMapæ—¶ï¼Œå°±å¯ä»¥ç›´æ¥ä»HashSetè·å–æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯æ¥æ„å»ºäº†ã€‚è¿™æ ·ä¸€æ¥ï¼ŒåŒä¸€ä¸ªç”¨æˆ·åå‰ç¼€çš„ä¸åŒç»„åˆï¼ˆæ¯”å¦‚ç”¨æˆ·åä¸ºabcçš„ç”¨æˆ·ï¼Œaã€abå’Œabcä¸‰ä¸ªKeyï¼‰å…³è”åˆ°UserDTOæ˜¯åŒä¸€ä»½ï¼š</p><pre><code>@PostConstruct\npublic void right() {\n    ...\n\n    HashSet&lt;UserDTO&gt; cache = userRepository.findAll().stream()\n            .map(item -&gt; new UserDTO(item.getName()))\n            .collect(Collectors.toCollection(HashSet::new));\n\n\n    cache.stream().forEach(userDTO -&gt; {\n        int len = userDTO.getName().length();\n        for (int i = 0; i &lt; len; i++) {\n            String key = userDTO.getName().substring(0, i + 1);\n            autoCompleteIndex.computeIfAbsent(key, s -&gt; new ArrayList&lt;&gt;())\n                    .add(userDTO);\n        }\n    });\n    ...\n}\n</code></pre><p>å†æ¬¡åˆ†æå †å†…å­˜ï¼Œå¯ä»¥çœ‹åˆ°UserDTOåªæœ‰9945ä»½ï¼Œæ€»å…±å ç”¨çš„å†…å­˜ä¸åˆ°200Mã€‚è¿™æ‰æ˜¯æˆ‘ä»¬çœŸæ­£æƒ³è¦çš„ç»“æœã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/34/52/34a0fc90ac8be7a20cb295c14f06d752.png?wh=1096*280\" alt=\"\"></p><p>ä¿®å¤åçš„ç¨‹åºï¼Œä¸ä»…ç›¸åŒçš„UserDTOåªæœ‰ä¸€ä»½ï¼Œæ€»å‰¯æœ¬æ•°å˜ä¸ºäº†åŸæ¥çš„å…­åˆ†ä¹‹ä¸€ï¼›è€Œä¸”å› ä¸ºHashSetçš„å»é‡ç‰¹æ€§ï¼ŒåŒé‡èŠ‚çº¦äº†å†…å­˜ã€‚</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬è™½ç„¶æ¸…æ¥šæ•°æ®æ€»é‡ï¼Œä½†å´å¿½ç•¥äº†æ¯ä¸€ä»½æ•°æ®åœ¨å†…å­˜ä¸­å¯èƒ½æœ‰å¤šä»½ã€‚æˆ‘ä¹‹å‰è¿˜é‡åˆ°ä¸€ä¸ªæ¡ˆä¾‹ï¼Œä¸€ä¸ªåå°ç¨‹åºéœ€è¦ä»æ•°æ®åº“åŠ è½½å¤§é‡ä¿¡æ¯ç”¨äºæ•°æ®å¯¼å‡ºï¼Œè¿™äº›æ•°æ®åœ¨æ•°æ®åº“ä¸­å ç”¨100Må†…å­˜ï¼Œä½†æ˜¯1GBçš„JVMå †å´æ— æ³•å®Œæˆå¯¼å‡ºæ“ä½œã€‚</p><p>æˆ‘æ¥å’Œä½ åˆ†æä¸‹åŸå› å§ã€‚100Mçš„æ•°æ®åŠ è½½åˆ°ç¨‹åºå†…å­˜ä¸­ï¼Œå˜ä¸ºJavaçš„æ•°æ®ç»“æ„å°±å·²ç»å ç”¨äº†200Må †å†…å­˜ï¼›è¿™äº›æ•°æ®ç»è¿‡JDBCã€MyBatisç­‰æ¡†æ¶å…¶å®æ˜¯åŠ è½½äº†2ä»½ï¼Œç„¶åé¢†åŸŸæ¨¡å‹ã€DTOå†è¿›è¡Œè½¬æ¢å¯èƒ½åˆåŠ è½½äº†2æ¬¡ï¼›æœ€ç»ˆï¼Œå ç”¨çš„å†…å­˜è¾¾åˆ°äº†200M*4=800Mã€‚</p><p>æ‰€ä»¥ï¼Œ<strong>åœ¨è¿›è¡Œå®¹é‡è¯„ä¼°æ—¶ï¼Œæˆ‘ä»¬ä¸èƒ½è®¤ä¸ºä¸€ä»½æ•°æ®åœ¨ç¨‹åºå†…å­˜ä¸­ä¹Ÿæ˜¯ä¸€ä»½</strong>ã€‚</p><h2>ä½¿ç”¨WeakHashMapä¸ç­‰äºä¸ä¼šOOM</h2><p>å¯¹äºä¸Šä¸€èŠ‚å®ç°å¿«é€Ÿæ£€ç´¢çš„æ¡ˆä¾‹ï¼Œä¸ºäº†é˜²æ­¢ç¼“å­˜ä¸­å †ç§¯å¤§é‡æ•°æ®å¯¼è‡´OOMï¼Œä¸€äº›åŒå­¦å¯èƒ½ä¼šæƒ³åˆ°ä½¿ç”¨WeakHashMapä½œä¸ºç¼“å­˜å®¹å™¨ã€‚</p><p>WeakHashMapçš„ç‰¹ç‚¹æ˜¯Keyåœ¨å“ˆå¸Œè¡¨å†…éƒ¨æ˜¯å¼±å¼•ç”¨çš„ï¼Œå½“æ²¡æœ‰å¼ºå¼•ç”¨æŒ‡å‘è¿™ä¸ªKeyä¹‹åï¼ŒEntryä¼šè¢«GCï¼Œå³ä½¿æˆ‘ä»¬æ— é™å¾€WeakHashMapåŠ å…¥æ•°æ®ï¼Œåªè¦Keyä¸å†ä½¿ç”¨ï¼Œä¹Ÿå°±ä¸ä¼šOOMã€‚</p><p>è¯´åˆ°äº†å¼ºå¼•ç”¨å’Œå¼±å¼•ç”¨ï¼Œæˆ‘å…ˆå’Œä½ å›é¡¾ä¸‹Javaä¸­å¼•ç”¨ç±»å‹å’Œåƒåœ¾å›æ”¶çš„å…³ç³»ï¼š</p><ul>\n<li>åƒåœ¾å›æ”¶å™¨ä¸ä¼šå›æ”¶æœ‰å¼ºå¼•ç”¨çš„å¯¹è±¡ï¼›</li>\n<li>åœ¨å†…å­˜å……è¶³æ—¶ï¼Œåƒåœ¾å›æ”¶å™¨ä¸ä¼šå›æ”¶å…·æœ‰è½¯å¼•ç”¨çš„å¯¹è±¡ï¼›</li>\n<li>åƒåœ¾å›æ”¶å™¨åªè¦æ‰«æåˆ°äº†å…·æœ‰å¼±å¼•ç”¨çš„å¯¹è±¡å°±ä¼šå›æ”¶ï¼ŒWeakHashMapå°±æ˜¯åˆ©ç”¨äº†è¿™ä¸ªç‰¹ç‚¹ã€‚</li>\n</ul><p>ä¸è¿‡ï¼Œæˆ‘è¦å’Œä½ åˆ†äº«çš„ç¬¬äºŒä¸ªæ¡ˆä¾‹ï¼Œæ°å·§å°±æ˜¯ä¸ä¹…å‰æˆ‘é‡åˆ°çš„ä¸€ä¸ªä½¿ç”¨WeakHashMapå´æœ€ç»ˆOOMçš„æ¡ˆä¾‹ã€‚æˆ‘ä»¬æš‚ä¸”ä¸è®ºä½¿ç”¨WeakHashMapä½œä¸ºç¼“å­˜æ˜¯å¦åˆé€‚ï¼Œå…ˆåˆ†æä¸€ä¸‹è¿™ä¸ªOOMé—®é¢˜ã€‚</p><p>å£°æ˜ä¸€ä¸ªKeyæ˜¯Userç±»å‹ã€Valueæ˜¯UserProfileç±»å‹çš„WeakHashMapï¼Œä½œä¸ºç”¨æˆ·æ•°æ®ç¼“å­˜ï¼Œå¾€å…¶ä¸­æ·»åŠ 200ä¸‡ä¸ªEntryï¼Œç„¶åä½¿ç”¨ScheduledThreadPoolExecutorå‘èµ·ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œæ¯éš”1ç§’è¾“å‡ºç¼“å­˜ä¸­çš„Entryä¸ªæ•°ï¼š</p><pre><code>private Map&lt;User, UserProfile&gt; cache = new WeakHashMap&lt;&gt;();\n\n@GetMapping(&quot;wrong&quot;)\npublic void wrong() {\n    String userName = &quot;zhuye&quot;;\n    //é—´éš”1ç§’å®šæ—¶è¾“å‡ºç¼“å­˜ä¸­çš„æ¡ç›®æ•°\n    Executors.newSingleThreadScheduledExecutor().scheduleAtFixedRate(\n            () -&gt; log.info(&quot;cache size:{}&quot;, cache.size()), 1, 1, TimeUnit.SECONDS);\n    LongStream.rangeClosed(1, 2000000).forEach(i -&gt; {\n        User user = new User(userName + i);\n        cache.put(user, new UserProfile(user, &quot;location&quot; + i));\n    });\n}\n</code></pre><p>æ‰§è¡Œç¨‹åºåæ—¥å¿—å¦‚ä¸‹ï¼š</p><pre><code>[10:30:28.509] [pool-3-thread-1] [INFO ] [t.c.o.demo3.WeakHashMapOOMController:29  ] - cache size:2000000\n[10:30:29.507] [pool-3-thread-1] [INFO ] [t.c.o.demo3.WeakHashMapOOMController:29  ] - cache size:2000000\n[10:30:30.509] [pool-3-thread-1] [INFO ] [t.c.o.demo3.WeakHashMapOOMController:29  ] - cache size:2000000\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œè¾“å‡ºçš„cache sizeå§‹ç»ˆæ˜¯200ä¸‡ï¼Œå³ä½¿æˆ‘ä»¬é€šè¿‡jvisualvmè¿›è¡Œæ‰‹åŠ¨GCè¿˜æ˜¯è¿™æ ·ã€‚è¿™å°±è¯´æ˜ï¼Œè¿™äº›Entryæ— æ³•é€šè¿‡GCå›æ”¶ã€‚å¦‚æœä½ æŠŠ200ä¸‡æ”¹ä¸º1000ä¸‡ï¼Œå°±å¯ä»¥åœ¨æ—¥å¿—ä¸­çœ‹åˆ°å¦‚ä¸‹çš„OOMé”™è¯¯ï¼š</p><pre><code>Exception in thread &quot;http-nio-45678-exec-1&quot; java.lang.OutOfMemoryError: GC overhead limit exceeded\nException in thread &quot;Catalina-utility-2&quot; java.lang.OutOfMemoryError: GC overhead limit exceeded\n</code></pre><p>æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹è¿™ä¸ªé—®é¢˜ã€‚è¿›è¡Œå †è½¬å‚¨åå¯ä»¥çœ‹åˆ°ï¼Œå †å†…å­˜ä¸­æœ‰200ä¸‡ä¸ªUserProfieå’ŒUserï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/b9/e9/b9bb8ef163a07a8da92e6e66a6dd55e9.png?wh=2386*572\" alt=\"\"></p><p>å¦‚ä¸‹æ˜¯Userå’ŒUserProfileç±»çš„å®šä¹‰ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒWeakHashMapçš„Keyæ˜¯Userå¯¹è±¡ï¼Œè€Œå…¶Valueæ˜¯UserProfileå¯¹è±¡ï¼ŒæŒæœ‰äº†Userçš„å¼•ç”¨ï¼š</p><pre><code>@Data\n@AllArgsConstructor\n@NoArgsConstructor\nclass User {\n    private String name;\n}\n\n\n@Data\n@AllArgsConstructor\n@NoArgsConstructor\npublic class UserProfile {\n    private User user;\n    private String location;\n}\n</code></pre><p>æ²¡é”™ï¼Œè¿™å°±æ˜¯é—®é¢˜çš„æ‰€åœ¨ã€‚åˆ†æä¸€ä¸‹WeakHashMapçš„æºç ï¼Œä½ ä¼šå‘ç°WeakHashMapå’ŒHashMapçš„æœ€å¤§åŒºåˆ«ï¼Œæ˜¯Entryå¯¹è±¡çš„å®ç°ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æš‚ä¸”å¿½ç•¥HashMapçš„å®ç°ï¼Œæ¥çœ‹ä¸‹Entryå¯¹è±¡ï¼š</p><pre><code>private static class Entry&lt;K,V&gt; extends WeakReference&lt;Object&gt; ...\n/**\n * Creates new entry.\n */\nEntry(Object key, V value,\n      ReferenceQueue&lt;Object&gt; queue,\n      int hash, Entry&lt;K,V&gt; next) {\n    super(key, queue);\n    this.value = value;\n    this.hash  = hash;\n    this.next  = next;\n}\n</code></pre><p>Entryå¯¹è±¡ç»§æ‰¿äº†WeakReferenceï¼ŒEntryçš„æ„é€ å‡½æ•°è°ƒç”¨äº†super (key,queue)ï¼Œè¿™æ˜¯çˆ¶ç±»çš„æ„é€ å‡½æ•°ã€‚å…¶ä¸­ï¼Œkeyæ˜¯æˆ‘ä»¬æ‰§è¡Œputæ–¹æ³•æ—¶çš„keyï¼›queueæ˜¯ä¸€ä¸ªReferenceQueueã€‚å¦‚æœä½ äº†è§£Javaçš„å¼•ç”¨å°±ä¼šçŸ¥é“ï¼Œè¢«GCçš„å¯¹è±¡ä¼šè¢«ä¸¢è¿›è¿™ä¸ªqueueé‡Œé¢ã€‚</p><p>å†æ¥çœ‹çœ‹å¯¹è±¡è¢«ä¸¢è¿›queueåæ˜¯å¦‚ä½•è¢«é”€æ¯çš„ï¼š</p><pre><code>public V get(Object key) {\n    Object k = maskNull(key);\n    int h = hash(k);\n    Entry&lt;K,V&gt;[] tab = getTable();\n    int index = indexFor(h, tab.length);\n    Entry&lt;K,V&gt; e = tab[index];\n    while (e != null) {\n        if (e.hash == h &amp;&amp; eq(k, e.get()))\n            return e.value;\n        e = e.next;\n    }\n    return null;\n}\n\nprivate Entry&lt;K,V&gt;[] getTable() {\n    expungeStaleEntries();\n    return table;\n}\n\n/**\n * Expunges stale entries from the table.\n */\nprivate void expungeStaleEntries() {\n    for (Object x; (x = queue.poll()) != null; ) {\n        synchronized (queue) {\n            @SuppressWarnings(&quot;unchecked&quot;)\n                Entry&lt;K,V&gt; e = (Entry&lt;K,V&gt;) x;\n            int i = indexFor(e.hash, table.length);\n\n            Entry&lt;K,V&gt; prev = table[i];\n            Entry&lt;K,V&gt; p = prev;\n            while (p != null) {\n                Entry&lt;K,V&gt; next = p.next;\n                if (p == e) {\n                    if (prev == e)\n                        table[i] = next;\n                    else\n                        prev.next = next;\n                    // Must not null out e.next;\n                    // stale entries may be in use by a HashIterator\n                    e.value = null; // Help GC\n                    size--;\n                    break;\n                }\n                prev = p;\n    ``            p = next;\n            }\n        }\n    }\n}\n</code></pre><p>ä»æºç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæ¯æ¬¡è°ƒç”¨getã€putã€sizeç­‰æ–¹æ³•æ—¶ï¼Œéƒ½ä¼šä»queueé‡Œæ‹¿å‡ºæ‰€æœ‰å·²ç»è¢«GCæ‰çš„keyå¹¶åˆ é™¤å¯¹åº”çš„Entryå¯¹è±¡ã€‚æˆ‘ä»¬å†æ¥å›é¡¾ä¸‹è¿™ä¸ªé€»è¾‘ï¼š</p><ul>\n<li>putä¸€ä¸ªå¯¹è±¡è¿›Mapæ—¶ï¼Œå®ƒçš„keyä¼šè¢«å°è£…æˆå¼±å¼•ç”¨å¯¹è±¡ï¼›</li>\n<li>å‘ç”ŸGCæ—¶ï¼Œå¼±å¼•ç”¨çš„keyè¢«å‘ç°å¹¶æ”¾å…¥queueï¼›</li>\n<li>è°ƒç”¨getç­‰æ–¹æ³•æ—¶ï¼Œæ‰«æqueueåˆ é™¤keyï¼Œä»¥åŠåŒ…å«keyå’Œvalueçš„Entryå¯¹è±¡ã€‚</li>\n</ul><p><strong>WeakHashMapçš„Keyè™½ç„¶æ˜¯å¼±å¼•ç”¨ï¼Œä½†æ˜¯å…¶Valueå´æŒæœ‰Keyä¸­å¯¹è±¡çš„å¼ºå¼•ç”¨ï¼ŒValueè¢«Entryå¼•ç”¨ï¼ŒEntryè¢«WeakHashMapå¼•ç”¨ï¼Œæœ€ç»ˆå¯¼è‡´Keyæ— æ³•å›æ”¶</strong>ã€‚è§£å†³æ–¹æ¡ˆå°±æ˜¯è®©Valueå˜ä¸ºå¼±å¼•ç”¨ï¼Œä½¿ç”¨WeakReferenceæ¥åŒ…è£…UserProfileå³å¯ï¼š</p><pre><code>private Map&lt;User, WeakReference&lt;UserProfile&gt;&gt; cache2 = new WeakHashMap&lt;&gt;();\n\n@GetMapping(&quot;right&quot;)\npublic void right() {\n    String userName = &quot;zhuye&quot;;\n    //é—´éš”1ç§’å®šæ—¶è¾“å‡ºç¼“å­˜ä¸­çš„æ¡ç›®æ•°\n    Executors.newSingleThreadScheduledExecutor().scheduleAtFixedRate(\n            () -&gt; log.info(&quot;cache size:{}&quot;, cache2.size()), 1, 1, TimeUnit.SECONDS);\n    LongStream.rangeClosed(1, 2000000).forEach(i -&gt; {\n        User user = new User(userName + i);\n        //è¿™æ¬¡ï¼Œæˆ‘ä»¬ä½¿ç”¨å¼±å¼•ç”¨æ¥åŒ…è£…UserProfile\n        cache2.put(user, new WeakReference(new UserProfile(user, &quot;location&quot; + i)));\n    });\n}\n</code></pre><p>é‡æ–°è¿è¡Œç¨‹åºï¼Œä»æ—¥å¿—ä¸­è§‚å¯Ÿåˆ°cache sizeä¸å†æ˜¯å›ºå®šçš„200ä¸‡ï¼Œè€Œæ˜¯åœ¨ä¸æ–­å‡å°‘ï¼Œç”šè‡³åœ¨æ‰‹åŠ¨GCåæ‰€æœ‰çš„Entryéƒ½è¢«å›æ”¶äº†ï¼š</p><pre><code>[10:40:05.792] [pool-3-thread-1] [INFO ] [t.c.o.demo3.WeakHashMapOOMController:40  ] - cache size:1367402\n[10:40:05.795] [pool-3-thread-1] [INFO ] [t.c.o.demo3.WeakHashMapOOMController:40  ] - cache size:1367846\n[10:40:06.773] [pool-3-thread-1] [INFO ] [t.c.o.demo3.WeakHashMapOOMController:40  ] - cache size:549551\n...\n[10:40:20.742] [pool-3-thread-1] [INFO ] [t.c.o.demo3.WeakHashMapOOMController:40  ] - cache size:549551\n[10:40:22.862] [pool-3-thread-1] [INFO ] [t.c.o.demo3.WeakHashMapOOMController:40  ] - cache size:547937\n[10:40:22.865] [pool-3-thread-1] [INFO ] [t.c.o.demo3.WeakHashMapOOMController:40  ] - cache size:542134\n[10:40:23.779] [pool-3-thread-1] [INFO ] \n//æ‰‹åŠ¨è¿›è¡ŒGC\n[t.c.o.demo3.WeakHashMapOOMController:40  ] - cache size:0\n</code></pre><p>å½“ç„¶ï¼Œè¿˜æœ‰ä¸€ç§åŠæ³•å°±æ˜¯ï¼Œè®©Valueä¹Ÿå°±æ˜¯UserProfileä¸å†å¼•ç”¨Keyï¼Œè€Œæ˜¯é‡æ–°newå‡ºä¸€ä¸ªæ–°çš„Userå¯¹è±¡èµ‹å€¼ç»™UserProfileï¼š</p><pre><code>@GetMapping(&quot;right2&quot;)\npublic void right2() {\n    String userName = &quot;zhuye&quot;;\n    ...\n        User user = new User(userName + i);\n        cache.put(user, new UserProfile(new User(user.getName()), &quot;location&quot; + i));\n    });\n}\n</code></pre><p>æ­¤å¤–ï¼ŒSpringæä¾›çš„<a href=\"https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/util/ConcurrentReferenceHashMap.html\">ConcurrentReferenceHashMap</a>ç±»å¯ä»¥ä½¿ç”¨å¼±å¼•ç”¨ã€è½¯å¼•ç”¨åšç¼“å­˜ï¼ŒKeyå’ŒValueåŒæ—¶è¢«è½¯å¼•ç”¨æˆ–å¼±å¼•ç”¨åŒ…è£…ï¼Œä¹Ÿèƒ½è§£å†³ç›¸äº’å¼•ç”¨å¯¼è‡´çš„æ•°æ®ä¸èƒ½é‡Šæ”¾é—®é¢˜ã€‚ä¸WeakHashMapç›¸æ¯”ï¼ŒConcurrentReferenceHashMapä¸ä½†æ€§èƒ½æ›´å¥½ï¼Œè¿˜å¯ä»¥ç¡®ä¿çº¿ç¨‹å®‰å…¨ã€‚ä½ å¯ä»¥è‡ªå·±åšå®éªŒæµ‹è¯•ä¸‹ã€‚</p><h2>Tomcatå‚æ•°é…ç½®ä¸åˆç†å¯¼è‡´OOM</h2><p>æˆ‘ä»¬å†æ¥çœ‹çœ‹ç¬¬ä¸‰ä¸ªæ¡ˆä¾‹ã€‚æœ‰ä¸€æ¬¡è¿ç»´åŒå­¦åé¦ˆï¼Œæœ‰ä¸ªåº”ç”¨åœ¨ä¸šåŠ¡é‡å¤§çš„æƒ…å†µä¸‹ä¼šå‡ºç°å‡æ­»ï¼Œæ—¥å¿—ä¸­ä¹Ÿæœ‰å¤§é‡OOMå¼‚å¸¸ï¼š</p><pre><code>[13:18:17.597] [http-nio-45678-exec-70] [ERROR] [ache.coyote.http11.Http11NioProtocol:175 ] - Failed to complete processing of a request\njava.lang.OutOfMemoryError: Java heap space\n</code></pre><p>äºæ˜¯ï¼Œæˆ‘è®©è¿ç»´åŒå­¦è¿›è¡Œç”Ÿäº§å †Dumpã€‚é€šè¿‡MATæ‰“å¼€dumpæ–‡ä»¶åï¼Œæˆ‘ä»¬ä¸€çœ¼å°±çœ‹åˆ°OOMçš„åŸå› æ˜¯ï¼Œæœ‰æ¥è¿‘1.7GBçš„byteæ•°ç»„åˆ†é…ï¼Œè€ŒJVMè¿›ç¨‹çš„æœ€å¤§å †å†…å­˜æˆ‘ä»¬åªé…ç½®äº†2GBï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/0b/ee/0b310e7da83f272afdf51b345d8057ee.png?wh=1738*194\" alt=\"\"></p><p>é€šè¿‡æŸ¥çœ‹å¼•ç”¨å¯ä»¥å‘ç°ï¼Œå¤§é‡å¼•ç”¨éƒ½æ˜¯Tomcatçš„å·¥ä½œçº¿ç¨‹ã€‚å¤§éƒ¨åˆ†å·¥ä½œçº¿ç¨‹éƒ½åˆ†é…äº†ä¸¤ä¸ª10Må·¦å³çš„æ•°ç»„ï¼Œ100ä¸ªå·¦å³å·¥ä½œçº¿ç¨‹åƒæ»¡äº†å†…å­˜ã€‚ç¬¬ä¸€ä¸ªçº¢æ¡†æ˜¯Http11InputBufferï¼Œå…¶bufferå¤§å°æ˜¯10008192å­—èŠ‚ï¼›è€Œç¬¬äºŒä¸ªçº¢æ¡†çš„Http11OutputBufferçš„bufferï¼Œæ­£å¥½å ç”¨10000000å­—èŠ‚ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/53/12/53546299958a4fecef5fd473a0579012.png?wh=2186*1056\" alt=\"\"></p><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ç¬¬ä¸€ä¸ªHttp11InputBufferä¸ºä»€ä¹ˆä¼šå ç”¨è¿™ä¹ˆå¤šå†…å­˜ã€‚æŸ¥çœ‹Http11InputBufferç±»çš„initæ–¹æ³•æ³¨æ„åˆ°ï¼Œå…¶ä¸­ä¸€ä¸ªåˆå§‹åŒ–æ–¹æ³•ä¼šåˆ†é…headerBufferSize+readBufferå¤§å°çš„å†…å­˜ï¼š</p><pre><code>void init(SocketWrapperBase&lt;?&gt; socketWrapper) {\n\n    wrapper = socketWrapper;\n    wrapper.setAppReadBufHandler(this);\n\n    int bufLength = headerBufferSize +\n            wrapper.getSocketBufferHandler().getReadBuffer().capacity();\n    if (byteBuffer == null || byteBuffer.capacity() &lt; bufLength) {\n        byteBuffer = ByteBuffer.allocate(bufLength);\n        byteBuffer.position(0).limit(0);\n    }\n}\n</code></pre><p>åœ¨<a href=\"https://tomcat.apache.org/tomcat-8.0-doc/config/http.html\">Tomcatæ–‡æ¡£</a>ä¸­æœ‰æåˆ°ï¼Œè¿™ä¸ªSocketçš„è¯»ç¼“å†²ï¼Œä¹Ÿå°±æ˜¯readBufferé»˜è®¤æ˜¯8192å­—èŠ‚ã€‚æ˜¾ç„¶ï¼Œé—®é¢˜å‡ºåœ¨äº†headerBufferSizeä¸Šï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/0c/68/0c14d6aff749d74b3ee0e159e4552168.png?wh=2650*246\" alt=\"\"></p><p>å‘ä¸Šè¿½æº¯åˆå§‹åŒ–Http11InputBufferçš„Http11Processorç±»ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œä¼ å…¥çš„headerBufferSizeé…ç½®çš„æ˜¯MaxHttpHeaderSizeï¼š</p><pre><code>inputBuffer = new Http11InputBuffer(request, protocol.getMaxHttpHeaderSize(),\n        protocol.getRejectIllegalHeaderName(), httpParser);\n</code></pre><p>Http11OutputBufferä¸­çš„bufferæ­£å¥½å ç”¨äº†10000000å­—èŠ‚ï¼Œè¿™åˆæ˜¯ä¸ºä»€ä¹ˆï¼Ÿé€šè¿‡Http11OutputBufferçš„æ„é€ æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°å®ƒæ˜¯ç›´æ¥æ ¹æ®headerBufferSizeåˆ†é…äº†å›ºå®šå¤§å°çš„headerBufferï¼š</p><pre><code>protected Http11OutputBuffer(Response response, int headerBufferSize){\n...\n \theaderBuffer = ByteBuffer.allocate(headerBufferSize);\n}\n</code></pre><p>é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥æƒ³åˆ°ï¼Œä¸€å®šæ˜¯åº”ç”¨æŠŠTomcatå¤´ç›¸å…³çš„å‚æ•°é…ç½®ä¸º10000000äº†ï¼Œä½¿å¾—æ¯ä¸€ä¸ªè¯·æ±‚å¯¹äºRequestå’ŒResponseéƒ½å ç”¨äº†20Må†…å­˜ï¼Œæœ€ç»ˆåœ¨å¹¶å‘è¾ƒå¤šçš„æƒ…å†µä¸‹å¼•èµ·äº†OOMã€‚</p><p>æœä¸å…¶ç„¶ï¼ŒæŸ¥çœ‹é¡¹ç›®ä»£ç å‘ç°é…ç½®æ–‡ä»¶ä¸­æœ‰è¿™æ ·çš„é…ç½®é¡¹ï¼š</p><pre><code>server.max-http-header-size=10000000\n</code></pre><p>ç¿»çœ‹æºç æäº¤è®°å½•å¯ä»¥çœ‹åˆ°ï¼Œå½“æ—¶å¼€å‘åŒå­¦é‡åˆ°äº†è¿™æ ·çš„å¼‚å¸¸ï¼š</p><pre><code>java.lang.IllegalArgumentException: Request header is too large\n</code></pre><p>äºæ˜¯ä»–å°±åˆ°ç½‘ä¸Šæœç´¢äº†ä¸€ä¸‹è§£å†³æ–¹æ¡ˆï¼Œéšæ„å°†server.max-http-header-sizeä¿®æ”¹ä¸ºäº†ä¸€ä¸ªè¶…å¤§å€¼ï¼ŒæœŸæœ›æ°¸è¿œä¸ä¼šå†å‡ºç°ç±»ä¼¼é—®é¢˜ã€‚ä½†ï¼Œæ²¡æƒ³åˆ°è¿™ä¸ªä¿®æ”¹å´å¼•èµ·äº†è¿™ä¹ˆå¤§çš„é—®é¢˜ã€‚æŠŠè¿™ä¸ªå‚æ•°æ”¹ä¸ºæ¯”è¾ƒåˆé€‚çš„20000å†è¿›è¡Œå‹æµ‹ï¼Œæˆ‘ä»¬å°±å¯ä»¥å‘ç°åº”ç”¨çš„å„é¡¹æŒ‡æ ‡éƒ½æ¯”è¾ƒç¨³å®šã€‚</p><p>è¿™ä¸ªæ¡ˆä¾‹å‘Šè¯‰æˆ‘ä»¬ï¼Œ<strong>ä¸€å®šè¦æ ¹æ®å®é™…éœ€æ±‚æ¥ä¿®æ”¹å‚æ•°é…ç½®ï¼Œå¯ä»¥è€ƒè™‘é¢„ç•™2åˆ°5å€çš„é‡ã€‚å®¹é‡ç±»çš„å‚æ•°èƒŒåå¾€å¾€ä»£è¡¨äº†èµ„æºï¼Œè®¾ç½®è¶…å¤§çš„å‚æ•°å°±æœ‰å¯èƒ½å ç”¨ä¸å¿…è¦çš„èµ„æºï¼Œåœ¨å¹¶å‘é‡å¤§çš„æ—¶å€™å› ä¸ºèµ„æºå¤§é‡åˆ†é…å¯¼è‡´OOM</strong>ã€‚</p><h2>é‡ç‚¹å›é¡¾</h2><p>ä»Šå¤©ï¼Œæˆ‘ä»å†…å­˜åˆ†é…æ„è¯†çš„è§’åº¦å’Œä½ åˆ†äº«äº†OOMçš„é—®é¢˜ã€‚é€šå¸¸è€Œè¨€ï¼ŒJavaç¨‹åºçš„OOMæœ‰å¦‚ä¸‹å‡ ç§å¯èƒ½ã€‚</p><p>ä¸€æ˜¯ï¼Œæˆ‘ä»¬çš„ç¨‹åºç¡®å®éœ€è¦è¶…å‡ºJVMé…ç½®çš„å†…å­˜ä¸Šé™çš„å†…å­˜ã€‚ä¸ç®¡æ˜¯ç¨‹åºå®ç°çš„ä¸åˆç†ï¼Œè¿˜æ˜¯å› ä¸ºå„ç§æ¡†æ¶å¯¹æ•°æ®çš„é‡å¤å¤„ç†ã€åŠ å·¥å’Œè½¬æ¢ï¼Œç›¸åŒçš„æ•°æ®åœ¨å†…å­˜ä¸­ä¸ä¸€å®šåªå ç”¨ä¸€ä»½ç©ºé—´ã€‚é’ˆå¯¹å†…å­˜é‡ä½¿ç”¨è¶…å¤§çš„ä¸šåŠ¡é€»è¾‘ï¼Œæ¯”å¦‚ç¼“å­˜é€»è¾‘ã€æ–‡ä»¶ä¸Šä¼ ä¸‹è½½å’Œå¯¼å‡ºé€»è¾‘ï¼Œæˆ‘ä»¬åœ¨åšå®¹é‡è¯„ä¼°æ—¶ï¼Œå¯èƒ½è¿˜éœ€è¦å®é™…åšä¸€ä¸‹Dumpï¼Œè€Œä¸æ˜¯è¿›è¡Œç®€å•çš„å‡è®¾ã€‚</p><p>äºŒæ˜¯ï¼Œå‡ºç°å†…å­˜æ³„éœ²ï¼Œå…¶å®å°±æ˜¯æˆ‘ä»¬è®¤ä¸ºæ²¡æœ‰ç”¨çš„å¯¹è±¡æœ€ç»ˆä¼šè¢«GCï¼Œä½†å´æ²¡æœ‰ã€‚GCå¹¶ä¸ä¼šå›æ”¶å¼ºå¼•ç”¨å¯¹è±¡ï¼Œæˆ‘ä»¬å¯èƒ½ç»å¸¸åœ¨ç¨‹åºä¸­å®šä¹‰ä¸€äº›å®¹å™¨ä½œä¸ºç¼“å­˜ï¼Œä½†å¦‚æœå®¹å™¨ä¸­çš„æ•°æ®æ— é™å¢é•¿ï¼Œè¦ç‰¹åˆ«å°å¿ƒæœ€ç»ˆä¼šå¯¼è‡´OOMã€‚ä½¿ç”¨WeakHashMapæ˜¯è§£å†³è¿™ä¸ªé—®é¢˜çš„å¥½åŠæ³•ï¼Œä½†å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœå¼ºå¼•ç”¨çš„Valueæœ‰å¼•ç”¨Keyï¼Œä¹Ÿæ— æ³•å›æ”¶Entryã€‚</p><p>ä¸‰æ˜¯ï¼Œä¸åˆç†çš„èµ„æºéœ€æ±‚é…ç½®ï¼Œåœ¨ä¸šåŠ¡é‡å°çš„æ—¶å€™å¯èƒ½ä¸ä¼šå‡ºç°é—®é¢˜ï¼Œä½†ä¸šåŠ¡é‡ä¸€å¤§å¯èƒ½å¾ˆå¿«å°±ä¼šæ’‘çˆ†å†…å­˜ã€‚æ¯”å¦‚ï¼Œéšæ„é…ç½®Tomcatçš„max-http-header-sizeå‚æ•°ï¼Œä¼šå¯¼è‡´ä¸€ä¸ªè¯·æ±‚ä½¿ç”¨è¿‡å¤šçš„å†…å­˜ï¼Œè¯·æ±‚é‡å¤§çš„æ—¶å€™å‡ºç°OOMã€‚åœ¨è¿›è¡Œå‚æ•°é…ç½®çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¦è®¤è¯†åˆ°ï¼Œå¾ˆå¤šé™åˆ¶ç±»å‚æ•°é™åˆ¶çš„æ˜¯èƒŒåèµ„æºçš„ä½¿ç”¨ï¼Œèµ„æºå§‹ç»ˆæ˜¯æœ‰é™çš„ï¼Œéœ€è¦æ ¹æ®å®é™…éœ€æ±‚æ¥åˆç†è®¾ç½®å‚æ•°ã€‚</p><p>æœ€åæˆ‘æƒ³è¯´çš„æ˜¯ï¼Œåœ¨å‡ºç°OOMä¹‹åï¼Œä¹Ÿä¸ç”¨è¿‡äºç´§å¼ ã€‚æˆ‘ä»¬å¯ä»¥æ ¹æ®é”™è¯¯æ—¥å¿—ä¸­çš„å¼‚å¸¸ä¿¡æ¯ï¼Œå†ç»“åˆjstatç­‰å‘½ä»¤è¡Œå·¥å…·è§‚å¯Ÿå†…å­˜ä½¿ç”¨æƒ…å†µï¼Œä»¥åŠç¨‹åºçš„GCæ—¥å¿—ï¼Œæ¥å¤§è‡´å®šä½å‡ºç°OOMçš„å†…å­˜åŒºå—å’Œç±»å‹ã€‚å…¶å®ï¼Œæˆ‘ä»¬é‡åˆ°çš„90%çš„OOMéƒ½æ˜¯å †OOMï¼Œå¯¹JVMè¿›ç¨‹è¿›è¡Œå †å†…å­˜Dumpï¼Œæˆ–ä½¿ç”¨jmapå‘½ä»¤åˆ†æå¯¹è±¡å†…å­˜å ç”¨æ’è¡Œï¼Œä¸€èˆ¬éƒ½å¯ä»¥å¾ˆå®¹æ˜“å®šä½åˆ°é—®é¢˜ã€‚</p><p>è¿™é‡Œï¼Œ<strong>æˆ‘å»ºè®®ä½ ä¸ºç”Ÿäº§ç³»ç»Ÿçš„ç¨‹åºé…ç½®JVMå‚æ•°å¯ç”¨è¯¦ç»†çš„GCæ—¥å¿—ï¼Œæ–¹ä¾¿è§‚å¯Ÿåƒåœ¾æ”¶é›†å™¨çš„è¡Œä¸ºï¼Œå¹¶å¼€å¯HeapDumpOnOutOfMemoryErrorï¼Œä»¥ä¾¿åœ¨å‡ºç°OOMæ—¶èƒ½è‡ªåŠ¨Dumpç•™ä¸‹ç¬¬ä¸€é—®é¢˜ç°åœº</strong>ã€‚å¯¹äºJDK8ï¼Œä½ å¯ä»¥è¿™ä¹ˆè®¾ç½®ï¼š</p><pre><code>XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=. -XX:+PrintGCDateStamps -XX:+PrintGCDetails -Xloggc:gc.log -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=10 -XX:GCLogFileSize=100M\n</code></pre><p>ä»Šå¤©ç”¨åˆ°çš„ä»£ç ï¼Œæˆ‘éƒ½æ”¾åœ¨äº†GitHubä¸Šï¼Œä½ å¯ä»¥ç‚¹å‡»<a href=\"https://github.com/JosephZhu1983/java-common-mistakes\">è¿™ä¸ªé“¾æ¥</a>æŸ¥çœ‹ã€‚</p><h2>æ€è€ƒä¸è®¨è®º</h2><ol>\n<li>Springçš„ConcurrentReferenceHashMapï¼Œé’ˆå¯¹Keyå’ŒValueæ”¯æŒè½¯å¼•ç”¨å’Œå¼±å¼•ç”¨ä¸¤ç§æ–¹å¼ã€‚ä½ è§‰å¾—å“ªç§æ–¹å¼æ›´é€‚åˆåšç¼“å­˜å‘¢ï¼Ÿ</li>\n<li>å½“æˆ‘ä»¬éœ€è¦åŠ¨æ€æ‰§è¡Œä¸€äº›è¡¨è¾¾å¼æ—¶ï¼Œå¯ä»¥ä½¿ç”¨GroovyåŠ¨æ€è¯­è¨€å®ç°ï¼šnewå‡ºä¸€ä¸ªGroovyShellç±»ï¼Œç„¶åè°ƒç”¨evaluateæ–¹æ³•åŠ¨æ€æ‰§è¡Œè„šæœ¬ã€‚è¿™ç§æ–¹å¼çš„é—®é¢˜æ˜¯ï¼Œä¼šé‡å¤äº§ç”Ÿå¤§é‡çš„ç±»ï¼Œå¢åŠ MetaspaceåŒºçš„GCè´Ÿæ‹…ï¼Œæœ‰å¯èƒ½ä¼šå¼•èµ·OOMã€‚ä½ çŸ¥é“å¦‚ä½•é¿å…è¿™ä¸ªé—®é¢˜å—ï¼Ÿ</li>\n</ol><p>é’ˆå¯¹OOMæˆ–å†…å­˜æ³„éœ²ï¼Œä½ è¿˜é‡åˆ°è¿‡ä»€ä¹ˆæ¡ˆä¾‹å—ï¼Ÿæˆ‘æ˜¯æœ±æ™”ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºä¸æˆ‘ç•™è¨€åˆ†äº«ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹æˆ–åŒäº‹ï¼Œä¸€èµ·äº¤æµã€‚</p>","neighbors":{"left":{"article_title":"16 | ç”¨å¥½Java 8çš„æ—¥æœŸæ—¶é—´ç±»ï¼Œå°‘è¸©ä¸€äº›â€œè€ä¸‰æ ·â€çš„å‘","id":224240},"right":{"article_title":"18 | å½“åå°„ã€æ³¨è§£å’Œæ³›å‹é‡åˆ°OOPæ—¶ï¼Œä¼šæœ‰å“ªäº›å‘ï¼Ÿ","id":225596}},"comments":[{"had_liked":false,"id":207699,"user_name":"ä¸€ä¸ªæ±‰å­~","can_delete":false,"product_type":"c1","uid":1635211,"ip_address":"","ucode":"9E1419704FDEBB","user_header":"https://static001.geekbang.org/account/avatar/00/18/f3/8b/a629f9d4.jpg","comment_is_top":false,"comment_ctime":1587140053,"is_pvip":false,"replies":[{"id":"77566","content":"ğŸ‘ğŸ»","user_name":"ä½œè€…å›å¤","comment_id":207699,"uid":"1001470","ip_address":"","utype":1,"ctime":1587167419,"user_name_real":"æœ±æ™”"}],"discussion_count":3,"race_medal":0,"score":"96076420565","product_id":100047701,"comment_content":"é’ˆå¯¹ç¬¬äºŒç‚¹ï¼Œå¯ä»¥å…ˆcompileï¼Œç„¶ååœ¨å†…å­˜ä¸­ä¿å­˜ï¼Œè„šæœ¬å†…å®¹çš„hashä½œä¸ºkeyï¼Œcompileç»“æœä½œä¸ºvalueï¼Œç”¨ConcurrentReferenceHashMapä¿å­˜<br>åŒæ ·çš„é£é™©è¿˜å‡ºç°åœ¨è¡¨è¾¾å¼æ¡†æ¶aviatorä¸­","like_count":23,"discussions":[{"author":{"id":1001470,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/fe/d0e25d57.jpg","nickname":"æœ±æ™”","note":"","ucode":"0B7F0BADE6AAB8","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492212,"discussion_content":"ğŸ‘ğŸ»","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587167419,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1139413,"avatar":"https://static001.geekbang.org/account/avatar/00/11/62/d5/1f5c5ab6.jpg","nickname":"å¤§å¤§å¤§ç†Šmyeh","note":"","ucode":"4832C2E7CEB151","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":237452,"discussion_content":"Aviator å¼€äº†cacheä¼šæå¤§é™ä½OOMçš„é£é™©","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1587142258,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1102228,"avatar":"https://static001.geekbang.org/account/avatar/00/10/d1/94/6c73ab00.jpg","nickname":"å¶è½","note":"","ucode":"F836A8144518BA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":307971,"discussion_content":"æœ‰æ²¡æœ‰å¯èƒ½hashå€¼é‡å¤","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600819587,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":208640,"user_name":"Darren","can_delete":false,"product_type":"c1","uid":1254968,"ip_address":"","ucode":"CCD2B2C492BE9A","user_header":"https://static001.geekbang.org/account/avatar/00/13/26/38/ef063dc2.jpg","comment_is_top":false,"comment_ctime":1587395151,"is_pvip":true,"replies":[{"id":"77980","content":"æºç é‡Œæˆ‘ä¹Ÿæœ‰ä¸€ä¸ªä¾‹å­ï¼Œæ€è·¯æ˜¯ä¸è¦æ¯æ¬¡éƒ½evaluateè„šæœ¬è€Œæ˜¯æŠŠè„šæœ¬è½¬å˜ä¸ºä¸€ä¸ªæ–¹æ³•parseåç¼“å­˜èµ·æ¥è¿™ä¸ªScriptï¼Œä»¥åç›´æ¥invokeMethodæ¥ä½¿ç”¨","user_name":"ä½œè€…å›å¤","comment_id":208640,"uid":"1001470","ip_address":"","utype":1,"ctime":1587435641,"user_name_real":"æœ±æ™”"}],"discussion_count":3,"race_medal":0,"score":"40242100815","product_id":100047701,"comment_content":"è¯•ç€å›åˆ°ä¸‹é—®é¢˜ï¼š<br>ç¬¬ä¸€ä¸ªï¼š<br>è‚¯å®šæ˜¯è½¯å¼•ç”¨ï¼Œå› ä¸ºå¼±å¼•ç”¨æ˜¯åªè¦GCæ‰§è¡Œï¼Œæ‰«æåˆ°å°±è¢«å›æ”¶ï¼Œç¼“å­˜çš„ä½œç”¨æ˜¯ä¸ºäº†æé«˜é€Ÿåº¦ï¼Œè¦æœ‰ä¸€å®šçš„å­˜åœ¨å‘¨æœŸï¼›å¦‚æœæ˜¯å¼±å¼•ç”¨ï¼Œæ¯æ¬¡GCæ‰§è¡Œï¼Œç¼“å­˜è¢«å›æ”¶ï¼Œç¼“å­˜å‘½ä¸­ç‡è¶…ä½ï¼Œå®Œå…¨è¾¾ä¸åˆ°ç¼“å­˜çš„ä½œç”¨ï¼Œè€Œåˆè¦ç»´æŠ¤ç¼“å­˜å’ŒDBçš„æ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼Œå¾—ä¸å¿å¤±ã€‚<br>ç¬¬äºŒä¸ªï¼š<br>ç¬¬ä¸€ç§ä¸å®Œç¾çš„æ–¹æ¡ˆï¼šGroovyShellä¸è¦è®¾ç½®æˆå…¨å±€çš„ï¼Œæ¯æ¬¡è¿è¡Œæ—¶ï¼Œéƒ½åˆ›å»ºä¸€ä¸ªGroovyShellï¼Œç„¶åé™åˆ¶å…ƒæ•°æ®åŒºå¤§å°ï¼Œå½“å…ƒæ•°æ®å›æ”¶æ—¶ï¼ŒGroovyShellå’Œè¯¥GroovyShellåŠ è½½çš„ç±»ä¸€èµ·è¢«å›æ”¶ï¼›<br>ç¬¬äºŒç§æ–¹æ³•ï¼šGroovyShellè®¾ç½®ä¸ºå…¨å±€çš„ï¼Œç„¶åä½¿ç”¨ç¼“å­˜ï¼Œæ¯æ¬¡éƒ½æ˜¯å…ˆä»ç¼“å­˜ä¸­è·å–ï¼Œè·å–ä¸åˆ°äº†ï¼Œåœ¨åŠ è½½ï¼Œç„¶åæ›´æ–°ç¼“å­˜ã€‚","like_count":10,"discussions":[{"author":{"id":1001470,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/fe/d0e25d57.jpg","nickname":"æœ±æ™”","note":"","ucode":"0B7F0BADE6AAB8","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492557,"discussion_content":"æºç é‡Œæˆ‘ä¹Ÿæœ‰ä¸€ä¸ªä¾‹å­ï¼Œæ€è·¯æ˜¯ä¸è¦æ¯æ¬¡éƒ½evaluateè„šæœ¬è€Œæ˜¯æŠŠè„šæœ¬è½¬å˜ä¸ºä¸€ä¸ªæ–¹æ³•parseåç¼“å­˜èµ·æ¥è¿™ä¸ªScriptï¼Œä»¥åç›´æ¥invokeMethodæ¥ä½¿ç”¨","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587435641,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1002939,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/4d/bb/abb7bfe3.jpg","nickname":"csyangchsh","note":"","ucode":"8604F5C839710B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":251050,"discussion_content":"è½¯å¼•ç”¨ä¹Ÿæ˜¯å‘ï¼Œå®ƒè‡ªå·±æœ¬èº«æ˜¯ä¸€ä¸ªå¼ºå¼•ç”¨ï¼Œå¦‚æœä¸å°å¿ƒè¢«GC Rootå¼•ç”¨ï¼Œå°±æ˜¯å†…å­˜æ³„éœ²äº†ã€‚è½¯å¼•ç”¨çš„é—®é¢˜æ˜¯å®ƒæ²¡æœ‰è¶³å¤Ÿçš„ä¿¡æ¯æä¾›ç»™GCæ˜¯å¦åº”è¯¥å›æ”¶ï¼Œ-XX:SoftRefLRUPolicyMSPerMB å¾ˆéš¾è®¾ç½®ä¸€ä¸ªåˆé€‚çš„å€¼ã€‚è¿‡å¤šä½¿ç”¨è½¯å¼•ç”¨å’Œå¼±å¼•ç”¨å¯èƒ½ä¼šå¯¼è‡´GCåœé¡¿æ—¶é—´å˜é•¿ã€‚","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1588061267,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1254968,"avatar":"https://static001.geekbang.org/account/avatar/00/13/26/38/ef063dc2.jpg","nickname":"Darren","note":"","ucode":"CCD2B2C492BE9A","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":243316,"discussion_content":"è°¢è°¢è€å¸ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587533569,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":208439,"user_name":"æ±æ—å¤–å²","can_delete":false,"product_type":"c1","uid":1188906,"ip_address":"","ucode":"3C66C0F0537A99","user_header":"https://static001.geekbang.org/account/avatar/00/12/24/2a/33441e2b.jpg","comment_is_top":false,"comment_ctime":1587358454,"is_pvip":false,"replies":[{"id":"77871","content":"1. ğŸ‘ æ˜¯çš„ï¼Œè¿™ç§åœºæ™¯å­—å…¸æ ‘æ›´åˆé€‚ï¼Œä¸è¿‡æˆ‘è¿™è¾¹éƒ½æ˜¯æ‹¿ç€å®é™…çš„æ¡ˆä¾‹æ•´ç†æˆæ–‡çš„ï¼Œä¸»è¦æ˜¯å¸Œæœ›å‘ŠçŸ¥å¤§å®¶æˆ‘ä»¬è®¤ä¸ºçš„ä¸€ä»½æ•°æ®åœ¨ç¨‹åºä¸­ä¸ä¸€å®šæ˜¯ä¸€ä»½è¿™ä¸ªè¯¯åŒº","user_name":"ä½œè€…å›å¤","comment_id":208439,"uid":"1001470","ip_address":"","utype":1,"ctime":1587363121,"user_name_real":"æœ±æ™”"}],"discussion_count":1,"race_medal":0,"score":"31652129526","product_id":100047701,"comment_content":"1. å¯¹äºè€å¸ˆè¯´çš„autoCompleteçš„åœºæ™¯æ˜¯ä¸æ˜¯Trieæ ‘æ›´é€‚åˆä¸€äº›ï¼Ÿ<br>2. è¿™ä¸ªWeakReferenceå¯èƒ½å¯¼è‡´å†…å­˜æº¢å‡ºçš„å…¸å‹å°±æ˜¯ThreadLocalï¼Œè™½ç„¶ThreadLocalMapçš„entryçš„keyæ˜¯weakReferenceï¼Œä½†æ˜¯valueæ˜¯å¼ºå¼•ç”¨ï¼Œå½“ç”¨çº¿ç¨‹æ± çš„æ—¶å€™ï¼Œå°±ä¼šå†…å­˜æº¢å‡ºï¼Œè¿˜æ˜¯è¦è‡ªå·±removeæ‰è¡Œã€‚<br>3. å¯¹äºé—®é¢˜1ï¼Œåº”è¯¥æ˜¯ç”¨è½¯å¼•ç”¨æ›´å¥½ä¸€äº›ï¼Œç”¨å¼±å¼•ç”¨æ€»æ˜¯è¢«gcå›æ”¶å°±å¤±å»äº†ç¼“å­˜çš„æ„ä¹‰ã€‚å¯¹äºé—®é¢˜2ä¸æ˜¯å¾ˆäº†è§£ã€‚","like_count":8,"discussions":[{"author":{"id":1001470,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/fe/d0e25d57.jpg","nickname":"æœ±æ™”","note":"","ucode":"0B7F0BADE6AAB8","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492456,"discussion_content":"1. ğŸ‘ æ˜¯çš„ï¼Œè¿™ç§åœºæ™¯å­—å…¸æ ‘æ›´åˆé€‚ï¼Œä¸è¿‡æˆ‘è¿™è¾¹éƒ½æ˜¯æ‹¿ç€å®é™…çš„æ¡ˆä¾‹æ•´ç†æˆæ–‡çš„ï¼Œä¸»è¦æ˜¯å¸Œæœ›å‘ŠçŸ¥å¤§å®¶æˆ‘ä»¬è®¤ä¸ºçš„ä¸€ä»½æ•°æ®åœ¨ç¨‹åºä¸­ä¸ä¸€å®šæ˜¯ä¸€ä»½è¿™ä¸ªè¯¯åŒº","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587363121,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":207896,"user_name":"ğŸ‘½","can_delete":false,"product_type":"c1","uid":1274117,"ip_address":"","ucode":"D313AF941B412D","user_header":"https://static001.geekbang.org/account/avatar/00/13/71/05/db554eba.jpg","comment_is_top":false,"comment_ctime":1587210234,"is_pvip":false,"replies":[{"id":"77587","content":"ä¸é”™","user_name":"ä½œè€…å›å¤","comment_id":207896,"uid":"1001470","ip_address":"","utype":1,"ctime":1587215260,"user_name_real":"æœ±æ™”"}],"discussion_count":2,"race_medal":0,"score":"31651981306","product_id":100047701,"comment_content":"åº”è¯¥ç”¨å“ªç§å¼•ç”¨ï¼Œé¦–å…ˆè€ƒè™‘çš„è‚¯å®šæ˜¯å››å¤§å¼•ç”¨çš„åŒºåˆ«ã€‚<br>1.å¼ºå¼•ç”¨ï¼šæœ€å¸¸è§çš„ä¸€ç§ï¼Œåªè¦è¯¥å¼•ç”¨å­˜åœ¨ï¼Œå°±ä¸ä¼šè¢«GCã€‚<br>2.è½¯å¼•ç”¨ï¼šå†…å­˜ç©ºé—´ä¸è¶³æ—¶ï¼Œè¿›è¡Œå›æ”¶ã€‚<br>3.å¼±å¼•ç”¨ï¼šå½“JVMè¿›è¡ŒGCæ—¶ï¼Œåˆ™è¿›è¡Œå›æ”¶ï¼Œæ— è®ºå†…å­˜æ˜¯å¦å……è¶³ã€‚<br>4.è™šå¼•ç”¨ï¼šè¿™ä¸ªä¸æäº†ï¼Œå› ä¸ºæˆ‘ä¹Ÿå®Œå…¨ä¸æ‡‚ã€‚<br><br>è½¯å¼•ç”¨å’Œå¼±å¼•ç”¨ï¼Œè¿™ä¸¤ä¸ªï¼Œè®©æˆ‘é€‰ï¼Œè‚¯å®šæ˜¯é€‰è½¯å¼•ç”¨ã€‚å› ä¸ºå¼±å¼•ç”¨ï¼Œè¢«å›æ”¶çš„é¢‘ç‡æ›´é«˜ã€‚ç¼“å­˜ï¼Œå¦‚æœç»å¸¸è¢«å›æ”¶çš„è¯ï¼Œå°±è¾¾ä¸åˆ°æœ€å¤§åˆ©ç”¨ç‡ã€‚<br><br>ä½†æ˜¯è¿™é‡Œåˆè¦è¯´ç‚¹é¢å¤–çš„ï¼Œå•è¯´ç¼“å­˜è®¾è®¡ï¼Œè¿˜è¦æ¶‰åŠå…¶ä»–çš„å› ç´ ã€‚åŒ…æ‹¬ç¼“å­˜å¤§å°ï¼Œç¼“å­˜çš„è¿‡æœŸæ—¶é—´ç­‰ã€‚è®©æˆ‘æ¥è¯´çš„è¯ï¼Œæˆ‘å¯èƒ½ä¼šè€ƒè™‘ä½¿ç”¨ç°æœ‰çš„ç¼“å­˜å®ç°ï¼Œæˆ–è€…æ˜¯redisã€‚è‡ªå·±å®ç°ä¸€å¥—ç¼“å­˜ï¼Œæˆæœ¬ç•¥é«˜ã€‚","like_count":8,"discussions":[{"author":{"id":1001470,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/fe/d0e25d57.jpg","nickname":"æœ±æ™”","note":"","ucode":"0B7F0BADE6AAB8","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492273,"discussion_content":"ä¸é”™","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587215260,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2014573,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/bd/6d/7010f98e.jpg","nickname":"SharpBB","note":"","ucode":"D30C5B798B8E8C","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":559653,"discussion_content":"ç¬‘æ­» å› ä¸ºæˆ‘ä¹Ÿä¸æ‡‚ å“ˆå“ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1648865808,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":207701,"user_name":"ä¸€ä¸ªæ±‰å­~","can_delete":false,"product_type":"c1","uid":1635211,"ip_address":"","ucode":"9E1419704FDEBB","user_header":"https://static001.geekbang.org/account/avatar/00/18/f3/8b/a629f9d4.jpg","comment_is_top":false,"comment_ctime":1587140559,"is_pvip":false,"replies":[{"id":"77565","content":"å¾ˆå¸¸è§çš„é—®é¢˜ï¼Œè¿˜æœ‰åŒ…æ‹¬å‚æ•°æœªä¼ å¯¼è‡´mybatisæ¡ä»¶æ²¡æœ‰æ‹¼æ¥ä¸Šå»ï¼Œå¯¼è‡´å…¨è¡¨æŸ¥è¯¢çš„oom","user_name":"ä½œè€…å›å¤","comment_id":207701,"uid":"1001470","ip_address":"","utype":1,"ctime":1587167410,"user_name_real":"æœ±æ™”"}],"discussion_count":3,"race_medal":0,"score":"31651911631","product_id":100047701,"comment_content":"ä¹‹å‰è¿˜é‡åˆ°ä¸€ä¸ªï¼Œä¸€ä¸ªå¯¼å‡ºåŠŸèƒ½ï¼Œæ‹¥æœ‰ç®¡ç†å‘˜æƒé™çš„äººå‡ ä¹æ²¡æœ‰é™åˆ¶ï¼Œé€ æˆäº†å…¨è¡¨æŸ¥ï¼Œå†åŠ ä¸Šæ¡†æ¶ç¦æ­¢joinï¼Œæ‰€ä»¥åˆæŠŠå¤–é”®æ‹‰å‡ºæ¥åšäº†ä¸€æ¬¡inæŸ¥è¯¢ï¼Œä¹Ÿæ˜¯å…¨è¡¨æ‰«ï¼Œå¤§é‡çš„Boå¯¹è±¡å’Œè¶…é•¿sqlï¼Œç›´æ¥æŠŠç³»ç»Ÿoomäº†","like_count":7,"discussions":[{"author":{"id":1001470,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/fe/d0e25d57.jpg","nickname":"æœ±æ™”","note":"","ucode":"0B7F0BADE6AAB8","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492213,"discussion_content":"å¾ˆå¸¸è§çš„é—®é¢˜ï¼Œè¿˜æœ‰åŒ…æ‹¬å‚æ•°æœªä¼ å¯¼è‡´mybatisæ¡ä»¶æ²¡æœ‰æ‹¼æ¥ä¸Šå»ï¼Œå¯¼è‡´å…¨è¡¨æŸ¥è¯¢çš„oom","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587167410,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1253978,"avatar":"https://static001.geekbang.org/account/avatar/00/13/22/5a/450ba91e.jpg","nickname":"å–ç«æŸ´çš„ç”·äºº","note":"","ucode":"F12AE47D039883","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1001470,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/fe/d0e25d57.jpg","nickname":"æœ±æ™”","note":"","ucode":"0B7F0BADE6AAB8","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":549424,"discussion_content":"åˆšè§£å†³äº†ä¸€ä¸ªå‚æ•°æœªä¼ å…¥ï¼Œæ¯æ¬¡7ä¸‡æ¡æ•°æ®å¯¼è‡´oom","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1643968395,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":492213,"ip_address":""},"score":549424,"extra":""}]},{"author":{"id":1274117,"avatar":"https://static001.geekbang.org/account/avatar/00/13/71/05/db554eba.jpg","nickname":"ğŸ‘½","note":"","ucode":"D313AF941B412D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":238087,"discussion_content":"è¿™ç§ä¸šåŠ¡ï¼Œå¯ä»¥ä¸å¯ä»¥è€ƒè™‘ï¼Œå¼ºåˆ¶åˆ†é¡µï¼Œå¹¶ä¸”è®¾å®šæœ€å¤§åˆ†é¡µé•¿åº¦ã€‚\nç±»ä¼¼äºMybatisPluså°±æœ‰è®¾å®šæœ€å¤§å•é¡µæ•°æ®é•¿åº¦çš„ã€‚ä¾‹å¦‚è®¾ç½®ä¸ª1000ï¼Œä¿è¯æŸ¥è¯¢å‡ºæ¥çš„æ•°é‡æ— è®ºå¦‚ä½•éƒ½ä¸ä¼šå¤ªå¤¸å¼ ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587210353,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":210298,"user_name":"ä¸èƒ½å¿çš„åœ°ç²¾","can_delete":false,"product_type":"c1","uid":1754913,"ip_address":"","ucode":"66A921C0BC8102","user_header":"","comment_is_top":false,"comment_ctime":1587716502,"is_pvip":false,"replies":[{"id":"78380","content":"ğŸ˜¥","user_name":"ä½œè€…å›å¤","comment_id":210298,"uid":"1001470","ip_address":"","utype":1,"ctime":1587725965,"user_name_real":"æœ±æ™”"}],"discussion_count":1,"race_medal":0,"score":"14472618390","product_id":100047701,"comment_content":"æˆ‘é‡åˆ°ä¸€ä¸ªOOM,æ˜¯è¿™æ ·çš„<br>1. é¦–å…ˆæœ‰ä¸€ä¸ªçº¿ç¨‹æ± ,çº¿ç¨‹æ•°é‡æ˜¯20ä¸ª,ä½†æ˜¯çº¿ç¨‹é˜Ÿåˆ—å®¹å™¨çš„æ•°é‡æ˜¯Integerçš„æœ€å¤§å€¼,æ‰€ä»¥æ‹’ç»ç­–ç•¥å‡ ä¹æ— æ•ˆ,å¤§æ¦‚æ²¡è¿‡3ç§’å¾€çº¿ç¨‹æ± æäº¤3ä¸ªä»»åŠ¡<br>2. ä»»åŠ¡é‡Œé¢æœ‰ä¸€ä¸ªRestemplate,æ²¡æœ‰è®¾ç½®è¶…æ—¶æ—¶é—´,è¶…æ—¶æ—¶é—´ä¸º-1,å¹¶ä¸”é‡Œé¢ç»´æŠ¤çš„è¿æ¥æ± æ˜¯5ä¸ª,å°äºçº¿ç¨‹æ± æ•°é‡<br>3. å‡ºç°5ä¸ªè¿æ¥éƒ½è¶…æ—¶,ä»»åŠ¡å¡ä½äº†,ä½†æ˜¯è¿˜æ˜¯ä¸æ–­çš„å¾€ä»»åŠ¡é˜Ÿåˆ—é‡Œé¢æ·»åŠ ä»»åŠ¡,æœ€ç»ˆå¯¼è‡´OOM","like_count":4,"discussions":[{"author":{"id":1001470,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/fe/d0e25d57.jpg","nickname":"æœ±æ™”","note":"","ucode":"0B7F0BADE6AAB8","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492996,"discussion_content":"ğŸ˜¥","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587725965,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":208353,"user_name":"ddosyang","can_delete":false,"product_type":"c1","uid":1903226,"ip_address":"","ucode":"DE0FBAB888AA7F","user_header":"","comment_is_top":false,"comment_ctime":1587344091,"is_pvip":false,"replies":[{"id":"77813","content":"æ˜¯ï¼Œä¸è¿‡è¿™å°±æ”¹äº†è®¾è®¡äº†","user_name":"ä½œè€…å›å¤","comment_id":208353,"uid":"1001470","ip_address":"","utype":1,"ctime":1587346124,"user_name_real":"æœ±æ™”"}],"discussion_count":1,"race_medal":0,"score":"10177278683","product_id":100047701,"comment_content":"è€å¸ˆæƒ³é—®ä¸€ä¸‹ï¼Œåœ¨WeakHashMapçš„é‚£ä¸ªä¾‹å­é‡Œï¼Œå¯ä¸å¯ä»¥ç›´æ¥ç”¨String nameå½“ä½œKeyï¼Œè€Œä¸æ˜¯ç”¨UseråšKeyã€‚è¿™æ ·æ˜¯ä¸æ˜¯ä¹Ÿå¯ä»¥è§£å†³é—®é¢˜ï¼Ÿ","like_count":2,"discussions":[{"author":{"id":1001470,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/fe/d0e25d57.jpg","nickname":"æœ±æ™”","note":"","ucode":"0B7F0BADE6AAB8","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492431,"discussion_content":"æ˜¯ï¼Œä¸è¿‡è¿™å°±æ”¹äº†è®¾è®¡äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587346124,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":207744,"user_name":"è‡ªç”±æ¸¯","can_delete":false,"product_type":"c1","uid":1086779,"ip_address":"","ucode":"EA1AFDB9123747","user_header":"https://static001.geekbang.org/account/avatar/00/10/95/3b/a7c94a53.jpg","comment_is_top":false,"comment_ctime":1587172122,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10177106714","product_id":100047701,"comment_content":"å…³äºç¬¬äºŒä¸ªå‘é¢˜é™åˆ¶äº†metadataçš„å †å¤§å°ï¼Œå‘ç°å°±å¯è‡ªåŠ¨å›æ”¶äº†","like_count":2},{"had_liked":false,"id":224230,"user_name":"Carisy","can_delete":false,"product_type":"c1","uid":1657429,"ip_address":"","ucode":"67E887967347BA","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLwTZdUafC5YM7bCASt8icUnoyYfV4hUHulexibDI7B4eaokTxYXHFtoic97DBlCAU9j5Jw4QUuGhyZQ/132","comment_is_top":false,"comment_ctime":1591320050,"is_pvip":false,"replies":[{"id":"82556","content":"buffersæ˜¯æŒ‡ä»€ä¹ˆbufferï¼Ÿè¿™ä¸ªå’ŒCompletableFutureæ²¡æœ‰å…³ç³»ï¼Œä¸Šä¼ ä¸‹è½½éƒ½ä¼šç”¨åˆ°ç¼“å†²åŒºï¼Œå¦‚æœå¹¶å‘å¤§çš„è¯å¯èƒ½æ˜¯ä¼šOOM","user_name":"ä½œè€…å›å¤","comment_id":224230,"uid":"1001470","ip_address":"","utype":1,"ctime":1591324507,"user_name_real":"æœ±æ™”"}],"discussion_count":1,"race_medal":0,"score":"5886287346","product_id":100047701,"comment_content":"è€å¸ˆè¯·æ•™ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨ä½¿ç”¨CompletableFutureçš„æ—¶å€™å‡ºç°äº†å¾ˆå¥‡æ€ªçš„åœºæ™¯ï¼Œå°±æ˜¯buffersé£™å‡å‡ºç°oomï¼Œåº”ç”¨ç¨‹åºä½¿ç”¨å†…å­˜å¹¶ä¸å¤šï¼Œå¤„ç†é€»è¾‘ä¹Ÿç›¸å¯¹ç®€å•å°±æ˜¯è°ƒç”¨æ¥å£é€šè¿‡httpä¸Šä¼ ä¸‹è½½æ–‡ä»¶","like_count":1,"discussions":[{"author":{"id":1001470,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/fe/d0e25d57.jpg","nickname":"æœ±æ™”","note":"","ucode":"0B7F0BADE6AAB8","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":497408,"discussion_content":"buffersæ˜¯æŒ‡ä»€ä¹ˆbufferï¼Ÿè¿™ä¸ªå’ŒCompletableFutureæ²¡æœ‰å…³ç³»ï¼Œä¸Šä¼ ä¸‹è½½éƒ½ä¼šç”¨åˆ°ç¼“å†²åŒºï¼Œå¦‚æœå¹¶å‘å¤§çš„è¯å¯èƒ½æ˜¯ä¼šOOM","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591324507,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":207719,"user_name":"pedro","can_delete":false,"product_type":"c1","uid":1200704,"ip_address":"","ucode":"F40C839DDFD599","user_header":"https://static001.geekbang.org/account/avatar/00/12/52/40/e57a736e.jpg","comment_is_top":false,"comment_ctime":1587166161,"is_pvip":false,"replies":[{"id":"77570","content":"ä¸å¤ªå¯¹ï¼Œå¯ä»¥å†æŸ¥ä¸€äº›èµ„æ–™æˆ–åšä¸€äº›å®éªŒçœ‹ä¸‹è½¯å’Œå¼±çš„åŒºåˆ«","user_name":"ä½œè€…å›å¤","comment_id":207719,"uid":"1001470","ip_address":"","utype":1,"ctime":1587173889,"user_name_real":"æœ±æ™”"}],"discussion_count":3,"race_medal":0,"score":"5882133457","product_id":100047701,"comment_content":"é—®é¢˜ä¸€ï¼Œå¼±å¼•ç”¨æ˜¯åœ¨å†…å­˜ä¸è¶³æ—¶è¢« gc æ‰ï¼Œè€Œè½¯å¼•ç”¨æ˜¯åªè¦ gc å°±å›æ”¶æ‰ï¼Œè‡ªç„¶å°±ä¸èƒ½ç”¨æ¥åšç¼“å­˜ï¼Œå¦åˆ™åŠ¨ä¸åŠ¨å°±ç¼“å­˜å¤±æ•ˆï¼Œæ•°æ®åº“æ€•æ˜¯è¦è¢«ç©åå“¦ï¼Œå› ä¸ºé€‚åˆåšç¼“å­˜çš„æ˜¯å¼±å¼•ç”¨ã€‚<br>é—®é¢˜äºŒï¼Œæ²¡ç”¨è¿‡ groovyï¼Œå¸Œæœ›çœ‹åˆ°åˆ«äººçš„è§£ç­”ã€‚ğŸ˜„","like_count":1,"discussions":[{"author":{"id":1001470,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/fe/d0e25d57.jpg","nickname":"æœ±æ™”","note":"","ucode":"0B7F0BADE6AAB8","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492222,"discussion_content":"ä¸å¤ªå¯¹ï¼Œå¯ä»¥å†æŸ¥ä¸€äº›èµ„æ–™æˆ–åšä¸€äº›å®éªŒçœ‹ä¸‹è½¯å’Œå¼±çš„åŒºåˆ«","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587173889,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1200704,"avatar":"https://static001.geekbang.org/account/avatar/00/12/52/40/e57a736e.jpg","nickname":"pedro","note":"","ucode":"F40C839DDFD599","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":237693,"discussion_content":"å„ä½ä¸å¥½æ„æ€ï¼Œè½¯å¼•ç”¨å’Œå¼±å¼•ç”¨æˆ‘ç¡®å®æåäº†ï¼Œå¹´çºªå¤§äº†ï¼Œå¤§å®¶æ‹…å¾…ä¸€ä¸‹ğŸ˜“","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1587178145,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1211223,"avatar":"https://static001.geekbang.org/account/avatar/00/12/7b/57/a9b04544.jpg","nickname":"QQæ€ª","note":"","ucode":"1A39B8433D9208","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":237671,"discussion_content":"è€å“¥ç¬¬ä¸€ä¸ªè¯´åäº†","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1587177234,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":211800,"user_name":"æ—…é€”","can_delete":false,"product_type":"c1","uid":1212902,"ip_address":"","ucode":"5022477E8E9441","user_header":"https://static001.geekbang.org/account/avatar/00/12/81/e6/6cafed37.jpg","comment_is_top":false,"comment_ctime":1588012034,"is_pvip":false,"replies":[{"id":"78689","content":"è¿™ä¸ªå¼‚å¸¸åŸå› æ˜¯è¯·æ±‚å¤´æ•°æ®è¿‡å¤§è¶…è¿‡äº†é™åˆ¶ ä¸æ˜¯æŒ‡tomcatè¯·æ±‚å¤´å‚æ•°é…ç½®è¿‡å¤§","user_name":"ä½œè€…å›å¤","comment_id":211800,"uid":"1001470","ip_address":"","utype":1,"ctime":1588031405,"user_name_real":"æœ±æ™”"}],"discussion_count":2,"race_medal":0,"score":"1588012034","product_id":100047701,"comment_content":"æœ‰ç‚¹æ²¡æ‡‚ java.lang.IllegalArgumentException: Request header is too large çš„æ„æ€ä¸å°±æ˜¯request headerè¿‡å¤§äº†ä¹ˆ ä¸ºä»€ä¹ˆå¼€å‘äººå‘˜è¿˜è®¾ç½®çš„é‚£ä¹ˆå¤§ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1001470,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/fe/d0e25d57.jpg","nickname":"æœ±æ™”","note":"","ucode":"0B7F0BADE6AAB8","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493371,"discussion_content":"è¿™ä¸ªå¼‚å¸¸åŸå› æ˜¯è¯·æ±‚å¤´æ•°æ®è¿‡å¤§è¶…è¿‡äº†é™åˆ¶ ä¸æ˜¯æŒ‡tomcatè¯·æ±‚å¤´å‚æ•°é…ç½®è¿‡å¤§","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588031405,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1212902,"avatar":"https://static001.geekbang.org/account/avatar/00/12/81/e6/6cafed37.jpg","nickname":"æ—…é€”","note":"","ucode":"5022477E8E9441","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":250913,"discussion_content":"æ˜ç™½äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588049850,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":208365,"user_name":"yang","can_delete":false,"product_type":"c1","uid":1227722,"ip_address":"","ucode":"45C1BE2D4AD72B","user_header":"https://static001.geekbang.org/account/avatar/00/12/bb/ca/86d58e40.jpg","comment_is_top":false,"comment_ctime":1587345480,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1587345480","product_id":100047701,"comment_content":"æŠ€æœ¯æ–¹æ¡ˆä¹Ÿå¤Ÿå¥‡è‘©çš„------------æ€ä¹ˆè®¾è®¡å‡ºæ¥çš„-----~-~----","like_count":0},{"had_liked":false,"id":207781,"user_name":"Geek_3b1096","can_delete":false,"product_type":"c1","uid":1549364,"ip_address":"","ucode":"A6BD92B79B3632","user_header":"","comment_is_top":false,"comment_ctime":1587178668,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1587178668","product_id":100047701,"comment_content":"å‘¨å…­ç¬¬ä¸€ä»¶äº‹è·Ÿä¸Šè€å¸ˆè¿›åº¦","like_count":1,"discussions":[{"author":{"id":1161368,"avatar":"https://static001.geekbang.org/account/avatar/00/11/b8/98/ce254cef.jpg","nickname":"æ¶Ÿæ¼ª","note":"","ucode":"2D643A25097FF5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":251480,"discussion_content":"æ¯”è¾ƒé¢‘ç¹çš„httpè¯·æ±‚ä¹Ÿé‡åˆ°è¿‡ã€‚è‡³ä»Šæ²¡æœ‰æ‰¾åˆ°é—®é¢˜å‡ºåœ¨å“ªé‡Œ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588086036,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}