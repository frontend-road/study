{"id":478192,"title":"34ï½œå¹¶å‘ï¼šå¦‚ä½•ä½¿ç”¨å…±äº«å˜é‡ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯Tony Baiã€‚</p><p>åœ¨å‰é¢çš„è®²è§£ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†Goçš„å¹¶å‘å®ç°æ–¹æ¡ˆï¼ŒçŸ¥é“äº†GoåŸºäºTony Hoareçš„<strong>CSPå¹¶å‘æ¨¡å‹</strong>ç†è®ºï¼Œå®ç°äº†Goroutineã€channelç­‰å¹¶å‘åŸè¯­ã€‚</p><p>å¹¶ä¸”ï¼ŒGoè¯­è¨€ä¹‹çˆ¶Rob Pikeè¿˜æœ‰ä¸€å¥ç»å…¸åè¨€ï¼šâ€œä¸è¦é€šè¿‡å…±äº«å†…å­˜æ¥é€šä¿¡ï¼Œåº”è¯¥é€šè¿‡é€šä¿¡æ¥å…±äº«å†…å­˜ï¼ˆDonâ€™t communicate by sharing memory, share memory by communicatingï¼‰â€ï¼Œè¿™å°±å¥ å®šäº†Goåº”ç”¨å¹¶å‘è®¾è®¡çš„ä¸»æµé£æ ¼ï¼š<strong>ä½¿ç”¨channelè¿›è¡Œä¸åŒGoroutineé—´çš„é€šä¿¡</strong>ã€‚</p><p>ä¸è¿‡ï¼ŒGoä¹Ÿå¹¶æ²¡æœ‰å½»åº•æ”¾å¼ƒåŸºäºå…±äº«å†…å­˜çš„å¹¶å‘æ¨¡å‹ï¼Œè€Œæ˜¯åœ¨æä¾›CSPå¹¶å‘æ¨¡å‹åŸè¯­çš„åŒæ—¶ï¼Œè¿˜é€šè¿‡æ ‡å‡†åº“çš„syncåŒ…ï¼Œæä¾›äº†é’ˆå¯¹ä¼ ç»Ÿçš„ã€åŸºäºå…±äº«å†…å­˜å¹¶å‘æ¨¡å‹çš„ä½çº§åŒæ­¥åŸè¯­ï¼ŒåŒ…æ‹¬ï¼šäº’æ–¥é”ï¼ˆsync.Mutexï¼‰ã€è¯»å†™é”ï¼ˆsync.RWMutexï¼‰ã€æ¡ä»¶å˜é‡ï¼ˆsync.Condï¼‰ç­‰ï¼Œå¹¶é€šè¿‡atomicåŒ…æä¾›äº†åŸå­æ“ä½œåŸè¯­ç­‰ç­‰ã€‚æ˜¾ç„¶ï¼ŒåŸºäºå…±äº«å†…å­˜çš„å¹¶å‘æ¨¡å‹åœ¨Goè¯­è¨€ä¸­ä¾ç„¶æœ‰å®ƒçš„â€œç”¨æ­¦ä¹‹åœ°â€ã€‚</p><p>æ‰€ä»¥ï¼Œåœ¨å¹¶å‘çš„æœ€åä¸€è®²ï¼Œæˆ‘ä»¬å°±å›´ç»•syncåŒ…ä¸­çš„å‡ ä¸ªåŒæ­¥ç»“æ„ä¸å¯¹åº”çš„æ–¹æ³•ï¼ŒèŠèŠåŸºäºå…±äº«å†…å­˜çš„å¹¶å‘æ¨¡å‹åœ¨Goä¸­çš„åº”ç”¨ã€‚</p><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨å“ªäº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ç”¨åˆ°syncåŒ…æä¾›çš„ä½çº§åŒæ­¥åŸè¯­ã€‚</p><!-- [[[read_end]]] --><h2>syncåŒ…ä½çº§åŒæ­¥åŸè¯­å¯ä»¥ç”¨åœ¨å“ªï¼Ÿ</h2><p>è¿™é‡Œæˆ‘è¦å…ˆå¼ºè°ƒä¸€å¥ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘å»ºè®®ä½ ä¼˜å…ˆä½¿ç”¨CSPå¹¶å‘æ¨¡å‹è¿›è¡Œå¹¶å‘ç¨‹åºè®¾è®¡ã€‚ä½†æ˜¯åœ¨ä¸‹é¢ä¸€äº›åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬ä¾ç„¶éœ€è¦syncåŒ…æä¾›çš„ä½çº§åŒæ­¥åŸè¯­ã€‚</p><p><strong>é¦–å…ˆæ˜¯éœ€è¦é«˜æ€§èƒ½çš„ä¸´ç•ŒåŒºï¼ˆcritical sectionï¼‰åŒæ­¥æœºåˆ¶åœºæ™¯ã€‚</strong></p><p>åœ¨Goä¸­ï¼Œchannelå¹¶å‘åŸè¯­ä¹Ÿå¯ä»¥ç”¨äºå¯¹æ•°æ®å¯¹è±¡è®¿é—®çš„åŒæ­¥ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠchannelçœ‹æˆæ˜¯ä¸€ç§é«˜çº§çš„åŒæ­¥åŸè¯­ï¼Œå®ƒè‡ªèº«çš„å®ç°ä¹Ÿæ˜¯å»ºæ„åœ¨ä½çº§åŒæ­¥åŸè¯­ä¹‹ä¸Šçš„ã€‚ä¹Ÿæ­£å› ä¸ºå¦‚æ­¤ï¼Œchannelè‡ªèº«çš„æ€§èƒ½ä¸ä½çº§åŒæ­¥åŸè¯­ç›¸æ¯”è¦ç•¥å¾®é€Šè‰²ï¼Œå¼€é”€è¦æ›´å¤§ã€‚</p><p>è¿™é‡Œï¼Œå…³äºsync.Mutexå’Œchannelå„è‡ªå®ç°çš„ä¸´ç•ŒåŒºåŒæ­¥æœºåˆ¶ï¼Œæˆ‘åšäº†ä¸€ä¸ªç®€å•çš„æ€§èƒ½åŸºå‡†æµ‹è¯•å¯¹æ¯”ï¼Œé€šè¿‡å¯¹æ¯”ç»“æœï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çœ‹å‡ºä¸¤è€…çš„æ€§èƒ½å·®å¼‚ï¼š</p><pre><code class=\"language-plain\">var cs = 0 // æ¨¡æ‹Ÿä¸´ç•ŒåŒºè¦ä¿æŠ¤çš„æ•°æ®\nvar mu sync.Mutex\nvar c = make(chan struct{}, 1)\n\nfunc criticalSectionSyncByMutex() {\n    mu.Lock()\n    cs++\n    mu.Unlock()\n}\n\nfunc criticalSectionSyncByChan() {\n    c &lt;- struct{}{}\n    cs++\n    &lt;-c\n}\n\nfunc BenchmarkCriticalSectionSyncByMutex(b *testing.B) {\n    for n := 0; n &lt; b.N; n++ {\n        criticalSectionSyncByMutex()\n    }\n}\n\nfunc BenchmarkCriticalSectionSyncByMutexInParallel(b *testing.B) {\n    b.RunParallel(func(pb *testing.PB) {\n        for pb.Next() {\n            criticalSectionSyncByMutex()\n        }\n    })\n}\n\nfunc BenchmarkCriticalSectionSyncByChan(b *testing.B) {\n    for n := 0; n &lt; b.N; n++ {\n        criticalSectionSyncByChan()\n    }\n}\n\nfunc BenchmarkCriticalSectionSyncByChanInParallel(b *testing.B) {\n    b.RunParallel(func(pb *testing.PB) {\n        for pb.Next() {\n            criticalSectionSyncByChan()\n        }\n    })\n}\n</code></pre><p>è¿è¡Œè¿™ä¸ªå¯¹æ¯”æµ‹è¯•ï¼ˆGo 1.17ï¼‰ï¼Œæˆ‘ä»¬å¾—åˆ°ï¼š</p><pre><code class=\"language-plain\">$go test -bench .\ngoos: darwin\ngoarch: amd64\n... ...\nBenchmarkCriticalSectionSyncByMutex-8             \t88083549\t        13.64 ns/op\nBenchmarkCriticalSectionSyncByMutexInParallel-8   \t22337848\t        55.29 ns/op\nBenchmarkCriticalSectionSyncByChan-8              \t28172056\t        42.48 ns/op\nBenchmarkCriticalSectionSyncByChanInParallel-8    \t 5722972\t       208.1 ns/op\nPASS\n</code></pre><p>é€šè¿‡è¿™ä¸ªå¯¹æ¯”å®éªŒï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ— è®ºæ˜¯åœ¨å•Goroutineæƒ…å†µä¸‹ï¼Œè¿˜æ˜¯åœ¨å¹¶å‘æµ‹è¯•æƒ…å†µä¸‹ï¼Œ<code>sync.Mutex</code>å®ç°çš„åŒæ­¥æœºåˆ¶çš„æ€§èƒ½ï¼Œéƒ½è¦æ¯”channelå®ç°çš„é«˜å‡ºä¸‰å€å¤šã€‚</p><p>å› æ­¤ï¼Œé€šå¸¸åœ¨éœ€è¦é«˜æ€§èƒ½çš„ä¸´ç•ŒåŒºï¼ˆcritical sectionï¼‰åŒæ­¥æœºåˆ¶çš„æƒ…å†µä¸‹ï¼ŒsyncåŒ…æä¾›çš„ä½çº§åŒæ­¥åŸè¯­æ›´ä¸ºé€‚åˆã€‚</p><p><strong>ç¬¬äºŒç§å°±æ˜¯åœ¨ä¸æƒ³è½¬ç§»ç»“æ„ä½“å¯¹è±¡æ‰€æœ‰æƒï¼Œä½†åˆè¦ä¿è¯ç»“æ„ä½“å†…éƒ¨çŠ¶æ€æ•°æ®çš„åŒæ­¥è®¿é—®çš„åœºæ™¯ã€‚</strong></p><p>åŸºäºchannelçš„å¹¶å‘è®¾è®¡ï¼Œæœ‰ä¸€ä¸ªç‰¹ç‚¹ï¼šåœ¨Goroutineé—´é€šè¿‡channelè½¬ç§»æ•°æ®å¯¹è±¡çš„æ‰€æœ‰æƒã€‚æ‰€ä»¥ï¼Œåªæœ‰æ‹¥æœ‰æ•°æ®å¯¹è±¡æ‰€æœ‰æƒï¼ˆä»channelæ¥æ”¶åˆ°è¯¥æ•°æ®ï¼‰çš„Goroutineæ‰å¯ä»¥å¯¹è¯¥æ•°æ®å¯¹è±¡è¿›è¡ŒçŠ¶æ€å˜æ›´ã€‚</p><p>å¦‚æœä½ çš„è®¾è®¡ä¸­æ²¡æœ‰è½¬ç§»ç»“æ„ä½“å¯¹è±¡æ‰€æœ‰æƒï¼Œä½†åˆè¦ä¿è¯ç»“æ„ä½“å†…éƒ¨çŠ¶æ€æ•°æ®åœ¨å¤šä¸ªGoroutineä¹‹é—´åŒæ­¥è®¿é—®ï¼Œé‚£ä¹ˆä½ å¯ä»¥ä½¿ç”¨syncåŒ…æä¾›çš„ä½çº§åŒæ­¥åŸè¯­æ¥å®ç°ï¼Œæ¯”å¦‚æœ€å¸¸ç”¨çš„<code>sync.Mutex</code>ã€‚</p><p>äº†è§£äº†è¿™äº›åº”ç”¨åœºæ™¯ä¹‹åï¼Œæ¥ç€æˆ‘ä»¬å°±æ¥çœ‹çœ‹å¦‚ä½•ä½¿ç”¨syncåŒ…ä¸­çš„å„ä¸ªåŒæ­¥ç»“æ„ï¼Œä¸è¿‡åœ¨ä½¿ç”¨ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆçœ‹çœ‹ä¸€ä¸ªsyncåŒ…ä¸­åŒæ­¥åŸè¯­ä½¿ç”¨çš„æ³¨æ„äº‹é¡¹ã€‚</p><h2>syncåŒ…ä¸­åŒæ­¥åŸè¯­ä½¿ç”¨çš„æ³¨æ„äº‹é¡¹</h2><p>åœ¨syncåŒ…çš„æ³¨é‡Šä¸­ï¼ˆåœ¨<code>$GOROOT/src/sync/mutex.go</code>æ–‡ä»¶çš„å¤´éƒ¨æ³¨é‡Šï¼‰ï¼Œæˆ‘ä»¬çœ‹åˆ°è¿™æ ·ä¸€è¡Œè¯´æ˜ï¼š</p><pre><code class=\"language-plain\">// Values containing the types defined in this package should not be copied.\n</code></pre><p>ç¿»è¯‘è¿‡æ¥å°±æ˜¯ï¼šâ€œä¸åº”å¤åˆ¶é‚£äº›åŒ…å«äº†æ­¤åŒ…ä¸­ç±»å‹çš„å€¼â€ã€‚</p><p>åœ¨syncåŒ…çš„å…¶ä»–æºæ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬åŒæ ·çœ‹åˆ°ç±»ä¼¼çš„ä¸€äº›æ³¨é‡Šï¼š</p><pre><code class=\"language-plain\">\n// $GOROOT/src/sync/mutex.go\n// A Mutex must not be copied after first use. ï¼ˆç¦æ­¢å¤åˆ¶é¦–æ¬¡ä½¿ç”¨åçš„Mutexï¼‰\n\n// $GOROOT/src/sync/rwmutex.go\n// A RWMutex must not be copied after first use.ï¼ˆç¦æ­¢å¤åˆ¶é¦–æ¬¡ä½¿ç”¨åçš„RWMutexï¼‰\n\n// $GOROOT/src/sync/cond.go\n// A Cond must not be copied after first use.ï¼ˆç¦æ­¢å¤åˆ¶é¦–æ¬¡ä½¿ç”¨åçš„Condï¼‰\n... ...\n</code></pre><p>é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆé¦–æ¬¡ä½¿ç”¨Mutexç­‰syncåŒ…ä¸­å®šä¹‰çš„ç»“æ„ç±»å‹åï¼Œæˆ‘ä»¬ä¸åº”è¯¥å†å¯¹å®ƒä»¬è¿›è¡Œå¤åˆ¶æ“ä½œå‘¢ï¼Ÿæˆ‘ä»¬ä»¥Mutexè¿™ä¸ªåŒæ­¥åŸè¯­ä¸ºä¾‹ï¼Œçœ‹çœ‹å®ƒçš„å®ç°æ˜¯æ€æ ·çš„ã€‚</p><p>Goæ ‡å‡†åº“ä¸­sync.Mutexçš„å®šä¹‰æ˜¯è¿™æ ·çš„ï¼š</p><pre><code class=\"language-plain\">// $GOROOT/src/sync/mutex.go\ntype Mutex struct {\n    state int32\n    sema  uint32\n}\n</code></pre><p>æˆ‘ä»¬çœ‹åˆ°ï¼ŒMutexçš„å®šä¹‰éå¸¸ç®€å•ï¼Œç”±ä¸¤ä¸ªæ•´å‹å­—æ®µstateå’Œsemaç»„æˆï¼š</p><ul>\n<li>stateï¼šè¡¨ç¤ºå½“å‰äº’æ–¥é”çš„çŠ¶æ€ï¼›</li>\n<li>semaï¼šç”¨äºæ§åˆ¶é”çŠ¶æ€çš„ä¿¡å·é‡ã€‚</li>\n</ul><p>åˆå§‹æƒ…å†µä¸‹ï¼ŒMutexçš„å®ä¾‹å¤„äº<strong>Unlocked</strong>çŠ¶æ€ï¼ˆstateå’Œsemaå‡ä¸º0ï¼‰ã€‚å¯¹Mutexå®ä¾‹çš„å¤åˆ¶ä¹Ÿå°±æ˜¯ä¸¤ä¸ªæ•´å‹å­—æ®µçš„å¤åˆ¶ã€‚ä¸€æ—¦å‘ç”Ÿå¤åˆ¶ï¼ŒåŸå˜é‡ä¸å‰¯æœ¬å°±æ˜¯ä¸¤ä¸ªå•ç‹¬çš„å†…å­˜å—ï¼Œå„è‡ªå‘æŒ¥åŒæ­¥ä½œç”¨ï¼Œäº’ç›¸å°±æ²¡æœ‰äº†å…³è”ã€‚</p><p>å¦‚æœå‘ç”Ÿå¤åˆ¶åï¼Œä½ ä»ç„¶è®¤ä¸ºåŸå˜é‡ä¸å‰¯æœ¬ä¿æŠ¤çš„æ˜¯åŒä¸€ä¸ªæ•°æ®å¯¹è±¡ï¼Œé‚£å¯å°±å¤§é”™ç‰¹é”™äº†ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p><pre><code class=\"language-plain\"> func main() {\n     var wg sync.WaitGroup\n     i := 0\n     var mu sync.Mutex // è´Ÿè´£å¯¹içš„åŒæ­¥è®¿é—®\n \n     wg.Add(1)\n     // g1\n     go func(mu1 sync.Mutex) {\n         mu1.Lock()\n         i = 10\n         time.Sleep(10 * time.Second)\n         fmt.Printf(\"g1: i = %d\\n\", i)\n         mu1.Unlock()\n         wg.Done()\n     }(mu)\n \n     time.Sleep(time.Second)\n \n     mu.Lock()\n     i = 1\n     fmt.Printf(\"g0: i = %d\\n\", i)\n     mu.Unlock()\n \n     wg.Wait()\n }\n</code></pre><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªsync.Mutexç±»å‹å˜é‡muæ¥åŒæ­¥å¯¹æ•´å‹å˜é‡içš„è®¿é—®ã€‚æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°Goroutineï¼šg1ï¼Œg1é€šè¿‡å‡½æ•°å‚æ•°å¾—åˆ°muçš„ä¸€ä»½æ‹·è´mu1ï¼Œç„¶åg1ä¼šé€šè¿‡mu1æ¥åŒæ­¥å¯¹æ•´å‹å˜é‡içš„è®¿é—®ã€‚</p><p>é‚£ä¹ˆï¼Œg0é€šè¿‡muå’Œg1é€šè¿‡muçš„æ‹·è´mu1ï¼Œæ˜¯å¦èƒ½å®ç°å¯¹åŒä¸€ä¸ªå˜é‡içš„åŒæ­¥è®¿é—®å‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹çœ‹è¿è¡Œè¿™ä¸ªç¤ºä¾‹çš„è¿è¡Œç»“æœï¼š</p><pre><code class=\"language-plain\">g0: i = 1\ng1: i = 1\n</code></pre><p>ä»ç»“æœæ¥çœ‹ï¼Œè¿™ä¸ªç¨‹åºå¹¶æ²¡æœ‰å®ç°å¯¹içš„åŒæ­¥è®¿é—®ï¼Œç¬¬9è¡Œg1å¯¹mu1çš„åŠ é”æ“ä½œï¼Œå¹¶æ²¡èƒ½é˜»å¡ç¬¬19è¡Œg0å¯¹muçš„åŠ é”ã€‚äºæ˜¯ï¼Œg1åˆšåˆšå°†ièµ‹å€¼ä¸º10åï¼Œg0å°±åˆå°†ièµ‹å€¼ä¸º1äº†ã€‚</p><p>å‡ºç°è¿™ç§ç»“æœçš„åŸå› å°±æ˜¯æˆ‘ä»¬å‰é¢åˆ†æçš„æƒ…å†µï¼Œä¸€æ—¦Mutexç±»å‹å˜é‡è¢«æ‹·è´ï¼ŒåŸå˜é‡ä¸å‰¯æœ¬å°±å„è‡ªå‘æŒ¥ä½œç”¨ï¼Œäº’ç›¸æ²¡æœ‰å…³è”äº†ã€‚ç”šè‡³ï¼Œå¦‚æœæ‹·è´çš„æ—¶æœºä¸å¯¹ï¼Œæ¯”å¦‚åœ¨ä¸€ä¸ªmutexå¤„äºlockedçš„çŠ¶æ€æ—¶å¯¹å®ƒè¿›è¡Œäº†æ‹·è´ï¼Œå°±ä¼šå¯¹å‰¯æœ¬è¿›è¡ŒåŠ é”æ“ä½œï¼Œå°†å¯¼è‡´åŠ é”çš„Goroutineæ°¸è¿œé˜»å¡ä¸‹å»ã€‚</p><p>é€šè¿‡å‰é¢è¿™ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆç›´è§‚åœ°çœ‹åˆ°ï¼šå¦‚æœå¯¹ä½¿ç”¨è¿‡çš„ã€syncåŒ…ä¸­çš„ç±»å‹çš„ç¤ºä¾‹è¿›è¡Œå¤åˆ¶ï¼Œå¹¶ä½¿ç”¨äº†å¤åˆ¶åå¾—åˆ°çš„å‰¯æœ¬ï¼Œå°†å¯¼è‡´ä¸å¯é¢„æœŸçš„ç»“æœã€‚æ‰€ä»¥ï¼Œåœ¨ä½¿ç”¨syncåŒ…ä¸­çš„ç±»å‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ¨èé€šè¿‡<strong>é—­åŒ…</strong>æ–¹å¼ï¼Œæˆ–è€…æ˜¯<strong>ä¼ é€’ç±»å‹å®ä¾‹ï¼ˆæˆ–åŒ…è£¹è¯¥ç±»å‹çš„ç±»å‹å®ä¾‹ï¼‰çš„åœ°å€ï¼ˆæŒ‡é’ˆï¼‰</strong>çš„æ–¹å¼è¿›è¡Œã€‚è¿™å°±æ˜¯ä½¿ç”¨syncåŒ…æ—¶æœ€å€¼å¾—æˆ‘ä»¬æ³¨æ„çš„äº‹é¡¹ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥é€ä¸ªåˆ†ææ—¥å¸¸ä½¿ç”¨è¾ƒå¤šçš„syncåŒ…ä¸­åŒæ­¥åŸè¯­ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹äº’æ–¥é”ä¸è¯»å†™é”ã€‚</p><h2>äº’æ–¥é”ï¼ˆMutexï¼‰è¿˜æ˜¯è¯»å†™é”ï¼ˆRWMutexï¼‰ï¼Ÿ</h2><p>syncåŒ…æä¾›äº†ä¸¤ç§ç”¨äºä¸´ç•ŒåŒºåŒæ­¥çš„åŸè¯­ï¼šäº’æ–¥é”ï¼ˆMutexï¼‰å’Œè¯»å†™é”ï¼ˆRWMutexï¼‰ã€‚å®ƒä»¬éƒ½æ˜¯é›¶å€¼å¯ç”¨çš„æ•°æ®ç±»å‹ï¼Œä¹Ÿå°±æ˜¯ä¸éœ€è¦æ˜¾å¼åˆå§‹åŒ–å°±å¯ä»¥ä½¿ç”¨ï¼Œå¹¶ä¸”ä½¿ç”¨æ–¹æ³•éƒ½æ¯”è¾ƒç®€å•ã€‚åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å·²ç»çœ‹åˆ°äº†Mutexçš„åº”ç”¨æ–¹æ³•ï¼Œè¿™é‡Œå†æ€»ç»“ä¸€ä¸‹ï¼š</p><pre><code class=\"language-plain\">var mu sync.Mutex\nmu.Lock()   // åŠ é”\ndoSomething()\nmu.Unlock() // è§£é”\n</code></pre><p>ä¸€æ—¦æŸä¸ªGoroutineè°ƒç”¨çš„Mutexæ‰§è¡ŒLockæ“ä½œæˆåŠŸï¼Œå®ƒå°†æˆåŠŸæŒæœ‰è¿™æŠŠäº’æ–¥é”ã€‚è¿™ä¸ªæ—¶å€™ï¼Œå¦‚æœæœ‰å…¶ä»–Goroutineæ‰§è¡ŒLockæ“ä½œï¼Œå°±ä¼šé˜»å¡åœ¨è¿™æŠŠäº’æ–¥é”ä¸Šï¼Œç›´åˆ°æŒæœ‰è¿™æŠŠé”çš„Goroutineè°ƒç”¨Unlocké‡Šæ”¾æ‰è¿™æŠŠé”åï¼Œæ‰ä¼šæŠ¢åˆ°è¿™æŠŠé”çš„æŒæœ‰æƒå¹¶è¿›å…¥ä¸´ç•ŒåŒºã€‚</p><p>ç”±æ­¤ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å¾—åˆ°ä½¿ç”¨äº’æ–¥é”çš„ä¸¤ä¸ªåŸåˆ™ï¼š</p><ul>\n<li><strong>å°½é‡å‡å°‘åœ¨é”ä¸­çš„æ“ä½œ</strong>ã€‚è¿™å¯ä»¥å‡å°‘å…¶ä»–å› Goroutineé˜»å¡è€Œå¸¦æ¥çš„æŸè€—ä¸å»¶è¿Ÿã€‚</li>\n<li><strong>ä¸€å®šè¦è®°å¾—è°ƒç”¨Unlockè§£é”</strong>ã€‚å¿˜è®°è§£é”ä¼šå¯¼è‡´ç¨‹åºå±€éƒ¨æ­»é”ï¼Œç”šè‡³æ˜¯æ•´ä¸ªç¨‹åºæ­»é”ï¼Œä¼šå¯¼è‡´ä¸¥é‡çš„åæœã€‚åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç»“åˆç¬¬23è®²å­¦ä¹ åˆ°çš„deferï¼Œä¼˜é›…åœ°æ‰§è¡Œè§£é”æ“ä½œã€‚</li>\n</ul><p>è¯»å†™é”ä¸äº’æ–¥é”ç”¨æ³•å¤§è‡´ç›¸åŒï¼Œåªä¸è¿‡å¤šäº†ä¸€ç»„åŠ è¯»é”å’Œè§£è¯»é”çš„æ–¹æ³•ï¼š</p><pre><code class=\"language-plain\">var rwmu sync.RWMutex\nrwmu.RLock()   //åŠ è¯»é”\nreadSomething()\nrwmu.RUnlock() //è§£è¯»é”\nrwmu.Lock()    //åŠ å†™é”\nchangeSomething()\nrwmu.Unlock()  //è§£å†™é”\n</code></pre><p>å†™é”ä¸Mutexçš„è¡Œä¸ºååˆ†ç±»ä¼¼ï¼Œä¸€æ—¦æŸGoroutineæŒæœ‰å†™é”ï¼Œå…¶ä»–Goroutineæ— è®ºæ˜¯å°è¯•åŠ è¯»é”ï¼Œè¿˜æ˜¯åŠ å†™é”ï¼Œéƒ½ä¼šè¢«é˜»å¡åœ¨å†™é”ä¸Šã€‚</p><p>ä½†è¯»é”å°±å®½æ¾å¤šäº†ï¼Œä¸€æ—¦æŸä¸ªGoroutineæŒæœ‰è¯»é”ï¼Œå®ƒä¸ä¼šé˜»å¡å…¶ä»–å°è¯•åŠ è¯»é”çš„Goroutineï¼Œä½†åŠ å†™é”çš„Goroutineä¾ç„¶ä¼šè¢«é˜»å¡ä½ã€‚</p><p>é€šå¸¸ï¼Œ<strong>äº’æ–¥é”ï¼ˆMutexï¼‰æ˜¯ä¸´æ—¶åŒºåŒæ­¥åŸè¯­çš„é¦–é€‰</strong>ï¼Œå®ƒå¸¸è¢«ç”¨æ¥å¯¹ç»“æ„ä½“å¯¹è±¡çš„å†…éƒ¨çŠ¶æ€ã€ç¼“å­˜ç­‰è¿›è¡Œä¿æŠ¤ï¼Œæ˜¯ä½¿ç”¨æœ€ä¸ºå¹¿æ³›çš„ä¸´ç•ŒåŒºåŒæ­¥åŸè¯­ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œè¯»å†™é”çš„åº”ç”¨å°±æ²¡é‚£ä¹ˆå¹¿æ³›äº†ï¼Œåªæ´»è·ƒäºå®ƒæ“…é•¿çš„åœºæ™¯ä¸‹ã€‚</p><p>é‚£è¯»å†™é”ï¼ˆRWMutexï¼‰ç©¶ç«Ÿæ“…é•¿åœ¨å“ªç§åœºæ™¯ä¸‹å‘¢ï¼Ÿæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ç»„åŸºå‡†æµ‹è¯•ï¼š</p><pre><code class=\"language-plain\">var cs1 = 0 // æ¨¡æ‹Ÿä¸´ç•ŒåŒºè¦ä¿æŠ¤çš„æ•°æ®\nvar mu1 sync.Mutex\n\nvar cs2 = 0 // æ¨¡æ‹Ÿä¸´ç•ŒåŒºè¦ä¿æŠ¤çš„æ•°æ®\nvar mu2 sync.RWMutex\n\nfunc BenchmarkWriteSyncByMutex(b *testing.B) {\n    b.RunParallel(func(pb *testing.PB) {\n        for pb.Next() {\n            mu1.Lock()\n            cs1++\n            mu1.Unlock()\n        }\n    })\n}\n\nfunc BenchmarkReadSyncByMutex(b *testing.B) {\n    b.RunParallel(func(pb *testing.PB) {\n        for pb.Next() {\n            mu1.Lock()\n            _ = cs1\n            mu1.Unlock()\n        }\n    })\n}\n\nfunc BenchmarkReadSyncByRWMutex(b *testing.B) {\n    b.RunParallel(func(pb *testing.PB) {\n        for pb.Next() {\n            mu2.RLock()\n            _ = cs2\n            mu2.RUnlock()\n        }\n    })\n}\n\nfunc BenchmarkWriteSyncByRWMutex(b *testing.B) {\n    b.RunParallel(func(pb *testing.PB) {\n        for pb.Next() {\n            mu2.Lock()\n            cs2++\n            mu2.Unlock()\n        }\n    })\n}\n</code></pre><p>è¿™äº›åŸºå‡†æµ‹è¯•éƒ½æ˜¯å¹¶å‘æµ‹è¯•ï¼Œåº¦é‡çš„æ˜¯Mutexã€RWMutexåœ¨å¹¶å‘ä¸‹çš„è¯»å†™æ€§èƒ½ã€‚æˆ‘ä»¬åˆ†åˆ«åœ¨cpu=2ã€8ã€16ã€32çš„æƒ…å†µä¸‹è¿è¡Œè¿™ä¸ªå¹¶å‘æ€§èƒ½æµ‹è¯•ï¼Œæµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">goos: darwin\ngoarch: amd64\n... ...\nBenchmarkWriteSyncByMutex-2     \t73423770\t        16.12 ns/op\nBenchmarkReadSyncByMutex-2      \t84031135\t        15.08 ns/op\nBenchmarkReadSyncByRWMutex-2    \t37182219\t        31.87 ns/op\nBenchmarkWriteSyncByRWMutex-2   \t40727782\t        29.08 ns/op\n\nBenchmarkWriteSyncByMutex-8     \t22153354\t        56.39 ns/op\nBenchmarkReadSyncByMutex-8      \t24164278\t        51.12 ns/op\nBenchmarkReadSyncByRWMutex-8    \t38589122\t        31.17 ns/op\nBenchmarkWriteSyncByRWMutex-8   \t18482208\t        65.27 ns/op\n\nBenchmarkWriteSyncByMutex-16      \t20672842\t        62.94 ns/op\nBenchmarkReadSyncByMutex-16       \t19247158\t        62.94 ns/op\nBenchmarkReadSyncByRWMutex-16     \t29978614\t        39.98 ns/op\nBenchmarkWriteSyncByRWMutex-16    \t16095952\t        78.19 ns/op\n\nBenchmarkWriteSyncByMutex-32      \t20539290\t        60.20 ns/op\nBenchmarkReadSyncByMutex-32       \t18807060\t        72.61 ns/op\nBenchmarkReadSyncByRWMutex-32     \t29772936\t        40.45 ns/op\nBenchmarkWriteSyncByRWMutex-32    \t13320544\t        86.53 ns/op\n</code></pre><p>é€šè¿‡æµ‹è¯•ç»“æœå¯¹æ¯”ï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸€äº›ç»“è®ºï¼š</p><ul>\n<li>å¹¶å‘é‡è¾ƒå°çš„æƒ…å†µä¸‹ï¼ŒMutexæ€§èƒ½æœ€å¥½ï¼›éšç€å¹¶å‘é‡å¢å¤§ï¼ŒMutexçš„ç«äº‰æ¿€çƒˆï¼Œå¯¼è‡´åŠ é”å’Œè§£é”æ€§èƒ½ä¸‹é™ï¼›</li>\n<li>RWMutexçš„è¯»é”æ€§èƒ½å¹¶æ²¡æœ‰éšç€å¹¶å‘é‡çš„å¢å¤§ï¼Œè€Œå‘ç”Ÿè¾ƒå¤§å˜åŒ–ï¼Œæ€§èƒ½å§‹ç»ˆæ’å®šåœ¨40nså·¦å³ï¼›</li>\n<li>åœ¨å¹¶å‘é‡è¾ƒå¤§çš„æƒ…å†µä¸‹ï¼ŒRWMutexçš„å†™é”æ€§èƒ½å’ŒMutexã€RWMutexè¯»é”ç›¸æ¯”ï¼Œæ˜¯æœ€å·®çš„ï¼Œå¹¶ä¸”éšç€å¹¶å‘é‡å¢å¤§ï¼ŒRWMutexå†™é”æ€§èƒ½æœ‰ç»§ç»­ä¸‹é™è¶‹åŠ¿ã€‚</li>\n</ul><p>ç”±æ­¤ï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹å‡ºï¼Œ<strong>è¯»å†™é”é€‚åˆåº”ç”¨åœ¨å…·æœ‰ä¸€å®šå¹¶å‘é‡ä¸”è¯»å¤šå†™å°‘çš„åœºåˆ</strong>ã€‚åœ¨å¤§é‡å¹¶å‘è¯»çš„æƒ…å†µä¸‹ï¼Œå¤šä¸ªGoroutineå¯ä»¥åŒæ—¶æŒæœ‰è¯»é”ï¼Œä»è€Œå‡å°‘åœ¨é”ç«äº‰ä¸­ç­‰å¾…çš„æ—¶é—´ã€‚</p><p>è€Œäº’æ–¥é”ï¼Œå³ä¾¿æ˜¯è¯»è¯·æ±‚çš„åœºåˆï¼ŒåŒä¸€æ—¶åˆ»ä¹Ÿåªèƒ½æœ‰ä¸€ä¸ªGoroutineæŒæœ‰é”ï¼Œå…¶ä»–Goroutineåªèƒ½é˜»å¡åœ¨åŠ é”æ“ä½œä¸Šç­‰å¾…è¢«è°ƒåº¦ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç»§ç»­çœ‹æ¡ä»¶å˜é‡sync.Condã€‚</p><h2>æ¡ä»¶å˜é‡</h2><p><code>sync.Cond</code>æ˜¯ä¼ ç»Ÿçš„æ¡ä»¶å˜é‡åŸè¯­æ¦‚å¿µåœ¨Goè¯­è¨€ä¸­çš„å®ç°ã€‚æˆ‘ä»¬å¯ä»¥æŠŠä¸€ä¸ªæ¡ä»¶å˜é‡ç†è§£ä¸ºä¸€ä¸ªå®¹å™¨ï¼Œè¿™ä¸ªå®¹å™¨ä¸­å­˜æ”¾ç€ä¸€ä¸ªæˆ–ä¸€ç»„ç­‰å¾…ç€æŸä¸ªæ¡ä»¶æˆç«‹çš„Goroutineã€‚å½“æ¡ä»¶æˆç«‹åï¼Œè¿™äº›å¤„äºç­‰å¾…çŠ¶æ€çš„Goroutineå°†å¾—åˆ°é€šçŸ¥ï¼Œå¹¶è¢«å”¤é†’ç»§ç»­è¿›è¡Œåç»­çš„å·¥ä½œã€‚è¿™ä¸ç™¾ç±³é£äººå¤§æˆ˜èµ›åœºä¸Šï¼Œå„ä½è¿åŠ¨å‘˜ç­‰å¾…è£åˆ¤å‘˜çš„å‘ä»¤æªå£°çš„æƒ…å½¢ååˆ†ç±»ä¼¼ã€‚</p><p>æ¡ä»¶å˜é‡æ˜¯åŒæ­¥åŸè¯­çš„ä¸€ç§ï¼Œå¦‚æœæ²¡æœ‰æ¡ä»¶å˜é‡ï¼Œå¼€å‘äººå‘˜å¯èƒ½éœ€è¦åœ¨Goroutineä¸­é€šè¿‡è¿ç»­è½®è¯¢çš„æ–¹å¼ï¼Œæ£€æŸ¥æŸæ¡ä»¶æ˜¯å¦ä¸ºçœŸï¼Œè¿™ç§è¿ç»­è½®è¯¢éå¸¸æ¶ˆè€—èµ„æºï¼Œå› ä¸ºGoroutineåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ˜¯å¤„äºæ´»åŠ¨çŠ¶æ€çš„ï¼Œä½†å®ƒçš„å·¥ä½œåˆæ²¡æœ‰è¿›å±•ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸ªç”¨<code>sync.Mutex</code> å®ç°å¯¹æ¡ä»¶è½®è¯¢ç­‰å¾…çš„ä¾‹å­ï¼š</p><pre><code class=\"language-go\">type signal struct{}\n\nvar ready bool\n\nfunc worker(i int) {\n\tfmt.Printf(\"worker %d: is working...\\n\", i)\n\ttime.Sleep(1 * time.Second)\n\tfmt.Printf(\"worker %d: works done\\n\", i)\n}\n\nfunc spawnGroup(f func(i int), num int, mu *sync.Mutex) &lt;-chan signal {\n\tc := make(chan signal)\n\tvar wg sync.WaitGroup\n\n\tfor i := 0; i &lt; num; i++ {\n\t\twg.Add(1)\n\t\tgo func(i int) {\n\t\t\tfor {\n\t\t\t\tmu.Lock()\n\t\t\t\tif !ready {\n\t\t\t\t\tmu.Unlock()\n\t\t\t\t\ttime.Sleep(100 * time.Millisecond)\n\t\t\t\t\tcontinue\n\t\t\t\t}\n\t\t\t\tmu.Unlock()\n\t\t\t\tfmt.Printf(\"worker %d: start to work...\\n\", i)\n\t\t\t\tf(i)\n\t\t\t\twg.Done()\n\t\t\t\treturn\n\t\t\t}\n\t\t}(i + 1)\n\t}\n\n\tgo func() {\n\t\twg.Wait()\n\t\tc &lt;- signal(struct{}{})\n\t}()\n\treturn c\n}\n\nfunc main() {\n\tfmt.Println(\"start a group of workers...\")\n\tmu := &amp;sync.Mutex{}\n\tc := spawnGroup(worker, 5, mu)\n\n\ttime.Sleep(5 * time.Second) // æ¨¡æ‹Ÿreadyå‰çš„å‡†å¤‡å·¥ä½œ\n\tfmt.Println(\"the group of workers start to work...\")\n\n\tmu.Lock()\n\tready = true\n\tmu.Unlock()\n\n\t&lt;-c\n\tfmt.Println(\"the group of workers work done!\")\n}\n</code></pre><p>å°±åƒå‰é¢æåˆ°çš„ï¼Œè½®è¯¢çš„æ–¹å¼å¼€é”€å¤§ï¼Œè½®è¯¢é—´éš”è®¾ç½®çš„ä¸åŒï¼Œæ¡ä»¶æ£€æŸ¥çš„åŠæ—¶æ€§ä¹Ÿä¼šå—åˆ°å½±å“ã€‚<br>\n<code>sync.Cond</code>ä¸ºGoroutineåœ¨è¿™ä¸ªåœºæ™¯ä¸‹æä¾›äº†å¦ä¸€ç§å¯é€‰çš„ã€èµ„æºæ¶ˆè€—æ›´å°ã€ä½¿ç”¨ä½“éªŒæ›´ä½³çš„åŒæ­¥æ–¹å¼ã€‚ä½¿ç”¨æ¡ä»¶å˜é‡åŸè¯­ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å®ç°ç›¸åŒç›®æ ‡çš„åŒæ—¶ï¼Œé¿å…å¯¹æ¡ä»¶çš„è½®è¯¢ã€‚</p><p>æˆ‘ä»¬ç”¨<code>sync.Cond</code>å¯¹ä¸Šé¢çš„ä¾‹å­è¿›è¡Œæ”¹é€ ï¼Œæ”¹é€ åçš„ä»£ç å¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">type signal struct{}\n\nvar ready bool\n\nfunc worker(i int) {\n\tfmt.Printf(\"worker %d: is working...\\n\", i)\n\ttime.Sleep(1 * time.Second)\n\tfmt.Printf(\"worker %d: works done\\n\", i)\n}\n\nfunc spawnGroup(f func(i int), num int, groupSignal *sync.Cond) &lt;-chan signal {\n\tc := make(chan signal)\n\tvar wg sync.WaitGroup\n\n\tfor i := 0; i &lt; num; i++ {\n\t\twg.Add(1)\n\t\tgo func(i int) {\n\t\t\tgroupSignal.L.Lock()\n\t\t\tfor !ready {\n\t\t\t\tgroupSignal.Wait()\n\t\t\t}\n\t\t\tgroupSignal.L.Unlock()\n\t\t\tfmt.Printf(\"worker %d: start to work...\\n\", i)\n\t\t\tf(i)\n\t\t\twg.Done()\n\t\t}(i + 1)\n\t}\n\n\tgo func() {\n\t\twg.Wait()\n\t\tc &lt;- signal(struct{}{})\n\t}()\n\treturn c\n}\n\nfunc main() {\n\tfmt.Println(\"start a group of workers...\")\n\tgroupSignal := sync.NewCond(&amp;sync.Mutex{})\n\tc := spawnGroup(worker, 5, groupSignal)\n\n\ttime.Sleep(5 * time.Second) // æ¨¡æ‹Ÿreadyå‰çš„å‡†å¤‡å·¥ä½œ\n\tfmt.Println(\"the group of workers start to work...\")\n\n\tgroupSignal.L.Lock()\n\tready = true\n\tgroupSignal.Broadcast()\n\tgroupSignal.L.Unlock()\n\n\t&lt;-c\n\tfmt.Println(\"the group of workers work done!\")\n}\n</code></pre><p>æˆ‘ä»¬è¿è¡Œè¿™ä¸ªç¤ºä¾‹ç¨‹åºï¼Œå¾—åˆ°ï¼š</p><pre><code class=\"language-plain\">start a group of workers...\nthe group of workers start to work...\nworker 2: start to work...\nworker 2: is working...\nworker 3: start to work...\nworker 3: is working...\nworker 1: start to work...\nworker 1: is working...\nworker 4: start to work...\nworker 5: start to work...\nworker 5: is working...\nworker 4: is working...\nworker 4: works done\nworker 2: works done\nworker 3: works done\nworker 1: works done\nworker 5: works done\nthe group of workers work done!\n</code></pre><p>æˆ‘ä»¬çœ‹åˆ°ï¼Œ<code>sync.Cond</code>å®ä¾‹çš„åˆå§‹åŒ–ï¼Œéœ€è¦ä¸€ä¸ªæ»¡è¶³å®ç°äº†<code>sync.Locker</code>æ¥å£çš„ç±»å‹å®ä¾‹ï¼Œé€šå¸¸æˆ‘ä»¬ä½¿ç”¨<code>sync.Mutex</code>ã€‚</p><p>æ¡ä»¶å˜é‡éœ€è¦è¿™ä¸ªäº’æ–¥é”æ¥åŒæ­¥ä¸´ç•ŒåŒºï¼Œä¿æŠ¤ç”¨ä½œæ¡ä»¶çš„æ•°æ®ã€‚åŠ é”åï¼Œå„ä¸ªç­‰å¾…æ¡ä»¶æˆç«‹çš„Goroutineåˆ¤æ–­æ¡ä»¶æ˜¯å¦æˆç«‹ï¼Œå¦‚æœä¸æˆç«‹ï¼Œåˆ™è°ƒç”¨<code>sync.Cond</code>çš„Waitæ–¹æ³•è¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚Waitæ–¹æ³•åœ¨GoroutineæŒ‚èµ·å‰ä¼šè¿›è¡ŒUnlockæ“ä½œã€‚</p><p>å½“main goroutineå°†<code>ready</code>ç½®ä¸ºtrueï¼Œå¹¶è°ƒç”¨<code>sync.Cond</code>çš„Broadcastæ–¹æ³•åï¼Œå„ä¸ªé˜»å¡çš„Goroutineå°†è¢«å”¤é†’ï¼Œå¹¶ä»Waitæ–¹æ³•ä¸­è¿”å›ã€‚Waitæ–¹æ³•è¿”å›å‰ï¼ŒWaitæ–¹æ³•ä¼šå†æ¬¡åŠ é”è®©Goroutineè¿›å…¥ä¸´ç•ŒåŒºã€‚æ¥ä¸‹æ¥Goroutineä¼šå†æ¬¡å¯¹æ¡ä»¶æ•°æ®è¿›è¡Œåˆ¤å®šï¼Œå¦‚æœæ¡ä»¶æˆç«‹ï¼Œå°±ä¼šè§£é”å¹¶è¿›å…¥ä¸‹ä¸€ä¸ªå·¥ä½œé˜¶æ®µï¼›å¦‚æœæ¡ä»¶ä¾æ—§ä¸æˆç«‹ï¼Œé‚£ä¹ˆä¼šå†æ¬¡è¿›å…¥å¾ªç¯ä½“ï¼Œå¹¶è°ƒç”¨Waitæ–¹æ³•æŒ‚èµ·ç­‰å¾…ã€‚</p><p>å’Œ<code>sync.Mutex</code> ã€<code>sync.RWMutex</code>ç­‰ç›¸æ¯”ï¼Œ<code>sync.Cond</code> åº”ç”¨çš„åœºæ™¯æ›´ä¸ºæœ‰é™ï¼Œåªæœ‰åœ¨éœ€è¦â€œç­‰å¾…æŸä¸ªæ¡ä»¶æˆç«‹â€çš„åœºæ™¯ä¸‹ï¼ŒCondæ‰æœ‰ç”¨æ­¦ä¹‹åœ°ã€‚</p><p>å…¶å®ï¼Œé¢å‘CSPå¹¶å‘æ¨¡å‹çš„channelåŸè¯­å’Œé¢å‘ä¼ ç»Ÿå…±äº«å†…å­˜å¹¶å‘æ¨¡å‹çš„syncåŒ…æä¾›çš„åŸè¯­ï¼Œå·²ç»èƒ½å¤Ÿæ»¡è¶³Goè¯­è¨€åº”ç”¨å¹¶å‘è®¾è®¡ä¸­99.9%çš„å¹¶å‘åŒæ­¥éœ€æ±‚äº†ã€‚è€Œå‰©ä½™é‚£0.1%çš„éœ€æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨Goæ ‡å‡†åº“æä¾›çš„atomicåŒ…æ¥å®ç°ã€‚</p><h2>åŸå­æ“ä½œï¼ˆatomic operationsï¼‰</h2><p>atomicåŒ…æ˜¯Goè¯­è¨€ç»™ç”¨æˆ·æä¾›çš„åŸå­æ“ä½œåŸè¯­çš„ç›¸å…³æ¥å£ã€‚åŸå­æ“ä½œï¼ˆatomic operationsï¼‰æ˜¯ç›¸å¯¹äºæ™®é€šæŒ‡ä»¤æ“ä½œè€Œè¨€çš„ã€‚</p><p>æˆ‘ä»¬ä»¥ä¸€ä¸ªæ•´å‹å˜é‡è‡ªå¢çš„è¯­å¥ä¸ºä¾‹è¯´æ˜ä¸€ä¸‹ï¼š</p><pre><code class=\"language-plain\">var a int\na++\n</code></pre><p>a++è¿™è¡Œè¯­å¥éœ€è¦3æ¡æ™®é€šæœºå™¨æŒ‡ä»¤æ¥å®Œæˆå˜é‡açš„è‡ªå¢ï¼š</p><ul>\n<li>LOADï¼šå°†å˜é‡ä»å†…å­˜åŠ è½½åˆ°CPUå¯„å­˜å™¨ï¼›</li>\n<li>ADDï¼šæ‰§è¡ŒåŠ æ³•æŒ‡ä»¤ï¼›</li>\n<li>STOREï¼šå°†ç»“æœå­˜å‚¨å›åŸå†…å­˜åœ°å€ä¸­ã€‚</li>\n</ul><p>è¿™3æ¡æ™®é€šæŒ‡ä»¤åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æ˜¯å¯ä»¥è¢«ä¸­æ–­çš„ã€‚è€ŒåŸå­æ“ä½œçš„æŒ‡ä»¤æ˜¯ä¸å¯ä¸­æ–­çš„ï¼Œå®ƒå°±å¥½æ¯”ä¸€ä¸ªäº‹åŠ¡ï¼Œè¦ä¹ˆä¸æ‰§è¡Œï¼Œä¸€æ—¦æ‰§è¡Œå°±ä¸€æ¬¡æ€§å…¨éƒ¨æ‰§è¡Œå®Œæ¯•ï¼Œä¸­é—´ä¸å¯åˆ†å‰²ã€‚ä¹Ÿæ­£å› ä¸ºå¦‚æ­¤ï¼ŒåŸå­æ“ä½œä¹Ÿå¯ä»¥è¢«ç”¨äºå…±äº«æ•°æ®çš„å¹¶å‘åŒæ­¥ã€‚</p><p>åŸå­æ“ä½œç”±åº•å±‚ç¡¬ä»¶ç›´æ¥æä¾›æ”¯æŒï¼Œæ˜¯ä¸€ç§ç¡¬ä»¶å®ç°çš„æŒ‡ä»¤çº§çš„â€œäº‹åŠ¡â€ï¼Œå› æ­¤ç›¸å¯¹äºæ“ä½œç³»ç»Ÿå±‚é¢å’ŒGoè¿è¡Œæ—¶å±‚é¢æä¾›çš„åŒæ­¥æŠ€æœ¯è€Œè¨€ï¼Œå®ƒæ›´ä¸ºåŸå§‹ã€‚</p><p>atomicåŒ…å°è£…äº†CPUå®ç°çš„éƒ¨åˆ†åŸå­æ“ä½œæŒ‡ä»¤ï¼Œä¸ºç”¨æˆ·å±‚æä¾›ä½“éªŒè‰¯å¥½çš„åŸå­æ“ä½œå‡½æ•°ï¼Œå› æ­¤atomicåŒ…ä¸­æä¾›çš„åŸè¯­æ›´æ¥è¿‘ç¡¬ä»¶åº•å±‚ï¼Œä¹Ÿæ›´ä¸ºä½çº§ï¼Œå®ƒä¹Ÿå¸¸è¢«ç”¨äºå®ç°æ›´ä¸ºé«˜çº§çš„å¹¶å‘åŒæ­¥æŠ€æœ¯ï¼Œæ¯”å¦‚channelå’ŒsyncåŒ…ä¸­çš„åŒæ­¥åŸè¯­ã€‚</p><p>æˆ‘ä»¬ä»¥atomic.SwapInt64å‡½æ•°åœ¨x86_64å¹³å°ä¸Šçš„å®ç°ä¸ºä¾‹ï¼Œçœ‹çœ‹è¿™ä¸ªå‡½æ•°çš„å®ç°æ–¹æ³•ï¼š</p><pre><code class=\"language-go\">// $GOROOT/src/sync/atomic/doc.go\nfunc SwapInt64(addr *int64, new int64) (old int64)\n\n// $GOROOT/src/sync/atomic/asm.s\n\nTEXT Â·SwapInt64(SB),NOSPLIT,$0\n        JMP     runtimeâˆ•internalâˆ•atomicÂ·Xchg64(SB)\n\n// $GOROOT/src/runtime/internal/atomic/asm_amd64.s\nTEXT runtimeâˆ•internalâˆ•atomicÂ·Xchg64(SB), NOSPLIT, $0-24\n        MOVQ    ptr+0(FP), BX\n        MOVQ    new+8(FP), AX\n        XCHGQ   AX, 0(BX)\n        MOVQ    AX, ret+16(FP)\n        RET\n\n</code></pre><p>ä»å‡½æ•°SwapInt64çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼šå®ƒåŸºæœ¬å°±æ˜¯å¯¹x86_64 CPUå®ç°çš„åŸå­æ“ä½œæŒ‡ä»¤<code>XCHGQ</code>çš„ç›´æ¥å°è£…ã€‚</p><p>åŸå­æ“ä½œçš„ç‰¹æ€§ï¼Œè®©atomicåŒ…ä¹Ÿå¯ä»¥è¢«ç”¨ä½œå¯¹å…±äº«æ•°æ®çš„å¹¶å‘åŒæ­¥ï¼Œé‚£ä¹ˆå’Œæ›´ä¸ºé«˜çº§çš„channelä»¥åŠsyncåŒ…ä¸­åŸè¯­ç›¸æ¯”ï¼Œæˆ‘ä»¬ç©¶ç«Ÿè¯¥æ€ä¹ˆé€‰æ‹©å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹atomicåŒ…æä¾›äº†å“ªäº›èƒ½åŠ›ã€‚</p><p>atomicåŒ…æä¾›äº†ä¸¤å¤§ç±»åŸå­æ“ä½œæ¥å£ï¼Œä¸€ç±»æ˜¯é’ˆå¯¹æ•´å‹å˜é‡çš„ï¼ŒåŒ…æ‹¬æœ‰ç¬¦å·æ•´å‹ã€æ— ç¬¦å·æ•´å‹ä»¥åŠå¯¹åº”çš„æŒ‡é’ˆç±»å‹ï¼›å¦å¤–ä¸€ç±»æ˜¯é’ˆå¯¹è‡ªå®šä¹‰ç±»å‹çš„ã€‚å› æ­¤ï¼Œç¬¬ä¸€ç±»åŸå­æ“ä½œæ¥å£çš„å­˜åœ¨è®©atomicåŒ…å¤©ç„¶é€‚åˆå»å®ç°æŸä¸€ä¸ªå…±äº«æ•´å‹å˜é‡çš„å¹¶å‘åŒæ­¥ã€‚</p><p>æˆ‘ä»¬å†çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p><pre><code class=\"language-go\">var n1 int64\n\nfunc addSyncByAtomic(delta int64) int64 {\n\treturn atomic.AddInt64(&amp;n1, delta)\n}\n\nfunc readSyncByAtomic() int64 {\n\treturn atomic.LoadInt64(&amp;n1)\n}\n\nvar n2 int64\nvar rwmu sync.RWMutex\n\nfunc addSyncByRWMutex(delta int64) {\n\trwmu.Lock()\n\tn2 += delta\n\trwmu.Unlock()\n}\n\nfunc readSyncByRWMutex() int64 {\n\tvar n int64\n\trwmu.RLock()\n\tn = n2\n\trwmu.RUnlock()\n\treturn n\n}\n\nfunc BenchmarkAddSyncByAtomic(b *testing.B) {\n\tb.RunParallel(func(pb *testing.PB) {\n\t\tfor pb.Next() {\n\t\t\taddSyncByAtomic(1)\n\t\t}\n\t})\n}\n\nfunc BenchmarkReadSyncByAtomic(b *testing.B) {\n\tb.RunParallel(func(pb *testing.PB) {\n\t\tfor pb.Next() {\n\t\t\treadSyncByAtomic()\n\t\t}\n\t})\n}\n\nfunc BenchmarkAddSyncByRWMutex(b *testing.B) {\n\tb.RunParallel(func(pb *testing.PB) {\n\t\tfor pb.Next() {\n\t\t\taddSyncByRWMutex(1)\n\t\t}\n\t})\n}\n\nfunc BenchmarkReadSyncByRWMutex(b *testing.B) {\n\tb.RunParallel(func(pb *testing.PB) {\n\t\tfor pb.Next() {\n\t\t\treadSyncByRWMutex()\n\t\t}\n\t})\n}\n\n</code></pre><p>æˆ‘ä»¬åˆ†åˆ«åœ¨cpu=2ã€ 8ã€16ã€32çš„æƒ…å†µä¸‹è¿è¡Œä¸Šè¿°æ€§èƒ½åŸºå‡†æµ‹è¯•ï¼Œå¾—åˆ°ç»“æœå¦‚ä¸‹ï¼š</p><pre><code class=\"language-go\">goos: darwin\ngoarch: amd64\n... ...\nBenchmarkAddSyncByAtomic-2     \t75426774\t        17.69 ns/op\nBenchmarkReadSyncByAtomic-2    \t1000000000\t         0.7437 ns/op\nBenchmarkAddSyncByRWMutex-2    \t39041671\t        30.16 ns/op\nBenchmarkReadSyncByRWMutex-2   \t41325093\t        28.48 ns/op\n\nBenchmarkAddSyncByAtomic-8     \t77497987\t        15.25 ns/op\nBenchmarkReadSyncByAtomic-8    \t1000000000\t         0.2395 ns/op\nBenchmarkAddSyncByRWMutex-8    \t17702034\t        67.16 ns/op\nBenchmarkReadSyncByRWMutex-8   \t29966182\t        40.37 ns/op\n\nBenchmarkAddSyncByAtomic-16      \t57727968\t        20.39 ns/op\nBenchmarkReadSyncByAtomic-16     \t1000000000\t         0.2536 ns/op\nBenchmarkAddSyncByRWMutex-16     \t15029635\t        78.61 ns/op\nBenchmarkReadSyncByRWMutex-16    \t29722464\t        40.28 ns/op\n\nBenchmarkAddSyncByAtomic-32      \t58010497\t        20.40 ns/op\nBenchmarkReadSyncByAtomic-32     \t1000000000\t         0.2402 ns/op\nBenchmarkAddSyncByRWMutex-32     \t11748312\t        93.15 ns/op\nBenchmarkReadSyncByRWMutex-32    \t29845912\t        40.54 ns/op\n</code></pre><p>é€šè¿‡è¿™ä¸ªè¿è¡Œç»“æœï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºä¸€äº›ç»“è®ºï¼š</p><ul>\n<li>è¯»å†™é”çš„æ€§èƒ½éšç€å¹¶å‘é‡å¢å¤§çš„æƒ…å†µï¼Œä¸å‰é¢è®²è§£çš„sync.RWMutexä¸€è‡´ï¼›</li>\n<li>åˆ©ç”¨åŸå­æ“ä½œçš„æ— é”å¹¶å‘å†™çš„æ€§èƒ½ï¼Œéšç€å¹¶å‘é‡å¢å¤§å‡ ä¹ä¿æŒæ’å®šï¼›</li>\n<li>åˆ©ç”¨åŸå­æ“ä½œçš„æ— é”å¹¶å‘è¯»çš„æ€§èƒ½ï¼Œéšç€å¹¶å‘é‡å¢å¤§æœ‰æŒç»­æå‡çš„è¶‹åŠ¿ï¼Œå¹¶ä¸”æ€§èƒ½æ˜¯è¯»é”çš„çº¦200å€ã€‚</li>\n</ul><p>é€šè¿‡è¿™äº›ç»“è®ºï¼Œæˆ‘ä»¬å¤§è‡´å¯ä»¥çœ‹åˆ°atomicåŸå­æ“ä½œçš„ç‰¹æ€§ï¼šéšç€å¹¶å‘é‡æå‡ï¼Œä½¿ç”¨atomicå®ç°çš„<strong>å…±äº«å˜é‡</strong>çš„å¹¶å‘è¯»å†™æ€§èƒ½è¡¨ç°æ›´ä¸ºç¨³å®šï¼Œå°¤å…¶æ˜¯åŸå­è¯»æ“ä½œï¼Œå’ŒsyncåŒ…ä¸­çš„è¯»å†™é”åŸè¯­æ¯”èµ·æ¥ï¼Œatomicè¡¨ç°å‡ºäº†æ›´å¥½çš„ä¼¸ç¼©æ€§å’Œé«˜æ€§èƒ½ã€‚</p><p>ç”±æ­¤ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡ºatomicåŒ…æ›´é€‚åˆ<strong>ä¸€äº›å¯¹æ€§èƒ½ååˆ†æ•æ„Ÿã€å¹¶å‘é‡è¾ƒå¤§ä¸”è¯»å¤šå†™å°‘çš„åœºåˆ</strong>ã€‚</p><p>ä¸è¿‡ï¼ŒatomicåŸå­æ“ä½œå¯ç”¨æ¥åŒæ­¥çš„èŒƒå›´æœ‰æ¯”è¾ƒå¤§é™åˆ¶ï¼Œåªèƒ½åŒæ­¥ä¸€ä¸ªæ•´å‹å˜é‡æˆ–è‡ªå®šä¹‰ç±»å‹å˜é‡ã€‚å¦‚æœæˆ‘ä»¬è¦å¯¹ä¸€ä¸ªå¤æ‚çš„ä¸´ç•ŒåŒºæ•°æ®è¿›è¡ŒåŒæ­¥ï¼Œé‚£ä¹ˆé¦–é€‰çš„ä¾æ—§æ˜¯syncåŒ…ä¸­çš„åŸè¯­ã€‚</p><h2>å°ç»“</h2><p>å¥½äº†ï¼Œä»Šå¤©çš„è¯¾è®²åˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œç°åœ¨æˆ‘ä»¬ä¸€èµ·æ¥å›é¡¾ä¸€ä¸‹å§ã€‚</p><p>è™½ç„¶Goæ¨èåŸºäºé€šä¿¡æ¥å…±äº«å†…å­˜çš„å¹¶å‘è®¾è®¡é£æ ¼ï¼Œä½†Goå¹¶æ²¡æœ‰å½»åº•æŠ›å¼ƒå¯¹åŸºäºå…±äº«å†…å­˜å¹¶å‘æ¨¡å‹çš„æ”¯æŒï¼ŒGoé€šè¿‡æ ‡å‡†åº“çš„syncåŒ…ä»¥åŠatomicåŒ…æä¾›äº†ä½çº§åŒæ­¥åŸè¯­ã€‚è¿™äº›åŸè¯­æœ‰ç€å®ƒä»¬è‡ªå·±çš„åº”ç”¨åœºæ™¯ã€‚</p><p>å¦‚æœæˆ‘ä»¬è€ƒè™‘ä½¿ç”¨ä½çº§åŒæ­¥åŸè¯­ï¼Œä¸€èˆ¬éƒ½æ˜¯å› ä¸ºä½çº§åŒæ­¥åŸè¯­å¯ä»¥æä¾›<strong>æ›´ä½³çš„æ€§èƒ½è¡¨ç°</strong>ï¼Œæ€§èƒ½åŸºå‡†æµ‹è¯•ç»“æœå‘Šè¯‰æˆ‘ä»¬ï¼Œä½¿ç”¨ä½çº§åŒæ­¥åŸè¯­çš„æ€§èƒ½å¯ä»¥é«˜å‡ºchannelè®¸å¤šå€ã€‚åœ¨æ€§èƒ½æ•æ„Ÿçš„åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬ä¾ç„¶ç¦»ä¸å¼€è¿™äº›ä½çº§åŒæ­¥åŸè¯­ã€‚</p><p>åœ¨ä½¿ç”¨syncåŒ…æä¾›çš„åŒæ­¥åŸè¯­ä¹‹å‰ï¼Œæˆ‘ä»¬ä¸€å®šè¦ç‰¢è®°è¿™äº›åŸè¯­ä½¿ç”¨çš„æ³¨æ„äº‹é¡¹ï¼š<strong>ä¸è¦å¤åˆ¶é¦–æ¬¡ä½¿ç”¨åçš„Mutex/RWMutex/Condç­‰</strong>ã€‚ä¸€æ—¦å¤åˆ¶ï¼Œä½ å°†å¾ˆå¤§å¯èƒ½å¾—åˆ°æ„æ–™ä¹‹å¤–çš„è¿è¡Œç»“æœã€‚</p><p>syncåŒ…ä¸­çš„ä½çº§åŒæ­¥åŸè¯­å„æœ‰å„çš„æ“…é•¿é¢†åŸŸï¼Œä½ å¯ä»¥è®°ä½ï¼š</p><ul>\n<li>åœ¨å…·æœ‰ä¸€å®šå¹¶å‘é‡ä¸”è¯»å¤šå†™å°‘çš„åœºåˆä½¿ç”¨RWMutexï¼›</li>\n<li>åœ¨éœ€è¦â€œç­‰å¾…æŸä¸ªæ¡ä»¶æˆç«‹â€çš„åœºæ™¯ä¸‹ä½¿ç”¨Condï¼›</li>\n<li>å½“ä½ ä¸ç¡®å®šä½¿ç”¨ä»€ä¹ˆåŸè¯­æ—¶ï¼Œé‚£å°±ä½¿ç”¨Mutexå§ã€‚</li>\n</ul><p>å¦‚æœä½ å¯¹åŒæ­¥çš„æ€§èƒ½æœ‰æè‡´è¦æ±‚ï¼Œä¸”å¹¶å‘é‡è¾ƒå¤§ï¼Œè¯»å¤šå†™å°‘ï¼Œé‚£ä¹ˆå¯ä»¥è€ƒè™‘ä¸€ä¸‹atomicåŒ…æä¾›çš„åŸå­æ“ä½œå‡½æ•°ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>ä½¿ç”¨åŸºäºå…±äº«å†…å­˜çš„å¹¶å‘æ¨¡å‹æ—¶ï¼Œæœ€ä»¤äººå¤´ç–¼çš„å¯èƒ½å°±æ˜¯â€œæ­»é”â€é—®é¢˜çš„å­˜åœ¨äº†ã€‚ä½ äº†è§£æ­»é”çš„äº§ç”Ÿæ¡ä»¶ä¹ˆï¼Ÿèƒ½ç¼–å†™ä¸€ä¸ªç¨‹åºæ¨¡æ‹Ÿä¸€ä¸‹æ­»é”çš„å‘ç”Ÿä¹ˆï¼Ÿ</p><p>æ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™æ›´å¤šå¯¹Goå¹¶å‘æ„Ÿå…´è¶£çš„æœ‹å‹ã€‚æˆ‘æ˜¯Tony Baiï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ã€‚</p>","neighbors":{"left":{"article_title":"33ï½œå¹¶å‘ï¼šå°channelä¸­è•´å«å¤§æ™ºæ…§","id":477365},"right":{"article_title":"35ï½œå³å­¦å³ç»ƒï¼šå¦‚ä½•å®ç°ä¸€ä¸ªè½»é‡çº§çº¿ç¨‹æ± ï¼Ÿ","id":479171}},"comments":[{"had_liked":false,"id":330679,"user_name":"ç½—æ°","can_delete":false,"product_type":"c1","uid":1320487,"ip_address":"","ucode":"96BAFAA147341F","user_header":"https://static001.geekbang.org/account/avatar/00/14/26/27/eba94899.jpg","comment_is_top":false,"comment_ctime":1642119526,"is_pvip":false,"replies":[{"id":"121575","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1026224","ctime":1643512303,"ip_address":"","comment_id":330679,"utype":1}],"discussion_count":6,"race_medal":2,"score":"36001857894","product_id":100093501,"comment_content":"è¿ç»­ä¸‰èŠ‚è¯¾éƒ½æ˜¯éœ€è¦èŠ±è´¹ 30 åˆ†é’Ÿæ‰èƒ½é˜…è¯»å®Œï¼Œå³ä½¿æ˜¯å¤ä¹ ä¹Ÿè¦è¶…è¿‡ 20 åˆ†é’Ÿï¼Œè¿™å‡ èŠ‚çš„å†…å®¹çœŸçš„å¥½å……å®ã€‚","like_count":8,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":549005,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1643512303,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2699840,"avatar":"https://static001.geekbang.org/account/avatar/00/29/32/40/d56f476c.jpg","nickname":"ibin","note":"","ucode":"766942C36B8E27","race_medal":1,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546024,"discussion_content":"æˆ‘çœ‹äº†ä¸€å¤©ï¼Œæ˜¯æˆ‘æ•ˆç‡å¤ªå·®äº†å—ï¼Ÿ","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1642132488,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":3,"child_discussions":[{"author":{"id":1320487,"avatar":"https://static001.geekbang.org/account/avatar/00/14/26/27/eba94899.jpg","nickname":"ç½—æ°","note":"","ucode":"96BAFAA147341F","race_medal":2,"user_type":1,"is_pvip":false},"reply_author":{"id":2699840,"avatar":"https://static001.geekbang.org/account/avatar/00/29/32/40/d56f476c.jpg","nickname":"ibin","note":"","ucode":"766942C36B8E27","race_medal":1,"user_type":1,"is_pvip":true},"discussion":{"id":546115,"discussion_content":"è¦çŸ¥é“æˆ‘ç”¨ Go å·²ç»å¼€å‘äº†ä¸‰å¹´ï¼Œè¿˜æœ‰è¿‘åå¹´çš„ç¼–ç¨‹ç»éªŒ","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1642163969,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":546024,"ip_address":""},"score":546115,"extra":""},{"author":{"id":2809224,"avatar":"https://static001.geekbang.org/account/avatar/00/2a/dd/88/92f8e582.jpg","nickname":"zz","note":"","ucode":"94E8990BF3E3C8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1320487,"avatar":"https://static001.geekbang.org/account/avatar/00/14/26/27/eba94899.jpg","nickname":"ç½—æ°","note":"","ucode":"96BAFAA147341F","race_medal":2,"user_type":1,"is_pvip":false},"discussion":{"id":548259,"discussion_content":"å¾ˆå¤šåé¢å®é™…åº”ç”¨å±‚é¢çš„éƒ½çœ‹ä¸æ‡‚ï¼Œæ„Ÿè§‰ç¼ºäº†å¾ˆå¤šå‰ç½®çŸ¥è¯†ï¼Œå¾—å»å…ˆå®è·µä¸€ä¸‹æ‰è¡Œ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1643103467,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":546115,"ip_address":""},"score":548259,"extra":""},{"author":{"id":1320487,"avatar":"https://static001.geekbang.org/account/avatar/00/14/26/27/eba94899.jpg","nickname":"ç½—æ°","note":"","ucode":"96BAFAA147341F","race_medal":2,"user_type":1,"is_pvip":false},"reply_author":{"id":2809224,"avatar":"https://static001.geekbang.org/account/avatar/00/2a/dd/88/92f8e582.jpg","nickname":"zz","note":"","ucode":"94E8990BF3E3C8","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":548268,"discussion_content":"è¿™å—å†…å®¹æœ¬æ¥å°±ä¸å®¹æ˜“ç†è§£ï¼Œçœ‹ä¸æ˜ç™½å¾ˆæ­£å¸¸ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1643106017,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":548259,"ip_address":""},"score":548268,"extra":""}]},{"author":{"id":1248326,"avatar":"https://static001.geekbang.org/account/avatar/00/13/0c/46/dfe32cf4.jpg","nickname":"å¤šé€‰å‚æ•°","note":"","ucode":"B2294D80AB075F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":567696,"discussion_content":"æˆ‘ä¹Ÿçœ‹äº†å¿«ä¸€å¤©ï¼Œé‡Œé¢çš„ä»£ç éƒ½æ•²äº†ä¸€é","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1650977057,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":330918,"user_name":"æ­¥æ¯”å¤©ä¸‹","can_delete":false,"product_type":"c1","uid":2295138,"ip_address":"","ucode":"120CC75E183441","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoibQLsjsrjiasFUaPdjib95Jk4y3ZMD6zXyEud7bCvibrjrPia3RCib0zTD7MahQJ41icOicIWXfbq8JpnGQ/132","comment_is_top":false,"comment_ctime":1642298705,"is_pvip":false,"replies":[{"id":"121535","content":"ä¸´ç•ŒåŒºå…¶å®å°±æ˜¯ä¸€ä¸ªä»£ç ç‰‡æ®µã€‚ä½†è¿™ä¸ªä»£ç ç‰‡æ®µä¸­æœ‰å…±äº«çš„æ•°æ®ï¼Œè¿™äº›æ•°æ®ä¸æ”¯æŒå¤šä¸ªgoroutineçš„å¹¶å‘è®¿é—®ï¼Œåªèƒ½é€šè¿‡åƒchannelã€é”ç­‰æœºåˆ¶åŒæ­¥å„ä¸ªgoroutineçš„è®¿é—®ã€‚åŒä¸€æ—¶é—´ï¼Œåªèƒ½æœ‰ä¸€ä¸ªgoroutineè®¿é—®è¿™æ®µä»£ç ï¼Œä¿®æ”¹æˆ–è¯»å–è¿™æ®µä»£ç æ‰€å…±äº«çš„æ•°æ®ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1026224","ctime":1643441765,"ip_address":"","comment_id":330918,"utype":1}],"discussion_count":4,"race_medal":0,"score":"31707069777","product_id":100093501,"comment_content":"è€å¸ˆï¼Œæˆ‘æƒ³é—®ä¸ªä½çº§çš„é—®é¢˜ï¼Œä»€ä¹ˆæ˜¯ä¸´ç•ŒåŒºå•Šï¼Œä¸å¤ªæ‡‚","like_count":8,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":548896,"discussion_content":"ä¸´ç•ŒåŒºå…¶å®å°±æ˜¯ä¸€ä¸ªä»£ç ç‰‡æ®µã€‚ä½†è¿™ä¸ªä»£ç ç‰‡æ®µä¸­æœ‰å…±äº«çš„æ•°æ®ï¼Œè¿™äº›æ•°æ®ä¸æ”¯æŒå¤šä¸ªgoroutineçš„å¹¶å‘è®¿é—®ï¼Œåªèƒ½é€šè¿‡åƒchannelã€é”ç­‰æœºåˆ¶åŒæ­¥å„ä¸ªgoroutineçš„è®¿é—®ã€‚åŒä¸€æ—¶é—´ï¼Œåªèƒ½æœ‰ä¸€ä¸ªgoroutineè®¿é—®è¿™æ®µä»£ç ï¼Œä¿®æ”¹æˆ–è¯»å–è¿™æ®µä»£ç æ‰€å…±äº«çš„æ•°æ®ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1643441766,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1026593,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/aa/21/6c3ba9af.jpg","nickname":"lfn","note":"","ucode":"2E1558C6A12A89","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":547325,"discussion_content":"ä¸´ç•ŒåŒºæ˜¯ä¸€æ®µå¯èƒ½äº§ç”Ÿç«æ€æ¡ä»¶çš„ä»£ç ","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1642613029,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1627670,"avatar":"https://static001.geekbang.org/account/avatar/00/18/d6/16/107f0d04.jpg","nickname":"å±±é’","note":"","ucode":"904AE3C23D3B92","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546369,"discussion_content":"å°±æ˜¯å¾ˆå¤šgoruntineéƒ½è¦è®¿é—®çš„èµ„æºå§ æˆ‘è¿™ä¹ˆç†è§£çš„ \n","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1642306141,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1756505,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/59/493b8eab.jpg","nickname":"ç»†å¿ƒç‚¹","note":"","ucode":"F4D0EF8C71718E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":590431,"discussion_content":"æˆ‘æ„Ÿè§‰ è¿™ä¸ªé—®é¢˜å¾ˆé«˜çº§â€¦","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1665734943,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"åŒ—äº¬"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":330825,"user_name":"Calvin","can_delete":false,"product_type":"c1","uid":1603004,"ip_address":"","ucode":"0EEF5B207623B5","user_header":"https://static001.geekbang.org/account/avatar/00/18/75/bc/e24e181e.jpg","comment_is_top":false,"comment_ctime":1642184091,"is_pvip":false,"replies":[{"id":"121588","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1026224","ctime":1643522258,"ip_address":"","comment_id":330825,"utype":1}],"discussion_count":4,"race_medal":0,"score":"27411987867","product_id":100093501,"comment_content":"æ€è€ƒé¢˜ï¼š<br>æ­»é”äº§ç”Ÿçš„ 4 ä¸ªå¿…è¦æ¡ä»¶ï¼š1) ä¸å¯å‰¥å¤ºï¼›2) è¯·æ±‚ä¸ä¿æŒï¼›3) å¾ªç¯ç­‰å¾…ï¼›4) äº’æ–¥ã€‚<br><br>ä»¥ä¸‹æ¨¡å—ç¨‹åºä¼šå‘ç”Ÿæ­»é”ï¼ŒæŠ¥ fatal error: all goroutines are asleep - deadlock!<br><br>func op1(mu1, mu2 *sync.Mutex, wg *sync.WaitGroup) {<br>\tmu1.Lock()<br>\ttime.Sleep(1 * time.Second)<br>\tmu2.Lock()<br>\tprintln(&quot;op1: do something...&quot;)<br>\tmu2.Unlock()<br>\tmu1.Unlock()<br>\twg.Done()<br>}<br><br>func op2(mu1, mu2 *sync.Mutex, wg *sync.WaitGroup) {<br>\tmu2.Lock()<br>\ttime.Sleep(2 * time.Second)<br>\tmu1.Lock()<br>\tprintln(&quot;op2: do something...&quot;)<br>\tmu1.Unlock()<br>\tmu2.Unlock()<br>\twg.Done()<br>}<br><br>func TestDeadLock(t *testing.T) {<br>\tvar mu1 sync.Mutex<br>\tvar mu2 sync.Mutex<br><br>\tvar wg sync.WaitGroup<br>\twg.Add(2)<br>\tgo op1(&amp;mu1, &amp;mu2, &amp;wg)<br>\tgo op2(&amp;mu1, &amp;mu2, &amp;wg)<br>\twg.Wait()<br>}","like_count":6,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":549029,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1643522258,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1351076,"avatar":"https://static001.geekbang.org/account/avatar/00/14/9d/a4/e481ae48.jpg","nickname":"lesserror","note":"","ucode":"25A54D1165FCF6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":547474,"discussion_content":"åŒå­¦ï¼Œæˆ‘åœ¨æˆ‘çš„m1 Macä¸Šé¢ï¼Œè¿è¡Œè¿™æ®µç¨‹åºï¼Œå¹¶æ²¡æœ‰æŠ¥ï¼šâ€œfatal error: all goroutines are asleep - deadlock!â€ è¿™ä¸ªé”™è¯¯ï¼Œè€Œæ˜¯ç¨‹åºä¸€ç›´é˜»å¡ç€ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642688554,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1603004,"avatar":"https://static001.geekbang.org/account/avatar/00/18/75/bc/e24e181e.jpg","nickname":"Calvin","note":"","ucode":"0EEF5B207623B5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1351076,"avatar":"https://static001.geekbang.org/account/avatar/00/14/9d/a4/e481ae48.jpg","nickname":"lesserror","note":"","ucode":"25A54D1165FCF6","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":547495,"discussion_content":"æˆ‘ç”¨æˆ‘çš„ Windows 11 ç‰ˆå®‰è£…çš„ Goland åˆè¯•äº†ä¸‹ï¼Œæ˜¯ä¼šæŠ¥æ­»é”å“¦ã€‚\nå¦å¤–æˆ‘è¿˜åœ¨å®˜æ–¹çš„ Playground ä¸Šï¼ˆhttps://go.dev/play/ï¼‰ä¹Ÿè¯•äº†ï¼Œä¹Ÿæ˜¯ä¸€æ ·æŠ¥æ­»é”ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642698067,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":547474,"ip_address":""},"score":547495,"extra":""},{"author":{"id":1603004,"avatar":"https://static001.geekbang.org/account/avatar/00/18/75/bc/e24e181e.jpg","nickname":"Calvin","note":"","ucode":"0EEF5B207623B5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1351076,"avatar":"https://static001.geekbang.org/account/avatar/00/14/9d/a4/e481ae48.jpg","nickname":"lesserror","note":"","ucode":"25A54D1165FCF6","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":547578,"discussion_content":"è¯•äº†ä¸‹ Mac ä¸Šçš„ç¡®é˜»å¡ç€ï¼Œæ¯”è¾ƒå¥‡æ€ªï¼Œå¸Œæœ›æœ‰äººèƒ½è§£æƒ‘ã€‚\nä½†æ˜¯è¿™ä¸ªå…¶å®è¿˜æ˜¯æ­»é”çš„ï¼Œgoroutine-1 æŒæœ‰ mu1 é”ï¼Œgoroutine-2 æŒæœ‰ mu2 é”ï¼Œç„¶å goroutine-1 åˆç”³è¯· mu2 é”ï¼Œç„¶å goroutine-2 åˆç”³è¯· mu1 é”ï¼Œå¯¼è‡´ç›¸äº’è·å–ä¸åˆ°é”ï¼Œå¼•å‘â€œæ­»é”â€é—®é¢˜ã€‚\næœªæŠ¥ all goroutines are asleep å¯èƒ½æ˜¯è¿˜æœ‰å…¶ä»– goroutine æœªé˜»å¡ï¼Œgo ç›‘æ§åˆ°å¹¶ä¸æ˜¯æ‰€æœ‰åç¨‹éƒ½ asleep äº†ï¼Œæ‰€ä»¥è¿˜æ²¡æœ‰æŠ¥ fatal error!\nå°† TestDeadLock æ›´æ¢ä½¿ç”¨ main å‡½æ•°çš„æ–¹å¼ï¼Œå°±å¯ä»¥æŠ¥â€œfatal error: all goroutines are asleep - deadlock!â€ è¿™ä¸ªé”™è¯¯äº†ï¼\nè¿™ä¸ªå“¥ä»¬çš„é—®é¢˜æ„Ÿè§‰å’Œè¿™ä¸ªæœ‰ç‚¹åƒï¼šhttps://stackoverflow.com/questions/61821676/why-does-go-test-with-blocked-channel-not-reporting-deadlock","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642755283,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":547474,"ip_address":""},"score":547578,"extra":""}]}]},{"had_liked":false,"id":331156,"user_name":"aoe","can_delete":false,"product_type":"c1","uid":1121758,"ip_address":"","ucode":"1C6201EDB4E954","user_header":"https://static001.geekbang.org/account/avatar/00/11/1d/de/62bfa83f.jpg","comment_is_top":false,"comment_ctime":1642468656,"is_pvip":false,"replies":[{"id":"121593","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1026224","ctime":1643525153,"ip_address":"","comment_id":331156,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18822337840","product_id":100093501,"comment_content":"è¯»åˆ°è¿™é‡Œï¼Œæ˜ç™½äº† Go çš„å¹¶å‘ä¸æ˜¯ä¸‡èƒ½çš„ï¼<br>1. Go åŸºäº Tony Hoare çš„ CSP å¹¶å‘æ¨¡å‹ç†è®ºï¼Œå®ç°äº† Goroutineã€channel ç­‰å¹¶å‘åŸè¯­ï¼›<br>2. ä½¿ç”¨ä½çº§åŒæ­¥åŸè¯­ï¼ˆæ ‡å‡†åº“çš„ sync åŒ…ä»¥åŠ atomic åŒ…æä¾›äº†ä½çº§åŒæ­¥åŸè¯­ï¼šMutex&#47;RWMutex&#47;Cond ç­‰ï¼‰çš„æ€§èƒ½å¯ä»¥é«˜å‡º channel è®¸å¤šå€<br>3. æœ‰é”çš„åœ°æ–¹å°±æœ‰æ±Ÿæ¹–ï¼Œé«˜å¹¶å‘ä¸‹çš„æ€§èƒ½ä¸»è¦æ‹¼çš„æ˜¯ç®—æ³•ï¼Œæ²¡æœ‰ä¸€é—¨è¯­è¨€æœ‰å‹å€’æ€§ä¼˜åŠ¿","like_count":4,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":549036,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1643525153,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":343522,"user_name":"Geek_62c21a","can_delete":false,"product_type":"c1","uid":2155223,"ip_address":"","ucode":"5F10926178A3DC","user_header":"https://static001.geekbang.org/account/avatar/00/20/e2/d7/8e2e0579.jpg","comment_is_top":false,"comment_ctime":1650890571,"is_pvip":true,"replies":[{"id":"125444","content":"1. å¯ä»¥çš„ã€‚<br>2. è™½ç„¶Broadcastçš„å‚è€ƒæ–‡æ¡£ä¹Ÿæåˆ°äº†ï¼šIt is allowed but not required for the caller to hold c.L during the call. å¯¹äºä¾‹å­æ¥è¯´ä¸¤ç§å†™æ³•éƒ½æ˜¯okçš„ã€‚ä½†æ¡ä»¶å˜é‡çš„æµ‹è¯•æ¡ä»¶è¡¨è¾¾å¼ï¼Œæ¯”å¦‚æœ¬ä¾‹å­ä¸­çš„readyæœ€å¥½æ˜¯å§‹ç»ˆåœ¨lockçš„ä¿æŠ¤ä¸‹çš„ã€‚æ‰€ä»¥è¿™é‡Œæˆ‘å»ºè®®ç”¨äº†ç¬¬ä¸€ç§ã€‚å¦åˆ™åœ¨å¤æ‚çš„åœºæ™¯ä¸‹ï¼Œä¸€æ—¦unlockï¼Œæ¡ä»¶å˜é‡æµ‹è¯•è¡¨è¾¾å¼ å°±ä¸å—æ§äº†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1026224","ctime":1651026093,"ip_address":"","comment_id":343522,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14535792459","product_id":100093501,"comment_content":"è€å¸ˆï¼Œæœ‰ä¸¤ä¸ªé—®é¢˜è¯·æ•™æ‚¨<br>1ï¼Œwg.Done() æ˜¯ä¸æ˜¯åœ¨å‡½æ•°å¼€å§‹çš„åœ°æ–¹å†™æˆ defer wg.Done() ä¼šå¥½ç‚¹å‘¢ï¼Ÿ<br>2ï¼Œæ¡ä»¶å˜é‡ broadcast çš„æ—¶å€™ï¼Œä»¥ä¸‹ä¸¤ç§å†™æ³•æœ‰åŒºåˆ«å—ï¼Ÿ<br>ç¬¬ä¸€ç§ï¼š<br>groupSignal.L.Lock() <br>ready = true <br>groupSignal.Broadcast()<br>groupSignal.L.Unlock()<br>ç¬¬äºŒç§ï¼š<br>groupSignal.L.Lock() <br>ready = true <br>groupSignal.L.Unlock()<br>groupSignal.Broadcast()","like_count":3,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":567907,"discussion_content":"1. å¯ä»¥çš„ã€‚\n2. è™½ç„¶Broadcastçš„å‚è€ƒæ–‡æ¡£ä¹Ÿæåˆ°äº†ï¼šIt is allowed but not required for the caller to hold c.L during the call. å¯¹äºä¾‹å­æ¥è¯´ä¸¤ç§å†™æ³•éƒ½æ˜¯okçš„ã€‚ä½†æ¡ä»¶å˜é‡çš„æµ‹è¯•æ¡ä»¶è¡¨è¾¾å¼ï¼Œæ¯”å¦‚æœ¬ä¾‹å­ä¸­çš„readyæœ€å¥½æ˜¯å§‹ç»ˆåœ¨lockçš„ä¿æŠ¤ä¸‹çš„ã€‚æ‰€ä»¥è¿™é‡Œæˆ‘å»ºè®®ç”¨äº†ç¬¬ä¸€ç§ã€‚å¦åˆ™åœ¨å¤æ‚çš„åœºæ™¯ä¸‹ï¼Œä¸€æ—¦unlockï¼Œæ¡ä»¶å˜é‡æµ‹è¯•è¡¨è¾¾å¼ å°±ä¸å—æ§äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1651026093,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":330824,"user_name":"Calvin","can_delete":false,"product_type":"c1","uid":1603004,"ip_address":"","ucode":"0EEF5B207623B5","user_header":"https://static001.geekbang.org/account/avatar/00/18/75/bc/e24e181e.jpg","comment_is_top":false,"comment_ctime":1642182651,"is_pvip":false,"replies":[{"id":"120910","content":"æ²¡æœ‰ã€‚Goå›¢é˜Ÿè®¤ä¸ºé€’å½’é”æˆ–å¯é‡å…¥é”æ˜¯ä¸€ä¸ªbad ideaï¼Œæ‰€ä»¥ä¸æ”¯æŒã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1026224","ctime":1642412990,"ip_address":"","comment_id":330824,"utype":1}],"discussion_count":9,"race_medal":0,"score":"10232117243","product_id":100093501,"comment_content":"è€å¸ˆï¼ŒGo ä¸­æ²¡æœ‰å¯é‡å…¥çš„é”å—ï¼Ÿ","like_count":3,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546749,"discussion_content":"æ²¡æœ‰ã€‚Goå›¢é˜Ÿè®¤ä¸ºé€’å½’é”æˆ–å¯é‡å…¥é”æ˜¯ä¸€ä¸ªbad ideaï¼Œæ‰€ä»¥ä¸æ”¯æŒã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642412990,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1603004,"avatar":"https://static001.geekbang.org/account/avatar/00/18/75/bc/e24e181e.jpg","nickname":"Calvin","note":"","ucode":"0EEF5B207623B5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":546775,"discussion_content":"å¥½çš„ï¼Œè°¢è°¢è€å¸ˆè§£ç­”","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642422014,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":546749,"ip_address":""},"score":546775,"extra":""}]},{"author":{"id":1351076,"avatar":"https://static001.geekbang.org/account/avatar/00/14/9d/a4/e481ae48.jpg","nickname":"lesserror","note":"","ucode":"25A54D1165FCF6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":547471,"discussion_content":"åŒå­¦ï¼Œè¿™é‡Œçš„å¯é‡å…¥é”æ€ä¹ˆç†è§£ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642686349,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1603004,"avatar":"https://static001.geekbang.org/account/avatar/00/18/75/bc/e24e181e.jpg","nickname":"Calvin","note":"","ucode":"0EEF5B207623B5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1351076,"avatar":"https://static001.geekbang.org/account/avatar/00/14/9d/a4/e481ae48.jpg","nickname":"lesserror","note":"","ucode":"25A54D1165FCF6","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":547494,"discussion_content":"å°±æ˜¯åŒä¸€ä¸ªçº¿ç¨‹å®ƒå¯ä»¥é‡å¤è·å–åŒä¸€æŠŠé”å¤šæ¬¡ï¼Œå½“ç„¶ï¼Œè·å–äº†å¤šå°‘æ¬¡ï¼Œå°±è¦è§£é”å¤šå°‘æ¬¡ã€‚\nä¾‹å¦‚ Java ä¸­çš„ synchronizedï¼Œå‡è®¾æœ‰å¦‚ä¸‹ç¨‹åºï¼š\npublic synchronized void doSomething() { doOtherthing(); }\npublic synchronized void doOtherthing() { doAnotherthing(); }\npublic synchronized void doAnotherthing() {...}\nå½“çº¿ç¨‹ 1 è·å–åˆ°æ–¹æ³•æ‰€åœ¨ç±»çš„å¯¹è±¡çš„é”ï¼Œå»è°ƒç”¨ doSomething() æ–¹æ³•ï¼ŒdoSomething() æ–¹æ³•ä¸­åˆè°ƒç”¨äº† doOtherthing() æ–¹æ³•ï¼Œè€Œè°ƒç”¨ doOtherthing() æ–¹æ³•éœ€è¦è·å–åŒä¸€æŠŠå¯¹è±¡é”ï¼Œå¦‚æœä¸æ˜¯å¯é‡å…¥çš„ï¼Œè¿™é‡Œå°±ä¼šæ­»é”äº†ï¼ˆè‡ªå·±é”æ­»è‡ªå·±ï¼‰ï¼ŒåŒç† doOtherthing() æ–¹æ³•ä¸­è°ƒç”¨ doAnotherthing() æ–¹æ³•ä¹Ÿæ˜¯ä¸€æ ·çš„é“ç†ï¼Œè€Œè¿™é‡Œå¯é‡å…¥çš„è¯ï¼Œå¯¹äºåŒä¸€ä¸ªçº¿ç¨‹ 1ï¼Œå®ƒå¯ä»¥å¤šæ¬¡è·å–è¿™æŠŠé”ï¼ˆ3æ¬¡ï¼‰ï¼Œæ–¹æ³•è°ƒç”¨è¿”å›æ—¶ï¼Œè§£é” 3 æ¬¡ï¼Œä»è€Œå®Œå…¨é‡Šæ”¾æ‰è¿™æŠŠé”ï¼Œä¾›ä¸‹ä¸€ä¸ªçº¿ç¨‹å†æ¬¡è·å–ã€‚\nå¦å¤–ï¼ŒJava ä¸­çš„ ReentrantLock ä¹Ÿæ˜¯å¯é‡å…¥é”ï¼ˆä»åå­—ä¸Šå°±å¯ä»¥çœ‹å‡ºæ¥ï¼‰ã€‚","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1642697646,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":547471,"ip_address":""},"score":547494,"extra":""},{"author":{"id":1351076,"avatar":"https://static001.geekbang.org/account/avatar/00/14/9d/a4/e481ae48.jpg","nickname":"lesserror","note":"","ucode":"25A54D1165FCF6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1603004,"avatar":"https://static001.geekbang.org/account/avatar/00/18/75/bc/e24e181e.jpg","nickname":"Calvin","note":"","ucode":"0EEF5B207623B5","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":547656,"discussion_content":"è°¢è°¢å›ç­”ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642780844,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":547494,"ip_address":""},"score":547656,"extra":""}]},{"author":{"id":1102656,"avatar":"https://static001.geekbang.org/account/avatar/00/10/d3/40/0067d6db.jpg","nickname":"AKAä¸‰çš®","note":"","ucode":"D3BC5C60025E9D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546633,"discussion_content":"å¯é‡å…¥é”çš„å‰ææ˜¯çŸ¥é“å“ªä¸ªgoroutineæŒæœ‰äº†è¿™æŠŠé”ï¼Œgoæ ‡å‡†åº“æ˜¯ä¸æ”¯æŒçš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642382363,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1603004,"avatar":"https://static001.geekbang.org/account/avatar/00/18/75/bc/e24e181e.jpg","nickname":"Calvin","note":"","ucode":"0EEF5B207623B5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1102656,"avatar":"https://static001.geekbang.org/account/avatar/00/10/d3/40/0067d6db.jpg","nickname":"AKAä¸‰çš®","note":"","ucode":"D3BC5C60025E9D","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546774,"discussion_content":"ä¸çŸ¥é“åé¢ä¼šä¸ä¼šæ”¯æŒğŸ˜‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642421971,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":546633,"ip_address":""},"score":546774,"extra":""}]},{"author":{"id":1627670,"avatar":"https://static001.geekbang.org/account/avatar/00/18/d6/16/107f0d04.jpg","nickname":"å±±é’","note":"","ucode":"904AE3C23D3B92","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546370,"discussion_content":"æœ‰çš„  åŸºäºmutexå®ç°çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642306162,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1603004,"avatar":"https://static001.geekbang.org/account/avatar/00/18/75/bc/e24e181e.jpg","nickname":"Calvin","note":"","ucode":"0EEF5B207623B5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1627670,"avatar":"https://static001.geekbang.org/account/avatar/00/18/d6/16/107f0d04.jpg","nickname":"å±±é’","note":"","ucode":"904AE3C23D3B92","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":546394,"discussion_content":"ä¸æ˜¯æ ‡å‡†åº“ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642308106,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":546370,"ip_address":""},"score":546394,"extra":""}]}]},{"had_liked":false,"id":347042,"user_name":"éæ¢§æ¡ä¸æ­¢","can_delete":false,"product_type":"c1","uid":1803283,"ip_address":"","ucode":"F70A5D19D86742","user_header":"https://static001.geekbang.org/account/avatar/00/1b/84/13/9570f522.jpg","comment_is_top":false,"comment_ctime":1653638324,"is_pvip":true,"replies":[{"id":"126637","content":"å¤šæ•°æƒ…å†µä¸‹ï¼Œå¯¹æ€§èƒ½æ²¡æœ‰é‚£ä¹ˆé«˜è¦æ±‚ï¼Œé‡‡ç”¨åŸºäºcspæ¨¡å‹çš„å¹¶å‘è®¾è®¡æ˜¯ä¸»æµã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1026224","ctime":1653897741,"ip_address":"","comment_id":347042,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5948605620","product_id":100093501,"comment_content":"è€å¸ˆï¼Œæ—¢ç„¶å…±äº«å†…å­˜çš„æ€§èƒ½æ¯”channelå¥½ï¼Œä¸ºä»€ä¹ˆGoå€¡å¯¼ç”¨é€šä¿¡å»å…±äº«å†…å­˜å‘¢ï¼Ÿ","like_count":2,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":574201,"discussion_content":"å¤šæ•°æƒ…å†µä¸‹ï¼Œå¯¹æ€§èƒ½æ²¡æœ‰é‚£ä¹ˆé«˜è¦æ±‚ï¼Œé‡‡ç”¨åŸºäºcspæ¨¡å‹çš„å¹¶å‘è®¾è®¡æ˜¯ä¸»æµã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1653897741,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":331776,"user_name":"æ–‡ç»","can_delete":false,"product_type":"c1","uid":1072346,"ip_address":"","ucode":"2C059BD2A4276B","user_header":"https://static001.geekbang.org/account/avatar/00/10/5c/da/0a8bc27b.jpg","comment_is_top":false,"comment_ctime":1642756576,"is_pvip":true,"replies":[{"id":"121526","content":"ä½ çš„æƒ³æ³•æ²¡é”™ã€‚ä½†æ¡ä»¶å˜é‡çš„æ€§èƒ½æˆ‘è¿˜çœŸæ²¡æœ‰å’Œchannelå¯¹æ¯”è¿‡ï¼Œä»‹ç»æ¡ä»¶å˜é‡åªæ˜¯ä¸ºäº†ç»™å¤§å®¶â€œç§‘æ™®â€ä¸€ä¸‹å®ƒçš„å­˜åœ¨å’Œé€‚åˆçš„åœºæ™¯ã€‚è¯´å®è¯ï¼Œæ¡ä»¶å˜é‡ä½¿ç”¨çš„å¾ˆå°‘ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1026224","ctime":1643426584,"ip_address":"","comment_id":331776,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5937723872","product_id":100093501,"comment_content":"ç™½è€å¸ˆï¼Œæˆ‘è§‰å¾—æ¡ä»¶å˜é‡çš„ä¾‹å­å®Œå…¨å¯ä»¥ç”¨channelæ¥å®ç°ï¼Œä»£ç é€»è¾‘è¿˜ä¼šæ›´ç®€å•ä¸€äº›ã€‚<br>ä½¿ç”¨æ¡ä»¶å˜é‡ï¼Œè·ŸMutexä¸€æ ·ï¼Œæ˜¯åŸºäºæ€§èƒ½çš„è€ƒè™‘å—ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":548866,"discussion_content":"ä½ çš„æƒ³æ³•æ²¡é”™ã€‚ä½†æ¡ä»¶å˜é‡çš„æ€§èƒ½æˆ‘è¿˜çœŸæ²¡æœ‰å’Œchannelå¯¹æ¯”è¿‡ï¼Œä»‹ç»æ¡ä»¶å˜é‡åªæ˜¯ä¸ºäº†ç»™å¤§å®¶â€œç§‘æ™®â€ä¸€ä¸‹å®ƒçš„å­˜åœ¨å’Œé€‚åˆçš„åœºæ™¯ã€‚è¯´å®è¯ï¼Œæ¡ä»¶å˜é‡ä½¿ç”¨çš„å¾ˆå°‘ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1643426584,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":331657,"user_name":"lesserror","can_delete":false,"product_type":"c1","uid":1351076,"ip_address":"","ucode":"25A54D1165FCF6","user_header":"https://static001.geekbang.org/account/avatar/00/14/9d/a4/e481ae48.jpg","comment_is_top":false,"comment_ctime":1642689126,"is_pvip":false,"replies":[{"id":"121599","content":"1. å½“åŸmutexå‡ºäºåŠ é”çŠ¶æ€æ—¶è¢«copyï¼Œcopyåçš„mutexæœ¬èº«å°±æ˜¯åŠ é”çŠ¶æ€ï¼Œåè€…è¢«ä½¿ç”¨æ—¶å°±ä¼šè¢«é˜»å¡ã€‚<br>2. è®°å¾—ä¹‹å‰çš„æŸè®²é‡Œæåˆ°è¿‡<br>3. è·¯å¾„çš„ç¡®ä¸å¯¹ï¼Œåº”è¯¥æ˜¯$GOROOT&#47;src&#47;runtime&#47;internal&#47;atomic&#47;asm_amd64.s ,åç»­è®©ç¼–è¾‘è€å¸ˆæ›´æ–°ä¸€ä¸‹ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1026224","ctime":1643537097,"ip_address":"","comment_id":331657,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5937656422","product_id":100093501,"comment_content":"å…³äºGoçš„å¹¶å‘ï¼Œå†…å®¹æŒºå¤šçš„ã€‚ä¸“é—¨è®²Goå¹¶å‘ç¼–ç¨‹çš„ä¹¦ç±éƒ½æœ‰ä¸å°‘ã€‚å¤§ç™½è€å¸ˆè¿™é‡Œå¸¦é¢†æˆ‘ä»¬é€šä¿—æ˜“æ‡‚åœ°å…¥é—¨äº†ã€‚å¦æœ‰å‡ ä¸ªå°é—®é¢˜ã€‚<br><br>1. æ–‡ä¸­è¯´ï¼šâ€œç”šè‡³ï¼Œå¦‚æœæ‹·è´çš„æ—¶æœºä¸å¯¹ï¼Œæ¯”å¦‚åœ¨ä¸€ä¸ª mutex å¤„äº locked çš„çŠ¶æ€æ—¶å¯¹å®ƒè¿›è¡Œäº†æ‹·è´ï¼Œå°±ä¼šå¯¹å‰¯æœ¬è¿›è¡ŒåŠ é”æ“ä½œï¼Œå°†å¯¼è‡´åŠ é”çš„ Goroutine æ°¸è¿œé˜»å¡ä¸‹å»ã€‚â€  è¿™é‡Œä¸æ˜¯äº’ä¸ç›¸å…³å—ï¼Ÿ ä¸ºä»€ä¹ˆè¿˜ä¼šå¯¹å‰¯æœ¬åŠ é”å‘¢ï¼Ÿ<br><br>2. å¦å¤–ï¼Œå¥½åƒä¹Ÿæ²¡è®²åˆ°ç©ºç»“æ„ä½“åœ¨channelä¸­ä¼ é€’çš„å¥½å¤„ï¼Ÿ <br><br>3.  $GOROOT&#47;src&#47;runtime&#47;internal&#47;asm_amd64.s è¿™ä¸ªæ–‡ä»¶æœªæ‰¾åˆ°ï¼ˆMac Book ä¸Šé¢ï¼‰ã€‚","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":549057,"discussion_content":"1. å½“åŸmutexå‡ºäºåŠ é”çŠ¶æ€æ—¶è¢«copyï¼Œcopyåçš„mutexæœ¬èº«å°±æ˜¯åŠ é”çŠ¶æ€ï¼Œåè€…è¢«ä½¿ç”¨æ—¶å°±ä¼šè¢«é˜»å¡ã€‚\n2. è®°å¾—ä¹‹å‰çš„æŸè®²é‡Œæåˆ°è¿‡\n3. è·¯å¾„çš„ç¡®ä¸å¯¹ï¼Œåº”è¯¥æ˜¯$GOROOT/src/runtime/internal/atomic/asm_amd64.s ,åç»­è®©ç¼–è¾‘è€å¸ˆæ›´æ–°ä¸€ä¸‹ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1643537097,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":330823,"user_name":"Calvin","can_delete":false,"product_type":"c1","uid":1603004,"ip_address":"","ucode":"0EEF5B207623B5","user_header":"https://static001.geekbang.org/account/avatar/00/18/75/bc/e24e181e.jpg","comment_is_top":false,"comment_ctime":1642182411,"is_pvip":false,"replies":[{"id":"120913","content":"å¥½é—®é¢˜ğŸ‘ï¼è™½ç„¶éƒ½åœ¨syncåŒ…ä¸­ï¼Œä½†sync.WaitGroup,Mapï¼ŒPoolå±‚çº§æ›´highä¸€äº›ï¼Œæ˜¯åŸºäºMutexã€RWMutexå’ŒCondè¿™ä¸‰ä¸ªåŸºæœ¬åŸè¯­ä¹‹ä¸Šå®ç°çš„æœºåˆ¶ã€‚è€ƒè™‘åˆ°ç¯‡å¹…ï¼Œè¿™é‡Œfocus Mutexã€RWMutexå’ŒCondè¿™å‡ ä¸ªåŸºæœ¬çš„åŸè¯­ç»“æ„äº†ã€‚è‡³äºâ€œsync.WaitGroup å°±æ²¡æœ‰è¯´åˆ°ï¼Œç›´æ¥å°±ä½¿ç”¨ä¸Šäº†â€ï¼Œ ä¸€æ˜¯ç”¨èµ·æ¥å¾ˆç®€å•ï¼ŒäºŒæ˜¯æœ‰äº›æ—¶å€™ä¸å¾—ä¸ç”¨ï¼Œæ²¡æœ‰å¯æ›¿ä»£æ‰‹æ®µğŸ˜ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1026224","ctime":1642413844,"ip_address":"","comment_id":330823,"utype":1}],"discussion_count":4,"race_medal":0,"score":"5937149707","product_id":100093501,"comment_content":"è€å¸ˆï¼Œsync åŒ…ä¸­è¿˜æœ‰å…¶ä»–çš„ä¸€äº›åŒæ­¥åŸè¯­ï¼Œåé¢ä¼šç»§ç»­è¯´ä¸‹å—ï¼Ÿæ¯”å¦‚å‰é¢è¯¾ç¨‹å’Œæœ¬èŠ‚è¯¾ä¸­éƒ½æœ‰ä½¿ç”¨åˆ°çš„ sync.WaitGroup å°±æ²¡æœ‰è¯´åˆ°ï¼Œç›´æ¥å°±ä½¿ç”¨ä¸Šäº†ï¼Œå¦å¤–è¿˜æœ‰ sync.Mapï¼Œsync.Pool ç­‰ã€‚","like_count":2,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546754,"discussion_content":"å¥½é—®é¢˜ğŸ‘ï¼è™½ç„¶éƒ½åœ¨syncåŒ…ä¸­ï¼Œä½†sync.WaitGroup,Mapï¼ŒPoolå±‚çº§æ›´highä¸€äº›ï¼Œæ˜¯åŸºäºMutexã€RWMutexå’ŒCondè¿™ä¸‰ä¸ªåŸºæœ¬åŸè¯­ä¹‹ä¸Šå®ç°çš„æœºåˆ¶ã€‚è€ƒè™‘åˆ°ç¯‡å¹…ï¼Œè¿™é‡Œfocus Mutexã€RWMutexå’ŒCondè¿™å‡ ä¸ªåŸºæœ¬çš„åŸè¯­ç»“æ„äº†ã€‚è‡³äºâ€œsync.WaitGroup å°±æ²¡æœ‰è¯´åˆ°ï¼Œç›´æ¥å°±ä½¿ç”¨ä¸Šäº†â€ï¼Œ ä¸€æ˜¯ç”¨èµ·æ¥å¾ˆç®€å•ï¼ŒäºŒæ˜¯æœ‰äº›æ—¶å€™ä¸å¾—ä¸ç”¨ï¼Œæ²¡æœ‰å¯æ›¿ä»£æ‰‹æ®µğŸ˜ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642413844,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":3,"child_discussions":[{"author":{"id":1603004,"avatar":"https://static001.geekbang.org/account/avatar/00/18/75/bc/e24e181e.jpg","nickname":"Calvin","note":"","ucode":"0EEF5B207623B5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":546776,"discussion_content":"å¥½çš„ï¼Œé‚£å¯èƒ½å¾—åç»­è‡ªå·±åœ¨å…¶ä»–åœ°æ–¹è¡¥ä¹ ä¸€ä¸‹äº†ã€‚è¿˜æœ‰ä¸ªContext å¥½åƒä¹ŸæŒºé‡è¦çš„ï¼Œå’Œé‚£ä¸ªChannelä¸€èµ·è®²å°±å¥½äº†ã€‚ğŸ˜‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642422117,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":546754,"ip_address":""},"score":546776,"extra":""},{"author":{"id":1603004,"avatar":"https://static001.geekbang.org/account/avatar/00/18/75/bc/e24e181e.jpg","nickname":"Calvin","note":"","ucode":"0EEF5B207623B5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":546777,"discussion_content":"å¹¶å‘è¿™ä¸ªä¸œè¥¿ï¼Œçš„ç¡®æ„Ÿè§‰åªæœ‰3èŠ‚è¯¾ç¨‹éš¾ä»¥å…¨éƒ¨è¯´å®Œï¼Œéƒ½å¯ä»¥å•ç‹¬çš„çš„æ‹å‡ºæ¥ä¸“åšä¸€é—¨ä¸“æ è¯¾äº†ï¼Œä¸çŸ¥é“è¿™ä¸ªä¸“æ è¯¾ç»“æŸåï¼Œè€å¸ˆæœ‰æ²¡æœ‰æƒ³æ³•å°±è¿™ä¸ªâ€œGo å¹¶å‘â€å†å¼€ä¸€ä¸ªåŠ å¼ºç‰ˆä¸“æ è®²è®²å‘¢ï¼ŸğŸ˜‚","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1642422302,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":546754,"ip_address":""},"score":546777,"extra":""},{"author":{"id":1351076,"avatar":"https://static001.geekbang.org/account/avatar/00/14/9d/a4/e481ae48.jpg","nickname":"lesserror","note":"","ucode":"25A54D1165FCF6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1603004,"avatar":"https://static001.geekbang.org/account/avatar/00/18/75/bc/e24e181e.jpg","nickname":"Calvin","note":"","ucode":"0EEF5B207623B5","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":547469,"discussion_content":"å“ˆå“ˆå“ˆï¼ŒåŒå­¦å¥½æƒ³æ³•å“¦ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642686288,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":546777,"ip_address":""},"score":547469,"extra":""}]}]},{"had_liked":false,"id":358036,"user_name":"å†¯ä»å½¬","can_delete":false,"product_type":"c1","uid":2960877,"ip_address":"è¾½å®","ucode":"6E5CA08BC6366B","user_header":"","comment_is_top":false,"comment_ctime":1663839855,"is_pvip":false,"replies":[{"id":"130366","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1026224","ctime":1664112935,"ip_address":"è¾½å®","comment_id":358036,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1663839855","product_id":100093501,"comment_content":"ä»¥ä¸‹ä»£ç ä¼šäº§ç”Ÿæ­»é”:<br>func main() {<br>\tvar mu1 sync.Mutex<br>\tvar mu2 sync.Mutex<br>\tmu1.Lock()<br>\tgo func() {<br>\t\tmu2.Lock()<br>\t\tmu1.Lock()<br>\t\tmu1.Unlock()<br>\t\tmu2.Unlock()<br>\t\tfmt.Println(&quot;fun&quot;)<br>\t}()<br><br>\ttime.Sleep(2 * time.Second)<br>\tmu2.Lock()<br>\tmu2.Unlock()<br>\tmu1.Unlock()<br><br>\tfmt.Println(&quot;main&quot;)<br>}","like_count":0,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":588789,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1664112935,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"è¾½å®"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":356941,"user_name":"è èå¹é›ªâ€”Code","can_delete":false,"product_type":"c1","uid":1650378,"ip_address":"åŒ—äº¬","ucode":"A5B2FC661EE17D","user_header":"https://static001.geekbang.org/account/avatar/00/19/2e/ca/469f7266.jpg","comment_is_top":false,"comment_ctime":1662713609,"is_pvip":true,"replies":[{"id":"129898","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1026224","ctime":1662780209,"ip_address":"åŒ—äº¬","comment_id":356941,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1662713609","product_id":100093501,"comment_content":"å¹¶å‘è¿™å‡ èŠ‚è¯¾éœ€è¦å¤šçœ‹å‡ éï¼Œè€å¸ˆè®²è§£çš„å¤ªæ£’äº†ï¼å……å®ã€‚<br>ç©ºç»“æ„ä½“åœ¨channelä¸­ä¼ é€’çš„å¥½å¤„ï¼Œå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« å…³äºç©ºç»“æ„ä½“çš„åº”ç”¨åœºæ™¯ï¼šhttps:&#47;&#47;mp.weixin.qq.com&#47;s&#47;zbYIdB0HlYwYSQRXFFpqSg","like_count":0,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":587086,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662780209,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":340279,"user_name":"tianbingJ","can_delete":false,"product_type":"c1","uid":2163653,"ip_address":"","ucode":"666141CAD8260F","user_header":"https://static001.geekbang.org/account/avatar/00/21/03/c5/600fd645.jpg","comment_is_top":false,"comment_ctime":1648716706,"is_pvip":true,"replies":[{"id":"124467","content":"åœ¨å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œé‡‡ç”¨ç›´æ¥è¯»å–xçš„æ–¹å¼è¯»å–åˆ°çš„ä¸ä¸€å®šæ˜¯xçš„æœ€æ–°å€¼ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1026224","ctime":1648804603,"ip_address":"","comment_id":340279,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1648716706","product_id":100093501,"comment_content":"è¯·é—®è€å¸ˆï¼Œatomic.LoadInt64(&amp;x)  å’Œç›´æ¥è¯»å–xçš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ è¿™é‡Œæ€ä¹ˆä½“ç°atomicå‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":559522,"discussion_content":"åœ¨å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œé‡‡ç”¨ç›´æ¥è¯»å–xçš„æ–¹å¼è¯»å–åˆ°çš„ä¸ä¸€å®šæ˜¯xçš„æœ€æ–°å€¼ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1648804603,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":2163653,"avatar":"https://static001.geekbang.org/account/avatar/00/21/03/c5/600fd645.jpg","nickname":"tianbingJ","note":"","ucode":"666141CAD8260F","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":559525,"discussion_content":"äº†è§£äº†ï¼Œå¯è§æ€§é—®é¢˜å“ˆï¼Œç±»ä¼¼äºvolatile","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1648805222,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":559522,"ip_address":""},"score":559525,"extra":""}]}]},{"had_liked":false,"id":333154,"user_name":"singularity of space time","can_delete":false,"product_type":"c1","uid":2816371,"ip_address":"","ucode":"14502507C9F2D7","user_header":"https://static001.geekbang.org/account/avatar/00/2a/f9/73/01eafd3c.jpg","comment_is_top":false,"comment_ctime":1644140103,"is_pvip":true,"replies":[{"id":"121808","content":"Goä¸­æ²¡æœ‰volatileã€‚ä½†goç»™å‡ºäº†è‡ªå·±çš„memory modelï¼Œhttps:&#47;&#47;go.dev&#47;ref&#47;mem è¿™ä¸ªä¹Ÿè®¸èƒ½å›ç­”ä½ çš„é—®é¢˜ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1026224","ctime":1644292103,"ip_address":"","comment_id":333154,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1644140103","product_id":100093501,"comment_content":"è€å¸ˆï¼Œè¯·é—®ä¸€ä¸‹Goåœ¨æ²¡æœ‰volatileçš„æƒ…å†µä¸‹å¦‚ä½•ä¿è¯å…±äº«å˜é‡åœ¨ä¸åŒGoroutineçš„å¯è§æ€§ï¼Ÿå¦‚æœå¯è§æ€§ä¸èƒ½ä¿è¯çš„è¯ï¼Œé‚£ä¹ˆCASçš„æ­£ç¡®æ€§åº”è¯¥ä¹Ÿä¸èƒ½ä¿è¯å§ï¼Ÿè¿˜æ˜¯è¯´CASå†…éƒ¨çš„å®ç°å·²ç»ä¿è¯äº†å¯è§æ€§å‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":549912,"discussion_content":"Goä¸­æ²¡æœ‰volatileã€‚ä½†goç»™å‡ºäº†è‡ªå·±çš„memory modelï¼Œhttps://go.dev/ref/mem è¿™ä¸ªä¹Ÿè®¸èƒ½å›ç­”ä½ çš„é—®é¢˜ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644292103,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":2816371,"avatar":"https://static001.geekbang.org/account/avatar/00/2a/f9/73/01eafd3c.jpg","nickname":"singularity of space time","note":"","ucode":"14502507C9F2D7","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":549913,"discussion_content":"è°¢è°¢è€å¸ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644292254,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":549912,"ip_address":""},"score":549913,"extra":""}]}]},{"had_liked":false,"id":331775,"user_name":"æ–‡ç»","can_delete":false,"product_type":"c1","uid":1072346,"ip_address":"","ucode":"2C059BD2A4276B","user_header":"https://static001.geekbang.org/account/avatar/00/10/5c/da/0a8bc27b.jpg","comment_is_top":false,"comment_ctime":1642755789,"is_pvip":true,"replies":[{"id":"121605","content":"ä½ è¯´çš„æ²¡é”™ï¼Œæ— è®ºæ•´å‹å˜é‡å’Œè‡ªå®šä¹‰ç±»å‹å˜é‡ï¼Œatomicçš„æ“ä½œå®è´¨ä¸Šé’ˆå¯¹çš„éƒ½æ˜¯å­—é•¿é•¿åº¦çš„æŒ‡é’ˆã€‚ä½†æˆ‘è¯´çš„å¤æ‚ä¸´ç•ŒåŒºï¼Œè¿˜æœ‰å¦å¤–ä¸€ä¸ªæƒ…å†µï¼Œé‚£å°±æ˜¯åœ¨é”å†…éƒ¨æœ‰ç€å¯¹æ•°æ®çš„æ›´ä¸ºå¤æ‚çš„åˆ¤æ–­ä¸æ“ä½œï¼Œè€Œä¸ä»…ä»…æ˜¯+n,-n,æˆ–casã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1026224","ctime":1643538425,"ip_address":"","comment_id":331775,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1642755789","product_id":100093501,"comment_content":"ç™½è€å¸ˆï¼š<br>â€œatomic åŸå­æ“ä½œå¯ç”¨æ¥åŒæ­¥çš„èŒƒå›´æœ‰æ¯”è¾ƒå¤§é™åˆ¶ï¼Œåªèƒ½åŒæ­¥ä¸€ä¸ªæ•´å‹å˜é‡æˆ–è‡ªå®šä¹‰ç±»å‹å˜é‡ã€‚å¦‚æœæˆ‘ä»¬è¦å¯¹ä¸€ä¸ªå¤æ‚çš„ä¸´ç•ŒåŒºæ•°æ®è¿›è¡ŒåŒæ­¥ï¼Œé‚£ä¹ˆé¦–é€‰çš„ä¾æ—§æ˜¯ sync åŒ…ä¸­çš„åŸè¯­ã€‚â€<br>è¿™é‡Œè¯´çš„æ•´å‹å˜é‡å’Œè‡ªå®šä¹‰ç±»å‹å˜é‡ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªå­—é•¿çš„å¤§å°ã€‚åœ¨64ä½cpuä¸Šå°±æ˜¯8ä¸ªå­—èŠ‚ã€‚å› ä¸ºCPUé€šè¿‡æ•°æ®æ€»çº¿ï¼Œä¸€æ¬¡ä»å†…å­˜ä¸­æœ€å¤šåªèƒ½è·å–ä¸€ä¸ªå­—é•¿çš„ä¿¡æ¯ã€‚æ‰€ä»¥atomicçš„é™åˆ¶ä¹Ÿæ˜¯ä¸€ä¸ªå­—é•¿ã€‚","like_count":0,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":549063,"discussion_content":"ä½ è¯´çš„æ²¡é”™ï¼Œæ— è®ºæ•´å‹å˜é‡å’Œè‡ªå®šä¹‰ç±»å‹å˜é‡ï¼Œatomicçš„æ“ä½œå®è´¨ä¸Šé’ˆå¯¹çš„éƒ½æ˜¯å­—é•¿é•¿åº¦çš„æŒ‡é’ˆã€‚ä½†æˆ‘è¯´çš„å¤æ‚ä¸´ç•ŒåŒºï¼Œè¿˜æœ‰å¦å¤–ä¸€ä¸ªæƒ…å†µï¼Œé‚£å°±æ˜¯åœ¨é”å†…éƒ¨æœ‰ç€å¯¹æ•°æ®çš„æ›´ä¸ºå¤æ‚çš„åˆ¤æ–­ä¸æ“ä½œï¼Œè€Œä¸ä»…ä»…æ˜¯+n,-n,æˆ–casã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1643538425,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":330861,"user_name":"BinyGo","can_delete":false,"product_type":"c1","uid":2639381,"ip_address":"","ucode":"182ADA4532C98B","user_header":"https://static001.geekbang.org/account/avatar/00/28/46/15/0f215f66.jpg","comment_is_top":false,"comment_ctime":1642230610,"is_pvip":true,"replies":[{"id":"121586","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1026224","ctime":1643521630,"ip_address":"","comment_id":330861,"utype":1}],"discussion_count":1,"race_medal":3,"score":"1642230610","product_id":100093501,"comment_content":"å¹¶å‘æ¯ç¯‡éƒ½å¹²è´§æ»¡æ»¡ï¼Œ3åˆ·4åˆ·éƒ½è¿˜æ²¡å®Œå…¨æ¶ˆåŒ–å®Œï¼ŒåŠ æ²¹~","like_count":0,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":549027,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1643521630,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}