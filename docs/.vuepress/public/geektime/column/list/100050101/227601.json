{"id":227601,"title":"05 | ç´¢å¼•ï¼ˆä¸‹ï¼‰ï¼šä½ç§»ç´¢å¼•å’Œæ—¶é—´æˆ³ç´¢å¼•çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯èƒ¡å¤•ã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬ç»§ç»­è¯´ç´¢å¼•é‚£äº›äº‹å„¿ã€‚</p><p>åœ¨ä¸ŠèŠ‚è¯¾ï¼Œæˆ‘å¸¦ä½ é‡ç‚¹å­¦ä¹ äº†Kafkaæºç ä¸­ç´¢å¼•çš„æŠ½è±¡çˆ¶ç±»AbstractIndexã€‚æˆ‘åˆ†æäº†AbstractIndexç±»çš„å¤§ä½“å¯¹è±¡ç»“æ„ï¼Œè¿˜ä»‹ç»äº†ç¤¾åŒºæ”¹è¿›ç‰ˆçš„äºŒåˆ†æŸ¥æ‰¾ç®—æ³•åœ¨Kafkaç´¢å¼•ä¸Šçš„åº”ç”¨ã€‚</p><p>å‰é¢è¯´è¿‡ï¼ŒKafkaç´¢å¼•ç±»å‹æœ‰ä¸‰å¤§ç±»ï¼šä½ç§»ç´¢å¼•ã€æ—¶é—´æˆ³ç´¢å¼•å’Œå·²ä¸­æ­¢äº‹åŠ¡ç´¢å¼•ã€‚ç›¸æ¯”äºæœ€åä¸€ç±»ç´¢å¼•ï¼Œå‰ä¸¤ç±»ç´¢å¼•çš„å‡ºé•œç‡æ›´é«˜ä¸€äº›ã€‚åœ¨Kafkaçš„æ•°æ®è·¯å¾„ä¸‹ï¼Œä½ è‚¯å®šçœ‹åˆ°è¿‡å¾ˆå¤š.indexå’Œ.timeindexåç¼€çš„æ–‡ä»¶ã€‚ä¸çŸ¥ä½ æ˜¯å¦æœ‰è¿‡è¿™æ ·çš„ç–‘é—®ï¼šâ€œè¿™äº›æ–‡ä»¶æ˜¯ç”¨æ¥åšä»€ä¹ˆçš„å‘¢ï¼Ÿâ€ ç°åœ¨æˆ‘å¯ä»¥æ˜ç¡®å‘Šè¯‰ä½ ï¼š.indexæ–‡ä»¶å°±æ˜¯Kafkaä¸­çš„ä½ç§»ç´¢å¼•æ–‡ä»¶ï¼Œè€Œ.timeindexæ–‡ä»¶åˆ™æ˜¯æ—¶é—´æˆ³ç´¢å¼•æ–‡ä»¶ã€‚</p><p>é‚£ä¹ˆï¼Œä½ç§»ç´¢å¼•å’Œæ—¶é—´æˆ³ç´¢å¼•åˆ°åº•æ˜¯åšä»€ä¹ˆç”¨çš„å‘¢ï¼Ÿå®ƒä»¬ä¹‹é—´çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿä»Šå¤©ï¼Œæˆ‘å°±ä¸ºä½ æ­æ™“è¿™äº›é—®é¢˜çš„ç­”æ¡ˆã€‚</p><h2>ä½ç§»ç´¢å¼•</h2><p>åœ¨å­¦ä¹ Kafkaçš„ä»»ä½•ä¸€ç±»ç´¢å¼•çš„æ—¶å€™ï¼Œæˆ‘ä»¬éƒ½è¦å…³æ³¨ä¸¤ä¸ªé—®é¢˜ï¼š</p><ol>\n<li>ç´¢å¼•ä¸­çš„ç´¢å¼•é¡¹æ˜¯å¦‚ä½•å®šä¹‰çš„ï¼Ÿ</li>\n<li>å¦‚ä½•å‘ç´¢å¼•å†™å…¥æ–°çš„ç´¢å¼•é¡¹ï¼Ÿ</li>\n</ol><p>çœ‹åˆ°è¿™é‡Œï¼Œä½ å¯èƒ½ä¼šå¾ˆç–‘æƒ‘ï¼šâ€œç­‰ç­‰ï¼Œéš¾é“æˆ‘ä»¬ä¸éœ€è¦å…³å¿ƒå¦‚ä½•æŸ¥è¯¢ç´¢å¼•å—ï¼Ÿâ€ å½“ç„¶éœ€è¦å•¦ï¼ä¸ŠèŠ‚è¯¾æˆ‘ä»¬ä¸æ˜¯è®²è¿‡äºŒåˆ†æŸ¥æ‰¾ç®—æ³•åœ¨ç´¢å¼•ä¸­çš„åº”ç”¨äº†å—ï¼Ÿå¦‚æœä½ è§‰å¾—æœ‰ç‚¹ç”Ÿç–äº†ï¼Œé‚£å°±èµ¶å¿«å…ˆå»å¤ä¹ ä¸€ä¸‹å§ã€‚</p><!-- [[[read_end]]] --><p>ç°åœ¨ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ç´¢å¼•é¡¹çš„å®šä¹‰ã€‚</p><h3>ç´¢å¼•é¡¹çš„å®šä¹‰</h3><p>ä½ç§»ç´¢å¼•ä¹Ÿå°±æ˜¯æ‰€è°“çš„OffsetIndexï¼Œå®ƒå¯æ˜¯ä¸€ä¸ªè€èµ„å†çš„ç»„ä»¶äº†ã€‚å¦‚æœæˆ‘æ²¡è®°é”™çš„è¯ï¼Œå›½å†…å¤§é¢ç§¯ä½¿ç”¨Kafkaåº”è¯¥æ˜¯åœ¨0.8æ—¶ä»£ã€‚ä»é‚£ä¸ªæ—¶å€™å¼€å§‹ï¼ŒOffsetIndexå°±å·²ç»å­˜åœ¨äº†ã€‚æ¯å½“Consumeréœ€è¦ä»ä¸»é¢˜åˆ†åŒºçš„æŸä¸ªä½ç½®å¼€å§‹è¯»å–æ¶ˆæ¯æ—¶ï¼ŒKafkaå°±ä¼šç”¨åˆ°OffsetIndexç›´æ¥å®šä½ç‰©ç†æ–‡ä»¶ä½ç½®ï¼Œä»è€Œé¿å…äº†å› ä¸ºä»å¤´è¯»å–æ¶ˆæ¯è€Œå¼•å…¥çš„æ˜‚è´µçš„I/Oæ“ä½œã€‚</p><p>åœ¨ä¸ŠèŠ‚è¯¾ï¼Œæˆ‘æåˆ°è¿‡ï¼Œä¸åŒç´¢å¼•ç±»å‹ä¿å­˜ä¸åŒçš„&lt;Key, Value&gt;å¯¹ã€‚å°±OffsetIndexè€Œè¨€ï¼ŒKeyå°±æ˜¯æ¶ˆæ¯çš„ç›¸å¯¹ä½ç§»ï¼ŒValueæ˜¯ä¿å­˜è¯¥æ¶ˆæ¯çš„æ—¥å¿—æ®µæ–‡ä»¶ä¸­è¯¥æ¶ˆæ¯ç¬¬ä¸€ä¸ªå­—èŠ‚çš„ç‰©ç†æ–‡ä»¶ä½ç½®ã€‚</p><p>è¿™é‡Œæˆ‘æ¥å…·ä½“è§£é‡Šä¸€ä¸‹ç›¸å¯¹ä½ç§»çš„å«ä¹‰ã€‚è¿˜è®°å¾—AbstractIndexç±»ä¸­çš„æŠ½è±¡æ–¹æ³•entrySizeå—ï¼Ÿå®ƒå®šä¹‰äº†å•ä¸ª&lt;Key, Value&gt;å¯¹æ‰€ç”¨çš„å­—èŠ‚æ•°ã€‚å¯¹äºOffsetIndexæ¥è¯´ï¼ŒentrySizeå°±æ˜¯8ï¼Œå¦‚OffsetIndex.scalaä¸­å®šä¹‰çš„é‚£æ ·ï¼š</p><pre><code>    override def entrySize = 8\n</code></pre><p>ä¸ºä»€ä¹ˆæ˜¯8å‘¢ï¼Ÿç›¸å¯¹ä½ç§»æ˜¯ä¸€ä¸ªæ•´å‹ï¼ˆIntegerï¼‰ï¼Œå ç”¨4ä¸ªå­—èŠ‚ï¼Œç‰©ç†æ–‡ä»¶ä½ç½®ä¹Ÿæ˜¯ä¸€ä¸ªæ•´å‹ï¼ŒåŒæ ·å ç”¨4ä¸ªå­—èŠ‚ï¼Œå› æ­¤æ€»å…±æ˜¯8ä¸ªå­—èŠ‚ã€‚</p><p>é‚£ç›¸å¯¹ä½ç§»æ˜¯ä»€ä¹ˆå€¼å‘¢ï¼Ÿæˆ‘ä»¬çŸ¥é“ï¼ŒKafkaä¸­çš„æ¶ˆæ¯ä½ç§»å€¼æ˜¯ä¸€ä¸ªé•¿æ•´å‹ï¼ˆLongï¼‰ï¼Œåº”è¯¥å ç”¨8ä¸ªå­—èŠ‚æ‰å¯¹ã€‚åœ¨ä¿å­˜OffsetIndexçš„&lt;Key, Value&gt;å¯¹æ—¶ï¼ŒKafkaåšäº†ä¸€äº›ä¼˜åŒ–ã€‚æ¯ä¸ªOffsetIndexå¯¹è±¡åœ¨åˆ›å»ºæ—¶ï¼Œéƒ½å·²ç»ä¿å­˜äº†å¯¹åº”æ—¥å¿—æ®µå¯¹è±¡çš„èµ·å§‹ä½ç§»ï¼Œå› æ­¤ï¼ŒOffsetIndexç´¢å¼•é¡¹æ²¡å¿…è¦ä¿å­˜å®Œæ•´çš„8å­—èŠ‚ä½ç§»å€¼ã€‚ç›¸ååœ°ï¼Œå®ƒåªéœ€è¦ä¿å­˜ä¸èµ·å§‹ä½ç§»çš„å·®å€¼ï¼ˆDeltaï¼‰å°±å¤Ÿäº†ï¼Œè€Œè¿™ä¸ªå·®å€¼æ˜¯å¯ä»¥è¢«æ•´å‹å®¹çº³çš„ã€‚è¿™ç§è®¾è®¡å¯ä»¥è®©OffsetIndexæ¯ä¸ªç´¢å¼•é¡¹éƒ½èŠ‚çœ4ä¸ªå­—èŠ‚ã€‚</p><p>ä¸¾ä¸ªç®€å•çš„ä¾‹å­ã€‚å‡è®¾ä¸€ä¸ªç´¢å¼•æ–‡ä»¶ä¿å­˜äº†1000ä¸ªç´¢å¼•é¡¹ï¼Œä½¿ç”¨ç›¸å¯¹ä½ç§»å€¼å°±èƒ½èŠ‚çœå¤§çº¦4MBçš„ç©ºé—´ï¼Œè¿™æ˜¯ä¸æ˜¯ä¸€ä»¶å¾ˆåˆ’ç®—çš„äº‹æƒ…å‘¢ï¼Ÿ</p><p>OffsetIndexå®šä¹‰äº†ä¸“é—¨çš„æ–¹æ³•ï¼Œç”¨äºå°†ä¸€ä¸ªLongå‹çš„ä½ç§»å€¼è½¬æ¢æˆç›¸å¯¹ä½ç§»ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>def relativeOffset(offset: Long): Int = {\n    val relativeOffset = toRelative(offset)\n    if (relativeOffset.isEmpty)\n      // å¦‚æœæ— æ³•è½¬æ¢æˆåŠŸï¼ˆæ¯”å¦‚å·®å€¼è¶…è¿‡äº†æ•´å‹è¡¨ç¤ºèŒƒå›´)ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸\n      throw new IndexOffsetOverflowException(s&quot;Integer overflow for offset: $offset (${file.getAbsoluteFile})&quot;)\n    relativeOffset.get\n}\n</code></pre><p>relativeOffsetæ–¹æ³•è°ƒç”¨äº†çˆ¶ç±»çš„toRelativeæ–¹æ³•æ‰§è¡ŒçœŸæ­£çš„è½¬æ¢ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹toRelativeæ–¹æ³•çš„å®ç°ã€‚</p><pre><code>private def toRelative(offset: Long): Option[Int] = {\n  val relativeOffset = offset - baseOffset\n  if (relativeOffset &lt; 0 || relativeOffset &gt; Int.MaxValue)\n    None\n  else\n    Some(relativeOffset.toInt)\n}\n</code></pre><p>é€»è¾‘å¾ˆç®€å•ï¼šç¬¬ä¸€æ­¥æ˜¯è®¡ç®—ç»™å®šçš„offsetå€¼ä¸baseOffsetçš„å·®å€¼ï¼›ç¬¬äºŒæ­¥æ˜¯æ ¡éªŒè¯¥å·®å€¼ä¸èƒ½æ˜¯è´Ÿæ•°æˆ–ä¸èƒ½è¶…è¿‡æ•´å‹è¡¨ç¤ºèŒƒå›´ã€‚å¦‚æœæ ¡éªŒé€šè¿‡ï¼Œå°±ç›´æ¥è¿”å›è¯¥å·®å€¼ä½œä¸ºç›¸å¯¹ä½ç§»å€¼ï¼Œå¦åˆ™å°±è¿”å›Noneè¡¨ç¤ºè½¬æ¢å¤±è´¥ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/c2/00/c259aff07a71aa4fe16165f423b3d600.jpg?wh=2766*2180\" alt=\"\"></p><p>ç°åœ¨ï¼Œä½ çŸ¥é“OffsetIndexä¸­çš„ç´¢å¼•é¡¹ä¸ºä»€ä¹ˆæ˜¯8ä¸ªå­—èŠ‚ä»¥åŠä½ç§»å€¼æ˜¯å¦‚ä½•è¢«è½¬æ¢æˆç›¸å¯¹ä½ç§»äº†å§ï¼Ÿ</p><p>å½“è¯»å–OffsetIndexæ—¶ï¼Œæºç è¿˜éœ€è¦å°†ç›¸å¯¹ä½ç§»å€¼è¿˜åŸæˆä¹‹å‰çš„å®Œæ•´ä½ç§»ã€‚è¿™ä¸ªæ˜¯åœ¨parseEntryæ–¹æ³•ä¸­å®ç°çš„ã€‚</p><pre><code>override protected def parseEntry(buffer: ByteBuffer, n: Int): OffsetPosition = {\n  OffsetPosition(baseOffset + relativeOffset(buffer, n), physical(buffer, n))\n}\n</code></pre><p>æˆ‘æ¥ç»™ä½ è§£é‡Šä¸‹å…·ä½“çš„å®ç°æ–¹æ³•ã€‚</p><p>è¿™ä¸ªæ–¹æ³•è¿”å›ä¸€ä¸ªOffsetPositionç±»å‹ã€‚è¯¥ç±»æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«è¿”å›ç´¢å¼•é¡¹çš„Keyå’ŒValueã€‚</p><p><strong>è¿™é‡Œçš„parseEntryæ–¹æ³•ï¼Œå°±æ˜¯è¦æ„é€ OffsetPositionæ‰€éœ€çš„Keyå’ŒValue</strong>ã€‚Keyæ˜¯ç´¢å¼•é¡¹ä¸­çš„å®Œæ•´ä½ç§»å€¼ï¼Œ<strong>ä»£ç ä½¿ç”¨baseOffset + relativeOffset(buffer, n)çš„æ–¹å¼å°†ç›¸å¯¹ä½ç§»å€¼è¿˜åŸæˆå®Œæ•´ä½ç§»å€¼</strong>ï¼›Valueæ˜¯è¿™ä¸ªä½ç§»å€¼ä¸Šæ¶ˆæ¯åœ¨æ—¥å¿—æ®µæ–‡ä»¶ä¸­çš„ç‰©ç†ä½ç½®ï¼Œä»£ç è°ƒç”¨physicalæ–¹æ³•è®¡ç®—è¿™ä¸ªç‰©ç†ä½ç½®å¹¶æŠŠå®ƒä½œä¸ºValueã€‚</p><p>æœ€åï¼ŒparseEntryæ–¹æ³•æŠŠKeyå’ŒValueå°è£…åˆ°ä¸€ä¸ªOffsetPositionå®ä¾‹ä¸­ï¼Œç„¶åå°†è¿™ä¸ªå®ä¾‹è¿”å›ã€‚</p><p>ç”±äºç´¢å¼•æ–‡ä»¶çš„æ€»å­—èŠ‚æ•°å°±æ˜¯ç´¢å¼•é¡¹å­—èŠ‚æ•°ä¹˜ä»¥ç´¢å¼•é¡¹æ•°ï¼Œå› æ­¤ï¼Œä»£ç ç»“åˆentrySizeå’Œbuffer.getIntæ–¹æ³•èƒ½å¤Ÿè½»æ¾åœ°è®¡ç®—å‡ºç¬¬nä¸ªç´¢å¼•é¡¹æ‰€å¤„çš„ç‰©ç†æ–‡ä»¶ä½ç½®ã€‚è¿™å°±æ˜¯physicalæ–¹æ³•åšçš„äº‹æƒ…ã€‚</p><h3>å†™å…¥ç´¢å¼•é¡¹</h3><p>å¥½äº†ï¼Œæœ‰äº†è¿™äº›åŸºç¡€ï¼Œä¸‹é¢çš„å†…å®¹å°±å¾ˆå®¹æ˜“ç†è§£äº†ã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹OffsetIndexä¸­æœ€é‡è¦çš„æ“ä½œâ€”â€”<strong>å†™å…¥ç´¢å¼•é¡¹appendæ–¹æ³•çš„å®ç°</strong>ã€‚</p><pre><code>def append(offset: Long, position: Int): Unit = {\n  inLock(lock) {\n    // ç´¢å¼•æ–‡ä»¶å¦‚æœå·²ç»å†™æ»¡ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸\n    require(!isFull, &quot;Attempt to append to a full index (size = &quot; + _entries + &quot;).&quot;)\n    // è¦ä¿è¯å¾…å†™å…¥çš„ä½ç§»å€¼offsetæ¯”å½“å‰ç´¢å¼•æ–‡ä»¶ä¸­æ‰€æœ‰ç°å­˜çš„ä½ç§»å€¼éƒ½è¦å¤§\n    // è¿™ä¸»è¦æ˜¯ä¸ºäº†ç»´æŠ¤ç´¢å¼•çš„å•è°ƒå¢åŠ æ€§\n    if (_entries == 0 || offset &gt; _lastOffset) {\n      trace(s&quot;Adding index entry $offset =&gt; $position to ${file.getAbsolutePath}&quot;)\n      mmap.putInt(relativeOffset(offset)) // å‘mmapå†™å…¥ç›¸å¯¹ä½ç§»å€¼\n      mmap.putInt(position) // å‘mmapå†™å…¥ç‰©ç†æ–‡ä»¶ä½ç½®\n      _entries += 1 // æ›´æ–°ç´¢å¼•é¡¹ä¸ªæ•°\n      _lastOffset = offset // æ›´æ–°å½“å‰ç´¢å¼•æ–‡ä»¶æœ€å¤§ä½ç§»å€¼\n      // ç¡®ä¿å†™å…¥ç´¢å¼•é¡¹æ ¼å¼ç¬¦åˆè¦æ±‚\n      require(_entries * entrySize == mmap.position(), s&quot;$entries entries but file position in index is ${mmap.position()}.&quot;)\n    } else {\n      throw new InvalidOffsetException(s&quot;Attempt to append an offset ($offset) to position $entries no larger than&quot; +\n        s&quot; the last offset appended (${_lastOffset}) to ${file.getAbsolutePath}.&quot;)\n    }\n  }\n}\n</code></pre><p>appendæ–¹æ³•æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼š<strong>Longå‹çš„ä½ç§»å€¼</strong>å’Œ<strong>Integerå‹çš„ç‰©ç†æ–‡ä»¶ä½ç½®</strong>ã€‚<strong>è¯¥æ–¹æ³•æœ€é‡è¦çš„ä¸¤æ­¥ï¼Œå°±æ˜¯åˆ†åˆ«å‘mmapå†™å…¥ç›¸å¯¹ä½ç§»å€¼å’Œç‰©ç†æ–‡ä»¶ä½ç½®</strong>ã€‚æˆ‘ä½¿ç”¨ä¸€å¼ å›¾ï¼Œæ¥æ€»ç»“ä¸‹appendæ–¹æ³•çš„æ‰§è¡Œæµç¨‹ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/17/e6/176bec3d45790509c0587614be7f61e6.jpg?wh=2568*3354\" alt=\"\"></p><p>é™¤äº†appendæ–¹æ³•ï¼Œç´¢å¼•è¿˜æœ‰ä¸€ä¸ªå¸¸è§çš„æ“ä½œï¼šæˆªæ–­æ“ä½œï¼ˆTruncationï¼‰ã€‚<strong>æˆªæ–­æ“ä½œæ˜¯æŒ‡ï¼Œå°†ç´¢å¼•æ–‡ä»¶å†…å®¹ç›´æ¥è£å‰ªæ‰ä¸€éƒ¨åˆ†</strong>ã€‚æ¯”å¦‚ï¼ŒOffsetIndexç´¢å¼•æ–‡ä»¶ä¸­å½“å‰ä¿å­˜äº†100ä¸ªç´¢å¼•é¡¹ï¼Œæˆ‘æƒ³åªä¿ç•™æœ€å¼€å§‹çš„40ä¸ªç´¢å¼•é¡¹ã€‚æºç å®šä¹‰äº†truncateToEntriesæ–¹æ³•æ¥å®ç°è¿™ä¸ªéœ€æ±‚ï¼š</p><pre><code>private def truncateToEntries(entries: Int): Unit = {\n  inLock(lock) {\n    _entries = entries\n    mmap.position(_entries * entrySize)\n    _lastOffset = lastEntry.offset\n    debug(s&quot;Truncated index ${file.getAbsolutePath} to $entries entries;&quot; +\n      s&quot; position is now ${mmap.position()} and last offset is now ${_lastOffset}&quot;)\n  }\n}\n\n</code></pre><p>è¿™ä¸ªæ–¹æ³•æ¥æ”¶entrieså‚æ•°ï¼Œè¡¨ç¤º<strong>è¦æˆªå–åˆ°å“ªä¸ªæ§½</strong>ï¼Œä¸»è¦çš„é€»è¾‘å®ç°æ˜¯è°ƒç”¨mmapçš„positionæ–¹æ³•ã€‚æºç ä¸­çš„_entries * entrySizeå°±æ˜¯mmapè¦æˆªå–åˆ°çš„å­—èŠ‚å¤„ã€‚</p><p>ä¸‹é¢ï¼Œæˆ‘æ¥è¯´è¯´OffsetIndexçš„ä½¿ç”¨æ–¹å¼ã€‚</p><p>æ—¢ç„¶OffsetIndexè¢«ç”¨æ¥å¿«é€Ÿå®šä½æ¶ˆæ¯æ‰€åœ¨çš„ç‰©ç†æ–‡ä»¶ä½ç½®ï¼Œé‚£ä¹ˆå¿…ç„¶éœ€è¦å®šä¹‰ä¸€ä¸ªæ–¹æ³•æ‰§è¡Œå¯¹åº”çš„æŸ¥è¯¢é€»è¾‘ã€‚è¿™ä¸ªæ–¹æ³•å°±æ˜¯lookupã€‚</p><pre><code>def lookup(targetOffset: Long): OffsetPosition = {\n  maybeLock(lock) {\n    val idx = mmap.duplicate // ä½¿ç”¨ç§æœ‰å˜é‡å¤åˆ¶å‡ºæ•´ä¸ªç´¢å¼•æ˜ å°„åŒº\n    // largestLowerBoundSlotForæ–¹æ³•åº•å±‚ä½¿ç”¨äº†æ”¹è¿›ç‰ˆçš„äºŒåˆ†æŸ¥æ‰¾ç®—æ³•å¯»æ‰¾å¯¹åº”çš„æ§½\n    val slot = largestLowerBoundSlotFor(idx, targetOffset, IndexSearchType.KEY)\n    // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œè¿”å›ä¸€ä¸ªç©ºçš„ä½ç½®ï¼Œå³ç‰©ç†æ–‡ä»¶ä½ç½®ä»0å¼€å§‹ï¼Œè¡¨ç¤ºä»å¤´è¯»æ—¥å¿—æ–‡ä»¶\n\t// å¦åˆ™è¿”å›slotæ§½å¯¹åº”çš„ç´¢å¼•é¡¹\n    if(slot == -1)\n      OffsetPosition(baseOffset, 0)\n    else\n      parseEntry(idx, slot)\n  }\n}\n</code></pre><p>æˆ‘æŠŠä¸»è¦çš„é€»è¾‘ä»¥æ³¨é‡Šçš„æ–¹å¼åŠ åˆ°äº†ä»£ç ä¸­ã€‚è¯¥æ–¹æ³•è¿”å›çš„ï¼Œæ˜¯ä¸å¤§äºç»™å®šä½ç§»å€¼targetOffsetçš„æœ€å¤§ä½ç§»å€¼ï¼Œä»¥åŠå¯¹åº”çš„ç‰©ç†æ–‡ä»¶ä½ç½®ã€‚ä½ å¤§è‡´å¯ä»¥æŠŠè¿™ä¸ªæ–¹æ³•ï¼Œç†è§£ä¸ºä½ç§»å€¼çš„FLOORå‡½æ•°ã€‚</p><h2>æ—¶é—´æˆ³ç´¢å¼•</h2><p>è¯´å®Œäº†OffsetIndexï¼Œæˆ‘ä»¬æ¥çœ‹å¦ä¸€å¤§ç±»ç´¢å¼•ï¼šæ—¶é—´æˆ³ç´¢å¼•ï¼Œå³TimeIndexã€‚ä¸OffsetIndexç±»ä¼¼ï¼Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨TimeIndexä¸­ç´¢å¼•é¡¹çš„å®šä¹‰ï¼Œä»¥åŠå¦‚ä½•å†™å…¥TimeIndexç´¢å¼•é¡¹ã€‚</p><h3>ç´¢å¼•é¡¹çš„å®šä¹‰</h3><p>ä¸OffsetIndexä¸åŒçš„æ˜¯ï¼ŒTimeIndexä¿å­˜çš„æ˜¯&lt;æ—¶é—´æˆ³ï¼Œç›¸å¯¹ä½ç§»å€¼&gt;å¯¹ã€‚æ—¶é—´æˆ³éœ€è¦ä¸€ä¸ªé•¿æ•´å‹æ¥ä¿å­˜ï¼Œç›¸å¯¹ä½ç§»å€¼ä½¿ç”¨Integeræ¥ä¿å­˜ã€‚å› æ­¤ï¼ŒTimeIndexå•ä¸ªç´¢å¼•é¡¹éœ€è¦å ç”¨12ä¸ªå­—èŠ‚ã€‚è¿™ä¹Ÿæ­ç¤ºäº†ä¸€ä¸ªé‡è¦çš„äº‹å®ï¼š<strong>åœ¨ä¿å­˜åŒç­‰æ•°é‡ç´¢å¼•é¡¹çš„åŸºç¡€ä¸Šï¼ŒTimeIndexä¼šæ¯”OffsetIndexå ç”¨æ›´å¤šçš„ç£ç›˜ç©ºé—´</strong>ã€‚</p><h3>å†™å…¥ç´¢å¼•é¡¹</h3><p>TimeIndexä¹Ÿæœ‰appendæ–¹æ³•ï¼Œåªä¸è¿‡å®ƒå«ä½œmaybeAppendã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹å®ƒçš„å®ç°é€»è¾‘ã€‚</p><pre><code>def maybeAppend(timestamp: Long, offset: Long, skipFullCheck: Boolean = false): Unit = {\n  inLock(lock) {\n    if (!skipFullCheck)\n      // å¦‚æœç´¢å¼•æ–‡ä»¶å·²å†™æ»¡ï¼ŒæŠ›å‡ºå¼‚å¸¸\n      require(!isFull, &quot;Attempt to append to a full time index (size = &quot; + _entries + &quot;).&quot;)\n    // ç¡®ä¿ç´¢å¼•å•è°ƒå¢åŠ æ€§\n    if (_entries != 0 &amp;&amp; offset &lt; lastEntry.offset)\n      throw new InvalidOffsetException(s&quot;Attempt to append an offset ($offset) to slot ${_entries} no larger than&quot; +\n        s&quot; the last offset appended (${lastEntry.offset}) to ${file.getAbsolutePath}.&quot;)\n    // ç¡®ä¿æ—¶é—´æˆ³çš„å•è°ƒå¢åŠ æ€§\n    if (_entries != 0 &amp;&amp; timestamp &lt; lastEntry.timestamp)\n      throw new IllegalStateException(s&quot;Attempt to append a timestamp ($timestamp) to slot ${_entries} no larger&quot; +\n        s&quot; than the last timestamp appended (${lastEntry.timestamp}) to ${file.getAbsolutePath}.&quot;)\n\n    if (timestamp &gt; lastEntry.timestamp) {\n      trace(s&quot;Adding index entry $timestamp =&gt; $offset to ${file.getAbsolutePath}.&quot;)\n      mmap.putLong(timestamp) // å‘mmapå†™å…¥æ—¶é—´æˆ³\n      mmap.putInt(relativeOffset(offset)) // å‘mmapå†™å…¥ç›¸å¯¹ä½ç§»å€¼\n      _entries += 1 // æ›´æ–°ç´¢å¼•é¡¹ä¸ªæ•°\n      _lastEntry = TimestampOffset(timestamp, offset) // æ›´æ–°å½“å‰æœ€æ–°çš„ç´¢å¼•é¡¹\n      require(_entries * entrySize == mmap.position(), s&quot;${_entries} entries but file position in index is ${mmap.position()}.&quot;)\n    }\n  }\n}\n</code></pre><p>å’ŒOffsetIndexç±»ä¼¼ï¼Œå‘TimeIndexå†™å…¥ç´¢å¼•é¡¹çš„ä¸»ä½“é€»è¾‘ï¼Œæ˜¯å‘mmapåˆ†åˆ«å†™å…¥æ—¶é—´æˆ³å’Œç›¸å¯¹ä½ç§»å€¼ã€‚åªä¸è¿‡ï¼Œ<strong>é™¤äº†æ ¡éªŒä½ç§»å€¼çš„å•è°ƒå¢åŠ æ€§ä¹‹å¤–ï¼ŒTimeIndexè¿˜ä¼šç¡®ä¿é¡ºåºå†™å…¥çš„æ—¶é—´æˆ³ä¹Ÿæ˜¯å•è°ƒå¢åŠ çš„</strong>ã€‚</p><p>è¯´åˆ°è¿™é‡Œï¼Œæˆ‘æƒ³åˆ°æˆ‘å½“å¹´è¯»åˆ°è¿™æ®µä»£ç æ—¶å€™çš„ä¸€ä¸ªæƒ³æ³•ã€‚é‚£ä¸ªæ—¶å€™ï¼Œè¿™æ®µä»£ç è¿˜æ²¡æœ‰åŠ ä¸Šæ—¶é—´æˆ³å•è°ƒå¢åŠ çš„æ ¡éªŒé€»è¾‘ï¼Œæˆ‘çµæœºä¸€åŠ¨ï¼ŒèŒå‘äº†å‘TimeIndexå†™å…¥ä¸€ä¸ªè¿‡æœŸæ—¶é—´æˆ³çš„æƒ³æ³•ã€‚ä¸€ç•ªåŠ¨æ‰‹æ“ä½œä¹‹åï¼Œæˆ‘çœŸçš„å‘TimeIndexç´¢å¼•æ–‡ä»¶ä¸­å†™å…¥äº†ä¸€ä¸ªè¿‡æœŸæ—¶é—´æˆ³å’Œä½ç§»ã€‚</p><p>ä½ çŒœç»“æœæ€æ ·ï¼Ÿç»“æœæ˜¯å¼•å‘äº†æ¶ˆè´¹è€…ç«¯ç¨‹åºçš„å½»åº•æ··ä¹±ã€‚è¿™æ˜¯å› ä¸ºï¼Œå½“æ¶ˆè´¹è€…ç«¯ç¨‹åºæ ¹æ®æ—¶é—´æˆ³ä¿¡æ¯å»è¿‡æ»¤å¾…è¯»å–çš„æ¶ˆæ¯æ—¶ï¼Œå®ƒè¯»åˆ°äº†è¿™ä¸ªè¿‡æœŸçš„æ—¶é—´æˆ³å¹¶æ‹¿åˆ°äº†é”™è¯¯çš„ä½ç§»å€¼ï¼Œå› æ­¤è¿”å›äº†é”™è¯¯çš„æ•°æ®ã€‚</p><p>ä¸ºæ­¤ï¼Œæˆ‘è¿˜ç»™ç¤¾åŒºæäº¤äº†ä¸€ä¸ªJiraï¼Œå½“æ—¶è¢«é©³å›äº†â€”â€”ç†ç”±æ˜¯ä¸å…è®¸å‘TimeIndexå†™å…¥è¿‡æœŸæ—¶é—´æˆ³ã€‚è·Ÿä½ è¯´è¿™ä¸ªè¶£äº‹å„¿åªæ˜¯æƒ³è¯´æ˜ï¼Œæœ‰çš„æ—¶å€™ï¼Œè¯»æºç ä¼šè¯±å‘å¾ˆå¤šçµæ„Ÿæˆ–å¥‡æ€å¦™æƒ³ï¼Œè€Œè¿™äº›ä¸œè¥¿æ˜¯ä½ åœ¨å¹³æ—¶ä½¿ç”¨è¿‡ç¨‹ä¸­ä¸ä¼šæƒ³åˆ°çš„ã€‚è¿™ä¹Ÿç®—æ˜¯é˜…è¯»æºç çš„ä¸€å¤§æ”¶è·å§ã€‚</p><h2>åŒºåˆ«</h2><p>è®²åˆ°è¿™é‡Œï¼Œè¿™èŠ‚è¯¾å°±æ¥è¿‘å°¾å£°äº†ã€‚æœ€åï¼Œæˆ‘ç”¨ä¸€å¼ è¡¨æ ¼æ±‡æ€»ä¸‹OffsetIndexå’ŒTimeIndexçš„ç‰¹ç‚¹å’ŒåŒºåˆ«ï¼Œå¸Œæœ›èƒ½å¤Ÿå¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£å’Œæ¶ˆåŒ–ä»Šå¤©çš„é‡ç‚¹å†…å®¹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/a3/78/a359ce4e81eb073a9ebed2979082b578.jpg?wh=3860*2007\" alt=\"\"></p><h2>æ€»ç»“</h2><p>ä»Šå¤©ï¼Œæˆ‘å¸¦ä½ è¯¦ç»†åˆ†æäº†OffsetIndexå’ŒTimeIndexï¼Œä»¥åŠå®ƒä»¬çš„ä¸åŒä¹‹å¤„ã€‚è™½ç„¶OffsetIndexå’ŒTimeIndexæ˜¯ä¸åŒç±»å‹çš„ç´¢å¼•ï¼Œä½†Kafkaå†…éƒ¨æ˜¯æŠŠäºŒè€…ç»“åˆä½¿ç”¨çš„ã€‚é€šå¸¸çš„æµç¨‹æ˜¯ï¼Œå…ˆä½¿ç”¨TimeIndexå¯»æ‰¾æ»¡è¶³æ—¶é—´æˆ³è¦æ±‚çš„æ¶ˆæ¯ä½ç§»å€¼ï¼Œç„¶åå†åˆ©ç”¨OffsetIndexå»å®šä½è¯¥ä½ç§»å€¼æ‰€åœ¨çš„ç‰©ç†æ–‡ä»¶ä½ç½®ã€‚å› æ­¤ï¼Œå®ƒä»¬å…¶å®æ˜¯åˆä½œçš„å…³ç³»ã€‚</p><p>æœ€åï¼Œæˆ‘è¿˜æƒ³æé†’ä½ ä¸€ç‚¹ï¼š<strong>ä¸è¦å¯¹ç´¢å¼•æ–‡ä»¶åšä»»ä½•ä¿®æ”¹ï¼</strong>æˆ‘ç¢°åˆ°è¿‡å› ç”¨æˆ·æ“…è‡ªé‡å‘½åç´¢å¼•æ–‡ä»¶ï¼Œä»è€Œå¯¼è‡´Brokerå´©æºƒæ— æ³•å¯åŠ¨çš„åœºæ™¯ã€‚å¦å¤–ï¼Œè™½ç„¶Kafkaèƒ½å¤Ÿé‡å»ºç´¢å¼•ï¼Œä½†æ˜¯éšæ„åœ°åˆ é™¤ç´¢å¼•æ–‡ä»¶ä¾ç„¶æ˜¯ä¸€ä¸ªå¾ˆå±é™©çš„æ“ä½œã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæˆ‘å»ºè®®ä½ å°½é‡ä¸è¦æ‰§è¡Œè¿™æ ·çš„æ“ä½œã€‚</p><h2>è¯¾åè®¨è®º</h2><p>OffsetIndexä¸­çš„lookupæ–¹æ³•å®ç°äº†ç±»ä¼¼äºFLOORå‡½æ•°çš„ä½ç§»æŸ¥æ‰¾é€»è¾‘ã€‚ä½ èƒ½å¦å¯¹åº”å†™ä¸€ä¸ªç±»ä¼¼äºCEILINGå‡½æ•°çš„ä½ç§»æŸ¥æ‰¾é€»è¾‘ï¼Œå³è¿”å›ä¸å°äºç»™å®šä½ç§»å€¼targetOffsetçš„æœ€å°ä½ç§»å€¼å’Œå¯¹åº”çš„ç‰©ç†æ–‡ä»¶ä½ç½®ï¼Ÿ</p><p>æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºç•…æ‰€æ¬²è¨€ï¼Œè·Ÿæˆ‘äº¤æµè®¨è®ºï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹ã€‚</p>","neighbors":{"left":{"article_title":"04 | ç´¢å¼•ï¼ˆä¸Šï¼‰ï¼šæ”¹è¿›çš„äºŒåˆ†æŸ¥æ‰¾ç®—æ³•åœ¨Kafkaç´¢å¼•çš„åº”ç”¨","id":226169},"right":{"article_title":"06 | è¯·æ±‚é€šé“ï¼šå¦‚ä½•å®ç°Kafkaè¯·æ±‚é˜Ÿåˆ—ï¼Ÿ","id":230352}},"comments":[{"had_liked":false,"id":209778,"user_name":"èƒ¡å¤•","can_delete":false,"product_type":"c1","uid":1288090,"ip_address":"","ucode":"5709A689B6683B","user_header":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","comment_is_top":true,"comment_ctime":1587612733,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"9.2233720599171994e+18","product_id":100050101,"comment_content":"ä½ å¥½ï¼Œæˆ‘æ˜¯èƒ¡å¤•ã€‚æˆ‘æ¥å…¬å¸ƒä¸ŠèŠ‚è¯¾çš„â€œè¯¾åè®¨è®ºâ€é¢˜ç­”æ¡ˆå•¦ï½<br><br>ä¸ŠèŠ‚è¯¾ï¼Œå’±ä»¬é‡ç‚¹äº†è§£äº†Kafkaç´¢å¼•å¯¹è±¡ä»¥åŠæ”¹è¿›ç‰ˆçš„äºŒåˆ†æŸ¥æ‰¾ç®—æ³•ï¼Œè¯¾åæˆ‘è®©ä½ æ€è€ƒä¸‹æ”¹è¿›ç‰ˆäºŒåˆ†æŸ¥æ‰¾ç®—æ³•ä¸­å†·åŒºå’Œçƒ­åŒºçš„åˆ†å‰²çº¿è®¾å®šåœ¨8192å­—èŠ‚å¤„çš„åŸç†ã€‚é‰´äºè¿™æ˜¯ä¸€ä¸ªå¼€æ”¾å¼çš„é—®é¢˜ï¼Œæˆ‘è¯´ä¸‹æˆ‘çš„ç†è§£ï¼šå°±åƒæºç æ³¨é‡Šé‡Œé¢å†™çš„é‚£æ ·ï¼Œ8192è¿™ä¸ªæ•°å­—ä¸å¤§ä¸å°æ­£åˆé€‚ã€‚æ‰€è°“ä¸å¤§ä¸å°æ˜¯æŒ‡å®ƒå¹¶ä¸æ˜¯å¤ªå°ï¼Œå®ƒè¶³ä»¥ç¡®ä¿å¤§å¤šæ•°laggingå¾ˆå°çš„followeræˆ–consumeréƒ½åªåœ¨çƒ­åŒºæŸ¥è¯¢ï¼›åŒæ—¶å®ƒä¹Ÿä¸ä¼šå¤ªå¤§ï¼Œå¯¹äºä¸»æµ4KBå¤§å°çš„page sizeè€Œè¨€ï¼Œ çƒ­åŒºå¤§çº¦ä¹Ÿå°±åªå ç”¨2~3ä¸ªé¡µé¢ã€‚<br><br>okayï¼Œä½ æ˜¯æ€ä¹ˆè€ƒè™‘çš„å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥ä¸€èµ·è®¨è®ºä¸‹ã€‚","like_count":5},{"had_liked":false,"id":221359,"user_name":"ä¸œé£ç¬¬ä¸€æ","can_delete":false,"product_type":"c1","uid":1402697,"ip_address":"","ucode":"0CD0F62E90DAD8","user_header":"https://static001.geekbang.org/account/avatar/00/15/67/49/864dba17.jpg","comment_is_top":false,"comment_ctime":1590481259,"is_pvip":false,"replies":[{"id":"81707","content":"å—¯å—¯ï¼Œå¯ä»¥å°è¯•å†™ä¸ªtest caseï¼Œæµ‹è¯•ä¸‹è‡ªå·±çš„æ–¹æ³•ï¼šï¼‰","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1590547095,"ip_address":"","comment_id":221359,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5885448555","product_id":100050101,"comment_content":"è¯¾åä½œä¸šï¼š<br>  def lookup(targetOffset: Long): OffsetPosition = {<br>    maybeLock(lock) {<br>      val idx = mmap.duplicate<br>      val slot = smallestUpperBoundSlotFor(idx, targetOffset, IndexSearchType.KEY)<br>      if(slot == -1)<br>        OffsetPosition(baseOffset, 0)<br>      else<br>        parseEntry(idx, slot)<br>    }<br>  }<br>&#47;&#47;è‡ªå·±é‡å†™äº†ä¸€ä¸‹äºŒåˆ†æŸ¥æ‰¾ï¼Œå‘ç°æœ‰ç°æˆçš„æ–¹æ³•ï¼ŒğŸ˜†","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":496437,"discussion_content":"å—¯å—¯ï¼Œå¯ä»¥å°è¯•å†™ä¸ªtest caseï¼Œæµ‹è¯•ä¸‹è‡ªå·±çš„æ–¹æ³•ï¼šï¼‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590547095,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":215073,"user_name":"Alpha ğŸ‘€","can_delete":false,"product_type":"c1","uid":1200971,"ip_address":"","ucode":"3C0BAD36550718","user_header":"https://static001.geekbang.org/account/avatar/00/12/53/4b/28991f30.jpg","comment_is_top":false,"comment_ctime":1588900489,"is_pvip":false,"replies":[{"id":"79687","content":"é’ˆå¯¹æ¶ˆè´¹è€…ç»„ï¼Œæˆ–è€…è¯´é’ˆå¯¹æ¯ä¸ªgroup idã€‚ä¿å­˜çš„æ˜¯&lt;groupId, topicPartition, offset&gt;ä¸‰å…ƒç»„ã€‚æ–°å¢æ¶ˆè´¹è€…æ‹¿åˆ°è¦æ¶ˆè´¹çš„åˆ†åŒºåï¼Œå»æŸ¥çœ‹æœ‰æ— å¯¹åº”çš„ä¸‰å…ƒç»„è®°å½•ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™æ ¹æ®consumerç«¯å‚æ•°auto.offset.resetå€¼æ¥å†³å®šä»å“ªé‡Œå¼€å§‹æ¶ˆè´¹","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1588984081,"ip_address":"","comment_id":215073,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5883867785","product_id":100050101,"comment_content":"è€å¸ˆæ‚¨å¥½ï¼Œè¯·é—®ä¸€ä¸ªé—®é¢˜ï¼Œkafkaè®°å½•æ¶ˆè´¹è€…çš„æ¶ˆè´¹offsetæ˜¯å¯¹æ¶ˆè´¹è€…ç»„ï¼Œè¿˜æ˜¯å¯¹å•ä¸ªæ¶ˆè´¹è€…ï¼Ÿæ¯”å¦‚ä¸€ä¸ªæ¶ˆè´¹è€…ç»„ä¸­æ–°åŠ å…¥ä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œåˆ†åŒºé‡æ–°åˆ†é…ï¼Œé‚£æ–°åŠ å…¥çš„æ¶ˆè´¹è€…æ˜¯ä»å“ªé‡Œå¼€å§‹æ¶ˆè´¹ï¼Ÿ","like_count":2,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":494303,"discussion_content":"é’ˆå¯¹æ¶ˆè´¹è€…ç»„ï¼Œæˆ–è€…è¯´é’ˆå¯¹æ¯ä¸ªgroup idã€‚ä¿å­˜çš„æ˜¯&amp;lt;groupId, topicPartition, offset&amp;gt;ä¸‰å…ƒç»„ã€‚æ–°å¢æ¶ˆè´¹è€…æ‹¿åˆ°è¦æ¶ˆè´¹çš„åˆ†åŒºåï¼Œå»æŸ¥çœ‹æœ‰æ— å¯¹åº”çš„ä¸‰å…ƒç»„è®°å½•ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™æ ¹æ®consumerç«¯å‚æ•°auto.offset.resetå€¼æ¥å†³å®šä»å“ªé‡Œå¼€å§‹æ¶ˆè´¹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588984081,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1200971,"avatar":"https://static001.geekbang.org/account/avatar/00/12/53/4b/28991f30.jpg","nickname":"Alpha ğŸ‘€","note":"","ucode":"3C0BAD36550718","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":265912,"discussion_content":"è°¢è°¢è€å¸ˆæŒ‡ç‚¹ï¼ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589454580,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":210781,"user_name":"thomas","can_delete":false,"product_type":"c1","uid":1016777,"ip_address":"","ucode":"9AB945308F1B50","user_header":"https://static001.geekbang.org/account/avatar/00/0f/83/c9/5d03981a.jpg","comment_is_top":false,"comment_ctime":1587824683,"is_pvip":true,"replies":[{"id":"78474","content":"é‡Œé¢ä¸ºç©ºï¼Œåªæ˜¯é¢„åˆ†é…äº†10MBçš„ç©ºé—´","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1587868288,"ip_address":"","comment_id":210781,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5882791979","product_id":100050101,"comment_content":"è€å¸ˆï¼Œè¯·é—®å»ºç«‹åˆ†åŒºåˆå§‹åŒ–çš„æ—¶å€™ï¼Œlog-segmentçš„ä½ç§»ç´¢å¼•å’Œæ—¶é—´ç´¢å¼•æ–‡ä»¶å°†è¿‘æœ‰10Mçš„æ•°æ®ï¼Ÿ<br>---------------------------------------------------------------------------------------ã€‹<br>-rw-r--r--  1 root root 10485760 Apr 25 14:23 00000000000000000000.index<br>-rw-r--r--  1 root root        0 Apr 25 14:23 00000000000000000000.log<br>-rw-r--r--  1 root root 10485756 Apr 25 14:23 00000000000000000000.timeindex<br><br>","like_count":2,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493107,"discussion_content":"é‡Œé¢ä¸ºç©ºï¼Œåªæ˜¯é¢„åˆ†é…äº†10MBçš„ç©ºé—´","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587868288,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1181505,"avatar":"https://static001.geekbang.org/account/avatar/00/12/07/41/2d477385.jpg","nickname":"æŸ æª¬C","note":"","ucode":"BC0EE704D952A4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":304145,"discussion_content":"MappedByteBufferä¼šç›´æ¥å ç”¨è®¾å®šçš„ç©ºé—´å¤§å°","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599479537,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":292627,"user_name":"QAQ","can_delete":false,"product_type":"c1","uid":2307937,"ip_address":"","ucode":"6E47215CBB81F5","user_header":"https://static001.geekbang.org/account/avatar/00/23/37/61/51e10a30.jpg","comment_is_top":false,"comment_ctime":1620901019,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1620901019","product_id":100050101,"comment_content":"è¿™äº›æ¶‰åŠåˆ°+1ï¼Œ-1çš„å„ç§offsetï¼Œpositionè®¡ç®—æ“ä½œï¼Œèƒ½å¦è¡¥å……æ›´å¤šçš„å›¾ç‰‡åŠ ä»¥è¯´æ˜ï¼Œä¾‹å¦‚åœ¨æ·»åŠ å¤šæ¡è®°å½•æ—¶ï¼Œlogæ–‡ä»¶åˆ°åº•æ€ä¹ˆå˜çš„ï¼Œindexæ–‡ä»¶åˆ°åº•æ€ä¹ˆå˜çš„ç­‰ç­‰","like_count":0},{"had_liked":false,"id":286233,"user_name":"å¿«è·‘","can_delete":false,"product_type":"c1","uid":1564645,"ip_address":"","ucode":"90ED7E6D40C58E","user_header":"https://static001.geekbang.org/account/avatar/00/17/df/e5/65e37812.jpg","comment_is_top":false,"comment_ctime":1617203157,"is_pvip":false,"replies":[{"id":"104164","content":"å¦‚æœä½ è¦æ ¹æ®æ—¶é—´æˆ³æŸ¥è¯¢æ¶ˆæ¯ï¼ŒTimeIndexå°±ç”¨ä¸Šäº†","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1617671573,"ip_address":"","comment_id":286233,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1617203157","product_id":100050101,"comment_content":"ä»æ¶ˆè´¹è€…çš„è§’åº¦ï¼Œå¦‚æœæ²¡æœ‰&lt;groupId, topicPartition, offset&gt;åˆ™ä»auto.offset.resetçš„offsetå¼€å§‹è¯»æ•°æ®ï¼Œè¿™äº›æ­¥éª¤éƒ½èƒ½ç›´æ¥æŸ¥åˆ°offsetå§ï¼Œé‚£TimeIndexæ˜¯åœ¨ä»€ä¹ˆåœºæ™¯æ´¾ä¸Šç”¨åœºï¼Œå‘æŒ¥ä½œç”¨çš„?","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":517917,"discussion_content":"å¦‚æœä½ è¦æ ¹æ®æ—¶é—´æˆ³æŸ¥è¯¢æ¶ˆæ¯ï¼ŒTimeIndexå°±ç”¨ä¸Šäº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617671573,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1564645,"avatar":"https://static001.geekbang.org/account/avatar/00/17/df/e5/65e37812.jpg","nickname":"å¿«è·‘","note":"","ucode":"90ED7E6D40C58E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":365332,"discussion_content":"è€å¸ˆä½ å¥½ã€‚æ ¹æ®æ—¶é—´æˆ³æŸ¥è¯¢æ¶ˆæ¯ï¼Œåœ¨ä»€ä¹ˆåœºæ™¯ä¼šå‘ç”Ÿï¼Ÿ\nå‘½ä»¤è¡Œæ ¹æ®æ—¶é—´é‡ç½®offsetç®—ä¹ˆã€‚è¿˜æœ‰å…¶ä»–ä»€ä¹ˆåœºæ™¯æ˜¯å±äºç”¨TimeIndexï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617773942,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":246065,"user_name":"z.l","can_delete":false,"product_type":"c1","uid":1181055,"ip_address":"","ucode":"805CC5784D3F76","user_header":"https://static001.geekbang.org/account/avatar/00/12/05/7f/d35ab9a1.jpg","comment_is_top":false,"comment_ctime":1599149086,"is_pvip":false,"replies":[{"id":"90471","content":"å¥½åƒä¸å¤ªä¸¥è°¨ã€‚å¦‚æœå‡ºç°ç­‰äºçš„æƒ…å†µå‘¢ï¼Ÿ","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1599205450,"ip_address":"","comment_id":246065,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1599149086","product_id":100050101,"comment_content":"æ€è€ƒé¢˜ï¼Œç›´æ¥æŠŠlookupæ–¹æ³•çš„æœ€åä¸€è¡Œæ”¹æˆ parseEntry(idx, slot+1)ï¼Œå¯ä»¥å—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":505049,"discussion_content":"å¥½åƒä¸å¤ªä¸¥è°¨ã€‚å¦‚æœå‡ºç°ç­‰äºçš„æƒ…å†µå‘¢ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599205450,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":244675,"user_name":"å¯¹ä¸é”™","can_delete":false,"product_type":"c1","uid":1682027,"ip_address":"","ucode":"EF55733E3BD78B","user_header":"https://static001.geekbang.org/account/avatar/00/19/aa/6b/ab9a072a.jpg","comment_is_top":false,"comment_ctime":1598610218,"is_pvip":false,"replies":[{"id":"90147","content":"é€»è¾‘æ˜¯ç»Ÿä¸€çš„ï¼Œéƒ½æ˜¯å†™å…¥æœ€å¤§çš„æ—¶é—´æˆ³ä»¥åŠå¯¹åº”çš„ä½ç§»","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1598836144,"ip_address":"","comment_id":244675,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1598610218","product_id":100050101,"comment_content":"æœ‰ä¸ªç–‘é—®:åœ¨leaderå†™å…¥æ¶ˆæ¯çš„æ—¶å€™,æ—¶é—´æˆ³ç´¢å¼•é¡¹é‡Œé¢æ˜¯<br>&lt;æ¶ˆæ¯é›†åˆçš„æœ€åä¸€æ¡æ¶ˆæ¯çš„æ—¶é—´æˆ³ï¼Œå½“å‰LEOçš„å€¼&gt;,<br>åœ¨flowwerå†™å…¥æ¶ˆæ¯çš„æ—¶å€™,æ—¶é—´æˆ³ç´¢å¼•é¡¹é‡Œé¢æ˜¯<br>&lt;æ¶ˆæ¯é›†åˆçš„æœ€åä¸€æ¡æ¶ˆæ¯çš„æ—¶é—´æˆ³ï¼Œæ¶ˆæ¯é›†åˆçš„æœ€åä¸€æ¡æ¶ˆæ¯çš„æ—¶é—´æˆ³æ‰€å¯¹åº”çš„ä½ç§»å€¼&gt;,ä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡?","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":504660,"discussion_content":"é€»è¾‘æ˜¯ç»Ÿä¸€çš„ï¼Œéƒ½æ˜¯å†™å…¥æœ€å¤§çš„æ—¶é—´æˆ³ä»¥åŠå¯¹åº”çš„ä½ç§»","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598836144,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":225322,"user_name":"sljoai","can_delete":false,"product_type":"c1","uid":1018071,"ip_address":"","ucode":"FF88C4BA265DE0","user_header":"https://static001.geekbang.org/account/avatar/00/0f/88/d7/07f8bc6c.jpg","comment_is_top":false,"comment_ctime":1591714725,"is_pvip":false,"replies":[{"id":"83193","content":"1. å—¯ï¼Œå·®ä¸å¤šæ˜¯è¿™ä¹ˆè®¡ç®—çš„<br>2. é€»è¾‘å˜å¾—æ›´åŠ ç®€å•äº†ã€‚æ¯ä¸€ä¸ªç´¢å¼•é¡¹éƒ½æ˜¯&lt;offset, position&gt;å¯¹ï¼Œé‚£ä¹ˆç¬¬né¡¹çš„ç›¸å¯¹ä½ç§»è‡ªç„¶å°±æ˜¯bufferçš„n*entrySizeå­—èŠ‚å¤„å¼€å§‹çš„4ä¸ªå­—èŠ‚è¡¨ç¤ºçš„æ•´æ•°å€¼","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1591871612,"ip_address":"","comment_id":225322,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1591714725","product_id":100050101,"comment_content":"èƒ¡è€å¸ˆï¼Œè¯·æ•™å‡ ä¸ªé—®é¢˜ï¼š<br>1.&quot;å‡è®¾ä¸€ä¸ªç´¢å¼•æ–‡ä»¶ä¿å­˜äº† 1000 ä¸ªç´¢å¼•é¡¹ï¼Œä½¿ç”¨ç›¸å¯¹ä½ç§»å€¼å°±èƒ½èŠ‚çœå¤§çº¦ 4MB çš„ç©ºé—´ï¼Œè¿™æ˜¯ä¸æ˜¯ä¸€ä»¶å¾ˆåˆ’ç®—çš„äº‹æƒ…å‘¢ï¼Ÿ!&quot;. è¯·é—®å…·ä½“æ˜¯æ€ä¹ˆè®¡ç®—çš„å‘¢ï¼Ÿ4å­—èŠ‚ * 1000 ï¼Ÿ<br>2.relativeOffsetæ–¹æ³•å·²ç»å˜äº†ï¼Œæˆ‘çœ‹åˆ°çš„æ˜¯å¦‚ä¸‹ï¼š<br>   private def relativeOffset(buffer: ByteBuffer, n: Int): Int = buffer.getInt(n * entrySize)<br> è·Ÿæœ¬æ–‡ä¸­ä»‹ç»çš„æœ‰æ‰€ä¸åŒï¼Œè¯¥æ€ä¹ˆç†è§£å‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":497806,"discussion_content":"1. å—¯ï¼Œå·®ä¸å¤šæ˜¯è¿™ä¹ˆè®¡ç®—çš„\n2. é€»è¾‘å˜å¾—æ›´åŠ ç®€å•äº†ã€‚æ¯ä¸€ä¸ªç´¢å¼•é¡¹éƒ½æ˜¯&amp;lt;offset, position&amp;gt;å¯¹ï¼Œé‚£ä¹ˆç¬¬né¡¹çš„ç›¸å¯¹ä½ç§»è‡ªç„¶å°±æ˜¯bufferçš„n*entrySizeå­—èŠ‚å¤„å¼€å§‹çš„4ä¸ªå­—èŠ‚è¡¨ç¤ºçš„æ•´æ•°å€¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591871612,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1521451,"avatar":"https://static001.geekbang.org/account/avatar/00/17/37/2b/b32f1d66.jpg","nickname":"Ball","note":"","ucode":"1EE949E68D84CA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":298357,"discussion_content":"ç¬¬ä¸€ä¸ªé—®é¢˜æˆ‘ä¹Ÿè§‰å¾—è®¡ç®—å€¼ä¸å¯¹ï¼Œç›¸å¯¹ä½ç§»å€¼æ¯”ç»å¯¹ä½ç§»å€¼èŠ‚çœ4B çš„å­˜å‚¨ç©ºé—´ï¼Œ1000 ä¸ªç´¢å¼•é¡¹åŠ èµ·æ¥æ€ä¹ˆç®—ä¹Ÿæ˜¯ 4KB å·¦å³æ‰å¯¹ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1597278958,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":215370,"user_name":"RonnieXie","can_delete":false,"product_type":"c1","uid":1395676,"ip_address":"","ucode":"2B5CB6283B1D94","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIZcwnxGkjzENwyeEd3RZsh9tpZDeYmnT51iciaMiaLV2XRfzrJolZvUWjf3L5DuE3BmBg7uCKg3iaSzQ/132","comment_is_top":false,"comment_ctime":1588983177,"is_pvip":false,"replies":[{"id":"79805","content":"ä½ è¯´çš„æ²¡é”™ã€‚ä¸è¿‡ä¸€èˆ¬æƒ…å†µä¸‹æ¶ˆè´¹è€…å¹¶ä¸æ˜¯ç›´æ¥èƒ½å¤Ÿå®šä½ç›®æ ‡offsetï¼Œç›¸ååœ°å®ƒæ˜¯é€šè¿‡æ—¶é—´æˆ³å…ˆæ‰¾åˆ°ç›®æ ‡offsetçš„","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1589036126,"ip_address":"","comment_id":215370,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1588983177","product_id":100050101,"comment_content":"è€å¸ˆï¼Œæˆ‘è¿™è¾¹å¯¹OffsetIndex å’Œ TimeIndexäºŒè€…ç»“åˆä½¿ç”¨çš„ç†è§£æœ‰äº›æ¨¡ç³Šï¼›<br>ä¸ºä»€ä¹ˆéœ€è¦ä¸€èµ·ä½¿ç”¨ï¼Œæ¶ˆè´¹è€…ä¸æ˜¯æ ¹æ®Offsetæ‰¾åˆ°å¯¹äºä½ç½®å€¼å¼€å§‹æ¶ˆè´¹å°±å¥½å—ï¼Ÿè€Œä¸”ç»“åˆä½¿ç”¨æ€§èƒ½ä¹Ÿåº”è¯¥é™ä½å§ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":494406,"discussion_content":"ä½ è¯´çš„æ²¡é”™ã€‚ä¸è¿‡ä¸€èˆ¬æƒ…å†µä¸‹æ¶ˆè´¹è€…å¹¶ä¸æ˜¯ç›´æ¥èƒ½å¤Ÿå®šä½ç›®æ ‡offsetï¼Œç›¸ååœ°å®ƒæ˜¯é€šè¿‡æ—¶é—´æˆ³å…ˆæ‰¾åˆ°ç›®æ ‡offsetçš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589036126,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":210249,"user_name":"delete is create","can_delete":false,"product_type":"c1","uid":1147979,"ip_address":"","ucode":"A8C751219A7746","user_header":"https://static001.geekbang.org/account/avatar/00/11/84/4b/e4738ba8.jpg","comment_is_top":false,"comment_ctime":1587706123,"is_pvip":true,"replies":[{"id":"78366","content":"åªèƒ½è‡ªå·±å†™ç¨‹åºå®ç°äº†ï¼ŒKafkaæ²¡æœ‰æä¾›è¿™æ–¹é¢çš„æœºåˆ¶:(","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1587712216,"ip_address":"","comment_id":210249,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1587706123","product_id":100050101,"comment_content":"è€å¸ˆ å¦‚æœç”¨kafkaå®ç°å»¶è¿Ÿæ¶ˆæ¯æœ‰æ²¡æœ‰ä»€ä¹ˆå¥½çš„å®è·µ    rocketmqè¿™å—åŸç”Ÿå°±æ”¯æŒ    æƒ³äº†è§£ä¸‹kafkaæ€ä¹ˆåš","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492981,"discussion_content":"åªèƒ½è‡ªå·±å†™ç¨‹åºå®ç°äº†ï¼ŒKafkaæ²¡æœ‰æä¾›è¿™æ–¹é¢çš„æœºåˆ¶:(","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587712216,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":210189,"user_name":"Jonah","can_delete":false,"product_type":"c1","uid":1079507,"ip_address":"","ucode":"2C4799BD2FF0DE","user_header":"https://static001.geekbang.org/account/avatar/00/10/78/d3/1dc40aa2.jpg","comment_is_top":false,"comment_ctime":1587695606,"is_pvip":true,"replies":[{"id":"78340","content":"fetchUpperBoundOffsetæ‰¾çš„æ˜¯å¤§äºç»™å®šç‰©ç†æ–‡ä»¶ä½ç½®çš„æœ€å°ä½ç½®ã€‚smallestUpperBoundSlotForè¿”å›-1è¯´æ˜å½“å‰ç´¢å¼•æ–‡ä»¶ä¸­ç´¢å¼•é¡¹ä¿å­˜çš„ç‰©ç†æ–‡ä»¶ä½ç½®å…¨éƒ½æ¯”targetå°ã€‚æ­¤æ—¶ï¼ŒKafkaä»£ç å°±è¦å°†ä¸‹ä¸€ä¸ªæ—¥å¿—æ®µï¼ˆå¦‚æœå­˜åœ¨çš„è¯ï¼‰å¯¹è±¡çš„èµ·å§‹ä½ç§»å€¼ä½œä¸ºè¦å¯»æ‰¾çš„ä½ç§»å€¼ï¼Œè¿™ä¹Ÿæ˜¯Log.addAbortedTransactionsæ–¹æ³•ä¸­upperBoundOffsetçš„ç¡®è®¤é€»è¾‘ã€‚ä½†æ— è®ºå¦‚ä½•ï¼ŒfetchUpperBoundOffsetä½œä¸ºå•ä¸ªå‡½æ•°è€Œè¨€ï¼Œå®ƒä¸åº”è¯¥æ‰¿è½½è¿™ä¹ˆå¤šé€»è¾‘ï¼Œå¦‚æœæ²¡æ‰¾åˆ°ç›´æ¥è¿”å›Noneæ˜¯æœ€åˆç†çš„åšæ³•ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1587697165,"ip_address":"","comment_id":210189,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1587695606","product_id":100050101,"comment_content":"æˆ‘è‡ªå·±å®ç°äº†ä¸ªceilingï¼Œå‘ç°æºç ä¸­å…¶å®æœ‰fetchUpperBoundOffsetï¼Œæˆ‘å’Œä»–çš„æ€è·¯å°±ä¸€ä¸ªå·®å¼‚ï¼Œå°±æ˜¯å½“smallestUpperBoundSlotForè¿”å›-1çš„æ—¶å€™ï¼Œä¸ºå•¥è¦è¿”å›Noneï¼Œè€Œä¸æ˜¯ä¸‹ä¸€ä¸ªæ’å…¥ä½ç½®ï¼Ÿ<br>def fetchUpperBoundOffset(fetchOffset: OffsetPosition, fetchSize: Int): Option[OffsetPosition] = {<br>    maybeLock(lock) {<br>      val idx = mmap.duplicate<br>      val slot = smallestUpperBoundSlotFor(idx, fetchOffset.position + fetchSize, IndexSearchType.VALUE)<br>      if (slot == -1)<br>        &#47;&#47; ä¸ºä»€ä¹ˆä¸èƒ½æ˜¯OffsetPosition(lastOffset, mmap.position())<br>        None<br>      else<br>        Some(parseEntry(idx, slot))<br>    }<br>  }<br>","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492964,"discussion_content":"fetchUpperBoundOffsetæ‰¾çš„æ˜¯å¤§äºç»™å®šç‰©ç†æ–‡ä»¶ä½ç½®çš„æœ€å°ä½ç½®ã€‚smallestUpperBoundSlotForè¿”å›-1è¯´æ˜å½“å‰ç´¢å¼•æ–‡ä»¶ä¸­ç´¢å¼•é¡¹ä¿å­˜çš„ç‰©ç†æ–‡ä»¶ä½ç½®å…¨éƒ½æ¯”targetå°ã€‚æ­¤æ—¶ï¼ŒKafkaä»£ç å°±è¦å°†ä¸‹ä¸€ä¸ªæ—¥å¿—æ®µï¼ˆå¦‚æœå­˜åœ¨çš„è¯ï¼‰å¯¹è±¡çš„èµ·å§‹ä½ç§»å€¼ä½œä¸ºè¦å¯»æ‰¾çš„ä½ç§»å€¼ï¼Œè¿™ä¹Ÿæ˜¯Log.addAbortedTransactionsæ–¹æ³•ä¸­upperBoundOffsetçš„ç¡®è®¤é€»è¾‘ã€‚ä½†æ— è®ºå¦‚ä½•ï¼ŒfetchUpperBoundOffsetä½œä¸ºå•ä¸ªå‡½æ•°è€Œè¨€ï¼Œå®ƒä¸åº”è¯¥æ‰¿è½½è¿™ä¹ˆå¤šé€»è¾‘ï¼Œå¦‚æœæ²¡æ‰¾åˆ°ç›´æ¥è¿”å›Noneæ˜¯æœ€åˆç†çš„åšæ³•ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587697165,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}