{"id":806946,"title":"12ï½œè¡¨å¤ªå¤§äº†ï¼Œä¿®æ”¹è¡¨ç»“æ„å¤ªæ…¢æ€ä¹ˆè§£å†³ï¼Ÿï¼ˆä¸‹ï¼‰","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯ä¿Šè¾¾ã€‚</p><p>åœ¨ä¸Šä¸€è®²ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†å‡ ç§æ‰§è¡Œå¾ˆå¿«çš„DDLæ“ä½œï¼Œè¿™äº›DDLæ“ä½œåªéœ€è¦ä¿®æ”¹å…ƒæ•°æ®ï¼Œå› æ­¤å³ä½¿è¡¨å¾ˆå¤§ï¼Œä¹Ÿä¸å½±å“æ‰§è¡Œé€Ÿåº¦ã€‚ä½†æ˜¯è¿˜æœ‰å¾ˆå¤šDDLæ“ä½œï¼Œåœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­éœ€è¦è¯»å–å…¨è¡¨çš„æ•°æ®ï¼Œæˆ–è€…æ˜¯é‡å»ºæ•´ä¸ªè¡¨ï¼Œå› æ­¤è¡¨çš„å¤§å°ä¼šç›´æ¥å½±å“æ‰§è¡Œçš„é€Ÿåº¦ã€‚è¿™ä¸€è®²ä¸­ï¼Œæˆ‘ä»¬å°±æ¥çœ‹çœ‹è¿™äº›DDLçš„æ‰§è¡Œç­–ç•¥ã€‚</p><h2>InnoDBåœ¨çº¿DDL</h2><p>æ·»åŠ å­—æ®µã€åˆ é™¤å­—æ®µå¯ä»¥ä½¿ç”¨Instant DDLï¼Œä½†æ˜¯è¿˜æœ‰å…¶ä»–å¾ˆå¤šDDLå¹¶ä¸èƒ½ä»…ä»…ä¿®æ”¹å…ƒæ•°æ®ã€‚æ¯”å¦‚åˆ›å»ºç´¢å¼•æ—¶ï¼Œéœ€è¦è¯»å–å…¨è¡¨çš„æ•°æ®ï¼Œå¯¹ç´¢å¼•å­—æ®µè¿›è¡Œæ’åºï¼Œç”Ÿæˆæ–°çš„ç´¢å¼•ã€‚ä¼˜åŒ–è¡¨ï¼ˆoptimize tableï¼‰æ—¶ï¼Œéœ€è¦é‡å»ºæ•´ä¸ªè¡¨çš„æ•°æ®ã€‚MySQLä»5.6å¼€å§‹æ”¯æŒåœ¨çº¿DDLã€‚åœ¨çº¿DDLçš„ä¸»è¦å«ä¹‰ï¼Œæ˜¯æŒ‡åœ¨DDLæ‰§è¡Œçš„æœŸé—´ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥æ­£å¸¸åœ°è¯»å†™è¡¨ä¸­çš„æ•°æ®ã€‚å¯¹äºåªéœ€è¦ä¿®æ”¹å…ƒæ•°æ®çš„DDLï¼Œå‰é¢å·²ç»åšäº†æ¯”è¾ƒå¤šçš„ä»‹ç»äº†ï¼Œè¿™é‡Œæˆ‘ä»¬åªè®¨è®ºåˆ›å»ºç´¢å¼•å’Œéœ€è¦é‡å»ºè¡¨çš„åœ¨çº¿DDLã€‚</p><h3>åˆ›å»ºäºŒçº§ç´¢å¼•</h3><p>åˆ›å»ºäºŒçº§ç´¢å¼•å¯ä»¥ä½¿ç”¨INPLACEçš„æ–¹å¼æ‰§è¡Œã€‚è¿™é‡Œåªè®¨è®ºæ™®é€šçš„B+æ ‘ç´¢å¼•ï¼Œä¸è®¨è®ºå…¨æ–‡ç´¢å¼•ã€ç©ºé—´ç´¢å¼•ã€‚ä¸‹é¢çš„è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ALTER TABLEå‘½ä»¤æ–°å»ºäº†ä¸€ä¸ªç´¢å¼•ã€‚</p><pre><code class=\"language-go\">mysql&gt; alter table employees \n    add key idx_firstname_lastname(first_name, last_name), \n    algorithm=inplace, \n    lock=none;\n\nQuery OK, 0 rows affected (0.73 sec)\nRecords: 0  Duplicates: 0  Warnings: 0\n</code></pre><!-- [[[read_end]]] --><p>åˆ›å»ºäºŒçº§ç´¢å¼•ä¸»è¦åˆ†ä¸ºå‡ ä¸ªæ­¥éª¤ã€‚</p><p><strong>1.  æ‰«ææ•´ä¸ªè¡¨ï¼Œè¯»å–æ–°å»ºç´¢å¼•éœ€è¦çš„å­—æ®µã€‚</strong></p><p>InnoDBå¯ä»¥ä½¿ç”¨å¤šä¸ªçº¿ç¨‹å¹¶å‘è¯»å–èšç°‡ç´¢å¼•ï¼Œå‚æ•°innodb_parallel_read_threadsç”¨æ¥è®¾ç½®å¹¶å‘è¯»å–çš„çº¿ç¨‹æ•°ï¼Œé»˜è®¤å€¼æ˜¯4ã€‚å¦‚æœè¡¨æ¯”è¾ƒå¤§ï¼ŒæœåŠ¡å™¨çš„é…ç½®æ¯”è¾ƒå¥½ï¼Œå¯ä»¥å°†è¿™ä¸ªå‚æ•°è®¾ç½®å¾—å¤§ä¸€äº›ï¼Œæ¥æå‡è¯»å–çš„é€Ÿåº¦ã€‚è¯»å–åˆ°çš„æ•°æ®ä¼šå…ˆå†™åˆ°ä¸€å—ä¸´æ—¶çš„å†…å­˜ä¸­ï¼Œå‚æ•°innodb_ddl_buffer_sizeç”¨æ¥æ§åˆ¶è¿™å—ä¸´æ—¶å†…å­˜çš„å¤§å°ï¼Œæœ€ç»ˆä¸´æ—¶å†…å­˜ä¸­çš„æ•°æ®ä¼šå†™åˆ°ä¸´æ—¶æ’åºæ–‡ä»¶ä¸­ã€‚å¦‚æœä½ çš„è¡¨æ¯”è¾ƒå¤§ï¼Œä¸´æ—¶æ–‡ä»¶ä¹Ÿå¯èƒ½å ç”¨æ¯”è¾ƒå¤§çš„ç©ºé—´ã€‚</p><p><strong>2. åˆå¹¶æ’åºæ­¥éª¤1ç”Ÿæˆçš„å¤šä¸ªä¸´æ—¶æ–‡ä»¶ä¸­çš„æ•°æ®ã€‚</strong></p><p>å¦‚æœæ­¥éª¤1ä½¿ç”¨äº†å¤šä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆæ¯ä¸ªçº¿ç¨‹éƒ½ä¼šç”Ÿæˆä¸´æ—¶æ’åºæ–‡ä»¶ã€‚æ­¥éª¤2éœ€è¦å°†æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶ä¸­çš„æ•°æ®åˆå¹¶åˆ°ä¸€èµ·ã€‚åˆå¹¶æ’åºæ—¶ï¼ŒInnoDBä¹Ÿä½¿ç”¨äº†å¤šä¸ªçº¿ç¨‹ï¼Œçº¿ç¨‹çš„æ•°é‡ç”±å‚æ•°innodb_ddl_threadsæ§åˆ¶ã€‚</p><p><strong>3. å°†æ­¥éª¤2å¾—åˆ°çš„æ•°æ®åŠ è½½åˆ°æ–°å»ºçš„ç´¢å¼•ä¸­ã€‚</strong></p><p>æ­¥éª¤2å¾—åˆ°çš„æ•°æ®å·²ç»æŒ‰ç´¢å¼•å­—æ®µæ’åºå¥½äº†ï¼Œè¿™é‡Œéœ€è¦å°†è¿™äº›æ•°æ®æ’å…¥åˆ°æ–°çš„ç´¢å¼•ä¸­ã€‚</p><p>å‰é¢è¿™3ä¸ªæ­¥éª¤åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œå…¶ä»–ä¼šè¯è¿˜å¯ä»¥æ­£å¸¸è¯»å–å’Œä¿®æ”¹è¡¨é‡Œé¢çš„æ•°æ®ã€‚InnoDBéœ€è¦å°†è¿™æœŸé—´ä¿®æ”¹è¿‡çš„æ•°æ®è®°å½•ä¸‹æ¥ï¼Œæ•°æ®ä¼šå…ˆå†™å…¥åˆ°ä¸€å—ä¸´æ—¶çš„å†…å­˜ä¸­ï¼Œè¿™å—ä¸´æ—¶å†…å­˜çš„å¤§å°ç”±å‚æ•°innodb_sort_buffer_sizeæ§åˆ¶ã€‚æœ€ç»ˆè¿™äº›æ•°æ®ä¼šå†™åˆ°ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªä¸´æ—¶æ–‡ä»¶ç§°ä¸ºåœ¨çº¿å˜æ›´æ—¥å¿—ã€‚å¦‚æœåœ¨åˆ›å»ºç´¢å¼•çš„è¿‡ç¨‹ä¸­ï¼Œè¡¨ä¸­çš„æ•°æ®å˜æ›´ç‰¹åˆ«é¢‘ç¹ï¼Œé‚£ä¹ˆåœ¨çº¿å˜æ›´æ—¥å¿—ä¸­å°±è¦è®°å½•å¾ˆå¤šæ•°æ®ï¼Œå‚æ•°innodb_online_alter_log_max_sizeé™åˆ¶äº†åœ¨çº¿å˜æ›´æ—¥å¿—çš„å¤§å°ï¼Œå¦‚æœæœŸé—´äº§ç”Ÿçš„å˜æ›´æ—¥å¿—è¶…è¿‡äº†è¿™ä¸ªé™åˆ¶ï¼ŒDDLæœ€ç»ˆä¼šå¤±è´¥ã€‚</p><p><strong>4. å°†åœ¨çº¿å˜æ›´æ—¥å¿—ä¸­çš„æ•°æ®æ›´æ–°åˆ°ç´¢å¼•ä¸­ã€‚</strong></p><p>ä¸ºäº†ä¿éšœç´¢å¼•æ•°æ®å’Œè¡¨ä¸­æ•°æ®çš„ä¸€è‡´æ€§ï¼Œæ­¥éª¤3æ‰§è¡Œå®Œæˆåï¼ŒInnoDBéœ€è¦å°†åœ¨çº¿å˜æ›´æ—¥å¿—ä¸­çš„æ•°æ®æ›´æ–°åˆ°ç´¢å¼•ç»“æ„ä¸­ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œéœ€è¦é”å®šæ–°åˆ›å»ºçš„è¿™ä¸ªç´¢å¼•ï¼Œå› æ­¤ï¼Œå…¶ä»–ä¼šè¯æ’å…¥æ–°çš„æ•°æ®ï¼Œæˆ–è€…æ›´æ–°è¿™ä¸ªæ–°åˆ›å»ºçš„ç´¢å¼•ä¸­åŒ…å«çš„å­—æ®µæ—¶ï¼Œéƒ½ä¼šè¢«é˜»å¡ã€‚</p><p>å¤„ç†åœ¨çº¿å˜æ›´æ—¥å¿—ä¸­çš„æ•°æ®æ—¶ï¼Œå¯èƒ½ä¼šé‡åˆ°å‡ ä¸ªé—®é¢˜ã€‚</p><p>å¦‚æœåˆ›å»ºç´¢å¼•çš„è¿‡ç¨‹ä¸­å‘ç”Ÿå˜åŒ–çš„æ•°æ®å¤ªå¤šï¼Œè¶…è¿‡äº†innodb_online_alter_log_max_sizeçš„é™åˆ¶ï¼Œé‚£ä¹ˆDDLæœ€åä¼šæŠ¥DB_ONLINE_LOG_TOO_BIGçš„é”™è¯¯ã€‚å¦‚æœæ–°åˆ›å»ºçš„æ˜¯å”¯ä¸€ç´¢å¼•ï¼Œé‚£ä¹ˆå¦‚æœåœ¨çº¿å˜æ›´æ—¥å¿—ä¸­å¦‚æœæœ‰æ•°æ®è¿åäº†å”¯ä¸€æ€§çº¦æŸï¼ŒDDLä¹Ÿä¼šå¤±è´¥ã€‚</p><p>ä¸‹é¢æˆ‘é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜è¿™ç§æƒ…å†µã€‚</p><p>æˆ‘ä»¬åœ¨ä¼šè¯1ä¸­åˆ›å»ºä¸€ä¸ªå”¯ä¸€ç´¢å¼•ã€‚æ­¤æ—¶è¡¨ä¸­è¿™å‡ ä¸ªå­—æ®µçš„æ•°æ®æ˜¯å”¯ä¸€çš„ã€‚</p><pre><code class=\"language-go\">alter table employees add unique key \n    uk_x(first_name, last_name, birth_date, hire_date);\n</code></pre><p>åœ¨ç´¢å¼•åˆ›å»ºçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬åœ¨å¦å¤–ä¸€ä¸ªä¼šè¯ä¸­æ‰§è¡Œä¸‹é¢è¿™å‡ ä¸ªSQLã€‚å› ä¸ºæ–°çš„å”¯ä¸€ç´¢å¼•è¿˜æ²¡æœ‰åˆ›å»ºå¥½ï¼Œæ‰€ä»¥è¿™äº›INSERTè¯­å¥å¯ä»¥æ­£å¸¸æ‰§è¡Œã€‚</p><pre><code class=\"language-go\">mysql&gt; insert into employees values\n    (10, '2013-10-10', 'AAAA', 'BBBB', 'M', '2020-10-01');\n\nQuery OK, 1 row affected (5.05 sec)\n\nmysql&gt; insert into employees values\n    (20, '2013-10-10', 'AAAA', 'BBBB', 'M', '2020-10-01');\n\nQuery OK, 1 row affected (5.45 sec)\n\nmysql&gt; insert into employees values\n    (30, '2013-10-10', 'AAAA', 'BBBB', 'M', '2020-10-01');\n\nQuery OK, 1 row affected (2.10 sec)\n\nmysql&gt; delete from employees where emp_no in (10,30);\nQuery OK, 2 rows affected (0.90 sec)\n</code></pre><p>å½“ä¼šè¯1å®Œæˆæ–°ç´¢å¼•çš„åˆ›å»ºï¼Œåœ¨å¤„ç†åœ¨çº¿å˜æ›´æ—¥å¿—ä¸­çš„æ•°æ®æ—¶ï¼Œå‘ç”Ÿäº†æ•°æ®å†²çªï¼Œå› æ­¤DDLæœ€ç»ˆå¤±è´¥äº†ã€‚</p><pre><code class=\"language-go\">mysql&gt; alter table employees add unique key uk_x(first_name, last_name, birth_date, hire_date);\n\nERROR 1062 (23000): Duplicate entry 'AAAA-BBBB-2013-10-10-2020-10-01' for key 'employees.uk_x'\n</code></pre><h3>éœ€è¦é‡å»ºè¡¨çš„åœ¨çº¿DDL</h3><p>è¿˜æœ‰ä¸€äº›DDLæ“ä½œï¼Œè™½ç„¶èƒ½ä»¥INPLACEçš„æ–¹å¼æ‰§è¡Œï¼Œä½†æ˜¯åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­éœ€è¦é‡å»ºè¡¨ï¼Œå› æ­¤å¼€é”€ä¹Ÿæ˜¯æ¯”è¾ƒå¤§çš„ã€‚</p><p>åˆ›å»ºä¸»é”®ã€ä¿®æ”¹ä¸»é”®è¿™å‡ ä¸ªæ“ä½œéƒ½éœ€è¦é‡å»ºè¡¨ã€‚è¿™ä¸€ç‚¹å¾ˆå®¹æ˜“ç†è§£ï¼Œå› ä¸ºInnoDBè¡¨ä»¥èšç°‡ç´¢å¼•çš„æ–¹å¼ç»„ç»‡æ•°æ®ï¼Œä¸»é”®å˜äº†ï¼Œæ•°æ®çš„ç‰©ç†æ ¼å¼å°±ä¼šå‘ç”Ÿå˜åŒ–ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä¿®æ”¹ä¸»é”®çš„ä¾‹å­ã€‚</p><pre><code class=\"language-go\">mysql&gt; alter table employees_bak \n    drop primary key, \n    add primary key(emp_no, last_name, first_name), \n    algorithm=inplace;\n\nQuery OK, 0 rows affected (46.97 sec)\nRecords: 0  Duplicates: 0  Warnings: 0\n</code></pre><p>ä¿®æ”¹å­—æ®µçš„é¡ºåºå’ŒNOT NULLå±æ€§ä¹Ÿéœ€è¦é‡å»ºè¡¨ã€‚è¿™å‡ ä¸ªæ“ä½œä¼šæ”¹å˜è¡Œçš„å­˜å‚¨æ ¼å¼ï¼Œå› æ­¤ä¹Ÿéœ€è¦é‡å»ºè¡¨ã€‚ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œå°†å­—æ®µfirst_nameç§»åˆ°äº†ç¬¬1åˆ—ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬ä¸€èˆ¬åº”è¯¥ä¸å¤ªä¼šç‰¹æ„å»ä¿®æ”¹è¡¨çš„å­—æ®µé¡ºåºã€‚</p><pre><code class=\"language-go\">mysql&gt; desc employees_bak;\n+------------+---------------+------+-----+---------+-------+\n| Field      | Type          | Null | Key | Default | Extra |\n+------------+---------------+------+-----+---------+-------+\n| first_name | varchar(14)   | NO   | PRI | NULL    |       |\n| emp_no     | int           | NO   | PRI | NULL    |       |\n| birth_date | date          | NO   |     | NULL    |       |\n| last_name  | varchar(16)   | NO   | PRI | NULL    |       |\n| gender     | enum('M','F') | NO   |     | NULL    |       |\n| hire_date  | date          | YES  |     | NULL    |       |\n+------------+---------------+------+-----+---------+-------+\n\nmysql&gt; alter table employees_bak \n    modify first_name varchar(14) not null first, \n    algorithm=inplace;\n\nQuery OK, 0 rows affected (41.22 sec)\nRecords: 0  Duplicates: 0  Warnings: 0\n</code></pre><p>å¦å¤–ï¼Œä¼˜åŒ–è¡¨ã€ä¿®æ”¹è¡¨çš„è¡Œæ ¼å¼æˆ–key_block_sizeå±æ€§ä¹Ÿéƒ½éœ€è¦é‡å»ºè¡¨ã€‚</p><p>ä½¿ç”¨optimize tableå‘½ä»¤ä¼˜åŒ–è¡¨ã€‚</p><pre><code class=\"language-go\">mysql&gt; optimize table employees_bak;\n+-------------------------+----------+----------+-------------------------------------------------------------------+\n| Table                   | Op       | Msg_type | Msg_text                                                          |\n+-------------------------+----------+----------+-------------------------------------------------------------------+\n| employees.employees_bak | optimize | note     | Table does not support optimize, doing recreate + analyze instead |\n| employees.employees_bak | optimize | status   | OK                                                                |\n+-------------------------+----------+----------+-------------------------------------------------------------------+\n2 rows in set (42.58 sec)\n</code></pre><p>optimize tableå‘½ä»¤çš„è¯­æ³•ä¸­ï¼Œä¸æ”¯æŒalgorithmå…³é”®å­—ï¼Œä½†æ˜¯å®é™…ä¸Šä¼˜åŒ–è¡¨æ˜¯åšäº†ä¸€æ¬¡åœ¨çº¿çš„è¡¨é‡å»ºã€‚å’Œä¸‹é¢è¿™ä¸ªå‘½ä»¤çš„æ•ˆæœç±»ä¼¼ã€‚</p><pre><code class=\"language-go\">mysql&gt; alter table employees_bak engine=innodb, algorithm=inplace, lock=none;\nQuery OK, 0 rows affected (45.60 sec)\nRecords: 0  Duplicates: 0  Warnings: 0\n</code></pre><p>InnoDBé‡å»ºè¡¨çš„æ—¶å€™ï¼Œéœ€è¦å°†æ•´ä¸ªè¡¨çš„æ•°æ®å†™åˆ°ä¸€ä¸ªä¸´æ—¶çš„ibdæ–‡ä»¶ä¸­ï¼Œè¿™ä¸ªä¸´æ—¶æ–‡ä»¶å’Œè¡¨çš„ibdæ–‡ä»¶æ”¾åœ¨åŒä¸€ä¸ªç›®å½•ä¸‹ï¼Œæ–‡ä»¶åä»¥ â€œ#sql-ibâ€ å¼€å¤´ï¼Œåœ¨é‡å»ºè¡¨çš„è¿‡ç¨‹ä¸­ï¼Œä½ å¯ä»¥åœ¨æ•°æ®ç›®å½•ä¸­çœ‹åˆ°è¿™ä¸ªæ–‡ä»¶ã€‚</p><pre><code class=\"language-go\"># ls -lrt /data/mysql01/data/employees\n......\n-rw-r----- 1 mysql mysql  37748736 8æœˆ   3 16:08 employees.ibd\n-rw-r----- 1 mysql mysql   7340032 8æœˆ   3 16:28 #sql-ib1396-1337919602.ibd\n</code></pre><p>è¡¨ä¸­çš„äºŒçº§ç´¢å¼•ï¼Œä¹Ÿéœ€è¦åŠ è½½åˆ°æ–°ç”Ÿæˆçš„è¿™ä¸ªibdæ–‡ä»¶ä¸­ã€‚</p><p>å’Œåœ¨çº¿åˆ›å»ºäºŒçº§ç´¢å¼•ç±»ä¼¼ï¼Œé‡å»ºè¡¨çš„è¿‡ç¨‹ä¸­ï¼Œå…¶ä»–ä¼šè¯å¯ä»¥æ­£å¸¸è¯»å†™è¡¨ä¸­çš„æ•°æ®ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå¦‚æœè¡¨ä¸­çš„è®°å½•è¢«ä¿®æ”¹äº†ï¼Œéœ€è¦å°†ä¿®æ”¹çš„æ•°æ®è®°å½•åˆ°åœ¨çº¿å˜æ›´æ—¥å¿—ä¸­ã€‚</p><p>å½“èšç°‡ç´¢å¼•å’ŒäºŒçº§ç´¢å¼•çš„æ•°æ®å…¨éƒ¨éƒ½å†™åˆ°æ–°çš„ibdæ–‡ä»¶ä¸­åï¼Œéœ€è¦å°†åœ¨çº¿å˜æ›´æ—¥å¿—ä¸­çš„æ•°æ®æ›´æ–°åˆ°æ–°çš„ibdæ–‡ä»¶ä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¼šå…ˆé”å®šè€çš„èšç°‡ç´¢å¼•ã€‚å› æ­¤ï¼Œåœ¨åº”ç”¨åœ¨çº¿å˜æ›´æ—¥å¿—æ—¶ï¼Œåº”ç”¨ç¨‹åºæ— æ³•è¯»å†™è¡¨çš„æ•°æ®ï¼Œæ³¨æ„ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­è¿æŸ¥è¯¢éƒ½ä¼šè¢«é˜»å¡ã€‚</p><p>å¦‚æœåœ¨é‡å»ºè¡¨çš„è¿‡ç¨‹ä¸­ï¼Œä¿®æ”¹çš„æ•°æ®è¶…è¿‡äº†innodb_online_alter_log_max_sizeçš„é™åˆ¶ï¼ŒDDLæœ€ç»ˆä¼šå¤±è´¥ã€‚ä½ å¯ä»¥å¢åŠ innodb_online_alter_log_max_sizeï¼Œä½†æ˜¯ï¼Œè¿™åŒæ—¶ä¹Ÿå¯èƒ½ä¼šå¯¼è‡´åº”ç”¨åœ¨çº¿å˜æ›´æ—¥å¿—çš„æ—¶é—´å˜é•¿ï¼Œå› æ­¤ä¼šå¢åŠ é”è¡¨çš„æ—¶é—´ã€‚</p><p>åœ¨çº¿å˜æ›´æ—¥å¿—åº”ç”¨å®Œæˆä¹‹åï¼ŒInnoDBåˆ é™¤è€çš„ibdæ–‡ä»¶ï¼Œä¿®æ”¹æ–°åˆ›å»ºçš„ibdæ–‡ä»¶ï¼Œå¹¶åœ¨å…ƒæ•°æ®ä¸­è®°å½•è¿™äº›æ“ä½œã€‚</p><h3>åœ¨çº¿DDLå°ç»“</h3><p>åœ¨çº¿DDLæ˜¯MySQLä¸ºäº†å¢åŠ æ•°æ®åº“å¯ç»´æŠ¤æ€§å¼•å…¥çš„ä¸€ä¸ªå¾ˆæœ‰ç”¨çš„ç‰¹æ€§ã€‚ä½ å¯ä»¥é€‚å½“åœ°è°ƒå¤§innodb_parallel_read_threadsã€innodb_ddl_threadsã€innodb_ddl_buffer_sizeã€innodb_sort_buffer_sizeç­‰å‚æ•°ï¼Œä»¥åŠ å¿«DDLçš„æ‰§è¡Œæ•ˆç‡ï¼Œå½“ç„¶å‰ææ˜¯æœåŠ¡å™¨çš„æ€§èƒ½è¦è·Ÿå¾—ä¸Šã€‚</p><p>åœ¨çº¿DDLçš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œéœ€è¦å ç”¨ä¸€äº›é¢å¤–çš„ç©ºé—´ï¼ŒåŒ…æ‹¬ä¸´æ—¶æ’åºæ–‡ä»¶ï¼Œåœ¨çº¿å˜æ›´æ—¥å¿—æ–‡ä»¶ï¼Œä»¥åŠä¸´æ—¶çš„ibdæ–‡ä»¶ã€‚ä¸´æ—¶æ’åºæ–‡ä»¶é»˜è®¤å­˜æ”¾åœ¨tmpdirä¸‹ï¼Œå¦‚æœtmpdirç©ºé—´ç´§å¼ ï¼Œä½ ä¹Ÿå¯ä»¥è®¾ç½®å‚æ•°innodb_tmpdirï¼Œå°†è¿™äº›æ–‡ä»¶æ”¾åˆ°ä¸€ä¸ªç©ºé—´è¶³å¤Ÿå¤§çš„ç›®å½•ä¸‹ã€‚ä½ å¯ä»¥æ ¹æ®è¡¨ibdæ–‡ä»¶å½“å‰çš„å¤§å°æ¥ä¼°ç®—ä¸´æ—¶æ’åºæ–‡ä»¶å’Œä¸´æ—¶ibdæ–‡ä»¶éœ€è¦çš„ç©ºé—´ã€‚</p><p>è™½ç„¶åœ¨çº¿DDLæå¤§åœ°å‡å°‘äº†é”è¡¨çš„æ—¶é—´ï¼Œä½†æ˜¯åœ¨åº”ç”¨åœ¨çº¿å˜æ›´æ—¥å¿—æ—¶ï¼Œè¿˜æ˜¯ä¼šå°†è¡¨æˆ–äºŒçº§ç´¢å¼•é”ä½ï¼Œå› æ­¤åº”ç”¨ç¨‹åºè¿˜æ˜¯ä¼šæœ‰å½±å“çš„ï¼Œé”çš„æ—¶é—´å–å†³äºè¡¨çš„å¤§å°ä»¥åŠå’ŒDDLæœŸé—´å‘ç”Ÿå˜åŒ–çš„æ•°æ®é‡æœ‰å…³ã€‚</p><p>InnoDBåœ¨çº¿å˜æ›´æ—¥å¿—æŒ‰innodb_sort_buffer_sizeçš„è®¾ç½®ï¼Œåˆ†ä¸ºå¤šä¸ªå—ã€‚åœ¨åº”ç”¨åœ¨çº¿å˜æ›´æ—¥å¿—æ—¶ï¼Œå¦‚æœæ˜¯åœ¨åº”ç”¨æœ€åä¸€ä¸ªæ—¥å¿—å—ä¸­çš„è®°å½•ï¼Œéœ€è¦è·å–ä¸»é”®æˆ–ç´¢å¼•çš„é”ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/a1/0d/a14d78989f67a7117c0f7f506e41yy0d.png?wh=1406x408\" alt=\"\"></p><p>å¦‚æœä½ çš„è¡¨ç‰¹åˆ«å¤§ï¼Œå¹¶ä¸”è¡¨ä¸­æ•°æ®çš„ä¿®æ”¹éå¸¸é¢‘ç¹ï¼ŒInnoDBåŸç”Ÿçš„åœ¨çº¿DDLå¹¶ä¸ä¸€å®šèƒ½æ»¡è¶³ä½ çš„éœ€æ±‚ã€‚</p><h2>ä¸æ”¯æŒåœ¨çº¿æ‰§è¡Œçš„DDL</h2><p>è™½ç„¶MySQLå¢åŠ äº†åœ¨çº¿DDLçš„èƒ½åŠ›ï¼Œä½†è¿˜æ˜¯å­˜åœ¨ä¸€äº›æƒ…å†µæ— æ³•ä½¿ç”¨åœ¨çº¿DDLï¼Œæ‰§è¡Œè¿™äº›DDLæ—¶ï¼Œéœ€è¦ä½¿ç”¨MySQLæœ€åŸå§‹çš„COPYæ–¹å¼ï¼Œå…ˆåˆ›å»ºä¸€ä¸ªä¸´æ—¶è¡¨ï¼Œå†é”ä½æºè¡¨ï¼Œå°†æºè¡¨çš„è®°å½•æ’å…¥åˆ°ä¸´æ—¶è¡¨ï¼Œæœ€åï¼Œå½“æ•°æ®å¤åˆ¶å®Œæˆåï¼Œå°†ä¸´æ—¶è¡¨æ”¹ä¸ºæ­£å¼è¡¨ã€‚</p><p>ä¸‹é¢è¿™äº›æ“ä½œéƒ½ä¸æ”¯æŒåœ¨çº¿DDLã€‚</p><ul>\n<li>åˆ é™¤è¡¨çš„ä¸»é”®ã€‚</li>\n</ul><pre><code class=\"language-go\">mysql&gt; alter table salaries drop primary key, algorithm=inplace;\nERROR 1846 (0A000): ALGORITHM=INPLACE is not supported. Reason: Dropping a primary key is not allowed without also adding a new primary key. Try ALGORITHM=COPY.\n</code></pre><ul>\n<li>ä¿®æ”¹å­—ç¬¦é›†ã€‚</li>\n</ul><p>æ³¨æ„ï¼Œä½¿ç”¨alter table table_name convert to character setæ‰ä¼šä¿®æ”¹è¡¨ä¸­å·²æœ‰æ•°æ®çš„ç¼–ç ã€‚alter table table_name character setåªæ˜¯ä¿®æ”¹äº†è¡¨çš„é»˜è®¤å­—ç¬¦é›†ï¼Œä¸ä¼šä¿®æ”¹ç°æœ‰æ•°æ®çš„ç¼–ç æ–¹å¼ã€‚</p><pre><code class=\"language-go\">mysql&gt; alter table employees_bak CONVERT TO CHARACTER SET GBK, algorithm=inplace;\nERROR 1846 (0A000): ALGORITHM=INPLACE is not supported. Reason: Cannot change column type INPLACE. Try ALGORITHM=COPY.\n</code></pre><ul>\n<li>ä¿®æ”¹å­—æ®µçš„æ•°æ®ç±»å‹ã€‚</li>\n</ul><pre><code class=\"language-go\">mysql&gt; desc salaries;\n+-----------+------+------+-----+---------+-------+\n| Field     | Type | Null | Key | Default | Extra |\n+-----------+------+------+-----+---------+-------+\n| emp_no    | int  | NO   | PRI | NULL    |       |\n| salary    | int  | NO   |     | NULL    |       |\n| from_date | date | NO   | PRI | NULL    |       |\n| to_date   | date | YES  |     | NULL    |       |\n+-----------+------+------+-----+---------+-------+\n4 rows in set (0.01 sec)\n\nmysql&gt; alter table salaries modify salary bigint, algorithm=inplace;\nERROR 1846 (0A000): ALGORITHM=INPLACE is not supported. Reason: Cannot change column type INPLACE. Try ALGORITHM=COPY.\n</code></pre><ul>\n<li>ç¼©å‡VARCHARå­—æ®µçš„é•¿åº¦ï¼Œæˆ–è€…å°†VARCHARå­—æ®µçš„é•¿åº¦ä»ä¸åˆ°255å­—èŠ‚ä¿®æ”¹ä¸ºè¶…è¿‡255å­—èŠ‚ã€‚è¿™ä¸€ç‚¹å¯¹CHARç±»å‹å…¶å®ä¹Ÿä¸€æ ·ã€‚</li>\n</ul><pre><code class=\"language-go\">mysql&gt; desc departments;\n+-----------+-------------+------+-----+---------+-------+\n| Field     | Type        | Null | Key | Default | Extra |\n+-----------+-------------+------+-----+---------+-------+\n| dept_no   | char(4)     | NO   | PRI | NULL    |       |\n| dept_name | varchar(40) | NO   | UNI | NULL    |       |\n+-----------+-------------+------+-----+---------+-------+\n2 rows in set (0.01 sec)\n\n\nmysql&gt; alter table departments modify dept_name varchar(30), algorithm=inplace;\nERROR 1846 (0A000): ALGORITHM=INPLACE is not supported. Reason: Cannot change column type INPLACE. Try ALGORITHM=COPY.\n\nmysql&gt; alter table departments modify dept_name varchar(64), algorithm=inplace;\nERROR 1846 (0A000): ALGORITHM=INPLACE is not supported. Reason: Cannot change column type INPLACE. Try ALGORITHM=COPY.\n\nmysql&gt; alter table departments modify dept_no char(64), algorithm=inplace;\nERROR 1846 (0A000): ALGORITHM=INPLACE is not supported. Reason: Cannot change column type INPLACE. Try ALGORITHM=COPY.\n\nmysql&gt; alter table departments modify dept_no char(2), algorithm=inplace;\nERROR 1846 (0A000): ALGORITHM=INPLACE is not supported. Reason: Cannot change column type INPLACE. Try ALGORITHM=COPY.\n</code></pre><p>è™½ç„¶æœ‰äº›INPLACEæ“ä½œä¹Ÿéœ€è¦é‡å»ºè¡¨ï¼Œéœ€è¦å¤åˆ¶æ•´ä¸ªè¡¨çš„æ•°æ®ï¼Œä½†æ˜¯å’ŒCOPYæ–¹å¼ç›¸æ¯”ï¼Œè¿˜æ˜¯å­˜åœ¨æ¯”è¾ƒå¤§çš„åŒºåˆ«çš„ã€‚é¦–å…ˆï¼Œä»¥COPYçš„æ–¹å¼æ‰§è¡ŒDDLæ—¶ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¸­éƒ½ä¼šé”è¡¨ã€‚å…¶æ¬¡COPYæ˜¯åœ¨MySQLçš„Serverå±‚æ‰§è¡Œçš„ï¼Œéœ€è¦å…ˆä»å­˜å‚¨å¼•æ“è·å–ä¸€è¡Œæ•°æ®ï¼Œå†è°ƒç”¨å­˜å‚¨å¼•æ“çš„æ¥å£å†™å…¥ä¸€è¡Œæ•°æ®ï¼Œç›´åˆ°å¤„ç†å®Œæ‰€æœ‰çš„è®°å½•ã€‚è€ŒINPLACE DDLæ˜¯åœ¨InnoDBå­˜å‚¨å¼•æ“çš„å†…éƒ¨å¤åˆ¶æ•°æ®ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­ä¸éœ€è¦è®°å½•UNDOæ—¥å¿—å’ŒREDOæ—¥å¿—ï¼Œè€Œä¸”äºŒçº§ç´¢å¼•çš„æ¡ç›®ä¼šé¢„å…ˆæ’å¥½åºï¼Œå› æ­¤ç†è®ºä¸Šå†™å…¥çš„é€Ÿåº¦ä¼šæ›´å¿«ã€‚</p><h2>ç¬¬ä¸‰æ–¹åœ¨çº¿DDLå·¥å…·</h2><p>å¦‚æœä½ è¦æ‰§è¡Œçš„DDLä¸æ”¯æŒä»¥INSTANTå’ŒINPLACEçš„æ–¹å¼æ‰§è¡Œï¼Œæˆ–è€…ä½ çš„è¡¨éå¸¸å¤§ï¼Œæ•°æ®å˜æ›´ä¹Ÿå¾ˆé¢‘ç¹ï¼Œä½¿ç”¨MySQLåŸç”Ÿçš„åœ¨çº¿DDLä¹Ÿæ— æ³•æ»¡è¶³ä¸šåŠ¡çš„å¯ç”¨æ€§è¦æ±‚ï¼Œé‚£ä¹ˆä½ å¯ä»¥è€ƒè™‘ä½¿ç”¨ä¸€äº›ç¬¬ä¸‰æ–¹çš„åœ¨çº¿DDLå·¥å…·ï¼Œä¸šç•Œæ¯”è¾ƒçŸ¥åçš„æœ‰perconaå‡ºå“çš„pt-online-schema-changeå·¥å…·ï¼Œä»¥åŠGithubå‡ºå“çš„gh-ostå·¥å…·ã€‚å½“ç„¶ï¼Œå¯èƒ½è¿˜å­˜åœ¨å…¶ä»–ç±»ä¼¼çš„ç¬¬ä¸‰æ–¹å·¥å…·ï¼Œå®é™…ä¸Šä½ è‡ªå·±ä¹Ÿå¯ä»¥å†™ä¸€ä¸ªç±»ä¼¼çš„å·¥å…·ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥ä¸€èµ·æ¢è®¨ä¸‹ï¼Œæ€ä¹ˆå®ç°ä¸€ä¸ªåœ¨çº¿DDLå·¥å…·ã€‚å‡è®¾æˆ‘ä»¬è¦å¯¹ä¸€ä¸ªè¡¨SRC_TABæ‰§è¡Œä¸€ä¸ªå¼€é”€å¾ˆå¤§çš„DDLï¼Œæˆ‘ä»¬å¯ä»¥å°†DDLæ‹†åˆ†æˆå‡ ä¸ªæ­¥éª¤ã€‚</p><ol>\n<li>åˆ›å»ºä¸€ä¸ªè¡¨ç»“æ„ä¸€æ ·çš„ç©ºè¡¨ã€‚</li>\n</ol><pre><code class=\"language-go\">create table __SRC_TAB_TMP like SRC_TAB;\n</code></pre><ol start=\"2\">\n<li>åœ¨æ–°å»ºçš„ä¸´æ—¶è¡¨ä¸Šæ‰§è¡ŒDDLã€‚ç”±äºæ–°è¡¨ä¸­æ²¡æœ‰ä»»ä½•æ•°æ®ï¼Œå› æ­¤DDLå¾ˆå¿«å°±èƒ½æ‰§è¡Œå®Œã€‚</li>\n<li>åˆ†æ‰¹è¯»å–æºè¡¨çš„æ•°æ®ï¼Œæ’å…¥åˆ°æ–°å»ºçš„ä¸´æ—¶è¡¨ä¸­ã€‚</li>\n</ol><pre><code class=\"language-go\">insert ignore into __SRC_TAB_TMP(...) select ... from SRC_TAB where ...\n</code></pre><p>å½“ç„¶ï¼Œåœ¨å¤åˆ¶æ•°æ®çš„è¿‡ç¨‹ä¸­ï¼Œæºè¡¨çš„æ•°æ®ä¼šä¸æ–­åœ°å‘ç”Ÿå˜åŒ–ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æƒ³åŠæ³•åŒæ­¥è¿™äº›å‘ç”Ÿäº†å˜åŒ–çš„æ•°æ®ï¼Œå¦åˆ™ä¸¤ä¸ªè¡¨çš„æ•°æ®å°±ä¸ä¸€è‡´äº†ã€‚</p><ol start=\"4\">\n<li>æˆ‘ä»¬å¯ä»¥ç»™æºè¡¨å»ºå‡ ä¸ªè§¦å‘å™¨ï¼Œå°†æºè¡¨å‘ç”Ÿè¿‡å˜åŒ–çš„è®°å½•éƒ½æ•æ‰ä¸‹æ¥ã€‚</li>\n</ol><p>å®é™…ä¸Šï¼Œè¦åœ¨å¤åˆ¶æ•°æ®å‰ï¼Œå…ˆæŠŠè§¦å‘å™¨å»ºå¥½ï¼Œå› æ­¤è¿™ä¸€æ­¥è¦åœ¨æ­¥éª¤3ä¹‹å‰æ‰§è¡Œã€‚è§¦å‘å™¨çš„å®ç°ä¸Šï¼Œæœ‰å‡ ç§ä¸åŒçš„ç­–ç•¥å¯ä»¥é€‰æ‹©ã€‚ä¸€ç§æ˜¯åœ¨è§¦å‘å™¨ä¸­ï¼Œå°†æ•´æ¡è®°å½•ç›´æ¥å†™åˆ°ç›®æ ‡ä¸´æ—¶è¡¨ä¸­ã€‚</p><p>è¿˜æœ‰ä¸€ç§æ–¹å¼æ˜¯å…ˆå°†å‘ç”Ÿè¿‡å˜åŒ–çš„æ•°æ®å†™åˆ°ä¸€ä¸ªæ—¥å¿—è¡¨ä¸­ï¼Œæ—¥å¿—è¡¨ä¸­åªä¿å­˜ä¸»é”®å­—æ®µå’Œæ•°æ®çš„å˜æ›´ç±»å‹ã€‚</p><p>æ—¥å¿—è¡¨çš„ç»“æ„ç±»ä¼¼äºä¸‹é¢å»ºçš„__SRC_TAB_DML_LOGè¡¨ã€‚PKå­—æ®µæ˜¯æºè¡¨çš„ä¸»é”®å­—æ®µï¼Œå½“ç„¶æ•°æ®ç±»å‹è¦å’Œæºè¡¨ä¿æŒä¸€è‡´ï¼Œç”¨æ¥æ ‡è¯†å‘ç”Ÿè¿‡å˜åŒ–çš„è®°å½•çš„ä¸»é”®ã€‚DML_TYPEå­—æ®µç”¨äº†æ ‡è¯†å‘ç”Ÿçš„DMLç±»å‹ã€‚DMLç±»å‹åˆ†ä¸ºINSERTã€UPDATEã€DELETEã€‚å¦‚æœæ˜¯æ›´æ–°äº†ä¸»é”®ï¼Œé‚£ä¹ˆéœ€è¦è®°å½•ä¸¤æ¡æ—¥å¿—ï¼Œä¸€æ¡æ˜¯åˆ é™¤æ“ä½œï¼Œä¸€æ¡æ˜¯æ’å…¥æ“ä½œã€‚</p><pre><code class=\"language-go\">create table __SRC_TAB_DML_LOG(\n    id bigint not null auto_increment,\n    pk bigint not null,\n    dml_type tinyint not null comment '0: insert, 1: update, 2: delete',\n    ts timestamp,\n    applied tinyint not null comment '0: not applied, 1: applied',\n    primary key(id)\n) engine=innodb;\n</code></pre><ol start=\"5\">\n<li>æŒ‰é¡ºåºå¤„ç†å¢é‡æ—¥å¿—è¡¨ä¸­çš„æ•°æ®ã€‚</li>\n</ol><p>æ ¹æ®å¢é‡æ—¥å¿—è¡¨ä¸­è®°å½•çš„ä¸»é”®IDï¼Œä¾æ¬¡å°†æ•°æ®ä»æºè¡¨å¤åˆ¶åˆ°ç›®æ ‡è¡¨ã€‚</p><pre><code class=\"language-go\">replace into __SRC_TAB_TMP(...) select ... from SRC_TAB where pk in (...)\n</code></pre><p>å¦‚æœæ˜¯DELETEæ“ä½œï¼Œåˆ™éœ€è¦åˆ°ç›®æ ‡è¡¨ä¸­åˆ é™¤å¯¹åº”çš„è®°å½•ã€‚</p><pre><code class=\"language-go\">delete from __SRC_TAB_TMP where pk in (...)\n</code></pre><p>å¤„ç†å¢é‡æ—¥å¿—è¡¨ä¸­çš„æ•°æ®æ—¶ï¼Œä½ å¯ä»¥æƒ³åŠæ³•åšå¹¶è¡Œå¤„ç†ã€‚è¿˜å¯ä»¥å°†ä¸»é”®ç›¸åŒçš„å¤šæ¡å˜æ›´è®°å½•åˆå¹¶åˆ°ä¸€èµ·æ‰§è¡Œã€‚æ¯”å¦‚æºè¡¨ä¸­æœ‰ä¸€è¡Œè®°å½•è¢«æ›´æ–°äº†100æ¬¡ï¼Œä½ åªè¦å°†è¯¥è®°å½•æœ€æ–°çš„æ•°æ®åŒæ­¥åˆ°ç›®æ ‡è¡¨å°±å¯ä»¥äº†ã€‚</p><ol start=\"6\">\n<li>é”å®šæºè¡¨ï¼Œå¤„ç†å¢é‡æ—¥å¿—è¡¨ä¸­å‰©ä½™çš„æ•°æ®ã€‚</li>\n</ol><p>å½“å¢é‡æ—¥å¿—è¡¨ä¸­çš„æ•°æ®åŸºæœ¬å¤„ç†å®Œä¹‹åï¼Œé”å®šæºè¡¨ã€‚æºè¡¨é”å®šåï¼Œå°±ä¸ä¼šå†å‘ç”Ÿæ•°æ®å˜åŒ–äº†ï¼Œç„¶åä½ å†å°†å¢é‡æ—¥å¿—è¡¨ä¸­æ‰€å‰©ä¸å¤šçš„æ•°æ®å¤„ç†å®Œã€‚</p><pre><code class=\"language-go\">lock tables SRC_TAB write, __SRC_TAB_TMP write;\n</code></pre><ol start=\"7\">\n<li>äº¤æ¢æºè¡¨å’Œç›®æ ‡è¡¨ã€‚</li>\n</ol><p>æ­¤æ—¶æºè¡¨å’Œç›®æ ‡è¡¨çš„æ•°æ®å·²ç»å®Œå…¨åŒæ­¥äº†ï¼Œæ‰§è¡Œrenameæ“ä½œï¼Œäº¤æ¢ä¸¤ä¸ªè¡¨çš„è¡¨åã€‚</p><pre><code class=\"language-go\">rename table SRC_TAB to __SRC_TAB_TOBE_DROPPED, __SRC_TAB_TMP to SRC_TAB_;\n</code></pre><p>è¿™æ ·ï¼Œä½ å°±å®Œæˆäº†SRC_TABè¡¨çš„DDLæ“ä½œã€‚å½“ç„¶ï¼Œåœ¨å®ç°ä¸Šï¼Œè¿˜æœ‰å¾ˆå¤šç»†èŠ‚é—®é¢˜éœ€è¦å¤„ç†ã€‚æ¯”å¦‚ï¼Œå¦‚æœæºè¡¨ä½¿ç”¨äº†è”åˆä¸»é”®ï¼Œä½ åº”è¯¥å¦‚ä½•åˆ†æ‰¹å¤åˆ¶æ•°æ®ã€‚å¦‚æœæœ‰å…¶ä»–è¡¨å¯¹æºè¡¨æœ‰å¤–é”®ä¾èµ–ï¼Œè¿™æ ·åšä¹Ÿä¼šæœ‰é—®é¢˜ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œå¦‚ä½•ä¿è¯æºè¡¨å’Œç›®æ ‡è¡¨çš„æ•°æ®æ˜¯å®Œå…¨ä¸€è‡´çš„ã€‚</p><h2>æ€»ç»“</h2><p>è¿™ä¸€è®²ä¸­ï¼Œæˆ‘ä»¬è®¨è®ºMySQLä¸­æ‰§è¡ŒDDLçš„å‡ ç§ä¸åŒçš„æ–¹å¼ã€‚</p><p>DDLï¼Œç‰¹åˆ«æ˜¯å¯¹å¤§è¡¨è¿›è¡ŒDDLï¼Œæœ€å¥½æ˜¯å®‰æ’åœ¨ä¸šåŠ¡è®¿é—®çš„ä½å³°æœŸè¿›è¡Œã€‚å¦‚æœä½ çš„æ•°æ®åº“éå¸¸ç¹å¿™ï¼Œå³ä½¿æ˜¯DROP TABLEè¿™æ ·çœ‹ä¼¼ç®€å•çš„æ“ä½œï¼Œéƒ½æœ‰å¯èƒ½å¯¹ä¸šåŠ¡é€ æˆæ˜æ˜¾çš„å½±å“ã€‚</p><p>è¿˜æœ‰ï¼Œå³ä½¿ä½ æ‰§è¡Œçš„DDLåªéœ€è¦ä¿®æ”¹å…ƒæ•°æ®ï¼Œåœ¨DDLæ‰§è¡Œå¼€å§‹å’Œæ‰§è¡Œç»“æŸçš„æ—¶å€™ï¼Œä¹Ÿæ˜¯éœ€è¦çŸ­æš‚åœ°è·å–å…ƒæ•°æ®é”çš„ï¼Œå¦‚æœæ•°æ®åº“ä¸­æœ‰åˆ«çš„é•¿äº‹åŠ¡æå‰è·å–äº†å…ƒæ•°æ®é”ï¼Œé‚£ä¹ˆDDLå°±ä¼šè¢«é˜»å¡ï¼Œè€ŒDDLè¢«é˜»å¡åï¼Œåç»­å…¶ä»–ä¼šè¯è®¿é—®åŒä¸€ä¸ªè¡¨æ—¶ï¼Œä¹Ÿä¼šè¢«é˜»å¡ã€‚å› æ­¤åœ¨DDLæ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œéœ€è¦æ³¨æ„è§‚å¯Ÿæ•°æ®åº“çš„æ•´ä½“çŠ¶å†µï¼Œç‰¹åˆ«æ˜¯è¦æ³¨æ„æœ‰æ²¡æœ‰ä¼šè¯åœ¨ç­‰å¾…å…ƒæ•°æ®é”ã€‚</p><p>MySQLçš„åœ¨çº¿DDLå¹¶ä¸æ˜¯å®Œå…¨æ— é”çš„ã€‚è¿˜æœ‰ä¸€äº›DDLå¹¶ä¸æ”¯æŒåœ¨çº¿æ‰§è¡Œã€‚ä½ å¯ä»¥è€ƒè™‘ä½¿ç”¨ç¬¬ä¸‰æ–¹çš„åœ¨çº¿DDLå·¥å…·ï¼Œä½†æ˜¯åœ¨ä½¿ç”¨å‰ä¸€å®šè¦åœ¨ä½ è‡ªå·±çš„ç¯å¢ƒä¸­åšå¥½å……åˆ†çš„æµ‹è¯•ï¼Œè¿™äº›å·¥å…·å¯èƒ½ä¼šæœ‰ä¸€äº›é¢å¤–çš„é™åˆ¶ã€‚ä½ éœ€è¦é‡ç‚¹éªŒè¯ä¸‹è¿™äº›å·¥å…·æ˜¯å¦èƒ½ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>gh-ostæ˜¯æ¯”è¾ƒçŸ¥åçš„ä¸€æ¬¾åœ¨çº¿DDLå·¥å…·ï¼Œåœ¨å®ç°ä¸Šä¹Ÿéå¸¸æœ‰ç‰¹è‰²ã€‚gt-oståœ¨æ‰§è¡ŒDDLå˜æ›´æ—¶ï¼Œä¸éœ€è¦ç»™æºè¡¨å»ºè§¦å‘å™¨ï¼Œè€Œæ˜¯é€šè¿‡BINLOGæ¥æ•æ‰DDLå˜æ›´æœŸé—´å‘ç”Ÿè¿‡å˜åŒ–çš„æ•°æ®ã€‚æˆ‘å°è¯•åœ¨æµ‹è¯•ç¯å¢ƒåšäº†ä¸€ä¸ªå®éªŒã€‚</p><pre><code class=\"language-go\">gh-ost -alter \"alter table employees_bak modify hire_date date\" \\\n  -user user_01 \\\n  -host 127.0.0.1 \\\n  -password somepass \\\n  -database employees \\\n  --allow-on-master \\\n  --execute \\\n  -heartbeat-interval-millis 1000\n</code></pre><p>åœ¨æ‰§è¡Œgh-ostå‰ï¼Œæˆ‘å…ˆå¼€å¯äº†general_logï¼Œæœ€ç»ˆåœ¨general logä¸­å‘ç°æœ‰ä»¥ä¸‹è¿™å‡ ç±»SQLã€‚</p><ul>\n<li>create table like</li>\n</ul><pre><code class=\"language-go\">create /* gh-ost */ table `employees`.`_employees_bak_gho` \n  like `employees`.`employees_bak`\n</code></pre><ul>\n<li>alter table</li>\n</ul><pre><code class=\"language-go\">alter /* gh-ost */ table `employees`.`_employees_bak_gho` modify hire_date date\n</code></pre><ul>\n<li>select</li>\n</ul><pre><code class=\"language-go\">select  /* gh-ost `employees`.`employees_bak` iteration:0 */\n    `emp_no`\nfrom `employees`.`employees_bak`\nwhere ((`emp_no` &gt; _binary'10001') or ((`emp_no` = _binary'10001'))) \nand ((`emp_no` &lt; _binary'20000') or ((`emp_no` = _binary'20000')))\norder by `emp_no` asc\nlimit 1\noffset 999\n</code></pre><ul>\n<li>insert ignore into</li>\n</ul><pre><code class=\"language-go\">insert /* gh-ost `employees`.`employees_bak` */ \nignore into `employees`.`_employees_bak_gho` \n(`emp_no`, `birth_date`, `first_name`, `last_name`, `gender`, `hire_date`)\n( \n  select `emp_no`, `birth_date`, `first_name`, `last_name`, `gender`, `hire_date` \n  from `employees`.`employees_bak` force index (`PRIMARY`)\n  where (((`emp_no` &gt; _binary'10001') or ((`emp_no` = _binary'10001')))\n  and ((`emp_no` &lt; _binary'11000') or ((`emp_no` = _binary'11000')))) \n  lock in share mode\n)\n</code></pre><ul>\n<li>replace into</li>\n</ul><pre><code class=\"language-go\">replace /* gh-ost `employees`.`_employees_bak_gho` */ into\n    `employees`.`_employees_bak_gho`(`emp_no`, `birth_date`, `first_name`, `last_name`, `gender`, `hire_date`)\nvalues (20001, '1962-05-16', _binary'Atreye', _binary'Eppinger', ELT(1, 'M','F'), '1990-04-18')\n</code></pre><ul>\n<li>rename table</li>\n</ul><pre><code class=\"language-go\">rename /* gh-ost */ table `employees`.`employees_bak` to `employees`.`_employees_bak_del`, `employees`.`_employees_bak_gho` to `employees`.`employees_bak`\n</code></pre><p>ä¸Šé¢çš„è¿™å‡ ç±»SQLï¼Œåˆ†åˆ«èµ·åˆ°äº†ä»€ä¹ˆä½œç”¨ï¼Ÿinsert ignore intoå’Œreplace intoçš„æ‰§è¡Œé¡ºåºï¼Œå¯¹æœ€ç»ˆæ•°æ®çš„ä¸€è‡´æ€§æœ‰å½±å“å—ï¼Ÿæ‰§è¡Œinsert ignore into â€¦ select from â€¦ çš„æ—¶å€™ï¼Œä¸ºä»€ä¹ˆè¦åŠ ä¸Šlock in share modeï¼Ÿ</p><p>æœŸå¾…ä½ çš„æ€è€ƒï¼Œæ¬¢è¿åœ¨ç•™è¨€åŒºä¸­ä¸æˆ‘äº¤æµã€‚å¦‚æœä»Šå¤©çš„è¯¾ç¨‹è®©ä½ æœ‰æ‰€æ”¶è·ï¼Œä¹Ÿæ¬¢è¿è½¬å‘ç»™æœ‰éœ€è¦çš„æœ‹å‹ã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼</p>","neighbors":{"left":{"article_title":"11ï½œè¡¨å¤ªå¤§äº†ï¼Œä¿®æ”¹è¡¨ç»“æ„å¤ªæ…¢æ€ä¹ˆè§£å†³ï¼Ÿï¼ˆä¸Šï¼‰","id":806938},"right":{"article_title":"13ï½œå®šä½MySQLé—®é¢˜çš„æ€è·¯ï¼šæ•°æ®åº“ä¸ºä»€ä¹ˆæ…¢äº†ï¼Ÿ","id":806951}},"comments":[{"had_liked":false,"id":394534,"user_name":"å¶æ˜","can_delete":false,"product_type":"c1","uid":1412429,"ip_address":"æ±Ÿè‹","ucode":"D0B4B7660DA766","user_header":"https://static001.geekbang.org/account/avatar/00/15/8d/4d/992070e8.jpg","comment_is_top":false,"comment_ctime":1727082531,"is_pvip":false,"replies":[{"id":143231,"content":"å¯¹çš„ã€‚\n\næˆ‘å†æµ‹è¯•äº†ä¸€ä¸‹ï¼ŒBinlogä¸­ï¼ŒInsertäº‹ä»¶è§£æä¸ºreplace intoè¯­å¥ï¼ŒUpdateäº‹ä»¶è§£æä¸ºupdateè¯­å¥ï¼ŒDeleteäº‹ä»¶è§£æä¸ºdeleteè¯­å¥ã€‚\n\nBinlogå¯è§å’Œäº‹åŠ¡å¯è§ä¹‹é—´å­˜åœ¨çš„æ—¶é—´å·®ï¼Œç”±ä¸¤é˜¶æ®µæäº¤å¼•èµ·ã€‚ğŸ‘ğŸ‘\n","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3898827,"ctime":1727331881,"ip_address":"æµ™æ±Ÿ","comment_id":394534,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100799401,"comment_content":"insert ignore intoç”¨æ¥åŒæ­¥å…¨é‡æ•°æ®ï¼Œreplace intoæ˜¯ä»binlogä¸­è§£æå‡ºæ¥çš„insertå’Œupdateäº‹ä»¶ã€‚binlogä¸­çš„deleteäº‹ä»¶åº”è¯¥ä¼šè§£ææˆdeleteè¯­å¥ã€‚æˆ‘æµ‹è¯•çš„ç»“æœæ˜¯ update è¯­å¥å¹¶æ²¡æœ‰è½¬ä¸º replace intoï¼Œä»æ—§æ˜¯ updateã€‚å…¨é‡æ—¥å¿—å¦‚ä¸‹\n\n2024-09-20T03:59:21.024359Z\t 1451 Query\tupdate employees_bak set first_name = &#39;2024-09-20&#39; where emp_no = 10001\n\n2024-09-20T03:59:21.044251Z\t 1467 Query\tSTART TRANSACTION\n2024-09-20T03:59:21.044461Z\t 1467 Query\tSET SESSION time_zone = &#39;+00:00&#39;, sql_mode = CONCAT(@@session.sql_mode, &#39;,NO_AUTO_VALUE_ON_ZERO,STRICT_ALL_TABLES&#39;)\n2024-09-20T03:59:21.044739Z\t 1467 Query\tupdate &#47;* gh-ost `employees`.`_employees_bak_gho` *&#47;\n\t\t\t\t\t`employees`.`_employees_bak_gho`\n\t\t\t\tset\n\t\t\t\t\t`emp_no`=10001, `birth_date`=&#39;1953-09-02&#39;, `first_name`=_binary&#39;2024-09-20&#39;, `last_name`=_binary&#39;Facello&#39;, `gender`=ELT(1, &#39;M&#39;,&#39;F&#39;), `hire_date`=&#39;1986-06-26&#39;\n\t\t\t\twhere\n\t\t\t\t\t((`emp_no` = 10001))\n2024-09-20T03:59:21.051821Z\t 1467 Query\tCOMMIT\n\næˆ‘ç†è§£çš„è½¬åŒ–è§„åˆ™ï¼Œä¸çŸ¥é“å¯¹å¦\n1ã€insert -&gt; replace into\n2ã€update -&gt; updateï¼Œå¦‚æœè®°å½•å·²ç»æ‹·è´åˆ°å½±å­è¡¨ä¸­ï¼Œé‚£ä¹ˆç›´æ¥ update å½±å­è¡¨ï¼Œå½±å­è¡¨ä¸­è®°å½•è¾¾åˆ°æœ€æ–°ï¼›å¦‚æœè®°å½•å°šæœªæ‹·è´åˆ°å½±å­è¡¨ï¼Œç›´æ¥æ›´æ–°å½±å­è¡¨ï¼Œä½†æ­¤æ—¶å½±å­è¡¨ä¸­æ²¡æœ‰è¿™æ¡è®°å½•ï¼Œå› æ­¤æ›´æ–° 0 è¡Œï¼Œå¾…åé¢ insert ignore into æ’å…¥æ–°çš„è®°å½•ï¼Œå½±å­è¡¨ä¸­å¯¹åº”çš„è¡Œä»æ—§ä¸ºæœ€æ–°çš„è®°å½•\n3ã€delete -&gt; delete\n\nBinlogå¯è§å’Œäº‹åŠ¡å¯è§ä¹‹é—´å­˜åœ¨ä¸€ä¸ªæ—¶é—´å·®ï¼Œè¿™æ˜¯ä¸¤é˜¶æ®µæäº¤å¯¼è‡´çš„å§ï¼Œinnodb prepare -&gt; binlog write -&gt; innodb commitï¼Œbinlog æ¯” innodb commit æå‰å®Œæˆï¼Œæ‰€ä»¥è¯´ binlog æ¯”äº‹åŠ¡å¯è§æ—©ä¸€ç‚¹ã€‚","like_count":1,"discussions":[{"author":{"id":3898827,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/7d/cb/fa3dae58.jpg","nickname":"ä¿Šè¾¾","note":"","ucode":"F79BF9651AD086","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":651720,"discussion_content":"å¯¹çš„ã€‚\n\næˆ‘å†æµ‹è¯•äº†ä¸€ä¸‹ï¼ŒBinlogä¸­ï¼ŒInsertäº‹ä»¶è§£æä¸ºreplace intoè¯­å¥ï¼ŒUpdateäº‹ä»¶è§£æä¸ºupdateè¯­å¥ï¼ŒDeleteäº‹ä»¶è§£æä¸ºdeleteè¯­å¥ã€‚\n\nBinlogå¯è§å’Œäº‹åŠ¡å¯è§ä¹‹é—´å­˜åœ¨çš„æ—¶é—´å·®ï¼Œç”±ä¸¤é˜¶æ®µæäº¤å¼•èµ·ã€‚ğŸ‘ğŸ‘\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1727331881,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":394283,"user_name":"Shelly","can_delete":false,"product_type":"c1","uid":2422713,"ip_address":"å¹¿ä¸œ","ucode":"75BA35C2737EA6","user_header":"https://static001.geekbang.org/account/avatar/00/24/f7/b9/f2eec64e.jpg","comment_is_top":false,"comment_ctime":1726317907,"is_pvip":false,"replies":[{"id":143137,"content":"å’Œæˆ‘çš„ç†è§£åŸºæœ¬ä¸€è‡´ã€‚\n\nlock in shared modeæ˜¯ä¸ºäº†ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼Œä½ ä¸¾çš„ä¾‹å­æ˜¯å…¶ä¸­ä¸€ç§æƒ…å†µã€‚\n\næ²¡æœ‰ä½¿ç”¨åŠåŒæ­¥æ—¶ï¼Œä¹Ÿä¼šå­˜åœ¨ç±»ä¼¼çš„æƒ…å†µã€‚Binlogå¯è§å’Œäº‹ç‰©å¯è§ä¹‹é—´å­˜åœ¨ä¸€ä¸ªæ—¶é—´å·®ï¼Œè™½ç„¶ä¸€èˆ¬è¿™ä¸ªæ—¶é—´å·®å¾ˆçŸ­ï¼Œä½†å¦‚æœä¸åŠ lock in shared modeï¼Œç†è®ºä¸Šæœ‰å¯èƒ½ä¼šè¯»å–åˆ°DELETEä¹‹å‰çš„æ•°æ®ï¼Œè¿™æ ·å½±å­è¡¨å¯èƒ½ä¼šå¤šæ•°æ®ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3898827,"ctime":1726557916,"ip_address":"æµ™æ±Ÿ","comment_id":394283,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100799401,"comment_content":"æ€è€ƒé¢˜ï¼š\n\ngh-oståšDDLå˜æ›´æœŸé—´ï¼Œæœ‰ä¸‰ç§æ“ä½œï¼š(1). å¯¹åŸè¡¨çš„copyåˆ°å½±å­è¡¨  (2). åº”ç”¨binlogåˆ°å½±å­è¡¨ (3). ä¸šåŠ¡å¯¹åŸè¡¨çš„DMLæ“ä½œ  \nç”±äºcopyåŸè¡¨æ“ä½œå’Œåº”ç”¨binlogåˆ°å½±å­è¡¨æ˜¯äº¤æ›¿è¿›è¡Œçš„ï¼Œæ‰€ä»¥ï¼š\n1. insert ingore into ...æ“ä½œï¼Œå¦‚æœä¸šåŠ¡å…ˆå¯¹åŸè¡¨è¿›è¡Œäº†ä¸€äº›æ’å…¥æ“ä½œï¼ˆæ³¨æ„æ­¤æ—¶å¯¹åº”çš„è¡Œè¿˜æ²¡æœ‰è¢«copyåˆ°å½±å­è¡¨ï¼‰ï¼Œç„¶ååº”ç”¨binlogåˆ°å½±å­è¡¨ï¼Œè¿™æ—¶copyå¯¹åº”çš„è¡Œåˆ°å½±å­è¡¨ï¼Œå¦‚æœä¸åŠ ingoreå°±ä¼šå¯¼è‡´ä¸»é”®å†²çªé”™è¯¯ \n2. replace into æ“ä½œï¼Œå¦‚æœä¸šåŠ¡å¯¹è¡¨è¿›è¡Œäº†ä¸€äº›æ’å…¥æ“ä½œï¼Œå¯¹åŸè¡¨ç›¸åº”è®°å½•copyåˆ°å½±å­è¡¨ï¼ˆæ­¤æ—¶å¯¹åº”çš„binlogè¿˜æœªè¢«åº”ç”¨ï¼‰ï¼Œåç»­åœ¨åº”ç”¨binlogæ—¶å½±å­è¡¨å·²ç»æœ‰äº†ç›¸åº”è®°å½•ï¼Œæ‰€ä»¥è¦åŠ inplace into è¦†ç›–æ‰copyæ“ä½œçš„ç›¸åº”è®°å½•ï¼Œå¦åˆ™ä¼šå¯¼è‡´ä¸»é”®å†²çªé”™è¯¯\n3. insert ingore into ...æ“ä½œå’Œreplace into æ“ä½œçš„é¡ºåºä¸ä¼šå¯¹æœ€ç»ˆçš„æ•°æ®ä¸€è‡´æ€§æœ‰å½±å“\n4. ä¸ªäººç†è§£æŸ¥è¯¢æ—¶åŠ lock in shared modeåŸå› ï¼šå‡è®¾ä¸€ä¸ªåœºæ™¯ä¸»ä»åŠåŒæ­¥ï¼ˆafter_syncï¼‰ï¼Œæœ‰ä¸ªç”¨æˆ·åœ¨ä¸»åº“å¯¹è¡¨è¿›è¡Œäº†å‡ è¡Œåˆ é™¤æ“ä½œï¼Œæ­¤æ—¶ä»åº“ç”±äºæŸäº›åŸå› æ²¡æœ‰å›å¤ackï¼Œå¦‚æœbinlogå·²ç»è¢«æ•è·ï¼Œåº”ç”¨binlogåˆ°å½±å­è¡¨æ—¶æ“ä½œä¼šè¢«å¿½ç•¥ï¼ˆæ­¤æ—¶ç›¸åº”çš„è®°å½•è¿˜æ²¡æœ‰è¢«copyåˆ°å½±å­è¡¨ï¼‰ï¼Œç„¶åå†copyç›¸åº”åŸè¡¨è®°å½•åˆ°å½±å­è¡¨ï¼ˆç”±äºä¸»åº“æ²¡æœ‰æ”¶åˆ°ä»åº“çš„ackï¼Œæ‰€ä»¥ä¸»åº“æ˜¯å¯ä»¥æŸ¥è¯¢åˆ°è¿™äº›è¢«åˆ é™¤çš„è¡¨ï¼‰ï¼Œäºæ˜¯å®é™…ä¸Šå·²ç»è¢«åˆ é™¤çš„æ•°æ®å´è¢«æ‹·è´åˆ°äº†å½±å­è¡¨ï¼Œå¯¼è‡´åŸè¡¨å’Œå½±å­è¡¨çš„æ•°æ®ä¸ä¸€è‡´ã€‚  å¦‚æœåœ¨copyæ•°æ®æ—¶ï¼ŒæŸ¥è¯¢åŠ ä¸Šlock in shard modeå…±äº«é”ï¼Œå°±ä¼šç­‰å¾…åˆ é™¤çš„äº‹åŠ¡æäº¤åæ‰èƒ½è·å–æ•°æ®ç›¸åº”è¡Œçš„æ•°æ®ï¼Œé˜²æ­¢äº†DDLå˜æ›´å‰åæ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µå‘ç”Ÿã€‚","like_count":1,"discussions":[{"author":{"id":3898827,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/7d/cb/fa3dae58.jpg","nickname":"ä¿Šè¾¾","note":"","ucode":"F79BF9651AD086","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":651218,"discussion_content":"å’Œæˆ‘çš„ç†è§£åŸºæœ¬ä¸€è‡´ã€‚\n\nlock in shared modeæ˜¯ä¸ºäº†ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼Œä½ ä¸¾çš„ä¾‹å­æ˜¯å…¶ä¸­ä¸€ç§æƒ…å†µã€‚\n\næ²¡æœ‰ä½¿ç”¨åŠåŒæ­¥æ—¶ï¼Œä¹Ÿä¼šå­˜åœ¨ç±»ä¼¼çš„æƒ…å†µã€‚Binlogå¯è§å’Œäº‹ç‰©å¯è§ä¹‹é—´å­˜åœ¨ä¸€ä¸ªæ—¶é—´å·®ï¼Œè™½ç„¶ä¸€èˆ¬è¿™ä¸ªæ—¶é—´å·®å¾ˆçŸ­ï¼Œä½†å¦‚æœä¸åŠ lock in shared modeï¼Œç†è®ºä¸Šæœ‰å¯èƒ½ä¼šè¯»å–åˆ°DELETEä¹‹å‰çš„æ•°æ®ï¼Œè¿™æ ·å½±å­è¡¨å¯èƒ½ä¼šå¤šæ•°æ®ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1726557917,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":394279,"user_name":"123","can_delete":false,"product_type":"c1","uid":2662872,"ip_address":"æ–°åŠ å¡","ucode":"5A343B568B9524","user_header":"https://static001.geekbang.org/account/avatar/00/28/a1/d8/42252c48.jpg","comment_is_top":false,"comment_ctime":1726307713,"is_pvip":false,"replies":[{"id":143138,"content":"replace into å’Œ insert ignore intoçš„é¡ºåºåº”è¯¥ä¸å½±å“æœ€ç»ˆçš„ç»“æœã€‚\ninsert ignore intoç”¨æ¥åŒæ­¥å…¨é‡æ•°æ®ï¼Œreplace intoæ˜¯ä»binlogä¸­è§£æå‡ºæ¥çš„insertå’Œupdateäº‹ä»¶ã€‚binlogä¸­çš„deleteäº‹ä»¶åº”è¯¥ä¼šè§£ææˆdeleteè¯­å¥ï¼Œè¿™ä¸€ç‚¹æˆ‘æ–‡ç« é‡Œæ²¡æåˆ°ã€‚\n\nlock in share modeæ˜¯ä¸ºäº†ä¿è¯å½±å­è¡¨æ•°æ®å’ŒåŸè¡¨ä¸€è‡´ã€‚\n\nBinlogå¯è§å’Œäº‹ç‰©å¯è§ä¹‹é—´å­˜åœ¨ä¸€ä¸ªæ—¶é—´å·®ï¼Œè™½ç„¶ä¸€èˆ¬è¿™ä¸ªæ—¶é—´å·®å¾ˆçŸ­ï¼Œä½†å¦‚æœä¸åŠ lock in shared modeï¼Œæºåº“æ‰§è¡Œdeleteè¯­å¥æ—¶ï¼Œbinlogä¸­è¯»åˆ°äº†deleteè¯­å¥ï¼Œä½†selectå¯èƒ½ä¼šè¯»å–åˆ°DELETEä¹‹å‰çš„æ•°æ®ã€‚è¿™æ ·ï¼Œå¦‚æœå…ˆå¯¹å½±å­è¡¨æ‰§è¡Œäº†deleteï¼Œç„¶åå†insert ignore intoæ—¶ï¼Œä¼šæŠŠæœ¬æ¥åº”è¯¥å·²ç»deleteæ‰çš„æ•°æ®ï¼Œæ’å…¥åˆ°å½±å­è¡¨ï¼Œå°±å¤šæ•°æ®äº†ã€‚\n\n","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3898827,"ctime":1726558367,"ip_address":"æµ™æ±Ÿ","comment_id":394279,"utype":1}],"discussion_count":7,"race_medal":0,"score":2,"product_id":100799401,"comment_content":"æ€è€ƒé¢˜ï¼š\n1 - create table likeï¼šåˆ›å»ºä¸´æ—¶è¡¨ï¼Œå¤åˆ¶è¡¨ç»“æ„ï¼›\n2 - alter tableï¼šæ ¹æ®å‘½ä»¤æ›´æ”¹è¡¨è¡¨ç»“æ„ï¼›\n3 - selectï¼šå¹¶å‘è¯»å–æ•°æ®ï¼ˆçœ‹åˆ°äº†åç§»é‡ï¼Œåº”è¯¥æ˜¯å¤šçº¿ç¨‹ï¼‰å†™å…¥ä¸´æ—¶æ–‡ä»¶ï¼Œä½¿ç”¨_binaryåº”è¯¥æ˜¯å¯ä»¥å¿½ç•¥å­—ç¬¦é›†ï¼Œç›´æ¥æ¯”è¾ƒäºŒè¿›åˆ¶æ–‡æœ¬ï¼Œå‡å°‘å¼€é”€æå‡æ€§èƒ½ï¼›\n4 - insert ignore intoï¼šå°†æ•°æ®æ’å…¥åˆ°ä¸´æ—¶è¡¨ä¸­ï¼Œå¿½ç•¥å”¯ä¸€é”®æŠ¥é”™ï¼›\n5 - replace intoï¼šå°†å¢é‡æ•°æ®æ›´æ–°è‡³ä¸´æ—¶è¡¨ä¸­ï¼›\n6 - rename tableï¼šå°†ä¸´æ—¶è¡¨å˜æ›´ä¸ºç”Ÿäº§è¡¨ï¼›\n\ninsert into Â åº”è¯¥æ˜¯åŸè¡¨çš„æ•°æ®ï¼Œreplace into çš„æ˜¯å¢é‡çš„æ•°æ®ï¼Œæ”¹å˜æ‰§è¡Œé¡ºåºï¼Œä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ï¼Œç‰¹åˆ«æ˜¯æ¶‰åŠåˆ é™¤æ“ä½œçš„å†…å®¹ï¼Œå¦‚æœä»…ä»…æ˜¯æ•°æ®çš„æ’å…¥å’Œæ›´æ–°ï¼Œæ›´æ–°æœ¬èº«å°±å¸¦æœ‰å…¨é‡æ•°æ®ï¼Œæ’å…¥åå°±ä»£è¡¨äº†è¯¥è¡Œçš„æœ€æ–°æ•°æ®ï¼Œåç»­çš„insert into ignoreä¹Ÿä¼šå¿½ç•¥ï¼Œè§‰å¾—ä»…ä»…æ˜¯replace into å’Œ insert intoçš„æ›¿æ¢æ„Ÿè§‰ä¹Ÿä¸ä¼šå‡ºé—®é¢˜ï¼Œæœ›è€å¸ˆæŒ‡æ­£\n\næ‰§è¡Œinsertæ—¶éœ€è¦lock in share modeåŠ ä¸Šå…±äº«é”ï¼Œåº”è¯¥æ˜¯é˜²æ­¢è¿›è¡Œæ•°æ®æ›´æ–°ï¼Œä»…ä¾›æŸ¥è¯¢ã€‚","like_count":1,"discussions":[{"author":{"id":3898827,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/7d/cb/fa3dae58.jpg","nickname":"ä¿Šè¾¾","note":"","ucode":"F79BF9651AD086","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":651220,"discussion_content":"replace into å’Œ insert ignore intoçš„é¡ºåºåº”è¯¥ä¸å½±å“æœ€ç»ˆçš„ç»“æœã€‚\ninsert ignore intoç”¨æ¥åŒæ­¥å…¨é‡æ•°æ®ï¼Œreplace intoæ˜¯ä»binlogä¸­è§£æå‡ºæ¥çš„insertå’Œupdateäº‹ä»¶ã€‚binlogä¸­çš„deleteäº‹ä»¶åº”è¯¥ä¼šè§£ææˆdeleteè¯­å¥ï¼Œè¿™ä¸€ç‚¹æˆ‘æ–‡ç« é‡Œæ²¡æåˆ°ã€‚\n\nlock in share modeæ˜¯ä¸ºäº†ä¿è¯å½±å­è¡¨æ•°æ®å’ŒåŸè¡¨ä¸€è‡´ã€‚\n\nBinlogå¯è§å’Œäº‹ç‰©å¯è§ä¹‹é—´å­˜åœ¨ä¸€ä¸ªæ—¶é—´å·®ï¼Œè™½ç„¶ä¸€èˆ¬è¿™ä¸ªæ—¶é—´å·®å¾ˆçŸ­ï¼Œä½†å¦‚æœä¸åŠ lock in shared modeï¼Œæºåº“æ‰§è¡Œdeleteè¯­å¥æ—¶ï¼Œbinlogä¸­è¯»åˆ°äº†deleteè¯­å¥ï¼Œä½†selectå¯èƒ½ä¼šè¯»å–åˆ°DELETEä¹‹å‰çš„æ•°æ®ã€‚è¿™æ ·ï¼Œå¦‚æœå…ˆå¯¹å½±å­è¡¨æ‰§è¡Œäº†deleteï¼Œç„¶åå†insert ignore intoæ—¶ï¼Œä¼šæŠŠæœ¬æ¥åº”è¯¥å·²ç»deleteæ‰çš„æ•°æ®ï¼Œæ’å…¥åˆ°å½±å­è¡¨ï¼Œå°±å¤šæ•°æ®äº†ã€‚\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1726558367,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":6,"child_discussions":[{"author":{"id":2662872,"avatar":"https://static001.geekbang.org/account/avatar/00/28/a1/d8/42252c48.jpg","nickname":"123","note":"","ucode":"5A343B568B9524","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":3898827,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/7d/cb/fa3dae58.jpg","nickname":"ä¿Šè¾¾","note":"","ucode":"F79BF9651AD086","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":651254,"discussion_content":"è€å¸ˆï¼Œå¢é‡æ•°æ®çš„æ‰§è¡Œéš¾é“ä¸æ˜¯åäºæºè¡¨å¤åˆ¶çš„å—ï¼Ÿå¦‚æœæ˜¯selectå…ˆè¡Œï¼Œé‚£ä¹ˆåç»­æäº¤äº‹åŠ¡çš„binlogéƒ½ä¼šè¢«è®°å½•ä¸‹æ¥çš„ï¼Œç„¶åå¾…æºè¡¨å¤åˆ¶å®Œæˆåå†æ‰§è¡Œå¢é‡binlogæ•°æ®","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1726630723,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":651220,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":651254,"extra":""},{"author":{"id":1582134,"avatar":"https://static001.geekbang.org/account/avatar/00/18/24/36/0829cbdc.jpg","nickname":"TheOne","note":"","ucode":"2A359780156A8B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":3898827,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/7d/cb/fa3dae58.jpg","nickname":"ä¿Šè¾¾","note":"","ucode":"F79BF9651AD086","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":651277,"discussion_content":"è€å¸ˆï¼Œbinlogå¯è§å’Œäº‹åŠ¡å¯è§æœ‰æ—¶é—´å·®æ˜¯ä»€ä¹ˆæ„æ€ï¼Œæ²¡å¤ªç†è§£ï¼Œbinlogå†™å®Œï¼Œä¸å°±çº¦ç­‰äºäº‹åŠ¡ç»“æŸäº†å—","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1726668451,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":651220,"ip_address":"åŒ—äº¬","group_id":0},"score":651277,"extra":""},{"author":{"id":3951358,"avatar":"https://static001.geekbang.org/account/avatar/00/3c/4a/fe/7b6bd101.jpg","nickname":"ç¬™ é¸¢","note":"","ucode":"477AF524212C6D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":3898827,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/7d/cb/fa3dae58.jpg","nickname":"ä¿Šè¾¾","note":"","ucode":"F79BF9651AD086","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":651412,"discussion_content":"è€å¸ˆï¼Œè¿™ä¸ªæ—¶é—´å·®èƒ½è¯¦è®²ä¸‹å—ï¼Ÿç°åœ¨å¯¹äºä¸€ä¸ªäº‹åŠ¡çš„æäº¤â€”â€”å†™åˆ°redologâ€”â€”bufferpoolå’Œbinlogæ—¥å¿—çš„å†™å…¥è¿™å—ä¸çŸ¥é“å“ªä¸ªå…ˆåï¼ˆé¡ºåºé—®é¢˜ï¼‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1726826106,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":651220,"ip_address":"ä¸Šæµ·","group_id":0},"score":651412,"extra":""}]}]},{"had_liked":false,"id":396473,"user_name":"æœ¨å‡ ä¸¶","can_delete":false,"product_type":"c1","uid":2420294,"ip_address":"ç¦å»º","ucode":"FFDB958DA64F8C","user_header":"https://static001.geekbang.org/account/avatar/00/24/ee/46/7d65ae37.jpg","comment_is_top":false,"comment_ctime":1734602368,"is_pvip":true,"replies":[{"id":143932,"content":"æ˜¯çš„ã€‚è‡³å°‘åˆ°8.0ç‰ˆæœ¬ä¸ºæ­¢ï¼Œä¿®æ”¹å­—æ®µçš„æ•°æ®ç±»å‹ï¼Œéƒ½ä¸æ”¯æŒOnline DDLã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3898827,"ctime":1734660945,"ip_address":"æµ™æ±Ÿ","comment_id":396473,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100799401,"comment_content":"è€å¸ˆï¼Œè¯·é—®ä¸‹ä¿®æ”¹å­—æ®µæ•°æ®ç±»å‹è¿™äº›æ“ä½œä¸èƒ½ç”¨OnlineDDL?","like_count":0,"discussions":[{"author":{"id":3898827,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/7d/cb/fa3dae58.jpg","nickname":"ä¿Šè¾¾","note":"","ucode":"F79BF9651AD086","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":655348,"discussion_content":"æ˜¯çš„ã€‚è‡³å°‘åˆ°8.0ç‰ˆæœ¬ä¸ºæ­¢ï¼Œä¿®æ”¹å­—æ®µçš„æ•°æ®ç±»å‹ï¼Œéƒ½ä¸æ”¯æŒOnline DDLã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1734660946,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":1,"child_discussions":[{"author":{"id":2420294,"avatar":"https://static001.geekbang.org/account/avatar/00/24/ee/46/7d65ae37.jpg","nickname":"æœ¨å‡ ä¸¶","note":"","ucode":"FFDB958DA64F8C","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":3898827,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/7d/cb/fa3dae58.jpg","nickname":"ä¿Šè¾¾","note":"","ucode":"F79BF9651AD086","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":655366,"discussion_content":"è€å¸ˆä¸å¥½æ„æ€ï¼Œæ¼å­—äº†ï¼Œæˆ‘æƒ³é—®çš„æ˜¯ä¸ºä»€ä¹ˆä¿®æ”¹å­—æ®µç±»å‹ä¸èƒ½ç”¨Online DDLï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1734689977,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":655348,"ip_address":"ç¦å»º","group_id":0},"score":655366,"extra":""}]}]},{"had_liked":false,"id":394603,"user_name":"é™ˆæ˜Ÿå®‡(2.11)","can_delete":false,"product_type":"c1","uid":1450562,"ip_address":"å››å·","ucode":"970E48260B7924","user_header":"https://static001.geekbang.org/account/avatar/00/16/22/42/11674804.jpg","comment_is_top":false,"comment_ctime":1727276469,"is_pvip":false,"replies":[{"id":143232,"content":"Online DDL MySQL 5.6å°±æœ‰çš„ï¼ŒåŒ…æ‹¬å‚æ•°innodb_online_alter_log_max_sizeã€‚\n\nmysql&gt; select @@version, @@innodb_online_alter_log_max_size\\G\n*************************** 1. row ***************************\n                         @@version: 5.6.51-log\n@@innodb_online_alter_log_max_size: 134217728","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3898827,"ctime":1727332251,"ip_address":"æµ™æ±Ÿ","comment_id":394603,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100799401,"comment_content":"è€å¸ˆï¼Œè¿™äº›éƒ½æ˜¯8.0æ‰æœ‰çš„å§ï¼Ÿinnodb_online_alter_log_max_size","like_count":0,"discussions":[{"author":{"id":3898827,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/7d/cb/fa3dae58.jpg","nickname":"ä¿Šè¾¾","note":"","ucode":"F79BF9651AD086","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":651721,"discussion_content":"Online DDL MySQL 5.6å°±æœ‰çš„ï¼ŒåŒ…æ‹¬å‚æ•°innodb_online_alter_log_max_sizeã€‚\n\nmysql&gt; select @@version, @@innodb_online_alter_log_max_size\\G\n*************************** 1. row ***************************\n                         @@version: 5.6.51-log\n@@innodb_online_alter_log_max_size: 134217728","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1727332251,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":394232,"user_name":"binzhang","can_delete":false,"product_type":"c1","uid":1647189,"ip_address":"ç¾å›½","ucode":"F2670F2EA24FAD","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q3auHgzwzM59PTNiaDASVicbVaeWBU1WKmOgyHcqVtl85nDwAqDicib1EUKE2RRoU0x0vZctZO4kbPDUTTke8qKfAw/132","comment_is_top":false,"comment_ctime":1726191735,"is_pvip":false,"replies":[{"id":143098,"content":"æ˜¯çš„ï¼Œinplace DDLå³ä½¿è¦é‡å»ºè¡¨ï¼Œä¹Ÿæ˜¯åœ¨å­˜å‚¨å¼•æ“å†…éƒ¨å®Œæˆçš„ï¼Œå› æ­¤rows affectedæ€»æ˜¯0ã€‚\n\nCOPYæ¨¡å¼æ˜¯åœ¨Serverå±‚å¤åˆ¶æ•°æ®çš„ï¼Œç›¸å½“äºselect + insertï¼Œrows affectedä¼šæ˜¾ç¤ºä¸ºå®é™…å¤„ç†çš„è®°å½•æ•°ï¼Œä¹Ÿå°±æ˜¯è¡¨é‡Œçš„è®°å½•æ•°ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3898827,"ctime":1726208364,"ip_address":"æµ™æ±Ÿ","comment_id":394232,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100799401,"comment_content":"ä¸ºå•¥æœ‰äº›inplaceçš„ddlä¹Ÿæ˜¾ç¤ºrows affectedæ˜¯0ï¼Ÿ åªæœ‰copyæ¨¡å¼ä¼šæ˜¾ç¤ºé0 çš„rows affectedå—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":3898827,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/7d/cb/fa3dae58.jpg","nickname":"ä¿Šè¾¾","note":"","ucode":"F79BF9651AD086","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":651088,"discussion_content":"æ˜¯çš„ï¼Œinplace DDLå³ä½¿è¦é‡å»ºè¡¨ï¼Œä¹Ÿæ˜¯åœ¨å­˜å‚¨å¼•æ“å†…éƒ¨å®Œæˆçš„ï¼Œå› æ­¤rows affectedæ€»æ˜¯0ã€‚\n\nCOPYæ¨¡å¼æ˜¯åœ¨Serverå±‚å¤åˆ¶æ•°æ®çš„ï¼Œç›¸å½“äºselect + insertï¼Œrows affectedä¼šæ˜¾ç¤ºä¸ºå®é™…å¤„ç†çš„è®°å½•æ•°ï¼Œä¹Ÿå°±æ˜¯è¡¨é‡Œçš„è®°å½•æ•°ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1726208364,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]}]}