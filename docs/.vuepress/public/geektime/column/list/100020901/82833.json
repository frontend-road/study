{"id":82833,"title":"40 | 案例篇：网络请求延迟变大了，我该怎么办？","content":"<p>你好，我是倪朋飞。</p><p>上一节，我们学习了碰到分布式拒绝服务（DDoS）的缓解方法。简单回顾一下，DDoS 利用大量的伪造请求，导致目标服务要耗费大量资源，来处理这些无效请求，进而无法正常响应正常用户的请求。</p><p>由于 DDoS 的分布式、大流量、难追踪等特点，目前确实还没有方法，能够完全防御 DDoS 带来的问题，我们只能设法缓解 DDoS 带来的影响。</p><p>比如，你可以购买专业的流量清洗设备和网络防火墙，在网络入口处阻断恶意流量，只保留正常流量进入数据中心的服务器。</p><p>在 Linux 服务器中，你可以通过内核调优、DPDK、XDP 等多种方法，增大服务器的抗攻击能力，降低 DDoS 对正常服务的影响。而在应用程序中，你可以利用各级缓存、 WAF、CDN 等方式，缓解 DDoS 对应用程序的影响。</p><p>不过要注意，如果 DDoS 的流量，已经到了 Linux 服务器中，那么，即使应用层做了各种优化，网络服务的延迟一般还是会比正常情况大很多。</p><p>所以，在实际应用中，我们通常要让 Linux 服务器，配合专业的流量清洗以及网络防火墙设备，一起来缓解这一问题。</p><p>除了 DDoS 会带来网络延迟增大外，我想，你肯定见到过不少其他原因导致的网络延迟，比如</p><ul>\n<li>\n<p>网络传输慢，导致延迟；</p>\n</li>\n<li>\n<p>Linux 内核协议栈报文处理慢，导致延迟；</p>\n</li>\n<li>\n<p>应用程序数据处理慢，导致延迟等等。</p>\n</li>\n</ul><!-- [[[read_end]]] --><p>那么，当碰到这些原因的延迟时，我们该怎么办呢？又该如何定位网络延迟的根源呢？今天，我就通过一个案例，带你一起看看这些问题。</p><h2>网络延迟</h2><p>我相信，提到<strong>网络延迟</strong>时，你可能轻松想起它的含义——网络数据传输所用的时间。不过要注意，这个时间可能是单向的，指从源地址发送到目的地址的单程时间；也可能是双向的，即从源地址发送到目的地址，然后又从目的地址发回响应，这个往返全程所用的时间。</p><p>通常，我们更常用的是双向的往返通信延迟，比如 ping 测试的结果，就是往返延时 RTT（Round-Trip Time）。</p><p>除了网络延迟外，另一个常用的指标是<strong>应用程序延迟</strong>，它是指，从应用程序接收到请求，再到发回响应，全程所用的时间。通常，应用程序延迟也指的是往返延迟，是网络数据传输时间加上数据处理时间的和。</p><p>在 <a href=\"https://time.geekbang.org/column/article/81057\">Linux 网络基础篇</a> 中，我曾经介绍到，你可以用 ping 来测试网络延迟。ping 基于 ICMP 协议，它通过计算 ICMP 回显响应报文与 ICMP 回显请求报文的时间差，来获得往返延时。这个过程并不需要特殊认证，常被很多网络攻击利用，比如端口扫描工具 nmap、组包工具 hping3 等等。</p><p>所以，为了避免这些问题，很多网络服务会把 ICMP 禁止掉，这也就导致我们无法用 ping ，来测试网络服务的可用性和往返延时。这时，你可以用 traceroute 或 hping3 的 TCP 和 UDP 模式，来获取网络延迟。</p><p>比如，以 baidu.com 为例，你可以执行下面的 hping3 命令，测试你的机器到百度搜索服务器的网络延迟：</p><pre><code># -c表示发送3次请求，-S表示设置TCP SYN，-p表示端口号为80\n$ hping3 -c 3 -S -p 80 baidu.com\nHPING baidu.com (eth0 123.125.115.110): S set, 40 headers + 0 data bytes\nlen=46 ip=123.125.115.110 ttl=51 id=47908 sport=80 flags=SA seq=0 win=8192 rtt=20.9 ms\nlen=46 ip=123.125.115.110 ttl=51 id=6788  sport=80 flags=SA seq=1 win=8192 rtt=20.9 ms\nlen=46 ip=123.125.115.110 ttl=51 id=37699 sport=80 flags=SA seq=2 win=8192 rtt=20.9 ms\n\n--- baidu.com hping statistic ---\n3 packets transmitted, 3 packets received, 0% packet loss\nround-trip min/avg/max = 20.9/20.9/20.9 ms\n</code></pre><p>从 hping3 的结果中，你可以看到，往返延迟 RTT 为 20.9ms。</p><p>当然，我们用 traceroute ，也可以得到类似结果：</p><pre><code># --tcp表示使用TCP协议，-p表示端口号，-n表示不对结果中的IP地址执行反向域名解析\n$ traceroute --tcp -p 80 -n baidu.com\ntraceroute to baidu.com (123.125.115.110), 30 hops max, 60 byte packets\n 1  * * *\n 2  * * *\n 3  * * *\n 4  * * *\n 5  * * *\n 6  * * *\n 7  * * *\n 8  * * *\n 9  * * *\n10  * * *\n11  * * *\n12  * * *\n13  * * *\n14  123.125.115.110  20.684 ms *  20.798 ms\n</code></pre><p>traceroute 会在路由的每一跳发送三个包，并在收到响应后，输出往返延时。如果无响应或者响应超时（默认5s），就会输出一个星号。</p><p>知道了基于 TCP 测试网络服务延迟的方法后，接下来，我们就通过一个案例，来学习网络延迟升高时的分析思路。</p><h2>案例准备</h2><p>下面的案例仍然基于 Ubuntu 18.04，同样适用于其他的 Linux 系统。我使用的案例环境是这样的：</p><ul>\n<li>\n<p>机器配置：2 CPU，8GB 内存。</p>\n</li>\n<li>\n<p>预先安装 docker、hping3、tcpdump、curl、wrk、Wireshark 等工具，比如 apt-get install docker.io hping3 tcpdump curl。</p>\n</li>\n</ul><p>这里的工具你应该都比较熟悉了，其中 wrk 的安装和使用方法在 <a href=\"https://time.geekbang.org/column/article/81497\">怎么评估系统的网络性能</a> 中曾经介绍过。如果你还没有安装，请执行下面的命令来安装它：</p><pre><code>$ https://github.com/wg/wrk\n$ cd wrk\n$ apt-get install build-essential -y\n$ make\n$ sudo cp wrk /usr/local/bin/\n</code></pre><p>由于Wireshark 需要图形界面，如果你的虚拟机没有图形界面，就可以把 Wireshark 安装到其他的机器中（比如 Windows 笔记本）。</p><p>本次案例用到两台虚拟机，我画了一张图来表示它们的关系。</p><p><img src=\"https://static001.geekbang.org/resource/image/55/63/55347dc1ec78688da5673f29b60aa863.png?wh=816*516\" alt=\"\"></p><p>接下来，我们打开两个终端，分别 SSH 登录到两台机器上（以下步骤，假设终端编号与图示VM 编号一致），并安装上面提到的这些工具。注意， curl 和 wrk 只需要安装在客户端 VM（即 VM2）中。</p><p>同以前的案例一样，下面的所有命令都默认以 root 用户运行，如果你是用普通用户身份登陆系统，请运行 sudo su root 命令切换到 root 用户。</p><blockquote>\n<p>如果安装过程中有什么问题，同样鼓励你先自己搜索解决，解决不了的，可以在留言区向我提问。如果你以前已经安装过了，就可以忽略这一点了。</p>\n</blockquote><p>接下来，我们就进入到案例操作的环节。</p><h2>案例分析</h2><p>为了对比得出延迟增大的影响，首先，我们来运行一个最简单的 Nginx，也就是用官方的 Nginx 镜像启动一个容器。在终端一中，执行下面的命令，运行官方 Nginx，它会在 80 端口监听：</p><pre><code>$ docker run --network=host --name=good -itd nginx\nfb4ed7cb9177d10e270f8320a7fb64717eac3451114c9fab3c50e02be2e88ba2\n</code></pre><p>继续在终端一中，执行下面的命令，运行案例应用，它会监听 8080 端口：</p><pre><code>$ docker run --name nginx --network=host -itd feisky/nginx:latency\nb99bd136dcfd907747d9c803fdc0255e578bad6d66f4e9c32b826d75b6812724\n</code></pre><p>然后，在终端二中执行 curl 命令，验证两个容器已经正常启动。如果一切正常，你将看到如下的输出：</p><pre><code># 80端口正常\n$ curl http://192.168.0.30\n&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n...\n&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n\n# 8080端口正常\n$ curl http://192.168.0.30:8080\n...\n&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre><p>接着，我们再用上面提到的 hping3 ，来测试它们的延迟，看看有什么区别。还是在终端二，执行下面的命令，分别测试案例机器 80 端口和 8080 端口的延迟：</p><pre><code># 测试80端口延迟\n$ hping3 -c 3 -S -p 80 192.168.0.30\nHPING 192.168.0.30 (eth0 192.168.0.30): S set, 40 headers + 0 data bytes\nlen=44 ip=192.168.0.30 ttl=64 DF id=0 sport=80 flags=SA seq=0 win=29200 rtt=7.8 ms\nlen=44 ip=192.168.0.30 ttl=64 DF id=0 sport=80 flags=SA seq=1 win=29200 rtt=7.7 ms\nlen=44 ip=192.168.0.30 ttl=64 DF id=0 sport=80 flags=SA seq=2 win=29200 rtt=7.6 ms\n\n--- 192.168.0.30 hping statistic ---\n3 packets transmitted, 3 packets received, 0% packet loss\nround-trip min/avg/max = 7.6/7.7/7.8 ms\n</code></pre><pre><code># 测试8080端口延迟\n$ hping3 -c 3 -S -p 8080 192.168.0.30\nHPING 192.168.0.30 (eth0 192.168.0.30): S set, 40 headers + 0 data bytes\nlen=44 ip=192.168.0.30 ttl=64 DF id=0 sport=8080 flags=SA seq=0 win=29200 rtt=7.7 ms\nlen=44 ip=192.168.0.30 ttl=64 DF id=0 sport=8080 flags=SA seq=1 win=29200 rtt=7.6 ms\nlen=44 ip=192.168.0.30 ttl=64 DF id=0 sport=8080 flags=SA seq=2 win=29200 rtt=7.3 ms\n\n--- 192.168.0.30 hping statistic ---\n3 packets transmitted, 3 packets received, 0% packet loss\nround-trip min/avg/max = 7.3/7.6/7.7 ms\n</code></pre><p>从这个输出你可以看到，两个端口的延迟差不多，都是 7ms。不过，这只是单个请求的情况。换成并发请求的话，又会怎么样呢？接下来，我们就用 wrk 试试。</p><p>这次在终端二中，执行下面的新命令，分别测试案例机器并发 100 时， 80 端口和 8080 端口的性能：</p><pre><code># 测试80端口性能\n$ # wrk --latency -c 100 -t 2 --timeout 2 http://192.168.0.30/\nRunning 10s test @ http://192.168.0.30/\n  2 threads and 100 connections\n  Thread Stats   Avg      Stdev     Max   +/- Stdev\n    Latency     9.19ms   12.32ms 319.61ms   97.80%\n    Req/Sec     6.20k   426.80     8.25k    85.50%\n  Latency Distribution\n     50%    7.78ms\n     75%    8.22ms\n     90%    9.14ms\n     99%   50.53ms\n  123558 requests in 10.01s, 100.15MB read\nRequests/sec:  12340.91\nTransfer/sec:     10.00MB\n</code></pre><pre><code># 测试8080端口性能\n$ wrk --latency -c 100 -t 2 --timeout 2 http://192.168.0.30:8080/\nRunning 10s test @ http://192.168.0.30:8080/\n  2 threads and 100 connections\n  Thread Stats   Avg      Stdev     Max   +/- Stdev\n    Latency    43.60ms    6.41ms  56.58ms   97.06%\n    Req/Sec     1.15k   120.29     1.92k    88.50%\n  Latency Distribution\n     50%   44.02ms\n     75%   44.33ms\n     90%   47.62ms\n     99%   48.88ms\n  22853 requests in 10.01s, 18.55MB read\nRequests/sec:   2283.31\nTransfer/sec:      1.85MB\n</code></pre><p>从上面两个输出可以看到，官方Nginx（监听在80端口）的平均延迟是 9.19ms，而案例 Nginx 的平均延迟（监听在 8080 端口）则是 43.6ms。从延迟的分布上来看，官方 Nginx 90% 的请求，都可以在 9ms以内完成；而案例 Nginx 50% 的请求，就已经达到了 44 ms。</p><p>再结合上面 hping3 的输出，我们很容易发现，案例 Nginx 在并发请求下的延迟增大了很多，这是怎么回事呢？</p><p>分析方法我想你已经想到了，上节课学过的，使用 tcpdump 抓取收发的网络包，分析网络的收发过程有没有问题。</p><p>接下来，我们在终端一中，执行下面的 tcpdump 命令，抓取 8080 端口上收发的网络包，并保存到 nginx.pcap 文件：</p><pre><code>$ tcpdump -nn tcp port 8080 -w nginx.pcap\n</code></pre><p>然后切换到终端二中，重新执行 wrk 命令：</p><pre><code># 测试8080端口性能\n$ wrk --latency -c 100 -t 2 --timeout 2 http://192.168.0.30:8080/\n</code></pre><p>当 wrk 命令结束后，再次切换回终端一，并按下 Ctrl+C 结束 tcpdump 命令。然后，再把抓取到的 nginx.pcap ，复制到装有 Wireshark 的机器中（如果 VM1 已经带有图形界面，那么可以跳过复制步骤），并用 Wireshark 打开它。</p><p>由于网络包的数量比较多，我们可以先过滤一下。比如，在选择一个包后，你可以单击右键并选择 “Follow” -&gt; “TCP Stream”，如下图所示：</p><p><img src=\"https://static001.geekbang.org/resource/image/45/98/4590d2477d54bf9aa3d2881ff3296498.png?wh=453*372\" alt=\"\"></p><p>然后，关闭弹出来的对话框，回到 Wireshark 主窗口。这时候，你会发现 Wireshark 已经自动帮你设置了一个过滤表达式 tcp.stream eq 24。如下图所示（图中省去了源和目的IP地址）：</p><p><img src=\"https://static001.geekbang.org/resource/image/f9/6e/f9fa457f95276ae4904a91619501376e.png?wh=761*295\" alt=\"\"></p><p>从这里，你可以看到这个 TCP 连接从三次握手开始的每个请求和响应情况。当然，这可能还不够直观，你可以继续点击菜单栏里的 Statics -&gt; Flow Graph，选中 “Limit to display filter” 并设置 Flow type 为 “TCP Flows”：</p><p><img src=\"https://static001.geekbang.org/resource/image/ff/cc/ff498170eb58abcdd841709fb4c036cc.png?wh=722*471\" alt=\"\"></p><p>注意，这个图的左边是客户端，而右边是 Nginx 服务器。通过这个图就可以看出，前面三次握手，以及第一次 HTTP 请求和响应还是挺快的，但第二次 HTTP 请求就比较慢了，特别是客户端在收到服务器第一个分组后，40ms 后才发出了 ACK 响应（图中蓝色行）。</p><p>看到 40ms 这个值，你有没有想起什么东西呢？实际上，这是 TCP 延迟确认（Delayed ACK）的最小超时时间。</p><p>这里我解释一下延迟确认。这是针对 TCP ACK 的一种优化机制，也就是说，不用每次请求都发送一个 ACK，而是先等一会儿（比如 40ms），看看有没有“顺风车”。如果这段时间内，正好有其他包需要发送，那就捎带着 ACK 一起发送过去。当然，如果一直等不到其他包，那就超时后单独发送 ACK。</p><p>因为案例中 40ms 发生在客户端上，我们有理由怀疑，是客户端开启了延迟确认机制。而这儿的客户端，实际上就是前面运行的 wrk。</p><p>查询 TCP 文档（执行 man tcp），你就会发现，只有 TCP 套接字专门设置了 TCP_QUICKACK ，才会开启快速确认模式；否则，默认情况下，采用的就是延迟确认机制：</p><pre><code>TCP_QUICKACK (since Linux 2.4.4)\n              Enable  quickack mode if set or disable quickack mode if cleared.  In quickack mode, acks are sent imme‐\n              diately, rather than delayed if needed in accordance to normal TCP operation.  This flag is  not  perma‐\n              nent,  it only enables a switch to or from quickack mode.  Subsequent operation of the TCP protocol will\n              once again enter/leave quickack mode depending on internal  protocol  processing  and  factors  such  as\n              delayed ack timeouts occurring and data transfer.  This option should not be used in code intended to be\n              portable.\n</code></pre><p>为了验证我们的猜想，确认 wrk 的行为，我们可以用 strace ，来观察 wrk 为套接字设置了哪些 TCP 选项。</p><p>比如，你可以切换到终端二中，执行下面的命令：</p><pre><code>$ strace -f wrk --latency -c 100 -t 2 --timeout 2 http://192.168.0.30:8080/\n...\nsetsockopt(52, SOL_TCP, TCP_NODELAY, [1], 4) = 0\n...\n</code></pre><p>这样，你可以看到，wrk 只设置了 TCP_NODELAY 选项，而没有设置 TCP_QUICKACK。这说明 wrk 采用的正是延迟确认，也就解释了上面这个40ms 的问题。</p><p>不过，别忘了，这只是客户端的行为，按理来说，Nginx 服务器不应该受到这个行为的影响。那是不是我们分析网络包时，漏掉了什么线索呢？让我们回到 Wireshark 重新观察一下。</p><p><img src=\"https://static001.geekbang.org/resource/image/72/8a/72eb14e8996147a458aa6523110c938a.png?wh=750*268\" alt=\"\"></p><p>仔细观察 Wireshark 的界面，其中， 1173 号包，就是刚才说到的延迟 ACK 包；下一行的 1175 ，则是 Nginx 发送的第二个分组包，它跟 697 号包组合起来，构成一个完整的 HTTP 响应（ACK 号都是 85）。</p><p>第二个分组没跟前一个分组（697 号）一起发送，而是等到客户端对第一个分组的 ACK 后（1173 号）才发送，这看起来跟延迟确认有点像，只不过，这儿不再是 ACK，而是发送数据。</p><p>看到这里，我估计你想起了一个东西—— Nagle 算法（纳格算法）。进一步分析案例前，我先简单介绍一下这个算法。</p><p>Nagle 算法，是 TCP 协议中用于减少小包发送数量的一种优化算法，目的是为了提高实际带宽的利用率。</p><p>举个例子，当有效负载只有 1 字节时，再加上 TCP 头部和 IP 头部分别占用的 20 字节，整个网络包就是 41 字节，这样实际带宽的利用率只有 2.4%（1/41）。往大了说，如果整个网络带宽都被这种小包占满，那整个网络的有效利用率就太低了。</p><p>Nagle 算法正是为了解决这个问题。它通过合并 TCP 小包，提高网络带宽的利用率。Nagle 算法规定，一个 TCP 连接上，最多只能有一个未被确认的未完成分组；在收到这个分组的 ACK 前，不发送其他分组。这些小分组会被组合起来，并在收到 ACK 后，用同一个分组发送出去。</p><p>显然，Nagle 算法本身的想法还是挺好的，但是知道 Linux 默认的延迟确认机制后，你应该就不这么想了。因为它们一起使用时，网络延迟会明显。如下图所示：</p><p><img src=\"https://static001.geekbang.org/resource/image/c5/c6/c51439692921cbf67b746a45fded2ec6.png?wh=672*934\" alt=\"\"></p><ul>\n<li>\n<p>当 Sever 发送了第一个分组后，由于 Client 开启了延迟确认，就需要等待 40ms 后才会回复 ACK。</p>\n</li>\n<li>\n<p>同时，由于 Server 端开启了 Nagle，而这时还没收到第一个分组的 ACK，Server 也会在这里一直等着。</p>\n</li>\n<li>\n<p>直到 40ms 超时后，Client 才会回复ACK，然后，Server 才会继续发送第二个分组。</p>\n</li>\n</ul><p>既然可能是 Nagle 的问题，那该怎么知道，案例 Nginx 有没有开启 Nagle 呢？</p><p>查询 tcp 的文档，你就会知道，只有设置了 TCP_NODELAY 后，Nagle 算法才会禁用。所以，我们只需要查看 Nginx 的 tcp_nodelay 选项就可以了。</p><pre><code>TCP_NODELAY\n              If set, disable the Nagle algorithm.  This means that segments are always sent as soon as possible, even\n              if there is only a small amount of data.  When not set, data is buffered until  there  is  a  sufficient\n              amount  to  send out, thereby avoiding the frequent sending of small packets, which results in poor uti‐\n              lization of the network.  This option is overridden by TCP_CORK; however, setting this option forces  an\n              explicit flush of pending output, even if TCP_CORK is currently set.\n</code></pre><p>我们回到终端一中，执行下面的命令，查看案例 Nginx 的配置:</p><pre><code>$ docker exec nginx cat /etc/nginx/nginx.conf | grep tcp_nodelay\n    tcp_nodelay    off;\n</code></pre><p>果然，你可以看到，案例 Nginx 的 tcp_nodelay 是关闭的，将其设置为 on ，应该就可以解决了。</p><p>改完后，问题是否就解决了呢？自然需要验证我们一下。修改后的应用，我已经打包到了Docker 镜像中，在终端一中执行下面的命令，你就可以启动它：</p><pre><code># 删除案例应用\n$ docker rm -f nginx\n\n# 启动优化后的应用\n$ docker run --name nginx --network=host -itd feisky/nginx:nodelay\n</code></pre><p>接着，切换到终端二，重新执行 wrk 测试延迟：</p><pre><code>$ wrk --latency -c 100 -t 2 --timeout 2 http://192.168.0.30:8080/\nRunning 10s test @ http://192.168.0.30:8080/\n  2 threads and 100 connections\n  Thread Stats   Avg      Stdev     Max   +/- Stdev\n    Latency     9.58ms   14.98ms 350.08ms   97.91%\n    Req/Sec     6.22k   282.13     6.93k    68.50%\n  Latency Distribution\n     50%    7.78ms\n     75%    8.20ms\n     90%    9.02ms\n     99%   73.14ms\n  123990 requests in 10.01s, 100.50MB read\nRequests/sec:  12384.04\nTransfer/sec:     10.04MB\n</code></pre><p>果然，现在延迟已经缩短成了 9ms，跟我们测试的官方 Nginx 镜像是一样的（Nginx 默认就是开启 tcp_nodelay 的） 。</p><p>作为对比，我们用 tcpdump ，抓取优化后的网络包（这儿实际上抓取的是官方 Nginx 监听的 80 端口）。你可以得到下面的结果：</p><p><img src=\"https://static001.geekbang.org/resource/image/b5/ba/b5f1643cdca33f29408881542fca4eba.png?wh=1599*621\" alt=\"\"></p><p>从图中你可以发现，由于 Nginx 不用再等 ACK，536 和 540 两个分组是连续发送的；而客户端呢，虽然仍开启了延迟确认，但这时收到了两个需要回复 ACK 的包，所以也不用等 40ms，可以直接合并回复 ACK。</p><p>案例最后，不要忘记停止这两个容器应用。在终端一中，执行下面的命令，就可以删除案例应用：</p><pre><code>$ docker rm -f nginx good\n</code></pre><h2>小结</h2><p>今天，我们学习了网络延迟增大后的分析方法。网络延迟，是最核心的网络性能指标。由于网络传输、网络包处理等各种因素的影响，网络延迟不可避免。但过大的网络延迟，会直接影响用户的体验。</p><p>所以，在发现网络延迟增大后，你可以用 traceroute、hping3、tcpdump、Wireshark、strace 等多种工具，来定位网络中的潜在问题。比如，</p><ul>\n<li>\n<p>使用 hping3 以及 wrk 等工具，确认单次请求和并发请求情况的网络延迟是否正常。</p>\n</li>\n<li>\n<p>使用 traceroute，确认路由是否正确，并查看路由中每一跳网关的延迟。</p>\n</li>\n<li>\n<p>使用 tcpdump 和 Wireshark，确认网络包的收发是否正常。</p>\n</li>\n<li>\n<p>使用 strace 等，观察应用程序对网络套接字的调用情况是否正常。</p>\n</li>\n</ul><p>这样，你就可以依次从路由、网络包的收发、再到应用程序等，逐层排查，直到定位问题根源。</p><h2>思考</h2><p>最后，我想邀请你一起来聊聊，你所理解的网络延迟，以及在发现网络延迟增大时，你又是怎么分析的呢？你可以结合今天的内容，和你自己的操作记录，来总结思路。</p><p>欢迎在留言区和我讨论，也欢迎把这篇文章分享给你的同事、朋友。我们一起在实战中演练，在交流中进步。</p><p></p>","neighbors":{"left":{"article_title":"39 | 案例篇：怎么缓解 DDoS 攻击带来的性能下降问题？","id":82573},"right":{"article_title":"41 | 案例篇：如何优化 NAT 性能？（上）","id":83189}},"comments":[{"had_liked":false,"id":72517,"user_name":"Christmas","can_delete":false,"product_type":"c1","uid":1219172,"ip_address":"","ucode":"F48F6BE4A7595B","user_header":"https://static001.geekbang.org/account/avatar/00/12/9a/64/ad837224.jpg","comment_is_top":false,"comment_ctime":1551663321,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"70271140057","product_id":100020901,"comment_content":"以前经常看到tcp no delay的socket设置，一直不求甚解，这次终于懂了，nagle算法","like_count":17},{"had_liked":false,"id":69584,"user_name":"我来也","can_delete":false,"product_type":"c1","uid":1205253,"ip_address":"","ucode":"773D6104F56767","user_header":"https://static001.geekbang.org/account/avatar/00/12/64/05/6989dce6.jpg","comment_is_top":false,"comment_ctime":1550794500,"is_pvip":false,"replies":[{"id":"25327","content":"😊谢谢分享你的经验","user_name":"作者回复","comment_id":69584,"uid":"1001282","ip_address":"","utype":1,"ctime":1551193165,"user_name_real":"倪朋飞"}],"discussion_count":1,"race_medal":0,"score":"65975303940","product_id":100020901,"comment_content":"[D40打卡]<br>我之前理解的网络延迟分三部分：客户端到服务端，服务端逻辑处理，服务端到客户端到耗时。<br><br>其中服务端逻辑处理的耗时是跟自身程序有关的，另外两个耗时跟宽带服务提供商有关，想更短的耗时就得加钱：选更优的线路或者在靠近客户端的地方加入口。<br><br>目前我们线上程序是可以推算出单次响应的时间的，因为在出入口的地方有记录。不管中间经过了多少服务的处理，都可以算出总的耗时。<br><br>我们在客户端中也加了汇报功能，在客户端的某些消息中会汇报 客户端实际发送请求-&gt;收到服务端响应 的时间差。这样便于我们确认客户端的网络状况。<br><br>从本文中，第一次见到了 Nagle 算法。也知道了服务端关闭icmp时怎么用tcp&#47;udp测试网络延迟。<br><br>文中的内容也是跌宕起伏，分析着怎么还是客户端的问题，客户端访问另外一个服务还是好的。原来是服务端程序也有问题，一个巴掌拍不响。😂<br>","like_count":16,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440176,"discussion_content":"😊谢谢分享你的经验","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551193165,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":77770,"user_name":"青石","can_delete":false,"product_type":"c1","uid":1215531,"ip_address":"","ucode":"B0056AD6453322","user_header":"https://static001.geekbang.org/account/avatar/00/12/8c/2b/3ab96998.jpg","comment_is_top":false,"comment_ctime":1552996263,"is_pvip":false,"replies":[{"id":"29610","content":"嗯","user_name":"作者回复","comment_id":77770,"uid":"1001282","ip_address":"","utype":1,"ctime":1554018905,"user_name_real":"倪朋飞"}],"discussion_count":1,"race_medal":0,"score":"31617767335","product_id":100020901,"comment_content":"网上查了Nagle算法的定义：任意时刻，最多只能有一个未被确认的小段。所谓“小段”，指的是小于MSS尺寸的数据块，所谓“未被确认”，是指一个数据块发送出去后，没有收到对方发送的ACK确认该数据已收到。<br><br>对比80端口和8080端口的报文，80端口的报文中，响应消息再发送完header后立刻发送body部分；8080端口的报文，响应消息再发送完header后，需要获得ACK响应后，才会发送body部分。<br><br>8080端口报文中server端在获得到ACK响应后才发送body部分，就是因为Nagle算法必须确认这个数据块被收到的原因。client在40ms后发送ACK是因为客户端没有开启TCP_QUICKACK的缘故。<br><br>请问老师，这样理解，对吗？","like_count":8,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":443843,"discussion_content":"嗯","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1554018905,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":143099,"user_name":"微微","can_delete":false,"product_type":"c1","uid":1617044,"ip_address":"","ucode":"2C3C934AD8CF7B","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/MibOYDxw9TDxwBuTyI79AoHlJGeUFiabGtUmdeiaMrjxFy3FXmNFTIAVxrESMojrReIDbhOib4os01uBZdbMBZGCVg/132","comment_is_top":false,"comment_ctime":1571629741,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"23046466221","product_id":100020901,"comment_content":"遇到一个问题，backlog设置的很大，有22w，但是用ss -ltn命令查看这个监听端口的Send-Q和Recv-Q都是0，但是用命令netstat -s|egrep &quot;listen|LISTEN&quot;的溢出值一直在上升，统计这个端口的连接数还不到5000，请问可能会是什么原因？","like_count":5,"discussions":[{"author":{"id":1101226,"avatar":"https://static001.geekbang.org/account/avatar/00/10/cd/aa/33d48789.jpg","nickname":"卫江","note":"","ucode":"DE2F7A6916F1A9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":141545,"discussion_content":"溢出值在升高，说明全连接队列满了，而全连接队列的长度是由backlog与somaxconn决定的，为min(backlog, somaxconn)。可以通过 cat /proc/sys/net/core/somaxconn 查看参数。","likes_number":11,"is_delete":false,"is_hidden":false,"ctime":1579430136,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1000439,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/43/f7/abb7bfe3.jpg","nickname":"刘冲","note":"","ucode":"0C4F66921AE76C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":69611,"discussion_content":"解决了么，我也遇到了这个问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1575295214,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":98282,"user_name":"大坏狐狸","can_delete":false,"product_type":"c1","uid":1325678,"ip_address":"","ucode":"5044F89A505C5B","user_header":"https://static001.geekbang.org/account/avatar/00/14/3a/6e/e39e90ca.jpg","comment_is_top":false,"comment_ctime":1558948066,"is_pvip":false,"replies":[{"id":"35923","content":"👍 谢谢分享","user_name":"作者回复","comment_id":98282,"uid":"1001282","ip_address":"","utype":1,"ctime":1559429172,"user_name_real":"倪朋飞"}],"discussion_count":1,"race_medal":0,"score":"18738817250","product_id":100020901,"comment_content":"额 第二次居然curl不通了。。18.04 的防火墙是ufw ,需要ufw allow 80&#47;tcp<br>","like_count":5,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":451630,"discussion_content":"👍 谢谢分享","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1559429172,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":71418,"user_name":"楚","can_delete":false,"product_type":"c1","uid":1154723,"ip_address":"","ucode":"A2F59EBDD6D9EE","user_header":"https://static001.geekbang.org/account/avatar/00/11/9e/a3/0bfaaf13.jpg","comment_is_top":false,"comment_ctime":1551337933,"is_pvip":false,"replies":[{"id":"26308","content":"这个因素比较多，RTO超时说明已经发生来重传，根源上还是要看为什么会发生重传，比如是否有丢包、是否超出了内核中的资源限制或者对端是否有类似的问题等等。这些最好两端抓包对比分析","user_name":"作者回复","comment_id":71418,"uid":"1001282","ip_address":"","utype":1,"ctime":1551703637,"user_name_real":"倪朋飞"}],"discussion_count":1,"race_medal":0,"score":"18731207117","product_id":100020901,"comment_content":"你好，我在网络编程中遇到一个问题，<br>我们用go语言做的服务调用其他HTTP服务器，发现HTTP请求中卡住，概率非常低。<br>然后我看了发现write，返回eagain，然后就等待epoll通知描述符是否可用，这个时候发现等了很久很久都不可用。netstata看了下，TCP写buffer有数据但是没有满，等了很久也貌似发生不出去，有重传，但是还是传不出去。直接达到rto次数内核中断连接。<br>我们只能将rto改很小让内核中断连接。<br>请问这种情况一般都是由什么原因引起的呢？<br>","like_count":5,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":441141,"discussion_content":"这个因素比较多，RTO超时说明已经发生来重传，根源上还是要看为什么会发生重传，比如是否有丢包、是否超出了内核中的资源限制或者对端是否有类似的问题等等。这些最好两端抓包对比分析","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551703637,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":69593,"user_name":"小虾米","can_delete":false,"product_type":"c1","uid":1005528,"ip_address":"","ucode":"F543987A7FAB20","user_header":"https://static001.geekbang.org/account/avatar/00/0f/57/d8/425e1b0a.jpg","comment_is_top":false,"comment_ctime":1550795325,"is_pvip":false,"replies":[{"id":"24853","content":"看系统的，据我所知，只有RHEL可以通过&#47;proc&#47;sys&#47;net&#47;ipv4&#47;tcp_delack_min修改（默认40ms），而其他发行版都不支持。","user_name":"作者回复","comment_id":69593,"uid":"1001282","ip_address":"","utype":1,"ctime":1550851723,"user_name_real":"倪朋飞"}],"discussion_count":1,"race_medal":0,"score":"18730664509","product_id":100020901,"comment_content":"我记得之前碰到的延迟ack是200ms，这个是可以配置的吗？","like_count":5,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440180,"discussion_content":"看系统的，据我所知，只有RHEL可以通过/proc/sys/net/ipv4/tcp_delack_min修改（默认40ms），而其他发行版都不支持。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550851723,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":250379,"user_name":"骑驴找你","can_delete":false,"product_type":"c1","uid":2118161,"ip_address":"","ucode":"FB9E7511C00BEA","user_header":"https://static001.geekbang.org/account/avatar/00/20/52/11/af170b65.jpg","comment_is_top":false,"comment_ctime":1601042147,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10190976739","product_id":100020901,"comment_content":"40ms最小延迟确认是有一个算法的，那我自己的centos8举例：<br>&#47;usr&#47;src&#47;kernels&#47;4.18.0-80.el8.x86_64+debug&#47;include&#47;net&#47;tcp.h文件中记录了这个变量&#47;宏的定义：<br>#define TCP_DELACK_MAX  ((unsigned)(HZ&#47;5))      &#47;* maximal time to delay before sending an ACK *&#47;<br>#if HZ &gt;= 100<br>#define TCP_DELACK_MIN  ((unsigned)(HZ&#47;25))     &#47;* minimal time to delay before sending an ACK *&#47;<br>HZ的值可以利用老师之前讲过的软中断相关知识计算出来，即相隔10s计算&#47;proc&#47;interrupts里面的中断次数变化，两次做差再除以10就是每秒的中断数，我这边计算出来的值是1005，那么HZ就应该是1000，所以1000&#47;25=40ms","like_count":3},{"had_liked":false,"id":79257,"user_name":"Maxwell","can_delete":false,"product_type":"c1","uid":1086275,"ip_address":"","ucode":"720A00AD472616","user_header":"https://static001.geekbang.org/account/avatar/00/10/93/43/0e84492d.jpg","comment_is_top":false,"comment_ctime":1553418501,"is_pvip":false,"replies":[{"id":"29343","content":"是不是还有其他报错？","user_name":"作者回复","comment_id":79257,"uid":"1001282","ip_address":"","utype":1,"ctime":1553698940,"user_name_real":"倪朋飞"}],"discussion_count":1,"race_medal":0,"score":"10143353093","product_id":100020901,"comment_content":"为什么执行strace -f wrk --latency -c 100 -t 2 --timeout 2 http:&#47;&#47;192.168.126.136:8080&#47;，输出结果中并没有TCP_NODELAY配置选项呢？","like_count":2,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":444420,"discussion_content":"是不是还有其他报错？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1553698940,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":69590,"user_name":"Linuxer","can_delete":false,"product_type":"c1","uid":1153978,"ip_address":"","ucode":"272D9D8089C3D6","user_header":"https://static001.geekbang.org/account/avatar/00/11/9b/ba/333b59e5.jpg","comment_is_top":false,"comment_ctime":1550795189,"is_pvip":false,"replies":[{"id":"25329","content":"嗯，只是客户端有可能在用户那儿，可能无法控制这些选项","user_name":"作者回复","comment_id":69590,"uid":"1001282","ip_address":"","utype":1,"ctime":1551193287,"user_name_real":"倪朋飞"}],"discussion_count":1,"race_medal":0,"score":"10140729781","product_id":100020901,"comment_content":"案例中能设置客户端的TCP_QUICKACK解决吗？","like_count":3,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440178,"discussion_content":"嗯，只是客户端有可能在用户那儿，可能无法控制这些选项","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551193287,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":305716,"user_name":"ghostwritten","can_delete":false,"product_type":"c1","uid":1308196,"ip_address":"","ucode":"AE512F2E24A1A0","user_header":"https://static001.geekbang.org/account/avatar/00/13/f6/24/5a9277f1.jpg","comment_is_top":false,"comment_ctime":1628130629,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5923097925","product_id":100020901,"comment_content":"1. hping3 -c 3 -S -p 80 baidu.com<br>traceroute --tcp -p 80 -n baidu.com<br>2.  wrk --latency -c 100 -t 2 --timeout 2 http:&#47;&#47;192.168.0.30&#47;<br>3.  tcpdump -nn tcp port 8080 -w nginx.pcap<br>4. man tcp---TCP_QUICKACK,TCP_NODELAY<br>5. strace -f wrk --latency -c 100 -t 2 --timeout 2 http:&#47;&#47;192.168.0.30:8080&#47;<br>6. Nagle 算法，是 TCP 协议中用于减少小包发送数量的一种优化算法，它通过合并 TCP 小包,目的是为了提高实际带宽的利用率,<br>7.  Wireshark分析","like_count":2},{"had_liked":false,"id":305114,"user_name":"忆水寒","can_delete":false,"product_type":"c1","uid":1147453,"ip_address":"","ucode":"E3F86BD8AA8903","user_header":"https://static001.geekbang.org/account/avatar/00/11/82/3d/356fc3d6.jpg","comment_is_top":false,"comment_ctime":1627825430,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5922792726","product_id":100020901,"comment_content":"本文是一个很好的案例，条理清晰，。抛砖引玉，我分享一个分析tcp断连的案例分析：https:&#47;&#47;mp.weixin.qq.com&#47;s&#47;XS3Jnn3Xl4_12gzg0zrSTA","like_count":2},{"had_liked":false,"id":297090,"user_name":"Geek_b85295","can_delete":false,"product_type":"c1","uid":1487998,"ip_address":"","ucode":"51CBB577C255EA","user_header":"https://wx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqtXSgThiaEiaEqqic5YIJ7v469nCM3VXiccOJ4SxbYjW91ciczuYYEzcTVtYWaWXaokZqShuLdKsXjnFA/132","comment_is_top":false,"comment_ctime":1623305913,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5918273209","product_id":100020901,"comment_content":"老师，这个案例中，为什么第一个请求没有延迟，第二个请求才开始有延迟","like_count":1},{"had_liked":false,"id":91981,"user_name":"skye","can_delete":false,"product_type":"c1","uid":1027840,"ip_address":"","ucode":"C55C9F52C78A00","user_header":"https://static001.geekbang.org/account/avatar/00/0f/af/00/9b49f42b.jpg","comment_is_top":false,"comment_ctime":1557148791,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5852116087","product_id":100020901,"comment_content":"那nagle算法用在什么情况下呢？","like_count":1,"discussions":[{"author":{"id":1284474,"avatar":"https://static001.geekbang.org/account/avatar/00/13/99/7a/558666a5.jpg","nickname":"AceslupK","note":"","ucode":"048F84D019CBBB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":394042,"discussion_content":"同问","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631695197,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":69668,"user_name":"怀特","can_delete":false,"product_type":"c1","uid":1072331,"ip_address":"","ucode":"3DACB205798ED3","user_header":"https://static001.geekbang.org/account/avatar/00/10/5c/cb/3ebdcc49.jpg","comment_is_top":false,"comment_ctime":1550805217,"is_pvip":true,"replies":[{"id":"25331","content":"就是说星号表示没有收到这一跳的响应","user_name":"作者回复","comment_id":69668,"uid":"1001282","ip_address":"","utype":1,"ctime":1551193429,"user_name_real":"倪朋飞"}],"discussion_count":2,"race_medal":0,"score":"5845772513","product_id":100020901,"comment_content":"traceroute 会在路由的每一跳发送三个包，并在收到响应后，输出往返延时。如果无响应或者响应超时（默认 5s），就会输出一个星号。<br>----这个地方，还有些不明白，希望老师能在这里再解释几句<br>","like_count":2,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440218,"discussion_content":"就是说星号表示没有收到这一跳的响应","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551193429,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1405256,"avatar":"https://static001.geekbang.org/account/avatar/00/15/71/48/44df7f4e.jpg","nickname":"凯","note":"","ucode":"60DB11CF72C7B0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":321564,"discussion_content":"可能是禁止tract了吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604589941,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":347799,"user_name":"DayDayUp","can_delete":false,"product_type":"c1","uid":1610552,"ip_address":"","ucode":"9C53659518AB74","user_header":"https://static001.geekbang.org/account/avatar/00/18/93/38/71615300.jpg","comment_is_top":false,"comment_ctime":1654439969,"is_pvip":false,"discussion_count":0,"race_medal":1,"score":"1654439969","product_id":100020901,"comment_content":"老师，我在想，案例中的恰好是“延迟回复” + “Nagle 算法”的“偶遇”导致了这个延时，如果有大量数据包的情况下，那么一两个包可能是延迟的，如果有大量数据包的情况下应该就没有问题了吧。因为客户端会把所有ACK攒齐一起发送，而服务端也是将数据包的数据部分凑满发送。<br><br>感觉整体不会有特别大的时延。","like_count":1},{"had_liked":false,"id":328181,"user_name":"jaxzhai","can_delete":false,"product_type":"c1","uid":1182911,"ip_address":"","ucode":"B65A8EE7A061FC","user_header":"https://static001.geekbang.org/account/avatar/00/12/0c/bf/863d440a.jpg","comment_is_top":false,"comment_ctime":1640591041,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1640591041","product_id":100020901,"comment_content":"我们业务请求oracle遇到一个同样 延迟确认的问题，但我们客户端加上 TCP_NODELAY  还是同样的问题，现在不知道怎么弄了？","like_count":0},{"had_liked":false,"id":312228,"user_name":"AceslupK","can_delete":false,"product_type":"c1","uid":1284474,"ip_address":"","ucode":"048F84D019CBBB","user_header":"https://static001.geekbang.org/account/avatar/00/13/99/7a/558666a5.jpg","comment_is_top":false,"comment_ctime":1631694507,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1631694507","product_id":100020901,"comment_content":"抓包就是看不懂哪个连着哪个，这个seq和ack太乱了","like_count":0},{"had_liked":false,"id":294806,"user_name":"江","can_delete":false,"product_type":"c1","uid":1398148,"ip_address":"","ucode":"DA8378171C959E","user_header":"https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIC5FK1ibcFwyTQ5TugfhJicSsZ3x5GfibRrUNTxpb8IY88wNREl4GlbJqUUibCHAhZp9wqic2eia2Dpgsw/132","comment_is_top":false,"comment_ctime":1622097246,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1622097246","product_id":100020901,"comment_content":"之前遇到过ping 内网IP偶发延时变高的问题，后来查了发现和网卡中断有关；不知道这部分老师有没有经验，为啥会有影响。","like_count":0},{"had_liked":false,"id":281899,"user_name":"Geek_392979","can_delete":false,"product_type":"c1","uid":2149562,"ip_address":"","ucode":"BE8A0B47CDF562","user_header":"","comment_is_top":false,"comment_ctime":1614938458,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1614938458","product_id":100020901,"comment_content":"老师，学了课程后， 面试的时候遇到一个问题: &quot;1000台服务器， 95%的服务器QPS正常(1000QPS), 其他的是2000QPS, cpu正常, 怎么排查？&quot;<br>我的思路是首先看平均负载， 如果平均负载高，看是什么导致的平局负载高。依次看各个CPU利用率，但题目里说CPU正常。然后能想到的就是：<br>1. sar -n DEV 2 10 看整个的网络收发情况<br>2. traceroute --tcp -p port -n xxx.xxx.com 看到目标服务的网络延时<br>3. pstack看目标服务器上的应用程序的调用堆栈，是不是阻塞在某个调用上<br>4. perf top分析目标应用程序<br><br>感觉这样的答案没有让面试官满意， 所以老师遇到这种问题应该怎么分析？ 到目标服务器的延时高和QPS低是正相关的吗？","like_count":1,"discussions":[{"author":{"id":2542376,"avatar":"https://static001.geekbang.org/account/avatar/00/26/cb/28/21a8a29e.jpg","nickname":"夏天","note":"","ucode":"5F224DDAC94DFF","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":372139,"discussion_content":"没说到点子上，有若干台qps 高\n1.先看机器配置是否相同\n2.如果配置相同，负载均衡权重是否相同\n3.没差别再分析程序","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620207109,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2149562,"avatar":"","nickname":"Geek_392979","note":"","ucode":"BE8A0B47CDF562","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":353136,"discussion_content":"写错了，正常的QPS是10000","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1615021393,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":281014,"user_name":"大拇哥","can_delete":false,"product_type":"c1","uid":1161483,"ip_address":"","ucode":"888C59A8045B5B","user_header":"https://static001.geekbang.org/account/avatar/00/11/b9/0b/cdf98d11.jpg","comment_is_top":false,"comment_ctime":1614525506,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1614525506","product_id":100020901,"comment_content":"本文虽然分析出了原因，并且按照此原因，那Nagle算法就只能在客户端支持QUICACK的场景下才使用，其它场景就没什么好处了？或者说本身Nagle解决的小包多次传输的问题，那就是如果业务场景中多是小包场景，那开启Nagle性能就更好，根据场景选择？","like_count":0},{"had_liked":false,"id":261017,"user_name":"海盗船长","can_delete":false,"product_type":"c1","uid":1363634,"ip_address":"","ucode":"ECB28BA21A4113","user_header":"https://static001.geekbang.org/account/avatar/00/14/ce/b2/1f914527.jpg","comment_is_top":false,"comment_ctime":1605173943,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1605173943","product_id":100020901,"comment_content":"请教下飞哥，如果遇到connect: connection timed out 这种错误，如何处理？","like_count":0,"discussions":[{"author":{"id":2542376,"avatar":"https://static001.geekbang.org/account/avatar/00/26/cb/28/21a8a29e.jpg","nickname":"夏天","note":"","ucode":"5F224DDAC94DFF","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":372140,"discussion_content":"分析是哪一步超时了。是代理服务器还是应用服务器","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620207188,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":241990,"user_name":"J.Smile","can_delete":false,"product_type":"c1","uid":1336475,"ip_address":"","ucode":"C4D98DFDBF7584","user_header":"https://static001.geekbang.org/account/avatar/00/14/64/9b/0b578b08.jpg","comment_is_top":false,"comment_ctime":1597552922,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1597552922","product_id":100020901,"comment_content":"很棒的一篇文章，让我串联起来陶辉老师课程中关于延迟确认 、nagle相关知识。也被科普了一波为什么一般生产环境的ping都被禁止了。","like_count":1},{"had_liked":false,"id":228524,"user_name":"景b","can_delete":false,"product_type":"c1","uid":1025641,"ip_address":"","ucode":"70E04E6B30432C","user_header":"https://static001.geekbang.org/account/avatar/00/0f/a6/69/cf2eb6be.jpg","comment_is_top":false,"comment_ctime":1592725953,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1592725953","product_id":100020901,"comment_content":"TCP Flows 那个地方展示的图，是tcp流  <br>怎么从这个图（上图红框画的那些）知道这些报文哪些是 第一个http响应的结束点和第二个请求的开始点  <br>这个地方没搞懂<br>","like_count":0,"discussions":[{"author":{"id":2118161,"avatar":"https://static001.geekbang.org/account/avatar/00/20/52/11/af170b65.jpg","nickname":"骑驴找你","note":"","ucode":"FB9E7511C00BEA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":308716,"discussion_content":"最直接的办法就是看wireshark中的协议，老师的例子里这个curl其实就是一个http请求，所以请求的开始就是客户端向服务器端发送一个GET请求，即图片里的包270；请求结束的时候，服务器会向客户端发送200的确认码，即包475，那么客户端要返回一个ACK，即包476，这就是一个完整的请求过程，也就是老师例子的里的第一个http响应","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1601041860,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1284474,"avatar":"https://static001.geekbang.org/account/avatar/00/13/99/7a/558666a5.jpg","nickname":"AceslupK","note":"","ucode":"048F84D019CBBB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2118161,"avatar":"https://static001.geekbang.org/account/avatar/00/20/52/11/af170b65.jpg","nickname":"骑驴找你","note":"","ucode":"FB9E7511C00BEA","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":394043,"discussion_content":"我想上面同学问的应该也还有TCP的开始和结束，当然我也同问，这个我也比较迷。希望赐教，多谢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631695377,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":308716,"ip_address":""},"score":394043,"extra":""}]}]},{"had_liked":false,"id":223024,"user_name":"Damoncui","can_delete":false,"product_type":"c1","uid":1566446,"ip_address":"","ucode":"5F09EB267F0572","user_header":"https://static001.geekbang.org/account/avatar/00/17/e6/ee/8fdbd5db.jpg","comment_is_top":false,"comment_ctime":1590982918,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1590982918","product_id":100020901,"comment_content":"真棒！！<br>打卡 D12~","like_count":0},{"had_liked":false,"id":203109,"user_name":"怀揣梦想的学渣","can_delete":false,"product_type":"c1","uid":1916685,"ip_address":"","ucode":"2349B9F4F6FDE3","user_header":"https://static001.geekbang.org/account/avatar/00/1d/3f/0d/1e8dbb2c.jpg","comment_is_top":false,"comment_ctime":1586140983,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1586140983","product_id":100020901,"comment_content":"太强了，看案例的时候，我就在想，作者居然可以想到这么多细节。","like_count":0},{"had_liked":false,"id":166764,"user_name":"HelloTalk","can_delete":false,"product_type":"c1","uid":1618633,"ip_address":"","ucode":"F898E6A7C61D39","user_header":"https://static001.geekbang.org/account/avatar/00/18/b2/c9/b414a77c.jpg","comment_is_top":false,"comment_ctime":1577589729,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1577589729","product_id":100020901,"comment_content":"为什么 TCP Flows 那个图里面的 “第一次请求和响应” 的第一个client-&gt;server是 PSH+ACK的报文呢？<br><br>我感觉子一个报文应该是纯packet才对阿，后面客户端回的报文才是 PSH+ACK<br>","like_count":0},{"had_liked":false,"id":127437,"user_name":"Magic Star Trace","can_delete":false,"product_type":"c1","uid":1297017,"ip_address":"","ucode":"15360D39BC32D1","user_header":"https://static001.geekbang.org/account/avatar/00/13/ca/79/139615aa.jpg","comment_is_top":false,"comment_ctime":1566711065,"is_pvip":false,"replies":[{"id":"47207","content":"用本文的思路分析一下，看看有什么发现？","user_name":"作者回复","user_name_real":"倪朋飞","uid":"1001282","ctime":1566743361,"ip_address":"","comment_id":127437,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1566711065","product_id":100020901,"comment_content":"请问：物理机centos 7 ，kvm 上虚拟机 丢包不稳定是什么问题导致的呢？<br>time 延迟很不稳定","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":464490,"discussion_content":"用本文的思路分析一下，看看有什么发现？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566743361,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":106749,"user_name":"阳光梦","can_delete":false,"product_type":"c1","uid":1283965,"ip_address":"","ucode":"55BDA128D39931","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/TTPicMEZ5s1zKiaKYecIljicRV9dibITPM0958W3VuNHXlTQic2Dj6XYGibF7dqrG3JWr0LMx7hY9zXGzuvTDNGw8KAA/132","comment_is_top":false,"comment_ctime":1561382859,"is_pvip":false,"replies":[{"id":"40444","content":"试试动态追踪（专栏第50、51篇）怎么样？","user_name":"作者回复","user_name_real":"倪朋飞","uid":"1001282","ctime":1562509845,"ip_address":"","comment_id":106749,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1561382859","product_id":100020901,"comment_content":"您好，请教下。我通过客户端直接访问服务器，平均响应延迟是30ms，经过nginx代理响应延迟是200ms，我使用的ngx+lua，业务逻辑是先查询worker进程的缓存，没有再查redis，再没有查mysql，现在lua层面可以优化的已经优化了，平均响应延迟还是170ms,不知道通过什么工具能定位具体哪里导致响应延迟慢呢？谢谢！","like_count":1,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":455205,"discussion_content":"试试动态追踪（专栏第50、51篇）怎么样？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562509845,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":94958,"user_name":"坤丰","can_delete":false,"product_type":"c1","uid":1143705,"ip_address":"","ucode":"AEE94BF9B837AB","user_header":"https://static001.geekbang.org/account/avatar/00/11/73/99/eb99b2cb.jpg","comment_is_top":false,"comment_ctime":1557930191,"is_pvip":false,"replies":[{"id":"34172","content":"会的，不推荐长期开着","user_name":"作者回复","user_name_real":"倪朋飞","uid":"1001282","ctime":1558095671,"ip_address":"","comment_id":94958,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1557930191","product_id":100020901,"comment_content":"不考虑磁盘问题，tcpdump 长期在生产环境打开，会有什么不良的影响吗？会影响到网络性能吗？如何去评估这样的问题","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":450273,"discussion_content":"会的，不推荐长期开着","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1558095671,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":85035,"user_name":"大坏狐狸","can_delete":false,"product_type":"c1","uid":1325678,"ip_address":"","ucode":"5044F89A505C5B","user_header":"https://static001.geekbang.org/account/avatar/00/14/3a/6e/e39e90ca.jpg","comment_is_top":false,"comment_ctime":1554963026,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1554963026","product_id":100020901,"comment_content":"开始懵了。setsocket那里 没找到。。不过 确实nginx的那个nodeplay  为off","like_count":0},{"had_liked":false,"id":83789,"user_name":"如果","can_delete":false,"product_type":"c1","uid":1320638,"ip_address":"","ucode":"138A3EEEE50850","user_header":"","comment_is_top":false,"comment_ctime":1554715759,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1554715759","product_id":100020901,"comment_content":"DAY40，打卡","like_count":0},{"had_liked":false,"id":73435,"user_name":"楚","can_delete":false,"product_type":"c1","uid":1154723,"ip_address":"","ucode":"A2F59EBDD6D9EE","user_header":"https://static001.geekbang.org/account/avatar/00/11/9e/a3/0bfaaf13.jpg","comment_is_top":false,"comment_ctime":1551883448,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1551883448","product_id":100020901,"comment_content":"文中没有说过有什么方法。而且我这是抓包根本看不出什么。只看见重传15次后连接断开。<br>我想请教的是，一般什么原因导致重传这么多次还是没有重传成功呢？<br>write buffer一直有数据且大小不变，代表数据一直发不出去。<br>而TCP心跳在有数据在write buffer情况下是不会发生心跳的。","like_count":0},{"had_liked":false,"id":73184,"user_name":"科学Jia","can_delete":false,"product_type":"c1","uid":1080409,"ip_address":"","ucode":"95430413F82A69","user_header":"https://static001.geekbang.org/account/avatar/00/10/7c/59/26b1e65a.jpg","comment_is_top":false,"comment_ctime":1551836177,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1551836177","product_id":100020901,"comment_content":"老师这个案例非常好，受益匪浅，让我决心好好再温习下tcp的基础知识。还是基础最重要。","like_count":0},{"had_liked":false,"id":72868,"user_name":"楚","can_delete":false,"product_type":"c1","uid":1154723,"ip_address":"","ucode":"A2F59EBDD6D9EE","user_header":"https://static001.geekbang.org/account/avatar/00/11/9e/a3/0bfaaf13.jpg","comment_is_top":false,"comment_ctime":1551748726,"is_pvip":false,"replies":[{"id":"26740","content":"嗯，可以用文中的方法分析看看","user_name":"作者回复","user_name_real":"倪朋飞","uid":"1001282","ctime":1551883062,"ip_address":"","comment_id":72868,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1551748726","product_id":100020901,"comment_content":"你好，但是每次出问题都要等到重传15次。而且write buffer都不变。<br>应该不是简单超时吧。","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":441800,"discussion_content":"嗯，可以用文中的方法分析看看","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551883062,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":70556,"user_name":"ninuxer","can_delete":false,"product_type":"c1","uid":1243135,"ip_address":"","ucode":"5394ADAF2667D6","user_header":"https://wx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEKQMM4m7NHuicr55aRiblTSEWIYe0QqbpyHweaoAbG7j2v7UUElqqeP3Ihrm3UfDPDRb1Hv8LvPwXqA/132","comment_is_top":false,"comment_ctime":1551141205,"is_pvip":false,"replies":[{"id":"25363","content":"再温习温习原理就可以了😊","user_name":"作者回复","user_name_real":"倪朋飞","uid":"1001282","ctime":1551195431,"ip_address":"","comment_id":70556,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1551141205","product_id":100020901,"comment_content":"打卡day42<br>案例中的问题，可能我通过抓包仔细看后，能得出ack有异常，但是没办法跟客户端默认的ack延时发送，以及nginx的tcp_nodelay联系起来～😂","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440690,"discussion_content":"再温习温习原理就可以了😊","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551195431,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":70123,"user_name":"腾达","can_delete":false,"product_type":"c1","uid":1079876,"ip_address":"","ucode":"72F9CFBA44FDEE","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTL9hlAIKQ1sGDu16oWLOHyCSicr18XibygQSMLMjuDvKk73deDlH9aMphFsj41WYJh121aniaqBLiaMNg/132","comment_is_top":false,"comment_ctime":1551001703,"is_pvip":false,"replies":[{"id":"25346","content":"这个案例的核心是客户端问题，客户端有没有配置延迟ACK？","user_name":"作者回复","user_name_real":"倪朋飞","uid":"1001282","ctime":1551194619,"ip_address":"","comment_id":70123,"utype":1}],"discussion_count":4,"race_medal":0,"score":"1551001703","product_id":100020901,"comment_content":"为什么我无法出现延迟40ms左右的情况？ 我都是按照老师的步骤来的。我的nginx端（VM1）是ubuntu 18.04，跟老师版本一样的，VM2端是Ubuntu16，wrk，curl工作在此。我用wrk跑三个nginx（分别是good，nginx-latency，nginx-nodelay）差不多，Latency  Avg在   90ms，有时候，反而还是nginx-latency最好。我观察了包的顺序，确实如课程所说的那样(老师能否将本课中说抓的包一起上传到github？)<br>我的三个nginx的配置如下：<br><br>good的配置：<br>http {<br>    include       &#47;etc&#47;nginx&#47;mime.types;<br>    default_type  application&#47;octet-stream;<br><br>    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;<br>                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;<br>                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;<br><br>    access_log  &#47;var&#47;log&#47;nginx&#47;access.log  main;<br><br>    sendfile        on;<br>    #tcp_nopush     on;<br><br>    keepalive_timeout  65;<br><br>    #gzip  on;<br><br>    include &#47;etc&#47;nginx&#47;conf.d&#47;*.conf;<br>}<br><br><br>nginx-nodelay的配置：<br>http {<br>    include       &#47;etc&#47;nginx&#47;mime.types;<br>    default_type  application&#47;octet-stream;<br><br>    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;<br>                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;<br>                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;<br><br>    access_log  &#47;var&#47;log&#47;nginx&#47;access.log  main;<br><br>    sendfile        on;<br>    tcp_nopush     off;<br>    tcp_nodelay     on;<br><br>    keepalive_timeout  65;<br><br>    #gzip  on;<br><br>    include &#47;etc&#47;nginx&#47;conf.d&#47;*.conf;<br>}<br><br><br>nginx-latency的配置：<br>http {<br>    include       &#47;etc&#47;nginx&#47;mime.types;<br>    default_type  application&#47;octet-stream;<br><br>    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;<br>                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;<br>                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;<br><br>    access_log  &#47;var&#47;log&#47;nginx&#47;access.log  main;<br><br>    sendfile        on;<br>    tcp_nopush     off;<br>    tcp_nodelay    off;<br><br>    keepalive_timeout  65;<br><br>    #gzip  on;<br><br>    include &#47;etc&#47;nginx&#47;conf.d&#47;*.conf;<br>}<br><br><br><br>","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440449,"discussion_content":"这个案例的核心是客户端问题，客户端有没有配置延迟ACK？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551194619,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1626276,"avatar":"https://static001.geekbang.org/account/avatar/00/18/d0/a4/9f8978dc.jpg","nickname":"wangkaiyuan","note":"","ucode":"FB975EB1DB53F0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":575050,"discussion_content":"客户端要如何配置延迟ACK","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1654572008,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":440449,"ip_address":""},"score":575050,"extra":""}]},{"author":{"id":1626276,"avatar":"https://static001.geekbang.org/account/avatar/00/18/d0/a4/9f8978dc.jpg","nickname":"wangkaiyuan","note":"","ucode":"FB975EB1DB53F0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":575052,"discussion_content":"我遇到了和你同样的问题，nginx设置tcp_nodelay的on和off对延时无影响，客户端配置的是延时确认ACK","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1654572324,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1657948,"avatar":"https://static001.geekbang.org/account/avatar/00/19/4c/5c/9ea0f752.jpg","nickname":"程序猿不圆","note":"","ucode":"BC8926A84A07C8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":212767,"discussion_content":"我抓的包和倪老师的一样，但是为什么反而案例Nginx的延迟更小？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585013820,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":69671,"user_name":"Linuxer","can_delete":false,"product_type":"c1","uid":1153978,"ip_address":"","ucode":"272D9D8089C3D6","user_header":"https://static001.geekbang.org/account/avatar/00/11/9b/ba/333b59e5.jpg","comment_is_top":false,"comment_ctime":1550805629,"is_pvip":false,"replies":[{"id":"24854","content":"思路是一样的，只是在抓包后要按应用过滤（比如端口号），然后再分别进行分析","user_name":"作者回复","user_name_real":"倪朋飞","uid":"1001282","ctime":1550851857,"ip_address":"","comment_id":69671,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1550805629","product_id":100020901,"comment_content":"同一套环境碰到一个低并发高延时，高并发低延时得的问题，请问倪老师像这种问题该如何排查?","like_count":1,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440219,"discussion_content":"思路是一样的，只是在抓包后要按应用过滤（比如端口号），然后再分别进行分析","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550851857,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}