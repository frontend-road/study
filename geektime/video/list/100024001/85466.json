{"id":85466,"title":"14 | 可变参数和defer","content":"<h1>课件及源代码地址</h1><p><a href=\"https://gitee.com/geektime-geekbang/go_learning\">https://gitee.com/geektime-geekbang/go_learning</a></p><h2>书目推荐</h2><p><a href=\"time://mall?url=https%3A%2F%2Fh5.youzan.com%2Fv2%2Fgoods%2F1ycmk3uob0ryw\">《计算机程序的构造和解释》</a></p>","comments":[{"had_liked":false,"id":237622,"user_name":"郭星","can_delete":false,"product_type":"c3","uid":1182219,"ip_address":"","ucode":"8A0F5DF80E0C61","user_header":"https://static001.geekbang.org/account/avatar/00/12/0a/0b/985d3800.jpg","comment_is_top":false,"comment_ctime":1595904003,"is_pvip":false,"replies":[{"id":88032,"content":"这个在我的公众号里，讨论过这个问题。 defer延迟执行只是最后一层调用的延迟","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1596115551,"ip_address":"","comment_id":237622,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"关于 defer func()func() 的问题\nfunc GetFunc() func() {\n   fmt.Print(&quot;[outside]&quot;)\n   return func() {\n      fmt.Print(&quot;[inside]&quot;)\n   }\n}\n\n\n&#47;&#47; 输出结果为 [outside][here][inside]\nfunc TestDeferGetFunc(t *testing.T) {\n   defer GetFunc()()\n   fmt.Print(&quot;[here]&quot;)\n}\n为什么会先执行GetFunc() 输出[outside]","like_count":2,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":502484,"discussion_content":"这个在我的公众号里，讨论过这个问题。 defer延迟执行只是最后一层调用的延迟","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596115551,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":159737,"user_name":"WING","can_delete":false,"product_type":"c3","uid":1485200,"ip_address":"","ucode":"E4723BA4027407","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/IdElofI20lsCUm1NIQPSpYFzAGLbLs41SL324FkmTb0icqnRJicW6mqX4iag1BQUSNtc7BtKJ2fEUYwU4rN47vEsQ/132","comment_is_top":false,"comment_ctime":1575769943,"is_pvip":false,"replies":[{"id":61477,"content":"不用写在最前面，就例子而言要写在你的panic前面。但是在实际程序中由于我们不知道错误&#47;panic会在哪里发生所以把defer写在最前面会更简单保险。","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1576159936,"ip_address":"","comment_id":159737,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"老师，defer的声明是要写在程序最前面吗？我试了一下，如果defer 申明放在panic后面，是不会执行的，这根java的finally有点区别。\nfmt.Println(&quot;Start...&quot;)\npanic(&quot;Fatal error.&quot;)\ndefer Clear()\n我这样写，Clear()不会被执行。","like_count":2,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":477156,"discussion_content":"不用写在最前面，就例子而言要写在你的panic前面。但是在实际程序中由于我们不知道错误/panic会在哪里发生所以把defer写在最前面会更简单保险。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576159936,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":77506,"user_name":"Steven Fung","can_delete":false,"product_type":"c3","uid":1052952,"ip_address":"","ucode":"193D1031AA362B","user_header":"https://static001.geekbang.org/account/avatar/00/10/11/18/bba8efd2.jpg","comment_is_top":false,"comment_ctime":1552957728,"is_pvip":false,"replies":[{"id":28374,"content":"你尝试都用fmt.Println输出\n","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1552995738,"ip_address":"","comment_id":77506,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"1，从打印来看，panic在defer之后，为什么还说defer是在panic之后执行？\n2，panic应该也有非自己调用的，这种是怎么保证defer在panic之后执行？","like_count":2,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":443752,"discussion_content":"你尝试都用fmt.Println输出\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1552995738,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":76990,"user_name":"Amorfati","can_delete":false,"product_type":"c3","uid":1047091,"ip_address":"","ucode":"71122E777FE2AB","user_header":"https://static001.geekbang.org/account/avatar/00/0f/fa/33/0eb31e67.jpg","comment_is_top":false,"comment_ctime":1552795561,"is_pvip":false,"replies":[{"id":28325,"content":"改成用fmt.Println（“after start”）\n\n","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1552965061,"ip_address":"","comment_id":76990,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"请教老师，我在写defer的这个例子的时候\nfunc TestDefer(t *testing.T) {\n\tdefer Clear()\n\tfmt.Println(&quot;start&quot;)\n\tt.Log(&quot;after start&quot;)\n\tpanic(&quot;Fatal Err&quot;)\n}\nafter start 这个并没有显示出来，能麻烦帮忙解答一下为什么没有显示出来么","like_count":2,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":443531,"discussion_content":"改成用fmt.Println（“after start”）\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1552965061,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1020525,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/92/6d/becd841a.jpg","nickname":"escray","note":"","ucode":"1F4204930E47C4","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":364229,"discussion_content":"不改代码，我也可以显示\ngo version go1.16.2 darwin/amd64\nVS Code","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617415166,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1587746,"avatar":"https://static001.geekbang.org/account/avatar/00/18/3a/22/1f554137.jpg","nickname":"My.life","note":"","ucode":"8A6849BED73FC9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":329527,"discussion_content":"为什么我可以显示出来，和你的代码一模一样","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606398809,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":105151,"user_name":"周棋洛","can_delete":false,"product_type":"c3","uid":1134070,"ip_address":"","ucode":"8F4A0947093982","user_header":"https://static001.geekbang.org/account/avatar/00/11/4d/f6/0557ad36.jpg","comment_is_top":false,"comment_ctime":1560930875,"is_pvip":false,"replies":[{"id":38177,"content":"不太一样，析构函数的执行时间是和对象的生命周期相关，而defer可以用在非对象的场景","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1561012802,"ip_address":"","comment_id":105151,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"老师,是否可以这么理解，defer像是函数的析构造？","like_count":1,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":454577,"discussion_content":"不太一样，析构函数的执行时间是和对象的生命周期相关，而defer可以用在非对象的场景","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561012802,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":100521,"user_name":"风吹过","can_delete":false,"product_type":"c3","uid":1068817,"ip_address":"","ucode":"5BDE444ECFE6B5","user_header":"https://static001.geekbang.org/account/avatar/00/10/4f/11/b5044abb.jpg","comment_is_top":false,"comment_ctime":1559570413,"is_pvip":false,"replies":[{"id":36308,"content":"这个是短音I，不发“滴”。找个发音软件","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1559621781,"ip_address":"","comment_id":100521,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"好别扭，跟我读：滴fer，不是跌fer  [dɪˈfɜː(r)]  ","like_count":1,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":452582,"discussion_content":"这个是短音I，不发“滴”。找个发音软件","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1559621781,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1904131,"avatar":"","nickname":"小火龙","note":"","ucode":"B6C4F22B1A6D51","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":211488,"discussion_content":"你的发音是很有问题...我也是无语了，人家指出来也不虚心接受。","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1584857141,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1020525,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/92/6d/becd841a.jpg","nickname":"escray","note":"","ucode":"1F4204930E47C4","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":364235,"discussion_content":"我真的查了字典，de‧fer /dɪˈfɜː $ -ˈfɜːr/ 朗文","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617416470,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":81728,"user_name":"NIXUS","can_delete":false,"product_type":"c3","uid":1000060,"ip_address":"","ucode":"853763C229A5AA","user_header":"https://static001.geekbang.org/account/avatar/00/0f/42/7c/8ef14715.jpg","comment_is_top":false,"comment_ctime":1554020747,"is_pvip":false,"replies":[{"id":29631,"content":"这个是用了不同的输出方式的原因，都用fmt.Println输出试试","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1554035379,"ip_address":"","comment_id":81728,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"请教老师，我在写defer的这个例子的时候\nfunc TestDefer(t *testing.T) {\n    defer Clear()\n    fmt.Println(&quot;start&quot;)\n    t.Log(&quot;after start&quot;)\n    panic(&quot;Fatal Err&quot;)\n}\nafter start 这个并没有显示出来，能麻烦帮忙解答一下为什么没有显示出来么\n\n这个并不是after start没显示出来, 而是在不同的地方显示了, t.Log输出的内容, 和panic输出的内容, 在同一个地方, 可能这两个属于同一类方法吧","like_count":0,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":445317,"discussion_content":"这个是用了不同的输出方式的原因，都用fmt.Println输出试试","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1554035379,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":76359,"user_name":"Flygar","can_delete":false,"product_type":"c3","uid":1202817,"ip_address":"","ucode":"9C3A47125FBDEE","user_header":"https://static001.geekbang.org/account/avatar/00/12/5a/81/8cb542f2.jpg","comment_is_top":false,"comment_ctime":1552577588,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"作为defer的补充：\n1. Defer 被用来确保一个函数调用在程序执行结束前执行。同样用来执行一些清理工作。defer 用在像其他语言中的 ensure 和 finally用到的地方。\n2. 关键字 defer 允许我们推迟到函数返回之前（或任意位置执行 return 语句之后）一刻才执行某个语句或函数（为什么要在返回之后才执行这些语句？因为 return 语句同样可以包含一些操作，而不是单纯地返回某个值）。\n3. 推迟的函数调用会被压入一个栈中。当外层函数返回时，被推迟的函数会按照后进先出的顺序调用。\n\n&#47;&#47;当有多个 defer 行为被注册时，它们会以逆序执行（类似栈，后进先出）\nfunc fdefer() {\n\tfor i := 0; i &lt; 5; i++ {\n\t\tdefer fmt.Printf(&quot;%d\\n&quot;, i)\n\t}\n}\n\n&#47;&#47;变量 ret 的值为 2，因为 ret++ 是在执行 return 1 语句后发生的\nfunc fdefer2() (ret int) {\n\tdefer func() {\n\t\tret++\n\t}()\n\treturn 1\n}","like_count":20,"discussions":[{"author":{"id":1214026,"avatar":"https://static001.geekbang.org/account/avatar/00/12/86/4a/0370f832.jpg","nickname":"写给三月","note":"","ucode":"F9DCF7C9B76AC5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":293070,"discussion_content":"这个关键字，我一直把他当java中的finally来用","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595426075,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":257253,"user_name":"李圣悦","can_delete":false,"product_type":"c3","uid":1638427,"ip_address":"","ucode":"C1786C98824E50","user_header":"https://static001.geekbang.org/account/avatar/00/19/00/1b/eee13196.jpg","comment_is_top":false,"comment_ctime":1603895927,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"实测了一下，发现os.Exit(0)之后就不会调用defer函数\nfunc TestDefer(t *testing.T) {\n\tdefer func() {\n\t\tt.Log(&quot;clean resources&quot;)\n\t}()\n\n\tt.Log(&quot;Started&quot;)\n\tos.Exit(0)\n}\n\n输出如下\n\n=== RUN   TestMultiFunc\n    func_test.go:32: 1\ntime spent:  1.000151402s\n    func_test.go:33: 10\n    func_test.go:34: time.Duration\n--- PASS: TestMultiFunc (1.00s)\n=== RUN   TestVarParam\n    func_test.go:47: 10\n    func_test.go:48: 15\n--- PASS: TestVarParam (0.00s)\n=== RUN   TestDefer\n    func_test.go:56: Started\nok  \ttest&#47;src&#47;ch10&#47;func\t1.014s\n","like_count":4,"discussions":[{"author":{"id":1020525,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/92/6d/becd841a.jpg","nickname":"escray","note":"","ucode":"1F4204930E47C4","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":364228,"discussion_content":"我在 VS Code 里面执行，是可以打印的，输出如下：\n\ngo version go1.16.2 darwin/amd64\n\n=== RUN   TestDefer\n    fun_test.go:106: Started\n    fun_test.go:103: clean resources\n--- FAIL: TestDefer (0.00s)\npanic: unexpected call to os.Exit(0) during test [recovered]\n\tpanic: unexpected call to os.Exit(0) during test\n\ngoroutine 6 [running]:\ntesting.tRunner.func1.2(0x111ca40, 0x116ed98)\n... ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617415077,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":100902,"user_name":"Eden","can_delete":false,"product_type":"c3","uid":1197733,"ip_address":"","ucode":"BE0AD731E5EF5E","user_header":"https://static001.geekbang.org/account/avatar/00/12/46/a5/51449de6.jpg","comment_is_top":false,"comment_ctime":1559683244,"is_pvip":false,"replies":null,"discussion_count":3,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"初学语言，用中文解释了一下，方便理解\n```\n&#47;&#47; defer「延缓」碰到这个函数，先延缓不动。在该函数最后返回前，才执行defer声明的函数, 一般用来释放执行函数后的资源和锁\n&#47;&#47; panic「惊恐」让人感到惊恐的错误 ⚠️：即便出现严重错误，defer 依然可以执行，用于释放资源\n\nfunc Clear(par1 int) {\n\tfmt.Println(&quot;3. Clear resources!&quot;, par1)\n}\n\nfunc FuncDefer() {\n\tfmt.Println(&quot;2. 被 defer 的函数里面还有被 defer 的化，会被先执行!&quot;)\n\tdefer Clear(2)\n}\n\nfunc TestDefer(t *testing.T) {\n\tdefer Clear(1)\n\tdefer FuncDefer()\n\tfmt.Println(&quot;1. Start&quot;)\n\tpanic(&quot;err&quot;)\n}\n\n```","like_count":4,"discussions":[{"author":{"id":1593085,"avatar":"https://static001.geekbang.org/account/avatar/00/18/4e/fd/c2c330d5.jpg","nickname":"为此","note":"","ucode":"2E0331524A7CFD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":611313,"discussion_content":"感觉像是栈，先defer先入栈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1680019372,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1020525,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/92/6d/becd841a.jpg","nickname":"escray","note":"","ucode":"1F4204930E47C4","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":364233,"discussion_content":"这段代码还真是让人意外\n\nfunc TestDefer(t *testing.T) {\n  defer Clear(1)\n  defer FuncDefer()\n  defer Clear(3)\n  fmt.Println(&#34;1. Start&#34;)\n  panic(&#34;err&#34;)\n}\n\n=== RUN   TestDefer\n1. Start\n3. Clear resources! 3\n2. 被 defer 的函数里面还有被 defer 的化，会被先执行!\n3. Clear resources! 2\n3. Clear resources! 1\n--- FAIL: TestDefer (0.00s)\npanic: err [recovered]","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617416286,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1105161,"avatar":"https://static001.geekbang.org/account/avatar/00/10/dd/09/feca820a.jpg","nickname":"helloworld","note":"","ucode":"1EECCA0F43E278","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":47225,"discussion_content":"学习了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573299200,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":220686,"user_name":"YanZu","can_delete":false,"product_type":"c3","uid":1223076,"ip_address":"","ucode":"B3954130EF8AD3","user_header":"https://static001.geekbang.org/account/avatar/00/12/a9/a4/9e0834a8.jpg","comment_is_top":false,"comment_ctime":1590308525,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"作为defer的补充：\n1. Defer 被用来确保一个函数调用在程序执行结束前执行。同样用来执行一些清理工作。defer 用在像其他语言中的 ensure 和 finally用到的地方。\n2. 关键字 defer 允许我们推迟到函数返回之前（或任意位置执行 return 语句之后）一刻才执行某个语句或函数（为什么要在返回之后才执行这些语句？因为 return 语句同样可以包含一些操作，而不是单纯地返回某个值）。\n3. 推迟的函数调用会被压入一个栈中。当外层函数返回时，被推迟的函数会按照后进先出的顺序调用。\n\n&#47;&#47;当有多个 defer 行为被注册时，它们会以逆序执行（类似栈，后进先出）\nfunc fdefer() {\nfor i := 0; i &lt; 5; i++ {\ndefer fmt.Printf(&quot;%d\\n&quot;, i)\n}\n}\n\n&#47;&#47;变量 ret 的值为 2，因为 ret++ 是在执行 return 1 语句后发生的\nfunc fdefer2() (ret int) {\ndefer func() {\nret++\n}()\nreturn 1\n}\n","like_count":1},{"had_liked":false,"id":177159,"user_name":"王宇","can_delete":false,"product_type":"c3","uid":1438475,"ip_address":"","ucode":"0E9BC3AD99C8E5","user_header":"https://static001.geekbang.org/account/avatar/00/15/f3/0b/4560079e.jpg","comment_is_top":false,"comment_ctime":1581306198,"is_pvip":false,"replies":null,"discussion_count":2,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"可变长参数，看到了PHP的影子…","like_count":1,"discussions":[{"author":{"id":2890901,"avatar":"https://static001.geekbang.org/account/avatar/00/2c/1c/95/3d8920c9.jpg","nickname":"abcdabcd999","note":"","ucode":"E1D9902737F544","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":600295,"discussion_content":"哪个语言不支持 PHP 的优越性？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1674190575,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"山西","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1005391,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","nickname":"奕","note":"","ucode":"73CEA468CE70C3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":184412,"discussion_content":"可变参数 ... 好多语言中都是这样用的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582554683,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":395505,"user_name":"一秒","can_delete":false,"product_type":"c3","uid":1311001,"ip_address":"山东","ucode":"F149B7F60620BD","user_header":"https://static001.geekbang.org/account/avatar/00/14/01/19/f4da2829.jpg","comment_is_top":false,"comment_ctime":1730992792,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"func TestVarParam(t *testing.T) {\n\tseveral := []int{1, 2, 3, 4}\n\tt.Log(Sum(several...)) &#47;&#47;在调用的切片变量后面添加省略号\n\tt.Log(Sum(1, 2, 3, 4, 5))\n}\n可变长参数最后一个参数接收一个切片类型的边长参数。调用的切片变量后面添加省略号。\n\n&#47;&#47;老师视频里说的是个数组，不太好理解，上边是我在 《Head First Go》里看到的。\n\n----2024.11.7.23:19","like_count":0},{"had_liked":false,"id":346768,"user_name":"颜海航","can_delete":false,"product_type":"c3","uid":1308159,"ip_address":"","ucode":"5644F6328BF901","user_header":"https://static001.geekbang.org/account/avatar/00/13/f5/ff/523fb378.jpg","comment_is_top":false,"comment_ctime":1653408400,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"Python中的装饰器 有语法糖 @ ,\ngo里面还需要在原来的功能函数外再使用时间统计函数 ，单纯从装饰器这块 扩展性可读性都没有Python高","like_count":0},{"had_liked":false,"id":345001,"user_name":"颜海航","can_delete":false,"product_type":"c3","uid":1308159,"ip_address":"","ucode":"5644F6328BF901","user_header":"https://static001.geekbang.org/account/avatar/00/13/f5/ff/523fb378.jpg","comment_is_top":false,"comment_ctime":1651924733,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"在Python中这种传入函数 返回函数是不是装饰器这种语法糖？","like_count":0},{"had_liked":false,"id":304793,"user_name":"噼里啪啦啪啦噼里噼里啪啦","can_delete":false,"product_type":"c3","uid":1109143,"ip_address":"","ucode":"2A4B86D38F7E11","user_header":"https://static001.geekbang.org/account/avatar/00/10/ec/97/58e7bc9a.jpg","comment_is_top":false,"comment_ctime":1627617943,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"更好的理解defer panic recover,实现try: catch:\npackage fn_test\n\nimport (\n\t&quot;fmt&quot;\n\t&quot;testing&quot;\n)\n\nfunc travelList(list []int, count int) {\n\tfor i := 0; i &lt; count; i++ {\n\t\tfmt.Println(list[i])\n\t}\n}\n\nfunc handleExcept() {\n\tif err := recover(); err != nil {\n\t\tfmt.Println(&quot;超出list range, stop.&quot;)\n\t}\n}\n\nfunc TestDeferPanicAndRecoverforTryCatch(t *testing.T) {\n\tt.Log(&quot;Test start.&quot;)\n\tlist := []int{1, 2, 3, 4, 5}\n\t&#47;&#47; catch:\n\tdefer handleExcept()\n\t&#47;&#47; try:\n\ttravelList(list, 10)\n\tt.Log(&quot;Test end.&quot;) &#47;&#47;不会执行\n}\n","like_count":0},{"had_liked":false,"id":286594,"user_name":"escray","can_delete":false,"product_type":"c3","uid":1020525,"ip_address":"","ucode":"1F4204930E47C4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/92/6d/becd841a.jpg","comment_is_top":false,"comment_ctime":1617416518,"is_pvip":true,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"可变参数似乎已经是新的编程语言标配了，PHP、Python、Ruby 里面似乎都有\n\n看到一个 defer 小魔术\n\n```\n&#47;&#47; [outside][here][inside]\nfunc TestDeferGetFunc(t *testing.T) {\n  defer GetFunc()()\n  fmt.Print(&quot;[here]&quot;)\n}\n\n&#47;&#47; [there][outside]\nfunc TestDeferGetFuncAgain(t *testing.T) {\n  defer GetFunc()\n  fmt.Print(&quot;[there]&quot;)\n}\n```\n\n老师的解释是 defer 延迟执行只是最后一层调用的延迟。\n\n另外留言里面 @Flygar 和 @Eden 的两段代码也值得一看。","like_count":0},{"had_liked":false,"id":195278,"user_name":"小虎","can_delete":false,"product_type":"c3","uid":1033083,"ip_address":"","ucode":"31438B30CF7910","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/GkMk4gBlfZcljsY3Vqu7w8ZkxBfe8WTz1ySnPTJARKXF0FpCr3HqlicIHQlItib9m7iaxLESkmBNpoiaY81EUUzQrA/132","comment_is_top":false,"comment_ctime":1585152981,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"Defer延迟执行，相当于java里面的finally，无论是否程序中断都会执行，一般用于资源清理。","like_count":0},{"had_liked":false,"id":169889,"user_name":"o9","can_delete":false,"product_type":"c3","uid":1101332,"ip_address":"","ucode":"E373E82A39BBFE","user_header":"https://static001.geekbang.org/account/avatar/00/10/ce/14/b488f241.jpg","comment_is_top":false,"comment_ctime":1578468679,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"稍微解释了一下:\n```go\n&#47;&#47;          变量名称(innerFunc)  类型(函数类型)  返回值(函数类型)\nfunc timeSpent(innerFunc func(op int) int) func(op int) int {\n\t&#47;&#47; 返回一个函数, 这个函数又一个整形入参 n\n\treturn func(n int) int {\n\t\t&#47;&#47; 函数开始执行时间\n\t\tstart := time.Now()\n\t\tret := innerFunc(n)\n\t\t&#47;&#47; 打印计算出的 函数执行花费的时间\n\t\tfmt.Println(&quot;Time Spent: &quot;, time.Since(start).Seconds())\n\n\t\t&#47;&#47; 返回 传入函数(也就是 innerFunc)的返回值\n\t\treturn ret\n\t}\n}\n\n&#47;&#47; 定义一个符合 timeSpent 入参的函数, 供后面测试\nfunc slowFlow(n int) int {\n\ttime.Sleep(time.Second * 1)\n\treturn n\n}\n\nfunc TestFn(t *testing.T) {\n\ta, b := returnMultiValues()\n\tt.Log(a, b)\n\n\t&#47;&#47; 调用 timeSpent 函数, 传入 slowFlow 函数\n\tret := timeSpent(slowFlow)\n\t&#47;&#47; 打印返回值\n\tt.Log(ret(10))\n}\n```","like_count":0},{"had_liked":false,"id":91673,"user_name":"张sir","can_delete":false,"product_type":"c3","uid":1209431,"ip_address":"","ucode":"52958DF6705208","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJSmAhbvPia1msvk91m5rQLTpicY85f2moFMCcAibictL3OeiaaVREadpHN2O3FwicmylwiclTUJJa1peS1Q/132","comment_is_top":false,"comment_ctime":1557070169,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"可变长参数应该是切片吧","like_count":0}]}