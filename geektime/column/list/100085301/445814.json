{"id":445814,"title":"35ï½œå®æ“é¡¹ç›®ï¼šå¦‚ä½•å®ç°ä¸€ä¸ªåŸºæœ¬çš„MPSC channelï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯é™ˆå¤©ã€‚</p><p>é€šè¿‡ä¸Šä¸¤è®²çš„å­¦ä¹ ï¼Œç›¸ä¿¡ä½ å·²ç»æ„è¯†åˆ°ï¼Œè™½ç„¶å¹¶å‘åŸè¯­çœ‹ä¸Šå»æ˜¯å¾ˆåº•å±‚ã€å¾ˆç¥ç§˜çš„ä¸œè¥¿ï¼Œä½†å®ç°èµ·æ¥ä¹Ÿå¹¶ä¸åƒæƒ³è±¡ä¸­çš„é‚£ä¹ˆå›°éš¾ï¼Œå°¤å…¶æ˜¯åœ¨ Rust ä¸‹ï¼Œåœ¨<a href=\"https://time.geekbang.org/column/article/442216\">ç¬¬ 33 è®²</a>ä¸­ï¼Œæˆ‘ä»¬ç”¨äº†å‡ åè¡Œä»£ç å°±å®ç°äº†ä¸€ä¸ªç®€å•çš„ SpinLockã€‚</p><p>ä½ ä¹Ÿè®¸ä¼šè§‰å¾—ä¸å¤ªè¿‡ç˜¾ï¼Œè€Œä¸” SpinLock ä¹Ÿä¸æ˜¯ç»å¸¸ä½¿ç”¨çš„å¹¶å‘åŸè¯­ï¼Œé‚£ä¹ˆä»Šå¤©ï¼Œæˆ‘ä»¬è¯•ç€å®ç°ä¸€ä¸ªä½¿ç”¨éå¸¸å¹¿æ³›çš„ MPSC channel å¦‚ä½•ï¼Ÿ</p><p>ä¹‹å‰æˆ‘ä»¬è°ˆè®ºäº†å¦‚ä½•åœ¨æœç´¢å¼•æ“çš„ Index writer ä¸Šä½¿ç”¨ MPSC channelï¼šè¦æ›´æ–° index çš„ä¸Šä¸‹æ–‡æœ‰å¾ˆå¤šï¼ˆå¯ä»¥æ˜¯çº¿ç¨‹ä¹Ÿå¯ä»¥æ˜¯å¼‚æ­¥ä»»åŠ¡ï¼‰ï¼Œè€Œ IndexWriter åªèƒ½æ˜¯å”¯ä¸€çš„ã€‚ä¸ºäº†é¿å…åœ¨è®¿é—® IndexWriter æ—¶åŠ é”ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ MPSC channelï¼Œåœ¨å¤šä¸ªä¸Šä¸‹æ–‡ä¸­ç»™ channel å‘æ¶ˆæ¯ï¼Œç„¶ååœ¨å”¯ä¸€æ‹¥æœ‰ IndexWriter çš„çº¿ç¨‹ä¸­è¯»å–è¿™äº›æ¶ˆæ¯ï¼Œéå¸¸é«˜æ•ˆã€‚</p><p>å¥½ï¼Œæ¥çœ‹çœ‹ä»Šå¤©è¦å®ç°çš„ MPSC channel çš„åŸºæœ¬åŠŸèƒ½ã€‚ä¸ºäº†ç®€ä¾¿èµ·è§ï¼Œæˆ‘ä»¬åªå…³å¿ƒ unbounded MPSC channelã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“é˜Ÿåˆ—å®¹é‡ä¸å¤Ÿæ—¶ï¼Œä¼šè‡ªåŠ¨æ‰©å®¹ï¼Œæ‰€ä»¥ï¼Œ<strong>ä»»ä½•æ—¶å€™ç”Ÿäº§è€…å†™å…¥æ•°æ®éƒ½ä¸ä¼šè¢«é˜»å¡ï¼Œä½†æ˜¯å½“é˜Ÿåˆ—ä¸­æ²¡æœ‰æ•°æ®æ—¶ï¼Œæ¶ˆè´¹è€…ä¼šè¢«é˜»å¡</strong>ï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/cf/a2/cfb839fc9c21f9ec51930c063f0ffda2.jpg?wh=2364x1355\" alt=\"\"></p><h2>æµ‹è¯•é©±åŠ¨çš„è®¾è®¡</h2><p>ä¹‹å‰æˆ‘ä»¬ä¼šä»éœ€æ±‚çš„è§’åº¦æ¥è®¾è®¡æ¥å£å’Œæ•°æ®ç»“æ„ï¼Œä»Šå¤©æˆ‘ä»¬å°±æ¢ç§æ–¹å¼ï¼Œå®Œå…¨ç«™åœ¨ä½¿ç”¨è€…çš„è§’åº¦ï¼Œç”¨ä½¿ç”¨å®ä¾‹ï¼ˆæµ‹è¯•ï¼‰æ¥é©±åŠ¨æ¥å£å’Œæ•°æ®ç»“æ„çš„è®¾è®¡ã€‚</p><!-- [[[read_end]]] --><h3>éœ€æ±‚ 1</h3><p>è¦å®ç°åˆšæ‰è¯´çš„ MPSC channelï¼Œéƒ½æœ‰ä»€ä¹ˆéœ€æ±‚å‘¢ï¼Ÿé¦–å…ˆï¼Œç”Ÿäº§è€…å¯ä»¥äº§ç”Ÿæ•°æ®ï¼Œæ¶ˆè´¹è€…èƒ½å¤Ÿæ¶ˆè´¹äº§ç”Ÿå‡ºæ¥çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯åŸºæœ¬çš„ send/recvï¼Œæˆ‘ä»¬ä»¥ä¸‹é¢è¿™ä¸ªå•å…ƒæµ‹è¯• 1 æ¥æè¿°è¿™ä¸ªéœ€æ±‚ï¼š</p><pre><code class=\"language-rust\">#[test]\nfn channel_should_work() {\n    let (mut s, mut r) = unbounded();\n    s.send(\"hello world!\".to_string()).unwrap();\n    let msg = r.recv().unwrap();\n    assert_eq!(msg, \"hello world!\");\n}\n</code></pre><p>è¿™é‡Œï¼Œé€šè¿‡ unbounded() æ–¹æ³•ï¼Œ å¯ä»¥åˆ›å»ºä¸€ä¸ª senderå’Œä¸€ä¸ª receiverï¼Œsender æœ‰ send() æ–¹æ³•ï¼Œå¯ä»¥å‘é€æ•°æ®ï¼Œreceiver æœ‰ recv() æ–¹æ³•ï¼Œå¯ä»¥æ¥å—æ•°æ®ã€‚æ•´ä½“çš„æ¥å£ï¼Œæˆ‘ä»¬è®¾è®¡å’Œ <a href=\"https://doc.rust-lang.org/std/sync/mpsc/index.html\">std::sync::mpsc</a> ä¿æŒä¸€è‡´ï¼Œé¿å…ä½¿ç”¨è€…ä½¿ç”¨ä¸Šçš„å¿ƒæ™ºè´Ÿæ‹…ã€‚</p><p>ä¸ºäº†å®ç°è¿™æ ·ä¸€ä¸ªæ¥å£ï¼Œéœ€è¦ä»€ä¹ˆæ ·çš„æ•°æ®ç»“æ„å‘¢ï¼Ÿé¦–å…ˆï¼Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´ä¼šå…±äº«ä¸€ä¸ªé˜Ÿåˆ—ï¼Œä¸Šä¸€è®²æˆ‘ä»¬è¯´åˆ°ï¼Œå¯ä»¥ç”¨ VecDequeã€‚æ˜¾ç„¶ï¼Œè¿™ä¸ªé˜Ÿåˆ—åœ¨æ’å…¥å’Œå–å‡ºæ•°æ®æ—¶éœ€è¦äº’æ–¥ï¼Œæ‰€ä»¥éœ€è¦ç”¨ Mutex æ¥ä¿æŠ¤å®ƒã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å¤§æ¦‚å¯ä»¥å¾—åˆ°è¿™æ ·ä¸€ä¸ªç»“æ„ï¼š</p><pre><code class=\"language-rust\">struct Shared&lt;T&gt; {\n    queue: Mutex&lt;VecDeque&lt;T&gt;&gt;,\n}\n\npub struct Sender&lt;T&gt; {\n    shared: Arc&lt;Shared&lt;T&gt;&gt;,\n}\n\npub struct Receiver&lt;T&gt; {\n    shared: Arc&lt;Shared&lt;T&gt;&gt;,\n}\n</code></pre><p>è¿™æ ·çš„æ•°æ®ç»“æ„åº”è¯¥å¯ä»¥æ»¡è¶³å•å…ƒæµ‹è¯• 1ã€‚</p><h3>éœ€æ±‚ 2</h3><p>ç”±äºéœ€è¦çš„æ˜¯ MPSCï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬å…è®¸å¤šä¸ª sender å¾€ channel é‡Œå‘é€æ•°æ®ï¼Œç”¨å•å…ƒæµ‹è¯• 2 æ¥æè¿°è¿™ä¸ªéœ€æ±‚ï¼š</p><pre><code class=\"language-rust\">#[test]\nfn multiple_senders_should_work() {\n    let (mut s, mut r) = unbounded();\n    let mut s1 = s.clone();\n    let mut s2 = s.clone();\n    let t = thread::spawn(move || {\n        s.send(1).unwrap();\n    });\n    let t1 = thread::spawn(move || {\n        s1.send(2).unwrap();\n    });\n    let t2 = thread::spawn(move || {\n        s2.send(3).unwrap();\n    });\n    for handle in [t, t1, t2] {\n        handle.join().unwrap();\n    }\n\n    let mut result = [r.recv().unwrap(), r.recv().unwrap(), r.recv().unwrap()];\n    // åœ¨è¿™ä¸ªæµ‹è¯•é‡Œï¼Œæ•°æ®åˆ°è¾¾çš„é¡ºåºæ˜¯ä¸ç¡®å®šçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æ’ä¸ªåºå† assert\n    result.sort();\n\n    assert_eq!(result, [1, 2, 3]);\n}\n</code></pre><p>è¿™ä¸ªéœ€æ±‚ï¼Œåˆšæ‰çš„æ•°æ®ç»“æ„å°±å¯ä»¥æ»¡è¶³ï¼Œåªæ˜¯ Sender éœ€è¦å®ç° Clone traitã€‚ä¸è¿‡æˆ‘ä»¬åœ¨å†™è¿™ä¸ªæµ‹è¯•çš„æ—¶å€™ç¨å¾®æœ‰äº›åˆ«æ‰­ï¼Œå› ä¸ºè¿™ä¸€è¡Œæœ‰ä¸æ–­é‡å¤çš„ä»£ç ï¼š</p><pre><code class=\"language-rust\">let mut result = [r.recv().unwrap(), r.recv().unwrap(), r.recv().unwrap()];\n</code></pre><p>æ³¨æ„ï¼Œæµ‹è¯•ä»£ç çš„ DRY ä¹Ÿå¾ˆé‡è¦ï¼Œæˆ‘ä»¬ä¹‹å‰å¼ºè°ƒè¿‡ã€‚æ‰€ä»¥ï¼Œå½“å†™ä¸‹è¿™ä¸ªæµ‹è¯•çš„æ—¶å€™ï¼Œä¹Ÿè®¸ä¼šæƒ³ï¼Œæˆ‘ä»¬å¯å¦æä¾› Iterator çš„å®ç°ï¼Ÿæ©è¿™ä¸ªæƒ³æ³•å…ˆæš‚å­˜ä¸‹æ¥ã€‚</p><h3>éœ€æ±‚ 3</h3><p>æ¥ä¸‹æ¥è€ƒè™‘å½“é˜Ÿåˆ—ç©ºçš„æ—¶å€™ï¼Œreceiver æ‰€åœ¨çš„çº¿ç¨‹ä¼šè¢«é˜»å¡è¿™ä¸ªéœ€æ±‚ã€‚é‚£ä¹ˆï¼Œå¦‚ä½•å¯¹è¿™ä¸ªéœ€æ±‚è¿›è¡Œæµ‹è¯•å‘¢ï¼Ÿè¿™å¹¶ä¸ç®€å•ï¼Œæˆ‘ä»¬æ²¡æœ‰æ¯”è¾ƒç›´è§‚çš„æ–¹å¼æ¥æ£€æµ‹çº¿ç¨‹çš„çŠ¶æ€ã€‚</p><p><strong>ä¸è¿‡ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ£€æµ‹â€œçº¿ç¨‹æ˜¯å¦é€€å‡ºâ€æ¥é—´æ¥åˆ¤æ–­çº¿ç¨‹æ˜¯å¦è¢«é˜»å¡</strong>ã€‚ç†ç”±å¾ˆç®€å•ï¼Œå¦‚æœçº¿ç¨‹æ²¡æœ‰ç»§ç»­å·¥ä½œï¼Œåˆæ²¡æœ‰é€€å‡ºï¼Œé‚£ä¹ˆä¸€å®šè¢«é˜»å¡ä½äº†ã€‚é˜»å¡ä½ä¹‹åï¼Œæˆ‘ä»¬ç»§ç»­å‘é€æ•°æ®ï¼Œæ¶ˆè´¹è€…æ‰€åœ¨çš„çº¿ç¨‹ä¼šè¢«å”¤é†’ï¼Œç»§ç»­å·¥ä½œï¼Œæ‰€ä»¥æœ€ç»ˆé˜Ÿåˆ—é•¿åº¦åº”è¯¥ä¸º 0ã€‚æˆ‘ä»¬çœ‹å•å…ƒæµ‹è¯• 3ï¼š</p><pre><code class=\"language-rust\">#[test]\nfn receiver_should_be_blocked_when_nothing_to_read() {\n    let (mut s, r) = unbounded();\n    let mut s1 = s.clone();\n    thread::spawn(move || {\n        for (idx, i) in r.into_iter().enumerate() {\n            // å¦‚æœè¯»åˆ°æ•°æ®ï¼Œç¡®ä¿å®ƒå’Œå‘é€çš„æ•°æ®ä¸€è‡´\n            assert_eq!(idx, i);\n        }\n        // è¯»ä¸åˆ°åº”è¯¥ä¼‘çœ ï¼Œæ‰€ä»¥ä¸ä¼šæ‰§è¡Œåˆ°è¿™ä¸€å¥ï¼Œæ‰§è¡Œåˆ°è¿™ä¸€å¥è¯´æ˜é€»è¾‘å‡ºé”™\n        assert!(false);\n    });\n\n    thread::spawn(move || {\n        for i in 0..100usize {\n            s.send(i).unwrap();\n        }\n    });\n\n    // 1ms è¶³å¤Ÿè®©ç”Ÿäº§è€…å‘å®Œ 100 ä¸ªæ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…æ¶ˆè´¹å®Œ 100 ä¸ªæ¶ˆæ¯å¹¶é˜»å¡\n    thread::sleep(Duration::from_millis(1));\n\n    // å†æ¬¡å‘é€æ•°æ®ï¼Œå”¤é†’æ¶ˆè´¹è€…\n    for i in 100..200usize {\n        s1.send(i).unwrap();\n    }\n\n    // ç•™ç‚¹æ—¶é—´è®© receiver å¤„ç†\n    thread::sleep(Duration::from_millis(1));\n\n    // å¦‚æœ receiver è¢«æ­£å¸¸å”¤é†’å¤„ç†ï¼Œé‚£ä¹ˆé˜Ÿåˆ—é‡Œçš„æ•°æ®ä¼šéƒ½è¢«è¯»å®Œ\n    assert_eq!(s1.total_queued_items(), 0);\n}\n</code></pre><p>è¿™ä¸ªæµ‹è¯•ä»£ç ä¸­ï¼Œæˆ‘ä»¬å‡å®š receiver å®ç°äº† Iteratorï¼Œè¿˜å‡å®š sender æä¾›äº†ä¸€ä¸ªæ–¹æ³•total_queued_items()ã€‚è¿™äº›å¯ä»¥åœ¨å®ç°çš„æ—¶å€™å†å¤„ç†ã€‚</p><p>ä½ å¯ä»¥èŠ±äº›æ—¶é—´ä»”ç»†çœ‹çœ‹è¿™æ®µä»£ç ï¼Œæƒ³æƒ³å…¶ä¸­çš„å¤„ç†é€»è¾‘ã€‚è™½ç„¶ä»£ç å¾ˆç®€å•ï¼Œä¸éš¾ç†è§£ï¼Œä½†æ˜¯æŠŠä¸€ä¸ªå®Œæ•´çš„éœ€æ±‚è½¬åŒ–æˆåˆé€‚çš„æµ‹è¯•ä»£ç ï¼Œè¿˜æ˜¯è¦é¢‡è´¹äº›å¿ƒæ€çš„ã€‚</p><p>å¥½ï¼Œå¦‚æœè¦èƒ½æ”¯æŒé˜Ÿåˆ—ä¸ºç©ºæ—¶é˜»å¡ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ <a href=\"https://doc.rust-lang.org/std/sync/struct.Condvar.html\">Condvar</a>ã€‚æ‰€ä»¥ Shared&lt;T&gt; éœ€è¦ä¿®æ”¹ä¸€ä¸‹ï¼š</p><pre><code class=\"language-rust\">struct Shared&lt;T&gt; {\n    queue: Mutex&lt;VecDeque&lt;T&gt;&gt;,\n    available: Condvar,\n}\n</code></pre><p>è¿™æ ·å½“å®ç° Receiver çš„ recv() æ–¹æ³•åï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¯»ä¸åˆ°æ•°æ®æ—¶é˜»å¡çº¿ç¨‹ï¼š</p><pre><code class=\"language-rust\">// æ‹¿åˆ°é”\nlet mut inner = self.shared.queue.lock().unwrap();\n// ... å‡è®¾è¯»ä¸åˆ°æ•°æ®\n// ä½¿ç”¨ condvar å’Œ MutexGuard é˜»å¡å½“å‰çº¿ç¨‹\nself.shared.available.wait(inner)\n</code></pre><h3>éœ€æ±‚ 4</h3><p>é¡ºç€åˆšæ‰çš„å¤šä¸ª senderæƒ³ï¼Œå¦‚æœç°åœ¨æ‰€æœ‰ Sender éƒ½é€€å‡ºä½œç”¨åŸŸï¼ŒReceiver ç»§ç»­æ¥æ”¶ï¼Œåˆ°æ²¡æœ‰æ•°æ®å¯è¯»äº†ï¼Œè¯¥æ€ä¹ˆå¤„ç†ï¼Ÿæ˜¯ä¸æ˜¯åº”è¯¥äº§ç”Ÿä¸€ä¸ªé”™è¯¯ï¼Œè®©è°ƒç”¨è€…çŸ¥é“ï¼Œç°åœ¨ channel çš„å¦ä¸€ä¾§å·²ç»æ²¡æœ‰ç”Ÿäº§è€…äº†ï¼Œå†è¯»ä¹Ÿè¯»ä¸å‡ºæ•°æ®äº†ï¼Ÿ</p><p>æˆ‘ä»¬æ¥å†™å•å…ƒæµ‹è¯• 4ï¼š</p><pre><code class=\"language-rust\">#[test]\nfn last_sender_drop_should_error_when_receive() {\n    let (s, mut r) = unbounded();\n    let s1 = s.clone();\n    let senders = [s, s1];\n    let total = senders.len();\n\n    // sender å³ç”¨å³æŠ›\n    for mut sender in senders {\n        thread::spawn(move || {\n            sender.send(\"hello\").unwrap();\n            // sender åœ¨æ­¤è¢«ä¸¢å¼ƒ\n        })\n        .join()\n        .unwrap();\n    }\n\n    // è™½ç„¶æ²¡æœ‰ sender äº†ï¼Œæ¥æ”¶è€…ä¾ç„¶å¯ä»¥æ¥å—å·²ç»åœ¨é˜Ÿåˆ—é‡Œçš„æ•°æ®\n    for _ in 0..total {\n        r.recv().unwrap();\n    }\n\n    // ç„¶è€Œï¼Œè¯»å–æ›´å¤šæ•°æ®æ—¶ä¼šå‡ºé”™\n    assert!(r.recv().is_err());\n}\n</code></pre><p>è¿™ä¸ªæµ‹è¯•ä¾æ—§å¾ˆç®€å•ã€‚ä½ å¯ä»¥æƒ³è±¡ä¸€ä¸‹ï¼Œä½¿ç”¨ä»€ä¹ˆæ ·çš„æ•°æ®ç»“æ„å¯ä»¥è¾¾åˆ°è¿™æ ·çš„ç›®çš„ã€‚</p><p>é¦–å…ˆï¼Œæ¯æ¬¡ Clone æ—¶ï¼Œè¦å¢åŠ  Sender çš„è®¡æ•°ï¼›åœ¨ Sender Drop æ—¶ï¼Œå‡å°‘è¿™ä¸ªè®¡æ•°ï¼›ç„¶åï¼Œæˆ‘ä»¬ä¸º Receiver æä¾›ä¸€ä¸ªæ–¹æ³• total_senders()ï¼Œæ¥è¯»å– Sender çš„è®¡æ•°ï¼Œå½“è®¡æ•°ä¸º 0ï¼Œä¸”é˜Ÿåˆ—ä¸­æ²¡æœ‰æ•°æ®å¯è¯»æ—¶ï¼Œrecv() æ–¹æ³•å°±æŠ¥é”™ã€‚</p><p>æœ‰äº†è¿™ä¸ªæ€è·¯ï¼Œä½ æƒ³ä¸€æƒ³ï¼Œè¿™ä¸ªè®¡æ•°å™¨ç”¨ä»€ä¹ˆæ•°æ®ç»“æ„å‘¢ï¼Ÿç”¨é”ä¿æŠ¤ä¹ˆï¼Ÿ</p><p>å“ˆï¼Œä½ ä¸€å®šæƒ³åˆ°äº†å¯ä»¥ä½¿ç”¨ atomicsã€‚å¯¹ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ AtomicUsizeã€‚æ‰€ä»¥ï¼ŒShared æ•°æ®ç»“æ„éœ€è¦æ›´æ–°ä¸€ä¸‹ï¼š</p><pre><code class=\"language-rust\">struct Shared&lt;T&gt; {\n    queue: Mutex&lt;VecDeque&lt;T&gt;&gt;,\n    available: Condvar,\n    senders: AtomicUsize,\n}\n</code></pre><h3>éœ€æ±‚ 5</h3><p>æ—¢ç„¶æ²¡æœ‰ Sender äº†è¦æŠ¥é”™ï¼Œé‚£ä¹ˆå¦‚æœæ²¡æœ‰ Receiveräº†ï¼ŒSender å‘é€æ—¶æ˜¯ä¸æ˜¯ä¹Ÿåº”è¯¥é”™è¯¯è¿”å›ï¼Ÿè¿™ä¸ªéœ€æ±‚å’Œä¸Šé¢ç±»ä¼¼ï¼Œå°±ä¸èµ˜è¿°äº†ã€‚çœ‹æ„é€ çš„å•å…ƒæµ‹è¯• 5ï¼š</p><pre><code class=\"language-rust\">#[test]\nfn receiver_drop_should_error_when_send() {\n    let (mut s1, mut s2) = {\n        let (s, _) = unbounded();\n        let s1 = s.clone();\n        let s2 = s.clone();\n        (s1, s2)\n    };\n\n    assert!(s1.send(1).is_err());\n    assert!(s2.send(1).is_err());\n}\n</code></pre><p>è¿™é‡Œï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª channelï¼Œäº§ç”Ÿä¸¤ä¸ª Sender åä¾¿ç«‹å³ä¸¢å¼ƒ Receiverã€‚ä¸¤ä¸ª Sender åœ¨å‘é€æ—¶éƒ½ä¼šå‡ºé”™ã€‚</p><p>åŒæ ·çš„ï¼ŒShared æ•°æ®ç»“æ„è¦æ›´æ–°ä¸€ä¸‹ï¼š</p><pre><code class=\"language-rust\">struct Shared&lt;T&gt; {\n    queue: Mutex&lt;VecDeque&lt;T&gt;&gt;,\n    available: Condvar,\n    senders: AtomicUsize,\n    receivers: AtomicUsize,\n}\n</code></pre><h2>å®ç° MPSC channel</h2><p>ç°åœ¨å†™äº†äº”ä¸ªå•å…ƒæµ‹è¯•ï¼Œæˆ‘ä»¬å·²ç»æŠŠéœ€æ±‚æ‘¸é€äº†ï¼Œå¹¶ä¸”æœ‰äº†åŸºæœ¬çš„æ¥å£å’Œæ•°æ®ç»“æ„çš„è®¾è®¡ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥å†™å®ç°çš„ä»£ç ã€‚</p><p>åˆ›å»ºä¸€ä¸ªæ–°çš„é¡¹ç›® <code>cargo new con_utils --lib</code>ã€‚åœ¨ cargo.toml ä¸­æ·»åŠ  anyhow ä½œä¸ºä¾èµ–ã€‚åœ¨ <a href=\"http://lib.rs\">lib.rs</a> é‡Œï¼Œæˆ‘ä»¬å°±å†™å…¥ä¸€å¥ï¼š<code>pub mod channel</code> , ç„¶ååˆ›å»º src/channel.rsï¼ŒæŠŠåˆšæ‰è®¾è®¡æ—¶ä½¿ç”¨çš„ test caseã€è®¾è®¡çš„æ•°æ®ç»“æ„ï¼Œä»¥åŠ test case é‡Œä½¿ç”¨åˆ°çš„æ¥å£ï¼Œç”¨ä»£ç å…¨éƒ¨æ”¾è¿›æ¥ï¼š</p><pre><code class=\"language-rust\">use anyhow::Result;\nuse std::{\n    collections::VecDeque,\n    sync::{atomic::AtomicUsize, Arc, Condvar, Mutex},\n};\n\n/// å‘é€è€…\npub struct Sender&lt;T&gt; {\n    shared: Arc&lt;Shared&lt;T&gt;&gt;,\n}\n\n/// æ¥æ”¶è€…\npub struct Receiver&lt;T&gt; {\n    shared: Arc&lt;Shared&lt;T&gt;&gt;,\n}\n\n/// å‘é€è€…å’Œæ¥æ”¶è€…ä¹‹é—´å…±äº«ä¸€ä¸ª VecDequeï¼Œç”¨ Mutex äº’æ–¥ï¼Œç”¨ Condvar é€šçŸ¥\n/// åŒæ—¶ï¼Œæˆ‘ä»¬è®°å½•æœ‰å¤šå°‘ä¸ª senders å’Œ receivers\n\nstruct Shared&lt;T&gt; {\n    queue: Mutex&lt;VecDeque&lt;T&gt;&gt;,\n    available: Condvar,\n    senders: AtomicUsize,\n    receivers: AtomicUsize,\n}\n\nimpl&lt;T&gt; Sender&lt;T&gt; {\n    /// ç”Ÿäº§è€…å†™å…¥ä¸€ä¸ªæ•°æ®\n    pub fn send(&amp;mut self, t: T) -&gt; Result&lt;()&gt; {\n        todo!()\n    }\n\n    pub fn total_receivers(&amp;self) -&gt; usize {\n        todo!()\n    }\n\n    pub fn total_queued_items(&amp;self) -&gt; usize {\n        todo!()\n    }\n}\n\nimpl&lt;T&gt; Receiver&lt;T&gt; {\n    pub fn recv(&amp;mut self) -&gt; Result&lt;T&gt; {\n        todo!()\n    }\n\n    pub fn total_senders(&amp;self) -&gt; usize {\n        todo!()\n    }\n}\n\nimpl&lt;T&gt; Iterator for Receiver&lt;T&gt; {\n    type Item = T;\n\n    fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt; {\n        todo!()\n    }\n}\n\n/// å…‹éš† sender\nimpl&lt;T&gt; Clone for Sender&lt;T&gt; {\n    fn clone(&amp;self) -&gt; Self {\n        todo!()\n    }\n}\n\n/// Drop sender\nimpl&lt;T&gt; Drop for Sender&lt;T&gt; {\n    fn drop(&amp;mut self) {\n        todo!()\n    }\n}\n\nimpl&lt;T&gt; Drop for Receiver&lt;T&gt; {\n    fn drop(&amp;mut self) {\n        todo!()\n    }\n}\n\n/// åˆ›å»ºä¸€ä¸ª unbounded channel\npub fn unbounded&lt;T&gt;() -&gt; (Sender&lt;T&gt;, Receiver&lt;T&gt;) {\n    todo!()\n}\n\n#[cfg(test)]\nmod tests {\n    use std::{thread, time::Duration};\n\n    use super::*;\n\t\t// æ­¤å¤„çœç•¥æ‰€æœ‰ test case\n}\n</code></pre><p>ç›®å‰è¿™ä¸ªä»£ç è™½ç„¶èƒ½å¤Ÿç¼–è¯‘é€šè¿‡ï¼Œä½†å› ä¸ºæ²¡æœ‰ä»»ä½•å®ç°ï¼Œæ‰€ä»¥ cargo test å…¨éƒ¨å‡ºé”™ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥ä¸€ç‚¹ç‚¹å®ç°åŠŸèƒ½ã€‚</p><h3>åˆ›å»º unbounded channel</h3><p>åˆ›å»º unbounded channel çš„æ¥å£å¾ˆç®€å•ï¼š</p><pre><code class=\"language-rust\">pub fn unbounded&lt;T&gt;() -&gt; (Sender&lt;T&gt;, Receiver&lt;T&gt;) {\n    let shared = Shared::default();\n    let shared = Arc::new(shared);\n    (\n        Sender {\n            shared: shared.clone(),\n        },\n        Receiver { shared },\n    )\n}\n\nconst INITIAL_SIZE: usize = 32;\nimpl&lt;T&gt; Default for Shared&lt;T&gt; {\n    fn default() -&gt; Self {\n        Self {\n            queue: Mutex::new(VecDeque::with_capacity(INITIAL_SIZE)),\n            available: Condvar::new(),\n            senders: AtomicUsize::new(1),\n            receivers: AtomicUsize::new(1),\n        }\n    }\n}\n</code></pre><p>å› ä¸ºè¿™é‡Œä½¿ç”¨ default() åˆ›å»ºäº† Shared&lt;T&gt; ç»“æ„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸ºå…¶å®ç° Defaultã€‚åˆ›å»ºæ—¶ï¼Œæˆ‘ä»¬æœ‰ 1 ä¸ªç”Ÿäº§è€…å’Œ1 ä¸ªæ¶ˆè´¹è€…ã€‚</p><h3>å®ç°æ¶ˆè´¹è€…</h3><p>å¯¹äºæ¶ˆè´¹è€…ï¼Œæˆ‘ä»¬ä¸»è¦éœ€è¦å®ç° recv æ–¹æ³•ã€‚</p><p>åœ¨ recv ä¸­ï¼Œå¦‚æœé˜Ÿåˆ—ä¸­æœ‰æ•°æ®ï¼Œé‚£ä¹ˆç›´æ¥è¿”å›ï¼›å¦‚æœæ²¡æ•°æ®ï¼Œä¸”æ‰€æœ‰ç”Ÿäº§è€…éƒ½ç¦»å¼€äº†ï¼Œæˆ‘ä»¬å°±è¿”å›é”™è¯¯ï¼›å¦‚æœæ²¡æ•°æ®ï¼Œä½†è¿˜æœ‰ç”Ÿäº§è€…ï¼Œæˆ‘ä»¬å°±é˜»å¡æ¶ˆè´¹è€…çš„çº¿ç¨‹ï¼š</p><pre><code class=\"language-rust\">impl&lt;T&gt; Receiver&lt;T&gt; {\n    pub fn recv(&amp;mut self) -&gt; Result&lt;T&gt; {\n        // æ‹¿åˆ°é˜Ÿåˆ—çš„é”\n        let mut inner = self.shared.queue.lock().unwrap();\n        loop {\n            match inner.pop_front() {\n                // è¯»åˆ°æ•°æ®è¿”å›ï¼Œé”è¢«é‡Šæ”¾\n                Some(t) =&gt; {\n                    return Ok(t);\n                }\n                // è¯»ä¸åˆ°æ•°æ®ï¼Œå¹¶ä¸”ç”Ÿäº§è€…éƒ½é€€å‡ºäº†ï¼Œé‡Šæ”¾é”å¹¶è¿”å›é”™è¯¯\n                None if self.total_senders() == 0 =&gt; return Err(anyhow!(\"no sender left\")),\n                // è¯»ä¸åˆ°æ•°æ®ï¼ŒæŠŠé”æäº¤ç»™ available Condvarï¼Œå®ƒä¼šé‡Šæ”¾é”å¹¶æŒ‚èµ·çº¿ç¨‹ï¼Œç­‰å¾… notify\n                None =&gt; {\n                    // å½“ Condvar è¢«å”¤é†’åä¼šè¿”å› MutexGuardï¼Œæˆ‘ä»¬å¯ä»¥ loop å›å»æ‹¿æ•°æ®\n                    // è¿™æ˜¯ä¸ºä»€ä¹ˆ Condvar è¦åœ¨ loop é‡Œä½¿ç”¨\n                    inner = self\n                        .shared\n                        .available\n                        .wait(inner)\n                        .map_err(|_| anyhow!(\"lock poisoned\"))?;\n                }\n            }\n        }\n    }\n\n    pub fn total_senders(&amp;self) -&gt; usize {\n        self.shared.senders.load(Ordering::SeqCst)\n    }\n}\n</code></pre><p>æ³¨æ„çœ‹è¿™é‡Œ Condvar çš„ä½¿ç”¨ã€‚</p><p>åœ¨ wait() æ–¹æ³•é‡Œï¼Œå®ƒæ¥æ”¶ä¸€ä¸ª MutexGuardï¼Œç„¶åé‡Šæ”¾è¿™ä¸ª Mutexï¼ŒæŒ‚èµ·çº¿ç¨‹ã€‚ç­‰å¾—åˆ°é€šçŸ¥åï¼Œå®ƒä¼šå†è·å–é”ï¼Œå¾—åˆ°ä¸€ä¸ª MutexGuardï¼Œè¿”å›ã€‚æ‰€ä»¥è¿™é‡Œæ˜¯ï¼š</p><pre><code class=\"language-rust\">inner = self.shared.available.wait(inner).map_err(|_| anyhow!(\"lock poisoned\"))?;\n</code></pre><p>å› ä¸º recv() ä¼šè¿”å›ä¸€ä¸ªå€¼ï¼Œæ‰€ä»¥é˜»å¡å›æ¥ä¹‹åï¼Œæˆ‘ä»¬åº”è¯¥å¾ªç¯å›å»æ‹¿æ•°æ®ã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆè¿™æ®µé€»è¾‘è¦è¢« loop {} åŒ…è£¹ã€‚æˆ‘ä»¬å‰é¢åœ¨è®¾è®¡æ—¶è€ƒè™‘è¿‡ï¼šå½“å‘é€è€…å‘é€æ•°æ®æ—¶ï¼Œåº”è¯¥é€šçŸ¥è¢«é˜»å¡çš„æ¶ˆè´¹è€…ã€‚æ‰€ä»¥ï¼Œåœ¨å®ç° Sender çš„ send() æ—¶ï¼Œéœ€è¦åšç›¸åº”çš„ notify å¤„ç†ã€‚</p><p>è®°å¾—è¿˜è¦å¤„ç†æ¶ˆè´¹è€…çš„ dropï¼š</p><pre><code class=\"language-rust\">impl&lt;T&gt; Drop for Receiver&lt;T&gt; {\n    fn drop(&amp;mut self) {\n        self.shared.receivers.fetch_sub(1, Ordering::AcqRel);\n    }\n}\n</code></pre><p>å¾ˆç®€å•ï¼Œæ¶ˆè´¹è€…ç¦»å¼€æ—¶ï¼Œå°† receivers å‡ä¸€ã€‚</p><h3>å®ç°ç”Ÿäº§è€…</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ç”Ÿäº§è€…çš„åŠŸèƒ½æ€ä¹ˆå®ç°ã€‚</p><p>é¦–å…ˆï¼Œåœ¨æ²¡æœ‰æ¶ˆè´¹è€…çš„æƒ…å†µä¸‹ï¼Œåº”è¯¥æŠ¥é”™ã€‚æ­£å¸¸åº”è¯¥ä½¿ç”¨ thiserror å®šä¹‰è‡ªå·±çš„é”™è¯¯ï¼Œä¸è¿‡è¿™é‡Œä¸ºäº†ç®€åŒ–ä»£ç ï¼Œå°±ä½¿ç”¨ anyhow! å®äº§ç”Ÿä¸€ä¸ª adhoc çš„é”™è¯¯ã€‚å¦‚æœæ¶ˆè´¹è€…è¿˜åœ¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬è·å– VecDeque çš„é”ï¼ŒæŠŠæ•°æ®å‹å…¥ï¼š</p><pre><code class=\"language-rust\">impl&lt;T&gt; Sender&lt;T&gt; {\n    /// ç”Ÿäº§è€…å†™å…¥ä¸€ä¸ªæ•°æ®\n    pub fn send(&amp;mut self, t: T) -&gt; Result&lt;()&gt; {\n        // å¦‚æœæ²¡æœ‰æ¶ˆè´¹è€…äº†ï¼Œå†™å…¥æ—¶å‡ºé”™\n        if self.total_receivers() == 0 {\n            return Err(anyhow!(\"no receiver left\"));\n        }\n\n        // åŠ é”ï¼Œè®¿é—® VecDequeï¼Œå‹å…¥æ•°æ®ï¼Œç„¶åç«‹åˆ»é‡Šæ”¾é”\n        let was_empty = {\n            let mut inner = self.shared.queue.lock().unwrap();\n            let empty = inner.is_empty();\n            inner.push_back(t);\n            empty\n        };\n\n        // é€šçŸ¥ä»»æ„ä¸€ä¸ªè¢«æŒ‚èµ·ç­‰å¾…çš„æ¶ˆè´¹è€…æœ‰æ•°æ®\n        if was_empty {\n            self.shared.available.notify_one();\n        }\n\n        Ok(())\n    }\n\n    pub fn total_receivers(&amp;self) -&gt; usize {\n        self.shared.receivers.load(Ordering::SeqCst)\n    }\n\n    pub fn total_queued_items(&amp;self) -&gt; usize {\n        let queue = self.shared.queue.lock().unwrap();\n        queue.len()\n    }\n}\n</code></pre><p>è¿™é‡Œï¼Œè·å– total_receivers æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† Ordering::SeqCstï¼Œä¿è¯æ‰€æœ‰çº¿ç¨‹çœ‹åˆ°åŒæ ·é¡ºåºçš„å¯¹ receivers çš„æ“ä½œã€‚è¿™ä¸ªå€¼æ˜¯æœ€æ–°çš„å€¼ã€‚</p><p><strong>åœ¨å‹å…¥æ•°æ®æ—¶ï¼Œéœ€è¦åˆ¤æ–­ä¸€ä¸‹ä¹‹å‰æ˜¯é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼Œå› ä¸ºé˜Ÿåˆ—ä¸ºç©ºçš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦ç”¨ notify_one() æ¥å”¤é†’æ¶ˆè´¹è€…</strong>ã€‚è¿™ä¸ªéå¸¸é‡è¦ï¼Œå¦‚æœæ²¡å¤„ç†çš„è¯ï¼Œä¼šå¯¼è‡´æ¶ˆè´¹è€…é˜»å¡åæ— æ³•å¤åŸæ¥æ”¶æ•°æ®ã€‚</p><p>ç”±äºæˆ‘ä»¬å¯ä»¥æœ‰å¤šä¸ªç”Ÿäº§è€…ï¼Œæ‰€ä»¥è¦å…è®¸å®ƒ cloneï¼š</p><pre><code class=\"language-rust\">impl&lt;T&gt; Clone for Sender&lt;T&gt; {\n    fn clone(&amp;self) -&gt; Self {\n        self.shared.senders.fetch_add(1, Ordering::AcqRel);\n        Self {\n            shared: Arc::clone(&amp;self.shared),\n        }\n    }\n}\n</code></pre><p>å®ç° Clone trait çš„æ–¹æ³•å¾ˆç®€å•ï¼Œä½†è®°å¾—è¦æŠŠ shared.senders åŠ  1ï¼Œä½¿å…¶ä¿æŒå’Œå½“å‰çš„ senders çš„æ•°é‡ä¸€è‡´ã€‚</p><p>å½“ç„¶ï¼Œåœ¨ drop çš„æ—¶å€™æˆ‘ä»¬ä¹Ÿè¦ç»´æŠ¤ shared.senders ä½¿å…¶å‡ 1ï¼š</p><pre><code class=\"language-rust\">impl&lt;T&gt; Drop for Sender&lt;T&gt; {\n    fn drop(&amp;mut self) {\n        self.shared.senders.fetch_sub(1, Ordering::AcqRel);\n        \n    }\n}\n</code></pre><h3>å…¶å®ƒåŠŸèƒ½</h3><p>ç›®å‰è¿˜ç¼ºä¹ Receiver çš„ Iterator çš„å®ç°ï¼Œè¿™ä¸ªå¾ˆç®€å•ï¼Œå°±æ˜¯åœ¨ next() é‡Œè°ƒç”¨ recv() æ–¹æ³•ï¼ŒRust æä¾›äº†æ”¯æŒåœ¨ Option / Result ä¹‹é—´å¾ˆæ–¹ä¾¿è½¬æ¢çš„å‡½æ•°ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡ ok() æ¥å°† Result è½¬æ¢æˆ Optionï¼š</p><pre><code class=\"language-rust\">impl&lt;T&gt; Iterator for Receiver&lt;T&gt; {\n    type Item = T;\n\n    fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt; {\n        self.recv().ok()\n    }\n}\n</code></pre><p>å¥½ï¼Œç›®å‰æ‰€æœ‰éœ€è¦å®ç°çš„ä»£ç éƒ½å®ç°å®Œæ¯•ï¼Œ  <code>cargo test</code> æµ‹è¯•ä¸€ä¸‹ã€‚wowï¼æµ‹è¯•ä¸€æ¬¡æ€§é€šè¿‡ï¼è¿™ä¹Ÿå¤ªé¡ºåˆ©äº†å§ï¼</p><p>æœ€åæ¥ä»”ç»†å®¡è§†ä¸€ä¸‹ä»£ç ã€‚å¾ˆå¿«ï¼Œæˆ‘ä»¬å‘ç° Sender çš„ Drop å®ç°ä¼¼ä¹æœ‰ç‚¹é—®é¢˜ã€‚<strong>å¦‚æœ Receiver è¢«é˜»å¡ï¼Œè€Œæ­¤åˆ»æ‰€æœ‰ Sender éƒ½èµ°äº†ï¼Œé‚£ä¹ˆ Receiver å°±æ²¡æœ‰äººå”¤é†’ï¼Œä¼šå¸¦æ¥èµ„æºçš„æ³„éœ²</strong>ã€‚è¿™æ˜¯ä¸€ä¸ªå¾ˆè¾¹è¾¹è§’è§’çš„é—®é¢˜ï¼Œæ‰€ä»¥ä¹‹å‰çš„æµ‹è¯•æ²¡æœ‰è¦†ç›–åˆ°ã€‚</p><p>æˆ‘ä»¬æ¥è®¾è®¡ä¸€ä¸ªåœºæ™¯è®©è¿™ä¸ªé—®é¢˜æš´éœ²ï¼š</p><pre><code class=\"language-rust\">#[test]\nfn receiver_shall_be_notified_when_all_senders_exit() {\n    let (s, mut r) = unbounded::&lt;usize&gt;();\n    // ç”¨äºä¸¤ä¸ªçº¿ç¨‹åŒæ­¥\n    let (mut sender, mut receiver) = unbounded::&lt;usize&gt;();\n    let t1 = thread::spawn(move || {\n        // ä¿è¯ r.recv() å…ˆäº t2 çš„ drop æ‰§è¡Œ\n        sender.send(0).unwrap();\n        assert!(r.recv().is_err());\n    });\n\n    thread::spawn(move || {\n        receiver.recv().unwrap();\n        drop(s);\n    });\n\n    t1.join().unwrap();\n}\n</code></pre><p>åœ¨æˆ‘è¿›ä¸€æ­¥è§£é‡Šä¹‹å‰ï¼Œä½ å¯ä»¥åœä¸‹æ¥æƒ³æƒ³ä¸ºä»€ä¹ˆè¿™ä¸ªæµ‹è¯•å¯ä»¥ä¿è¯æš´éœ²è¿™ä¸ªé—®é¢˜ï¼Ÿå®ƒæ˜¯æ€ä¹ˆæš´éœ²çš„ï¼Ÿå¦‚æœæƒ³ä¸åˆ°ï¼Œå† <code>cargo test</code> çœ‹çœ‹ä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜ã€‚</p><p>æ¥ä¸€èµ·åˆ†æåˆ†æï¼Œè¿™é‡Œï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸¤ä¸ªçº¿ç¨‹ t1 å’Œ t2ï¼Œåˆ†åˆ«è®©å®ƒä»¬å¤„ç†æ¶ˆè´¹è€…å’Œç”Ÿäº§è€…ã€‚<strong>t1 è¯»å–æ•°æ®ï¼Œæ­¤æ—¶æ²¡æœ‰æ•°æ®ï¼Œæ‰€ä»¥ä¼šé˜»å¡ï¼Œè€Œt2 ç›´æ¥æŠŠç”Ÿäº§è€… drop æ‰</strong>ã€‚æ‰€ä»¥ï¼Œæ­¤åˆ»å¦‚æœæ²¡æœ‰äººå”¤é†’ t1ï¼Œé‚£ä¹ˆ t1.join() å°±ä¼šä¸€ç›´ç­‰å¾…ï¼Œå› ä¸º t1 ä¸€ç›´æ²¡æœ‰é€€å‡ºã€‚</p><p>æ‰€ä»¥ï¼Œä¸ºäº†ä¿è¯ä¸€å®šæ˜¯ t1  <code>r.recv()</code>å…ˆæ‰§è¡Œå¯¼è‡´é˜»å¡ã€t2 å† <code>drop(s)</code>ï¼Œæˆ‘ä»¬ï¼ˆeat your own dog foodï¼‰ç”¨å¦ä¸€ä¸ª channel æ¥æ§åˆ¶ä¸¤ä¸ªçº¿ç¨‹çš„æ‰§è¡Œé¡ºåºã€‚è¿™æ˜¯ä¸€ç§å¾ˆé€šç”¨çš„åšæ³•ï¼Œä½ å¯ä»¥å¥½å¥½ç¢ç£¨ä¸€ä¸‹ã€‚</p><p>è¿è¡Œ <code>cargo test</code> åï¼Œæµ‹è¯•è¢«é˜»å¡ã€‚è¿™æ˜¯å› ä¸ºï¼Œt1 æ²¡æœ‰æœºä¼šå¾—åˆ°å”¤é†’ï¼Œæ‰€ä»¥è¿™ä¸ªæµ‹è¯•å°±åœåœ¨é‚£é‡Œä¸åŠ¨äº†ã€‚</p><p>è¦ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦å¦¥å–„å¤„ç† Sender çš„ Dropï¼š</p><pre><code class=\"language-rust\">impl&lt;T&gt; Drop for Sender&lt;T&gt; {\n    fn drop(&amp;mut self) {\n        let old = self.shared.senders.fetch_sub(1, Ordering::AcqRel);\n        // sender èµ°å…‰äº†ï¼Œå”¤é†’ receiver è¯»å–æ•°æ®ï¼ˆå¦‚æœé˜Ÿåˆ—ä¸­è¿˜æœ‰çš„è¯ï¼‰ï¼Œè¯»ä¸åˆ°å°±å‡ºé”™\n        if old &lt;= 1 {\n            // å› ä¸ºæˆ‘ä»¬å®ç°çš„æ˜¯ MPSCï¼Œreceiver åªæœ‰ä¸€ä¸ªï¼Œæ‰€ä»¥ notify_all å®é™…ç­‰ä»· notify_one\n            self.shared.available.notify_all();\n        }\n    }\n}\n</code></pre><p>è¿™é‡Œï¼Œå¦‚æœå‡ä¸€ä¹‹å‰ï¼Œæ—§çš„ senders çš„æ•°é‡å°äºç­‰äº 1ï¼Œæ„å‘³ç€ç°åœ¨æ˜¯æœ€åä¸€ä¸ª Sender è¦ç¦»å¼€äº†ï¼Œä¸ç®¡æ€æ ·æˆ‘ä»¬éƒ½è¦å”¤é†’ Receiver ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨äº† notify_all()ã€‚å¦‚æœ Receiver ä¹‹å‰å·²ç»è¢«é˜»å¡ï¼Œæ­¤åˆ»å°±èƒ½è¢«å”¤é†’ã€‚ä¿®æ”¹å®Œæˆï¼Œ<code>cargo test</code> ä¸€åˆ‡æ­£å¸¸ã€‚</p><h2>æ€§èƒ½ä¼˜åŒ–</h2><p>ä»åŠŸèƒ½ä¸Šæ¥è¯´ï¼Œç›®å‰æˆ‘ä»¬çš„ MPSC unbounded channel æ²¡æœ‰å¤ªå¤šçš„é—®é¢˜ï¼Œå¯ä»¥åº”ç”¨åœ¨ä»»ä½•éœ€è¦ MPSC channel çš„åœºæ™¯ã€‚ç„¶è€Œï¼Œæ¯æ¬¡è¯»å†™éƒ½éœ€è¦è·å–é”ï¼Œè™½ç„¶é”çš„ç²’åº¦å¾ˆå°ï¼Œä½†è¿˜æ˜¯è®©æ•´ä½“çš„æ€§èƒ½æ‰“äº†ä¸ªæŠ˜æ‰£ã€‚æœ‰æ²¡æœ‰å¯èƒ½ä¼˜åŒ–é”å‘¢ï¼Ÿ</p><p>ä¹‹å‰æˆ‘ä»¬è®²åˆ°ï¼Œä¼˜åŒ–é”çš„æ‰‹æ®µæ— éæ˜¯<strong>å‡å°ä¸´ç•ŒåŒºçš„å¤§å°</strong>ï¼Œè®©æ¯æ¬¡åŠ é”çš„æ—¶é—´å¾ˆçŸ­ï¼Œè¿™æ ·å†²çªçš„å‡ ç‡å°±å˜å°ã€‚å¦å¤–ï¼Œå°±æ˜¯<strong>é™ä½åŠ é”çš„é¢‘ç‡ï¼Œ</strong>å¯¹äºæ¶ˆè´¹è€…æ¥è¯´ï¼Œå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿä¸€æ¬¡æ€§æŠŠé˜Ÿåˆ—ä¸­çš„æ‰€æœ‰æ•°æ®éƒ½è¯»å®Œç¼“å­˜èµ·æ¥ï¼Œä»¥ååœ¨éœ€è¦çš„æ—¶å€™ä»ç¼“å­˜ä¸­è¯»å–ï¼Œè¿™æ ·å°±å¯ä»¥å¤§å¤§å‡å°‘æ¶ˆè´¹è€…åŠ é”çš„é¢‘æ¬¡ã€‚</p><p>é¡ºç€è¿™ä¸ªæ€è·¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ Receiver çš„ç»“æ„ä¸­æ”¾ä¸€ä¸ª cacheï¼š</p><pre><code class=\"language-rust\">pub struct Receiver&lt;T&gt; {\n    shared: Arc&lt;Shared&lt;T&gt;&gt;,\n    cache: VecDeque&lt;T&gt;,\n}\n</code></pre><p>å¦‚æœä½ ä¹‹å‰æœ‰ C è¯­è¨€å¼€å‘çš„ç»éªŒï¼Œä¹Ÿè®¸ä¼šæƒ³ï¼Œåˆ°äº†è¿™ä¸€æ­¥ï¼Œä½•å¿…æŠŠ queue ä¸­çš„æ•°æ®å…¨éƒ¨è¯»å‡ºæ¥ï¼Œå­˜å…¥ Receiver çš„ cache å‘¢ï¼Ÿè¿™æ ·æ•ˆç‡å¤ªä½ï¼Œå¦‚æœèƒ½å¤Ÿç›´æ¥ swap ä¸¤ä¸ªç»“æ„å†…éƒ¨çš„æŒ‡é’ˆï¼Œè¿™æ ·ï¼Œå³ä¾¿é˜Ÿåˆ—ä¸­æœ‰å†å¤šçš„æ•°æ®ï¼Œä¹Ÿæ˜¯ä¸€ä¸ª O(1) çš„æ“ä½œã€‚</p><p>å—¯ï¼Œåˆ«æ€¥ï¼ŒRust æœ‰ç±»ä¼¼çš„ <a href=\"https://doc.rust-lang.org/std/mem/fn.swap.html\">std::mem::swap</a> æ–¹æ³•ã€‚æ¯”å¦‚ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=b68e503ae3413338f770fde2f6c7e861\">ä»£ç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">use std::mem;\n\nfn main() {\n    let mut x = \"hello world\".to_string();\n    let mut y = \"goodbye world\".to_string();\n    \n    mem::swap(&amp;mut x, &amp;mut y);\n    \n    assert_eq!(\"goodbye world\", x);\n    assert_eq!(\"hello world\", y);\n}\n</code></pre><p>å¥½ï¼Œäº†è§£äº† swap æ–¹æ³•ï¼Œæˆ‘ä»¬çœ‹çœ‹å¦‚ä½•ä¿®æ”¹ Receiver çš„ recv() æ–¹æ³•æ¥æå‡æ€§èƒ½ï¼š</p><pre><code class=\"language-rust\">pub fn recv(&amp;mut self) -&gt; Result&lt;T&gt; {\n    // æ— é” fast path\n    if let Some(v) = self.cache.pop_front() {\n        return Ok(v);\n    }\n\n    // æ‹¿åˆ°é˜Ÿåˆ—çš„é”\n    let mut inner = self.shared.queue.lock().unwrap();\n    loop {\n        match inner.pop_front() {\n            // è¯»åˆ°æ•°æ®è¿”å›ï¼Œé”è¢«é‡Šæ”¾\n            Some(t) =&gt; {\n                // å¦‚æœå½“å‰é˜Ÿåˆ—ä¸­è¿˜æœ‰æ•°æ®ï¼Œé‚£ä¹ˆå°±æŠŠæ¶ˆè´¹è€…è‡ªèº«ç¼“å­˜çš„é˜Ÿåˆ—ï¼ˆç©ºï¼‰å’Œå…±äº«é˜Ÿåˆ— swap ä¸€ä¸‹\n                // è¿™æ ·ä¹‹åå†è¯»å–ï¼Œå°±å¯ä»¥ä» self.queue ä¸­æ— é”è¯»å–\n                if !inner.is_empty() {\n                    std::mem::swap(&amp;mut self.cache, &amp;mut inner);\n                }\n                return Ok(t);\n            }\n            // è¯»ä¸åˆ°æ•°æ®ï¼Œå¹¶ä¸”ç”Ÿäº§è€…éƒ½é€€å‡ºäº†ï¼Œé‡Šæ”¾é”å¹¶è¿”å›é”™è¯¯\n            None if self.total_senders() == 0 =&gt; return Err(anyhow!(\"no sender left\")),\n            // è¯»ä¸åˆ°æ•°æ®ï¼ŒæŠŠé”æäº¤ç»™ available Condvarï¼Œå®ƒä¼šé‡Šæ”¾é”å¹¶æŒ‚èµ·çº¿ç¨‹ï¼Œç­‰å¾… notify\n            None =&gt; {\n                // å½“ Condvar è¢«å”¤é†’åä¼šè¿”å› MutexGuardï¼Œæˆ‘ä»¬å¯ä»¥ loop å›å»æ‹¿æ•°æ®\n                // è¿™æ˜¯ä¸ºä»€ä¹ˆ Condvar è¦åœ¨ loop é‡Œä½¿ç”¨\n                inner = self\n                    .shared\n                    .available\n                    .wait(inner)\n                    .map_err(|_| anyhow!(\"lock poisoned\"))?;\n            }\n        }\n    }\n}\n</code></pre><p>å½“ cache ä¸­æœ‰æ•°æ®æ—¶ï¼Œæ€»æ˜¯ä» cache ä¸­è¯»å–ï¼›å½“ cache ä¸­æ²¡æœ‰ï¼Œæˆ‘ä»¬æ‹¿åˆ°é˜Ÿåˆ—çš„é”ï¼Œè¯»å–ä¸€ä¸ªæ•°æ®ï¼Œç„¶åçœ‹çœ‹é˜Ÿåˆ—æ˜¯å¦è¿˜æœ‰æ•°æ®ï¼Œæœ‰çš„è¯ï¼Œå°± swap cache å’Œ queueï¼Œç„¶åè¿”å›ä¹‹å‰è¯»å–çš„æ•°æ®ã€‚</p><p>å¥½ï¼Œåšå®Œè¿™ä¸ªé‡æ„å’Œä¼˜åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥è¿è¡Œ <code>cargo test</code>ï¼Œçœ‹çœ‹å·²æœ‰çš„æµ‹è¯•æ˜¯å¦æ­£å¸¸ã€‚å¦‚æœä½ é‡åˆ°æŠ¥é”™ï¼Œåº”è¯¥æ˜¯ cache æ²¡æœ‰åˆå§‹åŒ–ï¼Œä½ å¯ä»¥è‡ªè¡Œè§£å†³ï¼Œä¹Ÿå¯ä»¥å‚è€ƒï¼š</p><pre><code class=\"language-rust\">pub fn unbounded&lt;T&gt;() -&gt; (Sender&lt;T&gt;, Receiver&lt;T&gt;) {\n    let shared = Shared::default();\n    let shared = Arc::new(shared);\n    (\n        Sender {\n            shared: shared.clone(),\n        },\n        Receiver {\n            shared,\n            cache: VecDeque::with_capacity(INITIAL_SIZE),\n        },\n    )\n}\n</code></pre><p>è™½ç„¶ç°æœ‰çš„æµ‹è¯•å…¨æ•°é€šè¿‡ï¼Œä½†æˆ‘ä»¬å¹¶æ²¡æœ‰ä¸ºè¿™ä¸ªä¼˜åŒ–å†™æµ‹è¯•ï¼Œè¿™é‡Œè¡¥ä¸ªæµ‹è¯•ï¼š</p><pre><code class=\"language-rust\">#[test]\n    fn channel_fast_path_should_work() {\n    let (mut s, mut r) = unbounded();\n    for i in 0..10usize {\n        s.send(i).unwrap();\n    }\n\n    assert!(r.cache.is_empty());\n    // è¯»å–ä¸€ä¸ªæ•°æ®ï¼Œæ­¤æ—¶åº”è¯¥ä¼šå¯¼è‡´ swapï¼Œcache ä¸­æœ‰æ•°æ®\n    assert_eq!(0, r.recv().unwrap());\n    // è¿˜æœ‰ 9 ä¸ªæ•°æ®åœ¨ cache ä¸­\n    assert_eq!(r.cache.len(), 9);\n    // åœ¨ queue é‡Œæ²¡æœ‰æ•°æ®äº†\n    assert_eq!(s.total_queued_items(), 0);\n\n    // ä» cache é‡Œè¯»å–å‰©ä¸‹çš„æ•°æ®\n    for (idx, i) in r.into_iter().take(9).enumerate() {\n        assert_eq!(idx + 1, i);\n    }\n}\n</code></pre><p>è¿™ä¸ªæµ‹è¯•å¾ˆç®€å•ï¼Œè¯¦ç»†æ³¨é‡Šä¹Ÿéƒ½å†™ä¸Šäº†ã€‚</p><h2>å°ç»“</h2><p>ä»Šå¤©æˆ‘ä»¬ä¸€èµ·ç ”ç©¶äº†å¦‚ä½•ä½¿ç”¨ atomics å’Œ Condvarï¼Œç»“åˆ VecDeque æ¥åˆ›å»ºä¸€ä¸ª MPSC unbounded channelã€‚å®Œæ•´çš„ä»£ç è§ <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=042ee12817442a32bcfa05e31a1084f9\">playground</a>ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨ GitHub repo è¿™ä¸€è®²çš„ç›®å½•ä¸­æ‰¾åˆ°ã€‚</p><p>ä¸åŒäºä»¥å¾€çš„å®æ“é¡¹ç›®ï¼Œè¿™ä¸€è®²ï¼Œæˆ‘ä»¬å®Œå…¨é¡ºç€éœ€æ±‚å†™æµ‹è¯•ï¼Œç„¶ååœ¨å†™æµ‹è¯•çš„è¿‡ç¨‹ä¸­è¿›è¡Œæ•°æ®ç»“æ„å’Œæ¥å£çš„è®¾è®¡ã€‚å’Œæ™®é€šçš„ TDD ä¸åŒçš„æ˜¯ï¼Œæˆ‘ä»¬<strong>å…ˆä¸€å£æ°”æŠŠä¸»è¦éœ€æ±‚æ¶‰åŠçš„è¡Œä¸ºç”¨æµ‹è¯•æ¥è¡¨è¿°ï¼Œç„¶åé€šè¿‡è¿™ä¸ªè¡¨è¿°ï¼Œæ„å»ºåˆé€‚çš„æ¥å£ï¼Œä»¥åŠèƒ½å¤Ÿè¿è¡Œè¿™ä¸ªæ¥å£çš„æ•°æ®ç»“æ„</strong>ã€‚</p><p>åœ¨å¼€å‘äº§å“çš„æ—¶å€™ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ç§éå¸¸æœ‰æ•ˆçš„æ‰‹æ®µï¼Œå¯ä»¥è®©æˆ‘ä»¬é€šè¿‡æµ‹è¯•å®Œå–„è®¾è®¡ï¼Œæœ€ç»ˆå¾—åˆ°ä¸€ä¸ªèƒ½å¤Ÿè®©æµ‹è¯•ç¼–è¯‘é€šè¿‡çš„ã€å®Œå…¨æ²¡æœ‰å®ç°ä»£ç ã€åªæœ‰æ¥å£çš„ç‰ˆæœ¬ã€‚ä¹‹åï¼Œæˆ‘ä»¬å†ä¸€ä¸ªæ¥å£ä¸€ä¸ªæ¥å£å®ç°ï¼Œå…¨éƒ¨å®ç°å®Œæˆä¹‹åï¼Œè¿è¡Œæµ‹è¯•ï¼Œçœ‹çœ‹æ˜¯å¦å‡ºé—®é¢˜ã€‚</p><p>åœ¨å­¦ä¹ è¿™ä¸€è®²çš„å†…å®¹æ—¶ï¼Œä½ å¯ä»¥å¤šå¤šå…³æ³¨æ„å»ºæµ‹è¯•ç”¨ä¾‹çš„æŠ€å·§ã€‚ä¹‹å‰çš„è¯¾ç¨‹ä¸­ï¼Œæˆ‘åå¤å¼ºè°ƒè¿‡å•å…ƒæµ‹è¯•çš„é‡è¦æ€§ï¼Œä¹Ÿä»¥èº«ä½œåˆ™åœ¨å‡ ä¸ªé‡è¦çš„å®æ“ä¸­éƒ½æœ‰è¯¦å°½åœ°æµ‹è¯•ã€‚ä¸è¿‡ç›¸æ¯”ä¹‹å‰å†™çš„æµ‹è¯•ï¼Œè¿™ä¸€è®²ä¸­çš„æµ‹è¯•è¦æ›´éš¾å†™ä¸€äº›ï¼Œå°¤å…¶æ˜¯åœ¨å¹¶å‘åœºæ™¯ä¸‹é‚£äº›è¾¹è¾¹è§’è§’çš„åŠŸèƒ½æµ‹è¯•ã€‚</p><p>ä¸è¦å°çœ‹æµ‹è¯•ä»£ç ï¼Œæœ‰æ—¶å€™æ„é€ æµ‹è¯•ä»£ç æ¯”æ’°å†™åŠŸèƒ½ä»£ç è¿˜è¦çƒ§è„‘ã€‚ä½†æ˜¯ï¼Œå½“ä½ æœ‰äº†æ‰å®çš„å•å…ƒæµ‹è¯•è¦†ç›–åï¼Œå†åšé‡æ„ï¼Œæ¯”å¦‚æœ€åæˆ‘ä»¬åšå’Œæ€§èƒ½ç›¸å…³çš„é‡æ„ï¼Œå°±å˜å¾—è½»æ¾å¾ˆå¤šï¼Œ<strong>å› ä¸ºåªè¦</strong><code>cargo test</code><strong>é€šè¿‡ï¼Œèµ·ç è¿™ä¸ªé‡æ„æ²¡æœ‰å¼•èµ·ä»»ä½•å›å½’é—®é¢˜ï¼ˆregression bugï¼‰</strong>ã€‚</p><p>å½“ç„¶ï¼Œé‡æ„æ²¡æœ‰å¼•å…¥å›å½’é—®é¢˜ï¼Œå¹¶ä¸æ„å‘³ç€é‡æ„å®Œå…¨æ²¡æœ‰é—®é¢˜ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è€ƒè™‘æ’°å†™æ–°çš„æµ‹è¯•ï¼Œè¦†ç›–é‡æ„å¸¦æ¥çš„æ”¹åŠ¨ã€‚</p><h3>æ€è€ƒé¢˜</h3><p>æˆ‘ä»¬å®ç°äº†ä¸€ä¸ª unbounded MPSC channelï¼Œå¦‚æœè¦å°†å…¶ä¿®æ”¹ä¸º bounded MPSC channelï¼ˆé˜Ÿåˆ—å¤§å°æ˜¯å—é™çš„ï¼‰ï¼Œéœ€è¦æ€ä¹ˆåšï¼Ÿ</p><p>æ¬¢è¿åœ¨ç•™è¨€åŒºäº¤æµä½ çš„å­¦ä¹ å¿ƒå¾—å’Œæ€è€ƒï¼Œæ„Ÿè°¢ä½ çš„æ”¶å¬ï¼Œä»Šå¤©ä½ å·²ç»å®Œæˆäº†Rustå­¦ä¹ çš„ç¬¬35æ¬¡æ‰“å¡ã€‚å¦‚æœä½ è§‰å¾—æœ‰æ”¶è·ï¼Œä¹Ÿæ¬¢è¿ä½ åˆ†äº«ç»™èº«è¾¹çš„æœ‹å‹ï¼Œé‚€ä»–ä¸€èµ·è®¨è®ºã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ã€‚</p>","comments":[{"had_liked":false,"id":321947,"user_name":"ä¹Œé¾™çŒ¹","can_delete":false,"product_type":"c1","uid":2739949,"ip_address":"","ucode":"43F94A0DEC54BE","user_header":"https://static001.geekbang.org/account/avatar/00/29/ce/ed/3dbe915b.jpg","comment_is_top":false,"comment_ctime":1637114650,"is_pvip":false,"replies":[{"id":"116959","content":":)","user_name":"ä½œè€…å›å¤","comment_id":321947,"uid":"1079375","ip_address":"","utype":1,"ctime":1637162574,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"35996853018","product_id":100085301,"comment_content":"è¿™æ¸…æ™°çš„é€»è¾‘ï¼Œå®Œç¾è¯ é‡ŠTDD  æå‰é¢„å®šè€å¸ˆæœªæ¥æ¨å‡ºçš„ elixir è¯¾ç¨‹ ","like_count":8,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":530895,"discussion_content":":)","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637162574,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":321986,"user_name":"ç½—æ°","can_delete":false,"product_type":"c1","uid":1320487,"ip_address":"","ucode":"96BAFAA147341F","user_header":"https://static001.geekbang.org/account/avatar/00/14/26/27/eba94899.jpg","comment_is_top":false,"comment_ctime":1637126897,"is_pvip":false,"replies":[{"id":"116956","content":"å—¯ï¼ŒTDD å¼ºè°ƒå…³æ³¨äºéœ€æ±‚ï¼Œå¼ºè°ƒæµ‹è¯•å…ˆè¡Œï¼Œç„¶åå†ä¸€ç‚¹ç‚¹å®ç°ï¼Œä¸€ä¸ª case ä¸€ä¸ª case è·‘é€šï¼Œæœ‰äº›è¿‡äºæ¨¡å¼åŒ–ã€‚æˆ‘å¸Œæœ›ç»™å¤§å®¶å¸¦æ¥çš„æ€è€ƒæ˜¯ï¼Œé€šè¿‡ test æ¥ç†è§£éœ€æ±‚ï¼Œç„¶åæŠŠ test ä½œä¸ºæ•°æ®ç»“æ„å’Œæ¥å£è®¾è®¡çš„ä¸€ç¯ï¼Œé€šè¿‡ test ä¸æ–­å®Œå–„æ•°æ®ç»“æ„å’Œæ¥å£çš„è®¾è®¡ï¼Œæœ€åå†å®ç°ã€‚æˆ‘ä¸ªäººè¿˜æ˜¯ä¹ æƒ¯åœ¨æ¥å£ç¡®å®šåï¼Œä¸€æ¬¡æ€§æŠŠç³»ç»Ÿå®ç°ï¼Œè€Œä¸æ˜¯ä¸€ç‚¹ç‚¹å®ç°ï¼Œæµ‹è¯•ï¼Œå®ç°ï¼Œæµ‹è¯•ã€‚","user_name":"ä½œè€…å›å¤","comment_id":321986,"uid":"1079375","ip_address":"","utype":1,"ctime":1637161862,"user_name_real":"ç¼–è¾‘"}],"discussion_count":2,"race_medal":2,"score":"18816996081","product_id":100085301,"comment_content":"è€å¸ˆåœ¨ä¸€ééçš„é‡å¤ TDDï¼Œç„¶åæˆ‘æŠŠ TDD ç”¨åœ¨äº†ç°åœ¨çš„ Go é¡¹ç›®ä¸­ï¼Œæ•ˆæœéå¸¸å¥½ï¼Œè™½ç„¶å¼€å‘çš„æ—¶é—´å¢é•¿äº†ï¼Œä½†æ˜¯ä»£ç è´¨é‡æ˜¾è‘—æé«˜äº†ã€‚","like_count":4,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":530882,"discussion_content":"å—¯ï¼ŒTDD å¼ºè°ƒå…³æ³¨äºéœ€æ±‚ï¼Œå¼ºè°ƒæµ‹è¯•å…ˆè¡Œï¼Œç„¶åå†ä¸€ç‚¹ç‚¹å®ç°ï¼Œä¸€ä¸ª case ä¸€ä¸ª case è·‘é€šï¼Œæœ‰äº›è¿‡äºæ¨¡å¼åŒ–ã€‚æˆ‘å¸Œæœ›ç»™å¤§å®¶å¸¦æ¥çš„æ€è€ƒæ˜¯ï¼Œé€šè¿‡ test æ¥ç†è§£éœ€æ±‚ï¼Œç„¶åæŠŠ test ä½œä¸ºæ•°æ®ç»“æ„å’Œæ¥å£è®¾è®¡çš„ä¸€ç¯ï¼Œé€šè¿‡ test ä¸æ–­å®Œå–„æ•°æ®ç»“æ„å’Œæ¥å£çš„è®¾è®¡ï¼Œæœ€åå†å®ç°ã€‚æˆ‘ä¸ªäººè¿˜æ˜¯ä¹ æƒ¯åœ¨æ¥å£ç¡®å®šåï¼Œä¸€æ¬¡æ€§æŠŠç³»ç»Ÿå®ç°ï¼Œè€Œä¸æ˜¯ä¸€ç‚¹ç‚¹å®ç°ï¼Œæµ‹è¯•ï¼Œå®ç°ï¼Œæµ‹è¯•ã€‚","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1637161862,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1320487,"avatar":"https://static001.geekbang.org/account/avatar/00/14/26/27/eba94899.jpg","nickname":"ç½—æ°","note":"","ucode":"96BAFAA147341F","race_medal":2,"user_type":1,"is_pvip":false},"reply_author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":530972,"discussion_content":"è·Ÿè€å¸ˆå­¦åˆ°å¾ˆå¤šï¼ç¡®å®šå¥½äº†æ¥å£ï¼Œä¸€æ¬¡å®ç°ï¼Œæˆ‘è¦ä¸æ–­çš„å·¥ä½œä¸­å®è·µ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637198221,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":530882,"ip_address":""},"score":530972,"extra":"{\"user_type\":1}"}]}]},{"had_liked":false,"id":341351,"user_name":"æ…•é«˜è¿ª","can_delete":false,"product_type":"c1","uid":1448126,"ip_address":"","ucode":"EB1CB5EA4E3A90","user_header":"https://static001.geekbang.org/account/avatar/00/16/18/be/ad3127e0.jpg","comment_is_top":false,"comment_ctime":1649561566,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5944528862","product_id":100085301,"comment_content":"çœ‹è€å¸ˆçš„è¯¾ç¨‹çœŸçš„æ˜¯å¯ä»¥å­¦ä¹ åˆ°å¾ˆå¤šä¸œè¥¿å•Šï¼Œä¸æ­¢Rustã€‚å¤ªçˆ½äº†","like_count":1},{"had_liked":false,"id":321904,"user_name":"å½­äºšä¼¦","can_delete":false,"product_type":"c1","uid":2425378,"ip_address":"","ucode":"77A32C73A23F72","user_header":"https://static001.geekbang.org/account/avatar/00/25/02/22/19585900.jpg","comment_is_top":false,"comment_ctime":1637107863,"is_pvip":true,"replies":[{"id":"118914","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","comment_id":321904,"uid":"1079375","ip_address":"","utype":1,"ctime":1639852645,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"5932075159","product_id":100085301,"comment_content":"ä¸€è¾¹è¿½è¿™æœ€æ–°çš„è¯¾ç¨‹æ›´æ–°, ä¸€è¾¹åå¤æ¸©ä¹ å‰é¢çš„è¯¾ç¨‹; <br>ä¹‹å‰è¿½ã€Šwestworldã€‹éƒ½æ²¡è¿™ä¹ˆè¿‡ç˜¾è¿‡~","like_count":1,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539875,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639852645,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":358682,"user_name":"è¿›å‡»çš„Lancelot","can_delete":false,"product_type":"c1","uid":2620407,"ip_address":"å¹¿ä¸œ","ucode":"3BCC355801DC61","user_header":"https://static001.geekbang.org/account/avatar/00/27/fb/f7/88ab6f83.jpg","comment_is_top":false,"comment_ctime":1664537241,"is_pvip":true,"discussion_count":0,"race_medal":1,"score":"1664537241","product_id":100085301,"comment_content":"æ€è€ƒé¢˜ï¼šå¯¹äº bounded_channel  çš„æµ‹è¯•å¦‚ä¸‹ï¼š<br>```rust<br>&#47;&#47; éœ€æ±‚6: å½“ channel æ»¡äº†çš„æ—¶å€™ï¼Œsender å‘é€ä¼šè¢«é˜»å¡<br>    #[test]<br>    fn sender_should_block_when_channel_is_full() {<br>        let ( s, mut r) = bounded(3);<br>        let mut s1 = s.clone();<br>        let cnt = Arc::new(AtomicUsize::new(0));<br>        let cnt_1 = Arc::clone(&amp;cnt);<br>        thread::spawn(move || {<br>            for i in 0..10 {<br>                s1.send(i).unwrap();<br>                cnt_1.fetch_add(1, Ordering::AcqRel);<br>            }<br>            unreachable!();<br>        });<br><br>        &#47;&#47; 1ms è¶³ä»¥è®© sender å‘é€å®Œ 3 ä¸ªæ¶ˆæ¯<br>        thread::sleep(Duration::from_millis(1));<br>        assert_eq!(3, cnt.load(Ordering::SeqCst));<br>        for i in 0..2 {<br>            assert_eq!(i, r.recv().unwrap());<br>        }<br>        &#47;&#47; 1ms è¶³ä»¥è®© sender å†å‘é€å®Œ 2 ä¸ªæ¶ˆæ¯<br>        thread::sleep(Duration::from_millis(1));<br>        assert_eq!(5, cnt.load(Ordering::SeqCst));<br>        assert_eq!(2, r.recv().unwrap());<br><br>        thread::sleep(Duration::from_millis(1));<br>        assert_eq!(s.total_queued_items(), 3);<br>    }<br>```<br>ç¡®å®šå¥½äº†æµ‹è¯•ç”¨ä¾‹ä¹‹åï¼Œå°±å¯ä»¥å¼€å§‹æ€è€ƒå®ç°æ–¹å¼ã€‚ä¸»è¦å°±æ˜¯ç»™ shared å¢åŠ ä¸€ä¸ª capacity çš„åŸå­å˜é‡ï¼Œåœ¨ send æ—¶å€™å‡ä¸€ï¼Œrecv çš„æ—¶å€™åŠ ä¸€ï¼Œå¹¶ä¸”åœ¨ send æ—¶å€™ï¼Œå¦‚æœ capacity ä¸º 0ï¼Œåˆ™éœ€è¦ block ä½ send æ‰€åœ¨çš„çº¿ç¨‹ã€‚ç”±äº bounded_channel åº•å±‚å®¹å™¨æœ‰å®¹é‡ä¸Šé™ï¼Œä½¿ç”¨ cache ä¼šå¯¼è‡´ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚ï¼šæ˜æ˜è£…æ»¡äº† channel è¯»ä¸€æ¬¡åï¼Œå´åˆèƒ½ç»§ç»­å¾€é‡Œé¢ send æ•°æ®ï¼Œå®¹æ˜“è®©ç”¨æˆ·æ„Ÿåˆ°å›°æƒ‘ï¼Œå› æ­¤å–æ¶ˆäº† cache çš„ä¼˜åŒ–ã€‚ <br>å…·ä½“å®Œæ•´ä»£ç å¯ä»¥å‚è€ƒï¼šhttps:&#47;&#47;play.rust-lang.org&#47;?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=facca5a34f7bd1d103a482da3a6c8d5e","like_count":0},{"had_liked":false,"id":350775,"user_name":"zxk","can_delete":false,"product_type":"c1","uid":1221195,"ip_address":"","ucode":"4BB2BD9D2BCD04","user_header":"https://static001.geekbang.org/account/avatar/00/12/a2/4b/b72f724f.jpg","comment_is_top":false,"comment_ctime":1657185835,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1657185835","product_id":100085301,"comment_content":"è€å¸ˆï¼Œreceiver_shall_be_notified_when_all_senders_exit åº”è¯¥åªæ˜¯å¤§æ¦‚ç‡èƒ½æµ‹å‡ºé—®é¢˜å§ï¼Ÿ<br>```<br><br>#[test]<br>fn receiver_shall_be_notified_when_all_senders_exit() {<br>    let (s, mut r) = unbounded::&lt;usize&gt;();<br>    &#47;&#47; ç”¨äºä¸¤ä¸ªçº¿ç¨‹åŒæ­¥<br>    let (mut sender, mut receiver) = unbounded::&lt;usize&gt;();<br>    let t1 = thread::spawn(move || {<br>        &#47;&#47; ä¿è¯ r.recv() å…ˆäº t2 çš„ drop æ‰§è¡Œ<br>        sender.send(0).unwrap();<br>        assert!(r.recv().is_err());<br>    });<br><br>    thread::spawn(move || {<br>        receiver.recv().unwrap();<br>        drop(s);<br>    });<br><br>    t1.join().unwrap();<br>}<br>```<br>t1 çš„ sender.send(0).unwrap() ä¼šå”¤é†’ t2 ä¸­çš„ receiver.recv().unwrap()ï¼Œè¿™æ—¶å€™ t2 ä¸­çš„ drop(s) æ˜¯æœ‰å¯èƒ½åœ¨ t1 ä¸­çš„ assert!(r.recv().is_err()) ä¹‹å‰æ‰§è¡Œï¼Œå¯¼è‡´æ— æ³•æµ‹å‡ºé—®é¢˜ï¼Œè™½ç„¶æ¦‚ç‡éå¸¸å°ã€‚","like_count":0,"discussions":[{"author":{"id":2768844,"avatar":"","nickname":"Geek_1b11b3","note":"","ucode":"6D3AD8EAD46DC4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":591838,"discussion_content":"å¾ªç¯æµ‹è¯•äº†ä¸€ä¸‹ï¼Œå…¶å®è¿˜æ˜¯å¾ˆå¤§æœºç‡ä¼šå‡ºç°æ— æ³•å”¤é†’çš„é—®é¢˜","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1666857042,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å¹¿ä¸œ"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":348660,"user_name":"Curricane","can_delete":false,"product_type":"c1","uid":1243961,"ip_address":"","ucode":"3778B96444874E","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/VLB1WPGVDnicKaMGUcFZdtDQOXSib3LhFv6YqCZA16qfy2KHUAGL0ichSEE6rSu8HXSibGdg8vzIQ7qWlk9BZOeJjQ/132","comment_is_top":false,"comment_ctime":1655284012,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1655284012","product_id":100085301,"comment_content":"å®é™…é¡¹ç›®ä¸­ï¼Œä¼šæœ‰ç½‘ç»œè¯·æ±‚ï¼Œæ•°æ®åº“ï¼Œæˆ–è€…ä¸å…¶ä»–ç»„ä»¶äº¤äº’ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæ€ä¹ˆè¿›è¡Œ TDD å‘¢","like_count":0,"discussions":[{"author":{"id":1544345,"avatar":"https://static001.geekbang.org/account/avatar/00/17/90/99/d03ef0d4.jpg","nickname":"newbmiao","note":"","ucode":"1BDD0341C490FD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576403,"discussion_content":"æŠŠå…·ä½“å®ç°è®¾è®¡éƒ½å˜æˆæ¥å£ï¼Œä¾èµ–æ¥å£å°±æ–¹ä¾¿æµ‹è¯•äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655522504,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":340564,"user_name":"åƒè—•å§å‰²å¾çˆ±","can_delete":false,"product_type":"c1","uid":2717902,"ip_address":"","ucode":"84EB4F60E9E69F","user_header":"https://static001.geekbang.org/account/avatar/00/29/78/ce/c1f1ac55.jpg","comment_is_top":false,"comment_ctime":1648907766,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1648907766","product_id":100085301,"comment_content":"receiver_should_be_blocked_when_nothing_to_read()æµ‹è¯•ä¸­ä¸»çº¿ç¨‹é€€å‡ºåï¼ŒSenderå…¨éƒ¨è¢«ææ„ï¼Œthread1ä¸­çš„è¿­ä»£å™¨å°±è¿”å›Noneäº†ï¼Œé‚£ä¸æ˜¯å°±ä¼šè¿è¡Œåˆ°assert!(false)è¿™å¥è¯äº†å—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":2992421,"avatar":"","nickname":"Rex Wang","note":"","ucode":"FB419F40A5BA65","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":581119,"discussion_content":"å¯¹çš„å‘¢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1658511809,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":338055,"user_name":"å­¦ä¸å®Œä¸æ”¹å","can_delete":false,"product_type":"c1","uid":1748055,"ip_address":"","ucode":"68AE66A2E35734","user_header":"https://static001.geekbang.org/account/avatar/00/1a/ac/57/db7cc2a1.jpg","comment_is_top":false,"comment_ctime":1647258766,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1647258766","product_id":100085301,"comment_content":"å’Œjonçš„channelè§†é¢‘æ€è·¯å¾ˆåƒã€‚ã€‚ã€‚","like_count":0},{"had_liked":false,"id":335987,"user_name":"Geek_83f92d","can_delete":false,"product_type":"c1","uid":2906847,"ip_address":"","ucode":"36FAFA42389E32","user_header":"","comment_is_top":false,"comment_ctime":1645816368,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1645816368","product_id":100085301,"comment_content":"è¯·é—®è€å¸ˆ è¿™ä¸¤å¥çš„é¡ºåºæ˜¯ä¸æ˜¯åäº†ï¼Ÿ<br>sender.send(0).unwrap(); <br>assert!(r.recv().is_err());","like_count":0,"discussions":[{"author":{"id":2992421,"avatar":"","nickname":"Rex Wang","note":"","ucode":"FB419F40A5BA65","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":581116,"discussion_content":"åè¿‡æ¥ä¸è¡Œçš„ï¼Œæ•´ä¸ªä¸»è¿›ç¨‹å’Œå­è¿›ç¨‹éƒ½é˜»å¡äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1658507055,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":332135,"user_name":"A å‡¡","can_delete":false,"product_type":"c1","uid":1197361,"ip_address":"","ucode":"BDC8DB599B8284","user_header":"https://static001.geekbang.org/account/avatar/00/12/45/31/53910b61.jpg","comment_is_top":false,"comment_ctime":1643035711,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1643035711","product_id":100085301,"comment_content":"è€å¸ˆè®²çš„ç¡®å®éå¸¸å¥½ï¼Œè¿˜åœ¨è·Ÿç€å­¦ä¹ ä¸­ï¼Œä¸è¿‡æ„Ÿè§‰éœ€è¦ä¸æ–­å¤ä¹ ä¸€ä¸‹å‰é¢çš„çŸ¥è¯†ï¼Œèƒ½æœ‰æ›´æ¸…æ™°çš„è®¤è¯†","like_count":0},{"had_liked":false,"id":324858,"user_name":"Colt","can_delete":false,"product_type":"c1","uid":1117983,"ip_address":"","ucode":"7BDB5F469E325D","user_header":"https://static001.geekbang.org/account/avatar/00/11/0f/1f/e894ae27.jpg","comment_is_top":false,"comment_ctime":1638690464,"is_pvip":false,"replies":[{"id":"118860","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","comment_id":324858,"uid":"1079375","ip_address":"","utype":1,"ctime":1639848350,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"1638690464","product_id":100085301,"comment_content":"æœ€å–œæ¬¢è€å¸ˆçš„å®è·µè¯¾,ä¹Ÿè®¸rustçš„çŸ¥è¯†å­¦å¾—è¿˜ä¸€çŸ¥åŠè§£,ä½†æ˜¯è·Ÿç€è€å¸ˆçš„æ€è·¯æ•²ä»£ç æ„Ÿè§‰éå¸¸çˆ½,å¾ˆå¤šæ—¶å€™ä¸€ä¸ªé¡ºä¾¿å°±å®Œæˆäº†éœ€æ±‚","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539820,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639848350,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":323205,"user_name":"wowotuo","can_delete":false,"product_type":"c1","uid":1141192,"ip_address":"","ucode":"D87BCBD3EA61A9","user_header":"https://static001.geekbang.org/account/avatar/00/11/69/c8/d6f00a46.jpg","comment_is_top":false,"comment_ctime":1637761389,"is_pvip":false,"replies":[{"id":"118892","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","comment_id":323205,"uid":"1079375","ip_address":"","utype":1,"ctime":1639850712,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"1637761389","product_id":100085301,"comment_content":"ä¹Ÿç‰¹åˆ«æœŸå¾…æŠŠå¼‚æ­¥tokioã€å…ƒç¼–ç¨‹è®²é€","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539853,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639850712,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":323203,"user_name":"wowotuo","can_delete":false,"product_type":"c1","uid":1141192,"ip_address":"","ucode":"D87BCBD3EA61A9","user_header":"https://static001.geekbang.org/account/avatar/00/11/69/c8/d6f00a46.jpg","comment_is_top":false,"comment_ctime":1637761226,"is_pvip":false,"replies":[{"id":"118891","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","comment_id":323203,"uid":"1079375","ip_address":"","utype":1,"ctime":1639850701,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"1637761226","product_id":100085301,"comment_content":"è¿™ä¸ªå®æ“é¡¹ç›®éå¸¸æœ‰æ„ä¹‰ï¼Œè®©æˆ‘å¯¹è¿™å—æœ‰äº†ä¸€ä¸ªä½“ç³»æ€§ã€æ·±å…¥çš„è®¤çŸ¥ï¼Œå€¼å¾—å¤šè¯»å¤šçœ‹ã€‚","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539852,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639850702,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":322229,"user_name":"ç½—åŒå­¦","can_delete":false,"product_type":"c1","uid":1649119,"ip_address":"","ucode":"909B9EC768B9AD","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/vHujib2CCrUYNBaia32eIwTyJoAcl27vASZ9KGjSdnH1dJhD7CrSUicBib19Tf8nDibWaHjzIsvIfdqcXX6vGrH8bicw/132","comment_is_top":false,"comment_ctime":1637248461,"is_pvip":false,"replies":[{"id":"118908","content":"å¯¹ï¼Œåªæ˜¯ç”¨äºç†è§£ï¼Œä¸å»ºè®®ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒã€‚æ ‡å‡†åº“æˆ–è€… flumeï¼Œcrossbream ä¸‹çš„ channel æ€§èƒ½æ›´å¥½ï¼Œä¼˜å…ˆè€ƒè™‘","user_name":"ä½œè€…å›å¤","comment_id":322229,"uid":"1079375","ip_address":"","utype":1,"ctime":1639852087,"user_name_real":"ç¼–è¾‘"}],"discussion_count":2,"race_medal":0,"score":"1637248461","product_id":100085301,"comment_content":"æˆ‘æƒ³è¯·é—®ä¸€ä¸‹ï¼Œå®ç°è¿™ä¸ªä¸»è¦æ˜¯ä¸ºäº†ç†è§£channel åŸç†ï¼Œè¿™ä¸ªæ¡ˆä¾‹å¯ä»¥ç”¨äºå®é™…ç”Ÿäº§ä¸ï¼Ÿè¿˜æ˜¯è¯´æ ‡å‡†åº“é‡Œçš„æ€§èƒ½ä¼šæ›´å¥½ä¸€ç‚¹","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539869,"discussion_content":"å¯¹ï¼Œåªæ˜¯ç”¨äºç†è§£ï¼Œä¸å»ºè®®ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒã€‚æ ‡å‡†åº“æˆ–è€… flumeï¼Œcrossbream ä¸‹çš„ channel æ€§èƒ½æ›´å¥½ï¼Œä¼˜å…ˆè€ƒè™‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639852087,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1385204,"avatar":"https://static001.geekbang.org/account/avatar/00/15/22/f4/9fd6f8f0.jpg","nickname":"æ ¸æ¡ƒ","note":"","ucode":"7AB05270CBCCCB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":536899,"discussion_content":"å¯ä»¥çš„ï¼Œç›®å‰æˆ‘ä»¬ç”Ÿäº§ç¯å¢ƒï¼Œè‡ªç ”çš„æ–‡ä»¶ç³»ç»Ÿé‡Œé¢ï¼ŒèŠ‚ç‚¹ç›‘æ§æ•°æ®ä¸Šä¼ æ¨¡å—å°±éœ€è¦ç”¨åˆ°è¿™éƒ¨åˆ†å†…å®¹ï¼Œåœ¨æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªmonitorï¼Œå®å°±æ˜¯ä¸€ä¸ªmisc channelï¼Œç„¶åç´¯è®¡æ•°æ®å®šæ—¶ä¸ŠæŠ¥çš„åŠŸèƒ½ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638890082,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}