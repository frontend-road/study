{"id":365252,"title":"18 | ç£ç›˜è§†è§’ï¼šå¦‚æœå†…å­˜æ— é™å¤§ï¼Œç£ç›˜è¿˜æœ‰ç”¨æ­¦ä¹‹åœ°å—ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å´ç£Šã€‚</p><p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒSparkçš„ä¼˜åŠ¿åœ¨äºå†…å­˜è®¡ç®—ã€‚ä¸€æåˆ°â€œå†…å­˜è®¡ç®—â€ï¼Œæˆ‘ä»¬çš„ç¬¬ä¸€ååº”éƒ½æ˜¯ï¼šæ‰§è¡Œæ•ˆç‡é«˜ï¼ä½†å¦‚æœå¬åˆ°â€œåŸºäºç£ç›˜çš„è®¡ç®—â€ï¼Œå°±ä¼šè§‰å¾—æ€§èƒ½è‚¯å®šå¥½ä¸åˆ°å“ªå„¿å»ã€‚ç”šè‡³æœ‰çš„äººä¼šæƒ³ï¼Œå¦‚æœSparkçš„å†…å­˜æ— é™å¤§å°±å¥½äº†ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æŠŠç£ç›˜å®Œå…¨æŠ›å¼ƒæ‰ã€‚å½“ç„¶ï¼Œè¿™ä¸ªå‡è®¾å¤§æ¦‚ç‡ä¸ä¼šæˆçœŸï¼Œè€Œä¸”è¿™ç§ä¸€åˆ€åˆ‡çš„æ€ç»´ä¹Ÿä¸æ­£ç¡®ã€‚</p><p>å¦‚æœå†…å­˜æ— é™å¤§ï¼Œæˆ‘ä»¬ç¡®å®å¯ä»¥é€šè¿‡ä¸€äº›æ‰‹æ®µï¼Œè®©Sparkä½œä¸šåœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­å…å»æ‰€æœ‰çš„è½ç›˜åŠ¨ä½œã€‚ä½†æ˜¯ï¼Œæ— é™å¤§å†…å­˜å¼•å…¥çš„å¤§é‡Full GCåœé¡¿ï¼ˆStop The Worldï¼‰ï¼Œå¾ˆæœ‰å¯èƒ½è®©åº”ç”¨çš„æ‰§è¡Œæ€§èƒ½ï¼Œç›¸æ¯”æœ‰ç£ç›˜æ“ä½œçš„æ—¶å€™æ›´å·®ã€‚è¿™å°±ä¸ç¬¦åˆæˆ‘ä»¬ä¸€å†å¼ºè°ƒçš„ï¼Œ<strong>è°ƒä¼˜çš„æœ€ç»ˆç›®çš„æ˜¯åœ¨ä¸åŒçš„ç¡¬ä»¶èµ„æºä¹‹é—´å¯»æ±‚å¹³è¡¡äº†</strong>ã€‚</p><p>æ‰€ä»¥ä»Šå¤©è¿™ä¸€è®²ï¼Œæˆ‘ä»¬å°±æ¥è¯´è¯´ç£ç›˜åœ¨Sparkä»»åŠ¡æ‰§è¡Œçš„è¿‡ç¨‹ä¸­éƒ½æ‰®æ¼”å“ªäº›é‡è¦è§’è‰²ï¼Œå®ƒåŠŸèƒ½æ–¹é¢çš„ä½œç”¨ï¼Œä»¥åŠæ€§èƒ½æ–¹é¢çš„ä»·å€¼ã€‚æŒæ¡å®ƒä»¬å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´åˆç†åœ°åˆ©ç”¨ç£ç›˜ï¼Œä»¥æˆæœ¬ä¼˜åŠ¿å¹³è¡¡ä¸åŒç¡¬ä»¶èµ„æºçš„è®¡ç®—è´Ÿè½½ã€‚</p><h2>ç£ç›˜åœ¨åŠŸèƒ½ä¸Šçš„ä½œç”¨</h2><p>åœ¨Sparkå½“ä¸­ï¼Œç£ç›˜éƒ½ç”¨åœ¨å“ªäº›åœ°æ–¹å‘¢ï¼Ÿåœ¨Shuffleé‚£ä¸€è®²æˆ‘ä»¬è¯´è¿‡ï¼Œåœ¨Mapé˜¶æ®µï¼ŒSparkæ ¹æ®è®¡ç®—æ˜¯å¦éœ€è¦èšåˆï¼Œåˆ†åˆ«é‡‡ç”¨PartitionedPairBufferå’ŒPartitionedAppendOnlyMapä¸¤ç§ä¸åŒçš„å†…å­˜æ•°æ®ç»“æ„æ¥ç¼“å­˜åˆ†ç‰‡ä¸­çš„æ•°æ®è®°å½•ã€‚åˆ†å¸ƒå¼è®¡ç®—å¾€å¾€æ¶‰åŠæµ·é‡æ•°æ®ï¼Œå› æ­¤è¿™äº›æ•°æ®ç»“æ„é€šå¸¸éƒ½æ²¡åŠæ³•è£…æ»¡åˆ†åŒºä¸­çš„æ‰€æœ‰æ•°æ®ã€‚åœ¨å†…å­˜å—é™çš„æƒ…å†µä¸‹ï¼Œæº¢å‡ºæœºåˆ¶å¯ä»¥ä¿è¯ä»»åŠ¡çš„é¡ºåˆ©æ‰§è¡Œï¼Œä¸ä¼šå› ä¸ºå†…å­˜ç©ºé—´ä¸è¶³å°±ç«‹å³æŠ¥OOMå¼‚å¸¸ã€‚</p><!-- [[[read_end]]] --><p><img src=\"https://static001.geekbang.org/resource/image/68/4e/688d5453a9431c53d0a75c7a4yy3e44e.jpg?wh=7212*2328\" alt=\"\" title=\"æº¢å‡ºæ•°æ®åˆ°ç£ç›˜ï¼Œé¿å…é¢‘ç¹çš„OOM\"></p><p>ä»¥â€œä»™å¥³æ•£èŠ±â€çš„æ¸¸æˆä¸ºä¾‹ï¼Œæˆ‘ä»¬ç”¨groupByKeyå»æ”¶é›†ä¸åŒèŠ±è‰²çš„èŠ±æœµã€‚åœ¨PartitionedPairBufferå¤§å°ä¸º4çš„æƒ…å†µä¸‹ï¼Œå½“å°çº¢æ‹¿åˆ°çš„èŠ±æœµæ•°é‡è¶…è¿‡4æœµçš„æ—¶å€™ï¼Œå…¶ä½™èŠ±æœµè¦æƒ³è¿›å…¥å†…å­˜ï¼ŒSparkå°±å¿…é¡»æŠŠPartitionedPairBufferä¸­çš„å†…å®¹æš‚æ—¶æº¢å‡ºåˆ°ä¸´æ—¶æ–‡ä»¶ï¼ŒæŠŠå†…å­˜ç©ºé—´è®©å‡ºæ¥æ‰è¡Œã€‚<strong>è¿™å°±æ˜¯ç£ç›˜åœ¨åŠŸèƒ½ä¸Šçš„ç¬¬ä¸€ä¸ªä½œç”¨ï¼šæº¢å‡ºä¸´æ—¶æ–‡ä»¶ã€‚</strong></p><p>å½“åˆ†åŒºä¸­çš„æœ€åä¸€æ‰¹æ•°æ®åŠ è½½åˆ°PartitionedPairBufferä¹‹åï¼Œå®ƒä¼šå’Œä¹‹å‰æº¢å‡ºåˆ°ç£ç›˜çš„ä¸´æ—¶æ–‡ä»¶ä¸€èµ·åšå½’å¹¶è®¡ç®—ï¼Œæœ€ç»ˆå¾—åˆ°Shuffleçš„æ•°æ®æ–‡ä»¶å’Œç´¢å¼•æ–‡ä»¶ä¹Ÿä¼šå­˜å‚¨åˆ°ç£ç›˜ä¸Šï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„Shuffleä¸­é—´æ–‡ä»¶ã€‚<strong>è¿™å°±æ˜¯ç£ç›˜çš„åœ¨åŠŸèƒ½ä¸Šçš„ç¬¬äºŒä¸ªä½œç”¨ï¼šå­˜å‚¨Shuffleä¸­é—´æ–‡ä»¶ã€‚</strong></p><p>é™¤æ­¤ä¹‹å¤–ï¼Œ<strong>ç£ç›˜çš„ç¬¬ä¸‰ä¸ªä½œç”¨å°±æ˜¯ç¼“å­˜åˆ†å¸ƒå¼æ•°æ®é›†ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå‡¡æ˜¯å¸¦<em>DISK</em>å­—æ ·çš„å­˜å‚¨æ¨¡å¼ï¼Œéƒ½ä¼šæŠŠå†…å­˜ä¸­æ”¾ä¸ä¸‹çš„æ•°æ®ç¼“å­˜åˆ°ç£ç›˜</strong>ã€‚è¿™äº›ç¼“å­˜æ•°æ®è¿˜æœ‰åˆšåˆšè®²çš„ä¸´æ—¶æ–‡ä»¶ã€ä¸­é—´æ–‡ä»¶ï¼Œéƒ½ä¼šå­˜å‚¨åˆ°spark.local.dirå‚æ•°å¯¹åº”çš„æ–‡ä»¶ç³»ç»Ÿç›®å½•ä¸­ã€‚</p><h2>æ€§èƒ½ä¸Šçš„ä»·å€¼</h2><p>åœ¨é…ç½®é¡¹é‚£ä¸€è®²æˆ‘ä»¬è¯´è¿‡ï¼ŒæŠŠspark.local.dirè¿™ä¸ªå‚æ•°é…ç½®åˆ°SDDæˆ–è€…å…¶ä»–è®¿é—®æ•ˆç‡æ›´é«˜çš„å­˜å‚¨ç³»ç»Ÿä¸­å¯ä»¥æä¾›æ›´å¥½çš„ I/O æ€§èƒ½ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œç£ç›˜å¤ç”¨è¿˜èƒ½ç»™æ‰§è¡Œæ€§èƒ½å¸¦æ¥æ›´å¥½çš„æå‡ã€‚æ‰€è°“<strong>ç£ç›˜å¤ç”¨ï¼Œå®ƒæŒ‡çš„æ˜¯Shuffle Writeé˜¶æ®µäº§ç”Ÿçš„ä¸­é—´æ–‡ä»¶è¢«å¤šæ¬¡è®¡ç®—é‡å¤åˆ©ç”¨çš„è¿‡ç¨‹</strong>ã€‚ä¸‹é¢ï¼Œæˆ‘å°±é€šè¿‡ä¸¤ä¸ªä¾‹å­ç»™ä½ è¯¦ç»†è®²è®²ï¼Œç£ç›˜å¤ç”¨çš„å¸¸è§åº”ç”¨å’Œå®ƒçš„æ”¶ç›Šã€‚</p><h3>å¤±è´¥é‡è¯•ä¸­çš„ç£ç›˜å¤ç”¨</h3><p>æˆ‘ä»¬ç»å¸¸è¯´ï¼Œåœ¨æ²¡æœ‰RDD Cacheçš„æƒ…å†µä¸‹ï¼Œä¸€æ—¦æŸä¸ªè®¡ç®—ç¯èŠ‚å‡ºé”™ï¼Œå°±ä¼šè§¦å‘æ•´æ¡DAGä»å¤´è‡³å°¾é‡æ–°è®¡ç®—ï¼Œè¿™ä¸ªè¿‡ç¨‹åˆå«å¤±è´¥é‡è¯•ã€‚ä¸¥æ ¼æ¥è¯´ï¼Œè¿™ç§è¯´æ³•æ˜¯ä¸å‡†ç¡®çš„ã€‚å› ä¸ºï¼Œå¤±è´¥é‡è¯•çš„è®¡ç®—æºå¤´å¹¶ä¸æ˜¯æ•´æ¡DAGçš„â€œå¤´â€ï¼Œè€Œæ˜¯ä¸è§¦å‘ç‚¹è·ç¦»æœ€æ–°çš„Shuffleçš„ä¸­é—´æ–‡ä»¶ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/35/86/35c13d9f2eba5d23dabe05249ccb9486.jpg?wh=2626*1190\" alt=\"\" title=\"ç£ç›˜å¤ç”¨ä¸è“„æ°´æ± \"></p><p>æˆ‘ä»¬ä»¥æ–‡ç¨¿ç¤ºæ„å›¾ä¸­çš„DAGä¸ºä¾‹å­ï¼ŒHDFSæºæ•°æ®ç»è¿‡ä¸¤æ¬¡è½¬æ¢ä¹‹åï¼Œåˆ†åˆ«å¾—åˆ°RDD1å’ŒRDD2ã€‚RDD2åœ¨Shuffleä¹‹åå†è¿›è¡Œä¸¤æ¬¡è®¡ç®—ï¼Œåˆ†æˆå¾—åˆ°RDD3å’ŒRDD4ã€‚</p><p>ä¸å¹¸çš„æ˜¯ï¼Œåœ¨è®¡ç®—RDD4çš„è¿‡ç¨‹ä¸­æœ‰äº›ä»»åŠ¡å¤±è´¥äº†ã€‚åœ¨å¤±è´¥é‡è¯•çš„æ—¶å€™ï¼ŒSparkç¡®å®ä¼šä»RDD4å‘å‰å›æº¯ï¼Œä½†æ˜¯æœ‰äº†ç£ç›˜å¤ç”¨æœºåˆ¶çš„å­˜åœ¨ï¼Œå®ƒå¹¶ä¸ä¼šä¸€ç›´å›æº¯åˆ°HDFSæºæ•°æ®ï¼Œè€Œæ˜¯ç›´æ¥å›æº¯åˆ°å·²ç»ç‰©åŒ–åˆ°èŠ‚ç‚¹çš„RDD3çš„â€œæ•°æ®æºâ€ï¼Œä¹Ÿå°±æ˜¯RDD2åœ¨Shuffle Writeé˜¶æ®µè¾“å‡ºåˆ°ç£ç›˜çš„ä¸­é—´æ–‡ä»¶ã€‚å› æ­¤ï¼Œ<strong>ç£ç›˜å¤ç”¨çš„æ”¶ç›Šä¹‹ä¸€å°±æ˜¯ç¼©çŸ­å¤±è´¥é‡è¯•çš„è·¯å¾„ï¼Œåœ¨ä¿éšœä½œä¸šç¨³å®šæ€§çš„åŒæ—¶æå‡æ‰§è¡Œæ€§èƒ½</strong>ã€‚</p><p>ä¸ºäº†æ–¹ä¾¿ä½ ç†è§£ï¼Œæˆ‘ä»¬ä¸å¦¨æŠŠDAGä¸­çš„æµæ°´çº¿è®¡ç®—æƒ³è±¡æˆæ˜¯å¹²æ¸ çŒæº‰ï¼Œé»„åœŸé«˜å¡ä¸Šçš„éº¦ç”°ä¸€å¹´åˆ°å¤´ä¹Ÿå–ä¸åˆ°å‡ æ»´é›¨æ°´ï¼Œå®Œå…¨ä¾é äººå·¥å¹²æ¸ è¿›è¡ŒçŒæº‰ã€‚å½“æ°´ç”µç«™å¼€é—¸æ”¾æ°´çš„æ—¶å€™ï¼Œæ°´ä¼šæ²¿ç€å¹²æ¸ ä¸€è·¯å‘ä¸œæµè¿›æ”¯æ¸ å»æ»‹å…»å¦‚é¥¥ä¼¼æ¸´çš„éº¦è‹—ã€‚</p><p>ä¸€ä¸ªæ°´ç”µç«™å¾€å¾€æœåŠ¡æ–¹åœ†ç™¾é‡Œå¤§å¤§å°å°çš„æ‘å­ï¼Œå¦‚æœæ¯æ¬¡çŒæº‰éƒ½ç­‰ç€æ°´ç”µç«™å¼€é—¸æ”¾æ°´ï¼Œé‡ä¸Šå¤§æ—±çš„å¹´å¤´ï¼Œæ°´è¿˜æ²¡æµåˆ°æ”¯æ¸ ï¼Œéº¦è‹—å°±éƒ½æ—±æ­»äº†ã€‚è¦æ˜¯èƒ½æ²¿ç€å¹²æ¸ ï¼Œæ¯éš”ä¸€æ®µè·ç¦»å°±ä¿®å»ºä¸€åº§è“„æ°´æ± ï¼Œé‚£ä¹ˆé™„è¿‘çš„æ‘æ°‘å°±èƒ½å°±è¿‘çŒæº‰äº†ã€‚åœ¨è¿™ä¸ªå¹²æ¸ çŒæº‰çš„ç±»æ¯”ä¸­ï¼Œæ°´ç”µç«™çš„æ°´æ˜¯HDFSæ•°æ®æºå¤´ï¼Œè“„æ°´æ± å°±æ˜¯Shuffleä¸­é—´æ–‡ä»¶ï¼Œå°±è¿‘å–æ°´ã€å°±è¿‘çŒæº‰å°±æ˜¯ç£ç›˜å¤ç”¨æœºåˆ¶ã€‚</p><h3>ReuseExchangeæœºåˆ¶ä¸‹çš„ç£ç›˜å¤ç”¨</h3><p>ä½ å¯èƒ½ä¼šè¯´ï¼šâ€œç£ç›˜å¤ç”¨ä¹Ÿæ²¡ä»€ä¹ˆå˜›ï¼Œæ— éæ˜¯åœ¨å¤±è´¥é‡è¯•çš„æ—¶å€™ï¼ŒæŠ„ä¸ªè¿‘é“ã€å°‘èµ°äº›å¼¯è·¯ã€‚åœ¨ä»»åŠ¡ä¸å‡ºé”™çš„æƒ…å†µä¸‹æ˜¯åˆ©ç”¨ä¸åˆ°è¿™é¡¹ä¼˜åŠ¿çš„ã€‚â€æ²¡é”™ï¼Œæ‰€ä»¥æˆ‘ä»¬å†æ¥è¯´è¯´ç£ç›˜å¤ç”¨çš„å¦ä¸€ç§å½¢å¼ï¼šReuseExchangeæœºåˆ¶ã€‚ReuseExchangeæ˜¯Spark SQLä¼—å¤šä¼˜åŒ–ç­–ç•¥ä¸­çš„ä¸€ç§ï¼Œå®ƒæŒ‡çš„æ˜¯<strong>ç›¸åŒæˆ–æ˜¯ç›¸ä¼¼çš„ç‰©ç†è®¡åˆ’å¯ä»¥å…±äº«Shuffleè®¡ç®—çš„ä¸­é—´ç»“æœ</strong>ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„Shuffleä¸­é—´æ–‡ä»¶ã€‚ReuseExchangeæœºåˆ¶å¯ä»¥å¸®æˆ‘ä»¬å‰Šå‡I/Oå¼€é”€ï¼Œç”šè‡³èŠ‚çœShuffleï¼Œæ¥å¤§å¹…æå‡æ‰§è¡Œæ€§èƒ½ã€‚</p><p>é‚£æˆ‘ä»¬è¯¥æ€ä¹ˆæœ‰æ•ˆåˆ©ç”¨ReuseExchangeæœºåˆ¶å‘¢ï¼Ÿåœ¨æ•°æ®ä»“åº“åœºæ™¯ä¸‹ï¼Œä¸ºäº†å¾—åˆ°æ•°æ®æŠ¥è¡¨æˆ–æ˜¯å¯è§†åŒ–å›¾è¡¨ï¼Œç”¨æˆ·å¾€å¾€éœ€è¦æ‰§è¡Œå¤šä¸ªç›¸ä¼¼çš„æŸ¥è¯¢ï¼Œç”šè‡³ä¼šæŠŠåŒæ ·çš„æŸ¥è¯¢è¯­å¥æ‰§è¡Œå¤šæ¬¡ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒReuseExchangeç­–ç•¥åœ¨æ‰§è¡Œæ•ˆç‡æ–¹é¢ä¼šå¸¦æ¥éå¸¸å¤§çš„æ”¶ç›Šã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/5f/98/5f390cdb366edc25329956c11e773f98.jpg?wh=3023*1384\" alt=\"\" title=\"åŒæ ·æˆ–ç›¸ä¼¼çš„æŸ¥è¯¢åˆ©ç”¨ReuseExchangeç¼©çŸ­æ‰§è¡Œè·¯å¾„\"></p><p>å³ä¾¿æ˜¯åœ¨æ²¡æœ‰DataFrame Cacheçš„æƒ…å†µä¸‹ï¼Œç›¸åŒæˆ–æ˜¯ç›¸ä¼¼çš„æŸ¥è¯¢ä¹Ÿå¯ä»¥åˆ©ç”¨ReuseExchangeç­–ç•¥ï¼Œåœ¨ç¼©çŸ­æ‰§è¡Œè·¯å¾„çš„åŒæ—¶ï¼Œæ¶ˆé™¤é¢å¤–çš„Shuffleè®¡ç®—ã€‚ä»æ•°æ®å¤ç”¨çš„è§’åº¦æ¥è¯´ï¼ŒReuseExchangeå’ŒDISK_ONLYæ¨¡å¼çš„DataFrame Cacheèƒ½èµ·åˆ°çš„ä½œç”¨å®Œå…¨ç­‰ä»·ã€‚</p><p>å’±ä»¬æ¥ä¸¾ä¸ªä¾‹å­ã€‚ç°åœ¨æœ‰è¿™æ ·ä¸€ä¸ªä¸šåŠ¡éœ€æ±‚ï¼šç»™å®šç”¨æˆ·è®¿é—®æ—¥å¿—ï¼Œåˆ†åˆ«ç»Ÿè®¡ä¸åŒç”¨æˆ·çš„PVï¼ˆPage Viewsï¼Œé¡µé¢æµè§ˆé‡ï¼‰ã€UVï¼ˆUnique Viewsï¼Œç½‘ç«™ç‹¬ç«‹è®¿å®¢ï¼‰ï¼Œç„¶åå†æŠŠä¸¤é¡¹ç»Ÿè®¡ç»“æœåˆå¹¶èµ·æ¥ï¼Œä»¥å¤‡åç”¨ã€‚å…¶ä¸­ï¼Œç”¨æˆ·æ—¥å¿—åŒ…å«ç”¨æˆ·IDã€è®¿é—®æ—¶é—´ã€é¡µé¢åœ°å€ç­‰ä¸»è¦å­—æ®µã€‚ä¸šåŠ¡éœ€æ±‚ä¸ä»…æ˜ç¡®ä¹Ÿå¾ˆç®€å•ï¼Œæˆ‘ä»¬å¾ˆå¿«å°±èƒ½æŠŠä»£ç å†™å‡ºæ¥ã€‚</p><pre><code>//ç‰ˆæœ¬1ï¼šåˆ†åˆ«è®¡ç®—PVã€UVï¼Œç„¶ååˆå¹¶\n// Data schema (userId: String, accessTime: Timestamp, page: String)\n \nval filePath: String = _\nval df: DataFrame = spark.read.parquet(filePath)\n \nval dfPV: DataFrame = df.groupBy(&quot;userId&quot;).agg(count(&quot;page&quot;).alias(&quot;value&quot;)).withColumn(&quot;metrics&quot;, lit(&quot;PV&quot;))\nval dfUV: DataFrame = df.groupBy(&quot;userId&quot;).agg(countDistinct(&quot;page&quot;).alias(&quot;value&quot;)).withColumn(&quot;metrics &quot;, lit(&quot;UV&quot;))\n \nval resultDF: DataFrame = dfPV.Union(dfUV)\n \n// Resultæ ·ä¾‹\n| userId | metrics | value |\n| user0  | PV      | 25 |\n| user0  | UV      | 12 |\n</code></pre><p>ä»£ç é€»è¾‘æ˜¯å…ˆè¯»å–ç”¨æˆ·æ—¥å¿—ï¼Œç„¶ååœ¨åŒä¸€ä¸ªDataFrameä¹‹ä¸Šåˆ†åˆ«è°ƒç”¨countå’ŒcountDistinctè®¡ç®—PVã€UVï¼Œæœ€åæŠŠPUã€UVå¯¹åº”çš„ä¸¤ä¸ªDataFrameåˆå¹¶åœ¨ä¸€èµ·ã€‚</p><p>è™½ç„¶ä»£ç å®ç°èµ·æ¥ç®€å•ç›´æ¥ï¼Œä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬åœ¨resultDFä¹‹ä¸Šè°ƒç”¨explainæˆ–æ˜¯é€šè¿‡Spark UIå»æŸ¥çœ‹ç‰©ç†è®¡åˆ’å°±ä¼šå‘ç°ï¼Œå°½ç®¡countå’ŒcountDistinctæ˜¯åŸºäºåŒä¸€ä»½æ•°æ®æºè®¡ç®—çš„ï¼Œä½†è¿™ä¸¤ä¸ªæ“ä½œçš„æ‰§è¡Œè·¯å¾„æ˜¯å®Œå…¨ç‹¬ç«‹çš„ã€‚å®ƒä»¬å„è‡ªæ‰«æParquetæºæ–‡ä»¶ï¼Œå¹¶ä¸”é€šè¿‡Shuffleå®Œæˆè®¡ç®—ï¼Œåœ¨Shuffleä¹‹å‰ä¼šå…ˆåœ¨Mapç«¯åšæœ¬åœ°èšåˆï¼ŒShuffleä¹‹åä¼šåœ¨Reduceç«¯å†è¿›è¡Œå…¨å±€èšåˆã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/dd/28/dd150e0863812522a6f2ee9102678928.jpg?wh=2663*1333\" alt=\"\" title=\"Parquetæ–‡ä»¶æ‰«æä¸¤æ¬¡ã€Shuffleä¸¤æ¬¡\"></p><p>å¯¹äºç»å¤§å¤šæ•°çš„åˆå¹¶åœºæ™¯æ¥è¯´ï¼Œè®¡ç®—æµç¨‹å¤§æŠµå¦‚æ­¤ã€‚æ˜¾ç„¶ï¼Œè¿™æ ·çš„åšæ³•æ˜¯æå…¶ä½æ•ˆçš„ï¼Œå°¤å…¶æ˜¯åœ¨éœ€è¦åˆå¹¶å¤šä¸ªæ•°æ®é›†çš„æ—¶å€™ï¼Œé‡å¤çš„æ•°æ®æ‰«æå’Œåˆ†å‘å°±ä¼šå¼•å…¥æ›´å¤šçš„æ€§èƒ½å¼€é”€ã€‚é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆåŠæ³•ï¼Œè®©åŒä¸€ä»½æ•°æ®æºçš„å¤šä¸ªç®—å­åªè¯»å–ä¸€æ¬¡Parquetæ–‡ä»¶ï¼Œä¸”åªåšä¸€æ¬¡Shuffleå‘¢ï¼Ÿ</p><p>åšäº†è¿™ä¹ˆåŠå¤©é“ºå«ï¼Œç­”æ¡ˆè‡ªç„¶æ˜¯â€œæœ‰â€ã€‚é’ˆå¯¹ç‰ˆæœ¬1ä¸­çš„ä»£ç ï¼Œæˆ‘ä»¬ç¨ä½œè°ƒæ•´å°±å¯ä»¥å……åˆ†åˆ©ç”¨ReuseExchangeç­–ç•¥æ¥åšä¼˜åŒ–ã€‚</p><pre><code>//ç‰ˆæœ¬2ï¼šåˆ†åˆ«è®¡ç®—PVã€UVï¼Œç„¶ååˆå¹¶\n// Data schema (userId: String, accessTime: Timestamp, page: String)\n \nval filePath: String = _\nval df: DataFrame = spark.read.parquet(filePath).repartition($&quot;userId&quot;)\n \nval dfPV: DataFrame = df.groupBy(&quot;userId&quot;).agg(count(&quot;page&quot;).alias(&quot;value&quot;)).withColumn(&quot;metrics&quot;, lit(&quot;PV&quot;))\nval dfUV: DataFrame = df.groupBy(&quot;userId&quot;).agg(countDistinct(&quot;page&quot;).alias(&quot;value&quot;)).withColumn(&quot;metrics &quot;, lit(&quot;UV&quot;))\n \nval resultDF: DataFrame = dfPV.Union(dfUV)\n \n// Resultæ ·ä¾‹\n| userId | metrics | value |\n| user0  | PV      | 25 |\n| user0  | UV      | 12 |\n</code></pre><p>éœ€è¦è°ƒæ•´çš„éƒ¨åˆ†ä»…ä»…æ˜¯æ•°æ®æºè¯»å–ï¼Œå…¶ä»–éƒ¨åˆ†çš„ä»£ç ä¿æŒä¸å˜ã€‚åœ¨ç”¨Parquet APIè¯»å–ç”¨æˆ·æ—¥å¿—ä¹‹åï¼Œæˆ‘ä»¬è¿½åŠ ä¸€æ­¥é‡åˆ†åŒºæ“ä½œï¼Œä¹Ÿå°±æ˜¯ä»¥userIdä¸ºåˆ†åŒºé”®è°ƒç”¨repartitionç®—å­ã€‚</p><p>ç»è¿‡è¿™ä¸ªå¾®å°çš„æ”¹åŠ¨ä¹‹åï¼Œæˆ‘ä»¬é‡æ–°åœ¨resultDFä¹‹ä¸Šè°ƒç”¨explainæˆ–æ˜¯æŸ¥çœ‹Spark UIä¼šå‘ç°ï¼Œåœ¨æ–°çš„ç‰©ç†è®¡åˆ’ä¸­ï¼Œcountæˆ–æ˜¯countDistinctåˆ†æ”¯å‡ºç°äº†ReuseExchangeå­—æ ·ï¼Œä¹Ÿå°±æ˜¯å…¶ä¸­ä¸€æ–¹å¤ç”¨äº†å¦ä¸€æ–¹çš„Exchangeç»“æœã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/00/b2/008e691de73eefc6daa4886017fa33b2.jpg?wh=2868*1210\" alt=\"\" title=\"ReuseExchange\"></p><p>é€šè¿‡è§‚å¯Ÿæ‰§è¡Œè®¡åˆ’ä¸éš¾å‘ç°ï¼ŒReuseExchangeå¸¦æ¥çš„æ”¶ç›Šç›¸å½“å¯è§‚ï¼Œä¸ä»…æ˜¯<strong>æ•°æ®æºåªéœ€è¦æ‰«æä¸€éï¼Œè€Œä¸”ä½œä¸ºâ€œæ€§èƒ½ç“¶é¢ˆæ‹…å½“â€çš„Shuffleä¹Ÿåªå‘ç”Ÿäº†ä¸€æ¬¡</strong>ã€‚</p><p>å¦å¤–ï¼Œä½ å¯èƒ½ä¹Ÿä¼šå‘ç°ï¼Œå¤ç”¨Shuffleä¸­é—´ç»“æœçš„æ˜¯ä¸¤ä¸ªä¸å®Œå…¨ç›¸åŒçš„æŸ¥è¯¢ï¼Œä¸€ä¸ªæ˜¯ç”¨countåšç»Ÿè®¡è®¡æ•°ï¼Œå¦ä¸€ä¸ªæ˜¯ç”¨countDistinctåšå»é‡è®¡æ•°ã€‚ä½ çœ‹ï¼Œä¸¤ä¸ªç›¸ä¼¼çš„æŸ¥è¯¢ï¼Œé€šè¿‡ReuseExchangeæ•°æ®å¤ç”¨ï¼Œè¾¾åˆ°äº†ä½¿ç”¨DISK_ONLYç¼“å­˜çš„ç­‰ä»·æ•ˆæœã€‚æ¢å¥è¯è¯´ï¼Œä½ ä¸éœ€è¦æ‰‹åŠ¨è°ƒç”¨persist(DISK_ONLY)ï¼Œä¹Ÿä¸éœ€è¦å¿å—ç£ç›˜ç¼“å­˜çš„è®¡ç®—è¿‡ç¨‹ï¼Œå°±å¯ä»¥äº«å—å®ƒå¸¦æ¥çš„æ”¶ç›Šã€‚è¿™æƒŠä¸æƒŠå–œã€æ„ä¸æ„å¤–ï¼Ÿ</p><p>ä½ å¯èƒ½ä¼šé—®ï¼šâ€œæ—¢ç„¶ReuseExchangeæœºåˆ¶è¿™ä¹ˆå¥½ç”¨ï¼Œæ»¡è¶³ä»€ä¹ˆæ¡ä»¶æ‰èƒ½è§¦å‘Spark SQLå»é€‰æ‹©è¿™ä¸ªæ‰§è¡Œç­–ç•¥å‘¢ï¼Ÿâ€äº‹å®ä¸Šï¼Œè§¦å‘æ¡ä»¶è‡³å°‘æœ‰2ä¸ªï¼š</p><ul>\n<li><strong>å¤šä¸ªæŸ¥è¯¢æ‰€ä¾èµ–çš„åˆ†åŒºè§„åˆ™è¦ä¸Shuffleä¸­é—´æ•°æ®çš„åˆ†åŒºè§„åˆ™ä¿æŒä¸€è‡´</strong></li>\n<li><strong>å¤šä¸ªæŸ¥è¯¢æ‰€æ¶‰åŠçš„å­—æ®µï¼ˆAttributesï¼‰è¦ä¿æŒä¸€è‡´</strong></li>\n</ul><p>å¯¹äºç¬¬ä¸€ä¸ªæ¡ä»¶ï¼Œæˆ‘ä»¬åœ¨æ¡ˆä¾‹ä¸­å·²ç»æ¼”ç¤ºè¿‡äº†ï¼Œä¸¤ä¸ªæŸ¥è¯¢éƒ½ç”¨userIdåˆ†ç»„ï¼Œè¿™å°±è¦æ±‚æ‰€ä¾èµ–çš„æ•°æ®å¿…é¡»è¦æŒ‰ç…§userIdåšåˆ†åŒºã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨ç‰ˆæœ¬2çš„ä»£ç ä¸­ï¼Œä¼šæ·»åŠ ä»¥userIdä¸ºåˆ†åŒºé”®çš„repartitionç®—å­ï¼Œåªæœ‰è¿™æ ·ï¼ŒShuffleä¸­é—´ç»“æœçš„åˆ†åŒºè§„åˆ™æ‰èƒ½å’ŒæŸ¥è¯¢æ‰€éœ€çš„åˆ†åŒºè§„åˆ™ä¿æŒä¸€è‡´ã€‚</p><p>ä»”ç»†è§‚å¯Ÿcountå’ŒcountDistinctä¸¤ä¸ªæŸ¥è¯¢æ‰€æ¶‰åŠçš„å­—æ®µï¼Œæˆ‘ä»¬ä¼šå‘ç°å®ƒä»¬å®Œå…¨ä¸€è‡´ã€‚å®é™…ä¸Šï¼Œå¦‚æœæˆ‘ä»¬æŠŠcountè¯­å¥ä¸­çš„<code>count(\"page\")</code>æ”¹ä¸º<code>count(\"*\")</code>ä¹Ÿå¹¶ä¸å½±å“PVçš„è®¡ç®—ï¼Œä½†æ˜¯ï¼Œçœ‹ä¼¼æ— å…³ç—›ç—’çš„æ”¹åŠ¨ä¼šå¯¼è‡´ç¬¬äºŒä¸ªæ¡ä»¶ä¸èƒ½æ»¡è¶³ï¼Œä»è€Œæ— æ³•åˆ©ç”¨ReuseExchangeæœºåˆ¶æ¥æå‡æ‰§è¡Œæ€§èƒ½ã€‚ç‰ˆæœ¬2ä¸­çš„<code>count(\"page\")</code>æ”¹ä¸º<code>count(\"*\")</code>ä¹‹åï¼Œç‰©ç†è®¡åˆ’ä¼šå›é€€åˆ°ç‰ˆæœ¬1ï¼Œæˆ‘æŠŠå…¶ä¸­çš„å˜åŒ–ç•™ç»™ä½ ä½œä¸ºè¯¾åä½œä¸šå»å¯¹æ¯”ã€‚</p><h2>å°ç»“</h2><p>ç£ç›˜è™½ç„¶åœ¨å¤„ç†å»¶è¿Ÿä¸Šè¿œä¸å¦‚å†…å­˜ï¼Œä½†åœ¨æ€§èƒ½è°ƒä¼˜ä¸­ä¾ç„¶ä¸å¯æˆ–ç¼ºã€‚ç†è§£ç£ç›˜åœ¨åŠŸèƒ½ä¸Šå’Œæ€§èƒ½ä¸Šçš„ä»·å€¼ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´åˆç†åœ°åˆ©ç”¨ç£ç›˜ï¼Œä»¥æˆæœ¬ä¼˜åŠ¿å¹³è¡¡ä¸åŒç¡¬ä»¶èµ„æºçš„è®¡ç®—è´Ÿè½½ã€‚</p><p>ä»åŠŸèƒ½ä¸Šçœ‹ï¼Œç£ç›˜åœ¨Sparkä¸­ä¸»è¦æœ‰3æ–¹é¢çš„ä½œç”¨ï¼Œåˆ†åˆ«æ˜¯æº¢å‡ºä¸´æ—¶æ–‡ä»¶ã€ç¼“å­˜åˆ†å¸ƒå¼æ•°æ®é›†å’Œå­˜å‚¨Shuffleä¸­é—´æ–‡ä»¶ã€‚è¿™3æ–¹é¢åŠŸèƒ½åœ¨æå‡ä½œä¸šç¨³å®šæ€§çš„åŒæ—¶ï¼Œä¹Ÿä¸ºæ‰§è¡Œæ•ˆç‡çš„æå‡æ‰“ä¸‹äº†åŸºç¡€ã€‚</p><p>ä»æ€§èƒ½ä¸Šçœ‹ï¼Œåˆ©ç”¨å¥½ç£ç›˜å¤ç”¨æœºåˆ¶ï¼Œå¯ä»¥æå¤§åœ°æé«˜åº”ç”¨çš„æ‰§è¡Œæ€§èƒ½ã€‚ç£ç›˜å¤ç”¨æŒ‡çš„æ˜¯Shuffle Writeé˜¶æ®µäº§ç”Ÿçš„ä¸­é—´æ–‡ä»¶è¢«å¤šæ¬¡è®¡ç®—é‡å¤åˆ©ç”¨çš„è¿‡ç¨‹ã€‚ç£ç›˜å¤ç”¨æœ‰ä¸¤ç§ç”¨é€”ï¼Œä¸€ä¸ªæ˜¯å¤±è´¥é‡è¯•ï¼Œå¦ä¸€ä¸ªæ˜¯ReuseExchangeæœºåˆ¶ã€‚å…¶ä¸­ï¼Œå¤±è´¥é‡è¯•æŒ‡çš„å°±æ˜¯ä»»åŠ¡å¤±è´¥ä¹‹åå°è¯•é‡å¤´è®¡ç®—ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œç£ç›˜å¤ç”¨ç¼©çŸ­äº†å¤±è´¥é‡è¯•çš„è·¯å¾„ï¼Œåœ¨ä¿éšœä½œä¸šç¨³å®šæ€§çš„åŒæ—¶ï¼Œæå‡æ‰§è¡Œæ€§èƒ½ã€‚</p><p>ReuseExchangeç­–ç•¥æŒ‡çš„æ˜¯ï¼Œç›¸åŒæˆ–æ˜¯ç›¸ä¼¼çš„ç‰©ç†è®¡åˆ’å¯ä»¥å…±äº«Shuffleè®¡ç®—çš„ä¸­é—´ç»“æœã€‚ReuseExchangeå¯¹äºæ‰§è¡Œæ€§èƒ½çš„è´¡çŒ®ç›¸å½“å¯è§‚ï¼Œå®ƒå¯ä»¥è®©åŸºäºåŒä¸€ä»½æ•°æ®æºçš„å¤šä¸ªç®—å­åªè¯»å–ä¸€æ¬¡Parquetæ–‡ä»¶ï¼Œå¹¶ä¸”åªåšä¸€æ¬¡Shuffleï¼Œæ¥å¤§å¹…å‰Šå‡ç£ç›˜ä¸ç½‘ç»œå¼€é”€ã€‚</p><p>ä¸è¿‡ï¼Œè¦æƒ³è®©Spark SQLåœ¨ä¼˜åŒ–é˜¶æ®µé€‰æ‹©ReuseExchangeï¼Œä¸šåŠ¡åº”ç”¨å¿…é¡»è¦æ»¡è¶³2ä¸ªæ¡ä»¶ï¼š</p><ul>\n<li>å¤šä¸ªæŸ¥è¯¢æ‰€ä¾èµ–çš„åˆ†åŒºè§„åˆ™è¦ä¸Shuffleä¸­é—´æ•°æ®çš„åˆ†åŒºè§„åˆ™ä¿æŒä¸€è‡´</li>\n<li>å¤šä¸ªæŸ¥è¯¢æ‰€æ¶‰åŠçš„å­—æ®µè¦ä¿æŒä¸€è‡´</li>\n</ul><h2>æ¯æ—¥ä¸€ç»ƒ</h2><ol>\n<li>è¯·ä½ æŠŠcountè®¡ç®—ä¸­çš„<code>count(\"page\")</code>æ”¹ä¸º<code>count(\"*\")</code>ï¼Œä»¥æ­¤æ¥è§‚å¯Ÿç‰©ç†è®¡åˆ’çš„å˜åŒ–ï¼Œå¹¶åœ¨ç•™è¨€åŒºè¯´å‡ºä½ çš„è§‚å¯Ÿ</li>\n<li>ä¸ºäº†è§¦å‘ReuseExchangeæœºåˆ¶ç”Ÿæ•ˆï¼Œæˆ‘ä»¬æŒ‰ç…§userIdå¯¹æ•°æ®é›†åšé‡åˆ†åŒºï¼Œç»“åˆè¿™ä¸€ç‚¹ï¼Œä½ ä¸å¦¨æƒ³ä¸€æƒ³ï¼Œåœ¨å“ªäº›æƒ…å†µä¸‹ï¼Œä¸é€‚åˆé‡‡ç”¨ReuseExchangeæœºåˆ¶ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ</li>\n</ol><p>æœŸå¾…åœ¨ç•™è¨€åŒºçœ‹åˆ°ä½ çš„æ€è€ƒå’Œç­”æ¡ˆï¼Œæˆ‘ä»¬ä¸‹ä¸€è®²è§ï¼</p>","comments":[{"had_liked":false,"id":289782,"user_name":"sky_sql","can_delete":false,"product_type":"c1","uid":1099273,"ip_address":"","ucode":"397F4263C9E590","user_header":"https://static001.geekbang.org/account/avatar/00/10/c6/09/7f2bcc6e.jpg","comment_is_top":false,"comment_ctime":1619173069,"is_pvip":false,"replies":[{"id":"105163","content":"å¥½é—®é¢˜~ æˆ‘ä»¬è¿˜æ˜¯åˆ†èµ„æºè°ƒåº¦å’Œä»»åŠ¡è°ƒåº¦ä¸¤ç§æƒ…å†µæ¥è¯´ã€‚<br><br>Sparkåœ¨åšä»»åŠ¡è°ƒåº¦ä¹‹å‰ï¼ŒSchedulerBackendå°è£…çš„è°ƒåº¦å™¨ï¼Œæ¯”å¦‚Yarnã€Mesosã€Standaloneï¼Œå®é™…ä¸Šå·²ç»å®Œæˆäº†èµ„æºè°ƒåº¦ï¼Œæ¢å¥è¯è¯´ï¼Œæ•´ä¸ªé›†ç¾¤æœ‰å¤šå°‘ä¸ªcontainers&#47;executorsï¼Œå·²ç»æ˜¯ä¸€ä»¶ç¡®å®šçš„äº‹æƒ…äº†ã€‚è€Œä¸”ï¼Œæ¯ä¸ªExecutorsçš„CPUå’Œå†…å­˜ï¼Œä¹Ÿéƒ½æ˜¯ç¡®å®šçš„äº†ï¼ˆå› ä¸ºä½ å¯åŠ¨Sparké›†ç¾¤çš„æ—¶å€™ï¼Œä½¿ç”¨é…ç½®é¡¹æŒ‡å®šäº†æ¯ä¸ªExecutorsçš„CPUå’Œå†…å­˜åˆ†åˆ«æ˜¯å¤šå°‘ï¼‰ã€‚èµ„æºè°ƒåº¦å™¨åœ¨åšèµ„æºè°ƒåº¦çš„æ—¶å€™ï¼Œç¡®å®æ˜¯åŒæ—¶éœ€è¦CPUå’Œå†…å­˜ä¿¡æ¯çš„ã€‚<br><br>èµ„æºè°ƒåº¦å®Œæˆåï¼ŒSparkå¼€å§‹ä»»åŠ¡è°ƒåº¦ï¼Œä½ çš„é—®é¢˜ï¼Œå…¶å®æ˜¯ä»»åŠ¡è°ƒåº¦èŒƒç•´çš„é—®é¢˜ã€‚ä¹Ÿå°±æ˜¯TaskScheduleråœ¨å‡†å¤‡è°ƒåº¦ä»»åŠ¡çš„æ—¶å€™ï¼Œè¦äº‹å…ˆçŸ¥é“éƒ½æœ‰å“ªäº›Executorså¯ç”¨ï¼Œæ³¨æ„ï¼Œæ˜¯å¯ç”¨ã€‚ä¹Ÿå°±æ˜¯TaskSchedulerçš„æ ¸å¿ƒç›®çš„ï¼Œåœ¨äºè·å–â€œå¯ç”¨â€çš„Executorsã€‚<br><br>ç°åœ¨æ¥å›ç­”ä½ çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯ï¼šä¸ºä»€ä¹ˆExecutorDataä¸å­˜å‚¨äºå†…å­˜ç›¸å…³çš„ä¿¡æ¯ã€‚ç­”æ¡ˆæ˜¯ï¼šä¸éœ€è¦ã€‚ä¸€æ¥ï¼ŒTaskSchedulerè¦è¾¾åˆ°ç›®çš„ï¼Œå®ƒåªéœ€çŸ¥é“Executorsæ˜¯å¦æœ‰ç©ºé—²CPUã€æœ‰å‡ ä¸ªç©ºé—²CPUå°±å¯ä»¥äº†ï¼Œæœ‰è¿™äº›ä¿¡æ¯å°±è¶³ä»¥è®©ä»–å†³å®šæ˜¯å¦æŠŠtasksè°ƒåº¦åˆ°ç›®æ ‡Executorsä¸Šå»ã€‚äºŒæ¥ï¼Œæ¯ä¸ªExecutorsçš„å†…å­˜æ€»å¤§å°ï¼Œåœ¨Sparké›†ç¾¤å¯åŠ¨çš„æ—¶å€™å°±ç¡®å®šäº†ï¼Œå› æ­¤ï¼ŒExecutorDataè‡ªç„¶æ˜¯æ²¡å¿…è¦è®°å½•åƒTotal Memoryè¿™æ ·çš„å†—ä½™ä¿¡æ¯ã€‚<br><br>å†æ¥è¯´Free Memoryï¼Œé¦–å…ˆï¼Œæˆ‘ä»¬è¯´è¿‡ï¼ŒSparkå¯¹äºå†…å­˜çš„é¢„ä¼°ä¸å‡†ï¼Œå†è€…ï¼Œæ¯ä¸ªExecutorsçš„å¯ç”¨å†…å­˜éƒ½ä¼šéšç€GCçš„æ‰§è¡Œè€ŒåŠ¨æ€å˜åŒ–ï¼Œå› æ­¤ï¼ŒExecutorDataè®°å½•çš„Free Memoryï¼Œæ°¸è¿œéƒ½æ˜¯è¿‡æ—¶çš„ä¿¡æ¯ï¼ŒTaskScheduleræ‹¿åˆ°è¿™æ ·çš„ä¿¡æ¯ï¼Œä¹Ÿæ²¡å•¥ç”¨ã€‚ä¸€è€…æ˜¯ä¸å‡†ï¼ŒäºŒæ¥ç¡®å®æ²¡ç”¨ï¼Œå› ä¸ºTaskScheduleræ‹¿ä¸åˆ°æ•°æ®åˆ†ç‰‡å¤§å°è¿™æ ·çš„ä¿¡æ¯ï¼ŒTaskScheduleråœ¨Driverç«¯ï¼Œè€Œæ•°æ®åˆ†ç‰‡æ˜¯åœ¨ç›®æ ‡Executorsï¼Œæ‰€ä»¥TaskScheduleræ‹¿åˆ°Free Memoryä¹Ÿæ²¡å•¥ç”¨ï¼Œå› ä¸ºå®ƒä¹Ÿä¸èƒ½åˆ¤æ–­è¯´ï¼štaskè¦å¤„ç†çš„æ•°æ®åˆ†ç‰‡ï¼Œæ˜¯ä¸æ˜¯è¶…è¿‡äº†ç›®æ ‡Executorsçš„å¯ç”¨å†…å­˜ã€‚<br><br>ç»¼ä¸Šï¼ŒExecutorDataçš„æ•°æ®ç»“æ„ä¸­ï¼Œåªä¿å­˜äº†CPUä¿¡æ¯ï¼Œè€Œæ²¡æœ‰è®°å½•å†…å­˜æ¶ˆè€—ç­‰ä¿¡æ¯ã€‚ä¸çŸ¥é“è¿™äº›èƒ½ä¸èƒ½è§£ç­”ä½ çš„é—®é¢˜ï¼Ÿæœ‰é—®é¢˜å†èŠå“ˆ~","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1619339198,"ip_address":"","comment_id":289782,"utype":1}],"discussion_count":1,"race_medal":0,"score":"70338649805","product_id":100073401,"comment_content":"è€å¸ˆå¥½ï¼å’¨è¯¢ä¸ªé¢˜å¤–è¯ï¼Œåœ¨è°ƒåº¦ç³»ç»Ÿä¸­è®²åˆ°SchedulerBackend ç”¨ ExecutorData å¯¹ Executor è¿›è¡Œèµ„æºç”»åƒï¼ŒExecutorDataä¸­æœ‰RPC åœ°å€ã€ä¸»æœºåœ°å€ã€å¯ç”¨ CPU æ ¸æ•°å’Œæ»¡é… CPU æ ¸æ•°ç­‰ç­‰ï¼Œä½†æ˜¯æ²¡æœ‰å†…å­˜ç›¸å…³çš„ï¼Œæ˜¯sparkçš„Executor å†…å­˜è¿™å—æ¯”è¾ƒå¤æ‚ï¼Ÿ<br>å¯¹æ¯”hadoopåœ¨è°ƒåº¦æ—¶ä¼šè€ƒè™‘å†…å­˜æ˜¯å¦æ»¡è¶³å—ï¼Ÿ","like_count":16,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":519018,"discussion_content":"å¥½é—®é¢˜~ æˆ‘ä»¬è¿˜æ˜¯åˆ†èµ„æºè°ƒåº¦å’Œä»»åŠ¡è°ƒåº¦ä¸¤ç§æƒ…å†µæ¥è¯´ã€‚\n\nSparkåœ¨åšä»»åŠ¡è°ƒåº¦ä¹‹å‰ï¼ŒSchedulerBackendå°è£…çš„è°ƒåº¦å™¨ï¼Œæ¯”å¦‚Yarnã€Mesosã€Standaloneï¼Œå®é™…ä¸Šå·²ç»å®Œæˆäº†èµ„æºè°ƒåº¦ï¼Œæ¢å¥è¯è¯´ï¼Œæ•´ä¸ªé›†ç¾¤æœ‰å¤šå°‘ä¸ªcontainers/executorsï¼Œå·²ç»æ˜¯ä¸€ä»¶ç¡®å®šçš„äº‹æƒ…äº†ã€‚è€Œä¸”ï¼Œæ¯ä¸ªExecutorsçš„CPUå’Œå†…å­˜ï¼Œä¹Ÿéƒ½æ˜¯ç¡®å®šçš„äº†ï¼ˆå› ä¸ºä½ å¯åŠ¨Sparké›†ç¾¤çš„æ—¶å€™ï¼Œä½¿ç”¨é…ç½®é¡¹æŒ‡å®šäº†æ¯ä¸ªExecutorsçš„CPUå’Œå†…å­˜åˆ†åˆ«æ˜¯å¤šå°‘ï¼‰ã€‚èµ„æºè°ƒåº¦å™¨åœ¨åšèµ„æºè°ƒåº¦çš„æ—¶å€™ï¼Œç¡®å®æ˜¯åŒæ—¶éœ€è¦CPUå’Œå†…å­˜ä¿¡æ¯çš„ã€‚\n\nèµ„æºè°ƒåº¦å®Œæˆåï¼ŒSparkå¼€å§‹ä»»åŠ¡è°ƒåº¦ï¼Œä½ çš„é—®é¢˜ï¼Œå…¶å®æ˜¯ä»»åŠ¡è°ƒåº¦èŒƒç•´çš„é—®é¢˜ã€‚ä¹Ÿå°±æ˜¯TaskScheduleråœ¨å‡†å¤‡è°ƒåº¦ä»»åŠ¡çš„æ—¶å€™ï¼Œè¦äº‹å…ˆçŸ¥é“éƒ½æœ‰å“ªäº›Executorså¯ç”¨ï¼Œæ³¨æ„ï¼Œæ˜¯å¯ç”¨ã€‚ä¹Ÿå°±æ˜¯TaskSchedulerçš„æ ¸å¿ƒç›®çš„ï¼Œåœ¨äºè·å–â€œå¯ç”¨â€çš„Executorsã€‚\n\nç°åœ¨æ¥å›ç­”ä½ çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯ï¼šä¸ºä»€ä¹ˆExecutorDataä¸å­˜å‚¨äºå†…å­˜ç›¸å…³çš„ä¿¡æ¯ã€‚ç­”æ¡ˆæ˜¯ï¼šä¸éœ€è¦ã€‚ä¸€æ¥ï¼ŒTaskSchedulerè¦è¾¾åˆ°ç›®çš„ï¼Œå®ƒåªéœ€çŸ¥é“Executorsæ˜¯å¦æœ‰ç©ºé—²CPUã€æœ‰å‡ ä¸ªç©ºé—²CPUå°±å¯ä»¥äº†ï¼Œæœ‰è¿™äº›ä¿¡æ¯å°±è¶³ä»¥è®©ä»–å†³å®šæ˜¯å¦æŠŠtasksè°ƒåº¦åˆ°ç›®æ ‡Executorsä¸Šå»ã€‚äºŒæ¥ï¼Œæ¯ä¸ªExecutorsçš„å†…å­˜æ€»å¤§å°ï¼Œåœ¨Sparké›†ç¾¤å¯åŠ¨çš„æ—¶å€™å°±ç¡®å®šäº†ï¼Œå› æ­¤ï¼ŒExecutorDataè‡ªç„¶æ˜¯æ²¡å¿…è¦è®°å½•åƒTotal Memoryè¿™æ ·çš„å†—ä½™ä¿¡æ¯ã€‚\n\nå†æ¥è¯´Free Memoryï¼Œé¦–å…ˆï¼Œæˆ‘ä»¬è¯´è¿‡ï¼ŒSparkå¯¹äºå†…å­˜çš„é¢„ä¼°ä¸å‡†ï¼Œå†è€…ï¼Œæ¯ä¸ªExecutorsçš„å¯ç”¨å†…å­˜éƒ½ä¼šéšç€GCçš„æ‰§è¡Œè€ŒåŠ¨æ€å˜åŒ–ï¼Œå› æ­¤ï¼ŒExecutorDataè®°å½•çš„Free Memoryï¼Œæ°¸è¿œéƒ½æ˜¯è¿‡æ—¶çš„ä¿¡æ¯ï¼ŒTaskScheduleræ‹¿åˆ°è¿™æ ·çš„ä¿¡æ¯ï¼Œä¹Ÿæ²¡å•¥ç”¨ã€‚ä¸€è€…æ˜¯ä¸å‡†ï¼ŒäºŒæ¥ç¡®å®æ²¡ç”¨ï¼Œå› ä¸ºTaskScheduleræ‹¿ä¸åˆ°æ•°æ®åˆ†ç‰‡å¤§å°è¿™æ ·çš„ä¿¡æ¯ï¼ŒTaskScheduleråœ¨Driverç«¯ï¼Œè€Œæ•°æ®åˆ†ç‰‡æ˜¯åœ¨ç›®æ ‡Executorsï¼Œæ‰€ä»¥TaskScheduleræ‹¿åˆ°Free Memoryä¹Ÿæ²¡å•¥ç”¨ï¼Œå› ä¸ºå®ƒä¹Ÿä¸èƒ½åˆ¤æ–­è¯´ï¼štaskè¦å¤„ç†çš„æ•°æ®åˆ†ç‰‡ï¼Œæ˜¯ä¸æ˜¯è¶…è¿‡äº†ç›®æ ‡Executorsçš„å¯ç”¨å†…å­˜ã€‚\n\nç»¼ä¸Šï¼ŒExecutorDataçš„æ•°æ®ç»“æ„ä¸­ï¼Œåªä¿å­˜äº†CPUä¿¡æ¯ï¼Œè€Œæ²¡æœ‰è®°å½•å†…å­˜æ¶ˆè€—ç­‰ä¿¡æ¯ã€‚ä¸çŸ¥é“è¿™äº›èƒ½ä¸èƒ½è§£ç­”ä½ çš„é—®é¢˜ï¼Ÿæœ‰é—®é¢˜å†èŠå“ˆ~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619339198,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":289728,"user_name":"zxk","can_delete":false,"product_type":"c1","uid":1221195,"ip_address":"","ucode":"4BB2BD9D2BCD04","user_header":"https://static001.geekbang.org/account/avatar/00/12/a2/4b/b72f724f.jpg","comment_is_top":false,"comment_ctime":1619156652,"is_pvip":false,"replies":[{"id":"105146","content":"å¯¹ï¼Œå¦‚æœç”¨ç£ç›˜Cacheçš„è¯ï¼Œåªè¦æŠŠâ€œæœ€å°å…¬å…±å­é›†â€éƒ½Cacheä½å°±è¡Œäº†~ ReuseExchangeè™½ç„¶æ•ˆæœç›¸åŒï¼Œä½†æ˜¯å‰ææ¡ä»¶ç¡®å®æ¯”è¾ƒè‹›åˆ»ï¼Œä¸å®¹æ˜“å‘½ä¸­ã€‚æ‰€ä»¥ç¨³å¦¥çš„è¯ï¼Œè¿˜æ˜¯ä½¿ç”¨Disk Cacheã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1619314535,"ip_address":"","comment_id":289728,"utype":1}],"discussion_count":2,"race_medal":0,"score":"23093993132","product_id":100073401,"comment_content":"è€å¸ˆï¼Œå¦‚æœæˆ‘åœ¨ df.groupBy(&quot;userId&quot;) ååšç£ç›˜ cache ï¼Œåç»­å†åšä¸¤ä¸ª agg æ“ä½œï¼Œæ˜¯å¦è·Ÿ ReuseExchange æ•ˆæœä¸€æ ·ï¼Ÿå¦‚æœä¸€æ ·çš„è¯ï¼Œé‚£ä¹ˆè¿™æ—¶å€™æ˜¯ä¸æ˜¯å¯ä»¥ä¸ç”¨ç®¡ agg é‡Œæ¶‰åŠçš„å­—æ®µäº†ï¼Ÿ","like_count":5,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":519005,"discussion_content":"å¯¹ï¼Œå¦‚æœç”¨ç£ç›˜Cacheçš„è¯ï¼Œåªè¦æŠŠâ€œæœ€å°å…¬å…±å­é›†â€éƒ½Cacheä½å°±è¡Œäº†~ ReuseExchangeè™½ç„¶æ•ˆæœç›¸åŒï¼Œä½†æ˜¯å‰ææ¡ä»¶ç¡®å®æ¯”è¾ƒè‹›åˆ»ï¼Œä¸å®¹æ˜“å‘½ä¸­ã€‚æ‰€ä»¥ç¨³å¦¥çš„è¯ï¼Œè¿˜æ˜¯ä½¿ç”¨Disk Cacheã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619314535,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1056982,"avatar":"https://static001.geekbang.org/account/avatar/00/10/20/d6/b9513db0.jpg","nickname":"kingcall","note":"","ucode":"508884DC684B5B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":370634,"discussion_content":"å“ˆå“ˆ RelationalGroupedDataset ä¹Ÿå°±æ˜¯ä½ groupByåçš„DataFrame ä¸æ”¯æŒcache ","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1619488582,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":291320,"user_name":"aof","can_delete":false,"product_type":"c1","uid":1062864,"ip_address":"","ucode":"5815D63C4926BC","user_header":"https://static001.geekbang.org/account/avatar/00/10/37/d0/26975fba.jpg","comment_is_top":false,"comment_ctime":1620204920,"is_pvip":false,"replies":[{"id":"105591","content":"è¯´å¾—å¥½~ ğŸ‘ï¼Œæ•°æ®å€¾æ–œç¡®å®æ˜¯ä¸ªéšæ‚£ã€‚<br><br>æœ‰ä¸€ç±»åœºæ™¯ï¼Œå…¶å®ä¸é€‚åˆç”¨ReuseExchangeï¼Œå°±æ˜¯â€œä¸€ä¸ªå¤§Shuffleï¼Œæ›¿ä»£ä¸¤ä¸ªå°Shuffleâ€ã€‚ä¹Ÿå°±æ˜¯ä¸¤ä¸ªå¸¦Filterçš„Shuffleï¼ŒFilterä¹‹åæ•°æ®é›†æ¯”è¾ƒå°ï¼Œåé¢å³ä¾¿å¸¦Shuffleï¼Œå…¶å®å¼€é”€ä¹Ÿè¿˜å¥½ã€‚è¿™ä¸ªæ—¶å€™ï¼Œä¸ºäº†åˆ©ç”¨ReuseExchangeï¼Œå¦‚æœå¼ºè¡Œåœ¨æœ€å‰é¢Repartitionï¼Œé‚£ä¹ˆå°±æŠŠä¸¤ä¸ªå°Shuffleï¼Œå˜æˆäº†ä¸€ä¸ªå¤§Shuffleï¼Œå¦‚æœè¿™ä¸ªå¤§Shuffleçš„å¼€é”€ï¼Œå¤§äºä¸¤ä¸ªå°Shuffleçš„å¼€é”€ï¼Œé‚£ä¹ˆReuseExchangeå°±æ˜¯ä¸å€¼å¾—çš„ã€‚<br><br>å½“ç„¶ï¼Œè¿™ä¹ˆè¯´å¯èƒ½æ¯”è¾ƒæŠ½è±¡ï¼Œç­‰ä»¥åæœ‰æœºä¼šï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾ä¸ªä¾‹å­è®²ä¸€è®²ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨å¹³æ—¶å¤šå…³æ³¨ä¸‹è¿™ç§â€œä¸¤ä¸ªç›¸ä¼¼çš„å°Shuffleï¼Œä¸ä¸€ä¸ªå¤§Shuffleâ€ä¹‹é—´çš„å¼€é”€å¯¹æ¯”ï¼Œæˆ–è€…å›æƒ³ä¸€ä¸‹ï¼Œä¹‹å‰å·¥ä½œé‡Œé¢æœ‰æ²¡æœ‰é‡åˆ°ç±»ä¼¼çš„Caseã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1620315893,"ip_address":"","comment_id":291320,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18800074104","product_id":100073401,"comment_content":"ç¬¬äºŒé¢˜ï¼Œæƒ³åˆ°æœ‰ä¸€ç§æƒ…å†µï¼šå‡å¦‚åŸå§‹æ—¥å¿—æ•°æ®ä¸­ï¼ŒæŸäº›ç”¨æˆ·çš„è®¿é—®æ—¥å¿—æ¯”è¾ƒå¤šï¼Œè€Œä¸”åœ¨è°ƒç”¨repartition()å“ˆå¸Œåˆ†åŒºä¹‹åï¼Œæ°å¥½éƒ½è½åˆ°äº†ä¸€ä¸ªåˆ†åŒºï¼Œé‚£åç»­çš„è®¡ç®—å¯èƒ½ä¼šå‡ºç°æ•°æ®å€¾æ–œã€‚å…¶ä»–çš„æ²¡æƒ³åˆ°å“ˆå“ˆ","like_count":4,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":519439,"discussion_content":"è¯´å¾—å¥½~ ğŸ‘ï¼Œæ•°æ®å€¾æ–œç¡®å®æ˜¯ä¸ªéšæ‚£ã€‚\n\næœ‰ä¸€ç±»åœºæ™¯ï¼Œå…¶å®ä¸é€‚åˆç”¨ReuseExchangeï¼Œå°±æ˜¯â€œä¸€ä¸ªå¤§Shuffleï¼Œæ›¿ä»£ä¸¤ä¸ªå°Shuffleâ€ã€‚ä¹Ÿå°±æ˜¯ä¸¤ä¸ªå¸¦Filterçš„Shuffleï¼ŒFilterä¹‹åæ•°æ®é›†æ¯”è¾ƒå°ï¼Œåé¢å³ä¾¿å¸¦Shuffleï¼Œå…¶å®å¼€é”€ä¹Ÿè¿˜å¥½ã€‚è¿™ä¸ªæ—¶å€™ï¼Œä¸ºäº†åˆ©ç”¨ReuseExchangeï¼Œå¦‚æœå¼ºè¡Œåœ¨æœ€å‰é¢Repartitionï¼Œé‚£ä¹ˆå°±æŠŠä¸¤ä¸ªå°Shuffleï¼Œå˜æˆäº†ä¸€ä¸ªå¤§Shuffleï¼Œå¦‚æœè¿™ä¸ªå¤§Shuffleçš„å¼€é”€ï¼Œå¤§äºä¸¤ä¸ªå°Shuffleçš„å¼€é”€ï¼Œé‚£ä¹ˆReuseExchangeå°±æ˜¯ä¸å€¼å¾—çš„ã€‚\n\nå½“ç„¶ï¼Œè¿™ä¹ˆè¯´å¯èƒ½æ¯”è¾ƒæŠ½è±¡ï¼Œç­‰ä»¥åæœ‰æœºä¼šï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾ä¸ªä¾‹å­è®²ä¸€è®²ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨å¹³æ—¶å¤šå…³æ³¨ä¸‹è¿™ç§â€œä¸¤ä¸ªç›¸ä¼¼çš„å°Shuffleï¼Œä¸ä¸€ä¸ªå¤§Shuffleâ€ä¹‹é—´çš„å¼€é”€å¯¹æ¯”ï¼Œæˆ–è€…å›æƒ³ä¸€ä¸‹ï¼Œä¹‹å‰å·¥ä½œé‡Œé¢æœ‰æ²¡æœ‰é‡åˆ°ç±»ä¼¼çš„Caseã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620315893,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":306145,"user_name":"wow_xiaodi","can_delete":false,"product_type":"c1","uid":1511712,"ip_address":"","ucode":"B3FB301556A7EA","user_header":"https://static001.geekbang.org/account/avatar/00/17/11/20/9f31c4f4.jpg","comment_is_top":false,"comment_ctime":1628405836,"is_pvip":false,"replies":[{"id":"111351","content":"å¥½é—®é¢˜ï¼Œpvã€uvçš„èšåˆé€»è¾‘ï¼Œç¡®å®ä¸ä¸€æ ·ï¼Œä½†æ˜¯ä»–ä»¬reuseçš„ï¼Œæ˜¯repartitionçš„shuffleç»“æœï¼Œä¹Ÿå°±æ˜¯è¿™æ¡è¯­å¥äº§ç”Ÿçš„DataFrameï¼š<br><br>val df: DataFrame = spark.read.parquet(filePath).repartition($&quot;userId&quot;)<br><br>è¿™é‡Œçš„Shuffleï¼Œè¿˜æ²¡æœ‰ä»»ä½•çš„èšåˆé€»è¾‘ï¼Œçº¯ç²¹æ˜¯æ•°æ®çš„é‡åˆ†å‘è€Œå·²ã€‚è¿™æ ·Shuffleè¿‡åï¼Œå®é™…ä¸Šæå‰æŒ‰ç…§userIdåšäº†åˆ†ç»„ï¼Œä¹Ÿå°±æ˜¯ä½ è¯´çš„ï¼Œçº¯ç²¹æŒ‰ç…§&lt;partitionid, key&gt;åšæ•°æ®åˆ†å‘ã€‚å› æ­¤ï¼Œåé¢çš„è¯­å¥é‡Œé¢çš„groupByå®é™…ä¸Šå°±è¢«â€œbypassâ€äº†ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå°½ç®¡è¯­æ³•ä¸Šæ˜¯åœ¨åšåˆ†ç»„ï¼Œä½†æ˜¯åˆ†ç»„è¿™ä»¶äº‹ï¼Œå·²ç»æå‰è¢«åšäº†ã€‚<br><br>val dfPV: DataFrame = df.groupBy(&quot;userId&quot;).agg(count(&quot;page&quot;).alias(&quot;value&quot;)).withColumn(&quot;metrics&quot;, lit(&quot;PV&quot;))<br><br>val dfUV: DataFrame = df.groupBy(&quot;userId&quot;).agg(countDistinct(&quot;page&quot;).alias(&quot;value&quot;)).withColumn(&quot;metrics &quot;, lit(&quot;UV&quot;))<br><br>æ‰€ä»¥ï¼Œæ€»ç»“ä¸‹æ¥ï¼Œåé¢èšåˆé€»è¾‘çš„ä¸åŒï¼Œå¹¶ä¸å½±å“pvã€uvå…±äº«ï¼ˆreuseï¼‰åˆ†ç»„ä¹‹åçš„é‚£ä»½æ•°æ®é›†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1629185879,"ip_address":"","comment_id":306145,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14513307724","product_id":100073401,"comment_content":"è€å¸ˆæ‚¨å¥½ï¼Œå…³äºReuseExchangeçš„ä¾‹å­ï¼Œç”±äºè®¡ç®—pv uvçš„èšåˆç®—æ³•æ˜¯ä¸ä¸€æ ·çš„ï¼Œé‚£ä¹ˆåœ¨spillé˜¶æ®µå°±ä¸å¯èƒ½è¿›è¡Œç›¸åŒçš„map combineæ“ä½œã€‚è¿™ä¸ªReuseExchangeé‡Œå‘ç”Ÿçš„shuffleæ˜¯ä¸æ˜¯å•çº¯åªåšäº†æŒ‰&lt;partitionid, key&gt;æ¥æ’åºçš„æ“ä½œï¼Œè€Œæ²¡æœ‰è¿›è¡Œcombineæ“ä½œå‘¢ï¼Ÿè€Œä¸”å¯¹äºmapç«¯èšåˆå‘ç”Ÿåœ¨shuffleé˜¶æ®µåé¢ï¼Œè¿˜ç´§æ¥ç€reduceèšåˆæ“ä½œï¼Œä¸æ˜¯å¾ˆç¬¦åˆå¸¸è§„mrè¿‡ç¨‹ï¼Œæœ‰ç‚¹éš¾ç†è§£ï¼Œæœ›è€å¸ˆæŒ‡ç‚¹è¿·æ´¥ã€‚","like_count":3,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":524646,"discussion_content":"å¥½é—®é¢˜ï¼Œpvã€uvçš„èšåˆé€»è¾‘ï¼Œç¡®å®ä¸ä¸€æ ·ï¼Œä½†æ˜¯ä»–ä»¬reuseçš„ï¼Œæ˜¯repartitionçš„shuffleç»“æœï¼Œä¹Ÿå°±æ˜¯è¿™æ¡è¯­å¥äº§ç”Ÿçš„DataFrameï¼š\n\nval df: DataFrame = spark.read.parquet(filePath).repartition($&amp;quot;userId&amp;quot;)\n\nè¿™é‡Œçš„Shuffleï¼Œè¿˜æ²¡æœ‰ä»»ä½•çš„èšåˆé€»è¾‘ï¼Œçº¯ç²¹æ˜¯æ•°æ®çš„é‡åˆ†å‘è€Œå·²ã€‚è¿™æ ·Shuffleè¿‡åï¼Œå®é™…ä¸Šæå‰æŒ‰ç…§userIdåšäº†åˆ†ç»„ï¼Œä¹Ÿå°±æ˜¯ä½ è¯´çš„ï¼Œçº¯ç²¹æŒ‰ç…§&amp;lt;partitionid, key&amp;gt;åšæ•°æ®åˆ†å‘ã€‚å› æ­¤ï¼Œåé¢çš„è¯­å¥é‡Œé¢çš„groupByå®é™…ä¸Šå°±è¢«â€œbypassâ€äº†ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå°½ç®¡è¯­æ³•ä¸Šæ˜¯åœ¨åšåˆ†ç»„ï¼Œä½†æ˜¯åˆ†ç»„è¿™ä»¶äº‹ï¼Œå·²ç»æå‰è¢«åšäº†ã€‚\n\nval dfPV: DataFrame = df.groupBy(&amp;quot;userId&amp;quot;).agg(count(&amp;quot;page&amp;quot;).alias(&amp;quot;value&amp;quot;)).withColumn(&amp;quot;metrics&amp;quot;, lit(&amp;quot;PV&amp;quot;))\n\nval dfUV: DataFrame = df.groupBy(&amp;quot;userId&amp;quot;).agg(countDistinct(&amp;quot;page&amp;quot;).alias(&amp;quot;value&amp;quot;)).withColumn(&amp;quot;metrics &amp;quot;, lit(&amp;quot;UV&amp;quot;))\n\næ‰€ä»¥ï¼Œæ€»ç»“ä¸‹æ¥ï¼Œåé¢èšåˆé€»è¾‘çš„ä¸åŒï¼Œå¹¶ä¸å½±å“pvã€uvå…±äº«ï¼ˆreuseï¼‰åˆ†ç»„ä¹‹åçš„é‚£ä»½æ•°æ®é›†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629185879,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":290211,"user_name":"Geek_d794f8","can_delete":false,"product_type":"c1","uid":2485585,"ip_address":"","ucode":"1E20DA4FF8B800","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIiaeebUYxl7e4jicPshDRKMbiculHUjKgZZ2ygDibn2S7bbsjeqYIdsEUdVyoryKNa43ZGnDQmWjv3ibQ/132","comment_is_top":false,"comment_ctime":1619431242,"is_pvip":false,"replies":[{"id":"105341","content":"å¥½é—®é¢˜ï¼Œè¿™é‡Œç¡®å®æœ‰ç‚¹Trickyã€‚<br><br>è¿™éƒ¨åˆ†å…¶å®éœ€è¦ä¸€äº›â€œå‰ç½®å¼•ç”¨â€çš„çŸ¥è¯†ï¼Œè¿™äº›çŸ¥è¯†å…¶å®æ˜¯åœ¨22è®²Physical Planningæ‰ä¼šæ¶‰åŠï¼Œæ‰€ä»¥åœ¨è¿™ä¸€è®²è¿™é‡Œä¼šæ¯”è¾ƒéš¾ç†è§£ã€‚<br><br>æ˜¯è¿™æ ·çš„ï¼ŒSpark SQLæ‰§è¡Œè®¡åˆ’ä¸­çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œéƒ½æœ‰4ä¸ªé‡è¦çš„å±æ€§ï¼Œåˆ†åˆ«æ˜¯ï¼š<br>èŠ‚ç‚¹è¦æ±‚çš„è¾“å…¥ï¼š<br>1ï¼‰requiredChildDistribution<br>2ï¼‰requiredChildOrdering<br>èŠ‚ç‚¹çš„è¾“å‡ºï¼š<br>3ï¼‰outputPartitioning<br>4ï¼‰outputOrdering<br><br>æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰è¾“å‡ºçš„åˆ†åŒºæƒ…å†µã€æ’åºæƒ…å†µï¼Œä¹Ÿå°±æ˜¯3ï¼‰ã€4ï¼‰ï¼›åŒæ—¶ï¼Œæ¯ä¸ªèŠ‚ç‚¹å¯¹äºè‡ªå·±çš„å­èŠ‚ç‚¹ï¼Œéƒ½æœ‰å…³äº åˆ†åŒºå’Œæ’åºçš„è¦æ±‚ï¼Œä¹Ÿå°±æ˜¯1ï¼‰ã€2ï¼‰ã€‚<br><br>å½“å­èŠ‚ç‚¹çš„åˆ†åŒºä¸æ’åºæƒ…å†µï¼Œä¸æ»¡è¶³å½“å‰èŠ‚ç‚¹çš„è¾“å…¥è¦æ±‚æ—¶ï¼ŒSpark SQLå°±ä¼šåœ¨Physical planningé˜¶æ®µï¼Œå¼ºè¡Œæ’å…¥ä¸€äº›ä¸­é—´èŠ‚ç‚¹ï¼Œæ¯”å¦‚Exchangeï¼ˆShuffleï¼‰ã€‚<br><br>å›ç­”ä½ çš„é—®é¢˜ï¼šå’±ä»¬çš„ä¾‹å­ä¸­ï¼Œä¸¤ä¸ªgroupByï¼Œéƒ½æ˜¯ä»Parquetè¯»æºæ•°æ®ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œè¯»å–Parquetçš„ScanèŠ‚ç‚¹ï¼Œå®ƒçš„outputPartitioningï¼Œå’ŒgroupByè¿™ä¸ªèŠ‚ç‚¹å¯¹äºè¾“å…¥çš„è¦æ±‚ï¼Œä¸¤è€…æ˜¯ä¸matchçš„ï¼Œå› æ­¤ï¼ŒSpark SQLä¼šå¼ºè¡Œæ’å…¥Exchangeæ“ä½œç¬¦ã€‚<br><br>å°½ç®¡æˆ‘ä»¬è‚‰çœ¼èƒ½çœ‹å‡ºæ¥ï¼Œä¸¤ä¸ªgroupByéœ€è¦çš„shuffleæ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯ï¼ŒSpark SQLå¯ä¸çŸ¥é“ï¼Œè¿™ä»¶äº‹å¯¹å®ƒæ¥è¯´ï¼Œæ˜¯é€æ˜çš„ã€‚å®ƒæ²¡æœ‰ä»»ä½•æ¸ é“ï¼Œå»çŸ¥é“è¯´ï¼šâ€œOKï¼Œä»–ä¿©æ˜¯ä¸€æ ·çš„ï¼Œæˆ‘å¯ä»¥å¤ç”¨â€<br><br>repartitionçš„æ„ä¹‰åœ¨äºï¼Œå®ƒä¸€ä¸‹å˜æˆäº†ä¸¤ä¸ªgroupByå…±åŒçš„ä¾èµ–ï¼Œrepartitionä¹‹åçš„DataFrameï¼Œå®ƒçš„outputPartitioningï¼Œåˆšå¥½éƒ½æ˜¯groupByèŠ‚ç‚¹æ‰€éœ€è¦çš„ï¼Œå› æ­¤Spark SQLå›æº¯åˆ°è¿™é‡Œçš„æ—¶å€™ï¼Œå°±ä¼šå‘ç°ï¼šâ€œæˆ‘å»ï¼Œä¹‹å‰çš„è®¡ç®—å·²ç»æ»¡è¶³æˆ‘çš„requiredChildDistributionï¼Œæˆ‘ç›´æ¥æ‹¿æ¥ç”¨å°±å¥½äº†ã€‚â€<br><br>é€»è¾‘å°±æ˜¯è¿™ä¹ˆä¸ªé€»è¾‘ï¼Œå¯èƒ½ä¸€ä¸¤å¥è¯æ²¡è¯´æ¸…æ¥šï¼Œå¯ä»¥é‡ç‚¹å…³æ³¨22è®²çš„EnsureRequirementsé‚£éƒ¨åˆ†ï¼Œé‚£éƒ¨åˆ†ä¼šå’±ä»¬è¿™é‡Œäº¤ä»£çš„é€»è¾‘åšè¯¦ç»†å±•å¼€å“ˆ~","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1619693616,"ip_address":"","comment_id":290211,"utype":1}],"discussion_count":2,"race_medal":0,"score":"14504333130","product_id":100073401,"comment_content":"è€å¸ˆï¼Œdf.groupBy(&quot;userId&quot;).agg(count(&quot;page&quot;)å’Œdf.groupBy(&quot;userId&quot;).agg(countDistinct(&quot;page&quot;)éƒ½ä¼šæŒ‰ç…§userIdçš„hashcodeå€¼è¿›è¡ŒHash Partitionerã€‚è€Œrepartition($&quot;userId&quot;)ï¼Œåªä¸è¿‡æ˜¯åœ¨è¿™ä¹‹å‰è¿›è¡Œäº†Hash Partitionerçš„shuffleæ“ä½œã€‚æœ¬è´¨ä¸Šæ˜¯ä¸€æ ·çš„å‘€ï¼Ÿä¸ºä»€ä¹ˆæœ€åä¸€ä¸ªä¼šreuseExchangeï¼Œä¸€ä¸ªä¸ä¼šå‘¢ï¼Ÿ","like_count":3,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":519139,"discussion_content":"å¥½é—®é¢˜ï¼Œè¿™é‡Œç¡®å®æœ‰ç‚¹Trickyã€‚\n\nè¿™éƒ¨åˆ†å…¶å®éœ€è¦ä¸€äº›â€œå‰ç½®å¼•ç”¨â€çš„çŸ¥è¯†ï¼Œè¿™äº›çŸ¥è¯†å…¶å®æ˜¯åœ¨22è®²Physical Planningæ‰ä¼šæ¶‰åŠï¼Œæ‰€ä»¥åœ¨è¿™ä¸€è®²è¿™é‡Œä¼šæ¯”è¾ƒéš¾ç†è§£ã€‚\n\næ˜¯è¿™æ ·çš„ï¼ŒSpark SQLæ‰§è¡Œè®¡åˆ’ä¸­çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œéƒ½æœ‰4ä¸ªé‡è¦çš„å±æ€§ï¼Œåˆ†åˆ«æ˜¯ï¼š\nèŠ‚ç‚¹è¦æ±‚çš„è¾“å…¥ï¼š\n1ï¼‰requiredChildDistribution\n2ï¼‰requiredChildOrdering\nèŠ‚ç‚¹çš„è¾“å‡ºï¼š\n3ï¼‰outputPartitioning\n4ï¼‰outputOrdering\n\næ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰è¾“å‡ºçš„åˆ†åŒºæƒ…å†µã€æ’åºæƒ…å†µï¼Œä¹Ÿå°±æ˜¯3ï¼‰ã€4ï¼‰ï¼›åŒæ—¶ï¼Œæ¯ä¸ªèŠ‚ç‚¹å¯¹äºè‡ªå·±çš„å­èŠ‚ç‚¹ï¼Œéƒ½æœ‰å…³äº åˆ†åŒºå’Œæ’åºçš„è¦æ±‚ï¼Œä¹Ÿå°±æ˜¯1ï¼‰ã€2ï¼‰ã€‚\n\nå½“å­èŠ‚ç‚¹çš„åˆ†åŒºä¸æ’åºæƒ…å†µï¼Œä¸æ»¡è¶³å½“å‰èŠ‚ç‚¹çš„è¾“å…¥è¦æ±‚æ—¶ï¼ŒSpark SQLå°±ä¼šåœ¨Physical planningé˜¶æ®µï¼Œå¼ºè¡Œæ’å…¥ä¸€äº›ä¸­é—´èŠ‚ç‚¹ï¼Œæ¯”å¦‚Exchangeï¼ˆShuffleï¼‰ã€‚\n\nå›ç­”ä½ çš„é—®é¢˜ï¼šå’±ä»¬çš„ä¾‹å­ä¸­ï¼Œä¸¤ä¸ªgroupByï¼Œéƒ½æ˜¯ä»Parquetè¯»æºæ•°æ®ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œè¯»å–Parquetçš„ScanèŠ‚ç‚¹ï¼Œå®ƒçš„outputPartitioningï¼Œå’ŒgroupByè¿™ä¸ªèŠ‚ç‚¹å¯¹äºè¾“å…¥çš„è¦æ±‚ï¼Œä¸¤è€…æ˜¯ä¸matchçš„ï¼Œå› æ­¤ï¼ŒSpark SQLä¼šå¼ºè¡Œæ’å…¥Exchangeæ“ä½œç¬¦ã€‚\n\nå°½ç®¡æˆ‘ä»¬è‚‰çœ¼èƒ½çœ‹å‡ºæ¥ï¼Œä¸¤ä¸ªgroupByéœ€è¦çš„shuffleæ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯ï¼ŒSpark SQLå¯ä¸çŸ¥é“ï¼Œè¿™ä»¶äº‹å¯¹å®ƒæ¥è¯´ï¼Œæ˜¯é€æ˜çš„ã€‚å®ƒæ²¡æœ‰ä»»ä½•æ¸ é“ï¼Œå»çŸ¥é“è¯´ï¼šâ€œOKï¼Œä»–ä¿©æ˜¯ä¸€æ ·çš„ï¼Œæˆ‘å¯ä»¥å¤ç”¨â€\n\nrepartitionçš„æ„ä¹‰åœ¨äºï¼Œå®ƒä¸€ä¸‹å˜æˆäº†ä¸¤ä¸ªgroupByå…±åŒçš„ä¾èµ–ï¼Œrepartitionä¹‹åçš„DataFrameï¼Œå®ƒçš„outputPartitioningï¼Œåˆšå¥½éƒ½æ˜¯groupByèŠ‚ç‚¹æ‰€éœ€è¦çš„ï¼Œå› æ­¤Spark SQLå›æº¯åˆ°è¿™é‡Œçš„æ—¶å€™ï¼Œå°±ä¼šå‘ç°ï¼šâ€œæˆ‘å»ï¼Œä¹‹å‰çš„è®¡ç®—å·²ç»æ»¡è¶³æˆ‘çš„requiredChildDistributionï¼Œæˆ‘ç›´æ¥æ‹¿æ¥ç”¨å°±å¥½äº†ã€‚â€\n\né€»è¾‘å°±æ˜¯è¿™ä¹ˆä¸ªé€»è¾‘ï¼Œå¯èƒ½ä¸€ä¸¤å¥è¯æ²¡è¯´æ¸…æ¥šï¼Œå¯ä»¥é‡ç‚¹å…³æ³¨22è®²çš„EnsureRequirementsé‚£éƒ¨åˆ†ï¼Œé‚£éƒ¨åˆ†ä¼šå’±ä»¬è¿™é‡Œäº¤ä»£çš„é€»è¾‘åšè¯¦ç»†å±•å¼€å“ˆ~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619693616,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1056982,"avatar":"https://static001.geekbang.org/account/avatar/00/10/20/d6/b9513db0.jpg","nickname":"kingcall","note":"","ucode":"508884DC684B5B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":370538,"discussion_content":"ä¸ºäº†æ»¡è¶³æ–‡ä¸­æåˆ°çš„ç¬¬ä¸€ä¸ªæ¡ä»¶ï¼ŒæŸ¥è¯¢çš„åˆ†åŒºè§„åˆ™å’Œshuffle çš„åˆ†åŒºè§„åˆ™ä¸€è‡´ï¼Œæ‰€ä»¥ä½ çœ‹åˆ°æˆ‘ä»¬è¿™é‡Œçš„groupBy çš„key æ˜¯userIdï¼Œrepartitionçš„key ä¹Ÿæ˜¯userId","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1619446159,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":290012,"user_name":"RespectM","can_delete":false,"product_type":"c1","uid":2536840,"ip_address":"","ucode":"7FA4F794D2D859","user_header":"https://static001.geekbang.org/account/avatar/00/26/b5/88/477e7812.jpg","comment_is_top":false,"comment_ctime":1619320702,"is_pvip":false,"replies":[{"id":"105232","content":"ç¡®å®æ˜¯çœ‹éœ€æ±‚ã€çœ‹åœºæ™¯å“ˆï¼Œæ²¡æœ‰ä¸€ä¸ªç»Ÿä¸€çš„æ ‡å‡†ï¼Œä¸è¿‡ï¼Œè¿˜æ˜¯æœ‰ä¸€äº›Generalçš„Guidelineså¯ä»¥éµå¾ªï¼Œæ ¸å¿ƒæ€è·¯è¿˜æ˜¯â€œæ¶ˆé™¤ç“¶é¢ˆâ€ã€‚ç¡¬ä»¶çš„é€‰å‹ï¼Œå–å†³äºä½ çš„è®¡ç®—è´Ÿè½½ç±»å‹ï¼Œä¹Ÿå°±æ˜¯è®¡ç®—å¯†é›†å‹ï¼Ÿå†…å­˜å¯†é›†å‹ï¼Ÿè¿˜æ˜¯ç£ç›˜ã€ç½‘ç»œå¯†é›†å‹ï¼Ÿ<br><br>æˆ‘ä»¬æ¥åˆ†ç±»è®¨è®ºï¼š<br>1. å¦‚æœä½ çš„è®¡ç®—åœºæ™¯æ¶‰åŠåˆ°å¤§é‡çš„èšåˆã€æ’åºã€å“ˆå¸Œè®¡ç®—ã€æ•°å€¼è®¡ç®—ï¼Œç­‰ç­‰ï¼Œé‚£ä¹ˆä½ çš„æœºå™¨é…ç½®å°±è¦åŠ å¼ºCPU<br>2. å¦‚æœä½ çš„è®¡ç®—åœºæ™¯éœ€è¦åå¤æ¶ˆè€—åŒä¸€ä»½æˆ–æ˜¯åŒä¸€æ‰¹æ•°æ®é›†ï¼Œæ¯”å¦‚æœºå™¨å­¦ä¹ ã€æ•°æ®åˆ†æã€å›¾è®¡ç®—ï¼Œé‚£ä¹ˆï¼Œä¸ºäº†æŠŠéœ€è¦é¢‘ç¹è®¿é—®çš„æ•°æ®ç¼“å­˜è¿›å†…å­˜ï¼Œä½ è‡ªç„¶éœ€è¦åŠ å¤§å†…å­˜é…ç½®ã€‚<br>3. å¦‚æœä½ çš„è®¡ç®—åœºæ™¯ä¼šå¼•å…¥å¤§é‡shuffleï¼Œåˆä¸èƒ½é€šè¿‡å¹¿æ’­æ¥æ¶ˆé™¤Shuffleï¼Œé‚£ä¹ˆä½ å°±éœ€è¦é…ç½®è¶³å¤Ÿçš„SSDä»¥åŠé«˜ååç½‘ç»œã€‚<br><br>è§£ç­”å¾—æ¯”è¾ƒç²—ç³™ï¼Œå¹¶æ²¡æœ‰å…·ä½“å¯æ“ä½œçš„å»ºè®®ï¼Œéƒ½æ˜¯ä¸€äº›Guidelinesï¼Œå¸Œæœ›èƒ½å¸®åˆ°ä½ ~<br><br>","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1619512708,"ip_address":"","comment_id":290012,"utype":1}],"discussion_count":2,"race_medal":0,"score":"14504222590","product_id":100073401,"comment_content":"è€å¸ˆå¥½ï¼Œå¯ä»¥è®²è®²ä¼ä¸šçº§Sparkçš„æœºå™¨ç¡¬ä»¶è¯¥å¦‚ä½•é€‰è¡Œå—ï¼Œä»¥åŠåº”è¯¥è€ƒè™‘å“ªäº›é—®é¢˜ã€‚ç½‘ä¸Šéƒ½æ˜¯è¯´æ ¹æ®éœ€æ±‚ï¼Œæœ‰ä»€ä¹ˆæ ¹æ®å—ï¼Œèƒ½ä¸èƒ½ä¸¾ä¸ªä¾‹å­ã€‚","like_count":3,"discussions":[{"author":{"id":2536840,"avatar":"https://static001.geekbang.org/account/avatar/00/26/b5/88/477e7812.jpg","nickname":"RespectM","note":"","ucode":"7FA4F794D2D859","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":371018,"discussion_content":"è°¢è°¢è€å¸ˆï¼Œæˆ‘ç°åœ¨é‡åˆ°ä¸¤ä¸ªé—®é¢˜å§‹ç»ˆæ‰¾ä¸åˆ°åŸå› ã€‚ä¸€ä¸ªæ˜¯æ¯”è¾ƒå¤§çš„è¡¨(parquet snappy)ä¸­æœ‰å¤§mapç±»å‹ï¼Œå½“joinçš„æ—¶å€™ï¼Œshuffleæ—¶å€™æ€»ion ï¼Œå³ä¾¿åˆ†äº†å¾ˆå¤§çš„å†…å­˜å’Œå †å¤–å†…å­˜ï¼Œyarnè¿˜æ˜¯ä¼šoom ã€‚ç„¶è€Œç”¨hiveè·‘ï¼Œåˆ†å¾ˆå°‘å†…å­˜å°±å¯ä»¥è·‘è¿‡ã€‚è¿˜æœ‰ä¸€ä¸ªå°±æ˜¯yarn çš„ resourcemanager æ€»è¢«sparkç¨‹åºè·‘æŒ‚ï¼Œæ€ä¹ˆèƒ½æé«˜å®ƒçš„ç¨³å®šæ€§å‘¢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619612378,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":2536840,"avatar":"https://static001.geekbang.org/account/avatar/00/26/b5/88/477e7812.jpg","nickname":"RespectM","note":"","ucode":"7FA4F794D2D859","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375917,"discussion_content":"OOMçš„é—®é¢˜ï¼Œå¯ä»¥å‚è€ƒ17è®²å†…å­˜è§†è§’ä¸‰ï¼šOOMï¼Œé‚£é‡Œé¢OOMè®²çš„æ¯”è¾ƒå¤š","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621867977,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":371018,"ip_address":""},"score":375917,"extra":""}]}]},{"had_liked":false,"id":322801,"user_name":"tiankonghewo","can_delete":false,"product_type":"c1","uid":1476427,"ip_address":"","ucode":"7A55A9C17DD9DF","user_header":"https://static001.geekbang.org/account/avatar/00/16/87/4b/16ea3997.jpg","comment_is_top":false,"comment_ctime":1637593841,"is_pvip":false,"replies":[{"id":"117414","content":"ç¡®å®ï¼Œä¾‹å­ç¡®å®æœ‰äº›ç‰µå¼ºäº†ï¼Œè¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†ä»‹ç»ReuseExchangeç­–ç•¥ï¼Œæ–¹ä¾¿å¤§å®¶å®¹æ˜“ç†è§£ï¼Œè€å¼Ÿä¸å¦¨æ¨è€Œå¹¿ä¹‹ã€ä¸¾ä¸€åä¸‰å“ˆ~","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1043100","ctime":1637987092,"ip_address":"","comment_id":322801,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5932561137","product_id":100073401,"comment_content":"è¿™ç§ä¾‹å­å¾ˆç‰µå¼º, æ­£å¸¸äººéƒ½æ˜¯ aggä¸­ç›´æ¥countå’ŒcountDistinctäº†, è¿˜æœ‰äººåˆ†å¼€ç»Ÿè®¡å—","like_count":1,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":533826,"discussion_content":"ç¡®å®ï¼Œä¾‹å­ç¡®å®æœ‰äº›ç‰µå¼ºäº†ï¼Œè¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†ä»‹ç»ReuseExchangeç­–ç•¥ï¼Œæ–¹ä¾¿å¤§å®¶å®¹æ˜“ç†è§£ï¼Œè€å¼Ÿä¸å¦¨æ¨è€Œå¹¿ä¹‹ã€ä¸¾ä¸€åä¸‰å“ˆ~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637987092,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":291446,"user_name":"aof","can_delete":false,"product_type":"c1","uid":1062864,"ip_address":"","ucode":"5815D63C4926BC","user_header":"https://static001.geekbang.org/account/avatar/00/10/37/d0/26975fba.jpg","comment_is_top":false,"comment_ctime":1620290445,"is_pvip":false,"replies":[{"id":"105585","content":"ç¡®å®æ¯”è¾ƒè‹›åˆ»~","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1620312164,"ip_address":"","comment_id":291446,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5915257741","product_id":100073401,"comment_content":"éªŒè¯äº†ä¸€ä¸‹ç¬¬ä¸€é¢˜ï¼Œæ”¹æˆcount(*)ä¹‹åå†æ‰“å°Physical Planå‘ç°ReuseExchangeå¤±æ•ˆäº†ï¼Œè¿™ä¹Ÿå°è¯äº†è€å¸ˆè¯´çš„ReuseExchangeçš„ç¬¬äºŒä¸ªè§¦å‘æ¡ä»¶â€œå¤šä¸ªæŸ¥è¯¢æ‰€æ¶‰åŠçš„å­—æ®µè¦ä¿æŒä¸€è‡´â€ï¼Œè¿™ä¸ªè§¦å‘æ¡ä»¶çœŸçš„æœ‰ç‚¹ä¸¥æ ¼å“ˆå“ˆ","like_count":1,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":519472,"discussion_content":"ç¡®å®æ¯”è¾ƒè‹›åˆ»~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620312164,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":290293,"user_name":"kingcall","can_delete":false,"product_type":"c1","uid":1056982,"ip_address":"","ucode":"508884DC684B5B","user_header":"https://static001.geekbang.org/account/avatar/00/10/20/d6/b9513db0.jpg","comment_is_top":false,"comment_ctime":1619489007,"is_pvip":false,"replies":[{"id":"105342","content":"ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œå¯ä»¥å‚è€ƒæˆ‘ç•™ç»™@ Geek_d794f8 åŒå­¦çš„ç­”å¤å“ˆï¼Œåº”è¯¥å°±åœ¨ä½ è¿™æ¡ç•™è¨€çš„ä¸‹é¢~<br><br>å…³äºç¬¬äºŒä¸ªé—®é¢˜ï¼Œæˆ‘ç†è§£ä½ çš„é—®é¢˜æ˜¯ï¼Œä¸ºä»€ä¹ˆgroupByä¹‹åï¼Œä¸èƒ½åŠ cacheï¼Œæˆ–è€…è¯´ï¼Œæ²¡æœ‰cache APIã€‚å…¶å®ä½ å·²ç»ç»™å‡ºç­”æ¡ˆå•¦~ ä¹Ÿå°±æ˜¯ä½ è¯´çš„1ã€2ã€‚æˆ‘åŒæ„ä½ çš„è¯´æ³•ï¼Œåˆ†ç»„è¿™ç§æ“ä½œï¼Œä»…ä»…æ˜¯èšåˆçš„å‰å¥ï¼Œæ¢å¥è¯è¯´ï¼Œå¦‚æœæ²¡æœ‰èšåˆï¼Œå¾ˆå¤šåœºæ™¯æ˜¯æ ¹æœ¬ä¸éœ€è¦åˆ†ç»„çš„ã€‚æ‰€ä»¥æŠŠä½¿ç”¨é¢‘ç‡æä½çš„æ•°æ®åšç¼“å­˜ï¼Œæ²¡æœ‰æ„ä¹‰ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1619694340,"ip_address":"","comment_id":290293,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5914456303","product_id":100073401,"comment_content":"æ„Ÿè§‰æˆ‘ä»¬åªè¦èƒ½è®©ç®—å­å¤ç”¨shuffle åçš„æ•°æ®å°±å¯ä»¥åšåˆ°å‡å°‘shuffle,ä½†æ˜¯æ–‡ä¸­æåˆ°ReuseExchangeæ¡ä»¶å¤ªè‹›åˆ»ï¼Œè€Œè¯„è®ºä¸­è¯´çš„ç¼“å­˜groupByåçš„ç»“æœä¹Ÿå°±æ˜¯shuffle åçš„ç»“æœï¼Œä¾›åç»­å¤šä¸ªèšåˆç»Ÿè®¡åˆåšä¸åˆ°ï¼Œå“ˆå“ˆï¼Œè¿™æ˜¯ä¸æ˜¯spark åç»­å¯ä»¥ä¼˜åŒ–çš„åœ°æ–¹<br>æˆ‘è§‰å¾—æƒ³æƒ³ä¸ºå•¥spark æ²¡æœ‰ç»™RelationalGroupedDataset æ·»åŠ cacheæ“ä½œï¼Œç†è®ºä¸Šæ¥è¯´shuffle åçš„æ•°æ®å’Œshuffle å‰çš„æ•°æ®é‡æ˜¯ä¸€è‡´çš„ï¼Œåªè¦shuffleå‰çš„æ•°æ®å¯ä»¥ç¼“å­˜ä¸‹æ¥ï¼Œshuffle åçš„æ•°æ®ä¹Ÿå¯ä»¥ç¼“å­˜ä¸‹æ¥,æ˜¯ä¸æ˜¯è€ƒè™‘åˆ°äº† 1. shuffle åçš„æ•°æ®å¯èƒ½åˆ†å¸ƒä¸å‡ï¼Œå¯¼è‡´ä¸ªåˆ«partition è¿‡å¤§ä¸èƒ½cache, 2. è®¤ä¸ºshuffle åçš„æ•°æ®ä½¿ç”¨é¢‘ç‡æ¯”è¾ƒä½ï¼Œæˆ‘ä»¬æ›´å¤šå…³æ³¨çš„æ˜¯shuffle èšåˆåçš„ç»“æœã€‚<br>å¸Œæœ›è€å¸ˆè§£ç­”ä¸€äºŒ","like_count":1,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":519163,"discussion_content":"ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œå¯ä»¥å‚è€ƒæˆ‘ç•™ç»™@ Geek_d794f8 åŒå­¦çš„ç­”å¤å“ˆï¼Œåº”è¯¥å°±åœ¨ä½ è¿™æ¡ç•™è¨€çš„ä¸‹é¢~\n\nå…³äºç¬¬äºŒä¸ªé—®é¢˜ï¼Œæˆ‘ç†è§£ä½ çš„é—®é¢˜æ˜¯ï¼Œä¸ºä»€ä¹ˆgroupByä¹‹åï¼Œä¸èƒ½åŠ cacheï¼Œæˆ–è€…è¯´ï¼Œæ²¡æœ‰cache APIã€‚å…¶å®ä½ å·²ç»ç»™å‡ºç­”æ¡ˆå•¦~ ä¹Ÿå°±æ˜¯ä½ è¯´çš„1ã€2ã€‚æˆ‘åŒæ„ä½ çš„è¯´æ³•ï¼Œåˆ†ç»„è¿™ç§æ“ä½œï¼Œä»…ä»…æ˜¯èšåˆçš„å‰å¥ï¼Œæ¢å¥è¯è¯´ï¼Œå¦‚æœæ²¡æœ‰èšåˆï¼Œå¾ˆå¤šåœºæ™¯æ˜¯æ ¹æœ¬ä¸éœ€è¦åˆ†ç»„çš„ã€‚æ‰€ä»¥æŠŠä½¿ç”¨é¢‘ç‡æä½çš„æ•°æ®åšç¼“å­˜ï¼Œæ²¡æœ‰æ„ä¹‰ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619694340,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":290066,"user_name":"è Ÿç­†å°å™º","can_delete":false,"product_type":"c1","uid":1264412,"ip_address":"","ucode":"694ABA92BC48C7","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJN8s3YnzyDRCeg73yzglRgQgk581uIY1FRFO01GibMro4Mbxk58rRgulZTKrSGnd8ZD6RHY8uQj2A/132","comment_is_top":false,"comment_ctime":1619343473,"is_pvip":false,"replies":[{"id":"105203","content":"å†…å­˜æ— é™å¤§ï¼ŒJVMçš„é…ç½®å‚æ•°xmxã€xmsæ˜¯æœ‰ç•Œçš„å‘€ ğŸ˜ƒ","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1619434401,"ip_address":"","comment_id":290066,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5914310769","product_id":100073401,"comment_content":"å†…å­˜æ— é™å¤§çš„æƒ…å†µä¸‹ï¼Œå¯¹è±¡ä¸ä¼šé‡åˆ°æ”¾ä¸ä¸‹çš„é—®é¢˜ï¼Œä¸ºä»€ä¹ˆä¼šæœ‰GCå‘¢ã€‚ã€‚ã€‚ã€‚","like_count":1,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":519100,"discussion_content":"å†…å­˜æ— é™å¤§ï¼ŒJVMçš„é…ç½®å‚æ•°xmxã€xmsæ˜¯æœ‰ç•Œçš„å‘€ ğŸ˜ƒ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619434401,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1221195,"avatar":"https://static001.geekbang.org/account/avatar/00/12/a2/4b/b72f724f.jpg","nickname":"zxk","note":"","ucode":"4BB2BD9D2BCD04","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":370367,"discussion_content":"ç›®å‰é™¤äº†æœ€æ–°çš„ ZGC è·Ÿ Shandoah GC å¤–ï¼Œå…¶ä»–GCæ”¶é›†å™¨çš„GCæ—¶é—´éƒ½ä¼šéšç€å †å†…å­˜çš„å¢å¤§è€Œå¢åŠ ã€‚\nè¿™é‡Œä¹Ÿæƒ³é—®ä¸‹è€å¸ˆç›®å‰æœ€æ–°çš„è¿™ä¸¤ä¸ª GC æ”¶é›†å™¨åœ¨è¶…å¤§å †è¡¨ç°å¦‚ä½•ï¼Œæ˜¯å¦èƒ½æŠ•å…¥ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619393621,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":289802,"user_name":"FendoraèŒƒä¸œ_","can_delete":false,"product_type":"c1","uid":1187106,"ip_address":"","ucode":"63EE9DBEE08D70","user_header":"https://static001.geekbang.org/account/avatar/00/12/1d/22/f04cea4c.jpg","comment_is_top":false,"comment_ctime":1619180385,"is_pvip":false,"replies":[{"id":"105147","content":"ReuseExchangeæŒ‡çš„æ˜¯ï¼Œåé¢ç›¸ä¼¼çš„è®¡ç®—é€»è¾‘å¤ç”¨Shuffleè®¡ç®—çš„ä¸­é—´æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯Shuffle mapé˜¶æ®µè¾“å‡ºåˆ°æœ¬åœ°ç£ç›˜çš„ä¸­é—´æ–‡ä»¶ï¼Œè¿™å’ŒShuffleçš„Mapç«¯èšåˆå¹¶ä¸å†²çªï¼Œå®é™…ä¸Šï¼Œç›´ç™½åœ°è¯´ï¼Œæ˜¯æ²¡ä»€ä¹ˆå…³ç³»","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1619315293,"ip_address":"","comment_id":289802,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5914147681","product_id":100073401,"comment_content":"æœ‰ä¸ªç–‘é—®<br>æœ‰reuseexchangeç®—å­çš„æ‰§è¡Œè®¡åˆ’ä¸­ï¼Œæ—¢ç„¶reuseexchangeé˜¶æ®µæ˜¯shuffleï¼Œshuffleåé¢ç›´æ¥å°±åº”è¯¥æ˜¯reduceèšåˆäº†ï¼Œä¸ºå•¥åœ¨è¿™ä¸¤è€…ä¹‹é—´è¿˜å­˜åœ¨mapç«¯èšåˆï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":519022,"discussion_content":"ReuseExchangeæŒ‡çš„æ˜¯ï¼Œåé¢ç›¸ä¼¼çš„è®¡ç®—é€»è¾‘å¤ç”¨Shuffleè®¡ç®—çš„ä¸­é—´æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯Shuffle mapé˜¶æ®µè¾“å‡ºåˆ°æœ¬åœ°ç£ç›˜çš„ä¸­é—´æ–‡ä»¶ï¼Œè¿™å’ŒShuffleçš„Mapç«¯èšåˆå¹¶ä¸å†²çªï¼Œå®é™…ä¸Šï¼Œç›´ç™½åœ°è¯´ï¼Œæ˜¯æ²¡ä»€ä¹ˆå…³ç³»","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619315293,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":360344,"user_name":"ç»„ç»‡çµé­‚ ç‹å­å¥","can_delete":false,"product_type":"c1","uid":2957218,"ip_address":"æ³•å›½","ucode":"94DB462CEAFAD3","user_header":"https://static001.geekbang.org/account/avatar/00/2d/1f/a2/0ac2dc38.jpg","comment_is_top":false,"comment_ctime":1666461055,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1666461055","product_id":100073401,"comment_content":"ä¸å¤ªç†è§£ä¸ºä»€ä¹ˆReuseExchangeæ²¡åŠæ³•åšåˆ°åœ¨å·²ç»æ»¡è¶³åˆ†åŒºçš„DataFrameä¸Šæ‰§è¡Œä¸åŒçš„æ“ä½œï¼ŒçœŸçš„è¿˜ä¸å¦‚ç›´æ¥ä½¿ç”¨persist MEMORY_AND_DISKã€‚ä¸è¿‡é€»è¾‘å…¶å®æ˜¯ä¸€æ ·çš„ã€‚","like_count":0},{"had_liked":false,"id":360343,"user_name":"ç»„ç»‡çµé­‚ ç‹å­å¥","can_delete":false,"product_type":"c1","uid":2957218,"ip_address":"æ³•å›½","ucode":"94DB462CEAFAD3","user_header":"https://static001.geekbang.org/account/avatar/00/2d/1f/a2/0ac2dc38.jpg","comment_is_top":false,"comment_ctime":1666459872,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1666459872","product_id":100073401,"comment_content":"â€œä¸€æ—¦ä¸€ä¸ªtransformationå¤±è´¥å°±ä¼šè§¦å‘æ•´æ¡ DAG ä»å¤´è‡³å°¾é‡æ–°è®¡ç®—ï¼Œè¿™ä¸ªè¯´æ³•ä¸å‡†ç¡®ï¼Œå› ä¸ºï¼Œå¤±è´¥é‡å¤çš„è®¡ç®—æºå¤´å¹¶ä¸æ˜¯æ•´æ¡ DAG çš„â€œå¤´â€ï¼Œè€Œæ˜¯ä¸è§¦å‘ç‚¹è·ç¦»æœ€æ–°çš„ Shuffle çš„ä¸­é—´æ–‡ä»¶â€œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¤±è´¥é‡è¯•æ˜¯ä»å¤±è´¥æ‰€åœ¨çš„stageçš„æºå¤´é‡æ–°å¼€å§‹çš„ï¼Œå› ä¸ºæ¯ä¸ªwide transformation (shuffle)å’Œæœ€åçš„actionæ˜¯ä¸€ä¸ªJobè¢«åˆ†ä¸ºå¤§äºç­‰äºä¸€ä¸ªstagesçš„æ ‡å‡†","like_count":0},{"had_liked":false,"id":350936,"user_name":"åº·","can_delete":false,"product_type":"c1","uid":2621850,"ip_address":"","ucode":"C3E85292E026D5","user_header":"https://static001.geekbang.org/account/avatar/00/28/01/9a/d2831441.jpg","comment_is_top":false,"comment_ctime":1657363588,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1657363588","product_id":100073401,"comment_content":"è€å¸ˆï¼Œæˆ‘æƒ³é—»ä¸€ä¸‹ï¼ŒReuseExchange æœºåˆ¶ä¼šåˆ©ç”¨åœ¨hive on sparkåœºæ™¯å˜›ï¼Ÿæ„Ÿè°¢å›å¤","like_count":0},{"had_liked":false,"id":342786,"user_name":"ç½—ç›–ç¾½","can_delete":false,"product_type":"c1","uid":2802508,"ip_address":"","ucode":"E68FE072DDF87F","user_header":"https://static001.geekbang.org/account/avatar/00/2a/c3/4c/82b7df02.jpg","comment_is_top":false,"comment_ctime":1650462716,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1650462716","product_id":100073401,"comment_content":"è€å¸ˆï¼Œå…³äºReuseExchangeçš„ä¸¤ä¸ªä¾‹å­ï¼Œæœ€åä¸€ä¸ªä¼šreuseExchangeï¼Œç¬¬ä¸€ä¸ªä¾‹å­ä¸ºä»€ä¹ˆéœ€è¦æ‰«æä¸¤æ¬¡æ•°æ®æºï¼Ÿval df: DataFrame = spark.read.parquet(filePath)ä¸æ˜¯å·²ç»æ‰«æè¿‡äº†ä¸€æ¬¡ï¼Œåé¢çš„ä¸¤æ¬¡èšåˆä¸éƒ½æ˜¯åŸºäºdfçš„æ“ä½œå—ï¼Ÿ<br>éš¾é“æ˜¯ spark.read.parquet(filePath)è¿™ä¸ªæ“ä½œæ²¡æœ‰actionç±»çš„ç®—å­è§¦å‘ï¼Ÿ","like_count":0},{"had_liked":false,"id":332149,"user_name":"Sampson","can_delete":false,"product_type":"c1","uid":1418226,"ip_address":"","ucode":"BA78CA29A6D898","user_header":"https://static001.geekbang.org/account/avatar/00/15/a3/f2/ab8c5183.jpg","comment_is_top":false,"comment_ctime":1643070039,"is_pvip":true,"replies":[{"id":"121409","content":"å¯ä»¥çš„ï¼Œæ²¡é—®é¢˜ï¼Œå¯ä»¥æŠŠdfç¼“å­˜åˆ°ç£ç›˜ï¼Œè¿™æ ·æ•ˆæœå…¶å®å’ŒReuseExchangeæ˜¯ä¸€æ ·çš„ï¼Œè€Œä¸”æ¯”ReuseExchangeå¤ç”¨ç‡æ›´é«˜ï¼Œå› ä¸ºReuseExchangeæœºåˆ¶çš„æ¡ä»¶ä¼šæ¯”è¾ƒè‹›åˆ»ï¼Œå°±åƒæ–‡ä¸­è¯´çš„é‚£æ ·~","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1043100","ctime":1643191622,"ip_address":"","comment_id":332149,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1643070039","product_id":100073401,"comment_content":"ä½ å¥½ï¼Œç£Šå“¥ï¼Œå…³äºReuseExchangeæœºåˆ¶ï¼Œæˆ‘æƒ³é—®çš„æ˜¯ï¼Œåœ¨è¿™ä¸ªæ¡ˆä¾‹ä¸­ï¼Œæ˜¯å¦å¯ä»¥å°†è¯»å–æ–‡ä»¶ä¹‹åçš„dataframe cache ä¸‹æ¥ï¼Œåç»­ç›´æ¥é’ˆå¯¹è¿™ä¸ªcacheçš„dataframeæ“ä½œå‘¢ï¼Ÿè¿˜æ˜¯è¯´2è€…æœ‰ä»€ä¹ˆå·®åˆ«ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":548439,"discussion_content":"å¯ä»¥çš„ï¼Œæ²¡é—®é¢˜ï¼Œå¯ä»¥æŠŠdfç¼“å­˜åˆ°ç£ç›˜ï¼Œè¿™æ ·æ•ˆæœå…¶å®å’ŒReuseExchangeæ˜¯ä¸€æ ·çš„ï¼Œè€Œä¸”æ¯”ReuseExchangeå¤ç”¨ç‡æ›´é«˜ï¼Œå› ä¸ºReuseExchangeæœºåˆ¶çš„æ¡ä»¶ä¼šæ¯”è¾ƒè‹›åˆ»ï¼Œå°±åƒæ–‡ä¸­è¯´çš„é‚£æ ·~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1643191622,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":289688,"user_name":"æ–¯ç›–ä¸¸","can_delete":false,"product_type":"c1","uid":1168504,"ip_address":"","ucode":"B881D14B028F14","user_header":"https://static001.geekbang.org/account/avatar/00/11/d4/78/66b3f2a2.jpg","comment_is_top":false,"comment_ctime":1619144840,"is_pvip":false,"replies":[{"id":"105145","content":"ç¡®å®æ¯”è¾ƒè‹›åˆ»~","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1619314267,"ip_address":"","comment_id":289688,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1619144840","product_id":100073401,"comment_content":"ReuseExchangeçš„ç¬¬äºŒä¸ªæ¡ä»¶ä¹Ÿå¤ªè‹›åˆ»äº†å§ï¼Œéš¾é“å¤šé€‰çº§åˆ—å°±ä¸è¡Œäº†ï¼Œå®ç”¨æ€§ä¸€ä¸‹å­ä¸‹æ¥äº†â€¦","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":518992,"discussion_content":"ç¡®å®æ¯”è¾ƒè‹›åˆ»~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619314267,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}