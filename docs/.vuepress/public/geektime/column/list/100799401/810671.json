{"id":810671,"title":"19ï½œä¼˜åŒ–å™¨æˆæœ¬æ¨¡å‹ï¼šä¼˜åŒ–å™¨ä¸ºä»€ä¹ˆé€‰æ‹©è¿™ä¸ªæ‰§è¡Œè®¡åˆ’ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯ä¿Šè¾¾ã€‚</p><p>ä¸Šä¸€è®²ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡å››åå¤šä¸ªSQLï¼Œæ¼”ç¤ºäº†MySQLå„ç§ä¸åŒçš„æ‰§è¡Œè®¡åˆ’ã€‚å¯¹äºç»™å®šçš„ä¸€ä¸ªSQLè¯­å¥ï¼ŒMySQLä¸ºä»€ä¹ˆé€‰æ‹©äº†æŸä¸€ä¸ªæ‰§è¡Œè®¡åˆ’ï¼Œè€Œæ²¡æœ‰é‡‡ç”¨å…¶ä»–çš„æ‰§è¡Œè®¡åˆ’å‘¢ï¼Ÿä¼˜åŒ–å™¨ä¼šè¯„ä¼°æ¯ä¸€ä¸ªå¯èƒ½çš„æ‰§è¡Œè®¡åˆ’çš„æˆæœ¬ï¼Œä»ä¸­é€‰æ‹©ä¸€ä¸ªæˆæœ¬æœ€ä½çš„ä½œä¸ºæœ€ç»ˆçš„æ‰§è¡Œè®¡åˆ’ã€‚è¿™ä¸€è®²ä¸­æˆ‘ä»¬å°±æ¥èŠä¸€èŠæ‰§è¡Œè®¡åˆ’çš„æˆæœ¬æ˜¯æ€ä¹ˆè®¡ç®—çš„ã€‚</p><h2>SQLé¢„å¤„ç†</h2><p>ä¸€ä¸ªSQLï¼Œåœ¨è¿›è¡Œå…·ä½“çš„æˆæœ¬è®¡ç®—ä¹‹å‰ï¼Œä¼šå…ˆè¿›è¡Œä¸€ç³»åˆ—çš„é¢„å¤„ç†ã€‚é¦–å…ˆéœ€è¦å¯¹SQLæ–‡æœ¬è¿›è¡Œè¯æ³•åˆ†æå’Œè¯­æ³•è§£æï¼Œç”Ÿæˆè¯­æ³•æ ‘ã€‚ç„¶ååŸºäºå…³ç³»ä»£æ•°çš„ä¸€äº›åŸºæœ¬è§„åˆ™ï¼Œå¯¹SQLè¯­å¥è¿›è¡Œè½¬æ¢å’Œæ”¹å†™ã€‚</p><p>å¸¸è§çš„æ”¹å†™æœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼ã€‚</p><ul>\n<li>ç­‰å€¼æ¡ä»¶ä¼ æ’­</li>\n</ul><p>å¦‚æœA=Bï¼Œå¹¶ä¸”B=Cï¼Œåˆ™A=Cã€‚</p><p>ä¸‹é¢è¿™ä¸ªSQLä¸­ï¼ŒåŸå§‹æ¡ä»¶æ˜¯t1.a = t2.a and t2.a = t3.aï¼Œè½¬æ¢åï¼Œå¾—åˆ°t1.a = t2.a and t1.a = t3.aï¼Œè§‚å¯Ÿæ‰§è¡Œè®¡åˆ’ä¸­çš„refåˆ—å°±å¯ä»¥çœ‹åˆ°è¿™ä¸€ç‚¹ã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain select * from tab t1, tab t2, tab t3 \n  where t1.a = t2.a \n  and t2.a = t3.a;\n\n+----+-------------+-------+------+---------------+---------+---------+----------+------+----------+-------+\n| id | select_type | table | type | possible_keys | key     | key_len | ref      | rows | filtered | Extra |\n+----+-------------+-------+------+---------------+---------+---------+----------+------+----------+-------+\n|  1 | SIMPLE      | t1    | ALL  | idx_abc       | NULL    | NULL    | NULL     | 9913 |   100.00 | NULL  |\n|  1 | SIMPLE      | t2    | ref  | idx_abc       | idx_abc | 4       | rep.t1.a | 3304 |   100.00 | NULL  |\n|  1 | SIMPLE      | t3    | ref  | idx_abc       | idx_abc | 4       | rep.t1.a | 3304 |   100.00 | NULL  |\n+----+-------------+-------+------+---------------+---------+---------+----------+------+----------+-------+\n</code></pre><!-- [[[read_end]]] --><ul>\n<li>å¸¸é‡ä¼ æ’­</li>\n</ul><p>å¦‚æœA=Bï¼Œå¹¶ä¸” B=1ï¼Œé‚£ä¹ˆå¯ä»¥å¾—åˆ°A=1ã€‚ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œ é€šè¿‡show warningså¯ä»¥çœ‹åˆ°ï¼ŒWHEREæ¡ä»¶è¢«å†™æˆäº†t1.a = 1 and t2.b = 1ã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain select * from tab t1, tab t2    where t1.a = t2.b and t2.b = 1;\n+----+-------------+-------+------+---------------+------+---------+------+------+----------+--------------------------------------------+\n| id | select_type | table | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra                                      |\n+----+-------------+-------+------+---------------+------+---------+------+------+----------+--------------------------------------------+\n|  1 | SIMPLE      | t2    | ALL  | NULL          | NULL | NULL    | NULL | 9913 |    10.00 | Using where                                |\n|  1 | SIMPLE      | t1    | ALL  | idx_abc       | NULL | NULL    | NULL | 9913 |    33.62 | Using where; Using join buffer (hash join) |\n+----+-------------+-------+------+---------------+------+---------+------+------+----------+--------------------------------------------+\n\nmysql&gt; show warnings\\G\n*************************** 1. row ***************************\n  Level: Note\n   Code: 1003\nMessage: /* select#1 */ select `rep`.`t1`.`id` AS `id`,`rep`.`t1`.`a` AS `a`,\n     `rep`.`t1`.`b` AS `b`,`rep`.`t1`.`c` AS `c`,`rep`.`t1`.`padding` AS `padding`,\n     `rep`.`t2`.`id` AS `id`,`rep`.`t2`.`a` AS `a`,`rep`.`t2`.`b` AS `b`,\n     `rep`.`t2`.`c` AS `c`,`rep`.`t2`.`padding` AS `padding` \n  from `rep`.`tab` `t1` join `rep`.`tab` `t2` \n   where ((`rep`.`t2`.`b` = 1) \n   and (`rep`.`t1`.`a` = 1))\n</code></pre><ul>\n<li>ç§»é™¤é‡å¤æˆ–å¤šä½™çš„æ¡ä»¶</li>\n</ul><pre><code class=\"language-plain\">mysql&gt; explain select * from tab where a = 5 and a between 1 and 10;\n+----+-------------+-------+------+---------------+---------+---------+-------+------+----------+-------+\n| id | select_type | table | type | possible_keys | key     | key_len | ref   | rows | filtered | Extra |\n+----+-------------+-------+------+---------------+---------+---------+-------+------+----------+-------+\n|  1 | SIMPLE      | tab   | ref  | idx_abc       | idx_abc | 4       | const |    1 |   100.00 | NULL  |\n+----+-------------+-------+------+---------------+---------+---------+-------+------+----------+-------+\n</code></pre><ul>\n<li>ç§»é™¤æ°¸è¿œä¸ºçœŸçš„æ¡ä»¶</li>\n</ul><p>æ¡ä»¶1=1æ°¸è¿œæˆç«‹ï¼Œä¼˜åŒ–å™¨ä¼šç›´æ¥ç§»é™¤ç±»ä¼¼è¿™æ ·çš„æ¡ä»¶ã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain select * from tab where 1=1;\n+----+-------------+-------+------+---------------+------+---------+------+------+----------+-------+\n| id | select_type | table | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra |\n+----+-------------+-------+------+---------------+------+---------+------+------+----------+-------+\n|  1 | SIMPLE      | tab   | ALL  | NULL          | NULL | NULL    | NULL | 9913 |   100.00 | NULL  |\n+----+-------------+-------+------+---------------+------+---------+------+------+----------+-------+\n</code></pre><ul>\n<li>å¯¹äºæ°¸è¿œæ— æ³•æ»¡è¶³çš„æ¡ä»¶ï¼Œç›´æ¥è¿”å›æ— æ•°æ®</li>\n</ul><p>ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œt1.a &lt; 0 and t1.a &gt; 0é€»è¾‘ä¸Šå°±ä¸æˆç«‹ï¼Œå› æ­¤æŸ¥è¯¢å¯ä»¥ç›´æ¥è¿”å›æ— æ•°æ®ã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain select * from tab t1, tab t2 \n  where t1.a = t2.a and t1.a &lt; 0 and t1.a &gt; 0;\n+----+-------------+-------+------+---------------+------+---------+------+------+----------+--------------------------------+\n| id | select_type | table | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra                          |\n+----+-------------+-------+------+---------------+------+---------+------+------+----------+--------------------------------+\n|  1 | SIMPLE      | NULL  | NULL | NULL          | NULL | NULL    | NULL | NULL |     NULL | no matching row in const table |\n+----+-------------+-------+------+---------------+------+---------+------+------+----------+--------------------------------+\n</code></pre><ul>\n<li>å¤–è¿æ¥æ”¹å†™ä¸ºå†…è¿æ¥</li>\n</ul><p>ä¸‹é¢è¿™ä¸ªSQLä¸­ï¼Œç”±äºt2.a &gt; 0è¿™ä¸ªæ¡ä»¶ï¼Œleft joinè¢«è½¬æ¢æˆäº†æ™®é€šçš„joinã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain select * from tab t1 left join t2 on t1.a = t2.a where t2.a &gt; 0;\n+----+-------------+-------+------+---------------+---------+---------+----------+------+----------+-------------+\n| id | select_type | table | type | possible_keys | key     | key_len | ref      | rows | filtered | Extra       |\n+----+-------------+-------+------+---------------+---------+---------+----------+------+----------+-------------+\n|  1 | SIMPLE      | t1    | ALL  | idx_abc       | NULL    | NULL    | NULL     | 9913 |    67.25 | Using where |\n|  1 | SIMPLE      | t2    | ref  | idx_abc       | idx_abc | 4       | rep.t1.a | 3304 |   100.00 | NULL        |\n+----+-------------+-------+------+---------------+---------+---------+----------+------+----------+-------------+\n    \nmysql&gt; show warnings\\G\n*************************** 1. row ***************************\n  Level: Note\n   Code: 1003\nMessage: /* select#1 */ select `rep`.`t1`.`id` AS `id`,`rep`.`t1`.`a` AS `a`,\n    `rep`.`t1`.`b` AS `b`,`rep`.`t1`.`c` AS `c`,`rep`.`t1`.`padding` AS `padding`,\n    `rep`.`t2`.`id` AS `id`,`rep`.`t2`.`a` AS `a`,`rep`.`t2`.`b` AS `b`,\n    `rep`.`t2`.`c` AS `c`,`rep`.`t2`.`padding` AS `padding` \nfrom `rep`.`tab` `t1` join `rep`.`tab` `t2`\nwhere ((`rep`.`t2`.`a` = `rep`.`t1`.`a`) \nand (`rep`.`t1`.`a` &gt; 0))\n</code></pre><ul>\n<li>å­æŸ¥è¯¢è½¬æ¢ä¸ºSEMIJOIN</li>\n</ul><p>ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œå­æŸ¥è¯¢è¢«è½¬æ¢æˆäº†æ™®é€šçš„è¡¨è¿æ¥ã€‚æ³¨æ„åˆ°IDä¸º1çš„ä¸¤ä¸ªæŸ¥è¯¢å•å…ƒï¼Œselect_typeéƒ½æ˜¯SIMPLEã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain select * from tab where a in (select b from tab);\n+----+--------------+-------------+--------+---------------------+---------------------+---------+-----------+------+----------+-------------+\n| id | select_type  | table       | type   | possible_keys       | key                 | key_len | ref       | rows | filtered | Extra       |\n+----+--------------+-------------+--------+---------------------+---------------------+---------+-----------+------+----------+-------------+\n|  1 | SIMPLE       | tab         | ALL    | idx_abc             | NULL                | NULL    | NULL      | 9913 |   100.00 | NULL        |\n|  1 | SIMPLE       | &lt;subquery2&gt; | eq_ref | &lt;auto_distinct_key&gt; | &lt;auto_distinct_key&gt; | 4       | rep.tab.a |    1 |   100.00 | NULL        |\n|  2 | MATERIALIZED | tab         | index  | NULL                | idx_abc             | 12      | NULL      | 9913 |   100.00 | Using index |\n+----+--------------+-------------+--------+---------------------+---------------------+---------+-----------+------+----------+-------------+\n</code></pre><p>å½“ç„¶ï¼Œæ»¡è¶³ä¸€å®šæ¡ä»¶çš„å­æŸ¥è¯¢æ‰èƒ½è½¬æ¢ä¸ºæ™®é€šçš„è¡¨è¿æ¥ï¼Œè€Œä¸”ä¸ºäº†SQLèƒ½æŸ¥è¯¢å¾—åˆ°ä¸€æ ·çš„æ•°æ®ï¼Œè½¬æ¢ä¸ºæ™®é€šè¡¨è¿æ¥åï¼Œè¿˜éœ€è¦è¿›è¡Œä¸€äº›ç‰¹æ®Šçš„å¤„ç†ã€‚åç»­æˆ‘ä»¬ä¼šæœ‰ä¸€è®²ä¸“é—¨ä»‹ç»å­æŸ¥è¯¢çš„è½¬æ¢ã€‚</p><h2>åŸºäºæˆæœ¬çš„ä¼˜åŒ–</h2><p>MySQLä½¿ç”¨äº†åŸºäºæˆæœ¬çš„ä¼˜åŒ–å™¨ã€‚æˆ‘ä»¬é€šè¿‡ä¸€äº›å…·ä½“çš„ä¾‹å­æ¥è¯´æ˜æˆæœ¬çš„ä¸€äº›è®¡ç®—æ–¹å¼ã€‚</p><p>å…ˆåˆ›å»ºä¸€ä¸ªæµ‹è¯•è¡¨ï¼Œåˆå§‹åŒ–ä¸€äº›æ•°æ®ï¼Œè¿™é‡Œçš„numberså°±æ˜¯ä¸Šä¸€è®²å¼€å¤´åˆ›å»ºçš„é‚£ä¸ªè§†å›¾ã€‚</p><pre><code class=\"language-plain\">mysql&gt; create table t_cost (\n  id int not null auto_increment,\n  a int not null,\n  b int not null,\n  c int not null,\n  d int not null,\n  padding varchar(7000) DEFAULT NULL,\n  primary key (id),\n  key idx_ac(a,c),\n  key idx_bc(b,c)\n) engine=InnoDB;\n\nmysql&gt; insert into t_cost (a,b,c,d, padding)\nselect n%6, n%1000, n%100, n%100, rpad('', 2000, 'ABCDEFG XYZ') \nfrom \nnumbers;\n\nmysql&gt; analyze table t_cost;\n</code></pre><p>æˆ‘ä»¬å…ˆæ¥çœ‹è¿™ä¸ªSQLçš„æ‰§è¡Œè®¡åˆ’ã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain \nselect * \nfrom t_cost \nwhere a=3 \nand b between 90 and 100 \nand c in (1,2,3,4,5,6,7,8,9,10)\\G\n\n*************************** 1. row ***************************\n           id: 1\n  select_type: SIMPLE\n        table: t_cost\n   partitions: NULL\n         type: range\npossible_keys: idx_ac,idx_bc\n          key: idx_bc\n      key_len: 8\n          ref: NULL\n         rows: 110\n     filtered: 2.00\n        Extra: Using index condition; Using where\n</code></pre><p>å¯¹äºä¸Šé¢è¿™ä¸ªSQLï¼Œä¼˜åŒ–å™¨æœ€ç»ˆä»å…¨è¡¨æ‰«æã€ä½¿ç”¨ç´¢å¼•idx_acã€ä½¿ç”¨ç´¢å¼•idx_bcè¿™å‡ ç§å¯èƒ½çš„è·¯å¾„ä¸­é€‰æ‹©äº†idx_bcã€‚ä¼˜åŒ–å™¨è®¤ä¸ºé€šè¿‡ç´¢å¼•idx_bcéœ€è¦è®¿é—®110è¡Œæ•°æ®ã€‚</p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¼˜åŒ–å™¨è·Ÿè¸ªæ¥æŸ¥çœ‹ä¼˜åŒ–å™¨çš„æ€è€ƒè¿‡ç¨‹ã€‚å…ˆè®¾ç½®ä¼šè¯å˜é‡optimizer_traceï¼Œå†æ‰§è¡ŒSQLæˆ–Explainå‘½ä»¤ï¼Œç„¶åå°±å¯ä»¥ä»information_schema.optimizer_traceæŸ¥çœ‹ä¼˜åŒ–å™¨çš„è·Ÿè¸ªä¿¡æ¯äº†ã€‚</p><pre><code class=\"language-plain\">mysql&gt; set optimizer_trace='enabled=on';\nQuery OK, 0 rows affected (0.00 sec)\n\n\nmysql&gt; select *  from t_cost  \n  where a=3  \n  and b between 90 and 100  \n  and c in (1,2,3,4,5,6,7,8,9,10) ;\nEmpty set (0.01 sec)\n\nmysql&gt; select * from information_schema.optimizer_trace\\G\n*************************** 1. row ***************************\nQUERY: select *  from t_cost  where a=3  and b between 90 and 100  \n    and c in (1,2,3,4,5,6,7,8,9,10)\nTRACE: {\n  \"steps\": [\n    {\n      \"join_preparation\": {\n        \"select#\": 1,\n        \"steps\": [\n          {\n            \"IN_uses_bisection\": true\n          },\n          {\n......\n</code></pre><p>optimizer_traceçš„è¾“å‡ºå†…å®¹æ¯”è¾ƒé•¿ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å…¶ä¸­æ¯”è¾ƒå…³é”®çš„å‡ ä¸ªéƒ¨åˆ†ã€‚</p><ul>\n<li>table_scan</li>\n</ul><p>table_scanéƒ¨åˆ†è®°å½•äº†å…¨è¡¨æ‰«æçš„æˆæœ¬ï¼Œè¿™é‡Œæ˜¯æ‰«æ8580è¡Œè®°å½•ï¼Œæˆæœ¬æ˜¯1220.85ã€‚</p><pre><code class=\"language-plain\">{\n  \"rows_estimation\": [\n    {\n      \"table\": \"`t_cost`\",\n      \"range_analysis\": {\n        \"table_scan\": {\n          \"rows\": 8580,\n          \"cost\": 1220.85\n        }\n</code></pre><ul>\n<li>range_scan_alternatives</li>\n</ul><p>range_scan_alternativesä¸­è®°å½•äº†ç´¢å¼•æ‰«æçš„æˆæœ¬ï¼Œä¼˜åŒ–å™¨åˆ†åˆ«è®¡ç®—äº†ä½¿ç”¨idx_acå’Œidx_bcè¿™ä¸¤ä¸ªç´¢å¼•çš„è®¿é—®æˆæœ¬ã€‚ä½¿ç”¨idx_acæ—¶ï¼Œéœ€è¦æ‰«æ172è¡Œæ•°æ®ï¼Œæˆæœ¬æ˜¯62.71ã€‚ä½¿ç”¨idx_bcæ—¶ï¼Œéœ€è¦æ‰«æ110è¡Œæ•°æ®ï¼Œæˆæœ¬æ˜¯38.76ã€‚</p><pre><code class=\"language-plain\">\"analyzing_range_alternatives\": {\n \"range_scan_alternatives\": [\n   {\n     \"index\": \"idx_ac\",\n     \"ranges\": [\n       \"a = 3 AND c = 1\",\n       \"a = 3 AND c = 2\",\n       \"a = 3 AND c = 3\",\n       \"a = 3 AND c = 4\",\n       \"a = 3 AND c = 5\",\n       \"a = 3 AND c = 6\",\n       \"a = 3 AND c = 7\",\n       \"a = 3 AND c = 8\",\n       \"a = 3 AND c = 9\",\n       \"a = 3 AND c = 10\"\n     ],\n     \"index_dives_for_eq_ranges\": true,\n     \"rowid_ordered\": false,\n     \"using_mrr\": false,\n     \"index_only\": false,\n     \"in_memory\": 1,\n     \"rows\": 172,\n     \"cost\": 62.71,\n     \"chosen\": true\n   },\n   {\n     \"index\": \"idx_bc\",\n     \"ranges\": [\n       \"90 &lt;= b &lt;= 100\"\n     ],\n     \"index_dives_for_eq_ranges\": true,\n     \"rowid_ordered\": false,\n     \"using_mrr\": false,\n     \"index_only\": false,\n     \"in_memory\": 1,\n     \"rows\": 110,\n     \"cost\": 38.76,\n     \"chosen\": true\n   }\n ]\n</code></pre><ul>\n<li>best_access_path</li>\n</ul><p>best_access_pathè®°å½•äº†ä¼˜åŒ–å™¨æœ€ç»ˆé€‰æ‹©çš„æ‰§è¡Œè®¡åˆ’ï¼Œç”±äºä½¿ç”¨idx_bcæˆæœ¬æœ€ä½ï¼Œä¼˜åŒ–å™¨æœ€ç»ˆé€‰æ‹©äº†è¿™ä¸ªæ‰§è¡Œè®¡åˆ’ã€‚</p><pre><code class=\"language-plain\">\"best_access_path\": {\n  \"considered_access_paths\": [\n    {\n      \"access_type\": \"ref\",\n      \"index\": \"idx_ac\",\n      \"chosen\": false,\n      \"cause\": \"range_uses_more_keyparts\"\n    },\n    {\n      \"rows_to_scan\": 110,\n      \"access_type\": \"range\",\n      \"range_details\": {\n        \"used_index\": \"idx_bc\"\n      },\n      \"resulting_rows\": 110,\n      \"cost\": 49.76,\n      \"chosen\": true\n    }\n  ]\n}\n</code></pre><p>ä¼˜åŒ–å™¨æ˜¯æ€ä¹ˆæ¥è¯„ä¼°è¿™å‡ ç§ä¸åŒçš„æ‰§è¡Œè·¯å¾„çš„æˆæœ¬çš„å‘¢ï¼Ÿæ‰§è¡Œè·¯å¾„çš„æˆæœ¬ä¸»è¦ç”±IOæˆæœ¬å’ŒCPUæˆæœ¬ç»„æˆã€‚</p><ul>\n<li>IOæˆæœ¬</li>\n</ul><p>IOæˆæœ¬æ˜¯ä»å†…å­˜æˆ–ç£ç›˜ä¸­è¯»å†™æ•°æ®å—çš„æˆæœ¬ã€‚å¦‚æœæŸ¥è¯¢æ¶‰åŠåˆ°ç‰©åŒ–æ“ä½œï¼ŒIOæˆæœ¬è¿˜åŒ…æ‹¬åˆ›å»ºä¸´æ—¶è¡¨ã€è¯»å†™ä¸´æ—¶è¡¨çš„æˆæœ¬ã€‚IOæˆæœ¬å’Œéœ€è¦è®¿é—®çš„æ•°æ®å—çš„æ•°é‡ç›¸å…³ã€‚</p><ul>\n<li>CPUæˆæœ¬</li>\n</ul><p>CPUæˆæœ¬åŒ…æ‹¬è¡Œè¯„ä¼°æˆæœ¬ï¼ˆè¡Œè¯„ä¼°æˆæœ¬å¯ä»¥ç†è§£ä¸ºåˆ¤æ–­ä¸€è¡Œè®°å½•æ˜¯å¦æ»¡è¶³SQLè¡¨è¾¾å¼ä¸­çš„æ¡ä»¶ï¼‰ï¼ŒKEYæ¯”è¾ƒçš„æˆæœ¬ï¼ˆæ¯”å¦‚åœ¨è¿›è¡Œæ’åºæ“ä½œæ—¶ï¼Œéœ€è¦æ¯”è¾ƒè®°å½•æ’åºå­—æ®µçš„å¤§å°ï¼‰ã€‚</p><p>å…·ä½“æ€ä¹ˆè®¡ç®—IOæˆæœ¬å’ŒCPUæˆæœ¬å‘¢ï¼Ÿ</p><h3>ä¼˜åŒ–å™¨æˆæœ¬æ¨¡å‹</h3><p>é¦–å…ˆä¼˜åŒ–å™¨æœ‰ä¸€ä¸ªæˆæœ¬æ¨¡å‹ï¼Œè®¾ç½®äº†ä¸€äº›åŸºæœ¬æ“ä½œçš„æˆæœ¬ï¼Œæ¯”å¦‚è¯»å–1ä¸ªæ•°æ®å—çš„æˆæœ¬æ˜¯å¤šå°‘ã€è¯„ä¼°1è¡Œè®°å½•çš„æˆæœ¬æ˜¯å¤šå°‘ã€‚æˆ‘æŠŠä¼˜åŒ–å™¨ä¸­çš„æˆæœ¬æ¨¡å‹å¸¸é‡æ•´ç†æˆäº†ä¸‹é¢è¿™ä¸¤ä¸ªè¡¨æ ¼ï¼Œä½ å¯ä»¥å‚è€ƒä¸€ä¸‹ã€‚</p><ul>\n<li>Serverå±‚å¸¸é‡</li>\n</ul><p><img src=\"https://static001.geekbang.org/resource/image/36/34/3602c82ba75fef40a3f642f0fb90e634.png?wh=1920x905\" alt=\"å›¾ç‰‡\"></p><ul>\n<li>å­˜å‚¨å¼•æ“å±‚å¸¸é‡</li>\n</ul><p><img src=\"https://static001.geekbang.org/resource/image/ab/d1/ab4fed7807460246539455f7432078d1.png?wh=1920x472\" alt=\"å›¾ç‰‡\"></p><p>ä¸Šé¢è¿™ä¸¤ä¸ªè¡¨æ ¼ä¸­å¸¸é‡çš„å–å€¼ä»MySQL 8.0.32çš„ä»£ç ä¸­è·å–ã€‚ä¸åŒçš„ç‰ˆæœ¬å¯èƒ½ä¼šè®¾ç½®ä¸åŒçš„é»˜è®¤å€¼ï¼Œå¦‚æœä½ å»çœ‹5.7ç‰ˆæœ¬çš„æºç ï¼Œä¼šå‘ç°æœ‰äº›å¸¸é‡çš„å€¼ä¸ä¸€æ ·ã€‚ä¸€èˆ¬æˆ‘ä»¬å¹¶ä¸éœ€è¦ä¿®æ”¹è¿™äº›å¸¸é‡ï¼Œä¹Ÿä¸éœ€è¦çŸ¥é“è¿™äº›å¸¸é‡çš„å…·ä½“å–å€¼ï¼Œåªæœ‰å½“æˆ‘ä»¬æƒ³çŸ¥é“æŸä¸ªæˆæœ¬å€¼å…·ä½“æ˜¯å¦‚ä½•è®¡ç®—å¾—åˆ°çš„æ—¶å€™ï¼Œæ‰ä¼šç”¨åˆ°è¿™äº›å¸¸é‡ã€‚</p><p>ä½ è¿˜å¯ä»¥é€šè¿‡ä¿®æ”¹mysqlåº“ä¸­çš„server_costå’Œengine_costè¿™2ä¸ªè¡¨æ¥æ”¹å˜æŸä¸ªæˆæœ¬å¸¸é‡çš„å€¼ï¼Œå½“ç„¶ä¸€èˆ¬ä¸ä¼šå»ä¿®æ”¹è¿™äº›å€¼ã€‚</p><pre><code class=\"language-plain\">mysql&gt; select cost_name, cost_value, default_value from mysql.server_cost;\n+------------------------------+------------+---------------+\n| cost_name                    | cost_value | default_value |\n+------------------------------+------------+---------------+\n| disk_temptable_create_cost   |       NULL |            20 |\n| disk_temptable_row_cost      |       NULL |           0.5 |\n| key_compare_cost             |       NULL |          0.05 |\n| memory_temptable_create_cost |       NULL |             1 |\n| memory_temptable_row_cost    |       NULL |           0.1 |\n| row_evaluate_cost            |       NULL |           0.1 |\n+------------------------------+------------+---------------+\n6 rows in set (0.00 sec)\n\nmysql&gt; select engine_name, device_type, cost_name, cost_value, default_value \n    from mysql.engine_cost;\n+-------------+-------------+------------------------+------------+---------------+\n| engine_name | device_type | cost_name              | cost_value | default_value |\n+-------------+-------------+------------------------+------------+---------------+\n| default     |           0 | io_block_read_cost     |       NULL |             1 |\n| default     |           0 | memory_block_read_cost |       NULL |          0.25 |\n+-------------+-------------+------------------------+------------+---------------+\n</code></pre><p>å¦‚æœä½ æ›´æ–°äº†è¿™ä¸¤ä¸ªè¡¨ï¼Œè¦æ‰§è¡ŒFLUSH OPTIMIZER_COSTSå‘½ä»¤åæ‰ä¼šçœŸæ­£ç”Ÿæ•ˆã€‚</p><h3>æˆæœ¬è®¡ç®—</h3><p>MySQLæ€ä¹ˆè¯„ä¼°æŸä¸ªæ‰§è¡Œè®¿é—®è·¯å¾„éœ€è¦è¯»å–å¤šå°‘ä¸ªæ•°æ®å—ã€æ‰«æå¤šå°‘è¡Œæ•°æ®å‘¢ï¼Ÿè¿™é‡Œåˆ†ä¸ºå‡ ç§æƒ…å†µã€‚å¯¹äºå…¨è¡¨æ‰«æï¼ŒMySQLä¼šé€šè¿‡ç»Ÿè®¡ä¿¡æ¯æ¥ä¼°ç®—ã€‚å¯¹äºç´¢å¼•è®¿é—®ï¼ŒMySQLä¼šä½¿ç”¨Index Diveæœºåˆ¶æ¥è¯„ä¼°è¡Œæ•°ï¼Œæˆ–è€…ä½¿ç”¨ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯æ¥è¯„ä¼°ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬åˆ†åˆ«ä»‹ç»è¿™å‡ ç§æƒ…å†µã€‚</p><h4>å…¨è¡¨æ‰«ææˆæœ¬è®¡ç®—</h4><p><img src=\"https://static001.geekbang.org/resource/image/a6/8e/a66217358cd599b4ce9a8bfa814e9a8e.jpg?wh=1132x373\" alt=\"å›¾ç‰‡\"></p><p>å…¨è¡¨æ‰«æéœ€è¦è¯»å–è¡¨ä¸­çš„æ‰€æœ‰æ•°æ®é¡µã€‚å…¨è¡¨æ‰«æçš„æˆæœ¬ä¼šæ ¹æ®è¡¨çš„ç»Ÿè®¡ä¿¡æ¯æ¥è¯„ä¼°ã€‚InnoDBè¡¨çš„ç»Ÿè®¡ä¿¡æ¯å­˜å‚¨åœ¨mysql.innodb_table_statsè¡¨ä¸­ã€‚åœ¨æˆ‘ä»¬çš„æµ‹è¯•è¡¨ä¸­ï¼Œç»Ÿè®¡ä¿¡æ¯æ˜¯è¿™æ ·çš„ã€‚</p><pre><code class=\"language-plain\">mysql&gt; select * from mysql.innodb_table_stats where table_name = 't_cost'\\G\n*************************** 1. row ***************************\n           database_name: rep\n              table_name: t_cost\n             last_update: 2024-08-22 16:14:21\n                  n_rows: 8580\n    clustered_index_size: 1443\nsum_of_other_index_sizes: 46\n</code></pre><p>è¿™å‡ ä¸ªå­—æ®µçš„å«ä¹‰æˆ‘æ•´ç†åˆ°è¡¨æ ¼ä¸­äº†ï¼Œä¾›ä½ å‚è€ƒã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/a3/60/a3343bdede38a11d3c9d8a992b6f2060.png?wh=1920x868\" alt=\"å›¾ç‰‡\"></p><p>æˆ‘ä»¬æ¥å›é¡¾ä¸€ä¸‹å‰é¢å…¨è¡¨æ‰«æçš„æˆæœ¬ã€‚</p><pre><code class=\"language-plain\">\"table_scan\": {\n  \"rows\": 8580,\n  \"cost\": 1220.85\n}\n</code></pre><p>è®¿é—®è¡Œæ•°rowså°±æ˜¯ä»ç»Ÿè®¡ä¿¡æ¯ä¸­ç›´æ¥è·å–çš„ã€‚è®¿é—®æˆæœ¬çš„è®¡ç®—å…¬å¼ï¼Œæˆ‘ä½¿ç”¨ä¸‹é¢è¿™æ®µpythonä»£ç æ¥è¡¨ç¤ºã€‚</p><pre><code class=\"language-plain\">ROW_EVALUATE_COST = 0.1\nMEMORY_BLOCK_READ_COST = 0.25\nIO_BLOCK_READ_COST = 1\n\ndef io_cost(pages, in_mem_pct):\n    in_mem_pages = pages * in_mem_pct\n    disk_pages = pages - in_mem_pages\n    cost = in_mem_pages * MEMORY_BLOCK_READ_COST + disk_pages * IO_BLOCK_READ_COST\n    return cost\n\ndef row_eval_cost(rows):\n    cost = rows * ROW_EVALUATE_COST\n    return cost\n    \ndef scan_cost(pages, rows, in_mem_pct):\n    cost = io_cost(pages, in_mem_pct)\n    row_cost = row_eval_cost(rows)\n    return cost + row_cost + 1.1 + 1\n</code></pre><p>å‡½æ•°scan_costçš„å‚æ•°ä¸­ï¼Œpagesæ˜¯è¡¨ç»Ÿè®¡ä¿¡æ¯ä¸­çš„clustered_index_sizeå­—æ®µï¼Œrowsæ˜¯ç»Ÿè®¡ä¿¡æ¯ä¸­çš„n_rowså­—æ®µï¼Œin_mem_pctæ˜¯è¡¨ç¼“å­˜åœ¨å†…å­˜ä¸­çš„ä¸€ä¸ªé¢„ä¼°çš„æ¯”ä¾‹ï¼Œåœ¨æˆ‘ä»¬è¿™ä¸ªä¾‹å­ä¸­ï¼Œç¼“å­˜ç‡æ˜¯100ã€‚è®¡ç®—å…¨è¡¨æ‰«æçš„æˆæœ¬æ—¶ï¼Œä¼˜åŒ–å™¨è¿˜åŠ ä¸Šäº†ä¸€äº›å›ºå®šçš„æˆæœ¬ï¼Œå°±æ˜¯å…¬å¼ä¸­çš„ 1.1 + 1ã€‚<br>\nå°†ç»Ÿè®¡ä¿¡æ¯ä¸­çš„æ•°æ®ä»£å…¥scan_costå‡½æ•°ï¼Œå°±å¾—åˆ°äº†å…¨è¡¨æ‰«æçš„æˆæœ¬1220.85ã€‚</p><pre><code class=\"language-plain\">&gt;&gt;&gt; scan_cost(pages=1443, rows=8580, in_mem_pct=1.0)\n1220.85\n</code></pre><h4>ç´¢å¼•è®¿é—®æˆæœ¬è®¡ç®—</h4><p>æˆ‘ä»¬å…ˆæ¥å›é¡¾ä¸‹ç´¢å¼•è®¿é—®çš„å¤§è‡´æ­¥éª¤ã€‚ä¸‹é¢è¿™å¼ å›¾æè¿°äº†æ™®é€šéè¦†ç›–ç´¢å¼•çš„è®¿é—®æ­¥éª¤ã€‚</p><ol>\n<li>æ ¹æ®ç´¢å¼•æ¡ä»¶ï¼Œåœ¨ç´¢å¼•ä¸­å®šä½åˆ°ç´¢å¼•æ¡ç›®ã€‚</li>\n<li>æ ¹æ®ç´¢å¼•æ¡ç›®ä¸­çš„ä¸»é”®ä¿¡æ¯ï¼Œåˆ°èšç°‡ç´¢å¼•ä¸­æŸ¥æ‰¾æ•°æ®ã€‚</li>\n</ol><p>ä¸€ä¸ªSQLä¸­ï¼Œå¯èƒ½éœ€è¦è®¿é—®å¤šä¸ªç´¢å¼•èŒƒå›´ï¼Œæ¯”å¦‚åœ¨whereä¸­ä½¿ç”¨äº†oræˆ–è€…inæ¡ä»¶ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/c6/75/c62f9f5ab202a373eyy4d53be20aaa75.png?wh=1920x873\" alt=\"å›¾ç‰‡\"></p><p>ä»ä¸Šé¢çš„ç¤ºæ„å›¾ä¸­ï¼Œå¯ä»¥çœ‹å‡ºç´¢å¼•è®¿é—®çš„æˆæœ¬ä¸»è¦åŒ…æ‹¬ï¼š</p><ol>\n<li>éœ€è¦è®¿é—®çš„ç´¢å¼•æ¡ç›®æ•°é‡ï¼Œä»¥åŠè¿™äº›æ¡ç›®åˆ†å¸ƒåœ¨å¤šå°‘ä¸ªé¡µé¢ä¸­ã€‚</li>\n<li>ç´¢å¼•çš„åŒºé—´æ•°é‡ã€‚</li>\n<li>éœ€è¦è¯»å–çš„InnoDBèšç°‡ç´¢å¼•çš„é¡µé¢æ•°é‡ã€‚</li>\n</ol><p>æˆ‘ä»¬å›é¡¾ä¸‹æµ‹è¯•æ¡ˆä¾‹ä¸­ä¸¤ä¸ªç´¢å¼•çš„è®¿é—®æˆæœ¬ã€‚ä½¿ç”¨ç´¢å¼•idx_acéœ€è¦è®¿é—®10ä¸ªåŒºé—´ï¼Œæ€»å…±172è¡Œè®°å½•ï¼Œæˆæœ¬æ˜¯62.71ã€‚</p><pre><code class=\"language-plain\">{\n  \"index\": \"idx_ac\",\n  \"ranges\": [\n    \"a = 3 AND c = 1\",\n    \"a = 3 AND c = 2\",\n    \"a = 3 AND c = 3\",\n    \"a = 3 AND c = 4\",\n    \"a = 3 AND c = 5\",\n    \"a = 3 AND c = 6\",\n    \"a = 3 AND c = 7\",\n    \"a = 3 AND c = 8\",\n    \"a = 3 AND c = 9\",\n    \"a = 3 AND c = 10\"\n  ],\n  \"index_dives_for_eq_ranges\": true,\n  \"rowid_ordered\": false,\n  \"using_mrr\": false,\n  \"index_only\": false,\n  \"in_memory\": 1,\n  \"rows\": 172,\n  \"cost\": 62.71,\n  \"chosen\": true\n}\n</code></pre><p>ä½¿ç”¨ç´¢å¼•idx_bcéœ€è¦è®¿é—®1ä¸ªåŒºé—´ï¼Œ110è¡Œè®°å½•ï¼Œæˆæœ¬æ˜¯38.76ã€‚</p><pre><code class=\"language-plain\">   \n{\n  \"index\": \"idx_bc\",\n  \"ranges\": [\n    \"90 &lt;= b &lt;= 100\"\n  ],\n  \"index_dives_for_eq_ranges\": true,\n  \"rowid_ordered\": false,\n  \"using_mrr\": false,\n  \"index_only\": false,\n  \"in_memory\": 1,\n  \"rows\": 110,\n  \"cost\": 38.76,\n  \"chosen\": true\n}\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œç´¢å¼•è®¿é—®æ—¶ï¼Œéœ€è¦æ‰«æçš„è®°å½•æ•°å†³å®šäº†è®¿é—®çš„æˆæœ¬ã€‚é‚£ä¹ˆä¼˜åŒ–å™¨æ€ä¹ˆçŸ¥é“ï¼Œè®¿é—®ç´¢å¼•çš„æŸä¸€ä¸ªåŒºé—´æ—¶ï¼Œéœ€è¦æ‰«æå¤šå°‘è¡Œè®°å½•å‘¢ï¼ŸInnoDBä½¿ç”¨äº†index diveæœºåˆ¶æ¥è¯„ä¼°è®°å½•æ•°ã€‚ç®€å•åœ°è¯´ï¼Œindex diveå°±æ˜¯æ ¹æ®åŒºé—´çš„è¾¹ç•Œå€¼ï¼Œåˆ°ç´¢å¼•ä¸­ç»Ÿè®¡åŒºé—´å†…çš„è®°å½•æ•°ï¼Œåç»­æˆ‘ä»¬å†å¯¹index diveçš„åŸç†åšè¿›ä¸€æ­¥ä»‹ç»ï¼Œè¿™é‡Œå…ˆè®°ä½ä¸€ä¸ªç»“è®ºï¼š<strong>ä½¿ç”¨index diveæœºåˆ¶é€šå¸¸èƒ½å¾—åˆ°è®°å½•æ•°æ¯”è¾ƒå‡†ç¡®çš„ä¸€ä¸ªä¼°è®¡ã€‚</strong></p><p>å¾—åˆ°ç´¢å¼•åŒºé—´å†…çš„è®°å½•æ•°ä¹‹åï¼Œï¼ˆéè¦†ç›–ç´¢å¼•ï¼‰ç´¢å¼•è®¿é—®æˆæœ¬çš„è®¡ç®—å…¬å¼ï¼Œæˆ‘ä½¿ç”¨ä¸‹é¢è¿™æ®µpythonä»£ç æ¥è¡¨ç¤ºã€‚</p><pre><code class=\"language-plain\">MEMORY_BLOCK_READ_COST = 0.25\nIO_BLOCK_READ_COST = 1\nROW_EVALUATE_COST = 0.1\n\ndef row_evaluate_cost(rows):\n    return rows * ROW_EVALUATE_COST\n\ndef page_read_cost(in_mem_pct):\n    return MEMORY_BLOCK_READ_COST * in_mem_pct + IO_BLOCK_READ_COST * (1-in_mem_pct)\n\ndef range_normal_io_cost(ranges, rows, in_mem_pct):\n    pages = ranges + rows\n    result = pages * page_read_cost(in_mem_pct)\n    return result\n\ndef range_normal_cost(ranges, rows, in_mem_pct):\n    io_cost = range_normal_io_cost(ranges, rows, in_mem_pct)\n    result = io_cost + row_evaluate_cost(rows) + 0.01\n    return result\n</code></pre><p>ç´¢å¼•è®¿é—®æˆæœ¬ç”±IOæˆæœ¬å’Œè¡Œè¯„ä¼°æˆæœ¬ç»„æˆã€‚è€ŒIOçš„æ¬¡æ•°æ˜¯æ€ä¹ˆè¯„ä¼°çš„å‘¢ï¼Ÿ MySQLè®¤ä¸ºæ¯ä¸€è¡Œè®°å½•éœ€è¦è®¿é—®1æ¬¡IOï¼Œæ­¤å¤–ï¼Œæ¯ä¸€ä¸ªåŒºé—´éœ€è¦è®¿é—®1æ¬¡IOã€‚</p><p>æ ¹æ®ä¸Šé¢çš„å…¬å¼ï¼Œå¯ä»¥è®¡ç®—å‡ºæˆ‘ä»¬ä¾‹å­ä¸­ä¸¤ä¸ªç´¢å¼•çš„è®¿é—®æˆæœ¬ã€‚</p><p>ç´¢å¼•idx_acçš„è®¿é—®æˆæœ¬ï¼š</p><pre><code class=\"language-plain\">&gt;&gt;&gt; range_normal_cost(ranges=10, rows=172, in_mem_pct=1.0)\n62.71\n</code></pre><p>ç´¢å¼•index_bcçš„è®¿é—®æˆæœ¬ï¼š</p><pre><code class=\"language-plain\">&gt;&gt;&gt; range_normal_cost(ranges=1,  rows=110, in_mem_pct=1.0)\n38.76\n</code></pre><p>æˆ‘ä»¬è¿™é‡Œä»‹ç»äº†éè¦†ç›–ç´¢å¼•rangeæ‰§è¡Œè·¯å¾„ä¸‹çš„è®¿é—®æˆæœ¬ã€‚å®é™…ä¸Šç´¢å¼•è®¿é—®è¿˜å­˜åœ¨å…¶ä»–æƒ…å†µï¼Œæ¯”å¦‚ä¸Šä¸€è®²ä¸­è®²åˆ°ï¼Œæœ‰ä¸€ç§refçš„è®¿é—®è·¯å¾„ï¼Œæ­¤å¤–ï¼Œè¿˜å­˜åœ¨è¦†ç›–ç´¢å¼•çš„æƒ…å†µï¼Œè¿™äº›æƒ…å†µä¸‹ï¼Œç´¢å¼•è®¿é—®çš„æˆæœ¬è®¡ç®—æ–¹å¼ä¼šæœ‰ä¸€äº›å·®å¼‚ï¼Œæˆ‘ä»¬ä¸‹ä¸€è®²å†å…·ä½“åˆ†æã€‚</p><h4>ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯çš„ä½œç”¨</h4><p>ä½¿ç”¨index diveé€šå¸¸èƒ½å¾—åˆ°ç´¢å¼•åŒºé—´å†…è®°å½•æ•°æ¯”è¾ƒå‡†ç¡®çš„ä¸€ä¸ªä¼°è®¡ã€‚ä½†æ˜¯æœ‰äº›æƒ…å†µä¸‹ï¼Œå¹¶ä¸èƒ½ä½¿ç”¨index diveæœºåˆ¶ã€‚æ¯”å¦‚åœ¨è¡¨è¿æ¥çš„æ—¶å€™ï¼Œè¿æ¥æ¡ä»¶æ¥è‡ªäºé©±åŠ¨è¡¨ï¼Œè€Œä¼˜åŒ–å™¨å¹¶ä¸çŸ¥é“è¿æ¥æ¡ä»¶çš„å…·ä½“å–å€¼ï¼Œå› æ­¤æ— æ³•ä½¿ç”¨index diveã€‚å¦å¤–ä¸€ç§æƒ…å†µæ˜¯ï¼Œå¦‚æœå¾…æŸ¥è¯¢çš„åŒºé—´æ•°é‡ç‰¹åˆ«å¤šï¼Œå¯¹æ¯ä¸€ä¸ªåŒºé—´éƒ½åšä¸€æ¬¡index diveçš„å¼€é”€å¤ªå¤§äº†ã€‚å½“åŒºé—´çš„æ•°é‡è¶…è¿‡å‚æ•°eq_range_index_dive_limitçš„è®¾ç½®æ—¶ï¼Œä¼˜åŒ–å™¨å°±ä¼šæ”¾å¼ƒindex diveã€‚</p><p>æˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹è¿™ç§æƒ…å†µã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain select * from t_cost \n  where b in (1,2,3,4,5,6,7,8,9,10,11,12,13,14,15) \n  and c in (1,2,3,4,5,6,7,8,9,10,11,12,13,14,15);\n+----+-------------+--------+-------+---------------+--------+---------+------+------+----------+-----------------------+\n| id | select_type | table  | type  | possible_keys | key    | key_len | ref  | rows | filtered | Extra                 |\n+----+-------------+--------+-------+---------------+--------+---------+------+------+----------+-----------------------+\n|  1 | SIMPLE      | t_cost | range | idx_bc        | idx_bc | 8       | NULL | 1800 |   100.00 | Using index condition |\n+----+-------------+--------+-------+---------------+--------+---------+------+------+----------+-----------------------+\n</code></pre><p>eq_range_index_dive_limité»˜è®¤ä¸º200ï¼Œä¸Šé¢è¿™ä¸ªæµ‹è¯•SQLä¸­ï¼Œæ€»å…±æœ‰225ä¸ªåŒºé—´ï¼Œå› æ­¤ä¼˜åŒ–å™¨ä¼šæ”¾å¼ƒä½¿ç”¨index diveã€‚</p><p>ä»optimizer traceä¸­ï¼Œå¯ä»¥çœ‹åˆ°index_dives_for_eq_rangesä¸ºfalseï¼Œrowsä¸º1800ï¼Œæˆæœ¬ä¸º686.26ã€‚</p><pre><code class=\"language-plain\">{\n  \"index\": \"idx_bc\",\n  \"ranges\": [\n    \"b = 1 AND c = 1\",\n    \"b = 1 AND c = 2\",\n    \"b = 1 AND c = 3\",\n   ......\n    \"b = 15 AND c = 14\",\n    \"b = 15 AND c = 15\"\n  ],\n  \"index_dives_for_eq_ranges\": false,\n  \"rowid_ordered\": false,\n  \"using_mrr\": false,\n  \"index_only\": false,\n  \"in_memory\": 0,\n  \"rows\": 1800,\n  \"cost\": 686.26,\n  \"chosen\": true\n}\n</code></pre><p>æ ¹æ®å‰é¢çš„è®¡ç®—å…¬å¼ï¼Œå¯ä»¥å¾—åˆ°æ‰§è¡Œè®¡åˆ’çš„æˆæœ¬ã€‚</p><pre><code class=\"language-plain\">&gt;&gt;&gt; range_normal_cost(ranges=225,  rows=1800, in_mem_pct=1)\n686.26\n</code></pre><p>é‚£ä¹ˆè¿™é‡Œçš„è®°å½•æ•°æ˜¯æ€ä¹ˆè¯„ä¼°å‡ºæ¥çš„å‘¢ï¼Ÿè¿™éœ€è¦ç”¨åˆ°ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯ã€‚ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯å¯ä»¥é€šè¿‡information_schema.statisticsè¡¨æŸ¥çœ‹ï¼Œä¹Ÿå¯ä»¥é€šè¿‡show indexeså‘½ä»¤æŸ¥çœ‹ã€‚</p><pre><code class=\"language-plain\">mysql&gt; show indexes from t_cost;\n+------------+----------+--------------+-------------+-----------+-------------+\n| Non_unique | Key_name | Seq_in_index | Column_name | Collation | Cardinality |\n+------------+----------+--------------+-------------+-----------+-------------+\n|          0 | PRIMARY  |            1 | id          | A         |        8580 |\n|          1 | idx_ac   |            1 | a           | A         |           6 |\n|          1 | idx_ac   |            2 | c           | A         |         300 |\n|          1 | idx_bc   |            1 | b           | A         |        1000 |\n|          1 | idx_bc   |            2 | c           | A         |        1000 |\n+------------+----------+--------------+-------------+-----------+-------------+\n</code></pre><p>ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯å­—æ®µå«ä¹‰æˆ‘æ•´ç†åœ¨äº†è¿™ä¸ªè¡¨æ ¼ä¸­ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/4a/d3/4a3b0cf663da0820c11c2c588166bbd3.png?wh=1920x889\" alt=\"å›¾ç‰‡\"></p><p>ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯ä¸­æœ€é‡è¦å­—æ®µæ˜¯åŸºæ•°ã€‚å¯¹äºç»„åˆç´¢å¼•ï¼Œå­—æ®µçš„åŸºæ•°æ˜¯å½“å‰å­—æ®µä»¥åŠåºå·æ¯”å½“å‰å­—æ®µå°çš„é‚£äº›å­—æ®µçš„ç»„åˆå­—æ®µçš„å”¯ä¸€å€¼ã€‚åŸºæ•°å€¼è¶Šå¤§ï¼Œåˆ™é€šå¸¸è¯´æ˜ç´¢å¼•çš„é€‰æ‹©æ€§è¶Šé«˜ã€‚å½“ç„¶åœ¨å®é™…æƒ…å†µä¸­ï¼Œå¯èƒ½ä¼šå­˜åœ¨æ•°æ®åˆ†å¸ƒä¸å‡åŒ€çš„æƒ…å†µï¼ŒæŸäº›å€¼çš„è®°å½•æ•°ä¼šç‰¹åˆ«é«˜æˆ–ç‰¹åˆ«ä½ã€‚</p><p>æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œç´¢å¼•idx_bcçš„åŸºæ•°ä¸º1000ï¼Œå› æ­¤å¯¹äºwhere b=xx and c=xx è¿™æ ·çš„æ¡ä»¶ï¼ŒåŒ¹é…åˆ°çš„è®°å½•æ•°æ˜¯8580/1000ï¼Œç„¶åå†å–æ•´ï¼Œå¾—åˆ°è¡Œæ•°æ˜¯8ã€‚æˆ‘ä»¬çš„ä¾‹å­ä¸­æœ‰225ä¸ªè¿™æ ·çš„åŒºé—´ï¼Œå› æ­¤æ€»è®°å½•æ•°æ˜¯225 * 8ï¼Œä¹Ÿå°±æ˜¯1800ã€‚ä½ ä¹Ÿå¯ä»¥åœ¨mysql.innodb_index_statsè¡¨ä¸­æŸ¥çœ‹ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯ï¼Œæœ‰å…´è¶£çš„å¯ä»¥è‡ªå·±å»è¯•ä¸€è¯•ã€‚</p><h2>ç»Ÿè®¡ä¿¡æ¯</h2><p>é€šè¿‡å‰é¢è¿™å‡ ä¸ªç®€å•çš„ä¾‹å­ï¼Œä½ å¯ä»¥çœ‹åˆ°ç»Ÿè®¡ä¿¡æ¯çš„é‡è¦ä½œç”¨äº†ã€‚å‡†ç¡®çš„ç»Ÿè®¡ä¿¡æ¯å¯¹äºä¼˜åŒ–å™¨æ˜¯å¦èƒ½æ‰¾åˆ°æœ€ä¼˜çš„æ‰§è¡Œè®¡åˆ’èµ·ç€å…³é”®çš„ä½œç”¨ã€‚å¦‚æœç»Ÿè®¡ä¿¡æ¯ä¸å‡†ç¡®ï¼Œåˆ™ä¼˜åŒ–å™¨å¯èƒ½ä¼šé€‰æ‹©é”™è¯¯çš„æ‰§è¡Œè®¡åˆ’ã€‚é‚£ä¹ˆåº”è¯¥å¦‚ä½•ç»´æŠ¤ç»Ÿè®¡ä¿¡æ¯å‘¢ï¼Ÿ</p><p>æœ‰å‡ ä¸ªå‚æ•°æ§åˆ¶äº†InnoDBæ”¶é›†ç»Ÿè®¡ä¿¡æ¯çš„è¡Œä¸ºã€‚</p><ul>\n<li>innodb_stats_auto_recalc</li>\n</ul><p>è¯¥å‚æ•°æ§åˆ¶InnoDBæ˜¯å¦å¼€å¯ç»Ÿè®¡ä¿¡æ¯è‡ªåŠ¨æ”¶é›†ã€‚å¦‚æœå¼€å¯äº†ç»Ÿè®¡ä¿¡æ¯è‡ªåŠ¨æ”¶é›†ï¼Œåˆ™å½“è¡¨ä¸­çš„æ•°æ®å˜åŒ–è¶…è¿‡10%æ—¶ï¼ŒInnoDBåå°ä¼šè‡ªåŠ¨é‡æ–°è®¡ç®—è¡¨çš„ç›¸å…³ç»Ÿè®¡ä¿¡æ¯ã€‚è¯¥å‚æ•°é»˜è®¤å¼€å¯ã€‚å¦‚æœå…³é—­ç»Ÿè®¡ä¿¡æ¯è‡ªåŠ¨æ”¶é›†ï¼Œåˆ™éœ€è¦æ‰§è¡Œanalyze tableæ¥æ›´æ–°è¡¨çš„ç»Ÿè®¡ä¿¡æ¯ã€‚</p><ul>\n<li>innodb_stats_persistent</li>\n</ul><p>è¯¥å‚æ•°æ§åˆ¶æ˜¯å¦æŒä¹…åŒ–å­˜å‚¨InnoDBç»Ÿè®¡ä¿¡æ¯ï¼Œé»˜è®¤å¼€å¯ã€‚å¦‚æœæ²¡æœ‰å¼€å¯ç»Ÿè®¡ä¿¡æ¯æŒä¹…åŒ–å­˜å‚¨ï¼Œåˆ™ç»Ÿè®¡ä¿¡æ¯åªå­˜åœ¨å†…å­˜ä¸­ï¼Œåˆ™å½“MySQLé‡å¯åï¼Œæ‰€æœ‰InnoDBè¡¨çš„ç»Ÿè®¡ä¿¡æ¯éƒ½ç¼ºå¤±ã€‚æŸ¥è¯¢è¯­å¥è®¿é—®åˆ°ç¼ºå¤±ç»Ÿè®¡ä¿¡æ¯çš„è¡¨æ—¶ï¼Œä¼šæ”¶é›†ç»Ÿè®¡ä¿¡æ¯ã€‚</p><ul>\n<li>innodb_stats_persistent_sample_pages</li>\n</ul><p>è¯¥å‚æ•°æŒ‡å®šæ”¶é›†ç»Ÿè®¡ä¿¡æ¯æ—¶æ‰«æçš„é¡µé¢æ•°ã€‚è¯¥å‚æ•°è®¾ç½®å¾—è¶Šå¤§ï¼Œåˆ™analyze tableå¾—åˆ°çš„ç»Ÿè®¡ä¿¡æ¯è¶Šç²¾ç¡®ï¼Œä½†æ˜¯æ”¶é›†ç»Ÿè®¡ä¿¡æ¯çš„æ—¶é—´ä¼šå˜é•¿ï¼Œä¹Ÿä¼šæ¶ˆè€—æ›´å¤šçš„ç³»ç»ŸIOã€‚</p><ul>\n<li>innodb_stats_transient_sample_pages</li>\n</ul><p>innodb_stats_persistentè®¾ç½®ä¸ºOFFæ—¶ï¼Œä½¿ç”¨è¯¥å‚æ•°æ¥æ§åˆ¶æ”¶é›†ç»Ÿè®¡ä¿¡æ¯æ—¶æ‰«æçš„é¡µé¢æ•°ã€‚</p><ul>\n<li>innodb_stats_on_metadata</li>\n</ul><p>è¯¥å‚æ•°ç”¨äºæ§åˆ¶åœ¨æŸ¥çœ‹è¡¨çš„å…ƒæ•°æ®æ—¶ï¼ˆå¦‚æ‰§è¡ŒSHOW TABLE STATUSå‘½ä»¤ã€æŸ¥çœ‹information_schemaä¸­çš„TABLESã€STATISTICSè¡¨ï¼‰ï¼Œæ˜¯å¦æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ã€‚è¯¥å‚æ•°åªæœ‰å½“ç»Ÿè®¡ä¿¡æ¯æ²¡æœ‰æŒä¹…åŒ–æ—¶æ‰ç”Ÿæ•ˆï¼Œé»˜è®¤å…³é—­ã€‚</p><p>ä¸Šè¿°å‚æ•°åœ¨å…¨å±€æ§åˆ¶ç»Ÿè®¡ä¿¡æ¯æ”¶é›†è¡Œä¸ºã€‚InnoDBä¹Ÿæ”¯æŒåœ¨è¡¨çº§åˆ«æŒ‡å®šç»Ÿè®¡ä¿¡æ¯çš„æ”¶é›†ç­–ç•¥ã€‚å¯ä»¥åœ¨create tableæˆ–alter tableè¯­å¥ä¸­æŒ‡å®šSTATS_AUTO_RECALCã€STATS_PERSISTENTã€STATS_SAMPLE_PAGESè¿™å‡ ä¸ªé€‰é¡¹ï¼š</p><pre><code class=\"language-plain\">alter table tab \n    STATS_AUTO_RECALC = {DEFAULT|0|1},\n    STATS_PERSISTENT = {DEFAULT|0|1},\n    STATS_SAMPLE_PAGES = n;\n</code></pre><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ANALYZE TABLEå‘½ä»¤æ¥æ”¶é›†è¡¨çš„ç»Ÿè®¡ä¿¡æ¯ã€‚</p><pre><code class=\"language-plain\">ANALYZE [NO_WRITE_TO_BINLOG] TABLE tbl_name;\n\nANALYZE [NO_WRITE_TO_BINLOG | LOCAL]\n    TABLE tbl_name\n    UPDATE HISTOGRAM ON col_name\n    [WITH N BUCKETS];\n</code></pre><p>ANALYZE TABLEå‘½ä»¤çš„æ‰§è¡Œæ—¶é—´è·Ÿå‚æ•°innodb_stats_persistent_sample_pagesè®¾ç½®çš„é‡‡æ ·é¡µé¢æ•°ã€ç´¢å¼•å­—æ®µçš„æ•°é‡ä»¥åŠè¡¨çš„åˆ†åŒºæ•°ç›¸å…³ã€‚</p><h2>è¡¨è¿æ¥çš„æˆæœ¬è¯„ä¼°</h2><p>å¯¹äºå¤šè¡¨è¿æ¥ï¼Œä¼˜åŒ–å™¨éœ€è¦è¯„ä¼°ä¸åŒçš„è¿æ¥é¡ºåºä¸‹çš„æˆæœ¬ã€‚</p><pre><code class=\"language-plain\">select * \nfrom t1, t2, t3\nwhere t1.c1 = t1.c1\nand t2.c1 = t3.c1\nand ...\n</code></pre><p>æ¯”å¦‚å¯¹äºä¸Šé¢è¿™ä¸ªç®€å•çš„ä¸‰è¡¨è¿æ¥æŸ¥è¯¢ï¼Œå°±å­˜åœ¨6ç§å¯èƒ½çš„è¿æ¥é¡ºåºã€‚ä¼˜åŒ–å™¨éœ€è¦è¯„ä¼°æ¯ä¸€ä¸ªå¯èƒ½çš„æ‰§è¡Œè·¯å¾„çš„æˆæœ¬ï¼Œä»å…¶ä¸­é€‰æ‹©æˆæœ¬æœ€ä½çš„æ‰§è¡Œè·¯å¾„æ¥æ‰§è¡ŒæŸ¥è¯¢ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/9e/7f/9e8216c2f71f64e739910905813e457f.jpg?wh=1382x764\" alt=\"å›¾ç‰‡\"></p><p>è¡¨è¿æ¥çš„æˆæœ¬è¯„ä¼°ï¼Œä»¥åŠè¡¨è¿æ¥çš„æ‰§è¡Œï¼Œæˆ‘ä»¬åç»­æœ‰ä¸“é—¨çš„ä¸€èŠ‚è¯¾æ¥ä»‹ç»ã€‚</p><h2>å½±å“æ‰§è¡Œè®¡åˆ’çš„å…¶ä»–å› ç´ </h2><p>ä¼˜åŒ–å™¨æœ€ç»ˆä¼šé€‰æ‹©å“ªä¸ªæ‰§è¡Œè®¡åˆ’ï¼Œè¿˜å—åˆ°å…¶ä»–ä¸€äº›å› ç´ çš„å½±å“ã€‚</p><ol>\n<li>ä¼˜åŒ–å™¨å‚æ•°</li>\n</ol><p>å‰é¢æˆ‘ä»¬ä»‹ç»äº†å‚æ•°eq_range_index_dive_limitçš„ä½œç”¨ã€‚è¿˜æœ‰å…¶ä»–å‡ ä¸ªå‚æ•°ä¹Ÿä¼šå½±å“ä¼˜åŒ–å™¨ã€‚</p><p>å‚æ•°range_optimizer_max_mem_sizeç”¨æ¥é™åˆ¶rangeä¼˜åŒ–èƒ½ä½¿ç”¨çš„å†…å­˜ã€‚å¯¹äºwhere a in (x,x,x) and b in (x,x,x) and c in (x,x,x)è¿™æ ·çš„æ¡ä»¶ï¼Œæ¯ä¸€ä¸ªç»„åˆéƒ½ä¼šæ¶ˆè€—ä¸€å®šçš„å†…å­˜ï¼Œå½“ç»„åˆçš„æ•°é‡ç‰¹åˆ«å¤šæ—¶ï¼Œå¦‚æœå†…å­˜æ¶ˆè€—é‡è¶…å‡ºäº†range_optimizer_max_mem_sizeçš„é™åˆ¶ï¼Œä¼˜åŒ–å™¨å°±ä¼šæ”¾å¼ƒè¿™ä¸ªrangeä¼˜åŒ–ï¼Œæ”¹ä¸ºä½¿ç”¨å…¨è¡¨æ‰«æã€‚</p><p>ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°†range_optimizer_max_mem_sizeè®¾ç½®å¾—å°ä¸€äº›ï¼Œå°±èƒ½çœ‹åˆ°è¿™æ ·çš„waningä¿¡æ¯â€œMemory capacity of 16384 bytes for â€˜range_optimizer_max_mem_sizeâ€™ exceededâ€ã€‚ç°å®ä¸­ï¼Œæˆ‘ä¹Ÿé‡åˆ°è¿‡ç”±äºinçš„ç»„åˆæ•°å¤ªå¤šå¯¼è‡´çš„å…¨è¡¨æ‰«æã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå³ä½¿ä½¿ç”¨äº†FORCE INDEXæç¤ºï¼Œä¼˜åŒ–å™¨è¿˜æ˜¯ä¼šä½¿ç”¨å…¨è¡¨æ‰«æã€‚</p><pre><code class=\"language-plain\">mysql&gt; set range_optimizer_max_mem_size=16384;\nQuery OK, 0 rows affected (0.01 sec)\n\nmysql&gt; explain   select * from tab\n         where a in (1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20)\n         and  b in (1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20)\n         and c in (1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20) ;\n+----+-------------+-------+------+---------------+------+---------+------+------+----------+-------------+\n| id | select_type | table | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra       |\n+----+-------------+-------+------+---------------+------+---------+------+------+----------+-------------+\n|  1 | SIMPLE      | tab   | ALL  | idx_abc       | NULL | NULL    | NULL | 9913 |    12.50 | Using where |\n+----+-------------+-------+------+---------------+------+---------+------+------+----------+-------------+\n1 row in set, 2 warnings (0.00 sec)\n\n\nmysql&gt; explain   select * from tab force index(idx_abc)\n     where a in (1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20)\n     and  b in (1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20)\n     and c in (1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20) ;\n+----+-------------+-------+------+---------------+------+---------+------+------+----------+-------------+\n| id | select_type | table | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra       |\n+----+-------------+-------+------+---------------+------+---------+------+------+----------+-------------+\n|  1 | SIMPLE      | tab   | ALL  | idx_abc       | NULL | NULL    | NULL | 9913 |    12.50 | Using where |\n+----+-------------+-------+------+---------------+------+---------+------+------+----------+-------------+\n1 row in set, 2 warnings (0.00 sec)\n</code></pre><pre><code class=\"language-plain\">mysql&gt; show warnings\\G\n*************************** 1. row ***************************\n  Level: Warning\n   Code: 3170\nMessage: Memory capacity of 16384 bytes for 'range_optimizer_max_mem_size' exceeded. Range optimization was not done for this query.\n</code></pre><p>å‚æ•°optimizer_switchæä¾›äº†ä¼˜åŒ–å™¨å¾ˆå¤šåŠŸèƒ½çš„å¼€å…³ã€‚åç»­çš„å‡ è®²ä¸­ï¼Œæˆ‘ä¼šå¯¹è¿™é‡Œé¢çš„éƒ¨åˆ†é€‰é¡¹åšä¸€äº›ä»‹ç»ã€‚</p><pre><code class=\"language-plain\">mysql&gt; show variables like 'optimizer_switch'\\G\n*************************** 1. row ***************************\nVariable_name: optimizer_switch\n        Value: index_merge=on,index_merge_union=on,index_merge_sort_union=on,index_merge_intersection=on,engine_condition_pushdown=on,index_condition_pushdown=on,mrr=on,mrr_cost_based=on,block_nested_loop=on,batched_key_access=off,materialization=on,semijoin=on,loosescan=on,firstmatch=on,duplicateweedout=on,subquery_materialization_cost_based=on,use_index_extensions=on,condition_fanout_filter=on,derived_merge=on,use_invisible_indexes=off,skip_scan=on,hash_join=on,subquery_to_derived=off,prefer_ordering_index=on,hypergraph_optimizer=off,derived_condition_pushdown=on\n</code></pre><p>å‚æ•°optimizer_search_depthå’Œoptimizer_prune_levelå¯¹å¤šè¡¨æ¥è¿æŸ¥è¯¢æœ‰å½±å“ï¼Œæˆ‘ä»¬åœ¨è¡¨è¿æ¥é‚£ä¸€è®²ä¸­å†æ¥ä»‹ç»ã€‚</p><ol start=\"2\">\n<li>ä¼˜åŒ–å™¨æç¤ºï¼ˆhintï¼‰</li>\n</ol><p>ä¼˜åŒ–å™¨æç¤ºä¹Ÿèƒ½å½±å“æ‰§è¡Œè®¡åˆ’ï¼Œä¸Šä¸€è®²ä¸­æˆ‘ä»¬å°±ä½¿ç”¨äº†NO_SEMIJOINã€QB_NAMEã€BKAç­‰æç¤ºæ¥å›ºå®šæŸ¥è¯¢çš„æ‰§è¡Œè®¡åˆ’ã€‚</p><p>å¹³æ—¶æ¯”è¾ƒå¸¸ç”¨çš„å¯èƒ½æ˜¯FORCE INDEXã€IGNORE INDEXã€USE INDEXè¿™äº›æç¤ºã€‚FORCE INDEXä¸­ï¼Œå¯ä»¥æŒ‡å®šå¤šä¸ªç´¢å¼•ã€‚è¯­å¥ä¸­åŠ å…¥force indexæç¤ºåï¼Œä¼˜åŒ–å™¨åªä¼šè€ƒè™‘ä½¿ç”¨è¿™é‡Œé¢æŒ‡å®šçš„ç´¢å¼•ã€‚</p><p>ä¸‹é¢çš„è¿™ä¸ªæµ‹è¯•SQLä½¿ç”¨äº†force index(idx_ac, idx_bc)ï¼Œè™½ç„¶IDæ˜¯ä¸»é”®ï¼Œä½†æ˜¯å¯ä»¥çœ‹åˆ°ï¼Œä¼˜åŒ–å™¨æ²¡æœ‰è€ƒè™‘ä½¿ç”¨PRIMARYè¿™ä¸ªç´¢å¼•ï¼Œè€Œæ˜¯ä½¿ç”¨äº†å…¨è¡¨æ‰«æã€‚æ³¨æ„æ‰§è¡Œè®¡åˆ’ä¸­ï¼Œpossible_keysä¸ºNULLã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain select * from t_cost force index(idx_ac, idx_bc) where id = 1;\n+----+-------------+--------+------+---------------+------+---------+------+------+----------+-------------+\n| id | select_type | table  | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra       |\n+----+-------------+--------+------+---------------+------+---------+------+------+----------+-------------+\n|  1 | SIMPLE      | t_cost | ALL  | NULL          | NULL | NULL    | NULL | 8580 |     0.01 | Using where |\n+----+-------------+--------+------+---------------+------+---------+------+------+----------+-------------+\n</code></pre><p>FORCE INDEXè¿˜æœ‰å¦å¤–ä¸€ä¸ªæ•ˆæœï¼Œå¦‚æœè¯­å¥å¯ä»¥ä½¿ç”¨åˆ°æç¤ºä¸­çš„æŸä¸ªç´¢å¼•ï¼Œé‚£ä¹ˆå°±ä¸ä½¿ç”¨å…¨è¡¨æ‰«æã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain select * from t_merge where a&gt;0;\n+----+-------------+---------+------+---------------+------+---------+------+----------+-------------+\n| id | select_type | table   | type | possible_keys | key  | key_len | rows | filtered | Extra       |\n+----+-------------+---------+------+---------------+------+---------+------+----------+-------------+\n|  1 | SIMPLE      | t_merge | ALL  | idx_ad        | NULL | NULL    | 9737 |    49.99 | Using where |\n+----+-------------+---------+------+---------------+------+---------+------+----------+-------------+\n\nmysql&gt; explain select * from t_merge force index(idx_ad, idx_bd)  where a &gt; 0;\n+----+-------------+---------+-------+---------------+--------+---------+------+----------+-----------------------+\n| id | select_type | table   | type  | possible_keys | key    | key_len | rows | filtered | Extra                 |\n+----+-------------+---------+-------+---------------+--------+---------+------+----------+-----------------------+\n|  1 | SIMPLE      | t_merge | range | idx_ad        | idx_ad | 4       | 4868 |   100.00 | Using index condition |\n+----+-------------+---------+-------+---------------+--------+---------+------+----------+-----------------------+\n</code></pre><h2>æ€»ç»“</h2><p>è¿™ä¸€è®²ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†MySQLä¼˜åŒ–å™¨çš„ä¸€äº›å·¥ä½œåŸç†ã€‚ä¼˜åŒ–å™¨ä¼šé€‰æ‹©æˆæœ¬æœ€ä½çš„æ‰§è¡Œè®¡åˆ’ã€‚æˆ‘ä»¬ä»‹ç»äº†å…¨è¡¨æ‰«æå’Œç´¢å¼•èŒƒå›´æ‰«æè¿™ä¸¤ç§æœ€åŸºæœ¬ï¼Œä¹Ÿæ˜¯æœ€é‡è¦çš„è®¿é—®è·¯å¾„çš„æˆæœ¬è®¡ç®—æ–¹æ³•ã€‚</p><p>å®é™…å·¥ä½œä¸­ä¼˜åŒ–SQLæ—¶ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦çœŸçš„çŸ¥é“æŸä¸ªæ‰§è¡Œè®¡åˆ’çš„æˆæœ¬ï¼Œé‚£æ˜¯ä¼˜åŒ–å™¨è¦è®¡ç®—çš„ã€‚ä½†æ˜¯æˆ‘ä»¬éœ€è¦ç†è§£å…¨è¡¨æ‰«æå’Œç´¢å¼•è®¿é—®å¤§è‡´çš„åŸç†ï¼Œç†è§£è¿™ä¸¤ç§æ‰§è¡Œè®¡åˆ’çš„å¼€é”€æ¥è‡ªå“ªé‡Œã€‚</p><p>ç»Ÿè®¡ä¿¡æ¯å¯¹ä¼˜åŒ–å™¨å¾ˆé‡è¦ï¼Œå¦‚æœç»Ÿè®¡ä¿¡æ¯ä¸å‡†ç¡®ï¼Œä¼˜åŒ–å™¨å¾ˆå¯èƒ½ä¼šé€‰æ‹©é”™è¯¯çš„æ‰§è¡Œè®¡åˆ’ã€‚æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ä¼˜åŒ–å™¨å‚æ•°ã€SQLæç¤ºæ¥å½±å“ä¼˜åŒ–å™¨ã€‚ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘å»ºè®®å°½é‡å°‘ç”¨SQLæç¤ºï¼Œè®©ä¼˜åŒ–å™¨è‡ªå·±é€‰æ‹©æœ€ä¼˜çš„æ‰§è¡Œè®¡åˆ’ã€‚åœ¨ä¸€äº›æ¯”è¾ƒå¤æ‚çš„åœºæ™¯ä¸‹ï¼Œå¦‚æœä¼˜åŒ–å™¨ç¡®å®é€‰ä¸åˆ°æœ€ä¼˜çš„æ‰§è¡Œè®¡åˆ’æ—¶ï¼Œå†è€ƒè™‘ä½¿ç”¨SQLæç¤ºã€‚</p><h2>æ€è€ƒé¢˜</h2><p>æœ‰æ—¶æˆ‘ä»¬éœ€è¦åˆ†æ®µå¤„ç†å…¨è¡¨çš„æ•°æ®ã€‚å¦‚æœè¡¨ä½¿ç”¨äº†å•åˆ—ä¸»é”®ï¼Œé‚£ä¹ˆå¯ä»¥å¾ˆæ–¹ä¾¿åœ°æŒ‰ä¸»é”®èŒƒå›´æ¥è¿›è¡Œæ•°æ®åˆ†ç‰‡ã€‚ä½†æœ‰äº›æƒ…å†µä¸‹ï¼Œä¸šåŠ¡ä½¿ç”¨äº†è”åˆä¸»é”®ï¼Œé‚£ä¹ˆæ­¤æ—¶ä½ åº”è¯¥æ€ä¹ˆæŒ‰ä¸»é”®èŒƒå›´æ¥å¯¹æ•°æ®è¿›è¡Œåˆ†ç‰‡å‘¢ï¼Ÿ</p><pre><code class=\"language-plain\">create table t_business(\n  id1 varchar(30) not null,\n  id2 varchar(30) not null,\n  id3 varchar(30) not null,\n  col1 ...,\n  col2 ...,\n  primry key(id1, id2, id3)\n) engine=innodb;\n</code></pre><p>è€ƒè™‘ä¸Šé¢è¿™ä¸ªè¡¨ï¼Œä½¿ç”¨äº†è”åˆä¸»é”®(id1, id2, id3)ã€‚ä½ éœ€è¦åˆ†ç‰‡å¤„ç†è¿™ä¸ªè¡¨çš„æ•°æ®ï¼Œæ¯æ¬¡å¤„ç†1000è¡Œæ•°æ®ï¼Œè¦æ±‚ä¸è¦é‡å¤å¤„ç†æ•°æ®ï¼Œä½†ä¹Ÿä¸è¦æ¼æ‰ä»»ä½•ä¸€æ¡æ•°æ®ã€‚æ•´ä¸ªè¡¨çš„æ•°æ®é‡æ¯”è¾ƒå¤§ï¼Œè¦å°½å¯èƒ½ä¿è¯æ€§èƒ½ã€‚ä½ ä¼šæ€ä¹ˆæ¥å†™è¿™ä¸ªåˆ†é¡µçš„SQLå‘¢ï¼Ÿ</p><p>æœŸå¾…ä½ çš„æ€è€ƒï¼Œæ¬¢è¿åœ¨ç•™è¨€åŒºä¸­ä¸æˆ‘äº¤æµã€‚å¦‚æœä»Šå¤©çš„è¯¾ç¨‹è®©ä½ æœ‰æ‰€æ”¶è·ï¼Œä¹Ÿæ¬¢è¿è½¬å‘ç»™æœ‰éœ€è¦çš„æœ‹å‹ã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼</p>","neighbors":{"left":{"article_title":"18ï½œè¯»æ‡‚MySQLä¸­çš„æ‰§è¡Œè®¡åˆ’ï¼ˆä¸‹ï¼‰","id":810868},"right":{"article_title":"20ï½œå•è¡¨æŸ¥è¯¢ï¼šå¦‚ä½•è¯„ä¼°å•è¡¨è®¿é—®æˆæœ¬ï¼Ÿ","id":810682}},"comments":[{"had_liked":false,"id":394810,"user_name":"å¶æ˜","can_delete":false,"product_type":"c1","uid":1412429,"ip_address":"æ±Ÿè‹","ucode":"D0B4B7660DA766","user_header":"https://static001.geekbang.org/account/avatar/00/15/8d/4d/992070e8.jpg","comment_is_top":false,"comment_ctime":1728458947,"is_pvip":false,"replies":[{"id":143373,"content":"è¿™ç§å†™æ³•æ˜¯æˆ‘èƒ½æƒ³åˆ°çš„ï¼Œåœ¨è¿™ä¸ªåœºæ™¯ä¸‹æœ€å¥½çš„æ–¹æ³•ã€‚\nğŸ‘ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3898827,"ctime":1728553084,"ip_address":"æµ™æ±Ÿ","comment_id":394810,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100799401,"comment_content":"  \nå¦å¤–ï¼Œæˆ‘çœ‹ gh-ost çš„å®ç°æ–¹å¼æ˜¯å¦å¤–ä¸€ç§ï¼Œä»å·¦å³è¾¹ç•Œå’Œè”åˆä¸»é”®ä¸­å­—æ®µä¹‹é—´çš„åŒºé—´æ¥è€ƒè™‘\n  1. æœ€å·¦è¾¹çš„è¾¹ç•Œ: id1=&#39;a&#39; and id2=&#39;a&#39; and id3=&#39;1&#39;ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªæŸ¥è¯¢æ¡ä»¶æ¥æ‹¿åˆ°æœ€å·¦è¾¹ç•Œçš„è®°å½•\n  2. è”åˆä¸»é”® (id1, id2, id3) ä¸­ id1 å¤„äºç´¢å¼•ä¸­ç¬¬ä¸€åˆ—ï¼Œå› æ­¤ id1 æ˜¯æœ‰åºçš„ï¼ŒæŸ¥è¯¢æ¡ä»¶ id1&gt;&#39;a&#39; æ‹¿åˆ°é™¤ id1=&#39;a&#39; ä¹‹å¤–çš„æ‰€æœ‰è®°å½•\n  3. æ­¥éª¤2å®Œæˆåï¼Œåªéœ€è¦è€ƒè™‘ id1=&#39;a&#39; çš„æœ€åä¸€æ¡è®°å½•ä¸ç¬¬ä¸€æ¡è®°å½• (id1=&#39;a&#39;, id2=&#39;a&#39;, id3=&#39;1&#39;) è¿™æ®µèŒƒå›´çš„è®°å½•äº†\n  4. å½“ id1=&#39;a&#39; and id2=&#39;a&#39; æ—¶ï¼Œè¦æƒ³è®¿é—® id3 çš„æ‰€æœ‰è®°å½•ï¼ŒæŸ¥è¯¢æ¡ä»¶å¾—ä¸º id3 &gt; &#39;1&#39;ï¼Œè¿™æ ·å°±èƒ½æ‹¿åˆ° id1, id2 ä¸ºå›ºå®šå€¼æ—¶ï¼Œid3 &gt; &#39;1&#39; çš„æ‰€æœ‰è®°å½•ï¼Œid3 = 1 çš„è¾¹ç•Œå€¼åœ¨æ­¥éª¤ 1 ä¸­å·²ç»æ‹¿åˆ°äº†\n  5. æ­¥éª¤4å®Œæˆåï¼Œæ»¡è¶³ id1=&#39;a&#39; and id2=&#39;a&#39; æ¡ä»¶çš„æ‰€æœ‰è®°å½•å·²ç»èƒ½æ‹¿åˆ°äº†ï¼Œæ¥ä¸‹æ¥ï¼Œæ‹¿ id1 = &#39;a&#39; æ—¶ï¼Œid2 &gt; &#39;a&#39; çš„æ‰€æœ‰è®°å½•ï¼Œè¿™æ ·ï¼Œid1=&#39;a&#39; çš„æ‰€æœ‰è®°å½•å°±éƒ½èƒ½æ‹¿åˆ°äº†\n\nselect\n  &#47;* gh-ost `test`.`t_business` iteration:0 *&#47; `id1`,\n  `id2`,\n  `id3`\nfrom\n  `test`.`t_business`\nwhere\n  (\n    (`id1` &gt; _binary &#39;a&#39;)\n    or (\n      ((`id1` = _binary &#39;a&#39;))\n      AND (`id2` &gt; _binary &#39;a&#39;)\n    )\n    or (\n      (\n        (`id1` = _binary &#39;a&#39;)\n        and (`id2` = _binary &#39;a&#39;)\n      )\n      AND (`id3` &gt; _binary &#39;1&#39;)\n    )\n    or (\n      (`id1` = _binary &#39;a&#39;)\n      and (`id2` = _binary &#39;a&#39;)\n      and (`id3` = _binary &#39;1&#39;)\n    )\n  )\n  and (\n    (`id1` &lt; _binary &#39;d&#39;)\n    or (\n      ((`id1` = _binary &#39;d&#39;))\n      AND (`id2` &lt; _binary &#39;a&#39;)\n    )\n    or (\n      (\n        (`id1` = _binary &#39;d&#39;)\n        and (`id2` = _binary &#39;a&#39;)\n      )\n      AND (`id3` &lt; _binary &#39;9990&#39;)\n    )\n    or (\n      (`id1` = _binary &#39;d&#39;)\n      and (`id2` = _binary &#39;a&#39;)\n      and (`id3` = _binary &#39;9990&#39;)\n    )\n  )\norder by\n  `id1` asc,\n  `id2` asc,\n  `id3` asc\nlimit\n  1\noffset\n  99","like_count":1,"discussions":[{"author":{"id":3898827,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/7d/cb/fa3dae58.jpg","nickname":"ä¿Šè¾¾","note":"","ucode":"F79BF9651AD086","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":652261,"discussion_content":"è¿™ç§å†™æ³•æ˜¯æˆ‘èƒ½æƒ³åˆ°çš„ï¼Œåœ¨è¿™ä¸ªåœºæ™¯ä¸‹æœ€å¥½çš„æ–¹æ³•ã€‚\nğŸ‘ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1728553084,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":394809,"user_name":"å¶æ˜","can_delete":false,"product_type":"c1","uid":1412429,"ip_address":"æ±Ÿè‹","ucode":"D0B4B7660DA766","user_header":"https://static001.geekbang.org/account/avatar/00/15/8d/4d/992070e8.jpg","comment_is_top":false,"comment_ctime":1728458935,"is_pvip":false,"replies":[{"id":143372,"content":"æ˜¯çš„ã€‚ä½ æƒ³çš„è¿™ç§æ–¹å¼ï¼Œ(id1, id2, id3) &gt;= (&#39;a&#39;, &#39;a&#39;, &#39;1&#39;) æˆ‘ä¹Ÿå°è¯•è¿‡ï¼Œè¿™ç§å†™æ³•MySQLå¥½åƒä¼šå…¨è¡¨æ‰«æã€‚ğŸ˜­ğŸ˜­","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3898827,"ctime":1728552938,"ip_address":"æµ™æ±Ÿ","comment_id":394809,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100799401,"comment_content":"è”åˆä¸»é”®çš„æœ€å°å’Œæœ€å¤§å€¼æ¯”è¾ƒå®¹æ˜“ç¡®å®šï¼Œæ¯”å¦‚æˆ‘è¿™é‡Œçš„æœ€å°å€¼ (&#39;a&#39;, &#39;a&#39;, &#39;1&#39;)ï¼Œæœ€å¤§å€¼ (&#39;d&#39;, &#39;a&#39;, &#39;9990&#39;)ï¼Œä¸èƒ½é€šè¿‡ id1&gt;=&#39;a&#39; and id2&gt;=&#39;a&#39; and id3&gt;=&#39;1&#39; ä»¥åŠ id1&lt;=&#39;d&#39; and id2&lt;=&#39;a&#39; and id3 &lt;= &#39;9990&#39; æ¥è¿›è¡Œæ•°æ®åˆ†ç‰‡ï¼Œ\nè¿™æ˜¯å› ä¸ºè¿™ä¸‰ä¸ªå­—æ®µä½œä¸ºè”åˆä¸»é”®ï¼Œä¸‰ä¸ªå­—æ®µä½œä¸ºä¸€ä¸ªæ•´ä½“æ˜¯æœ‰åºçš„ï¼Œä½†ç»†åŒ–åˆ° id2, id3 å­—æ®µï¼Œåˆ™æ˜¯å½“å‰é¢å­—æ®µçš„å€¼å›ºå®šæ—¶ï¼Œåé¢çš„å­—æ®µæ‰æ˜¯æœ‰åºçš„ï¼Œå¦‚æœæŒ‰ç…§ id1&gt;=&#39;a&#39; and id2&gt;=&#39;a&#39; and id3&gt;=&#39;1&#39; å»åŒ¹é…ï¼Œé‚£ä¹ˆä¼šæ¼æ‰ä¸€äº›æ•°æ®ã€‚\næˆ‘æƒ³åˆ°çš„ä¸€ç§æ–¹å¼æ˜¯å°†è”åˆå­—æ®µä½œä¸ºä¸€ä¸ªæ•´ä½“å»åŒ¹é…ï¼Œä¾‹å¦‚ (id1, id2, id3) &gt;= (&#39;a&#39;, &#39;a&#39;, &#39;1&#39;)ã€‚","like_count":0,"discussions":[{"author":{"id":3898827,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/7d/cb/fa3dae58.jpg","nickname":"ä¿Šè¾¾","note":"","ucode":"F79BF9651AD086","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":652260,"discussion_content":"æ˜¯çš„ã€‚ä½ æƒ³çš„è¿™ç§æ–¹å¼ï¼Œ(id1, id2, id3) &gt;= (&#39;a&#39;, &#39;a&#39;, &#39;1&#39;) æˆ‘ä¹Ÿå°è¯•è¿‡ï¼Œè¿™ç§å†™æ³•MySQLå¥½åƒä¼šå…¨è¡¨æ‰«æã€‚ğŸ˜­ğŸ˜­","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1728552938,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":394801,"user_name":"ls","can_delete":false,"product_type":"c1","uid":1001037,"ip_address":"ä¸Šæµ·","ucode":"C18E208B1DFDA7","user_header":"https://static001.geekbang.org/account/avatar/00/0f/46/4d/161f3779.jpg","comment_is_top":false,"comment_ctime":1728448782,"is_pvip":true,"replies":[{"id":143374,"content":"è¿™ä¹Ÿæ˜¯ä¸€ç§è§£æ³•ï¼Œé¿å…äº†åˆ†é¡µSQLã€‚ä¸è¿‡è¦æ³¨æ„ï¼Œå®¢æˆ·ç«¯è¦ä½¿ç”¨æµå¼å¤„ç†ï¼Œä¸è¦ä¸€æ¬¡æ€§æŠŠæ•´ä¸ªè¡¨çš„æ•°æ®éƒ½ç¼“å­˜åœ¨å®¢æˆ·ç«¯ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3898827,"ctime":1728553296,"ip_address":"æµ™æ±Ÿ","comment_id":394801,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100799401,"comment_content":"å¾ªç¯ä¸»é”®ï¼Œæ ¹æ®ä¸»é”®å»æ‰¹é‡æ›´æ–°1000è¡Œï¼Œæ¯1000è¡Œæäº¤ä¸€æ¬¡ã€‚æ˜¯ä¸æ˜¯å°±å¯ä»¥äº†","like_count":0,"discussions":[{"author":{"id":3898827,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/7d/cb/fa3dae58.jpg","nickname":"ä¿Šè¾¾","note":"","ucode":"F79BF9651AD086","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":652262,"discussion_content":"è¿™ä¹Ÿæ˜¯ä¸€ç§è§£æ³•ï¼Œé¿å…äº†åˆ†é¡µSQLã€‚ä¸è¿‡è¦æ³¨æ„ï¼Œå®¢æˆ·ç«¯è¦ä½¿ç”¨æµå¼å¤„ç†ï¼Œä¸è¦ä¸€æ¬¡æ€§æŠŠæ•´ä¸ªè¡¨çš„æ•°æ®éƒ½ç¼“å­˜åœ¨å®¢æˆ·ç«¯ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1728553296,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]}]}