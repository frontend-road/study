{"id":793365,"title":"03｜变更：为什么说变更是可靠性的第一杀手？","content":"<p>你好，我是白园。今天我们来聊聊可靠性领域的第三个部分——变更。</p><p>你有没有发现一个现象，无论是国内的公司还是海外的公司，在故障原因中，变更所占的比例最大。你有没有想过原因是什么？既然变更是可靠性第一杀手，那么有没有什么办法来彻底解决这个问题？</p><p>在接下来的内容中，我将带你深入探讨变更背后的原理，并分析为什么变更会成为系统稳定性的主要威胁。此外，我将分享一套有效的策略来应对变更带来的风险，帮助你提高系统的可靠性。通过这些方法，我们可以更好地控制变更过程，减少其带来的负面影响。</p><h2>变更是什么？</h2><p>正式开始之前，你可以先回答我一个问题，以下哪些操作属于变更？</p><p><img src=\"https://static001.geekbang.org/resource/image/83/dd/83487d4283f194d9b8381aee0eff1cdd.png?wh=1938x1292\" alt=\"图片\"></p><p>答案是：上述列举的所有操作都属于变更。实际上，任何操作只要有可能影响到线上服务可靠性都会被视为一种变更。</p><h2><strong>为什么说变更是可靠性的第一杀手？</strong></h2><p>变更的本质就是打破稳态，在日常工作中，任何形式的变更，在变更过程中都可能让一个系统从稳定状态转变为不稳定状态。而系统处于不稳定状态的时候，正是故障最容易发生的时刻。</p><p><img src=\"https://static001.geekbang.org/resource/image/dd/7a/dd9a2fb1cc76975bf4dc9f1d6af5747a.png?wh=2046x744\" alt=\"图片\"></p><p>其次，变更的来源广泛，发生频率高，形式多样，涵盖软件更新、配置调整、硬件升级等类型，这些都显著增加了风险。在我负责的业务领域，变更日均超过百次，涵盖代码发布、配置调整、A/B测试等多种类型。历史上，这些类型变更都曾引发过故障。</p><!-- [[[read_end]]] --><h2><strong>如何应对变更带来的风险？</strong></h2><p>接下来，我们将探讨如何应对变更带来的风险。首先，我们需要对变更故障进行分类。在宏观层面上，变更故障主要分为两大类：主观因素导致的故障和客观因素导致的故障。</p><p>主观因素主要涉及人为问题，包括：</p><ul>\n<li><strong>没有按照既定流程操作</strong>：比如一个同学在封网期间，由于自信而跳过审批环节进行变更，最终引发线上故障。</li>\n<li><strong>忽略测试环节</strong>：一个同学感觉代码的变化很小就省略线下环境测试，直接在生产环境部署了新代码，最终恰恰是这个很小的变更引发了故障。</li>\n<li><strong>没有关注监控</strong>：在小流量测试阶段忽视了对关键指标的观察，未能及时发现指标变化，可能导致全面部署后故障大规模爆发。</li>\n<li><strong>变更比较随意</strong>：团队成员可以在任何时间进行变更，这不仅增加了变更的频率，而且由于变更时间的分散，难以确保所有相关人员都能及时响应，从而可能加剧了系统故障的风险。</li>\n</ul><p>客观因素主要涉及平台和工具的问题：</p><ul>\n<li><strong>监控指标太多</strong>：关键指标的变化微小且不易被察觉，如内存泄露问题，通常难以通过监控发现，直到内存报警才引起注意。</li>\n<li><strong>隐藏的Bug</strong>：例如，只有特定请求触发的core dump或用户ID越界问题，这些 Bug通常只在特定条件下才导致线上服务崩溃。</li>\n<li><strong>上下游服务问题</strong>：上线新功能可能导致下游服务调用量激增，如果没有及时监控下游服务的容量，可能会在高峰时段引发故障。</li>\n</ul><h3>整体应对方案</h3><p>为了有效应对变更带来的风险，我们双管齐下，一方面解决主观层面的问题，另一方面解决客观层面的问题。我们的应对措施贯穿变更的全过程，包括变更前、变更中和变更后三个阶段。此外，我们还可以依赖平台、工具和人工智能技术的支持，提高风险管理的效率和效果。</p><p><img src=\"https://static001.geekbang.org/resource/image/39/87/39d8fcae25806e74955bb45afdbb7a87.jpg?wh=3460x1792\" alt=\"\"></p><h3>主观层面上</h3><p>首要任务是提升团队成员对变更管理的重视。许多团队成员可能对变更流程和规范不够了解，因此必须明确传达相关的操作流程和标准。为确保线上变更的安全性，所有成员在进行变更操作前必须通过相应的流程和规范考核。原则上，只有考核合格者才有资格执行线上变更操作，这是保障变更安全的基本前提。</p><p><img src=\"https://static001.geekbang.org/resource/image/13/52/13bea9fb6716824706d8d9d7b7354f52.png?wh=1864x616\" alt=\"图片\"></p><p>建立明确的奖惩制度，尤其要强调惩罚措施的重要性。</p><ul>\n<li><strong>通报批评</strong>：对于未遵守变更规范而引发故障的行为，应在适当的范围内公开批评相关人员及其直接上级。若故障影响较大，应相应扩大通报的级别和范围。</li>\n<li><strong>禁止上线权限</strong>：对于造成故障的个人，可以暂时撤销其上线和变更的权限，例如禁止期限为两周，直至其重新学习并通过考核后，才能恢复权限。这类似于驾驶违章的积分处罚制度。</li>\n<li><strong>绩效考核影响</strong>：对于造成严重后果的故障，应在绩效考核中予以明确体现，确保责任与后果相匹配。</li>\n</ul><p>实施严格的变更机制，提高变更的审慎性，并有效降低变更的频率。比如<strong>班车制度</strong>就是一种有效的方法，它允许将多个变更集中到单一的部署过程中。这样做的优势在于显著减少了变更次数，并在出现问题时便于执行回滚操作。</p><p>此外，我们还应当<strong>设定变更时间窗口期</strong>，避免在团队休息时段进行变更。推荐上午10点到中午12点，以及下午2点到5点之间进行变更操作，确保在变更过程中有足够的团队成员可以支持和应对可能出现的问题。当然你可以根据自己的业务场景设置合理的变更窗口期。</p><h3>客观层面上</h3><p>整体分为变更前、变更中、变更后三个阶段，我们看一下每一个阶段应该做哪些事情。</p><h4>变更前：充分评估、准备</h4><p>首先我们应该<strong>详细记录每次变更的具体内容</strong>，包括更新了哪些代码模块、变更执行者的身份，还有是否已经完成了QA测试。如果测试被跳过，必须说明原因。然后在变更前，需要<strong>评估变更可能对哪些功能造成影响</strong>，还有是否会增加资源的使用量，这些评估应当尽可能准确。最后是<strong>制定详细的回滚计划</strong>，来应对变更后可能出现的问题。计划中应该包括怎么回滚配置、代码或数据，还有如果涉及数据变更，应该提前进行备份的步骤。</p><h4>变更时：分级发布</h4><p>分级发布是一种非常有效的应对变更风险的策略，目的是将变更可能引起的风险最小化。在实施线上变更时，将整个变更过程细化为若干阶段，每个阶段针对特定的服务实例或可用区进行操作。理想状态下，变更应<strong>按照服务单元的逻辑顺序</strong>逐步展开。这种分阶段的方法允许我们在早期发现问题时及时采取措施，为后续的故障控制提供了更大的灵活性，有效降低了整体风险。</p><p><strong>分级发布的三要素</strong></p><ol>\n<li>变更顺序：按可用区依次进行，这里的可用区，可以是分组或者机房，这个就按照具体的业务情况来定。可用区之间要严格按照顺序进行，不要并行。这样的好处是，当一个可用区有问题的时候可以快速切流到另一个，不至于两个都挂掉。在可用区内也要按照一定比例的顺序进行。</li>\n<li>变更检查：在每个阶段之间要进行严格的变更检测。比如可用性、延迟、资源消耗等等。一旦有问题就需要进行变更干预。</li>\n</ol><p><img src=\"https://static001.geekbang.org/resource/image/e1/a5/e1f3b37610e3ebec43dea050779a86a5.jpg?wh=4192x736\" alt=\"\"></p><ol start=\"3\">\n<li>变更干预和处置：一旦发现异常就要快速阻断当前的变更，一般我们可以根据具体的情况采取不同的方式处理。如果是1个实例有问题，这个时候可以采用<strong>单实例摘除</strong>的方式进行；如果一个可用区全量后发现问题就可以进行<strong>快速切流</strong>；如果所有服务都完成上线了，这个时候就只能<strong>回滚</strong>了。</li>\n</ol><p><img src=\"https://static001.geekbang.org/resource/image/b6/yy/b6454a43cbc7bb01600f300b8f1a8fyy.jpg?wh=4192x736\" alt=\"\"></p><h4>变更后：检查</h4><p>变更后的检查环节常常被忽视，但它对于确保变更成功至关重要。在进行变更后的检查时，应关注几个关键指标。</p><ul>\n<li><strong>自身服务状态指标</strong>：这些通常是最容易监控的指标，包括调用成功率、响应延迟和CPU等待时间等，它们直接反映了服务的健康状况。</li>\n<li><strong>业务核心指标</strong>：有时服务变更可能在内部运行正常，但却影响到其他依赖服务。例如，一个接口的数据格式变更，可能导致依赖该接口的服务出现问题，从而引发整体业务指标的波动。曾有一个案例，服务端返回格式的错误导致客户端服务崩溃，造成了严重故障。</li>\n<li><strong>上下游关键指标</strong>：包括调用频率、延迟以及核心功能的性能指标。上游服务的变更可能会增加下游服务的流量，有可能导致下游服务超载。比如曾经有新增功能未及时通知下游服务，导致流量激增4到5倍的事情发生。由于变更是在低峰期进行的，下游服务未能立即察觉到变化，结果在晚高峰时段出现了容量不足的问题。</li>\n</ul><h2>工具和平台层面</h2><p>如果想要更全面地防范变更引发的故障，我们还需要借助一些工具，比如自动阻断和智能checker。</p><h3><strong>自动阻断</strong></h3><p>自动阻断系统的设计旨在实时监控发布过程，并在检测到异常时自动暂停操作。这种方法能够在问题发生的早期阶段进行干预，有效降低了生产环境中大规模故障发生的风险。自动阻断常见的就是对通用性能指标进行监控，一旦这些指标出现异常，系统便会自动触发暂停变更的机制。这些指标包括但不限于调用失败率、CPU使用率、P99延迟、实例存活数以及core文件的数量等。</p><p>不过自动阻断只能应对通用指标的监控需求，但对于特定指标的监控显得力不从心了。这时候就需要用到智能checker了。</p><h3></h3><h3>智能checker</h3><p>智能checker可以处理大规模且具有个性化特征的指标检测问题，是自动阻断系统的补充。</p><p>例如，在网盘服务中，有的服务侧重于上传性能的监控，而另一些则关注下载性能。对于上下游服务的监控也同样如此，每个服务的依赖关系和业务模式都不相同，通用的监控策略不太合适，这样我们需要检查的指标就很多了，可能会涉及几百上千个。</p><p>完全依靠人工检查这些指标显然是不现实的，因此必须借助智能checker技术。然而，智能checker也有局限性，它需要大量的计算资源和复杂的服务模型来支持。如何在这两者之间找到平衡点，以及如何进行资源的合理分配和优化，你可以先想一想，我们后面会在具体的案例中继续讨论。</p><h2>小结</h2><p>这节课，我们详细探讨了如何进行变更管理，特别是变更可能引发的线上问题及其成因。变更故障产生的原因主要有主观和客观两个层面。针对这两种不同层面的问题，我们提出了相应的解决策略：对于主观层面的问题，我们通过建立有效的机制进行管理；而对于客观层面的问题，则通过优化发布流程、采用合适的工具和平台来解决。</p><p>我把这些内容总结成了一张表格，你可以通过这个表格来对照和评估你的变更策略，确保变更过程顺利进行。</p><p><img src=\"https://static001.geekbang.org/resource/image/3a/0c/3a1e9d3c239yy04fa53efa30f9d6b10c.png?wh=1980x1424\" alt=\"图片\"></p><p>至于怎么把这些变更策略应用到实践中，后面的场景篇中我会结合具体的案例来深入探讨。这里有一些业界比较好的变更方案，有兴趣的话你可以点进去看看。</p><ul>\n<li><a href=\"https://developer.baidu.com/article/detail.html?id=290230\">百度变更实践</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s?__biz=Mzg3Njc0NTgwMg==&mid=2247498123&idx=1&sn=cf31cfe246204797133a4b02cd01276a&chksm=cf2f3caef858b5b83d28fffe16764999d8d349b87c57f64ab54bb773e8ca3024b1c9a074de8a&exptype=timeline_recommend_article_extendread_samebiz&scene=21#wechat_redirect\">万字长文谈 B 站变更管控体系设计与实践</a></li>\n</ul><h2><strong>思考题</strong></h2><p>如果在上线的过程中，你的系统出现了故障，这个时候是优先切流止损还是优先选择回滚呢？ 欢迎你把你的想法分享到评论区，和我一起讨论，如果你觉得这节课的内容对你有帮助的话，也欢迎你把这节课的内容分享给其他朋友，我们下节课再见！</p>","neighbors":{"left":{"article_title":"02｜ 容量：从业务视角看容量到底是什么？","id":793332},"right":{"article_title":"04｜预案：预案的三板斧指的是什么？","id":794975}},"comments":[{"had_liked":false,"id":392958,"user_name":"takumi","can_delete":false,"product_type":"c1","uid":1439928,"ip_address":"江西","ucode":"780B10D8BEBDA6","user_header":"https://static001.geekbang.org/account/avatar/00/15/f8/b8/0398768b.jpg","comment_is_top":false,"comment_ctime":1722321186,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100781001,"comment_content":"先止损，把影响降到最低，然后在回滚，至少保证服务可用性不会中断太久","like_count":1},{"had_liked":false,"id":393031,"user_name":"书豪","can_delete":false,"product_type":"c1","uid":1337725,"ip_address":"北京","ucode":"CBC75BC712B915","user_header":"https://static001.geekbang.org/account/avatar/00/14/69/7d/59143808.jpg","comment_is_top":false,"comment_ctime":1722526028,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100781001,"comment_content":"单实例阶段回滚，单机房阶段切流，全流量阶段回滚","like_count":0},{"had_liked":false,"id":392776,"user_name":"枕畔雪","can_delete":false,"product_type":"c1","uid":1258675,"ip_address":"北京","ucode":"F2932722CB7CC4","user_header":"https://static001.geekbang.org/account/avatar/00/13/34/b3/cf70e0f5.jpg","comment_is_top":false,"comment_ctime":1721735682,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100781001,"comment_content":"哪个手段生效快用哪个。一般情况故障发现后这两个手段一起上。","like_count":0}]}