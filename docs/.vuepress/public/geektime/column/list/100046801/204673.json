{"id":204673,"title":"01 | 创建和更新订单时，如何保证数据准确无误？","content":"<p>你好，我是李玥。</p><p>订单系统是整个电商系统中最重要的一个子系统，订单数据也就是电商企业最重要的数据资产。今天这节课，我来和你说一下，在设计和实现一个订单系统的存储过程中，有哪些问题是要特别考虑的。</p><p>一个合格的订单系统，最基本的要求是什么？<strong>数据不能错。</strong></p><p>一个购物流程，从下单开始、支付、发货，直到收货，这么长的一个流程中，每一个环节，都少不了更新订单数据，每一次更新操作又需要同时更新好几张表。这些操作可能被随机分布到很多台服务器上执行，服务器有可能故障，网络有可能出问题。</p><p>在这么复杂的情况下，保证订单数据一笔都不能错，是不是很难？实际上，只要掌握了方法，其实并不难。</p><ul>\n<li>首先，你的代码必须是正确没Bug的，如果说是因为代码Bug导致的数据错误，那谁也救不了你。</li>\n<li>然后，你要会正确地使用数据库的事务。比如，你在创建订单的时候，同时要在订单表和订单商品表中插入数据，那这些插入数据的INSERT必须在一个数据库事务中执行，数据库的事务可以确保：执行这些INSERT语句，要么一起都成功，要么一起都失败。</li>\n</ul><p>我相信这些“基本操作”对于你来说，应该不是问题。</p><p>但是，还有一些情况下会引起数据错误，我们一起来看一下。不过在此之前，我们要明白，对于一个订单系统而言，它的核心功能和数据结构是怎样的。</p><!-- [[[read_end]]] --><p>因为，任何一个电商，它的订单系统的功能都是独一无二的，基于它的业务，有非常多的功能，并且都很复杂。我们在讨论订单系统的存储问题时，必须得化繁为简，只聚焦那些最核心的、共通的业务和功能上，并且以这个为基础来讨论存储技术问题。</p><h2>订单系统的核心功能和数据</h2><p>我先和你简单梳理一下一个订单系统必备的功能，它包含但远远不限于：</p><ol>\n<li>创建订单；</li>\n<li>随着购物流程更新订单状态；</li>\n<li>查询订单，包括用订单数据生成各种报表。</li>\n</ol><p>为了支撑这些必备功能，在数据库中，我们至少需要有这样几张表：</p><ol>\n<li>订单主表：也叫订单表，保存订单的基本信息。</li>\n<li>订单商品表：保存订单中的商品信息。</li>\n<li>订单支付表：保存订单的支付和退款信息。</li>\n<li>订单优惠表：保存订单使用的所有优惠信息。</li>\n</ol><p>这几个表之间的关系是这样的：订单主表和后面的几个子表都是一对多的关系，关联的外键就是订单主表的主键，也就是订单号。</p><p>绝大部分订单系统它的核心功能和数据结构都是这样的。</p><h2>如何避免重复下单？</h2><p>接下来我们来看一个场景。一个订单系统，提供创建订单的HTTP接口，用户在浏览器页面上点击“提交订单”按钮的时候，浏览器就会给订单系统发一个创建订单的请求，订单系统的后端服务，在收到请求之后，往数据库的订单表插入一条订单数据，创建订单成功。</p><p>假如说，用户点击“创建订单”的按钮时手一抖，点了两下，浏览器发了两个HTTP请求，结果是什么？创建了两条一模一样的订单。这样肯定不行，需要做防重。</p><p>有的同学会说，前端页面上应该防止用户重复提交表单，你说的没错。但是，网络错误会导致重传，很多RPC框架、网关都会有自动重试机制，所以对于订单服务来说，重复请求这个事儿，你是没办法完全避免的。</p><p>解决办法是，<strong>让你的订单服务具备幂等性。</strong>什么是幂等呢？一个幂等操作的特点是，其任意多次执行所产生的影响均与一次执行的影响相同。也就是说，一个幂等的方法，使用同样的参数，对它进行调用多次和调用一次，对系统产生的影响是一样的。所以，对于幂等的方法，不用担心重复执行会对系统造成任何改变。一个幂等的创建订单服务，无论创建订单的请求发送多少次，正确的结果是，数据库只有一条新创建的订单记录。</p><p>这里面有一个不太好解决的问题：对于订单服务来说，它怎么知道发过来的创建订单请求是不是重复请求呢？</p><p>在插入订单数据之前，先查询一下订单表里面有没有重复的订单，行不行？不太行，因为你很难用SQL的条件来定义“重复的订单”，订单用户一样、商品一样、价格一样，就认为是重复订单么？不一定，万一用户就是连续下了两个一模一样的订单呢？所以这个方法说起来容易，实际上很难实现。</p><p>很多电商解决这个问题的思路是这样的。在数据库的最佳实践中有一条就是，数据库的每个表都要有主键，绝大部分数据表都遵循这个最佳实践。一般来说，我们在往数据库插入一条记录的时候，都不提供主键，由数据库在插入的同时自动生成一个主键。这样重复的请求就会导致插入重复数据。</p><p>我们知道，表的主键自带唯一约束，如果我们在一条INSERT语句中提供了主键，并且这个主键的值在表中已经存在，那这条INSERT会执行失败，数据也不会被写入表中。<strong>我们可以利用数据库的这种“主键唯一约束”特性，在插入数据的时候带上主键，来解决创建订单服务的幂等性问题。</strong></p><p>具体的做法是这样的，我们给订单系统增加一个“生成订单号”的服务，这个服务没有参数，返回值就是一个新的、全局唯一的订单号。在用户进入创建订单的页面时，前端页面先调用这个生成订单号服务得到一个订单号，在用户提交订单的时候，在创建订单的请求中带着这个订单号。</p><p>这个订单号也是我们订单表的主键，这样，无论是用户手抖，还是各种情况导致的重试，这些重复请求中带的都是同一个订单号。订单服务在订单表中插入数据的时候，执行的这些重复INSERT语句中的主键，也都是同一个订单号。数据库的唯一约束就可以保证，只有一次INSERT语句是执行成功的，这样就实现了创建订单服务幂等性。</p><p>为了便于你理解，我把上面这个幂等创建订单的流程，绘制成了时序图供你参考：</p><p><img src=\"https://static001.geekbang.org/resource/image/66/17/667089ecbfdf18733c83c3d07783fa17.jpg?wh=765*571\" alt=\"\"></p><p>还有一点需要注意的是，如果是因为重复订单导致插入订单表失败，订单服务不要把这个错误返回给前端页面。否则，就有可能出现这样的情况：用户点击创建订单按钮后，页面提示创建订单失败，而实际上订单却创建成功了。正确的做法是，遇到这种情况，订单服务直接返回订单创建成功就可以了。</p><h2>如何解决ABA问题？</h2><p>同样，订单系统各种更新订单的服务一样也要具备幂等性。</p><p>这些更新订单服务，比如说支付、发货等等这些步骤中的更新订单操作，最终落到订单库上，都是对订单主表的UPDATE操作。数据库的更新操作，本身就具备天然的幂等性，比如说，你把订单状态，从未支付更新成已支付，执行一次和重复执行多次，订单状态都是已支付，不用我们做任何额外的逻辑，这就是天然幂等。</p><p>那在实现这些更新订单服务时，还有什么问题需要特别注意的吗？还真有，在并发环境下，你需要注意ABA问题。</p><p>什么是ABA问题呢？我举个例子你就明白了。比如说，订单支付之后，小二要发货，发货完成后要填个快递单号。假设说，小二填了一个单号666，刚填完，发现填错了，赶紧再修改成888。对订单服务来说，这就是2个更新订单的请求。</p><p>正常情况下，订单中的快递单号会先更新成666，再更新成888，这是没问题的。那不正常情况呢？666请求到了，单号更新成666，然后888请求到了，单号又更新成888，但是666更新成功的响应丢了，调用方没收到成功响应，自动重试，再次发起666请求，单号又被更新成666了，这数据显然就错了。这就是非常有名的ABA问题。</p><p>具体的时序你可以参考下面这张时序图：</p><p><img src=\"https://static001.geekbang.org/resource/image/60/f5/6007b4d5a6e804e755e91c5f1d3cd2f5.jpg?wh=778*611\" alt=\"\"></p><p>ABA问题怎么解决？这里给你提供一个比较通用的解决方法。给你的订单主表增加一列，列名可以叫version，也即是“版本号”的意思。每次查询订单的时候，版本号需要随着订单数据返回给页面。页面在更新数据的请求中，需要把这个版本号作为更新请求的参数，再带回给订单更新服务。</p><p>订单服务在更新数据的时候，需要比较订单当前数据的版本号，是否和消息中的版本号一致，如果不一致就拒绝更新数据。如果版本号一致，还需要再更新数据的同时，把版本号+1。“比较版本号、更新数据和版本号+1”，这个过程必须在同一个事务里面执行。</p><p>具体的SQL可以这样来写：</p><pre><code>UPDATE orders set tracking_number = 666, version = version + 1\nWHERE version = 8;\n</code></pre><p>在这条SQL的WHERE条件中，version的值需要页面在更新的时候通过请求传进来。</p><p>通过这个版本号，就可以保证，从我打开这条订单记录开始，一直到我更新这条订单记录成功，这个期间没有其他人修改过这条订单数据。因为，如果有其他人修改过，数据库中的版本号就会改变，那我的更新操作就不会执行成功。我只能重新查询新版本的订单数据，然后再尝试更新。</p><p>有了这个版本号，再回头看一下我们上面那个ABA问题的例子，会出现什么结果？可能出现两种情况：</p><ol>\n<li>第一种情况，把运单号更新为666的操作成功了，更新为888的请求带着旧版本号，那就会更新失败，页面提示用户更新888失败。</li>\n<li>第二种情况，666更新成功后，888带着新的版本号，888更新成功。这时候即使重试的666请求再来，因为它和上一条666请求带着相同的版本号，上一条请求更新成功后，这个版本号已经变了，所以重试请求的更新必然失败。</li>\n</ol><p>无论哪种情况，数据库中的数据与页面上给用户的反馈都是一致的。这样就可以实现幂等更新并且避免了ABA问题。下图展示的是第一种情况，第二种情况也是差不多的：</p><p><img src=\"https://static001.geekbang.org/resource/image/02/a5/02497bcdaf0e37a7e6f92d180a4c38a5.jpg?wh=918*637\" alt=\"\"></p><h2>小结</h2><p>我们把今天这节课的内容做一个总结。今天这节课，实际上就讲了一个事儿，也就是，实现订单操作的幂等的方法。</p><p>因为网络、服务器等等这些不确定的因素，重试请求是普遍存在并且不可避免的。具有幂等性的服务可以完美地克服重试导致的数据错误。</p><p>对于创建订单服务来说，可以通过预先生成订单号，然后利用数据库中订单号的唯一约束这个特性，避免重复写入订单，实现创建订单服务的幂等性。对于更新订单服务，可以通过一个版本号机制，每次更新数据前校验版本号，更新数据同时自增版本号，这样的方式，来解决ABA问题，确保更新订单服务的幂等性。</p><p>通过这样两种幂等的实现方法，就可以保证，无论请求是不是重复，订单表中的数据都是正确的。当然，上面讲到的实现订单幂等的方法，你完全可以套用在其他需要实现幂等的服务中，只需要这个服务操作的数据保存在数据库中，并且有一张带有主键的数据表就可以了。</p><h2>思考题</h2><p>实现服务幂等的方法，远不止我们这节课上介绍的这两种，课后请你想一下，在你负责开发的业务系统中，能不能用这节课中讲到的方法来实现幂等？除了这两种方法以外，还有哪些实现服务幂等的方法？欢迎你在留言区与我交流互动。</p><p>感谢你的阅读，如果你觉得今天的内容对你有所帮助，也欢迎把它分享给你的朋友。</p>","neighbors":{"left":{"article_title":"课前加餐 | 电商系统是如何设计的？","id":204667},"right":{"article_title":"02 | 流量大、数据多的商品详情页系统该如何设计？","id":204688}},"comments":[{"had_liked":false,"id":182114,"user_name":"李玥","can_delete":false,"product_type":"c1","uid":1501046,"ip_address":"","ucode":"B19E91EE248591","user_header":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","comment_is_top":true,"comment_ctime":1582711316,"is_pvip":false,"discussion_count":6,"race_medal":0,"score":"9.2233723047254999e+18","product_id":100046801,"comment_content":"hello，我是李玥。之后我都会在留言板上同步上节课思考题的答案，欢迎你跟我一起学习讨论。<br><br>在课前加餐这节课里，我给你留了道思考题，让你作为公司的CTO，想一想上节课我们提到的电商系统，它的技术选型应该是什么样的？<br><br>关于这个问题，我是这么理解的。<br><br>技术选型本身没有好与坏，更多的是选择“合适”的技术。对于编程语言和技术栈的选择，我认为需要从两方面考虑，一方面就是团队的人员配置，尽量选择大家熟悉的技术，第二个方面就是要考察选择的技术它的生态是不是够完善。这两个原则在选择编程语言、技术栈、云服务和存储的时候都是适用的。<br><br>如何根据业务来选择合适的存储系统，这是个很大的话题，我会在后面的课程中陆续穿插的来和你讲，什么场景下应该选择什么样的存储，敬请期待。","like_count":62,"discussions":[{"author":{"id":1615539,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI6LXcIqb5K48nia8d4zmdsD1M9AZeyXoGrLzX5xvqfN0fqXOsYKUWLbZvZ8TtJCXWmYbCkCXg93dQ/132","nickname":"漏脚脖","note":"","ucode":"214AE52EC201E6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":187785,"discussion_content":"同学们，注意头像","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1582768384,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1306032,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJcxSpNMqwqyicMvdOSr9ic0p1ABiauHnv7g7YQVSJuoHPoQbYDu3YzdpgmSAk2KricUBQ5yibWBWIq75w/132","nickname":"桂城老托尼","note":"","ucode":"139E4B8EE88B79","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":211410,"discussion_content":"给负责任的导师手动点个赞，路转粉了。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1584848363,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2912918,"avatar":"","nickname":"Geek_284c06","note":"","ucode":"4BD6D4449D4F1A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576976,"discussion_content":"为什么上面说的那个解决办法，我觉得还是有漏洞","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655873444,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1282639,"avatar":"https://static001.geekbang.org/account/avatar/00/13/92/4f/ff04156a.jpg","nickname":"天天向上","note":"","ucode":"D0914D4FD82272","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":197510,"discussion_content":"期待跟完全部课程","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583421370,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1301113,"avatar":"https://static001.geekbang.org/account/avatar/00/13/da/79/9b093890.jpg","nickname":"大秦皇朝","note":"","ucode":"0F72D0D2FAEAF2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":195968,"discussion_content":"李玥老师的课不错，都是第一时间购买，就跟我在京东消费一样哈哈哈哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583325231,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1301113,"avatar":"https://static001.geekbang.org/account/avatar/00/13/da/79/9b093890.jpg","nickname":"大秦皇朝","note":"","ucode":"0F72D0D2FAEAF2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":195966,"discussion_content":"哈哈哈，还是课程的宣传照帅","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583325145,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":184684,"user_name":"Panmax","can_delete":false,"product_type":"c1","uid":1004871,"ip_address":"","ucode":"9D65E3B84C5519","user_header":"https://static001.geekbang.org/account/avatar/00/0f/55/47/d217c45f.jpg","comment_is_top":false,"comment_ctime":1583381656,"is_pvip":false,"discussion_count":15,"race_medal":0,"score":"443965013144","product_id":100046801,"comment_content":"课程中给的那个 SQL 语句很危险啊😂，where 条件丢掉了最重要的订单ID。应该改为：<br><br>UPDATE orders set tracking_number = 666, version = version + 1<br>WHERE id = 12345 and version = 8;","like_count":103,"discussions":[{"author":{"id":1357944,"avatar":"https://static001.geekbang.org/account/avatar/00/14/b8/78/2828195b.jpg","nickname":"隰有荷","note":"","ucode":"2BE9A32AB28963","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":310958,"discussion_content":"不用怕，全表只有一个订单，不要问为什么，问就是生意不好🤣","likes_number":31,"is_delete":false,"is_hidden":false,"ctime":1602153055,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2108657,"avatar":"","nickname":"罗强","note":"","ucode":"B70DFE92A11B78","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":299329,"discussion_content":"太耿直了，人家只是示例说明解决ABA的办法，没必要这么扣","likes_number":7,"is_delete":false,"is_hidden":false,"ctime":1597659522,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1310518,"avatar":"https://static001.geekbang.org/account/avatar/00/13/ff/36/83281758.jpg","nickname":"L","note":"","ucode":"C18B98D3DC3387","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2108657,"avatar":"","nickname":"罗强","note":"","ucode":"B70DFE92A11B78","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":306172,"discussion_content":"做技术的，就是要抠细节","likes_number":15,"is_delete":false,"is_hidden":false,"ctime":1600190409,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":299329,"ip_address":""},"score":306172,"extra":""},{"author":{"id":1058015,"avatar":"https://static001.geekbang.org/account/avatar/00/10/24/df/645f8087.jpg","nickname":"Yayu","note":"","ucode":"5E7842458D8229","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2108657,"avatar":"","nickname":"罗强","note":"","ucode":"B70DFE92A11B78","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":325060,"discussion_content":"有必要","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1605230058,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":299329,"ip_address":""},"score":325060,"extra":""}]},{"author":{"id":1447887,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIofiaCAziajdQnbvrfpEkpCKVFgO62y6zicamhjF1BAWZSRcCVaTBXLIerLsGeZCic7XS7KOEkTN4fRg/132","nickname":"zahi","note":"","ucode":"F64ABEB63C6D1F","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":558446,"discussion_content":"这么细致的话，应该再加上limit 1…","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1648302619,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1102126,"avatar":"https://static001.geekbang.org/account/avatar/00/10/d1/2e/ad6315ab.jpg","nickname":"聂士伟","note":"","ucode":"C1624B259BB34E","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":376587,"discussion_content":"更新字段时可以直接写version=9","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1622203029,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":3,"child_discussions":[{"author":{"id":2204165,"avatar":"https://static001.geekbang.org/account/avatar/00/21/a2/05/302e0d0b.jpg","nickname":"烁","note":"","ucode":"802E56344B7C22","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1102126,"avatar":"https://static001.geekbang.org/account/avatar/00/10/d1/2e/ad6315ab.jpg","nickname":"聂士伟","note":"","ucode":"C1624B259BB34E","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":397547,"discussion_content":"你需要重新听一遍。。。","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1632638215,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":376587,"ip_address":""},"score":397547,"extra":""},{"author":{"id":2891918,"avatar":"","nickname":"黄欢","note":"","ucode":"9E244E76A908EE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1102126,"avatar":"https://static001.geekbang.org/account/avatar/00/10/d1/2e/ad6315ab.jpg","nickname":"聂士伟","note":"","ucode":"C1624B259BB34E","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":552453,"discussion_content":"同学，有必要再听一遍","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1645461864,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":376587,"ip_address":""},"score":552453,"extra":""},{"author":{"id":1075795,"avatar":"https://static001.geekbang.org/account/avatar/00/10/6a/53/88d74e0a.jpg","nickname":"楷罡行逸","note":"","ucode":"95313517094540","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2204165,"avatar":"https://static001.geekbang.org/account/avatar/00/21/a2/05/302e0d0b.jpg","nickname":"烁","note":"","ucode":"802E56344B7C22","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":554660,"discussion_content":"查询条件等于 8 的时候确实可以直接等于 9","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1646539051,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":397547,"ip_address":""},"score":554660,"extra":""}]},{"author":{"id":2956682,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/rvQxUmekECjyZu1RwbUguBWpBcQuKywQPtiaxNVFJSib07QMZnNUr8MnRF3RYEsn6MhgGFJibwlrVomibEicYMiaia7ZQ/132","nickname":"Geek_a8ce05","note":"","ucode":"C1D4002C48568F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":559808,"discussion_content":"哈哈，严重事故","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1648981326,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1135948,"avatar":"https://static001.geekbang.org/account/avatar/00/11/55/4c/df7ff549.jpg","nickname":"星星","note":"","ucode":"206B5063D53B01","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":374496,"discussion_content":"必须赞一个，很严谨","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621216588,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2291767,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLWA1zUQkKWzjnOmeCtZKN1s7X8qrp81ZEyYPsStot84pW0fgE5etMeNmbUdwxTicjmbWOXZxf9EFw/132","nickname":"Geek_128543","note":"","ucode":"09E3391C057CC1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":321938,"discussion_content":"6666","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604652021,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1435733,"avatar":"https://static001.geekbang.org/account/avatar/00/15/e8/55/92f82281.jpg","nickname":"MClink","note":"","ucode":"F479190923355C","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":282057,"discussion_content":"哈哈哈哈，来个全表更新吧！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591875023,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1160644,"avatar":"https://static001.geekbang.org/account/avatar/00/11/b5/c4/9148b40d.jpg","nickname":"SunshineBoy","note":"","ucode":"FC54CD1815CCBA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":273742,"discussion_content":"可以 哥们儿","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590495603,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1306032,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJcxSpNMqwqyicMvdOSr9ic0p1ABiauHnv7g7YQVSJuoHPoQbYDu3YzdpgmSAk2KricUBQ5yibWBWIq75w/132","nickname":"桂城老托尼","note":"","ucode":"139E4B8EE88B79","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":211469,"discussion_content":"很细心，哥们儿","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584854324,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":182140,"user_name":"川杰","can_delete":false,"product_type":"c1","uid":1099750,"ip_address":"","ucode":"815211E1D698E6","user_header":"https://static001.geekbang.org/account/avatar/00/10/c7/e6/11f21cb4.jpg","comment_is_top":false,"comment_ctime":1582717789,"is_pvip":false,"replies":[{"id":"70578","content":"如果单纯是生成GUID（全局唯一ID）方法有很多，比如小规模系统完全可以用MySQL的Sequence或者Redis来生成。大规模系统也可以采用类似雪花算法之类的方式分布式生成GUID。<br><br>但是订单号这个东西又有点儿特殊要求，比如在订单号中最好包含一些品类、时间等信息，便于业务处理，再比如，订单号它不能是一个单纯自增的ID，否则别人很容易根据订单号计算出你大致的销量，所以订单号的生产算法在保证不重复的前提下，一般都会加入很多业务规则在里面，这个每家都不一样，算是商业秘密吧。","user_name":"作者回复","comment_id":182140,"uid":"1501046","ip_address":"","utype":1,"ctime":1582771925,"user_name_real":"李玥"}],"discussion_count":19,"race_medal":0,"score":"254985788253","product_id":100046801,"comment_content":"请问，生成订单号 服务的一般逻辑会是怎样的？思来想去，如果要想这个ID全局唯一，只能带上时间，可是如果带上时间，像那种，不小心点了两次按钮的情况，必然是两个不同的订单号；请问这个问题怎么解决？","like_count":59,"discussions":[{"author":{"id":1311032,"avatar":"https://static001.geekbang.org/account/avatar/00/14/01/38/104b96a3.jpg","nickname":"谭伟","note":"","ucode":"AEC724819A2773","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":186918,"discussion_content":"注意这个生成订单号的时机，是在进入订单页面，而不是提交订单的时候。","likes_number":25,"is_delete":false,"is_hidden":false,"ctime":1582720870,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1099750,"avatar":"https://static001.geekbang.org/account/avatar/00/10/c7/e6/11f21cb4.jpg","nickname":"川杰","note":"","ucode":"815211E1D698E6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1311032,"avatar":"https://static001.geekbang.org/account/avatar/00/14/01/38/104b96a3.jpg","nickname":"谭伟","note":"","ucode":"AEC724819A2773","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":187429,"discussion_content":"谢谢你的回复","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1582731252,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":186918,"ip_address":""},"score":187429,"extra":""}]},{"author":{"id":1112183,"avatar":"https://static001.geekbang.org/account/avatar/00/10/f8/77/a6d34ca5.jpg","nickname":"jackie","note":"","ucode":"01A4B7839CFABD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":187010,"discussion_content":"进入提交订单页面的时候获取订单号，即使这个时候获取了两次不一样的订单号，在提交订单的时候，这个订单号会是固定的值，多次提交订单，订单号也不会改变","likes_number":10,"is_delete":false,"is_hidden":false,"ctime":1582723910,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":3,"child_discussions":[{"author":{"id":1099750,"avatar":"https://static001.geekbang.org/account/avatar/00/10/c7/e6/11f21cb4.jpg","nickname":"川杰","note":"","ucode":"815211E1D698E6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1112183,"avatar":"https://static001.geekbang.org/account/avatar/00/10/f8/77/a6d34ca5.jpg","nickname":"jackie","note":"","ucode":"01A4B7839CFABD","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":187431,"discussion_content":"谢谢你的回复","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582731271,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":187010,"ip_address":""},"score":187431,"extra":""},{"author":{"id":1036370,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/d0/52/014accaf.jpg","nickname":"划过天空阿忠","note":"","ucode":"9D9BEE73031E40","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1112183,"avatar":"https://static001.geekbang.org/account/avatar/00/10/f8/77/a6d34ca5.jpg","nickname":"jackie","note":"","ucode":"01A4B7839CFABD","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":208810,"discussion_content":"手一抖，生成多个订单？ 不妥呀","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584581788,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":187010,"ip_address":""},"score":208810,"extra":""},{"author":{"id":1112183,"avatar":"https://static001.geekbang.org/account/avatar/00/10/f8/77/a6d34ca5.jpg","nickname":"jackie","note":"","ucode":"01A4B7839CFABD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1036370,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/d0/52/014accaf.jpg","nickname":"划过天空阿忠","note":"","ucode":"9D9BEE73031E40","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":222346,"discussion_content":"幂等啊~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586137697,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":208810,"ip_address":""},"score":222346,"extra":""}]},{"author":{"id":1508990,"avatar":"https://static001.geekbang.org/account/avatar/00/17/06/7e/735968e2.jpg","nickname":"西门吹牛","note":"","ucode":"E5D3624DDE1E83","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":282600,"discussion_content":"点击俩次的操作，是在拿到订单号的基础上，应该不涉及你说的会生成俩个订单号，先拿到订单号，才会展示提交按钮","likes_number":7,"is_delete":false,"is_hidden":false,"ctime":1592025217,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1638878,"avatar":"https://static001.geekbang.org/account/avatar/00/19/01/de/bf524817.jpg","nickname":"慌张而黑糖","note":"","ucode":"B4416885A301C8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":186917,"discussion_content":"我感觉这个订单号应该是不变的，订单号应该在进入提交订单页面时生成的，而不是说在每次点击按钮时生成订单号，这是我的理解","likes_number":6,"is_delete":false,"is_hidden":false,"ctime":1582720854,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1099750,"avatar":"https://static001.geekbang.org/account/avatar/00/10/c7/e6/11f21cb4.jpg","nickname":"川杰","note":"","ucode":"815211E1D698E6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1638878,"avatar":"https://static001.geekbang.org/account/avatar/00/19/01/de/bf524817.jpg","nickname":"慌张而黑糖","note":"","ucode":"B4416885A301C8","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":187432,"discussion_content":"谢谢你的回复","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582731279,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":186917,"ip_address":""},"score":187432,"extra":""}]},{"author":{"id":1014680,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/7b/98/8f1aecf4.jpg","nickname":"楼下小黑哥","note":"","ucode":"453B099B0EE52E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":186910,"discussion_content":"可以基于 ZK，Redis，数据库，开发一个ID生成服务，自定义ID 生成规则。可以参考这篇文章：https://juejin.im/post/5e48a9af6fb9a07cc200c203","likes_number":6,"is_delete":false,"is_hidden":false,"ctime":1582720540,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1099750,"avatar":"https://static001.geekbang.org/account/avatar/00/10/c7/e6/11f21cb4.jpg","nickname":"川杰","note":"","ucode":"815211E1D698E6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1014680,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/7b/98/8f1aecf4.jpg","nickname":"楼下小黑哥","note":"","ucode":"453B099B0EE52E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":187433,"discussion_content":"谢谢你的回复","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582731286,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":186910,"ip_address":""},"score":187433,"extra":""}]},{"author":{"id":1886331,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/c8/7b/153181d7.jpg","nickname":"夜辉","note":"","ucode":"9421385F51FF9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":365688,"discussion_content":"并不会真正的删除订单，只会改变订单的状态，\n因此创建订单时，数据库中已经包含了订单ID和相关信息\n提交订单根据订单ID更改对应的状态","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1617867691,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1905946,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/15/1a/fce31315.jpg","nickname":"Joy Rick","note":"","ucode":"EA42BD15FAF9BA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":221731,"discussion_content":"微服务中通常使用 sonyflake 来做 id 生成，可以参考https://github.com/sony/sonyflake ","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1586052239,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":485235,"discussion_content":"如果单纯是生成GUID（全局唯一ID）方法有很多，比如小规模系统完全可以用MySQL的Sequence或者Redis来生成。大规模系统也可以采用类似雪花算法之类的方式分布式生成GUID。\n\n但是订单号这个东西又有点儿特殊要求，比如在订单号中最好包含一些品类、时间等信息，便于业务处理，再比如，订单号它不能是一个单纯自增的ID，否则别人很容易根据订单号计算出你大致的销量，所以订单号的生产算法在保证不重复的前提下，一般都会加入很多业务规则在里面，这个每家都不一样，算是商业秘密吧。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1582771925,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1306032,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJcxSpNMqwqyicMvdOSr9ic0p1ABiauHnv7g7YQVSJuoHPoQbYDu3YzdpgmSAk2KricUBQ5yibWBWIq75w/132","nickname":"桂城老托尼","note":"","ucode":"139E4B8EE88B79","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":211405,"discussion_content":"怎么生成的，作者已经回复了，全局sequnce+也许规则号段即可。\n第二个问题我看到时也有疑惑，仔细想了下，生成两个就两个呗，号段又不值钱，提交时候我用一个保持幂等就好了。 ","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1584848101,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1078280,"avatar":"https://static001.geekbang.org/account/avatar/00/10/74/08/aa2a9f36.jpg","nickname":"tomcat","note":"","ucode":"1929E1028414F6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546921,"discussion_content":"https://tech.meituan.com/2019/03/07/open-source-project-leaf.html","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642470745,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2035381,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/ibFY0KibR500MuU8PfyLZZP7c0UhnKEhXeymnfwbnkkic4U681PLBWehPKnHjl51Xj84o94cqHopiaxm6icJ1Sj7ibTQ/132","nickname":"Geek_QiFei","note":"","ucode":"6CBFD2417D1DC7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":411519,"discussion_content":"生成订单号是进入订单页面生成的  跟提交按钮没有关系","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635944555,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1357944,"avatar":"https://static001.geekbang.org/account/avatar/00/14/b8/78/2828195b.jpg","nickname":"隰有荷","note":"","ucode":"2BE9A32AB28963","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":310959,"discussion_content":"我比较倾向于用redis实现","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1602153164,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1811495,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/a4/27/15e75982.jpg","nickname":"小袁","note":"","ucode":"3F5D8721F577D9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":206877,"discussion_content":"隔壁林大神有说，例如将64位整数切成好几部分，包括时间、机房、业务、这一秒的偏移量等等。怎么切就看你了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584451712,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":182125,"user_name":"业余爱好者","can_delete":false,"product_type":"c1","uid":1482915,"ip_address":"","ucode":"A890935A982988","user_header":"https://static001.geekbang.org/account/avatar/00/16/a0/a3/8da99bb0.jpg","comment_is_top":false,"comment_ctime":1582713233,"is_pvip":false,"replies":[{"id":"70574","content":"这个思路非常好，并且可以适用很多的场景。<br><br>如果是超大规模的系统，可能用一个Redis实例来生成和验证这个GUID就忙不过来了，大家也可以想一下有没有什么性能上更好的方式？","user_name":"作者回复","comment_id":182125,"uid":"1501046","ip_address":"","utype":1,"ctime":1582768445,"user_name_real":"李玥"}],"discussion_count":26,"race_medal":0,"score":"220626045329","product_id":100046801,"comment_content":"每次请求之前必须先生成一个唯一的请求id,服务端将该id暂时放入redis。客户端请求时必须携带上这个id，借口会首先到redis中查询，如何有的话就继续后续的处理逻辑，同时删除该id,灭有的话就退出，返回不能重复请求的错误到客户端。<br><br>一句话总结：每次处理必须对应一个一次性的token。","like_count":51,"discussions":[{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":485228,"discussion_content":"这个思路非常好，并且可以适用很多的场景。\n\n如果是超大规模的系统，可能用一个Redis实例来生成和验证这个GUID就忙不过来了，大家也可以想一下有没有什么性能上更好的方式？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582768445,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1049208,"avatar":"https://static001.geekbang.org/account/avatar/00/10/02/78/23c56bce.jpg","nickname":"james","note":"","ucode":"5701899403917C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":251708,"discussion_content":"应该直接del 而不是exist 后del","likes_number":11,"is_delete":false,"is_hidden":false,"ctime":1588113593,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1306032,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJcxSpNMqwqyicMvdOSr9ic0p1ABiauHnv7g7YQVSJuoHPoQbYDu3YzdpgmSAk2KricUBQ5yibWBWIq75w/132","nickname":"桂城老托尼","note":"","ucode":"139E4B8EE88B79","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":211406,"discussion_content":"redis成功晋升公司最核心的组件，没有之一，单点风险略高，玩玩可以","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1584848226,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1010018,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/69/62/b874af21.jpg","nickname":"颛顼","note":"","ucode":"4A6139389C62EA","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":207127,"discussion_content":"高并发的情况下，多个请求可能都会查询到redis中有，从而存在问题，最简单的还是用mysql的唯一健，insert的时候先查，然后兜底是insert冲突","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1584460235,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1729060,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/62/24/07e2507c.jpg","nickname":"托尼斯威特","note":"","ucode":"98A1035527292E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1010018,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/69/62/b874af21.jpg","nickname":"颛顼","note":"","ucode":"4A6139389C62EA","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":284978,"discussion_content":"一楼james说的对， 直接del， 是原子的， del返回0说明已经被删除了。","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1592704295,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":207127,"ip_address":""},"score":284978,"extra":""},{"author":{"id":2032840,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/04/c8/3c7af100.jpg","nickname":"Javatar","note":"","ucode":"E216645CDF632C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1729060,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/62/24/07e2507c.jpg","nickname":"托尼斯威特","note":"","ucode":"98A1035527292E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":328681,"discussion_content":"没错，del后一定要检查返回结果","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606208601,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":284978,"ip_address":""},"score":328681,"extra":""}]},{"author":{"id":1003515,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/4f/fb/10366b97.jpg","nickname":"Henry","note":"","ucode":"54AFE9C99B31B4","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":190615,"discussion_content":"用 Redis 集群就可以了吧，数据可以分片放。","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1582966249,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1729060,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/62/24/07e2507c.jpg","nickname":"托尼斯威特","note":"","ucode":"98A1035527292E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1003515,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/4f/fb/10366b97.jpg","nickname":"Henry","note":"","ucode":"54AFE9C99B31B4","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":284980,"discussion_content":"👍 Key都不一样，方便水平扩展","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592704461,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":190615,"ip_address":""},"score":284980,"extra":""},{"author":{"id":1357944,"avatar":"https://static001.geekbang.org/account/avatar/00/14/b8/78/2828195b.jpg","nickname":"隰有荷","note":"","ucode":"2BE9A32AB28963","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1003515,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/4f/fb/10366b97.jpg","nickname":"Henry","note":"","ucode":"54AFE9C99B31B4","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":310960,"discussion_content":"和我用的方式一样","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1602153266,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":190615,"ip_address":""},"score":310960,"extra":""}]},{"author":{"id":1453182,"avatar":"https://static001.geekbang.org/account/avatar/00/16/2c/7e/f1efd18b.jpg","nickname":"摊牌","note":"","ucode":"F142596BFE4594","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":563068,"discussion_content":"那这个id生成的时机是何时","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649935106,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1132448,"avatar":"https://static001.geekbang.org/account/avatar/00/11/47/a0/f12115b7.jpg","nickname":"Sam.张朝","note":"","ucode":"FB20554D94B250","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":552854,"discussion_content":"生成I’d的服务也会成为性能瓶颈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1645614499,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2435535,"avatar":"https://static001.geekbang.org/account/avatar/00/25/29/cf/db5be02a.jpg","nickname":"漆黑的小白","note":"","ucode":"C8FF1577C6FBDC","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546756,"discussion_content":"业务量大有可能因为LRU过期导致丢数据","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642414155,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":3043130,"avatar":"https://static001.geekbang.org/account/avatar/00/2e/6f/3a/561c9aa9.jpg","nickname":"惊鸿","note":"","ucode":"648832D5CBA3FD","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":2435535,"avatar":"https://static001.geekbang.org/account/avatar/00/25/29/cf/db5be02a.jpg","nickname":"漆黑的小白","note":"","ucode":"C8FF1577C6FBDC","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":584325,"discussion_content":"设置不过期就可以","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660749044,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":546756,"ip_address":"浙江"},"score":584325,"extra":""}]},{"author":{"id":2035762,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/10/32/92b9f66f.jpg","nickname":"Sleepless","note":"","ucode":"F96607B4583928","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":385121,"discussion_content":"请问这个请求id是怎么生成的？前端自己的组件生成吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1626890390,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2707767,"avatar":"","nickname":"Geek_9dde75","note":"","ucode":"337E0342B8818F","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":2035762,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/10/32/92b9f66f.jpg","nickname":"Sleepless","note":"","ucode":"F96607B4583928","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":560277,"discussion_content":"创建订单之前会有一个确认订单的过程，id就是在这个时候向后端接口获取的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649247893,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":385121,"ip_address":""},"score":560277,"extra":""}]},{"author":{"id":1572356,"avatar":"https://static001.geekbang.org/account/avatar/00/17/fe/04/bb427e47.jpg","nickname":"码哥字节","note":"","ucode":"362103AD52C8E0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":380513,"discussion_content":"token 防止重复提交指的就是这个","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1624538914,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1080549,"avatar":"https://static001.geekbang.org/account/avatar/00/10/7c/e5/3dca2495.jpg","nickname":"上山的o牛","note":"","ucode":"5C5D1AC8563301","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":325442,"discussion_content":"请问这个请求id是哪方怎么生成的，什么时候给到前端和存到redis中","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605319894,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1729060,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/62/24/07e2507c.jpg","nickname":"托尼斯威特","note":"","ucode":"98A1035527292E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":284976,"discussion_content":"澄清一下，是不是这个意思？这个方法使用一次token来保证幂等， 这个Redis token 并不是订单id， 也不是主键。 订单id还是交由后端或数据库生成。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592704062,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":3,"child_discussions":[{"author":{"id":1482915,"avatar":"https://static001.geekbang.org/account/avatar/00/16/a0/a3/8da99bb0.jpg","nickname":"业余爱好者","note":"","ucode":"A890935A982988","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1729060,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/62/24/07e2507c.jpg","nickname":"托尼斯威特","note":"","ucode":"98A1035527292E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":284991,"discussion_content":"嗯，请求id","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592707632,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":284976,"ip_address":""},"score":284991,"extra":""},{"author":{"id":1475340,"avatar":"https://static001.geekbang.org/account/avatar/00/16/83/0c/b9e39db4.jpg","nickname":"韩俊臣","note":"","ucode":"D6A15C025570D5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1729060,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/62/24/07e2507c.jpg","nickname":"托尼斯威特","note":"","ucode":"98A1035527292E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":316940,"discussion_content":"订单id是在提交订单之前就生成好的，这样多次提交订单也不会插入同样数据，因为订单id是主键id","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603471722,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":284976,"ip_address":""},"score":316940,"extra":""},{"author":{"id":1475340,"avatar":"https://static001.geekbang.org/account/avatar/00/16/83/0c/b9e39db4.jpg","nickname":"韩俊臣","note":"","ucode":"D6A15C025570D5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1729060,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/62/24/07e2507c.jpg","nickname":"托尼斯威特","note":"","ucode":"98A1035527292E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":316941,"discussion_content":"业务场景是防止同样订单信息插入订单表，如果引入Redis，判断k在不在，如果在即删除需要是原子操作，需要用lua语言实现。显然增加系统复杂性","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603472054,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":284976,"ip_address":""},"score":316941,"extra":""}]},{"author":{"id":1433535,"avatar":"https://static001.geekbang.org/account/avatar/00/15/df/bf/96b50d1e.jpg","nickname":"😚 46","note":"","ucode":"EED0EBBBF80A43","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":244945,"discussion_content":"其实就是redis分布式锁吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587643272,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1691866,"avatar":"https://static001.geekbang.org/account/avatar/00/19/d0/da/ccf95fae.jpg","nickname":"风中追风","note":"","ucode":"17B7ADFE9DF20A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":241734,"discussion_content":"引入redis，是否要考虑架构带来的复杂性（可用、双写一致性）等","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587436399,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1158873,"avatar":"https://static001.geekbang.org/account/avatar/00/11/ae/d9/7a732188.jpg","nickname":"ROCKETsFORWARD","note":"","ucode":"D171E33E546FD2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":203003,"discussion_content":"高并发的情况下，多个请求可以同时访问到redis中存在的GUID，保证同步要用到分布式锁","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583982413,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1356990,"avatar":"https://static001.geekbang.org/account/avatar/00/14/b4/be/77e2313c.jpg","nickname":"梁天刚","note":"","ucode":"1F0257F3425855","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":201736,"discussion_content":"我觉得可以提前生成一批ID存到数据库备用","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583832960,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1541669,"avatar":"https://static001.geekbang.org/account/avatar/00/17/86/25/25ded6c3.jpg","nickname":"zhengyu.nie","note":"","ucode":"FFE0377D323E46","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1356990,"avatar":"https://static001.geekbang.org/account/avatar/00/14/b4/be/77e2313c.jpg","nickname":"梁天刚","note":"","ucode":"1F0257F3425855","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":568368,"discussion_content":"可以每次请求从sequence表里拿一组id，放到内存，用完了再拿。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1651115827,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":201736,"ip_address":""},"score":568368,"extra":""}]}]},{"had_liked":false,"id":185004,"user_name":"家庆","can_delete":false,"product_type":"c1","uid":1184982,"ip_address":"","ucode":"D77A489C78EF0D","user_header":"https://static001.geekbang.org/account/avatar/00/12/14/d6/e79204be.jpg","comment_is_top":false,"comment_ctime":1583464991,"is_pvip":false,"replies":[{"id":"71651","content":"有的同学已经在留言区给出了答案，那就是，在Redis里面缓存一下给出去的订单号，收到客户端请求的时候，先验证一下这个订单号在缓存中是否存在，就可以解决这个问题了。","user_name":"作者回复","comment_id":185004,"uid":"1501046","ip_address":"","utype":1,"ctime":1583636557,"user_name_real":"李玥"}],"discussion_count":5,"race_medal":0,"score":"134727451167","product_id":100046801,"comment_content":"李老师好，请问生成一个唯一订单号放在前端，如何保证客户绕过客户端直接发送请求恶意乱填订单号的问题，符合规则的订单号，而这个订单号有可能是后续系统生成的。","like_count":31,"discussions":[{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":486210,"discussion_content":"有的同学已经在留言区给出了答案，那就是，在Redis里面缓存一下给出去的订单号，收到客户端请求的时候，先验证一下这个订单号在缓存中是否存在，就可以解决这个问题了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583636557,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1729060,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/62/24/07e2507c.jpg","nickname":"托尼斯威特","note":"","ucode":"98A1035527292E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":284981,"discussion_content":"前端带token后端redis del， 已经可以实现幂等， 不用带订单号了","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1592704626,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1945605,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/b0/05/c9da834e.jpg","nickname":"小人物大希望","note":"","ucode":"8EF313AA26D4B8","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":228918,"discussion_content":"是不是也可以在创建订单号时，加一些特殊的规则，比如说订单号后X位由用户IP，商品ID等信息算出。创建订单的时候，对订单号进行校验？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1586589865,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2297346,"avatar":"https://static001.geekbang.org/account/avatar/00/23/0e/02/41099234.jpg","nickname":"Django...","note":"","ucode":"56693F8A886FF0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1945605,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/b0/05/c9da834e.jpg","nickname":"小人物大希望","note":"","ucode":"8EF313AA26D4B8","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":366949,"discussion_content":"是个思路；如果订单号最后是以用户id结尾，这样判断用户表就简单多了","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1618222968,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":228918,"ip_address":""},"score":366949,"extra":""}]},{"author":{"id":1520538,"avatar":"https://static001.geekbang.org/account/avatar/00/17/33/9a/f295dea5.jpg","nickname":"李正g","note":"","ucode":"A7BEA03BB6537A","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":579689,"discussion_content":"生单接口应该是放在内网的，有验签机制","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1657615562,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":182712,"user_name":"鸠摩智","can_delete":false,"product_type":"c1","uid":1106201,"ip_address":"","ucode":"853E584FC4CD64","user_header":"https://static001.geekbang.org/account/avatar/00/10/e1/19/c756aaed.jpg","comment_is_top":false,"comment_ctime":1582854487,"is_pvip":true,"replies":[{"id":"70684","content":"这确实是一个需要考虑的性能问题。<br><br>所以很多业务在设计订单号规则的时候都不是完全随机的，一般都是递增的。这种情况下，页分裂就不会特别严重。","user_name":"作者回复","comment_id":182712,"uid":"1501046","ip_address":"","utype":1,"ctime":1582860853,"user_name_real":"李玥"}],"discussion_count":13,"race_medal":0,"score":"126136906071","product_id":100046801,"comment_content":"老师，生成全局唯一订单号如果不是自增的，插入mysql innodb表的时候，底层的B+树索引是不是会发生页分裂等问题，影响插入性能？如果遇到大促，短时间生成大量订单，写入会成为瓶颈不？","like_count":29,"discussions":[{"author":{"id":1240401,"avatar":"","nickname":"fgdgtz","note":"","ucode":"486CC4ACCC015C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":210556,"discussion_content":"我觉的订单号设为唯一索引约束即可，仍然有个自增主键，订单号对外用，主键不暴露，这样表空间还是紧密的，其他关联订单表仍然以订单号作外键","likes_number":21,"is_delete":false,"is_hidden":false,"ctime":1584752519,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1138821,"avatar":"https://static001.geekbang.org/account/avatar/00/11/60/85/f72f1d94.jpg","nickname":"与路同飞","note":"","ucode":"2985F1440A1962","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1240401,"avatar":"","nickname":"fgdgtz","note":"","ucode":"486CC4ACCC015C","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":249938,"discussion_content":"是的，我们就是这样，还是有一个自增主键，订单号也是唯一索引约束","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1587977619,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":210556,"ip_address":""},"score":249938,"extra":""},{"author":{"id":2296382,"avatar":"https://static001.geekbang.org/account/avatar/00/23/0a/3e/5b1b1b75.jpg","nickname":"流年","note":"","ucode":"8B579C6E466CB4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1240401,"avatar":"","nickname":"fgdgtz","note":"","ucode":"486CC4ACCC015C","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":322395,"discussion_content":"我们也是这么做的，不然的话订单号如果不是递增的，就会导致mysql插入时页分裂，并发高时影响插入的性能","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604737597,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":210556,"ip_address":""},"score":322395,"extra":""}]},{"author":{"id":1611745,"avatar":"https://static001.geekbang.org/account/avatar/00/18/97/e1/0f4d90ff.jpg","nickname":"乖，摸摸头","note":"","ucode":"BD92741A11D3CD","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":263154,"discussion_content":"难道数据库不是都会留一个自增主键的吗，单独再加一个 订单号字段 唯一","likes_number":9,"is_delete":false,"is_hidden":false,"ctime":1589181026,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1306032,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJcxSpNMqwqyicMvdOSr9ic0p1ABiauHnv7g7YQVSJuoHPoQbYDu3YzdpgmSAk2KricUBQ5yibWBWIq75w/132","nickname":"桂城老托尼","note":"","ucode":"139E4B8EE88B79","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":211409,"discussion_content":"短时生成大量号码，可以预加载到本地jvm，比如一台机器先加载它一个亿。不够再像db申请。","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1584848306,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1886331,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/c8/7b/153181d7.jpg","nickname":"夜辉","note":"","ucode":"9421385F51FF9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1306032,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJcxSpNMqwqyicMvdOSr9ic0p1ABiauHnv7g7YQVSJuoHPoQbYDu3YzdpgmSAk2KricUBQ5yibWBWIq75w/132","nickname":"桂城老托尼","note":"","ucode":"139E4B8EE88B79","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":365690,"discussion_content":"一个亿太占内存了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617867910,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":211409,"ip_address":""},"score":365690,"extra":""}]},{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":485423,"discussion_content":"这确实是一个需要考虑的性能问题。\n\n所以很多业务在设计订单号规则的时候都不是完全随机的，一般都是递增的。这种情况下，页分裂就不会特别严重。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1582860853,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1285055,"avatar":"https://static001.geekbang.org/account/avatar/00/13/9b/bf/a76eadff.jpg","nickname":"小嘟嘟","note":"","ucode":"1584DD1402502D","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":574862,"discussion_content":"干货都在评论区出现","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1654413235,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1503064,"avatar":"https://static001.geekbang.org/account/avatar/00/16/ef/58/d05ec302.jpg","nickname":"Frode","note":"","ucode":"B7B8DBF9980EA1","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":368236,"discussion_content":"嗷嗷好","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618627134,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2291767,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLWA1zUQkKWzjnOmeCtZKN1s7X8qrp81ZEyYPsStot84pW0fgE5etMeNmbUdwxTicjmbWOXZxf9EFw/132","nickname":"Geek_128543","note":"","ucode":"09E3391C057CC1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":321945,"discussion_content":"所有表都应该有一个自增id，订单id可以用一个唯一索引代替。这样做不知道会有什么问题？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604652325,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1092169,"avatar":"https://static001.geekbang.org/account/avatar/00/10/aa/49/51790edb.jpg","nickname":"落尘kira","note":"","ucode":"D203B519E43F85","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":270275,"discussion_content":"这提醒了我为什么要建立唯一索引的原因之一，好问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589987805,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1293835,"avatar":"https://static001.geekbang.org/account/avatar/00/13/be/0b/0a381067.jpg","nickname":"zz","note":"","ucode":"EFE0C8D60D0CAC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1092169,"avatar":"https://static001.geekbang.org/account/avatar/00/10/aa/49/51790edb.jpg","nickname":"落尘kira","note":"","ucode":"D203B519E43F85","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":279280,"discussion_content":"但是更新唯一索引的时候，不是还是因为单号差距大，去请求新的节点叶吗？只不过这次多了一个连续的索引。感觉从N的问题变成N+1的问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591319271,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":270275,"ip_address":""},"score":279280,"extra":""}]},{"author":{"id":1058537,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI7Auf5Jy6ebh9wpPYMjz3bx5C7PG3MhOdQUUUGLk4ZJf5yCHnMcP8GEJywUo66rSJFsdMMgmogGA/132","nickname":"朝阳","note":"","ucode":"DD14181C1260AF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":193274,"discussion_content":"赞","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583142863,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":185487,"user_name":"Sunday","can_delete":false,"product_type":"c1","uid":1220703,"ip_address":"","ucode":"4C8E90499239C5","user_header":"https://static001.geekbang.org/account/avatar/00/12/a0/5f/5c190f36.jpg","comment_is_top":false,"comment_ctime":1583591391,"is_pvip":false,"replies":[{"id":"71656","content":"手机号注册重复这种情况，可以简单的用insert if not exist来解决，比如：<br><br>insert into user (name, phone)<br>select * from <br>(select &#39;张三&#39;, 13988888888) <br>as tmp<br>where not exists (<br>  select phone from user where phone = 13988888888<br>) limit 1;","user_name":"作者回复","comment_id":185487,"uid":"1501046","ip_address":"","utype":1,"ctime":1583637968,"user_name_real":"李玥"}],"discussion_count":13,"race_medal":0,"score":"87482937311","product_id":100046801,"comment_content":"老师，用户手机号注册会出现多次注册现象，但因为有注销功能，我又不能设置成唯一主键，所以想问下有没有什么好的解决办法？目前是用redis锁控制并发的。还有ABA问题，一般业务中这种更新都是牵扯到更新多条，使用事务，但事务的话因为隔离级别问题，比如可重复读，感觉并发情况还是有问题","like_count":20,"discussions":[{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":486376,"discussion_content":"手机号注册重复这种情况，可以简单的用insert if not exist来解决，比如：\n\ninsert into user (name, phone)\nselect * from \n(select &amp;#39;张三&amp;#39;, 13988888888) \nas tmp\nwhere not exists (\n  select phone from user where phone = 13988888888\n) limit 1;","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583637968,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1306032,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJcxSpNMqwqyicMvdOSr9ic0p1ABiauHnv7g7YQVSJuoHPoQbYDu3YzdpgmSAk2KricUBQ5yibWBWIq75w/132","nickname":"桂城老托尼","note":"","ucode":"139E4B8EE88B79","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":211414,"discussion_content":"一锁二判三更新，无论有多少条记录。都得遵守这个选择吧","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1584848947,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2256360,"avatar":"","nickname":"Ohh丶","note":"","ucode":"16D42132108E40","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":350306,"discussion_content":"联合索引就可以解决这个问题吧","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1613808616,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1886331,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/c8/7b/153181d7.jpg","nickname":"夜辉","note":"","ucode":"9421385F51FF9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":365692,"discussion_content":"只维护一个账户信息，注销更改其状态","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617868252,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1441734,"avatar":"https://static001.geekbang.org/account/avatar/00/15/ff/c6/8b5cbe97.jpg","nickname":"刘志兵","note":"","ucode":"A90C2FA49EDC23","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":282399,"discussion_content":"我觉得，唯一健用手机号+注销时间就可以解决你的问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591964686,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1049702,"avatar":"https://static001.geekbang.org/account/avatar/00/10/04/66/3b640b4d.jpg","nickname":"Nanda Yu","note":"","ucode":"1276E022340A5B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":270051,"discussion_content":"这个语句没太看明白，可以帮忙解释一下吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589978135,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1886331,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/c8/7b/153181d7.jpg","nickname":"夜辉","note":"","ucode":"9421385F51FF9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1049702,"avatar":"https://static001.geekbang.org/account/avatar/00/10/04/66/3b640b4d.jpg","nickname":"Nanda Yu","note":"","ucode":"1276E022340A5B","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":365695,"discussion_content":"我也感觉这个SQL写的有点奇怪？\n我理解就是只维护一个账户信息，注销/重复注册更改其状态\n注销不会真正删除表中记录\n重复注册不会增加账户信息","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617868375,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":270051,"ip_address":""},"score":365695,"extra":""}]},{"author":{"id":1484192,"avatar":"https://static001.geekbang.org/account/avatar/00/16/a5/a0/e0cccf7e.jpg","nickname":"圆圆满满","note":"","ucode":"396E7A822014D1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":210825,"discussion_content":"我觉得问题有点不清楚。什么是多次注册现象？多次注册会有什么问题吗？手机号可以唯一的吧？增加当前用户状态不就可以了吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584779387,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1359591,"avatar":"https://static001.geekbang.org/account/avatar/00/14/be/e7/605ddad5.jpg","nickname":"OWENZHE","note":"","ucode":"0568050F099A62","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":201727,"discussion_content":"加注销标志也可以，通过注销标示+手机号判断是否重新注册","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583831067,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":4,"child_discussions":[{"author":{"id":1133947,"avatar":"https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIaOAxRlZjFkGfRBn420LuAcyWkMrpq5iafGdqthX5icJPjql0ibZOAdafaqbfvw4ZpVzDmsaYglVXDw/132","nickname":"唐朝农民","note":"","ucode":"6F8F43C6652225","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1359591,"avatar":"https://static001.geekbang.org/account/avatar/00/14/be/e7/605ddad5.jpg","nickname":"OWENZHE","note":"","ucode":"0568050F099A62","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":201763,"discussion_content":"注销标志不太好吧，重复注销不就重复了吗，难道每次注销标志不一样？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583835194,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":201727,"ip_address":""},"score":201763,"extra":""},{"author":{"id":1359591,"avatar":"https://static001.geekbang.org/account/avatar/00/14/be/e7/605ddad5.jpg","nickname":"OWENZHE","note":"","ucode":"0568050F099A62","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1133947,"avatar":"https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIaOAxRlZjFkGfRBn420LuAcyWkMrpq5iafGdqthX5icJPjql0ibZOAdafaqbfvw4ZpVzDmsaYglVXDw/132","nickname":"唐朝农民","note":"","ucode":"6F8F43C6652225","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":203897,"discussion_content":"程序判断","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584098318,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":201763,"ip_address":""},"score":203897,"extra":""},{"author":{"id":1306032,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJcxSpNMqwqyicMvdOSr9ic0p1ABiauHnv7g7YQVSJuoHPoQbYDu3YzdpgmSAk2KricUBQ5yibWBWIq75w/132","nickname":"桂城老托尼","note":"","ucode":"139E4B8EE88B79","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1133947,"avatar":"https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIaOAxRlZjFkGfRBn420LuAcyWkMrpq5iafGdqthX5icJPjql0ibZOAdafaqbfvw4ZpVzDmsaYglVXDw/132","nickname":"唐朝农民","note":"","ucode":"6F8F43C6652225","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":211413,"discussion_content":"重复注销感觉没有什么问题吧，如果为了沉淀数据资产，注销次数和last注销时间就可以了。物理删除尽量别用。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584848883,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":201763,"ip_address":""},"score":211413,"extra":""}]}]},{"had_liked":false,"id":182500,"user_name":"约书亚","can_delete":false,"product_type":"c1","uid":1046714,"ip_address":"","ucode":"81EA27ADD9EC1A","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f8/ba/14e05601.jpg","comment_is_top":false,"comment_ctime":1582797078,"is_pvip":false,"replies":[{"id":"70648","content":"你是指在数据库中插入数据的时候，写入索引的性能下降吗？","user_name":"作者回复","comment_id":182500,"uid":"1501046","ip_address":"","utype":1,"ctime":1582802291,"user_name_real":"李玥"}],"discussion_count":23,"race_medal":0,"score":"70302273814","product_id":100046801,"comment_content":"请教您一个实际问题：<br>无论采用哪种生成订单id的方式，短时间内都可能出现靠前的id后提交（生成订单的问题)，这样一定程度上数据库接收到的id不是严格按时间递增的。而页面浏览的场景，尤甚。<br>请问在您做过的系统里，这会带来一定程度上的性能下降嘛？","like_count":16,"discussions":[{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":485357,"discussion_content":"你是指在数据库中插入数据的时候，写入索引的性能下降吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582802291,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1306032,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJcxSpNMqwqyicMvdOSr9ic0p1ABiauHnv7g7YQVSJuoHPoQbYDu3YzdpgmSAk2KricUBQ5yibWBWIq75w/132","nickname":"桂城老托尼","note":"","ucode":"139E4B8EE88B79","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":211412,"discussion_content":"这是个好问题，马克下来，我觉得不会，99%场景里都没问题，考虑下双11大促，还是不太清楚。 ","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1584848716,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1121758,"avatar":"https://static001.geekbang.org/account/avatar/00/11/1d/de/62bfa83f.jpg","nickname":"aoe","note":"","ucode":"1C6201EDB4E954","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":188579,"discussion_content":"并发量大的时候可以用批量提交插入操作","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1582815227,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":7,"child_discussions":[{"author":{"id":1046714,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f8/ba/14e05601.jpg","nickname":"约书亚","note":"","ucode":"81EA27ADD9EC1A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1121758,"avatar":"https://static001.geekbang.org/account/avatar/00/11/1d/de/62bfa83f.jpg","nickname":"aoe","note":"","ucode":"1C6201EDB4E954","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":189557,"discussion_content":"订单都是每个个人操作之后创建的，如何批量？如果在服务端攒一批再插入，会否down机丢失？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582891911,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":188579,"ip_address":""},"score":189557,"extra":""},{"author":{"id":1121758,"avatar":"https://static001.geekbang.org/account/avatar/00/11/1d/de/62bfa83f.jpg","nickname":"aoe","note":"","ucode":"1C6201EDB4E954","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1046714,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f8/ba/14e05601.jpg","nickname":"约书亚","note":"","ucode":"81EA27ADD9EC1A","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":190594,"discussion_content":"如果量足够大，可以用批处理，如果批处理的速度还没单条插入快，说明量不够大。Redis的pipeline可以了解一下。如何防止数据丢失，可以参考MySQL两阶段提交的思路。","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1582963961,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":189557,"ip_address":""},"score":190594,"extra":""},{"author":{"id":1046714,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f8/ba/14e05601.jpg","nickname":"约书亚","note":"","ucode":"81EA27ADD9EC1A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1121758,"avatar":"https://static001.geekbang.org/account/avatar/00/11/1d/de/62bfa83f.jpg","nickname":"aoe","note":"","ucode":"1C6201EDB4E954","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":191948,"discussion_content":"用redis缓冲id 看似能解决问题，但往往这种电商场景，下订单操作不仅仅是添加一条数据，也许要协调多个服务做一个事务，这时所有涉及的服务都缓冲么？缓存就说明下单成功了，但可能实际id插入时有问题，比如库存不够这种。\n感觉又引出无穷多的问题。\n\n另外我说的数据丢失是指缓冲机制下的，不是怀疑mysql会搞丢数据","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583048381,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":190594,"ip_address":""},"score":191948,"extra":""}]},{"author":{"id":1196531,"avatar":"https://static001.geekbang.org/account/avatar/00/12/41/f3/8bca4aba.jpg","nickname":"普通熊猫 ଘ(੭ˊ꒳​ˋ)੭✧","note":"","ucode":"7FEF9C72B4801B","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":579147,"discussion_content":"1. 所有的BTree索引都会有页分裂的问题, 在order id上加unique key性能跟普通索引没什么区别 \n\n2. order id不可能完全自增, 但可以尽可能的伪自增. 实际上MySQL的自增主键也不是严格自增的\n\n3. order id含user id的基因, 这样可以保证在分库的时候order跟user落在同一个DB上, 可以基于事务insert, update\n\n4. order数据有明显的时效性, 可归档旧的order数据, 约束order表的物理大小 ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1657194270,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1508990,"avatar":"https://static001.geekbang.org/account/avatar/00/17/06/7e/735968e2.jpg","nickname":"西门吹牛","note":"","ucode":"E5D3624DDE1E83","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":282607,"discussion_content":"索引不连续，容易页分裂，插入索引性能下降，批量处理啥的都不现实，感觉这个应该从数据库方面下手考虑","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592025757,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1433535,"avatar":"https://static001.geekbang.org/account/avatar/00/15/df/bf/96b50d1e.jpg","nickname":"😚 46","note":"","ucode":"EED0EBBBF80A43","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":244797,"discussion_content":"主键使用自增ID，订单号建立唯一索引能否解决呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587632035,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":5,"child_discussions":[{"author":{"id":1577580,"avatar":"https://static001.geekbang.org/account/avatar/00/18/12/6c/61a598e9.jpg","nickname":"苏暮沉觞","note":"","ucode":"532B816D4EF47B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1433535,"avatar":"https://static001.geekbang.org/account/avatar/00/15/df/bf/96b50d1e.jpg","nickname":"😚 46","note":"","ucode":"EED0EBBBF80A43","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":247868,"discussion_content":"唯一索引不太行，订单如果在多个数据库可能会出现重复的问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587826810,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":244797,"ip_address":""},"score":247868,"extra":""},{"author":{"id":1433535,"avatar":"https://static001.geekbang.org/account/avatar/00/15/df/bf/96b50d1e.jpg","nickname":"😚 46","note":"","ucode":"EED0EBBBF80A43","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1577580,"avatar":"https://static001.geekbang.org/account/avatar/00/18/12/6c/61a598e9.jpg","nickname":"苏暮沉觞","note":"","ucode":"532B816D4EF47B","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":247980,"discussion_content":"那是订单号重复生成了和唯一索引有啥关系？订单号是分布式唯一的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587829002,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":247868,"ip_address":""},"score":247980,"extra":""},{"author":{"id":1433535,"avatar":"https://static001.geekbang.org/account/avatar/00/15/df/bf/96b50d1e.jpg","nickname":"😚 46","note":"","ucode":"EED0EBBBF80A43","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1577580,"avatar":"https://static001.geekbang.org/account/avatar/00/18/12/6c/61a598e9.jpg","nickname":"苏暮沉觞","note":"","ucode":"532B816D4EF47B","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":248747,"discussion_content":"订单id重复用步长解决","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587893096,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":247868,"ip_address":""},"score":248747,"extra":""}]},{"author":{"id":1207622,"avatar":"https://static001.geekbang.org/account/avatar/00/12/6d/46/e16291f8.jpg","nickname":"丁小明","note":"","ucode":"CC23857B8D75D5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":214392,"discussion_content":"确实，还是使用类似唯一的token规避这类问题比较好，主键插入会有这个性能问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585188398,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1402638,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/X7laRrzGnsib2JOgDSrXnP3ftCx2CD1ia2n80lUZDVxQM8ALot3t7MLINNbDhbM5RevpwuzVb0vaj3yKQcicpsg3w/132","nickname":"SilentNoise","note":"","ucode":"C3B39D610A06E5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":213220,"discussion_content":"这个问题mark下来","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585059756,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1133947,"avatar":"https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIaOAxRlZjFkGfRBn420LuAcyWkMrpq5iafGdqthX5icJPjql0ibZOAdafaqbfvw4ZpVzDmsaYglVXDw/132","nickname":"唐朝农民","note":"","ucode":"6F8F43C6652225","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":201754,"discussion_content":"这个问题好，说订单批量提交的是没做过电商吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583834642,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1053914,"avatar":"https://static001.geekbang.org/account/avatar/00/10/14/da/0a012c26.jpg","nickname":"孤帆","note":"","ucode":"8CC9AAF28944EB","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":191575,"discussion_content":"这个问题提的好👍 但我觉得都没有处理这个情况 ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583003608,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1046714,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f8/ba/14e05601.jpg","nickname":"约书亚","note":"","ucode":"81EA27ADD9EC1A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":188212,"discussion_content":"是的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582804509,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":191179,"user_name":"fgdgtz","can_delete":false,"product_type":"c1","uid":1240401,"ip_address":"","ucode":"486CC4ACCC015C","user_header":"","comment_is_top":false,"comment_ctime":1584752794,"is_pvip":false,"replies":[{"id":"73510","content":"这样也是没问题的，很多情况下架构不是只有一种解决方案的。这种设计的好处就是主键连续，使用订单号做主键的好处是，最常用的按订单号查询会少走一次索引，各有优劣，都可以选择。","user_name":"作者回复","comment_id":191179,"uid":"1501046","ip_address":"","utype":1,"ctime":1584845449,"user_name_real":"李玥"}],"discussion_count":8,"race_medal":0,"score":"66009262234","product_id":100046801,"comment_content":"<br>老师你好，我觉的订单号设为唯一索引约束即可，仍然有个自增主键，订单号对外用，主键不暴露，这样表空间还是连续紧密的，其他关联订单表仍然以订单号作外键","like_count":15,"discussions":[{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":488127,"discussion_content":"这样也是没问题的，很多情况下架构不是只有一种解决方案的。这种设计的好处就是主键连续，使用订单号做主键的好处是，最常用的按订单号查询会少走一次索引，各有优劣，都可以选择。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584845449,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1516600,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/wBjvGCCZmO0Bic0DrnG466y6hwPkibGevAV6E6FPfQEricvw5toL7a2HSgjhI83cCiadrUibIyVibkgbbMOHVxo7HA8Q/132","nickname":"距离30米","note":"","ucode":"5566D9AB9E47DE","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":590890,"discussion_content":"但是一般订单查询，也不会直接走db，一般走搜索引擎呢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1666151110,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":488127,"ip_address":"四川"},"score":590890,"extra":""}]},{"author":{"id":1508990,"avatar":"https://static001.geekbang.org/account/avatar/00/17/06/7e/735968e2.jpg","nickname":"西门吹牛","note":"","ucode":"E5D3624DDE1E83","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":282599,"discussion_content":"订单号设置为主键，根据订单号查询频率很高，可以少一次回表的操作，而用自增id为主键，在加个订单号的唯一索引，会有回表操作，虽然自增id连续，能减少页分裂，但是回表操作，另外加上唯一索引，主键索引，总共俩个索引树，而用订单号做主键，只有一个索引树，空间上也更好点吧","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1592025060,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":3,"child_discussions":[{"author":{"id":1138576,"avatar":"https://static001.geekbang.org/account/avatar/00/11/5f/90/711efc88.jpg","nickname":"FuriousEric","note":"","ucode":"0A66DA938976F7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1508990,"avatar":"https://static001.geekbang.org/account/avatar/00/17/06/7e/735968e2.jpg","nickname":"西门吹牛","note":"","ucode":"E5D3624DDE1E83","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":302659,"discussion_content":"请教下什么叫回表操作？看不懂","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599002862,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":282599,"ip_address":""},"score":302659,"extra":""},{"author":{"id":1508990,"avatar":"https://static001.geekbang.org/account/avatar/00/17/06/7e/735968e2.jpg","nickname":"西门吹牛","note":"","ucode":"E5D3624DDE1E83","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1138576,"avatar":"https://static001.geekbang.org/account/avatar/00/11/5f/90/711efc88.jpg","nickname":"FuriousEric","note":"","ucode":"0A66DA938976F7","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":303254,"discussion_content":"一个索引对应一棵b+树，如果一个表中有多个索引，那么就有多个b+树，根据索引查询数据，首先会在索引对应的树上，进行查询，查询出主键id，然后拿着id在回到主键索引树上查询对应的数据行，这个过程，先根据非主键索引查到主键id，在用主键id回表到主键索引对应的树上查询数据，就叫回表。普通索引树，只存索引字段和主键id字段，只有在主键索引树上，才有这个表对应的整行数据","likes_number":6,"is_delete":false,"is_hidden":false,"ctime":1599201874,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":302659,"ip_address":""},"score":303254,"extra":""},{"author":{"id":2377406,"avatar":"","nickname":"杨毅","note":"","ucode":"189923D892549F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1508990,"avatar":"https://static001.geekbang.org/account/avatar/00/17/06/7e/735968e2.jpg","nickname":"西门吹牛","note":"","ucode":"E5D3624DDE1E83","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":339819,"discussion_content":"学到了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609815740,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":303254,"ip_address":""},"score":339819,"extra":""}]},{"author":{"id":1344431,"avatar":"https://static001.geekbang.org/account/avatar/00/14/83/af/1cb42cd3.jpg","nickname":"马以","note":"","ucode":"3FEA06CA14DE28","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":389540,"discussion_content":"用自增主键还有一个好处就是可以减少主键索引树的高度","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629332271,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2040309,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epq2AfJ26y9tHb6z7kyRyF9MoBgAJf3ia6Fu8GMpZjNY8sfyaAiaYjZ1HxaibDw0ErUS8goFuOuuHTpw/132","nickname":"大灰羊君","note":"","ucode":"49C91668AFB2CA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":285823,"discussion_content":"主要是订单号的索引树还是会有页分裂问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592963104,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":194053,"user_name":"王超","can_delete":false,"product_type":"c1","uid":1107559,"ip_address":"","ucode":"653A7A49A3090F","user_header":"https://static001.geekbang.org/account/avatar/00/10/e6/67/59e81206.jpg","comment_is_top":false,"comment_ctime":1585019578,"is_pvip":true,"replies":[{"id":"74078","content":"这种下单接口，订单内容中一般都会有用户ID，可以通过“1秒钟内每个用户只允许最多下1单”，这种方式来判重。因为一般来说，由于重试导致的重复请求之间的时间间隔都是比较短的。<br><br><br><br>INSERT INTO my_orders (...)<br>SELECT * FROM <br>(SELECT &#39;aaa&#39;, &#39;bbb&#39;, &#39;ccc&#39;) AS tmp -- 实际要insert的数据<br>WHERE NOT EXISTS (<br>    SELECT userid FROM my_orders WHERE userid = &#39;bbb&#39; and last_update_time  &gt; now - 1秒 <br>) LIMIT 1;","user_name":"作者回复","comment_id":194053,"uid":"1501046","ip_address":"","utype":1,"ctime":1585098815,"user_name_real":"李玥"}],"discussion_count":1,"race_medal":0,"score":"57419594426","product_id":100046801,"comment_content":"老师，如果是一个预约中台的项目，只对外提供API能力，前端的预约入口应用不由自己负责，无法要求别人的前端应用在进入下单界面的时候就调用统一生成单号的服务，这种情况下有什么推荐方案么，感谢","like_count":13,"discussions":[{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":488745,"discussion_content":"这种下单接口，订单内容中一般都会有用户ID，可以通过“1秒钟内每个用户只允许最多下1单”，这种方式来判重。因为一般来说，由于重试导致的重复请求之间的时间间隔都是比较短的。\n\n\n\nINSERT INTO my_orders (...)\nSELECT * FROM \n(SELECT &amp;#39;aaa&amp;#39;, &amp;#39;bbb&amp;#39;, &amp;#39;ccc&amp;#39;) AS tmp -- 实际要insert的数据\nWHERE NOT EXISTS (\n    SELECT userid FROM my_orders WHERE userid = &amp;#39;bbb&amp;#39; and last_update_time  &amp;gt; now - 1秒 \n) LIMIT 1;","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585098815,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":192925,"user_name":"leo","can_delete":false,"product_type":"c1","uid":1154091,"ip_address":"","ucode":"0E2D4D779D8DC9","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erxJYxzce3mZpuZFJNyTAvCibzLUTYbZepaBPNd7ichZgkMeibkQLmNzeb63zda1iaKJ6aIewUTA517hQ/132","comment_is_top":false,"comment_ctime":1584878912,"is_pvip":false,"replies":[{"id":"73873","content":"后面我会专门讲，海量数据应该怎么查才会快一些。<br><br>但是，有一个原则上，底层用什么存储，应该尽量对最终用户透明，不要因为换了存储系统，就改变用户的操作习惯。","user_name":"作者回复","comment_id":192925,"uid":"1501046","ip_address":"","utype":1,"ctime":1585013961,"user_name_real":"李玥"}],"discussion_count":2,"race_medal":0,"score":"44534551872","product_id":100046801,"comment_content":"关于数据报表类数据，现在主流解决方案能否推荐一下。本来想推es，但运营人员觉得操作复杂。大厂的实践是什么呢","like_count":10,"discussions":[{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":488482,"discussion_content":"后面我会专门讲，海量数据应该怎么查才会快一些。\n\n但是，有一个原则上，底层用什么存储，应该尽量对最终用户透明，不要因为换了存储系统，就改变用户的操作习惯。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585013961,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1154091,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erxJYxzce3mZpuZFJNyTAvCibzLUTYbZepaBPNd7ichZgkMeibkQLmNzeb63zda1iaKJ6aIewUTA517hQ/132","nickname":"leo","note":"","ucode":"0E2D4D779D8DC9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":212894,"discussion_content":"感谢大神分享和回复","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585030307,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":183994,"user_name":"撒旦的堕落","can_delete":false,"product_type":"c1","uid":1116864,"ip_address":"","ucode":"15F6AA41EE556F","user_header":"https://static001.geekbang.org/account/avatar/00/11/0a/c0/401c240e.jpg","comment_is_top":false,"comment_ctime":1583199462,"is_pvip":false,"replies":[{"id":"71222","content":"disruptor是一个高性能队列，我没有听过类似的用法，我猜测可能是利用disruptor这个队列，预先生成大量的订单号，高并发的情况下，可以瞬间从队列中取出大量预先生成好的订单号，避免订单号生成的速度跟不上瞬时的请求量。","user_name":"作者回复","comment_id":183994,"uid":"1501046","ip_address":"","utype":1,"ctime":1583201536,"user_name_real":"李玥"}],"discussion_count":3,"race_medal":0,"score":"44532872422","product_id":100046801,"comment_content":"老师 我曾经看到文章说用disruptor大规模生成预订单 可以动态改变生成速率  并且可以防止瞬间流量   不过没有说细节 老师在这方面有思路么","like_count":10,"discussions":[{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":485845,"discussion_content":"disruptor是一个高性能队列，我没有听过类似的用法，我猜测可能是利用disruptor这个队列，预先生成大量的订单号，高并发的情况下，可以瞬间从队列中取出大量预先生成好的订单号，避免订单号生成的速度跟不上瞬时的请求量。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583201536,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1886331,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/c8/7b/153181d7.jpg","nickname":"夜辉","note":"","ucode":"9421385F51FF9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":365696,"discussion_content":"这个思路有点像令牌桶算法，只是用于订单服务","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617868645,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1306032,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJcxSpNMqwqyicMvdOSr9ic0p1ABiauHnv7g7YQVSJuoHPoQbYDu3YzdpgmSAk2KricUBQ5yibWBWIq75w/132","nickname":"桂城老托尼","note":"","ucode":"139E4B8EE88B79","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":211425,"discussion_content":"每个jvm缓存一些号段，能否解决这个问题。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584849453,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":263652,"user_name":"Javatar","can_delete":false,"product_type":"c1","uid":2032840,"ip_address":"","ucode":"E216645CDF632C","user_header":"https://static001.geekbang.org/account/avatar/00/1f/04/c8/3c7af100.jpg","comment_is_top":false,"comment_ctime":1606207493,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"35965945861","product_id":100046801,"comment_content":"老师一言不和就讲了两个基本的面试题：<br>1. 如何防止重复提交？<br>2. 谈谈乐观锁？<br>db唯一约束搭配乐观锁，日常防止并发场景应该是足够用了。<br><br>还是题目中的场景，实现幂等应该也可以使用redis：<br><br>订单号还是事先生成，然后用每次创建之前，先在redis中setnx一把，key要包含订单号。<br>如果setnx成功，证明没有创建；如果setnx失败，说明已经创建了，此时应该返回幂等成功。<br><br>当然这会带来一个问题，就是redis中的数据会不断增多，可以考虑增加一个定时清理的任务，把已经“结束”的订单，对应的key清理掉<br>","like_count":8,"discussions":[{"author":{"id":1599313,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/sz7nSDb1CybNIjYYEE9mW4PHADnv7o2zjKsRibdT9wRgJuAgMkEPFHBnRSkVqI4aH5zsegp8fe5hydtxykHBpQQ/132","nickname":"zillo","note":"","ucode":"581D407EA6C627","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539508,"discussion_content":"setnx的时候可以设置超时时间，超时自动淘汰","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1639731485,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":183478,"user_name":"L","can_delete":false,"product_type":"c1","uid":1244290,"ip_address":"","ucode":"9F125EAC36CBEE","user_header":"https://static001.geekbang.org/account/avatar/00/12/fc/82/abf28df3.jpg","comment_is_top":false,"comment_ctime":1583049030,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"31647820102","product_id":100046801,"comment_content":"最喜欢看评论了，总能找到解决我疑问的答案。","like_count":7},{"had_liked":false,"id":294461,"user_name":"Ling","can_delete":false,"product_type":"c1","uid":1323264,"ip_address":"","ucode":"F16F675C1D1EA9","user_header":"https://static001.geekbang.org/account/avatar/00/14/31/00/b5fd38df.jpg","comment_is_top":false,"comment_ctime":1621950225,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"27391754001","product_id":100046801,"comment_content":"1. 作者讲了什么？<br><br>   针对**必须保证数据可靠性的写需求**（例如订单操作）的操作，如何保证数据库的可靠性（准确）<br><br>   引入了**幂等**的概念，表明重复请求在实际生产环境中不可避免；<br><br>   要避免重复请求，就需要使请求幂等，并通过列子说明，如何实现请求的幂等<br><br>2. 作者是怎么把事情说明白的？<br><br>   通过举了电商系统订单的实际的几个例子：<br><br>   1. 订单创建，如何保证保证不重复下单<br>   2. 订单更新，如何保证准确和幂等<br><br>3. 为了讲明白，作者讲了哪些要点？哪些是亮点？<br><br>   **要点**<br><br>   1. 实际生产环境，重复请求不可避免（客户端重试、服务间重试）<br><br>   2. 增：<br><br>      1. 生成唯一订单ID，订单ID全局唯一，并递增（为了MySQL建立索引时，如果不递增引起页分裂等问题，导致写入性能下降）<br>      2. 将生成的ID放入缓存<br>      3. order表的订单ID字段设置唯一索引约束<br>      4. 客户端请求带上订单ID，如果重复插入会引起唯一索引重复，导致事务失败<br>      5. 由于订单已经创建成功，对于由于唯一索引冲突导致的创建失败，需要给前端返回“创建成功”，防止对客户产生困扰<br><br>   3. 改：更改请求接口，带上当前version；SQL条件加上`WHERE version=x `实现天然幂等<br><br>      ```sql<br>      UPDATE order SET tarcing_num=666 AND version=version+1 WHERE id=100 AND version=6<br>      ```<br><br>4. 对于作者所讲，我有哪些发散性思考？<br><br>   1. 对于任何“写”操作的接口，在设计的时候，都需要考虑**幂等**的概念。对于需要强保证数据可靠性的服务，需要设计**幂等**<br>   2. 对于下订单、发表文章、发表评论这些写入服务的接口，除了幂等，还有防止重复提交、快速提交的问题<br><br>      - 一方面  ：客户端端需要做锁，用户点击“发布”按钮后，在网络请求没有返回，或者超时之前，用户都不可以继续点击“发布按钮”，界面可以将按钮置灰或者转菊花<br>      - 另一方面：服务端需要进行加锁<br>        1. 请求接口时，获取一个锁<br>           锁的粒度  ：同一用户的同一操作逻辑<br>           锁名称规则：业务名称+用户ID （例如：post_msg:100101 ）<br>        2. 给锁设置过期时间2-3秒，防止业务逻辑执行错误，用户一直被锁住<br>        3. 如果被锁了，返回“正在处理，请勿重复提交”<br>        4. 没有被锁，执行正常逻辑，在逻辑结束后，删掉锁<br><br>5. 在未来哪些场景，我可以使用它？<br><br>   1. 在做任何更新接口时，时刻考虑是否需要实现**幂等**","like_count":6},{"had_liked":false,"id":184020,"user_name":"京京beaver","can_delete":false,"product_type":"c1","uid":1179056,"ip_address":"","ucode":"C21838D7CA7D6B","user_header":"https://static001.geekbang.org/account/avatar/00/11/fd/b0/e30fd916.jpg","comment_is_top":false,"comment_ctime":1583206707,"is_pvip":false,"discussion_count":8,"race_medal":0,"score":"27353010483","product_id":100046801,"comment_content":"提供一种思路，电商网站一般都是从购物车进入结算的，意味着购物车已经有了待结算商品列表。在结算成单接口，做下单和清除购物车商品两个动作。对于幂等来讲，购物车系统对本次购物车数据有个购物车id，成单接口的入参是购物车id。购物车id本身是全局唯一的，所以订单系统只要检查购物车id是否被处理过就可以了。<br>而结算服务需要做两个动作：使用购物车id去生成订单id，清除购物车，这两个动作调用购物车服务和订单服务，构成了分布式事务。一般为了高并发，是不做事务的，采用后台修数来应对错误。","like_count":6,"discussions":[{"author":{"id":1095316,"avatar":"https://static001.geekbang.org/account/avatar/00/10/b6/94/190de8f4.jpg","nickname":"五河士稻","note":"","ucode":"CB1809F3B739A6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":271229,"discussion_content":"购物车存储可以用 redis 的 hash ，键用 标识+用户id，值","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1590108934,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2297346,"avatar":"https://static001.geekbang.org/account/avatar/00/23/0e/02/41099234.jpg","nickname":"Django...","note":"","ucode":"56693F8A886FF0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1095316,"avatar":"https://static001.geekbang.org/account/avatar/00/10/b6/94/190de8f4.jpg","nickname":"五河士稻","note":"","ucode":"CB1809F3B739A6","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":366955,"discussion_content":"确实可行；\nredis------购物车（hash）：\n&#39;cart_user_1&#39;= {\n\t&#39;sku_id_1&#39; : &#39;10&#39;,   # 值是数量\n\t&#39;sku_id_2&#39; : &#39;20&#39;,\n        &#39;sku_id_3&#39; : &#39;20&#39;,\n\t}\n勾选状态使用set\n&#39;cart_seleted_user_id&#39; = set(&#39;sku_id_1&#39;,&#39;sku_id_2&#39;)","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618224351,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":271229,"ip_address":""},"score":366955,"extra":""}]},{"author":{"id":1256821,"avatar":"https://static001.geekbang.org/account/avatar/00/13/2d/75/e7c29de4.jpg","nickname":"wkq2786130","note":"","ucode":"0F3A9DF9928C67","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":588721,"discussion_content":"商品详情页直接下单或者 营销拉新活动页直接下单 等都是不过购物车的 ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1664016134,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"北京"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1285055,"avatar":"https://static001.geekbang.org/account/avatar/00/13/9b/bf/a76eadff.jpg","nickname":"小嘟嘟","note":"","ucode":"1584DD1402502D","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":574867,"discussion_content":"这里会不会造成 订单号ID 吃紧浪费呢？   比如现在淘宝有晒购物车， 跟着买。 自己平时也会购物车里面加加减减一些东西","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1654414540,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1886331,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/c8/7b/153181d7.jpg","nickname":"夜辉","note":"","ucode":"9421385F51FF9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":365703,"discussion_content":"记录购物车的状态，且要实时更新，\n因为要查询购物车的状态，才能判别是否下单，\n那么更新购物车状态和下单就要同步","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617869225,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1095316,"avatar":"https://static001.geekbang.org/account/avatar/00/10/b6/94/190de8f4.jpg","nickname":"五河士稻","note":"","ucode":"CB1809F3B739A6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":271230,"discussion_content":"额，不小心点到提交了。。。值 存储的是集合，集合里你用下单商品的 sku id 作为键，值存储sku信息。下单支付时可以根据选中的 sku id 判断。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590109032,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1119098,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83er4KLhnBRsrMVlFDUBl4icRB4D0sg9X6H5zWUuXrTW0sax2z2nBlUMEXiawfenEvDe4dtNQric5KppJQ/132","nickname":"futurexiong","note":"","ucode":"160D824AE27CFF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":221480,"discussion_content":"这个购物车id是什么时候生成的？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586011031,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1306032,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJcxSpNMqwqyicMvdOSr9ic0p1ABiauHnv7g7YQVSJuoHPoQbYDu3YzdpgmSAk2KricUBQ5yibWBWIq75w/132","nickname":"桂城老托尼","note":"","ucode":"139E4B8EE88B79","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":211422,"discussion_content":"清空购物车或者从购物车里删除部分商品，这个不重要，做成异步即可。即使没删除问题也不大的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584849395,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":183482,"user_name":"L","can_delete":false,"product_type":"c1","uid":1244290,"ip_address":"","ucode":"9F125EAC36CBEE","user_header":"https://static001.geekbang.org/account/avatar/00/12/fc/82/abf28df3.jpg","comment_is_top":false,"comment_ctime":1583050089,"is_pvip":false,"discussion_count":3,"race_medal":0,"score":"23057886569","product_id":100046801,"comment_content":"我有个疑问，在提交订单的时候，一种是先拿着订单号去查库，让业务代码校验是否存在，另一种是直接利用库表主键唯一约束抛异常，这两种处理方式哪种性能更好？","like_count":5,"discussions":[{"author":{"id":1440423,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLCrJQ4AZe8VrDkR6IO03V4Tda9WexVT4zZiahBjLSYOnZb1Y49JvD2f70uQwYSMibUMQvib9NmGxEiag/132","nickname":"Dowen Liu","note":"","ucode":"DD072D44AD353D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":203522,"discussion_content":"等查完库确定不存在再插入的时候，可能数据已经变化了，订单存在了，还是要抛异常，检查意义不大。","likes_number":7,"is_delete":false,"is_hidden":false,"ctime":1584035365,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1244290,"avatar":"https://static001.geekbang.org/account/avatar/00/12/fc/82/abf28df3.jpg","nickname":"L","note":"","ucode":"9F125EAC36CBEE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1440423,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLCrJQ4AZe8VrDkR6IO03V4Tda9WexVT4zZiahBjLSYOnZb1Y49JvD2f70uQwYSMibUMQvib9NmGxEiag/132","nickname":"Dowen Liu","note":"","ucode":"DD072D44AD353D","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":203586,"discussion_content":"明白，谢谢解答。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584058675,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":203522,"ip_address":""},"score":203586,"extra":""}]},{"author":{"id":1306032,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJcxSpNMqwqyicMvdOSr9ic0p1ABiauHnv7g7YQVSJuoHPoQbYDu3YzdpgmSAk2KricUBQ5yibWBWIq75w/132","nickname":"桂城老托尼","note":"","ucode":"139E4B8EE88B79","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":211418,"discussion_content":"后者","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584849093,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":182612,"user_name":"aoe","can_delete":false,"product_type":"c1","uid":1121758,"ip_address":"","ucode":"1C6201EDB4E954","user_header":"https://static001.geekbang.org/account/avatar/00/11/1d/de/62bfa83f.jpg","comment_is_top":false,"comment_ctime":1582815539,"is_pvip":false,"replies":[{"id":"70682","content":"“业余爱好者”同学相比课中的方案，多了一步在Redis中验证订单号，我理解，这种设计一般是出于安全的考虑，确保提交的订单号确实是我们生成的，而不是来自外部的攻击。<br><br>真正的幂等或者说是防重，还是要依靠数据库的唯一约束。<br><br>也欢迎你说一下你的理解。","user_name":"作者回复","comment_id":182612,"uid":"1501046","ip_address":"","utype":1,"ctime":1582859845,"user_name_real":"李玥"}],"discussion_count":6,"race_medal":0,"score":"23057652019","product_id":100046801,"comment_content":"老师，您在”幂等创建订单的流程“的时序图中：1. 下单；1.1. 生成订单号 ……，按这个逻辑是不能防止重复提交。<br>因为：下单后会走一个完整的生成订单流程<br>留言中”业余爱好者“的思路是正确的","like_count":5,"discussions":[{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":485384,"discussion_content":"“业余爱好者”同学相比课中的方案，多了一步在Redis中验证订单号，我理解，这种设计一般是出于安全的考虑，确保提交的订单号确实是我们生成的，而不是来自外部的攻击。\n\n真正的幂等或者说是防重，还是要依靠数据库的唯一约束。\n\n也欢迎你说一下你的理解。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582859845,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1886331,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/c8/7b/153181d7.jpg","nickname":"夜辉","note":"","ucode":"9421385F51FF9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":365708,"discussion_content":"说我的理解\n这个下单是从购物车，点下单，post请求\n进入订单详情页，设置无法回退页面\n你如果此时刷新页面，只是在查询订单页，就不会重复下单\n\n若再次从购物车选中相同的商品，会下另外一个订单","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617869843,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1121758,"avatar":"https://static001.geekbang.org/account/avatar/00/11/1d/de/62bfa83f.jpg","nickname":"aoe","note":"","ucode":"1C6201EDB4E954","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":189235,"discussion_content":"老师，您的时序图不能保证幂等。下单之前没有判重。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582860329,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":3,"child_discussions":[{"author":{"id":1259218,"avatar":"https://static001.geekbang.org/account/avatar/00/13/36/d2/c7357723.jpg","nickname":"发条橙子 。","note":"","ucode":"ED076F4534FFED","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1121758,"avatar":"https://static001.geekbang.org/account/avatar/00/11/1d/de/62bfa83f.jpg","nickname":"aoe","note":"","ucode":"1C6201EDB4E954","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":190308,"discussion_content":"没有判重不太懂 老师说了真正的防重是依靠数据库唯一约束 。订单号生成唯一索引当重复提交自动就会判重了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582934742,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":189235,"ip_address":""},"score":190308,"extra":""},{"author":{"id":1121758,"avatar":"https://static001.geekbang.org/account/avatar/00/11/1d/de/62bfa83f.jpg","nickname":"aoe","note":"","ucode":"1C6201EDB4E954","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1259218,"avatar":"https://static001.geekbang.org/account/avatar/00/13/36/d2/c7357723.jpg","nickname":"发条橙子 。","note":"","ucode":"ED076F4534FFED","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":190588,"discussion_content":"我是说流程图的逻辑没有判重","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582963633,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":190308,"ip_address":""},"score":190588,"extra":""},{"author":{"id":2252928,"avatar":"","nickname":"Geek_653096","note":"","ucode":"949B213B3A4E33","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1121758,"avatar":"https://static001.geekbang.org/account/avatar/00/11/1d/de/62bfa83f.jpg","nickname":"aoe","note":"","ucode":"1C6201EDB4E954","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":339972,"discussion_content":"这个下单只是生成订单页，还没到真正的提交订单。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609853545,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":190588,"ip_address":""},"score":339972,"extra":""}]}]},{"had_liked":false,"id":189920,"user_name":"划过天空阿忠","can_delete":false,"product_type":"c1","uid":1036370,"ip_address":"","ucode":"9D9BEE73031E40","user_header":"https://static001.geekbang.org/account/avatar/00/0f/d0/52/014accaf.jpg","comment_is_top":false,"comment_ctime":1584582259,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"14469484147","product_id":100046801,"comment_content":"下单接口的参数做签名，放redis。且每个签名做setnx判断，并且设定时长，规定时间内有重复的就是重复下单","like_count":3},{"had_liked":false,"id":183094,"user_name":"陈迪","can_delete":false,"product_type":"c1","uid":1019744,"ip_address":"","ucode":"1A64122CC47337","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8f/60/be0a8805.jpg","comment_is_top":false,"comment_ctime":1582951538,"is_pvip":false,"replies":[{"id":"71091","content":"这种情况我们确实没提到。如果用户打开了多个tab页，只会产生多个订单号，这个时候还没有生成新订单呢。<br><br>只有他在每个tab也都点“下单”按钮，才会产生多个订单。这种情况不存在“误操作”的可能了。","user_name":"作者回复","comment_id":183094,"uid":"1501046","ip_address":"","utype":1,"ctime":1583114866,"user_name_real":"李玥"}],"discussion_count":7,"race_medal":0,"score":"14467853426","product_id":100046801,"comment_content":"第一个防重复创建订单的解决方案中有个疑点，唯一的订单号是在进入“创建订单页面”时创建，用户如果对这个页面不小心同时开了多个tab页，每次打开一个tab页都会生成个新订单号，那就可以提交多个“一模一样”的订单了，而且用户本意应该是一个订单。<br>老师怎么看待这个问题？","like_count":3,"discussions":[{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":485559,"discussion_content":"这种情况我们确实没提到。如果用户打开了多个tab页，只会产生多个订单号，这个时候还没有生成新订单呢。\n\n只有他在每个tab也都点“下单”按钮，才会产生多个订单。这种情况不存在“误操作”的可能了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583114866,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1886331,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/c8/7b/153181d7.jpg","nickname":"夜辉","note":"","ucode":"9421385F51FF9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":365709,"discussion_content":"视为同等将相同商品重新加入购物车处理","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1617869920,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1666025,"avatar":"https://static001.geekbang.org/account/avatar/00/19/6b/e9/7620ae7e.jpg","nickname":"雨落～紫竹","note":"","ucode":"33CED2F34E708F","race_medal":1,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":304247,"discussion_content":"加个流水表吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599529405,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1039069,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/da/dd/1e5e7b0c.jpg","nickname":"image","note":"","ucode":"A45BFF284F8933","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":211214,"discussion_content":"一般商品先加到购物车，在购物车中是不是一个用户只产生一个订单号？如果下单后再产生另一个","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584808085,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1253384,"avatar":"https://static001.geekbang.org/account/avatar/00/13/20/08/bc06bc69.jpg","nickname":"Dovelol","note":"","ucode":"9B5DDF7720F307","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":204341,"discussion_content":"同时点了下单按钮，业务上可以理解就是多单了，不行就帮用户退单就好了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584157022,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1433535,"avatar":"https://static001.geekbang.org/account/avatar/00/15/df/bf/96b50d1e.jpg","nickname":"😚 46","note":"","ucode":"EED0EBBBF80A43","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1253384,"avatar":"https://static001.geekbang.org/account/avatar/00/13/20/08/bc06bc69.jpg","nickname":"Dovelol","note":"","ucode":"9B5DDF7720F307","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":245029,"discussion_content":"我觉得这个确实不属于是误操作了，属于恶意操作，生成多单没毛病","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587647931,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":204341,"ip_address":""},"score":245029,"extra":""},{"author":{"id":1058779,"avatar":"","nickname":"破伞子","note":"","ucode":"694A0E2E76BEE5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1253384,"avatar":"https://static001.geekbang.org/account/avatar/00/13/20/08/bc06bc69.jpg","nickname":"Dovelol","note":"","ucode":"9B5DDF7720F307","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":391865,"discussion_content":"的确，双11这样操作，tb的确产生了多个订单","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630663914,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":204341,"ip_address":""},"score":391865,"extra":""}]}]},{"had_liked":false,"id":182970,"user_name":"每天晒白牙","can_delete":false,"product_type":"c1","uid":1004698,"ip_address":"","ucode":"A1B102CD933DEA","user_header":"https://static001.geekbang.org/account/avatar/00/0f/54/9a/76c0af70.jpg","comment_is_top":false,"comment_ctime":1582900618,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"14467802506","product_id":100046801,"comment_content":"学习收获<br>1.创建订单如何解决重复下单？<br>通过提前预先生成订单号【这里生成订单号可以走单独的id生成器，如何设计一个好的id生成器需要学习】，利用数据库订单号唯一约束【订单号是主键，但主键不是由数据库自增，而是由外部传入】来避免重复入库，实现幂等<br>2.订单更新如何解决ABA问题，在表中增加一个代表版本号的version字段，每次更新时用version做条件，并对其＋1入库","like_count":3,"discussions":[{"author":{"id":1039813,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/dd/c5/9ae99a7f.jpg","nickname":"¾阳光","note":"","ucode":"C67D0E18F6158D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":286983,"discussion_content":"每个课程都能遇见啊","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1593340631,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1004698,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/54/9a/76c0af70.jpg","nickname":"每天晒白牙","note":"","ucode":"A1B102CD933DEA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1039813,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/dd/c5/9ae99a7f.jpg","nickname":"¾阳光","note":"","ucode":"C67D0E18F6158D","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":287000,"discussion_content":"嘻嘻","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1593343806,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":286983,"ip_address":""},"score":287000,"extra":""}]}]},{"had_liked":false,"id":182391,"user_name":"Spring coming","can_delete":false,"product_type":"c1","uid":1116196,"ip_address":"","ucode":"9E01F2D987D08B","user_header":"https://static001.geekbang.org/account/avatar/00/11/08/24/1d3bafaf.jpg","comment_is_top":false,"comment_ctime":1582779058,"is_pvip":false,"replies":[{"id":"70644","content":"用并发的压测工具（比如LoadRunner）结合脚本就可以模拟出来。","user_name":"作者回复","user_name_real":"李玥","uid":"1501046","ctime":1582801771,"ip_address":"","comment_id":182391,"utype":1}],"discussion_count":3,"race_medal":0,"score":"14467680946","product_id":100046801,"comment_content":"如何重现aba问题呢，或者说怎么样模拟网络重试？","like_count":3,"discussions":[{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":485325,"discussion_content":"用并发的压测工具（比如LoadRunner）结合脚本就可以模拟出来。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582801771,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2297346,"avatar":"https://static001.geekbang.org/account/avatar/00/23/0e/02/41099234.jpg","nickname":"Django...","note":"","ucode":"56693F8A886FF0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":366958,"discussion_content":"mark","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618224940,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1476323,"avatar":"https://static001.geekbang.org/account/avatar/00/16/86/e3/a31f6869.jpg","nickname":" 尿布","note":"","ucode":"D1C8BDA7540962","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":260995,"discussion_content":"mark工具","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588924880,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":294460,"user_name":"Ling","can_delete":false,"product_type":"c1","uid":1323264,"ip_address":"","ucode":"F16F675C1D1EA9","user_header":"https://static001.geekbang.org/account/avatar/00/14/31/00/b5fd38df.jpg","comment_is_top":false,"comment_ctime":1621949890,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10211884482","product_id":100046801,"comment_content":"个人经验，对于下订单、发表文章、发表评论这些写入服务的接口，除了幂等，还有防止重复提交、快速提交的问题<br><br>一方面  ：客户端端需要做锁，用户点击“发布”按钮后，在网络请求没有返回，或者超时之前，用户都不可以继续点击“发布按钮”，界面可以将按钮置灰或者转菊花<br>另一方面：服务端需要进行加锁<br>1. 请求接口时，获取一个锁<br>   锁的粒度  ：同一用户的同一操作逻辑<br>   锁名称规则：业务名称+用户ID （例如：post_msg:100101 ）<br>2. 给锁设置过期时间2-3秒，防止业务逻辑执行错误，用户一直被锁住<br>3. 如果被锁了，返回“正在处理，请勿重复提交”<br>4. 没有被锁，执行正常逻辑，在逻辑结束后，删掉锁","like_count":2},{"had_liked":false,"id":239945,"user_name":"知识没学到","can_delete":false,"product_type":"c1","uid":1046584,"ip_address":"","ucode":"5D819DFFC7AB08","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f8/38/8af56e18.jpg","comment_is_top":false,"comment_ctime":1596698789,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"10186633381","product_id":100046801,"comment_content":"订单号自增有安全风险吧，不能让外部通过订单看出来你的销量，一般不会这样用的吧？","like_count":2},{"had_liked":false,"id":189250,"user_name":"浅","can_delete":false,"product_type":"c1","uid":1310499,"ip_address":"","ucode":"CD89303667EDEA","user_header":"https://static001.geekbang.org/account/avatar/00/13/ff/23/1d7f1a70.jpg","comment_is_top":false,"comment_ctime":1584493088,"is_pvip":false,"replies":[{"id":"72996","content":"我个人理解，事务这个功能可能是到现在还在大规模使用MySQL这类RDBMS的几个不多的理由之一了。","user_name":"作者回复","user_name_real":"李玥","uid":"1501046","ctime":1584500068,"ip_address":"","comment_id":189250,"utype":1}],"discussion_count":3,"race_medal":0,"score":"10174427680","product_id":100046801,"comment_content":"你好，老师，数据库事物在实战中应用的多吗，拿京东来说，事物的性能高吗？怎么权衡性能和数据一致性的？还是有别的方案？","like_count":2,"discussions":[{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":487648,"discussion_content":"我个人理解，事务这个功能可能是到现在还在大规模使用MySQL这类RDBMS的几个不多的理由之一了。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1584500068,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1729060,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/62/24/07e2507c.jpg","nickname":"托尼斯威特","note":"","ucode":"98A1035527292E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":285041,"discussion_content":"老师, 你说的事务是用MySQL实现分布式事务吗? \n\n正文提到 -- 插入订单表和插入商品表要在一个事务中.\n那么, 如果两个表在不同机器,不同库, 并且表也做了分片, 还要依赖MySQL做事务吗?\n\n正文提到 -- &#34;比较版本号、更新数据和版本号 +1”，这个过程必须在同一个事务里面执行。这个操作虽然也是事务, 但是本身这个语句就是原子的, 很多NoSQL也支持. \n所以本文的数据是不是用NoSQL也可以?","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592720629,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1886331,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/c8/7b/153181d7.jpg","nickname":"夜辉","note":"","ucode":"9421385F51FF9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1729060,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/62/24/07e2507c.jpg","nickname":"托尼斯威特","note":"","ucode":"98A1035527292E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":365712,"discussion_content":"ACID，数据的强一致性\nNoSQL还是只能保证数据的最终一致性，除非加分布式锁","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617870203,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":285041,"ip_address":""},"score":365712,"extra":""}]}]},{"had_liked":false,"id":189151,"user_name":"颛顼","can_delete":false,"product_type":"c1","uid":1010018,"ip_address":"","ucode":"4A6139389C62EA","user_header":"https://static001.geekbang.org/account/avatar/00/0f/69/62/b874af21.jpg","comment_is_top":false,"comment_ctime":1584460776,"is_pvip":true,"replies":[{"id":"72997","content":"不用，获取订单号是个非常廉价的操作。","user_name":"作者回复","user_name_real":"李玥","uid":"1501046","ctime":1584500103,"ip_address":"","comment_id":189151,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10174395368","product_id":100046801,"comment_content":"想请问下，一般在获取订单号的时候，需不需要去事先检验下能否下单的？","like_count":2,"discussions":[{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":487618,"discussion_content":"不用，获取订单号是个非常廉价的操作。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584500103,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":187557,"user_name":"Dovelol","can_delete":false,"product_type":"c1","uid":1253384,"ip_address":"","ucode":"9B5DDF7720F307","user_header":"https://static001.geekbang.org/account/avatar/00/13/20/08/bc06bc69.jpg","comment_is_top":false,"comment_ctime":1584157834,"is_pvip":false,"replies":[{"id":"72778","content":"我来说一下我的理解：<br><br>1. “生成订单号”这个操作本身是非常廉价的，所以并不会比系统的其它服务更害怕恶意攻击。<br><br>2 和 3 这两个问题，使用分布式锁行不行？肯定也是可以的。但如何在分布式环境下，实现一个高性能、可靠的分布式锁呢？相比 我们课程中提到的“用数据库约束来解决这个问题”，我感觉分布式锁更难实现。","user_name":"作者回复","user_name_real":"李玥","uid":"1501046","ctime":1584409744,"ip_address":"","comment_id":187557,"utype":1}],"discussion_count":3,"race_medal":0,"score":"10174092426","product_id":100046801,"comment_content":"老师好，我想问一个问题，在下单的时候用每次新生成主键id的方式来做幂等，1.这种会不会有恶意攻击的情况，频繁调用这个接口，比如大促的时候会导致正常用户被限流无法获取订单id下单，该如何防护避免呢；2.我理解下单流程从用户提交订单到最后入库应该有很长的逻辑链路？如果把幂等放在db，也就是最后入库的操作会不会因为大量重复问题导致的资源浪费和插入异常，也会影响正常下单体验，并且对db的性能也是一种考验。3.不符合快速失败的设计原则，为什么不直接在最外层用分布式锁来校验，失败就直接返回掉，老师没有选择这种方案的原因是什么呢？就是直接生成一个全局唯一幂等id，也不需要具有订单id的规则，感觉逻辑还更简单一点。希望老师解答一下，非常感谢。","like_count":2,"discussions":[{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":487145,"discussion_content":"我来说一下我的理解：\n\n1. “生成订单号”这个操作本身是非常廉价的，所以并不会比系统的其它服务更害怕恶意攻击。\n\n2 和 3 这两个问题，使用分布式锁行不行？肯定也是可以的。但如何在分布式环境下，实现一个高性能、可靠的分布式锁呢？相比 我们课程中提到的“用数据库约束来解决这个问题”，我感觉分布式锁更难实现。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584409744,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1253384,"avatar":"https://static001.geekbang.org/account/avatar/00/13/20/08/bc06bc69.jpg","nickname":"Dovelol","note":"","ucode":"9B5DDF7720F307","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":290240,"discussion_content":"用数据库约束来校验总感觉有点不合适，不知道大家怎么理解呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594387845,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1886331,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/c8/7b/153181d7.jpg","nickname":"夜辉","note":"","ucode":"9421385F51FF9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1253384,"avatar":"https://static001.geekbang.org/account/avatar/00/13/20/08/bc06bc69.jpg","nickname":"Dovelol","note":"","ucode":"9B5DDF7720F307","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":365715,"discussion_content":"数据库得ACID本身设计就是为了保证数据的一致性的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617870774,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":290240,"ip_address":""},"score":365715,"extra":""}]}]},{"had_liked":false,"id":182964,"user_name":"听雨","can_delete":false,"product_type":"c1","uid":1254493,"ip_address":"","ucode":"252754F9FCFF0C","user_header":"https://static001.geekbang.org/account/avatar/00/13/24/5d/65e61dcb.jpg","comment_is_top":false,"comment_ctime":1582899638,"is_pvip":false,"replies":[{"id":"71077","content":"极客有女粉？我不信。","user_name":"作者回复","user_name_real":"李玥","uid":"1501046","ctime":1583113856,"ip_address":"","comment_id":182964,"utype":1}],"discussion_count":8,"race_medal":0,"score":"10172834230","product_id":100046801,"comment_content":"老师讲的通透，另外，留胡子可是太帅了，如果把海报也换一下，应该能吸不少女粉","like_count":2,"discussions":[{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":485517,"discussion_content":"极客有女粉？我不信。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1583113856,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":2,"child_discussions":[{"author":{"id":1172501,"avatar":"","nickname":"火焰","note":"","ucode":"09FC35A1E7097A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":539314,"discussion_content":"我是女粉，哈哈哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639665765,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":485517,"ip_address":""},"score":539314,"extra":""},{"author":{"id":1692159,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI9lZ1UPoTzMkd83Bib2xuPNtdfdUSDwd9YVyicTdvSbuxkiaAszDwbib8qCIFbSnStibC0ibNaZvnr9icMg/132","nickname":"Geek_1cb3fe","note":"","ucode":"CB254F1AD4C802","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":577198,"discussion_content":"我就是","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655968272,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":485517,"ip_address":""},"score":577198,"extra":""}]},{"author":{"id":1301113,"avatar":"https://static001.geekbang.org/account/avatar/00/13/da/79/9b093890.jpg","nickname":"大秦皇朝","note":"","ucode":"0F72D0D2FAEAF2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":195978,"discussion_content":"程序媛？我也不信","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1583325568,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1691669,"avatar":"https://static001.geekbang.org/account/avatar/00/19/d0/15/5851180d.jpg","nickname":"一个无趣的俗人","note":"","ucode":"25435088B10CA2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":554176,"discussion_content":"谁说没有，我，，，，也不是","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1646235567,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2032840,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/04/c8/3c7af100.jpg","nickname":"Javatar","note":"","ucode":"E216645CDF632C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":328670,"discussion_content":"这是个钓鱼贴，我兴致勃勃的点进来发现评论果然清一色男的。我觉得老师说的对","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606207892,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1435733,"avatar":"https://static001.geekbang.org/account/avatar/00/15/e8/55/92f82281.jpg","nickname":"MClink","note":"","ucode":"F479190923355C","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":282058,"discussion_content":"谁说没有，我，，，，不是","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591875601,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1560828,"avatar":"https://static001.geekbang.org/account/avatar/00/17/d0/fc/f7a5e223.jpg","nickname":"狐狸糊涂","note":"","ucode":"131C15B606326D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":231098,"discussion_content":"为撒不信","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586786648,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":182520,"user_name":"刘楠","can_delete":false,"product_type":"c1","uid":1120773,"ip_address":"","ucode":"9F19D44CBEE039","user_header":"https://static001.geekbang.org/account/avatar/00/11/1a/05/f154d134.jpg","comment_is_top":false,"comment_ctime":1582801247,"is_pvip":false,"replies":[{"id":"70677","content":"订单号一定是后端服务来生成，新生成的订单号不用保存在任何地方，就是返回给前端页面。<br><br>提交订单就正常用新的单号插入数据库，如果用户没提交订单关了页面，这个单号废了也没关系。不需要做任何清理。","user_name":"作者回复","user_name_real":"李玥","uid":"1501046","ctime":1582859210,"ip_address":"","comment_id":182520,"utype":1}],"discussion_count":2,"race_medal":0,"score":"10172735839","product_id":100046801,"comment_content":"创建订单服务时，在用户进入创建订单的页面时,客户端先生成一个单号，提交时，把穿上单号提交上来，同时保存在数据库，生成订单成功后，客户端生成单号放缓存-给个短的过期时间，第二次提交上来，先查缓存，有就直接返回，没有就去生成订单？","like_count":2,"discussions":[{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":485364,"discussion_content":"订单号一定是后端服务来生成，新生成的订单号不用保存在任何地方，就是返回给前端页面。\n\n提交订单就正常用新的单号插入数据库，如果用户没提交订单关了页面，这个单号废了也没关系。不需要做任何清理。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582859210,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2297346,"avatar":"https://static001.geekbang.org/account/avatar/00/23/0e/02/41099234.jpg","nickname":"Django...","note":"","ucode":"56693F8A886FF0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":366963,"discussion_content":"正解，订单号还得后端生成；提交订单用最新的前端post带上最新的订单号参数","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618225674,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":182106,"user_name":"李东勇","can_delete":false,"product_type":"c1","uid":1236071,"ip_address":"","ucode":"7D1EA72D326F32","user_header":"https://static001.geekbang.org/account/avatar/00/12/dc/67/5149a60b.jpg","comment_is_top":false,"comment_ctime":1582710386,"is_pvip":false,"discussion_count":7,"race_medal":0,"score":"10172644978","product_id":100046801,"comment_content":"我们目前对重复下单不做处理， 过期不支付的话就把该订单关闭了， 加上我们目前不会把订单展示给用户， 似乎没啥问题（不过有隐患）","like_count":2,"discussions":[{"author":{"id":1121758,"avatar":"https://static001.geekbang.org/account/avatar/00/11/1d/de/62bfa83f.jpg","nickname":"aoe","note":"","ucode":"1C6201EDB4E954","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":188611,"discussion_content":"有问题的时候有可能你已经在别的公司了，程序员何必为难程序员","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1582815763,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1067425,"avatar":"https://static001.geekbang.org/account/avatar/00/10/49/a1/65eb82df.jpg","nickname":"良木","note":"","ucode":"2D63A277233DDA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":187530,"discussion_content":"重复下单还是要处理下，有很多监听创建订单的事件触发，比如发通知消息、增加积分，都会有影响","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1582732620,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1236071,"avatar":"https://static001.geekbang.org/account/avatar/00/12/dc/67/5149a60b.jpg","nickname":"李东勇","note":"","ucode":"7D1EA72D326F32","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1067425,"avatar":"https://static001.geekbang.org/account/avatar/00/10/49/a1/65eb82df.jpg","nickname":"良木","note":"","ucode":"2D63A277233DDA","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":191014,"discussion_content":"恩恩， 了解了，这块是同事做的， 我也觉得做法不太好，但觉得也不影响正常业务就没提出改进。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582984995,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":187530,"ip_address":""},"score":191014,"extra":""}]},{"author":{"id":1311032,"avatar":"https://static001.geekbang.org/account/avatar/00/14/01/38/104b96a3.jpg","nickname":"谭伟","note":"","ucode":"AEC724819A2773","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":186920,"discussion_content":"1. 数据重复，总归不好，多余的数据没有分析的价值。 2。是商家这端会不会看到这些数据","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1582720964,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1236071,"avatar":"https://static001.geekbang.org/account/avatar/00/12/dc/67/5149a60b.jpg","nickname":"李东勇","note":"","ucode":"7D1EA72D326F32","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1311032,"avatar":"https://static001.geekbang.org/account/avatar/00/14/01/38/104b96a3.jpg","nickname":"谭伟","note":"","ucode":"AEC724819A2773","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":191017,"discussion_content":"恩恩， 看来大家观点都很一致， 就是最好避免这种脏数据。 第二条的话目前不会的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582985035,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":186920,"ip_address":""},"score":191017,"extra":""}]},{"author":{"id":1002685,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/4c/bd/9e568308.jpg","nickname":"Jim","note":"","ucode":"2D413E4451060C","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":188941,"discussion_content":"这样后期做报表的话，感觉数据有点乱，不容易跟踪分析用户行为吧？比如到底是真下单不付款还是重复下单了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582822765,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1236071,"avatar":"https://static001.geekbang.org/account/avatar/00/12/dc/67/5149a60b.jpg","nickname":"李东勇","note":"","ucode":"7D1EA72D326F32","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1002685,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/4c/bd/9e568308.jpg","nickname":"Jim","note":"","ucode":"2D413E4451060C","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":191010,"discussion_content":"感谢评论， 感觉你说的很值得我去改进。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582984937,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":188941,"ip_address":""},"score":191010,"extra":""}]}]},{"had_liked":false,"id":227385,"user_name":"lidashuang","can_delete":false,"product_type":"c1","uid":1104850,"ip_address":"","ucode":"560ABE8032760E","user_header":"https://static001.geekbang.org/account/avatar/00/10/db/d2/e29f8834.jpg","comment_is_top":false,"comment_ctime":1592369206,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5887336502","product_id":100046801,"comment_content":"ABA 问题怎么解决？这里给你提供一个比较通用的解决方法。给你的订单主表增加一列，列名可以叫 version，也即是“版本号”的意思。每次查询订单的时候，版本号需要随着订单数据返回给页面。页面在更新数据的请求中，需要把这个版本号作为更新请求的参数，再带回给订单更新服务。<br><br><br>version这个学名就是乐观锁😄","like_count":1,"discussions":[{"author":{"id":1886331,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/c8/7b/153181d7.jpg","nickname":"夜辉","note":"","ucode":"9421385F51FF9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":365714,"discussion_content":"加版本号是为了区分第一个A和第三个A，使其快速失败\n不能等价于乐观锁，锁是有竟态条件的\n乐观锁用了这个思想，不断查询，进行更新","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617870669,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":225850,"user_name":"MClink","can_delete":false,"product_type":"c1","uid":1435733,"ip_address":"","ucode":"F479190923355C","user_header":"https://static001.geekbang.org/account/avatar/00/15/e8/55/92f82281.jpg","comment_is_top":false,"comment_ctime":1591875128,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"5886842424","product_id":100046801,"comment_content":"第一次听到 ABA 这个概念，在业务开发的时候对接巨量引擎的 API 时，就有要求提供一个上个实体信息的 modify_time 字段，目的是为了确保基于最新数据的修改，原来是为了避免这个问题。哈哈哈，学到了","like_count":1},{"had_liked":false,"id":194827,"user_name":"eviltion","can_delete":false,"product_type":"c1","uid":1515445,"ip_address":"","ucode":"022DE8510B825E","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/mWicFKgbjL299CQPEhoFdSAphVb4UpibkhF8loRxryBRt3H7ZGkibibhaKANTxvSiatic4PLCy2MsbEMH1hc76YefPUw/132","comment_is_top":false,"comment_ctime":1585107861,"is_pvip":true,"discussion_count":2,"race_medal":0,"score":"5880075157","product_id":100046801,"comment_content":"想问下老师一个问题，用订单号作为唯一索引，然后再增加一个订单的唯一主键递增，这样可以减少mysql数据库页分裂,但是感觉在创建订单时会有问题","like_count":1,"discussions":[{"author":{"id":1433535,"avatar":"https://static001.geekbang.org/account/avatar/00/15/df/bf/96b50d1e.jpg","nickname":"😚 46","note":"","ucode":"EED0EBBBF80A43","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":245010,"discussion_content":"没问题，但是应该会影响插入和更新的性能","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587647176,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2297346,"avatar":"https://static001.geekbang.org/account/avatar/00/23/0e/02/41099234.jpg","nickname":"Django...","note":"","ucode":"56693F8A886FF0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1433535,"avatar":"https://static001.geekbang.org/account/avatar/00/15/df/bf/96b50d1e.jpg","nickname":"😚 46","note":"","ucode":"EED0EBBBF80A43","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":366964,"discussion_content":"更新索引会影响插入和更新的性能是么","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618225907,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":245010,"ip_address":""},"score":366964,"extra":""}]}]},{"had_liked":false,"id":193900,"user_name":"夏目","can_delete":false,"product_type":"c1","uid":1212750,"ip_address":"","ucode":"67C075A01CF4D2","user_header":"https://static001.geekbang.org/account/avatar/00/12/81/4e/d71092f4.jpg","comment_is_top":false,"comment_ctime":1584978774,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5879946070","product_id":100046801,"comment_content":"使用token作为唯一标识，每次请求前前端向后端获取一个token并存在redis中设置合适的过期时间。请求的时候带上这个token，后端检验这个token是否存在，如果不存在则返回失败，存在则请求放行并删除redis中token","like_count":1,"discussions":[{"author":{"id":1998089,"avatar":"","nickname":"Geek_eefb88","note":"","ucode":"3E1DE70280D4D7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":291626,"discussion_content":"如果只针对下单接口的话，和上述方案区别不大。但是如果是所有接口都这样处理，凭多出很多资源消耗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594891177,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":184481,"user_name":"大秦皇朝","can_delete":false,"product_type":"c1","uid":1301113,"ip_address":"","ucode":"0F72D0D2FAEAF2","user_header":"https://static001.geekbang.org/account/avatar/00/13/da/79/9b093890.jpg","comment_is_top":false,"comment_ctime":1583325435,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5878292731","product_id":100046801,"comment_content":"订单生成的时候也有可能网络抖动，然后请求了两次，最无脑的处理就是不管哪次，获取到其中一个在界面中就行了，反正提交的时候就始终持有这个id不会变吧？不知道理解的对不对。","like_count":1},{"had_liked":false,"id":183903,"user_name":"看不到de颜色","can_delete":false,"product_type":"c1","uid":1162714,"ip_address":"","ucode":"88348CCAE81931","user_header":"https://static001.geekbang.org/account/avatar/00/11/bd/da/3d76ea74.jpg","comment_is_top":false,"comment_ctime":1583159522,"is_pvip":false,"discussion_count":3,"race_medal":0,"score":"5878126818","product_id":100046801,"comment_content":"“如果是超大规模的系统，可能用一个Redis实例来生成和验证这个GUID就忙不过来了，大家也可以想一下有没有什么性能上更好的方式？”<br>这个问题是否可以对订单号进行路由，用户提交订单时让此次请求路由到单号生成的机器上去，然后这台机器上本地缓存着这个单号，从而降级redis的访问频率。<br>再就是redis通长也是集群部署，是否可以准备一个专用的redis集群做这件事情。","like_count":1,"discussions":[{"author":{"id":1886331,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/c8/7b/153181d7.jpg","nickname":"夜辉","note":"","ucode":"9421385F51FF9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":365717,"discussion_content":"负载均衡和Redis cluster\n感觉细节是魔鬼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617870923,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1433535,"avatar":"https://static001.geekbang.org/account/avatar/00/15/df/bf/96b50d1e.jpg","nickname":"😚 46","note":"","ucode":"EED0EBBBF80A43","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":245008,"discussion_content":"布隆过滤器？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587647091,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1622141,"avatar":"","nickname":"RexDu","note":"","ucode":"E4325E897F3B38","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":231884,"discussion_content":"出现重复下单的比例不大吧，用了redis就会每次请求都查redis，老师的方案更省时间","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586835821,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":183561,"user_name":"不能扮演天使","can_delete":false,"product_type":"c1","uid":1046172,"ip_address":"","ucode":"9922330BFF7FFB","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f6/9c/b457a937.jpg","comment_is_top":false,"comment_ctime":1583066988,"is_pvip":false,"discussion_count":4,"race_medal":0,"score":"5878034284","product_id":100046801,"comment_content":"我们公司的解决方案是：一个用户30s内只能下一单，这样不仅能够限流还能解决重复问题，使用redis分布式锁判断，感觉老师说的前端请求订单号生成服务有点奇怪，我们的订单号是时间+服务器号+随机生成码之类算法出来的一个自增码，这样也能用作mysql主键。","like_count":1,"discussions":[{"author":{"id":1594215,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIG2aw6bmrrxPkrwIyStmZsfaYVHzYbP05A8V9LCa8ZnKl7yYb4zHTyicN5grp03nnpRqgQicpsaTxg/132","nickname":"STOREFEE","note":"","ucode":"CF660E3FF11D95","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":371901,"discussion_content":"秒杀其实前端也会动态阻止一部分流量打到后端。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620048058,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1886331,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/c8/7b/153181d7.jpg","nickname":"夜辉","note":"","ucode":"9421385F51FF9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":365719,"discussion_content":"类雪花算法，30s内只能下一单时长略有点长","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617871002,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1835642,"avatar":"","nickname":"叶子","note":"","ucode":"41131155D75B09","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":222566,"discussion_content":"抢购这种场景瞬间凉凉","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586158005,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1005062,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/56/06/ea49b29d.jpg","nickname":"小洛","note":"","ucode":"227EC21891012B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1835642,"avatar":"","nickname":"叶子","note":"","ucode":"41131155D75B09","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":233153,"discussion_content":"其实请求订单号服务这种，在抢购场景下也有可能瞬间凉凉，和用redis其实本质都是一样的，扛不住的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586912441,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":222566,"ip_address":""},"score":233153,"extra":""}]}]},{"had_liked":false,"id":360283,"user_name":"erge","can_delete":false,"product_type":"c1","uid":2672238,"ip_address":"北京","ucode":"FAE16C190A3E23","user_header":"https://static001.geekbang.org/account/avatar/00/28/c6/6e/49aff2bd.jpg","comment_is_top":false,"comment_ctime":1666398867,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1666398867","product_id":100046801,"comment_content":"老师请问一下，生成订单号的服务不是每次都会产生一个全局唯一的订单号吗，那为什么用户连续点击两次，返回的订单号是同一个呢？","like_count":0},{"had_liked":false,"id":356368,"user_name":"C.Y","can_delete":false,"product_type":"c1","uid":1888264,"ip_address":"北京","ucode":"52124B03842244","user_header":"https://static001.geekbang.org/account/avatar/00/1c/d0/08/f6970238.jpg","comment_is_top":false,"comment_ctime":1662202705,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1662202705","product_id":100046801,"comment_content":"清晰，透彻","like_count":0},{"had_liked":false,"id":355829,"user_name":"Geek_4f14f0","can_delete":false,"product_type":"c1","uid":3026361,"ip_address":"上海","ucode":"781A31ABA55836","user_header":"","comment_is_top":false,"comment_ctime":1661772577,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1661772577","product_id":100046801,"comment_content":"先通过创建订单接口返回订单，再进行下单，理论上不能解决幂等的问题，原因是：下单可能会有系统重复提交和用户行为，那么创建订单+下单也会有重复的可能，只是把事情拆成两端来处理了，降低了发生的概率。<br>系统性重试（网络重试OR业务重试）通过请求唯一Token不知道是不是一个比较好的解决方案，还减少一次和后端交互。<br>当然请求唯一Token1+创建订单---&gt;请求唯一Token2+下单这样做业务上可能更安全，自己YY的不太懂，还望大佬们反馈","like_count":0},{"had_liked":false,"id":349145,"user_name":"苏彧","can_delete":false,"product_type":"c1","uid":1622448,"ip_address":"","ucode":"C016B28DF7449C","user_header":"https://static001.geekbang.org/account/avatar/00/18/c1/b0/b52d9ade.jpg","comment_is_top":false,"comment_ctime":1655774350,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1655774350","product_id":100046801,"comment_content":"老师 单独搞一个生成订单号的接口 会不会多次生成订单号都往数据库里插入","like_count":0},{"had_liked":false,"id":335651,"user_name":"Sam.张朝","can_delete":false,"product_type":"c1","uid":1132448,"ip_address":"","ucode":"FB20554D94B250","user_header":"https://static001.geekbang.org/account/avatar/00/11/47/a0/f12115b7.jpg","comment_is_top":false,"comment_ctime":1645614351,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1645614351","product_id":100046801,"comment_content":"面试就被问了，如果让你负责整个订单服务，你要怎么设计，用到的技术，中间件，如何保证高可用，高性能","like_count":0},{"had_liked":false,"id":335535,"user_name":"请叫我和尚","can_delete":false,"product_type":"c1","uid":1703256,"ip_address":"","ucode":"33A8A1CDA103F9","user_header":"https://static001.geekbang.org/account/avatar/00/19/fd/58/1af629c7.jpg","comment_is_top":false,"comment_ctime":1645579355,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1645579355","product_id":100046801,"comment_content":"有一个问题：如果生成订单号的这个逻辑，只是简单的为了生成一个唯一订单号，那就会出现以下情况：<br>1. 用户同时打开了 N 个下单页（这时候就生成了 N 个不一样的订单号）<br>2. 然后在 N 个下单页同时去下单，用户其实就想下一个单，然而这样就下了 N 个单。<br><br>联想到支付的一个逻辑，根据订单号要生成一个支付流水号，然后做支付处理，那这时候是不是订单号和支付流水号就需要有一个 1：1 的关系，不可能每次进入支付界面，都重新生成一个新的支付流水号吧，应该是第一次新生成，第二次就是找到第一次的支付流水号返回吧。","like_count":0,"discussions":[{"author":{"id":2926591,"avatar":"","nickname":"Geek_50ca94","note":"","ucode":"3BAC934A4103D6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":556990,"discussion_content":"你这不是用户想下一个单 而是用户就想下N个单 重复提交 是防止用户点快了 或者 网络问题造成的数据重复","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1647597051,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":331259,"user_name":"ZY","can_delete":false,"product_type":"c1","uid":2367461,"ip_address":"","ucode":"1D7D83BE4BA54F","user_header":"https://static001.geekbang.org/account/avatar/00/24/1f/e5/c16be6b3.jpg","comment_is_top":false,"comment_ctime":1642509333,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1642509333","product_id":100046801,"comment_content":"这一章主要学到了两点：<br>1、利用预反馈给前端订单号的方式解决生成重复的订单的问题<br>2、利用版本号机制解决ABA问题","like_count":0},{"had_liked":false,"id":328592,"user_name":"沐","can_delete":false,"product_type":"c1","uid":1326537,"ip_address":"","ucode":"678F6A0C778CDD","user_header":"https://static001.geekbang.org/account/avatar/00/14/3d/c9/a1e6a307.jpg","comment_is_top":false,"comment_ctime":1640782612,"is_pvip":false,"discussion_count":0,"race_medal":1,"score":"1640782612","product_id":100046801,"comment_content":"1、订单系统的核心功能和数据：<br>A）创建订单<br>B）更新订单状态<br>C）查询订单<br>2、如何避免重复下单（前端重复提交、网络重传）：让订单服务具备幂等性<br>A）利用数据库的主键唯一性约束，插入数据时带上主键<br>B) 在进入创建订单页面，请求生产订单号服务得到一个订单号<br>3、如何解决ABA问题<br>给每行数据增加一列版本号","like_count":0},{"had_liked":false,"id":318704,"user_name":"董俊俊","can_delete":false,"product_type":"c1","uid":1297887,"ip_address":"","ucode":"732300A779660B","user_header":"https://static001.geekbang.org/account/avatar/00/13/cd/df/c520d418.jpg","comment_is_top":false,"comment_ctime":1635397853,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1635397853","product_id":100046801,"comment_content":"订单提交时，客户端提交时间是不确定的，数据库插入数据时，写入索引的性能会下降吧？<br>","like_count":0},{"had_liked":false,"id":314550,"user_name":"Ping","can_delete":false,"product_type":"c1","uid":1812754,"ip_address":"","ucode":"FC4743D8FEF61C","user_header":"https://static001.geekbang.org/account/avatar/00/1b/a9/12/e041e7b2.jpg","comment_is_top":false,"comment_ctime":1633205308,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1633205308","product_id":100046801,"comment_content":"“这几个表之间的关系是这样的：订单主表和后面的几个子表都是一对多的关系，关联的外键就是订单主表的主键，也就是订单号。”老师这里的一对多是什么意思啊？","like_count":0,"discussions":[{"author":{"id":2791739,"avatar":"https://static001.geekbang.org/account/avatar/00/2a/99/3b/acbc0986.jpg","nickname":"记忆不寒凉","note":"","ucode":"AC1D0AA0740803","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":400969,"discussion_content":"一个订单可能会有多个商品，也可能会有多种优惠，一对多","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633506216,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":307751,"user_name":"马以","can_delete":false,"product_type":"c1","uid":1344431,"ip_address":"","ucode":"3FEA06CA14DE28","user_header":"https://static001.geekbang.org/account/avatar/00/14/83/af/1cb42cd3.jpg","comment_is_top":false,"comment_ctime":1629247834,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1629247834","product_id":100046801,"comment_content":"唯一索引性能要比普通索引差很多","like_count":0},{"had_liked":false,"id":287291,"user_name":"夜辉","can_delete":false,"product_type":"c1","uid":1886331,"ip_address":"","ucode":"9421385F51FF9E","user_header":"https://static001.geekbang.org/account/avatar/00/1c/c8/7b/153181d7.jpg","comment_is_top":false,"comment_ctime":1617869995,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1617869995","product_id":100046801,"comment_content":"订单系统下单保证幂等性<br>​\t“生成订单号”的服务，返回一个新的、全局唯一的订单号<br><br>订单系统更新快递单号，更新天然具有幂等性，但在高并发情形下会有ABA问题<br>​\t数据库表加入version字段","like_count":0},{"had_liked":false,"id":251991,"user_name":"否极泰来","can_delete":false,"product_type":"c1","uid":1439355,"ip_address":"","ucode":"C249173266251A","user_header":"https://static001.geekbang.org/account/avatar/00/15/f6/7b/b6abcbbe.jpg","comment_is_top":false,"comment_ctime":1602044676,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1602044676","product_id":100046801,"comment_content":"把下单操作分解成两步：先获取单号（唯一标示）、再创建订单，可以避免重复下单、也可以一定程度避免外部 通过创建订单接口恶意攻击（如果不了解创建订单是两步操作的话）","like_count":0},{"had_liked":false,"id":248124,"user_name":"程堃","can_delete":false,"product_type":"c1","uid":1549808,"ip_address":"","ucode":"50D02D13CAD09A","user_header":"https://static001.geekbang.org/account/avatar/00/17/a5/f0/c4eba20f.jpg","comment_is_top":false,"comment_ctime":1600038741,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1600038741","product_id":100046801,"comment_content":"我们的订单系统是在所有更新订单操作时，都会查订单并用for update加行锁，感觉这种悲观锁实现起来更简单，那么性能方面会差很多吗？","like_count":0,"discussions":[{"author":{"id":1680805,"avatar":"https://static001.geekbang.org/account/avatar/00/19/a5/a5/0842599f.jpg","nickname":"Abner丶","note":"","ucode":"B071DAB57680AF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":390394,"discussion_content":"会的，如果太多订单没有释放的话，会造成数据库连接数过多的问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629814150,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":247455,"user_name":"莫珣","can_delete":false,"product_type":"c1","uid":1117933,"ip_address":"","ucode":"CAFE6F2AC5C177","user_header":"https://static001.geekbang.org/account/avatar/00/11/0e/ed/1c662e93.jpg","comment_is_top":false,"comment_ctime":1599713022,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1599713022","product_id":100046801,"comment_content":"发订单请求之前先生成一个订单号，这怎么能幂等呢，只能防止网络错误带来的重试吧。如果用户就是想要下一个一模一样的单怎么办？","like_count":0,"discussions":[{"author":{"id":2032840,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/04/c8/3c7af100.jpg","nickname":"Javatar","note":"","ucode":"E216645CDF632C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":328671,"discussion_content":"下一个一模一样的单就再请求一个新的订单号","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1606208019,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":246584,"user_name":"坏坏的举哥","can_delete":false,"product_type":"c1","uid":1084636,"ip_address":"","ucode":"98D1BAA79DC0C0","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJQsyr2Ge5iaKwEUQibeWDAa9sU5w3xmbBTBa4u9mibkKTia2DfDVdRCKL69rYradbmxBzQsPsNrPBic8A/132","comment_is_top":false,"comment_ctime":1599413404,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1599413404","product_id":100046801,"comment_content":"下单没有必要幂等吧，这可以网关层就拦截掉这短期频繁请求了，当成刷单拦截来做就行。而且文中这样方案就把下单下单请求分成两阶段了，而且服务端也不应该去充分相信前段的请求参数值","like_count":0},{"had_liked":false,"id":241067,"user_name":"龙行秀","can_delete":false,"product_type":"c1","uid":1351066,"ip_address":"","ucode":"2DA088D199EA9D","user_header":"https://static001.geekbang.org/account/avatar/00/14/9d/9a/7f064a9f.jpg","comment_is_top":false,"comment_ctime":1597162832,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1597162832","product_id":100046801,"comment_content":"第一个例子总感觉没有解决手抖问题呢？不知道老师能再解释下吗","like_count":0},{"had_liked":false,"id":224683,"user_name":"张三丰","can_delete":false,"product_type":"c1","uid":1155275,"ip_address":"","ucode":"3A6215A40B3B21","user_header":"https://static001.geekbang.org/account/avatar/00/11/a0/cb/aab3b3e7.jpg","comment_is_top":false,"comment_ctime":1591506104,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1591506104","product_id":100046801,"comment_content":"我感觉避免重复下单的操作还是要保留自增主键（毕竟它有很好的性能），同时增加一个订单号字段，并对这个字段创建唯一索引。<br><br>这样可以吗老师","like_count":0,"discussions":[{"author":{"id":2032840,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/04/c8/3c7af100.jpg","nickname":"Javatar","note":"","ucode":"E216645CDF632C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":328672,"discussion_content":"理论上感觉应该可以","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606208154,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1435733,"avatar":"https://static001.geekbang.org/account/avatar/00/15/e8/55/92f82281.jpg","nickname":"MClink","note":"","ucode":"F479190923355C","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":282059,"discussion_content":"自增ID作为主键是有好处的，比如说普通索引存储的其实是主键的值（然后回表查询），所以如果主键占的存储空间越小，索引树也就占用越小的空间","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591875721,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":219686,"user_name":"不忘初心","can_delete":false,"product_type":"c1","uid":1226554,"ip_address":"","ucode":"CD36F5EE1E1F4D","user_header":"https://static001.geekbang.org/account/avatar/00/12/b7/3a/a00ec799.jpg","comment_is_top":false,"comment_ctime":1590063630,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1590063630","product_id":100046801,"comment_content":"受益非浅，感谢老师","like_count":0},{"had_liked":false,"id":215172,"user_name":" 尿布","can_delete":false,"product_type":"c1","uid":1476323,"ip_address":"","ucode":"D1C8BDA7540962","user_header":"https://static001.geekbang.org/account/avatar/00/16/86/e3/a31f6869.jpg","comment_is_top":false,"comment_ctime":1588920423,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1588920423","product_id":100046801,"comment_content":"mark，很不错，学习了‘","like_count":0},{"had_liked":false,"id":214267,"user_name":"龙瑞","can_delete":false,"product_type":"c1","uid":1992000,"ip_address":"","ucode":"4F65235653EEE2","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/xyp6cZgwhrubOBZJathrtsQibJGCUr0Hc9S65gy3AS4gWoMCf2htBnl7RTgSTKLLkdjO3fB4aFAQS7Aj8gnopDA/132","comment_is_top":false,"comment_ctime":1588689590,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1588689590","product_id":100046801,"comment_content":"ABA在管理系统里面应该是最多的 那么应该用一个字段去标志 我喜欢用字段last_update_time 上次更新时间","like_count":0},{"had_liked":false,"id":206641,"user_name":"小洛","can_delete":false,"product_type":"c1","uid":1005062,"ip_address":"","ucode":"227EC21891012B","user_header":"https://static001.geekbang.org/account/avatar/00/0f/56/06/ea49b29d.jpg","comment_is_top":false,"comment_ctime":1586912719,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1586912719","product_id":100046801,"comment_content":"请教老师，目前单独请求订单号服务来做幂等，是具体什么样的业务下单场景会用到呢？抢购？秒杀？","like_count":0},{"had_liked":false,"id":206001,"user_name":"陆老师","can_delete":false,"product_type":"c1","uid":1203293,"ip_address":"","ucode":"0EA27C4755FF4A","user_header":"https://static001.geekbang.org/account/avatar/00/12/5c/5d/974b033f.jpg","comment_is_top":false,"comment_ctime":1586771355,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1586771355","product_id":100046801,"comment_content":"老师，关于防止重复下单，让前端获取一个唯一的订单号，插入订单时放入请求里。如果获取订单号这个服务因为一些原因失败重试了呢，第二次创建订单的请求和第一次，订单号不一样啊，实际上也创建了订单","like_count":0,"discussions":[{"author":{"id":1886331,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/c8/7b/153181d7.jpg","nickname":"夜辉","note":"","ucode":"9421385F51FF9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":365725,"discussion_content":"前面生成的订单号废弃就好了\n那就以后面的订单号为准，创建订单呀","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617871845,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":204692,"user_name":"窹寐","can_delete":false,"product_type":"c1","uid":1240246,"ip_address":"","ucode":"0FEDC0F0FADD2E","user_header":"https://static001.geekbang.org/account/avatar/00/12/ec/b6/1358f78f.jpg","comment_is_top":false,"comment_ctime":1586442839,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1586442839","product_id":100046801,"comment_content":"评论区和课程一样干货满满，赞","like_count":0},{"had_liked":false,"id":204427,"user_name":"励研冰","can_delete":false,"product_type":"c1","uid":1106394,"ip_address":"","ucode":"FCBC8266018FA0","user_header":"https://static001.geekbang.org/account/avatar/00/10/e1/da/d7f591a7.jpg","comment_is_top":false,"comment_ctime":1586398599,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1586398599","product_id":100046801,"comment_content":"我们当时在创建订单时考虑到同一个用户不可能存在并发问题的，所以在创建订单的时候会加分布式锁，同一时刻只会有一个传创建订单请求进来","like_count":0},{"had_liked":false,"id":204126,"user_name":"于浩源","can_delete":false,"product_type":"c1","uid":1945109,"ip_address":"","ucode":"11200E441D6E00","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/eIaRpVWt61ib14xDNkFa5xFFZqlQCOcuHgnuvacK0ksv5eBdotgruW3TnIBsCcFHcITD8JVCicefjPoCgV5GkY6g/132","comment_is_top":false,"comment_ctime":1586338067,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1586338067","product_id":100046801,"comment_content":"加锁也是一种不错的方法，处理好锁的粒度和竞争。","like_count":0,"discussions":[{"author":{"id":1236818,"avatar":"https://static001.geekbang.org/account/avatar/00/12/df/52/92389851.jpg","nickname":"hy","note":"","ucode":"666F4C56399C3B","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":271150,"discussion_content":"锁的话如果时多节点也没办法，得用分布式锁","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590082491,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":201123,"user_name":"菠萝吹雪—Code","can_delete":false,"product_type":"c1","uid":1650378,"ip_address":"","ucode":"A5B2FC661EE17D","user_header":"https://static001.geekbang.org/account/avatar/00/19/2e/ca/469f7266.jpg","comment_is_top":false,"comment_ctime":1585720121,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1585720121","product_id":100046801,"comment_content":"学习了","like_count":0},{"had_liked":false,"id":200773,"user_name":"小文同学","can_delete":false,"product_type":"c1","uid":1001893,"ip_address":"","ucode":"48F2AEB989C12A","user_header":"https://static001.geekbang.org/account/avatar/00/0f/49/a5/e4c1c2d4.jpg","comment_is_top":false,"comment_ctime":1585649222,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1585649222","product_id":100046801,"comment_content":"我自己编写的下单服务里，需要防止程序回调失败导致的多次回调，一般是在订单服务创建成功后返回订单号给客服端，回调客户端的时候通过这个订单号来进行判断以达到幂等。","like_count":0},{"had_liked":false,"id":200772,"user_name":"小文同学","can_delete":false,"product_type":"c1","uid":1001893,"ip_address":"","ucode":"48F2AEB989C12A","user_header":"https://static001.geekbang.org/account/avatar/00/0f/49/a5/e4c1c2d4.jpg","comment_is_top":false,"comment_ctime":1585649125,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1585649125","product_id":100046801,"comment_content":"小结一下自己学习成果：<br>文章是要解决的是创建、更新数据的准确性问题。<br>1、创建数据要考虑的问题是避免多建，方法是在提交订单页面上，前端先申请一个订单号作为主键，让数据库的冲突来自然解决多建问题。<br>2、ABA更新失败问题，原因是由于网络不稳定因素，导致重试等问题导致ABA更新失败。解决方法是给数据增加一个version字段。这有点乐观锁的意思。<br>分布式真的是直接把一个系统的复杂度拉到了几个级别啊，各种异常问题。","like_count":0},{"had_liked":false,"id":197086,"user_name":"ljr_bird","can_delete":false,"product_type":"c1","uid":1618685,"ip_address":"","ucode":"13D2885BA6CDFF","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/2QR4YBpeXgVXGXIfnibt80oLbjibIdp1c5ty5wbBTHvgheZRcLWDZAVklOpG2yjlDS2N3rZH66pDOvsvvqI2ic7icw/132","comment_is_top":false,"comment_ctime":1585357584,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1585357584","product_id":100046801,"comment_content":"看了老师这篇文章，反思了一下我们项目的订单业务在创建和修改状态时存在的问题。主要是修改状态，修改状态我们只是有分布式锁来保证了并发执行的顺序，保证修改只能一个个有顺序的执行，却不能解决aba这种问题，之后应该要把这个修改版本的标识加进来判断","like_count":0},{"had_liked":false,"id":194252,"user_name":"蹦～沙卡拉卡","can_delete":false,"product_type":"c1","uid":1100300,"ip_address":"","ucode":"DCA29164DD4669","user_header":"https://static001.geekbang.org/account/avatar/00/10/ca/0c/bbcdd6aa.jpg","comment_is_top":false,"comment_ctime":1585041847,"is_pvip":false,"replies":[{"id":"74080","content":"很多系统的做法是，订单号就是主键。<br><br>如果订单号不是主键，一般有业务含义的关联还是用订单号。","user_name":"作者回复","user_name_real":"李玥","uid":"1501046","ctime":1585099024,"ip_address":"","comment_id":194252,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1585041847","product_id":100046801,"comment_content":"老师，还有个问题，像订单表这类型的表，有个ID，还有个订单号，还有其他字段，如果我其他表要关联这个订单表，是关联订单ID好，还是关联订单号比较好呢？比如我的支付信息表。","like_count":0,"discussions":[{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":488793,"discussion_content":"很多系统的做法是，订单号就是主键。\n\n如果订单号不是主键，一般有业务含义的关联还是用订单号。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585099024,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1247124,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIUicDf5vnWPib22sugRBcES8lR3LibI3LfZrKqiabiczqeBVOhlCan8VNpVjK57gibmb58lYL68FY7nvFQ/132","nickname":"zhsoft","note":"","ucode":"573BF7C3676531","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":224545,"discussion_content":"订单编号不是主键的时候，如果用订单id做关联，后面分库分表的就不好玩了","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1586314588,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":193887,"user_name":"Darsen","can_delete":false,"product_type":"c1","uid":1157108,"ip_address":"","ucode":"2E8CB5FF43539E","user_header":"https://static001.geekbang.org/account/avatar/00/11/a7/f4/64785845.jpg","comment_is_top":false,"comment_ctime":1584977600,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1584977600","product_id":100046801,"comment_content":"分布式场景下是否存在强一致性？","like_count":0,"discussions":[{"author":{"id":2791739,"avatar":"https://static001.geekbang.org/account/avatar/00/2a/99/3b/acbc0986.jpg","nickname":"记忆不寒凉","note":"","ucode":"AC1D0AA0740803","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":400970,"discussion_content":"保证不了，要取舍，只能保证最终一致性，可以去看下CAP理论","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633506331,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":193336,"user_name":"J.Smile","can_delete":false,"product_type":"c1","uid":1336475,"ip_address":"","ucode":"C4D98DFDBF7584","user_header":"https://static001.geekbang.org/account/avatar/00/14/64/9b/0b578b08.jpg","comment_is_top":false,"comment_ctime":1584890241,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1584890241","product_id":100046801,"comment_content":"干货满满！","like_count":0},{"had_liked":false,"id":191721,"user_name":"cyl","can_delete":false,"product_type":"c1","uid":1620186,"ip_address":"","ucode":"6075FFED2111C9","user_header":"https://static001.geekbang.org/account/avatar/00/18/b8/da/1db53e48.jpg","comment_is_top":false,"comment_ctime":1584792316,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1584792316","product_id":100046801,"comment_content":"ABA问题：在工作中遇到过~我们在前台页面查询出版本号，然后做更新操作时会带上这个版本号，如果和数据库中存的版本号不一致，就去查询最新的版本号和数据。","like_count":0},{"had_liked":false,"id":190730,"user_name":"Tom.G","can_delete":false,"product_type":"c1","uid":1206034,"ip_address":"","ucode":"7929B45C1A51F8","user_header":"https://static001.geekbang.org/account/avatar/00/12/67/12/5c6eb568.jpg","comment_is_top":false,"comment_ctime":1584687881,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1584687881","product_id":100046801,"comment_content":"1.创建订单，重复提交订单<br>可以通过预先生成订单号（分布式环境下可以通过生成雪花Id等方式），然后利用数据库中订单号的唯一约束这个特性（可以把订单号设置为主键，或订单号设置为唯一值），避免重复写入订单，实现创建订单服务的幂等性<br><br>2.更新订单服务，解决ABA问题<br>可以通过一个版本号机制，每次更新数据前校验版本号，更新数据同时自增版本号","like_count":0},{"had_liked":false,"id":189631,"user_name":"小祺","can_delete":false,"product_type":"c1","uid":1193548,"ip_address":"","ucode":"2819BCA9E71C9F","user_header":"https://static001.geekbang.org/account/avatar/00/12/36/4c/46c43cce.jpg","comment_is_top":false,"comment_ctime":1584536314,"is_pvip":false,"replies":[{"id":"73116","content":"我们即将更新的11、12二节课就会讲如何解决这个问题。","user_name":"作者回复","user_name_real":"李玥","uid":"1501046","ctime":1584593048,"ip_address":"","comment_id":189631,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1584536314","product_id":100046801,"comment_content":"老师，如果下单量很大，每秒十几万，那下单请求直接打到数据库上扛得住吗？","like_count":0,"discussions":[{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":487752,"discussion_content":"我们即将更新的11、12二节课就会讲如何解决这个问题。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584593048,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":189065,"user_name":"小袁","can_delete":false,"product_type":"c1","uid":1811495,"ip_address":"","ucode":"3F5D8721F577D9","user_header":"https://static001.geekbang.org/account/avatar/00/1b/a4/27/15e75982.jpg","comment_is_top":false,"comment_ctime":1584452091,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1584452091","product_id":100046801,"comment_content":"老师，在业务上如何判断是同一个订单呢？这应该是依赖于客户端的缓存的吧？","like_count":0,"discussions":[{"author":{"id":1484192,"avatar":"https://static001.geekbang.org/account/avatar/00/16/a5/a0/e0cccf7e.jpg","nickname":"圆圆满满","note":"","ucode":"396E7A822014D1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":210831,"discussion_content":"订单号","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584779912,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":188218,"user_name":"朝阳","can_delete":false,"product_type":"c1","uid":1058537,"ip_address":"","ucode":"DD14181C1260AF","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI7Auf5Jy6ebh9wpPYMjz3bx5C7PG3MhOdQUUUGLk4ZJf5yCHnMcP8GEJywUo66rSJFsdMMgmogGA/132","comment_is_top":false,"comment_ctime":1584328352,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1584328352","product_id":100046801,"comment_content":"赞","like_count":0},{"had_liked":false,"id":184048,"user_name":"Jxin","can_delete":false,"product_type":"c1","uid":1251111,"ip_address":"","ucode":"4C03928388C413","user_header":"https://static001.geekbang.org/account/avatar/00/13/17/27/ec30d30a.jpg","comment_is_top":false,"comment_ctime":1583211848,"is_pvip":false,"replies":[{"id":"71298","content":"你可以举一个反例，我们一起讨论一下，是不是有什么情况加版本号也解决不了的。","user_name":"作者回复","user_name_real":"李玥","uid":"1501046","ctime":1583284105,"ip_address":"","comment_id":184048,"utype":1}],"discussion_count":6,"race_medal":0,"score":"1583211848","product_id":100046801,"comment_content":"1.加版本号并不能解决文中的问题吧。应该要保证更新成666和更新成888两个操作的顺序消费才能保证666的更新一定在前面。<br><br>2.加版本号是cas的一种常见实现（也可以根据更新日期）。其解决的问题应该是 防止 事务操作不可见带来的更新丢失。","like_count":0,"discussions":[{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":485866,"discussion_content":"你可以举一个反例，我们一起讨论一下，是不是有什么情况加版本号也解决不了的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583284105,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1251111,"avatar":"https://static001.geekbang.org/account/avatar/00/13/17/27/ec30d30a.jpg","nickname":"Jxin","note":"","ucode":"4C03928388C413","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":195527,"discussion_content":"假设666前面还有个更新555的操作，且当下数据库负载高处理比较慢，那么666的更新操作和888的更新操作就可能同时等待555的操作结束，这时候666和888谁先执行就不一定了，是可能888的操作先开启事务的。（也可能666操作路由到服务器负载高导致执行延后，888路由到的服务器直接执行，这样888也会在前面。）（假设两个操作在同个进程里面执行，666的线程a和888的线程b谁先走到数据库开启事务这一步也不是一定的，仍然有可能888的线程b先到）","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1583285973,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1275098,"avatar":"https://static001.geekbang.org/account/avatar/00/13/74/da/44fe2db8.jpg","nickname":"周宁","note":"","ucode":"9816F796252948","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1251111,"avatar":"https://static001.geekbang.org/account/avatar/00/13/17/27/ec30d30a.jpg","nickname":"Jxin","note":"","ucode":"4C03928388C413","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":205852,"discussion_content":"这个问题的关键就是“版本号”，而你的问题描述中只字未提“版本号”，建议您回去仔细重温一下文中关于ABA问题的讨论中出现“版本号”的地方～","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584350462,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":195527,"ip_address":""},"score":205852,"extra":""},{"author":{"id":1886331,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/c8/7b/153181d7.jpg","nickname":"夜辉","note":"","ucode":"9421385F51FF9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1251111,"avatar":"https://static001.geekbang.org/account/avatar/00/13/17/27/ec30d30a.jpg","nickname":"Jxin","note":"","ucode":"4C03928388C413","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":365728,"discussion_content":"这个数据的一致性表现在，以获取的版本号表示时间，\n如果同时并发，只会更新一个数据，\n如果有先后顺序，最终结果会是后一个，\n重复请求不会改变其结果，因为版本号会小于最新的版本号","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617872159,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":195527,"ip_address":""},"score":365728,"extra":""}]},{"author":{"id":1203293,"avatar":"https://static001.geekbang.org/account/avatar/00/12/5c/5d/974b033f.jpg","nickname":"陆老师","note":"","ucode":"0EA27C4755FF4A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":230796,"discussion_content":"确实，文中说最后要更新成888，如果888的请求先到，最后还是会更新成666.但我们最终还是想要更新成888的，所以应当有个顺序保证，就888一定要在666后面更新成功","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586773142,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1005381,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/57/45/c418ea5c.jpg","nickname":"指尖流逝","note":"","ucode":"417009F674FAF1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":196082,"discussion_content":"有道理","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583329609,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":183958,"user_name":"Eclipse","can_delete":false,"product_type":"c1","uid":1589989,"ip_address":"","ucode":"E7EB0BA99FA644","user_header":"https://static001.geekbang.org/account/avatar/00/18/42/e5/61cfe267.jpg","comment_is_top":false,"comment_ctime":1583168814,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1583168814","product_id":100046801,"comment_content":"插入幂等 用主键唯一性约束<br>更新幂等，防止aba，使用版本号控制先读取版本号，更新的时候同一版本则更新 类似cas","like_count":0},{"had_liked":false,"id":183462,"user_name":"不记年","can_delete":false,"product_type":"c1","uid":1045945,"ip_address":"","ucode":"287E40C68356DC","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f5/b9/888fe350.jpg","comment_is_top":false,"comment_ctime":1583046218,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1583046218","product_id":100046801,"comment_content":"订单ID也可以在前端生成吧，可以减少一次网络调用，不过会不会有ID生产算法暴露的风险","like_count":0,"discussions":[{"author":{"id":1886331,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/c8/7b/153181d7.jpg","nickname":"夜辉","note":"","ucode":"9421385F51FF9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":365729,"discussion_content":"不能保证唯一，\n而且把这个逻辑加入到前端，感觉很容易遭受攻击，我用自定义的值代替你生成的值","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617872257,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1386315,"avatar":"https://static001.geekbang.org/account/avatar/00/15/27/4b/e49c82d0.jpg","nickname":"Rover","note":"","ucode":"7575EC91F45B99","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":193193,"discussion_content":"用户下单这个过程多产生一次网络调用而耗费的性能我觉得可以忽略不计。我经历的公司来看，主键服务都是由基础架构部单独提供的一套服务，不知道前端是否也可以这样操作。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583136987,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":183063,"user_name":"GeekAmI","can_delete":false,"product_type":"c1","uid":1005030,"ip_address":"","ucode":"232C0B6DFB9F56","user_header":"https://static001.geekbang.org/account/avatar/00/0f/55/e6/87197b10.jpg","comment_is_top":false,"comment_ctime":1582946470,"is_pvip":false,"replies":[{"id":"71080","content":"你可以参考一下我在《消息队列高手课》中的[这节课](https:&#47;&#47;time.geekbang.org&#47;column&#47;article&#47;111552?utm_term=zeus7N1US&amp;utm_source=geektime&amp;utm_medium=app)，里面讲到了一些更通用的实现幂等等方法。","user_name":"作者回复","user_name_real":"李玥","uid":"1501046","ctime":1583114263,"ip_address":"","comment_id":183063,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1582946470","product_id":100046801,"comment_content":"请问老师，服务与服务之间调用的幂等性如何做?总不能要求A服务调用B之前，先请求一个唯一ID吧","like_count":0,"discussions":[{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":485553,"discussion_content":"你可以参考一下我在《消息队列高手课》中的[这节课](https://time.geekbang.org/column/article/111552?utm_term=zeus7N1US&amp;amp;utm_source=geektime&amp;amp;utm_medium=app)，里面讲到了一些更通用的实现幂等等方法。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583114263,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":182780,"user_name":"电光火石","can_delete":false,"product_type":"c1","uid":1013160,"ip_address":"","ucode":"3AD33BB4AA940F","user_header":"https://static001.geekbang.org/account/avatar/00/0f/75/a8/dfe4cade.jpg","comment_is_top":false,"comment_ctime":1582865012,"is_pvip":false,"discussion_count":3,"race_medal":0,"score":"1582865012","product_id":100046801,"comment_content":"总结：<br>网络的不稳定会带来重试，如果保证接口的幂等性：<br>1. 插入的时候，通过业务主键来保持数据库的唯一性，进而保证接口的幂等性<br>2. 更新的时候，通过乐观锁来保证操作的幂等性<br><br>在插入的时候，一般前面会加一个缓存，现在缓存中做判断，不然直接访问数据库，有可能会把数据库打死。不知道是否还有其他的方案可以做参考？谢谢！","like_count":0,"discussions":[{"author":{"id":1003515,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/4f/fb/10366b97.jpg","nickname":"Henry","note":"","ucode":"54AFE9C99B31B4","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":190621,"discussion_content":"感觉插入一般不会走缓存吧，因为在这个请求过程中数据是一定要插入到数据库避免不了的，那么加缓存的目的是什么呢？感觉还没见过写要走缓存的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582966605,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1048367,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ff/2f/172b942b.jpg","nickname":"扬帆起航","note":"","ucode":"708B686F19B8DE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1003515,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/4f/fb/10366b97.jpg","nickname":"Henry","note":"","ucode":"54AFE9C99B31B4","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":191788,"discussion_content":"他的意思是说在缓存中判断此订单号是否存在 , 存在的话就不插入了 .  防止数据库压力过大 ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583035014,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":190621,"ip_address":""},"score":191788,"extra":""},{"author":{"id":1003515,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/4f/fb/10366b97.jpg","nickname":"Henry","note":"","ucode":"54AFE9C99B31B4","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1048367,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ff/2f/172b942b.jpg","nickname":"扬帆起航","note":"","ucode":"708B686F19B8DE","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":193627,"discussion_content":"我是觉得没必要，因为重复插入的概率极小极小，所以读了 cache 基本上请求还是要到数据库，这层 cache 感觉就没必要了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583158830,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":191788,"ip_address":""},"score":193627,"extra":""}]}]},{"had_liked":false,"id":182711,"user_name":"观弈道人","can_delete":false,"product_type":"c1","uid":1016905,"ip_address":"","ucode":"F3BB619A33C605","user_header":"https://static001.geekbang.org/account/avatar/00/0f/84/49/47d48fd0.jpg","comment_is_top":false,"comment_ctime":1582854317,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1582854317","product_id":100046801,"comment_content":"用心了，李老师这是要打造爆款的节奏","like_count":0},{"had_liked":false,"id":182614,"user_name":"Spring coming","can_delete":false,"product_type":"c1","uid":1116196,"ip_address":"","ucode":"9E01F2D987D08B","user_header":"https://static001.geekbang.org/account/avatar/00/11/08/24/1d3bafaf.jpg","comment_is_top":false,"comment_ctime":1582815857,"is_pvip":false,"replies":[{"id":"70683","content":"这里面的调用方有可能APP，也有可能是某个后端服务，我们不用去纠结这个，很多RPC框架或者网关都有这种“超时或失败重试”的机制。","user_name":"作者回复","user_name_real":"李玥","uid":"1501046","ctime":1582860161,"ip_address":"","comment_id":182614,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1582815857","product_id":100046801,"comment_content":"谢谢老师的回答，除了压测外，还有什么方式是比较容易模拟的呢？我对文章中的&quot;但是 666 更新成功的响应丢了，调用方没收到成功响应，自动重试，再次发起 666 请求&quot;有点没理解，这里边的&quot;调用方&quot;是指的前端业务实现的超时重试还是http协议中有重试机制？","like_count":0,"discussions":[{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":485386,"discussion_content":"这里面的调用方有可能APP，也有可能是某个后端服务，我们不用去纠结这个，很多RPC框架或者网关都有这种“超时或失败重试”的机制。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582860161,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2377406,"avatar":"","nickname":"杨毅","note":"","ucode":"189923D892549F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":339858,"discussion_content":"dubbo这种rpc框架，超时就会有重试机制","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609826316,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":182306,"user_name":"飞翔","can_delete":false,"product_type":"c1","uid":1068571,"ip_address":"","ucode":"65AF6AF292DAD6","user_header":"https://static001.geekbang.org/account/avatar/00/10/4e/1b/f4b786b9.jpg","comment_is_top":false,"comment_ctime":1582766537,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1582766537","product_id":100046801,"comment_content":"老师 能不能 给这几个表的字段和给个具体例子","like_count":0},{"had_liked":false,"id":182213,"user_name":"覃钰栋","can_delete":false,"product_type":"c1","uid":1251835,"ip_address":"","ucode":"19080C463658EF","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/oiboHpgukqib2ASXeU0H7W1ibgRMqyrNE5KaWicicPEDy0ia8YdoneZAtvW0EFIiaqZJp2OS4dnweOgXaJ5EjJicicEqic5A/132","comment_is_top":false,"comment_ctime":1582729786,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1582729786","product_id":100046801,"comment_content":"又学到了两种处理幂等方式","like_count":0},{"had_liked":false,"id":182108,"user_name":"铁生","can_delete":false,"product_type":"c1","uid":1289309,"ip_address":"","ucode":"7FE82505855CB8","user_header":"https://static001.geekbang.org/account/avatar/00/13/ac/5d/7cfded43.jpg","comment_is_top":false,"comment_ctime":1582710581,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1582710581","product_id":100046801,"comment_content":"老师不说，头像要按吴彦祖来嘛，这也没换啊，哈哈哈。","like_count":0,"discussions":[{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":186745,"discussion_content":"看我头像，哈哈。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1582711328,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}