{"id":201162,"title":"28 | 工作单元模式（UnitOfWork）：管理好你的事务","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/NET-Core\">https://gitee.com/geektime-geekbang/NET-Core</a></p>","comments":[{"had_liked":false,"id":216457,"user_name":"峰","can_delete":false,"product_type":"c3","uid":1390326,"ip_address":"","ucode":"527BB65559F0B0","user_header":"https://static001.geekbang.org/account/avatar/00/15/36/f6/d65b7302.jpg","comment_is_top":false,"comment_ctime":1589263161,"is_pvip":false,"replies":[{"id":80581,"content":"一对一的关系","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1589682347,"ip_address":"","comment_id":216457,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"请问，一个unitofwork对应一个xxxDbContext吗？还是一个unitofwork可以对应多个xxxDbContext?","like_count":1,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":494825,"discussion_content":"一对一的关系","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589682347,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":181585,"user_name":"Geek_d38f30","can_delete":false,"product_type":"c3","uid":1512147,"ip_address":"","ucode":"955D6480731336","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/ib1aca6ibMC3bcTZeVdTFalyyhdvy4DLQ7s4WBTWaw95k8IJNTUkZ5VwfB9rYwxVz3PAz4chBJhWcyMHib9KdEEnQ/132","comment_is_top":false,"comment_ctime":1582573243,"is_pvip":false,"replies":[{"id":70452,"content":"事务的目的是一致性，如果是非重要的业务，不要求强一致性，可以不用事务，做异常补偿也可以","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1582690457,"ip_address":"","comment_id":181585,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"使用同一上下文：相同的context和相同的事务\n跟踪实体的状态：跟踪sql命令，异常会报错\n保障事务一致性：例如10句sql,后面第六行报错了，前面的5行运行结果会回滚\n事务的效率问题，老觉得锁表是因为事务？\n简单或者非重要的业务，可以不使用事务？","like_count":1,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":485043,"discussion_content":"事务的目的是一致性，如果是非重要的业务，不要求强一致性，可以不用事务，做异常补偿也可以","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582690457,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":213836,"discussion_content":"建议在同一进程内，还是要考虑数据的强一致性的，人为的提升实现难度，得不偿失。当然这也要看场景，但通常的做法肯定是进程内的一致性事务。另外对于数据库的锁来说，应该是行锁，而不是表锁。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1585126333,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":180987,"user_name":"阿冲","can_delete":false,"product_type":"c3","uid":1062514,"ip_address":"","ucode":"06BF66D9009659","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKg7RjNMzSrIwUnjYstbdicVv5MawrQLTHc6rdpwm0Q04b7icj7eAb0F8zSxe8gmM99QBvTECK5KvrQ/132","comment_is_top":false,"comment_ctime":1582453594,"is_pvip":false,"replies":[{"id":70461,"content":"服务中注入ITransaction，显示调用BeginTransactionAsync","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1582691552,"ip_address":"","comment_id":180987,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"请问老师,如果我要开启事务，在哪儿显式调用呢？","like_count":1,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":484879,"discussion_content":"服务中注入ITransaction，显示调用BeginTransactionAsync","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582691552,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1062514,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKg7RjNMzSrIwUnjYstbdicVv5MawrQLTHc6rdpwm0Q04b7icj7eAb0F8zSxe8gmM99QBvTECK5KvrQ/132","nickname":"阿冲","note":"","ucode":"06BF66D9009659","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":186964,"discussion_content":"public static IServiceCollection AddMediatRServices(this IServiceCollection services)\n        {\n            services.AddTransient(typeof(IPipelineBehavior<,>), typeof(DomainContextTransactionBehavior<,>));\n            return services.AddMediatR(typeof(Order).Assembly, typeof(Program).Assembly);\n        }\n\n老师，请问这里注册了IPipelineBehavior，目标是事务的管理。注册完了这个怎么使用呢，有代码可以演示吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582722557,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1062514,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKg7RjNMzSrIwUnjYstbdicVv5MawrQLTHc6rdpwm0Q04b7icj7eAb0F8zSxe8gmM99QBvTECK5KvrQ/132","nickname":"阿冲","note":"","ucode":"06BF66D9009659","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":213837,"discussion_content":"为啥要显示的来开启呢，unitofwork以及transactionbehavior本身就是对于数据库及事务的操作做了封装，对于使用有天然的透明性，避免开启事务，而不提交事务或者回滚事务的情况的出现，避免数据库层面锁的出现。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585126457,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":186964,"ip_address":"","group_id":0},"score":213837,"extra":""}]}]},{"had_liked":false,"id":180600,"user_name":"木风","can_delete":false,"product_type":"c3","uid":1339677,"ip_address":"","ucode":"3BAA80C2F1FB68","user_header":"https://static001.geekbang.org/account/avatar/00/14/71/1d/8d1d27b2.jpg","comment_is_top":false,"comment_ctime":1582347582,"is_pvip":false,"replies":[{"id":70502,"content":"这里是指：确保对业务对象的多个操作要么都生效，要么都失败","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1582718001,"ip_address":"","comment_id":180600,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"老师可以展开解析一下工作单元的三个特性吗，比如“保障事务一致性”怎么理解","like_count":1,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":484728,"discussion_content":"这里是指：确保对业务对象的多个操作要么都生效，要么都失败","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582718001,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":213838,"discussion_content":"savechanges是针对单表的单事务操作，如果对多表来说是同一个事务，那还是要做开启事务的声明和操作的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585126519,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":216102,"user_name":"Geek_ae287d","can_delete":false,"product_type":"c3","uid":1974714,"ip_address":"","ucode":"7B627A8B1EF9FE","user_header":"","comment_is_top":false,"comment_ctime":1589190348,"is_pvip":false,"replies":[{"id":80617,"content":"IsTransient \n返回true表示未持久化\n因为它的id与id类型的默认值相等，例如0。\n代码中的default表示id类型的默认值","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1589686427,"ip_address":"","comment_id":216102,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"咨询一下  public bool IsTransient()\n        {\n            return EqualityComparer&lt;TKey&gt;.Default.Equals(Id, default);\n        }\n这个方法如果返回true 表示不是持久化的   还是 如果方法返回true 表示持久化  \n public override bool Equals(object obj)\n        {\n            if (obj == null || !(obj is Entity&lt;TKey&gt;))\n                return false;\n\n            if (Object.ReferenceEquals(this, obj))\n                return true;\n\n            if (this.GetType() != obj.GetType())\n                return false;\n\n            Entity&lt;TKey&gt; item = (Entity&lt;TKey&gt;)obj;\n\n            if (item.IsTransient() || this.IsTransient())\n                return false;\n            else\n                return item.Id.Equals(this.Id);\n        }\n","like_count":0,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":494670,"discussion_content":"IsTransient \n返回true表示未持久化\n因为它的id与id类型的默认值相等，例如0。\n代码中的default表示id类型的默认值","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589686427,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":337011,"user_name":"张祈璟","can_delete":false,"product_type":"c3","uid":1400950,"ip_address":"","ucode":"DC7DDB3881633F","user_header":"https://static001.geekbang.org/account/avatar/00/15/60/76/be584def.jpg","comment_is_top":false,"comment_ctime":1646551403,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"既然commit方法中要求传入的事务对象与当前的事务对象必须是同一个，为什么不去掉这个参数，直接在内部用当前这个事务对象呢？","like_count":0},{"had_liked":false,"id":265039,"user_name":"布凡","can_delete":false,"product_type":"c3","uid":1202465,"ip_address":"","ucode":"346FCD332F8BFA","user_header":"https://static001.geekbang.org/account/avatar/00/12/59/21/d2efde18.jpg","comment_is_top":false,"comment_ctime":1606742479,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"工作单元模式：\n1、使用同一上下文\n2、跟踪实体状态\n3、保障事务一致性","like_count":0},{"had_liked":false,"id":195269,"user_name":"Chris","can_delete":false,"product_type":"c3","uid":1680073,"ip_address":"","ucode":"518955CBA4EFA0","user_header":"https://static001.geekbang.org/account/avatar/00/19/a2/c9/99c2161c.jpg","comment_is_top":false,"comment_ctime":1585151626,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"老师，事务中的next不是必现的吧？","like_count":0}]}