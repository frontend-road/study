{"id":222373,"title":"08 | Istio的自我救赎：为什么Istio发生了两次重大的架构变更？","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/geektime-servicemesh\">https://gitee.com/geektime-geekbang/geektime-servicemesh</a></p>","comments":[{"had_liked":false,"id":206457,"user_name":"百行吴书","can_delete":false,"product_type":"c3","uid":1806261,"ip_address":"","ucode":"3DFCBBEBCA9A4B","user_header":"https://static001.geekbang.org/account/avatar/00/1b/8f/b5/7bc42adc.jpg","comment_is_top":false,"comment_ctime":1586864281,"is_pvip":false,"replies":[{"id":77252,"content":"&quot;只有了解了它的过去，才能理解它的未来及使命。&quot; ~ 说的很好！也感谢认可！","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1586954634,"ip_address":"","comment_id":206457,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"只有了解了它的过去，才能理解它的未来及使命。还有老师快点更新啦，在开发的项目就是基于istio。（遗憾的是项目可能会被裁掉或减少投入，因为市场还不成熟，但相信明年istio的产品落地将会爆发）","like_count":4,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":491798,"discussion_content":"&amp;quot;只有了解了它的过去，才能理解它的未来及使命。&amp;quot; ~ 说的很好！也感谢认可！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586954634,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":283504,"user_name":"xcbeyond","can_delete":false,"product_type":"c3","uid":1585810,"ip_address":"","ucode":"96150D447BECF7","user_header":"https://static001.geekbang.org/account/avatar/00/18/32/92/8247f434.jpg","comment_is_top":false,"comment_ctime":1615800630,"is_pvip":false,"replies":[{"id":102861,"content":"整个控制面整合成了单体，istiod就是暴露出来的进程，citedal这些原本的独立进程都整合进去以功能模块的形式存在。可以看一下源码结构能大概知道一二。","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1615818224,"ip_address":"","comment_id":283504,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"在最新版本istio中，早已将Citadel组件合并到istiod中了，但从istiod Pod中去看，只有discovery容器（pilot），并没有Citadel容器。目前Citadel只是作为一个概念存在么，并不单独存在，或者是什么样的，比如这些组件(Citadel、Galley) 我在实际使用时，从哪块能直观的体现出来等？","like_count":2,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":517058,"discussion_content":"整个控制面整合成了单体，istiod就是暴露出来的进程，citedal这些原本的独立进程都整合进去以功能模块的形式存在。可以看一下源码结构能大概知道一二。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1615818224,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1585810,"avatar":"https://static001.geekbang.org/account/avatar/00/18/32/92/8247f434.jpg","nickname":"xcbeyond","note":"","ucode":"96150D447BECF7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":357740,"discussion_content":"源码已经看过一部分，的确是这样的。可能源于历史版本原因，对于istiod的中Pilot、Citadel、Galley这些功能，再叫做组件，就有些不太合适了吧，叫做相应功能模块应该更确切些了，这可能就是版本过度阶段","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1615859550,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":206908,"user_name":"008","can_delete":false,"product_type":"c3","uid":1164003,"ip_address":"","ucode":"E1D9D91E18208A","user_header":"https://static001.geekbang.org/account/avatar/00/11/c2/e3/df7447ff.jpg","comment_is_top":false,"comment_ctime":1586955704,"is_pvip":false,"replies":[{"id":77399,"content":"谢谢认可😋","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1587025730,"ip_address":"","comment_id":206908,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"两倍速过了一遍，非常有兴趣，虽然很可能不会具体实践，但一直认为Sidecar模式可以解决我们老旧系统的一些控制问题，我们也一直在这方面发力，学习service mesh的理念也可以有助于我们对现有基础设施层进行更清晰的定义。","like_count":1,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":491946,"discussion_content":"谢谢认可😋","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587025730,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":206048,"user_name":"我来也","can_delete":false,"product_type":"c3","uid":1205253,"ip_address":"","ucode":"773D6104F56767","user_header":"https://static001.geekbang.org/account/avatar/00/12/64/05/6989dce6.jpg","comment_is_top":false,"comment_ctime":1586779909,"is_pvip":false,"replies":[{"id":77150,"content":"谢谢认可😀","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1586870351,"ip_address":"","comment_id":206048,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"哈哈，老师的比喻很形象。\n前面的版本比较，拿F22和三代机型比较。\n后面的mvp，拿顿挫和烧机油举例，很形象生动。","like_count":1,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":491651,"discussion_content":"谢谢认可😀","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586870351,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":205804,"user_name":"朱晔","can_delete":false,"product_type":"c3","uid":1001470,"ip_address":"","ucode":"0B7F0BADE6AAB8","user_header":"https://static001.geekbang.org/account/avatar/00/0f/47/fe/d0e25d57.jpg","comment_is_top":false,"comment_ctime":1586742023,"is_pvip":false,"replies":[{"id":76942,"content":"感谢朱老师的认可！😋","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1586771176,"ip_address":"","comment_id":205804,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"说的非常好","like_count":1,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":491587,"discussion_content":"感谢朱老师的认可！😋","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586771176,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":236872,"user_name":"Geek_66dcc6","can_delete":false,"product_type":"c3","uid":1317851,"ip_address":"","ucode":"0EC9C087C5008B","user_header":"","comment_is_top":false,"comment_ctime":1595573382,"is_pvip":false,"replies":[{"id":87816,"content":"报什么错？贴一下配置。排除法先用最简单的例子试，慢慢加","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1595935363,"ip_address":"","comment_id":236872,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"谢谢老师，但是我在部署istio1.6 后，发现解析jwt  并添加到http header 这个rule 功能并不能用，用示例也是不能用的，不知道您那边有遇到过吗。因为目前 插件形式1.6 支持的并不好，想先用之前的rule 的方式过渡一下，谢谢您的指导\n\n-----------------------------------------------------------------\n老师您好，在mixer 这个问题上，我有个疑问，因为istio 1.5 已经废弃掉这个应用，在文档https:&#47;&#47;istio.io&#47;latest&#47;docs&#47;tasks&#47;policy-enforcement&#47;control-headers&#47;#request-header-operations 中，我有试过用推荐的envoy 的插件尝试加header，但是目前插件那边只支持1.5 版本，而我部署的是1.6 版本，所以我想继续用连接中adapter 的方式增加rule ，我想问下，官方说废弃掉，是以后不继续更新mixer，但是目前还可以使用？还是目前1.6 的版本完全不支持这种部署方式了呢，因为我查看kubectl -n istio-system get cm istio -o jsonpath=&quot;{@.data.mesh}&quot; | grep disablePolicyChecks\n结果是disablePolicyChecks: false，所以1.6版本目前还是支持policy的方式\n作者回复: 是的，肯定有一定的兼容期，不可能一下就废弃掉，这会让一部分用户没法迁移到新版本。据说是到1.7版本会彻底废弃。","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":502236,"discussion_content":"报什么错？贴一下配置。排除法先用最简单的例子试，慢慢加","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595935363,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1317851,"avatar":"","nickname":"Geek_66dcc6","note":"","ucode":"0EC9C087C5008B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":298141,"discussion_content":"通过写插件的方式已经写好了，目前1.6的文档对于rule这一块写的有问题，policy的开关方式不对，导致policy没有真正开启","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597202654,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":236281,"user_name":"Geek_66dcc6","can_delete":false,"product_type":"c3","uid":1317851,"ip_address":"","ucode":"0EC9C087C5008B","user_header":"","comment_is_top":false,"comment_ctime":1595383854,"is_pvip":false,"replies":[{"id":87524,"content":"是的，肯定有一定的兼容期，不可能一下就废弃掉，这会让一部分用户没法迁移到新版本。据说是到1.7版本会彻底废弃。","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1595571805,"ip_address":"","comment_id":236281,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"老师您好，在mixer 这个问题上，我有个疑问，因为istio 1.5 已经废弃掉这个应用，在文档https:&#47;&#47;istio.io&#47;latest&#47;docs&#47;tasks&#47;policy-enforcement&#47;control-headers&#47;#request-header-operations 中，我有试过用推荐的envoy 的插件尝试加header，但是目前插件那边只支持1.5 版本，而我部署的是1.6 版本，所以我想继续用连接中adapter 的方式增加rule ，我想问下，官方说废弃掉，是以后不继续更新mixer，但是目前还可以使用？还是目前1.6 的版本完全不支持这种部署方式了呢，因为我查看kubectl -n istio-system get cm istio -o jsonpath=&quot;{@.data.mesh}&quot; | grep disablePolicyChecks\n结果是disablePolicyChecks: false，所以1.6版本目前还是支持policy的方式\n","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":502013,"discussion_content":"是的，肯定有一定的兼容期，不可能一下就废弃掉，这会让一部分用户没法迁移到新版本。据说是到1.7版本会彻底废弃。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595571805,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":207477,"user_name":"szpzs","can_delete":false,"product_type":"c3","uid":1031994,"ip_address":"","ucode":"4F35103E5D9B26","user_header":"https://static001.geekbang.org/account/avatar/00/0f/bf/3a/bbcbc278.jpg","comment_is_top":false,"comment_ctime":1587090974,"is_pvip":false,"replies":[{"id":77516,"content":"参考我在部落的回答，这里面有官方的解释：https:&#47;&#47;horde.geekbang.org&#47;message&#47;detail&#47;UQUvVF3G3wTcu9L8ARUhk9l8vhbaTASyI1XlXDPM9jQ?tab=0\n你可以理解为只要有请求流经sidecar，这个sidecar就需要和mixer进行2次通信。不过1.5版本后mixer已经废弃了，可以不必纠结这个问题。","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1587110186,"ip_address":"","comment_id":207477,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"请问马老师，关于“Istio 中的 Mixer 需要和数据平面进行两次通讯，具体是那两次通讯呢？”这个问题，我还是有些疑惑。这两次通讯是在请求方的sidecar里发起的，还是在服务方的sidecar里发起的？或者说，预检是在请求方的sidecar里发起，遥测是在服务方的sidecar里发起？请马老师指点迷津。","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492144,"discussion_content":"参考我在部落的回答，这里面有官方的解释：https://horde.geekbang.org/message/detail/UQUvVF3G3wTcu9L8ARUhk9l8vhbaTASyI1XlXDPM9jQ?tab=0\n你可以理解为只要有请求流经sidecar，这个sidecar就需要和mixer进行2次通信。不过1.5版本后mixer已经废弃了，可以不必纠结这个问题。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587110186,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":206935,"user_name":"dream","can_delete":false,"product_type":"c3","uid":1117793,"ip_address":"","ucode":"65B33D32FA8BE9","user_header":"https://static001.geekbang.org/account/avatar/00/11/0e/61/ae68f8eb.jpg","comment_is_top":false,"comment_ctime":1586959579,"is_pvip":false,"replies":[{"id":77398,"content":"参考这里：https:&#47;&#47;istio.io&#47;docs&#47;reference&#47;config&#47;policy-and-telemetry&#47;mixer-overview&#47;\n“The Envoy sidecar logically calls Mixer before each request to perform precondition checks, and after each request to report telemetry. ” - 两次分别是预检和遥测。预检的时候可以做限流；遥测的时候收集指标数据，这也正好对应mixer的两个核心功能。","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1587025642,"ip_address":"","comment_id":206935,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"老师，请问一下，在 1.0 版本中有提到 mixer 有一个问题是性能，降低了性能的原因之一是 : mixer 需要和数据平面进行两次通讯，请问这里为什么是两次通讯呢？具体是那两次通讯呢？","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":491957,"discussion_content":"参考这里：https://istio.io/docs/reference/config/policy-and-telemetry/mixer-overview/\n“The Envoy sidecar logically calls Mixer before each request to perform precondition checks, and after each request to report telemetry. ” - 两次分别是预检和遥测。预检的时候可以做限流；遥测的时候收集指标数据，这也正好对应mixer的两个核心功能。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587025642,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":205781,"user_name":"思维决定未来","can_delete":false,"product_type":"c3","uid":1412891,"ip_address":"","ucode":"88CC245B3C6E2D","user_header":"","comment_is_top":false,"comment_ctime":1586738689,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"不够看啊，求快更","like_count":6},{"had_liked":false,"id":358154,"user_name":"JianXu","can_delete":false,"product_type":"c3","uid":1033219,"ip_address":"上海","ucode":"2A61BDBB573BDC","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c4/03/f753fda7.jpg","comment_is_top":false,"comment_ctime":1663978524,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100049401,"comment_content":"老师学圣经？","like_count":0},{"had_liked":false,"id":290161,"user_name":"💰💰💰","can_delete":false,"product_type":"c3","uid":2580393,"ip_address":"","ucode":"BAF5D7DBE496FA","user_header":"https://static001.geekbang.org/account/avatar/00/27/5f/a9/18573ff6.jpg","comment_is_top":false,"comment_ctime":1619408604,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100049401,"comment_content":"老师能不能提供教程的pdf版本，视频有时候会不太方便看","like_count":0},{"had_liked":false,"id":283503,"user_name":"xcbeyond","can_delete":false,"product_type":"c3","uid":1585810,"ip_address":"","ucode":"96150D447BECF7","user_header":"https://static001.geekbang.org/account/avatar/00/18/32/92/8247f434.jpg","comment_is_top":false,"comment_ctime":1615800509,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100049401,"comment_content":"您好。有几个问题 向您请教一下，最近在接触Istio时，存在一些关于各组件间的划分及关系，比较混乱（最近版本 1.9）。","like_count":0},{"had_liked":false,"id":205962,"user_name":"Ckiwis","can_delete":false,"product_type":"c3","uid":1038372,"ip_address":"","ucode":"E59B57FF70650B","user_header":"https://static001.geekbang.org/account/avatar/00/0f/d8/24/499e7c99.jpg","comment_is_top":false,"comment_ctime":1586764392,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100049401,"comment_content":"加油更","like_count":0}]}