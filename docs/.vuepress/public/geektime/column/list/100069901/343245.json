{"id":343245,"title":"13 | dbå¤§å°ï¼šä¸ºä»€ä¹ˆetcdç¤¾åŒºå»ºè®®dbå¤§å°ä¸è¶…è¿‡8Gï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å”èªã€‚</p><p>åœ¨<a href=\"https://time.geekbang.org/column/article/336766\">03</a>å†™æµç¨‹ä¸­æˆ‘å’Œä½ åˆ†äº«äº†etcd Quotaæ¨¡å—ï¼Œé‚£ä¹ˆetcdä¸ºä»€ä¹ˆéœ€è¦å¯¹dbå¢åŠ Quotaé™åˆ¶ï¼Œä»¥åŠä¸å»ºè®®ä½ çš„etcdé›†ç¾¤dbå¤§å°è¶…è¿‡8Gå‘¢ï¼Ÿ è¿‡å¤§çš„dbæ–‡ä»¶å¯¹é›†ç¾¤æ€§èƒ½å’Œç¨³å®šæ€§æœ‰å“ªäº›å½±å“ï¼Ÿ</p><p>ä»Šå¤©æˆ‘è¦å’Œä½ åˆ†äº«çš„ä¸»é¢˜å°±æ˜¯å…³äºdbå¤§å°ã€‚æˆ‘å°†é€šè¿‡ä¸€ä¸ªå¤§æ•°æ®é‡çš„etcdé›†ç¾¤ä¸ºæ¡ˆä¾‹ï¼Œä¸ºä½ å‰–æetcd dbå¤§å°é…é¢é™åˆ¶èƒŒåçš„è®¾è®¡æ€è€ƒå’Œè¿‡å¤§çš„dbæ½œåœ¨éšæ‚£ã€‚</p><p>å¸Œæœ›é€šè¿‡è¿™èŠ‚è¯¾ï¼Œå¸®åŠ©ä½ ç†è§£å¤§æ•°æ®é‡å¯¹é›†ç¾¤çš„å„ä¸ªæ¨¡å—çš„å½±å“ï¼Œé…ç½®åˆç†çš„db Quotaå€¼ã€‚åŒæ—¶ï¼Œå¸®åŠ©ä½ åœ¨å®é™…ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œéµå¾ªæœ€ä½³å®è·µï¼Œå°½é‡å‡å°‘valueå¤§å°å’Œå¤§key-valueæ›´æ–°é¢‘ç‡ï¼Œé¿å…dbæ–‡ä»¶å¤§å°ä¸æ–­å¢é•¿ã€‚</p><h2>åˆ†ææ•´ä½“æ€è·¯</h2><p>ä¸ºäº†å¸®åŠ©ä½ ç›´è§‚åœ°ç†è§£å¤§æ•°æ®é‡å¯¹é›†ç¾¤ç¨³å®šæ€§çš„å½±å“ï¼Œæˆ‘é¦–å…ˆå°†ä¸ºä½ å†™å…¥å¤§é‡æ•°æ®ï¼Œæ„é€ ä¸€ä¸ªdbå¤§å°ä¸º14Gçš„å¤§é›†ç¾¤ã€‚ç„¶åé€šè¿‡æ­¤é›†ç¾¤ä¸ºä½ åˆ†ædbå¤§å°çš„å„ä¸ªå½±å“é¢ï¼Œdbå¤§å°å½±å“é¢å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/ab/11/ab657951310461c835963c38e43fdc11.png?wh=1920*685\" alt=\"\"></p><p>é¦–å…ˆæ˜¯<strong>å¯åŠ¨è€—æ—¶</strong>ã€‚etcdå¯åŠ¨çš„æ—¶å€™ï¼Œéœ€æ‰“å¼€boltdb dbæ–‡ä»¶ï¼Œè¯»å–dbæ–‡ä»¶æ‰€æœ‰key-valueæ•°æ®ï¼Œç”¨äºé‡å»ºå†…å­˜treeIndexæ¨¡å—ã€‚å› æ­¤åœ¨å¤§é‡keyå¯¼è‡´dbæ–‡ä»¶è¿‡å¤§çš„åœºæ™¯ä¸­ï¼Œè¿™ä¼šå¯¼è‡´etcdå¯åŠ¨è¾ƒæ…¢ã€‚</p><p>å…¶æ¬¡æ˜¯<strong>èŠ‚ç‚¹å†…å­˜é…ç½®</strong>ã€‚etcdåœ¨å¯åŠ¨çš„æ—¶å€™ä¼šé€šè¿‡mmapå°†dbæ–‡ä»¶æ˜ å°„å†…å­˜ä¸­ï¼Œè‹¥èŠ‚ç‚¹å¯ç”¨å†…å­˜ä¸è¶³ï¼Œå°äºdbæ–‡ä»¶å¤§å°æ—¶ï¼Œå¯èƒ½ä¼šå‡ºç°ç¼ºé¡µæ–‡ä»¶ä¸­æ–­ï¼Œå¯¼è‡´æœåŠ¡ç¨³å®šæ€§ã€æ€§èƒ½ä¸‹é™ã€‚</p><!-- [[[read_end]]] --><p>æ¥ç€æ˜¯<strong>treeIndex</strong>ç´¢å¼•æ€§èƒ½ã€‚å› etcdä¸æ”¯æŒæ•°æ®åˆ†ç‰‡ï¼Œå†…å­˜ä¸­çš„treeIndexè‹¥ä¿å­˜äº†å‡ åä¸‡åˆ°ä¸Šåƒä¸‡çš„keyï¼Œè¿™ä¼šå¢åŠ æŸ¥è¯¢ã€ä¿®æ”¹æ“ä½œçš„æ•´ä½“å»¶æ—¶ã€‚</p><p>ç„¶åæ˜¯<strong>boltdbæ€§èƒ½</strong>ã€‚å¤§dbæ–‡ä»¶åœºæ™¯ä¼šå¯¼è‡´äº‹åŠ¡æäº¤è€—æ—¶å¢é•¿ã€æŠ–åŠ¨ã€‚</p><p>å†æ¬¡æ˜¯<strong>é›†ç¾¤ç¨³å®šæ€§</strong>ã€‚å¤§dbæ–‡ä»¶åœºæ™¯ä¸‹ï¼Œæ— è®ºä½ æ˜¯ç™¾ä¸‡çº§åˆ«å°keyè¿˜æ˜¯ä¸Šåƒä¸ªå¤§valueåœºæ™¯ï¼Œä¸€æ—¦å‡ºç°expensive requeståï¼Œå¾ˆå®¹æ˜“å¯¼è‡´etcd OOMã€èŠ‚ç‚¹å¸¦å®½æ»¡è€Œä¸¢åŒ…ã€‚</p><p>æœ€åæ˜¯<strong>å¿«ç…§ã€‚</strong>å½“FollowerèŠ‚ç‚¹è½åLeaderè¾ƒå¤šæ•°æ®çš„æ—¶å€™ï¼Œä¼šè§¦å‘Leaderç”Ÿæˆå¿«ç…§é‡å»ºå‘é€ç»™FollowerèŠ‚ç‚¹ï¼ŒFolloweråŸºäºå®ƒè¿›è¡Œè¿˜åŸé‡å»ºæ“ä½œã€‚è¾ƒå¤§çš„dbæ–‡ä»¶ä¼šå¯¼è‡´Leaderå‘é€å¿«ç…§éœ€è¦æ¶ˆè€—è¾ƒå¤šçš„CPUã€ç½‘ç»œå¸¦å®½èµ„æºï¼ŒåŒæ—¶FollowerèŠ‚ç‚¹é‡å»ºè¿˜åŸæ…¢ã€‚</p><h2>æ„é€ å¤§é›†ç¾¤</h2><p>ç®€å•ä»‹ç»å®Œdbå¤§å°çš„å…­ä¸ªå½±å“é¢åï¼Œæˆ‘ä»¬ä¸‹é¢æ¥æ„é€ ä¸€ä¸ªå¤§æ•°æ®é‡çš„é›†ç¾¤ï¼Œç”¨äºåç»­å„ä¸ªå½±å“é¢çš„åˆ†æã€‚</p><p>é¦–å…ˆï¼Œæˆ‘é€šè¿‡ä¸€ç³»åˆ—å¦‚ä¸‹<a href=\"https://github.com/etcd-io/etcd/tree/v3.4.9/tools/benchmark\">benchmark</a>å‘½ä»¤ï¼Œå‘ä¸€ä¸ª8æ ¸32Gçš„3èŠ‚ç‚¹çš„é›†ç¾¤å†™å…¥120ä¸‡å·¦å³keyã€‚keyå¤§å°ä¸º32ï¼Œvalueå¤§å°ä¸º256åˆ°10Kï¼Œç”¨ä»¥åˆ†æå¤§dbé›†ç¾¤æ¡ˆä¾‹ä¸­çš„å„ä¸ªå½±å“é¢ã€‚</p><pre><code>./benchmark put --key-size 32 --val-size 10240 --total \n1000000 --key-space-size 2000000 --clients 50 --conns 50\n</code></pre><p>æ‰§è¡Œå®Œä¸€ç³»åˆ—benchmarkå‘½ä»¤åï¼Œdb sizeè¾¾åˆ°14Gï¼Œæ€»keyæ•°è¾¾åˆ°120ä¸‡ï¼Œå…¶ç›‘æ§å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/67/60/67aa0c0fe078byy681fe4c55a3983f60.png?wh=1338*362\" alt=\"\"></p><p><img src=\"https://static001.geekbang.org/resource/image/33/88/331ac3c759578b297546f1651385be88.png?wh=1314*412\" alt=\"\"></p><h2>å¯åŠ¨è€—æ—¶</h2><p>åœ¨å¦‚ä¸Šçš„é›†ç¾¤ä¸­ï¼Œæˆ‘é€šè¿‡benchmarkå·¥å…·å°†etcdé›†ç¾¤dbå¤§å°å‹æµ‹åˆ°14Gåï¼Œåœ¨é‡æ–°å¯åŠ¨etcdè¿›ç¨‹çš„æ—¶å€™ï¼Œå¦‚ä¸‹æ—¥å¿—æ‰€ç¤ºï¼Œä½ ä¼šå‘ç°å¯åŠ¨æ¯”è¾ƒæ…¢ï¼Œä¸ºä»€ä¹ˆå¤§dbæ–‡ä»¶ä¼šå½±å“etcdå¯åŠ¨è€—æ—¶å‘¢ï¼Ÿ</p><pre><code>2021-02-15 02:25:55.273712 I | etcdmain: etcd Version: 3.4.9\n2021-02-15 02:26:58.806882 I | etcdserver: recovered store from snapshot at index 2100090\n2021-02-15 02:26:58.808810 I | mvcc: restore compact to 1000002\n2021-02-15 02:27:19.120141 W | etcdserver: backend quota 26442450944 exceeds maximum recommended quota 8589934592\n2021-02-15 02:27:19.297363 I | embed: ready to serve client requests\n</code></pre><p>é€šè¿‡å¯¹etcdå¯åŠ¨æµç¨‹å¢åŠ è€—æ—¶ç»Ÿè®¡ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°æ ¸å¿ƒç“¶é¢ˆä¸»è¦åœ¨äºæ‰“å¼€dbæ–‡ä»¶å’Œé‡å»ºå†…å­˜treeIndexæ¨¡å—ã€‚</p><p>è¿™é‡Œæˆ‘é‡ç‚¹å…ˆå’Œä½ ä»‹ç»ä¸‹etcdå¯åŠ¨åï¼Œé‡å»ºå†…å­˜treeIndexçš„åŸç†ã€‚</p><p>æˆ‘ä»¬çŸ¥é“treeIndexæ¨¡å—ç»´æŠ¤äº†ç”¨æˆ·keyä¸boltdb keyçš„æ˜ å°„å…³ç³»ï¼Œboltdbçš„keyã€valueåˆåŒ…å«äº†æ„å»ºtreeIndexçš„æ‰€éœ€çš„æ•°æ®ã€‚å› æ­¤etcdå¯åŠ¨çš„æ—¶å€™ï¼Œä¼šå¯åŠ¨ä¸åŒè§’è‰²çš„goroutineå¹¶å‘å®ŒæˆtreeIndexæ„å»ºã€‚</p><p><strong>é¦–å…ˆæ˜¯ä¸»goroutineã€‚</strong>å®ƒçš„èŒè´£æ˜¯éå†boltdbï¼Œè·å–æ‰€æœ‰key-valueæ•°æ®ï¼Œå¹¶å°†å…¶ååºåˆ—åŒ–æˆetcdçš„mvccpb.KeyValueç»“æ„ã€‚æ ¸å¿ƒåŸç†æ˜¯åŸºäºetcdå­˜å‚¨åœ¨boltdbä¸­çš„keyæ•°æ®æœ‰åºæ€§ï¼ŒæŒ‰ç‰ˆæœ¬å·ä»1å¼€å§‹æ‰¹é‡éå†ï¼Œæ¯æ¬¡æŸ¥è¯¢10000æ¡key-valueè®°å½•ï¼Œç›´åˆ°æŸ¥è¯¢æ•°æ®ä¸ºç©ºã€‚</p><p><strong>å…¶æ¬¡æ˜¯æ„å»ºtreeIndexç´¢å¼•çš„goroutineã€‚</strong>å®ƒä»ä¸»goroutineè·å–mvccpb.KeyValueæ•°æ®ï¼ŒåŸºäºkeyã€ç‰ˆæœ¬å·ã€æ˜¯å¦å¸¦åˆ é™¤æ ‡è¯†ç­‰ä¿¡æ¯ï¼Œæ„å»ºkeyIndexå¯¹è±¡ï¼Œæ’å…¥åˆ°treeIndexæ¨¡å—çš„B-treeä¸­ã€‚</p><p>å› å¯èƒ½å­˜åœ¨å¤šä¸ªgoroutineå¹¶å‘æ“ä½œtreeIndexï¼ŒtreeIndexçš„Insertå‡½æ•°ä¼šåŠ å…¨å±€é”ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚etcdå¯åŠ¨æ—¶åªæœ‰ä¸€ä¸ª<strong>æ„å»ºtreeIndexç´¢å¼•çš„goroutine</strong>ï¼Œå› æ­¤keyå¤šæ—¶ï¼Œä¼šæ¯”è¾ƒæ…¢ã€‚ä¹‹å‰æˆ‘å°è¯•ä¼˜åŒ–æˆå¤šgoroutineå¹¶å‘æ„å»ºï¼Œä½†æ˜¯æ•ˆæœä¸ä½³ï¼Œå¤§é‡è€—æ—¶ä¼šæ¶ˆè€—åœ¨æ­¤é”ä¸Šã€‚</p><pre><code>func (ti *treeIndex) Insert(ki *keyIndex) {\n   ti.Lock()\n   defer ti.Unlock()\n   ti.tree.ReplaceOrInsert(ki)\n}\n</code></pre><h2>èŠ‚ç‚¹å†…å­˜é…ç½®</h2><p>etcdè¿›ç¨‹é‡å¯å®Œæˆåï¼Œåœ¨æ²¡ä»»ä½•è¯»å†™QPSæƒ…å†µä¸‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œä½ ä¼šå‘ç°etcdæ‰€æ¶ˆè€—çš„å†…å­˜æ¯”dbå¤§å°è¿˜å¤§ä¸€ç‚¹ã€‚è¿™åˆæ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå¦‚æœetcd dbæ–‡ä»¶å¤§å°è¶…è¿‡èŠ‚ç‚¹å†…å­˜è§„æ ¼ï¼Œä¼šå¯¼è‡´ä»€ä¹ˆé—®é¢˜å—ï¼Ÿ</p><p><img src=\"https://static001.geekbang.org/resource/image/02/a1/027ef8e1759a2800f1a2c1c105d7d7a1.png?wh=1312*394\" alt=\"\"></p><p>åœ¨<a href=\"https://time.geekbang.org/column/article/342527\">10</a>ä»‹ç»boltdbå­˜å‚¨åŸç†çš„æ—¶å€™ï¼Œæˆ‘å’Œä½ åˆ†äº«è¿‡boltdbæ–‡ä»¶çš„ç£ç›˜å¸ƒå±€ç»“æ„å’Œå…¶å¯¹å¤–æä¾›çš„APIåŸç†ã€‚</p><p>etcdåœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šé€šè¿‡boltdbçš„Open APIè·å–æ•°æ®åº“å¯¹è±¡ï¼Œè€ŒOpen APIå®ƒä¼šé€šè¿‡mmapæœºåˆ¶å°†dbæ–‡ä»¶æ˜ å°„åˆ°å†…å­˜ä¸­ã€‚</p><p>ç”±äºetcdè°ƒç”¨boltdb Open APIçš„æ—¶å€™ï¼Œè®¾ç½®äº†mmapçš„MAP_POPULATE flagï¼Œå®ƒä¼šå‘Šè¯‰Linuxå†…æ ¸é¢„è¯»æ–‡ä»¶ï¼Œå°†dbæ–‡ä»¶å†…å®¹å…¨éƒ¨ä»ç£ç›˜åŠ è½½åˆ°ç‰©ç†å†…å­˜ä¸­ã€‚</p><p>å› æ­¤åœ¨ä½ èŠ‚ç‚¹å†…å­˜å……è¶³çš„æƒ…å†µä¸‹ï¼Œå¯åŠ¨åä½ çœ‹åˆ°çš„etcdå ç”¨å†…å­˜ï¼Œä¸€èˆ¬æ˜¯dbæ–‡ä»¶å¤§å°ä¸å†…å­˜treeIndexä¹‹å’Œã€‚</p><p>åœ¨èŠ‚ç‚¹å†…å­˜å……è¶³çš„æƒ…å†µä¸‹ï¼Œå¯åŠ¨åï¼Œclientåç»­å‘èµ·å¯¹etcdçš„è¯»æ“ä½œï¼Œå¯ç›´æ¥é€šè¿‡å†…å­˜è·å–boltdbçš„key-valueæ•°æ®ï¼Œä¸ä¼šäº§ç”Ÿä»»ä½•ç£ç›˜IOï¼Œå…·å¤‡è‰¯å¥½çš„è¯»æ€§èƒ½ã€ç¨³å®šæ€§ã€‚</p><p>è€Œå½“ä½ çš„dbæ–‡ä»¶å¤§å°è¶…è¿‡èŠ‚ç‚¹å†…å­˜é…ç½®æ—¶ï¼Œè‹¥ä½ æŸ¥è¯¢çš„keyæ‰€ç›¸å…³çš„branch pageã€leaf pageä¸åœ¨å†…å­˜ä¸­ï¼Œé‚£å°±ä¼šè§¦å‘ä¸»ç¼ºé¡µä¸­æ–­ï¼Œå¯¼è‡´è¯»å»¶æ—¶æŠ–åŠ¨ã€QPSä¸‹é™ã€‚</p><p>å› æ­¤ä¸ºäº†ä¿è¯etcdé›†ç¾¤æ€§èƒ½çš„ç¨³å®šæ€§ï¼Œæˆ‘å»ºè®®ä½ çš„etcdèŠ‚ç‚¹å†…å­˜è§„æ ¼è¦å¤§äºä½ çš„etcd dbæ–‡ä»¶å¤§å°ã€‚</p><h2>treeIndex</h2><p>å½“æˆ‘ä»¬å¾€é›†ç¾¤ä¸­å†™å…¥äº†ä¸€ç™¾å¤šä¸‡keyæ—¶ï¼Œæ­¤æ—¶ä½ å†è¯»å–ä¸€ä¸ªkeyèŒƒå›´æ“ä½œçš„å»¶æ—¶ä¼šå‡ºç°ä¸€å®šç¨‹åº¦ä¸Šå‡ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬è¯¥å¦‚ä½•åˆ†æè€—æ—¶æ˜¯åœ¨å“ªä¸€æ­¥å¯¼è‡´çš„ï¼Ÿ</p><p>åœ¨etcd 3.4ä¸­æä¾›äº†traceç‰¹æ€§ï¼Œå®ƒå¯å¸®åŠ©æˆ‘ä»¬å®šä½ã€åˆ†æè¯·æ±‚è€—æ—¶è¿‡é•¿é—®é¢˜ã€‚ä¸è¿‡ä½ éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œæ­¤ç‰¹æ€§åœ¨etcd 3.4ä¸­ï¼Œå› ä¸ºä¾èµ–zap loggerï¼Œé»˜è®¤ä¸ºå…³é—­ã€‚ä½ å¯ä»¥é€šè¿‡è®¾ç½®etcdå¯åŠ¨å‚æ•°ä¸­çš„--logger=zapæ¥å¼€å¯ã€‚</p><p>å¼€å¯ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥åœ¨etcdæ—¥å¿—ä¸­æ‰¾åˆ°ç±»ä¼¼å¦‚ä¸‹çš„è€—æ—¶è®°å½•ã€‚</p><pre><code>{\n&quot;msg&quot;:&quot;trace[331581563] range&quot;ï¼Œ\n&quot;detail&quot;:&quot;{range_begin:/vip/a; range_end:/vip/b; response_count:19304; response_revision:1005564; }&quot;ï¼Œ\n&quot;duration&quot;:&quot;146.432768ms&quot;ï¼Œ\n&quot;steps&quot;:[\n&quot;trace[331581563] 'range keys from in-memory treeIndex'  (duration: 95.925033ms)&quot;ï¼Œ\n&quot;trace[331581563] 'range keys from bolt db'  (duration: 47.932118ms)&quot;\n]\n</code></pre><p>æ­¤æ—¥å¿—è®°å½•äº†æŸ¥è¯¢è¯·æ±‚\"etcdctl get --prefix /vip/a\"ã€‚å®ƒåœ¨treeIndexä¸­æŸ¥è¯¢ç›¸å…³keyè€—æ—¶95msï¼Œä»boltdbéå†keyæ—¶47msã€‚ä¸»è¦åŸå› è¿˜æ˜¯æ­¤æŸ¥è¯¢æ¶‰åŠçš„keyæ•°è¾ƒå¤šï¼Œé«˜è¾¾ä¸€ä¸‡ä¹ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´è‹¥treeIndexä¸­å­˜å‚¨äº†ç™¾ä¸‡çº§çš„keyæ—¶ï¼Œå®ƒå¯èƒ½ä¹Ÿä¼šäº§ç”Ÿå‡ åæ¯«ç§’åˆ°æ•°ç™¾æ¯«ç§’çš„å»¶æ—¶ï¼Œå¯¹äºæœŸæœ›ä¸šåŠ¡å»¶æ—¶ç¨³å®šåœ¨è¾ƒå°é˜ˆå€¼å†…çš„ä¸šåŠ¡ï¼Œå°±æ— æ³•æ»¡è¶³å…¶è¯‰æ±‚ã€‚</p><h2>boltdbæ€§èƒ½</h2><p>å½“dbæ–‡ä»¶å¤§å°æŒç»­å¢é•¿åˆ°16Gä¹ƒè‡³æ›´å¤§åï¼Œä»etcdäº‹åŠ¡æäº¤ç›‘æ§metricsä½ å¯èƒ½ä¼šè§‚å¯Ÿåˆ°ï¼Œboltdbåœ¨æäº¤äº‹åŠ¡æ—¶å¶å°”å‡ºç°äº†è¾ƒé«˜å»¶æ—¶ï¼Œé‚£ä¹ˆå»¶æ—¶æ˜¯æ€ä¹ˆäº§ç”Ÿçš„å‘¢ï¼Ÿ</p><p>åœ¨<a href=\"https://time.geekbang.org/column/article/342527\">10</a>ä»‹ç»boltdbçš„åŸç†æ—¶ï¼Œæˆ‘å’Œä½ åˆ†äº«äº†dbæ–‡ä»¶çš„ç£ç›˜å¸ƒå±€ï¼Œå®ƒæ˜¯ç”±meta pageã€branch pageã€leaf pageã€free listã€freeé¡µç»„æˆçš„ã€‚åŒæ—¶æˆ‘ç»™ä½ ä»‹ç»äº†boltdbäº‹åŠ¡æäº¤çš„å››ä¸ªæ ¸å¿ƒæµç¨‹ï¼Œåˆ†åˆ«æ˜¯B+ treeçš„é‡å¹³è¡¡ã€åˆ†è£‚ï¼ŒæŒä¹…åŒ–dirty pageï¼ŒæŒä¹…åŒ–freelistä»¥åŠæŒä¹…åŒ–meta dataã€‚</p><p>äº‹åŠ¡æäº¤å»¶æ—¶æŠ–åŠ¨çš„åŸå› ä¸»è¦æ˜¯åœ¨B+ treeæ ‘çš„é‡å¹³è¡¡å’Œåˆ†è£‚è¿‡ç¨‹ä¸­ï¼Œå®ƒéœ€è¦ä»freelistä¸­ç”³è¯·è‹¥å¹²è¿ç»­çš„pageå­˜å‚¨æ•°æ®ï¼Œæˆ–é‡Šæ”¾ç©ºé—²çš„pageåˆ°freelistã€‚</p><p>freeliståç«¯å®ç°åœ¨boltdbä¸­æ˜¯arrayã€‚å½“ç”³è¯·ä¸€ä¸ªè¿ç»­çš„nä¸ªpageå­˜å‚¨æ•°æ®æ—¶ï¼Œå®ƒä¼šéå†boltdbä¸­æ‰€æœ‰çš„ç©ºé—²é¡µï¼Œç›´åˆ°æ‰¾åˆ°è¿ç»­çš„nä¸ªpageã€‚å› æ­¤å®ƒçš„æ—¶é—´å¤æ‚åº¦æ˜¯O(N)ã€‚è‹¥dbæ–‡ä»¶è¾ƒå¤§ï¼Œåˆå­˜åœ¨å¤§é‡çš„ç¢ç‰‡ç©ºé—²é¡µï¼Œå¾ˆå¯èƒ½å¯¼è‡´è¶…æ—¶ã€‚</p><p>åŒæ—¶äº‹åŠ¡æäº¤è¿‡ç¨‹ä¸­ï¼Œä¹Ÿå¯èƒ½ä¼šé‡Šæ”¾è‹¥å¹²ä¸ªpageç»™freelistï¼Œå› æ­¤éœ€è¦åˆå¹¶åˆ°freelistçš„æ•°ç»„ä¸­ï¼Œæ­¤æ“ä½œæ—¶é—´å¤æ‚åº¦æ˜¯O(NLog N)ã€‚</p><p>å‡è®¾æˆ‘ä»¬dbå¤§å°16Gï¼Œpage size 4KBï¼Œåˆ™æœ‰400ä¸‡ä¸ªpageã€‚ç»è¿‡å„ç§ä¿®æ”¹ã€å‹ç¼©åï¼Œè‹¥å­˜åœ¨ä¸€åŠé›¶æ•£åˆ†å¸ƒçš„ç¢ç‰‡ç©ºé—²é¡µï¼Œåœ¨æœ€åçš„åœºæ™¯ä¸‹ï¼Œetcdæ¯æ¬¡äº‹åŠ¡æäº¤éœ€è¦éå†200ä¸‡ä¸ªpageæ‰èƒ½æ‰¾åˆ°è¿ç»­çš„nä¸ªpageï¼ŒåŒæ—¶è¿˜éœ€è¦æŒä¹…åŒ–freeliståˆ°ç£ç›˜ã€‚</p><p>ä¸ºäº†ä¼˜åŒ–boltdbäº‹åŠ¡æäº¤çš„æ€§èƒ½ï¼Œetcdç¤¾åŒºåœ¨bbolté¡¹ç›®ä¸­ï¼Œå®ç°äº†åŸºäºhashmapæ¥ç®¡ç†freelistã€‚é€šè¿‡å¼•å…¥äº†å¦‚ä¸‹çš„ä¸‰ä¸ªmapæ•°æ®ç»“æ„ï¼ˆfreemapsçš„keyæ˜¯è¿ç»­çš„é¡µæ•°ï¼Œvalueæ˜¯ä»¥ç©ºé—²é¡µçš„èµ·å§‹é¡µpgidé›†åˆï¼Œforwardmapå’Œbackmapç”¨äºé‡Šæ”¾çš„æ—¶å€™å¿«é€Ÿåˆå¹¶é¡µï¼‰ï¼Œå°†ç”³è¯·å’Œé‡Šæ”¾æ—¶é—´å¤æ‚åº¦é™ä½åˆ°äº†O(1)ã€‚</p><p>freeliståç«¯å®ç°å¯ä»¥é€šè¿‡bboltçš„FreeListTypeå‚æ•°æ¥æ§åˆ¶ï¼Œæ”¯æŒarrayå’Œhashmapã€‚åœ¨etcd 3.4ç‰ˆæœ¬ä¸­ç›®å‰è¿˜æ˜¯arrayï¼Œæœªæ¥çš„3.5ç‰ˆæœ¬å°†é»˜è®¤æ˜¯hashmapã€‚</p><pre><code>freemaps       map[uint64]pidSet           // key is the size of continuous pages(span)ï¼Œvalue is a set which contains the starting pgids of same size\nforwardMap     map[pgid]uint64             // key is start pgidï¼Œvalue is its span size\nbackwardMap    map[pgid]uint64             // key is end pgidï¼Œvalue is its span size\n</code></pre><p>å¦å¤–åœ¨dbä¸­è‹¥å­˜åœ¨å¤§é‡ç©ºé—²é¡µï¼ŒæŒä¹…åŒ–freelistéœ€è¦æ¶ˆè€—è¾ƒå¤šçš„dbå¤§å°ï¼Œå¹¶ä¼šå¯¼è‡´é¢å¤–çš„äº‹åŠ¡æäº¤å»¶æ—¶ã€‚</p><p>è‹¥æœªæŒä¹…åŒ–freelistï¼Œbboltæ”¯æŒé€šè¿‡é‡å¯æ—¶æ‰«æå…¨éƒ¨pageæ¥æ„é€ freelistï¼Œé™ä½äº†dbå¤§å°å’Œæå‡å†™äº‹åŠ¡æäº¤çš„æ€§èƒ½ï¼ˆä½†æ˜¯å®ƒä¼šå¸¦æ¥etcdå¯åŠ¨å»¶æ—¶çš„ä¸Šå‡ï¼‰ã€‚æ­¤è¡Œä¸ºå¯ä»¥é€šè¿‡bboltçš„NoFreelistSyncå‚æ•°æ¥æ§åˆ¶ï¼Œé»˜è®¤æ˜¯trueå¯ç”¨æ­¤ç‰¹æ€§ã€‚</p><h2>é›†ç¾¤ç¨³å®šæ€§</h2><p>dbæ–‡ä»¶å¢å¤§åï¼Œå¦å¤–ä¸€ä¸ªéå¸¸å¤§çš„éšæ‚£æ˜¯ç”¨æˆ·clientå‘èµ·çš„expensive requestï¼Œå®¹æ˜“å¯¼è‡´é›†ç¾¤å‡ºç°å„ç§ç¨³å®šæ€§é—®é¢˜ã€‚</p><p>æœ¬è´¨åŸå› æ˜¯etcdä¸æ”¯æŒæ•°æ®åˆ†ç‰‡ï¼Œå„ä¸ªèŠ‚ç‚¹ä¿å­˜äº†æ‰€æœ‰key-valueæ•°æ®ï¼ŒåŒæ—¶å®ƒä»¬åˆå­˜å‚¨åœ¨boltdbçš„ä¸€ä¸ªbucketé‡Œé¢ã€‚å½“ä½ çš„é›†ç¾¤å«æœ‰ç™¾ä¸‡çº§ä»¥ä¸Škeyçš„æ—¶å€™ï¼Œä»»æ„ä¸€ç§expensive readè¯·æ±‚éƒ½å¯èƒ½å¯¼è‡´etcdå‡ºç°OOMã€ä¸¢åŒ…ç­‰æƒ…å†µå‘ç”Ÿã€‚</p><p>é‚£ä¹ˆæœ‰å“ªäº›expensive readè¯·æ±‚ä¼šå¯¼è‡´etcdä¸ç¨³å®šæ€§å‘¢ï¼Ÿ</p><p><strong>é¦–å…ˆæ˜¯ç®€å•çš„count onlyæŸ¥è¯¢ã€‚</strong>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå½“ä½ æƒ³é€šè¿‡APIç»Ÿè®¡ä¸€ä¸ªé›†ç¾¤æœ‰å¤šå°‘keyæ—¶ï¼Œå¦‚æœä½ çš„keyè¾ƒå¤šï¼Œåˆ™æœ‰å¯èƒ½å¯¼è‡´å†…å­˜çªå¢å’Œè¾ƒå¤§çš„å»¶æ—¶ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/44/a1/44ee247e9a31a455aca28459e5bb45a1.png?wh=1322*418\" alt=\"\"></p><p>åœ¨etcd 3.5ç‰ˆæœ¬ä¹‹å‰ï¼Œç»Ÿè®¡keyæ•°ä¼šéå†treeIndexï¼ŒæŠŠkeyè¿½åŠ åˆ°æ•°ç»„ä¸­ã€‚ç„¶è€Œå½“æ•°æ®è§„æ¨¡è¾ƒå¤§æ—¶ï¼Œè¿½åŠ keyåˆ°æ•°ç»„ä¸­çš„æ“ä½œä¼šæ¶ˆè€—å¤§é‡å†…å­˜ï¼ŒåŒæ—¶æ•°ç»„æ‰©å®¹æ—¶æ¶‰åŠåˆ°å¤§é‡æ•°æ®æ‹·è´ï¼Œä¼šå¯¼è‡´å»¶æ—¶ä¸Šå‡ã€‚</p><p><strong>å…¶æ¬¡æ˜¯limitæŸ¥è¯¢ã€‚</strong>å½“ä½ åªæƒ³æŸ¥è¯¢è‹¥å¹²æ¡æ•°æ®çš„æ—¶å€™ï¼Œè‹¥ä½ çš„keyè¾ƒå¤šï¼Œä¹Ÿä¼šå¯¼è‡´ç±»ä¼¼count onlyæŸ¥è¯¢çš„æ€§èƒ½ã€ç¨³å®šæ€§é—®é¢˜ã€‚</p><p>åŸå› æ˜¯etcd 3.5ç‰ˆæœ¬ä¹‹å‰éå†index B-treeæ—¶ï¼Œå¹¶æœªå°†limitå‚æ•°ä¸‹æ¨åˆ°ç´¢å¼•å±‚ï¼Œå¯¼è‡´äº†æ— ç”¨çš„èµ„æºå’Œæ—¶é—´æ¶ˆè€—ã€‚ä¼˜åŒ–æ–¹æ¡ˆä¹Ÿå¾ˆç®€å•ï¼Œetcd 3.5ä¸­æˆ‘æçš„ä¼˜åŒ–PRå°†limitå‚æ•°ä¸‹æ¨åˆ°äº†ç´¢å¼•å±‚ï¼Œå®ç°æŸ¥è¯¢æ€§èƒ½ç™¾å€æå‡ã€‚</p><p><strong>æœ€åæ˜¯å¤§åŒ…æŸ¥è¯¢ã€‚</strong>å½“ä½ æœªåˆ†é¡µæ‰¹é‡éå†key-valueæ•°æ®æˆ–å•key-valueæ•°æ®è¾ƒå¤§çš„æ—¶å€™ï¼Œéšç€è¯·æ±‚QPSå¢å¤§ï¼Œetcd OOMã€èŠ‚ç‚¹å‡ºç°å¸¦å®½ç“¶é¢ˆå¯¼è‡´ä¸¢åŒ…çš„é£é™©ä¼šè¶Šæ¥è¶Šå¤§ã€‚</p><p>é—®é¢˜ä¸»è¦ç”±ä»¥ä¸‹ä¸¤ç‚¹åŸå› å¯¼è‡´ï¼š</p><p>ç¬¬ä¸€ï¼Œetcdéœ€è¦éå†treeIndexè·å–keyåˆ—è¡¨ã€‚è‹¥ä½ æœªåˆ†é¡µï¼Œä¸€æ¬¡æŸ¥è¯¢ä¸‡çº§keyï¼Œæ˜¾ç„¶ä¼šæ¶ˆè€—å¤§é‡å†…å­˜å¹¶ä¸”é«˜å»¶æ—¶ã€‚</p><p>ç¬¬äºŒï¼Œè·å–åˆ°keyåˆ—è¡¨ã€ç‰ˆæœ¬å·åï¼Œetcdéœ€è¦éå†boltdbï¼Œå°†key-valueä¿å­˜åˆ°æŸ¥è¯¢ç»“æœæ•°æ®ç»“æ„ä¸­ã€‚å¦‚ä¸‹traceæ—¥å¿—æ‰€ç¤ºï¼Œä¸€ä¸ªè¯·æ±‚å¯èƒ½åœ¨éå†boltdbæ—¶èŠ±è´¹å¾ˆé•¿æ—¶é—´ï¼ŒåŒæ—¶å¯èƒ½ä¼šæ¶ˆè€—å‡ ç™¾Mç”šè‡³æ•°Gçš„å†…å­˜ã€‚éšç€è¯·æ±‚QPSå¢å¤§ï¼Œææ˜“å‡ºç°OOMã€ä¸¢åŒ…ç­‰ã€‚etcdè¿™å—æœªæ¥çš„ä¼˜åŒ–ç‚¹æ˜¯å®ç°æµå¼ä¼ è¾“ã€‚</p><pre><code>{\n&quot;level&quot;:&quot;info&quot;,\n&quot;ts&quot;:&quot;2021-02-15T03:44:52.209Z&quot;,\n&quot;caller&quot;:&quot;traceutil/trace.go:145&quot;,\n&quot;msg&quot;:&quot;trace[1908866301] range&quot;,\n&quot;detail&quot;:&quot;{range_begin:; range_end:; response_count:1232274; response_revision:3128500; }&quot;,\n&quot;duration&quot;:&quot;9.063748801s&quot;,\n&quot;start&quot;:&quot;2021-02-15T03:44:43.145Z&quot;,\n&quot;end&quot;:&quot;2021-02-15T03:44:52.209Z&quot;,\n&quot;steps&quot;:[\n&quot;trace[1908866301] 'range keys from in-memory index tree' (duration: 693.262565ms)&quot;,\n&quot;trace[1908866301] 'range keys from bolt db' (duration: 8.22558566s)&quot;,\n&quot;trace[1908866301] 'assemble the response' (duration: 18.810315ms)&quot;\n]\n}\n</code></pre><h2>å¿«ç…§</h2><p>å¤§dbæ–‡ä»¶æœ€åä¸€ä¸ªå½±å“é¢æ˜¯å¿«ç…§ã€‚å®ƒä¼šå½±å“dbå¤‡ä»½æ–‡ä»¶ç”Ÿæˆé€Ÿåº¦ã€Leaderå‘é€å¿«ç…§ç»™FollowerèŠ‚ç‚¹çš„èµ„æºå¼€é”€ã€FollowerèŠ‚ç‚¹é€šè¿‡å¿«ç…§é‡å»ºæ¢å¤çš„é€Ÿåº¦ã€‚</p><p>æˆ‘ä»¬çŸ¥é“etcdæä¾›äº†å¿«ç…§åŠŸèƒ½ï¼Œå¸®åŠ©æˆ‘ä»¬é€šè¿‡APIå³å¯å¤‡ä»½etcdæ•°æ®ã€‚å½“etcdæ”¶åˆ°snapshotè¯·æ±‚çš„æ—¶å€™ï¼Œå®ƒä¼šé€šè¿‡boltdbæ¥å£åˆ›å»ºä¸€ä¸ªåªè¯»äº‹åŠ¡Txï¼Œéšåé€šè¿‡äº‹åŠ¡çš„WriteToæ¥å£ï¼Œå°†meta pageå’Œdata pageæ‹·è´åˆ°bufferå³å¯ã€‚</p><p>ä½†æ˜¯éšç€dbæ–‡ä»¶å¢å¤§ï¼Œå¿«ç…§äº‹åŠ¡æ‰§è¡Œçš„æ—¶é—´ä¹Ÿä¼šè¶Šæ¥è¶Šé•¿ï¼Œè€Œé•¿äº‹åŠ¡åˆ™ä¼šå¯¼è‡´dbæ–‡ä»¶å¤§å°å‘ç”Ÿæ˜¾è‘—å¢åŠ ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´å½“dbå¤§æ—¶ï¼Œç”Ÿæˆå¿«ç…§ä¸ä»…æ…¢ï¼Œç”Ÿæˆå¿«ç…§æ—¶å¯èƒ½è¿˜ä¼šè§¦å‘dbæ–‡ä»¶å¤§å°æŒç»­å¢é•¿ï¼Œæœ€ç»ˆè¾¾åˆ°é…é¢é™åˆ¶ã€‚</p><p>ä¸ºä»€ä¹ˆé•¿äº‹åŠ¡å¯èƒ½ä¼šå¯¼è‡´dbå¤§å°å¢é•¿å‘¢ï¼Ÿ è¿™ä¸ªé—®é¢˜æˆ‘å…ˆå°†å®ƒä½œä¸ºæ€è€ƒé¢˜ï¼Œä½ å¯ä»¥åˆ†äº«ä¸€ä¸‹ä½ çš„æƒ³æ³•ï¼Œåç»­æˆ‘å°†ä¸ºä½ è¯¦ç»†è§£ç­”ã€‚</p><p>å¿«ç…§çš„å¦ä¸€å¤§ä½œç”¨æ˜¯å½“FollowerèŠ‚ç‚¹å¼‚å¸¸çš„æ—¶å€™ï¼ŒLeaderç”Ÿæˆå¿«ç…§å‘é€ç»™FollowerèŠ‚ç‚¹ï¼ŒFollowerä½¿ç”¨å¿«ç…§é‡å»ºå¹¶è¿½èµ¶ä¸ŠLeaderã€‚æ­¤è¿‡ç¨‹æ¶‰åŠåˆ°ä¸€å®šçš„CPUã€å†…å­˜ã€ç½‘ç»œå¸¦å®½ç­‰èµ„æºå¼€é”€ã€‚</p><p>åŒæ—¶ï¼Œè‹¥å¿«ç…§å’Œé›†ç¾¤å†™QPSè¾ƒå¤§ï¼ŒLeaderå‘é€å¿«ç…§ç»™Followerå’ŒFolloweråº”ç”¨å¿«ç…§åˆ°çŠ¶æ€æœºçš„æµç¨‹ä¼šè€—è´¹è¾ƒé•¿çš„æ—¶é—´ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´åŸºäºå¿«ç…§é‡å»ºåçš„Followerä¾ç„¶æ— æ³•é€šè¿‡æ­£å¸¸çš„æ—¥å¿—å¤åˆ¶æ¨¡å¼æ¥è¿½èµ¶Leaderï¼Œåªèƒ½ç»§ç»­è§¦å‘Leaderç”Ÿæˆå¿«ç…§ï¼Œè¿›è€Œè¿›å…¥æ­»å¾ªç¯ï¼ŒFollowerä¸€ç›´å¤„äºå¼‚å¸¸ä¸­ã€‚</p><h2>å°ç»“</h2><p>æœ€åæˆ‘ä»¬æ¥å°ç»“ä¸‹ä»Šå¤©çš„å†…å®¹ã€‚å¤§dbæ–‡ä»¶é¦–å…ˆä¼šå½±å“etcdå¯åŠ¨è€—æ—¶ï¼Œå› ä¸ºetcdéœ€è¦æ‰“å¼€dbæ–‡ä»¶ï¼Œåˆå§‹åŒ–dbå¯¹è±¡ï¼Œå¹¶éå†boltdbä¸­çš„æ‰€æœ‰key-valueä»¥é‡å»ºå†…å­˜treeIndexã€‚</p><p>å…¶æ¬¡ï¼Œè¾ƒå¤§dbæ–‡ä»¶ä¼šå¯¼è‡´etcdä¾èµ–æ›´é«˜é…ç½®çš„èŠ‚ç‚¹å†…å­˜è§„æ ¼ï¼Œetcdé€šè¿‡mmapå°†dbæ–‡ä»¶æ˜ å°„åˆ°å†…å­˜ä¸­ã€‚etcdå¯åŠ¨åï¼Œæ­£å¸¸æƒ…å†µä¸‹è¯»etcdè¿‡ç¨‹ä¸æ¶‰åŠç£ç›˜IOï¼Œè‹¥èŠ‚ç‚¹å†…å­˜ä¸å¤Ÿï¼Œå¯èƒ½ä¼šå¯¼è‡´ç¼ºé¡µä¸­æ–­ï¼Œå¼•èµ·å»¶æ—¶æŠ–åŠ¨ã€æœåŠ¡æ€§èƒ½ä¸‹é™ã€‚</p><p>æ¥ç€treeIndexç»´æŠ¤äº†æ‰€æœ‰keyçš„ç‰ˆæœ¬å·ä¿¡æ¯ï¼Œå½“treeIndexä¸­å«æœ‰ç™¾ä¸‡çº§keyæ—¶ï¼Œåœ¨treeIndexä¸­æœç´¢æŒ‡å®šèŒƒå›´çš„keyçš„å¼€é”€æ˜¯ä¸èƒ½å¿½ç•¥çš„ï¼Œæ­¤å¼€é”€å¯èƒ½é«˜è¾¾ä¸Šç™¾æ¯«ç§’ã€‚</p><p>ç„¶åå½“dbæ–‡ä»¶è¿‡å¤§åï¼Œboltdbæœ¬èº«è¿ç»­ç©ºé—²é¡µçš„ç”³è¯·ã€é‡Šæ”¾ã€å­˜å‚¨éƒ½ä¼šå­˜åœ¨ä¸€å®šçš„å¼€é”€ã€‚etcdç¤¾åŒºå·²é€šè¿‡æ–°çš„freelistç®¡ç†æ•°æ®ç»“æ„hashmapå¯¹å…¶è¿›è¡Œä¼˜åŒ–ï¼Œå°†æ—¶é—´å¤æ‚åº¦é™ä½åˆ°äº†O(1)ï¼ŒåŒæ—¶æ”¯æŒäº‹åŠ¡æäº¤æ—¶ä¸æŒä¹…åŒ–freelistï¼Œè€Œæ˜¯é€šè¿‡é‡å¯æ—¶æ‰«æpageé‡å»ºï¼Œä»¥æå‡etcdå†™æ€§èƒ½ã€é™ä½dbå¤§å°ã€‚</p><p>éšåæˆ‘ç»™ä½ ä»‹ç»äº†dbæ–‡ä»¶è¿‡å¤§åï¼Œcount onlyã€limitã€å¤§åŒ…æŸ¥è¯¢ç­‰expensive requestå¯¹é›†ç¾¤ç¨³å®šæ€§çš„å½±å“ã€‚å»ºè®®ä½ çš„ä¸šåŠ¡å°½é‡é¿å…ä»»ä½•expensive requestè¯·æ±‚ã€‚</p><p>æœ€åæˆ‘ä»¬ä»‹ç»äº†å¤§dbæ–‡ä»¶å¯¹å¿«ç…§åŠŸèƒ½çš„å½±å“ã€‚å¤§dbæ–‡ä»¶æ„å‘³ç€æ›´é•¿çš„å¤‡ä»½æ—¶é—´ï¼Œè€Œæ›´é•¿çš„åªè¯»äº‹åŠ¡åˆ™å¯èƒ½ä¼šå¯¼è‡´dbæ–‡ä»¶å¢é•¿ã€‚åŒæ—¶Leaderå‘é€å¿«ç…§ä¸FolloweråŸºäºå¿«ç…§é‡å»ºéƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œåœ¨é›†ç¾¤å†™è¯·æ±‚è¾ƒå¤§çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šé™·å…¥æ­»å¾ªç¯ï¼Œå¯¼è‡´è½åçš„FollowerèŠ‚ç‚¹ä¸€ç›´æ— æ³•è¿½èµ¶ä¸ŠLeaderã€‚</p><h2>æ€è€ƒé¢˜</h2><p>åœ¨ä½¿ç”¨etcdè¿‡ç¨‹ä¸­ï¼Œä½ é‡åˆ°äº†å“ªäº›æ¡ˆä¾‹å¯¼è‡´äº†etcd dbå¤§å°çªå¢å‘¢ï¼Ÿ å®ƒä»¬çš„æœ¬è´¨åŸå› æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><p>æ„Ÿè°¢ä½ çš„é˜…è¯»ï¼Œå¦‚æœä½ è®¤ä¸ºè¿™èŠ‚è¯¾çš„å†…å®¹æœ‰æ”¶è·ï¼Œä¹Ÿæ¬¢è¿æŠŠå®ƒåˆ†äº«ç»™ä½ çš„æœ‹å‹ï¼Œè°¢è°¢ã€‚</p>","neighbors":{"left":{"article_title":"12 | ä¸€è‡´æ€§ï¼šä¸ºä»€ä¹ˆåŸºäºRaftå®ç°çš„etcdè¿˜ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´ï¼Ÿ","id":343042},"right":{"article_title":"14 | å»¶æ—¶ï¼šä¸ºä»€ä¹ˆä½ çš„etcdè¯·æ±‚ä¼šå‡ºç°è¶…æ—¶ï¼Ÿ","id":343645}},"comments":[{"had_liked":false,"id":279836,"user_name":"fran712","can_delete":false,"product_type":"c1","uid":1284429,"ip_address":"","ucode":"B09A1186FA1FA5","user_header":"","comment_is_top":false,"comment_ctime":1613978931,"is_pvip":false,"replies":[{"id":"101817","content":"ä¸€èˆ¬æˆ‘ä»¬éƒ½æ˜¯é€šè¿‡prometheusé‡‡é›†etcd metricsï¼Œé…ç½®grafanaè§†å›¾æŸ¥çœ‹çš„ï¼Œdb å¤§å°çš„metricsæ˜¯è¿™ä¸ªetcd_debugging_mvcc_db_total_size_in_bytes","user_name":"ä½œè€…å›å¤","comment_id":279836,"uid":"1009582","ip_address":"","utype":1,"ctime":1614230043,"user_name_real":"å”èª"}],"discussion_count":2,"race_medal":0,"score":"40268684595","product_id":100069901,"comment_content":"è¯·é—®è€å¸ˆï¼š<br>etcdçš„æ•°æ®å®¹é‡æ˜¯ç›´æ¥æŸ¥çœ‹æ•°æ®ç›®å½•çš„å¤§å°ï¼Ÿè¿˜æ˜¯é€šè¿‡prometheusç­‰ç›‘æ§æ‰‹æ®µæŸ¥çœ‹ï¼Ÿè¿˜æ˜¯é€šè¿‡APIæˆ–å‘½ä»¤æŸ¥çœ‹?","like_count":9,"discussions":[{"author":{"id":1009582,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/67/ae/37b492db.jpg","nickname":"å”èª","note":"","ucode":"99CB061EDF35EA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":515887,"discussion_content":"ä¸€èˆ¬æˆ‘ä»¬éƒ½æ˜¯é€šè¿‡prometheusé‡‡é›†etcd metricsï¼Œé…ç½®grafanaè§†å›¾æŸ¥çœ‹çš„ï¼Œdb å¤§å°çš„metricsæ˜¯è¿™ä¸ªetcd_debugging_mvcc_db_total_size_in_bytes","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1614230043,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1090196,"avatar":"https://static001.geekbang.org/account/avatar/00/10/a2/94/ae0a60d8.jpg","nickname":"æ±Ÿå±±æœª","note":"","ucode":"5293DD9482717F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":358474,"discussion_content":"mark","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1615988071,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":280504,"user_name":"é›¾é›¾glu","can_delete":false,"product_type":"c1","uid":1370341,"ip_address":"","ucode":"00C6AA3DB823E7","user_header":"https://static001.geekbang.org/account/avatar/00/14/e8/e5/fd4c7ea6.jpg","comment_is_top":false,"comment_ctime":1614237304,"is_pvip":false,"replies":[{"id":"101831","content":"ç›®å‰ä¾ç„¶æ˜¯8Gï¼Œé˜¿é‡Œæçš„PRå°±æ˜¯æ–‡ä¸­è¯´çš„ä½¿ç”¨hashmapæ¥ç®¡ç†boltdb freelist, å®ƒè§£å†³äº†boltdbæ–‡ä»¶ç‰¹åˆ«å¤§(&gt;20G)åœºæ™¯ä¸‹çš„freelistç®¡ç†ç“¶é¢ˆã€‚é™¤äº†boltdbæœ¬èº«ç“¶é¢ˆï¼Œæ–‡ä¸­æˆ‘ç»™å‡ºäº†å¾ˆå¤šå…¶ä»–å½±å“é¢ï¼Œæ¯”å¦‚etcdå¯åŠ¨è€—æ—¶ï¼Œä¸€ä¸ª14Gï¼Œ100ä¸‡çš„keyå°±å¯åŠ¨æ¥è¿‘2åˆ†é’Ÿï¼Œè¿˜æœ‰expensive requestå¯¹å¤§æ•°æ®é‡etcdé›†ç¾¤å½±å“ç‰¹åˆ«å¤§, å› ä¸ºetcdå­˜å‚¨çš„key-valueæ•°æ®éƒ½æ˜¯åœ¨ä¸€ä¸ªbucketé‡Œé¢ï¼Œç›®å‰etcdæ²¡æœ‰ä»»ä½•QoSæœºåˆ¶ï¼Œä¸€æ—¦ä¸å°å¿ƒå‘èµ·ä¸€ä¸ªéå†å¤§é‡keyçš„æŸ¥è¯¢å°±å®¹æ˜“å‡ºç°å„ç§ç¨³å®šæ€§é—®é¢˜äº†ã€‚","user_name":"ä½œè€…å›å¤","comment_id":280504,"uid":"1009582","ip_address":"","utype":1,"ctime":1614250717,"user_name_real":"å”èª"}],"discussion_count":2,"race_medal":0,"score":"27384041080","product_id":100069901,"comment_content":"è¯·æ•™ä¸€ä¸‹è€å¸ˆï¼š<br>çœ‹åˆ°é˜¿é‡Œè´¡çŒ®çš„ cncf åšå®¢ä¸­æåˆ°äº†ï¼Œä¼˜åŒ–äº†ç®—æ³•åå¯ä»¥å°†å­˜å‚¨æå‡è‡³ 100G: https:&#47;&#47;www.cncf.io&#47;blog&#47;2019&#47;05&#47;09&#47;performance-optimization-of-etcd-in-web-scale-data-scenario&#47;#Conclusion<br><br>ä½†æ˜¯åœ¨å®˜æ–¹æ–‡æ¡£ä¸­ï¼Œè¿˜æ˜¯å†™ç€çš„æ˜¯ 8Gï¼Œä¸ç¡®å®šè¿™ä¸ªæ•°æ®æ˜¯å¦æ˜¯æœ€æ–°çš„ï¼Ÿ<br>","like_count":7,"discussions":[{"author":{"id":1009582,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/67/ae/37b492db.jpg","nickname":"å”èª","note":"","ucode":"99CB061EDF35EA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":516117,"discussion_content":"ç›®å‰ä¾ç„¶æ˜¯8Gï¼Œé˜¿é‡Œæçš„PRå°±æ˜¯æ–‡ä¸­è¯´çš„ä½¿ç”¨hashmapæ¥ç®¡ç†boltdb freelist, å®ƒè§£å†³äº†boltdbæ–‡ä»¶ç‰¹åˆ«å¤§(&amp;gt;20G)åœºæ™¯ä¸‹çš„freelistç®¡ç†ç“¶é¢ˆã€‚é™¤äº†boltdbæœ¬èº«ç“¶é¢ˆï¼Œæ–‡ä¸­æˆ‘ç»™å‡ºäº†å¾ˆå¤šå…¶ä»–å½±å“é¢ï¼Œæ¯”å¦‚etcdå¯åŠ¨è€—æ—¶ï¼Œä¸€ä¸ª14Gï¼Œ100ä¸‡çš„keyå°±å¯åŠ¨æ¥è¿‘2åˆ†é’Ÿï¼Œè¿˜æœ‰expensive requestå¯¹å¤§æ•°æ®é‡etcdé›†ç¾¤å½±å“ç‰¹åˆ«å¤§, å› ä¸ºetcdå­˜å‚¨çš„key-valueæ•°æ®éƒ½æ˜¯åœ¨ä¸€ä¸ªbucketé‡Œé¢ï¼Œç›®å‰etcdæ²¡æœ‰ä»»ä½•QoSæœºåˆ¶ï¼Œä¸€æ—¦ä¸å°å¿ƒå‘èµ·ä¸€ä¸ªéå†å¤§é‡keyçš„æŸ¥è¯¢å°±å®¹æ˜“å‡ºç°å„ç§ç¨³å®šæ€§é—®é¢˜äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1614250717,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1370341,"avatar":"https://static001.geekbang.org/account/avatar/00/14/e8/e5/fd4c7ea6.jpg","nickname":"é›¾é›¾glu","note":"","ucode":"00C6AA3DB823E7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":351353,"discussion_content":"å¥½å“’ï¼æ„Ÿè°¢è€å¸ˆï½é˜¿é‡Œè¿™ä¸ªæ–‡ç« é‡Œå†™äº† 100g è·Ÿ 2g ä¸€æ ·å¿«å±å®æœ‰ç‚¹è¯¯å¯¼æ€§ğŸ˜…","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1614252821,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":280425,"user_name":"å†¬è‡³æœªè‡³","can_delete":false,"product_type":"c1","uid":2420395,"ip_address":"","ucode":"23473E652FE40E","user_header":"https://static001.geekbang.org/account/avatar/00/24/ee/ab/15cfcfc5.jpg","comment_is_top":false,"comment_ctime":1614214524,"is_pvip":false,"replies":[{"id":"101814","content":"æ˜¯è¿™æ ·çš„ï¼Œæˆ‘ä¸¾ä¸ªä¾‹å­ï¼Œæ²¡è¿™ä¸ªä¼˜åŒ–ä¹‹å‰ï¼Œå¦‚æœä½ æœ‰1ç™¾ä¸‡çš„key,ä½ æŸ¥è¯¢ä¸ªlimit 1ï¼ŒtreeIndexä¹Ÿä¼šè¿”å›ä¸Šç™¾ä¸‡çš„keyç»™ä¸Šå±‚ï¼Œå¦‚æœæŠŠè¿™ä¸ªlimitå‚æ•°ä¸‹æ¨åˆ°treeIndexæ¨¡å—åï¼Œæ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„limtæ•°å°±ç›´æ¥è¿”å›äº†ã€‚","user_name":"ä½œè€…å›å¤","comment_id":280425,"uid":"1009582","ip_address":"","utype":1,"ctime":1614229463,"user_name_real":"å”èª"}],"discussion_count":2,"race_medal":0,"score":"18794083708","product_id":100069901,"comment_content":"æ±‚æ•™å¤§ä½¬ï¼š<br>â€œå°† limit å‚æ•°ä¸‹æ¨åˆ°äº†ç´¢å¼•å±‚ï¼Œå®ç°æŸ¥è¯¢æ€§èƒ½ç™¾å€æå‡â€ è¿™ä¸ªä¸‹æ¨åˆ°ç´¢å¼•å±‚ï¼Œå…·ä½“æ˜¯æ€ä¹ˆæ ·çš„æ“ä½œå‘¢ï¼Ÿ","like_count":4,"discussions":[{"author":{"id":1009582,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/67/ae/37b492db.jpg","nickname":"å”èª","note":"","ucode":"99CB061EDF35EA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":516093,"discussion_content":"æ˜¯è¿™æ ·çš„ï¼Œæˆ‘ä¸¾ä¸ªä¾‹å­ï¼Œæ²¡è¿™ä¸ªä¼˜åŒ–ä¹‹å‰ï¼Œå¦‚æœä½ æœ‰1ç™¾ä¸‡çš„key,ä½ æŸ¥è¯¢ä¸ªlimit 1ï¼ŒtreeIndexä¹Ÿä¼šè¿”å›ä¸Šç™¾ä¸‡çš„keyç»™ä¸Šå±‚ï¼Œå¦‚æœæŠŠè¿™ä¸ªlimitå‚æ•°ä¸‹æ¨åˆ°treeIndexæ¨¡å—åï¼Œæ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„limtæ•°å°±ç›´æ¥è¿”å›äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1614229463,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1795546,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epCnxicMqCiah8lIOZM9oy0VNeWpmv0U8c3kIAgMcntWQPn514jfN6n0LL3VlJqQypQJG3icbUSsTKFQ/132","nickname":"Geek_18a705","note":"","ucode":"41B325020A8E12","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":579922,"discussion_content":"è¯·é—®è€å¸ˆèƒ½è´´ä¸‹å¯¹åº”çš„pr å—ï¼Ÿè°¢è°¢ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1657775376,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":298253,"user_name":"int8","can_delete":false,"product_type":"c1","uid":2027659,"ip_address":"","ucode":"EDE812592B8C06","user_header":"https://static001.geekbang.org/account/avatar/00/1e/f0/8b/a806789b.jpg","comment_is_top":false,"comment_ctime":1623982151,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"5918949447","product_id":100069901,"comment_content":"é•¿äº‹åŠ¡å¯¼è‡´dbå¢å¤§æ˜¯å› ä¸ºé•¿äº‹åŠ¡å¯èƒ½ä¼šé˜»å¡å‹ç¼©ä»»åŠ¡çš„æ‰§è¡Œä¹ˆï¼Ÿ","like_count":1},{"had_liked":false,"id":279049,"user_name":"å†™ç‚¹å•¥å‘¢","can_delete":false,"product_type":"c1","uid":1065272,"ip_address":"","ucode":"C19032CF1C41BA","user_header":"https://static001.geekbang.org/account/avatar/00/10/41/38/4f89095b.jpg","comment_is_top":false,"comment_ctime":1613568378,"is_pvip":false,"replies":[{"id":"101422","content":"1. treeIndexåœ¨å¯åŠ¨æ—¶å’Œè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå¯èƒ½å­˜åœ¨å¤šä¸ªgoroutineå¹¶å‘è®¿é—®çš„æƒ…å†µä¸‹ï¼Œæ¯”å¦‚è¿˜æœ‰compactionå¼‚æ­¥ä»»åŠ¡ä¹Ÿä¼šæ“ä½œå®ƒã€‚æˆ‘è¿™é‡Œè¯´çš„é˜»å¡åœ¨é”ä¸Šï¼Œå®é™…ä¸Šæ˜¯æˆ‘ä¹‹å‰å°è¯•å°†æ„å»ºtreeIndexæ”¹æˆå¹¶è¡Œï¼Œå› ä¸ºé»˜è®¤åªæœ‰1ä¸ªgoroutineä¸²è¡Œæ„å»ºçš„ï¼Œå‘ç°æ•ˆæœä¾ç„¶ä¸ä½³ï¼Œæˆ‘å®Œå–„ä¸‹æè¿°ã€‚<br>2. ä¸‹é¢å†™äº†ä¼šæ‰§è¡Œä¸€ç³»åˆ—è¿™æ ·çš„å‘½ä»¤ï¼Œvalueä¹Ÿæœ‰å˜åŒ–ï¼Œç›´åˆ°å‹æµ‹åˆ°14Gdbå¤§å°å·¦å³ï¼Œkey 1.2Mä¸ªã€‚","user_name":"ä½œè€…å›å¤","comment_id":279049,"uid":"1009582","ip_address":"","utype":1,"ctime":1613627649,"user_name_real":"å”èª"}],"discussion_count":2,"race_medal":0,"score":"5908535674","product_id":100069901,"comment_content":"è¯·é—®ä¸‹è€å¸ˆï¼š<br>1. etcdå¯åŠ¨æ—¶å€™æ„å»ºtreeindexä¸ºä»€ä¹ˆéœ€è¦åŠ é”ï¼Ÿå¦‚æœæ„å»ºæ—¶å€™æ˜¯å•goroutineæ˜¯å¦å¯ä»¥é¿å…åŠ é”æ“ä½œï¼Ÿ<br>2. .&#47;benchmark put --key-size 32 --val-size 10240 --total 1000000 --key-space-size 2000000 --clients 50 --conns 50 è¿™ä¸ªå‘½ä»¤totalå‚æ•°æ˜¯1ä¸ªMï¼Œä¸ºå•¥ä¼šæ’å…¥1.2Mä¸ªkeyå‘¢ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1009582,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/67/ae/37b492db.jpg","nickname":"å”èª","note":"","ucode":"99CB061EDF35EA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":515608,"discussion_content":"1. treeIndexåœ¨å¯åŠ¨æ—¶å’Œè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå¯èƒ½å­˜åœ¨å¤šä¸ªgoroutineå¹¶å‘è®¿é—®çš„æƒ…å†µä¸‹ï¼Œæ¯”å¦‚è¿˜æœ‰compactionå¼‚æ­¥ä»»åŠ¡ä¹Ÿä¼šæ“ä½œå®ƒã€‚æˆ‘è¿™é‡Œè¯´çš„é˜»å¡åœ¨é”ä¸Šï¼Œå®é™…ä¸Šæ˜¯æˆ‘ä¹‹å‰å°è¯•å°†æ„å»ºtreeIndexæ”¹æˆå¹¶è¡Œï¼Œå› ä¸ºé»˜è®¤åªæœ‰1ä¸ªgoroutineä¸²è¡Œæ„å»ºçš„ï¼Œå‘ç°æ•ˆæœä¾ç„¶ä¸ä½³ï¼Œæˆ‘å®Œå–„ä¸‹æè¿°ã€‚\n2. ä¸‹é¢å†™äº†ä¼šæ‰§è¡Œä¸€ç³»åˆ—è¿™æ ·çš„å‘½ä»¤ï¼Œvalueä¹Ÿæœ‰å˜åŒ–ï¼Œç›´åˆ°å‹æµ‹åˆ°14Gdbå¤§å°å·¦å³ï¼Œkey 1.2Mä¸ªã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1613627649,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1016270,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/81/ce/abb7bfe3.jpg","nickname":"æ‰å…‹å¸ƒ","note":"","ucode":"D59A55A44E8A98","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":349893,"discussion_content":"çŒœæµ‹gprcæœåŠ¡å·²ç»å¯åŠ¨äº†ï¼Œè¿™æ—¶ä¸åŠ é”ï¼Œè¯»å†™ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1613620761,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":349630,"user_name":"lidabai","can_delete":false,"product_type":"c1","uid":2677124,"ip_address":"","ucode":"BACB3430064469","user_header":"https://static001.geekbang.org/account/avatar/00/28/d9/84/9b03cd04.jpg","comment_is_top":false,"comment_ctime":1656166471,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1656166471","product_id":100069901,"comment_content":"å¦‚ä½•æŸ¥çœ‹etcdä¸­dbçš„å¤§å°ï¼Ÿ","like_count":1},{"had_liked":false,"id":326485,"user_name":"æ„è„¾æ°”çš„æ„å¦–ç²¾","can_delete":false,"product_type":"c1","uid":2132933,"ip_address":"","ucode":"81778A821819FA","user_header":"https://static001.geekbang.org/account/avatar/00/20/8b/c5/6e06e49c.jpg","comment_is_top":false,"comment_ctime":1639539056,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1639539056","product_id":100069901,"comment_content":"æƒ³é—®å°±æ˜¯å¦‚æœetcdæœ‰ä¸€æ¬¡è®¾ç½®quato-backend-bytesä¸º4Gä¹‹åï¼Œæ˜¯ä¿æŒè¿™ä¸ªé…é¢å¤§å°å—ï¼Œè¿˜æ˜¯åœæ‰ä¹‹åæŠŠè¿™ä¸ªé…ç½®åˆ æ‰ä¹‹åé‡å¯å°±åˆå˜æˆäº†2Gï¼Œé‚£å¦‚æœä¹‹å‰å†…å­˜å·²ç»æ˜¯3Gå¤šå‘¢","like_count":0},{"had_liked":false,"id":305971,"user_name":"æƒ˜ é—»","can_delete":false,"product_type":"c1","uid":1181650,"ip_address":"","ucode":"C5909F034BF072","user_header":"https://static001.geekbang.org/account/avatar/00/12/07/d2/0d7ee298.jpg","comment_is_top":false,"comment_ctime":1628251537,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1628251537","product_id":100069901,"comment_content":"ä¸ºä»€ä¹ˆé•¿äº‹åŠ¡ä¼šå¯¼è‡´dbå¢å¤§å‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1411096,"avatar":"https://static001.geekbang.org/account/avatar/00/15/88/18/9744d5ec.jpg","nickname":"å°è¶…äºº","note":"","ucode":"0D8A433F3E3737","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":392398,"discussion_content":"é•¿äº‹åŠ¡éœ€è¦ä¿ç•™æ•°æ®çš„ç‰ˆæœ¬æ¯”è¾ƒå¤šï¼Œå‹ç¼©æ—¶éœ€è¦è€ƒè™‘è¿™ä¸ªç‰ˆæœ¬çš„æ•°æ®æ˜¯å¦è¿˜æœ‰ç”¨å§","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630995412,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":301410,"user_name":"å¤©ç…§","can_delete":false,"product_type":"c1","uid":2654722,"ip_address":"","ucode":"AC0C31BC9C1336","user_header":"https://static001.geekbang.org/account/avatar/00/28/82/02/0bf31808.jpg","comment_is_top":false,"comment_ctime":1625666048,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1625666048","product_id":100069901,"comment_content":"è¯·é—®å”è€å¸ˆæ˜¯å¦é‡åˆ°è¿‡è¿™ç§æƒ…å†µï¼š<br>å½“DBsizeè¾ƒå¤§æ—¶ï¼Œè€Œä¸”é›†ç¾¤å¤„ç†çš„å†™å…¥è¯·æ±‚è¾ƒé«˜æ—¶ï¼Œè¦ä¿è¯è°ƒç”¨ä¸šåŠ¡æ— æŸæƒ…å†µä¸‹ï¼Œå•èŠ‚ç‚¹é‡å¯ã€åŠ¨æ€æ‰©å®¹æ“ä½œå¤±è´¥","like_count":0},{"had_liked":false,"id":292750,"user_name":"åä»”","can_delete":false,"product_type":"c1","uid":1218236,"ip_address":"","ucode":"CCFCEB843722A3","user_header":"https://static001.geekbang.org/account/avatar/00/12/96/bc/82a7becd.jpg","comment_is_top":false,"comment_ctime":1620960513,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1620960513","product_id":100069901,"comment_content":"è¯·æ•™è€å¸ˆï¼Œ<br>å½“å‰è¯´å»ºè®®dbå¤§å°ä¸è¶…è¿‡8Gï¼Œæ€ä¹ˆæ ·å»æŸ¥è¯¢å‡ºå½“å‰çš„etcdçš„dbå­˜å‚¨èƒ½åŠ›æ˜¯é»˜è®¤çš„2Gæˆ–è€…æ˜¯è¢«è°ƒæ•´è¿‡çš„å¤§å°å‘¢ï¼Ÿæƒ³æŸ¥çœ‹ä¸‹å¦‚æœè°ƒæ•´åˆ°äº†8Gï¼Œæ€ä¹ˆæ ·å¯ä»¥æŸ¥çœ‹åˆ°æ˜¯å¦è°ƒæ•´ç”Ÿæ•ˆã€‚","like_count":0},{"had_liked":false,"id":292154,"user_name":"å‡ºå–çµé­‚çš„æ•™ç»ƒKerry","can_delete":false,"product_type":"c1","uid":1807943,"ip_address":"","ucode":"8C64517DA556FE","user_header":"https://static001.geekbang.org/account/avatar/00/1b/96/47/93838ff7.jpg","comment_is_top":false,"comment_ctime":1620705260,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1620705260","product_id":100069901,"comment_content":"é•¿å¸¸åŠ¡å¯¼è‡´dbå¢å¤§ï¼Œæ˜¯å› ä¸ºç”¨äº†å†™æ—¶å¤åˆ¶å—ï¼Ÿ","like_count":0},{"had_liked":false,"id":285904,"user_name":"@%åˆ%@","can_delete":false,"product_type":"c1","uid":1053509,"ip_address":"","ucode":"2B8A6134675ED7","user_header":"https://static001.geekbang.org/account/avatar/00/10/13/45/16c60da2.jpg","comment_is_top":false,"comment_ctime":1617070111,"is_pvip":true,"replies":[{"id":"104093","content":"å—¯ï¼Œæ˜¯çš„ï¼Œæ˜¯ç”³è¯·è¿ç»­çš„è‹¥å¹²ä¸ªç©ºé—²page","user_name":"ä½œè€…å›å¤","comment_id":285904,"uid":"1009582","ip_address":"","utype":1,"ctime":1617437269,"user_name_real":"å”èª"}],"discussion_count":2,"race_medal":0,"score":"1617070111","product_id":100069901,"comment_content":"è¯·é—®è€å¸ˆï¼š<br>åœ¨æåˆ°æäº¤äº‹åŠ¡å»¶è¿Ÿè¿‡é«˜ï¼Œæœ‰freelistçš„åŸå› ï¼ŒåŸå› æ˜¯ç”³è¯·nä¸ªpageä¼šå¢åŠ è€—æ—¶ï¼Œæˆ‘æ²¡ç†è§£çš„æ˜¯ï¼š<br>freelistæœ¬å°±æ˜¯ç©ºé—²åˆ—è¡¨ï¼Œç›´æ¥å–nä¸ªå°±å¯ä»¥äº†ï¼Œä¸ºä»€ä¹ˆä¼šå¢åŠ è€—æ—¶å‘¢ï¼Ÿéš¾é“æ˜¯ç”³è¯·nä¸ªè¿ç»­çš„å†…å­˜ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1009582,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/67/ae/37b492db.jpg","nickname":"å”èª","note":"","ucode":"99CB061EDF35EA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":517821,"discussion_content":"å—¯ï¼Œæ˜¯çš„ï¼Œæ˜¯ç”³è¯·è¿ç»­çš„è‹¥å¹²ä¸ªç©ºé—²page","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617437269,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2028956,"avatar":"","nickname":"å‹¿æ›´æ”¹ä»»ä½•ä¿¡æ¯","note":"","ucode":"575185C69C05A3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":365234,"discussion_content":"ç”³è¯·çš„æ˜¯ç£ç›˜ä¸Šå·²ç»åˆ†é…çš„ç©ºé—²é¡µã€‚ä¸ºäº†æ–¹ä¾¿ç®¡ç†ï¼Œä»¥åŠæ•°æ®å†™å…¥é€Ÿåº¦å¿«ï¼Œå¿…é¡»è¦æ±‚ç£ç›˜é¡µè¿ç»­","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617755348,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}