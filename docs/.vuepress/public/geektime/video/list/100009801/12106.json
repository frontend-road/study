{"id":12106,"title":"34 | 小结 : 动手设计Channel版的EventBus","content":"<h1>源代码及 PDF 课件地址：</h1><p><strong><a href=\"https://gitee.com/geektime-geekbang/KotlinPrimer\">https://gitee.com/geektime-geekbang/KotlinPrimer</a></strong></p>","comments":[{"had_liked":false,"id":43044,"user_name":"刘建","can_delete":false,"product_type":"c3","uid":1184348,"ip_address":"","ucode":"8FAA03E146B16F","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/RRyBNDRiaQ1rfDf2es0Gw8kWMUtFrITmIIfPBjYUtKNcOVBgO85AsdGlibPdoicBibsIoiatOM2QKKzbjD51kLKPObA/132","comment_is_top":false,"comment_ctime":1543148895,"is_pvip":false,"replies":[{"id":15437,"content":"kotlin 1.3开始协程也发了稳定版，目前没发现问题","user_name":"作者回复","user_name_real":"kymjs张涛","uid":1009146,"ctime":1543194144,"ip_address":"","comment_id":43044,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100009801,"comment_content":"你好  协程库现在是否已经稳定  是否能用于生产环境呢  有没有什么已知的问题","like_count":1,"discussions":[{"author":{"id":1009146,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/65/fa/2b4d2f26.jpg","nickname":"kymjs张涛","note":"","ucode":"EFE7AF4C0D4FE8","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":430284,"discussion_content":"kotlin 1.3开始协程也发了稳定版，目前没发现问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1543194144,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":26681,"user_name":"HYM","can_delete":false,"product_type":"c3","uid":1054178,"ip_address":"","ucode":"4E82D9A285DAFF","user_header":"https://static001.geekbang.org/account/avatar/00/10/15/e2/c21553c4.jpg","comment_is_top":false,"comment_ctime":1537721983,"is_pvip":false,"replies":[{"id":10505,"content":"嗯，很棒","user_name":"作者回复","user_name_real":"kymjs张涛","uid":1009146,"ctime":1538306879,"ip_address":"","comment_id":26681,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100009801,"comment_content":"以下是我实现的EventBus（基于coroutine 0.26.1版本）\n\nobject EventBus {\n\n    &#47;&#47;hot observable\n    val mChannelMap: HashMap&lt;String, BroadcastChannel&lt;Any&gt;&gt; = HashMap()\n\n    &#47;&#47;cold observable(订阅后会把订阅之前产生的数据推送给订阅者)\n&#47;&#47;    val mChannelMap: HashMap&lt;String, ConflatedBroadcastChannel&lt;Any&gt;&gt; = HashMap()\n\n    val mJobMap: HashMap&lt;String, CoroutineContext&gt; = HashMap()\n\n    inline fun &lt;reified E&gt; post(e: E) {\n        val key = E::class.java.name\n        if (!mChannelMap.containsKey(key)) {\n            mChannelMap[key] = BroadcastChannel(1)\n        }\n        GlobalScope.launch {\n            mChannelMap[key]?.send(e as Any)\n        }\n    }\n\n    inline fun &lt;reified E&gt; registerEvent(noinline action: (E) -&gt; Unit) {\n        val key = E::class.java.name\n        if (!mChannelMap.containsKey(key)) {\n            mChannelMap[key] = BroadcastChannel(1)\n        }\n        GlobalScope.launch {\n            val channel = mChannelMap[key]\n            mJobMap[key] = coroutineContext\n            channel?.let {\n                val receiver = channel.openSubscription().filter { it is E }.map { it as E }\n                GlobalScope.launch(Dispatchers.Main) {\n                    for (i in receiver) {\n                        action.invoke(i)\n                    }\n                }\n            }\n        }\n    }\n\n    inline fun &lt;reified E&gt; unRegisterEvent() {\n        val key = E::class.java.name\n        if (mChannelMap.containsKey(key)) {\n            mChannelMap[key]?.close()\n            mChannelMap.remove(key)\n        }\n        if (mJobMap.containsKey(key)) {\n            mJobMap[key]?.cancelChildren()\n            mJobMap.remove(key)\n        }\n    }\n}","like_count":1,"discussions":[{"author":{"id":1009146,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/65/fa/2b4d2f26.jpg","nickname":"kymjs张涛","note":"","ucode":"EFE7AF4C0D4FE8","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":424709,"discussion_content":"嗯，很棒","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1538306879,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}