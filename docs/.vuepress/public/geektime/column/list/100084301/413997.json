{"id":413997,"title":"17 | Lazy Freeä¼šå½±å“ç¼“å­˜æ›¿æ¢å—ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯è’‹å¾·é’§ã€‚</p><p>Redisç¼“å­˜æ·˜æ±°ç®—æ³•çš„ç›®çš„ï¼Œå…¶å®æ˜¯ä¸ºäº†åœ¨Redis serverå†…å­˜ä½¿ç”¨é‡è¶…è¿‡ä¸Šé™å€¼çš„æ—¶å€™ï¼Œç­›é€‰ä¸€äº›å†·æ•°æ®å‡ºæ¥ï¼ŒæŠŠå®ƒä»¬ä»Redis serverä¸­åˆ é™¤ï¼Œä»¥ä¿è¯serverçš„å†…å­˜ä½¿ç”¨é‡ä¸è¶…å‡ºä¸Šé™ã€‚æˆ‘ä»¬åœ¨å‰ä¸¤èŠ‚è¯¾ï¼Œå·²ç»åˆ†åˆ«å­¦ä¹ äº†Redisæºç å¯¹LRUç®—æ³•å’ŒLFUç®—æ³•çš„å®ç°ï¼Œè¿™ä¸¤ç§ç®—æ³•åœ¨æœ€åæ·˜æ±°æ•°æ®çš„æ—¶å€™ï¼Œéƒ½ä¼šåˆ é™¤è¢«æ·˜æ±°çš„æ•°æ®ã€‚</p><p>ä¸è¿‡ï¼Œæ— è®ºæ˜¯LRUç®—æ³•è¿˜æ˜¯LFUç®—æ³•ï¼Œå®ƒä»¬åœ¨åˆ é™¤æ·˜æ±°æ•°æ®æ—¶ï¼Œå®é™…ä¸Šéƒ½ä¼šæ ¹æ®Redis serverçš„<strong>lazyfree-lazy-evictioné…ç½®é¡¹</strong>ï¼Œæ¥å†³å®šæ˜¯å¦ä½¿ç”¨Lazy Freeï¼Œä¹Ÿå°±æ˜¯æƒ°æ€§åˆ é™¤ã€‚</p><p>æƒ°æ€§åˆ é™¤æ˜¯Redis 4.0ç‰ˆæœ¬åæä¾›çš„åŠŸèƒ½ï¼Œå®ƒä¼šä½¿ç”¨åå°çº¿ç¨‹æ¥æ‰§è¡Œåˆ é™¤æ•°æ®çš„ä»»åŠ¡ï¼Œä»è€Œé¿å…äº†åˆ é™¤æ“ä½œå¯¹ä¸»çº¿ç¨‹çš„é˜»å¡ã€‚ä½†æ˜¯ï¼Œ<strong>åå°çº¿ç¨‹å¼‚æ­¥åˆ é™¤æ•°æ®èƒ½åŠæ—¶é‡Šæ”¾å†…å­˜å—ï¼Ÿå®ƒä¼šå½±å“åˆ°Redisç¼“å­˜çš„æ­£å¸¸ä½¿ç”¨å—ï¼Ÿ</strong></p><p>ä»Šå¤©è¿™èŠ‚è¯¾ï¼Œæˆ‘å°±æ¥ç»™ä½ ä»‹ç»ä¸‹æƒ°æ€§åˆ é™¤åœ¨ç¼“å­˜æ·˜æ±°æ—¶çš„åº”ç”¨ã€‚äº†è§£è¿™éƒ¨åˆ†å†…å®¹ï¼Œä½ å°±å¯ä»¥æŒæ¡æƒ°æ€§åˆ é™¤å¯ç”¨åï¼Œä¼šç»™Redisç¼“å­˜æ·˜æ±°å’Œå†…å­˜é‡Šæ”¾å¸¦æ¥çš„å¯èƒ½å½±å“ã€‚è¿™æ ·ï¼Œå½“ä½ åœ¨å®é™…åº”ç”¨ä¸­ï¼Œé‡åˆ°Redisç¼“å­˜å†…å­˜å®¹é‡çš„é—®é¢˜æ—¶ï¼Œä½ å°±å¤šäº†ä¸€æ¡æ’æŸ¥æ€è·¯äº†ã€‚</p><p>å¥½ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å…ˆæ¥çœ‹ä¸‹ç¼“å­˜æ·˜æ±°æ—¶çš„æ•°æ®åˆ é™¤çš„åŸºæœ¬è¿‡ç¨‹ã€‚ä¸è¿‡åœ¨äº†è§£è¿™ä¸ªåˆ é™¤è¿‡ç¨‹ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£ä¸‹Redis serverå¯åŠ¨æƒ°æ€§åˆ é™¤çš„é…ç½®ã€‚å› ä¸ºåœ¨Redisæºç ä¸­ï¼Œæœ‰ä¸å°‘åœ°æ–¹éƒ½ä¼šæ ¹æ®serveræ˜¯å¦å¯åŠ¨æƒ°æ€§åˆ é™¤ï¼Œæ¥æ‰§è¡Œä¸åŒçš„åˆ†æ”¯æ“ä½œã€‚</p><!-- [[[read_end]]] --><h2>æƒ°æ€§åˆ é™¤çš„è®¾ç½®</h2><p>é¦–å…ˆï¼Œå½“Redis serverå¸Œæœ›å¯åŠ¨æƒ°æ€§åˆ é™¤æ—¶ï¼Œéœ€è¦åœ¨redis.confæ–‡ä»¶ä¸­è®¾ç½®å’Œæƒ°æ€§åˆ é™¤ç›¸å…³çš„é…ç½®é¡¹ã€‚å…¶ä¸­åŒ…æ‹¬äº†å››ä¸ªé…ç½®é¡¹ï¼Œåˆ†åˆ«å¯¹åº”äº†å¦‚ä¸‹çš„å››ç§åœºæ™¯ã€‚</p><ul>\n<li><strong>lazyfree-lazy-eviction</strong>ï¼šå¯¹åº”ç¼“å­˜æ·˜æ±°æ—¶çš„æ•°æ®åˆ é™¤åœºæ™¯ã€‚</li>\n<li><strong>lazyfree-lazy-expire</strong>ï¼šå¯¹åº”è¿‡æœŸkeyçš„åˆ é™¤åœºæ™¯ã€‚</li>\n<li><strong>lazyfree-lazy-server-del</strong>ï¼šå¯¹åº”ä¼šéšå¼è¿›è¡Œåˆ é™¤æ“ä½œçš„serverå‘½ä»¤æ‰§è¡Œåœºæ™¯ã€‚</li>\n<li><strong>replica-lazy-flush</strong>ï¼šå¯¹åº”ä»èŠ‚ç‚¹å®Œæˆå…¨é‡åŒæ­¥åï¼Œåˆ é™¤åŸæœ‰æ—§æ•°æ®çš„åœºæ™¯ã€‚</li>\n</ul><p>è¿™å››ä¸ªé…ç½®é¡¹çš„é»˜è®¤å€¼éƒ½æ˜¯noã€‚æ‰€ä»¥ï¼Œå¦‚æœè¦åœ¨ç¼“å­˜æ·˜æ±°æ—¶å¯ç”¨ï¼Œå°±éœ€è¦å°†</p><p>lazyfree-lazy-evictionè®¾ç½®ä¸ºyesã€‚åŒæ—¶ï¼ŒRedis serveråœ¨å¯åŠ¨è¿‡ç¨‹ä¸­è¿›è¡Œé…ç½®å‚æ•°åˆå§‹åŒ–æ—¶ï¼Œä¼šæ ¹æ®redis.confçš„é…ç½®ä¿¡æ¯ï¼Œè®¾ç½®å…¨å±€å˜é‡serverçš„lazyfree_lazy_evictionæˆå‘˜å˜é‡ã€‚</p><p>è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬åœ¨Redisæºç ä¸­ï¼Œå¦‚æœçœ‹åˆ°å¯¹server.lazyfree_lazy_evictionå˜é‡å€¼è¿›è¡Œæ¡ä»¶åˆ¤æ–­ï¼Œé‚£å…¶å®å°±æ˜¯Redisæ ¹æ®lazyfree-lazy-evictioné…ç½®é¡¹ï¼Œæ¥å†³å®šæ˜¯å¦æ‰§è¡Œæƒ°æ€§åˆ é™¤ã€‚</p><p>å¥½äº†ï¼Œäº†è§£äº†å¦‚ä½•åœ¨ç¼“å­˜æ·˜æ±°åœºæ™¯ä¸­è®¾ç½®æƒ°æ€§åˆ é™¤ä¹‹åï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥çœ‹ä¸‹è¢«æ·˜æ±°æ•°æ®çš„åˆ é™¤è¿‡ç¨‹ã€‚</p><h2>è¢«æ·˜æ±°æ•°æ®çš„åˆ é™¤è¿‡ç¨‹</h2><p>å…¶å®é€šè¿‡å‰ä¸¤èŠ‚è¯¾ç¨‹çš„å­¦ä¹ ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“ï¼ŒRedisæºç ä¸­çš„freeMemoryIfNeededå‡½æ•°ï¼ˆåœ¨<a href=\"https://github.com/redis/redis/tree/5.0/src/evict.c\">evict.c</a>æ–‡ä»¶ä¸­ï¼‰ä¼šè´Ÿè´£æ‰§è¡Œæ•°æ®æ·˜æ±°çš„æµç¨‹ã€‚è€Œè¯¥å‡½æ•°åœ¨ç­›é€‰å‡ºè¢«æ·˜æ±°çš„é”®å€¼å¯¹åï¼Œå°±è¦å¼€å§‹åˆ é™¤è¢«æ·˜æ±°çš„æ•°æ®ï¼Œè¿™ä¸ªåˆ é™¤è¿‡ç¨‹ä¸»è¦åˆ†æˆä¸¤æ­¥ã€‚</p><p><strong>ç¬¬ä¸€æ­¥</strong>ï¼ŒfreeMemoryIfNeededå‡½æ•°ä¼šä¸ºè¢«æ·˜æ±°çš„keyåˆ›å»ºä¸€ä¸ªSDSå¯¹è±¡ï¼Œç„¶åè°ƒç”¨propagateExpireå‡½æ•°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>int freeMemoryIfNeeded(void) {\n   â€¦\n   if (bestkey) {\n      db = server.db+bestdbid;\n      robj *keyobj = createStringObject(bestkey,sdslen(bestkey));\n\tpropagateExpire(db,keyobj,server.lazyfree_lazy_eviction);\n   â€¦\n}\n</code></pre><p>propagateExpireå‡½æ•°æ˜¯åœ¨<a href=\"https://github.com/redis/redis/tree/5.0/src/db.c\">db.c</a>æ–‡ä»¶ä¸­å®ç°çš„ã€‚å®ƒä¼šå…ˆåˆ›å»ºä¸€ä¸ªredisObjectç»“æ„ä½“æ•°ç»„ï¼Œè¯¥æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯åˆ é™¤æ“ä½œå¯¹åº”çš„å‘½ä»¤å¯¹è±¡ï¼Œè€Œç¬¬äºŒä¸ªå…ƒç´ æ˜¯è¢«åˆ é™¤çš„keyå¯¹è±¡ã€‚å› ä¸ºRedis serverå¯èƒ½é’ˆå¯¹ç¼“å­˜æ·˜æ±°åœºæ™¯å¯ç”¨äº†æƒ°æ€§åˆ é™¤ï¼Œæ‰€ä»¥ï¼Œ<strong>propagateExpireå‡½æ•°ä¼šæ ¹æ®å…¨å±€å˜é‡serverçš„lazyfree_lazy_evictionæˆå‘˜å˜é‡çš„å€¼ï¼Œæ¥å†³å®šåˆ é™¤æ“ä½œå…·ä½“å¯¹åº”çš„æ˜¯å“ªä¸ªå‘½ä»¤ã€‚</strong></p><p>å¦‚æœlazyfree_lazy_evictionè¢«è®¾ç½®ä¸º1ï¼Œä¹Ÿå°±æ˜¯å¯ç”¨äº†ç¼“å­˜æ·˜æ±°æ—¶çš„æƒ°æ€§åˆ é™¤ï¼Œé‚£ä¹ˆï¼Œåˆ é™¤æ“ä½œå¯¹åº”çš„å‘½ä»¤å°±æ˜¯UNLINKï¼›å¦åˆ™çš„è¯ï¼Œå‘½ä»¤å°±æ˜¯DELã€‚å› ä¸ºè¿™äº›å‘½ä»¤ä¼šè¢«ç»å¸¸ä½¿ç”¨ï¼Œæ‰€ä»¥Redisæºç ä¸­ä¼šä¸ºè¿™äº›å‘½ä»¤åˆ›å»ºå…±äº«å¯¹è±¡ã€‚è¿™äº›å…±äº«å¯¹è±¡çš„æ•°æ®ç»“æ„æ˜¯sharedObjectsStructç»“æ„ä½“ï¼Œå¹¶ç”¨ä¸€ä¸ªå…¨å±€å˜é‡sharedæ¥è¡¨ç¤ºã€‚åœ¨è¯¥ç»“æ„ä½“ä¸­åŒ…å«äº†æŒ‡å‘å…±äº«å¯¹è±¡çš„æŒ‡é’ˆï¼Œè¿™å…¶ä¸­å°±åŒ…æ‹¬äº†unlinkå’Œdelå‘½ä»¤å¯¹è±¡ã€‚</p><p>ä»¥ä¸‹ä»£ç å±•ç¤ºäº†sharedå…¨å±€å˜é‡çš„å®šä¹‰ä»¥åŠsharedObjectsStructç»“æ„ä½“çš„å®šä¹‰ï¼Œå…¶ä¸­ï¼Œsharedå˜é‡æ˜¯åœ¨<a href=\"https://github.com/redis/redis/tree/5.0/src/server.c\">server.c</a>æ–‡ä»¶ä¸­å®šä¹‰çš„ï¼Œè€ŒsharedObjectsStructç»“æ„ä½“æ˜¯åœ¨<a href=\"https://github.com/redis/redis/tree/5.0/src/server.h\">server.h</a>ä¸­å®šä¹‰çš„ã€‚</p><pre><code>struct sharedObjectsStruct shared;\n\nstruct sharedObjectsStruct {\n    ...\n    robj *del, *unlink,\n    ...\n}\n</code></pre><p>ç„¶åï¼ŒpropagateExpireå‡½æ•°åœ¨ä¸ºåˆ é™¤æ“ä½œåˆ›å»ºå‘½ä»¤å¯¹è±¡æ—¶ï¼Œå°±ä½¿ç”¨äº†sharedå˜é‡ä¸­çš„unlinkæˆ–delå¯¹è±¡ï¼Œè¿™éƒ¨åˆ†ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>void propagateExpire(redisDb *db, robj *key, int lazy) {\n    robj *argv[2];\n \n    argv[0] = lazy ? shared.unlink : shared.del;  //å¦‚æœserverå¯ç”¨äº†lazyfree-lazy-evictï¼Œé‚£ä¹ˆargv[0]çš„å€¼ä¸ºunlinkå¯¹è±¡ï¼Œå¦åˆ™ä¸ºdelå¯¹è±¡\n    argv[1] = key; //è¢«æ·˜æ±°çš„keyå¯¹è±¡\n    ...\n}\n</code></pre><p>ç´§æ¥ç€ï¼ŒpropagateExpireå‡½æ•°ä¼šåˆ¤æ–­Redis serveræ˜¯å¦å¯ç”¨äº†AOFæ—¥å¿—ã€‚å¦‚æœå¯ç”¨äº†ï¼Œé‚£ä¹ˆpropagateExpireå‡½æ•°ä¼šå…ˆæŠŠè¢«æ·˜æ±°keyçš„åˆ é™¤æ“ä½œè®°å½•åˆ°AOFæ–‡ä»¶ä¸­ï¼Œä»¥ä¿è¯åç»­ä½¿ç”¨AOFæ–‡ä»¶è¿›è¡ŒRedisæ•°æ®åº“æ¢å¤æ—¶ï¼Œå¯ä»¥å’Œæ¢å¤å‰ä¿æŒä¸€è‡´ã€‚è¿™ä¸€æ­¥æ˜¯é€šè¿‡è°ƒç”¨feedAppendOnlyFileå‡½æ•°ï¼ˆåœ¨<a href=\"https://github.com/redis/redis/tree/5.0/src/aof.c\">aof.c</a>æ–‡ä»¶ä¸­ï¼‰æ¥å®ç°çš„ã€‚</p><p>ç„¶åï¼ŒpropagateExpireå‡½æ•°ä¼šè°ƒç”¨replicationFeedSlaveså‡½æ•°ï¼ˆåœ¨<a href=\"https://github.com/redis/redis/tree/5.0/src/replication.c\">replication.c</a>æ–‡ä»¶ä¸­ï¼‰ï¼ŒæŠŠåˆ é™¤æ“ä½œåŒæ­¥ç»™ä»èŠ‚ç‚¹ï¼Œä»¥ä¿è¯ä¸»ä»èŠ‚ç‚¹çš„æ•°æ®ä¸€è‡´ã€‚</p><p>ä¸‹é¢ä»£ç å±•ç¤ºäº†propagateExpireå‡½æ•°çš„åŸºæœ¬æµç¨‹ï¼Œä½ å¯ä»¥çœ‹ä¸‹ã€‚</p><pre><code>    â€¦\n    //å¦‚æœå¯ç”¨äº†AOFæ—¥å¿—ï¼Œåˆ™å°†åˆ é™¤æ“ä½œå†™å…¥AOFæ–‡ä»¶\n    if (server.aof_state != AOF_OFF)\n        feedAppendOnlyFile(server.delCommand,db-&gt;id,argv,2);\n    //å°†åˆ é™¤æ“ä½œåŒæ­¥ç»™ä»èŠ‚ç‚¹\n\t  replicationFeedSlaves(server.slaves,db-&gt;id,argv,2);\n\t  â€¦\n</code></pre><p>ä¸ºäº†ä¾¿äºä½ æ›´ç›´è§‚åœ°ç†è§£è¿™ä¸ªæµç¨‹ï¼Œæˆ‘ä¹Ÿç”»äº†ä¸€å¼ å›¾ï¼Œä½ å¯ä»¥å‚è€ƒä¸‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/74/9f/74200fb7ccbcb0cyya8cff7189e5009f.jpg?wh=1852x858\" alt=\"\"></p><p>è¿™æ ·æ¥ä¸‹æ¥ï¼ŒfreeMemoryIfNeededå‡½æ•°å°±ä¼šå¼€å§‹æ‰§è¡Œåˆ é™¤æ“ä½œã€‚</p><p><strong>ç¬¬äºŒæ­¥</strong>ï¼ŒfreeMemoryIfNeededå‡½æ•°ä¼šæ ¹æ®serveræ˜¯å¦å¯ç”¨äº†æƒ°æ€§åˆ é™¤ï¼Œåˆ†åˆ«æ‰§è¡Œä¸¤ä¸ªåˆ†æ”¯ã€‚</p><ul>\n<li>åˆ†æ”¯ä¸€ï¼šå¦‚æœserverå¯ç”¨äº†æƒ°æ€§åˆ é™¤ï¼ŒfreeMemoryIfNeededå‡½æ•°ä¼šè°ƒç”¨dbAsyncDeleteå‡½æ•°è¿›è¡Œå¼‚æ­¥åˆ é™¤ã€‚</li>\n<li>åˆ†æ”¯äºŒï¼šå¦‚æœserveræœªå¯ç”¨æƒ°æ€§åˆ é™¤ï¼ŒfreeMemoryIfNeededå‡½æ•°ä¼šè°ƒç”¨dbSyncDeleteå‡½æ•°è¿›è¡ŒåŒæ­¥åˆ é™¤ã€‚</li>\n</ul><p>è€Œæ— è®ºæ˜¯æ‰§è¡Œå¼‚æ­¥åˆ é™¤è¿˜æ˜¯åŒæ­¥åˆ é™¤ï¼ŒfreeMemoryIfNeededå‡½æ•°éƒ½ä¼šåœ¨è°ƒç”¨åˆ é™¤å‡½æ•°å‰ï¼Œè°ƒç”¨<strong>zmalloc_used_memoryå‡½æ•°</strong>ï¼ˆåœ¨<a href=\"http://github.com/redis/redis/tree/5.0/src/zmalloc.c\">zmalloc.c</a>æ–‡ä»¶ä¸­ï¼‰è®¡ç®—å½“å‰ä½¿ç”¨çš„å†…å­˜é‡ã€‚ç„¶åï¼Œå®ƒåœ¨è°ƒç”¨åˆ é™¤å‡½æ•°åï¼Œä¼šå†æ¬¡è°ƒç”¨zmalloc_used_memoryå‡½æ•°è®¡ç®—æ­¤æ—¶çš„å†…å­˜ä½¿ç”¨é‡ï¼Œå¹¶è®¡ç®—åˆ é™¤æ“ä½œå¯¼è‡´çš„å†…å­˜ä½¿ç”¨é‡å·®å€¼ï¼Œè¿™ä¸ªå·®å€¼å°±æ˜¯é€šè¿‡åˆ é™¤æ“ä½œè€Œè¢«é‡Šæ”¾çš„å†…å­˜é‡ã€‚</p><p>æ‰€ä»¥ï¼ŒfreeMemoryIfNeededå‡½æ•°æœ€åä¼šæŠŠè¿™éƒ¨åˆ†é‡Šæ”¾çš„å†…å­˜é‡å’Œå·²é‡Šæ”¾çš„å†…å­˜é‡ç›¸åŠ ï¼Œå¾—åˆ°æœ€æ–°çš„å†…å­˜é‡Šæ”¾é‡ã€‚è¿™éƒ¨åˆ†çš„æ‰§è¡Œé€»è¾‘å¦‚ä»¥ä¸‹ä»£ç æ‰€ç¤ºï¼š</p><pre><code>delta = (long long) zmalloc_used_memory(); //è·å–å½“å‰å†…å­˜ä½¿ç”¨é‡\nif (server.lazyfree_lazy_eviction)\n      dbAsyncDelete(db,keyobj);  //å¦‚æœå¯ç”¨äº†æƒ°æ€§åˆ é™¤ï¼Œåˆ™è¿›è¡Œå¼‚æ­¥åˆ é™¤\nelse\n     dbSyncDelete(db,keyobj); //å¦åˆ™ï¼Œè¿›è¡ŒåŒæ­¥åˆ é™¤\ndelta -= (long long) zmalloc_used_memory(); //æ ¹æ®å½“å‰å†…å­˜ä½¿ç”¨é‡è®¡ç®—æ•°æ®åˆ é™¤å‰åé‡Šæ”¾çš„å†…å­˜é‡\nmem_freed += delta; //æ›´æ–°å·²é‡Šæ”¾çš„å†…å­˜é‡\n</code></pre><p>æ‰€ä»¥åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±çŸ¥é“äº†freeMemoryIfNeededå‡½æ•°åœ¨é€‰å®šè¢«åˆ é™¤çš„é”®å€¼å¯¹åï¼Œå¯ä»¥é€šè¿‡å¼‚æ­¥æˆ–åŒæ­¥æ“ä½œæ¥å®Œæˆæ•°æ®çš„å®é™…åˆ é™¤ã€‚é‚£ä¹ˆï¼Œ<strong>æ•°æ®å¼‚æ­¥åˆ é™¤å’ŒåŒæ­¥åˆ é™¤å…·ä½“åˆæ˜¯å¦‚ä½•æ‰§è¡Œçš„å‘¢ï¼Ÿ</strong></p><p>ä¸‹é¢ï¼Œæˆ‘ä»¬å°±æ¥å…·ä½“äº†è§£ä¸‹ã€‚</p><h2>æ•°æ®åˆ é™¤æ“ä½œ</h2><p>åœ¨å­¦ä¹ æ•°æ®å¼‚æ­¥æˆ–åŒæ­¥åˆ é™¤ä¹‹å‰ï¼Œä½ é¦–å…ˆéœ€è¦çŸ¥é“ï¼Œåˆ é™¤æ“ä½œå®é™…ä¸Šæ˜¯åŒ…æ‹¬äº†ä¸¤æ­¥å­æ“ä½œã€‚</p><ul>\n<li>å­æ“ä½œä¸€ï¼šå°†è¢«æ·˜æ±°çš„é”®å€¼å¯¹ä»å“ˆå¸Œè¡¨ä¸­å»é™¤ï¼Œè¿™é‡Œçš„å“ˆå¸Œè¡¨æ—¢å¯èƒ½æ˜¯è®¾ç½®äº†è¿‡æœŸkeyçš„å“ˆå¸Œè¡¨ï¼Œä¹Ÿå¯èƒ½æ˜¯å…¨å±€å“ˆå¸Œè¡¨ã€‚</li>\n<li>å­æ“ä½œäºŒï¼šé‡Šæ”¾è¢«æ·˜æ±°é”®å€¼å¯¹æ‰€å ç”¨çš„å†…å­˜ç©ºé—´ã€‚</li>\n</ul><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœè¿™ä¸¤ä¸ªå­æ“ä½œä¸€èµ·åšï¼Œé‚£ä¹ˆå°±æ˜¯<strong>åŒæ­¥åˆ é™¤</strong>ï¼›å¦‚æœåªåšäº†å­æ“ä½œä¸€ï¼Œè€Œå­æ“ä½œäºŒç”±åå°çº¿ç¨‹æ¥æ‰§è¡Œï¼Œé‚£ä¹ˆå°±æ˜¯<strong>å¼‚æ­¥åˆ é™¤</strong>ã€‚</p><p>é‚£ä¹ˆå¯¹äºRedisæºç æ¥è¯´ï¼Œå®ƒæ˜¯ä½¿ç”¨äº†<strong>dictGenericDeleteå‡½æ•°</strong>ï¼Œæ¥å®ç°å‰é¢ä»‹ç»çš„è¿™ä¸¤ä¸ªå­æ“ä½œã€‚dictGenericDeleteå‡½æ•°æ˜¯åœ¨dict.cæ–‡ä»¶ä¸­å®ç°çš„ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥äº†è§£ä¸‹å®ƒçš„å…·ä½“æ‰§è¡Œè¿‡ç¨‹ã€‚</p><p><strong>é¦–å…ˆï¼ŒdictGenericDeleteå‡½æ•°ä¼šå…ˆåœ¨å“ˆå¸Œè¡¨ä¸­æŸ¥æ‰¾è¦åˆ é™¤çš„keyã€‚</strong>å®ƒä¼šè®¡ç®—è¢«åˆ é™¤keyçš„å“ˆå¸Œå€¼ï¼Œç„¶åæ ¹æ®å“ˆå¸Œå€¼æ‰¾åˆ°keyæ‰€åœ¨çš„å“ˆå¸Œæ¡¶ã€‚</p><p>å› ä¸ºä¸åŒkeyçš„å“ˆå¸Œå€¼å¯èƒ½ç›¸åŒï¼Œè€ŒRedisçš„å“ˆå¸Œè¡¨æ˜¯é‡‡ç”¨äº†é“¾å¼å“ˆå¸Œï¼ˆä½ å¯ä»¥å›é¡¾ä¸‹<a href=\"https://time.geekbang.org/column/article/400379\">ç¬¬3è®²</a>ä¸­ä»‹ç»çš„é“¾å¼å“ˆå¸Œï¼‰ï¼Œæ‰€ä»¥å³ä½¿æˆ‘ä»¬æ ¹æ®ä¸€ä¸ªkeyçš„å“ˆå¸Œå€¼ï¼Œå®šä½åˆ°äº†å®ƒæ‰€åœ¨çš„å“ˆå¸Œæ¡¶ï¼Œæˆ‘ä»¬ä¹Ÿä»ç„¶éœ€è¦åœ¨è¿™ä¸ªå“ˆå¸Œæ¡¶ä¸­å»æ¯”å¯¹æŸ¥æ‰¾ï¼Œè¿™ä¸ªkeyæ˜¯å¦çœŸçš„å­˜åœ¨ã€‚</p><p>ä¹Ÿæ­£æ˜¯ç”±äºè¿™ä¸ªåŸå› ï¼ŒdictGenericDeleteå‡½æ•°ç´§æ¥ç€å°±ä¼šåœ¨å“ˆå¸Œæ¡¶ä¸­ï¼Œè¿›ä¸€æ­¥æ¯”å¯¹æŸ¥æ‰¾è¦åˆ é™¤çš„keyã€‚å¦‚æœæ‰¾åˆ°äº†ï¼Œå®ƒå°±å…ˆæŠŠè¿™ä¸ªkeyä»å“ˆå¸Œè¡¨ä¸­å»é™¤ï¼Œä¹Ÿå°±æ˜¯æŠŠè¿™ä¸ªkeyä»å“ˆå¸Œæ¡¶çš„é“¾è¡¨ä¸­å»é™¤ã€‚</p><p><strong>ç„¶åï¼ŒdictGenericDeleteå‡½æ•°ä¼šæ ¹æ®ä¼ å…¥å‚æ•°nofreeçš„å€¼ï¼Œå†³å®šæ˜¯å¦å®é™…é‡Šæ”¾keyå’Œvalueçš„å†…å­˜ç©ºé—´ã€‚</strong>dictGenericDeleteå‡½æ•°ä¸­çš„è¿™éƒ¨åˆ†æ‰§è¡Œé€»è¾‘å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>h = dictHashKey(d, key); //è®¡ç®—keyçš„å“ˆå¸Œå€¼\nfor (table = 0; table &lt;= 1; table++) {\n   idx = h &amp; d-&gt;ht[table].sizemask;  //æ ¹æ®keyçš„å“ˆå¸Œå€¼è·å–å®ƒæ‰€åœ¨çš„å“ˆå¸Œæ¡¶ç¼–å·\n   he = d-&gt;ht[table].table[idx];   //è·å–keyæ‰€åœ¨å“ˆå¸Œæ¡¶çš„ç¬¬ä¸€ä¸ªå“ˆå¸Œé¡¹\n   prevHe = NULL;\n   while(he) {   //åœ¨å“ˆå¸Œæ¡¶ä¸­é€ä¸€æŸ¥æ‰¾è¢«åˆ é™¤çš„keyæ˜¯å¦å­˜åœ¨\n      if (key==he-&gt;key || dictCompareKeys(d, key, he-&gt;key)) {\n         //å¦‚æœæ‰¾è§è¢«åˆ é™¤keyäº†ï¼Œé‚£ä¹ˆå°†å®ƒä»å“ˆå¸Œæ¡¶çš„é“¾è¡¨ä¸­å»é™¤\n         if (prevHe)\n            prevHe-&gt;next = he-&gt;next;\n         else\n            d-&gt;ht[table].table[idx] = he-&gt;next;\n          if (!nofree) {  //å¦‚æœè¦åŒæ­¥åˆ é™¤ï¼Œé‚£ä¹ˆå°±é‡Šæ”¾keyå’Œvalueçš„å†…å­˜ç©ºé—´\n             dictFreeKey(d, he); //è°ƒç”¨dictFreeKeyé‡Šæ”¾\n             dictFreeVal(d, he);\n             zfree(he);\n           }\n           d-&gt;ht[table].used--;\n           return he;\n      }\n      prevHe = he;\n       he = he-&gt;next;   //å½“å‰keyä¸æ˜¯è¦æŸ¥æ‰¾çš„keyï¼Œå†æ‰¾ä¸‹ä¸€ä¸ª\n   }\n   ...\n}\n</code></pre><p>é‚£ä¹ˆï¼Œä»dictGenericDeleteå‡½æ•°çš„å®ç°ä¸­ï¼Œä½ å¯ä»¥å‘ç°ï¼ŒdictGenericDeleteå‡½æ•°å®é™…ä¸Šä¼šæ ¹æ®nofreeå‚æ•°ï¼Œæ¥å†³å®šæ‰§è¡Œçš„æ˜¯åŒæ­¥åˆ é™¤è¿˜æ˜¯å¼‚æ­¥åˆ é™¤ã€‚è€ŒRedisæºç åœ¨dictGenericDeleteå‡½æ•°çš„åŸºç¡€ä¸Šï¼Œè¿˜å°è£…äº†<strong>ä¸¤ä¸ªå‡½æ•°dictDeleteå’ŒdictUnlink</strong>ã€‚</p><p>è¿™ä¸¤ä¸ªå‡½æ•°çš„åŒºåˆ«å°±åœ¨äºï¼Œå®ƒä»¬ç»™dictGenericDeleteå‡½æ•°ä¼ é€’çš„nofreeå‚æ•°å€¼æ˜¯0ï¼Œè¿˜æ˜¯1ã€‚å¦‚æœå…¶ä¸­nofreeçš„å€¼ä¸º0ï¼Œè¡¨ç¤ºçš„å°±æ˜¯åŒæ­¥åˆ é™¤ï¼Œè€Œnofreeå€¼ä¸º1ï¼Œè¡¨ç¤ºçš„åˆ™æ˜¯å¼‚æ­¥åˆ é™¤ã€‚</p><p>ä¸‹é¢çš„ä»£ç å±•ç¤ºäº†dictGenericDeleteå‡½æ•°åŸå‹ï¼Œä»¥åŠdictDeleteå’ŒdictUnlinkä¸¤ä¸ªå‡½æ•°çš„å®ç°ï¼Œä½ å¯ä»¥çœ‹ä¸‹ã€‚</p><pre><code>//dictGenericDeleteå‡½æ•°åŸå‹ï¼Œå‚æ•°æ˜¯å¾…æŸ¥æ‰¾çš„å“ˆå¸Œè¡¨ï¼Œå¾…æŸ¥æ‰¾çš„keyï¼Œä»¥åŠåŒæ­¥/å¼‚æ­¥åˆ é™¤æ ‡è®°\nstatic dictEntry *dictGenericDelete(dict *d, const void *key, int nofree) \n\n//åŒæ­¥åˆ é™¤å‡½æ•°ï¼Œä¼ ç»™dictGenericDeleteå‡½æ•°çš„nofreeå€¼ä¸º0\nint dictDelete(dict *ht, const void *key) {\n    return dictGenericDelete(ht,key,0) ? DICT_OK : DICT_ERR;\n}\n\n//å¼‚æ­¥åˆ é™¤å‡½æ•°ï¼Œä¼ ç»™dictGenericDeleteå‡½æ•°çš„nofreeå€¼ä¸º1\ndictEntry *dictUnlink(dict *ht, const void *key) {\n    return dictGenericDelete(ht,key,1);\n}\n</code></pre><p>å¥½äº†ï¼Œåˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±äº†è§£äº†åŒæ­¥åˆ é™¤å’Œå¼‚æ­¥åˆ é™¤çš„åŸºæœ¬ä»£ç å®ç°ã€‚ä¸‹é¢æˆ‘ä»¬å°±å†æ¥çœ‹ä¸‹ï¼Œåœ¨åˆšæ‰ä»‹ç»çš„freeMemoryIfNeededå‡½æ•°ä¸­ï¼Œå®ƒåœ¨åˆ é™¤é”®å€¼å¯¹æ—¶ï¼Œæ‰€è°ƒç”¨çš„dbAsyncDeleteå’ŒdbSyncDeleteè¿™ä¸¤ä¸ªå‡½æ•°ï¼Œæ˜¯å¦‚ä½•ä½¿ç”¨dictDeleteå’ŒdictUnlinkæ¥å®é™…åˆ é™¤è¢«æ·˜æ±°æ•°æ®çš„ã€‚</p><h3>åŸºäºå¼‚æ­¥åˆ é™¤çš„æ•°æ®æ·˜æ±°</h3><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹åŸºäºå¼‚æ­¥åˆ é™¤çš„æ•°æ®æ·˜æ±°è¿‡ç¨‹ã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯ç”±<strong>dbAsyncDeleteå‡½æ•°</strong>æ‰§è¡Œçš„ï¼Œå®ƒæ˜¯åœ¨<a href=\"http://github.com/redis/redis/tree/5.0/src/lazyfree.c\">lazyfree.c</a>æ–‡ä»¶ä¸­å®ç°çš„ã€‚è€Œè¿™ä¸ªå‡½æ•°çš„æ‰§è¡Œé€»è¾‘å…¶å®å¹¶ä¸å¤æ‚ï¼Œä¸»è¦å¯ä»¥åˆ†æˆä¸‰æ­¥ã€‚</p><p><strong>ç¬¬ä¸€æ­¥</strong>ï¼ŒdbAsyncDeleteå‡½æ•°ä¼šè°ƒç”¨dictDeleteå‡½æ•°ï¼Œåœ¨è¿‡æœŸkeyçš„å“ˆå¸Œè¡¨ä¸­åŒæ­¥åˆ é™¤è¢«æ·˜æ±°çš„é”®å€¼å¯¹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code> if (dictSize(db-&gt;expires) &gt; 0) dictDelete(db-&gt;expires,key-&gt;ptr);\n</code></pre><p><strong>ç¬¬äºŒæ­¥</strong>ï¼ŒdbAsyncDeleteå‡½æ•°ä¼šè°ƒç”¨dictUnlinkå‡½æ•°ï¼Œåœ¨å…¨å±€å“ˆå¸Œè¡¨ä¸­å¼‚æ­¥åˆ é™¤è¢«æ·˜æ±°çš„é”®å€¼å¯¹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>dictEntry *de = dictUnlink(db-&gt;dict,key-&gt;ptr);\n</code></pre><p>è€Œåˆ°è¿™é‡Œï¼Œè¢«æ·˜æ±°çš„é”®å€¼å¯¹åªæ˜¯åœ¨å…¨å±€å“ˆå¸Œè¡¨ä¸­è¢«ç§»é™¤äº†ï¼Œå®ƒå ç”¨çš„å†…å­˜ç©ºé—´è¿˜æ²¡æœ‰å®é™…é‡Šæ”¾ã€‚æ‰€ä»¥æ­¤æ—¶ï¼ŒdbAsyncDeleteå‡½æ•°ä¼š<strong>è°ƒç”¨lazyfreeGetFreeEffortå‡½æ•°ï¼Œæ¥è®¡ç®—é‡Šæ”¾è¢«æ·˜æ±°é”®å€¼å¯¹å†…å­˜ç©ºé—´çš„å¼€é”€</strong>ã€‚å¦‚æœå¼€é”€è¾ƒå°ï¼ŒdbAsyncDeleteå‡½æ•°å°±ç›´æ¥åœ¨ä¸»IOçº¿ç¨‹ä¸­è¿›è¡ŒåŒæ­¥åˆ é™¤äº†ã€‚å¦åˆ™çš„è¯ï¼ŒdbAsyncDeleteå‡½æ•°ä¼šåˆ›å»ºæƒ°æ€§åˆ é™¤ä»»åŠ¡ï¼Œå¹¶äº¤ç»™åå°çº¿ç¨‹æ¥å®Œæˆã€‚</p><p>è¿™é‡Œï¼Œä½ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè™½ç„¶dbAsyncDeleteå‡½æ•°è¯´æ˜¯æ‰§è¡Œæƒ°æ€§åˆ é™¤ï¼Œä½†å…¶å®ï¼Œå®ƒåœ¨å®é™…æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œä¼šä½¿ç”¨å‰é¢æåˆ°çš„è¿™ä¸ªlazyfreeGetFreeEffortå‡½æ•°æ¥è¯„ä¼°åˆ é™¤å¼€é”€ã€‚</p><p>lazyfreeGetFreeEffortå‡½æ•°æ˜¯åœ¨lazyfree.cæ–‡ä»¶ä¸­å®ç°çš„ï¼Œå®ƒå¯¹åˆ é™¤å¼€é”€çš„è¯„ä¼°é€»è¾‘å¾ˆç®€å•ï¼Œå°±æ˜¯æ ¹æ®<strong>è¦åˆ é™¤çš„é”®å€¼å¯¹çš„ç±»å‹</strong>ï¼Œæ¥è®¡ç®—åˆ é™¤å¼€é”€ã€‚å½“é”®å€¼å¯¹ç±»å‹å±äºListã€Hashã€Setå’ŒSorted Setè¿™å››ç§é›†åˆç±»å‹ä¸­çš„ä¸€ç§ï¼Œå¹¶ä¸”æ²¡æœ‰ä½¿ç”¨ç´§å‡‘å‹å†…å­˜ç»“æ„æ¥ä¿å­˜çš„è¯ï¼Œé‚£ä¹ˆï¼Œè¿™ä¸ªé”®å€¼å¯¹çš„åˆ é™¤å¼€é”€å°±ç­‰äºé›†åˆä¸­çš„å…ƒç´ ä¸ªæ•°ã€‚å¦åˆ™çš„è¯ï¼Œåˆ é™¤å¼€é”€å°±ç­‰äº1ã€‚</p><p>æˆ‘ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œä»¥ä¸‹ä»£ç å°±å±•ç¤ºäº†lazyfreeGetFreeEffortå‡½æ•°ï¼Œè®¡ç®—Listå’ŒSetç±»å‹é”®å€¼å¯¹çš„åˆ é™¤å¼€é”€ã€‚å¯ä»¥çœ‹åˆ°ï¼Œå½“é”®å€¼å¯¹æ˜¯Setç±»å‹ï¼ŒåŒæ—¶å®ƒæ˜¯ä½¿ç”¨å“ˆå¸Œè¡¨ç»“æ„è€Œä¸æ˜¯æ•´æ•°é›†åˆæ¥ä¿å­˜æ•°æ®çš„è¯ï¼Œé‚£ä¹ˆå®ƒçš„åˆ é™¤å¼€é”€å°±æ˜¯Setä¸­çš„å…ƒç´ ä¸ªæ•°ã€‚</p><pre><code>size_t lazyfreeGetFreeEffort(robj *obj) {\n    if (obj-&gt;type == OBJ_LIST) {  //å¦‚æœæ˜¯Listç±»å‹é”®å€¼å¯¹ï¼Œå°±è¿”å›Listçš„é•¿åº¦ï¼Œä¹Ÿå°±å…¶ä¸­å…ƒç´ ä¸ªæ•°\n        quicklist *ql = obj-&gt;ptr;\n        return ql-&gt;len;\n    } else if (obj-&gt;type == OBJ_SET &amp;&amp; obj-&gt;encoding == OBJ_ENCODING_HT) {\n        dict *ht = obj-&gt;ptr;\n        return dictSize(ht);   //å¦‚æœæ˜¯Setç±»å‹é”®å€¼å¯¹ï¼Œå°±è¿”å›Setä¸­çš„å…ƒç´ ä¸ªæ•°\n    }\n    ...\n}\n</code></pre><p>è¿™æ ·ï¼Œå½“dbAsyncDeleteå‡½æ•°é€šè¿‡lazyfreeGetFreeEffortå‡½æ•°ï¼Œè®¡ç®—å¾—åˆ°è¢«æ·˜æ±°é”®å€¼å¯¹çš„åˆ é™¤å¼€é”€ä¹‹åï¼Œæ¥ä¸‹æ¥çš„<strong>ç¬¬ä¸‰æ­¥</strong>ï¼Œå®ƒå°±ä¼šæŠŠåˆ é™¤å¼€é”€å’Œå®å®šä¹‰LAZYFREE_THRESHOLDï¼ˆåœ¨lazyfree.cæ–‡ä»¶ä¸­ï¼‰è¿›è¡Œæ¯”è¾ƒï¼Œè¿™ä¸ªå®å®šä¹‰çš„é»˜è®¤å€¼æ˜¯64ã€‚</p><p>æ‰€ä»¥ï¼Œå½“è¢«æ·˜æ±°é”®å€¼å¯¹æ˜¯åŒ…å«è¶…è¿‡64ä¸ªå…ƒç´ çš„é›†åˆç±»å‹æ—¶ï¼ŒdbAsyncDeleteå‡½æ•°æ‰ä¼šè°ƒç”¨bioCreateBackgroundJobå‡½æ•°ï¼Œæ¥å®é™…åˆ›å»ºåå°ä»»åŠ¡æ‰§è¡Œæƒ°æ€§åˆ é™¤ã€‚å…³äºbioCreateBackgroundJobå‡½æ•°çš„ä½œç”¨å’Œå·¥ä½œæœºåˆ¶ï¼Œæˆ‘åœ¨<a href=\"https://time.geekbang.org/column/article/409927\">ç¬¬12è®²</a>ä¸­å·²ç»ç»™ä½ ä»‹ç»è¿‡äº†ï¼Œä½ å¯ä»¥å†å»å›é¡¾ä¸‹ã€‚</p><p>ä¸è¿‡ï¼Œå¦‚æœè¢«æ·˜æ±°é”®å€¼å¯¹ä¸æ˜¯é›†åˆç±»å‹ï¼Œæˆ–è€…æ˜¯é›†åˆç±»å‹ä½†åŒ…å«çš„å…ƒç´ ä¸ªæ•°å°äºç­‰äº64ä¸ªï¼Œé‚£ä¹ˆdbAsyncDeleteå‡½æ•°å°±ç›´æ¥è°ƒç”¨<strong>dictFreeUnlinkedEntryå‡½æ•°</strong>ï¼ˆåœ¨dict.cæ–‡ä»¶ä¸­ï¼‰ï¼Œæ¥é‡Šæ”¾é”®å€¼å¯¹æ‰€å çš„å†…å­˜ç©ºé—´äº†ã€‚</p><p>ä»¥ä¸‹ä»£ç å°±å±•ç¤ºäº†dbAsyncDeleteå‡½æ•°ï¼Œä½¿ç”¨åå°ä»»åŠ¡æˆ–ä¸»IOçº¿ç¨‹é‡Šæ”¾å†…å­˜ç©ºé—´çš„é€»è¾‘ï¼Œä½ å¯ä»¥çœ‹ä¸‹ã€‚</p><pre><code>//å¦‚æœè¦æ·˜æ±°çš„é”®å€¼å¯¹åŒ…å«è¶…è¿‡64ä¸ªå…ƒç´ \nif (free_effort &gt; LAZYFREE_THRESHOLD &amp;&amp; val-&gt;refcount == 1) {\n   atomicIncr(lazyfree_objects,1);\n   bioCreateBackgroundJob(BIO_LAZY_FREE,val,NULL,NULL); //åˆ›å»ºæƒ°æ€§åˆ é™¤çš„åå°ä»»åŠ¡ï¼Œäº¤ç»™åå°çº¿ç¨‹æ‰§è¡Œ\n   dictSetVal(db-&gt;dict,de,NULL);  //å°†è¢«æ·˜æ±°é”®å€¼å¯¹çš„valueè®¾ç½®ä¸ºNULL\n}\n\nif (de) {\n   dictFreeUnlinkedEntry(db-&gt;dict,de);\n   ...\n   return 1;\n}\n</code></pre><p>å¦å¤–ï¼Œä½ ä¹Ÿå¯ä»¥æ ¹æ®ä¸‹å›¾æ¥æ•´ä½“å›é¡¾ä¸‹è¿™ä¸ªæ‰§è¡Œè¿‡ç¨‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/2e/cb/2ec7fcd7a52f4d5e1f2cf78bd44e5acb.jpg?wh=2000x916\" alt=\"\"></p><p>å¥½ï¼Œé‚£ä¹ˆç°åœ¨ï¼Œæˆ‘ä»¬ä¹Ÿå°±äº†è§£äº†åŸºäºå¼‚æ­¥åˆ é™¤çš„æ•°æ®æ·˜æ±°è¿‡ç¨‹ï¼Œå®é™…ä¸Šä¼šæ ¹æ®è¦åˆ é™¤çš„é”®å€¼å¯¹åŒ…å«çš„å…ƒç´ ä¸ªæ•°ï¼Œæ¥å†³å®šæ˜¯å®é™…ä½¿ç”¨åå°çº¿ç¨‹è¿˜æ˜¯ä¸»çº¿ç¨‹æ¥è¿›è¡Œåˆ é™¤æ“ä½œã€‚</p><p>ä¸è¿‡ï¼Œå¦‚æœæ˜¯ä½¿ç”¨äº†åå°çº¿ç¨‹æ¥é‡Šæ”¾å†…å­˜ï¼Œé‚£ä¹ˆéšä¹‹å¸¦æ¥çš„ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼š<strong>ä¸»çº¿ç¨‹å¦‚ä½•çŸ¥é“åå°çº¿ç¨‹é‡Šæ”¾çš„å†…å­˜ç©ºé—´ï¼Œå·²ç»æ»¡è¶³å¾…é‡Šæ”¾ç©ºé—´çš„å¤§å°å‘¢ï¼Ÿ</strong></p><p>å…¶å®ï¼ŒfreeMemoryIfNeededå‡½æ•°æœ¬èº«åœ¨è°ƒç”¨dbAsyncDeleteæˆ–dbSyncDeleteå‡½æ•°çš„å‰åï¼Œéƒ½ä¼šç»Ÿè®¡å·²ç»ä½¿ç”¨çš„å†…å­˜é‡ï¼Œå¹¶è®¡ç®—è°ƒç”¨åˆ é™¤å‡½æ•°å‰åçš„å·®å€¼ï¼Œè¿™æ ·å…¶å®å°±å¯ä»¥è·å¾—å·²ç»é‡Šæ”¾çš„å†…å­˜ç©ºé—´å¤§å°ã€‚</p><p>è€Œé™¤æ­¤ä¹‹å¤–ï¼ŒfreeMemoryIfNeededå‡½æ•°è¿˜ä¼šåœ¨è°ƒç”¨dbAsyncDeleteå‡½æ•°åï¼Œå†æ¬¡ä¸»åŠ¨æ£€æµ‹å½“å‰çš„å†…å­˜ä½¿ç”¨é‡ï¼Œæ˜¯å¦å·²ç»æ»¡è¶³æœ€å¤§å†…å­˜å®¹é‡è¦æ±‚ã€‚ä¸€æ—¦æ»¡è¶³äº†ï¼ŒfreeMemoryIfNeededå‡½æ•°å°±ä¼šåœæ­¢æ·˜æ±°æ•°æ®çš„æ‰§è¡Œæµç¨‹äº†ã€‚è¿™æ­¥çš„æ‰§è¡Œé€»è¾‘ï¼Œä½ å¯ä»¥å‚è€ƒä»¥ä¸‹ç»™å‡ºçš„ä»£ç ï¼š</p><pre><code>int freeMemoryIfNeeded(void) {\n...\n//æ‰§è¡Œå¾ªç¯æµç¨‹ï¼Œåˆ é™¤æ·˜æ±°æ•°æ®\nwhile (mem_freed &lt; mem_tofree) {\n...\n//å¦‚æœä½¿ç”¨äº†æƒ°æ€§åˆ é™¤ï¼Œå¹¶ä¸”æ¯åˆ é™¤16ä¸ªkeyåï¼Œç»Ÿè®¡ä¸‹å½“å‰å†…å­˜ä½¿ç”¨é‡\nif (server.lazyfree_lazy_eviction &amp;&amp; !(keys_freed % 16)) {\n   //è®¡ç®—å½“å‰å†…å­˜ä½¿ç”¨é‡æ˜¯å¦ä¸è¶…è¿‡æœ€å¤§å†…å­˜å®¹é‡\n   if (getMaxmemoryState(NULL,NULL,NULL,NULL) == C_OK) {\n      mem_freed = mem_tofree;  //å¦‚æœæ»¡è¶³æœ€å¤§å®¹é‡è¦æ±‚ï¼Œè®©å·²é‡Šæ”¾å†…å­˜é‡ç­‰äºå¾…é‡Šæ”¾é‡ï¼Œä»¥ä¾¿ç»“æŸå¾ªç¯\n   }\n}\n...\n}}\n</code></pre><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±äº†è§£äº†åŸºäºå¼‚æ­¥åˆ é™¤çš„æ•°æ®æ·˜æ±°å®ç°è¿‡ç¨‹ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹åŸºäºåŒæ­¥åˆ é™¤çš„æ•°æ®æ·˜æ±°å®ç°ã€‚</p><h3>åŸºäºåŒæ­¥åˆ é™¤çš„æ•°æ®æ·˜æ±°</h3><p>å…¶å®ï¼Œå’ŒåŸºäºå¼‚æ­¥åˆ é™¤çš„æ•°æ®æ·˜æ±°è¿‡ç¨‹ç›¸æ¯”ï¼ŒåŸºäºåŒæ­¥åˆ é™¤çš„æ•°æ®æ·˜æ±°è¿‡ç¨‹å°±æ¯”è¾ƒç®€å•äº†ã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯ç”±<strong>dbSyncDeleteå‡½æ•°</strong>ï¼ˆåœ¨db.cæ–‡ä»¶ä¸­ï¼‰å®ç°çš„ã€‚</p><p>dbSyncDeleteå‡½æ•°ä¸»è¦æ˜¯å®ç°äº†ä¸¤æ­¥æ“ä½œã€‚é¦–å…ˆï¼Œå®ƒä¼šè°ƒç”¨dictDeleteå‡½æ•°ï¼Œåœ¨è¿‡æœŸkeyçš„å“ˆå¸Œè¡¨ä¸­åˆ é™¤è¢«æ·˜æ±°çš„é”®å€¼å¯¹ã€‚ç´§æ¥ç€ï¼Œå®ƒä¼šå†æ¬¡è°ƒç”¨dictDeleteå‡½æ•°ï¼Œåœ¨å…¨å±€å“ˆå¸Œè¡¨ä¸­åˆ é™¤è¢«æ·˜æ±°çš„é”®å€¼å¯¹ã€‚è¿™æ ·ä¸€æ¥ï¼ŒåŒæ­¥åˆ é™¤çš„åŸºæœ¬æ“ä½œå°±å®Œæˆäº†ã€‚</p><p>ä¸è¿‡ï¼Œ<strong>è¿™é‡Œä½ éœ€è¦æ³¨æ„çš„æ˜¯</strong>ï¼ŒdictDeleteå‡½æ•°é€šè¿‡è°ƒç”¨dictGenericDeleteå‡½æ•°ï¼Œæ¥åŒæ­¥é‡Šæ”¾é”®å€¼å¯¹çš„å†…å­˜ç©ºé—´æ—¶ï¼Œæœ€ç»ˆæ˜¯é€šè¿‡åˆ†åˆ«è°ƒç”¨dictFreeKeyã€dictFreeValå’Œzfreeä¸‰ä¸ªå‡½æ•°æ¥é‡Šæ”¾keyã€valueå’Œé”®å€¼å¯¹å¯¹åº”å“ˆå¸Œé¡¹è¿™ä¸‰è€…å ç”¨çš„å†…å­˜ç©ºé—´çš„ã€‚</p><p>å…¶ä¸­ï¼Œzfreeå‡½æ•°æ˜¯åœ¨zmalloc.cæ–‡ä»¶ä¸­å®ç°çš„ã€‚è€ŒdictFreeKeyã€dictFreeValè¿™ä¸¤ä¸ªå‡½æ•°æ˜¯åœ¨dict.hæ–‡ä»¶ä¸­å®šä¹‰çš„ä¸¤ä¸ªå®å®šä¹‰ã€‚å®ƒä»¬çš„å…·ä½“å®ç°æ˜¯æ ¹æ®æ“ä½œçš„å“ˆå¸Œè¡¨ç±»å‹ï¼Œè°ƒç”¨ç›¸åº”çš„valDestructorå‡½æ•°å’ŒkeyDestructorå‡½æ•°æ¥é‡Šæ”¾å†…å­˜ã€‚ä½ å¯ä»¥çœ‹çœ‹ä¸‹é¢çš„ä»£ç ï¼Œå…¶ä¸­å°±å±•ç¤ºäº†dictFreeKeyå’ŒdictFreeValçš„å®å®šä¹‰ã€‚</p><pre><code>#define dictFreeVal(d, entry) \\\n    if ((d)-&gt;type-&gt;valDestructor) \\\n        (d)-&gt;type-&gt;valDestructor((d)-&gt;privdata, (entry)-&gt;v.val)\n\n#define dictFreeKey(d, entry) \\\n    if ((d)-&gt;type-&gt;keyDestructor) \\\n        (d)-&gt;type-&gt;keyDestructor((d)-&gt;privdata, (entry)-&gt;key)\n</code></pre><p>é‚£ä¹ˆï¼Œä¸ºäº†æ–¹ä¾¿ä½ èƒ½æ‰¾åˆ°æœ€ç»ˆè¿›è¡Œå†…å­˜é‡Šæ”¾æ“ä½œçš„å‡½æ•°ï¼Œä¸‹é¢æˆ‘å°±<strong>ä»¥å…¨å±€å“ˆå¸Œè¡¨ä¸ºä¾‹</strong>ï¼Œæ¥å¸¦ä½ çœ‹ä¸‹å½“æ“ä½œå…¨å±€å“ˆå¸Œè¡¨æ—¶ï¼Œé”®å€¼å¯¹çš„dictFreeValå’ŒdictFreeKeyä¸¤ä¸ªå®å®šä¹‰å¯¹åº”çš„å‡½æ•°ã€‚</p><p>é¦–å…ˆï¼Œå…¨å±€å“ˆå¸Œè¡¨æ˜¯åœ¨initServerå‡½æ•°ä¸­åˆ›å»ºçš„ã€‚åœ¨åˆ›å»ºæ—¶ï¼Œå…¨å±€å“ˆå¸Œè¡¨çš„ç±»å‹æ˜¯dbDictTypeï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>void initServer(void) {\n...\n for (j = 0; j &lt; server.dbnum; j++) {\n        server.db[j].dict = dictCreate(&amp;dbDictType,NULL);\n        server.db[j].expires = dictCreate(&amp;keyptrDictType,NULL);\n        ...\n}\n...\n}\n</code></pre><p>å…¶ä¸­ï¼ŒdbDictTypeæ˜¯ä¸€ä¸ªdictTypeç±»å‹çš„ç»“æ„ä½“ï¼ŒdictTypeç±»å‹æ˜¯åœ¨dict.hæ–‡ä»¶ä¸­å®šä¹‰çš„ã€‚å®ƒçš„æœ€åä¸¤ä¸ªæˆå‘˜å˜é‡ï¼Œå°±æ˜¯keyDestructorå‡½æ•°æŒ‡é’ˆå’ŒvalDestructorå‡½æ•°æŒ‡é’ˆï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>typedef struct dictType {\n    ...\n    void (*keyDestructor)(void *privdata, void *key);\n    void (*valDestructor)(void *privdata, void *obj);\n} dictType;\n</code></pre><p>ç„¶åï¼Œå¯¹äºdbDictTypeæ¥è¯´ï¼Œå®ƒæ˜¯åœ¨server.cæ–‡ä»¶ä¸­å®šä¹‰çš„ã€‚å› ä¸ºå®ƒä½œä¸ºå…¨å±€å“ˆå¸Œè¡¨ï¼Œä¿å­˜çš„æ˜¯SDSç±»å‹çš„keyï¼Œä»¥åŠå¤šç§æ•°æ®ç±»å‹çš„valueã€‚æ‰€ä»¥ï¼ŒdbDictTypeç±»å‹å“ˆå¸Œè¡¨çš„keyå’Œvalueé‡Šæ”¾å‡½æ•°ï¼Œå®é™…ä¸Šåˆ†åˆ«æ˜¯dictSdsDestructorå‡½æ•°å’ŒdictObjectDestructorå‡½æ•°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>dictType dbDictType = {\n    ...\n    dictSdsDestructor,          //keyçš„é‡Šæ”¾å‡½æ•°\n    dictObjectDestructor      //valueçš„é‡Šæ”¾å‡½æ•°\n};\n</code></pre><p>è¿™ä¸¤ä¸ªå‡½æ•°éƒ½æ˜¯åœ¨server.cæ–‡ä»¶ä¸­å®ç°çš„ã€‚</p><p>å…¶ä¸­ï¼ŒdictSdsDestructorå‡½æ•°ä¸»è¦æ˜¯ç›´æ¥è°ƒç”¨sdsfreeå‡½æ•°ï¼ˆåœ¨sds.cæ–‡ä»¶ä¸­ï¼‰ï¼Œé‡Šæ”¾SDSå­—ç¬¦ä¸²å ç”¨çš„å†…å­˜ç©ºé—´ã€‚è€ŒdictObjectDestructorå‡½æ•°ä¼šè°ƒç”¨decrRefCountå‡½æ•°ï¼ˆåœ¨object.cæ–‡ä»¶ä¸­ï¼‰ï¼Œæ¥æ‰§è¡Œé‡Šæ”¾æ“ä½œï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>void dictObjectDestructor(void *privdata, void *val)\n{\n    ...\n    decrRefCount(val);\n}\n</code></pre><p>é‚£ä¹ˆåœ¨è¿™é‡Œï¼Œä½ è¦çŸ¥é“çš„æ˜¯ï¼Œ<strong>decrRefCountå‡½æ•°åœ¨æ‰§è¡Œæ—¶ï¼Œä¼šåˆ¤æ–­å¾…é‡Šæ”¾å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ã€‚</strong>åªæœ‰å½“å¼•ç”¨è®¡æ•°ä¸º1äº†ï¼Œå®ƒæ‰ä¼šæ ¹æ®å¾…é‡Šæ”¾å¯¹è±¡çš„ç±»å‹ï¼Œè°ƒç”¨å…·ä½“ç±»å‹çš„é‡Šæ”¾å‡½æ•°æ¥é‡Šæ”¾å†…å­˜ç©ºé—´ã€‚å¦åˆ™çš„è¯ï¼ŒdecrRefCountå‡½æ•°å°±åªæ˜¯æŠŠå¾…é‡Šæ”¾å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å‡1ã€‚</p><p>ç°åœ¨ï¼Œæˆ‘ä»¬æ¥ä¸¾ä¸ªä¾‹å­ã€‚å¦‚æœå¾…é‡Šæ”¾å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¸º1ï¼Œå¹¶ä¸”æ˜¯Stringç±»å‹çš„è¯ï¼Œé‚£ä¹ˆdecrRefCountå‡½æ•°å°±ä¼šè°ƒç”¨freeStringObjectå‡½æ•°ï¼Œæ¥æ‰§è¡Œæœ€ç»ˆçš„å†…å­˜é‡Šæ”¾æ“ä½œã€‚è€Œå¦‚æœå¯¹è±¡æ˜¯Listç±»å‹ï¼Œé‚£ä¹ˆdecrRefCountå‡½æ•°åˆ™ä¼šè°ƒç”¨freeListObjectå‡½æ•°ï¼Œæ¥æœ€ç»ˆé‡Šæ”¾å†…å­˜ã€‚è¿™éƒ¨åˆ†ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>void decrRefCount(robj *o) {\n    if (o-&gt;refcount == 1) {\n        switch(o-&gt;type) {\n        case OBJ_STRING: freeStringObject(o); break;\n        case OBJ_LIST: freeListObject(o); break;\n        ...\n        }\n        zfree(o);\n    } else {\n        ...\n        if (o-&gt;refcount != OBJ_SHARED_REFCOUNT) o-&gt;refcount--;\n    }\n}\n</code></pre><p>æˆ‘ä¹Ÿç”»äº†ä¸€å¼ å›¾ï¼Œæ¥å±•ç¤ºdecrRefCountå‡½æ•°çš„åŸºæœ¬æ‰§è¡Œé€»è¾‘ï¼Œä½ å¯ä»¥çœ‹ä¸‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/1e/74/1e242ba4cf7bc7b5a34543bfea6d7474.jpg?wh=2000x865\" alt=\"\"></p><p>æ‰€ä»¥è¯´ï¼ŒåŸºäºåŒæ­¥åˆ é™¤çš„æ•°æ®æ·˜æ±°è¿‡ç¨‹ï¼Œå…¶å®å°±æ˜¯é€šè¿‡dictDeleteå‡½æ•°ï¼Œå°†è¢«æ·˜æ±°é”®å€¼å¯¹ä»å…¨å±€å“ˆå¸Œè¡¨ç§»é™¤ï¼Œå¹¶é€šè¿‡dictFreeKeyã€dictFreeValå’Œzfreeä¸‰ä¸ªå‡½æ•°æ¥é‡Šæ”¾å†…å­˜ç©ºé—´ã€‚è€Œé€šè¿‡ä»¥ä¸Šå†…å®¹çš„å­¦ä¹ ï¼Œä½ å°±å·²ç»çŸ¥é“é‡Šæ”¾valueç©ºé—´çš„å‡½æ•°æ˜¯decrRefCountå‡½æ•°ï¼Œå®ƒä¼šæ ¹æ®valueçš„å¼•ç”¨è®¡æ•°å’Œç±»å‹ï¼Œæœ€ç»ˆè°ƒç”¨ä¸åŒæ•°æ®ç±»å‹çš„é‡Šæ”¾å‡½æ•°æ¥å®Œæˆå†…å­˜ç©ºé—´çš„é‡Šæ”¾ã€‚</p><p>è€Œåœ¨è¿™é‡Œï¼Œä½ ä¹Ÿè¦æ³¨æ„çš„æ˜¯ï¼ŒåŸºäºå¼‚æ­¥åˆ é™¤çš„æ•°æ®æ·˜æ±°ï¼Œå®ƒé€šè¿‡åå°çº¿ç¨‹æ‰§è¡Œçš„å‡½æ•°æ˜¯<strong>lazyfreeFreeObjectFromBioThreadå‡½æ•°</strong>ï¼ˆåœ¨lazyfree.cæ–‡ä»¶ï¼‰ï¼Œè€Œè¿™ä¸ªå‡½æ•°å®é™…ä¸Šä¹Ÿæ˜¯è°ƒç”¨äº†decrRefCountå‡½æ•°ï¼Œæ¥é‡Šæ”¾å†…å­˜ç©ºé—´çš„ã€‚</p><h2>å°ç»“</h2><p>ä»Šå¤©è¿™èŠ‚è¯¾ï¼Œæˆ‘ç»™ä½ ä»‹ç»äº†Redisç¼“å­˜åœ¨æ·˜æ±°æ•°æ®æ—¶ï¼Œæ‰§è¡Œçš„æ•°æ®åˆ é™¤æµç¨‹ã€‚å› ä¸ºåœ¨Redis 4.0ç‰ˆæœ¬ä¹‹åæä¾›äº†æƒ°æ€§åˆ é™¤çš„åŠŸèƒ½ï¼Œæ‰€ä»¥Redisç¼“å­˜æ·˜æ±°æ•°æ®çš„æ—¶å€™ï¼Œå°±ä¼šæ ¹æ®æ˜¯å¦å¯ç”¨æƒ°æ€§åˆ é™¤ï¼Œæ¥å†³å®šæ˜¯æ‰§è¡ŒåŒæ­¥åˆ é™¤è¿˜æ˜¯å¼‚æ­¥çš„æƒ°æ€§åˆ é™¤ã€‚</p><p>è€Œä½ è¦çŸ¥é“ï¼Œæ— è®ºæ˜¯åŒæ­¥åˆ é™¤è¿˜æ˜¯å¼‚æ­¥çš„æƒ°æ€§åˆ é™¤ï¼Œå®ƒä»¬éƒ½ä¼šå…ˆæŠŠè¢«æ·˜æ±°çš„é”®å€¼å¯¹ä»å“ˆå¸Œè¡¨ä¸­ç§»é™¤ã€‚ç„¶åï¼ŒåŒæ­¥åˆ é™¤å°±ä¼šç´§æ¥ç€è°ƒç”¨dictFreeKeyã€dictFreeValå’Œzfreeä¸‰ä¸ªå‡½æ•°æ¥åˆ†åˆ«é‡Šæ”¾keyã€valueå’Œé”®å€¼å¯¹å“ˆå¸Œé¡¹çš„å†…å­˜ç©ºé—´ã€‚è€Œå¼‚æ­¥çš„æƒ°æ€§åˆ é™¤ï¼Œåˆ™æ˜¯æŠŠç©ºé—´é‡Šæ”¾ä»»åŠ¡äº¤ç»™äº†åå°çº¿ç¨‹æ¥å®Œæˆã€‚</p><p>æ³¨æ„ï¼Œè™½ç„¶æƒ°æ€§åˆ é™¤æ˜¯ç”±åå°çº¿ç¨‹å¼‚æ­¥å®Œæˆçš„ï¼Œä½†æ˜¯åå°çº¿ç¨‹å¯åŠ¨åä¼šç›‘å¬æƒ°æ€§åˆ é™¤çš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œä¸€æ—¦æœ‰äº†æƒ°æ€§åˆ é™¤ä»»åŠ¡ï¼Œåå°çº¿ç¨‹å°±ä¼šæ‰§è¡Œå¹¶é‡Šæ”¾å†…å­˜ç©ºé—´ã€‚æ‰€ä»¥ï¼Œä»æ·˜æ±°æ•°æ®é‡Šæ”¾å†…å­˜ç©ºé—´çš„è§’åº¦æ¥è¯´ï¼Œ<strong>æƒ°æ€§åˆ é™¤å¹¶ä¸ä¼šå½±å“ç¼“å­˜æ·˜æ±°æ—¶çš„ç©ºé—´é‡Šæ”¾è¦æ±‚</strong>ã€‚</p><p>ä¸è¿‡åœ¨æœ€åï¼Œæˆ‘ä¹Ÿæƒ³æé†’ä½ ä¸€ä¸‹ï¼Œå°±æ˜¯åå°çº¿ç¨‹éœ€è¦<strong>é€šè¿‡åŒæ­¥æœºåˆ¶è·å–ä»»åŠ¡</strong>ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šå¼•å…¥ä¸€äº›é¢å¤–çš„æ—¶é—´å¼€é”€ï¼Œä¼šå¯¼è‡´å†…å­˜é‡Šæ”¾ä¸åƒåŒæ­¥åˆ é™¤é‚£æ ·éå¸¸åŠæ—¶ã€‚å®é™…ä¸Šï¼Œè¿™ä¹Ÿæ˜¯Redisåœ¨è¢«æ·˜æ±°æ•°æ®æ˜¯å°é›†åˆï¼ˆå…ƒç´ ä¸è¶…è¿‡64ä¸ªï¼‰æ—¶ï¼Œä»ç„¶ä½¿ç”¨ä¸»çº¿ç¨‹è¿›è¡Œå†…å­˜é‡Šæ”¾çš„è®¾è®¡è€ƒè™‘å› ç´ ã€‚</p><h2>æ¯è¯¾ä¸€é—®</h2><p>è¯·ä½ æ€è€ƒä¸€ä¸‹ï¼ŒfreeMemoryIfNeededå‡½æ•°åœ¨ä½¿ç”¨åå°çº¿ç¨‹ï¼Œåˆ é™¤è¢«æ·˜æ±°æ•°æ®çš„è¿‡ç¨‹ä¸­ï¼Œä¸»çº¿ç¨‹æ˜¯å¦ä»ç„¶å¯ä»¥å¤„ç†å¤–éƒ¨è¯·æ±‚å‘¢ï¼Ÿ</p><p>æ¬¢è¿åœ¨ç•™è¨€åŒºå†™ä¸‹ä½ çš„ç­”æ¡ˆå’Œæ€è€ƒã€‚å¦‚æœè§‰å¾—æœ‰æ”¶è·ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹ã€‚</p>","comments":[{"had_liked":false,"id":352444,"user_name":"ğŸ¤","can_delete":false,"product_type":"c1","uid":1804626,"ip_address":"","ucode":"17D997E499E651","user_header":"https://static001.geekbang.org/account/avatar/00/1b/89/52/b96c272d.jpg","comment_is_top":true,"comment_ctime":1658673065,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"9.2233720385133998e+18","product_id":100084301,"comment_content":"ä»æºç å¯ä»¥ä½“ä¼šåˆ°redisä½œè€…çš„ç²¾ç›Šæ±‚ç²¾","like_count":0},{"had_liked":false,"id":310179,"user_name":"Kaito","can_delete":false,"product_type":"c1","uid":1020042,"ip_address":"","ucode":"79775FA35A95F2","user_header":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","comment_is_top":false,"comment_ctime":1630518253,"is_pvip":true,"discussion_count":8,"race_medal":0,"score":"96119798765","product_id":100084301,"comment_content":"1ã€lazy-free æ˜¯ 4.0 æ–°å¢çš„åŠŸèƒ½ï¼Œé»˜è®¤æ˜¯å…³é—­çš„ï¼Œéœ€è¦æ‰‹åŠ¨å¼€å¯<br><br>2ã€å¼€å¯ lazy-free æ—¶ï¼Œæœ‰å¤šä¸ªã€Œå­é€‰é¡¹ã€å¯ä»¥æ§åˆ¶ï¼Œåˆ†åˆ«å¯¹åº”ä¸åŒåœºæ™¯ä¸‹ï¼Œæ˜¯å¦å¼€å¯å¼‚æ­¥é‡Šæ”¾å†…å­˜ï¼š<br><br>a) lazyfree-lazy-expireï¼škey åœ¨è¿‡æœŸåˆ é™¤æ—¶å°è¯•å¼‚æ­¥é‡Šæ”¾å†…å­˜<br>b) lazyfree-lazy-evictionï¼šå†…å­˜è¾¾åˆ° maxmemory å¹¶è®¾ç½®äº†æ·˜æ±°ç­–ç•¥æ—¶å°è¯•å¼‚æ­¥é‡Šæ”¾å†…å­˜<br>c) lazyfree-lazy-server-delï¼šæ‰§è¡Œ RENAME&#47;MOVE ç­‰å‘½ä»¤æˆ–éœ€è¦è¦†ç›–ä¸€ä¸ª key æ—¶ï¼ŒRedis å†…éƒ¨åˆ é™¤æ—§ key å°è¯•å¼‚æ­¥é‡Šæ”¾å†…å­˜<br>d) replica-lazy-flushï¼šä¸»ä»å…¨é‡åŒæ­¥ï¼Œä»åº“æ¸…ç©ºæ•°æ®åº“æ—¶å¼‚æ­¥é‡Šæ”¾å†…å­˜<br><br>3ã€å³ä½¿å¼€å¯äº† lazy-freeï¼Œä½†å¦‚æœæ‰§è¡Œçš„æ˜¯ DEL å‘½ä»¤ï¼Œåˆ™è¿˜æ˜¯ä¼šåŒæ­¥é‡Šæ”¾ key å†…å­˜ï¼Œåªæœ‰ä½¿ç”¨ UNLINK å‘½ä»¤æ‰ã€Œå¯èƒ½ã€å¼‚æ­¥é‡Šæ”¾å†…å­˜<br><br>4ã€Redis 6.0 ç‰ˆæœ¬æ–°å¢äº†ä¸€ä¸ªæ–°çš„é€‰é¡¹ lazyfree-lazy-user-delï¼Œæ‰“å¼€åæ‰§è¡Œ DEL å°±ä¸ UNLINK æ•ˆæœä¸€æ ·äº†<br><br>5ã€æœ€å…³é”®çš„ä¸€ç‚¹ï¼Œå¼€å¯ lazy-free åï¼Œé™¤ replica-lazy-flush ä¹‹å¤–ï¼Œå…¶å®ƒé€‰é¡¹éƒ½åªæ˜¯ã€Œå¯èƒ½ã€å¼‚æ­¥é‡Šæ”¾ key çš„å†…å­˜ï¼Œå¹¶ä¸æ˜¯è¯´æ¯æ¬¡é‡Šæ”¾ key å†…å­˜éƒ½æ˜¯ä¸¢åˆ°åå°çº¿ç¨‹çš„<br><br>6ã€å¼€å¯ lazy-free åï¼ŒRedis åœ¨é‡Šæ”¾ä¸€ä¸ª key å†…å­˜æ—¶ï¼Œé¦–å…ˆä¼šè¯„ä¼°ã€Œä»£ä»·ã€ï¼Œå¦‚æœä»£ä»·å¾ˆå°ï¼Œé‚£ä¹ˆå°±ç›´æ¥åœ¨ã€Œä¸»çº¿ç¨‹ã€æ“ä½œäº†ï¼Œã€Œæ²¡å¿…è¦ã€æ”¾åˆ°åå°çº¿ç¨‹ä¸­æ‰§è¡Œï¼ˆä¸åŒçº¿ç¨‹ä¼ é€’æ•°æ®ä¹Ÿä¼šæœ‰æ€§èƒ½æ¶ˆè€—ï¼‰<br><br>7ã€ä»€ä¹ˆæƒ…å†µæ‰ä¼šçœŸæ­£å¼‚æ­¥é‡Šæ”¾å†…å­˜ï¼Ÿè¿™å’Œ key çš„ç±»å‹ã€ç¼–ç æ–¹å¼ã€å…ƒç´ æ•°é‡éƒ½æœ‰å…³ç³»ï¼ˆè¯¦è§ lazyfreeGetFreeEffort å‡½æ•°ï¼‰ï¼š<br><br>a) å½“ Hash&#47;Set åº•å±‚é‡‡ç”¨å“ˆå¸Œè¡¨å­˜å‚¨ï¼ˆé ziplist&#47;int ç¼–ç å­˜å‚¨ï¼‰æ—¶ï¼Œå¹¶ä¸”å…ƒç´ æ•°é‡è¶…è¿‡ 64 ä¸ª<br>b) å½“ ZSet åº•å±‚é‡‡ç”¨è·³è¡¨å­˜å‚¨ï¼ˆé ziplist ç¼–ç å­˜å‚¨ï¼‰æ—¶ï¼Œå¹¶ä¸”å…ƒç´ æ•°é‡è¶…è¿‡ 64 ä¸ª<br>c) å½“ List é“¾è¡¨èŠ‚ç‚¹æ•°é‡è¶…è¿‡ 64 ä¸ªï¼ˆæ³¨æ„ï¼Œä¸æ˜¯å…ƒç´ æ•°é‡ï¼Œè€Œæ˜¯é“¾è¡¨èŠ‚ç‚¹çš„æ•°é‡ï¼ŒList åº•å±‚å®ç°æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œé“¾è¡¨æ¯ä¸ªèŠ‚ç‚¹æ˜¯ä¸€ä¸ª ziplistï¼Œä¸€ä¸ª ziplist å¯èƒ½æœ‰å¤šä¸ªå…ƒç´ æ•°æ®ï¼‰<br><br>åªæœ‰æ»¡è¶³ä»¥ä¸Šæ¡ä»¶ï¼Œåœ¨é‡Šæ”¾ key å†…å­˜æ—¶ï¼Œæ‰ä¼šçœŸæ­£æ”¾åˆ°ã€Œåå°çº¿ç¨‹ã€ä¸­æ‰§è¡Œï¼Œå…¶å®ƒæƒ…å†µä¸€å¾‹è¿˜æ˜¯åœ¨ä¸»çº¿ç¨‹æ“ä½œã€‚<br><br>ä¹Ÿå°±æ˜¯è¯´ Stringï¼ˆä¸ç®¡å†…å­˜å ç”¨å¤šå¤§ï¼‰ã€Listï¼ˆå°‘é‡å…ƒç´ ï¼‰ã€Setï¼ˆint ç¼–ç å­˜å‚¨ï¼‰ã€Hash&#47;ZSetï¼ˆziplist ç¼–ç å­˜å‚¨ï¼‰è¿™äº›æƒ…å†µä¸‹çš„ keyï¼Œåœ¨é‡Šæ”¾å†…å­˜æ—¶ï¼Œä¾æ—§åœ¨ã€Œä¸»çº¿ç¨‹ã€ä¸­æ“ä½œã€‚<br><br>8ã€å¯è§ï¼Œå³ä½¿æ‰“å¼€äº† lazy-freeï¼ŒString ç±»å‹çš„ bigkeyï¼Œåœ¨åˆ é™¤æ—¶ä¾æ—§æœ‰ã€Œé˜»å¡ã€ä¸»çº¿ç¨‹çš„é£é™©ã€‚æ‰€ä»¥ï¼Œå³ä¾¿ Redis æä¾›äº† lazy-freeï¼Œè¿˜æ˜¯ä¸å»ºè®®åœ¨ Redis å­˜å‚¨ bigkey<br><br>9ã€Redis åœ¨é‡Šæ”¾å†…å­˜ã€Œè¯„ä¼°ã€ä»£ä»·æ—¶ï¼Œä¸æ˜¯çœ‹ key çš„å†…å­˜å¤§å°ï¼Œè€Œæ˜¯å…³æ³¨é‡Šæ”¾å†…å­˜æ—¶çš„ã€Œå·¥ä½œé‡ã€æœ‰å¤šå¤§ã€‚ä»ä¸Šé¢åˆ†æå¯ä»¥çœ‹å‡ºï¼Œå¦‚æœ key å†…å­˜æ˜¯è¿ç»­çš„ï¼Œé‡Šæ”¾å†…å­˜çš„ä»£ä»·å°±æ¯”è¾ƒä½ï¼Œåˆ™ä¾æ—§æ”¾åœ¨ã€Œä¸»çº¿ç¨‹ã€å¤„ç†ã€‚å¦‚æœ key å†…å­˜ä¸è¿ç»­ï¼ˆåŒ…å«å¤§é‡æŒ‡é’ˆï¼‰ï¼Œè¿™ä¸ªä»£ä»·å°±æ¯”è¾ƒé«˜ï¼Œè¿™æ‰ä¼šæ”¾åœ¨ã€Œåå°çº¿ç¨‹ã€ä¸­æ‰§è¡Œ<br><br>è¯¾åé¢˜ï¼šfreeMemoryIfNeeded å‡½æ•°åœ¨ä½¿ç”¨åå°çº¿ç¨‹ï¼Œåˆ é™¤è¢«æ·˜æ±°æ•°æ®çš„è¿‡ç¨‹ä¸­ï¼Œä¸»çº¿ç¨‹æ˜¯å¦ä»ç„¶å¯ä»¥å¤„ç†å¤–éƒ¨è¯·æ±‚ï¼Ÿ<br><br>è‚¯å®šæ˜¯å¯ä»¥ç»§ç»­å¤„ç†è¯·æ±‚çš„ã€‚<br><br>ä¸»çº¿ç¨‹å†³å®šæ·˜æ±°è¿™ä¸ª key ä¹‹åï¼Œä¼šå…ˆæŠŠè¿™ä¸ª key ä»ã€Œå…¨å±€å“ˆå¸Œè¡¨ã€ä¸­å‰”é™¤ï¼Œç„¶åè¯„ä¼°é‡Šæ”¾å†…å­˜çš„ä»£ä»·ï¼Œå¦‚æœç¬¦åˆæ¡ä»¶ï¼Œåˆ™ä¸¢åˆ°ã€Œåå°çº¿ç¨‹ã€ä¸­æ‰§è¡Œã€Œé‡Šæ”¾å†…å­˜ã€æ“ä½œã€‚<br><br>ä¹‹åå°±å¯ä»¥ç»§ç»­å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼Œå°½ç®¡åå°çº¿ç¨‹è¿˜æœªå®Œæˆé‡Šæ”¾å†…å­˜ï¼Œä½†å› ä¸º key å·²è¢«å…¨å±€å“ˆå¸Œè¡¨å‰”é™¤ï¼Œæ‰€ä»¥ä¸»çº¿ç¨‹å·²æŸ¥è¯¢ä¸åˆ°è¿™ä¸ª key äº†ï¼Œå¯¹å®¢æˆ·ç«¯æ¥è¯´æ— å½±å“ã€‚","like_count":23,"discussions":[{"author":{"id":1519415,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/dr34H3hOMVsibL0XV1iaBWFiaTnYssX8sNjmJDpiaBUVv2X39nFzDjNpe288cKkZfH3P9sVRxZ1lzYZEcRR3vJNYtA/132","nickname":"Benson_Geek","note":"","ucode":"D95B5C2BA09961","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":414626,"discussion_content":"æˆ‘ä»Redisæ ¸å¿ƒæŠ€æœ¯ä¸å®æˆ˜ä¸€è·¯è†œæ‹œå¤§ä½¬åˆ°è¿™é‡Œå•Šã€‚\næƒ³è¯·æ•™ä¸‹å¤§ä½¬ï¼Œ\nå¦‚æœå¤§é‡keyåŒä¸€æ—¶é—´è¿‡æœŸï¼Œä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ\nè¿™ä¸ªé—®é¢˜ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥å’Œè¿™é‡Œæ˜¯å¦æ˜¯å¼‚æ­¥é‡Šæ”¾å†…å­˜è”ç³»èµ·æ¥ï¼Ÿ\nå› ä¸ºå¦‚æœå¤§é‡keyåŒæ—¶è¿‡æœŸï¼Œä¸»çº¿ç¨‹æ‰§è¡Œæ—¶ï¼Œä¼šæ¯ç§’æ‰«æ10æ¬¡è¿‡æœŸå­—å…¸ï¼Œ\nç„¶åé‡‡ç”¨ç®€å•è´ªå¿ƒç­–ç•¥ï¼Œæ‹¿20ä¸ªkeyï¼Œåˆ¤æ–­æ˜¯å¦è¶…è¿‡1/4çš„è¿‡æœŸåç»§ç»­åœ¨æ‹¿ï¼Œè¿™ä¸ªè¿‡ç¨‹æœ€é•¿æŒç»­25msï¼Œä¹Ÿå°±æ˜¯å¯èƒ½ä¼šé˜»å¡ä¸»çº¿ç¨‹25msï¼Œç„¶ååç»­è¯·æ±‚åˆæœ‰å¾ˆå¤šè¿‡æœŸkeyåˆ™ç»§ç»­é‡å¤è¿™ä¸ªè¿‡ç¨‹åˆé˜»å¡25msåå†æ‰§è¡Œè¯»å†™è¯·æ±‚ï¼Œç„¶åå°±å¯èƒ½é€ æˆredisç³»ç»Ÿå¡é¡¿ï¼Œè¯»å†™è¯·æ±‚æ…¢çš„ç°è±¡å‡ºç°ã€‚\nä¸çŸ¥é“è‡ªå·±è¿™æ ·ç†è§£å¯¹ä¸å¯¹ï¼Ÿå¤§ä½¬ï¼Œå¤§ä½¬ï¼Œå¤§ä½¬ï¼Œmy deerå¤§ä½¬ï¼","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1636818897,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1020042,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","nickname":"Kaito","note":"","ucode":"79775FA35A95F2","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1519415,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/dr34H3hOMVsibL0XV1iaBWFiaTnYssX8sNjmJDpiaBUVv2X39nFzDjNpe288cKkZfH3P9sVRxZ1lzYZEcRR3vJNYtA/132","nickname":"Benson_Geek","note":"","ucode":"D95B5C2BA09961","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":414648,"discussion_content":"é›†ä¸­è¿‡æœŸä¼šå¡ä½ä¸»çº¿ç¨‹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1636822338,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":414626,"ip_address":""},"score":414648,"extra":""},{"author":{"id":1492301,"avatar":"https://static001.geekbang.org/account/avatar/00/16/c5/4d/3e75e5f1.jpg","nickname":"å‘½è¿å¥³ç¥åœ¨å¾®ç¬‘","note":"","ucode":"249172371DA9F2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1519415,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/dr34H3hOMVsibL0XV1iaBWFiaTnYssX8sNjmJDpiaBUVv2X39nFzDjNpe288cKkZfH3P9sVRxZ1lzYZEcRR3vJNYtA/132","nickname":"Benson_Geek","note":"","ucode":"D95B5C2BA09961","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":548933,"discussion_content":"ç”¨äºè¿‡æœŸkeyåˆ é™¤çš„æ—¶é—´ç‰‡æœ‰æœ€å¤§è¦æ±‚ï¼Œä¸ä¼šå ç”¨è¶…è¿‡æ¯æ¬¡å¾ªç¯25%ä»¥ä¸Šçš„æ—¶é—´ï¼Œredis6é€šè¿‡activate_expire_effortå¯ä»¥æ§åˆ¶æ—¶é—´ç‰‡å»¶é•¿ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1643450710,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":414626,"ip_address":""},"score":548933,"extra":""}]},{"author":{"id":2418232,"avatar":"https://static001.geekbang.org/account/avatar/00/24/e6/38/25e7cce5.jpg","nickname":"æµ·","note":"","ucode":"09FAF70D78668A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":572629,"discussion_content":"String ç±»å‹çš„ bigkeyï¼Œåœ¨åˆ é™¤æ—¶ä¾æ—§æœ‰ã€Œé˜»å¡ã€ä¸»çº¿ç¨‹çš„é£é™©ã€‚æ‰€ä»¥ï¼Œå³ä¾¿ Redis æä¾›äº† lazy-freeï¼Œè¿˜æ˜¯ä¸å»ºè®®åœ¨ Redis å­˜å‚¨ bigkey","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1652878906,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2668029,"avatar":"https://static001.geekbang.org/account/avatar/00/28/b5/fd/6c200288.jpg","nickname":"æ”¿ç”±è‘›æ°","note":"","ucode":"8650B30DF0F894","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":544449,"discussion_content":"Stringç±»å‹é‡Šæ”¾å†…å­˜ï¼Œå¤§ä¸äº†é‡Šæ”¾ä¸€æ¬¡æŒ‡é’ˆæŒ‡å‘çš„å­—ç¬¦ä¸²å’Œç®¡ç†å­—ç¬¦ä¸²çš„å…ƒæ•°æ®ï¼Œä¹Ÿå°±ä¸¤æ¬¡é‡Šæ”¾ï¼Œå¼€é”€å¾ˆå°å•Š","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641525625,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1812201,"avatar":"https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLm8skz4F7FGGBTXWUMia6qVEc00BddeXapicv5FkAx62GmOnUNEcE4scSR60AmappQoNdIQhccKsBA/132","nickname":"æœ«æ—¥ï¼Œæˆæ¬¢","note":"","ucode":"BBAEBB9C93558A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2668029,"avatar":"https://static001.geekbang.org/account/avatar/00/28/b5/fd/6c200288.jpg","nickname":"æ”¿ç”±è‘›æ°","note":"","ucode":"8650B30DF0F894","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":555858,"discussion_content":"æˆ‘ä¹Ÿä¸ç†è§£ï¼Œèƒ½ç»™æˆ‘è§£æƒ‘ä¸€ä¸‹å—ï¼Ÿ ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1647086386,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":544449,"ip_address":""},"score":555858,"extra":""}]},{"author":{"id":1005391,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","nickname":"ä¸€æ­¥","note":"","ucode":"73CEA468CE70C3","race_medal":1,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":391837,"discussion_content":"ç°åœ¨æœ‰ä¸ªé—®é¢˜ï¼Œå¦‚æœé…ç½®çš„ åå°çº¿ç¨‹åˆ é™¤ï¼Œåœ¨åˆ é™¤å‰åè®¡ç®— å†…å­˜ä½¿ç”¨é‡çš„æ—¶å€™ (long long)zmalloc_used_memory(); æ˜¯ä¸æ˜¯å°±ä¸å‡†äº†ï¼Ÿè¿™æ—¶å€™ key å’Œ value çš„å†…å­˜è¿˜æ²¡æœ‰å¾—åˆ°é‡Šæ”¾çš„ï¼Œåªæ˜¯æŠŠå…¨å±€å’Œå¤±æ•ˆ å“ˆå¸Œè¡¨é‡Œé¢çš„åˆ é™¤äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630652534,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1254968,"avatar":"https://static001.geekbang.org/account/avatar/00/13/26/38/ef063dc2.jpg","nickname":"Darren","note":"","ucode":"CCD2B2C492BE9A","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1005391,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","nickname":"ä¸€æ­¥","note":"","ucode":"73CEA468CE70C3","race_medal":1,"user_type":1,"is_pvip":true},"discussion":{"id":392412,"discussion_content":"æ¯æ¸…ç†16ä¸ªkeyåï¼Œä¼šè®¡ç®—ä¸€æ¬¡æµ‹è¯•å†…å­˜çš„é‡Šæ”¾é‡æ˜¯å¦å¯ä»¥äº†ï¼Œå› æ­¤å³ä½¿æ˜¯å¼‚æ­¥ï¼Œå½±å“ä¹Ÿä¸å¤§ï¼Œä»£ç å¦‚ä¸‹ \n\nif (keys_freed % 16 == 0) {\n                /* When the memory to free starts to be big enough, we may\n                 * start spending so much time here that is impossible to\n                 * deliver data to the replicas fast enough, so we force the\n                 * transmission here inside the loop.\n                 *\n                 * å½“è¦é‡Šæ”¾çš„å†…å­˜å¼€å§‹è¶³å¤Ÿå¤§æ—¶ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå¼€å§‹åœ¨æ­¤å¤„èŠ±è´¹å¤ªå¤šæ—¶é—´ï¼Œ\n                 * æ— æ³•è¶³å¤Ÿå¿«åœ°å°†æ•°æ®ä¼ é€åˆ°å‰¯æœ¬ï¼Œå› æ­¤æˆ‘ä»¬å¼ºåˆ¶åœ¨å¾ªç¯å†…éƒ¨è¿›è¡Œä¼ è¾“ã€‚\n                 *\n                 * */\n\n                if (slaves) flushSlavesOutputBuffers();\n\n                /* Normally our stop condition is the ability to release\n                 * a fixed, pre-computed amount of memory. However when we\n                 * are deleting objects in another thread, it&#39;s better to\n                 * check, from time to time, if we already reached our target\n                 * memory, since the &#34;mem_freed&#34; amount is computed only\n                 * across the dbAsyncDelete() call, while the thread can\n                 * release the memory all the time.\n                 *\n                 * é€šå¸¸æˆ‘ä»¬çš„åœæ­¢æ¡ä»¶æ˜¯èƒ½å¤Ÿé‡Šæ”¾å›ºå®šçš„ã€é¢„å…ˆè®¡ç®—çš„å†…å­˜é‡ã€‚ ç„¶è€Œï¼Œå½“æˆ‘ä»¬åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­åˆ é™¤å¯¹è±¡æ—¶ï¼Œæœ€å¥½ä¸æ—¶æ£€æŸ¥æ˜¯å¦å·²ç»åˆ°è¾¾æˆ‘ä»¬çš„ç›®æ ‡å†…å­˜ï¼Œ\n                 * å› ä¸ºâ€œmem_freedâ€æ•°é‡ä»…åœ¨ dbAsyncDelete() è°ƒç”¨ä¸­è®¡ç®—ï¼Œè€Œçº¿ç¨‹å¯ä»¥éšæ—¶é‡Šæ”¾å†…å­˜ã€‚\n                 *\n                 * */\n                if (server.lazyfree_lazy_eviction) {\n                    if (getMaxmemoryState(NULL,NULL,NULL,NULL) == C_OK) {\n                        break;\n                    }\n                }\n","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1630999229,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":391837,"ip_address":""},"score":392412,"extra":""}]}]},{"had_liked":false,"id":318063,"user_name":"äº‘æµ·","can_delete":false,"product_type":"c1","uid":1365206,"ip_address":"","ucode":"0C6CA0BE58EA21","user_header":"https://static001.geekbang.org/account/avatar/00/14/d4/d6/1d4543ac.jpg","comment_is_top":false,"comment_ctime":1635138007,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1635138007","product_id":100084301,"comment_content":"æƒ°æ€§åˆ é™¤ï¼Œæ¯åˆ é™¤16ä¸ªkeyåä¼šè®¡ç®—ä¸€æ¬¡å†…å­˜ã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œè®¡ç®—å†…å­˜çš„æ“ä½œæ˜¯å¦ä¼šæ¶ˆè€—å¾ˆå¤šèµ„æºï¼Ÿ","like_count":0,"discussions":[{"author":{"id":2420294,"avatar":"https://static001.geekbang.org/account/avatar/00/24/ee/46/7d65ae37.jpg","nickname":"æœ¨å‡ ä¸¶","note":"","ucode":"FFDB958DA64F8C","race_medal":5,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":579095,"discussion_content":"ä¸ä¼šï¼Œæœ‰ä¸€ä¸ªå…¨å±€å˜é‡è®°å½•ç€ï¼Œç›´æ¥å–å€¼å°±å¥½äº†","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1657175112,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":310427,"user_name":"ä¸€æ­¥","can_delete":false,"product_type":"c1","uid":1005391,"ip_address":"","ucode":"73CEA468CE70C3","user_header":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","comment_is_top":false,"comment_ctime":1630652529,"is_pvip":true,"discussion_count":4,"race_medal":1,"score":"1630652529","product_id":100084301,"comment_content":"ç°åœ¨æœ‰ä¸ªé—®é¢˜ï¼Œå¦‚æœé…ç½®çš„ åå°çº¿ç¨‹åˆ é™¤ï¼Œåœ¨åˆ é™¤å‰åè®¡ç®— å†…å­˜ä½¿ç”¨é‡çš„æ—¶å€™ (long long)zmalloc_used_memory(); æ˜¯ä¸æ˜¯å°±ä¸å‡†äº†ï¼Ÿè¿™æ—¶å€™ key å’Œ value çš„å†…å­˜è¿˜æ²¡æœ‰å¾—åˆ°é‡Šæ”¾çš„ï¼Œåªæ˜¯æŠŠå…¨å±€å’Œå¤±æ•ˆ å“ˆå¸Œè¡¨é‡Œé¢çš„åˆ é™¤äº†","like_count":0,"discussions":[{"author":{"id":1069583,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJ8BIG7fdqVH3xs2o7yDGpbr9FuT93FVN98CC4cYdojcJamJrPS6q8ObOFQwDgbxygiaYaWnuMk0cw/132","nickname":"Kkkoko","note":"","ucode":"C36729C4659F60","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":547832,"discussion_content":"åªéœ€è¦æ»¡è¶³å†…å­˜é‡Šæ”¾åˆ°äº†é˜ˆå€¼ä»¥ä¸‹ã€‚ å¹¶ä¸å¼ºæ±‚æ˜¯ä¸æ˜¯ä¼šå¤šæ‰§è¡Œä¸€æ¬¡å¾ªç¯ï¼Œå¹¶ä¸”éƒ½å·²ç»éœ€è¦å›æ”¶å†…å­˜äº†ï¼Œå¤šåˆ å‡ ä¸ªä¹Ÿä¸å½±å“","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1642868115,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1788762,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/4b/5a/143961d4.jpg","nickname":"Zack","note":"","ucode":"DA339946D115DF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":551382,"discussion_content":"å¼‚æ­¥ä¸‹æ˜¯ä¸å‡†çš„ï¼Œå¯èƒ½åå°çº¿ç¨‹å·²ç»åˆ æ‰äº†ï¼Œä¹Ÿå¯èƒ½æ²¡åˆ ï¼Œæ‰€ä»¥å¢åŠ äº†ä¸€ä¸ªå…œåº•æœºåˆ¶ï¼Œé€ æˆçš„ç»“æœæ— éå°±æ˜¯å¤šæ·˜æ±°äº†å‡ ä¸ªã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1645003521,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1069583,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJ8BIG7fdqVH3xs2o7yDGpbr9FuT93FVN98CC4cYdojcJamJrPS6q8ObOFQwDgbxygiaYaWnuMk0cw/132","nickname":"Kkkoko","note":"","ucode":"C36729C4659F60","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":547823,"discussion_content":"æˆ‘çš„ç†è§£æ˜¯ï¼Œ è®¡ç®—æ¥å¾—åŠå°±è®¡ç®—ã€‚ æ¥ä¸åŠå¯ä»¥ç»™ä¸‹ä¸€æ¬¡å¾ªç¯æ¥ç®—ï¼Œå¹¶ä¸”æœ€åæœ‰ä¸€ä¸ª16æ¬¡çš„å…œåº•","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642867710,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1657561,"avatar":"https://static001.geekbang.org/account/avatar/00/19/4a/d9/b8046b4b.jpg","nickname":"zhangm365","note":"","ucode":"60E7DEFB3F5840","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":396543,"discussion_content":"ä¸ºä»€ä¹ˆè€å¸ˆä¸ç­”ç–‘ï¼Œå¥½å‘å•Š","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632449480,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}