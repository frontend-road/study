{"id":176897,"title":"20 | 事务开发：读操作事务之一","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/geektime-mongodb-course\">https://gitee.com/geektime-geekbang/geektime-mongodb-course</a></p>","comments":[{"had_liked":false,"id":164521,"user_name":"hal","can_delete":false,"product_type":"c3","uid":1359844,"ip_address":"","ucode":"98E625F7327FD9","user_header":"https://static001.geekbang.org/account/avatar/00/14/bf/e4/45758517.jpg","comment_is_top":false,"comment_ctime":1577020219,"is_pvip":false,"replies":[{"id":62944,"content":"两个从节点是否都有锁住？","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1577182173,"ip_address":"","comment_id":164521,"utype":1}],"discussion_count":23,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师，你好，我都是按照步骤做的实验，slave设置了db.fsynclock(),在slave上db.test.find()也确实没有x:2,但是primary上执行db.test.find().readPref(&quot;secondary&quot;)\n{ &quot;_id&quot; : ObjectId(&quot;5dcf9491fb56b2bcfb260b70&quot;), &quot;x&quot; : 1 }\n{ &quot;_id&quot; : ObjectId(&quot;5dcf951cfb56b2bcfb260b71&quot;), &quot;x&quot; : 2 }\n还有会看到有2条数据。。","like_count":8,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":478799,"discussion_content":"两个从节点是否都有锁住？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577182173,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1440873,"avatar":"https://static001.geekbang.org/account/avatar/00/15/fc/69/02953435.jpg","nickname":"大懒虫","note":"","ucode":"51014C4A7074DA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":366081,"discussion_content":"我来回复一下吧，shell连接复制集，需要这么连mongo --host rs0/127.0.0.1:28017,这样才能复现出老师的结果，具体参见https://jira.mongodb.org/browse/SERVER-22289","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1617956161,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2726005,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/icQMkmKS4koq2SIIMKZf89npRWy65MldL6GicEF2fdDwuHmNh86uaVPvwgiaibxUW6w8icfFeQYfsZxfrVhKG0ibRqMA/132","nickname":"Geek_jayzzz","note":"","ucode":"930BA971F39350","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1440873,"avatar":"https://static001.geekbang.org/account/avatar/00/15/fc/69/02953435.jpg","nickname":"大懒虫","note":"","ucode":"51014C4A7074DA","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":389221,"discussion_content":"👍","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629183011,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":366081,"ip_address":"","group_id":0},"score":389221,"extra":""}]},{"author":{"id":1519881,"avatar":"https://static001.geekbang.org/account/avatar/00/17/31/09/f5d68957.jpg","nickname":"礼拜三","note":"","ucode":"C36A84E76E163D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":310669,"discussion_content":"这个问题作者不管了吗？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1601984977,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1809843,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/9d/b3/46d03057.jpg","nickname":"Colin","note":"","ucode":"00F7AD85CE0073","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":165234,"discussion_content":"我也遇到这个情况，有点奇怪","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1581260622,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1208184,"avatar":"https://static001.geekbang.org/account/avatar/00/12/6f/78/69a862ee.jpg","nickname":"一兵一卒","note":"","ucode":"594B4441559209","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":110889,"discussion_content":"我也是遇到这种情况，2个从节点都锁住了，看不到x:2的数据，但在2个primary的窗口看都是能查到x:2数据","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1577762638,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1168265,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d3/89/fcf95d32.jpg","nickname":"Allen","note":"","ucode":"10D365C791D28F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":108940,"discussion_content":"我也一样","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1577637647,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1022129,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/98/b1/f89a84d0.jpg","nickname":"wu526","note":"","ucode":"69282EB175B48E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":102986,"discussion_content":"我也遇到一样的情况了，我100%确定两个从节点都锁定了。mongodb version是db version v4.2.1","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1577369239,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":3,"child_discussions":[{"author":{"id":1359844,"avatar":"https://static001.geekbang.org/account/avatar/00/14/bf/e4/45758517.jpg","nickname":"hal","note":"","ucode":"98E625F7327FD9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1022129,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/98/b1/f89a84d0.jpg","nickname":"wu526","note":"","ucode":"69282EB175B48E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":104213,"discussion_content":"🤝🤝🤝","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577416889,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":102986,"ip_address":"","group_id":0},"score":104213,"extra":""},{"author":{"id":1359844,"avatar":"https://static001.geekbang.org/account/avatar/00/14/bf/e4/45758517.jpg","nickname":"hal","note":"","ucode":"98E625F7327FD9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1022129,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/98/b1/f89a84d0.jpg","nickname":"wu526","note":"","ucode":"69282EB175B48E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":104215,"discussion_content":"你用compass连过去查询，是符合实验预期的，所以也懵了……","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577416920,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":102986,"ip_address":"","group_id":0},"score":104215,"extra":""},{"author":{"id":1786752,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/43/80/b1ae32cd.jpg","nickname":"Kenneth。🌞","note":"","ucode":"299ADF236395CC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1359844,"avatar":"https://static001.geekbang.org/account/avatar/00/14/bf/e4/45758517.jpg","nickname":"hal","note":"","ucode":"98E625F7327FD9","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":342424,"discussion_content":"compass连接主节点，readPreference=secondary 连接，也不行，你是怎么操作的 ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1610678791,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":104215,"ip_address":"","group_id":0},"score":342424,"extra":""}]},{"author":{"id":1359844,"avatar":"https://static001.geekbang.org/account/avatar/00/14/bf/e4/45758517.jpg","nickname":"hal","note":"","ucode":"98E625F7327FD9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":100996,"discussion_content":"都锁了，用compass查，设置secondary是符合实验预期的，只是命令行查不符合预期，有点诡异，","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1577282347,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":541013,"discussion_content":"连接复制集的方式有问题，导致不能复现老师的实验。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640230305,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2281842,"avatar":"","nickname":"你好，Java","note":"","ucode":"4FA103B707B78D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":343684,"discussion_content":"用3T連主節點，確定無法read from secondary","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1611134489,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1307184,"avatar":"https://static001.geekbang.org/account/avatar/00/13/f2/30/960fbed7.jpg","nickname":"那些年D盘里","note":"","ucode":"BFF643E6A2E13A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":332344,"discussion_content":"MongoDB server version: 4.2.3, mongo shell 也有这个问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1607161284,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1120298,"avatar":"https://static001.geekbang.org/account/avatar/00/11/18/2a/9c18a3c4.jpg","nickname":"wzp","note":"","ucode":"2C511B2755A1E1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":302880,"discussion_content":"两个从节点都锁了，主节点使用db.test.find().readPref(&#34;secondary&#34;) 有两条","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599054848,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2031099,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/vl03zfnk5BDF0rDNq2mYSxlNibZ18wCxQx9avW753a9PG4Q4ptopX1BMicNmnmcaFYvKWUEiaPgr0O15ia4Ffqnk2A/132","nickname":"Geek_6ccc2f","note":"","ucode":"81A6EA14B45CA6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":301717,"discussion_content":"这个问题还没有解决吗，我的也是两条数据","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598617906,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1803177,"avatar":"","nickname":"david","note":"","ucode":"3E05713BC5CD5E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":298461,"discussion_content":"老师什么版本啊，我的也是可以查看到啊 \n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597303077,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1241239,"avatar":"https://static001.geekbang.org/account/avatar/00/12/f0/97/9c69ea5c.jpg","nickname":"誠","note":"","ucode":"ED389558F141F8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":296690,"discussion_content":"是版本的bug么，我也遇到相同的问题，我的版本是4.2.8","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596622646,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1182802,"avatar":"https://static001.geekbang.org/account/avatar/00/12/0c/52/f25c3636.jpg","nickname":"长脖子树","note":"","ucode":"D9090EF67EEB1B","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":175948,"discussion_content":"版本 4.2.3 使用 shell 查的, 两个从节点都有锁住, 但在主节点插入之后, readPref(&#34;secondary&#34;) 可以读取到新插入的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582007788,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1243939,"avatar":"https://static001.geekbang.org/account/avatar/00/12/fb/23/e5c346e7.jpg","nickname":"AAAAAAres","note":"","ucode":"B12540906635C7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":157289,"discussion_content":"+1, compass查符合预期，shell查不行","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580464851,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":3,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1359844,"avatar":"https://static001.geekbang.org/account/avatar/00/14/bf/e4/45758517.jpg","nickname":"hal","note":"","ucode":"98E625F7327FD9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1243939,"avatar":"https://static001.geekbang.org/account/avatar/00/12/fb/23/e5c346e7.jpg","nickname":"AAAAAAres","note":"","ucode":"B12540906635C7","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":157495,"discussion_content":"你的版本是？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580481002,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":157289,"ip_address":"","group_id":0},"score":157495,"extra":""},{"author":{"id":1984156,"avatar":"","nickname":"Geek_a4c5d3","note":"","ucode":"81817A9A311DA0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1243939,"avatar":"https://static001.geekbang.org/account/avatar/00/12/fb/23/e5c346e7.jpg","nickname":"AAAAAAres","note":"","ucode":"B12540906635C7","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":299944,"discussion_content":"compass 怎么指定从节点读","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597886284,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":157289,"ip_address":"","group_id":0},"score":299944,"extra":""}]}]},{"had_liked":false,"id":163996,"user_name":"旺旺","can_delete":false,"product_type":"c3","uid":1159196,"ip_address":"","ucode":"FE2CF90F446BFB","user_header":"https://static001.geekbang.org/account/avatar/00/11/b0/1c/2e30eeb8.jpg","comment_is_top":false,"comment_ctime":1576843312,"is_pvip":false,"replies":[{"id":62964,"content":"有这个可能。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1577183953,"ip_address":"","comment_id":163996,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"锁定2个secondary，primary上插入{x:2}后，解锁其中一个secondary，然后在primary上用find().readPref(&quot;secondary&quot;)读取时是不是也有可能读取不到呢？\n因为2个secondary，只解锁了一个，只有一个铜鼓过去了，如果从没有解锁未同步过去的那个secondary上读取的话，不是还读取不到{x:2}这记录吗？","like_count":2,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":478610,"discussion_content":"有这个可能。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577183953,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":194524,"user_name":"DZZ","can_delete":false,"product_type":"c3","uid":1516167,"ip_address":"","ucode":"C8E4C4B089BCE2","user_header":"https://static001.geekbang.org/account/avatar/00/17/22/87/e7bd2acf.jpg","comment_is_top":false,"comment_ctime":1585065075,"is_pvip":false,"replies":[{"id":74321,"content":"不能。写入必须是主节点","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1585221354,"ip_address":"","comment_id":194524,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"聚合操作语句如果设置readpreference 为从节点，聚合中再’$out生成新的集合，这样能插入到从节点吗？","like_count":1,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":488835,"discussion_content":"不能。写入必须是主节点","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585221354,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1516167,"avatar":"https://static001.geekbang.org/account/avatar/00/17/22/87/e7bd2acf.jpg","nickname":"DZZ","note":"","ucode":"C8E4C4B089BCE2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":214649,"discussion_content":"已实践，确实不能","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585222339,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":165297,"user_name":"👻 小二","can_delete":false,"product_type":"c3","uid":1625463,"ip_address":"","ucode":"9EEA8553163270","user_header":"https://static001.geekbang.org/account/avatar/00/18/cd/77/b2ab5d44.jpg","comment_is_top":false,"comment_ctime":1577195619,"is_pvip":false,"replies":[{"id":65215,"content":"100个uuid的字段，字段名都不一样吗？","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1577971438,"ip_address":"","comment_id":165297,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师， 问个问题， mongo如果大量存入不同字段的数据， 会有问题吗？  比如我存入100w条， 字段是uuid， 唯一的数据， 每条有100个uuid的字段， 这样， 整张表加起来就有 1亿个不同的字段。","like_count":1,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":479111,"discussion_content":"100个uuid的字段，字段名都不一样吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577971438,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1625463,"avatar":"https://static001.geekbang.org/account/avatar/00/18/cd/77/b2ab5d44.jpg","nickname":"👻 小二","note":"","ucode":"9EEA8553163270","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":114440,"discussion_content":"是的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577972146,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":251550,"user_name":"Geek_32772e","can_delete":false,"product_type":"c3","uid":1446158,"ip_address":"","ucode":"2850EF64F4775F","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoribOUgcicu1sOqZZVtPqpSDSS43vicxW0GesxQeBRjUC47CzulKSzYNj2aMg9YOZDdjPdAZxS3jNcQ/132","comment_is_top":false,"comment_ctime":1601666888,"is_pvip":false,"replies":[{"id":93806,"content":"不支持这种操作，你需要在程序里使用API如果希望对某个表采用不同的读写策略。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1604037215,"ip_address":"","comment_id":251550,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"MongoDB参数连接方式有没有对于某张表进行副本优先读取的设置？因为我们的配置中是包含表名的URI，我试了下直接加表名是读取不到的","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":506538,"discussion_content":"不支持这种操作，你需要在程序里使用API如果希望对某个表采用不同的读写策略。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604037215,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":182468,"user_name":"趁早","can_delete":false,"product_type":"c3","uid":1031970,"ip_address":"","ucode":"949FB3AA250D80","user_header":"https://static001.geekbang.org/account/avatar/00/0f/bf/22/26530e66.jpg","comment_is_top":false,"comment_ctime":1582792489,"is_pvip":false,"replies":[{"id":70944,"content":"4.0 之前从节点可能会阻塞，在写入很大的情况下。你说的情况还不太清楚","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1583028167,"ip_address":"","comment_id":182468,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"我印象中有版本的mongodb，做读写分离的时候会导致主库时不时出现写入慢的情况？ ","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":485347,"discussion_content":"4.0 之前从节点可能会阻塞，在写入很大的情况下。你说的情况还不太清楚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583028167,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":287459,"user_name":"大懒虫","can_delete":false,"product_type":"c3","uid":1440873,"ip_address":"","ucode":"51014C4A7074DA","user_header":"https://static001.geekbang.org/account/avatar/00/15/fc/69/02953435.jpg","comment_is_top":false,"comment_ctime":1617958089,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"shell连接复制集，需要这么连mongo --host rs0&#47;127.0.0.1:28017,这样才能复现出老师的结果，具体参见https:&#47;&#47;jira.mongodb.org&#47;browse&#47;SERVER-22289","like_count":1},{"had_liked":false,"id":263737,"user_name":"安静的小气泡","can_delete":false,"product_type":"c3","uid":2314428,"ip_address":"","ucode":"61D50A59F3B938","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEL1kzELNkpAgMLag4ne9259ZjFZ1dhApP6u0f5j86NgvXVPmJmgNHJQVMEuVFDw3UsoopgcEhtSnw/132","comment_is_top":false,"comment_ctime":1606241360,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师，您好，我也是按步骤实验了很久，也看了官方文档，版本切换过4.2.11和4.4.1，也试验了设置 db.getMongo().setReadPref(&#39;secondary&#39;)或者按您说的方式设置，在shell环境下。     通过代码查询secondary，确实查不到主节点的数据了，没问题，通过shell，在主节点上db.test.find().readPref(&quot;secondary&quot;)，还是能查询到数据，研究了两个晚上，实在没搞懂，谢谢了！！！","like_count":1,"discussions":[{"author":{"id":2354474,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/UNC7eWZWvRyAPWUpIJicgZBWLNpkljMbgeaFVWU3QNmWgaibchc8aGFfAG7gWh7eghHSrtSuSqMDp2ibVnvE2eLJg/132","nickname":"Geek_a88948","note":"","ucode":"C7FF3099A180D6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":352283,"discussion_content":"我也是这样，mongo4.0.21 主节点用shell查是两条数据，在代码中使用驱动查，是从节点数据","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1614672483,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":380278,"user_name":"毛","can_delete":false,"product_type":"c3","uid":1104191,"ip_address":"北京","ucode":"84C4B39145D9F9","user_header":"https://static001.geekbang.org/account/avatar/00/10/d9/3f/33c758df.jpg","comment_is_top":false,"comment_ctime":1693301187,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"感觉并不是事务吧，事务的acid有保证吗","like_count":0},{"had_liked":false,"id":336705,"user_name":"Julia.SQL","can_delete":false,"product_type":"c3","uid":2657631,"ip_address":"","ucode":"D5E9550547F451","user_header":"https://static001.geekbang.org/account/avatar/00/28/8d/5f/cfc12526.jpg","comment_is_top":false,"comment_ctime":1646301724,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"我遇到一個情況，已設定ReadPreference.secondaryPreferred()，但實際觀察到 Primary 的QPS總是最高，Primary 主要的 operation 是 returned。\n版本：v4.4.10\n請問我可以如何解釋這個情況、調整？\n\npublic MongoDatabase getMongoDatabaseForRead(String database) {\n    return getMongoClient() MongoClient\n             .getDatabase (database) MongoDatabase\n             .withReadConcern(ReadConcern.AVAILABLE)\n             .withReadPreference(ReadPreference.secondaryPreferred());\n}","like_count":0},{"had_liked":false,"id":328383,"user_name":"刘永臣","can_delete":false,"product_type":"c3","uid":2033098,"ip_address":"","ucode":"31426CE31CA514","user_header":"https://static001.geekbang.org/account/avatar/00/1f/05/ca/eefef69b.jpg","comment_is_top":false,"comment_ctime":1640697106,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"分桶（航班记录）、列转行（不同地区的发行日期，优化索引量级）、版本字段（应对多版本情况，文档模型格式太多）、近似计算（用于对精度要求不高的场景，比如统计网页点击浏览）、预聚合字段（业绩排名，游戏排名，商品统计等精确统计），","like_count":0},{"had_liked":false,"id":278166,"user_name":"Geek_7154af","can_delete":false,"product_type":"c3","uid":2082306,"ip_address":"","ucode":"E738DC8F4C93C0","user_header":"","comment_is_top":false,"comment_ctime":1612781626,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"老师你好，是否可以通过readPreference实现读写分离的作用？\n也就是否不需要再为mongo复制集做浮云VIP操作了？","like_count":0},{"had_liked":false,"id":239714,"user_name":"誠","can_delete":false,"product_type":"c3","uid":1241239,"ip_address":"","ucode":"ED389558F141F8","user_header":"https://static001.geekbang.org/account/avatar/00/12/f0/97/9c69ea5c.jpg","comment_is_top":false,"comment_ctime":1596622036,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"在主节点执行db.test.find().readPref(&quot;secondary&quot;)是两条数据，在secondary节点上执行db.test.find().readPref(&quot;primary&quot;)提示：&quot;errmsg&quot; : &quot;not master and slaveOk=false&quot;，但是在secondary节点上执行db.test.find().readPref(&quot;secondary&quot;)是可以查到1条数据","like_count":0,"discussions":[{"author":{"id":2459867,"avatar":"https://static001.geekbang.org/account/avatar/00/25/88/db/48366dc1.jpg","nickname":"人生就是梦","note":"","ucode":"4E1B3C51FB9CB8","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":351826,"discussion_content":"同问\nError: error: {\n\t&#34;operationTime&#34; : Timestamp(1614479205, 1),\n\t&#34;ok&#34; : 0,\n\t&#34;errmsg&#34; : &#34;not master and slaveOk=false&#34;,\n\t&#34;code&#34; : 13435,\n\t&#34;codeName&#34; : &#34;NotPrimaryNoSecondaryOk&#34;,\n\t&#34;$clusterTime&#34; : {\n\t\t&#34;clusterTime&#34; : Timestamp(1614479205, 1),\n\t\t&#34;signature&#34; : {\n\t\t\t&#34;hash&#34; : BinData(0,&#34;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&#34;),\n\t\t\t&#34;keyId&#34; : NumberLong(0)\n\t\t}\n\t}\n}\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1614479343,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":213213,"user_name":"葫芦娃-Dear","can_delete":false,"product_type":"c3","uid":1743582,"ip_address":"","ucode":"606C2E1D80B612","user_header":"https://static001.geekbang.org/account/avatar/00/1a/9a/de/abd008f3.jpg","comment_is_top":false,"comment_ctime":1588332566,"is_pvip":false,"replies":null,"discussion_count":4,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"两个从节点都锁住了，但是主节点执行db.test.find().readPref(&quot;secondary&quot;)是两条数据","like_count":0,"discussions":[{"author":{"id":2556093,"avatar":"https://static001.geekbang.org/account/avatar/00/27/00/bd/a55237a0.jpg","nickname":"gsh","note":"","ucode":"616A4F7AAEC8AF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":566276,"discussion_content":"mongo mongodb://root1:123456@10.0.0.29:28017,10.0.0.30:28017,10.0.0.31:28017/?replicaSet=my_repl  使用此方式链接","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1650638239,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2485664,"avatar":"https://static001.geekbang.org/account/avatar/00/25/ed/a0/cc89c128.jpg","nickname":"大聖","note":"","ucode":"5FD991D883BE78","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":552348,"discussion_content":"你应该是在主节点跑的吧，我没查到文档，但是怀疑主节的shell里直接查，最后发现从节点没有还是到主节点去查了。如果是远程连接去查的话，db.test.find().readPref(&#34;secondary&#34;)是查询不到的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1645425324,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1803177,"avatar":"","nickname":"david","note":"","ucode":"3E05713BC5CD5E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":298459,"discussion_content":"我也是","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597303014,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1241239,"avatar":"https://static001.geekbang.org/account/avatar/00/12/f0/97/9c69ea5c.jpg","nickname":"誠","note":"","ucode":"ED389558F141F8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":296685,"discussion_content":"请问你的问题解决了么，我的也是主节点执行db.test.find().readPref(&#34;secondary&#34;)是两条数据，在secondary节点上执行db.test.find().readPref(&#34;primary&#34;)提示：&#34;errmsg&#34; : &#34;not master and slaveOk=false&#34;，但是在secondary节点上执行db.test.find().readPref(&#34;secondary&#34;)是可以查到1条数据","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596622009,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}