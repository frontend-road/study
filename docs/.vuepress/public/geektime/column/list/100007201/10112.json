{"id":10112,"title":"第15讲 | 如何载入背景音乐和音效？","content":"<p>好的音乐总是伴随着游戏一起，一直被玩家所记忆。在游戏中播放音乐和音效并不是什么困难的事情，但是究竟什么时候播放什么音效，具体怎么实现，这恐怕就需要一些技巧了。比如，我今天要讲的，我们可以和某些函数捆绑在一起实现。</p><p>Pygame支持mp3、ogg、wav音频和音效的播放。音乐的模块都在pygame.mixer中，这里面包括音乐和音效。</p><p>我们在使用音频部分模块的时候，需要先初始化一次。</p><pre><code>pygame.mixer.init()\n</code></pre><p>这个初始化应该在pygame.init()的初始化之后。</p><p>我们来看一下具体的函数，这些函数，存在在pygame.mixer.Sound模块下。</p><p><img src=\"https://static001.geekbang.org/resource/image/29/4d/299c0650d736f939189c49b32eb2b54d.jpg?wh=728*556\" alt=\"\"></p><p>我们再来看一下Pygame.mixer.music音乐模块。我们可以尝试一下载入音频并且播放。</p><pre><code>pygame.mixer.music.load('bgm.mp3')\npygame.mixer.music.set_volume(0.5)\npygame.mixer.music.play()\ns1 = pygame.mixer.Sound('a.wav') \ns1.set_volume(0.5)\ns2 = pygame.mixer.Sound('b.wav')\ns2.set_volume(0.5)\n</code></pre><p>我来解释一下这段代码。</p><p>刚开始，我们载入了一个名叫bgm的mp3文件，告诉程序需要载入这个文件，然后调整音量到0.5，随后就是play，也就是播放，播放是在程序的后台播放，然后程序会接着跑到下面的代码行。</p><p>随后，我们使用Sound模块，Sound模块初始化会载入a.wav，然后返回一个对象，这个对象设置音量为0.5，随后再初始化一次，载入b.wav，然后设置音量为0.5。</p><!-- [[[read_end]]] --><p>到这里为止，我们已经将所有的初始化、设置都在游戏的循环外做好了。</p><p>随后，我们需要结合前几节的内容，在循环里面，对飞机碰撞进行声音的操作，比如出现爆炸声的时候，播放什么声音；碰撞结束，播放另一种的声音。</p><pre><code>if True == collide(pln, (100,300+y1), enm, (100,20+y2)):\ns1.play()\nelse:\n  s2.play()\nfor event in pygame.event.get():\n   if event.type == QUIT:\n     pygame.quit()\n   if event.type == KEYDOWN:\n     if event.key == K_p:\n       pygame.mixer.music.pause()\n     if event.key == K_r:\n       pygame.mixer.music.unpause()\n</code></pre><p>首先，我们使用<strong>collide函数</strong>。这在前面几章有过详细的说明。</p><p>这是一段检测飞机碰撞的代码，如果飞机碰撞了的话，就会返回True，如果返回True的话，我们就播放s1音频，否则就播放s2音频。当然，这个s2音频可能会一直在播放（因为一直没有碰撞）。</p><p>随后就是<strong>事件监测</strong>，如果检测到K_p，就是按下键盘p，就让音乐停止，使用pause函数；如果按下r键，就恢复播放。</p><p>我们在Pygame上的操作已经基本结束了，但是，音频和音效的内容并没有结束。</p><p>在游戏编程中，我们需要嵌入音频和音效，特别是在没有Pygame的时候，如果有一些游戏引擎没有提供音频库的话，我们就需要自己使用第三方的音频库。虽然可以使用耳熟能详的ffmpeg，但是感觉有点大材小用了，所以我们需要一个专门的音频库。</p><p>在这里，我推荐<strong>BASS音频库</strong>。你可以去 <a href=\"http://www.un4seen.com\">http://www.un4seen.com</a> 下载开发库。这个音频库是不开源的，如果你只是自己开发游戏玩玩，非商业目的，就可以使用。如果是商业使用，那就需要购买证书。</p><p><img src=\"https://static001.geekbang.org/resource/image/90/e2/9022635f73854d8b464a188c585ee6e2.jpg?wh=782*410\" alt=\"\"></p><p>在这个页面上，我们点击download按钮，就会下载最新版本的开发库。解压缩下来，会出现对应几个语言的开发目录。</p><p>其中bass.dll文件是动态链接库，要使用的话，可以在c文件夹下，使用lib库和bass.h进行头文件包含进行编程。</p><p>我们来看一下，如何使用C/C++语言加入Bass引擎的代码。</p><pre><code>BASS_Init(-1, 44100, 0, hwnd, NULL);\nHSTREAM s = BASS_StreamCreateFile(false, &quot;a.mp3&quot;, 0, 0, 0);\nBASS_ChannelPlay(s, false);\nBASS_StreamFree(s)\n</code></pre><p>首先，我们将 BASS 库初始化，初始化的参数是：设备、输出比率、标志位（比如8位音质、立体声、3D等等）、Windows句柄。你也可以输入0。最后一个是clsid，就是用于初始化DirectSound的类的ID，一般会使用NULL。</p><p>随后，开始从文件建立一个流，BASS_StreamCreateFile函数，返回一个HSTREAM。HSTREAM其实是一个DWORD类型。</p><p>这个函数里的参数，我也解释一下。</p><ul>\n<li>\n<p>第一个参数是内存。如果传入true的话，就将这个流保存在内存中；否则的话，就不保存在内存中。</p>\n</li>\n<li>\n<p>第二个参数是音频文件名。这个参数和第一个参数会联动。当第一个参数保存在内存中的时候，就填入内存地址，否则就填入文件名。</p>\n</li>\n<li>\n<p>第三个参数是偏移量，也就是文件从哪里开始播放。当然这个参数只在第一个参数为false，不保存在内存的情况下起作用。</p>\n</li>\n<li>\n<p>第四个参数是长度，如果填入0，就是所有长度。</p>\n</li>\n<li>\n<p>最后一个是标志位，填入的是创建模式，比如是循环播放方式，还是软件解码模式等等。</p>\n</li>\n</ul><p>接下来就是开始播放，第一个填入的是刚才返回的流的句柄，第二个参数是是否重新开始播放。最后一个就是播放完后进行回收资源，删除句柄。</p><pre><code>float v; DWORD r;\nBASS_SetConfig(BASS_CONFIG_GVOL_STREAM, 100);\nv = BASS_GetVolume();\nv = 200;\nBASS_SetVolume(v);\nr = BASS_ChannelIsActive(s);\nif(r == BASS_ACTIVE_PAUSED)\n...\nelse if(r == BASS_ACTIVE_PLAYING)\n...\nelse if(r == BASS_ACTIVE_STOPPED)\n...\nelse if (r == BASS_ACTIVE_STALLED)\n  ..\n</code></pre><p>接下来就是调整音量以及获取播放的状态功能。</p><p>其中BASS_SetConfig中，第一个参数是选项，第二个参数是调整音量的值，BASS_CONFIG_GVOL_STREAM的意义是全局的流的音量。</p><p>随后我们就开始取得音量，BASS_GetVolume是获取系统的音量，并不是流的音量，第五行代码就是设置系统音量。</p><p>接下来，我们就要获取播放的状态。在BASS_ChannelIsActive的函数内填入流的句柄，随后获取返回值，然后使用返回值进行比较，其中BASS_ACTIVE_PAUSED，就是播放状态暂停，BASS_ACTIVE_PLAYING是正在播放中或者录音状态，BASS_ACTIVE_STOPPED是停止状态，或者流句柄并不是有效的，BASS_ACTIVE_STALLED是停滞状态。</p><p>一般的原因是，播放的状态缺少样本数据，流的播放停滞了，如果数据足够播放的话，就会自动恢复。</p><p>BASS库还有许许多多的函数和功能，就不在这里过多阐述了。</p><h2>小结</h2><p>我来总结一下。今天我们讲解了Pygame中音频和音效的播放。你应该记住这些东西。</p><ul>\n<li>\n<p>在Pygame中，播放音乐是不需要进行多线程控制的。它本身就会在后台进行播放。</p>\n</li>\n<li>\n<p>所有的音乐和音效都在pygame.mixer模块中，如果载入的是音乐，就使用music模块；如果载入的是音效，就使用Sound模块。</p>\n</li>\n<li>\n<p>随后我们介绍了BASS音频库。这几乎是最专业的音频库了。由于是C接口，所以通用多种语言，你可以使用.NET或者VB等语言来应用。当然如果要进行后台播放、多个频道播放等功能，你需要编写多线程的代码，并没有Pygame那么轻松，这里面很多事情需要自己去做。</p>\n</li>\n</ul><p>现在给你留一个小问题。</p><p>在pygame.mixer.music模块中，如何播放一首音乐后立刻播放另外一首音乐？</p><p>欢迎留言说出你的看法。我在下一节的挑战中等你！</p>","neighbors":{"left":{"article_title":"第14讲 | 如何制作游戏资源包和保存机制？","id":10106},"right":{"article_title":"第16讲 | 如何在游戏中载入UI和菜单？","id":10436}},"comments":[{"had_liked":false,"id":14985,"user_name":"zhu见见","can_delete":false,"product_type":"c1","uid":1141494,"ip_address":"","ucode":"22F745AA60503D","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erwcUXd1YciaE2VmCRZUjbm0hscIAwvXJOQtibK2aor2DrmxxPszsfecZ11dibniakRSkMYrhp8ibsHWoA/132","comment_is_top":false,"comment_ctime":1530785748,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5825753044","product_id":100007201,"comment_content":"有源代码地址吗","like_count":0},{"had_liked":false,"id":30428,"user_name":"艾尔欧唯伊","can_delete":false,"product_type":"c1","uid":1139716,"ip_address":"","ucode":"5BD50691342461","user_header":"https://static001.geekbang.org/account/avatar/00/11/64/04/18875529.jpg","comment_is_top":false,"comment_ctime":1538838999,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1538838999","product_id":100007201,"comment_content":"为什么pygame 必须要开启窗口才能播放音乐，去掉pygame.display.set_mode()就没有声音。另外死循环是因为防止程序自己关闭么？","like_count":0},{"had_liked":false,"id":16002,"user_name":"换你睡床右边","can_delete":false,"product_type":"c1","uid":1176363,"ip_address":"","ucode":"896D3AAF04F1A8","user_header":"https://static001.geekbang.org/account/avatar/00/11/f3/2b/4896a525.jpg","comment_is_top":false,"comment_ctime":1531729493,"is_pvip":false,"replies":[{"id":"5669","content":"不能加载有很多原因，可以说得更明白点看看代码","user_name":"作者回复","user_name_real":"DarkSpy","uid":"1135118","ctime":1531897001,"ip_address":"","comment_id":16002,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1531729493","product_id":100007201,"comment_content":"补一个坑吧，可能我和作者用的版本不太一样，有时候代码会有一些差异才能在我这边运行，在pygame.mixer.load可以加载包括mp3在内的音频，而pygame.mixer.Sound却不能加载mp3。小白填坑中🤔","like_count":0,"discussions":[{"author":{"id":1135118,"avatar":"https://static001.geekbang.org/account/avatar/00/11/52/0e/2988158e.jpg","nickname":"DarkSpy","note":"","ucode":"F440F4BA28E92F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":420630,"discussion_content":"不能加载有很多原因，可以说得更明白点看看代码","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1531897001,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":15234,"user_name":"三硝基甲苯","can_delete":false,"product_type":"c1","uid":1141929,"ip_address":"","ucode":"C492B058C2A5C0","user_header":"","comment_is_top":false,"comment_ctime":1531020793,"is_pvip":false,"replies":[{"id":"5152","content":"真的大型游戏也不会真的拿来做代码测试用","user_name":"作者回复","user_name_real":"DarkSpy","uid":"1135118","ctime":1531043138,"ip_address":"","comment_id":15234,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1531020793","product_id":100007201,"comment_content":"pygame.mixer.init()\r<br>songs = [&quot;sugar-1.mp3&quot;,&quot;sugar-2.mp3&quot;,&quot;sugar-3.mp3&quot;]\r<br>current = 0\r<br>\r<br>while True:\r<br>\r<br>    if not (pygame.mixer.music.get_busy()):\r<br>        pygame.mixer.music.load(songs[current])\r<br>        pygame.mixer.music.set_volume(0.5)\r<br>        pygame.mixer.music.play()\r<br>        current = current + 1\r<br>        if current &gt; len(songs) - 1:\r<br>            current = 0\r<br>            \r<br>    for event in pygame.event.get():\r<br>        if event.type == pygame.QUIT:\r<br>            pygame.quit()<br><br><br>看了一眼doc。试了一下 感觉这样应该没啥问题了。只是感觉写在循环里。 如果以后游戏做大了会出事情吧。","like_count":0,"discussions":[{"author":{"id":1135118,"avatar":"https://static001.geekbang.org/account/avatar/00/11/52/0e/2988158e.jpg","nickname":"DarkSpy","note":"","ucode":"F440F4BA28E92F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":420297,"discussion_content":"真的大型游戏也不会真的拿来做代码测试用","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1531043138,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":15167,"user_name":"wusiration","can_delete":false,"product_type":"c1","uid":1104438,"ip_address":"","ucode":"A9403377054F1E","user_header":"https://static001.geekbang.org/account/avatar/00/10/da/36/ac0ff6a7.jpg","comment_is_top":false,"comment_ctime":1530941193,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1530941193","product_id":100007201,"comment_content":"当音乐播放完成时，调用pygame.mixer.music.set_endevent()函数，发送一个事件标志。同时，在循环中，当监听到播放结束的事件标志后，开始加载另外一首歌并播放。<br><br>pygame.mixer.music.load(&quot;a.mp3&quot;)\r<br>pygame.mixer.music.set_endevent(pygame.USEREVENT)\r<br>pygame.mixer.music.play()\r<br>while True:\r<br>   for event in pygame.event.get():\r<br>      if event.type == pygame.USEREVENT: \r<br>            pygame.mixer.music.load(&quot;b.mp3&quot;)\r<br>            pygame.mixer.music.play()<br><br>pygame文档中说pygame.mixer.music.queue()也可以实现该要求，但是在使用中根本没起作用。","like_count":0}]}