{"id":136528,"title":"49 | 微服务API网关搭建三步曲（三）","content":"<p>你好，我是温铭。</p><p>今天这节课，微服务 API 网关搭建就到了最后的环节了。让我们用一个最小的示例来把之前选型的组件，按照设计的蓝图，拼装运行起来吧！</p><h2>Nginx 配置和初始化</h2><p>我们知道，API 网关是用来处理流量入口的，所以我们首先需要在 Nginx.conf 中做简单的配置，让所有的流量都通过网关的 Lua 代码来处理。</p><pre><code>server {\n    listen 9080;\n\n    init_worker_by_lua_block {\n        apisix.http_init_worker()\n    }\n\n    location / {\n        access_by_lua_block {\n            apisix.http_access_phase()\n        }\n        header_filter_by_lua_block {\n            apisix.http_header_filter_phase()\n        }\n        body_filter_by_lua_block {\n            apisix.http_body_filter_phase()\n        }\n        log_by_lua_block {\n            apisix.http_log_phase()\n        }\n    }\n}\n</code></pre><p>这里我们使用开源 API 网关 <a href=\"https://github.com/apache/apisix\">APISIX</a>  为例，所以上面的代码示例中带有 <code>apisix</code> 的关键字。在这个示例中，我们监听了 9080 端口，并通过 <code>location /</code> 的方式，把这个端口的所有请求都拦截下来，并依次通过 <code>access</code>、<code>rewrite</code>、<code>header filter</code>、<code>body filter</code> 和 <code>log</code> 这几个阶段进行处理，在每个阶段中都会去调用对应的插件函数。其中， <code>rewrite</code> 阶段便是在 <code>apisix.http_access_phase</code> 函数中合并处理的。</p><p>而对于系统初始化的工作，我们放在了 <code>init_worker</code> 阶段来处理，这其中包含了读取各项配置参数、预制 etcd 中的目录、从 etcd 中获取插件列表、对于插件按照优先级进行排序等。我这里列出了关键部分的代码并进行讲解，当然，你可以在 GitHub 上看到更完整的<a href=\"https://github.com/apache/apisix/blob/master/lua/apisix.lua#L47\">初始化函数</a>。</p><!-- [[[read_end]]] --><pre><code>function _M.http_init_worker()\n-- 分别初始化路由、服务和插件这三个最重要的部分\n    router.init_worker()\n    require(&quot;apisix.http.service&quot;).init_worker()\n    require(&quot;apisix.plugin&quot;).init_worker()\nend\n</code></pre><p>通过阅读这段代码，你可以发现，<code>router</code> 和 <code>plugin</code> 这两部分的初始化相对复杂一些，主要涉及到读取配置参数，并根据参数的不同做一些选择。因为这里会涉及到从 etcd 中读取数据，所以我们使用的是 <code>ngx.timer</code> 的方式，来绕过“不能在 <code>init_worker</code> 阶段使用 cosocket”的这个限制。如果你对这部分很感兴趣并且学有余力，建议一定要去读读源码，加深理解。</p><h2>匹配路由</h2><p>在最开始的 <code>access</code> 阶段里面，我们首先需要做的就是匹配路由，根据请求中携带 uri、host、args、cookie 等，来和已经设置好的路由规则进行匹配：</p><pre><code>router.router_http.match(api_ctx)\n</code></pre><p>对外暴露的，其实只有上面一行代码，这里的<code>api_ctx</code> 中存放的就是 uri、host、args、cookie 这些请求的信息。而具体的 <code>match</code> 函数的<a href=\"https://github.com/apache/apisix/blob/master/apisix/http/router/radixtree_uri.lua\">实现</a>，就用到了我们前面提到过的 <code>lua-resty-radixtree</code>。如果没有命中，就说明这个请求并没有设置与之对应的上游，就会直接返回 404。</p><pre><code>local router = require(&quot;resty.radixtree&quot;)\n\nlocal match_opts = {}\n\nfunction _M.match(api_ctx)\n    -- 从 ctx 中获取请求的参数，作为路由的判断条件\n    match_opts.method = api_ctx.var.method\n    match_opts.host = api_ctx.var.host\n    match_opts.remote_addr = api_ctx.var.remote_addr\n    match_opts.vars = api_ctx.var\n    -- 调用路由的判断函数 \n    local ok = uri_router:dispatch(api_ctx.var.uri, match_opts, api_ctx)\n    -- 没有命中路由就直接返回 404 \n    if not ok then\n        core.log.info(&quot;not find any matched route&quot;)\n        return core.response.exit(404)\n    end\n\n    return true\nend\n</code></pre><h2>加载插件</h2><p>当然，如果路由可以命中，就会走到过滤插件和加载插件的步骤，这也是 API 网关的核心所在。我们先来看下面这段代码：</p><pre><code>local plugins = core.tablepool.fetch(&quot;plugins&quot;, 32, 0)\n-- etcd 中的插件列表和本地配置文件中的插件列表进行交集运算 \napi_ctx.plugins = plugin.filter(route, plugins)\n\n-- 依次运行插件在 rewrite 和 access 阶段挂载的函数 \nrun_plugin(&quot;rewrite&quot;, plugins, api_ctx)\nrun_plugin(&quot;access&quot;, plugins, api_ctx)\n</code></pre><p>在这段代码中，我们首先通过 table pool 的方式，申请了一个长度为 32 的 table，这是我们之前介绍过的性能优化技巧。然后便是插件的过滤函数。你可能疑惑，为什么需要这一步呢？在插件的 <code>init worker</code> 阶段，我们不是已经从 etcd 中获取插件列表并完成排序了吗？</p><p>事实上，这里的过滤是和本地配置文件来做对比的，主要有下面两个原因。</p><ul>\n<li>第一，新开发的插件需要灰度来发布，这时候新插件在 etcd 的列表中存在，但只在部分网关节点中处于开启状态。所以，我们需要额外做一次交集的运算。</li>\n<li>第二，为了支持 debug 模式。终端的请求经过了哪些插件的处理？这些插件的加载顺序是什么？这些信息在调试的时候会很有用，所以在过滤函数中也会判断其是否处于 debug 模式，并在响应头中记录下这些信息。</li>\n</ul><p>因此，在 access 阶段的最后，我们会把这些过滤好的插件，按照优先级逐个运行，如下面这段代码所示：</p><pre><code>local function run_plugin(phase, plugins, api_ctx)\n    for i = 1, #plugins, 2 do\n        local phase_fun = plugins[i][phase]\n        if phase_fun then\n            -- 最核心的调用代码 \n            phase_fun(plugins[i + 1], api_ctx)\n        end\n    end\n\n    return api_ctx\nend\n</code></pre><p>你可以看到，在遍历插件的时候，我们是以 <code>2</code> 为间隔进行的，这是因为每个插件都会有两个部分组成：插件对象和插件的配置参数。现在，我们来看上面示例代码中最核心的那一行代码：</p><pre><code>phase_fun(plugins[i + 1], api_ctx)\n</code></pre><p>单独看这行代码会有些抽象，我们用一个具体的 <code>limit_count</code> 插件来替换一下，就会清楚很多：</p><pre><code>limit_count_plugin_rewrite_function(conf_of_plugin, api_ctx)\n</code></pre><p>到这里，API 网关的整体流程，我们就实现得差不多了。这些代码都在同一个代码<a href=\"https://github.com/apache/apisix/blob/master/apisix/init.lua\">文件</a>中，它里面有 400 多行代码，但核心的代码就是我们上面所介绍的这短短几十行。</p><h2>编写插件</h2><p>现在，距离一个完整的 demo 还差一件事情，那就是编写一个插件，让它可以跑起来。我们以 <code>limit-count</code> 这个限制请求数的插件为例，它的<a href=\"https://github.com/apache/apisix/blob/master/apisix/plugins/limit-count.lua\">完整实现</a>只有 60 多行代码，你可以点击链接查看。下面，我来详细讲解下其中的关键代码。</p><p>首先，我们要引入 <code>lua-resty-limit-traffic</code> ，作为限制请求数的基础库：</p><pre><code>local limit_count_new = require(&quot;resty.limit.count&quot;).new\n</code></pre><p>然后，使用 rapidjson 中的 json schema ，来定义这个插件的参数有哪些：</p><pre><code>local schema = {\n    type = &quot;object&quot;,\n    properties = {\n        count = {type = &quot;integer&quot;, minimum = 0},\n        time_window = {type = &quot;integer&quot;, minimum = 0},\n        key = {type = &quot;string&quot;,\n        enum = {&quot;remote_addr&quot;, &quot;server_addr&quot;},\n        },\n        rejected_code = {type = &quot;integer&quot;, minimum = 200, maximum = 600},\n    },\n    additionalProperties = false,\n    required = {&quot;count&quot;, &quot;time_window&quot;, &quot;key&quot;, &quot;rejected_code&quot;},\n}\n</code></pre><p>插件的这些参数，和大部分 <code>resty.limit.count</code> 的参数是对应的，其中包含了限制的 key、时间窗口的大小、限制的请求数。另外，插件中增加了一个参数: <code>rejected_code</code>，在请求被限速的时候返回指定的状态码。</p><p>最后一步，我们把插件的处理函数挂载到 <code>rewrite</code> 阶段：</p><pre><code>function _M.rewrite(conf, ctx)\n    -- 从缓存中获取 limit count 的对象，如果没有就使用 `create_limit_obj` 函数新建并缓存 \n    local lim, err = core.lrucache.plugin_ctx(plugin_name, ctx,  create_limit_obj, conf)\n\n    -- 从 ctx.var 中获取 key 的值，并和配置类型和配置版本号一起组成新的 key \n    local key = (ctx.var[conf.key] or &quot;&quot;) .. ctx.conf_type .. ctx.conf_version\n\n    --  进入限制的判断函数\n    local delay, remaining = lim:incoming(key, true)\n    if not delay then\n        local err = remaining\n        -- 如果超过阈值，就返回指定的状态码 \n        if err == &quot;rejected&quot; then\n            return conf.rejected_code\n        end\n\n        core.log.error(&quot;failed to limit req: &quot;, err)\n        return 500\n    end\n\n    -- 如果没有超过阈值，就放行，并设置对应响应头 \n    core.response.set_header(&quot;X-RateLimit-Limit&quot;, conf.count,\n                             &quot;X-RateLimit-Remaining&quot;, remaining)\nend\n</code></pre><p>上面的代码中，进行限制判断的逻辑只有一行，其他的都是来做准备工作和设置响应头的。如果没有超过阈值，就会继续按照优先级运行下一个插件。</p><h2>写在最后</h2><p>今天这节课，通过整体框架和插件的编写，我们就完成了一个 API 网关的 Demo。更进一步，利用本专栏学到的 OpenResty 知识，你可以在上面继续添砖加瓦，搭建更丰富的功能。</p><p>最后，给你留一个思考题。我们知道，API 网关不仅可以处理七层的流量，也可以处理四层的流量，基于此，你能想到它的一些使用场景吗？欢迎留言说说你的看法，也欢迎你把这篇文章分享出去，和更多的人一起学习、交流。</p>","comments":[{"had_liked":false,"id":180993,"user_name":"铁匠","can_delete":false,"product_type":"c1","uid":1088309,"ip_address":"","ucode":"D403835F5DB8F7","user_header":"https://static001.geekbang.org/account/avatar/00/10/9b/35/79e42357.jpg","comment_is_top":false,"comment_ctime":1582454817,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"27352258593","product_id":100028301,"comment_content":"我自己实现了一个简单的网关服务，注册中心使用etcd，因为是初学，还有很多改进的地方，设计思路和优化点欢迎老师和大家指点。github: https:&#47;&#47;github.com&#47;fengjx&#47;resty-gateway","like_count":7},{"had_liked":false,"id":133752,"user_name":"一声扣钉","can_delete":false,"product_type":"c1","uid":1001609,"ip_address":"","ucode":"8B19A49A4CF6E9","user_header":"https://static001.geekbang.org/account/avatar/00/0f/48/89/9760b341.jpg","comment_is_top":false,"comment_ctime":1568645462,"is_pvip":false,"replies":[{"id":"51337","content":"这是个好问题。如果你修改了响应体，那么也同时需要在header_filter阶段把 content_length 置为 nil:<br>ngx.header.content_length = nil","user_name":"作者回复","user_name_real":"温铭@APISIX","uid":"1017955","ctime":1568680746,"ip_address":"","comment_id":133752,"utype":1}],"discussion_count":2,"race_medal":0,"score":"27338449238","product_id":100028301,"comment_content":"老师，如果需要修改respones body的内容，就只能在body_filter里做修改，这样引起body长度与content-length长度不一致，应该如何处理？","like_count":7,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"温铭@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":467495,"discussion_content":"这是个好问题。如果你修改了响应体，那么也同时需要在header_filter阶段把 content_length 置为 nil:\nngx.header.content_length = nil","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1568680746,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2024601,"avatar":"","nickname":"王嵘","note":"","ucode":"3E2BFAB6C96A31","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":393212,"discussion_content":"chunk模式","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631289944,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":141411,"user_name":"蓝色海洋","can_delete":false,"product_type":"c1","uid":1122512,"ip_address":"","ucode":"74F0C097750F96","user_header":"https://static001.geekbang.org/account/avatar/00/11/20/d0/ad12060d.jpg","comment_is_top":false,"comment_ctime":1571149130,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"10161083722","product_id":100028301,"comment_content":"老师您好，我这边想实现一个kong的灰度发布的插件，感觉没有思路，请老师指点一下谢谢","like_count":2,"discussions":[{"author":{"id":2425324,"avatar":"","nickname":"王胜辉","note":"","ucode":"A2B7E313479B36","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":406220,"discussion_content":"老师要推广自己公司的apisix，kong是最大的竞争对手","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1634723384,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2024601,"avatar":"","nickname":"王嵘","note":"","ucode":"3E2BFAB6C96A31","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":393213,"discussion_content":"可以动态修改service和upstream对应关系","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631290010,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":138683,"user_name":"言身寸飞","can_delete":false,"product_type":"c1","uid":1446071,"ip_address":"","ucode":"3381F030A64FC1","user_header":"https://static001.geekbang.org/account/avatar/00/16/10/b7/d8ae07c8.jpg","comment_is_top":false,"comment_ctime":1570419884,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5865387180","product_id":100028301,"comment_content":"插件那块不是很明白可以详细讲讲么","like_count":1},{"had_liked":false,"id":133956,"user_name":"段先森","can_delete":false,"product_type":"c1","uid":1310788,"ip_address":"","ucode":"90251BB8BF8DDB","user_header":"https://static001.geekbang.org/account/avatar/00/14/00/44/d5cf762b.jpg","comment_is_top":false,"comment_ctime":1568706399,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5863673695","product_id":100028301,"comment_content":"老师  把openresty作为IM系统的链接层可行吗  就是维护ws链接 应用层ack这些","like_count":1,"discussions":[{"author":{"id":1068843,"avatar":"https://static001.geekbang.org/account/avatar/00/10/4f/2b/da7efc7e.jpg","nickname":"cloudy","note":"","ucode":"60A0731E442024","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":188207,"discussion_content":"lua-resty-websocket","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582804390,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":333657,"user_name":"CheverJohn","can_delete":false,"product_type":"c1","uid":2877221,"ip_address":"","ucode":"9B6D41FB0CFE96","user_header":"https://static001.geekbang.org/account/avatar/00/2b/e7/25/f88357fa.jpg","comment_is_top":false,"comment_ctime":1644461534,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1644461534","product_id":100028301,"comment_content":"给老师更新一下，目前limit-count 插件选用了 jsonschema 了，而不是 腾讯的 rapidjson 啦。建议注明<br>","like_count":1},{"had_liked":false,"id":241228,"user_name":"王慧东","can_delete":false,"product_type":"c1","uid":1758432,"ip_address":"","ucode":"BDC7A487D63AC5","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eo8paWOic3x1nZuQGkHJOMzKmjf0zShbGjUyTnoKGqrJTxL3shqliaUe6AvVH4c8ib7icOCVOBAGFhL5Q/132","comment_is_top":false,"comment_ctime":1597219948,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1597219948","product_id":100028301,"comment_content":"老师,麻烦问一下怎么在init_worker_by_lua 加载数据库信息？？","like_count":0},{"had_liked":false,"id":223476,"user_name":"半夜一声笑","can_delete":false,"product_type":"c1","uid":1015811,"ip_address":"","ucode":"261241E206997E","user_header":"","comment_is_top":false,"comment_ctime":1591099492,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1591099492","product_id":100028301,"comment_content":"老师，如果这样调用ngx.timer.at(0,func) 可以获取到func返回的结果吗 找了一圈没找到合适的方法","like_count":0},{"had_liked":false,"id":134197,"user_name":"陈海源","can_delete":false,"product_type":"c1","uid":1095080,"ip_address":"","ucode":"28BBF1F581B374","user_header":"https://static001.geekbang.org/account/avatar/00/10/b5/a8/2d24e6ca.jpg","comment_is_top":false,"comment_ctime":1568773321,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1568773321","product_id":100028301,"comment_content":"温老师，这个demo的源代码的地址哪里可以查看","like_count":0,"discussions":[{"author":{"id":1199649,"avatar":"https://static001.geekbang.org/account/avatar/00/12/4e/21/e3a5beac.jpg","nickname":"书生","note":"","ucode":"EAE0982DF34AF7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":271425,"discussion_content":"这个demo处理nginx配置文件，其他都是apisix里边的代码。。。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590135423,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":133699,"user_name":"helloworld","can_delete":false,"product_type":"c1","uid":1105161,"ip_address":"","ucode":"1EECCA0F43E278","user_header":"https://static001.geekbang.org/account/avatar/00/10/dd/09/feca820a.jpg","comment_is_top":false,"comment_ctime":1568638801,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1568638801","product_id":100028301,"comment_content":"通过老师的专栏，我又系统掌握了一门技术，现在已经可以使用or开发一些实用的api项目了。感谢老师的分享。","like_count":0,"discussions":[{"author":{"id":2142023,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/hBS3EmeUoB3psO1kjxweMjgVtibZVnL21wWoNWPFOHaBjeszrJZySpZQlX9WfjLQnyibqo0jBjC8GsFvCwpehBlg/132","nickname":"Geek_fb2ac3","note":"","ucode":"8A1A3CB9E23376","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":311040,"discussion_content":"老师讲的，和实践相差甚远，你怎么可能又系统掌握了一门技术？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1602199805,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1105161,"avatar":"https://static001.geekbang.org/account/avatar/00/10/dd/09/feca820a.jpg","nickname":"helloworld","note":"","ucode":"1EECCA0F43E278","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2142023,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/hBS3EmeUoB3psO1kjxweMjgVtibZVnL21wWoNWPFOHaBjeszrJZySpZQlX9WfjLQnyibqo0jBjC8GsFvCwpehBlg/132","nickname":"Geek_fb2ac3","note":"","ucode":"8A1A3CB9E23376","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":311067,"discussion_content":"仙人指路，能力的获得要靠自己去努力实践","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1602209845,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":311040,"ip_address":""},"score":311067,"extra":""}]}]},{"had_liked":false,"id":133491,"user_name":"SMTCode","can_delete":false,"product_type":"c1","uid":1109038,"ip_address":"","ucode":"0D837A753E4FAB","user_header":"https://static001.geekbang.org/account/avatar/00/10/ec/2e/49d13bd2.jpg","comment_is_top":false,"comment_ctime":1568593790,"is_pvip":true,"replies":[{"id":"51274","content":"可以先从 OpenResty 替换 Nginx 开始入手，这是成本最低的：）","user_name":"作者回复","user_name_real":"温铭@APISIX","uid":"1017955","ctime":1568618090,"ip_address":"","comment_id":133491,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1568593790","product_id":100028301,"comment_content":"快结课了，基本上跟下来了，但自己实践偏少（工作中目前未用）。不过确实是强大的课。感谢温老师的持续分享。后期工作中择机引入～","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"温铭@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":467401,"discussion_content":"可以先从 OpenResty 替换 Nginx 开始入手，这是成本最低的：）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1568618090,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}