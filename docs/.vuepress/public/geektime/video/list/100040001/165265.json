{"id":165265,"title":"09 | 实验：聚合查询","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/geektime-mongodb-course\">https://gitee.com/geektime-geekbang/geektime-mongodb-course</a></p>","comments":[{"had_liked":false,"id":151094,"user_name":"第一装甲集群司令克莱斯特","can_delete":false,"product_type":"c3","uid":1265707,"ip_address":"","ucode":"4E8FBB23AD860B","user_header":"https://static001.geekbang.org/account/avatar/00/13/50/2b/2344cdaa.jpg","comment_is_top":false,"comment_ctime":1573652896,"is_pvip":false,"replies":[{"id":58540,"content":"这个问题需要一些时间，所以回复晚了一点。\n\n\n## 数据模型\n\n测试数据：\n\n```javascript\ndb.test.insertMany([\n    {\n        messageType: &#39;01&#39;,\n        date: ISODate(&quot;2019-01-01T01:15:42Z&quot;)\n        &#47;&#47; 其他字段\n    },\n    {\n        messageType: &#39;01&#39;,\n        date: ISODate(&quot;2019-01-01T01:17:42Z&quot;)\n    },\n    {\n        messageType: &#39;02&#39;,\n        date: ISODate(&quot;2019-01-17T01:17:42Z&quot;)\n    },\n    {\n        messageType: &#39;02&#39;,\n        date: ISODate(&quot;2019-01-17T02:17:42Z&quot;)\n    },\n])\n```\n## 解决思路\n\n1. 从日期中提取日期和小时。这里如果有必要，需要考虑时区问题。如果考虑时区问题，则需要3.6以上版本支持；\n1. 按日期、小时分组聚合；\n\n使用到的运算符：\n\n- [$dateToString](https:&#47;&#47;docs.mongodb.com&#47;manual&#47;reference&#47;operator&#47;aggregation&#47;dateToString&#47;)\n- [$year](https:&#47;&#47;docs.mongodb.com&#47;manual&#47;reference&#47;operator&#47;aggregation&#47;year&#47;)\n- [$month](https:&#47;&#47;docs.mongodb.com&#47;manual&#47;reference&#47;operator&#47;aggregation&#47;month&#47;)\n- [$dayOfMonth](https:&#47;&#47;docs.mongodb.com&#47;manual&#47;reference&#47;operator&#47;aggregation&#47;dayOfMonth&#47;)\n\n## 聚合语句\n\n```javascript\ndb.test.aggregate([\n    &#47;&#47; 过滤条件（如果有）\n    {\n        $match: {\n            date: {\n                $gte: ISODate(&quot;2019-01-01T00:00:00Z&quot;),\n                $lt: ISODate(&quot;2019-02-01T00:00:00Z&quot;),\n            }\n        }\n    },\n    &#47;&#47; 映射出日期和小时\n    {\n        $project: {\n            date: {\n                $dateToString: {\n                    date: &quot;$date&quot;,\n                    format: &quot;%Y-%m-%d&quot;,\n                    timezone: &quot;+08:00&quot;\n                }\n            },\n            hour: {\n                $hour: &quot;$date&quot;\n            },\n            messageType: 1\n        }\n    },\n    {\n        &#47;&#47; 按日期、小时、messageType分组计数\n        $group: {\n            _id: {\n                date: &quot;$date&quot;,\n                hour: &quot;$hour&quot;,\n                messageType: &quot;$messageType&quot;\n            },\n            count: {\n                $sum: 1\n            }\n        }\n    }\n]);\n```\n","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1573979425,"ip_address":"","comment_id":151094,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"我们业务场景就遇到了聚合查询的情况，很简单，但是对于小白也很费脑筋。作为网关流量统计需求，接口需要给前端返回每日00:00:00 ~ 23:59:59这一天内，字段messageType分别为01 02 03 04 ，四种业务意义的请求数量，请老师明示怎么动态取每天的date，然后返回的结果分条显示当天24小时之内，不同值messageType得请求数量count(messageType)。","like_count":34,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":474362,"discussion_content":"这个问题需要一些时间，所以回复晚了一点。\n\n\n## 数据模型\n\n测试数据：\n\n```javascript\ndb.test.insertMany([\n    {\n        messageType: &amp;#39;01&amp;#39;,\n        date: ISODate(&amp;quot;2019-01-01T01:15:42Z&amp;quot;)\n        // 其他字段\n    },\n    {\n        messageType: &amp;#39;01&amp;#39;,\n        date: ISODate(&amp;quot;2019-01-01T01:17:42Z&amp;quot;)\n    },\n    {\n        messageType: &amp;#39;02&amp;#39;,\n        date: ISODate(&amp;quot;2019-01-17T01:17:42Z&amp;quot;)\n    },\n    {\n        messageType: &amp;#39;02&amp;#39;,\n        date: ISODate(&amp;quot;2019-01-17T02:17:42Z&amp;quot;)\n    },\n])\n```\n## 解决思路\n\n1. 从日期中提取日期和小时。这里如果有必要，需要考虑时区问题。如果考虑时区问题，则需要3.6以上版本支持；\n1. 按日期、小时分组聚合；\n\n使用到的运算符：\n\n- [$dateToString](https://docs.mongodb.com/manual/reference/operator/aggregation/dateToString/)\n- [$year](https://docs.mongodb.com/manual/reference/operator/aggregation/year/)\n- [$month](https://docs.mongodb.com/manual/reference/operator/aggregation/month/)\n- [$dayOfMonth](https://docs.mongodb.com/manual/reference/operator/aggregation/dayOfMonth/)\n\n## 聚合语句\n\n```javascript\ndb.test.aggregate([\n    // 过滤条件（如果有）\n    {\n        $match: {\n            date: {\n                $gte: ISODate(&amp;quot;2019-01-01T00:00:00Z&amp;quot;),\n                $lt: ISODate(&amp;quot;2019-02-01T00:00:00Z&amp;quot;),\n            }\n        }\n    },\n    // 映射出日期和小时\n    {\n        $project: {\n            date: {\n                $dateToString: {\n                    date: &amp;quot;$date&amp;quot;,\n                    format: &amp;quot;%Y-%m-%d&amp;quot;,\n                    timezone: &amp;quot;+08:00&amp;quot;\n                }\n            },\n            hour: {\n                $hour: &amp;quot;$date&amp;quot;\n            },\n            messag","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573979425,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1076081,"avatar":"https://static001.geekbang.org/account/avatar/00/10/6b/71/e833b14a.jpg","nickname":"李英权","note":"","ucode":"FECAC14A9C414B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":196759,"discussion_content":"哇，原来可以先投影 然后再分组，类似管道连接。如果是sql还要很麻烦的嵌套子查询了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583371482,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":151762,"user_name":"fedwing","can_delete":false,"product_type":"c3","uid":1743661,"ip_address":"","ucode":"2DFF902FD190C7","user_header":"https://static001.geekbang.org/account/avatar/00/1a/9b/2d/f7fca208.jpg","comment_is_top":false,"comment_ctime":1573786636,"is_pvip":false,"replies":[{"id":58378,"content":"谢谢。后续章节会涉及一些设计方面的。但是本课程的目标确实是偏应用方面多一点。源码底层内容太多，可能需要另外的课程来覆盖。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1573790510,"ip_address":"","comment_id":151762,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"还有一个小建议，希望老师更多讲讲为什么这么设计，内部实现原理，方便真正理解mongo，而不只是会用！目前我在国内一线游戏大厂开发一款算是爆款的游戏，随着游戏数据的增多，暴露出一些mongo问题，用的是3.2的mongo，且没有切wt，目前想要调整版本和存储引擎，所以想要深入了解mongo，想要成为mongo高手，期待老师赶紧更新","like_count":8,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":474606,"discussion_content":"谢谢。后续章节会涉及一些设计方面的。但是本课程的目标确实是偏应用方面多一点。源码底层内容太多，可能需要另外的课程来覆盖。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573790510,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":151522,"user_name":"唐朝农民","can_delete":false,"product_type":"c3","uid":1133947,"ip_address":"","ucode":"6F8F43C6652225","user_header":"https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIaOAxRlZjFkGfRBn420LuAcyWkMrpq5iafGdqthX5icJPjql0ibZOAdafaqbfvw4ZpVzDmsaYglVXDw/132","comment_is_top":false,"comment_ctime":1573736207,"is_pvip":false,"replies":[{"id":58390,"content":"你可以打破常规思维考虑。国家的名称你多长时间需要改一次呢？当然，商品名称修改频率会略高一些，但也是低频动作。MongoDB已经提供多表多行事务来保证修改的一致性。另外如果是经常要改的内容，也还是可以按照关系设计，并不是绝对要放到一张表里面。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1573791568,"ip_address":"","comment_id":151522,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师问个实际使用中有点纠结的问题，你的DEMO 中，很多数据基本上都是冗余存储到一个collection上面，比如 订单中的商品或国家直接存储的是对应的名称，而我们使用MySql 时通常存储的是 对应的ID，这样mysql 的查询往往需要join 多张表才能满足用户的查询需求，mongo 这样的冗余存储则不需要，但是这也带来一个问题，就是数据一致性问题，当我需要修改某个商品的名称时对应该商品的所有关联数据都要修改，如果像关系型数据库那样主外键设计，那可能还是需要先设计好对应表之间的关系，并且查询同样要聚合查询，那岂不又失去了MongoDb 的文档灵活性，相比mysql还有那么大的优势吗？目前我们项目中只有类似日志这样永远不会变的数据用的MongoDB存储，还请老师解答我的疑惑","like_count":5,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":474514,"discussion_content":"你可以打破常规思维考虑。国家的名称你多长时间需要改一次呢？当然，商品名称修改频率会略高一些，但也是低频动作。MongoDB已经提供多表多行事务来保证修改的一致性。另外如果是经常要改的内容，也还是可以按照关系设计，并不是绝对要放到一张表里面。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573791568,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":151090,"user_name":"第一装甲集群司令克莱斯特","can_delete":false,"product_type":"c3","uid":1265707,"ip_address":"","ucode":"4E8FBB23AD860B","user_header":"https://static001.geekbang.org/account/avatar/00/13/50/2b/2344cdaa.jpg","comment_is_top":false,"comment_ctime":1573652534,"is_pvip":false,"replies":[{"id":58403,"content":"非常棒！","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1573792711,"ip_address":"","comment_id":151090,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"Mongo Compass官方的就是好用，大而全，我们还在用Mongo Booster，Mongo Compass中的Export To Language，帮我解决了大问题，在Mysql聚合查询语句翻译成MQL，再转换成Java 方式，快速高效，不用去翻MongoaTemplate API了.","like_count":4,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":474361,"discussion_content":"非常棒！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573792711,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1070287,"avatar":"https://static001.geekbang.org/account/avatar/00/10/54/cf/fddcf843.jpg","nickname":"芋头","note":"","ucode":"390438CFF71F0A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":631812,"discussion_content":"mongo compass如何把mysql的无法转换为mongo的？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1700009009,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":151153,"user_name":"vachel","can_delete":false,"product_type":"c3","uid":1216450,"ip_address":"","ucode":"1F91DB68DA8C37","user_header":"https://static001.geekbang.org/account/avatar/00/12/8f/c2/e07b4540.jpg","comment_is_top":false,"comment_ctime":1573658748,"is_pvip":false,"replies":[{"id":58489,"content":"这个范围很广。我们的客户中最大的有100TB的数据量上做聚合的（Amadeus）。当然那个是32台物理服务器和288个微分片的架构，比较复杂了。\n\n通常来说MongoDB有可以在内存做计算的特性，如果你可以把你的数据都放在内存，那么聚合运算的性能大概率可以不错。\n\n如果你有数千万数亿以上的行数要做扫描性汇聚，又是跑在机械盘，索引又没有优化，那么有可能是分钟级的聚合计算性能。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1573889309,"ip_address":"","comment_id":151153,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师，感谢精彩的分享！请教一下聚合查询的性能问题，能否结合您的业务场景自己数据量说明一下  ？非常感谢！","like_count":3,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":474383,"discussion_content":"这个范围很广。我们的客户中最大的有100TB的数据量上做聚合的（Amadeus）。当然那个是32台物理服务器和288个微分片的架构，比较复杂了。\n\n通常来说MongoDB有可以在内存做计算的特性，如果你可以把你的数据都放在内存，那么聚合运算的性能大概率可以不错。\n\n如果你有数千万数亿以上的行数要做扫描性汇聚，又是跑在机械盘，索引又没有优化，那么有可能是分钟级的聚合计算性能。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573889309,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1103776,"avatar":"https://static001.geekbang.org/account/avatar/00/10/d7/a0/15c82d8b.jpg","nickname":"Triton","note":"","ucode":"B6C7C2AEF2B649","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":76467,"discussion_content":"请问老师所说都微分片是如何实施的？能否指点一二 非常感谢！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1575818200,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1159196,"avatar":"https://static001.geekbang.org/account/avatar/00/11/b0/1c/2e30eeb8.jpg","nickname":"旺旺","note":"","ucode":"FE2CF90F446BFB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":52706,"discussion_content":"期待老师索引优化方面的深度讲解","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574079831,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":225562,"user_name":"***","can_delete":false,"product_type":"c3","uid":1023291,"ip_address":"","ucode":"11456AA243ECB8","user_header":"https://static001.geekbang.org/account/avatar/00/0f/9d/3b/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1591787097,"is_pvip":false,"replies":[{"id":88238,"content":"需要使用条件判断，有一点点绕:\n\ndb.test.aggregate([\n{ \n\t$group: {\n\t\t_id: &quot;$group&quot;, \n\t\tsuccess:  { $sum:  \n\t\t\t\t\t\t{ \n\t\t\t\t\t\t\t$cond: { if: { $eq: [ &quot;$status&quot;, &quot;SUCCESS&quot; ] }, then: 1, else: 0 }\n\t\t\t\t\t\t}   \n\t\t},\n\t\tfailure: { $sum:  \n\t\t\t\t\t\t{ \n\t\t\t\t\t\t\t$cond: { if: { $eq: [ &quot;$status&quot;, &quot;FAILURE&quot; ] }, then: 1, else: 0 }\n\t\t\t\t\t\t}   \n\t\t}\n\t}\n}\n])\n","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1596359776,"ip_address":"","comment_id":225562,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"你好老师，我在做聚合练习的时候，有一个问题需要请教你。\n我的文档结构是这样的：\n[\n  {\n    &quot;group&quot;:&quot;A&quot;,\n    &quot;status&quot;:&quot;SUCCESS&quot;\n  }\n  {\n    &quot;group&quot;:&quot;A&quot;,\n    &quot;status&quot;:&quot;SUCCESS&quot;\n  },\n  {\n    &quot;group&quot;:&quot;A&quot;,\n    &quot;status&quot;:&quot;FAILURE&quot;\n  },\n  {\n    &quot;group&quot;:&quot;B&quot;,\n    &quot;status&quot;:&quot;SUCCESS&quot;\n  }\n  {\n    &quot;group&quot;:&quot;B&quot;,\n    &quot;status&quot;:&quot;FAILURE&quot;\n  }\n]\n聚合期望结果\n[{\n\tgroup:&quot;A&quot;,\n\tSUCCESS:3\n\tFAILURE:1\n},\n{\n\tgroup:&quot;B&quot;,\n\tSUCCESS:1,\n\tFAILURE:1\n}\n]\n我现在只能到这种程度:\n{$group: {\n _id: &quot;$group&quot;, \n result: {$push:{&quot;res&quot;:&quot;$status&quot;}}\n}}\n还请老师指教。","like_count":2,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":497897,"discussion_content":"需要使用条件判断，有一点点绕:\n\ndb.test.aggregate([\n{ \n\t$group: {\n\t\t_id: &amp;quot;$group&amp;quot;, \n\t\tsuccess:  { $sum:  \n\t\t\t\t\t\t{ \n\t\t\t\t\t\t\t$cond: { if: { $eq: [ &amp;quot;$status&amp;quot;, &amp;quot;SUCCESS&amp;quot; ] }, then: 1, else: 0 }\n\t\t\t\t\t\t}   \n\t\t},\n\t\tfailure: { $sum:  \n\t\t\t\t\t\t{ \n\t\t\t\t\t\t\t$cond: { if: { $eq: [ &amp;quot;$status&amp;quot;, &amp;quot;FAILURE&amp;quot; ] }, then: 1, else: 0 }\n\t\t\t\t\t\t}   \n\t\t}\n\t}\n}\n])\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596359776,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1023291,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/9d/3b/abb7bfe3.jpg","nickname":"***","note":"","ucode":"11456AA243ECB8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":300442,"discussion_content":"谢谢老师 ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598104629,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":156693,"user_name":"袭","can_delete":false,"product_type":"c3","uid":1077573,"ip_address":"","ucode":"D5B8609CDFB145","user_header":"https://static001.geekbang.org/account/avatar/00/10/71/45/126cd913.jpg","comment_is_top":false,"comment_ctime":1574936446,"is_pvip":false,"replies":[{"id":60147,"content":"MongoDB里面貌似实现不了这么高级的计算，可能只能拉到内存里。这么大的量的话，要用到spark来做并发计算然后再把结果写回去mongodb。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1574943597,"ip_address":"","comment_id":156693,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师请问下，如果我有若干年的毫秒级的价格数据，我想对每条数据增加一个字段，字段内容为当前时间到接下来1000毫秒之间的数据的价格字段的最大值，怎么实习呢？","like_count":2,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":476201,"discussion_content":"MongoDB里面貌似实现不了这么高级的计算，可能只能拉到内存里。这么大的量的话，要用到spark来做并发计算然后再把结果写回去mongodb。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574943597,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1077573,"avatar":"https://static001.geekbang.org/account/avatar/00/10/71/45/126cd913.jpg","nickname":"袭","note":"","ucode":"D5B8609CDFB145","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":65482,"discussion_content":"“拉到内存”这个操作怎么进行呢？是说用spark连接mongodb，进行计算，然后再执行update吗？ 这个和在shell里做一个find然后foreach里面做个1000毫秒的聚合再update那一条记录，性能上会更快吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1575005278,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":153918,"user_name":"齐宝金","can_delete":false,"product_type":"c3","uid":1305074,"ip_address":"","ucode":"F783442C82FCC2","user_header":"https://static001.geekbang.org/account/avatar/00/13/e9/f2/9067371a.jpg","comment_is_top":false,"comment_ctime":1574330136,"is_pvip":false,"replies":[{"id":59390,"content":"&gt; Timestamp(1574326231, 1).getTime()\n157432623\n\n","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1574520135,"ip_address":"","comment_id":153918,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师好，请问下对于：\nrs1:PRIMARY&gt;  db.oplog.rs.findOne().ts\nTimestamp(1574326231, 1)\n\n执行db.oplog.rs.findOne().ts 时，返回值是Timestamp(1574326231, 1)。而我的需求是指获取1574326231，如果想获取1574326231值，有现成的函数吗，还是自己解析","like_count":2,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":475322,"discussion_content":"&amp;gt; Timestamp(1574326231, 1).getTime()\n157432623\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574520135,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1305074,"avatar":"https://static001.geekbang.org/account/avatar/00/13/e9/f2/9067371a.jpg","nickname":"齐宝金","note":"","ucode":"F783442C82FCC2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":219929,"discussion_content":"老师好，咨询一个问题，副本集时，应用连接的是主库，我认为下线主，从新选择主的时候，原来连接旧主的应用回终端吗，还是会像redis一样，可以管道到新的主，应用不会有中断的问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585825654,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1305074,"avatar":"https://static001.geekbang.org/account/avatar/00/13/e9/f2/9067371a.jpg","nickname":"齐宝金","note":"","ucode":"F783442C82FCC2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":60797,"discussion_content":"谢谢老师","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574755807,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":162154,"user_name":"YoKate","can_delete":false,"product_type":"c3","uid":1204743,"ip_address":"","ucode":"1D65BC35057F89","user_header":"https://static001.geekbang.org/account/avatar/00/12/62/07/953d0f7f.jpg","comment_is_top":false,"comment_ctime":1576467730,"is_pvip":false,"replies":[{"id":61726,"content":"这么没信心。。。\n\n如果计算的结果太大， 超过16MB，或者需要在内存进行排序或其他计算的时候超过100MB，聚合操作会失败。通常的做法是避免对非索引字段进行排序，或者使用allowDiskUse选项来突破100MB的限制。\n\n另外，考虑在从节点上进行这样的聚合操作。否则会影响其他的数据库操作业务。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1576479428,"ip_address":"","comment_id":162154,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"我的数据库某张表有2.2M的数据，我需要从这些数据里面计算出想要的数据，比如某个产品的销售额度。这个用聚合会把数据库查崩么》","like_count":1,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":477971,"discussion_content":"这么没信心。。。\n\n如果计算的结果太大， 超过16MB，或者需要在内存进行排序或其他计算的时候超过100MB，聚合操作会失败。通常的做法是避免对非索引字段进行排序，或者使用allowDiskUse选项来突破100MB的限制。\n\n另外，考虑在从节点上进行这样的聚合操作。否则会影响其他的数据库操作业务。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576479428,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":157321,"user_name":"袭","can_delete":false,"product_type":"c3","uid":1077573,"ip_address":"","ucode":"D5B8609CDFB145","user_header":"https://static001.geekbang.org/account/avatar/00/10/71/45/126cd913.jpg","comment_is_top":false,"comment_ctime":1575109181,"is_pvip":false,"replies":[{"id":60811,"content":"这个是MongoDB的物理限制，目前除了分文档之外没有别的解决方案。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1575503088,"ip_address":"","comment_id":157321,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"做聚合查询，希望把多个文档的同一字段合并在一起，这样使用第三方工具（matlab）读取时速度会明显加快，聚合过程中出现了BufBuilder attempted to grow() to 67108868 bytes, past the 64MB limit.&#39; 在网上查了下说是mongodb单个文档的大小限制。一般遇到这个问题该这么处理呢？感觉分成多个文档虽然可行但违背想方便的读取数据这个使用初衷了呢","like_count":1,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":476395,"discussion_content":"这个是MongoDB的物理限制，目前除了分文档之外没有别的解决方案。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1575503088,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":152743,"user_name":"Calvin","can_delete":false,"product_type":"c3","uid":1007793,"ip_address":"","ucode":"3A0F93F3FAD76C","user_header":"https://static001.geekbang.org/account/avatar/00/0f/60/b1/0cd5929d.jpg","comment_is_top":false,"comment_ctime":1574073965,"is_pvip":false,"replies":[{"id":58802,"content":"你先说说看为什么B+树更合理，我在回复你 ;-)","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1574143169,"ip_address":"","comment_id":152743,"utype":1}],"discussion_count":3,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"TJ大，能说下Mongo的存储引擎索引是采用B+树还是B-树存储的吗？ 网上一般都是说B-树 也有一哥们儿说问过WireTiger的作者是B+树 个人觉得B+树更合理些 如果真的是B-树 能否给解释下why呢？ 感谢","like_count":1,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":474923,"discussion_content":"你先说说看为什么B+树更合理，我在回复你 ;-)","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574143169,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1007793,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/60/b1/0cd5929d.jpg","nickname":"Calvin","note":"","ucode":"3A0F93F3FAD76C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":53278,"discussion_content":"B+树非根节点不存储具体数据 一页能存储更多的索引内容 减少读磁盘IO的次数","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1574153510,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1305074,"avatar":"https://static001.geekbang.org/account/avatar/00/13/e9/f2/9067371a.jpg","nickname":"齐宝金","note":"","ucode":"F783442C82FCC2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":53043,"discussion_content":"有同样的问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574127054,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":152215,"user_name":"确认过眼神","can_delete":false,"product_type":"c3","uid":1245530,"ip_address":"","ucode":"E6D73A9D27A279","user_header":"https://static001.geekbang.org/account/avatar/00/13/01/5a/f7c989e4.jpg","comment_is_top":false,"comment_ctime":1573916982,"is_pvip":false,"replies":[{"id":59027,"content":"视频课程提供课件，其他更多的内容可以去到docs.mongodb.com 上面有很详尽的参考。如果对某些地方不是很理解可以提问。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1574296133,"ip_address":"","comment_id":152215,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"老师，每周更新三节吗？一共多少节？配那本教材一起看会更全面一些？","like_count":1,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":474752,"discussion_content":"视频课程提供课件，其他更多的内容可以去到docs.mongodb.com 上面有很详尽的参考。如果对某些地方不是很理解可以提问。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574296133,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":152157,"user_name":"吴志刚","can_delete":false,"product_type":"c3","uid":1617003,"ip_address":"","ucode":"235EC700D44FAA","user_header":"https://static001.geekbang.org/account/avatar/00/18/ac/6b/6b07c5c6.jpg","comment_is_top":false,"comment_ctime":1573894566,"is_pvip":false,"replies":[{"id":58495,"content":"mongodb在大部分场景是是和mysql可以互换的，作为一个应用的后台数据库的时候。两者更多是使用习惯上的区别。一个是基于大家比较熟悉的常规的SQL，另一个是基于比较非常规的JSON API。做的事情都是增删改查。效率上如果同样不做任何优化的话，MongoDB一般来说会有更高的并发执行能力。原因一个是\b基于内存的\b数据更新+异步落盘，另一个是采用的MVCC 乐观锁。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1573899731,"ip_address":"","comment_id":152157,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"请问mongdb的使用场景，能否替代mysql，在新增，更新，删除，查询操作上与mysql的效率有什么不一样","like_count":1,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":474734,"discussion_content":"mongodb在大部分场景是是和mysql可以互换的，作为一个应用的后台数据库的时候。两者更多是使用习惯上的区别。一个是基于大家比较熟悉的常规的SQL，另一个是基于比较非常规的JSON API。做的事情都是增删改查。效率上如果同样不做任何优化的话，MongoDB一般来说会有更高的并发执行能力。原因一个是\b基于内存的\b数据更新+异步落盘，另一个是采用的MVCC 乐观锁。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573899731,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":151151,"user_name":"vachel","can_delete":false,"product_type":"c3","uid":1216450,"ip_address":"","ucode":"1F91DB68DA8C37","user_header":"https://static001.geekbang.org/account/avatar/00/12/8f/c2/e07b4540.jpg","comment_is_top":false,"comment_ctime":1573658609,"is_pvip":false,"replies":[{"id":67862,"content":"这个比较难回答。我上次做过一次为客户调优的时候有大概5000万笔资料，优化后大概10几秒钟左右算出结果。但是如果用不到索引（比如说全表扫描），那个就基本依赖存储性能了。几分钟都有可能。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1580280517,"ip_address":"","comment_id":151151,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"老师，感谢精彩的课程！请问一下聚合的性能情况 ，可否可以结合您的业务场景以及数据量说明下？","like_count":1,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":474382,"discussion_content":"这个比较难回答。我上次做过一次为客户调优的时候有大概5000万笔资料，优化后大概10几秒钟左右算出结果。但是如果用不到索引（比如说全表扫描），那个就基本依赖存储性能了。几分钟都有可能。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580280517,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":234871,"user_name":"polk","can_delete":false,"product_type":"c3","uid":1165455,"ip_address":"","ucode":"1B6E948BA4DFAF","user_header":"https://static001.geekbang.org/account/avatar/00/11/c8/8f/e13a6552.jpg","comment_is_top":false,"comment_ctime":1594816060,"is_pvip":false,"replies":[{"id":88162,"content":"谢谢鼓励！","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1596277595,"ip_address":"","comment_id":234871,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"老师的课不错，虽然只看了一点，但已经能够感受到老师讲课是完全根据自己的经验总结出的教学提纲，步步有序非常好。\n比绝大多数其他老师都讲的好","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":501533,"discussion_content":"谢谢鼓励！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596277595,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":213995,"user_name":"苗","can_delete":false,"product_type":"c3","uid":1088710,"ip_address":"","ucode":"5ECCC6C855E541","user_header":"https://static001.geekbang.org/account/avatar/00/10/9c/c6/05a6798f.jpg","comment_is_top":false,"comment_ctime":1588611129,"is_pvip":false,"replies":[{"id":88233,"content":"官网例子是查询数组元素。和orderDate的查询不太一样。orderDate查询只会返回介于2019-01-01 到 2019-04-01之间的数据。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1596357904,"ip_address":"","comment_id":213995,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"老师，我看官网的例子，orderDate:{$gte:ISODate(&quot;2019-01-01&quot;),$lt:ISODate(&quot;2019-04-01&quot;)},这种写法会匹配，订单时间大于2019-01-01的或者小于2019-04-01的或者在2019-01-01至2019-04-01之间的；不知道我理解的对不对；\n以下是官网的例子：Query an Array with Compound Filter Conditions on the Array Elements\nThe following example queries for documents where the dim_cm array contains elements that in some combination satisfy the query conditions; e.g., one element can satisfy the greater than 15 condition and another element can satisfy the less than 20 condition, or a single element can satisfy both:\n\ndb.inventory.find( { dim_cm: { $gt: 15, $lt: 20 } } )","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493924,"discussion_content":"官网例子是查询数组元素。和orderDate的查询不太一样。orderDate查询只会返回介于2019-01-01 到 2019-04-01之间的数据。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596357904,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":207899,"user_name":"Geek_211581","can_delete":false,"product_type":"c3","uid":1802944,"ip_address":"","ucode":"533309FFF88A6D","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJbQozibFs5h4H3om60yzI7Cb2kxic6tK6r2jMEoqeYH57o06cHWcsXBT9Eian0EaibIhyrUzJ5zKPCqQ/132","comment_is_top":false,"comment_ctime":1587211099,"is_pvip":false,"replies":[{"id":78491,"content":"&gt; db.m_online_adopt.find()\n{ &quot;_id&quot; : ObjectId(&quot;5ea51ffe805b704d632a9de3&quot;), &quot;out_id&quot; : 123456, &quot;user_id&quot; : 1, &quot;val&quot; : &quot;xxx&quot; }\n{ &quot;_id&quot; : ObjectId(&quot;5ea52006805b704d632a9de4&quot;), &quot;out_id&quot; : 123456, &quot;user_id&quot; : 1, &quot;val&quot; : &quot;xxy&quot; }\n{ &quot;_id&quot; : ObjectId(&quot;5ea52008805b704d632a9de5&quot;), &quot;out_id&quot; : 123456, &quot;user_id&quot; : 1, &quot;val&quot; : &quot;xxz&quot; }\n{ &quot;_id&quot; : ObjectId(&quot;5ea5201b805b704d632a9de6&quot;), &quot;out_id&quot; : 123457, &quot;user_id&quot; : 1, &quot;val&quot; : &quot;xxz&quot; }\n{ &quot;_id&quot; : ObjectId(&quot;5ea52022805b704d632a9de7&quot;), &quot;out_id&quot; : 123456, &quot;user_id&quot; : 2, &quot;val&quot; : &quot;xxz&quot; }\n{ &quot;_id&quot; : ObjectId(&quot;5ea52026805b704d632a9de8&quot;), &quot;out_id&quot; : 123456, &quot;user_id&quot; : 2, &quot;val&quot; : &quot;xxy&quot; }\n\n&gt; db.m_online_adopt.aggregate([ {$group:{_id: &quot;$out_id&quot;, user_ids: {$addToSet: &quot;$user_id&quot;}  }}, {$project:{ _id:0, out_id: &quot;$_id&quot;, num: {$size:&quot;$user_ids&quot;} }} ])\n{ &quot;out_id&quot; : 123457, &quot;num&quot; : 1 }\n{ &quot;out_id&quot; : 123456, &quot;num&quot; : 2 }\n&gt; \n","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1587880554,"ip_address":"","comment_id":207899,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"老师好，同学们好，我现在有个统计的问题。类似Mysql的语句\nSELECT out_id,COUNT(DISTINCT user_id) as `num` FROM m_online_adopt WHERE out_id = 1238479531665264640  GROUP BY out_id\n对应的mongo的聚合操作，还没有理清实现出来结果。\n主要目的是，对于user_id进行去重后，统计结果，并返回统计结果和另外的一个字段。","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492275,"discussion_content":"&amp;gt; db.m_online_adopt.find()\n{ &amp;quot;_id&amp;quot; : ObjectId(&amp;quot;5ea51ffe805b704d632a9de3&amp;quot;), &amp;quot;out_id&amp;quot; : 123456, &amp;quot;user_id&amp;quot; : 1, &amp;quot;val&amp;quot; : &amp;quot;xxx&amp;quot; }\n{ &amp;quot;_id&amp;quot; : ObjectId(&amp;quot;5ea52006805b704d632a9de4&amp;quot;), &amp;quot;out_id&amp;quot; : 123456, &amp;quot;user_id&amp;quot; : 1, &amp;quot;val&amp;quot; : &amp;quot;xxy&amp;quot; }\n{ &amp;quot;_id&amp;quot; : ObjectId(&amp;quot;5ea52008805b704d632a9de5&amp;quot;), &amp;quot;out_id&amp;quot; : 123456, &amp;quot;user_id&amp;quot; : 1, &amp;quot;val&amp;quot; : &amp;quot;xxz&amp;quot; }\n{ &amp;quot;_id&amp;quot; : ObjectId(&amp;quot;5ea5201b805b704d632a9de6&amp;quot;), &amp;quot;out_id&amp;quot; : 123457, &amp;quot;user_id&amp;quot; : 1, &amp;quot;val&amp;quot; : &amp;quot;xxz&amp;quot; }\n{ &amp;quot;_id&amp;quot; : ObjectId(&amp;quot;5ea52022805b704d632a9de7&amp;quot;), &amp;quot;out_id&amp;quot; : 123456, &amp;quot;user_id&amp;quot; : 2, &amp;quot;val&amp;quot; : &amp;quot;xxz&amp;quot; }\n{ &amp;quot;_id&amp;quot; : ObjectId(&amp;quot;5ea52026805b704d632a9de8&amp;quot;), &amp;quot;out_id&amp;quot; : 123456, &amp;quot;user_id&amp;quot; : 2, &amp;quot;val&amp;quot; : &amp;quot;xxy&amp;quot; }\n\n&amp;gt; db.m_online_adopt.aggregate([ {$group:{_id: &amp;quot;$out_id&amp;quot;, user_ids: {$addToSet: &amp;quot;$user_id&amp;quot;}  }}, {$project:{ _id:0, out_id: &amp;quot;$_id&amp;quot;, num: {$size:&amp;quot;$user_ids&amp;quot;} }} ])\n{ &amp;quot;out_id&amp;quot; : 123457, &amp;quot;num&amp;quot; : 1 }\n{ &amp;quot;out_id&amp;quot; : 123456, &amp;quot;num&amp;quot; : 2 }\n&amp;gt; \n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587880554,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":201749,"user_name":"稻草人","can_delete":false,"product_type":"c3","uid":1636197,"ip_address":"","ucode":"7671CFDCD55252","user_header":"https://static001.geekbang.org/account/avatar/00/18/f7/65/d3cc6be8.jpg","comment_is_top":false,"comment_ctime":1585832478,"is_pvip":false,"replies":[{"id":75799,"content":"“我文档里有字段是集合” - 这里表述有歧义。你说的集合是什么？给个样例。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1586080790,"ip_address":"","comment_id":201749,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"老师，我文档里有字段是集合，怎么针对该集合进行group，并将结果写入新字段","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":490410,"discussion_content":"“我文档里有字段是集合” - 这里表述有歧义。你说的集合是什么？给个样例。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586080790,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":184533,"user_name":"扬一场远远的风","can_delete":false,"product_type":"c3","uid":1357801,"ip_address":"","ucode":"AB47E3D2EAB8A8","user_header":"https://static001.geekbang.org/account/avatar/00/14/b7/e9/5400cdf3.jpg","comment_is_top":false,"comment_ctime":1583334075,"is_pvip":false,"replies":[{"id":72152,"content":"是的 - 这个和关系型数据库类似。建议在从节点上使用，如果不能建合适索引的话","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1584004108,"ip_address":"","comment_id":184533,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"mongo聚合查询，如果聚合字段没有索引，碰盘使用率很容易就达到100%","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":486047,"discussion_content":"是的 - 这个和关系型数据库类似。建议在从节点上使用，如果不能建合适索引的话","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584004108,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":167551,"user_name":"cording","can_delete":false,"product_type":"c3","uid":1786385,"ip_address":"","ucode":"82063AEC231613","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKlllSKrpQkhSXyNj0glDoCiaMKp23ey4Fw0nr54MKKhYAIxxU7toQuukJe2qZjwUC990ojdNmeicVQ/132","comment_is_top":false,"comment_ctime":1577856981,"is_pvip":false,"replies":[{"id":65191,"content":"你描述的是比较经典的Mongo +  ES组合，很多人这么用，没毛病。 #3 效率问题不大，就是对于分片可能支持不好。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1577967067,"ip_address":"","comment_id":167551,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"老师好，用mongo像这种场景如何处理好：用户需要按照商品的特有属性进行高级查询，比如：根据相机的规格、像素，这些事先不确定的字段查询相机列表，并分页。字段不确定是因为用户需要能自定义查询字段。我的问题是：\n1，这种场景是否只能用搜索引擎如es或solr解决？\n2，写入时mongo通过mongo connector实时同步数据到es，查询时用搜索引擎查询出mongo中ID集合，根据ID从mongo中获取数据，可行吗？\n3，mongo connector实时同步效率如何？我们一个文档100个字段，容量8k。","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":479898,"discussion_content":"你描述的是比较经典的Mongo +  ES组合，很多人这么用，没毛病。 #3 效率问题不大，就是对于分片可能支持不好。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577967067,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":158641,"user_name":"风中花","can_delete":false,"product_type":"c3","uid":1085237,"ip_address":"","ucode":"067E0A1E116844","user_header":"https://static001.geekbang.org/account/avatar/00/10/8f/35/f1839bb2.jpg","comment_is_top":false,"comment_ctime":1575426022,"is_pvip":false,"replies":[{"id":60809,"content":"可能需要看你的数据，及实际的输出。这个条件看上去没什么问题","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1575501715,"ip_address":"","comment_id":158641,"utype":1}],"discussion_count":1,"race_medal":0,"score":4,"product_id":100040001,"comment_content":"{\n        &quot;InputTime&quot;:{\n        $gte:ISODate(&quot;2019-11-30&quot;),\n     $lte:ISODate(&#39;2019-12-05&#39;)\n        }\n}\n\n老师好，在compass 里面match 执行脚本查不出数据。我把脚本放到robo 执行可以查到数据。\n\n请老师解惑，目前不知道什么原因？","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":476791,"discussion_content":"可能需要看你的数据，及实际的输出。这个条件看上去没什么问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1575501715,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":154961,"user_name":"Julien","can_delete":false,"product_type":"c3","uid":1204568,"ip_address":"","ucode":"2A3F0CF46B4034","user_header":"https://static001.geekbang.org/account/avatar/00/12/61/58/7b078879.jpg","comment_is_top":false,"comment_ctime":1574605657,"is_pvip":false,"replies":[{"id":59923,"content":"目前还不支持","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1574813106,"ip_address":"","comment_id":154961,"utype":1}],"discussion_count":1,"race_medal":0,"score":4,"product_id":100040001,"comment_content":"compass的export to language 没有C++吗？","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":475624,"discussion_content":"目前还不支持","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574813106,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":153944,"user_name":"忘记、时间","can_delete":false,"product_type":"c3","uid":1035340,"ip_address":"","ucode":"E7B665969582DF","user_header":"https://static001.geekbang.org/account/avatar/00/0f/cc/4c/587417db.jpg","comment_is_top":false,"comment_ctime":1574334771,"is_pvip":false,"replies":[{"id":59389,"content":"这个需要你提供具体的查询语句。可以加上explain，如：\n\ndb.orders.explain().aggregate( [...])\n\n然后看看是什么样的慢\n","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1574520114,"ip_address":"","comment_id":153944,"utype":1}],"discussion_count":2,"race_medal":0,"score":4,"product_id":100040001,"comment_content":"老师，我们因为业务需要，需要关键查询，聚合查询的时候，lookup后非常慢，这个有什么办法解决么？","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":475333,"discussion_content":"这个需要你提供具体的查询语句。可以加上explain，如：\n\ndb.orders.explain().aggregate( [...])\n\n然后看看是什么样的慢\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574520114,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1035340,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/cc/4c/587417db.jpg","nickname":"忘记、时间","note":"","ucode":"E7B665969582DF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":55947,"discussion_content":"聚合的时候，尽量将lookup放到最后，这样能快不少;再就是，有些查询需要分页（先用时间段过滤），排序很慢，这个索引怎么创建比较好？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574416081,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":153774,"user_name":"奔奔奔跑","can_delete":false,"product_type":"c3","uid":1210265,"ip_address":"","ucode":"F86EC205DCAACE","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Gswh7ibY4tubXhp0BXOmV2pXZ3XsXic1d942ZMAEgWrRSF99bDskOTsG1g172ibORXxSCWTn9HWUX5vSSUVWU5I4A/132","comment_is_top":false,"comment_ctime":1574305357,"is_pvip":false,"replies":[{"id":59393,"content":"你在你的find 里面加上同样的sort试试。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1574520676,"ip_address":"","comment_id":153774,"utype":1}],"discussion_count":4,"race_medal":0,"score":4,"product_id":100040001,"comment_content":"老师您好，我正在用mongodb,但是使用过程中发现了一个很奇怪的问题，我把查询语句贴上来。\ndb.rooms.find({&quot;staffid&quot;: ObjectId(&quot;5d37b78d864a61330babd2c5&quot;), &quot;status&quot;: &quot;离线&quot; })可以命中索引，返回文档1570\ndb.rooms.aggregate({ $match: { &quot;staffid&quot;: ObjectId(&quot;5d37b78d864a61330babd2c5&quot;), &quot;status&quot;: &quot;离线&quot; } },\n\t    { $sort: { &quot;createat&quot;: -1 } },\n\t    { $skip: 10 },\n\t    { $limit: 30 },\n命中索引，但是却是全表（24万）扫描了。这是为什么呢，find和aggregate的match不一样吗？","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":475268,"discussion_content":"你在你的find 里面加上同样的sort试试。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574520676,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1187892,"avatar":"https://static001.geekbang.org/account/avatar/00/12/20/34/31bff3e9.jpg","nickname":"似水","note":"","ucode":"771BF594C9D6AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":328973,"discussion_content":"aggregate 的参数不应该是数组吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606289886,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1210265,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Gswh7ibY4tubXhp0BXOmV2pXZ3XsXic1d942ZMAEgWrRSF99bDskOTsG1g172ibORXxSCWTn9HWUX5vSSUVWU5I4A/132","nickname":"奔奔奔跑","note":"","ucode":"F86EC205DCAACE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":54780,"discussion_content":"老师，我又来了，我发现explain放的位置不同，结果也不同。db.rooms.explain(&#34;executionStats&#34;).aggregate([])，这个用了索引，而且actual query execution time 只有42ms。\ndb.rooms.aggregate([]).explain(&#34;executionStats&#34;)这个的话完全没有结果","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574313970,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1210265,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Gswh7ibY4tubXhp0BXOmV2pXZ3XsXic1d942ZMAEgWrRSF99bDskOTsG1g172ibORXxSCWTn9HWUX5vSSUVWU5I4A/132","nickname":"奔奔奔跑","note":"","ucode":"F86EC205DCAACE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":54637,"discussion_content":"老师，我又试了一下，发现match根本找不到数据，返回0，同样的find又可以，这个好奇怪啊，老师您知道这是为什么吗？可不可以给我解答一下，感激","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574306816,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":153351,"user_name":"肖大保健","can_delete":false,"product_type":"c3","uid":1306868,"ip_address":"","ucode":"E3209A00C1B954","user_header":"https://static001.geekbang.org/account/avatar/00/13/f0/f4/22dbe2d9.jpg","comment_is_top":false,"comment_ctime":1574221060,"is_pvip":false,"replies":[{"id":59397,"content":"假设数据模型是：\n\n```javascript\ndb.testData.insertMany([{\n    areaCode: &quot;Shanghai&quot;,\n    sales: 100\n}, {\n    areaCode: &quot;Beijing&quot;,\n    sales: 120\n}, {\n    areaCode: &quot;Shenzhen&quot;,\n    sales: 130\n}, {\n    areaCode: &quot;Shenzhen&quot;,\n    sales: 120\n}, {\n    areaCode: &quot;Shenzhen&quot;,\n    sales: 100\n}, {\n    areaCode: &quot;Beijing&quot;,\n    sales: 100\n}]);\n```\n\n要计算每个地区的top1，需要将数据按照地区和销量排序，然后取每个分组（即每个地区）的`$first`：\n\n```javascript\ndb.testData.aggregate([{\n    $sort: {\n        areaCode: 1,\n        sales: -1\n    }\n}, {\n    $group: {\n        _id: &quot;$areaCode&quot;,\n        topSales: {\n            $first: &quot;$sales&quot;\n        }\n    }\n}]);\n```\n\n参考：\n\n- `$first`: https:&#47;&#47;docs.mongodb.com&#47;manual&#47;reference&#47;operator&#47;aggregation&#47;first&#47;\n- `$group`: https:&#47;&#47;docs.mongodb.com&#47;manual&#47;reference&#47;operator&#47;aggregation&#47;group&#47;\n","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1574521506,"ip_address":"","comment_id":153351,"utype":1}],"discussion_count":1,"race_medal":0,"score":4,"product_id":100040001,"comment_content":"老师 \n实验四：地区销量top1\n这个例子 如果我只取每个区域sku销量最大的那个返回该怎么写","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":475132,"discussion_content":"假设数据模型是：\n\n```javascript\ndb.testData.insertMany([{\n    areaCode: &amp;quot;Shanghai&amp;quot;,\n    sales: 100\n}, {\n    areaCode: &amp;quot;Beijing&amp;quot;,\n    sales: 120\n}, {\n    areaCode: &amp;quot;Shenzhen&amp;quot;,\n    sales: 130\n}, {\n    areaCode: &amp;quot;Shenzhen&amp;quot;,\n    sales: 120\n}, {\n    areaCode: &amp;quot;Shenzhen&amp;quot;,\n    sales: 100\n}, {\n    areaCode: &amp;quot;Beijing&amp;quot;,\n    sales: 100\n}]);\n```\n\n要计算每个地区的top1，需要将数据按照地区和销量排序，然后取每个分组（即每个地区）的`$first`：\n\n```javascript\ndb.testData.aggregate([{\n    $sort: {\n        areaCode: 1,\n        sales: -1\n    }\n}, {\n    $group: {\n        _id: &amp;quot;$areaCode&amp;quot;,\n        topSales: {\n            $first: &amp;quot;$sales&amp;quot;\n        }\n    }\n}]);\n```\n\n参考：\n\n- `$first`: https://docs.mongodb.com/manual/reference/operator/aggregation/first/\n- `$group`: https://docs.mongodb.com/manual/reference/operator/aggregation/group/\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574521506,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":153166,"user_name":"nkulpj","can_delete":false,"product_type":"c3","uid":1242666,"ip_address":"","ucode":"734AE87E009B9C","user_header":"https://static001.geekbang.org/account/avatar/00/12/f6/2a/b21a78d6.jpg","comment_is_top":false,"comment_ctime":1574173121,"is_pvip":false,"replies":[{"id":59037,"content":"没太看懂，用例子试下？","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1574298006,"ip_address":"","comment_id":153166,"utype":1}],"discussion_count":2,"race_medal":0,"score":4,"product_id":100040001,"comment_content":"怎么按某个字段值相同进行分类，对同一类按另一个字段值求和呢？","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":475068,"discussion_content":"没太看懂，用例子试下？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574298006,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1242666,"avatar":"https://static001.geekbang.org/account/avatar/00/12/f6/2a/b21a78d6.jpg","nickname":"nkulpj","note":"","ucode":"734AE87E009B9C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":54628,"discussion_content":"{&#34;set&#34;:1,&#34;total&#34;:1}就是类似这样的文档，相同的set，total累加！我查了一下，已经写完了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574305864,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":151105,"user_name":"旺旺","can_delete":false,"product_type":"c3","uid":1159196,"ip_address":"","ucode":"FE2CF90F446BFB","user_header":"https://static001.geekbang.org/account/avatar/00/11/b0/1c/2e30eeb8.jpg","comment_is_top":false,"comment_ctime":1573654124,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100040001,"comment_content":"一口气刷到这里，老师讲的清晰明了，听的很过瘾！","like_count":9},{"had_liked":false,"id":235100,"user_name":"奕","can_delete":false,"product_type":"c3","uid":1005391,"ip_address":"","ucode":"73CEA468CE70C3","user_header":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","comment_is_top":false,"comment_ctime":1594891182,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100040001,"comment_content":"对于 聚合 Mongo Compass 是怎么分析它的执行计划呢？ 我看 Explain Plan 没有分析 aggregate 的地方","like_count":1},{"had_liked":false,"id":151357,"user_name":"fedwing","can_delete":false,"product_type":"c3","uid":1743661,"ip_address":"","ucode":"2DFF902FD190C7","user_header":"https://static001.geekbang.org/account/avatar/00/1a/9b/2d/f7fca208.jpg","comment_is_top":false,"comment_ctime":1573705957,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100040001,"comment_content":"一口气把所有视频看完了，意犹未尽，期待老师的新视频","like_count":1},{"had_liked":false,"id":358011,"user_name":"kkaaddff","can_delete":false,"product_type":"c3","uid":1621271,"ip_address":"江苏","ucode":"5E9075463E6707","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTK3dicRrv41vMfAxdlW2icmTyG3jicf5iaUTZUStUdG6bUKxK1YjIcY67ciaicCfmZ0hqJ035VBBh80N59w/132","comment_is_top":false,"comment_ctime":1663830392,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100040001,"comment_content":"老师我有个需求，不知道使用管道操作改如何处理：\n有一部分初始数据(mock 数据)\n\n```json\n[\n  {\n    &quot;key&quot;: &quot;a&quot;,\n    &quot;no&quot;: &quot;1&quot;,\n    &quot;sales&quot;: 100\n  },\n  {\n    &quot;key&quot;: &quot;b&quot;,\n    &quot;no&quot;: &quot;1&quot;,\n    &quot;sales&quot;: 120\n  },\n  {\n    &quot;key&quot;: &quot;b&quot;,\n    &quot;no&quot;: &quot;2&quot;,\n    &quot;sales&quot;: 120\n  }\n]\n```\n\n过一段时间数据整体数据更新了需要使用新的数组更新上面的数据\n其中 key 和 no 作为联合查询条件\n```json\n[\n  {\n    &quot;key&quot;: &quot;a&quot;,\n    &quot;no&quot;: &quot;1&quot;,\n    &quot;sales&quot;: 99\n  },\n  {\n    &quot;key&quot;: &quot;b&quot;,\n    &quot;no&quot;: &quot;1&quot;,\n    &quot;sales&quot;: 990\n  },\n  {\n    &quot;key&quot;: &quot;b&quot;,\n    &quot;no&quot;: &quot;2&quot;,\n    &quot;sales&quot;: 120\n  }\n]\n```","like_count":0},{"had_liked":false,"id":353599,"user_name":"固态U盘","can_delete":false,"product_type":"c3","uid":1043446,"ip_address":"上海","ucode":"9C473DA25CB4C1","user_header":"https://static001.geekbang.org/account/avatar/00/0f/eb/f6/ec7971f4.jpg","comment_is_top":false,"comment_ctime":1659595024,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":5,"product_id":100040001,"comment_content":"非常棒的课程，多谢 TJ 老师精彩的演绎。","like_count":0},{"had_liked":false,"id":308132,"user_name":"家乐","can_delete":false,"product_type":"c3","uid":1301941,"ip_address":"","ucode":"94F8720B59F221","user_header":"https://wx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEJia90ErsTQtNDNeyTWNwWjicERicXj72b4xgbvru2IkUdrLxrgJb5lCrTaiaW2iaX3mOYiaV8vYo3voWlg/132","comment_is_top":false,"comment_ctime":1629425239,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":5,"product_id":100040001,"comment_content":"老师有个问题我请教下，我导入mysql测试数据时，（已知导出的iot_command_data.txt 文件内存在某些字段值乱码问题），我在monngoimport导入时添加了忽略报错的选项，为什么还是不能继续。如下命令和输出。麻烦解答下。\n #mongoimport --drop --db iot --collection iot_command_data --type csv --parseGrace skipRow --headerline --ignoreBlanks --file &#47;tmp&#47;iot_command_data.txt \n2021-08-20T09:51:06.525+0800    connected to: mongodb:&#47;&#47;localhost&#47;\n2021-08-20T09:51:06.526+0800    dropping: iot.iot_command_data\n2021-08-20T09:51:09.526+0800    [###.....................] iot.iot_command_data 2.02MB&#47;15.9MB (12.7%)\n2021-08-20T09:51:12.526+0800    [######..................] iot.iot_command_data 4.22MB&#47;15.9MB (26.5%)\n2021-08-20T09:51:15.525+0800    [######..................] iot.iot_command_data 4.22MB&#47;15.9MB (26.5%)\n2021-08-20T09:51:18.526+0800    [######..................] iot.iot_command_data 4.53MB&#47;15.9MB (28.5%)\n2021-08-20T09:51:20.177+0800    [#######.................] iot.iot_command_data 4.79MB&#47;15.9MB (30.1%)\n2021-08-20T09:51:20.177+0800    Failed: read error on entry #47526: line 47527, column 26: extraneous &quot; in field\n2021-08-20T09:51:20.177+0800    47000 document(s) imported successfully. 0 document(s) failed to import.","like_count":0},{"had_liked":false,"id":286906,"user_name":"一介农夫","can_delete":false,"product_type":"c3","uid":1231587,"ip_address":"","ucode":"FBDEE48436A542","user_header":"https://static001.geekbang.org/account/avatar/00/12/ca/e3/7e860739.jpg","comment_is_top":false,"comment_ctime":1617676794,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":5,"product_id":100040001,"comment_content":"要是导出支持Go就好了","like_count":0},{"had_liked":false,"id":286833,"user_name":"一介农夫","can_delete":false,"product_type":"c3","uid":1231587,"ip_address":"","ucode":"FBDEE48436A542","user_header":"https://static001.geekbang.org/account/avatar/00/12/ca/e3/7e860739.jpg","comment_is_top":false,"comment_ctime":1617621287,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":5,"product_id":100040001,"comment_content":"```\ndb.orders.aggregate([\n    {\n        $group:\n        {\n            _id: null,\n            total: {$sum: &quot;$total&quot;}\n        }\n    }\n])\n```\n奇怪了，在我的设备上total一直输出的是0","like_count":0,"discussions":[{"author":{"id":1231587,"avatar":"https://static001.geekbang.org/account/avatar/00/12/ca/e3/7e860739.jpg","nickname":"一介农夫","note":"","ucode":"FBDEE48436A542","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":364976,"discussion_content":"已查明原因为，字段类型不为数字类型导致","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617674690,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":286819,"user_name":"一介农夫","can_delete":false,"product_type":"c3","uid":1231587,"ip_address":"","ucode":"FBDEE48436A542","user_header":"https://static001.geekbang.org/account/avatar/00/12/ca/e3/7e860739.jpg","comment_is_top":false,"comment_ctime":1617611442,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":5,"product_id":100040001,"comment_content":"最近也是遇到一个可能需要聚合查询的情况，因对这款数据库不太熟悉，查询条件是任意日期区间内某个小时后某个Id的第一条数据。\n\n结构如下:\n\n```json\n[\n  {\n    &quot;_id&quot;: {&quot;$oid&quot;: &quot;60690a7411b670749eeac48c&quot;},\n    &quot;create_time&quot;: {&quot;$date&quot;: &quot;2021-12-30T16:01:00.000Z&quot;},\n    &quot;data&quot;: {\n      &quot;temp&quot;: 47,\n      &quot;humi&quot;: 13\n    },\n    &quot;device_id&quot;: &quot;20&quot;,\n    &quot;organization_id&quot;: &quot;7&quot;,\n    &quot;update_time&quot;: {&quot;$date&quot;: &quot;2021-12-30T16:01:00.000Z&quot;},\n    &quot;uuid&quot;: &quot;c2db7184-8946-4c92-860c-fb57743e8b3b&quot;\n  }\n]\n```\n\n日期区间、device_id、时段都是输入进来的，自由性很大。\n\n大白话场景就是：查询device_id为5在2021-01-01 ～ 2021-03-31 这段日期中每天早上8点之后的第一条数据。望老师解答","like_count":0},{"had_liked":false,"id":244464,"user_name":"qihuajun","can_delete":false,"product_type":"c3","uid":1099577,"ip_address":"","ucode":"AE03D55762C564","user_header":"https://static001.geekbang.org/account/avatar/00/10/c7/39/0f98fa50.jpg","comment_is_top":false,"comment_ctime":1598526548,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":5,"product_id":100040001,"comment_content":"mongo聚合效率跟clickhouse对比怎么样呢？","like_count":0},{"had_liked":false,"id":164628,"user_name":"浓烈","can_delete":false,"product_type":"c3","uid":1242783,"ip_address":"","ucode":"7BA598467BFD62","user_header":"https://static001.geekbang.org/account/avatar/00/12/f6/9f/87d7d25b.jpg","comment_is_top":false,"comment_ctime":1577063160,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":5,"product_id":100040001,"comment_content":"老师，怎么按照时间间隔查询数据呢？现在我们用mongodb存储的物联网数据，数据量大，数据之间的时间间隔不确定，有可能1秒1条，有可能3秒1条。假如现在有1千万条这样的数据，怎么按照1分钟的时间间隔快速查询？查询出来的数据间的时间间隔大约为1分钟就行。现在工作中遇到这个问题，页面需要按自定义的时间间隔展示这些数据，不知道有没有比较好的解决方案","like_count":0},{"had_liked":false,"id":156222,"user_name":"蓝魔丶","can_delete":false,"product_type":"c3","uid":1219438,"ip_address":"","ucode":"2AE4359E263558","user_header":"https://static001.geekbang.org/account/avatar/00/12/9b/6e/edd2da0c.jpg","comment_is_top":false,"comment_ctime":1574838998,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":5,"product_id":100040001,"comment_content":"老师有一个现在遇到的业务场景问题：同步的气象数据中有个data字段是二维数组地理坐标位置，比如：data [[101,23][102,32]],有另外一个geo多边形表示范围，判断现在data中哪些数据在多边形范围之内，我也看了mongodb对于geo索引查询的支持，比如：\nvar poly1=db.storePolygon.findOne();\ndb.storePoint.find({ &quot;location&quot; : {     &quot;$geoWithin&quot; : {         &quot;$geometry&quot; : poly1.geometry1     } } })\n这样的形式要求storePoint集合的每条数据都是单个坐标点，无法适配气象数据data字段包含所有点的情况，请问要怎么编写才合理？","like_count":0},{"had_liked":false,"id":152389,"user_name":"zenk","can_delete":false,"product_type":"c3","uid":1013669,"ip_address":"","ucode":"B235D5EBCF49BC","user_header":"https://static001.geekbang.org/account/avatar/00/0f/77/a5/c5ae871d.jpg","comment_is_top":false,"comment_ctime":1573989470,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":5,"product_id":100040001,"comment_content":"求更新。。。","like_count":0},{"had_liked":false,"id":152105,"user_name":"走小調的凡世林","can_delete":false,"product_type":"c3","uid":1011453,"ip_address":"","ucode":"EF3E5195D56188","user_header":"https://static001.geekbang.org/account/avatar/00/0f/6e/fd/6d0109c0.jpg","comment_is_top":false,"comment_ctime":1573878773,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":5,"product_id":100040001,"comment_content":"很实用！","like_count":0},{"had_liked":false,"id":151381,"user_name":"Middleware","can_delete":false,"product_type":"c3","uid":1072015,"ip_address":"","ucode":"C0028293ECDD47","user_header":"https://static001.geekbang.org/account/avatar/00/10/5b/8f/4b0ab5db.jpg","comment_is_top":false,"comment_ctime":1573710540,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":6,"product_id":100040001,"comment_content":"给力，手动点赞","like_count":0}]}