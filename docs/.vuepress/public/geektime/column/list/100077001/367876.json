{"id":367876,"title":"04ï½œSpring Bean ç”Ÿå‘½å‘¨æœŸå¸¸è§é”™è¯¯","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å‚…å¥ï¼Œè¿™èŠ‚è¯¾æˆ‘ä»¬æ¥èŠä¸€èŠ Spring Bean çš„åˆå§‹åŒ–è¿‡ç¨‹åŠé”€æ¯è¿‡ç¨‹ä¸­çš„ä¸€äº›é—®é¢˜ã€‚</p><p>è™½ç„¶è¯´ Spring å®¹å™¨ä¸Šæ‰‹ç®€å•ï¼Œå¯ä»¥ä»…ä»…é€šè¿‡å­¦ä¹ ä¸€äº›æœ‰é™çš„æ³¨è§£ï¼Œå³å¯è¾¾åˆ°å¿«é€Ÿä½¿ç”¨çš„ç›®çš„ã€‚ä½†åœ¨å·¥ç¨‹å®è·µä¸­ï¼Œæˆ‘ä»¬ä¾ç„¶ä¼šä»ä¸­å‘ç°ä¸€äº›å¸¸è§çš„é”™è¯¯ã€‚å°¤å…¶å½“ä½ å¯¹ Spring çš„ç”Ÿå‘½å‘¨æœŸè¿˜æ²¡æœ‰æ·±å…¥äº†è§£æ—¶ï¼Œç±»åˆå§‹åŒ–åŠé”€æ¯è¿‡ç¨‹ä¸­æ½œåœ¨çš„çº¦å®šå°±ä¸ä¼šå¾ˆæ¸…æ¥šã€‚</p><p>è¿™ä¼šå¯¼è‡´è¿™æ ·ä¸€äº›çŠ¶å†µå‘ç”Ÿï¼šæœ‰äº›é”™è¯¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ Spring çš„å¼‚å¸¸æç¤ºä¸‹å¿«é€Ÿè§£å†³ï¼Œä½†å´ä¸ç†è§£èƒŒåçš„åŸç†ï¼›è€Œå¦ä¸€äº›é”™è¯¯ï¼Œå¹¶ä¸å®¹æ˜“åœ¨å¼€å‘ç¯å¢ƒä¸‹è¢«å‘ç°ï¼Œä»è€Œåœ¨äº§çº¿ä¸Šé€ æˆè¾ƒä¸ºä¸¥é‡çš„åæœã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±å…·ä½“è§£æä¸‹è¿™äº›å¸¸è§æ¡ˆä¾‹åŠå…¶èƒŒåçš„åŸç†ã€‚</p><h2>æ¡ˆä¾‹ 1ï¼šæ„é€ å™¨å†…æŠ›ç©ºæŒ‡é’ˆå¼‚å¸¸</h2><p>å…ˆçœ‹ä¸ªä¾‹å­ã€‚åœ¨æ„å»ºå®¿èˆç®¡ç†ç³»ç»Ÿæ—¶ï¼Œæœ‰ LightMgrService æ¥ç®¡ç† LightServiceï¼Œä»è€Œæ§åˆ¶å®¿èˆç¯çš„å¼€å¯å’Œå…³é—­ã€‚æˆ‘ä»¬å¸Œæœ›åœ¨ LightMgrService åˆå§‹åŒ–æ—¶èƒ½å¤Ÿè‡ªåŠ¨è°ƒç”¨ LightService çš„ check æ–¹æ³•æ¥æ£€æŸ¥æ‰€æœ‰å®¿èˆç¯çš„ç”µè·¯æ˜¯å¦æ­£å¸¸ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre><code>import org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.stereotype.Component;\n@Component\npublic class LightMgrService {\n  @Autowired\n  private LightService lightService;\n  public LightMgrService() {\n    lightService.check();\n  }\n}\n</code></pre><p>æˆ‘ä»¬åœ¨ LightMgrService çš„é»˜è®¤æ„é€ å™¨ä¸­è°ƒç”¨äº†é€šè¿‡ @Autoware æ³¨å…¥çš„æˆå‘˜å˜é‡ LightService çš„ check æ–¹æ³•ï¼š</p><!-- [[[read_end]]] --><pre><code>@Service\npublic class LightService {\n    public void start() {\n        System.out.println(&quot;turn on all lights&quot;);\n    }\n    public void shutdown() {\n        System.out.println(&quot;turn off all lights&quot;);\n    }\n    public void check() {\n        System.out.println(&quot;check all lights&quot;);\n    }\n}\n</code></pre><p>ä»¥ä¸Šä»£ç å®šä¹‰äº† LightService å¯¹è±¡çš„åŸå§‹ç±»ã€‚</p><p>ä»æ•´ä¸ªæ¡ˆä¾‹ä»£ç å®ç°æ¥çœ‹ï¼Œæˆ‘ä»¬çš„æœŸå¾…æ˜¯åœ¨ LightMgrService åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼ŒLightService å› ä¸ºæ ‡è®°ä¸º @Autowiredï¼Œæ‰€ä»¥èƒ½è¢«è‡ªåŠ¨è£…é…å¥½ï¼›ç„¶ååœ¨ LightMgrService çš„æ„é€ å™¨æ‰§è¡Œä¸­ï¼ŒLightService çš„ shutdown() æ–¹æ³•èƒ½è¢«è‡ªåŠ¨è°ƒç”¨ï¼›æœ€ç»ˆæ‰“å°å‡º check all lightsã€‚</p><p>ç„¶è€Œäº‹ä¸æ„¿è¿ï¼Œæˆ‘ä»¬å¾—åˆ°çš„åªä¼šæ˜¯ NullPointerExceptionï¼Œé”™è¯¯ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/4d/4e/4d4cecc9c82abaaa4f04cdb274c05e4e.png?wh=1589*293\" alt=\"\"></p><p>è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p><h3>æ¡ˆä¾‹è§£æ</h3><p>æ˜¾ç„¶è¿™æ˜¯æ–°æ‰‹æœ€å¸¸çŠ¯çš„é”™è¯¯ï¼Œä½†æ˜¯é—®é¢˜çš„æ ¹æºï¼Œæ˜¯æˆ‘ä»¬<strong>å¯¹Springç±»åˆå§‹åŒ–è¿‡ç¨‹æ²¡æœ‰è¶³å¤Ÿçš„äº†è§£</strong>ã€‚ä¸‹é¢è¿™å¼ æ—¶åºå›¾æè¿°äº† Spring å¯åŠ¨æ—¶çš„ä¸€äº›å…³é”®ç»“ç‚¹ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/6f/8a/6ff70ab627711065bc17c54c001ef08a.png?wh=3321*1068\" alt=\"\"></p><p>è¿™ä¸ªå›¾åˆçœ‹èµ·æ¥å¤æ‚ï¼Œæˆ‘ä»¬ä¸å¦¨å°†å…¶åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š</p><ul>\n<li>ç¬¬ä¸€éƒ¨åˆ†ï¼Œå°†ä¸€äº›å¿…è¦çš„ç³»ç»Ÿç±»ï¼Œæ¯”å¦‚ Bean çš„åç½®å¤„ç†å™¨ç±»ï¼Œæ³¨å†Œåˆ° Spring å®¹å™¨ï¼Œå…¶ä¸­å°±åŒ…æ‹¬æˆ‘ä»¬è¿™èŠ‚è¯¾å…³æ³¨çš„ CommonAnnotationBeanPostProcessor ç±»ï¼›</li>\n<li>ç¬¬äºŒéƒ¨åˆ†ï¼Œå°†è¿™äº›åç½®å¤„ç†å™¨å®ä¾‹åŒ–ï¼Œå¹¶æ³¨å†Œåˆ° Spring çš„å®¹å™¨ä¸­ï¼›</li>\n<li>ç¬¬ä¸‰éƒ¨åˆ†ï¼Œå®ä¾‹åŒ–æ‰€æœ‰ç”¨æˆ·å®šåˆ¶ç±»ï¼Œè°ƒç”¨åç½®å¤„ç†å™¨è¿›è¡Œè¾…åŠ©è£…é…ã€ç±»åˆå§‹åŒ–ç­‰ç­‰ã€‚</li>\n</ul><p>ç¬¬ä¸€éƒ¨åˆ†å’Œç¬¬äºŒéƒ¨åˆ†å¹¶éæ˜¯æˆ‘ä»¬ä»Šå¤©è¦è®¨è®ºçš„é‡ç‚¹ï¼Œè¿™é‡Œä»…ä»…æ˜¯ä¸ºäº†è®©ä½ çŸ¥é“ CommonAnnotationBeanPostProcessor  è¿™ä¸ªåç½®å¤„ç†ç±»æ˜¯ä½•æ—¶è¢« Spring åŠ è½½å’Œå®ä¾‹åŒ–çš„ã€‚</p><p><strong>è¿™é‡Œæˆ‘é¡ºä¾¿ç»™ä½ æ‹“å±•ä¸¤ä¸ªçŸ¥è¯†ç‚¹ï¼š</strong></p><ol>\n<li>å¾ˆå¤šå¿…è¦çš„ç³»ç»Ÿç±»ï¼Œå°¤å…¶æ˜¯ Bean åç½®å¤„ç†å™¨ï¼ˆæ¯”å¦‚CommonAnnotationBeanPostProcessorã€AutowiredAnnotationBeanPostProcessor ç­‰ï¼‰ï¼Œéƒ½æ˜¯è¢« Spring ç»Ÿä¸€åŠ è½½å’Œç®¡ç†çš„ï¼Œå¹¶åœ¨ Spring ä¸­æ‰®æ¼”äº†éå¸¸é‡è¦çš„è§’è‰²ï¼›</li>\n<li>é€šè¿‡ Bean åç½®å¤„ç†å™¨ï¼ŒSpring èƒ½å¤Ÿéå¸¸çµæ´»åœ°åœ¨ä¸åŒçš„åœºæ™¯è°ƒç”¨ä¸åŒçš„åç½®å¤„ç†å™¨ï¼Œæ¯”å¦‚æ¥ä¸‹æ¥æˆ‘ä¼šè®²åˆ°ç¤ºä¾‹é—®é¢˜å¦‚ä½•ä¿®æ­£ï¼Œä¿®æ­£æ–¹æ¡ˆä¸­æåˆ°çš„ PostConstruct æ³¨è§£ï¼Œå®ƒçš„å¤„ç†é€»è¾‘å°±éœ€è¦ç”¨åˆ° CommonAnnotationBeanPostProcessorï¼ˆç»§æ‰¿è‡ª InitDestroyAnnotationBeanPostProcessorï¼‰è¿™ä¸ªåç½®å¤„ç†å™¨ã€‚</li>\n</ol><p>ç°åœ¨æˆ‘ä»¬é‡ç‚¹çœ‹ä¸‹ç¬¬ä¸‰éƒ¨åˆ†ï¼Œå³ Spring åˆå§‹åŒ–å•ä¾‹ç±»çš„ä¸€èˆ¬è¿‡ç¨‹ï¼ŒåŸºæœ¬éƒ½æ˜¯ getBean()-&gt;doGetBean()-&gt;getSingleton()ï¼Œå¦‚æœå‘ç° Bean ä¸å­˜åœ¨ï¼Œåˆ™è°ƒç”¨ createBean()-&gt;doCreateBean() è¿›è¡Œå®ä¾‹åŒ–ã€‚</p><p>æŸ¥çœ‹ doCreateBean() çš„æºä»£ç å¦‚ä¸‹ï¼š</p><pre><code>protected Object doCreateBean(final String beanName, final RootBeanDefinition mbd, final @Nullable Object[] args)\n\t\tthrows BeanCreationException {\n    //çœç•¥éå…³é”®ä»£ç \n\tif (instanceWrapper == null) {\n\t\tinstanceWrapper = createBeanInstance(beanName, mbd, args);\n\t}\n\tfinal Object bean = instanceWrapper.getWrappedInstance();\n\n    //çœç•¥éå…³é”®ä»£ç \n    Object exposedObject = bean;\n    try {\n       populateBean(beanName, mbd, instanceWrapper);\n       exposedObject = initializeBean(beanName, exposedObject, mbd);\n    }\n    catch (Throwable ex) {\n    //çœç•¥éå…³é”®ä»£ç \n}\n</code></pre><p>ä¸Šè¿°ä»£ç å®Œæ•´åœ°å±•ç¤ºäº† Bean åˆå§‹åŒ–çš„ä¸‰ä¸ªå…³é”®æ­¥éª¤ï¼ŒæŒ‰æ‰§è¡Œé¡ºåºåˆ†åˆ«æ˜¯ç¬¬ 5 è¡Œçš„ createBeanInstanceï¼Œç¬¬ 12 è¡Œçš„ populateBeanï¼Œä»¥åŠç¬¬ 13 è¡Œçš„ initializeBeanï¼Œåˆ†åˆ«å¯¹åº”å®ä¾‹åŒ– Beanï¼Œæ³¨å…¥ Bean ä¾èµ–ï¼Œä»¥åŠåˆå§‹åŒ– Bean ï¼ˆä¾‹å¦‚æ‰§è¡Œ @PostConstruct æ ‡è®°çš„æ–¹æ³• ï¼‰è¿™ä¸‰ä¸ªåŠŸèƒ½ï¼Œè¿™ä¹Ÿå’Œä¸Šè¿°æ—¶åºå›¾çš„æµç¨‹ç›¸ç¬¦ã€‚</p><p>è€Œç”¨æ¥å®ä¾‹åŒ– Bean çš„ createBeanInstance æ–¹æ³•é€šè¿‡ä¾æ¬¡è°ƒç”¨DefaultListableBeanFactory.instantiateBean() &gt;SimpleInstantiationStrategy.instantiate()ï¼Œæœ€ç»ˆæ‰§è¡Œåˆ° BeanUtils.instantiateClass()ï¼Œå…¶ä»£ç å¦‚ä¸‹ï¼š</p><pre><code>public static &lt;T&gt; T instantiateClass(Constructor&lt;T&gt; ctor, Object... args) throws BeanInstantiationException {\n   Assert.notNull(ctor, &quot;Constructor must not be null&quot;);\n   try {\n      ReflectionUtils.makeAccessible(ctor);\n      return (KotlinDetector.isKotlinReflectPresent() &amp;&amp; KotlinDetector.isKotlinType(ctor.getDeclaringClass()) ?\n            KotlinDelegate.instantiateClass(ctor, args) : ctor.newInstance(args));\n   }\n   catch (InstantiationException ex) {\n      throw new BeanInstantiationException(ctor, &quot;Is it an abstract class?&quot;, ex);\n   }\n   //çœç•¥éå…³é”®ä»£ç \n}\n\n</code></pre><p>è¿™é‡Œå› ä¸ºå½“å‰çš„è¯­è¨€å¹¶é Kotlinï¼Œæ‰€ä»¥æœ€ç»ˆå°†è°ƒç”¨ ctor.newInstance() æ–¹æ³•å®ä¾‹åŒ–ç”¨æˆ·å®šåˆ¶ç±» LightMgrServiceï¼Œè€Œé»˜è®¤æ„é€ å™¨æ˜¾ç„¶æ˜¯åœ¨ç±»å®ä¾‹åŒ–çš„æ—¶å€™è¢«è‡ªåŠ¨è°ƒç”¨çš„ï¼ŒSpring ä¹Ÿæ— æ³•æ§åˆ¶ã€‚è€Œæ­¤æ—¶è´Ÿè´£è‡ªåŠ¨è£…é…çš„ populateBean æ–¹æ³•è¿˜æ²¡æœ‰è¢«æ‰§è¡Œï¼ŒLightMgrService çš„å±æ€§  LightService è¿˜æ˜¯ nullï¼Œå› è€Œå¾—åˆ°ç©ºæŒ‡é’ˆå¼‚å¸¸ä¹Ÿåœ¨æƒ…ç†ä¹‹ä¸­ã€‚</p><h3>é—®é¢˜ä¿®æ­£</h3><p>é€šè¿‡æºç åˆ†æï¼Œç°åœ¨æˆ‘ä»¬çŸ¥é“äº†é—®é¢˜çš„æ ¹æºï¼Œå°±æ˜¯åœ¨äº<strong>ä½¿ç”¨ @Autowired ç›´æ¥æ ‡è®°åœ¨æˆå‘˜å±æ€§ä¸Šè€Œå¼•å‘çš„è£…é…è¡Œä¸ºæ˜¯å‘ç”Ÿåœ¨æ„é€ å™¨æ‰§è¡Œä¹‹åçš„</strong>ã€‚æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢è¿™ç§ä¿®è®¢æ–¹æ³•æ¥çº æ­£è¿™ä¸ªé—®é¢˜ï¼š</p><pre><code>@Component\npublic class LightMgrService {\n\n    private LightService lightService;\n\n    public LightMgrService(LightService lightService) {\n        this.lightService = lightService;\n        lightService.check();\n    }\n}\n</code></pre><p>åœ¨<a href=\"https://time.geekbang.org/column/article/366170\">ç¬¬02è¯¾</a>çš„æ¡ˆä¾‹ 2 ä¸­ï¼Œæˆ‘ä»¬å°±æåˆ°äº†æ„é€ å™¨å‚æ•°çš„éšå¼æ³¨å…¥ã€‚å½“ä½¿ç”¨ä¸Šé¢çš„ä»£ç æ—¶ï¼Œæ„é€ å™¨å‚æ•° LightService ä¼šè¢«è‡ªåŠ¨æ³¨å…¥LightService çš„ Beanï¼Œä»è€Œåœ¨æ„é€ å™¨æ‰§è¡Œæ—¶ï¼Œä¸ä¼šå‡ºç°ç©ºæŒ‡é’ˆã€‚å¯ä»¥è¯´ï¼Œ<strong>ä½¿ç”¨æ„é€ å™¨å‚æ•°æ¥éšå¼æ³¨å…¥æ˜¯ä¸€ç§ Spring æœ€ä½³å®è·µ</strong>ï¼Œå› ä¸ºå®ƒæˆåŠŸåœ°è§„é¿äº†æ¡ˆä¾‹1ä¸­çš„é—®é¢˜ã€‚</p><p>å¦å¤–ï¼Œé™¤äº†è¿™ç§çº æ­£æ–¹å¼ï¼Œæœ‰æ²¡æœ‰åˆ«çš„æ–¹å¼ï¼Ÿ</p><p>å®é™…ä¸Šï¼ŒSpring åœ¨ç±»å±æ€§å®Œæˆæ³¨å…¥ä¹‹åï¼Œä¼šå›è°ƒç”¨æˆ·å®šåˆ¶çš„åˆå§‹åŒ–æ–¹æ³•ã€‚å³åœ¨ populateBean æ–¹æ³•ä¹‹åï¼Œä¼šè°ƒç”¨ initializeBean æ–¹æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®ƒçš„å…³é”®ä»£ç ï¼š</p><pre><code>protected Object initializeBean(final String beanName, final Object bean, @Nullable RootBeanDefinition mbd) {\n   //çœç•¥éå…³é”®ä»£ç  \n   if (mbd == null || !mbd.isSynthetic()) {\n      wrappedBean = applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName);\n   }\n   try {\n      invokeInitMethods(beanName, wrappedBean, mbd);\n   }\n   //çœç•¥éå…³é”®ä»£ç  \n}\n</code></pre><p>è¿™é‡Œä½ å¯ä»¥çœ‹åˆ° applyBeanPostProcessorsBeforeInitialization å’Œ invokeInitMethods è¿™ä¸¤ä¸ªå…³é”®æ–¹æ³•çš„æ‰§è¡Œï¼Œå®ƒä»¬åˆ†åˆ«å¤„ç†äº† @PostConstruct æ³¨è§£å’Œ InitializingBean æ¥å£è¿™ä¸¤ç§ä¸åŒçš„åˆå§‹åŒ–æ–¹æ¡ˆçš„é€»è¾‘ã€‚è¿™é‡Œæˆ‘å†è¯¦ç»†åœ°ç»™ä½ è®²è®²ã€‚</p><p><strong>1. applyBeanPostProcessorsBeforeInitialization ä¸@PostConstruct</strong></p><p>applyBeanPostProcessorsBeforeInitialization  æ–¹æ³•æœ€ç»ˆæ‰§è¡Œåˆ°åç½®å¤„ç†å™¨  InitDestroyAnnotationBeanPostProcessor  çš„  buildLifecycleMetadata  æ–¹æ³•ï¼ˆCommonAnnotationBeanPostProcessor  çš„çˆ¶ç±»ï¼‰ï¼š</p><pre><code>private LifecycleMetadata buildLifecycleMetadata(final Class&lt;?&gt; clazz) {\n   //çœç•¥éå…³é”®ä»£ç  \n   do {\n      //çœç•¥éå…³é”®ä»£ç \n      final List&lt;LifecycleElement&gt; currDestroyMethods = new ArrayList&lt;&gt;();\n      ReflectionUtils.doWithLocalMethods(targetClass, method -&gt; {\n      //æ­¤å¤„çš„ this.initAnnotationType å€¼ï¼Œå³ä¸º PostConstruct.class\n         if (this.initAnnotationType != null &amp;&amp; method.isAnnotationPresent(this.initAnnotationType)) {\n            LifecycleElement element = new LifecycleElement(method);\n            currInitMethods.add(element);\n  //éå…³é”®ä»£ç           \n}\n</code></pre><p>åœ¨è¿™ä¸ªæ–¹æ³•é‡Œï¼ŒSpring å°†éå†æŸ¥æ‰¾è¢« PostConstruct.class æ³¨è§£è¿‡çš„æ–¹æ³•ï¼Œè¿”å›åˆ°ä¸Šå±‚ï¼Œå¹¶æœ€ç»ˆè°ƒç”¨æ­¤æ–¹æ³•ã€‚</p><p><strong>2. invokeInitMethods ä¸ InitializingBean æ¥å£</strong></p><p>invokeInitMethods æ–¹æ³•ä¼šåˆ¤æ–­å½“å‰ Bean æ˜¯å¦å®ç°äº† InitializingBean æ¥å£ï¼Œåªæœ‰åœ¨å®ç°äº†è¯¥æ¥å£çš„æƒ…å†µä¸‹ï¼ŒSpring æ‰ä¼šè°ƒç”¨è¯¥ Bean çš„æ¥å£å®ç°æ–¹æ³• afterPropertiesSet()ã€‚</p><pre><code>protected void invokeInitMethods(String beanName, final Object bean, @Nullable RootBeanDefinition mbd)\n      throws Throwable {\n   boolean isInitializingBean = (bean instanceof InitializingBean);\n   if (isInitializingBean &amp;&amp; (mbd == null || !mbd.isExternallyManagedInitMethod(&quot;afterPropertiesSet&quot;))) {\n      // çœç•¥éå…³é”®ä»£ç  \n      else {\n         ((InitializingBean) bean).afterPropertiesSet();\n      }\n   }\n   // çœç•¥éå…³é”®ä»£ç  \n }\n</code></pre><p>å­¦åˆ°æ­¤å¤„ï¼Œç­”æ¡ˆä¹Ÿå°±å‘¼ä¹‹æ¬²å‡ºäº†ã€‚æˆ‘ä»¬è¿˜æœ‰ä¸¤ç§æ–¹å¼å¯ä»¥è§£å†³æ­¤é—®é¢˜ã€‚</p><ol>\n<li>æ·»åŠ  init æ–¹æ³•ï¼Œå¹¶ä¸”ä½¿ç”¨ PostConstruct æ³¨è§£è¿›è¡Œä¿®é¥°ï¼š</li>\n</ol><pre><code>import org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.stereotype.Component;\n@Component\npublic class LightMgrService {\n  @Autowired\n  private LightService lightService;\n  \n  @PostConstruct\n  public void init() {\n       lightService.check();\n  }\n}\n</code></pre><ol start=\"2\">\n<li>å®ç° InitializingBean æ¥å£ï¼Œåœ¨å…¶ afterPropertiesSet() æ–¹æ³•ä¸­æ‰§è¡Œåˆå§‹åŒ–ä»£ç ï¼š</li>\n</ol><pre><code>import org.springframework.beans.factory.InitializingBean;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.stereotype.Component;\n@Component\npublic class LightMgrService implements InitializingBean {\n    @Autowired\n    private LightService lightService;\n  \n    @Override\n    public void afterPropertiesSet() throws Exception {\n        lightService.check();\n    }\n}\n</code></pre><p>å¯¹æ¯”æœ€å¼€å§‹æå‡ºçš„è§£å†³æ–¹æ¡ˆï¼Œå¾ˆæ˜æ˜¾ï¼Œé’ˆå¯¹æœ¬æ¡ˆä¾‹è€Œè¨€ï¼Œåç»­çš„ä¸¤ç§æ–¹æ¡ˆå¹¶ä¸æ˜¯æœ€ä¼˜çš„ã€‚ä½†æ˜¯åœ¨ä¸€äº›åœºæ™¯ä¸‹ï¼Œè¿™ä¸¤ç§æ–¹æ¡ˆå„æœ‰æ‰€é•¿ï¼Œä¸ç„¶ Spring ä¸ºä»€ä¹ˆè¦æä¾›è¿™ä¸ªåŠŸèƒ½å‘¢ï¼Ÿå¯¹å§ï¼</p><h2>æ¡ˆä¾‹ 2ï¼šæ„å¤–è§¦å‘ shutdown æ–¹æ³•</h2><p>ä¸Šè¿°å®ä¾‹æˆ‘ç»™ä½ è®²è§£äº†ç±»åˆå§‹åŒ–æ—¶æœ€å®¹æ˜“é‡åˆ°çš„é—®é¢˜ï¼ŒåŒæ ·ï¼Œåœ¨ç±»é”€æ¯æ—¶ï¼Œä¹Ÿä¼šæœ‰ä¸€äº›ç›¸å¯¹éšè”½çš„çº¦å®šï¼Œå¯¼è‡´ä¸€äº›éš¾ä»¥å¯Ÿè§‰çš„é”™è¯¯ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸ªæ¡ˆä¾‹ï¼Œè¿˜æ˜¯æ²¿ç”¨ä¹‹å‰çš„åœºæ™¯ã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç®€å•å¤ä¹ ä¸€ä¸‹LightService çš„å®ç°ï¼Œå®ƒåŒ…å«äº† shutdown æ–¹æ³•ï¼Œè´Ÿè´£å…³é—­æ‰€æœ‰çš„ç¯ï¼Œå…³é”®ä»£ç å¦‚ä¸‹ï¼š</p><pre><code>import org.springframework.stereotype.Service;\n@Service\npublic class LightService {\n  //çœç•¥å…¶ä»–éå…³é”®ä»£ç \n  public void shutdown(){\n    System.out.println(&quot;shutting down all lights&quot;);\n  }\n  //çœç•¥å…¶ä»–éå…³é”®ä»£ç \n}\n</code></pre><p>åœ¨ä¹‹å‰çš„æ¡ˆä¾‹ä¸­ï¼Œå¦‚æœæˆ‘ä»¬çš„å®¿èˆç®¡ç†ç³»ç»Ÿåœ¨é‡å¯æ—¶ï¼Œç¯æ˜¯ä¸ä¼šè¢«å…³é—­çš„ã€‚ä½†æ˜¯éšç€ä¸šåŠ¡çš„éœ€æ±‚å˜åŒ–ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå»æ‰ @Service æ³¨è§£ï¼Œè€Œæ˜¯ä½¿ç”¨å¦å¤–ä¸€ç§äº§ç”Ÿ Bean çš„æ–¹å¼ï¼šåˆ›å»ºä¸€ä¸ªé…ç½®ç±» BeanConfigurationï¼ˆæ ‡è®°  @Configurationï¼‰æ¥åˆ›å»ºä¸€å † Beanï¼Œå…¶ä¸­å°±åŒ…å«äº†åˆ›å»º LightService ç±»å‹çš„ Beanï¼Œå¹¶å°†å…¶æ³¨å†Œåˆ° Spring å®¹å™¨ï¼š</p><pre><code>import org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\n@Configuration\npublic class BeanConfiguration {\n    @Bean\n    public LightService getTransmission(){\n        return new LightService();\n    }\n}\n</code></pre><p>å¤ç”¨æ¡ˆä¾‹ 1 çš„å¯åŠ¨ç¨‹åºï¼Œç¨ä½œä¿®æ”¹ï¼Œè®© Spring å¯åŠ¨å®Œæˆåç«‹é©¬å…³é—­å½“å‰ Spring ä¸Šä¸‹æ–‡ã€‚è¿™æ ·ç­‰åŒäºæ¨¡æ‹Ÿå®¿èˆç®¡ç†ç³»ç»Ÿçš„å¯åœï¼š</p><pre><code>@SpringBootApplication\npublic class Application {\n    public static void main(String[] args) {\n        ConfigurableApplicationContext context = SpringApplication.run(Application.class, args);\n        context.close();\n    }\n}\n</code></pre><p>ä»¥ä¸Šä»£ç æ²¡æœ‰å…¶ä»–ä»»ä½•æ–¹æ³•çš„è°ƒç”¨ï¼Œä»…ä»…æ˜¯å°†æ‰€æœ‰ç¬¦åˆçº¦å®šçš„ç±»åˆå§‹åŒ–å¹¶åŠ è½½åˆ° Spring å®¹å™¨ï¼Œå®Œæˆåå†å…³é—­å½“å‰çš„ Spring å®¹å™¨ã€‚æŒ‰ç…§é¢„æœŸï¼Œè¿™æ®µä»£ç è¿è¡Œåä¸ä¼šæœ‰ä»»ä½•çš„ log è¾“å‡ºï¼Œæ¯•ç«Ÿæˆ‘ä»¬åªæ˜¯æ”¹å˜äº† Bean çš„äº§ç”Ÿæ–¹å¼ã€‚</p><p>ä½†å®é™…è¿è¡Œè¿™æ®µä»£ç åï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ§åˆ¶å°ä¸Šæ‰“å°äº† shutting down all lightsã€‚æ˜¾ç„¶ shutdown æ–¹æ³•æœªæŒ‰ç…§é¢„æœŸè¢«æ‰§è¡Œäº†ï¼Œè¿™å¯¼è‡´ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„ bugï¼šåœ¨ä½¿ç”¨æ–°çš„ Bean ç”Ÿæˆæ–¹å¼ä¹‹å‰ï¼Œæ¯ä¸€æ¬¡å®¿èˆç®¡ç†æœåŠ¡è¢«é‡å¯æ—¶ï¼Œå®¿èˆé‡Œæ‰€æœ‰çš„ç¯éƒ½ä¸ä¼šè¢«å…³é—­ã€‚ä½†æ˜¯ä¿®æ”¹åï¼Œåªæœ‰æœåŠ¡é‡å¯ï¼Œç¯éƒ½è¢«æ„å¤–å…³é—­äº†ã€‚å¦‚ä½•ç†è§£è¿™ä¸ª bug?</p><h3>æ¡ˆä¾‹è§£æ</h3><p>é€šè¿‡è°ƒè¯•ï¼Œæˆ‘ä»¬å‘ç°åªæœ‰é€šè¿‡ä½¿ç”¨ Bean æ³¨è§£æ³¨å†Œåˆ° Spring å®¹å™¨çš„å¯¹è±¡ï¼Œæ‰ä¼šåœ¨ Spring å®¹å™¨è¢«å…³é—­çš„æ—¶å€™è‡ªåŠ¨è°ƒç”¨ shutdown æ–¹æ³•ï¼Œè€Œä½¿ç”¨ @Componentï¼ˆService ä¹Ÿæ˜¯ä¸€ç§ Componentï¼‰å°†å½“å‰ç±»è‡ªåŠ¨æ³¨å…¥åˆ° Spring å®¹å™¨æ—¶ï¼Œshutdown æ–¹æ³•åˆ™ä¸ä¼šè¢«è‡ªåŠ¨æ‰§è¡Œã€‚</p><p>æˆ‘ä»¬å¯ä»¥å°è¯•åˆ° Bean æ³¨è§£ç±»çš„ä»£ç ä¸­å»å¯»æ‰¾ä¸€äº›çº¿ç´¢ï¼Œå¯ä»¥çœ‹åˆ°å±æ€§ destroyMethod æœ‰éå¸¸å¤§æ®µçš„æ³¨é‡Šï¼ŒåŸºæœ¬ä¸Šè§£ç­”äº†æˆ‘ä»¬å¯¹äºè¿™ä¸ªé—®é¢˜çš„å¤§éƒ¨åˆ†ç–‘æƒ‘ã€‚</p><p>ä½¿ç”¨ Bean æ³¨è§£çš„æ–¹æ³•æ‰€æ³¨å†Œçš„ Bean å¯¹è±¡ï¼Œå¦‚æœç”¨æˆ·ä¸è®¾ç½® destroyMethod å±æ€§ï¼Œåˆ™å…¶å±æ€§å€¼ä¸º AbstractBeanDefinition.INFER_METHODã€‚æ­¤æ—¶ Spring ä¼šæ£€æŸ¥å½“å‰ Bean å¯¹è±¡çš„åŸå§‹ç±»ä¸­æ˜¯å¦æœ‰åä¸º shutdown æˆ–è€… close çš„æ–¹æ³•ï¼Œå¦‚æœæœ‰ï¼Œæ­¤æ–¹æ³•ä¼šè¢« Spring è®°å½•ä¸‹æ¥ï¼Œå¹¶åœ¨å®¹å™¨è¢«é”€æ¯æ—¶è‡ªåŠ¨æ‰§è¡Œï¼›å½“ç„¶å¦‚è‹¥æ²¡æœ‰ï¼Œé‚£ä¹ˆè‡ªç„¶ä»€ä¹ˆéƒ½ä¸ä¼šå‘ç”Ÿã€‚</p><p>ä¸‹é¢æˆ‘ä»¬ç»§ç»­æŸ¥çœ‹ Spring çš„æºä»£ç æ¥è¿›ä¸€æ­¥åˆ†ææ­¤é—®é¢˜ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬å¯ä»¥æŸ¥æ‰¾ INFER_METHOD æšä¸¾å€¼çš„å¼•ç”¨ï¼Œå¾ˆå®¹æ˜“å°±æ‰¾åˆ°äº†ä½¿ç”¨è¯¥æšä¸¾å€¼çš„æ–¹æ³• DisposableBeanAdapter#inferDestroyMethodIfNecessaryï¼š</p><pre><code>private String inferDestroyMethodIfNecessary(Object bean, RootBeanDefinition beanDefinition) {\n   String destroyMethodName = beanDefinition.getDestroyMethodName();\n   if (AbstractBeanDefinition.INFER_METHOD.equals(destroyMethodName) ||(destroyMethodName == null &amp;&amp; bean instanceof AutoCloseable)) {\n      if (!(bean instanceof DisposableBean)) {\n         try {\n            //å°è¯•æŸ¥æ‰¾ close æ–¹æ³•\n            return bean.getClass().getMethod(CLOSE_METHOD_NAME).getName();\n         }\n         catch (NoSuchMethodException ex) {\n            try {\n               //å°è¯•æŸ¥æ‰¾ shutdown æ–¹æ³•\n               return bean.getClass().getMethod(SHUTDOWN_METHOD_NAME).getName();\n            }\n            catch (NoSuchMethodException ex2) {\n               // no candidate destroy method found\n            }\n         }\n      }\n      return null;\n   }\n   return (StringUtils.hasLength(destroyMethodName) ? destroyMethodName : null);\n}\n\n</code></pre><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä»£ç é€»è¾‘å’Œ Bean æ³¨è§£ç±»ä¸­å¯¹äº destroyMethod å±æ€§çš„æ³¨é‡Šå®Œå…¨ä¸€è‡´destroyMethodName å¦‚æœç­‰äº INFER_METHODï¼Œä¸”å½“å‰ç±»æ²¡æœ‰å®ç° DisposableBean æ¥å£ï¼Œé‚£ä¹ˆé¦–å…ˆæŸ¥æ‰¾ç±»çš„ close æ–¹æ³•ï¼Œå¦‚æœæ‰¾ä¸åˆ°ï¼Œå°±åœ¨æŠ›å‡ºå¼‚å¸¸åç»§ç»­æŸ¥æ‰¾ shutdown æ–¹æ³•ï¼›å¦‚æœæ‰¾åˆ°äº†ï¼Œåˆ™è¿”å›å…¶æ–¹æ³•åï¼ˆclose æˆ–è€… shutdownï¼‰ã€‚</p><p>æ¥ç€ï¼Œç»§ç»­é€çº§æŸ¥æ‰¾å¼•ç”¨ï¼Œæœ€ç»ˆå¾—åˆ°çš„è°ƒç”¨é“¾ä»ä¸Šåˆ°ä¸‹ä¸º doCreateBean-&gt;registerDisposableBeanIfNecessary-&gt;registerDisposableBean(new DisposableBeanAdapter)-&gt;inferDestroyMethodIfNecessaryã€‚</p><p>ç„¶åï¼Œæˆ‘ä»¬è¿½æº¯åˆ°äº†é¡¶å±‚çš„ doCreateBean æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre><code>protected Object doCreateBean(final String beanName, final RootBeanDefinition mbd, final @Nullable Object[] args)\n      throws BeanCreationException {\n   //çœç•¥éå…³é”®ä»£ç  \n   if (instanceWrapper == null) {\n      instanceWrapper = createBeanInstance(beanName, mbd, args);\n   }\n   //çœç•¥éå…³é”®ä»£ç \n   // Initialize the bean instance.\n   Object exposedObject = bean;\n   try {\n      populateBean(beanName, mbd, instanceWrapper);\n      exposedObject = initializeBean(beanName, exposedObject, mbd);\n   }\n   //çœç•¥éå…³é”®ä»£ç  \n   // Register bean as disposable.\n   try {\n      registerDisposableBeanIfNecessary(beanName, bean, mbd);\n   }\n   catch (BeanDefinitionValidationException ex) {\n      throw new BeanCreationException(\n            mbd.getResourceDescription(), beanName, &quot;Invalid destruction signature&quot;, ex);\n   }\n\n   return exposedObject;\n}\n</code></pre><p>åˆ°è¿™ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¯¹ doCreateBean æ–¹æ³•åšä¸€ä¸ªå°å°çš„æ€»ç»“äº†ã€‚å¯ä»¥è¯´ <strong>doCreateBean ç®¡ç†äº†Beançš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­å‡ ä¹æ‰€æœ‰çš„å…³é”®èŠ‚ç‚¹</strong>ï¼Œç›´æ¥è´Ÿè´£äº† Bean å¯¹è±¡çš„ç”Ÿè€ç—…æ­»ï¼Œå…¶ä¸»è¦åŠŸèƒ½åŒ…æ‹¬ï¼š</p><ul>\n<li>Bean  å®ä¾‹çš„åˆ›å»ºï¼›</li>\n<li>Bean  å¯¹è±¡ä¾èµ–çš„æ³¨å…¥ï¼›</li>\n<li>å®šåˆ¶ç±»åˆå§‹åŒ–æ–¹æ³•çš„å›è°ƒï¼›</li>\n<li>Disposable  æ–¹æ³•çš„æ³¨å†Œã€‚</li>\n</ul><p>æ¥ç€ï¼Œç»§ç»­æŸ¥çœ‹ registerDisposableBean æ–¹æ³•ï¼š</p><pre><code>public void registerDisposableBean(String beanName, DisposableBean bean) {\n   //çœç•¥å…¶ä»–éå…³é”®ä»£ç \n   synchronized (this.disposableBeans) {\n      this.disposableBeans.put(beanName, bean);\n   }\n   //çœç•¥å…¶ä»–éå…³é”®ä»£ç \n}\n</code></pre><p>åœ¨ registerDisposableBean æ–¹æ³•å†…ï¼ŒDisposableBeanAdapter ç±»ï¼ˆå…¶å±æ€§destroyMethodName è®°å½•äº†ä½¿ç”¨å“ªç§ destory æ–¹æ³•ï¼‰è¢«å®ä¾‹åŒ–å¹¶æ·»åŠ åˆ° DefaultSingletonBeanRegistry#disposableBeans å±æ€§å†…ï¼ŒdisposableBeans å°†æš‚å­˜è¿™äº›  DisposableBeanAdapter å®ä¾‹ï¼Œç›´åˆ° AnnotationConfigApplicationContext çš„ close æ–¹æ³•è¢«è°ƒç”¨ã€‚</p><p>è€Œå½“ AnnotationConfigApplicationContext çš„ close æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œå³å½“ Spring å®¹å™¨è¢«é”€æ¯æ—¶ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ° DefaultSingletonBeanRegistry#destroySingletonã€‚æ­¤æ–¹æ³•å°†éå† disposableBeans å±æ€§é€ä¸€è·å– DisposableBeanï¼Œä¾æ¬¡è°ƒç”¨å…¶ä¸­çš„ close æˆ–è€… shutdown  æ–¹æ³•ï¼š</p><pre><code>public void destroySingleton(String beanName) {\n   // Remove a registered singleton of the given name, if any.\n   removeSingleton(beanName);\n   // Destroy the corresponding DisposableBean instance.\n   DisposableBean disposableBean;\n   synchronized (this.disposableBeans) {\n      disposableBean = (DisposableBean) this.disposableBeans.remove(beanName);\n   }\n   destroyBean(beanName, disposableBean);\n}\n\n</code></pre><p>å¾ˆæ˜æ˜¾ï¼Œæœ€ç»ˆæˆ‘ä»¬çš„æ¡ˆä¾‹è°ƒç”¨äº† LightService#shutdown æ–¹æ³•ï¼Œå°†æ‰€æœ‰çš„ç¯å…³é—­äº†ã€‚</p><h3>é—®é¢˜ä¿®æ­£</h3><p>ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“äº†é—®é¢˜çš„æ ¹æºï¼Œè§£å†³èµ·æ¥å°±éå¸¸ç®€å•äº†ã€‚</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡<strong>é¿å…åœ¨Javaç±»ä¸­å®šä¹‰ä¸€äº›å¸¦æœ‰ç‰¹æ®Šæ„ä¹‰åŠ¨è¯çš„æ–¹æ³•æ¥è§£å†³</strong>ï¼Œå½“ç„¶å¦‚æœä¸€å®šè¦å®šä¹‰åä¸º close æˆ–è€… shutdown æ–¹æ³•ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å°† Bean æ³¨è§£å†… destroyMethod å±æ€§è®¾ç½®ä¸ºç©ºçš„æ–¹å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><p>ç¬¬ä¸€ç§ä¿®æ”¹æ–¹å¼æ¯”è¾ƒç®€å•ï¼Œæ‰€ä»¥è¿™é‡Œåªå±•ç¤ºç¬¬äºŒç§ä¿®æ”¹æ–¹å¼ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre><code>import org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\n@Configuration\npublic class BeanConfiguration {\n    @Bean(destroyMethod=&quot;&quot;)\n    public LightService getTransmission(){\n        return new LightService();\n    }\n}\n\n</code></pre><p>å¦å¤–ï¼Œé’ˆå¯¹è¿™ä¸ªé—®é¢˜æˆ‘æƒ³å†å¤šæç¤ºä¸€ç‚¹ã€‚å¦‚æœæˆ‘ä»¬èƒ½<strong>å…»æˆè‰¯å¥½çš„ç¼–ç ä¹ æƒ¯</strong>ï¼Œåœ¨ä½¿ç”¨æŸä¸ªä¸ç†Ÿæ‚‰çš„æ³¨è§£ä¹‹å‰ï¼Œè®¤çœŸç ”è¯»ä¸€ä¸‹è¯¥æ³¨è§£çš„æ³¨é‡Šï¼Œä¹Ÿå¯ä»¥å¤§æ¦‚ç‡è§„é¿è¿™ä¸ªé—®é¢˜ã€‚</p><p>ä¸è¿‡è¯´åˆ°è¿™é‡Œï¼Œä½ ä¹Ÿå¯èƒ½è¿˜æ˜¯ä¼šç–‘æƒ‘ï¼Œä¸ºä»€ä¹ˆ @Service æ³¨å…¥çš„ LightServiceï¼Œå…¶ shutdown æ–¹æ³•ä¸èƒ½è¢«æ‰§è¡Œï¼Ÿè¿™é‡Œæˆ‘æƒ³è¡¥å……è¯´æ˜ä¸‹ã€‚</p><p>æƒ³è¦æ‰§è¡Œï¼Œåˆ™å¿…é¡»è¦æ·»åŠ  DisposableBeanAdapterï¼Œè€Œå®ƒçš„æ·»åŠ æ˜¯æœ‰æ¡ä»¶çš„ï¼š</p><pre><code>protected void registerDisposableBeanIfNecessary(String beanName, Object bean, RootBeanDefinition mbd) {\n   AccessControlContext acc = (System.getSecurityManager() != null ? getAccessControlContext() : null);\n   if (!mbd.isPrototype() &amp;&amp; requiresDestruction(bean, mbd)) {\n      if (mbd.isSingleton()) {\n         // Register a DisposableBean implementation that performs all destruction\n         // work for the given bean: DestructionAwareBeanPostProcessors,\n         // DisposableBean interface, custom destroy method.\n         registerDisposableBean(beanName,\n               new DisposableBeanAdapter(bean, beanName, mbd, getBeanPostProcessors(), acc));\n      }\n      else {\n        //çœç•¥éå…³é”®ä»£ç \n      }\n   }\n}\n</code></pre><p>å‚è€ƒä¸Šè¿°ä»£ç ï¼Œå…³é”®çš„è¯­å¥åœ¨äºï¼š</p><blockquote>\n<p>!mbd.isPrototype() &amp;&amp; requiresDestruction(bean, mbd)</p>\n</blockquote><p>å¾ˆæ˜æ˜¾ï¼Œåœ¨æ¡ˆä¾‹ä»£ç ä¿®æ”¹å‰åï¼Œæˆ‘ä»¬éƒ½æ˜¯å•ä¾‹ï¼Œæ‰€ä»¥åŒºåˆ«ä»…åœ¨äºæ˜¯å¦æ»¡è¶³requiresDestruction æ¡ä»¶ã€‚ç¿»é˜…å®ƒçš„ä»£ç ï¼Œæœ€ç»ˆçš„å…³é”®è°ƒç”¨å‚è€ƒDisposableBeanAdapter#hasDestroyMethodï¼š</p><pre><code>public static boolean hasDestroyMethod(Object bean, RootBeanDefinition beanDefinition) {\n   if (bean instanceof DisposableBean || bean instanceof AutoCloseable) {\n      return true;\n   }\n   String destroyMethodName = beanDefinition.getDestroyMethodName();\n   if (AbstractBeanDefinition.INFER_METHOD.equals(destroyMethodName)) {\n      return (ClassUtils.hasMethod(bean.getClass(), CLOSE_METHOD_NAME) ||\n            ClassUtils.hasMethod(bean.getClass(), SHUTDOWN_METHOD_NAME));\n   }\n   return StringUtils.hasLength(destroyMethodName);\n}\n</code></pre><p>å¦‚æœæˆ‘ä»¬æ˜¯ä½¿ç”¨ @Service æ¥äº§ç”Ÿ Bean çš„ï¼Œé‚£ä¹ˆåœ¨ä¸Šè¿°ä»£ç ä¸­æˆ‘ä»¬è·å–çš„destroyMethodName å…¶å®æ˜¯ nullï¼›è€Œä½¿ç”¨ @Bean çš„æ–¹å¼ï¼Œé»˜è®¤å€¼ä¸ºAbstractBeanDefinition.INFER_METHODï¼Œå‚è€ƒ Bean çš„å®šä¹‰ï¼š</p><pre><code>public @interface Bean {\n   //çœç•¥å…¶ä»–éå…³é”®ä»£ç \n   String destroyMethod() default AbstractBeanDefinition.INFER_METHOD;\n}\n</code></pre><p>ç»§ç»­å¯¹ç…§ä»£ç ï¼Œä½ å°±ä¼šå‘ç° @Service æ ‡è®°çš„ LightService ä¹Ÿæ²¡æœ‰å®ç° AutoCloseableã€DisposableBeanï¼Œæœ€ç»ˆæ²¡æœ‰æ·»åŠ ä¸€ä¸ª DisposableBeanAdapterã€‚æ‰€ä»¥æœ€ç»ˆæˆ‘ä»¬å®šä¹‰çš„ shutdown æ–¹æ³•æ²¡æœ‰è¢«è°ƒç”¨ã€‚</p><h2>é‡ç‚¹å›é¡¾</h2><p>é€šè¿‡ä»¥ä¸Šä¸¤ä¸ªæ¡ˆä¾‹ï¼Œç›¸ä¿¡ä½ å¯¹ Spring ç”Ÿå‘½å‘¨æœŸï¼Œå°¤å…¶æ˜¯å¯¹äº Bean çš„åˆå§‹åŒ–å’Œé”€æ¯æµç¨‹å·²ç»æœ‰äº†ä¸€å®šçš„äº†è§£ã€‚è¿™é‡Œå¸¦ä½ å†æ¬¡å›é¡¾ä¸‹é‡ç‚¹ï¼š</p><ol>\n<li>DefaultListableBeanFactory ç±»æ˜¯ Spring Bean çš„çµé­‚ï¼Œè€Œæ ¸å¿ƒå°±æ˜¯å…¶ä¸­çš„ doCreateBean æ–¹æ³•ï¼Œå®ƒæŒæ§äº† Bean å®ä¾‹çš„åˆ›å»ºã€Bean å¯¹è±¡ä¾èµ–çš„æ³¨å…¥ã€å®šåˆ¶ç±»åˆå§‹åŒ–æ–¹æ³•çš„å›è°ƒä»¥åŠ Disposable æ–¹æ³•çš„æ³¨å†Œç­‰å…¨éƒ¨å…³é”®èŠ‚ç‚¹ã€‚</li>\n<li>åç½®å¤„ç†å™¨æ˜¯ Spring ä¸­æœ€ä¼˜é›…çš„è®¾è®¡ä¹‹ä¸€ï¼Œå¯¹äºå¾ˆå¤šåŠŸèƒ½æ³¨è§£çš„å¤„ç†éƒ½æ˜¯å€ŸåŠ©äºåç½®å¤„ç†å™¨æ¥å®Œæˆçš„ã€‚è™½ç„¶è¿™èŠ‚è¯¾å¯¹å…¶æ²¡æœ‰è¿‡å¤šä»‹ç»ï¼Œä½†åœ¨ç¬¬ä¸€ä¸ªæ¡ˆä¾‹ä¸­ï¼ŒBean å¯¹è±¡â€œè¡¥å……â€åˆå§‹åŒ–åŠ¨ä½œå´æ˜¯åœ¨ CommonAnnotationBeanPostProcessorï¼ˆç»§æ‰¿è‡ª  InitDestroyAnnotationBeanPostProcessorï¼‰è¿™ä¸ªåç½®å¤„ç†å™¨ä¸­å®Œæˆçš„ã€‚</li>\n</ol><h2>æ€è€ƒé¢˜</h2><p>æ¡ˆä¾‹ 2 ä¸­çš„ç±» LightServiceï¼Œå½“æˆ‘ä»¬ä¸åœ¨ Configuration æ³¨è§£ç±»ä¸­ä½¿ç”¨ Bean æ–¹æ³•å°†å…¶æ³¨å…¥ Spring å®¹å™¨ï¼Œè€Œæ˜¯åšæŒä½¿ç”¨ @Service å°†å…¶è‡ªåŠ¨æ³¨å…¥åˆ°å®¹å™¨ï¼ŒåŒæ—¶å®ç° Closeable æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre><code>import org.springframework.stereotype.Component;\nimport java.io.Closeable;\n@Service\npublic class LightService implements Closeable {\n    public void close() {\n        System.out.println(&quot;turn off all lights);\n    }\n    //çœç•¥éå…³é”®ä»£ç \n}\n</code></pre><p>æ¥å£æ–¹æ³• close() ä¹Ÿä¼šåœ¨ Spring å®¹å™¨è¢«é”€æ¯çš„æ—¶å€™è‡ªåŠ¨æ‰§è¡Œä¹ˆï¼Ÿ</p><p>æˆ‘åœ¨ç•™è¨€åŒºæœŸå¾…ä½ çš„ç­”æ¡ˆï¼</p>","neighbors":{"left":{"article_title":"03ï½œSpring Bean ä¾èµ–æ³¨å…¥å¸¸è§é”™è¯¯ï¼ˆä¸‹ï¼‰","id":366930},"right":{"article_title":"05ï½œSpring AOP å¸¸è§é”™è¯¯ï¼ˆä¸Šï¼‰","id":369251}},"comments":[{"had_liked":false,"id":291605,"user_name":"NobugNomiss","can_delete":false,"product_type":"c1","uid":2230796,"ip_address":"","ucode":"F62D66399D7742","user_header":"https://static001.geekbang.org/account/avatar/00/22/0a/0c/333ecdfe.jpg","comment_is_top":false,"comment_ctime":1620380229,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"108994562629","product_id":100077001,"comment_content":"æ¥å£æ–¹æ³• close() ä¹Ÿä¼šåœ¨ Spring å®¹å™¨è¢«é”€æ¯çš„æ—¶å€™è‡ªåŠ¨æ‰§è¡Œä¹ˆï¼Ÿ<br>ä¼šï¼ŒåŸå› ï¼šrequiresDestructionæ–¹æ³•ä¸­ï¼Œæœ‰ä¸¤ä¸ªé€»è¾‘çŸ­è·¯æˆ–åˆ¤æ–­ï¼Œç¬¬ä¸€ä¸ªæ˜¯destroyMethodNameä¸ä¸ºç©ºï¼Œå¦ä¸€ä¸ªæ˜¯destroyMethodNameä¸ºç©ºä¸”beanå±äºAutoCloseableç±»å‹ï¼Œè€ŒCloseableæ¥å£æ˜¯AutoCloseableçš„å­ç±»ï¼Œæ‰€ä»¥å¯ä»¥æ»¡è¶³æ¡ä»¶æ‰§è¡Œcloseæ–¹æ³•ã€‚","like_count":26},{"had_liked":false,"id":311409,"user_name":"Geek_45e28f","can_delete":false,"product_type":"c1","uid":2759037,"ip_address":"","ucode":"6CF51984950F48","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erb3HxekfsIdQumoyJVicmOuvibm0DqIiaCNHeESJdic3t1eIXAplplMicOnmLzibI19uiagdXm8qgZftHbw/132","comment_is_top":false,"comment_ctime":1631230583,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"18811099767","product_id":100077001,"comment_content":"â€œLightService çš„ shutdown() æ–¹æ³•èƒ½è¢«è‡ªåŠ¨è°ƒç”¨ï¼›æœ€ç»ˆæ‰“å°å‡º check all lighâ€<br><br>è°ƒç”¨çš„æ˜¯LightService.check()å§ï¼Ÿ","like_count":5,"discussions":[{"author":{"id":2028955,"avatar":"","nickname":"å‹¿æ›´æ”¹ä»»ä½•ä¿¡æ¯","note":"","ucode":"B4949BEB8B2AFD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":410051,"discussion_content":"æ˜¯çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635581963,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":298191,"user_name":"Monday","can_delete":false,"product_type":"c1","uid":1250907,"ip_address":"","ucode":"77B9BACC783598","user_header":"https://static001.geekbang.org/account/avatar/00/13/16/5b/83a35681.jpg","comment_is_top":false,"comment_ctime":1623940823,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10213875415","product_id":100077001,"comment_content":"DefaultListableBeanFactory ç±»æ˜¯ Spring Bean çš„çµé­‚ã€‚dubugäº†çœ‹äº†DefaultListableBeanFactory#doCreateBeanæºç ï¼Œä¹Ÿdebugäº†ä¸‹ã€‚beançš„åˆ›å»ºè¿‡ç¨‹æ€»ç»“å¾—ä¸é”™","like_count":2},{"had_liked":false,"id":290492,"user_name":"å“¦å¼æ‰äº†","can_delete":false,"product_type":"c1","uid":1232599,"ip_address":"","ucode":"1F89B1BA1EEF52","user_header":"https://static001.geekbang.org/account/avatar/00/12/ce/d7/8168e1bf.jpg","comment_is_top":false,"comment_ctime":1619589715,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"5914557011","product_id":100077001,"comment_content":"æ€è€ƒé¢˜:ä¼šçš„ã€‚ä¸ºå•¥@Beanè¦æœ‰é”€æ¯æ–¹æ³•è¿™ä¸ªé»˜è®¤å€¼ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":2894784,"avatar":"","nickname":"Geek_4996c9","note":"","ucode":"98F65C1722D354","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":589474,"discussion_content":"ç”¨@Beanæ–¹å¼æ³¨å…¥çš„ï¼Œä¸€èˆ¬éƒ½æ˜¯ç¬¬ä¸‰æ–¹åŒ…çš„ç±»ï¼Œå› ä¸ºæˆ‘ä»¬æ— æ³•åœ¨ç¬¬ä¸‰æ–¹åŒ…ç±»çš„æºç åŠ @Componentã€@Serviceè¿™ç§æ–¹å¼æ³¨å…¥æˆ‘ä»¬çš„å®¹å™¨ã€‚å¯èƒ½ä¸€äº›ç±»åœ¨å®¹å™¨é”€æ¯çš„æ—¶å€™éœ€è¦æœ‰ä¸€äº›åç½®å¤„ç†ï¼ˆæ–­å¼€æ•°æ®åº“è¿æ¥ã€æŠŠç¼“å­˜å†™å…¥æ–‡ä»¶ï¼‰ï¼Œä½†ä¸ºäº†ä¿æŒé»‘ç›’ï¼ŒSpringåˆ¶å®šäº†è¿™æ¡è§„åˆ™ï¼Œç¬¬ä¸‰æ–¹åŒ…ä½œè€…å¼€å‘çš„æ—¶å€™ä¼šé»˜è®¤éµå®ˆè¿™æ¡è§„åˆ™ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1665022199,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"æ±Ÿè‹"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":347154,"user_name":"ğŸ‡³ æ±Ÿâƒ®âƒ—âƒ¯","can_delete":false,"product_type":"c1","uid":2457579,"ip_address":"","ucode":"276CCAE155BE53","user_header":"https://static001.geekbang.org/account/avatar/00/25/7f/eb/c26be6c2.jpg","comment_is_top":false,"comment_ctime":1653750880,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1653750880","product_id":100077001,"comment_content":"ä¼šè¢«æ‰§è¡Œ<br>if (bean instanceof DisposableBean || bean instanceof AutoCloseable) {return true;}","like_count":0},{"had_liked":false,"id":337266,"user_name":"å®‰è¿ªå¯†æ©","can_delete":false,"product_type":"c1","uid":1331611,"ip_address":"","ucode":"A6F3F67CF8E6F8","user_header":"https://static001.geekbang.org/account/avatar/00/14/51/9b/ccea47d9.jpg","comment_is_top":false,"comment_ctime":1646725958,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1646725958","product_id":100077001,"comment_content":"å‚…å“¥ï¼Œè¿™ä¸¤å¥è¯ä¸­ï¼Œéƒ½æåˆ°äº† â€œæ³¨å†Œåˆ° Spring å®¹å™¨â€ï¼Œçœ‹èµ·æ¥å¤„ç†çš„éƒ½æ˜¯ â€œåç½®å¤„ç†å™¨ç±»â€ï¼Œ å¦‚ä½•ç†è§£å‘¢ï¼Ÿ<br>ç¬¬ä¸€éƒ¨åˆ†ï¼Œå°†ä¸€äº›å¿…è¦çš„ç³»ç»Ÿç±»ï¼Œæ¯”å¦‚ Bean çš„åç½®å¤„ç†å™¨ç±»ï¼Œæ³¨å†Œåˆ° Spring å®¹å™¨ï¼Œå…¶ä¸­å°±åŒ…æ‹¬æˆ‘ä»¬è¿™èŠ‚è¯¾å…³æ³¨çš„ CommonAnnotationBeanPostProcessor ç±»ï¼›<br>ç¬¬äºŒéƒ¨åˆ†ï¼Œå°†è¿™äº›åç½®å¤„ç†å™¨å®ä¾‹åŒ–ï¼Œå¹¶æ³¨å†Œåˆ° Spring çš„å®¹å™¨ä¸­ï¼›","like_count":0},{"had_liked":false,"id":332297,"user_name":"å­å¤œæ¯ç¯","can_delete":false,"product_type":"c1","uid":1359678,"ip_address":"","ucode":"5D84BFE7832038","user_header":"https://static001.geekbang.org/account/avatar/00/14/bf/3e/cdc36608.jpg","comment_is_top":false,"comment_ctime":1643163787,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1643163787","product_id":100077001,"comment_content":"æ€è€ƒé¢˜:<br>ä¼šçš„ï¼ŒåŸå› ï¼šrequiresDestructionæ–¹æ³•ä¸­ï¼Œæœ‰ä¸¤ä¸ªé€»è¾‘çŸ­è·¯æˆ–åˆ¤æ–­ï¼Œç¬¬ä¸€ä¸ªæ˜¯destroyMethodNameä¸ä¸ºç©ºï¼Œå¦ä¸€ä¸ªæ˜¯destroyMethodNameä¸ºç©ºä¸”beanå±äºAutoCloseableç±»å‹ï¼Œè€ŒCloseableæ¥å£æ˜¯AutoCloseableçš„å­ç±»ï¼Œæ‰€ä»¥å¯ä»¥æ»¡è¶³æ¡ä»¶æ‰§è¡Œcloseæ–¹æ³•ã€‚","like_count":0},{"had_liked":false,"id":325588,"user_name":"kycool","can_delete":false,"product_type":"c1","uid":1145056,"ip_address":"","ucode":"A4757A1E4401B5","user_header":"https://static001.geekbang.org/account/avatar/00/11/78/e0/294f6de8.jpg","comment_is_top":false,"comment_ctime":1639032717,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1639032717","product_id":100077001,"comment_content":"åŸæ–‡ä¸­ï¼š<br><br>æˆ‘ä»¬åœ¨ LightMgrService çš„é»˜è®¤æ„é€ å™¨ä¸­è°ƒç”¨äº†é€šè¿‡ @Autoware æ³¨å…¥çš„æˆå‘˜å˜é‡ LightService çš„ check æ–¹æ³•ï¼š<br><br>ä¸­çš„ Autoware åº”ä¸º Autowired","like_count":0},{"had_liked":false,"id":295885,"user_name":"Swaven","can_delete":false,"product_type":"c1","uid":1006986,"ip_address":"","ucode":"168467BBC03C51","user_header":"https://static001.geekbang.org/account/avatar/00/0f/5d/8a/4afd2896.jpg","comment_is_top":false,"comment_ctime":1622630222,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1622630222","product_id":100077001,"comment_content":"ä¼šçš„ï¼Œåœ¨hasDestroyMethodæ–¹æ³•ä¸­åˆ¤æ–­beanæ˜¯å¦DisposableBeanæˆ–è€…AutoCloseableå®ä¾‹ï¼ŒClose-ableç»§æ‰¿è‡ªAutoCloseableï¼Œæ‰€ä»¥ä¼šåœ¨é”€æ¯æ—¶æ‰§è¡Œã€‚","like_count":0},{"had_liked":false,"id":292681,"user_name":"æš–è‰²æµ®ä½™ç”Ÿ","can_delete":false,"product_type":"c1","uid":1593126,"ip_address":"","ucode":"ED943F2DF88896","user_header":"https://static001.geekbang.org/account/avatar/00/18/4f/26/f21afb83.jpg","comment_is_top":false,"comment_ctime":1620918839,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1620918839","product_id":100077001,"comment_content":" ä¼šçš„ã€‚ åœ¨ DisposableBeanAdapter çš„ inferDestroyMethodIfNecessary æ–¹æ³•ä¸­ã€‚ ä¼šåˆ¤æ–­å¦‚æœæ²¡æœ‰è®¾ç½®é”€æ¯æ–¹æ³•çš„è¯ã€‚ä¼šç»§ç»­åˆ¤æ–­å½“å‰ bean æ˜¯å¦å±äº AutoCloseable æ¥å£çš„å®ç°ã€‚","like_count":0},{"had_liked":false,"id":290679,"user_name":"é»‘å±±è€å¦–","can_delete":false,"product_type":"c1","uid":1115958,"ip_address":"","ucode":"A1659F99C5BE1E","user_header":"https://static001.geekbang.org/account/avatar/00/11/07/36/d677e741.jpg","comment_is_top":false,"comment_ctime":1619685276,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1619685276","product_id":100077001,"comment_content":"æ¥å£æ–¹æ³• close() ä¹Ÿä¼šåœ¨ Spring å®¹å™¨è¢«é”€æ¯çš„æ—¶å€™è‡ªåŠ¨æ‰§è¡Œä¹ˆï¼Ÿ<br>ä¼šçš„ã€‚","like_count":0}]}