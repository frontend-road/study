{"id":101397,"title":"35 | å—è®¾å¤‡ï¼ˆä¸‹ï¼‰ï¼šå¦‚ä½•å»ºç«‹ä»£ç†å•†é”€å”®æ¨¡å¼ï¼Ÿ","content":"<p>åœ¨<a href=\"https://time.geekbang.org/column/article/97876\">æ–‡ä»¶ç³»ç»Ÿ</a>é‚£ä¸€èŠ‚ï¼Œæˆ‘ä»¬è®²äº†æ–‡ä»¶çš„å†™å…¥ï¼Œåˆ°äº†è®¾å¤‡é©±åŠ¨è¿™ä¸€å±‚ï¼Œå°±æ²¡æœ‰å†å¾€ä¸‹åˆ†æã€‚ä¸Šä¸€èŠ‚æˆ‘ä»¬åˆè®²äº†mountä¸€ä¸ªå—è®¾å¤‡ï¼Œå°†block_deviceä¿¡æ¯æ”¾åˆ°äº†ext4æ–‡ä»¶ç³»ç»Ÿçš„super_blocké‡Œé¢ï¼Œæœ‰äº†è¿™äº›åŸºç¡€ï¼Œæ˜¯æ—¶å€™æŠŠæ•´ä¸ªå†™å…¥çš„æ•…äº‹ä¸²èµ·æ¥äº†ã€‚</p><p>è¿˜è®°å¾—å’±ä»¬åœ¨æ–‡ä»¶ç³»ç»Ÿé‚£ä¸€èŠ‚åˆ†æå†™å…¥æµç¨‹çš„æ—¶å€™ï¼Œå¯¹äºext4æ–‡ä»¶ç³»ç»Ÿï¼Œæœ€åè°ƒç”¨çš„æ˜¯ext4_file_write_iterï¼Œå®ƒå°†I/Oçš„è°ƒç”¨åˆ†æˆä¸¤ç§æƒ…å†µï¼š</p><p>ç¬¬ä¸€æ˜¯<strong>ç›´æ¥I/O</strong>ã€‚æœ€ç»ˆæˆ‘ä»¬è°ƒç”¨çš„æ˜¯generic_file_direct_writeï¼Œè¿™é‡Œè°ƒç”¨çš„æ˜¯mapping-&gt;a_ops-&gt;direct_IOï¼Œå®é™…è°ƒç”¨çš„æ˜¯ext4_direct_IOï¼Œå¾€è®¾å¤‡å±‚å†™å…¥æ•°æ®ã€‚</p><p>ç¬¬äºŒç§æ˜¯<strong>ç¼“å­˜I/O</strong>ã€‚æœ€ç»ˆæˆ‘ä»¬ä¼šå°†æ•°æ®ä»åº”ç”¨æ‹·è´åˆ°å†…å­˜ç¼“å­˜ä¸­ï¼Œä½†æ˜¯è¿™ä¸ªæ—¶å€™ï¼Œå¹¶ä¸æ‰§è¡ŒçœŸæ­£çš„I/Oæ“ä½œã€‚å®ƒä»¬åªå°†æ•´ä¸ªé¡µæˆ–å…¶ä¸­éƒ¨åˆ†æ ‡è®°ä¸ºè„ã€‚å†™æ“ä½œç”±ä¸€ä¸ªtimerè§¦å‘ï¼Œé‚£ä¸ªæ—¶å€™ï¼Œæ‰è°ƒç”¨wb_workfnå¾€ç¡¬ç›˜å†™å…¥é¡µé¢ã€‚</p><p>æ¥ä¸‹æ¥çš„è°ƒç”¨é“¾ä¸ºï¼šwb_workfn-&gt;wb_do_writeback-&gt;wb_writeback-&gt;writeback_sb_inodes-&gt;__writeback_single_inode-&gt;do_writepagesã€‚åœ¨do_writepagesä¸­ï¼Œæˆ‘ä»¬è¦è°ƒç”¨mapping-&gt;a_ops-&gt;writepagesï¼Œä½†å®é™…è°ƒç”¨çš„æ˜¯ext4_writepagesï¼Œå¾€è®¾å¤‡å±‚å†™å…¥æ•°æ®ã€‚</p><!-- [[[read_end]]] --><p>è¿™ä¸€èŠ‚ï¼Œæˆ‘ä»¬å°±æ²¿ç€è¿™ä¸¤ç§æƒ…å†µåˆ†æä¸‹å»ã€‚</p><h2>ç›´æ¥I/Oå¦‚ä½•è®¿é—®å—è®¾å¤‡ï¼Ÿ</h2><p>æˆ‘ä»¬å…ˆæ¥çœ‹ç¬¬ä¸€ç§æƒ…å†µï¼Œç›´æ¥I/Oè°ƒç”¨åˆ°ext4_direct_IOã€‚</p><pre><code>static ssize_t ext4_direct_IO(struct kiocb *iocb, struct iov_iter *iter)\n{\n\tstruct file *file = iocb-&gt;ki_filp;\n\tstruct inode *inode = file-&gt;f_mapping-&gt;host;\n\tsize_t count = iov_iter_count(iter);\n\tloff_t offset = iocb-&gt;ki_pos;\n\tssize_t ret;\n......\n\tret = ext4_direct_IO_write(iocb, iter);\n......\n}\n\n\nstatic ssize_t ext4_direct_IO_write(struct kiocb *iocb, struct iov_iter *iter)\n{\n\tstruct file *file = iocb-&gt;ki_filp;\n\tstruct inode *inode = file-&gt;f_mapping-&gt;host;\n\tstruct ext4_inode_info *ei = EXT4_I(inode);\n\tssize_t ret;\n\tloff_t offset = iocb-&gt;ki_pos;\n\tsize_t count = iov_iter_count(iter);\n......\n\tret = __blockdev_direct_IO(iocb, inode, inode-&gt;i_sb-&gt;s_bdev, iter,\n\t\t\t\t   get_block_func, ext4_end_io_dio, NULL,\n\t\t\t\t   dio_flags);\n\n\nâ€¦â€¦\n}\n</code></pre><p>åœ¨ext4_direct_IO_writeè°ƒç”¨__blockdev_direct_IOï¼Œæœ‰ä¸ªå‚æ•°ä½ éœ€è¦ç‰¹åˆ«æ³¨æ„ä¸€ä¸‹ï¼Œé‚£å°±æ˜¯inode-&gt;i_sb-&gt;s_bdevã€‚é€šè¿‡å½“å‰æ–‡ä»¶çš„inodeï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°super_blockã€‚è¿™ä¸ªsuper_blockä¸­çš„s_bdevï¼Œå°±æ˜¯å’±ä»¬ä¸Šä¸€èŠ‚å¡«è¿›å»çš„é‚£ä¸ªblock_deviceã€‚</p><p>__blockdev_direct_IOä¼šè°ƒç”¨do_blockdev_direct_IOï¼Œåœ¨è¿™é‡Œé¢æˆ‘ä»¬è¦å‡†å¤‡ä¸€ä¸ªstruct dioç»“æ„å’Œstruct dio_submitç»“æ„ï¼Œç”¨æ¥æè¿°å°†è¦å‘ç”Ÿçš„å†™å…¥è¯·æ±‚ã€‚</p><pre><code>static inline ssize_t\ndo_blockdev_direct_IO(struct kiocb *iocb, struct inode *inode,\n\t\t      struct block_device *bdev, struct iov_iter *iter,\n\t\t      get_block_t get_block, dio_iodone_t end_io,\n\t\t      dio_submit_t submit_io, int flags)\n{\n\tunsigned i_blkbits = ACCESS_ONCE(inode-&gt;i_blkbits);\n\tunsigned blkbits = i_blkbits;\n\tunsigned blocksize_mask = (1 &lt;&lt; blkbits) - 1;\n\tssize_t retval = -EINVAL;\n\tsize_t count = iov_iter_count(iter);\n\tloff_t offset = iocb-&gt;ki_pos;\n\tloff_t end = offset + count;\n\tstruct dio *dio;\n\tstruct dio_submit sdio = { 0, };\n\tstruct buffer_head map_bh = { 0, };\n......\n\tdio = kmem_cache_alloc(dio_cache, GFP_KERNEL);\n\tdio-&gt;flags = flags;\n\tdio-&gt;i_size = i_size_read(inode);\n\tdio-&gt;inode = inode;\n\tif (iov_iter_rw(iter) == WRITE) {\n\t\tdio-&gt;op = REQ_OP_WRITE;\n\t\tdio-&gt;op_flags = REQ_SYNC | REQ_IDLE;\n\t\tif (iocb-&gt;ki_flags &amp; IOCB_NOWAIT)\n\t\t\tdio-&gt;op_flags |= REQ_NOWAIT;\n\t} else {\n\t\tdio-&gt;op = REQ_OP_READ;\n\t}\n\tsdio.blkbits = blkbits;\n\tsdio.blkfactor = i_blkbits - blkbits;\n\tsdio.block_in_file = offset &gt;&gt; blkbits;\n\n\n\tsdio.get_block = get_block;\n\tdio-&gt;end_io = end_io;\n\tsdio.submit_io = submit_io;\n\tsdio.final_block_in_bio = -1;\n\tsdio.next_block_for_io = -1;\n\n\n\tdio-&gt;iocb = iocb;\n\tdio-&gt;refcount = 1;\n\n\n\tsdio.iter = iter;\n\tsdio.final_block_in_request =\n\t\t(offset + iov_iter_count(iter)) &gt;&gt; blkbits;\n......\n\tsdio.pages_in_io += iov_iter_npages(iter, INT_MAX);\n\n\n\tretval = do_direct_IO(dio, &amp;sdio, &amp;map_bh);\n.....\n}\n</code></pre><p>do_direct_IOé‡Œé¢æœ‰ä¸¤å±‚å¾ªç¯ï¼Œç¬¬ä¸€å±‚å¾ªç¯æ˜¯ä¾æ¬¡å¤„ç†è¿™æ¬¡è¦å†™å…¥çš„æ‰€æœ‰å—ã€‚å¯¹äºæ¯ä¸€å—ï¼Œå–å‡ºå¯¹åº”çš„å†…å­˜ä¸­çš„é¡µpageï¼Œåœ¨è¿™ä¸€å—ä¸­ï¼Œæœ‰å†™å…¥çš„èµ·å§‹åœ°å€fromå’Œç»ˆæ­¢åœ°å€toï¼Œæ‰€ä»¥ï¼Œç¬¬äºŒå±‚å¾ªç¯å°±æ˜¯ä¾æ¬¡å¤„ç†fromåˆ°toçš„æ•°æ®ï¼Œè°ƒç”¨submit_page_sectionï¼Œæäº¤åˆ°å—è®¾å¤‡å±‚è¿›è¡Œå†™å…¥ã€‚</p><pre><code>static int do_direct_IO(struct dio *dio, struct dio_submit *sdio,\n\t\t\tstruct buffer_head *map_bh)\n{\n\tconst unsigned blkbits = sdio-&gt;blkbits;\n\tconst unsigned i_blkbits = blkbits + sdio-&gt;blkfactor;\n\tint ret = 0;\n\n\n\twhile (sdio-&gt;block_in_file &lt; sdio-&gt;final_block_in_request) {\n\t\tstruct page *page;\n\t\tsize_t from, to;\n\n\n\t\tpage = dio_get_page(dio, sdio);\n        from = sdio-&gt;head ? 0 : sdio-&gt;from;\n\t\tto = (sdio-&gt;head == sdio-&gt;tail - 1) ? sdio-&gt;to : PAGE_SIZE;\n\t\tsdio-&gt;head++;\n\n\n\t\twhile (from &lt; to) {\n\t\t\tunsigned this_chunk_bytes;\t/* # of bytes mapped */\n\t\t\tunsigned this_chunk_blocks;\t/* # of blocks */\n......\n            ret = submit_page_section(dio, sdio, page,\n\t\t\t\t\t\t  from,\n\t\t\t\t\t\t  this_chunk_bytes,\n\t\t\t\t\t\t  sdio-&gt;next_block_for_io,\n\t\t\t\t\t\t  map_bh);\n......\n\t\t\tsdio-&gt;next_block_for_io += this_chunk_blocks;\n\t\t\tsdio-&gt;block_in_file += this_chunk_blocks;\n\t\t\tfrom += this_chunk_bytes;\n\t\t\tdio-&gt;result += this_chunk_bytes;\n\t\t\tsdio-&gt;blocks_available -= this_chunk_blocks;\n\t\t\tif (sdio-&gt;block_in_file == sdio-&gt;final_block_in_request)\n\t\t\t\tbreak;\n......\n        }\n    }\n}\n</code></pre><p>submit_page_sectionä¼šè°ƒç”¨dio_bio_submitï¼Œè¿›è€Œè°ƒç”¨submit_bioå‘å—è®¾å¤‡å±‚æäº¤æ•°æ®ã€‚å…¶ä¸­ï¼Œå‚æ•°struct bioæ˜¯å°†æ•°æ®ä¼ ç»™å—è®¾å¤‡çš„é€šç”¨ä¼ è¾“å¯¹è±¡ã€‚å®šä¹‰å¦‚ä¸‹ï¼š</p><pre><code>/**\n * submit_bio - submit a bio to the block device layer for I/O\n * @bio: The &amp;struct bio which describes the I/O\n */\nblk_qc_t submit_bio(struct bio *bio)\n{\n......\n  return generic_make_request(bio);\n}\n</code></pre><h2>ç¼“å­˜I/Oå¦‚ä½•è®¿é—®å—è®¾å¤‡ï¼Ÿ</h2><p>æˆ‘ä»¬å†æ¥çœ‹ç¬¬äºŒç§æƒ…å†µï¼Œç¼“å­˜I/Oè°ƒç”¨åˆ°ext4_writepagesã€‚è¿™ä¸ªå‡½æ•°æ¯”è¾ƒé•¿ï¼Œæˆ‘ä»¬è¿™é‡Œåªæˆªå–æœ€é‡è¦çš„éƒ¨åˆ†æ¥è®²è§£ã€‚</p><pre><code>static int ext4_writepages(struct address_space *mapping,\n\t\t\t   struct writeback_control *wbc)\n{\n......\n\tstruct mpage_da_data mpd;\n\tstruct inode *inode = mapping-&gt;host;\n\tstruct ext4_sb_info *sbi = EXT4_SB(mapping-&gt;host-&gt;i_sb);\n......\n\tmpd.do_map = 0;\n\tmpd.io_submit.io_end = ext4_init_io_end(inode, GFP_KERNEL);\n\tret = mpage_prepare_extent_to_map(&amp;mpd);\n\t/* Submit prepared bio */\n\text4_io_submit(&amp;mpd.io_submit);\n......\n}\n</code></pre><p>è¿™é‡Œæ¯”è¾ƒé‡è¦çš„ä¸€ä¸ªæ•°æ®ç»“æ„æ˜¯struct mpage_da_dataã€‚è¿™é‡Œé¢æœ‰æ–‡ä»¶çš„inodeã€è¦å†™å…¥çš„é¡µçš„åç§»é‡ï¼Œè¿˜æœ‰ä¸€ä¸ªé‡è¦çš„struct ext4_io_submitï¼Œé‡Œé¢æœ‰é€šç”¨ä¼ è¾“å¯¹è±¡bioã€‚</p><pre><code>struct mpage_da_data {\n\tstruct inode *inode;\n......\n\tpgoff_t first_page;\t/* The first page to write */\n\tpgoff_t next_page;\t/* Current page to examine */\n\tpgoff_t last_page;\t/* Last page to examine */\n\tstruct ext4_map_blocks map;\n\tstruct ext4_io_submit io_submit;\t/* IO submission data */\n\tunsigned int do_map:1;\n};\n\n\nstruct ext4_io_submit {\n......\n\tstruct bio\t\t*io_bio;\n\text4_io_end_t\t\t*io_end;\n\tsector_t\t\tio_next_block;\n};\n</code></pre><p>åœ¨ext4_writepagesä¸­ï¼Œmpage_prepare_extent_to_mapç”¨äºåˆå§‹åŒ–è¿™ä¸ªstruct mpage_da_dataç»“æ„ã€‚æ¥ä¸‹æ¥çš„è°ƒç”¨é“¾ä¸ºï¼šmpage_prepare_extent_to_map-&gt;mpage_process_page_bufs-&gt;mpage_submit_page-&gt;ext4_bio_write_page-&gt;io_submit_add_bhã€‚</p><p>åœ¨io_submit_add_bhä¸­ï¼Œæ­¤æ—¶çš„bioè¿˜æ˜¯ç©ºçš„ï¼Œå› è€Œæˆ‘ä»¬è¦è°ƒç”¨io_submit_init_bioï¼Œåˆå§‹åŒ–bioã€‚</p><pre><code>static int io_submit_init_bio(struct ext4_io_submit *io,\n\t\t\t      struct buffer_head *bh)\n{\n\tstruct bio *bio;\n\n\n\tbio = bio_alloc(GFP_NOIO, BIO_MAX_PAGES);\n\tif (!bio)\n\t\treturn -ENOMEM;\n\twbc_init_bio(io-&gt;io_wbc, bio);\n\tbio-&gt;bi_iter.bi_sector = bh-&gt;b_blocknr * (bh-&gt;b_size &gt;&gt; 9);\n\tbio-&gt;bi_bdev = bh-&gt;b_bdev;\n\tbio-&gt;bi_end_io = ext4_end_bio;\n\tbio-&gt;bi_private = ext4_get_io_end(io-&gt;io_end);\n\tio-&gt;io_bio = bio;\n\tio-&gt;io_next_block = bh-&gt;b_blocknr;\n\treturn 0;\n}\n\n</code></pre><p>æˆ‘ä»¬å†å›åˆ°ext4_writepagesä¸­ã€‚åœ¨bioåˆå§‹åŒ–å®Œä¹‹åï¼Œæˆ‘ä»¬è¦è°ƒç”¨ext4_io_submitï¼Œæäº¤I/Oã€‚åœ¨è¿™é‡Œæˆ‘ä»¬åˆæ˜¯è°ƒç”¨submit_bioï¼Œå‘å—è®¾å¤‡å±‚ä¼ è¾“æ•°æ®ã€‚ext4_io_submitçš„å®ç°å¦‚ä¸‹ï¼š</p><pre><code>void ext4_io_submit(struct ext4_io_submit *io)\n{\n\tstruct bio *bio = io-&gt;io_bio;\n\n\n\tif (bio) {\n\t\tint io_op_flags = io-&gt;io_wbc-&gt;sync_mode == WB_SYNC_ALL ?\n\t\t\t\t  REQ_SYNC : 0;\n\t\tio-&gt;io_bio-&gt;bi_write_hint = io-&gt;io_end-&gt;inode-&gt;i_write_hint;\n\t\tbio_set_op_attrs(io-&gt;io_bio, REQ_OP_WRITE, io_op_flags);\n\t\tsubmit_bio(io-&gt;io_bio);\n\t}\n\tio-&gt;io_bio = NULL;\n}\n\n</code></pre><h2>å¦‚ä½•å‘å—è®¾å¤‡å±‚æäº¤è¯·æ±‚ï¼Ÿ</h2><p>æ—¢ç„¶ä¸ç®¡æ˜¯ç›´æ¥I/Oï¼Œè¿˜æ˜¯ç¼“å­˜I/Oï¼Œæœ€åéƒ½åˆ°äº†submit_bioé‡Œé¢ï¼Œé‚£æˆ‘ä»¬å°±æ¥é‡ç‚¹åˆ†æä¸€ä¸‹å®ƒã€‚</p><p>submit_bioä¼šè°ƒç”¨generic_make_requestã€‚ä»£ç å¦‚ä¸‹ï¼š</p><pre><code>blk_qc_t generic_make_request(struct bio *bio)\n{\n\t/*\n\t * bio_list_on_stack[0] contains bios submitted by the current\n\t * make_request_fn.\n\t * bio_list_on_stack[1] contains bios that were submitted before\n\t * the current make_request_fn, but that haven't been processed\n\t * yet.\n\t */\n\tstruct bio_list bio_list_on_stack[2];\n\tblk_qc_t ret = BLK_QC_T_NONE;\n......\n\tif (current-&gt;bio_list) {\n\t\tbio_list_add(&amp;current-&gt;bio_list[0], bio);\n\t\tgoto out;\n\t}\n\n\n\tbio_list_init(&amp;bio_list_on_stack[0]);\n\tcurrent-&gt;bio_list = bio_list_on_stack;\n\tdo {\n\t\tstruct request_queue *q = bdev_get_queue(bio-&gt;bi_bdev);\n\n\n\t\tif (likely(blk_queue_enter(q, bio-&gt;bi_opf &amp; REQ_NOWAIT) == 0)) {\n\t\t\tstruct bio_list lower, same;\n\n\n\t\t\t/* Create a fresh bio_list for all subordinate requests */\n\t\t\tbio_list_on_stack[1] = bio_list_on_stack[0];\n\t\t\tbio_list_init(&amp;bio_list_on_stack[0]);\n\t\t\tret = q-&gt;make_request_fn(q, bio);\n\n\n\t\t\tblk_queue_exit(q);\n\n\n\t\t\t/* sort new bios into those for a lower level\n\t\t\t * and those for the same level\n\t\t\t */\n\t\t\tbio_list_init(&amp;lower);\n\t\t\tbio_list_init(&amp;same);\n\t\t\twhile ((bio = bio_list_pop(&amp;bio_list_on_stack[0])) != NULL)\n\t\t\t\tif (q == bdev_get_queue(bio-&gt;bi_bdev))\n\t\t\t\t\tbio_list_add(&amp;same, bio);\n\t\t\t\telse\n\t\t\t\t\tbio_list_add(&amp;lower, bio);\n\t\t\t/* now assemble so we handle the lowest level first */\n\t\t\tbio_list_merge(&amp;bio_list_on_stack[0], &amp;lower);\n\t\t\tbio_list_merge(&amp;bio_list_on_stack[0], &amp;same);\n\t\t\tbio_list_merge(&amp;bio_list_on_stack[0], &amp;bio_list_on_stack[1]);\n\t\t} \n......\n\t\tbio = bio_list_pop(&amp;bio_list_on_stack[0]);\n\t} while (bio);\n\tcurrent-&gt;bio_list = NULL; /* deactivate */\nout:\n\treturn ret;\n}\n</code></pre><p>è¿™é‡Œçš„é€»è¾‘æœ‰ç‚¹å¤æ‚ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹å¤§çš„é€»è¾‘ã€‚åœ¨do-whileä¸­ï¼Œæˆ‘ä»¬å…ˆæ˜¯è·å–ä¸€ä¸ªè¯·æ±‚é˜Ÿåˆ—request_queueï¼Œç„¶åè°ƒç”¨è¿™ä¸ªé˜Ÿåˆ—çš„make_request_fnå‡½æ•°ã€‚</p><h3>å—è®¾å¤‡é˜Ÿåˆ—ç»“æ„</h3><p>å¦‚æœå†æ¥çœ‹struct block_deviceç»“æ„å’Œstruct gendiskç»“æ„ï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œæ¯ä¸ªå—è®¾å¤‡éƒ½æœ‰ä¸€ä¸ªè¯·æ±‚é˜Ÿåˆ—struct request_queueï¼Œç”¨äºå¤„ç†ä¸Šå±‚å‘æ¥çš„è¯·æ±‚ã€‚</p><p>åœ¨æ¯ä¸ªå—è®¾å¤‡çš„é©±åŠ¨ç¨‹åºåˆå§‹åŒ–çš„æ—¶å€™ï¼Œä¼šç”Ÿæˆä¸€ä¸ªrequest_queueã€‚</p><pre><code>struct request_queue {\n\t/*\n\t * Together with queue_head for cacheline sharing\n\t */\n\tstruct list_head\tqueue_head;\n\tstruct request\t\t*last_merge;\n\tstruct elevator_queue\t*elevator;\n......\n\trequest_fn_proc\t\t*request_fn;\n\tmake_request_fn\t\t*make_request_fn;\n......\n}\n</code></pre><p>åœ¨è¯·æ±‚é˜Ÿåˆ—request_queueä¸Šï¼Œé¦–å…ˆæ˜¯æœ‰ä¸€ä¸ªé“¾è¡¨list_headï¼Œä¿å­˜è¯·æ±‚requestã€‚</p><pre><code>struct request {\n\tstruct list_head queuelist;\n......\n\tstruct request_queue *q;\n......\n\tstruct bio *bio;\n\tstruct bio *biotail;\n......\n}\n</code></pre><p>æ¯ä¸ªrequeståŒ…æ‹¬ä¸€ä¸ªé“¾è¡¨çš„struct bioï¼Œæœ‰æŒ‡é’ˆæŒ‡å‘ä¸€å¤´ä¸€å°¾ã€‚</p><pre><code>struct bio {\n\tstruct bio\t\t*bi_next;\t/* request queue link */\n\tstruct block_device\t*bi_bdev;\n\tblk_status_t\t\tbi_status;\n......\n    struct bvec_iter\tbi_iter;\n\tunsigned short\t\tbi_vcnt;\t/* how many bio_vec's */\n\tunsigned short\t\tbi_max_vecs;\t/* max bvl_vecs we can hold */\n\tatomic_t\t\t__bi_cnt;\t/* pin count */\n\tstruct bio_vec\t\t*bi_io_vec;\t/* the actual vec list */\n......\n};\n\n\nstruct bio_vec {\n\tstruct page\t*bv_page;\n\tunsigned int\tbv_len;\n\tunsigned int\tbv_offset;\n}\n</code></pre><p>åœ¨bioä¸­ï¼Œbi_nextæ˜¯é“¾è¡¨ä¸­çš„ä¸‹ä¸€é¡¹ï¼Œstruct bio_vecæŒ‡å‘ä¸€ç»„é¡µé¢ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/3c/0e/3c473d163b6e90985d7301f115ab660e.jpeg?wh=1289*2930\" alt=\"\"></p><p>åœ¨è¯·æ±‚é˜Ÿåˆ—request_queueä¸Šï¼Œè¿˜æœ‰ä¸¤ä¸ªé‡è¦çš„å‡½æ•°ï¼Œä¸€ä¸ªæ˜¯make_request_fnå‡½æ•°ï¼Œç”¨äºç”Ÿæˆrequestï¼›å¦ä¸€ä¸ªæ˜¯request_fnå‡½æ•°ï¼Œç”¨äºå¤„ç†requestã€‚</p><h3>å—è®¾å¤‡çš„åˆå§‹åŒ–</h3><p>æˆ‘ä»¬è¿˜æ˜¯ä»¥scsié©±åŠ¨ä¸ºä¾‹ã€‚åœ¨åˆå§‹åŒ–è®¾å¤‡é©±åŠ¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šè°ƒç”¨scsi_alloc_queueï¼ŒæŠŠrequest_fnè®¾ç½®ä¸ºscsi_request_fnã€‚æˆ‘ä»¬è¿˜ä¼šè°ƒç”¨blk_init_allocated_queue-&gt;blk_queue_make_requestï¼ŒæŠŠmake_request_fnè®¾ç½®ä¸ºblk_queue_bioã€‚</p><pre><code>/**\n * scsi_alloc_sdev - allocate and setup a scsi_Device\n * @starget: which target to allocate a &amp;scsi_device for\n * @lun: which lun\n * @hostdata: usually NULL and set by -&gt;slave_alloc instead\n *\n * Description:\n *     Allocate, initialize for io, and return a pointer to a scsi_Device.\n *     Stores the @shost, @channel, @id, and @lun in the scsi_Device, and\n *     adds scsi_Device to the appropriate list.\n *\n * Return value:\n *     scsi_Device pointer, or NULL on failure.\n **/\nstatic struct scsi_device *scsi_alloc_sdev(struct scsi_target *starget,\n\t\t\t\t\t   u64 lun, void *hostdata)\n{\n\tstruct scsi_device *sdev;\n\tsdev = kzalloc(sizeof(*sdev) + shost-&gt;transportt-&gt;device_size,\n\t\t       GFP_ATOMIC);\n......\n\tsdev-&gt;request_queue = scsi_alloc_queue(sdev);\n......\n}\n\n\nstruct request_queue *scsi_alloc_queue(struct scsi_device *sdev)\n{\n\tstruct Scsi_Host *shost = sdev-&gt;host;\n\tstruct request_queue *q;\n\n\n\tq = blk_alloc_queue_node(GFP_KERNEL, NUMA_NO_NODE);\n\tif (!q)\n\t\treturn NULL;\n\tq-&gt;cmd_size = sizeof(struct scsi_cmnd) + shost-&gt;hostt-&gt;cmd_size;\n\tq-&gt;rq_alloc_data = shost;\n\tq-&gt;request_fn = scsi_request_fn;\n\tq-&gt;init_rq_fn = scsi_init_rq;\n\tq-&gt;exit_rq_fn = scsi_exit_rq;\n\tq-&gt;initialize_rq_fn = scsi_initialize_rq;\n\n\n    //è°ƒç”¨blk_queue_make_request(q, blk_queue_bio);\n\tif (blk_init_allocated_queue(q) &lt; 0) {\n\t\tblk_cleanup_queue(q);\n\t\treturn NULL;\n\t}\n\n\n\t__scsi_init_queue(shost, q);\n......\n\treturn q\n}\n</code></pre><p>åœ¨blk_init_allocated_queueä¸­ï¼Œé™¤äº†åˆå§‹åŒ–make_request_fnå‡½æ•°ï¼Œæˆ‘ä»¬è¿˜è¦åšä¸€ä»¶å¾ˆé‡è¦çš„äº‹æƒ…ï¼Œå°±æ˜¯åˆå§‹åŒ–I/Oçš„ç”µæ¢¯ç®—æ³•ã€‚</p><pre><code>int blk_init_allocated_queue(struct request_queue *q)\n{\n\tq-&gt;fq = blk_alloc_flush_queue(q, NUMA_NO_NODE, q-&gt;cmd_size);\n......\n\tblk_queue_make_request(q, blk_queue_bio);\n......\n\t/* init elevator */\n\tif (elevator_init(q, NULL)) {\n......\n\t}\n......\n}\n</code></pre><p>ç”µæ¢¯ç®—æ³•æœ‰å¾ˆå¤šç§ç±»å‹ï¼Œå®šä¹‰ä¸ºelevator_typeã€‚ä¸‹é¢æˆ‘æ¥é€ä¸€è¯´ä¸€ä¸‹ã€‚</p><ul>\n<li><strong>struct elevator_type elevator_noop</strong></li>\n</ul><p>Noopè°ƒåº¦ç®—æ³•æ˜¯æœ€ç®€å•çš„IOè°ƒåº¦ç®—æ³•ï¼Œå®ƒå°†IOè¯·æ±‚æ”¾å…¥åˆ°ä¸€ä¸ªFIFOé˜Ÿåˆ—ä¸­ï¼Œç„¶åé€ä¸ªæ‰§è¡Œè¿™äº›IOè¯·æ±‚ã€‚</p><ul>\n<li><strong>struct elevator_type iosched_deadline</strong></li>\n</ul><p>Deadlineç®—æ³•è¦ä¿è¯æ¯ä¸ªIOè¯·æ±‚åœ¨ä¸€å®šçš„æ—¶é—´å†…ä¸€å®šè¦è¢«æœåŠ¡åˆ°ï¼Œä»¥æ­¤æ¥é¿å…æŸä¸ªè¯·æ±‚é¥¥é¥¿ã€‚ä¸ºäº†å®Œæˆè¿™ä¸ªç›®æ ‡ï¼Œç®—æ³•ä¸­å¼•å…¥äº†ä¸¤ç±»é˜Ÿåˆ—ï¼Œä¸€ç±»é˜Ÿåˆ—ç”¨æ¥å¯¹è¯·æ±‚æŒ‰èµ·å§‹æ‰‡åŒºåºå·è¿›è¡Œæ’åºï¼Œé€šè¿‡çº¢é»‘æ ‘æ¥ç»„ç»‡ï¼Œæˆ‘ä»¬ç§°ä¸ºsort_listï¼ŒæŒ‰ç…§æ­¤é˜Ÿåˆ—ä¼ è¾“æ€§èƒ½ä¼šæ¯”è¾ƒé«˜ï¼›å¦ä¸€ç±»é˜Ÿåˆ—å¯¹è¯·æ±‚æŒ‰å®ƒä»¬çš„ç”Ÿæˆæ—¶é—´è¿›è¡Œæ’åºï¼Œç”±é“¾è¡¨æ¥ç»„ç»‡ï¼Œç§°ä¸ºfifo_listï¼Œå¹¶ä¸”æ¯ä¸€ä¸ªè¯·æ±‚éƒ½æœ‰ä¸€ä¸ªæœŸé™å€¼ã€‚</p><ul>\n<li><strong>struct elevator_type iosched_cfq</strong></li>\n</ul><p>åˆçœ‹åˆ°äº†ç†Ÿæ‚‰çš„CFQå®Œå…¨å…¬å¹³è°ƒåº¦ç®—æ³•ã€‚æ‰€æœ‰çš„è¯·æ±‚ä¼šåœ¨å¤šä¸ªé˜Ÿåˆ—ä¸­æ’åºã€‚åŒä¸€ä¸ªè¿›ç¨‹çš„è¯·æ±‚ï¼Œæ€»æ˜¯åœ¨åŒä¸€é˜Ÿåˆ—ä¸­å¤„ç†ã€‚æ—¶é—´ç‰‡ä¼šåˆ†é…åˆ°æ¯ä¸ªé˜Ÿåˆ—ï¼Œé€šè¿‡è½®è¯¢ç®—æ³•ï¼Œæˆ‘ä»¬ä¿è¯äº†I/Oå¸¦å®½ï¼Œä»¥å…¬å¹³çš„æ–¹å¼ï¼Œåœ¨ä¸åŒé˜Ÿåˆ—ä¹‹é—´è¿›è¡Œå…±äº«ã€‚</p><p>elevator_initä¸­ä¼šæ ¹æ®åç§°æ¥æŒ‡å®šç”µæ¢¯ç®—æ³•ï¼Œå¦‚æœæ²¡æœ‰é€‰æ‹©ï¼Œé‚£å°±é»˜è®¤ä½¿ç”¨iosched_cfqã€‚</p><h3>è¯·æ±‚æäº¤ä¸è°ƒåº¦</h3><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å›åˆ°generic_make_requestå‡½æ•°ä¸­ã€‚è°ƒç”¨é˜Ÿåˆ—çš„make_request_fnå‡½æ•°ï¼Œå…¶å®å°±æ˜¯è°ƒç”¨blk_queue_bioã€‚</p><pre><code>static blk_qc_t blk_queue_bio(struct request_queue *q, struct bio *bio)\n{\n\tstruct request *req, *free;\n\tunsigned int request_count = 0;\n......\n\tswitch (elv_merge(q, &amp;req, bio)) {\n\tcase ELEVATOR_BACK_MERGE:\n\t\tif (!bio_attempt_back_merge(q, req, bio))\n\t\t\tbreak;\n\t\telv_bio_merged(q, req, bio);\n\t\tfree = attempt_back_merge(q, req);\n\t\tif (free)\n\t\t\t__blk_put_request(q, free);\n\t\telse\n\t\t\telv_merged_request(q, req, ELEVATOR_BACK_MERGE);\n\t\tgoto out_unlock;\n\tcase ELEVATOR_FRONT_MERGE:\n\t\tif (!bio_attempt_front_merge(q, req, bio))\n\t\t\tbreak;\n\t\telv_bio_merged(q, req, bio);\n\t\tfree = attempt_front_merge(q, req);\n\t\tif (free)\n\t\t\t__blk_put_request(q, free);\n\t\telse\n\t\t\telv_merged_request(q, req, ELEVATOR_FRONT_MERGE);\n\t\tgoto out_unlock;\n\tdefault:\n\t\tbreak;\n\t}\n\n\nget_rq:\n\treq = get_request(q, bio-&gt;bi_opf, bio, GFP_NOIO);\n......\n\tblk_init_request_from_bio(req, bio);\n......\n\tadd_acct_request(q, req, where);\n\t__blk_run_queue(q);\nout_unlock:\n......\n\treturn BLK_QC_T_NONE;\n}\n</code></pre><p>blk_queue_bioé¦–å…ˆåšçš„ä¸€ä»¶äº‹æƒ…æ˜¯è°ƒç”¨elv_mergeæ¥åˆ¤æ–­ï¼Œå½“å‰è¿™ä¸ªbioè¯·æ±‚æ˜¯å¦èƒ½å¤Ÿå’Œç›®å‰å·²æœ‰çš„requeståˆå¹¶èµ·æ¥ï¼Œæˆä¸ºåŒä¸€æ‰¹I/Oæ“ä½œï¼Œä»è€Œæé«˜è¯»å–å’Œå†™å…¥çš„æ€§èƒ½ã€‚</p><p>åˆ¤æ–­æ ‡å‡†å’Œstruct bioçš„æˆå‘˜struct bvec_iteræœ‰å…³ï¼Œå®ƒé‡Œé¢æœ‰ä¸¤ä¸ªå˜é‡ï¼Œä¸€ä¸ªæ˜¯èµ·å§‹ç£ç›˜ç°‡bi_sectorï¼Œå¦ä¸€ä¸ªæ˜¯å¤§å°bi_sizeã€‚</p><pre><code>enum elv_merge elv_merge(struct request_queue *q, struct request **req,\n\t\tstruct bio *bio)\n{\n\tstruct elevator_queue *e = q-&gt;elevator;\n\tstruct request *__rq;\n......\n\tif (q-&gt;last_merge &amp;&amp; elv_bio_merge_ok(q-&gt;last_merge, bio)) {\n\t\tenum elv_merge ret = blk_try_merge(q-&gt;last_merge, bio);\n\n\n\t\tif (ret != ELEVATOR_NO_MERGE) {\n\t\t\t*req = q-&gt;last_merge;\n\t\t\treturn ret;\n\t\t}\n\t}\n......\n\t__rq = elv_rqhash_find(q, bio-&gt;bi_iter.bi_sector);\n\tif (__rq &amp;&amp; elv_bio_merge_ok(__rq, bio)) {\n\t\t*req = __rq;\n\t\treturn ELEVATOR_BACK_MERGE;\n\t}\n\n\n\tif (e-&gt;uses_mq &amp;&amp; e-&gt;type-&gt;ops.mq.request_merge)\n\t\treturn e-&gt;type-&gt;ops.mq.request_merge(q, req, bio);\n\telse if (!e-&gt;uses_mq &amp;&amp; e-&gt;type-&gt;ops.sq.elevator_merge_fn)\n\t\treturn e-&gt;type-&gt;ops.sq.elevator_merge_fn(q, req, bio);\n\n\n\treturn ELEVATOR_NO_MERGE;\n}\n</code></pre><p>elv_mergeå°è¯•äº†ä¸‰æ¬¡åˆå¹¶ã€‚</p><p>ç¬¬ä¸€æ¬¡ï¼Œå®ƒå…ˆåˆ¤æ–­å’Œä¸Šä¸€æ¬¡åˆå¹¶çš„requestèƒ½ä¸èƒ½å†æ¬¡åˆå¹¶ï¼Œçœ‹çœ‹èƒ½ä¸èƒ½èµ¶ä¸Šé©¬ä¸Šè¦èµ°çš„è¿™éƒ¨ç”µæ¢¯ã€‚åœ¨blk_try_mergeä¸»è¦åšäº†è¿™æ ·çš„åˆ¤æ–­ï¼šå¦‚æœblk_rq_pos(rq) + blk_rq_sectors(rq) == bio-&gt;bi_iter.bi_sectorï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªrequestçš„èµ·å§‹åœ°å€åŠ ä¸Šå®ƒçš„å¤§å°ï¼ˆå…¶å®æ˜¯è¿™ä¸ªrequestçš„ç»“æŸåœ°å€ï¼‰ï¼Œå¦‚æœå’Œbioçš„èµ·å§‹åœ°å€èƒ½æ¥å¾—ä¸Šï¼Œé‚£å°±æŠŠbioæ”¾åœ¨requestçš„æœ€åï¼Œæˆ‘ä»¬ç§°ä¸ºELEVATOR_BACK_MERGEã€‚</p><p>å¦‚æœblk_rq_pos(rq) - bio_sectors(bio) == bio-&gt;bi_iter.bi_sectorï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªrequestçš„èµ·å§‹åœ°å€å‡å»bioçš„å¤§å°ç­‰äºbioçš„èµ·å§‹åœ°å€ï¼Œè¿™è¯´æ˜bioæ”¾åœ¨requestçš„æœ€å‰é¢èƒ½å¤Ÿæ¥å¾—ä¸Šï¼Œé‚£å°±æŠŠbioæ”¾åœ¨requestçš„æœ€å‰é¢ï¼Œæˆ‘ä»¬ç§°ä¸ºELEVATOR_FRONT_MERGEã€‚å¦åˆ™ï¼Œé‚£å°±ä¸åˆå¹¶ï¼Œæˆ‘ä»¬ç§°ä¸ºELEVATOR_NO_MERGEã€‚</p><pre><code>enum elv_merge blk_try_merge(struct request *rq, struct bio *bio)\n{\n......\n    if (blk_rq_pos(rq) + blk_rq_sectors(rq) == bio-&gt;bi_iter.bi_sector)\n\t\treturn ELEVATOR_BACK_MERGE;\n\telse if (blk_rq_pos(rq) - bio_sectors(bio) == bio-&gt;bi_iter.bi_sector)\n\t\treturn ELEVATOR_FRONT_MERGE;\n\treturn ELEVATOR_NO_MERGE;\n}\n</code></pre><p>ç¬¬äºŒæ¬¡ï¼Œå¦‚æœå’Œä¸Šä¸€ä¸ªåˆå¹¶è¿‡çš„requestæ— æ³•åˆå¹¶ï¼Œé‚£æˆ‘ä»¬å°±è°ƒç”¨elv_rqhash_findã€‚ç„¶åæŒ‰ç…§bioçš„èµ·å§‹åœ°å€æŸ¥æ‰¾requestï¼Œçœ‹æœ‰æ²¡æœ‰èƒ½å¤Ÿåˆå¹¶çš„ã€‚å¦‚æœæœ‰çš„è¯ï¼Œå› ä¸ºæ˜¯æŒ‰ç…§èµ·å§‹åœ°å€æ‰¾çš„ï¼Œåº”è¯¥æ¥åœ¨äººå®¶çš„åé¢ï¼Œæ‰€ä»¥æ˜¯ELEVATOR_BACK_MERGEã€‚</p><p>ç¬¬ä¸‰æ¬¡ï¼Œè°ƒç”¨elevator_merge_fnè¯•å›¾åˆå¹¶ã€‚å¯¹äºiosched_cfqï¼Œè°ƒç”¨çš„æ˜¯cfq_mergeã€‚åœ¨è¿™é‡Œé¢ï¼Œcfq_find_rq_fmergeä¼šè°ƒç”¨elv_rb_findå‡½æ•°ï¼Œé‡Œé¢çš„å‚æ•°æ˜¯bioçš„ç»“æŸåœ°å€ã€‚æˆ‘ä»¬è¿˜æ˜¯è¦çœ‹ï¼Œèƒ½ä¸èƒ½æ‰¾åˆ°å¯ä»¥åˆå¹¶çš„ã€‚å¦‚æœæœ‰çš„è¯ï¼Œå› ä¸ºæ˜¯æŒ‰ç…§ç»“æŸåœ°å€æ‰¾çš„ï¼Œåº”è¯¥æ¥åœ¨äººå®¶å‰é¢ï¼Œæ‰€ä»¥æ˜¯ELEVATOR_FRONT_MERGEã€‚</p><pre><code>static enum elv_merge cfq_merge(struct request_queue *q, struct request **req,\n\t\t     struct bio *bio)\n{\n\tstruct cfq_data *cfqd = q-&gt;elevator-&gt;elevator_data;\n\tstruct request *__rq;\n\n\n\t__rq = cfq_find_rq_fmerge(cfqd, bio);\n\tif (__rq &amp;&amp; elv_bio_merge_ok(__rq, bio)) {\n\t\t*req = __rq;\n\t\treturn ELEVATOR_FRONT_MERGE;\n\t}\n\n\n\treturn ELEVATOR_NO_MERGE;\n}\n\n\nstatic struct request *\ncfq_find_rq_fmerge(struct cfq_data *cfqd, struct bio *bio)\n{\n\tstruct task_struct *tsk = current;\n\tstruct cfq_io_cq *cic;\n\tstruct cfq_queue *cfqq;\n\n\n\tcic = cfq_cic_lookup(cfqd, tsk-&gt;io_context);\n\tif (!cic)\n\t\treturn NULL;\n\n\n\tcfqq = cic_to_cfqq(cic, op_is_sync(bio-&gt;bi_opf));\n\tif (cfqq)\n\t\treturn elv_rb_find(&amp;cfqq-&gt;sort_list, bio_end_sector(bio));\n\n\n\treturn NUL\n}\n</code></pre><p>ç­‰ä»elv_mergeè¿”å›blk_queue_bioçš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±çŸ¥é“ï¼Œåº”è¯¥åšå“ªç§ç±»å‹çš„åˆå¹¶ï¼Œæ¥ç€å°±è¦è¿›è¡ŒçœŸçš„åˆå¹¶ã€‚å¦‚æœæ²¡æœ‰åŠæ³•åˆå¹¶ï¼Œé‚£å°±è°ƒç”¨get_requestï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„requestï¼Œè°ƒç”¨blk_init_request_from_bioï¼Œå°†bioæ”¾åˆ°æ–°çš„requesté‡Œé¢ï¼Œç„¶åè°ƒç”¨add_acct_requestï¼ŒæŠŠæ–°çš„requeståŠ åˆ°request_queueé˜Ÿåˆ—ä¸­ã€‚</p><p>è‡³æ­¤ï¼Œæˆ‘ä»¬è§£æå®Œäº†generic_make_requestä¸­æœ€é‡è¦çš„ä¸¤å¤§é€»è¾‘ï¼šè·å–ä¸€ä¸ªè¯·æ±‚é˜Ÿåˆ—request_queueå’Œè°ƒç”¨è¿™ä¸ªé˜Ÿåˆ—çš„make_request_fnå‡½æ•°ã€‚</p><p>å…¶å®ï¼Œgeneric_make_requestå…¶ä»–éƒ¨åˆ†ä¹Ÿå¾ˆä»¤äººå›°æƒ‘ã€‚æ„Ÿè§‰é‡Œé¢æœ‰ç‰¹åˆ«å¤šçš„struct bio_listï¼Œå€’è…¾è¿‡æ¥ï¼Œå€’è…¾è¿‡å»çš„ã€‚è¿™æ˜¯å› ä¸ºï¼Œå¾ˆå¤šå—è®¾å¤‡æ˜¯æœ‰å±‚æ¬¡çš„ã€‚</p><p>æ¯”å¦‚ï¼Œæˆ‘ä»¬ç”¨ä¸¤å—ç¡¬ç›˜ç»„æˆRAIDï¼Œä¸¤ä¸ªRAIDç›˜ç»„æˆLVMï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥åœ¨LVMä¸Šåˆ›å»ºä¸€ä¸ªå—è®¾å¤‡ç»™ç”¨æˆ·ç”¨ï¼Œæˆ‘ä»¬ç§°æ¥è¿‘ç”¨æˆ·çš„å—è®¾å¤‡ä¸º<strong>é«˜å±‚æ¬¡çš„å—è®¾å¤‡</strong>ï¼Œæ¥è¿‘åº•å±‚çš„å—è®¾å¤‡ä¸º<strong>ä½å±‚æ¬¡</strong>ï¼ˆlowerï¼‰<strong>çš„å—è®¾å¤‡</strong>ã€‚è¿™æ ·ï¼Œgeneric_make_requestæŠŠI/Oè¯·æ±‚å‘é€ç»™é«˜å±‚æ¬¡çš„å—è®¾å¤‡çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨é«˜å±‚å—è®¾å¤‡çš„make_request_fnï¼Œé«˜å±‚å—è®¾å¤‡åˆè¦è°ƒç”¨generic_make_requestï¼Œå°†è¯·æ±‚å‘é€ç»™ä½å±‚æ¬¡çš„å—è®¾å¤‡ã€‚è™½ç„¶å—è®¾å¤‡çš„å±‚æ¬¡ä¸ä¼šå¤ªå¤šï¼Œä½†æ˜¯å¯¹äºä»£ç generic_make_requestæ¥è®²ï¼Œè¿™å¯æ˜¯é€’å½’çš„è°ƒç”¨ï¼Œä¸€ä¸å°å¿ƒï¼Œå°±ä¼šé€’å½’è¿‡æ·±ï¼Œæ— æ³•æ­£å¸¸é€€å‡ºï¼Œè€Œä¸”å†…æ ¸æ ˆçš„å¤§å°åˆéå¸¸æœ‰é™ï¼Œæ‰€ä»¥è¦æ¯”è¾ƒå°å¿ƒã€‚</p><p>è¿™é‡Œä½ æ˜¯å¦ç†è§£äº†struct bio_list bio_list_on_stack[2]çš„åå­—ä¸ºä»€ä¹ˆå«stackå‘¢ï¼Ÿå…¶å®ï¼Œå°†æ ˆçš„æ“ä½œå˜æˆå¯¹äºé˜Ÿåˆ—çš„æ“ä½œï¼Œé˜Ÿåˆ—ä¸åœ¨æ ˆé‡Œé¢ï¼Œä¼šå¤§å¾ˆå¤šã€‚æ¯æ¬¡generic_make_requestè¢«å½“å‰ä»»åŠ¡è°ƒç”¨çš„æ—¶å€™ï¼Œå°†current-&gt;bio_listè®¾ç½®ä¸ºbio_list_on_stackï¼Œå¹¶åœ¨generic_make_requestçš„ä¸€å¼€å§‹å°±åˆ¤æ–­current-&gt;bio_listæ˜¯å¦ä¸ºç©ºã€‚å¦‚æœä¸ä¸ºç©ºï¼Œè¯´æ˜å·²ç»åœ¨generic_make_requestçš„è°ƒç”¨é‡Œé¢äº†ï¼Œå°±ä¸å¿…è°ƒç”¨make_request_fnè¿›è¡Œé€’å½’äº†ï¼Œç›´æ¥æŠŠè¯·æ±‚åŠ å…¥åˆ°bio_listé‡Œé¢å°±å¯ä»¥äº†ï¼Œè¿™å°±å®ç°äº†é€’å½’çš„åŠæ—¶é€€å‡ºã€‚</p><p>å¦‚æœcurrent-&gt;bio_listä¸ºç©ºï¼Œé‚£æˆ‘ä»¬å°±å°†current-&gt;bio_listè®¾ç½®ä¸ºbio_list_on_stackåï¼Œè¿›å…¥do-whileå¾ªç¯ï¼Œåšå’±ä»¬åˆ†æè¿‡çš„generic_make_requestçš„ä¸¤å¤§é€»è¾‘ã€‚ä½†æ˜¯ï¼Œå½“å‰çš„é˜Ÿåˆ—è°ƒç”¨make_request_fnçš„æ—¶å€™ï¼Œåœ¨make_request_fnçš„å…·ä½“å®ç°ä¸­ï¼Œä¼šç”Ÿæˆæ–°çš„bioã€‚è°ƒç”¨æ›´åº•å±‚çš„å—è®¾å¤‡ï¼Œä¹Ÿä¼šç”Ÿæˆæ–°çš„bioï¼Œéƒ½ä¼šæ”¾åœ¨bio_list_on_stackçš„é˜Ÿåˆ—ä¸­ï¼Œæ˜¯ä¸€ä¸ªè¾¹å¤„ç†è¿˜è¾¹åˆ›å»ºçš„è¿‡ç¨‹ã€‚</p><p>bio_list_on_stack[1] = bio_list_on_stack[0]è¿™ä¸€å¥åœ¨make_request_fnä¹‹å‰ï¼Œå°†ä¹‹å‰é˜Ÿåˆ—é‡Œé¢é—ç•™æ²¡æœ‰å¤„ç†çš„ä¿å­˜ä¸‹æ¥ï¼Œæ¥ç€bio_list_initå°†bio_list_on_stack[0]è®¾ç½®ä¸ºç©ºï¼Œç„¶åè°ƒç”¨make_request_fnï¼Œåœ¨make_request_fné‡Œé¢å¦‚æœæœ‰æ–°çš„bioç”Ÿæˆï¼Œéƒ½ä¼šåŠ åˆ°bio_list_on_stack[0]è¿™ä¸ªé˜Ÿåˆ—é‡Œé¢æ¥ã€‚</p><p>make_request_fnæ‰§è¡Œå®Œæ¯•åï¼Œå¯ä»¥æƒ³è±¡bio_list_on_stack[0]å¯èƒ½åˆå¤šäº†ä¸€äº›bioäº†ï¼Œæ¥ä¸‹æ¥çš„å¾ªç¯ä¸­è°ƒç”¨bio_list_popå°†bio_list_on_stack[0]ç§¯æ”’çš„bioæ‹¿å‡ºæ¥ï¼Œåˆ†åˆ«æ”¾åœ¨ä¸¤ä¸ªé˜Ÿåˆ—lowerå’Œsameä¸­ï¼Œé¡¾åæ€ä¹‰ï¼Œlowerå°±æ˜¯æ›´ä½å±‚æ¬¡çš„å—è®¾å¤‡çš„bioï¼Œsameæ˜¯åŒå±‚æ¬¡çš„å—è®¾å¤‡çš„bioã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬èƒ½å°†lowerã€sameä»¥åŠbio_list_on_stack[1] éƒ½å–å‡ºæ¥ï¼Œæ”¾åœ¨bio_list_on_stack[0]ç»Ÿä¸€è¿›è¡Œå¤„ç†ã€‚å½“ç„¶åº”è¯¥lowerä¼˜å…ˆäº†ï¼Œå› ä¸ºåªæœ‰åº•å±‚çš„å—è®¾å¤‡çš„I/Oåšå®Œäº†ï¼Œä¸Šå±‚çš„å—è®¾å¤‡çš„I/Oæ‰èƒ½åšå®Œã€‚</p><p>åˆ°è¿™é‡Œï¼Œgeneric_make_requestçš„é€»è¾‘æ‰ç®—è§£æå®Œæ¯•ã€‚å¯¹äºå†™å…¥çš„æ•°æ®æ¥è®²ï¼Œå…¶å®ä»…ä»…æ˜¯å°†bioè¯·æ±‚æ”¾åœ¨è¯·æ±‚é˜Ÿåˆ—ä¸Šï¼Œè®¾å¤‡é©±åŠ¨ç¨‹åºè¿˜æ²¡å¾€è®¾å¤‡é‡Œé¢å†™å‘¢ã€‚</p><h3>è¯·æ±‚çš„å¤„ç†</h3><p>è®¾å¤‡é©±åŠ¨ç¨‹åºå¾€è®¾å¤‡é‡Œé¢å†™ï¼Œè°ƒç”¨çš„æ˜¯è¯·æ±‚é˜Ÿåˆ—request_queueçš„å¦å¤–ä¸€ä¸ªå‡½æ•°request_fnã€‚å¯¹äºscsiè®¾å¤‡æ¥è®²ï¼Œè°ƒç”¨çš„æ˜¯scsi_request_fnã€‚</p><pre><code>static void scsi_request_fn(struct request_queue *q)\n\t__releases(q-&gt;queue_lock)\n\t__acquires(q-&gt;queue_lock)\n{\n\tstruct scsi_device *sdev = q-&gt;queuedata;\n\tstruct Scsi_Host *shost;\n\tstruct scsi_cmnd *cmd;\n\tstruct request *req;\n\n\n\t/*\n\t * To start with, we keep looping until the queue is empty, or until\n\t * the host is no longer able to accept any more requests.\n\t */\n\tshost = sdev-&gt;host;\n\tfor (;;) {\n\t\tint rtn;\n\t\t/*\n\t\t * get next queueable request.  We do this early to make sure\n\t\t * that the request is fully prepared even if we cannot\n\t\t * accept it.\n\t\t */\n\t\treq = blk_peek_request(q);\n......\n\t\t/*\n\t\t * Remove the request from the request list.\n\t\t */\n\t\tif (!(blk_queue_tagged(q) &amp;&amp; !blk_queue_start_tag(q, req)))\n\t\t\tblk_start_request(req);\n.....\n\t\tcmd = req-&gt;special;\n......\n\t\t/*\n\t\t * Dispatch the command to the low-level driver.\n\t\t */\n\t\tcmd-&gt;scsi_done = scsi_done;\n\t\trtn = scsi_dispatch_cmd(cmd);\n......\n\t}\n\treturn;\n......\n}\n</code></pre><p>åœ¨è¿™é‡Œé¢æ˜¯ä¸€ä¸ªforæ— é™å¾ªç¯ï¼Œä»request_queueä¸­è¯»å–requestï¼Œç„¶åå°è£…æ›´åŠ åº•å±‚çš„æŒ‡ä»¤ï¼Œç»™è®¾å¤‡æ§åˆ¶å™¨ä¸‹æŒ‡ä»¤ï¼Œå®æ–½çœŸæ­£çš„I/Oæ“ä½œã€‚</p><h2>æ€»ç»“æ—¶åˆ»</h2><p>è¿™ä¸€èŠ‚æˆ‘ä»¬è®²äº†å¦‚ä½•å°†å—è®¾å¤‡I/Oè¯·æ±‚é€è¾¾åˆ°å¤–éƒ¨è®¾å¤‡ã€‚</p><p>å¯¹äºå—è®¾å¤‡çš„I/Oæ“ä½œåˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§æ˜¯ç›´æ¥I/Oï¼Œå¦ä¸€ç§æ˜¯ç¼“å­˜I/Oã€‚æ— è®ºæ˜¯å“ªç§I/Oï¼Œæœ€ç»ˆéƒ½ä¼šè°ƒç”¨submit_bioæäº¤å—è®¾å¤‡I/Oè¯·æ±‚ã€‚</p><p>å¯¹äºæ¯ä¸€ç§å—è®¾å¤‡ï¼Œéƒ½æœ‰ä¸€ä¸ªgendiskè¡¨ç¤ºè¿™ä¸ªè®¾å¤‡ï¼Œå®ƒæœ‰ä¸€ä¸ªè¯·æ±‚é˜Ÿåˆ—ï¼Œè¿™ä¸ªé˜Ÿåˆ—æ˜¯ä¸€ç³»åˆ—çš„requestå¯¹è±¡ã€‚æ¯ä¸ªrequestå¯¹è±¡é‡Œé¢åŒ…å«å¤šä¸ªBIOå¯¹è±¡ï¼ŒæŒ‡å‘page cacheã€‚æ‰€è°“çš„å†™å…¥å—è®¾å¤‡ï¼ŒI/Oå°±æ˜¯å°†page cacheé‡Œé¢çš„æ•°æ®å†™å…¥ç¡¬ç›˜ã€‚</p><p>å¯¹äºè¯·æ±‚é˜Ÿåˆ—æ¥è®²ï¼Œè¿˜æœ‰ä¸¤ä¸ªå‡½æ•°ï¼Œä¸€ä¸ªå‡½æ•°å«make_request_fnå‡½æ•°ï¼Œç”¨äºå°†è¯·æ±‚æ”¾å…¥é˜Ÿåˆ—ã€‚submit_bioä¼šè°ƒç”¨generic_make_requestï¼Œç„¶åè°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚</p><p>å¦ä¸€ä¸ªå‡½æ•°å¾€å¾€åœ¨è®¾å¤‡é©±åŠ¨ç¨‹åºé‡Œå®ç°ï¼Œæˆ‘ä»¬å«request_fnå‡½æ•°ï¼Œå®ƒç”¨äºä»é˜Ÿåˆ—é‡Œé¢å–å‡ºè¯·æ±‚æ¥ï¼Œå†™å…¥å¤–éƒ¨è®¾å¤‡ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/c9/3c/c9f6a08075ba4eae3314523fa258363c.png?wh=2248*2023\" alt=\"\"></p><p>è‡³æ­¤ï¼Œæ•´ä¸ªå†™å…¥æ–‡ä»¶çš„è¿‡ç¨‹æ‰ç®—å®Œå…¨ç»“æŸã€‚è¿™çœŸæ˜¯ä¸ªå¤æ‚çš„è¿‡ç¨‹ï¼Œæ¶‰åŠç³»ç»Ÿè°ƒç”¨ã€å†…å­˜ç®¡ç†ã€æ–‡ä»¶ç³»ç»Ÿå’Œè¾“å…¥è¾“å‡ºã€‚è¿™è¶³ä»¥è¯´æ˜ï¼Œæ“ä½œç³»ç»ŸçœŸçš„æ˜¯ä¸€ä¸ªéå¸¸å¤æ‚çš„ä½“ç³»ï¼Œç¯ç¯ç›¸æ‰£ï¼Œéœ€è¦åˆ†å±‚æ¬¡å±‚å±‚å±•å¼€æ¥å­¦ä¹ ã€‚</p><p>åˆ°è¿™é‡Œï¼Œä¸“æ å·²ç»è¿‡åŠäº†ï¼Œä½ åº”è¯¥èƒ½å‘ç°ï¼Œå¾ˆå¤šæˆ‘ä¹‹å‰è¯´â€œåé¢ä¼šç»†è®²â€çš„ä¸œè¥¿ï¼Œç°åœ¨æ­£åœ¨ä¸€ç‚¹ä¸€ç‚¹è§£é‡Šæ¸…æ¥šï¼Œè€Œæ–‡ä¸­è¶Šæ¥è¶Šå¤šå‡ºç°â€œå‰é¢æˆ‘ä»¬è®²è¿‡â€çš„å­—çœ¼ï¼Œä½ æ˜¯å¦å½“æ—¶å­¦ä¹ å‰é¢çŸ¥è¯†çš„æ—¶å€™ï¼Œæ²¡æœ‰åœ¨æ„ï¼Œå¯¼è‡´å­¦ä¹ åé¢çš„çŸ¥è¯†äº§ç”Ÿå›°æƒ‘äº†å‘¢ï¼Ÿæ²¡å…³ç³»ï¼ŒåŠæ—¶å€’å›å»å¤ä¹ ï¼Œå†å›è¿‡å¤´å»çœ‹ï¼Œå½“åˆå­¦è¿‡çš„å¾ˆå¤šçŸ¥è¯†ä¼šå˜å¾—æ¸…æ™°å¾ˆå¤šã€‚</p><h2>è¯¾å ‚ç»ƒä¹ </h2><p>ä½ çŸ¥é“å¦‚ä½•æŸ¥çœ‹ç£ç›˜è°ƒåº¦ç®—æ³•ã€ä¿®æ”¹ç£ç›˜è°ƒåº¦ç®—æ³•ä»¥åŠI/Oé˜Ÿåˆ—çš„é•¿åº¦å—ï¼Ÿ</p><p>æ¬¢è¿ç•™è¨€å’Œæˆ‘åˆ†äº«ä½ çš„ç–‘æƒ‘å’Œè§è§£ ï¼Œä¹Ÿæ¬¢è¿å¯ä»¥æ”¶è—æœ¬èŠ‚å†…å®¹ï¼Œåå¤ç ”è¯»ã€‚ä½ ä¹Ÿå¯ä»¥æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹ï¼Œå’Œä»–ä¸€èµ·å­¦ä¹ å’Œè¿›æ­¥ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/8c/37/8c0a95fa07a8b9a1abfd394479bdd637.jpg?wh=1110*659\" alt=\"\"></p>","neighbors":{"left":{"article_title":"34 | å—è®¾å¤‡ï¼ˆä¸Šï¼‰ï¼šå¦‚ä½•å»ºç«‹ä»£ç†å•†é”€å”®æ¨¡å¼ï¼Ÿ","id":100942},"right":{"article_title":"36 | è¿›ç¨‹é—´é€šä¿¡ï¼šé‡åˆ°å¤§é¡¹ç›®éœ€è¦é¡¹ç›®ç»„ä¹‹é—´çš„åˆä½œæ‰è¡Œ","id":101719}},"comments":[{"had_liked":false,"id":106068,"user_name":"LeonğŸ“·","can_delete":false,"product_type":"c1","uid":1219496,"ip_address":"","ucode":"B9BBD1EFAAE5A2","user_header":"https://static001.geekbang.org/account/avatar/00/12/9b/a8/6a391c66.jpg","comment_is_top":false,"comment_ctime":1561163872,"is_pvip":false,"replies":[{"id":"48873","content":"æ˜¯çš„","user_name":"ä½œè€…å›å¤","comment_id":106068,"uid":"1001590","ip_address":"","utype":1,"ctime":1567502465,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"70280640608","product_id":100024701,"comment_content":"æ–‡ä»¶ç³»ç»Ÿä¸­çš„page_cacheå¯¹åº”é€»è¾‘ä¸Šçš„å—çš„æ¦‚å¿µï¼Œå°†page_cacheæ‰“åŒ…æˆbioé€’äº¤ç»™é€šç”¨å—è®¾å¤‡å±‚ï¼Œé€šç”¨å—è®¾å¤‡å±‚å°†å¤šä¸ªbioæ‰“åŒ…æˆä¸€ä¸ªè¯·æ±‚request, å°½é‡æŠŠbioå¯¹åº”çš„sectorä¸´è¿‘çš„æ•°æ®åˆå¹¶ï¼Œæäº¤ç»™å—è®¾å¤‡è°ƒåº¦å±‚ï¼Œå—è®¾å¤‡è°ƒåº¦å±‚å°±æ˜¯æŠŠå„ä¸ªrequestå½“æˆæ®µæäº¤ç»™è®¾å¤‡é©±åŠ¨ç¨‹åºï¼Œå› ä¸ºè®¾å¤‡é©±åŠ¨ç¨‹åºåªè¯†åˆ«æ®µï¼Œä¹Ÿå°±æ˜¯è¯´é€šç”¨å—è®¾å¤‡å±‚æ£è…¾çš„å…¶å®å°±æ˜¯æŠŠbioå¯¹åº”çš„é¡µæ¡†å’Œåœ¨ç£ç›˜ä¸­å¯¹åº”çš„sectorè¿›è¡Œåˆå¹¶çš„è¿‡ç¨‹ï¼Œè°ƒåº¦å±‚åªè´Ÿè´£æŠŠåˆå¹¶çš„requestæ”¾è¿›é˜Ÿåˆ—ï¼Œç”¨è°ƒåº¦ç®—æ³•ä¸‹å‘ç»™é©±åŠ¨ç¨‹åºå¤„ç†ï¼Œå…¶å®æ‰€æœ‰å¤æ‚çš„åˆå¹¶æ“ä½œä»¥åŠå†…å­˜å’Œç£ç›˜æ‰‡åŒºçš„å¯¹åº”å…³ç³»éƒ½æ˜¯é€šè¿‡å—è®¾å¤‡å±‚åšäº†ï¼Œè€å¸ˆï¼Œå¯ä»¥è¿™ä¹ˆç†è§£å§","like_count":17,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":454934,"discussion_content":"æ˜¯çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567502465,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":136806,"user_name":"hello","can_delete":false,"product_type":"c1","uid":1510495,"ip_address":"","ucode":"C6FC61A90F202B","user_header":"https://static001.geekbang.org/account/avatar/00/17/0c/5f/4cbcbfb9.jpg","comment_is_top":false,"comment_ctime":1569513223,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"31634284295","product_id":100024701,"comment_content":"å¤ªçˆ½äº†ï¼Œå¬äº†ä¸‰å››éè¿™èŠ‚è¯¾ï¼Œä»¥å‰ä¸€ç›´æ‹…å¿ƒioåœ¨å†…æ ¸å†…éƒ¨ä¼šå‘ç”Ÿå¤šæ¬¡æ‹·è´ï¼Œå¬å®Œå‘ç°å¹¶æ²¡æœ‰ã€‚ä¸‹ä¸€æ¬¡æˆ‘ä¸€å®šè¦è¾¹è¯»æºç è¾¹å¬ã€‚","like_count":7},{"had_liked":false,"id":106452,"user_name":"djfhchdh","can_delete":false,"product_type":"c1","uid":1484184,"ip_address":"","ucode":"E71D75328CE398","user_header":"https://static001.geekbang.org/account/avatar/00/16/a5/98/a65ff31a.jpg","comment_is_top":false,"comment_ctime":1561305640,"is_pvip":false,"replies":[{"id":"38646","content":"èµ","user_name":"ä½œè€…å›å¤","comment_id":106452,"uid":"1001590","ip_address":"","utype":1,"ctime":1561420019,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"27331109416","product_id":100024701,"comment_content":"&#47;sys&#47;block&#47;xvda&#47;queue&#47;scheduler ç£ç›˜çš„è°ƒåº¦ç®—æ³•ï¼Œä¸´æ—¶ä¿®æ”¹ï¼šecho noop &gt; &#47;sys&#47;block&#47;xvda&#47;queue&#47;schedulerï¼Œæ°¸ä¹…ä¿®æ”¹å°±éœ€è¦ä¿®æ”¹å†…æ ¸å‚æ•°ï¼Œç„¶åé‡å¯ã€‚<br>iostat -d  -x ä¸­çš„avgqu-szæ˜¯å¹³å‡I&#47;Oé˜Ÿåˆ—é•¿åº¦ã€‚<br>","like_count":6,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":455095,"discussion_content":"èµ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561420019,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":104601,"user_name":"LeonğŸ“·","can_delete":false,"product_type":"c1","uid":1219496,"ip_address":"","ucode":"B9BBD1EFAAE5A2","user_header":"https://static001.geekbang.org/account/avatar/00/12/9b/a8/6a391c66.jpg","comment_is_top":false,"comment_ctime":1560782012,"is_pvip":false,"replies":[{"id":"49023","content":"æ˜¯çš„","user_name":"ä½œè€…å›å¤","comment_id":104601,"uid":"1001590","ip_address":"","utype":1,"ctime":1567580353,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"23035618492","product_id":100024701,"comment_content":"é‚£ä¸ªé˜Ÿåˆ—ï¼Œé˜Ÿå¤´å’Œé˜Ÿå°¾çš„åˆå¹¶éƒ½æ˜¯ä¸ºäº†æ‰€è°“çš„é¡ºåºå†™ï¼Œå‡å°‘æœºæ¢°ç¡¬ç›˜å¯»å€æ¶ˆè€—å§ï¼Œèƒ½èµ¶ä¸Šå°±ä¸ŠåŒä¸€è¾†è½¦ï¼Œèµ¶ä¸ä¸Šè‡ªå·±å«ä¸€è¾†è½¦ç­‰æ»¡äº†å†èµ°ï¼Œä½†æ˜¯ä¹Ÿæ˜¯æœ‰è¶…æ—¶ç­‰å¾…æ—¶é—´çš„ï¼Œå¯ä»¥è¿™ä¹ˆç†è§£å§","like_count":6,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":454338,"discussion_content":"æ˜¯çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567580353,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":104360,"user_name":"å®‰æ’","can_delete":false,"product_type":"c1","uid":1260026,"ip_address":"","ucode":"F78CFA9624CAEF","user_header":"https://static001.geekbang.org/account/avatar/00/13/39/fa/a7edbc72.jpg","comment_is_top":false,"comment_ctime":1560736822,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"18740606006","product_id":100024701,"comment_content":"çœ‹äº†ä¸€ç‚¹å„¿å…¶å®ƒçš„èµ„æ–™ï¼Œå¤§æ¦‚äº†è§£äº†ä¸€ä¸‹ï¼Œæœ‰ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š1ã€request_fnæ˜¯åœ¨unplugæ³„æµçš„æ—¶å€™è°ƒç”¨ï¼ˆä¹Ÿå°±æ˜¯é˜Ÿåˆ—é‡Œé¢çš„è¯·æ±‚è¾¾åˆ°ä¸€å®šçš„æ•°é‡ï¼‰  2ã€æˆ–è€…æ˜¯ç”±å®šæ—¶å™¨è§¦å‘ï¼Œä¹Ÿå°±æ˜¯å³ä½¿é˜Ÿåˆ—é‡Œé¢çš„è¯·æ±‚å¾ˆå°‘ï¼Œä½†æ˜¯ä¹Ÿä¸èƒ½æ— é™æœŸçš„ä¸æ‰§è¡Œå®ƒä»¬ï¼Œæ‰€ä»¥åœ¨å®šæ—¶å™¨è¶…æ—¶åä¼šè°ƒç”¨request_fn 3ã€æˆ–è€…åœ¨æ·»åŠ requestè¿›è¡Œåˆå¹¶çš„æ—¶å€™ï¼Œåˆ¤æ–­ä¸€ä¸‹æ˜¯å“ªç§åˆå¹¶æ–¹å¼ï¼Œå¦‚æœæ˜¯åå‘åˆå¹¶å°±ä¼šç«‹å³è°ƒç”¨requset_fnã€‚<br>ä¸çŸ¥é“è¿™æ ·ç†è§£çš„å¯¹ä¸å¯¹ï¼Ÿ","like_count":4},{"had_liked":false,"id":104747,"user_name":"å®‰æ’","can_delete":false,"product_type":"c1","uid":1260026,"ip_address":"","ucode":"F78CFA9624CAEF","user_header":"https://static001.geekbang.org/account/avatar/00/13/39/fa/a7edbc72.jpg","comment_is_top":false,"comment_ctime":1560826581,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10150761173","product_id":100024701,"comment_content":"         make_request_fnè¢«åˆå§‹åŒ–æˆäº†blk_queue_bioå‡½æ•°ã€‚submit_bioä¼šè°ƒç”¨åˆ°generic_make_requestï¼Œç„¶åè¿›ä¸€æ­¥è°ƒç”¨åˆ°make_request_fnï¼Œä¹Ÿå°±æ˜¯blk_queue_bioã€‚åœ¨blk_queue_bioé‡Œé¢å…¶å®æ˜¯å…ˆå°è¯•å°†bioåˆå¹¶åˆ°å½“å‰è¿›ç¨‹çš„plug_listé‡Œé¢çš„requestï¼Œå¦‚æœå¯ä»¥åˆå¹¶ï¼Œåˆ™åˆå¹¶åç›´æ¥è¿”å›äº†ï¼Œå¦‚æœä¸èƒ½åˆå¹¶ï¼Œåˆ™æ¥ç€å‘ç£ç›˜è®¾å¤‡çš„request_queueä¸­åˆå¹¶ï¼Œå‘request_queueä¸­åˆå¹¶çš„æ—¶å€™ä¸€å®šä¼šæˆåŠŸï¼ˆå› ä¸ºå³ä½¿ä¸èƒ½åˆå¹¶ä¹Ÿä¼šæ–°ç”Ÿæˆä¸€ä¸ªrequestï¼‰ã€‚è€Œæ¯ä¸ªè¿›ç¨‹çš„plug_listé‡Œé¢çš„requestä¹Ÿä¼šåœ¨é€‚å½“çš„æ—¶å€™å°±è¡Œæ³„æµï¼Œæ³„æµçš„æ—¶å€™ä¼šè°ƒç”¨åˆ°ç£ç›˜è®¾å¤‡çš„request_queueé‡Œé¢çš„ç”µæ¢¯æˆå‘˜çš„elevator_add_req_fnï¼Œè¿™ä¸ªå‡½æ•°å°±æ˜¯è®²plug_listé‡Œé¢çš„requeståŠ å…¥åˆ°request_queueé‡Œé¢çš„ç”µæ¢¯é˜Ÿåˆ—é‡Œï¼Œè¿›è¡Œæ›´è¿›ä¸€æ­¥çš„åˆå¹¶ã€‚<br>        è®¾å¤‡é©±åŠ¨ä¼šè°ƒç”¨request_queueçš„request_fnï¼Œå¹³æ—¶å†™å—è®¾å¤‡é©±åŠ¨ä¹Ÿå°±æ˜¯ç”³è¯·ä¸€ä¸ªrequest_queueï¼Œç„¶åè°ƒç”¨ä¸€äº›å†…æ ¸apiåˆå§‹åŒ–è¿™ä¸ªrequest_queueï¼Œå¹¶ä¸”å®ç°è‡ªå·±çš„request_fnå‡½æ•°ï¼Œrequest_fnä¼šè°ƒç”¨blk_peek_requestä»request_queueçš„queue_headæˆå‘˜å–å‡ºrequestï¼Œå¹¶è½¬åŒ–ä¸ºæ›´åº•å±‚çš„æŒ‡ä»¤æ¥æ‰§è¡Œï¼Œå¦‚æœå‘ç°queue_headä¸ºç©ºï¼Œåˆ™ä¼šè°ƒç”¨request_queueçš„elevator_dispatch_fnåˆ†å‘requestã€‚","like_count":3},{"had_liked":false,"id":249719,"user_name":"Yakmoz","can_delete":false,"product_type":"c1","uid":1257502,"ip_address":"","ucode":"1FA18A711457A0","user_header":"https://static001.geekbang.org/account/avatar/00/13/30/1e/0b05530d.jpg","comment_is_top":false,"comment_ctime":1600769201,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5895736497","product_id":100024701,"comment_content":"è¿™é‡Œçš„page_cacheå’Œæ–‡ä»¶ç³»ç»Ÿé‡Œçš„page_cacheæ˜¯ä¸æ˜¯ä¸ä¸€æ ·çš„? ä¸å¤ªæ˜ç™½,ä¸ºä»€ä¹ˆç›´æ¥IO æäº¤çš„æ—¶å€™ä¹Ÿä¼šæ“ä½œpage_cache","like_count":1},{"had_liked":false,"id":112411,"user_name":"çœ­ä¸œäº®","can_delete":false,"product_type":"c1","uid":1449336,"ip_address":"","ucode":"E9F629828B4E55","user_header":"https://wx.qlogo.cn/mmopen/vi_32/7dSgJbCaoS5CnCI4toP6mPueW1f0eQ0Ua9LxymPqJjH49cNYkJK0s9NcvrapPU4gvZb12j2u3l2A8Rw5onlJMQ/132","comment_is_top":false,"comment_ctime":1562729393,"is_pvip":false,"replies":[{"id":"46718","content":"èµ","user_name":"ä½œè€…å›å¤","comment_id":112411,"uid":"1001590","ip_address":"","utype":1,"ctime":1566386238,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"5857696689","product_id":100024701,"comment_content":"æŸ¥çœ‹ç£ç›˜è°ƒåº¦ç®—æ³•<br>cat &#47;sys&#47;block&#47;sda&#47;queue&#47;scheduler<br>","like_count":1,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457722,"discussion_content":"èµ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566386238,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":105114,"user_name":"èš‚èšå†…æ¨+v","can_delete":false,"product_type":"c1","uid":1050508,"ip_address":"","ucode":"24B10AEE54B3FD","user_header":"https://static001.geekbang.org/account/avatar/00/10/07/8c/0d886dcc.jpg","comment_is_top":false,"comment_ctime":1560921172,"is_pvip":false,"replies":[{"id":"49014","content":"ä¼šå‘€ï¼Œflushå°±ä¸ä¼š","user_name":"ä½œè€…å›å¤","comment_id":105114,"uid":"1001590","ip_address":"","utype":1,"ctime":1567579738,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"5855888468","product_id":100024701,"comment_content":"ä¼šä¸ä¼šæ–­ç”µä¸¢å¤±æ•°æ®å‘¢ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":454563,"discussion_content":"ä¼šå‘€ï¼Œflushå°±ä¸ä¼š","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567579738,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":104274,"user_name":"å®‰æ’","can_delete":false,"product_type":"c1","uid":1260026,"ip_address":"","ucode":"F78CFA9624CAEF","user_header":"https://static001.geekbang.org/account/avatar/00/13/39/fa/a7edbc72.jpg","comment_is_top":false,"comment_ctime":1560704750,"is_pvip":false,"replies":[{"id":"49039","content":"ä¼šè°ƒç”¨__blk_run_queueï¼Œé‡Œé¢è°ƒç”¨request_fn","user_name":"ä½œè€…å›å¤","comment_id":104274,"uid":"1001590","ip_address":"","utype":1,"ctime":1567583986,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"5855672046","product_id":100024701,"comment_content":"å¾€è®¾å¤‡é‡Œé¢å†™çš„æ—¶å€™è°ƒç”¨çš„æ˜¯request_fnï¼Œè¿™ä¸ªå‡½æ•°æ˜¯è°æ¥è°ƒç”¨çš„å‘¢ï¼Ÿè§¦å‘è¿™ä¸ªè°ƒç”¨çš„æ—¶æœºæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿè¿˜æ˜¯è¯´è¯·æ±‚ä¸€æ—¦è¿›å…¥é˜Ÿåˆ—å°±ä¼šç«‹å³å†™å…¥ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":454197,"discussion_content":"ä¼šè°ƒç”¨__blk_run_queueï¼Œé‡Œé¢è°ƒç”¨request_fn","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567583986,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":333057,"user_name":"specter","can_delete":false,"product_type":"c1","uid":1293928,"ip_address":"","ucode":"0E7F6A7FD55DB7","user_header":"https://static001.geekbang.org/account/avatar/00/13/be/68/8c0796be.jpg","comment_is_top":false,"comment_ctime":1644033188,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1644033188","product_id":100024701,"comment_content":"åˆ˜è€å¸ˆï¼Œæˆ‘æ˜¯ä¸€ä¸ªè€å¸ˆï¼Œæ‚¨ç”»çš„å›¾å®åœ¨æ˜¯å¤ªå¥½äº†ï¼Œæˆ‘èƒ½åœ¨è®²è¯¾çš„æ—¶å€™å€Ÿç”¨æ‚¨çš„å›¾å—ï¼Ÿ","like_count":0},{"had_liked":false,"id":324457,"user_name":"TableBear","can_delete":false,"product_type":"c1","uid":1673990,"ip_address":"","ucode":"A2C0562EEA2725","user_header":"https://static001.geekbang.org/account/avatar/00/19/8b/06/fb3be14a.jpg","comment_is_top":false,"comment_ctime":1638441097,"is_pvip":true,"discussion_count":0,"race_medal":5,"score":"1638441097","product_id":100024701,"comment_content":"å¥½æ™•å•Š","like_count":1},{"had_liked":false,"id":300551,"user_name":"chaoxifuchen","can_delete":false,"product_type":"c1","uid":1292330,"ip_address":"","ucode":"95DCC5C4994F68","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/VX0ib4CV0m7fwxB2xFcIJaYYWXXpfxxYbfBErqBej9395hgZszqS3dz9bThCxOuFfJ8Xibx9HbdNmZJwL5m33wIw/132","comment_is_top":false,"comment_ctime":1625215934,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1625215934","product_id":100024701,"comment_content":"è€å¸ˆï¼Œæœ‰ä¸ªç–‘é—®ï¼Œä»€ä¹ˆæƒ…å†µä¸‹ä¼šç”¨åˆ°ç›´æ¥ I&#47;Oï¼Œè¿˜æœ‰å‡è®¾ä¸€ä¸ªé¡µé‡Œåªæœ‰1ä¸ªå­—èŠ‚æ”¹å˜äº†ï¼Œä»page_cacheå¾€ç£ç›˜é‡Œåˆ·è„é¡µæ—¶ä¹Ÿæ˜¯é‡æ–°å†™æ•´ä¸ªé¡µ4kå­—èŠ‚å—ï¼Ÿ","like_count":0},{"had_liked":false,"id":270532,"user_name":"--","can_delete":false,"product_type":"c1","uid":1075167,"ip_address":"","ucode":"A262E3991E69DA","user_header":"https://static001.geekbang.org/account/avatar/00/10/67/df/8b85d0d9.jpg","comment_is_top":false,"comment_ctime":1609152057,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1609152057","product_id":100024701,"comment_content":"è¡¥å……çŸ¥è¯†ç‚¹ï¼šå—è®¾å¤‡å¤šé˜Ÿåˆ—æ¶æ„ã€‚å†…æ ¸åœ¨5.0ä¹‹åå·²ç»å®Œå…¨ä»å•é˜Ÿåˆ—æ¶æ„è¿ç§»åˆ°äº†å¤šé˜Ÿåˆ—æ¶æ„ï¼ŒæŒ‰ç…§è€å¸ˆçš„æ€è·¯å»äº†è§£å¤šé˜Ÿåˆ—æ¶æ„è¿˜æ˜¯æŒºæœ‰æ„æ€çš„ã€‚","like_count":0},{"had_liked":false,"id":167239,"user_name":"Paul Shan","can_delete":false,"product_type":"c1","uid":1593140,"ip_address":"","ucode":"32D99989028284","user_header":"","comment_is_top":false,"comment_ctime":1577743689,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1577743689","product_id":100024701,"comment_content":"è¯·é—®è€å¸ˆï¼Œdo_direct_IO é‡Œé¢æ¯ä¸€é¡µ(page)å¯èƒ½å¯¹åº”å¤šä¸ªå—ï¼ˆblockï¼‰ï¼Œæ˜¯ä¸æ˜¯ç°å®ä¸­å¤§å¤šæ•°æƒ…å†µé¡µå’Œå—ç›¸ç­‰ï¼ˆ4Kï¼‰ï¼Œä¹Ÿå°±æ˜¯æ¯é¡µä¹Ÿå°±å¾ªç¯ä¸€æ¬¡ã€‚æ˜¯ä¸æ˜¯ä»è¿™é‡Œä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œé¡µçš„å¤§å°è™½ç„¶å¯ä»¥é…ç½®ï¼Œä¹Ÿå¿…é¡»æ˜¯4Kçš„æ•´æ•°å€ï¼Œå—çš„å¤§å°åº”è¯¥æ˜¯ä¸å¯é…ç½®çš„ï¼ˆæ°¸è¿œ4Kï¼‰ã€‚","like_count":0},{"had_liked":false,"id":129943,"user_name":"æ¸¸å¼‹äº‘ç«¯","can_delete":false,"product_type":"c1","uid":1208637,"ip_address":"","ucode":"A960E8F5AA25B9","user_header":"https://static001.geekbang.org/account/avatar/00/12/71/3d/da8dc880.jpg","comment_is_top":false,"comment_ctime":1567331910,"is_pvip":false,"replies":[{"id":"48702","content":"è¿˜æ˜¯éœ€è¦è®¾å¤‡é©±åŠ¨å±‚çš„","user_name":"ä½œè€…å›å¤","comment_id":129943,"uid":"1001590","ip_address":"","utype":1,"ctime":1567479566,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"1567331910","product_id":100024701,"comment_content":"è€å¸ˆï¼Œæ˜¯å¦å¯ä»¥è®¤ä¸ºç›´æ¥ IOæ‰§è¡Œå®Œæˆåï¼Œæ•°æ®å°±æ˜¯ä¸‹ç›˜çš„ï¼Œè¿˜æ˜¯ä¸ä¸€å®šï¼Œè¿˜æœ‰é©±åŠ¨å±‚ä»¥åŠç£ç›˜ç¼“å­˜ç­‰å› ç´ ã€‚","like_count":0,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465726,"discussion_content":"è¿˜æ˜¯éœ€è¦è®¾å¤‡é©±åŠ¨å±‚çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567479566,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":105282,"user_name":"å®‰æ’","can_delete":false,"product_type":"c1","uid":1260026,"ip_address":"","ucode":"F78CFA9624CAEF","user_header":"https://static001.geekbang.org/account/avatar/00/13/39/fa/a7edbc72.jpg","comment_is_top":false,"comment_ctime":1560954691,"is_pvip":false,"replies":[{"id":"49009","content":"å–å‡ºæ¥ä¹‹åï¼ŒåŸºæœ¬å°±æ˜¯é¢å‘è®¾å¤‡çš„æ“ä½œäº†ã€‚","user_name":"ä½œè€…å›å¤","comment_id":105282,"uid":"1001590","ip_address":"","utype":1,"ctime":1567579543,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"1560954691","product_id":100024701,"comment_content":"è€å¸ˆï¼Œå¸Œæœ›åœ¨ç­”ç–‘ç¯‡èƒ½è®²ä¸€è®²request_fnå–å‡ºè¯·æ±‚ä¹‹åçš„å…·ä½“æ‰§è¡Œè¿‡ç¨‹ï¼Œå…·ä½“çš„æ‰§è¡Œæ˜¯ä¸æ˜¯å’Œblock_deviceæœ‰å…³ï¼Œç£ç›˜çš„æœ€åº•å±‚çš„æ“ä½œæ˜¯ä¸æ˜¯éƒ½åœ¨block_deviceä¸­ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":454620,"discussion_content":"å–å‡ºæ¥ä¹‹åï¼ŒåŸºæœ¬å°±æ˜¯é¢å‘è®¾å¤‡çš„æ“ä½œäº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567579543,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":104757,"user_name":"å®‰æ’","can_delete":false,"product_type":"c1","uid":1260026,"ip_address":"","ucode":"F78CFA9624CAEF","user_header":"https://static001.geekbang.org/account/avatar/00/13/39/fa/a7edbc72.jpg","comment_is_top":false,"comment_ctime":1560828149,"is_pvip":false,"replies":[{"id":"49022","content":"ä¸ä¼šçš„","user_name":"ä½œè€…å›å¤","comment_id":104757,"uid":"1001590","ip_address":"","utype":1,"ctime":1567580335,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"1560828149","product_id":100024701,"comment_content":"ç›´æ¥è¯»å†™è£¸è®¾å¤‡ä¸ä¼šèµ°æ–‡ä»¶ç³»ç»Ÿï¼Œé‚£è¿˜ä¼šèµ°é€šç”¨å—å±‚å—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":454411,"discussion_content":"ä¸ä¼šçš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567580335,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":104322,"user_name":"çŸ³ç»´åº·","can_delete":false,"product_type":"c1","uid":1067564,"ip_address":"","ucode":"E39ED8416B2C01","user_header":"https://static001.geekbang.org/account/avatar/00/10/4a/2c/f8451d77.jpg","comment_is_top":false,"comment_ctime":1560732978,"is_pvip":false,"replies":[{"id":"49040","content":"åé¢ä¼šåŠ å›å»çš„","user_name":"ä½œè€…å›å¤","comment_id":104322,"uid":"1001590","ip_address":"","utype":1,"ctime":1567584004,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"1560732978","product_id":100024701,"comment_content":"bio_list_merge(&amp;bio_list_on_stack[0], &amp;lower);<br>bio_list_merge(&amp;bio_list_on_stack[0], &amp;same);<br>bio_list_merge(&amp;bio_list_on_stack[0], &amp;bio_list_on_stack[1]);<br><br>è¯·é—®è¿™äº›åŠ åˆ°bio_list_on_stack[0]ä¸Šçš„bioæ˜¯åœ¨ä»€ä¹ˆæ—¶å€™è¢«å¤„ç†çš„ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":454224,"discussion_content":"åé¢ä¼šåŠ å›å»çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567584004,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}