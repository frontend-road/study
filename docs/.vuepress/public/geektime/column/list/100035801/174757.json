{"id":174757,"title":"32 |  压力测试：怎样设计全链路压力测试平台？","content":"<p>你好，我是唐扬。</p><p>经过两节课的学习，我们已经搭建了服务端和客户端的监控，通过监控的报表和一些报警规则的设置，你可以实时地跟踪和解决垂直电商系统中出现的问题了。不过，你不能掉以轻心，因为监控只能发现目前系统中已经存在的问题，对于未来可能发生的性能问题是无能为力的。</p><p>一旦你的系统流量有大的增长，比如类似“双十一”的流量，那么你在面临性能问题时就可能会手足无措。为了解决后顾之忧，你需要了解在流量增长若干倍的时候，系统的哪些组件或者服务会成为整体系统的瓶颈点，这时你就需要做一次全链路的压力测试。</p><p>那么，什么是压力测试呢？要如何来做全链路的压测呢？这两个问题就是本节课重点讲解的内容。</p><h2>什么是压力测试</h2><p>压力测试（简称为压测）这个名词儿，你在业界的分享中一定听过很多次，当然了，你也可能在项目的研发过程中做过压力测试，所以，对于你来说，压力测试并不陌生。</p><p>不过我想让你回想一下，自己是怎么做压力测试的？是不是像很多同学一样：先搭建一套与正式环境功能相同的测试环境，并且导入或者生成一批测试数据，然后在另一台服务器，启动多个线程并发地调用需要压测的接口（接口的参数一般也会设置成相同的，比如，想要压测获取商品信息的接口，那么压测时会使用同一个商品ID）。最后，通过统计访问日志或者查看测试环境的监控系统，来记录最终压测QPS是多少之后，直接交差？</p><!-- [[[read_end]]] --><p>这么做压力测试其实是不正确的，<strong>错误之处主要有以下几点。</strong></p><p>1.首先，做压力测试时，最好使用线上的数据和线上的环境。因为，你无法确定自己搭建的测试环境与正式环境的差异，是否会影响到压力测试的结果。</p><p>2.其次，压力测试时不能使用模拟的请求而是要使用线上的流量。你可以通过拷贝流量的方式，把线上流量拷贝一份到压力测试环境。因为模拟流量的访问模型和线上流量相差很大，会对压力测试的结果产生比较大的影响。</p><p>比如，你在获取商品信息的时候，线上的流量会获取不同商品的数据，这些商品的数据有的命中了缓存，有的没有命中缓存。如果使用同一个商品ID来做压力测试，那么只有第一次请求没有命中缓存，而在请求之后会将数据库中的数据回种到缓存，后续的请求就一定会命中缓存了，这种压力测试的数据就不具备参考性了。</p><p>3.不要从一台服务器发起流量，这样很容易达到这台服务器性能瓶颈，从而导致压力测试的QPS上不去，最终影响压力测试的结果。而且，为了尽量真实地模拟用户请求，我们倾向于把流量产生的机器放在离用户更近的位置，比如放在CDN节点上。如果没有这个条件，那么可以放在不同的机房中，这样可以尽量保证压力测试结果的真实性。</p><p>之所以有很多同学出现这个问题，主要是对压力测试的概念没有完全理解，以为只要是使用多个线程并发的请求服务接口，就算是对接口进行压力测试了。</p><p><strong>那么究竟什么是压力测试呢？</strong>压力测试指的是在高并发大流量下进行的测试，测试人员可以通过观察系统在峰值负载下的表现，从而找到系统中存在的性能隐患。</p><p>与监控一样，压力测试是一种常见的发现系统中存在问题的方式，也是保障系统可用性和稳定性的重要手段。而在压力测试的过程中，我们不能只针对某一个核心模块来做压测，而需要将接入层、所有后端服务、数据库、缓存、消息队列、中间件以及依赖的第三方服务系统及其资源，都纳入压力测试的目标之中。因为，一旦用户的访问行为增加，包含上述组件服务的整个链路都会受到不确定的大流量的冲击。因此，它们都需要依赖压力测试来发现可能存在的性能瓶颈，<strong>这种针对整个调用链路执行的压力测试也称为“全链路压测”。</strong></p><p>由于在互联网项目中，功能迭代的速度很快，系统的复杂性也变得越来越高，新增加的功能和代码很可能会成为新的性能瓶颈点。也许半年前做压力测试时，单台机器可以承担每秒1000次请求，现在很可能就承担每秒800次请求了。所以，压力测试应该作为系统稳定性保障的常规手段，周期性地进行。</p><p>但是，通常做一次全链路压力测试，需要联合DBA、运维、依赖服务方、中间件架构等多个团队，一起协同进行，无论是人力成本还是沟通协调的成本都比较高。同时，在压力测试的过程中，如果没有很好的监控机制，那么还会对线上系统造成不利的影响。<strong>为了解决这些问题，我们需要搭建一套自动化的全链路压测平台来降低成本和风险。</strong></p><h2>如何搭建全链路压测平台</h2><p>搭建全链路压测平台，主要有两个关键点。</p><p>一点是流量的隔离。由于压力测试是在正式环境进行，所以需要区分压力测试流量和正式流量，这样可以针对压力测试的流量做单独的处理。</p><p>另一点是风险的控制。也就是尽量避免压力测试对于正常访问用户的影响。因此，一般来说全链路压测平台需要包含以下几个模块：</p><ul>\n<li>流量构造和产生模块；</li>\n<li>压测数据隔离模块；</li>\n<li>系统健康度检查和压测流量干预模块。</li>\n</ul><p>整体压测平台的架构图可以是下面这样的：</p><p><img src=\"https://static001.geekbang.org/resource/image/15/ff/1552e524d495bb7e129405578b7907ff.jpg?wh=1142*557\" alt=\"\"></p><p>为了让你能够更清晰地了解每一个模块是如何实现的，方便你来设计适合自身业务的全链路压测平台，我会对压测平台的每一个模块做更细致的介绍。先来看看压力测试的流量是如何产生的。</p><h4>压测数据的产生</h4><p>一般来说，我们系统的入口流量是来自于客户端的HTTP请求。所以，我们会考虑在系统高峰期时，将这些入口流量拷贝一份，在经过一些流量清洗的工作之后（比如过滤一些无效的请求），将数据存储在像是HBase、MongoDB这些NoSQL存储组件或者亚马逊S3这些云存储服务中，我们称之为流量数据工厂。</p><p>这样，当我们要压测的时候，就可以从这个工厂中获取数据，将数据切分多份后下发到多个压测节点上了。<strong>在这里，我想强调几个，你需要特殊注意的点。</strong></p><p>首先，我们可以使用多种方式来实现流量的拷贝。最简单的一种方式：直接拷贝负载均衡服务器的访问日志，数据就以文本的方式写入到流量数据工厂中。但是这样产生的数据在发起压测时，需要自己写解析的脚本来解析访问日志，会增加压测时候的成本，不太建议使用。</p><p>另一种方式：通过一些开源的工具来实现流量的拷贝。这里，我推荐一款轻型的流量拷贝工具<a href=\"https://github.com/buger/goreplay\">GoReplay</a>，它可以劫持本机某一个端口的流量，将它们记录在文件中，传送到流量数据工厂中。在压测时，你也可以使用这个工具进行加速的流量回放，这样就可以实现对正式环境的压力测试了。</p><p>其次，如上文中提到，我们在下发压测流量时，需要保证下发流量的节点与用户更加接近，起码不能和服务部署节点在同一个机房中，这样可以尽量保证压测数据的真实性。</p><p>另外，我们还需要对压测流量染色，也就是增加压测标记。在实际项目中，我会在HTTP的请求头中增加一个标记项，比如说叫做is stress test，在流量拷贝之后，批量在请求中增加这个标记项，再写入到数据流量工厂中。</p><h4>数据如何隔离</h4><p>将压测流量拷贝下来的同时，我们也需要考虑对系统做改造，以实现压测流量和正式流量的隔离，这样一来就会尽量避免压测对线上系统的影响。一般来说，我们需要做两方面的事情。</p><p>一方面，针对读取数据的请求（一般称之为下行流量），我们会针对某些不能压测的服务或者组件，做Mock或者特殊的处理，举个例子。</p><p>在业务开发中，我们一般会依据请求记录用户的行为，比如，用户请求了某个商品的页面，我们会记录这个商品多了一次浏览的行为，这些行为数据会写入一份单独的大数据日志中，再传输给数据分析部门，形成业务报表给到产品或者老板做业务的分析决策。</p><p>在压测的时候，肯定会增加这些行为数据，比如原本一天商品页面的浏览行为是一亿次，而压测之后变成了十亿次，这样就会对业务报表产生影响，影响后续的产品方向的决策。因此，我们对于这些压测产生的用户行为做特殊处理，不再记录到大数据日志中。</p><p>再比如，我们系统会依赖一些推荐服务，推荐一些你可能感兴趣的商品，但是这些数据的展示有一个特点就是展示过的商品就不再会被推荐出来。如果你的压测流量经过这些推荐服务，大量的商品就会被压测流量请求到，线上的用户就不会再看到这些商品了，也就会影响推荐的效果。</p><p>所以，我们需要Mock这些推荐服务，让不带有压测标记的请求经过推荐服务，而让带有压测标记的请求经过Mock服务。搭建Mock服务，你需要注意一点：这些Mock服务最好部署在真实服务所在的机房，这样可以尽量模拟真实的服务部署结构，提高压测结果的真实性。</p><p>另一方面，针对写入数据的请求（一般称之为上行流量），我们会把压测流量产生的数据写入到影子库，也就是和线上数据存储完全隔离的一份存储系统中。针对不同的存储类型，我们会使用不同的影子库的搭建方式。</p><ol>\n<li>如果数据存储在MySQL中，我们可以在同一个MySQL实例，不同的Schema中创建一套和线上相同的库表结构，并且把线上的数据也导入进来。</li>\n<li>而如果数据是放在Redis中，我们对压测流量产生的数据，增加一个统一的前缀，存储在同一份存储中。</li>\n<li>还有一些数据会存储在Elasticsearch中，针对这部分数据，我们可以放在另外一个单独的索引表中。</li>\n</ol><p>通过对下行流量的特殊处理以及对上行流量增加影子库的方式，我们就可以实现压测流量的隔离了。</p><h4>压力测试如何实施</h4><p>在拷贝了线上流量和完成了对线上系统的改造之后，我们就可以进行压力测试的实施了。在此之前，一般会设立一个压力测试的目标，比如说，整体系统的QPS需要达到每秒20万。</p><p>不过，在压测时，不会一下子把请求量增加到每秒20万次，而是按照一定的步长（比如每次压测增加一万QPS），逐渐地增加流量。在增加一次流量之后，让系统稳定运行一段时间，观察系统在性能上的表现。如果发现依赖的服务或者组件出现了瓶颈，可以先减少压测流量，比如，回退到上一次压测的QPS，保证服务的稳定，再针对此服务或者组件进行扩容，然后再继续增加流量压测。</p><p>为了能够减少压力测试过程中人力投入成本，可以开发一个流量监控的组件，在这个组件中，预先设定一些性能阈值。比如，容器的CPU使用率的阈值可以设定为60%～70%；系统的平均响应时间的上限可以设定为1秒；系统慢请求的比例设置为1%等等。</p><p>当系统性能达到这个阈值之后，流量监控组件可以及时发现，并且通知压测流量下发组件减少压测流量，并且发送报警给到开发和运维的同学，开发和运维同学就迅速地排查性能瓶颈，在解决问题或者扩容之后再继续执行压测。</p><p>业界关于全链路压测平台的探索有很多，一些大厂比如阿里、京东、美团和微博都有了适合自身业务的全链路压测平台。在我看来，这些压测平台万变不离其宗，都无非是经过流量拷贝、流量染色隔离、打压、监控熔断等步骤，与本课程中介绍的核心思想都是相通的。因此，你在考虑自研适合自己项目的全链路压测平台时，也可以遵循这个成熟的套路。</p><h2>课程小结</h2><p>本节课，我带你了解了做压力测试常见的误区，以及自动化的全链路压测平台的搭建过程，这里你需要了解的重点是：</p><ol>\n<li>压力测试是一种发现系统性能隐患的重要手段，所以应该尽量使用正式的环境和数据；</li>\n<li>对压测的流量需要增加标记，这样就可以通过Mock第三方依赖服务和影子库的方式来实现压测数据和正式数据的隔离；</li>\n<li>压测时，应该实时地对系统性能指标做监控和告警，及时地对出现瓶颈的资源或者服务扩容，避免对正式环境产生影响。</li>\n</ol><p><strong>这套全链路的压力测试系统对于我们来说有三方面的价值：</strong>其一，它可以帮助我们发现系统中可能出现的性能瓶颈，方便我们提前准备预案来应对；其次，它也可以为我们做容量评估，提供数据上的支撑；最后，我们也可以在压测的时候做预案演练，因为压测一般会安排在流量的低峰期进行，这样我们可以降级一些服务来验证预案效果，并且可以尽量减少对线上用户的影响。所以，随着你的系统流量的快速增长，你也需要及时考虑搭建这么一套全链路压测平台，来保证你的系统的稳定性。</p><h2>一课一思</h2><p>在实际的工作中，你的系统的压力测试是如何进行的呢？在压力测试的过程中发现了哪些性能瓶颈点呢？欢迎在留言区与我分享你的经验。</p><p>最后，感谢你的阅读，如果这篇文章让你有所收获，也欢迎你将它分享给更多的朋友。</p>","comments":[{"had_liked":false,"id":215068,"user_name":"钱","can_delete":false,"product_type":"c1","uid":1009652,"ip_address":"","ucode":"2C92A243A463D4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg","comment_is_top":false,"comment_ctime":1588900108,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"190567461132","product_id":100035801,"comment_content":"前面的观点不敢苟同，压测具体怎么来做首先需要看压测的目的是什么？比如：新开发一个接口服务，想了解他的性能如何，为什么不能自己搭建环境压测？另外，现在都是容器化部署的，申请几台容器和线上容器配置一样，为什么不能评估线上容器的性能？一个服务新增一些代码逻辑，想知道性能损耗有多大，在添加代码逻辑前后进行压测进行对比也是完全可行的。<br>全链路压测当然好啦！不过每个环节的性能都不能保证达到预期的话，其实是得不尝试的，每逢大促尤其是店庆或双十一必然会进行系统压测。一般是各个系统自己进行压测看看自己的性能如何？如果有性能问题，需要自行先解决。等各个系统的压测都达到预期了才会进行线上全链路压测，此时使用的完全是线上的流量和真实系统，为了压测会进行流量的储备，上游会进行憋单，然后通知各个下游准备好监控及应急预案，然后放量观察。<br>一次全链路压测耗费成本不少，这种线上全链路压测我不信大部分公司会搞，有些公司估计也没必要搞，所以，我觉得具体怎么搞压测需要看公司的定位，和系统架构一样没必要上来就按阿里的架构来弄，当然，也弄不起的。","like_count":45,"discussions":[{"author":{"id":1583740,"avatar":"https://static001.geekbang.org/account/avatar/00/18/2a/7c/0d6a87c4.jpg","nickname":"dandy","note":"","ucode":"5EE976FCBD9215","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":402051,"discussion_content":"老师说的都是服务稳定后，你对系统的评估。比如你一个很稳定的系统。但是在不断迭代中，系统性能肯定会有所下降。这时候你的业务代码本身就需要为全链路压测做好改写的。 大公司很多有关金钱类的，都会做全链路压测。不一定你理解的自己的系统压测好了就没问题。你的业务足够复杂，依赖的上下游系统就会多。这时候，你怎么保证自己的系统没有问题。肯定是需要其他部门一起合作，一起搞全链路压测。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1633788289,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":159218,"user_name":"阿土","can_delete":false,"product_type":"c1","uid":1183019,"ip_address":"","ucode":"2DBEAD80B0CA3C","user_header":"https://static001.geekbang.org/account/avatar/00/12/0d/2b/4814d3db.jpg","comment_is_top":false,"comment_ctime":1575565349,"is_pvip":false,"replies":[{"id":"61440","content":"其实如果没有做影子库，可以只做下行流量的压测（读请求），一般读多写少，其实也可以大致反应你的系统的容量","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1576132092,"ip_address":"","comment_id":159218,"utype":1}],"discussion_count":2,"race_medal":0,"score":"74590009381","product_id":100035801,"comment_content":"我所在的团队，因为没有资源提供影子库，所以一直做不起来真正的全链路压测。规划的很美好，就因为没有存储隔离，所有的东西都成了泡影。另外，业务系统领导对于系统改造支持压测也不支持，这就造成无法实施。所以目前的全链路压测都是固定的几个账号，几个商品。得到的结果可信度也有限","like_count":18,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":476985,"discussion_content":"其实如果没有做影子库，可以只做下行流量的压测（读请求），一般读多写少，其实也可以大致反应你的系统的容量","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1576132092,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":2906771,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIl03YHWlzIHiaa4Ivr5SaKQAnVCp7zTU7Dpl9IxfF92bW0ibrMceJxTMhPlPBzBaiaM1TTiaWLZrGU8g/132","nickname":"Geek_042981","note":"","ucode":"62F407850F2446","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":551015,"discussion_content":"如果有缓存的话，读请求的数据构造也挺费劲的，如果是线上数据库，还要担心数据过多，影响sql查询的耗时吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644849577,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":476985,"ip_address":""},"score":551015,"extra":""}]}]},{"had_liked":false,"id":161481,"user_name":"新世界","can_delete":false,"product_type":"c1","uid":1079495,"ip_address":"","ucode":"4473DC1505F158","user_header":"https://static001.geekbang.org/account/avatar/00/10/78/c7/083a3a0b.jpg","comment_is_top":false,"comment_ctime":1576215829,"is_pvip":false,"replies":[{"id":"62166","content":"goreplay，tcpcopy","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1576744561,"ip_address":"","comment_id":161481,"utype":1}],"discussion_count":1,"race_medal":0,"score":"48820856085","product_id":100035801,"comment_content":"老师：流量复制和重放后的响应对比有什么工具推荐吗？还是自己去写解析？","like_count":12,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":477732,"discussion_content":"goreplay，tcpcopy","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576744561,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":159281,"user_name":"天天向善","can_delete":false,"product_type":"c1","uid":1108250,"ip_address":"","ucode":"6AE57FB2B15043","user_header":"https://static001.geekbang.org/account/avatar/00/10/e9/1a/6ba207a3.jpg","comment_is_top":false,"comment_ctime":1575594565,"is_pvip":true,"replies":[{"id":"61439","content":"是的~","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1576132058,"ip_address":"","comment_id":159281,"utype":1}],"discussion_count":1,"race_medal":0,"score":"31640365637","product_id":100035801,"comment_content":"是不是我这样理解，购买商品下单要存储到影子库，第三方支付用mock，支付的回调也mock","like_count":8,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":477000,"discussion_content":"是的~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576132058,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":210903,"user_name":"问题究竟系边度","can_delete":false,"product_type":"c1","uid":1095284,"ip_address":"","ucode":"CA4F2C9A84F867","user_header":"https://static001.geekbang.org/account/avatar/00/10/b6/74/c63449b1.jpg","comment_is_top":false,"comment_ctime":1587863953,"is_pvip":true,"replies":[{"id":"78863","content":"好问题！<br>1. 线程池的话 需要改造，把标识传到异步任务里面<br>2. mq也是  可以把标识放到消息体里面","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1588070257,"ip_address":"","comment_id":210903,"utype":1}],"discussion_count":4,"race_medal":0,"score":"27357667729","product_id":100035801,"comment_content":"如果服务里面有线程池，异步操作如何染色，发送mq消息之类怎么处理。 ","like_count":7,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493144,"discussion_content":"好问题！\n1. 线程池的话 需要改造，把标识传到异步任务里面\n2. mq也是  可以把标识放到消息体里面","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1588070257,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1755152,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/VTPuhJb5xxuRwH1iblqrAe3De4PoETgNWibZRkLlhvszysdtpAvSPZFuYtsJfWJmoXOFFWnpR02W9NGIiammU8UPg/132","nickname":"Info_E","note":"","ucode":"97207B2CC4C776","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":362760,"discussion_content":"意思就是把流量接触到的服务全都打上标记，不如在请求字段上加上一个字段标示","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617025013,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1886331,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/c8/7b/153181d7.jpg","nickname":"夜辉","note":"","ucode":"9421385F51FF9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1755152,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/VTPuhJb5xxuRwH1iblqrAe3De4PoETgNWibZRkLlhvszysdtpAvSPZFuYtsJfWJmoXOFFWnpR02W9NGIiammU8UPg/132","nickname":"Info_E","note":"","ucode":"97207B2CC4C776","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":364911,"discussion_content":"业务处理总不能一直传request吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617641072,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":362760,"ip_address":""},"score":364911,"extra":""},{"author":{"id":1307497,"avatar":"https://static001.geekbang.org/account/avatar/00/13/f3/69/7039d03f.jpg","nickname":"书策稠浊","note":"","ucode":"A29875CE15FDA3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1755152,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/VTPuhJb5xxuRwH1iblqrAe3De4PoETgNWibZRkLlhvszysdtpAvSPZFuYtsJfWJmoXOFFWnpR02W9NGIiammU8UPg/132","nickname":"Info_E","note":"","ucode":"97207B2CC4C776","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":403134,"discussion_content":"mq没有请求","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634013729,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":362760,"ip_address":""},"score":403134,"extra":""}]}]},{"had_liked":false,"id":162681,"user_name":"电光火石","can_delete":false,"product_type":"c1","uid":1013160,"ip_address":"","ucode":"3AD33BB4AA940F","user_header":"https://static001.geekbang.org/account/avatar/00/0f/75/a8/dfe4cade.jpg","comment_is_top":false,"comment_ctime":1576577291,"is_pvip":false,"replies":[{"id":"62145","content":"这个其实是不需要的，如果能做到水位监测就可以在系统出现问题时及时的停掉压测流量","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1576735843,"ip_address":"","comment_id":162681,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18756446475","product_id":100035801,"comment_content":"老师你好，有个问题，压测的流量和正常的流量是否需要分流，比如说正常的访问把他分流到某几台机器上，压测的流量把他分流道几台机器上，做物理隔离？<br>做的话，因为后面都是一堆的服务，如果每个服务都做分流，复杂度还是蛮高的；不做的话，是否会相互影响，尤其影响到线上流量？<br>谢谢了！","like_count":5,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":478125,"discussion_content":"这个其实是不需要的，如果能做到水位监测就可以在系统出现问题时及时的停掉压测流量","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576735843,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":161376,"user_name":"新世界","can_delete":false,"product_type":"c1","uid":1079495,"ip_address":"","ucode":"4473DC1505F158","user_header":"https://static001.geekbang.org/account/avatar/00/10/78/c7/083a3a0b.jpg","comment_is_top":false,"comment_ctime":1576199328,"is_pvip":false,"replies":[{"id":"62238","content":"没有遇到过CPU使用率高的情况，我们在线上压高峰五倍左右的流量，没有看到问题","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1576756433,"ip_address":"","comment_id":161376,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18756068512","product_id":100035801,"comment_content":"线上真实环境也是用goreplay做的流量拷贝吗？我最近也在做，但是用goreplay cpu使用率瞬间很高，担心影响线上真实系统，我想请教下老师，你们线上真实环境也是用goreplay 做流量拷贝吗？启动goreplay后也是cpu使用率很高吗","like_count":5,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":477699,"discussion_content":"没有遇到过CPU使用率高的情况，我们在线上压高峰五倍左右的流量，没有看到问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576756433,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":192561,"user_name":"古德","can_delete":false,"product_type":"c1","uid":1037755,"ip_address":"","ucode":"E3F646BB73F60E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/d5/bb/98b93862.jpg","comment_is_top":false,"comment_ctime":1584860456,"is_pvip":false,"replies":[{"id":"73892","content":"是的，那样只能模拟流量了。工具的话我用的比较多的是goreplay，已经在github上开源","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1585019745,"ip_address":"","comment_id":192561,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14469762344","product_id":100035801,"comment_content":"如果是一个新系统还没有上线，是不是就没法通过拷贝流量的方式去做全链路压测了？<br>另外，如果要对拷贝的流量进行加速重放，有开源的工具能实现吗","like_count":4,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":488424,"discussion_content":"是的，那样只能模拟流量了。工具的话我用的比较多的是goreplay，已经在github上开源","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585019745,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":161696,"user_name":"电光火石","can_delete":false,"product_type":"c1","uid":1013160,"ip_address":"","ucode":"3AD33BB4AA940F","user_header":"https://static001.geekbang.org/account/avatar/00/0f/75/a8/dfe4cade.jpg","comment_is_top":false,"comment_ctime":1576299530,"is_pvip":false,"replies":[{"id":"62231","content":"这个确实是的，以前有个合作团队也是这个观念。其实是不用的，只要做好监控，是可以在线上压测的","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1576756299,"ip_address":"","comment_id":161696,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14461201418","product_id":100035801,"comment_content":"线上做压测，除了技术问题外，还有观念问题，很多人不敢做，怕出事情背锅","like_count":3,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":477820,"discussion_content":"这个确实是的，以前有个合作团队也是这个观念。其实是不用的，只要做好监控，是可以在线上压测的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576756299,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":159320,"user_name":"你净瞎说～","can_delete":false,"product_type":"c1","uid":1255437,"ip_address":"","ucode":"A4EE0154034D22","user_header":"https://static001.geekbang.org/account/avatar/00/13/28/0d/558f6141.jpg","comment_is_top":false,"comment_ctime":1575598668,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"14460500556","product_id":100035801,"comment_content":"先搭建一套和生产环境一模一样的性能测试环境，然后造数据，针对一些第三方调用，一键mock ，最后使用Jmeter直接压就完事了","like_count":2},{"had_liked":false,"id":250912,"user_name":"aoe","can_delete":false,"product_type":"c1","uid":1121758,"ip_address":"","ucode":"1C6201EDB4E954","user_header":"https://static001.geekbang.org/account/avatar/00/11/1d/de/62bfa83f.jpg","comment_is_top":false,"comment_ctime":1601279970,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5896247266","product_id":100035801,"comment_content":"压测工具：JMeter<br>经济实用：自己找几台机器搭建集群<br>土豪任性：阿里云全套环境 + JMeter压测服务<br>理论可行：K8S上想建多少就有多少","like_count":1},{"had_liked":false,"id":310031,"user_name":"小胡","can_delete":false,"product_type":"c1","uid":2397964,"ip_address":"","ucode":"1E0DD4138E9D0E","user_header":"","comment_is_top":false,"comment_ctime":1630462631,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1630462631","product_id":100035801,"comment_content":"我怎么总是感觉没有成熟的团队做线上压测风险很大呢","like_count":1},{"had_liked":false,"id":262789,"user_name":"老衲只吃肉","can_delete":false,"product_type":"c1","uid":1178058,"ip_address":"","ucode":"489E04DAC7D88B","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Ug0tqzEkGlUopeZqF3icbATJFbsNVYwSG0gTK2PEJbYqg3LBMooE6hUkaZ4w3PMOGwmWAYyJeyu79sjzSJCKu7Q/132","comment_is_top":false,"comment_ctime":1605842668,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1605842668","product_id":100035801,"comment_content":"goreplay流量回放， 是不能直接回放生产环境的，如写的操作，用户下单，变成同一个用户又写单？ 是不是要在回放的时候做一些标记处理，然后代码也要能识别这种标记写到影子库？  这个全链路工程改造成本有点大啊。降的不是很细，很多细节都不太清楚怎么实现；又如，只想回放只读的请求，细节是怎么区分出来？","like_count":1},{"had_liked":false,"id":216119,"user_name":"mghio","can_delete":false,"product_type":"c1","uid":1213078,"ip_address":"","ucode":"74883EDE4FD0DC","user_header":"https://static001.geekbang.org/account/avatar/00/12/82/96/aa795685.jpg","comment_is_top":false,"comment_ctime":1589191910,"is_pvip":true,"replies":[{"id":"82722","content":"全链路压测并不复杂，可以结合业务特点只压测读流量或者写流量","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1591538776,"ip_address":"","comment_id":216119,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1589191910","product_id":100035801,"comment_content":"公司资源和人力有限，目前只做了些主要功能接口压力测试，全链路压测对小公司感觉比较难完成","like_count":0,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":494677,"discussion_content":"全链路压测并不复杂，可以结合业务特点只压测读流量或者写流量","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591538776,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":178630,"user_name":"惜心（伟祺）","can_delete":false,"product_type":"c1","uid":1067846,"ip_address":"","ucode":"393DF1A9E81332","user_header":"https://static001.geekbang.org/account/avatar/00/10/4b/46/717d5cb9.jpg","comment_is_top":false,"comment_ctime":1581763023,"is_pvip":false,"replies":[{"id":"69659","content":"谢谢~","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1582001381,"ip_address":"","comment_id":178630,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1581763023","product_id":100035801,"comment_content":"讲的好棒","like_count":0,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":483903,"discussion_content":"谢谢~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582001381,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":159958,"user_name":"何磊","can_delete":false,"product_type":"c1","uid":1047604,"ip_address":"","ucode":"78934C3ED4A342","user_header":"https://static001.geekbang.org/account/avatar/00/0f/fc/34/c733b116.jpg","comment_is_top":false,"comment_ctime":1575851590,"is_pvip":false,"replies":[{"id":"61429","content":"1. 是针对一个业务来压测<br>2. 我理解可以在压测时指定一些接口的依赖关系，说实话，我没有遇到过类似的问题~","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1576131310,"ip_address":"","comment_id":159958,"utype":1}],"discussion_count":3,"race_medal":0,"score":"1575851590","product_id":100035801,"comment_content":"唐老师好，我有如下问题：<br>1. 链路压测的时候是一次压一个接口比如商品详情，还是一次压一个业务比如下单。<br>2. 如果我想全链路压一个业务（下单）这就涉及到上下游接口的依赖，如：先加购物车，再去下单结算。甚至还有用券等逻辑。如果仅仅是拷贝流量应该无法完成。是否还需要一个其他的机制呢？","like_count":0,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":477219,"discussion_content":"1. 是针对一个业务来压测\n2. 我理解可以在压测时指定一些接口的依赖关系，说实话，我没有遇到过类似的问题~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576131310,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1123163,"avatar":"https://static001.geekbang.org/account/avatar/00/11/23/5b/983408b9.jpg","nickname":"悟空聊架构","note":"","ucode":"C2F482A0CF8AF1","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":382489,"discussion_content":"是否可以把下单的流量拷贝出来？比如10w的下单请求。另外对于库存和券需要提前准备好。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625612060,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1005062,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/56/06/ea49b29d.jpg","nickname":"小洛","note":"","ucode":"227EC21891012B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":168319,"discussion_content":"下单是一个业务，结算，优惠券我理解的也是业务，业务之间有依赖，所以结算系统和优惠券系统也需要类似的流量隔离的机制，进行全链路的压测，如果依赖服务可以mock就mock，看公司具体业务场景，能容忍就直接压测下单业务，其他依赖先mock或者降级掉","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581572332,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":159326,"user_name":"你净瞎说～","can_delete":false,"product_type":"c1","uid":1255437,"ip_address":"","ucode":"A4EE0154034D22","user_header":"https://static001.geekbang.org/account/avatar/00/13/28/0d/558f6141.jpg","comment_is_top":false,"comment_ctime":1575599583,"is_pvip":false,"replies":[{"id":"61437","content":"是需要改代码兼容的~","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1576131986,"ip_address":"","comment_id":159326,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1575599583","product_id":100035801,"comment_content":"老师，有个问题想请教一下，关于文中说的将压力测试产生的数据写入到影子库，redis中的key用前缀区分，这是需要改代码做兼容吗？我们现在的做法是代码兼容，比如发送短信，开了mock之后，就永远返回发送成功。","like_count":0,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":477011,"discussion_content":"是需要改代码兼容的~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576131986,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":159301,"user_name":"gogo","can_delete":false,"product_type":"c1","uid":1003104,"ip_address":"","ucode":"E8F0F3B000020A","user_header":"https://static001.geekbang.org/account/avatar/00/0f/4e/60/0d5aa340.jpg","comment_is_top":false,"comment_ctime":1575596903,"is_pvip":false,"replies":[{"id":"61438","content":"如果是拷贝的流量，并且是在线上系统压测，其实是有比较大的参考意义的","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1576132049,"ip_address":"","comment_id":159301,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1575596903","product_id":100035801,"comment_content":"老师您好，有个问题：在线上压测的结果 假如是2w qps，但这只是压测流量的数据结果，真实流量没有考虑进来，这样压测怎么反应真实性能呢？","like_count":0,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":477004,"discussion_content":"如果是拷贝的流量，并且是在线上系统压测，其实是有比较大的参考意义的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576132049,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}