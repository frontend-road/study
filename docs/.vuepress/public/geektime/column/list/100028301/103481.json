{"id":103481,"title":"17 | ä¸ºä»€ä¹ˆèƒ½æˆä¸ºæ›´å¥½çš„WebæœåŠ¡å™¨ï¼ŸåŠ¨æ€å¤„ç†è¯·æ±‚å’Œå“åº”æ˜¯å…³é”®","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯æ¸©é“­ã€‚ç»è¿‡å‰é¢å†…å®¹çš„é“ºå«åï¼Œ ç›¸ä¿¡ä½ å·²ç»å¯¹ OpenResty çš„æ¦‚å¿µå’Œå¦‚ä½•å­¦ä¹ å®ƒæœ‰äº†åŸºæœ¬çš„è®¤è¯†ã€‚ä»Šå¤©è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ OpenResty å¦‚ä½•å¤„ç†ç»ˆç«¯è¯·æ±‚å’Œå“åº”ã€‚</p><p>è™½ç„¶ OpenResty æ˜¯åŸºäº NGINX çš„ Web æœåŠ¡å™¨ï¼Œä½†å®ƒä¸ NGINX å´æœ‰æœ¬è´¨çš„ä¸åŒï¼šNGINX ç”±é™æ€çš„é…ç½®æ–‡ä»¶é©±åŠ¨ï¼Œè€Œ OpenResty æ˜¯ç”± Lua API é©±åŠ¨çš„ï¼Œæ‰€ä»¥èƒ½æä¾›æ›´å¤šçš„çµæ´»æ€§å’Œå¯ç¼–ç¨‹æ€§ã€‚</p><p>ä¸‹é¢ï¼Œå°±è®©æˆ‘æ¥å¸¦ä½ é¢†ç•¥ Lua API å¸¦æ¥çš„å¥½å¤„å§ã€‚</p><h2>API åˆ†ç±»</h2><p>é¦–å…ˆæˆ‘ä»¬è¦çŸ¥é“ï¼ŒOpenResty çš„ API ä¸»è¦åˆ†ä¸ºä¸‹é¢å‡ ä¸ªå¤§ç±»ï¼š</p><ul>\n<li>å¤„ç†è¯·æ±‚å’Œå“åº”ï¼›</li>\n<li>SSL ç›¸å…³ï¼›</li>\n<li>shared dictï¼›</li>\n<li>cosocketï¼›</li>\n<li>å¤„ç†å››å±‚æµé‡ï¼›</li>\n<li>process å’Œ workerï¼›</li>\n<li>è·å– NGINX å˜é‡å’Œé…ç½®ï¼›</li>\n<li>å­—ç¬¦ä¸²ã€æ—¶é—´ã€ç¼–è§£ç ç­‰é€šç”¨åŠŸèƒ½ã€‚</li>\n</ul><p>è¿™é‡Œï¼Œæˆ‘å»ºè®®ä½ åŒæ—¶æ‰“å¼€ OpenResty çš„ Lua API æ–‡æ¡£ï¼Œå¯¹ç…§ç€å…¶ä¸­çš„ <a href=\"https://github.com/openresty/lua-nginx-module/#nginx-api-for-lua\">API åˆ—è¡¨</a>  ï¼Œçœ‹çœ‹æ˜¯å¦èƒ½å’Œè¿™ä¸ªåˆ†ç±»è”ç³»èµ·æ¥ã€‚</p><p>OpenResty çš„ API ä¸ä»…ä»…å­˜åœ¨äº lua-nginx-module é¡¹ç›®ä¸­ï¼Œä¹Ÿå­˜åœ¨äº lua-resty-core é¡¹ç›®ä¸­ï¼Œæ¯”å¦‚ ngx.sslã€ngx.base64ã€ngx.errlogã€ngx.processã€ngx.re.splitã€ngx.resp.add_headerã€ngx.balancerã€ngx.semaphoreã€ngx.ocsp è¿™äº› API ã€‚</p><!-- [[[read_end]]] --><p>è€Œå¯¹äºä¸åœ¨ lua-nginx-module é¡¹ç›®ä¸­çš„ APIï¼Œä½ éœ€è¦å•ç‹¬ require æ‰èƒ½ä½¿ç”¨ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚ä½ æƒ³ä½¿ç”¨ split è¿™ä¸ªå­—ç¬¦ä¸²åˆ†å‰²å‡½æ•°ï¼Œå°±éœ€è¦æŒ‰ç…§ä¸‹é¢çš„æ–¹æ³•æ¥è°ƒç”¨ï¼š</p><pre><code>$ resty -e 'local ngx_re = require &quot;ngx.re&quot;\n local res, err = ngx_re.split(&quot;a,b,c,d&quot;, &quot;,&quot;, nil, {pos = 5})\n print(res)\n '\n</code></pre><p>å½“ç„¶ï¼Œè¿™å¯èƒ½ä¼šç»™ä½ å¸¦æ¥ä¸€ä¸ªå›°æƒ‘ï¼šåœ¨ lua-nginx-module é¡¹ç›®ä¸­ï¼Œæ˜æ˜æœ‰ ngx.re.subã€ngx.re.find ç­‰å¥½å‡ ä¸ª ngx.re å¼€å¤´çš„ APIï¼Œä¸ºä»€ä¹ˆå•å•æ˜¯ ngx.re.split è¿™ä¸ª API ï¼Œéœ€è¦ require åæ‰èƒ½ä½¿ç”¨å‘¢ï¼Ÿ</p><p>äº‹å®ä¸Šï¼Œåœ¨å‰é¢ lua-resty-core ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿæåˆ°è¿‡ï¼ŒOpenResty æ–°çš„ API éƒ½æ˜¯é€šè¿‡ FFI çš„æ–¹å¼åœ¨ <code>lua-rety-core</code> ä»“åº“ä¸­å®ç°çš„ï¼Œæ‰€ä»¥éš¾å…å°±ä¼šå­˜åœ¨è¿™ç§å‰²è£‚æ„Ÿã€‚è‡ªç„¶ï¼Œæˆ‘ä¹Ÿå¾ˆæœŸå¾…lua-nginx-module å’Œ lua-resty-core è¿™ä¸¤ä¸ªé¡¹ç›®ä»¥åå¯ä»¥åˆå¹¶ï¼Œå½»åº•è§£å†³æ­¤ç±»é—®é¢˜ã€‚</p><h2>è¯·æ±‚</h2><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å…·ä½“äº†è§£ä¸‹OpenResty æ˜¯å¦‚ä½•å¤„ç†ç»ˆç«¯è¯·æ±‚å’Œå“åº”çš„ã€‚å…ˆæ¥çœ‹ä¸‹å¤„ç†è¯·æ±‚çš„ APIï¼Œä¸è¿‡ï¼Œä»¥ ngx.req å¼€å¤´çš„ API æœ‰ 20 å¤šä¸ªï¼Œè¯¥æ€ä¹ˆä¸‹æ‰‹å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬çŸ¥é“ï¼ŒHTTP è¯·æ±‚æŠ¥æ–‡ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼šè¯·æ±‚è¡Œã€è¯·æ±‚å¤´å’Œè¯·æ±‚ä½“ï¼Œæ‰€ä»¥ä¸‹é¢æˆ‘å°±æŒ‰ç…§è¿™ä¸‰éƒ¨åˆ†æ¥å¯¹ API åšä»‹ç»ã€‚</p><h3>è¯·æ±‚è¡Œ</h3><p>é¦–å…ˆæ˜¯è¯·æ±‚è¡Œï¼ŒHTTP çš„è¯·æ±‚è¡Œä¸­åŒ…å«è¯·æ±‚æ–¹æ³•ã€URI å’Œ HTTP åè®®ç‰ˆæœ¬ã€‚åœ¨ NGINX ä¸­ï¼Œä½ å¯ä»¥é€šè¿‡å†…ç½®å˜é‡çš„æ–¹å¼ï¼Œæ¥è·å–å…¶ä¸­çš„å€¼ï¼›è€Œåœ¨ OpenResty ä¸­å¯¹åº”çš„åˆ™æ˜¯ <code>ngx.var.*</code> è¿™ä¸ª APIã€‚æˆ‘ä»¬æ¥çœ‹ä¸¤ä¸ªä¾‹å­ã€‚</p><ul>\n<li><code>$scheme</code> è¿™ä¸ªå†…ç½®å˜é‡ï¼Œåœ¨ NGINX ä¸­ä»£è¡¨åè®®çš„åå­—ï¼Œæ˜¯ â€œhttpâ€ æˆ–è€… â€œhttpsâ€ï¼›è€Œåœ¨ OpenResty ä¸­ï¼Œä½ å¯ä»¥é€šè¿‡ <code>ngx.var.scheme</code> æ¥è¿”å›åŒæ ·çš„å€¼ã€‚</li>\n<li><code>$request_method</code> ä»£è¡¨çš„æ˜¯è¯·æ±‚çš„æ–¹æ³•ï¼Œâ€œGETâ€ã€â€œPOSTâ€ ç­‰ï¼›è€Œåœ¨ OpenResty ä¸­ï¼Œä½ å¯ä»¥é€šè¿‡ <code>ngx.var. request_method</code> æ¥è¿”å›åŒæ ·çš„å€¼ã€‚</li>\n</ul><p>è‡³äºå®Œæ•´çš„ NGINX å†…ç½®å˜é‡åˆ—è¡¨ï¼Œä½ å¯ä»¥è®¿é—® NGINX çš„å®˜æ–¹æ–‡æ¡£æ¥è·å–ï¼š<a href=\"http://nginx.org/en/docs/http/ngx_http_core_module.html#variables\">http://nginx.org/en/docs/http/ngx_http_core_module.html#variables</a>ã€‚</p><p>é‚£ä¹ˆé—®é¢˜å°±æ¥äº†ï¼šæ—¢ç„¶å¯ä»¥é€šè¿‡<code>ngx.var.*</code> è¿™ç§è¿”å›å˜é‡å€¼çš„æ–¹æ³•ï¼Œæ¥å¾—åˆ°è¯·æ±‚è¡Œä¸­çš„æ•°æ®ï¼Œä¸ºä»€ä¹ˆ OpenResty è¿˜è¦å•ç‹¬æä¾›é’ˆå¯¹è¯·æ±‚è¡Œçš„ API å‘¢ï¼Ÿ</p><p>è¿™å…¶å®æ˜¯å¾ˆå¤šæ–¹é¢å› ç´ çš„ç»¼åˆè€ƒè™‘ç»“æœï¼š</p><ul>\n<li>é¦–å…ˆæ˜¯å¯¹æ€§èƒ½çš„è€ƒè™‘ã€‚<code>ngx.var</code> çš„æ•ˆç‡ä¸é«˜ï¼Œä¸å»ºè®®åå¤è¯»å–ï¼›</li>\n<li>ä¹Ÿæœ‰å¯¹ç¨‹åºå‹å¥½çš„è€ƒè™‘ï¼Œ<code>ngx.var</code> è¿”å›çš„æ˜¯å­—ç¬¦ä¸²ï¼Œè€Œé Lua å¯¹è±¡ï¼Œé‡åˆ°è·å– args è¿™ç§å¯èƒ½è¿”å›å¤šä¸ªå€¼çš„æƒ…å†µï¼Œå°±ä¸å¥½å¤„ç†äº†ï¼›</li>\n<li>å¦å¤–æ˜¯å¯¹çµæ´»æ€§çš„è€ƒè™‘ï¼Œç»å¤§éƒ¨åˆ†çš„ <code>ngx.var</code> æ˜¯åªè¯»çš„ï¼Œåªæœ‰å¾ˆå°‘æ•°çš„å˜é‡æ˜¯å¯å†™çš„ï¼Œæ¯”å¦‚ <code>$args</code> å’Œ <code>limit_rate</code>ï¼Œå¯å¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬ä¼šæœ‰ä¿®æ”¹ methodã€URI å’Œ args çš„éœ€æ±‚ã€‚</li>\n</ul><p>æ‰€ä»¥ï¼Œ OpenResty æä¾›äº†å¤šä¸ªä¸“é—¨æ“ä½œè¯·æ±‚è¡Œçš„ APIï¼Œå®ƒä»¬å¯ä»¥å¯¹è¯·æ±‚è¡Œè¿›è¡Œæ”¹å†™ï¼Œä»¥ä¾¿åç»­çš„é‡å®šå‘ç­‰æ“ä½œã€‚</p><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ï¼Œå¦‚ä½•é€šè¿‡ API æ¥è·å– HTTP åè®®ç‰ˆæœ¬å·ã€‚OpenResty çš„ API <code>ngx.req.http_version</code> å’Œ NGINX çš„ <code>$server_protocol</code> å˜é‡çš„ä½œç”¨ä¸€æ ·ï¼Œéƒ½æ˜¯è¿”å› HTTP åè®®çš„ç‰ˆæœ¬å·ã€‚ä¸è¿‡è¿™ä¸ª API çš„è¿”å›å€¼æ˜¯æ•°å­—æ ¼å¼ï¼Œè€Œéå­—ç¬¦ä¸²ï¼Œå¯èƒ½çš„å€¼æ˜¯ 2.0ã€1.0ã€1.1 å’Œ 0.9ï¼Œå¦‚æœç»“æœä¸åœ¨è¿™å‡ ä¸ªå€¼çš„èŒƒå›´å†…ï¼Œå°±ä¼šè¿”å› nilã€‚</p><p>å†æ¥çœ‹ä¸‹è·å–è¯·æ±‚è¡Œä¸­çš„è¯·æ±‚æ–¹æ³•ã€‚åˆšæ‰æˆ‘ä»¬æåˆ°è¿‡ï¼Œ<code>ngx.req.get_method</code> å’Œ NGINX çš„ <code>$request_method</code> å˜é‡çš„ä½œç”¨ã€è¿”å›å€¼ä¸€æ ·ï¼Œéƒ½æ˜¯å­—ç¬¦ä¸²æ ¼å¼çš„æ–¹æ³•åã€‚</p><p>ä½†æ˜¯ï¼Œæ”¹å†™å½“å‰ HTTP è¯·æ±‚æ–¹æ³•çš„ APIï¼Œä¹Ÿå°±æ˜¯ <code>ngx.req.set_method</code>ï¼Œå®ƒæ¥å—çš„å‚æ•°æ ¼å¼å´å¹¶éå­—ç¬¦ä¸²ï¼Œè€Œæ˜¯å†…ç½®çš„æ•°å­—å¸¸é‡ã€‚æ¯”å¦‚ï¼Œä¸‹é¢çš„ä»£ç ï¼ŒæŠŠè¯·æ±‚æ–¹æ³•æ”¹å†™ä¸º POSTï¼š</p><pre><code>ngx.req.set_method(ngx.HTTP_POST)\n</code></pre><p>ä¸ºäº†éªŒè¯ <code>ngx.HTTP_POST</code> è¿™ä¸ªå†…ç½®å¸¸é‡ï¼Œç¡®å®æ˜¯æ•°å­—è€Œéå­—ç¬¦ä¸²ï¼Œä½ å¯ä»¥æ‰“å°å‡ºå®ƒçš„å€¼ï¼Œçœ‹è¾“å‡ºæ˜¯å¦ä¸º 8ï¼š</p><pre><code>$ resty -e 'print(ngx.HTTP_POST)'\n</code></pre><p>è¿™æ ·ä¸€æ¥ï¼Œget æ–¹æ³•çš„è¿”å›å€¼ä¸ºå­—ç¬¦ä¸²ï¼Œè€Œset æ–¹æ³•çš„è¾“å…¥å€¼å´æ˜¯æ•°å­—ï¼Œå°±å¾ˆå®¹æ˜“è®©ä½ åœ¨å†™ä»£ç çš„æ—¶å€™æƒ³å½“ç„¶äº†ã€‚å¦‚æœæ˜¯ set æ—¶å€™ä¼ å€¼æ··æ·†çš„æƒ…å†µè¿˜å¥½ï¼ŒAPI ä¼šå´©æºƒæŠ¥å‡º 500 çš„é”™è¯¯ï¼›ä½†å¦‚æœæ˜¯ä¸‹é¢è¿™ç§åˆ¤æ–­é€»è¾‘çš„ä»£ç ï¼š</p><pre><code>if (ngx.req.get_method() == ngx.HTTP_POST) then\n    -- do something\n end\n</code></pre><p>è¿™ç§ä»£ç æ˜¯å¯ä»¥æ­£å¸¸è¿è¡Œçš„ï¼Œä¸ä¼šæŠ¥å‡ºä»»ä½•é”™è¯¯ï¼Œç”šè‡³åœ¨ code review æ—¶ä¹Ÿå¾ˆéš¾å‘ç°ã€‚ä¸å¹¸çš„æ˜¯ï¼Œæˆ‘å°±çŠ¯è¿‡ç±»ä¼¼çš„é”™è¯¯ï¼Œå¯¹æ­¤è®°å¿†çŠ¹æ–°ï¼šå½“æ—¶å·²ç»ç»è¿‡äº†ä¸¤è½® code reviewï¼Œè¿˜æœ‰ä¸å®Œæ•´çš„æµ‹è¯•æ¡ˆä¾‹å°è¯•è¦†ç›–ï¼Œç„¶è€Œï¼Œæœ€ç»ˆè¿˜æ˜¯å› ä¸ºçº¿ä¸Šç¯å¢ƒå¼‚å¸¸æ‰è¿½è¸ªåˆ°äº†è¿™é‡Œã€‚</p><p>ç¢°åˆ°è¿™ç±»æƒ…å†µï¼Œé™¤äº†è‡ªå·±å¤šå°å¿ƒï¼Œæˆ–è€…å†å¤šä¸€å±‚å°è£…å¤–ï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆæœ‰æ•ˆçš„æ–¹æ³•æ¥è§£å†³ã€‚å¹³å¸¸ä½ åœ¨è®¾è®¡è‡ªå·±çš„ä¸šåŠ¡ API æ—¶ï¼Œä¹Ÿå¯ä»¥å¤šåšä¸€äº›è¿™æ–¹é¢çš„è€ƒè™‘ï¼Œå°½é‡ä¿æŒ getã€set æ–¹æ³•çš„å‚æ•°æ ¼å¼ä¸€è‡´ï¼Œå³ä½¿è¿™ä¼šç‰ºç‰²ä¸€äº›æ€§èƒ½ã€‚</p><p>å¦å¤–ï¼Œåœ¨æ”¹å†™è¯·æ±‚è¡Œçš„æ–¹æ³•ä¸­ï¼Œè¿˜æœ‰ <code>ngx.req.set_uri</code> å’Œ <code>ngx.req.set_uri_args</code> è¿™ä¸¤ä¸ª APIï¼Œå¯ä»¥ç”¨æ¥æ”¹å†™ uri å’Œ argsã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹è¿™ä¸ª NGINX é…ç½®ï¼š</p><pre><code> rewrite ^ /foo?a=3? break;\n</code></pre><p>é‚£ä¹ˆï¼Œå¦‚ä½•ç”¨ç­‰ä»·çš„ Lua API æ¥è§£å†³å‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯ä¸‹é¢è¿™ä¸¤è¡Œä»£ç ã€‚</p><pre><code>ngx.req.set_uri_args(&quot;a=3&quot;)\nngx.req.set_uri(&quot;/foo&quot;)\n</code></pre><p>å…¶å®ï¼Œå¦‚æœä½ çœ‹è¿‡å®˜æ–¹æ–‡æ¡£ï¼Œå°±ä¼šå‘ç° <code>ngx.req.set_uri</code> è¿˜æœ‰ç¬¬äºŒä¸ªå‚æ•°ï¼šjumpï¼Œé»˜è®¤æ˜¯ falseã€‚å¦‚æœè®¾ç½®ä¸º trueï¼Œå°±ç­‰åŒäºæŠŠ rewrite æŒ‡ä»¤çš„ flag è®¾ç½®ä¸º <code>last</code>ï¼Œè€Œéä¸Šé¢ç¤ºä¾‹ä¸­çš„ <code>break</code>ã€‚</p><p>ä¸è¿‡ï¼Œæˆ‘ä¸ªäººå¹¶ä¸å–œæ¬¢ rewrite æŒ‡ä»¤çš„ flag é…ç½®ï¼Œçœ‹ä¸æ‡‚ä¹Ÿè®°ä¸ä½ï¼Œè¿œæ²¡æœ‰ä»£ç æ¥çš„ç›´è§‚å’Œå¥½ç»´æŠ¤ã€‚</p><h3>è¯·æ±‚å¤´</h3><p>å†æ¥çœ‹ä¸‹å’Œè¯·æ±‚å¤´æœ‰å…³çš„ APIã€‚æˆ‘ä»¬çŸ¥é“ï¼ŒHTTP çš„è¯·æ±‚å¤´æ˜¯ <code>key : value</code> æ ¼å¼çš„ï¼Œæ¯”å¦‚ï¼š</p><pre><code>Accept: text/css,*/*;q=0.1\nAccept-Encoding: gzip, deflate, br\n</code></pre><p>åœ¨OpenResty ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>ngx.req.get_headers</code> æ¥è§£æå’Œè·å–è¯·æ±‚å¤´ï¼Œè¿”å›å€¼çš„ç±»å‹åˆ™æ˜¯ tableï¼š</p><pre><code>local h, err = ngx.req.get_headers()\n \n  if err == &quot;truncated&quot; then\n      -- one can choose to ignore or reject the current request here\n  end\n \n  for k, v in pairs(h) do\n      ...\n  end\n</code></pre><p>è¿™é‡Œé»˜è®¤è¿”å›å‰ 100 ä¸ª headerï¼Œå¦‚æœè¯·æ±‚å¤´è¶…è¿‡äº† 100 ä¸ªï¼Œå°±ä¼šè¿”å› <code>truncated</code> çš„é”™è¯¯ä¿¡æ¯ï¼Œç”±å¼€å‘è€…è‡ªå·±å†³å®šå¦‚ä½•å¤„ç†ã€‚ä½ å¯èƒ½ä¼šå¥½å¥‡ä¸ºä»€ä¹ˆä¼šæœ‰è¿™æ ·çš„å¤„ç†ï¼Œè¿™ä¸€ç‚¹å…ˆç•™ä¸ªæ‚¬å¿µï¼Œåœ¨åé¢å®‰å…¨æ¼æ´çš„ç« èŠ‚ä¸­æˆ‘ä¼šæåˆ°ã€‚</p><p>ä¸è¿‡ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒOpenResty å¹¶æ²¡æœ‰æä¾›è·å–æŸä¸€ä¸ªæŒ‡å®šè¯·æ±‚å¤´çš„ APIï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰ <code>ngx.req.header['host']</code> è¿™ç§å½¢å¼ã€‚å¦‚æœä½ æœ‰è¿™æ ·çš„éœ€æ±‚ï¼Œé‚£å°±éœ€è¦å€ŸåŠ© NGINX çš„å˜é‡ <code>$http_xxx</code> æ¥å®ç°äº†ï¼Œé‚£ä¹ˆåœ¨ OpenResty ä¸­ï¼Œå°±æ˜¯ <code>ngx.var.http_xxx</code> è¿™æ ·çš„è·å–æ–¹å¼ã€‚</p><p>çœ‹å®Œäº†è·å–è¯·æ±‚å¤´ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹åº”è¯¥å¦‚ä½•æ”¹å†™å’Œåˆ é™¤è¯·æ±‚å¤´ï¼Œè¿™ä¸¤ç§æ“ä½œçš„ API å…¶å®éƒ½å¾ˆç›´è§‚ï¼š</p><pre><code>ngx.req.set_header(&quot;Content-Type&quot;, &quot;text/css&quot;)\nngx.req.clear_header(&quot;Content-Type&quot;)\n</code></pre><p>å½“ç„¶ï¼Œå®˜æ–¹æ–‡æ¡£ä¸­ä¹Ÿæåˆ°äº†å…¶ä»–æ–¹æ³•æ¥åˆ é™¤è¯·æ±‚å¤´ï¼Œæ¯”å¦‚æŠŠ header çš„å€¼è®¾ç½®ä¸º nilç­‰ï¼Œä½†ä¸ºäº†ä»£ç æ›´åŠ æ¸…æ™°çš„è€ƒè™‘ï¼Œæˆ‘è¿˜æ˜¯æ¨èç»Ÿä¸€ç”¨ <code>clear_header</code> æ¥æ“ä½œã€‚</p><h3>è¯·æ±‚ä½“</h3><p>æœ€åæ¥çœ‹è¯·æ±‚ä½“ã€‚å‡ºäºæ€§èƒ½è€ƒè™‘ï¼ŒOpenResty ä¸ä¼šä¸»åŠ¨è¯»å–è¯·æ±‚ä½“çš„å†…å®¹ï¼Œé™¤éä½ åœ¨ nginx.conf ä¸­å¼ºåˆ¶å¼€å¯äº† <code>lua_need_request_body</code> æŒ‡ä»¤ã€‚æ­¤å¤–ï¼Œå¯¹äºæ¯”è¾ƒå¤§çš„è¯·æ±‚ä½“ï¼ŒOpenResty ä¼šæŠŠå†…å®¹ä¿å­˜åœ¨ç£ç›˜çš„ä¸´æ—¶æ–‡ä»¶ä¸­ï¼Œæ‰€ä»¥è¯»å–è¯·æ±‚ä½“çš„å®Œæ•´æµç¨‹æ˜¯ä¸‹é¢è¿™æ ·çš„ï¼š</p><pre><code>ngx.req.read_body()\nlocal data = ngx.req.get_body_data()\nif not data then\n    local tmp_file = ngx.req.get_body_file()\n     -- io.open(tmp_file)\n     -- ...\n end\n</code></pre><p>è¿™æ®µä»£ç ä¸­æœ‰è¯»å–ç£ç›˜æ–‡ä»¶çš„ IO é˜»å¡æ“ä½œã€‚ä½ åº”è¯¥æ ¹æ®å®é™…æƒ…å†µæ¥è°ƒæ•´ <code>client_body_buffer_size</code> é…ç½®çš„å¤§å°ï¼ˆ64 ä½ç³»ç»Ÿä¸‹é»˜è®¤æ˜¯ 16 KBï¼‰ï¼Œå°½é‡å‡å°‘é˜»å¡çš„æ“ä½œï¼›ä½ ä¹Ÿå¯ä»¥æŠŠ <code>client_body_buffer_size</code> å’Œ <code>client_max_body_size</code> é…ç½®æˆä¸€æ ·çš„ï¼Œå®Œå…¨åœ¨å†…å­˜ä¸­æ¥å¤„ç†ï¼Œå½“ç„¶ï¼Œè¿™å–å†³äºä½ å†…å­˜çš„å¤§å°å’Œå¤„ç†çš„å¹¶å‘è¯·æ±‚æ•°ã€‚</p><p>å¦å¤–ï¼Œè¯·æ±‚ä½“ä¹Ÿå¯ä»¥è¢«æ”¹å†™ï¼Œ<code>ngx.req.set_body_data</code> å’Œ <code>ngx.req.set_body_file</code> è¿™ä¸¤ä¸ªAPIï¼Œåˆ†åˆ«æ¥å—å­—ç¬¦ä¸²å’Œæœ¬åœ°ç£ç›˜æ–‡ä»¶åšä¸ºè¾“å…¥å‚æ•°ï¼Œæ¥å®Œæˆè¯·æ±‚ä½“çš„æ”¹å†™ã€‚ä¸è¿‡ï¼Œè¿™ç±»æ“ä½œå¹¶ä¸å¸¸è§ï¼Œä½ å¯ä»¥æŸ¥çœ‹æ–‡æ¡£æ¥è·å–æ›´è¯¦ç»†çš„å†…å®¹ã€‚</p><h2>å“åº”</h2><p>å¤„ç†å®Œè¯·æ±‚åï¼Œæˆ‘ä»¬å°±éœ€è¦å‘é€å“åº”è¿”å›ç»™å®¢æˆ·ç«¯äº†ã€‚å’Œè¯·æ±‚æŠ¥æ–‡ä¸€æ ·ï¼Œå“åº”æŠ¥æ–‡ä¹Ÿç”±å‡ ä¸ªéƒ¨åˆ†ç»„æˆï¼Œå³çŠ¶æ€è¡Œã€å“åº”å¤´å’Œå“åº”ä½“ã€‚åŒæ ·çš„ï¼Œæ¥ä¸‹æ¥æˆ‘ä¼šæŒ‰ç…§è¿™ä¸‰éƒ¨åˆ†æ¥ä»‹ç»ç›¸åº”çš„APIã€‚</p><h3>çŠ¶æ€è¡Œ</h3><p>çŠ¶æ€è¡Œä¸­ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨çš„æ˜¯çŠ¶æ€ç ã€‚åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿”å›çš„ HTTP çŠ¶æ€ç æ˜¯ 200ï¼Œä¹Ÿå°±æ˜¯ OpenResty ä¸­å†…ç½®çš„å¸¸é‡ <code>ngx.HTTP_OK</code>ã€‚ä½†åœ¨ä»£ç çš„ä¸–ç•Œä¸­ï¼Œå¤„ç†å¼‚å¸¸æƒ…å†µçš„ä»£ç æ€»æ˜¯å æ¯”æœ€å¤šçš„ã€‚</p><p>å¦‚æœä½ æ£€æµ‹äº†è¯·æ±‚æŠ¥æ–‡ï¼Œå‘ç°è¿™æ˜¯ä¸€ä¸ªæ¶æ„çš„è¯·æ±‚ï¼Œé‚£ä¹ˆä½ éœ€è¦ç»ˆæ­¢è¯·æ±‚:</p><pre><code> ngx.exit(ngx.HTTP_BAD_REQUEST)\n</code></pre><p>ä¸è¿‡ï¼ŒOpenResty çš„ HTTP çŠ¶æ€ç ä¸­ï¼Œæœ‰ä¸€ä¸ªç‰¹åˆ«çš„å¸¸é‡ï¼š<code>ngx.OK</code>ã€‚å½“ <code>ngx.exit(ngx.OK)</code> æ—¶ï¼Œè¯·æ±‚ä¼šé€€å‡ºå½“å‰å¤„ç†é˜¶æ®µï¼Œè¿›å…¥ä¸‹ä¸€ä¸ªé˜¶æ®µï¼Œè€Œä¸æ˜¯ç›´æ¥è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p><p>å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥é€‰æ‹©ä¸é€€å‡ºï¼Œåªä½¿ç”¨ <code>ngx.status</code> æ¥æ”¹å†™çŠ¶æ€ç ï¼Œæ¯”å¦‚ä¸‹é¢è¿™æ ·çš„å†™æ³•ï¼š</p><pre><code>ngx.status = ngx.HTTP_FORBIDDEN\n</code></pre><p>å¦‚æœä½ æƒ³äº†è§£æ›´å¤šçš„çŠ¶æ€ç å¸¸é‡ï¼Œå¯ä»¥ä»<a href=\"https://github.com/openresty/lua-nginx-module/#http-status-constants\">æ–‡æ¡£</a>ä¸­æŸ¥è¯¢åˆ°ã€‚</p><h3>å“åº”å¤´</h3><p>è¯´åˆ°å“åº”å¤´ï¼Œå…¶å®ï¼Œä½ æœ‰ä¸¤ç§æ–¹æ³•æ¥è®¾ç½®å®ƒã€‚ç¬¬ä¸€ç§æ˜¯æœ€ç®€å•çš„ï¼š</p><pre><code>ngx.header.content_type = 'text/plain'\nngx.header[&quot;X-My-Header&quot;] = 'blah blah'\nngx.header[&quot;X-My-Header&quot;] = nil -- åˆ é™¤\n</code></pre><p>è¿™é‡Œçš„ ngx.header ä¿å­˜äº†å“åº”å¤´çš„ä¿¡æ¯ï¼Œå¯ä»¥è¯»å–ã€ä¿®æ”¹å’Œåˆ é™¤ã€‚</p><p>ç¬¬äºŒç§è®¾ç½®å“åº”å¤´çš„æ–¹æ³•æ˜¯ <code>ngx_resp.add_header</code> ï¼Œæ¥è‡ª lua-resty-core ä»“åº“ï¼Œå®ƒå¯ä»¥å¢åŠ ä¸€ä¸ªå¤´ä¿¡æ¯ï¼Œç”¨ä¸‹é¢çš„æ–¹æ³•æ¥è°ƒç”¨ï¼š</p><pre><code>local ngx_resp = require &quot;ngx.resp&quot;\nngx_resp.add_header(&quot;Foo&quot;, &quot;bar&quot;)\n</code></pre><p>ä¸ç¬¬ä¸€ç§æ–¹æ³•çš„ä¸åŒä¹‹å¤„åœ¨äºï¼Œadd header ä¸ä¼šè¦†ç›–å·²ç»å­˜åœ¨çš„åŒåå­—æ®µã€‚</p><h3>å“åº”ä½“</h3><p>æœ€åçœ‹ä¸‹å“åº”ä½“ï¼Œåœ¨ OpenResty ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>ngx.say</code> å’Œ <code>ngx.print</code> æ¥è¾“å‡ºå“åº”ä½“ï¼š</p><pre><code>ngx.say('hello, world')\n</code></pre><p>è¿™ä¸¤ä¸ª API çš„åŠŸèƒ½æ˜¯ä¸€è‡´çš„ï¼Œå”¯ä¸€çš„ä¸åŒåœ¨äºï¼Œ <code>ngx.say</code> ä¼šåœ¨æœ€åå¤šä¸€ä¸ªæ¢è¡Œç¬¦ã€‚</p><p>ä¸ºäº†é¿å…å­—ç¬¦ä¸²æ‹¼æ¥çš„ä½æ•ˆï¼Œ<code>ngx.say / ngx.print</code> ä¸ä»…æ”¯æŒå­—ç¬¦ä¸²ä½œä¸ºå‚æ•°ï¼Œä¹Ÿæ”¯æŒæ•°ç»„æ ¼å¼ï¼š</p><pre><code>$ resty -e 'ngx.say({&quot;hello&quot;, &quot;, &quot;, &quot;world&quot;})'\n hello, world\n</code></pre><p>è¿™æ ·åœ¨ Lua å±‚é¢å°±è·³è¿‡äº†å­—ç¬¦ä¸²çš„æ‹¼æ¥ï¼ŒæŠŠè¿™ä¸ªå®ƒä¸æ“…é•¿çš„äº‹æƒ…ä¸¢ç»™äº† C å‡½æ•°å»å¤„ç†ã€‚</p><h2>å†™åœ¨æœ€å</h2><p>åˆ°æ­¤ï¼Œè®©æˆ‘ä»¬å›é¡¾ä¸‹ä»Šå¤©çš„å†…å®¹ã€‚æˆ‘ä»¬æŒ‰ç…§è¯·æ±‚æŠ¥æ–‡å’Œå“åº”æŠ¥æ–‡çš„å†…å®¹ï¼Œä¾æ¬¡ä»‹ç»äº†ä¸ä¹‹ç›¸å…³çš„ OpenResty APIã€‚ä½ å¯ä»¥çœ‹å¾—å‡ºæ¥ï¼Œå’Œ NGINX çš„æŒ‡ä»¤ç›¸æ¯”ï¼ŒOpenResty APIæ›´åŠ çµæ´»å’Œå¼ºå¤§ã€‚</p><p>é‚£ä¹ˆï¼Œåœ¨ä½ å¤„ç† HTTP è¯·æ±‚æ—¶ï¼ŒOpenResty æä¾›çš„ Lua API æ˜¯å¦è¶³å¤Ÿæ»¡è¶³ä½ çš„éœ€æ±‚å‘¢ï¼Ÿæ¬¢è¿ç•™è¨€ä¸€èµ·æ¢è®¨ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™ç¯‡æ–‡ç« åˆ†äº«ç»™ä½ çš„åŒäº‹ã€æœ‹å‹ï¼Œæˆ‘ä»¬ä¸€èµ·äº¤æµï¼Œä¸€èµ·è¿›æ­¥ã€‚</p><p></p>","comments":[{"had_liked":false,"id":111254,"user_name":"helloworld","can_delete":false,"product_type":"c1","uid":1105161,"ip_address":"","ucode":"1EECCA0F43E278","user_header":"https://static001.geekbang.org/account/avatar/00/10/dd/09/feca820a.jpg","comment_is_top":false,"comment_ctime":1562518335,"is_pvip":false,"replies":[{"id":"40870","content":"ngx.ok ç¡®å®ä¸æ˜¯httpçŠ¶æ€ç ï¼Œå®ƒæ˜¯ OpenResty ä¸­çš„ä¸€ä¸ªå¸¸é‡ï¼Œå€¼æ˜¯0.<br>ngx.exit çš„å®˜æ–¹æ–‡æ¡£æ­£å¥½å¯ä»¥è§£ç­”ä½ çš„é—®é¢˜ï¼š<br>When status &gt;= 200 (i.e., ngx.HTTP_OK and above), it will interrupt the execution of the current request and return status code to nginx.<br><br>When status == 0 (i.e., ngx.OK), it will only quit the current phase handler (or the content handler if the content_by_lua* directive is used) and continue to run later phases (if any) for the current request.<br><br>ä¸è¿‡ï¼Œé‡Œé¢å¹¶æ²¡æœ‰æåˆ°å¯¹äºngx.exit(ngx.ERROR)å’Œngx.exit(ngx.DECLINED)æ˜¯å¦‚ä½•å¤„ç†çš„ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±æ¥åšä¸ªæµ‹è¯•ï¼š<br>location &#47;lua {<br>        rewrite_by_lua &quot;ngx.exit(ngx.ERROR)&quot;;<br>        echo hello;<br>    }<br>è®¿é—®è¿™ä¸ª locationï¼Œå¯ä»¥çœ‹åˆ° http å“åº”ç ä¸ºç©ºï¼Œå“åº”ä½“ä¹Ÿæ˜¯ç©ºã€‚å¹¶æ²¡æœ‰å¼•å…¥ä¸‹ä¸€ä¸ªæ‰§è¡Œé˜¶æ®µã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1562728804,"ip_address":"","comment_id":111254,"utype":1}],"discussion_count":1,"race_medal":0,"score":"35922256703","product_id":100028301,"comment_content":"è€å¸ˆï¼Œæ–‡ä¸­çš„è¿™å¥â€œOpenResty çš„ HTTP çŠ¶æ€ç ä¸­ï¼Œæœ‰ä¸€ä¸ªç‰¹åˆ«çš„å¸¸é‡ï¼šngx.OKã€‚å½“ ngx.exit(ngx.OK) æ—¶ï¼Œè¯·æ±‚ä¼šé€€å‡ºå½“å‰å¤„ç†é˜¶æ®µï¼Œè¿›å…¥ä¸‹ä¸€ä¸ªé˜¶æ®µï¼Œè€Œä¸æ˜¯ç›´æ¥è¿”å›ç»™å®¢æˆ·ç«¯ã€‚â€<br>ngx.OKåº”è¯¥ä¸èƒ½ç®—æ˜¯HTTPçŠ¶æ€ç å§ï¼Œå®ƒå¯¹åº”çš„å€¼æ˜¯0ï¼›<br>æˆ‘ä¸‹é¢çš„ç†è§£å¯¹ä¸å¯¹ï¼š<br>ngx.exit(ngx.OK)ã€ngx.exit(ngx.ERROR)å’Œngx.exit(ngx.DECLINED)æ—¶ï¼Œè¯·æ±‚ä¼šé€€å‡ºå½“å‰å¤„ç†é˜¶æ®µï¼Œè¿›å…¥ä¸‹ä¸€ä¸ªé˜¶æ®µï¼›<br>è€Œå½“ngx.exit(ngx.HTTP_*)ä»¥ngx.HTTP_*å„ç§HTTPçŠ¶æ€ç ä½œä¸ºå‚æ•°æ—¶ï¼Œä¼šç›´æ¥å“åº”ç»™å®¢æˆ·ç«¯ã€‚","like_count":9,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457296,"discussion_content":"ngx.ok ç¡®å®ä¸æ˜¯httpçŠ¶æ€ç ï¼Œå®ƒæ˜¯ OpenResty ä¸­çš„ä¸€ä¸ªå¸¸é‡ï¼Œå€¼æ˜¯0.\nngx.exit çš„å®˜æ–¹æ–‡æ¡£æ­£å¥½å¯ä»¥è§£ç­”ä½ çš„é—®é¢˜ï¼š\nWhen status &amp;gt;= 200 (i.e., ngx.HTTP_OK and above), it will interrupt the execution of the current request and return status code to nginx.\n\nWhen status == 0 (i.e., ngx.OK), it will only quit the current phase handler (or the content handler if the content_by_lua* directive is used) and continue to run later phases (if any) for the current request.\n\nä¸è¿‡ï¼Œé‡Œé¢å¹¶æ²¡æœ‰æåˆ°å¯¹äºngx.exit(ngx.ERROR)å’Œngx.exit(ngx.DECLINED)æ˜¯å¦‚ä½•å¤„ç†çš„ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±æ¥åšä¸ªæµ‹è¯•ï¼š\nlocation /lua {\n        rewrite_by_lua &amp;quot;ngx.exit(ngx.ERROR)&amp;quot;;\n        echo hello;\n    }\nè®¿é—®è¿™ä¸ª locationï¼Œå¯ä»¥çœ‹åˆ° http å“åº”ç ä¸ºç©ºï¼Œå“åº”ä½“ä¹Ÿæ˜¯ç©ºã€‚å¹¶æ²¡æœ‰å¼•å…¥ä¸‹ä¸€ä¸ªæ‰§è¡Œé˜¶æ®µã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562728804,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":110006,"user_name":"HelloBug","can_delete":false,"product_type":"c1","uid":1249598,"ip_address":"","ucode":"E61A4AD5C2F724","user_header":"https://static001.geekbang.org/account/avatar/00/13/11/3e/925aa996.jpg","comment_is_top":false,"comment_ctime":1562149636,"is_pvip":true,"replies":[{"id":"40893","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1562736538,"ip_address":"","comment_id":110006,"utype":1}],"discussion_count":1,"race_medal":0,"score":"23036986116","product_id":100028301,"comment_content":"åˆ©ç”¨ngx.exitè¿”å›é200æ—¶ï¼Œè¯·æ±‚ä¼šé€€å‡ºå½“å‰è¯·æ±‚å¤„ç†é˜¶æ®µï¼Œç„¶åç›´æ¥è¿”å›ç»™å®¢æˆ·ç«¯ã€‚åœ¨æµ‹è¯•çš„æ—¶å€™å‘ç°ä¸€ä¸ªç‰¹ç‚¹æ˜¯æ— è®ºngx.exitè¿”å›ä»€ä¹ˆåº”ç­”ç ï¼Œlog_by_lua*é˜¶æ®µéƒ½ä¼šæ‰§è¡Œã€‚æœ¬æ¥ä»¥ä¸ºç›´æ¥è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œä¸ä¼šæ‰§è¡Œlogé˜¶æ®µçš„ï¼Œå› ä¸ºlogé˜¶æ®µä¹Ÿæ˜¯å¤„ç†æµç¨‹ä¸­çš„ä¸€ä¸ªé˜¶æ®µã€‚å…¶å®logé˜¶æ®µæ˜¯åœ¨è¿”å›ç»™å®¢æˆ·ç«¯ä¹‹åæ‰ä¼šæ‰§è¡Œçš„ä¸€ä¸ªé˜¶æ®µæ˜¯å§ã€‚ä»”ç»†æƒ³æ¥ä¹Ÿåº”è¯¥æ˜¯è¿™æ ·ï¼šï¼‰","like_count":6,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":456678,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562736538,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":119027,"user_name":"å°å¼º","can_delete":false,"product_type":"c1","uid":1294353,"ip_address":"","ucode":"154A18AD4028F3","user_header":"https://static001.geekbang.org/account/avatar/00/13/c0/11/3d59119f.jpg","comment_is_top":false,"comment_ctime":1564489241,"is_pvip":false,"replies":[{"id":"43749","content":"å½“ç„¶å¯ä»¥ï¼Œç°åœ¨æµè¡Œçš„ API ç½‘å…³ä¸å°‘éƒ½æ˜¯åŸºäº OpenResty çš„ã€‚JWT çš„å¯ä»¥å‚è€ƒè¿™é‡Œï¼šhttps:&#47;&#47;github.com&#47;iresty&#47;apisix&#47;blob&#47;master&#47;doc&#47;plugins&#47;jwt-auth-cn.md","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1564543372,"ip_address":"","comment_id":119027,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10154423833","product_id":100028301,"comment_content":"è€å¸ˆï¼Œopenresty å¯ä»¥åšapié‰´æƒå—ï¼Ÿç°åœ¨é¡¹ç›®ä¸­ç½‘å…³ç”¨çš„spring cloud gatewayå’Œjwtï¼Œåªåšé‰´æƒå’Œä»£ç†ï¼Œæ€§èƒ½è¾ƒå·®ï¼Œé€‚åˆå¾€openrestyè¿ç§»å—ï¼Ÿ","like_count":2,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":460713,"discussion_content":"å½“ç„¶å¯ä»¥ï¼Œç°åœ¨æµè¡Œçš„ API ç½‘å…³ä¸å°‘éƒ½æ˜¯åŸºäº OpenResty çš„ã€‚JWT çš„å¯ä»¥å‚è€ƒè¿™é‡Œï¼šhttps://github.com/iresty/apisix/blob/master/doc/plugins/jwt-auth-cn.md","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564543372,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":310584,"user_name":"Geek_c0ea3b","can_delete":false,"product_type":"c1","uid":1665832,"ip_address":"","ucode":"3F054407CDCF40","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/pJJpwhFRpXm1NFJ8HuiapckC8IibS0eHY99XqnAUtpicHXDdiajK3ObthbnenMTwRDGgvfv86LPEjKq06wzd9o8sHQ/132","comment_is_top":false,"comment_ctime":1630756558,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1630756558","product_id":100028301,"comment_content":"è€å¸ˆï¼Œè¯·é—®ä½œä¸ºåå‘ä»£ç†æ—¶ï¼Œè·å–ä¸Šæ¸¸æœåŠ¡å™¨çš„å“åº”ï¼Œä¸€èˆ¬æ˜¯é€šè¿‡ngx.arg[1]è¿™æ ·å—ï¼Ÿå¯¹äºè¾ƒå¤§çš„å“åº”ï¼Œngx.arg[1]å¯èƒ½éœ€è¦è·å–å¤šæ¬¡ï¼Œæ€§èƒ½ä¸Šå¯èƒ½ä¸æ˜¯æœ€ä¼˜ã€‚åƒä¸€èˆ¬è½¯WAFåœ¨å¤„ç†å“åº”è¿›è¡Œè§„åˆ¶åŒ¹é…æ—¶ï¼Œæ˜¯æ€ä¹ˆè·å–å“åº”çš„å‘¢ï¼Ÿ","like_count":0},{"had_liked":false,"id":110710,"user_name":"J.Smile","can_delete":false,"product_type":"c1","uid":1336475,"ip_address":"","ucode":"C4D98DFDBF7584","user_header":"https://static001.geekbang.org/account/avatar/00/14/64/9b/0b578b08.jpg","comment_is_top":false,"comment_ctime":1562318229,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1562318229","product_id":100028301,"comment_content":"çœ‹åˆ°è¿™é‡Œï¼Œæ‰è§‰å¾—æ¥è¿‘äº†å®æˆ˜ã€‚^_^","like_count":0},{"had_liked":false,"id":110665,"user_name":"2xshu","can_delete":false,"product_type":"c1","uid":1188473,"ip_address":"","ucode":"71584CB9676EDF","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKsz8j0bAayjSne9iakvjzUmvUdxWEbsM9iasQ74spGFayIgbSE232sH2LOWmaKtx1WqAFDiaYgVPwIQ/132","comment_is_top":false,"comment_ctime":1562311900,"is_pvip":false,"replies":[{"id":"40909","content":"æ˜¯çš„ï¼Œåœ¨ OpenResty ä¸­ Lua å±‚é¢çš„å†…å­˜éƒ½æ˜¯è‡ªåŠ¨ç®¡ç†çš„ã€‚<br>æ˜¯å¦å¯ä»¥ä½¿ç”¨åè¯æ³•ï¼Œå¦‚æœåœ¨ç»“æŸçš„æ—¶å€™æ²¡æœ‰é‡Šæ”¾ï¼Œé‚£ä¹ˆå†…å­˜å°±æ˜¯ä¸€ç›´å¢é•¿ã€‚ç”¨ wrk æˆ–è€… ab å‘é€å‡ ç™¾ä¸ªè¯·æ±‚ï¼Œç„¶åçœ‹çœ‹å†…å­˜çš„å ç”¨ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1562741233,"ip_address":"","comment_id":110665,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1562311900","product_id":100028301,"comment_content":"è€å¸ˆè¯·æ•™ä¸ª ngx.location.captureé—®é¢˜ï¼Œçœ‹lua apiå®˜æ–¹æ–‡æ¡£å¦‚ä¸‹ï¼š<br>This API function (as well as ngx.location.capture_multi) always buffers the whole response body of the subrequest in memory.<br>æƒ³é—®ä¸‹ï¼Œè¿™ä¸ªç¼“å­˜çš„response bodyï¼Œæ˜¯parent requestç»“æŸå°±ä¼šé‡Šæ”¾æ‰å—ï¼Ÿæœ‰ä»€ä¹ˆåŠæ³•å¯ä»¥éªŒè¯æˆ‘çš„çŒœæƒ³å—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":456996,"discussion_content":"æ˜¯çš„ï¼Œåœ¨ OpenResty ä¸­ Lua å±‚é¢çš„å†…å­˜éƒ½æ˜¯è‡ªåŠ¨ç®¡ç†çš„ã€‚\næ˜¯å¦å¯ä»¥ä½¿ç”¨åè¯æ³•ï¼Œå¦‚æœåœ¨ç»“æŸçš„æ—¶å€™æ²¡æœ‰é‡Šæ”¾ï¼Œé‚£ä¹ˆå†…å­˜å°±æ˜¯ä¸€ç›´å¢é•¿ã€‚ç”¨ wrk æˆ–è€… ab å‘é€å‡ ç™¾ä¸ªè¯·æ±‚ï¼Œç„¶åçœ‹çœ‹å†…å­˜çš„å ç”¨ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562741233,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":110212,"user_name":"psoracle","can_delete":false,"product_type":"c1","uid":1219195,"ip_address":"","ucode":"26F9B166508BBA","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/2xoGmvlQ9qfSibVpPJyyaEriavuWzXnuECrJITmGGHnGVuTibUuBho43Uib3Y5qgORHeSTxnOOSicxs0FV3HGvTpF0A/132","comment_is_top":false,"comment_ctime":1562208506,"is_pvip":false,"replies":[{"id":"40891","content":"å®˜æ–¹ LuaJIT å¹¶æ²¡æœ‰è¿™ä¸ªé—®é¢˜ï¼ŒOpenResty å¸¦çš„ LuaJIT ç¡®å®ä¼šå¦‚æ­¤ã€‚æˆ‘ä¹Ÿä¸å¤ªæ¸…æ¥šè¿™ä¹ˆåšçš„åŸå› ï¼Œå¯èƒ½æ˜¯ä¸ª bugï¼Œä½ å¯ä»¥åˆ°https:&#47;&#47;github.com&#47;openresty&#47;luajit2æäº¤ issue è¯¢é—®ä¸‹ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1562736167,"ip_address":"","comment_id":110212,"utype":1}],"discussion_count":3,"race_medal":0,"score":"1562208506","product_id":100028301,"comment_content":"ä¸€ç›´æ²¡ææ˜ç™½ä¸ºä»€ä¹ˆluajitæä¾›çš„shellå‘½ä»¤è¡Œä¸­ä¸èƒ½ä½¿ç”¨local æœ¬åœ°å˜é‡ï¼Œå¯ä»¥å®šä¹‰å£°æ˜ï¼Œä½†ä½¿ç”¨æ—¶è¿˜æ˜¯å°è¯•ä»global indexä¸­æŸ¥æ‰¾ï¼Œæ‰€ä»¥æ‰¾ä¸åˆ°ã€‚<br>![](http:&#47;&#47;wimgss.oss-cn-hangzhou.aliyuncs.com&#47;2019-07-04-024647.png)","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":456777,"discussion_content":"å®˜æ–¹ LuaJIT å¹¶æ²¡æœ‰è¿™ä¸ªé—®é¢˜ï¼ŒOpenResty å¸¦çš„ LuaJIT ç¡®å®ä¼šå¦‚æ­¤ã€‚æˆ‘ä¹Ÿä¸å¤ªæ¸…æ¥šè¿™ä¹ˆåšçš„åŸå› ï¼Œå¯èƒ½æ˜¯ä¸ª bugï¼Œä½ å¯ä»¥åˆ°https://github.com/openresty/luajit2æäº¤ issue è¯¢é—®ä¸‹ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562736167,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1219195,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/2xoGmvlQ9qfSibVpPJyyaEriavuWzXnuECrJITmGGHnGVuTibUuBho43Uib3Y5qgORHeSTxnOOSicxs0FV3HGvTpF0A/132","nickname":"psoracle","note":"","ucode":"26F9B166508BBA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1030,"discussion_content":"æ„Ÿè§‰ä¸Šæ˜¯ä¸€è¡Œä¸€ä¸ªä¸Šä¸‹æ–‡ï¼Œä¸åŒçš„ä»£ç å—","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1562251049,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1189836,"avatar":"https://static001.geekbang.org/account/avatar/00/12/27/cc/99349a54.jpg","nickname":"é»‘é“æ‰“é‡ç‹","note":"","ucode":"09FCB9DB732177","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1028,"discussion_content":"local ffi = require(&#34;ffi&#34;); ffi.cdef[[int printf(const char *fmt, ...)]];ffi.C.printf(&#34;hello world&#34;) æˆ‘åœ¨ä¸€è¡Œè¿è¡Œå°±å¯ä»¥, åº”è¯¥æ˜¯luajitæ¯æ‰§è¡Œä¸€è¡Œå°±æ˜¯ä¸€ä¸ªæ–°çš„ä»£ç å—, åªæœ‰globalä½œç”¨åŸŸçš„å˜é‡èƒ½ç”¨.","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1562248221,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":110081,"user_name":"å°é£å“¥ â€è¶…ç´šæœƒå“¡","can_delete":false,"product_type":"c1","uid":1110049,"ip_address":"","ucode":"417F9563B3005B","user_header":"https://static001.geekbang.org/account/avatar/00/10/f0/21/104b9565.jpg","comment_is_top":false,"comment_ctime":1562168638,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1562168638","product_id":100028301,"comment_content":"çœ‹åˆ°è¿™é‡Œï¼Œå·²ç»ä¸çŸ¥é“åº”è¯¥å¦‚ä½•æ“ä½œäº†ã€‚","like_count":0},{"had_liked":false,"id":109888,"user_name":"psoracle","can_delete":false,"product_type":"c1","uid":1219195,"ip_address":"","ucode":"26F9B166508BBA","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/2xoGmvlQ9qfSibVpPJyyaEriavuWzXnuECrJITmGGHnGVuTibUuBho43Uib3Y5qgORHeSTxnOOSicxs0FV3HGvTpF0A/132","comment_is_top":false,"comment_ctime":1562125321,"is_pvip":false,"replies":[{"id":"40899","content":"content by lua è¿™ä¸ªæ˜¯ nginx çš„æŒ‡ä»¤ï¼Œä¸èƒ½åœ¨ resty é‡Œé¢è°ƒç”¨","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1562737267,"ip_address":"","comment_id":109888,"utype":1}],"discussion_count":3,"race_medal":0,"score":"1562125321","product_id":100028301,"comment_content":"å¦‚æœåœ¨restyä¸­ç†Ÿæ‚‰å¤„ç†httpè¯·æ±‚çš„apiï¼Œå¦‚ngx.req.http_versionï¼Œæˆ‘æ˜¯ä½¿ç”¨restyå¯åŠ¨ä¸€ä¸ªmini http serverï¼Œä»£ç ä¸­æ‰“å°å½“å‰è®¿é—®çš„http ä¿¡æ¯ï¼Œä½¿ç”¨curl -XMETHODæ¥è°ƒç”¨<br>![](http:&#47;&#47;wimgss.oss-cn-hangzhou.aliyuncs.com&#47;2019-07-03-034013.png)","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":456625,"discussion_content":"content by lua è¿™ä¸ªæ˜¯ nginx çš„æŒ‡ä»¤ï¼Œä¸èƒ½åœ¨ resty é‡Œé¢è°ƒç”¨","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562737267,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1189836,"avatar":"https://static001.geekbang.org/account/avatar/00/12/27/cc/99349a54.jpg","nickname":"é»‘é“æ‰“é‡ç‹","note":"","ucode":"09FCB9DB732177","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1027,"discussion_content":"init_worker_by_luaåªä¼šåœ¨æ¯ä¸ª Worker è¿›ç¨‹è¢«åˆ›å»ºæ—¶æ‰§ è¿™ä¸ªæ—¶å€™æ²¡æœ‰è¯·æ±‚,ä¸èƒ½è·å–è¯·æ±‚ç›¸å…³çš„å†…å®¹.","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1562247142,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1219195,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/2xoGmvlQ9qfSibVpPJyyaEriavuWzXnuECrJITmGGHnGVuTibUuBho43Uib3Y5qgORHeSTxnOOSicxs0FV3HGvTpF0A/132","nickname":"psoracle","note":"","ucode":"26F9B166508BBA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":942,"discussion_content":"é‡æ–°å­¦ä¹ äº†ä¸€ä¸‹02è¯¾ï¼ŒæŸ¥çœ‹restyç”Ÿæˆçš„nginx.confæ–‡ä»¶ï¼Œå‘ç°luaä»£ç æ˜¯åœ¨ init_worker_by_lua_block ä¸­æ‰§è¡Œçš„ï¼Œè€Œåƒngx.req.http_versionä¹‹ç±»apiæ˜¯ä¸èƒ½ç”¨åœ¨è¿™ä¸ªé˜¶æ®µï¼Œå¦å¤–ï¼Œrestyä¹Ÿæ— æ³•é…ç½®serverç›‘å¬æŸä¸ªç«¯å£ï¼Œæ‰€ä»¥æƒ³ä½¿ç”¨restyå¯åŠ¨è¿·ä½ serverï¼Œæ–¹ä¾¿æµ‹è¯•httpè¯·æ±‚å¤„ç†apiåº”è¯¥æ˜¯ä¸è¡Œçš„ï¼›åªèƒ½è€è€å®å®åœ¨openrestyçš„nginx.confä¸­includeè‡ªå·±çš„serveré…ç½®æ¥æµ‹è¯•äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562164302,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":109779,"user_name":"manatee","can_delete":false,"product_type":"c1","uid":1041112,"ip_address":"","ucode":"708D90E7A265BD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/e2/d8/f0562ede.jpg","comment_is_top":false,"comment_ctime":1562113698,"is_pvip":false,"replies":[{"id":"40894","content":"å¹¶æ²¡æœ‰ç‰¹åˆ«è¦æ³¨æ„çš„åœ°æ–¹","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1562736690,"ip_address":"","comment_id":109779,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1562113698","product_id":100028301,"comment_content":"å¯¹äºä¸åŒcontenttypeçš„è¯·æ±‚ä½“ï¼Œæœ‰ä»€ä¹ˆéœ€è¦ç‰¹åˆ«æ³¨æ„çš„å—","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":456566,"discussion_content":"å¹¶æ²¡æœ‰ç‰¹åˆ«è¦æ³¨æ„çš„åœ°æ–¹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562736690,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1219195,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/2xoGmvlQ9qfSibVpPJyyaEriavuWzXnuECrJITmGGHnGVuTibUuBho43Uib3Y5qgORHeSTxnOOSicxs0FV3HGvTpF0A/132","nickname":"psoracle","note":"","ucode":"26F9B166508BBA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":941,"discussion_content":"httpåè®®ä¸­å¹¶æ²¡æœ‰å¯¹bodyè¿›è¡Œçº¦æŸå§ï¼ŒContent-Typeåªæ˜¯ç”¨äºå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´åè®®å¦‚ä½•è§£æbodyçš„å§","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1562163996,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}