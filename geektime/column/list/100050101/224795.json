{"id":224795,"title":"02 | æ—¥å¿—ï¼ˆä¸Šï¼‰ï¼šæ—¥å¿—ç©¶ç«Ÿæ˜¯å¦‚ä½•åŠ è½½æ—¥å¿—æ®µçš„ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯èƒ¡å¤•ã€‚ä»Šå¤©æˆ‘æ¥è®²è®²Kafkaæºç çš„æ—¥å¿—ï¼ˆLogï¼‰å¯¹è±¡ã€‚</p><p>ä¸ŠèŠ‚è¯¾ï¼Œæˆ‘ä»¬å­¦ä¹ äº†æ—¥å¿—æ®µéƒ¨åˆ†çš„æºç ï¼Œä½ å¯ä»¥è®¤ä¸ºï¼Œ<strong>æ—¥å¿—æ˜¯æ—¥å¿—æ®µçš„å®¹å™¨ï¼Œé‡Œé¢å®šä¹‰äº†å¾ˆå¤šç®¡ç†æ—¥å¿—æ®µçš„æ“ä½œ</strong>ã€‚å¦ç‡åœ°è¯´ï¼Œå¦‚æœçœ‹Kafkaæºç å´ä¸çœ‹Logï¼Œå°±è·Ÿä½ ä¹°äº†è¿™é—¨è¯¾å´ä¸çŸ¥é“ä½œè€…æ˜¯è°ä¸€æ ·ã€‚åœ¨æˆ‘çœ‹æ¥ï¼ŒLogå¯¹è±¡æ˜¯Kafkaæºç ï¼ˆç‰¹åˆ«æ˜¯Brokerç«¯ï¼‰æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œæ²¡æœ‰ä¹‹ä¸€ã€‚</p><p>å®ƒåˆ°åº•æœ‰å¤šé‡è¦å‘¢ï¼Ÿæˆ‘å’Œä½ åˆ†äº«ä¸€ä¸ªä¾‹å­ï¼Œä½ å…ˆæ„Ÿå—ä¸‹ã€‚æˆ‘æœ€è¿‘æ­£åœ¨ä¿®å¤ä¸€ä¸ªKafkaçš„Bugï¼ˆ<a href=\"https://issues.apache.org/jira/browse/KAFKA-9157\">KAFKA-9157</a>ï¼‰ï¼šåœ¨æŸäº›æƒ…å†µä¸‹ï¼ŒKafkaçš„Compactionæ“ä½œä¼šäº§ç”Ÿå¾ˆå¤šç©ºçš„æ—¥å¿—æ®µæ–‡ä»¶ã€‚å¦‚æœè¦é¿å…è¿™äº›ç©ºæ—¥å¿—æ®µæ–‡ä»¶è¢«åˆ›å»ºå‡ºæ¥ï¼Œå°±å¿…é¡»ææ‡‚åˆ›å»ºæ—¥å¿—æ®µæ–‡ä»¶çš„åŸç†ï¼Œè€Œè¿™äº›ä»£ç æ°æ°å°±åœ¨Logæºç ä¸­ã€‚</p><p>æ—¢ç„¶Logæºç è¦ç®¡ç†æ—¥å¿—æ®µå¯¹è±¡ï¼Œé‚£ä¹ˆå®ƒå°±å¿…é¡»å…ˆæŠŠæ‰€æœ‰æ—¥å¿—æ®µå¯¹è±¡åŠ è½½åˆ°å†…å­˜é‡Œé¢ã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿä»Šå¤©ï¼Œæˆ‘å°±å¸¦ä½ å­¦ä¹ ä¸‹æ—¥å¿—åŠ è½½æ—¥å¿—æ®µçš„è¿‡ç¨‹ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹Logå¯¹è±¡çš„æºç ç»“æ„ã€‚</p><h2>Logæºç ç»“æ„</h2><p>Logæºç ä½äºKafka coreå·¥ç¨‹çš„logæºç åŒ…ä¸‹ï¼Œæ–‡ä»¶åæ˜¯Log.scalaã€‚æ€»ä½“ä¸Šï¼Œè¯¥æ–‡ä»¶å®šä¹‰äº†10ä¸ªç±»å’Œå¯¹è±¡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/81/ce/8126a191f63d9abea860d71992b0aece.jpg?wh=863*606\" alt=\"\"></p><p>é‚£ä¹ˆï¼Œè¿™10ä¸ªç±»å’Œå¯¹è±¡éƒ½æ˜¯åšä»€ä¹ˆçš„å‘¢ï¼Ÿæˆ‘å…ˆç»™ä½ ç®€å•ä»‹ç»ä¸€ä¸‹ï¼Œä½ å¯ä»¥å¯¹å®ƒä»¬æœ‰ä¸ªå¤§è‡´çš„äº†è§£ã€‚</p><!-- [[[read_end]]] --><p>ä¸è¿‡ï¼Œåœ¨ä»‹ç»ä¹‹å‰ï¼Œæˆ‘å…ˆæä¸€å¥ï¼Œå›¾ä¸­æ‹¬å·é‡Œçš„Cè¡¨ç¤ºClassï¼ŒOè¡¨ç¤ºObjectã€‚è¿˜è®°å¾—æˆ‘åœ¨ä¸ŠèŠ‚è¯¾æåˆ°è¿‡çš„ä¼´ç”Ÿå¯¹è±¡å—ï¼Ÿæ²¡é”™ï¼ŒåŒæ—¶å®šä¹‰åŒåçš„Classå’ŒObjectï¼Œå°±å±äºScalaä¸­çš„ä¼´ç”Ÿå¯¹è±¡ç”¨æ³•ã€‚</p><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¼´ç”Ÿå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯LogAppendInfoã€Logå’ŒRollParamsã€‚</p><p><strong>1.LogAppendInfo</strong></p><ul>\n<li>LogAppendInfoï¼ˆCï¼‰ï¼šä¿å­˜äº†ä¸€ç»„å¾…å†™å…¥æ¶ˆæ¯çš„å„ç§å…ƒæ•°æ®ä¿¡æ¯ã€‚æ¯”å¦‚ï¼Œè¿™ç»„æ¶ˆæ¯ä¸­ç¬¬ä¸€æ¡æ¶ˆæ¯çš„ä½ç§»å€¼æ˜¯å¤šå°‘ã€æœ€åä¸€æ¡æ¶ˆæ¯çš„ä½ç§»å€¼æ˜¯å¤šå°‘ï¼›å†æ¯”å¦‚ï¼Œè¿™ç»„æ¶ˆæ¯ä¸­æœ€å¤§çš„æ¶ˆæ¯æ—¶é—´æˆ³åˆæ˜¯å¤šå°‘ã€‚æ€»ä¹‹ï¼Œè¿™é‡Œé¢çš„æ•°æ®éå¸¸ä¸°å¯Œï¼ˆä¸‹èŠ‚è¯¾æˆ‘å†å…·ä½“è¯´è¯´ï¼‰ã€‚</li>\n<li>LogAppendInfoï¼ˆOï¼‰: å¯ä»¥ç†è§£ä¸ºå…¶å¯¹åº”ä¼´ç”Ÿç±»çš„å·¥å‚æ–¹æ³•ç±»ï¼Œé‡Œé¢å®šä¹‰äº†ä¸€äº›å·¥å‚æ–¹æ³•ï¼Œç”¨äºåˆ›å»ºç‰¹å®šçš„LogAppendInfoå®ä¾‹ã€‚</li>\n</ul><p><strong>2.Log</strong></p><ul>\n<li>Logï¼ˆCï¼‰: Logæºç ä¸­æœ€æ ¸å¿ƒçš„ä»£ç ã€‚è¿™é‡Œæˆ‘å…ˆå–ä¸ªå…³å­ï¼Œä¸€ä¼šå„¿ç»†èŠã€‚</li>\n<li>Logï¼ˆOï¼‰ï¼šåŒç†ï¼ŒLogä¼´ç”Ÿç±»çš„å·¥å‚æ–¹æ³•ï¼Œå®šä¹‰äº†å¾ˆå¤šå¸¸é‡ä»¥åŠä¸€äº›è¾…åŠ©æ–¹æ³•ã€‚</li>\n</ul><p><strong>3.RollParams</strong></p><ul>\n<li>RollParamsï¼ˆCï¼‰ï¼šå®šä¹‰ç”¨äºæ§åˆ¶æ—¥å¿—æ®µæ˜¯å¦åˆ‡åˆ†ï¼ˆRollï¼‰çš„æ•°æ®ç»“æ„ã€‚</li>\n<li>RollParamsï¼ˆOï¼‰ï¼šåŒç†ï¼ŒRollParamsä¼´ç”Ÿç±»çš„å·¥å‚æ–¹æ³•ã€‚</li>\n</ul><p>é™¤äº†è¿™3ç»„ä¼´ç”Ÿå¯¹è±¡ä¹‹å¤–ï¼Œè¿˜æœ‰4ç±»æºç ã€‚</p><ul>\n<li>LogMetricNamesï¼šå®šä¹‰äº†Logå¯¹è±¡çš„ç›‘æ§æŒ‡æ ‡ã€‚</li>\n<li>LogOffsetSnapshotï¼šå°è£…åˆ†åŒºæ‰€æœ‰ä½ç§»å…ƒæ•°æ®çš„å®¹å™¨ç±»ã€‚</li>\n<li>LogReadInfoï¼šå°è£…è¯»å–æ—¥å¿—è¿”å›çš„æ•°æ®åŠå…¶å…ƒæ•°æ®ã€‚</li>\n<li>CompletedTxnï¼šè®°å½•å·²å®Œæˆäº‹åŠ¡çš„å…ƒæ•°æ®ï¼Œä¸»è¦ç”¨äºæ„å»ºäº‹åŠ¡ç´¢å¼•ã€‚</li>\n</ul><h2>Log Class &amp; Object</h2><p>ä¸‹é¢ï¼Œæˆ‘ä¼šæŒ‰ç…§è¿™äº›ç±»å’Œå¯¹è±¡çš„é‡è¦ç¨‹åº¦ï¼Œå¯¹å®ƒä»¬ä¸€ä¸€è¿›è¡Œæ‹†è§£ã€‚é¦–å…ˆï¼Œå’±ä»¬å…ˆè¯´è¯´Logç±»åŠå…¶ä¼´ç”Ÿå¯¹è±¡ã€‚</p><p>è€ƒè™‘åˆ°ä¼´ç”Ÿå¯¹è±¡å¤šç”¨äºä¿å­˜é™æ€å˜é‡å’Œé™æ€æ–¹æ³•ï¼ˆæ¯”å¦‚é™æ€å·¥å‚æ–¹æ³•ç­‰ï¼‰ï¼Œå› æ­¤æˆ‘ä»¬å…ˆçœ‹ä¼´ç”Ÿå¯¹è±¡ï¼ˆå³Log Objectï¼‰çš„å®ç°ã€‚æ¯•ç«Ÿï¼ŒæŸ¿å­å…ˆæ‰¾è½¯çš„æï¼</p><pre><code>object Log {\n  val LogFileSuffix = &quot;.log&quot;\n  val IndexFileSuffix = &quot;.index&quot;\n  val TimeIndexFileSuffix = &quot;.timeindex&quot;\n  val ProducerSnapshotFileSuffix = &quot;.snapshot&quot;\n  val TxnIndexFileSuffix = &quot;.txnindex&quot;\n  val DeletedFileSuffix = &quot;.deleted&quot;\n  val CleanedFileSuffix = &quot;.cleaned&quot;\n  val SwapFileSuffix = &quot;.swap&quot;\n  val CleanShutdownFile = &quot;.kafka_cleanshutdown&quot;\n  val DeleteDirSuffix = &quot;-delete&quot;\n  val FutureDirSuffix = &quot;-future&quot;\nâ€¦â€¦\n}\n</code></pre><p>è¿™æ˜¯Log Objectå®šä¹‰çš„æ‰€æœ‰å¸¸é‡ã€‚å¦‚æœæœ‰é¢è¯•å®˜é—®ä½ Kafkaä¸­å®šä¹‰äº†å¤šå°‘ç§æ–‡ä»¶ç±»å‹ï¼Œä½ å¯ä»¥è‡ªè±ªåœ°æŠŠè¿™äº›è¯´å‡ºæ¥ã€‚è€³ç†Ÿèƒ½è¯¦çš„.logã€.indexã€.timeindexå’Œ.txnindexæˆ‘å°±ä¸è§£é‡Šäº†ï¼Œæˆ‘ä»¬æ¥äº†è§£ä¸‹å…¶ä»–å‡ ç§æ–‡ä»¶ç±»å‹ã€‚</p><ul>\n<li>.snapshotæ˜¯Kafkaä¸ºå¹‚ç­‰å‹æˆ–äº‹åŠ¡å‹Produceræ‰€åšçš„å¿«ç…§æ–‡ä»¶ã€‚é‰´äºæˆ‘ä»¬ç°åœ¨è¿˜å¤„äºé˜…è¯»æºç çš„åˆçº§é˜¶æ®µï¼Œäº‹åŠ¡æˆ–å¹‚ç­‰éƒ¨åˆ†çš„æºç æˆ‘å°±ä¸è¯¦ç»†å±•å¼€è®²äº†ã€‚</li>\n<li>.deletedæ˜¯åˆ é™¤æ—¥å¿—æ®µæ“ä½œåˆ›å»ºçš„æ–‡ä»¶ã€‚ç›®å‰åˆ é™¤æ—¥å¿—æ®µæ–‡ä»¶æ˜¯å¼‚æ­¥æ“ä½œï¼ŒBrokerç«¯æŠŠæ—¥å¿—æ®µæ–‡ä»¶ä».logåç¼€ä¿®æ”¹ä¸º.deletedåç¼€ã€‚å¦‚æœä½ çœ‹åˆ°ä¸€å¤§å †.deletedåç¼€çš„æ–‡ä»¶åï¼Œåˆ«æ…Œï¼Œè¿™æ˜¯Kafkaåœ¨æ‰§è¡Œæ—¥å¿—æ®µæ–‡ä»¶åˆ é™¤ã€‚</li>\n<li>.cleanedå’Œ.swapéƒ½æ˜¯Compactionæ“ä½œçš„äº§ç‰©ï¼Œç­‰æˆ‘ä»¬è®²åˆ°Cleanerçš„æ—¶å€™å†è¯´ã€‚</li>\n<li>-deleteåˆ™æ˜¯åº”ç”¨äºæ–‡ä»¶å¤¹çš„ã€‚å½“ä½ åˆ é™¤ä¸€ä¸ªä¸»é¢˜çš„æ—¶å€™ï¼Œä¸»é¢˜çš„åˆ†åŒºæ–‡ä»¶å¤¹ä¼šè¢«åŠ ä¸Šè¿™ä¸ªåç¼€ã€‚</li>\n<li>-futureæ˜¯ç”¨äºå˜æ›´ä¸»é¢˜åˆ†åŒºæ–‡ä»¶å¤¹åœ°å€çš„ï¼Œå±äºæ¯”è¾ƒé«˜é˜¶çš„ç”¨æ³•ã€‚</li>\n</ul><p>æ€»ä¹‹ï¼Œè®°ä½è¿™äº›å¸¸é‡å§ã€‚è®°ä½å®ƒä»¬çš„ä¸»è¦ä½œç”¨æ˜¯ï¼Œä»¥åä¸è¦è¢«é¢è¯•å®˜å”¬ä½ï¼å¼€ç©ç¬‘ï¼Œå…¶å®è¿™äº›å¸¸é‡æœ€é‡è¦çš„åœ°æ–¹å°±åœ¨äºï¼Œå®ƒä»¬èƒ½å¤Ÿè®©ä½ äº†è§£Kafkaå®šä¹‰çš„å„ç§æ–‡ä»¶ç±»å‹ã€‚</p><p>Log Objectè¿˜å®šä¹‰äº†è¶…å¤šçš„å·¥å…·ç±»æ–¹æ³•ã€‚ç”±äºå®ƒä»¬éƒ½å¾ˆç®€å•ï¼Œè¿™é‡Œæˆ‘åªç»™å‡ºä¸€ä¸ªæ–¹æ³•çš„æºç ï¼Œæˆ‘ä»¬ä¸€èµ·è¯»ä¸€ä¸‹ã€‚</p><pre><code>def filenamePrefixFromOffset(offset: Long): String = {\n    val nf = NumberFormat.getInstance()\n    nf.setMinimumIntegerDigits(20)\n    nf.setMaximumFractionDigits(0)\n    nf.setGroupingUsed(false)\n    nf.format(offset)\n  }\n</code></pre><p>è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯<strong>é€šè¿‡ç»™å®šçš„ä½ç§»å€¼è®¡ç®—å‡ºå¯¹åº”çš„æ—¥å¿—æ®µæ–‡ä»¶å</strong>ã€‚Kafkaæ—¥å¿—æ–‡ä»¶å›ºå®šæ˜¯20ä½çš„é•¿åº¦ï¼ŒfilenamePrefixFromOffsetæ–¹æ³•å°±æ˜¯ç”¨å‰é¢è¡¥0çš„æ–¹å¼ï¼ŒæŠŠç»™å®šä½ç§»å€¼æ‰©å……æˆä¸€ä¸ªå›ºå®š20ä½é•¿åº¦çš„å­—ç¬¦ä¸²ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬ç»™å®šä¸€ä¸ªä½ç§»å€¼æ˜¯12345ï¼Œé‚£ä¹ˆBrokerç«¯ç£ç›˜ä¸Šå¯¹åº”çš„æ—¥å¿—æ®µæ–‡ä»¶åå°±åº”è¯¥æ˜¯00000000000000012345.logã€‚æ€ä¹ˆæ ·ï¼Œå¾ˆç®€å•å§ï¼Ÿå…¶ä»–çš„å·¥å…·ç±»æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œæˆ‘å°±ä¸ä¸€ä¸€å±•å¼€è¯´äº†ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹Logæºç éƒ¨åˆ†çš„é‡å¤´æˆï¼š<strong>Logç±»</strong>ã€‚è¿™æ˜¯ä¸€ä¸ª2000å¤šè¡Œçš„å¤§ç±»ã€‚æ”¾çœ¼æ•´ä¸ªKafkaæºç ï¼ŒåƒLogè¿™ä¹ˆå¤§çš„ç±»ä¹Ÿä¸å¤šè§ï¼Œè¶³è§å®ƒçš„é‡è¦ç¨‹åº¦ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹è¿™ä¸ªç±»çš„å®šä¹‰ï¼š</p><pre><code>class Log(@volatile var dir: File,\n          @volatile var config: LogConfig,\n          @volatile var logStartOffset: Long,\n          @volatile var recoveryPoint: Long,\n          scheduler: Scheduler,\n          brokerTopicStats: BrokerTopicStats,\n          val time: Time,\n          val maxProducerIdExpirationMs: Int,\n          val producerIdExpirationCheckIntervalMs: Int,\n          val topicPartition: TopicPartition,\n          val producerStateManager: ProducerStateManager,\n          logDirFailureChannel: LogDirFailureChannel) extends Logging with KafkaMetricsGroup {\nâ€¦â€¦\n}\n</code></pre><p>çœ‹ç€å¥½åƒæœ‰å¾ˆå¤šå±æ€§ï¼Œä½†å…¶å®ï¼Œä½ åªéœ€è¦è®°ä½ä¸¤ä¸ªå±æ€§çš„ä½œç”¨å°±å¤Ÿäº†ï¼š<strong>dirå’ŒlogStartOffset</strong>ã€‚dirå°±æ˜¯è¿™ä¸ªæ—¥å¿—æ‰€åœ¨çš„æ–‡ä»¶å¤¹è·¯å¾„ï¼Œä¹Ÿå°±æ˜¯<strong>ä¸»é¢˜åˆ†åŒºçš„è·¯å¾„</strong>ã€‚è€ŒlogStartOffsetï¼Œè¡¨ç¤º<strong>æ—¥å¿—çš„å½“å‰æœ€æ—©ä½ç§»</strong>ã€‚dirå’ŒlogStartOffsetéƒ½æ˜¯volatile varç±»å‹ï¼Œè¡¨ç¤ºå®ƒä»¬çš„å€¼æ˜¯å˜åŠ¨çš„ï¼Œè€Œä¸”å¯èƒ½è¢«å¤šä¸ªçº¿ç¨‹æ›´æ–°ã€‚</p><p>ä½ å¯èƒ½å¬è¿‡æ—¥å¿—çš„å½“å‰æœ«ç«¯ä½ç§»ï¼Œä¹Ÿå°±æ˜¯Log End Offsetï¼ˆLEOï¼‰ï¼Œå®ƒæ˜¯è¡¨ç¤ºæ—¥å¿—ä¸‹ä¸€æ¡å¾…æ’å…¥æ¶ˆæ¯çš„ä½ç§»å€¼ï¼Œè€Œè¿™ä¸ªLog Start Offsetæ˜¯è·Ÿå®ƒç›¸åçš„ï¼Œå®ƒè¡¨ç¤ºæ—¥å¿—å½“å‰å¯¹å¤–å¯è§çš„æœ€æ—©ä¸€æ¡æ¶ˆæ¯çš„ä½ç§»å€¼ã€‚æˆ‘ç”¨ä¸€å¼ å›¾æ¥æ ‡è¯†å®ƒä»¬çš„åŒºåˆ«ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/38/b4/388672f6dab8571f272ed47c9679c2b4.jpg?wh=4000*2250\" alt=\"\"></p><p>å›¾ä¸­ç»¿è‰²çš„ä½ç§»å€¼3æ˜¯æ—¥å¿—çš„Log Start Offsetï¼Œè€Œä½ç§»å€¼15è¡¨ç¤ºLEOã€‚å¦å¤–ï¼Œä½ç§»å€¼8æ˜¯é«˜æ°´ä½å€¼ï¼Œå®ƒæ˜¯åŒºåˆ†å·²æäº¤æ¶ˆæ¯å’Œæœªæäº¤æ¶ˆæ¯çš„åˆ†æ°´å²­ã€‚</p><p>æœ‰æ„æ€çš„æ˜¯ï¼ŒLog End Offsetå¯ä»¥ç®€ç§°ä¸ºLEOï¼Œä½†Log Start Offsetå´ä¸èƒ½ç®€ç§°ä¸ºLSOã€‚å› ä¸ºåœ¨Kafkaä¸­ï¼ŒLSOç‰¹æŒ‡Log Stable Offsetï¼Œå±äºKafkaäº‹åŠ¡çš„æ¦‚å¿µã€‚è¿™ä¸ªè¯¾ç¨‹ä¸­ä¸ä¼šæ¶‰åŠLSOï¼Œä½ åªéœ€è¦çŸ¥é“Log Start Offsetä¸ç­‰äºLSOå³å¯ã€‚</p><p>Logç±»çš„å…¶ä»–å±æ€§ä½ æš‚æ—¶ä¸ç”¨ç†ä¼šï¼Œå› ä¸ºå®ƒä»¬è¦ä¹ˆæ˜¯å¾ˆæ˜æ˜¾çš„å·¥å…·ç±»å±æ€§ï¼Œæ¯”å¦‚timerå’Œschedulerï¼Œè¦ä¹ˆæ˜¯é«˜é˜¶ç”¨æ³•æ‰ä¼šç”¨åˆ°çš„é«˜çº§å±æ€§ï¼Œæ¯”å¦‚producerStateManagerå’ŒlogDirFailureChannelã€‚å·¥å…·ç±»çš„ä»£ç å¤§å¤šæ˜¯åšè¾…åŠ©ç”¨çš„ï¼Œè·³è¿‡å®ƒä»¬ä¹Ÿä¸å¦¨ç¢æˆ‘ä»¬ç†è§£Kafkaçš„æ ¸å¿ƒåŠŸèƒ½ï¼›è€Œé«˜é˜¶åŠŸèƒ½ä»£ç è®¾è®¡å¤æ‚ï¼Œå­¦ä¹ æˆæœ¬é«˜ï¼Œæ€§ä»·æ¯”ä¸é«˜ã€‚</p><p>å…¶å®ï¼Œé™¤äº†Logç±»ç­¾åå®šä¹‰çš„è¿™äº›å±æ€§ä¹‹å¤–ï¼ŒLogç±»è¿˜å®šä¹‰äº†ä¸€äº›å¾ˆé‡è¦çš„å±æ€§ï¼Œæ¯”å¦‚ä¸‹é¢è¿™æ®µä»£ç ï¼š</p><pre><code>    @volatile private var nextOffsetMetadata: LogOffsetMetadata = _\n    @volatile private var highWatermarkMetadata: LogOffsetMetadata = LogOffsetMetadata(logStartOffset)\n    private val segments: ConcurrentNavigableMap[java.lang.Long, LogSegment] = new ConcurrentSkipListMap[java.lang.Long, LogSegment]\n    @volatile var leaderEpochCache: Option[LeaderEpochFileCache] = None\n</code></pre><p>ç¬¬ä¸€ä¸ªå±æ€§nextOffsetMetadataï¼Œå®ƒå°è£…äº†ä¸‹ä¸€æ¡å¾…æ’å…¥æ¶ˆæ¯çš„ä½ç§»å€¼ï¼Œä½ åŸºæœ¬ä¸Šå¯ä»¥æŠŠè¿™ä¸ªå±æ€§å’ŒLEOç­‰åŒèµ·æ¥ã€‚</p><p>ç¬¬äºŒä¸ªå±æ€§highWatermarkMetadataï¼Œæ˜¯åˆ†åŒºæ—¥å¿—é«˜æ°´ä½å€¼ã€‚å…³äºé«˜æ°´ä½çš„æ¦‚å¿µï¼Œæˆ‘ä»¬åœ¨<a href=\"https://time.geekbang.org/column/intro/100029201\">ã€ŠKafkaæ ¸å¿ƒæŠ€æœ¯ä¸å®æˆ˜ã€‹</a>è¿™ä¸ªè¯¾ç¨‹ä¸­åšè¿‡è¯¦ç»†è§£é‡Šï¼Œä½ å¯ä»¥çœ‹ä¸€ä¸‹<a href=\"https://time.geekbang.org/column/article/112118\">è¿™ç¯‡æ–‡ç« </a>ï¼ˆä¸‹èŠ‚è¯¾æˆ‘è¿˜ä¼šå†å…·ä½“ç»™ä½ ä»‹ç»ä¸‹ï¼‰ã€‚</p><p>ç¬¬ä¸‰ä¸ªå±æ€§segmentsï¼Œæˆ‘è®¤ä¸ºè¿™æ˜¯Logç±»ä¸­æœ€é‡è¦çš„å±æ€§ã€‚å®ƒä¿å­˜äº†åˆ†åŒºæ—¥å¿—ä¸‹æ‰€æœ‰çš„æ—¥å¿—æ®µä¿¡æ¯ï¼Œåªä¸è¿‡æ˜¯ç”¨Mapçš„æ•°æ®ç»“æ„æ¥ä¿å­˜çš„ã€‚Mapçš„Keyå€¼æ˜¯æ—¥å¿—æ®µçš„èµ·å§‹ä½ç§»å€¼ï¼ŒValueåˆ™æ˜¯æ—¥å¿—æ®µå¯¹è±¡æœ¬èº«ã€‚Kafkaæºç ä½¿ç”¨ConcurrentNavigableMapæ•°æ®ç»“æ„æ¥ä¿å­˜æ—¥å¿—æ®µå¯¹è±¡ï¼Œå°±å¯ä»¥å¾ˆè½»æ¾åœ°åˆ©ç”¨è¯¥ç±»æä¾›çš„çº¿ç¨‹å®‰å…¨å’Œå„ç§æ”¯æŒæ’åºçš„æ–¹æ³•ï¼Œæ¥ç®¡ç†æ‰€æœ‰æ—¥å¿—æ®µå¯¹è±¡ã€‚</p><p>ç¬¬å››ä¸ªå±æ€§æ˜¯Leader Epoch Cacheå¯¹è±¡ã€‚Leader Epochæ˜¯ç¤¾åŒºäº0.11.0.0ç‰ˆæœ¬å¼•å…¥æºç ä¸­çš„ï¼Œä¸»è¦æ˜¯ç”¨æ¥åˆ¤æ–­å‡ºç°Failureæ—¶æ˜¯å¦æ‰§è¡Œæ—¥å¿—æˆªæ–­æ“ä½œï¼ˆTruncationï¼‰ã€‚ä¹‹å‰é é«˜æ°´ä½æ¥åˆ¤æ–­çš„æœºåˆ¶ï¼Œå¯èƒ½ä¼šé€ æˆå‰¯æœ¬é—´æ•°æ®ä¸ä¸€è‡´çš„æƒ…å½¢ã€‚è¿™é‡Œçš„Leader Epoch Cacheæ˜¯ä¸€ä¸ªç¼“å­˜ç±»æ•°æ®ï¼Œé‡Œé¢ä¿å­˜äº†åˆ†åŒºLeaderçš„Epochå€¼ä¸å¯¹åº”ä½ç§»å€¼çš„æ˜ å°„å…³ç³»ï¼Œæˆ‘å»ºè®®ä½ æŸ¥çœ‹ä¸‹LeaderEpochFileCacheç±»ï¼Œæ·±å…¥åœ°äº†è§£ä¸‹å®ƒçš„å®ç°åŸç†ã€‚</p><p>æŒæ¡äº†è¿™äº›åŸºæœ¬å±æ€§ä¹‹åï¼Œæˆ‘ä»¬çœ‹ä¸‹Logç±»çš„åˆå§‹åŒ–é€»è¾‘ï¼š</p><pre><code> locally {\n        val startMs = time.milliseconds\n    \n    \n        // create the log directory if it doesn't exist\n        Files.createDirectories(dir.toPath)\n    \n    \n        initializeLeaderEpochCache()\n    \n    \n        val nextOffset = loadSegments()\n    \n    \n        /* Calculate the offset of the next message */\n        nextOffsetMetadata = LogOffsetMetadata(nextOffset, activeSegment.baseOffset, activeSegment.size)\n    \n    \n        leaderEpochCache.foreach(_.truncateFromEnd(nextOffsetMetadata.messageOffset))\n    \n    \n        logStartOffset = math.max(logStartOffset, segments.firstEntry.getValue.baseOffset)\n    \n    \n        // The earliest leader epoch may not be flushed during a hard failure. Recover it here.\n        leaderEpochCache.foreach(_.truncateFromStart(logStartOffset))\n    \n    \n        // Any segment loading or recovery code must not use producerStateManager, so that we can build the full state here\n        // from scratch.\n        if (!producerStateManager.isEmpty)\n          throw new IllegalStateException(&quot;Producer state must be empty during log initialization&quot;)\n        loadProducerState(logEndOffset, reloadFromCleanShutdown = hasCleanShutdownFile)\n    \n    \n        info(s&quot;Completed load of log with ${segments.size} segments, log start offset $logStartOffset and &quot; +\n          s&quot;log end offset $logEndOffset in ${time.milliseconds() - startMs} \n</code></pre><p>åœ¨è¯¦ç»†è§£é‡Šè¿™æ®µåˆå§‹åŒ–ä»£ç ä¹‹å‰ï¼Œæˆ‘ä½¿ç”¨ä¸€å¼ å›¾æ¥è¯´æ˜å®ƒåˆ°åº•åšäº†ä»€ä¹ˆï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/a1/a8/a10b81680a449e5b1d8882939061f7a8.jpg?wh=2284*1285\" alt=\"\"></p><p>è¿™é‡Œæˆ‘ä»¬é‡ç‚¹è¯´è¯´ç¬¬ä¸‰æ­¥ï¼Œå³åŠ è½½æ—¥å¿—æ®µçš„å®ç°é€»è¾‘ï¼Œä»¥ä¸‹æ˜¯loadSegmentsçš„å®ç°ä»£ç ï¼š</p><pre><code> private def loadSegments(): Long = {\n        // first do a pass through the files in the log directory and remove any temporary files\n        // and find any interrupted swap operations\n        val swapFiles = removeTempFilesAndCollectSwapFiles()\n    \n    \n        // Now do a second pass and load all the log and index files.\n        // We might encounter legacy log segments with offset overflow (KAFKA-6264). We need to split such segments. When\n        // this happens, restart loading segment files from scratch.\n        retryOnOffsetOverflow {\n          // In case we encounter a segment with offset overflow, the retry logic will split it after which we need to retry\n          // loading of segments. In that case, we also need to close all segments that could have been left open in previous\n          // call to loadSegmentFiles().\n          logSegments.foreach(_.close())\n          segments.clear()\n          loadSegmentFiles()\n        }\n    \n    \n        // Finally, complete any interrupted swap operations. To be crash-safe,\n        // log files that are replaced by the swap segment should be renamed to .deleted\n        // before the swap file is restored as the new segment file.\n        completeSwapOperations(swapFiles)\n    \n    \n        if (!dir.getAbsolutePath.endsWith(Log.DeleteDirSuffix)) {\n          val nextOffset = retryOnOffsetOverflow {\n            recoverLog()\n          }\n    \n    \n          // reset the index size of the currently active log segment to allow more entries\n          activeSegment.resizeIndexes(config.maxIndexSize)\n          nextOffset\n        } else {\n           if (logSegments.isEmpty) {\n              addSegment(LogSegment.open(dir = dir,\n                baseOffset = 0,\n                config,\n                time = time,\n                fileAlreadyExists = false,\n                initFileSize = this.initFileSize,\n                preallocate = false))\n           }\n          0\n        }\n\n</code></pre><p>è¿™æ®µä»£ç ä¼šå¯¹åˆ†åŒºæ—¥å¿—è·¯å¾„éå†ä¸¤æ¬¡ã€‚</p><p>é¦–å…ˆï¼Œå®ƒä¼šç§»é™¤ä¸Šæ¬¡Failureé—ç•™ä¸‹æ¥çš„å„ç§ä¸´æ—¶æ–‡ä»¶ï¼ˆåŒ…æ‹¬.cleanedã€.swapã€.deletedæ–‡ä»¶ç­‰ï¼‰ï¼ŒremoveTempFilesAndCollectSwapFilesæ–¹æ³•å®ç°äº†è¿™ä¸ªé€»è¾‘ã€‚</p><p>ä¹‹åï¼Œå®ƒä¼šæ¸…ç©ºæ‰€æœ‰æ—¥å¿—æ®µå¯¹è±¡ï¼Œå¹¶ä¸”å†æ¬¡éå†åˆ†åŒºè·¯å¾„ï¼Œé‡å»ºæ—¥å¿—æ®µsegments Mapå¹¶åˆ é™¤æ— å¯¹åº”æ—¥å¿—æ®µæ–‡ä»¶çš„å­¤ç«‹ç´¢å¼•æ–‡ä»¶ã€‚</p><p>å¾…æ‰§è¡Œå®Œè¿™ä¸¤æ¬¡éå†ä¹‹åï¼Œå®ƒä¼šå®Œæˆæœªå®Œæˆçš„swapæ“ä½œï¼Œå³è°ƒç”¨completeSwapOperationsæ–¹æ³•ã€‚ç­‰è¿™äº›éƒ½åšå®Œä¹‹åï¼Œå†è°ƒç”¨recoverLogæ–¹æ³•æ¢å¤æ—¥å¿—æ®µå¯¹è±¡ï¼Œç„¶åè¿”å›æ¢å¤ä¹‹åçš„åˆ†åŒºæ—¥å¿—LEOå€¼ã€‚</p><p>å¦‚æœä½ ç°åœ¨è§‰å¾—æœ‰ç‚¹è’™ï¼Œä¹Ÿæ²¡å…³ç³»ï¼Œæˆ‘æŠŠè¿™æ®µä»£ç å†è¿›ä¸€æ­¥æ‹†è§£ä¸‹ï¼Œä»¥æ›´å°çš„ç²’åº¦è·Ÿä½ è®²ä¸‹å®ƒä»¬åšäº†ä»€ä¹ˆã€‚ç†è§£äº†è¿™æ®µä»£ç ä¹‹åï¼Œä½ å¤§è‡´å°±èƒ½ææ¸…æ¥šå¤§éƒ¨åˆ†çš„åˆ†åŒºæ—¥å¿—æ“ä½œäº†ã€‚æ‰€ä»¥ï¼Œè¿™éƒ¨åˆ†ä»£ç ç»å¯¹å€¼å¾—æˆ‘ä»¬å¤šèŠ±ä¸€ç‚¹æ—¶é—´å»å­¦ä¹ ã€‚</p><p>æˆ‘ä»¬é¦–å…ˆæ¥çœ‹ç¬¬ä¸€æ­¥ï¼ŒremoveTempFilesAndCollectSwapFilesæ–¹æ³•çš„å®ç°ã€‚æˆ‘ç”¨æ³¨é‡Šçš„æ–¹å¼è¯¦ç»†è§£é‡Šäº†æ¯è¡Œä»£ç çš„ä½œç”¨ï¼š</p><pre><code> private def removeTempFilesAndCollectSwapFiles(): Set[File] = {\n    \n    // åœ¨æ–¹æ³•å†…éƒ¨å®šä¹‰ä¸€ä¸ªåä¸ºdeleteIndicesIfExistçš„æ–¹æ³•ï¼Œç”¨äºåˆ é™¤æ—¥å¿—æ–‡ä»¶å¯¹åº”çš„ç´¢å¼•æ–‡ä»¶\n    \n    def deleteIndicesIfExist(baseFile: File, suffix: String = &quot;&quot;): Unit = {\n    \n    info(s&quot;Deleting index files with suffix $suffix for baseFile $baseFile&quot;)\n    \n    val offset = offsetFromFile(baseFile)\n    \n    Files.deleteIfExists(Log.offsetIndexFile(dir, offset, suffix).toPath)\n    \n    Files.deleteIfExists(Log.timeIndexFile(dir, offset, suffix).toPath)\n    \n    Files.deleteIfExists(Log.transactionIndexFile(dir, offset, suffix).toPath)\n    \n    }\n    \n    var swapFiles = Set[File]()\n    \n    var cleanFiles = Set[File]()\n    \n    var minCleanedFileOffset = Long.MaxValue\n    \n    // éå†åˆ†åŒºæ—¥å¿—è·¯å¾„ä¸‹çš„æ‰€æœ‰æ–‡ä»¶\n    \n    for (file &lt;- dir.listFiles if file.isFile) {\n    \n    if (!file.canRead) // å¦‚æœä¸å¯è¯»ï¼Œç›´æ¥æŠ›å‡ºIOException\n    \n    throw new IOException(s&quot;Could not read file $file&quot;)\n    \n    val filename = file.getName\n    \n    if (filename.endsWith(DeletedFileSuffix)) { // å¦‚æœä»¥.deletedç»“å°¾\n    \n    debug(s&quot;Deleting stray temporary file ${file.getAbsolutePath}&quot;)\n    \n    Files.deleteIfExists(file.toPath) // è¯´æ˜æ˜¯ä¸Šæ¬¡Failureé—ç•™ä¸‹æ¥çš„æ–‡ä»¶ï¼Œç›´æ¥åˆ é™¤\n    \n    } else if (filename.endsWith(CleanedFileSuffix)) { // å¦‚æœä»¥.cleanedç»“å°¾\n    \n    minCleanedFileOffset = Math.min(offsetFromFileName(filename), minCleanedFileOffset) // é€‰å–æ–‡ä»¶åä¸­ä½ç§»å€¼æœ€å°çš„.cleanedæ–‡ä»¶ï¼Œè·å–å…¶ä½ç§»å€¼ï¼Œå¹¶å°†è¯¥æ–‡ä»¶åŠ å…¥å¾…åˆ é™¤æ–‡ä»¶é›†åˆä¸­\n    \n    cleanFiles += file\n    \n    } else if (filename.endsWith(SwapFileSuffix)) { // å¦‚æœä»¥.swapç»“å°¾\n    \n    val baseFile = new File(CoreUtils.replaceSuffix(file.getPath, SwapFileSuffix, &quot;&quot;))\n    \n    info(s&quot;Found file ${file.getAbsolutePath} from interrupted swap operation.&quot;)\n    \n    if (isIndexFile(baseFile)) { // å¦‚æœè¯¥.swapæ–‡ä»¶åŸæ¥æ˜¯ç´¢å¼•æ–‡ä»¶\n    \n    deleteIndicesIfExist(baseFile) // åˆ é™¤åŸæ¥çš„ç´¢å¼•æ–‡ä»¶\n    \n    } else if (isLogFile(baseFile)) { // å¦‚æœè¯¥.swapæ–‡ä»¶åŸæ¥æ˜¯æ—¥å¿—æ–‡ä»¶\n    \n    deleteIndicesIfExist(baseFile) // åˆ é™¤æ‰åŸæ¥çš„ç´¢å¼•æ–‡ä»¶\n    \n    swapFiles += file // åŠ å…¥å¾…æ¢å¤çš„.swapæ–‡ä»¶é›†åˆä¸­\n    \n    }\n    \n    }\n    \n    }\n    \n    // ä»å¾…æ¢å¤swapé›†åˆä¸­æ‰¾å‡ºé‚£äº›èµ·å§‹ä½ç§»å€¼å¤§äºminCleanedFileOffsetå€¼çš„æ–‡ä»¶ï¼Œç›´æ¥åˆ æ‰è¿™äº›æ— æ•ˆçš„.swapæ–‡ä»¶\n    \n    val (invalidSwapFiles, validSwapFiles) = swapFiles.partition(file =&gt; offsetFromFile(file) &gt;= minCleanedFileOffset)\n    \n    invalidSwapFiles.foreach { file =&gt;\n    \n    debug(s&quot;Deleting invalid swap file ${file.getAbsoluteFile} minCleanedFileOffset: $minCleanedFileOffset&quot;)\n    \n    val baseFile = new File(CoreUtils.replaceSuffix(file.getPath, SwapFileSuffix, &quot;&quot;))\n    \n    deleteIndicesIfExist(baseFile, SwapFileSuffix)\n    \n    Files.deleteIfExists(file.toPath)\n    \n    }\n    \n    // Now that we have deleted all .swap files that constitute an incomplete split operation, let's delete all .clean files\n    \n    // æ¸…é™¤æ‰€æœ‰å¾…åˆ é™¤æ–‡ä»¶é›†åˆä¸­çš„æ–‡ä»¶\n    \n    cleanFiles.foreach { file =&gt;\n    \n    debug(s&quot;Deleting stray .clean file ${file.getAbsolutePath}&quot;)\n    \n    Files.deleteIfExists(file.toPath)\n    \n    }\n    \n    // æœ€åè¿”å›å½“å‰æœ‰æ•ˆçš„.swapæ–‡ä»¶é›†åˆ\n    \n    validSwapFiles\n    \n    }\n</code></pre><p>æ‰§è¡Œå®Œäº†removeTempFilesAndCollectSwapFilesé€»è¾‘ä¹‹åï¼Œæºç å¼€å§‹æ¸…ç©ºå·²æœ‰æ—¥å¿—æ®µé›†åˆï¼Œå¹¶é‡æ–°åŠ è½½æ—¥å¿—æ®µæ–‡ä»¶ã€‚è¿™å°±æ˜¯ç¬¬äºŒæ­¥ã€‚è¿™é‡Œè°ƒç”¨çš„ä¸»è¦æ–¹æ³•æ˜¯loadSegmentFilesã€‚</p><pre><code>   private def loadSegmentFiles(): Unit = {\n    \n    // æŒ‰ç…§æ—¥å¿—æ®µæ–‡ä»¶åä¸­çš„ä½ç§»å€¼æ­£åºæ’åˆ—ï¼Œç„¶åéå†æ¯ä¸ªæ–‡ä»¶\n    \n    for (file &lt;- dir.listFiles.sortBy(_.getName) if file.isFile) {\n    \n    if (isIndexFile(file)) { // å¦‚æœæ˜¯ç´¢å¼•æ–‡ä»¶\n    \n    val offset = offsetFromFile(file)\n    \n    val logFile = Log.logFile(dir, offset)\n    \n    if (!logFile.exists) { // ç¡®ä¿å­˜åœ¨å¯¹åº”çš„æ—¥å¿—æ–‡ä»¶ï¼Œå¦åˆ™è®°å½•ä¸€ä¸ªè­¦å‘Šï¼Œå¹¶åˆ é™¤è¯¥ç´¢å¼•æ–‡ä»¶\n    \n    warn(s&quot;Found an orphaned index file ${file.getAbsolutePath}, with no corresponding log file.&quot;)\n    \n    Files.deleteIfExists(file.toPath)\n    \n    }\n    \n    } else if (isLogFile(file)) { // å¦‚æœæ˜¯æ—¥å¿—æ–‡ä»¶\n    \n    val baseOffset = offsetFromFile(file)\n    \n    val timeIndexFileNewlyCreated = !Log.timeIndexFile(dir, baseOffset).exists()\n    \n    // åˆ›å»ºå¯¹åº”çš„LogSegmentå¯¹è±¡å®ä¾‹ï¼Œå¹¶åŠ å…¥segmentsä¸­\n    \n    val segment = LogSegment.open(dir = dir,\n    \n    baseOffset = baseOffset,\n    \n    config,\n    \n    time = time,\n    \n    fileAlreadyExists = true)\n    \n    try segment.sanityCheck(timeIndexFileNewlyCreated)\n    \n    catch {\n    \n    case _: NoSuchFileException =&gt;\n    \n    error(s&quot;Could not find offset index file corresponding to log file ${segment.log.file.getAbsolutePath}, &quot; +\n    \n    &quot;recovering segment and rebuilding index files...&quot;)\n    \n    recoverSegment(segment)\n    \n    case e: CorruptIndexException =&gt;\n    \n    warn(s&quot;Found a corrupted index file corresponding to log file ${segment.log.file.getAbsolutePath} due &quot; +\n    \n    s&quot;to ${e.getMessage}}, recovering segment and rebuilding index files...&quot;)\n    \n    recoverSegment(segment)\n    \n    }\n    \n    addSegment(segment)\n    \n    }\n    \n    }\n    \n    }\n\n</code></pre><p>ç¬¬ä¸‰æ­¥æ˜¯å¤„ç†ç¬¬ä¸€æ­¥è¿”å›çš„æœ‰æ•ˆ.swapæ–‡ä»¶é›†åˆã€‚completeSwapOperationsæ–¹æ³•å°±æ˜¯åšè¿™ä»¶äº‹çš„ï¼š</p><pre><code>  private def completeSwapOperations(swapFiles: Set[File]): Unit = {\n    \n    // éå†æ‰€æœ‰æœ‰æ•ˆ.swapæ–‡ä»¶\n    \n    for (swapFile &lt;- swapFiles) {\n    \n    val logFile = new File(CoreUtils.replaceSuffix(swapFile.getPath, SwapFileSuffix, &quot;&quot;)) // è·å–å¯¹åº”çš„æ—¥å¿—æ–‡ä»¶\n    \n    val baseOffset = offsetFromFile(logFile) // æ‹¿åˆ°æ—¥å¿—æ–‡ä»¶çš„èµ·å§‹ä½ç§»å€¼\n    \n    // åˆ›å»ºå¯¹åº”çš„LogSegmentå®ä¾‹\n    \n    val swapSegment = LogSegment.open(swapFile.getParentFile,\n    \n    baseOffset = baseOffset,\n    \n    config,\n    \n    time = time,\n    \n    fileSuffix = SwapFileSuffix)\n    \n    info(s&quot;Found log file ${swapFile.getPath} from interrupted swap operation, repairing.&quot;)\n    \n    // æ‰§è¡Œæ—¥å¿—æ®µæ¢å¤æ“ä½œ\n    \n    recoverSegment(swapSegment)\n    \n    // We create swap files for two cases:\n    \n    // (1) Log cleaning where multiple segments are merged into one, and\n    \n    // (2) Log splitting where one segment is split into multiple.\n    \n    //\n    \n    // Both of these mean that the resultant swap segments be composed of the original set, i.e. the swap segment\n    \n    // must fall within the range of existing segment(s). If we cannot find such a segment, it means the deletion\n    \n    // of that segment was successful. In such an event, we should simply rename the .swap to .log without having to\n    \n    // do a replace with an existing segment.\n    \n    // ç¡®è®¤ä¹‹å‰åˆ é™¤æ—¥å¿—æ®µæ˜¯å¦æˆåŠŸï¼Œæ˜¯å¦è¿˜å­˜åœ¨è€çš„æ—¥å¿—æ®µæ–‡ä»¶\n    \n    val oldSegments = logSegments(swapSegment.baseOffset, swapSegment.readNextOffset).filter { segment =&gt;\n    \n    segment.readNextOffset &gt; swapSegment.baseOffset\n    \n    }\n    \n    // å°†ç”Ÿæˆçš„.swapæ–‡ä»¶åŠ å…¥åˆ°æ—¥å¿—ä¸­ï¼Œåˆ é™¤æ‰swapä¹‹å‰çš„æ—¥å¿—æ®µ\n    \n    replaceSegments(Seq(swapSegment), oldSegments.toSeq, isRecoveredSwapFile = true)\n    \n    }\n    \n    }\n\n</code></pre><p>æœ€åä¸€æ­¥æ˜¯recoverLogæ“ä½œï¼š</p><pre><code> private def recoverLog(): Long = {\n        // if we have the clean shutdown marker, skip recovery\n        // å¦‚æœä¸å­˜åœ¨ä»¥.kafka_cleanshutdownç»“å°¾çš„æ–‡ä»¶ã€‚é€šå¸¸éƒ½ä¸å­˜åœ¨\n        if (!hasCleanShutdownFile) {\n          // è·å–åˆ°ä¸Šæ¬¡æ¢å¤ç‚¹ä»¥å¤–çš„æ‰€æœ‰unflushedæ—¥å¿—æ®µå¯¹è±¡\n          val unflushed = logSegments(this.recoveryPoint, Long.MaxValue).toIterator\n          var truncated = false\n    \n    \n          // éå†è¿™äº›unflushedæ—¥å¿—æ®µ\n          while (unflushed.hasNext &amp;&amp; !truncated) {\n            val segment = unflushed.next\n            info(s&quot;Recovering unflushed segment ${segment.baseOffset}&quot;)\n            val truncatedBytes =\n              try {\n                // æ‰§è¡Œæ¢å¤æ—¥å¿—æ®µæ“ä½œ\n                recoverSegment(segment, leaderEpochCache)\n              } catch {\n                case _: InvalidOffsetException =&gt;\n                  val startOffset = segment.baseOffset\n                  warn(&quot;Found invalid offset during recovery. Deleting the corrupt segment and &quot; +\n                    s&quot;creating an empty one with starting offset $startOffset&quot;)\n                  segment.truncateTo(startOffset)\n              }\n            if (truncatedBytes &gt; 0) { // å¦‚æœæœ‰æ— æ•ˆçš„æ¶ˆæ¯å¯¼è‡´è¢«æˆªæ–­çš„å­—èŠ‚æ•°ä¸ä¸º0ï¼Œç›´æ¥åˆ é™¤å‰©ä½™çš„æ—¥å¿—æ®µå¯¹è±¡\n              warn(s&quot;Corruption found in segment ${segment.baseOffset}, truncating to offset ${segment.readNextOffset}&quot;)\n              removeAndDeleteSegments(unflushed.toList, asyncDelete = true)\n              truncated = true\n            }\n          }\n        }\n    \n    \n        // è¿™äº›éƒ½åšå®Œä¹‹åï¼Œå¦‚æœæ—¥å¿—æ®µé›†åˆä¸ä¸ºç©º\n        if (logSegments.nonEmpty) {\n          val logEndOffset = activeSegment.readNextOffset\n          if (logEndOffset &lt; logStartOffset) { // éªŒè¯åˆ†åŒºæ—¥å¿—çš„LEOå€¼ä¸èƒ½å°äºLog Start Offsetå€¼ï¼Œå¦åˆ™åˆ é™¤è¿™äº›æ—¥å¿—æ®µå¯¹è±¡\n            warn(s&quot;Deleting all segments because logEndOffset ($logEndOffset) is smaller than logStartOffset ($logStartOffset). &quot; +\n              &quot;This could happen if segment files were deleted from the file system.&quot;)\n            removeAndDeleteSegments(logSegments, asyncDelete = true)\n          }\n        }\n    \n    \n        // è¿™äº›éƒ½åšå®Œä¹‹åï¼Œå¦‚æœæ—¥å¿—æ®µé›†åˆä¸ºç©ºäº†\n        if (logSegments.isEmpty) {\n        // è‡³å°‘åˆ›å»ºä¸€ä¸ªæ–°çš„æ—¥å¿—æ®µï¼Œä»¥logStartOffsetä¸ºæ—¥å¿—æ®µçš„èµ·å§‹ä½ç§»ï¼Œå¹¶åŠ å…¥æ—¥å¿—æ®µé›†åˆä¸­\n          addSegment(LogSegment.open(dir = dir,\n            baseOffset = logStartOffset,\n            config,\n            time = time,\n            fileAlreadyExists = false,\n            initFileSize = this.initFileSize,\n            preallocate = config.preallocate))\n        }\n    \n    \n        // æ›´æ–°ä¸Šæ¬¡æ¢å¤ç‚¹å±æ€§ï¼Œå¹¶è¿”å›\n        recoveryPoint = activeSegment.readNextOffset\n        recoveryPoint\n</code></pre><h2>æ€»ç»“</h2><p>ä»Šå¤©ï¼Œæˆ‘é‡ç‚¹å‘ä½ ä»‹ç»äº†Kafkaçš„Logæºç ï¼Œä¸»è¦åŒ…æ‹¬ï¼š</p><ol>\n<li><strong>Logæ–‡ä»¶çš„æºç ç»“æ„</strong>ï¼šä½ å¯ä»¥çœ‹ä¸‹ä¸‹é¢çš„å¯¼å›¾ï¼Œå®ƒå±•ç¤ºäº†Logç±»æ–‡ä»¶çš„æ¶æ„ç»„æˆï¼Œä½ è¦é‡ç‚¹æŒæ¡Logç±»åŠå…¶ç›¸å…³æ–¹æ³•ã€‚</li>\n<li><strong>åŠ è½½æ—¥å¿—æ®µæœºåˆ¶</strong>ï¼šæˆ‘ç»“åˆæºç é‡ç‚¹åˆ†æäº†æ—¥å¿—åœ¨åˆå§‹åŒ–æ—¶æ˜¯å¦‚ä½•åŠ è½½æ—¥å¿—æ®µçš„ã€‚å‰é¢è¯´è¿‡äº†ï¼Œæ—¥å¿—æ˜¯æ—¥å¿—æ®µçš„å®¹å™¨ï¼Œå¼„æ˜ç™½å¦‚ä½•åŠ è½½æ—¥å¿—æ®µæ˜¯åç»­å­¦ä¹ æ—¥å¿—æ®µç®¡ç†çš„å‰ææ¡ä»¶ã€‚</li>\n</ol><p><img src=\"https://static001.geekbang.org/resource/image/dd/fc/dd2bf4882021d969accb14c0017d9dfc.jpg?wh=2543*3019\" alt=\"\"></p><p>æ€»çš„æ¥è¯´ï¼Œè™½ç„¶æ´‹æ´‹æ´’æ´’å‡ åƒå­—ï¼Œä½†æˆ‘ä¹Ÿåªè®²äº†æœ€é‡è¦çš„éƒ¨åˆ†ã€‚æˆ‘å»ºè®®ä½ å¤šçœ‹å‡ éLog.scalaä¸­åŠ è½½æ—¥å¿—æ®µçš„ä»£ç ï¼Œè¿™å¯¹åé¢æˆ‘ä»¬ç†è§£Kafka Brokerç«¯æ—¥å¿—æ®µç®¡ç†åŸç†å¤§æœ‰è£¨ç›Šã€‚åœ¨ä¸‹èŠ‚è¯¾ï¼Œæˆ‘ä¼šç»§ç»­è®¨è®ºæ—¥å¿—éƒ¨åˆ†çš„æºç ï¼Œå¸¦ä½ å­¦ä¹ å¸¸è§çš„Kafkaæ—¥å¿—æ“ä½œã€‚</p><h2>è¯¾åè®¨è®º</h2><p>Logæºç ä¸­æœ‰ä¸ªmaybeIncrementHighWatermarkæ–¹æ³•ï¼Œä½ èƒ½è¯´è¯´å®ƒçš„å®ç°åŸç†å—ï¼Ÿ</p><p>æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºç•…æ‰€æ¬²è¨€ï¼Œè·Ÿæˆ‘äº¤æµè®¨è®ºï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹ã€‚</p>","comments":[{"had_liked":false,"id":207936,"user_name":"æ›¾è½¼éºŸ","can_delete":false,"product_type":"c1","uid":1451391,"ip_address":"","ucode":"D418371AC11270","user_header":"https://static001.geekbang.org/account/avatar/00/16/25/7f/473d5a77.jpg","comment_is_top":true,"comment_ctime":1587219231,"is_pvip":false,"replies":[{"id":"77809","content":"ğŸ‘ğŸ‘ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1587345825,"ip_address":"","comment_id":207936,"utype":1}],"discussion_count":4,"race_medal":0,"score":"9.2233720728016998e+18","product_id":100050101,"comment_content":"å…ˆå›ç­”è€å¸ˆçš„é—®é¢˜maybeIncrementHighWatermarkçš„å®ç°ï¼š<br>ã€é¦–å…ˆéœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ä¸ªå†…å®¹ã€‘ï¼š<br>1ã€è¿™ä¸ªæ–¹æ³•æ˜¯é€šè¿‡leaderLogè¿™ä¸ªå®ä¾‹å»è°ƒç”¨çš„ï¼Œå½“HWæ›´æ–°çš„æ—¶å€™followerå°±ä¼šæ›´æ–°è‡ªèº«çš„HWã€‚<br><br>2ã€leaderLog æ˜¯åœ¨Partition.scalaä¸­çš„ï¼Œæ˜¯åˆ†åŒºç»´åº¦çš„æ¦‚å¿µã€‚<br><br>3ã€maybeIncrementHighWatermarkçš„å…¥å‚æ˜¯newHighWatermarkï¼Œæ˜¯æ–°çš„HWæ ‡è®°ï¼Œä½†æ˜¯å¯èƒ½æ˜¯æ›´æ–°ä¹Ÿå¯èƒ½ä¸æ˜¯ã€‚<br><br>ã€ä¸‹é¢æ¥è¯´å®ç°ã€‘<br>åœ¨maybeIncrementHighWatermarkä¸­ä¼šå…ˆå»åˆ¤æ–­æ–°çš„newHighWatermark.messageOffsetæ˜¯å¦å¤§äºå½“å‰çš„LEOï¼Œå¦‚æœå¤§äºè‚¯å®šä¸åˆç†ï¼Œå› ä¸ºæ–°çš„HWä¸å¯èƒ½è·‘åœ¨LEOå‰é¢<br><br>ç„¶åè·å–å½“å‰é«˜æ°´ä½çš„åç§»é‡å’Œå…ƒæ•°æ®ã€‚å¦‚æœåç§»å…ƒæ•°æ®ä¸æ˜¯ï¼Œå·²çŸ¥ï¼Œå°†åœ¨ç´¢å¼•ä¸­æ‰§è¡ŒæŸ¥æ‰¾å¹¶ç¼“å­˜ç»“æœï¼Œå¹¶èµ‹å€¼ç»™oldHighWatermarkã€‚<br><br>æœ€åè¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœï¼ˆoldHighWatermark.messageOffsetå°äºnewHighWatermark.messageOffsetï¼‰<br>åˆ™è·Ÿæ–°HWçš„å…ƒæ•°æ®<br><br>æˆ–è€…å¦‚æœï¼ˆoldHighWatermark.messageOffset ç­‰äº newHighWatermark.messageOffsetï¼‰å¹¶ä¸”å½“å‰segmentBaseOffsetå°äºnewHighWatermark.segmentBaseOffset<br>ä¹Ÿä¼šæ›´æ–°HWçš„å…ƒæ•°æ®<br><br>æœ€åè¿™ä¸ªè¿‡ç¨‹æ˜¯åœ¨synchronizedçš„åŒ…å›´ä¸‹è¿›è¡Œçš„ã€‚","like_count":8,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492286,"discussion_content":"ğŸ‘ğŸ‘ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587345825,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1060632,"avatar":"https://static001.geekbang.org/account/avatar/00/10/2f/18/0c943f98.jpg","nickname":"ç§‹æ—","note":"","ucode":"B5882D4EC73648","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":378690,"discussion_content":"å“ˆå“ˆå“ˆæ²¡æƒ³åˆ°è¿™é‡Œé‡åˆ°ä½ ï¼Œå‰å®³å“¦","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1623335707,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1451391,"avatar":"https://static001.geekbang.org/account/avatar/00/16/25/7f/473d5a77.jpg","nickname":"æ›¾è½¼éºŸ","note":"","ucode":"D418371AC11270","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1060632,"avatar":"https://static001.geekbang.org/account/avatar/00/10/2f/18/0c943f98.jpg","nickname":"ç§‹æ—","note":"","ucode":"B5882D4EC73648","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":385954,"discussion_content":"ğŸ˜‚ğŸ˜‚ğŸ˜‚ä»Šå¤©æ‰çœ‹è§ï¼Œæœ‰ä¸€æ®µæ—¶é—´æ²¡ä¸Šäº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627360609,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":378690,"ip_address":""},"score":385954,"extra":""}]},{"author":{"id":1231549,"avatar":"https://static001.geekbang.org/account/avatar/00/12/ca/bd/a51ae4b2.jpg","nickname":"åƒé¥­é¥­","note":"","ucode":"95CFA07CDA2957","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":241766,"discussion_content":"ç¡¬æ ¸å•Šï¼ŒScala çœ‹çš„å¤´å¤§","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587439374,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":209755,"user_name":"èƒ¡å¤•","can_delete":false,"product_type":"c1","uid":1288090,"ip_address":"","ucode":"5709A689B6683B","user_header":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","comment_is_top":true,"comment_ctime":1587609124,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"9.2233720384423997e+18","product_id":100050101,"comment_content":"ä½ å¥½ï¼Œæˆ‘æ˜¯èƒ¡å¤•ã€‚æˆ‘æ¥å…¬å¸ƒä¸ŠèŠ‚è¯¾çš„â€œè¯¾åè®¨è®ºâ€é¢˜ç­”æ¡ˆå•¦ï½<br><br>ä¸ŠèŠ‚è¯¾ï¼Œå’±ä»¬é‡ç‚¹äº†è§£äº†æ—¥å¿—æ®µå¯¹è±¡ï¼Œè¯¾åæˆ‘è®©ä½ æ€è€ƒä¸‹å¦‚æœç»™å®šä½ç§»å€¼è¿‡å¤§truncateToæ–¹æ³•çš„å®ç°ã€‚å…³äºè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘çš„çœ‹æ³•å¾ˆç®€å•ã€‚å¦‚æœtruncateToçš„è¾“å…¥offsetè¿‡å¤§ä»¥è‡³äºè¶…è¿‡äº†è¯¥æ—¥å¿—æ®µå½“å‰æœ€å¤§çš„æ¶ˆæ¯ä½ç§»å€¼ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•ä¸ä¼šæ‰§è¡Œä»»ä½•æˆªæ–­æ“ä½œï¼Œå› ä¸ºä¸ä¼šæœ‰æœºä¼šè°ƒç”¨log.truncateTo(mapping.position)<br><br>okayï¼Œä½ æ˜¯æ€ä¹ˆè€ƒè™‘çš„å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥ä¸€èµ·è®¨è®ºä¸‹ã€‚","like_count":0,"discussions":[{"author":{"id":1098550,"avatar":"https://static001.geekbang.org/account/avatar/00/10/c3/36/f73653c2.jpg","nickname":"é™ˆé˜³","note":"","ucode":"7D87DD5F380659","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":344413,"discussion_content":"truncateToæ–¹æ³•çš„æ³¨é‡Šæœ‰ç­”æ¡ˆï¼Œå“ˆå“ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1611457829,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":213012,"user_name":"èŠ±å¼€æˆæµ·","can_delete":false,"product_type":"c1","uid":1179974,"ip_address":"","ucode":"ED73A4ACFC5F72","user_header":"https://static001.geekbang.org/account/avatar/00/12/01/46/faf75ba6.jpg","comment_is_top":false,"comment_ctime":1588261170,"is_pvip":true,"replies":[{"id":"79131","content":"1. è¿™äº›å†™çš„ç¡®å®æœ‰ç‚¹é—®é¢˜ã€‚åº”è¯¥æ˜¯åˆ é™¤å­¤ç«‹çš„ç´¢å¼•æ–‡ä»¶<br>2. åº”è¯¥è¯´æ˜¯JVM GCæœºåˆ¶ï¼šï¼‰ FileRocordsè¡¨ç¤ºæ—¥å¿—æ®µå¯¹è±¡çš„åº•å±‚ç‰©ç†æ–‡ä»¶ï¼Œå·²åŠ è½½å®Œæˆçš„æ—¥å¿—æ®µå¯¹è±¡å¯¹åº”çš„FileRecordsæ˜¯å¯ä»¥è¢«GCçš„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1588400059,"ip_address":"","comment_id":213012,"utype":1}],"discussion_count":2,"race_medal":0,"score":"10178195762","product_id":100050101,"comment_content":"æœ‰ä¸¤ä¸ªç–‘é—®è¯·è€å¸ˆå¸®å¿™çœ‹ä¸‹ï¼š<br>1ã€ä¸ºä»€ä¹ˆbrokeré‡å¯è¦é‡å»ºæ‰€æœ‰çš„ç´¢å¼•æ–‡ä»¶ï¼Ÿ<br>2ã€LogSegmentçš„log: FileRecords è¡¨ç¤ºçš„æ˜¯æ¶ˆæ¯å†…å®¹ï¼ŒåŠ è½½æ—¥å¿—æ®µæ—¶å€™ï¼Œä»€ä¹ˆæœºåˆ¶ä½¿æœ‰é™å†…å­˜åŠ è½½æ‰€æœ‰segmentï¼Ÿ","like_count":2,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493668,"discussion_content":"1. è¿™äº›å†™çš„ç¡®å®æœ‰ç‚¹é—®é¢˜ã€‚åº”è¯¥æ˜¯åˆ é™¤å­¤ç«‹çš„ç´¢å¼•æ–‡ä»¶\n2. åº”è¯¥è¯´æ˜¯JVM GCæœºåˆ¶ï¼šï¼‰ FileRocordsè¡¨ç¤ºæ—¥å¿—æ®µå¯¹è±¡çš„åº•å±‚ç‰©ç†æ–‡ä»¶ï¼Œå·²åŠ è½½å®Œæˆçš„æ—¥å¿—æ®µå¯¹è±¡å¯¹åº”çš„FileRecordsæ˜¯å¯ä»¥è¢«GCçš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588400059,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1348848,"avatar":"https://static001.geekbang.org/account/avatar/00/14/94/f0/54dffdba.jpg","nickname":"ZenHao","note":"","ucode":"324E87C83E7641","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":384847,"discussion_content":" æºä»£ç é‡Œé¢ç¡®å®æ˜¯é‡å»ºäº†ç´¢å¼•å“¦","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1626771075,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":207052,"user_name":"åŒ—çº¬8â„ƒ","can_delete":false,"product_type":"c1","uid":1433189,"ip_address":"","ucode":"4999F2E037C93C","user_header":"https://static001.geekbang.org/account/avatar/00/15/de/65/51147fb6.jpg","comment_is_top":false,"comment_ctime":1587000264,"is_pvip":false,"replies":[{"id":"77309","content":"å“ˆå“ˆï¼ŒåšæŒåšæŒï¼","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1587002009,"ip_address":"","comment_id":207052,"utype":1}],"discussion_count":2,"race_medal":0,"score":"10176934856","product_id":100050101,"comment_content":"å¤ªéš¾äº†ğŸ˜‚","like_count":2,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":491993,"discussion_content":"å“ˆå“ˆï¼ŒåšæŒåšæŒï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587002009,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1433189,"avatar":"https://static001.geekbang.org/account/avatar/00/15/de/65/51147fb6.jpg","nickname":"åŒ—çº¬8â„ƒ","note":"","ucode":"4999F2E037C93C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":234886,"discussion_content":"æƒ³è¦debugçœ‹ï¼Œå°è¯•å¤±è´¥äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587003858,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":312935,"user_name":"Geek_47baf9","can_delete":false,"product_type":"c1","uid":1793038,"ip_address":"","ucode":"DCF187338050DC","user_header":"","comment_is_top":false,"comment_ctime":1632128706,"is_pvip":false,"replies":[{"id":"114445","content":"æ˜¯å•Šï¼Œæ„Ÿæ…¨Kafkaä»£ç ä¾ç„¶åœ¨ä¿æŒæ´»åŠ›åœ°æ›´æ–°ç€","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1634004784,"ip_address":"","comment_id":312935,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5927096002","product_id":100050101,"comment_content":"åœ¨trunkåˆ†æ”¯æäº¤è®°å½•ï¼ˆcommitId=db1f581da7f3440cfd5be93800b4a9a2d7327a35ï¼‰ä¸Š Log.scalaå·²ç»åœ¨2021-08-13 7:10è¢«é‡å‘½åä¸ºUnifiedLog.scalaï¼Œå¸Œæœ›å¤§å®¶çœ‹ä¸“æ çš„æ—¶å€™æ³¨æ„ç‚¹","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527167,"discussion_content":"æ˜¯å•Šï¼Œæ„Ÿæ…¨Kafkaä»£ç ä¾ç„¶åœ¨ä¿æŒæ´»åŠ›åœ°æ›´æ–°ç€","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634004784,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1107305,"avatar":"https://static001.geekbang.org/account/avatar/00/10/e5/69/719ec5d0.jpg","nickname":"Jian","note":"","ucode":"17ED4919F22DEC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":564025,"discussion_content":"æ­£å¸¸æ¥è¯´åº”è¯¥ç»™ä¸ªå…·ä½“çš„ç¨³å®šçš„åˆ†æ”¯è€Œä¸æ˜¯trunkåˆ†æ”¯ï¼Œåé¢æ¥å¾—åŒå­¦çœ‹èµ·æ¥éå¸¸ç—›è‹¦ï¼Œæœ€æ–°çš„ä»£ç é‡æ„äº†å¾ˆå¤šå†…å®¹ï¼Œè·Ÿä¸“æ è®²çš„å®Œå…¨ä¸ä¸€æ ·äº†ã€‚å…¶å®å¯ä»¥çœ‹ä¸‹redisä¸“æ ä½œè€…ï¼Œå…ˆä¸»çº¿ä¸²èµ·æ¥ï¼Œåé¢å†è®²æ—è·¯ã€‚ä¸€ä¸Šæ¥å°±è®²æŸä¸€ç‚¹çš„ä»£ç è®©å¾ˆå¤šåŒå­¦ä¼šçœ‹ä¸ä¸‹å»çš„ã€‚è¯´å®è¯ï¼Œè¿™ä¸“æ è´¨é‡ä¸è¡Œã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1650127837,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":291710,"user_name":"ä½ ç…å•¥ï¼Ÿæ²¡è§è¿‡è¿™ä¹ˆå¸…çš„å“ˆå£«å¥‡å—","can_delete":false,"product_type":"c1","uid":1127288,"ip_address":"","ucode":"16BA6EF8F8A86C","user_header":"https://static001.geekbang.org/account/avatar/00/11/33/78/cf112171.jpg","comment_is_top":false,"comment_ctime":1620443781,"is_pvip":false,"replies":[{"id":"105692","content":"brokerç¢°åˆ°çš„ä»»ä½•å¤±è´¥","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1620613699,"ip_address":"","comment_id":291710,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5915411077","product_id":100050101,"comment_content":"æ¸…é™¤ä¸Šä¸€æ¬¡failureç•™ä¸‹çš„æ–‡ä»¶ï¼Œè¿™ä¸ªfailureæƒ…å†µæ˜¯æŒ‡ä»€ä¹ˆæƒ…å†µä¸‹å‘ç”Ÿçš„failureæƒ…å†µï¼Œæ˜¯èŠ‚ç‚¹æŒ‚äº†é‡å¯æ—¶çš„failureè¿˜æ˜¯å…¶ä»–æƒ…å†µï¼Œèƒ½ä¸¾ä¸ªğŸŒ°å—","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":519546,"discussion_content":"brokerç¢°åˆ°çš„ä»»ä½•å¤±è´¥","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620613699,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":254518,"user_name":"äº‘è¶…","can_delete":false,"product_type":"c1","uid":1581783,"ip_address":"","ucode":"63DFDDAB37A04F","user_header":"https://static001.geekbang.org/account/avatar/00/18/22/d7/ae0ed31f.jpg","comment_is_top":false,"comment_ctime":1603121956,"is_pvip":false,"replies":[{"id":"93056","content":"ç±»ä¼¼äºjavaä¸­çš„é™æ€ä»£ç å—ï¼Œå¤šç”¨äºç±»æˆ–Objectåˆå§‹åŒ–æ‰§è¡Œä¸€æ®µä»£ç ä¹‹ç”¨","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1603354449,"ip_address":"","comment_id":254518,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5898089252","product_id":100050101,"comment_content":"è€å¸ˆï¼Œé—®ä¸€ä¸ªè¯­æ³•ä¸Šçš„é—®é¢˜ï¼Œåœ¨ä¸Šé¢çš„ä»£ç ç‰‡æ®µä¸­çš„locally{xxx}  ï¼Œè¿™ä¸ªlocallyçš„ä½œç”¨æ˜¯ä»€ä¹ˆå•Šï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":507424,"discussion_content":"ç±»ä¼¼äºjavaä¸­çš„é™æ€ä»£ç å—ï¼Œå¤šç”¨äºç±»æˆ–Objectåˆå§‹åŒ–æ‰§è¡Œä¸€æ®µä»£ç ä¹‹ç”¨","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603354449,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1581783,"avatar":"https://static001.geekbang.org/account/avatar/00/18/22/d7/ae0ed31f.jpg","nickname":"äº‘è¶…","note":"","ucode":"63DFDDAB37A04F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":316087,"discussion_content":"å¥½çš„ï¼Œæ˜ç™½äº†ï¼Œè°¢è°¢è€å¸ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603357048,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":236857,"user_name":"å¼ å­æ¶µ","can_delete":false,"product_type":"c1","uid":1743397,"ip_address":"","ucode":"57C509EA32B916","user_header":"https://static001.geekbang.org/account/avatar/00/1a/9a/25/3e5e942b.jpg","comment_is_top":false,"comment_ctime":1595568941,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5890536237","product_id":100050101,"comment_content":" def maybeIncrementHighWatermark(newHighWatermark: LogOffsetMetadata): Option[LogOffsetMetadata] = {<br>    if (newHighWatermark.messageOffset &gt; logEndOffset)  &#47;&#47;å¯¹é«˜æ°´ä½çš„å€¼è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœnewé«˜æ°´ä½å¤§äºLEOï¼Œåˆ™æŠ¥é”™<br>      throw new IllegalArgumentException(s&quot;High watermark $newHighWatermark update exceeds current &quot; +<br>        s&quot;log end offset $logEndOffsetMetadata&quot;)<br>    lock.synchronized {<br>      val oldHighWatermark = fetchHighWatermarkMetadata<br>      if (oldHighWatermark.messageOffset &lt; newHighWatermark.messageOffset ||<br>        (oldHighWatermark.messageOffset == newHighWatermark.messageOffset &amp;&amp; oldHighWatermark.onOlderSegment(newHighWatermark))) {<br>        &#47;&#47;è‹¥oldé«˜æ°´ä½offsetå°äºnewé«˜æ°´ä½offset<br>        &#47;&#47; æˆ–è€…ï¼ˆoldé«˜æ°´ä½offsetç­‰äºnewé«˜æ°´ä½offsetï¼Œä¸”å½“å‰segmentBaseOffsetå°äºnewé«˜æ°´ä½çš„segmentBaseOffsetï¼‰<br>        &#47;&#47;åˆ™æ›´æ–°é«˜æ°´ä½å€¼<br>        updateHighWatermarkMetadata(newHighWatermark)<br>        Some(oldHighWatermark)<br>      } else {<br>        None<br>      }<br>    }<br>  }","like_count":1},{"had_liked":false,"id":211082,"user_name":"ä¸œé£ç¬¬ä¸€æ","can_delete":false,"product_type":"c1","uid":1402697,"ip_address":"","ucode":"0CD0F62E90DAD8","user_header":"https://static001.geekbang.org/account/avatar/00/15/67/49/864dba17.jpg","comment_is_top":false,"comment_ctime":1587893017,"is_pvip":false,"replies":[{"id":"78564","content":"é¦–å…ˆæˆ‘è¦å£°æ˜ï¼Œæºç å†™å¾—ä¹Ÿä¸ä¸€å®šå°±æ˜¯å¯¹çš„ï¼æˆ‘ä»¬å®Œå…¨å¯ä»¥é’ˆå¯¹æºç ä¸­å¯èƒ½çš„é—®é¢˜å¼€æ”¾è®¨è®ºå“ˆã€‚<br><br>åœ¨LeaderEpochFileCacheä¸­ï¼Œé’ˆå¯¹epochsçš„æ›´æ–°å’Œèµ‹å€¼å…¨éƒ¨éƒ½åœ¨write lockä¸‹ï¼Œè¯»å–epochç”¨read lockã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1587951426,"ip_address":"","comment_id":211082,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5882860313","product_id":100050101,"comment_content":"å…ˆå›ç­”è€å¸ˆçš„é—®é¢˜ï¼š<br>å¦‚æœHWå¤§äºLEOï¼Œé‚£ä¹ˆç›´æ¥æŠ›å‡ºIllegalArgumentExceptionå¼‚å¸¸ï¼›<br>å¦åˆ™åšå¦‚ä¸‹æ“ä½œï¼š<br>1. æ‹¿åˆ°HWçš„LogOffsetMetadata<br>2. å½“å­˜åœ¨ä»¥ä¸‹æƒ…å†µçš„æ—¶å€™ï¼Œæ›´æ–°HWï¼Œå¹¶ä¸”è¿”å›æ›´æ–°ä¹‹å‰çš„HW<br>\ta. old HWçš„ä½ç§»å°äºnew HW<br>\tb. old HWçš„ä½ç§»ç­‰äºnew HW, å¹¶ä¸”old HWçš„åŸºå‡†ä½ç§»å°äºnew HWçš„åŸºå‡†ä½ç§»ï¼Œè¿™ç§æƒ…å†µè¯´æ˜ï¼Œnew HWå¯¹åº”çš„segmentæ˜¯ä¸€ä¸ªæ–°çš„segment<br>3. å¦‚æœold HWçš„ä½ç§»å¤§äºç­‰äºnew HWï¼Œç›´æ¥è¿”å›None<br><br>å†è¯·æ•™è€å¸ˆä¸€ä¸ªé—®é¢˜ï¼ŒLeaderEpochFileCacheä¸­æœ‰è¿™æ ·ä¸€è¡Œä»£ç ï¼š<br>private var epochs: ArrayBuffer[EpochEntry] = inWriteLock(lock) ......<br>å…¶å®å°±æ˜¯åˆå§‹åŒ–epochsï¼Œæˆ‘ç†è§£è¿™è¾¹æ˜¯è¯»leader-epoch-checkpointæ–‡ä»¶ï¼Œä¸ºä»€ä¹ˆè¦ç”¨inWriteLockå†™é”ï¼Œè€Œä¸æ˜¯inReadLockã€‚","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493192,"discussion_content":"é¦–å…ˆæˆ‘è¦å£°æ˜ï¼Œæºç å†™å¾—ä¹Ÿä¸ä¸€å®šå°±æ˜¯å¯¹çš„ï¼æˆ‘ä»¬å®Œå…¨å¯ä»¥é’ˆå¯¹æºç ä¸­å¯èƒ½çš„é—®é¢˜å¼€æ”¾è®¨è®ºå“ˆã€‚\n\nåœ¨LeaderEpochFileCacheä¸­ï¼Œé’ˆå¯¹epochsçš„æ›´æ–°å’Œèµ‹å€¼å…¨éƒ¨éƒ½åœ¨write lockä¸‹ï¼Œè¯»å–epochç”¨read lockã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587951426,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":207943,"user_name":"æ›¾è½¼éºŸ","can_delete":false,"product_type":"c1","uid":1451391,"ip_address":"","ucode":"D418371AC11270","user_header":"https://static001.geekbang.org/account/avatar/00/16/25/7f/473d5a77.jpg","comment_is_top":false,"comment_ctime":1587220075,"is_pvip":false,"replies":[{"id":"77808","content":"1. å°±æˆ‘ä¸ªäººè€Œè¨€ï¼Œæˆ‘è§‰å¾—ä¹Ÿæ²¡æœ‰ä»€ä¹ˆé—®é¢˜ã€‚æˆ‘è§‰å¾—ä½œè€…æ›´å¤šæ˜¯ä¸ºäº†æŠŠä¸åŒé€»è¾‘è¿›è¡Œäº†åˆ†ç»„å¯¼è‡´éå†å¤šæ¬¡<br>2. å¯èƒ½é€ æˆBrokerçš„å´©æºƒï¼Œæ— æ³•å¯åŠ¨ã€‚å› ä¸ºæˆ‘ä»¬å…¬å¸æœ‰å°ä¼™ä¼´è¿™ä¹ˆå¹²è¿‡ï¼šï¼ˆ<br>3. å¯¹çš„ï¼Œè¿™æ ·å¯ä»¥å¿«é€Ÿæ ¹æ®ç»™å®šoffsetæ‰¾åˆ°å¯¹åº”çš„ä¸€ä¸Šä¸€ä¸‹æ—¥å¿—æ®µå¯¹è±¡","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1587345815,"ip_address":"","comment_id":207943,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5882187371","product_id":100050101,"comment_content":"è€å¸ˆä¸‹é¢æˆ‘æƒ³é—®ä¸€ä¸‹æˆ‘çš„ä¸€äº›é—®é¢˜ï¼š<br>1ã€ä¸ºä»€ä¹ˆè¦éå†ä¸¤æ¬¡æ–‡ä»¶è·¯å¾„å‘¢ï¼Ÿæˆ‘çœ‹äº†ä¸€ä¸‹ï¼Œå¦‚æœåœ¨åˆ é™¤çš„æ—¶å€™é¡ºä¾¿å»åŠ è½½segmentä¼šæœ‰ä»€ä¹ˆé—®é¢˜å—ï¼Ÿè¿™æ ·æ˜¯å¦å¯ä»¥æé«˜åŠ è½½æ•ˆç‡å‘¢ï¼Ÿ<br>2ã€æˆ‘çœ‹äº†ä¸€ä¸‹åœ¨removeTempFilesAndCollectSwapFilesæ–¹æ³•ä¸­minCleanedFileOffsetæ˜¯ä»æ–‡ä»¶åfilenameä¸Šé¢è¯»å–çš„ï¼Œå¦‚æœæˆ‘ä¿®æ”¹äº†æ–‡ä»¶åçš„offsetå¤§å°ä¼šå‡ºç°ä»€ä¹ˆæ„æƒ³ä¸åˆ°çš„æƒ…å†µå‘¢ï¼Ÿ<br>3ã€æˆ‘å‘ç°segmentsæ˜¯ä½¿ç”¨ConcurrentNavigableMapï¼Œè€Œè¿™é‡Œçš„ConcurrentNavigableMapæ˜¯ä½¿ç”¨JDKçš„ConcurrentSkipListMapï¼Œä½¿ç”¨è·³è¡¨çš„ç›®çš„æ˜¯ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨offsetèŒƒå›´æŸ¥è¯¢segmentsä¸­çš„å¯¹è±¡å—ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492288,"discussion_content":"1. å°±æˆ‘ä¸ªäººè€Œè¨€ï¼Œæˆ‘è§‰å¾—ä¹Ÿæ²¡æœ‰ä»€ä¹ˆé—®é¢˜ã€‚æˆ‘è§‰å¾—ä½œè€…æ›´å¤šæ˜¯ä¸ºäº†æŠŠä¸åŒé€»è¾‘è¿›è¡Œäº†åˆ†ç»„å¯¼è‡´éå†å¤šæ¬¡\n2. å¯èƒ½é€ æˆBrokerçš„å´©æºƒï¼Œæ— æ³•å¯åŠ¨ã€‚å› ä¸ºæˆ‘ä»¬å…¬å¸æœ‰å°ä¼™ä¼´è¿™ä¹ˆå¹²è¿‡ï¼šï¼ˆ\n3. å¯¹çš„ï¼Œè¿™æ ·å¯ä»¥å¿«é€Ÿæ ¹æ®ç»™å®šoffsetæ‰¾åˆ°å¯¹åº”çš„ä¸€ä¸Šä¸€ä¸‹æ—¥å¿—æ®µå¯¹è±¡","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587345815,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1085297,"avatar":"https://static001.geekbang.org/account/avatar/00/10/8f/71/29fb7bc2.jpg","nickname":"hgf","note":"","ucode":"A9649ECFDBD9E8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":247530,"discussion_content":"éå†ä¸€æ¬¡è§£å†³ä¸äº†é—®é¢˜ï¼Œè€Œä¸æ˜¯ç®€å•çš„ä¸ºäº†é€»è¾‘æ¸…æ™°ï¼ç‰¹åˆ«æ˜¯æ¸…ç†æ–‡ä»¶è¿‡ç¨‹ä¸­ï¼Œåªæœ‰éå†å®Œæˆä¸€éæ‰èƒ½çŸ¥é“minCleanedFileOffset(å³å“ªäº›.swapæ–‡ä»¶è¯¥æ¸…ç†ï¼‰ï¼Œå¦‚æœåœ¨ç¬¬äºŒæ¬¡éå†å‰ä¸æ¸…ç†.swapæ–‡ä»¶ï¼Œé‚£ä¹ˆåŠ è½½çš„æœ‰å¯èƒ½æ˜¯æœ‰é—®é¢˜çš„æ•°æ®ã€‚ä¸€æ¬¡éå†ï¼Œæ— æ³•åšåˆ°è¿™ç‚¹ã€‚è€Œä¸”è¿˜æœ‰ä¸€ç‚¹ï¼Œæ¸…ç†.swapæ‰€æœ‰å‰ï¼Œæ˜¯ä¸èƒ½æ¸…ç†.cleanedæ–‡ä»¶çš„ï¼Œä¸‡ä¸€è¿™æ¬¡brokeråˆå´©äº†å°±æ²¡æ³•æ¢å¤äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587816904,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":207569,"user_name":"æˆ‘æ˜¯å°é˜Ÿé•¿","can_delete":false,"product_type":"c1","uid":1334198,"ip_address":"","ucode":"E0687666EE2031","user_header":"https://static001.geekbang.org/account/avatar/00/14/5b/b6/f404b490.jpg","comment_is_top":false,"comment_ctime":1587110430,"is_pvip":false,"replies":[{"id":"77817","content":"å½“åº•å±‚æ—¥å¿—æ–‡ä»¶è¢«åˆ é™¤æˆ–æŸåçš„è¯å°±å¯èƒ½å‡ºç°è¿™ç§æƒ…å†µï¼Œå› ä¸ºæ— æ³•è¯»å–æ–‡ä»¶å»è·å–LEOäº†ã€‚ä½ å¯ä»¥ç”¨2.0ç‰ˆæœ¬åšä¸ªè¯•éªŒï¼š<br>1. å‘æ¶ˆæ¯åˆ°åˆ†åŒºæ—¥å¿—<br>2. ä½¿ç”¨Adminçš„DeleteRecordså‘½ä»¤é©±åŠ¨Log start offsetå‰è¿›<br>3. å…³é—­Broker<br>4. åˆ é™¤æ—¥å¿—è·¯å¾„<br>5. é‡å¯Broker","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1587346641,"ip_address":"","comment_id":207569,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5882077726","product_id":100050101,"comment_content":"   &#47;&#47; è¿™äº›éƒ½åšå®Œä¹‹åï¼Œå¦‚æœæ—¥å¿—æ®µé›†åˆä¸ä¸ºç©º<br>   &#47;&#47; éªŒè¯åˆ†åŒºæ—¥å¿—çš„LEOå€¼ä¸èƒ½å°äºLog Start Offsetå€¼ï¼Œå¦åˆ™åˆ é™¤è¿™äº›æ—¥å¿—æ®µå¯¹è±¡<br><br><br>æƒ³é—®ä¸‹ä»€ä¹ˆæ—¶å€™æ‰ä¼šå‡ºç°è¿™ç§æƒ…å†µå‘¢ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492172,"discussion_content":"å½“åº•å±‚æ—¥å¿—æ–‡ä»¶è¢«åˆ é™¤æˆ–æŸåçš„è¯å°±å¯èƒ½å‡ºç°è¿™ç§æƒ…å†µï¼Œå› ä¸ºæ— æ³•è¯»å–æ–‡ä»¶å»è·å–LEOäº†ã€‚ä½ å¯ä»¥ç”¨2.0ç‰ˆæœ¬åšä¸ªè¯•éªŒï¼š\n1. å‘æ¶ˆæ¯åˆ°åˆ†åŒºæ—¥å¿—\n2. ä½¿ç”¨Adminçš„DeleteRecordså‘½ä»¤é©±åŠ¨Log start offsetå‰è¿›\n3. å…³é—­Broker\n4. åˆ é™¤æ—¥å¿—è·¯å¾„\n5. é‡å¯Broker","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587346641,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":207563,"user_name":"æˆ‘æ˜¯å°é˜Ÿé•¿","can_delete":false,"product_type":"c1","uid":1334198,"ip_address":"","ucode":"E0687666EE2031","user_header":"https://static001.geekbang.org/account/avatar/00/14/5b/b6/f404b490.jpg","comment_is_top":false,"comment_ctime":1587109019,"is_pvip":false,"replies":[{"id":"77822","content":"é¦–å…ˆï¼Œä¸ç®¡æ˜¯å¦è¦è¿‡æ»¤å‡ºç¬¦åˆæ¡ä»¶çš„oldSegmentsï¼Œå›å¤ä¹‹åéƒ½è¦è¿›è¡Œæ›¿æ¢ï¼Œè¿™ä¸ªä½ å®é™…ä¸Šè¿™æ˜¯å› ä¸ºå‡çº§Brokerç‰ˆæœ¬è€Œåšçš„é˜²å¾¡æ€§ç¼–ç¨‹ã€‚åœ¨è€çš„ç‰ˆæœ¬ä¸­ï¼Œä»£ç å†™å…¥æ¶ˆæ¯åå¹¶ä¸ä¼šå¯¹ä½ç§»å€¼è¿›è¡Œæ ¡éªŒã€‚å› æ­¤log cleanerè€ä»£ç å¯èƒ½å†™å…¥ä¸€ä¸ªéå¸¸å¤§çš„ä½ç§»å€¼ï¼ˆå¤§äºInt.MAX_VALUEï¼‰ã€‚å½“brokerå‡çº§åï¼Œè¿™äº›æ—¥å¿—æ®µå°±ä¸èƒ½æ­£å¸¸è¢«compactäº†ï¼Œå› ä¸ºä½ç§»å€¼è¶Šç•Œäº†ï¼ˆæ–°ç‰ˆæœ¬åŠ å…¥äº†ä½ç§»æ ¡éªŒï¼‰<br><br>ä»£ç éœ€è¦å»æœå¯»åœ¨swap start offsetå’Œswap LEOä¹‹é—´çš„æ‰€æœ‰æ—¥å¿—æ®µå¯¹è±¡ï¼Œä½†è¿™è¿˜ä¸å¤Ÿï¼Œè¿˜è¦ä¿è¯è¿™äº›æ—¥å¿—æ®µçš„LEOæ¯”swapçš„base offsetå¤§æ‰è¡Œæ˜¯åŒæ„çš„å§ï¼Ÿå¦åˆ™","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1587347824,"ip_address":"","comment_id":207563,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5882076315","product_id":100050101,"comment_content":"è€å¸ˆï¼Œæ‰¾å‡ºéœ€è¦æ¢å¤çš„swapï¼Œç›´æ¥æ¢å¤å®Œæˆä¸å°±è¡Œäº†ä¹ˆï¼Œä¸ºä»€ä¹ˆè¿˜æœ‰ä¸‹é¢çš„æ“ä½œå‘¢ï¼Ÿ<br><br><br>&#47;&#47; We create swap files for two cases:<br>&#47;&#47; (1) Log cleaning where multiple segments are merged into one, and<br>&#47;&#47; (2) Log splitting where one segment is split into multiple.<br>&#47;&#47;<br>&#47;&#47; Both of these mean that the resultant swap segments be composed of the original set, i.e. the swap segment<br>&#47;&#47; must fall within the range of existing segment(s). If we cannot find such a segment, it means the deletion<br>&#47;&#47; of that segment was successful. In such an event, we should simply rename the .swap to .log without having to<br>&#47;&#47; do a replace with an existing segment.<br>&#47;&#47; ç¡®è®¤ä¹‹å‰åˆ é™¤æ—¥å¿—æ®µæ˜¯å¦æˆåŠŸï¼Œæ˜¯å¦è¿˜å­˜åœ¨è€çš„æ—¥å¿—æ®µæ–‡ä»¶<br>val oldSegments = logSegments(swapSegment.baseOffset, swapSegment.readNextOffset).filter { segment =&gt;<br>segment.readNextOffset &gt; swapSegment.baseOffset<br>}<br>&#47;&#47; å¦‚æœå­˜åœ¨ï¼Œç›´æ¥æŠŠ.swapæ–‡ä»¶é‡å‘½åæˆ.log<br>replaceSegments(Seq(swapSegment), oldSegments.toSeq, isRecoveredSwapFile = ","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492169,"discussion_content":"é¦–å…ˆï¼Œä¸ç®¡æ˜¯å¦è¦è¿‡æ»¤å‡ºç¬¦åˆæ¡ä»¶çš„oldSegmentsï¼Œå›å¤ä¹‹åéƒ½è¦è¿›è¡Œæ›¿æ¢ï¼Œè¿™ä¸ªä½ å®é™…ä¸Šè¿™æ˜¯å› ä¸ºå‡çº§Brokerç‰ˆæœ¬è€Œåšçš„é˜²å¾¡æ€§ç¼–ç¨‹ã€‚åœ¨è€çš„ç‰ˆæœ¬ä¸­ï¼Œä»£ç å†™å…¥æ¶ˆæ¯åå¹¶ä¸ä¼šå¯¹ä½ç§»å€¼è¿›è¡Œæ ¡éªŒã€‚å› æ­¤log cleanerè€ä»£ç å¯èƒ½å†™å…¥ä¸€ä¸ªéå¸¸å¤§çš„ä½ç§»å€¼ï¼ˆå¤§äºInt.MAX_VALUEï¼‰ã€‚å½“brokerå‡çº§åï¼Œè¿™äº›æ—¥å¿—æ®µå°±ä¸èƒ½æ­£å¸¸è¢«compactäº†ï¼Œå› ä¸ºä½ç§»å€¼è¶Šç•Œäº†ï¼ˆæ–°ç‰ˆæœ¬åŠ å…¥äº†ä½ç§»æ ¡éªŒï¼‰\n\nä»£ç éœ€è¦å»æœå¯»åœ¨swap start offsetå’Œswap LEOä¹‹é—´çš„æ‰€æœ‰æ—¥å¿—æ®µå¯¹è±¡ï¼Œä½†è¿™è¿˜ä¸å¤Ÿï¼Œè¿˜è¦ä¿è¯è¿™äº›æ—¥å¿—æ®µçš„LEOæ¯”swapçš„base offsetå¤§æ‰è¡Œæ˜¯åŒæ„çš„å§ï¼Ÿå¦åˆ™","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587347824,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":351854,"user_name":"ã€‚ã€‚ã€‚","can_delete":false,"product_type":"c1","uid":2556149,"ip_address":"","ucode":"715BEDC6917E9E","user_header":"https://static001.geekbang.org/account/avatar/00/27/00/f5/596e8e84.jpg","comment_is_top":false,"comment_ctime":1658231133,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1658231133","product_id":100050101,"comment_content":"æ¢å¤ç‚¹æ˜¯å•¥å•Š  æ–‡ä¸­å¥½åƒæ²¡æœ‰æåˆ°è€å¸ˆ<br>","like_count":0},{"had_liked":false,"id":327414,"user_name":"qgaye","can_delete":false,"product_type":"c1","uid":1702112,"ip_address":"","ucode":"E817609D4ED2D6","user_header":"https://static001.geekbang.org/account/avatar/00/19/f8/e0/d6e3cc8f.jpg","comment_is_top":false,"comment_ctime":1640109581,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1640109581","product_id":100050101,"comment_content":"&#47;&#47; ä»å¾…æ¢å¤swapé›†åˆä¸­æ‰¾å‡ºé‚£äº›èµ·å§‹ä½ç§»å€¼å¤§äºminCleanedFileOffsetå€¼çš„æ–‡ä»¶ï¼Œç›´æ¥åˆ æ‰è¿™äº›æ— æ•ˆçš„.swapæ–‡ä»¶<br>è¯·é—®ä¸ºä»€ä¹ˆè¦åˆ é™¤ä½ç§»å€¼å¤§äºminCleanedFileOffsetçš„æ–‡ä»¶å‘¢","like_count":0},{"had_liked":false,"id":292317,"user_name":"é‚“æ–Œ","can_delete":false,"product_type":"c1","uid":1162877,"ip_address":"","ucode":"548073840A21C9","user_header":"https://static001.geekbang.org/account/avatar/00/11/be/7d/40f6361e.jpg","comment_is_top":false,"comment_ctime":1620782048,"is_pvip":false,"replies":[{"id":"105882","content":"æœ€å¥½è¿˜æ˜¯åˆ«æ”¾åœ¨windowsä¸Šäº†ï¼Œæœ‰å„ç§å„æ ·çš„é—®é¢˜","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1620818948,"ip_address":"","comment_id":292317,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1620782048","product_id":100050101,"comment_content":"ä½ å¥½ï¼Œæˆ‘çš„Windows10ç³»ç»Ÿåœ¨å¯åŠ¨æºç çš„æ—¶å€™å‡ºç°java.nio.file.AccessDeniedExceptionå¼‚å¸¸ï¼Œé”™è¯¯ä¿¡æ¯ï¼šError while writing to checkpoint file C:\\tmp\\kafka\\kafka-logs\\recovery-point-offset-checkpoint (kafka.server.LogDirFailureChannel)å’Œ<br>Failed to create or validate data directory C:\\tmp\\kafka-logs (kafka.server.LogDirFailureChannel)ã€‚<br>æˆ‘å·²ç»æ’æŸ¥äº†ç›®å½•å’Œæ–‡ä»¶çš„æƒé™éƒ½æ˜¯å®Œå…¨æ§åˆ¶ï¼Œç”šè‡³é‡è£…ç³»ç»Ÿéƒ½æ²¡æœ‰è§£å†³ï¼Œè¯·æ•™ä¸€ä¸‹ï¼Œè¿™ä¸ªé”™è¯¯è¿˜æœ‰ä»€ä¹ˆåŠæ³•è§£å†³å—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":519774,"discussion_content":"æœ€å¥½è¿˜æ˜¯åˆ«æ”¾åœ¨windowsä¸Šäº†ï¼Œæœ‰å„ç§å„æ ·çš„é—®é¢˜","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620818948,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":250328,"user_name":"å¯¹ä¸é”™","can_delete":false,"product_type":"c1","uid":1682027,"ip_address":"","ucode":"EF55733E3BD78B","user_header":"https://static001.geekbang.org/account/avatar/00/19/aa/6b/ab9a072a.jpg","comment_is_top":false,"comment_ctime":1601026636,"is_pvip":false,"replies":[{"id":"91719","content":"ä¸€å¯¹ä¸€ã€‚logä¸‹é¢åˆ†å¤šä¸ªsegment","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1601170397,"ip_address":"","comment_id":250328,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1601026636","product_id":100050101,"comment_content":"è¯·é—®åˆ†åŒºä¸Logä¹‹é—´çš„å…³ç³»æ˜¯ä¸€å¯¹å¤šå—?","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":506186,"discussion_content":"ä¸€å¯¹ä¸€ã€‚logä¸‹é¢åˆ†å¤šä¸ªsegment","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1601170397,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1030082,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b7/c2/196932c7.jpg","nickname":"å—ç›ä¸€æ¢¦","note":"","ucode":"6338D5428DB2B0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":540311,"discussion_content":"1ã€ä¸€ä¸ªtopicå¯¹åº”å¤šä¸ªPartition\n2ã€ä¸€ä¸ªPartitionå¯¹åº”ä¸€ä¸ªé€»è¾‘Logå¯¹è±¡\n3ã€ä¸€ä¸ªLogå¯¹è±¡(ä¸€ä¸ªPartition)å¯¹åº”ä¸€ä¸ªç‰©ç†ç£ç›˜ç›®å½•\n4ã€ä¸€ä¸ªç‰©ç†ç£ç›˜ç›®å½•åŒ…å«å¤šä¸ªæ—¥å¿—ç›¸å…³æ–‡ä»¶ï¼Œæ¯ä¸€ç»„æ—¥å¿—ç›¸å…³æ–‡ä»¶ä¸ºä¸€ä¸ªé€»è¾‘Logsegmentå¯¹è±¡(*.indexã€*.logã€*.timeindexç­‰)\n5ã€ä¸€ä¸ªLogå¯¹è±¡å¯¹åº”å¤šä¸ªLogSegmentå¯¹è±¡","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640014104,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":243969,"user_name":"é²Â·æœ¬","can_delete":false,"product_type":"c1","uid":1209939,"ip_address":"","ucode":"F1DEB30C21B48E","user_header":"https://static001.geekbang.org/account/avatar/00/12/76/53/21d62a23.jpg","comment_is_top":false,"comment_ctime":1598342676,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1598342676","product_id":100050101,"comment_content":"ç”¨æ³¨é‡Šçš„æ–¹å¼ç»™å‡ºæˆ‘çš„ç†è§£: <br><br>def maybeIncrementHighWatermark(newHighWatermark: LogOffsetMetadata): Option[LogOffsetMetadata] = {<br>    &#47;&#47;å¦‚æœæœŸæœ›è®¾ç½®çš„é«˜æ°´ä½offset &gt; endOffset æ— æ•ˆå€¼,æŠ›å‡ºå¼‚å¸¸<br>    if (newHighWatermark.messageOffset &gt; logEndOffset)<br>      throw new IllegalArgumentException(s&quot;High watermark $newHighWatermark update exceeds current &quot; +<br>        s&quot;log end offset $logEndOffsetMetadata&quot;)<br><br>    lock.synchronized {<br>      &#47;&#47;è·å–è€çš„é«˜æ°´ä½å…ƒæ•°æ®<br>      val oldHighWatermark = fetchHighWatermarkMetadata<br><br>      &#47;&#47; Ensure that the high watermark increases monotonically. We also update the high watermark when the new<br>      &#47;&#47; offset metadata is on a newer segment, which occurs whenever the log is rolled to a new segment.<br>      &#47;&#47;ä»¥ä¸‹åœºæ™¯ä¼šæ‰§è¡Œé«˜æ°´ä½å…ƒæ•°æ®çš„æ›´æ–°<br>      &#47;&#47;å¦‚æœè€çš„é«˜æ°´ä½offset &lt; æ–°çš„é«˜æ°´ä½offset æˆ–è€…<br>      &#47;&#47;è€çš„é«˜æ°´ä½offset == æ–°çš„é«˜æ°´ä½offset å¹¶ä¸” è€çš„é«˜æ°´ä½å…ƒæ•°æ®çš„baseoffå°äºæ–°çš„é«˜æ°´ä½å…ƒæ•°æ®çš„baseoffset(ä¹Ÿå°±æ˜¯è™½ç„¶é«˜æ°´ä½æ²¡å˜,ä½†æ˜¯æ—¥å¿—æ®µå‘ç”Ÿäº†æ»šåŠ¨)<br>      if (oldHighWatermark.messageOffset &lt; newHighWatermark.messageOffset ||<br>        (oldHighWatermark.messageOffset == newHighWatermark.messageOffset &amp;&amp; oldHighWatermark.onOlderSegment(newHighWatermark))) {<br>        updateHighWatermarkMetadata(newHighWatermark)<br>        Some(oldHighWatermark)<br>      } else {<br>        None<br>      }<br>    }<br>  }","like_count":0},{"had_liked":false,"id":242532,"user_name":"ä¸‰é¢—è±†å­","can_delete":false,"product_type":"c1","uid":2008638,"ip_address":"","ucode":"632CE3E7563666","user_header":"https://static001.geekbang.org/account/avatar/00/1e/a6/3e/3d18f35a.jpg","comment_is_top":false,"comment_ctime":1597752426,"is_pvip":false,"replies":[{"id":"89547","content":"1ã€å®šæ—¶ä»»åŠ¡<br>2ã€unflushedè®°å½•çš„æ˜¯æœªå†™å…¥åˆ°æ£€æŸ¥ç‚¹æ–‡ä»¶çš„æ—¥å¿—æ®µã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1597885591,"ip_address":"","comment_id":242532,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1597752426","product_id":100050101,"comment_content":"è¯·é—®ä¸€ä¸‹ï¼š<br>1ã€æ£€æŸ¥ç‚¹æ˜¯æ ¹æ®ä»€ä¹ˆä¾æ®æ¥å»ºç«‹çš„å‘¢ï¼Ÿæ˜¯å®šæ—¶ä»»åŠ¡ï¼Œè¿˜æ˜¯ä»€ä¹ˆã€‚<br>2ã€â€œunflushedæ—¥å¿—æ®µâ€è®°å½•çš„æ˜¯æœªæäº¤ä½ç§»çš„æ—¥å¿—å—ï¼Ÿå¦‚æœæ˜¯å·²ç»æäº¤ä½ç§»çš„æ—¥å¿—ï¼Œåˆ æ‰è¿™äº›æ—¥å¿—æ®µå¯¹è±¡ï¼Œä¸å°±æ˜ å°„ä¸åˆ°è¿™äº›æ—¥å¿—äº†å—ï¼Ÿå¦‚æœæ˜¯æœªæäº¤ä½ç§»çš„æ—¥å¿—ï¼Œé‚£å·²ç»æäº¤ä½ç§»çš„æ—¥å¿—ä¸€å®šåœ¨recoveryPointä¹‹å†…å—ï¼Œä¸ºä»€ä¹ˆï¼Ÿ<br>è°¢è°¢ã€‚","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":504030,"discussion_content":"1ã€å®šæ—¶ä»»åŠ¡\n2ã€unflushedè®°å½•çš„æ˜¯æœªå†™å…¥åˆ°æ£€æŸ¥ç‚¹æ–‡ä»¶çš„æ—¥å¿—æ®µã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597885591,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":230752,"user_name":"æ‡‚ç å“¥(GerryWen)","can_delete":false,"product_type":"c1","uid":2049910,"ip_address":"","ucode":"55CD1C9AAD87CD","user_header":"","comment_is_top":false,"comment_ctime":1593483216,"is_pvip":false,"replies":[{"id":"85258","content":"ä¸€èµ·åŠ æ²¹â›½ï¸","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1593506684,"ip_address":"","comment_id":230752,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1593483216","product_id":100050101,"comment_content":"è¯»æºç çœŸçš„æ˜¯ä»¶ç—›å¹¶å¿«ä¹çš„äº‹ï¼Œéå¸¸å¹¸è¿èƒ½é‡åˆ°è€å¸ˆæ‚¨çš„è¯¾ç¨‹ã€‚è·Ÿæ‚¨ä¸€èµ·åšæŒè¯»æºç ã€‚","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":500023,"discussion_content":"ä¸€èµ·åŠ æ²¹â›½ï¸","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1593506684,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":229887,"user_name":"yes","can_delete":false,"product_type":"c1","uid":1386201,"ip_address":"","ucode":"612BF6884ED6CC","user_header":"https://static001.geekbang.org/account/avatar/00/15/26/d9/f7e96590.jpg","comment_is_top":false,"comment_ctime":1593177843,"is_pvip":false,"replies":[{"id":"85036","content":"1ã€ä¸ºäº†ç¡®ä¿segmentsä¸­çš„æ—¥å¿—æ®µèƒ½å¤Ÿè¦†ç›–åŒ…å«çš„offsetå€¼ï¼Œå› ä¸ºå¯èƒ½å…¶ä»–çº¿ç¨‹ä¹Ÿè¦è®¿é—®segments<br>2ã€åšå®Œäº†swapï¼Œç§»é™¤swapåç¼€","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1593389507,"ip_address":"","comment_id":229887,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1593177843","product_id":100050101,"comment_content":"è€å¸ˆï¼Œå…³äºcompleteSwapOperationsé‡Œé¢çš„replaceSegments(),æˆ‘æœ‰äº›ç–‘é—®ã€‚<br>replaceSegmentsæ–¹æ³•é‡Œé¢æœ‰ä»¥ä¸‹ä»£ç ï¼š<br>1ã€sortedNewSegments.reverse.foreach(addSegment(_)) ï¼Œè¿™ä¸ªreverseæœ‰ä»€ä¹ˆæ„ä¹‰åœ¨<br>2ã€sortedNewSegments.foreach(_.changeFileSuffixes(Log.SwapFileSuffix, &quot;&quot;)) ï¼Œä¸ºå•¥newSuffixæ˜¯â€œâ€ï¼Œä¸æ˜¯log","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":499683,"discussion_content":"1ã€ä¸ºäº†ç¡®ä¿segmentsä¸­çš„æ—¥å¿—æ®µèƒ½å¤Ÿè¦†ç›–åŒ…å«çš„offsetå€¼ï¼Œå› ä¸ºå¯èƒ½å…¶ä»–çº¿ç¨‹ä¹Ÿè¦è®¿é—®segments\n2ã€åšå®Œäº†swapï¼Œç§»é™¤swapåç¼€","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1593389507,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":219079,"user_name":"Rogerå®‡","can_delete":false,"product_type":"c1","uid":1703222,"ip_address":"","ucode":"CBA23C01409349","user_header":"https://static001.geekbang.org/account/avatar/00/19/fd/36/f947c340.jpg","comment_is_top":false,"comment_ctime":1589940951,"is_pvip":false,"replies":[{"id":"80946","content":"log compactionä¸æ˜¯logä¸»è¦åŠŸèƒ½ï¼Œè€Œä¸”æºç åœ¨LogCleaneréƒ¨åˆ†ã€‚ä¸å½±å“logçš„å­¦ä¹ ï¼šï¼‰","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1589942825,"ip_address":"","comment_id":219079,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1589940951","product_id":100050101,"comment_content":"æƒ³è¯·é—®ä¸€ä¸‹è€å¸ˆï¼ŒLog Compactionçš„å†…å®¹è®¡åˆ’åœ¨ä»€ä¹ˆæ—¶å€™è¯´å‘¢ï¼ŸLogä¸Šä¸­çš„swapæ–‡ä»¶ç›¸å…³æ“ä½œç¡¬ç€å¤´çš®æ²¡å»çº ç»“å®ƒçš„ç»†èŠ‚ï¼ŒæŠŠæ•´ä½“æ¡†æ¶çœ‹äº†ä¸€éã€‚ä½†çœ‹å®Œæ—¥å¿—æ•´ä¸ªç« èŠ‚ä¹Ÿæ²¡é‡åˆ°è®©äººæœ‰ç‚¹å¿ƒè™šå•Šã€‚æœ¬æ¥ä»¥ä¸ºLog Compactionä¹Ÿæ˜¯æ—¥å¿—æ“ä½œåº”è¯¥ä¼šåœ¨ç¬¬ä¸€ç« ï¼Œä½†ç»“æœæ²¡æœ‰æ‰¾åˆ°ã€‚è¿™éƒ¨åˆ†æš‚æ—¶æ²¡ç†è§£æ¸…æ¥šä¸ä¼šå½±å“ä¹‹åçš„æºç å­¦ä¹ å—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":495675,"discussion_content":"log compactionä¸æ˜¯logä¸»è¦åŠŸèƒ½ï¼Œè€Œä¸”æºç åœ¨LogCleaneréƒ¨åˆ†ã€‚ä¸å½±å“logçš„å­¦ä¹ ï¼šï¼‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589942825,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":215617,"user_name":"å°˜æ«","can_delete":false,"product_type":"c1","uid":1093372,"ip_address":"","ucode":"79698689EDD97A","user_header":"https://static001.geekbang.org/account/avatar/00/10/ae/fc/d647a3e4.jpg","comment_is_top":false,"comment_ctime":1589033357,"is_pvip":false,"replies":[{"id":"79868","content":"ä½ æ˜¯æŒ‡å“ªé‡Œçš„Snapshotå‘¢ï¼Ÿ<br>","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1589122325,"ip_address":"","comment_id":215617,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1589033357","product_id":100050101,"comment_content":"è€å¸ˆï¼Œæœ‰æ—¶é—´éº»çƒ¦è®²ä¸€ä¸‹ snapshotç›¸å…³çš„æºç å§ï¼Œè¿™ä¸ªç”¨çš„ä¹ŸæŒºå¤šçš„","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":494499,"discussion_content":"ä½ æ˜¯æŒ‡å“ªé‡Œçš„Snapshotå‘¢ï¼Ÿ\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589122325,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":214964,"user_name":"è´","can_delete":false,"product_type":"c1","uid":1963914,"ip_address":"","ucode":"19603B3FDECC7B","user_header":"https://static001.geekbang.org/account/avatar/00/1d/f7/8a/09a4c107.jpg","comment_is_top":false,"comment_ctime":1588858648,"is_pvip":false,"replies":[{"id":"79690","content":"å‰¯æœ¬å‡è¡¡è¿™ä¸ªææ³•å¾ˆé™Œç”Ÿï¼Œä¸å¤ªç¡®å®šæ˜¯æŒ‡å“ªä¸ªæ“ä½œï¼Ÿè€Œä¸”æƒ³äº†è§£ä¸‹æ‚¨æ˜¯æ€ä¹ˆåšé™æµçš„ã€‚å¾ˆå¤šé™æµæ“ä½œæ˜¯é’ˆå¯¹å…¨å±€çš„ï¼Œæœ€å¥½è¯¦ç»†æè¿°ä¸€ä¸‹åœºæ™¯ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1588984405,"ip_address":"","comment_id":214964,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1588858648","product_id":100050101,"comment_content":"è€å¸ˆï¼Œæœ‰ä¸ªé—®é¢˜ç™¾æ€ä¸å¾—å…¶è§£ï¼Œåœ¨è¿›è¡Œtopicå‰¯æœ¬å‡è¡¡çš„æ—¶å€™ï¼Œå¦‚æœåªå¯¹topicAè¿›è¡Œå‡è¡¡ï¼Œè¦æ˜¯åŠ äº†é™æµä¸åº”è¯¥åªé™åˆ¶è¯¥topicä¹ˆï¼Œä¸ºä»€ä¹ˆå®è·µçš„è¿‡ç¨‹å‘ç°å¦‚æœé™æµå¤ªå°ä¼šå¯¼è‡´å…¶å®ƒçš„ä¸€äº›topicä¹Ÿå‡ºç°æœªåŒæ­¥çš„ç°è±¡å‘¢ï¼Œè€Œä¸”æ— æ³•æ¢å¤ï¼Œåªèƒ½é‡å¯kafkaã€‚å…³äºkafkaçš„å‰¯æœ¬å‡è¡¡æ˜¯å¦è€ƒè™‘è®²ä¸€ä¸‹å‘¢ï¼Ÿè¿™é‡Œçš„æ°´å¤ªæ·±äº†ï¼Œé™æµé«˜äº†ä¼šæ‰“å®æœºå™¨ï¼Œä½äº†åˆä¼šå‡ºç°å‰¯æœ¬æœªåŒæ­¥çš„ç°è±¡ï¼Œéƒ½ä¸çŸ¥é“è¯¥æ€ä¹ˆè¿›è¡Œå‰¯æœ¬å‡è¡¡äº†","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":494260,"discussion_content":"å‰¯æœ¬å‡è¡¡è¿™ä¸ªææ³•å¾ˆé™Œç”Ÿï¼Œä¸å¤ªç¡®å®šæ˜¯æŒ‡å“ªä¸ªæ“ä½œï¼Ÿè€Œä¸”æƒ³äº†è§£ä¸‹æ‚¨æ˜¯æ€ä¹ˆåšé™æµçš„ã€‚å¾ˆå¤šé™æµæ“ä½œæ˜¯é’ˆå¯¹å…¨å±€çš„ï¼Œæœ€å¥½è¯¦ç»†æè¿°ä¸€ä¸‹åœºæ™¯ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588984405,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":210839,"user_name":"thomas","can_delete":false,"product_type":"c1","uid":1016777,"ip_address":"","ucode":"9AB945308F1B50","user_header":"https://static001.geekbang.org/account/avatar/00/0f/83/c9/5d03981a.jpg","comment_is_top":false,"comment_ctime":1587834049,"is_pvip":true,"replies":[{"id":"78475","content":"ç¬¬5æ­¥è¦ç”¨åˆ°ä¸Šä¸€æ­¥æ›´æ–°çš„LEOå€¼ï¼Œå³nextOffsetMetadataå¯¹è±¡","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1587868402,"ip_address":"","comment_id":210839,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1587834049","product_id":100050101,"comment_content":"è€å¸ˆï¼Œè¯·é—®logç±»çš„åˆå§‹åŒ–çš„5ä¸ªæ­¥éª¤ä¸­ï¼Œç¬¬äºŒï¼ˆåˆå§‹åŒ–Leader Epoch Cacheï¼‰å’Œç¬¬äº”æ­¥(æ›´æ–°Leader Epoch Cache)ä¸ºä»€ä¹ˆè¦åˆ†å¼€ï¼Œä¸èƒ½æŠŠç¬¬äºŒæ­¥å’Œç¬¬äº”æ­¥åˆå¹¶å—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493123,"discussion_content":"ç¬¬5æ­¥è¦ç”¨åˆ°ä¸Šä¸€æ­¥æ›´æ–°çš„LEOå€¼ï¼Œå³nextOffsetMetadataå¯¹è±¡","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587868402,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":208794,"user_name":"åƒé¥­é¥­","can_delete":false,"product_type":"c1","uid":1231549,"ip_address":"","ucode":"95CFA07CDA2957","user_header":"https://static001.geekbang.org/account/avatar/00/12/ca/bd/a51ae4b2.jpg","comment_is_top":false,"comment_ctime":1587439497,"is_pvip":false,"replies":[{"id":"78135","content":"log start offsetå¯ä»¥ä¸ç­‰äºbaseOffsetã€‚äº‹å®ä¸Šï¼Œè¿™ä¸¤ä¸ªä½ç§»å€¼æ²¡æœ‰ç›´æ¥çš„å…³è”ã€‚å›¾ä¸­ä»…ä»…æ˜¯ä¸€ä¸ªç¤ºä¾‹","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1587518505,"ip_address":"","comment_id":208794,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1587439497","product_id":100050101,"comment_content":"æ–‡ä¸­ã€å›¾ä¸­ç»¿è‰²çš„ä½ç§»å€¼ 3 æ˜¯æ—¥å¿—çš„ Log Start Offsetã€‘ï¼Œè¿™é‡Œä¸æ˜ç™½ï¼Œä¸ºä»€ä¹ˆ logStartOffset ä¸ç­‰äº baseOffset = 0 ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492624,"discussion_content":"log start offsetå¯ä»¥ä¸ç­‰äºbaseOffsetã€‚äº‹å®ä¸Šï¼Œè¿™ä¸¤ä¸ªä½ç§»å€¼æ²¡æœ‰ç›´æ¥çš„å…³è”ã€‚å›¾ä¸­ä»…ä»…æ˜¯ä¸€ä¸ªç¤ºä¾‹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587518505,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":208208,"user_name":"ä¸€æ­¥","can_delete":false,"product_type":"c1","uid":1005391,"ip_address":"","ucode":"73CEA468CE70C3","user_header":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","comment_is_top":false,"comment_ctime":1587302238,"is_pvip":true,"replies":[{"id":"77742","content":"æ˜¯çš„ï¼š","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1587307123,"ip_address":"","comment_id":208208,"utype":1}],"discussion_count":1,"race_medal":1,"score":"1587302238","product_id":100050101,"comment_content":"è¿™ä¸ª ä¸€ä¸ªLog å¯¹è±¡ å°±ç›¸å½“ä¸ ä¸€ä¸ªæ—¥å¿—åˆ†åŒºæ–‡ä»¶å¤¹å—ï¼Ÿ å°±æ˜¯åˆ†åŒºæ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰æ—¥å¿—æ®µå¯¹è±¡çš„é›†åˆ","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492378,"discussion_content":"æ˜¯çš„ï¼š","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587307123,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}