{"id":70876,"title":"44 | Kubernetes GPUç®¡ç†ä¸Device Pluginæœºåˆ¶","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å¼ ç£Šã€‚ä»Šå¤©æˆ‘å’Œä½ åˆ†äº«çš„ä¸»é¢˜æ˜¯ï¼šKubernetes GPUç®¡ç†ä¸Device Pluginæœºåˆ¶ã€‚</p><p>2016å¹´ï¼Œéšç€ AlphaGo çš„èµ°çº¢å’ŒTensorFlow é¡¹ç›®çš„å¼‚å†›çªèµ·ï¼Œä¸€åœºåä¸º AI çš„æŠ€æœ¯é©å‘½è¿…é€Ÿä»å­¦æœ¯ç•Œè”“å»¶åˆ°äº†å·¥ä¸šç•Œï¼Œæ‰€è°“çš„ AI å…ƒå¹´ï¼Œå°±æ­¤æ‹‰å¼€å¸·å¹•ã€‚</p><p>å½“ç„¶ï¼Œæœºå™¨å­¦ä¹ æˆ–è€…è¯´äººå·¥æ™ºèƒ½ï¼Œå¹¶ä¸æ˜¯ä»€ä¹ˆæ–°é²œçš„æ¦‚å¿µã€‚è€Œè¿™æ¬¡çƒ­æ½®çš„èƒŒåï¼Œäº‘è®¡ç®—æœåŠ¡çš„æ™®åŠä¸æˆç†Ÿï¼Œä»¥åŠç®—åŠ›çš„å·¨å¤§æå‡ï¼Œå…¶å®æ­£æ˜¯å°†äººå·¥æ™ºèƒ½ä»è±¡ç‰™å¡”å¸¦åˆ°å·¥ä¸šç•Œçš„ä¸€ä¸ªé‡è¦æ¨æ‰‹ã€‚</p><p>è€Œä¸ä¹‹ç›¸å¯¹åº”çš„ï¼Œä»2016å¹´å¼€å§‹ï¼ŒKubernetes ç¤¾åŒºå°±ä¸æ–­æ”¶åˆ°æ¥è‡ªä¸åŒæ¸ é“çš„å¤§é‡è¯‰æ±‚ï¼Œå¸Œæœ›èƒ½å¤Ÿåœ¨ Kubernetes é›†ç¾¤ä¸Šè¿è¡Œ TensorFlow ç­‰æœºå™¨å­¦ä¹ æ¡†æ¶æ‰€åˆ›å»ºçš„è®­ç»ƒï¼ˆTrainingï¼‰å’ŒæœåŠ¡ï¼ˆServingï¼‰ä»»åŠ¡ã€‚è€Œè¿™äº›è¯‰æ±‚ä¸­ï¼Œé™¤äº†å‰é¢æˆ‘ä¸ºä½ è®²è§£è¿‡çš„ Jobã€Operator ç­‰ç¦»çº¿ä½œä¸šç®¡ç†éœ€è¦ç”¨åˆ°çš„ç¼–æ’æ¦‚å¿µä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªäºŸå¾…å®ç°çš„åŠŸèƒ½ï¼Œå°±æ˜¯å¯¹ GPU ç­‰ç¡¬ä»¶åŠ é€Ÿè®¾å¤‡ç®¡ç†çš„æ”¯æŒã€‚</p><p>ä¸è¿‡ï¼Œ æ­£å¦‚åŒ TensorFlow ä¹‹äº Google çš„æˆ˜ç•¥æ„ä¹‰ä¸€æ ·ï¼Œ<strong>GPU æ”¯æŒå¯¹äº Kubernetes é¡¹ç›®æ¥è¯´ï¼Œå…¶å®ä¹Ÿæœ‰ç€è¶…è¿‡æŠ€æœ¯æœ¬èº«çš„è€ƒè™‘</strong>ã€‚æ‰€ä»¥ï¼Œå°½ç®¡åœ¨ç¡¬ä»¶åŠ é€Ÿå™¨è¿™ä¸ªé¢†åŸŸé‡Œï¼ŒKubernetes ä¸Šæ¸¸æœ‰ç€ä¸å°‘æ¥è‡ª NVIDIA å’Œ Intel ç­‰èŠ¯ç‰‡å‚å•†çš„å·¥ç¨‹å¸ˆï¼Œä½†è¿™ä¸ªç‰¹æ€§æœ¬èº«ï¼Œå´ä»ä¸€å¼€å§‹å°±æ˜¯ä»¥ Google Cloud çš„éœ€æ±‚ä¸ºä¸»å¯¼æ¥æ¨è¿›çš„ã€‚</p><!-- [[[read_end]]] --><p>è€Œå¯¹äºäº‘çš„ç”¨æˆ·æ¥è¯´ï¼Œåœ¨ GPU çš„æ”¯æŒä¸Šï¼Œä»–ä»¬æœ€åŸºæœ¬çš„è¯‰æ±‚å…¶å®éå¸¸ç®€å•ï¼šæˆ‘åªè¦åœ¨ Pod çš„ YAML é‡Œé¢ï¼Œå£°æ˜æŸå®¹å™¨éœ€è¦çš„ GPU ä¸ªæ•°ï¼Œé‚£ä¹ˆKubernetes ä¸ºæˆ‘åˆ›å»ºçš„å®¹å™¨é‡Œå°±åº”è¯¥å‡ºç°å¯¹åº”çš„ GPU è®¾å¤‡ï¼Œä»¥åŠå®ƒå¯¹åº”çš„é©±åŠ¨ç›®å½•ã€‚</p><p>ä»¥ NVIDIA çš„ GPU è®¾å¤‡ä¸ºä¾‹ï¼Œä¸Šé¢çš„éœ€æ±‚å°±æ„å‘³ç€å½“ç”¨æˆ·çš„å®¹å™¨è¢«åˆ›å»ºä¹‹åï¼Œè¿™ä¸ªå®¹å™¨é‡Œå¿…é¡»å‡ºç°å¦‚ä¸‹ä¸¤éƒ¨åˆ†è®¾å¤‡å’Œç›®å½•ï¼š</p><ol>\n<li>\n<p>GPU è®¾å¤‡ï¼Œæ¯”å¦‚ /dev/nvidia0ï¼›</p>\n</li>\n<li>\n<p>GPU é©±åŠ¨ç›®å½•ï¼Œæ¯”å¦‚/usr/local/nvidia/*ã€‚</p>\n</li>\n</ol><p>å…¶ä¸­ï¼ŒGPU è®¾å¤‡è·¯å¾„ï¼Œæ­£æ˜¯è¯¥å®¹å™¨å¯åŠ¨æ—¶çš„ Devices å‚æ•°ï¼›è€Œé©±åŠ¨ç›®å½•ï¼Œåˆ™æ˜¯è¯¥å®¹å™¨å¯åŠ¨æ—¶çš„ Volume å‚æ•°ã€‚æ‰€ä»¥ï¼Œåœ¨ Kubernetes çš„GPU æ”¯æŒçš„å®ç°é‡Œï¼Œkubelet å®é™…ä¸Šå°±æ˜¯å°†ä¸Šè¿°ä¸¤éƒ¨åˆ†å†…å®¹ï¼Œè®¾ç½®åœ¨äº†åˆ›å»ºè¯¥å®¹å™¨çš„ CRI ï¼ˆContainer Runtime Interfaceï¼‰å‚æ•°é‡Œé¢ã€‚è¿™æ ·ï¼Œç­‰åˆ°è¯¥å®¹å™¨å¯åŠ¨ä¹‹åï¼Œå¯¹åº”çš„å®¹å™¨é‡Œå°±ä¼šå‡ºç° GPU è®¾å¤‡å’Œé©±åŠ¨çš„è·¯å¾„äº†ã€‚</p><p>ä¸è¿‡ï¼ŒKubernetes åœ¨ Pod çš„ API å¯¹è±¡é‡Œï¼Œå¹¶æ²¡æœ‰ä¸º GPU ä¸“é—¨è®¾ç½®ä¸€ä¸ªèµ„æºç±»å‹å­—æ®µï¼Œè€Œæ˜¯ä½¿ç”¨äº†ä¸€ç§å«ä½œ Extended Resourceï¼ˆERï¼‰çš„ç‰¹æ®Šå­—æ®µæ¥è´Ÿè´£ä¼ é€’ GPU çš„ä¿¡æ¯ã€‚æ¯”å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š</p><pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: cuda-vector-add\nspec:\n  restartPolicy: OnFailure\n  containers:\n    - name: cuda-vector-add\n      image: &quot;k8s.gcr.io/cuda-vector-add:v0.1&quot;\n      resources:\n        limits:\n          nvidia.com/gpu: 1\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ä¸Šè¿° Pod çš„ limits å­—æ®µé‡Œï¼Œè¿™ä¸ªèµ„æºçš„åç§°æ˜¯<code>nvidia.com/gpu</code>ï¼Œå®ƒçš„å€¼æ˜¯1ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ª Pod å£°æ˜äº†è‡ªå·±è¦ä½¿ç”¨ä¸€ä¸ª NVIDIA ç±»å‹çš„GPUã€‚</p><p>è€Œåœ¨ kube-scheduler é‡Œé¢ï¼Œå®ƒå…¶å®å¹¶ä¸å…³å¿ƒè¿™ä¸ªå­—æ®µçš„å…·ä½“å«ä¹‰ï¼Œåªä¼šåœ¨è®¡ç®—çš„æ—¶å€™ï¼Œä¸€å¾‹å°†è°ƒåº¦å™¨é‡Œä¿å­˜çš„è¯¥ç±»å‹èµ„æºçš„å¯ç”¨é‡ï¼Œç›´æ¥å‡å» Pod å£°æ˜çš„æ•°å€¼å³å¯ã€‚æ‰€ä»¥è¯´ï¼ŒExtended Resourceï¼Œå…¶å®æ˜¯ Kubernetes ä¸ºç”¨æˆ·è®¾ç½®çš„ä¸€ç§å¯¹è‡ªå®šä¹‰èµ„æºçš„æ”¯æŒã€‚</p><p>å½“ç„¶ï¼Œä¸ºäº†èƒ½å¤Ÿè®©è°ƒåº¦å™¨çŸ¥é“è¿™ä¸ªè‡ªå®šä¹‰ç±»å‹çš„èµ„æºåœ¨æ¯å°å®¿ä¸»æœºä¸Šçš„å¯ç”¨é‡ï¼Œå®¿ä¸»æœºèŠ‚ç‚¹æœ¬èº«ï¼Œå°±å¿…é¡»èƒ½å¤Ÿå‘ API Server æ±‡æŠ¥è¯¥ç±»å‹èµ„æºçš„å¯ç”¨æ•°é‡ã€‚åœ¨ Kubernetes é‡Œï¼Œå„ç§ç±»å‹çš„èµ„æºå¯ç”¨é‡ï¼Œå…¶å®æ˜¯ Node å¯¹è±¡Status å­—æ®µçš„å†…å®¹ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š</p><pre><code>apiVersion: v1\nkind: Node\nmetadata:\n  name: node-1\n...\nStatus:\n  Capacity:\n   cpu:  2\n   memory:  2049008Ki\n</code></pre><p>è€Œä¸ºäº†èƒ½å¤Ÿåœ¨ä¸Šè¿° Status å­—æ®µé‡Œæ·»åŠ è‡ªå®šä¹‰èµ„æºçš„æ•°æ®ï¼Œä½ å°±å¿…é¡»ä½¿ç”¨ PATCH API æ¥å¯¹è¯¥ Node å¯¹è±¡è¿›è¡Œæ›´æ–°ï¼ŒåŠ ä¸Šä½ çš„è‡ªå®šä¹‰èµ„æºçš„æ•°é‡ã€‚è¿™ä¸ª PATCH æ“ä½œï¼Œå¯ä»¥ç®€å•åœ°ä½¿ç”¨ curl å‘½ä»¤æ¥å‘èµ·ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code># å¯åŠ¨ Kubernetes çš„å®¢æˆ·ç«¯ proxyï¼Œè¿™æ ·ä½ å°±å¯ä»¥ç›´æ¥ä½¿ç”¨ curl æ¥è·Ÿ Kubernetes  çš„API Server è¿›è¡Œäº¤äº’äº†\n$ kubectl proxy\n\n# æ‰§è¡Œ PACTH æ“ä½œ\n$ curl --header &quot;Content-Type: application/json-patch+json&quot; \\\n--request PATCH \\\n--data '[{&quot;op&quot;: &quot;add&quot;, &quot;path&quot;: &quot;/status/capacity/nvidia.com/gpu&quot;, &quot;value&quot;: &quot;1&quot;}]' \\\nhttp://localhost:8001/api/v1/nodes/&lt;your-node-name&gt;/status\n</code></pre><p>PATCH æ“ä½œå®Œæˆåï¼Œä½ å°±å¯ä»¥çœ‹åˆ° Node çš„ Status å˜æˆäº†å¦‚ä¸‹æ‰€ç¤ºçš„å†…å®¹ï¼š</p><pre><code>apiVersion: v1\nkind: Node\n...\nStatus:\n  Capacity:\n   cpu:  2\n   memory:  2049008Ki\n   nvidia.com/gpu: 1\n</code></pre><p>è¿™æ ·åœ¨è°ƒåº¦å™¨é‡Œï¼Œå®ƒå°±èƒ½å¤Ÿåœ¨ç¼“å­˜é‡Œè®°å½•ä¸‹node-1ä¸Šçš„<code>nvidia.com/gpu</code>ç±»å‹çš„èµ„æºçš„æ•°é‡æ˜¯1ã€‚</p><p>å½“ç„¶ï¼Œåœ¨ Kubernetes çš„ GPU æ”¯æŒæ–¹æ¡ˆé‡Œï¼Œä½ å¹¶ä¸éœ€è¦çœŸæ­£å»åšä¸Šè¿°å…³äº Extended Resource çš„è¿™äº›æ“ä½œã€‚åœ¨ Kubernetes ä¸­ï¼Œå¯¹æ‰€æœ‰ç¡¬ä»¶åŠ é€Ÿè®¾å¤‡è¿›è¡Œç®¡ç†çš„åŠŸèƒ½ï¼Œéƒ½æ˜¯ç”±ä¸€ç§å«ä½œ Device Pluginçš„æ’ä»¶æ¥è´Ÿè´£çš„ã€‚è¿™å…¶ä¸­ï¼Œå½“ç„¶ä¹Ÿå°±åŒ…æ‹¬äº†å¯¹è¯¥ç¡¬ä»¶çš„ Extended Resource è¿›è¡Œæ±‡æŠ¥çš„é€»è¾‘ã€‚</p><p>Kubernetes çš„ Device Plugin æœºåˆ¶ï¼Œæˆ‘å¯ä»¥ç”¨å¦‚ä¸‹æ‰€ç¤ºçš„ä¸€å¹…ç¤ºæ„å›¾æ¥å’Œä½ è§£é‡Šæ¸…æ¥šã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/10/10/10a472b64f9daf24f63df4e3ae24cd10.jpg?wh=1640*808\" alt=\"\"></p><p>æˆ‘ä»¬å…ˆä»è¿™å¹…ç¤ºæ„å›¾çš„å³ä¾§å¼€å§‹çœ‹èµ·ã€‚</p><p>é¦–å…ˆï¼Œå¯¹äºæ¯ä¸€ç§ç¡¬ä»¶è®¾å¤‡ï¼Œéƒ½éœ€è¦æœ‰å®ƒæ‰€å¯¹åº”çš„ Device Plugin è¿›è¡Œç®¡ç†ï¼Œè¿™äº› Device Pluginï¼Œéƒ½é€šè¿‡gRPC çš„æ–¹å¼ï¼ŒåŒ kubelet è¿æ¥èµ·æ¥ã€‚ä»¥ NVIDIA GPU ä¸ºä¾‹ï¼Œå®ƒå¯¹åº”çš„æ’ä»¶å«ä½œ<a href=\"https://github.com/NVIDIA/k8s-device-plugin\"><code>NVIDIA GPU device plugin</code></a>ã€‚</p><p>è¿™ä¸ª Device Plugin ä¼šé€šè¿‡ä¸€ä¸ªå«ä½œ ListAndWatchçš„ APIï¼Œå®šæœŸå‘ kubelet æ±‡æŠ¥è¯¥ Node ä¸Š GPU çš„åˆ—è¡¨ã€‚æ¯”å¦‚ï¼Œåœ¨æˆ‘ä»¬çš„ä¾‹å­é‡Œï¼Œä¸€å…±æœ‰ä¸‰ä¸ªGPUï¼ˆGPU0ã€GPU1å’Œ GPU2ï¼‰ã€‚è¿™æ ·ï¼Œkubelet åœ¨æ‹¿åˆ°è¿™ä¸ªåˆ—è¡¨ä¹‹åï¼Œå°±å¯ä»¥ç›´æ¥åœ¨å®ƒå‘ APIServer å‘é€çš„å¿ƒè·³é‡Œï¼Œä»¥ Extended Resource çš„æ–¹å¼ï¼ŒåŠ ä¸Šè¿™äº› GPU çš„æ•°é‡ï¼Œæ¯”å¦‚<code>nvidia.com/gpu=3</code>ã€‚æ‰€ä»¥è¯´ï¼Œç”¨æˆ·åœ¨è¿™é‡Œæ˜¯ä¸éœ€è¦å…³å¿ƒ GPU ä¿¡æ¯å‘ä¸Šçš„æ±‡æŠ¥æµç¨‹çš„ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒListAndWatchå‘ä¸Šæ±‡æŠ¥çš„ä¿¡æ¯ï¼Œåªæœ‰æœ¬æœºä¸Š GPU çš„ ID åˆ—è¡¨ï¼Œè€Œä¸ä¼šæœ‰ä»»ä½•å…³äº GPU è®¾å¤‡æœ¬èº«çš„ä¿¡æ¯ã€‚è€Œä¸” kubelet åœ¨å‘ API Server æ±‡æŠ¥çš„æ—¶å€™ï¼Œåªä¼šæ±‡æŠ¥è¯¥ GPU å¯¹åº”çš„Extended Resource çš„æ•°é‡ã€‚å½“ç„¶ï¼Œkubelet æœ¬èº«ï¼Œä¼šå°†è¿™ä¸ª GPU çš„ ID åˆ—è¡¨ä¿å­˜åœ¨è‡ªå·±çš„å†…å­˜é‡Œï¼Œå¹¶é€šè¿‡ ListAndWatch API å®šæ—¶æ›´æ–°ã€‚</p><p>è€Œå½“ä¸€ä¸ª Pod æƒ³è¦ä½¿ç”¨ä¸€ä¸ª GPU çš„æ—¶å€™ï¼Œå®ƒåªéœ€è¦åƒæˆ‘åœ¨æœ¬æ–‡ä¸€å¼€å§‹ç»™å‡ºçš„ä¾‹å­ä¸€æ ·ï¼Œåœ¨ Pod çš„ limits å­—æ®µå£°æ˜<code>nvidia.com/gpu: 1</code>ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥ï¼ŒKubernetes çš„è°ƒåº¦å™¨å°±ä¼šä»å®ƒçš„ç¼“å­˜é‡Œï¼Œå¯»æ‰¾ GPU æ•°é‡æ»¡è¶³æ¡ä»¶çš„ Nodeï¼Œç„¶åå°†ç¼“å­˜é‡Œçš„ GPU æ•°é‡å‡1ï¼Œå®ŒæˆPod ä¸ Node çš„ç»‘å®šã€‚</p><p>è¿™ä¸ªè°ƒåº¦æˆåŠŸåçš„ Podä¿¡æ¯ï¼Œè‡ªç„¶å°±ä¼šè¢«å¯¹åº”çš„ kubelet æ‹¿æ¥è¿›è¡Œå®¹å™¨æ“ä½œã€‚è€Œå½“ kubelet å‘ç°è¿™ä¸ª Pod çš„å®¹å™¨è¯·æ±‚ä¸€ä¸ª GPU çš„æ—¶å€™ï¼Œkubelet å°±ä¼šä»è‡ªå·±æŒæœ‰çš„ GPUåˆ—è¡¨é‡Œï¼Œä¸ºè¿™ä¸ªå®¹å™¨åˆ†é…ä¸€ä¸ªGPUã€‚æ­¤æ—¶ï¼Œkubelet å°±ä¼šå‘æœ¬æœºçš„ Device Plugin å‘èµ·ä¸€ä¸ª Allocate() è¯·æ±‚ã€‚è¿™ä¸ªè¯·æ±‚æºå¸¦çš„å‚æ•°ï¼Œæ­£æ˜¯å³å°†åˆ†é…ç»™è¯¥å®¹å™¨çš„è®¾å¤‡ ID åˆ—è¡¨ã€‚</p><p>å½“ Device Plugin æ”¶åˆ° Allocate è¯·æ±‚ä¹‹åï¼Œå®ƒå°±ä¼šæ ¹æ®kubelet ä¼ é€’è¿‡æ¥çš„è®¾å¤‡ IDï¼Œä»Device Plugin é‡Œæ‰¾åˆ°è¿™äº›è®¾å¤‡å¯¹åº”çš„è®¾å¤‡è·¯å¾„å’Œé©±åŠ¨ç›®å½•ã€‚å½“ç„¶ï¼Œè¿™äº›ä¿¡æ¯ï¼Œæ­£æ˜¯ Device Plugin å‘¨æœŸæ€§çš„ä»æœ¬æœºæŸ¥è¯¢åˆ°çš„ã€‚æ¯”å¦‚ï¼Œåœ¨ NVIDIA Device Plugin çš„å®ç°é‡Œï¼Œå®ƒä¼šå®šæœŸè®¿é—® nvidia-docker æ’ä»¶ï¼Œä»è€Œè·å–åˆ°æœ¬æœºçš„ GPU ä¿¡æ¯ã€‚</p><p>è€Œè¢«åˆ†é…GPUå¯¹åº”çš„è®¾å¤‡è·¯å¾„å’Œé©±åŠ¨ç›®å½•ä¿¡æ¯è¢«è¿”å›ç»™ kubelet ä¹‹åï¼Œkubelet å°±å®Œæˆäº†ä¸ºä¸€ä¸ªå®¹å™¨åˆ†é… GPU çš„æ“ä½œã€‚æ¥ä¸‹æ¥ï¼Œkubelet ä¼šæŠŠè¿™äº›ä¿¡æ¯è¿½åŠ åœ¨åˆ›å»ºè¯¥å®¹å™¨æ‰€å¯¹åº”çš„ CRI è¯·æ±‚å½“ä¸­ã€‚è¿™æ ·ï¼Œå½“è¿™ä¸ª CRI è¯·æ±‚å‘ç»™ Docker ä¹‹åï¼ŒDocker ä¸ºä½ åˆ›å»ºå‡ºæ¥çš„å®¹å™¨é‡Œï¼Œå°±ä¼šå‡ºç°è¿™ä¸ª GPU è®¾å¤‡ï¼Œå¹¶æŠŠå®ƒæ‰€éœ€è¦çš„é©±åŠ¨ç›®å½•æŒ‚è½½è¿›å»ã€‚</p><p>è‡³æ­¤ï¼ŒKubernetes ä¸ºä¸€ä¸ªPod åˆ†é…ä¸€ä¸ª GPU çš„æµç¨‹å°±å®Œæˆäº†ã€‚</p><p>å¯¹äºå…¶ä»–ç±»å‹ç¡¬ä»¶æ¥è¯´ï¼Œè¦æƒ³åœ¨ Kubernetes æ‰€ç®¡ç†çš„å®¹å™¨é‡Œä½¿ç”¨è¿™äº›ç¡¬ä»¶çš„è¯ï¼Œä¹Ÿéœ€è¦éµå¾ªä¸Šè¿° Device Plugin çš„æµç¨‹æ¥å®ç°å¦‚ä¸‹æ‰€ç¤ºçš„Allocateå’Œ ListAndWatch APIï¼š</p><pre><code>  service DevicePlugin {\n        // ListAndWatch returns a stream of List of Devices\n        // Whenever a Device state change or a Device disappears, ListAndWatch\n        // returns the new list\n        rpc ListAndWatch(Empty) returns (stream ListAndWatchResponse) {}\n        // Allocate is called during container creation so that the Device\n        // Plugin can run device specific operations and instruct Kubelet\n        // of the steps to make the Device available in the container\n        rpc Allocate(AllocateRequest) returns (AllocateResponse) {}\n  }\n</code></pre><p>ç›®å‰ï¼ŒKubernetesç¤¾åŒºé‡Œå·²ç»å®ç°äº†å¾ˆå¤šç¡¬ä»¶æ’ä»¶ï¼Œæ¯”å¦‚<a href=\"https://github.com/intel/intel-device-plugins-for-kubernetes\">FPGA</a>ã€<a href=\"https://github.com/intel/sriov-network-device-plugin\">SRIOV</a>ã€<a href=\"https://github.com/hustcat/k8s-rdma-device-plugin\">RDMA</a>ç­‰ç­‰ã€‚æ„Ÿå…´è¶£çš„è¯ï¼Œä½ å¯ä»¥ç‚¹å‡»è¿™äº›é“¾æ¥æ¥æŸ¥çœ‹è¿™äº› Device Plugin çš„å®ç°ã€‚</p><h2>æ€»ç»“</h2><p>åœ¨æœ¬ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä¸ºä½ è¯¦ç»†è®²è¿°äº† Kubernetes å¯¹ GPU çš„ç®¡ç†æ–¹å¼ï¼Œä»¥åŠå®ƒæ‰€éœ€è¦ä½¿ç”¨çš„ Device Plugin æœºåˆ¶ã€‚</p><p>éœ€è¦æŒ‡å‡ºçš„æ˜¯ï¼ŒDevice Plugin çš„è®¾è®¡ï¼Œé•¿æœŸä»¥æ¥éƒ½æ˜¯ä»¥ Google Cloud çš„ç”¨æˆ·éœ€æ±‚ä¸ºä¸»å¯¼çš„ï¼Œæ‰€ä»¥ï¼Œå®ƒçš„æ•´å¥—å·¥ä½œæœºåˆ¶å’Œæµç¨‹ä¸Šï¼Œå®é™…ä¸Šè·Ÿå­¦æœ¯ç•Œå’Œå·¥ä¸šç•Œçš„çœŸå®åœºæ™¯è¿˜æœ‰ç€ä¸å°çš„å·®å¼‚ã€‚</p><p>è¿™é‡Œæœ€å¤§çš„é—®é¢˜åœ¨äºï¼ŒGPU ç­‰ç¡¬ä»¶è®¾å¤‡çš„è°ƒåº¦å·¥ä½œï¼Œå®é™…ä¸Šæ˜¯ç”± kubelet å®Œæˆçš„ã€‚å³ï¼Œkubelet ä¼šè´Ÿè´£ä»å®ƒæ‰€æŒæœ‰çš„ç¡¬ä»¶è®¾å¤‡åˆ—è¡¨ä¸­ï¼Œä¸ºå®¹å™¨æŒ‘é€‰ä¸€ä¸ªç¡¬ä»¶è®¾å¤‡ï¼Œç„¶åè°ƒç”¨ Device Plugin çš„ Allocate API æ¥å®Œæˆè¿™ä¸ªåˆ†é…æ“ä½œã€‚å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æ•´æ¡é“¾è·¯ä¸­ï¼Œè°ƒåº¦å™¨æ‰®æ¼”çš„è§’è‰²ï¼Œä»…ä»…æ˜¯ä¸º Pod å¯»æ‰¾åˆ°å¯ç”¨çš„ã€æ”¯æŒè¿™ç§ç¡¬ä»¶è®¾å¤‡çš„èŠ‚ç‚¹è€Œå·²ã€‚</p><p>è¿™å°±ä½¿å¾—ï¼ŒKubernetes é‡Œå¯¹ç¡¬ä»¶è®¾å¤‡çš„ç®¡ç†ï¼Œåªèƒ½å¤„ç†â€œè®¾å¤‡ä¸ªæ•°â€è¿™å”¯ä¸€ä¸€ç§æƒ…å†µã€‚ä¸€æ—¦ä½ çš„è®¾å¤‡æ˜¯å¼‚æ„çš„ã€ä¸èƒ½ç®€å•åœ°ç”¨â€œæ•°ç›®â€å»æè¿°å…·ä½“ä½¿ç”¨éœ€æ±‚çš„æ—¶å€™ï¼Œæ¯”å¦‚ï¼Œâ€œæˆ‘çš„ Pod æƒ³è¦è¿è¡Œåœ¨è®¡ç®—èƒ½åŠ›æœ€å¼ºçš„é‚£ä¸ª GPU ä¸Šâ€ï¼ŒDevice Plugin å°±å®Œå…¨ä¸èƒ½å¤„ç†äº†ã€‚</p><p>æ›´ä¸ç”¨è¯´ï¼Œåœ¨å¾ˆå¤šåœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å…¶å®å¸Œæœ›åœ¨è°ƒåº¦å™¨è¿›è¡Œè°ƒåº¦çš„æ—¶å€™ï¼Œå°±å¯ä»¥æ ¹æ®æ•´ä¸ªé›†ç¾¤é‡Œçš„æŸç§ç¡¬ä»¶è®¾å¤‡çš„å…¨å±€åˆ†å¸ƒï¼Œåšå‡ºä¸€ä¸ªæœ€ä½³çš„è°ƒåº¦é€‰æ‹©ã€‚</p><p>æ­¤å¤–ï¼Œä¸Šè¿° Device Plugin çš„è®¾è®¡ï¼Œä¹Ÿä½¿å¾— Kubernetes é‡Œï¼Œç¼ºä¹ä¸€ç§èƒ½å¤Ÿå¯¹ Device è¿›è¡Œæè¿°çš„ API å¯¹è±¡ã€‚è¿™å°±ä½¿å¾—å¦‚æœä½ çš„ç¡¬ä»¶è®¾å¤‡æœ¬èº«çš„å±æ€§æ¯”è¾ƒå¤æ‚ï¼Œå¹¶ä¸” Pod ä¹Ÿå…³å¿ƒè¿™äº›ç¡¬ä»¶çš„å±æ€§çš„è¯ï¼Œé‚£ä¹ˆ Device Plugin ä¹Ÿæ˜¯å®Œå…¨æ²¡æœ‰åŠæ³•æ”¯æŒçš„ã€‚</p><p>æ›´ä¸ºæ£˜æ‰‹çš„æ˜¯ï¼Œåœ¨Device Plugin çš„è®¾è®¡å’Œå®ç°ä¸­ï¼ŒGoogle çš„å·¥ç¨‹å¸ˆä»¬ä¸€ç›´ä¸å¤ªæ„¿æ„ä¸º Allocate å’Œ ListAndWatch API æ·»åŠ å¯æ‰©å±•æ€§çš„å‚æ•°ã€‚è¿™å°±ä½¿å¾—ï¼Œå½“ä½ ç¡®å®éœ€è¦å¤„ç†ä¸€äº›æ¯”è¾ƒå¤æ‚çš„ç¡¬ä»¶è®¾å¤‡ä½¿ç”¨éœ€æ±‚æ—¶ï¼Œæ˜¯æ²¡æœ‰åŠæ³•é€šè¿‡æ‰©å±• Device Plugin çš„ APIæ¥å®ç°çš„ã€‚</p><p>é’ˆå¯¹è¿™äº›é—®é¢˜ï¼ŒRedHat åœ¨ç¤¾åŒºé‡Œæ›¾ç»å¤§åŠ›æ¨è¿›è¿‡ <a href=\"https://github.com/kubernetes/community/pull/2265\">ResourceClass</a>çš„è®¾è®¡ï¼Œè¯•å›¾å°†ç¡¬ä»¶è®¾å¤‡çš„ç®¡ç†åŠŸèƒ½ä¸Šæµ®åˆ° API å±‚å’Œè°ƒåº¦å±‚ã€‚ä½†æ˜¯ï¼Œç”±äºå„æ–¹åŠ¿åŠ›çš„åå¯¹ï¼Œè¿™ä¸ªæè®®æœ€åä¸äº†äº†ä¹‹äº†ã€‚</p><p>æ‰€ä»¥è¯´ï¼Œç›®å‰ Kubernetes æœ¬èº«çš„ Device Plugin çš„è®¾è®¡ï¼Œå®é™…ä¸Šèƒ½è¦†ç›–çš„åœºæ™¯æ˜¯éå¸¸å•ä¸€çš„ï¼Œå±äºâ€œå¯ç”¨â€ä½†æ˜¯â€œä¸å¥½ç”¨â€çš„çŠ¶æ€ã€‚å¹¶ä¸”ï¼Œ Device Plugin çš„ API æœ¬èº«çš„å¯æ‰©å±•æ€§ä¹Ÿä¸æ˜¯å¾ˆå¥½ã€‚è¿™ä¹Ÿå°±è§£é‡Šäº†ä¸ºä»€ä¹ˆåƒ NVIDIA è¿™æ ·çš„ç¡¬ä»¶å‚å•†ï¼Œå®é™…ä¸Šå¹¶æ²¡æœ‰å®Œå…¨åŸºäºä¸Šæ¸¸çš„ Kubernetes ä»£ç æ¥å®ç°è‡ªå·±çš„ GPU è§£å†³æ–¹æ¡ˆï¼Œè€Œæ˜¯åšäº†ä¸€å®šçš„æ”¹åŠ¨ï¼Œä¹Ÿå°±æ˜¯ forkã€‚è¿™ï¼Œå®å±ä¸å¾—å·²è€Œä¸ºä¹‹ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>è¯·ä½ ç»“åˆè‡ªå·±çš„éœ€æ±‚è°ˆä¸€è°ˆï¼Œä½ å¸Œæœ›å¦‚ä½•å¯¹å½“å‰çš„ Device Pluginè¿›è¡Œæ”¹è¿›å‘¢ï¼Ÿæˆ–è€…è¯´ï¼Œä½ è§‰å¾—å½“å‰çš„è®¾è®¡å·²ç»å®Œå…¨å¤Ÿç”¨äº†å—ï¼Ÿ</p><p>æ„Ÿè°¢ä½ çš„æ”¶å¬ï¼Œæ¬¢è¿ä½ ç»™æˆ‘ç•™è¨€ï¼Œä¹Ÿæ¬¢è¿åˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹ä¸€èµ·é˜…è¯»ã€‚</p>","comments":[{"had_liked":false,"id":46593,"user_name":"Eric","can_delete":false,"product_type":"c1","uid":1227651,"ip_address":"","ucode":"5242C31C614476","user_header":"https://static001.geekbang.org/account/avatar/00/12/bb/83/39c48a58.jpg","comment_is_top":false,"comment_ctime":1543942679,"is_pvip":false,"replies":[{"id":"17511","content":"æˆ‘å·²ç»åæ§½çš„å¾ˆå§”å©‰äº†","user_name":"ä½œè€…å›å¤","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1544533748,"ip_address":"","comment_id":46593,"utype":1}],"discussion_count":2,"race_medal":0,"score":"130392961559","product_id":100015201,"comment_content":"å•å—GPUèµ„æºéƒ½ä¸èƒ½å…±äº«ï¼Œè¿˜å¾—è‡ªå·±forkä¸€ä»½device pluginç»´æŠ¤è™šæ‹ŸåŒ–çš„GPUã€‚ ç¤¾åŒºæœ‰æ—¶å€™åŠäº‹çœŸçš„ä¸åˆ©ç´¢","like_count":31,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"å¼ ç£Š Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431491,"discussion_content":"æˆ‘å·²ç»åæ§½çš„å¾ˆå§”å©‰äº†","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1544533748,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2040257,"avatar":"","nickname":"é™ˆå¿—å¼º2","note":"","ucode":"28EC0004F06322","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":304845,"discussion_content":"å¯ä»¥äº†è§£ä¸‹rancher","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1599697230,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":98223,"user_name":"å‡Œ","can_delete":false,"product_type":"c1","uid":1257995,"ip_address":"","ucode":"41369B360C794F","user_header":"https://static001.geekbang.org/account/avatar/00/13/32/0b/81ae214b.jpg","comment_is_top":false,"comment_ctime":1558936519,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"31623707591","product_id":100015201,"comment_content":"https:&#47;&#47;mp.weixin.qq.com&#47;s&#47;NU8Cj6DL8wEKFzVYhuyzbQ","like_count":7,"discussions":[{"author":{"id":1751859,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/bb/33/5545b42e.jpg","nickname":"Bobo","note":"","ucode":"23102FBE943515","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":356112,"discussion_content":"å‰å®³å‰å®³  æ‰äº‘ç°åœ¨å·²ç»è¢«å¤´æ¡æ”¶è´­äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1615533616,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":120427,"user_name":"å°æ²³","can_delete":false,"product_type":"c1","uid":1345696,"ip_address":"","ucode":"97E81BF18F272A","user_header":"https://static001.geekbang.org/account/avatar/00/14/88/a0/562c2626.jpg","comment_is_top":false,"comment_ctime":1564890079,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"27334693855","product_id":100015201,"comment_content":"hiï¼Œå¼ è€å¸ˆï¼Œæˆ‘ç°åœ¨å°†gpuçš„æœåŠ¡è¿ç§»åˆ°kubernetesä¸Šï¼Œå¯¹å¤–æä¾›çš„æ˜¯gRRCæ¥å£ï¼Œæˆ‘ä½¿ç”¨äº†ingres-nginxå¯¹gRPCè¿›è¡Œè´Ÿè½½å‡è¡¡ï¼Œä½†æ˜¯å‘ç°æ”¯æŒå¹¶ä¸å¥½ï¼Œåˆæƒ³ä½¿ç”¨Istioä»¥sidecaræ¨¡å¼ä»£ç†gPRCï¼Œä½†æ˜¯åˆè§‰å¾—å¤ªé‡ï¼Œè¯·é—®ç›®å‰æœ‰ä»€ä¹ˆè¾ƒå¥½çš„æ–¹æ¡ˆåœ¨kuberntesæ”¯æŒå¯¹gRPCçš„è´Ÿè½½å‡è¡¡ä¹ˆğŸ˜€","like_count":6,"discussions":[{"author":{"id":1707741,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/vM2NmFZQYmb4kkk8Cba1fGP4bhK9diaeXb2LXFWXJWfOPuibK3aib24qujweqciaxt43btqicSz9gDDlJkUQ12RDfJQ/132","nickname":"Geek_955506","note":"","ucode":"D07C5B9A1ECEA1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":579824,"discussion_content":"æˆ‘å¸ç”¨çš„ contourï¼Œæ˜¯ä¸€ä¸ª GRPC åŸç”Ÿçš„ingressï¼Œåº•å±‚ç”¨çš„ Envoyã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1657703198,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49271,"user_name":"å‹‡æ•¢çš„å¿ƒ","can_delete":false,"product_type":"c1","uid":1198639,"ip_address":"","ucode":"43678591F1A558","user_header":"https://static001.geekbang.org/account/avatar/00/12/4a/2f/42aa48d7.jpg","comment_is_top":false,"comment_ctime":1544658568,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"14429560456","product_id":100015201,"comment_content":"æ‰€ä»¥ç›®å‰æ˜¯æ— æ³•å®ç°å¤šç”¨æˆ·åŒæ—¶å…±äº«å•å—GPUå’¯ï¼Ÿæœ‰æ²¡æœ‰å¯ä»¥å®ç°è¿™ä¸€åŠŸèƒ½çš„Magicï¼Ÿè¿˜æœ‰ï¼Œç›®å‰å¯èƒ½å®ç°GPUæˆ–è€…CPUæ•°é‡çš„åŠ¨æ€æ”¹å˜å—ï¼Œåœ¨ä¸é‡å»ºpodçš„æƒ…å†µä¸‹ï¼ŸæœŸå¾…è€å¸ˆçš„è§£ç­”","like_count":4},{"had_liked":false,"id":46581,"user_name":"ä¹±æ„£é»","can_delete":false,"product_type":"c1","uid":1324168,"ip_address":"","ucode":"83DA6683DEDC4A","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/S8nYMkG2uByU9IpbAExZwLAa1no0RgKeeqjfBns0fVuBGU3GlVwia5BKujIX4648h9N2OMsyVVCLbKibje06HicvQ/132","comment_is_top":false,"comment_ctime":1543939344,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"14428841232","product_id":100015201,"comment_content":"1ã€device pluginåªèƒ½é€šè¿‡patchæ“ä½œæ¥å®ç°deviceä¿¡æ¯çš„æ·»åŠ å—ï¼Ÿèƒ½å¦åœ¨èŠ‚ç‚¹æ·»åŠ çš„æ—¶å€™è‡ªåŠ¨æ·»åŠ <br>2ã€åœ¨ç¬¬1ç‚¹çš„æƒ…å†µä¸‹ï¼Œåœ¨æœåŠ¡å™¨æŒç»­é›†æˆçš„æƒ…å†µä¸‹ï¼Œæ–°æ—§è®¾å¤‡deviceä¿¡æ¯è‚¯å®šæ˜¯ä¼šä¸ä¸€è‡´çš„ï¼Œå¦‚ä½•è§£å†³device pluginæœºåˆ¶æ— æ³•åŒºåˆ†è®¾å¤‡å±æ€§çš„æƒ…å†µï¼Ÿ<br>    ä»¥æœ¬ç¯‡æ–‡ç« çš„å†…å®¹æ¥çœ‹ï¼Œå¯ä»¥è¿™ä¹ˆè®¾ç½®<br>    æ‰¹æ¬¡Aä½¿ç”¨nvidia.com&#47;GP100=4ï¼Œæ‰¹æ¬¡Bä½¿ç”¨amd.com&#47;VEGA64=4<br>    è¿™æ ·ç¼–å†™èµ„æºéœ€æ±‚å’Œæ–°æ—§è®¾å¤‡äº¤æ›¿éƒ½éœ€è¦äººä¸ºæŒ‡å®šï¼Œè¿™æ ·å¯¹äºè¿ç»´æ¥è¯´å¾ˆéš¾å—å•Š<br>3ã€æ˜¯å¦èƒ½æŠŠGPUæŠ½è±¡æˆç±»ä¼¼äºCPUçš„æ—¶é—´ç‰‡ï¼Œå°†æ•´ä¸ªGPUè®¡ç®—èƒ½åŠ›æ± åŒ–ï¼Œç„¶åæ ¹æ®pod.spec.containers.resourcesé‡Œé¢çš„requireå’Œlimitså­—æ®µæ¥åˆ†é…GPUè®¡ç®—èµ„æº","like_count":3},{"had_liked":false,"id":45838,"user_name":"hlzhu1983","can_delete":false,"product_type":"c1","uid":1335076,"ip_address":"","ucode":"2BF4DD66CF3C9D","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/oyZfdsQL71tLcX1Eiav4NOMxa2yRSQmQNFzm7SV2aicfNkXoIN80DN2Iafpnmu2WVPBdlHylOWwElrVA8A8X71qQ/132","comment_is_top":false,"comment_ctime":1543802317,"is_pvip":false,"replies":[{"id":"17513","content":"å¾ˆç²—ç²’åº¦å‘¢","user_name":"ä½œè€…å›å¤","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1544533806,"ip_address":"","comment_id":45838,"utype":1}],"discussion_count":2,"race_medal":0,"score":"14428704205","product_id":100015201,"comment_content":"å¼ è€å¸ˆï¼Œé—®ä¸€ä¸‹ç°åœ¨k8så…³äºGPUèµ„æºè°ƒåº¦ç²’åº¦æ˜¯å¦èƒ½åƒCPUè°ƒåº¦ç²’åº¦é‚£ä¹ˆç»†ï¼Ÿç°åœ¨è¿˜åªèƒ½æŒ‰ç…§1å—GPUå¡æ¥åˆ†é…GPUèµ„æºå—ï¼Ÿ","like_count":3,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"å¼ ç£Š Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431231,"discussion_content":"å¾ˆç²—ç²’åº¦å‘¢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544533806,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1218501,"avatar":"https://static001.geekbang.org/account/avatar/00/12/97/c5/84491beb.jpg","nickname":"ç½—å³°","note":"","ucode":"5F3D6AF8F28322","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":376906,"discussion_content":"æ‰€ä»¥ä½“ç°åœ¨æ²¡æ³•åƒcpué‚£æ ·æ”¯æŒ0.5cå§","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1622421070,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":269021,"user_name":"ch_ort","can_delete":false,"product_type":"c1","uid":1580926,"ip_address":"","ucode":"B79746E687F29E","user_header":"","comment_is_top":false,"comment_ctime":1608474507,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10198409099","product_id":100015201,"comment_content":"Kuberentesé€šè¿‡Extended Resourceæ¥æ”¯æŒè‡ªå®šä¹‰èµ„æºï¼Œæ¯”å¦‚GPUã€‚ä¸ºäº†è®©è°ƒåº¦å™¨çŸ¥é“è¿™ç§è‡ªå®šä¹‰èµ„æºåœ¨å„Nodeä¸Šçš„æ•°é‡ï¼Œéœ€è¦çš„Nodeé‡Œæ·»åŠ è‡ªå®šä¹‰èµ„æºçš„æ•°é‡ã€‚å®é™…ä¸Šï¼Œè¿™äº›ä¿¡æ¯å¹¶ä¸éœ€è¦äººå·¥å»ç»´æŠ¤ï¼Œæ‰€æœ‰çš„ç¡¬ä»¶åŠ é€Ÿè®¾å¤‡çš„ç®¡ç†éƒ½é€šè¿‡Device Pluginæ’ä»¶æ¥æ”¯æŒï¼Œä¹ŸåŒ…æ‹¬å¯¹è¯¥ç¡¬ä»¶çš„Extended Resourceè¿›è¡Œæ±‡æŠ¥çš„é€»è¾‘ã€‚<br><br>Device Plugin ã€kubeletã€è°ƒåº¦å™¨å¦‚ä½•ååŒå·¥ä½œï¼š<br><br>æ±‡æŠ¥èµ„æºï¼š Device Pluginé€šè¿‡gRPCä¸æœ¬æœºkubeletè¿æ¥ -&gt;  Device Pluginå®šæœŸå‘kubeletæ±‡æŠ¥è®¾å¤‡ä¿¡æ¯ï¼Œæ¯”å¦‚GPUçš„æ•°é‡ -&gt; kubelet å‘APIServerå‘é€çš„å¿ƒè·³ä¸­ï¼Œä»¥Extended Reousrceçš„æ–¹å¼åŠ ä¸Šè¿™äº›è®¾å¤‡ä¿¡æ¯ï¼Œæ¯”å¦‚GPUçš„æ•°é‡ <br><br>è°ƒåº¦ï¼š Podç”³æ˜éœ€è¦ä¸€ä¸ªGPU -&gt; è°ƒåº¦å™¨æ‰¾åˆ°GPUæ•°é‡æ»¡è¶³æ¡ä»¶çš„node -&gt; Podç»‘å®šåˆ°å¯¹åº”çš„Nodeä¸Š -&gt; kubeletå‘ç°éœ€è¦æ‹‰èµ·ä¸€ä¸ªPodï¼Œä¸”è¯¥Podéœ€è¦GPU -&gt; kubeletå‘ Device Plugin å‘èµ· Allocate()è¯·æ±‚ -&gt; Device Pluginæ ¹æ®kubeletä¼ é€’è¿‡æ¥çš„éœ€æ±‚ï¼Œæ‰¾åˆ°è¿™äº›è®¾å¤‡å¯¹åº”çš„è®¾å¤‡è·¯å¾„å’Œé©±åŠ¨ç›®å½•ï¼Œå¹¶è¿”å›ç»™kubelet -&gt; kubeletå°†è¿™äº›ä¿¡æ¯è¿½åŠ åœ¨åˆ›å»ºPodæ‰€å¯¹åº”çš„CRIè¯·æ±‚ä¸­ -&gt; å®¹å™¨åˆ›å»ºå®Œæˆä¹‹åï¼Œå°±ä¼šå‡ºç°è¿™ä¸ªGPUè®¾å¤‡ï¼ˆè®¾å¤‡è·¯å¾„+é©±åŠ¨ç›®å½•ï¼‰-&gt; è°ƒåº¦å®Œæˆ<br>","like_count":2},{"had_liked":false,"id":255534,"user_name":"æ±Ÿå±±æœª","can_delete":false,"product_type":"c1","uid":1090196,"ip_address":"","ucode":"5293DD9482717F","user_header":"https://static001.geekbang.org/account/avatar/00/10/a2/94/ae0a60d8.jpg","comment_is_top":false,"comment_ctime":1603366851,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10193301443","product_id":100015201,"comment_content":"GPUå…±äº«åŠè™šæ‹ŸåŒ–ï¼Œå¯ä»¥æœç´¢ä¸€ä¸‹Orion VGPU","like_count":3},{"had_liked":false,"id":46339,"user_name":"æ¯æ—¥éƒ½æƒ³ä¸Šç­","can_delete":false,"product_type":"c1","uid":1060466,"ip_address":"","ucode":"1DE64120C8B14A","user_header":"https://static001.geekbang.org/account/avatar/00/10/2e/72/145c10db.jpg","comment_is_top":false,"comment_ctime":1543903469,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10133838061","product_id":100015201,"comment_content":"ä»Šå¤©çˆ†å‡ºkubeneteså®‰å…¨æ¼æ´éœ€è¦å‡çº§ï¼Œè¯·é—®è¦å¦‚ä½•å‡çº§<br>","like_count":2},{"had_liked":false,"id":267918,"user_name":"å¼ æŒ¯å®‡","can_delete":false,"product_type":"c1","uid":1130691,"ip_address":"","ucode":"7A6FD7294E65FF","user_header":"https://static001.geekbang.org/account/avatar/00/11/40/c3/e545ba80.jpg","comment_is_top":false,"comment_ctime":1607996301,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5902963597","product_id":100015201,"comment_content":"è€å¸ˆï¼Œæˆ‘ä»¬çš„2ä¸ªpodç»å¸¸å‡ºç°å…±ç”¨ä¸€å¼ gpuå¡çš„æƒ…å†µï¼Œå¯¼è‡´æ€§èƒ½äº’ç›¸å½±å“ï¼Œæ±‚è§£æ•‘ã€‚","like_count":1},{"had_liked":false,"id":167575,"user_name":"PatHoo","can_delete":false,"product_type":"c1","uid":1097801,"ip_address":"","ucode":"7519F3ABCB7AC6","user_header":"https://static001.geekbang.org/account/avatar/00/10/c0/49/e2a18264.jpg","comment_is_top":false,"comment_ctime":1577865214,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5872832510","product_id":100015201,"comment_content":"è¯·é—®ç°åœ¨K8Sæ”¯æŒæŒ‰ç¡¬ä»¶æ‹“æ‰‘ç»“æ„è°ƒåº¦äº†å—? ","like_count":1},{"had_liked":false,"id":45752,"user_name":"ç¡•","can_delete":false,"product_type":"c1","uid":1310756,"ip_address":"","ucode":"661AE1FC22C943","user_header":"https://static001.geekbang.org/account/avatar/00/14/00/24/6ff7cb37.jpg","comment_is_top":false,"comment_ctime":1543769316,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5838736612","product_id":100015201,"comment_content":"åˆšå…¬å¸éœ€è¦ ä½¿ç”¨nvdia-docker ç®¡ç† gpu ç”¨äºéƒ¨ç½²ai å›¾åƒ è¿™å°±æ¥äº†","like_count":1},{"had_liked":false,"id":349029,"user_name":"Geek_4acba3","can_delete":false,"product_type":"c1","uid":2723551,"ip_address":"","ucode":"016F1C56E95FAE","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/uUwMSbicsSdrzWpnCBJKMgOpA6MzgztaqNr4w9kiciaH7wFlcsjd97cYhduMXyYicdV9r0vTTmqPReTYr6ia2S15meA/132","comment_is_top":false,"comment_ctime":1655652817,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1655652817","product_id":100015201,"comment_content":"è¯·æ•™ä¸€ä¸‹ï¼Œå¦‚æœæ ¹æ®GPUæ˜¾å­˜èµ„æºæ¥è°ƒåº¦æœ‰ä»€ä¹ˆå¥½åŠæ³•å—ï¼Ÿ","like_count":0},{"had_liked":false,"id":288676,"user_name":"è¡Œé“è€…","can_delete":false,"product_type":"c1","uid":1115729,"ip_address":"","ucode":"7161C994C088D8","user_header":"","comment_is_top":false,"comment_ctime":1618622859,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1618622859","product_id":100015201,"comment_content":"è€å¸ˆï¼Œè¯·é—®å¦‚ä½•ç®¡ç†å¤šä¸ªä¸åŒk8sé›†ç¾¤çš„GPUèµ„æºï¼Œä¸šç•Œæœ‰è¿™æ ·çš„æ–¹æ¡ˆå—ï¼Ÿè°¢è°¢","like_count":0,"discussions":[{"author":{"id":1044053,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ee/55/773bfa13.jpg","nickname":"fengelee5","note":"","ucode":"9C9E66647FE4C2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":589168,"discussion_content":"æ‚¨å¥½ï¼Œã€ç®¡ç†å¤šä¸ªä¸åŒk8sé›†ç¾¤çš„GPUèµ„æºã€ â€”â€” æœ‰äº†å®è·µå¿ƒå¾—ä¹ˆï¼Œæ¬¢è¿åˆ†äº«å‘€ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1664490373,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"åŒ—äº¬"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":253677,"user_name":"Heaven","can_delete":false,"product_type":"c1","uid":1694207,"ip_address":"","ucode":"FA33FBCC66C911","user_header":"https://static001.geekbang.org/account/avatar/00/19/d9/ff/b23018a6.jpg","comment_is_top":false,"comment_ctime":1602829160,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1602829160","product_id":100015201,"comment_content":"ç°åœ¨çš„èµ„æºå¿…ç„¶ä¸å¤Ÿç”¨,å› ä¸ºåªèƒ½æŒ‰ç…§æ•´æ•°ç±»å‹çš„åˆ†é…,å¯¼è‡´å¾ˆå¤šæ—¶å€™,ä¸èƒ½å…±äº«èµ„æº<br>æ— æ³•åšåˆ°æŒ‰éœ€ä¿®æ”¹api","like_count":0},{"had_liked":false,"id":154640,"user_name":"æ‹‰æ¬§","can_delete":false,"product_type":"c1","uid":1206605,"ip_address":"","ucode":"40996A8093A95F","user_header":"https://static001.geekbang.org/account/avatar/00/12/69/4d/81c44f45.jpg","comment_is_top":false,"comment_ctime":1574497995,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1574497995","product_id":100015201,"comment_content":"æŒ‰éœ€å¢åŠ api, googleæŠŠè¿™ä¸€å—å®Œå…¨å¼€æ”¾å‡ºæ¥ï¼Œåº”è¯¥æ˜¯å”¯ä¸€çš„é“è·¯","like_count":0},{"had_liked":false,"id":110683,"user_name":"Tarjintor","can_delete":false,"product_type":"c1","uid":1519558,"ip_address":"","ucode":"AC5DD78B2EB962","user_header":"https://static001.geekbang.org/account/avatar/00/17/2f/c6/b7448158.jpg","comment_is_top":false,"comment_ctime":1562314187,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1562314187","product_id":100015201,"comment_content":"é‚£ä¹ˆï¼Œç†è®ºä¸Šï¼Œå¯ä»¥åšåˆ°å¯¹ä¸€ä¸ªè¿›ç¨‹ç»„çš„gpuä½¿ç”¨ç™¾åˆ†æ¯”åšé™åˆ¶å—ï¼Ÿ<br>ä¹‹å‰å¯¹dockeråšä»‹ç»çš„æ—¶å€™ï¼Œè¯´è¿‡å¯ä»¥é™åˆ¶ä¸€ä¸ªcpuæ‰€èƒ½ä½¿ç”¨çš„ç™¾åˆ†æ¯”","like_count":0},{"had_liked":false,"id":76562,"user_name":"Hank","can_delete":false,"product_type":"c1","uid":1460347,"ip_address":"","ucode":"3BE6B86218F957","user_header":"https://static001.geekbang.org/account/avatar/00/16/48/7b/bc7fcac2.jpg","comment_is_top":false,"comment_ctime":1552632739,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1552632739","product_id":100015201,"comment_content":"kubeflow èƒ½å¦è§£å†³æ­¤äº‹å‘¢ï¼Ÿ    ç²—é¢—ç²’ è½¬æ¢æˆç»†ç²’åº¦","like_count":0,"discussions":[{"author":{"id":1021421,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJUSUdGJFtQolpA8mANMZnjXB18ibmx5JRhI0byF4jb29qNghKoEk9EDJNIIiayJDCnqZLSutX3pXnQ/132","nickname":"DI-é™ˆèµœï¼ˆzeï¼‰","note":"","ucode":"2EDABDDB80F2C5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":115784,"discussion_content":"æˆªæ­¢åˆ°ç›®å‰ä¸å¯ä»¥","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578034991,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":75785,"user_name":"ğŸ”œ","can_delete":false,"product_type":"c1","uid":1224046,"ip_address":"","ucode":"E75A44829D9ED8","user_header":"https://static001.geekbang.org/account/avatar/00/12/ad/6e/f08676bf.jpg","comment_is_top":false,"comment_ctime":1552468809,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1552468809","product_id":100015201,"comment_content":"[root@bigdata-k8s-master-1 ~]# curl --header &quot;Content-Type: application&#47;json-patch+json&quot; \\<br>&gt; --request PATCH \\<br>&gt; --data &#39;[{&quot;op&quot;: &quot;add&quot;, &quot;path&quot;: &quot;&#47;status&#47;capacity&#47;nvidia.com&#47;gpu&quot;, &quot;value&quot;: &quot;1&quot;}]&#39; \\<br>&gt; http:&#47;&#47;localhost:8001&#47;api&#47;v1&#47;nodes&#47;k8s-master-01&#47;status<br>{<br>  &quot;kind&quot;: &quot;Status&quot;,<br>  &quot;apiVersion&quot;: &quot;v1&quot;,<br>  &quot;metadata&quot;: {<br><br>  },<br>  &quot;status&quot;: &quot;Failure&quot;,<br>  &quot;message&quot;: &quot;jsonpatch add operation does not apply: doc is missing path: &#47;status&#47;capacity&#47;nvidia.com&#47;gpu&quot;,<br>  &quot;code&quot;: 500<br><br>ä»€ä¹ˆåŸå› ","like_count":0},{"had_liked":false,"id":52631,"user_name":"æ™®ç½—@åºé“®","can_delete":false,"product_type":"c1","uid":1201651,"ip_address":"","ucode":"B6A9EB4019CD30","user_header":"https://static001.geekbang.org/account/avatar/00/12/55/f3/4e8fecaa.jpg","comment_is_top":false,"comment_ctime":1545458905,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1545458905","product_id":100015201,"comment_content":"ç¤¾åŒºå°±æ˜¯æ±Ÿæ¹–ï¼Œå¼€æºä¸æ˜¯å…è´¹ã€‚<br>å·®å¼‚æ€§å¦‚ä½•ä½“ç°ï¼Œlol","like_count":0},{"had_liked":false,"id":45798,"user_name":"Acter","can_delete":false,"product_type":"c1","uid":1082561,"ip_address":"","ucode":"EF747BEAD2A797","user_header":"https://static001.geekbang.org/account/avatar/00/10/84/c1/dfcad82a.jpg","comment_is_top":false,"comment_ctime":1543797805,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1543797805","product_id":100015201,"comment_content":"Redhatçš„æè®®æˆ–ç±»ä¼¼å±‚é¢çš„è§£å†³æ–¹æ¡ˆï¼Œåé¢è¿˜æœ‰å¯èƒ½æ”¯æŒå—ï¼Ÿ","like_count":0}]}