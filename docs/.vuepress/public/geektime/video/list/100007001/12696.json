{"id":12696,"title":"73 | CAT 架构设计","content":"无","comments":[{"had_liked":false,"id":176107,"user_name":"张爽","can_delete":false,"product_type":"c3","uid":1021129,"ip_address":"","ucode":"ED2969DA26E8E0","user_header":"https://static001.geekbang.org/account/avatar/00/0f/94/c9/374a69f2.jpg","comment_is_top":false,"comment_ctime":1580957941,"is_pvip":false,"replies":[{"id":68615,"content":"回复你的问题，用[bobo]标注：\n1、&#47;data&#47;{appdatas,applogs}&#47;cat是否client跟server端都需要创建?\n[bobo]：server要，client只需appdatas(不放心，client建个applogs也没关系)\n2、&#47;data&#47;appdatas&#47;cat目录下client.xml仅client端创建即可?\n[bobo]：server&#47;client都要，因为server里头也内嵌了一个client，会自检发送server内部的trace数据。\n3、&#47;data&#47;appdatas&#47;cat目录下datasources.xml仅server端创建即可?\n[bobo]：对，只有server要。\n4、&#47;data&#47;applogs&#47;cat目录仅server端才会写入日志?\n[bobo]：对，只有server写入(不放心可实际确认)\n5、http:&#47;&#47;10.1.1.1:8080&#47;cat&#47;s&#47;config?op=routerConfigUpdate  客户端路由配置的作用是什么，是否要跟client.xml里面的ip必须保持一致？\n[bobo]：为了对client进行一些动态配置(不需要一个一个去改client)，比如重新调整CAT server的地址(比如CAT扩容，维护腾挪等)。刚开始建议一致，后面可能动态调整后不一致。\n6、配置的问题\n\nclient.xml\n\n&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;\n&lt;config mode=&quot;client&quot;&gt;\n    &lt;servers&gt;\n        &lt;server ip=&quot;10.1.1.1&quot; port=&quot;2280&quot; http-port=&quot;8080&quot;&#47;&gt;\n        &lt;server ip=&quot;10.1.1.2&quot; port=&quot;2280&quot; http-port=&quot;8080&quot;&#47;&gt;\n        &lt;server ip=&quot;10.1.1.3&quot; port=&quot;2280&quot; http-port=&quot;8080&quot;&#47;&gt;\n    &lt;&#47;servers&gt;\n&lt;&#47;config&gt;\n\n客户端路由配置:\n&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;\n&lt;router-config backup-server=&quot;10.1.1.1&quot; backup-server-port=&quot;2280&quot;&gt;\n   &lt;default-server id=&quot;10.1.1.1&quot; weight=&quot;1.0&quot; port=&quot;2280&quot; enable=&quot;false&quot;&#47;&gt;\n   &lt;default-server id=&quot;10.1.1.2&quot; weight=&quot;1.0&quot; port=&quot;2280&quot; enable=&quot;true&quot;&#47;&gt;\n   &lt;default-server id=&quot;10.1.1.3&quot; weight=&quot;1.0&quot; port=&quot;2280&quot; enable=&quot;true&quot;&#47;&gt;\n   &lt;network-policy id=&quot;default&quot; title=&quot;default&quot; block=&quot;false&quot; server-group=&quot;default_group&quot;&gt;\n   &lt;&#47;network-policy&gt;\n   &lt;server-group id=&quot;default_group&quot; title=&quot;default-group&quot;&gt;\n      &lt;group-server id=&quot;10.1.1.2&quot;&#47;&gt;\n      &lt;group-server id=&quot;10.1.1.3&quot;&#47;&gt;\n   &lt;&#47;server-group&gt;\n   &lt;domain id=&quot;cat&quot;&gt;\n      &lt;group id=&quot;default&quot;&gt;\n         &lt;server id=&quot;10.1.1.2&quot; port=&quot;2280&quot; weight=&quot;1.0&quot;&#47;&gt;\n         &lt;server id=&quot;10.1.1.3&quot; port=&quot;2280&quot; weight=&quot;1.0&quot;&#47;&gt;\n      &lt;&#47;group&gt;\n   &lt;&#47;domain&gt;\n&lt;&#47;router-config&gt;\n\nenable=false表示机器不可用，10.1.1.1机器不做为消费机集群，若客户端使用10.1.1.1:2280上报数据时是否会出现问题？\n[bobo]这个动态配置生效后，client压根就不会向10.1.1.1发送trace数据。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1581172144,"ip_address":"","comment_id":176107,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"详细的看了一下cat的集群部署文档(3.0), cat的整体架构设计是client-server的模式，但文档并未详细说明各配置及目录在哪一端使用，有如下疑问\n1、&#47;data&#47;{appdatas,applogs}&#47;cat是否client跟server端都需要创建?\n2、&#47;data&#47;appdatas&#47;cat目录下client.xml仅client端创建即可?\n3、&#47;data&#47;appdatas&#47;cat目录下datasources.xml仅server端创建即可?\n4、&#47;data&#47;applogs&#47;cat目录仅server端才会写入日志?\n5、http:&#47;&#47;10.1.1.1:8080&#47;cat&#47;s&#47;config?op=routerConfigUpdate  客户端路由配置的作用是什么，是否要跟client.xml里面的ip必须保持一致？\n6、配置的问题\n\nclient.xml\n\n&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;\n&lt;config mode=&quot;client&quot;&gt;\n    &lt;servers&gt;\n        &lt;server ip=&quot;10.1.1.1&quot; port=&quot;2280&quot; http-port=&quot;8080&quot;&#47;&gt;\n        &lt;server ip=&quot;10.1.1.2&quot; port=&quot;2280&quot; http-port=&quot;8080&quot;&#47;&gt;\n        &lt;server ip=&quot;10.1.1.3&quot; port=&quot;2280&quot; http-port=&quot;8080&quot;&#47;&gt;\n    &lt;&#47;servers&gt;\n&lt;&#47;config&gt;\n\n客户端路由配置:\n&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;\n&lt;router-config backup-server=&quot;10.1.1.1&quot; backup-server-port=&quot;2280&quot;&gt;\n   &lt;default-server id=&quot;10.1.1.1&quot; weight=&quot;1.0&quot; port=&quot;2280&quot; enable=&quot;false&quot;&#47;&gt;\n   &lt;default-server id=&quot;10.1.1.2&quot; weight=&quot;1.0&quot; port=&quot;2280&quot; enable=&quot;true&quot;&#47;&gt;\n   &lt;default-server id=&quot;10.1.1.3&quot; weight=&quot;1.0&quot; port=&quot;2280&quot; enable=&quot;true&quot;&#47;&gt;\n   &lt;network-policy id=&quot;default&quot; title=&quot;default&quot; block=&quot;false&quot; server-group=&quot;default_group&quot;&gt;\n   &lt;&#47;network-policy&gt;\n   &lt;server-group id=&quot;default_group&quot; title=&quot;default-group&quot;&gt;\n      &lt;group-server id=&quot;10.1.1.2&quot;&#47;&gt;\n      &lt;group-server id=&quot;10.1.1.3&quot;&#47;&gt;\n   &lt;&#47;server-group&gt;\n   &lt;domain id=&quot;cat&quot;&gt;\n      &lt;group id=&quot;default&quot;&gt;\n         &lt;server id=&quot;10.1.1.2&quot; port=&quot;2280&quot; weight=&quot;1.0&quot;&#47;&gt;\n         &lt;server id=&quot;10.1.1.3&quot; port=&quot;2280&quot; weight=&quot;1.0&quot;&#47;&gt;\n      &lt;&#47;group&gt;\n   &lt;&#47;domain&gt;\n&lt;&#47;router-config&gt;\n\nenable=false表示机器不可用，10.1.1.1机器不做为消费机集群，若客户端使用10.1.1.1:2280上报数据时是否会出现问题？\n\n还请老师解答，谢谢","like_count":4,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":483024,"discussion_content":"回复你的问题，用[bobo]标注：\n1、/data/{appdatas,applogs}/cat是否client跟server端都需要创建?\n[bobo]：server要，client只需appdatas(不放心，client建个applogs也没关系)\n2、/data/appdatas/cat目录下client.xml仅client端创建即可?\n[bobo]：server/client都要，因为server里头也内嵌了一个client，会自检发送server内部的trace数据。\n3、/data/appdatas/cat目录下datasources.xml仅server端创建即可?\n[bobo]：对，只有server要。\n4、/data/applogs/cat目录仅server端才会写入日志?\n[bobo]：对，只有server写入(不放心可实际确认)\n5、http://10.1.1.1:8080/cat/s/config?op=routerConfigUpdate  客户端路由配置的作用是什么，是否要跟client.xml里面的ip必须保持一致？\n[bobo]：为了对client进行一些动态配置(不需要一个一个去改client)，比如重新调整CAT server的地址(比如CAT扩容，维护腾挪等)。刚开始建议一致，后面可能动态调整后不一致。\n6、配置的问题\n\nclient.xml\n\n&amp;lt;?xml version=&amp;quot;1.0&amp;quot; encoding=&amp;quot;utf-8&amp;quot;?&amp;gt;\n&amp;lt;config mode=&amp;quot;client&amp;quot;&amp;gt;\n    &amp;lt;servers&amp;gt;\n        &amp;lt;server ip=&amp;quot;10.1.1.1&amp;quot; port=&amp;quot;2280&amp;quot; http-port=&amp;quot;8080&amp;quot;/&amp;gt;\n        &amp;lt;server ip=&amp;quot;10.1.1.2&amp;quot; port=&amp;quot;2280&amp;quot; http-port=&amp;quot;8080&amp;quot;/&amp;gt;\n        &amp;lt;server ip=&amp;quot;10.1.1.3&amp;quot; port=&amp;quot;2280&amp;quot; http-port=&amp;quot;8080&amp;quot;/&amp;gt;\n    &amp;lt;/servers&amp;gt;\n&amp;lt;/config&amp;gt;\n\n客户端路由配置:\n&amp;lt;?xml version=&amp;quot;1.0&amp;quot; encoding=&amp;quot;utf-8&amp;quot;?&amp;gt;\n&amp;lt;router-config backup-server=&amp;quot;10.1.1.1&amp;quot; backup-server-port=&amp;quot;2280&amp;quot;&amp;gt;\n   &amp;lt;default-server id=&amp;quot;10.1.1.1&amp;quot; weight=&amp;quot;1.0&amp;quot; port=&amp;quot;2280&amp;quot; enable=&amp;quot;false&amp;quot;/&amp;gt;\n   &amp;lt;default-server id=&amp;quot;10.1.1.2&amp;quot; weight=&amp;quot;1.0&amp;quot; port=&amp;quot;2280&amp;quot; enable=&amp;quot;true&amp;quot;/&amp;gt;\n   &amp;lt;default-server id=&amp;quot;10.1.1.3&","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581172144,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":32833,"user_name":"superfq","can_delete":false,"product_type":"c3","uid":1033472,"ip_address":"","ucode":"37B45E9018F14F","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c5/00/37ef050e.jpg","comment_is_top":false,"comment_ctime":1539700509,"is_pvip":false,"replies":[{"id":12668,"content":"cat本身设计是侵入式的，侵入有利有弊，性能会更好，要改代码是弊。实践中尽量在框架层埋点，让集中框架团队埋好，对业务团队尽量透明，一般业务研发基本不用埋点。另外可以对cat客户端做AOP封装(如spring），SPI封装（可参考apollo做法），也可减少侵入性。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1540734150,"ip_address":"","comment_id":32833,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"请教老师，从最后的demo代码来看cat是严重代码侵入的，这样的业务代码中会混入很多cat代码，请问老师使用cat有没有什么最佳实践能够尽可能少的侵入业务代码？","like_count":2,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426898,"discussion_content":"cat本身设计是侵入式的，侵入有利有弊，性能会更好，要改代码是弊。实践中尽量在框架层埋点，让集中框架团队埋好，对业务团队尽量透明，一般业务研发基本不用埋点。另外可以对cat客户端做AOP封装(如spring），SPI封装（可参考apollo做法），也可减少侵入性。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1540734150,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":23636,"user_name":"高峰","can_delete":false,"product_type":"c3","uid":1046111,"ip_address":"","ucode":"2DFE77FE4970B8","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f6/5f/85e82813.jpg","comment_is_top":false,"comment_ctime":1536561694,"is_pvip":false,"replies":[{"id":9654,"content":"未听说cat和spring里头事务有冲突说法，你用cat的try catch埋点后，具体异常仍可向外抛出，让spring事务rollback机制生效","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1537683616,"ip_address":"","comment_id":23636,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"请教老师，如果添加cat代码到 业务代码中  和spring 里面调用数据库 事务有冲突么？  如果直接加try catch 出现异常可能不会rollback 。  还是说cat 代码在 spring mvc controller 加？","like_count":2,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":423652,"discussion_content":"未听说cat和spring里头事务有冲突说法，你用cat的try catch埋点后，具体异常仍可向外抛出，让spring事务rollback机制生效","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1537683616,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":136047,"user_name":"在路上","can_delete":false,"product_type":"c3","uid":1205712,"ip_address":"","ucode":"18337C6DD5E618","user_header":"https://static001.geekbang.org/account/avatar/00/12/65/d0/b5b00bc2.jpg","comment_is_top":false,"comment_ctime":1569335777,"is_pvip":false,"replies":[{"id":52261,"content":"这个每家公司不同，看你的资源富裕情况和审计要求，短的放两周或一个月，长的可放三个月甚至半年以上的。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1569416265,"ip_address":"","comment_id":136047,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"老师，原始的监控信息存储在HDFS中，数据的有效期一般设置多少合适呢？","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":468432,"discussion_content":"这个每家公司不同，看你的资源富裕情况和审计要求，短的放两周或一个月，长的可放三个月甚至半年以上的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1569416265,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":51264,"user_name":"王盛武","can_delete":false,"product_type":"c3","uid":1182516,"ip_address":"","ucode":"DE7EF246D3DCE8","user_header":"https://static001.geekbang.org/account/avatar/00/12/0b/34/f41d73a4.jpg","comment_is_top":false,"comment_ctime":1545143886,"is_pvip":false,"replies":[{"id":18698,"content":"CAT客户端trace缓存在内存中，以一定周期（秒级）向服务器发送，如系统重启，可能很少量丢数据，但完全不丢数据不是CAT（包括其它监控系统）首要设计目标，少量数据的偶尔丢失，并不影响统计趋势性监控。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1545223557,"ip_address":"","comment_id":51264,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"文中提到   queue里的数据是通过 send线程发送到cat服务器端；\n如果重启系统，  那还没来得及消费的queue里的跟踪数据是否丢失了呢？\ncat是否有本地文件系统存储未上报的数据？","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433371,"discussion_content":"CAT客户端trace缓存在内存中，以一定周期（秒级）向服务器发送，如系统重启，可能很少量丢数据，但完全不丢数据不是CAT（包括其它监控系统）首要设计目标，少量数据的偶尔丢失，并不影响统计趋势性监控。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545223557,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":27002,"user_name":"Single","can_delete":false,"product_type":"c3","uid":1163455,"ip_address":"","ucode":"0FF03512CE2F27","user_header":"https://static001.geekbang.org/account/avatar/00/11/c0/bf/9d6f3645.jpg","comment_is_top":false,"comment_ctime":1537795829,"is_pvip":false,"replies":[{"id":10674,"content":"可以，属于异步调用，相当于跨进程调用，需要在线程间传递调用链上下文context。这种调用链呈现比较复杂，线程之间没有明确时序关系，一般不建议。调用链监控主要适用于同步调用场景。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1538480725,"ip_address":"","comment_id":27002,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"请教老师，客户端埋点时，主线程起了子线程，子线程里的调用能否正常上报，并和主线程调用链连起来呢？","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":424781,"discussion_content":"可以，属于异步调用，相当于跨进程调用，需要在线程间传递调用链上下文context。这种调用链呈现比较复杂，线程之间没有明确时序关系，一般不建议。调用链监控主要适用于同步调用场景。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1538480725,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}