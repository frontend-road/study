{"id":103951,"title":"19 | OpenResty çš„æ ¸å¿ƒå’Œç²¾é«“ï¼šcosocket","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯æ¸©é“­ï¼Œä»Šå¤©æˆ‘ä»¬æ¥å­¦ä¹ ä¸‹ OpenResty ä¸­çš„æ ¸å¿ƒæŠ€æœ¯ï¼šcosocketã€‚</p><p>å…¶å®åœ¨å‰é¢çš„è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°±å·²ç»å¤šæ¬¡æåˆ°è¿‡å®ƒäº†ï¼Œcosocket æ˜¯å„ç§ <code>lua-resty-*</code> éé˜»å¡åº“çš„åŸºç¡€ï¼Œæ²¡æœ‰ cosocketï¼Œå¼€å‘è€…å°±æ— æ³•ç”¨ Lua æ¥å¿«é€Ÿè¿æ¥å„ç§å¤–éƒ¨çš„ç½‘ç»œæœåŠ¡ã€‚</p><p>åœ¨æ—©æœŸçš„ OpenResty ç‰ˆæœ¬ä¸­ï¼Œå¦‚æœä½ æƒ³è¦å»ä¸ Redisã€memcached è¿™äº›æœåŠ¡äº¤äº’çš„è¯ï¼Œéœ€è¦ä½¿ç”¨ <code>redis2-nginx-module</code>ã€<code>redis-nginx-module</code> å’Œ <code>memc-nginx-module</code>è¿™äº› C æ¨¡å—.è¿™äº›æ¨¡å—è‡³ä»Šä»ç„¶åœ¨ OpenResty çš„å‘è¡ŒåŒ…ä¸­ã€‚</p><p>ä¸è¿‡ï¼Œcosocket åŠŸèƒ½åŠ å…¥ä»¥åï¼Œå®ƒä»¬éƒ½å·²ç»è¢« <code>lua-resty-redis</code> å’Œ <code>lua-resty-memcached</code> æ›¿ä»£ï¼ŒåŸºæœ¬ä¸Šæ²¡äººå†å»ä½¿ç”¨ C æ¨¡å—è¿æ¥å¤–éƒ¨æœåŠ¡äº†ã€‚</p><h2>ä»€ä¹ˆæ˜¯ cosocketï¼Ÿ</h2><p>é‚£ç©¶ç«Ÿä»€ä¹ˆæ˜¯cosocket å‘¢ï¼Ÿäº‹å®ä¸Šï¼Œcosocketæ˜¯ OpenResty ä¸­çš„ä¸“æœ‰åè¯ï¼Œæ˜¯æŠŠåç¨‹å’Œç½‘ç»œå¥—æ¥å­—çš„è‹±æ–‡æ‹¼åœ¨ä¸€èµ·å½¢æˆçš„ï¼Œå³ cosocket = coroutine + socketã€‚æ‰€ä»¥ï¼Œä½ å¯ä»¥æŠŠ cosocket ç¿»è¯‘ä¸ºâ€œåç¨‹å¥—æ¥å­—â€ã€‚</p><p>cosocket ä¸ä»…éœ€è¦ Lua åç¨‹ç‰¹æ€§çš„æ”¯æŒï¼Œä¹Ÿéœ€è¦ Nginx ä¸­éå¸¸é‡è¦çš„äº‹ä»¶æœºåˆ¶çš„æ”¯æŒï¼Œè¿™ä¸¤è€…ç»“åˆåœ¨ä¸€èµ·ï¼Œæœ€ç»ˆå®ç°äº†éé˜»å¡ç½‘ç»œ I/Oã€‚å¦å¤–ï¼Œcosocket æ”¯æŒ TCPã€UDP å’Œ Unix Domain Socketã€‚</p><!-- [[[read_end]]] --><p>å¦‚æœæˆ‘ä»¬åœ¨ OpenResty ä¸­è°ƒç”¨ä¸€ä¸ª cosocket ç›¸å…³å‡½æ•°ï¼Œå†…éƒ¨å®ç°ä¾¿æ˜¯ä¸‹é¢è¿™å¼ å›¾çš„æ ·å­ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/80/06/80d16e11d2750d6e4127445c126c9f06.png?wh=1692*756\" alt=\"\"></p><p>è®°æ€§æ¯”è¾ƒå¥½çš„åŒå­¦åº”è¯¥å‘ç°äº†ï¼Œåœ¨å‰é¢ OpenResty åŸç†å’ŒåŸºæœ¬æ¦‚å¿µçš„é‚£èŠ‚è¯¾é‡Œï¼Œæˆ‘ä¹Ÿç”¨è¿‡è¿™å¼ å›¾ã€‚ä»å›¾ä¸­ä½ å¯ä»¥çœ‹åˆ°ï¼Œç”¨æˆ·çš„ Lua è„šæœ¬æ¯è§¦å‘ä¸€ä¸ªç½‘ç»œæ“ä½œï¼Œéƒ½ä¼šæœ‰åç¨‹çš„ yield ä»¥åŠ resumeã€‚</p><p>é‡åˆ°ç½‘ç»œ I/O æ—¶ï¼Œå®ƒä¼šäº¤å‡ºæ§åˆ¶æƒï¼ˆyieldï¼‰ï¼ŒæŠŠç½‘ç»œäº‹ä»¶æ³¨å†Œåˆ° Nginx ç›‘å¬åˆ—è¡¨ä¸­ï¼Œå¹¶æŠŠæƒé™äº¤ç»™ Nginxï¼›å½“æœ‰ Nginx äº‹ä»¶è¾¾åˆ°è§¦å‘æ¡ä»¶æ—¶ï¼Œä¾¿å”¤é†’å¯¹åº”çš„åç¨‹ç»§ç»­å¤„ç†ï¼ˆresumeï¼‰ã€‚</p><p>OpenResty æ­£æ˜¯ä»¥æ­¤ä¸ºè“å›¾ï¼Œå°è£…å®ç° connectã€sendã€receive ç­‰æ“ä½œï¼Œå½¢æˆäº†æˆ‘ä»¬å¦‚ä»Šè§åˆ°çš„ cosocket APIã€‚ä¸‹é¢ï¼Œæˆ‘å°±ä»¥å¤„ç† TCP çš„ API ä¸ºä¾‹æ¥ä»‹ç»ä¸€ä¸‹ã€‚å¤„ç† UDP å’Œ Unix Domain Socket ï¼Œä¸TCP çš„æ¥å£åŸºæœ¬æ˜¯ä¸€æ ·çš„ã€‚</p><h2>cosocket API å’ŒæŒ‡ä»¤ç®€ä»‹</h2><p>TCP ç›¸å…³çš„ cosocket API å¯ä»¥åˆ†ä¸ºä¸‹é¢è¿™å‡ ç±»ã€‚</p><ul>\n<li>åˆ›å»ºå¯¹è±¡ï¼šngx.socket.tcpã€‚</li>\n<li>è®¾ç½®è¶…æ—¶ï¼štcpsock:settimeout å’Œ tcpsock:settimeoutsã€‚</li>\n<li>å»ºç«‹è¿æ¥ï¼štcpsock:connectã€‚</li>\n<li>å‘é€æ•°æ®ï¼štcpsock:sendã€‚</li>\n<li>æ¥å—æ•°æ®ï¼štcpsock:receiveã€tcpsock:receiveany å’Œ tcpsock:receiveuntilã€‚</li>\n<li>è¿æ¥æ± ï¼štcpsock:setkeepaliveã€‚</li>\n<li>å…³é—­è¿æ¥ï¼štcpsock:closeã€‚</li>\n</ul><p>æˆ‘ä»¬è¿˜è¦ç‰¹åˆ«æ³¨æ„ä¸‹ï¼Œè¿™äº› API å¯ä»¥ä½¿ç”¨çš„ä¸Šä¸‹æ–‡ï¼š</p><pre><code>rewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*_\n</code></pre><p>è¿™é‡Œæˆ‘è¿˜è¦å¼ºè°ƒä¸€ç‚¹ï¼Œå½’å’äº Nginx å†…æ ¸çš„å„ç§é™åˆ¶ï¼Œcosocket API åœ¨ <code>set_by_lua*</code>ï¼Œ <code>log_by_lua*</code>ï¼Œ <code>header_filter_by_lua*</code> å’Œ <code>body_filter_by_lua*</code> ä¸­æ˜¯æ— æ³•ä½¿ç”¨çš„ã€‚è€Œåœ¨ <code>init_by_lua*</code> å’Œ <code>init_worker_by_lua*</code> ä¸­æš‚æ—¶ä¹Ÿä¸èƒ½ç”¨ï¼Œä¸è¿‡ Nginx å†…æ ¸å¯¹è¿™ä¸¤ä¸ªé˜¶æ®µå¹¶æ²¡æœ‰é™åˆ¶ï¼Œåé¢å¯ä»¥å¢åŠ å¯¹è¿™å®ƒä»¬çš„æ”¯æŒã€‚</p><p>æ­¤å¤–ï¼Œä¸è¿™äº› API ç›¸å…³çš„ï¼Œè¿˜æœ‰ 8 ä¸ª <code>lua_socket_</code> å¼€å¤´çš„ Nginx æŒ‡ä»¤ï¼Œæˆ‘ä»¬ç®€å•æ¥çœ‹ä¸€ä¸‹ã€‚</p><ul>\n<li><code>lua_socket_connect_timeout</code>ï¼šè¿æ¥è¶…æ—¶ï¼Œé»˜è®¤ 60 ç§’ã€‚</li>\n<li><code>lua_socket_send_timeout</code>ï¼šå‘é€è¶…æ—¶ï¼Œé»˜è®¤ 60 ç§’ã€‚</li>\n<li><code>lua_socket_send_lowat</code>ï¼šå‘é€é˜ˆå€¼ï¼ˆlow waterï¼‰ï¼Œé»˜è®¤ä¸º 0ã€‚</li>\n<li><code>lua_socket_read_timeout</code>ï¼š è¯»å–è¶…æ—¶ï¼Œé»˜è®¤ 60 ç§’ã€‚</li>\n<li><code>lua_socket_buffer_size</code>ï¼šè¯»å–æ•°æ®çš„ç¼“å­˜åŒºå¤§å°ï¼Œé»˜è®¤ 4k/8kã€‚</li>\n<li><code>lua_socket_pool_size</code>ï¼šè¿æ¥æ± å¤§å°ï¼Œé»˜è®¤ 30ã€‚</li>\n<li><code>lua_socket_keepalive_timeout</code>ï¼šè¿æ¥æ±  cosocket å¯¹è±¡çš„ç©ºé—²æ—¶é—´ï¼Œé»˜è®¤ 60 ç§’ã€‚</li>\n<li><code>lua_socket_log_errors</code>ï¼šcosocket å‘ç”Ÿé”™è¯¯æ—¶ï¼Œæ˜¯å¦è®°å½•æ—¥å¿—ï¼Œé»˜è®¤ä¸º onã€‚</li>\n</ul><p>è¿™é‡Œä½ ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œæœ‰äº›æŒ‡ä»¤å’Œ API çš„åŠŸèƒ½ä¸€æ ·çš„ï¼Œæ¯”å¦‚è®¾ç½®è¶…æ—¶æ—¶é—´å’Œè¿æ¥æ± å¤§å°ç­‰ã€‚ä¸è¿‡ï¼Œå¦‚æœä¸¤è€…æœ‰å†²çªçš„è¯ï¼ŒAPI çš„ä¼˜å…ˆçº§é«˜äºæŒ‡ä»¤ï¼Œä¼šè¦†ç›–æŒ‡ä»¤è®¾ç½®çš„å€¼ã€‚æ‰€ä»¥ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬éƒ½æ¨èä½¿ç”¨ API æ¥åšè®¾ç½®ï¼Œè¿™æ ·ä¹Ÿä¼šæ›´åŠ çµæ´»ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸€ä¸ªå…·ä½“çš„ä¾‹å­ï¼Œå¼„æ˜ç™½åˆ°åº•å¦‚ä½•ä½¿ç”¨è¿™äº› cosocket APIã€‚ä¸‹é¢è¿™æ®µä»£ç çš„åŠŸèƒ½å¾ˆç®€å•ï¼Œæ˜¯å‘é€ TCP è¯·æ±‚åˆ°ä¸€ä¸ªç½‘ç«™ï¼Œå¹¶æŠŠè¿”å›çš„å†…å®¹æ‰“å°å‡ºæ¥ï¼š</p><pre><code>$ resty -e 'local sock = ngx.socket.tcp()\n        sock:settimeout(1000)  -- one second timeout\n        local ok, err = sock:connect(&quot;www.baidu.com&quot;, 80)\n        if not ok then\n            ngx.say(&quot;failed to connect: &quot;, err)\n            return\n        end\n\n        local req_data = &quot;GET / HTTP/1.1\\r\\nHost: www.baidu.com\\r\\n\\r\\n&quot;\n        local bytes, err = sock:send(req_data)\n        if err then\n            ngx.say(&quot;failed to send: &quot;, err)\n            return\n        end\n\n        local data, err, partial = sock:receive()\n        if err then\n            ngx.say(&quot;failed to receive: &quot;, err)\n            return\n        end\n\n        sock:close()\n        ngx.say(&quot;response is: &quot;, data)'\n</code></pre><p>æˆ‘ä»¬æ¥å…·ä½“åˆ†æä¸‹è¿™æ®µä»£ç ã€‚</p><ul>\n<li>é¦–å…ˆï¼Œé€šè¿‡ <code>ngx.socket.tcp()</code> ï¼Œåˆ›å»º  TCP çš„ cosocket å¯¹è±¡ï¼Œåå­—æ˜¯ sockã€‚</li>\n<li>ç„¶åï¼Œä½¿ç”¨ <code>settimeout()</code> ï¼ŒæŠŠè¶…æ—¶æ—¶é—´è®¾ç½®ä¸º 1 ç§’ã€‚æ³¨æ„è¿™é‡Œçš„è¶…æ—¶æ²¡æœ‰åŒºåˆ† connectã€receiveï¼Œæ˜¯ç»Ÿä¸€çš„è®¾ç½®ã€‚</li>\n<li>æ¥ç€ï¼Œä½¿ç”¨ <code>connect()</code> å»è¿æ¥æŒ‡å®šç½‘ç«™çš„ 80 ç«¯å£ï¼Œå¦‚æœå¤±è´¥å°±ç›´æ¥é€€å‡ºã€‚</li>\n<li>è¿æ¥æˆåŠŸçš„è¯ï¼Œå°±ä½¿ç”¨ <code>send()</code> æ¥å‘é€æ„é€ å¥½çš„æ•°æ®ï¼Œå¦‚æœå‘é€å¤±è´¥å°±é€€å‡ºã€‚</li>\n<li>å‘é€æ•°æ®æˆåŠŸçš„è¯ï¼Œå°±ä½¿ç”¨ <code>receive()</code> æ¥æ¥æ”¶ç½‘ç«™è¿”å›çš„æ•°æ®ã€‚è¿™é‡Œ <code>receive()</code> çš„é»˜è®¤å‚æ•°å€¼æ˜¯ <code>*l</code>ï¼Œä¹Ÿå°±æ˜¯åªè¿”å›ç¬¬ä¸€è¡Œçš„æ•°æ®ï¼›å¦‚æœå‚æ•°è®¾ç½®ä¸ºäº†<code>*a</code>ï¼Œå°±æ˜¯æŒç»­æ¥æ”¶æ•°æ®ï¼Œç›´åˆ°è¿æ¥å…³é—­ï¼›</li>\n<li>æœ€åï¼Œè°ƒç”¨ <code>close()</code> ï¼Œä¸»åŠ¨å…³é—­ socket è¿æ¥ã€‚</li>\n</ul><p>ä½ çœ‹ï¼ŒçŸ­çŸ­å‡ æ­¥å°±å¯ä»¥å®Œæˆï¼Œä½¿ç”¨ cosocket API æ¥åšç½‘ç»œé€šä¿¡ï¼Œå°±æ˜¯è¿™ä¹ˆç®€å•ã€‚ä¸è¿‡ï¼Œä¸èƒ½æ»¡è¶³äºæ­¤ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯¹è¿™ä¸ªç¤ºä¾‹å†åšä¸€äº›è°ƒæ•´ã€‚</p><p><strong>ç¬¬ä¸€ä¸ªåŠ¨ä½œï¼Œå¯¹ socket è¿æ¥ã€å‘é€å’Œè¯»å–è¿™ä¸‰ä¸ªåŠ¨ä½œï¼Œåˆ†åˆ«è®¾ç½®è¶…æ—¶æ—¶é—´ã€‚</strong></p><p>æˆ‘ä»¬åˆšåˆšç”¨çš„<code>settimeout()</code> ï¼Œä½œç”¨æ˜¯æŠŠè¶…æ—¶æ—¶é—´ç»Ÿä¸€è®¾ç½®ä¸ºä¸€ä¸ªå€¼ã€‚å¦‚æœè¦æƒ³åˆ†å¼€è®¾ç½®ï¼Œå°±éœ€è¦ä½¿ç”¨ <code>settimeouts()</code> å‡½æ•°ï¼Œæ¯”å¦‚ä¸‹é¢è¿™æ ·çš„å†™æ³•ï¼š</p><pre><code>sock:settimeouts(1000, 2000, 3000) \n</code></pre><p>è¿™è¡Œä»£ç è¡¨ç¤ºè¿æ¥è¶…æ—¶ä¸º 1 ç§’ï¼Œå‘é€è¶…æ—¶ä¸º 2 ç§’ï¼Œè¯»å–è¶…æ—¶ä¸º 3 ç§’ã€‚</p><p>åœ¨OpenResty å’Œ lua-resty åº“ä¸­ï¼Œå¤§éƒ¨åˆ†å’Œæ—¶é—´ç›¸å…³çš„ API çš„å‚æ•°ï¼Œéƒ½ä»¥æ¯«ç§’ä¸ºå•ä½ï¼Œä½†ä¹Ÿæœ‰ä¾‹å¤–ï¼Œéœ€è¦ä½ åœ¨è°ƒç”¨çš„æ—¶å€™ç‰¹åˆ«æ³¨æ„ä¸‹ã€‚</p><p><strong>ç¬¬äºŒä¸ªåŠ¨ä½œï¼Œreceiveæ¥æ”¶æŒ‡å®šå¤§å°çš„å†…å®¹ã€‚</strong></p><p>åˆšåˆšè¯´äº†ï¼Œ<code>receive()</code> æ¥å£å¯ä»¥æ¥æ”¶ä¸€è¡Œæ•°æ®ï¼Œä¹Ÿå¯ä»¥æŒç»­æ¥æ”¶æ•°æ®ã€‚ä¸è¿‡ï¼Œå¦‚æœä½ åªæƒ³æ¥æ”¶ 10K å¤§å°çš„æ•°æ®ï¼Œåº”è¯¥æ€ä¹ˆè®¾ç½®å‘¢ï¼Ÿ</p><p>è¿™æ—¶ï¼Œ<code>receiveany()</code> é—ªäº®ç™»åœºã€‚å®ƒå°±æ˜¯ä¸“ä¸ºæ»¡è¶³è¿™ç§éœ€æ±‚è€Œè®¾è®¡çš„ï¼Œä¸€èµ·æ¥çœ‹ä¸‹é¢è¿™è¡Œä»£ç ï¼š</p><pre><code>local data, err, partial = sock:receiveany(10240)\n</code></pre><p>è¿™æ®µä»£ç å°±è¡¨ç¤ºï¼Œæœ€å¤šåªæ¥æ”¶ 10K çš„æ•°æ®ã€‚</p><p>å½“ç„¶ï¼Œå…³äºreceiveï¼Œè¿˜æœ‰å¦ä¸€ä¸ªå¾ˆå¸¸è§çš„ç”¨æˆ·éœ€æ±‚ï¼Œé‚£å°±æ˜¯ä¸€ç›´è·å–æ•°æ®ï¼Œç›´åˆ°é‡åˆ°æŒ‡å®šå­—ç¬¦ä¸²æ‰åœæ­¢ã€‚</p><p><code>receiveuntil()</code> ä¸“é—¨ç”¨æ¥è§£å†³è¿™ç±»é—®é¢˜ï¼Œå®ƒä¸ä¼šåƒ <code>receive()</code> å’Œ <code>receiveany()</code> ä¸€æ ·è¿”å›å­—ç¬¦ä¸²ï¼Œè€Œä¼šè¿”å›ä¸€ä¸ªè¿­ä»£å™¨ã€‚è¿™æ ·ï¼Œä½ å°±å¯ä»¥åœ¨å¾ªç¯ä¸­è°ƒç”¨å®ƒæ¥åˆ†æ®µè¯»å–åŒ¹é…åˆ°çš„æ•°æ®ï¼Œå½“è¯»å–å®Œæ¯•æ—¶ï¼Œå°±ä¼šè¿”å› nilã€‚ä¸‹é¢å°±æ˜¯ä¸€ä¸ªä¾‹å­ï¼š</p><pre><code> local reader = sock:receiveuntil(&quot;\\r\\n&quot;)\n\n while true do\n     local data, err, partial = reader(4)\n     if not data then\n         if err then\n             ngx.say(&quot;failed to read the data stream: &quot;, err)\n             break\n         end\n\n         ngx.say(&quot;read done&quot;)\n         break\n     end\n     ngx.say(&quot;read chunk: [&quot;, data, &quot;]&quot;)\n end\n</code></pre><p>è¿™æ®µä»£ç ä¸­çš„ <code>receiveuntil</code> ä¼šè¿”å› <code>\\r\\n</code> ä¹‹å‰çš„æ•°æ®ï¼Œå¹¶é€šè¿‡è¿­ä»£å™¨æ¯æ¬¡è¯»å–å…¶ä¸­çš„ 4 ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±å®ç°äº†æˆ‘ä»¬æƒ³è¦çš„åŠŸèƒ½ã€‚</p><p><strong>ç¬¬ä¸‰ä¸ªåŠ¨ä½œï¼Œä¸ç›´æ¥å…³é—­ socketï¼Œè€Œæ˜¯æ”¾å…¥è¿æ¥æ± ä¸­ã€‚</strong></p><p>æˆ‘ä»¬çŸ¥é“ï¼Œæ²¡æœ‰è¿æ¥æ± çš„è¯ï¼Œæ¯æ¬¡è¯·æ±‚è¿›æ¥éƒ½è¦æ–°å»ºä¸€ä¸ªè¿æ¥ï¼Œå°±ä¼šå¯¼è‡´ cosocket å¯¹è±¡è¢«é¢‘ç¹åœ°åˆ›å»ºå’Œé”€æ¯ï¼Œé€ æˆä¸å¿…è¦çš„æ€§èƒ½æŸè€—ã€‚</p><p>ä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜ï¼Œåœ¨ä½ ä½¿ç”¨å®Œä¸€ä¸ª cosocket åï¼Œå¯ä»¥è°ƒç”¨ <code>setkeepalive()</code> æ”¾åˆ°è¿æ¥æ± ä¸­ï¼Œæ¯”å¦‚ä¸‹é¢è¿™æ ·çš„å†™æ³•ï¼š</p><pre><code>local ok, err = sock:setkeepalive(2 * 1000, 100)\nif not ok then\n    ngx.say(&quot;failed to set reusable: &quot;, err)\nend\n</code></pre><p>è¿™æ®µä»£ç è®¾ç½®äº†è¿æ¥çš„ç©ºé—²æ—¶é—´ä¸º 2 ç§’ï¼Œè¿æ¥æ± çš„å¤§å°ä¸º 100ã€‚è¿™æ ·ï¼Œåœ¨è°ƒç”¨ <code>connect()</code> å‡½æ•°æ—¶ï¼Œå°±ä¼šä¼˜å…ˆä»è¿æ¥æ± ä¸­è·å– cosocket å¯¹è±¡ã€‚</p><p>ä¸è¿‡ï¼Œå…³äºè¿æ¥æ± çš„ä½¿ç”¨ï¼Œæœ‰ä¸¤ç‚¹éœ€è¦æˆ‘ä»¬æ³¨æ„ä¸€ä¸‹ã€‚</p><ul>\n<li>ç¬¬ä¸€ï¼Œä¸èƒ½æŠŠå‘ç”Ÿé”™è¯¯çš„è¿æ¥æ”¾å…¥è¿æ¥æ± ï¼Œå¦åˆ™ä¸‹æ¬¡ä½¿ç”¨æ—¶ï¼Œå°±ä¼šå¯¼è‡´æ”¶å‘æ•°æ®å¤±è´¥ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦åˆ¤æ–­æ¯ä¸€ä¸ª API è°ƒç”¨æ˜¯å¦æˆåŠŸçš„ä¸€ä¸ªåŸå› ã€‚</li>\n<li>ç¬¬äºŒï¼Œè¦ææ¸…æ¥šè¿æ¥çš„æ•°é‡ã€‚è¿æ¥æ± æ˜¯ worker çº§åˆ«çš„ï¼Œæ¯ä¸ª worker éƒ½æœ‰è‡ªå·±çš„è¿æ¥æ± ã€‚æ‰€ä»¥ï¼Œå¦‚æœä½ æœ‰ 10 ä¸ª workerï¼Œè¿æ¥æ± å¤§å°è®¾ç½®ä¸º 30ï¼Œé‚£ä¹ˆå¯¹äºåç«¯çš„æœåŠ¡æ¥è®²ï¼Œå°±ç­‰äºæœ‰ 300 ä¸ªè¿æ¥ã€‚</li>\n</ul><h2>å†™åœ¨æœ€å</h2><p>æ€»ç»“ä¸€ä¸‹ï¼Œä»Šå¤©æˆ‘ä»¬å­¦ä¹ äº†cosocket çš„åŸºæœ¬æ¦‚å¿µï¼Œä»¥åŠç›¸å…³çš„æŒ‡ä»¤å’Œ APIï¼Œå¹¶é€šè¿‡ä¸€ä¸ªå®é™…çš„ä¾‹å­ï¼Œç†Ÿæ‚‰äº†TCP ç›¸å…³çš„ API åº”è¯¥å¦‚ä½•ä½¿ç”¨ã€‚è€ŒUDP å’Œ Unix Domain Socketçš„ä½¿ç”¨ç±»ä¼¼äºTCPï¼Œå¼„æ˜ç™½ä»Šå¤©æ‰€å­¦ï¼Œä½ åŸºæœ¬ä¸Šéƒ½èƒ½è¿åˆƒè€Œè§£äº†ã€‚</p><p>ä»ä¸­ä½ åº”è¯¥ä¹Ÿèƒ½æ„Ÿå—åˆ°ï¼Œcosocket ç”¨èµ·æ¥è¿˜æ˜¯æ¯”è¾ƒå®¹æ˜“ä¸Šæ‰‹çš„ï¼Œè€Œä¸”ç”¨å¥½å®ƒï¼Œä½ å°±å¯ä»¥å»è¿æ¥å„ç§å¤–éƒ¨çš„æœåŠ¡äº†ï¼Œå¯ä»¥è¯´æ˜¯ç»™ OpenResty æ’ä¸Šäº†æƒ³è±¡çš„ç¿…è†€ã€‚</p><p>æœ€åï¼Œç»™ä½ ç•™ä¸¤ä¸ªä½œä¸šé¢˜ã€‚</p><p>ç¬¬ä¸€é—®ï¼Œåœ¨ä»Šå¤©çš„ä¾‹å­ä¸­ï¼Œ<code>tcpsock:send</code> å‘é€çš„æ˜¯å­—ç¬¦ä¸²ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦å‘é€ä¸€ä¸ªç”±å­—ç¬¦ä¸²æ„æˆçš„ tableï¼Œåˆè¯¥æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿ</p><p>ç¬¬äºŒé—®ï¼Œä½ ä¹Ÿçœ‹åˆ°äº†ï¼Œcosocket åœ¨å¾ˆå¤šé˜¶æ®µä¸­ä¸èƒ½ä½¿ç”¨ï¼Œé‚£ä¹ˆï¼Œä½ èƒ½å¦æƒ³åˆ°ä¸€äº›ç»•è¿‡çš„æ–¹å¼å‘¢ï¼Ÿ</p><p>æ¬¢è¿ç•™è¨€å’Œæˆ‘åˆ†äº«ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™ç¯‡æ–‡ç« åˆ†äº«ç»™ä½ çš„åŒäº‹ã€æœ‹å‹ï¼Œæˆ‘ä»¬ä¸€èµ·äº¤æµï¼Œä¸€èµ·è¿›æ­¥ã€‚</p><p></p>","neighbors":{"left":{"article_title":"18 | workeré—´çš„é€šä¿¡æ³•å®ï¼šæœ€é‡è¦çš„æ•°æ®ç»“æ„ä¹‹shared dict","id":103950},"right":{"article_title":"20 | è¶…è¶Š Web æœåŠ¡å™¨ï¼šç‰¹æƒè¿›ç¨‹å’Œå®šæ—¶ä»»åŠ¡","id":104939}},"comments":[{"had_liked":false,"id":111366,"user_name":"HelloBug","can_delete":false,"product_type":"c1","uid":1249598,"ip_address":"","ucode":"E61A4AD5C2F724","user_header":"https://static001.geekbang.org/account/avatar/00/13/11/3e/925aa996.jpg","comment_is_top":false,"comment_ctime":1562548185,"is_pvip":true,"replies":[{"id":"40863","content":"ç¬¬äºŒä¸ªç­”æ¡ˆæ˜¯å¯¹çš„ã€‚ç¬¬ä¸€ä¸ªç¡®å®æ˜¯å¯ä»¥çš„ï¼Œä½†å¹¶éæœ€å¥½çš„æ–¹æ¡ˆï¼Œsend å‡½æ•°ä¸ä»…æ”¯æŒå­—ç¬¦ä¸²ï¼Œè¿˜æ”¯æŒ tableï¼Œè¿™ä¹Ÿæ˜¯éšè—çš„ä¼˜åŒ–ç‚¹ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1562723702,"ip_address":"","comment_id":111366,"utype":1}],"discussion_count":2,"race_medal":0,"score":"31627319257","product_id":100028301,"comment_content":"é—®é¢˜ä¸€ï¼šå°†è¡¨æ ¼åˆ©ç”¨cjsonè¿›è¡Œåºåˆ—åŒ–ä¹‹åå‘é€<br>é—®é¢˜äºŒï¼šé€šè¿‡è®¾ç½®å®šæ—¶å™¨ï¼Œåœ¨ä¸èƒ½ä½¿ç”¨cosocketçš„é˜¶æ®µä½¿ç”¨","like_count":7,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457320,"discussion_content":"ç¬¬äºŒä¸ªç­”æ¡ˆæ˜¯å¯¹çš„ã€‚ç¬¬ä¸€ä¸ªç¡®å®æ˜¯å¯ä»¥çš„ï¼Œä½†å¹¶éæœ€å¥½çš„æ–¹æ¡ˆï¼Œsend å‡½æ•°ä¸ä»…æ”¯æŒå­—ç¬¦ä¸²ï¼Œè¿˜æ”¯æŒ tableï¼Œè¿™ä¹Ÿæ˜¯éšè—çš„ä¼˜åŒ–ç‚¹ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562723702,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1490007,"avatar":"https://static001.geekbang.org/account/avatar/00/16/bc/57/e66d8571.jpg","nickname":"katichar","note":"","ucode":"22736911F30E2C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1602,"discussion_content":"cocos2dx-luaä¸­ç”¨çš„æ˜¯luasocket,sendåªèƒ½æ˜¯string","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562726582,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":113352,"user_name":"Che Kwas","can_delete":false,"product_type":"c1","uid":1048095,"ip_address":"","ucode":"4CDF9CA041859C","user_header":"https://static001.geekbang.org/account/avatar/00/0f/fe/1f/6a3f2abb.jpg","comment_is_top":false,"comment_ctime":1562983391,"is_pvip":false,"replies":[{"id":"41600","content":"æˆ‘ç†è§£äº†ä½ çš„é—®é¢˜ï¼Œå°è¯•å›ç­”ä¸‹ï¼Œä¸ä¸€å®šå‡†ç¡®ï¼š<br>1. client ä¼šä¼ ä¸Šæ¥ total_lenï¼Œé‚£ä¹ˆ OpenResty å°±èƒ½è®¡ç®—å‡ºæ¥ç¬¬å‡ æ¬¡ send æ˜¯æœ€åä¸€æ¬¡ã€‚åœ¨æœ€åä¸€æ¬¡ client send çš„æ•°æ®è§£å¯†å¹¶è½¬å‘ç»™ä¸Šæ¸¸ server åï¼Œå¼€å§‹ receive serverã€‚æ˜¯å¦å¯ä»¥è§£å†³å‘¢ï¼Ÿ<br>2. è¿™ä¸ªæœ‰æœ‰äº›å°´å°¬äº†ï¼Œå³ä½¿OpenResty ä¸å…³å¿ƒæ•°æ®æ ¼å¼ï¼Œè‡³å°‘ä¹Ÿè¦çŸ¥é“æ•°æ®é•¿åº¦æˆ–è€…ç»“æŸç¬¦ï¼Œè¿™ä¸¤ä¸ªçš„å…¶ä¸­ä¸€ä¸ªã€‚ä¸ç„¶æ— æ³•çŸ¥é“ä½•æ—¶ç»“æŸã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1563240119,"ip_address":"","comment_id":113352,"utype":1}],"discussion_count":3,"race_medal":0,"score":"5857950687","product_id":100028301,"comment_content":"æœ‰ä¸ªçœŸå®éœ€æ±‚ï¼š<br>client   --å¯†æ–‡--&gt; Openrestyè§£å¯†   --æ˜æ–‡--&gt; server<br>client &lt;--å¯†æ–‡--   OpenrestyåŠ å¯† &lt;--æ˜æ–‡--   server<br>1. è¿™æ˜¯TCPåº”ç”¨ï¼Œsend&#47;recvä¸ä¸€å®šæ˜¯ä¸€å¯¹å„¿ï¼Œæ¯”å¦‚æœ‰ä¸ªå¤§è¯·æ±‚ï¼Œclientéœ€è¦send 10æ¬¡ä»¥åå†æ”¶ï¼›<br>2. OpenrestyçŸ¥é“clientå‘è¿‡æ¥çš„å¯†æ–‡æ ¼å¼ï¼Œå¸¦total_lenï¼Œå¯ä»¥æ­£å¸¸receive(total_len)å°±å¯ä»¥äº†ï¼›<br>3. ã€é—®é¢˜ã€‘Openrestyä¸çŸ¥é“ä¸šåŠ¡æ•°æ®æ ¼å¼ï¼Œåœ¨receiveä¸Šæ¸¸æœåŠ¡å™¨æ—¶ï¼Œé‡åˆ°ä¸¤ä¸ªé—®é¢˜ï¼š<br>*3.1* ä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™receiveï¼Œå¦‚1.æè¿°ï¼ŒOpenrestyå°†æ˜æ–‡è½¬å‘è‡³serveræ—¶ï¼Œserverä¸ä¸€å®šæœ‰è¿”å›æ•°æ®ï¼›<br>*3.2*å¦‚æœæ¥äº†æ•°æ®ï¼Œä¸çŸ¥é“è¯¥æ”¶å¤šå°‘ï¼Œå› ä¸ºä¸çŸ¥é“ä¸šåŠ¡æ•°æ®çš„æ ¼å¼ã€‚<br>ã€æˆ‘ç°åœ¨çš„åšæ³•æ˜¯ã€‘<br>1. Openresty receive serveré‚£ä¸€ä¾§ï¼Œè®¾ç½®äº†ä¸€ä¸ªbuf_len,å’Œä¸€ä¸ªè¾ƒå°çš„è¶…æ—¶ï¼Œæ¯”å¦‚200ms;<br>2. Openrestyæ¯è½¬å‘ä¸€æ¬¡æ•°æ®åˆ°serverï¼Œéƒ½å°è¯•receiveä¸€ä¸‹serverï¼Œå¦‚æœè¶…æ—¶ï¼Œä¸æŠ¥é”™ä¸è¿”å›ï¼›å¦‚æœreceiveåˆ°æ•°æ®äº†ï¼Œå°±åŠ å¯†è¿”å›åå†å¾ªç¯receiveï¼Œç›´åˆ°æ— æ•°æ®ï¼ˆè¶…æ—¶ï¼‰ï¼›<br>è¿™æ ·è™½ç„¶è§£å†³äº†é—®é¢˜ï¼Œä½†æ˜¯æ€§èƒ½å¤ªå·®äº†ï¼Œåœ¨openresty---serveré‚£ä¸€ä¾§ï¼Œè‡³å°‘è¦receiveè¶…æ—¶ä¸€æ¬¡ï¼Œæ‰èƒ½çŸ¥é“æ”¶å®Œæ•°æ®äº†ã€‚<br>ã€è¯·é—®ã€‘æœ‰æ›´å¥½çš„è§£å†³åŠæ³•å—ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":458182,"discussion_content":"æˆ‘ç†è§£äº†ä½ çš„é—®é¢˜ï¼Œå°è¯•å›ç­”ä¸‹ï¼Œä¸ä¸€å®šå‡†ç¡®ï¼š\n1. client ä¼šä¼ ä¸Šæ¥ total_lenï¼Œé‚£ä¹ˆ OpenResty å°±èƒ½è®¡ç®—å‡ºæ¥ç¬¬å‡ æ¬¡ send æ˜¯æœ€åä¸€æ¬¡ã€‚åœ¨æœ€åä¸€æ¬¡ client send çš„æ•°æ®è§£å¯†å¹¶è½¬å‘ç»™ä¸Šæ¸¸ server åï¼Œå¼€å§‹ receive serverã€‚æ˜¯å¦å¯ä»¥è§£å†³å‘¢ï¼Ÿ\n2. è¿™ä¸ªæœ‰æœ‰äº›å°´å°¬äº†ï¼Œå³ä½¿OpenResty ä¸å…³å¿ƒæ•°æ®æ ¼å¼ï¼Œè‡³å°‘ä¹Ÿè¦çŸ¥é“æ•°æ®é•¿åº¦æˆ–è€…ç»“æŸç¬¦ï¼Œè¿™ä¸¤ä¸ªçš„å…¶ä¸­ä¸€ä¸ªã€‚ä¸ç„¶æ— æ³•çŸ¥é“ä½•æ—¶ç»“æŸã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1563240119,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1249598,"avatar":"https://static001.geekbang.org/account/avatar/00/13/11/3e/925aa996.jpg","nickname":"HelloBug","note":"","ucode":"E61A4AD5C2F724","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1923,"discussion_content":"å®¢æˆ·ç«¯å¦‚æœçŸ¥é“æœåŠ¡ç«¯æœ‰æ²¡æœ‰æ•°æ®è¦å‘è¿‡æ¥å¯ä»¥å‘Šè¯‰openrestyã€‚\nå¦‚æœå®¢æˆ·ç«¯ä¸çŸ¥é“çš„è¯ï¼ŒæœåŠ¡ç«¯å¯ä»¥æ— è®ºæœ‰æ²¡æœ‰æ•°æ®éƒ½å‘è¿‡æ¥ä¸€ä¸ªåº”ç­”ï¼Œç±»ä¼¼äºè¯´ï¼Œæˆ‘æ”¶åˆ°ä½ çš„æ•°æ®äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563097261,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1048095,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/fe/1f/6a3f2abb.jpg","nickname":"Che Kwas","note":"","ucode":"4CDF9CA041859C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1249598,"avatar":"https://static001.geekbang.org/account/avatar/00/13/11/3e/925aa996.jpg","nickname":"HelloBug","note":"","ucode":"E61A4AD5C2F724","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":1965,"discussion_content":"è°¢è°¢æ‚¨çš„å›ç­”ã€‚æˆ‘å’Œæˆ‘è€å¤§è®¨è®ºäº†ä¸€ä¸‹ã€‚\nã€æ‚¨çš„ç¬¬ä¸€ç§æ–¹æ¡ˆã€‘\næˆ‘æ„Ÿè§‰æ²¡é—®é¢˜ï¼Œä½†æ˜¯æˆ‘è€å¤§ä¸åŒæ„ï¼Œä»–è¦æ±‚åŠ ä¸ŠOpenrestyè¿™ä¸€å±‚ä»¥åï¼Œclientçš„ä½¿ç”¨ä½“éªŒä¸èƒ½æœ‰ä»€ä¹ˆå˜åŒ–ã€‚\nå¦‚æœclient recv Openrestyçš„æ—¶å€™ï¼ŒOpenrestyå†å»recv serverï¼Œæ—¶æœºæœ‰ç‚¹å„¿æ™šäº†ã€‚å› ä¸ºå¦‚æœæ²¡æœ‰Openrestyè¿™ä¸€å±‚ï¼Œserverä¸€æœ‰æ•°æ®ï¼Œå°±ä¼šä¸»åŠ¨sendåˆ°clientæ‰€åœ¨çš„æ“ä½œç³»ç»Ÿå†…æ ¸çš„ï¼›clientå»recvçš„æ—¶å€™ï¼Œç›´æ¥ä»å†…æ ¸ç¼“å­˜æ‹·è´åˆ°ç”¨æˆ·ç¼“å­˜ã€‚\nå¦‚æœåŠ ä¸ŠOpenrestyè¿™ä¸€å±‚ï¼Œå°±å˜æˆäº†client recvçš„æ—¶å€™ï¼Œå…ˆå‘ä¸ªsendåˆ°Openrestyå‘Šè¯‰Openrestyè¦recväº†ï¼ŒOpenrestyå†å»çœŸæ­£çš„è½¬å‘ä¸šåŠ¡æ•°æ®ã€‚å³ã€ç½‘ç»œä¼ è¾“çš„æ—¶æœºæœ‰ç‚¹å„¿æ™šäº†ã€‘\n\nã€æ‚¨çš„ç¬¬äºŒç§æ–¹æ¡ˆã€‘\næˆ‘ä»¬çš„OpenrestyåŠ å¯†ç½‘å…³æ˜¯æƒ³ç»™ç¬¬ä¸‰æ–¹ä½¿ç”¨çš„ï¼Œclientå’Œserveréƒ½æ˜¯ç¬¬ä¸‰æ–¹çš„ï¼Œæ”¹ä¸äº†ä»–ä»¬çš„ä¸šåŠ¡é€»è¾‘ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563154090,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":1923,"ip_address":""},"score":1965,"extra":""}]}]},{"had_liked":false,"id":325445,"user_name":"Leo","can_delete":false,"product_type":"c1","uid":2858431,"ip_address":"","ucode":"24D1E66E284411","user_header":"","comment_is_top":false,"comment_ctime":1638958660,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1638958660","product_id":100028301,"comment_content":"çœŸæ˜¯ç”¨å¿ƒè‰¯è‹¦ï¼Œæˆ‘åœ¨openrestyçš„githubä»‹ç»é¡µä¸Šï¼Œçœ‹è§äº†è‹±æ–‡ç‰ˆçš„ä»‹ç»ï¼ŒçœŸæŒºä¸å®¹æ˜“çš„ï¼Œä¸ºäº†æ¨å¹¿ï¼Œç­‰äºæŠŠè‹±æ–‡ç‰ˆçš„ä»‹ç»ï¼Œåšäº†æ‹£é€‰ä¹‹ååšäº†æ•´ç†ç¿»è¯‘ã€‚è°¢è°¢äº†ï¼Œæˆ‘ä¹Ÿåœ¨åŠªåŠ›è¡¥è‹±è¯­ï¼Œä¸­å›½ä½“åˆ¶æ•™è‚²çš„å—å®³è€…ï¼Œæˆ‘æ˜¯å­¦ä¿„è¯­çš„ï¼Œåˆä¸­è¢«åˆ†åˆ°äº†ä¿„è¯­ç­ï¼Œæ²¡æœºä¼šé€‰æ‹©ï¼Œå¹¶ä¸”å®¶é‡Œä¹Ÿæ²¡å»äº‰å–è¿‡ã€‚æ²¡åŠæ³•é è‡ªå·±å§ï¼Œä¸è¿‡çœŸçš„æŒºæ— è¯­çš„ï¼Œæˆ‘åŸ¹è®­çš„æœºæ„å—åŒå‡æ”¿ç­–å€’é—­äº†ï¼Œä½ æƒ³å¾€å‡ºèµ°ï¼Œå°±è¦æ‰“æ–­ä½ çš„è…¿ï¼Œæˆ‘ä»¬çš„æ°‘æ—è¿›æ­¥è¿˜æœ‰å¸Œæœ›ä¹ˆ","like_count":0},{"had_liked":false,"id":307469,"user_name":"é‡‘é»„åæœˆ","can_delete":false,"product_type":"c1","uid":2387932,"ip_address":"","ucode":"4AA81E8FF42A88","user_header":"https://static001.geekbang.org/account/avatar/00/24/6f/dc/dba82cbe.jpg","comment_is_top":false,"comment_ctime":1629114930,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1629114930","product_id":100028301,"comment_content":"æ¸©è€å¸ˆï¼šé—®ä¸€ä¸‹ï¼Œä¸ºä»€ä¹ˆä½¿ç”¨ngx.socket.tcpè¿æ¥æœ¬æœºIP (192.168.0.2)çš„æœåŠ¡ï¼Œæ€»æ˜¯è¿”å›â€Connection refusedâ€œé”™è¯¯ï¼Œä½¿ç”¨pythonå»è¿æ¥æœ¬æœºçš„æœåŠ¡ï¼Œæˆ–è€…ä½¿ç”¨telnet 192.168.0.2å´å¯ä»¥æˆåŠŸï¼›ä½¿ç”¨ngx.socket.tcpè¿æ¥æœ¬æœºIP (192.168.0.6)æ˜¯æˆåŠŸçš„ã€‚æ„Ÿè§‰æ˜¯openrestyçš„é—®é¢˜ã€‚æ¯”å¦‚è¿æ¥æ± è¿”å›çš„socketæœ‰é—®é¢˜è¿˜æ˜¯å…¶ä»–åŸå› ï¼Ÿæœ‰æ²¡æœ‰ä»€ä¹ˆå¥½å»ºè®®ï¼Ÿ","like_count":0},{"had_liked":false,"id":261460,"user_name":"swimming","can_delete":false,"product_type":"c1","uid":1812062,"ip_address":"","ucode":"5AB8317A76E80E","user_header":"https://static001.geekbang.org/account/avatar/00/1b/a6/5e/95b85420.jpg","comment_is_top":false,"comment_ctime":1605343752,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1605343752","product_id":100028301,"comment_content":"è€å¸ˆï¼Œæœ‰ä¸ªå®é™…éœ€æ±‚ï¼Œéœ€è¦åœ¨header filteré˜¶æ®µè°ƒç”¨httpæ¥å£ï¼Œåç»­çš„å¤„ç†ä¾èµ–è¿™æ¬¡è°ƒç”¨çš„è¿”å›ç»“æœï¼Œè¿™ç§æƒ…å†µä½¿ç”¨timerè·³è¿‡æ— æ³•æ»¡è¶³éœ€æ±‚ï¼Œå› ä¸ºä¸èƒ½ä¿è¯åç»­å¤„ç†æ—¶timerå·²ç»è°ƒç”¨å®Œæ¯•è¿”å›ç»“æœäº†ã€‚è¯·é—®è¿™ç§æƒ…å†µæœ‰å¤„ç†æ–¹æ¡ˆå—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1362626,"avatar":"https://static001.geekbang.org/account/avatar/00/14/ca/c2/7a73b569.jpg","nickname":"é‡é£","note":"","ucode":"688473065C58DF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":567637,"discussion_content":"åŒé—®ï¼Œè¯·é—®æœ‰è§£å†³æ–¹æ¡ˆäº†å—","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1650964629,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":260039,"user_name":"å­¦ä¼šä¼ çƒ","can_delete":false,"product_type":"c1","uid":1156267,"ip_address":"","ucode":"49DA267C0DDC7D","user_header":"https://static001.geekbang.org/account/avatar/00/11/a4/ab/b2177dcf.jpg","comment_is_top":false,"comment_ctime":1604912881,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1604912881","product_id":100028301,"comment_content":"è€å¸ˆæ‚¨å¥½ï¼Œè¯·é—®ä¸‹å®¢æˆ·ç«¯æ€ä¹ˆbind()æœ¬åœ°ç½‘å¡ipï¼Œæˆ‘çš„æœºå™¨æœ‰å¤šä¸ªç½‘å¡ï¼Œæˆ‘æƒ³æŒ‡å®šä¸€ä¸ªç½‘å¡å‡ºå»ï¼Œå¦‚æœngx.socket.tcp()æ²¡æœ‰å®ç°bind()è¿™ä¸ªå‡½æ•°ï¼Œæˆ‘æ˜¯åœ¨ngx_http_lua_socket_tcp.cè¿™ä¸ªæ–‡ä»¶é‡Œnewå¯¹è±¡çš„æ—¶å€™åŠ ä¸Šå»ï¼Œè¿˜æ˜¯åœ¨å“ªä¸ªåœ°æ–¹åŠ ï¼Ÿ","like_count":0},{"had_liked":false,"id":236699,"user_name":"æå¼º","can_delete":false,"product_type":"c1","uid":1276652,"ip_address":"","ucode":"EE1F99E12D212E","user_header":"https://static001.geekbang.org/account/avatar/00/13/7a/ec/19104a37.jpg","comment_is_top":false,"comment_ctime":1595505361,"is_pvip":true,"discussion_count":2,"race_medal":0,"score":"1595505361","product_id":100028301,"comment_content":"è€å¸ˆï¼Œ æˆ‘åœ¨ä½¿ç”¨æ—¶é‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼š<br>openrestyä½œä¸ºå®¢æˆ·ç«¯ä¸ä¸Šæ¸¸æœåŠ¡å»ºç«‹Tcpè¿æ¥æ—¶ï¼Œ ä¸èƒ½ä½¿ç”¨bindæ–¹æ³•æŒ‡å®šç«¯å£ï¼Œ ä¹Ÿæ— æ³•è·å–éšæœºåˆ†é…çš„ç«¯å£ï¼Œ æ˜¯æˆ‘ä½¿ç”¨çš„å§¿åŠ¿ä¸å¯¹ä¹ˆï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1156267,"avatar":"https://static001.geekbang.org/account/avatar/00/11/a4/ab/b2177dcf.jpg","nickname":"å­¦ä¼šä¼ çƒ","note":"","ucode":"49DA267C0DDC7D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":323308,"discussion_content":"å“¥ä»¬ï¼Œä½ æœ€åæ˜¯æ€ä¹ˆè§£å†³çš„å‘¢ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604914381,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1156267,"avatar":"https://static001.geekbang.org/account/avatar/00/11/a4/ab/b2177dcf.jpg","nickname":"å­¦ä¼šä¼ çƒ","note":"","ucode":"49DA267C0DDC7D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":323285,"discussion_content":"æˆ‘ä¹Ÿæƒ³çŸ¥é“æ€ä¹ˆbindæœ¬åœ°ipï¼Œæˆ‘çš„æœºå™¨æœ‰å¤šä¸ªç½‘å¡ï¼Œæˆ‘æƒ³æŒ‡å®šæŸä¸ªç½‘å¡å‡ºå»ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604912181,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":113477,"user_name":"wusiration","can_delete":false,"product_type":"c1","uid":1104438,"ip_address":"","ucode":"A9403377054F1E","user_header":"https://static001.geekbang.org/account/avatar/00/10/da/36/ac0ff6a7.jpg","comment_is_top":false,"comment_ctime":1563027250,"is_pvip":false,"replies":[{"id":"41595","content":"æ¥æ”¶ table è€Œéå­—ç¬¦ä¸²ï¼Œæ˜¯ OpenResty Lua API çš„ä¸€ä¸ªé‡è¦çš„ä¼˜åŒ–ç‚¹ã€‚<br>é€šè¿‡shared dictè¿›è¡Œæ•°æ®ä¼ é€’ï¼Œè¿™ä¸ªæˆ‘ä¸æ˜¯å¾ˆæ˜ç™½ï¼Œè¿™ä¸ªæ˜¯å¦‚ä½•ç»•è¿‡é™åˆ¶çš„å‘¢ï¼Ÿ","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1563239408,"ip_address":"","comment_id":113477,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1563027250","product_id":100028301,"comment_content":"é—®é¢˜ä¸€ï¼šå°†tableé€šè¿‡cjsonåºåˆ—åŒ–ï¼Œä½†æ˜¯çœ‹åˆ°è€å¸ˆæœ‰è¯´sendå‡½æ•°æ”¯æŒtableï¼ŒæŸ¥é˜…apiæ–‡æ¡£æœ‰è¯´The input argument data can either be a Lua string or a (nested) Lua table holding string fragments.In case of table arguments, this method will copy all the string elements piece by piece to the underlying Nginx socket send buffers, which is usually optimal than doing string concatenation operations on the Lua land.<br>é—®é¢˜äºŒï¼šé€šè¿‡shared dictè¿›è¡Œæ•°æ®ä¼ é€’","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":458240,"discussion_content":"æ¥æ”¶ table è€Œéå­—ç¬¦ä¸²ï¼Œæ˜¯ OpenResty Lua API çš„ä¸€ä¸ªé‡è¦çš„ä¼˜åŒ–ç‚¹ã€‚\né€šè¿‡shared dictè¿›è¡Œæ•°æ®ä¼ é€’ï¼Œè¿™ä¸ªæˆ‘ä¸æ˜¯å¾ˆæ˜ç™½ï¼Œè¿™ä¸ªæ˜¯å¦‚ä½•ç»•è¿‡é™åˆ¶çš„å‘¢ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563239408,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1104438,"avatar":"https://static001.geekbang.org/account/avatar/00/10/da/36/ac0ff6a7.jpg","nickname":"wusiration","note":"","ucode":"A9403377054F1E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":2145,"discussion_content":"è€å¸ˆï¼Œä¸å¥½æ„æ€ï¼Œæˆ‘ç†è§£é”™é¢˜æ„äº†...","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563282452,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":113214,"user_name":"helloworld","can_delete":false,"product_type":"c1","uid":1105161,"ip_address":"","ucode":"1EECCA0F43E278","user_header":"https://static001.geekbang.org/account/avatar/00/10/dd/09/feca820a.jpg","comment_is_top":false,"comment_ctime":1562917346,"is_pvip":false,"replies":[{"id":"41610","content":"å»ºè®®åœ¨ redis:new() çš„æ—¶å€™åˆ¤æ–­ä¸‹æ˜¯å¦æˆåŠŸã€‚<br>å¦å¤–é™„ä¸Š OpenResty ä½œè€…ç»™è¿™ä¸ªé”™è¯¯çš„æ’æŸ¥æ„è§ï¼šhttps:&#47;&#47;github.com&#47;openresty&#47;lua-resty-redis&#47;issues&#47;27#issuecomment-28166754ï¼Œè‡ªç„¶æ˜¯æ›´åŠ æƒå¨çš„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1563241039,"ip_address":"","comment_id":113214,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1562917346","product_id":100028301,"comment_content":"è€å¸ˆï¼š<br>[error] 16239#16239: *5 attempt to send data on a closed socket: u:0000000000000000, c:0000000000000000<br>å®¢æˆ·ç«¯æ¯æ¬¡postæ•°æ®è¿‡æ¥ï¼Œluaéƒ½å¯ä»¥æ­£ç¡®çš„å°†æ•°æ®å†™å…¥redisï¼Œä½†æ˜¯error.logæ—¥å¿—ä¸­æ€»æ˜¯æŠ¥è¿™ä¸ªé”™è¯¯ã€‚<br>è€å¸ˆï¼Œæˆ‘æ²¡ç”¨åˆ°redisè¿æ¥æ± ï¼Œæˆ‘è¿™ä¸ªåº”ç”¨åœºæ™¯æ˜¯æ¯éš”ä¸€æ®µæ—¶é—´postè¯·æ±‚å¾€rediså†™æ•°æ®ï¼Œæ‰€ä»¥æ²¡å¿…è¦ä½¿ç”¨è¿æ¥æ± ã€‚å…³äºredisçš„è¯­å¥åªæœ‰ä¸‹é¢è¿™äº›ï¼š<br>local redis = require &quot;resty.redis&quot;<br>local red = redis:new()<br>red:set_timemout(2000) -- 2 sec<br>local ip = &quot;127.0.0.1&quot;<br>local port = 6379<br>local ok, err = red:connect(ip, port)<br>if not ok then<br>    ...<br>end<br>ok, err = red:hset(data_time, client, json_encode(data))<br>if not ok then<br>    ...<br>end","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":458114,"discussion_content":"å»ºè®®åœ¨ redis:new() çš„æ—¶å€™åˆ¤æ–­ä¸‹æ˜¯å¦æˆåŠŸã€‚\nå¦å¤–é™„ä¸Š OpenResty ä½œè€…ç»™è¿™ä¸ªé”™è¯¯çš„æ’æŸ¥æ„è§ï¼šhttps://github.com/openresty/lua-resty-redis/issues/27#issuecomment-28166754ï¼Œè‡ªç„¶æ˜¯æ›´åŠ æƒå¨çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563241039,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1105161,"avatar":"https://static001.geekbang.org/account/avatar/00/10/dd/09/feca820a.jpg","nickname":"helloworld","note":"","ucode":"1EECCA0F43E278","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1927,"discussion_content":"è€å¸ˆï¼Œæˆ‘æ’æŸ¥å‡ºé—®é¢˜äº†ï¼Œæ˜¯ä¸ªå¾ˆå¼±æ™ºçš„é—®é¢˜ï¼Œred:set_timeout(2000)è¢«æˆ‘è¯¯å†™æˆäº†red:set_timemout(2000)å¯¼è‡´çš„ï¼Œæ‹¼å†™é”™è¯¯çš„é—®é¢˜:)","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563101065,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":111632,"user_name":"helloworld","can_delete":false,"product_type":"c1","uid":1105161,"ip_address":"","ucode":"1EECCA0F43E278","user_header":"https://static001.geekbang.org/account/avatar/00/10/dd/09/feca820a.jpg","comment_is_top":false,"comment_ctime":1562575863,"is_pvip":false,"replies":[{"id":"40862","content":"æ˜¯å¦ä½¿ç”¨äº†redis çš„è¿æ¥æ± ï¼ŸçŒœæµ‹è¿æ¥æ± é‡Œé¢æœ‰ä¸æ­£å¸¸çš„è¿æ¥ï¼Œä½†æ˜¯è¢«å¤ç”¨äº†ã€‚å¯ä»¥ç¡®è®¤ä¸‹æ”¾è¿›è¿æ¥æ± ä¹‹å‰ï¼Œä»£ç ä¸­æ˜¯å¦åˆ¤æ–­äº†è¿æ¥æ˜¯å¦æ­£å¸¸ï¼Ÿ","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1562723589,"ip_address":"","comment_id":111632,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1562575863","product_id":100028301,"comment_content":"[error] 16239#16239: *5 attempt to send data on a closed socket: u:0000000000000000, c:0000000000000000<br>å®¢æˆ·ç«¯æ¯æ¬¡postæ•°æ®è¿‡æ¥ï¼Œluaéƒ½å¯ä»¥æ­£ç¡®çš„å°†æ•°æ®å†™å…¥redisï¼Œä½†æ˜¯error.logæ—¥å¿—ä¸­æ€»æ˜¯æŠ¥è¿™ä¸ªé”™è¯¯ï¼Œæ±‚è§£ã€‚","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457394,"discussion_content":"æ˜¯å¦ä½¿ç”¨äº†redis çš„è¿æ¥æ± ï¼ŸçŒœæµ‹è¿æ¥æ± é‡Œé¢æœ‰ä¸æ­£å¸¸çš„è¿æ¥ï¼Œä½†æ˜¯è¢«å¤ç”¨äº†ã€‚å¯ä»¥ç¡®è®¤ä¸‹æ”¾è¿›è¿æ¥æ± ä¹‹å‰ï¼Œä»£ç ä¸­æ˜¯å¦åˆ¤æ–­äº†è¿æ¥æ˜¯å¦æ­£å¸¸ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562723589,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":111421,"user_name":"helloworld","can_delete":false,"product_type":"c1","uid":1105161,"ip_address":"","ucode":"1EECCA0F43E278","user_header":"https://static001.geekbang.org/account/avatar/00/10/dd/09/feca820a.jpg","comment_is_top":false,"comment_ctime":1562555632,"is_pvip":false,"replies":[{"id":"40871","content":"å¹¶ä¸æ˜¯ï¼Œä½ å¯ä»¥çœ‹ä¸‹å®ƒçš„æ‰§è¡Œé˜¶æ®µçš„é¡ºåºå›¾ï¼šhttps:&#47;&#47;github.com&#47;moonbingbing&#47;openresty-best-practices&#47;blob&#47;master&#47;images&#47;openresty_phases.pngï¼Œä½ å¯ä»¥åšè¿™ä¸ªæµ‹è¯•ï¼Œåœ¨ content é‡Œé¢ ngx.sayï¼Œç„¶ååœ¨ log æˆ–è€… body filter é˜¶æ®µæ‰“å°ä¸‹æ—¥å¿—è¯•è¯•ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1562729089,"ip_address":"","comment_id":111421,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1562555632","product_id":100028301,"comment_content":"è€å¸ˆï¼Œæ˜¯ä¸æ˜¯ä¸è®ºåœ¨å“ªä¸ªé˜¶æ®µè¿è¡Œngx.say(&#39;hello&#39;),éƒ½ä¼šåœ¨æ‰§è¡Œå®Œæœ¬é˜¶æ®µå‰©ä½™ä»£ç åç›´æ¥å“åº”ç»™å®¢æˆ·ç«¯ï¼Œä¸ä¼šç»§ç»­æ‰§è¡Œå…¶ä»–é˜¶æ®µäº†ã€‚æˆ‘æµ‹è¯•æ˜¯è¿™æ ·çš„ã€‚","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457348,"discussion_content":"å¹¶ä¸æ˜¯ï¼Œä½ å¯ä»¥çœ‹ä¸‹å®ƒçš„æ‰§è¡Œé˜¶æ®µçš„é¡ºåºå›¾ï¼šhttps://github.com/moonbingbing/openresty-best-practices/blob/master/images/openresty_phases.pngï¼Œä½ å¯ä»¥åšè¿™ä¸ªæµ‹è¯•ï¼Œåœ¨ content é‡Œé¢ ngx.sayï¼Œç„¶ååœ¨ log æˆ–è€… body filter é˜¶æ®µæ‰“å°ä¸‹æ—¥å¿—è¯•è¯•ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562729089,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1105161,"avatar":"https://static001.geekbang.org/account/avatar/00/10/dd/09/feca820a.jpg","nickname":"helloworld","note":"","ucode":"1EECCA0F43E278","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1821,"discussion_content":"è€å¸ˆè¯´çš„å¯¹ï¼Œæˆ‘é‡æ–°æ€»ç»“äº†ä¸€ä¸‹ï¼š. ngx.say é€‚ç”¨é˜¶æ®µä¸ºï¼šrewrite_by_lua*, access_by_lua*, content_by_lua*ï¼Œå¦‚æœå‡ºç°åœ¨rewriteï¼Œå°±ä¸ä¼šæ‰§è¡Œaccesså’Œcontenté˜¶æ®µäº†ï¼Œä½†ä¹‹åçš„header_filterã€body_filterã€logä¸‰ä¸ªé˜¶æ®µè¿˜æ˜¯ä¼šæ‰§è¡Œçš„ã€‚åŒç†å‡ºç°åœ¨accessé˜¶æ®µï¼Œå°±ä¸ä¼šæ‰§è¡Œcontenté˜¶æ®µäº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562928713,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":111370,"user_name":"HelloBug","can_delete":false,"product_type":"c1","uid":1249598,"ip_address":"","ucode":"E61A4AD5C2F724","user_header":"https://static001.geekbang.org/account/avatar/00/13/11/3e/925aa996.jpg","comment_is_top":false,"comment_ctime":1562548825,"is_pvip":true,"replies":[{"id":"41605","content":"<br>ä¸€èˆ¬æ¥è¯´ï¼Œä¸€ä¸ª ip ä¸Šå¯èƒ½ä¼šè¿è¡Œå¤šä¸ªç½‘ç«™ï¼Œæ‰€ä»¥ä¼šé€šè¿‡ server name æ¥åšåŒºåˆ†ï¼Œæ¯”å¦‚ Nginx ä¸­çš„ server è¿™ä¸ªæŒ‡ä»¤ã€‚å¦‚æœæ²¡æœ‰è®¾ç½®<br> proxy_set_header Host &quot;www.baidu.com&quot;;<br>çš„è¯ï¼Œåœ¨è·¯ç”±çš„æ—¶å€™å°±å¯èƒ½ä¼šæ‰¾ä¸åˆ° serverã€‚<br>","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1563240662,"ip_address":"","comment_id":111370,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1562548825","product_id":100028301,"comment_content":"æ–‡ä¸­åˆ©ç”¨cosocketå°†TCPè¯·æ±‚å‘é€åˆ°www.baidu.comçš„ä¾‹å­ï¼Œæˆ‘è¿è¡Œäº†ä¸€ä¸‹åŒ…å«å¤´åŸŸHostï¼šwww.baidu.comå’Œä¸åŒ…å«è¯¥å¤´åŸŸçš„è¯·æ±‚ï¼ŒæŠ“åŒ…æ¥çœ‹ï¼Œä¹Ÿç¡®å®æ˜¯ä¸€ä¸ªåŒ…å«Hostå¤´åŸŸï¼Œä¸€ä¸ªä¸åŒ…å«ï¼Œä¸¤ä¸ªè¯·æ±‚éƒ½èƒ½å¾—åˆ°ç™¾åº¦çš„200åº”ç­”ã€‚æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œæˆ‘åœ¨æœ¬åœ°ä½¿ç”¨proxyï¼Œç„¶åè½¬upstreamæ—¶ï¼Œå¦‚æœä¸æŒ‡å®šè¯·æ±‚å¤´åŸŸä¸ºè¯·æ±‚åˆ°çš„åŸŸåçš„è¯ï¼Œå°±ä¸èƒ½å¾—åˆ°æ­£ç¡®çš„åº”ç­”ã€‚è¿™é‡Œæ˜¯æˆ‘å†™çš„å…³äºè¿™ä¸ªé—®é¢˜çš„åšå®¢é“¾æ¥ï¼šhttps:&#47;&#47;blog.csdn.net&#47;u013139008&#47;article&#47;details&#47;94732537 ä»‹ç»è¿™ä¸ªé—®é¢˜ã€‚è€å¸ˆï¼Œä½ çŸ¥é“è¿™é‡Œå¿…é¡»è¦æŒ‡å®šå¤´åŸŸæ˜¯www.baidu.comçš„åŸå› å—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457322,"discussion_content":"\nä¸€èˆ¬æ¥è¯´ï¼Œä¸€ä¸ª ip ä¸Šå¯èƒ½ä¼šè¿è¡Œå¤šä¸ªç½‘ç«™ï¼Œæ‰€ä»¥ä¼šé€šè¿‡ server name æ¥åšåŒºåˆ†ï¼Œæ¯”å¦‚ Nginx ä¸­çš„ server è¿™ä¸ªæŒ‡ä»¤ã€‚å¦‚æœæ²¡æœ‰è®¾ç½®\n proxy_set_header Host &amp;quot;www.baidu.com&amp;quot;;\nçš„è¯ï¼Œåœ¨è·¯ç”±çš„æ—¶å€™å°±å¯èƒ½ä¼šæ‰¾ä¸åˆ° serverã€‚\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563240662,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1249598,"avatar":"https://static001.geekbang.org/account/avatar/00/13/11/3e/925aa996.jpg","nickname":"HelloBug","note":"","ucode":"E61A4AD5C2F724","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1304,"discussion_content":"åˆšåˆšæµ‹è¯•äº†ä¸€ä¸‹åˆ©ç”¨proxyçš„æ–¹å¼å‘é€è¯·æ±‚çš„è¯ï¼Œå¦‚æœè®¾ç½®Hostå¤´åŸŸä¸ºç©ºï¼Œæ”¶åˆ°çš„åº”ç­”æ˜¯302 Foundã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562549476,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":111276,"user_name":"helloworld","can_delete":false,"product_type":"c1","uid":1105161,"ip_address":"","ucode":"1EECCA0F43E278","user_header":"https://static001.geekbang.org/account/avatar/00/10/dd/09/feca820a.jpg","comment_is_top":false,"comment_ctime":1562534811,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1562534811","product_id":100028301,"comment_content":"ğŸ‘","like_count":0}]}