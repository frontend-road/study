{"id":405387,"title":"06 | ä»zipliståˆ°quicklistï¼Œå†åˆ°listpackçš„å¯å‘","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯è’‹å¾·é’§ã€‚</p><p>åœ¨å‰é¢çš„<a href=\"https://time.geekbang.org/column/article/402223\">ç¬¬4è®²</a>ï¼Œæˆ‘ä»‹ç»Redisä¼˜åŒ–è®¾è®¡æ•°æ®ç»“æ„æ¥æå‡å†…å­˜åˆ©ç”¨ç‡çš„æ—¶å€™ï¼Œæåˆ°å¯ä»¥ä½¿ç”¨å‹ç¼©åˆ—è¡¨ï¼ˆziplistï¼‰æ¥ä¿å­˜æ•°æ®ã€‚æ‰€ä»¥ç°åœ¨ä½ åº”è¯¥ä¹ŸçŸ¥é“ï¼Œziplistçš„æœ€å¤§ç‰¹ç‚¹ï¼Œå°±æ˜¯å®ƒè¢«è®¾è®¡æˆä¸€ç§å†…å­˜ç´§å‡‘å‹çš„æ•°æ®ç»“æ„ï¼Œå ç”¨ä¸€å—è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œä»¥è¾¾åˆ°èŠ‚çœå†…å­˜çš„ç›®çš„ã€‚</p><p>ä½†æ˜¯ï¼Œ<strong>åœ¨è®¡ç®—æœºç³»ç»Ÿä¸­ï¼Œä»»ä½•ä¸€ä¸ªè®¾è®¡éƒ½æ˜¯æœ‰åˆ©æœ‰å¼Šçš„</strong>ã€‚å¯¹äºziplistæ¥è¯´ï¼Œè¿™ä¸ªé“ç†åŒæ ·æˆç«‹ã€‚</p><p>è™½ç„¶ziplistèŠ‚çœäº†å†…å­˜å¼€é”€ï¼Œå¯å®ƒä¹Ÿå­˜åœ¨ä¸¤ä¸ªè®¾è®¡ä»£ä»·ï¼šä¸€æ˜¯ä¸èƒ½ä¿å­˜è¿‡å¤šçš„å…ƒç´ ï¼Œå¦åˆ™è®¿é—®æ€§èƒ½ä¼šé™ä½ï¼›äºŒæ˜¯ä¸èƒ½ä¿å­˜è¿‡å¤§çš„å…ƒç´ ï¼Œå¦åˆ™å®¹æ˜“å¯¼è‡´å†…å­˜é‡æ–°åˆ†é…ï¼Œç”šè‡³å¯èƒ½å¼•å‘è¿é”æ›´æ–°çš„é—®é¢˜ã€‚æ‰€è°“çš„è¿é”æ›´æ–°ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯ziplistä¸­çš„æ¯ä¸€é¡¹éƒ½è¦è¢«é‡æ–°åˆ†é…å†…å­˜ç©ºé—´ï¼Œé€ æˆziplistçš„æ€§èƒ½é™ä½ã€‚</p><p>å› æ­¤ï¼Œé’ˆå¯¹zipliståœ¨è®¾è®¡ä¸Šçš„ä¸è¶³ï¼ŒRedisä»£ç åœ¨å¼€å‘æ¼”è¿›çš„è¿‡ç¨‹ä¸­ï¼Œæ–°å¢è®¾è®¡äº†ä¸¤ç§æ•°æ®ç»“æ„ï¼š<strong>quicklistå’Œlistpack</strong>ã€‚è¿™ä¸¤ç§æ•°æ®ç»“æ„çš„è®¾è®¡ç›®æ ‡ï¼Œå°±æ˜¯å°½å¯èƒ½åœ°ä¿æŒziplistèŠ‚çœå†…å­˜çš„ä¼˜åŠ¿ï¼ŒåŒæ—¶é¿å…ziplistæ½œåœ¨çš„æ€§èƒ½ä¸‹é™é—®é¢˜ã€‚</p><p>ä»Šå¤©è¿™èŠ‚è¯¾ï¼Œæˆ‘å°±æ¥ç»™ä½ è¯¦ç»†ä»‹ç»ä¸‹quicklistå’Œlistpackçš„è®¾è®¡æ€æƒ³å’Œå®ç°æ€è·¯ï¼Œä¸è¿‡åœ¨å…·ä½“è®²è§£è¿™ä¸¤ç§æ•°æ®ç»“æ„ä¹‹å‰ï¼Œæˆ‘æƒ³å…ˆå¸¦ä½ æ¥äº†è§£ä¸‹ä¸ºä»€ä¹ˆziplistçš„è®¾è®¡ä¼šå­˜åœ¨ç¼ºé™·ã€‚è¿™æ ·ä¸€æ¥ï¼Œä½ åœ¨å­¦ä¹ quicklistå’Œlistpackæ—¶ï¼Œå¯ä»¥å’Œziplistçš„è®¾è®¡è¿›è¡Œå¯¹æ¯”ï¼Œè¿›ä¸€æ­¥å°±èƒ½æ›´åŠ å®¹æ˜“åœ°æŒæ¡quicklistå’Œlistpackçš„è®¾è®¡è€ƒè™‘äº†ã€‚</p><!-- [[[read_end]]] --><p>è€Œä¸”ï¼Œziplistå’Œquicklistçš„åŒºåˆ«ï¼Œä¹Ÿæ˜¯ç»å¸¸è¢«é—®åˆ°çš„é¢è¯•é¢˜ï¼Œè€Œlistpackæ•°æ®ç»“æ„å› ä¸ºæ¯”è¾ƒæ–°ï¼Œä½ å¯¹å®ƒçš„è®¾è®¡å®ç°å¯èƒ½äº†è§£å¾—å¹¶ä¸å¤šã€‚é‚£åœ¨å­¦å®Œäº†è¿™èŠ‚è¯¾ä¹‹åï¼Œä½ å…¶å®å°±å¯ä»¥å¾ˆè½»æ¾åœ°åº”å¯¹è¿™ä¸‰ç§æ•°æ®ç»“æ„çš„ä½¿ç”¨é—®é¢˜äº†ã€‚æ­¤å¤–ï¼Œä½ è¿˜å¯ä»¥ä»è¿™ä¸‰ç§æ•°æ®ç»“æ„çš„é€æ­¥ä¼˜åŒ–è®¾è®¡ä¸­ï¼Œå­¦ä¹ åˆ°Redisæ•°æ®ç»“æ„åœ¨å†…å­˜å¼€é”€å’Œè®¿é—®æ€§èƒ½ä¹‹é—´ï¼Œé‡‡å–çš„è®¾è®¡å–èˆæ€æƒ³ã€‚å¦‚æœä½ éœ€è¦å¼€å‘é«˜æ•ˆçš„æ•°æ®ç»“æ„ï¼Œä½ å°±å¯ä»¥æŠŠè¿™ç§è®¾è®¡æ€æƒ³åº”ç”¨èµ·æ¥ã€‚</p><p>å¥½ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å…ˆæ¥äº†è§£ä¸‹zipliståœ¨è®¾è®¡ä¸å®ç°ä¸Šå­˜åœ¨çš„ç¼ºé™·ã€‚</p><h2>ziplistçš„ä¸è¶³</h2><p>ä½ å·²ç»çŸ¥é“ï¼Œä¸€ä¸ªziplistæ•°æ®ç»“æ„åœ¨å†…å­˜ä¸­çš„å¸ƒå±€ï¼Œå°±æ˜¯ä¸€å—è¿ç»­çš„å†…å­˜ç©ºé—´ã€‚è¿™å—ç©ºé—´çš„èµ·å§‹éƒ¨åˆ†æ˜¯å¤§å°å›ºå®šçš„10å­—èŠ‚å…ƒæ•°æ®ï¼Œå…¶ä¸­è®°å½•äº†ziplistçš„æ€»å­—èŠ‚æ•°ã€æœ€åä¸€ä¸ªå…ƒç´ çš„åç§»é‡ä»¥åŠåˆ—è¡¨å…ƒç´ çš„æ•°é‡ï¼Œè€Œè¿™10å­—èŠ‚åé¢çš„å†…å­˜ç©ºé—´åˆ™ä¿å­˜äº†å®é™…çš„åˆ—è¡¨æ•°æ®ã€‚åœ¨ziplistçš„æœ€åéƒ¨åˆ†ï¼Œæ˜¯ä¸€ä¸ª1å­—èŠ‚çš„æ ‡è¯†ï¼ˆå›ºå®šä¸º255ï¼‰ï¼Œç”¨æ¥è¡¨ç¤ºziplistçš„ç»“æŸï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/08/6d/08fe01427f264234c59951c8293d466d.jpg?wh=2000x795\" alt=\"\"></p><p>ä¸è¿‡ï¼Œè™½ç„¶ziplisté€šè¿‡ç´§å‡‘çš„å†…å­˜å¸ƒå±€æ¥ä¿å­˜æ•°æ®ï¼ŒèŠ‚çœäº†å†…å­˜ç©ºé—´ï¼Œä½†æ˜¯ziplistä¹Ÿé¢ä¸´ç€éšä¹‹è€Œæ¥çš„ä¸¤ä¸ªä¸è¶³ï¼šæŸ¥æ‰¾å¤æ‚åº¦é«˜å’Œæ½œåœ¨çš„è¿é”æ›´æ–°é£é™©ã€‚é‚£ä¹ˆä¸‹é¢ï¼Œæˆ‘ä»¬å°±åˆ†åˆ«æ¥äº†è§£ä¸‹è¿™ä¸¤ä¸ªé—®é¢˜ã€‚</p><h3>æŸ¥æ‰¾å¤æ‚åº¦é«˜</h3><p>å› ä¸ºziplistå¤´å°¾å…ƒæ•°æ®çš„å¤§å°æ˜¯å›ºå®šçš„ï¼Œå¹¶ä¸”åœ¨ziplistå¤´éƒ¨è®°å½•äº†æœ€åä¸€ä¸ªå…ƒç´ çš„ä½ç½®ï¼Œæ‰€ä»¥ï¼Œå½“åœ¨ziplistä¸­æŸ¥æ‰¾ç¬¬ä¸€ä¸ªæˆ–æœ€åä¸€ä¸ªå…ƒç´ çš„æ—¶å€™ï¼Œå°±å¯ä»¥å¾ˆå¿«æ‰¾åˆ°ã€‚</p><p>ä½†é—®é¢˜æ˜¯ï¼Œå½“è¦æŸ¥æ‰¾åˆ—è¡¨ä¸­é—´çš„å…ƒç´ æ—¶ï¼Œziplistå°±å¾—ä»åˆ—è¡¨å¤´æˆ–åˆ—è¡¨å°¾éå†æ‰è¡Œã€‚è€Œå½“ziplistä¿å­˜çš„å…ƒç´ è¿‡å¤šæ—¶ï¼ŒæŸ¥æ‰¾ä¸­é—´æ•°æ®çš„å¤æ‚åº¦å°±å¢åŠ äº†ã€‚æ›´ç³Ÿç³•çš„æ˜¯ï¼Œå¦‚æœziplisté‡Œé¢ä¿å­˜çš„æ˜¯å­—ç¬¦ä¸²ï¼Œzipliståœ¨æŸ¥æ‰¾æŸä¸ªå…ƒç´ æ—¶ï¼Œè¿˜éœ€è¦é€ä¸€åˆ¤æ–­å…ƒç´ çš„æ¯ä¸ªå­—ç¬¦ï¼Œè¿™æ ·åˆè¿›ä¸€æ­¥å¢åŠ äº†å¤æ‚åº¦ã€‚</p><p>ä¹Ÿæ­£å› ä¸ºå¦‚æ­¤ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨ziplistä¿å­˜Hashæˆ–Sorted Setæ•°æ®æ—¶ï¼Œéƒ½ä¼šåœ¨redis.confæ–‡ä»¶ä¸­ï¼Œé€šè¿‡hash-max-ziplist-entrieså’Œzset-max-ziplist-entriesä¸¤ä¸ªå‚æ•°ï¼Œæ¥æ§åˆ¶ä¿å­˜åœ¨ziplistä¸­çš„å…ƒç´ ä¸ªæ•°ã€‚</p><p>ä¸ä»…å¦‚æ­¤ï¼Œé™¤äº†æŸ¥æ‰¾å¤æ‚åº¦é«˜ä»¥å¤–ï¼Œzipliståœ¨æ’å…¥å…ƒç´ æ—¶ï¼Œå¦‚æœå†…å­˜ç©ºé—´ä¸å¤Ÿäº†ï¼Œziplistè¿˜éœ€è¦é‡æ–°åˆ†é…ä¸€å—è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œè€Œè¿™è¿˜ä¼šè¿›ä¸€æ­¥å¼•å‘è¿é”æ›´æ–°çš„é—®é¢˜ã€‚</p><h3>è¿é”æ›´æ–°é£é™©</h3><p>æˆ‘ä»¬çŸ¥é“ï¼Œå› ä¸ºziplistå¿…é¡»ä½¿ç”¨ä¸€å—è¿ç»­çš„å†…å­˜ç©ºé—´æ¥ä¿å­˜æ•°æ®ï¼Œæ‰€ä»¥å½“æ–°æ’å…¥ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œziplistå°±éœ€è¦è®¡ç®—å…¶æ‰€éœ€çš„ç©ºé—´å¤§å°ï¼Œå¹¶ç”³è¯·ç›¸åº”çš„å†…å­˜ç©ºé—´ã€‚è¿™ä¸€ç³»åˆ—æ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥ä»ziplistçš„å…ƒç´ æ’å…¥å‡½æ•°__ziplistInsertä¸­çœ‹åˆ°ã€‚</p><p><strong>__ziplistInsertå‡½æ•°é¦–å…ˆä¼šè®¡ç®—è·å¾—å½“å‰ziplistçš„é•¿åº¦</strong>ï¼Œè¿™ä¸ªæ­¥éª¤é€šè¿‡ZIPLIST_BYTESå®å®šä¹‰å°±å¯ä»¥å®Œæˆï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚åŒæ—¶ï¼Œè¯¥å‡½æ•°è¿˜å£°æ˜äº†reqlenå˜é‡ï¼Œç”¨äºè®°å½•æ’å…¥å…ƒç´ åæ‰€éœ€çš„æ–°å¢ç©ºé—´å¤§å°ã€‚</p><pre><code>//è·å–å½“å‰ziplisté•¿åº¦curlenï¼›å£°æ˜reqlenå˜é‡ï¼Œç”¨æ¥è®°å½•æ–°æ’å…¥å…ƒç´ æ‰€éœ€çš„é•¿åº¦\nsize_t curlen = intrev32ifbe(ZIPLIST_BYTES(zl)), reqlen;\n</code></pre><p>ç„¶åï¼Œ<strong>__ziplistInsertå‡½æ•°ä¼šåˆ¤æ–­å½“å‰è¦æ’å…¥çš„ä½ç½®æ˜¯å¦æ˜¯åˆ—è¡¨æœ«å°¾</strong>ã€‚å¦‚æœä¸æ˜¯æœ«å°¾ï¼Œé‚£ä¹ˆå°±éœ€è¦è·å–ä½äºå½“å‰æ’å…¥ä½ç½®çš„å…ƒç´ çš„prevlenå’Œprevlensizeã€‚è¿™éƒ¨åˆ†ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>//å¦‚æœæ’å…¥çš„ä½ç½®ä¸æ˜¯ziplistæœ«å°¾ï¼Œåˆ™è·å–å‰ä¸€é¡¹é•¿åº¦\n   if (p[0] != ZIP_END) {\n\t  ZIP_DECODE_PREVLEN(p, prevlensize, prevlen);\n\t  } else {\n\t     â€¦\n\t  }\n</code></pre><p>å®é™…ä¸Šï¼Œåœ¨ziplistä¸­ï¼Œæ¯ä¸€ä¸ªå…ƒç´ éƒ½ä¼šè®°å½•å…¶<strong>å‰ä¸€é¡¹çš„é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯prevlen</strong>ã€‚ç„¶åï¼Œä¸ºäº†èŠ‚çœå†…å­˜å¼€é”€ï¼Œziplistä¼šä½¿ç”¨ä¸åŒçš„ç©ºé—´è®°å½•prevlenï¼Œè¿™ä¸ª<strong>prevlenç©ºé—´å¤§å°å°±æ˜¯prevlensize</strong>ã€‚</p><p>ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œå½“åœ¨ä¸€ä¸ªå…ƒç´ Aå‰æ’å…¥ä¸€ä¸ªæ–°çš„å…ƒç´ Bæ—¶ï¼ŒAçš„prevlenå’Œprevlensizeéƒ½è¦æ ¹æ®Bçš„é•¿åº¦è¿›è¡Œç›¸åº”çš„å˜åŒ–ã€‚</p><p>é‚£ä¹ˆç°åœ¨ï¼Œæˆ‘ä»¬å‡è®¾Açš„prevlenåŸæœ¬åªå ç”¨1å­—èŠ‚ï¼ˆä¹Ÿå°±æ˜¯prevlensizeç­‰äº1ï¼‰ï¼Œè€Œèƒ½è®°å½•çš„å‰ä¸€é¡¹é•¿åº¦æœ€å¤§ä¸º253å­—èŠ‚ã€‚æ­¤æ—¶ï¼Œå¦‚æœBçš„é•¿åº¦è¶…è¿‡äº†253å­—èŠ‚ï¼ŒAçš„prevlenå°±éœ€è¦ä½¿ç”¨5ä¸ªå­—èŠ‚æ¥è®°å½•ï¼ˆprevlenå…·ä½“çš„ç¼–ç æ–¹å¼ï¼Œä½ å¯ä»¥å¤ä¹ å›é¡¾ä¸‹ç¬¬4è®²ï¼‰ï¼Œè¿™æ ·å°±éœ€è¦ç”³è¯·é¢å¤–çš„4å­—èŠ‚ç©ºé—´äº†ã€‚ä¸è¿‡ï¼Œå¦‚æœå…ƒç´ Bçš„æ’å…¥ä½ç½®æ˜¯åˆ—è¡¨æœ«å°¾ï¼Œé‚£ä¹ˆæ’å…¥å…ƒç´ Bæ—¶ï¼Œæˆ‘ä»¬å°±ä¸ç”¨è€ƒè™‘åé¢å…ƒç´ çš„prevlenäº†ã€‚</p><p>æˆ‘ç”»äº†ä¸‹é¢è¿™å¼ å›¾ï¼Œä»¥ä¾¿äºä½ ç†è§£æ•°æ®æ’å…¥è¿‡ç¨‹å¯¹æ’å…¥ä½ç½®å…ƒç´ çš„å½±å“ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/de/45/de43202b0afb4e5394c5323fc9f93a45.jpg?wh=2000x1125\" alt=\"\"></p><p>å› æ­¤ï¼Œä¸ºäº†ä¿è¯ziplistæœ‰è¶³å¤Ÿçš„å†…å­˜ç©ºé—´ï¼Œæ¥ä¿å­˜æ’å…¥å…ƒç´ ä»¥åŠæ’å…¥ä½ç½®å…ƒç´ çš„prevlenä¿¡æ¯ï¼Œ<strong>__ziplistInsertå‡½æ•°åœ¨è·å¾—æ’å…¥ä½ç½®å…ƒç´ çš„prevlenå’Œprevlensizeåï¼Œç´§æ¥ç€å°±ä¼šè®¡ç®—æ’å…¥å…ƒç´ çš„é•¿åº¦</strong>ã€‚</p><p>ç°åœ¨æˆ‘ä»¬å·²çŸ¥ï¼Œä¸€ä¸ªziplistå…ƒç´ åŒ…æ‹¬äº†prevlenã€encodingå’Œå®é™…æ•°æ®dataä¸‰ä¸ªéƒ¨åˆ†ã€‚æ‰€ä»¥ï¼Œåœ¨è®¡ç®—æ’å…¥å…ƒç´ çš„æ‰€éœ€ç©ºé—´æ—¶ï¼Œ__ziplistInsertå‡½æ•°ä¹Ÿä¼šåˆ†åˆ«è®¡ç®—è¿™ä¸‰ä¸ªéƒ¨åˆ†çš„é•¿åº¦ã€‚è¿™ä¸ªè®¡ç®—è¿‡ç¨‹ä¸€å…±å¯ä»¥åˆ†æˆå››æ­¥æ¥å®Œæˆã€‚</p><ul>\n<li>ç¬¬ä¸€æ­¥ï¼Œè®¡ç®—å®é™…æ’å…¥å…ƒç´ çš„é•¿åº¦ã€‚</li>\n</ul><p>é¦–å…ˆä½ è¦çŸ¥é“ï¼Œè¿™ä¸ªè®¡ç®—è¿‡ç¨‹å’Œæ’å…¥å…ƒç´ æ˜¯æ•´æ•°è¿˜æ˜¯å­—ç¬¦ä¸²æœ‰å…³ã€‚__ziplistInsertå‡½æ•°ä¼šå…ˆè°ƒç”¨zipTryEncodingå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¼šåˆ¤æ–­æ’å…¥å…ƒç´ æ˜¯å¦ä¸ºæ•´æ•°ã€‚å¦‚æœæ˜¯æ•´æ•°ï¼Œå°±æŒ‰ç…§ä¸åŒçš„æ•´æ•°å¤§å°ï¼Œè®¡ç®—encodingå’Œå®é™…æ•°æ®dataå„è‡ªæ‰€éœ€çš„ç©ºé—´ï¼›å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆå°±å…ˆæŠŠå­—ç¬¦ä¸²é•¿åº¦è®°å½•ä¸ºæ‰€éœ€çš„æ–°å¢ç©ºé—´å¤§å°ã€‚è¿™ä¸€è¿‡ç¨‹çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>\tif (zipTryEncoding(s,slen,&amp;value,&amp;encoding)) {\n\t        reqlen = zipIntSize(encoding);\n\t    } else {\n\t        reqlen = slen;\n\t    }\n</code></pre><ul>\n<li>ç¬¬äºŒæ­¥ï¼Œè°ƒç”¨zipStorePrevEntryLengthå‡½æ•°ï¼Œå°†æ’å…¥ä½ç½®å…ƒç´ çš„prevlenä¹Ÿè®¡ç®—åˆ°æ‰€éœ€ç©ºé—´ä¸­ã€‚</li>\n</ul><p>è¿™æ˜¯å› ä¸ºåœ¨æ’å…¥å…ƒç´ åï¼Œ__ziplistInsertå‡½æ•°å¯èƒ½è¦ä¸ºæ’å…¥ä½ç½®çš„å…ƒç´ åˆ†é…æ–°å¢ç©ºé—´ã€‚è¿™éƒ¨åˆ†ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>reqlen += zipStorePrevEntryLength(NULL,prevlen);\n</code></pre><ul>\n<li>ç¬¬ä¸‰æ­¥ï¼Œè°ƒç”¨zipStoreEntryEncodingå‡½æ•°ï¼Œæ ¹æ®å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œè®¡ç®—ç›¸åº”encodingçš„å¤§å°ã€‚</li>\n</ul><p>åœ¨åˆšæ‰çš„ç¬¬ä¸€æ­¥ä¸­ï¼Œ__ziplistInsertå‡½æ•°å¯¹äºå­—ç¬¦ä¸²æ•°æ®ï¼Œåªæ˜¯è®°å½•äº†å­—ç¬¦ä¸²æœ¬èº«çš„é•¿åº¦ï¼Œæ‰€ä»¥åœ¨ç¬¬ä¸‰æ­¥ä¸­ï¼Œ__ziplistInsertå‡½æ•°è¿˜ä¼šè°ƒç”¨zipStoreEntryEncodingå‡½æ•°ï¼Œæ ¹æ®å­—ç¬¦ä¸²çš„é•¿åº¦æ¥è®¡ç®—ç›¸åº”çš„encodingå¤§å°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>reqlen += zipStoreEntryEncoding(NULL,encoding,slen);\n</code></pre><p>å¥½äº†ï¼Œåˆ°è¿™é‡Œï¼Œ__ziplistInsertå‡½æ•°å°±å·²ç»åœ¨reqlenå˜é‡ä¸­ï¼Œè®°å½•äº†æ’å…¥å…ƒç´ çš„prevlené•¿åº¦ã€encodingå¤§å°ï¼Œä»¥åŠå®é™…æ•°æ®dataçš„é•¿åº¦ã€‚è¿™æ ·ä¸€æ¥ï¼Œæ’å…¥å…ƒç´ çš„æ•´ä½“é•¿åº¦å°±æœ‰äº†ï¼Œè¿™ä¹Ÿæ˜¯æ’å…¥ä½ç½®å…ƒç´ çš„prevlenæ‰€è¦è®°å½•çš„å¤§å°ã€‚</p><ul>\n<li>ç¬¬å››æ­¥ï¼Œè°ƒç”¨zipPrevLenByteDiffå‡½æ•°ï¼Œåˆ¤æ–­æ’å…¥ä½ç½®å…ƒç´ çš„prevlenå’Œå®é™…æ‰€éœ€çš„prevlenå¤§å°ã€‚</li>\n</ul><p>æœ€åï¼Œ__ziplistInsertå‡½æ•°ä¼šè°ƒç”¨zipPrevLenByteDiffå‡½æ•°ï¼Œç”¨æ¥åˆ¤æ–­æ’å…¥ä½ç½®å…ƒç´ çš„prevlenå’Œå®é™…æ‰€éœ€çš„prevlenï¼Œè¿™ä¸¤è€…é—´çš„å¤§å°å·®åˆ«ã€‚è¿™éƒ¨åˆ†ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼Œprevlençš„å¤§å°å·®åˆ«æ˜¯ä½¿ç”¨nextdiffæ¥è®°å½•çš„ï¼š</p><pre><code>nextdiff = (p[0] != ZIP_END) ? zipPrevLenByteDiff(p,reqlen) : 0;\n</code></pre><p>é‚£ä¹ˆåœ¨è¿™é‡Œï¼Œå¦‚æœnextdiffå¤§äº0ï¼Œå°±è¡¨æ˜æ’å…¥ä½ç½®å…ƒç´ çš„ç©ºé—´ä¸å¤Ÿï¼Œéœ€è¦æ–°å¢nextdiffå¤§å°çš„ç©ºé—´ï¼Œä»¥ä¾¿èƒ½ä¿å­˜æ–°çš„prevlenã€‚ç„¶åï¼Œ<strong>__ziplistInsertå‡½æ•°åœ¨æ–°å¢ç©ºé—´æ—¶ï¼Œå°±ä¼šè°ƒç”¨ziplistResizeå‡½æ•°ï¼Œæ¥é‡æ–°åˆ†é…ziplistæ‰€éœ€çš„ç©ºé—´</strong>ã€‚</p><p>ziplistResizeå‡½æ•°æ¥æ”¶çš„å‚æ•°åˆ†åˆ«æ˜¯å¾…é‡æ–°åˆ†é…çš„ziplistå’Œé‡æ–°åˆ†é…çš„ç©ºé—´å¤§å°ã€‚è€Œ__ziplistInsertå‡½æ•°ä¼ å…¥çš„é‡æ–°åˆ†é…å¤§å°çš„å‚æ•°ï¼Œæ˜¯ä¸‰ä¸ªé•¿åº¦ä¹‹å’Œã€‚</p><p>é‚£ä¹ˆæ˜¯å“ªä¸‰ä¸ªé•¿åº¦ä¹‹å’Œå‘¢ï¼Ÿ</p><p>è¿™ä¸‰ä¸ªé•¿åº¦åˆ†åˆ«æ˜¯ziplistç°æœ‰å¤§å°ï¼ˆcurlenï¼‰ã€å¾…æ’å…¥å…ƒç´ è‡ªèº«æ‰€éœ€çš„æ–°å¢ç©ºé—´ï¼ˆreqlenï¼‰ï¼Œä»¥åŠæ’å…¥ä½ç½®å…ƒç´ prevlenæ‰€éœ€çš„æ–°å¢ç©ºé—´ï¼ˆnextdiffï¼‰ã€‚ä¸‹é¢çš„ä»£ç æ˜¾ç¤ºäº†ziplistResizeå‡½æ•°çš„è°ƒç”¨å’Œå‚æ•°ä¼ é€’é€»è¾‘ï¼š</p><pre><code>zl = ziplistResize(zl,curlen+reqlen+nextdiff);\n</code></pre><p>è¿›ä¸€æ­¥ï¼Œé‚£ä¹ˆziplistResizeå‡½æ•°åœ¨è·å¾—ä¸‰ä¸ªé•¿åº¦æ€»å’Œä¹‹åï¼Œå…·ä½“æ˜¯å¦‚ä½•æ‰©å®¹å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥çœ‹ä¸‹ziplistResizeå‡½æ•°çš„å®ç°ï¼Œè¿™ä¸ªå‡½æ•°ä¼šè°ƒç”¨<strong>zreallocå‡½æ•°</strong>ï¼Œæ¥å®Œæˆç©ºé—´çš„é‡æ–°åˆ†é…ï¼Œè€Œé‡æ–°åˆ†é…çš„ç©ºé—´å¤§å°å°±æ˜¯ç”±<strong>ä¼ å…¥å‚æ•°len</strong>å†³å®šçš„ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±äº†è§£åˆ°äº†ziplistResizeå‡½æ•°æ¶‰åŠåˆ°å†…å­˜åˆ†é…æ“ä½œï¼Œå› æ­¤å¦‚æœæˆ‘ä»¬å¾€ziplisté¢‘ç¹æ’å…¥è¿‡å¤šæ•°æ®çš„è¯ï¼Œå°±å¯èƒ½å¼•èµ·å¤šæ¬¡å†…å­˜åˆ†é…ï¼Œä»è€Œä¼šå¯¹Redisæ€§èƒ½é€ æˆå½±å“ã€‚</p><p>ä¸‹é¢çš„ä»£ç æ˜¾ç¤ºäº†ziplistResizeå‡½æ•°çš„éƒ¨åˆ†å®ç°ï¼Œä½ å¯ä»¥çœ‹ä¸‹ã€‚</p><pre><code>unsigned char *ziplistResize(unsigned char *zl, unsigned int len) {\n    //å¯¹zlè¿›è¡Œé‡æ–°å†…å­˜ç©ºé—´åˆ†é…ï¼Œé‡æ–°åˆ†é…çš„å¤§å°æ˜¯len\n    zl = zrealloc(zl,len);\n    â€¦\n    zl[len-1] = ZIP_END;\n    return zl;\n}\n</code></pre><p>å¥½äº†ï¼Œåˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±äº†è§£äº†zipliståœ¨æ–°æ’å…¥å…ƒç´ æ—¶ï¼Œä¼šè®¡ç®—å…¶æ‰€éœ€çš„æ–°å¢ç©ºé—´ï¼Œå¹¶è¿›è¡Œé‡æ–°åˆ†é…ã€‚è€Œå½“æ–°æ’å…¥çš„å…ƒç´ è¾ƒå¤§æ—¶ï¼Œå°±ä¼šå¼•èµ·æ’å…¥ä½ç½®çš„å…ƒç´ prevlensizeå¢åŠ ï¼Œè¿›è€Œå°±ä¼šå¯¼è‡´æ’å…¥ä½ç½®çš„å…ƒç´ æ‰€å ç©ºé—´ä¹Ÿå¢åŠ ã€‚</p><p>è€Œå¦‚æ­¤ä¸€æ¥ï¼Œè¿™ç§ç©ºé—´æ–°å¢å°±ä¼šå¼•èµ·è¿é”æ›´æ–°çš„é—®é¢˜ã€‚</p><p>å®é™…ä¸Šï¼Œæ‰€è°“çš„<strong>è¿é”æ›´æ–°</strong>ï¼Œå°±æ˜¯æŒ‡å½“ä¸€ä¸ªå…ƒç´ æ’å…¥åï¼Œä¼šå¼•èµ·å½“å‰ä½ç½®å…ƒç´ æ–°å¢prevlensizeçš„ç©ºé—´ã€‚è€Œå½“å‰ä½ç½®å…ƒç´ çš„ç©ºé—´å¢åŠ åï¼Œåˆä¼šè¿›ä¸€æ­¥å¼•èµ·è¯¥å…ƒç´ çš„åç»­å…ƒç´ ï¼Œå…¶prevlensizeæ‰€éœ€ç©ºé—´çš„å¢åŠ ã€‚</p><p>è¿™æ ·ï¼Œä¸€æ—¦æ’å…¥ä½ç½®åç»­çš„æ‰€æœ‰å…ƒç´ ï¼Œéƒ½ä¼šå› ä¸ºå‰åºå…ƒç´ çš„prevlenszieå¢åŠ ï¼Œè€Œå¼•èµ·è‡ªèº«ç©ºé—´ä¹Ÿè¦å¢åŠ ï¼Œè¿™ç§æ¯ä¸ªå…ƒç´ çš„ç©ºé—´éƒ½éœ€è¦å¢åŠ çš„ç°è±¡ï¼Œå°±æ˜¯è¿é”æ›´æ–°ã€‚æˆ‘ç”»äº†ä¸‹é¢è¿™å¼ å›¾ï¼Œä½ å¯ä»¥çœ‹ä¸‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/b7/4c/b7f75261e8e72832220c98bf73a0eb4c.jpg?wh=2000x1125\" alt=\"\"></p><p>è¿é”æ›´æ–°ä¸€æ—¦å‘ç”Ÿï¼Œå°±ä¼šå¯¼è‡´ziplistå ç”¨çš„å†…å­˜ç©ºé—´è¦å¤šæ¬¡é‡æ–°åˆ†é…ï¼Œè¿™å°±ä¼šç›´æ¥å½±å“åˆ°ziplistçš„è®¿é—®æ€§èƒ½ã€‚</p><p>æ‰€ä»¥è¯´ï¼Œè™½ç„¶ziplistç´§å‡‘å‹çš„å†…å­˜å¸ƒå±€èƒ½èŠ‚çœå†…å­˜å¼€é”€ï¼Œä½†æ˜¯å¦‚æœä¿å­˜çš„å…ƒç´ æ•°é‡å¢åŠ äº†ï¼Œæˆ–æ˜¯å…ƒç´ å˜å¤§äº†ï¼Œziplistå°±ä¼šé¢ä¸´æ€§èƒ½é—®é¢˜ã€‚é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆæ–¹æ³•å¯ä»¥é¿å…ziplistçš„é—®é¢˜å‘¢ï¼Ÿ</p><p>è¿™å°±æ˜¯æ¥ä¸‹æ¥æˆ‘è¦ç»™ä½ ä»‹ç»çš„quicklistå’Œlistpackï¼Œè¿™ä¸¤ç§æ•°æ®ç»“æ„çš„è®¾è®¡æ€æƒ³äº†ã€‚</p><h2>quicklistè®¾è®¡ä¸å®ç°</h2><p>æˆ‘ä»¬å…ˆæ¥å­¦ä¹ ä¸‹quicklistçš„å®ç°æ€è·¯ã€‚</p><p>quicklistçš„è®¾è®¡ï¼Œå…¶å®æ˜¯ç»“åˆäº†é“¾è¡¨å’Œziplistå„è‡ªçš„ä¼˜åŠ¿ã€‚ç®€å•æ¥è¯´ï¼Œ<strong>ä¸€ä¸ªquicklistå°±æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œè€Œé“¾è¡¨ä¸­çš„æ¯ä¸ªå…ƒç´ åˆæ˜¯ä¸€ä¸ªziplistã€‚</strong></p><p>æˆ‘ä»¬æ¥çœ‹ä¸‹quicklistçš„æ•°æ®ç»“æ„ï¼Œè¿™æ˜¯åœ¨<a href=\"https://github.com/redis/redis/tree/5.0/src/quicklist.h\">quicklist.h</a>æ–‡ä»¶ä¸­å®šä¹‰çš„ï¼Œè€Œquicklistçš„å…·ä½“å®ç°æ˜¯åœ¨<a href=\"https://github.com/redis/redis/tree/5.0/src/quicklist.c\">quicklist.c</a>æ–‡ä»¶ä¸­ã€‚</p><p>é¦–å…ˆï¼Œquicklistå…ƒç´ çš„å®šä¹‰ï¼Œä¹Ÿå°±æ˜¯quicklistNodeã€‚å› ä¸ºquicklistæ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œæ‰€ä»¥æ¯ä¸ªquicklistNodeä¸­ï¼Œéƒ½åŒ…å«äº†åˆ†åˆ«æŒ‡å‘å®ƒå‰åºå’ŒååºèŠ‚ç‚¹çš„<strong>æŒ‡é’ˆ<code>*prev</code>å’Œ<code>*next</code></strong>ã€‚åŒæ—¶ï¼Œæ¯ä¸ªquicklistNodeåˆæ˜¯ä¸€ä¸ªziplistï¼Œæ‰€ä»¥ï¼Œåœ¨quicklistNodeçš„ç»“æ„ä½“ä¸­ï¼Œè¿˜æœ‰æŒ‡å‘ziplistçš„<strong>æŒ‡é’ˆ<code>*zl</code></strong>ã€‚</p><p>æ­¤å¤–ï¼ŒquicklistNodeç»“æ„ä½“ä¸­è¿˜å®šä¹‰äº†ä¸€äº›å±æ€§ï¼Œæ¯”å¦‚ziplistçš„å­—èŠ‚å¤§å°ã€åŒ…å«çš„å…ƒç´ ä¸ªæ•°ã€ç¼–ç æ ¼å¼ã€å­˜å‚¨æ–¹å¼ç­‰ã€‚ä¸‹é¢çš„ä»£ç æ˜¾ç¤ºäº†quicklistNodeçš„ç»“æ„ä½“å®šä¹‰ï¼Œä½ å¯ä»¥çœ‹ä¸‹ã€‚</p><pre><code>typedef struct quicklistNode {\n    struct quicklistNode *prev;     //å‰ä¸€ä¸ªquicklistNode\n    struct quicklistNode *next;     //åä¸€ä¸ªquicklistNode\n    unsigned char *zl;              //quicklistNodeæŒ‡å‘çš„ziplist\n    unsigned int sz;                //ziplistçš„å­—èŠ‚å¤§å°\n    unsigned int count : 16;        //ziplistä¸­çš„å…ƒç´ ä¸ªæ•° \n    unsigned int encoding : 2;   //ç¼–ç æ ¼å¼ï¼ŒåŸç”Ÿå­—èŠ‚æ•°ç»„æˆ–å‹ç¼©å­˜å‚¨\n    unsigned int container : 2;  //å­˜å‚¨æ–¹å¼\n    unsigned int recompress : 1; //æ•°æ®æ˜¯å¦è¢«å‹ç¼©\n    unsigned int attempted_compress : 1; //æ•°æ®èƒ½å¦è¢«å‹ç¼©\n    unsigned int extra : 10; //é¢„ç•™çš„bitä½\n} quicklistNode;\n</code></pre><p>äº†è§£äº†quicklistNodeçš„å®šä¹‰ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹quicklistçš„ç»“æ„ä½“å®šä¹‰ã€‚</p><p>quicklistä½œä¸ºä¸€ä¸ªé“¾è¡¨ç»“æ„ï¼Œåœ¨å®ƒçš„æ•°æ®ç»“æ„ä¸­ï¼Œæ˜¯å®šä¹‰äº†<strong>æ•´ä¸ªquicklistçš„å¤´ã€å°¾æŒ‡é’ˆ</strong>ï¼Œè¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡quicklistçš„æ•°æ®ç»“æ„ï¼Œæ¥å¿«é€Ÿå®šä½åˆ°quicklistçš„é“¾è¡¨å¤´å’Œé“¾è¡¨å°¾ã€‚</p><p>æ­¤å¤–ï¼Œquicklistä¸­è¿˜å®šä¹‰äº†quicklistNodeçš„ä¸ªæ•°ã€æ‰€æœ‰ziplistçš„æ€»å…ƒç´ ä¸ªæ•°ç­‰å±æ€§ã€‚quicklistçš„ç»“æ„å®šä¹‰å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>typedef struct quicklist {\n    quicklistNode *head;      //quicklistçš„é“¾è¡¨å¤´\n    quicklistNode *tail;      //quicklistçš„é“¾è¡¨å°¾\n    unsigned long count;     //æ‰€æœ‰ziplistä¸­çš„æ€»å…ƒç´ ä¸ªæ•°\n    unsigned long len;       //quicklistNodesçš„ä¸ªæ•°\n    ...\n} quicklist;\n</code></pre><p>ç„¶åï¼Œä»quicklistNodeå’Œquicklistçš„ç»“æ„ä½“å®šä¹‰ä¸­ï¼Œæˆ‘ä»¬å°±èƒ½ç”»å‡ºä¸‹é¢è¿™å¼ quicklistçš„ç¤ºæ„å›¾ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/bc/0e/bc725a19b5c1fd25ba7740bab5f9220e.jpg?wh=2000x890\" alt=\"\"></p><p>è€Œä¹Ÿæ­£å› ä¸ºquicklisté‡‡ç”¨äº†é“¾è¡¨ç»“æ„ï¼Œæ‰€ä»¥å½“æ’å…¥ä¸€ä¸ªæ–°çš„å…ƒç´ æ—¶ï¼Œquicklisté¦–å…ˆå°±ä¼šæ£€æŸ¥æ’å…¥ä½ç½®çš„ziplistæ˜¯å¦èƒ½å®¹çº³è¯¥å…ƒç´ ï¼Œè¿™æ˜¯é€šè¿‡ <strong>_quicklistNodeAllowInsertå‡½æ•°</strong>æ¥å®Œæˆåˆ¤æ–­çš„ã€‚</p><p>_quicklistNodeAllowInsertå‡½æ•°ä¼šè®¡ç®—æ–°æ’å…¥å…ƒç´ åçš„å¤§å°ï¼ˆnew_szï¼‰ï¼Œè¿™ä¸ªå¤§å°ç­‰äºquicklistNodeçš„å½“å‰å¤§å°ï¼ˆnode-&gt;szï¼‰ã€æ’å…¥å…ƒç´ çš„å¤§å°ï¼ˆszï¼‰ï¼Œä»¥åŠæ’å…¥å…ƒç´ åziplistçš„prevlenå ç”¨å¤§å°ã€‚</p><p>åœ¨è®¡ç®—å®Œå¤§å°ä¹‹åï¼Œ_quicklistNodeAllowInsertå‡½æ•°ä¼šä¾æ¬¡åˆ¤æ–­æ–°æ’å…¥çš„æ•°æ®å¤§å°ï¼ˆszï¼‰æ˜¯å¦æ»¡è¶³è¦æ±‚ï¼Œå³<strong>å•ä¸ªziplistæ˜¯å¦ä¸è¶…è¿‡8KBï¼Œæˆ–æ˜¯å•ä¸ªziplisté‡Œçš„å…ƒç´ ä¸ªæ•°æ˜¯å¦æ»¡è¶³è¦æ±‚</strong>ã€‚</p><p>åªè¦è¿™é‡Œé¢çš„ä¸€ä¸ªæ¡ä»¶èƒ½æ»¡è¶³ï¼Œquicklistå°±å¯ä»¥åœ¨å½“å‰çš„quicklistNodeä¸­æ’å…¥æ–°å…ƒç´ ï¼Œå¦åˆ™quicklistå°±ä¼šæ–°å»ºä¸€ä¸ªquicklistNodeï¼Œä»¥æ­¤æ¥ä¿å­˜æ–°æ’å…¥çš„å…ƒç´ ã€‚</p><p>ä¸‹é¢ä»£ç æ˜¾ç¤ºäº†æ˜¯å¦å…è®¸åœ¨å½“å‰quicklistNodeæ’å…¥æ•°æ®çš„åˆ¤æ–­é€»è¾‘ï¼Œä½ å¯ä»¥çœ‹ä¸‹ã€‚</p><pre><code>unsigned int new_sz = node-&gt;sz + sz + ziplist_overhead;\nif (likely(_quicklistNodeSizeMeetsOptimizationRequirement(new_sz, fill)))\n    return 1;\nelse if (!sizeMeetsSafetyLimit(new_sz))\n    return 0;\nelse if ((int)node-&gt;count &lt; fill)\n    return 1;\nelse\n    return 0;\n</code></pre><p>è¿™æ ·ä¸€æ¥ï¼Œquicklisté€šè¿‡æ§åˆ¶æ¯ä¸ªquicklistNodeä¸­ï¼Œziplistçš„å¤§å°æˆ–æ˜¯å…ƒç´ ä¸ªæ•°ï¼Œå°±æœ‰æ•ˆå‡å°‘äº†åœ¨ziplistä¸­æ–°å¢æˆ–ä¿®æ”¹å…ƒç´ åï¼Œå‘ç”Ÿè¿é”æ›´æ–°çš„æƒ…å†µï¼Œä»è€Œæä¾›äº†æ›´å¥½çš„è®¿é—®æ€§èƒ½ã€‚</p><p>è€ŒRedisé™¤äº†è®¾è®¡äº†quicklistç»“æ„æ¥åº”å¯¹ziplistçš„é—®é¢˜ä»¥å¤–ï¼Œè¿˜åœ¨5.0ç‰ˆæœ¬ä¸­æ–°å¢äº†listpackæ•°æ®ç»“æ„ï¼Œç”¨æ¥å½»åº•é¿å…è¿é”æ›´æ–°ã€‚ä¸‹é¢æˆ‘ä»¬å°±ç»§ç»­æ¥å­¦ä¹ ä¸‹å®ƒçš„è®¾è®¡å®ç°æ€è·¯ã€‚</p><h2>listpackè®¾è®¡ä¸å®ç°</h2><p>listpackä¹Ÿå«ç´§å‡‘åˆ—è¡¨ï¼Œå®ƒçš„ç‰¹ç‚¹å°±æ˜¯<strong>ç”¨ä¸€å—è¿ç»­çš„å†…å­˜ç©ºé—´æ¥ç´§å‡‘åœ°ä¿å­˜æ•°æ®</strong>ï¼ŒåŒæ—¶ä¸ºäº†èŠ‚çœå†…å­˜ç©ºé—´ï¼Œ<strong>listpackåˆ—è¡¨é¡¹ä½¿ç”¨äº†å¤šç§ç¼–ç æ–¹å¼ï¼Œæ¥è¡¨ç¤ºä¸åŒé•¿åº¦çš„æ•°æ®</strong>ï¼Œè¿™äº›æ•°æ®åŒ…æ‹¬æ•´æ•°å’Œå­—ç¬¦ä¸²ã€‚</p><p>å’Œlistpackç›¸å…³çš„å®ç°æ–‡ä»¶æ˜¯<a href=\"https://github.com/redis/redis/tree/5.0/src/listpack.c\">listpack.c</a>ï¼Œå¤´æ–‡ä»¶åŒ…æ‹¬<a href=\"https://github.com/redis/redis/tree/5.0/src/listpack.h\">listpack.h</a>å’Œ<a href=\"https://github.com/redis/redis/tree/5.0/src/listpack_malloc.h\">listpack_malloc.h</a>ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹listpackçš„<strong>åˆ›å»ºå‡½æ•°lpNew</strong>ï¼Œå› ä¸ºä»è¿™ä¸ªå‡½æ•°çš„ä»£ç é€»è¾‘ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥äº†è§£åˆ°listpackçš„æ•´ä½“ç»“æ„ã€‚</p><p>lpNewå‡½æ•°åˆ›å»ºäº†ä¸€ä¸ªç©ºçš„listpackï¼Œä¸€å¼€å§‹åˆ†é…çš„å¤§å°æ˜¯LP_HDR_SIZEå†åŠ 1ä¸ªå­—èŠ‚ã€‚LP_HDR_SIZEå®å®šä¹‰æ˜¯åœ¨listpack.cä¸­ï¼Œå®ƒé»˜è®¤æ˜¯6ä¸ªå­—èŠ‚ï¼Œå…¶ä¸­4ä¸ªå­—èŠ‚æ˜¯è®°å½•listpackçš„æ€»å­—èŠ‚æ•°ï¼Œ2ä¸ªå­—èŠ‚æ˜¯è®°å½•listpackçš„å…ƒç´ æ•°é‡ã€‚</p><p>æ­¤å¤–ï¼Œlistpackçš„æœ€åä¸€ä¸ªå­—èŠ‚æ˜¯ç”¨æ¥æ ‡è¯†listpackçš„ç»“æŸï¼Œå…¶é»˜è®¤å€¼æ˜¯å®å®šä¹‰LP_EOFã€‚å’Œzipliståˆ—è¡¨é¡¹çš„ç»“æŸæ ‡è®°ä¸€æ ·ï¼ŒLP_EOFçš„å€¼ä¹Ÿæ˜¯255ã€‚</p><pre><code>unsigned char *lpNew(void) {\n    //åˆ†é…LP_HRD_SIZE+1\n    unsigned char *lp = lp_malloc(LP_HDR_SIZE+1);\n    if (lp == NULL) return NULL;\n    //è®¾ç½®listpackçš„å¤§å°\n    lpSetTotalBytes(lp,LP_HDR_SIZE+1);\n    //è®¾ç½®listpackçš„å…ƒç´ ä¸ªæ•°ï¼Œåˆå§‹å€¼ä¸º0\n    lpSetNumElements(lp,0);\n    //è®¾ç½®listpackçš„ç»“å°¾æ ‡è¯†ä¸ºLP_EOFï¼Œå€¼ä¸º255\n    lp[LP_HDR_SIZE] = LP_EOF;\n    return lp;\n}\n</code></pre><p>ä½ å¯ä»¥çœ‹çœ‹ä¸‹é¢è¿™å¼ å›¾ï¼Œå±•ç¤ºçš„å°±æ˜¯å¤§å°ä¸ºLP_HDR_SIZEçš„listpackå¤´å’Œå€¼ä¸º255çš„listpackå°¾ã€‚å½“æœ‰æ–°å…ƒç´ æ’å…¥æ—¶ï¼Œè¯¥å…ƒç´ ä¼šè¢«æ’åœ¨listpackå¤´å’Œå°¾ä¹‹é—´ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/d6/60/d6ef170068fc14c7d901b9ff4935yy60.jpg?wh=2000x562\" alt=\"\"></p><p>å¥½äº†ï¼Œäº†è§£äº†listpackçš„æ•´ä½“ç»“æ„åï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹listpackåˆ—è¡¨é¡¹çš„è®¾è®¡ã€‚</p><p>å’Œzipliståˆ—è¡¨é¡¹ç±»ä¼¼ï¼Œlistpackåˆ—è¡¨é¡¹ä¹ŸåŒ…å«äº†å…ƒæ•°æ®ä¿¡æ¯å’Œæ•°æ®æœ¬èº«ã€‚ä¸è¿‡ï¼Œä¸ºäº†é¿å…ziplistå¼•èµ·çš„è¿é”æ›´æ–°é—®é¢˜ï¼Œlistpackä¸­çš„æ¯ä¸ªåˆ—è¡¨é¡¹ä¸å†åƒzipliståˆ—è¡¨é¡¹é‚£æ ·ï¼Œä¿å­˜å…¶å‰ä¸€ä¸ªåˆ—è¡¨é¡¹çš„é•¿åº¦ï¼Œ<strong>å®ƒåªä¼šåŒ…å«ä¸‰ä¸ªæ–¹é¢å†…å®¹</strong>ï¼Œåˆ†åˆ«æ˜¯å½“å‰å…ƒç´ çš„ç¼–ç ç±»å‹ï¼ˆentry-encodingï¼‰ã€å…ƒç´ æ•°æ®(entry-data)ï¼Œä»¥åŠç¼–ç ç±»å‹å’Œå…ƒç´ æ•°æ®è¿™ä¸¤éƒ¨åˆ†çš„é•¿åº¦(entry-len)ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/60/27/60833af3db19ccf12957cfe6467e9227.jpg?wh=2000x786\" alt=\"\"></p><p>è¿™é‡Œï¼Œå…³äºlistpackåˆ—è¡¨é¡¹çš„è®¾è®¡ï¼Œä½ éœ€è¦é‡ç‚¹æŒæ¡ä¸¤æ–¹é¢çš„è¦ç‚¹ï¼Œåˆ†åˆ«æ˜¯åˆ—è¡¨é¡¹å…ƒç´ çš„ç¼–ç ç±»å‹ï¼Œä»¥åŠåˆ—è¡¨é¡¹é¿å…è¿é”æ›´æ–°çš„æ–¹æ³•ã€‚ä¸‹é¢æˆ‘å°±å¸¦ä½ å…·ä½“äº†è§£ä¸‹ã€‚</p><h3>listpackåˆ—è¡¨é¡¹ç¼–ç æ–¹æ³•</h3><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹listpackå…ƒç´ çš„ç¼–ç ç±»å‹ã€‚å¦‚æœä½ çœ‹äº†listpack.cæ–‡ä»¶ï¼Œä½ ä¼šå‘ç°è¯¥æ–‡ä»¶ä¸­æœ‰å¤§é‡ç±»ä¼¼LP_ENCODING__XX_BIT_INTå’ŒLP_ENCODING__XX_BIT_STRçš„å®å®šä¹‰ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>#define LP_ENCODING_7BIT_UINT 0\n#define LP_ENCODING_6BIT_STR 0x80\n#define LP_ENCODING_13BIT_INT 0xC0\n...\n#define LP_ENCODING_64BIT_INT 0xF4\n#define LP_ENCODING_32BIT_STR 0xF0\n</code></pre><p>è¿™äº›å®å®šä¹‰å…¶å®å°±å¯¹åº”äº†listpackçš„å…ƒç´ ç¼–ç ç±»å‹ã€‚å…·ä½“æ¥è¯´ï¼Œ<strong>listpackå…ƒç´ ä¼šå¯¹ä¸åŒé•¿åº¦çš„æ•´æ•°å’Œå­—ç¬¦ä¸²è¿›è¡Œç¼–ç </strong>ï¼Œè¿™é‡Œæˆ‘ä»¬åˆ†åˆ«æ¥çœ‹ä¸‹ã€‚</p><p>é¦–å…ˆï¼Œå¯¹äº<strong>æ•´æ•°ç¼–ç </strong>æ¥è¯´ï¼Œå½“listpackå…ƒç´ çš„ç¼–ç ç±»å‹ä¸ºLP_ENCODING_7BIT_UINTæ—¶ï¼Œè¡¨ç¤ºå…ƒç´ çš„å®é™…æ•°æ®æ˜¯ä¸€ä¸ª7 bitçš„æ— ç¬¦å·æ•´æ•°ã€‚åˆå› ä¸ºLP_ENCODING_7BIT_UINTæœ¬èº«çš„å®å®šä¹‰å€¼ä¸º0ï¼Œæ‰€ä»¥ç¼–ç ç±»å‹çš„å€¼ä¹Ÿç›¸åº”ä¸º0ï¼Œå 1ä¸ªbitã€‚</p><p>æ­¤æ—¶ï¼Œç¼–ç ç±»å‹å’Œå…ƒç´ å®é™…æ•°æ®å…±ç”¨1ä¸ªå­—èŠ‚ï¼Œè¿™ä¸ªå­—èŠ‚çš„æœ€é«˜ä½ä¸º0ï¼Œè¡¨ç¤ºç¼–ç ç±»å‹ï¼Œåç»­çš„7ä½ç”¨æ¥å­˜å‚¨7 bitçš„æ— ç¬¦å·æ•´æ•°ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/8c/fb/8c4bd520d3953f7e70b6e3f08543c6fb.jpg?wh=1752x710\" alt=\"\"></p><p>è€Œå½“ç¼–ç ç±»å‹ä¸ºLP_ENCODING_13BIT_INTæ—¶ï¼Œè¿™è¡¨ç¤ºå…ƒç´ çš„å®é™…æ•°æ®æ˜¯13 bitçš„æ•´æ•°ã€‚åŒæ—¶ï¼Œå› ä¸ºLP_ENCODING_13BIT_INTçš„å®å®šä¹‰å€¼ä¸º0xC0ï¼Œè½¬æ¢ä¸ºäºŒè¿›åˆ¶å€¼æ˜¯1100 0000ï¼Œæ‰€ä»¥ï¼Œè¿™ä¸ªäºŒè¿›åˆ¶å€¼ä¸­çš„å5ä½å’Œåç»­çš„1ä¸ªå­—èŠ‚ï¼Œå…±13ä½ï¼Œä¼šç”¨æ¥ä¿å­˜13bitçš„æ•´æ•°ã€‚è€Œè¯¥äºŒè¿›åˆ¶å€¼ä¸­çš„å‰3ä½110ï¼Œåˆ™ç”¨æ¥è¡¨ç¤ºå½“å‰çš„ç¼–ç ç±»å‹ã€‚æˆ‘ç”»äº†ä¸‹é¢è¿™å¼ å›¾ï¼Œä½ å¯ä»¥çœ‹ä¸‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/3e/d7/3ecbb8412d41d0a36587dfdaf49714d7.jpg?wh=1897x712\" alt=\"\"></p><p>å¥½ï¼Œåœ¨äº†è§£äº†LP_ENCODING_7BIT_UINTå’ŒLP_ENCODING_13BIT_INTè¿™ä¸¤ç§ç¼–ç ç±»å‹åï¼Œå‰©ä¸‹çš„LP_ENCODING_16BIT_INTã€LP_ENCODING_24BIT_INTã€LP_ENCODING_32BIT_INTå’ŒLP_ENCODING_64BIT_INTï¼Œä½ åº”è¯¥ä¹Ÿå°±èƒ½çŸ¥é“å®ƒä»¬çš„ç¼–ç æ–¹å¼äº†ã€‚</p><p>è¿™å››ç§ç±»å‹æ˜¯åˆ†åˆ«ç”¨2å­—èŠ‚ï¼ˆ16 bitï¼‰ã€3å­—èŠ‚ï¼ˆ24 bitï¼‰ã€4å­—èŠ‚ï¼ˆ32 bitï¼‰å’Œ8å­—èŠ‚ï¼ˆ64 bitï¼‰æ¥ä¿å­˜æ•´æ•°æ•°æ®ã€‚åŒæ—¶ï¼Œå®ƒä»¬çš„ç¼–ç ç±»å‹æœ¬èº«å 1å­—èŠ‚ï¼Œç¼–ç ç±»å‹å€¼åˆ†åˆ«æ˜¯å®ƒä»¬çš„å®å®šä¹‰å€¼ã€‚</p><p>ç„¶åï¼Œå¯¹äº<strong>å­—ç¬¦ä¸²ç¼–ç </strong>æ¥è¯´ï¼Œä¸€å…±æœ‰ä¸‰ç§ç±»å‹ï¼Œåˆ†åˆ«æ˜¯LP_ENCODING_6BIT_STRã€LP_ENCODING_12BIT_STRå’ŒLP_ENCODING_32BIT_STRã€‚ä»åˆšæ‰çš„ä»‹ç»ä¸­ï¼Œä½ å¯ä»¥çœ‹åˆ°ï¼Œæ•´æ•°ç¼–ç ç±»å‹åç§°ä¸­BITå‰é¢çš„æ•°å­—ï¼Œè¡¨ç¤ºçš„æ˜¯æ•´æ•°çš„é•¿åº¦ã€‚å› æ­¤ç±»ä¼¼çš„ï¼Œå­—ç¬¦ä¸²ç¼–ç ç±»å‹åç§°ä¸­BITå‰çš„æ•°å­—ï¼Œè¡¨ç¤ºçš„å°±æ˜¯å­—ç¬¦ä¸²çš„é•¿åº¦ã€‚</p><p>æ¯”å¦‚ï¼Œå½“ç¼–ç ç±»å‹ä¸ºLP_ENCODING_6BIT_STRæ—¶ï¼Œç¼–ç ç±»å‹å 1å­—èŠ‚ã€‚è¯¥ç±»å‹çš„å®å®šä¹‰å€¼æ˜¯0x80ï¼Œå¯¹åº”çš„äºŒè¿›åˆ¶å€¼æ˜¯1000 0000ï¼Œè¿™å…¶ä¸­çš„å‰2ä½æ˜¯ç”¨æ¥æ ‡è¯†ç¼–ç ç±»å‹æœ¬èº«ï¼Œè€Œå6ä½ä¿å­˜çš„æ˜¯å­—ç¬¦ä¸²é•¿åº¦ã€‚ç„¶åï¼Œåˆ—è¡¨é¡¹ä¸­çš„æ•°æ®éƒ¨åˆ†ä¿å­˜äº†å®é™…çš„å­—ç¬¦ä¸²ã€‚</p><p>ä¸‹é¢çš„å›¾å±•ç¤ºäº†ä¸‰ç§å­—ç¬¦ä¸²ç¼–ç ç±»å‹å’Œæ•°æ®çš„å¸ƒå±€ï¼Œä½ å¯ä»¥çœ‹ä¸‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/9c/25/9c17c0be0519100c509e2378acd6e125.jpg?wh=2000x1125\" alt=\"\"></p><h3>listpacké¿å…è¿é”æ›´æ–°çš„å®ç°æ–¹å¼</h3><p>æœ€åï¼Œæˆ‘ä»¬å†æ¥äº†è§£ä¸‹listpackåˆ—è¡¨é¡¹æ˜¯å¦‚ä½•é¿å…è¿é”æ›´æ–°çš„ã€‚</p><p>åœ¨listpackä¸­ï¼Œå› ä¸ºæ¯ä¸ªåˆ—è¡¨é¡¹åªè®°å½•è‡ªå·±çš„é•¿åº¦ï¼Œè€Œä¸ä¼šåƒziplistä¸­çš„åˆ—è¡¨é¡¹é‚£æ ·ï¼Œä¼šè®°å½•å‰ä¸€é¡¹çš„é•¿åº¦ã€‚æ‰€ä»¥ï¼Œå½“æˆ‘ä»¬åœ¨listpackä¸­æ–°å¢æˆ–ä¿®æ”¹å…ƒç´ æ—¶ï¼Œå®é™…ä¸Šåªä¼šæ¶‰åŠæ¯ä¸ªåˆ—è¡¨é¡¹è‡ªå·±çš„æ“ä½œï¼Œè€Œä¸ä¼šå½±å“åç»­åˆ—è¡¨é¡¹çš„é•¿åº¦å˜åŒ–ï¼Œè¿™å°±é¿å…äº†è¿é”æ›´æ–°ã€‚</p><p>ä¸è¿‡ï¼Œä½ å¯èƒ½ä¼šæœ‰ç–‘é—®ï¼š<strong>å¦‚æœlistpackåˆ—è¡¨é¡¹åªè®°å½•å½“å‰é¡¹çš„é•¿åº¦ï¼Œé‚£ä¹ˆlistpackæ”¯æŒä»å·¦å‘å³æ­£å‘æŸ¥è¯¢åˆ—è¡¨ï¼Œæˆ–æ˜¯ä»å³å‘å·¦åå‘æŸ¥è¯¢åˆ—è¡¨å—ï¼Ÿ</strong></p><p>å…¶å®ï¼Œlistpackæ˜¯èƒ½æ”¯æŒæ­£ã€åå‘æŸ¥è¯¢åˆ—è¡¨çš„ã€‚</p><p><strong>å½“åº”ç”¨ç¨‹åºä»å·¦å‘å³æ­£å‘æŸ¥è¯¢listpackæ—¶</strong>ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆè°ƒç”¨lpFirstå‡½æ•°ã€‚è¯¥å‡½æ•°çš„å‚æ•°æ˜¯æŒ‡å‘listpackå¤´çš„æŒ‡é’ˆï¼Œå®ƒåœ¨æ‰§è¡Œæ—¶ï¼Œä¼šè®©æŒ‡é’ˆå‘å³åç§»LP_HDR_SIZEå¤§å°ï¼Œä¹Ÿå°±æ˜¯è·³è¿‡listpackå¤´ã€‚ä½ å¯ä»¥çœ‹ä¸‹lpFirstå‡½æ•°çš„ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>unsigned char *lpFirst(unsigned char *lp) {\n    lp += LP_HDR_SIZE; //è·³è¿‡listpackå¤´éƒ¨6ä¸ªå­—èŠ‚\n    if (lp[0] == LP_EOF) return NULL;  //å¦‚æœå·²ç»æ˜¯listpackçš„æœ«å°¾ç»“æŸå­—èŠ‚ï¼Œåˆ™è¿”å›NULL\n    return lp;\n}\n</code></pre><p>ç„¶åï¼Œå†è°ƒç”¨lpNextå‡½æ•°ï¼Œè¯¥å‡½æ•°çš„å‚æ•°åŒ…æ‹¬äº†æŒ‡å‘listpackæŸä¸ªåˆ—è¡¨é¡¹çš„æŒ‡é’ˆã€‚lpNextå‡½æ•°ä¼šè¿›ä¸€æ­¥è°ƒç”¨lpSkipå‡½æ•°ï¼Œå¹¶ä¼ å…¥å½“å‰åˆ—è¡¨é¡¹çš„æŒ‡é’ˆï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>unsigned char *lpNext(unsigned char *lp, unsigned char *p) {\n    ...\n    p = lpSkip(p);  //è°ƒç”¨lpSkipå‡½æ•°ï¼Œåç§»æŒ‡é’ˆæŒ‡å‘ä¸‹ä¸€ä¸ªåˆ—è¡¨é¡¹\n    if (p[0] == LP_EOF) return NULL;\n    return p;\n}\n</code></pre><p>æœ€åï¼ŒlpSkipå‡½æ•°ä¼šå…ˆåè°ƒç”¨lpCurrentEncodedSizeå’ŒlpEncodeBacklenè¿™ä¸¤ä¸ªå‡½æ•°ã€‚</p><p>lpCurrentEncodedSizeå‡½æ•°æ˜¯æ ¹æ®å½“å‰åˆ—è¡¨é¡¹ç¬¬1ä¸ªå­—èŠ‚çš„å–å€¼ï¼Œæ¥è®¡ç®—å½“å‰é¡¹çš„ç¼–ç ç±»å‹ï¼Œå¹¶æ ¹æ®ç¼–ç ç±»å‹ï¼Œè®¡ç®—å½“å‰é¡¹ç¼–ç ç±»å‹å’Œå®é™…æ•°æ®çš„æ€»é•¿åº¦ã€‚ç„¶åï¼ŒlpEncodeBacklenå‡½æ•°ä¼šæ ¹æ®ç¼–ç ç±»å‹å’Œå®é™…æ•°æ®çš„é•¿åº¦ä¹‹å’Œï¼Œè¿›ä¸€æ­¥è®¡ç®—åˆ—è¡¨é¡¹æœ€åä¸€éƒ¨åˆ†entry-lenæœ¬èº«çš„é•¿åº¦ã€‚</p><p>è¿™æ ·ä¸€æ¥ï¼ŒlpSkipå‡½æ•°å°±çŸ¥é“å½“å‰é¡¹çš„ç¼–ç ç±»å‹ã€å®é™…æ•°æ®å’Œentry-lençš„æ€»é•¿åº¦äº†ï¼Œä¹Ÿå°±å¯ä»¥å°†å½“å‰é¡¹æŒ‡é’ˆå‘å³åç§»ç›¸åº”çš„é•¿åº¦ï¼Œä»è€Œå®ç°æŸ¥åˆ°ä¸‹ä¸€ä¸ªåˆ—è¡¨é¡¹çš„ç›®çš„ã€‚</p><p>ä¸‹é¢ä»£ç å±•ç¤ºäº†lpEncodeBacklenå‡½æ•°çš„åŸºæœ¬è®¡ç®—é€»è¾‘ï¼Œä½ å¯ä»¥çœ‹ä¸‹ã€‚</p><pre><code>unsigned long lpEncodeBacklen(unsigned char *buf, uint64_t l) {\n    //ç¼–ç ç±»å‹å’Œå®é™…æ•°æ®çš„æ€»é•¿åº¦å°äºç­‰äº127ï¼Œentry-lené•¿åº¦ä¸º1å­—èŠ‚\n    if (l &lt;= 127) {\n        ...\n        return 1;\n    } else if (l &lt; 16383) { //ç¼–ç ç±»å‹å’Œå®é™…æ•°æ®çš„æ€»é•¿åº¦å¤§äº127ä½†å°äº16383ï¼Œentry-lené•¿åº¦ä¸º2å­—èŠ‚\n       ...\n        return 2;\n    } else if (l &lt; 2097151) {//ç¼–ç ç±»å‹å’Œå®é™…æ•°æ®çš„æ€»é•¿åº¦å¤§äº16383ä½†å°äº2097151ï¼Œentry-lené•¿åº¦ä¸º3å­—èŠ‚\n       ...\n        return 3;\n    } else if (l &lt; 268435455) { //ç¼–ç ç±»å‹å’Œå®é™…æ•°æ®çš„æ€»é•¿åº¦å¤§äº2097151ä½†å°äº268435455ï¼Œentry-lené•¿åº¦ä¸º4å­—èŠ‚\n        ...\n        return 4;\n    } else { //å¦åˆ™ï¼Œentry-lené•¿åº¦ä¸º5å­—èŠ‚\n       ...\n        return 5;\n    }\n}\n</code></pre><p>æˆ‘ä¹Ÿç”»äº†ä¸€å¼ å›¾ï¼Œå±•ç¤ºäº†ä»å·¦å‘å³éå†listpackçš„åŸºæœ¬è¿‡ç¨‹ï¼Œä½ å¯ä»¥å†å›é¡¾ä¸‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/a9/be/a9e7c837959f8d01bff8321135c484be.jpg?wh=2000x1125\" alt=\"\"></p><p>å¥½ï¼Œäº†è§£äº†ä»å·¦å‘å³æ­£å‘æŸ¥è¯¢listpackï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹<strong>ä»å³å‘å·¦åå‘æŸ¥è¯¢listpack</strong>ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ ¹æ®listpackå¤´ä¸­è®°å½•çš„listpackæ€»é•¿åº¦ï¼Œå°±å¯ä»¥ç›´æ¥å®šä½åˆ°listapckçš„å°¾éƒ¨ç»“æŸæ ‡è®°ã€‚ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨lpPrevå‡½æ•°ï¼Œè¯¥å‡½æ•°çš„å‚æ•°åŒ…æ‹¬æŒ‡å‘æŸä¸ªåˆ—è¡¨é¡¹çš„æŒ‡é’ˆï¼Œå¹¶è¿”å›æŒ‡å‘å½“å‰åˆ—è¡¨é¡¹å‰ä¸€é¡¹çš„æŒ‡é’ˆã€‚</p><p>lpPrevå‡½æ•°ä¸­çš„å…³é”®ä¸€æ­¥å°±æ˜¯è°ƒç”¨lpDecodeBacklenå‡½æ•°ã€‚lpDecodeBacklenå‡½æ•°ä¼šä»å³å‘å·¦ï¼Œé€ä¸ªå­—èŠ‚åœ°è¯»å–å½“å‰åˆ—è¡¨é¡¹çš„entry-lenã€‚</p><p>é‚£ä¹ˆï¼Œ<strong>lpDecodeBacklenå‡½æ•°å¦‚ä½•åˆ¤æ–­entry-lenæ˜¯å¦ç»“æŸäº†å‘¢ï¼Ÿ</strong></p><p>è¿™å°±ä¾èµ–äºentry-lençš„ç¼–ç æ–¹å¼äº†ã€‚entry-lenæ¯ä¸ªå­—èŠ‚çš„æœ€é«˜ä½ï¼Œæ˜¯ç”¨æ¥è¡¨ç¤ºå½“å‰å­—èŠ‚æ˜¯å¦ä¸ºentry-lençš„æœ€åä¸€ä¸ªå­—èŠ‚ï¼Œè¿™é‡Œå­˜åœ¨ä¸¤ç§æƒ…å†µï¼Œåˆ†åˆ«æ˜¯ï¼š</p><ul>\n<li>æœ€é«˜ä½ä¸º1ï¼Œè¡¨ç¤ºentry-lenè¿˜æ²¡æœ‰ç»“æŸï¼Œå½“å‰å­—èŠ‚çš„å·¦è¾¹å­—èŠ‚ä»ç„¶è¡¨ç¤ºentry-lençš„å†…å®¹ï¼›</li>\n<li>æœ€é«˜ä½ä¸º0ï¼Œè¡¨ç¤ºå½“å‰å­—èŠ‚å·²ç»æ˜¯entry-lenæœ€åä¸€ä¸ªå­—èŠ‚äº†ã€‚</li>\n</ul><p>è€Œentry-lenæ¯ä¸ªå­—èŠ‚çš„ä½7ä½ï¼Œåˆ™è®°å½•äº†å®é™…çš„é•¿åº¦ä¿¡æ¯ã€‚è¿™é‡Œä½ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œentry-lenæ¯ä¸ªå­—èŠ‚çš„ä½7ä½é‡‡ç”¨äº†<strong>å¤§ç«¯æ¨¡å¼å­˜å‚¨</strong>ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œentry-lençš„ä½ä½å­—èŠ‚ä¿å­˜åœ¨å†…å­˜é«˜åœ°å€ä¸Šã€‚</p><p>æˆ‘ç”»äº†ä¸‹é¢è¿™å¼ å›¾ï¼Œå±•ç¤ºäº†entry-lenè¿™ç§ç‰¹åˆ«çš„ç¼–ç æ–¹å¼ï¼Œä½ å¯ä»¥çœ‹ä¸‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/4a/5c/4ae6140ca6b08f35b9eb245c4627245c.jpg?wh=2000x1125\" alt=\"\"></p><p>å®é™…ä¸Šï¼Œæ­£æ˜¯å› ä¸ºæœ‰äº†entry-lençš„ç‰¹åˆ«ç¼–ç æ–¹å¼ï¼ŒlpDecodeBacklenå‡½æ•°å°±å¯ä»¥ä»å½“å‰åˆ—è¡¨é¡¹èµ·å§‹ä½ç½®çš„æŒ‡é’ˆå¼€å§‹ï¼Œå‘å·¦é€ä¸ªå­—èŠ‚è§£æï¼Œå¾—åˆ°å‰ä¸€é¡¹çš„entry-lenå€¼ã€‚è¿™ä¹Ÿæ˜¯lpDecodeBacklenå‡½æ•°çš„è¿”å›å€¼ã€‚è€Œä»åˆšæ‰çš„ä»‹ç»ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“entry-lenè®°å½•äº†ç¼–ç ç±»å‹å’Œå®é™…æ•°æ®çš„é•¿åº¦ä¹‹å’Œã€‚</p><p>å› æ­¤ï¼ŒlpPrevå‡½æ•°ä¼šå†è°ƒç”¨lpEncodeBacklenå‡½æ•°ï¼Œæ¥è®¡ç®—å¾—åˆ°entry-lenæœ¬èº«é•¿åº¦ï¼Œè¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°å‰ä¸€é¡¹çš„æ€»é•¿åº¦ï¼Œè€ŒlpPrevå‡½æ•°ä¹Ÿå°±å¯ä»¥å°†æŒ‡é’ˆæŒ‡å‘å‰ä¸€é¡¹çš„èµ·å§‹ä½ç½®äº†ã€‚æ‰€ä»¥æŒ‰ç…§è¿™ä¸ªæ–¹æ³•ï¼Œlistpackå°±å®ç°äº†ä»å³å‘å·¦çš„æŸ¥è¯¢åŠŸèƒ½ã€‚</p><h2>å°ç»“</h2><p>è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»ziplistçš„è®¾è®¡ä¸è¶³å‡ºå‘ï¼Œä¾æ¬¡ç»™ä½ ä»‹ç»äº†quicklistå’Œlistpackçš„è®¾è®¡æ€æƒ³ã€‚</p><p>ä½ è¦çŸ¥é“ï¼Œziplistçš„ä¸è¶³ä¸»è¦åœ¨äº<strong>ä¸€æ—¦ziplistä¸­å…ƒç´ ä¸ªæ•°å¤šäº†ï¼Œå®ƒçš„æŸ¥æ‰¾æ•ˆç‡å°±ä¼šé™ä½</strong>ã€‚è€Œä¸”å¦‚æœåœ¨ziplisté‡Œæ–°å¢æˆ–ä¿®æ”¹æ•°æ®ï¼Œziplistå ç”¨çš„å†…å­˜ç©ºé—´è¿˜éœ€è¦é‡æ–°åˆ†é…ï¼›æ›´ç³Ÿç³•çš„æ˜¯ï¼Œziplistæ–°å¢æŸä¸ªå…ƒç´ æˆ–ä¿®æ”¹æŸä¸ªå…ƒç´ æ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´åç»­å…ƒç´ çš„prevlenå ç”¨ç©ºé—´éƒ½å‘ç”Ÿå˜åŒ–ï¼Œä»è€Œå¼•èµ·è¿é”æ›´æ–°é—®é¢˜ï¼Œå¯¼è‡´æ¯ä¸ªå…ƒç´ çš„ç©ºé—´éƒ½è¦é‡æ–°åˆ†é…ï¼Œè¿™å°±ä¼šå¯¼è‡´ziplistçš„è®¿é—®æ€§èƒ½ä¸‹é™ã€‚</p><p>æ‰€ä»¥ï¼Œä¸ºäº†åº”å¯¹ziplistçš„é—®é¢˜ï¼ŒRediså…ˆæ˜¯åœ¨3.0ç‰ˆæœ¬ä¸­è®¾è®¡å®ç°äº†quicklistã€‚quicklistç»“æ„åœ¨zipliståŸºç¡€ä¸Šï¼Œä½¿ç”¨é“¾è¡¨å°†ziplistä¸²è”èµ·æ¥ï¼Œé“¾è¡¨çš„æ¯ä¸ªå…ƒç´ å°±æ˜¯ä¸€ä¸ªziplistã€‚è¿™ç§è®¾è®¡<strong>å‡å°‘äº†æ•°æ®æ’å…¥æ—¶å†…å­˜ç©ºé—´çš„é‡æ–°åˆ†é…ï¼Œä»¥åŠå†…å­˜æ•°æ®çš„æ‹·è´</strong>ã€‚åŒæ—¶ï¼Œquicklisté™åˆ¶äº†æ¯ä¸ªèŠ‚ç‚¹ä¸Šziplistçš„å¤§å°ï¼Œä¸€æ—¦ä¸€ä¸ªziplistè¿‡å¤§ï¼Œå°±ä¼šé‡‡ç”¨æ–°å¢quicklistèŠ‚ç‚¹çš„æ–¹æ³•ã€‚</p><p>ä¸è¿‡ï¼Œåˆå› ä¸ºquicklistä½¿ç”¨quicklistNodeç»“æ„æŒ‡å‘æ¯ä¸ªziplistï¼Œæ— ç–‘å¢åŠ äº†å†…å­˜å¼€é”€ã€‚ä¸ºäº†<strong>å‡å°‘å†…å­˜å¼€é”€ï¼Œå¹¶è¿›ä¸€æ­¥é¿å…ziplistè¿é”æ›´æ–°é—®é¢˜</strong>ï¼ŒRedisåœ¨5.0ç‰ˆæœ¬ä¸­ï¼Œå°±è®¾è®¡å®ç°äº†listpackç»“æ„ã€‚listpackç»“æ„æ²¿ç”¨äº†ziplistç´§å‡‘å‹çš„å†…å­˜å¸ƒå±€ï¼ŒæŠŠæ¯ä¸ªå…ƒç´ éƒ½ç´§æŒ¨ç€æ”¾ç½®ã€‚</p><p>listpackä¸­æ¯ä¸ªåˆ—è¡¨é¡¹ä¸å†åŒ…å«å‰ä¸€é¡¹çš„é•¿åº¦äº†ï¼Œå› æ­¤å½“æŸä¸ªåˆ—è¡¨é¡¹ä¸­çš„æ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œå¯¼è‡´åˆ—è¡¨é¡¹é•¿åº¦å˜åŒ–æ—¶ï¼Œå…¶ä»–åˆ—è¡¨é¡¹çš„é•¿åº¦æ˜¯ä¸ä¼šå—å½±å“çš„ï¼Œå› è€Œè¿™å°±é¿å…äº†ziplisté¢ä¸´çš„è¿é”æ›´æ–°é—®é¢˜ã€‚</p><p>æ€»è€Œè¨€ä¹‹ï¼ŒRedisåœ¨å†…å­˜ç´§å‡‘å‹åˆ—è¡¨çš„è®¾è®¡ä¸å®ç°ä¸Šï¼Œä»zipliståˆ°quicklistï¼Œå†åˆ°listpackï¼Œä½ å¯ä»¥çœ‹åˆ°Redisåœ¨å†…å­˜ç©ºé—´å¼€é”€å’Œè®¿é—®æ€§èƒ½ä¹‹é—´çš„è®¾è®¡å–èˆï¼Œè¿™ä¸€ç³»åˆ—çš„è®¾è®¡å˜åŒ–ï¼Œæ˜¯éå¸¸å€¼å¾—ä½ å­¦ä¹ çš„ã€‚</p><h2>æ¯è¯¾ä¸€é—®</h2><p>ziplistä¼šä½¿ç”¨zipTryEncodingå‡½æ•°è®¡ç®—æ’å…¥å…ƒç´ æ‰€éœ€çš„æ–°å¢å†…å­˜ç©ºé—´ï¼Œå‡è®¾æ’å…¥çš„ä¸€ä¸ªå…ƒç´ æ˜¯æ•´æ•°ï¼Œä½ çŸ¥é“ziplistèƒ½æ”¯æŒçš„æœ€å¤§æ•´æ•°æ˜¯å¤šå¤§å—ï¼Ÿ</p><p>æ¬¢è¿åœ¨ç•™è¨€åŒºåˆ†äº«ä½ çš„ç­”æ¡ˆå’Œæ€è€ƒè¿‡ç¨‹ï¼Œå¦‚æœè§‰å¾—æœ‰æ”¶è·ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹ã€‚</p>","neighbors":{"left":{"article_title":"05 | æœ‰åºé›†åˆä¸ºä½•èƒ½åŒæ—¶æ”¯æŒç‚¹æŸ¥è¯¢å’ŒèŒƒå›´æŸ¥è¯¢ï¼Ÿ","id":404391},"right":{"article_title":"07 | ä¸ºä»€ä¹ˆStreamä½¿ç”¨äº†Radix Treeï¼Ÿ","id":406284}},"comments":[{"had_liked":false,"id":306042,"user_name":"Kaito","can_delete":false,"product_type":"c1","uid":1020042,"ip_address":"","ucode":"79775FA35A95F2","user_header":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","comment_is_top":false,"comment_ctime":1628318323,"is_pvip":true,"discussion_count":6,"race_medal":0,"score":"156247140979","product_id":100084301,"comment_content":"1ã€ziplist è®¾è®¡çš„åˆè¡·å°±æ˜¯ã€ŒèŠ‚çœå†…å­˜ã€ï¼Œåœ¨å­˜å‚¨æ•°æ®æ—¶ï¼ŒæŠŠå†…å­˜åˆ©ç”¨ç‡å‘æŒ¥åˆ°äº†æè‡´ï¼š<br><br>- æ•°å­—æŒ‰ã€Œæ•´å‹ã€ç¼–ç å­˜å‚¨ï¼Œæ¯”ç›´æ¥å½“å­—ç¬¦ä¸²å­˜å†…å­˜å ç”¨å°‘<br>- æ•°æ®ã€Œé•¿åº¦ã€å­—æ®µï¼Œä¼šæ ¹æ®å†…å®¹çš„å¤§å°é€‰æ‹©æœ€å°çš„é•¿åº¦ç¼–ç <br>- ç”šè‡³å¯¹äºæå°çš„æ•°æ®ï¼Œå¹²è„†æŠŠå†…å®¹ç›´æ¥æ”¾åˆ°äº†ã€Œé•¿åº¦ã€å­—æ®µä¸­ï¼ˆå‰å‡ ä¸ªä½è¡¨ç¤ºé•¿åº¦ï¼Œåå‡ ä¸ªä½å­˜æ•°æ®ï¼‰<br><br>2ã€ä½† ziplist çš„åŠ£åŠ¿ä¹Ÿå¾ˆæ˜æ˜¾ï¼š<br><br>- å¯»æ‰¾å…ƒç´ åªèƒ½æŒ¨ä¸ªéå†ï¼Œå­˜å‚¨è¿‡é•¿æ•°æ®ï¼ŒæŸ¥è¯¢æ€§èƒ½å¾ˆä½<br>- æ¯ä¸ªå…ƒç´ ä¸­ä¿å­˜äº†ã€Œä¸Šä¸€ä¸ªã€å…ƒç´ çš„é•¿åº¦ï¼ˆä¸ºäº†æ–¹ä¾¿åå‘éå†ï¼‰ï¼Œè¿™ä¼šå¯¼è‡´ä¸Šä¸€ä¸ªå…ƒç´ å†…å®¹å‘ç”Ÿä¿®æ”¹ï¼Œé•¿åº¦è¶…è¿‡äº†åŸæ¥çš„ç¼–ç é•¿åº¦ï¼Œä¸‹ä¸€ä¸ªå…ƒç´ çš„å†…å®¹ä¹Ÿè¦è·Ÿç€å˜ï¼Œé‡æ–°åˆ†é…å†…å­˜ï¼Œè¿›è€Œå°±æœ‰å¯èƒ½å†æ¬¡å¼•èµ·ä¸‹ä¸€çº§çš„å˜åŒ–ï¼Œä¸€çº§çº§æ›´æ–°ä¸‹å»ï¼Œé¢‘ç¹ç”³è¯·å†…å­˜<br><br>3ã€æƒ³è¦ç¼“è§£ ziplist çš„é—®é¢˜ï¼Œæ¯”è¾ƒç®€å•ç›´æ¥çš„æ–¹æ¡ˆå°±æ˜¯ï¼Œå¤šä¸ªæ•°æ®é¡¹ï¼Œä¸å†ç”¨ä¸€ä¸ª ziplist æ¥å­˜ï¼Œè€Œæ˜¯åˆ†æ‹†åˆ°å¤šä¸ª ziplist ä¸­ï¼Œæ¯ä¸ª ziplist ç”¨æŒ‡é’ˆä¸²èµ·æ¥ï¼Œè¿™æ ·ä¿®æ”¹å…¶ä¸­ä¸€ä¸ªæ•°æ®é¡¹ï¼Œå³ä¾¿å‘ç”Ÿçº§è”æ›´æ–°ï¼Œä¹Ÿåªä¼šå½±å“è¿™ä¸€ä¸ª ziplistï¼Œå…¶å®ƒ ziplist ä¸å—å½±å“ï¼Œè¿™ç§æ–¹æ¡ˆå°±æ˜¯ quicklistï¼š<br><br>qucklist: ziplist1(ä¹Ÿå«quicklistNode) &lt;-&gt; ziplist2 &lt;-&gt; ziplist3 &lt;-&gt; ...<br><br>4ã€List æ•°æ®ç±»å‹åº•å±‚å®ç°ï¼Œå°±æ˜¯ç”¨çš„ quicklistï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œæ‰€ä»¥ LPUSH&#47;LPOP&#47;RPUSH&#47;RPOP çš„å¤æ‚åº¦æ˜¯ O(1)<br><br>5ã€List ä¸­æ¯ä¸ª ziplist èŠ‚ç‚¹å¯ä»¥å­˜çš„å…ƒç´ ä¸ªæ•°&#47;æ€»å¤§å°ï¼Œå¯ä»¥é€šè¿‡ list-max-ziplist-size é…ç½®ï¼š<br><br>- æ­£æ•°ï¼šziplist æœ€å¤šåŒ…å«å‡ ä¸ªæ•°æ®é¡¹<br>- è´Ÿæ•°ï¼šå–å€¼ -1 ~ -5ï¼Œè¡¨ç¤ºæ¯ä¸ª ziplist å­˜å‚¨æœ€å¤§çš„å­—èŠ‚æ•°ï¼Œé»˜è®¤ -2ï¼Œæ¯ä¸ªziplist 8KB<br><br>ziplist è¶…è¿‡ä¸Šè¿°ä»»ä¸€é…ç½®ï¼Œæ·»åŠ æ–°å…ƒç´ å°±ä¼šæ–°å»º ziplist æ’å…¥åˆ°é“¾è¡¨ä¸­ã€‚<br><br>6ã€List å› ä¸ºæ›´å¤šæ˜¯ä¸¤å¤´æ“ä½œï¼Œä¸ºäº†èŠ‚çœå†…å­˜ï¼Œè¿˜å¯ä»¥æŠŠä¸­é—´çš„ ziplistã€Œå‹ç¼©ã€ï¼Œå…·ä½“å¯çœ‹ list-compress-depth é…ç½®é¡¹ï¼Œé»˜è®¤é…ç½®ä¸å‹ç¼©<br><br>7ã€è¦æƒ³å½»åº•è§£å†³ ziplist çº§è”æ›´æ–°é—®é¢˜ï¼Œæœ¬è´¨ä¸Šè¦ä¿®æ”¹ ziplist çš„å­˜å‚¨ç»“æ„ï¼Œä¹Ÿå°±æ˜¯ä¸è¦è®©æ¯ä¸ªå…ƒç´ ä¿å­˜ã€Œä¸Šä¸€ä¸ªã€å…ƒç´ çš„é•¿åº¦å³å¯ï¼Œæ‰€ä»¥æ‰æœ‰äº† listpack<br><br>8ã€listpack æ¯ä¸ªå…ƒç´ é¡¹ä¸å†ä¿å­˜ä¸Šä¸€ä¸ªå…ƒç´ çš„é•¿åº¦ï¼Œè€Œæ˜¯ä¼˜åŒ–å…ƒç´ å†…å­—æ®µçš„é¡ºåºï¼Œæ¥ä¿è¯æ—¢å¯ä»¥ä»å‰ä¹Ÿå¯ä»¥å‘åéå†<br><br>9ã€listpack æ˜¯ä¸ºäº†æ›¿ä»£ ziplist ä¸ºè®¾è®¡çš„ï¼Œä½†å› ä¸º List&#47;Hash&#47;Set&#47;ZSet éƒ½ä¸¥é‡ä¾èµ– ziplistï¼Œæ‰€ä»¥è¿™ä¸ªæ›¿æ¢ä¹‹è·¯å¾ˆæ¼«é•¿ï¼Œç›®å‰åªæœ‰ Stream æ•°æ®ç±»å‹ç”¨åˆ°äº† listpack","like_count":36,"discussions":[{"author":{"id":1158363,"avatar":"https://static001.geekbang.org/account/avatar/00/11/ac/db/fb0805dc.jpg","nickname":"é’Ÿä»£å…¶","note":"","ucode":"758C950BC32EE9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":563471,"discussion_content":"listpackå†—ä½™å­˜å‚¨äº†ä¸€ä¸ªæ•°æ®é•¿åº¦æ¥å®ç°æ­£åéå†çš„å§.ä¸€ä¸ªlistpack entry çš„å¤´éƒ¨æ•°æ®é•¿åº¦ç”¨æ¥æ­£å‘éå†. å°¾éƒ¨çš„æ•°æ®é•¿åº¦ç”¨æ¥åå‘éå†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1650002853,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1158363,"avatar":"https://static001.geekbang.org/account/avatar/00/11/ac/db/fb0805dc.jpg","nickname":"é’Ÿä»£å…¶","note":"","ucode":"758C950BC32EE9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":563469,"discussion_content":"è¿é”æ›´æ–°çš„æ¡ä»¶æ˜¯æ¯ä¸ªziplist entryçš„æ•°æ®é•¿åº¦åœ¨249-253æ‰ä¼šè§¦å‘è¿é”æ›´æ–°å§ æ„Ÿè§‰è¿™ä¸ªæ¡ä»¶å…¶å®æ˜¯å¾ˆè‹›åˆ»å§,è¿˜æ˜¯æˆ‘ç†è§£æœ‰é—®é¢˜","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1650002586,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1285509,"avatar":"https://static001.geekbang.org/account/avatar/00/13/9d/85/3931745a.jpg","nickname":"Lourier","note":"","ucode":"701DCDADA3C3E9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":538893,"discussion_content":"ç¬¬9ç‚¹ï¼šsetåº•å±‚æ˜¯intsetå’Œdictå®ç°çš„ï¼Œå¹¶æ²¡æœ‰ä½¿ç”¨åˆ°ziplist","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639549988,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1020042,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","nickname":"Kaito","note":"","ucode":"79775FA35A95F2","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1285509,"avatar":"https://static001.geekbang.org/account/avatar/00/13/9d/85/3931745a.jpg","nickname":"Lourier","note":"","ucode":"701DCDADA3C3E9","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539152,"discussion_content":"æ˜¯çš„ï¼Œæ„Ÿè°¢æŒ‡å‡ºã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639623240,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":538893,"ip_address":""},"score":539152,"extra":""}]},{"author":{"id":1005391,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","nickname":"ä¸€æ­¥","note":"","ucode":"73CEA468CE70C3","race_medal":1,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":387724,"discussion_content":"æ€ä¹ˆå¿«é€Ÿçš„æŸ¥çœ‹ æŸä¸ªæ•°æ®ç±»å‹ä½¿ç”¨äº†å“ªç§æ•°æ®ç»“æ„å‘¢ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628388973,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2187697,"avatar":"https://static001.geekbang.org/account/avatar/00/21/61/b1/8bacdc31.jpg","nickname":"å½“å½“å½“å½“","note":"","ucode":"A5210F5EC47F74","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1005391,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","nickname":"ä¸€æ­¥","note":"","ucode":"73CEA468CE70C3","race_medal":1,"user_type":1,"is_pvip":true},"discussion":{"id":411889,"discussion_content":"debug object [key] æœ‰è¿”å›encoding","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1636027094,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":387724,"ip_address":""},"score":411889,"extra":""}]}]},{"had_liked":false,"id":307311,"user_name":"lzh2nix","can_delete":false,"product_type":"c1","uid":1066191,"ip_address":"","ucode":"2B9AC282082F7D","user_header":"https://static001.geekbang.org/account/avatar/00/10/44/cf/a0315a85.jpg","comment_is_top":false,"comment_ctime":1629022779,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"31693793851","product_id":100084301,"comment_content":"ä»ziplist---&gt;quickListè¿™åœ¨è®¡ç®—æœºé‡Œä¹Ÿæ˜¯ä¸€ä¸ªå¸¸è§çš„è®¾è®¡æ¨¡å¼ã€‚<br><br>ä¸ºäº†é˜²æ­¢å•ä¸ªæ•°æ®è¡¨å¤ªå¤§ï¼Œæˆ‘ä»¬å°†å…¶æ‹†åˆ†æˆå¤šä¸ªæ•°æ®è¡¨ï¼Œä¹Ÿå« [åˆ†æ¡¶è®¾è®¡]ï¼Œæ•°æ®åº“ä¸­çš„shardingï¼Œä»¥åŠå°†ä¸€ä¸ªå¤§ç²’åº¦çš„é”æ‹†åˆ†æˆå¤šä¸ªå°ç²’åº¦çš„é”éƒ½æ˜¯ç±»ä¼¼çš„æ€æƒ³ã€‚","like_count":7},{"had_liked":false,"id":306123,"user_name":"ä¸€æ­¥","can_delete":false,"product_type":"c1","uid":1005391,"ip_address":"","ucode":"73CEA468CE70C3","user_header":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","comment_is_top":false,"comment_ctime":1628393472,"is_pvip":true,"discussion_count":0,"race_medal":1,"score":"18808262656","product_id":100084301,"comment_content":"listpack è§£å†³äº† ziplist è¿é”æ›´æ–°çš„é—®é¢˜ï¼Œä½†æ˜¯è¿˜æ˜¯æ²¡æœ‰è§£å†³å…ƒç´ å¤šçš„æ—¶å€™ï¼ŒæŸ¥è¯¢å¤æ‚åº¦é«˜çš„é—®é¢˜","like_count":4},{"had_liked":false,"id":306182,"user_name":"æ›¾è½¼éºŸ","can_delete":false,"product_type":"c1","uid":1451391,"ip_address":"","ucode":"D418371AC11270","user_header":"https://static001.geekbang.org/account/avatar/00/16/25/7f/473d5a77.jpg","comment_is_top":false,"comment_ctime":1628422957,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"14513324845","product_id":100084301,"comment_content":"å›ç­”è€å¸ˆçš„æé—®ï¼Œziplist èƒ½æ”¯æŒçš„æœ€å¤§æ•´æ•°æ˜¯å¤šå¤§ï¼Ÿ<br><br>åˆ†ææ­¥éª¤ï¼š<br>1ã€æŒ‰ç…§é—®é¢˜èŒƒå›´ï¼Œé¦–å…ˆæˆ‘å»æŸ¥çœ‹äº†zipTryEncodingçš„å®ç°ï¼ˆziplist.cï¼‰ï¼Œå…¶ä¸­åœ¨ç»™encodingèµ‹å€¼çš„æ—¶å€™åˆ’åˆ†äº†ï¼šæå°å€¼ï¼Œint8ï¼Œint16ï¼Œint24ï¼Œint32å’Œint64<br>2ã€æ­¤å¤–å‘ç°å½“valueå¤§äºint32æœ€å¤§å€¼çš„æ—¶å€™ï¼Œä¼šç»Ÿä¸€ä½¿ç”¨ZIP_INT_64Bå»ç¼–ç <br>3ã€ä½†æ˜¯åœ¨zipTryEncodingå¼€å¤´å¤„å‘ç°äº†ä¸€ä¸ªåˆ¤æ–­ï¼Œentrylen &gt;= 32çš„æ—¶å€™æ˜¯ä¸å…è®¸ç¼–ç ï¼Œæ„æ€å°±æ˜¯ä¼ å…¥çš„æ•°æ®å¦‚æœentrylenå¤§äº32ç›´æ¥è·³è¿‡ä¸ç¼–ç ä¸ºint<br>4ã€æœ€åè°ƒç”¨string2llå°è¯•å°†string valueç¼–ç ä¸ºlong long(è½¬æ¢æˆåŠŸä¸º1å¤±è´¥ä¸º0)<br>5ã€è‹¥è½¬æ¢æˆåŠŸï¼Œç¼–ç ç±»å‹æ”¾åˆ°encodingä¸­ï¼Œå€¼æ”¾åˆ°vä¸­<br><br><br>æ ¹æ®ç¬¬ä¸‰æ­¥ä¸ªäººåˆ¤æ–­ï¼Œä¼ å…¥çš„intå€¼å¤§å°ä¸ä¼šè¶…è¿‡32ä½ï¼Œé‚£ä¹ˆæœ€å¤§å€¼åº”è¯¥å°±æ˜¯int32çš„æœ€å¤§å€¼<br>","like_count":3,"discussions":[{"author":{"id":1250775,"avatar":"https://static001.geekbang.org/account/avatar/00/13/15/d7/96e77edd.jpg","nickname":"é—®å¿ƒ","note":"","ucode":"6808568D61CE36","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":559691,"discussion_content":"2çš„32æ¬¡æ–¹æ˜¯2147483647ï¼Œ32ä½å­—ç¬¦ä¸²é•¿åº¦æ˜¯æ¯”2çš„64æ¬¡æ–¹çš„å€¼è½¬å­—ç¬¦ä¸²ä»¥åè¿˜è¦é•¿çš„\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1648883103,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1812201,"avatar":"https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLm8skz4F7FGGBTXWUMia6qVEc00BddeXapicv5FkAx62GmOnUNEcE4scSR60AmappQoNdIQhccKsBA/132","nickname":"æœ«æ—¥ï¼Œæˆæ¬¢","note":"","ucode":"BBAEBB9C93558A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":553572,"discussion_content":"intå€¼çš„é•¿åº¦ä¸ä¼šè¶…è¿‡32ä½ï¼Œ æœ€å¤§å€¼åº”è¯¥ä¸æ˜¯int32","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1645968237,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":335514,"user_name":"Geek_0cfc2d","can_delete":false,"product_type":"c1","uid":2365133,"ip_address":"","ucode":"4E7A034578A19E","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLR2YXdT0AticVATPbtpd1LLOAA0FE1uRJstglZeBs1bAiaPB2PkEnlibIFtUPg1gsseribTib5Oiaw0BBA/132","comment_is_top":false,"comment_ctime":1645547577,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5940514873","product_id":100084301,"comment_content":"è€å¸ˆï¼Œæœ‰ä¸ªé—®é¢˜æƒ³è¯·æ•™ä¸€ä¸‹ï¼š<br>listpack ä¸­å¦‚æœä¸è€ƒè™‘é€†åºæŸ¥è¯¢ï¼Œentry å…¶å®ä½¿ç”¨ encoding+data å°±å¯ä»¥ï¼Œé‚£ entry ä¸­æœ€åä¸€ä¸ª len å…¶å®æ˜¯ä¸ºäº†é€†åºéå†è€ŒåŠ å…¥çš„ï¼Œè¿™æ ·ç†è§£å¯¹å—ï¼Ÿ ","like_count":1},{"had_liked":false,"id":306046,"user_name":"èƒ¡ç²ç²","can_delete":false,"product_type":"c1","uid":1438315,"ip_address":"","ucode":"BA8C5190A13A74","user_header":"https://wx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEI9Fb9tYoBrjUa8zpvOTGibnKYI9fz1QnfXO1Dy5rp5DPJ7nQOHIIXzKOXet3DMqHNYIHJHyz6bm3g/132","comment_is_top":false,"comment_ctime":1628319756,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"5923287052","product_id":100084301,"comment_content":"è¯·é—®ziplistã€quicklistã€listpack è¿™ä¸‰è€…æ˜¯å¦‚ä½•ååŠ©redisçš„æ•°æ®ç±»å‹çš„å‘¢","like_count":1},{"had_liked":false,"id":355793,"user_name":"dawn","can_delete":false,"product_type":"c1","uid":1296063,"ip_address":"æ±Ÿè‹","ucode":"1757B28F1EF5C4","user_header":"https://static001.geekbang.org/account/avatar/00/13/c6/bf/52b3f71d.jpg","comment_is_top":false,"comment_ctime":1661753958,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1661753958","product_id":100084301,"comment_content":"å¦‚æœæ•°æ®å­˜åœ¨è¿ç»­å†…å­˜é‡Œï¼Œé’ˆå¯¹æ’å…¥å’Œåˆ é™¤æ“ä½œï¼Œåªè¦ä¸æ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¸éƒ½éœ€è¦ç»™åç»­çš„èŠ‚ç‚¹é‡æ–°åˆ†é…å†…å­˜åœ°å€å˜›ï¼Œlistpackå¹¶æ²¡æœ‰è§£å†³è¿™ä¸ªé—®é¢˜å•Šï¼Ÿè€Œquicklistè§£å†³è¿™ä¸ªé—®é¢˜æ˜¯æ–¹å¼ï¼Œå®é™…ä¸Šæ˜¯ç”¨äº†é“¾è¡¨è€Œéè¿ç»­ç©ºé—´ï¼Œç‰ºç‰²äº†ç©ºé—´æ¥è§£å†³è¿™ä¸ªäº‹çš„ï¼Œé‚£è¿˜ä¸å¦‚ç›´æ¥å…¨ä¸Šé“¾è¡¨ï¼Œæ ¹æ®ç±»å‹å½’ç±»ä¹ŸæŒºéº»çƒ¦çš„","like_count":0},{"had_liked":false,"id":352385,"user_name":"ğŸ¤","can_delete":false,"product_type":"c1","uid":1804626,"ip_address":"","ucode":"17D997E499E651","user_header":"https://static001.geekbang.org/account/avatar/00/1b/89/52/b96c272d.jpg","comment_is_top":false,"comment_ctime":1658631895,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1658631895","product_id":100084301,"comment_content":"ä½œä¸ºä¸€ä¸ªå†™JAVAçš„ï¼Œæœ‰ç‚¹ç†è§£ä¸äº†è¿™é‡Œ","like_count":0},{"had_liked":false,"id":348652,"user_name":"å­¤ç‹¬æ‚£è€…","can_delete":false,"product_type":"c1","uid":1137910,"ip_address":"","ucode":"4CDD797F355F99","user_header":"https://static001.geekbang.org/account/avatar/00/11/5c/f6/443808f8.jpg","comment_is_top":false,"comment_ctime":1655281460,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1655281460","product_id":100084301,"comment_content":"quicklistï¼Œå¦‚æœæ›´æ–°æŸä¸ªèŠ‚ç‚¹æ•°æ®ï¼Œå¯¼è‡´èŠ‚ç‚¹å†…å­˜å˜å¤§äº†ï¼Œé‚£æ˜¯ä¸æ˜¯å½“å‰èŠ‚ç‚¹çš„åç»­èŠ‚ç‚¹éƒ½è¦å¾€åç§»åŠ¨å‘¢ï¼Ÿå› ä¸ºå†…å­˜æ˜¯è¿ç»­çš„","like_count":0,"discussions":[{"author":{"id":2420294,"avatar":"https://static001.geekbang.org/account/avatar/00/24/ee/46/7d65ae37.jpg","nickname":"æœ¨å‡ ä¸¶","note":"","ucode":"FFDB958DA64F8C","race_medal":5,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576334,"discussion_content":"å½“å‰quicklistNodeçš„ziplistè¿˜æ˜¯å¯èƒ½ä¼šå‘ç”Ÿè¿é”æ›´æ–°ï¼Œæ‰€ä»¥quickliståªæ˜¯ç¼“è§£","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655446638,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":329545,"user_name":"æŸæ²¹","can_delete":false,"product_type":"c1","uid":1604468,"ip_address":"","ucode":"92BFEEEE8BBFA0","user_header":"https://static001.geekbang.org/account/avatar/00/18/7b/74/9b88e040.jpg","comment_is_top":false,"comment_ctime":1641394519,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1641394519","product_id":100084301,"comment_content":"åœ¨è¿é”æ›´æ–°ä»£ç å—ä¸­ï¼Œåªçœ‹åˆ°è°ƒç”¨äº†ä¸€æ¬¡ziplistResizeè¿›è¡Œå†…å­˜é‡åˆ†é…ï¼›åœ¨è¿™ä¹‹å‰ä¼šå°†æ‰€æœ‰è¿é”æ›´æ–°å½±å“çš„entryæ‰¾å‡ºæ¥ï¼Œå¹¶é‡æ–°è®¡ç®—lenï¼Œè¿™æ ·å°±å¯ä»¥ä¸€æ¬¡æ€§è®¡ç®—å¾—åˆ°æ‰€æœ‰éœ€è¦çš„å†…å­˜å¤§å°ï¼Œä¹Ÿå°±æ˜¯åªæœ‰ä¸€æ¬¡ziplistResizeå†…å­˜é‡æ–°åˆ†é…ã€‚ä¸è¿‡ï¼Œå¯èƒ½ä¼šè°ƒç”¨å¤šæ¬¡memmoveæ¥è°ƒæ•´å…ƒç´ çš„ä½ç½®ã€‚<br><br>æ–‡ç« ä¸­ï¼š<br>â€œziplist æ–°å¢æŸä¸ªå…ƒç´ æˆ–ä¿®æ”¹æŸä¸ªå…ƒç´ æ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´åç»­å…ƒç´ çš„ prevlen å ç”¨ç©ºé—´éƒ½å‘ç”Ÿå˜åŒ–ï¼Œä»è€Œå¼•èµ·è¿é”æ›´æ–°é—®é¢˜ï¼Œå¯¼è‡´æ¯ä¸ªå…ƒç´ çš„ç©ºé—´éƒ½è¦é‡æ–°åˆ†é…â€<br><br>æ¯ä¸ªå…ƒç´ éƒ½ä¼šè¿›è¡Œå†…å­˜é‡åˆ†é…æ˜¯ä¸æ˜¯æœ‰é—®é¢˜ï¼Ÿè¿˜æœ›è§£ç­”","like_count":0,"discussions":[{"author":{"id":1604468,"avatar":"https://static001.geekbang.org/account/avatar/00/18/7b/74/9b88e040.jpg","nickname":"æŸæ²¹","note":"","ucode":"92BFEEEE8BBFA0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":544436,"discussion_content":"ä¸‹æ¥åˆçœ‹äº†ä¸‹ï¼Œè€å¸ˆå‚è€ƒçš„æºç ç‰ˆæœ¬æ˜¯5.0.8ï¼Œåœ¨è¿™ä¸€ç‰ˆæœ¬ä¸­ç¡®å®æ˜¯æ¯ä¸ªå‘ç”Ÿå˜åŠ¨çš„å…ƒç´ éƒ½ä¼šè¿›è¡Œå†…å­˜é‡åˆ†é…ï¼Œåœ¨æˆ‘ä¹‹å‰çœ‹çš„6.2ç‰ˆæœ¬ä¸­å·²ç»åªä¼šè¿›è¡Œä¸€æ¬¡é‡åˆ†é…äº†ã€‚å› æ­¤ï¼Œæ–‡ç« ä¸­è¯´çš„ä¹Ÿæ²¡å•¥é—®é¢˜","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641522344,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":314074,"user_name":"è·¯é¥çŸ¥ç åŠ›","can_delete":false,"product_type":"c1","uid":2698825,"ip_address":"","ucode":"1EF9655BEDAFA6","user_header":"https://static001.geekbang.org/account/avatar/00/29/2e/49/a04480a9.jpg","comment_is_top":false,"comment_ctime":1632825681,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1632825681","product_id":100084301,"comment_content":"quicklisté‡Œçš„quicklistnodeå­˜å‚¨ziplistï¼Œæ¯ä¸ªquicklistnodeé‡Œçš„ziplistæ˜¯æ€ä¹ˆæ‹†åˆ†è¿›å…¥ä¸åŒçš„nodeé‡Œçš„ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":2698825,"avatar":"https://static001.geekbang.org/account/avatar/00/29/2e/49/a04480a9.jpg","nickname":"è·¯é¥çŸ¥ç åŠ›","note":"","ucode":"1EF9655BEDAFA6","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":399081,"discussion_content":"ä»¥å•ä¸ª ziplist æ˜¯å¦ä¸è¶…è¿‡ 8KBæ¥åˆ¤æ–­æ˜¯å¦åˆ›å»ºæ–°çš„node","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632904144,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":310548,"user_name":"test","can_delete":false,"product_type":"c1","uid":1065849,"ip_address":"","ucode":"9A4973E591DD12","user_header":"https://static001.geekbang.org/account/avatar/00/10/43/79/18073134.jpg","comment_is_top":false,"comment_ctime":1630734945,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1630734945","product_id":100084301,"comment_content":"entey-encodingç®—æ˜¯å“ˆå¤«æ›¼ç¼–ç ï¼Ÿ","like_count":0},{"had_liked":false,"id":310543,"user_name":"å˜‰æœ¨","can_delete":false,"product_type":"c1","uid":1317999,"ip_address":"","ucode":"AF4877693782C0","user_header":"https://static001.geekbang.org/account/avatar/00/14/1c/6f/3ea2a599.jpg","comment_is_top":false,"comment_ctime":1630731308,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1630731308","product_id":100084301,"comment_content":"unsigned long lpEncodeBacklen(unsigned char *buf, uint64_t l) { <br>\t&#47;&#47;ç¼–ç ç±»å‹å’Œå®é™…æ•°æ®çš„æ€»é•¿åº¦å°äºç­‰äº127ï¼Œentry-lené•¿åº¦ä¸º1å­—èŠ‚ <br>\tif (l &lt;= 127) { ... return 1; } <br>\telse if (l &lt; 16383) { &#47;&#47;ç¼–ç ç±»å‹å’Œå®é™…æ•°æ®çš„æ€»é•¿åº¦å¤§äº127ä½†å°äº16383ï¼Œentry-lené•¿åº¦ä¸º2å­—èŠ‚ ... return 2; } <br>\telse if (l &lt; 2097151) {&#47;&#47;ç¼–ç ç±»å‹å’Œå®é™…æ•°æ®çš„æ€»é•¿åº¦å¤§äº16383ä½†å°äº2097151ï¼Œentry-lené•¿åº¦ä¸º3å­—èŠ‚ ... return 3; } <br>\telse if (l &lt; 268435455) { &#47;&#47;ç¼–ç ç±»å‹å’Œå®é™…æ•°æ®çš„æ€»é•¿åº¦å¤§äº2097151ä½†å°äº268435455ï¼Œentry-lené•¿åº¦ä¸º4å­—èŠ‚ ... return 4; } <br>\telse { &#47;&#47;å¦åˆ™ï¼Œentry-lené•¿åº¦ä¸º5å­—èŠ‚ ... return 5; }<br>}<br><br>è€å¸ˆæ‚¨å¥½ï¼Œ<br>å¯¹äºbacklençš„ç¼–ç è®¡ç®—è¿™æ®µä»£ç æœ‰ç‚¹ç–‘æƒ‘ï¼š<br>é™¤äº†ç¬¬ä¸€ä¸ªifåˆ¤æ–­æ˜¯&lt;=ä¹‹å¤–ï¼Œåé¢çš„ifåˆ¤æ–­ä¸ºä»€ä¹ˆæ˜¯&lt;ï¼Œè€Œä¸æ˜¯&lt;=äº†å‘¢ï¼Ÿ <br>æ¯”å¦‚16383ï¼ŒæŒ‰ç…§&lt;=åˆ¤æ–­ï¼Œç¼–ç ä¸º7f ffï¼Œæœ€é«˜ä½ä¸º0ï¼Œè¡¨ç¤ºä¸‹ä¸ªå­—èŠ‚ä¸å±äºbacklenï¼Œè¿™æ ·backlenåªä½¿ç”¨2ä¸ªå­—èŠ‚ï¼›<br>ä½†æ˜¯æŒ‰ç…§æºç é€»è¾‘çš„è¯ï¼Œ16383ç¼–ç ä¸º00 ff ffäº†ï¼Œbacklenä½¿ç”¨äº†3ä¸ªå­—èŠ‚ï¼Œè¿™æ ·çš„è¯ä¸æ˜¯æµªè´¹äº†ä¸€ä¸ªå­—èŠ‚å—ï¼Ÿ<br>","like_count":0,"discussions":[{"author":{"id":1808868,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/99/e4/3def9888.jpg","nickname":"?? skywalker","note":"","ucode":"308046121D5C6E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":555454,"discussion_content":"ä½ æœ‰ç­”æ¡ˆäº†å—ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1646910286,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":308708,"user_name":"æ…¢åŠ¨ä½œ","can_delete":false,"product_type":"c1","uid":1133945,"ip_address":"","ucode":"62C944F4A4D8AC","user_header":"https://static001.geekbang.org/account/avatar/00/11/4d/79/803537db.jpg","comment_is_top":false,"comment_ctime":1629765866,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1629765866","product_id":100084301,"comment_content":"listpackæœ‰å¯¹åº”çš„quicklistå—ï¼Ÿæ•°ç»„ç±»å‹å­˜å‚¨æœ‰æœ€ä¼˜å¤§å°å§ï¼Œè¿‡å¤§ä»¥åä¸­é—´æ’å…¥ä»£ä»·ä¼šå¾ˆå¤§ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1053509,"avatar":"https://static001.geekbang.org/account/avatar/00/10/13/45/16c60da2.jpg","nickname":"@%åˆ%@","note":"","ucode":"2B8A6134675ED7","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":404516,"discussion_content":"listpackç›®å‰ç”¨åœ¨redisçš„streamç»“æ„æ¶ˆæ¯ä¸­ï¼Œæ¶ˆæ¯åªæ˜¯å°¾éƒ¨appendï¼Œä¸ä¼šå‡ºç°ä¸­é—´çš„æ’å…¥çš„é—®é¢˜ï¼Œè¿™æ°æ°è¯´æ˜äº†ï¼Œredisæ˜¯åœ¨åˆé€‚çš„åœºæ™¯ä¸­ï¼Œä½¿ç”¨åˆé€‚çš„æ•°æ®ç»“æ„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634312993,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":307149,"user_name":"Miroticwillbeforever","can_delete":false,"product_type":"c1","uid":2488913,"ip_address":"","ucode":"1DDD8AECD93EA8","user_header":"https://static001.geekbang.org/account/avatar/00/25/fa/51/5da91010.jpg","comment_is_top":false,"comment_ctime":1628910200,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1628910200","product_id":100084301,"comment_content":"åœ¨æœ‰å…³ listpack çš„æ­£å‘æŸ¥è¯¢å›¾ä¸­ï¼Œç¬¬äºŒæ­¥ 2.lpFirst è°ƒç”¨ lpSkip æ˜¯å¦æ˜¯é”™è¯¯å‘¢ï¼Ÿç¬¬ä¸€æ­¥è°ƒç”¨ lpNext,æ­¤æ—¶å·²ç»è¿›å…¥ lpNext å‡½æ•°äº†ï¼Œè€Œ lpFirst æ˜¯å°†æŒ‡é’ˆæŒ‡åˆ°ç¬¬ä¸€ä¸ªåˆ—è¡¨é¡¹å°±è¿”å›ã€‚æ‰€ä»¥æˆ‘è§‰å¾—è¿™é‡Œå¯ä»¥åšä¸ªä¿®æ­£ã€‚ã€‚ã€‚","like_count":0},{"had_liked":false,"id":306957,"user_name":"èµµå°æ´›","can_delete":false,"product_type":"c1","uid":1592232,"ip_address":"","ucode":"A326C12B1A1ABA","user_header":"https://static001.geekbang.org/account/avatar/00/18/4b/a8/14b8a860.jpg","comment_is_top":false,"comment_ctime":1628812194,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1628812194","product_id":100084301,"comment_content":"è€å¸ˆè¿˜æ˜¯æœ‰ç‚¹å¬ä¸å¤ªæ‡‚ï¼Œæœ‰æ²¡æœ‰è¾…åŠ©çš„ä¹¦","like_count":0},{"had_liked":false,"id":306524,"user_name":"iron bo","can_delete":false,"product_type":"c1","uid":2094925,"ip_address":"","ucode":"4BFB1331637AA3","user_header":"https://static001.geekbang.org/account/avatar/00/1f/f7/4d/09554c96.jpg","comment_is_top":false,"comment_ctime":1628596089,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1628596089","product_id":100084301,"comment_content":"åœ¨zipTryEncodingä¸­ï¼Œç¬¬ä¸€ä¸ªåˆ¤æ–­æ˜¯ï¼š<br> if (entrylen &gt;= 32 || entrylen == 0) return 0;<br>è¿™ä¸ªåˆ¤æ–­ä¸­entrylen æ˜¯æŒ‡çš„æ•´æ•°çš„é•¿åº¦ï¼Œä¸æ˜¯äºŒè¿›åˆ¶çš„é•¿åº¦ï¼Œæ‰€ä»¥è¿™é‡Œåˆ¤æ–­çš„æ˜¯è¿™ä¸ªæ•´æ•°çš„é•¿åº¦æ˜¯å¦è¶…è¿‡32ä½ï¼Œå¦‚æœè¶…è¿‡äº†å°±ç”¨strçš„å½¢å¼ç¼–ç <br>ç¬¬äºŒä¸ªåˆ¤æ–­æ˜¯ï¼š<br>if (string2ll((char*)entry,entrylen,&amp;value))<br>æŸ¥è¯¢string2llå‡½æ•°æ‰€èƒ½è¡¨ç¤ºçš„æœ€å¤§å€¼æ˜¯ULLONG_MAXï¼Œå¦‚æœè¶…è¿‡äº†å°±ç”¨strçš„å½¢å¼ç¼–ç <br>æ­¤æ—¶*encoding = ZIP_INT_64B ä¹Ÿå°±æ˜¯8ä¸ªå­—èŠ‚ï¼Œå’Œlong longç±»å‹çš„å­—èŠ‚æ•°ä¸€è‡´<br>ä¸¤ä¸ªåˆ¤æ–­å–è¾ƒå°å€¼ï¼Œå³ULLONG_MAXï¼Œä½†æ˜¯ç”±äºvalueæ˜¯æœ‰ç¬¦å·çš„ï¼Œå³ä¸ºLLONG_MAX 0x7fffffffffffffffLL<br><br>æˆ‘æœ‰ä¸€ä¸ªç–‘é—®ï¼Œå½“valueçš„å€¼åœ¨LLONG_MAXå’ŒULLONG_MAXä¹‹é—´ï¼Œstring2llå‡½æ•°ä¼šè¿”å›trueï¼Œå¦‚æœç”¨ZIP_INT_64Bè¡¨ç¤ºï¼Œé‚£ç¬¦å·ä½å°±æ²¡æœ‰äº†ï¼Œè¿™ä¼šä¸ä¼šæœ‰é—®é¢˜ï¼Ÿ<br>","like_count":0},{"had_liked":false,"id":306517,"user_name":"å€ªå¤§äºº","can_delete":false,"product_type":"c1","uid":1193052,"ip_address":"","ucode":"4798D69F3E86FB","user_header":"https://static001.geekbang.org/account/avatar/00/12/34/5c/6b4757a0.jpg","comment_is_top":false,"comment_ctime":1628591224,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1628591224","product_id":100084301,"comment_content":"çœ‹äº†ä¸‹zipTryEncodingçš„å®ç°<br> if (entrylen &gt;= 32 || entrylen == 0) return 0;<br>è¿™è¡Œä»£ç çš„æ„æ€åº”è¯¥æ˜¯ä¼ å…¥çš„å­—ç¬¦ä¸²é•¿åº¦â‰¥32æˆ–ä¸º0ï¼Œå°±ä¸è®¤ä¸ºæ˜¯æ•°å­—ï¼Œç›´æ¥æŒ‰å­—ç¬¦ä¸²å¤„ç†<br>åˆçœ‹äº†ä¸€ä¸‹__ziplistInsertï¼Œè°ƒç”¨zipTryEncodingä¹‹åä¼šè°ƒç”¨zipIntSizeç®—éœ€è¦å¤šå°‘å­—èŠ‚å­˜æ•°å­—ï¼Œæœ€å¤§8ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥è¯¾åé¢˜èƒ½æ”¯æŒçš„æœ€å¤§æ•´æ•°åº”è¯¥æ˜¯2^64","like_count":0},{"had_liked":false,"id":306160,"user_name":"äº‘æµ·","can_delete":false,"product_type":"c1","uid":1365206,"ip_address":"","ucode":"0C6CA0BE58EA21","user_header":"https://static001.geekbang.org/account/avatar/00/14/d4/d6/1d4543ac.jpg","comment_is_top":false,"comment_ctime":1628412461,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1628412461","product_id":100084301,"comment_content":"ziplist<br>ä¼˜ç‚¹ï¼š<br>1. ã€èŠ‚çœå†…å­˜ã€‘å†…å­˜ç´§å‡‘å‹çš„æ•°æ®ç»“æ„ï¼Œä¸å­˜å‚¨å‰åèŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œå ç”¨ä¸€å—è¿ç»­çš„å†…å­˜ç©ºé—´ï¼›<br>ç¼ºç‚¹ï¼š<br>1. ã€æŸ¥æ‰¾å¤æ‚åº¦é«˜ã€‘ziplist å…ƒç´ è¿‡å¤šæ—¶ï¼Œè®¿é—®æ€§èƒ½ä¼šé™ä½ï¼›<br>2. ã€æ½œåœ¨çš„è¿é”æ›´æ–°é£é™©ã€‘ä¸èƒ½ä¿å­˜è¿‡å¤§çš„å…ƒç´ ï¼Œå¦åˆ™æ–°å¢æˆ–ä¿®æ”¹æ•°æ®æ—¶ï¼Œå®¹æ˜“å¯¼è‡´å†…å­˜é‡æ–°åˆ†é…ï¼Œç”šè‡³å¯èƒ½å¼•å‘è¿é”æ›´æ–°çš„é—®é¢˜ã€‚<br><br>quicklist<br>ä¼˜ç‚¹ï¼š<br>1. ç»“åˆäº†é“¾è¡¨å’Œ ziplist å„è‡ªçš„ä¼˜åŠ¿ï¼›<br>2. ä¸€ä¸ª quicklist å°±æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œè€Œé“¾è¡¨ä¸­çš„æ¯ä¸ªå…ƒç´ åˆæ˜¯ä¸€ä¸ª ziplistï¼›<br>3. quicklist é€šè¿‡æ§åˆ¶æ¯ä¸ª quicklistNode ä¸­ ziplist çš„å¤§å°æˆ–æ˜¯å…ƒç´ ä¸ªæ•°ï¼Œå°±æœ‰æ•ˆå‡å°‘äº†åœ¨ ziplist ä¸­æ–°å¢æˆ–ä¿®æ”¹å…ƒç´ åï¼Œå‘ç”Ÿè¿é”æ›´æ–°çš„æƒ…å†µï¼Œä»è€Œæä¾›äº†æ›´å¥½çš„è®¿é—®æ€§èƒ½ã€‚<br>ç¼ºç‚¹ï¼š<br>1. ã€æ½œåœ¨çš„è¿é”æ›´æ–°é£é™©ã€‘æœ‰æ•ˆå‡å°‘ä½†æœªå®Œå…¨é¿å…ï¼›<br>2. ã€å†…å­˜å¼€é”€å¤§ã€‘quicklist ä½¿ç”¨ quicklistNode ç»“æ„æŒ‡å‘æ¯ä¸ª ziplistï¼›<br><br>listpack<br>ä¼˜ç‚¹ï¼š<br>1. ã€èŠ‚çœå†…å­˜ã€‘ç”¨ä¸€å—è¿ç»­çš„å†…å­˜ç©ºé—´æ¥ç´§å‡‘åœ°ä¿å­˜æ•°æ®ï¼›<br>2. ä¸ºäº†ã€è¿›ä¸€æ­¥èŠ‚çœå†…å­˜ç©ºé—´ã€‘ï¼Œlistpack å…ƒç´ ä¼šå¯¹ä¸åŒé•¿åº¦çš„æ•´æ•°å’Œå­—ç¬¦ä¸²è¿›è¡Œä¸åŒçš„ç¼–ç ï¼›<br>3. ã€é¿å…è¿é”æ›´æ–°ã€‘ï¼›","like_count":0},{"had_liked":false,"id":306076,"user_name":"Geek_f71330","can_delete":false,"product_type":"c1","uid":1617615,"ip_address":"","ucode":"40F8CD661E8F59","user_header":"https://static001.geekbang.org/account/avatar/00/18/ae/cf/6186d936.jpg","comment_is_top":false,"comment_ctime":1628329457,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1628329457","product_id":100084301,"comment_content":"è¯¾åé¢˜ï¼š<br>1. å‡½æ•°ä¸­å…ˆåˆ¤æ–­entrylenï¼Œè¾¾åˆ°32ç¼–ç åˆ™è¿”å›0,ç¼–ç å¤±è´¥ã€‚if (entrylen &gt;= 32 || entrylen == 0) return 0;<br>2. å…¶æ¬¡*encoding æœ€å¤§ä¸º #define ZIP_INT_64B (0xc0 | 2&lt;&lt;4)ï¼Œå³11000000 | 00100000 == 11100000 == 224<br>3. value ç±»å‹ä¸º long longï¼Œ8ä¸ªå­—èŠ‚æ•°ï¼Œä¸€å…±64ä½ã€‚<br><br>ç¬¬2ä¸ªå¼å­æˆ‘è¿˜ä¸æ˜¯å¾ˆæ˜ç™½ï¼Œæ²¡æœ‰ææ‡‚ç¼–ç encodingçš„å•ä½ï¼Œæ˜¯ä½è¿˜æ˜¯ä»€ä¹ˆï¼Ÿ<br><br>ä¸‰è€…å–æœ€å°ï¼Œåº”è¯¥å°±æ˜¯æœ€å¤šåªèƒ½ä¿å­˜31ä½ï¼Œåˆ™æ•´æ•°æœ€å¤§å€¼2*31 - 1<br>","like_count":0},{"had_liked":false,"id":306072,"user_name":"Geek_f71330","can_delete":false,"product_type":"c1","uid":1617615,"ip_address":"","ucode":"40F8CD661E8F59","user_header":"https://static001.geekbang.org/account/avatar/00/18/ae/cf/6186d936.jpg","comment_is_top":false,"comment_ctime":1628328009,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1628328009","product_id":100084301,"comment_content":"- ziplist è¿ç»­ã€ç´§å‡‘ï¼Œé€‰ç”¨æœ€å°çš„é•¿åº¦ç¼–ç ä¿å­˜ä¸Šä¸€ä¸ªå…ƒç´ çš„é•¿åº¦ï¼Œè¿™æ˜¯èŠ‚çº¦å†…å­˜çš„é‡ç‚¹ï¼ŒåŒæ ·ä¹Ÿæ˜¯å› ä¸ºè¿™ä¸ªâ€œä¿å­˜ä¸Šä¸€ä¸ªå…ƒç´ é•¿åº¦â€çš„prevlenï¼Œåœ¨æ›´æ–°æ—¶éœ€è¦åšåˆ°æ›´æ–°ï¼Œå¯¼è‡´çš„çº§è”æ›´æ–°ã€‚<br>- quicklist ä¸ºäº†è§£å†³zipilistçº§è”æ›´æ–°çš„å½±å“ï¼Œç›¸å½“äºå¤šä¸€ç‚¹å†…å­˜å¼€é”€ï¼Œåˆ†å‰²å¤šæ®µziplistï¼Œç”¨quicklistNodeæ¥è®°å½•èŠ‚ç‚¹ï¼Œä½¿å¾—ä¸€ä¸ªèŠ‚ç‚¹å†…çš„ziplistå³ä½¿å‘ç”Ÿçº§è”æ›´æ–°ï¼Œå½±å“èŒƒå›´ä¹Ÿä¼šæœ‰é™ã€‚<br>- listpack çš„æ•°æ®ç»“æ„å‘ç”Ÿçš„å˜åŒ–å°±ç›¸å¯¹æ›´å¤§äº†ï¼Œå…¶ä¸è®°å½•ä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„é•¿åº¦ï¼Œä»æ ¹æœ¬ä¸Šè§£å†³äº†çº§è”æ›´æ–°çš„é—®é¢˜ã€‚åŒæ—¶ï¼Œå…¶éå†çš„æ–¹æ³•ä¹Ÿå‘ç”Ÿäº†å˜åŒ–ã€‚","like_count":0},{"had_liked":false,"id":306061,"user_name":"Ethan New","can_delete":false,"product_type":"c1","uid":2063962,"ip_address":"","ucode":"9CA2EF39E58030","user_header":"https://static001.geekbang.org/account/avatar/00/1f/7e/5a/da39f489.jpg","comment_is_top":false,"comment_ctime":1628324977,"is_pvip":true,"discussion_count":0,"race_medal":4,"score":"1628324977","product_id":100084301,"comment_content":"è¿™ä¸ªä¸“æ å¤ªå€¼äº†ï¼Œå¹²è´§æ»¡æ»¡","like_count":0}]}