{"id":97463,"title":"26 | å†…æ ¸æ€å†…å­˜æ˜ å°„ï¼šå¦‚ä½•æ‰¾åˆ°æ­£ç¡®çš„ä¼šè®®å®¤ï¼Ÿ","content":"<p>å‰é¢è®²ç”¨æˆ·æ€å†…å­˜æ˜ å°„æœºåˆ¶çš„æ—¶å€™ï¼Œæˆ‘ä»¬å·²ç»å¤šæ¬¡å¼•ç”³å‡ºäº†å†…æ ¸çš„æ˜ å°„æœºåˆ¶ï¼Œä½†æ˜¯å’±ä»¬éƒ½æš‚æ—¶æ”¾äº†æ”¾ï¼Œè¿™ä¸€èŠ‚æˆ‘ä»¬å°±æ¥è¯¦ç»†è§£æä¸€ä¸‹ï¼Œè®©ä½ å½»åº•ææ‡‚å®ƒã€‚</p><p>é¦–å…ˆï¼Œä½ è¦çŸ¥é“ï¼Œå†…æ ¸æ€çš„å†…å­˜æ˜ å°„æœºåˆ¶ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š</p><ul>\n<li>\n<p>å†…æ ¸æ€å†…å­˜æ˜ å°„å‡½æ•°vmallocã€kmap_atomicæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼›</p>\n</li>\n<li>\n<p>å†…æ ¸æ€é¡µè¡¨æ˜¯æ”¾åœ¨å“ªé‡Œçš„ï¼Œå¦‚ä½•å·¥ä½œçš„ï¼Ÿswapper_pg_diræ˜¯æ€ä¹ˆå›äº‹ï¼›</p>\n</li>\n<li>\n<p>å‡ºç°äº†å†…æ ¸æ€ç¼ºé¡µå¼‚å¸¸åº”è¯¥æ€ä¹ˆåŠï¼Ÿ</p>\n</li>\n</ul><h2>å†…æ ¸é¡µè¡¨</h2><p>å’Œç”¨æˆ·æ€é¡µè¡¨ä¸åŒï¼Œåœ¨ç³»ç»Ÿåˆå§‹åŒ–çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±è¦åˆ›å»ºå†…æ ¸é¡µè¡¨äº†ã€‚</p><p>æˆ‘ä»¬ä»å†…æ ¸é¡µè¡¨çš„æ ¹swapper_pg_dirå¼€å§‹æ‰¾çº¿ç´¢ï¼Œåœ¨arch/x86/include/asm/pgtable_64.hä¸­å°±èƒ½æ‰¾åˆ°å®ƒçš„å®šä¹‰ã€‚</p><pre><code>extern pud_t level3_kernel_pgt[512];\nextern pud_t level3_ident_pgt[512];\nextern pmd_t level2_kernel_pgt[512];\nextern pmd_t level2_fixmap_pgt[512];\nextern pmd_t level2_ident_pgt[512];\nextern pte_t level1_fixmap_pgt[512];\nextern pgd_t init_top_pgt[];\n\n\n#define swapper_pg_dir init_top_pgt\n</code></pre><p>swapper_pg_diræŒ‡å‘å†…æ ¸æœ€é¡¶çº§çš„ç›®å½•pgdï¼ŒåŒæ—¶å‡ºç°çš„è¿˜æœ‰å‡ ä¸ªé¡µè¡¨ç›®å½•ã€‚æˆ‘ä»¬å¯ä»¥å›å¿†ä¸€ä¸‹ï¼Œ64ä½ç³»ç»Ÿçš„è™šæ‹Ÿåœ°å€ç©ºé—´çš„å¸ƒå±€ï¼Œå…¶ä¸­XXX_ident_pgtå¯¹åº”çš„æ˜¯ç›´æ¥æ˜ å°„åŒºï¼ŒXXX_kernel_pgtå¯¹åº”çš„æ˜¯å†…æ ¸ä»£ç åŒºï¼ŒXXX_fixmap_pgtå¯¹åº”çš„æ˜¯å›ºå®šæ˜ å°„åŒºã€‚</p><p>å®ƒä»¬æ˜¯åœ¨å“ªé‡Œåˆå§‹åŒ–çš„å‘¢ï¼Ÿåœ¨æ±‡ç¼–è¯­è¨€çš„æ–‡ä»¶é‡Œé¢çš„arch\\x86\\kernel\\head_64.Sã€‚è¿™æ®µä»£ç æ¯”è¾ƒéš¾çœ‹æ‡‚ï¼Œä½ åªè¦æ˜ç™½å®ƒæ˜¯å¹²ä»€ä¹ˆçš„å°±è¡Œäº†ã€‚</p><!-- [[[read_end]]] --><pre><code>__INITDATA\n\n\nNEXT_PAGE(init_top_pgt)\n\t.quad   level3_ident_pgt - __START_KERNEL_map + _KERNPG_TABLE\n\t.org    init_top_pgt + PGD_PAGE_OFFSET*8, 0\n\t.quad   level3_ident_pgt - __START_KERNEL_map + _KERNPG_TABLE\n\t.org    init_top_pgt + PGD_START_KERNEL*8, 0\n\t/* (2^48-(2*1024*1024*1024))/(2^39) = 511 */\n\t.quad   level3_kernel_pgt - __START_KERNEL_map + _PAGE_TABLE\n\n\nNEXT_PAGE(level3_ident_pgt)\n\t.quad\tlevel2_ident_pgt - __START_KERNEL_map + _KERNPG_TABLE\n\t.fill\t511, 8, 0\nNEXT_PAGE(level2_ident_pgt)\n\t/* Since I easily can, map the first 1G.\n\t * Don't set NX because code runs from these pages.\n\t */\n\tPMDS(0, __PAGE_KERNEL_IDENT_LARGE_EXEC, PTRS_PER_PMD)\n\n\nNEXT_PAGE(level3_kernel_pgt)\n\t.fill\tL3_START_KERNEL,8,0\n\t/* (2^48-(2*1024*1024*1024)-((2^39)*511))/(2^30) = 510 */\n\t.quad\tlevel2_kernel_pgt - __START_KERNEL_map + _KERNPG_TABLE\n\t.quad\tlevel2_fixmap_pgt - __START_KERNEL_map + _PAGE_TABLE\n\n\nNEXT_PAGE(level2_kernel_pgt)\n\t/*\n\t * 512 MB kernel mapping. We spend a full page on this pagetable\n\t * anyway.\n\t *\n\t * The kernel code+data+bss must not be bigger than that.\n\t *\n\t * (NOTE: at +512MB starts the module area, see MODULES_VADDR.\n\t *  If you want to increase this then increase MODULES_VADDR\n\t *  too.)\n\t */\n\tPMDS(0, __PAGE_KERNEL_LARGE_EXEC,\n\t\tKERNEL_IMAGE_SIZE/PMD_SIZE)\n\n\nNEXT_PAGE(level2_fixmap_pgt)\n\t.fill\t506,8,0\n\t.quad\tlevel1_fixmap_pgt - __START_KERNEL_map + _PAGE_TABLE\n\t/* 8MB reserved for vsyscalls + a 2MB hole = 4 + 1 entries */\n\t.fill\t5,8,0\n\n\nNEXT_PAGE(level1_fixmap_pgt)\n\t.fill\t51\n</code></pre><p>å†…æ ¸é¡µè¡¨çš„é¡¶çº§ç›®å½•init_top_pgtï¼Œå®šä¹‰åœ¨__INITDATAé‡Œé¢ã€‚å’±ä»¬è®²è¿‡ELFçš„æ ¼å¼ï¼Œä¹Ÿè®²è¿‡è™šæ‹Ÿå†…å­˜ç©ºé—´çš„å¸ƒå±€ã€‚å®ƒä»¬éƒ½æœ‰ä»£ç æ®µï¼Œè¿˜æœ‰ä¸€äº›åˆå§‹åŒ–äº†çš„å…¨å±€å˜é‡ï¼Œæ”¾åœ¨.initåŒºåŸŸã€‚è¿™äº›è¯´çš„å°±æ˜¯è¿™ä¸ªåŒºåŸŸã€‚å¯ä»¥çœ‹åˆ°ï¼Œé¡µè¡¨çš„æ ¹å…¶å®æ˜¯å…¨å±€å˜é‡ï¼Œè¿™å°±ä½¿å¾—æˆ‘ä»¬åˆå§‹åŒ–çš„æ—¶å€™ï¼Œç”šè‡³å†…å­˜ç®¡ç†è¿˜æ²¡æœ‰åˆå§‹åŒ–çš„æ—¶å€™ï¼Œå¾ˆå®¹æ˜“å°±å¯ä»¥å®šä½åˆ°ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œå®šä¹‰init_top_pgtåŒ…å«å“ªäº›é¡¹ï¼Œè¿™ä¸ªæ±‡ç¼–ä»£ç æ¯”è¾ƒéš¾æ‡‚äº†ã€‚ä½ å¯ä»¥ç®€å•åœ°è®¤ä¸ºï¼Œquadæ˜¯å£°æ˜äº†ä¸€é¡¹çš„å†…å®¹ï¼Œorgæ˜¯è·³åˆ°äº†æŸä¸ªä½ç½®ã€‚</p><p>æ‰€ä»¥ï¼Œinit_top_pgtæœ‰ä¸‰é¡¹ï¼Œä¸Šæ¥å…ˆæœ‰ä¸€é¡¹ï¼ŒæŒ‡å‘çš„æ˜¯level3_ident_pgtï¼Œä¹Ÿå³ç›´æ¥æ˜ å°„åŒºé¡µè¡¨çš„ä¸‰çº§ç›®å½•ã€‚ä¸ºä»€ä¹ˆè¦å‡å»__START_KERNEL_mapå‘¢ï¼Ÿå› ä¸ºlevel3_ident_pgtæ˜¯å®šä¹‰åœ¨å†…æ ¸ä»£ç é‡Œçš„ï¼Œå†™ä»£ç çš„æ—¶å€™ï¼Œå†™çš„éƒ½æ˜¯è™šæ‹Ÿåœ°å€ï¼Œè°å†™ä»£ç çš„æ—¶å€™ä¹Ÿä¸çŸ¥é“å°†æ¥åŠ è½½çš„ç‰©ç†åœ°å€æ˜¯å¤šå°‘å‘€ï¼Œå¯¹ä¸å¯¹ï¼Ÿ</p><p>å› ä¸ºlevel3_ident_pgtæ˜¯åœ¨è™šæ‹Ÿåœ°å€çš„å†…æ ¸ä»£ç æ®µé‡Œçš„ï¼Œè€Œ__START_KERNEL_mapæ­£æ˜¯è™šæ‹Ÿåœ°å€ç©ºé—´çš„å†…æ ¸ä»£ç æ®µçš„èµ·å§‹åœ°å€ï¼Œè¿™åœ¨è®²64ä½è™šæ‹Ÿåœ°å€ç©ºé—´çš„æ—¶å€™éƒ½è®²è¿‡äº†ï¼Œè¦æ˜¯æƒ³ä¸èµ·æ¥å°±èµ¶ç´§å»å›é¡¾ä¸€ä¸‹ã€‚è¿™æ ·ï¼Œlevel3_ident_pgtå‡å»__START_KERNEL_mapæ‰æ˜¯ç‰©ç†åœ°å€ã€‚</p><p>ç¬¬ä¸€é¡¹å®šä¹‰å®Œäº†ä»¥åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è·³åˆ°PGD_PAGE_OFFSETçš„ä½ç½®ï¼Œå†å®šä¹‰ä¸€é¡¹ã€‚ä»å®šä¹‰å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸€é¡¹å°±åº”è¯¥æ˜¯__PAGE_OFFSET_BASEå¯¹åº”çš„ã€‚__PAGE_OFFSET_BASEæ˜¯è™šæ‹Ÿåœ°å€ç©ºé—´é‡Œé¢å†…æ ¸çš„èµ·å§‹åœ°å€ã€‚ç¬¬äºŒé¡¹ä¹ŸæŒ‡å‘level3_ident_pgtï¼Œç›´æ¥æ˜ å°„åŒºã€‚</p><pre><code>PGD_PAGE_OFFSET = pgd_index(__PAGE_OFFSET_BASE)\nPGD_START_KERNEL = pgd_index(__START_KERNEL_map)\nL3_START_KERNEL = pud_index(__START_KERNEL_map)\n</code></pre><p>ç¬¬äºŒé¡¹å®šä¹‰å®Œäº†ä»¥åï¼Œæ¥ä¸‹æ¥è·³åˆ°PGD_START_KERNELçš„ä½ç½®ï¼Œå†å®šä¹‰ä¸€é¡¹ã€‚ä»å®šä¹‰å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸€é¡¹åº”è¯¥æ˜¯__START_KERNEL_mapå¯¹åº”çš„é¡¹ï¼Œ__START_KERNEL_mapæ˜¯è™šæ‹Ÿåœ°å€ç©ºé—´é‡Œé¢å†…æ ¸ä»£ç æ®µçš„èµ·å§‹åœ°å€ã€‚ç¬¬ä¸‰é¡¹æŒ‡å‘level3_kernel_pgtï¼Œå†…æ ¸ä»£ç åŒºã€‚</p><p>æ¥ä¸‹æ¥çš„ä»£ç å°±å¾ˆç±»ä¼¼äº†ï¼Œå°±æ˜¯åˆå§‹åŒ–ä¸ªè¡¨é¡¹ï¼Œç„¶åæŒ‡å‘ä¸‹ä¸€çº§ç›®å½•ï¼Œæœ€ç»ˆå½¢æˆä¸‹é¢è¿™å¼ å›¾ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/78/6d/78c8d44d7d8c08c03eee6f7a94652d6d.png?wh=2188*2623\" alt=\"\"></p><p>å†…æ ¸é¡µè¡¨å®šä¹‰å®Œäº†ï¼Œä¸€å¼€å§‹è¿™é‡Œé¢çš„é¡µè¡¨èƒ½å¤Ÿè¦†ç›–çš„å†…å­˜èŒƒå›´æ¯”è¾ƒå°ã€‚ä¾‹å¦‚ï¼Œå†…æ ¸ä»£ç åŒº512Mï¼Œç›´æ¥æ˜ å°„åŒº1Gã€‚è¿™ä¸ªæ—¶å€™ï¼Œå…¶å®åªè¦èƒ½å¤Ÿæ˜ å°„åŸºæœ¬çš„å†…æ ¸ä»£ç å’Œæ•°æ®ç»“æ„å°±å¯ä»¥äº†ã€‚å¯ä»¥çœ‹å‡ºï¼Œé‡Œé¢è¿˜ç©ºç€å¾ˆå¤šé¡¹ï¼Œå¯ä»¥ç”¨äºå°†æ¥æ˜ å°„å·¨å¤§çš„å†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œç­‰ç”¨åˆ°çš„æ—¶å€™å†è¿›è¡Œæ˜ å°„ã€‚</p><p>å¦‚æœæ˜¯ç”¨æˆ·æ€è¿›ç¨‹é¡µè¡¨ï¼Œä¼šæœ‰mm_structæŒ‡å‘è¿›ç¨‹é¡¶çº§ç›®å½•pgdï¼Œå¯¹äºå†…æ ¸æ¥è®²ï¼Œä¹Ÿå®šä¹‰äº†ä¸€ä¸ªmm_structï¼ŒæŒ‡å‘swapper_pg_dirã€‚</p><pre><code>struct mm_struct init_mm = {\n\t.mm_rb\t\t= RB_ROOT,\n\t.pgd\t\t= swapper_pg_dir,\n\t.mm_users\t= ATOMIC_INIT(2),\n\t.mm_count\t= ATOMIC_INIT(1),\n\t.mmap_sem\t= __RWSEM_INITIALIZER(init_mm.mmap_sem),\n\t.page_table_lock =  __SPIN_LOCK_UNLOCKED(init_mm.page_table_lock),\n\t.mmlist\t\t= LIST_HEAD_INIT(init_mm.mmlist),\n\t.user_ns\t= &amp;init_user_ns,\n\tINIT_MM_CONTEXT(init_mm)\n};\n</code></pre><p>å®šä¹‰å®Œäº†å†…æ ¸é¡µè¡¨ï¼Œæ¥ä¸‹æ¥æ˜¯åˆå§‹åŒ–å†…æ ¸é¡µè¡¨ï¼Œåœ¨ç³»ç»Ÿå¯åŠ¨çš„æ—¶å€™start_kernelä¼šè°ƒç”¨setup_archã€‚</p><pre><code>void __init setup_arch(char **cmdline_p)\n{\n\t/*\n\t * copy kernel address range established so far and switch\n\t * to the proper swapper page table\n\t */\n\tclone_pgd_range(swapper_pg_dir     + KERNEL_PGD_BOUNDARY,\n\t\t\tinitial_page_table + KERNEL_PGD_BOUNDARY,\n\t\t\tKERNEL_PGD_PTRS);\n\n\n\tload_cr3(swapper_pg_dir);\n\t__flush_tlb_all();\n......\n\tinit_mm.start_code = (unsigned long) _text;\n\tinit_mm.end_code = (unsigned long) _etext;\n\tinit_mm.end_data = (unsigned long) _edata;\n\tinit_mm.brk = _brk_end;\n......\n\tinit_mem_mapping();\n......\n}\n</code></pre><p>åœ¨setup_archä¸­ï¼Œload_cr3(swapper_pg_dir)è¯´æ˜å†…æ ¸é¡µè¡¨è¦å¼€å§‹èµ·ä½œç”¨äº†ï¼Œå¹¶ä¸”åˆ·æ–°äº†TLBï¼Œåˆå§‹åŒ–init_mmçš„æˆå‘˜å˜é‡ï¼Œæœ€é‡è¦çš„å°±æ˜¯init_mem_mappingã€‚æœ€ç»ˆå®ƒä¼šè°ƒç”¨kernel_physical_mapping_initã€‚</p><pre><code>/*\n * Create page table mapping for the physical memory for specific physical\n * addresses. The virtual and physical addresses have to be aligned on PMD level\n * down. It returns the last physical address mapped.\n */\nunsigned long __meminit\nkernel_physical_mapping_init(unsigned long paddr_start,\n\t\t\t     unsigned long paddr_end,\n\t\t\t     unsigned long page_size_mask)\n{\n\tunsigned long vaddr, vaddr_start, vaddr_end, vaddr_next, paddr_last;\n\n\n\tpaddr_last = paddr_end;\n\tvaddr = (unsigned long)__va(paddr_start);\n\tvaddr_end = (unsigned long)__va(paddr_end);\n\tvaddr_start = vaddr;\n\n\n\tfor (; vaddr &lt; vaddr_end; vaddr = vaddr_next) {\n\t\tpgd_t *pgd = pgd_offset_k(vaddr);\n\t\tp4d_t *p4d;\n\n\n\t\tvaddr_next = (vaddr &amp; PGDIR_MASK) + PGDIR_SIZE;\n\n\n\t\tif (pgd_val(*pgd)) {\n\t\t\tp4d = (p4d_t *)pgd_page_vaddr(*pgd);\n\t\t\tpaddr_last = phys_p4d_init(p4d, __pa(vaddr),\n\t\t\t\t\t\t   __pa(vaddr_end),\n\t\t\t\t\t\t   page_size_mask);\n\t\t\tcontinue;\n\t\t}\n\n\n\t\tp4d = alloc_low_page();\n\t\tpaddr_last = phys_p4d_init(p4d, __pa(vaddr), __pa(vaddr_end),\n\t\t\t\t\t   page_size_mask);\n\n\n\t\tp4d_populate(&amp;init_mm, p4d_offset(pgd, vaddr), (pud_t *) p4d);\n\t}\n\t__flush_tlb_all();\n\n\n\treturn paddr_l\n</code></pre><p>åœ¨kernel_physical_mapping_inité‡Œï¼Œæˆ‘ä»¬å…ˆé€šè¿‡__vaå°†ç‰©ç†åœ°å€è½¬æ¢ä¸ºè™šæ‹Ÿåœ°å€ï¼Œç„¶åå†åˆ›å»ºè™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€çš„æ˜ å°„é¡µè¡¨ã€‚</p><p>ä½ å¯èƒ½ä¼šé—®ï¼Œæ€ä¹ˆè¿™ä¹ˆéº»çƒ¦å•Šï¼Ÿæ—¢ç„¶å¯¹äºå†…æ ¸æ¥è®²ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨__vaå’Œ__paç›´æ¥åœ¨è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€ä¹‹é—´ç›´æ¥è½¬æ¥è½¬å»ï¼Œä¸ºå•¥è¿˜è¦è¾›è¾›è‹¦è‹¦å»ºç«‹é¡µè¡¨å‘¢ï¼Ÿå› ä¸ºè¿™æ˜¯CPUå’Œå†…å­˜çš„ç¡¬ä»¶çš„éœ€æ±‚ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒCPUåœ¨ä¿æŠ¤æ¨¡å¼ä¸‹è®¿é—®è™šæ‹Ÿåœ°å€çš„æ—¶å€™ï¼Œå°±ä¼šç”¨CR3è¿™ä¸ªå¯„å­˜å™¨ï¼Œè¿™ä¸ªå¯„å­˜å™¨æ˜¯CPUå®šä¹‰çš„ï¼Œä½œä¸ºæ“ä½œç³»ç»Ÿï¼Œæˆ‘ä»¬æ˜¯è½¯ä»¶ï¼Œåªèƒ½æŒ‰ç…§ç¡¬ä»¶çš„è¦æ±‚æ¥ã€‚</p><p>ä½ å¯èƒ½åˆä¼šé—®äº†ï¼ŒæŒ‰ç…§å’±ä»¬è®²åˆå§‹åŒ–çš„æ—¶å€™çš„è¿‡ç¨‹ï¼Œç³»ç»Ÿæ—©æ—©å°±è¿›å…¥äº†ä¿æŠ¤æ¨¡å¼ï¼Œåˆ°äº†setup_arché‡Œé¢æ‰load_cr3ï¼Œå¦‚æœä½¿ç”¨cr3æ˜¯ç¡¬ä»¶çš„è¦æ±‚ï¼Œé‚£ä¹‹å‰æ˜¯æ€ä¹ˆåŠçš„å‘¢ï¼Ÿå¦‚æœä½ ä»”ç»†å»çœ‹arch\\x86\\kernel\\head_64.Sï¼Œè¿™é‡Œé¢é™¤äº†åˆå§‹åŒ–å†…æ ¸é¡µè¡¨ä¹‹å¤–ï¼Œåœ¨è¿™ä¹‹å‰ï¼Œè¿˜æœ‰å¦ä¸€ä¸ªé¡µè¡¨early_top_pgtã€‚çœ‹åˆ°å…³é”®å­—earlyäº†å˜›ï¼Ÿè¿™ä¸ªé¡µè¡¨å°±æ˜¯ä¸“é—¨ç”¨åœ¨çœŸæ­£çš„å†…æ ¸é¡µè¡¨åˆå§‹åŒ–ä¹‹å‰ï¼Œä¸ºäº†éµå¾ªç¡¬ä»¶çš„è¦æ±‚è€Œè®¾ç½®çš„ã€‚æ—©æœŸé¡µè¡¨ä¸æ˜¯æˆ‘ä»¬è¿™èŠ‚çš„é‡ç‚¹ï¼Œè¿™é‡Œæˆ‘å°±ä¸å±•å¼€å¤šè¯´äº†ã€‚</p><h2>vmallocå’Œkmap_atomicåŸç†</h2><p>åœ¨ç”¨æˆ·æ€å¯ä»¥é€šè¿‡mallocå‡½æ•°åˆ†é…å†…å­˜ï¼Œå½“ç„¶mallocåœ¨åˆ†é…æ¯”è¾ƒå¤§çš„å†…å­˜çš„æ—¶å€™ï¼Œåº•å±‚è°ƒç”¨çš„æ˜¯mmapï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥é€šè¿‡mmapåšå†…å­˜æ˜ å°„ï¼Œåœ¨å†…æ ¸é‡Œé¢ä¹Ÿæœ‰ç›¸åº”çš„å‡½æ•°ã€‚</p><p>åœ¨è™šæ‹Ÿåœ°å€ç©ºé—´é‡Œé¢ï¼Œæœ‰ä¸ªvmallocåŒºåŸŸï¼Œä»VMALLOC_STARTå¼€å§‹åˆ°VMALLOC_ENDï¼Œå¯ä»¥ç”¨äºæ˜ å°„ä¸€æ®µç‰©ç†å†…å­˜ã€‚</p><pre><code>/**\n *\tvmalloc  -  allocate virtually contiguous memory\n *\t@size:\t\tallocation size\n *\tAllocate enough pages to cover @size from the page level\n *\tallocator and map them into contiguous kernel virtual space.\n *\n *\tFor tight control over page level allocator and protection flags\n *\tuse __vmalloc() instead.\n */\nvoid *vmalloc(unsigned long size)\n{\n\treturn __vmalloc_node_flags(size, NUMA_NO_NODE,\n\t\t\t\t    GFP_KERNEL);\n}\n\n\nstatic void *__vmalloc_node(unsigned long size, unsigned long align,\n\t\t\t    gfp_t gfp_mask, pgprot_t prot,\n\t\t\t    int node, const void *caller)\n{\n\treturn __vmalloc_node_range(size, align, VMALLOC_START, VMALLOC_END,\n\t\t\t\tgfp_mask, prot, 0, node, caller);\n}\n</code></pre><p>æˆ‘ä»¬å†æ¥çœ‹å†…æ ¸çš„ä¸´æ—¶æ˜ å°„å‡½æ•°kmap_atomicçš„å®ç°ã€‚ä»ä¸‹é¢çš„ä»£ç æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœæ˜¯32ä½æœ‰é«˜ç«¯åœ°å€çš„ï¼Œå°±éœ€è¦è°ƒç”¨set_pteé€šè¿‡å†…æ ¸é¡µè¡¨è¿›è¡Œä¸´æ—¶æ˜ å°„ï¼›å¦‚æœæ˜¯64ä½æ²¡æœ‰é«˜ç«¯åœ°å€çš„ï¼Œå°±è°ƒç”¨page_addressï¼Œé‡Œé¢ä¼šè°ƒç”¨lowmem_page_addressã€‚å…¶å®ä½ç«¯å†…å­˜çš„æ˜ å°„ï¼Œä¼šç›´æ¥ä½¿ç”¨__vaè¿›è¡Œä¸´æ—¶æ˜ å°„ã€‚</p><pre><code>void *kmap_atomic_prot(struct page *page, pgprot_t prot)\n{\n......\n\tif (!PageHighMem(page))\n\t\treturn page_address(page);\n......\n\tvaddr = __fix_to_virt(FIX_KMAP_BEGIN + idx);\n\tset_pte(kmap_pte-idx, mk_pte(page, prot));\n......\n\treturn (void *)vaddr;\n}\n\n\nvoid *kmap_atomic(struct page *page)\n{\n\treturn kmap_atomic_prot(page, kmap_prot);\n}\n\n\nstatic __always_inline void *lowmem_page_address(const struct page *page)\n{\n\treturn page_to_virt(page);\n}\n\n\n#define page_to_virt(x)\t__va(PFN_PHYS(page_to_pfn(x)\n</code></pre><h2>å†…æ ¸æ€ç¼ºé¡µå¼‚å¸¸</h2><p>å¯ä»¥çœ‹å‡ºï¼Œkmap_atomicå’Œvmallocä¸åŒã€‚kmap_atomicå‘ç°ï¼Œæ²¡æœ‰é¡µè¡¨çš„æ—¶å€™ï¼Œå°±ç›´æ¥åˆ›å»ºé¡µè¡¨è¿›è¡Œæ˜ å°„äº†ã€‚è€Œvmallocæ²¡æœ‰ï¼Œå®ƒåªåˆ†é…äº†å†…æ ¸çš„è™šæ‹Ÿåœ°å€ã€‚æ‰€ä»¥ï¼Œè®¿é—®å®ƒçš„æ—¶å€™ï¼Œä¼šäº§ç”Ÿç¼ºé¡µå¼‚å¸¸ã€‚</p><p>å†…æ ¸æ€çš„ç¼ºé¡µå¼‚å¸¸è¿˜æ˜¯ä¼šè°ƒç”¨do_page_faultï¼Œä½†æ˜¯ä¼šèµ°åˆ°å’±ä»¬ä¸Šé¢ç”¨æˆ·æ€ç¼ºé¡µå¼‚å¸¸ä¸­æ²¡æœ‰è§£æçš„é‚£éƒ¨åˆ†vmalloc_faultã€‚è¿™ä¸ªå‡½æ•°å¹¶ä¸å¤æ‚ï¼Œä¸»è¦ç”¨äºå…³è”å†…æ ¸é¡µè¡¨é¡¹ã€‚</p><pre><code>/*\n * 32-bit:\n *\n *   Handle a fault on the vmalloc or module mapping area\n */\nstatic noinline int vmalloc_fault(unsigned long address)\n{\n\tunsigned long pgd_paddr;\n\tpmd_t *pmd_k;\n\tpte_t *pte_k;\n\n\n\t/* Make sure we are in vmalloc area: */\n\tif (!(address &gt;= VMALLOC_START &amp;&amp; address &lt; VMALLOC_END))\n\t\treturn -1;\n\n\n\t/*\n\t * Synchronize this task's top level page-table\n\t * with the 'reference' page table.\n\t *\n\t * Do _not_ use &quot;current&quot; here. We might be inside\n\t * an interrupt in the middle of a task switch..\n\t */\n\tpgd_paddr = read_cr3_pa();\n\tpmd_k = vmalloc_sync_one(__va(pgd_paddr), address);\n\tif (!pmd_k)\n\t\treturn -1;\n\n\n\tpte_k = pte_offset_kernel(pmd_k, address);\n\tif (!pte_present(*pte_k))\n\t\treturn -1;\n\n\n\treturn 0\n</code></pre><h2>æ€»ç»“æ—¶åˆ»</h2><p>è‡³æ­¤ï¼Œå†…æ ¸æ€çš„å†…å­˜æ˜ å°„ä¹Ÿè®²å®Œäº†ã€‚è¿™ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ•´ä¸ªå†…å­˜ç®¡ç†çš„ä½“ç³»ä¸²èµ·æ¥äº†ã€‚</p><p>ç‰©ç†å†…å­˜æ ¹æ®NUMAæ¶æ„åˆ†èŠ‚ç‚¹ã€‚æ¯ä¸ªèŠ‚ç‚¹é‡Œé¢å†åˆ†åŒºåŸŸã€‚æ¯ä¸ªåŒºåŸŸé‡Œé¢å†åˆ†é¡µã€‚</p><p>ç‰©ç†é¡µé¢é€šè¿‡ä¼™ä¼´ç³»ç»Ÿè¿›è¡Œåˆ†é…ã€‚åˆ†é…çš„ç‰©ç†é¡µé¢è¦å˜æˆè™šæ‹Ÿåœ°å€è®©ä¸Šå±‚å¯ä»¥è®¿é—®ï¼Œkswapdå¯ä»¥æ ¹æ®ç‰©ç†é¡µé¢çš„ä½¿ç”¨æƒ…å†µå¯¹é¡µé¢è¿›è¡Œæ¢å…¥æ¢å‡ºã€‚</p><p>å¯¹äºå†…å­˜çš„åˆ†é…éœ€æ±‚ï¼Œå¯èƒ½æ¥è‡ªå†…æ ¸æ€ï¼Œä¹Ÿå¯èƒ½æ¥è‡ªç”¨æˆ·æ€ã€‚</p><p>å¯¹äºå†…æ ¸æ€ï¼Œkmallocåœ¨åˆ†é…å¤§å†…å­˜çš„æ—¶å€™ï¼Œä»¥åŠvmallocåˆ†é…ä¸è¿ç»­ç‰©ç†é¡µçš„æ—¶å€™ï¼Œç›´æ¥ä½¿ç”¨ä¼™ä¼´ç³»ç»Ÿï¼Œåˆ†é…åè½¬æ¢ä¸ºè™šæ‹Ÿåœ°å€ï¼Œè®¿é—®çš„æ—¶å€™éœ€è¦é€šè¿‡å†…æ ¸é¡µè¡¨è¿›è¡Œæ˜ å°„ã€‚</p><p>å¯¹äºkmem_cacheä»¥åŠkmallocåˆ†é…å°å†…å­˜ï¼Œåˆ™ä½¿ç”¨slubåˆ†é…å™¨ï¼Œå°†ä¼™ä¼´ç³»ç»Ÿåˆ†é…å‡ºæ¥çš„å¤§å—å†…å­˜åˆ‡æˆä¸€å°å—ä¸€å°å—è¿›è¡Œåˆ†é…ã€‚</p><p>kmem_cacheå’Œkmallocçš„éƒ¨åˆ†ä¸ä¼šè¢«æ¢å‡ºï¼Œå› ä¸ºç”¨è¿™ä¸¤ä¸ªå‡½æ•°åˆ†é…çš„å†…å­˜å¤šç”¨äºä¿æŒå†…æ ¸å…³é”®çš„æ•°æ®ç»“æ„ã€‚å†…æ ¸æ€ä¸­vmallocåˆ†é…çš„éƒ¨åˆ†ä¼šè¢«æ¢å‡ºï¼Œå› è€Œå½“è®¿é—®çš„æ—¶å€™ï¼Œå‘ç°ä¸åœ¨ï¼Œå°±ä¼šè°ƒç”¨do_page_faultã€‚</p><p>å¯¹äºç”¨æˆ·æ€çš„å†…å­˜åˆ†é…ï¼Œæˆ–è€…ç›´æ¥è°ƒç”¨mmapç³»ç»Ÿè°ƒç”¨åˆ†é…ï¼Œæˆ–è€…è°ƒç”¨mallocã€‚è°ƒç”¨mallocçš„æ—¶å€™ï¼Œå¦‚æœåˆ†é…å°çš„å†…å­˜ï¼Œå°±ç”¨sys_brkç³»ç»Ÿè°ƒç”¨ï¼›å¦‚æœåˆ†é…å¤§çš„å†…å­˜ï¼Œè¿˜æ˜¯ç”¨sys_mmapç³»ç»Ÿè°ƒç”¨ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œç”¨æˆ·æ€çš„å†…å­˜éƒ½æ˜¯å¯ä»¥æ¢å‡ºçš„ï¼Œå› è€Œä¸€æ—¦å‘ç°å†…å­˜ä¸­ä¸å­˜åœ¨ï¼Œå°±ä¼šè°ƒç”¨do_page_faultã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/27/9a/274e22b3f5196a4c68bb6813fb643f9a.png?wh=2368*2248\" alt=\"\"></p><h2>è¯¾å ‚ç»ƒä¹ </h2><p>ä¼™ä¼´ç³»ç»Ÿåˆ†é…å¥½äº†ç‰©ç†é¡µé¢ä¹‹åï¼Œå¦‚ä½•è½¬æ¢æˆä¸ºè™šæ‹Ÿåœ°å€å‘¢ï¼Ÿè¯·ç ”ç©¶ä¸€ä¸‹page_addresså‡½æ•°çš„å®ç°ã€‚</p><p>æ¬¢è¿ç•™è¨€å’Œæˆ‘åˆ†äº«ä½ çš„ç–‘æƒ‘å’Œè§è§£ï¼Œä¹Ÿæ¬¢è¿ä½ æ”¶è—æœ¬èŠ‚å†…å®¹ï¼Œåå¤ç ”è¯»ã€‚ä½ ä¹Ÿå¯ä»¥æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹ï¼Œå’Œä»–ä¸€èµ·å­¦ä¹ ã€è¿›æ­¥ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/8c/37/8c0a95fa07a8b9a1abfd394479bdd637.jpg?wh=1110*659\" alt=\"\"></p>","comments":[{"had_liked":false,"id":98338,"user_name":"why","can_delete":false,"product_type":"c1","uid":1012937,"ip_address":"","ucode":"C9E796E53F6F5E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/74/c9/d3439ca4.jpg","comment_is_top":false,"comment_ctime":1558962149,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"91753275365","product_id":100024701,"comment_content":"- æ¶‰åŠä¸‰å—å†…å®¹:<br>    - å†…å­˜æ˜ å°„å‡½æ•° vmalloc, kmap_atomic<br>    - å†…æ ¸æ€é¡µè¡¨å­˜æ”¾ä½ç½®å’Œå·¥ä½œæµç¨‹<br>    - å†…æ ¸æ€ç¼ºé¡µå¼‚å¸¸å¤„ç†<br>- å†…æ ¸æ€é¡µè¡¨, ç³»ç»Ÿåˆå§‹åŒ–æ—¶å°±åˆ›å»º<br>    - swapper_pg_dir æŒ‡å‘å†…æ ¸é¡¶çº§é¡µç›®å½• pgd<br>        - xxx_ident&#47;kernel&#47;fixmap_pgt åˆ†åˆ«æ˜¯ç›´æ¥æ˜ å°„&#47;å†…æ ¸ä»£ç &#47;å›ºå®šæ˜ å°„çš„ xxx çº§é¡µè¡¨ç›®å½•<br>    - åˆ›å»ºå†…æ ¸æ€é¡µè¡¨<br>        - swapper_pg_dir æŒ‡å‘ init_top_pgt, æ˜¯ ELF æ–‡ä»¶çš„å…¨å±€å˜é‡, å› æ­¤å†å†…å­˜ç®¡ç†åˆå§‹åŒ–ä¹‹é—´å°±å­˜åœ¨<br>        - init_top_pgt å…ˆåˆå§‹åŒ–äº†ä¸‰é¡¹<br>            - ç¬¬ä¸€é¡¹æŒ‡å‘ level3_ident_pgt (å†…æ ¸ä»£ç æ®µçš„æŸä¸ªè™šæ‹Ÿåœ°å€) å‡å» __START_KERNEL_MAP (å†…æ ¸ä»£ç èµ·å§‹è™šæ‹Ÿåœ°å€) å¾—åˆ°å®é™…ç‰©ç†åœ°å€<br>            - ç¬¬äºŒé¡¹ä¹Ÿæ˜¯æŒ‡å‘ level3_ident_pgt<br>            - ç¬¬ä¸‰é¡¹æŒ‡å‘ level3_kernel_pgt å†…æ ¸ä»£ç åŒº<br>    - åˆå§‹åŒ–å„é¡µè¡¨é¡¹, æŒ‡å‘ä¸‹ä¸€é›†ç›®å½•<br>        - é¡µè¡¨è¦†ç›–èŒƒå›´è¾ƒå°, å†…æ ¸ä»£ç  512MB, ç›´æ¥æ˜ å°„åŒº 1GB<br>        - å†…æ ¸æ€ä¹Ÿå®šä¹‰ mm_struct æŒ‡å‘ swapper_pg_dir<br>        - åˆå§‹åŒ–å†…æ ¸æ€é¡µè¡¨,  start_kernelâ†’ setup_arch<br>            - load_cr3(swapper_pg_dir) å¹¶åˆ·æ–° TLB<br>            - è°ƒç”¨ init_mem_mappingâ†’kernel_physical_mapping_init, ç”¨ __va å°†ç‰©ç†åœ°å€æ˜ å°„åˆ°è™šæ‹Ÿåœ°å€, å†åˆ›å»ºæ˜ å°„é¡µè¡¨é¡¹<br>            - CPU åœ¨ä¿æŠ¤æ¨¡å¼ä¸‹è®¿é—®è™šæ‹Ÿåœ°å€éƒ½å¿…é¡»é€šè¿‡ cr3, ç³»ç»Ÿåªèƒ½ç…§åš<br>            - åœ¨ load_cr3 ä¹‹å‰, é€šè¿‡ early_top_pgt å®Œæˆæ˜ å°„<br>- vmalloc å’Œ kmap_atomic<br>    - å†…æ ¸çš„è™šæ‹Ÿåœ°å€ç©ºé—´ vmalloc åŒºåŸŸç”¨äºæ˜ å°„<br>    - kmap_atomic ä¸´æ—¶æ˜ å°„<br>        - 32 ä½, è°ƒç”¨ set_pte é€šè¿‡å†…æ ¸é¡µè¡¨ä¸´æ—¶æ˜ å°„<br>        - 64 ä½, è°ƒç”¨ page_addressâ†’lowmem_page_address è¿›è¡Œæ˜ å°„<br>- å†…æ ¸æ€ç¼ºé¡µå¼‚å¸¸<br>    - kmap_atomic ç›´æ¥åˆ›å»ºé¡µè¡¨è¿›è¡Œæ˜ å°„<br>    - vmalloc åªåˆ†é…å†…æ ¸è™šæ‹Ÿåœ°å€, è®¿é—®æ—¶è§¦å‘ç¼ºé¡µä¸­æ–­, è°ƒç”¨ do_page_faultâ†’vmalloc_fault ç”¨äºå…³è”å†…æ ¸é¡µè¡¨é¡¹<br>- kmem_cache å’Œ kmalloc ç”¨äºä¿å­˜å†…æ ¸æ•°æ®ç»“æ„, ä¸ä¼šè¢«æ¢å‡º; è€Œå†…æ ¸ vmalloc ä¼šè¢«æ¢å‡º","like_count":21},{"had_liked":false,"id":98897,"user_name":"æ´»çš„æ½‡æ´’","can_delete":false,"product_type":"c1","uid":1238830,"ip_address":"","ucode":"666C30CA894754","user_header":"https://static001.geekbang.org/account/avatar/00/12/e7/2e/1522a7d6.jpg","comment_is_top":false,"comment_ctime":1559114188,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"87458460108","product_id":100024701,"comment_content":"å†³å¿ƒä»å¤´æŠŠè®¡ç®—æœºæ‰€æœ‰çš„åŸºç¡€è¯¾ç¨‹å…¨éƒ¨è¡¥ä¸Šï¼Œå¤¯å®åŸºç¡€ï¼Œä¸€å®šè¦åšæŒåˆ°æœ€å<br>day26ç¬”è®°ï¼šhttps:&#47;&#47;www.cnblogs.com&#47;luoahong&#47;p&#47;10931320.html","like_count":20,"discussions":[{"author":{"id":2149899,"avatar":"https://static001.geekbang.org/account/avatar/00/20/ce/0b/b1e244e6.jpg","nickname":"IMBFD","note":"","ucode":"2E7B3D01C537A0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":377505,"discussion_content":"åšæŒåˆ°æœ€åäº†ä¹ˆï¼Ÿ","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1622688413,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1064375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/3d/b7/d863295a.jpg","nickname":"panbook","note":"","ucode":"1B1CC0F44C41DF","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":274203,"discussion_content":"æ”¯æŒ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590554240,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":110735,"user_name":"æ²¡å¿ƒæ²¡è‚º","can_delete":false,"product_type":"c1","uid":1258867,"ip_address":"","ucode":"121FD3AEBA3BEA","user_header":"https://static001.geekbang.org/account/avatar/00/13/35/73/46d6dadc.jpg","comment_is_top":false,"comment_ctime":1562321287,"is_pvip":false,"replies":[{"id":"46757","content":"ä¸æ€•ä¸æ€•","user_name":"ä½œè€…å›å¤","comment_id":110735,"uid":"1001590","ip_address":"","utype":1,"ctime":1566388299,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":2,"race_medal":0,"score":"74576765319","product_id":100024701,"comment_content":"å¥½ææ€–ï¼Œçœ‹åˆ°è¿™é‡Œï¼Œæ˜¯ç¡¬çœ‹äº†","like_count":17,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457030,"discussion_content":"ä¸æ€•ä¸æ€•","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566388299,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1131300,"avatar":"https://static001.geekbang.org/account/avatar/00/11/43/24/3f9f7c70.jpg","nickname":"zixuan","note":"","ucode":"C72920DD05B074","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":589460,"discussion_content":"çœ‹æˆçœ‹ç¡¬äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1664965508,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å¹¿ä¸œ"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":98365,"user_name":"ezra.xu","can_delete":false,"product_type":"c1","uid":1014005,"ip_address":"","ucode":"6C3E11889BC6AB","user_header":"https://static001.geekbang.org/account/avatar/00/0f/78/f5/ae200a94.jpg","comment_is_top":false,"comment_ctime":1558968267,"is_pvip":false,"replies":[{"id":"35384","content":"æ˜¯å› ä¸ºCè¯­è¨€ç¼–è¯‘å®Œäº†å°±ç›´æ¥æ˜¯ç¡¬ä»¶èƒ½å¤Ÿè¯†åˆ«çš„äºŒè¿›åˆ¶ï¼Œä¸åƒjavaï¼Œéœ€è¦jvmæ‰èƒ½è¿è¡Œã€‚Cè¯­è¨€ä¸ç”¨è‡ªä¸¾ï¼Œé™¤äº†ç¬¬ä¸€ä¸ªå¼€å‘Cè¯­è¨€çš„ï¼Œéœ€è¦ç”¨æ±‡ç¼–æ¥åšï¼Œåé¢éƒ½å¯ä»¥ç”¨é”¤å­é€ é”¤å­","user_name":"ä½œè€…å›å¤","comment_id":98365,"uid":"1001590","ip_address":"","utype":1,"ctime":1559100578,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":2,"race_medal":0,"score":"65983477707","product_id":100024701,"comment_content":"å†…æ ¸èƒ½ç”¨cè¯­è¨€ç¼–å†™ï¼Œæ˜¯ä¸æ˜¯æ„å‘³ç€ç”¨cå¯ä»¥ç›´æ¥æ“ä½œç‰©ç†å†…å­˜ï¼Œå¦å¤–linuxä¸Šçš„cè¯­è¨€ç¼–è¯‘å™¨æ˜¯ç”¨ä»€ä¹ˆè¯­è¨€å¼€å‘çš„ï¼Œcè¯­è¨€å®ç°äº†è‡ªä¸¾å—ï¼Œcè¯­è¨€è·¨å¹³å°åº•å±‚åŸç†æ˜¯ä»€ä¹ˆï¼Œè¯·è€å¸ˆç­”ç–‘è§£æƒ‘ã€‚","like_count":15,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":451660,"discussion_content":"æ˜¯å› ä¸ºCè¯­è¨€ç¼–è¯‘å®Œäº†å°±ç›´æ¥æ˜¯ç¡¬ä»¶èƒ½å¤Ÿè¯†åˆ«çš„äºŒè¿›åˆ¶ï¼Œä¸åƒjavaï¼Œéœ€è¦jvmæ‰èƒ½è¿è¡Œã€‚Cè¯­è¨€ä¸ç”¨è‡ªä¸¾ï¼Œé™¤äº†ç¬¬ä¸€ä¸ªå¼€å‘Cè¯­è¨€çš„ï¼Œéœ€è¦ç”¨æ±‡ç¼–æ¥åšï¼Œåé¢éƒ½å¯ä»¥ç”¨é”¤å­é€ é”¤å­","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1559100578,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1995068,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/71/3c/119f00a9.jpg","nickname":"Ironman","note":"","ucode":"66F3226ACD8570","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":295833,"discussion_content":"cè¯­è¨€æ˜¯å¯ä»¥æ“ä½œç‰©ç†å†…å­˜çš„ï¼Œç©è¿‡å•ç‰‡æœºçš„éƒ½çŸ¥é“ã€‚ä¸åŒæ¶æ„çš„cpuéœ€è¦ä¸åŒçš„cç¼–è¯‘å™¨ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596359005,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":155351,"user_name":"czh","can_delete":false,"product_type":"c1","uid":1159078,"ip_address":"","ucode":"649FE5C9269D69","user_header":"https://static001.geekbang.org/account/avatar/00/11/af/a6/3f15ba2f.jpg","comment_is_top":false,"comment_ctime":1574681203,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"40229386867","product_id":100024701,"comment_content":"æ•´ä¸ªå†…å­˜çš„è®²è§£ï¼ˆè¿™ä¸ªä¸“æ å†…å®¹å¦‚æœä¸€ä¸‹çœ‹ä¸æ‡‚ç›´æ¥è·³æ€»ç»“éƒ¨åˆ†ï¼Œç”šè‡³æ¯ç« çš„æœ€åï¼Œç°æœ‰ä¸ªæ•´ä½“è®¤è¯†ï¼Œå†è¿”å›å»çœ‹ç»†èŠ‚ï¼Œä¼šå®¹æ˜“å¾ˆå¤šï¼‰","like_count":9},{"had_liked":false,"id":115040,"user_name":"è«å","can_delete":false,"product_type":"c1","uid":1007254,"ip_address":"","ucode":"E28F2602BA25DD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/5e/96/a03175bc.jpg","comment_is_top":false,"comment_ctime":1563460006,"is_pvip":false,"replies":[{"id":"46569","content":"èµï¼Œæœ‰æ„Ÿè§‰å°±å¥½ï¼Œè¦çš„å°±æ˜¯å¿ƒåŠ¨","user_name":"ä½œè€…å›å¤","comment_id":115040,"uid":"1001590","ip_address":"","utype":1,"ctime":1566357997,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"31628231078","product_id":100024701,"comment_content":"ğŸ‘çœ‹èµ·æ¥å¾ˆæœ‰æ„Ÿè§‰ï¼Œå…ˆè®²ç”¨æˆ·æ€ã€å†…æ ¸æ€è™šæ‹Ÿå†…å­˜çš„ç®¡ç†ï¼Œç„¶åè®²ç‰©ç†å†…å­˜çš„ç®¡ç†ï¼Œæœ€åè®²ç”¨æˆ·æ€ã€å†…æ ¸æ€è™šæ‹Ÿå†…å­˜ä¸ç‰©ç†å†…å­˜å¦‚ä½•å»ºç«‹å…³è”ã€‚","like_count":7,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":458941,"discussion_content":"èµï¼Œæœ‰æ„Ÿè§‰å°±å¥½ï¼Œè¦çš„å°±æ˜¯å¿ƒåŠ¨","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566357997,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":241075,"user_name":"garlic","can_delete":false,"product_type":"c1","uid":1019579,"ip_address":"","ucode":"FEB147EDB5774E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8e/bb/c039dc11.jpg","comment_is_top":false,"comment_ctime":1597182532,"is_pvip":true,"discussion_count":0,"race_medal":1,"score":"18777051716","product_id":100024701,"comment_content":"ä¼™ä¼´ç³»ç»Ÿåˆ†é…å¥½äº†ç‰©ç†é¡µé¢åˆ°è™šæ‹Ÿåœ°å€:æœ‰ä¸¤ç§æƒ…å†µ<br>1. ç”³è¯·æ—¶è½¬æ¢ï¼Œ <br>ç›´æ¥ä½¿ç”¨ä¼™ä¼´ç³»ç»Ÿç”³è¯·é¡µ,é€šè¿‡page_addressè¿›è¡Œåœ°å€è½¬æ¢ï¼Œå¦‚kmallocç”³è¯·å¤§äº2ä¸ªé¡µé¢æ—¶<br>é€šè¿‡SLABä»ä¼™ä¼´ç³»ç»Ÿç”³è¯·é¡µ,åˆ›å»ºnew slabæ—¶é€šè¿‡page_addressè¿›è¡Œåœ°å€è½¬æ¢, å¦‚vmalloc, VMAç»“æ„ä½“ç”³è¯·æ—¶<br>2. æœ‰è™šæ‹Ÿåœ°å€æŒ‚è½½é¡µé¢<br>æœ‰æŒ‡å®šè™šæ‹Ÿåœ°å€èŒƒå›´ï¼Œå†é€šè¿‡ä¼™ä¼´ç³»ç»Ÿç”³è¯·ç©ºé—´ï¼Œç”³è¯·é‡Šæ”¾æ—¶ç»Ÿä¸€è¿›è¡Œæ›´æ–°é¡µè¡¨é¡¹, å¦‚vmalloc<br>è¯¾å ‚å­¦ä¹ ç¬”è®°ï¼š https:&#47;&#47;garlicspace.com&#47;2020&#47;08&#47;12&#47;%e4%bc%99%e4%bc%b4%e7%b3%bb%e7%bb%9f%e5%88%86%e9%85%8d%e7%89%a9%e7%90%86%e9%a1%b5%e5%90%8e%e5%a6%82%e4%bd%95%e8%bd%ac%e6%8d%a2%e6%88%90%e4%b8%ba%e8%99%9a%e6%8b%9f%e5%9c%b0%e5%9d%80&#47;","like_count":4},{"had_liked":false,"id":98280,"user_name":"æ´»çš„æ½‡æ´’","can_delete":false,"product_type":"c1","uid":1238830,"ip_address":"","ucode":"666C30CA894754","user_header":"https://static001.geekbang.org/account/avatar/00/12/e7/2e/1522a7d6.jpg","comment_is_top":false,"comment_ctime":1558947682,"is_pvip":false,"replies":[{"id":"35386","content":"åŠ æ²¹","user_name":"ä½œè€…å›å¤","comment_id":98280,"uid":"1001590","ip_address":"","utype":1,"ctime":1559100646,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"14443849570","product_id":100024701,"comment_content":"åšæŒå®Œæ•´çš„å­¦åˆ°åº•ï¼ŒåšæŒå®Œæ•´çš„ç¬”è®°åˆ°åº•<br>day26 å­¦ä¹ ç¬”è®°ï¼šhttps:&#47;&#47;www.cnblogs.com&#47;luoahong&#47;p&#47;10931320.html","like_count":3,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":451629,"discussion_content":"åŠ æ²¹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1559100646,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":130641,"user_name":"å¥”è·‘çš„ç ä»”","can_delete":false,"product_type":"c1","uid":1609871,"ip_address":"","ucode":"AB3B02B07B8B8C","user_header":"https://static001.geekbang.org/account/avatar/00/18/90/8f/9c691a5f.jpg","comment_is_top":false,"comment_ctime":1567499946,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10157434538","product_id":100024701,"comment_content":"page_addressçš„å®ç°å¦‚ä¸‹ï¼š<br><br>```<br>&#47;**<br> * page_address - get the mapped virtual address of a page<br> * @page: &amp;struct page to get the virtual address of<br> *<br> * Returns the page&#39;s virtual address.<br> *&#47;<br>void *page_address(const struct page *page)<br>{<br>\tunsigned long flags;<br>\tvoid *ret;<br>\tstruct page_address_slot *pas;<br><br>\tif (!PageHighMem(page))<br>\t\treturn lowmem_page_address(page);<br><br>\tpas = page_slot(page);<br>\tret = NULL;<br>\tspin_lock_irqsave(&amp;pas-&gt;lock, flags);<br>\tif (!list_empty(&amp;pas-&gt;lh)) {<br>\t\tstruct page_address_map *pam;<br><br>\t\tlist_for_each_entry(pam, &amp;pas-&gt;lh, list) {<br>\t\t\tif (pam-&gt;page == page) {<br>\t\t\t\tret = pam-&gt;virtual;<br>\t\t\t\tgoto done;<br>\t\t\t}<br>\t\t}<br>\t}<br>done:<br>\tspin_unlock_irqrestore(&amp;pas-&gt;lock, flags);<br>\treturn ret;<br>}<br>```<br><br>- å¦‚æœä¸æ˜¯é«˜ç«¯å†…å­˜ï¼Œç‰©ç†åœ°å€å’Œè™šæ‹Ÿåœ°å€ä¹‹é—´çš„è½¬æ¢ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼Œç›´æ¥ä½¿ç”¨lowmme_page_addressè¿›è¡Œè½¬æ¢ï¼Œå‰é¢æåˆ°è¿‡è¿™ä¸ªå‡½æ•°ï¼›<br>- å¯¹äºéé«˜ç«¯å†…å­˜é¡µï¼Œé€šè¿‡page_slotè®¡ç®—å‡ºpasï¼Œpasä¿å­˜åœ¨ç”±pagezä½œä¸ºkeyçš„hashè¡¨page_address_htableä¸­ï¼›<br>- éå†pas-&gt;lhåŒå‘é“¾è¡¨ï¼Œé“¾è¡¨çš„èŠ‚ç‚¹ä¿å­˜æœ‰pageçš„åœ°å€å’Œpageæ‰€å¯¹åº”çš„è™šæ‹Ÿåœ°å€ï¼Œé€šè¿‡pageï¼Œå¯ä»¥ç¡®å®špageå¯¹åº”çš„è™šæ‹Ÿåœ°å€ã€‚","like_count":2},{"had_liked":false,"id":100110,"user_name":"LDxy","can_delete":false,"product_type":"c1","uid":1188710,"ip_address":"","ucode":"956432CE7B7761","user_header":"https://static001.geekbang.org/account/avatar/00/12/23/66/413c0bb5.jpg","comment_is_top":false,"comment_ctime":1559446548,"is_pvip":false,"replies":[{"id":"49211","content":"åˆå§‹åŒ–çš„æ—¶å€™ï¼Œä¼šæ£€æµ‹ç¡¬ä»¶","user_name":"ä½œè€…å›å¤","comment_id":100110,"uid":"1001590","ip_address":"","utype":1,"ctime":1567603454,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"10149381140","product_id":100024701,"comment_content":"æ“ä½œç³»ç»Ÿæ˜¯å¦‚ä½•çŸ¥é“è®¡ç®—æœºä¸Šæœ‰å¤šå°‘ç‰©ç†å†…å­˜çš„å‘¢ï¼Ÿ","like_count":2,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":452414,"discussion_content":"åˆå§‹åŒ–çš„æ—¶å€™ï¼Œä¼šæ£€æµ‹ç¡¬ä»¶","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567603454,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":339573,"user_name":"dll","can_delete":false,"product_type":"c1","uid":1264401,"ip_address":"","ucode":"5773CBC8BFB91F","user_header":"https://static001.geekbang.org/account/avatar/00/13/4b/11/d7e08b5b.jpg","comment_is_top":false,"comment_ctime":1648198836,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"5943166132","product_id":100024701,"comment_content":"çœŸçš„åå¤çœ‹äº†å‡ éï¼Œæ²¡ç†è§£init_top_pgté‡Œçš„ä¸‰é¡¹æŒ‡çš„æ˜¯ä»€ä¹ˆï¼Œæˆ‘è§‰å¾—æœ‰æ—¶å€™æ–‡ç« è¿˜æ˜¯æœ‰ç‚¹å†™çš„è¯ä¸è¾¾æ„ï¼Œä»£ç æœ‰ç‚¹ç¼ºå¤±ï¼ŒçœŸçš„çœ‹èµ·æ¥å¥½å¹¸è‹¦","like_count":1},{"had_liked":false,"id":286702,"user_name":"geek","can_delete":false,"product_type":"c1","uid":2401422,"ip_address":"","ucode":"FF0845140D72A9","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/NyFOEueITjaGLpakMEuWAqVQjo1uDIXlpDdpCxXGfaWiaXzibLQ3WgOFCe8D9FvCmyjsGT7jDsLUbkt8jt2aVs9g/132","comment_is_top":false,"comment_ctime":1617513100,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"5912480396","product_id":100024701,"comment_content":"page_address_mapç»“æ„ä½“ä¸­ä¿å­˜äº†pageå’Œå¯¹åº”è™šæ‹Ÿåœ°å€çš„æ˜ å°„å…³ç³»ã€‚<br>æ¯ä¸ªpageå¯¹è±¡ä¿å­˜åœ¨page_address_htableä¸­ï¼Œæ˜ å°„åˆ°ç›¸åŒslotçš„pagesä¼šå½¢æˆä¸€ä¸ªé“¾è¡¨ã€‚page_addressæ–¹æ³•å°±æ˜¯æ ¹æ®pageæ‰¾åˆ°slotï¼Œéå†å¯¹åº”slotçš„é“¾è¡¨ï¼Œæ‰¾åˆ°pageç›¸åŒçš„é‚£é¡¹ï¼Œè¿”å›å…¶å¯¹åº”çš„è™šæ‹Ÿåœ°å€ã€‚","like_count":1},{"had_liked":false,"id":215173,"user_name":"Mhy","can_delete":false,"product_type":"c1","uid":1287774,"ip_address":"","ucode":"DE19BCAD1F856E","user_header":"https://static001.geekbang.org/account/avatar/00/13/a6/5e/b05254a6.jpg","comment_is_top":false,"comment_ctime":1588920452,"is_pvip":false,"replies":[{"id":"83476","content":"ä¸æ˜¯çš„ï¼Œmmapæ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œä¸å­˜åœ¨å†…æ ¸è°ƒç”¨ä»–çš„","user_name":"ä½œè€…å›å¤","comment_id":215173,"uid":"1001590","ip_address":"","utype":1,"ctime":1592186772,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"5883887748","product_id":100024701,"comment_content":"è€å¸ˆï¼Œçœ‹åˆ°è¿™é‡Œæˆ‘æ˜¯ä¸æ˜¯å¯ä»¥è®¤ä¸ºåœ¨ç”¨æˆ·æ€ä½¿ç”¨mmapå’Œå†…æ ¸æ€ä½¿ç”¨mmapæ˜¯ä¸¤ç äº‹ï¼Œæˆ‘ä»¬ä¸€èˆ¬åº”ç”¨åœºæ™¯æ¯”å¦‚å°†å›¾ç‰‡å†…å­˜ç›´æ¥æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ä¸Šè®¿é—®é¿å…å¤šæ¬¡æ‹·è´ä»è€Œæé«˜å›¾ç‰‡åŠ è½½é€Ÿåº¦ï¼Œé‚£ä¹ˆè¿™ä¸ªåœºæ™¯æ˜¯å‘ç”Ÿåœ¨ç”¨æˆ·æ€ä¸Šé¢ï¼ŒæœŸé—´ä¸éœ€è¦é€šè¿‡å†…æ ¸æ€å—ï¼Ÿè°ƒç”¨ç³»ç»Ÿå‡½æ•°è§¦å‘çš„mmapæ˜¯å‘ç”Ÿåœ¨å†…æ ¸æ€å—ï¼Œæ¯”å¦‚strace ls -l","like_count":1,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":494342,"discussion_content":"ä¸æ˜¯çš„ï¼Œmmapæ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œä¸å­˜åœ¨å†…æ ¸è°ƒç”¨ä»–çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592186772,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":124366,"user_name":"Bing","can_delete":false,"product_type":"c1","uid":1070258,"ip_address":"","ucode":"E9F46630FB1F3A","user_header":"https://static001.geekbang.org/account/avatar/00/10/54/b2/8811d29f.jpg","comment_is_top":false,"comment_ctime":1565867558,"is_pvip":false,"replies":[{"id":"46271","content":"å½“ç„¶ä¼šå•Šï¼Œè™šæ‹Ÿå†…å­˜å˜›","user_name":"ä½œè€…å›å¤","comment_id":124366,"uid":"1001590","ip_address":"","utype":1,"ctime":1566280656,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"5860834854","product_id":100024701,"comment_content":"ç”¨mallocç”³è¯·çš„å†…å­˜ï¼Œè¿›ç¨‹é€€å‡ºæ—¶ï¼Œæ“ä½œç³»ç»Ÿæ˜¯å¦ä¼šé‡Šæ”¾","like_count":1,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":463138,"discussion_content":"å½“ç„¶ä¼šå•Šï¼Œè™šæ‹Ÿå†…å­˜å˜›","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566280656,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":360681,"user_name":"Jay","can_delete":false,"product_type":"c1","uid":1070670,"ip_address":"åŒ—äº¬","ucode":"ED9970F7E66080","user_header":"https://static001.geekbang.org/account/avatar/00/10/56/4e/9291fac0.jpg","comment_is_top":false,"comment_ctime":1666754182,"is_pvip":true,"discussion_count":0,"race_medal":4,"score":"1666754182","product_id":100024701,"comment_content":"å®šä¹‰çš„æ•°æ®ç»“æ„åå­—å®åœ¨å¤ªå¤šäº†ï¼Œçœ‹ç€çœ‹ç€å°±æ™•äº†ï¼Œå¾ˆç—›è‹¦ã€‚<br><br>è¿˜æ˜¯å¾—æŠŠå†…å­˜ç®¡ç†çš„åŸºæœ¬æ€æƒ³å’Œæ•´ä½“æµç¨‹ææ¸…æ¥šï¼Œæœ€å¥½äº†ç„¶äºèƒ¸ï¼Œè¯»èµ·æ¥æ‰èˆ’æœä¸€äº›ã€‚<br><br>å¦å¤–é‡åˆ°è¿™äº›ç¼©å†™ï¼Œæ¯æ¬¡éƒ½è¦æƒ³è¿™åˆ°åº•æŒ‡ä»£ä»€ä¹ˆç»“æ„ï¼Œæ¯æ¬¡éƒ½å¾—è½¬åŒ–ä¸‹ï¼Œç‰¹åˆ«è´¹è„‘å­ï¼Œæƒ³ç€æƒ³ç€å°±ç´¯äº†ï¼Œä¸€æ¥ä¸€å›ï¼Œå°±è¿·å¤±äº†...... æˆ‘è¦å»éš”å£ä¸“æ è¡¥ä¸€ä¸‹å†…å­˜çš„åŸºç¡€çŸ¥è¯†ã€‚","like_count":0},{"had_liked":false,"id":336151,"user_name":"å¼ å¯å¤«æ–¯åŸº","can_delete":false,"product_type":"c1","uid":1076487,"ip_address":"","ucode":"3B8DF6D98583F2","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIKoEicqUZTJly55qoUXRmK4wia7YbnibsMncJaO6tKgKAQNJRfpMsibvfeiaukIibsCsuaic8QjQ3gOoTGA/132","comment_is_top":false,"comment_ctime":1645957289,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1645957289","product_id":100024701,"comment_content":"åšæŒåªçœ‹æ€»ç»“ã€‚ã€‚ã€‚ã€‚","like_count":0},{"had_liked":false,"id":332489,"user_name":"@è®¸è¿˜çœŸ","can_delete":false,"product_type":"c1","uid":1099324,"ip_address":"","ucode":"6D754D5AE44CEC","user_header":"https://static001.geekbang.org/account/avatar/00/10/c6/3c/8ab9deb0.jpg","comment_is_top":false,"comment_ctime":1643273575,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1643273575","product_id":100024701,"comment_content":"å›æ¥å†çœ‹ ","like_count":0},{"had_liked":false,"id":306305,"user_name":"ç›¸é€¢æ˜¯ç¼˜","can_delete":false,"product_type":"c1","uid":1060730,"ip_address":"","ucode":"CB299F53A95654","user_header":"https://static001.geekbang.org/account/avatar/00/10/2f/7a/ab6c811c.jpg","comment_is_top":false,"comment_ctime":1628489996,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1628489996","product_id":100024701,"comment_content":"ä¸€ç›´æœ‰ä¸€ä¸ªç–‘é—®ï¼Œåº”ç”¨ç©ºé—´å’Œå†…å­˜ç©ºé—´æœ‰å„è‡ªçš„é¡µè¡¨ï¼Œè™šæ‹Ÿå†…å­˜ä¸ºä»€ä¹ˆè¦åˆ’åˆ†ä¸ºç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´å‘¢ï¼Œæœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿå†…æ ¸ç©ºé—´å’Œåº”ç”¨ç©ºé—´ä»è™šæ‹Ÿå†…å­˜çœ‹éƒ½èƒ½ç”³è¯·0~4Gçš„å†…å­˜ï¼ˆå‡å¦‚æ˜¯32ä½æœºï¼‰ï¼Œä¼šæœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿä¸ºä»€ä¹ˆä¸ºå†…æ ¸åˆ†é…å†…å­˜çš„æ—¶å€™ç¡¬è¦è§„å®š3Gä»¥ä¸Šçš„æ‰æ˜¯å†…æ ¸ç”¨çš„å‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":2028811,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/f5/0b/73628618.jpg","nickname":"å…”å˜Ÿå˜Ÿ","note":"","ucode":"5A9042B4C7670C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":391603,"discussion_content":"æƒé™é—®é¢˜ï¼Œå†…æ ¸æ‰€æœ‰taskä¸ºäº†æ•ˆç‡è¦ç”¨åŒä¸€ä¸ªç©ºé—´ï¼Œè€Œç”¨æˆ·æ€è¦éš”ç¦»ï¼Œç”¨ä¸åŒçš„è¡¨ï¼Œé‚£ä¸¤è€…å°±ä¸å¯èƒ½ç”¨åŒä¸€ä¸ªç©ºé—´","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630548293,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":250750,"user_name":"stackWarn","can_delete":false,"product_type":"c1","uid":1002005,"ip_address":"","ucode":"89672E452DEBA5","user_header":"https://static001.geekbang.org/account/avatar/00/0f/4a/15/106eaaa8.jpg","comment_is_top":false,"comment_ctime":1601210134,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1601210134","product_id":100024701,"comment_content":"å¯¹äºå†…æ ¸æ€ï¼Œkmalloc åœ¨åˆ†é…å¤§å†…å­˜çš„æ—¶å€™ï¼Œä»¥åŠ vmalloc åˆ†é…ä¸è¿ç»­ç‰©ç†é¡µçš„æ—¶å€™ï¼Œç›´æ¥ä½¿ç”¨ä¼™ä¼´ç³»ç»Ÿï¼Œåˆ†é…åè½¬æ¢ä¸ºè™šæ‹Ÿåœ°å€ï¼Œè®¿é—®çš„æ—¶å€™éœ€è¦é€šè¿‡å†…æ ¸é¡µè¡¨è¿›è¡Œæ˜ å°„ã€‚ <br>kmallocä¸æ˜¯åˆ†é…å°å†…å­˜çš„å—ï¼Ÿï¼Ÿæ²¡æ‡‚è¿™é‡Œ","like_count":0},{"had_liked":false,"id":250243,"user_name":"å¢¨æ¸Šæˆ˜ç¥01","can_delete":false,"product_type":"c1","uid":1046665,"ip_address":"","ucode":"79668ADBB2A4DA","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f8/89/7431e82e.jpg","comment_is_top":false,"comment_ctime":1601001782,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1601001782","product_id":100024701,"comment_content":"ä¸ºä»€ä¹ˆä»ç”¨æˆ·æ€åˆ°å†…æ ¸æ€ï¼Œè¯»å†™æ•°æ®éƒ½éœ€è¦æ‹·è´ï¼Ÿ","like_count":0},{"had_liked":false,"id":205546,"user_name":"çš®çš®ä¾ ","can_delete":false,"product_type":"c1","uid":1258402,"ip_address":"","ucode":"04205990C1DE1F","user_header":"https://static001.geekbang.org/account/avatar/00/13/33/a2/6c0ffc15.jpg","comment_is_top":false,"comment_ctime":1586669746,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1586669746","product_id":100024701,"comment_content":"ç”¨æˆ·æ€å¯ä»¥ç”¨kmallocç›´æ¥åˆ†é…å¤§å†…å­˜ä¹ˆï¼Ÿ","like_count":0},{"had_liked":false,"id":174980,"user_name":"Dylan","can_delete":false,"product_type":"c1","uid":1040236,"ip_address":"","ucode":"58064D0C9F9F5F","user_header":"https://static001.geekbang.org/account/avatar/00/0f/df/6c/5af32271.jpg","comment_is_top":false,"comment_ctime":1580486166,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1580486166","product_id":100024701,"comment_content":"æˆ‘è®°å¾—kmalloc åˆ†é…çš„å†…å­˜å¤§å°æœ‰é™åˆ¶çš„ï¼Œ128k","like_count":0},{"had_liked":false,"id":155352,"user_name":"czh","can_delete":false,"product_type":"c1","uid":1159078,"ip_address":"","ucode":"649FE5C9269D69","user_header":"https://static001.geekbang.org/account/avatar/00/11/af/a6/3f15ba2f.jpg","comment_is_top":false,"comment_ctime":1574681276,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1574681276","product_id":100024701,"comment_content":"å¯¹äºå†…å­˜ï¼Œè¦æé†’è‡ªå·±å†…æ ¸æ€å’Œç”¨æˆ·æ€çš„æ¦‚å¿µï¼Œè™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€çš„æ¦‚å¿µï¼","like_count":0},{"had_liked":false,"id":138006,"user_name":"kdb_reboot","can_delete":false,"product_type":"c1","uid":1003594,"ip_address":"","ucode":"4C56FCA563FCA3","user_header":"https://static001.geekbang.org/account/avatar/00/0f/50/4a/04fef27f.jpg","comment_is_top":false,"comment_ctime":1569978401,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1569978401","product_id":100024701,"comment_content":"è€å¸ˆï¼Œé’ˆå¯¹å†…å­˜ç®¡ç†æœ‰ä»€ä¹ˆèµ„æ–™æ¨èå—ï¼Œçœ‹çš„æœ‰ç‚¹æ™•ã€‚å‘ç°äº†ä¸€ä»¶äº‹æƒ…ï¼šè™½ç„¶è€å¸ˆè®²çš„å¾ˆå¥½ï¼Œä½†æ˜¯å¦‚æœé’ˆå¯¹ä¸ªäººï¼Œçœ‹ä¸“æ çš„è¯ï¼Œè¿˜æ˜¯æœ‰å¾ˆå¤šéšå«ä¿¡æ¯éœ€è¦è‡ªå·±å»äº†è§£","like_count":0},{"had_liked":false,"id":117434,"user_name":"æ ‹èƒ½","can_delete":false,"product_type":"c1","uid":1006849,"ip_address":"","ucode":"8BD9C939D3E8E1","user_header":"https://static001.geekbang.org/account/avatar/00/0f/5d/01/9cd84003.jpg","comment_is_top":false,"comment_ctime":1564046427,"is_pvip":false,"replies":[{"id":"46414","content":"kmallocå†…æ ¸ç©ºé—´å†…å­˜ç”³è¯·å‡½æ•°ã€‚","user_name":"ä½œè€…å›å¤","comment_id":117434,"uid":"1001590","ip_address":"","utype":1,"ctime":1566299296,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"1564046427","product_id":100024701,"comment_content":"æ²¡å¤ªçœ‹æ‡‚kmallocåˆæ˜¯ä»å“ªé‡Œæ¥çš„ï¼Œæ˜¯å†™é”™äº†ä¹ˆï¼Ÿï¼ˆè¿™ä¸ªæˆ‘è¿˜ç‰¹æ„å¾€å‰æ‰¾äº†ä¸‹ï¼Œä»¥ä¸ºæ˜¯kmmapï¼Œç”¨äºå†…å­˜æ˜ å°„åŒºçš„å‘¢ï¼‰","like_count":0,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":459969,"discussion_content":"kmallocå†…æ ¸ç©ºé—´å†…å­˜ç”³è¯·å‡½æ•°ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566299296,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}