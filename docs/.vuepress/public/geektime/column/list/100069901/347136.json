{"id":347136,"title":"18 | å®æˆ˜ï¼šå¦‚ä½•åŸºäºRaftä»0åˆ°1æ„å»ºä¸€ä¸ªæ”¯æŒå¤šå­˜å‚¨å¼•æ“åˆ†å¸ƒå¼KVæœåŠ¡ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å”èªã€‚</p><p>é€šè¿‡å‰é¢è¯¾ç¨‹çš„å­¦ä¹ ï¼Œæˆ‘ç›¸ä¿¡ä½ å·²ç»å¯¹etcdåŸºæœ¬æ¶æ„ã€æ ¸å¿ƒç‰¹æ€§æœ‰äº†ä¸€å®šç†è§£ã€‚å¦‚æœè®©ä½ åŸºäºRaftåè®®ï¼Œå®ç°ä¸€ä¸ªç®€æ˜“çš„ç±»etcdã€æ”¯æŒå¤šå­˜å‚¨å¼•æ“çš„åˆ†å¸ƒå¼KVæœåŠ¡ï¼Œå¹¶èƒ½æ»¡è¶³è¯»å¤šå†™å°‘ã€è¯»å°‘å†™å¤šçš„ä¸åŒä¸šåŠ¡åœºæ™¯è¯‰æ±‚ï¼Œä½ çŸ¥é“è¯¥æ€ä¹ˆåŠ¨æ‰‹å—ï¼Ÿ</p><p>çº¸ä¸Šå¾—æ¥ç»ˆè§‰æµ…ï¼Œç»çŸ¥æ­¤äº‹è¦èº¬è¡Œã€‚</p><p>ä»Šå¤©æˆ‘å°±å’Œä½ èŠèŠå¦‚ä½•å®ç°ä¸€ä¸ªç±»etcdã€æ”¯æŒå¤šå­˜å‚¨å¼•æ“çš„KVæœåŠ¡ï¼Œæˆ‘ä»¬å°†åŸºäºetcdè‡ªå¸¦çš„<a href=\"https://github.com/etcd-io/etcd/tree/v3.4.9/contrib/raftexample\">raftexample</a>é¡¹ç›®å¿«é€Ÿæ„å»ºå®ƒã€‚</p><p>ä¸ºäº†æ–¹ä¾¿åé¢æè¿°ï¼Œæˆ‘æŠŠå®ƒå‘½åä¸ºmetcdï¼ˆè¡¨ç¤ºå¾®å‹çš„etcdï¼‰ï¼Œå®ƒæ˜¯raftexampleçš„åŠ å¼ºç‰ˆã€‚å¸Œæœ›é€šè¿‡metcdè¿™ä¸ªå°å°çš„å®æˆ˜é¡¹ç›®ï¼Œèƒ½å¤Ÿå¸®åŠ©ä½ è¿›ä¸€æ­¥ç†è§£etcdä¹ƒè‡³åˆ†å¸ƒå¼å­˜å‚¨æœåŠ¡çš„æ ¸å¿ƒæ¶æ„ã€åŸç†ã€å…¸å‹é—®é¢˜è§£å†³æ–¹æ¡ˆã€‚</p><p>åŒæ—¶åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘å°†è¯¦ç»†ä¸ºä½ ä»‹ç»etcdçš„Raftç®—æ³•å·¥ç¨‹å®ç°åº“ã€ä¸åŒç±»å‹å­˜å‚¨å¼•æ“çš„ä¼˜ç¼ºç‚¹ï¼Œæ‹“å®½ä½ çš„çŸ¥è¯†è§†é‡ï¼Œä¸ºä½ ç‹¬ç«‹åˆ†æetcdæºç ï¼Œå¤¯å®åŸºç¡€ã€‚</p><h2>æ•´ä½“æ¶æ„è®¾è®¡</h2><p>åœ¨å’Œä½ æ·±å…¥èŠä»£ç ç»†èŠ‚ä¹‹å‰ï¼Œé¦–å…ˆæˆ‘å’Œä½ ä»æ•´ä½“ä¸Šä»‹ç»ä¸‹ç³»ç»Ÿæ¶æ„ã€‚</p><p>ä¸‹é¢æ˜¯æˆ‘ç»™ä½ ç”»çš„metcdæ•´ä½“æ¶æ„è®¾è®¡ï¼Œå®ƒç”±APIå±‚ã€Raftå±‚çš„å…±è¯†æ¨¡å—ã€é€»è¾‘å±‚åŠå­˜å‚¨å±‚ç»„æˆçš„çŠ¶æ€æœºç»„æˆã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘åˆ†åˆ«å’Œä½ ç®€è¦åˆ†æä¸‹APIè®¾è®¡åŠå¤åˆ¶çŠ¶æ€æœºã€‚</p><!-- [[[read_end]]] --><p><img src=\"https://static001.geekbang.org/resource/image/5e/03/5e9f6882a6f6e357e5c2c5yyffda4e03.png?wh=1920*1166\" alt=\"\"></p><h3>APIè®¾è®¡</h3><p>APIæ˜¯è½¯ä»¶ç³»ç»Ÿå¯¹å¤–çš„è¯­è¨€ï¼Œå®ƒæ˜¯åº”ç”¨ç¼–ç¨‹æ¥å£çš„ç¼©å†™ï¼Œç”±ä¸€ç»„æ¥å£å®šä¹‰å’Œåè®®ç»„æˆã€‚</p><p>åœ¨è®¾è®¡APIçš„æ—¶å€™ï¼Œæˆ‘ä»¬å¾€å¾€ä¼šè€ƒè™‘ä»¥ä¸‹å‡ ä¸ªå› ç´ ï¼š</p><ul>\n<li>æ€§èƒ½ã€‚å¦‚etcd v2ä½¿ç”¨çš„æ˜¯ç®€å•çš„HTTP/1.xï¼Œæ€§èƒ½ä¸Šæ— æ³•æ»¡è¶³å¤§è§„æ¨¡Kubernetesé›†ç¾¤ç­‰åœºæ™¯çš„è¯‰æ±‚ï¼Œå› æ­¤etcd v3ä½¿ç”¨çš„æ˜¯åŸºäºHTTP/2çš„gRPCåè®®ã€‚</li>\n<li>æ˜“ç”¨æ€§ã€å¯è°ƒè¯•æ€§ã€‚å¦‚æœ‰çš„å†…éƒ¨é«˜å¹¶å‘æœåŠ¡ä¸ºäº†æ»¡è¶³æ€§èƒ½ç­‰è¯‰æ±‚ï¼Œä½¿ç”¨çš„æ˜¯UDPåè®®ã€‚ç›¸æ¯”HTTPåè®®ï¼ŒUDPåè®®æ˜¾ç„¶åœ¨æ˜“ç”¨æ€§ã€å¯è°ƒè¯•æ€§ä¸Šå­˜åœ¨ä¸€å®šçš„å·®è·ã€‚</li>\n<li>å¼€å‘æ•ˆç‡ã€è·¨å¹³å°ã€å¯ç§»æ¤æ€§ã€‚ç›¸æ¯”åŸºäºè£¸UDPã€TCPåè®®è®¾è®¡çš„æ¥å£ï¼Œå¦‚æœä½ ä½¿ç”¨Protobufç­‰IDLè¯­è¨€ï¼Œå®ƒæ”¯æŒè·¨å¹³å°ã€ä»£ç è‡ªåŠ¨è‡ªåŠ¨ç”Ÿæˆï¼Œå¼€å‘æ•ˆç‡æ›´é«˜ã€‚</li>\n<li>å®‰å…¨æ€§ã€‚å¦‚ç›¸æ¯”HTTPåè®®ï¼Œä½¿ç”¨HTTPSåè®®å¯å¯¹é€šä¿¡æ•°æ®åŠ å¯†æ›´å®‰å…¨ï¼Œå¯é€‚ç”¨äºä¸å®‰å…¨çš„ç½‘ç»œç¯å¢ƒï¼ˆæ¯”å¦‚å…¬ç½‘ä¼ è¾“ï¼‰ã€‚</li>\n<li>æ¥å£å¹‚ç­‰æ€§ã€‚å¹‚ç­‰æ€§ç®€å•æ¥è¯´ï¼Œå°±æ˜¯åŒæ ·ä¸€ä¸ªæ¥å£è¯·æ±‚ä¸€æ¬¡ä¸å¤šæ¬¡çš„æ•ˆæœä¸€æ ·ã€‚è‹¥ä½ çš„æ¥å£å¯¹å¤–ä¿è¯å¹‚ç­‰æ€§ï¼Œåˆ™å¯é™ä½ä½¿ç”¨è€…çš„å¤æ‚åº¦ã€‚</li>\n</ul><p>å› ä¸ºæˆ‘ä»¬åœºæ™¯çš„æ˜¯POC(Proof of concept)ã€Demoå¼€å‘ï¼Œå› æ­¤åœ¨metcdé¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬ä¼˜å…ˆè€ƒè™‘ç‚¹æ˜¯æ˜“ç”¨æ€§ã€å¯è°ƒè¯•æ€§ï¼Œé€‰æ‹©HTTP/1.xåè®®ï¼Œæ¥å£ä¸Šä¸ºäº†æ»¡è¶³key-valueæ“ä½œï¼Œæ”¯æŒGetå’ŒPutæ¥å£å³å¯ã€‚</p><p>å‡è®¾metcdé¡¹ç›®ä½¿ç”¨3379ç«¯å£ï¼ŒPutå’ŒGetæ¥å£ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p><ul>\n<li>Putæ¥å£ï¼Œè®¾ç½®key-value</li>\n</ul><pre><code>curl -L http://127.0.0.1:3379/hello -XPUT -d world\n</code></pre><ul>\n<li>Getæ¥å£ï¼ŒæŸ¥è¯¢key-value</li>\n</ul><pre><code>curl -L http://127.0.0.1:3379/hello\nworld\n</code></pre><h3>å¤åˆ¶çŠ¶æ€æœº</h3><p>äº†è§£å®ŒAPIè®¾è®¡ï¼Œé‚£æœ€æ ¸å¿ƒçš„å¤åˆ¶çŠ¶æ€æœºæ˜¯å¦‚ä½•å·¥ä½œçš„å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬çŸ¥é“etcdæ˜¯åŸºäºä¸‹å›¾å¤åˆ¶çŠ¶æ€æœºå®ç°çš„åˆ†å¸ƒå¼KVæœåŠ¡ï¼Œå¤åˆ¶çŠ¶æ€æœºç”±å…±è¯†æ¨¡å—ã€æ—¥å¿—æ¨¡å—ã€çŠ¶æ€æœºç»„æˆã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/5c/4f/5c7a3079032f90120a6b309ee401fc4f.png?wh=605*319\" alt=\"\"></p><p>æˆ‘ä»¬çš„å®æˆ˜é¡¹ç›®metcdï¼Œä¹Ÿæ­£æ˜¯ä½¿ç”¨ä¸ä¹‹ä¸€æ ·çš„æ¨¡å‹ï¼Œå¹¶ä¸”ä½¿ç”¨etcdé¡¹ç›®ä¸­å®ç°çš„Raftç®—æ³•åº“ä½œä¸ºå…±è¯†æ¨¡å—ï¼Œæ­¤ç®—æ³•åº“å·²è¢«å¹¿æ³›åº”ç”¨åœ¨etcdã€cockroachdbã€dgraphç­‰å¼€æºé¡¹ç›®ä¸­ã€‚</p><p>ä»¥ä¸‹æ˜¯å¤åˆ¶çŠ¶æ€æœºçš„å†™è¯·æ±‚æµç¨‹ï¼š</p><ul>\n<li>clientå‘èµ·ä¸€ä¸ªå†™è¯·æ±‚ï¼ˆput hello = worldï¼‰ï¼›</li>\n<li>serverå‘Raftå…±è¯†æ¨¡å—æäº¤è¯·æ±‚ï¼Œå…±è¯†æ¨¡å—ç”Ÿæˆä¸€ä¸ªå†™ææ¡ˆæ—¥å¿—æ¡ç›®ã€‚è‹¥serveræ˜¯Leaderï¼Œåˆ™æŠŠæ—¥å¿—æ¡ç›®å¹¿æ’­ç»™å…¶ä»–èŠ‚ç‚¹ï¼Œå¹¶æŒä¹…åŒ–æ—¥å¿—æ¡ç›®åˆ°WALä¸­ï¼›</li>\n<li>å½“ä¸€åŠä»¥ä¸ŠèŠ‚ç‚¹æŒä¹…åŒ–æ—¥å¿—æ¡ç›®åï¼ŒLeaderçš„å…±è¯†æ¨¡å—å°†æ­¤æ—¥å¿—æ¡ç›®æ ‡è®°ä¸ºå·²æäº¤ï¼ˆcommittedï¼‰ï¼Œå¹¶é€šçŸ¥å…¶ä»–èŠ‚ç‚¹æäº¤ï¼›</li>\n<li>serverä»å…±è¯†æ¨¡å—è·å–å·²ç»æäº¤çš„æ—¥å¿—æ¡ç›®ï¼Œå¼‚æ­¥åº”ç”¨åˆ°çŠ¶æ€æœºå­˜å‚¨ä¸­ï¼ˆboltdb/leveldb/memoryï¼‰ï¼Œç„¶åè¿”å›ç»™clientã€‚</li>\n</ul><h3>å¤šå­˜å‚¨å¼•æ“</h3><p>äº†è§£å®Œå¤åˆ¶çŠ¶æ€æœºæ¨¡å‹åï¼Œæˆ‘å’Œä½ å†æ·±å…¥ä»‹ç»ä¸‹çŠ¶æ€æœºã€‚çŠ¶æ€æœºä¸­æœ€æ ¸å¿ƒæ¨¡å—å½“ç„¶æ˜¯å­˜å‚¨å¼•æ“ï¼Œé‚£è¦å¦‚ä½•åŒæ—¶æ”¯æŒå¤šç§å­˜å‚¨å¼•æ“å‘¢ï¼Ÿ</p><p>metcdé¡¹ç›®å°†åŸºäºetcdæœ¬èº«è‡ªå¸¦çš„raftexampleé¡¹ç›®è¿›è¡Œå¿«é€Ÿå¼€å‘ï¼Œè€Œraftexampleæœ¬èº«åªæ”¯æŒå†…å­˜å­˜å‚¨ã€‚</p><p>å› æ­¤æˆ‘ä»¬é€šè¿‡å°†KVå­˜å‚¨æ¥å£è¿›è¡ŒæŠ½è±¡åŒ–è®¾è®¡ï¼Œå®ç°æ”¯æŒå¤šå­˜å‚¨å¼•æ“ã€‚KVStore interfaceçš„å®šä¹‰å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>type KVStore interface {\n   // LookUp get key value\n   Lookup(key string) (string, bool)\n\n   // Propose propose kv request into raft state machine\n   Propose(k, v string)\n\n   // ReadCommits consume entry from raft state machine into KvStore map until error\n   ReadCommits(commitC &lt;-chan *string, errorC &lt;-chan error)\n\n   // Snapshot return KvStore snapshot\n   Snapshot() ([]byte, error)\n\n   // RecoverFromSnapshot recover data from snapshot\n   RecoverFromSnapshot(snapshot []byte) error\n\n   // Close close backend databases\n   Close() err\n}\n</code></pre><p>åŸºäºKVæ¥å£æŠ½è±¡åŒ–çš„è®¾è®¡ï¼Œæˆ‘ä»¬åªéœ€è¦é’ˆå¯¹å…·ä½“çš„å­˜å‚¨å¼•æ“ï¼Œå®ç°å¯¹åº”çš„æ“ä½œå³å¯ã€‚</p><p>æˆ‘ä»¬æœŸæœ›æ”¯æŒä¸‰ç§å­˜å‚¨å¼•æ“ï¼Œåˆ†åˆ«æ˜¯å†…å­˜mapã€boltdbã€leveldbï¼Œå¹¶åšä¸€ç³»åˆ—ç®€åŒ–è®¾è®¡ã€‚ä¸€ç»„metcdå®ä¾‹ï¼Œé€šè¿‡metcdå¯åŠ¨æ—¶çš„é…ç½®æ¥å†³å®šä½¿ç”¨å“ªç§å­˜å‚¨å¼•æ“ã€‚ä¸åŒä¸šåŠ¡åœºæ™¯ä¸åŒå®ä¾‹ï¼Œæ¯”å¦‚è¯»å¤šå†™å°‘çš„å­˜å‚¨å¼•æ“å¯ä½¿ç”¨boltdbï¼Œå†™å¤šè¯»å°‘çš„å¯ä½¿ç”¨leveldbã€‚</p><p>æ¥ä¸‹æ¥æˆ‘å’Œä½ é‡ç‚¹ä»‹ç»ä¸‹å­˜å‚¨å¼•æ“çš„é€‰å‹åŠåŸç†ã€‚</p><h4>boltdb</h4><p>boltdbæ˜¯ä¸€ä¸ªåŸºäºB+ treeå®ç°çš„å­˜å‚¨å¼•æ“åº“ï¼Œåœ¨<a href=\"https://time.geekbang.org/column/article/342527?utm_term=zeus18YAD&amp;utm_source=app&amp;utm_medium=geektime\">10</a>ä¸­æˆ‘å·²å’Œä½ è¯¦ç»†ä»‹ç»è¿‡åŸç†ã€‚</p><p>boltdbä¸ºä»€ä¹ˆé€‚åˆè¯»å¤šå†™å°‘ï¼Ÿ</p><p>å¯¹äºè¯»è¯·æ±‚è€Œè¨€ï¼Œä¸€èˆ¬æƒ…å†µä¸‹å®ƒå¯ç›´æ¥ä»å†…å­˜ä¸­åŸºäºB+ treeéå†ï¼Œå¿«é€Ÿè·å–æ•°æ®è¿”å›ç»™clientï¼Œä¸æ¶‰åŠç»è¿‡ç£ç›˜I/Oã€‚</p><p>å¯¹äºå†™è¯·æ±‚ï¼Œå®ƒåŸºäºB+ treeæŸ¥æ‰¾å†™å…¥ä½ç½®ï¼Œæ›´æ–°key-valueã€‚äº‹åŠ¡æäº¤æ—¶ï¼Œå†™è¯·æ±‚åŒ…æ‹¬B+ treeé‡å¹³è¡¡ã€åˆ†è£‚ã€æŒä¹…åŒ–ditry pageã€æŒä¹…åŒ–freelistã€æŒä¹…åŒ–meta pageæµç¨‹ã€‚åŒæ—¶ï¼Œditry pageå¯èƒ½åˆ†å¸ƒåœ¨æ–‡ä»¶çš„å„ä¸ªä½ç½®ï¼Œå®ƒå‘èµ·çš„æ˜¯éšæœºå†™ç£ç›˜I/Oã€‚</p><p>å› æ­¤åœ¨boltdbä¸­ï¼Œå®Œæˆä¸€ä¸ªå†™è¯·æ±‚çš„å¼€é”€ç›¸æ¯”è¯»è¯·æ±‚æ˜¯å¤§å¾ˆå¤šçš„ã€‚æ­£å¦‚æˆ‘åœ¨<a href=\"https://time.geekbang.org/column/article/345588\">16</a>å’Œ<a href=\"https://time.geekbang.org/column/article/346471\">17</a>ä¸­ç»™ä½ ä»‹ç»çš„ä¸€æ ·ï¼Œä¸€ä¸ª3èŠ‚ç‚¹çš„8æ ¸16Gç©ºé›†ç¾¤ï¼Œçº¿æ€§è¯»æ€§èƒ½å¯ä»¥è¾¾åˆ°19ä¸‡QPSï¼Œè€Œå†™QPSä»…ä¸º5ä¸‡ã€‚</p><h4>leveldb</h4><p>é‚£è¦å¦‚ä½•è®¾è®¡é€‚åˆå†™å¤šè¯»å°‘çš„å­˜å‚¨å¼•æ“å‘¢?</p><p>æœ€ç®€å•çš„æ€è·¯å½“ç„¶æ˜¯å†™å†…å­˜æœ€å¿«ã€‚å¯æ˜¯å†…å­˜æœ‰é™çš„ï¼Œæ— æ³•æ”¯æ’‘å¤§å®¹é‡çš„æ•°æ®å­˜å‚¨ï¼Œä¸æŒä¹…åŒ–æ•°æ®ä¼šä¸¢å¤±ã€‚</p><p>é‚£èƒ½å¦ç›´æ¥å°†æ•°æ®é¡ºåºè¿½åŠ åˆ°æ–‡ä»¶æœ«å°¾ï¼ˆAOFï¼‰å‘¢ï¼Ÿå› ä¸ºç£ç›˜çš„ç‰¹ç‚¹æ˜¯é¡ºåºå†™æ€§èƒ½æ¯”è¾ƒå¿«ã€‚</p><p>å½“ç„¶å¯ä»¥ã€‚<a href=\"https://en.wikipedia.org/wiki/Bitcask\">Bitcask</a>å­˜å‚¨æ¨¡å‹å°±æ˜¯é‡‡ç”¨AOFæ¨¡å¼ï¼ŒæŠŠå†™è¯·æ±‚é¡ºåºè¿½åŠ åˆ°æ–‡ä»¶ã€‚Facebookçš„å›¾ç‰‡å­˜å‚¨<a href=\"https://www.usenix.org/legacy/event/osdi10/tech/full_papers/Beaver.pdf\">Haystack</a>æ ¹æ®å…¶è®ºæ–‡ä»‹ç»ï¼Œä¹Ÿæ˜¯ä½¿ç”¨ç±»ä¼¼çš„æ–¹æ¡ˆæ¥è§£å†³å¤§è§„æ¨¡å†™å…¥ç—›ç‚¹ã€‚</p><p>é‚£åœ¨AOFå†™å…¥æ¨¡å‹ä¸­å¦‚ä½•å®ç°æŸ¥è¯¢æ•°æ®å‘¢ï¼Ÿ</p><p>å¾ˆæ˜¾ç„¶é€šè¿‡éå†æ–‡ä»¶ä¸€ä¸ªä¸ªåŒ¹é…keyæ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯å®ƒçš„æ€§èƒ½æ˜¯æå·®çš„ã€‚ä¸ºäº†å®ç°é«˜æ€§èƒ½çš„æŸ¥è¯¢ï¼Œæœ€ç†æƒ³çš„è§£å†³æ–¹æ¡ˆä»ç›´æ¥ä»å†…å­˜ä¸­æŸ¥è¯¢ï¼Œä½†æ˜¯å†…å­˜æ˜¯æœ‰é™çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬èƒ½å¦é€šè¿‡å†…å­˜ç´¢å¼•æ¥è®°å½•ä¸€ä¸ªkey-valueæ•°æ®åœ¨æ–‡ä»¶ä¸­çš„åç§»é‡ï¼Œå®ç°ä»ç£ç›˜å¿«é€Ÿè¯»å–å‘¢ï¼Ÿ</p><p>æ˜¯çš„ï¼Œè¿™æ­£æ˜¯<a href=\"https://en.wikipedia.org/wiki/Bitcask\">Bitcask</a>å­˜å‚¨æ¨¡å‹çš„æŸ¥è¯¢çš„å®ç°ï¼Œå®ƒé€šè¿‡å†…å­˜å“ˆå¸Œè¡¨ç»´æŠ¤å„ä¸ªkey-valueæ•°æ®çš„ç´¢å¼•ï¼Œå®ç°äº†å¿«é€ŸæŸ¥æ‰¾key-valueæ•°æ®ã€‚ä¸è¿‡ï¼Œå†…å­˜ä¸­è™½ç„¶åªä¿å­˜keyç´¢å¼•ä¿¡æ¯ï¼Œä½†æ˜¯å½“keyè¾ƒå¤šçš„æ—¶å€™ï¼Œå…¶å¯¹å†…å­˜è¦æ±‚ä¾ç„¶æ¯”è¾ƒé«˜ã€‚</p><p>å¿«é€Ÿäº†è§£å®Œå­˜å‚¨å¼•æ“æå‡å†™æ€§èƒ½çš„æ ¸å¿ƒæ€è·¯ï¼ˆéšæœºå†™è½¬åŒ–ä¸ºé¡ºåºå†™ï¼‰ä¹‹åï¼Œé‚£leveldbå®ƒçš„åŸç†æ˜¯æ€æ ·çš„å‘¢ï¼Ÿä¸Bitcaskå­˜å‚¨æ¨¡å‹æœ‰ä»€ä¹ˆä¸ä¸€æ ·ï¼Ÿ</p><p>leveldbæ˜¯åŸºäºLSM tree(log-structured merge-tree)å®ç°çš„key-valueå­˜å‚¨ï¼Œå®ƒçš„æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆ<a href=\"https://microsoft.github.io/MLOS/notebooks/LevelDbTuning/\">å¼•ç”¨è‡ªå¾®è½¯åšå®¢</a>ï¼‰ã€‚</p><p>å®ƒæå‡å†™æ€§èƒ½çš„æ ¸å¿ƒæ€è·¯åŒæ ·æ˜¯å°†éšæœºå†™è½¬åŒ–ä¸ºé¡ºåºå†™ç£ç›˜WALæ–‡ä»¶å’Œå†…å­˜ï¼Œç»“åˆäº†æˆ‘ä»¬ä¸Šé¢è®¨è®ºçš„å†™å†…å­˜å’Œç£ç›˜ä¸¤ç§æ–¹æ³•ã€‚æ•°æ®æŒä¹…åŒ–åˆ°WALæ–‡ä»¶æ˜¯ä¸ºäº†ç¡®ä¿æœºå™¨crashåæ•°æ®ä¸ä¸¢å¤±ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/05/50/05f01951fe5862a62624b81e2ceea150.png?wh=992*677\" alt=\"\"></p><p>é‚£ä¹ˆå®ƒè¦å¦‚ä½•è§£å†³å†…å­˜ä¸è¶³å’ŒæŸ¥è¯¢çš„ç—›ç‚¹é—®é¢˜å‘¢ï¼Ÿ</p><p>æ ¸å¿ƒè§£å†³æ–¹æ¡ˆæ˜¯åˆ†å±‚çš„è®¾è®¡å’ŒåŸºäºä¸€ç³»åˆ—å¯¹è±¡çš„è½¬æ¢å’Œå‹ç¼©ã€‚æ¥ä¸‹æ¥æˆ‘ç»™ä½ åˆ†æä¸€ä¸‹ä¸Šé¢æ¶æ„å›¾å†™æµç¨‹å’Œåå°compactionä»»åŠ¡ï¼š</p><ul>\n<li>é¦–å…ˆå†™è¯·æ±‚é¡ºåºå†™å…¥Logæ–‡ä»¶(WAL)ï¼›</li>\n<li>æ›´æ–°å†…å­˜çš„Memtableã€‚leveldb Memtableåç«¯æ•°æ®ç»“æ„å®ç°æ˜¯skiplistï¼Œskiplistç›¸æ¯”å¹³è¡¡äºŒå‰æ ‘ï¼Œå®ç°ç®€å•å´åŒæ ·æ‹¥æœ‰é«˜æ€§èƒ½çš„è¯»å†™ï¼›</li>\n<li>å½“Memtableè¾¾åˆ°ä¸€å®šçš„é˜ˆå€¼æ—¶ï¼Œè½¬æ¢æˆä¸å¯å˜çš„Memtableï¼Œä¹Ÿå°±æ˜¯åªè¯»ä¸å¯å†™ï¼›</li>\n<li>leveldbåå°Compactä»»åŠ¡ä¼šå°†ä¸å¯å˜çš„Memtableç”ŸæˆSSTableæ–‡ä»¶ï¼Œå®ƒæœ‰åºåœ°å­˜å‚¨ä¸€ç³»åˆ—key-valueæ•°æ®ã€‚æ³¨æ„SSTæ–‡ä»¶æŒ‰å†™å…¥æ—¶é—´è¿›è¡Œäº†åˆ†å±‚ï¼ŒLevelå±‚æ¬¡è¶Šå°æ•°æ®è¶Šæ–°ã€‚Manifestæ–‡ä»¶è®°å½•äº†å„ä¸ªSSTableæ–‡ä»¶å¤„äºå“ªä¸ªå±‚çº§ã€å®ƒçš„æœ€å°ä¸æœ€å¤§keyèŒƒå›´ï¼›</li>\n<li>å½“æŸä¸ªlevelä¸‹çš„SSTableæ–‡ä»¶æ•°ç›®è¶…è¿‡ä¸€å®šé˜ˆå€¼åï¼ŒCompactä»»åŠ¡ä¼šä»è¿™ä¸ªlevelçš„SSTableä¸­é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶ï¼ˆlevel&gt;0ï¼‰ï¼Œå°†å…¶å’Œé«˜ä¸€å±‚çº§çš„level+1çš„SSTableæ–‡ä»¶åˆå¹¶ï¼›</li>\n<li>æ³¨æ„level 0æ˜¯ç”±Immutableç›´æ¥ç”Ÿæˆçš„ï¼Œå› æ­¤level 0 SSTableæ–‡ä»¶ä¸­çš„key-valueå­˜åœ¨ç›¸äº’é‡å ã€‚è€Œlevel &gt; 0æ—¶ï¼Œåœ¨å’Œæ›´é«˜ä¸€å±‚SSTableåˆå¹¶è¿‡ç¨‹ä¸­ï¼Œå‚ä¸çš„SSTableæ–‡ä»¶æ˜¯å¤šä¸ªï¼Œleveldbä¼šç¡®ä¿å„ä¸ªSSTableä¸­çš„key-valueä¸é‡å ã€‚</li>\n</ul><p>äº†è§£å®Œå†™æµç¨‹ï¼Œè¯»æµç¨‹ä¹Ÿå°±ç®€å•äº†ï¼Œæ ¸å¿ƒæ­¥éª¤å¦‚ä¸‹ï¼š</p><ul>\n<li>ä»Memtableè·³è·ƒè¡¨ä¸­æŸ¥è¯¢keyï¼›</li>\n<li>æœªæ‰¾åˆ°åˆ™ä»Immutableä¸­æŸ¥æ‰¾ï¼›</li>\n<li>Immutableä»æœªå‘½ä¸­ï¼Œåˆ™æŒ‰ç…§leveldbçš„åˆ†å±‚å±æ€§ï¼Œå› level 0 SSTableæ–‡ä»¶æ˜¯ç›´æ¥ä»Immutableç”Ÿæˆçš„ï¼Œlevel 0å­˜åœ¨ç‰¹æ®Šæ€§ï¼Œå› æ­¤ä½ éœ€è¦ä»level 0éå†SSTableæŸ¥æ‰¾keyï¼›</li>\n<li>level 0ä¸­è‹¥æœªå‘½ä¸­ï¼Œåˆ™ä»level 1ä¹ƒè‡³æ›´é«˜çš„å±‚æ¬¡æŸ¥æ‰¾ã€‚levelå¤§äº0æ—¶ï¼Œå„ä¸ªSSTableä¸­çš„keyæ˜¯ä¸å­˜åœ¨ç›¸äº’é‡å çš„ã€‚æ ¹æ®manifestè®°å½•çš„key-valueèŒƒå›´ä¿¡æ¯ï¼Œå¯å¿«é€’å®šä½åˆ°å…·ä½“çš„SSTableã€‚åŒæ—¶leveldbåŸºäº<a href=\"https://en.wikipedia.org/wiki/Bloom_filter\">bloom filter</a>å®ç°äº†å¿«é€Ÿç­›é€‰SSTableï¼Œå› æ­¤æŸ¥è¯¢æ•ˆç‡è¾ƒé«˜ã€‚</li>\n</ul><p>æ›´è¯¦ç»†åŸç†ä½ å¯ä»¥å‚è€ƒä¸€ä¸‹<a href=\"https://github.com/google/leveldb\">leveldb</a>æºç ã€‚</p><h2>å®ç°åˆ†æ</h2><p>ä»APIè®¾è®¡ã€å¤åˆ¶çŠ¶æ€æœºã€å¤šå­˜å‚¨å¼•æ“æ”¯æŒç­‰å‡ ä¸ªæ–¹é¢ä½ ä»‹ç»äº†metcdæ¶æ„è®¾è®¡åï¼Œæ¥ä¸‹æ¥æˆ‘å°±å’Œä½ é‡ç‚¹ä»‹ç»ä¸‹å…±è¯†æ¨¡å—ã€çŠ¶æ€æœºæ”¯æŒå¤šå­˜å‚¨å¼•æ“æ¨¡å—çš„æ ¸å¿ƒå®ç°è¦ç‚¹ã€‚</p><h3>Raftç®—æ³•åº“</h3><p>å…±è¯†æ¨¡å—ä½¿ç”¨çš„æ˜¯etcd <a href=\"https://github.com/etcd-io/etcd/tree/v3.4.9/raft\">Raftç®—æ³•åº“</a>ï¼Œå®ƒæ˜¯ä¸€ä¸ªç»è¿‡å¤§é‡ä¸šåŠ¡ç”Ÿäº§ç¯å¢ƒæ£€éªŒã€å…·å¤‡è‰¯å¥½å¯æ‰©å±•æ€§çš„å…±è¯†ç®—æ³•åº“ã€‚</p><p>å®ƒæä¾›äº†å“ªäº›æ¥å£ç»™ä½ ä½¿ç”¨? å¦‚ä½•æäº¤ä¸€ä¸ªææ¡ˆï¼Œå¹¶ä¸”è·å–Raftå…±è¯†æ¨¡å—è¾“å‡ºç»“æœå‘¢ï¼Ÿ</p><h4>Raft API</h4><p>Raftä½œä¸ºä¸€ä¸ªåº“ï¼Œå®ƒå¯¹å¤–æœ€æ ¸å¿ƒçš„å¯¹è±¡æ˜¯ä¸€ä¸ªåä¸º<a href=\"https://github.com/etcd-io/etcd/blob/v3.4.9/raft/node.go#L125:L203\">Node</a>çš„æ•°æ®ç»“æ„ã€‚Nodeè¡¨ç¤ºRafté›†ç¾¤ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå®ƒçš„è¾“å…¥ä¸è¾“å‡ºæ¥å£å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä¸‹é¢æˆ‘é‡ç‚¹å’Œä½ ä»‹ç»å®ƒçš„å‡ ä¸ªæ¥å£åŠŸèƒ½ï¼š</p><ul>\n<li>Campaignï¼ŒçŠ¶æ€è½¬æ¢æˆCandidateï¼Œå‘èµ·æ–°ä¸€è½®Leaderé€‰ä¸¾ï¼›</li>\n<li>Proposeï¼Œæäº¤ææ¡ˆæ¥å£ï¼›</li>\n<li>Readyï¼ŒRaftçŠ¶æ€æœºè¾“å‡ºæ¥å£ï¼Œå®ƒçš„è¿”å›æ˜¯ä¸€ä¸ªè¾“å‡ºReadyæ•°æ®ç»“æ„ç±»å‹çš„ç®¡é“ï¼Œåº”ç”¨éœ€è¦ç›‘å¬æ­¤ç®¡é“ï¼Œè·å–Readyæ•°æ®ï¼Œå¤„ç†å…¶ä¸­çš„å„ä¸ªæ¶ˆæ¯ï¼ˆå¦‚æŒä¹…åŒ–æœªæäº¤çš„æ—¥å¿—æ¡ç›®åˆ°WALä¸­ï¼Œå‘é€æ¶ˆæ¯ç»™å…¶ä»–èŠ‚ç‚¹ç­‰ï¼‰ï¼›</li>\n<li>Advanceï¼Œé€šçŸ¥RaftçŠ¶æ€æœºï¼Œåº”ç”¨å·²å¤„ç†ä¸Šä¸€ä¸ªè¾“å‡ºçš„Readyæ•°æ®ï¼Œç­‰å¾…å‘é€ä¸‹ä¸€ä¸ªReadyæ•°æ®ï¼›</li>\n<li>TransferLeaderShipï¼Œå°è¯•å°†Leaderè½¬ç§»åˆ°æŸä¸ªèŠ‚ç‚¹ï¼›</li>\n<li>Stepï¼Œå‘RaftçŠ¶æ€æœºæäº¤æ”¶åˆ°çš„æ¶ˆæ¯ï¼Œæ¯”å¦‚å½“Leaderå¹¿æ’­å®ŒMsgAppæ¶ˆæ¯ç»™FollowerèŠ‚ç‚¹åï¼ŒLeaderæ”¶åˆ°FollowerèŠ‚ç‚¹å›å¤çš„MsgAppRespæ¶ˆæ¯æ—¶ï¼Œå°±é€šè¿‡Stepæ¥å£å°†æ­¤æ¶ˆæ¯æäº¤ç»™RaftçŠ¶æ€æœºé©±åŠ¨å…¶å·¥ä½œï¼›</li>\n<li>ReadIndexï¼Œç”¨äºå®ç°çº¿æ€§è¯»ã€‚</li>\n</ul><p><img src=\"https://static001.geekbang.org/resource/image/a7/39/a79a97f8cc8294dcb93f9552fb638f39.png?wh=1920*787\" alt=\"\"></p><p>ä¸Šé¢æåˆ°çš„RaftçŠ¶æ€æœºçš„è¾“å‡º<a href=\"https://github.com/etcd-io/etcd/blob/v3.4.9/raft/node.go#L52:L90\">Readyç»“æ„</a>å«æœ‰å“ªäº›ä¿¡æ¯å‘¢? ä¸‹å›¾æ˜¯å…¶è¯¦ç»†å­—æ®µï¼Œå«ä¹‰å¦‚ä¸‹ï¼š</p><ul>\n<li>SoftStateï¼Œè½¯çŠ¶æ€ã€‚åŒ…æ‹¬é›†ç¾¤Leaderå’ŒèŠ‚ç‚¹çŠ¶æ€ï¼Œä¸éœ€è¦æŒä¹…åŒ–åˆ°WALï¼›</li>\n<li>pb.HardStateï¼Œç¡¬çŠ¶æ€ã€‚ä¸è½¯çŠ¶æ€ç›¸åï¼ŒåŒ…æ‹¬äº†èŠ‚ç‚¹å½“å‰Termã€Voteç­‰ä¿¡æ¯ï¼Œéœ€è¦æŒä¹…åŒ–åˆ°WALä¸­ï¼›</li>\n<li>ReadStatesï¼Œç”¨äºçº¿æ€§ä¸€è‡´æ€§è¯»ï¼›</li>\n<li>Entriesï¼Œåœ¨å‘å…¶ä»–èŠ‚ç‚¹å‘é€æ¶ˆæ¯ä¹‹å‰éœ€æŒä¹…åŒ–åˆ°WALä¸­ï¼›</li>\n<li>Messagesï¼ŒæŒä¹…åŒ–Entriesåï¼Œå‘é€ç»™å…¶ä»–èŠ‚ç‚¹çš„æ¶ˆæ¯ï¼›</li>\n<li>Committed Entriesï¼Œå·²æäº¤çš„æ—¥å¿—æ¡ç›®ï¼Œéœ€è¦åº”ç”¨åˆ°å­˜å‚¨çŠ¶æ€æœºä¸­ï¼›</li>\n<li>Snapshotï¼Œå¿«ç…§éœ€ä¿å­˜åˆ°æŒä¹…åŒ–å­˜å‚¨ä¸­ï¼›</li>\n<li>MustSyncï¼ŒHardStateå’ŒEntriesæ˜¯å¦è¦æŒä¹…åŒ–åˆ°WALä¸­ï¼›</li>\n</ul><p><img src=\"https://static001.geekbang.org/resource/image/c0/d6/c0f0b8046a7c8c67c277fed9548251d6.png?wh=1920*786\" alt=\"\"></p><p>äº†è§£å®ŒAPIåï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥ç»§ç»­çœ‹çœ‹ä»£ç å¦‚ä½•ä½¿ç”¨Raftçš„Node APIã€‚</p><p>æ­£å¦‚æˆ‘åœ¨<a href=\"https://time.geekbang.org/column/article/337604\">04</a>ä¸­å’Œä½ ä»‹ç»çš„ï¼Œetcd Raftåº“çš„è®¾è®¡æŠ½è±¡äº†ç½‘ç»œã€Raftæ—¥å¿—å­˜å‚¨ç­‰æ¨¡å—ï¼Œå®ƒæœ¬èº«å¹¶ä¸ä¼šè¿›è¡Œç½‘ç»œã€å­˜å‚¨ç›¸å…³çš„æ“ä½œï¼Œä¸Šå±‚åº”ç”¨éœ€ç»“åˆè‡ªå·±ä¸šåŠ¡åœºæ™¯é€‰æ‹©å†…ç½®çš„æ¨¡å—æˆ–è‡ªå®šä¹‰å®ç°ç½‘ç»œã€å­˜å‚¨ã€æ—¥å¿—ç­‰æ¨¡å—ã€‚</p><p>å› æ­¤æˆ‘ä»¬åœ¨ä½¿ç”¨Raftåº“æ—¶ï¼Œéœ€è¦å…ˆè‡ªå®šä¹‰å¥½ç›¸å…³ç½‘ç»œã€å­˜å‚¨ç­‰æ¨¡å—ï¼Œå†ç»“åˆä¸Šé¢ä»‹ç»çš„Raft Node APIï¼Œå°±å¯ä»¥å®Œæˆä¸€ä¸ªNodeçš„æ ¸å¿ƒæ“ä½œäº†ã€‚å…¶æ•°æ®ç»“æ„å®šä¹‰å¦‚ä¸‹ï¼š</p><pre><code>// A key-value stream backed by raft\ntype raftNode struct {\n   proposeC    &lt;-chan string            // proposed messages (k,v)\n   confChangeC &lt;-chan raftpb.ConfChange // proposed cluster config changes\n   commitC     chan&lt;- *string           // entries committed to log (k,v)\n   errorC      chan&lt;- error             // errors from raft session\n   id          int      // client ID for raft session\n   ......\n   node        raft.Node\n   raftStorage *raft.MemoryStorage\n   wal         *wal.WAL\n   transport *rafthttp.Transport\n}\n</code></pre><p>è¿™ä¸ªæ•°æ®ç»“æ„åå­—å«raftNodeï¼Œå®ƒè¡¨ç¤ºRafté›†ç¾¤ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ã€‚å®ƒæ˜¯ç”±æˆ‘ä»¬ä¸šåŠ¡åº”ç”¨å±‚è®¾è®¡çš„ä¸€ä¸ªç»„åˆç»“æ„ã€‚ä»ç»“æ„ä½“å®šä¹‰ä¸­ä½ å¯ä»¥çœ‹åˆ°å®ƒåŒ…å«äº†Raftæ ¸å¿ƒæ•°æ®ç»“æ„Node(raft.Node)ã€Raftæ—¥å¿—æ¡ç›®å†…å­˜å­˜å‚¨æ¨¡å—(raft.MemoryStorageï¼‰ã€WALæŒä¹…åŒ–æ¨¡å—(wal.WAL)ä»¥åŠç½‘ç»œæ¨¡å—(rafthttp.Transport)ã€‚</p><p>åŒæ—¶ï¼Œå®ƒæä¾›äº†ä¸‰ä¸ªæ ¸å¿ƒçš„ç®¡é“ä¸ä¸šåŠ¡é€»è¾‘æ¨¡å—ã€å­˜å‚¨çŠ¶æ€æœºäº¤äº’ï¼š</p><ul>\n<li>proposeCï¼Œå®ƒç”¨æ¥æ¥æ”¶clientå‘é€çš„å†™è¯·æ±‚ææ¡ˆæ¶ˆæ¯ï¼›</li>\n<li>confChangeCï¼Œå®ƒç”¨æ¥æ¥æ”¶é›†ç¾¤é…ç½®å˜åŒ–æ¶ˆæ¯ï¼›</li>\n<li>commitCï¼Œå®ƒç”¨æ¥è¾“å‡ºRaftå…±è¯†æ¨¡å—å·²æäº¤çš„æ—¥å¿—æ¡ç›®æ¶ˆæ¯ã€‚</li>\n</ul><p>åœ¨metcdé¡¹ç›®ä¸­å› ä¸ºæˆ‘ä»¬æ˜¯ç›´æ¥åŸºäºraftexampleå®šåˆ¶å¼€å‘ï¼Œå› æ­¤æ—¥å¿—æŒä¹…åŒ–å­˜å‚¨ã€ç½‘ç»œéƒ½ä½¿ç”¨çš„æ˜¯etcdè‡ªå¸¦çš„WALå’Œrafthttpæ¨¡å—ã€‚</p><p><a href=\"https://github.com/etcd-io/etcd/blob/v3.4.9/wal/wal.go\">WAL</a>æ¨¡å—ä¸­æä¾›äº†æ ¸å¿ƒçš„ä¿å­˜æœªæŒä¹…åŒ–çš„æ—¥å¿—æ¡ç›®å’Œå¿«ç…§åŠŸèƒ½æ¥å£ï¼Œä½ å¯ä»¥å‚è€ƒ<a href=\"https://time.geekbang.org/column/article/336766\">03</a>èŠ‚å†™è¯·æ±‚ä¸­æˆ‘å’Œä½ ä»‹ç»çš„åŸç†ã€‚</p><p><a href=\"https://github.com/etcd-io/etcd/tree/v3.4.9/etcdserver/api/rafthttp\">rafthttp</a>æ¨¡å—åŸºäºHTTPåè®®æä¾›äº†å„ä¸ªèŠ‚ç‚¹é—´çš„æ¶ˆæ¯å‘é€èƒ½åŠ›ï¼Œmetcdä½¿ç”¨å¦‚ä¸‹ï¼š</p><pre><code>rc.transport = &amp;rafthttp.Transport{\n   Logger:      zap.NewExample(),\n   ID:          types.ID(rc.id),\n   ClusterID:   0x1000,\n   Raft:        rc,\n   ServerStats: stats.NewServerStats(&quot;&quot;, &quot;&quot;),\n   LeaderStats: stats.NewLeaderStats(strconv.Itoa(rc.id)),\n   ErrorC:      make(chan error),\n}\n</code></pre><p>ææ¸…æ¥šRaftæ¨¡å—çš„è¾“å…¥ã€è¾“å‡ºAPIï¼Œè®¾è®¡å¥½raftNodeç»“æ„ï¼Œå¤ç”¨etcdçš„WALã€ç½‘ç»œç­‰æ¨¡å—åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±åªéœ€è¦å®ç°å¦‚ä¸‹ä¸¤ä¸ªå¾ªç¯é€»è¾‘ï¼Œå¤„ç†ä¸šåŠ¡å±‚å‘é€ç»™proposeCå’ŒconfChangeCæ¶ˆæ¯ã€å°†Raftçš„Nodeè¾“å‡ºReadyç»“æ„è¿›è¡Œç›¸å¯¹åº”çš„å¤„ç†å³å¯ã€‚ç²¾ç®€åçš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>func (rc *raftNode) serveChannels() {\n   // send proposals over raft\n   go func() {\n      confChangeCount := uint64(0)\n      for rc.proposeC != nil &amp;&amp; rc.confChangeC != nil {\n         select {\n         case prop, ok := &lt;-rc.proposeC:\n            if !ok {\n               rc.proposeC = nil\n            } else {\n               // blocks until accepted by raft state machine\n               rc.node.Propose(context.TODO(), []byte(prop))\n            }\n\n         case cc, ok := &lt;-rc.confChangeC:\n            if !ok {\n               rc.confChangeC = nil\n            } else {\n               confChangeCount++\n               cc.ID = confChangeCount\n               rc.node.ProposeConfChange(context.TODO(), cc)\n            }\n         }\n      }\n   }()\n\n   // event loop on raft state machine updates\n   for {\n      select {\n      case &lt;-ticker.C:\n         rc.node.Tick()\n\n      // store raft entries to wal, then publish over commit channel\n      case rd := &lt;-rc.node.Ready():\n         rc.wal.Save(rd.HardState, rd.Entries)\n         if !raft.IsEmptySnap(rd.Snapshot) {\n            rc.saveSnap(rd.Snapshot)\n            rc.raftStorage.ApplySnapshot(rd.Snapshot)\n            rc.publishSnapshot(rd.Snapshot)\n         }\n         rc.raftStorage.Append(rd.Entries)\n         rc.transport.Send(rd.Messages)\n         if ok := rc.publishEntries(rc.entriesToApply(rd.CommittedEntries)); !ok {\n            rc.stop()\n            return\n         }\n         rc.maybeTriggerSnapshot()\n         rc.node.Advance()\n      }\n   }\n}\n</code></pre><p>ä»£ç ç®€è¦åˆ†æå¦‚ä¸‹ï¼š</p><ul>\n<li>ä»proposeCä¸­å–å‡ºææ¡ˆæ¶ˆæ¯ï¼Œé€šè¿‡raft.Node.Propose APIæäº¤ææ¡ˆï¼›</li>\n<li>ä»confChangeCå–å‡ºé…ç½®å˜æ›´æ¶ˆæ¯ï¼Œé€šè¿‡raft.Node.ProposeConfChange APIæäº¤é…ç½®å˜åŒ–æ¶ˆæ¯ï¼›</li>\n<li>ä»raft.Nodeä¸­è·å–Raftç®—æ³•çŠ¶æ€æœºè¾“å‡ºåˆ°Readyç»“æ„ä¸­ï¼Œå°†rd.Entrieså’Œrd.HardStateé€šè¿‡WALæ¨¡å—æŒä¹…åŒ–ï¼Œå°†rd.Messagesé€šè¿‡rafthttpæ¨¡å—ï¼Œå‘é€ç»™å…¶ä»–èŠ‚ç‚¹ã€‚å°†rd.CommittedEntriesåº”ç”¨åˆ°ä¸šåŠ¡å­˜å‚¨çŠ¶æ€æœºã€‚</li>\n</ul><p>ä»¥ä¸Šå°±æ˜¯Raftå®ç°çš„æ ¸å¿ƒæµç¨‹ï¼Œæ¥ä¸‹æ¥æˆ‘æ¥å’Œä½ èŠèŠä¸šåŠ¡å­˜å‚¨çŠ¶æ€æœºã€‚</p><h3>æ”¯æŒå¤šå­˜å‚¨å¼•æ“</h3><p>åœ¨æ•´ä½“æ¶æ„è®¾è®¡æ—¶ï¼Œæˆ‘å’Œä½ ä»‹ç»äº†ä¸ºäº†ä½¿metcdé¡¹ç›®èƒ½æ”¯æ’‘å¤šå­˜å‚¨å¼•æ“ï¼Œæˆ‘ä»¬å°†KVStoreè¿›è¡Œäº†æŠ½è±¡åŒ–è®¾è®¡ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦å®ç°å„ä¸ªå­˜å‚¨å¼•æ“ç›¸å¯¹åº”çš„APIå³å¯ã€‚</p><p>è¿™é‡Œæˆ‘ä»¥Putæ¥å£ä¸ºæ¡ˆä¾‹ï¼Œåˆ†åˆ«ç»™ä½ ä»‹ç»ä¸‹å„ä¸ªå­˜å‚¨å¼•æ“çš„å®ç°ã€‚</p><h4>boltdb</h4><p>é¦–å…ˆæ˜¯boltdbå­˜å‚¨å¼•æ“ï¼Œå®ƒçš„å®ç°å¦‚ä¸‹ï¼Œä½ ä¹Ÿå¯ä»¥å»<a href=\"https://time.geekbang.org/column/article/342527\">10</a>é‡Œå›é¡¾ä¸€ä¸‹å®ƒçš„APIå’ŒåŸç†ã€‚</p><pre><code>func (s *boltdbKVStore) Put(key, value string) error {\n   s.mu.Lock()\n   defer s.mu.Unlock()\n   // Start a writable transaction.\n   tx, err := s.db.Begin(true)\n   if err != nil {\n      return err\n   }\n   defer tx.Rollback()\n\n   // Use the transaction...\n   bucket, err := tx.CreateBucketIfNotExists([]byte(&quot;keys&quot;))\n   if err != nil {\n      log.Printf(&quot;failed to put key %s, value %s, err is %v&quot;, key, value, err)\n      return err\n   }\n   err = bucket.Put([]byte(key), []byte(value))\n   if err != nil {\n      log.Printf(&quot;failed to put key %s, value %s, err is %v&quot;, key, value, err)\n      return err\n   }\n\n   // Commit the transaction and check for error.\n   if err := tx.Commit(); err != nil {\n      log.Printf(&quot;failed to commit transaction, key %s, err is %v&quot;, key, err)\n      return err\n   }\n   log.Printf(&quot;backend:%s,put key:%s,value:%s succ&quot;, s.config.backend, key, value)\n   return nil\n</code></pre><h4>leveldb</h4><p>å…¶æ¬¡æ˜¯leveldbï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯<a href=\"https://github.com/syndtr/goleveldb\">goleveldb</a>ï¼Œå®ƒåŸºäºGoogleå¼€æºçš„c++ <a href=\"https://github.com/google/leveldb\">leveldb</a>ç‰ˆæœ¬å®ç°ã€‚å®ƒæä¾›çš„å¸¸ç”¨APIå¦‚ä¸‹æ‰€ç¤ºã€‚</p><ul>\n<li>é€šè¿‡OpenFile APIåˆ›å»ºæˆ–æ‰“å¼€ä¸€ä¸ªleveldbæ•°æ®åº“ã€‚</li>\n</ul><pre><code>db, err := leveldb.OpenFile(&quot;path/to/db&quot;, nil)\n...\ndefer db.Close()\n</code></pre><ul>\n<li>é€šè¿‡DB.Get/Put/Delete APIæ“ä½œæ•°æ®ã€‚</li>\n</ul><pre><code>data, err := db.Get([]byte(&quot;key&quot;), nil)\n...\nerr = db.Put([]byte(&quot;key&quot;), []byte(&quot;value&quot;), nil)\n...\nerr = db.Delete([]byte(&quot;key&quot;), nil)\n...\n</code></pre><p>äº†è§£å…¶æ¥å£åï¼Œé€šè¿‡goleveldbçš„åº“ï¼Œclientè°ƒç”¨å°±éå¸¸ç®€å•äº†ï¼Œä¸‹é¢æ˜¯metcdé¡¹ç›®ä¸­ï¼Œleveldbå­˜å‚¨å¼•æ“Putæ¥å£çš„å®ç°ã€‚</p><pre><code>func (s *leveldbKVStore) Put(key, value string) error {\n   err := s.db.Put([]byte(key), []byte(value), nil)\n   if err != nil {\n      log.Printf(&quot;failed to put key %s, value %s, err is %v&quot;, key, value, err)\n      return err\n   }\n   log.Printf(&quot;backend:%s,put key:%s,value:%s succ&quot;, s.config.backend, key, value)\n   return nil\n}\n</code></pre><h3>è¯»å†™æµç¨‹</h3><p>ä»‹ç»å®Œåœ¨metcdé¡¹ç›®ä¸­å¦‚ä½•ä½¿ç”¨Raftå…±è¯†æ¨¡å—ã€æ”¯æŒå¤šå­˜å‚¨å¼•æ“åï¼Œæˆ‘ä»¬å†ä»æ•´ä½“ä¸Šä»‹ç»ä¸‹åœ¨metcdä¸­å†™å…¥å’Œè¯»å–ä¸€ä¸ªkey-valueçš„æµç¨‹ã€‚</p><h4>å†™æµç¨‹</h4><p>å½“ä½ é€šè¿‡å¦‚ä¸‹curlå‘½ä»¤å‘èµ·ä¸€ä¸ªå†™æ“ä½œæ—¶ï¼Œå†™æµç¨‹å¦‚ä¸‹é¢æ¶æ„å›¾åºå·æ‰€ç¤º:</p><pre><code>curl -L http://127.0.0.1:3379/hello -XPUT -d world\n\n</code></pre><ul>\n<li>clienté€šè¿‡curlå‘é€HTTP PUTè¯·æ±‚åˆ°serverï¼›</li>\n<li>serveræ”¶åˆ°åï¼Œå°†æ¶ˆæ¯å†™å…¥åˆ°KVStoreçš„ProposeCç®¡é“ï¼›</li>\n<li>raftNodeå¾ªç¯é€»è¾‘å°†æ¶ˆæ¯é€šè¿‡Raftæ¨¡å—çš„Proposeæ¥å£æäº¤ï¼›</li>\n<li>Raftæ¨¡å—è¾“å‡ºReadyç»“æ„ï¼Œserverå°†æ—¥å¿—æ¡ç›®æŒä¹…åŒ–åï¼Œå¹¶å‘é€ç»™å…¶ä»–èŠ‚ç‚¹ï¼›</li>\n<li>é›†ç¾¤å¤šæ•°èŠ‚ç‚¹æŒä¹…åŒ–æ­¤æ—¥å¿—æ¡ç›®åï¼Œè¿™ä¸ªæ—¥å¿—æ¡ç›®è¢«æäº¤ç»™å­˜å‚¨çŠ¶æ€æœºKVStoreæ‰§è¡Œï¼›</li>\n<li>KVStoreæ ¹æ®å¯åŠ¨çš„backendå­˜å‚¨å¼•æ“åç§°ï¼Œè°ƒç”¨å¯¹åº”çš„Putæ¥å£å³å¯ã€‚</li>\n</ul><p><img src=\"https://static001.geekbang.org/resource/image/9b/c1/9b84a7e312165de46749e1c4046fc9c1.png?wh=1920*1135\" alt=\"\"></p><h4>è¯»æµç¨‹</h4><p>å½“ä½ é€šè¿‡å¦‚ä¸‹curlå‘½ä»¤å‘èµ·ä¸€ä¸ªè¯»æ“ä½œæ—¶ï¼Œè¯»æµç¨‹å¦‚ä¸‹é¢æ¶æ„å›¾åºå·æ‰€ç¤ºï¼š</p><pre><code>curl -L http://127.0.0.1:3379/hello\nworld\n</code></pre><ul>\n<li>clienté€šè¿‡curlå‘é€HTTP Getè¯·æ±‚åˆ°serverï¼›</li>\n<li>serveræ”¶åˆ°åï¼Œæ ¹æ®KVStoreçš„å­˜å‚¨å¼•æ“ï¼Œä»åç«¯æŸ¥è¯¢å‡ºå¯¹åº”çš„key-valueæ•°æ®ã€‚</li>\n</ul><p><img src=\"https://static001.geekbang.org/resource/image/17/b2/1746fbd9e9435d8607e44bea2d2c39b2.png?wh=1920*1187\" alt=\"\"></p><h2>å°ç»“</h2><p>æœ€åï¼Œæˆ‘æ¥æ€»ç»“ä¸‹æˆ‘ä»¬ä»Šå¤©çš„å†…å®¹ã€‚æˆ‘è¿™èŠ‚è¯¾åˆ†åˆ«ä»æ•´ä½“æ¶æ„è®¾è®¡å’Œå®ç°åˆ†æï¼Œç»™ä½ ä»‹ç»äº†å¦‚ä½•åŸºäºRaftä»0åˆ°1æ„å»ºä¸€ä¸ªæ”¯æŒå¤šå­˜å‚¨å¼•æ“çš„åˆ†å¸ƒå¼key-valueæ•°æ®åº“ã€‚</p><p>åœ¨æ•´ä½“æ¶æ„è®¾è®¡ä¸Šï¼Œæˆ‘ç»™ä½ ä»‹ç»äº†APIè®¾è®¡æ ¸å¿ƒå› ç´ ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯æ€§èƒ½ã€æ˜“ç”¨æ€§ã€å¼€å‘æ•ˆç‡ã€å®‰å…¨æ€§ã€å¹‚ç­‰æ€§ã€‚å…¶æ¬¡æˆ‘å’Œä½ ä»‹ç»äº†å¤åˆ¶çŠ¶æ€æœºçš„åŸç†ï¼Œå®ƒç”±å…±è¯†æ¨¡å—ã€æ—¥å¿—æ¨¡å—ã€å­˜å‚¨çŠ¶æ€æœºæ¨¡å—ç»„æˆã€‚æœ€åæˆ‘å’Œä½ æ·±å…¥åˆ†æäº†å¤šå­˜å‚¨å¼•æ“è®¾è®¡ï¼Œé‡ç‚¹ä»‹ç»äº†leveldbåŸç†ï¼Œå®ƒå°†éšæœºå†™è½¬æ¢ä¸ºé¡ºåºå†™æ—¥å¿—å’Œå†…å­˜ï¼Œé€šè¿‡ä¸€ç³»åˆ—åˆ†å±‚ã€åˆ›æ–°çš„è®¾è®¡å®ç°äº†ä¼˜å¼‚çš„å†™æ€§èƒ½ï¼Œé€‚åˆè¯»å°‘å†™å¤šã€‚</p><p>åœ¨å®ç°åˆ†æä¸Šï¼Œæˆ‘å’Œä½ é‡ç‚¹ä»‹ç»äº†Raftç®—æ³•åº“çš„æ ¸å¿ƒå¯¹è±¡Node APIã€‚å¯¹äºä¸€ä¸ªåº“è€Œè¨€ï¼Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨çš„æ˜¯å…¶è¾“å…¥ã€è¾“å‡ºæ¥å£ï¼Œä¸šåŠ¡é€»è¾‘å±‚å¯é€šè¿‡Proposeæ¥å£æäº¤ææ¡ˆï¼Œé€šè¿‡Readyç»“æ„è·å–Raftç®—æ³•çŠ¶æ€æœºçš„è¾“å‡ºå†…å®¹ã€‚å…¶æ¬¡æˆ‘å’Œä½ ä»‹ç»äº†Raftç®—æ³•åº“å¦‚ä½•ä¸WALæ¨¡å—ã€Raftæ—¥å¿—å­˜å‚¨æ¨¡å—ã€ç½‘ç»œæ¨¡å—åä½œå®Œæˆä¸€ä¸ªå†™è¯·æ±‚ã€‚</p><p>æœ€åä¸ºäº†æ”¯æŒå¤šå­˜å‚¨å¼•æ“ï¼Œæˆ‘ä»¬åˆ†åˆ«åŸºäºboltdbã€leveldbå®ç°äº†KVStoreç›¸å…³æ¥å£æ“ä½œï¼Œå¹¶é€šè¿‡è¯»å†™æµç¨‹å›¾ï¼Œä»æ•´ä½“ä¸Šä¸ºä½ ä»‹ç»äº†ä¸€ä¸ªè¯»å†™è¯·æ±‚åœ¨metcdä¸­æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚</p><p>éº»é›€è™½å°ï¼Œäº”è„ä¿±å…¨ã€‚å¸Œæœ›èƒ½é€šè¿‡è¿™ä¸ªè¿·ä½ é¡¹ç›®è§£ç­”ä½ å¯¹å¦‚ä½•æ„å»ºä¸€ä¸ªç®€æ˜“åˆ†å¸ƒå¼KVæœåŠ¡çš„ç–‘é—®ï¼Œä»¥åŠè®©ä½ å¯¹etcdçš„å·¥ä½œåŸç†æœ‰æ›´æ·±çš„ç†è§£ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>ä½ çŸ¥é“<a href=\"https://github.com/etcd-io/etcd/tree/v3.4.9/contrib/raftexample\">raftexample</a>å¯åŠ¨çš„æ—¶å€™æ˜¯å¦‚ä½•å·¥ä½œçš„å—ï¼Ÿå®ƒçš„å­˜å‚¨å¼•æ“å†…å­˜mapæ˜¯å¦‚ä½•ä¿è¯æ•°æ®ä¸ä¸¢å¤±çš„å‘¢ï¼Ÿ</p><p>æ„Ÿè°¢ä½ çš„é˜…è¯»ï¼Œå¦‚æœä½ è®¤ä¸ºè¿™èŠ‚è¯¾çš„å†…å®¹æœ‰æ”¶è·ï¼Œä¹Ÿæ¬¢è¿æŠŠå®ƒåˆ†äº«ç»™ä½ çš„æœ‹å‹ï¼Œæˆ‘ä»¬ä¸‹ä¸€è®²è§ã€‚</p>","neighbors":{"left":{"article_title":"17 | æ€§èƒ½åŠç¨³å®šæ€§ï¼ˆä¸‹ï¼‰ï¼šå¦‚ä½•ä¼˜åŒ–åŠæ‰©å±•etcdæ€§èƒ½?","id":346471},"right":{"article_title":"19 | KubernetesåŸºç¡€åº”ç”¨ï¼šåˆ›å»ºä¸€ä¸ªPodèƒŒåetcdå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ","id":347992}},"comments":[{"had_liked":false,"id":281206,"user_name":"äº‘åŸç”Ÿå·¥ç¨‹å¸ˆ","can_delete":false,"product_type":"c1","uid":2243294,"ip_address":"","ucode":"40CB692F21D3BC","user_header":"https://static001.geekbang.org/account/avatar/00/22/3a/de/e5c30589.jpg","comment_is_top":false,"comment_ctime":1614645769,"is_pvip":false,"replies":[{"id":"102124","content":"å—¯ï¼Œè‡ªå·±åŠ¨æ‰‹ä¼šæœ‰æ›´æ·±çš„ç†è§£ï¼Œä¹¦ç±æ¨èã€ŠDesigning Data-Intensive Applicationsã€‹ï¼Œä¸­æ–‡åã€Šè®¾è®¡æ•°æ®å¯†é›†å‹åº”ç”¨ã€‹ï¼Œè±†ç“£è¯„åˆ†é«˜è¾¾9.7ï¼Œhttps:&#47;&#47;book.douban.com&#47;subject&#47;30329536&#47;ï¼Œéå¸¸ä¸é”™çš„åˆ†å¸ƒå¼å…¥é—¨ä¹¦ç±ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å”èª","uid":"1009582","ctime":1614652261,"ip_address":"","comment_id":281206,"utype":1}],"discussion_count":2,"race_medal":0,"score":"48859286025","product_id":100069901,"comment_content":"è®¾è®¡ä¸Šå­˜å‚¨å¼•æ“çš„ä»‹ç»ï¼Œè·ç›ŠåŒªæµ…ï¼Œå…·ä½“å®ç°ä¸Šçš„è§£è¯»ï¼Œä¹Ÿææ¸…äº†ä¹‹å‰å‡ ä¸ªç–‘é—®ï¼Œetcdè¶³å¤Ÿè½»é‡çº§ï¼Œç®€ç›´å°±æ˜¯å­¦ä¹ åˆ†å¸ƒå¼ç³»ç»Ÿçš„æœ€ä½³æ¡ˆä¾‹ï¼Œåé¢æŠ½ç©ºè‡ªå·±åŸºäºraftæä¸ªå°å°é¡¹ç›®ï¼Œè¿›ä¸€æ­¥åŠ æ·±ä¸‹ï¼Œè€å¸ˆåœ¨è¿™å—æœ‰ä»€ä¹ˆåˆ†å¸ƒå¼ä¹¦ç±æ¨èæ²¡","like_count":11,"discussions":[{"author":{"id":1009582,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/67/ae/37b492db.jpg","nickname":"å”èª","note":"","ucode":"99CB061EDF35EA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":516323,"discussion_content":"å—¯ï¼Œè‡ªå·±åŠ¨æ‰‹ä¼šæœ‰æ›´æ·±çš„ç†è§£ï¼Œä¹¦ç±æ¨èã€ŠDesigning Data-Intensive Applicationsã€‹ï¼Œä¸­æ–‡åã€Šè®¾è®¡æ•°æ®å¯†é›†å‹åº”ç”¨ã€‹ï¼Œè±†ç“£è¯„åˆ†é«˜è¾¾9.7ï¼Œhttps://book.douban.com/subject/30329536/ï¼Œéå¸¸ä¸é”™çš„åˆ†å¸ƒå¼å…¥é—¨ä¹¦ç±ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1614652261,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2243294,"avatar":"https://static001.geekbang.org/account/avatar/00/22/3a/de/e5c30589.jpg","nickname":"äº‘åŸç”Ÿå·¥ç¨‹å¸ˆ","note":"","ucode":"40CB692F21D3BC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":352395,"discussion_content":"å¥½çš„ï¼Œè°¢è°¢è€å¸ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1614716906,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":333336,"user_name":"æ— åæ°","can_delete":false,"product_type":"c1","uid":1256121,"ip_address":"","ucode":"584E697AE276AB","user_header":"https://static001.geekbang.org/account/avatar/00/13/2a/b9/2bf8cc89.jpg","comment_is_top":false,"comment_ctime":1644296486,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"27414100262","product_id":100069901,"comment_content":"å¤§ä½¬ æœ‰å®Œæ•´demoå¯ä»¥åˆ†äº«å—ğŸ˜€","like_count":6},{"had_liked":false,"id":353161,"user_name":"ä¸¹å°¼å°”-é›ªç¢§","can_delete":false,"product_type":"c1","uid":2700925,"ip_address":"å¹¿ä¸œ","ucode":"F098396F4B7500","user_header":"https://static001.geekbang.org/account/avatar/00/29/36/7d/eab0d26a.jpg","comment_is_top":false,"comment_ctime":1659199497,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1659199497","product_id":100069901,"comment_content":"è¯·é—®å¤§ä½¬ï¼Œraftæ¨¡å—è¿”å›çš„å¿«ç…§ä¿¡æ¯ï¼Œå¿«ç…§æ˜¯ä»å“ªé‡Œæ¥çš„ï¼Ÿæˆ‘ç†è§£å¿«ç…§å°±æ˜¯ä»kvStorageæ¥çš„ï¼Ÿæ‰€ä»¥æ˜¯å½“éœ€è¦ç”Ÿæˆå¿«ç…§çš„æ—¶å€™ï¼Œraftæ¨¡å—è°ƒç”¨kvStorageçš„æ¥å£ç”Ÿæˆå¿«ç…§ï¼Ÿ","like_count":0},{"had_liked":false,"id":347146,"user_name":"å°ä½•","can_delete":false,"product_type":"c1","uid":1067516,"ip_address":"","ucode":"EFD72AB3CA2AF7","user_header":"https://static001.geekbang.org/account/avatar/00/10/49/fc/5627215c.jpg","comment_is_top":false,"comment_ctime":1653744149,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1653744149","product_id":100069901,"comment_content":"è¿™ä¸ªå®ç°çš„ä»£ç åœ¨å“ªé‡Œå¯ä»¥ä¸‹è½½ï¼Ÿ","like_count":0},{"had_liked":false,"id":338068,"user_name":"lixg","can_delete":false,"product_type":"c1","uid":1228028,"ip_address":"","ucode":"6E821145950FBB","user_header":"https://static001.geekbang.org/account/avatar/00/12/bc/fc/cf98963a.jpg","comment_is_top":false,"comment_ctime":1647265880,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1647265880","product_id":100069901,"comment_content":"æ–‡ä¸­æåˆ°â€œMessagesï¼ŒæŒä¹…åŒ– Entries åï¼Œå‘é€ç»™å…¶ä»–èŠ‚ç‚¹çš„æ¶ˆæ¯â€<br><br>è¿™é‡Œçš„æ¶ˆæ¯æ˜¯æŒ‡ä»€ä¹ˆæ¶ˆæ¯ï¼ŒåŒ…å«ä»€ä¹ˆå†…å®¹ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":2058258,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/68/12/031a05c3.jpg","nickname":"Aå…å¸…å«å“¥","note":"","ucode":"76D2522E602AEF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":579302,"discussion_content":"å°±æ˜¯ææ¡ˆçš„å†…å®¹ï¼Œleaderè‡ªå·±æŒä¹…åŒ–åˆ°walä¸­ï¼Œä¹Ÿè¦å°†æ¶ˆæ¯å‘ç»™å…¶ä»–èŠ‚ç‚¹ï¼ŒåšåŒæ ·çš„äº‹æƒ…ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1657331508,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}