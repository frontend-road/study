{"id":154689,"title":"20 | 源码解析：Netty对堆外内存和内存池的支持","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/geek_netty\">https://gitee.com/geektime-geekbang/geek_netty</a></p>","comments":[{"had_liked":false,"id":156723,"user_name":"冬渐暖","can_delete":false,"product_type":"c3","uid":1586800,"ip_address":"","ucode":"907E41AAE9A36C","user_header":"https://static001.geekbang.org/account/avatar/00/18/36/70/00122b24.jpg","comment_is_top":false,"comment_ctime":1574942385,"is_pvip":false,"replies":[{"id":60558,"content":"那肯定的，不然他就不是java了啊，哈，所以我每次看代码都使劲找它最后调用的地方，找到了，以后它的代码看不懂也关系不大，因为自己也能搞出来了。","user_name":"作者回复","user_name_real":"傅健","uid":1638649,"ctime":1575325331,"ip_address":"","comment_id":156723,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"切换是否使用内存池的方法:还是和之前创建keepAlive一样，通过那个额外参数childOption来设置，\nserverBootstrap.group.childOption(ChannelOption.ALLOCATOR,PooledByteBufAllocator.DEFAULT)\n还有一种是\nserverBootstrap.group(workerGroup).childOption(ChannelOption.ALLOCATOR,new UnpooledByteBufAllocator(false))\n用的话还是直接用这个default好，\n两者除了后者需要实例化外 就类似于System.gc()和Runtime.getRuntime().gc();\n也是和切换io类型一样，把PooledByteBufAllocator这个改成UnpooledByteBufAllocator（官方注释为that does not pool anything）。\n\n关于设置默认内存池的时候，撇开不规范的魔法值命名外。。。。个人认为写的是真的叼啊，用了jdk自带的System.getProperty(key)。还对结果进行转小写去空格。考虑周到啊\n\n从内存池里拿: 先获取ThreadLocal 的stack，然后再 pop()---&gt;获取并删除最后一个元素。没有就新创建一个\n还给内存池:拿用的是pop(),还的话就用push推进去。\n\nThreadLocal 就是线程的一个副本，实现了和其它线程隔离,比如上学时候黑板上的布置的作业，这个作业就是ThreadLocal 。 \n\n\n使用堆外内存的方法：上面说的第二种设置内存池的方法，里面的布尔类型就是判断是否使用堆外内存。\n经过一系列判断来调用jdk自带的使用堆外内存方法。饶了这么久还是用了jdk的。尴尬\n\n","like_count":3,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":476212,"discussion_content":"那肯定的，不然他就不是java了啊，哈，所以我每次看代码都使劲找它最后调用的地方，找到了，以后它的代码看不懂也关系不大，因为自己也能搞出来了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1575325331,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":151144,"user_name":"夏目","can_delete":false,"product_type":"c3","uid":1212750,"ip_address":"","ucode":"67C075A01CF4D2","user_header":"https://static001.geekbang.org/account/avatar/00/12/81/4e/d71092f4.jpg","comment_is_top":false,"comment_ctime":1573657879,"is_pvip":false,"replies":[{"id":61394,"content":"不好意思，回复的有点晚，是的，因为堆外还是堆内相当于图书馆本身从哪进书，池化和非池化相当于书的使用模式，一个是借还模式，一个是买卖模式，池化的也只能是引用，引用指向堆外内存。","user_name":"作者回复","user_name_real":"stroller","uid":1638649,"ctime":1576110503,"ip_address":"","comment_id":151144,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"老师，请问使用堆外内存时也可以使用内存池吗？如果可以那是不是对堆内的引用做的池化？","like_count":2,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":474379,"discussion_content":"不好意思，回复的有点晚，是的，因为堆外还是堆内相当于图书馆本身从哪进书，池化和非池化相当于书的使用模式，一个是借还模式，一个是买卖模式，池化的也只能是引用，引用指向堆外内存。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576110503,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":154734,"user_name":"td901105","can_delete":false,"product_type":"c3","uid":1348830,"ip_address":"","ucode":"32D42A4F36FA02","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/SM4fwn9uFicXU8cQ1rNF2LQdKNbZI1FX1jmdwaE2MTrBawbugj4TQKjMKWG0sGbmqQickyARXZFS8NZtobvoWTHA/132","comment_is_top":false,"comment_ctime":1574525262,"is_pvip":false,"replies":[{"id":59444,"content":"每节内容的视频下面都有一个github的连接，那个里面有，我标记了，最近上传过了。\n\n ","user_name":"作者回复","user_name_real":"Geek_9bc307","uid":1638649,"ctime":1574577275,"ip_address":"","comment_id":154734,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"老师您好，我想问一下您的带注释的源码在哪里可以下载，谢谢！","like_count":0,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":475566,"discussion_content":"每节内容的视频下面都有一个github的连接，那个里面有，我标记了，最近上传过了。\n\n ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574577275,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":144900,"user_name":"tony","can_delete":false,"product_type":"c3","uid":1597095,"ip_address":"","ucode":"93ADE0CA21D271","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLLFZlMALuORBsngE7Ujbm8E6R7sX6PlhuuJ9ibDjWhEeRKL1pE2FQUibia4o0xNYowJ0N6WQIylHVMA/132","comment_is_top":false,"comment_ctime":1572084640,"is_pvip":false,"replies":[{"id":57250,"content":"好像每周三更新五节","user_name":"作者回复","user_name_real":"Geek_9bc307","uid":1638649,"ctime":1573048262,"ip_address":"","comment_id":144900,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"下次更新是什么时候，现在才到21讲，迫切想看下应用了\n","like_count":0,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":472161,"discussion_content":"好像每周三更新五节","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573048262,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":144831,"user_name":"李博","can_delete":false,"product_type":"c3","uid":1119919,"ip_address":"","ucode":"04C2DE916B84AB","user_header":"https://static001.geekbang.org/account/avatar/00/11/16/af/bada0f59.jpg","comment_is_top":false,"comment_ctime":1572067168,"is_pvip":false,"replies":[{"id":62390,"content":"不好意思，回复的有点晚！\n不够准确，比如安卓平台就默认不使用堆外和池化等高级特性；\n可能我要说句废话：“除了使用堆外都是使用堆内”，\n堆外的比如接受请求的数据存储。","user_name":"作者回复","user_name_real":"stroller","uid":1638649,"ctime":1576898560,"ip_address":"","comment_id":144831,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"在netty框架中，是不是网络请求都是用的是对外内存，netty什么时候堆外内存什么时候使用堆内存，能解释一下么？","like_count":0,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":472127,"discussion_content":"不好意思，回复的有点晚！\n不够准确，比如安卓平台就默认不使用堆外和池化等高级特性；\n可能我要说句废话：“除了使用堆外都是使用堆内”，\n堆外的比如接受请求的数据存储。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576898560,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":144462,"user_name":"灿烂明天","can_delete":false,"product_type":"c3","uid":1322455,"ip_address":"","ucode":"07DA56B0680D0C","user_header":"https://static001.geekbang.org/account/avatar/00/14/2d/d7/74fc8f38.jpg","comment_is_top":false,"comment_ctime":1571928387,"is_pvip":false,"replies":[{"id":61731,"content":"堆外内存，主要是想存更多的对象，同时也减少对象都放堆里带来的GC压力，内存池主要是为了复用对象，直接减少对象产生；\n两个是不同：有时候能用堆外内存，但是不见得能用对象&#47;内存池（假设对象不能复用）；\n相同点在于都可以减少GC压力，减少STW时间，间接带来处理的平滑度。","user_name":"作者回复","user_name_real":"stroller","uid":1638649,"ctime":1576481510,"ip_address":"","comment_id":144462,"utype":1}],"discussion_count":4,"race_medal":2,"score":2,"product_id":100036701,"comment_content":"请问下老师，这个堆外内存和内存池，分别什么场景下使用的？还有这些优化是会提升哪方面的效率的吗？解答下疑惑吧，谢谢","like_count":0,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":471953,"discussion_content":"堆外内存，主要是想存更多的对象，同时也减少对象都放堆里带来的GC压力，内存池主要是为了复用对象，直接减少对象产生；\n两个是不同：有时候能用堆外内存，但是不见得能用对象/内存池（假设对象不能复用）；\n相同点在于都可以减少GC压力，减少STW时间，间接带来处理的平滑度。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576481510,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1184514,"avatar":"https://static001.geekbang.org/account/avatar/00/12/13/02/37aa3882.jpg","nickname":"R曾","note":"","ucode":"8AED49A52AFF12","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":40860,"discussion_content":"堆外使用要求高，堆内回收容易。但堆外减少gc，这还是得要看实际场景","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572277852,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1322455,"avatar":"https://static001.geekbang.org/account/avatar/00/14/2d/d7/74fc8f38.jpg","nickname":"灿烂明天","note":"","ucode":"07DA56B0680D0C","race_medal":2,"user_type":1,"is_pvip":false},"reply_author":{"id":1184514,"avatar":"https://static001.geekbang.org/account/avatar/00/12/13/02/37aa3882.jpg","nickname":"R曾","note":"","ucode":"8AED49A52AFF12","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":41091,"discussion_content":"那堆外是不是理解对内存管理是不可控的？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572349576,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":40860,"ip_address":"","group_id":0},"score":41091,"extra":""},{"author":{"id":1195258,"avatar":"https://static001.geekbang.org/account/avatar/00/12/3c/fa/e2990931.jpg","nickname":"文敦复","note":"","ucode":"B8F4A6BD5D7805","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1322455,"avatar":"https://static001.geekbang.org/account/avatar/00/14/2d/d7/74fc8f38.jpg","nickname":"灿烂明天","note":"","ucode":"07DA56B0680D0C","race_medal":2,"user_type":1,"is_pvip":false},"discussion":{"id":293331,"discussion_content":"并不是啊，正确使用ByteBuf的情况下，即使是堆外内存，也是可控的。你可以看看：io.netty.channel.SimpleChannelInboundHandler#channelRead的finaly中的ReferenceCountUtil.release(msg) 就是为了回收内存！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595504936,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":41091,"ip_address":"","group_id":0},"score":293331,"extra":""}]}]},{"had_liked":false,"id":144457,"user_name":"鱼向北游","can_delete":false,"product_type":"c3","uid":1439908,"ip_address":"","ucode":"580EC7DCE57E9A","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/IPdZZXuHVMibwfZWmm7NiawzeEFGsaRoWjhuN99iaoj5amcRkiaOePo6rH1KJ3jictmNlic4OibkF4I20vOGfwDqcBxfA/132","comment_is_top":false,"comment_ctime":1571927586,"is_pvip":false,"replies":[{"id":57872,"content":"这个问题很好，可以参考这个文章里面的图有个比较，可以直观感受下：\nhttps:&#47;&#47;blog.twitter.com&#47;engineering&#47;en_us&#47;a&#47;2013&#47;netty-4-at-twitter-reduced-gc-overhead.html","user_name":"作者回复","user_name_real":"Geek_9bc307","uid":1638649,"ctime":1573549713,"ip_address":"","comment_id":144457,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"问下老师 netty的内存参数设置为堆内存还是直接内存，池化还是非池化 性能大概差多少呀 有大概的性能数据么","like_count":0,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":471949,"discussion_content":"这个问题很好，可以参考这个文章里面的图有个比较，可以直观感受下：\nhttps://blog.twitter.com/engineering/en_us/a/2013/netty-4-at-twitter-reduced-gc-overhead.html","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573549713,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":332938,"user_name":"geekcat","can_delete":false,"product_type":"c3","uid":1030639,"ip_address":"","ucode":"8CC3800E76176B","user_header":"https://wx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqWKj6kxC4ib8ia9tTz0CKvQYcjK6Maf5s1TVpMwtLs7ELkM3spzkbsnaMhoLqO1zkZqiaHFCX5ibibSYQ/132","comment_is_top":false,"comment_ctime":1643857025,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"老师讲的确实好，功力深厚，能把技术栈串起来点到，让人多一个层次理解。","like_count":0},{"had_liked":false,"id":224445,"user_name":"suke","can_delete":false,"product_type":"c3","uid":1007753,"ip_address":"","ucode":"C0287C31A4F45B","user_header":"","comment_is_top":false,"comment_ctime":1591403098,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"老师申请的对外内存，如果引用是在堆内。那么jvm是不是可以通过这个引用把对应的内存回收呢？","like_count":0,"discussions":[{"author":{"id":1195258,"avatar":"https://static001.geekbang.org/account/avatar/00/12/3c/fa/e2990931.jpg","nickname":"文敦复","note":"","ucode":"B8F4A6BD5D7805","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":293327,"discussion_content":"插眼，同问这个问题！堆内的内存应该也是有池化和非池化2种情况吧，那么着2种情况下，ByteBuf的释放是如何操作的了？！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595504646,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":208160,"user_name":"likun","can_delete":false,"product_type":"c3","uid":1030816,"ip_address":"","ucode":"9145ED059CCC6D","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ba/a0/f03d20cd.jpg","comment_is_top":false,"comment_ctime":1587286461,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"老师 你好 想问下 jvm的堆外内存还是分配在jvm进程虚拟地址空间的用户态的吧？这样数据真正写入的是堆外内存对应的物理内存，而由于os内核的机制，此时发送数据到网卡的数据访问时内核通过内核的虚拟地址去访问，只不多内核的虚拟地址也是指向用户态虚拟内存指向的物理内存的，所以实现了零拷贝，不知道这样理解对不对，特别希望得到老师的街道，这块非常疑惑。","like_count":0},{"had_liked":false,"id":202038,"user_name":"Shawn.C","can_delete":false,"product_type":"c3","uid":1046295,"ip_address":"","ucode":"9CE004D0325320","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f7/17/f94e987f.jpg","comment_is_top":false,"comment_ctime":1585891816,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100036701,"comment_content":"老师你好，grpc在进行请求处理的时候会通过netty使用堆外内存，那这个内存的释放什么时候进行，如果不指定full gc，是不是就不会被回收了。","like_count":0}]}