{"id":105980,"title":"44 | Socketå†…æ ¸æ•°æ®ç»“æ„ï¼šå¦‚ä½•æˆç«‹ç‰¹å¤§é¡¹ç›®åˆä½œéƒ¨ï¼Ÿ","content":"<p>ä¸Šä¸€èŠ‚æˆ‘ä»¬è®²äº†Socketåœ¨TCPå’ŒUDPåœºæ™¯ä¸‹çš„è°ƒç”¨æµç¨‹ã€‚è¿™ä¸€èŠ‚ï¼Œæˆ‘ä»¬å°±æ²¿ç€è¿™ä¸ªæµç¨‹åˆ°å†…æ ¸é‡Œé¢ä¸€æ¢ç©¶ç«Ÿï¼Œçœ‹çœ‹åœ¨å†…æ ¸é‡Œé¢ï¼Œéƒ½åˆ›å»ºäº†å“ªäº›æ•°æ®ç»“æ„ï¼Œåšäº†å“ªäº›äº‹æƒ…ã€‚</p><h2>è§£æsocketå‡½æ•°</h2><p>æˆ‘ä»¬ä»Socketç³»ç»Ÿè°ƒç”¨å¼€å§‹ã€‚</p><pre><code>SYSCALL_DEFINE3(socket, int, family, int, type, int, protocol)\n{\n\tint retval;\n\tstruct socket *sock;\n\tint flags;\n......\n\tif (SOCK_NONBLOCK != O_NONBLOCK &amp;&amp; (flags &amp; SOCK_NONBLOCK))\n\t\tflags = (flags &amp; ~SOCK_NONBLOCK) | O_NONBLOCK;\n\n\tretval = sock_create(family, type, protocol, &amp;sock);\n......\n\tretval = sock_map_fd(sock, flags &amp; (O_CLOEXEC | O_NONBLOCK));\n......\n\treturn retval;\n}\n</code></pre><p>è¿™é‡Œé¢çš„ä»£ç æ¯”è¾ƒå®¹æ˜“çœ‹æ‡‚ï¼ŒSocketç³»ç»Ÿè°ƒç”¨ä¼šè°ƒç”¨sock_createåˆ›å»ºä¸€ä¸ªstruct socketç»“æ„ï¼Œç„¶åé€šè¿‡sock_map_fdå’Œæ–‡ä»¶æè¿°ç¬¦å¯¹åº”èµ·æ¥ã€‚</p><p>åœ¨åˆ›å»ºSocketçš„æ—¶å€™ï¼Œæœ‰ä¸‰ä¸ªå‚æ•°ã€‚</p><p>ä¸€ä¸ªæ˜¯<strong>family</strong>ï¼Œè¡¨ç¤ºåœ°å€æ—ã€‚ä¸æ˜¯æ‰€æœ‰çš„Socketéƒ½è¦é€šè¿‡IPè¿›è¡Œé€šä¿¡ï¼Œè¿˜æœ‰å…¶ä»–çš„é€šä¿¡æ–¹å¼ã€‚ä¾‹å¦‚ï¼Œä¸‹é¢çš„å®šä¹‰ä¸­ï¼Œdomain socketså°±æ˜¯é€šè¿‡æœ¬åœ°æ–‡ä»¶è¿›è¡Œé€šä¿¡çš„ï¼Œä¸éœ€è¦IPåœ°å€ã€‚åªä¸è¿‡ï¼Œé€šè¿‡IPåœ°å€åªæ˜¯æœ€å¸¸ç”¨çš„æ¨¡å¼ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œç€é‡åˆ†æè¿™ç§æ¨¡å¼ã€‚</p><pre><code>#define AF_UNIX 1/* Unix domain sockets */\n#define AF_INET 2/* Internet IP Protocol */\n</code></pre><p>ç¬¬äºŒä¸ªå‚æ•°æ˜¯<strong>type</strong>ï¼Œä¹Ÿå³Socketçš„ç±»å‹ã€‚ç±»å‹æ˜¯æ¯”è¾ƒå°‘çš„ã€‚</p><p>ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯<strong>protocol</strong>ï¼Œæ˜¯åè®®ã€‚åè®®æ•°ç›®æ˜¯æ¯”è¾ƒå¤šçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¤šä¸ªåè®®ä¼šå±äºåŒä¸€ç§ç±»å‹ã€‚</p><p>å¸¸ç”¨çš„Socketç±»å‹æœ‰ä¸‰ç§ï¼Œåˆ†åˆ«æ˜¯SOCK_STREAMã€SOCK_DGRAMå’ŒSOCK_RAWã€‚</p><pre><code>enum sock_type {\nSOCK_STREAM = 1,\nSOCK_DGRAM = 2,\nSOCK_RAW = 3,\n......\n}\n</code></pre><p>SOCK_STREAMæ˜¯é¢å‘æ•°æ®æµçš„ï¼Œåè®®IPPROTO_TCPå±äºè¿™ç§ç±»å‹ã€‚SOCK_DGRAMæ˜¯é¢å‘æ•°æ®æŠ¥çš„ï¼Œåè®®IPPROTO_UDPå±äºè¿™ç§ç±»å‹ã€‚å¦‚æœåœ¨å†…æ ¸é‡Œé¢çœ‹çš„è¯ï¼ŒIPPROTO_ICMPä¹Ÿå±äºè¿™ç§ç±»å‹ã€‚SOCK_RAWæ˜¯åŸå§‹çš„IPåŒ…ï¼ŒIPPROTO_IPå±äºè¿™ç§ç±»å‹ã€‚</p><!-- [[[read_end]]] --><p><strong>è¿™ä¸€èŠ‚ï¼Œæˆ‘ä»¬é‡ç‚¹çœ‹SOCK_STREAMç±»å‹å’ŒIPPROTO_TCPåè®®ã€‚</strong></p><p>ä¸ºäº†ç®¡ç†familyã€typeã€protocolè¿™ä¸‰ä¸ªåˆ†ç±»å±‚æ¬¡ï¼Œå†…æ ¸ä¼šåˆ›å»ºå¯¹åº”çš„æ•°æ®ç»“æ„ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ‰“å¼€sock_createå‡½æ•°çœ‹ä¸€ä¸‹ã€‚å®ƒä¼šè°ƒç”¨__sock_createã€‚</p><pre><code>int __sock_create(struct net *net, int family, int type, int protocol,\n\t\t\t struct socket **res, int kern)\n{\n\tint err;\n\tstruct socket *sock;\n\tconst struct net_proto_family *pf;\n......\n\tsock = sock_alloc();\n......\n\tsock-&gt;type = type;\n......\n\tpf = rcu_dereference(net_families[family]);\n......\n\terr = pf-&gt;create(net, sock, protocol, kern);\n......\n\t*res = sock;\n\n\treturn 0;\n}\n</code></pre><p>è¿™é‡Œå…ˆæ˜¯åˆ†é…äº†ä¸€ä¸ªstruct socketç»“æ„ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬è¦ç”¨åˆ°familyå‚æ•°ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªnet_familiesæ•°ç»„ï¼Œæˆ‘ä»¬å¯ä»¥ä»¥familyå‚æ•°ä¸ºä¸‹æ ‡ï¼Œæ‰¾åˆ°å¯¹åº”çš„struct net_proto_familyã€‚</p><pre><code>/* Supported address families. */\n#define AF_UNSPEC\t0\n#define AF_UNIX\t\t1\t/* Unix domain sockets \t\t*/\n#define AF_LOCAL\t1\t/* POSIX name for AF_UNIX\t*/\n#define AF_INET\t\t2\t/* Internet IP Protocol \t*/\n......\n#define AF_INET6\t10\t/* IP version 6\t\t\t*/\n......\n#define AF_MPLS\t\t28\t/* MPLS */\n......\n#define AF_MAX\t\t44\t/* For now.. */\n#define NPROTO\t\tAF_MAX\n\nstruct net_proto_family __rcu *net_families[NPROTO] __read_mostly;\n</code></pre><p>æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°net_familiesçš„å®šä¹‰ã€‚æ¯ä¸€ä¸ªåœ°å€æ—åœ¨è¿™ä¸ªæ•°ç»„é‡Œé¢éƒ½æœ‰ä¸€é¡¹ï¼Œé‡Œé¢çš„å†…å®¹æ˜¯net_proto_familyã€‚æ¯ä¸€ç§åœ°å€æ—éƒ½æœ‰è‡ªå·±çš„net_proto_familyï¼ŒIPåœ°å€æ—çš„net_proto_familyå®šä¹‰å¦‚ä¸‹ï¼Œé‡Œé¢æœ€é‡è¦çš„å°±æ˜¯ï¼Œcreateå‡½æ•°æŒ‡å‘inet_createã€‚</p><pre><code>//net/ipv4/af_inet.c\nstatic const struct net_proto_family inet_family_ops = {\n\t.family = PF_INET,\n\t.create = inet_create,//è¿™ä¸ªç”¨äºsocketç³»ç»Ÿè°ƒç”¨åˆ›å»º\n......\n}\n</code></pre><p>æˆ‘ä»¬å›åˆ°å‡½æ•°__sock_createã€‚æ¥ä¸‹æ¥ï¼Œåœ¨è¿™é‡Œé¢ï¼Œè¿™ä¸ªinet_createä¼šè¢«è°ƒç”¨ã€‚</p><pre><code>static int inet_create(struct net *net, struct socket *sock, int protocol, int kern)\n{\n\tstruct sock *sk;\n\tstruct inet_protosw *answer;\n\tstruct inet_sock *inet;\n\tstruct proto *answer_prot;\n\tunsigned char answer_flags;\n\tint try_loading_module = 0;\n\tint err;\n\n\t/* Look for the requested type/protocol pair. */\nlookup_protocol:\n\tlist_for_each_entry_rcu(answer, &amp;inetsw[sock-&gt;type], list) {\n\t\terr = 0;\n\t\t/* Check the non-wild match. */\n\t\tif (protocol == answer-&gt;protocol) {\n\t\t\tif (protocol != IPPROTO_IP)\n\t\t\t\tbreak;\n\t\t} else {\n\t\t\t/* Check for the two wild cases. */\n\t\t\tif (IPPROTO_IP == protocol) {\n\t\t\t\tprotocol = answer-&gt;protocol;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif (IPPROTO_IP == answer-&gt;protocol)\n\t\t\t\tbreak;\n\t\t}\n\t\terr = -EPROTONOSUPPORT;\n\t}\n......\n\tsock-&gt;ops = answer-&gt;ops;\n\tanswer_prot = answer-&gt;prot;\n\tanswer_flags = answer-&gt;flags;\n......\n\tsk = sk_alloc(net, PF_INET, GFP_KERNEL, answer_prot, kern);\n......\n\tinet = inet_sk(sk);\n\tinet-&gt;nodefrag = 0;\n\tif (SOCK_RAW == sock-&gt;type) {\n\t\tinet-&gt;inet_num = protocol;\n\t\tif (IPPROTO_RAW == protocol)\n\t\t\tinet-&gt;hdrincl = 1;\n\t}\n\tinet-&gt;inet_id = 0;\n\tsock_init_data(sock, sk);\n\n\tsk-&gt;sk_destruct\t   = inet_sock_destruct;\n\tsk-&gt;sk_protocol\t   = protocol;\n\tsk-&gt;sk_backlog_rcv = sk-&gt;sk_prot-&gt;backlog_rcv;\n\n\tinet-&gt;uc_ttl\t= -1;\n\tinet-&gt;mc_loop\t= 1;\n\tinet-&gt;mc_ttl\t= 1;\n\tinet-&gt;mc_all\t= 1;\n\tinet-&gt;mc_index\t= 0;\n\tinet-&gt;mc_list\t= NULL;\n\tinet-&gt;rcv_tos\t= 0;\n\n\tif (inet-&gt;inet_num) {\n\t\tinet-&gt;inet_sport = htons(inet-&gt;inet_num);\n\t\t/* Add to protocol hash chains. */\n\t\terr = sk-&gt;sk_prot-&gt;hash(sk);\n\t}\n\n\tif (sk-&gt;sk_prot-&gt;init) {\n\t\terr = sk-&gt;sk_prot-&gt;init(sk);\n\t}\n......\n}\n</code></pre><p>åœ¨inet_createä¸­ï¼Œæˆ‘ä»¬å…ˆä¼šçœ‹åˆ°ä¸€ä¸ªå¾ªç¯list_for_each_entry_rcuã€‚åœ¨è¿™é‡Œï¼Œç¬¬äºŒä¸ªå‚æ•°typeå¼€å§‹èµ·ä½œç”¨ã€‚å› ä¸ºå¾ªç¯æŸ¥çœ‹çš„æ˜¯inetsw[sock-&gt;type]ã€‚</p><p>è¿™é‡Œçš„inetswä¹Ÿæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œtypeä½œä¸ºä¸‹æ ‡ï¼Œé‡Œé¢çš„å†…å®¹æ˜¯struct inet_protoswï¼Œæ˜¯åè®®ï¼Œä¹Ÿå³inetswæ•°ç»„å¯¹äºæ¯ä¸ªç±»å‹æœ‰ä¸€é¡¹ï¼Œè¿™ä¸€é¡¹é‡Œé¢æ˜¯å±äºè¿™ä¸ªç±»å‹çš„åè®®ã€‚</p><pre><code>static struct list_head inetsw[SOCK_MAX];\n\nstatic int __init inet_init(void)\n{\n......\n\t/* Register the socket-side information for inet_create. */\n\tfor (r = &amp;inetsw[0]; r &lt; &amp;inetsw[SOCK_MAX]; ++r)\n\t\tINIT_LIST_HEAD(r);\n\tfor (q = inetsw_array; q &lt; &amp;inetsw_array[INETSW_ARRAY_LEN]; ++q)\n\t\tinet_register_protosw(q);\n......\n}\n</code></pre><p>inetswæ•°ç»„æ˜¯åœ¨ç³»ç»Ÿåˆå§‹åŒ–çš„æ—¶å€™åˆå§‹åŒ–çš„ï¼Œå°±åƒä¸‹é¢ä»£ç é‡Œé¢å®ç°çš„ä¸€æ ·ã€‚</p><p>é¦–å…ˆï¼Œä¸€ä¸ªå¾ªç¯ä¼šå°†inetswæ•°ç»„çš„æ¯ä¸€é¡¹ï¼Œéƒ½åˆå§‹åŒ–ä¸ºä¸€ä¸ªé“¾è¡¨ã€‚å’±ä»¬å‰é¢è¯´äº†ï¼Œä¸€ä¸ªtypeç±»å‹ä¼šåŒ…å«å¤šä¸ªprotocolï¼Œå› è€Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªé“¾è¡¨ã€‚æ¥ä¸‹æ¥ä¸€ä¸ªå¾ªç¯ï¼Œæ˜¯å°†inetsw_arrayæ³¨å†Œåˆ°inetswæ•°ç»„é‡Œé¢å»ã€‚inetsw_arrayçš„å®šä¹‰å¦‚ä¸‹ï¼Œè¿™ä¸ªæ•°ç»„é‡Œé¢çš„å†…å®¹å¾ˆé‡è¦ï¼Œåé¢ä¼šç”¨åˆ°å®ƒä»¬ã€‚</p><pre><code>static struct inet_protosw inetsw_array[] =\n{\n\t{\n\t\t.type =       SOCK_STREAM,\n\t\t.protocol =   IPPROTO_TCP,\n\t\t.prot =       &amp;tcp_prot,\n\t\t.ops =        &amp;inet_stream_ops,\n\t\t.flags =      INET_PROTOSW_PERMANENT |\n\t\t\t      INET_PROTOSW_ICSK,\n\t},\n\t{\n\t\t.type =       SOCK_DGRAM,\n\t\t.protocol =   IPPROTO_UDP,\n\t\t.prot =       &amp;udp_prot,\n\t\t.ops =        &amp;inet_dgram_ops,\n\t\t.flags =      INET_PROTOSW_PERMANENT,\n     },\n     {\n\t\t.type =       SOCK_DGRAM,\n\t\t.protocol =   IPPROTO_ICMP,\n\t\t.prot =       &amp;ping_prot,\n\t\t.ops =        &amp;inet_sockraw_ops,\n\t\t.flags =      INET_PROTOSW_REUSE,\n     },\n     {\n        .type =       SOCK_RAW,\n\t    .protocol =   IPPROTO_IP,\t/* wild card */\n\t    .prot =       &amp;raw_prot,\n\t    .ops =        &amp;inet_sockraw_ops,\n\t    .flags =      INET_PROTOSW_REUSE,\n     }\n}\n</code></pre><p>æˆ‘ä»¬å›åˆ°inet_createçš„list_for_each_entry_rcuå¾ªç¯ä¸­ã€‚åˆ°è¿™é‡Œå°±å¥½ç†è§£äº†ï¼Œè¿™æ˜¯åœ¨inetswæ•°ç»„ä¸­ï¼Œæ ¹æ®typeæ‰¾åˆ°å±äºè¿™ä¸ªç±»å‹çš„åˆ—è¡¨ï¼Œç„¶åä¾æ¬¡æ¯”è¾ƒåˆ—è¡¨ä¸­çš„struct inet_protoswçš„protocolæ˜¯ä¸æ˜¯ç”¨æˆ·æŒ‡å®šçš„protocolï¼›å¦‚æœæ˜¯ï¼Œå°±å¾—åˆ°äº†ç¬¦åˆç”¨æˆ·æŒ‡å®šçš„family-&gt;type-&gt;protocolçš„struct inet_protosw *answerå¯¹è±¡ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œstruct socket *sockçš„opsæˆå‘˜å˜é‡ï¼Œè¢«èµ‹å€¼ä¸ºanswerçš„opsã€‚å¯¹äºTCPæ¥è®²ï¼Œå°±æ˜¯inet_stream_opsã€‚åé¢ä»»ä½•ç”¨æˆ·å¯¹äºè¿™ä¸ªsocketçš„æ“ä½œï¼Œéƒ½æ˜¯é€šè¿‡inet_stream_opsè¿›è¡Œçš„ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªstruct sock *skå¯¹è±¡ã€‚è¿™é‡Œæ¯”è¾ƒè®©äººå›°æƒ‘ã€‚socketå’Œsockçœ‹èµ·æ¥å‡ ä¹ä¸€æ ·ï¼Œå®¹æ˜“è®©äººæ··æ·†ï¼Œè¿™é‡Œéœ€è¦è¯´æ˜ä¸€ä¸‹ï¼Œsocketæ˜¯ç”¨äºè´Ÿè´£å¯¹ä¸Šç»™ç”¨æˆ·æä¾›æ¥å£ï¼Œå¹¶ä¸”å’Œæ–‡ä»¶ç³»ç»Ÿå…³è”ã€‚è€Œsockï¼Œè´Ÿè´£å‘ä¸‹å¯¹æ¥å†…æ ¸ç½‘ç»œåè®®æ ˆã€‚</p><p>åœ¨sk_allocå‡½æ•°ä¸­ï¼Œstruct inet_protosw *answerç»“æ„çš„tcp_protèµ‹å€¼ç»™äº†struct sock *skçš„sk_protæˆå‘˜ã€‚tcp_protçš„å®šä¹‰å¦‚ä¸‹ï¼Œé‡Œé¢å®šä¹‰äº†å¾ˆå¤šçš„å‡½æ•°ï¼Œéƒ½æ˜¯sockä¹‹ä¸‹å†…æ ¸åè®®æ ˆçš„åŠ¨ä½œã€‚</p><pre><code>struct proto tcp_prot = {\n\t.name\t\t\t= &quot;TCP&quot;,\n\t.owner\t\t\t= THIS_MODULE,\n\t.close\t\t\t= tcp_close,\n\t.connect\t\t= tcp_v4_connect,\n\t.disconnect\t\t= tcp_disconnect,\n\t.accept\t\t\t= inet_csk_accept,\n\t.ioctl\t\t\t= tcp_ioctl,\n\t.init\t\t\t= tcp_v4_init_sock,\n\t.destroy\t\t= tcp_v4_destroy_sock,\n\t.shutdown\t\t= tcp_shutdown,\n\t.setsockopt\t\t= tcp_setsockopt,\n\t.getsockopt\t\t= tcp_getsockopt,\n\t.keepalive\t\t= tcp_set_keepalive,\n\t.recvmsg\t\t= tcp_recvmsg,\n\t.sendmsg\t\t= tcp_sendmsg,\n\t.sendpage\t\t= tcp_sendpage,\n\t.backlog_rcv\t\t= tcp_v4_do_rcv,\n\t.release_cb\t\t= tcp_release_cb,\n\t.hash\t\t\t= inet_hash,\n    .get_port\t\t= inet_csk_get_port,\n......\n}\n</code></pre><p>åœ¨inet_createå‡½æ•°ä¸­ï¼Œæ¥ä¸‹æ¥åˆ›å»ºä¸€ä¸ªstruct inet_sockç»“æ„ï¼Œè¿™ä¸ªç»“æ„ä¸€å¼€å§‹å°±æ˜¯struct sockï¼Œç„¶åæ‰©å±•äº†ä¸€äº›å…¶ä»–çš„ä¿¡æ¯ï¼Œå‰©ä¸‹çš„ä»£ç å°±å¡«å……è¿™äº›ä¿¡æ¯ã€‚è¿™ä¸€å¹•æˆ‘ä»¬ä¼šç»å¸¸çœ‹åˆ°ï¼Œå°†ä¸€ä¸ªç»“æ„æ”¾åœ¨å¦ä¸€ä¸ªç»“æ„çš„å¼€å§‹ä½ç½®ï¼Œç„¶åæ‰©å±•ä¸€äº›æˆå‘˜ï¼Œé€šè¿‡å¯¹äºæŒ‡é’ˆçš„å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œæ¥è®¿é—®è¿™äº›æˆå‘˜ã€‚</p><p>socketçš„åˆ›å»ºè‡³æ­¤ç»“æŸã€‚</p><h2>è§£æbindå‡½æ•°</h2><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹bindã€‚</p><pre><code>SYSCALL_DEFINE3(bind, int, fd, struct sockaddr __user *, umyaddr, int, addrlen)\n{\n\tstruct socket *sock;\n\tstruct sockaddr_storage address;\n\tint err, fput_needed;\n\n\tsock = sockfd_lookup_light(fd, &amp;err, &amp;fput_needed);\n\tif (sock) {\n\t\terr = move_addr_to_kernel(umyaddr, addrlen, &amp;address);\n\t\tif (err &gt;= 0) {\n\t\t\terr = sock-&gt;ops-&gt;bind(sock,\n\t\t\t\t\t\t      (struct sockaddr *)\n\t\t\t\t\t\t      &amp;address, addrlen);\n\t\t}\n\t\tfput_light(sock-&gt;file, fput_needed);\n\t}\n\treturn err;\n}\n</code></pre><p>åœ¨bindä¸­ï¼Œsockfd_lookup_lightä¼šæ ¹æ®fdæ–‡ä»¶æè¿°ç¬¦ï¼Œæ‰¾åˆ°struct socketç»“æ„ã€‚ç„¶åå°†sockaddrä»ç”¨æˆ·æ€æ‹·è´åˆ°å†…æ ¸æ€ï¼Œç„¶åè°ƒç”¨struct socketç»“æ„é‡Œé¢opsçš„bindå‡½æ•°ã€‚æ ¹æ®å‰é¢åˆ›å»ºsocketçš„æ—¶å€™çš„è®¾å®šï¼Œè°ƒç”¨çš„æ˜¯inet_stream_opsçš„bindå‡½æ•°ï¼Œä¹Ÿå³è°ƒç”¨inet_bindã€‚</p><pre><code>int inet_bind(struct socket *sock, struct sockaddr *uaddr, int addr_len)\n{\n\tstruct sockaddr_in *addr = (struct sockaddr_in *)uaddr;\n\tstruct sock *sk = sock-&gt;sk;\n\tstruct inet_sock *inet = inet_sk(sk);\n\tstruct net *net = sock_net(sk);\n\tunsigned short snum;\n......\n\tsnum = ntohs(addr-&gt;sin_port);\n......\n\tinet-&gt;inet_rcv_saddr = inet-&gt;inet_saddr = addr-&gt;sin_addr.s_addr;\n\t/* Make sure we are allowed to bind here. */\n\tif ((snum || !inet-&gt;bind_address_no_port) &amp;&amp;\n\t    sk-&gt;sk_prot-&gt;get_port(sk, snum)) {\n......\n\t}\n\tinet-&gt;inet_sport = htons(inet-&gt;inet_num);\n\tinet-&gt;inet_daddr = 0;\n\tinet-&gt;inet_dport = 0;\n\tsk_dst_reset(sk);\n}\n</code></pre><p>bindé‡Œé¢ä¼šè°ƒç”¨sk_protçš„get_portå‡½æ•°ï¼Œä¹Ÿå³inet_csk_get_portæ¥æ£€æŸ¥ç«¯å£æ˜¯å¦å†²çªï¼Œæ˜¯å¦å¯ä»¥ç»‘å®šã€‚å¦‚æœå…è®¸ï¼Œåˆ™ä¼šè®¾ç½®struct inet_sockçš„æœ¬æ–¹çš„åœ°å€inet_saddrå’Œæœ¬æ–¹çš„ç«¯å£inet_sportï¼Œå¯¹æ–¹çš„åœ°å€inet_daddrå’Œå¯¹æ–¹çš„ç«¯å£inet_dportéƒ½åˆå§‹åŒ–ä¸º0ã€‚</p><p>bindçš„é€»è¾‘ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼Œå°±åˆ°è¿™é‡Œäº†ã€‚</p><h2>è§£ælistenå‡½æ•°</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹listenã€‚</p><pre><code>SYSCALL_DEFINE2(listen, int, fd, int, backlog)\n{\n\tstruct socket *sock;\n\tint err, fput_needed;\n\tint somaxconn;\n\n\tsock = sockfd_lookup_light(fd, &amp;err, &amp;fput_needed);\n\tif (sock) {\n\t\tsomaxconn = sock_net(sock-&gt;sk)-&gt;core.sysctl_somaxconn;\n\t\tif ((unsigned int)backlog &gt; somaxconn)\n\t\t\tbacklog = somaxconn;\n\t\terr = sock-&gt;ops-&gt;listen(sock, backlog);\n\t\tfput_light(sock-&gt;file, fput_needed);\n\t}\n\treturn err;\n}\n</code></pre><p>åœ¨listenä¸­ï¼Œæˆ‘ä»¬è¿˜æ˜¯é€šè¿‡sockfd_lookup_lightï¼Œæ ¹æ®fdæ–‡ä»¶æè¿°ç¬¦ï¼Œæ‰¾åˆ°struct socketç»“æ„ã€‚æ¥ç€ï¼Œæˆ‘ä»¬è°ƒç”¨struct socketç»“æ„é‡Œé¢opsçš„listenå‡½æ•°ã€‚æ ¹æ®å‰é¢åˆ›å»ºsocketçš„æ—¶å€™çš„è®¾å®šï¼Œè°ƒç”¨çš„æ˜¯inet_stream_opsçš„listenå‡½æ•°ï¼Œä¹Ÿå³è°ƒç”¨inet_listenã€‚</p><pre><code>int inet_listen(struct socket *sock, int backlog)\n{\n\tstruct sock *sk = sock-&gt;sk;\n\tunsigned char old_state;\n\tint err;\n\told_state = sk-&gt;sk_state;\n\t/* Really, if the socket is already in listen state\n\t * we can only allow the backlog to be adjusted.\n\t */\n\tif (old_state != TCP_LISTEN) {\n\t\terr = inet_csk_listen_start(sk, backlog);\n\t}\n\tsk-&gt;sk_max_ack_backlog = backlog;\n}\n</code></pre><p>å¦‚æœè¿™ä¸ªsocketè¿˜ä¸åœ¨TCP_LISTENçŠ¶æ€ï¼Œä¼šè°ƒç”¨inet_csk_listen_startè¿›å…¥ç›‘å¬çŠ¶æ€ã€‚</p><pre><code>int inet_csk_listen_start(struct sock *sk, int backlog)\n{\n\tstruct inet_connection_sock *icsk = inet_csk(sk);\n\tstruct inet_sock *inet = inet_sk(sk);\n\tint err = -EADDRINUSE;\n\n\treqsk_queue_alloc(&amp;icsk-&gt;icsk_accept_queue);\n\n\tsk-&gt;sk_max_ack_backlog = backlog;\n\tsk-&gt;sk_ack_backlog = 0;\n\tinet_csk_delack_init(sk);\n\n\tsk_state_store(sk, TCP_LISTEN);\n\tif (!sk-&gt;sk_prot-&gt;get_port(sk, inet-&gt;inet_num)) {\n......\n\t}\n......\n}\n</code></pre><p>è¿™é‡Œé¢å»ºç«‹äº†ä¸€ä¸ªæ–°çš„ç»“æ„inet_connection_sockï¼Œè¿™ä¸ªç»“æ„ä¸€å¼€å§‹æ˜¯struct inet_sockï¼Œinet_cskå…¶å®åšäº†ä¸€æ¬¡å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œæ‰©å¤§äº†ç»“æ„ï¼Œçœ‹åˆ°äº†å§ï¼Œåˆæ˜¯è¿™ä¸ªå¥—è·¯ã€‚</p><p>struct inet_connection_sockç»“æ„æ¯”è¾ƒå¤æ‚ã€‚å¦‚æœæ‰“å¼€å®ƒï¼Œä½ èƒ½çœ‹åˆ°å¤„äºå„ç§çŠ¶æ€çš„é˜Ÿåˆ—ï¼Œå„ç§è¶…æ—¶æ—¶é—´ã€æ‹¥å¡æ§åˆ¶ç­‰å­—çœ¼ã€‚æˆ‘ä»¬è¯´TCPæ˜¯é¢å‘è¿æ¥çš„ï¼Œå°±æ˜¯å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éƒ½æ˜¯æœ‰ä¸€ä¸ªç»“æ„ç»´æŠ¤è¿æ¥çš„çŠ¶æ€ï¼Œå°±æ˜¯æŒ‡è¿™ä¸ªç»“æ„ã€‚æˆ‘ä»¬è¿™é‡Œå…ˆä¸è¯¦ç»†åˆ†æé‡Œé¢çš„å˜é‡ï¼Œå› ä¸ºå¤ªå¤šäº†ï¼Œåé¢æˆ‘ä»¬é‡åˆ°ä¸€ä¸ªåˆ†æä¸€ä¸ªã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬é‡åˆ°çš„æ˜¯icsk_accept_queueã€‚å®ƒæ˜¯å¹²ä»€ä¹ˆçš„å‘¢ï¼Ÿ</p><p>åœ¨TCPçš„çŠ¶æ€é‡Œé¢ï¼Œæœ‰ä¸€ä¸ªlistençŠ¶æ€ï¼Œå½“è°ƒç”¨listenå‡½æ•°ä¹‹åï¼Œå°±ä¼šè¿›å…¥è¿™ä¸ªçŠ¶æ€ï¼Œè™½ç„¶æˆ‘ä»¬å†™ç¨‹åºçš„æ—¶å€™ï¼Œä¸€èˆ¬è¦ç­‰å¾…æœåŠ¡ç«¯è°ƒç”¨acceptåï¼Œç­‰å¾…åœ¨å“ªé‡Œçš„æ—¶å€™ï¼Œè®©å®¢æˆ·ç«¯å°±å‘èµ·è¿æ¥ã€‚å…¶å®æœåŠ¡ç«¯ä¸€æ—¦å¤„äºlistençŠ¶æ€ï¼Œä¸ç”¨acceptï¼Œå®¢æˆ·ç«¯ä¹Ÿèƒ½å‘èµ·è¿æ¥ã€‚å…¶å®TCPçš„çŠ¶æ€ä¸­ï¼Œæ²¡æœ‰ä¸€ä¸ªæ˜¯å¦è¢«acceptçš„çŠ¶æ€ï¼Œé‚£acceptå‡½æ•°çš„ä½œç”¨æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><p>åœ¨å†…æ ¸ä¸­ï¼Œä¸ºæ¯ä¸ªSocketç»´æŠ¤ä¸¤ä¸ªé˜Ÿåˆ—ã€‚ä¸€ä¸ªæ˜¯å·²ç»å»ºç«‹äº†è¿æ¥çš„é˜Ÿåˆ—ï¼Œè¿™æ—¶å€™è¿æ¥ä¸‰æ¬¡æ¡æ‰‹å·²ç»å®Œæ¯•ï¼Œå¤„äºestablishedçŠ¶æ€ï¼›ä¸€ä¸ªæ˜¯è¿˜æ²¡æœ‰å®Œå…¨å»ºç«‹è¿æ¥çš„é˜Ÿåˆ—ï¼Œè¿™ä¸ªæ—¶å€™ä¸‰æ¬¡æ¡æ‰‹è¿˜æ²¡å®Œæˆï¼Œå¤„äºsyn_rcvdçš„çŠ¶æ€ã€‚</p><p>æœåŠ¡ç«¯è°ƒç”¨acceptå‡½æ•°ï¼Œå…¶å®æ˜¯åœ¨ç¬¬ä¸€ä¸ªé˜Ÿåˆ—ä¸­æ‹¿å‡ºä¸€ä¸ªå·²ç»å®Œæˆçš„è¿æ¥è¿›è¡Œå¤„ç†ã€‚å¦‚æœè¿˜æ²¡æœ‰å®Œæˆå°±é˜»å¡ç­‰å¾…ã€‚è¿™é‡Œçš„icsk_accept_queueå°±æ˜¯ç¬¬ä¸€ä¸ªé˜Ÿåˆ—ã€‚</p><p>åˆå§‹åŒ–å®Œä¹‹åï¼Œå°†TCPçš„çŠ¶æ€è®¾ç½®ä¸ºTCP_LISTENï¼Œå†æ¬¡è°ƒç”¨get_portåˆ¤æ–­ç«¯å£æ˜¯å¦å†²çªã€‚</p><p>è‡³æ­¤ï¼Œlistençš„é€»è¾‘å°±ç»“æŸäº†ã€‚</p><h2>è§£æacceptå‡½æ•°</h2><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è§£ææœåŠ¡ç«¯è°ƒç”¨acceptã€‚</p><pre><code>SYSCALL_DEFINE3(accept, int, fd, struct sockaddr __user *, upeer_sockaddr,\n\t\tint __user *, upeer_addrlen)\n{\n\treturn sys_accept4(fd, upeer_sockaddr, upeer_addrlen, 0);\n}\n\nSYSCALL_DEFINE4(accept4, int, fd, struct sockaddr __user *, upeer_sockaddr,\n\t\tint __user *, upeer_addrlen, int, flags)\n{\n\tstruct socket *sock, *newsock;\n\tstruct file *newfile;\n\tint err, len, newfd, fput_needed;\n\tstruct sockaddr_storage address;\n......\n\tsock = sockfd_lookup_light(fd, &amp;err, &amp;fput_needed);\n\tnewsock = sock_alloc();\n\tnewsock-&gt;type = sock-&gt;type;\n\tnewsock-&gt;ops = sock-&gt;ops;\n\tnewfd = get_unused_fd_flags(flags);\n\tnewfile = sock_alloc_file(newsock, flags, sock-&gt;sk-&gt;sk_prot_creator-&gt;name);\n\terr = sock-&gt;ops-&gt;accept(sock, newsock, sock-&gt;file-&gt;f_flags, false);\n\tif (upeer_sockaddr) {\n\t\tif (newsock-&gt;ops-&gt;getname(newsock, (struct sockaddr *)&amp;address, &amp;len, 2) &lt; 0) {\n\t\t}\n\t\terr = move_addr_to_user(&amp;address,\n\t\t\t\t\tlen, upeer_sockaddr, upeer_addrlen);\n\t}\n\tfd_install(newfd, newfile);\n......\n}\n</code></pre><p>acceptå‡½æ•°çš„å®ç°ï¼Œå°è¯äº†socketçš„åŸç†ä¸­è¯´çš„é‚£æ ·ï¼ŒåŸæ¥çš„socketæ˜¯ç›‘å¬socketï¼Œè¿™é‡Œæˆ‘ä»¬ä¼šæ‰¾åˆ°åŸæ¥çš„struct socketï¼Œå¹¶åŸºäºå®ƒå»åˆ›å»ºä¸€ä¸ªæ–°çš„newsockã€‚è¿™æ‰æ˜¯è¿æ¥socketã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„struct fileå’Œfdï¼Œå¹¶å…³è”åˆ°socketã€‚</p><p>è¿™é‡Œé¢è¿˜ä¼šè°ƒç”¨struct socketçš„sock-&gt;ops-&gt;acceptï¼Œä¹Ÿå³ä¼šè°ƒç”¨inet_stream_opsçš„acceptå‡½æ•°ï¼Œä¹Ÿå³inet_acceptã€‚</p><pre><code>int inet_accept(struct socket *sock, struct socket *newsock, int flags, bool kern)\n{\n\tstruct sock *sk1 = sock-&gt;sk;\n\tint err = -EINVAL;\n\tstruct sock *sk2 = sk1-&gt;sk_prot-&gt;accept(sk1, flags, &amp;err, kern);\n\tsock_rps_record_flow(sk2);\n\tsock_graft(sk2, newsock);\n\tnewsock-&gt;state = SS_CONNECTED;\n}\n</code></pre><p>inet_acceptä¼šè°ƒç”¨struct sockçš„sk1-&gt;sk_prot-&gt;acceptï¼Œä¹Ÿå³tcp_protçš„acceptå‡½æ•°ï¼Œinet_csk_acceptå‡½æ•°ã€‚</p><pre><code>/*\n * This will accept the next outstanding connection.\n */\nstruct sock *inet_csk_accept(struct sock *sk, int flags, int *err, bool kern)\n{\n\tstruct inet_connection_sock *icsk = inet_csk(sk);\n\tstruct request_sock_queue *queue = &amp;icsk-&gt;icsk_accept_queue;\n\tstruct request_sock *req;\n\tstruct sock *newsk;\n\tint error;\n\n\tif (sk-&gt;sk_state != TCP_LISTEN)\n\t\tgoto out_err;\n\n\t/* Find already established connection */\n\tif (reqsk_queue_empty(queue)) {\n\t\tlong timeo = sock_rcvtimeo(sk, flags &amp; O_NONBLOCK);\n\t\terror = inet_csk_wait_for_connect(sk, timeo);\n\t}\n\treq = reqsk_queue_remove(queue, sk);\n\tnewsk = req-&gt;sk;\n......\n}\n\n/*\n * Wait for an incoming connection, avoid race conditions. This must be called\n * with the socket locked.\n */\nstatic int inet_csk_wait_for_connect(struct sock *sk, long timeo)\n{\n\tstruct inet_connection_sock *icsk = inet_csk(sk);\n\tDEFINE_WAIT(wait);\n\tint err;\n\tfor (;;) {\n\t\tprepare_to_wait_exclusive(sk_sleep(sk), &amp;wait,\n\t\t\t\t\t  TASK_INTERRUPTIBLE);\n\t\trelease_sock(sk);\n\t\tif (reqsk_queue_empty(&amp;icsk-&gt;icsk_accept_queue))\n\t\t\ttimeo = schedule_timeout(timeo);\n\t\tsched_annotate_sleep();\n\t\tlock_sock(sk);\n\t\terr = 0;\n\t\tif (!reqsk_queue_empty(&amp;icsk-&gt;icsk_accept_queue))\n\t\t\tbreak;\n\t\terr = -EINVAL;\n\t\tif (sk-&gt;sk_state != TCP_LISTEN)\n\t\t\tbreak;\n\t\terr = sock_intr_errno(timeo);\n\t\tif (signal_pending(current))\n\t\t\tbreak;\n\t\terr = -EAGAIN;\n\t\tif (!timeo)\n\t\t\tbreak;\n\t}\n\tfinish_wait(sk_sleep(sk), &amp;wait);\n\treturn err;\n}\n</code></pre><p>inet_csk_acceptçš„å®ç°ï¼Œå°è¯äº†ä¸Šé¢æˆ‘ä»¬è®²çš„ä¸¤ä¸ªé˜Ÿåˆ—çš„é€»è¾‘ã€‚å¦‚æœicsk_accept_queueä¸ºç©ºï¼Œåˆ™è°ƒç”¨inet_csk_wait_for_connectè¿›è¡Œç­‰å¾…ï¼›ç­‰å¾…çš„æ—¶å€™ï¼Œè°ƒç”¨schedule_timeoutï¼Œè®©å‡ºCPUï¼Œå¹¶ä¸”å°†è¿›ç¨‹çŠ¶æ€è®¾ç½®ä¸ºTASK_INTERRUPTIBLEã€‚</p><p>å¦‚æœå†æ¬¡CPUé†’æ¥ï¼Œæˆ‘ä»¬ä¼šæ¥ç€åˆ¤æ–­icsk_accept_queueæ˜¯å¦ä¸ºç©ºï¼ŒåŒæ—¶ä¹Ÿä¼šè°ƒç”¨signal_pendingçœ‹æœ‰æ²¡æœ‰ä¿¡å·å¯ä»¥å¤„ç†ã€‚ä¸€æ—¦icsk_accept_queueä¸ä¸ºç©ºï¼Œå°±ä»inet_csk_wait_for_connectä¸­è¿”å›ï¼Œåœ¨é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªstruct sockå¯¹è±¡èµ‹å€¼ç»™newskã€‚</p><h2>è§£æconnectå‡½æ•°</h2><p>ä»€ä¹ˆæƒ…å†µä¸‹ï¼Œicsk_accept_queueæ‰ä¸ä¸ºç©ºå‘¢ï¼Ÿå½“ç„¶æ˜¯ä¸‰æ¬¡æ¡æ‰‹ç»“æŸæ‰å¯ä»¥ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¥åˆ†æä¸‰æ¬¡æ¡æ‰‹çš„è¿‡ç¨‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/ab/df/ab92c2afb4aafb53143c471293ccb2df.png?wh=3223*3178\" alt=\"\"></p><p>ä¸‰æ¬¡æ¡æ‰‹ä¸€èˆ¬æ˜¯ç”±å®¢æˆ·ç«¯è°ƒç”¨connectå‘èµ·ã€‚</p><pre><code>SYSCALL_DEFINE3(connect, int, fd, struct sockaddr __user *, uservaddr,\n\t\tint, addrlen)\n{\n\tstruct socket *sock;\n\tstruct sockaddr_storage address;\n\tint err, fput_needed;\n\tsock = sockfd_lookup_light(fd, &amp;err, &amp;fput_needed);\n\terr = move_addr_to_kernel(uservaddr, addrlen, &amp;address);\n\terr = sock-&gt;ops-&gt;connect(sock, (struct sockaddr *)&amp;address, addrlen, sock-&gt;file-&gt;f_flags);\n}\n</code></pre><p>connectå‡½æ•°çš„å®ç°ä¸€å¼€å§‹ä½ åº”è¯¥å¾ˆçœ¼ç†Ÿï¼Œè¿˜æ˜¯é€šè¿‡sockfd_lookup_lightï¼Œæ ¹æ®fdæ–‡ä»¶æè¿°ç¬¦ï¼Œæ‰¾åˆ°struct socketç»“æ„ã€‚æ¥ç€ï¼Œæˆ‘ä»¬ä¼šè°ƒç”¨struct socketç»“æ„é‡Œé¢opsçš„connectå‡½æ•°ï¼Œæ ¹æ®å‰é¢åˆ›å»ºsocketçš„æ—¶å€™çš„è®¾å®šï¼Œè°ƒç”¨inet_stream_opsçš„connectå‡½æ•°ï¼Œä¹Ÿå³è°ƒç”¨inet_stream_connectã€‚</p><pre><code>/*\n *\tConnect to a remote host. There is regrettably still a little\n *\tTCP 'magic' in here.\n */\nint __inet_stream_connect(struct socket *sock, struct sockaddr *uaddr,\n\t\t\t  int addr_len, int flags, int is_sendmsg)\n{\n\tstruct sock *sk = sock-&gt;sk;\n\tint err;\n\tlong timeo;\n\n\tswitch (sock-&gt;state) {\n......\n\tcase SS_UNCONNECTED:\n\t\terr = -EISCONN;\n\t\tif (sk-&gt;sk_state != TCP_CLOSE)\n\t\t\tgoto out;\n\n\t\terr = sk-&gt;sk_prot-&gt;connect(sk, uaddr, addr_len);\n\t\tsock-&gt;state = SS_CONNECTING;\n\t\tbreak;\n\t}\n\n\ttimeo = sock_sndtimeo(sk, flags &amp; O_NONBLOCK);\n\n\tif ((1 &lt;&lt; sk-&gt;sk_state) &amp; (TCPF_SYN_SENT | TCPF_SYN_RECV)) {\n......\n\t\tif (!timeo || !inet_wait_for_connect(sk, timeo, writebias))\n\t\t\tgoto out;\n\n\t\terr = sock_intr_errno(timeo);\n\t\tif (signal_pending(current))\n\t\t\tgoto out;\n\t}\n\tsock-&gt;state = SS_CONNECTED;\n}\n</code></pre><p>åœ¨__inet_stream_connecté‡Œé¢ï¼Œæˆ‘ä»¬å‘ç°ï¼Œå¦‚æœsocketå¤„äºSS_UNCONNECTEDçŠ¶æ€ï¼Œé‚£å°±è°ƒç”¨struct sockçš„sk-&gt;sk_prot-&gt;connectï¼Œä¹Ÿå³tcp_protçš„connectå‡½æ•°â€”â€”tcp_v4_connectå‡½æ•°ã€‚</p><pre><code>int tcp_v4_connect(struct sock *sk, struct sockaddr *uaddr, int addr_len)\n{\n\tstruct sockaddr_in *usin = (struct sockaddr_in *)uaddr;\n\tstruct inet_sock *inet = inet_sk(sk);\n\tstruct tcp_sock *tp = tcp_sk(sk);\n\t__be16 orig_sport, orig_dport;\n\t__be32 daddr, nexthop;\n\tstruct flowi4 *fl4;\n\tstruct rtable *rt;\n......\n\torig_sport = inet-&gt;inet_sport;\n\torig_dport = usin-&gt;sin_port;\n\trt = ip_route_connect(fl4, nexthop, inet-&gt;inet_saddr,\n\t\t\t      RT_CONN_FLAGS(sk), sk-&gt;sk_bound_dev_if,\n\t\t\t      IPPROTO_TCP,\n\t\t\t      orig_sport, orig_dport, sk);\n......\n\ttcp_set_state(sk, TCP_SYN_SENT);\n\terr = inet_hash_connect(tcp_death_row, sk);\n\tsk_set_txhash(sk);\n\trt = ip_route_newports(fl4, rt, orig_sport, orig_dport,\n\t\t\t       inet-&gt;inet_sport, inet-&gt;inet_dport, sk);\n\t/* OK, now commit destination to socket.  */\n\tsk-&gt;sk_gso_type = SKB_GSO_TCPV4;\n\tsk_setup_caps(sk, &amp;rt-&gt;dst);\n    if (likely(!tp-&gt;repair)) {\n\t\tif (!tp-&gt;write_seq)\n\t\t\ttp-&gt;write_seq = secure_tcp_seq(inet-&gt;inet_saddr,\n\t\t\t\t\t\t       inet-&gt;inet_daddr,\n\t\t\t\t\t\t       inet-&gt;inet_sport,\n\t\t\t\t\t\t       usin-&gt;sin_port);\n\t\ttp-&gt;tsoffset = secure_tcp_ts_off(sock_net(sk),\n\t\t\t\t\t\t inet-&gt;inet_saddr,\n\t\t\t\t\t\t inet-&gt;inet_daddr);\n\t}\n\trt = NULL;\n......\n\terr = tcp_connect(sk);\n......\n}\n</code></pre><p>åœ¨tcp_v4_connectå‡½æ•°ä¸­ï¼Œip_route_connectå…¶å®æ˜¯åšä¸€ä¸ªè·¯ç”±çš„é€‰æ‹©ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºä¸‰æ¬¡æ¡æ‰‹é©¬ä¸Šå°±è¦å‘é€ä¸€ä¸ªSYNåŒ…äº†ï¼Œè¿™å°±è¦å‡‘é½æºåœ°å€ã€æºç«¯å£ã€ç›®æ ‡åœ°å€ã€ç›®æ ‡ç«¯å£ã€‚ç›®æ ‡åœ°å€å’Œç›®æ ‡ç«¯å£æ˜¯æœåŠ¡ç«¯çš„ï¼Œå·²ç»çŸ¥é“æºç«¯å£æ˜¯å®¢æˆ·ç«¯éšæœºåˆ†é…çš„ï¼Œæºåœ°å€åº”è¯¥ç”¨å“ªä¸€ä¸ªå‘¢ï¼Ÿè¿™æ—¶å€™è¦é€‰æ‹©ä¸€æ¡è·¯ç”±ï¼Œçœ‹ä»å“ªä¸ªç½‘å¡å‡ºå»ï¼Œå°±åº”è¯¥å¡«å†™å“ªä¸ªç½‘å¡çš„IPåœ°å€ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œåœ¨å‘é€SYNä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå°†å®¢æˆ·ç«¯socketçš„çŠ¶æ€è®¾ç½®ä¸ºTCP_SYN_SENTã€‚ç„¶ååˆå§‹åŒ–TCPçš„seq numï¼Œä¹Ÿå³write_seqï¼Œç„¶åè°ƒç”¨tcp_connectè¿›è¡Œå‘é€ã€‚</p><pre><code>/* Build a SYN and send it off. */\nint tcp_connect(struct sock *sk)\n{\n\tstruct tcp_sock *tp = tcp_sk(sk);\n\tstruct sk_buff *buff;\n\tint err;\n......\n\ttcp_connect_init(sk);\n......\n\tbuff = sk_stream_alloc_skb(sk, 0, sk-&gt;sk_allocation, true);\n......\n\ttcp_init_nondata_skb(buff, tp-&gt;write_seq++, TCPHDR_SYN);\n\ttcp_mstamp_refresh(tp);\n\ttp-&gt;retrans_stamp = tcp_time_stamp(tp);\n\ttcp_connect_queue_skb(sk, buff);\n\ttcp_ecn_send_syn(sk, buff);\n\n\t/* Send off SYN; include data in Fast Open. */\n\terr = tp-&gt;fastopen_req ? tcp_send_syn_data(sk, buff) :\n\t      tcp_transmit_skb(sk, buff, 1, sk-&gt;sk_allocation);\n......\n\ttp-&gt;snd_nxt = tp-&gt;write_seq;\n\ttp-&gt;pushed_seq = tp-&gt;write_seq;\n\tbuff = tcp_send_head(sk);\n\tif (unlikely(buff)) {\n\t\ttp-&gt;snd_nxt\t= TCP_SKB_CB(buff)-&gt;seq;\n\t\ttp-&gt;pushed_seq\t= TCP_SKB_CB(buff)-&gt;seq;\n\t}\n......\n\t/* Timer for repeating the SYN until an answer. */\n\tinet_csk_reset_xmit_timer(sk, ICSK_TIME_RETRANS,\n\t\t\t\t  inet_csk(sk)-&gt;icsk_rto, TCP_RTO_MAX);\n\treturn 0;\n}\n</code></pre><p>åœ¨tcp_connectä¸­ï¼Œæœ‰ä¸€ä¸ªæ–°çš„ç»“æ„struct tcp_sockï¼Œå¦‚æœæ‰“å¼€ä»–ï¼Œä½ ä¼šå‘ç°ä»–æ˜¯struct inet_connection_sockçš„ä¸€ä¸ªæ‰©å±•ï¼Œstruct inet_connection_sockåœ¨struct tcp_sockå¼€å¤´çš„ä½ç½®ï¼Œé€šè¿‡å¼ºåˆ¶ç±»å‹è½¬æ¢è®¿é—®ï¼Œæ•…ä¼é‡æ¼”åˆä¸€æ¬¡ã€‚</p><p>struct tcp_socké‡Œé¢ç»´æŠ¤äº†æ›´å¤šçš„TCPçš„çŠ¶æ€ï¼Œå’±ä»¬åŒæ ·æ˜¯é‡åˆ°äº†å†åˆ†æã€‚</p><p>æ¥ä¸‹æ¥tcp_init_nondata_skbåˆå§‹åŒ–ä¸€ä¸ªSYNåŒ…ï¼Œtcp_transmit_skbå°†SYNåŒ…å‘é€å‡ºå»ï¼Œinet_csk_reset_xmit_timerè®¾ç½®äº†ä¸€ä¸ªtimerï¼Œå¦‚æœSYNå‘é€ä¸æˆåŠŸï¼Œåˆ™å†æ¬¡å‘é€ã€‚</p><p>å‘é€ç½‘ç»œåŒ…çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬æ”¾åˆ°ä¸‹ä¸€èŠ‚è®²è§£ã€‚è¿™é‡Œæˆ‘ä»¬å§‘ä¸”è®¤ä¸ºSYNå·²ç»å‘é€å‡ºå»äº†ã€‚</p><p>æˆ‘ä»¬å›åˆ°__inet_stream_connectå‡½æ•°ï¼Œåœ¨è°ƒç”¨sk-&gt;sk_prot-&gt;connectä¹‹åï¼Œinet_wait_for_connectä¼šä¸€ç›´ç­‰å¾…å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡ç«¯çš„ACKã€‚è€Œæˆ‘ä»¬çŸ¥é“ï¼ŒæœåŠ¡ç«¯åœ¨acceptä¹‹åï¼Œä¹Ÿæ˜¯åœ¨ç­‰å¾…ä¸­ã€‚</p><p>ç½‘ç»œåŒ…æ˜¯å¦‚ä½•æ¥æ”¶çš„å‘¢ï¼Ÿå¯¹äºè§£æçš„è¯¦ç»†è¿‡ç¨‹ï¼Œæˆ‘ä»¬ä¼šåœ¨ä¸‹ä¸‹èŠ‚è®²è§£ï¼Œè¿™é‡Œä¸ºäº†è§£æä¸‰æ¬¡æ¡æ‰‹ï¼Œæˆ‘ä»¬ç®€å•çš„çœ‹ç½‘ç»œåŒ…æ¥æ”¶åˆ°TCPå±‚åšçš„éƒ¨åˆ†äº‹æƒ…ã€‚</p><pre><code>static struct net_protocol tcp_protocol = {\n\t.early_demux\t=\ttcp_v4_early_demux,\n\t.early_demux_handler =  tcp_v4_early_demux,\n\t.handler\t=\ttcp_v4_rcv,\n\t.err_handler\t=\ttcp_v4_err,\n\t.no_policy\t=\t1,\n\t.netns_ok\t=\t1,\n\t.icmp_strict_tag_validation = 1,\n}\n</code></pre><p>æˆ‘ä»¬é€šè¿‡struct net_protocolç»“æ„ä¸­çš„handlerè¿›è¡Œæ¥æ”¶ï¼Œè°ƒç”¨çš„å‡½æ•°æ˜¯tcp_v4_rcvã€‚æ¥ä¸‹æ¥çš„è°ƒç”¨é“¾ä¸ºtcp_v4_rcv-&gt;tcp_v4_do_rcv-&gt;tcp_rcv_state_processã€‚tcp_rcv_state_processï¼Œé¡¾åæ€ä¹‰ï¼Œæ˜¯ç”¨æ¥å¤„ç†æ¥æ”¶ä¸€ä¸ªç½‘ç»œåŒ…åå¼•èµ·çŠ¶æ€å˜åŒ–çš„ã€‚</p><pre><code>int tcp_rcv_state_process(struct sock *sk, struct sk_buff *skb)\n{\n\tstruct tcp_sock *tp = tcp_sk(sk);\n\tstruct inet_connection_sock *icsk = inet_csk(sk);\n\tconst struct tcphdr *th = tcp_hdr(skb);\n\tstruct request_sock *req;\n\tint queued = 0;\n\tbool acceptable;\n\n\tswitch (sk-&gt;sk_state) {\n......\n\tcase TCP_LISTEN:\n......\n\t\tif (th-&gt;syn) {\n\t\t\tacceptable = icsk-&gt;icsk_af_ops-&gt;conn_request(sk, skb) &gt;= 0;\n\t\t\tif (!acceptable)\n\t\t\t\treturn 1;\n\t\t\tconsume_skb(skb);\n\t\t\treturn 0;\n\t\t}\n......\n}\n</code></pre><p>ç›®å‰æœåŠ¡ç«¯æ˜¯å¤„äºTCP_LISTENçŠ¶æ€çš„ï¼Œè€Œä¸”å‘è¿‡æ¥çš„åŒ…æ˜¯SYNï¼Œå› è€Œå°±æœ‰äº†ä¸Šé¢çš„ä»£ç ï¼Œè°ƒç”¨icsk-&gt;icsk_af_ops-&gt;conn_requestå‡½æ•°ã€‚struct inet_connection_sockå¯¹åº”çš„æ“ä½œæ˜¯inet_connection_sock_af_opsï¼ŒæŒ‰ç…§ä¸‹é¢çš„å®šä¹‰ï¼Œå…¶å®è°ƒç”¨çš„æ˜¯tcp_v4_conn_requestã€‚</p><pre><code>const struct inet_connection_sock_af_ops ipv4_specific = {\n        .queue_xmit        = ip_queue_xmit,\n        .send_check        = tcp_v4_send_check,\n        .rebuild_header    = inet_sk_rebuild_header,\n        .sk_rx_dst_set     = inet_sk_rx_dst_set,\n        .conn_request      = tcp_v4_conn_request,\n        .syn_recv_sock     = tcp_v4_syn_recv_sock,\n        .net_header_len    = sizeof(struct iphdr),\n        .setsockopt        = ip_setsockopt,\n        .getsockopt        = ip_getsockopt,\n        .addr2sockaddr     = inet_csk_addr2sockaddr,\n        .sockaddr_len      = sizeof(struct sockaddr_in),\n        .mtu_reduced       = tcp_v4_mtu_reduced,\n};\n</code></pre><p>tcp_v4_conn_requestä¼šè°ƒç”¨tcp_conn_requestï¼Œè¿™ä¸ªå‡½æ•°ä¹Ÿæ¯”è¾ƒé•¿ï¼Œé‡Œé¢è°ƒç”¨äº†send_synackï¼Œä½†å®é™…è°ƒç”¨çš„æ˜¯tcp_v4_send_synackã€‚å…·ä½“å‘é€çš„è¿‡ç¨‹æˆ‘ä»¬ä¸å»ç®¡å®ƒï¼Œçœ‹æ³¨é‡Šæˆ‘ä»¬èƒ½çŸ¥é“ï¼Œè¿™æ˜¯æ”¶åˆ°äº†SYNåï¼Œå›å¤ä¸€ä¸ªSYN-ACKï¼Œå›å¤å®Œæ¯•åï¼ŒæœåŠ¡ç«¯å¤„äºTCP_SYN_RECVã€‚</p><pre><code>int tcp_conn_request(struct request_sock_ops *rsk_ops,\n\t\t     const struct tcp_request_sock_ops *af_ops,\n\t\t     struct sock *sk, struct sk_buff *skb)\n{\n......\naf_ops-&gt;send_synack(sk, dst, &amp;fl, req, &amp;foc,\n\t\t\t\t    !want_cookie ? TCP_SYNACK_NORMAL :\n\t\t\t\t\t\t   TCP_SYNACK_COOKIE);\n......\n}\n\n/*\n *\tSend a SYN-ACK after having received a SYN.\n */\nstatic int tcp_v4_send_synack(const struct sock *sk, struct dst_entry *dst,\n\t\t\t      struct flowi *fl,\n\t\t\t      struct request_sock *req,\n\t\t\t      struct tcp_fastopen_cookie *foc,\n\t\t\t      enum tcp_synack_type synack_type)\n{......}\n</code></pre><p>è¿™ä¸ªæ—¶å€™ï¼Œè½®åˆ°å®¢æˆ·ç«¯æ¥æ”¶ç½‘ç»œåŒ…äº†ã€‚éƒ½æ˜¯TCPåè®®æ ˆï¼Œæ‰€ä»¥è¿‡ç¨‹å’ŒæœåŠ¡ç«¯æ²¡æœ‰å¤ªå¤šåŒºåˆ«ï¼Œè¿˜æ˜¯ä¼šèµ°åˆ°tcp_rcv_state_processå‡½æ•°çš„ï¼Œåªä¸è¿‡ç”±äºå®¢æˆ·ç«¯ç›®å‰å¤„äºTCP_SYN_SENTçŠ¶æ€ï¼Œå°±è¿›å…¥äº†ä¸‹é¢çš„ä»£ç åˆ†æ”¯ã€‚</p><pre><code>int tcp_rcv_state_process(struct sock *sk, struct sk_buff *skb)\n{\n\tstruct tcp_sock *tp = tcp_sk(sk);\n\tstruct inet_connection_sock *icsk = inet_csk(sk);\n\tconst struct tcphdr *th = tcp_hdr(skb);\n\tstruct request_sock *req;\n\tint queued = 0;\n\tbool acceptable;\n\n\tswitch (sk-&gt;sk_state) {\n......\n\tcase TCP_SYN_SENT:\n\t\ttp-&gt;rx_opt.saw_tstamp = 0;\n\t\ttcp_mstamp_refresh(tp);\n\t\tqueued = tcp_rcv_synsent_state_process(sk, skb, th);\n\t\tif (queued &gt;= 0)\n\t\t\treturn queued;\n\t\t/* Do step6 onward by hand. */\n\t\ttcp_urg(sk, skb, th);\n\t\t__kfree_skb(skb);\n\t\ttcp_data_snd_check(sk);\n\t\treturn 0;\n\t}\n......\n}\n</code></pre><p>tcp_rcv_synsent_state_processä¼šè°ƒç”¨tcp_send_ackï¼Œå‘é€ä¸€ä¸ªACK-ACKï¼Œå‘é€åå®¢æˆ·ç«¯å¤„äºTCP_ESTABLISHEDçŠ¶æ€ã€‚</p><p>åˆè½®åˆ°æœåŠ¡ç«¯æ¥æ”¶ç½‘ç»œåŒ…äº†ï¼Œæˆ‘ä»¬è¿˜æ˜¯å½’tcp_rcv_state_processå‡½æ•°å¤„ç†ã€‚ç”±äºæœåŠ¡ç«¯ç›®å‰å¤„äºçŠ¶æ€TCP_SYN_RECVçŠ¶æ€ï¼Œå› è€Œåˆèµ°äº†å¦å¤–çš„åˆ†æ”¯ã€‚å½“æ”¶åˆ°è¿™ä¸ªç½‘ç»œåŒ…çš„æ—¶å€™ï¼ŒæœåŠ¡ç«¯ä¹Ÿå¤„äºTCP_ESTABLISHEDçŠ¶æ€ï¼Œä¸‰æ¬¡æ¡æ‰‹ç»“æŸã€‚</p><pre><code>int tcp_rcv_state_process(struct sock *sk, struct sk_buff *skb)\n{\n\tstruct tcp_sock *tp = tcp_sk(sk);\n\tstruct inet_connection_sock *icsk = inet_csk(sk);\n\tconst struct tcphdr *th = tcp_hdr(skb);\n\tstruct request_sock *req;\n\tint queued = 0;\n\tbool acceptable;\n......\n\tswitch (sk-&gt;sk_state) {\n\tcase TCP_SYN_RECV:\n\t\tif (req) {\n\t\t\tinet_csk(sk)-&gt;icsk_retransmits = 0;\n\t\t\treqsk_fastopen_remove(sk, req, false);\n\t\t} else {\n\t\t\t/* Make sure socket is routed, for correct metrics. */\n\t\t\ticsk-&gt;icsk_af_ops-&gt;rebuild_header(sk);\n\t\t\ttcp_call_bpf(sk, BPF_SOCK_OPS_PASSIVE_ESTABLISHED_CB);\n\t\t\ttcp_init_congestion_control(sk);\n\n\t\t\ttcp_mtup_init(sk);\n\t\t\ttp-&gt;copied_seq = tp-&gt;rcv_nxt;\n\t\t\ttcp_init_buffer_space(sk);\n\t\t}\n\t\tsmp_mb();\n\t\ttcp_set_state(sk, TCP_ESTABLISHED);\n\t\tsk-&gt;sk_state_change(sk);\n\t\tif (sk-&gt;sk_socket)\n\t\t\tsk_wake_async(sk, SOCK_WAKE_IO, POLL_OUT);\n\t\ttp-&gt;snd_una = TCP_SKB_CB(skb)-&gt;ack_seq;\n\t\ttp-&gt;snd_wnd = ntohs(th-&gt;window) &lt;&lt; tp-&gt;rx_opt.snd_wscale;\n\t\ttcp_init_wl(tp, TCP_SKB_CB(skb)-&gt;seq);\n\t\tbreak;\n......\n}\n</code></pre><h2>æ€»ç»“æ—¶åˆ»</h2><p>è¿™ä¸€èŠ‚é™¤äº†ç½‘ç»œåŒ…çš„æ¥æ”¶å’Œå‘é€ï¼Œå…¶ä»–çš„ç³»ç»Ÿè°ƒç”¨æˆ‘ä»¬éƒ½åˆ†æåˆ°äº†ã€‚å¯ä»¥çœ‹å‡ºæ¥ï¼Œå®ƒä»¬æœ‰ä¸€ä¸ªç»Ÿä¸€çš„æ•°æ®ç»“æ„å’Œæµç¨‹ã€‚å…·ä½“å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/c0/d8/c028381cf45d65d3f148e57408d26bd8.png?wh=4903*2503\" alt=\"\"></p><p>é¦–å…ˆï¼ŒSocketç³»ç»Ÿè°ƒç”¨ä¼šæœ‰ä¸‰çº§å‚æ•°familyã€typeã€protocalï¼Œé€šè¿‡è¿™ä¸‰çº§å‚æ•°ï¼Œåˆ†åˆ«åœ¨net_proto_familyè¡¨ä¸­æ‰¾åˆ°typeé“¾è¡¨ï¼Œåœ¨typeé“¾è¡¨ä¸­æ‰¾åˆ°protocalå¯¹åº”çš„æ“ä½œã€‚è¿™ä¸ªæ“ä½œåˆ†ä¸ºä¸¤å±‚ï¼Œå¯¹äºTCPåè®®æ¥è®²ï¼Œç¬¬ä¸€å±‚æ˜¯inet_stream_opså±‚ï¼Œç¬¬äºŒå±‚æ˜¯tcp_protå±‚ã€‚</p><p>äºæ˜¯ï¼Œæ¥ä¸‹æ¥çš„ç³»ç»Ÿè°ƒç”¨è§„å¾‹å°±éƒ½ä¸€æ ·äº†ï¼š</p><ul>\n<li>bindç¬¬ä¸€å±‚è°ƒç”¨inet_stream_opsçš„inet_bindå‡½æ•°ï¼Œç¬¬äºŒå±‚è°ƒç”¨tcp_protçš„inet_csk_get_portå‡½æ•°ï¼›</li>\n<li>listenç¬¬ä¸€å±‚è°ƒç”¨inet_stream_opsçš„inet_listenå‡½æ•°ï¼Œç¬¬äºŒå±‚è°ƒç”¨tcp_protçš„inet_csk_get_portå‡½æ•°ï¼›</li>\n<li>acceptç¬¬ä¸€å±‚è°ƒç”¨inet_stream_opsçš„inet_acceptå‡½æ•°ï¼Œç¬¬äºŒå±‚è°ƒç”¨tcp_protçš„inet_csk_acceptå‡½æ•°ï¼›</li>\n<li>connectç¬¬ä¸€å±‚è°ƒç”¨inet_stream_opsçš„inet_stream_connectå‡½æ•°ï¼Œç¬¬äºŒå±‚è°ƒç”¨tcp_protçš„tcp_v4_connectå‡½æ•°ã€‚</li>\n</ul><h2>è¯¾å ‚ç»ƒä¹ </h2><p>TCPçš„ä¸‰æ¬¡æ¡æ‰‹åè®®éå¸¸é‡è¦ï¼Œè¯·ä½ åŠ¡å¿…è·Ÿç€ä»£ç èµ°è¯»ä¸€éã€‚å¦å¤–æˆ‘ä»¬è¿™é‡Œé‡ç‚¹å…³æ³¨äº†TCPçš„åœºæ™¯ï¼Œè¯·èµ°è¯»ä»£ç çš„æ—¶å€™ï¼Œä¹Ÿçœ‹ä¸€ä¸‹UDPæ˜¯å¦‚ä½•å®ç°å„å±‚çš„å‡½æ•°çš„ã€‚</p><p>æ¬¢è¿ç•™è¨€å’Œæˆ‘åˆ†äº«ä½ çš„ç–‘æƒ‘å’Œè§è§£ ï¼Œä¹Ÿæ¬¢è¿å¯ä»¥æ”¶è—æœ¬èŠ‚å†…å®¹ï¼Œåå¤ç ”è¯»ã€‚ä½ ä¹Ÿå¯ä»¥æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹ï¼Œå’Œä»–ä¸€èµ·å­¦ä¹ å’Œè¿›æ­¥ã€‚</p><p></p>","comments":[{"had_liked":false,"id":140002,"user_name":"å¥”è·‘çš„ç ä»”","can_delete":false,"product_type":"c1","uid":1609871,"ip_address":"","ucode":"AB3B02B07B8B8C","user_header":"https://static001.geekbang.org/account/avatar/00/18/90/8f/9c691a5f.jpg","comment_is_top":false,"comment_ctime":1570783314,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"48815423570","product_id":100024701,"comment_content":"struct tcp_sockç»§æ‰¿è‡ªstruct inet_connection_sock inet_connï¼Œinet_connection_sockç»§æ‰¿è‡ªstruct inet_sockï¼Œstruct inet_sockç»§æ‰¿è‡ªstruct sockï¼›<br><br>1.ä¸Šè¿°å››ä¸ªç»“æ„çš„å…³ç³»å…·æœ‰åè¶³çš„é¢å‘å¯¹è±¡çš„ç‰¹å¾ï¼Œstructæ˜¯åŸºç±»ï¼Œé€šè¿‡å±‚å±‚ç»§æ‰¿ï¼Œå®ç°äº†ç±»çš„å¤ç”¨ï¼›<br>2.å†…æ ¸ä¸­ç½‘ç»œç›¸å…³çš„å¾ˆå¤šå‡½æ•°ï¼Œå‚æ•°å¾€å¾€éƒ½æ˜¯struct sockï¼Œå‡½æ•°å†…éƒ¨ä¾ç…§ä¸åŒçš„ä¸šåŠ¡é€»è¾‘ï¼Œå°†struct sockè½¬æ¢ä¸ºä¸åŒçš„ä¸šåŠ¡ç»“æ„ï¼›<br>è¿™æ ·åšçš„å¥½å¤„ï¼š<br>1.ç®€åŒ–æ¥å£çš„è®¾è®¡å¤æ‚åº¦ï¼›<br>2.ä½¿ç”¨åŸºç±»ä½œä¸ºå‚æ•°ï¼Œååˆ†ç±»ä¼¼äºé¢å‘å¯¹è±¡ä¸­çš„å¤šæ€ç‰¹æ€§ï¼Œèƒ½å¤Ÿæœ‰æ•ˆçš„å¢å¼ºæ¥å£çš„ç¨³å®šæ€§ã€æå‡æ‰©å±•æ€§ã€‚","like_count":12},{"had_liked":false,"id":122376,"user_name":"è«å","can_delete":false,"product_type":"c1","uid":1007254,"ip_address":"","ucode":"E28F2602BA25DD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/5e/96/a03175bc.jpg","comment_is_top":false,"comment_ctime":1565352556,"is_pvip":false,"replies":[{"id":"46322","content":"èµ","user_name":"ä½œè€…å›å¤","comment_id":122376,"uid":"1001590","ip_address":"","utype":1,"ctime":1566288395,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"44515025516","product_id":100024701,"comment_content":"çœ‹äº†ä¸€éï¼Œç„¶åèŠ±äº†ä¸€å¤©æŠŠæºç åˆè¿‡äº†ä¸€éï¼Œå¾ˆæœ‰æ”¶è´§ï¼Œå¯¹socketçš„ç†è§£ä¸å†æµ®äºè¡¨é¢ã€‚","like_count":11,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":462226,"discussion_content":"èµ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566288395,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":154740,"user_name":"è°›å¬","can_delete":false,"product_type":"c1","uid":1228687,"ip_address":"","ucode":"7539D5B06662EA","user_header":"https://static001.geekbang.org/account/avatar/00/12/bf/8f/51f044dc.jpg","comment_is_top":false,"comment_ctime":1574527355,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"18754396539","product_id":100024701,"comment_content":"socket: æ ¹æ®å‚æ•°åˆ›å»ºç›¸åº”socket<br>bind: ç»‘å®šIPã€ç«¯å£<br>listen: å»ºç«‹ä¸¤ä¸ªé˜Ÿåˆ—ï¼Œæ”¹å˜çŠ¶æ€ä¸ºTCP_LISTEN<br>accept: ä»å®Œæˆä¸‰æ¬¡æ¡æ‰‹çš„é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªsocketï¼Œæ²¡æœ‰çš„è¯è®©å‡ºcpu<br>connect: ä¸‰æ¬¡æ¡æ‰‹<br>","like_count":5},{"had_liked":false,"id":113542,"user_name":"kkxue","can_delete":false,"product_type":"c1","uid":1159904,"ip_address":"","ucode":"0DCB861D5543D6","user_header":"https://static001.geekbang.org/account/avatar/00/11/b2/e0/bf56878a.jpg","comment_is_top":false,"comment_ctime":1563074033,"is_pvip":true,"replies":[{"id":"46630","content":"å¯¹çš„ï¼Œè¿™æ˜¯ä¸€ä¸ªå¥½æ–¹æ³•","user_name":"ä½œè€…å›å¤","comment_id":113542,"uid":"1001590","ip_address":"","utype":1,"ctime":1566369154,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":5,"score":"14447975921","product_id":100024701,"comment_content":"åŸæ¥å¾—å…ˆçœ‹æ€»ç»“å›¾ï¼Œå†çœ‹å†…å®¹ã€‚ã€‚","like_count":4,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":458269,"discussion_content":"å¯¹çš„ï¼Œè¿™æ˜¯ä¸€ä¸ªå¥½æ–¹æ³•","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566369154,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":111754,"user_name":"W.jyao","can_delete":false,"product_type":"c1","uid":1422582,"ip_address":"","ucode":"C57B3A78B6A795","user_header":"https://static001.geekbang.org/account/avatar/00/15/b4/f6/735673f7.jpg","comment_is_top":false,"comment_ctime":1562594161,"is_pvip":false,"replies":[{"id":"46734","content":"ä¸€ä¸ªæœåŠ¡ç«¯å£å½“ç„¶ä¸€æ ·å‘€ã€‚åªä¸è¿‡ä¸¤ä¸ªsocketæ•°æ®ç»“æ„è€Œå·²","user_name":"ä½œè€…å›å¤","comment_id":111754,"uid":"1001590","ip_address":"","utype":1,"ctime":1566387349,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"10152528753","product_id":100024701,"comment_content":"è€å¸ˆï¼Œèƒ½è§£é‡Šä¸‹listenfdå’Œacceptfdçš„ç«¯å£ä¸ºä»€ä¹ˆä¸€æ ·å—ï¼Ÿ","like_count":3,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457436,"discussion_content":"ä¸€ä¸ªæœåŠ¡ç«¯å£å½“ç„¶ä¸€æ ·å‘€ã€‚åªä¸è¿‡ä¸¤ä¸ªsocketæ•°æ®ç»“æ„è€Œå·²","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566387349,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":138007,"user_name":"Spring","can_delete":false,"product_type":"c1","uid":1222211,"ip_address":"","ucode":"8175463FB4705B","user_header":"https://static001.geekbang.org/account/avatar/00/12/a6/43/cb6ab349.jpg","comment_is_top":false,"comment_ctime":1569979371,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5864946667","product_id":100024701,"comment_content":"è€å¸ˆï¼Œè¯·é—®æœåŠ¡ç«¯ç»´æŠ¤çš„æœªå®Œå…¨å»ºç«‹é“¾æ¥é˜Ÿåˆ—çš„å…ƒç´ sockæ˜¯ä»€ä¹ˆæ—¶å€™åˆ›å»ºçš„å‘¢ï¼Ÿæ˜¯æ¯æ¬¡æ”¶åˆ°å®¢æˆ·ç«¯çš„SYNåŒ…ååˆ›å»ºï¼Ÿè¿˜æ˜¯listenæ—¶ä¼šåˆå§‹åŒ–å‡ ä¸ªsockï¼Ÿ","like_count":1},{"had_liked":false,"id":125410,"user_name":"æ— å¿ƒä¹‹ç¦","can_delete":false,"product_type":"c1","uid":1462095,"ip_address":"","ucode":"88D1EC33473247","user_header":"https://static001.geekbang.org/account/avatar/00/16/4f/4f/f8868b94.jpg","comment_is_top":false,"comment_ctime":1566180711,"is_pvip":false,"replies":[{"id":"46260","content":"å¯¹çš„ï¼Œçœ‹ä¸€ä¸‹SYSCALL_DEFINE3è¿™ä¸ªå®çš„å®šä¹‰å°±ç†è§£äº†","user_name":"ä½œè€…å›å¤","comment_id":125410,"uid":"1001590","ip_address":"","utype":1,"ctime":1566280288,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":2,"race_medal":0,"score":"5861148007","product_id":100024701,"comment_content":"å¼€å¤´çš„é‚£ä¸ªä»£ç çš„ é€—å·åŠ çš„ä¸å¯¹å§ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":463566,"discussion_content":"å¯¹çš„ï¼Œçœ‹ä¸€ä¸‹SYSCALL_DEFINE3è¿™ä¸ªå®çš„å®šä¹‰å°±ç†è§£äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566280288,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1462095,"avatar":"https://static001.geekbang.org/account/avatar/00/16/4f/4f/f8868b94.jpg","nickname":"æ— å¿ƒä¹‹ç¦","note":"","ucode":"88D1EC33473247","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":5457,"discussion_content":"å¥½çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566284549,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":240406,"user_name":"Geek_ty","can_delete":false,"product_type":"c1","uid":1587280,"ip_address":"","ucode":"F8178B6B09D628","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epZhOmpZpicOzalVU7kibd59dMJc25N9cfGu9icBAIUPzYNYDedtzlYHZBiazaYiadgqvlotrjM4CA6KOQ/132","comment_is_top":false,"comment_ctime":1596891711,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1596891711","product_id":100024701,"comment_content":"è€å¸ˆæ‚¨å¥½ï¼Œæˆ‘åœ¨è®¤çœŸé˜…è¯»äº†æ–‡ç« å’Œä»£ç åè¿˜æ˜¯å­˜åœ¨ä¸€ä¸ªç–‘æƒ‘ï¼šicsk_accept_queueæ˜¯å…¨è¿æ¥é˜Ÿåˆ—å½“ç„¶æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯æœåŠ¡ç«¯LISTENçŠ¶æ€ä¸‹ï¼Œè°ƒç”¨tcp_v4_conn_request()æ—¶inet_csk_reqsk_queue_hash_add()å‡½æ•°ä¹Ÿæ˜¯å¢åŠ äº†è¯¥é˜Ÿåˆ—çš„é•¿åº¦ã€‚ä½†æ˜¯å®é™…ä¸Šåº”è¯¥ä¿®æ”¹çš„æ—¶åŠè¿æ¥é˜Ÿåˆ—æ‰å¯¹ã€‚æˆ‘åå¤çœ‹äº†å‡ éæºç ï¼Œæ²¡æœ‰å‘ç°åœ¨ä»€ä¹ˆåœ°æ–¹æœ‰ä¿å­˜syné˜Ÿåˆ—ï¼Œä¹Ÿæ²¡æœ‰syné˜Ÿåˆ—çš„ç›¸å…³æ“ä½œï¼Œéƒ½æ˜¯å¯¹icsk_accept_queueçš„æ“ä½œï¼Œè¿™è®©æˆ‘ååˆ†å›°æƒ‘ï¼Œè¿˜è¯·è€å¸ˆå¸®å¿™è§£ç­”ã€‚","like_count":1},{"had_liked":false,"id":213593,"user_name":"bookå°¾æ±","can_delete":false,"product_type":"c1","uid":1446375,"ip_address":"","ucode":"AE2B8DFC643ACC","user_header":"https://static001.geekbang.org/account/avatar/00/16/11/e7/044a9a6c.jpg","comment_is_top":false,"comment_ctime":1588485428,"is_pvip":true,"replies":[{"id":"83779","content":"ç›‘å¬çš„ç«¯å£å·","user_name":"ä½œè€…å›å¤","comment_id":213593,"uid":"1001590","ip_address":"","utype":1,"ctime":1592359199,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":2,"race_medal":0,"score":"1588485428","product_id":100024701,"comment_content":"è°ƒç”¨acceptçš„æ—¶å€™,ä¼šæ–°å»ºä¸€ä¸ªsocket,ä»¥åŠå…¶å¯¹åº”çš„struct file,ç„¶åä¼šä»icsk_accept_queue å–å‡ºä¸€ä¸ªreq,å°†å…¶skèµ‹å€¼ç»™æ–°å»ºçš„socket-&gt;sk,è¿™æ ·å°±å¯ä»¥è¯»å–åˆ°è¯·æ±‚çš„æ•°æ®äº†,ä¸ç†è§£çš„æ˜¯åé¢è®²åˆ°æ¥æ”¶æ•°æ®åŒ…æ—¶tcpå±‚æœ‰ä¸‰ä¸ªé˜Ÿåˆ—,ä¼šæ ¹æ®å†…æ ¸ä½å»¶æ—¶ é«˜ååé‡çš„ç­‰ç­–ç•¥ä»¥åŠsocketå½“æ—¶çš„çŠ¶æ€æ¥å†³å®šæ”¾å…¥å“ªä¸ªé˜Ÿåˆ—,è¿™é‡Œçš„socketæ˜¯æ€ä¹ˆé€‰å‡ºæ¥çš„å•Š,æ•°æ®åŒ…æ˜¯å…ˆå‘é€åˆ°å¤„äºç›‘å¬é˜Ÿåˆ—çš„socketç„¶åç”±å…¶å°†æ•°æ®åˆ†å‘åˆ°å…¶é€šè¿‡acceptç”Ÿæˆçš„sokcetä¸Šå—,å¦‚æœæ˜¯ç›´æ¥ç”±é€šè¿‡acceptç”Ÿæˆçš„socketæ¥å¤„ç†,æ€ä¹ˆåˆ†è¾¨å‡ºæ¥åˆ°åº•è¯¥ç»™å“ªä¸ªsocketå‘¢,æ ¹æ®æ•°æ®åŒ…çš„æºåœ°å€ä¸ç«¯å£å—?","like_count":0,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493819,"discussion_content":"ç›‘å¬çš„ç«¯å£å·","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592359199,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1114352,"avatar":"https://static001.geekbang.org/account/avatar/00/11/00/f0/fe94061e.jpg","nickname":"å‡è£…åœ¨å…»ğŸ·","note":"","ucode":"D0AB9CD03E0D5B","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":574123,"discussion_content":"æ˜¯ä¸æ˜¯å¯ä»¥ç†è§£ä¸ºï¼Œnew socket è´Ÿè´£å¤„ç†æ•°æ®ï¼ˆæ‰“åŒ…ã€çª—å£æ§åˆ¶ç­‰ï¼‰ï¼Œä½†æ˜¯çœŸå®çš„æ•°æ®å‡ºå£è¿˜æ˜¯è¦é€šè¿‡ç›‘å¬çš„socketå‡ºå»ï¼Ÿå¦‚æœä¸æ˜¯çš„è¯ï¼ŒçœŸå®çš„æ•°æ®æ˜¯æ€ä¹ˆå‘é€å‡ºå»çš„å‘¢ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1653837377,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":111364,"user_name":"é£ç¿”","can_delete":false,"product_type":"c1","uid":1068571,"ip_address":"","ucode":"65AF6AF292DAD6","user_header":"https://static001.geekbang.org/account/avatar/00/10/4e/1b/f4b786b9.jpg","comment_is_top":false,"comment_ctime":1562548150,"is_pvip":true,"replies":[{"id":"46743","content":"è¯¦è§ç½‘ç»œåŒ…çš„æ ¼å¼ï¼ŒTCPå¤´é‡Œé¢æœ‰syn","user_name":"ä½œè€…å›å¤","comment_id":111364,"uid":"1001590","ip_address":"","utype":1,"ctime":1566387771,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":3,"race_medal":0,"score":"1562548150","product_id":100024701,"comment_content":"synåˆ°åº•æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿å‘€ï¼Ÿæ˜¯ä¸ªintegerè¿˜æ˜¯charç±»å‹","like_count":0,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457319,"discussion_content":"è¯¦è§ç½‘ç»œåŒ…çš„æ ¼å¼ï¼ŒTCPå¤´é‡Œé¢æœ‰syn","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566387771,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1508990,"avatar":"https://static001.geekbang.org/account/avatar/00/17/06/7e/735968e2.jpg","nickname":"è¥¿é—¨å¹ç‰›","note":"","ucode":"E5D3624DDE1E83","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":379652,"discussion_content":"è¡¨ç¤ºå‘èµ·ä¸‰æ¬¡æ¡æ‰‹çš„è¿æ¥","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1624038527,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1101660,"avatar":"https://static001.geekbang.org/account/avatar/00/10/cf/5c/d4e19eb6.jpg","nickname":"å®‰å°ä¾","note":"","ucode":"A5C414C7B994FF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":2032,"discussion_content":"ä¸€ä¸ª bit ä½","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563189649,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":111302,"user_name":"äºŒæ˜Ÿçƒ","can_delete":false,"product_type":"c1","uid":1111552,"ip_address":"","ucode":"89EC5FEB98E7CE","user_header":"https://static001.geekbang.org/account/avatar/00/10/f6/00/2a248fd8.jpg","comment_is_top":false,"comment_ctime":1562542979,"is_pvip":false,"replies":[{"id":"46744","content":"RPCæ˜¯åº”ç”¨å±‚çš„ï¼Œéœ€è¦åº”ç”¨å±‚è‡ªå·±ä¿è¯è¯·æ±‚å’Œç»“æœçš„å¯¹åº”ã€‚","user_name":"ä½œè€…å›å¤","comment_id":111302,"uid":"1001590","ip_address":"","utype":1,"ctime":1566387851,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":2,"race_medal":0,"score":"1562542979","product_id":100024701,"comment_content":"è€å¸ˆå¥½ï¼ŒåŒä¸€ä¸ªTCPé“¾æ¥ä¸Šå…ˆåå‘é€2æ¬¡rpcè¯·æ±‚ï¼Œåå‘é€çš„è¯·æ±‚å…¶ç»“æœå…ˆè¿”å›ï¼Œå…ˆå‘é€çš„è¯·æ±‚ç»“æœåè¿”å›ï¼Œè¿™æ ·æœ‰æ²¡æœ‰é—®é¢˜å‘¢ï¼Œç³»ç»Ÿèƒ½åŒºåˆ†å„è‡ªçš„è¿”å›ç»“æœä¹ˆï¼Œé ä»€ä¹ˆæœºåˆ¶ä¿è¯çš„å‘¢ï¼Ÿä¸€ç›´æ²¡æœ‰æƒ³æ˜ç™½","like_count":0,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457299,"discussion_content":"RPCæ˜¯åº”ç”¨å±‚çš„ï¼Œéœ€è¦åº”ç”¨å±‚è‡ªå·±ä¿è¯è¯·æ±‚å’Œç»“æœçš„å¯¹åº”ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566387851,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1508990,"avatar":"https://static001.geekbang.org/account/avatar/00/17/06/7e/735968e2.jpg","nickname":"è¥¿é—¨å¹ç‰›","note":"","ucode":"E5D3624DDE1E83","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":379653,"discussion_content":"RPC æœ‰è‡ªå·±çš„åº”ç”¨å±‚åè®®ï¼Œæ˜¯æœ‰çŠ¶æ€çš„ï¼Œæ¯”å¦‚ç”¨ä¸ªidåŒºåˆ†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1624038579,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}