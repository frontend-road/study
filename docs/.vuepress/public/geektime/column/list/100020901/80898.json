{"id":80898,"title":"33 | 关于 Linux 网络，你必须知道这些（上）","content":"<p>你好，我是倪朋飞。</p><p>前几节，我们一起学习了文件系统和磁盘 I/O 的工作原理，以及相应的性能分析和优化方法。接下来，我们将进入下一个重要模块—— Linux 的网络子系统。</p><p>由于网络处理的流程最复杂，跟我们前面讲到的进程调度、中断处理、内存管理以及 I/O 等都密不可分，所以，我把网络模块作为最后一个资源模块来讲解。</p><p>同 CPU、内存以及 I/O 一样，网络也是 Linux 系统最核心的功能。网络是一种把不同计算机或网络设备连接到一起的技术，它本质上是一种进程间通信方式，特别是跨系统的进程间通信，必须要通过网络才能进行。随着高并发、分布式、云计算、微服务等技术的普及，网络的性能也变得越来越重要。</p><p>那么，Linux 网络又是怎么工作的呢？又有哪些指标衡量网络的性能呢？接下来的两篇文章，我将带你一起学习 Linux 网络的工作原理和性能指标。</p><h2>网络模型</h2><p>说到网络，我想你肯定经常提起七层负载均衡、四层负载均衡，或者三层设备、二层设备等等。那么，这里说的二层、三层、四层、七层又都是什么意思呢？</p><p>实际上，这些层都来自国际标准化组织制定的<strong>开放式系统互联通信参考模型</strong>（Open System Interconnection Reference Model），简称为 OSI 网络模型。</p><!-- [[[read_end]]] --><p>为了解决网络互联中异构设备的兼容性问题，并解耦复杂的网络包处理流程，OSI 模型把网络互联的框架分为应用层、表示层、会话层、传输层、网络层、数据链路层以及物理层等七层，每个层负责不同的功能。其中，</p><ul>\n<li>\n<p>应用层，负责为应用程序提供统一的接口。</p>\n</li>\n<li>\n<p>表示层，负责把数据转换成兼容接收系统的格式。</p>\n</li>\n<li>\n<p>会话层，负责维护计算机之间的通信连接。</p>\n</li>\n<li>\n<p>传输层，负责为数据加上传输表头，形成数据包。</p>\n</li>\n<li>\n<p>网络层，负责数据的路由和转发。</p>\n</li>\n<li>\n<p>数据链路层，负责MAC寻址、错误侦测和改错。</p>\n</li>\n<li>\n<p>物理层，负责在物理网络中传输数据帧。</p>\n</li>\n</ul><p>但是 OSI 模型还是太复杂了，也没能提供一个可实现的方法。所以，在 Linux 中，我们实际上使用的是另一个更实用的四层模型，即 TCP/IP 网络模型。</p><p>TCP/IP 模型，把网络互联的框架分为应用层、传输层、网络层、网络接口层等四层，其中，</p><ul>\n<li>\n<p>应用层，负责向用户提供一组应用程序，比如 HTTP、FTP、DNS 等。</p>\n</li>\n<li>\n<p>传输层，负责端到端的通信，比如 TCP、UDP 等。</p>\n</li>\n<li>\n<p>网络层，负责网络包的封装、寻址和路由，比如 IP、ICMP 等。</p>\n</li>\n<li>\n<p>网络接口层，负责网络包在物理网络中的传输，比如 MAC 寻址、错误侦测以及通过网卡传输网络帧等。</p>\n</li>\n</ul><p>为了帮你更形象理解TCP/IP 与 OSI 模型的关系，我画了一张图，如下所示：</p><p><img src=\"https://static001.geekbang.org/resource/image/f2/bd/f2dbfb5500c2aa7c47de6216ee7098bd.png?wh=591*521\" alt=\"\"></p><p>当然了，虽说 Linux 实际按照 TCP/IP 模型，实现了网络协议栈，但在平时的学习交流中，我们习惯上还是用 OSI 七层模型来描述。比如，说到七层和四层负载均衡，对应的分别是 OSI 模型中的应用层和传输层（而它们对应到 TCP/IP 模型中，实际上是四层和三层）。</p><p>TCP/IP 模型包括了大量的网络协议，这些协议的原理，也是我们每个人必须掌握的核心基础知识。如果你不太熟练，推荐你去学《TCP/IP 详解》的卷一和卷二，或者学习极客时间出品的《<a href=\"https://time.geekbang.org/course/intro/85\">趣谈网络协议</a>》专栏。</p><h2>Linux网络栈</h2><p>有了 TCP/IP 模型后，在进行网络传输时，数据包就会按照协议栈，对上一层发来的数据进行逐层处理；然后封装上该层的协议头，再发送给下一层。</p><p>当然，网络包在每一层的处理逻辑，都取决于各层采用的网络协议。比如在应用层，一个提供 REST API 的应用，可以使用 HTTP 协议，把它需要传输的 JSON 数据封装到 HTTP 协议中，然后向下传递给 TCP 层。</p><p>而封装做的事情就很简单了，只是在原来的负载前后，增加固定格式的元数据，原始的负载数据并不会被修改。</p><p>比如，以通过 TCP 协议通信的网络包为例，通过下面这张图，我们可以看到，应用程序数据在每个层的封装格式。</p><p><img src=\"https://static001.geekbang.org/resource/image/c8/79/c8dfe80acc44ba1aa9df327c54349e79.png?wh=525*254\" alt=\"\"></p><p>其中：</p><ul>\n<li>\n<p>传输层在应用程序数据前面增加了 TCP 头；</p>\n</li>\n<li>\n<p>网络层在 TCP 数据包前增加了 IP 头；</p>\n</li>\n<li>\n<p>而网络接口层，又在 IP 数据包前后分别增加了帧头和帧尾。</p>\n</li>\n</ul><p>这些新增的头部和尾部，都按照特定的协议格式填充，想了解具体格式，你可以查看协议的文档。 比如，你可以查看<a href=\"https://zh.wikipedia.org/wiki/%E4%BC%A0%E8%BE%93%E6%8E%A7%E5%88%B6%E5%8D%8F%E8%AE%AE#%E5%B0%81%E5%8C%85%E7%B5%90%E6%A7%8B\">这里</a>，了解 TCP 头的格式。</p><p>这些新增的头部和尾部，增加了网络包的大小，但我们都知道，物理链路中并不能传输任意大小的数据包。网络接口配置的最大传输单元（MTU），就规定了最大的 IP 包大小。在我们最常用的以太网中，MTU 默认值是 1500（这也是 Linux 的默认值）。</p><p>一旦网络包超过 MTU 的大小，就会在网络层分片，以保证分片后的 IP 包不大于MTU 值。显然，MTU 越大，需要的分包也就越少，自然，网络吞吐能力就越好。</p><p>理解了 TCP/IP 网络模型和网络包的封装原理后，你很容易能想到，Linux 内核中的网络栈，其实也类似于 TCP/IP 的四层结构。如下图所示，就是 Linux 通用 IP 网络栈的示意图：</p><p><img src=\"https://static001.geekbang.org/resource/image/c7/ac/c7b5b16539f90caabb537362ee7c27ac.png?wh=1092*1316\" alt=\"\"></p><p>（图片参考《性能之巅》图 10.7 通用 IP 网络栈绘制）</p><p>我们从上到下来看这个网络栈，你可以发现，</p><ul>\n<li>\n<p>最上层的应用程序，需要通过系统调用，来跟套接字接口进行交互；</p>\n</li>\n<li>\n<p>套接字的下面，就是我们前面提到的传输层、网络层和网络接口层；</p>\n</li>\n<li>\n<p>最底层，则是网卡驱动程序以及物理网卡设备。</p>\n</li>\n</ul><p>这里我简单说一下网卡。网卡是发送和接收网络包的基本设备。在系统启动过程中，网卡通过内核中的网卡驱动程序注册到系统中。而在网络收发过程中，内核通过中断跟网卡进行交互。</p><p>再结合前面提到的 Linux 网络栈，可以看出，网络包的处理非常复杂。所以，网卡硬中断只处理最核心的网卡数据读取或发送，而协议栈中的大部分逻辑，都会放到软中断中处理。</p><h2>Linux网络收发流程</h2><p>了解了 Linux 网络栈后，我们再来看看， Linux 到底是怎么收发网络包的。</p><blockquote>\n<p>注意，以下内容都以物理网卡为例。事实上，Linux 还支持众多的虚拟网络设备，而它们的网络收发流程会有一些差别。</p>\n</blockquote><h3>网络包的接收流程</h3><p>我们先来看网络包的接收流程。</p><p>当一个网络帧到达网卡后，网卡会通过 DMA 方式，把这个网络包放到收包队列中；然后通过硬中断，告诉中断处理程序已经收到了网络包。</p><p>接着，网卡中断处理程序会为网络帧分配内核数据结构（sk_buff），并将其拷贝到 sk_buff 缓冲区中；然后再通过软中断，通知内核收到了新的网络帧。</p><p>接下来，内核协议栈从缓冲区中取出网络帧，并通过网络协议栈，从下到上逐层处理这个网络帧。比如，</p><ul>\n<li>\n<p>在链路层检查报文的合法性，找出上层协议的类型（比如 IPv4 还是 IPv6），再去掉帧头、帧尾，然后交给网络层。</p>\n</li>\n<li>\n<p>网络层取出 IP 头，判断网络包下一步的走向，比如是交给上层处理还是转发。当网络层确认这个包是要发送到本机后，就会取出上层协议的类型（比如 TCP 还是 UDP），去掉 IP 头，再交给传输层处理。</p>\n</li>\n<li>\n<p>传输层取出 TCP 头或者 UDP 头后，根据 &lt;源 IP、源端口、目的 IP、目的端口&gt; 四元组作为标识，找出对应的 Socket，并把数据拷贝到 Socket 的接收缓存中。</p>\n</li>\n</ul><p>最后，应用程序就可以使用 Socket 接口，读取到新接收到的数据了。</p><p>为了更清晰表示这个流程，我画了一张图，这张图的左半部分表示接收流程，而图中的粉色箭头则表示网络包的处理路径。</p><p><img src=\"https://static001.geekbang.org/resource/image/3a/65/3af644b6d463869ece19786a4634f765.png?wh=1826*1118\" alt=\"\"></p><h3>网络包的发送流程</h3><p>了解网络包的接收流程后，就很容易理解网络包的发送流程。网络包的发送流程就是上图的右半部分，很容易发现，网络包的发送方向，正好跟接收方向相反。</p><p>首先，应用程序调用 Socket API（比如 sendmsg）发送网络包。</p><p>由于这是一个系统调用，所以会陷入到内核态的套接字层中。套接字层会把数据包放到 Socket 发送缓冲区中。</p><p>接下来，网络协议栈从 Socket 发送缓冲区中，取出数据包；再按照 TCP/IP 栈，从上到下逐层处理。比如，传输层和网络层，分别为其增加 TCP 头和 IP 头，执行路由查找确认下一跳的 IP，并按照 MTU 大小进行分片。</p><p>分片后的网络包，再送到网络接口层，进行物理地址寻址，以找到下一跳的 MAC 地址。然后添加帧头和帧尾，放到发包队列中。这一切完成后，会有软中断通知驱动程序：发包队列中有新的网络帧需要发送。</p><p>最后，驱动程序通过 DMA ，从发包队列中读出网络帧，并通过物理网卡把它发送出去。</p><h2><strong>小结</strong></h2><p>在今天的文章中，我带你一起梳理了 Linux 网络的工作原理。</p><p>多台服务器通过网卡、交换机、路由器等网络设备连接到一起，构成了相互连接的网络。由于网络设备的异构性和网络协议的复杂性，国际标准化组织定义了一个七层的 OSI 网络模型，但是这个模型过于复杂，实际工作中的事实标准，是更为实用的 TCP/IP 模型。</p><p>TCP/IP 模型，把网络互联的框架，分为应用层、传输层、网络层、网络接口层等四层，这也是 Linux 网络栈最核心的构成部分。</p><ul>\n<li>\n<p>应用程序通过套接字接口发送数据包，先要在网络协议栈中从上到下进行逐层处理，最终再送到网卡发送出去。</p>\n</li>\n<li>\n<p>而接收时，同样先经过网络栈从下到上的逐层处理，最终才会送到应用程序。</p>\n</li>\n</ul><p>了解了Linux 网络的基本原理和收发流程后，你肯定迫不及待想知道，如何去观察网络的性能情况。那么，具体来说，哪些指标可以衡量 Linux 的网络性能呢？别急，我将在下一节中为你详细讲解。</p><h2>思考</h2><p>最后，我想请你来聊聊你所理解的 Linux 网络。你碰到过哪些网络相关的性能瓶颈？你又是怎么样来分析它们的呢？你可以结合今天学到的网络知识，提出自己的观点。</p><p>欢迎在留言区和我讨论，也欢迎你把这篇文章分享给你的同事、朋友。我们一起在实战中演练，在交流中进步。</p><p></p>","neighbors":{"left":{"article_title":"32 | 答疑（四）：阻塞、非阻塞 I/O 与同步、异步 I/O 的区别和联系","id":79734},"right":{"article_title":"34 | 关于 Linux 网络，你必须知道这些（下）","id":81057}},"comments":[{"had_liked":false,"id":73744,"user_name":"渡渡鸟_linux","can_delete":false,"product_type":"c1","uid":1227772,"ip_address":"","ucode":"099BB11A3201D3","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83ernR4NKI5tejJAV3HMTF3gszBBUAjkjLO2QYic2gx5dMGelFv4LWibib7CUGexmMcMp5HiaaibmOH3dyHg/132","comment_is_top":false,"comment_ctime":1551967277,"is_pvip":false,"replies":[{"id":"27325","content":"对的","user_name":"作者回复","comment_id":73744,"uid":"1001282","ip_address":"","utype":1,"ctime":1552348419,"user_name_real":"倪朋飞"}],"discussion_count":8,"race_medal":0,"score":"366624187437","product_id":100020901,"comment_content":"我结合网络上查阅的资料和文章中的内容，总结了下网卡收发报文的过程，不知道是否正确：<br>1. 内核分配一个主内存地址段（DMA缓冲区)，网卡设备可以在DMA缓冲区中读写数据<br>2. 当来了一个网络包，网卡将网络包写入DMA缓冲区，写完后通知CPU产生硬中断<br>3. 硬中断处理程序锁定当前DMA缓冲区，然后将网络包拷贝到另一块内存区，清空并解锁当前DMA缓冲区，然后通知软中断去处理网络包。<br>-----<br>当发送数据包时，与上述相反。链路层将数据包封装完毕后，放入网卡的DMA缓冲区，并调用系统硬中断，通知网卡从缓冲区读取并发送数据。<br>","like_count":85,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":442257,"discussion_content":"对的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1552348419,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2689623,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/2Iw3M4Myq6G3TO1BQExJP9JKtazBEfptXhG1WcMsnZSWRyiaXCeq0NibsWmmerJVRSpybhfezib8pBGlowlR2wg2A/132","nickname":"Geek9772","note":"","ucode":"A5E059C92D9950","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":560012,"discussion_content":"CPU确认设备完好---&gt;DMA预处理（设置设备地址，内存地址，传输数据个数，命令）----&gt;CPU去做其他事----&gt;外设准备好，发出DMA请求----&gt;DMA发出总线请求，申请使用系统总线----&gt;DMA获得总线后，开始进行内存和IO之间的数据交换---&gt;DMA数据传输完毕，向CPU发送中断请求----&gt;CPU执行中断服务程序","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1649122805,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1487584,"avatar":"https://static001.geekbang.org/account/avatar/00/16/b2/e0/d856f5a4.jpg","nickname":"鱼","note":"","ucode":"89EC9CE3AD0281","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":349186,"discussion_content":"网卡发送数据过程中，还有硬中断的逻辑吗？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1612953374,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1136959,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epNoWjGv759Dn3v4kkRhUGr2wN48VwMdIDrH6q1XYHqmia21iaRqekQNslUefPyfsylnSeLnEuhBwdw/132","nickname":"shupian416","note":"","ucode":"4DC22BCF5C5414","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1487584,"avatar":"https://static001.geekbang.org/account/avatar/00/16/b2/e0/d856f5a4.jpg","nickname":"鱼","note":"","ucode":"89EC9CE3AD0281","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":373259,"discussion_content":"是不是软中断阿？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620661645,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":349186,"ip_address":""},"score":373259,"extra":""},{"author":{"id":1134694,"avatar":"https://static001.geekbang.org/account/avatar/00/11/50/66/047ee060.jpg","nickname":"Return12321","note":"","ucode":"F7A3C5ED02E1D9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1487584,"avatar":"https://static001.geekbang.org/account/avatar/00/16/b2/e0/d856f5a4.jpg","nickname":"鱼","note":"","ucode":"89EC9CE3AD0281","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":380549,"discussion_content":"也很疑惑此处到底是硬中断还是软中断？按照文章所写，硬中断处理接受和发送","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1624551059,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":349186,"ip_address":""},"score":380549,"extra":""}]},{"author":{"id":2608728,"avatar":"https://static001.geekbang.org/account/avatar/00/27/ce/58/71ed845f.jpg","nickname":"Dexter","note":"","ucode":"909CABC4AC4AC9","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":586492,"discussion_content":"这个DMA的缓冲区，是不是网卡的ring buffer?","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662256572,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"上海"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1805809,"avatar":"","nickname":"ccz 开发(谢不邀)","note":"","ucode":"B8803B050AAC68","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":387869,"discussion_content":"请问下，硬中断没处理完，另一个数据包来到网卡，会不会丢失？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628480748,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1016905,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/84/49/47d48fd0.jpg","nickname":"观弈道人","note":"","ucode":"F3BB619A33C605","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":60485,"discussion_content":"应该是网络包到了之后，才分配DMA缓冲区","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574733484,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":70606,"user_name":"安排","can_delete":false,"product_type":"c1","uid":1260026,"ip_address":"","ucode":"F78CFA9624CAEF","user_header":"https://static001.geekbang.org/account/avatar/00/13/39/fa/a7edbc72.jpg","comment_is_top":false,"comment_ctime":1551145968,"is_pvip":false,"replies":[{"id":"26296","content":"问题比较多，放到答疑篇里面统一回复吧","user_name":"作者回复","comment_id":70606,"uid":"1001282","ip_address":"","utype":1,"ctime":1551702265,"user_name_real":"倪朋飞"}],"discussion_count":1,"race_medal":0,"score":"130400164848","product_id":100020901,"comment_content":"当一个网络帧到达网卡后，网卡会通过 DMA 方式，把这个网络包放到收包队列中；然后通过硬中断，告诉中断处理程序已经收到了网络包。<br><br>接着，网卡中断处理程序会为网络帧分配内核数据结构（sk_buff），并将其拷贝到 sk_buff 缓冲区中；然后再通过软中断，通知内核收到了新的网络帧。<br><br>接下来，内核协议栈从缓冲区中取出网络帧，并通过网络协议栈，从下到上逐层处理这个网络帧。<br><br><br><br>老师你好，上面的一段话有些疑问想请教一下。<br><br>收包队列是属于哪里的存储空间，是属于物理内存吗，还是网卡中的存储空间，通过dma方式把数据放到收包队列，我猜这个收包队列是物理内存中的空间。这个收包队列是由内核管理的吧，也就是跟某一个进程的用户空间地址没关系？   <br><br>那sk_buf缓冲区又是哪里的存储空间，为什么还要把收包队列拷贝到这个缓冲区呢，这个缓冲区是协议栈维护的吗？也属于内核，跟进程的用户空间地址有关系吗？<br><br><br>socket的接收发送缓冲区是映射到进程的用户空间地址的吗？还是由协议栈为每个socket在内核中维护的缓冲区？<br><br>还有上面说到的这些缓冲区跟cache和buf有什么关系？会被回收吗？<br><br><br>内核协议栈的运行是通过一个内核线程的方式来运行的吗？是否可以看到这个线程的名字？","like_count":30,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440723,"discussion_content":"问题比较多，放到答疑篇里面统一回复吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551702265,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":66323,"user_name":"Dale","can_delete":false,"product_type":"c1","uid":1010056,"ip_address":"","ucode":"DD4717C06E417D","user_header":"https://static001.geekbang.org/account/avatar/00/0f/69/88/528442b0.jpg","comment_is_top":false,"comment_ctime":1549930430,"is_pvip":false,"discussion_count":7,"race_medal":0,"score":"87449276350","product_id":100020901,"comment_content":"网络报文传需要在用户态和内核态来回切换，导致性能下降。业界使用零拷贝或intel的dpdk来提高性能。","like_count":20,"discussions":[{"author":{"id":1240465,"avatar":"https://static001.geekbang.org/account/avatar/00/12/ed/91/1d332031.jpg","nickname":"我能走多远","note":"","ucode":"07DF5D5DADFA3C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":286821,"discussion_content":"一次发包有三次拷贝过程，应用层到内核态发包socket缓冲区；socket缓冲区到skb_buffer；skb到dma缓冲区？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1593305552,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1055334,"avatar":"https://static001.geekbang.org/account/avatar/00/10/1a/66/2d9db9ed.jpg","nickname":"苦行僧","note":"","ucode":"726024A9A9CF44","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":14049,"discussion_content":"零拷贝有没有副作用？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1568724619,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":5,"child_discussions":[{"author":{"id":1068361,"avatar":"https://static001.geekbang.org/account/avatar/00/10/4d/49/28e73b9c.jpg","nickname":"明翼","note":"","ucode":"E77F86BEB3D5C1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1055334,"avatar":"https://static001.geekbang.org/account/avatar/00/10/1a/66/2d9db9ed.jpg","nickname":"苦行僧","note":"","ucode":"726024A9A9CF44","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":290894,"discussion_content":"有副作用:1. 零拷贝一般没有机会做压缩或加密等;2.大文件做零拷贝会占用大量pagecache 而且后面命中又少,一般用异步IO的方式传输大文件","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1594634275,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":14049,"ip_address":""},"score":290894,"extra":""},{"author":{"id":2055993,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/5f/39/8d2c61d3.jpg","nickname":"Kiddy","note":"","ucode":"D07AAEE69BE504","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1068361,"avatar":"https://static001.geekbang.org/account/avatar/00/10/4d/49/28e73b9c.jpg","nickname":"明翼","note":"","ucode":"E77F86BEB3D5C1","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":302739,"discussion_content":"网卡数据包跟你的pagecache没有关系吧？这个是网络数据，操作的都是内存，跟文件IO无关","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599016826,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":290894,"ip_address":""},"score":302739,"extra":""},{"author":{"id":1068361,"avatar":"https://static001.geekbang.org/account/avatar/00/10/4d/49/28e73b9c.jpg","nickname":"明翼","note":"","ucode":"E77F86BEB3D5C1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2055993,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/5f/39/8d2c61d3.jpg","nickname":"Kiddy","note":"","ucode":"D07AAEE69BE504","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":303188,"discussion_content":"如果你读本地文件通过网络发送就有关系了，比如web服务器","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599181340,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":302739,"ip_address":""},"score":303188,"extra":""}]}]},{"had_liked":false,"id":67030,"user_name":"ninuxer","can_delete":false,"product_type":"c1","uid":1243135,"ip_address":"","ucode":"5394ADAF2667D6","user_header":"https://wx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEKQMM4m7NHuicr55aRiblTSEWIYe0QqbpyHweaoAbG7j2v7UUElqqeP3Ihrm3UfDPDRb1Hv8LvPwXqA/132","comment_is_top":false,"comment_ctime":1550058456,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"48794698712","product_id":100020901,"comment_content":"打卡day35<br>有一次业务反馈有些请求无法正常响应，后来花了两天时间才发现ifconfig看网卡的drop的包不断增长，后来发现是跟开启了内核的timestamp参数有关","like_count":11,"discussions":[{"author":{"id":1320293,"avatar":"https://static001.geekbang.org/account/avatar/00/14/25/65/f04c6cfa.jpg","nickname":"yesterday","note":"","ucode":"681CDE1288BFD6","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":299306,"discussion_content":"netstat -s 里面的3 packets rejects in established connections because of timestamp吗？我也遇到过跟nat有关。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1597651526,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":65479,"user_name":"Penn","can_delete":false,"product_type":"c1","uid":1044701,"ip_address":"","ucode":"C6A4AA2259068F","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/AkO5s3tJhibth9nelCNdU5qD4J3aEn8OpBhOHluicWgEj1SbcGC6e9rccK8DrfJtRibJT5g6iamfIibt5xX7ketDF6w/132","comment_is_top":false,"comment_ctime":1549405241,"is_pvip":false,"replies":[{"id":"23250","content":"嗯 这是最常见的两个问题","user_name":"作者回复","comment_id":65479,"uid":"1001282","ip_address":"","utype":1,"ctime":1549636290,"user_name_real":"倪朋飞"}],"discussion_count":6,"race_medal":0,"score":"35909143609","product_id":100020901,"comment_content":"中断不均，连接跟踪打满","like_count":8,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438464,"discussion_content":"嗯 这是最常见的两个问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1549636290,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1008348,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/dc/8876c73b.jpg","nickname":"moooofly","note":"","ucode":"4A20795C281B6F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":551125,"discussion_content":"contrack 很多时候不是不建议开启么","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644905126,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":438464,"ip_address":""},"score":551125,"extra":""}]},{"author":{"id":1033219,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/c4/03/f753fda7.jpg","nickname":"JianXu","note":"","ucode":"2A61BDBB573BDC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":542337,"discussion_content":"Contrack ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640733861,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1292330,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/VX0ib4CV0m7fwxB2xFcIJaYYWXXpfxxYbfBErqBej9395hgZszqS3dz9bThCxOuFfJ8Xibx9HbdNmZJwL5m33wIw/132","nickname":"chaoxifuchen","note":"","ucode":"95DCC5C4994F68","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":395368,"discussion_content":"表示看不懂，先记下来","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632294221,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2131606,"avatar":"","nickname":"Geek_da4cfb","note":"","ucode":"DB59B24A249713","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":310881,"discussion_content":"表示看不懂，先记下来","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1602088355,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1298046,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKZicicibGibtR5zAia782Ajc5I5BN3F3tjAdlibATIknHv67gbxeH21N7B6vbgwLjYb1miaLKhqicptB5ibYw/132","nickname":"阿飞","note":"","ucode":"F8B1FC8521264D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":269224,"discussion_content":"表示看不懂，先记下来","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589881023,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":84622,"user_name":"zhoufeng","can_delete":false,"product_type":"c1","uid":1447741,"ip_address":"","ucode":"6F92F7866F9EB4","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKq0oQVibKcmYJqmpqaNNQibVgia7EsEgW65LZJIpDZBMc7FyMcs7J1JmFCtp06pY8ibbcpW4ibRtG7Frg/132","comment_is_top":false,"comment_ctime":1554886835,"is_pvip":false,"replies":[{"id":"30638","content":"sk_buff一般是说内核数据接口，而 skb则是套接字缓存(socket buffer)","user_name":"作者回复","comment_id":84622,"uid":"1001282","ip_address":"","utype":1,"ctime":1555076472,"user_name_real":"倪朋飞"}],"discussion_count":2,"race_medal":0,"score":"23029723315","product_id":100020901,"comment_content":"老师好，一直不太明白skb_buff和sk_buff的区别，这两者有关系吗","like_count":5,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":446406,"discussion_content":"sk_buff一般是说内核数据接口，而 skb则是套接字缓存(socket buffer)","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1555076472,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2608728,"avatar":"https://static001.geekbang.org/account/avatar/00/27/ce/58/71ed845f.jpg","nickname":"Dexter","note":"","ucode":"909CABC4AC4AC9","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":586493,"discussion_content":"yes， 多了一个skb","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662256629,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"上海"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":78669,"user_name":"Geek_00d753","can_delete":false,"product_type":"c1","uid":1253949,"ip_address":"","ucode":"2ED08B1A425994","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJUP6ibuQssqJBNtQdSaFNhzzibdf7I3nyVGCeJPoDYqfsRndqRY19GpOJCOibMXQmOv2EchtHh0SXow/132","comment_is_top":false,"comment_ctime":1553215808,"is_pvip":false,"discussion_count":5,"race_medal":0,"score":"23028052288","product_id":100020901,"comment_content":"收数据的时候，从网卡到应用层socket。需要一次硬中断+一次软中断。<br>发数据的时候只需要一次软中断。<br>是这样吗？老师","like_count":5,"discussions":[{"author":{"id":2021302,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/d7/b6/534c036e.jpg","nickname":"可以告诉我你名字嘛","note":"","ucode":"AAAA58E95F54D6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":283580,"discussion_content":"DMA的出现就是为了解决批量数据的输入/输出问题。DMA是指外部设备不通过CPU而直接与系统内存交换数据的接口技术。这样数据的传送速度就取决于存储器和外设的工作速度。","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1592303196,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1226968,"avatar":"https://static001.geekbang.org/account/avatar/00/12/b8/d8/f81b5604.jpg","nickname":"hcyycb","note":"","ucode":"77FF6CA41F9E66","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":394851,"discussion_content":"应该也需要经过软中断和硬中断。网卡要发送或者接收数据，都要通知CPU，这会产生硬中断。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632102718,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2021302,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/d7/b6/534c036e.jpg","nickname":"可以告诉我你名字嘛","note":"","ucode":"AAAA58E95F54D6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":283581,"discussion_content":"哈哈,我也不知道了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592303227,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2021302,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/d7/b6/534c036e.jpg","nickname":"可以告诉我你名字嘛","note":"","ucode":"AAAA58E95F54D6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":283578,"discussion_content":"我感觉不是, &#34;最后，驱动程序通过 DMA ，从发包队列中读出网络帧，并通过物理网卡把它发送出去&#34;  明显内核还是要调用驱动和网卡交互","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592302428,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1016905,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/84/49/47d48fd0.jpg","nickname":"观弈道人","note":"","ucode":"F3BB619A33C605","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":60486,"discussion_content":"同问，感觉不会有回复了 ，o(*￣︶￣*)o","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574733583,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":69134,"user_name":"饼子","can_delete":false,"product_type":"c1","uid":1085953,"ip_address":"","ucode":"981A44836A5216","user_header":"https://static001.geekbang.org/account/avatar/00/10/92/01/c723d180.jpg","comment_is_top":false,"comment_ctime":1550668087,"is_pvip":false,"replies":[{"id":"24539","content":"嗯嗯，文件数量或者连接数量都可以看到","user_name":"作者回复","comment_id":69134,"uid":"1001282","ip_address":"","utype":1,"ctime":1550675758,"user_name_real":"倪朋飞"}],"discussion_count":1,"race_medal":0,"score":"23025504567","product_id":100020901,"comment_content":"遇到了程序分配大量链接，占用完程序最大打开文件数量，使用lsof 查看分析的","like_count":5,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":439966,"discussion_content":"嗯嗯，文件数量或者连接数量都可以看到","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550675758,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":113617,"user_name":"空白","can_delete":false,"product_type":"c1","uid":1147753,"ip_address":"","ucode":"65DA67B52A16B9","user_header":"https://static001.geekbang.org/account/avatar/00/11/83/69/77256c74.jpg","comment_is_top":false,"comment_ctime":1563095098,"is_pvip":false,"replies":[{"id":"41981","content":"系统调用","user_name":"作者回复","comment_id":113617,"uid":"1001282","ip_address":"","utype":1,"ctime":1563456723,"user_name_real":"倪朋飞"}],"discussion_count":1,"race_medal":0,"score":"10153029690","product_id":100020901,"comment_content":"一直不太理解，网络包是如何具体交付给对应的线程的？","like_count":2,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":458311,"discussion_content":"系统调用","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563456723,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":67034,"user_name":"佳","can_delete":false,"product_type":"c1","uid":1334190,"ip_address":"","ucode":"482C90C3DC17DB","user_header":"https://static001.geekbang.org/account/avatar/00/14/5b/ae/3d639ea4.jpg","comment_is_top":false,"comment_ctime":1550059295,"is_pvip":false,"replies":[{"id":"23751","content":"MTU大小的问题都是分片和重组导致的。后面有案例讲到分析内核中网络协议栈的行为，你可以到时候试着分析下这种场景","user_name":"作者回复","comment_id":67034,"uid":"1001282","ip_address":"","utype":1,"ctime":1550071925,"user_name_real":"倪朋飞"}],"discussion_count":1,"race_medal":0,"score":"10139993887","product_id":100020901,"comment_content":"使用InfiniBand网卡和InfiniBand交换机的时候， mtu如果配置65520的时候，通过http下载对象存储小文件比较慢，但是配置9000的时候大小文件都比较快。https:&#47;&#47;github.com&#47;antirez&#47;redis&#47;issues&#47;2385 Redis works very slow with MTU higher than packet size. 请问老师是什么原因<br>","like_count":2,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":439023,"discussion_content":"MTU大小的问题都是分片和重组导致的。后面有案例讲到分析内核中网络协议栈的行为，你可以到时候试着分析下这种场景","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550071925,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":65709,"user_name":"空空","can_delete":false,"product_type":"c1","uid":1335572,"ip_address":"","ucode":"8F39A6F6E3362B","user_header":"https://static001.geekbang.org/account/avatar/00/14/61/14/2f9fec68.jpg","comment_is_top":false,"comment_ctime":1549596710,"is_pvip":false,"replies":[{"id":"23690","content":"这个不好说，后面有讲到延迟增大的分析思路，到时候可以分析看看","user_name":"作者回复","comment_id":65709,"uid":"1001282","ip_address":"","utype":1,"ctime":1550066260,"user_name_real":"倪朋飞"}],"discussion_count":2,"race_medal":0,"score":"10139531302","product_id":100020901,"comment_content":"老师过年好！<br>曾经在Linux3.10测试netlink收发包效率，发现一个问题，正常情况下每收一个包大概需要10us，但是每隔8秒会出现一次收包时间30-50ms，就是因为固定间隔8秒会出现一次收包时间过长，导致收包效率降低。请教一下老师每隔8秒系统会做什么？或者是因为什么系统配置？希望老师解答一下疑惑，谢谢！","like_count":2,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438559,"discussion_content":"这个不好说，后面有讲到延迟增大的分析思路，到时候可以分析看看","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550066260,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1045678,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f4/ae/3b101c00.jpg","nickname":"fl260919784","note":"","ucode":"D6E10B8BDD0BB8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":3890,"discussion_content":"小伙伴你的问题解决了吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564929305,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":65536,"user_name":"威","can_delete":false,"product_type":"c1","uid":1068542,"ip_address":"","ucode":"C921CDCB22B9A3","user_header":"https://static001.geekbang.org/account/avatar/00/10/4d/fe/882eaf0f.jpg","comment_is_top":false,"comment_ctime":1549435516,"is_pvip":false,"replies":[{"id":"23242","content":"ring buffer","user_name":"作者回复","comment_id":65536,"uid":"1001282","ip_address":"","utype":1,"ctime":1549636105,"user_name_real":"倪朋飞"}],"discussion_count":2,"race_medal":0,"score":"10139370108","product_id":100020901,"comment_content":"老师您好，请问最后一张图下方的两个大圈圈代表的是什么意思，是代表loop吗","like_count":2,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438494,"discussion_content":"ring buffer","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1549636105,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":2608728,"avatar":"https://static001.geekbang.org/account/avatar/00/27/ce/58/71ed845f.jpg","nickname":"Dexter","note":"","ucode":"909CABC4AC4AC9","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":586510,"discussion_content":"ring buffer 和DMA什么关系？ring buffer 不是驱动程序和物理网卡之间吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662285527,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":438494,"ip_address":"浙江"},"score":586510,"extra":""}]}]},{"had_liked":false,"id":65528,"user_name":"Geek_33409b","can_delete":false,"product_type":"c1","uid":1112756,"ip_address":"","ucode":"9C64C42F799403","user_header":"https://static001.geekbang.org/account/avatar/00/10/fa/b4/6892eabe.jpg","comment_is_top":false,"comment_ctime":1549430768,"is_pvip":false,"replies":[{"id":"23253","content":"DDoS 😊","user_name":"作者回复","comment_id":65528,"uid":"1001282","ip_address":"","utype":1,"ctime":1549636365,"user_name_real":"倪朋飞"}],"discussion_count":1,"race_medal":0,"score":"10139365360","product_id":100020901,"comment_content":"系统出口带宽被打满，导致大量请求超时","like_count":2,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438491,"discussion_content":"DDoS 😊","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1549636365,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":243779,"user_name":"Geek_04e22a","can_delete":false,"product_type":"c1","uid":1184505,"ip_address":"","ucode":"B64FF12EA28BA6","user_header":"https://static001.geekbang.org/account/avatar/00/12/12/f9/7e6e3ac6.jpg","comment_is_top":false,"comment_ctime":1598273134,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5893240430","product_id":100020901,"comment_content":"网关机器带宽被打满，查看发送机器有TCP重传","like_count":1},{"had_liked":false,"id":120008,"user_name":"Geek_25565b","can_delete":false,"product_type":"c1","uid":1592987,"ip_address":"","ucode":"0C3A01C4B0AB66","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/CV9kk5M26pdIuAxwdXvj90ewKECzdSmzO4ibP6iaLXY50hICibefmib4qGvu1wCSfXuRobFC86z7W3OcfncpV8Uevw/132","comment_is_top":false,"comment_ctime":1564754186,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"5859721482","product_id":100020901,"comment_content":"老师好，netstat 执行一次 Recv-Q 和Send-Q 有值就说明堆积吗？还是用watch 看变化情况确定堆积？","like_count":1,"discussions":[{"author":{"id":1298046,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKZicicibGibtR5zAia782Ajc5I5BN3F3tjAdlibATIknHv67gbxeH21N7B6vbgwLjYb1miaLKhqicptB5ibYw/132","nickname":"阿飞","note":"","ucode":"F8B1FC8521264D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":269220,"discussion_content":"有值就有堆积","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589880912,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":90146,"user_name":"涛涛","can_delete":false,"product_type":"c1","uid":1180810,"ip_address":"","ucode":"747C4B1F20A2D3","user_header":"https://static001.geekbang.org/account/avatar/00/12/04/8a/ff94bd60.jpg","comment_is_top":false,"comment_ctime":1556432438,"is_pvip":false,"replies":[{"id":"32535","content":"为了性能，只在必须要拷贝的时候才去复制","user_name":"作者回复","comment_id":90146,"uid":"1001282","ip_address":"","utype":1,"ctime":1556635040,"user_name_real":"倪朋飞"}],"discussion_count":1,"race_medal":0,"score":"5851399734","product_id":100020901,"comment_content":"接受网络包的时候，数据拷贝了好几次，所以后来有了零拷贝？","like_count":1,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":448404,"discussion_content":"为了性能，只在必须要拷贝的时候才去复制","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1556635040,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":78162,"user_name":"胡鹏","can_delete":false,"product_type":"c1","uid":1326455,"ip_address":"","ucode":"52644EC57FA4DB","user_header":"https://static001.geekbang.org/account/avatar/00/14/3d/77/45e5e06d.jpg","comment_is_top":false,"comment_ctime":1553082638,"is_pvip":false,"replies":[{"id":"28744","content":"是的，大规模必须要专业的网络设备来抗","user_name":"作者回复","comment_id":78162,"uid":"1001282","ip_address":"","utype":1,"ctime":1553316324,"user_name_real":"倪朋飞"}],"discussion_count":1,"race_medal":0,"score":"5848049934","product_id":100020901,"comment_content":"我所知道的网络问题，就是服务器被ddos攻击，小规模，可以防，，，大规模防不了","like_count":1,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":443990,"discussion_content":"是的，大规模必须要专业的网络设备来抗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1553316324,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":78040,"user_name":"张挺","can_delete":false,"product_type":"c1","uid":1038954,"ip_address":"","ucode":"CDF8549440926D","user_header":"https://static001.geekbang.org/account/avatar/00/0f/da/6a/91bd13de.jpg","comment_is_top":false,"comment_ctime":1553060732,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5848028028","product_id":100020901,"comment_content":"您好，请问，数据从网卡到应用程序或者应用程序到网卡，都会同时触发硬中断和软中断吗？","like_count":1},{"had_liked":false,"id":67509,"user_name":"玉剑冰锋","can_delete":false,"product_type":"c1","uid":1214202,"ip_address":"","ucode":"8EA56A71BA5B22","user_header":"https://static001.geekbang.org/account/avatar/00/12/86/fa/4bcd7365.jpg","comment_is_top":false,"comment_ctime":1550188790,"is_pvip":false,"replies":[{"id":"24034","content":"根据 MTU 分片，分片里面会包含分片信息，所以接收后还可以组合起来。","user_name":"作者回复","comment_id":67509,"uid":"1001282","ip_address":"","utype":1,"ctime":1550325361,"user_name_real":"倪朋飞"}],"discussion_count":1,"race_medal":0,"score":"5845156086","product_id":100020901,"comment_content":"您好老师，IP包分片，一个IP包分成多个分片，是如何保证接收方收一个完整的数据包的？","like_count":1,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":439224,"discussion_content":"根据 MTU 分片，分片里面会包含分片信息，所以接收后还可以组合起来。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550325361,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":67375,"user_name":"夜空中最亮的星","can_delete":false,"product_type":"c1","uid":1267566,"ip_address":"","ucode":"ADC3E7B6789955","user_header":"https://static001.geekbang.org/account/avatar/00/13/57/6e/b6795c44.jpg","comment_is_top":false,"comment_ctime":1550136457,"is_pvip":false,"replies":[{"id":"24031","content":"谢谢，新春快乐！","user_name":"作者回复","comment_id":67375,"uid":"1001282","ip_address":"","utype":1,"ctime":1550325047,"user_name_real":"倪朋飞"}],"discussion_count":1,"race_medal":0,"score":"5845103753","product_id":100020901,"comment_content":"新年好，给老师拜个晚年，过年的课都落下了，抓紧时间赶上来。","like_count":1,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":439165,"discussion_content":"谢谢，新春快乐！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550325047,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":65706,"user_name":"我来也","can_delete":false,"product_type":"c1","uid":1205253,"ip_address":"","ucode":"773D6104F56767","user_header":"https://static001.geekbang.org/account/avatar/00/12/64/05/6989dce6.jpg","comment_is_top":false,"comment_ctime":1549596577,"is_pvip":false,"replies":[{"id":"23691","content":"可以考虑做个内部网络监控，比如内网流量都来自自己的服务（IP已知），其他的可以算作外网流量","user_name":"作者回复","user_name_real":"倪朋飞","uid":"1001282","ctime":1550066361,"ip_address":"","comment_id":65706,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5844563873","product_id":100020901,"comment_content":"[D33打卡]<br>可能是公司业务规模不大，峰值带宽未超过100m。以前遇到的网络性能问题不太多，现在都是云服务器了，理论上出口带宽可以动态调整，遇到的问题就更少了。<br>但自从阿里云切到腾讯云后，还真遇到了一个对我来说无解的网络问题。<br>云服务器控制台经常提示带宽已达峰值，但上控制台观察，只能查到最小粒度10s的流量图，而服务器上只能看到内网ip，并未有单独的外网ip，就是说在服务器上用工具观察到的流量是内外+外网的流量总和。而内网流量又不能砍掉，也无法预估流量大小。<br>最后就很尴尬了，以我用iftop的分析结果来看，流量应该是未超，但控制台说超了被限制了，也无法核对数据。","like_count":1,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438558,"discussion_content":"可以考虑做个内部网络监控，比如内网流量都来自自己的服务（IP已知），其他的可以算作外网流量","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550066361,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":65614,"user_name":"J","can_delete":false,"product_type":"c1","uid":1204008,"ip_address":"","ucode":"7F1BD7F66F4700","user_header":"https://static001.geekbang.org/account/avatar/00/12/5f/28/17ed19bc.jpg","comment_is_top":false,"comment_ctime":1549508928,"is_pvip":false,"replies":[{"id":"23693","content":"谢谢，会的。从 busy poll 的原理上其实可以找到一些线索。比如 busy poll 是 socket layer 的，会占用大量的CPU，比如 busy-poll 的进程过多的话，CPU 可能就是瓶颈","user_name":"作者回复","user_name_real":"倪朋飞","uid":"1001282","ctime":1550067068,"ip_address":"","comment_id":65614,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5844476224","product_id":100020901,"comment_content":"先拜年，再问问题:)。好多时候性能问题是由于网络造成的，后续应该有些相关案例分析吧。<br>从centos7.4升级到7.5之后，网卡busy-poll: off 被设置成off了。如果用tuned-profile network-latency,<br>就会有很大的性能下降。必须把里面的net.core.busy_read net.core.busy_poll 设置为0关闭。不太明白这个内核变化的原因以及性能下降的原因。","like_count":1,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438521,"discussion_content":"谢谢，会的。从 busy poll 的原理上其实可以找到一些线索。比如 busy poll 是 socket layer 的，会占用大量的CPU，比如 busy-poll 的进程过多的话，CPU 可能就是瓶颈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550067068,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":65538,"user_name":"道无涯","can_delete":false,"product_type":"c1","uid":1117394,"ip_address":"","ucode":"DA1C0C4BB63DC6","user_header":"https://static001.geekbang.org/account/avatar/00/11/0c/d2/381c75f5.jpg","comment_is_top":false,"comment_ctime":1549438030,"is_pvip":false,"replies":[{"id":"23748","content":"收包取决于机器外部的路由（比如交换机和路由器），机器内部的配置可能会影响回包路径","user_name":"作者回复","user_name_real":"倪朋飞","uid":"1001282","ctime":1550071806,"ip_address":"","comment_id":65538,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5844405326","product_id":100020901,"comment_content":"本机有两张网卡，如果路由配成第二张网卡也走第一张网卡，会不会导致第二张网络收不到数据？","like_count":1,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438495,"discussion_content":"收包取决于机器外部的路由（比如交换机和路由器），机器内部的配置可能会影响回包路径","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550071806,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":359804,"user_name":"李維道","can_delete":false,"product_type":"c1","uid":1926057,"ip_address":"中国台湾","ucode":"9A16ECAB2522E3","user_header":"https://static001.geekbang.org/account/avatar/00/1d/63/a9/abed781e.jpg","comment_is_top":false,"comment_ctime":1665912847,"is_pvip":true,"discussion_count":0,"race_medal":5,"score":"1665912847","product_id":100020901,"comment_content":"专有名词请附上英文原文，实在没办法看懂中文名词在描述什么","like_count":0},{"had_liked":false,"id":344061,"user_name":"爱丽包°","can_delete":false,"product_type":"c1","uid":2535283,"ip_address":"","ucode":"125325E82EE6D2","user_header":"https://static001.geekbang.org/account/avatar/00/26/af/73/6bc60f7a.jpg","comment_is_top":false,"comment_ctime":1651218198,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1651218198","product_id":100020901,"comment_content":"老师，不太明白网络协议栈和内核协议栈有什么关联和区别","like_count":0},{"had_liked":false,"id":316667,"user_name":"Ansyear","can_delete":false,"product_type":"c1","uid":1629257,"ip_address":"","ucode":"489CE96852EA2C","user_header":"https://static001.geekbang.org/account/avatar/00/18/dc/49/43ae1627.jpg","comment_is_top":false,"comment_ctime":1634481059,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1634481059","product_id":100020901,"comment_content":"学过网络的就会觉得这张比较简单了","like_count":0},{"had_liked":false,"id":310285,"user_name":"小小菜鸟","can_delete":false,"product_type":"c1","uid":1229617,"ip_address":"","ucode":"1CECC0A664CFD1","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTK009KMmXKFVSEdjicpDD4ick3NZpM3JdIUibWGB03lG6yicibad0tGmQD7E3DpZ0sVRenxWNfd7iaPdp7g/132","comment_is_top":false,"comment_ctime":1630577430,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1630577430","product_id":100020901,"comment_content":"我以前就一招<br>top看CPU：负载、进程、各种的；<br>top看内存：看可用和是否有swap；<br>top看网络：si是否高；<br>top看磁盘IO：wa是否高；<br>再详细用其它命令或工具进一步；","like_count":0},{"had_liked":false,"id":303873,"user_name":"暮雨未央","can_delete":false,"product_type":"c1","uid":1809462,"ip_address":"","ucode":"1D53E1F42B387B","user_header":"https://static001.geekbang.org/account/avatar/00/1b/9c/36/72825715.jpg","comment_is_top":false,"comment_ctime":1627039113,"is_pvip":false,"discussion_count":0,"race_medal":4,"score":"1627039113","product_id":100020901,"comment_content":"服务网络，相同网段之间传输速度不超过2m1秒。猜测是做了限速，查起来木有头绪。希望老师的课程，希望老师的课程给我一些思路","like_count":0},{"had_liked":false,"id":278461,"user_name":"鱼","can_delete":false,"product_type":"c1","uid":1487584,"ip_address":"","ucode":"89EC9CE3AD0281","user_header":"https://static001.geekbang.org/account/avatar/00/16/b2/e0/d856f5a4.jpg","comment_is_top":false,"comment_ctime":1612951943,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1612951943","product_id":100020901,"comment_content":"老师在网卡发送数据部分“这一切完成后，会有软中断通知驱动程序：发包队列中有新的网络帧需要发送。”  这里是不是笔误了？应该是硬中断。发送过程的软中断，应该发生在系统调用时：软中断告知内核基于网络协议栈层层封装需要发送的数据。","like_count":0},{"had_liked":false,"id":267589,"user_name":"边明凯","can_delete":false,"product_type":"c1","uid":2330488,"ip_address":"","ucode":"3177EEB41069B0","user_header":"https://static001.geekbang.org/account/avatar/00/23/8f/78/47cbb66e.jpg","comment_is_top":false,"comment_ctime":1607838167,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1607838167","product_id":100020901,"comment_content":"老师您好，请教您两个问题：<br>1.数据帧在发送队列中，通过软中断通知驱动程序有数据波要发送。这个是由内核通知的还是协议栈通知的？<br>2.tcpdump或者wireshark抓包是从发送队列中抓取的么<br>谢谢老师。","like_count":0},{"had_liked":false,"id":231399,"user_name":"Carey","can_delete":false,"product_type":"c1","uid":1295041,"ip_address":"","ucode":"D31D1ECFAE0027","user_header":"https://static001.geekbang.org/account/avatar/00/13/c2/c1/48785057.jpg","comment_is_top":false,"comment_ctime":1593666568,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1593666568","product_id":100020901,"comment_content":"老师，我看见网络层的ip报文格式，开头四位是版本，标识这个报文是ipv4还是ipv6，而本文的说法是在链路层检查出来的。我查资料显示链路层可检查报文是ip数据报还是ARP，网络层检查报文是TCP还是UDP。","like_count":0},{"had_liked":false,"id":229528,"user_name":"我能走多远","can_delete":false,"product_type":"c1","uid":1240465,"ip_address":"","ucode":"07DF5D5DADFA3C","user_header":"https://static001.geekbang.org/account/avatar/00/12/ed/91/1d332031.jpg","comment_is_top":false,"comment_ctime":1593052159,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1593052159","product_id":100020901,"comment_content":"在网络发包流程中的，应用层的数据会在系统调用时copy到socket的发包缓冲区；网络协议栈会从socket缓冲区取出数据包；进入tcp&#47;IP协议栈逐层处理，疑问 数据是在那一层申请和填充的sk_buffer的？<br>看了一下发包调用栈是在传输层层构造的sk_buffer 结构，socket缓冲区数据有拷贝到skbuffer的data区的动作吗？有的话在那个阶段？","like_count":0},{"had_liked":false,"id":161702,"user_name":"allan","can_delete":false,"product_type":"c1","uid":1142819,"ip_address":"","ucode":"CA0BE868AA9FF5","user_header":"https://static001.geekbang.org/account/avatar/00/11/70/23/972dcd30.jpg","comment_is_top":false,"comment_ctime":1576301205,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1576301205","product_id":100020901,"comment_content":"请教下老师，为什么内核协议栈接收网络包的时候，在每一层都要找出上层协议呢？？？比如在网络层取出上层协议的类型是TCP&#47;UDP，直接把本层的头部去掉，交上层处理不就可以了嘛","like_count":0,"discussions":[{"author":{"id":1448147,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/ueWNR1W4WibG9o7sa3Wv6by4VwM15rJCOGfxZ3nX0tj9ic8nTcofFUICBrXICgomJfRblVMHUQELFoKKMLUmPk0Q/132","nickname":"不懈前行","note":"","ucode":"237C22578E1AF6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":227141,"discussion_content":"因为每一层都支持多个协议，每个协议调用不同的函数入口","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586468542,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":101789,"user_name":"sTone","can_delete":false,"product_type":"c1","uid":1335643,"ip_address":"","ucode":"2944A230620076","user_header":"https://static001.geekbang.org/account/avatar/00/14/61/5b/9ad27865.jpg","comment_is_top":false,"comment_ctime":1559972927,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1559972927","product_id":100020901,"comment_content":"根据tcp网络模型的封装方式, 网络接口层mac地址, 但是internet是ip寻址, 难道每次接到网络包都要拆分到网络层找到对应的ip地址, 然后再决定下一步? 是不是先mac寻址再op寻址?","like_count":0},{"had_liked":false,"id":101659,"user_name":"Goal","can_delete":false,"product_type":"c1","uid":1307012,"ip_address":"","ucode":"C337CD4C7E07B0","user_header":"https://static001.geekbang.org/account/avatar/00/13/f1/84/7d21bd9e.jpg","comment_is_top":false,"comment_ctime":1559904150,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1559904150","product_id":100020901,"comment_content":"打卡<br>","like_count":0},{"had_liked":false,"id":97534,"user_name":"sTone","can_delete":false,"product_type":"c1","uid":1335643,"ip_address":"","ucode":"2944A230620076","user_header":"https://static001.geekbang.org/account/avatar/00/14/61/5b/9ad27865.jpg","comment_is_top":false,"comment_ctime":1558689331,"is_pvip":false,"replies":[{"id":"34966","content":"IP","user_name":"作者回复","user_name_real":"倪朋飞","uid":"1001282","ctime":1558793322,"ip_address":"","comment_id":97534,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1558689331","product_id":100020901,"comment_content":"互联网是按ip寻址还是mac?","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":451317,"discussion_content":"IP","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1558793322,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":78493,"user_name":"如果","can_delete":false,"product_type":"c1","uid":1320638,"ip_address":"","ucode":"138A3EEEE50850","user_header":"","comment_is_top":false,"comment_ctime":1553159720,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1553159720","product_id":100020901,"comment_content":"DAY33，打卡","like_count":0},{"had_liked":false,"id":75098,"user_name":"小胡子","can_delete":false,"product_type":"c1","uid":1018182,"ip_address":"","ucode":"79FEC6400D25DA","user_header":"https://static001.geekbang.org/account/avatar/00/0f/89/46/0b7828a1.jpg","comment_is_top":false,"comment_ctime":1552355188,"is_pvip":false,"replies":[{"id":"27483","content":"不完全一样，lo不用走到网卡，而只是一个虚拟设备，在内核中路由后就会转到lo上了","user_name":"作者回复","user_name_real":"倪朋飞","uid":"1001282","ctime":1552399385,"ip_address":"","comment_id":75098,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1552355188","product_id":100020901,"comment_content":"请问老师环回接口的收发包也是和正常网卡接口一样的吗？","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":442798,"discussion_content":"不完全一样，lo不用走到网卡，而只是一个虚拟设备，在内核中路由后就会转到lo上了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1552399385,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":66544,"user_name":"vvccoe","can_delete":false,"product_type":"c1","uid":1099892,"ip_address":"","ucode":"1BE9FDE72175BE","user_header":"https://static001.geekbang.org/account/avatar/00/10/c8/74/a1bd2307.jpg","comment_is_top":false,"comment_ctime":1549956286,"is_pvip":false,"replies":[{"id":"23717","content":"简单网络是这样的，不过复杂网络里面 MTU 不一定准确，还有可能动态变化，所以并不是IP分片就完全不需要了","user_name":"作者回复","user_name_real":"倪朋飞","uid":"1001282","ctime":1550069842,"ip_address":"","comment_id":66544,"utype":1}],"discussion_count":4,"race_medal":0,"score":"1549956286","product_id":100020901,"comment_content":"老师，新年快乐。<br>之前忘了在哪里读的，关于分片的说法，和你在文章中的说法，有一点差异，如果是TCP连接，在三次握手中的前两次会带一个MSS值，MSS值来表示接收单包最大量，MSS值根据MTU计算出来。以避免在IP层分片，IP层分片的缺点在于如果丢失一个包，会导致所有分片包重传。<br>如果在中间路由出现MTU过小的情况，会重新协商MSS值，总之TCP的连接不会用IP层来分片，不知道对否？","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438827,"discussion_content":"简单网络是这样的，不过复杂网络里面 MTU 不一定准确，还有可能动态变化，所以并不是IP分片就完全不需要了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550069842,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1636551,"avatar":"https://static001.geekbang.org/account/avatar/00/18/f8/c7/d0c0a613.jpg","nickname":"大地","note":"","ucode":"62D9098C0BCE13","race_medal":1,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":278660,"discussion_content":"在IP层有个DF标志位，假如你的host发了一个很大的包(超过了对端MTU)给路由器，路由器发现你发的包过大，并且IP层的DF标志位置1了，就会给你的host回一个ICMP差错报文(type=3, code=4)，这个包主要目的就是告诉你，你发的包过大了，你nexthop的mtu(路由器的mtu)是多少。所以你要想成功发送这个大报文，就要自己分段。你的host收到这个差错报文，会根据路由器告诉你的MTU和自己的MSS取一个最小值，来分段发送数据。\nhttps://www.cisco.com/c/en/us/support/docs/ip/generic-routing-encapsulation-gre/25885-pmtud-ipfrag.html#anc2\n这篇文章介绍的很清楚，推荐看一遍。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1591201332,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1636551,"avatar":"https://static001.geekbang.org/account/avatar/00/18/f8/c7/d0c0a613.jpg","nickname":"大地","note":"","ucode":"62D9098C0BCE13","race_medal":1,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":278662,"discussion_content":"补充一句，能在传输层分段就不要在IP层分片，网络环境对IP分片包不是很友好，说不准你的IP分片包就被哪个防火墙就给丢了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591201553,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1135299,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKzqiaZnBw2myRWY802u48Rw3W2zDtKoFQ6vN63m4FdyjibM21FfaOYe8MbMpemUdxXJeQH6fRdVbZA/132","nickname":"kissingers","note":"","ucode":"615151808CF628","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":18214,"discussion_content":"也就是TCP考虑了收发两端，但无法兼顾中间。path mtu discovery，可以用来检测中间链路","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1569032742,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":65989,"user_name":"二三子也","can_delete":false,"product_type":"c1","uid":1245787,"ip_address":"","ucode":"69C7D86583277D","user_header":"https://static001.geekbang.org/account/avatar/00/13/02/5b/ce326cfc.jpg","comment_is_top":false,"comment_ctime":1549841970,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1549841970","product_id":100020901,"comment_content":"Flag<br>2019&#47;02&#47;11","like_count":0}]}