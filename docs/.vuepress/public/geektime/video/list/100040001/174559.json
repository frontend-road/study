{"id":174559,"title":"19 | 事务开发：写操作事务","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/geektime-mongodb-course\">https://gitee.com/geektime-geekbang/geektime-mongodb-course</a></p>","comments":[{"had_liked":false,"id":164785,"user_name":"dream","can_delete":false,"product_type":"c3","uid":1117793,"ip_address":"","ucode":"65B33D32FA8BE9","user_header":"https://static001.geekbang.org/account/avatar/00/11/0e/61/ae68f8eb.jpg","comment_is_top":false,"comment_ctime":1577091290,"is_pvip":false,"replies":[{"id":62935,"content":"日志：  这个是一个比较通用的概念，可以包括你说的所有（journal,oplog,以及server日志）。\n\n具体一点来说， journal日志是数据库的crash recovery手段。通常的做法是把数据库内的数据块修改，提前用文件顺序写方式刷到盘上，然后再去真正的提交数据的修改。这样的目的是在服务器宕机的时候，内存中被丢失的数据可以在恢复过程中从journal 日志文件中读回来。\n\nOplog也是记录的数据库的操作日志，但是记的是逻辑操作命令。主要的目的是用于节点之间复制数据，而不是上面journal主要是用来recover crash。\n\n还有一种就是mongod.log，这个就是一个文本文件，记录数据库系统的正常运行和错误信息等等。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1577181040,"ip_address":"","comment_id":164785,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师，请问一下：日志、journal、oplog 这三个有什么联系与区别呢？感觉这三者的概念很混淆。","like_count":10,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":478893,"discussion_content":"日志：  这个是一个比较通用的概念，可以包括你说的所有（journal,oplog,以及server日志）。\n\n具体一点来说， journal日志是数据库的crash recovery手段。通常的做法是把数据库内的数据块修改，提前用文件顺序写方式刷到盘上，然后再去真正的提交数据的修改。这样的目的是在服务器宕机的时候，内存中被丢失的数据可以在恢复过程中从journal 日志文件中读回来。\n\nOplog也是记录的数据库的操作日志，但是记的是逻辑操作命令。主要的目的是用于节点之间复制数据，而不是上面journal主要是用来recover crash。\n\n还有一种就是mongod.log，这个就是一个文本文件，记录数据库系统的正常运行和错误信息等等。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577181040,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1165671,"avatar":"https://static001.geekbang.org/account/avatar/00/11/c9/67/7d446501.jpg","nickname":"大展宏兔","note":"","ucode":"21E6001F29951B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":576519,"discussion_content":"WAL","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655623571,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":478893,"ip_address":"","group_id":0},"score":576519,"extra":""}]},{"author":{"id":1180955,"avatar":"https://static001.geekbang.org/account/avatar/00/12/05/1b/fc1aa0ac.jpg","nickname":"王大伟","note":"","ucode":"A3BDC4D7B94B0F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":98759,"discussion_content":"跟mysql的redolog binlog相似","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1577185340,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":166624,"user_name":"撑伞也是雨中人。","can_delete":false,"product_type":"c3","uid":1610634,"ip_address":"","ucode":"743F23626ACF53","user_header":"https://static001.geekbang.org/account/avatar/00/18/93/8a/2b78f44d.jpg","comment_is_top":false,"comment_ctime":1577522796,"is_pvip":false,"replies":[{"id":65195,"content":"服务器端无法配置。\n你可以在Connection String上设置，这个一般是全局统一的设置。\n\n例子：\n\nmongodb:&#47;&#47;db0.example.com,db1.example.com,db2.example.com&#47;?replicaSet=myRepl&amp;w=majority&amp;wtimeoutMS=5000\n\n详细文档：\nhttps:&#47;&#47;docs.mongodb.com&#47;manual&#47;reference&#47;connection-string&#47;\n\n\n","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1577967539,"ip_address":"","comment_id":166624,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师 mongo是否可以在服务器端配置 majority write concern ，跟 j : true ？  如果在sql层面每条语句加 w:majority , j : true 有点麻烦，开发也不一定按照规范来操作。   如果可以在服务器直接配置，该如何配置","like_count":6,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":479562,"discussion_content":"服务器端无法配置。\n你可以在Connection String上设置，这个一般是全局统一的设置。\n\n例子：\n\nmongodb://db0.example.com,db1.example.com,db2.example.com/?replicaSet=myRepl&amp;amp;w=majority&amp;amp;wtimeoutMS=5000\n\n详细文档：\nhttps://docs.mongodb.com/manual/reference/connection-string/\n\n\n","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1577967539,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1076081,"avatar":"https://static001.geekbang.org/account/avatar/00/10/6b/71/e833b14a.jpg","nickname":"李英权","note":"","ucode":"FECAC14A9C414B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":324368,"discussion_content":"哇 太感谢了，我研究半天 没找到springdata哪里可以配置wtimeout","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605095922,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":166005,"user_name":"wu526","can_delete":false,"product_type":"c3","uid":1022129,"ip_address":"","ucode":"69282EB175B48E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/98/b1/f89a84d0.jpg","comment_is_top":false,"comment_ctime":1577361480,"is_pvip":false,"replies":[{"id":66852,"content":"这个问题我已经提交给原厂了，暂时还没有回复。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1579170339,"ip_address":"","comment_id":166005,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师您好，我在演练的时候发现(使用mongodb的cli工具)，当集群为3个的时候，将writeConcern的w设置为4时, 数据任然可以插入成功，但是cli有错误信息返回。这个和预想的情况不同。如果我想让这种情况也无法插入数据应该如何设置呢？","like_count":6,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":479349,"discussion_content":"这个问题我已经提交给原厂了，暂时还没有回复。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579170339,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":165388,"user_name":"奕","can_delete":false,"product_type":"c3","uid":1005391,"ip_address":"","ucode":"73CEA468CE70C3","user_header":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","comment_is_top":false,"comment_ctime":1577232788,"is_pvip":false,"replies":[{"id":65228,"content":"j:1 表示Journal 日志刷盘，所以就是要写文件到硬盘。\n\n正常数据只是写到内存的Cache（不是操作系统的cache，而是WiredTiger自己管理的Cache），然后异步刷盘。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1577974118,"ip_address":"","comment_id":165388,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"Mongo 落盘的时候，有用到文件系统的 Page Cache 机制吗？\n当有一条数据更新的时候是先写到内存，然后是Page Cache 最后是 硬盘吗？\n\nj 这个参数是代表写到 Page Cache 还是硬盘呢？","like_count":5,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":479140,"discussion_content":"j:1 表示Journal 日志刷盘，所以就是要写文件到硬盘。\n\n正常数据只是写到内存的Cache（不是操作系统的cache，而是WiredTiger自己管理的Cache），然后异步刷盘。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577974118,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1165671,"avatar":"https://static001.geekbang.org/account/avatar/00/11/c9/67/7d446501.jpg","nickname":"大展宏兔","note":"","ucode":"21E6001F29951B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576525,"discussion_content":"&#34;正常数据只是写到内存的Cache&#34; 看起来和MySQL  innodb_flush_log_at_trx_commit 参数为0时类似，都是先把数据保存在自己的进程内存中； j: true的话，类似上面MySQL参数值&#34;1&#34;, 即直接刷盘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655627760,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":164228,"user_name":"dream","can_delete":false,"product_type":"c3","uid":1117793,"ip_address":"","ucode":"65B33D32FA8BE9","user_header":"https://static001.geekbang.org/account/avatar/00/11/0e/61/ae68f8eb.jpg","comment_is_top":false,"comment_ctime":1576910790,"is_pvip":false,"replies":[{"id":62959,"content":"有点绕。但是“刚刚写的那条数据是在它监听之前写入新的主节点的日志的，那么这个从节点不就丢失了这条写的数据了” 我只能说，这个从节点不会丢失。\n\n最后一个从节点通过比较自己的oplog和新主的oplog来确定是否要同步新数据。两者的oplog肯定会差一条（新的数据），就会从新主那里复制。\n\n\n","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1577183646,"ip_address":"","comment_id":164228,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师请问一下，就是一主二从的模式，writeConcern 为 majority，刚好写入一条数据时主节点宕机，此时两个从节点一个有数据，一个没有这条数据，有数据的一个作为主节点。此时，没有数据的一个还是从节点，它的同步是去监听新的主节点的日志变化，但是刚刚写的那条数据是在它监听之前写入新的主节点的日志的，那么这个从节点不就丢失了这条写的数据了吗？mongodb还有其他什么机制保证吗？","like_count":5,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":478686,"discussion_content":"有点绕。但是“刚刚写的那条数据是在它监听之前写入新的主节点的日志的，那么这个从节点不就丢失了这条写的数据了” 我只能说，这个从节点不会丢失。\n\n最后一个从节点通过比较自己的oplog和新主的oplog来确定是否要同步新数据。两者的oplog肯定会差一条（新的数据），就会从新主那里复制。\n\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577183646,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":166945,"user_name":"Allen","can_delete":false,"product_type":"c3","uid":1168265,"ip_address":"","ucode":"10D365C791D28F","user_header":"https://static001.geekbang.org/account/avatar/00/11/d3/89/fcf95d32.jpg","comment_is_top":false,"comment_ctime":1577635441,"is_pvip":false,"replies":[{"id":65194,"content":"这个是需要用reconfig命令才能生效的。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1577967416,"ip_address":"","comment_id":166945,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师，我发现配置好了后，需要调用一下rs.reconfig()命令才能生效，这个和mongodb的版本有关系吗？","like_count":4,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":479688,"discussion_content":"这个是需要用reconfig命令才能生效的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577967416,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":173166,"user_name":"李英权","can_delete":false,"product_type":"c3","uid":1076081,"ip_address":"","ucode":"FECAC14A9C414B","user_header":"https://static001.geekbang.org/account/avatar/00/10/6b/71/e833b14a.jpg","comment_is_top":false,"comment_ctime":1579442973,"is_pvip":false,"replies":[{"id":67374,"content":"默认是read uncommitted。正常情况都不会有问题，除了发生宕机的时候，这个可能会有问题 - 你读到的一条数据可能会在宕机的时候被回滚掉。这种事情概率很小，发生了可能问题也不算特别严重，很多场景可以接受。如果要求比较高，那么需要用 readConcern: majority 来提高隔离级别。\n","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1579702594,"ip_address":"","comment_id":173166,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师，mongodb事务的默认隔离级别是什么？听说是相当于read uncommitted，这样似乎存在问题啊","like_count":2,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":481984,"discussion_content":"默认是read uncommitted。正常情况都不会有问题，除了发生宕机的时候，这个可能会有问题 - 你读到的一条数据可能会在宕机的时候被回滚掉。这种事情概率很小，发生了可能问题也不算特别严重，很多场景可以接受。如果要求比较高，那么需要用 readConcern: majority 来提高隔离级别。\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579702594,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":163041,"user_name":"长期规划","can_delete":false,"product_type":"c3","uid":1019332,"ip_address":"","ucode":"5EF65E9115834B","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8d/c4/6f97daea.jpg","comment_is_top":false,"comment_ctime":1576644993,"is_pvip":false,"replies":[{"id":62368,"content":"如果你使用majority write concern的话，不一定非得需要j:true。因为即使在主节点crash场景下，这条数据也已经在另一个节点上有了。\n","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1576888090,"ip_address":"","comment_id":163041,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师，j参数一般要设置为true吗","like_count":2,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":478224,"discussion_content":"如果你使用majority write concern的话，不一定非得需要j:true。因为即使在主节点crash场景下，这条数据也已经在另一个节点上有了。\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576888090,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1309984,"avatar":"https://static001.geekbang.org/account/avatar/00/13/fd/20/2761ef0e.jpg","nickname":"cheriston","note":"","ucode":"617CBFCE0925C4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":90965,"discussion_content":"非常重要数据操作要加这个条件参数，保证数据再宕机后不丢失数据。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576804442,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1019332,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/8d/c4/6f97daea.jpg","nickname":"长期规划","note":"","ucode":"5EF65E9115834B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1309984,"avatar":"https://static001.geekbang.org/account/avatar/00/13/fd/20/2761ef0e.jpg","nickname":"cheriston","note":"","ucode":"617CBFCE0925C4","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":91031,"discussion_content":"谢谢，其实加了w=majority我感觉也可以了吧，即使宕机，也已经在从节点有数据了。在MySQL中j对应的应该是redo log，但由于MySQL没有w参数，即它不会等同步从库后再返回，所以安全做法是redo log落盘后再返回。\n但Mongo有w，我感觉j的必要性已经不大了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576806403,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":90965,"ip_address":"","group_id":0},"score":91031,"extra":""}]}]},{"had_liked":false,"id":224103,"user_name":"田翌辰","can_delete":false,"product_type":"c3","uid":1430069,"ip_address":"","ucode":"4AF661C4C61C68","user_header":"https://static001.geekbang.org/account/avatar/00/15/d2/35/b25875e4.jpg","comment_is_top":false,"comment_ctime":1591275616,"is_pvip":false,"replies":[{"id":82545,"content":"oplog和就是一个MongoDB的collection ，都是存储在磁盘上的。 对oplog的操作只是顺序追加写入，所以效率相对来说会高不少，相比于普通collection 的随机读写。\n\n每一次增删改都会记录相应的oplog，并且对oplog的操作和数据表的写入是同一个原子事务的。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1591322179,"ip_address":"","comment_id":224103,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"请问一下，oplog是在内存中还是在磁盘上呢？ 每一次写操作都会事务的记录oplog对吧","like_count":1,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":497367,"discussion_content":"oplog和就是一个MongoDB的collection ，都是存储在磁盘上的。 对oplog的操作只是顺序追加写入，所以效率相对来说会高不少，相比于普通collection 的随机读写。\n\n每一次增删改都会记录相应的oplog，并且对oplog的操作和数据表的写入是同一个原子事务的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591322179,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":172819,"user_name":"默","can_delete":false,"product_type":"c3","uid":1230305,"ip_address":"","ucode":"5008C954338844","user_header":"https://static001.geekbang.org/account/avatar/00/12/c5/e1/b8ca59b5.jpg","comment_is_top":false,"comment_ctime":1579324544,"is_pvip":false,"replies":[{"id":67873,"content":"按照mongodb复制集选举规则，有最新数据的会第一优先被选为主节点","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1580283917,"ip_address":"","comment_id":172819,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"怎么就确定重新启动的主节点是同步x=1的节点呢.也可能是还没同步x=1节点.","like_count":1,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":481865,"discussion_content":"按照mongodb复制集选举规则，有最新数据的会第一优先被选为主节点","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580283917,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1370304,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLNgTWpN9vEUMZ77xTkiaPibX8E22c2L5GTmkgyP4cajbNiap5zEp28HicvA8eOCQqYo7YDsAhuafict2Q/132","nickname":"Geek_lbv7gj","note":"","ucode":"0CD6F332407936","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":412069,"discussion_content":"我也在疑惑这个问题，就看到了老师的回复😁","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1636074147,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":167572,"user_name":"dream","can_delete":false,"product_type":"c3","uid":1117793,"ip_address":"","ucode":"65B33D32FA8BE9","user_header":"https://static001.geekbang.org/account/avatar/00/11/0e/61/ae68f8eb.jpg","comment_is_top":false,"comment_ctime":1577864019,"is_pvip":false,"replies":[{"id":65189,"content":"跨系统事务（XA）目前在MongoDB&#47;ES上并无实现。Tough luck, 搜索下Saga Pattern，自己做事务补偿吧。\n\n","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1577966081,"ip_address":"","comment_id":167572,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"老师，请问个问题呀，一条数据在某个特定的业务场景，我需要把它写入 es 与 mongo(先写入mongo，然后在写入es)，写入mongo是ok的，但是由于某些原因写入es失败。\n这个时候我需要回滚 mongo 里面的数据，怎么处理呢？","like_count":1,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":479902,"discussion_content":"跨系统事务（XA）目前在MongoDB/ES上并无实现。Tough luck, 搜索下Saga Pattern，自己做事务补偿吧。\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577966081,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":163743,"user_name":"长期规划","can_delete":false,"product_type":"c3","uid":1019332,"ip_address":"","ucode":"5EF65E9115834B","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8d/c4/6f97daea.jpg","comment_is_top":false,"comment_ctime":1576797434,"is_pvip":false,"replies":[{"id":62965,"content":"你这个是Triple Failure - 三重错误。 如果按照这种假设，极端点的话就像是3个硬盘同时坏掉，你全部写入都没用。数据还是丢了。\n\n然后，你的描述确实有可能发生。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1577185428,"ip_address":"","comment_id":163743,"utype":1}],"discussion_count":2,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"老师，w=majority时，写入成功会数据一定不会丢吧？比如副本集有5个节点，某一次更新录录记为r，更新成功。主和另一从节点宕机，剩下A，B，C三个节点，且满足\n1. A与B，C能通信，但B和C之间无法通信\n2. A比B和C有更高优先级\n3. A的opIog比B和C旧，少一个修改记录r\n这种情况下，A是不是有可能成为主节点呢？如果是，B和C同步A的数据后，会回滚那个记录r吧？数据不就丢了吗","like_count":1,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":478523,"discussion_content":"你这个是Triple Failure - 三重错误。 如果按照这种假设，极端点的话就像是3个硬盘同时坏掉，你全部写入都没用。数据还是丢了。\n\n然后，你的描述确实有可能发生。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577185428,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1309984,"avatar":"https://static001.geekbang.org/account/avatar/00/13/fd/20/2761ef0e.jpg","nickname":"cheriston","note":"","ucode":"617CBFCE0925C4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":90987,"discussion_content":"对于强一致性场景，建议w>1或者等于majority，以及journal为true，否则w=0 ，数据就会丢失","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1576805031,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":163047,"user_name":"qbit","can_delete":false,"product_type":"c3","uid":1262927,"ip_address":"","ucode":"96C70A1E47B93D","user_header":"https://static001.geekbang.org/account/avatar/00/13/45/4f/f94caf47.jpg","comment_is_top":false,"comment_ctime":1576647285,"is_pvip":false,"replies":[{"id":62370,"content":"32GB只是控制数据的缓存空间大小。MongoDB服务器本身还需要内存来进行工作，如管理TCP连接，聚合、排序运算等。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1576888354,"ip_address":"","comment_id":163047,"utype":1}],"discussion_count":2,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"请问怎样限制 MongoDB 使用的总内存大小？\n将 mongod.cfg 中 storage.wiredTiger.engineConfig.cacheSizeGB 设置为 32 之后，在任务管理器中发现，MongoDB Server 占用的内存还是达到了 45 GB，相关配置如下：\n```\nstorage:\n  dbPath: E:\\MongoDB\\Server\\4.2\\data\n  journal:\n    enabled: true\n  engine: wiredTiger\n  wiredTiger:\n    engineConfig:\n         cacheSizeGB: 32\n```\n系统版本： Windows Server 2012 R2\nMondoDB 版本： 4.2.1","like_count":1,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":478228,"discussion_content":"32GB只是控制数据的缓存空间大小。MongoDB服务器本身还需要内存来进行工作，如管理TCP连接，聚合、排序运算等。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576888354,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1262927,"avatar":"https://static001.geekbang.org/account/avatar/00/13/45/4f/f94caf47.jpg","nickname":"qbit","note":"","ucode":"96C70A1E47B93D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":93111,"discussion_content":"MongoDB 有参数限制自己使用的总内存吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576907996,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":207276,"user_name":"Geek_7c4953","can_delete":false,"product_type":"c3","uid":1809168,"ip_address":"","ucode":"359745D4725D4F","user_header":"","comment_is_top":false,"comment_ctime":1587040820,"is_pvip":false,"replies":[{"id":77483,"content":"写入多数节点后，即时一个节点数据失效&#47;不可用，你的数据还在另外一个节点上。是从这个角度。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1587095683,"ip_address":"","comment_id":207276,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"为什么说写入多数集群才算安全呢？\n写入一个故障的概率如果是a，那写入两个同时故障的概率就是a平方，三个就是三次方，也就是写入的安全性应该是跟写入个数指数相关，跟集群的总数没有关系啊。","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492068,"discussion_content":"写入多数节点后，即时一个节点数据失效/不可用，你的数据还在另外一个节点上。是从这个角度。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587095683,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":165781,"user_name":"Julien","can_delete":false,"product_type":"c3","uid":1204568,"ip_address":"","ucode":"2A3F0CF46B4034","user_header":"https://static001.geekbang.org/account/avatar/00/12/61/58/7b078879.jpg","comment_is_top":false,"comment_ctime":1577322057,"is_pvip":false,"replies":[{"id":65208,"content":"“写性能是standalone mongod的好几倍”\n复制集比单机更快？还是更慢？","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1577970110,"ip_address":"","comment_id":165781,"utype":1}],"discussion_count":2,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"老师您好，我们在使用 1 primary + 2 secondaries， writeConcern：majority, j:1 的情况下，写性能是standalone mongod的好几倍，请问这个现象是正常的吗？理论上来说，客户端代码一样的情况下，即使数据需要拷贝到secondary，也不过是standalone的两倍时间。希望老师指教一下~","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":479277,"discussion_content":"“写性能是standalone mongod的好几倍”\n复制集比单机更快？还是更慢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577970110,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1204568,"avatar":"https://static001.geekbang.org/account/avatar/00/12/61/58/7b078879.jpg","nickname":"Julien","note":"","ucode":"2A3F0CF46B4034","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":114412,"discussion_content":"更慢了，慢了很多","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577971560,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":164231,"user_name":"dream","can_delete":false,"product_type":"c3","uid":1117793,"ip_address":"","ucode":"65B33D32FA8BE9","user_header":"https://static001.geekbang.org/account/avatar/00/11/0e/61/ae68f8eb.jpg","comment_is_top":false,"comment_ctime":1576910971,"is_pvip":false,"replies":[{"id":62957,"content":"后者。对应于 w:N 里面N个节点的日志落盘。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1577183509,"ip_address":"","comment_id":164231,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"老师，请问一下 j:true 是保证主节点的日志写入成功，还是保证writeConcern配置的参数对应的节点的日志写入成功才返回呢？","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":478688,"discussion_content":"后者。对应于 w:N 里面N个节点的日志落盘。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577183509,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":164220,"user_name":"dream","can_delete":false,"product_type":"c3","uid":1117793,"ip_address":"","ucode":"65B33D32FA8BE9","user_header":"https://static001.geekbang.org/account/avatar/00/11/0e/61/ae68f8eb.jpg","comment_is_top":false,"comment_ctime":1576910432,"is_pvip":false,"replies":[{"id":66778,"content":"这个就是这个课程讲的内容，你再仔细学习一边，如果觉得还是没有得到答案，可以线下联系下我 tjtang826\n\n","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1579133436,"ip_address":"","comment_id":164220,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"请问mongodb不管主节点，还是从节点，只要需要写入的数据写入到了内存中，就会响应给客户端写入成功吗？\n\nmongodb 主节点接收到写操作后，主节点的写入过程是什么样的呢？先写入内存，在写入rollback文件，在写入日志(此时从节点监听到主节点日志发生变化，同步变化到从节点进行相同的流程)，在写入磁盘。是这样的吗？","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":478683,"discussion_content":"这个就是这个课程讲的内容，你再仔细学习一边，如果觉得还是没有得到答案，可以线下联系下我 tjtang826\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579133436,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":323693,"user_name":"伪钞","can_delete":false,"product_type":"c3","uid":2164123,"ip_address":"","ucode":"7087364945A6B0","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/oOSgaSW8MFRDx6da1bicY40IVg7hoDNjYlSuTeIg93aB3nuKedhbTa2HQhXpBJmN2w0xU9icvkTDZWMzL5NVicrYw/132","comment_is_top":false,"comment_ctime":1638099626,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"这只能算是分布式的一致性吧，和SQL的事务没关系","like_count":2,"discussions":[{"author":{"id":1227492,"avatar":"https://static001.geekbang.org/account/avatar/00/12/ba/e4/6df89add.jpg","nickname":"芋头","note":"","ucode":"A9C875548E4EE5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":612943,"discussion_content":"没提到AICD特性","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1681026263,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":169047,"user_name":"yihang","can_delete":false,"product_type":"c3","uid":1012361,"ip_address":"","ucode":"A5506F085D1793","user_header":"https://static001.geekbang.org/account/avatar/00/0f/72/89/1a83120a.jpg","comment_is_top":false,"comment_ctime":1578265246,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"1.6 day01 mongodb高手课\n学习了 writeconcern 用法\n它的作用是描述写入操作的数据可靠性的保证，是一致性和性能的一个权衡选项\n例如\ninsert(数据,{writeConcern:{w:值,j:值,timeout:值}})\n* w 默认为1，如果是majority表示必须传播至集群超半数节点才返回，如果是n表示要传播到集群的n个节点才返回\n* j 为 true 表示需要写入到 journal 日志才返回，journal 有点像 mysql 的 redo log，提供了crash 恢复功能\n* wtimeout 指定了传播超时时间","like_count":2},{"had_liked":false,"id":356002,"user_name":"qxkbwl","can_delete":false,"product_type":"c3","uid":1130310,"ip_address":"四川","ucode":"B090F6CAD6984D","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Hvst0m2ko7Yvrq4nld4PjZjnfM5krGZNf20icO6kbGraV0ZxjkR7icib49ibqMc2GL1xuy5EZgpluF5TRxGwicylsvg/132","comment_is_top":false,"comment_ctime":1661912504,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"cfg = rs.conf()\n版本6:\ncfg.members[0].priority = 0\ncfg.members[0].hidden = true\ncfg.members[0].secondaryDelaySecs = 3600\nrs.reconfig(cfg)","like_count":1},{"had_liked":false,"id":351556,"user_name":"陈星宇(2.11)","can_delete":false,"product_type":"c3","uid":1450562,"ip_address":"","ucode":"970E48260B7924","user_header":"https://static001.geekbang.org/account/avatar/00/16/22/42/11674804.jpg","comment_is_top":false,"comment_ctime":1657893656,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100040001,"comment_content":"老师，对比MySQL，journal是相当于redo（用于前滚和回退），oplog是相当于binlog，mongod log相当于general log（包含slowlog、errorlog）？","like_count":1},{"had_liked":false,"id":272587,"user_name":"注意力$","can_delete":false,"product_type":"c3","uid":1142316,"ip_address":"","ucode":"7FB3399A1EAB72","user_header":"https://static001.geekbang.org/account/avatar/00/11/6e/2c/e2f3cfc0.jpg","comment_is_top":false,"comment_ctime":1610165547,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100040001,"comment_content":"老师， write concern 设置 w=None, wtimeout=None, j=None, fsync=None，在主从arbter架构中，从库挂了后，发现主库的数据没法刷盘，和rc一致性读 有关系吗","like_count":1},{"had_liked":false,"id":370561,"user_name":"🤔","can_delete":false,"product_type":"c3","uid":1616114,"ip_address":"美国","ucode":"5A80E3F01DE216","user_header":"https://static001.geekbang.org/account/avatar/00/18/a8/f2/91a7a3b4.jpg","comment_is_top":false,"comment_ctime":1678958773,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100040001,"comment_content":"事务应该是一组写操作要么都成功，要么都失败吧，本节课没有讲到","like_count":0},{"had_liked":false,"id":370031,"user_name":"数学汤家凤","can_delete":false,"product_type":"c3","uid":2029485,"ip_address":"广东","ucode":"DE84E777C384AD","user_header":"https://static001.geekbang.org/account/avatar/00/1e/f7/ad/4fd4d867.jpg","comment_is_top":false,"comment_ctime":1678279940,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100040001,"comment_content":"三节点，不推荐使用投票节点原因之一就是如果是majority，挂了一个数据节点，那么就会永久等待了？","like_count":0},{"had_liked":false,"id":365868,"user_name":"非洲黑猴子","can_delete":false,"product_type":"c3","uid":2639724,"ip_address":"美国","ucode":"F5FEAC07D562E0","user_header":"https://static001.geekbang.org/account/avatar/00/28/47/6c/78184d19.jpg","comment_is_top":false,"comment_ctime":1673162364,"is_pvip":true,"replies":null,"discussion_count":0,"race_medal":1,"score":4,"product_id":100040001,"comment_content":"MongoDB 5.0之后的版本，延迟节点的现象好像有所不同：写入之后立刻就能给客户端返回成功，但是延迟节点10s之后才能看到新插入的数据","like_count":0},{"had_liked":false,"id":359062,"user_name":"coder.js","can_delete":false,"product_type":"c3","uid":1338120,"ip_address":"重庆","ucode":"3DE173A5D23690","user_header":"https://static001.geekbang.org/account/avatar/00/14/6b/08/15c473ef.jpg","comment_is_top":false,"comment_ctime":1665215135,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100040001,"comment_content":"新版本已经不能使用 slaveDelay 了，用 secondaryDelaySecs 替换","like_count":0},{"had_liked":false,"id":323975,"user_name":"null","can_delete":false,"product_type":"c3","uid":2857634,"ip_address":"","ucode":"627A85BCBA3A10","user_header":"https://static001.geekbang.org/account/avatar/00/2b/9a/a2/1cd42c6f.jpg","comment_is_top":false,"comment_ctime":1638246376,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100040001,"comment_content":"老师 比如我又3个节点  writeconcern 设置all  1个节点写入已经成功 剩下的都写入不成功 此时返回失败  那写入成功的节点会进行回滚吗","like_count":0},{"had_liked":false,"id":298980,"user_name":"rnn","can_delete":false,"product_type":"c3","uid":1169811,"ip_address":"","ucode":"9DC14B9DCF477D","user_header":"https://static001.geekbang.org/account/avatar/00/11/d9/93/43c876e8.jpg","comment_is_top":false,"comment_ctime":1624414422,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100040001,"comment_content":"老师，最后一个例子超时之后同样插入成功，岂不是违背了majority参数的含义？因为未确认是3个节点均写入成功，而插入却成功了","like_count":0},{"had_liked":false,"id":280874,"user_name":"Ruby","can_delete":false,"product_type":"c3","uid":1741877,"ip_address":"","ucode":"78DCC0843B7F92","user_header":"https://static001.geekbang.org/account/avatar/00/1a/94/35/a5ace6ae.jpg","comment_is_top":false,"comment_ctime":1614433463,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100040001,"comment_content":"老师，请问mongodb单节点为什么不支持多表操作的事务？","like_count":0},{"had_liked":false,"id":274101,"user_name":"连边","can_delete":false,"product_type":"c3","uid":1391748,"ip_address":"","ucode":"54B5DA38449728","user_header":"https://static001.geekbang.org/account/avatar/00/15/3c/84/608f679b.jpg","comment_is_top":false,"comment_ctime":1610854552,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100040001,"comment_content":"不对，我感觉这个是集群中的事务，控制一条数据会成功写到多个节点中，而不是保证多个sql，执行成功，一起提交，执行失败，一起回滚的那种业务。","like_count":0},{"had_liked":false,"id":274099,"user_name":"连边","can_delete":false,"product_type":"c3","uid":1391748,"ip_address":"","ucode":"54B5DA38449728","user_header":"https://static001.geekbang.org/account/avatar/00/15/3c/84/608f679b.jpg","comment_is_top":false,"comment_ctime":1610853997,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":5,"product_id":100040001,"comment_content":"这个事务的解决方案，是直接在连接层面解决的？\n之前对事务的理解，就是几个sql操作不同的表都成功，这种解决方式好精辟的感觉。","like_count":0},{"had_liked":false,"id":235809,"user_name":"polk","can_delete":false,"product_type":"c3","uid":1165455,"ip_address":"","ucode":"1B6E948BA4DFAF","user_header":"https://static001.geekbang.org/account/avatar/00/11/c8/8f/e13a6552.jpg","comment_is_top":false,"comment_ctime":1595208536,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":5,"product_id":100040001,"comment_content":"原本概念里，对事务仅仅是几个sql一起成功一起失败，老师这个讲了主从的事务，受益匪浅","like_count":0},{"had_liked":false,"id":180917,"user_name":"密码123456","can_delete":false,"product_type":"c3","uid":1126593,"ip_address":"","ucode":"9889463CC0EA71","user_header":"https://static001.geekbang.org/account/avatar/00/11/30/c1/2dde6700.jpg","comment_is_top":false,"comment_ctime":1582442312,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":5,"product_id":100040001,"comment_content":"在java中 这样使用没有出现错误。\nMongoCollection  obj= md.getCollection(&quot;test&quot;);\nobj.getWriteConcern().withW(4);\n在java中 writeConcern 是这样用的吗？","like_count":0},{"had_liked":false,"id":177134,"user_name":"cording","can_delete":false,"product_type":"c3","uid":1786385,"ip_address":"","ucode":"82063AEC231613","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKlllSKrpQkhSXyNj0glDoCiaMKp23ey4Fw0nr54MKKhYAIxxU7toQuukJe2qZjwUC990ojdNmeicVQ/132","comment_is_top":false,"comment_ctime":1581299641,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":5,"product_id":100040001,"comment_content":"老师，你好，mongodb有分布式锁吗？如果有如何实现生成全局唯一ID呢？","like_count":0},{"had_liked":false,"id":163678,"user_name":"兜兜","can_delete":false,"product_type":"c3","uid":1297941,"ip_address":"","ucode":"9033348BEF5F5A","user_header":"https://static001.geekbang.org/account/avatar/00/13/ce/15/51187703.jpg","comment_is_top":false,"comment_ctime":1576766041,"is_pvip":true,"replies":null,"discussion_count":0,"race_medal":0,"score":5,"product_id":100040001,"comment_content":"writeConcern增加了写操作延时，应该一定会增加集群压力吧？毕竟延时期间，占用着资源，处理能力会下降，吞吐量也会下降，延迟太大最终成功率也会掉","like_count":0}]}