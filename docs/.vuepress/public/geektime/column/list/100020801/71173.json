{"id":71173,"title":"10 | MySQL为什么有时候会选错索引？","content":"<p>前面我们介绍过索引，你已经知道了在MySQL中一张表其实是可以支持多个索引的。但是，你写SQL语句的时候，并没有主动指定使用哪个索引。也就是说，使用哪个索引是由MySQL来确定的。</p><p>不知道你有没有碰到过这种情况，一条本来可以执行得很快的语句，却由于MySQL选错了索引，而导致执行速度变得很慢？</p><p>我们一起来看一个例子吧。</p><p>我们先建一个简单的表，表里有a、b两个字段，并分别建上索引：</p><pre><code>CREATE TABLE `t` (\n  `id` int(11) NOT NULL AUTO_INCREMENT,\n  `a` int(11) DEFAULT NULL,\n  `b` int(11) DEFAULT NULL,\n  PRIMARY KEY (`id`),\n  KEY `a` (`a`),\n  KEY `b` (`b`)\n) ENGINE=InnoDB;\n</code></pre><p>然后，我们往表t中插入10万行记录，取值按整数递增，即：(1,1,1)，(2,2,2)，(3,3,3) 直到(100000,100000,100000)。</p><p>我是用存储过程来插入数据的，这里我贴出来方便你复现：</p><pre><code>delimiter ;;\ncreate procedure idata()\nbegin\n  declare i int;\n  set i=1;\n  while(i&lt;=100000)do\n    insert into t values(i, i, i);\n    set i=i+1;\n  end while;\nend;;\ndelimiter ;\ncall idata();\n</code></pre><p>接下来，我们分析一条SQL语句：</p><pre><code>mysql&gt; select * from t where a between 10000 and 20000;\n</code></pre><p>你一定会说，这个语句还用分析吗，很简单呀，a上有索引，肯定是要使用索引a的。</p><p>你说得没错，图1显示的就是使用explain命令看到的这条语句的执行情况。</p><p><img src=\"https://static001.geekbang.org/resource/image/2c/e3/2cfce769551c6eac9bfbee0563d48fe3.png?wh=1743*159\" alt=\"\"></p><center><span class=\"reference\">图1 使用explain命令查看语句执行情况</span></center><p>从图1看上去，这条查询语句的执行也确实符合预期，key这个字段值是’a’，表示优化器选择了索引a。</p><p>不过别急，这个案例不会这么简单。在我们已经准备好的包含了10万行数据的表上，我们再做如下操作。</p><!-- [[[read_end]]] --><p><img src=\"https://static001.geekbang.org/resource/image/1e/1e/1e5ba1c2934d3b2c0d96b210a27e1a1e.png?wh=936*344\" alt=\"\"></p><center><span class=\"reference\">图2 session A和session B的执行流程</span></center><p>这里，session A的操作你已经很熟悉了，它就是开启了一个事务。随后，session B把数据都删除后，又调用了 idata这个存储过程，插入了10万行数据。</p><p>这时候，session B的查询语句select * from t where a between 10000 and 20000就不会再选择索引a了。我们可以通过慢查询日志（slow log）来查看一下具体的执行情况。</p><p>为了说明优化器选择的结果是否正确，我增加了一个对照，即：使用force index(a)来让优化器强制使用索引a（这部分内容，我还会在这篇文章的后半部分中提到）。</p><p>下面的三条SQL语句，就是这个实验过程。</p><pre><code>set long_query_time=0;\nselect * from t where a between 10000 and 20000; /*Q1*/\nselect * from t force index(a) where a between 10000 and 20000;/*Q2*/\n</code></pre><ul>\n<li>第一句，是将慢查询日志的阈值设置为0，表示这个线程接下来的语句都会被记录入慢查询日志中；</li>\n<li>第二句，Q1是session B原来的查询；</li>\n<li>第三句，Q2是加了force index(a)来和session B原来的查询语句执行情况对比。</li>\n</ul><p>如图3所示是这三条SQL语句执行完成后的慢查询日志。</p><p><img src=\"https://static001.geekbang.org/resource/image/7c/f6/7c58b9c71853b8bba1a8ad5e926de1f6.png?wh=1221*325\" alt=\"\"></p><center><span class=\"reference\">图3 slow log结果</span></center><p>可以看到，Q1扫描了10万行，显然是走了全表扫描，执行时间是40毫秒。Q2扫描了10001行，执行了21毫秒。也就是说，我们在没有使用force index的时候，MySQL用错了索引，导致了更长的执行时间。</p><p>这个例子对应的是我们平常不断地删除历史数据和新增数据的场景。这时，MySQL竟然会选错索引，是不是有点奇怪呢？今天，我们就从这个奇怪的结果说起吧。</p><h1>优化器的逻辑</h1><p>在第一篇文章中，我们就提到过，选择索引是优化器的工作。</p><p>而优化器选择索引的目的，是找到一个最优的执行方案，并用最小的代价去执行语句。在数据库里面，扫描行数是影响执行代价的因素之一。扫描的行数越少，意味着访问磁盘数据的次数越少，消耗的CPU资源越少。</p><p>当然，扫描行数并不是唯一的判断标准，优化器还会结合是否使用临时表、是否排序等因素进行综合判断。</p><p>我们这个简单的查询语句并没有涉及到临时表和排序，所以MySQL选错索引肯定是在判断扫描行数的时候出问题了。</p><p>那么，问题就是：<strong>扫描行数是怎么判断的？</strong></p><p>MySQL在真正开始执行语句之前，并不能精确地知道满足这个条件的记录有多少条，而只能根据统计信息来估算记录数。</p><p>这个统计信息就是索引的“区分度”。显然，一个索引上不同的值越多，这个索引的区分度就越好。而一个索引上不同的值的个数，我们称之为“基数”（cardinality）。也就是说，这个基数越大，索引的区分度越好。</p><p>我们可以使用show index方法，看到一个索引的基数。如图4所示，就是表t的show index 的结果 。虽然这个表的每一行的三个字段值都是一样的，但是在统计信息中，这三个索引的基数值并不同，而且其实都不准确。</p><p><img src=\"https://static001.geekbang.org/resource/image/16/d4/16dbf8124ad529fec0066950446079d4.png?wh=1850*209\" alt=\"\"></p><center><span class=\"reference\">图4 表t的show index 结果</span></center><p>那么，<strong>MySQL是怎样得到索引的基数的呢？</strong>这里，我给你简单介绍一下MySQL采样统计的方法。</p><p>为什么要采样统计呢？因为把整张表取出来一行行统计，虽然可以得到精确的结果，但是代价太高了，所以只能选择“采样统计”。</p><p>采样统计的时候，InnoDB默认会选择N个数据页，统计这些页面上的不同值，得到一个平均值，然后乘以这个索引的页面数，就得到了这个索引的基数。</p><p>而数据表是会持续更新的，索引统计信息也不会固定不变。所以，当变更的数据行数超过1/M的时候，会自动触发重新做一次索引统计。</p><p>在MySQL中，有两种存储索引统计的方式，可以通过设置参数innodb_stats_persistent的值来选择：</p><ul>\n<li>设置为on的时候，表示统计信息会持久化存储。这时，默认的N是20，M是10。</li>\n<li>设置为off的时候，表示统计信息只存储在内存中。这时，默认的N是8，M是16。</li>\n</ul><p>由于是采样统计，所以不管N是20还是8，这个基数都是很容易不准的。</p><p>但，这还不是全部。</p><p>你可以从图4中看到，这次的索引统计值（cardinality列）虽然不够精确，但大体上还是差不多的，选错索引一定还有别的原因。</p><p>其实索引统计只是一个输入，对于一个具体的语句来说，优化器还要判断，执行这个语句本身要扫描多少行。</p><p>接下来，我们再一起看看优化器预估的，这两个语句的扫描行数是多少。</p><p><img src=\"https://static001.geekbang.org/resource/image/e2/89/e2bc5f120858391d4accff05573e1289.png?wh=1606*382\" alt=\"\"></p><center><span class=\"reference\">图5 意外的explain结果</span></center><p>rows这个字段表示的是预计扫描行数。</p><p>其中，Q1的结果还是符合预期的，rows的值是104620；但是Q2的rows值是37116，偏差就大了。而图1中我们用explain命令看到的rows是只有10001行，是这个偏差误导了优化器的判断。</p><p>到这里，可能你的第一个疑问不是为什么不准，而是优化器为什么放着扫描37000行的执行计划不用，却选择了扫描行数是100000的执行计划呢？</p><p>这是因为，如果使用索引a，每次从索引a上拿到一个值，都要回到主键索引上查出整行数据，这个代价优化器也要算进去的。</p><p>而如果选择扫描10万行，是直接在主键索引上扫描的，没有额外的代价。</p><p>优化器会估算这两个选择的代价，从结果看来，优化器认为直接扫描主键索引更快。当然，从执行时间看来，这个选择并不是最优的。</p><p>使用普通索引需要把回表的代价算进去，在图1执行explain的时候，也考虑了这个策略的代价 ，但图1的选择是对的。也就是说，这个策略并没有问题。</p><p>所以冤有头债有主，MySQL选错索引，这件事儿还得归咎到没能准确地判断出扫描行数。至于为什么会得到错误的扫描行数，这个原因就作为课后问题，留给你去分析了。</p><p>既然是统计信息不对，那就修正。analyze table t 命令，可以用来重新统计索引信息。我们来看一下执行效果。</p><p><img src=\"https://static001.geekbang.org/resource/image/20/9c/209e9d3514688a3bcabbb75e54e1e49c.png?wh=1736*397\" alt=\"\"></p><center><span class=\"reference\">图6 执行analyze table t 命令恢复的explain结果</span></center><p>这回对了。</p><p>所以在实践中，如果你发现explain的结果预估的rows值跟实际情况差距比较大，可以采用这个方法来处理。</p><p>其实，如果只是索引统计不准确，通过analyze命令可以解决很多问题，但是前面我们说了，优化器可不止是看扫描行数。</p><p>依然是基于这个表t，我们看看另外一个语句：</p><pre><code>mysql&gt; select * from t where (a between 1 and 1000)  and (b between 50000 and 100000) order by b limit 1;\n</code></pre><p>从条件上看，这个查询没有符合条件的记录，因此会返回空集合。</p><p>在开始执行这条语句之前，你可以先设想一下，如果你来选择索引，会选择哪一个呢？</p><p>为了便于分析，我们先来看一下a、b这两个索引的结构图。</p><p><img src=\"https://static001.geekbang.org/resource/image/1d/b9/1d037f92063e800c3bfff3f4dbf1a2b9.png?wh=1142*856\" alt=\"\"></p><center><span class=\"reference\">图7 a、b索引的结构图</span></center><p>如果使用索引a进行查询，那么就是扫描索引a的前1000个值，然后取到对应的id，再到主键索引上去查出每一行，然后根据字段b来过滤。显然这样需要扫描1000行。</p><p>如果使用索引b进行查询，那么就是扫描索引b的最后50001个值，与上面的执行过程相同，也是需要回到主键索引上取值再判断，所以需要扫描50001行。</p><p>所以你一定会想，如果使用索引a的话，执行速度明显会快很多。那么，下面我们就来看看到底是不是这么一回事儿。</p><p>图8是执行explain的结果。</p><pre><code>mysql&gt; explain select * from t where (a between 1 and 1000) and (b between 50000 and 100000) order by b limit 1;\n</code></pre><p><img src=\"https://static001.geekbang.org/resource/image/48/b8/483bcb1ef3bb902844e80d9cbdd73ab8.png?wh=1891*163\" alt=\"\"></p><center><span class=\"reference\">图8 使用explain方法查看执行计划 2</span></center><p>可以看到，返回结果中key字段显示，这次优化器选择了索引b，而rows字段显示需要扫描的行数是50198。</p><p>从这个结果中，你可以得到两个结论：</p><ol>\n<li>\n<p>扫描行数的估计值依然不准确；</p>\n</li>\n<li>\n<p>这个例子里MySQL又选错了索引。</p>\n</li>\n</ol><h1>索引选择异常和处理</h1><p>其实大多数时候优化器都能找到正确的索引，但偶尔你还是会碰到我们上面举例的这两种情况：原本可以执行得很快的SQL语句，执行速度却比你预期的慢很多，你应该怎么办呢？</p><p><strong>一种方法是，像我们第一个例子一样，采用force index强行选择一个索引。</strong>MySQL会根据词法解析的结果分析出可能可以使用的索引作为候选项，然后在候选列表中依次判断每个索引需要扫描多少行。如果force index指定的索引在候选索引列表中，就直接选择这个索引，不再评估其他索引的执行代价。</p><p>我们来看看第二个例子。刚开始分析时，我们认为选择索引a会更好。现在，我们就来看看执行效果：</p><p><img src=\"https://static001.geekbang.org/resource/image/95/54/9582401a6bed6cb8fd803c9555750b54.png?wh=1235*115\" alt=\"\"></p><center><span class=\"reference\">图9 使用不同索引的语句执行耗时</span></center><p>可以看到，原本语句需要执行2.23秒，而当你使用force index(a)的时候，只用了0.05秒，比优化器的选择快了40多倍。</p><p>也就是说，优化器没有选择正确的索引，force index起到了“矫正”的作用。</p><p>不过很多程序员不喜欢使用force index，一来这么写不优美，二来如果索引改了名字，这个语句也得改，显得很麻烦。而且如果以后迁移到别的数据库的话，这个语法还可能会不兼容。</p><p>但其实使用force index最主要的问题还是变更的及时性。因为选错索引的情况还是比较少出现的，所以开发的时候通常不会先写上force index。而是等到线上出现问题的时候，你才会再去修改SQL语句、加上force index。但是修改之后还要测试和发布，对于生产系统来说，这个过程不够敏捷。</p><p>所以，数据库的问题最好还是在数据库内部来解决。那么，在数据库里面该怎样解决呢？</p><p>既然优化器放弃了使用索引a，说明a还不够合适，所以<strong>第二种方法就是，我们可以考虑修改语句，引导MySQL使用我们期望的索引。</strong>比如，在这个例子里，显然把“order by b limit 1” 改成 “order by b,a limit 1” ，语义的逻辑是相同的。</p><p>我们来看看改之后的效果：</p><p><img src=\"https://static001.geekbang.org/resource/image/14/94/14cd598e52a2b72dd334a42603e5b894.png?wh=1623*146\" alt=\"\"></p><center><span class=\"reference\">图10 order by b,a limit 1 执行结果</span></center><p>之前优化器选择使用索引b，是因为它认为使用索引b可以避免排序（b本身是索引，已经是有序的了，如果选择索引b的话，不需要再做排序，只需要遍历），所以即使扫描行数多，也判定为代价更小。</p><p>现在order by b,a 这种写法，要求按照b,a排序，就意味着使用这两个索引都需要排序。因此，扫描行数成了影响决策的主要条件，于是此时优化器选了只需要扫描1000行的索引a。</p><p>当然，这种修改并不是通用的优化手段，只是刚好在这个语句里面有limit 1，因此如果有满足条件的记录， order by b limit 1和order by b,a limit 1 都会返回b是最小的那一行，逻辑上一致，才可以这么做。</p><p>如果你觉得修改语义这件事儿不太好，这里还有一种改法，图11是执行效果。</p><pre><code>mysql&gt; select * from  (select * from t where (a between 1 and 1000)  and (b between 50000 and 100000) order by b limit 100)alias limit 1;\n</code></pre><p><img src=\"https://static001.geekbang.org/resource/image/b1/d7/b1a2ad43c78477d7f93dbc692cbaa0d7.png?wh=1824*165\" alt=\"\"></p><center><span class=\"reference\">图11 改写SQL的explain</span></center><p>在这个例子里，我们用limit 100让优化器意识到，使用b索引代价是很高的。其实是我们根据数据特征诱导了一下优化器，也不具备通用性。</p><p><strong>第三种方法是，在有些场景下，我们可以新建一个更合适的索引，来提供给优化器做选择，或删掉误用的索引。</strong></p><p>不过，在这个例子中，我没有找到通过新增索引来改变优化器行为的方法。这种情况其实比较少，尤其是经过DBA索引优化过的库，再碰到这个bug，找到一个更合适的索引一般比较难。</p><p>如果我说还有一个方法是删掉索引b，你可能会觉得好笑。但实际上我碰到过两次这样的例子，最终是DBA跟业务开发沟通后，发现这个优化器错误选择的索引其实根本没有必要存在，于是就删掉了这个索引，优化器也就重新选择到了正确的索引。</p><h1>小结</h1><p>今天我们一起聊了聊索引统计的更新机制，并提到了优化器存在选错索引的可能性。</p><p>对于由于索引统计信息不准确导致的问题，你可以用analyze table来解决。</p><p>而对于其他优化器误判的情况，你可以在应用端用force index来强行指定索引，也可以通过修改语句来引导优化器，还可以通过增加或者删除索引来绕过这个问题。</p><p>你可能会说，今天这篇文章后面的几个例子，怎么都没有展开说明其原理。我要告诉你的是，今天的话题，我们面对的是MySQL的bug，每一个展开都必须深入到一行行代码去量化，实在不是我们在这里应该做的事情。</p><p>所以，我把我用过的解决方法跟你分享，希望你在碰到类似情况的时候，能够有一些思路。</p><p>你平时在处理MySQL优化器bug的时候有什么别的方法，也发到评论区分享一下吧。</p><p>最后，我给你留下一个思考题。前面我们在构造第一个例子的过程中，通过session A的配合，让session B删除数据后又重新插入了一遍数据，然后就发现explain结果中，rows字段从10001变成37000多。</p><p>而如果没有session A的配合，只是单独执行delete from t 、call idata()、explain这三句话，会看到rows字段其实还是10000左右。你可以自己验证一下这个结果。</p><p>这是什么原因呢？也请你分析一下吧。</p><p>你可以把你的分析结论写在留言区里，我会在下一篇文章的末尾和你讨论这个问题。感谢你的收听，也欢迎你把这篇文章分享给更多的朋友一起阅读。</p><h1>上期问题时间</h1><p>我在上一篇文章最后留给你的问题是，如果某次写入使用了change buffer机制，之后主机异常重启，是否会丢失change buffer和数据。</p><p>这个问题的答案是不会丢失，留言区的很多同学都回答对了。虽然是只更新内存，但是在事务提交的时候，我们把change buffer的操作也记录到redo log里了，所以崩溃恢复的时候，change buffer也能找回来。</p><p>在评论区有同学问到，merge的过程是否会把数据直接写回磁盘，这是个好问题。这里，我再为你分析一下。</p><p>merge的执行流程是这样的：</p><ol>\n<li>\n<p>从磁盘读入数据页到内存（老版本的数据页）；</p>\n</li>\n<li>\n<p>从change buffer里找出这个数据页的change buffer 记录(可能有多个），依次应用，得到新版数据页；</p>\n</li>\n<li>\n<p>写redo log。这个redo log包含了数据的变更和change buffer的变更。</p>\n</li>\n</ol><p>到这里merge过程就结束了。这时候，数据页和内存中change buffer对应的磁盘位置都还没有修改，属于脏页，之后各自刷回自己的物理数据，就是另外一个过程了。</p><p>评论区留言点赞板：</p><blockquote>\n<p>@某、人 把02篇的redo log更新细节和change buffer的更新串了起来；<br>\n@Ivan 回复了其他同学的问题，并联系到Checkpoint机制；<br>\n@约书亚 问到了merge和redolog的关系。</p>\n</blockquote>","comments":[{"had_liked":false,"id":46980,"user_name":"某、人","can_delete":false,"product_type":"c1","uid":1308784,"ip_address":"","ucode":"ADB42AA12A11C1","user_header":"https://static001.geekbang.org/account/avatar/00/13/f8/70/f3a33a14.jpg","comment_is_top":true,"comment_ctime":1544014442,"is_pvip":false,"replies":[{"id":"16775","content":"1. 好问题，而且你做了个不错的对照实验。是的，加了limit 1 能减少扫描多少行，其实优化器也不确定，【得执行才知道】，所以显示的时候还是按照“最多可能扫多少行”来显示。<br><br>2. 你这个例子里，如果确实是按照b扫描了，应该肯定是ID最大值呀，除非ID最大的那个记录，a条件不满足。但是一定是“满足a条件里面最大的那个ID的”，你再验证下。<br><br> 而如果是用了a, 那就有临时表排序，临时表排序有三种算法，还分内存还是磁盘临时表… 这里展开不了了，后面《order by是怎么工作的》这篇会讲。","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544019723,"ip_address":"","comment_id":46980,"utype":1}],"discussion_count":3,"race_medal":0,"score":"9.2233723218666004e+18","product_id":100020801,"comment_content":"今天这个问题不是特别明白为什么。session A开启了一致性读,session B delete或者insert,之前记录都已经放进了undo了。二级索引的记录也写进了redo和change buffer,应该说删除了索引页也不影响session A的重复读。估计是开启了一致性读之后,在这个事务执行期间,不能释放空间,导致统计信息变大。还是需要老师解释下具体的细节<br><br>今天有两个问题,想请教下老师<br>1.我的理解是由于B是查找(50000,100000),由于B+树有序,通过二分查找找到b=50000的值,从50000往右扫描,一条一条回表查数据,在执行器上做where a(1,1000)的筛选,然后做判断是否够不够limit的数,够就结束循环。由于这里b(50000,100000)必然不存在a(1,1000),所以需要扫描5W行左右.但是如果把a改为(50001,51000),扫描行数没有变。那么是因为优化器给的扫描行数有问题还是执行器没有结束循环？为什么不结束循环?<br>(好像rows能直观展示limit起作用,必须在执行器上过滤数据,不能在索引上过滤数据,不知道为什么这样设计)<br><br>2.假设b上数据是会有很多重复的数据,b的最大值也存在多行重复<br>select * from t where (a between 1 and 1000) and (b between 50000 and 100000) order by b desc limit 1;<br>这里倒序去扫描b索引树,选取的是b值最大,id值为一个固定值(既不最大也不最小)<br>select * from t force index(a) where (a between 1 and 1000) and (b between 50000 and 100000) order by b desc limit 1;<br>由于这里选取的是a索引,排序不能用到索引,只能用优化排序.选取的是b值最大,id值最小那一行<br>这就是典型的两条相同的sql,但是索引选择的不同,出现的数据不一致。<br>所以如果是order by b,a就可以避免这种情况的引起的不一致,也可以避免堆排序造成的不一致<br>但是如果是asc没有出现这种情况。这里出现不一致,应该还不是由于堆排序造成的。这是什么原因造成的？","like_count":66,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431626,"discussion_content":"1. 好问题，而且你做了个不错的对照实验。是的，加了limit 1 能减少扫描多少行，其实优化器也不确定，【得执行才知道】，所以显示的时候还是按照“最多可能扫多少行”来显示。\n\n2. 你这个例子里，如果确实是按照b扫描了，应该肯定是ID最大值呀，除非ID最大的那个记录，a条件不满足。但是一定是“满足a条件里面最大的那个ID的”，你再验证下。\n\n 而如果是用了a, 那就有临时表排序，临时表排序有三种算法，还分内存还是磁盘临时表… 这里展开不了了，后面《order by是怎么工作的》这篇会讲。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544019723,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1934802,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/85/d2/045c63fb.jpg","nickname":"王建新","note":"","ucode":"E3151DDC0EEF0D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":348193,"discussion_content":"你这问题太长 我随便看了下，你都能描述的清楚，自己还不知道答案？有点不对劲啊，还是专门极颗时间来刷评论的，或者还是你太菜","likes_number":7,"is_delete":false,"is_hidden":false,"ctime":1612451179,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1986739,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/50/b3/9269cd59.jpg","nickname":"LWD","note":"","ucode":"DDA444DB113C01","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":587301,"discussion_content":"堆排序是不稳定算法。重复值的位置可能发生变化","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1662968375,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":47027,"user_name":"路过","can_delete":false,"product_type":"c1","uid":1316401,"ip_address":"","ucode":"7152C19ED024CC","user_header":"https://static001.geekbang.org/account/avatar/00/14/16/31/ae8adf82.jpg","comment_is_top":true,"comment_ctime":1544021198,"is_pvip":false,"replies":[{"id":"16797","content":"啊，误会了，确实是哪个索引的基数就是在哪个索引树上拿的。<br><br>你的理解是对的，我文中也是这个意思哦😓","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544026892,"ip_address":"","comment_id":47027,"utype":1}],"discussion_count":5,"race_medal":0,"score":"9.2233721844277002e+18","product_id":100020801,"comment_content":"老师，关于本章中的“基数”（cardinality）问题。既然已经为列a创建了索引，即有专门的数据页存放索引。遍历索引是很快的，从而得到“基数”的值应该很快呀。为何要到原始的数据页中，找N页，统计上面不同的值呢？有点多此一举啊。如果这样操作，会导致信息不准确，比如本来一个页中有50条数据，后来其中20条数据被删除了，空间没有被释放，这导致统计的信息就发生偏差。基数信息就更不准确了。<br>从原始页中计算“基数”，是不是考虑到索引页中的数据具有滞后性，即更新了表中数据，要过一会才更新索引页？<br>请老师指正，谢谢！<br><br>","like_count":34,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431641,"discussion_content":"啊，误会了，确实是哪个索引的基数就是在哪个索引树上拿的。\n\n你的理解是对的，我文中也是这个意思哦😓","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544026892,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1160678,"avatar":"https://static001.geekbang.org/account/avatar/00/11/b5/e6/c67f12bd.jpg","nickname":"左耳朵东","note":"","ucode":"60134ACF12BB52","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":381088,"discussion_content":"“analyze table t 命令，可以用来重新统计索引信息。”它的作用不是重新计算索引基数吗，怎么也使得预估要扫描的行数也更准确了呢？","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1624889500,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1062848,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83ersGSic8ib7OguJv6CJiaXY0s4n9C7Z51sWxTTljklFpq3ZAIWXoFTPV5oLo0GMTkqW5sYJRRnibNqOJQ/132","nickname":"walle斌","note":"","ucode":"0DB3243004951F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":293136,"discussion_content":"每次也是数据块的取，而且一般树高不超过4层。。之前的知识点有讲，一般根节点以及第二层大概率都在内存，实际就是2~3次寻址读取","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1595461594,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1780797,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/2c/3d/0bd58aa4.jpg","nickname":"Em","note":"","ucode":"32012A5C603C8A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1062848,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83ersGSic8ib7OguJv6CJiaXY0s4n9C7Z51sWxTTljklFpq3ZAIWXoFTPV5oLo0GMTkqW5sYJRRnibNqOJQ/132","nickname":"walle斌","note":"","ucode":"0DB3243004951F","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576571,"discussion_content":"大概率在内存是因为很容易被访问到吗  频繁访问所以常驻内存","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655654067,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":293136,"ip_address":""},"score":576571,"extra":""}]},{"author":{"id":1242455,"avatar":"https://static001.geekbang.org/account/avatar/00/12/f5/57/ce10fb1b.jpg","nickname":"天天向上","note":"","ucode":"0CCCA6F4DCC480","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":196064,"discussion_content":"遍历索引也需要将索引的数据页从磁盘读取吧，这样也要消耗很多时间的吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583328991,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":46844,"user_name":"bowenz","can_delete":false,"product_type":"c1","uid":1127589,"ip_address":"","ucode":"A58FF6F9E4040C","user_header":"https://static001.geekbang.org/account/avatar/00/11/34/a5/db01dc4f.jpg","comment_is_top":true,"comment_ctime":1543990354,"is_pvip":false,"replies":[{"id":"16748","content":"Session A提交早了… 从上到下按照时间顺序执行哈","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544012072,"ip_address":"","comment_id":46844,"utype":1}],"discussion_count":3,"race_medal":0,"score":"9.2233721028232991e+18","product_id":100020801,"comment_content":"在5.7.21 percona 版本实验，未出现案例1的情况 。 <br>dev02&gt; select @@global.tx_isolation,@@tx_isolation,version(),&quot;session A&quot;;<br>+-----------------------+-----------------+---------------+-----------+<br>| @@global.tx_isolation | @@tx_isolation  | version()     | session A |<br>+-----------------------+-----------------+---------------+-----------+<br>| REPEATABLE-READ       | REPEATABLE-READ | 5.7.21-20-log | session A |<br>+-----------------------+-----------------+---------------+-----------+<br>dev02&gt; start transaction with consistent snapshot;<br>Query OK, 0 rows affected (0.00 sec)<br>dev02&gt; commit;<br>Query OK, 0 rows affected (0.00 sec)<br>dev02&gt; select now() ;<br>+---------------------+<br>| now()               |<br>+---------------------+<br>| 2018-12-04 22:03:48 |<br>+---------------------+<br>1 row in set (0.00 sec)<br>dev02&gt; select @@global.tx_isolation,@@tx_isolation,version(),&quot;session B&quot;;<br>+-----------------------+-----------------+---------------+-----------+<br>| @@global.tx_isolation | @@tx_isolation  | version()     | session B |<br>+-----------------------+-----------------+---------------+-----------+<br>| REPEATABLE-READ       | REPEATABLE-READ | 5.7.21-20-log | session B |<br>+-----------------------+-----------------+---------------+-----------+<br>1 row in set, 2 warnings (0.00 sec)<br><br>dev02&gt; delete from t;<br>Query OK, 100000 rows affected (0.51 sec)<br><br>dev02&gt; call idata();<br>Query OK, 1 row affected (2 min 38.34 sec)<br><br>dev02&gt; select now();<br>+---------------------+<br>| now()               |<br>+---------------------+<br>| 2018-12-04 22:03:58 |<br>+---------------------+<br>1 row in set (0.00 sec)<br><br>dev02&gt; explain select * from t where a between 10000 and 20000;<br>| id | select_type | table | partitions | type  | possible_keys | key  | key_len | ref  | rows  | filtered | Extra                 |<br>|  1 | SIMPLE      | t     | NULL       | range | a             | a    | 5       | NULL | 10001 |   100.00 | Using index condition |","like_count":15,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431565,"discussion_content":"Session A提交早了… 从上到下按照时间顺序执行哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544012072,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":2797976,"avatar":"","nickname":"Geek_323a60","note":"","ucode":"CDC276EC255411","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":584397,"discussion_content":"在 5.7.36 版本下，好像真的不行","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1660804134,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":431565,"ip_address":"四川"},"score":584397,"extra":""}]},{"author":{"id":1341575,"avatar":"https://static001.geekbang.org/account/avatar/00/14/78/87/54eb0929.jpg","nickname":"海洋之心","note":"","ucode":"D540476207AFF4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":590350,"discussion_content":"5.7.39版本下同样没有复现","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1665702196,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"北京"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":47342,"user_name":"某、人","can_delete":false,"product_type":"c1","uid":1308784,"ip_address":"","ucode":"ADB42AA12A11C1","user_header":"https://static001.geekbang.org/account/avatar/00/13/f8/70/f3a33a14.jpg","comment_is_top":false,"comment_ctime":1544110459,"is_pvip":false,"replies":[{"id":"16890","content":"👍🏿","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544112309,"ip_address":"","comment_id":47342,"utype":1}],"discussion_count":18,"race_medal":0,"score":"1397408481659","product_id":100020801,"comment_content":"趁着答案公布之前的最后时间,再来尝试性答一下这个题<br>1.为什么没有session A,session B扫描的行数是1W<br>由于mysql是使用标记删除来删除记录的,并不从索引和数据文件中真正的删除。<br>如果delete和insert中间的间隔相对较小,purge线程还没有来得及清理该记录。<br>如果主键相同的情况下,新插入的insert会沿用之前删除的delete的记录的空间。<br>由于相同的数据量以及表大小,所以导致了统计信息没有变化<br>2.为什么开启了session A,session B扫描行数变成3W<br>由于session A开启了一致性读,目的为了保证session A的可重复读,insert只能<br>另起炉灶,不能占用delete的空间。所以出现的情况就是delete虽然删除了,但是<br>未释放空间,insert又增加了空间。导致统计信息有误","like_count":326,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431743,"discussion_content":"👍🏿","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544112309,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1068361,"avatar":"https://static001.geekbang.org/account/avatar/00/10/4d/49/28e73b9c.jpg","nickname":"明翼","note":"","ucode":"E77F86BEB3D5C1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":262896,"discussion_content":"开始事务加了镜像，为什么不用undo日志还原数据而是保留被删除的数据那？","likes_number":7,"is_delete":false,"is_hidden":false,"ctime":1589154966,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":5,"child_discussions":[{"author":{"id":1392326,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/7KvTibLByic8Eht03jsera25gTIoJEKnajulAVyRibaFic34rNjCSd3DBpjwWInJ72gBMuo1RNNoFdiay0PUSy8971Q/132","nickname":"hahahhh","note":"","ucode":"ED94DDF526F94D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1068361,"avatar":"https://static001.geekbang.org/account/avatar/00/10/4d/49/28e73b9c.jpg","nickname":"明翼","note":"","ucode":"E77F86BEB3D5C1","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":292875,"discussion_content":"有同样的疑问","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1595374540,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":262896,"ip_address":""},"score":292875,"extra":""},{"author":{"id":1015189,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/7d/95/dd73022c.jpg","nickname":"我是曾经那个少年","note":"","ucode":"9F02F7FF147D14","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1068361,"avatar":"https://static001.geekbang.org/account/avatar/00/10/4d/49/28e73b9c.jpg","nickname":"明翼","note":"","ucode":"E77F86BEB3D5C1","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":334270,"discussion_content":"Mysql数据底层是通过页存储的，删除数据，就删除记录就需要IO操作，这就是很显然的空间换时间。","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1607781330,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":262896,"ip_address":""},"score":334270,"extra":""},{"author":{"id":2552742,"avatar":"https://static001.geekbang.org/account/avatar/00/26/f3/a6/1dd784f6.jpg","nickname":"里河","note":"","ucode":"0A05A5F7A19EFA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1068361,"avatar":"https://static001.geekbang.org/account/avatar/00/10/4d/49/28e73b9c.jpg","nickname":"明翼","note":"","ucode":"E77F86BEB3D5C1","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":368862,"discussion_content":"有同样疑问","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618845854,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":262896,"ip_address":""},"score":368862,"extra":""}]},{"author":{"id":1442588,"avatar":"https://static001.geekbang.org/account/avatar/00/16/03/1c/c9fe6738.jpg","nickname":"Kvicii.Y","note":"","ucode":"446BFA633569EA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":203932,"discussion_content":"insert是当前读吧，当前读只能读最新的，但是删除标志还没来得及清理才会多出来？","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1584102974,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2571749,"avatar":"","nickname":"wdm","note":"","ucode":"E538FCDE900D6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":369053,"discussion_content":"insert是在视图创建后提交的 本身对事务A不可见了啊 为什么还要说保证一致性读","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1618912984,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1648865,"avatar":"https://static001.geekbang.org/account/avatar/00/19/28/e1/93886c86.jpg","nickname":"金重石頁⁴².₁₉₅","note":"","ucode":"38F3DD549A5676","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":229514,"discussion_content":"这样是我看到案例时产生的疑问，层主解释的太棒了","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1586659862,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1986739,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/50/b3/9269cd59.jpg","nickname":"LWD","note":"","ucode":"DDA444DB113C01","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":587303,"discussion_content":"mysql的快照有2种实现：1.能原地更新则采用undo log记录老值 2.不能原地更新则逻辑打上删除标识并新增一条记录","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662969178,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东"},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":3178022,"avatar":"https://static001.geekbang.org/account/avatar/00/30/7e/26/4f17e754.jpg","nickname":"Brian","note":"","ucode":"87D7902656C93E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1986739,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/50/b3/9269cd59.jpg","nickname":"LWD","note":"","ucode":"DDA444DB113C01","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":587308,"discussion_content":"可以解释一下，什么时候会原地更新? 谢谢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662971465,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":587303,"ip_address":"广东"},"score":587308,"extra":""},{"author":{"id":1986739,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/50/b3/9269cd59.jpg","nickname":"LWD","note":"","ucode":"DDA444DB113C01","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":3178022,"avatar":"https://static001.geekbang.org/account/avatar/00/30/7e/26/4f17e754.jpg","nickname":"Brian","note":"","ucode":"87D7902656C93E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":590073,"discussion_content":"记录更新以后大于原来空间；","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1665501292,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":587308,"ip_address":"广东"},"score":590073,"extra":""}]},{"author":{"id":1041685,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKPIrGvZ9qJOmfwy37ruzpKQXlTxA1WACHiaPWEq59tR3ID6Dp9qo7L7nlbic4TiamCSribxwqV7IKKSg/132","nickname":"Seven","note":"","ucode":"78266D8828B61B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":81336,"discussion_content":"怎么统计信息","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576242319,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1041685,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKPIrGvZ9qJOmfwy37ruzpKQXlTxA1WACHiaPWEq59tR3ID6Dp9qo7L7nlbic4TiamCSribxwqV7IKKSg/132","nickname":"Seven","note":"","ucode":"78266D8828B61B","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":153179,"discussion_content":"show index from t;","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580034945,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":81336,"ip_address":""},"score":153179,"extra":""}]},{"author":{"id":1173894,"avatar":"https://static001.geekbang.org/account/avatar/00/11/e9/86/d34800a4.jpg","nickname":"heyman","note":"","ucode":"92EF9EF1B1B1B3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":47582,"discussion_content":"所以第2种情况触发了cardinality的重新计算？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573371116,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1173894,"avatar":"https://static001.geekbang.org/account/avatar/00/11/e9/86/d34800a4.jpg","nickname":"heyman","note":"","ucode":"92EF9EF1B1B1B3","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":153182,"discussion_content":"第2种情况主要是针对扫描行数来说。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580035069,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":47582,"ip_address":""},"score":153182,"extra":""},{"author":{"id":1324122,"avatar":"https://static001.geekbang.org/account/avatar/00/14/34/5a/723311cd.jpg","nickname":"句子","note":"","ucode":"C0C20F466DF9D0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":336413,"discussion_content":"扫描行数这里为什么是37000，是怎么计算的呢？和cardinality之间的关联是什么？","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1608566666,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":153182,"ip_address":""},"score":336413,"extra":""}]}]},{"had_liked":false,"id":48072,"user_name":"WL","can_delete":false,"product_type":"c1","uid":1173771,"ip_address":"","ucode":"6277DCD776B87E","user_header":"https://static001.geekbang.org/account/avatar/00/11/e9/0b/1171ac71.jpg","comment_is_top":false,"comment_ctime":1544342266,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"461105842938","product_id":100020801,"comment_content":"把该讲内容总结为几个问题, 大家复习的时候可以先尝试回答这些问题检查自己的掌握程度:<br><br>\t1. <br>mysql如何判断一个查询的扫描行数?<br>\t2. <br>索引基数如何计算? 通过哪个参数可以设置索引统计的存储方式?<br>\t3. <br>可以重新统计索引信息的命令是什么?<br>\t4. <br>如何定位索引选择异常这样的问题?<br>\t5. <br>索引选择异常的问题可以有哪几种处理方式?<br><br>","like_count":108},{"had_liked":false,"id":46966,"user_name":"Ying","can_delete":false,"product_type":"c1","uid":1307466,"ip_address":"","ucode":"FAE36C852765F2","user_header":"https://static001.geekbang.org/account/avatar/00/13/f3/4a/4874b350.jpg","comment_is_top":false,"comment_ctime":1544011469,"is_pvip":false,"replies":[{"id":"16754","content":"👍🏿<br><br>而且发评论的时候还做了很细致地脱敏，赞","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544016444,"ip_address":"","comment_id":46966,"utype":1}],"discussion_count":12,"race_medal":0,"score":"254947081933","product_id":100020801,"comment_content":"现学现用 今天有个500万的表 分页查询特别慢。<br>select * from table where create_time and create_time&gt;=时间戳 and  create_time&lt;=时间戳 <br>and subtype=&#39;xx&#39; and type=&#39;xx&#39; and company_id =x order by create_time limited 90,30 ;<br>已经建立了组合索引 union_index包括字段 create_time subtype  type company_id<br>但是 explain 发现竟然走了create_time 的索引<br>语句里加了一个use index(union_index) ，立马好了<br>真正的解决了客户的实际问题啊。 感谢老师","like_count":59,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431622,"discussion_content":"👍🏿\n\n而且发评论的时候还做了很细致地脱敏，赞","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544016444,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":153200,"discussion_content":"直接将createtime索引删除吧。用组合索引就够了。","likes_number":15,"is_delete":false,"is_hidden":false,"ctime":1580036870,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1446512,"avatar":"https://static001.geekbang.org/account/avatar/00/16/12/70/10faf04b.jpg","nickname":"Lywane","note":"","ucode":"2B0027AA069CE9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":128441,"discussion_content":"这个不是只需要联合索引就行了吗，create_time单列索引没有存在必要了吧","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1578640311,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1652085,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKORTofsU89GYKtywquzKuEiabvZnEOonfMYKuCPlo8GDlXqZuJdBicu0XtlaeodH4BnmHV1kldSAwQ/132","nickname":"未来怎样","note":"","ucode":"4E54EB62595B27","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":14661,"discussion_content":"最左前缀 跟where条件之后 字段的前后顺序无关，只要包含了联合索引中左方字段即可","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1568775559,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1593957,"avatar":"https://static001.geekbang.org/account/avatar/00/18/52/65/320eccb3.jpg","nickname":"王斯拉","note":"","ucode":"D00DD3CE432189","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1706,"discussion_content":"是不是如果把语句的create_time改到后面也能解决这个问题，因为最左前缀的原理。","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1562830774,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1335293,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKR3ibELhjgVicCNShZCBwvaDxibnzibggG4wUzVkS2mkDxUBZyIs87nDEdJ7PiahJBVoZcuhQ84RxAziag/132","nickname":"周治慧","note":"","ucode":"7D56C4E66BEE17","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1593957,"avatar":"https://static001.geekbang.org/account/avatar/00/18/52/65/320eccb3.jpg","nickname":"王斯拉","note":"","ucode":"D00DD3CE432189","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":186320,"discussion_content":"跟where条件的顺序没有关系,这里是因为order by的时候create_time字段原因没去选择联合索引  去掉create_time单独的索引字段即可","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1582676616,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":1706,"ip_address":""},"score":186320,"extra":""},{"author":{"id":1986739,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/50/b3/9269cd59.jpg","nickname":"LWD","note":"","ucode":"DDA444DB113C01","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1335293,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKR3ibELhjgVicCNShZCBwvaDxibnzibggG4wUzVkS2mkDxUBZyIs87nDEdJ7PiahJBVoZcuhQ84RxAziag/132","nickname":"周治慧","note":"","ucode":"7D56C4E66BEE17","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":587305,"discussion_content":"这里的情况跟排序没有关系，2个索引排序成本都一致","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662969682,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":186320,"ip_address":"广东"},"score":587305,"extra":""}]},{"author":{"id":1501671,"avatar":"","nickname":"bobo","note":"","ucode":"0A3DA38BB8925F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":141419,"discussion_content":"这里应该是mysql想用create_time索引进行排序，索引没有使用联合索引","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1579420033,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1624574,"avatar":"https://static001.geekbang.org/account/avatar/00/18/c9/fe/874b172b.jpg","nickname":"benxiong","note":"","ucode":"F6498059D439D9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":303967,"discussion_content":"请问是用了 use index 还是force index 解决的？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599439017,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1643181,"avatar":"https://static001.geekbang.org/account/avatar/00/19/12/ad/8a149930.jpg","nickname":"青城","note":"","ucode":"9C255FF808D4EF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1624574,"avatar":"https://static001.geekbang.org/account/avatar/00/18/c9/fe/874b172b.jpg","nickname":"benxiong","note":"","ucode":"F6498059D439D9","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":350297,"discussion_content":"use index和force index都可以让优化器使用指定的索引","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1613803881,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":303967,"ip_address":""},"score":350297,"extra":""}]},{"author":{"id":2086624,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/d6/e0/3ccaaa7b.jpg","nickname":"领子","note":"","ucode":"64AC4E6AB74E68","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":294541,"discussion_content":"这个写法虽然减少了回表的数量，但是走了全索引扫描","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595921291,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1758820,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/d6/64/17ac0b0c.jpg","nickname":"华华华","note":"","ucode":"D3374AF036254D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":294262,"discussion_content":"也许业务要保证唯一性，怎么随便删","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595842517,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":48974,"user_name":"Niko.","can_delete":false,"product_type":"c1","uid":1304975,"ip_address":"","ucode":"AC573B894DC693","user_header":"https://static001.geekbang.org/account/avatar/00/13/e9/8f/0de9ca55.jpg","comment_is_top":false,"comment_ctime":1544584180,"is_pvip":false,"discussion_count":36,"race_medal":0,"score":"190523145204","product_id":100020801,"comment_content":"我试了几遍 也是没有复现选错索引<br>A会话<br>mysql&gt; select @@tx_isolation;<br>+-----------------+<br>| @@tx_isolation  |<br>+-----------------+<br>| REPEATABLE-READ |<br>+-----------------+<br>1 row in set, 1 warning (0.01 sec)<br><br>mysql&gt; select @@version<br>    -&gt; ;<br>+------------+<br>| @@version  |<br>+------------+<br>| 5.7.22-log |<br>+------------+<br>1 row in set (0.00 sec)<br>mysql&gt; start transaction with consistent snapshot;<br>Query OK, 0 rows affected (0.00 sec)<br><br>B会话<br>mysql&gt; delete from t;<br>Query OK, 100000 rows affected (2.58 sec)<br><br>mysql&gt; call idata();<br>Query OK, 1 row affected (24.32 sec)<br><br>mysql&gt; explain select * from t where a between 10000 and 20000;<br>+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+<br>| id | select_type | table | partitions | type  | possible_keys | key  | key_len | ref  | rows  | filtered | Extra                 |<br>+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+<br>|  1 | SIMPLE      | t     | NULL       | range | a             | a    | 5       | NULL | 10001 |   100.00 | Using index condition |<br>+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+<br>1 row in set, 1 warning (0.00 sec)<br><br>为啥呢？ ","like_count":44,"discussions":[{"author":{"id":1228424,"avatar":"https://static001.geekbang.org/account/avatar/00/12/be/88/8d15796f.jpg","nickname":"John","note":"","ucode":"A46AF2906C38C1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":310323,"discussion_content":"老师的表应该是主键自增的，估计 SQL 发错了，下面是我复现的SQL\n```mysql\nCREATE TABLE `t` (\n  `id` int(11) AUTO_INCREMENT NOT NULL,\n  `a` int(11) DEFAULT NULL,\n  `b` int(11) DEFAULT NULL,\n  PRIMARY KEY (`id`),\n  KEY `a` (`a`),\n  KEY `b` (`b`)\n) ENGINE=InnoDB;\n\ndelimiter ;;\ncreate procedure idata()\nbegin\n  declare i int;\n  set i=1;\n  while(i<=100000)do\n    insert into t(a, b) values(i, i);\n    set i=i+1;\n  end while;\nend;;\ndelimiter ;\n\ncall idata();\n```\n至于主键自增和非自增的区别：\n- 自增的时候，对于二级索引a来说，删除掉的10w行数据和重新插入的10w行数据在其叶子节点中保存的主键字段值是不一样的，此时因为另外一个事务的一致性视图导致删除掉的10w行数据只能继续保留在索引中，使得它再次查询这些数据的时候可以查询得到。所以此时索引a里面是有20w数据的\n- 非自增，就是老师文章中发出来的建表和存储过程语句，删除掉和新增的10w行数据的主键值是一样的，所以新增的每行数据在插入的时候都会通过（a，id）的方式也定位了到了对应的删除的数据行，所以新增的数据会覆盖为最新版本，同时删除的数据行被构造为该最新版本的undo log了，此时索引中只有10w行数据。\n\n这是我个人的理解，行扫描预估是直接根据索引的page中的有多少行进行抽样检查的，因为像自增的情形，虽然说删除的10w行数据被标记为删除了，但是如果它不能彻底地从索引中移除（删除线程来不及删除或者它的undo log被其它read view引用导致不能删除），那么它就还是在该索引中的，所以利用索引a进行检索的时候，必然会检索到这些删除的索引，然后再检查它是否是标记为delete的，这个是一个有效的计算来的，所以个人理解差异应该这里。。。。。\n\n不知道说的对不对。。。","likes_number":31,"is_delete":false,"is_hidden":false,"ctime":1601776238,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":10,"child_discussions":[{"author":{"id":1229070,"avatar":"https://static001.geekbang.org/account/avatar/00/12/c1/0e/2b987d54.jpg","nickname":"蜉蝣","note":"","ucode":"77CF92496855D4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1228424,"avatar":"https://static001.geekbang.org/account/avatar/00/12/be/88/8d15796f.jpg","nickname":"John","note":"","ucode":"A46AF2906C38C1","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":310349,"discussion_content":"感谢，借助你的方法复现了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1601791774,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":310323,"ip_address":""},"score":310349,"extra":""},{"author":{"id":2299060,"avatar":"https://static001.geekbang.org/account/avatar/00/23/14/b4/6418c05a.jpg","nickname":"我的刚","note":"","ucode":"243BAE26E2295D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1228424,"avatar":"https://static001.geekbang.org/account/avatar/00/12/be/88/8d15796f.jpg","nickname":"John","note":"","ucode":"A46AF2906C38C1","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":325756,"discussion_content":"你说的很nice 牛逼克拉斯","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605425944,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":310323,"ip_address":""},"score":325756,"extra":""},{"author":{"id":2326134,"avatar":"https://static001.geekbang.org/account/avatar/00/23/7e/76/368394bf.jpg","nickname":"哦","note":"","ucode":"C776659DED9D79","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1228424,"avatar":"https://static001.geekbang.org/account/avatar/00/12/be/88/8d15796f.jpg","nickname":"John","note":"","ucode":"A46AF2906C38C1","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":331654,"discussion_content":"nice","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606922521,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":310323,"ip_address":""},"score":331654,"extra":""}]},{"author":{"id":1044546,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f0/42/7728d4f5.jpg","nickname":"艿艿","note":"","ucode":"8F727AB7A7F6B2","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":34104,"discussion_content":"我也是。。。\n\n我已经不在去模拟了，假装出现了。理解意思就好。","likes_number":19,"is_delete":false,"is_hidden":false,"ctime":1571157263,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":7,"child_discussions":[{"author":{"id":1243722,"avatar":"https://static001.geekbang.org/account/avatar/00/12/fa/4a/a31fd498.jpg","nickname":"旅人阿杰鲁","note":"","ucode":"1483D608AEDC2E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1044546,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f0/42/7728d4f5.jpg","nickname":"艿艿","note":"","ucode":"8F727AB7A7F6B2","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":283528,"discussion_content":"我居然在这里看到了芋道源码。。。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1592291667,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":34104,"ip_address":""},"score":283528,"extra":""},{"author":{"id":1044546,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f0/42/7728d4f5.jpg","nickname":"艿艿","note":"","ucode":"8F727AB7A7F6B2","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1243722,"avatar":"https://static001.geekbang.org/account/avatar/00/12/fa/4a/a31fd498.jpg","nickname":"旅人阿杰鲁","note":"","ucode":"1483D608AEDC2E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":284360,"discussion_content":"额，我也认真学习也","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1592518568,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":283528,"ip_address":""},"score":284360,"extra":""},{"author":{"id":1243722,"avatar":"https://static001.geekbang.org/account/avatar/00/12/fa/4a/a31fd498.jpg","nickname":"旅人阿杰鲁","note":"","ucode":"1483D608AEDC2E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1044546,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f0/42/7728d4f5.jpg","nickname":"艿艿","note":"","ucode":"8F727AB7A7F6B2","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":285020,"discussion_content":"我经常逛你的博客的😂😂😂，只是在这里看到有点意外","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1592716583,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":284360,"ip_address":""},"score":285020,"extra":""}]},{"author":{"id":1798979,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/73/43/ae139b1f.jpg","nickname":"博","note":"","ucode":"F7CA69FF5D09BA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":128354,"discussion_content":"估计是mysql的版本不同导致的吧，我用的也是5.7的，也没有出现该情况","likes_number":6,"is_delete":false,"is_hidden":false,"ctime":1578631634,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2459923,"avatar":"https://static001.geekbang.org/account/avatar/00/25/89/13/0d3c5008.jpg","nickname":"最好不过","note":"","ucode":"C7DBCD08402DF8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":374714,"discussion_content":"MySQL8.0没有复现","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1621324474,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1063308,"avatar":"https://static001.geekbang.org/account/avatar/00/10/39/8c/089525aa.jpg","nickname":"小乙哥","note":"","ucode":"C77E79BEA0C325","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2459923,"avatar":"https://static001.geekbang.org/account/avatar/00/25/89/13/0d3c5008.jpg","nickname":"最好不过","note":"","ucode":"C7DBCD08402DF8","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":399181,"discussion_content":"我的8.0.19也没有复现","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632917670,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":374714,"ip_address":""},"score":399181,"extra":""}]},{"author":{"id":1515223,"avatar":"https://static001.geekbang.org/account/avatar/00/17/1e/d7/7d28a531.jpg","nickname":"飞机翅膀上","note":"","ucode":"D239DFFECDBF01","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":332863,"discussion_content":"为什么非要复现呢，讲师就是描述了这样一个场景，MySQL选错索引又不是一天两天的事了。因为这是一个BUG，MySQL也在不断优化，所以高版本的可能会好一点","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1607356931,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1695608,"avatar":"https://static001.geekbang.org/account/avatar/00/19/df/78/d4946736.jpg","nickname":"很大的勇气","note":"","ucode":"7871D1C1E22F3F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1515223,"avatar":"https://static001.geekbang.org/account/avatar/00/17/1e/d7/7d28a531.jpg","nickname":"飞机翅膀上","note":"","ucode":"D239DFFECDBF01","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":577869,"discussion_content":"你看文章最后提到的问题，“为何复现索引选择错误时要，有一个session开启一个事务。” 所以说该问题还是需要研究和实践的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1656400000,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":332863,"ip_address":""},"score":577869,"extra":""}]},{"author":{"id":2083033,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/c8/d9/51288e15.jpg","nickname":"安畅","note":"","ucode":"03855E154A1AD3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":308126,"discussion_content":"没复现，依然是选择的a","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1600850821,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1649057,"avatar":"https://static001.geekbang.org/account/avatar/00/19/29/a1/41607383.jpg","nickname":"hello","note":"","ucode":"4F42DAA5DB5C38","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":2083033,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/c8/d9/51288e15.jpg","nickname":"安畅","note":"","ucode":"03855E154A1AD3","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":339391,"discussion_content":"一样没有复现","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609656565,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":308126,"ip_address":""},"score":339391,"extra":""}]},{"author":{"id":1354415,"avatar":"https://static001.geekbang.org/account/avatar/00/14/aa/af/98c5e896.jpg","nickname":"Lion","note":"","ucode":"AB9F4F373A5DF9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":304948,"discussion_content":"我的也不能复现：Server version: 5.7.28-log MySQL Community Server (GPL)","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1599720192,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1136228,"avatar":"https://static001.geekbang.org/account/avatar/00/11/56/64/b70e50c0.jpg","nickname":"山辣","note":"","ucode":"4EFEF826347809","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":301339,"discussion_content":"加一哇，我5.5和8都试了的确没有复现","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1598493745,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1036353,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/d0/41/52be7dad.jpg","nickname":"阳","note":"","ucode":"44B06F129A2C65","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":285879,"discussion_content":"5.7.30也是无法复现","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1592982760,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1591072,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIDhIpvB4hJnrY6bj9xJMK95b2XSicYJQIdavSp1dRbBUJr1gK22jgGodQIIZHP39qtDRia93d1WAVQ/132","nickname":"Seayon阿阳","note":"","ucode":"50E14D9C03669E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":541848,"discussion_content":"5.7.34-log 未曾复现","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640583997,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1194853,"avatar":"https://static001.geekbang.org/account/avatar/00/12/3b/65/3a4fc8cf.jpg","nickname":"prepared","note":"","ucode":"00E54A5C7CDCBE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":400975,"discussion_content":"5.7.12 没有复现","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633508693,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1513833,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/T47ep9TMicuHcPAYnu1vAiaxq0But7pgpLEdNKcice8sfsl1UdzDGhQorHhpbBfHOtf5vmZZe9w5Z3nAezBaxGspg/132","nickname":"黑黑","note":"","ucode":"3948F4DA211374","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":321780,"discussion_content":"5.7.31,id字段变成自增，可以复现","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604631267,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1194853,"avatar":"https://static001.geekbang.org/account/avatar/00/12/3b/65/3a4fc8cf.jpg","nickname":"prepared","note":"","ucode":"00E54A5C7CDCBE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":297010,"discussion_content":"没复现+1，mysql版本 5.7","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596727415,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1180676,"avatar":"https://static001.geekbang.org/account/avatar/00/12/04/04/0af56558.jpg","nickname":"Jc.Chen","note":"","ucode":"36886491352CD4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":267776,"discussion_content":"我也是复现不了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589686360,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1986918,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/51/66/00b24ae2.jpg","nickname":"Andy","note":"","ucode":"EC6259AAD64533","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":258171,"discussion_content":"俺也一样","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588658747,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1026960,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ab/90/52d85edf.jpg","nickname":"Alvin","note":"","ucode":"BAC5FDAF1E3E5E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":164342,"discussion_content":"me too","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581169935,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":46767,"user_name":"斜面镜子 Bill","can_delete":false,"product_type":"c1","uid":1305242,"ip_address":"","ucode":"B5505F94540D52","user_header":"https://static001.geekbang.org/account/avatar/00/13/ea/9a/02d589f9.jpg","comment_is_top":false,"comment_ctime":1543978771,"is_pvip":false,"replies":[{"id":"16697","content":"👍🏿","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1543982866,"ip_address":"","comment_id":46767,"utype":1}],"discussion_count":4,"race_medal":0,"score":"181932605203","product_id":100020801,"comment_content":"问题的思考：<br>我理解 session A 开启的事务对 session B的delete操作后的索引数据的统计时效产生了影响，因为需要保证事务A的重复读，在数据页没有实际删除，而索引的统计选择了N个数据页，这部分数据页不收到前台事务的影响，所以整体统计值会变大，直接影响了索引选择的准确性；","like_count":42,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431538,"discussion_content":"👍🏿","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1543982866,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1810051,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTK0uyg1IicbEhLwsgM2A2ROoyVdWdmUqZfQfs6G67w9m3hdRNBMOQJatQoACj3qNGgj2KVIgricaYiaQ/132","nickname":"木得感情的编码机器","note":"","ucode":"9C6CD47ADCB8E6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":169869,"discussion_content":"兄弟，我觉得你的回答比置顶回答更容易理解。赞！","likes_number":7,"is_delete":false,"is_hidden":false,"ctime":1581651532,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1041685,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKPIrGvZ9qJOmfwy37ruzpKQXlTxA1WACHiaPWEq59tR3ID6Dp9qo7L7nlbic4TiamCSribxwqV7IKKSg/132","nickname":"Seven","note":"","ucode":"78266D8828B61B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":81337,"discussion_content":"基数是怎么计算的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576242375,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1041685,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKPIrGvZ9qJOmfwy37ruzpKQXlTxA1WACHiaPWEq59tR3ID6Dp9qo7L7nlbic4TiamCSribxwqV7IKKSg/132","nickname":"Seven","note":"","ucode":"78266D8828B61B","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":153205,"discussion_content":"采样统计时，InnoDB默认会选择N个数据页，统计这些页面上的不同值，得到一个平均值，然后乘以这个索引的页面数，就得到了这个索引的基数。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580037588,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":81337,"ip_address":""},"score":153205,"extra":""}]}]},{"had_liked":false,"id":65022,"user_name":"梁中华","can_delete":false,"product_type":"c1","uid":1006789,"ip_address":"","ucode":"52FE40242CBAD0","user_header":"https://static001.geekbang.org/account/avatar/00/0f/5c/c5/1231d633.jpg","comment_is_top":false,"comment_ctime":1549004819,"is_pvip":true,"replies":[{"id":"23040","content":"好问题<br>where  A in (a,b,c) AND B in (x,y,z)<br>会转成<br> <br>(A=a and B=x) or (A=a and B=y) or (A=a and B=z) or<br>(A=b and B=x) or (A=b and B=y) or (A=b and B=z) or<br>(A=c and B=x) or (A=c and B=y) or (A=c and B=z) ","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1549008398,"ip_address":"","comment_id":65022,"utype":1}],"discussion_count":17,"race_medal":1,"score":"177642663955","product_id":100020801,"comment_content":"假如要查 A in () AND B in (), 怎么建索引?","like_count":41,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438280,"discussion_content":"好问题\nwhere  A in (a,b,c) AND B in (x,y,z)\n会转成\n \n(A=a and B=x) or (A=a and B=y) or (A=a and B=z) or\n(A=b and B=x) or (A=b and B=y) or (A=b and B=z) or\n(A=c and B=x) or (A=c and B=y) or (A=c and B=z) ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1549008398,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":2,"child_discussions":[{"author":{"id":2822072,"avatar":"","nickname":"600988277","note":"","ucode":"2071F6F66087CF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":532170,"discussion_content":"转成\n \n(A=a and B=x) or (A=a and B=y) or (A=a and B=z) or\n(A=b and B=x) or (A=b and B=y) or (A=b and B=z) or\n(A=c and B=x) or (A=c and B=y) or (A=c and B=z)\n因为or的原因，这个语句是不走索引的吧，会造成全表扫描","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637548847,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":438280,"ip_address":""},"score":532170,"extra":"{\"user_type\":1}"},{"author":{"id":2633486,"avatar":"https://static001.geekbang.org/account/avatar/00/28/2f/0e/d61a9a47.jpg","nickname":"2Years","note":"","ucode":"9CC611009FCA4E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2822072,"avatar":"","nickname":"600988277","note":"","ucode":"2071F6F66087CF","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":549952,"discussion_content":"a,b都有索引是会走的吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644309769,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":532170,"ip_address":""},"score":549952,"extra":""}]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":153207,"discussion_content":"将A,B建立联合索引就行吧。","likes_number":7,"is_delete":false,"is_hidden":false,"ctime":1580037694,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1124075,"avatar":"https://static001.geekbang.org/account/avatar/00/11/26/eb/24e0ac9c.jpg","nickname":"嬴梦川","note":"","ucode":"104CDFD26A1711","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":362098,"discussion_content":"可见，计算机世界里面其实没有捷径，归根结底都是“暴力破击”“遍历”。只不过，如果采用了索引等结构，遍历次数会大大减小罢了","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1616849789,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1235750,"avatar":"https://static001.geekbang.org/account/avatar/00/12/db/26/3c8d68fb.jpg","nickname":"天使梦泪","note":"","ucode":"782991747DD424","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":3274,"discussion_content":"可以创建（a,x,y,z）(b,x,y,z)  (c,x,y,z)三个联合索引，对吗？","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1564370424,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":10,"child_discussions":[{"author":{"id":1308783,"avatar":"https://static001.geekbang.org/account/avatar/00/13/f8/6f/080973cf.jpg","nickname":"Edward","note":"","ucode":"10FAADF92D05F4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1235750,"avatar":"https://static001.geekbang.org/account/avatar/00/12/db/26/3c8d68fb.jpg","nickname":"天使梦泪","note":"","ucode":"782991747DD424","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":7022,"discussion_content":"a x y z是值，字段是A和B，此处建立AB联合索引即可","likes_number":19,"is_delete":false,"is_hidden":false,"ctime":1567269278,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":3274,"ip_address":""},"score":7022,"extra":""},{"author":{"id":1241420,"avatar":"https://static001.geekbang.org/account/avatar/00/12/f1/4c/8db65c40.jpg","nickname":"Felix.Wong😈 ིོ༽","note":"","ucode":"033F90CE6E8AF4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1235750,"avatar":"https://static001.geekbang.org/account/avatar/00/12/db/26/3c8d68fb.jpg","nickname":"天使梦泪","note":"","ucode":"782991747DD424","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":159048,"discussion_content":"感谢你给我枯燥的学习中带来点乐趣，没忍住，不好意思","likes_number":59,"is_delete":false,"is_hidden":false,"ctime":1580650259,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":3274,"ip_address":""},"score":159048,"extra":""},{"author":{"id":1327313,"avatar":"https://static001.geekbang.org/account/avatar/00/14/40/d1/fb6f402a.jpg","nickname":"melon","note":"","ucode":"AFBE9426C10AFA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1241420,"avatar":"https://static001.geekbang.org/account/avatar/00/12/f1/4c/8db65c40.jpg","nickname":"Felix.Wong😈 ིོ༽","note":"","ucode":"033F90CE6E8AF4","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":184286,"discussion_content":"我也笑了 哈哈哈 😄","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1582551856,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":159048,"ip_address":""},"score":184286,"extra":""}]},{"author":{"id":1049017,"avatar":"https://static001.geekbang.org/account/avatar/00/10/01/b9/73435279.jpg","nickname":"学习学个屁","note":"","ucode":"DF2D61E6FB2FCE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":405890,"discussion_content":"哈哈哈哈，学到了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634656238,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":46885,"user_name":"Leon📷","can_delete":false,"product_type":"c1","uid":1219496,"ip_address":"","ucode":"B9BBD1EFAAE5A2","user_header":"https://static001.geekbang.org/account/avatar/00/12/9b/a8/6a391c66.jpg","comment_is_top":false,"comment_ctime":1543996913,"is_pvip":false,"replies":[{"id":"16790","content":"………<br><br>不会吧，插入10万条27分钟… 你把innodb_flush_log_at_trx_commit 和 sync_binlog都设置成0试试","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544022824,"ip_address":"","comment_id":46885,"utype":1}],"discussion_count":12,"race_medal":0,"score":"160457786865","product_id":100020801,"comment_content":"公司测试机器IO性能太差，插十万条要27分钟，做这个文章的实验要1个小时以上","like_count":37,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431585,"discussion_content":"………\n\n不会吧，插入10万条27分钟… 你把innodb_flush_log_at_trx_commit 和 sync_binlog都设置成0试试","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544022824,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1686410,"avatar":"https://static001.geekbang.org/account/avatar/00/19/bb/8a/d33d9d3f.jpg","nickname":"小菠萝🍍","note":"","ucode":"DA814203C6C062","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":221295,"discussion_content":"在循环开始之前启动一次事务，循环结束后提交，这样每次insert就不会重新启动一个事务再提交了\nCREATE DEFINER=`root`@`localhost` PROCEDURE `idata`()\nbegin\n  declare i int;\n  set i=1;\n\tSTART TRANSACTION;\n  while(i<=100000)do\n    insert into t values(i, i, i);\n    set i=i+1;\n  end while;\n\tcommit;\nend","likes_number":23,"is_delete":false,"is_hidden":false,"ctime":1586000159,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":3,"child_discussions":[{"author":{"id":1691517,"avatar":"https://static001.geekbang.org/account/avatar/00/19/cf/7d/d9085aaa.jpg","nickname":"punnpkin","note":"","ucode":"E635BD016D892F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1686410,"avatar":"https://static001.geekbang.org/account/avatar/00/19/bb/8a/d33d9d3f.jpg","nickname":"小菠萝🍍","note":"","ucode":"DA814203C6C062","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":304743,"discussion_content":"很好用","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599653524,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":221295,"ip_address":""},"score":304743,"extra":""},{"author":{"id":1365206,"avatar":"https://static001.geekbang.org/account/avatar/00/14/d4/d6/1d4543ac.jpg","nickname":"云海","note":"","ucode":"0C6CA0BE58EA21","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1686410,"avatar":"https://static001.geekbang.org/account/avatar/00/19/bb/8a/d33d9d3f.jpg","nickname":"小菠萝🍍","note":"","ucode":"DA814203C6C062","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":380092,"discussion_content":"while循环内，insert一条数据调整成多条，也会快很多吧","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1624338469,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":221295,"ip_address":""},"score":380092,"extra":""},{"author":{"id":2633486,"avatar":"https://static001.geekbang.org/account/avatar/00/28/2f/0e/d61a9a47.jpg","nickname":"2Years","note":"","ucode":"9CC611009FCA4E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1686410,"avatar":"https://static001.geekbang.org/account/avatar/00/19/bb/8a/d33d9d3f.jpg","nickname":"小菠萝🍍","note":"","ucode":"DA814203C6C062","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":549954,"discussion_content":"牛啊","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644309977,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":221295,"ip_address":""},"score":549954,"extra":""}]},{"author":{"id":1361746,"avatar":"https://static001.geekbang.org/account/avatar/00/14/c7/52/c5adf218.jpg","nickname":"喜欢地球的阿培同学","note":"","ucode":"5F97037585F857","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":6059,"discussion_content":"你如果没有设置的话，插入10W条数据，默认自动提交10W次事务的哦","likes_number":11,"is_delete":false,"is_hidden":false,"ctime":1566646791,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":3,"child_discussions":[{"author":{"id":2070879,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/99/5f/9232a19f.jpg","nickname":"Lion","note":"","ucode":"BD8DDC17EAE6FD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1361746,"avatar":"https://static001.geekbang.org/account/avatar/00/14/c7/52/c5adf218.jpg","nickname":"喜欢地球的阿培同学","note":"","ucode":"5F97037585F857","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":292998,"discussion_content":"为什么是默认提交10W此事务呢。。。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595407757,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":6059,"ip_address":""},"score":292998,"extra":""},{"author":{"id":1576711,"avatar":"https://static001.geekbang.org/account/avatar/00/18/0f/07/c09035a2.jpg","nickname":"扫地僧","note":"","ucode":"5C6A080EFE7575","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2070879,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/99/5f/9232a19f.jpg","nickname":"Lion","note":"","ucode":"BD8DDC17EAE6FD","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":294860,"discussion_content":"你没开启事物，当然是执行一次提交一次啊。你创建的函数，其实就是一个while循环，里面执行了10W的插入","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1596017009,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":292998,"ip_address":""},"score":294860,"extra":""},{"author":{"id":1649662,"avatar":"https://static001.geekbang.org/account/avatar/00/19/2b/fe/7925eb7e.jpg","nickname":"pdf","note":"","ucode":"A44250955878BB","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":2070879,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/99/5f/9232a19f.jpg","nickname":"Lion","note":"","ucode":"BD8DDC17EAE6FD","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":306403,"discussion_content":"隐式事务  auto commit  = 1","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1600263413,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":292998,"ip_address":""},"score":306403,"extra":""}]},{"author":{"id":1012361,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/72/89/1a83120a.jpg","nickname":"yihang","note":"","ucode":"A5506F085D1793","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":157743,"discussion_content":"把存储过程的代码修改一下，所有 insert 放在一个事务内就可以了","likes_number":5,"is_delete":false,"is_hidden":false,"ctime":1580513462,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2497728,"avatar":"https://static001.geekbang.org/account/avatar/00/26/1c/c0/b8ff566a.jpg","nickname":"我是大橙子132","note":"","ucode":"61660568CF07C9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":555740,"discussion_content":"“公司”机器？狗头^.^","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1647054876,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1702861,"avatar":"https://static001.geekbang.org/account/avatar/00/19/fb/cd/ea7373d6.jpg","nickname":"齐鸣","note":"","ucode":"D83001B96B49CE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":60321,"discussion_content":"你可以用分布式来插入，只需0.8秒就能插入10万条","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574727549,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":46703,"user_name":"沉浮","can_delete":false,"product_type":"c1","uid":1310165,"ip_address":"","ucode":"7F6D52DA51E309","user_header":"https://static001.geekbang.org/account/avatar/00/13/fd/d5/0194ea41.jpg","comment_is_top":false,"comment_ctime":1543972840,"is_pvip":false,"replies":[{"id":"16701","content":"是，已经修改了，谢谢。<br><br>删除的时候是标记删除，所以很快。<br>建索引是要扫描数据和真正生成索引树，是会慢些","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1543985016,"ip_address":"","comment_id":46703,"utype":1}],"discussion_count":1,"race_medal":0,"score":"138982926312","product_id":100020801,"comment_content":"图十下面第二段<br>现在 limit b,a 这种写法，要求按照 b,a 排序，就意味着使用这两个索引都需要排序。<br>应该是order by b,a吧<br>另外有个问题请教林老师，根据经验大表增加索引的时候比较慢，这个是理解的，但是删除索引的时候能做到秒删，这个什么原理呢？","like_count":32,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431511,"discussion_content":"是，已经修改了，谢谢。\n\n删除的时候是标记删除，所以很快。\n建索引是要扫描数据和真正生成索引树，是会慢些","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1543985016,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":70617,"user_name":"XD","can_delete":false,"product_type":"c1","uid":1079293,"ip_address":"","ucode":"DC9DCFB3841A4E","user_header":"https://static001.geekbang.org/account/avatar/00/10/77/fd/c6619535.jpg","comment_is_top":false,"comment_ctime":1551147448,"is_pvip":false,"replies":[{"id":"25209","content":"是的，你提到的这些，都在server层<br><br>很早之前连过滤数据都在server层，后来有了index condition pushdown下推了一点到引擎层<br><br>","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1551154871,"ip_address":"","comment_id":70617,"utype":1}],"discussion_count":1,"race_medal":0,"score":"121810231736","product_id":100020801,"comment_content":"谢谢老师的解答，我之前一直以为这个操作也是在存储层进行的。<br>那执行器调用存储层的接口是不是只能获取到最原始的数据，后续的加工，比如order，join和group操作也都是在执行器里进行的吗？对应的buffer和内存临时表也都是server层的东西？","like_count":28,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440730,"discussion_content":"是的，你提到的这些，都在server层\n\n很早之前连过滤数据都在server层，后来有了index condition pushdown下推了一点到引擎层\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551154871,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":167560,"user_name":"温故而知新可以为师矣","can_delete":false,"product_type":"c1","uid":1453053,"ip_address":"","ucode":"FADCDFA9F9E5E8","user_header":"https://static001.geekbang.org/account/avatar/00/16/2b/fd/7013289d.jpg","comment_is_top":false,"comment_ctime":1577859647,"is_pvip":false,"discussion_count":13,"race_medal":0,"score":"113247009343","product_id":100020801,"comment_content":"号外，号外，我终于把开头例子给复现了，修改建表语句（id自增），存储过程代码（不要指定id值）如下，即可复现不选择索引a问题：<br>CREATE TABLE `t` (<br>  `id` int(11) auto_increment,<br>  `a` int(11) DEFAULT NULL,<br>  `b` int(11) DEFAULT NULL,<br>  PRIMARY KEY (`id`),<br>  KEY `a` (`a`),<br>  KEY `b` (`b`)<br>) ENGINE=InnoDB;<br><br>delimiter ;;<br>create procedure idata()<br>begin<br>  declare i int;<br>  set i=1;<br>  while(i&lt;=100000)do<br>    insert into t (`a`,`b`) values(i, i);<br>    set i=i+1;<br>  end while;<br>end;;<br>delimiter ;","like_count":26,"discussions":[{"author":{"id":1152599,"avatar":"https://static001.geekbang.org/account/avatar/00/11/96/57/397ead08.jpg","nickname":"一个米屌","note":"","ucode":"8470D3FB4456F3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":218333,"discussion_content":" 8.0.19也重现了。。但是为什么呢","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1585649038,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1026960,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ab/90/52d85edf.jpg","nickname":"Alvin","note":"","ucode":"BAC5FDAF1E3E5E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":164362,"discussion_content":"感谢，我的version 是  5.7.22-log, 也是靠这个解决的。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1581171129,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1026960,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ab/90/52d85edf.jpg","nickname":"Alvin","note":"","ucode":"BAC5FDAF1E3E5E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":164361,"discussion_content":"感谢，我的version 是  5.7.22-log, 也是靠这个解决的。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1581171127,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":3030463,"avatar":"https://static001.geekbang.org/account/avatar/00/2e/3d/bf/e84ddf60.jpg","nickname":"东方天空","note":"","ucode":"9967A50C83F3CD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576443,"discussion_content":"感谢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655554176,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1261530,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKDKsicmpne7xQNocwRQ80DDZ3CzjsDoVIcH0SBiaYzS056oVOx4pEeEVeCaXE3QtsjUIEI0x1xQVTw/132","nickname":"muggle","note":"","ucode":"D78087BCAD0860","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":414820,"discussion_content":"终于复现出来了，很想知道原理","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1636901942,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2112092,"avatar":"https://static001.geekbang.org/account/avatar/00/20/3a/5c/60fdf8e2.jpg","nickname":"wtdd","note":"","ucode":"26C64BF9CCA061","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":391549,"discussion_content":"我想问问买的哪款车嘿嘿，我老爹也准备考驾照了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630504657,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1453053,"avatar":"https://static001.geekbang.org/account/avatar/00/16/2b/fd/7013289d.jpg","nickname":"温故而知新可以为师矣","note":"","ucode":"FADCDFA9F9E5E8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2112092,"avatar":"https://static001.geekbang.org/account/avatar/00/20/3a/5c/60fdf8e2.jpg","nickname":"wtdd","note":"","ucode":"26C64BF9CCA061","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":578200,"discussion_content":"斯柯达明锐","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1656570065,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":391549,"ip_address":""},"score":578200,"extra":""}]},{"author":{"id":2564230,"avatar":"","nickname":"雨声","note":"","ucode":"5ABF8607971CE7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":384245,"discussion_content":"增加事务，加快数据插入速度\ndelimiter ;;\ncreate procedure idata2()\nbegin\n  declare i int;\n  set i=1;\n  start transaction;\n  while(i<=100000)do\n    insert into t2 values(i, i, i);\n    set i=i+1;\n  end while;\n  commit;\nend;;\ndelimiter ;\ncall idata2();","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1626438850,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2564230,"avatar":"","nickname":"雨声","note":"","ucode":"5ABF8607971CE7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":382724,"discussion_content":"感谢，8.0.21也复现了。另外，在存储过程开启事务的话，插入速度也会加快。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625706809,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1130791,"avatar":"https://static001.geekbang.org/account/avatar/00/11/41/27/528144cc.jpg","nickname":"共和国长子","note":"","ucode":"C2F8F66FB23D3D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375631,"discussion_content":"原因是什么呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621780056,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1324314,"avatar":"https://static001.geekbang.org/account/avatar/00/14/35/1a/9fa38dc9.jpg","nickname":"子瞻","note":"","ucode":"5C26FF10934534","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":313791,"discussion_content":"请问第二种方法中 limit 100优化器是怎么选择的索引a?","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603093142,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1019860,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/8f/d4/c506f8b2.jpg","nickname":"阿森","note":"","ucode":"ECE79780038445","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":308099,"discussion_content":"感谢，5.7.26靠这个复现，答案上面斜面镜子朋友解释了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600846019,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1332594,"avatar":"https://static001.geekbang.org/account/avatar/00/14/55/72/8e89ce99.jpg","nickname":"何何何","note":"","ucode":"CACE8A22996A0B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":299524,"discussion_content":"感谢 8.0.21 已复现。 ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597722172,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":46997,"user_name":"张永志","can_delete":false,"product_type":"c1","uid":1208727,"ip_address":"","ucode":"E54B75EF3F63B3","user_header":"https://static001.geekbang.org/account/avatar/00/12/71/97/f1a3d398.jpg","comment_is_top":false,"comment_ctime":1544016208,"is_pvip":false,"replies":[{"id":"16772","content":"准确。<br><br>悄悄地我涨了一点信心😄","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544018620,"ip_address":"","comment_id":46997,"utype":1}],"discussion_count":10,"race_medal":0,"score":"108918198608","product_id":100020801,"comment_content":"merge那段的解释明白了change buffer操作逻辑。即change buffer变化与数据块变化是分开的，最初redo中记录的只是change buffer的变更，因为还未应用到数据块上。而merge后redo记录的是数据块、change buffer的变更。<br>是这样吧？😄","like_count":25,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431631,"discussion_content":"准确。\n\n悄悄地我涨了一点信心😄","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544018620,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1122349,"avatar":"https://static001.geekbang.org/account/avatar/00/11/20/2d/dfa5bec8.jpg","nickname":"Han","note":"","ucode":"280808D4F641AA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":313225,"discussion_content":"merge后redo记录的是数据块、change buffer的变更。 change buffer变更是指删除change buffer吗？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1603006018,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":3,"child_discussions":[{"author":{"id":1255277,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLDVXsv6JOOficLK07867AkAb21eoG5KBgYFmwhMXKJooU5B6iaIZwyDxExicokVQSiaKEwZ4qPicqVFcg/132","nickname":"拼yin世界","note":"","ucode":"9571428A12B72A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1122349,"avatar":"https://static001.geekbang.org/account/avatar/00/11/20/2d/dfa5bec8.jpg","nickname":"Han","note":"","ucode":"280808D4F641AA","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":349359,"discussion_content":"同问","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1613129944,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":313225,"ip_address":""},"score":349359,"extra":""},{"author":{"id":2362279,"avatar":"","nickname":"曾祥金","note":"","ucode":"CBBB7FC1EA00D6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1122349,"avatar":"https://static001.geekbang.org/account/avatar/00/11/20/2d/dfa5bec8.jpg","nickname":"Han","note":"","ucode":"280808D4F641AA","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":351111,"discussion_content":"同问","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1614155906,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":313225,"ip_address":""},"score":351111,"extra":""},{"author":{"id":1010344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/6a/a8/ee414a25.jpg","nickname":"公告-SRE运维实践","note":"","ucode":"86F4E48AE1D9D8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1122349,"avatar":"https://static001.geekbang.org/account/avatar/00/11/20/2d/dfa5bec8.jpg","nickname":"Han","note":"","ucode":"280808D4F641AA","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":557270,"discussion_content":"是直接修改changbuffer内容，修改内存","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1647747211,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":313225,"ip_address":""},"score":557270,"extra":""}]},{"author":{"id":1986739,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/50/b3/9269cd59.jpg","nickname":"LWD","note":"","ucode":"DDA444DB113C01","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":587312,"discussion_content":"666啊","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662973576,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1295609,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJRFRX8kNzNet7FibNvtavbVpAwK09AhIhrib9k762qWtH6mre8ickP7hM5mgZC4ytr8NnmIfmAhxMSQ/132","nickname":"老大不小","note":"","ucode":"35BCDD3CB13467","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":586152,"discussion_content":"没看懂过说的啥","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662006836,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1254801,"avatar":"https://static001.geekbang.org/account/avatar/00/13/25/91/46600294.jpg","nickname":"猴哥一一 cium","note":"","ucode":"38EC64F8D1A0B4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":312458,"discussion_content":"牛批!","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1602689894,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1453053,"avatar":"https://static001.geekbang.org/account/avatar/00/16/2b/fd/7013289d.jpg","nickname":"温故而知新可以为师矣","note":"","ucode":"FADCDFA9F9E5E8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":114333,"discussion_content":"可以说redo-log和数据相关的变化都要记录（change buffer，merge引起的原始数据变更等）。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577968730,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1006849,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/5d/01/9cd84003.jpg","nickname":"栋能","note":"","ucode":"8BD9C939D3E8E1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":96975,"discussion_content":"我咋说merge咋还要写redo log...","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577101941,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":108756,"user_name":"钱","can_delete":false,"product_type":"c1","uid":1009652,"ip_address":"","ucode":"2C92A243A463D4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg","comment_is_top":false,"comment_ctime":1561876312,"is_pvip":false,"discussion_count":4,"race_medal":0,"score":"100346124120","product_id":100020801,"comment_content":"为加深印象小结如下：<br><br>1：MySQL选错索引，啥意思？<br><br>我们认为使用K索引检索的速度会更快的，但是MySQL没有使用，决定使用什么索引是由Server层的优化器来决定的，她也是想选择最佳的方案来检索数据的，不过他也是人写的程序也是存在bug的。<br><br>2：MySQL为啥会选错索引？<br><br>优化器认为使用那个索引检索数据的速度比较快是一个需要各种因素综合评估的事情，比如：是否使用临时表、是否排序、扫描的行数多少、回表的次数等，文中的例子优化器判断失误的主要原因是扫描行数的判断存在误差，因为这个信息是采样评估得到的。索引的创建是非常的耗时的，因为需要真正的建索引的过程，但是删除索引却不需要耗费太多时间，因为是标记删除，这个是以空间换时间的思路。优化器采用采样评估出现误差的原因也在于，索引的标记删除影响的。<br><br>3：MySQL选错索引怎么破？<br><br>3-1：强制指定使用某个索引，不常用不推荐用<br><br>3-2：调整SQL语句，使优化器选择的和我们想的一样，不具有通用性<br><br>3-3：新建更合适的索引或者删除不合适的索引，是一个思路<br><br>3-4：使用analyze table可以解决索引统计信息不准确导致的索引选错的问题<br><br>这篇刷新了认知，以前从没有思考过这个问题，觉得MySQL很牛逼没有什么bug，即使有我也发现不了，如果使用是有问题也是自己不会使用。<br><br>现在还存在这个问题嘛？<br><br>通过改变使用方式就解决了，好像也不算是bug了？<br><br>","like_count":23,"discussions":[{"author":{"id":2305167,"avatar":"https://static001.geekbang.org/account/avatar/00/23/2c/8f/aa45f6c4.jpg","nickname":"lambda","note":"","ucode":"D1990B7903913B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":339698,"discussion_content":"赞","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609759102,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1324122,"avatar":"https://static001.geekbang.org/account/avatar/00/14/34/5a/723311cd.jpg","nickname":"句子","note":"","ucode":"C0C20F466DF9D0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":336415,"discussion_content":"扫描行数的判断怎么是采样得到的呢？不是基数才是采样得到吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608567325,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1324314,"avatar":"https://static001.geekbang.org/account/avatar/00/14/35/1a/9fa38dc9.jpg","nickname":"子瞻","note":"","ucode":"5C26FF10934534","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":313793,"discussion_content":"请问第二种方法中 limit 100优化器是怎么选择的索引a?","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603093170,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1324314,"avatar":"https://static001.geekbang.org/account/avatar/00/14/35/1a/9fa38dc9.jpg","nickname":"子瞻","note":"","ucode":"5C26FF10934534","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":370482,"discussion_content":"让优化器认为走索引b的代价比索引a的高，这个地方应该不一定是100，只要让优化器认为用b的代价高于用a的代价即可","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619430817,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":313793,"ip_address":""},"score":370482,"extra":""}]}]},{"had_liked":false,"id":47984,"user_name":"蚂蚁内推+v","can_delete":false,"product_type":"c1","uid":1050508,"ip_address":"","ucode":"24B10AEE54B3FD","user_header":"https://static001.geekbang.org/account/avatar/00/10/07/8c/0d886dcc.jpg","comment_is_top":false,"comment_ctime":1544280038,"is_pvip":false,"replies":[{"id":"17098","content":"其实这篇主要就是说优化器的bug😄 bug嘛就没什么道理😓","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544332604,"ip_address":"","comment_id":47984,"utype":1}],"discussion_count":4,"race_medal":0,"score":"78853691366","product_id":100020801,"comment_content":"老师，原文中：在这个例子里，我们用 limit 100 让优化器意识到，使用b索引代价是很高的。<br>问题：为什么limit 100时候，使用b索引代价高呢？和limit 1相比，赶紧没有什么质的变化啊","like_count":18,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431973,"discussion_content":"其实这篇主要就是说优化器的bug😄 bug嘛就没什么道理😓","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544332604,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2716512,"avatar":"https://static001.geekbang.org/account/avatar/00/29/73/60/469bcdfb.jpg","nickname":"李承芳","note":"","ucode":"0848375E0178E9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":403172,"discussion_content":"优化器也在赌，limit1 就是遍历1000次前只要命中1条就可以了，所以可以去赌，因为是千分一的失败率。但是换成100的话，失败率就是百分之十了，概率大大增加（这里的概率是拟人话了，其实是计算了一下查询磁盘的次数，还有回表的次数来的）","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1634023099,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2036366,"avatar":"","nickname":"吟游诗人","note":"","ucode":"27CA90D3D9C5B6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":327245,"discussion_content":"我自己的理解是，假设我是优化器，一个选择是从1000个数据里找到满足A约束条件的前100个，然后再做个排序，跟从5000个找到满足B约束条件的前100个，可能前一个选择更好？可以把100当做个变量，随着它的增大，比如把它调整到900，这时第一个选择最多也就是要遍历1000个，而第二个选择最坏要遍历5000个，以至于抵消了减少排序的优势","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1605773999,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1324314,"avatar":"https://static001.geekbang.org/account/avatar/00/14/35/1a/9fa38dc9.jpg","nickname":"子瞻","note":"","ucode":"5C26FF10934534","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":313799,"discussion_content":"这里我也不明白，可能就是老师经验丰富，找到了优化器的bug。哈哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603093480,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":46801,"user_name":"kevin","can_delete":false,"product_type":"c1","uid":1081413,"ip_address":"","ucode":"6634588DD7FD2D","user_header":"https://static001.geekbang.org/account/avatar/00/10/80/45/24c30321.jpg","comment_is_top":false,"comment_ctime":1543984403,"is_pvip":false,"replies":[{"id":"16716","content":"Redo log 和 binlog刷盘次数少了，你把100000个事务变成了100个事务。<br>","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1543990321,"ip_address":"","comment_id":46801,"utype":1}],"discussion_count":1,"race_medal":0,"score":"70263461139","product_id":100020801,"comment_content":"老师你好。我用存储过程插入100000条数据特别慢，后来我set autocommit=0,每1000条才commit，这样就快了。我想不出来这是为什么，求解惑","like_count":16,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431550,"discussion_content":"Redo log 和 binlog刷盘次数少了，你把100000个事务变成了100个事务。\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1543990321,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":46823,"user_name":"Laputa","can_delete":false,"product_type":"c1","uid":1079345,"ip_address":"","ucode":"64C157042CF138","user_header":"https://static001.geekbang.org/account/avatar/00/10/78/31/c7f8d1db.jpg","comment_is_top":false,"comment_ctime":1543986964,"is_pvip":false,"replies":[{"id":"16713","content":"Redolog buffer是在事务执行过程中，先把要写入的内容在内存里存起来，在commit阶段，一次性写入redolog file ","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1543990059,"ip_address":"","comment_id":46823,"utype":1}],"discussion_count":3,"race_medal":0,"score":"57378561812","product_id":100020801,"comment_content":"老师，redo log 是实时写入磁盘的吗？是不是还有一层所谓的“redo log buffer”？","like_count":13,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431558,"discussion_content":"Redolog buffer是在事务执行过程中，先把要写入的内容在内存里存起来，在commit阶段，一次性写入redolog file ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1543990059,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1986739,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/50/b3/9269cd59.jpg","nickname":"LWD","note":"","ucode":"DDA444DB113C01","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":587313,"discussion_content":"事务有多条语句；总不能每条都刷盘一次吧，所以需要一层buffer；buffer的刷盘也不定是当前事务发起的，因为有组提交的优化","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662973693,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1980201,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/37/29/b3af57a7.jpg","nickname":"凯文小猪","note":"","ucode":"36D8AD0229547F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":350156,"discussion_content":"不会的，大多数存储介质都会走write back策略。结合数据库原理，他们会等待server层传入commit信号","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1613728036,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":47235,"user_name":"EAGLE","can_delete":false,"product_type":"c1","uid":1303484,"ip_address":"","ucode":"5B0FE019A8C9BD","user_header":"https://static001.geekbang.org/account/avatar/00/13/e3/bc/064401c7.jpg","comment_is_top":false,"comment_ctime":1544085324,"is_pvip":false,"replies":[{"id":"16851","content":"文章说错了… 😓<br>默认按照“查询使用的索引”排序","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544089774,"ip_address":"","comment_id":47235,"utype":1}],"discussion_count":3,"race_medal":0,"score":"53083692876","product_id":100020801,"comment_content":"老师，看了一篇文章说innodb如果不加order by默认是按照主键排序的。也就是说如果不加order by，查询结果也是有一定次序的。那么如果没有业务需求，纯粹只是为了分页显示数据，不加order by也是可以的吗？","like_count":12,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431708,"discussion_content":"文章说错了… 😓\n默认按照“查询使用的索引”排序","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1544089774,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1254801,"avatar":"https://static001.geekbang.org/account/avatar/00/13/25/91/46600294.jpg","nickname":"猴哥一一 cium","note":"","ucode":"38EC64F8D1A0B4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":312459,"discussion_content":"学到了,查询默认按照“查询使用的索引”排序","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1602690140,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":370484,"discussion_content":"不加排序 ，分页会有重复数据","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619431246,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":76776,"user_name":"Shen","can_delete":false,"product_type":"c1","uid":1182167,"ip_address":"","ucode":"CFF7609A754392","user_header":"https://static001.geekbang.org/account/avatar/00/12/09/d7/ffe7b0bf.jpg","comment_is_top":false,"comment_ctime":1552706527,"is_pvip":false,"discussion_count":4,"race_medal":0,"score":"44502379487","product_id":100020801,"comment_content":"1、sessionA：start transaction with consistent snapshot;<br>2、sessionB：delete from t;<br>3、sessionB：call idata();<br>4、sessionB：explain select * from t where a between 10000 and 20000;<br>+----+-------------+-------+-------+---------------+------+---------+------+-------+-----------------------+<br>| id | select_type | table | type  | possible_keys | key  | key_len | ref  | rows  | Extra                 |<br>+----+-------------+-------+-------+---------------+------+---------+------+-------+-----------------------+<br>|  1 | SIMPLE      | t     | range | a             | a    | 5       | NULL | 10000 | Using index condition |<br>+----+-------------+-------+-------+---------------+------+---------+------+-------+-----------------------+<br><br><br>5.6.43没有复现 案例1的情况<br>","like_count":10,"discussions":[{"author":{"id":1339768,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eozpyAUaM6ra8W0icl5RFc2VmGdBCTbU84uG2qoOdtdgBFSjGOqSU2h05jwxKVVbpuyh5omcKic4ZFg/132","nickname":"李小鹏","note":"","ucode":"E325904431A4B1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":368299,"discussion_content":"必须要注意的是隔离级别。要使用repeatable read;可重复读，才能实现上面这个错误。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618648524,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1623409,"avatar":"https://static001.geekbang.org/account/avatar/00/18/c5/71/f7c43b49.jpg","nickname":"风向北吹","note":"","ucode":"2FD0BC5159E1C1","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":329788,"discussion_content":"我也试了好多次，都没有复现","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606459798,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1623409,"avatar":"https://static001.geekbang.org/account/avatar/00/18/c5/71/f7c43b49.jpg","nickname":"风向北吹","note":"","ucode":"2FD0BC5159E1C1","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":370483,"discussion_content":"id主键是自增的，且idata存储过程中insert不要写id的值，就可以复现了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619430960,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":329788,"ip_address":""},"score":370483,"extra":""}]},{"author":{"id":1599738,"avatar":"https://static001.geekbang.org/account/avatar/00/18/68/fa/103589dc.jpg","nickname":"周末音乐家","note":"","ucode":"B603D53E6576A2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":32529,"discussion_content":"MySQL啥版本","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571045043,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":48771,"user_name":"杰之7","can_delete":false,"product_type":"c1","uid":1297232,"ip_address":"","ucode":"F7DA2E21085332","user_header":"https://static001.geekbang.org/account/avatar/00/13/cb/50/66d0bd7f.jpg","comment_is_top":false,"comment_ctime":1544533310,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"44494206270","product_id":100020801,"comment_content":"通过这一讲的学习，阅读完本文，其实核心点就是优化器的索引选择，从而牵引出索引统计的更新机制，以及通过Analyze tabe来进行分析索引。当然有时避免不了可以选择简单粗暴的用Force index来进行索引选择。<br>下半部分老师通过实践上的问题给出了索引选择上的方案，一、通过Force index强行选择一个索引。二、通过修改SQL语句来修改索引，三、通过提供一个更合适的索引来给优化器做出选择。<br>学习到这里，我想写通过认真阅读老师的每一篇文章，至少我现在开始思考老师每篇文章真正的出发点是什么，然后通过老师的每一步细节来搞懂技术上的问题，不敢说有多大进步，至少我相信我在不久之后可以做数据库技术这件事，感谢和老师一同进步成长。","like_count":10,"discussions":[{"author":{"id":1120025,"avatar":"https://static001.geekbang.org/account/avatar/00/11/17/19/46fcde38.jpg","nickname":"yonyoupht","note":"","ucode":"9B3AC96150B8AD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":297899,"discussion_content":" 加油，你肯定可以。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597107082,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":46971,"user_name":"Ryoma","can_delete":false,"product_type":"c1","uid":1130590,"ip_address":"","ucode":"7F692369239692","user_header":"https://static001.geekbang.org/account/avatar/00/11/40/5e/b8fada94.jpg","comment_is_top":false,"comment_ctime":1544012721,"is_pvip":true,"replies":[{"id":"16780","content":"比分成两句快😄","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544020178,"ip_address":"","comment_id":46971,"utype":1}],"discussion_count":2,"race_medal":2,"score":"40198718385","product_id":100020801,"comment_content":"请问使用insert ... on duplicate key update对性能有什么影响呢","like_count":9,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431623,"discussion_content":"比分成两句快😄","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544020178,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2166073,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/k3YD3y3BzGDSdrwRJyJY4BXsNJibfM4uzOdDVKIAlFApR2FZCLg2ibrZtJ4vuahA3LHLW9GKzH5CMGqCDhWjhZqg/132","nickname":"戒酒的李白","note":"","ucode":"744E1A22761647","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":400328,"discussion_content":"insert update是原子的吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633235346,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":53287,"user_name":"sky","can_delete":false,"product_type":"c1","uid":1008071,"ip_address":"","ucode":"9FE5F43055D3AB","user_header":"https://static001.geekbang.org/account/avatar/00/0f/61/c7/b64ac05e.jpg","comment_is_top":false,"comment_ctime":1545622408,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"35905360776","product_id":100020801,"comment_content":"按照顺序执行，没能复现选错索引 版本5.6.33。<br>Server version: 5.6.33 MySQL Community Server (GPL)<br># Time: 181224 11:32:26<br># User@Host: root[root] @ localhost []  Id: 20852<br># Query_time: 0.012308  Lock_time: 0.000124 Rows_sent: 10001  Rows_examined: 10001<br>SET timestamp=1545622346;<br>select * from t where a between 10000 and 20000;<br># Time: 181224 11:32:32<br># User@Host: root[root] @ localhost []  Id: 20852<br># Query_time: 0.351406  Lock_time: 0.000086 Rows_sent: 0  Rows_examined: 100000<br>SET timestamp=1545622352;<br>delete from t;<br># Time: 181224 11:32:37<br># User@Host: root[root] @ localhost []  Id: 20852<br># Query_time: 3.234390  Lock_time: 0.000000 Rows_sent: 0  Rows_examined: 0<br>SET timestamp=1545622357;<br>call idata();<br># Time: 181224 11:32:40<br># User@Host: root[root] @ localhost []  Id: 20852<br># Query_time: 0.014459  Lock_time: 0.000160 Rows_sent: 10001  Rows_examined: 10001<br>SET timestamp=1545622360;<br>select * from t where a between 10000 and 20000;","like_count":8,"discussions":[{"author":{"id":1181844,"avatar":"https://static001.geekbang.org/account/avatar/00/12/08/94/2c22bd4e.jpg","nickname":"克里斯","note":"","ucode":"00B755C10AC1C3","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":327845,"discussion_content":"大佬们，帮我分析一下，为啥会选择one_name作为索引而是不two_id?\n*************************** 1. row ***************************\n        Table: one\n   Non_unique: 0\n     Key_name: PRIMARY\n Seq_in_index: 1\n  Column_name: one_id\n    Collation: A\n  Cardinality: 1\n     Sub_part: NULL\n       Packed: NULL\n         Null: \n   Index_type: BTREE\n      Comment: \nIndex_comment: \n      Visible: YES\n   Expression: NULL\n*************************** 2. row ***************************\n        Table: one\n   Non_unique: 1\n     Key_name: one_name\n Seq_in_index: 1\n  Column_name: one_name\n    Collation: A\n  Cardinality: 1\n     Sub_part: NULL\n       Packed: NULL\n         Null: YES\n   Index_type: BTREE\n      Comment: \nIndex_comment: \n      Visible: YES\n   Expression: NULL\n*************************** 3. row ***************************\n        Table: one\n   Non_unique: 1\n     Key_name: two_id\n Seq_in_index: 1\n  Column_name: two_id\n    Collation: A\n  Cardinality: 1\n     Sub_part: NULL\n       Packed: NULL\n         Null: YES\n   Index_type: BTREE\n      Comment: \nIndex_comment: \n      Visible: YES\n   Expression: NULL\n3 rows in set (0.01 sec)\n\n\n\nexplain select * from one where two_id=&#39;1&#39; and one_name=&#39;&#39; order by two_id\\G\n*************************** 1. row ***************************\n           id: 1\n  select_type: SIMPLE\n        table: one\n   partitions: NULL\n         type: ref\npossible_keys: one_name,two_id\n          key: one_name\n      key_len: 131\n          ref: const\n         rows: 1\n     filtered: 100.00\n        Extra: Using where\n1 row in set, 1 warning (0.00 sec)","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605967444,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":47032,"user_name":"某、人","can_delete":false,"product_type":"c1","uid":1308784,"ip_address":"","ucode":"ADB42AA12A11C1","user_header":"https://static001.geekbang.org/account/avatar/00/13/f8/70/f3a33a14.jpg","comment_is_top":false,"comment_ctime":1544022018,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"35903760386","product_id":100020801,"comment_content":"谢谢老师的回答.<br>1.确实有时候感觉虽然显示了扫描行数比较多,但是limit应该是起了作用的,从执行时间就能看出来。<br>2.失误,确实是应该满足a条件id最大的。<br>临时表排序之前了解过一点,1.常规排序。2.优化排序 3.优先队列排序(堆排序)<br>由于选取的字段没超过max_length_for_sort_data,所以选取的是优化排序,只需要进行一次I&#47;O。","like_count":8},{"had_liked":false,"id":70673,"user_name":"kuzicala","can_delete":false,"product_type":"c1","uid":1200531,"ip_address":"","ucode":"AD1C21328E9928","user_header":"https://static001.geekbang.org/account/avatar/00/12/51/93/ed274018.jpg","comment_is_top":false,"comment_ctime":1551161636,"is_pvip":false,"replies":[{"id":"25226","content":"对，一条条返回给server层，server层处理完再读下一个","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1551163297,"ip_address":"","comment_id":70673,"utype":1}],"discussion_count":1,"race_medal":0,"score":"31615932708","product_id":100020801,"comment_content":"请教一个疑问：<br>  存储引擎在找到一行合格的数据后 是先返回在继续查 还是一口气查完在一次性返回？ <br>我的理解是查到一行就返回 不知对否？","like_count":7,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440762,"discussion_content":"对，一条条返回给server层，server层处理完再读下一个","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551163297,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58771,"user_name":"仲玄","can_delete":false,"product_type":"c1","uid":1049139,"ip_address":"","ucode":"CA42FFC21DE0EB","user_header":"https://static001.geekbang.org/account/avatar/00/10/02/33/b4bb0b9c.jpg","comment_is_top":false,"comment_ctime":1547190652,"is_pvip":false,"replies":[{"id":"21233","content":"所以我们要加一个约定，如果innodb_flush_logs_at_trx_commit=1，就要每次提交事务的时候，确保这个事务的redo log要持久化到磁盘。<br><br>","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547194062,"ip_address":"","comment_id":58771,"utype":1}],"discussion_count":2,"race_medal":0,"score":"31611961724","product_id":100020801,"comment_content":"老师你好 , 我看你说数据写到redo log上,所以主机异常重启不会丢失, 但是redo log包括两部分：一是内存中的日志缓冲(redo log buffer)，该部分日志是易失性的；二是磁盘上的重做日志文件(redo log file)，该部分日志是持久的。 如果数据是在redo log buffer上的,是会丢失的吧?","like_count":7,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":436204,"discussion_content":"所以我们要加一个约定，如果innodb_flush_logs_at_trx_commit=1，就要每次提交事务的时候，确保这个事务的redo log要持久化到磁盘。\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547194062,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1254801,"avatar":"https://static001.geekbang.org/account/avatar/00/13/25/91/46600294.jpg","nickname":"猴哥一一 cium","note":"","ucode":"38EC64F8D1A0B4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":312461,"discussion_content":"为了方便理解,我就这样记了,刷 redo log 就是实时,搞什么异步刷盘.\n对我来说够用了.","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1602690285,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":86959,"user_name":"Geek_8c4277","can_delete":false,"product_type":"c1","uid":1448066,"ip_address":"","ucode":"D68861FEE25660","user_header":"","comment_is_top":false,"comment_ctime":1555487209,"is_pvip":false,"discussion_count":4,"race_medal":0,"score":"23030323689","product_id":100020801,"comment_content":"老师，你给的例子有误，表t的主键应该是自增主键，然后存储过程也需要改下，去掉主键的插入，这样才能重现索引选择错误。大部分同学是按照提供的建表语句去做实验的，结果都没重现，哈哈。","like_count":5,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":153221,"discussion_content":"胡扯，根本不行，依旧是10001","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1580038971,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2843604,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/63/d4/b63373c3.jpg","nickname":"金金","note":"","ucode":"807EDDCDB2E939","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":560175,"discussion_content":"8.0.28可以","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649221577,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":153221,"ip_address":""},"score":560175,"extra":""}]},{"author":{"id":2760460,"avatar":"","nickname":"BOOM","note":"","ucode":"A776D865CFD08B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":397593,"discussion_content":"版本 Ver 8.0.17 for Linux on x86_64 可以复现","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632647771,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1143234,"avatar":"","nickname":"刘瑞","note":"","ucode":"7E712BC281A8A7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":227385,"discussion_content":"请问下您的版本是什么，按照您的操作您复现了吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586487264,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":50715,"user_name":"William","can_delete":false,"product_type":"c1","uid":1346215,"ip_address":"","ucode":"55F5D9DEE485B1","user_header":"https://static001.geekbang.org/account/avatar/00/14/8a/a7/674c1864.jpg","comment_is_top":false,"comment_ctime":1545033939,"is_pvip":true,"discussion_count":2,"race_medal":0,"score":"23019870419","product_id":100020801,"comment_content":"使用navicate for  mysql  .<br><br>开启了2个查询编辑器。<br><br>在1 编辑器中  开启长事务：start TRANSACTION with CONSISTENT SNAPSHOT ; <br><br>然后到2编辑器中， 进行了 <br><br>delete from t ; <br><br>call idata();<br><br>explain select *from t where a BETWEEN  1000 and  2000 ; <br><br>依然用了 a索引。 <br><br>包括下一篇的例子，我也看了。<br>也是按照那个方式模拟的，差别就是我用的navicat ，为什么就无法重现呢。。。。","like_count":5,"discussions":[{"author":{"id":2400648,"avatar":"https://static001.geekbang.org/account/avatar/00/24/a1/88/c9ef1b75.jpg","nickname":"言午","note":"","ucode":"F0F0AAFD179DF4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":540543,"discussion_content":"应该是默认commit了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640077770,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1273813,"avatar":"https://static001.geekbang.org/account/avatar/00/13/6f/d5/3e284a71.jpg","nickname":"tlseek","note":"","ucode":"39956BA395AADF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":7955,"discussion_content":"使用navicat的命令行试试","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567739707,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":50691,"user_name":"William","can_delete":false,"product_type":"c1","uid":1346215,"ip_address":"","ucode":"55F5D9DEE485B1","user_header":"https://static001.geekbang.org/account/avatar/00/14/8a/a7/674c1864.jpg","comment_is_top":false,"comment_ctime":1545030169,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"23019866649","product_id":100020801,"comment_content":"老师，你好。 <br><br>我按照文档中的例子。没有复现选择错索引呢？<br><br>select @@global.tx_isolation,@@tx_isolation,version(),&quot;session A&quot;;<br><br><br>start transaction with consistent snapshot;<br><br>select now() ;<br><br><br>select @@global.tx_isolation,@@tx_isolation,version(),&quot;session B&quot;;<br><br><br>delete from tt;<br><br>call idata();<br><br>select now();<br><br>explain select * from tt where a between 10000 and 20000;<br><br>select @@global.tx_isolation,@@tx_isolation,version(),&quot;session A&quot;;<br><br>commit;<br><br>","like_count":5},{"had_liked":false,"id":64857,"user_name":"kyq叶鑫","can_delete":false,"product_type":"c1","uid":1129030,"ip_address":"","ucode":"0002BFD7569B06","user_header":"https://static001.geekbang.org/account/avatar/00/11/3a/46/9fd9bd26.jpg","comment_is_top":false,"comment_ctime":1548926939,"is_pvip":true,"replies":[{"id":"22946","content":"就是因为这个limit 100，让优化器算完发现用索引比较快<br><br>总之，这个其实我认为原来的优化器判断是个bug，就是提供一个思路给大家哈","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1548936716,"ip_address":"","comment_id":64857,"utype":1}],"discussion_count":3,"race_medal":0,"score":"18728796123","product_id":100020801,"comment_content":"老师您好：我反复读了几遍文章还是无法理解为什么这个语句：select * from  (select * from t where (a between 1 and 1000)  and (b between 50000 and 100000) order by b limit 100)alias limit 1可以诱导优化器选择正确的索引。。。求解惑。","like_count":4,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438208,"discussion_content":"就是因为这个limit 100，让优化器算完发现用索引比较快\n\n总之，这个其实我认为原来的优化器判断是个bug，就是提供一个思路给大家哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548936716,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1003956,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/51/b4/0d402ae8.jpg","nickname":"南桥畂翊","note":"","ucode":"A97C49A6309A42","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":38493,"discussion_content":"我也是","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571795483,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1015754,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/7f/ca/ea85bfdd.jpg","nickname":"helloworld","note":"","ucode":"00DF2FEC58D2E6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":9520,"discussion_content":"原来和我有同样的疑问","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1568181303,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":64783,"user_name":"greatcl","can_delete":false,"product_type":"c1","uid":1009449,"ip_address":"","ucode":"44D3C55394EC08","user_header":"https://static001.geekbang.org/account/avatar/00/0f/67/29/b0ec5430.jpg","comment_is_top":false,"comment_ctime":1548907635,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"18728776819","product_id":100020801,"comment_content":"老师您好，刚学习到这节内容，一直复现不了全表扫描的情况，看了下节课里面的视频，按照一样的步骤操作，Session B里最后还是走a索引，这个会是版本问题吗？在Windows上是5.7.21，Ubuntu上是5.7.23都不行。<br>我也把在Ubuntu上的操作步骤录了个视频，如果老师有时间，希望能帮忙看一下哪里出问题了，谢谢！<br>https:&#47;&#47;www.youtube.com&#47;watch?v=LSS9GUUjEmA<br>","like_count":4},{"had_liked":false,"id":53662,"user_name":"曹龙飞","can_delete":false,"product_type":"c1","uid":1198055,"ip_address":"","ucode":"DD2DF8C0E89E38","user_header":"https://static001.geekbang.org/account/avatar/00/12/47/e7/53416498.jpg","comment_is_top":false,"comment_ctime":1545706815,"is_pvip":true,"discussion_count":0,"race_medal":2,"score":"14430608703","product_id":100020801,"comment_content":"丁老师，按照图2的流程,还参考了老师下一篇文章末尾的视频,还是没有重现选错索引的情况；操作循序是没有问题，隔离级别和表的存储引擎类型我都检查了，我想问的是:这个是必现的吗？如果是必现，不出现的可能原因又有哪些呢？","like_count":3},{"had_liked":false,"id":46934,"user_name":"monkay","can_delete":false,"product_type":"c1","uid":1066182,"ip_address":"","ucode":"07C0BB8A47799A","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/pc41FOKAiabVaaKiawibEm7zglvnsYBnYeRiaSAElf9ciczovXmXmI0hOeR6U9RULFtMoqX5kobNttvwXCLsUM9Hbcg/132","comment_is_top":false,"comment_ctime":1544004352,"is_pvip":false,"replies":[{"id":"16744","content":"Merge的过程中要修改数据页，这次记数据页的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544011664,"ip_address":"","comment_id":46934,"utype":1}],"discussion_count":4,"race_medal":0,"score":"14428906240","product_id":100020801,"comment_content":"merge的第三部写redo log，不是前面的更新语句已经写了redo log了吗？为什么merge时又写一次？","like_count":3,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431609,"discussion_content":"Merge的过程中要修改数据页，这次记数据页的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544011664,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2667025,"avatar":"","nickname":"Geek_a39aea","note":"","ucode":"94E6C8088AE0CB","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":389499,"discussion_content":"merge的时候记录的是数据页的变化，merge之前记录的是change buffer的页的变化，不一样的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629295544,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1263932,"avatar":"https://static001.geekbang.org/account/avatar/00/13/49/3c/5d54c510.jpg","nickname":"静静聆听","note":"","ucode":"0A8600CB928EFE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":286950,"discussion_content":"说实话，我也觉得有点多此一举了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1593331889,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1263932,"avatar":"https://static001.geekbang.org/account/avatar/00/13/49/3c/5d54c510.jpg","nickname":"静静聆听","note":"","ucode":"0A8600CB928EFE","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":370494,"discussion_content":"merge的时候记录的是数据页的变化，merge之前记录的是change buffer的页的变化，不一样的。如果没有数据页的redo 没有办法保证数据的crash-safe","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1619434566,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":286950,"ip_address":""},"score":370494,"extra":""}]}]},{"had_liked":false,"id":319169,"user_name":"wsxzei","can_delete":false,"product_type":"c1","uid":2766280,"ip_address":"","ucode":"8527ED444BFC73","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/JHzZynEKL2CibTaxCZV3XOs1bJJFqbmwhmibd4U5njlaNVWPrbre1Qha2XUx1dcQ99iaYFl13PyjlYQ0rcl9N5vEg/132","comment_is_top":false,"comment_ctime":1635651151,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10225585743","product_id":100020801,"comment_content":"请教下各位同学老师，为什么加了a索引后扫描行数估计为37000行，而不是20000多行。（考虑到标记删除的数据，应该是正确结果的两倍？）","like_count":2},{"had_liked":false,"id":263978,"user_name":"Wangyf","can_delete":false,"product_type":"c1","uid":2226219,"ip_address":"","ucode":"349068A07CB1D4","user_header":"https://static001.geekbang.org/account/avatar/00/21/f8/2b/339660f1.jpg","comment_is_top":false,"comment_ctime":1606306776,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"10196241368","product_id":100020801,"comment_content":"有一说一这节是迄今为止最模糊的一节了，很多概念轻轻一扫就过去了，完全没有写明白。看了别的同学的笔记，说明并不是我一个人觉得某些地方很模糊。可能作者工作能力确实很强，但是在这篇文章上的某些地方，写的着实垃圾得不行，看了很多遍依然是有很多地方没有弄清楚，而且这专栏早已更新完毕，有问题也不一定能得到回答，真亏。<br><br>讲道理选错索引，是优化器觉得回表、磁盘 IO 等开销过大，它做出了自己觉得划算的选择。何不使用 trace 工具，得到一个 json 文件，然后看里面的对于每一个索引，优化器做出的判断。","like_count":2},{"had_liked":false,"id":256800,"user_name":"Pluto","can_delete":false,"product_type":"c1","uid":1324404,"ip_address":"","ucode":"CD99ED8487BC7D","user_header":"https://static001.geekbang.org/account/avatar/00/14/35/74/8eaee356.jpg","comment_is_top":false,"comment_ctime":1603756739,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"10193691331","product_id":100020801,"comment_content":"试了几次没有选错索引，不是很理解","like_count":2,"discussions":[{"author":{"id":1015184,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/7d/90/abb7bfe3.jpg","nickname":"fourge","note":"","ucode":"F3E3FFC4990358","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":582576,"discussion_content":"创建表结构的时候去掉主键自增属性，就可以复现。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659513810,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":227779,"user_name":"haruki","can_delete":false,"product_type":"c1","uid":1233609,"ip_address":"","ucode":"EE1BA166F20466","user_header":"https://static001.geekbang.org/account/avatar/00/12/d2/c9/f262f947.jpg","comment_is_top":false,"comment_ctime":1592478228,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10182412820","product_id":100020801,"comment_content":"老师有个问题想问下：最开始数据页不在内存，更新操作记录到change buffer中，然后也在redo log 中记录了一条change buffer的变更，然后也记录binlog并fsync到磁盘，然后redo log变为commit，是这样一个过程吗？<br>如果是的话，为什么merge的时候还要再写一次redo log？还是说未merge之前，redo log记录的是change buffer的变更，merge之后记录的是数据页的变更。如果是这样的话，这两种不同的变更记录是不是有什么标记来区分呢？","like_count":2},{"had_liked":false,"id":161975,"user_name":"小码渣","can_delete":false,"product_type":"c1","uid":1723655,"ip_address":"","ucode":"8432409D9616D1","user_header":"https://static001.geekbang.org/account/avatar/00/1a/4d/07/7d331b04.jpg","comment_is_top":false,"comment_ctime":1576420393,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10166354985","product_id":100020801,"comment_content":"老师 不知道现在您还能看到问题吗？<br>看完这章，有个地方有点不明白：<br>在扫描行数是怎么判断的下面有说到mysql 只能根据统计信息来估算记录数，但是后面又说 其实索引统计只是一个输入，对于一个具体的语句来说，有优化器还要判断执行这个语句本身要扫描多少行！既然说需要用到基数来估算记录数，后面怎么又说还要判断扫描多少行，这个扫描的不是只和统计信息也就是基数相关吗 ？ ","like_count":2},{"had_liked":false,"id":47174,"user_name":"TiTi","can_delete":false,"product_type":"c1","uid":1127343,"ip_address":"","ucode":"58F19596A1EF4C","user_header":"https://static001.geekbang.org/account/avatar/00/11/33/af/dda311cf.jpg","comment_is_top":false,"comment_ctime":1544067279,"is_pvip":false,"replies":[{"id":"16832","content":"写redo log文件，是在更新内存之后的。<br>","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544071101,"ip_address":"","comment_id":47174,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10134001871","product_id":100020801,"comment_content":"看了老师对于上一期思考题的解答，“虽然是只更新内存，但是在事务提交的时候，我们把 change buffer的操作也记录到 redo log 里了，所以崩溃恢复的时候，change buffer也能够找回来 ”，难道记录redo log是在更新change buffer内存内容之前就做好的吗？照您的说法，事务提交也是在更新内存之前，从而保证写内存时断电，change buffer的内容依然保存在redo log里？有点颠覆我的三观啊","like_count":2,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431687,"discussion_content":"写redo log文件，是在更新内存之后的。\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544071101,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":47042,"user_name":"做梦到天亮list","can_delete":false,"product_type":"c1","uid":1314060,"ip_address":"","ucode":"6EE25EBC17C26D","user_header":"https://static001.geekbang.org/account/avatar/00/14/0d/0c/3dbffd56.jpg","comment_is_top":false,"comment_ctime":1544025155,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10133959747","product_id":100020801,"comment_content":"舒服了","like_count":2},{"had_liked":false,"id":46882,"user_name":"☞","can_delete":false,"product_type":"c1","uid":1302793,"ip_address":"","ucode":"6FAEF05F234D2A","user_header":"https://static001.geekbang.org/account/avatar/00/13/e1/09/9483f537.jpg","comment_is_top":false,"comment_ctime":1543996579,"is_pvip":false,"replies":[{"id":"16791","content":"不能，或者低峰期执行","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544022845,"ip_address":"","comment_id":46882,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10133931171","product_id":100020801,"comment_content":"老师anlyze table或者optimize table都是会锁表的吧，线上可以直接执行吗？","like_count":2,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431584,"discussion_content":"不能，或者低峰期执行","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544022845,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":46783,"user_name":"萧若愚","can_delete":false,"product_type":"c1","uid":1081558,"ip_address":"","ucode":"E9AD6D1F65E932","user_header":"https://static001.geekbang.org/account/avatar/00/10/80/d6/1f78bc57.jpg","comment_is_top":false,"comment_ctime":1543980777,"is_pvip":false,"replies":[{"id":"16698","content":"这个问题会在后面《乱码怎么办》中展开哈。<br><br>先简单回答一个，字段名的乱码是改不了了，返回结果的schema信息固定只能用utf8, utf8不认识表情符号…","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1543983039,"ip_address":"","comment_id":46783,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10133915369","product_id":100020801,"comment_content":"请教个问题，如果一个表的字段名中包含表情符号比如 a😇，查询表的结果中字段名变为a？，该表的字符集已设为 utf8_mb4。查看 information_schema 表中字段名也是a？，发现 information_schema 表的默认字符集是 utf8。查询时若条件语句中用到该字段名时，用`a?`，`a😇`，以及 a😇 都可正确查询到结果，这是为什么？还有，如何查询出正确的字段名，即查询结果中为 a😇 而不是 a?。谢谢！","like_count":2,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431543,"discussion_content":"这个问题会在后面《乱码怎么办》中展开哈。\n\n先简单回答一个，字段名的乱码是改不了了，返回结果的schema信息固定只能用utf8, utf8不认识表情符号…","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1543983039,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":46700,"user_name":"柚子","can_delete":false,"product_type":"c1","uid":1002136,"ip_address":"","ucode":"7641A699DA0CFD","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/NhbRicjvf8v3K6D3v1FtOicxOciaPZQsCjCmuGCqea4vJeRVaLicKLpAcFQlcTgLvczBWY7SYDkeOtibxXj1PGl7Nug/132","comment_is_top":false,"comment_ctime":1543972636,"is_pvip":true,"replies":[{"id":"16681","content":"是不是记反了… 应该是a 是varchar 类型，然后SQL是 a=1, 改成’1’就好了？<br>这个是跟类型转化规则有关，我们会在后面文章提到","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1543974770,"ip_address":"","comment_id":46700,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10133907228","product_id":100020801,"comment_content":"我以前遇到过一次，字段a类型是int，where a=‘1’,条件值是字符串类型，最后发现没有用到索引，改成数值1就用到了，只在那一台机子复现了，请问这是mysql有这样设计么，是有配置控制的么","like_count":2,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431510,"discussion_content":"是不是记反了… 应该是a 是varchar 类型，然后SQL是 a=1, 改成’1’就好了？\n这个是跟类型转化规则有关，我们会在后面文章提到","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1543974770,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":46674,"user_name":"天王","can_delete":false,"product_type":"c1","uid":1239337,"ip_address":"","ucode":"C074B2F9A5F007","user_header":"https://static001.geekbang.org/account/avatar/00/12/e9/29/629d9bb0.jpg","comment_is_top":false,"comment_ctime":1543970648,"is_pvip":false,"replies":[{"id":"16677","content":"1. 一般不是，但是不影响这个逻辑哈<br>2. 有可能的, index_merge算法可以。就是你说的各自选出ID。这个过程需要画个图讲比较清楚，我放到答疑文章中。<br> ","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1543974563,"ip_address":"","comment_id":46674,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10133905240","product_id":100020801,"comment_content":"请教几个问题  1 索引的基数＝页面不同值的平均值数量*索引的页面数，什么是索引的页面数，索引是在页面上连续保存的？2 一个表有多个索引的情况，where条件里面有多个索引列的条件，每次都只能走一个索引吗，能都优化让走多个索引吗，不能同时走多个索引的原因是什么？","like_count":2,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431504,"discussion_content":"1. 一般不是，但是不影响这个逻辑哈\n2. 有可能的, index_merge算法可以。就是你说的各自选出ID。这个过程需要画个图讲比较清楚，我放到答疑文章中。\n ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1543974563,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":278096,"user_name":"郑喜亮","can_delete":false,"product_type":"c1","uid":1450420,"ip_address":"","ucode":"9E47DC9361B6D3","user_header":"https://static001.geekbang.org/account/avatar/00/16/21/b4/7fb0d713.jpg","comment_is_top":false,"comment_ctime":1612759139,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5907726435","product_id":100020801,"comment_content":"没有真实删除，再插入时页面利用率仅有约50%，所以统计结果放大了约四倍。不过有个疑问，为什么统计时不判断下删除标识？另外，既然是采样，为什么不做一下平均页面利用率的采样计算？如果说删除担心回滚，那不计算页面利用率只能是为了性能考虑？","like_count":1},{"had_liked":false,"id":273217,"user_name":"Ansyear","can_delete":false,"product_type":"c1","uid":1629257,"ip_address":"","ucode":"489CE96852EA2C","user_header":"https://static001.geekbang.org/account/avatar/00/18/dc/49/43ae1627.jpg","comment_is_top":false,"comment_ctime":1610500790,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5905468086","product_id":100020801,"comment_content":"正文中插入100000条数据的函数到底应该怎么执行的，为什么在Navicat创建函数总是报错：invalid stored procedure syntax","like_count":1,"discussions":[{"author":{"id":2843604,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/63/d4/b63373c3.jpg","nickname":"金金","note":"","ucode":"807EDDCDB2E939","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":560177,"discussion_content":"你要贴一个你自己写的啊","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649221678,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":205331,"user_name":"helloworld2018","can_delete":false,"product_type":"c1","uid":1210386,"ip_address":"","ucode":"2AE40C0DF5A9F7","user_header":"https://static001.geekbang.org/account/avatar/00/12/78/12/7df38a54.jpg","comment_is_top":false,"comment_ctime":1586594203,"is_pvip":false,"discussion_count":3,"race_medal":0,"score":"5881561499","product_id":100020801,"comment_content":"mysql是如何根据索引区分度cardinality，来估算需要扫描多少记录的？","like_count":1,"discussions":[{"author":{"id":2843604,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/63/d4/b63373c3.jpg","nickname":"金金","note":"","ucode":"807EDDCDB2E939","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":560180,"discussion_content":"索引区分度表示的是索引中不同值的比例，所以它影响的应该是按照某个值进行查找平均大概会执行多少次行扫描的次数。举个例子，比如有一个索引的区分度是0.5，这个索引是在属性a上建立的，如果这张表一共有1w行，那就表示在这张表中，不重复的a值大概只有5000（当然这样的估计其实也不是很准确），所以你在查询时如果指明a=xxx来查询的话，那估计就会扫描2行。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649222141,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":370496,"discussion_content":"走哪个索引就根据索引的区分度和where条件来计算不就行了？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619434881,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1324122,"avatar":"https://static001.geekbang.org/account/avatar/00/14/34/5a/723311cd.jpg","nickname":"句子","note":"","ucode":"C0C20F466DF9D0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":336111,"discussion_content":"感觉是cardinality影响了索引的选择，索引的选择影响了扫描的行数。如选择主键，这里会扫描100000，选择索引c就不一样了。但是为什么会扫描3万多行，这个不是很清楚，老师在下一节课中也没有给出答案。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608479518,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":180772,"user_name":"mgs2002","can_delete":false,"product_type":"c1","uid":1812970,"ip_address":"","ucode":"F5931108BD509B","user_header":"https://static001.geekbang.org/account/avatar/00/1b/a9/ea/5bfce6c5.jpg","comment_is_top":false,"comment_ctime":1582384227,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5877351523","product_id":100020801,"comment_content":"简单总结<br>1. MySQL索引是通过优化器来选择<br>2. 扫描行数是优化器选择索引的重要因素，扫描的行数越少，访问磁盘的次数就越少，CPU消耗也越少<br>3. 优化器有可能错误估计扫描行数，可使用analyze table 表名 重新统计信息<br>4. 索引选择错误处理方式①使用force index 索引 强制使用索引 ②修改SQL语句，引导MySQL使用我们期望的索引③创建更合适的索引或者删除误用的索引","like_count":1},{"had_liked":false,"id":175172,"user_name":"escray","can_delete":false,"product_type":"c1","uid":1020525,"ip_address":"","ucode":"1F4204930E47C4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/92/6d/becd841a.jpg","comment_is_top":false,"comment_ctime":1580601277,"is_pvip":true,"discussion_count":0,"race_medal":2,"score":"5875568573","product_id":100020801,"comment_content":"不知道如何去查询慢查询日志，简单的搜索了一下：<br><br># 查看慢查询日志的参数<br>mysql&gt; show variables like ‘%slow_query_log%’;<br># 开启慢查询日志<br>mysql&gt; set global slow_query_log=1;<br># 查看慢查询阈值，单位：毫秒<br>mysql&gt; show variables like ‘long_query_time%’;<br># 设置慢查询阈值<br>mysql&gt; set global log_query_time=0;<br><br>自己做实验的时候，得到了 show log 的比较结果，但是没有得到 explain 的比较结果，很奇怪的是，重新做实验验的时候，show log 也趋于一致了，有点怀疑是因为 MySQL 缓存了查询的结果。<br><br>之前在使用 Oracle 的时候，曾经大约半年左右会做一次索引的优化，用的就是类似的 analysis 的命令。<br><br>alter index rebuild<br><br>对于思考题，其实我自己是没有能够实现利用 session A 配合，让 rows 字段变成 30000+，我也是开了两个 MySQL 的窗口，不知道为什么没有被识别为两个 session。<br><br>在留言里面看到有不少同学都没能复现那个用错索引的例子，后来在 @Geek_8c4277 的提示下，原文提供的建表语句和存储过程定义可能有问题。如果使用自增 ID 做主键，那么能够复现用错索引，但是这样一来，表中的数据其实是不一样的（ID字段），不知道是否为作者本意。","like_count":1},{"had_liked":false,"id":103366,"user_name":"天使梦泪","can_delete":false,"product_type":"c1","uid":1235750,"ip_address":"","ucode":"782991747DD424","user_header":"https://static001.geekbang.org/account/avatar/00/12/db/26/3c8d68fb.jpg","comment_is_top":false,"comment_ctime":1560420981,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5855388277","product_id":100020801,"comment_content":"老师好，order by b，a  limit 1 这个语句的执行流程为啥不是取得最后查询结果的一行记录呢？和不使用order by，直接使用limit 1的执行流程是什么呢？","like_count":1,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":153252,"discussion_content":"默认升序。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580040323,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":97185,"user_name":"Geek_e7a036","can_delete":false,"product_type":"c1","uid":1497030,"ip_address":"","ucode":"65EA05C403441F","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIUvKMecKzfLSgFuYicksMxz1BJHp2Qz1uJBZsrfMTwBmF39tibW7HvbRmompwr71x86qwW22hLTULw/132","comment_is_top":false,"comment_ctime":1558603994,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5853571290","product_id":100020801,"comment_content":"文章的例子我刚开始没复现，然后加了自增是复现了。但是有一些疑问。<br>1. 我开启事务A的时候，事务B进行删除前后explain的rows不一样。我猜测是explain中rows是查询的全局的table status中的行数？而不是如select操作建立了快照读？<br>MariaDB [test_mysql]&gt; begin;<br>Query OK, 0 rows affected (0.00 sec)<br><br>MariaDB [test_mysql]&gt; select * from t where a between 10000 and 20000 limit 1;<br>+-------+-------+-------+<br>| id    | a     | b     |<br>+-------+-------+-------+<br>| 10000 | 10000 | 10000 |<br>+-------+-------+-------+<br>1 row in set (0.00 sec)<br><br>MariaDB [test_mysql]&gt; explain select * from t where a between 10000 and 20000;<br>+------+-------------+-------+-------+---------------+------+---------+------+-------+-----------------------+<br>| id   | select_type | table | type  | possible_keys | key  | key_len | ref  | rows  | Extra                 |<br>+------+-------------+-------+-------+---------------+------+---------+------+-------+-----------------------+<br>|    1 | SIMPLE      | t     | range | a             | a    | 5       | NULL | 10000 | Using index condition |<br>+------+-------------+-------+-------+---------------+------+---------+------+-------+-----------------------+<br>1 row in set (0.00 sec)<br><br>MariaDB [test_mysql]&gt; explain select * from t where a between 10000 and 20000;<br>+------+-------------+-------+------+---------------+------+---------+------+------+-------------+<br>| id   | select_type | table | type | possible_keys | key  | key_len | ref  | rows | Extra       |<br>+------+-------------+-------+------+---------------+------+---------+------+------+-------------+<br>|    1 | SIMPLE      | t     | ALL  | a             | NULL | NULL    | NULL |    1 | Using where |<br>+------+-------------+-------+------+---------------+------+---------+------+------+-------------+<br>1 row in set (0.00 sec)<br><br>2. 事务A中的explain的rows随着插入是从1不断上升到58407，插入完成又恢复到10000，这个到5w是因为事务A有快照读的标记删除的数据，又有新插入的数据，然后不断上升？最后又恢复到当前表统计的行数？<br>","like_count":1},{"had_liked":false,"id":96575,"user_name":"狂风骤雨","can_delete":false,"product_type":"c1","uid":1305749,"ip_address":"","ucode":"5CE9B9438FAB3F","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKZSibeTatZ2ImL5Xu3QqdTWQs5nyQAxDlsm3m0KicP3TN6icJqYricvhjOFfTB2B3oLInU45CC9LtqMA/132","comment_is_top":false,"comment_ctime":1558451152,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5853418448","product_id":100020801,"comment_content":"像文中这种情况，用组合索引是不是就不会出问题呢","like_count":1},{"had_liked":false,"id":70288,"user_name":"三胖","can_delete":false,"product_type":"c1","uid":1373454,"ip_address":"","ucode":"CD69FCD606FC5C","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/1hp9kzzuLUVHzmmddIPIO2OgUWr1ibJRr8cMoB7K0fwx8Vmn34L8yN2NoYUtgNicfPGaXKF02pQ2huXd59r2I0kw/132","comment_is_top":false,"comment_ctime":1551065146,"is_pvip":false,"replies":[{"id":"25080","content":"正常应该是多个线程吧，<br>你可以通过 select @@pseudo_thread_id 来查看本窗口的session id<br><br>不过索引选择的case有时候依赖于现场环境的哈^_^","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1551068758,"ip_address":"","comment_id":70288,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5846032442","product_id":100020801,"comment_content":"老师，我是windows上面实践的，用navicat开两个窗口进行复现，但是没有复现成功。是因为两个窗口其实都算一个ssesion吗","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440547,"discussion_content":"正常应该是多个线程吧，\n你可以通过 select @@pseudo_thread_id 来查看本窗口的session id\n\n不过索引选择的case有时候依赖于现场环境的哈^_^","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551068758,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":61832,"user_name":"亮","can_delete":false,"product_type":"c1","uid":1086346,"ip_address":"","ucode":"5B8E59AEA6E3F2","user_header":"https://static001.geekbang.org/account/avatar/00/10/93/8a/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1547812594,"is_pvip":false,"replies":[{"id":"21932","content":"加MDL 读锁","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547825060,"ip_address":"","comment_id":61832,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5842779890","product_id":100020801,"comment_content":"老师，您好，analyze table 语句会锁表吗","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437012,"discussion_content":"加MDL 读锁","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547825060,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":57136,"user_name":"我是小队长","can_delete":false,"product_type":"c1","uid":1334198,"ip_address":"","ucode":"E0687666EE2031","user_header":"https://static001.geekbang.org/account/avatar/00/14/5b/b6/f404b490.jpg","comment_is_top":false,"comment_ctime":1546657432,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5841624728","product_id":100020801,"comment_content":"老师，看下这个有问题么？mysql&gt; select @@global.tx_isolation,@@tx_isolation,version(),&quot;session A&quot;;<br>+-----------------------+-----------------+------------+-----------+<br>| @@global.tx_isolation | @@tx_isolation  | version()  | session A |<br>+-----------------------+-----------------+------------+-----------+<br>| REPEATABLE-READ       | REPEATABLE-READ | 5.7.17-log | session A |<br>+-----------------------+-----------------+------------+-----------+<br>1 row in set<br><br>mysql&gt; start transaction with consistent snapshot;<br>Query OK, 0 rows affected<br><br>mysql&gt; select @@global.tx_isolation,@@tx_isolation,version(),&quot;session B&quot;;<br>+-----------------------+-----------------+------------+-----------+<br>| @@global.tx_isolation | @@tx_isolation  | version()  | session B |<br>+-----------------------+-----------------+------------+-----------+<br>| REPEATABLE-READ       | REPEATABLE-READ | 5.7.17-log | session B |<br>+-----------------------+-----------------+------------+-----------+<br>1 row in set<br><br>mysql&gt; delete from t;<br>Query OK, 100000 rows affected<br><br>mysql&gt; call ww();<br>Query OK, 1 row affected<br><br>mysql&gt;  explain select * from t where a between 10000 and 20000;<br>+----+-------------+-------+------------+-------+---------------+-----+---------+------+-------+----------+-----------------------+<br>| id | select_type | table | partitions | type  | possible_keys | key | key_len | ref  | rows  | filtered | Extra                 |<br>+----+-------------+-------+------------+-------+---------------+-----+---------+------+-------+----------+-----------------------+<br>|  1 | SIMPLE      | t     | NULL       | range | a             | a   | 5       | NULL | 10001 |      100 | Using index condition |<br>+----+-------------+-------+------------+-------+---------------+-----+---------+------+-------+----------+-----------------------+<br>1 row in set<br><br>mysql&gt;  commit;<br>","like_count":1},{"had_liked":false,"id":53566,"user_name":"运斤成风","can_delete":false,"product_type":"c1","uid":1350812,"ip_address":"","ucode":"BAFF69C29FDFA5","user_header":"https://static001.geekbang.org/account/avatar/00/14/9c/9c/e02a0daf.jpg","comment_is_top":false,"comment_ctime":1545692139,"is_pvip":false,"replies":[{"id":"19483","content":"没有触发索引重新统计，就是直接用指定的索引执行","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545702784,"ip_address":"","comment_id":53566,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5840659435","product_id":100020801,"comment_content":"老师好，对 上面网友 ying 的500万记录用use index索引提示后改变了执行计划，我还是有点小疑问，若是只是用use index 而统计信息没有变化的话，优化器不会仅仅依据该提示去调整执行计划？还是加索引提示后会触发重新收集统计信息等内部机制？谢谢","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434183,"discussion_content":"没有触发索引重新统计，就是直接用指定的索引执行","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545702784,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":50693,"user_name":"William","can_delete":false,"product_type":"c1","uid":1346215,"ip_address":"","ucode":"55F5D9DEE485B1","user_header":"https://static001.geekbang.org/account/avatar/00/14/8a/a7/674c1864.jpg","comment_is_top":false,"comment_ctime":1545030215,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"5839997511","product_id":100020801,"comment_content":"补充：REPEATABLE-READ\tREPEATABLE-READ\t5.7.17-log\tsession A   刚提问的内容。","like_count":1},{"had_liked":false,"id":49510,"user_name":"汝林外史","can_delete":false,"product_type":"c1","uid":1188906,"ip_address":"","ucode":"3C66C0F0537A99","user_header":"https://static001.geekbang.org/account/avatar/00/12/24/2a/33441e2b.jpg","comment_is_top":false,"comment_ctime":1544702488,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5839669784","product_id":100020801,"comment_content":"丁大，我本地mysql是5.6.40，经过图2的测试后仍然用的是索引a,行数是10000，图11的结果也与您的结果不同，我的下面的还是用的b索引，然后行数是50128，请问是版本的问题吗？","like_count":1},{"had_liked":false,"id":48251,"user_name":"andy","can_delete":false,"product_type":"c1","uid":1063321,"ip_address":"","ucode":"F03BE5E20B471C","user_header":"https://static001.geekbang.org/account/avatar/00/10/39/99/42929758.jpg","comment_is_top":false,"comment_ctime":1544406584,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5839373880","product_id":100020801,"comment_content":"create table #t<br>(<br>\ta int,<br>\tb int,<br>\tc int<br>)<br><br>insert into #t values(1,1,1)<br><br>declare @count int<br>set @count=1<br><br>while @count&lt;=70000<br>begin<br>\tinsert into #t select a+@count,b+@count,c+@count from #t<br>\tset @count= @count*2<br>end<br><br>插入测试数据，这种方法我试过很快，不过不能准确插入10万条，以上是SQL Server的语法","like_count":1,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":153223,"discussion_content":"那就按照老师的sql语句。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580039301,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":48060,"user_name":"gentleman♥️","can_delete":false,"product_type":"c1","uid":1119062,"ip_address":"","ucode":"0BAC746A70038C","user_header":"https://static001.geekbang.org/account/avatar/00/11/13/56/6a062937.jpg","comment_is_top":false,"comment_ctime":1544337766,"is_pvip":false,"replies":[{"id":"17133","content":"是这样的，问题确实只是用来引出话题，否则这篇文章如果只讲一个“索引统计”问题呢，<br>我觉得内容不够，对不起大家花时间来读…<br><br>所以你把问题当作印子好了，<br>这篇文章就是说的“索引选错，案例及处理分享”","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544353941,"ip_address":"","comment_id":48060,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5839305062","product_id":100020801,"comment_content":"老师 提个建议，看了你几章了，发现一个问题，<br>有时候，带出一个问题，后面又不是由这个问题引起的，<br>感觉就好分散，会让人摸着头脑的感觉，<br>尽量，前后因果关系衔接点哈","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432012,"discussion_content":"是这样的，问题确实只是用来引出话题，否则这篇文章如果只讲一个“索引统计”问题呢，\n我觉得内容不够，对不起大家花时间来读…\n\n所以你把问题当作印子好了，\n这篇文章就是说的“索引选错，案例及处理分享”","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544353941,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":47985,"user_name":"蚂蚁内推+v","can_delete":false,"product_type":"c1","uid":1050508,"ip_address":"","ucode":"24B10AEE54B3FD","user_header":"https://static001.geekbang.org/account/avatar/00/10/07/8c/0d886dcc.jpg","comment_is_top":false,"comment_ctime":1544280097,"is_pvip":false,"replies":[{"id":"17097","content":"1. 是的<br><br>2. 如果你的需求就是要导出全表，那只能这样了。。 按version分表可以解决回表问题，但是得看看你别的业务请求需求","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544332551,"ip_address":"","comment_id":47985,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5839247393","product_id":100020801,"comment_content":"老师，我们现在使用mysql时，在表t上有一个版本号索引，每天更新一次数据量100w左右，更新的当天日期作为版本号，此时某一天的版本号索引，对应的数据有100w，那么<br>1. 我如果查询select * from t where version =&#39;xxxx&#39;的时候，需要回表100w次吗？<br>2. 减少回表次数的办法吗？","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431974,"discussion_content":"1. 是的\n\n2. 如果你的需求就是要导出全表，那只能这样了。。 按version分表可以解决回表问题，但是得看看你别的业务请求需求","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544332551,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":47882,"user_name":"Long","can_delete":false,"product_type":"c1","uid":1318970,"ip_address":"","ucode":"2417242560360A","user_header":"https://static001.geekbang.org/account/avatar/00/14/20/3a/90db6a24.jpg","comment_is_top":false,"comment_ctime":1544245361,"is_pvip":false,"replies":[{"id":"17052","content":"1. 嗯，这么说也可以，其实是information_schema.table 和 优化器用的是同一份数据；<br><br>2. Analyze 只是重新统计，更新表索引的统计信息； 后面两个会重建表<br><br>3. 这个，除了尽量使用自增主键外，其它的只能按照业务需求来了","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544268773,"ip_address":"","comment_id":47882,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5839212657","product_id":100020801,"comment_content":"老师好，1. 能不能再说下关联的free data的统计，就是information_schema.tables里面的信息，优化器读取的行数信息应该是来自于这个表的吧？2. 还有修正统计信息可以用analyze table，optimize table，如果是innodb的还可以set engine = innodb来解决.这三者时候有什么大的算法上的区别？   3 有没有案例说自己的应用程序设计的时候应该注意什么，就好比说一个经常新增和删除的表应该注意什么，来减少free data的大小？希望老师能够解答一下，多谢","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431927,"discussion_content":"1. 嗯，这么说也可以，其实是information_schema.table 和 优化器用的是同一份数据；\n\n2. Analyze 只是重新统计，更新表索引的统计信息； 后面两个会重建表\n\n3. 这个，除了尽量使用自增主键外，其它的只能按照业务需求来了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544268773,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":47295,"user_name":"J!","can_delete":false,"product_type":"c1","uid":1305003,"ip_address":"","ucode":"71C946119B59D1","user_header":"https://static001.geekbang.org/account/avatar/00/13/e9/ab/37903736.jpg","comment_is_top":false,"comment_ctime":1544101938,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5839069234","product_id":100020801,"comment_content":"我想问下mysql dbname 的长度在源码中是在哪里定义的，为什么最大长度是64=?","like_count":1},{"had_liked":false,"id":47221,"user_name":"york","can_delete":false,"product_type":"c1","uid":1318852,"ip_address":"","ucode":"EE938B81A7FC04","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epGMibYc0m7cDHMsNRBUur2NPVnlBZFXoNjWomibfjnHeAO3XRt27VaH3WNtdUX11d3uIT1ZHWCxLeg/132","comment_is_top":false,"comment_ctime":1544080286,"is_pvip":false,"replies":[{"id":"16848","content":"set sql_long_query=0; 改成 set long_query_time=0; 😓","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544084535,"ip_address":"","comment_id":47221,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5839047582","product_id":100020801,"comment_content":"老师：<br>1.  我的机器也没复现图2所指的问题，MySQL版本5.7.24<br>2. set sql_long_query=0命令，在我的MySQL执行报错<br>    Unknown system variable &#39;sql_long_query&#39;<br>3. 用虚拟机插入10万条数据耗时长的问题，可能是因为创建虚拟机时，磁盘选择的是动态增长容量的方式，其他同学可以试试。","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431701,"discussion_content":"set sql_long_query=0; 改成 set long_query_time=0; 😓","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544084535,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":47183,"user_name":"DanielAnton","can_delete":false,"product_type":"c1","uid":1308521,"ip_address":"","ucode":"69D49AC70898B0","user_header":"https://static001.geekbang.org/account/avatar/00/13/f7/69/d8dba3de.jpg","comment_is_top":false,"comment_ctime":1544069647,"is_pvip":false,"replies":[{"id":"16829","content":"就是用两个不同的终端，连进去就是两个不同的session ","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544070944,"ip_address":"","comment_id":47183,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5839036943","product_id":100020801,"comment_content":"小白，问下老师，我想在本机上做这个实验，但是怎么在一台机器上开启不同的 session 呢（或者说怎么在 session A 的执行过程中开启 session B 呢），我用的 windows , 我试着打开两个 cmd 终端，但第一个例子的效果还是 rows 为 10001。 初学，实在不懂，请老师指教。","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431693,"discussion_content":"就是用两个不同的终端，连进去就是两个不同的session ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544070944,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":47182,"user_name":"Bennet","can_delete":false,"product_type":"c1","uid":1022801,"ip_address":"","ucode":"C85C47A75BA412","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIXYib4bOBtUeLniaqjMNaOY4gDPPbL4hYmv1HYHSPibyHVQlAeWhabABIy0YL7qgOqaa8EibxGSoiaw1w/132","comment_is_top":false,"comment_ctime":1544069443,"is_pvip":false,"replies":[{"id":"16830","content":"这是一个原因，<br>还有就是区分度不好。<br>业务上要尽量避免只有这一个条件的语句（如果实在有，那也没办法还是要建）","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544071010,"ip_address":"","comment_id":47182,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5839036739","product_id":100020801,"comment_content":"请教老师一个问题：对于枚举属性（像：类型、标记这种只有少量值的字段）字段，按照文中的意思这样的字段建立索引的话区分度很低，基数也很小。那适合在这样的字段上建索引吗？<br><br>我能想到的不合适的理由是：行级锁的范围会很大。","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431692,"discussion_content":"这是一个原因，\n还有就是区分度不好。\n业务上要尽量避免只有这一个条件的语句（如果实在有，那也没办法还是要建）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544071010,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":46888,"user_name":"kunsect","can_delete":false,"product_type":"c1","uid":1299322,"ip_address":"","ucode":"2CC4ADF82887FC","user_header":"https://static001.geekbang.org/account/avatar/00/13/d3/7a/dd7d35b5.jpg","comment_is_top":false,"comment_ctime":1543997314,"is_pvip":false,"replies":[{"id":"16788","content":"你把session A 的commit改移动到最后执行看看","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544022633,"ip_address":"","comment_id":46888,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5838964610","product_id":100020801,"comment_content":"老师，我这边复现不了走全局扫描的案例。<br><br>mysql&gt; select version();<br>+-----------+<br>| version() |<br>+-----------+<br>| 5.7.22    |<br>+-----------+<br>1 row in set (0.00 sec)<br><br>mysql&gt; show variables like &#39;transaction_isolation&#39;;<br>+-----------------------+-----------------+<br>| Variable_name         | Value           |<br>+-----------------------+-----------------+<br>| transaction_isolation | REPEATABLE-READ |<br>+-----------------------+-----------------+<br>1 row in set (0.00 sec)<br><br>—————————————————————————————————<br>Session A：<br>mysql&gt; start transaction with consistent snapshot;<br>Query OK, 0 rows affected (0.00 sec)<br><br>Session B：<br>mysql&gt; delete from t;<br>Query OK, 100000 rows affected (0.52 sec)<br><br>Session B：<br>mysql&gt; call idata();<br>Query OK, 1 row affected (1.91 sec)<br><br>Session A：<br>mysql&gt; commit;<br>Query OK, 0 rows affected (0.00 sec)<br><br>Session B：<br>mysql&gt; explain select * from t where a between 10000 and 20000;<br>+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+<br>| id | select_type | table | partitions | type  | possible_keys | key  | key_len | ref  | rows  | filtered | Extra                 |<br>+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+<br>|  1 | SIMPLE      | t     | NULL       | range | a             | a    | 5       | NULL | 10001 |   100.00 | Using index condition |<br>+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+<br>1 row in set, 1 warning (0.00 sec)","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431587,"discussion_content":"你把session A 的commit改移动到最后执行看看","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544022633,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":46740,"user_name":"高枕","can_delete":false,"product_type":"c1","uid":1310312,"ip_address":"","ucode":"20F6CF75EC9AA4","user_header":"https://static001.geekbang.org/account/avatar/00/13/fe/68/e0bebd9a.jpg","comment_is_top":false,"comment_ctime":1543976261,"is_pvip":false,"replies":[{"id":"16705","content":"1. 是的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1543985338,"ip_address":"","comment_id":46740,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5838943557","product_id":100020801,"comment_content":"老师，您文中提到：“从 change buffer 里找出这个数据页的 change buffer 记录 (可能有多个），依次应用，得到新版数据页；<br><br>写 redo log。这个 redo log 包含了数据的变更和 change buffer 的变更。”<br>您的意思是，这些新版的数据页后的数据 ，没有直接写回到磁盘（数据页），而是写进了redo log？<br>写回数据页和更新系统表空间对应的change buffer是另外的一个过程？<br>写进","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431523,"discussion_content":"1. 是的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1543985338,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":370498,"discussion_content":"redo log记录的不是具体的数据是数据页的变化，磁盘上面的数据也不是根据redo log来修改的，是把内存中的数据页的脏页刷新到磁盘数据页中","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619435525,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":46734,"user_name":"高枕","can_delete":false,"product_type":"c1","uid":1310312,"ip_address":"","ucode":"20F6CF75EC9AA4","user_header":"https://static001.geekbang.org/account/avatar/00/13/fe/68/e0bebd9a.jpg","comment_is_top":false,"comment_ctime":1543975649,"is_pvip":false,"replies":[{"id":"16686","content":"前面两句理解对应位置是对的哈，<br>最后一句问题：没有马上写","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1543979302,"ip_address":"","comment_id":46734,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5838942945","product_id":100020801,"comment_content":"老师，您文中最后写道：“这时候，数据页和内存中 change buffer 对应的磁盘位置都还没有修改，属于脏页，之后各自刷回自己的物理数据，就是另外一个过程了。”<br>能再给解释下change buffer和数据页对应的磁盘位置是哪里吗？<br>我理解change buffer 对应的磁盘位置是系统表空间，数据页所在的磁盘位置是表空间的位置，marge并没有把数据直接写道这个表空间的位置吗？","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431520,"discussion_content":"前面两句理解对应位置是对的哈，\n最后一句问题：没有马上写","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1543979302,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1254801,"avatar":"https://static001.geekbang.org/account/avatar/00/13/25/91/46600294.jpg","nickname":"猴哥一一 cium","note":"","ucode":"38EC64F8D1A0B4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":312463,"discussion_content":"专门的刷盘线程去刷脏页","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1602690717,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":359843,"user_name":"听风","can_delete":false,"product_type":"c1","uid":2786848,"ip_address":"浙江","ucode":"EC2EB012E8DB6D","user_header":"https://static001.geekbang.org/account/avatar/00/2a/86/20/1f1221f5.jpg","comment_is_top":false,"comment_ctime":1665973187,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1665973187","product_id":100020801,"comment_content":"老师你好我在优化一个sql时遇到这样一个问题，不知道老师有没有时间解答下：<br><br>u_cash_withdraw_log 表数据量380万，隔离级别rr ，表结构如下<br><br>```<br>create table u_cash_withdraw_log<br>(<br>    order_no               varchar(100)                        not null comment &#39;订单号&#39;<br>        primary key,<br>    user_id                bigint                              not null comment &#39;用户ID&#39;,<br>    <br>    real_money             double(8, 2)                        not null comment &#39;金额(元)&#39;,<br>  <br>    expect_submit_time     datetime                            not null comment &#39;预计提交时间&#39;,<br>    create_time            datetime                            not null comment &#39;时间戳，分区键&#39;<br>)<br>    comment &#39;用户提现记录表&#39; collate = utf8mb4_general_ci;<br><br>create index expect_submit_time<br>    on u_cash_withdraw_log (expect_submit_time);<br>```<br><br> 执行下面sql<br><br>不走索引<br><br>```<br>select sum(l.real_money) from jc_cash.u_cash_withdraw_log l where<br>                          l.expect_submit_time &gt;= &#39;2022-09-14 00:00:00&#39;<br>                         and l.expect_submit_time &lt;= &#39;2022-10-15 23:00:00&#39;<br>[2022-10-17 10:06:02] 1 row retrieved starting from 1 in 1 s 531 ms (execution: 1 s 500 ms, fetching: 31 ms)<br><br>```<br><br>explain 分析<br><br>```<br>1|SIMPLE|l||ALL|expect_submit_time||||3663169|31.15|Using where<br>```<br><br>优化后走索引<br><br>select sum(l.real_money) from jc_cash.u_cash_withdraw_log l where<br>                          l.expect_submit_time &gt;= &#39;2022-09-14 00:00:00&#39;<br>                         and l.expect_submit_time &lt;= &#39;2022-10-15 23:00:00&#39;<br>         order by expect_submit_time limit 1<br>[2022-10-17 10:06:31] 1 row retrieved starting from 1 in 1 s 815 ms (execution: 1 s 765 ms, fetching: 50 ms)<br><br>explain 分析<br><br>1|SIMPLE|l||range|expect_submit_time|expect_submit_time|5||1141008|100|Using index condition<br><br><br><br>我的问题是为啥用了索引的执行execution的时间要比全表还要大，扫描行数有索引100万行明显也比300万要少很多 为啥速度还慢","like_count":0},{"had_liked":false,"id":354817,"user_name":"Geek_323a60","can_delete":false,"product_type":"c1","uid":2797976,"ip_address":"四川","ucode":"CDC276EC255411","user_header":"","comment_is_top":false,"comment_ctime":1660804089,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1660804089","product_id":100020801,"comment_content":"按照图2 中的 session A 与 session B 的执行流程并不能复现优化器错误选择结果。mysql 版本 5.7.36","like_count":0},{"had_liked":false,"id":351811,"user_name":"若~","can_delete":false,"product_type":"c1","uid":1401787,"ip_address":"","ucode":"23E59E7C067A05","user_header":"https://static001.geekbang.org/account/avatar/00/15/63/bb/1b0387b0.jpg","comment_is_top":false,"comment_ctime":1658204994,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1658204994","product_id":100020801,"comment_content":"有一张表，数据2700000w，在一个字段上加了索引，但是简单查询的执行计划却不用索引，force index也不用，analyze和alter 都用了也没作用，是什么原因呢","like_count":0},{"had_liked":false,"id":351320,"user_name":"Geek_57eac9","can_delete":false,"product_type":"c1","uid":2579808,"ip_address":"","ucode":"E31699EDFF2A56","user_header":"","comment_is_top":false,"comment_ctime":1657698735,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1657698735","product_id":100020801,"comment_content":"老师，有个问题，“为什么写chengeBuffer要写redoLog，merge changeBuffer时候也要写redoLog。”<br>        我的理解是：<br>        1、写change buffer的时候，往redo log中记录的是 操作记录，也就是new change buffer item&quot;add (id2,k2)to Page2&quot;;<br>        2、merge change buffer的时候，往redo log中记录的是 数据变更记录，也就是 add (id2,k2)to Page2；<br>        3、“操作记录”是用来保证：即使断电重启后，内存中的changeBuffer已经丢失了，但是可以通过redo log中的操作记录和 数据变更记录来还原还未merge的changeBuffer。（假设操作记录有a、b、c，数据变更记录有a、b，那么说明还有个c还没merge，那么就对比这两种记录来确定需要恢复的changeBuffer是c那一条）<br>        4、“数据变更记录”是用来保证：数据库的CrashSafe能力。<br><br>不知道我的理解对不对？","like_count":0},{"had_liked":false,"id":350183,"user_name":"张满意","can_delete":false,"product_type":"c1","uid":2974275,"ip_address":"","ucode":"2AA2AC8F1A3364","user_header":"","comment_is_top":false,"comment_ctime":1656640869,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1656640869","product_id":100020801,"comment_content":"这里要复现统计基数失准的情况，innodb_stats_include_delete_marked 要看一下折参数的配置","like_count":0},{"had_liked":false,"id":348345,"user_name":"千锤百炼领悟之极限","can_delete":false,"product_type":"c1","uid":1744257,"ip_address":"","ucode":"224B5CF2101716","user_header":"https://static001.geekbang.org/account/avatar/00/1a/9d/81/d748b7eb.jpg","comment_is_top":false,"comment_ctime":1655006657,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1655006657","product_id":100020801,"comment_content":"影响优化器选择索引的因素很多，例如扫描行数，是否使用临时表，是否排序，回表次数等。<br><br>解决优化器选择错索引的方法<br>1.使用force index强制指定索引。<br>2.修改SQL语句使优化器能命中预期索引。<br>3.新增或删除索引，使优化器能命中预期索引。","like_count":0},{"had_liked":false,"id":341903,"user_name":"再见理想","can_delete":false,"product_type":"c1","uid":1245999,"ip_address":"","ucode":"FAC88B3F6F6DFD","user_header":"https://static001.geekbang.org/account/avatar/00/13/03/2f/0a5e0751.jpg","comment_is_top":false,"comment_ctime":1649909331,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1649909331","product_id":100020801,"comment_content":"优化器会根据索引的扫描行数，是否使用临时表，排序等条件确定使用的索引。<br>而扫描行数是根据索引的区分度计算的，索引的区分度使用的抽样统计，并不是完全精准。<br>show index from t 可以查询索引的区分度。<br>analyze table t  可以重新统计索引的信息<br>1，可以使用 force index（·index_name·）方式强制使用索引<br>2，修改sql语句，引导优化器使用我们指定的索引<br>3，删除错误或没必要的索引<br>","like_count":0},{"had_liked":false,"id":341467,"user_name":"亚林","can_delete":false,"product_type":"c1","uid":1018972,"ip_address":"","ucode":"4A5A6D24314B79","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8c/5c/3f164f66.jpg","comment_is_top":false,"comment_ctime":1649645840,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1649645840","product_id":100020801,"comment_content":"MySQL8已经把第一个问题修复了","like_count":0},{"had_liked":false,"id":341384,"user_name":"imageine","can_delete":false,"product_type":"c1","uid":1784001,"ip_address":"","ucode":"05A7EA8F28818C","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIcLjatV3GHd94SjWGpTYlTXc0NMKyk1ejq6XeAgdf8QWbZKa67CHvVvicoC6oXRfJmqmnAZcepOrw/132","comment_is_top":false,"comment_ctime":1649574630,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1649574630","product_id":100020801,"comment_content":"老师好，最近解决了一个因为in和order by id导致的慢SQL问题，也是因为优化器使用了错误的索引导致的，发现去掉in或者去掉order by id 都可以解决这个问题，详情请查看：https:&#47;&#47;blog.csdn.net&#47;zhouwenjun0820&#47;article&#47;details&#47;124070771<br><br>但是仍有一点疑惑：为什么in 两个元素的列表也会使索引失效呢？<br><br>谢谢老师","like_count":0},{"had_liked":false,"id":340512,"user_name":"Geek_290df2","can_delete":false,"product_type":"c1","uid":2951010,"ip_address":"","ucode":"45052E4F5225BA","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epzf6xib6HyMiakG6QiblZ58dqwxEcwOqK16hhXYfRcg9jP1WD1dE3xDmluIs6N2u3ib6giaEzmPfpohdg/132","comment_is_top":false,"comment_ctime":1648870775,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1648870775","product_id":100020801,"comment_content":"这个慢查询日志是通过什么命令找到的啊 ","like_count":0,"discussions":[{"author":{"id":1015184,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/7d/90/abb7bfe3.jpg","nickname":"fourge","note":"","ucode":"F3E3FFC4990358","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":582579,"discussion_content":"看数据目录下的slow.log文件","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659516128,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":336063,"user_name":"Geek_9527","can_delete":false,"product_type":"c1","uid":2925289,"ip_address":"","ucode":"F064D2EE4B30EC","user_header":"https://static001.geekbang.org/account/avatar/00/2c/a2/e9/f70d3144.jpg","comment_is_top":false,"comment_ctime":1645876091,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1645876091","product_id":100020801,"comment_content":"Oracle中的话，通过hints来固化索引（强制索引） ，如 &#47;*+INDEX(TABLE INDEX_NAME)*&#47;","like_count":0},{"had_liked":false,"id":335828,"user_name":"林伟华","can_delete":false,"product_type":"c1","uid":1308094,"ip_address":"","ucode":"38BDA7DB6CAB09","user_header":"https://static001.geekbang.org/account/avatar/00/13/f5/be/f2c346e3.jpg","comment_is_top":false,"comment_ctime":1645706020,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1645706020","product_id":100020801,"comment_content":"优化器的选择是否存在优先级的情况啊 例如<br>回表大于行数这样的 还是综合考虑的","like_count":0},{"had_liked":false,"id":335660,"user_name":"Jason","can_delete":false,"product_type":"c1","uid":1756181,"ip_address":"","ucode":"B2765DD1D90B0C","user_header":"https://static001.geekbang.org/account/avatar/00/1a/cc/15/35622b02.jpg","comment_is_top":false,"comment_ctime":1645616298,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1645616298","product_id":100020801,"comment_content":"老师你好，我今天发现了个现象，select * from table_a where id = 0; table_a 表的主键是id， 如果表里面没有 id = 0 的情况，用explain 查看这个语句的执行情况，显示没有走索引，但是从实际上执行速率来看好像是走了索引（6亿的数据，非常快的返回了结果），请问这种情况到底有没有走索引？如果没有走索引的话，在主键上的等值查询为什么不走索引呢？","like_count":0},{"had_liked":false,"id":334082,"user_name":"天堂在左 DBA在右","can_delete":false,"product_type":"c1","uid":1324234,"ip_address":"","ucode":"40D0BBB2B170CC","user_header":"https://static001.geekbang.org/account/avatar/00/14/34/ca/84d80f76.jpg","comment_is_top":false,"comment_ctime":1644733395,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1644733395","product_id":100020801,"comment_content":"是否可以通过改变统计信息的方式让查询走指定索引，例如update更新mysql.innodb_table_stats设计t表的n_rows，和主索引大小clustered_index_size，其他非主索引的总大小sum_of_other_index_sizes来让查询走到指定索引，然后删除innodb_index_stats的索引统计信息，重新flush table","like_count":0},{"had_liked":false,"id":331237,"user_name":"駱炳聪","can_delete":false,"product_type":"c1","uid":2011284,"ip_address":"","ucode":"55E724536C271E","user_header":"https://static001.geekbang.org/account/avatar/00/1e/b0/94/fa6668e7.jpg","comment_is_top":false,"comment_ctime":1642497644,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1642497644","product_id":100020801,"comment_content":"那更新的操作的流程就是现在改变记到 change buffer 当事务提交的时候，才把 change buffer 的操作也记录到 redo log 里了对吧？","like_count":0},{"had_liked":false,"id":325082,"user_name":"黑微狗‮‮","can_delete":false,"product_type":"c1","uid":1177797,"ip_address":"","ucode":"D44505E7E97BB3","user_header":"https://static001.geekbang.org/account/avatar/00/11/f8/c5/6d38f3e3.jpg","comment_is_top":false,"comment_ctime":1638801867,"is_pvip":false,"replies":[{"id":"118294","content":"是数值，不过不止一个，你可以理解为一组“统计直方图”","user_name":"作者回复","user_name_real":"编辑","uid":"1264162","ctime":1639385141,"ip_address":"","comment_id":325082,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1638801867","product_id":100020801,"comment_content":"老师你好 想问下优化器是怎么根据统计信息来预估扫描行数的阿？我理解统计信息只是一个数值吧？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":538258,"discussion_content":"是数值，不过不止一个，你可以理解为一组“统计直方图”","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639385141,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":321504,"user_name":"muggle","can_delete":false,"product_type":"c1","uid":1261530,"ip_address":"","ucode":"D78087BCAD0860","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKDKsicmpne7xQNocwRQ80DDZ3CzjsDoVIcH0SBiaYzS056oVOx4pEeEVeCaXE3QtsjUIEI0x1xQVTw/132","comment_is_top":false,"comment_ctime":1636908994,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1636908994","product_id":100020801,"comment_content":"由于事务A一致性读视图原因导致事务B的a索引扫描行数翻倍，这个可以理解了，那为什么主键索引树在这个场景下扫描行数仍然是10w，而不是20w呢？？","like_count":0,"discussions":[{"author":{"id":2843604,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/63/d4/b63373c3.jpg","nickname":"金金","note":"","ucode":"807EDDCDB2E939","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":560195,"discussion_content":"翻倍应该是两万行啊，为什么会是接近4万行呢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649226849,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":321375,"user_name":"无关风月丶","can_delete":false,"product_type":"c1","uid":1446583,"ip_address":"","ucode":"4F27DC4DCFED32","user_header":"https://static001.geekbang.org/account/avatar/00/16/12/b7/32deac2b.jpg","comment_is_top":false,"comment_ctime":1636816491,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1636816491","product_id":100020801,"comment_content":"老师，我试着将字段b中超过1&#47;m的值更新，再看基数，为什么没有发生改变？而且不准确","like_count":0},{"had_liked":false,"id":320720,"user_name":"十年","can_delete":false,"product_type":"c1","uid":2184438,"ip_address":"","ucode":"6E1A26C38C11BC","user_header":"https://static001.geekbang.org/account/avatar/00/21/54/f6/ac89dddb.jpg","comment_is_top":false,"comment_ctime":1636467881,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1636467881","product_id":100020801,"comment_content":"MySQL8.0 执行存储过程，插入10w条数据用了800多s 。为什么？<br>MySQL5.7正常执行，很快就插入完了","like_count":0,"discussions":[{"author":{"id":1015184,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/7d/90/abb7bfe3.jpg","nickname":"fourge","note":"","ucode":"F3E3FFC4990358","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":582580,"discussion_content":"把innodb_flush_log_at_trx_commit和sync_binlog 都改成0试试看","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659516269,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":320279,"user_name":"爱学习的W","can_delete":false,"product_type":"c1","uid":2641096,"ip_address":"","ucode":"C66BFF0D54E57F","user_header":"https://static001.geekbang.org/account/avatar/00/28/4c/c8/77e4d78b.jpg","comment_is_top":false,"comment_ctime":1636194813,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1636194813","product_id":100020801,"comment_content":"我有个疑问？索引区分度越大查询时扫描的记录数越少呢？？","like_count":0,"discussions":[{"author":{"id":1015184,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/7d/90/abb7bfe3.jpg","nickname":"fourge","note":"","ucode":"F3E3FFC4990358","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":582581,"discussion_content":"在where条件查询时候，符合查询条件的行数就越少，即扫描行数越小，io次数越少","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659516369,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":319421,"user_name":"李坤龙","can_delete":false,"product_type":"c1","uid":2824858,"ip_address":"","ucode":"68346B996EE22B","user_header":"https://static001.geekbang.org/account/avatar/00/2b/1a/9a/f2f9f5dd.jpg","comment_is_top":false,"comment_ctime":1635810961,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1635810961","product_id":100020801,"comment_content":"我用mysql 8.0做测试，并没有出现老师在文中提到的bug，是否该bug在8.0已经修复？<br><br>## 默认执行计划<br>mysql&gt; explain select * from t where (a between 1 and 1000) and (b between 50000 and 100000) order by b limit 1;<br>+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-------------+<br>| id | select_type | table | partitions | type  | possible_keys | key  | key_len | ref  | rows  | filtered | Extra       |<br>+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-------------+<br>|  1 | SIMPLE      | t     | NULL       | range | a,b           | b    | 5       | NULL | 50097 |     1.00 | Using where |<br>+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-------------+<br>1 row in set, 1 warning (0.00 sec)<br><br>## 使用强制索引<br>mysql&gt; explain select * from t force index(a) where (a between 1 and 1000) and (b between 50000 and 100000) order by b limit 1;<br>+----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+-----------------------------+<br>| id | select_type | table | partitions | type  | possible_keys | key  | key_len | ref  | rows | filtered | Extra                       |<br>+----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+-----------------------------+<br>|  1 | SIMPLE      | t     | NULL       | range | a             | a    | 5       | NULL | 1000 |    11.11 | Using where; Using filesort |<br>+----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+-----------------------------+<br>1 row in set, 1 warning (0.00 sec)","like_count":0},{"had_liked":false,"id":316622,"user_name":"康斯坦丁","can_delete":false,"product_type":"c1","uid":1368096,"ip_address":"","ucode":"C130E800E8D5C9","user_header":"https://static001.geekbang.org/account/avatar/00/14/e0/20/003190c1.jpg","comment_is_top":false,"comment_ctime":1634456692,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1634456692","product_id":100020801,"comment_content":"为什么SessionA启动事务, 会导致标统计信息不准确?  因为SessionA启动事务后,   由于Mvvc机制, 对表纪录做的更新操作,  都需要保持下来。","like_count":0},{"had_liked":false,"id":315442,"user_name":"zone","can_delete":false,"product_type":"c1","uid":2078885,"ip_address":"","ucode":"06C1BA105D3BE3","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIM05VW3moIQKe85gz4YRlajrPjUTYrK0dW0efbFlfYOibLWww70uNS9gIj2wBickdn7leoPIFErIWw/132","comment_is_top":false,"comment_ctime":1633907682,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1633907682","product_id":100020801,"comment_content":"老师请教3个问题<br>1.扫描行数-》基数估算-》采样统计。我想转下牛角尖问下扫描行数是如何计算出来的？它是根据where语句条件估算出来的吗？<br>2.联合索引基数统计问题<br><br>idx_machant_id_status_type_deleted | 1\t| merchant_id\t| A\t| 68357<br>idx_machant_id_status_type_deleted | 2\t| status\t    | A\t| 123276<br>idx_machant_id_status_type_deleted | 3\t| draft_type\t| A\t| 71050<br>idx_machant_id_status_type_deleted | 4\t| is_deleted\t| A\t| 104516<br>这个联合索引的基数统计让我百思不得其解，理论上来讲统计是根据(merchant),(merchant,status),(merchant,status,type),(merchant,status,type,delete)来做索引统计的，理论上区分度不是应该越来越高吗，就算区分度不会提高也不应该减少啊？<br>3.联合索引创建顺序是不是应该将区分度高的字段放前面？（网上看了好多说区分度好的放后面）","like_count":0},{"had_liked":false,"id":314833,"user_name":"颜海航","can_delete":false,"product_type":"c1","uid":1308159,"ip_address":"","ucode":"5644F6328BF901","user_header":"https://static001.geekbang.org/account/avatar/00/13/f5/ff/523fb378.jpg","comment_is_top":false,"comment_ctime":1633490847,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1633490847","product_id":100020801,"comment_content":"老师 我看这节课的案例中 explain中的using  index condition，using where ,using index 能不能这些 感觉很迷惑","like_count":0,"discussions":[{"author":{"id":1015184,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/7d/90/abb7bfe3.jpg","nickname":"fourge","note":"","ucode":"F3E3FFC4990358","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":582582,"discussion_content":"1. using index condition: 即索引条件（二级索引）下推，在引擎层过滤不符合条件的记录\n2. using where：查找使用索引的情况下，需要回表查询所需的数据\n3. using index: 覆盖索引","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659516631,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":314806,"user_name":"Geek_fa5760","can_delete":false,"product_type":"c1","uid":2795982,"ip_address":"","ucode":"05996A78C09073","user_header":"","comment_is_top":false,"comment_ctime":1633444080,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1633444080","product_id":100020801,"comment_content":"老师你好，mysql既然统计信息一直在发生变化，对于同一个sql，执行计划是否也会一直变化？如果变化的话从慢日志里拿出来sql explain并不能看到慢的时候的执行计划吧，有什么办法嘛。","like_count":0},{"had_liked":false,"id":312209,"user_name":"克克","can_delete":false,"product_type":"c1","uid":2742451,"ip_address":"","ucode":"0FA7CA5AB26A6F","user_header":"https://static001.geekbang.org/account/avatar/00/29/d8/b3/38105dbb.jpg","comment_is_top":false,"comment_ctime":1631684832,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1631684832","product_id":100020801,"comment_content":"老师，我想问下线上可以直接执行drop语句删除索引吗？删除索引的操作会获取mdl写锁吗，还是会有其他的标志位告诉别的操作这个索引被废弃了","like_count":0},{"had_liked":false,"id":309339,"user_name":"阿市","can_delete":false,"product_type":"c1","uid":1320234,"ip_address":"","ucode":"1DF2A71043A644","user_header":"https://static001.geekbang.org/account/avatar/00/14/25/2a/972a5881.jpg","comment_is_top":false,"comment_ctime":1630053573,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1630053573","product_id":100020801,"comment_content":"所以，在知道了索引基数后，再如何去判断扫描行数呢","like_count":0},{"had_liked":false,"id":308188,"user_name":"jzq","can_delete":false,"product_type":"c1","uid":2531565,"ip_address":"","ucode":"CAF2BA2F2092D5","user_header":"https://static001.geekbang.org/account/avatar/00/26/a0/ed/432a1c51.jpg","comment_is_top":false,"comment_ctime":1629444679,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1629444679","product_id":100020801,"comment_content":"在Merge的第三步操作时 <br>对数据的变更：其实就类似一个简单的update语句记录数据变更日志的过程，也是先prepare再commit <br>对change buffer 的变更：比如类似把之前一个记录new change buffer 的记录删掉<br>请问老师我这样理解对嘛","like_count":0},{"had_liked":false,"id":307551,"user_name":"柯察金","can_delete":false,"product_type":"c1","uid":1115149,"ip_address":"","ucode":"F722BF8FCD2C47","user_header":"https://static001.geekbang.org/account/avatar/00/11/04/0d/3dc5683a.jpg","comment_is_top":false,"comment_ctime":1629158072,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1629158072","product_id":100020801,"comment_content":"根据答疑的意思，redo log 是在 merge change buffer 的时候才记录的，那着中间会有时间差啊。如果 change buffer 因为 crash 丢失，那数据也就丢失了？<br><br>还有一点，从之前的留言看，发生 crash 时，都是根据 redo log 恢复的，那 change buffer 为啥要有写表空间的动作啊，感觉没有必要啊","like_count":0},{"had_liked":false,"id":304995,"user_name":"Tsang","can_delete":false,"product_type":"c1","uid":2720215,"ip_address":"","ucode":"5B46AD25EA5BB9","user_header":"https://static001.geekbang.org/account/avatar/00/29/81/d7/629ee141.jpg","comment_is_top":false,"comment_ctime":1627739045,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1627739045","product_id":100020801,"comment_content":"看这些对智力是严峻挑战，不知道那些考上211的学生是不是会很轻松","like_count":0},{"had_liked":false,"id":304042,"user_name":"赴","can_delete":false,"product_type":"c1","uid":2675954,"ip_address":"","ucode":"D47B3179BE3950","user_header":"https://static001.geekbang.org/account/avatar/00/28/d4/f2/3c0bfa0e.jpg","comment_is_top":false,"comment_ctime":1627204550,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1627204550","product_id":100020801,"comment_content":"第二个例子，为什么会基于b索引? 是因为使用了order by 吗?我的理解是排序在索引列是基本上没有多余的消耗的。假如这个查询就是能查出来那么多数据，应该走b更佳，先占个位，再测试一下","like_count":0},{"had_liked":false,"id":300542,"user_name":"prader26","can_delete":false,"product_type":"c1","uid":1433707,"ip_address":"","ucode":"5EFFFC374ADECE","user_header":"https://static001.geekbang.org/account/avatar/00/15/e0/6b/f61d7466.jpg","comment_is_top":false,"comment_ctime":1625212701,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1625212701","product_id":100020801,"comment_content":"mysql 索引异常：<br>1 通常的异常情况为，使用错索引，导致慢查询。<br>2 为什么会使用错索引呢？<br>    因为在执行 sql 之前，优化器会 分析语句，选择不同的索引 导致不同的 扫描行数， 排序等操作，因此存在选错索引的情况。<br>    优化器会判断使用这个索引需要扫描多少行的数据。<br>3  不同的索引会有不同的基数：就是这个索引被多少不同的数据引用（索引的这一列大概有多少数据。） 计算方法即使，随机选取几个数据页，计算出数据量的平均值，然后乘以页数。<br>4 在 MySQL 中，有两种存储索引统计的方式，可以通过设置参数 innodb_stats_persistent 的值来选择：<br>  设置为 on 的时候，表示统计信息会持久化存储。这时，默认的 N 是 20，M 是 10。<br>   设置为 off 的时候，表示统计信息只存储在内存中。这时，默认的 N 是 8，M 是 16。<br>5  应对索引异常的情况，可以采取下面三种方式应对：<br>  5.1  强制使用某个索引。<br>  5.2 修改语句引导mysql使用期望的索引。<br>  5.3 删除或者新建索引。<br>6 analyze table t 命令，可以用来重新统计索引信息。","like_count":0},{"had_liked":false,"id":298859,"user_name":"葫芦娃-Dear","can_delete":false,"product_type":"c1","uid":1743582,"ip_address":"","ucode":"606C2E1D80B612","user_header":"https://static001.geekbang.org/account/avatar/00/1a/9a/de/abd008f3.jpg","comment_is_top":false,"comment_ctime":1624347012,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1624347012","product_id":100020801,"comment_content":"线上有个5万个内容的in查询,发现使用强制索引会全表扫描,不使用强制索引使用的是model_id,version的索引<br>SELECT  <br>  model_id, COUNT( 1) as  device_num, `VERSION`   force index(index_sn)<br>FROM  <br>   `tb_device_upgrade_device_version`<br>WHERE<br>device_id in(5万个sn)<br>GROUP BY model_id, version ;<br>表结构:CREATE TABLE `tb_device_upgrade_device_version` ( `id` int(11) unsigned NOT NULL AUTO_INCREMENT, `model_id` int(11) DEFAULT NULL, `device_id` varchar(50) DEFAULT NULL, `version` varchar(50) DEFAULT NULL, `online_num` int(11) DEFAULT NULL, `b_auto_id` int(11) DEFAULT NULL, `device_type` tinyint(4) DEFAULT NULL, `platform` varchar(10) DEFAULT NULL, `oem_auto_id` int(11) DEFAULT NULL, `channel_id` int(11) DEFAULT NULL, PRIMARY KEY (`id`), KEY `index_sn` (`device_id`) USING BTREE, KEY `index_model_id_version` (`model_id`,`version`) USING BTREE ) ENGINE=InnoDB  DEFAULT CHARSET=utf8<br>在device_id比较少的时候,不使用强制索引也是会走device_id的索引的. 这里已经强制使用索引了,为什么不生效呢,难道是因为in中的内容太多了?","like_count":0},{"had_liked":false,"id":298767,"user_name":"哈哈哈","can_delete":false,"product_type":"c1","uid":1248876,"ip_address":"","ucode":"C40ABE7161EFAE","user_header":"https://static001.geekbang.org/account/avatar/00/13/0e/6c/1f3b1372.jpg","comment_is_top":false,"comment_ctime":1624322145,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1624322145","product_id":100020801,"comment_content":"老师，阿里的mysql分支是否对文中提到的采样统计不精准问题做优化呢","like_count":0},{"had_liked":false,"id":298038,"user_name":"平凡中的不平凡","can_delete":false,"product_type":"c1","uid":1334463,"ip_address":"","ucode":"D1235E6E8378A6","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIdIwR8uj8espUpYYMV0QhP88U4dx3hU5G58RGKuubUiaRgzj5e8WAgucxZibySICEF2rX4ErLJn6lg/132","comment_is_top":false,"comment_ctime":1623895356,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1623895356","product_id":100020801,"comment_content":"优化器选择索引的条件有扫描行，是否有临时表及是否排序等，其中扫描行涉及到区分度的判断。区分度采用随机采样的统计方法。如果存在事务中无序更新表数据可能会产生页分裂导致随机采样统计不准确的情况。可以通过强制索引和analyze table优化。排序情况选择索引要考虑扫描行的问题","like_count":0},{"had_liked":false,"id":295088,"user_name":"Z","can_delete":false,"product_type":"c1","uid":1257299,"ip_address":"","ucode":"8E56D0618F1B76","user_header":"https://static001.geekbang.org/account/avatar/00/13/2f/53/f17cfee2.jpg","comment_is_top":false,"comment_ctime":1622213212,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1622213212","product_id":100020801,"comment_content":"在将操作缓存到 change buffer 时 会将 数据变化写入到redolog中，redolog是不是也是记录两条一条是change buffer 变化，一条是数据的变化？","like_count":0},{"had_liked":false,"id":294183,"user_name":"执念、","can_delete":false,"product_type":"c1","uid":1304683,"ip_address":"","ucode":"96A609813D231F","user_header":"https://static001.geekbang.org/account/avatar/00/13/e8/6b/d76b7540.jpg","comment_is_top":false,"comment_ctime":1621819814,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1621819814","product_id":100020801,"comment_content":"请问下老师一个问题，主库和从库一样的配置，语句如select * from xxx where id &gt; 1230087 and book_id<br>=123   主库选择了id主键索引，从库选择了book_id二级索引（有慢sql），索引选择不一样的原因是什么。","like_count":0},{"had_liked":false,"id":283803,"user_name":"出卖灵魂的教练Kerry","can_delete":false,"product_type":"c1","uid":1807943,"ip_address":"","ucode":"8C64517DA556FE","user_header":"https://static001.geekbang.org/account/avatar/00/1b/96/47/93838ff7.jpg","comment_is_top":false,"comment_ctime":1615943085,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1615943085","product_id":100020801,"comment_content":"老师，merge过程最后，为什么会写redolog呢？之前change buffer已经写了redo，为什么merge还要写呢，想了很久，都想不通，希望老师可以解答！！！","like_count":0,"discussions":[{"author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":370503,"discussion_content":"change buffer写的redo是change buffer数据页的变化，merge之后写的redo是数据的数据页的变化，应该是这样","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1619438141,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":280557,"user_name":"雨的记忆","can_delete":false,"product_type":"c1","uid":1691901,"ip_address":"","ucode":"E55A5CAC977DC6","user_header":"https://static001.geekbang.org/account/avatar/00/19/d0/fd/f7f4fdc3.jpg","comment_is_top":false,"comment_ctime":1614246602,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1614246602","product_id":100020801,"comment_content":"使用change buffer 的情况下会有两次写redo log 吗？  第一次是事务提交，第二次是merge ？","like_count":0,"discussions":[{"author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":370506,"discussion_content":"redo在事务执行过程中也是一直写的，不只是在事务提交的时候，merge时也记录redo","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619439274,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":279325,"user_name":"L","can_delete":false,"product_type":"c1","uid":1135761,"ip_address":"","ucode":"68954D2A92AB01","user_header":"https://static001.geekbang.org/account/avatar/00/11/54/91/845de758.jpg","comment_is_top":false,"comment_ctime":1613721479,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1613721479","product_id":100020801,"comment_content":"drop table if exists test;<br>CREATE TABLE `test` (<br>  `id` int(11) NOT NULL,<br>  `ca` varchar(16) DEFAULT NULL,<br>  PRIMARY KEY (`id`),<br> KEY `ia` (`ca`) USING BTREE<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;<br>truncate test;<br>begin;<br>insert into test (id, ca) values (1, &#39;1&#39;);<br>insert into test (id, ca) values (2, &#39;2&#39;);<br>insert into test (id, ca) values (3, &#39;3&#39;);<br>insert into test (id, ca) values (4, &#39;4&#39;);<br>insert into test (id, ca) values (5, &#39;5&#39;);<br>insert into test (id, ca) values (6, &#39;6&#39;);<br>insert into test (id, ca) values (7, &#39;7&#39;);<br>insert into test (id, ca) values (8, &#39;8&#39;);<br>insert into test (id, ca) values (9, &#39;9&#39;);<br>insert into test (id, ca) values (10, &#39;10&#39;);<br>commit;<br>begin;<br>delete from test where id = 8;<br>insert into test (id, ca) values (8, &#39;1&#39;);<br>commit;<br>执行完后发现排序并不是 按id来排序的<br>EXPLAIN select * from test;<br>发现索引用的是ia  这是为什么呢？<br>","like_count":0,"discussions":[{"author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":370507,"discussion_content":"用到了索引覆盖","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619439419,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":277863,"user_name":"贺子","can_delete":false,"product_type":"c1","uid":2076283,"ip_address":"","ucode":"A64DC9D9CF7CCD","user_header":"https://static001.geekbang.org/account/avatar/00/1f/ae/7b/47200692.jpg","comment_is_top":false,"comment_ctime":1612626997,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1612626997","product_id":100020801,"comment_content":"merge 的执行流程是这样的：<br>从磁盘读入数据页到内存（老版本的数据页）；<br>从 change buffer 里找出这个数据页的 change buffer 记录 (可能有多个），依次应用，得到新版数据页；<br>写 redo log。这个 redo log 包含了数据的变更和 change buffer 的变更。<br>针对这个过程有个疑问？merge的时候也需要写redo，然后开始的时候记录change buffer的时候也记录redo了，那么请问这两次redo记录的内容不冲突吗？或者说分别记录的是什么","like_count":0,"discussions":[{"author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":370508,"discussion_content":"一次写change buffer的，一次写数据的数据页的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619439528,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":277374,"user_name":"Long","can_delete":false,"product_type":"c1","uid":1318970,"ip_address":"","ucode":"2417242560360A","user_header":"https://static001.geekbang.org/account/avatar/00/14/20/3a/90db6a24.jpg","comment_is_top":false,"comment_ctime":1612397814,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1612397814","product_id":100020801,"comment_content":"二刷第7天，温故知新，variables innodb_stats_persistent; 默认值 为on ,选择20页， 10%更新重新更新统计信息，为OFF选择8页，更新16%后重新统计统计信息。<br><br>在RR隔离级别下，未提交事务的读写，可能会影响索引的选择。这个知识点已经忘了。温故知新。","like_count":0},{"had_liked":false,"id":273119,"user_name":"冒旭","can_delete":false,"product_type":"c1","uid":2410735,"ip_address":"","ucode":"EB0591AC4597B3","user_header":"https://static001.geekbang.org/account/avatar/00/24/c8/ef/1251fe4b.jpg","comment_is_top":false,"comment_ctime":1610444490,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1610444490","product_id":100020801,"comment_content":"选择的索引是否和索引顺序有关系，有一次我更改了2个索引的创建顺序，发现两次使用的索引不同","like_count":0},{"had_liked":false,"id":272003,"user_name":"Buffalo","can_delete":false,"product_type":"c1","uid":1198446,"ip_address":"","ucode":"A066E048EBDA33","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/ajNVdqHZLLBLNWibggjw6BHRvG4FoZuQeNtMwCFUepzp36u8u9kf9K2ibcEnoMn876WNAeib7JgIUvK9UPxWeenyQ/132","comment_is_top":false,"comment_ctime":1609906048,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1609906048","product_id":100020801,"comment_content":"除了删除新增操作，update操作会影响统计信息的么？ 比如索引index(a,b)，b字段频繁更新。这样会影响统计的准确性么？","like_count":0,"discussions":[{"author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":370512,"discussion_content":"统计信息也会更新的，根据数据的变化量","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619439732,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":271945,"user_name":"凹凸鸿","can_delete":false,"product_type":"c1","uid":1915334,"ip_address":"","ucode":"A458BAEBF314B2","user_header":"https://static001.geekbang.org/account/avatar/00/1d/39/c6/1e12f271.jpg","comment_is_top":false,"comment_ctime":1609892579,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1609892579","product_id":100020801,"comment_content":"提个建议，留言区左侧空了很大区域，能不能利用起来呢，现在留言文本的显示区域太窄了，显得很拥挤。","like_count":0},{"had_liked":false,"id":271927,"user_name":"凹凸鸿","can_delete":false,"product_type":"c1","uid":1915334,"ip_address":"","ucode":"A458BAEBF314B2","user_header":"https://static001.geekbang.org/account/avatar/00/1d/39/c6/1e12f271.jpg","comment_is_top":false,"comment_ctime":1609866781,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1609866781","product_id":100020801,"comment_content":"当变更的数据行数超过 1&#47;M 的时候，会自动触发重新做一次索引统计。<br>怎么突然冒出个1&#47;M，什么意思？","like_count":0,"discussions":[{"author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":370513,"discussion_content":"M是通过innodb_states_persistent的取值来确定的，取值不同M的值不同","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619439847,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":269392,"user_name":"Geek_e1987e","can_delete":false,"product_type":"c1","uid":2367735,"ip_address":"","ucode":"B44F9EE148409B","user_header":"","comment_is_top":false,"comment_ctime":1608631486,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1608631486","product_id":100020801,"comment_content":"这一讲中说 merge 没有更新磁盘数据，09将中又说merge 是真正进行数据更新的时刻，哪一个是正确的。。。。。。。。。。。。。。","like_count":0,"discussions":[{"author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":370546,"discussion_content":"两个说法都没有错，merge是从change buffer应用变化到数据页上面，可以说是数据更新的时刻，但是数据页更新了记录了redo，数据页就不需要及时更新到磁盘了，也可以说merge没有更新磁盘数据","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619447749,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":267474,"user_name":"poordickey","can_delete":false,"product_type":"c1","uid":1810156,"ip_address":"","ucode":"2A436EC813AF97","user_header":"","comment_is_top":false,"comment_ctime":1607760865,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1607760865","product_id":100020801,"comment_content":"老师的文章出现了很多新的名词时  可以解释下  如果不解释的话  下文就无法理解了  比如刚开始提到基数是指哪个字段  m值代表什么含义  最开始提及的时候都没说明  后面阅读就有点跟不上了","like_count":0},{"had_liked":false,"id":266488,"user_name":"Tank","can_delete":false,"product_type":"c1","uid":2262986,"ip_address":"","ucode":"A7108E83D2D199","user_header":"https://static001.geekbang.org/account/avatar/00/22/87/ca/00cc5a1a.jpg","comment_is_top":false,"comment_ctime":1607352388,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1607352388","product_id":100020801,"comment_content":"请问MySQL单表数据量达到8个亿，索引字段较多是否影响inner、update的性能？","like_count":0},{"had_liked":false,"id":265918,"user_name":"哈姆","can_delete":false,"product_type":"c1","uid":1097042,"ip_address":"","ucode":"B40EFE58BD2D20","user_header":"https://static001.geekbang.org/account/avatar/00/10/bd/52/5994ad51.jpg","comment_is_top":false,"comment_ctime":1607068132,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1607068132","product_id":100020801,"comment_content":"老师，请问一下，全模糊查询 像like %%这种，如何可以让它跑索引呢？","like_count":0,"discussions":[{"author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":370549,"discussion_content":"能用到索引吧？只不过是不能用到索引的快速定位","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619447937,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":262669,"user_name":"Geek_0c1732","can_delete":false,"product_type":"c1","uid":1721278,"ip_address":"","ucode":"6276D0412CCE51","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/ajNVdqHZLLAhj2fB8NI2TPI1SNicgiciczuMUHyAb9HHBkkKJHrgtR162fsicaTqdAneHfuVX7icDXaVibDHstM9L47g/132","comment_is_top":false,"comment_ctime":1605798194,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1605798194","product_id":100020801,"comment_content":"听老师的总结，感觉有时是不是dba遇到的bug属于逻辑bug，只能从源码中找到原因了","like_count":0},{"had_liked":false,"id":260263,"user_name":"Windqiu","can_delete":false,"product_type":"c1","uid":2278659,"ip_address":"","ucode":"EF78D3CF73BCBB","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/TUMtkaIMdbFDS28AhjrQcqOhiapNvHyPMApz9QoZZkShZmomJRh6GX2aL2YeSMg4SicdydzdWxXZOZz49HNS9EtA/132","comment_is_top":false,"comment_ctime":1604971803,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1604971803","product_id":100020801,"comment_content":"请问老师，您说的sessionA和sessionB是开两个窗口的mysql执行命令吗？还是同一个窗口，把开启事务看做sessionA，把执行DDL看做sessionB呢？","like_count":0,"discussions":[{"author":{"id":1649057,"avatar":"https://static001.geekbang.org/account/avatar/00/19/29/a1/41607383.jpg","nickname":"hello","note":"","ucode":"4F42DAA5DB5C38","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":339397,"discussion_content":"肯定是打开两个窗口","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609658008,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":258118,"user_name":"斜杠青年","can_delete":false,"product_type":"c1","uid":1177739,"ip_address":"","ucode":"D7AF02B8588549","user_header":"https://static001.geekbang.org/account/avatar/00/11/f8/8b/74d2ab6b.jpg","comment_is_top":false,"comment_ctime":1604304710,"is_pvip":true,"discussion_count":1,"race_medal":1,"score":"1604304710","product_id":100020801,"comment_content":"没有复现出来第一个现象，有同学帮帮我吗？","like_count":0,"discussions":[{"author":{"id":1649057,"avatar":"https://static001.geekbang.org/account/avatar/00/19/29/a1/41607383.jpg","nickname":"hello","note":"","ucode":"4F42DAA5DB5C38","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":339398,"discussion_content":"估计好多都没有复现","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609658026,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":256805,"user_name":"Pluto","can_delete":false,"product_type":"c1","uid":1324404,"ip_address":"","ucode":"CD99ED8487BC7D","user_header":"https://static001.geekbang.org/account/avatar/00/14/35/74/8eaee356.jpg","comment_is_top":false,"comment_ctime":1603757588,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1603757588","product_id":100020801,"comment_content":"<br>Session A<br>mysql&gt; explain select * from t where a between 10000 and 20000;<br>+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+<br>| id | select_type | table | partitions | type  | possible_keys | key  | key_len | ref  | rows  | filtered | Extra                 |<br>+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+<br>|  1 | SIMPLE      | t     | NULL       | range | a             | a    | 5       | NULL | 10001 |   100.00 | Using index condition |<br>+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+<br>1 row in set, 1 warning (0.00 sec)<br><br>mysql&gt; start transaction with consistent snapshot;<br>Query OK, 0 rows affected (0.00 sec)<br><br>mysql&gt; commit<br>    -&gt; ;<br>Query OK, 0 rows affected (0.00 sec)<br><br>Session B:<br><br>mysql&gt; use first;<br>Database changed<br>mysql&gt; delete from t;<br>Query OK, 100000 rows affected (0.44 sec)<br><br>mysql&gt; call idata();<br>Query OK, 1 row affected (59.20 sec)<br><br>mysql&gt;<br>mysql&gt;<br>mysql&gt;<br>mysql&gt; explain select * from t where a between 10000 and 20000;<br>+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+<br>| id | select_type | table | partitions | type  | possible_keys | key  | key_len | ref  | rows  | filtered | Extra                 |<br>+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+<br>|  1 | SIMPLE      | t     | NULL       | range | a             | a    | 5       | NULL | 10001 |   100.00 | Using index condition |<br>+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+<br>1 row in set, 1 warning (0.00 sec)<br><br>mysql&gt;<br>","like_count":0},{"had_liked":false,"id":253847,"user_name":"LinSharry","can_delete":false,"product_type":"c1","uid":1622499,"ip_address":"","ucode":"74828240C1FF99","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqyr8VM0QCSDaiaQ5K8OFF3o6h3rwucDicYNhKxaxqEanic9aWfd3bOuopUPza6uTfskpELQms8QBvdQ/132","comment_is_top":false,"comment_ctime":1602917972,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1602917972","product_id":100020801,"comment_content":"对第九讲的回答越看越疑惑：感觉作者自己都不知道在讲什么，在第９讲changebuffer和redolog的读操作示例时说道，和系统表空间和redo log无关，在这部分回答中，又说与redo log有关，到底以哪个为准，希望作者在描述细节的时候尽量用准确的语言．比如更新内存时希望描述成更新到具体的内存名字，如何进行更新的，更新操作涉及的细节等做出描述．而不是写将更新到内存就完了．希望作者重新写下第９将，尽量把更新设涉及到的细节描述清楚，而不是泛泛而谈","like_count":0},{"had_liked":false,"id":251741,"user_name":"崔经刚","can_delete":false,"product_type":"c1","uid":1827943,"ip_address":"","ucode":"207FDF850860C4","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/P5lTnAkviacPGu5S5XJQGQdTpvkSjAVU9Nu2EYicIpMAjiaNP8aXDtfcIHicSnHw2fVIoqTWGGg48rZVzcficUlbgmw/132","comment_is_top":false,"comment_ctime":1601819136,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1601819136","product_id":100020801,"comment_content":"老师，我按照您的步骤来也无法复现。我是复现的步骤是这样的：<br>首先，确认是可重复读隔离级别：<br>show variables like &#39;transaction_isolation&#39;;<br>+-----------------------+-----------------+<br>| Variable_name         | Value           |<br>+-----------------------+-----------------+<br>| transaction_isolation | REPEATABLE-READ |<br>+-----------------------+-----------------+<br><br>session A：<br>           1. 先删掉表t —— drop table t；<br>           3. 创建表t<br>mysql&gt; CREATE TABLE `t` (<br>    -&gt;   `id` int(11) NOT NULL,<br>    -&gt;   `a` int(11) DEFAULT NULL,<br>    -&gt;   `b` int(11) DEFAULT NULL,<br>    -&gt;   PRIMARY KEY (`id`),<br>    -&gt;   KEY `a` (`a`),<br>    -&gt;   KEY `b` (`b`)<br>    -&gt; ) ENGINE=InnoDB;<br><br>         3. 执行存储过程，插入10万行数据   call idata();<br>接着是session B：<br>          1. 开启事务   start transaction with consistent snapshot;<br>紧接着是session C：<br>          1. delete掉表 t 的所有数据    delete from t;<br>          2. 执行存储过程，插入10万行数据    call idata();<br>          3. 执行select操作<br>explain select * from t where a between 10000 and 20000;<br>+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+<br>| id | select_type | table | partitions | type  | possible_keys | key  | key_len | ref  | rows  | filtered | Extra                 |<br>+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+<br>|  1 | SIMPLE      | t     | NULL       | range | a             | a    | 5       | NULL | 10001 |   100.00 | Using index condition |<br>+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+<br><br>发现选择的索引还是 a <br><br>请问，mysql是修复了选错索引的这个bug了吗？我的mysql版本是5.7.31的<br>root@localhost ~]# mysql -Vsersion<br>mysql  Ver 14.14 Distrib 5.7.31, for Linux (x86_64) using  EditLine wrapper","like_count":0},{"had_liked":false,"id":246379,"user_name":"学习学个屁","can_delete":false,"product_type":"c1","uid":1049017,"ip_address":"","ucode":"DF2D61E6FB2FCE","user_header":"https://static001.geekbang.org/account/avatar/00/10/01/b9/73435279.jpg","comment_is_top":false,"comment_ctime":1599302333,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1599302333","product_id":100020801,"comment_content":"为什么使用limit的时候 会让mysql觉得使用索引代价高呢,是因为数据量大,我只想拿100条??","like_count":0},{"had_liked":false,"id":243284,"user_name":"black_mirror","can_delete":false,"product_type":"c1","uid":1320092,"ip_address":"","ucode":"2549C87298BF12","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q3auHgzwzM4z9WYWVvWDhMF0SicPE5ad56ME6DibyWGbRoQa0lH4U9icdsjNcv3ssRickcuRMDA01e6vMXnmOVSr9l5LVUefVxicn/132","comment_is_top":false,"comment_ctime":1598014681,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1598014681","product_id":100020801,"comment_content":"我要给爸爸买辆二手车(已买)<br>号外，号外，我终于把开头例子给复现了，修改建表语句（id自增），存储过程代码（不要指定id值）如下，即可复现不选择索引a问题：<br>CREATE TABLE `t` (<br>  `id` int(11) auto_increment,<br>  `a` int(11) DEFAULT NULL,<br>  `b` int(11) DEFAULT NULL,<br>  PRIMARY KEY (`id`),<br>  KEY `a` (`a`),<br>  KEY `b` (`b`)<br>) ENGINE=InnoDB;<br><br>delimiter ;;<br>create procedure idata()<br>begin<br>  declare i int;<br>  set i=1;<br>  while(i&lt;=100000)do<br>    insert into t (`a`,`b`) values(i, i);<br>    set i=i+1;<br>  end while;<br>end;;<br>delimiter ;<br><br>一个米屌<br>8.0.19也重现了。。但是为什么呢<br>-----------------------------<br><br>在rr模式，innodb表，session a先开启一致性读前提下; session b(delete+call data())：<br>因为是给自增PK显示赋值，同时赋的值都小于当前自增值auto_increment=100001，因此自增值就不再发生变化<br>即使事务a开启一致性读，感觉被标记为delete的空间被重复利用，没有申请新的空间，统计信息没有发生变化<br>这个例子中，因为显示给PK赋值其实数据并没有发生变化，因此也不影响session a看到的数据，即可重复读<br>非显示给PK赋值，采用自增属性自动赋值，因为PK值不同，需要申请新的空间<br><br>请问老师这么理解对吗？<br>","like_count":0},{"had_liked":false,"id":240052,"user_name":"prepared","can_delete":false,"product_type":"c1","uid":1194853,"ip_address":"","ucode":"00E54A5C7CDCBE","user_header":"https://static001.geekbang.org/account/avatar/00/12/3b/65/3a4fc8cf.jpg","comment_is_top":false,"comment_ctime":1596727506,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1596727506","product_id":100020801,"comment_content":"老师用的什么版本的 mysql ？复现不了问题。<br><br>EXPLAIN select * from t where a between 10000 and 20000; &#47;*Q1*&#47;<br>EXPLAIN select * from t force index(a) where a between 10000 and 20000;&#47;*Q2*&#47;<br><br>mysql版本： 5.7.31 MySQL Community Server (GPL)","like_count":0},{"had_liked":false,"id":238837,"user_name":"Geek_e8d55e","can_delete":false,"product_type":"c1","uid":1602239,"ip_address":"","ucode":"5F13626B0E1E45","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKyobcyicicCQoldZofsS36xrjA2R2hk2F89pu1hCqwjlRaRG4xKkgCicZibEVdOwpfN5rWjEchrsxicSQ/132","comment_is_top":false,"comment_ctime":1596339148,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1596339148","product_id":100020801,"comment_content":"Using index condition是指索引下推吧?索引也不是联合索引，没什么好过滤的啊，为啥例子中的很多查询都有走索引下推？","like_count":0},{"had_liked":false,"id":237631,"user_name":"查冠友","can_delete":false,"product_type":"c1","uid":1402749,"ip_address":"","ucode":"C0F1B5BD2CA29E","user_header":"https://static001.geekbang.org/account/avatar/00/15/67/7d/dbc8d10a.jpg","comment_is_top":false,"comment_ctime":1595905531,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1595905531","product_id":100020801,"comment_content":"老师好，面试经常被问到什么情况会导致索引失效？<br>1、关于字段中有null、或者使用is null和is not null 时索引是否会失效？<br>2、还有使用or时的情况，比如or前字段有索引后字段没有索引、联合索引（a, b, c）b前用了or，c还能使用索引吗？<br>网上说什么的都有，老师能帮忙解答一下吗？","like_count":0,"discussions":[{"author":{"id":1303322,"avatar":"https://static001.geekbang.org/account/avatar/00/13/e3/1a/061e77b6.jpg","nickname":"亢星东","note":"","ucode":"5E4063E83B2BB9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":315426,"discussion_content":"is null  is not null 不会走索引","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603273447,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":236860,"user_name":"xiao.bona","can_delete":false,"product_type":"c1","uid":1064758,"ip_address":"","ucode":"183B35082F67B1","user_header":"https://static001.geekbang.org/account/avatar/00/10/3f/36/2b791093.jpg","comment_is_top":false,"comment_ctime":1595570267,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1595570267","product_id":100020801,"comment_content":"貌似没有重现删除表记录后重新添加记录 扫描行记录的变化。<br>&#47;***********************************************************<br> session a 2020-07-24 13:25:07 <br> ***********************************************************&#47;<br>mysql&gt; start transaction with consistent snapshot;<br><br>mysql&gt; select count(*) from t; <br>&#47;* count(*) :100000 *&#47;<br><br>mysql&gt; select now(); <br>&#47;* 2020-07-24 13:26:18 *&#47;<br>mysql&gt; select count(*) from t;<br>&#47;* count(*) :100000 *&#47;<br><br><br>&#47;************************************************************************<br> session b 2020-07-24 13:25:17 <br> ************************************************************************&#47;<br>mysql&gt; select count(*) from t;<br>&#47;* count(*) :100000 *&#47;<br><br>mysql&gt; explain select * from t where a between 10000 and 20000;<br><br>| id | select_type | table | type  | possible_keys | key  | key_len | ref  | rows  | Extra       |<br>|  1 | SIMPLE      | t     | range | a             | a    | 5       | NULL | 10000 | Using where |<br><br>mysql&gt; delete from t;<br>Query OK, 100000 rows affected (0.79 sec)<br><br>mysql&gt; select now();&#47;*  2020-07-24 13:26:10 *&#47;<br>mysql&gt; select count(*) from t; &#47;* count(*) :0 *&#47;<br><br>mysql&gt; explain select * from t where a between 10000 and 20000;<br>| id | select_type | table | type  | possible_keys | key  | key_len | ref  | rows  | Extra       |<br>|  1 | SIMPLE      | t     | range | a             | a    | 5       | NULL | 10000 | Using where |<br><br>mysql&gt; call idata();<br>Query OK, 1 row affected (2.15 sec)<br><br>mysql&gt; explain select * from t where a between 10000 and 20000;<br>| id | select_type | table | type  | possible_keys | key  | key_len | ref  | rows  | Extra       |<br>|  1 | SIMPLE      | t     | range | a             | a    | 5       | NULL | 10000 | Using where |<br><br>","like_count":0},{"had_liked":false,"id":233041,"user_name":"端赖柔嘉","can_delete":false,"product_type":"c1","uid":2033321,"ip_address":"","ucode":"DD08DBCF2BF76B","user_header":"https://static001.geekbang.org/account/avatar/00/1f/06/a9/308187cb.jpg","comment_is_top":false,"comment_ctime":1594200175,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1594200175","product_id":100020801,"comment_content":"老师请问联合索引在搜索的过程中是怎么执行的？比如有（a，b）这样的联合索引 select * from table where a=1 and b=2这样的sql语句。是先找a然后找b，还是a，b一块找的？","like_count":0},{"had_liked":false,"id":230263,"user_name":"静静聆听","can_delete":false,"product_type":"c1","uid":1263932,"ip_address":"","ucode":"0A8600CB928EFE","user_header":"https://static001.geekbang.org/account/avatar/00/13/49/3c/5d54c510.jpg","comment_is_top":false,"comment_ctime":1593330537,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1593330537","product_id":100020801,"comment_content":"老师，关于课后问题回答，第三条“写 redo log。这个 redo log 包含了数据的变更和 change buffer 的变更。”，有两点疑问：<br>1、之前的数据变更已经记录到redo log了，为什么还要记录<br>2、change buffer的变更属于内存层面的，为什么要记录redo log","like_count":0,"discussions":[{"author":{"id":1208499,"avatar":"https://static001.geekbang.org/account/avatar/00/12/70/b3/5d27c25d.jpg","nickname":"优秀是一种习惯","note":"","ucode":"5131AE84B04F95","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":299789,"discussion_content":"如果change buffer没有及时merge 要落盘在系统表空间，redolog 就是用来崩溃恢复change buffer到系统表空间的","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1597820170,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":230189,"user_name":"沈哒哒","can_delete":false,"product_type":"c1","uid":2035731,"ip_address":"","ucode":"77ACC760C8FA4B","user_header":"https://static001.geekbang.org/account/avatar/00/1f/10/13/e7cf06a2.jpg","comment_is_top":false,"comment_ctime":1593306681,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1593306681","product_id":100020801,"comment_content":"老师，问个问题，是因为session A的原因导致session  B的数据没删除吗，还是delete删除后，由于写入change buffer没合的原因","like_count":0,"discussions":[{"author":{"id":1208499,"avatar":"https://static001.geekbang.org/account/avatar/00/12/70/b3/5d27c25d.jpg","nickname":"优秀是一种习惯","note":"","ucode":"5131AE84B04F95","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":299792,"discussion_content":"sessionA mvcc 使数据没有真正的删除，数据页还在，又新插入的10w，又产生的新的数据页","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597822116,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":228806,"user_name":"thong","can_delete":false,"product_type":"c1","uid":1369211,"ip_address":"","ucode":"C9DF492B704CD0","user_header":"https://static001.geekbang.org/account/avatar/00/14/e4/7b/2258ef5d.jpg","comment_is_top":false,"comment_ctime":1592814714,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1592814714","product_id":100020801,"comment_content":"600万的表，update in（10000个主键id），用上了主键索引，但是select_type由range变为index，导致扫描行数退化非常严重，in 4000的时候还是range，不太明白为什么会退化","like_count":0,"discussions":[{"author":{"id":1208499,"avatar":"https://static001.geekbang.org/account/avatar/00/12/70/b3/5d27c25d.jpg","nickname":"优秀是一种习惯","note":"","ucode":"5131AE84B04F95","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":299794,"discussion_content":"关键字搜index dive，in里值多，可能退化全表扫描","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597822305,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2036786,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/14/32/e37762cb.jpg","nickname":"标准码农","note":"","ucode":"F1AAA474EC0619","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":286339,"discussion_content":"是不是更新的这些id 分布比较散 不集中在几个数据页内 ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1593139990,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":228192,"user_name":"海鸟","can_delete":false,"product_type":"c1","uid":1028311,"ip_address":"","ucode":"EBAF85D1EFFAAB","user_header":"https://static001.geekbang.org/account/avatar/00/0f/b0/d7/22ce0046.jpg","comment_is_top":false,"comment_ctime":1592584392,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1592584392","product_id":100020801,"comment_content":"林老师好，MySQL 8 好像重现不了这个现象，是不是加了什么特性优化这块？","like_count":0},{"had_liked":false,"id":225497,"user_name":"along","can_delete":false,"product_type":"c1","uid":1118419,"ip_address":"","ucode":"0F44495219E0BC","user_header":"https://static001.geekbang.org/account/avatar/00/11/10/d3/157068af.jpg","comment_is_top":false,"comment_ctime":1591769915,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1591769915","product_id":100020801,"comment_content":"我试了两次都没有成功，是什么原因呢？<br>=======================Session B===========================<br>mysql&gt; &#47;* session B *&#47; explain select * from t where a between 10000 and 20000;<br>+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+<br>| id | select_type | table | partitions | type  | possible_keys | key  | key_len | ref  | rows  | filtered | Extra                 |<br>+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+<br>|  1 | SIMPLE      | t     | NULL       | range | a             | a    | 5       | NULL | 10001 |   100.00 | Using index condition |<br>+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+<br>1 row in set, 1 warning (0.01 sec)<br><br>mysql&gt; delete from t;<br>Query OK, 99999 rows affected (0.66 sec)<br><br>mysql&gt; call idata();<br>Query OK, 1 row affected (36.58 sec)<br><br>mysql&gt; explain select * from t where a between 10000 and 20000;<br>+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+<br>| id | select_type | table | partitions | type  | possible_keys | key  | key_len | ref  | rows  | filtered | Extra                 |<br>+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+<br>|  1 | SIMPLE      | t     | NULL       | range | a             | a    | 5       | NULL | 10001 |   100.00 | Using index condition |<br>+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+<br>1 row in set, 1 warning (0.00 sec)<br><br>=======================Session A===========================<br><br>mysql&gt; &#47;* sesson A*&#47; start transaction with consistent snapshot;<br>Query OK, 0 rows affected (0.00 sec)","like_count":0},{"had_liked":false,"id":225455,"user_name":"HaydnSyx","can_delete":false,"product_type":"c1","uid":1185263,"ip_address":"","ucode":"2B4241CD385875","user_header":"https://static001.geekbang.org/account/avatar/00/12/15/ef/84ed23fb.jpg","comment_is_top":false,"comment_ctime":1591758989,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1591758989","product_id":100020801,"comment_content":"老师，我在线上遇到一个特别奇怪的问题：<br>explain select amount, out_transaction_id, transaction_account_id from money_fund_pre_buy_order where uid = 575534929 and status in (&#39;new&#39;,&#39;wait&#39;);<br>分析出来的结果是全表扫描，一个索引也不选择，<br>+----+-------------+--------------------------+------+------------------------+------+---------+------+---------+-------------+<br>| id | select_type | table                    | type | possible_keys          | key  | key_len | ref  | rows    | Extra       |<br>+----+-------------+--------------------------+------+------------------------+------+---------+------+---------+-------------+<br>|  1 | SIMPLE      | money_fund_pre_buy_order | ALL  | idx_status_uid,idx_uid | NULL | NULL    | NULL | 2006693 | Using where |<br>+----+-------------+--------------------------+------+------------------------+------+---------+------+---------+-------------+<br>这个表的索引信息如下：<br>  PRIMARY KEY (`id`),<br>  UNIQUE KEY `idx_transaction_id` (`out_transaction_id`),<br>  KEY `idx_status_uid` (`status`,`uid`),<br>  KEY `idx_uid` (`uid`) USING BTREE<br>老师能分析一下这个可能产生的原因吗","like_count":0},{"had_liked":false,"id":224002,"user_name":"shawn","can_delete":false,"product_type":"c1","uid":1010221,"ip_address":"","ucode":"8F6A8C7920996E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/6a/2d/ec4ed8ce.jpg","comment_is_top":false,"comment_ctime":1591253585,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1591253585","product_id":100020801,"comment_content":"老师，可以画一下联合索引的结构图，这样可以很好的解释为什么有最左前缀原则。","like_count":0},{"had_liked":false,"id":217981,"user_name":"Jc.Chen","can_delete":false,"product_type":"c1","uid":1180676,"ip_address":"","ucode":"36886491352CD4","user_header":"https://static001.geekbang.org/account/avatar/00/12/04/04/0af56558.jpg","comment_is_top":false,"comment_ctime":1589686052,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1589686052","product_id":100020801,"comment_content":"老师，有个问题：<br>我们用 limit 100 让优化器意识到，使用 b 索引代价是很高的<br><br>为啥limit 100 能让优化器意识到使用b索引代价很高？limit 1和limit 100不都是只是遍历不用排序吗（因为b有索引）？","like_count":0},{"had_liked":false,"id":216620,"user_name":"秦培荣","can_delete":false,"product_type":"c1","uid":1495143,"ip_address":"","ucode":"DFC1EB3001730D","user_header":"https://static001.geekbang.org/account/avatar/00/16/d0/67/32a8f861.jpg","comment_is_top":false,"comment_ctime":1589297011,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1589297011","product_id":100020801,"comment_content":"你好，一个表中有100条记录，记录有id 订单号和下单时间，其中下单时间是今天的有50条，下单时间有索引，根据下单时间查询记录，发现执行计划没有用下单时间索引，走了全表扫描，不知道是为啥，求帮助，谢谢，是优化器又选错索引了吗","like_count":0},{"had_liked":false,"id":211998,"user_name":"谁还不是个小公主是咋滴","can_delete":false,"product_type":"c1","uid":1723955,"ip_address":"","ucode":"8E35446E63541A","user_header":"https://static001.geekbang.org/account/avatar/00/1a/4e/33/029194b5.jpg","comment_is_top":false,"comment_ctime":1588044159,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1588044159","product_id":100020801,"comment_content":"今天遇到了一个问题，再回来看这篇文章,但是没有解决。希望老师和各位大神能指点下：<br>背景：<br>t表数据:3378564<br>biz_type  int(4) Not Null<br>current_max_id bigint(20)  Not Null<br><br>sql:<br>SELECT biz_type, MAX(current_max_id) AS current_max_id,`offset` FROM t  GROUP BY biz_type<br><br>问题描述：<br>在表t 中添加索引 idx_biz_type(`biz_type`) 和索引 idx_biz_current_max_id(`biz_type`,current_max_id);<br>查看执行计划,走第一个索引，ken_len 为4  （正常）<br><br>删除idx_biz_type(`biz_type`) 再次查看执行计划, 可以看到SQL走了复合索引（biz_type,current_max_id）ken_len 为20<br><br>问题1：索引列上有函数的话，此列上的索引会失效吗？如果会的话，怎么还用到了索引第二列？<br>问题2 ：为什么两个索引都存在的情况，优化器选择了前者？<br>","like_count":0,"discussions":[{"author":{"id":1537739,"avatar":"https://static001.geekbang.org/account/avatar/00/17/76/cb/83b62223.jpg","nickname":"灵雨既零","note":"","ucode":"6DB62A9EB731FA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":342949,"discussion_content":"1、索引列上有函数是指在where 条件哪里\n2、因为符合最左匹配原则所以用了biz_type","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1610885337,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":211003,"user_name":"baronouyang","can_delete":false,"product_type":"c1","uid":1941572,"ip_address":"","ucode":"46E6ADAF91021C","user_header":"https://static001.geekbang.org/account/avatar/00/1d/a0/44/528be246.jpg","comment_is_top":false,"comment_ctime":1587879950,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1587879950","product_id":100020801,"comment_content":"哈喽，老师，我这边有个问题想请教一下：<br><br>我有一个sql语句explain看已经命中了索引，扫描行数有13w行数据（总共56万行数据）<br>但是当我使用force index 后， 扫描行数只有4万行，不知道是什么原因了？","like_count":0},{"had_liked":false,"id":209234,"user_name":"Sparrow","can_delete":false,"product_type":"c1","uid":1693667,"ip_address":"","ucode":"88D3F3920C68BC","user_header":"https://static001.geekbang.org/account/avatar/00/19/d7/e3/e6cf6352.jpg","comment_is_top":false,"comment_ctime":1587521808,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1587521808","product_id":100020801,"comment_content":"原来猜错了， 以为msyql在多个索引查询的时候，会取出每个索引的查询结果，做个交集再回表。<br>比如<br>select * from t where (a between 1 and 1000)  and (b between 50000 and 100000) ；这个语句<br>先取出a 在0~1000的主键集合，  然后再取出b在50000~100000的主键集合， 做个交集运算，然后回表取出数据。<br>请问不这么做是因为性价比问题吗？比如只能用于全部索引查询的情况，交集多了性能更差， 还有实现复杂度的原因？<br><br>有没有这么实现查询的数据库？<br>","like_count":0},{"had_liked":false,"id":208808,"user_name":"红颜铭心","can_delete":false,"product_type":"c1","uid":1889026,"ip_address":"","ucode":"18F94E5444C71A","user_header":"","comment_is_top":false,"comment_ctime":1587441235,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1587441235","product_id":100020801,"comment_content":"老师，索引基数读取的是index page，并不是data page。还有change buffer也只是优化非唯一二级索引的更新操作，<br>针对的也是index page，而不是data page。辛苦在文中更正下。","like_count":0},{"had_liked":false,"id":204884,"user_name":"englefly","can_delete":false,"product_type":"c1","uid":1145907,"ip_address":"","ucode":"E3FCF19E618718","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83ep2gRIticwS6CiatsCiaU4QRjAODKibQevrhSciatrmd90lNIZFxywE9yyZgAxKTmWiaBSH4zZUcRIV46qQ/132","comment_is_top":false,"comment_ctime":1586486633,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1586486633","product_id":100020801,"comment_content":"林老师，您好，有一个hash 索引的问题想请教一下。<br>mysql 里 一个 hash 索引会创建多少个 bucket呢？一般来说bucket数量 和 被hash元素的数量有很强的关系，比如是1.5倍。但数据库表中tuple的数量是变化的，而且建索引的时候表可能是空的，那mysql怎么知道应该建多少个bucket呢？","like_count":0},{"had_liked":false,"id":198848,"user_name":"Ryan","can_delete":false,"product_type":"c1","uid":1667987,"ip_address":"","ucode":"95BBBEE5B23878","user_header":"https://static001.geekbang.org/account/avatar/00/19/73/93/0a3a1e5b.jpg","comment_is_top":false,"comment_ctime":1585470428,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1585470428","product_id":100020801,"comment_content":"判断扫描行数：MySQL 在真正开始执行语句之前，并不能精确地知道满足这个条件的记录有多少条，而只能根据统计信息来估算记录数。这个统计信息就是索引的“区分度”。显然，一个索引上不同的值越多，这个索引的区分度就越好。而一个索引上不同的值的个数，我们称之为“基数”（cardinality）。也就是说，这个基数越大，索引的区分度越好。","like_count":0},{"had_liked":false,"id":194057,"user_name":"喻茂","can_delete":false,"product_type":"c1","uid":1318661,"ip_address":"","ucode":"C8BD8086A17365","user_header":"https://static001.geekbang.org/account/avatar/00/14/1f/05/8a06692e.jpg","comment_is_top":false,"comment_ctime":1585019917,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1585019917","product_id":100020801,"comment_content":"10.1.34-MariaDB  就算有事务配合也没有出现上面的情况，show index from t; Cardinality值都是1万多","like_count":0},{"had_liked":false,"id":190980,"user_name":"南山","can_delete":false,"product_type":"c1","uid":1119593,"ip_address":"","ucode":"94656FE4A6C378","user_header":"https://static001.geekbang.org/account/avatar/00/11/15/69/187b9968.jpg","comment_is_top":false,"comment_ctime":1584715668,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1584715668","product_id":100020801,"comment_content":"真实遇到过选错索引，当时只是用force index解决，没细想原理","like_count":0},{"had_liked":false,"id":188123,"user_name":"哈密锅儿","can_delete":false,"product_type":"c1","uid":1792142,"ip_address":"","ucode":"35B34503F530AB","user_header":"https://static001.geekbang.org/account/avatar/00/1b/58/8e/97b20eb3.jpg","comment_is_top":false,"comment_ctime":1584322936,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1584322936","product_id":100020801,"comment_content":"MySQL采样统计计算索引区分度的时候，有时准有时不准，不确切的说，这是一个概率问题。大部分情况下，会把索引建立在索引区分度高的列上，如果索引区分度很低，那么就算建立索引，查询效率也不高。","like_count":0},{"had_liked":false,"id":187216,"user_name":"深白色","can_delete":false,"product_type":"c1","uid":1123171,"ip_address":"","ucode":"C4B26AB70D8A6D","user_header":"https://static001.geekbang.org/account/avatar/00/11/23/63/4fb6fee0.jpg","comment_is_top":false,"comment_ctime":1584062807,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1584062807","product_id":100020801,"comment_content":"很疑惑，并没有复现成功。<br>Server version: 5.7.28-log MySQL Community Server (GPL)<br><br>session A:<br>mysql&gt; start transaction with consistent snapshot;<br>Query OK, 0 rows affected (0.00 sec)<br>--中间等待session B的操作<br>mysql&gt; commit;<br>Query OK, 0 rows affected (0.00 sec)<br><br><br>session B:<br>mysql&gt; select @@global.tx_isolation;<br>+-----------------------+<br>| @@global.tx_isolation |<br>+-----------------------+<br>| REPEATABLE-READ       |<br>+-----------------------+<br>1 row in set, 1 warning (0.00 sec)<br><br>mysql&gt; delete from t;<br>Query OK, 100000 rows affected (1.09 sec)<br><br>mysql&gt; call idata();<br>Query OK, 1 row affected (34.93 sec)<br><br>mysql&gt; explain select * from t where a between 10000 and 20000;<br>+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+<br>| id | select_type | table | partitions | type  | possible_keys | key  | key_len | ref  | rows  | filtered | Extra                 |<br>+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+<br>|  1 | SIMPLE      | t     | NULL       | range | a             | a    | 5       | NULL | 10001 |   100.00 | Using index condition |<br>+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+<br>1 row in set, 1 warning (0.00 sec)<br>","like_count":0},{"had_liked":false,"id":184493,"user_name":"天天向上","can_delete":false,"product_type":"c1","uid":1242455,"ip_address":"","ucode":"0CCCA6F4DCC480","user_header":"https://static001.geekbang.org/account/avatar/00/12/f5/57/ce10fb1b.jpg","comment_is_top":false,"comment_ctime":1583328354,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1583328354","product_id":100020801,"comment_content":"（1）change buffer 的操作也记录到 redo log 里，和（2） merge 的执行流程中，写 redo log。这个 redo log 包含了数据的变更和 change buffer 的变更，两个是否重复呢？<br>1中已经记录redo log了，之后落盘，那2中获取到的新数据页中是从磁盘获取的，应该就包含了change buffer中的数据了吧，那就没有必要merge了吧？","like_count":0,"discussions":[{"author":{"id":1208499,"avatar":"https://static001.geekbang.org/account/avatar/00/12/70/b3/5d27c25d.jpg","nickname":"优秀是一种习惯","note":"","ucode":"5131AE84B04F95","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":299799,"discussion_content":"change buffer没有及时merge要落盘，存在系统表空间，（1）中redolog目的恢复系统表空间的change buffer。（2）中redo log 就是正常数据页的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597824041,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":183073,"user_name":"ipofss","can_delete":false,"product_type":"c1","uid":1018620,"ip_address":"","ucode":"DE3061C9259F9E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8a/fc/d1dd57dd.jpg","comment_is_top":false,"comment_ctime":1582948655,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1582948655","product_id":100020801,"comment_content":"若后续出现索引选择失败的场景，可以这样做：<br>1、使用force index<br>2、调整sql语句<br>3、调整索引，加索引，减索引<br><br>但归根结底，MySQL的问题还是应该有MySQL来解决，相信在后续的版本中会解决这个问题，或者在进行优化，使出现选错索引的case更少","like_count":0},{"had_liked":false,"id":182990,"user_name":"乔丹","can_delete":false,"product_type":"c1","uid":1217413,"ip_address":"","ucode":"D832A9F97A0C7E","user_header":"https://static001.geekbang.org/account/avatar/00/12/93/85/f5d9474c.jpg","comment_is_top":false,"comment_ctime":1582902571,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1582902571","product_id":100020801,"comment_content":"这节课的难度没有上节课那么高。哈哈。<br>这节课的核心就是：mysql的优化器可能会选错索引。<br>为啥会选错索引呢？ <br>这就导出了选索引的点（行数，是否为临时表，是否排序等）；如何解决选错索引的问题？","like_count":0},{"had_liked":false,"id":179853,"user_name":"Casper","can_delete":false,"product_type":"c1","uid":1022129,"ip_address":"","ucode":"69282EB175B48E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/98/b1/f89a84d0.jpg","comment_is_top":false,"comment_ctime":1582111215,"is_pvip":true,"discussion_count":0,"race_medal":5,"score":"1582111215","product_id":100020801,"comment_content":"老师，我复现出来的情况很诡异,  数据库版本是 mysql5.6.42, 确认开启了RR，慢查询日志是:<br># Time: 200219 11:17:24<br># User@Host: root[root] @ localhost []  Id:     6<br># Query_time: 0.042119  Lock_time: 0.000256 Rows_sent: 10001  Rows_examined: 100000<br>SET timestamp=1582111044;<br>select * from t where a between 10000 and 20000;<br># Time: 200219 11:17:32<br># User@Host: root[root] @ localhost []  Id:     6<br># Query_time: 0.034305  Lock_time: 0.000269 Rows_sent: 10001  Rows_examined: 10001<br>SET timestamp=1582111052;<br>select * from t force index(a) where a between 10000 and 20000;<br><br>还望老师解惑一下, 谢谢老师。","like_count":0},{"had_liked":false,"id":177393,"user_name":"小予","can_delete":false,"product_type":"c1","uid":1442580,"ip_address":"","ucode":"3F5EAEE1746074","user_header":"https://static001.geekbang.org/account/avatar/00/16/03/14/e9ca2d09.jpg","comment_is_top":false,"comment_ctime":1581387048,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1581387048","product_id":100020801,"comment_content":"select * from t where a between 10000 and 20000; 这个例子我按老师的操作，MySQL没有选错索引，是MySQL的特定版本才有这个问题么，我的版本是5.7.27","like_count":0},{"had_liked":false,"id":175213,"user_name":"星之所在","can_delete":false,"product_type":"c1","uid":1247574,"ip_address":"","ucode":"03ADB0ADD5FC27","user_header":"https://static001.geekbang.org/account/avatar/00/13/09/56/2628852c.jpg","comment_is_top":false,"comment_ctime":1580617474,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1580617474","product_id":100020801,"comment_content":"我之前也遇到类似问题，mysql优化器选择","like_count":0},{"had_liked":false,"id":174411,"user_name":"与狼共舞","can_delete":false,"product_type":"c1","uid":1391144,"ip_address":"","ucode":"02AC04B43F0194","user_header":"https://static001.geekbang.org/account/avatar/00/15/3a/28/cf707831.jpg","comment_is_top":false,"comment_ctime":1580195960,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1580195960","product_id":100020801,"comment_content":"不知道是不是因为我使用的是mysql8.0版本的问题，文章的这个问题没有重现成功。","like_count":0},{"had_liked":false,"id":174223,"user_name":"飘逸的翔云","can_delete":false,"product_type":"c1","uid":1254012,"ip_address":"","ucode":"0E756D3AC3D889","user_header":"https://static001.geekbang.org/account/avatar/00/13/22/7c/7169323f.jpg","comment_is_top":false,"comment_ctime":1580096364,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1580096364","product_id":100020801,"comment_content":"每次都好认真地看评论，老师总能很负责地回答问题。好多时候评论更精彩，能学到更多细节的知识，还能加深了对文章知识点原理的理解。","like_count":0},{"had_liked":false,"id":172362,"user_name":"刘群龙龙","can_delete":false,"product_type":"c1","uid":1322832,"ip_address":"","ucode":"2084A841E9208F","user_header":"https://static001.geekbang.org/account/avatar/00/14/2f/50/fdb594d9.jpg","comment_is_top":false,"comment_ctime":1579161207,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1579161207","product_id":100020801,"comment_content":"我用相同的操作操作自己的数据库 我的数据库版本是mysql5.7.28   图二复现依旧用到了 a索引 这个是？","like_count":0},{"had_liked":false,"id":171999,"user_name":"Ethan","can_delete":false,"product_type":"c1","uid":1276373,"ip_address":"","ucode":"016F1DEBA895B8","user_header":"https://static001.geekbang.org/account/avatar/00/13/79/d5/4a7971fc.jpg","comment_is_top":false,"comment_ctime":1579067580,"is_pvip":true,"discussion_count":0,"race_medal":1,"score":"1579067580","product_id":100020801,"comment_content":"步骤：<br>explain select * from t force index(a) where a between 1 and 100000;<br><br>结果：<br>rows=50128<br><br>问题：<br>这里想要查询的是全表的数据，为什么使用索引 a ，优化器显示的需要的扫描结果是：50128，这里我的理解应该是全表的数据行数才对啊。<br>接着发现当 between 1 到 50000 及之上的 rows 的值基本都是一样的。<br><br><br><br>","like_count":0},{"had_liked":false,"id":167416,"user_name":"lyt","can_delete":false,"product_type":"c1","uid":1526706,"ip_address":"","ucode":"8C179F339C2A27","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/OwolYO3ppfrxTcX81cswxNkD4tIlHM7vrnfroMzoTx878mDCnfJ3esicvbhm7ricUAbR7T9DjEDstVklh9z6uzjQ/132","comment_is_top":false,"comment_ctime":1577788117,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1577788117","product_id":100020801,"comment_content":"和老师说的执行步骤一样，开始级别也是可重复读，但试了几遍，都没有出现选错索引的结果","like_count":0},{"had_liked":false,"id":160306,"user_name":"长期规划","can_delete":false,"product_type":"c1","uid":1019332,"ip_address":"","ucode":"5EF65E9115834B","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8d/c4/6f97daea.jpg","comment_is_top":false,"comment_ctime":1575916424,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1575916424","product_id":100020801,"comment_content":"老师，有没有指标可以监测到索引该更新了？这节课懂了，但问题是，我无法决定何时更新索引","like_count":0},{"had_liked":false,"id":156536,"user_name":"枫","can_delete":false,"product_type":"c1","uid":1310357,"ip_address":"","ucode":"819CA7B97DD7E2","user_header":"https://static001.geekbang.org/account/avatar/00/13/fe/95/39856e4e.jpg","comment_is_top":false,"comment_ctime":1574907025,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1574907025","product_id":100020801,"comment_content":"额，我以前以为用between and是函数不走索引呢。。。","like_count":0},{"had_liked":false,"id":154007,"user_name":"Return12321","can_delete":false,"product_type":"c1","uid":1134694,"ip_address":"","ucode":"F7A3C5ED02E1D9","user_header":"https://static001.geekbang.org/account/avatar/00/11/50/66/047ee060.jpg","comment_is_top":false,"comment_ctime":1574346092,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1574346092","product_id":100020801,"comment_content":"在MySQL8.0.18上从上到下按照时间顺序执行了图1中的语句，就是没出现图1中的结果，是否被优化掉了？？？","like_count":0},{"had_liked":false,"id":152280,"user_name":"长期规划","can_delete":false,"product_type":"c1","uid":1019332,"ip_address":"","ucode":"5EF65E9115834B","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8d/c4/6f97daea.jpg","comment_is_top":false,"comment_ctime":1573958761,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1573958761","product_id":100020801,"comment_content":"文末问题：我理解是回滚段的原因吧？数据并没有删除？","like_count":0},{"had_liked":false,"id":151393,"user_name":"Geek_3004e0","can_delete":false,"product_type":"c1","uid":1732823,"ip_address":"","ucode":"441D39BDC39E4A","user_header":"https://static001.geekbang.org/account/avatar/00/1a/70/d7/d1049bae.jpg","comment_is_top":false,"comment_ctime":1573713034,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1573713034","product_id":100020801,"comment_content":"使用的8.0.16版本的mysql，开启了innodb_stats_include_delete_marked，索引统计错误没有复现。觉得这个配置就是解决标记为delete的行被统计的问题的。不知道理解的对不对？","like_count":0},{"had_liked":false,"id":150912,"user_name":"萝卜条","can_delete":false,"product_type":"c1","uid":1692713,"ip_address":"","ucode":"4BC975BBFE50A7","user_header":"https://static001.geekbang.org/account/avatar/00/19/d4/29/5f52a82c.jpg","comment_is_top":false,"comment_ctime":1573626052,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1573626052","product_id":100020801,"comment_content":"你好，请教一个问题：为什么order by b limit 1和order by b limit 100中，优化器会分别使用索引b和索引a呢？既然索引b已经是有序的了，1和100为什么100代价大呢？","like_count":0},{"had_liked":false,"id":150586,"user_name":"learn more","can_delete":false,"product_type":"c1","uid":1128702,"ip_address":"","ucode":"0EF628B2E0F95E","user_header":"https://static001.geekbang.org/account/avatar/00/11/38/fe/00ddeb81.jpg","comment_is_top":false,"comment_ctime":1573563192,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1573563192","product_id":100020801,"comment_content":"使用作者的插入语句，半个小时了还没执行完成，后面改成了 insert into values(),() ， 100000 条记录只要 5.44秒。<br>JavaScript <br>var str = &quot;insert into t(id,a,b) values&quot;;<br>for(var i = 0 ;i &lt; 100000; i++){<br><br>\tstr += &quot;(&quot;;<br>\tstr += i+&quot;,&quot;+i+&quot;,&quot;+i;<br>\tstr += &quot;)&quot;;<br>\tif(i &lt; 99999){<br>\t\tstr += &quot;,&quot;;<br>\t}<br>}<br>console.info(str); <br>","like_count":0},{"had_liked":false,"id":148248,"user_name":"明天有你","can_delete":false,"product_type":"c1","uid":1183001,"ip_address":"","ucode":"C673E13D0E6540","user_header":"https://static001.geekbang.org/account/avatar/00/12/0d/19/8cf1a9d2.jpg","comment_is_top":false,"comment_ctime":1572963529,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1572963529","product_id":100020801,"comment_content":"我在win10上面安装了vmware来安装了一个centos7，在这个centos7里面安装了 5.6.44-log MySQL Community Server (GPL)，然后我在win10上打开两个cmd窗口A、B。两个窗口都连接到了centos7里面的mysql。A 执行了  set autocommit=0; start TRANSACTION WITH CONSISTENT SNAPSHOT; 语句，B 执行了 DELETE from t;CALL idata();set long_query_time=0; select * from t where a between 10000 and 20000; select * from t force index(a) where a between 10000 and 20000; 语句，两条select 语句的查询时间只相差了0.0001，也就是说，重现不了本课程的内容。我的问题出现在哪里呢，望各位指导一下。","like_count":0},{"had_liked":false,"id":148084,"user_name":"小灰灰zyh","can_delete":false,"product_type":"c1","uid":1323362,"ip_address":"","ucode":"47C5B1C7002FCD","user_header":"https://static001.geekbang.org/account/avatar/00/14/31/62/103e276b.jpg","comment_is_top":false,"comment_ctime":1572939597,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1572939597","product_id":100020801,"comment_content":"老师，请教个问题，如果where条件where a=? and b=? and c=? and d=?。如果c和d字段建立了联合索引，那么最终这条sql执行的时候会走联合索引吗？为什么？","like_count":0,"discussions":[{"author":{"id":1005391,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","nickname":"一步","note":"","ucode":"73CEA468CE70C3","race_medal":1,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":49245,"discussion_content":"在 c 的查询条件了会走联合索引的，where 后面的条件顺序是没有关系，优化器会选择最优的顺序","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573566681,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":145015,"user_name":"xinglichea","can_delete":false,"product_type":"c1","uid":1176447,"ip_address":"","ucode":"986DA07BF3CA89","user_header":"https://static001.geekbang.org/account/avatar/00/11/f3/7f/2dd9409b.jpg","comment_is_top":false,"comment_ctime":1572160732,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1572160732","product_id":100020801,"comment_content":"到这里 merge 过程就结束了。这时候，数据页和内存中 change buffer 对应的磁盘位置都还没有修改，属于脏页，之后各自刷回自己的物理数据，就是另外一个过程了。<br>———————————————————<br>老师，请问下，内存中的数据页和change buffer刷盘，除了checkpoint机制触发，还有其它的触发机制吗？您在，第二节的留言有提到过第10讲会讲，但全篇没有讲的，希望老师指点下，非常感谢","like_count":0},{"had_liked":false,"id":134407,"user_name":"家乐","can_delete":false,"product_type":"c1","uid":1301941,"ip_address":"","ucode":"94F8720B59F221","user_header":"https://wx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEJia90ErsTQtNDNeyTWNwWjicERicXj72b4xgbvru2IkUdrLxrgJb5lCrTaiaW2iaX3mOYiaV8vYo3voWlg/132","comment_is_top":false,"comment_ctime":1568820132,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1568820132","product_id":100020801,"comment_content":"真的很欣赏奇哥的文章和每个评论的回答。专业，通俗易懂，而且很谦逊。","like_count":0},{"had_liked":false,"id":132634,"user_name":"helloworld","can_delete":false,"product_type":"c1","uid":1015754,"ip_address":"","ucode":"00DF2FEC58D2E6","user_header":"https://static001.geekbang.org/account/avatar/00/0f/7f/ca/ea85bfdd.jpg","comment_is_top":false,"comment_ctime":1568181209,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1568181209","product_id":100020801,"comment_content":"为什么limit 100后就可以让优化器认识到使用b索引代价会很高？？？","like_count":0},{"had_liked":false,"id":129708,"user_name":"张三丰","can_delete":false,"product_type":"c1","uid":1155275,"ip_address":"","ucode":"3A6215A40B3B21","user_header":"https://static001.geekbang.org/account/avatar/00/11/a0/cb/aab3b3e7.jpg","comment_is_top":false,"comment_ctime":1567224911,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1567224911","product_id":100020801,"comment_content":"采样统计的时候，InnoDB 默认会选择 N 个数据页，统计这些页面上的不同值，得到一个平均值，然后乘以这个索引的页面数，就得到了这个索引的基数。<br><br>没明白   怎么统计的，能详细展开一下么","like_count":0},{"had_liked":false,"id":129428,"user_name":"Dthan","can_delete":false,"product_type":"c1","uid":1177838,"ip_address":"","ucode":"B5DEB7D050981D","user_header":"https://static001.geekbang.org/account/avatar/00/11/f8/ee/2cf560f5.jpg","comment_is_top":false,"comment_ctime":1567128265,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1567128265","product_id":100020801,"comment_content":"老师，N是数据页树，M是总行数还是页的行数","like_count":0},{"had_liked":false,"id":125180,"user_name":"张三丰","can_delete":false,"product_type":"c1","uid":1155275,"ip_address":"","ucode":"3A6215A40B3B21","user_header":"https://static001.geekbang.org/account/avatar/00/11/a0/cb/aab3b3e7.jpg","comment_is_top":false,"comment_ctime":1566112673,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1566112673","product_id":100020801,"comment_content":"”而如果选择扫描 10 万行，是直接在主键索引上扫描的，没有额外的代价。”<br><br>这句话不理解，这和全表扫描有什么区别？一共就10000行记录。主键索引并没有发挥出”索引”所具备的能力。","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":153240,"discussion_content":"主键索引表扫描就是指全表扫描。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580039901,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":125003,"user_name":"Mr.钧👻","can_delete":false,"product_type":"c1","uid":1249939,"ip_address":"","ucode":"D781E030E79245","user_header":"https://static001.geekbang.org/account/avatar/00/13/12/93/3470fc43.jpg","comment_is_top":false,"comment_ctime":1566039785,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1566039785","product_id":100020801,"comment_content":"老师，为什么会得到错的扫描行数呢？是还有其他采样统计吗？ 根据文章，扫描行数受到索引统计，排序，临时表的影响。还受到其他因素的影响吗？","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":153243,"discussion_content":"基数、扫描行数。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580039926,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":116600,"user_name":"竹荀","can_delete":false,"product_type":"c1","uid":1604511,"ip_address":"","ucode":"3380C18DCAD203","user_header":"https://static001.geekbang.org/account/avatar/00/18/7b/9f/7825b97c.jpg","comment_is_top":false,"comment_ctime":1563877586,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1563877586","product_id":100020801,"comment_content":"十万行数据太大了，我insert半个多钟头还是没有好，这是怎么一回事呢？我的电脑是i7,8G内存，各位insert的效果如何呢？","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":153245,"discussion_content":"将innodb_flush_log_at_trx_commit设置为0就好了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580039965,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":116442,"user_name":"Hacker","can_delete":false,"product_type":"c1","uid":1142767,"ip_address":"","ucode":"FB33501701B9FE","user_header":"","comment_is_top":false,"comment_ctime":1563850907,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1563850907","product_id":100020801,"comment_content":"为了可以让 MySQL 选错索引，在不同的机器上，测试了老师的方法，均无效。费尽千辛万古，不如好好阅读。终于被老师的一句 order by rand()，点醒。如果朋友您也不能重现选错索引，不妨仅实施随即删除，亲测有效。一条误入歧途的语句，让MySQL选错索引，：delete from t order by rand() limit 12000;  # 12000 为了重新索引统计。","like_count":0},{"had_liked":false,"id":113978,"user_name":"TioSun","can_delete":false,"product_type":"c1","uid":1590457,"ip_address":"","ucode":"4A039179296310","user_header":"","comment_is_top":false,"comment_ctime":1563197462,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1563197462","product_id":100020801,"comment_content":"问个很白痴的问题建立(b,a)或者(a,b)这样的组合索引不会优化吗","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":153247,"discussion_content":"（b,a)和(a,b)是两个不同的索引。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580040013,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":112012,"user_name":"时间是最真的答案","can_delete":false,"product_type":"c1","uid":1183601,"ip_address":"","ucode":"B90F3EF769F865","user_header":"https://static001.geekbang.org/account/avatar/00/12/0f/71/9273e8a4.jpg","comment_is_top":false,"comment_ctime":1562653693,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1562653693","product_id":100020801,"comment_content":"怎么模拟 session A 和 session B 呢？","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":153248,"discussion_content":"打开两个查询编辑窗口或者命令窗口。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580040039,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":110341,"user_name":"残天噬魂","can_delete":false,"product_type":"c1","uid":1506609,"ip_address":"","ucode":"A2AD8303A4518D","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/q2HwchogzNiavKhIB4GfAxH6B88NhSoC7B7keVEUqiaP6JPokDUNJLYehocOyqYqrhA3iaxywyRXLYkYJjDUQESZw/132","comment_is_top":false,"comment_ctime":1562235493,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1562235493","product_id":100020801,"comment_content":"开启事务之后按照老师的操作，没有复现出选错索引的问题<br>session a : start transaction with CONSISTENT SNAPSHOT;<br>session b:  DELETE from t;<br>session b:  call idata();<br>session b:  EXPLAIN select * from t WHERE a BETWEEN 10000 and 20000;<br>得到的结果还是<br>id\tselect_type\ttable\tpartitions\ttype\tpossible_keys\tkey\tkey_len\tref\trows\tfiltered\tExtra<br>1\tSIMPLE\tt\t\trange\ta\ta\t5\t\t10001\t100.00\tUsing index condition<br><br>我用的是mysql8.0，会是版本引发的问题么？？","like_count":0},{"had_liked":false,"id":109096,"user_name":"多襄丸","can_delete":false,"product_type":"c1","uid":1074310,"ip_address":"","ucode":"1AA1497C5A293C","user_header":"https://static001.geekbang.org/account/avatar/00/10/64/86/f5a9403a.jpg","comment_is_top":false,"comment_ctime":1561961288,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1561961288","product_id":100020801,"comment_content":"1. 我的扫描行数确实是在变，我在想是不是因为存储过程没有执行完？<br><br>2. 我的最终在数据记录是10W条的情况下，<br>select count(*) from t2;<br>\tcount(*)<br>\t100000<br><br> 执行 explain select * from t2 where a between 10000 and 20000; 结果如下：<br>\tid\tselect_type\ttable\tpartitions\ttype\tpossible_keys\tkey\tkey_len\tref\trows\tfiltered\tExtra<br>\t1\tSIMPLE\tt2\t\tALL\ta\t\t\t\t100263\t9.97\tUsing where<br><br>扫描除了100263行记录，好奇怪啊？ 版本是8.0.16；<br><br><br>","like_count":0},{"had_liked":false,"id":104615,"user_name":"大宝","can_delete":false,"product_type":"c1","uid":1102771,"ip_address":"","ucode":"224458E5D1A35A","user_header":"https://static001.geekbang.org/account/avatar/00/10/d3/b3/4f5550c0.jpg","comment_is_top":false,"comment_ctime":1560785320,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1560785320","product_id":100020801,"comment_content":"图 2中的sessionA有什么作用吗","like_count":0},{"had_liked":false,"id":100235,"user_name":"Tunayoyo","can_delete":false,"product_type":"c1","uid":1447213,"ip_address":"","ucode":"E77AFDE575CE04","user_header":"https://static001.geekbang.org/account/avatar/00/16/15/2d/8447e8c8.jpg","comment_is_top":false,"comment_ctime":1559490525,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1559490525","product_id":100020801,"comment_content":"说下我对图三和图五的理解：图三session A开启事务后，session B没有“真正”delete掉数据，进而影响了force index扫描行的估计，所以有图五估计的结果37116；而图三中慢查询日志记录force index扫描行是实际运行得到的真实数据10001。","like_count":0},{"had_liked":false,"id":98320,"user_name":"Longerian","can_delete":false,"product_type":"c1","uid":1032464,"ip_address":"","ucode":"0B74EE70D09A2A","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c1/10/28d5a686.jpg","comment_is_top":false,"comment_ctime":1558958266,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1558958266","product_id":100020801,"comment_content":"怎样模拟图2里 Session A 和 Session B的流程，我开了两个bash访问mysql，第一个当作session A，第二个当作 session B，按时间顺序执行图2里的语句，并不能复现","like_count":0},{"had_liked":false,"id":98317,"user_name":"张三丰","can_delete":false,"product_type":"c1","uid":1155275,"ip_address":"","ucode":"3A6215A40B3B21","user_header":"https://static001.geekbang.org/account/avatar/00/11/a0/cb/aab3b3e7.jpg","comment_is_top":false,"comment_ctime":1558956197,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1558956197","product_id":100020801,"comment_content":"“”而如果选择扫描 10 万行，是直接在主键索引上扫描的，没有额外的代价。”<br><br>这句话想不明白？为何直接在主键索引扫描？a并不是主键索引啊","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":153254,"discussion_content":"主键索引表扫描就是全表扫描。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580040374,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":93819,"user_name":"笨的","can_delete":false,"product_type":"c1","uid":1304330,"ip_address":"","ucode":"9CD069C815A40F","user_header":"https://static001.geekbang.org/account/avatar/00/13/e7/0a/a7c5c647.jpg","comment_is_top":false,"comment_ctime":1557629495,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1557629495","product_id":100020801,"comment_content":"林老师，有个问题请教一下。<br>就是时间字段datetime或者Int型的。如果用Like的方式。即使字段有索引，也是会全表扫描，请问这是类型转换的原因么？","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":153258,"discussion_content":"没这么玩过，整型可以用like?","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580040574,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":89513,"user_name":"风在身后","can_delete":false,"product_type":"c1","uid":1486579,"ip_address":"","ucode":"AA28C7C4FB6393","user_header":"https://static001.geekbang.org/account/avatar/00/16/ae/f3/f9b8b077.jpg","comment_is_top":false,"comment_ctime":1556191679,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1556191679","product_id":100020801,"comment_content":"Oracle可以使用星型转换来同时利用多个位图索引。mysql的能有一次使用多个二级索引的场景么","like_count":0},{"had_liked":false,"id":85646,"user_name":"纸片人","can_delete":false,"product_type":"c1","uid":1358508,"ip_address":"","ucode":"84490E7CEF59A4","user_header":"https://static001.geekbang.org/account/avatar/00/14/ba/ac/b44b256a.jpg","comment_is_top":false,"comment_ctime":1555157167,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1555157167","product_id":100020801,"comment_content":"唔，本章第一个示例，因为会话A上的读事务，undo确实没有回收。但是undo没有回收和索引统计结果有误是否有关，就说不准了。我是通过反证法来进行判断的。<br>假设索引统计结果有误和undo有关，那么第一个示例不加auto_increment的情况下，第二次调用idata()所引发的重新统计，会将同一行上undo上的数据行记录在内。由于所有行删除前和删除后的数据完全相同，所以基数一定会下降到原来的1&#47;2左右。<br>实际情况是，不添加自增关键值时，删除再插入前后基数差距并不大。而添加了自增关键值，基数变化就不可琢磨了。我其中一次实验，在B操作之后基数值变成1，142，142。我想这应该和索引统计选择的数据页有关，也和我反复实验有关。因为我在同一对会话上反复操作了n次，id积累到了800,000。<br>总而言之，基于上述操作结果，我们可以得出结论，索引统计有误，和undo没有直接关系，反而可能和数据表格中“已删除”的行有关。显然，删除标记并没有阻拦MySQL计算索引区分度的脚步。","like_count":0},{"had_liked":false,"id":85643,"user_name":"纸片人","can_delete":false,"product_type":"c1","uid":1358508,"ip_address":"","ucode":"84490E7CEF59A4","user_header":"https://static001.geekbang.org/account/avatar/00/14/ba/ac/b44b256a.jpg","comment_is_top":false,"comment_ctime":1555155863,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1555155863","product_id":100020801,"comment_content":"还是有点不同的。如果Id加上auto_increment，会话B第二次调用idata()的时候，插入的是不同行，因为id值不一样。只有这种情况下，课程结果才能复现。如果没有auto_increment，不会出现上述结果。此时，第二次插入直接“覆盖”了之前的行。<br><br>重新看了一遍后，我脑海里出现了两个问题，希望您解答🤔：<br>1、删除行的时候，删除标记是直接打在数据页上的吧。那undo上会如何记录这个操作呢？直接复制一行吗？在同一行上，重新插入数据，undo又会怎么记录呢？<br>2、文章末尾，那个limit 100，我想到了一种可能性。如果MySQL假设查询条件B筛选出来的行，同时符合条件A的平均概率是1%的话，那么limit 1使用索引B最有可能的真实扫描行数为500，limit 100是50000。<br>当然了，感觉事情不可能那么简单。因为命中率看起来也可以用在条件A上，同理推断limit 1只用扫描两行，limit 100仅需200行。但是因为order by b，无法保证先根据A扫描出来的结果是否正确。优化的前提是结果正确！为了保证结果的正确性，所以选择索引A，一定会扫描1000行。<br>如此，limit 1和limit 100时MySQL的不同抉择貌似说的通了😁我的问题是，MySQL衡量索引代价的权重函数里，是否包含类似平均命中率之类的数值？或者它使用了更复杂的机制，来“学习”数据跨列的分布规律。","like_count":0},{"had_liked":false,"id":84646,"user_name":"画船听雨眠","can_delete":false,"product_type":"c1","uid":1204530,"ip_address":"","ucode":"7BF99B0B26F3B2","user_header":"https://static001.geekbang.org/account/avatar/00/12/61/32/61112578.jpg","comment_is_top":false,"comment_ctime":1554889300,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1554889300","product_id":100020801,"comment_content":"mysql&gt; select version();<br>+-----------+<br>| version() |<br>+-----------+<br>| 5.7.12    |<br>+-----------+<br>我尝试了几次也没有复现案例1的情况啊！","like_count":0},{"had_liked":false,"id":83840,"user_name":"纸片人","can_delete":false,"product_type":"c1","uid":1358508,"ip_address":"","ucode":"84490E7CEF59A4","user_header":"https://static001.geekbang.org/account/avatar/00/14/ba/ac/b44b256a.jpg","comment_is_top":false,"comment_ctime":1554723127,"is_pvip":false,"replies":[{"id":"30756","content":"我感觉我们说的是一样的意思<br><br>删除的数据为什么会被算进去，是因为还没有被真正删除；<br>undo log也还没有回收。<br><br>","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1555148543,"ip_address":"","comment_id":83840,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1554723127","product_id":100020801,"comment_content":"林老师，我就本章的第一示例，做了四组实验，发现您的说法存在问题。以下是我的实验过程，请指正！<br>第一组实验，mysql版本5.7.18，严格按照本章叙述步骤进行。复现失败，explain结果显示，mysql选择了索引a。<br>第二组实验，mysql版本5.6.24，同样的步骤，复现失败。同时我注意到，在第二次调用call idata()前，在会话A（即读事务所在会话）中explain目标select语句，返回的索引类型和长度都为NULL，预测扫描长度为1。此时，由于当前隔离级别为RR，读事务看到的数据都被会话B删除了，所以其视图来自undo日志。如果explain统计扫描行数会将undo log里的数据行统计在内的话，explain的rows不可能等于1。所以“因为undo log里的数据不能实际删除，导致explain... force index(a)...的扫描行数出现误差”的说法是错误的！！！<br>第三组实验，尝试将idb放入系统表空间。我想看看如果数据行和undo log放在一起，是否会改变现状。实验结果表明，mysql还是选择了索引a。<br>第四组实验，将id改成自增主键（灵感来自第11章您给@某、人的回复），成功复现示例结果！！explain... force index(a)...的rows为37136，和文章里的数值相差无几。<br><br>结论：<br>1、mysql的优化器评估select查询代价，读取的是表格和索引的元数据，所以explain结果不会因为事务不同被隔离。<br>2、explain不会将undo log上的数据计算在内，即undo上的数据不会影响explain的估算结果。<br>3、基数不是导致rows出现误差的根本原因——我其中有一组实验所有步骤完成后，三个索引的基数都为100141。<br>4、explain会把已经打上“删除”标记的行也考虑进去，这可能是rows出现误差的真正原因。","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":446160,"discussion_content":"我感觉我们说的是一样的意思\n\n删除的数据为什么会被算进去，是因为还没有被真正删除；\nundo log也还没有回收。\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1555148543,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":79532,"user_name":"不似旧日","can_delete":false,"product_type":"c1","uid":1161271,"ip_address":"","ucode":"DF4C5E3AB9570C","user_header":"https://static001.geekbang.org/account/avatar/00/11/b8/37/98991aeb.jpg","comment_is_top":false,"comment_ctime":1553505641,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1553505641","product_id":100020801,"comment_content":"索引失效: 优化器选择错的索引(或者不使用索引)<br>发现索引失效: 使用expain查看sql执行计划<br>解决索引失效: 使用force index语句指定索引, 写合适的sql语句","like_count":0},{"had_liked":false,"id":77960,"user_name":"见月明","can_delete":false,"product_type":"c1","uid":1314680,"ip_address":"","ucode":"89D13DFE959344","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIq0R7vjEVNqQhQ7JALNWAnSqoSYuia6aAibGFfnbdVHXQlpWIQyvF4uPSCQu51BSCEw06bPTJs6cgg/132","comment_is_top":false,"comment_ctime":1553046769,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1553046769","product_id":100020801,"comment_content":"最后一个例子，mysql认为B索引更好。这种情况是统计信息全的情况下mysql的优化器出现了问题？我以为优化器在统计信息没问题的状态下基本上不会走错呢。。。估计以后mysql会更精进这方面","like_count":0},{"had_liked":false,"id":74057,"user_name":"路过","can_delete":false,"product_type":"c1","uid":1316401,"ip_address":"","ucode":"7152C19ED024CC","user_header":"https://static001.geekbang.org/account/avatar/00/14/16/31/ae8adf82.jpg","comment_is_top":false,"comment_ctime":1552095589,"is_pvip":false,"replies":[{"id":"27084","content":"啊 不会吧，没碰到过这种情况。。<br>要不你把完整的复现步骤写一下？","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1552111052,"ip_address":"","comment_id":74057,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1552095589","product_id":100020801,"comment_content":"老师好。<br>5.7.17上，设置long_query_time=0.执行简单的命令后，该语句不会出现在slow log中，表中只有20条记录。比如：<br>select * from words；<br>但执行稍微复杂点的语句就记录到slow log中：<br>select word from words order by rand() limit 3;<br>请问这是为何？谢谢！","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":442414,"discussion_content":"啊 不会吧，没碰到过这种情况。。\n要不你把完整的复现步骤写一下？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1552111052,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":70581,"user_name":"XD","can_delete":false,"product_type":"c1","uid":1079293,"ip_address":"","ucode":"DC9DCFB3841A4E","user_header":"https://static001.geekbang.org/account/avatar/00/10/77/fd/c6619535.jpg","comment_is_top":false,"comment_ctime":1551143543,"is_pvip":false,"replies":[{"id":"25186","content":"对，但是这里的“都”，改成“依次”比较不容易引起误解哈","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1551145191,"ip_address":"","comment_id":70581,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1551143543","product_id":100020801,"comment_content":"老师，在where a between 1 and 10000 and b between 50000 and 100000的情况下，如果走的是索引b，那么存储层是把满足条件的5w行数据都返回给执行器然后执行器再进行过滤吗？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440709,"discussion_content":"对，但是这里的“都”，改成“依次”比较不容易引起误解哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551145191,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":65163,"user_name":"devil","can_delete":false,"product_type":"c1","uid":1259625,"ip_address":"","ucode":"BB6090411BAA23","user_header":"https://static001.geekbang.org/account/avatar/00/13/38/69/864569a4.jpg","comment_is_top":false,"comment_ctime":1549081788,"is_pvip":false,"replies":[{"id":"23094","content":"这个就是优化器算代价的时候的计算细节了<br><br>只是给大家提供一个思路哈","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1549101864,"ip_address":"","comment_id":65163,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1549081788","product_id":100020801,"comment_content":"为什么把limit 1换成limit 100会让优化器觉得使用索引b代价变高呢？都是要排序b，取前一百还是前一个代价差不多吧，如果用索引a还是要排序b代价还是更大。","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438343,"discussion_content":"这个就是优化器算代价的时候的计算细节了\n\n只是给大家提供一个思路哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1549101864,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":64899,"user_name":"L!en6o","can_delete":false,"product_type":"c1","uid":1054472,"ip_address":"","ucode":"E0931CB8998260","user_header":"https://static001.geekbang.org/account/avatar/00/10/17/08/566fb246.jpg","comment_is_top":false,"comment_ctime":1548945456,"is_pvip":false,"replies":[{"id":"23004","content":"😅，👍","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1548980441,"ip_address":"","comment_id":64899,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1548945456","product_id":100020801,"comment_content":"前不久就碰到过，删除索引解决的。自己挖的坑 跪的也要踩完","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438226,"discussion_content":"😅，👍","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548980441,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":61834,"user_name":"亮","can_delete":false,"product_type":"c1","uid":1086346,"ip_address":"","ucode":"5B8E59AEA6E3F2","user_header":"https://static001.geekbang.org/account/avatar/00/10/93/8a/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1547813306,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1547813306","product_id":100020801,"comment_content":"老师，analyze table 锁表吗","like_count":0},{"had_liked":false,"id":60009,"user_name":"w","can_delete":false,"product_type":"c1","uid":1318306,"ip_address":"","ucode":"DB837CAE2FB7C7","user_header":"https://static001.geekbang.org/account/avatar/00/14/1d/a2/ef8758c9.jpg","comment_is_top":false,"comment_ctime":1547436710,"is_pvip":false,"replies":[{"id":"21511","content":"就是用回滚日志“算出来”的<br>你看下15篇哈","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547446892,"ip_address":"","comment_id":60009,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1547436710","product_id":100020801,"comment_content":"CREATE TABLE `user` (<br>  `id` int(11) NOT NULL,<br>  `card` int(11) DEFAULT NULL,<br>  PRIMARY KEY (`id`),<br>  UNIQUE KEY `card` (`card`)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8;<br>insert into `user`(id, card) values(1, 3);<br><br>下面的sql按时间顺序执行<br>session a: start transaction with consistent snapshot;<br>session a: select * from user where card = 3; result: (1, 3)<br>session b: update user set card = 2  where card = 3; commit;<br>session a: select * from user where card = 3; result: (1, 3)<br>session b: select * from user where card = 3; result: empty;<br><br>老师您之前说 数据页上没有历史版本。<br>很好奇 在session b更新了card=2之后，通过索引card，如何检索到card=3这条记录的。<br>求解惑","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":436435,"discussion_content":"就是用回滚日志“算出来”的\n你看下15篇哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547446892,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":59640,"user_name":"w","can_delete":false,"product_type":"c1","uid":1318306,"ip_address":"","ucode":"DB837CAE2FB7C7","user_header":"https://static001.geekbang.org/account/avatar/00/14/1d/a2/ef8758c9.jpg","comment_is_top":false,"comment_ctime":1547395094,"is_pvip":false,"replies":[{"id":"21482","content":"1. 因为存在重复数据。导致预估的扫描行数变多了。 是的 ，不过准确说不是“重复数据”，而是说这个范围的是数据页变多了<br>2. 数据页上没有历史版本的， 看一下08篇","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547432451,"ip_address":"","comment_id":59640,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1547395094","product_id":100020801,"comment_content":"老师 针对您提问的rows行数从10000变成37000多，有两个问题想确定。<br>1、您在答案中提到因为一致性视图，未删除的旧数据其实还暂时保留。<br>所以我是否可以进一步的理解为，对于索引统计信息来说，数据记录翻了一倍，但是cardinality没变。因为都是重复数据。导致预估的扫描行数变多了？文章中似乎没有提到 cardinality如何估算扫描行数，，只提了如何计算cardinality。<br><br>2、对于未删除的旧数据，不单指记录在undo log里面。索引的数据页上也不会清除该数据。因为我理解数据页上历史版本的数据如果删掉了，就没办法通过索引检索到了。","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":436372,"discussion_content":"1. 因为存在重复数据。导致预估的扫描行数变多了。 是的 ，不过准确说不是“重复数据”，而是说这个范围的是数据页变多了\n2. 数据页上没有历史版本的， 看一下08篇","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547432451,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2166073,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/k3YD3y3BzGDSdrwRJyJY4BXsNJibfM4uzOdDVKIAlFApR2FZCLg2ibrZtJ4vuahA3LHLW9GKzH5CMGqCDhWjhZqg/132","nickname":"戒酒的李白","note":"","ucode":"744E1A22761647","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":400595,"discussion_content":"感觉明白了一点了，因为数据页删除的数据只是标记删除，没有真正的清理，这些记录占用的页空间还在，这样查找数据时需要扫描更多的页，预估扫描行数就会变多","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633342591,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":57138,"user_name":"我是小队长","can_delete":false,"product_type":"c1","uid":1334198,"ip_address":"","ucode":"E0687666EE2031","user_header":"https://static001.geekbang.org/account/avatar/00/14/5b/b6/f404b490.jpg","comment_is_top":false,"comment_ctime":1546657601,"is_pvip":false,"replies":[{"id":"20635","content":"问题是啥？","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1546690575,"ip_address":"","comment_id":57138,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1546657601","product_id":100020801,"comment_content":"接上面问题，这个是打印出的慢日志，# Time: 2019-01-05T02:59:29.655832Z<br># User@Host: root[root] @ localhost [127.0.0.1]  Id:    16<br># Query_time: 0.024064  Lock_time: 0.000000 Rows_sent: 10001  Rows_examined: 10001<br>SET timestamp=1546657169;<br>select * from t where a between 10000 and 20000;<br># Time: 2019-01-05T02:59:55.757943Z<br># User@Host: root[root] @ localhost [127.0.0.1]  Id:    16<br># Query_time: 0.021558  Lock_time: 0.000000 Rows_sent: 10001  Rows_examined: 10001<br>SET timestamp=1546657195;<br>select * from t force index(a) where a between 10000 and 20000;","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435423,"discussion_content":"问题是啥？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546690575,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":53564,"user_name":"运斤成风","can_delete":false,"product_type":"c1","uid":1350812,"ip_address":"","ucode":"BAFF69C29FDFA5","user_header":"https://static001.geekbang.org/account/avatar/00/14/9c/9c/e02a0daf.jpg","comment_is_top":false,"comment_ctime":1545691435,"is_pvip":false,"replies":[{"id":"19485","content":"就是因为不能真的删除导致的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545702915,"ip_address":"","comment_id":53564,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1545691435","product_id":100020801,"comment_content":"Session a 发起了读一直性查询，而session b的做大批量的删除后，紧接着做插入操作，导致全表扫描主因是统计信息不准确。那统计信息不准的原因是什么呢？采样算法采样在一致性读的干扰下不准确？因为后期手动收集统计分析后结果就正常了，谢谢！","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434182,"discussion_content":"就是因为不能真的删除导致的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545702915,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":53144,"user_name":"浮沉随浪记今朝","can_delete":false,"product_type":"c1","uid":1302527,"ip_address":"","ucode":"09514602876EFC","user_header":"https://static001.geekbang.org/account/avatar/00/13/df/ff/55d529ec.jpg","comment_is_top":false,"comment_ctime":1545611843,"is_pvip":false,"replies":[{"id":"19266","content":"额，hbase不熟，而且你这么问我估计hbase的专家也不知道怎么回答哈","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545616250,"ip_address":"","comment_id":53144,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1545611843","product_id":100020801,"comment_content":"请问在hbase中，他的执行逻辑和mysql类似吗","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434044,"discussion_content":"额，hbase不熟，而且你这么问我估计hbase的专家也不知道怎么回答哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545616250,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":51262,"user_name":"千德勒","can_delete":false,"product_type":"c1","uid":1020912,"ip_address":"","ucode":"821466DEF391C2","user_header":"https://static001.geekbang.org/account/avatar/00/0f/93/f0/e3ed3ae3.jpg","comment_is_top":false,"comment_ctime":1545143824,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1545143824","product_id":100020801,"comment_content":"刚好遇到了，测试机走正确索引，正式环境走错索引，后来删掉错的。。只知道这样解决问题了，不知道为什么，这篇算是解惑了。。","like_count":0},{"had_liked":false,"id":50236,"user_name":"Mr.Strive.Z.H.L","can_delete":false,"product_type":"c1","uid":1030198,"ip_address":"","ucode":"6D97E159E2EECD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/b8/36/542c96bf.jpg","comment_is_top":false,"comment_ctime":1544930041,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1544930041","product_id":100020801,"comment_content":"关于第一个例子的疑惑：<br>sessionA是长事务，sessionB是先删除再插入。那么如果sessionB是update语句，把10W行数据全部更新（比如a的值都增加100），这样sessionB的explain语句，也不会选择索引a，而是选择全表吗？<br><br>我的答案：sessionB删除数据再插入，根据MVCC的机制，应该是增加undo log，这样方便sessionA通过undo log查询到删除之前的数据。那么更新操作肯定也和删除操作一样，也是增加undo log。所以我认为即使sessionB使用的是更新语句，应该也有极大可能性是选择全表扫描。<br>老师你看我理解的对吗？","like_count":0,"discussions":[{"author":{"id":2166073,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/k3YD3y3BzGDSdrwRJyJY4BXsNJibfM4uzOdDVKIAlFApR2FZCLg2ibrZtJ4vuahA3LHLW9GKzH5CMGqCDhWjhZqg/132","nickname":"戒酒的李白","note":"","ucode":"744E1A22761647","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":400602,"discussion_content":"感觉不是，更新如果不涉及页分裂，没有过时的记录，不会导致cadinality有太大的误差","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633346389,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":48708,"user_name":"罗杰","can_delete":false,"product_type":"c1","uid":1316843,"ip_address":"","ucode":"7D440AFAA78678","user_header":"https://static001.geekbang.org/account/avatar/00/14/17/eb/8bfd69b0.jpg","comment_is_top":false,"comment_ctime":1544520267,"is_pvip":false,"replies":[{"id":"17487","content":"Session就是会话，对应的是一个连接。连接里面可以启动事务","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544524095,"ip_address":"","comment_id":48708,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544520267","product_id":100020801,"comment_content":"sessionA和sessionB是指事务a和事务b的意思吗","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432320,"discussion_content":"Session就是会话，对应的是一个连接。连接里面可以启动事务","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544524095,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":48073,"user_name":"WL","can_delete":false,"product_type":"c1","uid":1173771,"ip_address":"","ucode":"6277DCD776B87E","user_header":"https://static001.geekbang.org/account/avatar/00/11/e9/0b/1171ac71.jpg","comment_is_top":false,"comment_ctime":1544342333,"is_pvip":false,"replies":[{"id":"17141","content":"一般是在工作目录下呀， 搜一下，文件名包含slow_log","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544357499,"ip_address":"","comment_id":48073,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544342333","product_id":100020801,"comment_content":"再请教一下老师, 慢查询日志是在哪里看? 刚刚找了半天没找到","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432015,"discussion_content":"一般是在工作目录下呀， 搜一下，文件名包含slow_log","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544357499,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":48071,"user_name":"WL","can_delete":false,"product_type":"c1","uid":1173771,"ip_address":"","ucode":"6277DCD776B87E","user_header":"https://static001.geekbang.org/account/avatar/00/11/e9/0b/1171ac71.jpg","comment_is_top":false,"comment_ctime":1544342243,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1544342243","product_id":100020801,"comment_content":"思考题: 可能是session A启动事务后, 因为要保证A的一致读视图, session B的删除操作收到了影响并没有真正删除, 所以重新插入10条后, 在session B查询的时候收到A的视图数据的影响导致扫描了3万多行.","like_count":0},{"had_liked":false,"id":47856,"user_name":"404","can_delete":false,"product_type":"c1","uid":1313407,"ip_address":"","ucode":"2E7815DDCBA8AB","user_header":"","comment_is_top":false,"comment_ctime":1544236906,"is_pvip":false,"replies":[{"id":"17109","content":"我的是5.7.21，应该没差别的。你看下下一篇文章末尾的视频，按照顺序执行一下","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544333763,"ip_address":"","comment_id":47856,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544236906","product_id":100020801,"comment_content":"老师，这个和版本有关系吗。我的是5.7.24的。做事务这块实验的时候，结果跟你的不一样。index 和 force index 索引结果是一样的。<br>Cardinality 这个值也是相等的","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431914,"discussion_content":"我的是5.7.21，应该没差别的。你看下下一篇文章末尾的视频，按照顺序执行一下","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544333763,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":47724,"user_name":"信信","can_delete":false,"product_type":"c1","uid":1303865,"ip_address":"","ucode":"8DF0EC045579FD","user_header":"https://static001.geekbang.org/account/avatar/00/13/e5/39/951f89c8.jpg","comment_is_top":false,"comment_ctime":1544186954,"is_pvip":false,"replies":[{"id":"16997","content":"全表扫描的预期是10万哦","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544190589,"ip_address":"","comment_id":47724,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544186954","product_id":100020801,"comment_content":"请问老师，图5下说Q1 的结果还是符合预期的，rows 的值是 104620。可是预期是10001吧？比Q2差的更远呀。。。。","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431871,"discussion_content":"全表扫描的预期是10万哦","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544190589,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":47679,"user_name":"yy","can_delete":false,"product_type":"c1","uid":1307788,"ip_address":"","ucode":"4F6E10E2D1FE8C","user_header":"","comment_is_top":false,"comment_ctime":1544178514,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1544178514","product_id":100020801,"comment_content":"老师好 请问在用analyze统计大表的时候 会对表产生锁 从而影响业务吗","like_count":0},{"had_liked":false,"id":47650,"user_name":"潮汐","can_delete":false,"product_type":"c1","uid":1042208,"ip_address":"","ucode":"F5E4F6DF9CEA9E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/e7/20/70a95f94.jpg","comment_is_top":false,"comment_ctime":1544172312,"is_pvip":false,"discussion_count":0,"race_medal":4,"score":"1544172312","product_id":100020801,"comment_content":"请问老师，这个优化器的选择的问题，8.0版本有修复吗，我装的8.0.13的，按照过程走没有出现这些选错的现象","like_count":0},{"had_liked":false,"id":47423,"user_name":"潮汐","can_delete":false,"product_type":"c1","uid":1042208,"ip_address":"","ucode":"F5E4F6DF9CEA9E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/e7/20/70a95f94.jpg","comment_is_top":false,"comment_ctime":1544143529,"is_pvip":false,"replies":[{"id":"16935","content":"是的，set global 命令","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544149368,"ip_address":"","comment_id":47423,"utype":1}],"discussion_count":1,"race_medal":4,"score":"1544143529","product_id":100020801,"comment_content":"老师，之前有人评论说插入十万行要很久，今天我也像复现文中的过程，也是很慢，你回答说设置innodb_flush_log_at_trx_commit和sync_binlog为0是在哪设置，存储过程执行前吗？小白一枚，请老师指出？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431764,"discussion_content":"是的，set global 命令","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544149368,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":47287,"user_name":"潘多拉","can_delete":false,"product_type":"c1","uid":1327046,"ip_address":"","ucode":"6EBB6F281018A0","user_header":"https://static001.geekbang.org/account/avatar/00/14/3f/c6/ccc487f9.jpg","comment_is_top":false,"comment_ctime":1544101007,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1544101007","product_id":100020801,"comment_content":"老师好，我想问一下在数据库里用大字段，对数据库查阅和更新的性能影响有多大呀","like_count":0},{"had_liked":false,"id":47228,"user_name":"wjz1991","can_delete":false,"product_type":"c1","uid":1311687,"ip_address":"","ucode":"D82D744F5A4E6D","user_header":"https://static001.geekbang.org/account/avatar/00/14/03/c7/563345e1.jpg","comment_is_top":false,"comment_ctime":1544082294,"is_pvip":false,"replies":[{"id":"16845","content":"我下一篇中给个视频","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544084277,"ip_address":"","comment_id":47228,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544082294","product_id":100020801,"comment_content":"老师，我用了mysql官方版本5.7.21和percona版本的5.6.36都复现不了老师的情况，是按着老师的步骤一步步来的，而且评论里也有挺多人复现不了的，是老师的步骤有遗漏吗？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431705,"discussion_content":"我下一篇中给个视频","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544084277,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":47222,"user_name":"EAGLE","can_delete":false,"product_type":"c1","uid":1303484,"ip_address":"","ucode":"5B0FE019A8C9BD","user_header":"https://static001.geekbang.org/account/avatar/00/13/e3/bc/064401c7.jpg","comment_is_top":false,"comment_ctime":1544080744,"is_pvip":false,"replies":[{"id":"16847","content":"要看你业务需求哦","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544084384,"ip_address":"","comment_id":47222,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544080744","product_id":100020801,"comment_content":"老师请问，一个分页查询需要使用order by吗？是不是默认的排序用来也是OK的。","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431702,"discussion_content":"要看你业务需求哦","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544084384,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":47192,"user_name":"晨思暮语","can_delete":false,"product_type":"c1","uid":1304974,"ip_address":"","ucode":"F21D2FDCDD6B43","user_header":"https://static001.geekbang.org/account/avatar/00/13/e9/8e/6dc15a91.jpg","comment_is_top":false,"comment_ctime":1544073226,"is_pvip":false,"replies":[{"id":"16850","content":"不是，两个操作都写入redolog了的，只是内容不同","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544084701,"ip_address":"","comment_id":47192,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544073226","product_id":100020801,"comment_content":"丁老师好，咨询一个前面的问题！在第二节两阶段这一块，你说是redo写两次磁盘，第一次为prepare，第二次为commit！个人理解为，第一次是写日志到redo file，第二次是写commit到redo file。不知道这样理解正确吗，请帮忙答疑，谢谢！","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431695,"discussion_content":"不是，两个操作都写入redolog了的，只是内容不同","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544084701,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":47148,"user_name":"kunsect","can_delete":false,"product_type":"c1","uid":1299322,"ip_address":"","ucode":"2CC4ADF82887FC","user_header":"https://static001.geekbang.org/account/avatar/00/13/d3/7a/dd7d35b5.jpg","comment_is_top":false,"comment_ctime":1544063929,"is_pvip":false,"replies":[{"id":"16852","content":"今晚发的下一篇里面我有贴个视频，你到时看下","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544089814,"ip_address":"","comment_id":47148,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544063929","product_id":100020801,"comment_content":"老师早<br>今天将 session A 的 commit 放在 explain 后面，还是没有复现。<br><br>mysql&gt; explain select * from t where a between 10000 and 20000;<br>+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+<br>| id | select_type | table | partitions | type  | possible_keys | key  | key_len | ref  | rows  | filtered | Extra                 |<br>+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+<br>|  1 | SIMPLE      | t     | NULL       | range | a             | a    | 5       | NULL | 10001 |   100.00 | Using index condition |<br>+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+<br>1 row in set, 1 warning (0.00 sec)<br>","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431679,"discussion_content":"今晚发的下一篇里面我有贴个视频，你到时看下","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544089814,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":47132,"user_name":"Wrelon","can_delete":false,"product_type":"c1","uid":1306021,"ip_address":"","ucode":"8670BDBF317A36","user_header":"https://static001.geekbang.org/account/avatar/00/13/ed/a5/ca3b4cc4.jpg","comment_is_top":false,"comment_ctime":1544061408,"is_pvip":false,"replies":[{"id":"16837","content":"第二句left去掉看看","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544071577,"ip_address":"","comment_id":47132,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544061408","product_id":100020801,"comment_content":"老师，上一个问题解决了，但是没明白其中的道理，还请老师讲解。<br>SELECT <br>a.`materialCode`<br>,b.`MaterialCode`<br>FROM sit_r_iwm_data.gr_materialpreferedstoragebin\ta<br>,pdata.`tb_material`\t\t\t\tb<br>WHERE a.`materialCode`=b.`MaterialCode`<br>AND a.`legalPersonCode`=b.`LegalPersonCode`<br>跟<br>SELECT<br>a.`materialCode`<br>,b.`MaterialCode`<br>FROM sit_r_iwm_data.gr_materialpreferedstoragebin\ta<br>LEFT JOIN pdata.`tb_material`\t\t\t\tb<br>ON  a.`legalPersonCode`=b.`LegalPersonCode`<br>AND a.`materialCode`=b.`MaterialCode`<br>这两个SQL对于索引的选择，执行的效率差别很大，这是为什么呢？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431674,"discussion_content":"第二句left去掉看看","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544071577,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":47130,"user_name":"25ma","can_delete":false,"product_type":"c1","uid":1303713,"ip_address":"","ucode":"AB5435B9DB52C9","user_header":"https://static001.geekbang.org/account/avatar/00/13/e4/a1/178387da.jpg","comment_is_top":false,"comment_ctime":1544060902,"is_pvip":false,"replies":[{"id":"16858","content":"表是Innodb 的吧？还有数据库隔离级别是RR吗","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544094692,"ip_address":"","comment_id":47130,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544060902","product_id":100020801,"comment_content":"老师好，我这边执行也是都用到了a 索引，是不是我执行顺序的问题？<br>我的执行顺序是： <br>1. 创建表<br>2. 用存储过程写入数据（100000）<br>3. 在session A（客户端） 调用 START TRANSACTION WITH CONSISTENT SNAPSHOT; 命令<br>4. session B (使用命令行登录mysql）  执行 delete from t;  <br>5. session B 再次调用存储过程函数 call idata();<br>6. session B 执行 EXPLAIN SELECT * FROM t WHERE a BETWEEN 10000 AND 20000;<br>得到的结果依然是 <br>mysql&gt; EXPLAIN SELECT * FROM t WHERE a BETWEEN 10000 AND 20000;<br>+----+-------------+-------+-------+---------------+------+---------+------+-------+-----------------------+<br>| id | select_type | table | type  | possible_keys | key  | key_len | ref  | rows  | Extra                 |<br>+----+-------------+-------+-------+---------------+------+---------+------+-------+-----------------------+<br>|  1 | SIMPLE      | t     | range | a             | a    | 5       | NULL | 10000 | Using index condition |<br>+----+-------------+-------+-------+---------------+------+---------+------+-------+-----------------------+<br>1 row in set (0.01 sec)<br><br>没有重现文章中的问题，继续查找原因中。。。<br>mysql  小白敬上<br>","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431673,"discussion_content":"表是Innodb 的吧？还有数据库隔离级别是RR吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544094692,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":47122,"user_name":"Jason","can_delete":false,"product_type":"c1","uid":1005685,"ip_address":"","ucode":"8651661C362897","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJdic50nGmb0a4IhlUEbFOxN37ng7ziclUibx5zPRkFZVe9LKSQBeqd9J7DicTNbN63hriamcqmicqXzWVQ/132","comment_is_top":false,"comment_ctime":1544060489,"is_pvip":false,"replies":[{"id":"16838","content":"都会去遍历也没关系，关键你的分区不要太多。<br><br><br>还有，别的字段该建的索引还是要建哈","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544071687,"ip_address":"","comment_id":47122,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544060489","product_id":100020801,"comment_content":"大神好，提前问一句，MySQL表分区方案靠谱么?每天产生上百万的大表，想按时间进行分区，不知道会不会踩坑，看很多人说不建议用。<br><br>2018-12-05<br><br> 作者回复<br><br>其实我觉得可以…<br>分区别太多，滚动建上去<br><br>________<br>好像不能继续追加，只能再次提问了。。<br>大神，我这边测试了根据创建时间按天建分区，但是有应用场景用不到创建时间这个条件，查询就巨慢，基本查不出来，就挂了，分区的原理，是根据分区字段来判断落到哪个区去查询对吧，如果没有这个字段，或者过大，是不是就就全量分区都会去遍历一边，请问大神有什么更好的建议么。","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431670,"discussion_content":"都会去遍历也没关系，关键你的分区不要太多。\n\n\n还有，别的字段该建的索引还是要建哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544071687,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":47111,"user_name":"50包邮解君愁","can_delete":false,"product_type":"c1","uid":1077636,"ip_address":"","ucode":"BFC08A518F24B3","user_header":"https://static001.geekbang.org/account/avatar/00/10/71/84/4b33817f.jpg","comment_is_top":false,"comment_ctime":1544059363,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1544059363","product_id":100020801,"comment_content":"explain的时候好多次看到a表的索引一个也没有使用，我是个新手，不知道为什么，有时候建了好多个索引mysql却一个也不用","like_count":0},{"had_liked":false,"id":47063,"user_name":"ye7zi","can_delete":false,"product_type":"c1","uid":1271757,"ip_address":"","ucode":"1534EF36A1CD5A","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKicssIR5KDT8mEXiciadjkxNHr83EicBsD8Ln9Lwrc6BiczFZcwbeFOicUA4QmsFHp3DFDMBN2jVcAmggA/132","comment_is_top":false,"comment_ctime":1544027343,"is_pvip":false,"replies":[{"id":"16826","content":"你这个机器的io不行… <br>你把innodb_flush_log_at_trx_commit 和 sync_binlog 都设置成0来测吧","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544066538,"ip_address":"","comment_id":47063,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544027343","product_id":100020801,"comment_content":"老师：下面链接直接点击就好：<br>http:&#47;&#47;www.ye7zi.xyz:8000&#47;<br>这是我的美国服务器，很安全！","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431650,"discussion_content":"你这个机器的io不行… \n你把innodb_flush_log_at_trx_commit 和 sync_binlog 都设置成0来测吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544066538,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":47057,"user_name":"ye7zi","can_delete":false,"product_type":"c1","uid":1271757,"ip_address":"","ucode":"1534EF36A1CD5A","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKicssIR5KDT8mEXiciadjkxNHr83EicBsD8Ln9Lwrc6BiczFZcwbeFOicUA4QmsFHp3DFDMBN2jVcAmggA/132","comment_is_top":false,"comment_ctime":1544026884,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1544026884","product_id":100020801,"comment_content":"老师，这么晚还没睡呀 辛苦哈<br>我把结果放在美国服务器上，一会发链接","like_count":0},{"had_liked":false,"id":47043,"user_name":"ye7zi","can_delete":false,"product_type":"c1","uid":1271757,"ip_address":"","ucode":"1534EF36A1CD5A","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKicssIR5KDT8mEXiciadjkxNHr83EicBsD8Ln9Lwrc6BiczFZcwbeFOicUA4QmsFHp3DFDMBN2jVcAmggA/132","comment_is_top":false,"comment_ctime":1544025173,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1544025173","product_id":100020801,"comment_content":"老师，您好，问一下，插人10万条非常慢：<br>环境：虚拟机，4c,8G内存，centos6.5，mysql5.7.24，开binlog；<br><br>插10万条，到现在，一个小时了，还没结束，此时：binlog日志：19MB；数据文件：t.ibd 13M<br><br>然后：在插入的过程中：iostat和vmstat测试磁盘：<br>[root@vm205 test]# iostat -x 1 5<br><br>avg-cpu:  %user   %nice %system %iowait  %steal   %idle<br>           0.22    0.00    0.25    0.83    0.00   98.70<br>Device:         rrqm&#47;s   wrqm&#47;s     r&#47;s     w&#47;s   rsec&#47;s   wsec&#47;s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util<br>sda               0.00     7.00    0.00   87.00     0.00   752.00     8.64     1.48   17.22    0.00   17.22  11.44  99.50<br>dm-0              0.00     0.00    0.00   93.00     0.00   744.00     8.00     1.81   19.62    0.00   19.62  10.69  99.40<br>[root@vm205 test]# vmstat 1 5<br>procs -----------memory---------- ---swap-- -----io---- --system-- -----cpu-----<br> r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st<br> 0  1      0 7924356 227072 3370624    0    0     0   536 1497 2757  0  1 75 24  0<br>[root@vm205 test]# <br><br>最后：orion测试IOPS:<br><br>[root@vm205 iops]# .&#47;orion_linux_x86-64 -run advanced -testname zhang -num_disks 1 -size_small 8 -size_large 8 -type rand <br>ORION: ORacle IO Numbers -- Version 11.1.0.7.0<br>zhang_20181205_2321<br>Test will take approximately 9 minutes<br>Larger caches may take longer<br><br>[root@vm205 iops]# more zhang_20181205_2321_summary.txt <br>ORION VERSION 11.1.0.7.0<br><br>Commandline:<br>-run advanced -testname zhang -num_disks 1 -size_small 8 -size_large 8 -type rand <br><br>This maps to this test:<br>Test: zhang<br>Small IO size: 8 KB<br>Large IO size: 8 KB<br>IO Types: Small Random IOs, Large Random IOs<br>Simulated Array Type: CONCAT<br>Write: 0%<br>Cache Size: Not Entered<br>Duration for each Data Point: 60 seconds<br>Small Columns:,      0<br>Large Columns:,      0,      1,      2<br>Total Data Points: 8<br><br>Name: &#47;dev&#47;sda1 Size: 209715200<br>1 FILEs found.<br><br>Maximum Large MBPS=96.14 @ Small=0 and Large=2<br>Maximum Small IOPS=15930 @ Small=4 and Large=0<br>Minimum Small Latency=0.15 @ Small=1 and Large=0<br><br>老师：：：您好：<br><br>您能帮忙看看   给点分析意见吗？？多谢了。<br>","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":153278,"discussion_content":"你把innodb_flush_log_at_trx_commit 和 sync_binlog 都设置成0来测吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580041776,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":47008,"user_name":"阿丽","can_delete":false,"product_type":"c1","uid":1170970,"ip_address":"","ucode":"C01D32E7165302","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erJFlHhylrbLANtehiaX50wgVa2Z1ibQAdLpgyW4gCpEyOKEI9bPNZZBiabrP2oCleZWc2KKyKADz8tg/132","comment_is_top":false,"comment_ctime":1544018626,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1544018626","product_id":100020801,"comment_content":"老师，我碰到一个问题，update时where id=x and tid=xx and sid=xxx，id是主键，后两列分别有索引，执行计划用的primary，但type是range，让人费解，使用select执行计划的type却是const，，希望老师有时间帮忙解答，谢谢！","like_count":0},{"had_liked":false,"id":47002,"user_name":"nero","can_delete":false,"product_type":"c1","uid":1110627,"ip_address":"","ucode":"BACD4A95B5FA09","user_header":"https://static001.geekbang.org/account/avatar/00/10/f2/63/1f495e51.jpg","comment_is_top":false,"comment_ctime":1544017243,"is_pvip":false,"replies":[{"id":"16770","content":"如果有满足条件的行，确实就是你说的这么做的，<br>但是这个例子里面并没有满足的哦<br><br>","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544018559,"ip_address":"","comment_id":47002,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544017243","product_id":100020801,"comment_content":"老师我有个奇怪的问题请教下您： select * from t where (a between 1 and 1000)  and (b between 50000 and 100000) order by b limit 1; mysql在选错索引的情况下，为啥不考虑后面的limit1，比如错误用了b索引，查一条后，直接判断a是否满足条件，a满足条件的话就直接返回好了，因为b本身就是有序的，这样就只要扫描前几个就好了，为啥要把b的50001个全查出来再进行a的判断，最后再排序返回一个。<br>可能有点小白哈<br><br>","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431632,"discussion_content":"如果有满足条件的行，确实就是你说的这么做的，\n但是这个例子里面并没有满足的哦\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544018559,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":46975,"user_name":"Wrelon","can_delete":false,"product_type":"c1","uid":1306021,"ip_address":"","ucode":"8670BDBF317A36","user_header":"https://static001.geekbang.org/account/avatar/00/13/ed/a5/ca3b4cc4.jpg","comment_is_top":false,"comment_ctime":1544013975,"is_pvip":false,"replies":[{"id":"16779","content":"你这样描述我很难回答… 确保业务安全的情况下，analyze一把？","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544020156,"ip_address":"","comment_id":46975,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544013975","product_id":100020801,"comment_content":"老师，今天做优化的时候碰到类似问题了，explain分析SQL发现预计索引为空，实际索引为两张表的索引，但是rows为62w跟8w，也就是全表扫描了，但是确实有用到索引，请问该怎么解决？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431624,"discussion_content":"你这样描述我很难回答… 确保业务安全的情况下，analyze一把？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544020156,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":46909,"user_name":"Leon📷","can_delete":false,"product_type":"c1","uid":1219496,"ip_address":"","ucode":"B9BBD1EFAAE5A2","user_header":"https://static001.geekbang.org/account/avatar/00/12/9b/a8/6a391c66.jpg","comment_is_top":false,"comment_ctime":1543999941,"is_pvip":false,"replies":[{"id":"16784","content":"Session A的操作时间顺序对了ma","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544020390,"ip_address":"","comment_id":46909,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1543999941","product_id":100020801,"comment_content":"老师，是不是新版mysql5.7已经修复了你说的这个bug，我的slow_log是这样的<br>SET timestamp=1543999785;<br>set long_query_time=0;<br># Time: 2018-12-05T08:49:58.292037Z<br># User@Host: root[root] @ localhost []  Id:     7<br># Query_time: 0.017165  Lock_time: 0.000179 Rows_sent: 10001  Rows_examined: 10001<br>SET timestamp=1543999798;<br>select * from t where a between 10000 and 20000;<br># Time: 2018-12-05T08:50:04.762129Z<br># User@Host: root[root] @ localhost []  Id:     7<br># Query_time: 0.014629  Lock_time: 0.000170 Rows_sent: 10001  Rows_examined: 10001<br>SET timestamp=1543999804;<br>select * from t force index(a) where a between 10000 and 20000;","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431595,"discussion_content":"Session A的操作时间顺序对了ma","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544020390,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":46889,"user_name":"无眠","can_delete":false,"product_type":"c1","uid":1123870,"ip_address":"","ucode":"FBFA936A884EAA","user_header":"https://static001.geekbang.org/account/avatar/00/11/26/1e/adc166df.jpg","comment_is_top":false,"comment_ctime":1543997426,"is_pvip":false,"replies":[{"id":"16787","content":"1. 2. 这个有点复杂我没想好怎么描述，容我三思…<br>3. server层","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544022469,"ip_address":"","comment_id":46889,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1543997426","product_id":100020801,"comment_content":"有些不太明白，图11下面描述的“我们用limit 100让优化器意识到，使用b索引代价是很高的”这句，limit 100怎么就代价高了？另外，优化器是如何分析limit子句的？对于limit 子句是在引擎层还是server层起作用的？望老师解惑","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431588,"discussion_content":"1. 2. 这个有点复杂我没想好怎么描述，容我三思…\n3. server层","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544022469,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":46886,"user_name":"Jason","can_delete":false,"product_type":"c1","uid":1005685,"ip_address":"","ucode":"8651661C362897","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJdic50nGmb0a4IhlUEbFOxN37ng7ziclUibx5zPRkFZVe9LKSQBeqd9J7DicTNbN63hriamcqmicqXzWVQ/132","comment_is_top":false,"comment_ctime":1543997034,"is_pvip":false,"replies":[{"id":"16789","content":"其实我觉得可以…<br>分区别太多，滚动建上去","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544022691,"ip_address":"","comment_id":46886,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1543997034","product_id":100020801,"comment_content":"大神好，提前问一句，MySQL表分区方案靠谱么?每天产生上百万的大表，想按时间进行分区，不知道会不会踩坑，看很多人说不建议用。","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431586,"discussion_content":"其实我觉得可以…\n分区别太多，滚动建上去","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544022691,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":46862,"user_name":"ajlidue","can_delete":false,"product_type":"c1","uid":1308376,"ip_address":"","ucode":"D6B29E941958E8","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83er6NXib2NGaTAAEe2KCcibH2FiafOOD73kQdcuAMGrnRib5CDWXum0SWDOM9NnWicbUsDpghmxEmJtpk9w/132","comment_is_top":false,"comment_ctime":1543993207,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1543993207","product_id":100020801,"comment_content":"5.6.24，show variables like ‘tx_isolation’ 为REPEATABLE-READ，未复现，且explain的rows为10000","like_count":0},{"had_liked":false,"id":46854,"user_name":"lianjie1229","can_delete":false,"product_type":"c1","uid":1302615,"ip_address":"","ucode":"C13DD612602DA9","user_header":"","comment_is_top":false,"comment_ctime":1543991590,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1543991590","product_id":100020801,"comment_content":"第一个选错索引的例子，在5.7.24版本上没复现出来<br>session A:<br>| transaction_isolation                                    | REPEATABLE-READ |<br>13 rows in set (0.01 sec)<br>mysql&gt; start transaction with consistent snapshot;<br>Query OK, 0 rows affected (0.00 sec)<br>mysql&gt; select now();<br>+---------------------+<br>| now()               |<br>+---------------------+<br>| 2018-12-04 22:20:03 |<br>+---------------------+<br>1 row in set (0.00 sec)<br><br>mysql&gt; select now();<br>+---------------------+<br>| now()               |<br>+---------------------+<br>| 2018-12-04 22:22:16 |<br>+---------------------+<br>1 row in set (0.00 sec)<br>mysql&gt; commit;<br>Query OK, 0 rows affected (0.00 sec)<br>session B:<br>mysql&gt; select now();<br>+---------------------+<br>| now()               |<br>+---------------------+<br>| 2018-12-04 22:20:20 |<br>+---------------------+<br>1 row in set (0.00 sec)<br>mysql&gt;<br>mysql&gt; delete from t;<br>Query OK, 100000 rows affected (0.66 sec)<br>mysql&gt; call idata();<br>Query OK, 1 row affected (52.57 sec)<br>mysql&gt; select now();<br>+---------------------+<br>| now()               |<br>+---------------------+<br>| 2018-12-04 22:21:57 |<br>+---------------------+<br>1 row in set (0.01 sec)<br><br>mysql&gt; explain select * from t where a between 10000 and 20000;<br>+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+<br>| id | select_type | table | partitions | type  | possible_keys | key  | key_len | ref  | rows  | filtered | Extra                 |<br>+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+<br>|  1 | SIMPLE      | t     | NULL       | range | a             | a    | 5       | NULL | 10001 |   100.00 | Using index condition |<br>","like_count":0},{"had_liked":false,"id":46846,"user_name":"木偶人King","can_delete":false,"product_type":"c1","uid":1028805,"ip_address":"","ucode":"0BDCA51E6F0B76","user_header":"https://static001.geekbang.org/account/avatar/00/0f/b2/c5/6ae0be56.jpg","comment_is_top":false,"comment_ctime":1543990678,"is_pvip":false,"replies":[{"id":"16747","content":"没区别","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544011941,"ip_address":"","comment_id":46846,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1543990678","product_id":100020801,"comment_content":"老师你好, 这个创建索引的时候,我看到这里经常用的是key,   而不是index.  这个有什么区别吗?","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431566,"discussion_content":"没区别","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544011941,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":46843,"user_name":"bowenz","can_delete":false,"product_type":"c1","uid":1127589,"ip_address":"","ucode":"A58FF6F9E4040C","user_header":"https://static001.geekbang.org/account/avatar/00/11/34/a5/db01dc4f.jpg","comment_is_top":false,"comment_ctime":1543990100,"is_pvip":false,"replies":[{"id":"16746","content":"发个微博或博客，然后贴地址。我也用的5.7.21…","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544011801,"ip_address":"","comment_id":46843,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1543990100","product_id":100020801,"comment_content":"在5.7.21版本没有出现案例1的情况 <br>留言好像上不了截图","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431564,"discussion_content":"发个微博或博客，然后贴地址。我也用的5.7.21…","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544011801,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":46818,"user_name":"Tony Du","can_delete":false,"product_type":"c1","uid":1001661,"ip_address":"","ucode":"F5FCC400E615EA","user_header":"https://static001.geekbang.org/account/avatar/00/0f/48/bd/6c7d4230.jpg","comment_is_top":false,"comment_ctime":1543986178,"is_pvip":false,"replies":[{"id":"16714","content":"前面的过程有个理解不太对：<br><br>如果merge还没做，磁盘上page 2的数据是不会变的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1543990166,"ip_address":"","comment_id":46818,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1543986178","product_id":100020801,"comment_content":"对于redo log，后台会定期把redo log的内容刷到磁盘，然后对于change buffer，后台也会定期做merge操作（或者当访问数据页的时候做定期操作）。那当redo log刷到磁盘上后，读取磁盘上的数据页就是最新的了，则此时当读取数据页时的merge操作（merge操作 ＝ 更新操作 ＋ 老的数据页面）不就显得不不正确了？<br>换一个角度问，redo log定期刷到磁盘和change buffer定期merge操作（之后把脏页刷到磁盘），之间有什么联系？因为它们都会将最新的数据刷到磁盘上。如果有两条并行的线去刷最新的数据到磁盘，则两者之间如何同步？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431556,"discussion_content":"前面的过程有个理解不太对：\n\n如果merge还没做，磁盘上page 2的数据是不会变的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1543990166,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":46806,"user_name":"郭江伟","can_delete":false,"product_type":"c1","uid":1313994,"ip_address":"","ucode":"613D638619B5A2","user_header":"https://static001.geekbang.org/account/avatar/00/14/0c/ca/6173350b.jpg","comment_is_top":false,"comment_ctime":1543984778,"is_pvip":false,"replies":[{"id":"16715","content":"99722已经算是不错啦，挺接近的了…","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1543990249,"ip_address":"","comment_id":46806,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1543984778","product_id":100020801,"comment_content":"重复测试几次始终无法获取正确的统计信息，步骤如下：<br>mysql&gt; show create table t;<br>| Table | Create Table   |<br>| t     | CREATE TABLE `t` (<br>  `id` int(11) NOT NULL,<br>  `a` int(11) DEFAULT NULL,<br>  `b` int(11) DEFAULT NULL,<br>  PRIMARY KEY (`id`),<br>  KEY `a` (`a`),<br>  KEY `b` (`b`)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |<br>按照专栏脚本插入数据后：<br>mysql&gt; select count(*) from t where a between 10001 and 20000;<br>| count(*) |<br>|    10000 |<br>执行计划rows理论值应该在10000附近，实际却是18900 <br>mysql&gt; explain select * from t   where a between 10001 and 20000 ;<br>| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows  | filtered | Extra       |<br>+----+-------------+-------+------------+------+---------------+------+---------+------+-------<br>|  1 | SIMPLE      | t     | NULL       | ALL  | a             | NULL | NULL    | NULL | 99722 |    18.95 | Using where |<br><br>mysql&gt; explain select * from t  force index(a)  where a between 10001 and 20000 ;<br>| id | select_type | table | partitions | type  | possible_keys | key  | key_len | ref  | rows  | filtered | Extra                 |<br>+----+-------------+-------+------------+-------+---------------+------+---------+------+-------<br>|  1 | SIMPLE      | t     | NULL       | range | a             | a    | 5       | NULL | 18900 |   100.00 | Using index condition |<br>1 row in set, 1 warning (0.00 sec)<br><br>mysql&gt; analyze table t;<br>| Table      | Op      | Msg_type | Msg_text |<br>| sysbench.t | analyze | status   | OK       |<br><br>mysql&gt; explain select * from t   where a between 10001 and 20000 ;<br>| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows  | filtered | Extra       |<br>+----+-------------+-------+------------+------+---------------+------+<br>|  1 | SIMPLE      | t     | NULL       | ALL  | a             | NULL | NULL    | NULL | 99722 |    18.95 | Using where |<br><br>mysql&gt; show variables like &#39;%stats_persistent%&#39;;<br>| innodb_stats_persistent              | ON    |<br>| innodb_stats_persistent_sample_pages | 20    |<br>执行 truncate table t;后重新插入数据依然是上面的情况","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431552,"discussion_content":"99722已经算是不错啦，挺接近的了…","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1543990249,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":46805,"user_name":"栋能","can_delete":false,"product_type":"c1","uid":1006849,"ip_address":"","ucode":"8BD9C939D3E8E1","user_header":"https://static001.geekbang.org/account/avatar/00/0f/5d/01/9cd84003.jpg","comment_is_top":false,"comment_ctime":1543984679,"is_pvip":false,"replies":[{"id":"16706","content":"删不掉，MDL锁住了","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1543985379,"ip_address":"","comment_id":46805,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1543984679","product_id":100020801,"comment_content":"看到这篇文章我突然有了个新的MVCC疑惑，希望老师解惑下。谢谢。<br>我理解Delete操作是物理删除。如果有两个事务，事务A“读T表，再更新T表”的“更新T表”前事务B删除了T表，那更新还会成功吗？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431551,"discussion_content":"删不掉，MDL锁住了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1543985379,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":46786,"user_name":"Rainbow","can_delete":false,"product_type":"c1","uid":1214835,"ip_address":"","ucode":"0651CFFE920BE7","user_header":"https://static001.geekbang.org/account/avatar/00/12/89/73/e1e01096.jpg","comment_is_top":false,"comment_ctime":1543981532,"is_pvip":false,"replies":[{"id":"16708","content":"事务隔离级别是可重复读吗？","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1543985634,"ip_address":"","comment_id":46786,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1543981532","product_id":100020801,"comment_content":"老师你好，我把文章开头的实验按步骤做了。<br>执行了session A 和session B 的操作之后，MySQL并没有选错索引，用的还是`a`这个索引。<br>是因为MySQL版本问题吗？<br>我用的是5.7<br>mysql&gt; select version();<br>+-------------------------+<br>| version()               |<br>+-------------------------+<br>| 5.7.24-0ubuntu0.16.04.1 <br><br>希望老师能解答一下：）<br>","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431545,"discussion_content":"事务隔离级别是可重复读吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1543985634,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":46770,"user_name":"HuaMax","can_delete":false,"product_type":"c1","uid":1118488,"ip_address":"","ucode":"2E78DE1AF098AF","user_header":"https://static001.geekbang.org/account/avatar/00/11/11/18/8cee35f9.jpg","comment_is_top":false,"comment_ctime":1543979201,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1543979201","product_id":100020801,"comment_content":"课后题我的理解是，session A在B之前启动，对于session B，A对数据的变更不可见，因此索引在统计时只能悲观的加上session A视图下的统计信息，并且B自己的事务内的存储过程插入了1万行数据，由于没有提交，所以加上这1万行数据。这样算起来应该是2万，为啥是3万多，没想明白，望解惑","like_count":0},{"had_liked":false,"id":46768,"user_name":"天王","can_delete":false,"product_type":"c1","uid":1239337,"ip_address":"","ucode":"C074B2F9A5F007","user_header":"https://static001.geekbang.org/account/avatar/00/12/e9/29/629d9bb0.jpg","comment_is_top":false,"comment_ctime":1543978932,"is_pvip":false,"replies":[{"id":"16695","content":"Join的顺序MySQL 会帮你选的哈，<br><br>这个我得想下，放到篇文章展开","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1543982763,"ip_address":"","comment_id":46768,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1543978932","product_id":100020801,"comment_content":"请教一个问题：单表索引的分析相对简单一些。如果是多表关联查询，多个表的数据量很大，where条件里面有多个列，<br>怎么控制join和on的顺序，where条件里面字段的顺序，怎么建索引，让查询性能达到最优，有成型的规律吗，能否通过一些例子讲下？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431539,"discussion_content":"Join的顺序MySQL 会帮你选的哈，\n\n这个我得想下，放到篇文章展开","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1543982763,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":46755,"user_name":"看不穿","can_delete":false,"product_type":"c1","uid":1259769,"ip_address":"","ucode":"8D35C36C7A35F0","user_header":"https://static001.geekbang.org/account/avatar/00/13/38/f9/2b4755b5.jpg","comment_is_top":false,"comment_ctime":1543977806,"is_pvip":false,"replies":[{"id":"16693","content":"嗯，MySQL 的优化器有时候就是不会做那些，我们觉得“本该做”的事情😓","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1543982553,"ip_address":"","comment_id":46755,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1543977806","product_id":100020801,"comment_content":"老师，MySQL还有个不走索引的bug，感觉很诡异，生产上碰到多次了，就是update  ... set ...  where in select，走的索引不是我们期望的，必须转化为update ... join ... set ...。<br>参考文档：https:&#47;&#47;blog.csdn.net&#47;defonds&#47;article&#47;details&#47;46745143<br>以前在学oracle的时候，老师常说oracle的优化器是活的。可是到了mysql这，有时候只能呵呵了","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431531,"discussion_content":"嗯，MySQL 的优化器有时候就是不会做那些，我们觉得“本该做”的事情😓","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1543982553,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":46754,"user_name":"lianjie1229","can_delete":false,"product_type":"c1","uid":1302615,"ip_address":"","ucode":"C13DD612602DA9","user_header":"","comment_is_top":false,"comment_ctime":1543977686,"is_pvip":false,"replies":[{"id":"16696","content":"Session A正常工作了吗？过程截图看下？","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1543982814,"ip_address":"","comment_id":46754,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1543977686","product_id":100020801,"comment_content":"第一个选错索引的例子，在5.7.24版本上没复现出来，其他同学有复现出来的吗","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431530,"discussion_content":"Session A正常工作了吗？过程截图看下？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1543982814,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":46748,"user_name":"dancer","can_delete":false,"product_type":"c1","uid":1019036,"ip_address":"","ucode":"B8D5641A3AC490","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8c/9c/d48473ab.jpg","comment_is_top":false,"comment_ctime":1543976899,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1543976899","product_id":100020801,"comment_content":"感谢老师的细致讲解，曾经面试过程中就遇到过类似的问索引区分度的问题~","like_count":0},{"had_liked":false,"id":46676,"user_name":"Justin","can_delete":false,"product_type":"c1","uid":1305601,"ip_address":"","ucode":"D49723FEA66731","user_header":"https://static001.geekbang.org/account/avatar/00/13/ec/01/978d54af.jpg","comment_is_top":false,"comment_ctime":1543970763,"is_pvip":false,"replies":[{"id":"16678","content":"会，普通索引也要满足事务隔离级别下的可见性规则","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1543974639,"ip_address":"","comment_id":46676,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1543970763","product_id":100020801,"comment_content":"普通索引和mvcc有关系吗 会不会根据不同的tx id 有不同的结果呢？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431505,"discussion_content":"会，普通索引也要满足事务隔离级别下的可见性规则","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1543974639,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":46666,"user_name":"Justin","can_delete":false,"product_type":"c1","uid":1305601,"ip_address":"","ucode":"D49723FEA66731","user_header":"https://static001.geekbang.org/account/avatar/00/13/ec/01/978d54af.jpg","comment_is_top":false,"comment_ctime":1543970348,"is_pvip":false,"replies":[{"id":"16674","content":"索引的内容（逻辑上）是马上变化的，否则我们再去查的时候就出错了。<br><br>但是物理上，可能会有Change buffer,<br>如果是这篇文章中说的统计信息，不会每次更新都重新统计，参考“1&#47;M”那段","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1543974389,"ip_address":"","comment_id":46666,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1543970348","product_id":100020801,"comment_content":"删除行之后索引会立刻做出变化吗？是怎么变化的呢？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431501,"discussion_content":"索引的内容（逻辑上）是马上变化的，否则我们再去查的时候就出错了。\n\n但是物理上，可能会有Change buffer,\n如果是这篇文章中说的统计信息，不会每次更新都重新统计，参考“1/M”那段","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1543974389,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":46654,"user_name":"一大只😴","can_delete":false,"product_type":"c1","uid":1310960,"ip_address":"","ucode":"92F3D2B7F63568","user_header":"https://static001.geekbang.org/account/avatar/00/14/00/f0/08409e78.jpg","comment_is_top":false,"comment_ctime":1543969430,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1543969430","product_id":100020801,"comment_content":"老师，联合索引的区分度咋看啊？","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":153314,"discussion_content":"可以看一下索引的基数，这不就是区分度了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580043495,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":46639,"user_name":"404  had found","can_delete":false,"product_type":"c1","uid":1025939,"ip_address":"","ucode":"BF6983EB50AC74","user_header":"https://static001.geekbang.org/account/avatar/00/0f/a7/93/62f03467.jpg","comment_is_top":false,"comment_ctime":1543967943,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1543967943","product_id":100020801,"comment_content":"优化器选择索引的原则是什么呢？可以介绍下吗？","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":153330,"discussion_content":"选择行数最少的，节省CPU时间的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580044039,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":46637,"user_name":"404  had found","can_delete":false,"product_type":"c1","uid":1025939,"ip_address":"","ucode":"BF6983EB50AC74","user_header":"https://static001.geekbang.org/account/avatar/00/0f/a7/93/62f03467.jpg","comment_is_top":false,"comment_ctime":1543967710,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1543967710","product_id":100020801,"comment_content":"一楼的是不是用了联合查询，优化器会选择小表去驱动，如果如果排序字段是驱动表的字段会用索引的，不然只能指定驱动表了。可以执行explain看驱动表，迪哥0第一个就是驱动表","like_count":0},{"had_liked":false,"id":46613,"user_name":"码上有钱","can_delete":false,"product_type":"c1","uid":1081524,"ip_address":"","ucode":"BB10B8686DE9B0","user_header":"https://static001.geekbang.org/account/avatar/00/10/80/b4/4bce6198.jpg","comment_is_top":false,"comment_ctime":1543953645,"is_pvip":true,"replies":[{"id":"16665","content":"嗯嗯，这种不是 bug,这是优化器正常工作了😄","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1543974010,"ip_address":"","comment_id":46613,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1543953645","product_id":100020801,"comment_content":"遇到过这样一种情况，索引是建在一个日期类型的字段，范围查询时，要查的数量少的时候就走索引，数量大的时候就不走索引。","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431492,"discussion_content":"嗯嗯，这种不是 bug,这是优化器正常工作了😄","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1543974010,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}