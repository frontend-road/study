{"id":312590,"title":"20 | åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼Œé˜Ÿåˆ—ã€æ …æ å’ŒSTMè¯¥å¦‚ä½•å®ç°ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯é¸Ÿçªã€‚</p><p>ä¸Šä¸€è®²ï¼Œæˆ‘å·²ç»å¸¦ä½ è®¤è¯†äº†åŸºäºetcdå®ç°çš„Leaderé€‰ä¸¾ã€äº’æ–¥é”å’Œè¯»å†™é”ï¼Œä»Šå¤©ï¼Œæˆ‘ä»¬æ¥å­¦ä¹ ä¸‹åŸºäºetcdçš„åˆ†å¸ƒå¼é˜Ÿåˆ—ã€æ …æ å’ŒSTMã€‚</p><p>åªè¦ä½ å­¦è¿‡è®¡ç®—æœºç®—æ³•å’Œæ•°æ®ç»“æ„ç›¸å…³çš„çŸ¥è¯†ï¼Œ é˜Ÿåˆ—è¿™ç§æ•°æ®ç»“æ„ä½ ä¸€å®šä¸é™Œç”Ÿï¼Œå®ƒæ˜¯ä¸€ç§å…ˆè¿›å…ˆå‡ºçš„ç±»å‹ï¼Œæœ‰å‡ºé˜Ÿï¼ˆdequeueï¼‰å’Œå…¥é˜Ÿï¼ˆenqueueï¼‰ä¸¤ç§æ“ä½œã€‚åœ¨<a href=\"https://time.geekbang.org/column/article/304127\">ç¬¬12è®²</a>ä¸­ï¼Œæˆ‘ä¸“é—¨è®²åˆ°äº†ä¸€ç§å«åšlock-freeçš„é˜Ÿåˆ—ã€‚é˜Ÿåˆ—åœ¨å•æœºçš„åº”ç”¨ç¨‹åºä¸­å¸¸å¸¸ä½¿ç”¨ï¼Œä½†æ˜¯åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼Œå¤šèŠ‚ç‚¹å¦‚ä½•å¹¶å‘åœ°æ‰§è¡Œå…¥é˜Ÿå’Œå‡ºé˜Ÿçš„æ“ä½œå‘¢ï¼Ÿè¿™ä¸€è®²ï¼Œæˆ‘ä¼šå¸¦ä½ è®¤è¯†ä¸€ä¸‹åŸºäºetcdå®ç°çš„åˆ†å¸ƒå¼é˜Ÿåˆ—ã€‚</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘è¿˜ä¼šè®²ç”¨åˆ†å¸ƒå¼æ …æ ç¼–æ’ä¸€ç»„åˆ†å¸ƒå¼èŠ‚ç‚¹åŒæ—¶æ‰§è¡Œçš„æ–¹æ³•ï¼Œä»¥åŠç®€åŒ–å¤šä¸ªkeyçš„æ“ä½œå¹¶ä¸”æä¾›äº‹åŠ¡åŠŸèƒ½çš„STMï¼ˆSoftware Transactional Memoryï¼Œè½¯ä»¶äº‹åŠ¡å†…å­˜ï¼‰ã€‚</p><h1>åˆ†å¸ƒå¼é˜Ÿåˆ—å’Œä¼˜å…ˆçº§é˜Ÿåˆ—</h1><p>å‰ä¸€è®²æˆ‘ä¹Ÿè®²åˆ°ï¼Œæˆ‘ä»¬å¹¶ä¸æ˜¯ä»é›¶å¼€å§‹å®ç°ä¸€ä¸ªåˆ†å¸ƒå¼é˜Ÿåˆ—ï¼Œè€Œæ˜¯ç«™åœ¨etcdçš„è‚©è†€ä¸Šï¼Œåˆ©ç”¨etcdæä¾›çš„åŠŸèƒ½å®ç°åˆ†å¸ƒå¼é˜Ÿåˆ—ã€‚</p><p>etcdé›†ç¾¤çš„å¯ç”¨æ€§ç”±etcdé›†ç¾¤çš„ç»´æŠ¤è€…æ¥ä¿è¯ï¼Œæˆ‘ä»¬ä¸ç”¨æ‹…å¿ƒç½‘ç»œåˆ†åŒºã€èŠ‚ç‚¹å®•æœºç­‰é—®é¢˜ã€‚æˆ‘ä»¬å¯ä»¥æŠŠè¿™äº›é€šé€šäº¤ç»™etcdçš„è¿ç»´äººå‘˜ï¼ŒæŠŠæˆ‘ä»¬è‡ªå·±çš„å…³æ³¨ç‚¹æ”¾åœ¨ä½¿ç”¨ä¸Šã€‚</p><p>ä¸‹é¢ï¼Œæˆ‘ä»¬å°±æ¥äº†è§£ä¸‹etcdæä¾›çš„åˆ†å¸ƒå¼é˜Ÿåˆ—ã€‚etcdé€šè¿‡github.com/coreos/etcd/contrib/recipesåŒ…æä¾›äº†åˆ†å¸ƒå¼é˜Ÿåˆ—è¿™ç§æ•°æ®ç»“æ„ã€‚</p><!-- [[[read_end]]] --><p>åˆ›å»ºåˆ†å¸ƒå¼é˜Ÿåˆ—çš„æ–¹æ³•éå¸¸ç®€å•ï¼Œåªæœ‰ä¸€ä¸ªï¼Œå³NewQueueï¼Œä½ åªéœ€è¦ä¼ å…¥etcdçš„clientå’Œè¿™ä¸ªé˜Ÿåˆ—çš„åå­—ï¼Œå°±å¯ä»¥äº†ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><pre><code>func NewQueue(client *v3.Client, keyPrefix string) *Queue\n</code></pre><p><strong>è¿™ä¸ªé˜Ÿåˆ—åªæœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯å‡ºé˜Ÿå’Œå…¥é˜Ÿï¼Œé˜Ÿåˆ—ä¸­çš„å…ƒç´ æ˜¯å­—ç¬¦ä¸²ç±»å‹</strong>ã€‚è¿™ä¸¤ä¸ªæ–¹æ³•çš„ç­¾åå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>// å…¥é˜Ÿ\nfunc (q *Queue) Enqueue(val string) error\n//å‡ºé˜Ÿ\nfunc (q *Queue) Dequeue() (string, error)\n</code></pre><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœè¿™ä¸ªåˆ†å¸ƒå¼é˜Ÿåˆ—å½“å‰ä¸ºç©ºï¼Œè°ƒç”¨Dequeueæ–¹æ³•çš„è¯ï¼Œä¼šè¢«é˜»å¡ï¼Œç›´åˆ°æœ‰å…ƒç´ å¯ä»¥å‡ºé˜Ÿæ‰è¿”å›ã€‚</p><p>æ—¢ç„¶æ˜¯åˆ†å¸ƒå¼çš„é˜Ÿåˆ—ï¼Œé‚£å°±æ„å‘³ç€ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸€ä¸ªèŠ‚ç‚¹å°†å…ƒç´ æ”¾å…¥é˜Ÿåˆ—ï¼Œåœ¨å¦å¤–ä¸€ä¸ªèŠ‚ç‚¹æŠŠå®ƒå–å‡ºã€‚</p><p>åœ¨æˆ‘æ¥ä¸‹æ¥è®²çš„ä¾‹å­ä¸­ï¼Œä½ å°±å¯ä»¥å¯åŠ¨ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œä¸€ä¸ªèŠ‚ç‚¹å¾€é˜Ÿåˆ—ä¸­æ”¾å…¥å…ƒç´ ï¼Œä¸€ä¸ªèŠ‚ç‚¹ä»é˜Ÿåˆ—ä¸­å–å‡ºå…ƒç´ ï¼Œçœ‹çœ‹æ˜¯å¦èƒ½æ­£å¸¸å–å‡ºæ¥ã€‚etcdçš„åˆ†å¸ƒå¼é˜Ÿåˆ—æ˜¯ä¸€ç§å¤šè¯»å¤šå†™çš„é˜Ÿåˆ—ï¼Œæ‰€ä»¥ï¼Œä½ ä¹Ÿå¯ä»¥å¯åŠ¨å¤šä¸ªå†™èŠ‚ç‚¹å’Œå¤šä¸ªè¯»èŠ‚ç‚¹ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬æ¥å€ŸåŠ©ä»£ç ï¼Œçœ‹ä¸€ä¸‹å¦‚ä½•å®ç°åˆ†å¸ƒå¼é˜Ÿåˆ—ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬å¯åŠ¨ä¸€ä¸ªç¨‹åºï¼Œå®ƒä¼šä»å‘½ä»¤è¡Œè¯»å–ä½ çš„å‘½ä»¤ï¼Œç„¶åæ‰§è¡Œã€‚ä½ å¯ä»¥è¾“å…¥<code>push &lt;value&gt;</code>ï¼Œå°†ä¸€ä¸ªå…ƒç´ å…¥é˜Ÿï¼Œè¾“å…¥<code>pop</code>ï¼Œå°†ä¸€ä¸ªå…ƒç´ å¼¹å‡ºã€‚å¦å¤–ï¼Œä½ è¿˜å¯ä»¥ä½¿ç”¨è¿™ä¸ªç¨‹åºå¯åŠ¨å¤šä¸ªå®ä¾‹ï¼Œç”¨æ¥æ¨¡æ‹Ÿåˆ†å¸ƒå¼çš„ç¯å¢ƒï¼š</p><pre><code>package main\n\n\nimport (\n    &quot;bufio&quot;\n    &quot;flag&quot;\n    &quot;fmt&quot;\n    &quot;log&quot;\n    &quot;os&quot;\n    &quot;strings&quot;\n\n\n    &quot;github.com/coreos/etcd/clientv3&quot;\n    recipe &quot;github.com/coreos/etcd/contrib/recipes&quot;\n)\n\n\nvar (\n    addr      = flag.String(&quot;addr&quot;, &quot;http://127.0.0.1:2379&quot;, &quot;etcd addresses&quot;)\n    queueName = flag.String(&quot;name&quot;, &quot;my-test-queue&quot;, &quot;queue name&quot;)\n)\n\n\nfunc main() {\n    flag.Parse()\n\n\n    // è§£æetcdåœ°å€\n    endpoints := strings.Split(*addr, &quot;,&quot;)\n\n\n    // åˆ›å»ºetcdçš„client\n    cli, err := clientv3.New(clientv3.Config{Endpoints: endpoints})\n    if err != nil {\n        log.Fatal(err)\n    }\n    defer cli.Close()\n\n\n    // åˆ›å»º/è·å–é˜Ÿåˆ—\n    q := recipe.NewQueue(cli, *queueName)\n\n\n    // ä»å‘½ä»¤è¡Œè¯»å–å‘½ä»¤\n    consolescanner := bufio.NewScanner(os.Stdin)\n    for consolescanner.Scan() {\n        action := consolescanner.Text()\n        items := strings.Split(action, &quot; &quot;)\n        switch items[0] {\n        case &quot;push&quot;: // åŠ å…¥é˜Ÿåˆ—\n            if len(items) != 2 {\n                fmt.Println(&quot;must set value to push&quot;)\n                continue\n            }\n            q.Enqueue(items[1]) // å…¥é˜Ÿ\n        case &quot;pop&quot;: // ä»é˜Ÿåˆ—å¼¹å‡º\n            v, err := q.Dequeue() // å‡ºé˜Ÿ\n            if err != nil {\n                log.Fatal(err)\n            }\n            fmt.Println(v) // è¾“å‡ºå‡ºé˜Ÿçš„å…ƒç´ \n        case &quot;quit&quot;, &quot;exit&quot;: //é€€å‡º\n            return\n        default:\n            fmt.Println(&quot;unknown action&quot;)\n        }\n    }\n}\n</code></pre><p>æˆ‘ä»¬å¯ä»¥æ‰“å¼€ä¸¤ä¸ªç»ˆç«¯ï¼Œåˆ†åˆ«æ‰§è¡Œè¿™ä¸ªç¨‹åºã€‚åœ¨ç¬¬ä¸€ä¸ªç»ˆç«¯ä¸­æ‰§è¡Œå…¥é˜Ÿæ“ä½œï¼Œåœ¨ç¬¬äºŒä¸ªç»ˆç«¯ä¸­æ‰§è¡Œå‡ºé˜Ÿæ“ä½œï¼Œå¹¶ä¸”è§‚å¯Ÿä¸€ä¸‹å‡ºé˜Ÿã€å…¥é˜Ÿæ˜¯å¦æ­£å¸¸ã€‚</p><p>é™¤äº†åˆšåˆšè¯´çš„åˆ†å¸ƒå¼é˜Ÿåˆ—ï¼Œetcdè¿˜æä¾›äº†ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼ˆPriorityQueueï¼‰ã€‚</p><p>å®ƒçš„ç”¨æ³•å’Œé˜Ÿåˆ—ç±»ä¼¼ï¼Œä¹Ÿæä¾›äº†å‡ºé˜Ÿå’Œå…¥é˜Ÿçš„æ“ä½œï¼Œåªä¸è¿‡ï¼Œåœ¨å…¥é˜Ÿçš„æ—¶å€™ï¼Œé™¤äº†éœ€è¦æŠŠä¸€ä¸ªå€¼åŠ å…¥åˆ°é˜Ÿåˆ—ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æä¾›uint16ç±»å‹çš„ä¸€ä¸ªæ•´æ•°ï¼Œä½œä¸ºæ­¤å€¼çš„ä¼˜å…ˆçº§ï¼Œä¼˜å…ˆçº§é«˜çš„å…ƒç´ ä¼šä¼˜å…ˆå‡ºé˜Ÿã€‚</p><p>ä¼˜å…ˆçº§é˜Ÿåˆ—çš„æµ‹è¯•ç¨‹åºå¦‚ä¸‹ï¼Œä½ å¯ä»¥åœ¨ä¸€ä¸ªèŠ‚ç‚¹è¾“å…¥ä¸€äº›ä¸åŒä¼˜å…ˆçº§çš„å…ƒç´ ï¼Œåœ¨å¦å¤–ä¸€ä¸ªèŠ‚ç‚¹è¯»å–å‡ºæ¥ï¼Œçœ‹çœ‹å®ƒä»¬æ˜¯ä¸æ˜¯æŒ‰ç…§ä¼˜å…ˆçº§é¡ºåºå¼¹å‡ºçš„ï¼š</p><pre><code>package main\n\n\nimport (\n    &quot;bufio&quot;\n    &quot;flag&quot;\n    &quot;fmt&quot;\n    &quot;log&quot;\n    &quot;os&quot;\n    &quot;strconv&quot;\n    &quot;strings&quot;\n\n\n    &quot;github.com/coreos/etcd/clientv3&quot;\n    recipe &quot;github.com/coreos/etcd/contrib/recipes&quot;\n)\n\n\nvar (\n    addr      = flag.String(&quot;addr&quot;, &quot;http://127.0.0.1:2379&quot;, &quot;etcd addresses&quot;)\n    queueName = flag.String(&quot;name&quot;, &quot;my-test-queue&quot;, &quot;queue name&quot;)\n)\n\n\nfunc main() {\n    flag.Parse()\n\n\n    // è§£æetcdåœ°å€\n    endpoints := strings.Split(*addr, &quot;,&quot;)\n\n\n    // åˆ›å»ºetcdçš„client\n    cli, err := clientv3.New(clientv3.Config{Endpoints: endpoints})\n    if err != nil {\n        log.Fatal(err)\n    }\n    defer cli.Close()\n\n\n    // åˆ›å»º/è·å–é˜Ÿåˆ—\n    q := recipe.NewPriorityQueue(cli, *queueName)\n\n\n    // ä»å‘½ä»¤è¡Œè¯»å–å‘½ä»¤\n    consolescanner := bufio.NewScanner(os.Stdin)\n    for consolescanner.Scan() {\n        action := consolescanner.Text()\n        items := strings.Split(action, &quot; &quot;)\n        switch items[0] {\n        case &quot;push&quot;: // åŠ å…¥é˜Ÿåˆ—\n            if len(items) != 3 {\n                fmt.Println(&quot;must set value and priority to push&quot;)\n                continue\n            }\n            pr, err := strconv.Atoi(items[2]) // è¯»å–ä¼˜å…ˆçº§\n            if err != nil {\n                fmt.Println(&quot;must set uint16 as priority&quot;)\n                continue\n            }\n            q.Enqueue(items[1], uint16(pr)) // å…¥é˜Ÿ\n        case &quot;pop&quot;: // ä»é˜Ÿåˆ—å¼¹å‡º\n            v, err := q.Dequeue() // å‡ºé˜Ÿ\n            if err != nil {\n                log.Fatal(err)\n            }\n            fmt.Println(v) // è¾“å‡ºå‡ºé˜Ÿçš„å…ƒç´ \n        case &quot;quit&quot;, &quot;exit&quot;: //é€€å‡º\n            return\n        default:\n            fmt.Println(&quot;unknown action&quot;)\n        }\n    }\n}\n</code></pre><p>ä½ çœ‹ï¼Œåˆ©ç”¨etcdå®ç°åˆ†å¸ƒå¼é˜Ÿåˆ—å’Œåˆ†å¸ƒå¼ä¼˜å…ˆé˜Ÿåˆ—ï¼Œå°±æ˜¯è¿™ä¹ˆç®€å•ã€‚æ‰€ä»¥ï¼Œåœ¨å®é™…é¡¹ç›®ä¸­ï¼Œå¦‚æœæœ‰è¿™ç±»éœ€æ±‚çš„è¯ï¼Œä½ å°±å¯ä»¥é€‰æ‹©ç”¨etcdå®ç°ã€‚</p><p>ä¸è¿‡ï¼Œåœ¨ä½¿ç”¨åˆ†å¸ƒå¼å¹¶å‘åŸè¯­æ—¶ï¼Œé™¤äº†éœ€è¦è€ƒè™‘å¯ç”¨æ€§å’Œæ•°æ®ä¸€è‡´æ€§ï¼Œè¿˜éœ€è¦è€ƒè™‘åˆ†å¸ƒå¼è®¾è®¡å¸¦æ¥çš„æ€§èƒ½æŸè€—é—®é¢˜ã€‚æ‰€ä»¥ï¼Œåœ¨ä½¿ç”¨ä¹‹å‰ï¼Œä½ ä¸€å®šè¦åšå¥½æ€§èƒ½çš„è¯„ä¼°ã€‚</p><h1>åˆ†å¸ƒå¼æ …æ </h1><p>åœ¨<a href=\"https://time.geekbang.org/column/article/309098\">ç¬¬17è®²</a>ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†å¾ªç¯æ …æ CyclicBarrierï¼Œå®ƒå’Œ<a href=\"https://time.geekbang.org/column/article/298516\">ç¬¬6è®²</a>çš„æ ‡å‡†åº“ä¸­çš„WaitGroupï¼Œæœ¬è´¨ä¸Šæ˜¯åŒä¸€ç±»å¹¶å‘åŸè¯­ï¼Œéƒ½æ˜¯ç­‰å¾…åŒä¸€ç»„goroutineåŒæ—¶æ‰§è¡Œï¼Œæˆ–è€…æ˜¯ç­‰å¾…åŒä¸€ç»„goroutineéƒ½å®Œæˆã€‚</p><p>åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬ä¹Ÿä¼šé‡åˆ°è¿™æ ·çš„åœºæ™¯ï¼šä¸€ç»„èŠ‚ç‚¹ååŒå·¥ä½œï¼Œå…±åŒç­‰å¾…ä¸€ä¸ªä¿¡å·ï¼Œåœ¨ä¿¡å·æœªå‡ºç°å‰ï¼Œè¿™äº›èŠ‚ç‚¹ä¼šè¢«é˜»å¡ä½ï¼Œè€Œä¸€æ—¦ä¿¡å·å‡ºç°ï¼Œè¿™äº›é˜»å¡çš„èŠ‚ç‚¹å°±ä¼šåŒæ—¶å¼€å§‹ç»§ç»­æ‰§è¡Œä¸‹ä¸€æ­¥çš„ä»»åŠ¡ã€‚</p><p>etcdä¹Ÿæä¾›äº†ç›¸åº”çš„åˆ†å¸ƒå¼å¹¶å‘åŸè¯­ã€‚</p><ul>\n<li><strong>Barrierï¼šåˆ†å¸ƒå¼æ …æ </strong>ã€‚å¦‚æœæŒæœ‰Barrierçš„èŠ‚ç‚¹é‡Šæ”¾äº†å®ƒï¼Œæ‰€æœ‰ç­‰å¾…è¿™ä¸ªBarrierçš„èŠ‚ç‚¹å°±ä¸ä¼šè¢«é˜»å¡ï¼Œè€Œæ˜¯ä¼šç»§ç»­æ‰§è¡Œã€‚</li>\n<li><strong>DoubleBarrierï¼šè®¡æ•°å‹æ …æ </strong>ã€‚åœ¨åˆå§‹åŒ–è®¡æ•°å‹æ …æ çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±å¿…é¡»æä¾›å‚ä¸èŠ‚ç‚¹çš„æ•°é‡ï¼Œå½“è¿™äº›æ•°é‡çš„èŠ‚ç‚¹éƒ½Enteræˆ–è€…Leaveçš„æ—¶å€™ï¼Œè¿™ä¸ªæ …æ å°±ä¼šæ”¾å¼€ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬æŠŠå®ƒç§°ä¸ºè®¡æ•°å‹æ …æ ã€‚</li>\n</ul><h2>Barrierï¼šåˆ†å¸ƒå¼æ …æ </h2><p>æˆ‘ä»¬å…ˆæ¥å­¦ä¹ ä¸‹åˆ†å¸ƒå¼Barrierã€‚</p><p>åˆ†å¸ƒå¼Barrierçš„åˆ›å»ºå¾ˆç®€å•ï¼Œä½ åªéœ€è¦æä¾›etcdçš„Clientå’ŒBarrierçš„åå­—å°±å¯ä»¥äº†ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>func NewBarrier(client *v3.Client, key string) *Barrier\n</code></pre><p>Barrieræä¾›äº†ä¸‰ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯Holdã€<strong>Releaseå’ŒWaitï¼Œ</strong>ä»£ç å¦‚ä¸‹ï¼š</p><pre><code>func (b *Barrier) Hold() error\nfunc (b *Barrier) Release() error\nfunc (b *Barrier) Wait() error\n</code></pre><ul>\n<li><strong>Holdæ–¹æ³•</strong>æ˜¯åˆ›å»ºä¸€ä¸ªBarrierã€‚å¦‚æœBarrierå·²ç»åˆ›å»ºå¥½äº†ï¼Œæœ‰èŠ‚ç‚¹è°ƒç”¨å®ƒçš„Waitæ–¹æ³•ï¼Œå°±ä¼šè¢«é˜»å¡ã€‚</li>\n<li><strong>Releaseæ–¹æ³•</strong>æ˜¯é‡Šæ”¾è¿™ä¸ªBarrierï¼Œä¹Ÿå°±æ˜¯æ‰“å¼€æ …æ ã€‚å¦‚æœä½¿ç”¨äº†è¿™ä¸ªæ–¹æ³•ï¼Œæ‰€æœ‰è¢«é˜»å¡çš„èŠ‚ç‚¹éƒ½ä¼šè¢«æ”¾è¡Œï¼Œç»§ç»­æ‰§è¡Œã€‚</li>\n<li><strong>Waitæ–¹æ³•</strong>ä¼šé˜»å¡å½“å‰çš„è°ƒç”¨è€…ï¼Œç›´åˆ°è¿™ä¸ªBarrierè¢«releaseã€‚å¦‚æœè¿™ä¸ªæ …æ ä¸å­˜åœ¨ï¼Œè°ƒç”¨è€…ä¸ä¼šè¢«é˜»å¡ï¼Œè€Œæ˜¯ä¼šç»§ç»­æ‰§è¡Œã€‚</li>\n</ul><p><strong>å­¦ä¹ å¹¶å‘åŸè¯­æœ€å¥½çš„æ–¹å¼å°±æ˜¯ä½¿ç”¨å®ƒ</strong>ã€‚ä¸‹é¢æˆ‘ä»¬å°±æ¥å€ŸåŠ©ä¸€ä¸ªä¾‹å­ï¼Œæ¥çœ‹çœ‹Barrierè¯¥æ€ä¹ˆç”¨ã€‚</p><p>ä½ å¯ä»¥åœ¨ä¸€ä¸ªç»ˆç«¯ä¸­è¿è¡Œè¿™ä¸ªç¨‹åºï¼Œæ‰§è¡Œ\"hold\"\"release\"å‘½ä»¤ï¼Œæ¨¡æ‹Ÿæ …æ çš„æŒæœ‰å’Œé‡Šæ”¾ã€‚åœ¨å¦å¤–ä¸€ä¸ªç»ˆç«¯ä¸­è¿è¡Œè¿™ä¸ªç¨‹åºï¼Œä¸æ–­è°ƒç”¨\"wait\"æ–¹æ³•ï¼Œçœ‹çœ‹æ˜¯å¦èƒ½æ­£å¸¸åœ°è·³å‡ºé˜»å¡ç»§ç»­æ‰§è¡Œï¼š</p><pre><code>package main\n\n\nimport (\n    &quot;bufio&quot;\n    &quot;flag&quot;\n    &quot;fmt&quot;\n    &quot;log&quot;\n    &quot;os&quot;\n    &quot;strings&quot;\n\n\n    &quot;github.com/coreos/etcd/clientv3&quot;\n    recipe &quot;github.com/coreos/etcd/contrib/recipes&quot;\n)\n\n\nvar (\n    addr        = flag.String(&quot;addr&quot;, &quot;http://127.0.0.1:2379&quot;, &quot;etcd addresses&quot;)\n    barrierName = flag.String(&quot;name&quot;, &quot;my-test-queue&quot;, &quot;barrier name&quot;)\n)\n\n\nfunc main() {\n    flag.Parse()\n\n\n    // è§£æetcdåœ°å€\n    endpoints := strings.Split(*addr, &quot;,&quot;)\n\n\n    // åˆ›å»ºetcdçš„client\n    cli, err := clientv3.New(clientv3.Config{Endpoints: endpoints})\n    if err != nil {\n        log.Fatal(err)\n    }\n    defer cli.Close()\n\n\n    // åˆ›å»º/è·å–æ …æ \n    b := recipe.NewBarrier(cli, *barrierName)\n\n\n    // ä»å‘½ä»¤è¡Œè¯»å–å‘½ä»¤\n    consolescanner := bufio.NewScanner(os.Stdin)\n    for consolescanner.Scan() {\n        action := consolescanner.Text()\n        items := strings.Split(action, &quot; &quot;)\n        switch items[0] {\n        case &quot;hold&quot;: // æŒæœ‰è¿™ä¸ªbarrier\n            b.Hold()\n            fmt.Println(&quot;hold&quot;)\n        case &quot;release&quot;: // é‡Šæ”¾è¿™ä¸ªbarrier\n            b.Release()\n            fmt.Println(&quot;released&quot;)\n        case &quot;wait&quot;: // ç­‰å¾…barrierè¢«é‡Šæ”¾\n            b.Wait()\n            fmt.Println(&quot;after wait&quot;)\n        case &quot;quit&quot;, &quot;exit&quot;: //é€€å‡º\n            return\n        default:\n            fmt.Println(&quot;unknown action&quot;)\n        }\n    }\n}\n</code></pre><h2>DoubleBarrierï¼šè®¡æ•°å‹æ …æ </h2><p>etcdè¿˜æä¾›äº†å¦å¤–ä¸€ç§æ …æ ï¼Œå«åšDoubleBarrierï¼Œè¿™ä¹Ÿæ˜¯ä¸€ç§éå¸¸æœ‰ç”¨çš„æ …æ ã€‚è¿™ä¸ªæ …æ åˆå§‹åŒ–çš„æ—¶å€™éœ€è¦æä¾›ä¸€ä¸ªè®¡æ•°countï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>func NewDoubleBarrier(s *concurrency.Session, key string, count int) *DoubleBarrier\n</code></pre><p>åŒæ—¶ï¼Œå®ƒè¿˜æä¾›äº†ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯Enterå’ŒLeaveï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre><code>func (b *DoubleBarrier) Enter() error\nfunc (b *DoubleBarrier) Leave() error\n</code></pre><p>æˆ‘æ¥è§£é‡Šä¸‹è¿™ä¸¤ä¸ªæ–¹æ³•çš„ä½œç”¨ã€‚</p><p>å½“è°ƒç”¨è€…è°ƒç”¨Enteræ—¶ï¼Œä¼šè¢«é˜»å¡ä½ï¼Œç›´åˆ°ä¸€å…±æœ‰countï¼ˆåˆå§‹åŒ–è¿™ä¸ªæ …æ çš„æ—¶å€™è®¾å®šçš„å€¼ï¼‰ä¸ªèŠ‚ç‚¹è°ƒç”¨äº†Enterï¼Œè¿™countä¸ªè¢«é˜»å¡çš„èŠ‚ç‚¹æ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚æ‰€ä»¥ï¼Œä½ å¯ä»¥åˆ©ç”¨å®ƒç¼–æ’ä¸€ç»„èŠ‚ç‚¹ï¼Œè®©è¿™äº›èŠ‚ç‚¹åœ¨åŒä¸€ä¸ªæ—¶åˆ»å¼€å§‹æ‰§è¡Œä»»åŠ¡ã€‚</p><p>åŒç†ï¼Œå¦‚æœä½ æƒ³è®©ä¸€ç»„èŠ‚ç‚¹åœ¨åŒä¸€ä¸ªæ—¶åˆ»å®Œæˆä»»åŠ¡ï¼Œå°±å¯ä»¥è°ƒç”¨Leaveæ–¹æ³•ã€‚èŠ‚ç‚¹è°ƒç”¨Leaveæ–¹æ³•çš„æ—¶å€™ï¼Œä¼šè¢«é˜»å¡ï¼Œç›´åˆ°æœ‰countä¸ªèŠ‚ç‚¹ï¼Œéƒ½è°ƒç”¨äº†Leaveæ–¹æ³•ï¼Œè¿™äº›èŠ‚ç‚¹æ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚</p><p>æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹DoubleBarrierçš„ä½¿ç”¨ä¾‹å­ã€‚ä½ å¯ä»¥èµ·ä¸¤ä¸ªèŠ‚ç‚¹ï¼ŒåŒæ—¶æ‰§è¡ŒEnteræ–¹æ³•ï¼Œçœ‹çœ‹è¿™ä¸¤ä¸ªèŠ‚ç‚¹æ˜¯ä¸æ˜¯å…ˆé˜»å¡ï¼Œä¹‹åæ‰ç»§ç»­æ‰§è¡Œã€‚ç„¶åï¼Œä½ å†æ‰§è¡ŒLeaveæ–¹æ³•ï¼Œä¹Ÿè§‚å¯Ÿä¸€ä¸‹ï¼Œæ˜¯ä¸æ˜¯å…ˆé˜»å¡åˆç»§ç»­æ‰§è¡Œçš„ã€‚</p><pre><code>package main\n\n\nimport (\n    &quot;bufio&quot;\n    &quot;flag&quot;\n    &quot;fmt&quot;\n    &quot;log&quot;\n    &quot;os&quot;\n    &quot;strings&quot;\n\n\n    &quot;github.com/coreos/etcd/clientv3&quot;\n    &quot;github.com/coreos/etcd/clientv3/concurrency&quot;\n    recipe &quot;github.com/coreos/etcd/contrib/recipes&quot;\n)\n\n\nvar (\n    addr        = flag.String(&quot;addr&quot;, &quot;http://127.0.0.1:2379&quot;, &quot;etcd addresses&quot;)\n    barrierName = flag.String(&quot;name&quot;, &quot;my-test-doublebarrier&quot;, &quot;barrier name&quot;)\n    count       = flag.Int(&quot;c&quot;, 2, &quot;&quot;)\n)\n\n\nfunc main() {\n    flag.Parse()\n\n\n    // è§£æetcdåœ°å€\n    endpoints := strings.Split(*addr, &quot;,&quot;)\n\n\n    // åˆ›å»ºetcdçš„client\n    cli, err := clientv3.New(clientv3.Config{Endpoints: endpoints})\n    if err != nil {\n        log.Fatal(err)\n    }\n    defer cli.Close()\n    // åˆ›å»ºsession\n    s1, err := concurrency.NewSession(cli)\n    if err != nil {\n        log.Fatal(err)\n    }\n    defer s1.Close()\n\n\n    // åˆ›å»º/è·å–æ …æ \n    b := recipe.NewDoubleBarrier(s1, *barrierName, *count)\n\n\n    // ä»å‘½ä»¤è¡Œè¯»å–å‘½ä»¤\n    consolescanner := bufio.NewScanner(os.Stdin)\n    for consolescanner.Scan() {\n        action := consolescanner.Text()\n        items := strings.Split(action, &quot; &quot;)\n        switch items[0] {\n        case &quot;enter&quot;: // æŒæœ‰è¿™ä¸ªbarrier\n            b.Enter()\n            fmt.Println(&quot;enter&quot;)\n        case &quot;leave&quot;: // é‡Šæ”¾è¿™ä¸ªbarrier\n            b.Leave()\n            fmt.Println(&quot;leave&quot;)\n        case &quot;quit&quot;, &quot;exit&quot;: //é€€å‡º\n            return\n        default:\n            fmt.Println(&quot;unknown action&quot;)\n        }\n    }\n}\n</code></pre><p>å¥½äº†ï¼Œæˆ‘ä»¬å…ˆæ¥ç®€å•æ€»ç»“ä¸€ä¸‹ã€‚æˆ‘ä»¬åœ¨ç¬¬17è®²å­¦ä¹ çš„å¾ªç¯æ …æ ï¼Œæ§åˆ¶çš„æ˜¯åŒä¸€ä¸ªè¿›ç¨‹ä¸­çš„ä¸åŒgoroutineçš„æ‰§è¡Œï¼Œè€Œ<strong>åˆ†å¸ƒå¼æ …æ å’Œè®¡æ•°å‹æ …æ æ§åˆ¶çš„æ˜¯ä¸åŒèŠ‚ç‚¹ã€ä¸åŒè¿›ç¨‹çš„æ‰§è¡Œ</strong>ã€‚å½“ä½ éœ€è¦åè°ƒä¸€ç»„åˆ†å¸ƒå¼èŠ‚ç‚¹åœ¨æŸä¸ªæ—¶é—´ç‚¹åŒæ—¶è¿è¡Œçš„æ—¶å€™ï¼Œå¯ä»¥è€ƒè™‘etcdæä¾›çš„è¿™ç»„å¹¶å‘åŸè¯­ã€‚</p><h1>STM</h1><p>æåˆ°äº‹åŠ¡ï¼Œä½ è‚¯å®šä¸é™Œç”Ÿã€‚åœ¨å¼€å‘åŸºäºæ•°æ®åº“çš„åº”ç”¨ç¨‹åºçš„æ—¶å€™ï¼Œæˆ‘ä»¬ç»å¸¸ç”¨åˆ°äº‹åŠ¡ã€‚äº‹åŠ¡å°±æ˜¯è¦ä¿è¯ä¸€ç»„æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚</p><p>åœ¨å­¦ä¹ STMä¹‹å‰ï¼Œæˆ‘ä»¬è¦å…ˆäº†è§£ä¸€ä¸‹etcdçš„äº‹åŠ¡ä»¥åŠå®ƒçš„é—®é¢˜ã€‚</p><p>etcdæä¾›äº†åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­å¯¹å¤šä¸ªkeyçš„æ›´æ–°åŠŸèƒ½ï¼Œè¿™ä¸€ç»„keyçš„æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚etcdçš„äº‹åŠ¡å®ç°æ–¹å¼æ˜¯åŸºäºCASæ–¹å¼å®ç°çš„ï¼Œèåˆäº†Getã€Putå’ŒDeleteæ“ä½œã€‚</p><p>etcdçš„äº‹åŠ¡æ“ä½œå¦‚ä¸‹ï¼Œåˆ†ä¸ºæ¡ä»¶å—ã€æˆåŠŸå—å’Œå¤±è´¥å—ï¼Œæ¡ä»¶å—ç”¨æ¥æ£€æµ‹äº‹åŠ¡æ˜¯å¦æˆåŠŸï¼Œå¦‚æœæˆåŠŸï¼Œå°±æ‰§è¡ŒThen(...)ï¼Œå¦‚æœå¤±è´¥ï¼Œå°±æ‰§è¡ŒElse(...)ï¼š</p><pre><code>Txn().If(cond1, cond2, ...).Then(op1, op2, ...,).Else(op1â€™, op2â€™, â€¦)\n</code></pre><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªåˆ©ç”¨etcdçš„äº‹åŠ¡å®ç°è½¬è´¦çš„å°ä¾‹å­ã€‚æˆ‘ä»¬ä»è´¦æˆ·from å‘è´¦æˆ·toè½¬è´¦ amountï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre><code>func doTxnXfer(etcd *v3.Client, from, to string, amount uint) (bool, error) {\n    // ä¸€ä¸ªæŸ¥è¯¢äº‹åŠ¡\n    getresp, err := etcd.Txn(ctx.TODO()).Then(OpGet(from), OpGet(to)).Commit()\n    if err != nil {\n         return false, err\n    }\n    // è·å–è½¬è´¦è´¦æˆ·çš„å€¼\n    fromKV := getresp.Responses[0].GetRangeResponse().Kvs[0]\n    toKV := getresp.Responses[1].GetRangeResponse().Kvs[1]\n    fromV, toV := toUInt64(fromKV.Value), toUint64(toKV.Value)\n    if fromV &lt; amount {\n        return false, fmt.Errorf(â€œinsufficient valueâ€)\n    }\n    // è½¬è´¦äº‹åŠ¡\n    // æ¡ä»¶å—\n    txn := etcd.Txn(ctx.TODO()).If(\n        v3.Compare(v3.ModRevision(from), â€œ=â€, fromKV.ModRevision),\n        v3.Compare(v3.ModRevision(to), â€œ=â€, toKV.ModRevision))\n    // æˆåŠŸå—\n    txn = txn.Then(\n        OpPut(from, fromUint64(fromV - amount)),\n        OpPut(to, fromUint64(toV + amount))\n    //æäº¤äº‹åŠ¡ \n    putresp, err := txn.Commit()\n    // æ£€æŸ¥äº‹åŠ¡çš„æ‰§è¡Œç»“æœ\n    if err != nil {\n        return false, err\n    }\n    return putresp.Succeeded, nil\n}\n</code></pre><p>ä»åˆšåˆšçš„è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè™½ç„¶å¯ä»¥åˆ©ç”¨etcdå®ç°äº‹åŠ¡æ“ä½œï¼Œä½†æ˜¯é€»è¾‘è¿˜æ˜¯æ¯”è¾ƒå¤æ‚çš„ã€‚</p><p>å› ä¸ºäº‹åŠ¡ä½¿ç”¨èµ·æ¥éå¸¸éº»çƒ¦ï¼Œæ‰€ä»¥etcdåˆåœ¨è¿™äº›åŸºç¡€APIä¸Šè¿›è¡Œäº†å°è£…ï¼Œæ–°å¢äº†ä¸€ç§å«åšSTMçš„æ“ä½œï¼Œæä¾›äº†æ›´åŠ ä¾¿åˆ©çš„æ–¹æ³•ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€çœ‹STMæ€ä¹ˆç”¨ã€‚</p><p>è¦ä½¿ç”¨STMï¼Œä½ éœ€è¦å…ˆç¼–å†™ä¸€ä¸ªapplyå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°çš„æ‰§è¡Œæ˜¯åœ¨ä¸€ä¸ªäº‹åŠ¡ä¹‹ä¸­çš„ï¼š</p><pre><code>apply func(STM) error\n</code></pre><p>è¿™ä¸ªæ–¹æ³•åŒ…å«ä¸€ä¸ªSTMç±»å‹çš„å‚æ•°ï¼Œå®ƒæä¾›äº†å¯¹keyå€¼çš„è¯»å†™æ“ä½œã€‚</p><p>STMæä¾›äº†4ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯Getã€Putã€Receiveå’ŒDeleteï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre><code>type STM interface {\n\tGet(key ...string) string\n\tPut(key, val string, opts ...v3.OpOption)\n\tRev(key string) int64\n\tDel(key string)\n}\n</code></pre><p>ä½¿ç”¨etcd STMçš„æ—¶å€™ï¼Œæˆ‘ä»¬åªéœ€è¦å®šä¹‰ä¸€ä¸ªapplyæ–¹æ³•ï¼Œæ¯”å¦‚è¯´è½¬è´¦æ–¹æ³•exchangeï¼Œç„¶åé€šè¿‡concurrency.NewSTM(cli, exchange)ï¼Œå°±å¯ä»¥å®Œæˆè½¬è´¦äº‹åŠ¡çš„æ‰§è¡Œäº†ã€‚</p><p>STMå’‹ç”¨å‘¢ï¼Ÿæˆ‘ä»¬è¿˜æ˜¯å€ŸåŠ©ä¸€ä¸ªä¾‹å­æ¥å­¦ä¹ ä¸‹ã€‚</p><p>ä¸‹é¢è¿™ä¸ªä¾‹å­åˆ›å»ºäº†5ä¸ªé“¶è¡Œè´¦å·ï¼Œç„¶åéšæœºé€‰æ‹©ä¸€äº›è´¦å·ä¸¤ä¸¤è½¬è´¦ã€‚åœ¨è½¬è´¦çš„æ—¶å€™ï¼Œè¦æŠŠæºè´¦å·ä¸€åŠçš„é’±è¦è½¬ç»™ç›®æ ‡è´¦å·ã€‚è¿™ä¸ªä¾‹å­å¯åŠ¨äº†10ä¸ªgoroutineå»æ‰§è¡Œè¿™äº›äº‹åŠ¡ï¼Œæ¯ä¸ªgoroutineè¦å®Œæˆ100ä¸ªäº‹åŠ¡ã€‚</p><p>ä¸ºäº†ç¡®è®¤äº‹åŠ¡æ˜¯å¦å‡ºé”™äº†ï¼Œæˆ‘ä»¬æœ€åè¦æ ¡éªŒæ¯ä¸ªè´¦å·çš„é’±æ•°å’Œæ€»é’±æ•°ã€‚æ€»é’±æ•°ä¸å˜ï¼Œå°±ä»£è¡¨æ‰§è¡ŒæˆåŠŸäº†ã€‚è¿™ä¸ªä¾‹å­çš„ä»£ç å¦‚ä¸‹ï¼š</p><pre><code>package main\n\n\nimport (\n    &quot;context&quot;\n    &quot;flag&quot;\n    &quot;fmt&quot;\n    &quot;log&quot;\n    &quot;math/rand&quot;\n    &quot;strings&quot;\n    &quot;sync&quot;\n\n\n    &quot;github.com/coreos/etcd/clientv3&quot;\n    &quot;github.com/coreos/etcd/clientv3/concurrency&quot;\n)\n\n\nvar (\n    addr = flag.String(&quot;addr&quot;, &quot;http://127.0.0.1:2379&quot;, &quot;etcd addresses&quot;)\n)\n\n\nfunc main() {\n    flag.Parse()\n\n\n    // è§£æetcdåœ°å€\n    endpoints := strings.Split(*addr, &quot;,&quot;)\n\n\n    cli, err := clientv3.New(clientv3.Config{Endpoints: endpoints})\n    if err != nil {\n        log.Fatal(err)\n    }\n    defer cli.Close()\n\n\n    // è®¾ç½®5ä¸ªè´¦æˆ·ï¼Œæ¯ä¸ªè´¦å·éƒ½æœ‰100å…ƒï¼Œæ€»å…±500å…ƒ\n    totalAccounts := 5\n    for i := 0; i &lt; totalAccounts; i++ {\n        k := fmt.Sprintf(&quot;accts/%d&quot;, i)\n        if _, err = cli.Put(context.TODO(), k, &quot;100&quot;); err != nil {\n            log.Fatal(err)\n        }\n    }\n\n\n    // STMçš„åº”ç”¨å‡½æ•°ï¼Œä¸»è¦çš„äº‹åŠ¡é€»è¾‘\n    exchange := func(stm concurrency.STM) error {\n        // éšæœºå¾—åˆ°ä¸¤ä¸ªè½¬è´¦è´¦å·\n        from, to := rand.Intn(totalAccounts), rand.Intn(totalAccounts)\n        if from == to {\n            // è‡ªå·±ä¸å’Œè‡ªå·±è½¬è´¦\n            return nil\n        }\n        // è¯»å–è´¦å·çš„å€¼\n        fromK, toK := fmt.Sprintf(&quot;accts/%d&quot;, from), fmt.Sprintf(&quot;accts/%d&quot;, to)\n        fromV, toV := stm.Get(fromK), stm.Get(toK)\n        fromInt, toInt := 0, 0\n        fmt.Sscanf(fromV, &quot;%d&quot;, &amp;fromInt)\n        fmt.Sscanf(toV, &quot;%d&quot;, &amp;toInt)\n\n\n        // æŠŠæºè´¦å·ä¸€åŠçš„é’±è½¬è´¦ç»™ç›®æ ‡è´¦å·\n        xfer := fromInt / 2\n        fromInt, toInt = fromInt-xfer, toInt+xfer\n\n\n        // æŠŠè½¬è´¦åçš„å€¼å†™å›\n        stm.Put(fromK, fmt.Sprintf(&quot;%d&quot;, fromInt))\n        stm.Put(toK, fmt.Sprintf(&quot;%d&quot;, toInt))\n        return nil\n    }\n\n\n    // å¯åŠ¨10ä¸ªgoroutineè¿›è¡Œè½¬è´¦æ“ä½œ\n    var wg sync.WaitGroup\n    wg.Add(10)\n    for i := 0; i &lt; 10; i++ {\n        go func() {\n            defer wg.Done()\n            for j := 0; j &lt; 100; j++ {\n                if _, serr := concurrency.NewSTM(cli, exchange); serr != nil {\n                    log.Fatal(serr)\n                }\n            }\n        }()\n    }\n    wg.Wait()\n\n\n    // æ£€æŸ¥è´¦å·æœ€åçš„æ•°ç›®\n    sum := 0\n    accts, err := cli.Get(context.TODO(), &quot;accts/&quot;, clientv3.WithPrefix()) // å¾—åˆ°æ‰€æœ‰è´¦å·\n    if err != nil {\n        log.Fatal(err)\n    }\n    for _, kv := range accts.Kvs { // éå†è´¦å·çš„å€¼\n        v := 0\n        fmt.Sscanf(string(kv.Value), &quot;%d&quot;, &amp;v)\n        sum += v\n        log.Printf(&quot;account %s: %d&quot;, kv.Key, v)\n    }\n\n\n    log.Println(&quot;account sum is&quot;, sum) // æ€»æ•°\n}\n</code></pre><p>æ€»ç»“ä¸€ä¸‹ï¼Œå½“ä½ åˆ©ç”¨etcdåšå­˜å‚¨æ—¶ï¼Œæ˜¯å¯ä»¥åˆ©ç”¨STMå®ç°äº‹åŠ¡æ“ä½œçš„ï¼Œä¸€ä¸ªäº‹åŠ¡å¯ä»¥åŒ…å«å¤šä¸ªè´¦å·çš„æ•°æ®æ›´æ”¹æ“ä½œï¼Œäº‹åŠ¡èƒ½å¤Ÿä¿è¯è¿™äº›æ›´æ”¹è¦ä¹ˆå…¨æˆåŠŸï¼Œè¦ä¹ˆå…¨å¤±è´¥ã€‚</p><h1>æ€»ç»“</h1><p>å¦‚æœæˆ‘ä»¬æŠŠçœ¼å…‰æ”¾å¾—æ›´å®½å¹¿ä¸€äº›ï¼Œå…¶å®å¹¶ä¸åªæ˜¯etcdæä¾›äº†è¿™äº›å¹¶å‘åŸè¯­ï¼Œæ¯”å¦‚æˆ‘ä¸ŠèŠ‚è¯¾ä¸€å¼€å§‹å°±æåˆ°äº†ï¼ŒZookeeperå¾ˆæ—©ä¹Ÿæä¾›äº†ç±»ä¼¼çš„å¹¶å‘åŸè¯­ï¼Œåªä¸è¿‡åªæä¾›äº†Javaçš„åº“ï¼Œå¹¶æ²¡æœ‰æä¾›åˆé€‚çš„Goåº“ã€‚å¦å¤–ï¼Œæ ¹æ®Consulå®˜æ–¹çš„åé¦ˆï¼Œä»–ä»¬å¹¶æ²¡æœ‰å¼€å‘è¿™äº›å¹¶å‘åŸè¯­çš„è®¡åˆ’ï¼Œæ‰€ä»¥ï¼Œä»ç›®å‰æ¥çœ‹ï¼Œetcdæ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ã€‚</p><p>å½“ç„¶ï¼Œä¹Ÿæœ‰ä¸€äº›å…¶å®ƒä¸å¤ªçŸ¥åçš„åˆ†å¸ƒå¼åŸè¯­åº“ï¼Œä½†æ˜¯æ´»è·ƒåº¦ä¸é«˜ï¼Œå¯ç”¨æ€§ä½ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿä¸éœ€è¦å»äº†è§£äº†ã€‚</p><p>å…¶å®ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨Rediså®ç°åˆ†å¸ƒå¼é”ï¼Œæˆ–è€…æ˜¯åŸºäºMySQLå®ç°åˆ†å¸ƒå¼é”ï¼Œè¿™ä¹Ÿæ˜¯å¸¸ç”¨çš„é€‰æ‹©ã€‚å¯¹äºå¤§å‚æ¥è¯´ï¼Œé€‰æ‹©èµ·æ¥æ˜¯éå¸¸ç®€å•çš„ï¼Œåªéœ€è¦çœ‹çœ‹å‚å†…æä¾›äº†å“ªä¸ªåŸºç¡€æœåŠ¡ï¼Œå“ªä¸ªæ›´ç¨³å®šäº›ã€‚å¯¹äºæ²¡æœ‰etcdã€Redisè¿™äº›åŸºç¡€æœåŠ¡çš„å…¬å¸æ¥è¯´ï¼Œå¾ˆé‡è¦çš„ä¸€ç‚¹ï¼Œå°±æ˜¯è‡ªå·±æ­å»ºä¸€å¥—è¿™æ ·çš„åŸºç¡€æœåŠ¡ï¼Œå¹¶ä¸”è¿ç»´å¥½ï¼Œè¿™å°±éœ€è¦è€ƒå¯Ÿä½ ä»¬å¯¹etcdã€Redisã€MySQLçš„æŠ€æœ¯æŠŠæ§èƒ½åŠ›äº†ï¼Œå“ªä¸ªç”¨å¾—æ›´é¡ºæ‰‹ï¼Œå°±ç”¨å“ªä¸ªã€‚</p><p>ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä¸å»ºè®®ä½ è‡ªå·±å»å®ç°åˆ†å¸ƒå¼åŸè¯­ï¼Œæœ€å¥½æ˜¯ç›´æ¥ä½¿ç”¨etcdã€Redisè¿™äº›æˆç†Ÿçš„è½¯ä»¶æä¾›çš„åŠŸèƒ½ï¼Œè¿™ä¹Ÿæ„å‘³ç€ï¼Œæˆ‘ä»¬å°†ç¨‹åºçš„é£é™©è½¬å«åˆ°äº†è¿™äº›åŸºç¡€æœåŠ¡ä¸Šï¼Œè¿™äº›åŸºç¡€æœåŠ¡å¿…é¡»è¦èƒ½å¤Ÿæä¾›è¶³å¤Ÿçš„æœåŠ¡ä¿éšœã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/c0/1d/c0d48fd09b91685c836829570fdc7b1d.jpg?wh=2250*1452\" alt=\"\"></p><h1>æ€è€ƒé¢˜</h1><ol>\n<li>éƒ¨ç½²ä¸€ä¸ª3èŠ‚ç‚¹çš„etcdé›†ç¾¤ï¼Œæµ‹è¯•ä¸€ä¸‹åˆ†å¸ƒå¼é˜Ÿåˆ—çš„æ€§èƒ½ã€‚</li>\n<li>etcdæä¾›çš„STMæ˜¯åˆ†å¸ƒå¼äº‹åŠ¡å—ï¼Ÿ</li>\n</ol><p>æ¬¢è¿åœ¨ç•™è¨€åŒºå†™ä¸‹ä½ çš„æ€è€ƒå’Œç­”æ¡ˆï¼Œæˆ‘ä»¬ä¸€èµ·äº¤æµè®¨è®ºã€‚å¦‚æœä½ è§‰å¾—æœ‰æ‰€æ”¶è·ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹æˆ–åŒäº‹ã€‚</p>","neighbors":{"left":{"article_title":"19 |  åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼ŒLeaderé€‰ä¸¾ã€äº’æ–¥é”å’Œè¯»å†™é”è¯¥å¦‚ä½•å®ç°ï¼Ÿ","id":310887},"right":{"article_title":"ç»“æŸè¯­ | å†èŠGoå¹¶å‘ç¼–ç¨‹çš„ä»·å€¼å’Œç²¾è¿›ä¹‹è·¯","id":313080}},"comments":[{"had_liked":false,"id":284117,"user_name":"answerå®«","can_delete":false,"product_type":"c1","uid":1114020,"ip_address":"","ucode":"54CA51DE2BE829","user_header":"https://static001.geekbang.org/account/avatar/00/10/ff/a4/55520286.jpg","comment_is_top":false,"comment_ctime":1616069107,"is_pvip":false,"replies":[{"id":"103181","content":"ğŸ‘ğŸ»ğŸ‘ğŸ»ğŸ‘ğŸ»","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1616301804,"ip_address":"","comment_id":284117,"utype":1}],"discussion_count":1,"race_medal":0,"score":"23090905587","product_id":100061801,"comment_content":"æ‰“å¡,åšæŒçœ‹å®Œäº†,æ…¢æ…¢å¸æ”¶!","like_count":6,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":517242,"discussion_content":"ğŸ‘ğŸ»ğŸ‘ğŸ»ğŸ‘ğŸ»","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1616301804,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":263794,"user_name":"myrfy","can_delete":false,"product_type":"c1","uid":1169401,"ip_address":"","ucode":"2814BAE5D70098","user_header":"","comment_is_top":false,"comment_ctime":1606268663,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"18786137847","product_id":100061801,"comment_content":"æ„Ÿè§‰æ˜¯åŒ…è£…äº†ä¸€å±‚æœ€åŸºç¡€çš„ä¹è§‚é”ï¼Œç¦»åˆ†å¸ƒå¼äº‹åŠ¡åº”è¯¥è¿˜å·®ä¸å°‘å§","like_count":4},{"had_liked":false,"id":338689,"user_name":"æ— åæ°","can_delete":false,"product_type":"c1","uid":1256121,"ip_address":"","ucode":"584E697AE276AB","user_header":"https://static001.geekbang.org/account/avatar/00/13/2a/b9/2bf8cc89.jpg","comment_is_top":false,"comment_ctime":1647663445,"is_pvip":false,"replies":[{"id":"124054","content":"etcd stmæ”¯æŒå››ç§éš”ç¦»çº§åˆ«ï¼Œåœ¨åˆ›å»ºstmå¯ä»¥æŒ‡å®š","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1066613","ctime":1648047297,"ip_address":"","comment_id":338689,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5942630741","product_id":100061801,"comment_content":"æƒ³è¯·æ•™ä¸‹è€å¸ˆè¿™ä¸ªSTMäº‹åŠ¡èƒ½è¾¾åˆ°ä»€ä¹ˆéš”ç¦»çº§åˆ«ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":558027,"discussion_content":"etcd stmæ”¯æŒå››ç§éš”ç¦»çº§åˆ«ï¼Œåœ¨åˆ›å»ºstmå¯ä»¥æŒ‡å®š","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1648047297,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":289088,"user_name":"jack","can_delete":false,"product_type":"c1","uid":1352726,"ip_address":"","ucode":"5260F7D2219542","user_header":"https://static001.geekbang.org/account/avatar/00/14/a4/16/6463e374.jpg","comment_is_top":false,"comment_ctime":1618849636,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5913816932","product_id":100061801,"comment_content":"ç»ˆäºçœ‹å®Œäº†ï¼Œæ„Ÿè§‰è¿˜å¾—å†çœ‹å‡ é æ¶ˆåŒ–æ¶ˆåŒ–ã€‚","like_count":1},{"had_liked":false,"id":267277,"user_name":"Kepler","can_delete":false,"product_type":"c1","uid":1214303,"ip_address":"","ucode":"0C9CA3DB8B3CF0","user_header":"https://static001.geekbang.org/account/avatar/00/12/87/5f/6bf8b74a.jpg","comment_is_top":false,"comment_ctime":1607667153,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"5902634449","product_id":100061801,"comment_content":"ç®—åˆ†å¸ƒå¼äº‹åŠ¡å§ï¼Œæ¯•ç«Ÿæ“ä½œçš„æ•°æ®å¯èƒ½æ¥è‡ªä¸åŒetcd èŠ‚ç‚¹","like_count":1},{"had_liked":false,"id":349678,"user_name":"DayDayUp","can_delete":false,"product_type":"c1","uid":1610552,"ip_address":"","ucode":"9C53659518AB74","user_header":"https://static001.geekbang.org/account/avatar/00/18/93/38/71615300.jpg","comment_is_top":false,"comment_ctime":1656221145,"is_pvip":false,"replies":[{"id":"127419","content":"å¤ªæ£’äº†ï¼Œèµä¸€ä¸ªğŸ‘ğŸ»","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1066613","ctime":1656681663,"ip_address":"","comment_id":349678,"utype":1}],"discussion_count":1,"race_medal":1,"score":"1656221145","product_id":100061801,"comment_content":"åœ¨åœ°é“ä¸Šæ‰“å¡ï¼Œæ„ŸåŠ¨ä¸€ä¸‹è‡ªå·±ğŸ˜‚","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":578375,"discussion_content":"å¤ªæ£’äº†ï¼Œèµä¸€ä¸ªğŸ‘ğŸ»","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1656681663,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":319006,"user_name":"Jamey","can_delete":false,"product_type":"c1","uid":2344373,"ip_address":"","ucode":"449E4F65339CDE","user_header":"https://static001.geekbang.org/account/avatar/00/23/c5/b5/25179772.jpg","comment_is_top":false,"comment_ctime":1635502339,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1635502339","product_id":100061801,"comment_content":"æŠ¥äº†è¿™èŠ‚è¯¾çœŸæ˜¯æ”¶è·æ»¡æ»¡ï¼Œè™½ç„¶åªæœ‰20å‡ èŠ‚ï¼Œä½†æ˜¯èŠ‚èŠ‚å¹²è´§ï¼Œæ„Ÿè§‰è‡ªå·±å¯¹å¹¶å‘çš„è®¤çŸ¥åˆæé«˜äº†ã€‚","like_count":0},{"had_liked":false,"id":318280,"user_name":"gitxuzan","can_delete":false,"product_type":"c1","uid":1081566,"ip_address":"","ucode":"B0E20F892DA716","user_header":"https://static001.geekbang.org/account/avatar/00/10/80/de/c6191045.jpg","comment_is_top":false,"comment_ctime":1635229323,"is_pvip":false,"replies":[{"id":"115728","content":"ğŸ‘ğŸ»ğŸ‘ğŸ»ğŸ‘ğŸ»","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1635695906,"ip_address":"","comment_id":318280,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1635229323","product_id":100061801,"comment_content":"åˆ·äº†ç¬¬ä¸‰éäº†ï¼Œæ¯æ¬¡éƒ½æœ‰ä¸ä¸€æ ·çš„æ”¶è·","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":529168,"discussion_content":"ğŸ‘ğŸ»ğŸ‘ğŸ»ğŸ‘ğŸ»","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635695906,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":264058,"user_name":"æ©™å­888","can_delete":false,"product_type":"c1","uid":1447790,"ip_address":"","ucode":"8FB8A9AAE526E3","user_header":"https://static001.geekbang.org/account/avatar/00/16/17/6e/76b4aa3d.jpg","comment_is_top":false,"comment_ctime":1606320981,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1606320981","product_id":100061801,"comment_content":"æ‰“å¡ã€‚","like_count":0}]}