{"id":350285,"title":"21 | åˆ†å¸ƒå¼é”ï¼šä¸ºä»€ä¹ˆåŸºäºetcdå®ç°åˆ†å¸ƒå¼é”æ¯”Redisé”æ›´å®‰å…¨ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å”èªã€‚</p><p>åœ¨è½¯ä»¶å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°å„ç§åœºæ™¯è¦æ±‚å¯¹å…±äº«èµ„æºè¿›è¡Œäº’æ–¥æ“ä½œï¼Œå¦åˆ™æ•´ä¸ªç³»ç»Ÿçš„æ•°æ®ä¸€è‡´æ€§å°±ä¼šå‡ºç°é—®é¢˜ã€‚å…¸å‹åœºæ™¯å¦‚å•†å“åº“å­˜æ“ä½œã€Kubernertesè°ƒåº¦å™¨ä¸ºPodåˆ†é…è¿è¡Œçš„Nodeã€‚</p><p>é‚£è¦å¦‚ä½•å®ç°å¯¹å…±äº«èµ„æºè¿›è¡Œäº’æ–¥æ“ä½œå‘¢ï¼Ÿ</p><p>é”å°±æ˜¯å…¶ä¸­ä¸€ä¸ªéå¸¸é€šç”¨çš„è§£å†³æ–¹æ¡ˆã€‚åœ¨å•èŠ‚ç‚¹å¤šçº¿ç¨‹ç¯å¢ƒï¼Œä½ ä½¿ç”¨æœ¬åœ°çš„äº’æ–¥é”å°±å¯ä»¥å®Œæˆèµ„æºçš„äº’æ–¥æ“ä½œã€‚ç„¶è€Œå•èŠ‚ç‚¹å­˜åœ¨å•ç‚¹æ•…éšœï¼Œä¸ºäº†ä¿è¯æœåŠ¡é«˜å¯ç”¨ï¼Œä½ éœ€è¦å¤šèŠ‚ç‚¹éƒ¨ç½²ã€‚åœ¨å¤šèŠ‚ç‚¹éƒ¨ç½²çš„åˆ†å¸ƒå¼æ¶æ„ä¸­ï¼Œä½ å°±éœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼é”æ¥è§£å†³èµ„æºäº’æ–¥æ“ä½œäº†ã€‚</p><p>ä½†æ˜¯ä¸ºä»€ä¹ˆæœ‰çš„ä¸šåŠ¡ä½¿ç”¨äº†åˆ†å¸ƒå¼é”è¿˜ä¼šå‡ºç°å„ç§ä¸¥é‡è¶…å–äº‹æ•…å‘¢ï¼Ÿåˆ†å¸ƒå¼é”çš„å®ç°å’Œä½¿ç”¨è¿‡ç¨‹éœ€è¦æ³¨æ„ä»€ä¹ˆï¼Ÿ</p><p>ä»Šå¤©ï¼Œæˆ‘å°±å’Œä½ èŠèŠåˆ†å¸ƒå¼é”èƒŒåçš„æ•…äº‹ï¼Œæˆ‘å°†é€šè¿‡ä¸€ä¸ªèŒ…å°è¶…å–çš„æ¡ˆä¾‹ï¼Œä¸ºä½ ä»‹ç»åŸºäºRediså®ç°çš„åˆ†å¸ƒé”ä¼˜ç¼ºç‚¹ï¼Œå¼•å‡ºåˆ†å¸ƒå¼é”çš„æ ¸å¿ƒè¦ç´ ï¼Œå¯¹æ¯”åˆ†å¸ƒå¼é”çš„å‡ ç§ä¸šç•Œå…¸å‹å®ç°æ–¹æ¡ˆï¼Œæ·±å…¥å‰–æetcdåˆ†å¸ƒå¼é”çš„å®ç°ã€‚</p><p>å¸Œæœ›é€šè¿‡è¿™èŠ‚è¯¾ï¼Œè®©ä½ äº†è§£etcdåˆ†å¸ƒå¼é”çš„åº”ç”¨åœºæ™¯ã€æ ¸å¿ƒåŸç†ï¼Œåœ¨ä¸šåŠ¡å¼€å‘è¿‡ç¨‹ä¸­ï¼Œä¼˜é›…ã€åˆç†çš„ä½¿ç”¨åˆ†å¸ƒå¼é”å»è§£å†³å„ç±»èµ„æºäº’æ–¥ã€å¹¶å‘æ“ä½œé—®é¢˜ã€‚</p><h2>ä»èŒ…å°è¶…å–æ¡ˆä¾‹çœ‹åˆ†å¸ƒå¼é”è¦ç´ </h2><p>é¦–å…ˆæˆ‘ä»¬ä»å»å¹´ä¸€ä¸ªå› Redisåˆ†å¸ƒå¼é”å®ç°é—®é¢˜å¯¼è‡´<a href=\"https://juejin.cn/post/6854573212831842311\">èŒ…å°è¶…å–æ¡ˆä¾‹</a>è¯´èµ·ï¼Œåœ¨è¿™ä¸ªç½‘å‹åˆ†äº«çš„çœŸå®æ¡ˆä¾‹ä¸­ï¼Œå› èŒ…å°çš„ç¨€ç¼ºæ€§ï¼Œäº‹ä»¶æœ€ç»ˆå®šçº§ä¸ºP0çº§ç”Ÿäº§äº‹æ•…ï¼Œåæœå½±å“ä¸¥é‡ã€‚</p><!-- [[[read_end]]] --><p>é‚£ä¹ˆå®ƒæ˜¯å¦‚ä½•å¯¼è‡´è¶…å–çš„å‘¢ï¼Ÿ</p><p>é¦–å…ˆå’Œä½ ç®€å•ä»‹ç»ä¸‹æ­¤æ¡ˆä¾‹ä¸­çš„Redisç®€æ˜“åˆ†å¸ƒå¼é”å®ç°æ–¹æ¡ˆï¼Œå®ƒä½¿ç”¨äº†Redis SETå‘½ä»¤æ¥å®ç°ã€‚</p><pre><code>SET key value [EX seconds|PX milliseconds|EXAT timestamp|PXAT milliseconds-timestamp|KEEPTTL] [NX|XX] \n[GET]\n</code></pre><p>ç®€å•ç»™ä½ ä»‹ç»ä¸‹SETå‘½ä»¤é‡ç‚¹å‚æ•°å«ä¹‰ï¼š</p><ul>\n<li><code>EX</code>  è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå•ä½ç§’ï¼›</li>\n<li><code>NX</code> å½“keyä¸å­˜åœ¨çš„æ—¶å€™ï¼Œæ‰è®¾ç½®keyï¼›</li>\n<li><code>XX</code> å½“keyå­˜åœ¨çš„æ—¶å€™ï¼Œæ‰è®¾ç½®keyã€‚</li>\n</ul><p>æ­¤ä¸šåŠ¡å°±æ˜¯åŸºäºSet key value EX 10 NXå‘½ä»¤æ¥å®ç°çš„åˆ†å¸ƒå¼é”ï¼Œå¹¶é€šè¿‡JAVAçš„try-finallyè¯­å¥ï¼Œæ‰§è¡ŒDel keyè¯­å¥æ¥é‡Šæ”¾é”ï¼Œç®€æ˜“æµç¨‹å¦‚ä¸‹ï¼š</p><pre><code># å¯¹èµ„æºkeyåŠ é”ï¼Œkeyä¸å­˜åœ¨æ—¶åˆ›å»ºï¼Œå¹¶ä¸”è®¾ç½®ï¼Œ10ç§’è‡ªåŠ¨è¿‡æœŸ\nSET key value EX 10 NX\nä¸šåŠ¡é€»è¾‘æµç¨‹1ï¼Œæ ¡éªŒç”¨æˆ·èº«ä»½\nä¸šåŠ¡é€»è¾‘æµç¨‹2ï¼ŒæŸ¥è¯¢å¹¶æ ¡éªŒåº“å­˜(get and compare)\nä¸šåŠ¡é€»è¾‘æµç¨‹3ï¼Œåº“å­˜&gt;0ï¼Œæ‰£å‡åº“å­˜(Decr stock)ï¼Œç”Ÿæˆç§’æ€èŒ…å°è®¢å•\n\n# é‡Šæ”¾é”\nDel key\n</code></pre><p>ä»¥ä¸Šæµç¨‹ä¸­å…¶å®å­˜åœ¨ä»¥ä¸‹æ€è€ƒç‚¹:</p><ul>\n<li>NXå‚æ•°æœ‰ä»€ä¹ˆä½œç”¨?</li>\n<li>ä¸ºä»€ä¹ˆéœ€è¦åŸå­çš„è®¾ç½®keyåŠè¿‡æœŸæ—¶é—´ï¼Ÿ</li>\n<li>ä¸ºä»€ä¹ˆåŸºäºSet key value EX 10 NXå‘½ä»¤è¿˜å‡ºç°äº†è¶…å–å‘¢?</li>\n<li>ä¸ºä»€ä¹ˆå¤§å®¶éƒ½æ¯”è¾ƒå–œæ¬¢ä½¿ç”¨Redisä½œä¸ºåˆ†å¸ƒå¼é”å®ç°ï¼Ÿ</li>\n</ul><p>é¦–å…ˆæ¥çœ‹ç¬¬ä¸€ä¸ªé—®é¢˜ï¼ŒNXå‚æ•°çš„ä½œç”¨ã€‚NXå‚æ•°æ˜¯ä¸ºäº†ä¿è¯å½“åˆ†å¸ƒå¼é”ä¸å­˜åœ¨æ—¶ï¼Œåªæœ‰ä¸€ä¸ªclientèƒ½å†™å…¥æ­¤keyæˆåŠŸï¼Œè·å–åˆ°æ­¤é”ã€‚æˆ‘ä»¬ä½¿ç”¨åˆ†å¸ƒå¼é”çš„ç›®çš„å°±æ˜¯å¸Œæœ›åœ¨é«˜å¹¶å‘ç³»ç»Ÿä¸­ï¼Œæœ‰ä¸€ç§äº’æ–¥æœºåˆ¶æ¥é˜²æ­¢å½¼æ­¤ç›¸äº’å¹²æ‰°ï¼Œä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚</p><p><strong>å› æ­¤åˆ†å¸ƒå¼é”çš„ç¬¬ä¸€æ ¸å¿ƒè¦ç´ å°±æ˜¯äº’æ–¥æ€§ã€å®‰å…¨æ€§ã€‚åœ¨åŒä¸€æ—¶é—´å†…ï¼Œä¸å…è®¸å¤šä¸ªclientåŒæ—¶è·å¾—é”ã€‚</strong></p><p>å†çœ‹ç¬¬äºŒä¸ªé—®é¢˜ï¼Œå‡è®¾æˆ‘ä»¬æœªè®¾ç½®keyè‡ªåŠ¨è¿‡æœŸæ—¶é—´ï¼Œåœ¨Set key value NXåï¼Œå¦‚æœç¨‹åºcrashæˆ–è€…å‘ç”Ÿç½‘ç»œåˆ†åŒºåæ— æ³•ä¸RedisèŠ‚ç‚¹é€šä¿¡ï¼Œæ¯«æ— ç–‘é—®å…¶ä»–clientå°†æ°¸è¿œæ— æ³•è·å¾—é”ã€‚è¿™å°†å¯¼è‡´æ­»é”ï¼ŒæœåŠ¡å‡ºç°ä¸­æ–­ã€‚</p><p>æœ‰çš„åŒå­¦æ„è¯†åˆ°è¿™ä¸ªé—®é¢˜åï¼Œä½¿ç”¨å¦‚ä¸‹SETNXå’ŒEXPIREå‘½ä»¤å»è®¾ç½®keyå’Œè¿‡æœŸæ—¶é—´ï¼Œè¿™ä¹Ÿæ˜¯ä¸æ­£ç¡®çš„ï¼Œå› ä¸ºä½ æ— æ³•ä¿è¯SETNXå’ŒEXPIREå‘½ä»¤çš„åŸå­æ€§ã€‚</p><pre><code># å¯¹èµ„æºkeyåŠ é”ï¼Œkeyä¸å­˜åœ¨æ—¶åˆ›å»º\nSETNX key value\n# è®¾ç½®KEYè¿‡æœŸæ—¶é—´\nEXPIRE key 10\nä¸šåŠ¡é€»è¾‘æµç¨‹\n\n# é‡Šæ”¾é”\nDel key\n</code></pre><p><strong>è¿™å°±æ˜¯åˆ†å¸ƒå¼é”ç¬¬äºŒä¸ªæ ¸å¿ƒè¦ç´ ï¼Œæ´»æ€§ã€‚åœ¨å®ç°åˆ†å¸ƒå¼é”çš„è¿‡ç¨‹ä¸­è¦è€ƒè™‘åˆ°clientå¯èƒ½ä¼šå‡ºç°crashæˆ–è€…ç½‘ç»œåˆ†åŒºï¼Œä½ éœ€è¦åŸå­ç”³è¯·åˆ†å¸ƒå¼é”åŠè®¾ç½®é”çš„è‡ªåŠ¨è¿‡æœŸæ—¶é—´ï¼Œé€šè¿‡è¿‡æœŸã€è¶…æ—¶ç­‰æœºåˆ¶è‡ªåŠ¨é‡Šæ”¾é”ï¼Œé¿å…å‡ºç°æ­»é”ï¼Œå¯¼è‡´ä¸šåŠ¡ä¸­æ–­ã€‚</strong></p><p>å†çœ‹ç¬¬ä¸‰ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆä½¿ç”¨äº†Set key value EX 10 NXå‘½ä»¤ï¼Œè¿˜å‡ºç°äº†è¶…å–å‘¢ï¼Ÿ</p><p>åŸæ¥æ˜¯æŠ¢è´­æ´»åŠ¨å¼€å§‹åï¼ŒåŠ é”é€»è¾‘ä¸­çš„ä¸šåŠ¡æµç¨‹1è®¿é—®çš„ç”¨æˆ·èº«ä»½æœåŠ¡å‡ºç°äº†é«˜è´Ÿè½½ï¼Œå¯¼è‡´é˜»å¡åœ¨æ ¡éªŒç”¨æˆ·èº«ä»½æµç¨‹ä¸­(è¶…æ—¶30ç§’)ï¼Œç„¶è€Œé”10ç§’åå°±è‡ªåŠ¨è¿‡æœŸäº†ï¼Œå› æ­¤å…¶ä»–clientèƒ½è·å–åˆ°é”ã€‚å…³é”®æ˜¯é˜»å¡çš„è¯·æ±‚æ‰§è¡Œå®Œåï¼Œå®ƒåˆæŠŠå…¶ä»–clientçš„é”é‡Šæ”¾æ‰äº†ï¼Œå¯¼è‡´è¿›å…¥ä¸€ä¸ªæ¶æ€§å¾ªç¯ã€‚</p><p>å› æ­¤ç”³è¯·é”æ—¶ï¼Œå†™å…¥çš„valueåº”ç¡®ä¿å”¯ä¸€æ€§ï¼ˆéšæœºå€¼ç­‰ï¼‰ã€‚clientåœ¨é‡Šæ”¾é”æ—¶ï¼Œåº”é€šè¿‡Luaè„šæœ¬åŸå­æ ¡éªŒæ­¤é”çš„valueä¸è‡ªå·±å†™å…¥çš„valueä¸€è‡´ï¼Œè‹¥ä¸€è‡´æ‰èƒ½æ‰§è¡Œé‡Šæ”¾å·¥ä½œã€‚</p><p>æ›´å…³é”®çš„æ˜¯åº“å­˜æ ¡éªŒæ˜¯é€šè¿‡get and compareæ–¹å¼ï¼Œå®ƒå‹æ ¹å°±æ— æ³•é˜²æ­¢è¶…å–ã€‚æ­£ç¡®çš„è§£å†³æ–¹æ¡ˆåº”è¯¥æ˜¯é€šè¿‡LUAè„šæœ¬å®ç°Redisæ¯”è¾ƒåº“å­˜ã€æ‰£å‡åº“å­˜æ“ä½œçš„åŸå­æ€§ï¼ˆæˆ–è€…åœ¨æ¯æ¬¡åªèƒ½æŠ¢è´­ä¸€ä¸ªçš„æƒ…å†µä¸‹ï¼Œé€šè¿‡åˆ¤æ–­<a href=\"https://redis.io/commands/DECR\">Redis Decrå‘½ä»¤</a>çš„è¿”å›å€¼å³å¯ã€‚æ­¤å‘½ä»¤ä¼šè¿”å›æ‰£å‡åçš„æœ€æ–°åº“å­˜ï¼Œè‹¥å°äº0åˆ™è¡¨ç¤ºè¶…å–ï¼‰ã€‚</p><p><strong>ä»è¿™ä¸ªé—®é¢˜ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåˆ†å¸ƒå¼é”å®ç°å…·å¤‡ä¸€å®šçš„å¤æ‚åº¦ï¼Œå®ƒä¸ä»…ä¾èµ–å­˜å‚¨æœåŠ¡æä¾›çš„æ ¸å¿ƒæœºåˆ¶ï¼ŒåŒæ—¶ä¾èµ–ä¸šåŠ¡é¢†åŸŸçš„å®ç°ã€‚æ— è®ºæ˜¯é­é‡é«˜è´Ÿè½½ã€è¿˜æ˜¯å®•æœºã€ç½‘ç»œåˆ†åŒºç­‰æ•…éšœï¼Œéƒ½éœ€ç¡®ä¿é”çš„äº’æ–¥æ€§ã€å®‰å…¨æ€§ï¼Œå¦åˆ™å°±ä¼šå‡ºç°ä¸¥é‡çš„è¶…å–ç”Ÿäº§äº‹æ•…ã€‚</strong></p><p>å†çœ‹æœ€åä¸€ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆå¤§å®¶éƒ½æ¯”è¾ƒå–œæ¬¢ä½¿ç”¨Redisåšåˆ†å¸ƒå¼é”çš„å®ç°å‘¢?</p><p>è€ƒè™‘åˆ°åœ¨ç§’æ€ç­‰ä¸šåŠ¡åœºæ™¯ä¸Šå­˜åœ¨å¤§é‡çš„ç¬é—´ã€é«˜å¹¶å‘è¯·æ±‚ï¼ŒåŠ é”ä¸é‡Šæ”¾é”çš„è¿‡ç¨‹åº”æ˜¯é«˜æ€§èƒ½ã€é«˜å¯ç”¨çš„ã€‚è€ŒRedisæ ¸å¿ƒä¼˜ç‚¹å°±æ˜¯å¿«ã€ç®€å•ï¼Œæ˜¯éšå¤„å¯è§çš„åŸºç¡€è®¾æ–½ï¼Œéƒ¨ç½²ã€ä½¿ç”¨ä¹ŸåŠå…¶æ–¹ä¾¿ï¼Œå› æ­¤å¹¿å—å¼€å‘è€…æ¬¢è¿ã€‚</p><p><strong>è¿™å°±æ˜¯åˆ†å¸ƒå¼é”ç¬¬ä¸‰ä¸ªæ ¸å¿ƒè¦ç´ ï¼Œé«˜æ€§èƒ½ã€é«˜å¯ç”¨ã€‚åŠ é”ã€é‡Šæ”¾é”çš„è¿‡ç¨‹æ€§èƒ½å¼€é”€è¦å°½é‡ä½ï¼ŒåŒæ—¶è¦ä¿è¯é«˜å¯ç”¨ï¼Œç¡®ä¿ä¸šåŠ¡ä¸ä¼šå‡ºç°ä¸­æ–­ã€‚</strong></p><p>é‚£ä¹ˆé™¤äº†ä»¥ä¸Šæ¡ˆä¾‹ä¸­äººä¸ºå®ç°é—®é¢˜å¯¼è‡´çš„é”ä¸å®‰å…¨å› ç´ å¤–ï¼ŒåŸºäºRediså®ç°çš„ä»¥ä¸Šåˆ†å¸ƒå¼é”è¿˜æœ‰å“ªäº›å®‰å…¨æ€§é—®é¢˜å‘¢ï¼Ÿ</p><h2>Redisåˆ†å¸ƒå¼é”é—®é¢˜</h2><p>æˆ‘ä»¬ä»èŒ…å°è¶…å–æ¡ˆä¾‹ä¸­ä¸ºä½ æ€»ç»“å‡ºçš„åˆ†å¸ƒå¼æ ¸å¿ƒè¦ç´ ï¼ˆäº’æ–¥æ€§ã€å®‰å…¨æ€§ã€æ´»æ€§ã€é«˜å¯ç”¨ã€é«˜æ€§èƒ½ï¼‰è¯´èµ·ã€‚</p><p>é¦–å…ˆï¼Œå¦‚æœæˆ‘ä»¬çš„åˆ†å¸ƒå¼é”è·‘åœ¨å•èŠ‚ç‚¹çš„Redis MasterèŠ‚ç‚¹ä¸Šï¼Œé‚£ä¹ˆå®ƒå°±å­˜åœ¨å•ç‚¹æ•…éšœï¼Œæ— æ³•ä¿è¯åˆ†å¸ƒå¼é”çš„é«˜å¯ç”¨ã€‚</p><p>äºæ˜¯æˆ‘ä»¬éœ€è¦ä¸€ä¸ªä¸»å¤‡ç‰ˆçš„RedisæœåŠ¡ï¼Œè‡³å°‘å…·å¤‡ä¸€ä¸ªSlaveèŠ‚ç‚¹ã€‚</p><p>æˆ‘ä»¬åˆçŸ¥é“Redisæ˜¯åŸºäºä¸»å¤‡å¼‚æ­¥å¤åˆ¶åè®®å®ç°çš„Master-Slaveæ•°æ®åŒæ­¥ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè‹¥client Aæ‰§è¡ŒSET key value EX 10 NXå‘½ä»¤ï¼Œredis-serverè¿”å›ç»™client AæˆåŠŸåï¼ŒRedis MasterèŠ‚ç‚¹çªç„¶å‡ºç°crashç­‰å¼‚å¸¸ï¼Œè¿™æ—¶å€™Redis SlaveèŠ‚ç‚¹è¿˜æœªæ”¶åˆ°æ­¤å‘½ä»¤çš„åŒæ­¥ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/cd/45/cd3d4ab1af45c6eb76e7dccd9c666245.png?wh=1920*994\" alt=\"\"></p><p>è‹¥ä½ éƒ¨ç½²äº†Redis Sentinelç­‰ä¸»å¤‡åˆ‡æ¢æœåŠ¡ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šä»¥SlaveèŠ‚ç‚¹æå‡ä¸ºä¸»ï¼Œæ­¤æ—¶SlaveèŠ‚ç‚¹å› å¹¶æœªæ‰§è¡ŒSET key value EX 10 NXå‘½ä»¤ï¼Œå› æ­¤å®ƒæ”¶åˆ°client Bå‘èµ·çš„åŠ é”çš„æ­¤å‘½ä»¤åï¼Œå®ƒä¹Ÿä¼šè¿”å›æˆåŠŸç»™clientã€‚</p><p>é‚£ä¹ˆåœ¨åŒä¸€æ—¶åˆ»ï¼Œé›†ç¾¤å°±å‡ºç°äº†ä¸¤ä¸ªclientåŒæ—¶è·å¾—é”ï¼Œåˆ†å¸ƒå¼é”çš„äº’æ–¥æ€§ã€å®‰å…¨æ€§å°±è¢«ç ´åäº†ã€‚</p><p>é™¤äº†ä¸»å¤‡åˆ‡æ¢å¯èƒ½ä¼šå¯¼è‡´åŸºäºRediså®ç°çš„åˆ†å¸ƒå¼é”å‡ºç°å®‰å…¨æ€§é—®é¢˜ï¼Œåœ¨å‘ç”Ÿç½‘ç»œåˆ†åŒºç­‰åœºæ™¯ä¸‹ä¹Ÿå¯èƒ½ä¼šå¯¼è‡´å‡ºç°è„‘è£‚ï¼ŒRedisé›†ç¾¤å‡ºç°å¤šä¸ªMasterï¼Œè¿›è€Œä¹Ÿä¼šå¯¼è‡´å¤šä¸ªclientåŒæ—¶è·å¾—é”ã€‚</p><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒMasterèŠ‚ç‚¹åœ¨å¯ç”¨åŒº1ï¼ŒSlaveèŠ‚ç‚¹åœ¨å¯ç”¨åŒº2ï¼Œå½“å¯ç”¨åŒº1å’Œå¯ç”¨åŒº2å‘ç”Ÿç½‘ç»œåˆ†åŒºåï¼Œéƒ¨ç½²åœ¨å¯ç”¨åŒº2çš„Redis SentinelæœåŠ¡å°±ä¼šå°†å¯ç”¨åŒº2çš„Slaveæå‡ä¸ºMasterï¼Œè€Œæ­¤æ—¶å¯ç”¨åŒº1çš„Masterä¹Ÿåœ¨å¯¹å¤–æä¾›æœåŠ¡ã€‚å› æ­¤é›†ç¾¤å°±å‡ºç°äº†è„‘è£‚ï¼Œå‡ºç°äº†ä¸¤ä¸ªMasterï¼Œéƒ½å¯å¯¹å¤–æä¾›åˆ†å¸ƒå¼é”ç”³è¯·ä¸é‡Šæ”¾æœåŠ¡ï¼Œåˆ†å¸ƒå¼é”çš„äº’æ–¥æ€§è¢«ä¸¥é‡ç ´åã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/cb/b1/cb4cb52cf2244d2000884ef5f5ff3db1.png?wh=1920*1026\" alt=\"\"></p><p><strong>ä¸»å¤‡åˆ‡æ¢ã€è„‘è£‚æ˜¯Redisåˆ†å¸ƒå¼é”çš„ä¸¤ä¸ªå…¸å‹ä¸å®‰å…¨çš„å› ç´ ï¼Œæœ¬è´¨åŸå› æ˜¯Redisä¸ºäº†æ»¡è¶³é«˜æ€§èƒ½ï¼Œé‡‡ç”¨äº†ä¸»å¤‡å¼‚æ­¥å¤åˆ¶åè®®ï¼ŒåŒæ—¶ä¹Ÿä¸è´Ÿè´£ä¸»å¤‡åˆ‡æ¢çš„Redis SentinelæœåŠ¡æ˜¯å¦åˆç†éƒ¨ç½²æœ‰å…³ã€‚</strong></p><p>æœ‰æ²¡æœ‰å…¶ä»–æ–¹æ¡ˆè§£å†³å‘¢ï¼Ÿ</p><p>å½“ç„¶æœ‰ï¼ŒRedisä½œè€…ä¸ºäº†è§£å†³SET key value [EX] 10 [NX]å‘½ä»¤å®ç°åˆ†å¸ƒå¼é”ä¸å®‰å…¨çš„é—®é¢˜ï¼Œæå‡ºäº†<a href=\"https://redis.io/topics/distlock\">RedLockç®—æ³•</a>ã€‚å®ƒæ˜¯åŸºäºå¤šä¸ªç‹¬ç«‹çš„Redis MasterèŠ‚ç‚¹çš„ä¸€ç§å®ç°ï¼ˆä¸€èˆ¬ä¸º5ï¼‰ã€‚clientä¾æ¬¡å‘å„ä¸ªèŠ‚ç‚¹ç”³è¯·é”ï¼Œè‹¥èƒ½ä»å¤šæ•°ä¸ªèŠ‚ç‚¹ä¸­ç”³è¯·é”æˆåŠŸå¹¶æ»¡è¶³ä¸€äº›æ¡ä»¶é™åˆ¶ï¼Œé‚£ä¹ˆclientå°±èƒ½è·å–é”æˆåŠŸã€‚</p><p>å®ƒé€šè¿‡ç‹¬ç«‹çš„Nä¸ªMasterèŠ‚ç‚¹ï¼Œé¿å…äº†ä½¿ç”¨ä¸»å¤‡å¼‚æ­¥å¤åˆ¶åè®®çš„ç¼ºé™·ï¼Œåªè¦å¤šæ•°RedisèŠ‚ç‚¹æ­£å¸¸å°±èƒ½æ­£å¸¸å·¥ä½œï¼Œæ˜¾è‘—æå‡äº†åˆ†å¸ƒå¼é”çš„å®‰å…¨æ€§ã€å¯ç”¨æ€§ã€‚</p><p>ä½†æ˜¯ï¼Œå®ƒçš„å®ç°å»ºç«‹åœ¨ä¸€ä¸ªä¸å®‰å…¨çš„ç³»ç»Ÿæ¨¡å‹ä¸Šçš„ï¼Œå®ƒä¾èµ–ç³»ç»Ÿæ—¶é—´ï¼Œå½“æ—¶é’Ÿå‘ç”Ÿè·³è·ƒæ—¶ï¼Œä¹Ÿå¯èƒ½ä¼šå‡ºç°å®‰å…¨æ€§é—®é¢˜ã€‚ä½ è¦æœ‰å…´è¶£çš„è¯ï¼Œå¯ä»¥è¯¦ç»†é˜…è¯»ä¸‹åˆ†å¸ƒå¼å­˜å‚¨ä¸“å®¶Martinå¯¹<a href=\"https://martin.kleppmann.com/2016/02/08/how-to-do-distributed-locking.html\">RedLockçš„åˆ†ææ–‡ç« </a>ï¼ŒRedisä½œè€…çš„ä¹Ÿä¸“é—¨å†™äº†<a href=\"http://antirez.com/news/101\">ä¸€ç¯‡æ–‡ç« è¿›è¡Œäº†åé©³</a>ã€‚</p><h2>åˆ†å¸ƒå¼é”å¸¸è§å®ç°æ–¹æ¡ˆ</h2><p>äº†è§£å®ŒRedisåˆ†å¸ƒå¼é”çš„ä¸€ç³»åˆ—é—®é¢˜å’Œå®ç°æ–¹æ¡ˆåï¼Œæˆ‘ä»¬å†çœ‹çœ‹è¿˜æœ‰å“ªäº›å…¸å‹çš„åˆ†å¸ƒå¼é”å®ç°ã€‚</p><p>é™¤äº†Redisåˆ†å¸ƒå¼é”ï¼Œå…¶ä»–ä½¿ç”¨æœ€å¹¿çš„åº”è¯¥æ˜¯ZooKeeperåˆ†å¸ƒå¼é”å’Œetcdåˆ†å¸ƒå¼é”ã€‚</p><p>ZooKeeperä¹Ÿæ˜¯ä¸€ä¸ªå…¸å‹çš„åˆ†å¸ƒå¼å…ƒæ•°æ®å­˜å‚¨æœåŠ¡ï¼Œå®ƒçš„åˆ†å¸ƒå¼é”å®ç°åŸºäºZooKeeperçš„ä¸´æ—¶èŠ‚ç‚¹å’Œé¡ºåºç‰¹æ€§ã€‚</p><p>é¦–å…ˆä»€ä¹ˆæ˜¯ä¸´æ—¶èŠ‚ç‚¹å‘¢ï¼Ÿ</p><p>ä¸´æ—¶èŠ‚ç‚¹å…·å¤‡æ•°æ®è‡ªåŠ¨åˆ é™¤çš„åŠŸèƒ½ã€‚å½“clientä¸ZooKeeperè¿æ¥å’Œsessionæ–­æ‰æ—¶ï¼Œç›¸åº”çš„ä¸´æ—¶èŠ‚ç‚¹å°±ä¼šè¢«åˆ é™¤ã€‚</p><p>å…¶æ¬¡ZooKeeperä¹Ÿæä¾›äº†Watchç‰¹æ€§å¯ç›‘å¬keyçš„æ•°æ®å˜åŒ–ã€‚</p><p><a href=\"https://www.usenix.org/legacy/event/atc10/tech/full_papers/Hunt.pdf\">ä½¿ç”¨ZookeeperåŠ é”çš„ä¼ªä»£ç å¦‚ä¸‹</a>ï¼š</p><pre><code>Lock\n1 n = create(l + â€œ/lock-â€, EPHEMERAL|SEQUENTIAL)\n2 C = getChildren(l, false)\n3 if n is lowest znode in C, exit\n4 p = znode in C ordered just before n\n5 if exists(p, true) wait for watch event\n6 goto 2\nUnlock\n1 delete(n)\n</code></pre><p>æ¥ä¸‹æ¥æˆ‘é‡ç‚¹ç»™ä½ ä»‹ç»ä¸€ä¸‹åŸºäºetcdçš„åˆ†å¸ƒå¼é”å®ç°ã€‚</p><h2>etcdåˆ†å¸ƒå¼é”å®ç°</h2><p>é‚£ä¹ˆåŸºäºetcdå®ç°çš„åˆ†å¸ƒå¼é”æ˜¯å¦‚ä½•ç¡®ä¿å®‰å…¨æ€§ã€äº’æ–¥æ€§ã€æ´»æ€§çš„å‘¢ï¼Ÿ</p><h3>äº‹åŠ¡ä¸é”çš„å®‰å…¨æ€§</h3><p>ä»Redisæ¡ˆä¾‹ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒåŠ é”çš„è¿‡ç¨‹éœ€è¦ç¡®ä¿å®‰å…¨æ€§ã€äº’æ–¥æ€§ã€‚æ¯”å¦‚ï¼Œå½“keyä¸å­˜åœ¨æ—¶æ‰èƒ½åˆ›å»ºï¼Œå¦åˆ™æŸ¥è¯¢ç›¸å…³keyä¿¡æ¯ï¼Œè€Œetcdæä¾›çš„äº‹åŠ¡èƒ½åŠ›æ­£å¥½å¯ä»¥æ»¡è¶³æˆ‘ä»¬çš„è¯‰æ±‚ã€‚</p><p>æ­£å¦‚æˆ‘åœ¨<a href=\"https://time.geekbang.org/column/article/341935\">09</a>ä¸­ç»™ä½ ä»‹ç»çš„äº‹åŠ¡ç‰¹æ€§ï¼Œå®ƒç”±IFè¯­å¥ã€Thenè¯­å¥ã€Elseè¯­å¥ç»„æˆã€‚å…¶ä¸­åœ¨IFè¯­å¥ä¸­ï¼Œæ”¯æŒæ¯”è¾ƒkeyçš„æ˜¯ä¿®æ”¹ç‰ˆæœ¬å·mod_revisionå’Œåˆ›å»ºç‰ˆæœ¬å·create_revisionã€‚</p><p>åœ¨åˆ†å¸ƒå¼é”åœºæ™¯ï¼Œä½ å°±å¯ä»¥é€šè¿‡keyçš„åˆ›å»ºç‰ˆæœ¬å·create_revisionæ¥æ£€æŸ¥keyæ˜¯å¦å·²å­˜åœ¨ï¼Œå› ä¸ºä¸€ä¸ªkeyä¸å­˜åœ¨çš„è¯ï¼Œå®ƒçš„create_revisionç‰ˆæœ¬å·å°±æ˜¯0ã€‚</p><p>è‹¥create_revisionæ˜¯0ï¼Œä½ å°±å¯å‘èµ·putæ“ä½œåˆ›å»ºç›¸å…³keyï¼Œå…·ä½“ä»£ç å¦‚ä¸‹:</p><pre><code>txn := client.Txn(ctx).If(v3.Compare(v3.CreateRevision(k), \n&quot;=&quot;, 0))\n</code></pre><p>ä½ è¦æ³¨æ„çš„æ˜¯ï¼Œå®ç°åˆ†å¸ƒå¼é”çš„æ–¹æ¡ˆæœ‰å¤šç§ï¼Œæ¯”å¦‚ä½ å¯ä»¥é€šè¿‡clientæ˜¯å¦æˆåŠŸåˆ›å»ºä¸€ä¸ªå›ºå®šçš„keyï¼Œæ¥åˆ¤æ–­æ­¤clientæ˜¯å¦è·å¾—é”ï¼Œä½ ä¹Ÿå¯ä»¥é€šè¿‡å¤šä¸ªclientåˆ›å»ºprefixç›¸åŒï¼Œåç§°ä¸ä¸€æ ·çš„keyï¼Œå“ªä¸ªkeyçš„revisionæœ€å°ï¼Œæœ€ç»ˆå°±æ˜¯å®ƒè·å¾—é”ã€‚è‡³äºè°ä¼˜è°åŠ£ï¼Œæˆ‘ä½œä¸ºæ€è€ƒé¢˜çš„ä¸€éƒ¨åˆ†ï¼Œç•™ç»™å¤§å®¶ä¸€èµ·è®¨è®ºã€‚</p><p>ç›¸æ¯”RedisåŸºäºä¸»å¤‡å¼‚æ­¥å¤åˆ¶å¯¼è‡´é”çš„å®‰å…¨æ€§é—®é¢˜ï¼Œetcdæ˜¯åŸºäºRaftå…±è¯†ç®—æ³•å®ç°çš„ï¼Œä¸€ä¸ªå†™è¯·æ±‚éœ€è¦ç»è¿‡é›†ç¾¤å¤šæ•°èŠ‚ç‚¹ç¡®è®¤ã€‚å› æ­¤ä¸€æ—¦åˆ†å¸ƒå¼é”ç”³è¯·è¿”å›ç»™clientæˆåŠŸåï¼Œå®ƒä¸€å®šæ˜¯æŒä¹…åŒ–åˆ°äº†é›†ç¾¤å¤šæ•°èŠ‚ç‚¹ä¸Šï¼Œä¸ä¼šå‡ºç°Redisä¸»å¤‡å¼‚æ­¥å¤åˆ¶å¯èƒ½å¯¼è‡´ä¸¢æ•°æ®çš„é—®é¢˜ï¼Œå…·å¤‡æ›´é«˜çš„å®‰å…¨æ€§ã€‚</p><h3>Leaseä¸é”çš„æ´»æ€§</h3><p>é€šè¿‡äº‹åŠ¡å®ç°åŸå­çš„æ£€æŸ¥keyæ˜¯å¦å­˜åœ¨ã€åˆ›å»ºkeyåï¼Œæˆ‘ä»¬ç¡®ä¿äº†åˆ†å¸ƒå¼é”çš„å®‰å…¨æ€§ã€äº’æ–¥æ€§ã€‚é‚£ä¹ˆetcdæ˜¯å¦‚ä½•ç¡®ä¿é”çš„æ´»æ€§å‘¢? ä¹Ÿå°±æ˜¯å‘ç”Ÿä»»ä½•æ•…éšœï¼Œéƒ½å¯é¿å…å‡ºç°æ­»é”å‘¢ï¼Ÿ</p><p>æ­£å¦‚åœ¨<a href=\"https://time.geekbang.org/column/article/339337\">06</a>ç§Ÿçº¦ç‰¹æ€§ä¸­å’Œä½ ä»‹ç»çš„ï¼ŒLeaseå°±æ˜¯ä¸€ç§æ´»æ€§æ£€æµ‹æœºåˆ¶ï¼Œå®ƒæä¾›äº†æ£€æµ‹å„ä¸ªå®¢æˆ·ç«¯å­˜æ´»çš„èƒ½åŠ›ã€‚ä½ çš„ä¸šåŠ¡clientéœ€å®šæœŸå‘etcdæœåŠ¡å‘é€\"ç‰¹æ®Šå¿ƒè·³\"æ±‡æŠ¥å¥åº·çŠ¶æ€ï¼Œè‹¥ä½ æœªæ­£å¸¸å‘é€å¿ƒè·³ï¼Œå¹¶è¶…è¿‡å’ŒetcdæœåŠ¡çº¦å®šçš„æœ€å¤§å­˜æ´»æ—¶é—´åï¼Œå°±ä¼šè¢«etcdæœåŠ¡ç§»é™¤æ­¤Leaseå’Œå…¶å…³è”çš„æ•°æ®ã€‚</p><p>é€šè¿‡Leaseæœºåˆ¶å°±ä¼˜é›…åœ°è§£å†³äº†clientå‡ºç°crashæ•…éšœã€clientä¸etcdé›†ç¾¤ç½‘ç»œå‡ºç°éš”ç¦»ç­‰å„ç±»æ•…éšœåœºæ™¯ä¸‹çš„æ­»é”é—®é¢˜ã€‚ä¸€æ—¦è¶…è¿‡Lease TTLï¼Œå®ƒå°±èƒ½è‡ªåŠ¨è¢«é‡Šæ”¾ï¼Œç¡®ä¿äº†å…¶ä»–clientåœ¨TTLè¿‡æœŸåèƒ½æ­£å¸¸ç”³è¯·é”ï¼Œä¿éšœäº†ä¸šåŠ¡çš„å¯ç”¨æ€§ã€‚</p><p>å…·ä½“ä»£ç å¦‚ä¸‹:</p><pre><code>txn := client.Txn(ctx).If(v3.Compare(v3.CreateRevision(k), &quot;=&quot;, 0))\ntxn = txn.Then(v3.OpPut(k, val, v3.WithLease(s.Lease())))\ntxn = txn.Else(v3.OpGet(k))\nresp, err := txn.Commit()\nif err != nil {\n    return err\n}\n</code></pre><h3>Watchä¸é”çš„å¯ç”¨æ€§</h3><p>å½“ä¸€ä¸ªæŒæœ‰é”çš„client crashæ•…éšœåï¼Œå…¶ä»–clientå¦‚ä½•å¿«é€Ÿæ„ŸçŸ¥åˆ°æ­¤é”å¤±æ•ˆäº†ï¼Œå¿«é€Ÿè·å¾—é”å‘¢ï¼Œæœ€å¤§ç¨‹åº¦é™ä½é”çš„ä¸å¯ç”¨æ—¶é—´å‘¢ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯Watchç‰¹æ€§ã€‚æ­£å¦‚åœ¨08 Watchç‰¹æ€§ä¸­å’Œä½ ä»‹ç»çš„ï¼ŒWatchæä¾›äº†é«˜æ•ˆçš„æ•°æ®ç›‘å¬èƒ½åŠ›ã€‚å½“å…¶ä»–clientæ”¶åˆ°Watch Deleteäº‹ä»¶åï¼Œå°±å¯å¿«é€Ÿåˆ¤æ–­è‡ªå·±æ˜¯å¦æœ‰èµ„æ ¼è·å¾—é”ï¼Œæå¤§å‡å°‘äº†é”çš„ä¸å¯ç”¨æ—¶é—´ã€‚</p><p>å…·ä½“ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>var wr v3.WatchResponse\nwch := client.Watch(cctx, key, v3.WithRev(rev))\nfor wr = range wch {\n   for _, ev := range wr.Events {\n      if ev.Type == mvccpb.DELETE {\n         return nil\n      }\n   }\n}\n</code></pre><h3>etcdè‡ªå¸¦çš„concurrencyåŒ…</h3><p>ä¸ºäº†å¸®åŠ©ä½ ç®€åŒ–åˆ†å¸ƒå¼é”ã€åˆ†å¸ƒå¼é€‰ä¸¾ã€åˆ†å¸ƒå¼äº‹åŠ¡çš„å®ç°ï¼Œetcdç¤¾åŒºæä¾›äº†ä¸€ä¸ªåä¸ºconcurrencyåŒ…å¸®åŠ©ä½ æ›´ç®€å•ã€æ­£ç¡®åœ°ä½¿ç”¨åˆ†å¸ƒå¼é”ã€åˆ†å¸ƒå¼é€‰ä¸¾ã€‚</p><p>ä¸‹é¢æˆ‘ç®€å•ä¸ºä½ ä»‹ç»ä¸‹åˆ†å¸ƒå¼é”<a href=\"https://github.com/etcd-io/etcd/tree/v3.4.9/clientv3/concurrency\">concurrency</a>åŒ…çš„ä½¿ç”¨å’Œå®ç°ï¼Œå®ƒçš„ä½¿ç”¨éå¸¸ç®€å•ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼Œæ ¸å¿ƒæµç¨‹å¦‚ä¸‹ï¼š</p><ul>\n<li>é¦–å…ˆé€šè¿‡concurrency.NewSessionæ–¹æ³•åˆ›å»ºSessionï¼Œæœ¬è´¨æ˜¯åˆ›å»ºäº†ä¸€ä¸ªTTLä¸º10çš„Leaseã€‚</li>\n<li>å…¶æ¬¡å¾—åˆ°sessionå¯¹è±¡åï¼Œé€šè¿‡concurrency.NewMutexåˆ›å»ºäº†ä¸€ä¸ªmutexå¯¹è±¡ï¼ŒåŒ…å«Leaseã€key prefixç­‰ä¿¡æ¯ã€‚</li>\n<li>ç„¶åé€šè¿‡mutexå¯¹è±¡çš„Lockæ–¹æ³•å°è¯•è·å–é”ã€‚</li>\n<li>æœ€åä½¿ç”¨ç»“æŸï¼Œå¯é€šè¿‡mutexå¯¹è±¡çš„Unlockæ–¹æ³•é‡Šæ”¾é”ã€‚</li>\n</ul><pre><code>cli, err := clientv3.New(clientv3.Config{Endpoints: endpoints})\nif err != nil {\n   log.Fatal(err)\n}\ndefer cli.Close()\n// create two separate sessions for lock competition\ns1, err := concurrency.NewSession(cli, concurrency.WithTTL(10))\nif err != nil {\n   log.Fatal(err)\n}\ndefer s1.Close()\nm1 := concurrency.NewMutex(s1, &quot;/my-lock/&quot;)\n// acquire lock for s1\nif err := m1.Lock(context.TODO()); err != nil {\n   log.Fatal(err)\n}\nfmt.Println(&quot;acquired lock for s1&quot;)\nif err := m1.Unlock(context.TODO()); err != nil {\n   log.Fatal(err)\n}\nfmt.Println(&quot;released lock for s1&quot;)\n</code></pre><p>é‚£ä¹ˆmutexå¯¹è±¡çš„Lockæ–¹æ³•æ˜¯å¦‚ä½•åŠ é”çš„å‘¢ï¼Ÿ</p><p>æ ¸å¿ƒè¿˜æ˜¯ä½¿ç”¨äº†æˆ‘ä»¬ä¸Šé¢ä»‹ç»çš„äº‹åŠ¡å’ŒLeaseç‰¹æ€§ï¼Œå½“CreateRevisionä¸º0æ—¶ï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸ªprefixä¸º/my-lockçš„keyï¼ˆ /my-lock + LeaseID)ï¼Œå¹¶è·å–åˆ°/my-lock prefixä¸‹é¢æœ€æ—©åˆ›å»ºçš„ä¸€ä¸ªkeyï¼ˆrevisionæœ€å°ï¼‰ï¼Œåˆ†å¸ƒå¼é”æœ€ç»ˆæ˜¯ç”±å†™å…¥æ­¤keyçš„clientè·å¾—ï¼Œå…¶ä»–clientåˆ™è¿›å…¥ç­‰å¾…æ¨¡å¼ã€‚</p><p>è¯¦ç»†ä»£ç å¦‚ä¸‹ï¼š</p><pre><code>m.myKey = fmt.Sprintf(&quot;%s%x&quot;, m.pfx, s.Lease())\ncmp := v3.Compare(v3.CreateRevision(m.myKey), &quot;=&quot;, 0)\n// put self in lock waiters via myKey; oldest waiter holds lock\nput := v3.OpPut(m.myKey, &quot;&quot;, v3.WithLease(s.Lease()))\n// reuse key in case this session already holds the lock\nget := v3.OpGet(m.myKey)\n// fetch current holder to complete uncontended path with only one RPC\ngetOwner := v3.OpGet(m.pfx, v3.WithFirstCreate()...)\nresp, err := client.Txn(ctx).If(cmp).Then(put, getOwner).Else(get, getOwner).Commit()\nif err != nil {\n   return err\n}\n</code></pre><p>é‚£æœªè·å¾—é”çš„clientæ˜¯å¦‚ä½•ç­‰å¾…çš„å‘¢?</p><p>ç­”æ¡ˆæ˜¯é€šè¿‡Watchæœºåˆ¶å„è‡ªç›‘å¬prefixç›¸åŒï¼Œrevisionæ¯”è‡ªå·±å°çš„keyï¼Œå› ä¸ºåªæœ‰revisionæ¯”è‡ªå·±å°çš„keyé‡Šæ”¾é”ï¼Œæˆ‘æ‰èƒ½æœ‰æœºä¼šï¼Œè·å¾—é”ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼Œå…¶ä¸­waitDeleteä¼šä½¿ç”¨æˆ‘ä»¬ä¸Šé¢çš„ä»‹ç»çš„Watchå»ç›‘å¬æ¯”è‡ªå·±å°çš„keyï¼Œè¯¦ç»†ä»£ç å¯å‚è€ƒ<a href=\"https://github.com/etcd-io/etcd/blob/v3.4.9/clientv3/concurrency/mutex.go\">concurrency mutex</a>çš„å®ç°ã€‚</p><pre><code>// wait for deletion revisions prior to myKey\nhdr, werr := waitDeletes(ctx, client, m.pfx, m.myRev-1)\n// release lock key if wait failed\nif werr != nil {\n   m.Unlock(client.Ctx())\n} else {\n   m.hdr = hdr\n}\n</code></pre><h2>å°ç»“</h2><p>æœ€åæˆ‘ä»¬æ¥å°ç»“ä¸‹ä»Šå¤©çš„å†…å®¹ã€‚</p><p>ä»Šå¤©æˆ‘é€šè¿‡ä¸€ä¸ªRedisåˆ†å¸ƒå¼é”å®ç°é—®é¢˜â€”â€”èŒ…å°è¶…å–æ¡ˆä¾‹ï¼Œç»™ä½ ä»‹ç»äº†åˆ†å¸ƒå¼é”çš„ä¸‰ä¸ªä¸»è¦æ ¸å¿ƒè¦ç´ ï¼Œå®ƒä»¬åˆ†åˆ«å¦‚ä¸‹ï¼š</p><ul>\n<li>å®‰å…¨æ€§ã€äº’æ–¥æ€§ã€‚åœ¨åŒä¸€æ—¶é—´å†…ï¼Œä¸å…è®¸å¤šä¸ªclientåŒæ—¶è·å¾—é”ã€‚</li>\n<li>æ´»æ€§ã€‚æ— è®ºclientå‡ºç°crashè¿˜æ˜¯é­é‡ç½‘ç»œåˆ†åŒºï¼Œä½ éƒ½éœ€è¦ç¡®ä¿ä»»æ„æ•…éšœåœºæ™¯ä¸‹ï¼Œéƒ½ä¸ä¼šå‡ºç°æ­»é”ï¼Œå¸¸ç”¨çš„è§£å†³æ–¹æ¡ˆæ˜¯è¶…æ—¶å’Œè‡ªåŠ¨è¿‡æœŸæœºåˆ¶ã€‚</li>\n<li>é«˜å¯ç”¨ã€é«˜æ€§èƒ½ã€‚åŠ é”ã€é‡Šæ”¾é”çš„è¿‡ç¨‹æ€§èƒ½å¼€é”€è¦å°½é‡ä½ï¼ŒåŒæ—¶è¦ä¿è¯é«˜å¯ç”¨ï¼Œé¿å…å•ç‚¹æ•…éšœã€‚</li>\n</ul><p>éšåæˆ‘é€šè¿‡è¿™ä¸ªæ¡ˆä¾‹ï¼Œç»§ç»­å’Œä½ åˆ†æäº†Redis SETå‘½ä»¤åˆ›å»ºåˆ†å¸ƒå¼é”çš„å®‰å…¨æ€§é—®é¢˜ã€‚å•Redis MasterèŠ‚ç‚¹å­˜åœ¨å•ç‚¹æ•…éšœï¼Œä¸€ä¸»å¤šå¤‡Rediså®ä¾‹åˆå› ä¸ºRedisä¸»å¤‡å¼‚æ­¥å¤åˆ¶ï¼Œå½“MasterèŠ‚ç‚¹å‘ç”Ÿcrashæ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´åŒæ—¶å¤šä¸ªclientæŒæœ‰åˆ†å¸ƒå¼é”ï¼Œè¿åäº†é”çš„å®‰å…¨æ€§é—®é¢˜ã€‚</p><p>ä¸ºäº†ä¼˜åŒ–ä»¥ä¸Šé—®é¢˜ï¼ŒRedisä½œè€…æå‡ºäº†RedLockåˆ†å¸ƒå¼é”ï¼Œå®ƒåŸºäºå¤šä¸ªç‹¬ç«‹çš„Redis MasterèŠ‚ç‚¹å·¥ä½œï¼Œåªè¦ä¸€åŠä»¥ä¸ŠèŠ‚ç‚¹å­˜æ´»å°±èƒ½æ­£å¸¸å·¥ä½œï¼ŒåŒæ—¶ä¸ä¾èµ–Redisä¸»å¤‡å¼‚æ­¥å¤åˆ¶ï¼Œå…·æœ‰è‰¯å¥½çš„å®‰å…¨æ€§ã€é«˜å¯ç”¨æ€§ã€‚ç„¶è€Œå®ƒçš„å®ç°ä¾èµ–äºç³»ç»Ÿæ—¶é—´ï¼Œå½“å‘ç”Ÿæ—¶é’Ÿè·³å˜çš„æ—¶å€™ï¼Œä¹Ÿä¼šå‡ºç°å®‰å…¨æ€§é—®é¢˜ã€‚</p><p>æœ€åæˆ‘å’Œä½ é‡ç‚¹ä»‹ç»äº†etcdçš„åˆ†å¸ƒå¼é”å®ç°è¿‡ç¨‹ä¸­çš„ä¸€äº›æŠ€æœ¯ç‚¹ã€‚å®ƒé€šè¿‡etcdäº‹åŠ¡æœºåˆ¶ï¼Œæ ¡éªŒCreateRevisionä¸º0æ‰èƒ½å†™å…¥ç›¸å…³keyã€‚è‹¥å¤šä¸ªclientåŒæ—¶ç”³è¯·é”ï¼Œåˆ™clienté€šè¿‡æ¯”è¾ƒå„ä¸ªkeyçš„revisionå¤§å°ï¼Œåˆ¤æ–­æ˜¯å¦è·å¾—é”ï¼Œç¡®ä¿äº†é”çš„å®‰å…¨æ€§ã€äº’æ–¥æ€§ã€‚é€šè¿‡Leaseæœºåˆ¶ç¡®ä¿äº†é”çš„æ´»æ€§ï¼Œæ— è®ºclientå‘ç”Ÿcrashè¿˜æ˜¯ç½‘ç»œåˆ†åŒºï¼Œéƒ½èƒ½ä¿è¯ä¸ä¼šå‡ºç°æ­»é”ã€‚é€šè¿‡Watchæœºåˆ¶ä½¿å…¶ä»–clientèƒ½å¿«é€Ÿæ„ŸçŸ¥åˆ°åŸclientæŒæœ‰çš„é”å·²é‡Šæ”¾ï¼Œæå‡äº†é”çš„å¯ç”¨æ€§ã€‚æœ€é‡è¦çš„æ˜¯etcdæ˜¯åŸºäºRaftåè®®å®ç°çš„é«˜å¯é ã€å¼ºä¸€è‡´å­˜å‚¨ï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼Œä¸å­˜åœ¨Redisä¸»å¤‡å¼‚æ­¥å¤åˆ¶åè®®å¯¼è‡´çš„æ•°æ®ä¸¢å¤±é—®é¢˜ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>è¿™èŠ‚è¯¾åˆ°è¿™é‡Œä¹Ÿå°±ç»“æŸäº†ï¼Œæœ€åæˆ‘ç»™ä½ ç•™äº†ä¸¤ä¸ªæ€è€ƒé¢˜ã€‚</p><p>ç¬¬ä¸€ï¼Œæ­»é”ã€è„‘è£‚ã€æƒŠç¾¤æ•ˆåº”æ˜¯åˆ†å¸ƒå¼é”çš„æ ¸å¿ƒé—®é¢˜ï¼Œä½ çŸ¥é“å®ƒä»¬å„è‡ªæ˜¯æ€ä¹ˆä¸€å›äº‹å—ï¼ŸZooKeeperå’Œetcdæ˜¯å¦‚ä½•åº”å¯¹è¿™äº›é—®é¢˜çš„å‘¢ï¼Ÿ</p><p>ç¬¬äºŒï¼Œè‹¥ä½ é”è®¾ç½®çš„10ç§’ï¼Œå¦‚æœä½ çš„æŸä¸šåŠ¡è¿›ç¨‹æŠ¢é”æˆåŠŸåï¼Œæ‰§è¡Œå¯èƒ½ä¼šè¶…è¿‡10ç§’æ‰æˆåŠŸï¼Œåœ¨è¿™è¿‡ç¨‹ä¸­å¦‚ä½•é¿å…é”è¢«è‡ªåŠ¨é‡Šæ”¾è€Œå‡ºç°çš„å®‰å…¨æ€§é—®é¢˜å‘¢?</p><p>æ„Ÿè°¢ä½ çš„é˜…è¯»ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™ç¯‡æ–‡ç« åˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹ä¸€èµ·é˜…è¯»ã€‚</p>","neighbors":{"left":{"article_title":"20 | Kubernetesé«˜çº§åº”ç”¨ï¼šå¦‚ä½•ä¼˜åŒ–ä¸šåŠ¡åœºæ™¯ä½¿etcdèƒ½æ”¯æ’‘ä¸Šä¸‡èŠ‚ç‚¹é›†ç¾¤ï¼Ÿ","id":348633},"right":{"article_title":"22 | é…ç½®åŠæœåŠ¡å‘ç°ï¼šè§£æetcdåœ¨API Gatewayå¼€æºé¡¹ç›®ä¸­åº”ç”¨","id":351113}},"comments":[{"had_liked":false,"id":282657,"user_name":"jeffery","can_delete":false,"product_type":"c1","uid":1219972,"ip_address":"","ucode":"35E2DAA386FB86","user_header":"https://static001.geekbang.org/account/avatar/00/12/9d/84/171b2221.jpg","comment_is_top":false,"comment_ctime":1615354046,"is_pvip":false,"replies":[{"id":"102643","content":"èµjefferyä¸€ç›´åšæŒä¸æ‡ˆçš„å­¦ä¹ ï¼Œæ„Ÿè°¢è®¤å¯ï¼Œä¸“æ è™½å³å°†ç»“æŸï¼Œä½†å­¦ä¹ ä¸æ¢ç´¢æœªçŸ¥é¢†åŸŸä»æœªæœ‰ç»ˆç‚¹ï¼Œåé¢æœ‰ä»€ä¹ˆæœ‰è¶£çš„æ¡ˆä¾‹ã€æ–°çš„ä½“ä¼šï¼Œæˆ‘ä¹Ÿä¼šé€šè¿‡ä¸“æ ã€å¾®ä¿¡å…¬ä¼—å·ã€åšå®¢ç­‰å„ç§æ¸ é“ä¸å¤§å®¶ä¸€èµ·åˆ†äº«äº¤æµï¼","user_name":"ä½œè€…å›å¤","user_name_real":"å”èª","uid":"1009582","ctime":1615434486,"ip_address":"","comment_id":282657,"utype":1}],"discussion_count":1,"race_medal":0,"score":"91809667262","product_id":100069901,"comment_content":"è€å¸ˆå¤ªå‰å®³äº†ğŸ‘etcdå’Œredis åˆ†æçš„å¤ªå¤ªé€å½»äº†ï¼ç»ˆäºæ˜ç™½äº†etcdå’Œredis é”çš„åŒºåˆ«äº†â€¦â€¦.ä¸“æ å¿«æ¥è¿‘å°¾å£°äº†â€¦â€¦çœŸæœ‰ç‚¹ä¸èˆï¼","like_count":21,"discussions":[{"author":{"id":1009582,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/67/ae/37b492db.jpg","nickname":"å”èª","note":"","ucode":"99CB061EDF35EA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":516804,"discussion_content":"èµjefferyä¸€ç›´åšæŒä¸æ‡ˆçš„å­¦ä¹ ï¼Œæ„Ÿè°¢è®¤å¯ï¼Œä¸“æ è™½å³å°†ç»“æŸï¼Œä½†å­¦ä¹ ä¸æ¢ç´¢æœªçŸ¥é¢†åŸŸä»æœªæœ‰ç»ˆç‚¹ï¼Œåé¢æœ‰ä»€ä¹ˆæœ‰è¶£çš„æ¡ˆä¾‹ã€æ–°çš„ä½“ä¼šï¼Œæˆ‘ä¹Ÿä¼šé€šè¿‡ä¸“æ ã€å¾®ä¿¡å…¬ä¼—å·ã€åšå®¢ç­‰å„ç§æ¸ é“ä¸å¤§å®¶ä¸€èµ·åˆ†äº«äº¤æµï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1615434486,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":334535,"user_name":"Geek_604077","can_delete":false,"product_type":"c1","uid":1969081,"ip_address":"","ucode":"3BDCDCA9187514","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/ib3Rzem884S5MOS96THy0gQXcF26PNsnRBpyr3pM5rVibZdYvAibpVvAGfibF1ddpgrteg9fQUsq4vce9EM95Jj97Q/132","comment_is_top":false,"comment_ctime":1644991169,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"36004729537","product_id":100069901,"comment_content":"æ­»é”ã€è„‘è£‚ã€æƒŠç¾¤æ•ˆåº”æ˜¯åˆ†å¸ƒå¼é”çš„æ ¸å¿ƒé—®é¢˜ï¼Œä½ çŸ¥é“å®ƒä»¬å„è‡ªæ˜¯æ€ä¹ˆä¸€å›äº‹å—ï¼ŸZooKeeper å’Œ etcd æ˜¯å¦‚ä½•åº”å¯¹è¿™äº›é—®é¢˜çš„å‘¢ï¼Ÿ<br>æ­»é”ï¼šåŠ é”åç”±äºæ²¡æœ‰æ·»åŠ é”çš„è¿‡æœŸæ—¶é—´æˆ–è€…é”çš„æ—¶é—´è®¾ç½®è¿‡é•¿ï¼ŒæœåŠ¡å¼‚å¸¸crashæˆ–è€…æœåŠ¡æ‰§è¡Œåæ¼æ‰§è¡Œé‡Šæ”¾é”æ“ä½œï¼Œå¯¼è‡´é”é•¿æ—¶é—´æ²¡æœ‰é‡Šæ”¾<br><br>è„‘è£‚ï¼šåˆ†å¸ƒå¼ä½“ç³»ç»“æ„ä¸­çš„é›†ä¸­å¼ç»“æ„ï¼ˆä¹Ÿç§°ä¸º Master&#47;Slave æ¶æ„ï¼‰ï¼Œä¸€ä¸ªMasterèŠ‚ç‚¹å¤šä¸ªSlaveèŠ‚ç‚¹ï¼Œæ‰€æœ‰çš„è¯·æ±‚æ•°æ®å¤„ç†å¿…é¡»å…ˆç»è¿‡Masterä¸­å¤®æœåŠ¡å™¨ï¼Œç”±Masterç»Ÿä¸€è¿›è¡Œèµ„æºå’Œä»»åŠ¡è°ƒåº¦ï¼Œä¸­å¤®æœåŠ¡å™¨æ ¹æ®è¿™äº›ä¿¡æ¯ï¼Œå°†ä»»åŠ¡ä¸‹è¾¾ç»™èŠ‚ç‚¹æœåŠ¡å™¨ï¼ŒèŠ‚ç‚¹æœåŠ¡å™¨æ‰§è¡Œä»»åŠ¡ï¼Œå¹¶å°†ç»“æœåé¦ˆç»™ä¸­å¤®æœåŠ¡å™¨ã€‚è„‘è£‚æ˜¯åœ¨æŸäº›ç‰¹æ®Šæ¡ä»¶ä¸‹ï¼Œå¦‚ä¸»å¤‡åˆ‡æ¢ï¼ŒSlaveåœ¨ä¸Masterçš„ç½‘ç»œå‡ºç°æ•…éšœçš„æ—¶å€™ï¼ŒSlaveä¼šè®¤ä¸ºMasterå·²ç»æ•…éšœï¼Œä»è€Œæˆä¸ºæ–°çš„masterï¼Œè€ŒåŸæ¥çš„masterä¹Ÿæ²¡æœ‰å¸ä»»ï¼Œä»è€Œå¯¼è‡´å­˜åœ¨ä¸¤ä¸ªMasteråœ¨å¯¹å¤–æœåŠ¡ï¼Œå­˜åœ¨å¤šmasterä¼šå¯¼è‡´å…±äº«èµ„æºçš„äº’æ–¥æ€§é­åˆ°ç ´åï¼Œå‡ºç°èµ„æºäº‰æŠ¢ï¼Œæ•°æ®ä¸ä¸€è‡´ç­‰é—®é¢˜<br><br>æƒŠç¾¤æ•ˆåº”ï¼šæŒ‡å¤šè¿›ç¨‹ï¼ˆå¤šçº¿ç¨‹ï¼‰åœ¨åŒæ—¶é˜»å¡ç­‰å¾…åŒä¸€ä¸ªäº‹ä»¶çš„æ—¶å€™ï¼ˆä¼‘çœ çŠ¶æ€ï¼‰ï¼Œå¦‚æœç­‰å¾…çš„è¿™ä¸ªäº‹ä»¶å‘ç”Ÿï¼Œé‚£ä¹ˆä»–å°±ä¼šå”¤é†’ç­‰å¾…çš„æ‰€æœ‰è¿›ç¨‹ï¼ˆæˆ–è€…çº¿ç¨‹ï¼‰ï¼Œä½†æ˜¯æœ€ç»ˆå´åªèƒ½æœ‰ä¸€ä¸ªè¿›ç¨‹ï¼ˆçº¿ç¨‹ï¼‰è·å¾—è¿™ä¸ªæ—¶é—´çš„â€œæ§åˆ¶æƒâ€ï¼Œå¯¹è¯¥äº‹ä»¶è¿›è¡Œå¤„ç†ï¼Œè€Œå…¶ä»–è¿›ç¨‹ï¼ˆçº¿ç¨‹ï¼‰è·å–â€œæ§åˆ¶æƒâ€å¤±è´¥ï¼Œåªèƒ½é‡æ–°è¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œè¿™ç§ç°è±¡å’Œæ€§èƒ½æµªè´¹å°±å«åšæƒŠç¾¤æ•ˆåº”ã€‚ï¼ˆå½“ä½ å¾€ä¸€ç¾¤é¸½å­ä¸­é—´æ‰”ä¸€å—é£Ÿç‰©ï¼Œè™½ç„¶æœ€ç»ˆåªæœ‰ä¸€ä¸ªé¸½å­æŠ¢åˆ°é£Ÿç‰©ï¼Œä½†æ‰€æœ‰é¸½å­éƒ½ä¼šè¢«æƒŠåŠ¨æ¥äº‰å¤ºï¼Œæ²¡æœ‰æŠ¢åˆ°é£Ÿç‰©çš„é¸½å­åªå¥½å›å»ç»§ç»­ç¡è§‰ï¼Œ ç­‰å¾…ä¸‹ä¸€å—é£Ÿç‰©åˆ°æ¥ã€‚è¿™æ ·ï¼Œæ¯æ‰”ä¸€å—é£Ÿç‰©ï¼Œéƒ½ä¼šæƒŠåŠ¨æ‰€æœ‰çš„é¸½å­ï¼Œå³ä¸ºæƒŠç¾¤ã€‚ï¼‰<br><br>etcdå¦‚ä½•é¿å…æ­»é”ï¼šåˆ©ç”¨Leaseçš„æ´»æ€§æ£€æµ‹æœºåˆ¶ï¼Œå®ƒæä¾›äº†æ£€æµ‹å„ä¸ªå®¢æˆ·ç«¯å­˜æ´»çš„èƒ½åŠ›ã€‚ä½ çš„ä¸šåŠ¡ client éœ€å®šæœŸå‘ etcd æœåŠ¡å‘é€&quot;ç‰¹æ®Šå¿ƒè·³&quot;æ±‡æŠ¥å¥åº·çŠ¶æ€ï¼Œè‹¥ä½ æœªæ­£å¸¸å‘é€å¿ƒè·³ï¼Œå¹¶è¶…è¿‡å’Œ etcd æœåŠ¡çº¦å®šçš„æœ€å¤§å­˜æ´»æ—¶é—´åï¼Œå°±ä¼šè¢« etcd æœåŠ¡ç§»é™¤æ­¤ Lease å’Œå…¶å…³è”çš„æ•°æ®ã€‚é€šè¿‡ Lease æœºåˆ¶å°±ä¼˜é›…åœ°è§£å†³äº† client å‡ºç° crash æ•…éšœã€client ä¸ etcd é›†ç¾¤ç½‘ç»œå‡ºç°éš”ç¦»ç­‰å„ç±»æ•…éšœåœºæ™¯ä¸‹çš„æ­»é”é—®é¢˜ã€‚ä¸€æ—¦è¶…è¿‡ Lease TTLï¼Œå®ƒå°±èƒ½è‡ªåŠ¨è¢«é‡Šæ”¾ï¼Œç¡®ä¿äº†å…¶ä»– client åœ¨ TTL è¿‡æœŸåèƒ½æ­£å¸¸ç”³è¯·é”ï¼Œä¿éšœäº†ä¸šåŠ¡çš„å¯ç”¨æ€§ã€‚<br><br>etcdå¦‚ä½•é¿å…é›†ç¾¤è„‘è£‚ï¼šåœ¨leaderé€‰ä¸¾ä¸Šé‡‡ç”¨äº†è¿‡åŠæœºåˆ¶ï¼Œå³å¾—åˆ°ä¸€åŠä»¥ä¸Šçš„followæ‰èƒ½æˆä¸ºleaderï¼Œä¸”æ–°leaderå°±ä»»åæ—§leaderå¿…é¡»å¸ä»»ï¼Œæ‰€ä»¥etcdä¸å­˜åœ¨è„‘è£‚é—®é¢˜<br><br>etcdå¦‚ä½•é¿å…æƒŠç¾¤æ•ˆåº”ï¼šmutexï¼Œé€šè¿‡ Watch æœºåˆ¶å„è‡ªç›‘å¬ prefix ç›¸åŒï¼Œrevision æ¯”è‡ªå·±å°çš„ keyï¼Œå› ä¸ºåªæœ‰ revision æ¯”è‡ªå·±å°çš„ key é‡Šæ”¾é”ï¼Œæ‰èƒ½æœ‰æœºä¼šï¼Œè·å¾—é”","like_count":9},{"had_liked":false,"id":282628,"user_name":"é‚£æ—¶åˆ»","can_delete":false,"product_type":"c1","uid":1150927,"ip_address":"","ucode":"B0D150856C3A4A","user_header":"https://static001.geekbang.org/account/avatar/00/11/8f/cf/890f82d6.jpg","comment_is_top":false,"comment_ctime":1615343950,"is_pvip":false,"replies":[{"id":"102611","content":"èµï¼Œæˆ‘è¡¥å……ä¸€ç‚¹ï¼Œå¤šä¸ªclienté€šè¿‡å†™åŒkeyæŠ¢åŒæŠŠé”ï¼Œä¸»è¦æœ‰æƒŠç¾¤æ•ˆåº”ï¼ŒåŒæ—¶è·å–é”æ€§èƒ½ä¹Ÿä½ç‚¹ï¼Œæ¯•ç«Ÿæ˜¯éœ€è¦å®æ—¶å†™å…¥ç›¸å…³keyçš„ï¼Œè€Œåè€…ï¼Œrevisionæ˜¯æŒ‰æ—¶é—´å…¨å±€é€’å¢çš„ï¼Œå› æ­¤æ–°çš„client å†™å…¥çš„key revisionä¼šæ¯”è¾ƒå¤§ï¼Œæ‹¿é”çš„é¡ºåºå¯ä»¥ç†è§£ä¸ºæŒ‰æ—¶é—´é¡ºåºæ’é˜Ÿã€‚ ","user_name":"ä½œè€…å›å¤","user_name_real":"å”èª","uid":"1009582","ctime":1615373424,"ip_address":"","comment_id":282628,"utype":1}],"discussion_count":1,"race_medal":0,"score":"31680115022","product_id":100069901,"comment_content":"è€å¸ˆæ–‡ä¸­æåˆ°çš„æ€è€ƒé¢˜ï¼Œå¤šä¸ªclientæŠ¢åŒä¸€æŠŠé”ä¸å¤šä¸ªclientå„è‡ªæŠ¢è‡ªå·±çš„é”ã€‚æˆ‘çš„æƒ³æ³•æ˜¯å¤šä¸ªclientæŠ¢åŒä¸€æŠŠé”ï¼Œåœ¨clientæ•°ç›®å¤šçš„æ—¶å€™ï¼ŒåŒä¸€æŠŠé”çš„ç«äº‰æ¯”è¾ƒæ¿€çƒˆã€‚è€Œå¤šä¸ªclientå„è‡ªæŠ¢å„è‡ªçš„é”ï¼Œä¼šæœ‰é”é¥¥é¥¿é—®é¢˜ï¼Œæ¯”å¦‚æ–°çš„clientå› å…¶versionæ¯”è¾ƒå°ï¼Œæ›´å®¹æ˜“è·å¾—é”ã€‚<br><br>","like_count":7,"discussions":[{"author":{"id":1009582,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/67/ae/37b492db.jpg","nickname":"å”èª","note":"","ucode":"99CB061EDF35EA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":516795,"discussion_content":"èµï¼Œæˆ‘è¡¥å……ä¸€ç‚¹ï¼Œå¤šä¸ªclienté€šè¿‡å†™åŒkeyæŠ¢åŒæŠŠé”ï¼Œä¸»è¦æœ‰æƒŠç¾¤æ•ˆåº”ï¼ŒåŒæ—¶è·å–é”æ€§èƒ½ä¹Ÿä½ç‚¹ï¼Œæ¯•ç«Ÿæ˜¯éœ€è¦å®æ—¶å†™å…¥ç›¸å…³keyçš„ï¼Œè€Œåè€…ï¼Œrevisionæ˜¯æŒ‰æ—¶é—´å…¨å±€é€’å¢çš„ï¼Œå› æ­¤æ–°çš„client å†™å…¥çš„key revisionä¼šæ¯”è¾ƒå¤§ï¼Œæ‹¿é”çš„é¡ºåºå¯ä»¥ç†è§£ä¸ºæŒ‰æ—¶é—´é¡ºåºæ’é˜Ÿã€‚ ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1615373424,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":283931,"user_name":"çŸ³å°","can_delete":false,"product_type":"c1","uid":1781893,"ip_address":"","ucode":"4258C686F289A6","user_header":"https://static001.geekbang.org/account/avatar/00/1b/30/85/14c2f16c.jpg","comment_is_top":false,"comment_ctime":1615987485,"is_pvip":false,"replies":[{"id":"104113","content":"æœ‰çš„,etcdæä¾›äº†å¦‚ä¸‹ä¸¤ä¸ªå‚æ•°å¯ä»¥æ§åˆ¶äº‹åŠ¡æäº¤çš„è¡Œä¸ºã€‚<br>--backend-batch-interval &#39;&#39;<br>    BackendBatchInterval is the maximum time before commit the backend transaction.<br>  --backend-batch-limit &#39;0&#39;<br>    BackendBatchLimit is the maximum operations before commit the backend transaction.<br>åœ¨etcd v3.4.9ä¸­ï¼Œbackend-batch-intervalå¦‚æœä½ æ²¡æŒ‡å®šï¼Œé»˜è®¤æ˜¯100msï¼Œå¯¹åº”çš„å¼‚æ­¥goroutineå°†æ‰¹é‡ã€æ¯éš”100msï¼Œå°†boltdbäº‹åŠ¡è¿›è¡Œæäº¤ã€‚<br>backend-batch-limité»˜è®¤æ˜¯10000ï¼Œå½“å †ç§¯çš„put&#47;delç­‰æ“ä½œè‹¥è¶…è¿‡10000ä¸ªï¼Œåˆ™ä¼šåŒæ­¥è§¦å‘boltdbäº‹åŠ¡æäº¤<br>ï¼Œè‹¥boltdbäº‹åŠ¡æŒä¹…åŒ–å¤±è´¥ï¼Œåˆ™ä¼šå¼‚å¸¸é€€å‡ºï¼Œé‡å¯æ—¶ä¼šé‡æ”¾æœ€æ–°WALæ—¥å¿—ä¸­å·²æäº¤çš„æ—¥å¿—æ¡ç›®ï¼Œå†æ¬¡æ‰§è¡Œã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å”èª","uid":"1009582","ctime":1617470099,"ip_address":"","comment_id":283931,"utype":1}],"discussion_count":2,"race_medal":0,"score":"18795856669","product_id":100069901,"comment_content":"å”è€å¸ˆå¥½ï¼Œetcdæœ‰åƒinnodbé‚£æ ·èƒ½èƒ½æ§åˆ¶æŒä¹…åŒ–ç¨‹åº¦çš„é…ç½®(ä¸»è¦æŒ‡å¤šä¹…fsyncä¸€æ¬¡ç£ç›˜)å—ï¼Ÿæˆ–è€…è¯´ï¼Œetcdå¯èƒ½å‡ºç°æŒä¹…åŒ–å¤±è´¥(å†™å…¥ç£ç›˜ç¼“å­˜ï¼Œæ²¡fsync)å—ï¼Ÿå¦‚æœæŒä¹…åŒ–å¤±è´¥ä¼šæœ‰å“ªäº›å½±å“ï¼Ÿ","like_count":4,"discussions":[{"author":{"id":1009582,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/67/ae/37b492db.jpg","nickname":"å”èª","note":"","ucode":"99CB061EDF35EA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":517183,"discussion_content":"æœ‰çš„,etcdæä¾›äº†å¦‚ä¸‹ä¸¤ä¸ªå‚æ•°å¯ä»¥æ§åˆ¶äº‹åŠ¡æäº¤çš„è¡Œä¸ºã€‚\n--backend-batch-interval &amp;#39;&amp;#39;\n    BackendBatchInterval is the maximum time before commit the backend transaction.\n  --backend-batch-limit &amp;#39;0&amp;#39;\n    BackendBatchLimit is the maximum operations before commit the backend transaction.\nåœ¨etcd v3.4.9ä¸­ï¼Œbackend-batch-intervalå¦‚æœä½ æ²¡æŒ‡å®šï¼Œé»˜è®¤æ˜¯100msï¼Œå¯¹åº”çš„å¼‚æ­¥goroutineå°†æ‰¹é‡ã€æ¯éš”100msï¼Œå°†boltdbäº‹åŠ¡è¿›è¡Œæäº¤ã€‚\nbackend-batch-limité»˜è®¤æ˜¯10000ï¼Œå½“å †ç§¯çš„put/delç­‰æ“ä½œè‹¥è¶…è¿‡10000ä¸ªï¼Œåˆ™ä¼šåŒæ­¥è§¦å‘boltdbäº‹åŠ¡æäº¤\nï¼Œè‹¥boltdbäº‹åŠ¡æŒä¹…åŒ–å¤±è´¥ï¼Œåˆ™ä¼šå¼‚å¸¸é€€å‡ºï¼Œé‡å¯æ—¶ä¼šé‡æ”¾æœ€æ–°WALæ—¥å¿—ä¸­å·²æäº¤çš„æ—¥å¿—æ¡ç›®ï¼Œå†æ¬¡æ‰§è¡Œã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617470099,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1781893,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/30/85/14c2f16c.jpg","nickname":"çŸ³å°","note":"","ucode":"4258C686F289A6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":366800,"discussion_content":"æˆ‘é—®çš„ä¸å¤ªæ˜ç™½å“ˆğŸ˜„ï¼Œæ˜¯è¿™æ ·çš„ï¼šmysqlå¯ä»¥æ§åˆ¶åˆ·æ—¥å¿—ï¼ˆé€šè¿‡innodb_flush_log_at_trx_commitï¼‰ï¼Œé€šè¿‡è¿™ä¸ªæ—¥å¿—èƒ½æ§åˆ¶åˆ·ç£ç›˜ï¼Œä¹Ÿä¼šå½±å“åˆ°äº‹åŠ¡æäº¤æˆè´¥ã€‚etcdæœ‰ç±»ä¼¼è¿™æ ·æ§åˆ¶æ—¥å¿—åˆ·æ–°çš„æ§åˆ¶å—ï¼Ÿè¿˜æ˜¯è¯´etcdæ¯æ¬¡æäº¤å¿…é¡»åˆ·ç£ç›˜ï¼ˆå†™walæ—¥å¿—ï¼‰ï¼Œä¿è¯äº†äº‹åŠ¡ä¸€å®šä¼šæäº¤æˆåŠŸï¼ˆå³ä½¿boltdbå†™å…¥å¤±è´¥ï¼‰,å¦‚æœæ˜¯è¿™æ ·çš„ï¼Œé—®ä»€ä¹ˆetcdè¦è¿™æ ·è®¾è®¡ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618193782,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":282867,"user_name":"types","can_delete":false,"product_type":"c1","uid":2449777,"ip_address":"","ucode":"8B50927EF1804F","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLDUJyeq54fiaXAgF62tNeocO3lHsKT4mygEcNoZLnibg6ONKicMgCgUHSfgW8hrMUXlwpNSzR8MHZwg/132","comment_is_top":false,"comment_ctime":1615446772,"is_pvip":false,"replies":[{"id":"102679","content":"å—¯ï¼Œæœ€ä¸»è¦æ˜¯æƒŠç¾¤æ•ˆåº”ï¼Œæ‰€æœ‰clientéƒ½ä¼šæ”¶åˆ°ç›¸åº”keyè¢«åˆ é™¤æ¶ˆæ¯ï¼Œéƒ½ä¼šå°è¯•å‘èµ·äº‹åŠ¡ï¼Œå†™å…¥keyï¼Œæ€§èƒ½ä¼šæ¯”è¾ƒå·®","user_name":"ä½œè€…å›å¤","user_name_real":"å”èª","uid":"1009582","ctime":1615476986,"ip_address":"","comment_id":282867,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18795315956","product_id":100069901,"comment_content":"ä½ è¦æ³¨æ„çš„æ˜¯ï¼Œå®ç°åˆ†å¸ƒå¼é”çš„æ–¹æ¡ˆæœ‰å¤šç§ï¼Œæ¯”å¦‚ä½ å¯ä»¥é€šè¿‡ client æ˜¯å¦æˆåŠŸåˆ›å»ºä¸€ä¸ªå›ºå®šçš„ keyï¼Œæ¥åˆ¤æ–­æ­¤ client æ˜¯å¦è·å¾—é”ï¼Œä½ ä¹Ÿå¯ä»¥é€šè¿‡å¤šä¸ª client åˆ›å»º prefix ç›¸åŒï¼Œåç§°ä¸ä¸€æ ·çš„ keyï¼Œå“ªä¸ª key çš„ revision æœ€å°ï¼Œæœ€ç»ˆå°±æ˜¯å®ƒè·å¾—é”ã€‚è‡³äºè°ä¼˜è°åŠ£ï¼Œæˆ‘ä½œä¸ºæ€è€ƒé¢˜çš„ä¸€éƒ¨åˆ†ï¼Œç•™ç»™å¤§å®¶ä¸€èµ·è®¨è®ºã€‚<br>1. æŒ‰ç…§æ–‡ä¸­ä»‹ç»concurrencyåŒ…ä¸­ç”¨çš„æ˜¯prefix<br>2. å¦‚æœä½¿ç”¨ç›¸åŒçš„keyï¼Œæˆ‘èƒ½å¤Ÿæƒ³åˆ°å­˜åœ¨çš„é—®é¢˜,åœ¨é‡Šæ”¾é”åï¼Œä¼šå¯¼è‡´è·å–é”çš„äº‹åŠ¡åŒæ—¶å‘ç”Ÿï¼Œäº‹åŠ¡æ•°é‡å˜å¾—å¾ˆå¤§<br>","like_count":4,"discussions":[{"author":{"id":1009582,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/67/ae/37b492db.jpg","nickname":"å”èª","note":"","ucode":"99CB061EDF35EA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":516862,"discussion_content":"å—¯ï¼Œæœ€ä¸»è¦æ˜¯æƒŠç¾¤æ•ˆåº”ï¼Œæ‰€æœ‰clientéƒ½ä¼šæ”¶åˆ°ç›¸åº”keyè¢«åˆ é™¤æ¶ˆæ¯ï¼Œéƒ½ä¼šå°è¯•å‘èµ·äº‹åŠ¡ï¼Œå†™å…¥keyï¼Œæ€§èƒ½ä¼šæ¯”è¾ƒå·®","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1615476986,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":334541,"user_name":"Geek_604077","can_delete":false,"product_type":"c1","uid":1969081,"ip_address":"","ucode":"3BDCDCA9187514","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/ib3Rzem884S5MOS96THy0gQXcF26PNsnRBpyr3pM5rVibZdYvAibpVvAGfibF1ddpgrteg9fQUsq4vce9EM95Jj97Q/132","comment_is_top":false,"comment_ctime":1644994382,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10234928974","product_id":100069901,"comment_content":"è‹¥ä½ é”è®¾ç½®çš„ 10 ç§’ï¼Œå¦‚æœä½ çš„æŸä¸šåŠ¡è¿›ç¨‹æŠ¢é”æˆåŠŸåï¼Œæ‰§è¡Œå¯èƒ½ä¼šè¶…è¿‡ 10 ç§’æ‰æˆåŠŸï¼Œåœ¨è¿™è¿‡ç¨‹ä¸­å¦‚ä½•é¿å…é”è¢«è‡ªåŠ¨é‡Šæ”¾è€Œå‡ºç°çš„å®‰å…¨æ€§é—®é¢˜å‘¢?<br>åŠ é”æ—¶ï¼Œå…ˆè®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´ï¼Œç„¶åæˆ‘ä»¬å¼€å¯ä¸€ä¸ªã€Œå®ˆæŠ¤çº¿ç¨‹ã€ï¼Œå®šæ—¶å»æ£€æµ‹è¿™ä¸ªé”çš„å¤±æ•ˆæ—¶é—´ï¼Œå¦‚æœé”å¿«è¦è¿‡æœŸäº†ï¼Œæ“ä½œå…±äº«èµ„æºè¿˜æœªå®Œæˆï¼Œé‚£ä¹ˆå°±è‡ªåŠ¨å¯¹é”è¿›è¡Œã€Œç»­æœŸã€ï¼Œé‡æ–°è®¾ç½®è¿‡æœŸæ—¶é—´ã€‚<br><br>å¹¸è¿çš„æ˜¯ï¼Œå·²ç»æœ‰ä¸€ä¸ªåº“æŠŠè¿™äº›å·¥ä½œéƒ½å°è£…å¥½äº†ï¼šRedissonã€‚<br><br>Redisson æ˜¯ä¸€ä¸ª Java è¯­è¨€å®ç°çš„ Redis SDK å®¢æˆ·ç«¯ï¼Œåœ¨ä½¿ç”¨åˆ†å¸ƒå¼é”æ—¶ï¼Œå®ƒå°±é‡‡ç”¨äº†ã€Œè‡ªåŠ¨ç»­æœŸã€çš„æ–¹æ¡ˆæ¥é¿å…é”è¿‡æœŸï¼Œè¿™ä¸ªå®ˆæŠ¤çº¿ç¨‹æˆ‘ä»¬ä¸€èˆ¬ä¹ŸæŠŠå®ƒå«åšã€Œçœ‹é—¨ç‹—ã€çº¿ç¨‹ã€‚","like_count":2},{"had_liked":false,"id":324494,"user_name":"Yang","can_delete":false,"product_type":"c1","uid":1891504,"ip_address":"","ucode":"6CC4DCAFFD7C03","user_header":"https://static001.geekbang.org/account/avatar/00/1c/dc/b0/5b652423.jpg","comment_is_top":false,"comment_ctime":1638456646,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"5933423942","product_id":100069901,"comment_content":"etcdå®ç°çš„åˆ†å¸ƒå¼æ‰€èƒ½ä¿è¯é«˜æ€§èƒ½ä¸","like_count":2},{"had_liked":false,"id":354763,"user_name":"æ˜Ÿæ˜Ÿ","can_delete":false,"product_type":"c1","uid":1202481,"ip_address":"å¹¿ä¸œ","ucode":"868E88A96313AE","user_header":"https://static001.geekbang.org/account/avatar/00/12/59/31/3820fbb7.jpg","comment_is_top":false,"comment_ctime":1660751174,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1660751174","product_id":100069901,"comment_content":"å¼ºè¡Œå¹ <br>Redisson æˆ–è€…ä½ è‡ªå·±å†™ä¸ªwatchdog éƒ½å¯ä»¥è§£å†³ç»­æœŸé—®é¢˜ <br>æœ¬è´¨ä¸Šzk çš„å¿ƒè·³ç»´æŒå°±æ˜¯ client åœ¨è‡ªåŠ¨ç»­æœŸ<br><br>ä¸ºä»€ä¹ˆè¿™ä¹ˆå¤šäººä½¿ç”¨redis è¿˜æ˜¯å› ä¸ºredis è¯»å†™æ€§èƒ½è¿œè¶… zk etcd","like_count":0},{"had_liked":false,"id":350873,"user_name":"è èpower","can_delete":false,"product_type":"c1","uid":1132050,"ip_address":"","ucode":"8B3DA9859187C5","user_header":"https://static001.geekbang.org/account/avatar/00/11/46/12/965a6cc9.jpg","comment_is_top":false,"comment_ctime":1657268203,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1657268203","product_id":100069901,"comment_content":"è¿™ä¸ªå’Œlock APIæœ‰ä»€ä¹ˆåŒºåˆ«å— server&#47;etcdserver&#47;api&#47;v3lock&#47;v3lockpb&#47;v3lock.proto","like_count":0},{"had_liked":false,"id":339856,"user_name":"chongsheng","can_delete":false,"product_type":"c1","uid":1368768,"ip_address":"","ucode":"859DF328FCA608","user_header":"https://static001.geekbang.org/account/avatar/00/14/e2/c0/e7a59706.jpg","comment_is_top":false,"comment_ctime":1648437986,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1648437986","product_id":100069901,"comment_content":"å¦‚æœç”¨etcdï¼Œèƒ½æŒ‡å®šé”çš„è‡ªåŠ¨é‡Šæ”¾æ—¶é—´å—ï¼Ÿæˆ‘çœ‹NewSessionæ–¹æ³•é‡Œå¯¹leaseåšäº†keepaliveï¼Œåªè¦ä¸unlockæˆ–è€…å´©æºƒï¼Œæ˜¯ä¸æ˜¯ä¸€ç›´æŒæœ‰é”å‘¢ï¼Ÿ","like_count":0},{"had_liked":false,"id":311632,"user_name":"æ±Ÿå±±å¦‚ç”»","can_delete":false,"product_type":"c1","uid":1188280,"ip_address":"","ucode":"BEB6228E6135B5","user_header":"https://static001.geekbang.org/account/avatar/00/12/21/b8/aca814dd.jpg","comment_is_top":false,"comment_ctime":1631353861,"is_pvip":false,"replies":[{"id":"113031","content":"æ„Ÿè°¢åˆ†äº«ï¼Œæœ€è¿‘æˆ‘åœ¨æå®¢æ—¶é—´ç›´æ’­ä¸­ä¹Ÿåˆ†äº«äº†æ›´å¤šk8sæœ€ä½³å®è·µæ¡ˆä¾‹, åé¢ä¹Ÿå°†æ•´ç†åˆ°ä¸“æ ä¸­ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å”èª","uid":"1009582","ctime":1631545976,"ip_address":"","comment_id":311632,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1631353861","product_id":100069901,"comment_content":"æˆ‘æœ€è¿‘åœ¨åšçš„å·¥ä½œä¸­é‡åˆ°äº†åˆ†å¸ƒå¼é”ï¼Œè¿™ç¯‡æ–‡ç« è§£å†³äº†å·¥ä½œä¸­çš„å¾ˆå¤šç–‘æƒ‘ï¼Œå¿ä¸ä½æƒ³è¦åˆ†äº«ç»™åŒäº‹ä»¬ï¼Œé€»è¾‘åˆç†ï¼Œåˆ‡ä¸­è¦å®³ï¼Œå†™çš„å¤ªèµäº†ã€‚","like_count":0,"discussions":[{"author":{"id":1009582,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/67/ae/37b492db.jpg","nickname":"å”èª","note":"","ucode":"99CB061EDF35EA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":526687,"discussion_content":"æ„Ÿè°¢åˆ†äº«ï¼Œæœ€è¿‘æˆ‘åœ¨æå®¢æ—¶é—´ç›´æ’­ä¸­ä¹Ÿåˆ†äº«äº†æ›´å¤šk8sæœ€ä½³å®è·µæ¡ˆä¾‹, åé¢ä¹Ÿå°†æ•´ç†åˆ°ä¸“æ ä¸­ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631545976,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":306727,"user_name":"æƒ˜ é—»","can_delete":false,"product_type":"c1","uid":1181650,"ip_address":"","ucode":"C5909F034BF072","user_header":"https://static001.geekbang.org/account/avatar/00/12/07/d2/0d7ee298.jpg","comment_is_top":false,"comment_ctime":1628682893,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1628682893","product_id":100069901,"comment_content":"å¦‚æœè·å–é”çš„client crashäº†ã€‚  å…¶ä»–çš„clientç›‘å¬åˆ°deleteåè·å–åˆ°äº†é”ï¼Œä½†æ˜¯ç¬¬ä¸€ä¸ªclientå…¶å®åªæ˜¯å› ä¸ºç½‘ç»œåŸå› æ²¡æœ‰å‘é€leaseï¼Œä½†æ˜¯å®ƒæ¢å¤åç»§ç»­æ‰§è¡Œä»£ç ã€‚å°±ç›¸å½“äºä¸€ä¸ªèµ„æºè¢«ä¸¤ä¸ªclientæ“ä½œäº†å•Šã€‚","like_count":0},{"had_liked":false,"id":300988,"user_name":"ç‹¬å­¤ä¹å‰‘","can_delete":false,"product_type":"c1","uid":2230909,"ip_address":"","ucode":"6C1253E2B8C1D4","user_header":"https://static001.geekbang.org/account/avatar/00/22/0a/7d/ac715471.jpg","comment_is_top":false,"comment_ctime":1625478101,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1625478101","product_id":100069901,"comment_content":"é¢è¯•ä¸æ€•åˆ†å¸ƒå¼é”é—®é¢˜äº†","like_count":0},{"had_liked":false,"id":288042,"user_name":"@%åˆ%@","can_delete":false,"product_type":"c1","uid":1053509,"ip_address":"","ucode":"2B8A6134675ED7","user_header":"https://static001.geekbang.org/account/avatar/00/10/13/45/16c60da2.jpg","comment_is_top":false,"comment_ctime":1618279937,"is_pvip":true,"replies":[{"id":"104903","content":"å—¯ï¼Œæ€§èƒ½ä¹Ÿè¦è€ƒè™‘ä¸‹","user_name":"ä½œè€…å›å¤","user_name_real":"å”èª","uid":"1009582","ctime":1618887981,"ip_address":"","comment_id":288042,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1618279937","product_id":100069901,"comment_content":"æˆ‘ç†è§£å¤šä¸ªå®¢æˆ·ç«¯å†™ä¸€ä¸ªkeyï¼Œä¸å¤šä¸ªå®¢æˆ·ç«¯å†™å¤šä¸ªkeyï¼Œå¯ä»¥ç†è§£ä¸ºéå…¬å¹³é”ä¸å…¬å¹³é”ã€‚ä¸»è¦è¿˜æ˜¯è¦çœ‹ä¸šåŠ¡åœºæ™¯å¤„ç†ã€‚","like_count":0,"discussions":[{"author":{"id":1009582,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/67/ae/37b492db.jpg","nickname":"å”èª","note":"","ucode":"99CB061EDF35EA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":518499,"discussion_content":"å—¯ï¼Œæ€§èƒ½ä¹Ÿè¦è€ƒè™‘ä¸‹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618887981,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}