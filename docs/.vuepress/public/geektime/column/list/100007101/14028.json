{"id":14028,"title":"åè®®ä¸“æ ç‰¹åˆ«ç¦åˆ© | ç­”ç–‘è§£æƒ‘ç¬¬ä¸‰æœŸ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯åˆ˜è¶…ã€‚</p><p>ç¬¬ä¸‰æœŸç­”ç–‘æ¶µç›–ç¬¬7è®²è‡³ç¬¬13è®²çš„å†…å®¹ã€‚æˆ‘ä¾æ—§å¯¹è¯¾åæ€è€ƒé¢˜å’Œç•™è¨€ä¸­æ¯”è¾ƒæœ‰ä»£è¡¨æ€§çš„é—®é¢˜ä½œå‡ºå›ç­”ã€‚ä½ å¯ä»¥ç‚¹å‡»æ–‡ç« åï¼Œå›åˆ°å¯¹åº”çš„ç« èŠ‚å¤ä¹ ï¼Œä¹Ÿå¯ä»¥ç»§ç»­åœ¨ç•™è¨€åŒºå†™ä¸‹ä½ çš„ç–‘é—®ï¼Œæˆ‘ä¼šæŒç»­ä¸æ–­åœ°è§£ç­”ã€‚å¸Œæœ›å¯¹ä½ æœ‰å¸®åŠ©ã€‚</p><h2><a href=\"https://time.geekbang.org/column/article/8445\">ã€Š</a><a href=\"https://time.geekbang.org/column/article/8445\">ç¬¬7è®² | ICMPä¸pingï¼šæŠ•çŸ³é—®è·¯çš„ä¾¦å¯Ÿå…µ</a><a href=\"https://time.geekbang.org/column/article/8445\">ã€‹</a></h2><h3>è¯¾åæ€è€ƒé¢˜</h3><p><span class=\"orange\">å½“å‘é€çš„æŠ¥æ–‡å‡ºé—®é¢˜çš„æ—¶å€™ï¼Œä¼šå‘é€ä¸€ä¸ªICMPçš„å·®é”™æŠ¥æ–‡æ¥æŠ¥å‘Šé”™è¯¯ï¼Œä½†æ˜¯å¦‚æœ ICMP çš„å·®é”™æŠ¥æ–‡ä¹Ÿå‡ºé—®é¢˜äº†å‘¢ï¼Ÿ</span></p><p>æˆ‘æ€»ç»“äº†ä¸€ä¸‹ï¼Œä¸ä¼šå¯¼è‡´äº§ç”ŸICMPå·®é”™æŠ¥æ–‡çš„æœ‰ï¼š</p><ul>\n<li>\n<p>ICMPå·®é”™æŠ¥æ–‡ï¼ˆICMPæŸ¥è¯¢æŠ¥æ–‡å¯èƒ½ä¼šäº§ç”ŸICMPå·®é”™æŠ¥æ–‡ï¼‰ï¼›</p>\n</li>\n<li>\n<p>ç›®çš„åœ°å€æ˜¯å¹¿æ’­åœ°å€æˆ–å¤šæ’­åœ°å€çš„IPæ•°æ®æŠ¥ï¼›</p>\n</li>\n<li>\n<p>ä½œä¸ºé“¾è·¯å±‚å¹¿æ’­çš„æ•°æ®æŠ¥ï¼›</p>\n</li>\n<li>\n<p>ä¸æ˜¯IPåˆ†ç‰‡çš„ç¬¬ä¸€ç‰‡ï¼›</p>\n</li>\n<li>\n<p>æºåœ°å€ä¸æ˜¯å•ä¸ªä¸»æœºçš„æ•°æ®æŠ¥ã€‚è¿™å°±æ˜¯è¯´ï¼Œæºåœ°å€ä¸èƒ½ä¸ºé›¶åœ°å€ã€ç¯å›åœ°å€ã€å¹¿æ’­åœ°å€æˆ–å¤šæ’­åœ°å€ã€‚</p>\n</li>\n</ul><h3>ç•™è¨€é—®é¢˜</h3><p><span class=\"orange\">1.pingä½¿ç”¨çš„æ˜¯ä»€ä¹ˆç½‘ç»œç¼–ç¨‹æ¥å£ï¼Ÿ</span></p><p><img src=\"https://static001.geekbang.org/resource/image/3b/e6/3b2b3f4abaed8a485e8933efbcc304e6.png?wh=750*1117\" alt=\"\"></p><p>å’±ä»¬ä½¿ç”¨çš„ç½‘ç»œç¼–ç¨‹æ¥å£æ˜¯Socketï¼Œå¯¹äºpingæ¥è®²ï¼Œä½¿ç”¨çš„æ˜¯ICMPï¼Œåˆ›å»ºSocketå¦‚ä¸‹ï¼š</p><pre><code>socket(AF_INET, SOCK_RAW, IPPROTO_ICMP)\n</code></pre><p>SOCK_RAWå°±æ˜¯åŸºäºIPå±‚åè®®å»ºç«‹é€šä¿¡æœºåˆ¶ã€‚</p><p>å¦‚æœæ˜¯TCPï¼Œåˆ™å»ºç«‹ä¸‹é¢çš„Socketï¼š</p><pre><code>socket(AF_INET, SOCK_STREAM, IPPROTO_TCP)\n</code></pre><p>å¦‚æœæ˜¯UDPï¼Œåˆ™å»ºç«‹ä¸‹é¢çš„Socketï¼š</p><pre><code>socket(AF_INET, SOCK_DGRAM, IPPROTO_UDP)\n</code></pre><!-- [[[read_end]]] --><p><span class=\"orange\">2.ICMPå·®é”™æŠ¥æ–‡æ˜¯è°å‘é€çš„å‘¢ï¼Ÿ</span></p><p>æˆ‘çœ‹ç•™è¨€é‡Œæœ‰å¾ˆå¤šäººå¯¹è¿™ä¸ªé—®é¢˜æœ‰ç–‘æƒ‘ã€‚ICMPåŒ…æ˜¯ç”±å†…æ ¸è¿”å›çš„ï¼Œåœ¨å†…æ ¸ä¸­ï¼Œæœ‰ä¸€ä¸ªå‡½æ•°ç”¨äºå‘é€ICMPçš„åŒ…ã€‚</p><pre><code>void icmp_send(struct sk_buff *skb_in, int type, int code, __be32 info);\n</code></pre><p>ä¾‹å¦‚ï¼Œç›®æ ‡ä¸å¯è¾¾ï¼Œä¼šè°ƒç”¨ä¸‹é¢çš„å‡½æ•°ã€‚</p><pre><code>icmp_send(skb, ICMP_DEST_UNREACH, ICMP_PROT_UNREACH, 0);\n</code></pre><p>å½“IPå¤§å°è¶…è¿‡MTUçš„æ—¶å€™ï¼Œå‘é€éœ€è¦åˆ†ç‰‡çš„ICMPã€‚</p><pre><code>if (ip_exceeds_mtu(skb, mtu)) {\n  icmp_send(skb, ICMP_DEST_UNREACH, ICMP_FRAG_NEEDED, htonl(mtu));\n  goto drop;\n }\n</code></pre><h2><a href=\"https://time.geekbang.org/column/article/8590\">ã€Šç¬¬8è®² | ä¸–ç•Œè¿™ä¹ˆå¤§ï¼Œæˆ‘æƒ³å‡ºç½‘å…³ï¼šæ¬§æ´²åå›½æ¸¸ä¸ç„å¥˜è¥¿è¡Œã€‹</a></h2><h3>è¯¾åæ€è€ƒé¢˜</h3><p><span class=\"orange\">å½“åœ¨ä½ å®¶é‡Œè¦è®¿é—® 163 ç½‘ç«™çš„æ—¶å€™ï¼Œä½ çš„åŒ…éœ€è¦ NAT æˆä¸ºå…¬ç½‘ IPï¼Œè¿”å›çš„åŒ…åˆè¦ NAT æˆä½ çš„ç§æœ‰ IPï¼Œè¿”å›åŒ…æ€ä¹ˆçŸ¥é“è¿™æ˜¯ä½ çš„è¯·æ±‚å‘¢ï¼Ÿå®ƒæ€ä¹ˆèƒ½è¿™ä¹ˆæ™ºèƒ½åœ° NAT æˆäº†ä½ çš„ IP è€Œéåˆ«äººçš„ IP å‘¢ï¼Ÿ</span></p><p>è¿™æ˜¯ä¸ªæ¯”è¾ƒå¤æ‚çš„äº‹æƒ…ã€‚åœ¨è®²äº‘ä¸­ç½‘ç»œå®‰å…¨é‡Œçš„iptablesæ—¶ï¼Œæˆ‘ä»¬è®²è¿‡conntrackåŠŸèƒ½ï¼Œå®ƒè®°å½•äº†SNATä¸€å»ä¸€å›çš„å¯¹åº”å…³ç³»ã€‚</p><p>å¦‚æœç¼–è¯‘å†…æ ¸æ—¶å¼€å¯äº†è¿æ¥è·Ÿè¸ªé€‰é¡¹ï¼Œé‚£ä¹ˆLinuxç³»ç»Ÿå°±ä¼šä¸ºå®ƒæ”¶åˆ°çš„æ¯ä¸ªæ•°æ®åŒ…ç»´æŒä¸€ä¸ªè¿æ¥çŠ¶æ€ï¼Œç”¨äºè®°å½•è¿™æ¡æ•°æ®è¿æ¥çš„çŠ¶æ€ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/a9/fc/a924ccda5d54bcad6f67fdebe0a6c1fc.jpg?wh=958*432\" alt=\"\"></p><p>æ ¹æ®å’±ä»¬å­¦è¿‡çš„Netfilterçš„æµç¨‹å›¾ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œç½‘ç»œåŒ…æœ‰ä¸‰ç§è·¯å¾„ï¼š</p><ul>\n<li>\n<p>å‘ç»™æˆ‘çš„ï¼Œä»PREROUTINGåˆ°INPUTï¼Œæˆ‘å°±æ¥æ”¶äº†ï¼›</p>\n</li>\n<li>\n<p>æˆ‘å‘ç»™åˆ«äººçš„ï¼Œä»OUTPUTåˆ°POSTROUTINGï¼Œå°±å‘å‡ºå»çš„ï¼›</p>\n</li>\n<li>\n<p>ä»æˆ‘è¿™é‡Œç»è¿‡çš„ï¼Œä»PREROUTINGåˆ°FORWARDåˆ°POSTROUTINGã€‚</p>\n</li>\n</ul><p>å¦‚æœè¦è·Ÿè¸ªä¸€ä¸ªç½‘ç»œåŒ…ï¼Œå¯¹äºæ¯ä¸€ç§è·¯å¾„ï¼Œéƒ½éœ€è¦è®¾ç½®ä¸¤ä¸ªè®°å½•ç‚¹ï¼Œç›¸å½“äºæ‰“ä¸¤æ¬¡å¡ï¼Œè¿™æ ·å†…æ ¸æ‰çŸ¥é“è¿™ä¸ªåŒ…çš„çŠ¶æ€ã€‚</p><p>å¯¹äºè¿™ä¸‰ç§è·¯å¾„ï¼Œæ‰“å¡çš„ç‚¹æ˜¯è¿™æ ·è®¾ç½®çš„ï¼š</p><ul>\n<li>\n<p>å‘ç»™æˆ‘çš„ï¼Œåœ¨PREROUTINGè°ƒç”¨ipv4_conntrack_inï¼Œåˆ›å»ºè¿æ¥è·Ÿè¸ªè®°å½•ï¼›åœ¨INPUTè°ƒç”¨ipv4_confirmï¼Œå°†è¿™ä¸ªè¿æ¥è·Ÿè¸ªè®°å½•æŒ‚åœ¨å†…æ ¸çš„è¿æ¥è·Ÿè¸ªè¡¨é‡Œé¢ã€‚ä¸ºä»€ä¹ˆä¸ä¸€å¼€å§‹å°±æŒ‚åœ¨å†…æ ¸çš„è¿æ¥è·Ÿè¸ªè¡¨é‡Œé¢å‘¢ï¼Ÿå› ä¸ºæœ‰filterè¡¨ï¼Œä¸€æ—¦æŠŠåŒ…è¿‡æ»¤äº†ï¼Œä¹Ÿå°±æ˜¯ä¸¢å¼ƒäº†ï¼Œé‚£æ ¹æœ¬æ²¡å¿…è¦è®°å½•è¿™ä¸ªè¿æ¥äº†ã€‚</p>\n</li>\n<li>\n<p>æˆ‘å‘ç»™åˆ«äººçš„ï¼Œåœ¨OUTPUTè°ƒç”¨ipv4_conntrack_localï¼Œåˆ›å»ºè¿æ¥è·Ÿè¸ªè®°å½•ï¼Œåœ¨POSTROUTINGè°ƒç”¨ipv4_confirmï¼Œå°†è¿™ä¸ªè¿æ¥è·Ÿè¸ªè®°å½•æŒ‚åœ¨å†…æ ¸çš„è¿æ¥è·Ÿè¸ªè¡¨é‡Œé¢ã€‚</p>\n</li>\n<li>\n<p>ä»æˆ‘è¿™é‡Œç»è¿‡çš„ï¼Œåœ¨PREROUTINGè°ƒç”¨ipv4_conntrack_inï¼Œåˆ›å»ºè¿æ¥è·Ÿè¸ªè®°å½•ï¼Œåœ¨POSTROUTINGè°ƒç”¨ipv4_confirmï¼Œå°†è¿™ä¸ªè¿æ¥è·Ÿè¸ªè®°å½•æŒ‚åœ¨å†…æ ¸çš„è¿æ¥è·Ÿè¸ªè¡¨é‡Œé¢ã€‚</p>\n</li>\n</ul><p>ç½‘å…³ä¸»è¦åšè½¬å‘ï¼Œè¿™é‡Œä¸»è¦è¯´çš„æ˜¯NATç½‘å…³ï¼Œå› è€Œæˆ‘ä»¬é‡ç‚¹æ¥çœ‹â€œä»æˆ‘è¿™é‡Œç»è¿‡çš„â€è¿™ç§åœºæ™¯ï¼Œå†åŠ ä¸Šè¦NATï¼Œå› è€Œå°†NATçš„è¿‡ç¨‹èå…¥åˆ°è¿æ¥è·Ÿè¸ªçš„è¿‡ç¨‹ä¸­æ¥ï¼š</p><ul>\n<li>\n<p>å¦‚æœæ˜¯PREROUTINGçš„æ—¶å€™ï¼Œå…ˆè°ƒç”¨ipv4_conntrack_inï¼Œåˆ›å»ºè¿æ¥è·Ÿè¸ªè®°å½•ï¼›</p>\n</li>\n<li>\n<p>å¦‚æœæ˜¯PREROUTINGçš„æ—¶å€™ï¼Œæœ‰NATè§„åˆ™ï¼Œåˆ™è°ƒç”¨nf_nat_ipv4_inè¿›è¡Œåœ°å€è½¬æ¢ï¼›</p>\n</li>\n<li>\n<p>å¦‚æœæ˜¯POSTROUTINGçš„æ—¶å€™ï¼Œæœ‰NATè§„åˆ™ï¼Œåˆ™è°ƒç”¨nf_nat_ipv4_outè¿›è¡Œåœ°å€è½¬æ¢ï¼›</p>\n</li>\n<li>\n<p>å¦‚æœæ˜¯POSTROUTINGçš„æ—¶å€™ï¼Œè°ƒç”¨ipv4_confirmï¼Œå°†è¿™ä¸ªè¿æ¥è·Ÿè¸ªè®°å½•æŒ‚åœ¨å†…æ ¸çš„è¿æ¥è·Ÿè¸ªè¡¨é‡Œé¢ã€‚</p>\n</li>\n</ul><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ¶‰åŠåˆ°çš„æ•°æ®ç»“æ„ï¼šè¿æ¥è·Ÿè¸ªè®°å½•ã€è¿æ¥è·Ÿè¸ªè¡¨ã€‚</p><p>åœ¨å‰é¢è®²ç½‘ç»œåŒ…å¤„ç†çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¯´è¿‡ï¼Œæ¯ä¸ªç½‘ç»œåŒ…éƒ½æ˜¯ä¸€ä¸ªstruct sk_buffï¼Œå®ƒæœ‰ä¸€ä¸ªæˆå‘˜å˜é‡_nfctæŒ‡å‘ä¸€ä¸ªè¿æ¥è·Ÿè¸ªè®°å½•struct nf_connã€‚å½“ç„¶å½“ä¸€ä¸ªç½‘ç»œåŒ…åˆšåˆšè¿›æ¥çš„æ—¶å€™ï¼Œæ˜¯ä¸ä¼šæŒ‡å‘è¿™ä¹ˆä¸€ä¸ªç»“æ„çš„ï¼Œä½†æ˜¯è¿™ä¸ªç½‘ç»œåŒ…è‚¯å®šå±äºæŸä¸ªè¿æ¥ï¼Œå› è€Œä¼šå»è¿æ¥è·Ÿè¸ªè¡¨é‡Œé¢å»æŸ¥æ‰¾ï¼Œä¹‹åèµ‹å€¼ç»™sk_buffçš„è¿™ä¸ªæˆå‘˜å˜é‡ã€‚æ²¡æ‰¾åˆ°çš„è¯ï¼Œå°±è¯´æ˜æ˜¯ä¸€ä¸ªæ–°çš„è¿æ¥ï¼Œç„¶åä¼šé‡æ–°åˆ›å»ºä¸€ä¸ªã€‚</p><p>è¿æ¥è·Ÿè¸ªè®°å½•é‡Œé¢æœ‰å‡ ä¸ªé‡è¦çš„ä¸œè¥¿ï¼š</p><ul>\n<li>\n<p>nf_conntrackå…¶å®æ‰æ˜¯_nfctå˜é‡æŒ‡å‘çš„åœ°å€ï¼Œä½†æ˜¯æ²¡æœ‰å…³ç³»ï¼Œå­¦è¿‡C++çš„è¯åº”è¯¥æ˜ç™½ï¼Œå¯¹äºç»“æ„ä½“æ¥è®²ï¼Œnf_connå’Œnf_conntrackçš„èµ·å§‹åœ°å€æ˜¯ä¸€æ ·çš„ï¼›</p>\n</li>\n<li>\n<p>tuplehashè™½ç„¶æ˜¯æ•°ç»„ï¼Œä½†æ˜¯é‡Œé¢åªæœ‰ä¸¤ä¸ªï¼ŒIP_CT_DIR_ORIGINALä¸ºä¸‹æ ‡0ï¼Œè¡¨ç¤ºè¿æ¥çš„å‘èµ·æ–¹å‘ï¼ŒIP_CT_DIR_REPLYä¸ºä¸‹æ ‡1ï¼Œè¡¨ç¤ºè¿æ¥çš„å›å¤æ–¹å‘ã€‚</p>\n</li>\n</ul><pre><code>struct nf_conn {\n ......\n struct nf_conntrack ct_general;\n ......\n struct nf_conntrack_tuple_hash tuplehash[IP_CT_DIR_MAX];\n ......\n unsigned long status;\n ......\n}\n</code></pre><p>åœ¨è¿™é‡Œé¢ï¼Œæœ€é‡è¦çš„æ˜¯nf_conntrack_tuple_hashçš„æ•°ç»„ã€‚nf_connæ˜¯è¿™ä¸ªç½‘ç»œåŒ…å¯¹åº”çš„ä¸€å»ä¸€å›çš„è¿æ¥è¿½è¸ªè®°å½•ï¼Œä½†æ˜¯è¿™ä¸ªè®°å½•æ˜¯ä¼šæ”¾åœ¨ä¸€ä¸ªç»Ÿä¸€çš„è¿æ¥è¿½è¸ªè¡¨é‡Œé¢çš„ã€‚</p><p>è¿æ¥è·Ÿè¸ªè¡¨nf_conntrack_hashæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„ä¸­çš„æ¯ä¸€é¡¹éƒ½æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨çš„å¤´ï¼Œæ¯ä¸€é¡¹åé¢éƒ½æŒ‚ç€ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œé“¾è¡¨ä¸­çš„æ¯ä¸€é¡¹éƒ½æ˜¯è¿™ä¸ªç»“æ„ã€‚</p><p>è¿™ä¸ªç»“æ„çš„ç¬¬ä¸€é¡¹æ˜¯é“¾è¡¨çš„é“¾ï¼Œnf_conntrack_tupleæ˜¯ç”¨æ¥æ ‡è¯†æ˜¯å¦åŒä¸€ä¸ªè¿æ¥ã€‚</p><p>ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºæ¥ï¼Œè¿æ¥è·Ÿè¸ªè¡¨æ˜¯ä¸€ä¸ªå…¸å‹çš„é“¾å¼å“ˆå¸Œè¡¨çš„å®ç°ã€‚</p><p>æ¯å½“æœ‰ä¸€ä¸ªç½‘ç»œåŒ…æ¥äº†çš„æ—¶å€™ï¼Œä¼šå°†ç½‘ç»œåŒ…ä¸­sk_buffä¸­çš„æ•°æ®æå–å‡ºæ¥ï¼Œå½¢æˆnf_conntrack_tupleï¼Œå¹¶æ ¹æ®é‡Œé¢çš„å†…å®¹è®¡ç®—å“ˆå¸Œå€¼ã€‚ç„¶åéœ€è¦åœ¨å“ˆå¸Œè¡¨ä¸­æŸ¥æ‰¾ï¼Œå¦‚æœæ‰¾åˆ°ï¼Œåˆ™è¯´æ˜è¿™ä¸ªè¿æ¥å‡ºç°è¿‡ï¼›å¦‚æœæ²¡æ‰¾åˆ°ï¼Œåˆ™ç”Ÿæˆä¸€ä¸ªæ’å…¥å“ˆå¸Œè¡¨ã€‚</p><p>é€šè¿‡nf_conntrack_tupleé‡Œé¢çš„å†…å®¹ï¼Œå¯ä»¥å”¯ä¸€åœ°æ ‡è¯†ä¸€ä¸ªè¿æ¥ï¼š</p><ul>\n<li>\n<p>srcï¼šåŒ…å«æºIPåœ°å€ï¼›å¦‚æœæ˜¯TCPæˆ–è€…UDPï¼ŒåŒ…å«æºç«¯å£ï¼›å¦‚æœæ˜¯ICMPï¼ŒåŒ…å«çš„æ˜¯IDï¼›</p>\n</li>\n<li>\n<p>dstï¼šåŒ…å«ç›®æ ‡IPåœ°å€ï¼›å¦‚æœæ˜¯TCPæˆ–è€…UDPï¼ŒåŒ…å«ç›®æ ‡ç«¯å£ï¼›å¦‚æœæ˜¯ICMPï¼ŒåŒ…å«çš„æ˜¯type, codeã€‚</p>\n</li>\n</ul><p>æœ‰äº†è¿™äº›æ•°æ®ç»“æ„ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥çœ‹è¿™ä¸€å»ä¸€å›çš„è¿‡ç¨‹ã€‚</p><p>å½“ä¸€ä¸ªåŒ…å‘å‡ºå»çš„æ—¶å€™ï¼Œåˆ°è¾¾è¿™ä¸ªNATç½‘å…³çš„æ—¶å€™ï¼Œé¦–å…ˆç»è¿‡PREROUTINGçš„æ—¶å€™ï¼Œå…ˆè°ƒç”¨ipv4_conntrack_inã€‚è¿™ä¸ªæ—¶å€™è¿›æ¥çš„åŒ…sk_buffä¸ºï¼š {æºIPï¼šå®¢æˆ·ç«¯IPï¼Œæºç«¯å£ï¼šå®¢æˆ·ç«¯portï¼Œç›®æ ‡IPï¼šæœåŠ¡ç«¯IPï¼Œç›®æ ‡ç«¯å£ï¼šæœåŠ¡ç«¯port}ï¼Œå°†è¿™ä¸ªè½¬æ¢ä¸ºnf_conntrack_tupleï¼Œç„¶åç»è¿‡å“ˆå¸Œè¿ç®—ï¼Œåœ¨è¿æ¥è·Ÿè¸ªè¡¨é‡Œé¢æŸ¥æ‰¾ï¼Œå‘ç°æ²¡æœ‰ï¼Œè¯´æ˜è¿™æ˜¯ä¸€ä¸ªæ–°çš„è¿æ¥ã€‚</p><p>äºæ˜¯ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„è¿æ¥è·Ÿè¸ªè®°å½•nf_connï¼Œè¿™é‡Œé¢æœ‰ä¸¤ä¸ªnf_conntrack_tuple_hashï¼š</p><ul>\n<li>\n<p>ä¸€å»ï¼š{æºIPï¼šå®¢æˆ·ç«¯IPï¼Œæºç«¯å£ï¼šå®¢æˆ·ç«¯portï¼Œç›®æ ‡IPï¼šæœåŠ¡ç«¯IPï¼Œç›®æ ‡ç«¯å£ï¼šæœåŠ¡ç«¯port}ï¼›</p>\n</li>\n<li>\n<p>ä¸€å›ï¼š{æºIPï¼šæœåŠ¡ç«¯IPï¼Œæºç«¯å£ï¼šæœåŠ¡ç«¯portï¼Œç›®æ ‡IPï¼šå®¢æˆ·ç«¯IPï¼Œç›®æ ‡ç«¯å£ï¼šå®¢æˆ·ç«¯port}ã€‚</p>\n</li>\n</ul><p>æ¥ä¸‹æ¥ç»è¿‡FORWARDè¿‡ç¨‹ï¼Œå‡è®¾åŒ…æ²¡æœ‰è¢«filteræ‰ï¼Œäºæ˜¯è¦è½¬å‘å‡ºå»ï¼Œè¿›å…¥POSTROUTINGçš„è¿‡ç¨‹ï¼Œæœ‰NATè§„åˆ™ï¼Œåˆ™è°ƒç”¨nf_nat_ipv4_outè¿›è¡Œåœ°å€è½¬æ¢ã€‚è¿™ä¸ªæ—¶å€™ï¼Œæºåœ°å€è¦å˜æˆNATç½‘å…³çš„IPåœ°å€ï¼Œå¯¹äºmasqueradeæ¥è®²ï¼Œä¼šè‡ªåŠ¨é€‰æ‹©ä¸€ä¸ªå…¬ç½‘IPåœ°å€å’Œä¸€ä¸ªéšæœºç«¯å£ã€‚</p><p>ä¸ºäº†è®©åŒ…å›æ¥çš„æ—¶å€™ï¼Œèƒ½æ‰¾åˆ°è¿æ¥è·Ÿè¸ªè®°å½•ï¼Œéœ€è¦ä¿®æ”¹ä¸¤ä¸ªnf_conntrack_tuple_hashä¸­å›æ¥çš„é‚£ä¸€é¡¹ä¸ºï¼š{æºIPï¼šæœåŠ¡ç«¯IPï¼Œæºç«¯å£ï¼šæœåŠ¡ç«¯portï¼Œç›®æ ‡IPï¼šNATç½‘å…³IPï¼Œç›®æ ‡ç«¯å£ï¼šéšæœºç«¯å£}ã€‚</p><p>æ¥ä¸‹æ¥è¦å°†ç½‘ç»œåŒ…çœŸæ­£å‘å‡ºå»çš„æ—¶å€™ï¼Œé™¤äº†è¦ä¿®æ”¹åŒ…é‡Œé¢çš„æºIPå’Œæºç«¯å£ä¹‹å¤–ï¼Œè¿˜éœ€è¦å°†åˆšæ‰çš„ä¸€å»ä¸€å›çš„ä¸¤ä¸ªnf_conntrack_tuple_hashæ”¾å…¥è¿æ¥è·Ÿè¸ªè¡¨è¿™ä¸ªå“ˆå¸Œè¡¨ä¸­ã€‚</p><p>å½“ç½‘ç»œåŒ…åˆ°è¾¾æœåŠ¡ç«¯ï¼Œç„¶åå›å¤ä¸€ä¸ªåŒ…çš„æ—¶å€™ï¼Œè¿™ä¸ªåŒ…sk_buffä¸ºï¼š{æºIPï¼šæœåŠ¡ç«¯IPï¼Œæºç«¯å£ï¼šæœåŠ¡ç«¯portï¼Œç›®æ ‡IPï¼šNATç½‘å…³IPï¼Œç›®æ ‡ç«¯å£ï¼šéšæœºç«¯å£}ã€‚</p><p>å°†è¿™ä¸ªè½¬æ¢ä¸ºnf_conntrack_tupleåï¼Œè¿›è¡Œå“ˆå¸Œè¿ç®—ï¼Œåœ¨è¿æ¥è·Ÿè¸ªè¡¨é‡Œé¢æŸ¥æ‰¾ï¼Œæ˜¯èƒ½æ‰¾åˆ°ç›¸åº”çš„è®°å½•çš„ï¼Œæ‰¾åˆ°nf_conntrack_tuple_hashä¹‹åï¼ŒLinuxä¼šæä¾›ä¸€ä¸ªå‡½æ•°ã€‚</p><pre><code>static inline struct nf_conn *\nnf_ct_tuplehash_to_ctrack(const struct nf_conntrack_tuple_hash *hash)\n{\n return container_of(hash, struct nf_conn,\n       tuplehash[hash-&gt;tuple.dst.dir]);\n}\n</code></pre><p>å¯ä»¥é€šè¿‡nf_conntrack_tuple_hashæ‰¾åˆ°å¤–é¢çš„è¿æ¥è·Ÿè¸ªè®°å½•nf_connï¼Œé€šè¿‡è¿™ä¸ªå¯ä»¥æ‰¾åˆ°æ¥æ–¹å‘çš„é‚£ä¸ªnf_conntrack_tuple_hashï¼Œ{æºIPï¼šå®¢æˆ·ç«¯IPï¼Œæºç«¯å£ï¼šå®¢æˆ·ç«¯portï¼Œç›®æ ‡IPï¼šæœåŠ¡ç«¯IPï¼Œç›®æ ‡ç«¯å£ï¼šæœåŠ¡ç«¯port}ï¼Œè¿™æ ·å°±èƒ½å¤Ÿæ‰¾åˆ°å®¢æˆ·ç«¯çš„IPå’Œç«¯å£ï¼Œä»è€Œå¯ä»¥NATå›å»ã€‚</p><h3>ç•™è¨€é—®é¢˜</h3><p><span class=\"orange\">1.NATèƒ½å»ºç«‹å¤šå°‘è¿æ¥ï¼Ÿ</span></p><p><img src=\"https://static001.geekbang.org/resource/image/3d/d6/3d9249834f730926c2b2f350aba6e1d6.png?wh=750*932\" alt=\"\"></p><p>SNATå¤šç”¨äºå†…ç½‘è®¿é—®å¤–ç½‘çš„åœºæ™¯ï¼Œé‰´äºconntrackæ˜¯ç”±{æºIPï¼Œæºç«¯å£ï¼Œç›®æ ‡IPï¼Œç›®æ ‡ç«¯å£}ï¼Œhashåç¡®å®šçš„ã€‚</p><p>å¦‚æœå†…ç½‘æœºå™¨å¾ˆå¤šï¼Œä½†æ˜¯è®¿é—®çš„æ˜¯ä¸åŒçš„å¤–ç½‘ï¼Œä¹Ÿå³ç›®æ ‡IPå’Œç›®æ ‡ç«¯å£å¾ˆå¤šï¼Œè¿™æ ·å†…ç½‘å¯æ‰¿è½½çš„æ•°é‡å°±éå¸¸å¤§ï¼Œå¯ä¸æ­¢65535ä¸ªã€‚</p><p>ä½†æ˜¯å¦‚æœå†…ç½‘æ‰€æœ‰çš„æœºå™¨ï¼Œéƒ½ä¸€å®šè¦è®¿é—®åŒä¸€ä¸ªç›®æ ‡IPå’Œç›®æ ‡ç«¯å£ï¼Œè¿™æ ·æºIPå¦‚æœåªæœ‰ä¸€ä¸ªï¼Œè¿™æ ·çš„æƒ…å†µä¸‹ï¼Œæ‰å—65535çš„ç«¯å£æ•°ç›®é™åˆ¶ï¼Œæ ¹æ®åŸç†ï¼Œä¸€ç§æ–¹æ³•å°±æ˜¯å¤šä¸ªæºIPï¼Œå¦å¤–çš„æ–¹æ³•å°±æ˜¯å¤šä¸ªNATç½‘å…³ï¼Œæ¥åˆ†æ‘Šä¸åŒçš„å†…ç½‘æœºå™¨è®¿é—®ã€‚</p><p>å¦‚æœä½ ä½¿ç”¨çš„æ˜¯å…¬æœ‰äº‘ï¼Œ65535å°æœºå™¨ï¼Œåº”è¯¥æ”¾åœ¨ä¸€ä¸ªVPCé‡Œé¢ï¼Œå¯ä»¥æ”¾åœ¨å¤šä¸ªVPCé‡Œé¢ï¼Œæ¯ä¸ªVPCéƒ½å¯ä»¥æœ‰è‡ªå·±çš„NATç½‘å…³ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/d0/8d/d08e3a727681751037f715c3f5bd398d.png?wh=750*1226\" alt=\"\"></p><p>å…¶å®SNATçš„åœºæ™¯æ˜¯å†…ç½‘è®¿é—®å¤–ç½‘ï¼Œå­˜åœ¨ç«¯å£æ•°é‡çš„é—®é¢˜ï¼Œä¹Ÿæ˜¯æ‰€æœ‰çš„æœºå™¨éƒ½è®¿é—®ä¸€ä¸ªç›®æ ‡åœ°å€çš„æƒ…å†µã€‚</p><p>å¦‚æœæ˜¯å¾®ä¿¡è¿™ç§åœºæ™¯ï¼Œåº”è¯¥æ˜¯æœåŠ¡ç«¯åœ¨æ•°æ®ä¸­å¿ƒå†…éƒ¨ï¼Œæ— è®ºå¤šå°‘é•¿è¿æ¥ï¼Œä½œä¸ºæœåŠ¡ç«¯ç›‘å¬çš„éƒ½æ˜¯å°‘æ•°å‡ ä¸ªç«¯å£ï¼Œæ˜¯DNATçš„åœºæ™¯ï¼Œæ˜¯æ²¡æœ‰ç«¯å£æ•°ç›®é—®é¢˜çš„ï¼Œåªæœ‰ä¸€å°æœåŠ¡å™¨èƒ½ä¸èƒ½ç»´æŠ¤è¿™ä¹ˆå¤šè¿æ¥ï¼Œå› è€Œåœ¨NATç½‘å…³åé¢éƒ¨ç½²å¤šä¸ªnginxæ¥åˆ†æ‘Šè¿æ¥å³å¯ã€‚</p><p><span class=\"orange\">2.å…¬ç½‘IPå’Œç§ç½‘IPéœ€è¦ä¸€ä¸€ç»‘å®šå—ï¼Ÿ</span></p><p><img src=\"https://static001.geekbang.org/resource/image/2d/f1/2d134e61e8cc945c71969be7391b3ff1.png?wh=750*1008\" alt=\"\"></p><p>å…¬ç½‘IPæ˜¯æœ‰é™çš„ï¼Œå¦‚æœä½¿ç”¨å…¬æœ‰äº‘ï¼Œéœ€è¦èŠ±é’±å»ä¹°ã€‚ä½†æ˜¯ä¸æ˜¯æ¯ä¸€ä¸ªè™šæ‹Ÿæœºéƒ½è¦æœ‰ä¸€ä¸ªå…¬ç½‘IPçš„ï¼Œåªæœ‰éœ€è¦å¯¹å¤–æä¾›æœåŠ¡çš„æœºå™¨ï¼Œä¹Ÿå³æ¥å…¥å±‚çš„é‚£äº›nginxéœ€è¦å…¬ç½‘IPï¼Œæ²¡æœ‰å…¬ç½‘IPï¼Œä½¿ç”¨SNATï¼Œå¤§å®¶å…±äº«SNATç½‘å…³çš„å…¬ç½‘IPåœ°å€ï¼Œä¹Ÿæ˜¯èƒ½å¤Ÿè®¿é—®çš„å¤–ç½‘çš„ã€‚</p><p>æˆ‘çœ‹ç•™è¨€ä¸­çš„å›°æƒ‘ç‚¹éƒ½åœ¨äºï¼Œè¦åŒºåˆ†å†…ä¸»åŠ¨å‘èµ·è®¿é—®å¤–ï¼Œè¿˜æ˜¯å¤–ä¸»åŠ¨å‘èµ·è®¿é—®å†…ï¼Œæ˜¯è®¿é—®åŒä¸€ä¸ªæœåŠ¡ç«¯ï¼Œè¿˜æ˜¯è®¿é—®ä¸€å¤§æ‰¹æœåŠ¡ç«¯ã€‚è¿™é‡Œå°±å¾ˆæ˜ç™½äº†ã€‚</p><h2><a href=\"https://time.geekbang.org/column/article/8729\">ã€Šç¬¬9è®² | è·¯ç”±åè®®ï¼šè¥¿å‡ºç½‘å…³æ— æ•…äººï¼Œæ•¢é—®è·¯åœ¨ä½•æ–¹ã€‹</a></h2><h3>è¯¾åæ€è€ƒé¢˜</h3><p><span class=\"orange\">è·¯ç”±åè®®è¦åœ¨è·¯ç”±å™¨ä¹‹é—´äº¤æ¢ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯çš„äº¤æ¢è¿˜éœ€è¦èµ°è·¯ç”±å—ï¼Ÿä¸æ˜¯æ­»é”äº†å—ï¼Ÿ</span></p><p><img src=\"https://static001.geekbang.org/resource/image/b5/da/b5834f4f10c51cb8c91e570bf83f7eda.png?wh=750*801\" alt=\"\"></p><p>OSPFæ˜¯ç›´æ¥åŸºäºIPåè®®å‘é€çš„ï¼Œè€Œä¸”OSPFçš„åŒ…éƒ½æ˜¯å‘ç»™é‚»å±…çš„ï¼Œä¹Ÿå³åªæœ‰ä¸€è·³ï¼Œä¸ä¼šä¸­é—´ç»è¿‡è·¯ç”±è®¾å¤‡ã€‚BGPæ˜¯åŸºäºTCPåè®®çš„ï¼Œåœ¨BGP peerä¹‹é—´äº¤æ¢ä¿¡æ¯ã€‚</p><h3>ç•™è¨€é—®é¢˜</h3><p><span class=\"orange\">1.å¤šçº¿BGPæœºæˆ¿æ˜¯æ€ä¹ˆå›äº‹å„¿ï¼Ÿ</span></p><p><img src=\"https://static001.geekbang.org/resource/image/18/cd/18040a74506276b23e672d2d818d37cd.png?wh=750*910\" alt=\"\"></p><p>BGPä¸»è¦ç”¨äºäº’è”ç½‘ASè‡ªæ²»ç³»ç»Ÿä¹‹é—´çš„äº’è”ï¼ŒBGPçš„æœ€ä¸»è¦åŠŸèƒ½åœ¨äº<strong>æ§åˆ¶è·¯ç”±çš„ä¼ æ’­</strong>å’Œ<strong>é€‰æ‹©æœ€å¥½çš„è·¯ç”±</strong>ã€‚å„å¤§è¿è¥å•†éƒ½å…·æœ‰ASå·ï¼Œå…¨å›½å„å¤§ç½‘ç»œè¿è¥å•†å¤šæ•°éƒ½æ˜¯é€šè¿‡BGPåè®®ä¸è‡ªèº«çš„ASæ¥å®ç°å¤šçº¿äº’è”çš„ã€‚</p><p>ä½¿ç”¨æ­¤æ–¹æ¡ˆæ¥å®ç°å¤šçº¿è·¯äº’è”ï¼ŒIDCéœ€è¦åœ¨CNNICï¼ˆä¸­å›½äº’è”ç½‘ä¿¡æ¯ä¸­å¿ƒï¼‰æˆ–APNICï¼ˆäºšå¤ªç½‘ç»œä¿¡æ¯ä¸­å¿ƒï¼‰ç”³è¯·è‡ªå·±çš„IPåœ°å€æ®µå’ŒASå·ï¼Œç„¶åé€šè¿‡BGPåè®®å°†æ­¤æ®µIPåœ°å€å¹¿æ’­åˆ°å…¶å®ƒçš„ç½‘ç»œè¿è¥å•†çš„ç½‘ç»œä¸­ã€‚</p><p>ä½¿ç”¨BGPåè®®äº’è”åï¼Œç½‘ç»œè¿è¥å•†çš„æ‰€æœ‰éª¨å¹²è·¯ç”±è®¾å¤‡å°†ä¼šåˆ¤æ–­åˆ°IDCæœºæˆ¿IPæ®µçš„æœ€ä½³è·¯ç”±ï¼Œä»¥ä¿è¯ä¸åŒç½‘ç»œè¿è¥å•†ç”¨æˆ·çš„é«˜é€Ÿè®¿é—®ã€‚</p><h2><a href=\"https://time.geekbang.org/column/article/8924\">ã€Šç¬¬10è®² | UDPåè®®ï¼šå› æ€§å–„è€Œç®€å•ï¼Œéš¾å…ç¢°åˆ°â€œåŸä¼šç©â€ã€‹</a></h2><h3>è¯¾åæ€è€ƒé¢˜</h3><p><span class=\"orange\">éƒ½è¯´ TCP æ˜¯é¢å‘è¿æ¥çš„ï¼Œåœ¨è®¡ç®—æœºçœ‹æ¥ï¼Œæ€ä¹ˆæ ·æ‰ç®—ä¸€ä¸ªè¿æ¥å‘¢ï¼Ÿ</span></p><p>èµµå¼ºå¼ºåœ¨ç•™è¨€ä¸­å›ç­”çš„æ˜¯æ­£ç¡®çš„ã€‚è¿™æ˜¯TCPçš„ä¸¤ç«¯ä¸ºäº†ç»´æŠ¤è¿æ¥æ‰€ä¿æŒçš„æ•°æ®ç»“æ„ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/3c/e1/3cba74151564c129057b2cd246a332e1.png?wh=750*910\" alt=\"\"></p><p><img src=\"https://static001.geekbang.org/resource/image/95/e0/9507374c04e0908f29d5a3050d905fe0.png?wh=750*823\" alt=\"\"></p><p></p><h2><a href=\"https://time.geekbang.org/column/article/8975\">ã€Šç¬¬11è®² | TCPåè®®ï¼ˆä¸Šï¼‰ï¼šå› æ€§æ¶è€Œå¤æ‚ï¼Œå…ˆæ¶åå–„åè½»æ¾ã€‹</a></h2><h3>è¯¾åæ€è€ƒé¢˜</h3><p><span class=\"orange\">TCP çš„è¿æ¥æœ‰è¿™ä¹ˆå¤šçš„çŠ¶æ€ï¼Œä½ çŸ¥é“å¦‚ä½•åœ¨ç³»ç»Ÿä¸­æŸ¥çœ‹æŸä¸ªè¿æ¥çš„çŠ¶æ€å—ï¼Ÿ</span></p><p><img src=\"https://static001.geekbang.org/resource/image/3c/d7/3c997ad09a1c72cbb32a992e7c9588d7.png?wh=750*747\" alt=\"\"></p><h3>ç•™è¨€é—®é¢˜</h3><p><span class=\"orange\">1.TIME_WAITçŠ¶æ€å¤ªå¤šæ˜¯æ€ä¹ˆå›äº‹å„¿ï¼Ÿ</span></p><p><img src=\"https://static001.geekbang.org/resource/image/85/b8/8535df3de9f426b44def750330dcf2b8.png?wh=750*1019\" alt=\"\"></p><p><img src=\"https://static001.geekbang.org/resource/image/1f/11/1f6a5e17b34f00d28722428b7b8ccb11.jpg?wh=553*477\" alt=\"\"></p><p>å¦‚æœå¤„äºTIMEWAITçŠ¶æ€ï¼Œè¯´æ˜åŒæ–¹å»ºç«‹æˆåŠŸè¿‡è¿æ¥ï¼Œè€Œä¸”å·²ç»å‘é€äº†æœ€åçš„ACKä¹‹åï¼Œæ‰ä¼šå¤„äºè¿™ä¸ªçŠ¶æ€ï¼Œè€Œä¸”æ˜¯ä¸»åŠ¨å‘èµ·å…³é—­çš„ä¸€æ–¹å¤„äºè¿™ä¸ªçŠ¶æ€ã€‚</p><p>å¦‚æœå­˜åœ¨å¤§é‡çš„TIMEWAITï¼Œå¾€å¾€æ˜¯å› ä¸ºçŸ­è¿æ¥å¤ªå¤šï¼Œä¸æ–­çš„åˆ›å»ºè¿æ¥ï¼Œç„¶åé‡Šæ”¾è¿æ¥ï¼Œä»è€Œå¯¼è‡´å¾ˆå¤šè¿æ¥åœ¨è¿™ä¸ªçŠ¶æ€ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ— æ³•å‘èµ·æ–°çš„è¿æ¥ã€‚è§£å†³çš„æ–¹å¼å¾€å¾€æ˜¯ï¼š</p><ul>\n<li>\n<p>æ‰“å¼€tcp_tw_recycleå’Œtcp_timestampsé€‰é¡¹ï¼›</p>\n</li>\n<li>\n<p>æ‰“å¼€tcp_tw_reuseå’Œtcp_timestampsé€‰é¡¹ï¼›</p>\n</li>\n<li>\n<p>ç¨‹åºä¸­ä½¿ç”¨SO_LINGERï¼Œåº”ç”¨å¼ºåˆ¶ä½¿ç”¨rstå…³é—­ã€‚</p>\n</li>\n</ul><p>å½“å®¢æˆ·ç«¯æ”¶åˆ°Connection Resetï¼Œå¾€å¾€æ˜¯æ”¶åˆ°äº†TCPçš„RSTæ¶ˆæ¯ï¼ŒRSTæ¶ˆæ¯ä¸€èˆ¬åœ¨ä¸‹é¢çš„æƒ…å†µä¸‹å‘é€ï¼š</p><ul>\n<li>\n<p>è¯•å›¾è¿æ¥ä¸€ä¸ªæœªè¢«ç›‘å¬çš„æœåŠ¡ç«¯ï¼›</p>\n</li>\n<li>\n<p>å¯¹æ–¹å¤„äºTIMEWAITçŠ¶æ€ï¼Œæˆ–è€…è¿æ¥å·²ç»å…³é—­å¤„äºCLOSEDçŠ¶æ€ï¼Œæˆ–è€…é‡æ–°ç›‘å¬seq numä¸åŒ¹é…ï¼›</p>\n</li>\n<li>\n<p>å‘èµ·è¿æ¥æ—¶è¶…æ—¶ï¼Œé‡ä¼ è¶…æ—¶ï¼Œkeepaliveè¶…æ—¶ï¼›</p>\n</li>\n<li>\n<p>åœ¨ç¨‹åºä¸­ä½¿ç”¨SO_LINGERï¼Œå…³é—­è¿æ¥æ—¶ï¼Œæ”¾å¼ƒç¼“å­˜ä¸­çš„æ•°æ®ï¼Œç»™å¯¹æ–¹å‘é€RSTã€‚</p>\n</li>\n</ul><p><span class=\"orange\">2.èµ·å§‹åºåˆ—å·æ˜¯æ€ä¹ˆè®¡ç®—çš„ï¼Œä¼šå†²çªå—ï¼Ÿ</span></p><p>æœ‰åŒå­¦åœ¨ç•™è¨€ä¸­é—®äº†å‡ ä¸ªé—®é¢˜ã€‚Ender0224çš„å›ç­”éå¸¸ä¸é”™ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/af/47/afed5f0593647c0b64971c2fef7e4247.png?wh=750*1998\" alt=\"\"></p><p><img src=\"https://static001.geekbang.org/resource/image/c3/e1/c39c723c9389c4414401366a32b69fe1.jpg?wh=499*731\" alt=\"\"></p><p>èµ·å§‹ISNæ˜¯åŸºäºæ—¶é’Ÿçš„ï¼Œæ¯4æ¯«ç§’åŠ ä¸€ï¼Œè½¬ä¸€åœˆè¦4.55ä¸ªå°æ—¶ã€‚</p><p>TCPåˆå§‹åŒ–åºåˆ—å·ä¸èƒ½è®¾ç½®ä¸ºä¸€ä¸ªå›ºå®šå€¼ï¼Œå› ä¸ºè¿™æ ·å®¹æ˜“è¢«æ”»å‡»è€…çŒœå‡ºåç»­åºåˆ—å·ï¼Œä»è€Œé­åˆ°æ”»å‡»ã€‚ RFC1948ä¸­æå‡ºäº†ä¸€ä¸ªè¾ƒå¥½çš„åˆå§‹åŒ–åºåˆ—å·ISNéšæœºç”Ÿæˆç®—æ³•ã€‚</p><p>ISN = M + F (localhost, localport, remotehost, remoteport)</p><p>Mæ˜¯ä¸€ä¸ªè®¡æ—¶å™¨ï¼Œè¿™ä¸ªè®¡æ—¶å™¨æ¯éš”4æ¯«ç§’åŠ 1ã€‚Fæ˜¯ä¸€ä¸ªHashç®—æ³•ï¼Œæ ¹æ®æºIPã€ç›®çš„IPã€æºç«¯å£ã€ç›®çš„ç«¯å£ç”Ÿæˆä¸€ä¸ªéšæœºæ•°å€¼ã€‚è¦ä¿è¯Hashç®—æ³•ä¸èƒ½è¢«å¤–éƒ¨è½»æ˜“æ¨ç®—å¾—å‡ºï¼Œç”¨MD5ç®—æ³•æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¥½çš„é€‰æ‹©ã€‚</p><h2><a href=\"https://time.geekbang.org/column/article/9141\">ã€Šç¬¬12è®² | TCPåè®®ï¼ˆä¸‹ï¼‰ï¼šè¥¿è¡Œå¿…å®šå¤šå¦–å­½ï¼Œæ’å¿ƒæ™ºæ…§æ¶ˆç£¨éš¾ã€‹</a></h2><h3>è¯¾åæ€è€ƒé¢˜</h3><p><span class=\"orange\">TCPçš„BBRå¬èµ·æ¥å¾ˆç‰›ï¼Œä½ çŸ¥é“å®ƒæ˜¯å¦‚ä½•è¾¾åˆ°è¿™ä¸ªæœ€ä¼˜ç‚¹çš„å—ï¼Ÿ</span></p><p><img src=\"https://static001.geekbang.org/resource/image/33/03/33b035bd326e9c1f811d667104a54003.png?wh=750*2740\" alt=\"\"></p><h2><a href=\"https://time.geekbang.org/column/article/9293\">ã€Šç¬¬13è®² | å¥—æ¥å­—Socketï¼šTalk is cheap, show me the codeã€‹</a></h2><h3>è¯¾åæ€è€ƒé¢˜</h3><p><span class=\"orange\">epollæ˜¯Linuxä¸Šçš„å‡½æ•°ï¼Œé‚£ä½ çŸ¥é“Windowsä¸Šå¯¹åº”çš„æœºåˆ¶æ˜¯ä»€ä¹ˆå—ï¼Ÿå¦‚æœæƒ³å®ç°ä¸€ä¸ªè·¨å¹³å°çš„ç¨‹åºï¼Œä½ çŸ¥é“åº”è¯¥æ€ä¹ˆåŠå—ï¼Ÿ</span></p><p><img src=\"https://static001.geekbang.org/resource/image/74/e9/74d6535a22f5dc8ab2f782b4484ca7e9.png?wh=750*1053\" alt=\"\"></p><p>epollæ˜¯å¼‚æ­¥é€šçŸ¥ï¼Œå½“äº‹ä»¶å‘ç”Ÿçš„æ—¶å€™ï¼Œé€šçŸ¥åº”ç”¨å»è°ƒç”¨IOå‡½æ•°è·å–æ•°æ®ã€‚IOCPå¼‚æ­¥ä¼ è¾“ï¼Œå½“äº‹ä»¶å‘ç”Ÿæ—¶ï¼ŒIOCPæœºåˆ¶ä¼šå°†æ•°æ®ç›´æ¥æ‹·è´åˆ°ç¼“å†²åŒºé‡Œï¼Œåº”ç”¨å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚</p><p>å¦‚æœè·¨å¹³å°ï¼Œæ¨èä½¿ç”¨libeventåº“ï¼Œå®ƒæ˜¯ä¸€ä¸ªäº‹ä»¶é€šçŸ¥åº“ï¼Œé€‚ç”¨äºWindowsã€Linuxã€BSDç­‰å¤šç§å¹³å°ï¼Œå†…éƒ¨ä½¿ç”¨selectã€epollã€kqueueã€IOCPç­‰ç³»ç»Ÿè°ƒç”¨ç®¡ç†äº‹ä»¶æœºåˆ¶ã€‚</p><hr><p>æ„Ÿè°¢ç¬¬7è®²è‡³ç¬¬13è®²ä¸­å¯¹å†…å®¹æœ‰æ·±åº¦æ€è€ƒå’Œæå‡ºé—®é¢˜çš„åŒå­¦ã€‚æˆ‘ä¼šä¸ºä½ ä»¬é€ä¸Šå¥–åŠ±ç¤¼åˆ¸å’ŒçŸ¥è¯†å›¾è°±ã€‚ï¼ˆç¨åè¿è¥åŒå­¦ä¼šå‘é€çŸ­ä¿¡é€šçŸ¥ã€‚ï¼‰</p><p>æ¬¢è¿ä½ ç»§ç»­æé—®ï¼</p><p><img src=\"https://static001.geekbang.org/resource/image/ed/57/edc42141381c0458ab65f70628e88557.jpg?wh=900*1929\" alt=\"\"></p>","neighbors":{"left":{"article_title":"åè®®ä¸“æ ç‰¹åˆ«ç¦åˆ© | ç­”ç–‘è§£æƒ‘ç¬¬äºŒæœŸ","id":13847},"right":{"article_title":"åè®®ä¸“æ ç‰¹åˆ«ç¦åˆ© | ç­”ç–‘è§£æƒ‘ç¬¬å››æœŸ","id":14194}},"comments":[{"had_liked":false,"id":23229,"user_name":"po","can_delete":false,"product_type":"c1","uid":1023905,"ip_address":"","ucode":"7DB36C278F34D7","user_header":"https://static001.geekbang.org/account/avatar/00/0f/9f/a1/d75219ee.jpg","comment_is_top":false,"comment_ctime":1536222436,"is_pvip":true,"replies":[{"id":"8410","content":"é€šè¿‡ nf_conntrack_tuple é‡Œé¢çš„å†…å®¹ï¼Œå¯ä»¥å”¯ä¸€åœ°æ ‡è¯†ä¸€ä¸ªè¿æ¥ï¼š<br><br>srcï¼šåŒ…å«æº IP åœ°å€ï¼›å¦‚æœæ˜¯ TCP æˆ–è€… UDPï¼ŒåŒ…å«æºç«¯å£ï¼›å¦‚æœæ˜¯ ICMPï¼ŒåŒ…å«çš„æ˜¯ IDï¼›<br><br>dstï¼šåŒ…å«ç›®æ ‡ IP åœ°å€ï¼›å¦‚æœæ˜¯ TCP æˆ–è€… UDPï¼ŒåŒ…å«ç›®æ ‡ç«¯å£ï¼›å¦‚æœæ˜¯ ICMPï¼ŒåŒ…å«çš„æ˜¯ type, codeã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘","uid":"1001590","ctime":1536234577,"ip_address":"","comment_id":23229,"utype":1}],"discussion_count":1,"race_medal":0,"score":"40190928100","product_id":100007101,"comment_content":"é‚£pingå‘¢ï¼Ÿæ˜¯å¦‚ä½•natçš„å‘¢ï¼Ÿ","like_count":10,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":423471,"discussion_content":"é€šè¿‡ nf_conntrack_tuple é‡Œé¢çš„å†…å®¹ï¼Œå¯ä»¥å”¯ä¸€åœ°æ ‡è¯†ä¸€ä¸ªè¿æ¥ï¼š\n\nsrcï¼šåŒ…å«æº IP åœ°å€ï¼›å¦‚æœæ˜¯ TCP æˆ–è€… UDPï¼ŒåŒ…å«æºç«¯å£ï¼›å¦‚æœæ˜¯ ICMPï¼ŒåŒ…å«çš„æ˜¯ IDï¼›\n\ndstï¼šåŒ…å«ç›®æ ‡ IP åœ°å€ï¼›å¦‚æœæ˜¯ TCP æˆ–è€… UDPï¼ŒåŒ…å«ç›®æ ‡ç«¯å£ï¼›å¦‚æœæ˜¯ ICMPï¼ŒåŒ…å«çš„æ˜¯ type, codeã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1536234577,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":21437,"user_name":"å°æ–‡åŒå­¦","can_delete":false,"product_type":"c1","uid":1001893,"ip_address":"","ucode":"48F2AEB989C12A","user_header":"https://static001.geekbang.org/account/avatar/00/0f/49/a5/e4c1c2d4.jpg","comment_is_top":false,"comment_ctime":1535080043,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"27304883819","product_id":100007101,"comment_content":"è°¢è°¢æå®¢æ—¶é—´ä¸ºæˆ‘ä»¬ä¸è€å¸ˆæ­æ¡¥","like_count":7},{"had_liked":false,"id":22545,"user_name":"æµªå­","can_delete":false,"product_type":"c1","uid":1142287,"ip_address":"","ucode":"321C295455CD08","user_header":"https://static001.geekbang.org/account/avatar/00/11/6e/0f/d6773c7e.jpg","comment_is_top":false,"comment_ctime":1535779159,"is_pvip":false,"replies":[{"id":"8098","content":"æ˜¯çš„","user_name":"ä½œè€…å›å¤","user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘","uid":"1001590","ctime":1535785929,"ip_address":"","comment_id":22545,"utype":1}],"discussion_count":1,"race_medal":0,"score":"23010615639","product_id":100007101,"comment_content":"å»ºè®®ä½¿ç”¨sså‘½ä»¤æ¥æŸ¥çœ‹socketç›¸å…³ä¿¡æ¯","like_count":6,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":423155,"discussion_content":"æ˜¯çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1535785929,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":267790,"user_name":"å¤œè¾‰","can_delete":false,"product_type":"c1","uid":1886331,"ip_address":"","ucode":"9421385F51FF9E","user_header":"https://static001.geekbang.org/account/avatar/00/1c/c8/7b/153181d7.jpg","comment_is_top":false,"comment_ctime":1607932323,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"10197866915","product_id":100007101,"comment_content":"è€å¸ˆï¼ŒISNæ—¶é’Ÿæ˜¯å‡ ä¹4**å¾®ç§’**åŠ 1ï¼Œæ‚¨è§£ç­”çš„æ—¶å€™å•ä½æ‰“é”™äº†<br>32ä½æ— ç¬¦å·æ•´æ•°ï¼Œå¦‚æœæ°å¥½æ˜¯4å¾®ç§’ï¼Œ2^32 &#47; 1 * 4 * 10^(-6) &#47; 3600 = 4.77h &gt; 4.55hï¼Œå› æ­¤æ—¶é’ŸåŠ 1çš„é€Ÿç‡ä¼šæ›´å¿«ç‚¹ã€‚","like_count":3,"discussions":[{"author":{"id":1849733,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/39/85/c6110f83.jpg","nickname":"é»„éª","note":"","ucode":"3C41D02F4F712C","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":350042,"discussion_content":"4mså¤ªé•¿äº†ï¼Œè€å¸ˆè‚¯å®šæ˜¯çœ‹é”™äº†microseconds","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1613689091,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":39546,"user_name":"Tom","can_delete":false,"product_type":"c1","uid":1109832,"ip_address":"","ucode":"00EEDE4CB11776","user_header":"","comment_is_top":false,"comment_ctime":1542299910,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"10132234502","product_id":100007101,"comment_content":"ä¸ºä»€ä¹ˆå­˜åœ¨å¤§é‡çš„ TIMEWAITï¼Œå¯èƒ½ä¼šå¯¼è‡´æ— æ³•å‘èµ·æ–°çš„è¿æ¥å‘¢ï¼Ÿé™¤äº†tcpè¶…è¿‡6ä¸‡å¤šè¿˜æœ‰å…¶ä»–æ— æ³•è¿æ¥çš„æƒ…å†µå—ï¼Ÿç¢°åˆ°è¿‡å­˜åœ¨å¾ˆå¤šè¿æ¥æœ‰æ—¶è¿ä¸ä¸Šï¼Œæ²¡æƒ³æ˜ç™½ã€‚","like_count":3,"discussions":[{"author":{"id":2171912,"avatar":"","nickname":"Geek_66e425","note":"","ucode":"0D07573C2E8246","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":334681,"discussion_content":"timewaitä¼šä½¿ç«¯å£ä¸å¯ç”¨","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1607934860,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":21873,"user_name":"tommyCmd","can_delete":false,"product_type":"c1","uid":1208393,"ip_address":"","ucode":"4ADBB1FA44668D","user_header":"https://static001.geekbang.org/account/avatar/00/12/70/49/d7690979.jpg","comment_is_top":false,"comment_ctime":1535382069,"is_pvip":true,"replies":[{"id":"7840","content":"å…è®¸ï¼Œå°±æ˜¯ipä¸å‡ºæœ¬æœºå°±å¯ä»¥ï¼Œå¤šç”¨äºä¸€ä¸ªå‡çš„ipåœ°å€ä½œä¸ºè™šæ‹Ÿipçš„æƒ…å†µ","user_name":"ä½œè€…å›å¤","user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘","uid":"1001590","ctime":1535419444,"ip_address":"","comment_id":21873,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10125316661","product_id":100007101,"comment_content":"è¯·é—®ä¸‹netmask255.255.255.255 è¢«å…è®¸å—ï¼Œé€šå¸¸ä»€ä¹ˆåœºæ™¯ä½¿ç”¨ï¼Ÿ ","like_count":3,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":422901,"discussion_content":"å…è®¸ï¼Œå°±æ˜¯ipä¸å‡ºæœ¬æœºå°±å¯ä»¥ï¼Œå¤šç”¨äºä¸€ä¸ªå‡çš„ipåœ°å€ä½œä¸ºè™šæ‹Ÿipçš„æƒ…å†µ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1535419444,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":23228,"user_name":"po","can_delete":false,"product_type":"c1","uid":1023905,"ip_address":"","ucode":"7DB36C278F34D7","user_header":"https://static001.geekbang.org/account/avatar/00/0f/9f/a1/d75219ee.jpg","comment_is_top":false,"comment_ctime":1536222394,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"5831189690","product_id":100007101,"comment_content":"é‚£pingå‘¢ï¼Ÿä¹Ÿæœ‰ipå’Œç«¯å£å—ï¼Ÿ","like_count":2},{"had_liked":false,"id":341849,"user_name":"Geek_9e80c7","can_delete":false,"product_type":"c1","uid":1938998,"ip_address":"","ucode":"C5BE38B4218DDC","user_header":"","comment_is_top":false,"comment_ctime":1649859993,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1649859993","product_id":100007101,"comment_content":"tcp_tw_recycleã€tcp_timestamps<br>åŒæ—¶å¯ç”¨ä¼šå¯¼è‡´ä¸å¯é¢„çŸ¥çš„é—®é¢˜ï¼Œæˆ‘é‡åˆ°è¿‡ç»æ­¤ä¼˜åŒ–è¿‡åï¼Œç³»ç»Ÿè¿è¡Œ9ä¸ªæœˆåå‡ºç°ç½‘ç»œé—®é¢˜ï¼Œé—®é¢˜ç°è±¡tcpæ¡æ‰‹é˜¶æ®µï¼ŒæœåŠ¡ç«¯æ”¶åˆ°synä½†ä¸åº”ç­”ackï¼Œå®¢æˆ·ç«¯ç½‘ç»œè¿æ¥çŠ¶æ€æ˜¯syn_sentè¿™ç§æƒ…å†µå°±è¦æŠ“åŒ…åˆ†æè€ƒè™‘æ˜¯å› ä¸ºæ—¶é—´æˆ³é—®é¢˜å¯¼è‡´ç›´æ¥è¢«æœåŠ¡ç«¯æ‹’ç»ã€‚è§¦å‘åœºæ™¯ä¸æ˜¯å‚æ•°ä¼˜åŒ–åç«‹å³å‘ç”Ÿé—®é¢˜ï¼Œè€Œæ˜¯ä¸ç¡®å®šæ—¶é—´ï¼Œå’Œä¸»æœºçš„æ—¶é’Ÿæ»´ç­”æ•°æœ‰å…³ã€‚è§£å†³æ–¹æ³•æ˜¯å¯ä»¥å¼€å¯tcpé‡ç”¨ã€‚","like_count":0},{"had_liked":false,"id":293544,"user_name":"å°é¾šå°é¾š é©¬åˆ°æˆåŠŸ ğŸ”¥","can_delete":false,"product_type":"c1","uid":2572557,"ip_address":"","ucode":"F137BE58BC1F48","user_header":"https://static001.geekbang.org/account/avatar/00/27/41/0d/99312186.jpg","comment_is_top":false,"comment_ctime":1621425852,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1621425852","product_id":100007101,"comment_content":"è¿˜æ˜¯ä¸æ˜¯å¾ˆç†è§£è¿æ¥è·Ÿè¸ªè¡¨é‚£é‡Œï¼Œæˆ‘çš„ç†è§£æ˜¯ï¼Œä¸€ä¸ªåŒ…ç”±å®¢æˆ·ç«¯å‘é€ç»™æœåŠ¡ç«¯çš„æ—¶å€™ï¼Œç»è¿‡NATè½¬æ¢çš„æ—¶å€™å°±ä¼šç»™å…¶åˆ†é…ä¸€ä¸ªç«¯å£å·ï¼Œè®°å½•åœ¨è·Ÿè¸ªè¡¨ä¸­ã€‚å½“åŒ…å›æ¥çš„æ—¶å€™ï¼Œæ ¹æ®è¿™ä¸ªç«¯å£å·åœ¨è¿æ¥è·Ÿè¸ªè¡¨ä¸­æŸ¥è¯¢ï¼Œå¾—åˆ°å…¶è¦å‘é€çš„æœåŠ¡ç«¯çš„ipä¿¡æ¯ã€‚","like_count":1},{"had_liked":false,"id":267591,"user_name":"å¤œè¾‰","can_delete":false,"product_type":"c1","uid":1886331,"ip_address":"","ucode":"9421385F51FF9E","user_header":"https://static001.geekbang.org/account/avatar/00/1c/c8/7b/153181d7.jpg","comment_is_top":false,"comment_ctime":1607838729,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1607838729","product_id":100007101,"comment_content":"è€å¸ˆå¥½ï¼Œstruct nf_conntrackå’Œnf_conntrack_tupleçš„ä»£ç ç»“æ„æ²¡æ˜¾ç¤ºï¼Œå†åŠ ä¸Šæ•°æ®ç»“æ„çš„åç§°ç›¸ä¼¼ï¼Œæ‰€ä»¥çœ‹èµ·æ¥è¿˜æ˜¯æœ‰ç‚¹ç»•ã€‚<br><br>æˆ‘è¯´ä¸‹æˆ‘çš„ç†è§£å’Œå›°æƒ‘ï¼Œæœ›å¤§å®¶å¤šå¤šæŒ‡æ­£<br><br>nf_conntrack_tupleâ€”â€”ã€‹nf_conntrack_tuple_hashï¼ˆäºŒè€…å†…å®¹ä¸€è‡´ï¼Œå°±æ˜¯æºIPã€æºPortã€ç›®çš„IPã€ç›®çš„Portï¼‰<br><br>nf_conntrack_tuple_hashâ€”â€”ã€‹nf_connï¼ˆLinux æä¾›çš„å‡½æ•°nf_ct_tuplehash_to_ctrackï¼‰ï¼Œæ ¹æ®**å€¼å†…å®¹**æ‰¾åˆ°å¼•ç”¨ï¼Œå¥½å¥‡è¿™é‡Œé¢çš„æ•°æ®ç»“æ„ï¼Œ","like_count":0},{"had_liked":false,"id":267569,"user_name":"å¤œè¾‰","can_delete":false,"product_type":"c1","uid":1886331,"ip_address":"","ucode":"9421385F51FF9E","user_header":"https://static001.geekbang.org/account/avatar/00/1c/c8/7b/153181d7.jpg","comment_is_top":false,"comment_ctime":1607831337,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1607831337","product_id":100007101,"comment_content":"è€å¸ˆï¼Œæˆ‘ç†è§£nf_connæœ‰ä¸¤ä¸ªnf_conntrack_hashï¼Œæ¯ä¸ªnf_conntrack_hashå¯¹åº”ä¸€ä¸ªnf_conntrack_tupleï¼ŒåŒ…å«çš„å†…å®¹éƒ½æ˜¯srcâ€”â€”&gt;dst<br><br>å¯ä»¥é€šè¿‡ nf_conntrack_hashï¼ˆå“ˆå¸Œè¡¨ï¼‰åˆ¤æ–­nf_conntrack_tupleï¼Œä½†æ˜¯æ–‡ä¸­ä¼¼ä¹æ²¡æœ‰çœ‹åˆ°ä»€ä¹ˆæ•°æ®ç»“æ„å¯ä»¥æ‰¾åˆ°nf_connï¼Ÿ","like_count":0},{"had_liked":false,"id":202011,"user_name":"wuw","can_delete":false,"product_type":"c1","uid":1073462,"ip_address":"","ucode":"C10AAB2B84274A","user_header":"https://static001.geekbang.org/account/avatar/00/10/61/36/1200614d.jpg","comment_is_top":false,"comment_ctime":1585887339,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1585887339","product_id":100007101,"comment_content":"tcp_tw_recycleè¿™ä¸ªé€‰é¡¹å·²ç»è¢«linuxå¼ƒç”¨äº†ï¼Œè¯¥é€‰é¡¹ä¼šå½±å“natåçš„æ•°æ®åŒ…çš„æ¥å—","like_count":1,"discussions":[{"author":{"id":1007254,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/5e/96/a03175bc.jpg","nickname":"è«å","note":"","ucode":"E28F2602BA25DD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":328903,"discussion_content":"æ˜¯çš„ï¼Œtcp_tw_recycleã€tcp_timestamps åŒæ—¶å¼€å¯çš„æƒ…å†µä¸‹ï¼ŒNAT åœºæ™¯ä¸‹å¯èƒ½ä¼šå‡ºç°é—®é¢˜ã€‚å†…æ ¸ 4.11 ç‰ˆæœ¬ä¹‹åå·²ç»å¼ƒç”¨ã€‚","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1606269543,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":139746,"user_name":"æ¸…æ–°ç¬å°æŸ æª¬","can_delete":false,"product_type":"c1","uid":1113587,"ip_address":"","ucode":"F3004F2F385096","user_header":"https://static001.geekbang.org/account/avatar/00/10/fd/f3/77223a8c.jpg","comment_is_top":false,"comment_ctime":1570715696,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1570715696","product_id":100007101,"comment_content":"å¯¹æˆ‘è€Œè¨€ï¼ŒçœŸçš„å¯ä»¥è¯´æ˜¯éå¸¸è¯¦ç»†ï¼Œéå¸¸æ·±å…¥äº†ã€‚æš‚æ—¶è¿˜ç”¨ä¸åˆ°è¿™ä¹ˆæ·±å…¥çš„çŸ¥è¯†","like_count":1}]}