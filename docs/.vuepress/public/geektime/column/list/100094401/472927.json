{"id":472927,"title":"32ï½œç¼–è¯‘åŸç†ï¼ˆä¸Šï¼‰ï¼šæ‰‹å†™ä¸€ä¸ªè¿·ä½ Vue 3 Compilerçš„å…¥é—¨åŸç†","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å¤§åœ£ã€‚</p><p>å‰é¢æˆ‘ä»¬ç”¨äº†å››è®²ï¼Œå­¦ä¹ äº†Vueåœ¨æµè§ˆå™¨ä¸­æ˜¯å¦‚ä½•æ‰§è¡Œçš„ï¼Œä½ å¯ä»¥å‚è€ƒä¸Šä¸€è®²ç»“å°¾çš„Vueæ‰§è¡Œå…¨æ™¯å›¾æ¥å›é¡¾ä¸€ä¸‹ã€‚åœ¨Vueä¸­ï¼Œç»„ä»¶éƒ½æ˜¯ä»¥è™šæ‹ŸDOMçš„å½¢å¼å­˜åœ¨ï¼ŒåŠ è½½å®Œæ¯•ä¹‹åæ³¨å†Œeffectå‡½æ•°ã€‚è¿™æ ·ç»„ä»¶å†…éƒ¨çš„æ•°æ®å˜åŒ–ä¹‹åï¼Œç”¨Vueçš„å“åº”å¼æœºåˆ¶åšåˆ°äº†é€šçŸ¥ç»„ä»¶æ›´æ–°ï¼Œå†…éƒ¨åˆ™ä½¿ç”¨patchå‡½æ•°å®ç°äº†è™šæ‹ŸDOMçš„æ›´æ–°ï¼Œä¸­é—´æˆ‘ä»¬ä¹Ÿå­¦ä¹ äº†ä½è¿ç®—ã€æœ€é•¿é€’å¢å­åºåˆ—ç­‰ç®—æ³•ã€‚</p><p>è¿™æ—¶å€™ä½ è‚¯å®šè¿˜æœ‰ä¸€ä¸ªç–‘é—®ï¼Œé‚£å°±æ˜¯è™šæ‹ŸDOMæ˜¯ä»å“ªæ¥çš„ï¼Ÿæˆ‘ä»¬æ˜æ˜å†™çš„æ˜¯templateå’ŒJSXï¼Œè¿™ä¹Ÿæ˜¯åƒé€Vueæºç æœ€åä¸€ä¸ªéš¾ç‚¹ï¼šVueä¸­çš„Compilerã€‚</p><p>ä¸‹å›¾å°±æ˜¯Vueæ ¸å¿ƒæ¨¡å—ä¾èµ–å…³ç³»å›¾ï¼Œreactivityå’Œruntimeæˆ‘ä»¬å·²ç»å‰–æå®Œæ¯•ï¼Œè¿·ä½ ç‰ˆæœ¬çš„ä»£ç ä½ å¯ä»¥åœ¨<a href=\"https://github.com/shengxinjing/weiyouyi\">GitHub</a>ä¸­çœ‹åˆ°ã€‚ä»Šå¤©å¼€å§‹æˆ‘å°†ç”¨ä¸‰è®²çš„å†…å®¹ï¼Œç»™ä½ è¯¦ç»†è®²è§£ä¸€ä¸‹Vueåœ¨ç¼–è¯‘çš„è¿‡ç¨‹ä¸­åšäº†ä»€ä¹ˆã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/59/15/59f10ba0b6a6ed5fb956ca05016fde15.jpg?wh=1888x982\" alt=\"å›¾ç‰‡\"></p><p>ç¼–è¯‘åŸç†ä¹Ÿå±äºè®¡ç®—æœºä¸­çš„ä¸€ä¸ªé‡è¦å­¦ç§‘ï¼ŒVueçš„compileræ˜¯åœ¨Vueåœºæ™¯ä¸‹çš„å®ç°ï¼Œç›®çš„å°±æ˜¯å®ç°templateåˆ°renderå‡½æ•°çš„è½¬å˜ã€‚</p><p>æˆ‘ä»¬ç¬¬ä¸€æ­¥éœ€è¦å…ˆæŒæ¡ç¼–è¯‘åŸç†çš„åŸºæœ¬æ¦‚å¿µã€‚Vueå®˜æ–¹æä¾›äº†æ¨¡æ¿ç¼–è¯‘çš„<a href=\"https://vue-next-template-explorer.netlify.app/#%7B%22src%22%3A%22%3Cdiv%20id%3D%5C%22app%5C%22%3E%5Cn%20%20%20%20%3Cdiv%20%40click%3D%5C%22()%3D%3Econsole.log(xx)%5C%22%20%3Aid%3D%5C%22name%5C%22%3E%7B%7Bname%7D%7D%3C%2Fdiv%3E%5Cn%20%20%20%20%3Ch1%20%3Aname%3D%5C%22title%5C%22%3E%E7%8E%A9%E8%BD%ACvue3%3C%2Fh1%3E%5Cn%20%20%20%20%3Cp%20%3E%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%3C%2Fp%3E%5Cn%3C%2Fdiv%3E%5Cn%22%2C%22ssr%22%3Afalse%2C%22options%22%3A%7B%22mode%22%3A%22module%22%2C%22filename%22%3A%22Foo.vue%22%2C%22prefixIdentifiers%22%3Afalse%2C%22hoistStatic%22%3Atrue%2C%22cacheHandlers%22%3Atrue%2C%22scopeId%22%3Anull%2C%22inline%22%3Afalse%2C%22ssrCssVars%22%3A%22%7B%20color%20%7D%22%2C%22compatConfig%22%3A%7B%22MODE%22%3A3%7D%2C%22whitespace%22%3A%22condense%22%2C%22bindingMetadata%22%3A%7B%22TestComponent%22%3A%22setup-const%22%2C%22setupRef%22%3A%22setup-ref%22%2C%22setupConst%22%3A%22setup-const%22%2C%22setupLet%22%3A%22setup-let%22%2C%22setupMaybeRef%22%3A%22setup-maybe-ref%22%2C%22setupProp%22%3A%22props%22%2C%22vMySetupDir%22%3A%22setup-const%22%7D%2C%22optimizeBindings%22%3Afalse%7D%7D\">åœ¨çº¿æ¼”ç¤º</a>ã€‚ä¸‹å›¾å·¦ä¾§ä»£ç æ˜¯æˆ‘ä»¬å†™çš„templateï¼Œå³ä¾§ä»£ç å°±æ˜¯compileræ¨¡å—è§£æåŸçš„renderå‡½æ•°ï¼Œæˆ‘ä»¬ä»Šå¤©çš„ä»»åŠ¡å°±æ˜¯èƒ½å¤Ÿå®ç°ä¸€ä¸ªè¿·ä½ çš„compilerã€‚</p><!-- [[[read_end]]] --><p><img src=\"https://static001.geekbang.org/resource/image/33/23/3326bd4f65d0714c4920e6d37e1be923.png?wh=1920x608\" alt=\"å›¾ç‰‡\"></p><h2>æ•´ä½“æµç¨‹</h2><p>ä¸Šè¿°è½¬åŒ–çš„è¿‡ç¨‹å¯ä»¥åˆ†ä¸ºä¸‹é¢çš„ç¤ºæ„å›¾å‡ æ­¥æ¥å®ç°ã€‚</p><p>é¦–å…ˆï¼Œä»£ç ä¼šè¢«è§£ææˆä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡æœ‰ç‚¹åƒè™šæ‹ŸDOMçš„æ¦‚å¿µï¼Œç”¨æ¥æè¿°templateçš„ä»£ç å…³ç³»ï¼Œè¿™ä¸ªå¯¹è±¡å°±æ˜¯æŠ½è±¡è¯­æ³•æ ‘ï¼ˆç®€ç§°ASTï¼Œåé¢æˆ‘ä»¬ç»†è®²ï¼‰ã€‚ç„¶åé€šè¿‡transformæ¨¡å—å¯¹ä»£ç è¿›è¡Œä¼˜åŒ–ï¼Œæ¯”å¦‚è¯†åˆ«Vueä¸­çš„è¯­æ³•ï¼Œé™æ€æ ‡è®°ã€æœ€åé€šè¿‡generateæ¨¡å—ç”Ÿæˆæœ€ç»ˆçš„renderå‡½æ•°ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/9a/6d/9aaa7b24f6b9ff0cef5f70151ddd926d.jpg?wh=1920x1747\" alt=\"å›¾ç‰‡\"></p><p>ç†æ¸…äº†æµç¨‹ï¼Œæˆ‘ä»¬åŠ¨æ‰‹å®Œæˆå…·ä½“ä»£ç å®ç°ã€‚ç”¨ä¸‹é¢çš„ä»£ç å°±èƒ½å®ç°ä¸Šè¿°çš„æµç¨‹å›¾é‡Œçš„å†…å®¹ã€‚å…¶ä¸­parseå‡½æ•°è´Ÿè´£ç”ŸæˆæŠ½è±¡è¯­æ³•æ ‘ASTï¼Œtransformå‡½æ•°è´Ÿè´£è¯­ä¹‰è½¬æ¢ï¼Œgenerateå‡½æ•°è´Ÿè´£æœ€ç»ˆçš„ä»£ç ç”Ÿæˆã€‚</p><pre><code class=\"language-javascript\">\nfunction compiler(template) {\n  const ast = parse(template);\n  transform(ast)\n  const code = generate(ast)\n  return code\n}\n\nlet template = `&lt;div id=\"app\"&gt;\n  &lt;div @click=\"()=&gt;console.log(xx)\" :id=\"name\"&gt;{{name}}&lt;/div&gt;\n  &lt;h1 :name=\"title\"&gt;ç©è½¬vue3&lt;/h1&gt;\n  &lt;p &gt;ç¼–è¯‘åŸç†&lt;/p&gt;\n&lt;/div&gt;\n`\n\nconst renderFunction = compiler(template)\nconsole.log(renderFunction)\n</code></pre><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹parseå‡½æ•°å¦‚ä½•å®ç°ã€‚templateè½¬æˆrenderå‡½æ•°æ˜¯ä¸¤ç§è¯­æ³•çš„è½¬æ¢ï¼Œè¿™ç§ä»£ç è½¬æ¢çš„éœ€æ±‚å…¶å®è®¡ç®—æœºçš„ä¸–ç•Œä¸­éå¸¸å¸¸è§ã€‚æ¯”å¦‚æˆ‘ä»¬å¸¸ç”¨çš„Babelï¼Œå°±æ˜¯æŠŠES6çš„è¯­æ³•è½¬æˆä½ç‰ˆæœ¬æµè§ˆå™¨å¯ä»¥æ‰§è¡Œçš„ä»£ç ã€‚</p><h2>tokenizerçš„è¿·ä½ å®ç°</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬è¦å¯¹templateè¿›è¡Œè¯æ³•åˆ†æï¼ŒæŠŠæ¨¡æ¿ä¸­çš„&lt;div&gt;,  @click, {{}}ç­‰è¯­æ³•è¯†åˆ«å‡ºæ¥ï¼Œè½¬æ¢æˆä¸€ä¸ªä¸ªçš„tokenã€‚ä½ å¯ä»¥ç†è§£ä¸ºæŠŠtemplateçš„è¯­æ³•è¿›è¡Œäº†åˆ†ç±»ï¼Œè¿™ä¸€æ­¥æˆ‘ä»¬å«tokenizerã€‚</p><p>ä¸‹é¢çš„ä»£ç å°±æ˜¯tokenizerçš„è¿·ä½ å®ç°ã€‚æˆ‘ä»¬ä½¿ç”¨tokensæ•°ç»„å­˜å‚¨è§£æçš„ç»“æœï¼Œç„¶åå¯¹æ¨¡æ¿å­—ç¬¦ä¸²è¿›è¡Œå¾ªç¯ï¼Œåœ¨templateä¸­ï¼Œ&lt; &gt; / å’Œç©ºæ ¼éƒ½æ˜¯å…³é”®çš„åˆ†éš”ç¬¦ï¼Œå¦‚æœç¢°è§&lt;å­—ç¬¦ï¼Œæˆ‘ä»¬éœ€è¦åˆ¤æ–­ä¸‹ä¸€ä¸ªå­—ç¬¦çš„çŠ¶æ€ã€‚å¦‚æœæ˜¯å­—ç¬¦ä¸²æˆ‘ä»¬å°±æ ‡è®°tagstartï¼›å¦‚æœæ˜¯/ï¼Œæˆ‘ä»¬å°±çŸ¥é“æ˜¯ç»“æŸæ ‡ç­¾ï¼Œæ ‡è®°ä¸ºtagendï¼Œæœ€ç»ˆé€šè¿‡pushæ–¹æ³•æŠŠåˆ†å‰²ä¹‹åçš„tokenå­˜å‚¨åœ¨æ•°ç»„tokensä¸­è¿”å›ã€‚</p><pre><code class=\"language-javascript\">function tokenizer(input) {\n  let tokens = []\n  let type = ''\n  let val = ''\n  // ç²—æš´å¾ªç¯\n  for (let i = 0; i &lt; input.length; i++) {\n    let ch = input[i]\n    if (ch === '&lt;') {\n      push()\n      if (input[i + 1] === '/') {\n        type = 'tagend'\n      } else {\n        type = 'tagstart'\n      }\n    } if (ch === '&gt;') {\n      if(input[i-1]=='='){\n        //ç®­å¤´å‡½æ•°\n      }else{\n        push()\n        type = \"text\"\n        continue\n      }\n    } else if (/[\\s]/.test(ch)) { // ç¢°è§ç©ºæ ¼æˆªæ–­ä¸€ä¸‹\n      push()\n      type = 'props'\n      continue\n    }\n    val += ch\n  }\n  return tokens\n\n  function push() {\n    if (val) {\n      if (type === \"tagstart\") val = val.slice(1) // &lt;div =&gt; div\n      if (type === \"tagend\") val = val.slice(2)   //  &lt;/div  =&gt; div\n      tokens.push({\n        type,\n        val\n      })\n      val = ''\n    }\n  }\n}\n</code></pre><p>å®ç°äº†ä¸Šé¢çš„ä»£ç ï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº†è§£æä¹‹åçš„tokenæ•°ç»„ã€‚</p><h2>ç”ŸæˆæŠ½è±¡è¯­æ³•æ ‘</h2><p>ä¸‹é¢çš„æ•°ç»„ä¸­ï¼Œæˆ‘ä»¬åˆ†åˆ«ç”¨tagstartã€props tagendå’Œtextæ ‡è®°ï¼Œç”¨å®ƒä»¬æ ‡è®°äº†å…¨éƒ¨å†…å®¹ã€‚ç„¶åä¸‹ä¸€æ­¥æˆ‘ä»¬éœ€è¦æŠŠè¿™ä¸ªæ•°ç»„æŒ‰ç…§æ ‡ç­¾çš„åµŒå¥—å…³ç³»è½¬æ¢æˆæ ‘å½¢ç»“æ„ï¼Œè¿™æ ·æ‰èƒ½å®Œæ•´åœ°æè¿°templateæ ‡ç­¾çš„å…³ç³»ã€‚</p><pre><code class=\"language-javascript\">[\n&nbsp; { type: 'tagstart', val: 'div' },\n&nbsp; { type: 'props', val: 'id=\"app\"' },\n&nbsp; { type: 'tagstart', val: 'div' },\n&nbsp; { type: 'props', val: '@click=\"()=console.log(xx)\"' },\n&nbsp; { type: 'props', val: ':id=\"name\"' },\n&nbsp; { type: 'text', val: '{{name}}' },\n&nbsp; { type: 'tagend', val: 'div' },\n&nbsp; { type: 'tagstart', val: 'h1' },\n&nbsp; { type: 'props', val: ':name=\"title\"' },\n&nbsp; { type: 'text', val: 'ç©è½¬vue3' },\n&nbsp; { type: 'tagend', val: 'h1' },\n&nbsp; { type: 'tagstart', val: 'p' },\n&nbsp; { type: 'text', val: 'ç¼–è¯‘åŸç†' },\n&nbsp; { type: 'tagend', val: 'p' },\n&nbsp; { type: 'tagend', val: 'div' }\n</code></pre><p>ç„¶åæˆ‘ä»¬åˆ†ætokenæ•°ç»„ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦‚ä½•è½¬åŒ–æˆä¸€ä¸ªä½“ç°è¯­æ³•è§„åˆ™çš„æ ‘å½¢ç»“æ„çš„ã€‚<br>\nå°±åƒæˆ‘ä»¬ç”¨è™šæ‹ŸDOMæè¿°é¡µé¢DOMç»“æ„ä¸€æ ·ï¼Œæˆ‘ä»¬ä½¿ç”¨æ ‘å½¢ç»“æ„æè¿°templateçš„è¯­æ³•ï¼Œè¿™ä¸ªæ ‘æˆ‘ä»¬ç§°ä¹‹ä¸ºæŠ½è±¡è¯­æ³•æ ‘ï¼Œç®€ç§°ASTã€‚</p><p>ä¸‹é¢çš„ä»£ç ä¸­æˆ‘ä»¬ç”¨parseå‡½æ•°å®ç°ASTçš„è§£æã€‚è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼Œé¦–å…ˆæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªASTå¯¹è±¡ä½œä¸ºæ ¹èŠ‚ç‚¹ã€‚ç„¶åé€šè¿‡walkå‡½æ•°éå†æ•´ä¸ªtokensæ•°ç»„ï¼Œæ ¹æ®tokençš„ç±»å‹ä¸åŒï¼Œç”Ÿæˆä¸åŒçš„nodeå¯¹è±¡ã€‚æœ€åæ ¹æ®tagendçš„çŠ¶æ€æ¥å†³å®šwalkçš„é€’å½’é€»è¾‘ï¼Œæœ€ç»ˆå®ç°äº†æ•´æ£µæ ‘çš„æ„å»ºã€‚</p><pre><code class=\"language-javascript\">function parse(template) {\n  const tokens = tokenizer(template)\n  let cur = 0\n  let ast = {\n    type: 'root',\n    props:[],\n    children: []\n  }\n  while (cur &lt; tokens.length) {\n    ast.children.push(walk())\n  }\n  return ast\n\n  function walk() {\n    let token = tokens[cur]\n    if (token.type == 'tagstart') {\n      let node = {\n        type: 'element',\n        tag: token.val,\n        props: [],\n        children: []\n      }\n      token = tokens[++cur]\n      while (token.type !== 'tagend') {\n        if (token.type == 'props') {\n          node.props.push(walk())\n        } else {\n          node.children.push(walk())\n        }\n        token = tokens[cur]\n      }\n      cur++\n      return node\n    }\n    if (token.type === 'tagend') {\n      cur++\n      // return token\n    }\n    if (token.type == \"text\") {\n      cur++\n      return token\n    }\n    if (token.type === \"props\") {\n      cur++\n      const [key, val] = token.val.replace('=','~').split('~')\n      return {\n        key,\n        val\n      }\n    }\n  }\n}\n</code></pre><p>ä¸Šé¢çš„ä»£ç ä¼šç”ŸæˆæŠ½è±¡è¯­æ³•æ ‘ASTï¼Œè¿™ä¸ªæ ‘çš„ç»“æ„å¦‚ä¸‹é¢ä»£ç æ‰€ç¤ºï¼Œé€šè¿‡typeå’Œchildrenæè¿°æ•´ä¸ªtemplateçš„ç»“æ„ã€‚</p><pre><code class=\"language-javascript\">{\n&nbsp; \"type\": \"root\",\n&nbsp; \"props\": [],\n&nbsp; \"children\": [\n&nbsp; &nbsp; {\n&nbsp; &nbsp; &nbsp; \"type\": \"element\",\n&nbsp; &nbsp; &nbsp; \"tag\": \"div\",\n&nbsp; &nbsp; &nbsp; \"props\": [\n&nbsp; &nbsp; &nbsp; &nbsp; {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \"key\": \"id\",\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \"val\": \"\\\"app\\\"\"\n&nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; &nbsp; ],\n&nbsp; &nbsp; &nbsp; \"children\": [\n&nbsp; &nbsp; &nbsp; &nbsp; {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \"type\": \"element\",\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \"tag\": \"div\",\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \"props\": [\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \"key\": \"@click\",\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \"val\": \"\\\"()\"\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; },\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \"key\": \":id\",\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \"val\": \"\\\"name\\\"\"\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ],\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \"children\": [\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \"type\": \"text\",\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \"val\": \"{{name}}\"\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ]\n&nbsp; &nbsp; &nbsp; &nbsp; },\n&nbsp; &nbsp; &nbsp; &nbsp; {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \"type\": \"element\",\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \"tag\": \"h1\",\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \"props\": [\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \"key\": \":name\",\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \"val\": \"\\\"title\\\"\"\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ],\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \"children\": [\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \"type\": \"text\",\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \"val\": \"ç©è½¬vue3\"\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ]\n&nbsp; &nbsp; &nbsp; &nbsp; },\n&nbsp; &nbsp; &nbsp; &nbsp; {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \"type\": \"element\",\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \"tag\": \"p\",\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \"props\": [],\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \"children\": [\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \"type\": \"text\",\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \"val\": \"ç¼–è¯‘åŸç†\"\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ]\n&nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; &nbsp; ]\n&nbsp; &nbsp; }\n&nbsp; ]\n}\n</code></pre><h2>è¯­ä¹‰åˆ†æå’Œä¼˜åŒ–</h2><p>æœ‰äº†æŠ½è±¡è¯­æ³•æ ‘ä¹‹åï¼Œæˆ‘ä»¬è¿˜è¦è¿›è¡Œè¯­ä¹‰çš„åˆ†æå’Œä¼˜åŒ–ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬è¦åœ¨è¿™ä¸ªé˜¶æ®µç†è§£è¯­å¥è¦åšçš„äº‹ã€‚å’±ä»¬ç»“åˆä¾‹å­æ¥ç†è§£ä¼šæ›´å®¹æ˜“ã€‚</p><p>åœ¨templateè¿™ä¸ªåœºæ™¯ä¸‹ï¼Œä¸¤ä¸ªå¤§æ‹¬å·åŒ…è£¹çš„å­—ç¬¦ä¸²å°±æ˜¯å˜é‡ï¼Œ@clickå°±æ˜¯äº‹ä»¶ç›‘å¬ã€‚</p><p>ä¸‹é¢çš„ä»£ç ä¸­æˆ‘ä»¬ä½¿ç”¨transformå‡½æ•°å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œè¿™ä¸€æ­¥ä¸»è¦æ˜¯ç†è§£templateä¸­Vueçš„è¯­æ³•ï¼Œå¹¶ä¸”ä¸ºæœ€åç”Ÿæˆçš„ä»£ç åšå‡†å¤‡ã€‚æˆ‘ä»¬ä½¿ç”¨contextå¯¹è±¡å­˜å‚¨ASTæ‰€éœ€è¦çš„ä¸Šä¸‹æ–‡ï¼Œå¦‚æœæˆ‘ä»¬ç”¨åˆ°äº†å˜é‡{{}}ï¼Œå°±éœ€è¦å¼•å…¥toDisplayStringå‡½æ•°ï¼Œä¸Šä¸‹æ–‡ä¸­çš„helperså­˜å‚¨çš„å°±æ˜¯æˆ‘ä»¬ç”¨åˆ°çš„å·¥å…·å‡½æ•°ã€‚</p><pre><code class=\"language-javascript\">function transform(ast) {\n  // ä¼˜åŒ–ä¸€ä¸‹ast\n  let context = {\n    // import { toDisplayString , createVNode , openBlock , createBlock } from \"vue\"\n    helpers:new Set(['openBlock','createVnode']), // ç”¨åˆ°çš„å·¥å…·å‡½æ•° \n  }\n  traverse(ast, context)\n  ast.helpers = context.helpers\n}\n</code></pre><p>ç„¶åæˆ‘ä»¬ä½¿ç”¨traverseå‡½æ•°é€’å½’æ•´ä¸ªASTï¼Œå»ä¼˜åŒ–ASTçš„ç»“æ„ï¼Œå¹¶ä¸”åœ¨è¿™ä¸€æ­¥å®ç°ç®€å•çš„é™æ€æ ‡è®°ã€‚</p><p>å½“èŠ‚ç‚¹æ ‡è®°ä¸ºelementçš„æ—¶å€™ï¼Œæˆ‘ä»¬é€’å½’è°ƒç”¨æ•´ä¸ªASTï¼Œå†…éƒ¨æŒ¨ä¸ªéå†ASTæ‰€æœ‰çš„å±æ€§ï¼Œæˆ‘ä»¬é»˜è®¤ä½¿ç”¨ast.flagæ ‡è®°èŠ‚ç‚¹çš„åŠ¨æ€çŠ¶æ€ã€‚å¦‚æœå±æ€§æ˜¯@å¼€å¤´çš„ï¼Œæˆ‘ä»¬å°±è®¤ä¸ºå®ƒæ˜¯Vueä¸­çš„äº‹ä»¶ç»‘å®šï¼Œä½¿ç”¨arg.flag|= PatchFlags.EVENT æ ‡è®°å½“å‰èŠ‚ç‚¹çš„äº‹ä»¶æ˜¯åŠ¨æ€çš„ï¼Œéœ€è¦è®¡ç®—diffï¼Œè¿™éƒ¨åˆ†ä½è¿ç®—çš„çŸ¥è¯†ç‚¹æˆ‘ä»¬åœ¨ä¸Šä¸€è®²å·²ç»å­¦ä¹ è¿‡äº†ã€‚</p><p>ç„¶åå†’å·å¼€å¤´çš„å°±æ˜¯åŠ¨æ€çš„å±æ€§ä¼ é€’ï¼Œå¹¶ä¸”æŠŠclasså’Œstyleæ ‡è®°äº†ä¸åŒçš„flagã€‚å¦‚æœéƒ½æ²¡æœ‰å‘½ä¸­çš„è¯ï¼Œå°±ä½¿ç”¨static:trueï¼Œæ ‡è®°å½“å‰èŠ‚ç‚¹ä½æ˜¯é™æ€èŠ‚ç‚¹ã€‚</p><pre><code class=\"language-javascript\">function traverse(ast, context){\n  switch(ast.type){\n    case \"root\":\n      context.helpers.add('createBlock')\n      // log(ast)\n    case \"element\":\n      ast.children.forEach(node=&gt;{\n        traverse(node,context)\n      })\n      ast.flag = 0\n      ast.props = ast.props.map(prop=&gt;{\n        const {key,val} = prop\n        if(key[0]=='@'){\n          ast.flag |= PatchFlags.EVENT // æ ‡è®°eventéœ€è¦æ›´æ–°\n          return {\n            key:'on'+key[1].toUpperCase()+key.slice(2),\n            val\n          }\n        }\n        if(key[0]==':'){\n          const k = key.slice(1)\n          if(k==\"class\"){\n            ast.flag |= PatchFlags.CLASS // æ ‡è®°classéœ€è¦æ›´æ–°\n\n          }else if(k=='style'){\n            ast.flag |= PatchFlags.STYLE // æ ‡è®°styleéœ€è¦æ›´æ–°\n          }else{\n            ast.flag |= PatchFlags.PROPS // æ ‡è®°propséœ€è¦æ›´æ–°\n          }\n          return{\n            key:key.slice(1),\n            val\n          }\n        }\n        if(key.startsWith('v-')){\n          // pass such as v-model \n        }\n        //æ ‡è®°staticæ˜¯true é™æ€èŠ‚ç‚¹\n        return {...prop,static:true} \n      })\n      break\n    case \"text\":\n      // trnsformText\n      let re = /\\{\\{(.*)\\}\\}/g\n      if(re.test(ast.val)){\n        //æœ‰{{\n          ast.flag |= PatchFlags.TEXT // æ ‡è®°propséœ€è¦æ›´æ–°\n          context.helpers.add('toDisplayString')\n          ast.val = ast.val.replace(/\\{\\{(.*)\\}\\}/g,function(s0,s1){\n            return s1\n          })\n      }else{\n        ast.static = true\n      }\n  }\n}  \n\n</code></pre><p>ç»è¿‡ä¸Šé¢çš„ä»£ç æ ‡è®°ä¼˜åŒ–ä¹‹åï¼Œé¡¹ç›®åœ¨æ•°æ®æ›´æ–°ä¹‹åï¼Œæµè§ˆå™¨è®¡ç®—è™šæ‹Ÿdom diffè¿ç®—çš„æ—¶å€™ï¼Œå°±ä¼šæ‰§è¡Œç±»ä¼¼ä¸‹é¢çš„ä»£ç é€»è¾‘ã€‚</p><p><strong>æˆ‘ä»¬é€šè¿‡åœ¨compileré˜¶æ®µçš„æ ‡è®°ï¼Œè®©templateäº§å‡ºçš„è™šæ‹ŸDOMæœ‰äº†æ›´ç²¾ç¡®çš„çŠ¶æ€ï¼Œå¯ä»¥è¶Šè¿‡å¤§éƒ¨åˆ†çš„è™šæ‹ŸDOMçš„diffè®¡ç®—ï¼Œæå¤§æé«˜Vueçš„è¿è¡Œæ—¶æ•ˆç‡ï¼Œè¿™ä¸ªæ€æƒ³æˆ‘ä»¬æ—¥å¸¸å¼€å‘ä¸­ä¹Ÿå¯ä»¥å€Ÿé‰´å­¦ä¹ ã€‚</strong></p><pre><code class=\"language-javascript\">if(vnode.static){\n  return \n}\nif(vnode.flag &amp; patchFlag.CLASS){\n  éå†class è®¡ç®—diff  \n}else if(vnode.flag &amp; patchFlag.STYLE){\n  è®¡ç®—styleçš„diff\n}else if(vnode.flag &amp; patchFlag.TEXT){\n  è®¡ç®—æ–‡æœ¬çš„diff\n}\n</code></pre><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åŸºäºä¼˜åŒ–ä¹‹åçš„ASTç”Ÿæˆç›®æ ‡ä»£ç ï¼Œä¹Ÿå°±æ˜¯generateå‡½æ•°è¦åšçš„äº‹ï¼šéå†æ•´ä¸ªASTï¼Œæ‹¼æ¥æˆæœ€åè¦æ‰§è¡Œçš„å‡½æ•°å­—ç¬¦ä¸²ã€‚</p><p>ä¸‹é¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆæŠŠhelpersæ‹¼æ¥æˆimportè¯­å¥ï¼Œå¹¶ä¸”ä½¿ç”¨walkå‡½æ•°éå†æ•´ä¸ªASTï¼Œåœ¨éå†çš„è¿‡ç¨‹ä¸­æ”¶é›†helperé›†åˆçš„ä¾èµ–ã€‚æœ€åï¼Œåœ¨createVnodeçš„æœ€åä¸€ä¸ªå‚æ•°å¸¦ä¸Šast.flagè¿›è¡ŒçŠ¶æ€çš„æ ‡è®°ã€‚</p><pre><code class=\"language-javascript\">function generate(ast) {\n  const {helpers} = ast \n\n  let code = `\nimport {${[...helpers].map(v=&gt;v+' as _'+v).join(',')}} from 'vue'\\n\nexport function render(_ctx, _cache, $props){\n  return(_openBlock(), ${ast.children.map(node=&gt;walk(node))})}`\n\n  function walk(node){\n    switch(node.type){\n      case 'element':\n        let {flag} = node // ç¼–è¯‘çš„æ ‡è®°\n        let props = '{'+node.props.reduce((ret,p)=&gt;{\n          if(flag.props){\n            //åŠ¨æ€å±æ€§\n            ret.push(p.key +':_ctx.'+p.val.replace(/['\"]/g,'') )\n          }else{\n            ret.push(p.key +':'+p.val )\n          }\n\n          return ret\n        },[]).join(',')+'}'\n        return `_createVnode(\"${node.tag}\",${props}),[\n          ${node.children.map(n=&gt;walk(n))}\n        ],${JSON.stringify(flag)}`\n        break\n      case 'text':\n        if(node.static){\n          return '\"'+node.val+'\"'\n        }else{\n          return `_toDisplayString(_ctx.${node.val})`\n        }\n        break\n    }\n  }\n  return code\n}\n</code></pre><h2>æœ€ç»ˆå®ç°æ•ˆæœ</h2><p>æœ€åæˆ‘ä»¬æ‰§è¡Œä¸€ä¸‹ä»£ç ï¼Œçœ‹ä¸‹æ•ˆæœè¾“å‡ºçš„ä»£ç ã€‚å¯ä»¥çœ‹åˆ°ï¼Œå®ƒå·²ç»å’ŒVueè¾“å‡ºçš„ä»£ç å¾ˆæ¥è¿‘äº†ï¼Œåˆ°æ­¤ä¸ºæ­¢ï¼Œæˆ‘ä»¬ä¹Ÿå®ç°äº†ä¸€ä¸ªéå¸¸è¿·ä½ çš„Vue compilerï¼Œè¿™ä¸ªäº§å‡ºçš„renderå‡½æ•°æœ€ç»ˆä¼šå’Œç»„ä»¶çš„setupå‡½æ•°ä¸€èµ·ç»„æˆè¿è¡Œæ—¶çš„ç»„ä»¶å¯¹è±¡ã€‚</p><pre><code class=\"language-javascript\">function compiler(template) {\n  const ast = parse(template);\n  transform(ast)\n\n  const code = generate(ast)\n  return code\n}\n\nlet template = `&lt;div id=\"app\"&gt;\n  &lt;div @click=\"()=&gt;console.log(xx)\" :id=\"name\"&gt;{{name}}&lt;/div&gt;\n  &lt;h1 :name=\"title\"&gt;ç©è½¬vue3&lt;/h1&gt;\n  &lt;p &gt;ç¼–è¯‘åŸç†&lt;/p&gt;\n&lt;/div&gt;\n`\n\nconst renderFunction = compiler(template)\nconsole.log(renderFunction)\n\n// ä¸‹é¢æ˜¯è¾“å‡ºç»“æœ\nimport { openBlock as _openBlock, createVnode as _createVnode, createBlock as _createBlock, toDisplayString as _toDisplayString } from 'vue'\n\nexport function render(_ctx, _cache, $props) {\n  return (_openBlock(), _createVnode(\"div\", { id: \"app\" }), [\n    _createVnode(\"div\", { onClick: \"()=&gt;console.log(xx)\", id: \"name\" }), [\n      _toDisplayString(_ctx.name)\n    ], 24, _createVnode(\"h1\", { name: \"title\" }), [\n      \"ç©è½¬vue3\"\n    ], 8, _createVnode(\"p\", {}), [\n      \"ç¼–è¯‘åŸç†\"\n    ], 0\n  ], 0)\n}\n\n</code></pre><h2>æ€»ç»“</h2><p>æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ä»Šå¤©æ‰€å­¦çš„å†…å®¹ã€‚ä»Šå¤©ï¼Œæˆ‘å¸¦ä½ æ‰‹å†™äº†ä¸€ä¸ªéå¸¸è¿·ä½ çš„Vue compilerï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬å­¦ä¹ æ¡†æ¶æºç çš„æ—¶å€™ä¸€ä¸ªæ¯”è¾ƒæ­£ç¡®çš„æ€è·¯ï¼šåœ¨å»çœ‹å®é™…çš„æºç ä¹‹å‰ï¼Œå…ˆé€šè¿‡è¿·ä½ ç‰ˆæœ¬çš„å®ç°ï¼Œç†Ÿæ‚‰æ•´ä¸ªVue compilerå·¥ä½œçš„ä¸»ä½“æµç¨‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/ce/0d/ce5d04ae043d4247b4yy03e91353620d.jpg?wh=1920x453\" alt=\"å›¾ç‰‡\"></p><p>é€šè¿‡è¿™ä¸ªè¿·ä½ çš„compilerï¼Œæˆ‘ä»¬å­¦ä¹ äº†ç¼–è¯‘åŸç†çš„å…¥é—¨çŸ¥è¯†ï¼šåŒ…æ‹¬parserçš„å®ç°ã€ASTæ˜¯ä»€ä¹ˆï¼ŒASTçš„è¯­ä¹‰åŒ–ä¼˜åŒ–å’Œä»£ç ç”Ÿæˆgenerateæ¨¡å—ï¼Œè¿™ç»™æˆ‘ä»¬ä¸‹ä¸€è®²å¼„æ¸…æ¥šVueçš„compilerçš„æ ¸å¿ƒé€»è¾‘æ‰“ä¸‹äº†è‰¯å¥½çš„ç†è®ºåŸºç¡€ã€‚</p><p>æˆ‘æƒ³æé†’ä½ æ³¨æ„ä¸€ä¸ªä¼˜åŒ–æ–¹æ³•ï¼Œæˆ‘ä»¬å®ç°çš„è¿·ä½ compilerä¹Ÿå®ç°äº†å±æ€§çš„é™æ€æ ‡è®°ï¼Œé€šè¿‡åœ¨ç¼–è¯‘æœŸé—´çš„æ ‡è®°æ–¹å¼ï¼Œè®©è™šæ‹ŸDOMåœ¨è¿è¡Œæ—¶æœ‰æ›´å¤šçš„çŠ¶æ€ï¼Œä»è€Œèƒ½å¤Ÿç²¾ç¡®åœ°æ§åˆ¶æ›´æ–°ã€‚è¿™ç§ç¼–è¯‘æ—¶çš„ä¼˜åŒ–ä¹Ÿèƒ½å¤Ÿå¯¹æˆ‘ä»¬é¡¹ç›®å¼€å‘æœ‰å¾ˆå¤šæŒ‡å¼•ä½œç”¨ï¼Œæˆ‘ä¼šåœ¨å‰–æå®ŒVueçš„compilerä¹‹åï¼Œåœ¨ç¬¬34è®²é‚£é‡Œè·Ÿä½ åˆ†äº«ä¸€ä¸‹å®æˆ˜ä¸­å¦‚ä½•ä½¿ç”¨ç¼–è¯‘ä¼˜åŒ–çš„æ€æƒ³ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>æœ€åç•™ä¸€ä¸ªæ€è€ƒé¢˜å§ï¼ŒVueçš„compilerè¾“å‡ºçš„ä»£ç ä¼šæœ‰å‡ ä¸ªhoistedå¼€å¤´çš„å˜é‡ï¼Œè¿™å‡ ä¸ªå˜é‡æœ‰ä»€ä¹ˆç”¨å¤„å‘¢ï¼Ÿæ¬¢è¿åœ¨è¯„è®ºåŒºåˆ†äº«ä½ çš„ç­”æ¡ˆï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™ä¸€è®²åˆ†äº«ç»™ä½ çš„åŒäº‹å’Œæœ‹å‹ä»¬ï¼Œæˆ‘ä»¬ä¸‹ä¸€è®²å†è§ï¼</p>","neighbors":{"left":{"article_title":"31ï½œè™šæ‹ŸDOMï¼ˆä¸‹ï¼‰ï¼šæƒ³çœ‹æ‡‚è™šæ‹ŸDOMç®—æ³•ï¼Œå…ˆåˆ·ä¸ªç®—æ³•é¢˜","id":471017},"right":{"article_title":"33 | ç¼–è¯‘åŸç†ï¼ˆä¸­ï¼‰ï¼šVue Compileræ¨¡å—å…¨è§£æ","id":473181}},"comments":[{"had_liked":false,"id":346315,"user_name":"é™ˆåšæ³“","can_delete":false,"product_type":"c1","uid":2461961,"ip_address":"","ucode":"75258EE1BF1C2A","user_header":"https://static001.geekbang.org/account/avatar/00/25/91/09/6f0b987a.jpg","comment_is_top":false,"comment_ctime":1653018100,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1653018100","product_id":100094401,"comment_content":"const [key, val] = token.val.replace(&#39;=&#39;,&#39;~&#39;).split(&#39;~&#39;)  <br>æ˜¯ä¸æ˜¯å¯ä»¥å†™æˆ<br>const [key, val] = token.val.split(&#39;=&#39;)  <br><br>å¤‡æ³¨é‡Œ &#47;&#47; trnsformText    ä¼°è®¡æ˜¯æ‹¼é”™äº† ","like_count":0},{"had_liked":false,"id":341699,"user_name":"Blueberry","can_delete":false,"product_type":"c1","uid":2942699,"ip_address":"","ucode":"072EF4E4A9F447","user_header":"https://static001.geekbang.org/account/avatar/00/2c/e6/eb/58da8565.jpg","comment_is_top":false,"comment_ctime":1649775675,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1649775675","product_id":100094401,"comment_content":"templateè¯­æ³•éœ€è¦ç»è¿‡è¿™ä¹ˆä¸€ç³»åˆ—çš„ç¼–è¯‘ï¼Œé‚£hå‡½æ•°å‘¢ï¼Œæ˜¯ç»è¿‡ä»€ä¹ˆå˜æˆäº†æœ€åçš„renderè¯­æ³•?","like_count":0},{"had_liked":false,"id":333029,"user_name":"åå­—å¥½é•¿çš„å¤§æ—","can_delete":false,"product_type":"c1","uid":1998008,"ip_address":"","ucode":"FF5887D3E5DE9B","user_header":"https://static001.geekbang.org/account/avatar/00/1e/7c/b8/b4e0dfb0.jpg","comment_is_top":false,"comment_ctime":1643987257,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1643987257","product_id":100094401,"comment_content":"PatchFlags è¿™ä¸ªå˜é‡æ²¡æœ‰ç»™ï¼Ÿï¼Ÿ","like_count":0,"discussions":[{"author":{"id":2817674,"avatar":"https://static001.geekbang.org/account/avatar/00/2a/fe/8a/8b5f5a66.jpg","nickname":"ä¸‹ä¸€ä¸ªèµ·è·‘ç‚¹","note":"","ucode":"5EDC478AE4CBA2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576416,"discussion_content":"ä¸Šä¸€èŠ‚å·²ç»è®²è¿‡äº†ï¼Œé‚£é‡Œæœ‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655533097,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":332687,"user_name":"ç¥ç˜¦","can_delete":false,"product_type":"c1","uid":1607746,"ip_address":"","ucode":"900C5845D88274","user_header":"https://static001.geekbang.org/account/avatar/00/18/88/42/176ddd62.jpg","comment_is_top":false,"comment_ctime":1643473720,"is_pvip":false,"replies":[{"id":"121572","content":"æ”¶åˆ°ï¼Œå·²ç»æ›´æ–°å•¦ï¼Œè°¢è°¢åé¦ˆ","user_name":"ç¼–è¾‘å›å¤","comment_id":332687,"uid":"1501385","ip_address":"","utype":2,"ctime":1643492651,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"1643473720","product_id":100094401,"comment_content":"â€œtokenizer çš„è¿·ä½ å®ç°â€è¿™ä¸ªåœ°æ–¹â€œæŠŠæ¨¡æ¿ä¸­çš„â€è¿™å‡ ä¸ªå­—åé¢ä¸€å¤§æ®µç©ºç™½å‘¢ï¼Œä½ ä»¬é‚£è¾¹èƒ½çœ‹åˆ°å—ï¼Ÿæ£€æŸ¥ä¸‹å‘¢","like_count":0,"discussions":[{"author":{"id":1501385,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e8/c9/59bcd490.jpg","nickname":"å¬æ°´çš„æ¹–","note":"","ucode":"B1759F90165D81","race_medal":0,"user_type":8,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":548988,"discussion_content":"æ”¶åˆ°ï¼Œå·²ç»æ›´æ–°å•¦ï¼Œè°¢è°¢åé¦ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1643492651,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":8}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":329555,"user_name":"openbilibili","can_delete":false,"product_type":"c1","uid":1354408,"ip_address":"","ucode":"57CF3971A268B9","user_header":"https://static001.geekbang.org/account/avatar/00/14/aa/a8/6ca767ca.jpg","comment_is_top":false,"comment_ctime":1641404043,"is_pvip":false,"replies":[{"id":"120224","content":"æˆ‘ä»¬è¿™ä¸ªæ¯•ç«Ÿæ˜¯è¿·ä½ çš„ç‰ˆæœ¬ï¼Œè€ƒè™‘çš„æƒ…å†µæ¯”è¾ƒå°‘ï¼ŒåŸºæœ¬åªè€ƒè™‘äº†æœ€æ ¸å¿ƒçš„è§£æè·¯å¾„ï¼Œè¾¹ç¼˜caseä¸æ–­å®Œå–„çš„æ—¶å€™ï¼Œæ¡†æ¶ä¹Ÿä¼šè¶Šæ¥è¶Šæ¸…æ™°ï¼Œè¿™é‡Œå¯ä»¥å‚è€ƒvue-compiler-coreçš„å®ç°","user_name":"ä½œè€…å›å¤","comment_id":329555,"uid":"1003715","ip_address":"","utype":1,"ctime":1641774330,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"1641404043","product_id":100094401,"comment_content":"templateä¸­çš„pæ ‡ç­¾ ä¸èƒ½æœ‰ç©ºæ ¼ ä¸ç„¶è§£æä¸äº†","like_count":0,"discussions":[{"author":{"id":1003715,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/50/c3/0aa50246.jpg","nickname":"èŠ±æœå±±å¤§åœ£","note":"","ucode":"25C0A36D628037","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":544898,"discussion_content":"æˆ‘ä»¬è¿™ä¸ªæ¯•ç«Ÿæ˜¯è¿·ä½ çš„ç‰ˆæœ¬ï¼Œè€ƒè™‘çš„æƒ…å†µæ¯”è¾ƒå°‘ï¼ŒåŸºæœ¬åªè€ƒè™‘äº†æœ€æ ¸å¿ƒçš„è§£æè·¯å¾„ï¼Œè¾¹ç¼˜caseä¸æ–­å®Œå–„çš„æ—¶å€™ï¼Œæ¡†æ¶ä¹Ÿä¼šè¶Šæ¥è¶Šæ¸…æ™°ï¼Œè¿™é‡Œå¯ä»¥å‚è€ƒvue-compiler-coreçš„å®ç°","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641774331,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":329179,"user_name":"æ–œæœˆæµ®äº‘","can_delete":false,"product_type":"c1","uid":1008933,"ip_address":"","ucode":"25CECBB175DA02","user_header":"https://static001.geekbang.org/account/avatar/00/0f/65/25/c6de04bc.jpg","comment_is_top":false,"comment_ctime":1641197674,"is_pvip":false,"replies":[{"id":"120855","content":"cool   æˆ‘æ£€æŸ¥ä¸€ä¸‹  ","user_name":"ä½œè€…å›å¤","comment_id":329179,"uid":"1003715","ip_address":"","utype":1,"ctime":1642339846,"user_name_real":"ç¼–è¾‘"}],"discussion_count":2,"race_medal":1,"score":"1641197674","product_id":100094401,"comment_content":"hoistedå¼€å¤´çš„å˜é‡ç”¨äºé™æ€èŠ‚ç‚¹æå‡ï¼Œè¯´ç™½äº†å°±æ˜¯åœ¨æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­åªéœ€è¦è¿›è¡Œä¸€æ¬¡åˆ›å»ºï¼Œæœ‰æ•ˆèŠ‚çœä¸å¿…è¦çš„æ€§èƒ½å¼€é”€ã€‚<br><br>è¯è¯´æœ€åçš„generateä»£ç æ˜æ˜¾ä¸å¯¹å•Šï¼ŒcreateVnodeçš„åæ‹¬å·é˜”æ­ªäº†å“¦~ğŸ™‚","like_count":0,"discussions":[{"author":{"id":1003715,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/50/c3/0aa50246.jpg","nickname":"èŠ±æœå±±å¤§åœ£","note":"","ucode":"25C0A36D628037","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546560,"discussion_content":"cool   æˆ‘æ£€æŸ¥ä¸€ä¸‹  ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642339846,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2826309,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/20/45/6c8bb3aa.jpg","nickname":"å°èŠ±ï¼ˆfaï¼‰","note":"","ucode":"7F88A9F990712B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":552953,"discussion_content":"hoisted_4æ˜¯é™æ€æ ‡ç­¾å¯ä»¥ç†è§£ï¼Œhoisted_2, hoisted_3 æ˜¯åŠ¨æ€å±æ€§idï¼Œname,è¿™éƒ¨åˆ†æ€ä¹ˆè§£é‡Šå‘¢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1645666484,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}