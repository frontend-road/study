{"id":526944,"title":"42｜RESTful Web Services（6）：如何处理JAX-RS定义的异常类？","content":"<p>你好，我是徐昊。今天我们继续使用TDD的方式实现RESTful Web Services。</p><h2>回顾架构愿景与任务列表</h2><p>目前我们的架构愿景如下：</p><p><img src=\"https://static001.geekbang.org/resource/image/ed/2e/ed95e0629105b3fe661590be6ab4af2e.jpg?wh=2284x1285\" alt=\"\"><br>\n<img src=\"https://static001.geekbang.org/resource/image/aa/56/aacdc2230e337d593308c0184b799956.jpg?wh=2284x1285\" alt=\"\"></p><p>任务列表为：</p><ul>\n<li>\n<p>ResourceServlet</p>\n<ul>\n<li>\n<p>将请求派分给对应的资源（Resource），并根据返回的状态、超媒体类型、内容，响应Http请求</p>\n<ul>\n<li><s>使用OutboundResponse的status作为Http Response的状态</s></li>\n<li><s>使用OutboundResponse的headers作为Http Response的Http Headers</s></li>\n<li><s>通过MessageBodyWriter将OutboundResponse的GenericEntity写回为Body</s></li>\n<li>如果找不到对应的MessageBody，则返回500族错误</li>\n</ul>\n</li>\n<li>\n<p>当资源方法抛出异常时，根据异常影响Http请求</p>\n<ul>\n<li>如果抛出WebApplicationException，且response不为null，则使用response响应Http</li>\n<li>如果抛出WebApplicationException，而response为null，则通过异常的具体类型查找ExceptionMapper，生产response响应Http请求</li>\n<li>如果抛出的不是WebApplicationException，则通过异常的具体类型查找ExceptionMapper，生产response响应Http请求</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>RuntimeDelegate</p>\n<ul>\n<li>为MediaType提供HeaderDelegate</li>\n<li>为CacheControl提供HeaderDelegate</li>\n<li>为Cookie提供HeaderDelegates</li>\n<li>为EntityTag提供HeaderDelegate</li>\n<li>为Link提供HeaderDelegate</li>\n<li>为NewCookie提供HeaderDelegate</li>\n<li>为Date提供HeaderDelegate</li>\n</ul>\n</li>\n</ul><!-- [[[read_end]]] --><p>代码为：</p><pre><code>package geektime.tdd.rest;\n\nimport jakarta.servlet.ServletException;\nimport jakarta.servlet.http.HttpServlet;\nimport jakarta.servlet.http.HttpServletRequest;\nimport jakarta.servlet.http.HttpServletResponse;\nimport jakarta.ws.rs.core.GenericEntity;\nimport jakarta.ws.rs.core.MultivaluedMap;\nimport jakarta.ws.rs.ext.MessageBodyWriter;\nimport jakarta.ws.rs.ext.Providers;\nimport jakarta.ws.rs.ext.RuntimeDelegate;\nimport java.io.IOException;\n\npublic class ResourceServlet extends HttpServlet {\n\n    private Runtime runtime;\n    \n    public ResourceServlet(Runtime runtime) {\n        this.runtime = runtime;\n    }\n    \n    @Override\n    protected void service(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {\n        ResourceRouter router = runtime.getResourceRouter();\n        Providers providers = runtime.getProviders();\n        \n        OutboundResponse response = router.dispatch(req, runtime.createResourceContext(req, resp));\n        \n        resp.setStatus(response.getStatus());\n        \n        MultivaluedMap&lt;String, Object&gt; headers = response.getHeaders();\n        for (String name : headers.keySet())\n            for (Object value : headers.get(name)) {\n                RuntimeDelegate.HeaderDelegate headerDelegate = RuntimeDelegate.getInstance().createHeaderDelegate(value.getClass());\n                resp.addHeader(name, headerDelegate.toString(value));\n            }\n            \n        GenericEntity entity = response.getGenericEntity();\n        MessageBodyWriter writer = providers.getMessageBodyWriter(entity.getRawType(), entity.getType(), response.getAnnotations(), response.getMediaType());\n        writer.writeTo(entity.getEntity(), entity.getRawType(), entity.getType(), response.getAnnotations(), response.getMediaType(),\n                response.getHeaders(), resp.getOutputStream());\n    }\n}\n</code></pre><h2>视频演示</h2><p>下面让我们继续：</p><p><video poster=\"https://media001.geekbang.org/6de8f3214bbd4fb4a66906e2fe8b885d/snapshots/349caa7a035948adb602bc2e962e2b42-00005.jpg\" preload=\"none\" controls=\"\"><source src=\"https://media001.geekbang.org/customerTrans/7e27d07d27d407ebcc195a0e78395f55/14eee078-1815c76fcab-0000-0000-01d-dbacd.mp4\" type=\"video/mp4\"><source src=\" https://media001.geekbang.org/60f75862b6f14550825a85176c218b32/60d3a01ba6ab4faf829e3c79d5d72fde-07082fb65ff7b2e68b5a5b7d2f5869eb-sd.m3u8\" type=\"application/x-mpegURL\"></video></p><h2>思考题</h2><p>在进入下节课之前，希望你能认真思考如下两个问题。</p><ol>\n<li>目前的Sad Path任务是否足够？还有哪些Sad Path的情况？</li>\n<li>在这节课的学习中，你最大的收获是什么？</li>\n</ol><p>欢迎把你的想法分享在留言区，也欢迎把你的项目代码分享出来。相信经过你的思考与实操，学习效果会更好！</p>","neighbors":{"left":{"article_title":"41｜RESTful Web Services（5）：如何通过对数据测试的管理来凸显意图？","id":526940},"right":{"article_title":"43｜RESTful Web Services（7）：剩下两个Sad Path场景该如何处理？","id":526946}},"comments":[{"had_liked":false,"id":349197,"user_name":"张铁林","can_delete":false,"product_type":"c1","uid":1108258,"ip_address":"","ucode":"4AB8BC6CDAC0A3","user_header":"https://static001.geekbang.org/account/avatar/00/10/e9/22/7606c6ba.jpg","comment_is_top":false,"comment_ctime":1655793085,"is_pvip":false,"replies":[{"id":127084,"content":"good job！送你一朵小红花！","user_name":"编辑回复","user_name_real":"编辑","uid":2189689,"ctime":1655798250,"ip_address":"","comment_id":349197,"utype":2}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100109401,"comment_content":"https:&#47;&#47;github.com&#47;vfbiby&#47;tdd-restful&#47;blob&#47;main&#47;doc&#47;Geektime%20TDD%2042.md\n这是操作步骤，我是先看视频纪录，再自己跟着步骤做，相当于检查了一遍。\n这章做了3次提交，","like_count":1,"discussions":[{"author":{"id":2189689,"avatar":"https://static001.geekbang.org/account/avatar/00/21/69/79/b4132042.jpg","nickname":"🐑","note":"","ucode":"DE34B3B14287D1","race_medal":0,"user_type":8,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576816,"discussion_content":"good job！送你一朵小红花！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655798250,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":4}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":349120,"user_name":"aoe","can_delete":false,"product_type":"c1","uid":1121758,"ip_address":"","ucode":"1C6201EDB4E954","user_header":"https://static001.geekbang.org/account/avatar/00/11/1d/de/62bfa83f.jpg","comment_is_top":false,"comment_ctime":1655738826,"is_pvip":false,"replies":[{"id":127085,"content":"哎呀呀 太棒了！也送你一朵小红花🌺","user_name":"编辑回复","user_name_real":"编辑","uid":2189689,"ctime":1655798272,"ip_address":"","comment_id":349120,"utype":2}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100109401,"comment_content":"代码 https:&#47;&#47;github.com&#47;wyyl1&#47;geektime-tdd-framework&#47;tree&#47;6","like_count":1,"discussions":[{"author":{"id":2189689,"avatar":"https://static001.geekbang.org/account/avatar/00/21/69/79/b4132042.jpg","nickname":"🐑","note":"","ucode":"DE34B3B14287D1","race_medal":0,"user_type":8,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576817,"discussion_content":"哎呀呀 太棒了！也送你一朵小红花🌺","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1655798272,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":4}","child_discussion_number":0,"child_discussions":[]}]}]}