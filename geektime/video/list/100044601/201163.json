{"id":201163,"title":"29 | 定义仓储：使用EF Core实现仓储层","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/NET-Core\">https://gitee.com/geektime-geekbang/NET-Core</a></p>","comments":[{"had_liked":false,"id":186997,"user_name":"偏偏","can_delete":false,"product_type":"c3","uid":1764425,"ip_address":"","ucode":"1E2E357F109F9D","user_header":"https://static001.geekbang.org/account/avatar/00/1a/ec/49/410176b8.jpg","comment_is_top":false,"comment_ctime":1583985979,"is_pvip":false,"replies":[{"id":72449,"content":"如果是类似汇总报表这样的诉求，则应该通过数据汇聚的方式解决，类似数据仓库\n\n如果是常规业务列表查询，则看是否可以通过分别查询，应用层处理合并。\n\n如果这种关联查询需求非常多，则说明你微服务拆分有问题，考虑合并服务","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1584240788,"ip_address":"","comment_id":186997,"utype":1}],"discussion_count":4,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"老师，你好，关于仓储这块有个问题，需要指点一下，如果我每个微服务对应一个数据库，这时我的表分散开来，有时会涉及到多个库连表查询的问题，在配置中怎么提现关系，请问老师这块在微服务中应如何处理。\n1. 如果跨库联查应该在仓储层怎么定义，这种情况会延时。\n2. 如果添加本地冗余表，会形成大量表和同步任务，不好维护。\n3. 有没有一个中间件可以做到隔离数据库分库实现细节，在业务外层就相当于一个数据库。\n如果使用mysql这种情况该如何实现。\n4. 如果使用newsql类的数据库，如tidb是不是可以解决掉。","like_count":3,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":486951,"discussion_content":"如果是类似汇总报表这样的诉求，则应该通过数据汇聚的方式解决，类似数据仓库\n\n如果是常规业务列表查询，则看是否可以通过分别查询，应用层处理合并。\n\n如果这种关联查询需求非常多，则说明你微服务拆分有问题，考虑合并服务","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584240788,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1813557,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/ac/35/8d0178d5.jpg","nickname":"andy","note":"","ucode":"28D55F6000A1F7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":290160,"discussion_content":"老师人狠话不多  功力深厚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594362847,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1764425,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/ec/49/410176b8.jpg","nickname":"偏偏","note":"","ucode":"1E2E357F109F9D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":205143,"discussion_content":"谢谢老师的回复，如果是业务中台，我服务中业务需要查询中台的显示值，或者查询字典里的显示值，这时候垮库应该怎么处理","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584272481,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1764425,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/ec/49/410176b8.jpg","nickname":"偏偏","note":"","ucode":"1E2E357F109F9D","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":213865,"discussion_content":"那就进行业务数据合并就行了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585129686,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":205143,"ip_address":"","group_id":0},"score":213865,"extra":""}]}]},{"had_liked":false,"id":184055,"user_name":"小嘿呗","can_delete":false,"product_type":"c3","uid":1231145,"ip_address":"","ucode":"610AE86BE774A8","user_header":"https://static001.geekbang.org/account/avatar/00/12/c9/29/2dc110d9.jpg","comment_is_top":false,"comment_ctime":1583213660,"is_pvip":false,"replies":[{"id":71571,"content":"你会发现最终实现出来跟EF差不多","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1583563202,"ip_address":"","comment_id":184055,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"能不能基于dapper实现一个dbcontext","like_count":2,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":485870,"discussion_content":"你会发现最终实现出来跟EF差不多","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583563202,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1231145,"avatar":"https://static001.geekbang.org/account/avatar/00/12/c9/29/2dc110d9.jpg","nickname":"小嘿呗","note":"","ucode":"610AE86BE774A8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":199153,"discussion_content":"是的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583563263,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":185354,"user_name":"dao","can_delete":false,"product_type":"c3","uid":1087879,"ip_address":"","ucode":"4181FB270462CF","user_header":"https://static001.geekbang.org/account/avatar/00/10/99/87/5066026c.jpg","comment_is_top":false,"comment_ctime":1583566370,"is_pvip":false,"replies":[{"id":72460,"content":"后面章节会有","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1584242323,"ip_address":"","comment_id":185354,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"老师,可以给出一下整个项目的顶层设计图吗?或者更好的是整个架构图.这样有全局观,听起来也更轻松点.谢谢.","like_count":1,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":486337,"discussion_content":"后面章节会有","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584242323,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":219679,"user_name":"养猪(jnn)小能手","can_delete":false,"product_type":"c3","uid":1255604,"ip_address":"","ucode":"A19BD24C7B3D22","user_header":"https://static001.geekbang.org/account/avatar/00/13/28/b4/3d8c9d4a.jpg","comment_is_top":false,"comment_ctime":1590063005,"is_pvip":false,"replies":[{"id":81334,"content":"查询后使用ToList方法获取集合","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1590235567,"ip_address":"","comment_id":219679,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"老师您好，我在用ef core操作mysql数据库的时候，在使用linq或lambada表达式的时候，当在循环里面使用的时候，总会提示要先把datareader关闭后才能操作。但是始终没有想出如何将上一个访问链接关闭的方法。希望老师能讲解一下，谢谢","like_count":0,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":495901,"discussion_content":"查询后使用ToList方法获取集合","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590235567,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":218758,"user_name":"张文君","can_delete":false,"product_type":"c3","uid":1487882,"ip_address":"","ucode":"9F986D57F49EB2","user_header":"https://static001.geekbang.org/account/avatar/00/16/b4/0a/ffb53539.jpg","comment_is_top":false,"comment_ctime":1589868727,"is_pvip":false,"replies":[{"id":81337,"content":"哪怕你做code first，最终还是要定义模型与数据库的映射关系的，EntityTypeConfiguration写法让你显式定义映射关系，使得设计表达更明确。\n\n虽然说约定大于配置，但显式地设计表达比约定更加明确易懂。","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1590235928,"ip_address":"","comment_id":218758,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"老师您好。之前我做得系统都是DB First的方法构建DB跟仓储层的mapping。感觉DDD的设计，code first的方法比较对。但是如果要建立数百张表，code first写类似orderEntityTypeConfiguration的类，很费时间。请问有没有其他方法可以用code first凸显领域，创建表也不用写这么多代码呢？","like_count":0,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":495568,"discussion_content":"哪怕你做code first，最终还是要定义模型与数据库的映射关系的，EntityTypeConfiguration写法让你显式定义映射关系，使得设计表达更明确。\n\n虽然说约定大于配置，但显式地设计表达比约定更加明确易懂。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590235928,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1737886,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/84/9e/d4c0e2c4.jpg","nickname":"Broadm","note":"","ucode":"BEA06300731AE8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":303710,"discussion_content":"任何事物都有两面性, 有时候你这多写的一点代码,会为日后节省十倍百倍的时间","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599359061,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":206612,"user_name":"SuperSnow","can_delete":false,"product_type":"c3","uid":1065351,"ip_address":"","ucode":"84C89AA8083E6A","user_header":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","comment_is_top":false,"comment_ctime":1586910016,"is_pvip":false,"replies":[{"id":77418,"content":"可以先取出goods对象，然后操作它的skuitem，然后保存goods\n","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1587040583,"ip_address":"","comment_id":206612,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"老师好，上面和您够通的那个问题，我当时对skuitem建立了仓储类，因为保存涉及到提交数据和数据库数据的双向对比。用ef并没有什么好的方法，如果采用整体删除相应goods的sku，然后再整体insert，我感觉这种方式太重了。毕竟以产品为聚合根，在修改商品信息时，总得涉及sku的处理。像对于这种特殊场景的话，我个人觉得是否对非聚合根的类也建立仓储类，以增加操作的方便性。在体现上还是ddd的思想体现，并不是传统三层的，毕竟sku在设计上还是属于以goods为聚合根的，还是在一个聚合里，在少部分特殊场景这样落地也应该是合理的吧?","like_count":0,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":491841,"discussion_content":"可以先取出goods对象，然后操作它的skuitem，然后保存goods\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587040583,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":195043,"user_name":"SuperSnow","can_delete":false,"product_type":"c3","uid":1065351,"ip_address":"","ucode":"84C89AA8083E6A","user_header":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","comment_is_top":false,"comment_ctime":1585130777,"is_pvip":false,"replies":[{"id":77163,"content":"你举例的删除skuitem，用ddd的思维，就是删除某一个good的某个skuitem，要从good这个聚合根找到这个skuitem，然后删除\n\n如果你为skuitem创建了仓储，意味着你可以直接删除某一个特定的skuitem，那就说明它拥有全局唯一标识，它等同于聚合根了。\n从方便的角度看，确实方便了，但是未来在些业务的时候，这个对象可以从两个仓储修改和处理，哪个写法是正确的姿势呢，团队成员大概率可能倾向于方便的那个做法，最终变成了原来的三层架构，一个表一个仓储。\n\n另外现在EF这么强大，你的举例，从good聚合根来处理，写法上也不会很复杂吧","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1586876779,"ip_address":"","comment_id":195043,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"老师，有一个问题想沟通一下。在repository层，我看到声明了IAggregateRoot接口，这就说明只有聚合根才有资格拥有仓储类。但在实际情况中，如果这种约束的话，一个聚合下非聚合根实体的数据操作都要通过聚合根这个实体来进入操作，道理肯定是这么个道理，但是在落地的时候实现起来会比较麻烦。比如一个Goods表和一个GoodsSkuItems表，一对多的关系，在进行更新的时候，涉及到sku数据的添加、删除操作，（更新可不用进行重复更新操作），那此时就需要进行库与前端的数据对比，此时涉及数据库的添加、删除，最后一并事务提交操作。如果只有一个GoodsRepository类，实现起来感觉不是很方便，如果有一个SkuItemRepository类就会很容易了。所以，我在想聚合的划分其实还是站在业务的角度进行把控，在实现上可以酌情调整，只要不跑出DDD思想，实现时不用太教条。毕竟两个实体类如果一个仓储操作方便可以一并化，如果不方便分别搞两个仓储类也未尝不可，毕竟还是在一个聚合范围内。\n所以，我想IAggregateRoot可以声明在实体类中，在仓储类层面可以不用声明了吧，以上是我的个人理解。","like_count":0,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":488957,"discussion_content":"你举例的删除skuitem，用ddd的思维，就是删除某一个good的某个skuitem，要从good这个聚合根找到这个skuitem，然后删除\n\n如果你为skuitem创建了仓储，意味着你可以直接删除某一个特定的skuitem，那就说明它拥有全局唯一标识，它等同于聚合根了。\n从方便的角度看，确实方便了，但是未来在些业务的时候，这个对象可以从两个仓储修改和处理，哪个写法是正确的姿势呢，团队成员大概率可能倾向于方便的那个做法，最终变成了原来的三层架构，一个表一个仓储。\n\n另外现在EF这么强大，你的举例，从good聚合根来处理，写法上也不会很复杂吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586876779,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":187883,"user_name":"d(ŐдŐ๑)成(๑ŐдŐ)b","can_delete":false,"product_type":"c3","uid":1808618,"ip_address":"","ucode":"9FB36A8DF8A89D","user_header":"https://static001.geekbang.org/account/avatar/00/1b/98/ea/ae7d08cf.jpg","comment_is_top":false,"comment_ctime":1584264967,"is_pvip":false,"replies":[{"id":80614,"content":"业务模型可以不变，仅仅修改实体与数据库的映射关系","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1589685720,"ip_address":"","comment_id":187883,"utype":1}],"discussion_count":4,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"老师，实际开发中，如果因为order表过大需要将address拆到另一张表的情况，但是address是值对象不是实体，代码层面要如何适应这种情况？","like_count":0,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":487280,"discussion_content":"业务模型可以不变，仅仅修改实体与数据库的映射关系","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589685720,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":213867,"discussion_content":"如果将address内容拆到另外一张表中，那就不能当成值对象来对待了，只能当成实体。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585129760,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1907116,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/19/ac/bdb46d30.jpg","nickname":"雷洛","note":"","ucode":"C847A4AA13C8AF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":218330,"discussion_content":"1.在一张表中，如果几个字段是一起的，要更新就一起更新，不会单独更新，这样的东西，就是值对象吗？\n2.值对象作为对象的命名中，比如课程中Address，对应的是Address_Street，Address_City, Address_ZipCode，请问可以自定义Address_Street的名称为xxx，Address_City为yyy，程序中咋弄呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585648798,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":213867,"ip_address":"","group_id":0},"score":218330,"extra":""},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1907116,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/19/ac/bdb46d30.jpg","nickname":"雷洛","note":"","ucode":"C847A4AA13C8AF","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":218808,"discussion_content":"可以在ef的实体类配置文件中指定。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1585703285,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":218330,"ip_address":"","group_id":0},"score":218808,"extra":""}]}]},{"had_liked":false,"id":186161,"user_name":"小喵喵","can_delete":false,"product_type":"c3","uid":1062444,"ip_address":"","ucode":"FDBBB2A59DB8B6","user_header":"https://static001.geekbang.org/account/avatar/00/10/36/2c/8bd4be3a.jpg","comment_is_top":false,"comment_ctime":1583768215,"is_pvip":false,"replies":[{"id":72455,"content":"EF Core 的问题是在复杂查询上生成的SQL会比较复杂，在SQL调优上定位问题略显复杂。\n\n如果使用CQRS模式，则数据写入使用EF Core，查询可以考虑使用其它轻量级的ORM，发挥各自的优势。","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1584241707,"ip_address":"","comment_id":186161,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"如果不用EF，还有什么办法实现呢？总觉得ef性能比较差。","like_count":0,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":486652,"discussion_content":"EF Core 的问题是在复杂查询上生成的SQL会比较复杂，在SQL调优上定位问题略显复杂。\n\n如果使用CQRS模式，则数据写入使用EF Core，查询可以考虑使用其它轻量级的ORM，发挥各自的优势。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584241707,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":213868,"discussion_content":"ef或者ef core的性能肯定是不差的，如果感觉性能差，只能说在使用层面上没有用好，毕竟微软这帮人也都不是吃素的，市面上的其他ORM框架也无非是类似或锦上添花的实现方式。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1585129884,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":184477,"user_name":"峰","can_delete":false,"product_type":"c3","uid":1390326,"ip_address":"","ucode":"527BB65559F0B0","user_header":"https://static001.geekbang.org/account/avatar/00/15/36/f6/d65b7302.jpg","comment_is_top":false,"comment_ctime":1583324797,"is_pvip":false,"replies":[{"id":71568,"content":"实际上EF映射出来也是两种情况，一种是主表上加对应的字段，一种是映射到另外一张表。\n\n不用EF的话，要实现领域模型到仓储会非常复杂，难以维护。","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1583562913,"ip_address":"","comment_id":184477,"utype":1}],"discussion_count":4,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"如果不用ef如何实现值对象映射呢？","like_count":0,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":486028,"discussion_content":"实际上EF映射出来也是两种情况，一种是主表上加对应的字段，一种是映射到另外一张表。\n\n不用EF的话，要实现领域模型到仓储会非常复杂，难以维护。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583562913,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":213873,"discussion_content":"如果其他ORM框架有类似EF操作数据库的方式方法，也是可以考虑的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585130029,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1390326,"avatar":"https://static001.geekbang.org/account/avatar/00/15/36/f6/d65b7302.jpg","nickname":"峰","note":"","ucode":"527BB65559F0B0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":206419,"discussion_content":"大多时候领域对象和持久化对象是可以混在一起的吧？我看ecshop也是混在一起的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584404844,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1390326,"avatar":"https://static001.geekbang.org/account/avatar/00/15/36/f6/d65b7302.jpg","nickname":"峰","note":"","ucode":"527BB65559F0B0","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":213870,"discussion_content":"可以，如果想再搞一层po也未尝不可。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585129980,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":206419,"ip_address":"","group_id":0},"score":213870,"extra":""}]}]},{"had_liked":false,"id":181777,"user_name":"峰","can_delete":false,"product_type":"c3","uid":1390326,"ip_address":"","ucode":"527BB65559F0B0","user_header":"https://static001.geekbang.org/account/avatar/00/15/36/f6/d65b7302.jpg","comment_is_top":false,"comment_ctime":1582632623,"is_pvip":false,"replies":[{"id":70451,"content":"自定义标签的话，你仍需额外实现映射关系，相当于重复造轮子","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1582690382,"ip_address":"","comment_id":181777,"utype":1}],"discussion_count":3,"race_medal":0,"score":3,"product_id":100044601,"comment_content":"如果领域实体中的映射字段太多，手写动态映射会不会没有直接在实体上打属性标签好？标签可以用自定义的，和orm无关\n","like_count":0,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":485116,"discussion_content":"自定义标签的话，你仍需额外实现映射关系，相当于重复造轮子","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582690382,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1737886,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/84/9e/d4c0e2c4.jpg","nickname":"Broadm","note":"","ucode":"BEA06300731AE8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":303711,"discussion_content":"建议不要把映射关系直接打在领域模型的属性上, 要保持领域的绝对清晰, 领域只负责自己的业务, 最好还是单独定义 领域模型和数据持久模型的映射","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599359252,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":213874,"discussion_content":"大部分映射的内容没必要这样写了，除非搞codefirst方式，我一般都是建立数据库，然后将映射的一些主要属性配置一下。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585130201,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":180346,"user_name":"悦峯.L","can_delete":false,"product_type":"c3","uid":1811155,"ip_address":"","ucode":"53530D2E35E856","user_header":"https://static001.geekbang.org/account/avatar/00/1b/a2/d3/9312c5db.jpg","comment_is_top":false,"comment_ctime":1582264391,"is_pvip":false,"replies":[{"id":70453,"content":"如果你是code first，使用迁移命令。\n如果因为一些原因你需要database first，可以手动创建数据库变更脚本。","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1582690626,"ip_address":"","comment_id":180346,"utype":1}],"discussion_count":3,"race_medal":0,"score":3,"product_id":100044601,"comment_content":"表结构发生变化，不用迁移，就要去数据库改表了？","like_count":0,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":484619,"discussion_content":"如果你是code first，使用迁移命令。\n如果因为一些原因你需要database first，可以手动创建数据库变更脚本。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582690626,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":213876,"discussion_content":"如果后期都上生产环境了，然后改这改那，建议还是从改数据库入手吧，避免改代码然后再影响数据库而带来一些麻烦的问题，毕竟一不小心影响到数据那就不好玩了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585130305,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1811155,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/a2/d3/9312c5db.jpg","nickname":"悦峯.L","note":"","ucode":"53530D2E35E856","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":215149,"discussion_content":"业务需求的变化有时还是挺大的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585291447,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":213876,"ip_address":"","group_id":0},"score":215149,"extra":""}]}]},{"had_liked":false,"id":349883,"user_name":"ShincoLiu","can_delete":false,"product_type":"c3","uid":2935482,"ip_address":"","ucode":"B8DA44719109E1","user_header":"","comment_is_top":false,"comment_ctime":1656409869,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100044601,"comment_content":"老师，您好！请教一个关于仓储的问题，如果列表查询的是一个视图，那么仓储层怎么设计呢？","like_count":0},{"had_liked":false,"id":320372,"user_name":"Zhaocbo","can_delete":false,"product_type":"c3","uid":1974839,"ip_address":"","ucode":"811EF3340FD6F5","user_header":"https://static001.geekbang.org/account/avatar/00/1e/22/37/137ca56d.jpg","comment_is_top":false,"comment_ctime":1636281035,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":3,"product_id":100044601,"comment_content":"老师，你好，我想问一下，我用sql server数据库，无法实现数据库表的创建。\n错误信息：Unhandled exception. System.InvalidOperationException: You must be config transport provider for CAP!\nwebAPI注册代码：        public static IServiceCollection AddSqlServerDomainContext(this IServiceCollection services,string connectionString) {\n            services.AddDbContext&lt;OrderContext&gt;();\n            services.AddCap(x =&gt;\n                {\n                    x.UseEntityFramework&lt;OrderContext&gt;();\n                    x.UseSqlServer(connectionString);\n                }\n            );\n            return services.AddDomainContext(builder=&gt; {\n                &#47;&#47;builder.UseSqlServer(connectionString);\n            });\n        }","like_count":0,"discussions":[{"author":{"id":2694940,"avatar":"https://static001.geekbang.org/account/avatar/00/29/1f/1c/f8edd6ea.jpg","nickname":"Smily","note":"","ucode":"52E38AD86327B6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":610130,"discussion_content":"找到解决方案了吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1679405314,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"福建","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":303985,"user_name":"余昭","can_delete":false,"product_type":"c3","uid":1055073,"ip_address":"","ucode":"29EEEA1BFFE16B","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/sOvjoV6STk6SYPHRqVOo7DkiajY0KKuKLHSnDNvOKic5lllRNGEQo6W1oE6FrPiaSzUia1vCw9lqmV0vibCOtYtIfHQ/132","comment_is_top":false,"comment_ctime":1627142825,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100044601,"comment_content":"dbContext的问题：\n生命周期是scope的，也就是随当前请求结束而释放的。（强依赖于请求）。\n相对于请求异步的操作、后台耗时的操作、静态方法等无法直接获取可用的dbContext实例。有什么办法可以解决这些情况下的数据库操作问题么","like_count":0},{"had_liked":false,"id":288173,"user_name":"寒枫","can_delete":false,"product_type":"c3","uid":1189932,"ip_address":"","ucode":"0BCCB1849046FD","user_header":"https://static001.geekbang.org/account/avatar/00/12/28/2c/da55cab8.jpg","comment_is_top":false,"comment_ctime":1618329316,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100044601,"comment_content":"老师，能组建一个群，便于大家一起后期做技术交流吗？","like_count":0},{"had_liked":false,"id":249056,"user_name":"迈步","can_delete":false,"product_type":"c3","uid":1747737,"ip_address":"","ucode":"BA9B69CEDA6176","user_header":"https://static001.geekbang.org/account/avatar/00/1a/ab/19/829f321f.jpg","comment_is_top":false,"comment_ctime":1600416322,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100044601,"comment_content":"老师，有两个问题\n1、DbContext.FindAsync&lt;TEntity&gt;(id, cancellationToken)这样是错误的，应该是DbContext.FindAsync&lt;TEntity&gt;(new object[] { id }, cancellationToken)\n2、实体如果Remove掉，在上下文中实体中就无法跟踪了，这个如何解决呢？","like_count":0},{"had_liked":false,"id":239641,"user_name":"How2Go","can_delete":false,"product_type":"c3","uid":1151796,"ip_address":"","ucode":"A2242F1C832D36","user_header":"https://static001.geekbang.org/account/avatar/00/11/93/34/5e5b958e.jpg","comment_is_top":false,"comment_ctime":1596602944,"is_pvip":false,"replies":null,"discussion_count":2,"race_medal":0,"score":3,"product_id":100044601,"comment_content":"老师， 关于SaveEntitiesAsync 方法的一点疑问，还请解答，谢谢！\npublic async Task&lt;bool&gt; SaveEntitiesAsync(CancellationToken cancellationToken = default(CancellationToken))\n        {\n            &#47;&#47; Dispatch Domain Events collection. \n            &#47;&#47; Choices:\n            &#47;&#47; A) Right BEFORE committing data (EF SaveChanges) into the DB will make a single transaction including  \n            &#47;&#47; side effects from the domain event handlers which are using the same DbContext with &quot;InstancePerLifetimeScope&quot; or &quot;scoped&quot; lifetime\n            &#47;&#47; B) Right AFTER committing data (EF SaveChanges) into the DB will make multiple transactions. \n            &#47;&#47; You will need to handle eventual consistency and compensatory actions in case of failures in any of the Handlers. \n            await _mediator.DispatchDomainEventsAsync(this);\n\n            &#47;&#47; After executing this line all the changes (from the Command Handler and Domain Event Handlers) \n            &#47;&#47; performed through the DbContext will be committed\n            var result = await base.SaveChangesAsync(cancellationToken);\n\n            return true;\n        }\n\n疑问1：为什么A就只有一个transaction,  而B有多个transactions?\n如果选择B, 又该如何保证最终一致性？有何好的解决方案推荐吗？\n\n疑问2：这个transaction 是在哪里控制的？又是如何起作用的？ 除了TransactionBehavior 中的一句  _dbContext.BeginTransactionAsync， 再没找到相应的代码 。\n","like_count":0,"discussions":[{"author":{"id":1151796,"avatar":"https://static001.geekbang.org/account/avatar/00/11/93/34/5e5b958e.jpg","nickname":"How2Go","note":"","ucode":"A2242F1C832D36","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":298281,"discussion_content":"课程结束了，没有老师解答了吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597234265,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1151796,"avatar":"https://static001.geekbang.org/account/avatar/00/11/93/34/5e5b958e.jpg","nickname":"How2Go","note":"","ucode":"A2242F1C832D36","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":297429,"discussion_content":"老师有时间帮看一下吗？ ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596936854,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":234518,"user_name":"啊啵呲嘚","can_delete":false,"product_type":"c3","uid":1810682,"ip_address":"","ucode":"44BE0A5A62E2B2","user_header":"https://static001.geekbang.org/account/avatar/00/1b/a0/fa/0b013dde.jpg","comment_is_top":false,"comment_ctime":1594712925,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":3,"product_id":100044601,"comment_content":"你好,您的例子用一个订单只有一条记录,如果实际业务中,一个订单有表头,表体,哪我的仓储应该怎么创建哪?多谢!\n","like_count":0,"discussions":[{"author":{"id":1737886,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/84/9e/d4c0e2c4.jpg","nickname":"Broadm","note":"","ucode":"BEA06300731AE8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":303709,"discussion_content":"请先了解聚合根的概念, 订单和订单项属于一个聚合,只需要为订单这个聚合根定义一个仓储即可","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599358903,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":222933,"user_name":"gainorloss","can_delete":false,"product_type":"c3","uid":1104013,"ip_address":"","ucode":"C3F3502D62C2CF","user_header":"https://static001.geekbang.org/account/avatar/00/10/d8/8d/796a491f.jpg","comment_is_top":false,"comment_ctime":1590970365,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100044601,"comment_content":"老师好，仓储层的约束放在领域还是仓储这个有啥说法吗，eshop是作为聚合的一部分的，我看课程里头是和实现在一块的，这是不是失去了解耦的意义了","like_count":0},{"had_liked":false,"id":211144,"user_name":"zy","can_delete":false,"product_type":"c3","uid":1817487,"ip_address":"","ucode":"54C318B06B8D3A","user_header":"https://static001.geekbang.org/account/avatar/00/1b/bb/8f/13de6ff8.jpg","comment_is_top":false,"comment_ctime":1587903207,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100044601,"comment_content":"仓储存中的异步添加方法都是以Task.FromResult方式调用的同步方法。有没有办法直接使用ef 的异步方法 DbContext.AddAsync 了","like_count":0},{"had_liked":false,"id":180916,"user_name":"stg609","can_delete":false,"product_type":"c3","uid":1073025,"ip_address":"","ucode":"FB70A75A891BB8","user_header":"https://static001.geekbang.org/account/avatar/00/10/5f/81/1c614f4a.jpg","comment_is_top":false,"comment_ctime":1582442263,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":4,"product_id":100044601,"comment_content":"希望之后可以专门介绍下产品环境遇到数据库迁移的标准姿势","like_count":0,"discussions":[{"author":{"id":1026779,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/aa/db/abb7bfe3.jpg","nickname":"Level","note":"","ucode":"FD2D1EA2B39954","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":267996,"discussion_content":"线上迁移 尽量不要用EF的， 一般情况下，运维也不让这么干","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589721617,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}