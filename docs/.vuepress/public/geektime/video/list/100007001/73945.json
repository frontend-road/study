{"id":73945,"title":"163 | Gravitee OAuth2集成(lab03)","content":"","comments":[{"had_liked":false,"id":75894,"user_name":"亮","can_delete":false,"product_type":"c3","uid":1031695,"ip_address":"","ucode":"4F8B9F5ABA2D52","user_header":"https://static001.geekbang.org/account/avatar/00/0f/be/0f/82db5e65.jpg","comment_is_top":false,"comment_ctime":1552488841,"is_pvip":false,"replies":[{"id":28176,"content":"令牌放在localstorage并不是特别安全的，如果客户设备丢失，有可能被黑客获取，然后被黑客利用。这个目前没有办法完全避免，主要要靠合理设置令牌的有效期，另外，如果发现令牌被盗，oauth2支持主动申请吊销令牌。对于安全特别严格的应用，建议使用授权码模式，在此模式下，令牌在服务器端，不会跑到浏览器中。对于涉及交易的操作步骤，在令牌的基础上，一般要求用户进一步校验确认（比如手机验证码等）。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1552913172,"ip_address":"","comment_id":75894,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"波波老师，另外放在localstorage安全吗，会不会被别人直接看到并拿走，然后也能直接放在Authorization头部带过来访问服务？谢谢","like_count":2,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":443079,"discussion_content":"令牌放在localstorage并不是特别安全的，如果客户设备丢失，有可能被黑客获取，然后被黑客利用。这个目前没有办法完全避免，主要要靠合理设置令牌的有效期，另外，如果发现令牌被盗，oauth2支持主动申请吊销令牌。对于安全特别严格的应用，建议使用授权码模式，在此模式下，令牌在服务器端，不会跑到浏览器中。对于涉及交易的操作步骤，在令牌的基础上，一般要求用户进一步校验确认（比如手机验证码等）。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1552913172,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":75868,"user_name":"亮","can_delete":false,"product_type":"c3","uid":1031695,"ip_address":"","ucode":"4F8B9F5ABA2D52","user_header":"https://static001.geekbang.org/account/avatar/00/0f/be/0f/82db5e65.jpg","comment_is_top":false,"comment_ctime":1552485161,"is_pvip":false,"replies":[{"id":28174,"content":"token过期，简单做法让用户重新登录获取新的token；比较灵活的做法，可以使用refresh token，后台自动检查token过期时间，在临近过期之前使用refresh token换取新的token。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1552912226,"ip_address":"","comment_id":75868,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"波波老师好，相当于注册的时候就把对应的token生成好，放到前端localstorage中去，后续直接来访问服务了，我的问题是: token过期怎么处理呢，是什么逻辑过程和步骤呢？因为要refresh token。谢谢","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":443065,"discussion_content":"token过期，简单做法让用户重新登录获取新的token；比较灵活的做法，可以使用refresh token，后台自动检查token过期时间，在临近过期之前使用refresh token换取新的token。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1552912226,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":56341,"user_name":"王盛武","can_delete":false,"product_type":"c3","uid":1182516,"ip_address":"","ucode":"DE7EF246D3DCE8","user_header":"https://static001.geekbang.org/account/avatar/00/12/0b/34/f41d73a4.jpg","comment_is_top":false,"comment_ctime":1546425087,"is_pvip":false,"replies":[{"id":20284,"content":"嗯，这里有个事务要完善，作为演示案例简化了。实际生产中要考虑分布式事务性，可以考虑用异步消息进一步解耦。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1546433448,"ip_address":"","comment_id":56341,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"如果注册account的时候，调用了oauth的createUser，后续代码报错， 这个createUser就不能回滚了","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434994,"discussion_content":"嗯，这里有个事务要完善，作为演示案例简化了。实际生产中要考虑分布式事务性，可以考虑用异步消息进一步解耦。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546433448,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":56340,"user_name":"王盛武","can_delete":false,"product_type":"c3","uid":1182516,"ip_address":"","ucode":"DE7EF246D3DCE8","user_header":"https://static001.geekbang.org/account/avatar/00/12/0b/34/f41d73a4.jpg","comment_is_top":false,"comment_ctime":1546425032,"is_pvip":false,"replies":[{"id":20285,"content":"可以考虑将oauth2服务也注册到注册中心，本案例架构上也ok。实际生产中，oauth2一般和网关平行布署，外面的应用可能直接访问oauth2服务，这个时候一般用nginx反向代理+域名方式，不通过注册中心。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1546433840,"ip_address":"","comment_id":56340,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"波波老师，oauth服务，为什么不也注册到服务发现组件里呢？  方便做多节点，可用性高一些","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434993,"discussion_content":"可以考虑将oauth2服务也注册到注册中心，本案例架构上也ok。实际生产中，oauth2一般和网关平行布署，外面的应用可能直接访问oauth2服务，这个时候一般用nginx反向代理+域名方式，不通过注册中心。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546433840,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}