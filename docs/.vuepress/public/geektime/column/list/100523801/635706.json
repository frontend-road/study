{"id":635706,"title":"19ï½œå…¶ä»–é‡è¦æ ‡å‡†åº“ç‰¹æ€§å®æˆ˜ï¼šåˆ©ç”¨æ—¥å†åº”ç”¨ç†Ÿæ‚‰æ–°ç‰¹æ€§","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å¢èª‰å£°ã€‚</p><p>æˆ‘ä»¬æƒ³è¦æå‡C++çš„ç¼–ç¨‹æ•ˆç‡ï¼Œå°±éœ€è¦å¯¹é‡è¦æ ‡å‡†åº“çš„å˜æ›´ä¿æŒå…³æ³¨ã€‚åœ¨ç¬¬18è®²å·²ç»æ¶µç›–äº†ç»å¤§å¤šæ•°C++20å¸¦æ¥çš„é‡è¦åº“å˜æ›´ã€‚ä¸è¿‡ï¼Œæˆ‘å½“æ—¶æœ‰æ„å¿½ç•¥äº†å…¶ä¸­ä¸€ä¸ªï¼Œå°±æ˜¯æˆ‘ä»¬ä»Šå¤©çš„ä¸»è§’â€”â€”C++20 Calendarã€Timzoneã€‚</p><p>å®ƒä»¬æ˜¯å¯¹ç°æœ‰chronoåº“çš„é‡è¦è¡¥å……ã€‚Calendaræä¾›äº†æ—¥å†çš„è¡¨ç¤ºä¸è®¡ç®—å·¥å…·ã€‚è€ŒTimezoneæä¾›äº†æ ‡å‡†çš„æ—¶åŒºå®šä¹‰ï¼Œå¯ä»¥æ„å»ºåŒ…å«æ—¶åŒºä¿¡æ¯çš„zoned_timeã€‚</p><p>ä»Šå¤©ï¼Œæˆ‘ä¼šå›´ç»•C++20 Calendarã€Timzoneå¸¦ä½ è¿›è¡Œç¼–ç¨‹å®æˆ˜ï¼Œå¹¶ç»“åˆä¸Šä¸€è®²æ¶µç›–çš„ç‰¹æ€§ï¼šjthreadã€source locationã€sync streamå’Œu8stringï¼Œå®ç°ä¸€ä¸ªä½¿ç”¨æ–°æ ‡å‡†å®ç°çš„æ—¥å†ç¨‹åºã€‚</p><p>å“¦ï¼Œå¯¹äº†ï¼Œæˆ‘ä»¬è¿˜ä¼šåœ¨è¿™ä¸€è®²ä¸­ä½¿ç”¨C++ 20 Formattingåº“ï¼Œå¸®ä½ è¿›ä¸€æ­¥åŠ æ·±å¯¹è¿™ä¸ªç‰¹æ€§çš„ç†è§£ã€‚å¥½ï¼Œè¯ä¸å¤šè¯´ï¼Œå°±è®©æˆ‘ä»¬ä»æ¨¡å—è®¾è®¡å¼€å§‹ä»Šå¤©çš„å†…å®¹ï¼ˆè¯¾ç¨‹é…å¥—ä»£ç å¯ä»¥ä»<a href=\"https://github.com/samblg/cpp20-plus-indepth\">è¿™é‡Œ</a>è·å–ï¼‰ã€‚</p><h2>æ¨¡å—è®¾è®¡</h2><p>æˆ‘ä»¬å‡†å¤‡æ„å»ºçš„å‘½ä»¤è¡Œæ—¥å†åº”ç”¨ï¼Œå…·å¤‡ä»¥ä¸‹ç‰¹æ€§ã€‚</p><ul>\n<li>ä½¿ç”¨C++20 chronoï¼šæ”¯æŒæ˜¾ç¤ºæœ¬æœˆæ—¥å†ï¼Œæ˜¾ç¤ºæ—¥æœŸå’Œæ˜ŸæœŸä¿¡æ¯ã€‚</li>\n<li>ä½¿ç”¨u8stringï¼šæ”¯æŒå¯¼å‡ºæœ¬å¹´çš„å…¨å¹´æ—¥å†åˆ°æ–‡æœ¬æ–‡ä»¶ï¼Œç¼–ç ä¸ºUTF-8ã€‚</li>\n</ul><p>æˆ‘ä»¬ä¾ç„¶é‡‡ç”¨ä¼ ç»ŸC++æ¨¡å—ç»“æ„è®¾è®¡ï¼Œæ•´ä½“æ¨¡å—è®¾è®¡å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚<br>\n<img src=\"https://static001.geekbang.org/resource/image/78/25/78e7e0c75ed186253b7d5cbb3a60db25.jpg?wh=2900x1682\" alt=\"\"></p><!-- [[[read_end]]] --><p>è¯¥å·¥ç¨‹åŒ…å«ä¸¤ä¸ªå­é¡¹ç›®ï¼Œä¸€ä¸ªæ˜¯å¯æ‰§è¡Œæ–‡ä»¶calendarppï¼Œå¦ä¸€ä¸ªæ˜¯é™æ€é“¾æ¥åº“loggingã€‚ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œcalendarppçš„å…¥å£æ˜¯main.cppï¼Œå…¶ä»–å®ç°éƒ½åœ¨calendarppæ¨¡å—ä¸‹ï¼ŒåŒ…æ‹¬åé¢è¿™å‡ ä¸ªæ¨¡å—ã€‚</p><ul>\n<li>menuï¼šä¸»èœå•å®ç°ï¼ŒåŒ…æ‹¬èœå•å®šä¹‰ä¸èœå•äº¤äº’ã€‚</li>\n<li>actionsï¼šå„ä¸ªèœå•é¡¹çš„å…·ä½“å®ç°ï¼Œå®Œæˆå…·ä½“çš„åŠŸèƒ½ã€‚</li>\n<li>utilsï¼šå…·ä½“çš„åº•å±‚å®ç°æ¨¡å—ï¼ŒåŒ…æ‹¬æ—¥å†è®¡ç®—æ¨¡å—calendarã€æ–‡æœ¬æ¸²æŸ“æ¨¡å—renderå’Œè¾“å…¥è¾“å‡ºæ¨¡å—ioã€‚</li>\n</ul><p>æˆ‘ä»¬æ²¿ç”¨äº†<a href=\"https://time.geekbang.org/column/article/631248\">ç¬¬15è®²</a>ä¸­çš„å®ç°ï¼Œå³æ—¥å¿—æ¡†æ¶æ¥æ„å»ºå¹¶åŒ…è£…æˆäº†loggingåº“ï¼Œå¹¶åˆ©ç”¨ç¬¬18è®²ä¸­è®²è¿‡çš„éƒ¨åˆ†ç‰¹æ€§è¿›è¡Œäº†æ”¹é€ ã€‚æ²¿ç€è¿™æ¡è·¯çº¿ï¼Œæˆ‘ä»¬å…ˆä»æ”¹é€ æ—¥å¿—æ¡†æ¶å¼€å§‹çœ‹ã€‚</p><h2>æ”¹é€ æ—¥å¿—æ¡†æ¶</h2><p>æ—¥å¿—æ¡†æ¶çš„æ‰€æœ‰ä»£ç æ–‡ä»¶éƒ½åœ¨projects/loggingä¸‹ï¼Œä½ å¯ä»¥ç»“åˆä»£ç æ¥ç†è§£å¦‚ä½•é›†æˆæ—¥å¿—æ¡†æ¶ï¼Œå¹¶ç”¨å®ƒæ¥è®°å½•ç³»ç»Ÿè¿è¡Œæ—¥å¿—ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹ï¼Œä½¿ç”¨C++20çš„ç‰¹æ€§ï¼Œå¯ä»¥åœ¨åŸæœ‰çš„æ¡†æ¶åŸºç¡€ä¸Šåšå‡ºå“ªäº›æ”¹é€ ã€‚</p><p>ä¹‹å‰çš„Handleråœ¨å¤šçº¿ç¨‹åœºæ™¯ä¸‹ä½¿ç”¨æ—¶ï¼Œå› ä¸ºæ²¡æœ‰é‡‡ç”¨çº¿ç¨‹åŒæ­¥æ–¹æ¡ˆï¼Œå¯¼è‡´è¾“å‡ºæ—¶å¯èƒ½ä¼šäº§ç”Ÿé”™ä¹±çš„é—®é¢˜ï¼Œå› æ­¤æˆ‘ä»¬æ”¹é€ äº†Handlerã€‚</p><p>æ¯”å¦‚DefaultHandlerçš„å®ç°æ”¹é€ æ˜¯åé¢è¿™æ ·ã€‚</p><pre><code class=\"language-c++\">#pragma once\n&nbsp;\n#include \"logging/Handler.h\"\n#include &lt;syncstream&gt;\n&nbsp;\nnamespace logging::handlers {\n&nbsp;&nbsp;&nbsp; // é»˜è®¤æ—¥å¿—å¤„ç†å™¨\n&nbsp;&nbsp;&nbsp; template &lt;Level HandlerLevel = Level::Warning&gt;\n&nbsp;&nbsp;&nbsp; // ç»§æ‰¿BaseHandler\n&nbsp;&nbsp;&nbsp; class DefaultHandler : public BaseHandler&lt;HandlerLevel&gt; {\n&nbsp;&nbsp;&nbsp; public:\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // æ„é€ å‡½æ•°ï¼Œéœ€è¦æŒ‡å®šæ ¼å¼åŒ–å™¨ï¼Œé»˜è®¤æ ¼å¼åŒ–å™¨ä¸ºdefaultFormatter\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DefaultHandler(Formatter formatter = defaultFormatter) : BaseHandler&lt;HandlerLevel&gt;(formatter) {}\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // ç¦æ­¢æ‹·è´æ„é€ å‡½æ•°\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DefaultHandler(const DefaultHandler&amp;) = delete;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // å®šä¹‰ç§»åŠ¨æ„é€ å‡½æ•°\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DefaultHandler(const DefaultHandler&amp;&amp; rhs) noexcept : BaseHandler&lt;HandlerLevel&gt;(rhs.getForamtter()) {}\n&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // emitç”¨äºæäº¤æ—¥å¿—è®°å½•\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // emitLevel &gt; HandlerLevelçš„æ—¥å¿—ä¼šè¢«ä¸¢å¼ƒ\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; template &lt;Level emitLevel&gt;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; requires (emitLevel &gt; HandlerLevel)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; void emit(const Record&amp; record) {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }\n&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // emitLevel &lt;= HandlerLevelçš„æ—¥å¿—ä¼šè¢«è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºæµä¸­\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; template &lt;Level emitLevel&gt;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; requires (emitLevel &lt;= HandlerLevel)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; void emit(const Record&amp; record) {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // è°ƒç”¨formatå°†æ—¥å¿—è®°å½•å¯¹è±¡æ ¼å¼åŒ–æˆæ–‡æœ¬å­—ç¬¦ä¸²\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; std::osyncstream(std::cout) &lt;&lt; this-&gt;format(record) &lt;&lt; std::endl;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }\n&nbsp;&nbsp;&nbsp; };\n}\n</code></pre><p>ä»£ç ä¸­çš„æ”¹åŠ¨åœ¨ç¬¬31è¡Œï¼Œé€šè¿‡<strong> std::osyncstream</strong> åŒ…è£…äº†std::coutï¼Œç„¶åé€šè¿‡åŒ…è£…åçš„è¾“å‡ºæµè¿›è¡Œè¾“å‡ºï¼Œè¿™æ ·å°±èƒ½å®Œæˆè¾“å‡ºçš„çº¿ç¨‹åŒæ­¥æ§åˆ¶ï¼ˆè¯¦ç»†è®²è§£ï¼Œä½ å¯ä»¥å›é¡¾ä¸Šä¸€è®² â€œsync streamâ€ è¿™éƒ¨åˆ†ï¼‰ã€‚</p><p>æ—¥å¿—æ¡†æ¶çš„ç¬¬äºŒä¸ªæ”¹åŠ¨åœ¨äºï¼Œå®ƒé€šè¿‡source locationè®°å½•äº†è¾“å‡ºæ—¥å¿—çš„æºä»£ç ä½ç½®ä¿¡æ¯ã€‚å®ç°åœ¨Record.hä¸‹ï¼Œåé¢å±•ç¤ºçš„æ˜¯é‡ç‚¹ä»£ç ã€‚</p><pre><code class=\"language-c++\">class Record {\npublic:\n&nbsp;&nbsp;&nbsp; // Loggeråç§°\n&nbsp;&nbsp;&nbsp; std::string name;\n&nbsp;&nbsp;&nbsp; // æ—¥å¿—ç­‰çº§\n&nbsp;&nbsp;&nbsp; Level level;\n&nbsp;&nbsp;&nbsp; // æ—¥å¿—æ—¶é—´\n&nbsp;&nbsp;&nbsp; TimePoint time;\n&nbsp;&nbsp;&nbsp; // æ—¥å¿—æ¶ˆæ¯\n&nbsp;&nbsp;&nbsp; std::string message;\n&nbsp;&nbsp;&nbsp; std::source_location sourceLocation;\n\n&nbsp;&nbsp;&nbsp; // getLevelNameï¼šè·å–æ—¥å¿—ç­‰çº§æ–‡æœ¬\n&nbsp;&nbsp;&nbsp; const std::string&amp; getLevelName() const {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // è°ƒç”¨toLevelNameè·å–æ—¥å¿—ç­‰çº§æ–‡æœ¬\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return toLevelName(level);\n&nbsp;&nbsp;&nbsp; }\n};\n</code></pre><p>é€šè¿‡ä»£ç å¯ä»¥çœ‹åˆ°ï¼ŒRecordå®šä¹‰å¢åŠ äº†sourceLocationç”¨äºè®°å½•æºä»£ç ä½ç½®ã€‚</p><p>æ¥ç€ï¼Œæˆ‘ä»¬è¿˜è¦ä¿®æ”¹Loggerå®šä¹‰ï¼Œå¢åŠ è®°å½•æºä»£ç ä½ç½®ä¿¡æ¯çš„åŠŸèƒ½ã€‚å…·ä½“å®ç°åœ¨Logger.hä¸‹ï¼Œæˆ‘ä»¬å°†logçš„å®šä¹‰æ”¹ä¸ºä»¥ä¸‹å½¢å¼ã€‚</p><pre><code class=\"language-c++\">template &lt;Level level&gt;\n&nbsp;&nbsp;&nbsp; requires (level &gt; loggerLevel)\nLogger&amp; log(const std::string&amp; message, std::source_location sourceLocation = std::source_location::current()) {\n&nbsp;&nbsp;&nbsp; return *this;\n}\n\n// é€šè¿‡requiresçº¦æŸæäº¤ç­‰çº§ä¸ºæ—¥å¿—è®°å½•å™¨è®¾å®šç­‰çº§åŠä»¥ä¸Šçš„æ—¥å¿—\ntemplate &lt;Level level&gt;\n&nbsp;&nbsp;&nbsp; requires (level &lt;= loggerLevel)\nLogger &amp; log(const std::string&amp; message, std::source_location sourceLocation = std::source_location::current()) {\n&nbsp;&nbsp;&nbsp; // æ„é€ Recordå¯¹è±¡\n&nbsp;&nbsp;&nbsp; Record record{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;.name = _name,\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .level = level,\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .time = std::chrono::system_clock::now(),\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .message = message,\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // è®°å½•æºä»£ç ä½ç½®\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .sourceLocation = sourceLocation\n&nbsp;&nbsp;&nbsp; };\n\n&nbsp;&nbsp;&nbsp; // è°ƒç”¨handleLogå®é™…å¤„ç†æ—¥å¿—è¾“å‡º\n&nbsp;&nbsp;&nbsp; handleLog&lt;level, HandlerCount - 1&gt;(record);\n\n&nbsp;&nbsp;&nbsp; return *this;\n}\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘å¢åŠ äº†source_locationå®šä¹‰ï¼Œå¹¶é€šè¿‡é»˜è®¤å‚æ•°è‡ªåŠ¨è®°å½•è°ƒç”¨è€…çš„æ‰€åœ¨ä½ç½®ï¼Œè°ƒç”¨è€…ä¹Ÿå¯ä»¥è‡ªå·±æŒ‡å®šéœ€è¦è®°å½•çš„source_locationã€‚</p><p>æˆ‘ä»¬åŒæ—¶<strong>ä¿®æ”¹äº†å‡ ä¸ªçº§åˆ«çš„ç›¸å…³æ¥å£</strong>ï¼Œæ¯”å¦‚debugæˆå‘˜å‡½æ•°æ”¹é€ ã€‚</p><pre><code class=\"language-c++\">// æäº¤è°ƒè¯•ä¿¡æ¯ï¼ˆlogçš„åŒ…è£…ï¼‰\nLogger&amp; debug(const std::string&amp; message, std::source_location sourceLocation = std::source_location::current()) {\n&nbsp;&nbsp;&nbsp; return log&lt;Level::Debug&gt;(message, sourceLocation);\n}\n</code></pre><p>å…¶ä»–çš„å‡ ä¸ªæˆå‘˜å‡½æ•°éƒ½å’Œdebugä¸€æ ·ï¼Œè¿™é‡Œå°±ä¸å±•ç¤ºå‡ºæ¥äº†ã€‚</p><p>æœ€åï¼Œæˆ‘è¿˜ä¿®æ”¹äº†formatå‡½æ•°è¾“å‡ºsourceLocationä¸­çš„ä¿¡æ¯ã€‚å…·ä½“å®ç°ï¼Œæˆ‘ä»¬ä»¥ModernFormatter.cppçš„ä¿®æ”¹ä¸ºä¾‹æ¥çœ‹çœ‹ã€‚</p><pre><code class=\"language-c++\">#include \"logging/formatters/ModernFormatter.h\"\n#include \"logging/Record.h\"\n&nbsp;\nnamespace logging::formatters::modern {\n&nbsp;&nbsp;&nbsp; // formatRecordï¼šå°†Recordå¯¹è±¡æ ¼å¼åŒ–ä¸ºå­—ç¬¦ä¸²\n&nbsp;&nbsp;&nbsp; std::string formatRecord(const Record&amp; record) {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; const auto&amp; sourceLocation = record.sourceLocation;\n&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return std::format(\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \"{0:&lt;16}| [{1}] {2:%Y-%m-%d}T{2:%H:%M:%OS}Z - &lt;{3}:{4} [{5}]&gt; - {6}\",\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; record.name,\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; record.getLevelName(),\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; record.time,\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sourceLocation.file_name(),\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sourceLocation.line(),\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sourceLocation.function_name(),\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; record.message\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; );\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; catch (std::exception&amp; e) {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; std::cerr &lt;&lt; \"Error in format: \" &lt;&lt; e.what() &lt;&lt; std::endl;\n&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return \"\";\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }\n&nbsp;&nbsp;&nbsp; }\n}\n</code></pre><p>ä»£ç ä¸­formatçš„éƒ¨åˆ†åŠ å…¥äº†sourceLocationä¿¡æ¯ï¼Œå…¶ä»–éƒ¨åˆ†ç›¸è¾ƒäºä¹‹å‰åˆ™æ²¡æœ‰å˜åŒ–ã€‚</p><h2>ä¸»ç¨‹åºä¸èœå•</h2><p>åœ¨äº†è§£äº†æ—¥å¿—æ¡†æ¶çš„æ”¹é€ åï¼Œæˆ‘ä»¬ç»§ç»­çœ‹å¦‚ä½•é€šè¿‡C++20 Formattingåº“å®ç°ä¸»ç¨‹åºå’Œèœå•ã€‚</p><p>ä¸»ç¨‹åºå®šä¹‰éå¸¸ç®€å•ï¼Œåœ¨main.cppä¸­ï¼Œä»£ç æ˜¯åé¢è¿™æ ·ã€‚</p><pre><code class=\"language-c++\">#include \"menu/Menu.h\"\n#include &lt;iostream&gt;\n#include &lt;format&gt;\n&nbsp;\nint main() {\n&nbsp;&nbsp;&nbsp; while (true) {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // å±•ç¤ºèœå•\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; calendarpp::menu::showMenu();\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // è¯»å–å¹¶æ‰§è¡Œèœå•é¡¹\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; calendarpp::menu::readAction();\n&nbsp;&nbsp;&nbsp; }\n&nbsp;\n&nbsp;&nbsp;&nbsp; return 0;\n}\n</code></pre><p>ä»£ç æ•´ä½“æ˜¯ä¸€ä¸ªwhileå¾ªç¯ï¼Œé¦–å…ˆå±•ç¤ºèœå•ï¼Œç„¶åè¯»å–ç”¨æˆ·è¾“å…¥å¹¶æ‰§è¡Œèœå•é¡¹ã€‚æ‰€ä»¥åªæœ‰ç”¨æˆ·é€‰æ‹©é€€å‡ºç¨‹åºæ—¶ï¼Œæ•´ä¸ªç¨‹åºæ‰ä¼šé€€å‡ºã€‚</p><p>èœå•å®ç°åœ¨menu/Menu.cppä¸­ï¼Œä»£ç æ˜¯åé¢è¿™æ ·ã€‚</p><pre><code class=\"language-c++\">#include \"menu/Menu.h\"\n#include \"actions/ShowAction.h\"\n#include \"actions/ExportAction.h\"\n#include \"actions/ExitAction.h\"\n#include \"utils/RenderUtils.h\"\n&nbsp;\n#include &lt;iostream&gt;\n#include &lt;string&gt;\n#include &lt;vector&gt;\n#include &lt;cstdint&gt;\n#include &lt;format&gt;\n#include &lt;algorithm&gt;\n&nbsp;\nnamespace calendarpp::menu {\n&nbsp;&nbsp;&nbsp; // èœå•é¡¹ç±»å‹\n&nbsp;&nbsp;&nbsp; struct MenuItem {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; std::string title;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Action action;\n&nbsp;&nbsp;&nbsp; };\n&nbsp;\n&nbsp;&nbsp;&nbsp; // æ‰€æœ‰èœå•\n&nbsp;&nbsp;&nbsp; static const std::vector&lt;MenuItem&gt; MenuItems = {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; std::vector&lt;MenuItem&gt; {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .title = \"å±•ç¤ºæœ¬æœˆæ—¥å†\",\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .action = actions::showCurrentMonth\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .title = \"å¯¼å‡ºæœ¬å¹´æ—¥å†\",\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .action = actions::exportCurrentYear\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .title = \"é€€å‡ºç¨‹åº\",\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .action = actions::exitApp\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }\n&nbsp;&nbsp;&nbsp; };\n&nbsp;\n&nbsp;&nbsp;&nbsp; // èœå•é€‰é¡¹èŒƒå›´\n&nbsp;&nbsp;&nbsp; static const int32_t MinActionNumber = 1;\n&nbsp;&nbsp;&nbsp; static const int32_t MaxActionNumber = MenuItems.size();\n&nbsp;\n&nbsp;&nbsp;&nbsp; // å±•ç¤ºèœå•\n&nbsp;&nbsp;&nbsp; void showMenu() {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // è¾“å‡ºç³»ç»Ÿæ ‡é¢˜\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; std::cout &lt;&lt; std::format(\"\\n{:=^80}\\n\", \" Calendar++ v1.0 \") &lt;&lt; std::endl;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // è¾“å‡ºå½“å‰æ—¶é—´ä¸æœ¬åœ°æ—¶åŒºä¿¡æ¯\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; std::cout &lt;&lt; utils::renderNow() &lt;&lt; std::endl;\n&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // è¾“å‡ºæ‰€æœ‰èœå•\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; std::cout &lt;&lt; std::format(\"{:*^80}\\n\", \" MENU \");\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; std::cout &lt;&lt; std::format(\"*{: ^78}*\\n\", \"\");\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; std::int32_t menuIndex = 0;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for (const auto&amp; menuItem : MenuItems) {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; menuIndex += 1;\n&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // è¾“å‡ºèœå•åºå·ä¸èœå•åç§°\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; std::string menuLine = std::format(\"({}) {}\", menuIndex, menuItem.title);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; std::cout &lt;&lt; std::format(\"* {: &lt;76} *\", menuLine) &lt;&lt; std::endl;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; std::cout &lt;&lt; std::format(\"*{: ^78}*\\n\", \"\");\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; std::cout &lt;&lt; std::format(\"{:*^80}\\n\", \"\");\n&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // æç¤ºç”¨æˆ·è¾“å…¥èœå•ç¼–å·\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; std::cout &lt;&lt; std::format(\"\\nè¯·è¾“å…¥èœå•ç¼–å·({}-{}):\", 1, menuIndex);\n&nbsp;&nbsp;&nbsp; }\n&nbsp;\n&nbsp;&nbsp;&nbsp; // è¯»å–ç”¨æˆ·è¾“å…¥å¹¶æ‰§è¡ŒåŠ¨ä½œ\n&nbsp;&nbsp;&nbsp; void readAction() {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; std::string actionNumberString;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // è¯»å–ç”¨æˆ·è¾“å…¥\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; std::getline(std::cin, actionNumberString);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // è§£æç”¨æˆ·è¾“å…¥\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int32_t actionNumber = std::stoi(actionNumberString);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (actionNumber &lt; MinActionNumber || actionNumber &gt; MaxActionNumber) {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; std::cerr &lt;&lt; std::format(\"èœå•ç¼–å·è¶…å‡ºèŒƒå›´({}-{})\\n\", MinActionNumber, MaxActionNumber);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }\n&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // æ‰§è¡Œç›¸åº”èœå•é¡¹çš„action\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int32_t actionIndex = std::max(actionNumber - 1, 0);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; const auto&amp; action = MenuItems[actionIndex].action;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; action();\n&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; catch (const std::exception&amp; e) {\n&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;std::cerr &lt;&lt; e.what() &lt;&lt; std::endl;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }\n&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; std::cerr &lt;&lt; \"æ— æ³•è¯†åˆ«ç”¨æˆ·è¾“å…¥\" &lt;&lt; std::endl;\n&nbsp;&nbsp;&nbsp; }\n}\n</code></pre><p>è¿™æ®µä»£ç ä¸­å€¼å¾—æ³¨æ„çš„éƒ¨åˆ†æ˜¯ <strong>showMenuå‡½æ•°</strong>ï¼Œå®ƒç”¨äºå±•ç¤ºèœå•ã€‚è¯¥å‡½æ•°è¾“å‡ºæ ‡é¢˜åï¼Œä¼šéå†æ‰€æœ‰çš„MenuItemså¹¶è¾“å‡ºèœå•å†…å®¹ã€‚å‘ç°äº†ä¹ˆï¼Ÿè¿™æ®µä»£ç é€šè¿‡formatå®Œæˆäº†å¤§é‡çš„æ–‡æœ¬æ ¼å¼åŒ–å·¥ä½œã€‚</p><p>æœ€åæˆ‘ä»¬è¿˜å®šä¹‰äº†readActionå‡½æ•°ï¼Œç”¨äºè¯»å–ç”¨æˆ·è¾“å…¥çš„èœå•ç¼–å·å¹¶æ‰§è¡Œå¯¹åº”çš„èœå•åŠ¨ä½œã€‚è¿™é‡Œä½¿ç”¨äº†C++11å¼•å…¥çš„std::stoiå‡½æ•°å°†å­—ç¬¦ä¸²è½¬æ¢æˆå¯¹åº”çš„æ•´å‹æ•°å­—ã€‚</p><p>èœå•çš„å±•ç¤ºæ•ˆæœæ˜¯åé¢è¿™æ ·ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/89/56/894d127e48f9d7566b4a7f742ea61b56.jpg?wh=1406x375\" alt=\"\"></p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæœ¬é¡¹ç›®ä»£ç é‡‡ç”¨äº†UTF-8ç¼–ç ï¼Œå› æ­¤å¦‚æœä½ åœ¨Windowsä¸‹æ‰§è¡Œï¼Œéœ€è¦åœ¨æ”¯æŒUTF-8ç¼–ç è¾“å‡ºçš„æ§åˆ¶å°ä¸‹ä½¿ç”¨ï¼ˆæ¯”å¦‚MinGWçš„bashï¼‰ã€‚</p><h2>å±•ç¤ºæ—¥å†</h2><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹è¯¥å¦‚ä½•å±•ç¤ºæœ¬æœˆæ—¥å†ã€‚åœ¨actionsä¸­å®šä¹‰äº†èœå•é¡¹çš„å‡½æ•°å®ç°ï¼Œä»£ç å®ç°åœ¨src/actions/ShowAction.cppä¸­ã€‚</p><pre><code class=\"language-c++\">#include \"actions/ShowAction.h\"\n#include \"utils/RenderUtils.h\"\n&nbsp;\n#include &lt;chrono&gt;\n#include &lt;iostream&gt;\n#include &lt;format&gt;\n&nbsp;\nnamespace chrono = std::chrono;\n&nbsp;\nnamespace calendarpp::actions {\n&nbsp;&nbsp;&nbsp; void showCurrentMonth() {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // è·å–å½“å‰æ—¶é—´\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; chrono::time_point now{ chrono::system_clock::now() };\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // å°†æ—¶é—´è½¬æ¢ä¸ºyear_month_day\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; chrono::year_month_day ymd{ chrono::floor&lt;chrono::days&gt;(now) };\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // è·å–å½“å‰å¹´æœˆï¼ˆç±»å‹ä¸ºyear_monthï¼‰\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; chrono::year_month currentYearMonth = ymd.year() / ymd.month();\n&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // è°ƒç”¨æ¸²æŸ“æ¨¡å—æ¸²æŸ“å½“æœˆæ—¥å†\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; std::cout &lt;&lt; std::endl;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; std::cout &lt;&lt; utils::renderMonth(currentYearMonth);\n&nbsp;&nbsp;&nbsp; }\n}\n</code></pre><p>ä»£ç ä¸­å®šä¹‰äº†showCurrentMonthå‡½æ•°ï¼Œè¯¥å‡½æ•°é¦–å…ˆè°ƒç”¨äº†chronoçš„Calendarè·å–å½“æ—¥æ‰€åœ¨çš„æ—¥æœŸå’Œæœˆä»½ã€‚</p><p>Calendaræ˜¯C++20å¼•å…¥åˆ°chronoä¸­æ–°çš„åº“ç‰¹æ€§ï¼Œæä¾›äº†æ ‡å‡†çš„æ ¼é‡Œé«˜åˆ©å†ï¼ˆGregorian calendarï¼‰å®ç°ã€‚</p><p>è¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹year_month_dayï¼Œç”¨äºæè¿°ä¸€ä¸ªå®Œæ•´æ—¥æœŸï¼ˆå¹´æœˆæ—¥ï¼‰ï¼Œè¯¥ç±»å‹æ”¯æŒå¤šç§æ„é€ æ–¹æ³•ï¼Œè¿™é‡Œä½¿ç”¨chrono::system_clock::now()è·å–ç³»ç»Ÿæœ¬åœ°æ—¶é—´ï¼Œç„¶åé‡‡ç”¨chrono::floor&lt;chrono::days&gt;å°†æ—¶é—´è½¬æ¢ä¸ºä»¥æ—¥ä¸ºå•ä½çš„æ—¶é—´ï¼Œæœ€åè°ƒç”¨year_month_dayå¾—åˆ°å½“æ—¥çš„æ—¥æœŸã€‚</p><p>year_month_dayæ”¯æŒé€šè¿‡yearå’Œmonthæˆå‘˜å‡½æ•°è·å–å½“æ—¥çš„å¹´ä»½ä¸æœˆä»½ï¼Œä»£ç 17è¡Œå°±è°ƒç”¨äº†year / monthè¿™ç§å½¢å¼æ„é€ äº†ä¸€ä¸ªyear_monthå¯¹è±¡ï¼Œè¡¨ç¤ºæŸå¹´çš„æŸä¸ªæœˆï¼Œè¿™é‡Œæœ€åå¾—åˆ°çš„å°±æ˜¯æœ¬æ—¥æ‰€åœ¨çš„å½“æœˆã€‚/æ˜¯Calendarçš„ä¸€ä¸ªæ“ä½œç¬¦é‡è½½ï¼Œæ˜¯åˆ›å»ºæ—¥æœŸç±»å‹å¯¹è±¡çš„ä¸€ä¸ªè¯­æ³•ç³–ã€‚</p><p>ä»£ç æœ€åè°ƒç”¨renderMonthæ¸²æŸ“äº†å½“æœˆæ—¥å†å¹¶å°†å…¶è¾“å‡ºåˆ°æ§åˆ¶å°ï¼Œè¯¥å‡½æ•°å®šä¹‰åœ¨src/utils/RenderUtils.cppä¸­ï¼Œå±äºæ¸²æŸ“æ¨¡å—ï¼Œæˆ‘ä»¬åˆ†æä¸€ä¸‹ç›¸å…³ä»£ç ã€‚</p><p>é¦–å…ˆå®šä¹‰äº†Weekdayså¸¸é‡ï¼ŒåŒ…å«äº†å‘¨ä¸€åˆ°å‘¨æ—¥çš„æ‰€æœ‰æ˜ŸæœŸå‡ çš„å®šä¹‰ã€‚</p><pre><code class=\"language-c++\">// å®šä¹‰ä¸€å‘¨ä¸ƒå¤©çš„weekdayå¸¸é‡\nstatic std::vector&lt;chrono::weekday&gt; Weekdays = {\n&nbsp;&nbsp;&nbsp; chrono::Monday,\n&nbsp;&nbsp;&nbsp; chrono::Tuesday,\n&nbsp;&nbsp;&nbsp; chrono::Wednesday,\n&nbsp;&nbsp;&nbsp; chrono::Thursday,\n&nbsp;&nbsp;&nbsp; chrono::Friday,\n&nbsp;&nbsp;&nbsp; chrono::Saturday,\n&nbsp;&nbsp;&nbsp; chrono::Sunday,\n};\n</code></pre><p>è¯¥æ•°ç»„çš„å…ƒç´ ç±»å‹ä¸ºchrono::weekdayï¼Œè¿™æ˜¯chronoçš„æ ‡å‡†ç±»å‹ï¼Œç”¨æ¥è¡¨ç¤ºå‘¨å‡ ï¼Œå…¶ä¸­Mondayåˆ°Sundayéƒ½æ˜¯chronoå®šä¹‰çš„å¸¸é‡ï¼Œè¡¨ç¤ºå‘¨ä¸€åˆ°å‘¨æ—¥ã€‚</p><pre><code class=\"language-c++\">// æ¸²æŸ“æŸä¸ªæœˆä»½çš„æ—¥å†ï¼Œè¿”å›string\nstd::string renderMonth(chrono::year_month yearMonth) {\n&nbsp;&nbsp;&nbsp; std::ostringstream os;\n&nbsp;\n&nbsp;&nbsp;&nbsp; // è·å–å½“æœˆçš„æ‰€æœ‰å‘¨\n&nbsp;&nbsp;&nbsp; auto monthWeeks = utils::buildMonthWeeks(yearMonth);\n&nbsp;\n&nbsp;&nbsp;&nbsp; // è·å–å½“æœˆç¬¬ä¸€å¤©\n&nbsp;&nbsp;&nbsp; const auto firstDay = yearMonth / 1d;\n&nbsp;&nbsp;&nbsp; // è·å–å½“æœˆæœ€åä¸€å¤©\n&nbsp;&nbsp;&nbsp; const auto lastDay = chrono::year_month_day(yearMonth / chrono::last);\n&nbsp;\n&nbsp;&nbsp;&nbsp; // è¾“å‡ºæ ¼å¼åŒ–çš„æ ‡é¢˜ï¼ˆå¹´ä»½ä¸æœˆä»½ï¼‰\n&nbsp;&nbsp;&nbsp; std::string titleLine = std::format(\"** {:%Y-%m} **\", yearMonth);\n&nbsp;&nbsp;&nbsp; os &lt;&lt; std::format(\"{:^35}\", titleLine) &lt;&lt; std::endl;\n&nbsp;&nbsp;&nbsp; os &lt;&lt; std::format(\"{:-&gt;35}\", \"\") &lt;&lt; std::endl;\n&nbsp;\n&nbsp;&nbsp;&nbsp; // è¾“å‡ºæ—¥å†è¡¨å¤´ï¼ˆä»å‘¨ä¸€åˆ°å‘¨æ—¥ï¼‰\n&nbsp;&nbsp;&nbsp; std::vector&lt;std::string&gt; headerLineParts;\n&nbsp;&nbsp;&nbsp; for (const auto&amp; weekday : Weekdays) {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; headerLineParts.push_back(std::format(ZhCNLocale, \"{:L%a}\", weekday));\n&nbsp;&nbsp;&nbsp; }\n&nbsp;&nbsp;&nbsp; // åˆ©ç”¨renderWeekLineç”Ÿæˆæ ¼å¼åŒ–çš„è¡¨å¤´ï¼ˆæ§åˆ¶7ä¸ªå…ƒç´ çš„ä½ç½®ä¸å®½åº¦ï¼‰\n&nbsp;&nbsp;&nbsp; std::string headerLine = renderWeekLine(headerLineParts);\n&nbsp;&nbsp;&nbsp; os &lt;&lt; headerLine &lt;&lt; std::endl;\n&nbsp;&nbsp;&nbsp; os &lt;&lt; std::format(\"{:-&gt;35}\", \"\") &lt;&lt; std::endl;\n&nbsp;\n&nbsp;&nbsp;&nbsp; // éå†monthWeeksï¼Œè°ƒç”¨renderWeekç”Ÿæˆæ—¥å†ä¸­çš„æ¯ä¸€è¡Œ\n&nbsp;&nbsp;&nbsp; for (const auto&amp; currentWeek : monthWeeks) {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; std::string weekLine = renderWeek(currentWeek, yearMonth);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; os &lt;&lt; weekLine &lt;&lt; std::endl;\n&nbsp;&nbsp;&nbsp; }\n&nbsp;\n&nbsp;&nbsp;&nbsp; // è¿”å›æ¸²æŸ“çš„å­—ç¬¦ä¸²\n&nbsp;&nbsp;&nbsp; return os.str();\n}\n&nbsp;\n// æ¸²æŸ“æ—¥å†ä¸­çš„æŸä¸€å‘¨\nstd::string renderWeek(const std::vector&lt;chrono::year_month_day&gt; week, chrono::year_month yearMonth) {\n&nbsp;&nbsp;&nbsp; // è·å–å½“æœˆç¬¬ä¸€å¤©\n&nbsp;&nbsp;&nbsp; const auto firstDay = yearMonth / 1d;\n&nbsp;&nbsp;&nbsp; // è·å–å½“æœˆæœ€åä¸€å¤©\n&nbsp;&nbsp;&nbsp; const auto lastDay = chrono::year_month_day(yearMonth / chrono::last);\n&nbsp;\n&nbsp;&nbsp;&nbsp; // ç”Ÿæˆæœ¬å‘¨çš„æ‰€æœ‰æ—¥æœŸ\n&nbsp;&nbsp;&nbsp; std::vector&lt;std::string&gt; weekLine;\n&nbsp;&nbsp;&nbsp; for (const auto&amp; currentDay : week) {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; std::string inCurrentMonthFlag = currentDay &gt;= firstDay &amp;&amp; currentDay &lt;= lastDay ? \"*\" : \"\";\n&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; weekLine.push_back(std::format(\"{}{:&gt;2}\", inCurrentMonthFlag, currentDay.day()));\n&nbsp;&nbsp;&nbsp; }\n&nbsp;\n&nbsp;&nbsp;&nbsp; // åˆ©ç”¨renderWeekLineç”Ÿæˆæ ¼å¼åŒ–çš„æœ¬å‘¨æ—¥æœŸ\n&nbsp;&nbsp;&nbsp; return renderWeekLine(weekLine);\n}\n&nbsp;\n// ç”ŸæˆæŸä¸€å‘¨çš„æ ¼å¼åŒ–è¾“å‡º\nstd::string renderWeekLine(const std::vector&lt;std::string&gt;&amp; weekLine) {\n&nbsp;&nbsp;&nbsp; std::string renderResult;\n&nbsp;&nbsp;&nbsp; for (const auto&amp; weekLineItem : weekLine) {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // æ‰€æœ‰å†…å®¹æŒ‰ç…§å®½åº¦ä¸º4å³å¯¹é½\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; renderResult.append(std::format(\"{:&gt;4} \", weekLineItem));\n&nbsp;&nbsp;&nbsp; }\n&nbsp;\n&nbsp;&nbsp;&nbsp; return renderResult;\n}\n</code></pre><p>ä»£ç ä¸­çš„æ³¨é‡Šå·²ç»æ¯”è¾ƒè¯¦ç»†äº†ï¼Œæ‰€ä»¥åé¢æˆ‘ä»¬åªè®¨è®ºä¸€äº›é‡ç‚¹å®ç°ã€‚</p><p>ä»£ç ç¬¬5è¡Œï¼Œä½œç”¨æ˜¯è·å–å½“æœˆçš„æ‰€æœ‰å‘¨çš„æ•°ç»„ï¼Œutils::buildMonthWeekså±äºæ—¥å†è®¡ç®—æ¨¡å—ï¼Œæˆ‘ä»¬åé¢è¯¦ç»†è§£é‡Šå…¶å®ç°ã€‚</p><p>åœ¨ä»£ç ç¬¬8è¡Œï¼Œç”¨yearMonth / 1dç”Ÿæˆå½“æœˆçš„ç¬¬ä¸€å¤©ï¼Œè¿”å›çš„ç±»å‹å°±æ˜¯year_month_dayã€‚å…¶ä¸­1dæ˜¯ä¸€ä¸ªè‡ªå®šä¹‰æ–‡å­—é‡ï¼Œå®šä¹‰åœ¨åç§°ç©ºé—´std::literals::chrono_literalsä¸­ï¼Œç›¸å½“äºchrono::days(1)çš„è¯­æ³•ç³–ï¼Œè¡¨ç¤ºæŸä¸ªæœˆ1å·ã€‚yearMonth / 1dä¸­çš„/æ˜¯yearMonthçš„æ“ä½œç¬¦é‡è½½ï¼Œè¡¨ç¤ºå½“æœˆç¬¬ä¸€å¤©ã€‚</p><p>åœ¨ä»£ç ç¬¬10è¡Œï¼Œç”¨yearMonth / chrono::lastè¡¨ç¤ºå½“æœˆæœ€åä¸€å¤©ã€‚å…¶ä¸­ï¼Œchrono::lastæ˜¯C++20ä¸­å¼•å…¥çš„ï¼Œç”¨æ¥è¡¨ç¤ºä¸€ä¸ªæ—¶é—´åºåˆ—æœ«å°¾çš„æ ‡è®°ã€‚æœ€åï¼Œæˆ‘ä»¬è°ƒç”¨chrono::year_month_dayè½¬æ¢æˆyear_month_dayã€‚</p><p>ä»£ç ç¬¬18åˆ°25è¡Œï¼Œè°ƒç”¨äº†renderWeekLineå¸®åŠ©æˆ‘ä»¬ç”Ÿæˆæ ¼å¼åŒ–çš„æ ‡é¢˜ï¼Œå› ä¸ºè¾“å‡ºçš„æ—¥å†éœ€è¦å°†ä¸€å‘¨ä¸ƒå¤©æŒ‰ç…§ä¸€å®šçš„å¸ƒå±€è¾“å‡ºåˆ°æ§åˆ¶å°ä¸Šï¼Œè¯¥å‡½æ•°å¯ä»¥å¸®åŠ©æˆ‘ä»¬å®Œæˆæ¸²æŸ“å¸ƒå±€ã€‚ä»£ç ç¬¬20è¡Œåˆ©ç”¨äº†localeè¾“å‡ºä¸­æ–‡ï¼Œæœ‰å…´è¶£å¯ä»¥è‡ªå·±çœ‹RenderUtils.cppä¸­çš„å®šä¹‰ä»¥åŠlocaleç›¸å…³å†…å®¹ã€‚</p><p>åœ¨ä»£ç ç¬¬28åˆ°31è¡Œï¼Œç”Ÿæˆæ—¥å†çš„å†…å®¹ã€‚ç”±äºæ—¥å†é‡Œæ¯å‘¨è¾“å‡ºåˆ°ä¸€è¡Œä¸­ï¼Œå› æ­¤è¿™é‡Œéå†å½“æœˆæ‰€æœ‰å‘¨ï¼Œè°ƒç”¨renderWeekå®Œæˆä¸€å‘¨çš„å¸ƒå±€è¾“å‡ºã€‚</p><p>renderWeekLineå‡½æ•°å®ç°ä¹Ÿä¼šæ¯”è¾ƒç®€å•ï¼Œè¾“å…¥å‚æ•°æ˜¯ä¸€ä¸ªåŒ…å«Nä¸ªå­—ç¬¦ä¸²çš„æ•°ç»„ï¼Œæ•°ç»„å…ƒç´ å°±æ˜¯åœ¨æ—¥å†ä¸­çš„æ¯ä¸€ä¸ªæ ¼å­ä¸­éœ€è¦è¾“å‡ºçš„å†…å®¹ï¼ˆæ¯”å¦‚è¡¨å¤´çš„å‘¨å‡ æˆ–è€…æ—¥æœŸï¼‰ï¼Œè¿™é‡Œä¸»è¦é€šè¿‡formatå°†æ¯ä¸€æ ¼å†…å®¹çš„è¾“å‡ºå®½åº¦é™åˆ¶åœ¨4ï¼Œç¡®ä¿å¸ƒå±€å·¥æ•´ã€‚</p><p>æ¸²æŸ“å‡ºæ¥çš„æ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚<br>\n<img src=\"https://static001.geekbang.org/resource/image/58/75/581e249fe9ff9eb69052ce33d496b275.jpg?wh=1990x1070\" alt=\"\"></p><p>æœ€åï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹utils::buildMonthWeeksçš„å®ç°ï¼Œä»£ç å®ç°åœ¨src/utils/CalendarUtils.cppä¸­ã€‚</p><pre><code class=\"language-c++\">#include \"utils/CalendarUtils.h\"\n#include &lt;format&gt;\n&nbsp;\nnamespace chrono = std::chrono;\nusing namespace std::literals::chrono_literals;\n&nbsp;\nstatic uint32_t MaxWeekdayIndex = 6;\n&nbsp;\nnamespace calendarpp::utils {\n&nbsp;&nbsp;&nbsp; std::vector&lt;std::vector&lt;std::chrono::year_month_day&gt;&gt; buildMonthWeeks(std::chrono::year_month yearMonth) {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // è·å–å½“æœˆç¬¬ä¸€å¤©\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; const auto firstDay = yearMonth / 1d;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // è·å–å½“æœˆæœ€åä¸€å¤©\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; const auto lastDay = chrono::year_month_day(yearMonth / chrono::last);\n&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; std::vector&lt;std::vector&lt;chrono::year_month_day&gt;&gt; monthWeeks;\n&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // å°†å½“æœˆç¬¬ä¸€å¤©è®¾å®šä¸ºå½“æ—¥\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; auto currentDay = firstDay;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // å½“æ¯å‘¨å½“æ—¥è¶…å‡ºå½“æœˆæœ€åä¸€å¤©æ—¶ä¸­æ­¢å¾ªç¯\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; while (currentDay &lt;= lastDay) {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // æ¯æ¬¡å¾ªç¯éƒ½è®¡ç®—å‡ºå½“æ—¥æ‰€åœ¨å‘¨çš„7å¤©ï¼ˆå‘¨ä¸€åˆ°å‘¨æ—¥ï¼‰\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; std::vector&lt;chrono::year_month_day&gt; currentMonthWeek;\n&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // é€šè¿‡weekdayè·å–æŸä¸€å¤©æ˜¯å‘¨å‡ \n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; auto currentWeekday = chrono::weekday{ std::chrono::sys_days{ currentDay } };\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // é€šè¿‡iso_encodingè·å–å‘¨å‡ çš„ç¼–ç ï¼ˆ1-7ï¼‰\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; auto currentWeekdayIndex = currentWeekday.iso_encoding() - 1;\n&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // è®¡ç®—æœ¬å‘¨ç¬¬ä¸€å¤©\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; auto firstDayOfWeek = chrono::year_month_day{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; std::chrono::sys_days{ currentDay } - chrono::days(currentWeekdayIndex)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; };\n&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; currentDay = firstDayOfWeek;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // è®¡ç®—å‡ºæœ¬å‘¨çš„æ‰€æœ‰æ—¥æœŸå¹¶æ·»åŠ åˆ°currentMonthWeekä¸­\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for (uint32_t weekdayIndex = 0; weekdayIndex &lt;= MaxWeekdayIndex; ++weekdayIndex) {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; currentMonthWeek.push_back(currentDay);\n&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; currentDay = chrono::year_month_day{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; std::chrono::sys_days{ currentDay } + chrono::days(1)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; };\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // å°†è®¡ç®—å¥½çš„å½“å‰å‘¨æ·»åŠ åˆ°monthWeeksä¸­\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; monthWeeks.push_back(currentMonthWeek);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }\n&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return monthWeeks;\n&nbsp;&nbsp;&nbsp; }\n}\n</code></pre><p>åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬ä¼šç”Ÿæˆå½“æœˆçš„æ‰€æœ‰å‘¨ï¼Œé€šè¿‡Calendarå®Œæˆäº†å¤§é‡çš„æ—¥æœŸè®¡ç®—ï¼Œç›¸æ¯”è‡ªå·±å®ç°æ ¼é‡Œé«˜åˆ©å†è¦æ–¹ä¾¿ä¸å°‘ã€‚</p><h2>å¯¼å‡ºæ—¥å†</h2><p>é™¤äº†å±•ç¤ºæ—¥å†ï¼Œæˆ‘ä»¬ç»§ç»­è®¨è®ºåºåˆ—åŒ–æ—¥å†çš„å®ç°ã€‚åœ¨src/actions/ExportAction.cppä¸­å®šä¹‰äº†å¯¼å‡ºèœå•é¡¹çš„ä»£ç å®ç°ã€‚</p><pre><code class=\"language-c++\">#include \"actions/ExportAction.h\"\n#include \"utils/RenderUtils.h\"\n#include \"utils/IOUtils.h\"\n&nbsp;\n#include &lt;chrono&gt;\n#include &lt;iostream&gt;\n#include &lt;string&gt;\n&nbsp;\nnamespace chrono = std::chrono;\n&nbsp;\nnamespace calendarpp::actions {\n&nbsp;&nbsp;&nbsp; void exportCurrentYear() {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // è·å–å½“å‰æ—¶é—´\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; chrono::time_point now{ chrono::system_clock::now() };\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // å°†æ—¶é—´è½¬æ¢ä¸ºyear_month_day\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; chrono::year_month_day ymd{ chrono::floor&lt;chrono::days&gt;(now) };\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // è·å–å½“å‰å¹´ä»½\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; chrono::year currentYear = ymd.year();\n&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // æç¤ºå¹¶è¯»å–ç”¨æˆ·è¾“å…¥\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; std::cout &lt;&lt; \"è¯·è¾“å…¥å¯¼å‡ºæ–‡ä»¶è·¯å¾„: \";\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; std::string filePath;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; std::getline(std::cin, filePath);\n&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // è°ƒç”¨IOæ¨¡å—å°†renderYearçš„æ¸²æŸ“ç»“æœè¾“å‡ºåˆ°æ–‡ä»¶ä¸­\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; utils::writeFile(filePath, utils::renderYear(currentYear));\n&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; std::cout &lt;&lt; std::format(\"å·²å°†æ—¥å†å¯¼å‡ºåˆ°æ–‡ä»¶ä¸­: {}\", filePath) &lt;&lt; std::endl;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; std::cout &lt;&lt; std::endl;\n&nbsp;&nbsp;&nbsp; }\n}\n</code></pre><p>è¿™æ®µä»£ç éå¸¸ç®€å•ï¼Œæ ¸å¿ƒæ˜¯é€šè¿‡renderYearæ¸²æŸ“å½“å¹´çš„æ—¥å†ï¼Œç„¶åé€šè¿‡writeFileä»¥UTF-8ç¼–ç å†™å…¥åˆ°æ–‡ä»¶ä¸­ã€‚</p><p>å‡½æ•°renderYearå®ç°åœ¨src/utils/RenderUtils.cppä¸­ï¼Œç›¸å…³ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code class=\"language-c++\">// å®šä¹‰ä¸€å¹´12ä¸ªæœˆçš„monthå¸¸é‡\nstatic std::vector&lt;chrono::month&gt; Months = {\n&nbsp;&nbsp;&nbsp; chrono::January,\n&nbsp;&nbsp;&nbsp; chrono::February,\n&nbsp;&nbsp;&nbsp; chrono::March,\n&nbsp;&nbsp;&nbsp; chrono::April,\n&nbsp;&nbsp;&nbsp; chrono::May,\n&nbsp;&nbsp;&nbsp; chrono::June,\n&nbsp;&nbsp;&nbsp; chrono::July,\n&nbsp;&nbsp;&nbsp; chrono::August,\n&nbsp;&nbsp;&nbsp; chrono::September,\n&nbsp;&nbsp;&nbsp; chrono::October,\n&nbsp;&nbsp;&nbsp; chrono::November,\n&nbsp;&nbsp;&nbsp; chrono::December,\n};\n&nbsp;\nstd::string renderYear(std::chrono::year year) {\n&nbsp;&nbsp;&nbsp; std::ostringstream os;\n&nbsp;\n&nbsp;&nbsp;&nbsp; // è¾“å‡ºæ ¼å¼åŒ–çš„æ ‡é¢˜ï¼ˆå¹´ä»½ï¼‰\n&nbsp;&nbsp;&nbsp; std::string titleLine = std::format(\"**** {:%Y}å¹´ ****\", year);\n&nbsp;&nbsp;&nbsp; os &lt;&lt; std::format(\"{:^35}\", titleLine) &lt;&lt; std::endl;\n&nbsp;&nbsp;&nbsp; os &lt;&lt; std::format(\"{:=^35}\\n\", \"\") &lt;&lt; std::endl;\n&nbsp;\n&nbsp;&nbsp;&nbsp; // è°ƒç”¨renderYearMonthså¹¶è¡Œç”Ÿæˆ12ä¸ªæœˆçš„æ—¥å†\n&nbsp;&nbsp;&nbsp; std::vector&lt;std::string&gt; renderedMonths(Months.size(), \"\");\n&nbsp;&nbsp;&nbsp; renderYearMonths(renderedMonths, year);\n&nbsp;\n&nbsp;&nbsp;&nbsp; // å°†12ä¸ªæœˆçš„æ—¥å†è¾“å…¥åˆ°è¾“å‡ºæµä¸­\n&nbsp;&nbsp;&nbsp; for (const std::string&amp; renderedMonth : renderedMonths) {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; os &lt;&lt; renderedMonth;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; os &lt;&lt; std::endl;\n&nbsp;&nbsp;&nbsp; }\n&nbsp;\n&nbsp;&nbsp;&nbsp; // è¿”å›æ¸²æŸ“å¥½çš„å­—ç¬¦ä¸²\n&nbsp;&nbsp;&nbsp; return os.str();\n}\n&nbsp;\nstatic void renderYearMonths(std::vector&lt;std::string&gt;&amp; renderedMonths, chrono::year year) {\n&nbsp;&nbsp;&nbsp; std::vector&lt;std::jthread&gt; renderThreads;\n&nbsp;\n&nbsp;&nbsp;&nbsp; int32_t monthIndex = 0;\n&nbsp;&nbsp;&nbsp; for (const auto&amp; currentMonth : Months) {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; auto currentYearMonth = year / currentMonth;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; auto&amp; renderedMonth = renderedMonths[monthIndex];\n&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // åˆ›å»ºjthreadå¯¹è±¡ï¼Œå¼€å¯è®¡ç®—çº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹è´Ÿè´£ç”Ÿæˆä¸€ä¸ªæœˆçš„æ—¥å†\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; renderThreads.push_back(std::jthread([currentYearMonth, &amp;renderedMonth] {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; renderedMonth = renderMonth(currentYearMonth);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }));\n&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ++monthIndex;\n&nbsp;&nbsp;&nbsp; }\n&nbsp;\n&nbsp;&nbsp;&nbsp; // é€€å‡ºå‡½æ•°æ—¶ï¼Œæ‰€æœ‰jthreadå¯¹è±¡ä¼šè‡ªåŠ¨ç­‰å¾…è®¡ç®—å®Œæˆç„¶åé€€å‡º\n}\n</code></pre><p>æˆ‘ä»¬é‡ç‚¹çœ‹ä¸€ä¸‹renderYearMonthså‡½æ•°çš„å®ç°ã€‚</p><p>è¯¥å‡½æ•°å®šä¹‰äº†ä¸€ä¸ªjthreadæ•°ç»„ï¼Œç„¶åå¾ªç¯åˆ›å»ºäº†12ä¸ªçº¿ç¨‹ï¼Œç”¨äºåˆ†åˆ«è°ƒç”¨renderMonthæ¸²æŸ“å„è‡ªæœˆä»½çš„æ—¥å†ã€‚ç”±äºjthreadä¼šåœ¨ææ„æ—¶è‡ªåŠ¨ç­‰å¾…æœ¬çº¿ç¨‹å®Œæˆã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦å»joinè¿™äº›çº¿ç¨‹ï¼Œåœ¨é€€å‡ºrenderYearMonthsä¹‹å‰ï¼Œæ‰€æœ‰çš„å·¥ä½œçº¿ç¨‹è‚¯å®šèƒ½ç»“æŸä»»åŠ¡ã€‚</p><p>æœ€åçœ‹ä¸€ä¸‹writeFileçš„å®ç°ï¼Œä»£ç åœ¨src/utils/IOUtils.cppä¸­ã€‚</p><pre><code class=\"language-c++\">#include \"utils/IOUtils.h\"\n#include \"Logger.h\"\n&nbsp;\n#include &lt;filesystem&gt;\n#include &lt;format&gt;\n#include &lt;iostream&gt;\n&nbsp;\nnamespace fs = std::filesystem;\n&nbsp;\nnamespace calendarpp::utils {\n&nbsp;&nbsp;&nbsp; void writeFile(const std::string&amp; filePath, const std::string&amp; fileContent) {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; auto&amp; logger = getLogger();\n&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // æ£€æµ‹æ–‡ä»¶æ˜¯å¦å­˜åœ¨\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (fs::exists(filePath)) {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; logger.warning(std::format(\"Override existed file: {}\", filePath));\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }\n&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // ç”±äºæºä»£ç ä½¿ç”¨UTF-8ï¼Œç”Ÿæˆçš„å­—ç¬¦ä¸²å°±æ˜¯UTF-8ï¼Œå› æ­¤å¯ä»¥ç›´æ¥å¼ºåˆ¶ç±»å‹è½¬æ¢æ„å»ºu8string\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; std::u8string utf8FileContent(reinterpret_cast&lt;const char8_t*&gt;(fileContent.c_str()), fileContent.size());\n&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // å°†u8stringä»¥äºŒè¿›åˆ¶å½¢å¼å†™å…¥åˆ°æ–‡ä»¶ä¸­\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; std::ofstream outputFile(filePath, std::ios::binary);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; outputFile.write(reinterpret_cast&lt;char*&gt;(utf8FileContent.data()), utf8FileContent.size());\n&nbsp;&nbsp;&nbsp; }\n}\n</code></pre><p>åœ¨è¿™æ®µä»£ç ä¸­ï¼Œé¦–å…ˆé€šè¿‡æ–‡ä»¶ç³»ç»Ÿåº“ä¸­çš„std::filsystem::existsæ£€æµ‹æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™æç¤ºç”¨æˆ·ä¼šè¦†ç›–åŸæœ‰æ–‡ä»¶ã€‚</p><p>æ¥ç€ï¼Œå°†å­—ç¬¦ä¸²è½¬æ¢æˆu8stringï¼Œç”±äºæºä»£ç ä½¿ç”¨UTF-8ï¼Œç”Ÿæˆçš„å­—ç¬¦ä¸²å°±æ˜¯UTF-8ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å¼ºåˆ¶ç±»å‹è½¬æ¢æ„å»ºu8stringã€‚</p><p>æœ€åï¼Œå°†u8stringçš„dataå¼ºåˆ¶ç±»å‹è½¬æ¢ä¸ºchar*ï¼Œå¹¶é€šè¿‡äºŒè¿›åˆ¶å½¢å¼å†™å…¥åˆ°æ–‡ä»¶ä¸­ã€‚</p><h2>æ€»ç»“</h2><p>åœ¨è¿™ä¸€è®²ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå·¥ç¨‹ï¼Œä¸²è®²äº†ä¸€ç³»åˆ—C++20å¸¦æ¥çš„é‡è¦åº“å˜æ›´ã€‚æˆ‘ä»¬åœ¨åŸæœ‰çš„æ—¥å¿—æ¡†æ¶åŸºç¡€ä¸Šï¼Œè¿½åŠ äº†source_locationï¼Œç”¨äºè®°å½•æ‰“å°æ—¥å¿—æ—¶ä»£ç çš„æ‰€åœ¨ä½ç½®ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå°†ä¼ ç»Ÿçš„è¾“å‡ºæµæ›¿æ¢æˆsync streamï¼Œå°±å¯ä»¥è½»æ¾å®ç°è¾“å‡ºçš„çº¿ç¨‹åŒæ­¥æ§åˆ¶ã€‚</p><p>åœ¨å®ç°çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬è¿˜ä½¿ç”¨äº†TimeZoneè·å–å¸¦æ—¶åŒºçš„æœ¬åœ°æ—¶é—´ï¼Œå¹¶é€šè¿‡ä½¿ç”¨Calendarå®Œæˆæ—¥å†è®¡ç®—ã€‚è¿™äº›é’ˆå¯¹chronoçš„æ ‡å‡†åº“è¡¥å……ï¼Œå¤§å¤§é™ä½äº†æ—¶é—´å¤„ç†çš„å¤æ‚åº¦ã€‚</p><p>æœ€åï¼Œæˆ‘ä»¬åˆ©ç”¨u8stringï¼Œè½»æ¾å®ç°äº†UTF-8ç¼–ç çš„æ–‡æœ¬å¯¼å‡ºã€‚</p><p>é€šè¿‡è¿™äº›æ¡ˆä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥æ„Ÿå—åˆ°ï¼Œ<strong>ç°ä»£ C++çš„åº“å˜æ›´å»ºç«‹åœ¨æ–°çš„æ ¸å¿ƒè¯­è¨€ç‰¹æ€§åŸºç¡€ä¸Šï¼Œä¸ºæˆ‘ä»¬æ—¥å¸¸ç¼–ç¨‹å·¥ä½œæä¾›äº†æå¤§çš„ä¾¿åˆ©ã€‚é¿å…é€ è½®å­ï¼Œæå‡ç¼–ç¨‹æ•ˆç‡</strong>â€”â€”è¿™äº›å¯¹äºåº“çš„æ ¸å¿ƒå˜æ›´æ¥è¯´æ˜¯æ ¸å¿ƒè®®é¢˜ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥ä¿æŒå¯¹æ ‡å‡†åº“æ¼”è¿›çš„æŒç»­å…³æ³¨ã€‚</p><h2>è¯¾åæ€è€ƒ</h2><p>ç°åœ¨æ—¥å†ä¸­æ˜¾ç¤ºçš„æ—¶é—´æ˜¯åŒ…å«æ—¶åŒºä¿¡æ¯çš„æœ¬åœ°æ—¶é—´ï¼Œå¦‚æœæˆ‘ä»¬å¸Œæœ›æ—¥å†ä¸­æ˜¾ç¤ºçš„å½“å‰æ—¶é—´æ˜¯UTCæ—¶é—´ï¼ˆæ—¥å†æ˜¾ç¤ºä¾ç„¶æŒ‰ç…§æœ¬åœ°æ—¶é—´è®¡ç®—ï¼Œä¸éœ€è¦å˜åŒ–ï¼‰ï¼Œæˆ‘ä»¬è¦å¯¹ä»£ç åšä»€ä¹ˆæ”¹åŠ¨ï¼Ÿ</p><p>æ¬¢è¿ç»™å‡ºä½ çš„æ–¹æ¡ˆï¼Œä¸å¤§å®¶ä¸€èµ·åˆ†äº«ã€‚æˆ‘ä»¬ä¸€åŒäº¤æµã€‚ä¸‹ä¸€è®²è§ï¼</p>","comments":[{"had_liked":false,"id":387093,"user_name":"æäº‘é¾™","can_delete":false,"product_type":"c1","uid":3201926,"ip_address":"åŒ—äº¬","ucode":"785924B16BE788","user_header":"https://static001.geekbang.org/account/avatar/00/30/db/86/51ec4c41.jpg","comment_is_top":false,"comment_ctime":1706435884,"is_pvip":false,"replies":[{"id":141120,"content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1006976,"ctime":1706699743,"ip_address":"ä¸Šæµ·","comment_id":387093,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100523801,"comment_content":"æŠŠæœ¬åœ°æ—¶é—´çš„æ˜¾ç¤ºæ¢æˆUTCæ—¶é—´ï¼Œåªéœ€ä¿®æ”¹RenderUtils.cppä¸­çš„ renderNow() å‡½æ•°ï¼šæŠŠchrono::system_clock::now() æ›¿æ¢ä¸º auto utcNow = std::chrono::utc_clock::now(); åŒæ—¶æŠŠæ—¶åŒºä¿¡æ¯å»é™¤ã€‚","like_count":1,"discussions":[{"author":{"id":1006976,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/5d/80/0c52be53.jpg","nickname":"å¢èª‰å£°","note":"","ucode":"93C5EFC39EB9C6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":636675,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1706699743,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":396201,"user_name":"ä¸‰ç¬‘ä¸‰å¼•ä¼å…µ","can_delete":false,"product_type":"c1","uid":3784424,"ip_address":"ä¸­å›½å°æ¹¾","ucode":"B96439B22B407E","user_header":"https://static001.geekbang.org/account/avatar/00/39/be/e8/878aa74f.jpg","comment_is_top":false,"comment_ctime":1733541721,"is_pvip":false,"replies":[{"id":143865,"content":"ä¸€èˆ¬å¹¶ä¸ä¼šå¯¼è‡´ç¼“å†²åŒºè¿‡é•¿ã€‚å› ä¸ºæ­£å¸¸åˆ°äº†ç¼“å†²åŒºé•¿åº¦è‚¯å®šå°±emitæˆ–è€…ææ„äº†ã€‚æ‰€ä»¥æˆ‘ä»¬æ¯æ¬¡è¾“å‡ºéƒ½ä¼šåŒ…è£…ä¸€ä¸ªæ–°çš„osyncstreamå¯¹è±¡ï¼Œç¡®ä¿ä¸ä¼šå‘ç”Ÿè¿™ä¸ªé—®é¢˜ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1006976,"ctime":1733980234,"ip_address":"åŠ æ‹¿å¤§","comment_id":396201,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100523801,"comment_content":"osyncstreamå¥½åƒæ˜¯åœ¨è°ƒç”¨emit()å’Œææ„æ—¶æ‰ä¼šå°†è‡ªèº«ç¼“å†²åŒºçš„å†…å®¹ä¼ è¾“ç»™è¢«åŒ…è£…çš„ç¼“å†²  åœ¨æ—¥å¿—æ¨¡å—ä¸­çš„è¯ä¸ä¼šå¯¼è‡´ç¼“å†²åŒºä¸€ç›´å¢é•¿å—\nä¸€èˆ¬æ€ä¹ˆè§£å†³å‘¢","like_count":0,"discussions":[{"author":{"id":1006976,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/5d/80/0c52be53.jpg","nickname":"å¢èª‰å£°","note":"","ucode":"93C5EFC39EB9C6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":655007,"discussion_content":"ä¸€èˆ¬å¹¶ä¸ä¼šå¯¼è‡´ç¼“å†²åŒºè¿‡é•¿ã€‚å› ä¸ºæ­£å¸¸åˆ°äº†ç¼“å†²åŒºé•¿åº¦è‚¯å®šå°±emitæˆ–è€…ææ„äº†ã€‚æ‰€ä»¥æˆ‘ä»¬æ¯æ¬¡è¾“å‡ºéƒ½ä¼šåŒ…è£…ä¸€ä¸ªæ–°çš„osyncstreamå¯¹è±¡ï¼Œç¡®ä¿ä¸ä¼šå‘ç”Ÿè¿™ä¸ªé—®é¢˜ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1733980234,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŠ æ‹¿å¤§","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":3784424,"avatar":"https://static001.geekbang.org/account/avatar/00/39/be/e8/878aa74f.jpg","nickname":"ä¸‰ç¬‘ä¸‰å¼•ä¼å…µ","note":"","ucode":"B96439B22B407E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":655189,"discussion_content":"å¥½çš„ äº†è§£ è°¢è°¢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1734353602,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"æ±Ÿè‹","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":369941,"user_name":"peter","can_delete":false,"product_type":"c1","uid":1058183,"ip_address":"åŒ—äº¬","ucode":"261C3FC001DE2D","user_header":"https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg","comment_is_top":false,"comment_ctime":1678162180,"is_pvip":false,"replies":[{"id":134892,"content":"éœ€è¦åŸºäºéå¸¸åŸºç¡€çš„Cå‡½æ•°è¿›è¡Œå°è£…ï¼Œæ²¡æœ‰æ ‡å‡†åŒ–æ–¹æ¡ˆã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1006976,"ctime":1678249670,"ip_address":"ä¸Šæµ·","comment_id":369941,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100523801,"comment_content":"C++20ä¹‹å‰æ²¡æœ‰Calendarå—ï¼Ÿ\næ–‡ä¸­â€œCalendar æ˜¯ C++20 å¼•å…¥åˆ° chrono ä¸­æ–°çš„åº“ç‰¹æ€§â€ï¼Œä¹‹å‰æ²¡æœ‰Calendarå—ï¼Ÿæœ‰ç‚¹å°æ€€ç–‘ã€‚å¦‚æœæ²¡æœ‰ï¼Œä»¥å‰æ˜¯æ€ä¹ˆå¤„ç†æ—¥å†é—®é¢˜çš„ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1006976,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/5d/80/0c52be53.jpg","nickname":"å¢èª‰å£°","note":"","ucode":"93C5EFC39EB9C6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":608074,"discussion_content":"éœ€è¦åŸºäºéå¸¸åŸºç¡€çš„Cå‡½æ•°è¿›è¡Œå°è£…ï¼Œæ²¡æœ‰æ ‡å‡†åŒ–æ–¹æ¡ˆã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1678249671,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}