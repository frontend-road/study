{"id":72388,"title":"13 | 为什么表数据删掉一半，表文件大小不变？","content":"<p>经常会有同学来问我，我的数据库占用空间太大，我把一个最大的表删掉了一半的数据，怎么表文件的大小还是没变？</p><p>那么今天，我就和你聊聊数据库表的空间回收，看看如何解决这个问题。</p><p>这里，我们还是针对MySQL中应用最广泛的InnoDB引擎展开讨论。一个InnoDB表包含两部分，即：表结构定义和数据。在MySQL 8.0版本以前，表结构是存在以.frm为后缀的文件里。而MySQL 8.0版本，则已经允许把表结构定义放在系统数据表中了。因为表结构定义占用的空间很小，所以我们今天主要讨论的是表数据。</p><p>接下来，我会先和你说明为什么简单地删除表数据达不到表空间回收的效果，然后再和你介绍正确回收空间的方法。</p><h1>参数innodb_file_per_table</h1><p>表数据既可以存在共享表空间里，也可以是单独的文件。这个行为是由参数innodb_file_per_table控制的：</p><ol>\n<li>\n<p>这个参数设置为OFF表示的是，表的数据放在系统共享表空间，也就是跟数据字典放在一起；</p>\n</li>\n<li>\n<p>这个参数设置为ON表示的是，每个InnoDB表数据存储在一个以 .ibd为后缀的文件中。</p>\n</li>\n</ol><p>从MySQL 5.6.6版本开始，它的默认值就是ON了。</p><p>我建议你不论使用MySQL的哪个版本，都将这个值设置为ON。因为，一个表单独存储为一个文件更容易管理，而且在你不需要这个表的时候，通过drop table命令，系统就会直接删除这个文件。而如果是放在共享表空间中，即使表删掉了，空间也是不会回收的。</p><!-- [[[read_end]]] --><p>所以，<strong>将innodb_file_per_table设置为ON，是推荐做法，我们接下来的讨论都是基于这个设置展开的。</strong></p><p>我们在删除整个表的时候，可以使用drop table命令回收表空间。但是，我们遇到的更多的删除数据的场景是删除某些行，这时就遇到了我们文章开头的问题：表中的数据被删除了，但是表空间却没有被回收。</p><p>我们要彻底搞明白这个问题的话，就要从数据删除流程说起了。</p><h1>数据删除流程</h1><p>我们先再来看一下InnoDB中一个索引的示意图。在前面<a href=\"https://time.geekbang.org/column/article/69236\">第4</a>和<a href=\"https://time.geekbang.org/column/article/69636\">第5</a>篇文章中，我和你介绍索引时曾经提到过，InnoDB里的数据都是用B+树的结构组织的。</p><p><img src=\"https://static001.geekbang.org/resource/image/f0/c8/f0b1e4ac610bcb5c5922d0b18563f3c8.png?wh=1142*856\" alt=\"\"></p><center><span class=\"reference\">图1 B+树索引示意图</span></center><p>假设，我们要删掉R4这个记录，InnoDB引擎只会把R4这个记录标记为删除。如果之后要再插入一个ID在300和600之间的记录时，可能会复用这个位置。但是，磁盘文件的大小并不会缩小。</p><p>现在，你已经知道了InnoDB的数据是按页存储的，那么如果我们删掉了一个数据页上的所有记录，会怎么样？</p><p>答案是，整个数据页就可以被复用了。</p><p>但是，<strong>数据页的复用跟记录的复用是不同的。</strong></p><p>记录的复用，只限于符合范围条件的数据。比如上面的这个例子，R4这条记录被删除后，如果插入一个ID是400的行，可以直接复用这个空间。但如果插入的是一个ID是800的行，就不能复用这个位置了。</p><p>而当整个页从B+树里面摘掉以后，可以复用到任何位置。以图1为例，如果将数据页page A上的所有记录删除以后，page A会被标记为可复用。这时候如果要插入一条ID=50的记录需要使用新页的时候，page A是可以被复用的。</p><p>如果相邻的两个数据页利用率都很小，系统就会把这两个页上的数据合到其中一个页上，另外一个数据页就被标记为可复用。</p><p>进一步地，如果我们用delete命令把整个表的数据删除呢？结果就是，所有的数据页都会被标记为可复用。但是磁盘上，文件不会变小。</p><p>你现在知道了，delete命令其实只是把记录的位置，或者数据页标记为了“可复用”，但磁盘文件的大小是不会变的。也就是说，通过delete命令是不能回收表空间的。这些可以复用，而没有被使用的空间，看起来就像是“空洞”。</p><p>实际上，<strong>不止是删除数据会造成空洞，插入数据也会。</strong></p><p>如果数据是按照索引递增顺序插入的，那么索引是紧凑的。但如果数据是随机插入的，就可能造成索引的数据页分裂。</p><p>假设图1中page A已经满了，这时我要再插入一行数据，会怎样呢？</p><p><img src=\"https://static001.geekbang.org/resource/image/80/ea/8083f05a4a4c0372833a6e01d5a8e6ea.png?wh=1142*1522\" alt=\"\"></p><center><span class=\"reference\">图2 插入数据导致页分裂</span></center><p>可以看到，由于page A满了，再插入一个ID是550的数据时，就不得不再申请一个新的页面page B来保存数据了。页分裂完成后，page A的末尾就留下了空洞（注意：实际上，可能不止1个记录的位置是空洞）。</p><p>另外，更新索引上的值，可以理解为删除一个旧的值，再插入一个新值。不难理解，这也是会造成空洞的。</p><p>也就是说，经过大量增删改的表，都是可能是存在空洞的。所以，如果能够把这些空洞去掉，就能达到收缩表空间的目的。</p><p>而重建表，就可以达到这样的目的。</p><h1>重建表</h1><p>试想一下，如果你现在有一个表A，需要做空间收缩，为了把表中存在的空洞去掉，你可以怎么做呢？</p><p>你可以新建一个与表A结构相同的表B，然后按照主键ID递增的顺序，把数据一行一行地从表A里读出来再插入到表B中。</p><p>由于表B是新建的表，所以表A主键索引上的空洞，在表B中就都不存在了。显然地，表B的主键索引更紧凑，数据页的利用率也更高。如果我们把表B作为临时表，数据从表A导入表B的操作完成后，用表B替换A，从效果上看，就起到了收缩表A空间的作用。</p><p>这里，你可以使用alter table A engine=InnoDB命令来重建表。在MySQL 5.5版本之前，这个命令的执行流程跟我们前面描述的差不多，区别只是这个临时表B不需要你自己创建，MySQL会自动完成转存数据、交换表名、删除旧表的操作。</p><p><img src=\"https://static001.geekbang.org/resource/image/02/cd/02e083adaec6e1191f54992f7bc13dcd.png?wh=1142*856\" alt=\"\"></p><center><span class=\"reference\">图3 改锁表DDL</span></center><p>显然，花时间最多的步骤是往临时表插入数据的过程，如果在这个过程中，有新的数据要写入到表A的话，就会造成数据丢失。因此，在整个DDL过程中，表A中不能有更新。也就是说，这个DDL不是Online的。</p><p>而在<strong>MySQL 5.6版本开始引入的Online DDL，对这个操作流程做了优化。</strong></p><p>我给你简单描述一下引入了Online DDL之后，重建表的流程：</p><ol>\n<li>\n<p>建立一个临时文件，扫描表A主键的所有数据页；</p>\n</li>\n<li>\n<p>用数据页中表A的记录生成B+树，存储到临时文件中；</p>\n</li>\n<li>\n<p>生成临时文件的过程中，将所有对A的操作记录在一个日志文件（row log）中，对应的是图中state2的状态；</p>\n</li>\n<li>\n<p>临时文件生成后，将日志文件中的操作应用到临时文件，得到一个逻辑数据上与表A相同的数据文件，对应的就是图中state3的状态；</p>\n</li>\n<li>\n<p>用临时文件替换表A的数据文件。</p>\n</li>\n</ol><p><img src=\"https://static001.geekbang.org/resource/image/2d/f0/2d1cfbbeb013b851a56390d38b5321f0.png?wh=1142*856\" alt=\"\"></p><center><span class=\"reference\">图4 Online DDL</span></center><p>可以看到，与图3过程的不同之处在于，由于日志文件记录和重放操作这个功能的存在，这个方案在重建表的过程中，允许对表A做增删改操作。这也就是Online DDL名字的来源。</p><p>我记得有同学在第6篇讲表锁的文章<a href=\"https://time.geekbang.org/column/article/69862\">《全局锁和表锁 ：给表加个字段怎么索这么多阻碍？》</a>的评论区留言说，DDL之前是要拿MDL写锁的，这样还能叫Online DDL吗？</p><p>确实，图4的流程中，alter语句在启动的时候需要获取MDL写锁，但是这个写锁在真正拷贝数据之前就退化成读锁了。</p><p>为什么要退化呢？为了实现Online，MDL读锁不会阻塞增删改操作。</p><p>那为什么不干脆直接解锁呢？为了保护自己，禁止其他线程对这个表同时做DDL。</p><p>而对于一个大表来说，Online DDL最耗时的过程就是拷贝数据到临时表的过程，这个步骤的执行期间可以接受增删改操作。所以，相对于整个DDL过程来说，锁的时间非常短。对业务来说，就可以认为是Online的。</p><p>需要补充说明的是，上述的这些重建方法都会扫描原表数据和构建临时文件。对于很大的表来说，这个操作是很消耗IO和CPU资源的。因此，如果是线上服务，你要很小心地控制操作时间。如果想要比较安全的操作的话，我推荐你使用GitHub开源的gh-ost来做。</p><h1>Online 和 inplace</h1><p>说到Online，我还要再和你澄清一下它和另一个跟DDL有关的、容易混淆的概念inplace的区别。</p><p>你可能注意到了，在图3中，我们把表A中的数据导出来的存放位置叫作tmp_table。这是一个临时表，是在server层创建的。</p><p>在图4中，根据表A重建出来的数据是放在“tmp_file”里的，这个临时文件是InnoDB在内部创建出来的。整个DDL过程都在InnoDB内部完成。对于server层来说，没有把数据挪动到临时表，是一个“原地”操作，这就是“inplace”名称的来源。</p><p>所以，我现在问你，如果你有一个1TB的表，现在磁盘间是1.2TB，能不能做一个inplace的DDL呢？</p><p>答案是不能。因为，tmp_file也是要占用临时空间的。</p><p>我们重建表的这个语句alter table t engine=InnoDB，其实隐含的意思是：</p><pre><code>alter table t engine=innodb,ALGORITHM=inplace;\n</code></pre><p>跟inplace对应的就是拷贝表的方式了，用法是：</p><pre><code>alter table t engine=innodb,ALGORITHM=copy;\n</code></pre><p>当你使用ALGORITHM=copy的时候，表示的是强制拷贝表，对应的流程就是图3的操作过程。</p><p>但我这样说你可能会觉得，inplace跟Online是不是就是一个意思？</p><p>其实不是的，只是在重建表这个逻辑中刚好是这样而已。</p><p>比如，如果我要给InnoDB表的一个字段加全文索引，写法是：</p><pre><code>alter table t add FULLTEXT(field_name);\n</code></pre><p>这个过程是inplace的，但会阻塞增删改操作，是非Online的。</p><p>如果说这两个逻辑之间的关系是什么的话，可以概括为：</p><ol>\n<li>\n<p>DDL过程如果是Online的，就一定是inplace的；</p>\n</li>\n<li>\n<p>反过来未必，也就是说inplace的DDL，有可能不是Online的。截止到MySQL 8.0，添加全文索引（FULLTEXT index）和空间索引(SPATIAL index)就属于这种情况。</p>\n</li>\n</ol><p>最后，我们再延伸一下。</p><p>在第10篇文章<a href=\"https://time.geekbang.org/column/article/71173\">《MySQL为什么有时候会选错索引》</a>的评论区中，有同学问到使用optimize table、analyze table和alter table这三种方式重建表的区别。这里，我顺便再简单和你解释一下。</p><ul>\n<li>从MySQL 5.6版本开始，alter table t engine = InnoDB（也就是recreate）默认的就是上面图4的流程了；</li>\n<li>analyze table t 其实不是重建表，只是对表的索引信息做重新统计，没有修改数据，这个过程中加了MDL读锁；</li>\n<li>optimize table t 等于recreate+analyze。</li>\n</ul><h1>小结</h1><p>今天这篇文章，我和你讨论了数据库中收缩表空间的方法。</p><p>现在你已经知道了，如果要收缩一个表，只是delete掉表里面不用的数据的话，表文件的大小是不会变的，你还要通过alter table命令重建表，才能达到表文件变小的目的。我跟你介绍了重建表的两种实现方式，Online DDL的方式是可以考虑在业务低峰期使用的，而MySQL 5.5及之前的版本，这个命令是会阻塞DML的，这个你需要特别小心。</p><p>最后，又到了我们的课后问题时间。</p><p>假设现在有人碰到了一个“想要收缩表空间，结果适得其反”的情况，看上去是这样的：</p><ol>\n<li>\n<p>一个表t文件大小为1TB；</p>\n</li>\n<li>\n<p>对这个表执行 alter table t engine=InnoDB；</p>\n</li>\n<li>\n<p>发现执行完成后，空间不仅没变小，还稍微大了一点儿，比如变成了1.01TB。</p>\n</li>\n</ol><p>你觉得可能是什么原因呢 ？</p><p>你可以把你觉得可能的原因写在留言区里，我会在下一篇文章的末尾把大家描述的合理的原因都列出来，以后其他同学就不用掉到这样的坑里了。感谢你的收听，也欢迎你把这篇文章分享给更多的朋友一起阅读。</p><h1>上期问题时间</h1><p>在上期文章最后，我留给你的问题是，如果一个高配的机器，redo log设置太小，会发生什么情况。</p><p>每次事务提交都要写redo log，如果设置太小，很快就会被写满，也就是下面这个图的状态，这个“环”将很快被写满，write pos一直追着CP。</p><p><img src=\"https://static001.geekbang.org/resource/image/a2/e5/a25bdbbfc2cfc5d5e20690547fe7f2e5.jpg?wh=1142*856\" alt=\"\"></p><p>这时候系统不得不停止所有更新，去推进checkpoint。</p><p>这时，你看到的现象就是<strong>磁盘压力很小，但是数据库出现间歇性的性能下跌。</strong></p><p>评论区留言点赞板：</p><blockquote>\n<p>@某、人 给了一个形象的描述，而且提到了，在这种情况下，连change buffer的优化也失效了。因为checkpoint一直要往前推，这个操作就会触发merge操作，然后又进一步地触发刷脏页操作；<br>\n有几个同学提到了内存淘汰脏页，对应的redo log的操作，这个我们会在后面的文章中展开，大家可以先看一下 @melon 同学的描述了解一下；<br>\n@算不出流源 提到了“动态平衡”，其实只要出现了这种“平衡”，意味着本应该后台的操作，就已经影响了业务应用，属于有损失的平衡。</p>\n</blockquote><p></p>","comments":[{"had_liked":false,"id":49398,"user_name":"陈飞","can_delete":false,"product_type":"c1","uid":1285028,"ip_address":"","ucode":"23D955265723B4","user_header":"https://static001.geekbang.org/account/avatar/00/13/9b/a4/a52a637d.jpg","comment_is_top":true,"comment_ctime":1544680661,"is_pvip":false,"replies":[{"id":"17785","content":"好问题。<br><br><br>性能一样的，没有一定要“连续”，只要是递增","user_name":"作者回复","comment_id":49398,"uid":"1264162","ip_address":"","utype":1,"ctime":1544695897,"user_name_real":"林晓斌"}],"discussion_count":6,"race_medal":0,"score":"9.2233727556589998e+18","product_id":100020801,"comment_content":"老师，请问下分布式ID（雪花算法生成的ID）生成的索引会比自增长的ID性能低吗？<br><br>雪花算法生成的ID是越来越大的，但不是逐渐递增，长度用的的bitint，麻烦解答下，非常感谢。","like_count":168,"discussions":[{"author":{"id":2035976,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/11/08/1129ff5a.jpg","nickname":"。","note":"","ucode":"A82F22678E439A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":346311,"discussion_content":"用这种分布式 ID 做主键是不是也会存在“页分裂”的问题，只是说几率可能比较小。因为分布式 ID 只能保证在生成的时候是严格递增的，但获取到 ID 后插入数据的顺序是不确定的。比如 A 先获取到 ID = 1，B 后获取到 ID = 2，但 B 插入的操作在 A 之前进行","likes_number":6,"is_delete":false,"is_hidden":false,"ctime":1611906303,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2014285,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKNv880TlsNuKaWcKbxiaAZTQIBWfJAddC8wfOROnwRPRwJXaEGSTBH2sic4jK7IGpxZn79tTDcREjw/132","nickname":"Geek_7482f6","note":"","ucode":"F3565F78525D30","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2035976,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/11/08/1129ff5a.jpg","nickname":"。","note":"","ucode":"A82F22678E439A","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":407522,"discussion_content":"这种现象是在并发比较高的发生的吧，你可以考虑一下，这种场景是不是经常发生，如果不是经常发生，其实可以不太考虑。如果是经常发生，你可能需要根据业务再进行优化了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635046763,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":346311,"ip_address":""},"score":407522,"extra":""}]},{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432604,"discussion_content":"好问题。\n\n\n性能一样的，没有一定要“连续”，只要是递增","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1544695897,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1438863,"avatar":"https://static001.geekbang.org/account/avatar/00/15/f4/8f/6b3d4370.jpg","nickname":"瑶老板的小弟","note":"","ucode":"EA6CDB3165227F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":538623,"discussion_content":"趋势递增","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639457397,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2350585,"avatar":"","nickname":"Geek_0ddc80","note":"","ucode":"57B8C059E6800D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":333228,"discussion_content":"在进行重新建表过程中，有新的更新语句，把redo_log写满了，需要写入磁盘这种情况怎么办呢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1607484073,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1303322,"avatar":"https://static001.geekbang.org/account/avatar/00/13/e3/1a/061e77b6.jpg","nickname":"亢星东","note":"","ucode":"5E4063E83B2BB9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":318785,"discussion_content":"放在本地更快","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603849842,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":48964,"user_name":"undifined","can_delete":false,"product_type":"c1","uid":1068920,"ip_address":"","ucode":"449CB4CD2DC089","user_header":"https://static001.geekbang.org/account/avatar/00/10/4f/78/c3d8ecb0.jpg","comment_is_top":true,"comment_ctime":1544582508,"is_pvip":false,"replies":[{"id":"17577","content":"1. Truncate 可以理解为drop+create<br>2.  Online 可以认为没有<br>3. 数据也是索引哦<br>4. 可能会<br>5. 好问题，我放到明天答疑部分","user_name":"作者回复","comment_id":48964,"uid":"1264162","ip_address":"","utype":1,"ctime":1544584585,"user_name_real":"林晓斌"}],"discussion_count":13,"race_medal":0,"score":"9.2233724979609006e+18","product_id":100020801,"comment_content":"老师，有几个问题：<br>1.Truncate 会释放表空间吗<br>2.重建表的时候如果没有数据更新，有没有可能产生页分裂和空洞<br>3.页分裂是发生在索引还是数据上<br>4.应用 row log 的过程会不会再次产生页分裂和空洞<br>5.不影响增删改，就是 Online；相对 Server层没有新建临时表，就是 inplace，这里怎么判断是不是相对 Server 层没有新建临时表<br>辛苦老师解答一下，谢谢老师","like_count":108,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432439,"discussion_content":"1. Truncate 可以理解为drop+create\n2.  Online 可以认为没有\n3. 数据也是索引哦\n4. 可能会\n5. 好问题，我放到明天答疑部分","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544584585,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2354810,"avatar":"","nickname":"Geek_4c4472","note":"","ucode":"22EE9820DAC79C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":333359,"discussion_content":"重建表的过程为啥不会产生空洞啊？比如一个数据页最多5条记录，按顺序依次插入1,2,3,4,5,6会分裂为两个数据页[1,2,3，_ , _ ] 和[4,5,6, _  , _ ]，且由索引节点 [ 4 ] 索引这两个数据页，虽然继续插入7,8会利用第二个数据页，但是第一个数据页因为索引4的限制，不会再插入新纪录了，导致第一个数据页的利用率只有50%","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1607506610,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1526355,"avatar":"https://static001.geekbang.org/account/avatar/00/17/4a/53/063f9d17.jpg","nickname":"moonfox","note":"","ucode":"902BFF40EFA9FA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2354810,"avatar":"","nickname":"Geek_4c4472","note":"","ucode":"22EE9820DAC79C","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":338101,"discussion_content":"MySQL对于你说的这种情况是有优化的，就是防止这样的空洞，6会单独插一页，12345插满同一页","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1609171558,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":333359,"ip_address":""},"score":338101,"extra":""},{"author":{"id":1780797,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/2c/3d/0bd58aa4.jpg","nickname":"Em","note":"","ucode":"32012A5C603C8A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2354810,"avatar":"","nickname":"Geek_4c4472","note":"","ucode":"22EE9820DAC79C","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576903,"discussion_content":"都说了重建了你还这123和456....","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655832423,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":333359,"ip_address":""},"score":576903,"extra":""}]},{"author":{"id":2350585,"avatar":"","nickname":"Geek_0ddc80","note":"","ucode":"57B8C059E6800D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":333229,"discussion_content":"在进行重新建表过程中，有新的更新语句，把redo_log写满了，需要写入磁盘这种情况怎么办呢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1607484083,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":3,"child_discussions":[{"author":{"id":1124075,"avatar":"https://static001.geekbang.org/account/avatar/00/11/26/eb/24e0ac9c.jpg","nickname":"嬴梦川","note":"","ucode":"104CDFD26A1711","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2350585,"avatar":"","nickname":"Geek_0ddc80","note":"","ucode":"57B8C059E6800D","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":369052,"discussion_content":"还是先写到 row log里面？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618912938,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":333229,"ip_address":""},"score":369052,"extra":""},{"author":{"id":2273076,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eo1QZQ0eoOqvOyMyAzcsyEK8bQaZTd9aJHTTCYicicUm9gmhUFaxQe6IBc3caLVD8PhqtmhhicrNHe0w/132","nickname":"Severus4","note":"","ucode":"79BC6487B595EE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2350585,"avatar":"","nickname":"Geek_0ddc80","note":"","ucode":"57B8C059E6800D","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":373718,"discussion_content":"“生成临时文件的过程中，将所有对 A 的操作记录在一个日志文件（row log）中”\n个人理解是新的更新语句除了写入redo_log，还会写入row log，这两个应该不冲突，redo_log写满了的话就把check_point往前推，只要row log没满就行","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1620833479,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":333229,"ip_address":""},"score":373718,"extra":""},{"author":{"id":1780797,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/2c/3d/0bd58aa4.jpg","nickname":"Em","note":"","ucode":"32012A5C603C8A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2273076,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eo1QZQ0eoOqvOyMyAzcsyEK8bQaZTd9aJHTTCYicicUm9gmhUFaxQe6IBc3caLVD8PhqtmhhicrNHe0w/132","nickname":"Severus4","note":"","ucode":"79BC6487B595EE","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576904,"discussion_content":"redo写满了需要刷脏页 这个时候怎么办?","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655832535,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":373718,"ip_address":""},"score":576904,"extra":""}]},{"author":{"id":1045107,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f2/73/1c7bceae.jpg","nickname":"乔纳森","note":"","ucode":"51EC9FAE071388","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":281041,"discussion_content":"but it also extends the period of time at the end of the DDL operation when the table is locked to apply logged DML.\n看来apply logged DML 是会锁表的\nhttps://dev.mysql.com/doc/refman/5.7/en/innodb-online-ddl-space-requirements.html","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591665342,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1045107,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f2/73/1c7bceae.jpg","nickname":"乔纳森","note":"","ucode":"51EC9FAE071388","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":281035,"discussion_content":"apply  row log 的时候，是不是已经将S-MDL 提升为 X-MDL了？(来自阿里PolarDB 技术支持的解释），我对此表示怀疑","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591664936,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":3,"child_discussions":[{"author":{"id":2278559,"avatar":"https://static001.geekbang.org/account/avatar/00/22/c4/9f/a01e4bd1.jpg","nickname":"海浪","note":"","ucode":"091941B3556B4B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1045107,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f2/73/1c7bceae.jpg","nickname":"乔纳森","note":"","ucode":"51EC9FAE071388","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":326272,"discussion_content":"这里说的table is locked指的是MDL读锁把表锁住了吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605574190,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":281035,"ip_address":""},"score":326272,"extra":""},{"author":{"id":1837414,"avatar":"","nickname":"winder","note":"","ucode":"58A63A6CC5E6DD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2278559,"avatar":"https://static001.geekbang.org/account/avatar/00/22/c4/9f/a01e4bd1.jpg","nickname":"海浪","note":"","ucode":"091941B3556B4B","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":327652,"discussion_content":"我感觉是这样","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605882437,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":326272,"ip_address":""},"score":327652,"extra":""},{"author":{"id":1526355,"avatar":"https://static001.geekbang.org/account/avatar/00/17/4a/53/063f9d17.jpg","nickname":"moonfox","note":"","ucode":"902BFF40EFA9FA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1837414,"avatar":"","nickname":"winder","note":"","ucode":"58A63A6CC5E6DD","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":338098,"discussion_content":"我觉得这个时候是把mdl读锁提升到mdl写锁了，直到最后的替换表完成","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609171117,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":327652,"ip_address":""},"score":338098,"extra":""}]}]},{"had_liked":false,"id":49563,"user_name":"发条橙子 。","can_delete":false,"product_type":"c1","uid":1259218,"ip_address":"","ucode":"ED076F4534FFED","user_header":"https://static001.geekbang.org/account/avatar/00/13/36/d2/c7357723.jpg","comment_is_top":true,"comment_ctime":1544716161,"is_pvip":false,"replies":[{"id":"17817","content":"1. 不是哦，我文章里说的加全文索引就不online<br><br>2. 对，这两个暂时，都是时间很短的<br><br>3. 是，DML语句加的是MDL读锁，读读不冲突<br><br>4. 好问题 ， 不过alter table 语句会默认提交前面的事务，然后自己独立执行😄","user_name":"作者回复","comment_id":49563,"uid":"1264162","ip_address":"","utype":1,"ctime":1544719012,"user_name_real":"林晓斌"}],"discussion_count":8,"race_medal":0,"score":"9.2233723734069002e+18","product_id":100020801,"comment_content":"老师 ， 我的确实是 5.7 版本。我今天看了些关于 online ddl的文章 ，再结合表锁那章评论的内容，有几个点还想确认一下 ，希望老师能解答一下 。<br><br>1. 是不是 5.6 之后 所有的 alter 操作(增删字段、增删索引等)都是支持 online ddl <br><br>2. 如果 alter 都是 online ddl 那么是不是如果 alter操作 获取到mdl写锁 时， 后面的 查询需要mdl读锁会暂时阻塞， 但是mdl会马上降为读锁 ，后面的操作会继续进行不会堵塞 。等再升到写锁 ，后面操作又会暂时阻塞。 <br><br>3. 当 alter 降到mdl 读锁时 ， 这时候可以新增数据么 ， mdl表级读锁 不会影响到 insert 或者 update的行锁么 <br><br>4. 如果将 alter 操作显式的放到事务里 ，事务不提交 ， 另一个事务查询的时候会查询到alter 操作后的表结构 ， 比如新增了一个字段。这个是什么原因 ，是否打破了 mvcc 的定义呢","like_count":79,"discussions":[{"author":{"id":1336951,"avatar":"https://static001.geekbang.org/account/avatar/00/14/66/77/194ba21d.jpg","nickname":"lzh","note":"","ucode":"C3D83DF4230109","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":4490,"discussion_content":"在事务里面用alter会有隐式提交，因为要保持事务一致性","likes_number":23,"is_delete":false,"is_hidden":false,"ctime":1565488478,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1344997,"avatar":"https://static001.geekbang.org/account/avatar/00/14/85/e5/eedb0528.jpg","nickname":"Zed","note":"","ucode":"0B1BF15DFB050C","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":541140,"discussion_content":"“Alter 会默认提交前面的事务”，如果前面的事务这时候还没有执行完，提交不会有问题么","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1640266225,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2278559,"avatar":"https://static001.geekbang.org/account/avatar/00/22/c4/9f/a01e4bd1.jpg","nickname":"海浪","note":"","ucode":"091941B3556B4B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":326274,"discussion_content":"alter执行完毕后也会提交","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1605574409,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1350991,"avatar":"https://static001.geekbang.org/account/avatar/00/14/9d/4f/273ffb51.jpg","nickname":"小哪吒","note":"","ucode":"252087A733355C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2278559,"avatar":"https://static001.geekbang.org/account/avatar/00/22/c4/9f/a01e4bd1.jpg","nickname":"海浪","note":"","ucode":"091941B3556B4B","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":382484,"discussion_content":"Alter 无所谓事务吧，所以执行完成后立即生效","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625591822,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":326274,"ip_address":""},"score":382484,"extra":""}]},{"author":{"id":1372556,"avatar":"https://static001.geekbang.org/account/avatar/00/14/f1/8c/754566c5.jpg","nickname":"微光","note":"","ucode":"023D7D3F637F4F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":544450,"discussion_content":"第三点应该不会阻塞insert和update操作，加读锁的目的是防止并发alter table，所以这里的读锁是意向锁","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641527191,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432659,"discussion_content":"1. 不是哦，我文章里说的加全文索引就不online\n\n2. 对，这两个暂时，都是时间很短的\n\n3. 是，DML语句加的是MDL读锁，读读不冲突\n\n4. 好问题 ， 不过alter table 语句会默认提交前面的事务，然后自己独立执行😄","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544719012,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2350585,"avatar":"","nickname":"Geek_0ddc80","note":"","ucode":"57B8C059E6800D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":333230,"discussion_content":"在进行重新建表过程中，有新的更新语句，把redo_log写满了，需要写入磁盘这种情况怎么办呢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1607484092,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1074742,"avatar":"https://static001.geekbang.org/account/avatar/00/10/66/36/b4a4e6fb.jpg","nickname":"Edon du","note":"","ucode":"1648624751AAE9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2350585,"avatar":"","nickname":"Geek_0ddc80","note":"","ucode":"57B8C059E6800D","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":340145,"discussion_content":"我想的是重新建表应该会重新申请数据页进行数据复制，而redo_log 记录的就是数据页都干了什么，如果这个时候满了，则需要等待redo log flush完成，才能记录这个最新的数据页的相关操作。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609916125,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":333230,"ip_address":""},"score":340145,"extra":""}]}]},{"had_liked":false,"id":49359,"user_name":"郜","can_delete":false,"product_type":"c1","uid":1074032,"ip_address":"","ucode":"A5D5D890946356","user_header":"https://static001.geekbang.org/account/avatar/00/10/63/70/0b7b5cda.jpg","comment_is_top":true,"comment_ctime":1544670447,"is_pvip":false,"replies":[{"id":"17786","content":"额，<br><br>Copy的时候肯定更要的…<br><br>这里特别指出来，是因为大多数人很容易理解copy需要临时空间，但是误以为inplace不需要<br><br><br>Anyway,好问题 😄","user_name":"作者回复","comment_id":49359,"uid":"1264162","ip_address":"","utype":1,"ctime":1544695981,"user_name_real":"林晓斌"}],"discussion_count":8,"race_medal":0,"score":"9.2233721715434004e+18","product_id":100020801,"comment_content":"麻烦咨询个问题，“在图 3 中，我们把表 A 中的数据导出来的存放位置叫作 tmp_table。这是一个临时表，是在 server 层创建的。”<br>在server层创建的表也是将A表数据copy到了临时表，为什么在空间不够用时就没有问题，而inplace在InnoDB执行则会再占用一份存储？<br>","like_count":32,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432589,"discussion_content":"额，\n\nCopy的时候肯定更要的…\n\n这里特别指出来，是因为大多数人很容易理解copy需要临时空间，但是误以为inplace不需要\n\n\nAnyway,好问题 😄","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544695981,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2350585,"avatar":"","nickname":"Geek_0ddc80","note":"","ucode":"57B8C059E6800D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":333231,"discussion_content":"在进行重新建表过程中，有新的更新语句，把redo_log写满了，需要写入磁盘这种情况怎么办呢","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1607484100,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1780797,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/2c/3d/0bd58aa4.jpg","nickname":"Em","note":"","ucode":"32012A5C603C8A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2350585,"avatar":"","nickname":"Geek_0ddc80","note":"","ucode":"57B8C059E6800D","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576905,"discussion_content":"还是写到row log?","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655832728,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":333231,"ip_address":""},"score":576905,"extra":""}]},{"author":{"id":1464006,"avatar":"https://static001.geekbang.org/account/avatar/00/16/56/c6/0b449bc6.jpg","nickname":"斐波那契","note":"","ucode":"85E2EBC01392B1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":178891,"discussion_content":"那问题来了 既然都会占用空间 那对于大表来说该怎么alter table呢","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1582203267,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1834977,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/ff/e1/ea2b6cef.jpg","nickname":"有头发的程序员","note":"","ucode":"48B9B1C5CC4E3A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1464006,"avatar":"https://static001.geekbang.org/account/avatar/00/16/56/c6/0b449bc6.jpg","nickname":"斐波那契","note":"","ucode":"85E2EBC01392B1","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":305028,"discussion_content":"用其他方式,比如说备库里面的表alter完了,再接上主库,更新完binlog后,同步了,再主从切换.","likes_number":6,"is_delete":false,"is_hidden":false,"ctime":1599745884,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":178891,"ip_address":""},"score":305028,"extra":""},{"author":{"id":2166073,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/k3YD3y3BzGDSdrwRJyJY4BXsNJibfM4uzOdDVKIAlFApR2FZCLg2ibrZtJ4vuahA3LHLW9GKzH5CMGqCDhWjhZqg/132","nickname":"戒酒的李白","note":"","ucode":"744E1A22761647","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1464006,"avatar":"https://static001.geekbang.org/account/avatar/00/16/56/c6/0b449bc6.jpg","nickname":"斐波那契","note":"","ucode":"85E2EBC01392B1","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":402610,"discussion_content":"要是磁盘空间不够， 就不配做ddl。 不然怎么也不行","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1633921888,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":178891,"ip_address":""},"score":402610,"extra":""}]},{"author":{"id":1874999,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/9c/37/253ea895.jpg","nickname":"我不是码农","note":"","ucode":"EB4BB711CC54B6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":551369,"discussion_content":"原来如此，就是空间不够怎么也不行","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644999467,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1335293,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKR3ibELhjgVicCNShZCBwvaDxibnzibggG4wUzVkS2mkDxUBZyIs87nDEdJ7PiahJBVoZcuhQ84RxAziag/132","nickname":"周治慧","note":"","ucode":"7D56C4E66BEE17","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":186354,"discussion_content":"大表是不适合做alter table操作的,做也是在晚上处理并且要对时间进行预估;因为做alter table操作的时候online的第一步要获取MDL的写锁此时不能DML语句和DDL语句的执行","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582678715,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":48976,"user_name":"飞翔","can_delete":false,"product_type":"c1","uid":1303038,"ip_address":"","ucode":"30D659BD4BD0AA","user_header":"","comment_is_top":false,"comment_ctime":1544584577,"is_pvip":false,"replies":[{"id":"17585","content":"一个漂亮的答案","user_name":"作者回复","comment_id":48976,"uid":"1264162","ip_address":"","utype":1,"ctime":1544586212,"user_name_real":"林晓斌"}],"discussion_count":18,"race_medal":0,"score":"1178365623681","product_id":100020801,"comment_content":"我想到的其中一种可能：<br>本来就很紧凑，没能整出多少剩余空间。<br>重新收缩的过程中，页会按90%满的比例来重新整理页数据（10%留给UPDATE使用），<br>未整理之前页已经占用90%以上，收缩之后，文件就反而变大了。","like_count":275,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432447,"discussion_content":"一个漂亮的答案","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544586212,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1618289,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b1/71/d5df5dc1.jpg","nickname":"张缘","note":"","ucode":"8A05C57E46ED87","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":202575,"discussion_content":"我的问题是，既然存在很紧凑的情况，那么我们去重新收缩的时候就需要谨慎，有没有办法去判断该不该进行收缩呢","likes_number":6,"is_delete":false,"is_hidden":false,"ctime":1583934419,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":10,"child_discussions":[{"author":{"id":1834977,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/ff/e1/ea2b6cef.jpg","nickname":"有头发的程序员","note":"","ucode":"48B9B1C5CC4E3A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1618289,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b1/71/d5df5dc1.jpg","nickname":"张缘","note":"","ucode":"8A05C57E46ED87","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":305033,"discussion_content":"INFORMATION_SCHEMA.INNODB_BUFFER_PAGE  这里面可以看到每个page的尺寸,如果离16KB很近,那就说明基本满了. 做个统计就行了.","likes_number":44,"is_delete":false,"is_hidden":false,"ctime":1599746330,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":202575,"ip_address":""},"score":305033,"extra":""},{"author":{"id":2375518,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJjUlpicxYn2HMHiahGFIficiaOfrZia5s8sY2XTgYtFtRUXjgecuyr4hhrpLA9vx48qxLajvZn7D2qdibA/132","nickname":"Geek_382cd1","note":"","ucode":"33387CE620FC7A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1834977,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/ff/e1/ea2b6cef.jpg","nickname":"有头发的程序员","note":"","ucode":"48B9B1C5CC4E3A","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":351450,"discussion_content":"Mark","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1614270811,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":305033,"ip_address":""},"score":351450,"extra":""},{"author":{"id":1124075,"avatar":"https://static001.geekbang.org/account/avatar/00/11/26/eb/24e0ac9c.jpg","nickname":"嬴梦川","note":"","ucode":"104CDFD26A1711","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1834977,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/ff/e1/ea2b6cef.jpg","nickname":"有头发的程序员","note":"","ucode":"48B9B1C5CC4E3A","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":369057,"discussion_content":"刚去看了下，很赞！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618914235,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":305033,"ip_address":""},"score":369057,"extra":""}]},{"author":{"id":2761358,"avatar":"","nickname":"Geek_d38758","note":"","ucode":"7BE0963E18DDDC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":589494,"discussion_content":"这个90%是什么知识点？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1665043267,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"北京"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":3014916,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqKiaa7OE3FelFiaUmFCiaMUTn1kG3UrR3ZuzTOl5bSGDTjThn3ujFQgcbeZBPump30Jfzb4EEZeUhaQ/132","nickname":"Geek_e009ee","note":"","ucode":"EB5DB9A8D6DBA2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":585605,"discussion_content":"mark","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661701130,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"福建"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2957548,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/TCc0icvama5VVOH4B3icFjcofPXVD7LrcS6GkBa09rMMM33Dgicg3adaNGYJwMS2u5BNnG7SXWPvXIGuKjFdXTnIA/132","nickname":"Geek_3c04cb","note":"","ucode":"F24EAE4985A372","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583658,"discussion_content":"mark","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660277158,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2026666,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/ec/aa/3dcec393.jpg","nickname":"小太阳","note":"","ucode":"39E5F069203C05","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546638,"discussion_content":"mark","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642382678,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1104699,"avatar":"https://static001.geekbang.org/account/avatar/00/10/db/3b/311cb46a.jpg","nickname":"TiAmo","note":"","ucode":"A9957AB9D08631","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":544055,"discussion_content":"Mark","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641389504,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1324501,"avatar":"https://static001.geekbang.org/account/avatar/00/14/35/d5/17833946.jpg","nickname":"八宝","note":"","ucode":"89D991A930FDEA","race_medal":1,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":396424,"discussion_content":"Mark","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632441534,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":108925,"user_name":"钱","can_delete":false,"product_type":"c1","uid":1009652,"ip_address":"","ucode":"2C92A243A463D4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg","comment_is_top":false,"comment_ctime":1561938738,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"452533504818","product_id":100020801,"comment_content":"1：为啥删除了表的一半数8据，表文文件大小没变化？<br><br>因为delete 命令其实只是把记录的位置，或者数据页标记为了“可复用”，但磁盘文件的大小是不会变的。也可以认为是一种逻辑删除，所以物理空间没有实际释放，只是标记为可复用，表文件的大小当然是不变的啦！<br><br>2：表的数据信息存在哪里？<br><br>表数据信息可能较小也可能巨大无比，她可以存储在共享表空间里，也可以单独存储在一个以.ibd为后缀的文件里，由参数innodb_file_per_table来控制，老师建议总是作为一个单独的文件来存储，这样非常容易管理，并且在不需要的时候，使用drop table命令也能直接把对应的文件删除，如果存储在共享空间之中即使表删除了空间也不会释放。<br><br>3：表的结构信息存在哪里？<br><br>首先，表结构定义占有的存储空间比较小，在MySQL8.0之前，表结构的定义信息存在以.frm为后缀的文件里，在MySQL8.0之后，则允许把表结构的定义信息存在系统数据表之中。<br><br>系统数据表，主要用于存储MySQL的系统数据，比如：数据字典、undo log(默认)等文件<br><br>4：如何才能删除表数据后，表文件大小就变小？<br><br>重建表，消除表因为进行大量的增删改操作而产生的空洞，使用如下命令：<br><br>1：alter table t engine=InnoDB<br><br>2：optimize table t( 等于 recreate+analyze)。<br><br>3：truntace table t (等于drop+create)<br><br>5：空洞是啥？咋产生的？<br><br>空洞就是那些被标记可复用但是还没被使用的存储空间。<br><br>使用delete命令删除数据会产生空洞，标记为可复用<br><br>插入新的数据可能引起页分裂，也可能产生空洞<br><br>修改操作，有时是一种先删后插的动作也可能产生空洞<br>","like_count":106,"discussions":[{"author":{"id":2041396,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/26/34/891dd45b.jpg","nickname":"宙斯","note":"","ucode":"80DF36BAD298AD","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":391514,"discussion_content":"1：为啥删除了表的一半数8据，表文文件大小没变化？\n标记删除不释放空间。\n\n2：表的数据信息存在哪里？\n由innodb_file_per_table控制，no存在.ibd中，yes单独存在.frm中\n5.6及以前innodb_file_per_table默认为no，5.6及以后 默认为yes。\n\n3 表的结构信息存在哪里？\n8.0以前存在.ibd中，存在.frm中，8.0及以后存在系统数据表。\n\n4：删除表数据后，表文件大小如何变小？\n alter table t engine=InnoDB\n optimize table t( 等于 recreate+analyze)。\n truntace table t (等于drop+create)\n\n5：空洞是啥？\n空洞是被标记可复用的空间。\n\n6：空洞怎么产生的？\n delete，insert，update都有可能产生空洞。\n 索引非递增导致页分裂，容易产生空洞。\n","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1630490952,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":64281,"user_name":"Mr.Panda","can_delete":false,"product_type":"c1","uid":1238864,"ip_address":"","ucode":"655A3013B5E849","user_header":"https://static001.geekbang.org/account/avatar/00/12/e7/50/d476ed6c.jpg","comment_is_top":false,"comment_ctime":1548733388,"is_pvip":false,"replies":[{"id":"22770","content":"3. 可以这么想下，如果1，2，3，4，5<br>然后update把2 改成6， 如果原地修改，这个索引就不是“有序”的了","user_name":"作者回复","comment_id":64281,"uid":"1264162","ip_address":"","utype":1,"ctime":1548739468,"user_name_real":"林晓斌"}],"discussion_count":21,"race_medal":0,"score":"375210888140","product_id":100020801,"comment_content":"很喜欢作者的MySQL，绝对干货哈哈。<br>这里针对空洞提下问题：<br>1.删除有空洞，是因为标记了已删除可复用的节点位置，不会释放。<br>2.随机插入有空洞，是因为数据页分裂造成。<br>3.但更新有空洞，有点费解，我个人理解是更新是结合删除和插入的一个合并操作。删除后产生的空洞，在插入时不是应该就马上被复用了吗，毕竟主键是一致的。所以为什么更新会产生空洞呢？？","like_count":87,"discussions":[{"author":{"id":1809802,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/9d/8a/a2d34896.jpg","nickname":"一元(wx:abley1874)","note":"","ucode":"5E7A33642FC767","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":302814,"discussion_content":"老师这里没讲明白，我再给大家说道说道。\n原因是更新可能会导致位置改变。说再详细些应该是这样，其实更新操作，主键索引树的位置是不会变的，可能会变的是哪些二级索引树。","likes_number":11,"is_delete":false,"is_hidden":false,"ctime":1599037037,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1809802,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/9d/8a/a2d34896.jpg","nickname":"一元(wx:abley1874)","note":"","ucode":"5E7A33642FC767","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":371187,"discussion_content":"主键值都更新了，为啥主键索引树的位置不会变，解释一下？二级索引才不会变，二级索引的key有没有发生变化，变化的是value，也就是主键值而已","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619681780,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":302814,"ip_address":""},"score":371187,"extra":""},{"author":{"id":1986739,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/50/b3/9269cd59.jpg","nickname":"LWD","note":"","ucode":"DDA444DB113C01","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1809802,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/9d/8a/a2d34896.jpg","nickname":"一元(wx:abley1874)","note":"","ucode":"5E7A33642FC767","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":580964,"discussion_content":"更新后主键的位置是可能变的。不然为啥每页都预留一些空间呢？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1658419912,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":302814,"ip_address":""},"score":580964,"extra":""}]},{"author":{"id":1179676,"avatar":"https://static001.geekbang.org/account/avatar/00/12/00/1c/d39cdabd.jpg","nickname":"疯狂的石头","note":"","ucode":"E14331FAA436EE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":5593,"discussion_content":"1，2，3，4，5，将2更新为6，先删除了2，并在5后面插入了6，这样保证了索引的有序，但是2位置就变成空洞了。","likes_number":8,"is_delete":false,"is_hidden":false,"ctime":1566367927,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":7,"child_discussions":[{"author":{"id":1599454,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLOKzDVXse2WibsBGOR27GVYOlv8WRtFBfQe4ekNia2S5986QibD6Wv17gyDpZqmQt3kJcAcbhl3rroQ/132","nickname":"itsxun","note":"","ucode":"69E6CEA3FCB4F3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1179676,"avatar":"https://static001.geekbang.org/account/avatar/00/12/00/1c/d39cdabd.jpg","nickname":"疯狂的石头","note":"","ucode":"E14331FAA436EE","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":240503,"discussion_content":"实际上并不是这样子的，索引的顺序是通过行记录的指针进行维护的，而不是通过物理存储顺序维护的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587369739,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":5593,"ip_address":""},"score":240503,"extra":""},{"author":{"id":1295768,"avatar":"","nickname":"InfoQ_61ccf683c4df","note":"","ucode":"2D3437F0D0749F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1599454,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLOKzDVXse2WibsBGOR27GVYOlv8WRtFBfQe4ekNia2S5986QibD6Wv17gyDpZqmQt3kJcAcbhl3rroQ/132","nickname":"itsxun","note":"","ucode":"69E6CEA3FCB4F3","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":293350,"discussion_content":"页之间是通过指针来维护，但是单个页内的数据不是吧","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1595506482,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":240503,"ip_address":""},"score":293350,"extra":""},{"author":{"id":1285652,"avatar":"","nickname":"mycat","note":"","ucode":"6878BD32D042F2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1599454,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLOKzDVXse2WibsBGOR27GVYOlv8WRtFBfQe4ekNia2S5986QibD6Wv17gyDpZqmQt3kJcAcbhl3rroQ/132","nickname":"itsxun","note":"","ucode":"69E6CEA3FCB4F3","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":305736,"discussion_content":"老师在下面回复了这个疑问：作者回复: 可以这么想下，如果2 和 6应该属于不同的父亲节点，那父亲节点怎么表示这个page的取值范围？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600072205,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":240503,"ip_address":""},"score":305736,"extra":""}]},{"author":{"id":1672786,"avatar":"https://static001.geekbang.org/account/avatar/00/19/86/52/91c7d112.jpg","nickname":"Garen","note":"","ucode":"0608C88F83EF0C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":33228,"discussion_content":"我的理解是修改索引会造成空洞，修改其他非索引字段是没有空洞的。普通索引应该也是会造成空洞的，只是空间小。因为数据是放在主键索引上的。所以单个空洞占用空间大。","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1571110512,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1834977,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/ff/e1/ea2b6cef.jpg","nickname":"有头发的程序员","note":"","ucode":"48B9B1C5CC4E3A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":305035,"discussion_content":"还有就是,即使主键id没变, update进去的数据更多了,会导致这条数据变大. 然后膨胀引发分页,造成空洞.","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1599746517,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2166073,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/k3YD3y3BzGDSdrwRJyJY4BXsNJibfM4uzOdDVKIAlFApR2FZCLg2ibrZtJ4vuahA3LHLW9GKzH5CMGqCDhWjhZqg/132","nickname":"戒酒的李白","note":"","ucode":"744E1A22761647","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1834977,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/ff/e1/ea2b6cef.jpg","nickname":"有头发的程序员","note":"","ucode":"48B9B1C5CC4E3A","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":326279,"discussion_content":"确实。update,delete都可能产生空洞，包括主键索引和二级索引","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1605575561,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":305035,"ip_address":""},"score":326279,"extra":""}]},{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437935,"discussion_content":"3. 可以这么想下，如果1，2，3，4，5\n然后update把2 改成6， 如果原地修改，这个索引就不是“有序”的了","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1548739468,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2166073,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/k3YD3y3BzGDSdrwRJyJY4BXsNJibfM4uzOdDVKIAlFApR2FZCLg2ibrZtJ4vuahA3LHLW9GKzH5CMGqCDhWjhZqg/132","nickname":"戒酒的李白","note":"","ucode":"744E1A22761647","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":402615,"discussion_content":"修改非索引字段是不会造成空洞的， 因为修改后， 不会影响到索引树上的排序。  针对主键索引， 如果修改的是主键值，也会导致数据挪动（以保持索引的有序性），从而可能导致页分裂，造成空洞。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1633922490,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":157870,"discussion_content":"关键现实操作中，基本不会有更改主键更新的这种行为。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1580528224,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1155646,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKotsBr2icbYNYlRSlicGUD1H7lulSTQUAiclsEz9gnG5kCW9qeDwdYtlRMXic3V6sj9UrfKLPJnQojag/132","nickname":"ppd0705","note":"","ucode":"EB63D4E3FD1E9A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":299284,"discussion_content":"请问普通索引呢？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1597642016,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":157870,"ip_address":""},"score":299284,"extra":""}]},{"author":{"id":2041396,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/26/34/891dd45b.jpg","nickname":"宙斯","note":"","ucode":"80DF36BAD298AD","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":391516,"discussion_content":"我有一个观点：老师这里暗示对索引的操作。\n首先索引树是什么？是一颗B+树，这是根据1，2，3，4，5，6顺序的。\n假如没两个数据为一个页，这里共有3个页，12一个页，34一个页，56一个页，若数字2被更改为6，为了保持B+树的特性，会页分裂，（以前的2）就必须到6那页或新页上，以前2的位置要么为空洞，要么3被分裂过来。\n\n其实数据更新特别是字符穿页有可能导致页分裂。某text字段以前存10个字符，现在更新为10w个字符，这也有页分裂的可能。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630491833,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1285652,"avatar":"","nickname":"mycat","note":"","ucode":"6878BD32D042F2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":305673,"discussion_content":"有哪位大佬给解释一下楼上两位说的哪个观点是正确的？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600052963,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1335293,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKR3ibELhjgVicCNShZCBwvaDxibnzibggG4wUzVkS2mkDxUBZyIs87nDEdJ7PiahJBVoZcuhQ84RxAziag/132","nickname":"周治慧","note":"","ucode":"7D56C4E66BEE17","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":186364,"discussion_content":"普通索引的更新会产品空洞,更新操作是先删除在添加,那么删除的位置则变成了空洞;在被空间复用","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582678908,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49063,"user_name":"帆帆帆帆帆帆帆帆","can_delete":false,"product_type":"c1","uid":1304645,"ip_address":"","ucode":"0CB732FFD07463","user_header":"https://static001.geekbang.org/account/avatar/00/13/e8/45/c58cb283.jpg","comment_is_top":false,"comment_ctime":1544596883,"is_pvip":false,"replies":[{"id":"17620","content":"👍🏿，下一篇答疑直接贴你答案😄","user_name":"作者回复","comment_id":49063,"uid":"1264162","ip_address":"","utype":1,"ctime":1544608618,"user_name_real":"林晓斌"}],"discussion_count":7,"race_medal":0,"score":"366616817043","product_id":100020801,"comment_content":"@undifined怎么判断是不是相对 Server 层没有新建临时表。一个最直观的判断方法是看命令执行后影响的行数，没有新建临时表的话新建的行数是0。","like_count":86,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432471,"discussion_content":"👍🏿，下一篇答疑直接贴你答案😄","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544608618,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1008597,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/63/d5/a300899a.jpg","nickname":"杨丁","note":"","ucode":"D469B0BCA86587","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":545513,"discussion_content":"MariaDB [test]&gt; alter table t engine=InnoDB;\nQuery OK, 0 rows affected (0.800 sec)\nRecords: 0  Duplicates: 0  Warnings: 0\n\nMariaDB [test]&gt; alter table t engine=innodb,ALGORITHM=copy;\nQuery OK, 100000 rows affected (1.381 sec)             \nRecords: 100000  Duplicates: 0  Warnings: 0\n\n赞！！","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1641979891,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2845977,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/6d/19/204b0900.jpg","nickname":"Black Jack","note":"","ucode":"CB16C8F44EF422","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":536370,"discussion_content":"学习了\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638771589,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2166073,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/k3YD3y3BzGDSdrwRJyJY4BXsNJibfM4uzOdDVKIAlFApR2FZCLg2ibrZtJ4vuahA3LHLW9GKzH5CMGqCDhWjhZqg/132","nickname":"戒酒的李白","note":"","ucode":"744E1A22761647","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":402619,"discussion_content":"确实牛逼， 学到了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633922667,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1351117,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/2au3iaQvydOVeVY1vlSVeGia7SvrpWFVibdxdjKiafof3RhzFO9e8sxKIBxKXJQibRNpO9pCH2hmibkibsGv7YKF3yjEw/132","nickname":"秋一匹","note":"","ucode":"BEBDBF8C15C6BC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":323656,"discussion_content":"给表加列是inplace的，但是语句执行影响的行数并不是0。你这个解释有问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604978764,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2191611,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI4tSatQ0rLPu7KBPyxnicmNj0SznMibMK85mFcRKvZrjA7XzP48CKUx0pib4ial0icQRribpZJHw3UMzSA/132","nickname":"Geek_9acf33","note":"","ucode":"3C39B88C3B7813","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1351117,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/2au3iaQvydOVeVY1vlSVeGia7SvrpWFVibdxdjKiafof3RhzFO9e8sxKIBxKXJQibRNpO9pCH2hmibkibsGv7YKF3yjEw/132","nickname":"秋一匹","note":"","ucode":"BEBDBF8C15C6BC","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":382976,"discussion_content":"是不是mysql版本不对，我这里影响行数就是0。除非加上 algorithm=copy","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625814447,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":323656,"ip_address":""},"score":382976,"extra":""}]},{"author":{"id":1017377,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/86/21/4ef1a2d5.jpg","nickname":"非晚","note":"","ucode":"997B9A82DDDB8C","race_medal":1,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":297457,"discussion_content":"妙啊","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596943336,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":65923,"user_name":"null","can_delete":false,"product_type":"c1","uid":1024294,"ip_address":"","ucode":"F9039EFED6B55D","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaELZPnUAiajaR5C25EDLWeJURggyiaOP5GGPe2qlwpQcm5e3ybib8OsP4tvddFDLVRSNNGL5I3SFPJHsA/132","comment_is_top":false,"comment_ctime":1549775940,"is_pvip":false,"replies":[{"id":"23989","content":"👍","user_name":"作者回复","comment_id":65923,"uid":"1264162","ip_address":"","utype":1,"ctime":1550297158,"user_name_real":"林晓斌"}],"discussion_count":3,"race_medal":0,"score":"233478009924","product_id":100020801,"comment_content":"临时表插入数据时，不允许表 A 有增删改操作，否则会造成数据丢失。所以表数据 copy  的方式不是 online  的。<br>而 inplace 的方式，在构建临时文件时，允许表 A 有增删改操作，期间新的增删改操作会记录到另外的日志文件，表 A 数据页的所有数据复制完成后，再应用日志文件（自己理解：应用日志文件时，不允许对表 A  增删改操作，即非 online 的）。整体操作是 online  的。<br>切换表名或临时文件时，需要获取 MDL 写锁。<br>inplace 表示在 innodb 引擎完成所有操作，对 server 层是透明的。inplace 操作不一定是 online 的，如 MySQL 8.0 的添加全文索引和空间索引。而 online 的一定是 inplace 的。","like_count":55,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438643,"discussion_content":"👍","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550297158,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1644104,"avatar":"https://static001.geekbang.org/account/avatar/00/19/16/48/09493874.jpg","nickname":"茶没喝完","note":"","ucode":"D72D88C42A1258","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":307704,"discussion_content":"感谢，解除了我的疑惑","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1600738890,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2845977,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/6d/19/204b0900.jpg","nickname":"Black Jack","note":"","ucode":"CB16C8F44EF422","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":536346,"discussion_content":"读了好几遍，最终的理解和你的一致","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1638764794,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":48928,"user_name":"wang chen wen","can_delete":false,"product_type":"c1","uid":1065463,"ip_address":"","ucode":"168CA7EE7A3EFF","user_header":"https://static001.geekbang.org/account/avatar/00/10/41/f7/277f14bb.jpg","comment_is_top":false,"comment_ctime":1544579155,"is_pvip":false,"replies":[{"id":"17560","content":"好问题，这个得是比较极端的情况下才有必要，所以我比较喜欢直接用alter ","user_name":"作者回复","comment_id":48928,"uid":"1264162","ip_address":"","utype":1,"ctime":1544581844,"user_name_real":"林晓斌"}],"discussion_count":3,"race_medal":0,"score":"130393598035","product_id":100020801,"comment_content":"optimize table t 等于 recreate+analyze<br>老师请教个问题recreate出来应该是几乎全新的，analyze的必要性？","like_count":31,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432423,"discussion_content":"好问题，这个得是比较极端的情况下才有必要，所以我比较喜欢直接用alter ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544581844,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2069361,"avatar":"","nickname":"林静","note":"","ucode":"492618873E9B1F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":357059,"discussion_content":"recreat是重建表，analize是收集分析数据，感觉不冲突啊？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1615730402,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2069361,"avatar":"","nickname":"林静","note":"","ucode":"492618873E9B1F","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":371198,"discussion_content":"表都重建了，索引信息都是新的了，老师也没说极端情况是什么情况","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619682940,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":357059,"ip_address":""},"score":371198,"extra":""}]}]},{"had_liked":false,"id":49516,"user_name":"某、人","can_delete":false,"product_type":"c1","uid":1308784,"ip_address":"","ucode":"ADB42AA12A11C1","user_header":"https://static001.geekbang.org/account/avatar/00/13/f8/70/f3a33a14.jpg","comment_is_top":false,"comment_ctime":1544703985,"is_pvip":false,"replies":[{"id":"17801","content":"1. 确保没有启发请求在用这个表<br><br>2. Binlog设置为row格式，幂等的<br><br>3. 这个我觉得其实是bug,就没提。你在DDL期间，往原表插入一个已经存在相同主键的一行试试","user_name":"作者回复","comment_id":49516,"uid":"1264162","ip_address":"","utype":1,"ctime":1544709103,"user_name_real":"林晓斌"}],"discussion_count":7,"race_medal":0,"score":"108918886385","product_id":100020801,"comment_content":"通过第10期的课后思考题学习到如果delete的数据还会被用于MVCC,那么该数据页(二级索引和聚簇索引)上的记录不会被物理删除,是被标记删除。只有当该事务不会用于mvcc了,才可以被purge线程把之前标记删除的数据真正删除掉.但是即便数据物理删除了,磁盘空间也不会返回给操作系统.可以通过show table status like &#39;t&#39;;观察data_free来预估该表的碎片。如果过大,可以用alter table t engine=innodb来清除<br>我有几个问题请教下老师:<br>1.inplace相对于其他在线改表软件,多了MDL X锁.既然都是通过临时表&#47;文件来做,为什么一开始要上MDL X锁？<br>2.gh-ost使用binlog来做同步,假设从position 1开始,先lock S前面1000条数据做cp,这时有事务对后面1000条数据做了修改或者插入。等cp后面这个1000条时,会把修改好的数据cp到临时表.最后又应用binlog,那么这相当于做了两次操作,请问这部分数据是怎么处理的？<br>3.online会把过程中对表的操作记录在一个(row log)中,那么中途这些DML事务,是怎么判定的commit?我做测试,中途这些事务都是成功的。但是有在做online DDL快完了,commit那个阶段,DDL报唯一键冲突,这又是什么原因造成的啊？我没有模拟出来这个例子","like_count":26,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432644,"discussion_content":"1. 确保没有启发请求在用这个表\n\n2. Binlog设置为row格式，幂等的\n\n3. 这个我觉得其实是bug,就没提。你在DDL期间，往原表插入一个已经存在相同主键的一行试试","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544709103,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1633316,"avatar":"https://static001.geekbang.org/account/avatar/00/18/ec/24/6bceb24c.jpg","nickname":"孝孝孝孝孝康","note":"","ucode":"0B475582C30D25","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":531145,"discussion_content":"好家伙大佬炸鱼来了？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637241222,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"user_type\":1}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1002074,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/4a/5a/c9e70aec.jpg","nickname":"yeyuliunian","note":"","ucode":"ACBCD834BDE602","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":52521,"discussion_content":"这里“确保没有其他请求在用这个表”目的是什么？是ddl 线程在此刻有啥特殊操作吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574060741,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":4,"child_discussions":[{"author":{"id":1003086,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/4e/4e/c41de010.jpg","nickname":"chenxi","note":"","ucode":"1B8C0C4DF92601","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1002074,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/4a/5a/c9e70aec.jpg","nickname":"yeyuliunian","note":"","ucode":"ACBCD834BDE602","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":178976,"discussion_content":"禁止并发 ddl？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582205447,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":52521,"ip_address":""},"score":178976,"extra":""},{"author":{"id":1335293,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKR3ibELhjgVicCNShZCBwvaDxibnzibggG4wUzVkS2mkDxUBZyIs87nDEdJ7PiahJBVoZcuhQ84RxAziag/132","nickname":"周治慧","note":"","ucode":"7D56C4E66BEE17","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1003086,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/4e/4e/c41de010.jpg","nickname":"chenxi","note":"","ucode":"1B8C0C4DF92601","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":186447,"discussion_content":"DDL本来就并发不了,online下MDL锁降级为MDL读锁了也不能去执行第二次DDL,DDL操作写会被MDL读锁阻塞因为要申请MDL的写锁;这个地方应该说的是获取MDL的写锁防止执行DML语句对表数据进行修改影响拷贝","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582681726,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":178976,"ip_address":""},"score":186447,"extra":""},{"author":{"id":2287841,"avatar":"https://static001.geekbang.org/account/avatar/00/22/e8/e1/6045b299.jpg","nickname":"LPF","note":"","ucode":"036C552D7251E9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1335293,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKR3ibELhjgVicCNShZCBwvaDxibnzibggG4wUzVkS2mkDxUBZyIs87nDEdJ7PiahJBVoZcuhQ84RxAziag/132","nickname":"周治慧","note":"","ucode":"7D56C4E66BEE17","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":327510,"discussion_content":"拷贝数据的时候对A表的修改是不直接修改A表的，只是将DML操作存入日志文件，等拷贝完数据到temp file才进行日志文件的归档，所以我认为MDL写锁不是防止DML操作对表示局修改影响拷贝，因为拷贝信息时并没有对索引进行修改，而是存储到日志文件中。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605853056,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":186447,"ip_address":""},"score":327510,"extra":""}]}]},{"had_liked":false,"id":51573,"user_name":"壹口尘埃","can_delete":false,"product_type":"c1","uid":1002953,"ip_address":"","ucode":"F63EF6BCCB7355","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKVIjh4T1akib7wAQXiaMmTRVe89bT3tBAeSdFflCQSWjDZQOs5jeBEWLC1GyFshHjvhsIZKArO6ichw/132","comment_is_top":false,"comment_ctime":1545201625,"is_pvip":false,"discussion_count":6,"race_medal":0,"score":"104624416729","product_id":100020801,"comment_content":"网上找到一个Inplace和Online的区别，写的挺好的，贴出来方便大家理解：<br>MySQL各版本，对于add Index的处理方式是不同的，主要有三种：<br><br>（1）Copy Table方式<br>这是InnoDB最早支持的创建索引的方式。顾名思义，创建索引是通过临时表拷贝的方式实现的。<br><br>新建一个带有新索引的临时表，将原表数据全部拷贝到临时表，然后Rename，完成创建索引的操作。<br><br>这个方式创建索引，创建过程中，原表是可读的。但是会消耗一倍的存储空间。<br><br>（2）Inplace方式<br>这是原生MySQL 5.5，以及innodb_plugin中提供的创建索引的方式。所谓Inplace，也就是索引创建在原表上直接进行，不会拷贝临时表。相对于Copy Table方式，这是一个进步。<br><br>Inplace方式创建索引，创建过程中，原表同样可读的，但是不可写。<br><br>（3）Online方式<br>这是MySQL 5.6.7中提供的创建索引的方式。无论是Copy Table方式，还是Inplace方式，创建索引的过程中，原表只能允许读取，不可写。对应用有较大的限制，因此MySQL最新版本中，InnoDB支持了所谓的Online方式创建索引。<br><br>InnoDB的Online Add Index，首先是Inplace方式创建索引，无需使用临时表。在遍历聚簇索引，收集记录并插入到新索引的过程中，原表记录可修改。而修改的记录保存在Row Log中。当聚簇索引遍历完毕，并全部插入到新索引之后，重放Row Log中的记录修改，使得新索引与聚簇索引记录达到一致状态。<br><br>与Copy Table方式相比，Online Add Index采用的是Inplace方式，无需Copy Table，减少了空间开销；与此同时，Online Add Index只有在重放Row Log最后一个Block时锁表，减少了锁表的时间。<br><br>与Inplace方式相比，Online Add Index吸收了Inplace方式的优势，却减少了锁表的时间。","like_count":24,"discussions":[{"author":{"id":1115958,"avatar":"https://static001.geekbang.org/account/avatar/00/11/07/36/d677e741.jpg","nickname":"黑山老妖","note":"","ucode":"A1659F99C5BE1E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":360258,"discussion_content":"解释的非常清楚！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1616401870,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1809802,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/9d/8a/a2d34896.jpg","nickname":"一元(wx:abley1874)","note":"","ucode":"5E7A33642FC767","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":302819,"discussion_content":"文章中的Online和Inplace讲得稀里糊涂的，你这个倒是好理解，但怎么好几处都和文章中说的不一样呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599038237,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":4,"child_discussions":[{"author":{"id":1275424,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/aiaO77mTsCalcia49ElevPn988pgwcL3rD5ic1DTD6E8rbAwfmguiaPsibHicsYGQID7VbmD21GUAV9bbuNMfDhDGGyg/132","nickname":"穿针土豆丝","note":"","ucode":"5DA3BDDE5162E4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1809802,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/9d/8a/a2d34896.jpg","nickname":"一元(wx:abley1874)","note":"","ucode":"5E7A33642FC767","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":350630,"discussion_content":"其实很好理解的，DDL 的方式就两种，一种是COPY，一种是INPLACE。mysql 5.6之前是 COPY 方式，mysql5.6引入 online，整个过程在引擎内部完成，对于 server 层没有创建临时表，就是 Inplace 方式。所以，如果DDL过程是 online 的，那么一定是 Inplace 方式。反之不一定，比如添加全文索引。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1613959561,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":302819,"ip_address":""},"score":350630,"extra":""},{"author":{"id":2463658,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIia6JywZv309nf8y9JCknibhGv6Wz1b1wO6GhCR6lzvia3BhllFIRT3cOF5INwqE9ib1bVJWRl7bOq6Q/132","nickname":"Geek_chen","note":"","ucode":"F962122DB779A6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1809802,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/9d/8a/a2d34896.jpg","nickname":"一元(wx:abley1874)","note":"","ucode":"5E7A33642FC767","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":357765,"discussion_content":"想请教下文章copy方式中的“新建一个带有新索引的临时表”，这是什么意思","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1615862667,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":302819,"ip_address":""},"score":357765,"extra":""},{"author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2463658,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIia6JywZv309nf8y9JCknibhGv6Wz1b1wO6GhCR6lzvia3BhllFIRT3cOF5INwqE9ib1bVJWRl7bOq6Q/132","nickname":"Geek_chen","note":"","ucode":"F962122DB779A6","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":371212,"discussion_content":"就是创建一个与原表一样的临时表，然后把数据从原表copy到临时表","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619685363,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":357765,"ip_address":""},"score":371212,"extra":""}]}]},{"had_liked":false,"id":49438,"user_name":"库淘淘","can_delete":false,"product_type":"c1","uid":1310240,"ip_address":"","ucode":"90813B0C46E978","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqibSwKPg7hiapc49qoM4dibhM3fYANPjfltF2ibBZ3dHX2hibjg5EIIcziahrmjO5R2XrcRibvU39TQS7jg/132","comment_is_top":false,"comment_ctime":1544688249,"is_pvip":false,"replies":[{"id":"17783","content":"如果有别的线程正在读这个表的数据，得等下","user_name":"作者回复","comment_id":49438,"uid":"1264162","ip_address":"","utype":1,"ctime":1544695667,"user_name_real":"林晓斌"}],"discussion_count":8,"race_medal":0,"score":"87444034169","product_id":100020801,"comment_content":"alter table A engine=InnoDB 中由写锁降为读锁。有个疑问 为何不直接就加个MDL读锁 ,这样DDL 也执行不了,应用redo 替换文件后释放读锁即可","like_count":21,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432617,"discussion_content":"如果有别的线程正在读这个表的数据，得等下","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544695667,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1148537,"avatar":"https://static001.geekbang.org/account/avatar/00/11/86/79/28fcafa6.jpg","nickname":"胡红伟","note":"","ucode":"33F12A97311F63","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":4655,"discussion_content":"多个线程做ddl时，如果获取mdl读锁，就不好弄了","likes_number":6,"is_delete":false,"is_hidden":false,"ctime":1565623782,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2166073,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/k3YD3y3BzGDSdrwRJyJY4BXsNJibfM4uzOdDVKIAlFApR2FZCLg2ibrZtJ4vuahA3LHLW9GKzH5CMGqCDhWjhZqg/132","nickname":"戒酒的李白","note":"","ucode":"744E1A22761647","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":402634,"discussion_content":"老师解释的方向不太对， 这个应该就是因为不允许并发的ddl，所以就只能加MDL写锁。 如果加了MDL读锁， 那多个ddl语句过来， 都加了读锁， 是可以并行执行的， 这个就违背了初衷。","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1633923933,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2843604,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/63/d4/b63373c3.jpg","nickname":"金金","note":"","ucode":"807EDDCDB2E939","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2166073,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/k3YD3y3BzGDSdrwRJyJY4BXsNJibfM4uzOdDVKIAlFApR2FZCLg2ibrZtJ4vuahA3LHLW9GKzH5CMGqCDhWjhZqg/132","nickname":"戒酒的李白","note":"","ucode":"744E1A22761647","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":560268,"discussion_content":"读和读又不冲突，而且加写锁也只是一瞬间的事，后面实际操作就降级为读锁了，你这个解释不成立","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649245060,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":402634,"ip_address":""},"score":560268,"extra":""}]},{"author":{"id":2667025,"avatar":"","nickname":"Geek_a39aea","note":"","ucode":"94E6C8088AE0CB","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":390395,"discussion_content":"如果DDL操作加MDL读锁的话，读读是不互斥的，可能在我DDL操作时，正巧有个线程正在MDL，这个时候可能会导致表结构与数据不一致，所以加DDL加写锁就是为了排除干净我在操作时没有任何线程在操作该表，因为DDL加写锁是互斥的，只要有MDL读锁或者写锁加在该表上，都无法加上MDL写锁","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1629814180,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2843604,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/63/d4/b63373c3.jpg","nickname":"金金","note":"","ucode":"807EDDCDB2E939","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2667025,"avatar":"","nickname":"Geek_a39aea","note":"","ucode":"94E6C8088AE0CB","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":560269,"discussion_content":"在保持读锁期间，写锁是不能获取到的，你这个解释也不对","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649245109,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":390395,"ip_address":""},"score":560269,"extra":""}]},{"author":{"id":2166073,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/k3YD3y3BzGDSdrwRJyJY4BXsNJibfM4uzOdDVKIAlFApR2FZCLg2ibrZtJ4vuahA3LHLW9GKzH5CMGqCDhWjhZqg/132","nickname":"戒酒的李白","note":"","ucode":"744E1A22761647","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":326384,"discussion_content":"防止多个线程同时做ddl操作","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605587521,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2166073,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/k3YD3y3BzGDSdrwRJyJY4BXsNJibfM4uzOdDVKIAlFApR2FZCLg2ibrZtJ4vuahA3LHLW9GKzH5CMGqCDhWjhZqg/132","nickname":"戒酒的李白","note":"","ucode":"744E1A22761647","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":371210,"discussion_content":"他的意思是加了MDL读锁，也不能执行DDL，为什么还要加MDL写锁？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619684905,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":326384,"ip_address":""},"score":371210,"extra":""}]}]},{"had_liked":false,"id":71690,"user_name":"阿杜","can_delete":false,"product_type":"c1","uid":1066705,"ip_address":"","ucode":"349D3572F5ABE7","user_header":"https://static001.geekbang.org/account/avatar/00/10/46/d1/a1ddf49f.jpg","comment_is_top":false,"comment_ctime":1551414500,"is_pvip":false,"replies":[{"id":"25843","content":"👍，找到正主了😆","user_name":"作者回复","comment_id":71690,"uid":"1264162","ip_address":"","utype":1,"ctime":1551425545,"user_name_real":"林晓斌"}],"discussion_count":3,"race_medal":0,"score":"83155793124","product_id":100020801,"comment_content":"我以前负责的一个系统就出现过这种情况，突然有个表的sql执行很慢，后来觉得是此表增删的数据很多，碎片很多，就执行了optimize table，立马就好了。看来就是老师文中说的，删除和增加都是空洞造成。","like_count":20,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":441278,"discussion_content":"👍，找到正主了😆","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551425545,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2542376,"avatar":"https://static001.geekbang.org/account/avatar/00/26/cb/28/21a8a29e.jpg","nickname":"夏天","note":"","ucode":"5F224DDAC94DFF","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":367580,"discussion_content":"很慢的原因，是因为碎片太多，导致 IO 次数过多。性能过低吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618399809,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1157001,"avatar":"https://static001.geekbang.org/account/avatar/00/11/a7/89/3da58d8b.jpg","nickname":"逗猫","note":"","ucode":"084B3B2409064D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":332051,"discussion_content":"同遇到过。。sql在测试环境很慢，在生产和dev都很ok。执行optimize table立马正常了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1607052935,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":62171,"user_name":"Dylan","can_delete":false,"product_type":"c1","uid":1040236,"ip_address":"","ucode":"58064D0C9F9F5F","user_header":"https://static001.geekbang.org/account/avatar/00/0f/df/6c/5af32271.jpg","comment_is_top":false,"comment_ctime":1547967661,"is_pvip":false,"replies":[{"id":"21989","content":"有爱有恨 😅 加油哈<br><br>这种我觉得可以这样，上网找一个“最佳实践”的建议，但是不要照搬，而是一个个去理解每个参数的意思，以及判断是否适合自己的业务<br><br>这样几次我觉得应该会慢慢有感觉起来","user_name":"作者回复","comment_id":62171,"uid":"1264162","ip_address":"","utype":1,"ctime":1547971379,"user_name_real":"林晓斌"}],"discussion_count":1,"race_medal":0,"score":"53087575213","product_id":100020801,"comment_content":"看了这么多期的文章，感觉这个专栏真的是让我有爱有恨，喜欢的是让我能理解这些SQL语句背后的原理，恨的刚好也是这些原理理解起来很是费劲。<br>有一个问题想请教老师，关于MySQL的这些参数，对于之前没接触过的人来说，很多是不知道的，那我用的时候怎么知道说要设置哪个参赛比较适合呢","like_count":12,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437123,"discussion_content":"有爱有恨 😅 加油哈\n\n这种我觉得可以这样，上网找一个“最佳实践”的建议，但是不要照搬，而是一个个去理解每个参数的意思，以及判断是否适合自己的业务\n\n这样几次我觉得应该会慢慢有感觉起来","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1547971379,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":50271,"user_name":"WL","can_delete":false,"product_type":"c1","uid":1173771,"ip_address":"","ucode":"6277DCD776B87E","user_header":"https://static001.geekbang.org/account/avatar/00/11/e9/0b/1171ac71.jpg","comment_is_top":false,"comment_ctime":1544939742,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"48789579998","product_id":100020801,"comment_content":"把该讲内容总结为几个问题, 大家复习的时候可以先尝试回答这些问题检查自己的掌握程度:<br>\t1.<br> innodb_file_per_table参数是什么意思, 一般如何设置更合理?<br>\t2. <br>删除数据和插入数据为什么会造成出现空间空洞的情况? 原因各是什么?<br>\t3. <br>online DDL在重建表流程上比非online DDL的方式做了哪些流程上的优化?<br>\t4. <br>Online和replace两个概念各是什么, 他们之间有什么样的区别?<br><br>","like_count":12},{"had_liked":false,"id":49628,"user_name":"每天晒白牙","can_delete":false,"product_type":"c1","uid":1004698,"ip_address":"","ucode":"A1B102CD933DEA","user_header":"https://static001.geekbang.org/account/avatar/00/0f/54/9a/76c0af70.jpg","comment_is_top":false,"comment_ctime":1544748281,"is_pvip":false,"replies":[{"id":"17862","content":"不是…<br>我的意思是，数据是放在主键索引的叶子节点的<br><br>“索引也是数据”这个是哲学问题，一切皆数据😄","user_name":"作者回复","comment_id":49628,"uid":"1264162","ip_address":"","utype":1,"ctime":1544749597,"user_name_real":"林晓斌"}],"discussion_count":3,"race_medal":1,"score":"48789388537","product_id":100020801,"comment_content":"针对@undifined的问题3：页分裂发生在索引上还是数据上？老师给的回答是 数据也是索引，老师是不是想表达 索引也是数据呢？","like_count":11,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432692,"discussion_content":"不是…\n我的意思是，数据是放在主键索引的叶子节点的\n\n“索引也是数据”这个是哲学问题，一切皆数据😄","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544749597,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1453053,"avatar":"https://static001.geekbang.org/account/avatar/00/16/2b/fd/7013289d.jpg","nickname":"温故而知新可以为师矣","note":"","ucode":"FADCDFA9F9E5E8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":120762,"discussion_content":"&#34;哲学问题&#34;，戳中笑点。","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1578294269,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":157880,"discussion_content":"表数据其实就是主键索引表。","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1580528816,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":48847,"user_name":"尘封","can_delete":false,"product_type":"c1","uid":1247006,"ip_address":"","ucode":"CEE0C006387A03","user_header":"https://static001.geekbang.org/account/avatar/00/13/07/1e/bdbe93f4.jpg","comment_is_top":false,"comment_ctime":1544571140,"is_pvip":false,"replies":[{"id":"17570","content":"你这个问题放在第16篇问就刚刚好了。<br><br>以前不支持紧凑排序的时候有，现在没啥了差别了，小于256都差不多","user_name":"作者回复","comment_id":48847,"uid":"1264162","ip_address":"","utype":1,"ctime":1544582876,"user_name_real":"林晓斌"}],"discussion_count":2,"race_medal":0,"score":"48789211396","product_id":100020801,"comment_content":"老师，请教一个问题，和本文无关，既然mysql支持了打包数据排序模式，能够更紧凑的分配内存进行排序，那定义表结构的时候，varchar(10)存储hello和varchar(100)存储hello的优势在哪里呢？谢谢","like_count":11,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432384,"discussion_content":"你这个问题放在第16篇问就刚刚好了。\n\n以前不支持紧凑排序的时候有，现在没啥了差别了，小于256都差不多","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544582876,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1834977,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/ff/e1/ea2b6cef.jpg","nickname":"有头发的程序员","note":"","ucode":"48B9B1C5CC4E3A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":305037,"discussion_content":"orderBy 之类的地命令, 系统创建临时表的时候,如果是在内存中创建,会是MEMORY一类的引擎,这时候varchar会变成固定长度,浪费更多内存.","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1599747357,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":99672,"user_name":"是我的海","can_delete":false,"product_type":"c1","uid":1197457,"ip_address":"","ucode":"4BCE240829676A","user_header":"https://static001.geekbang.org/account/avatar/00/12/45/91/afda3094.jpg","comment_is_top":false,"comment_ctime":1559276897,"is_pvip":false,"replies":[{"id":"36696","content":"可以这么想下，如果2 和 6应该属于不同的父亲节点，那父亲节点怎么表示这个page的取值范围？","user_name":"作者回复","comment_id":99672,"uid":"1264162","ip_address":"","utype":1,"ctime":1560003769,"user_name_real":"林晓斌"}],"discussion_count":5,"race_medal":0,"score":"35919015265","product_id":100020801,"comment_content":"二刷中++<br>以下是老师回复一个同学的问题：<br>+++++++++++++++++++++++<br>Mr.Panda<br>很喜欢作者的MySQL，绝对干货哈哈。<br>这里针对空洞提下问题：<br>1.删除有空洞，是因为标记了已删除可复用的节点位置，不会释放。<br>2.随机插入有空洞，是因为数据页分裂造成。<br>3.但更新有空洞，有点费解，我个人理解是更新是结合删除和插入的一个合并操作。删除后产生的空洞，在插入时不是应该就马上被复用了吗，毕竟主键是一致的。所以为什么更新会产生空洞呢？？<br><br>5<br>2019-01-29<br>作者回复: 3. 可以这么想下，如果1，2，3，4，5<br>然后update把2 改成6， 如果原地修改，这个索引就不是“有序”的了<br>+++++++++++++++++++<br>我的问题是：即使是更新主键索引，把2 改成6 了，不是只要修改指针就可以保证有序了么？<br>为什么需要先删除，再插入一条数据 ？ 这里对更新的流程不太熟悉，请老师稍微详细解答下。","like_count":8,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":452215,"discussion_content":"可以这么想下，如果2 和 6应该属于不同的父亲节点，那父亲节点怎么表示这个page的取值范围？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1560003769,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1285652,"avatar":"","nickname":"mycat","note":"","ucode":"6878BD32D042F2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":305737,"discussion_content":"那如果修改某条记录的是，不是修改的主键值，而是把某一个列的值：从A改为B，是不是就是原地修改了？还是也需要标记为删除，然后再次插入一行新的数据？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600072491,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1386818,"avatar":"https://static001.geekbang.org/account/avatar/00/15/29/42/43d4b1a8.jpg","nickname":"烫烫烫","note":"","ucode":"C06018670DE76A","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1285652,"avatar":"","nickname":"mycat","note":"","ucode":"6878BD32D042F2","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":318881,"discussion_content":"也有可能是二级索引","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603873901,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":305737,"ip_address":""},"score":318881,"extra":""}]},{"author":{"id":1285652,"avatar":"","nickname":"mycat","note":"","ucode":"6878BD32D042F2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":305735,"discussion_content":"老师这个回答牛逼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600072068,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1930954,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/76/ca/78f28c5d.jpg","nickname":"阮春图","note":"","ucode":"411EEF7552F344","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":259794,"discussion_content":"老师回答绝妙，这种情况确实需要做页整理","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588817676,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":48930,"user_name":"毛毛","can_delete":false,"product_type":"c1","uid":1249698,"ip_address":"","ucode":"AD520D0011227D","user_header":"https://static001.geekbang.org/account/avatar/00/13/11/a2/33be69a6.jpg","comment_is_top":false,"comment_ctime":1544579179,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"35904317547","product_id":100020801,"comment_content":"可能性有两个。<br>1. 生成临时表过程中，row log中新增的数据较多，导致表的行数变多。<br>2. 生成临时表过程中，row log中有部分插入和删除操作会产生“空洞”。<br>个人感觉，第一种情况，突然多了高于1％的数据，比较少见；但第二种情况，在某些业务中，经常出现。","like_count":9},{"had_liked":false,"id":50584,"user_name":"蚂蚁内推+v","can_delete":false,"product_type":"c1","uid":1050508,"ip_address":"","ucode":"24B10AEE54B3FD","user_header":"https://static001.geekbang.org/account/avatar/00/10/07/8c/0d886dcc.jpg","comment_is_top":false,"comment_ctime":1545012775,"is_pvip":false,"replies":[{"id":"18169","content":"也需要（更需要）","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545015592,"ip_address":"","comment_id":50584,"utype":1}],"discussion_count":1,"race_medal":0,"score":"23019849255","product_id":100020801,"comment_content":"文中说到“答案是不能。因为，tmp_file 也是要占用临时空间的”，意思是tmp_table在server层操作的时候不需要占用临时空间吗？","like_count":5,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433029,"discussion_content":"也需要（更需要）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545015592,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":77569,"user_name":"GLADIATOR","can_delete":false,"product_type":"c1","uid":1448564,"ip_address":"","ucode":"6FE14E0BCD6240","user_header":"https://static001.geekbang.org/account/avatar/00/16/1a/74/8f7f8786.jpg","comment_is_top":false,"comment_ctime":1552963396,"is_pvip":false,"discussion_count":6,"race_medal":0,"score":"18732832580","product_id":100020801,"comment_content":"老师，online DDL有一个问题：因为row log的存在，解决了 DDL过程中的增量dml数据，最后应用日志后，再把temp文件替换表A的文件。但是如果替换的时候，必须等到没有增量数据了吗？如果这个过程中一直有dml，是不是就一直完成不了这个替换操作？","like_count":4,"discussions":[{"author":{"id":1453053,"avatar":"https://static001.geekbang.org/account/avatar/00/16/2b/fd/7013289d.jpg","nickname":"温故而知新可以为师矣","note":"","ucode":"FADCDFA9F9E5E8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":120747,"discussion_content":"还是要短暂上锁，只是比整表copy上锁时间短。","likes_number":6,"is_delete":false,"is_hidden":false,"ctime":1578293103,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1015184,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/7d/90/abb7bfe3.jpg","nickname":"fourge","note":"","ucode":"F3E3FFC4990358","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":582840,"discussion_content":"mdl写锁可以解决这个问题。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659694636,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":371213,"discussion_content":"也就是为什么要在业务低峰期执行DDL","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619685928,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1788647,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/4a/e7/6c16af5d.jpg","nickname":"汉江","note":"","ucode":"01622D984B8F9B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":341855,"discussion_content":"这里会升级成MDL 写锁","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1610537606,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1292330,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/VX0ib4CV0m7fwxB2xFcIJaYYWXXpfxxYbfBErqBej9395hgZszqS3dz9bThCxOuFfJ8Xibx9HbdNmZJwL5m33wIw/132","nickname":"chaoxifuchen","note":"","ucode":"95DCC5C4994F68","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":328929,"discussion_content":"感觉从应用row log到完成替换前需要加一个表锁吧？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606274359,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":157879,"discussion_content":"表中的数据该怎么copy就怎么copy，等copy完后，执行日志文件，将DML的数据再补到新表中。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580528767,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":48908,"user_name":"天王","can_delete":false,"product_type":"c1","uid":1239337,"ip_address":"","ucode":"C074B2F9A5F007","user_header":"https://static001.geekbang.org/account/avatar/00/12/e9/29/629d9bb0.jpg","comment_is_top":false,"comment_ctime":1544577293,"is_pvip":false,"replies":[{"id":"17561","content":"👍🏿<br>","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544581928,"ip_address":"","comment_id":48908,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18724446477","product_id":100020801,"comment_content":" delete删除表数据，只是打上一个可复用标记，如果是数据页上一部分数据打上标记，如果按照自增主键insert数据，那表空间的数据不会复用，如果是整个数据页的所有数据打上标记，那么可以复用。2个3相临的数据页，如果空洞太多，合并成一个页，另外一个可以标记复用。重建表可以减少空洞，文件大小可以减小，本质上是通过，创建临时文件，将数据在临时文件上，重建一份，重建过程，按照顺序插入，极大减少了黑洞，数据都拷贝到临时文件以后，会有删除原来文件，切换到新文件。文件会减小了。<br><br><br>","like_count":4,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432413,"discussion_content":"👍🏿\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544581928,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":114985,"user_name":"Boh","can_delete":false,"product_type":"c1","uid":1172201,"ip_address":"","ucode":"0CF4CAC992FB4B","user_header":"https://static001.geekbang.org/account/avatar/00/11/e2/e9/d309c895.jpg","comment_is_top":false,"comment_ctime":1563442357,"is_pvip":false,"discussion_count":3,"race_medal":0,"score":"14448344245","product_id":100020801,"comment_content":"老师，有个问题请教下，对于主键自增的表，每次delete后都会产生空洞，这个空洞由于主键递增的关系是不会被复用的，累计一定时间后，会发现空洞占用空间非常大，需要执行alter table t engine = InnoDB<br>收缩下表，对于这种情况的表，有没有什么好的方案让它自动收缩而非等到存储空间告警了再处理","like_count":3,"discussions":[{"author":{"id":2971019,"avatar":"","nickname":"Geek_0b93c0","note":"","ucode":"ACAA7817AD2C61","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576054,"discussion_content":"主键递增和空洞回收不回收没有关系吧 删除后主键不会被减小 但是空白页可以被回收啊  ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655262120,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":157881,"discussion_content":"对于大部分表来说，就不要delete操作了，可以用逻辑删除。因为在业务场景中，所谓删除数据也要尽量保留，不要总是执行物理删除操作。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580528902,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1083422,"avatar":"https://static001.geekbang.org/account/avatar/00/10/88/1e/69e84907.jpg","nickname":"罗罗诺亚.恩佐","note":"","ucode":"42D7932946CEBF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":280690,"discussion_content":"有道理，但是增加，修改一样会产生空洞，所以重建表操作还是要做","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591594122,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":157881,"ip_address":""},"score":280690,"extra":""}]}]},{"had_liked":false,"id":55349,"user_name":"金龟","can_delete":false,"product_type":"c1","uid":1228500,"ip_address":"","ucode":"1C7D35C8AE8D9D","user_header":"https://static001.geekbang.org/account/avatar/00/12/be/d4/ff1c1319.jpg","comment_is_top":false,"comment_ctime":1546141536,"is_pvip":false,"replies":[{"id":"20053","content":"是的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1546169469,"ip_address":"","comment_id":55349,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14431043424","product_id":100020801,"comment_content":"老师，请教个问题，在innodb中是不是b+树的每个节点都是一页，比如最上层的根节点就是一页。下层有5个节点就是5页。","like_count":4,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434748,"discussion_content":"是的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546169469,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49745,"user_name":"undifined","can_delete":false,"product_type":"c1","uid":1068920,"ip_address":"","ucode":"449CB4CD2DC089","user_header":"https://static001.geekbang.org/account/avatar/00/10/4f/78/c3d8ecb0.jpg","comment_is_top":false,"comment_ctime":1544761799,"is_pvip":false,"replies":[{"id":"17919","content":"额，如果考虑同时有并发的插入数据，就可能了。<br><br>我原来说“online可以认为没有”是假设没有并发更新","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544763217,"ip_address":"","comment_id":49745,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14429663687","product_id":100020801,"comment_content":"重建表的时候如果没有数据更新，有没有可能产生页分裂和空洞<br>老师，这个问题结合您和白牙的答案，还是不太明白；<br>我的理解是 页分裂发生在插入数据的时候，空洞产生在删除数据的时候，不论online 还是非 online 没有数据更新的话它不会产生页分裂和空洞；而 online 由于在重建表的过程中会将更新记录在 row log 里，如果这些语句里面有非自增的插入和删除数据，在执行 rowlog 的时候可能会发生空洞；您的答案是 online 可以认为没有；您能再详细说一下吗，谢谢老师","like_count":3,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432756,"discussion_content":"额，如果考虑同时有并发的插入数据，就可能了。\n\n我原来说“online可以认为没有”是假设没有并发更新","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544763217,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49540,"user_name":"悠悠然","can_delete":false,"product_type":"c1","uid":1304939,"ip_address":"","ucode":"16057BF00483B0","user_header":"https://static001.geekbang.org/account/avatar/00/13/e9/6b/05d72c29.jpg","comment_is_top":false,"comment_ctime":1544709440,"is_pvip":false,"replies":[{"id":"17816","content":"缘分啊😄","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544718780,"ip_address":"","comment_id":49540,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14429611328","product_id":100020801,"comment_content":"太巧了吧，刚好最近公司的大表做了拆分删除了大量数据，还在奇怪为什么磁盘空间没变小，刚好老师就讲到了👍👍👍👍👍","like_count":3,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432655,"discussion_content":"缘分啊😄","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544718780,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":307973,"user_name":"大反派","can_delete":false,"product_type":"c1","uid":1117339,"ip_address":"","ucode":"425D85B39D8A61","user_header":"https://static001.geekbang.org/account/avatar/00/11/0c/9b/0835caf1.jpg","comment_is_top":false,"comment_ctime":1629344058,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10219278650","product_id":100020801,"comment_content":"purge不会帮忙物理删除么？","like_count":2},{"had_liked":false,"id":164323,"user_name":"林小胖🐼","can_delete":false,"product_type":"c1","uid":1213142,"ip_address":"","ucode":"FC33F133C53A11","user_header":"https://static001.geekbang.org/account/avatar/00/12/82/d6/4d208c6f.jpg","comment_is_top":false,"comment_ctime":1576936574,"is_pvip":false,"replies":[{"id":"62615","content":"这种一般select里面用的是主键id排序的<br>所以XX表的主键索引是紧凑的了<br><br>不过其他索引还是有哦","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1577077582,"ip_address":"","comment_id":164323,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10166871166","product_id":100020801,"comment_content":"老师问个问题 creat table xx select * from xxx这种还会有空洞的存在吗？","like_count":2,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":478722,"discussion_content":"这种一般select里面用的是主键id排序的\n所以XX表的主键索引是紧凑的了\n\n不过其他索引还是有哦","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577077582,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49475,"user_name":"Leon📷","can_delete":false,"product_type":"c1","uid":1219496,"ip_address":"","ucode":"B9BBD1EFAAE5A2","user_header":"https://static001.geekbang.org/account/avatar/00/12/9b/a8/6a391c66.jpg","comment_is_top":false,"comment_ctime":1544694842,"is_pvip":false,"replies":[{"id":"17804","content":"1. Rebuild 是整个表重建，就是我们文中图4的过程。 no-rebuild是指主键索引不用重建，比如加索引<br><br>2.  Rebuild<br><br>3. Rebuild","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544709330,"ip_address":"","comment_id":49475,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10134629434","product_id":100020801,"comment_content":"老师，我回去查了下inplace的rebuild和no-rebuild<br>rebuild 需要重建表（重新组织记录），比如optimize table、添加索引、添加&#47;删除列、修改列NULL&#47;NOT NULL属性等<br>no-rebuild 需要修改表的元数据，比如删除索引、修改列名不改变数据类型、修改列默认值、修改列自增值 <br>问题一 这二者什么差别，我感觉都差不多，<br>问题二 文章中说的这个表消除空洞较少空间属于哪个<br>问题三 如果没有任何新数据插入，只是压缩原有的表，请问属于哪个<br>","like_count":2,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432630,"discussion_content":"1. Rebuild 是整个表重建，就是我们文中图4的过程。 no-rebuild是指主键索引不用重建，比如加索引\n\n2.  Rebuild\n\n3. Rebuild","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544709330,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49386,"user_name":"明亮","can_delete":false,"product_type":"c1","uid":1303015,"ip_address":"","ucode":"DAFB3424C4C2D7","user_header":"https://static001.geekbang.org/account/avatar/00/13/e1/e7/d1b2e914.jpg","comment_is_top":false,"comment_ctime":1544677683,"is_pvip":false,"replies":[{"id":"17761","content":"你设想一下，索引上三个值3、4、5，现在把4改成6， 如果本地替换是不是顺序不递增了😄","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544679549,"ip_address":"","comment_id":49386,"utype":1}],"discussion_count":2,"race_medal":0,"score":"10134612275","product_id":100020801,"comment_content":"老师你好，insert和delete会造成数据空洞我可以理解，为什么update也会造成空洞呢，update不是应该复用原来的空间才合理吗？","like_count":2,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432602,"discussion_content":"你设想一下，索引上三个值3、4、5，现在把4改成6， 如果本地替换是不是顺序不递增了😄","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544679549,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1518795,"avatar":"","nickname":"Geek_2ac804","note":"","ucode":"EDF69B20030BB8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":554813,"discussion_content":"可以理解为：update=delete+insert","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1646626349,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49376,"user_name":"还一棵树","can_delete":false,"product_type":"c1","uid":1317709,"ip_address":"","ucode":"C187F2A141D60E","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eop9WylZJicLQxlvXukXUgPp39zJHyyReK5s1C9VhA6rric7GiarbfQMuWhdCCDdxdfL610Hc4cNkn9Q/132","comment_is_top":false,"comment_ctime":1544673800,"is_pvip":false,"replies":[{"id":"17751","content":"后面有一章会讲到的，赞认真哦","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544675220,"ip_address":"","comment_id":49376,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10134608392","product_id":100020801,"comment_content":"每一篇+评率 都认真看完，受益不少。  老师啥时间有空了 讲解下double  write，之前的文档里提到过，但是没搞懂。 现在要是有人问我 什么是mysql的 double write 及有啥作用    感觉还回答不上来，求老师指点","like_count":2,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432597,"discussion_content":"后面有一章会讲到的，赞认真哦","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544675220,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49219,"user_name":"skyoo","can_delete":false,"product_type":"c1","uid":1302503,"ip_address":"","ucode":"EBC0528BA02DD7","user_header":"https://static001.geekbang.org/account/avatar/00/13/df/e7/4ce5ed27.jpg","comment_is_top":false,"comment_ctime":1544625278,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"10134559870","product_id":100020801,"comment_content":"在alter table engine =innodb  未完成前,做了DML 操作, 并且是在已经重构完的数据引起的DML操作，产生了空洞. 导致变大 重构未处理的数据 即使产生了 空洞，到100% 后也能清理碎片空间.<br><br>truncate table  里面的 数据 不产生 binlog,无法恢复， 如果速度上面来讲 还是drop table 更快.  但对于 超大的table 做drop， truncate 时候也是很危险了，容易整个数据库 hang 住，因为要对 buffer pool 中对应的页面清除, 可以对ibd 文件做 ln 操作生成 ibd.hdlk  然后 rm -f  ibd 最后 drop table 会很快<br><br>对经常delete 数据的表 用以前讲的 循环删除 方法，来删除 也是 不错的. 当然要根据情况做 碎片整理","like_count":2,"discussions":[{"author":{"id":1285652,"avatar":"","nickname":"mycat","note":"","ucode":"6878BD32D042F2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":305739,"discussion_content":"请问，rm命令删除的时候是删除的innodb的数据文件吗？如果删除之后，再次在innodb中删除表drop table的时候，命令还能执行成功吗？MySQL中应该不能识别软连接的数据文件吧？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600073079,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49064,"user_name":"帆帆帆帆帆帆帆帆","can_delete":false,"product_type":"c1","uid":1304645,"ip_address":"","ucode":"0CB732FFD07463","user_header":"https://static001.geekbang.org/account/avatar/00/13/e8/45/c58cb283.jpg","comment_is_top":false,"comment_ctime":1544596968,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10134531560","product_id":100020801,"comment_content":"执行完成后，空间不仅没变小，还稍微大了一点儿。比较常见的情况是表上只有insert，没有update的情况，如一些存放历史操作记录的表。","like_count":2},{"had_liked":false,"id":326365,"user_name":"刘佳奇","can_delete":false,"product_type":"c1","uid":2756889,"ip_address":"","ucode":"857DCD20B70D74","user_header":"https://static001.geekbang.org/account/avatar/00/2a/11/19/5c63bf7f.jpg","comment_is_top":false,"comment_ctime":1639483792,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5934451088","product_id":100020801,"comment_content":"online DDL感觉很像Redis的BGREWRITEAOF命令啊，也是边复制边记录最新的写操作，最后再合并到一起。","like_count":1},{"had_liked":false,"id":278054,"user_name":"Long","can_delete":false,"product_type":"c1","uid":1318970,"ip_address":"","ucode":"2417242560360A","user_header":"https://static001.geekbang.org/account/avatar/00/14/20/3a/90db6a24.jpg","comment_is_top":false,"comment_ctime":1612742034,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5907709330","product_id":100020801,"comment_content":"二刷第9天：温故知新<br><br>\t1. DDL如果是online的一定是inplace的，但是如果是inplace不一定是onlne的，比如fulltext index，8.0的spatial index，还有修改字段类型（非扩充）。<br>\t2. （1）alter table table1 engine = INNODB;这个是重建表，（2）analyze table table1.这个不是重建表，只是做索引信息重新统计。没有修改数据，过程加了MDL读锁。（3）optimize table table1 = recreate+analyze。<br>\t3. 如果想要释放主键索引树的空洞，可以recate或者optimize table<br>\t4. 如果是需要alter table不管是online还是inpalce，都需要考虑创建过程中的临时表，需要占用很大的空间。","like_count":1},{"had_liked":false,"id":209762,"user_name":"ξ！","can_delete":false,"product_type":"c1","uid":1636657,"ip_address":"","ucode":"F9797D21EBE10E","user_header":"https://static001.geekbang.org/account/avatar/00/18/f9/31/b75cc6d5.jpg","comment_is_top":false,"comment_ctime":1587609910,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5882577206","product_id":100020801,"comment_content":"老师我用你的10万数据的表执行了delete命令之后立马查发现是不会释放表空间，然后过一会查发现表空间就被释放了，是因为什么呢","like_count":1},{"had_liked":false,"id":198833,"user_name":"Ryan","can_delete":false,"product_type":"c1","uid":1667987,"ip_address":"","ucode":"95BBBEE5B23878","user_header":"https://static001.geekbang.org/account/avatar/00/19/73/93/0a3a1e5b.jpg","comment_is_top":false,"comment_ctime":1585469989,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5880437285","product_id":100020801,"comment_content":"实际工作中不太可能会经常性的整理空洞 只有磁盘空间过大时才会在业务低峰期做这些操作","like_count":1},{"had_liked":false,"id":178318,"user_name":"Geek_f288d9","can_delete":false,"product_type":"c1","uid":1859598,"ip_address":"","ucode":"AB7D30915D5FD8","user_header":"","comment_is_top":false,"comment_ctime":1581660919,"is_pvip":false,"replies":[{"id":"69165","content":"后面再插入数据，可以复用这个空间","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1581668086,"ip_address":"","comment_id":178318,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5876628215","product_id":100020801,"comment_content":"请问我delete删除的数据，就永远不会释放吗？","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":483752,"discussion_content":"后面再插入数据，可以复用这个空间","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581668086,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2287841,"avatar":"https://static001.geekbang.org/account/avatar/00/22/e8/e1/6045b299.jpg","nickname":"LPF","note":"","ucode":"036C552D7251E9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":327530,"discussion_content":"drop table会删除表数据释放空间，因为删除的是数据文件。\ndelete不会释放数据，除非你重建表。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605857827,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":133048,"user_name":"insist","can_delete":false,"product_type":"c1","uid":1054536,"ip_address":"","ucode":"1EE2800A900BA7","user_header":"https://static001.geekbang.org/account/avatar/00/10/17/48/3ab39c86.jpg","comment_is_top":false,"comment_ctime":1568336817,"is_pvip":false,"discussion_count":7,"race_medal":0,"score":"5863304113","product_id":100020801,"comment_content":"老师，咨询一个问题，我生产服务器有一个表有千万条数据，如果需要加一个普通索引，非全文索引，会导致对这个表的增删该查都阻塞吗？（mysql版本5.7）","like_count":1,"discussions":[{"author":{"id":1789588,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/4e/94/af3eb6d4.jpg","nickname":"面试怪圈","note":"","ucode":"C9C4B9B2F699C6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":195780,"discussion_content":"会有一瞬间加锁,但是很快,我测试了1k万数据,加字段加索引,期间CURD都正常不阻塞,但需要考虑,从库的数据延迟问题","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1583307259,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1049017,"avatar":"https://static001.geekbang.org/account/avatar/00/10/01/b9/73435279.jpg","nickname":"学习学个屁","note":"","ucode":"DF2D61E6FB2FCE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":406815,"discussion_content":"会锁表一瞬间时间，建议在业务低峰期，如果主从，建议关闭binlog 从库 先搞 然后主库搞","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634831240,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1453053,"avatar":"https://static001.geekbang.org/account/avatar/00/16/2b/fd/7013289d.jpg","nickname":"温故而知新可以为师矣","note":"","ucode":"FADCDFA9F9E5E8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":120749,"discussion_content":"(个人理解，仅供参考)add index DDL，会获取MDL写锁，阻塞其它线程所有读写操作。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578293368,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":4,"child_discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1453053,"avatar":"https://static001.geekbang.org/account/avatar/00/16/2b/fd/7013289d.jpg","nickname":"温故而知新可以为师矣","note":"","ucode":"FADCDFA9F9E5E8","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":157885,"discussion_content":"那应该怎么处理呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580529236,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":120749,"ip_address":""},"score":157885,"extra":""},{"author":{"id":1394997,"avatar":"https://static001.geekbang.org/account/avatar/00/15/49/35/4fc7bc20.jpg","nickname":"大鼻子先生","note":"","ucode":"4F9ED4A302B60C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":159672,"discussion_content":"不是用online ddl就行了吧，选择夜间业务低峰期，然后alter table add index xx algorithm=inplace指定online ddl(明确指定是当inplace不适用时也不会降到copy的形式)，此时只有短暂的获取dml写锁那一瞬间阻塞，其他时间是dml读锁则不阻塞","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580723293,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":157885,"ip_address":""},"score":159672,"extra":""},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1394997,"avatar":"https://static001.geekbang.org/account/avatar/00/15/49/35/4fc7bc20.jpg","nickname":"大鼻子先生","note":"","ucode":"4F9ED4A302B60C","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":160311,"discussion_content":"可能差不多","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580785609,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":159672,"ip_address":""},"score":160311,"extra":""}]}]},{"had_liked":false,"id":89189,"user_name":"greatcl","can_delete":false,"product_type":"c1","uid":1009449,"ip_address":"","ucode":"44D3C55394EC08","user_header":"https://static001.geekbang.org/account/avatar/00/0f/67/29/b0ec5430.jpg","comment_is_top":false,"comment_ctime":1556100787,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5851068083","product_id":100020801,"comment_content":"发现MySQL官方有页文档里对innodb_file_per_table的默认值为1的变更版本描述有误：https:&#47;&#47;dev.mysql.com&#47;doc&#47;refman&#47;8.0&#47;en&#47;glossary.html#glos_file_per_table，这里面说的是从5.6.7版本开始默认开启的。<br>而查看5.6.6的changelog是有innodb_file_per_table默认值从0改为1的：https:&#47;&#47;dev.mysql.com&#47;doc&#47;relnotes&#47;mysql&#47;5.6&#47;en&#47;news-5-6-6.html","like_count":1},{"had_liked":false,"id":82414,"user_name":"啦啦啦","can_delete":false,"product_type":"c1","uid":1131687,"ip_address":"","ucode":"6B12EC90A62525","user_header":"https://static001.geekbang.org/account/avatar/00/11/44/a7/171c1e86.jpg","comment_is_top":false,"comment_ctime":1554204938,"is_pvip":false,"replies":[{"id":"30169","content":"你说的“对数据进行了修改和添加”，说的是原表对吧，<br><br>就是row_log继续追加呀，最终都会应用到临时表的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1554626393,"ip_address":"","comment_id":82414,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5849172234","product_id":100020801,"comment_content":"老师，在图4中row_log执行进临时文件中的这个时候，如果对数据进行了修改和添加会怎么办","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":445581,"discussion_content":"你说的“对数据进行了修改和添加”，说的是原表对吧，\n\n就是row_log继续追加呀，最终都会应用到临时表的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1554626393,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2287841,"avatar":"https://static001.geekbang.org/account/avatar/00/22/e8/e1/6045b299.jpg","nickname":"LPF","note":"","ucode":"036C552D7251E9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":327538,"discussion_content":"row_log继续追加写，temp_file写入row_log数据是要加锁的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605858232,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":81293,"user_name":"飛","can_delete":false,"product_type":"c1","uid":1310732,"ip_address":"","ucode":"1D7053E122DC8D","user_header":"https://static001.geekbang.org/account/avatar/00/14/00/0c/cfb3c61b.jpg","comment_is_top":false,"comment_ctime":1553851360,"is_pvip":false,"replies":[{"id":"29653","content":"👍","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1554052319,"ip_address":"","comment_id":81293,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5848818656","product_id":100020801,"comment_content":"看了之前的文章 特地去做了测试。正好有其中一个库 出现了反而增加的情况","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":445142,"discussion_content":"👍","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1554052319,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2287841,"avatar":"https://static001.geekbang.org/account/avatar/00/22/e8/e1/6045b299.jpg","nickname":"LPF","note":"","ucode":"036C552D7251E9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":327539,"discussion_content":"页分裂现象，本来就很紧凑达到95%，分裂后就不怎么紧凑达到90%，数据分到了更多的页，因此容量就大了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605858300,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":80697,"user_name":"Li Yao","can_delete":false,"product_type":"c1","uid":1129838,"ip_address":"","ucode":"703E1E5505F70D","user_header":"https://static001.geekbang.org/account/avatar/00/11/3d/6e/60680aa4.jpg","comment_is_top":false,"comment_ctime":1553699262,"is_pvip":false,"discussion_count":4,"race_medal":0,"score":"5848666558","product_id":100020801,"comment_content":"如果将一个表中的数据全部清空(delete from table)，再将清空前的原始数据重新导入，也同样会达到消除空洞的目的吗？","like_count":1,"discussions":[{"author":{"id":1134574,"avatar":"https://static001.geekbang.org/account/avatar/00/11/4f/ee/bd08cfab.jpg","nickname":"一魄","note":"","ucode":"71541125D4AA5A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":401039,"discussion_content":"文中说了 delete 并不会释放空间，MySQL只是标记记录为可复用。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633529372,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1303322,"avatar":"https://static001.geekbang.org/account/avatar/00/13/e3/1a/061e77b6.jpg","nickname":"亢星东","note":"","ucode":"5E4063E83B2BB9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":318947,"discussion_content":"那要阻塞写操作了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603888692,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":157893,"discussion_content":"那还不如直接drop table，然后再新建表。或者如果你不drop，那就alter一下。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580529408,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1453053,"avatar":"https://static001.geekbang.org/account/avatar/00/16/2b/fd/7013289d.jpg","nickname":"温故而知新可以为师矣","note":"","ucode":"FADCDFA9F9E5E8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":120753,"discussion_content":"如果此时MySQL真的还只是简单标记复用的话，肯定不能（原来的萝卜是哪个坑里的还回到哪个坑里去，之前没萝卜的坑依然没萝卜）。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578293575,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":70068,"user_name":"饭粒","can_delete":false,"product_type":"c1","uid":1153455,"ip_address":"","ucode":"4C3220B0D43997","user_header":"https://static001.geekbang.org/account/avatar/00/11/99/af/d29273e2.jpg","comment_is_top":false,"comment_ctime":1550982461,"is_pvip":false,"replies":[{"id":"24994","content":"1.2 在旧表读的数据<br>3. 不是，更新也是直接更新在旧表<br><br>在没完成之前都是读的旧表，新表是靠row log构建的，完成后，做了新旧表互换，查询才能查到新表的数据","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1550998042,"ip_address":"","comment_id":70068,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5845949757","product_id":100020801,"comment_content":"看的比较晚，请教老师个问题，Online DDL过程中，MDL已经退化成读锁，对表也做了更新操作，但还没完全完成整个过程。这个时候读表数据是怎么读的？还在旧表的数据读旧表？读新插入的数据读临时表？如果读跨越旧表-临时表的范围数据？","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440425,"discussion_content":"1.2 在旧表读的数据\n3. 不是，更新也是直接更新在旧表\n\n在没完成之前都是读的旧表，新表是靠row log构建的，完成后，做了新旧表互换，查询才能查到新表的数据","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550998042,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":53383,"user_name":"三木禾","can_delete":false,"product_type":"c1","uid":1109458,"ip_address":"","ucode":"39C37228236860","user_header":"https://static001.geekbang.org/account/avatar/00/10/ed/d2/e3ae7ddd.jpg","comment_is_top":false,"comment_ctime":1545635891,"is_pvip":false,"replies":[{"id":"19314","content":"申请新页B，把一部分数据从A挪到B，A就空出一些","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545639651,"ip_address":"","comment_id":53383,"utype":1}],"discussion_count":7,"race_medal":0,"score":"5840603187","product_id":100020801,"comment_content":"数据页A满了，随机插入一条数据，不得不申请一个新的数据页，这时候数据页A会留下空洞，我的问题是，既然满了，为什么还有空洞呢？","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434121,"discussion_content":"申请新页B，把一部分数据从A挪到B，A就空出一些","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545639651,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1691516,"avatar":"https://static001.geekbang.org/account/avatar/00/19/cf/7c/2e99d0ad.jpg","nickname":"一新","note":"","ucode":"1915C6C655C31F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":270774,"discussion_content":"A 有 1 2 5 已满 插入 4 就要  4 5 到B","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590052247,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1061991,"avatar":"https://static001.geekbang.org/account/avatar/00/10/34/67/06a7f9be.jpg","nickname":"while (1)等;","note":"","ucode":"BAEC7258D65B69","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":234196,"discussion_content":"为什么要把A的部分移到B","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586960553,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1083422,"avatar":"https://static001.geekbang.org/account/avatar/00/10/88/1e/69e84907.jpg","nickname":"罗罗诺亚.恩佐","note":"","ucode":"42D7932946CEBF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1061991,"avatar":"https://static001.geekbang.org/account/avatar/00/10/34/67/06a7f9be.jpg","nickname":"while (1)等;","note":"","ucode":"BAEC7258D65B69","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":280694,"discussion_content":"因为索引是要保证顺序性的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591595117,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":234196,"ip_address":""},"score":280694,"extra":""}]},{"author":{"id":1061991,"avatar":"https://static001.geekbang.org/account/avatar/00/10/34/67/06a7f9be.jpg","nickname":"while (1)等;","note":"","ucode":"BAEC7258D65B69","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":231213,"discussion_content":"为什么要把A的一部分移到B呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586789153,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1055560,"avatar":"https://static001.geekbang.org/account/avatar/00/10/1b/48/c7446814.jpg","nickname":"阿斯顿马丁-飞","note":"","ucode":"11F0C92DEA713B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1061991,"avatar":"https://static001.geekbang.org/account/avatar/00/10/34/67/06a7f9be.jpg","nickname":"while (1)等;","note":"","ucode":"BAEC7258D65B69","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":328958,"discussion_content":"首先b+tree页分裂有优化，如果插入数据时发现当前页已满（默认50%），才触发页分裂，目的是保证前一页利用率到100%，减少页分裂次数，但是这次优化是不全面的，会有问题，于是就有了再次优化，也就是把前一页的部分数据拿到新页上，这篇文章里有说明，https://www.cnblogs.com/mscm/p/13493129.html","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1606285780,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":231213,"ip_address":""},"score":328958,"extra":""},{"author":{"id":2112092,"avatar":"https://static001.geekbang.org/account/avatar/00/20/3a/5c/60fdf8e2.jpg","nickname":"wtdd","note":"","ucode":"26C64BF9CCA061","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1061991,"avatar":"https://static001.geekbang.org/account/avatar/00/10/34/67/06a7f9be.jpg","nickname":"while (1)等;","note":"","ucode":"BAEC7258D65B69","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":392005,"discussion_content":"兄弟去了解一下b+树，这是基本的树上面的操作哦~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630762372,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":231213,"ip_address":""},"score":392005,"extra":""}]}]},{"had_liked":false,"id":49876,"user_name":"xmasye","can_delete":false,"product_type":"c1","uid":1067119,"ip_address":"","ucode":"7AB897FE157604","user_header":"https://static001.geekbang.org/account/avatar/00/10/48/6f/cdf34b6b.jpg","comment_is_top":false,"comment_ctime":1544783552,"is_pvip":false,"replies":[{"id":"18019","content":"不是，重建表过程中，在原表上的更新都要记row log","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544875683,"ip_address":"","comment_id":49876,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5839750848","product_id":100020801,"comment_content":"老师，重建表（online）的时候，flush才会写到row log，如果只是写入到redo-log就不会写到row log。简而言之就是，更新到磁盘的数据页才会写row log，对吗？","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432794,"discussion_content":"不是，重建表过程中，在原表上的更新都要记row log","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544875683,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49209,"user_name":"Inon","can_delete":false,"product_type":"c1","uid":1014967,"ip_address":"","ucode":"F547915362A5DE","user_header":"https://static001.geekbang.org/account/avatar/00/0f/7c/b7/3b3cbc38.jpg","comment_is_top":false,"comment_ctime":1544623219,"is_pvip":false,"replies":[{"id":"17652","content":"其实是一行行直接读出来发给客户端","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544634420,"ip_address":"","comment_id":49209,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5839590515","product_id":100020801,"comment_content":"每天晚上才有空留言，还是想问下老师上次问的问题。远程JDBC执行查询的时候，mysql是会把数据都查出来放在某块内存，还是会生成带游标的数据结构索引到所有的查询结果记录？","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432530,"discussion_content":"其实是一行行直接读出来发给客户端","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544634420,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49204,"user_name":"发条橙子 。","can_delete":false,"product_type":"c1","uid":1259218,"ip_address":"","ucode":"ED076F4534FFED","user_header":"https://static001.geekbang.org/account/avatar/00/13/36/d2/c7357723.jpg","comment_is_top":false,"comment_ctime":1544621767,"is_pvip":false,"replies":[{"id":"17649","content":"1. 你是不是在5.7验证的，5.7改行为了。不过你确认下，S1 提交后S2就能过了； 之前文章例子是5.6<br><br>2. 是的<br><br>3. 如果可以全表删除，超过10万行的表，是推荐truncate的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544634360,"ip_address":"","comment_id":49204,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5839589063","product_id":100020801,"comment_content":"1.  老师说到， alter table a engine=innodb 来更新表， 5.6后的 Online DDL 会在 alter 申请 mdl 写锁的时候锁一下表，但是马上会变成读锁，以免阻塞后面的查询等操作 ，这块我不太理解。 <br>问题：<br>    这里是所有的 alter （比如增删字段、增删索引）都会先申请 mdl写锁 ，拷贝数据时会转为 mdl读锁 。还是只是 alter table a engine=innodb 重建表这个语句这样 ？<br><br>    我自己本地测试显示启了三个事物 。 先后顺序为 S1 查询表 、S2增加表字段 、S3查询表 。 发现 S2 会一直等到 S1 和 S3 事务提交后才会执行增加字段操作 。这和前面表锁提到的 S3会等待 S2释放写锁后申请读锁 现象不一致 ，这个是什么原因 ？？ <br><br>    将第2个事物语句换成 alter table a engine=innodb 重建表语句重复上面操作 ， 也是 S2 等待 S1 和 S3提交后才获取的写锁 。这样的话 S2重建表语句都要等到他之后所有的增删改查事物提交后才能执行拷贝数据的逻辑，这个时候再有事务进来，要等到写锁换成读锁，后面的语句才能执行 是这个样子的么 ？？<br><br>2.alter table a engine=innodb 同步表时 ，是不是连带索引页也一同重建了<br><br>3.trucate 和 drop 删除数据的话，又会和 delete 有什么区别呢 。正好有个需求 ，数据组那边要对业务表回流进行改造，两种模式，truncate和delete，需要我们评估下各业务表的影响 。用truncate会减少表空间带来比delete更好的优势么 。","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432527,"discussion_content":"1. 你是不是在5.7验证的，5.7改行为了。不过你确认下，S1 提交后S2就能过了； 之前文章例子是5.6\n\n2. 是的\n\n3. 如果可以全表删除，超过10万行的表，是推荐truncate的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544634360,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49153,"user_name":"yy","can_delete":false,"product_type":"c1","uid":1307788,"ip_address":"","ucode":"4F6E10E2D1FE8C","user_header":"","comment_is_top":false,"comment_ctime":1544611997,"is_pvip":false,"replies":[{"id":"17637","content":"是都会占的，一个是表一个是文件","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544617000,"ip_address":"","comment_id":49153,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5839579293","product_id":100020801,"comment_content":"老师好 图3临时表和图4临时文件都会占用存储空间吧？临时表和临时文件的区别就是一个是表结构一个是文件吧？","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432503,"discussion_content":"是都会占的，一个是表一个是文件","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544617000,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49102,"user_name":"Richard","can_delete":false,"product_type":"c1","uid":1005235,"ip_address":"","ucode":"165E48039ED8BE","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLRXbu511COICQXDgKDXg9Ok0wwPfte5ZibiasCBwuyE9ZzicazoFsbFZWFykQBohiaXPbyw44LjlBIxA/132","comment_is_top":false,"comment_ctime":1544604727,"is_pvip":true,"replies":[{"id":"17639","content":"如果binlog 开了，而且是row格式就很方便,<br><br><br>最好有备份，兜底就都不怕","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544617600,"ip_address":"","comment_id":49102,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5839572023","product_id":100020801,"comment_content":"老师，请问一下，如果已经用了delete还有救么","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432484,"discussion_content":"如果binlog 开了，而且是row格式就很方便,\n\n\n最好有备份，兜底就都不怕","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544617600,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49042,"user_name":"everyok22","can_delete":false,"product_type":"c1","uid":1213878,"ip_address":"","ucode":"3A3304CCDC5C5C","user_header":"","comment_is_top":false,"comment_ctime":1544593873,"is_pvip":false,"replies":[{"id":"17622","content":"略少一丢丢，不会你还是得按照2T去准备磁盘空间","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544608777,"ip_address":"","comment_id":49042,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5839561169","product_id":100020801,"comment_content":"老师：如果我现在有1T的数据，现在要重建表，如果是copy的话， 是不是大概要2T的空间，如果是inplace呢， 这个空间大小会是多少。","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432464,"discussion_content":"略少一丢丢，不会你还是得按照2T去准备磁盘空间","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544608777,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":48890,"user_name":"Stalary","can_delete":false,"product_type":"c1","uid":1101749,"ip_address":"","ucode":"F69AFF7C958D31","user_header":"https://static001.geekbang.org/account/avatar/00/10/cf/b5/d1ec6a7d.jpg","comment_is_top":false,"comment_ctime":1544576265,"is_pvip":false,"replies":[{"id":"17564","content":"会，操作需谨慎","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544582211,"ip_address":"","comment_id":48890,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5839543561","product_id":100020801,"comment_content":"我清空数据一般用的truncate，请问这样会回收空间吗？","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432405,"discussion_content":"会，操作需谨慎","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544582211,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":48877,"user_name":"天王","can_delete":false,"product_type":"c1","uid":1239337,"ip_address":"","ucode":"C074B2F9A5F007","user_header":"https://static001.geekbang.org/account/avatar/00/12/e9/29/629d9bb0.jpg","comment_is_top":false,"comment_ctime":1544575499,"is_pvip":false,"replies":[{"id":"17565","content":"1. 系统表空间里面有数据字典、undo log(默认）等等， 表数据都不建议放在系统表空间，就是说都建议用innodb_file_per_table<br><br>2. 其实是得看数据页总体利用率，等我组织一下怎么说哈😄","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544582522,"ip_address":"","comment_id":48877,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5839542795","product_id":100020801,"comment_content":"请教几个问题1 系统表空间做什么用的，表数据哪些适合放在系统表空间，哪些适合放在文件，是不是绝大多数表都放在表空间？ 2 怎么来计算和评估需要重建表？","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432400,"discussion_content":"1. 系统表空间里面有数据字典、undo log(默认）等等， 表数据都不建议放在系统表空间，就是说都建议用innodb_file_per_table\n\n2. 其实是得看数据页总体利用率，等我组织一下怎么说哈😄","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544582522,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":353994,"user_name":"Geek_ca6711","can_delete":false,"product_type":"c1","uid":1501061,"ip_address":"广东","ucode":"FE8C67DDA26BF1","user_header":"","comment_is_top":false,"comment_ctime":1660002731,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1660002731","product_id":100020801,"comment_content":"如何判断一个表是否有空洞产生呢？","like_count":0},{"had_liked":false,"id":348624,"user_name":"Geek_0b93c0","can_delete":false,"product_type":"c1","uid":2971019,"ip_address":"","ucode":"ACAA7817AD2C61","user_header":"","comment_is_top":false,"comment_ctime":1655261886,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1655261886","product_id":100020801,"comment_content":"为什么我新建10w条数据，删除10w条数据，再重建索引，idb的大小也没有变啊","like_count":0},{"had_liked":false,"id":341971,"user_name":"再见理想","can_delete":false,"product_type":"c1","uid":1245999,"ip_address":"","ucode":"FAC88B3F6F6DFD","user_header":"https://static001.geekbang.org/account/avatar/00/13/03/2f/0a5e0751.jpg","comment_is_top":false,"comment_ctime":1649936295,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1649936295","product_id":100020801,"comment_content":"innodb_fiile_per_table参数控制表数据存储在一个单独文件还是系统的共享空间，建议设置为ON，每个表用一个独立文件，这样数据更好管理。<br>为什么删除数据后，表空间没有变小呢？因为用delete语句删除数据时，innodb会将记录设置为可复用，并不会清理记录，带该位置有新的数据插入时，可以直接服用这个位置。如果将整个数据页上的数据都删除，则这个数据页会被标记为可复用。当相邻数据页利用率都较低时，innodb会将数据移动到一数据页上，另一个数据页标记为可复用（页合并），插入数据时，如果造成页分裂，也会产生数据空洞，<br>数据的更新相当于 删除一条数据并插入一条数据。 删除的数据也被标记为可复用。<br>如何解决磁盘空洞的问题？ 重建表。<br>1，alter table t engine=innodb   重建表<br>2, analyze  table t  重新统计索引<br>3，optimize table t 1+2的结合","like_count":0},{"had_liked":false,"id":336654,"user_name":"cake","can_delete":false,"product_type":"c1","uid":1966533,"ip_address":"","ucode":"55A7FC6CC1204C","user_header":"https://static001.geekbang.org/account/avatar/00/1e/01/c5/b48d25da.jpg","comment_is_top":false,"comment_ctime":1646276679,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1646276679","product_id":100020801,"comment_content":"老师请问下，Online添加字段，OnlineDDL还没完成，会不会导致插入数据失败呢(插入的数据有新的字段)，或者说(插入数据没有DDL之后的字段，导致失败)","like_count":0},{"had_liked":false,"id":336493,"user_name":"gitxuzan","can_delete":false,"product_type":"c1","uid":1081566,"ip_address":"","ucode":"B0E20F892DA716","user_header":"https://static001.geekbang.org/account/avatar/00/10/80/de/c6191045.jpg","comment_is_top":false,"comment_ctime":1646188084,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1646188084","product_id":100020801,"comment_content":"我想问下，表数据删除很多，空间没回收，对数据库有什么影响，影响增删改查性能？","like_count":0},{"had_liked":false,"id":336231,"user_name":"刘章","can_delete":false,"product_type":"c1","uid":1009693,"ip_address":"","ucode":"7608C518D49AE4","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJLxEbhSEziblPNVkr9XFIAzPCib0TQvBxHYwiaKiaib7ExZ8dmUWyqWoibSedACTHCf52INMib80ic92G6wQ/132","comment_is_top":false,"comment_ctime":1646018341,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1646018341","product_id":100020801,"comment_content":"100 ~200 万数据， 数据库版本 5.6.16 生成环境可以执行  alter table A engine=InnoDB， 怕搞崩了","like_count":0},{"had_liked":false,"id":334201,"user_name":"阿卷","can_delete":false,"product_type":"c1","uid":2678376,"ip_address":"","ucode":"E9B433370B1772","user_header":"https://static001.geekbang.org/account/avatar/00/28/de/68/27ea710e.jpg","comment_is_top":false,"comment_ctime":1644808484,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1644808484","product_id":100020801,"comment_content":"3年过去了，不知道还有没有人再看。提个疑问，记录的复用，只限于符合范围条件的数据对于这段的描述和其他资料上有所差别，页面的Page Header中有一个PAGE_FREE指向垃圾链表的头节点，每当有已删除记录就会被加入到垃圾链表（先标记delete_mask，事务提交后由后台线程完成）。<br>之后每当新插入记录时，首先判断PAGE_FREE指向的头节点代表的已删除记录占用的存储空间是否足够容纳这条新插入的记录，如果不可以容纳，就直接向页面中申请新的空间来存储这条记录（不会尝试遍历整个垃圾链表），如果可以容纳，那么直接重用这条已删除记录的存储空间，并且把PAGE_FREE指向垃圾链表中的下一条已删除记录。如果新插入的那条记录占用的存储空间大小小于垃圾链表的头节点占用的存储空间大小，就会才生碎片空间。这些碎片空间占用的存储空间大小会被统计到PAGE_GARBAGE属性中，当页面快满时，如果再插入一条记录，此时页面中并不能分配一条完整记录的空间，这时候会首先看一看PAGE_GARBAGE的空间和剩余可利用的空间加起来是不是可以容纳下这条记录，如果可以的话，InnoDB会尝试重新组织页内的记录（先开辟一个临时页面，把页面内的记录依次插入一遍，之后再把临时页面的内容复制到本页面），这样就可以把那些碎片空间都解放出来。从这个描述中看，复用是没有范围约束的。","like_count":0},{"had_liked":false,"id":331362,"user_name":"阿斗","can_delete":false,"product_type":"c1","uid":2324137,"ip_address":"","ucode":"B8DAD5ADEEF122","user_header":"https://static001.geekbang.org/account/avatar/00/23/76/a9/2a104be3.jpg","comment_is_top":false,"comment_ctime":1642562293,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1642562293","product_id":100020801,"comment_content":"老师，利用第10章的t表和存储过程，却产生了将近3M的data free,使用重建表后data free依然存在，为什么会产生这种情况呢？","like_count":0},{"had_liked":false,"id":326298,"user_name":"山渐青","can_delete":false,"product_type":"c1","uid":2631809,"ip_address":"","ucode":"1C9753865EBD6C","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/pBwb5icFhsRZCumouaCqOIERPPFEOSOYQiaRBNQmMX4icYb4wz0HbibPt57Mj2qHLAo3fZF0Tvj4dL7EWThL2pA9yg/132","comment_is_top":false,"comment_ctime":1639463397,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1639463397","product_id":100020801,"comment_content":"请问老师，purge操作会将delete mark 的数据物理层面上从磁盘上清除么","like_count":0},{"had_liked":false,"id":324238,"user_name":"kyle","can_delete":false,"product_type":"c1","uid":1213128,"ip_address":"","ucode":"55EF7FC99C0BF7","user_header":"https://static001.geekbang.org/account/avatar/00/12/82/c8/6924e551.jpg","comment_is_top":false,"comment_ctime":1638346615,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1638346615","product_id":100020801,"comment_content":"“磁盘压力很小，但是数据库出现间歇性的性能下跌。”想问下老师，这里的磁盘压力，数据库性能下降这些指标是如何获取的？","like_count":0},{"had_liked":false,"id":317529,"user_name":"Geek_7de5c5","can_delete":false,"product_type":"c1","uid":2816189,"ip_address":"","ucode":"8226F480278EF1","user_header":"","comment_is_top":false,"comment_ctime":1634826939,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1634826939","product_id":100020801,"comment_content":"我觉得思考题的另外一种可能性，但是好像站不住脚：<br><br>就是文件中有很多很多的空洞，但是文件时存放在系统共享表空间中的。重建不会影响表空间的释放。<br>但是说有很多的空洞的话，数据页会发生合并。<br>文中的context时1.0T变成1.01TB，只额外增加了0.01T，也就意味着重建的新表不会有那么小.<br><br>如果时从1.0T变成1.2T，上述的情况有没有可能发生？","like_count":0},{"had_liked":false,"id":314066,"user_name":"GeekWL","can_delete":false,"product_type":"c1","uid":1716943,"ip_address":"","ucode":"7A957139D4AF73","user_header":"https://static001.geekbang.org/account/avatar/00/1a/32/cf/4158e3be.jpg","comment_is_top":false,"comment_ctime":1632823367,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1632823367","product_id":100020801,"comment_content":"1、drop table table_name 立刻释放磁盘空间 ，不管是 Innodb和MyISAM<br><br>2、truncate table table_name 立刻释放磁盘空间 ，不管是 Innodb和MyISAM 。truncate table其实有点类似于drop table 然后create。只不过这个create table 的过程做了优化，比如表结构文件之前已经有了等等，就不需要重新再搞一把。所以速度上应该是接近drop table的速度。<br><br>3、对于delete from table_name :删除表的全部数据<br><br>对于MyISAM 会立刻释放磁盘空间 (应该是做了特别处理，也比较合理)<br><br>InnoDB 不会释放磁盘空间<br><br>4、对于delete from table_name where xxx带条件的删除，不管是innodb还是MyISAM都不会释放磁盘空间。<br><br>5、delete操作以后 使用optimize table table_name 会立刻释放磁盘空间。不管是innodb还是myisam。所以要想达到清理数据的目的，请delete以后执行optimize table 操作。<br><br>6、delete from表以后虽然未释放磁盘空间，但是下次插入数据的时候，仍然可以使用这部分空间。<br>","like_count":0,"discussions":[{"author":{"id":1134574,"avatar":"https://static001.geekbang.org/account/avatar/00/11/4f/ee/bd08cfab.jpg","nickname":"一魄","note":"","ucode":"71541125D4AA5A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":401040,"discussion_content":"乱七八糟总结的都不是本质原因，还可以再归纳，文中有答案","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633529479,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":313089,"user_name":"哈喽","can_delete":false,"product_type":"c1","uid":2745834,"ip_address":"","ucode":"A2DDAA7A55A635","user_header":"https://static001.geekbang.org/account/avatar/00/29/e5/ea/9627bec5.jpg","comment_is_top":false,"comment_ctime":1632275254,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1632275254","product_id":100020801,"comment_content":"老师，请问一下我遇到的一个生产问题，我需要修改一个表的字段的字符集，具体语句是：alter table xxx modify column content text character set utf8mb4;  这个表比较大，执行的时候改语句的state是copy to tmp table，其他关于这个表的增删改语句都是waiting for table metadata lock，这个修改字段字符集的语句是不是不是online的？要怎么实现在线做呢？","like_count":0},{"had_liked":false,"id":312556,"user_name":"逍遥","can_delete":false,"product_type":"c1","uid":2063647,"ip_address":"","ucode":"8EEB4332ED03B0","user_header":"https://static001.geekbang.org/account/avatar/00/1f/7d/1f/12b13da0.jpg","comment_is_top":false,"comment_ctime":1631863523,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1631863523","product_id":100020801,"comment_content":"老师你好  问下 alter table t engine=InnoDB，这个命令在主库执行，从库会执行相同的命令吗？","like_count":0,"discussions":[{"author":{"id":1081566,"avatar":"https://static001.geekbang.org/account/avatar/00/10/80/de/c6191045.jpg","nickname":"gitxuzan","note":"","ucode":"B0E20F892DA716","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":554020,"discussion_content":"同问","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1646188351,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":310117,"user_name":"宙斯","can_delete":false,"product_type":"c1","uid":2041396,"ip_address":"","ucode":"80DF36BAD298AD","user_header":"https://static001.geekbang.org/account/avatar/00/1f/26/34/891dd45b.jpg","comment_is_top":false,"comment_ctime":1630489597,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1630489597","product_id":100020801,"comment_content":"问题：<br>假设现在有人碰到了一个“想要收缩表空间，结果适得其反”的情况，看上去是这样的：<br>1 一个表 t 文件大小为 1TB；<br>2 对这个表执行 alter table t engine=InnoDB；<br>3 发现执行完成后，空间不仅没变小，还稍微大了一点儿，比如变成了 1.01TB。<br><br>回答：1 Online过程中，重新写入了较多的数据。<br>        2 主键索引是非递增，构建时页分裂严重（浪费大量的空间）。","like_count":0},{"had_liked":false,"id":309449,"user_name":"UUID","can_delete":false,"product_type":"c1","uid":1897273,"ip_address":"","ucode":"40772B1A094456","user_header":"https://static001.geekbang.org/account/avatar/00/1c/f3/39/223a741b.jpg","comment_is_top":false,"comment_ctime":1630141144,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1630141144","product_id":100020801,"comment_content":"老师好，作为业务方研发发现以下问题：<br><br>数据库信息：腾讯云数据库，版本是 cdb 5.7，InnoDB存储引擎<br>表信息：有唯一联合索引<br>异常现象：表清理之后，准备收缩碎片时，大量唯一键冲突，1min&#47;5k条，引起线上告警，对业务无影响<br><br>在pt-osc的过程中，业务写入db和触发器是在同一个事物中，同时，由于pt-osc会给update建立一个replace into的触发器，所以，如果update修改一个已经copy到新表的列的主键，则这个行还会保留在新表，导致后面insert报Duplicate entry<br><br>以上原则只是针对update，但是本表无update操作，只是insert，也引起了Duplicate entry<br><br>最后只能用逻辑备份把表碎片清理掉，没敢再在执行一次pt-osc，估计还会报错<br><br>老师有什么见解嘛。","like_count":0},{"had_liked":false,"id":308920,"user_name":"Geek_28b2f6","can_delete":false,"product_type":"c1","uid":1763192,"ip_address":"","ucode":"95319FC32851F6","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/72M4Btn4p1PfuEdqMH1dVribpv1VlqbQibrEALGic88qN8anrvCyUGJibxicB0Yg6pRavay8a6F8ibgRu5ib4Q5OrmC9Q/132","comment_is_top":false,"comment_ctime":1629861050,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1629861050","product_id":100020801,"comment_content":"频繁随机delete资源消耗很大，delete只是做标记而已，为啥会有很大的资源消耗","like_count":0},{"had_liked":false,"id":308697,"user_name":"张三","can_delete":false,"product_type":"c1","uid":1004092,"ip_address":"","ucode":"1155528FAE1546","user_header":"https://static001.geekbang.org/account/avatar/00/0f/52/3c/d6fcb93a.jpg","comment_is_top":false,"comment_ctime":1629761147,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1629761147","product_id":100020801,"comment_content":"change buffer 只有用普通索引的时候才用吗？没有索引条件的改动能不能用到？","like_count":0},{"had_liked":false,"id":307836,"user_name":"Jack Xin","can_delete":false,"product_type":"c1","uid":1425444,"ip_address":"","ucode":"BEC98A1F437239","user_header":"https://static001.geekbang.org/account/avatar/00/15/c0/24/01699070.jpg","comment_is_top":false,"comment_ctime":1629275898,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1629275898","product_id":100020801,"comment_content":"老师，图3和图4的state3感觉是不是画错了，tempfile和表A的顺序搞反了，左边是表A，右边是临时表，不知道是不是我没懂原理没看懂，还请老师指正","like_count":0},{"had_liked":false,"id":306986,"user_name":"李战磊","can_delete":false,"product_type":"c1","uid":1103675,"ip_address":"","ucode":"512ACBE158E99B","user_header":"https://static001.geekbang.org/account/avatar/00/10/d7/3b/66b9fae1.jpg","comment_is_top":false,"comment_ctime":1628818514,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1628818514","product_id":100020801,"comment_content":"redo的脏页指的是什么","like_count":0,"discussions":[{"author":{"id":2420294,"avatar":"https://static001.geekbang.org/account/avatar/00/24/ee/46/7d65ae37.jpg","nickname":"木几丶","note":"","ucode":"FFDB958DA64F8C","race_medal":5,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":392439,"discussion_content":"看上一篇","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631004567,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":304949,"user_name":"Geek_ba2a76","can_delete":false,"product_type":"c1","uid":2705839,"ip_address":"","ucode":"CE4CF0E9670285","user_header":"","comment_is_top":false,"comment_ctime":1627716095,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1627716095","product_id":100020801,"comment_content":"感觉这一章Online 和 inplace的部分 讲的不太好","like_count":0},{"had_liked":false,"id":304551,"user_name":"Geek_ebfcd5","can_delete":false,"product_type":"c1","uid":2715651,"ip_address":"","ucode":"F012FB748EC95D","user_header":"","comment_is_top":false,"comment_ctime":1627476641,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1627476641","product_id":100020801,"comment_content":"有两个问题，1.使用 alter table A engine=InnoDB 命令来重建表。这个主键索引会重新从1开始吗，如果不是还是之前的为什么会变紧凑，中间有跳过一样会分页，如果主键变了那是不是对使用主键做关联的业务就不能这样搞？<br>2.给表添加字段的时候，innodb也是会在存储层创建一个表，然后查询之前表一条条更新给新字段添加默认值吗？如果是online的，那DML操作使用原表索引做查询是不是没有任何影响？<br>希望在坐各位大牛给解答一下","like_count":0},{"had_liked":false,"id":301592,"user_name":"熊猫","can_delete":false,"product_type":"c1","uid":1080238,"ip_address":"","ucode":"23C85117A16BEF","user_header":"https://static001.geekbang.org/account/avatar/00/10/7b/ae/66ae403d.jpg","comment_is_top":false,"comment_ctime":1625753392,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1625753392","product_id":100020801,"comment_content":"老师，整个数据页就可以被复用了。---可以用在其他表（同库或非同库）上吗？","like_count":0},{"had_liked":false,"id":300483,"user_name":"冲冲冲","can_delete":false,"product_type":"c1","uid":2676330,"ip_address":"","ucode":"4DA7596B5AFD51","user_header":"https://static001.geekbang.org/account/avatar/00/28/d6/6a/1d844a27.jpg","comment_is_top":false,"comment_ctime":1625193097,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1625193097","product_id":100020801,"comment_content":"老师，我刚刚开始学习，想问一下为什么加全文索引和空间索引，inplace就不是online的尼，这些索引为啥有的不会影响尼，谢谢","like_count":0},{"had_liked":false,"id":291406,"user_name":"nicholas_66","can_delete":false,"product_type":"c1","uid":1462100,"ip_address":"","ucode":"27367CA1B4805D","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/lnfzMT7DeZBmhc0sdfhnPnXicAk2ZWNHMEibJDDC4AqnUVrd5EdOczCpdAmZZrPtH1dXGG50nEdrEpdfkh4x83cg/132","comment_is_top":false,"comment_ctime":1620273644,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1620273644","product_id":100020801,"comment_content":"optimize table、analyze table 和 alter table 这三种方式 ，在实践中应该都有一定风险的，如何优雅的处理这部分操作呢","like_count":0},{"had_liked":false,"id":290637,"user_name":"lleft","can_delete":false,"product_type":"c1","uid":1970443,"ip_address":"","ucode":"D573EB509455AE","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","comment_is_top":false,"comment_ctime":1619668584,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1619668584","product_id":100020801,"comment_content":"老师，最后的optimize table等于recreate + analyze table，recreate 表，索引的统计信息不会发生变化吗？还需要多一次analyze table？","like_count":0},{"had_liked":false,"id":290454,"user_name":"happy","can_delete":false,"product_type":"c1","uid":1126811,"ip_address":"","ucode":"75111CA8A0AD72","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eobdgTHjeugrHmhLJAhSBu7ibaxmuxJMjzicjAibWAoqwL4JqLP3Gchj7v05gibXG6hZDXqIzdEbDdKxA/132","comment_is_top":false,"comment_ctime":1619573198,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1619573198","product_id":100020801,"comment_content":"我有600万数据，主键自增，我把前300万数据delete删掉，新进来的数据还是自增，那表空间能重复利用吗","like_count":0,"discussions":[{"author":{"id":2166073,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/k3YD3y3BzGDSdrwRJyJY4BXsNJibfM4uzOdDVKIAlFApR2FZCLg2ibrZtJ4vuahA3LHLW9GKzH5CMGqCDhWjhZqg/132","nickname":"戒酒的李白","note":"","ucode":"744E1A22761647","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":402702,"discussion_content":"前300万条数据中， 那些被全部标记为删除的页能复用，在引擎申请新页的时候可以使用。 其它有部分页，部分标记为删除的， 主键索引页不能复用， 其它索引页在update时可以复用。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633934171,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":285805,"user_name":"Geek_962a2c","can_delete":false,"product_type":"c1","uid":2538239,"ip_address":"","ucode":"E941A15DE7C686","user_header":"","comment_is_top":false,"comment_ctime":1617017368,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1617017368","product_id":100020801,"comment_content":"老师，好，<br>图四第5步:用临时文件替换表 A 的数据文件，rowlog 已经应用了，如果这个时候表A有更新操作怎么办，要等待吗？","like_count":0,"discussions":[{"author":{"id":2166073,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/k3YD3y3BzGDSdrwRJyJY4BXsNJibfM4uzOdDVKIAlFApR2FZCLg2ibrZtJ4vuahA3LHLW9GKzH5CMGqCDhWjhZqg/132","nickname":"戒酒的李白","note":"","ucode":"744E1A22761647","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":402703,"discussion_content":"在应用rowlog和交换文件名的时候， 是加的写锁， 此时dml都会阻塞，不会出现你说的这种情况","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633934276,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":281984,"user_name":"柏油","can_delete":false,"product_type":"c1","uid":1604468,"ip_address":"","ucode":"92BFEEEE8BBFA0","user_header":"https://static001.geekbang.org/account/avatar/00/18/7b/74/9b88e040.jpg","comment_is_top":false,"comment_ctime":1615002332,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1615002332","product_id":100020801,"comment_content":"老师，对于Online DDL重新建表过程3, 4 有个疑问<br>“3.生成临时文件的过程中，将所有对 A 的操作记录在一个日志文件（row log）中，对应的是图中 state2 的状态；<br>4.临时文件生成后，将日志文件中的操作应用到临时文件，得到一个逻辑数据上与表 A 相同的数据文件，对应的就是图中 state3 的状态；<br>”<br>这里对A的操作记录仅仅是存在日志文件(row log)中吗，这些DML操作 在后续应用到临时文件的时候也许会失败(比如唯一约束异常、并发修改怎么控制)，既然是online，操作记录在row log之后又如何返回给应该呢<br><br>还请老师指点，谢谢","like_count":0},{"had_liked":false,"id":269334,"user_name":"八戒","can_delete":false,"product_type":"c1","uid":2307327,"ip_address":"","ucode":"900F070F13376F","user_header":"https://static001.geekbang.org/account/avatar/00/23/34/ff/669c576e.jpg","comment_is_top":false,"comment_ctime":1608616514,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1608616514","product_id":100020801,"comment_content":"老师， 我想问一个 问题，相同记录的3个表，存储引擎不一样。第1个使用的是 InnoDb，第2个使用的是 myisam，第3个是 memory。这3个表 占用空间大小的排序 是什么呢？","like_count":0},{"had_liked":false,"id":266853,"user_name":"惘 闻","can_delete":false,"product_type":"c1","uid":1181650,"ip_address":"","ucode":"C5909F034BF072","user_header":"https://static001.geekbang.org/account/avatar/00/12/07/d2/0d7ee298.jpg","comment_is_top":false,"comment_ctime":1607506359,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1607506359","product_id":100020801,"comment_content":"  为什么在插入数据的时候,pageA都满了, 触发了页分裂,申请了新的页pageB,空洞反而生成在pageA的末尾啊,不应该是pageB的数据后面产生了空洞吗?","like_count":0},{"had_liked":false,"id":266774,"user_name":"Geek_0ddc80","can_delete":false,"product_type":"c1","uid":2350585,"ip_address":"","ucode":"57B8C059E6800D","user_header":"","comment_is_top":false,"comment_ctime":1607484066,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1607484066","product_id":100020801,"comment_content":"在进行重新建表过程中，有新的更新语句，把redo_log写满了，需要写入磁盘这种情况怎么办呢","like_count":0},{"had_liked":false,"id":263197,"user_name":"jackiesteed","can_delete":false,"product_type":"c1","uid":1434913,"ip_address":"","ucode":"78C374E8A53E29","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqWa00uqgukb0sPD16VkHAlP7KibaChCmBIA7y9LficdWv7yguibJeicV2dwQakIQbI7RuqzpdHNQjriaw/132","comment_is_top":false,"comment_ctime":1606041400,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1606041400","product_id":100020801,"comment_content":"要删除一个大表，有两种方案：<br>一、delete每一行数据（分批，可以控制影响），然后再optimize<br>二、直接truncate<br><br>delete只是标记为可以复用，并没有释放空间，这么看来两种方案对线上数据库的性能影响是否是一样的？","like_count":0},{"had_liked":false,"id":261717,"user_name":"sibyl","can_delete":false,"product_type":"c1","uid":1323652,"ip_address":"","ucode":"0D142011860D69","user_header":"","comment_is_top":false,"comment_ctime":1605502569,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1605502569","product_id":100020801,"comment_content":"一个uuid主键和int字段组成的表，100万行，idb文件是160M,执行完alter talbe t engine=InnoDB后，降为80M","like_count":0},{"had_liked":false,"id":257865,"user_name":"Gopher","can_delete":false,"product_type":"c1","uid":1206229,"ip_address":"","ucode":"3C1F9012BB486D","user_header":"https://static001.geekbang.org/account/avatar/00/12/67/d5/1b26b725.jpg","comment_is_top":false,"comment_ctime":1604160554,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1604160554","product_id":100020801,"comment_content":"遇到一个很奇怪的问题：<br><br>count(字段)理论上应该是会判断一下不是null 才累加1 <br><br>表结构：<br><br>CREATE TABLE `user` (<br>  `id` int(11) NOT NULL AUTO_INCREMENT,<br>  `user_id` int(11) DEFAULT NULL COMMENT &#39;用户ID&#39;,<br>  `remark` varchar(512) DEFAULT NULL COMMENT &#39;备注&#39;,<br> CURRENT_TIMESTAMP,<br>  PRIMARY KEY (`id`),<br>  KEY `uid_index` (`uuid`)<br>) ENGINE=InnoDB AUTO_INCREMENT=113203 DEFAULT CHARSET=utf8 ROW_FORMAT=DYNAMIC COMMENT=&#39;用户表&#39;;<br><br>count(user_id) 统计的的结果是去除null.的，这个结果是正常的。而且奇怪的是count(remark)的结果居然是错 的，因为表中的字段只有12个有值，其他都是null 按理说应是12 （一个接近总条数的结果）<br><br>版本5.7<br><br>我在5.8上执行的结果却是正确的 很奇怪这是为啥啊<br><br>希望老师能帮我解答一下","like_count":0},{"had_liked":false,"id":256578,"user_name":"陈狄","can_delete":false,"product_type":"c1","uid":2011954,"ip_address":"","ucode":"456F00EB2EB43D","user_header":"https://static001.geekbang.org/account/avatar/00/1e/b3/32/0ee78a1a.jpg","comment_is_top":false,"comment_ctime":1603682541,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1603682541","product_id":100020801,"comment_content":"课后问题：表空间没变小，说明还是存在索引空洞的问题，那么就有可能是主键的排列不紧凑，重建表也没用。而表空间稍微变大，可能是因为重建表的时候，有页分裂，使得数据没多，但是数据页变多了。","like_count":0},{"had_liked":false,"id":251698,"user_name":"John","can_delete":false,"product_type":"c1","uid":1228424,"ip_address":"","ucode":"A46AF2906C38C1","user_header":"https://static001.geekbang.org/account/avatar/00/12/be/88/8d15796f.jpg","comment_is_top":false,"comment_ctime":1601801648,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1601801648","product_id":100020801,"comment_content":"另外，如果主键是自增的。那么不断新增数据就会导致这个表文件越来越大？因为永远无法复用？","like_count":0},{"had_liked":false,"id":251695,"user_name":"John","can_delete":false,"product_type":"c1","uid":1228424,"ip_address":"","ucode":"A46AF2906C38C1","user_header":"https://static001.geekbang.org/account/avatar/00/12/be/88/8d15796f.jpg","comment_is_top":false,"comment_ctime":1601800998,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1601800998","product_id":100020801,"comment_content":"老师，我有个疑问，数据页中被标记为删除的数据行也不一定是可复用的吧？需要这个数据行挂的所有undo log 都删除了吧？","like_count":0},{"had_liked":false,"id":250142,"user_name":"kobe huang","can_delete":false,"product_type":"c1","uid":1014251,"ip_address":"","ucode":"235011AE91829A","user_header":"https://static001.geekbang.org/account/avatar/00/0f/79/eb/b0aea6ff.jpg","comment_is_top":false,"comment_ctime":1600950016,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1600950016","product_id":100020801,"comment_content":"奇哥，如果整个数据页的记录被删除，是不是对应的磁盘空间也会被释放? 我们今天delete 了 1千万数据，发现表的大小少了1个G左右。","like_count":0,"discussions":[{"author":{"id":1237121,"avatar":"https://static001.geekbang.org/account/avatar/00/12/e0/81/7a669875.jpg","nickname":"淡之","note":"","ucode":"8C4334A70E910B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":545395,"discussion_content":"还有页合并","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641950405,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":249797,"user_name":"rafa","can_delete":false,"product_type":"c1","uid":1318383,"ip_address":"","ucode":"CF01C3EAF1DA11","user_header":"","comment_is_top":false,"comment_ctime":1600795250,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1600795250","product_id":100020801,"comment_content":"答案是不能。因为，tmp_file 也是要占用临时空间的。<br>这个是什么意思？tmpfile不是占用了磁盘空间吗，磁盘空间1.2T啊，这个临时空间不属于磁盘空间？","like_count":0,"discussions":[{"author":{"id":1014665,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/7b/89/34f2cbcc.jpg","nickname":"杨宇","note":"","ucode":"EB74DF6E269F03","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":318752,"discussion_content":"老师说的应该是“磁盘总空间”","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603844682,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":247840,"user_name":"seqwait","can_delete":false,"product_type":"c1","uid":2170189,"ip_address":"","ucode":"D3293E997738DF","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83er5oeRAIicqPSzibzX6CMxq0x90G9ibefKAp4EOMljeafJUjt1877cC4ljGCOYz1wYBwIARVESlWuSicA/132","comment_is_top":false,"comment_ctime":1599885657,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1599885657","product_id":100020801,"comment_content":"老师,大量删除表数据后,表空间的大小会影响查询效率吗?","like_count":0},{"had_liked":false,"id":243861,"user_name":"刘玉龙","can_delete":false,"product_type":"c1","uid":1500821,"ip_address":"","ucode":"02BCA2E78C1AD7","user_header":"https://static001.geekbang.org/account/avatar/00/16/e6/95/99d51e08.jpg","comment_is_top":false,"comment_ctime":1598315406,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1598315406","product_id":100020801,"comment_content":"mySQL目录下还有一个文件  ibdata 文件也是只增不减，是什么原因","like_count":0},{"had_liked":false,"id":240878,"user_name":"徐海浪","can_delete":false,"product_type":"c1","uid":1078528,"ip_address":"","ucode":"21801C420D0610","user_header":"https://static001.geekbang.org/account/avatar/00/10/75/00/618b20da.jpg","comment_is_top":false,"comment_ctime":1597109293,"is_pvip":false,"discussion_count":0,"race_medal":1,"score":"1597109293","product_id":100020801,"comment_content":"可能是页分裂导致的空间变大。","like_count":0},{"had_liked":false,"id":239414,"user_name":"黑客时间","can_delete":false,"product_type":"c1","uid":1831324,"ip_address":"","ucode":"7E22D76EECAC4D","user_header":"https://static001.geekbang.org/account/avatar/00/1b/f1/9c/cd12361d.jpg","comment_is_top":false,"comment_ctime":1596527259,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1596527259","product_id":100020801,"comment_content":"如果主键是递增的，现在删除了一部分数据，那么下次插入的主键值还是在以前最大值基础上递增的，那么之前删除的位置是不是永远都用不了了","like_count":0},{"had_liked":false,"id":234873,"user_name":"一飞冲天","can_delete":false,"product_type":"c1","uid":1980707,"ip_address":"","ucode":"14CB54F27C4DD4","user_header":"https://static001.geekbang.org/account/avatar/00/1e/39/23/a8a23268.jpg","comment_is_top":false,"comment_ctime":1594816639,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1594816639","product_id":100020801,"comment_content":"老师有一个问题，就是如何查看现有的一个表的空洞占比呢？<br>","like_count":0,"discussions":[{"author":{"id":1388018,"avatar":"https://static001.geekbang.org/account/avatar/00/15/2d/f2/07b94d3c.jpg","nickname":"养成好习惯","note":"","ucode":"7919C9592E2B2C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":295337,"discussion_content":"好问题，我也想问","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596167133,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":234440,"user_name":"。。。","can_delete":false,"product_type":"c1","uid":1035567,"ip_address":"","ucode":"6882BABE9C3D6B","user_header":"https://static001.geekbang.org/account/avatar/00/0f/cd/2f/f4adcb41.jpg","comment_is_top":false,"comment_ctime":1594692698,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1594692698","product_id":100020801,"comment_content":"数据页到底是什么,看不见摸不着,能具体说明下吗?","like_count":0},{"had_liked":false,"id":230732,"user_name":"NingJiaa","can_delete":false,"product_type":"c1","uid":1104129,"ip_address":"","ucode":"5CEA19486F7D48","user_header":"https://static001.geekbang.org/account/avatar/00/10/d9/01/3ad0c998.jpg","comment_is_top":false,"comment_ctime":1593479819,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1593479819","product_id":100020801,"comment_content":"老师，想请问您一下，您说一个页被重用在索引的任何地方的，但是索引提高效率不就是顺序读吗，如果一个页被重用在了索引的随便一个地方，那不就增加了索引的随机读吗，特别是普通硬盘时候是不是会有性能影响，谢谢🙏","like_count":0},{"had_liked":false,"id":229910,"user_name":"獒泽","can_delete":false,"product_type":"c1","uid":1200189,"ip_address":"","ucode":"7C054BF34B0E3A","user_header":"https://static001.geekbang.org/account/avatar/00/12/50/3d/28f2b679.jpg","comment_is_top":false,"comment_ctime":1593185089,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1593185089","product_id":100020801,"comment_content":"老师删除一行数据时，除了主键索引会被置为删除状态外，与之相关的二级索引会做什么处理呢？","like_count":0},{"had_liked":false,"id":229364,"user_name":"夏奇","can_delete":false,"product_type":"c1","uid":1221854,"ip_address":"","ucode":"92F035A901F5A8","user_header":"https://static001.geekbang.org/account/avatar/00/12/a4/de/a5db636f.jpg","comment_is_top":false,"comment_ctime":1592975758,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1592975758","product_id":100020801,"comment_content":"为什么Mysql的删除是标记复用，而不是直接清除数据，这个在设计上是怎么考虑的","like_count":0},{"had_liked":false,"id":228125,"user_name":"Finley","can_delete":false,"product_type":"c1","uid":1604532,"ip_address":"","ucode":"042BC805B4A1B0","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/QD9GIbqK8mx2zu6GbHQQEfWYG2oxzTlZIUQhWUrBgy4QFueKPb1qlVBUtxZictHibtjdia7ZBoNOrD1SrZPQ3TKsw/132","comment_is_top":false,"comment_ctime":1592562176,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1592562176","product_id":100020801,"comment_content":"老师，如果表是按天常见的partition，且定期删除partition，还会出现表文件大小不变的情况不 ？","like_count":0},{"had_liked":false,"id":226086,"user_name":"图灵机","can_delete":false,"product_type":"c1","uid":2034632,"ip_address":"","ucode":"EB02DB653AD591","user_header":"https://static001.geekbang.org/account/avatar/00/1f/0b/c8/15f055d3.jpg","comment_is_top":false,"comment_ctime":1591948624,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1591948624","product_id":100020801,"comment_content":"之前有一张表，测试用，每次导200多万数据，用完就delete table ，然后还是这张表重新导数据测，结果count(*) 越来越慢....","like_count":0},{"had_liked":false,"id":225477,"user_name":"盘胧","can_delete":false,"product_type":"c1","uid":1650748,"ip_address":"","ucode":"5386CC4C92ECC2","user_header":"https://static001.geekbang.org/account/avatar/00/19/30/3c/0668d6ae.jpg","comment_is_top":false,"comment_ctime":1591762097,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1591762097","product_id":100020801,"comment_content":"执行之后表还是很大，没有变化呀。是否要重新排一下id，再执行","like_count":0},{"had_liked":false,"id":224124,"user_name":"Tomy","can_delete":false,"product_type":"c1","uid":1192601,"ip_address":"","ucode":"D7E49E90B0D60F","user_header":"https://static001.geekbang.org/account/avatar/00/12/32/99/91b58bf7.jpg","comment_is_top":false,"comment_ctime":1591279409,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1591279409","product_id":100020801,"comment_content":"如何查询表空间的大小呢","like_count":0},{"had_liked":false,"id":215569,"user_name":"幼儿编程教学","can_delete":false,"product_type":"c1","uid":1237199,"ip_address":"","ucode":"F13F3150E6CAE9","user_header":"https://static001.geekbang.org/account/avatar/00/12/e0/cf/43f201f2.jpg","comment_is_top":false,"comment_ctime":1589019319,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1589019319","product_id":100020801,"comment_content":"课后问题中表的大小，从1T变成了1.01T，变化量很小<br>我实际线上，出现过，7G大小，optimize table 后，变成 11G<br>除了“在重建表的时候，InnoDB 不会把整张表占满，每个页留了 1&#47;16 给后续的更新用。”这个原因，是不是还有可能下面这个原因<br><br>Mysql8 上线了 add column instant 这个功能。因此，刚执行 add column 时，这个应该只是改了表结构定义部分，row数据应该没改。select 时，实时的去加新add的部分，返回给客户端。执行重建sql后，这个column的数据，应该到row中了，因此变大了。","like_count":0},{"had_liked":false,"id":212368,"user_name":"达达队长","can_delete":false,"product_type":"c1","uid":1117597,"ip_address":"","ucode":"1C3F2E4F6B7637","user_header":"https://static001.geekbang.org/account/avatar/00/11/0d/9d/58d09086.jpg","comment_is_top":false,"comment_ctime":1588089922,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1588089922","product_id":100020801,"comment_content":"老师有2个问题：<br>1.一个表有多个索引，是只有主键B+树的叶子节点上的数据才会标记为删除吗？其余的索引上的叶子节点还会标记吗？如果不会，那么根据其他索引select * 的时候不就得回表查，发现标记删除了，然后返回空，mysql 应该不会这么做吧？<br>2.如果普通索引也被标记为删除，那您回答 create table t select * from xxx的时候，为什么说主键是紧凑的，而其他索引还是会有空洞的，主键索引和普通索引处理不一样吗？","like_count":0},{"had_liked":false,"id":207743,"user_name":"梅侯","can_delete":false,"product_type":"c1","uid":1047837,"ip_address":"","ucode":"60445908BDD82C","user_header":"https://static001.geekbang.org/account/avatar/00/0f/fd/1d/76bec892.jpg","comment_is_top":false,"comment_ctime":1587171925,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1587171925","product_id":100020801,"comment_content":"数据库有页合并的功能，这个页合并是何时执行的呢，合并后空出的部分也是标记为可复用，表空间没有变吧","like_count":0},{"had_liked":false,"id":205929,"user_name":"Jonah","can_delete":false,"product_type":"c1","uid":1079507,"ip_address":"","ucode":"2C4799BD2FF0DE","user_header":"https://static001.geekbang.org/account/avatar/00/10/78/d3/1dc40aa2.jpg","comment_is_top":false,"comment_ctime":1586759250,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1586759250","product_id":100020801,"comment_content":"老师有几个问题：<br>1. 删除数据导致的空洞会出现在普通索引上吗？<br>2. 如果普通索引上出现空洞，会不会导致该索引的基数值统计出现问题？","like_count":0},{"had_liked":false,"id":202577,"user_name":"小牛牛","can_delete":false,"product_type":"c1","uid":1122912,"ip_address":"","ucode":"AB47706AC35168","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/411lrtIQO2bQFSvmb7DGOwxiaCQUmO8Qjibp2Sqibg4MFgCAsico4m51qiaThflLoQgBbuDtwzo3B5VSW2T4HVYzvrQ/132","comment_is_top":false,"comment_ctime":1586009922,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1586009922","product_id":100020801,"comment_content":"如果我的主键做为外键使用了，是不是就不能用这种方式了？有没有其它方式呢","like_count":0},{"had_liked":false,"id":199998,"user_name":"小区反手王","can_delete":false,"product_type":"c1","uid":1346234,"ip_address":"","ucode":"69F9D46C82A690","user_header":"https://static001.geekbang.org/account/avatar/00/14/8a/ba/8f48bdc6.jpg","comment_is_top":false,"comment_ctime":1585531005,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1585531005","product_id":100020801,"comment_content":"老师，我们使用mysql时候遇到这么一个问题，辛苦您帮忙看看有没有思路：<br>为了支持更大数据量将数据水平拆分，分成64个库，每个库有1500万左右数据量，在某次变更，执行ALTER DDL 增加字段的时候，大部分库执行的很快，10分钟内完成。个别库执行的很慢，耗时约50分钟。您有什么好的分析建议？","like_count":0,"discussions":[{"author":{"id":2215928,"avatar":"https://static001.geekbang.org/account/avatar/00/21/cf/f8/86076de4.jpg","nickname":"宏彬","note":"","ucode":"8EFDD45EA62342","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":387403,"discussion_content":"1 当时各个库的资源使用情况，cpu 内存 磁盘io等\n2 当时数据库内事务执行情况，是否有慢查询导致等待\n3 数据库影响性能的配置参数是否不一致\n我大概想到的就这些","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628152412,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":194835,"user_name":"陈家睿","can_delete":false,"product_type":"c1","uid":1830128,"ip_address":"","ucode":"570EEC6AB6CB21","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJSaE2tKBHbZpdvicX7CNiaacXsvEHzcjMRQ5LiauDA7wFIwsCltj0HyggQsYh49VJCj5iciawceZZnl9w/132","comment_is_top":false,"comment_ctime":1585108747,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1585108747","product_id":100020801,"comment_content":"online DDL 具体操作是什么样的呢？","like_count":0},{"had_liked":false,"id":192328,"user_name":"贾森安德森","can_delete":false,"product_type":"c1","uid":1071680,"ip_address":"","ucode":"7FF58646E0AD86","user_header":"https://static001.geekbang.org/account/avatar/00/10/5a/40/59de94de.jpg","comment_is_top":false,"comment_ctime":1584846819,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1584846819","product_id":100020801,"comment_content":"delete命令把整个表的数据删除，所有的数据页都会别标记为可复用，而不是清空数据。是不是这样理解","like_count":0},{"had_liked":false,"id":190731,"user_name":"1885","can_delete":false,"product_type":"c1","uid":1907880,"ip_address":"","ucode":"550DF8AE62A03A","user_header":"","comment_is_top":false,"comment_ctime":1584688221,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1584688221","product_id":100020801,"comment_content":"请问林老师，innodb表的话，如何判断可回收的空间，或者说碎片？information_schema.TABLES 对innodb表无效。","like_count":0},{"had_liked":false,"id":188893,"user_name":"ipofss","can_delete":false,"product_type":"c1","uid":1018620,"ip_address":"","ucode":"DE3061C9259F9E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8a/fc/d1dd57dd.jpg","comment_is_top":false,"comment_ctime":1584431276,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1584431276","product_id":100020801,"comment_content":"delete操作就像是，只是标记了记录“可复用”或数据页“可复用”，中间会产生“空洞”。<br>innodb_file_per_table，会标记表数据是使用系统表空间，还是独立文件，最好使用独立文件，即设置为ON。<br>想要压缩表空间，可以通过alter命令来重建表。但是要根据业务来，在业务低峰期执行。","like_count":0},{"had_liked":false,"id":185137,"user_name":"万凯","can_delete":false,"product_type":"c1","uid":1179106,"ip_address":"","ucode":"4D0027D520EA0B","user_header":"https://static001.geekbang.org/account/avatar/00/11/fd/e2/0c511e7a.jpg","comment_is_top":false,"comment_ctime":1583493163,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1583493163","product_id":100020801,"comment_content":"大家使用什么语句来查表空间的大小呢？<br>我用： select concat(round(sum(DATA_LENGTH&#47;1024&#47;1024),2),&#39;M&#39;)  from information_schema.tables where table_schema=&quot;translatedb&quot; and table_name = &quot;t&quot;;<br>但是查出来的结果不对，有知道的伙伴吗？","like_count":0},{"had_liked":false,"id":182509,"user_name":"笙箫","can_delete":false,"product_type":"c1","uid":1659072,"ip_address":"","ucode":"D1B3E88BD97728","user_header":"https://static001.geekbang.org/account/avatar/00/19/50/c0/96ae4cd5.jpg","comment_is_top":false,"comment_ctime":1582798942,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1582798942","product_id":100020801,"comment_content":"用alter table A engine=innodb 的时候会创建临时表，执行的过程中该数据库所在的文件夹占用的磁盘空间变大了，但是并没有在该文件夹下看到临时表的文件，请问临时表的文件是隐藏了吗?","like_count":0},{"had_liked":false,"id":180157,"user_name":"chenxi","can_delete":false,"product_type":"c1","uid":1003086,"ip_address":"","ucode":"1B8C0C4DF92601","user_header":"https://static001.geekbang.org/account/avatar/00/0f/4e/4e/c41de010.jpg","comment_is_top":false,"comment_ctime":1582202034,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1582202034","product_id":100020801,"comment_content":"online ddl 过程中发生的 dml 操作记录在 row log 中，这时有 查询 操作的话，可以查到这些增量数据么？<br>","like_count":0},{"had_liked":false,"id":179359,"user_name":"张sir","can_delete":false,"product_type":"c1","uid":1209431,"ip_address":"","ucode":"52958DF6705208","user_header":"https://static001.geekbang.org/account/avatar/00/12/74/57/7b828263.jpg","comment_is_top":false,"comment_ctime":1581989807,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1581989807","product_id":100020801,"comment_content":"老师，有一点不太明白，如果数据页是可复用状态，数据页本身会占用空间吗，所以空间不太减少，是这个意思吗？还是已经删除的数据本身还占用空间<br>","like_count":0,"discussions":[{"author":{"id":1071680,"avatar":"https://static001.geekbang.org/account/avatar/00/10/5a/40/59de94de.jpg","nickname":"贾森安德森","note":"","ucode":"7FF58646E0AD86","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":211388,"discussion_content":"我感觉没有删除，只是给了一个标记，标记为可复用。 数据都还存在。。。。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584846252,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":174703,"user_name":"passinger","can_delete":false,"product_type":"c1","uid":1146811,"ip_address":"","ucode":"7D14BD16D99DC3","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKXgv8EI2jwIyQ0jVKNKecQ3z4pYHyN92siaEDS0Ezpo2Xic5Tpr6IrpHtA81d5ExBsXrxicroKsYkSg/132","comment_is_top":false,"comment_ctime":1580356933,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1580356933","product_id":100020801,"comment_content":"alter table不会对索引重新进行统计吗？必须用analyze table? ","like_count":0,"discussions":[{"author":{"id":2287841,"avatar":"https://static001.geekbang.org/account/avatar/00/22/e8/e1/6045b299.jpg","nickname":"LPF","note":"","ucode":"036C552D7251E9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":327532,"discussion_content":"alter就足够，重建表的过程就是重建索引的过程","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605857858,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":157907,"discussion_content":"alter table是重建的过程。这个过程就是可以理解为重新统计吧。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580529879,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":168934,"user_name":"温故而知新可以为师矣","can_delete":false,"product_type":"c1","uid":1453053,"ip_address":"","ucode":"FADCDFA9F9E5E8","user_header":"https://static001.geekbang.org/account/avatar/00/16/2b/fd/7013289d.jpg","comment_is_top":false,"comment_ctime":1578220043,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1578220043","product_id":100020801,"comment_content":"有几个问题+“找茬”：<br>1：&quot;page A 会被标记为可复用。这时候如果要插入一条 ID=50 的记录需要使用新页的时候，page A 是可以被复用的&quot;,pageA可复用id范围应该是”300~700“，为什么&quot;插入一条 ID=50&quot;的时候可以复用？<br>2: &quot;图 4 Online DDL&quot;，state 3中“temp_file”和“A”标反了吧?<br>3: “现在磁盘间是 1.2TB”少一个&quot;空&quot;吧？","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":157913,"discussion_content":"我个人理解：\n1、page页可复用，说明它已经是干净的，没有所谓的id范围了，所以可以插入任意id值；\n2、我也感觉是标反了，当时看着也别扭。\n3、当时看这个也有点歧义，如果你加上空的话，那应该是可以inplace的。我感觉1.2T是包括1T表的总空间，也就是现在剩于0.2T空间了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580530150,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":166600,"user_name":"Aaron","can_delete":false,"product_type":"c1","uid":1114238,"ip_address":"","ucode":"6ECBBA57DD2687","user_header":"https://static001.geekbang.org/account/avatar/00/11/00/7e/c22945bf.jpg","comment_is_top":false,"comment_ctime":1577514463,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1577514463","product_id":100020801,"comment_content":"老师 我有很多表data_free都很大，但执行alter table engine innodb后 data_free都变为原来一半 请问什么原因呢","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":157973,"discussion_content":"说明空间压缩了一半啊。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580537936,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":160057,"user_name":"Nash.Z","can_delete":false,"product_type":"c1","uid":1232273,"ip_address":"","ucode":"76B14722664402","user_header":"https://static001.geekbang.org/account/avatar/00/12/cd/91/3d6c53f8.jpg","comment_is_top":false,"comment_ctime":1575861548,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1575861548","product_id":100020801,"comment_content":"老师您好：<br>我在我们项目测试环境，对一个表执行了 alter操作，表数据大小减少了三分之一，但是rows却从21000行编程了29000行，反而增加了，请教一下为什么会出现这种情况，谢谢","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":157974,"discussion_content":"是不是索引先错了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580538107,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1453053,"avatar":"https://static001.geekbang.org/account/avatar/00/16/2b/fd/7013289d.jpg","nickname":"温故而知新可以为师矣","note":"","ucode":"FADCDFA9F9E5E8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":120771,"discussion_content":"扫描行？\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578294899,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":160027,"user_name":"Nash.Z","can_delete":false,"product_type":"c1","uid":1232273,"ip_address":"","ucode":"76B14722664402","user_header":"https://static001.geekbang.org/account/avatar/00/12/cd/91/3d6c53f8.jpg","comment_is_top":false,"comment_ctime":1575858927,"is_pvip":false,"discussion_count":5,"race_medal":0,"score":"1575858927","product_id":100020801,"comment_content":"老师，请教个问题：<br>我们项目目前在重构，我们的架构师，要求我门所有表的id都用uuid来生成，但是我觉得用uuid的话，数据插入的时候，会经常性的拆分数据页，会导致存储空间的浪费，但是如果有数据删除的话，被标记删除的空间存在被复用的可能性，而如果用自增的话，虽然做数据插入的时候，不会拆分数据页，但是被标记删除的空间，又永远不会被复用。所以这两者到底如何做选择？<br> <br>","like_count":0,"discussions":[{"author":{"id":1010344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/6a/a8/ee414a25.jpg","nickname":"公告-SRE运维实践","note":"","ucode":"86F4E48AE1D9D8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546156,"discussion_content":"为了数据迁移方便","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642178831,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":157975,"discussion_content":"尽量别用uuid来做主键了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580538171,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1453053,"avatar":"https://static001.geekbang.org/account/avatar/00/16/2b/fd/7013289d.jpg","nickname":"温故而知新可以为师矣","note":"","ucode":"FADCDFA9F9E5E8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":120775,"discussion_content":"是有什么特殊的业务需求吗？为什么要用uuid来做主键？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578295041,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1246178,"avatar":"https://static001.geekbang.org/account/avatar/00/13/03/e2/5768d26e.jpg","nickname":"inrtyx","note":"","ucode":"81CD18FF34ABAB","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":112697,"discussion_content":"uuid也一样会有这个问题。你可以这样：用id自增作为主键，uuid作为业务id。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577879692,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1698291,"avatar":"https://static001.geekbang.org/account/avatar/00/19/e9/f3/3bbdff7e.jpg","nickname":"雪候鸟","note":"","ucode":"3E7ED6605BC86E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":95012,"discussion_content":"这个问题也是我一直以来的疑问，期待老师给予答复","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577006573,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":159995,"user_name":"Nash.Z","can_delete":false,"product_type":"c1","uid":1232273,"ip_address":"","ucode":"76B14722664402","user_header":"https://static001.geekbang.org/account/avatar/00/12/cd/91/3d6c53f8.jpg","comment_is_top":false,"comment_ctime":1575855639,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1575855639","product_id":100020801,"comment_content":"老师，请教一个问题：<br> 图一，中讲到，如果要删除R4这个记录，只是把R4这个记录标为已删除，那么如果有一个非主键索引，那么只想主键索引ID的那条记录怎么处理？谢谢！","like_count":0,"discussions":[{"author":{"id":2287841,"avatar":"https://static001.geekbang.org/account/avatar/00/22/e8/e1/6045b299.jpg","nickname":"LPF","note":"","ucode":"036C552D7251E9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":327533,"discussion_content":"对的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605857953,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":157977,"discussion_content":"该行记录的非主键索引也会删除吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580538267,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":152684,"user_name":"萝卜条","can_delete":false,"product_type":"c1","uid":1692713,"ip_address":"","ucode":"4BC975BBFE50A7","user_header":"https://static001.geekbang.org/account/avatar/00/19/d4/29/5f52a82c.jpg","comment_is_top":false,"comment_ctime":1574062868,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1574062868","product_id":100020801,"comment_content":"整篇讲了2个问题：<br>1、delete和insert会生成一些可复用却没复用的空间。<br>2、alter table A engine=InnoDB可以解决那个问题。","like_count":0},{"had_liked":false,"id":152547,"user_name":"长期规划","can_delete":false,"product_type":"c1","uid":1019332,"ip_address":"","ucode":"5EF65E9115834B","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8d/c4/6f97daea.jpg","comment_is_top":false,"comment_ctime":1574041844,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1574041844","product_id":100020801,"comment_content":"老师，MySQL有什么办法查看空洞占数据页的比例吗，我理解如果空洞多，会影响读写效率吧","like_count":0,"discussions":[{"author":{"id":2287841,"avatar":"https://static001.geekbang.org/account/avatar/00/22/e8/e1/6045b299.jpg","nickname":"LPF","note":"","ucode":"036C552D7251E9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":327534,"discussion_content":"show table status like &#39;t&#39;，查看 free_data","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605857982,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1453053,"avatar":"https://static001.geekbang.org/account/avatar/00/16/2b/fd/7013289d.jpg","nickname":"温故而知新可以为师矣","note":"","ucode":"FADCDFA9F9E5E8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":120778,"discussion_content":"我觉得可以用实际大小和应该大小推算吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578295153,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":142188,"user_name":"周末音乐家","can_delete":false,"product_type":"c1","uid":1599738,"ip_address":"","ucode":"B603D53E6576A2","user_header":"https://static001.geekbang.org/account/avatar/00/18/68/fa/103589dc.jpg","comment_is_top":false,"comment_ctime":1571306924,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1571306924","product_id":100020801,"comment_content":"文中“数据页分裂”的原因，是因为MySQL索引是基于B+树结构而造成的吗？","like_count":0,"discussions":[{"author":{"id":2287841,"avatar":"https://static001.geekbang.org/account/avatar/00/22/e8/e1/6045b299.jpg","nickname":"LPF","note":"","ucode":"036C552D7251E9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":327536,"discussion_content":"比如一个麻袋装不下，不就需要另一个麻袋去装吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605858052,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1453053,"avatar":"https://static001.geekbang.org/account/avatar/00/16/2b/fd/7013289d.jpg","nickname":"温故而知新可以为师矣","note":"","ucode":"FADCDFA9F9E5E8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":120779,"discussion_content":"因为要维持B+树的状态（比如要求每个节点最多1000个元素，现在插入一个变为1001就要分裂了）。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578295396,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":140785,"user_name":"三丰","can_delete":false,"product_type":"c1","uid":1310187,"ip_address":"","ucode":"CA69A069D3061D","user_header":"","comment_is_top":false,"comment_ctime":1571048389,"is_pvip":false,"discussion_count":3,"race_medal":0,"score":"1571048389","product_id":100020801,"comment_content":"老师，我们在线做alter table ... engine=innodb ,导致大量等待，不是mdl锁等待，是感觉操作将完的时候导致的大量等待，这是怎么个情况呢？","like_count":0,"discussions":[{"author":{"id":2287841,"avatar":"https://static001.geekbang.org/account/avatar/00/22/e8/e1/6045b299.jpg","nickname":"LPF","note":"","ucode":"036C552D7251E9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":327537,"discussion_content":"在线DDL，后期转为写锁，阻塞其他DDL和DML操作","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1605858156,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1009693,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJLxEbhSEziblPNVkr9XFIAzPCib0TQvBxHYwiaKiaib7ExZ8dmUWyqWoibSedACTHCf52INMib80ic92G6wQ/132","nickname":"刘章","note":"","ucode":"7608C518D49AE4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":553481,"discussion_content":"你们版本是多少的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1645924764,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":157983,"discussion_content":"因为是表锁导致的阻塞吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580538643,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":130074,"user_name":"alioo","can_delete":false,"product_type":"c1","uid":1022507,"ip_address":"","ucode":"F36A38C1F5FFAB","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqOpANMwDibLmj5IGJh6dTw300sZ1BHM5sG3sZv1A1rvCHOiblPD3jgFOiaMVVujtctWnQbVFoNPpRgw/132","comment_is_top":false,"comment_ctime":1567383693,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1567383693","product_id":100020801,"comment_content":"从 MySQL 5.6 版本开始，alter table t engine = InnoDB（也就是 recreate）默认的就是上面图 4 的流程了；<br>analyze table t 其实不是重建表，只是对表的索引信息做重新统计，没有修改数据，这个过程中加了 MDL 读锁；<br>optimize table t 等于 recreate+analyze。","like_count":0},{"had_liked":false,"id":130013,"user_name":"潘","can_delete":false,"product_type":"c1","uid":1631455,"ip_address":"","ucode":"344FBB29676C05","user_header":"https://static001.geekbang.org/account/avatar/00/18/e4/df/410c134d.jpg","comment_is_top":false,"comment_ctime":1567351576,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1567351576","product_id":100020801,"comment_content":"总结一下心得，为什么数据删除后表空间大小没变，本质上要归于b+树数据页的数据存储结构，数据被删除在底层只是打了个可复用的标记，有点类似于逻辑删除一样，空间并不会得到释放。进而再扩展一下，要想优化空间有哪些方法呢？大概这么些，以ibd为存储的drop table操作，这种相当于直接干掉了ibd存储文件，再就是重建表alter table engine=innodb这种，收缩存储空洞和整理分页数据，感觉和磁盘整理一个道理","like_count":0},{"had_liked":false,"id":125872,"user_name":"Geek_544e36","can_delete":false,"product_type":"c1","uid":1450625,"ip_address":"","ucode":"AE7D01F2BA3D65","user_header":"https://static001.geekbang.org/account/avatar/00/16/22/81/3115e3eb.jpg","comment_is_top":false,"comment_ctime":1566266713,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1566266713","product_id":100020801,"comment_content":"可能的原因是：使用了online ddl后，在alter table t engine=InnoDB；过程中新增的记录占用的空间比重建表节省的空间大了0.01TB","like_count":0},{"had_liked":false,"id":125819,"user_name":"PXB","can_delete":false,"product_type":"c1","uid":1583267,"ip_address":"","ucode":"947F7CF80C69D5","user_header":"https://static001.geekbang.org/account/avatar/00/18/28/a3/409424cd.jpg","comment_is_top":false,"comment_ctime":1566262429,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1566262429","product_id":100020801,"comment_content":"老师，请问下，update一行数据是不是先删除那行数据，然后在原来的位置（page里面的相同位置，不是更新主键）再insert？","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":157986,"discussion_content":"如果主键相同，应该是复用相同的位置。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580538813,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":125311,"user_name":"衬衫的价格是19美元","can_delete":false,"product_type":"c1","uid":1397631,"ip_address":"","ucode":"655F925451F772","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKVUskibDnhMt5MCIJ8227HWkeg2wEEyewps8GuWhWaY5fy7Ya56bu2ktMlxdla3K29Wqia9efCkWaQ/132","comment_is_top":false,"comment_ctime":1566144793,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1566144793","product_id":100020801,"comment_content":"5.6之后可以认为通过alter table t engin=innodb是online的，因为最耗时间的拷贝操作只是读锁，不影响数据库正常读写，而是记录在日志中。只有在对副本应用日志时时才会加dml锁，但是这段时间一般很短，可以近似认为是onlion的，这样理解对吗？","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":157988,"discussion_content":"online体现的意义是在重建表时，不影响原表的使用，同时对于在转移数据过程这段时间里，通过row log来记录这段时间内数据的变化。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580539166,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":115293,"user_name":"光","can_delete":false,"product_type":"c1","uid":1284618,"ip_address":"","ucode":"BDA7F41566E4FE","user_header":"https://static001.geekbang.org/account/avatar/00/13/9a/0a/6c74e932.jpg","comment_is_top":false,"comment_ctime":1563525983,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1563525983","product_id":100020801,"comment_content":"我有一个表，阿里云后台看着3G多点，但是alter table T engine=innodb 后变成8GB多了。什么原因啊。我看阿里云分析碎片率0.2降到了0.02.但是空间为啥变大了。","like_count":0},{"had_liked":false,"id":115245,"user_name":"库尔斯","can_delete":false,"product_type":"c1","uid":1085569,"ip_address":"","ucode":"BC2F220993C3ED","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIG210UcWicnKgOjBJC3CUxiaRImsiaqscVLyABrA4Kshm7hReicSuyRvfe1x07ydoT8WknNh2QLxU3rA/132","comment_is_top":false,"comment_ctime":1563517577,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1563517577","product_id":100020801,"comment_content":"老师  5.6.27版本 应该是支持online ddl的 但ddl仍会堵塞dml 这里可以贴图么<br><br>14 | copy to tmp table                | alter table `orders` <br>13 | Waiting for table metadata lock  | INSERT INTO `orders`<br>10 | Waiting for table metadata lock  | INSERT INTO `orders` <br>10 | Waiting for table metadata lock  | INSERT INTO `orders`<br>9  | Waiting for table metadata lock  | UPDATE `orders` SET <br>2  | Waiting for table metadata lock  | INSERT INTO `orders`<br><br>此时copy to tmp table 的状态 MDL退化成MDL读锁 ，不应该堵塞dml.这是怎么回事？","like_count":0},{"had_liked":false,"id":114963,"user_name":"Boh","can_delete":false,"product_type":"c1","uid":1172201,"ip_address":"","ucode":"0CF4CAC992FB4B","user_header":"https://static001.geekbang.org/account/avatar/00/11/e2/e9/d309c895.jpg","comment_is_top":false,"comment_ctime":1563439251,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1563439251","product_id":100020801,"comment_content":"在第七章就反馈过目前遇到过的这个问题，之前只是一知半解的知道大概是什么情况，今天看了老师这节课，真的是醍醐灌顶，对于发生这种情况的底层原理，处理方法都很清晰了，正因为遇到这个问题，看这节课印象特别深刻，同时也理解的比较透彻","like_count":0},{"had_liked":false,"id":110932,"user_name":"苍茫","can_delete":false,"product_type":"c1","uid":1299149,"ip_address":"","ucode":"CED8598307BEAE","user_header":"https://static001.geekbang.org/account/avatar/00/13/d2/cd/6fb14677.jpg","comment_is_top":false,"comment_ctime":1562398504,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1562398504","product_id":100020801,"comment_content":"老师，怎么我刚刚实验了一下,Truncate 一张表，这个表所占用的空间还是不变呢？","like_count":0,"discussions":[{"author":{"id":1155646,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKotsBr2icbYNYlRSlicGUD1H7lulSTQUAiclsEz9gnG5kCW9qeDwdYtlRMXic3V6sj9UrfKLPJnQojag/132","nickname":"ppd0705","note":"","ucode":"EB63D4E3FD1E9A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":241895,"discussion_content":"可能是表没有数据空洞","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587446177,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":157990,"discussion_content":"TRUNCATE只是删除表中所有数据，应该是将所有数据标记为已删除，但是空间应该没变。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580539392,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":109192,"user_name":"多襄丸","can_delete":false,"product_type":"c1","uid":1074310,"ip_address":"","ucode":"1AA1497C5A293C","user_header":"https://static001.geekbang.org/account/avatar/00/10/64/86/f5a9403a.jpg","comment_is_top":false,"comment_ctime":1561977741,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1561977741","product_id":100020801,"comment_content":"老师，我问一个问题啊:<br><br>图4.online ddl中，从state2 变为 state3过程中， 也就是将row log里的内容，写入到tem–file的过程中，这个时候row log是被读取的，这个时候要是再有更新原表A的记录，还会往row log里写数据吗？  online ddl 一定可以保证alter过程中对原表A的数据更新操作，不会丢失吗？","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":157991,"discussion_content":"是的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580539425,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":106248,"user_name":"Geek_e95920","can_delete":false,"product_type":"c1","uid":1344701,"ip_address":"","ucode":"193C44DAC1699C","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/HLDjKFe3k6EsKg2AzW7UPp6EiaxotnDciaIxCHtBWibbb0GAJXc2LfDCJwv3sL2QZAudndqUU31cicq4oMrGXibLaTA/132","comment_is_top":false,"comment_ctime":1561216980,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1561216980","product_id":100020801,"comment_content":"老师好，有个问题希望得到解答，谢谢。<br><br>引入了 Online DDL 之后，重建表的流程中，第4步，临时文件生成后，将日志文件中的操作应用到临时文件，得到一个逻辑数据上与表 A 相同的数据文件。<br><br>这个过程会加什么锁吗？如果不加锁阻塞DML操作，万一这个过程中，日志文件（row log）又被更新了，不会有什么问题吗？不会存在并发问题吗？<br><br>假设将row log最后一条记录应用到临时文件 到 用临时文件替换为表A的时间窗口内，又发生了一个写入操作，怎么办？虽然概率很低。","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":157992,"discussion_content":"这时候应该是有表锁的吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580539588,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":99316,"user_name":"一一","can_delete":false,"product_type":"c1","uid":1344255,"ip_address":"","ucode":"29D73AC1DCFFB6","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/JkMtA7dN7V9Z9iaX2w5zTuPOU6mxhARmEZxicXG7vOs5snjAQrlU0Km8pk9eOibJlhdV3aQk2zkFXOQwZEu1mDgLg/132","comment_is_top":false,"comment_ctime":1559191657,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1559191657","product_id":100020801,"comment_content":"老师，有几个问题想请教一下<br>1 引擎内部的omline DDL和gh-ost的实现原理是一样的，都会有插曲数据到临时表的操作。<br>2 生产环境中推荐使用gh-ost的原因是gh-ost可以控制随时停止，避免由于时间长部分阻塞引影响生产环境<br>","like_count":0},{"had_liked":false,"id":99036,"user_name":"养只小狗叫板凳","can_delete":false,"product_type":"c1","uid":1500822,"ip_address":"","ucode":"160C6B79EE46B6","user_header":"https://static001.geekbang.org/account/avatar/00/16/e6/96/0f4a18e0.jpg","comment_is_top":false,"comment_ctime":1559133619,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1559133619","product_id":100020801,"comment_content":"老师，1、我在我们的数据库里并没有找到表文件，用的是show  GLOBAL VARIABLES like &#39;%datadir%&#39;。不带global的也试了。没有具体的路径。<br>2、重建表，用的是alter table t engine = InnoDB<br><br> 数据长度和索引长度也没发生变化，明明表的起始是3000多了，之前的记录都通过delete删掉了。还是说我什么地方理解错了。<br>数据库版本是5.6","like_count":0},{"had_liked":false,"id":96081,"user_name":"anchor","can_delete":false,"product_type":"c1","uid":1083124,"ip_address":"","ucode":"24EECD40CC54C2","user_header":"https://static001.geekbang.org/account/avatar/00/10/86/f4/331f33a7.jpg","comment_is_top":false,"comment_ctime":1558322513,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1558322513","product_id":100020801,"comment_content":"继续追<br>请教下老师 在online时候 那个rowlog 里面有删除的吗？ 是怎么个逻辑 如果对A有删除的操作，那么应用到temp表会不会还是有”空洞“？","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":157995,"discussion_content":"有可能。不过对于大部分来说是紧凑了，这才是目的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580539842,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":95280,"user_name":"谭小谭","can_delete":false,"product_type":"c1","uid":1298631,"ip_address":"","ucode":"C7928BEDFF4EDC","user_header":"https://static001.geekbang.org/account/avatar/00/13/d0/c7/62de0458.jpg","comment_is_top":false,"comment_ctime":1558006274,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1558006274","product_id":100020801,"comment_content":"丁老师问个问题，图2中，随机插入的id=550为啥不直接插入到pageA中呢，只把id=600移动到新申请的pageb上，这样不就刚好填补pageA上的空洞了吗。","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":157996,"discussion_content":"因为B+树上是要排序的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580539864,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1314724,"avatar":"https://static001.geekbang.org/account/avatar/00/14/0f/a4/0b49469f.jpg","nickname":"木子00","note":"","ucode":"8F78CA722EB29B","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":306437,"discussion_content":"550 插入到pageA 也是有续的啊","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600267940,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":157996,"ip_address":""},"score":306437,"extra":""}]}]},{"had_liked":false,"id":93052,"user_name":"Jzzw","can_delete":false,"product_type":"c1","uid":1508208,"ip_address":"","ucode":"4B642AADF48BD6","user_header":"https://static001.geekbang.org/account/avatar/00/17/03/70/01dc4853.jpg","comment_is_top":false,"comment_ctime":1557385481,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1557385481","product_id":100020801,"comment_content":"Mysql重建表后  二级索引如何操作  是跟着自动重建么还是会失效","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":158006,"discussion_content":"MySql重建表，二级索引应该不会建立吧，这个应该是紧凑了主键索引后，然后再在新表上建立之前所需要的二级索引，这时候二级索引树就会建立起来吧。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580540532,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":91234,"user_name":"Michael","can_delete":false,"product_type":"c1","uid":1118976,"ip_address":"","ucode":"35F4FFAC4A4B15","user_header":"https://static001.geekbang.org/account/avatar/00/11/13/00/a4a2065f.jpg","comment_is_top":false,"comment_ctime":1556940752,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1556940752","product_id":100020801,"comment_content":"删除数据之后表文件大小也不减小，只是将相应的位置标记为可用，这个意思是说物理磁盘上的数据也是按照页存储的？那么既然一个页默认固定大小是 16kb，那么会不会存在这种情况，一行数据被存在了两个数据页上？考虑到这个，我主要是想到平时在建表的时候，总要为各个字段设置长度，不知道这个长度除了限制这个字段能存储数据的上限之外，还会影响哪些东西？","like_count":0},{"had_liked":false,"id":87885,"user_name":"蚂蚁内推+v","can_delete":false,"product_type":"c1","uid":1050508,"ip_address":"","ucode":"24B10AEE54B3FD","user_header":"https://static001.geekbang.org/account/avatar/00/10/07/8c/0d886dcc.jpg","comment_is_top":false,"comment_ctime":1555742842,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1555742842","product_id":100020801,"comment_content":"老师你好，<br>为什么插入也会造成页分裂？<br>1，2，4一页    插入3<br>变为<br>1，2，3一页    4一页<br>可以吗？？","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":157999,"discussion_content":"有可能，因为B+树上是要求递增排序的，那如果插入的时候，此页放不下了，就会有页分裂。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1580540079,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":83528,"user_name":"aliang","can_delete":false,"product_type":"c1","uid":1149502,"ip_address":"","ucode":"B36B94B362477F","user_header":"https://static001.geekbang.org/account/avatar/00/11/8a/3e/30c05bce.jpg","comment_is_top":false,"comment_ctime":1554641012,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1554641012","product_id":100020801,"comment_content":"老师，你在回答@陈飞的问题：“雪花算法生成的分布式ID作主键（bigint类型）和自增ID作主键哪个性能更好？”时，认为性能一样。那如果表上还有其他二级索引呢，是不是前者的二级索引会比后者更占空间呢（分布式ID比自增ID更长，对应的主键索引也更大）？如果是，那做增删改操作时前者维护二级索引的代价（时间和空间）是不是更大？麻烦老师解惑！！","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":158000,"discussion_content":"肯定是有这种情况的，这个要看雪花算法生成的ID占的是多少字节，像bigint为8B，那如果雪花算法生成的是16B，肯定二级索引表占的空间更大。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580540186,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":82253,"user_name":"Lucus","can_delete":false,"product_type":"c1","uid":1198800,"ip_address":"","ucode":"CE8EB70CB9D9F1","user_header":"https://static001.geekbang.org/account/avatar/00/12/4a/d0/d319c44a.jpg","comment_is_top":false,"comment_ctime":1554169836,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1554169836","product_id":100020801,"comment_content":"有可能是表本身空洞比较少优化空间不大，执行命令期间又有很多新增数据","like_count":0},{"had_liked":false,"id":75758,"user_name":"万能的pino","can_delete":false,"product_type":"c1","uid":1435292,"ip_address":"","ucode":"E29D7415544789","user_header":"https://static001.geekbang.org/account/avatar/00/15/e6/9c/3e9ea951.jpg","comment_is_top":false,"comment_ctime":1552464944,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1552464944","product_id":100020801,"comment_content":"请教老师,请问如果我其他的表跟这个表有id上的关联...如果我这样重建索引跟其他表应该是关联不上的吧,那我是不是平时就应该尽量避免用递增主键id作为其他表的关联键?","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":158003,"discussion_content":"这个不影响吧，你的ID又不会变。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580540300,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":73068,"user_name":"风动草","can_delete":false,"product_type":"c1","uid":1303051,"ip_address":"","ucode":"6ED975DC4DD0D0","user_header":"https://static001.geekbang.org/account/avatar/00/13/e2/0b/e3c8765a.jpg","comment_is_top":false,"comment_ctime":1551789461,"is_pvip":false,"replies":[{"id":"26499","content":"难道是alter table engine =innodb?<br>","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1551796141,"ip_address":"","comment_id":73068,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1551789461","product_id":100020801,"comment_content":"delete记得你以前说后面跟个什么就可以立马释放空间的？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":441895,"discussion_content":"难道是alter table engine =innodb?\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551796141,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1453053,"avatar":"https://static001.geekbang.org/account/avatar/00/16/2b/fd/7013289d.jpg","nickname":"温故而知新可以为师矣","note":"","ucode":"FADCDFA9F9E5E8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":120789,"discussion_content":"难道这篇文章讲了&#34;alter table engine =innodb&#34;，哈哈哈！！！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578296132,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":72245,"user_name":"core dumped","can_delete":false,"product_type":"c1","uid":1103253,"ip_address":"","ucode":"F99C28F2C396E2","user_header":"https://static001.geekbang.org/account/avatar/00/10/d5/95/aae1eb2a.jpg","comment_is_top":false,"comment_ctime":1551539326,"is_pvip":false,"replies":[{"id":"26168","content":"这行记录从原表也会删除呀^_^","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1551575190,"ip_address":"","comment_id":72245,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1551539326","product_id":100020801,"comment_content":"如果查询的是ddl之前表中的结果，在这个期间删除了一条数据，会记录到row log中。删除以后再次查询，如果看到的还是ddl之前表中内容，这时候数据就不对了吧？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":441509,"discussion_content":"这行记录从原表也会删除呀^_^","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551575190,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2287841,"avatar":"https://static001.geekbang.org/account/avatar/00/22/e8/e1/6045b299.jpg","nickname":"LPF","note":"","ucode":"036C552D7251E9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":327540,"discussion_content":"临时文件会根据row_log删除这条数据","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605858354,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":71642,"user_name":"Bin","can_delete":false,"product_type":"c1","uid":1304406,"ip_address":"","ucode":"26BA010D2990C4","user_header":"https://static001.geekbang.org/account/avatar/00/13/e7/56/87f45704.jpg","comment_is_top":false,"comment_ctime":1551406055,"is_pvip":false,"replies":[{"id":"26169","content":"1. write_pos 追上checkpoint<br>2. 额，这个是比较常见的原因","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1551575947,"ip_address":"","comment_id":71642,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1551406055","product_id":100020801,"comment_content":"请教一下丁老师，文章中 “上期问题时间” 下面提到的 “每次事务提交都要写 redo log，如果设置太小，很快就会被写满。”。 那么我有问题请教一下老师您： <br>问题1： 怎么知道 redo log 被写满（不够用）了呢<br>问题2： 是通过 “磁盘压力很小，但是数据库出现间歇性的性能下跌” 来观察我提的问题1吗？ ","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":441250,"discussion_content":"1. write_pos 追上checkpoint\n2. 额，这个是比较常见的原因","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551575947,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":67978,"user_name":"core dumped","can_delete":false,"product_type":"c1","uid":1103253,"ip_address":"","ucode":"F99C28F2C396E2","user_header":"https://static001.geekbang.org/account/avatar/00/10/d5/95/aae1eb2a.jpg","comment_is_top":false,"comment_ctime":1550373807,"is_pvip":false,"replies":[{"id":"24444","content":"在这边文章里面介绍的online ddl流程你再看下，这个策略，是可以保证的可以查到正确结果的（正确结果就是ddl还没完成之前，应该查到ddl之前的表的结果）","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1550625622,"ip_address":"","comment_id":67978,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1550373807","product_id":100020801,"comment_content":"老师 有个问题：online ddl不阻塞增删改操作，在ddl期间的查询操作是如何处理的呢？如何处理才能让ddl期间的查询得到正确结果呢？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":439452,"discussion_content":"在这边文章里面介绍的online ddl流程你再看下，这个策略，是可以保证的可以查到正确结果的（正确结果就是ddl还没完成之前，应该查到ddl之前的表的结果）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550625622,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":64872,"user_name":"菜鸡一只","can_delete":false,"product_type":"c1","uid":1336004,"ip_address":"","ucode":"5FBA9A68E0E9B9","user_header":"https://static001.geekbang.org/account/avatar/00/14/62/c4/98a9e594.jpg","comment_is_top":false,"comment_ctime":1548934988,"is_pvip":false,"replies":[{"id":"22951","content":"1. 是的，要用再替换<br>2. 不会了，重建保留就是给这个时候用的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1548940186,"ip_address":"","comment_id":64872,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1548934988","product_id":100020801,"comment_content":"1.当delete数据时其实是标记删除，把删除的空间标记为可复用，那么我想问一下delete将空间标记为可复用时会把原数据删除吗，还是当下一个数据复用这个标记空间才把原数据替换删除？<br>2.当插入数据时，数据页也会像重建表一样预留1&#47;16的空间吗？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438214,"discussion_content":"1. 是的，要用再替换\n2. 不会了，重建保留就是给这个时候用的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548940186,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":62939,"user_name":"念你如昔","can_delete":false,"product_type":"c1","uid":1323531,"ip_address":"","ucode":"FCAD88AB57D084","user_header":"https://static001.geekbang.org/account/avatar/00/14/32/0b/981b4e93.jpg","comment_is_top":false,"comment_ctime":1548210873,"is_pvip":false,"replies":[{"id":"22255","content":"purge cleaner可不是做这个事情的哦","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1548224334,"ip_address":"","comment_id":62939,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1548210873","product_id":100020801,"comment_content":"不是会有 purge cleaner 线程去 清理回收 带有delete 标记的数据行吗，文件应该会减小，但是空间可能没有被复用会出现碎片。线上环境  做alter table engine=innodb是很少的。 ","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437413,"discussion_content":"purge cleaner可不是做这个事情的哦","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548224334,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1788647,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/4a/e7/6c16af5d.jpg","nickname":"汉江","note":"","ucode":"01622D984B8F9B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":341911,"discussion_content":" purge cleaner 是清理undolog的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1610541090,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":60674,"user_name":"Jobs","can_delete":false,"product_type":"c1","uid":1014824,"ip_address":"","ucode":"7745742129EDFC","user_header":"https://static001.geekbang.org/account/avatar/00/0f/7c/28/cb6d8768.jpg","comment_is_top":false,"comment_ctime":1547528708,"is_pvip":false,"replies":[{"id":"21665","content":"哈哈 操心好呀<br><br>分区表那篇会说到吧，不过说实话，delete也就只能delete，最多分成小片删","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547551623,"ip_address":"","comment_id":60674,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1547528708","product_id":100020801,"comment_content":"会开一两篇答疑讲一讲如何优化delete和insert几百几千万的数据吗?最近作为一个普通开发的我操着DBA的心。。","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":436578,"discussion_content":"哈哈 操心好呀\n\n分区表那篇会说到吧，不过说实话，delete也就只能delete，最多分成小片删","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547551623,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":60014,"user_name":"天使梦泪","can_delete":false,"product_type":"c1","uid":1235750,"ip_address":"","ucode":"782991747DD424","user_header":"https://static001.geekbang.org/account/avatar/00/12/db/26/3c8d68fb.jpg","comment_is_top":false,"comment_ctime":1547437060,"is_pvip":false,"replies":[{"id":"21525","content":"不用真正删除，可以复用的时候覆盖掉就好了。","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547449855,"ip_address":"","comment_id":60014,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1547437060","product_id":100020801,"comment_content":"老师，我有个问题：delete语句是把要删除的数据标记为删除状态，什么时候会把这些数据真正删除呢？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":436437,"discussion_content":"不用真正删除，可以复用的时候覆盖掉就好了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547449855,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58510,"user_name":"杰之7","can_delete":false,"product_type":"c1","uid":1297232,"ip_address":"","ucode":"F7DA2E21085332","user_header":"https://static001.geekbang.org/account/avatar/00/13/cb/50/66d0bd7f.jpg","comment_is_top":false,"comment_ctime":1547097703,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1547097703","product_id":100020801,"comment_content":"通过这一节的阅读学习，了解了删除表中的数据以后，表的大小并没有减少，这种现象我们叫做空洞，对于增删改都会产生这种现象。为什么会是这样，我想是计算机系统或许内存方面的内容。<br><br>对于这种现象，老师给予的解决方法是重建表，就是将原表数据重新建立在一张表。同时在高版本Mysql的Innodb支持online操作，同时，老师解释了onplace和inplace的区别。<br><br>中途有两个礼拜没有跟上进度学习，很惭愧，接下来一月会尽快跟上老师的步伐。","like_count":0},{"had_liked":false,"id":54214,"user_name":"海曙云崖","can_delete":false,"product_type":"c1","uid":1303371,"ip_address":"","ucode":"DCAA7816359B14","user_header":"https://static001.geekbang.org/account/avatar/00/13/e3/4b/5046906a.jpg","comment_is_top":false,"comment_ctime":1545808205,"is_pvip":false,"replies":[{"id":"19612","content":"Show processlist可以看到<br><br>不过MDL锁阶段很短","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545815200,"ip_address":"","comment_id":54214,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1545808205","product_id":100020801,"comment_content":"怎么判断online DDL 的阶段是在MDL还是读锁阶段呢","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434394,"discussion_content":"Show processlist可以看到\n\n不过MDL锁阶段很短","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545815200,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":52034,"user_name":"zzkkll99","can_delete":false,"product_type":"c1","uid":1302565,"ip_address":"","ucode":"ECB94A2B94D145","user_header":"https://static001.geekbang.org/account/avatar/00/13/e0/25/d87b1c9b.jpg","comment_is_top":false,"comment_ctime":1545298082,"is_pvip":false,"replies":[{"id":"18829","content":"你说的原数据是说表里的数据吗？<br><br>MySQL 官方版本还不支持只改表结构😓","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545300423,"ip_address":"","comment_id":52034,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1545298082","product_id":100020801,"comment_content":"老师我想问一下，为什么对表结构进行修改要读原数据。不可以直接修改吗","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433713,"discussion_content":"你说的原数据是说表里的数据吗？\n\nMySQL 官方版本还不支持只改表结构😓","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545300423,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":51285,"user_name":"Bolor","can_delete":false,"product_type":"c1","uid":1314048,"ip_address":"","ucode":"536456A7D5FB0C","user_header":"https://static001.geekbang.org/account/avatar/00/14/0d/00/ed8ce979.jpg","comment_is_top":false,"comment_ctime":1545146473,"is_pvip":false,"replies":[{"id":"18512","content":"一般有两个硬盘的话，大家都这么做哦😄","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545150369,"ip_address":"","comment_id":51285,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1545146473","product_id":100020801,"comment_content":"老师，请问redo log数据页可以和数据隔开放到另一张ssd盘提升效率吗？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433381,"discussion_content":"一般有两个硬盘的话，大家都这么做哦😄","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545150369,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1285652,"avatar":"","nickname":"mycat","note":"","ucode":"6878BD32D042F2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":305746,"discussion_content":"那binlog是不是也需要单独挂一个盘？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600073935,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":50362,"user_name":"刘文韬","can_delete":false,"product_type":"c1","uid":1312479,"ip_address":"","ucode":"41395E6036D516","user_header":"https://static001.geekbang.org/account/avatar/00/14/06/df/d0fe2300.jpg","comment_is_top":false,"comment_ctime":1544962267,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1544962267","product_id":100020801,"comment_content":"请问新建表是不是要保存老表的快照，才能使用row log恢复数据呀？这个快照是怎么保存的呢？","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":158009,"discussion_content":"为啥有老表了，还要个老表的快照","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580541234,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":50303,"user_name":"臧天霸","can_delete":false,"product_type":"c1","uid":1302804,"ip_address":"","ucode":"F53FB15E7BD17A","user_header":"https://static001.geekbang.org/account/avatar/00/13/e1/14/006e8b9b.jpg","comment_is_top":false,"comment_ctime":1544948610,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1544948610","product_id":100020801,"comment_content":"老师，第一次提问，烦请解惑：<br>1.alter table t engine = innodb;后表及索引的统计信息也会跟着自动重建吗？<br>2.如果表及索引的统计信息没有跟着自动重建，那此时会使用表及索引旧的统计信息?或者是达到统计信息重新收集阈值后再收集？","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":158010,"discussion_content":"主键索引会重建，普通索引就没有吧。毕竟是重新建立表。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580541444,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":50272,"user_name":"WL","can_delete":false,"product_type":"c1","uid":1173771,"ip_address":"","ucode":"6277DCD776B87E","user_header":"https://static001.geekbang.org/account/avatar/00/11/e9/0b/1171ac71.jpg","comment_is_top":false,"comment_ctime":1544939916,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1544939916","product_id":100020801,"comment_content":"思考题: 我分析可能是重建之前的表本身的空洞数量就很少, 而重建之后可能在插入数据的时候造成了页分裂的情况, 所以重建过后比重建前大了一点点.","like_count":0},{"had_liked":false,"id":50248,"user_name":"WL","can_delete":false,"product_type":"c1","uid":1173771,"ip_address":"","ucode":"6277DCD776B87E","user_header":"https://static001.geekbang.org/account/avatar/00/11/e9/0b/1171ac71.jpg","comment_is_top":false,"comment_ctime":1544933084,"is_pvip":false,"replies":[{"id":"18059","content":"1. 所有字段都拷的。 <br>    因为加了MDL读锁，所以不存在“其它线程对A增删字段”<br><br>2. 可以inplace. 而且跟空洞有多少无关，重建语句5.6以后就都可以","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544944898,"ip_address":"","comment_id":50248,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544933084","product_id":100020801,"comment_content":"想请教老师两个问题:<br>1.文章中提到&quot;Alter 语句在启动的时候需要获取 MDL 写锁，但是这个写锁在真正拷贝数据之前就退化成读锁了。&quot;那么在重建表从表A到temp_file的copy过程中是连表A的各个字段一同拷贝到temp_file了吗?<br>如果是的话, 是因为需要复制原表A的字段到temp_file, 而这个操作被认为是对表做结构变更的操作，所以才加 MDL 写锁, 后面进行数据拷贝的时候不需要对元数据操作了, 所以就就退化成DML读锁, 那么如果在copy数据的过程中对于表A的有增删字段的操作怎么办, 也会记录到row log中吗? <br>如果没有copy表A的各个字段到temp_file, 那么为什么又需要MDL的写锁呢, 因为并没有对于表A的元数据进行操作?<br>2. 对于一个1T的表, 如果这个表绝大部分都是空洞, 只用真正有数据的记录加起来只有0.1T, 这样是否可以可以做inplace的DDL呢?","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432926,"discussion_content":"1. 所有字段都拷的。 \n    因为加了MDL读锁，所以不存在“其它线程对A增删字段”\n\n2. 可以inplace. 而且跟空洞有多少无关，重建语句5.6以后就都可以","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544944898,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49992,"user_name":"当下","can_delete":false,"product_type":"c1","uid":1304326,"ip_address":"","ucode":"2B8B003F94BC07","user_header":"https://static001.geekbang.org/account/avatar/00/13/e7/06/76ee65a1.jpg","comment_is_top":false,"comment_ctime":1544828265,"is_pvip":false,"replies":[{"id":"18006","content":"表如果更新量不大，是可能一直不用更新的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544846177,"ip_address":"","comment_id":49992,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544828265","product_id":100020801,"comment_content":"myssql有策略自动更新统计信息，可是有的表统计信息几个月都没跟新，这是怎么回事?","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432831,"discussion_content":"表如果更新量不大，是可能一直不用更新的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544846177,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49778,"user_name":"💦","can_delete":false,"product_type":"c1","uid":1163844,"ip_address":"","ucode":"E9E342A9E767C2","user_header":"https://static001.geekbang.org/account/avatar/00/11/c2/44/d1b135d1.jpg","comment_is_top":false,"comment_ctime":1544768171,"is_pvip":false,"replies":[{"id":"17948","content":"看之久干了啥，如果很快插入新的数据复用这些位置，就没啥关系","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544777862,"ip_address":"","comment_id":49778,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544768171","product_id":100020801,"comment_content":"老师，在大量的删除操作后产生的空洞对查询效率会有多大的影响呢？<br>","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432769,"discussion_content":"看之久干了啥，如果很快插入新的数据复用这些位置，就没啥关系","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544777862,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49663,"user_name":"每天晒白牙","can_delete":false,"product_type":"c1","uid":1004698,"ip_address":"","ucode":"A1B102CD933DEA","user_header":"https://static001.geekbang.org/account/avatar/00/0f/54/9a/76c0af70.jpg","comment_is_top":false,"comment_ctime":1544750733,"is_pvip":false,"discussion_count":0,"race_medal":1,"score":"1544750733","product_id":100020801,"comment_content":"老师我又来了，这个不能回复老师的回复，有点麻烦<br>online重建表我觉得删除可能会出现空洞但不会出现页分裂。这点老师好像是赞同的。<br>插入我觉得不会出现页分裂和空洞，理由是更新操作先写到日志中，然后在对插入，这样id是递增的，所以应该不会出现页分裂(在非尾部插入才可能会发生页分裂，因为重建表嗯id是更新的)和空洞呀","like_count":0},{"had_liked":false,"id":49617,"user_name":"每天晒白牙","can_delete":false,"product_type":"c1","uid":1004698,"ip_address":"","ucode":"A1B102CD933DEA","user_header":"https://static001.geekbang.org/account/avatar/00/0f/54/9a/76c0af70.jpg","comment_is_top":false,"comment_ctime":1544747413,"is_pvip":false,"replies":[{"id":"17865","content":"2. 插入也是可能的哦<br><br>3. 普通索引也可能发生分裂（可能会满就可能发生）。其它的说的很好","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544749964,"ip_address":"","comment_id":49617,"utype":1}],"discussion_count":1,"race_medal":1,"score":"1544747413","product_id":100020801,"comment_content":"针对undifined问的，我说下<br>2.页分裂发生在插入数据的时候，空洞发生在删除数据或插入数据的时候<br> 非online重建表的过程中丢失更新的数据，online重建表的过程中有更新数据是写在 row log中的，然后在按id顺序递增的插入到后面，所以不会出现页分裂和空洞，但是如果是删除数据，我觉得是可能出现空洞的，对吗老师？<br>3. 页分裂是针对数据页而言的，页中会存储数据，主键索引和普通索引不同，普通索引存储普通索引值和对应的主键索引值。主键索引存储主键和对应的数据","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432687,"discussion_content":"2. 插入也是可能的哦\n\n3. 普通索引也可能发生分裂（可能会满就可能发生）。其它的说的很好","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544749964,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49597,"user_name":"当下","can_delete":false,"product_type":"c1","uid":1304326,"ip_address":"","ucode":"2B8B003F94BC07","user_header":"https://static001.geekbang.org/account/avatar/00/13/e7/06/76ee65a1.jpg","comment_is_top":false,"comment_ctime":1544745146,"is_pvip":false,"replies":[{"id":"17867","content":"mysql认为它的策略会在“很不准”前自动更新，但如果你发现太不准就要手动更新…","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544750169,"ip_address":"","comment_id":49597,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544745146","product_id":100020801,"comment_content":"如果表的统计信息没更新情况下,如何准确计算碎片的百分比?","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432678,"discussion_content":"mysql认为它的策略会在“很不准”前自动更新，但如果你发现太不准就要手动更新…","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544750169,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49499,"user_name":"风萧雨瑟","can_delete":false,"product_type":"c1","uid":1317323,"ip_address":"","ucode":"5E832ABE126393","user_header":"https://static001.geekbang.org/account/avatar/00/14/19/cb/70a2b47e.jpg","comment_is_top":false,"comment_ctime":1544699253,"is_pvip":false,"replies":[{"id":"17803","content":"嗯，那就是实锤你放redo log的盘性能不好，或者压力过大哦","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544709209,"ip_address":"","comment_id":49499,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544699253","product_id":100020801,"comment_content":"老师，13篇里问您的innodb_flush_log_at_trx_commit 当值设置为1和2 磁盘压力的问题<br>这个从库上从监控上看每秒钟执行的事务在330左右，在主从复制延迟的情况下当我将innodb_flush_log_at_trx_commit=2设置为2的时候最高可以跳到2000以上，主从复制延迟在迅速恢复。从监控上来看结果的话。在innodb_flush_log_at_trx_commit=1的情况下最多也就跑到300多就已经到达顶点了。","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432636,"discussion_content":"嗯，那就是实锤你放redo log的盘性能不好，或者压力过大哦","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544709209,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49473,"user_name":"☞","can_delete":false,"product_type":"c1","uid":1302793,"ip_address":"","ucode":"6FAEF05F234D2A","user_header":"https://static001.geekbang.org/account/avatar/00/13/e1/09/9483f537.jpg","comment_is_top":false,"comment_ctime":1544694093,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1544694093","product_id":100020801,"comment_content":"老师请教下：<br>        在inplace里面还分是不是需要rebuilds表，我理解需要rebuild表的这部分操作是肯定需要空间的，比如add column，但是比如add index这种不需要rebuild表的操作呢，也占用空间吗<br>1、从空间上来和rebuild表有什么差异吗，rebuild相当于是copy表数据，非rebuild占用空间是存放什么<br>2、如果非rebuild操作也需要占用空间，这部分空间怎么去看，应该不会是和rebuild一样占用大约表大小这么大的空间吧<br>谢谢老师","like_count":0},{"had_liked":false,"id":49458,"user_name":"郭江伟","can_delete":false,"product_type":"c1","uid":1313994,"ip_address":"","ucode":"613D638619B5A2","user_header":"https://static001.geekbang.org/account/avatar/00/14/0c/ca/6173350b.jpg","comment_is_top":false,"comment_ctime":1544691833,"is_pvip":false,"replies":[{"id":"17779","content":"不是binlog,是引擎内部维护的一个操作日志","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544693680,"ip_address":"","comment_id":49458,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1544691833","product_id":100020801,"comment_content":"原表t 有1T， 执行alter table t engine =Innodb;变为1.01T 可能是DDL过程中有数据插入或者修改；<br>另外请问下老师：执行alter table t engine =Innodb时记录的row log 是否就是这个表的binlog，如果DDL过程中记录了该表的binlog ，然后应用此binlog也可以实现类似的功能。","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432625,"discussion_content":"不是binlog,是引擎内部维护的一个操作日志","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544693680,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1285652,"avatar":"","nickname":"mycat","note":"","ucode":"6878BD32D042F2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":305748,"discussion_content":"这个rowlog，对我们来说，是不是不可见的？不像binlog或者redolog一样，我们可以在磁盘的某个路径下看到？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600074321,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49417,"user_name":"当下","can_delete":false,"product_type":"c1","uid":1304326,"ip_address":"","ucode":"2B8B003F94BC07","user_header":"https://static001.geekbang.org/account/avatar/00/13/e7/06/76ee65a1.jpg","comment_is_top":false,"comment_ctime":1544684218,"is_pvip":false,"replies":[{"id":"17784","content":"1.  如果称为inplace,就是这个过程<br>2. 是提示，不是错误<br>3. 看页面空间占用率","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544695835,"ip_address":"","comment_id":49417,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544684218","product_id":100020801,"comment_content":"小结：<br><br>1.delete操作会生成插入相同记录的记录复用和page复用<br>2.delete会产生page空洞，随机insert也会产生page空洞(页分裂)，索引update分解为delete和insert也会产生空洞<br>3.重建表可以使数据在page上更紧凑<br>4.alter table tb_name engine=innodb 在非online ddl 时server层生成临时表且mdl写锁，阻塞其他会话dml操作，锁阻塞时间久。在online ddl时，时innodb引擎操作步骤：<br>a.扫描表页，获取表的dml读锁;<br>b.将表页复制到一个临时文件，以b+树格式存储;<br>c.在扫描和复制page的过程生成row.log日志记录ddl复制过程的dml操作;<br>d.将row.log操作日志应用到临时文件;<br>e.获取dml的写锁，临时文件与表文件替换<br><br>5.ddl online时，innodb表加全文索引时，会阻塞dml操作，其实效果与非online ddl一样的。ddl online一定是inplace;inplace 的ddl不一定是online,例如:添加fulltext索引和spatial索引<br>6.optimize table 重建表及索引，收集统计信息<br>alter table tb engine=innodb 重建表其实也收集统计信息<br>analyze table tb 重新收集统计信息<br><br>问题：<br>1.online ddl时，是不是所有的inplace操作都会生成一个表的临时文件?<br>2.optimize table时提示“table does not support optimize.doing recreate+analyze instead”是错误提示吗?<br>3.分裂page的合并是怎么触发的?<br><br>","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432610,"discussion_content":"1.  如果称为inplace,就是这个过程\n2. 是提示，不是错误\n3. 看页面空间占用率","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544695835,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49346,"user_name":"Ryoma","can_delete":false,"product_type":"c1","uid":1130590,"ip_address":"","ucode":"7F692369239692","user_header":"https://static001.geekbang.org/account/avatar/00/11/40/5e/b8fada94.jpg","comment_is_top":false,"comment_ctime":1544668809,"is_pvip":true,"discussion_count":1,"race_medal":2,"score":"1544668809","product_id":100020801,"comment_content":"有两个问题想问一下老师：<br>0. 数据页的排列是不是以链表的方式排列的，不然在发生两个数据页合并时候，另一个数据页如何被复用呢<br>1. Online DDL生成临时过程中，如果插入了一条R3&#39;的数据，这样在重放过程中是不是有可能会导致数据页分裂呢（比如R3 R4所在Page已满，此时插入R3&#39;）<br>","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":158019,"discussion_content":"0：是的。\n1：如果插入一条应该不会吧，不是留了1/16的空间嘛。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580542506,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49329,"user_name":"田小树","can_delete":false,"product_type":"c1","uid":1313308,"ip_address":"","ucode":"CCD52612ECC33E","user_header":"https://static001.geekbang.org/account/avatar/00/14/0a/1c/efb2aba2.jpg","comment_is_top":false,"comment_ctime":1544667084,"is_pvip":false,"replies":[{"id":"17754","content":"额，这样根据时间查肯定慢呀，时间字段上没索引，没法“快速查找”呀","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544675430,"ip_address":"","comment_id":49329,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544667084","product_id":100020801,"comment_content":"老师，你让贴出来，可是我不能直接给你回复呀，只好这样了。<br>CREATE TABLE `ms_sign_in_record` (<br>  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#39;主键ID&#39;,<br>  `user_id` bigint(20) NOT NULL COMMENT &#39;会员id&#39;,<br>  `record_type` tinyint(4) NOT NULL COMMENT &#39;类型:1.普通签到、2.补签(补签券)、3.补签(福豆)&#39;,<br>  `sign_time` timestamp NULL DEFAULT NULL COMMENT &#39;签到日期&#39;,<br>  `create_time` timestamp NULL DEFAULT NULL COMMENT &#39;创建时间&#39;,<br>  `update_time` timestamp NULL DEFAULT NULL COMMENT &#39;更新时间&#39;,<br>  PRIMARY KEY (`id`)<br>) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT=&#39;签到记录流水表，记录单日签到及抽奖结果信息&#39;;","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432578,"discussion_content":"额，这样根据时间查肯定慢呀，时间字段上没索引，没法“快速查找”呀","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544675430,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49187,"user_name":"包包up","can_delete":false,"product_type":"c1","uid":1073495,"ip_address":"","ucode":"A6F51A62A8B362","user_header":"https://static001.geekbang.org/account/avatar/00/10/61/57/6f3c81dd.jpg","comment_is_top":false,"comment_ctime":1544619410,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1544619410","product_id":100020801,"comment_content":"可能原因是这个表本来就是紧密的，没有必要去做alter table t engine=InnoDB；操作。在recreate table的过程中原表有新的插入操作，最后发现文件还变大了。<br>也有可能在recreate table的过程中有大量打插入操作，导致最后的文件变大了。<br>","like_count":0},{"had_liked":false,"id":49177,"user_name":"skating","can_delete":false,"product_type":"c1","uid":1209971,"ip_address":"","ucode":"EA89EA34C78EB9","user_header":"https://static001.geekbang.org/account/avatar/00/12/76/73/5da49573.jpg","comment_is_top":false,"comment_ctime":1544617715,"is_pvip":false,"replies":[{"id":"17643","content":"自增插入，没删除的话，可以认为主键索引是紧凑的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544622472,"ip_address":"","comment_id":49177,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544617715","product_id":100020801,"comment_content":"如果我们的表用的是自增主键id就不用重建表这个过程了吧","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432517,"discussion_content":"自增插入，没删除的话，可以认为主键索引是紧凑的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544622472,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49160,"user_name":"风萧雨瑟","can_delete":false,"product_type":"c1","uid":1317323,"ip_address":"","ucode":"5E832ABE126393","user_header":"https://static001.geekbang.org/account/avatar/00/14/19/cb/70a2b47e.jpg","comment_is_top":false,"comment_ctime":1544612979,"is_pvip":false,"replies":[{"id":"17642","content":"你数据和redolog是放在同一个盘的吧？直接看这个盘的随机iops能力。<br><br><br>看上面结果不是很好，但也还行，性能上这个从库一秒执行多少个事务呀？","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544622427,"ip_address":"","comment_id":49160,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544612979","product_id":100020801,"comment_content":"老师，13篇里问您的innodb_flush_log_at_trx_commit 当值设置为1和2 磁盘压力的问题。我通过fio两台机器上做了测试。<br>有问题机器<br>随机写<br>fio -ioengine=libaio -bs=16k -direct=1 -thread -rw=randwrite  -size=100G -filename=&#47;data1&#47;fio_randr_write_test2.txt -name=&#39;fiotest&#39; -iodepth=4 -runtime=100<br>iops        : min= 7832, max=14890, avg=11606.47, stdev=1252.62, samples=199<br>顺序写<br>fio -ioengine=libaio -bs=16k -direct=1 -thread -rw=write  -size=100G -filename=&#47;data2&#47;fio_rand_write_test3.txt -name=&#39;fiotest&#39; -iodepth=4 -runtime=100<br>iops        : min=16784, max=23028, avg=20018.49, stdev=972.28, samples=199<br>机器上的两块硬盘测试结果基本一样。随机写和顺序写的最大值差6000左右。<br>测试了正常从库(跟有问题的这个不是同一批)的，随机写和顺序写的最大值相差不大。同一批机器我测试了三台，有两台随机写和顺序的最大差值是6000左右。<br>但redo是顺序写，影响应该不会大吧？  redo log和数据在一个盘上。 ","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432507,"discussion_content":"你数据和redolog是放在同一个盘的吧？直接看这个盘的随机iops能力。\n\n\n看上面结果不是很好，但也还行，性能上这个从库一秒执行多少个事务呀？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544622427,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49131,"user_name":"布衣骇客","can_delete":false,"product_type":"c1","uid":1256280,"ip_address":"","ucode":"5226B0F67090D1","user_header":"https://static001.geekbang.org/account/avatar/00/13/2b/58/11c05ccb.jpg","comment_is_top":false,"comment_ctime":1544608832,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1544608832","product_id":100020801,"comment_content":"先回答下问题，第一种可能，在重建的时候出现，insert和update交替进行的时候出现了页分裂的情况，第二种，还有出现了删除，导致索引不连续，等也会出线上述情况。我的个人问题，在 做CURD的时候，做delet的时候，只是删除数据，会 保留数据空间，然后这个delet产生的日志在redo log中，如果出现误删是可以更具日志恢复的，但是Truncate 用得少，这个在我个人查找资料好像是永久删除，是直接删除数据以及表空间吗？也不会存在rode log的日志里是吗？如有错误，麻烦不吝赐教，谢谢","like_count":0},{"had_liked":false,"id":49097,"user_name":"田小树","can_delete":false,"product_type":"c1","uid":1313308,"ip_address":"","ucode":"CCD52612ECC33E","user_header":"https://static001.geekbang.org/account/avatar/00/14/0a/1c/efb2aba2.jpg","comment_is_top":false,"comment_ctime":1544603434,"is_pvip":false,"replies":[{"id":"17640","content":"表结构和SQL贴一下","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544617700,"ip_address":"","comment_id":49097,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1544603434","product_id":100020801,"comment_content":"老师，请教一个问题：一个表几百万数据，根据id查询很快，根据日期范围查询很慢，怎么办？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432483,"discussion_content":"表结构和SQL贴一下","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544617700,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":158021,"discussion_content":"那在日期字段上建立索引呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580542724,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":49006,"user_name":"尘封","can_delete":false,"product_type":"c1","uid":1247006,"ip_address":"","ucode":"CEE0C006387A03","user_header":"https://static001.geekbang.org/account/avatar/00/13/07/1e/bdbe93f4.jpg","comment_is_top":false,"comment_ctime":1544587236,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1544587236","product_id":100020801,"comment_content":"对于修改列的comment信息，删除索引来说，是不是就不要临时表了，直接修改元数据即可？","like_count":0},{"had_liked":false,"id":48996,"user_name":"朋朋 mart 💻","can_delete":false,"product_type":"c1","uid":1130333,"ip_address":"","ucode":"31C1FB164F2F91","user_header":"https://static001.geekbang.org/account/avatar/00/11/3f/5d/75e98cd4.jpg","comment_is_top":false,"comment_ctime":1544586423,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1544586423","product_id":100020801,"comment_content":"1. 表空间本身就很就凑 , 可回收的页空洞很少 .<br>2. 在进行重建表操作时 , 有大量的insert操作<br>3. 重建表回收的空间小于Insert操作占用的空间<br>4. 导致表重建后 , 表空间不减反增","like_count":0},{"had_liked":false,"id":48966,"user_name":"倪大人","can_delete":false,"product_type":"c1","uid":1193052,"ip_address":"","ucode":"4798D69F3E86FB","user_header":"https://static001.geekbang.org/account/avatar/00/12/34/5c/6b4757a0.jpg","comment_is_top":false,"comment_ctime":1544583130,"is_pvip":false,"replies":[{"id":"17575","content":"是有可能的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544584358,"ip_address":"","comment_id":48966,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544583130","product_id":100020801,"comment_content":"老师求问下图4，如果R7不是插入到最后，而是插入R3、R4之间，是会造成页分裂吗？分裂之后会有新的“空洞”产生？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432441,"discussion_content":"是有可能的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544584358,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":48961,"user_name":"ʸᵉ ᶠᵉᶮᵍ","can_delete":false,"product_type":"c1","uid":1280969,"ip_address":"","ucode":"BD6B8B01F78A21","user_header":"https://static001.geekbang.org/account/avatar/00/13/8b/c9/4281a2a3.jpg","comment_is_top":false,"comment_ctime":1544582093,"is_pvip":false,"replies":[{"id":"17578","content":"“optimize table t 等于 recreate+analyze”<br><br>","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544584674,"ip_address":"","comment_id":48961,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544582093","product_id":100020801,"comment_content":"可是老师,我在平时都是用optimize table这个命令来回收表空间的,这个命令希望老师能详细讲一下","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432437,"discussion_content":"“optimize table t 等于 recreate+analyze”\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544584674,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":48944,"user_name":"锅子","can_delete":false,"product_type":"c1","uid":1323048,"ip_address":"","ucode":"4A9143AFB07FF2","user_header":"https://static001.geekbang.org/account/avatar/00/14/30/28/6e019a7a.jpg","comment_is_top":false,"comment_ctime":1544580770,"is_pvip":false,"replies":[{"id":"17587","content":"会","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544586412,"ip_address":"","comment_id":48944,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544580770","product_id":100020801,"comment_content":"老师好，有一个问题在图4的第五步中，用临时文件替换表A，这个替换动作会不会对表重新加上MDL写锁呢？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432430,"discussion_content":"会","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544586412,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":48939,"user_name":"春困秋乏夏打盹","can_delete":false,"product_type":"c1","uid":1210807,"ip_address":"","ucode":"CCC558EF504F4B","user_header":"https://static001.geekbang.org/account/avatar/00/12/79/b7/989824f7.jpg","comment_is_top":false,"comment_ctime":1544580133,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1544580133","product_id":100020801,"comment_content":"紧凑表变稀疏","like_count":0},{"had_liked":false,"id":48922,"user_name":"风轨","can_delete":false,"product_type":"c1","uid":1185844,"ip_address":"","ucode":"7B8A5233B61EB0","user_header":"https://static001.geekbang.org/account/avatar/00/12/18/34/c082419c.jpg","comment_is_top":false,"comment_ctime":1544578250,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1544578250","product_id":100020801,"comment_content":"可能还是页分裂，主键连续不代表其他索引也连续，可能其他索引太多，且不连续。","like_count":0},{"had_liked":false,"id":48920,"user_name":"许海涛","can_delete":false,"product_type":"c1","uid":1307820,"ip_address":"","ucode":"25AED1BBDF4B54","user_header":"https://static001.geekbang.org/account/avatar/00/13/f4/ac/2cedea87.jpg","comment_is_top":false,"comment_ctime":1544578052,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1544578052","product_id":100020801,"comment_content":"1.如果没有使用独立表空间，在共享表空间下空间不会得到释放<br>2.猜测online ddl下大量数据写入？","like_count":0},{"had_liked":false,"id":48914,"user_name":"W_T","can_delete":false,"product_type":"c1","uid":1044071,"ip_address":"","ucode":"1A78F28537E138","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ee/67/c146c144.jpg","comment_is_top":false,"comment_ctime":1544577750,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1544577750","product_id":100020801,"comment_content":"老师早<br>文末的问题我整理得三种可能性：<br>1. 表空间本身就很紧凑，能回收的部分很少，极端情况下甚至没有。回收结束后又有新数据进来，空间不减反增。<br>2. 回收规程中大量数据进表，新占用的空间比回收的还多。<br>3. 回收过程出现异常，回收失败了。","like_count":0},{"had_liked":false,"id":48911,"user_name":"星期六男爵","can_delete":false,"product_type":"c1","uid":1201316,"ip_address":"","ucode":"EE6DCECB6801BA","user_header":"https://static001.geekbang.org/account/avatar/00/12/54/a4/6ace02b2.jpg","comment_is_top":false,"comment_ctime":1544577560,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1544577560","product_id":100020801,"comment_content":"最近正在搞表空间缩小的方案，学习了。","like_count":0},{"had_liked":false,"id":48897,"user_name":"Arvin LI","can_delete":false,"product_type":"c1","uid":1275595,"ip_address":"","ucode":"23AA16137DBF6B","user_header":"https://static001.geekbang.org/account/avatar/00/13/76/cb/ca506ee2.jpg","comment_is_top":false,"comment_ctime":1544576661,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1544576661","product_id":100020801,"comment_content":"执行为online DDL，也就是说构建的时候允许插入数据操作，变大有可能是插入了大量新数据造成的。","like_count":0},{"had_liked":false,"id":48873,"user_name":"小样","can_delete":false,"product_type":"c1","uid":1105414,"ip_address":"","ucode":"08B031FCA6DE7B","user_header":"https://static001.geekbang.org/account/avatar/00/10/de/06/fdfcc996.jpg","comment_is_top":false,"comment_ctime":1544575128,"is_pvip":false,"replies":[{"id":"17566","content":"额？最后不是有提到😓","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544582556,"ip_address":"","comment_id":48873,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544575128","product_id":100020801,"comment_content":"老师，请问OPTIMIZE TABLE命令和这篇讲解的碎片回收原理是相同的么？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432398,"discussion_content":"额？最后不是有提到😓","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544582556,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":48867,"user_name":"小样","can_delete":false,"product_type":"c1","uid":1105414,"ip_address":"","ucode":"08B031FCA6DE7B","user_header":"https://static001.geekbang.org/account/avatar/00/10/de/06/fdfcc996.jpg","comment_is_top":false,"comment_ctime":1544574625,"is_pvip":false,"replies":[{"id":"17567","content":"额，你这样描述我完全不知道怎么下手…","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544582592,"ip_address":"","comment_id":48867,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544574625","product_id":100020801,"comment_content":"老师，最近我遇到一个比较难以理解的问题，数据库资源占用率不高，CPU，内存，io等都是正常的，查看过也没有阻塞的事物或者SQL，但是执行语句都特别慢，哪怕是最简单的查询，最后重启服务之后恢复了，这种情况可能会是什么原因呢？谷歌了一通，没有找到任何相似性的问题，能请您分析一下么？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432394,"discussion_content":"额，你这样描述我完全不知道怎么下手…","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544582592,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":48866,"user_name":"天王","can_delete":false,"product_type":"c1","uid":1239337,"ip_address":"","ucode":"C074B2F9A5F007","user_header":"https://static001.geekbang.org/account/avatar/00/12/e9/29/629d9bb0.jpg","comment_is_top":false,"comment_ctime":1544574498,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1544574498","product_id":100020801,"comment_content":"一种可能是在重建表的过程中，有大量的表写入数据，写入的表数据比空洞释放的空间还要大，导致文件大小增加了。","like_count":0},{"had_liked":false,"id":48850,"user_name":"慧鑫coming","can_delete":false,"product_type":"c1","uid":1324385,"ip_address":"","ucode":"7BAC9CA255630E","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLE4LYb3jrH63ZV98Zpc8DompwDgb1O3nffMoZCmiaibauRyEFv6NDNsST9RWxZExvMLMWb50zaanoQ/132","comment_is_top":false,"comment_ctime":1544572373,"is_pvip":false,"replies":[{"id":"17569","content":"你们都这么早啊，优秀……","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1544582748,"ip_address":"","comment_id":48850,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544572373","product_id":100020801,"comment_content":"早","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432387,"discussion_content":"你们都这么早啊，优秀……","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544582748,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}