{"id":41366,"title":"21 | å®¹å™¨åŒ–å®ˆæŠ¤è¿›ç¨‹çš„æ„ä¹‰ï¼šDaemonSet","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å¼ ç£Šã€‚ä»Šå¤©æˆ‘å’Œä½ åˆ†äº«çš„ä¸»é¢˜æ˜¯ï¼šå®¹å™¨åŒ–å®ˆæŠ¤è¿›ç¨‹çš„æ„ä¹‰ä¹‹DaemonSetã€‚</p><p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å’Œä½ è¯¦ç»†åˆ†äº«äº†ä½¿ç”¨StatefulSetç¼–æ’â€œæœ‰çŠ¶æ€åº”ç”¨â€çš„è¿‡ç¨‹ã€‚ä»ä¸­ä¸éš¾çœ‹å‡ºï¼ŒStatefulSetå…¶å®å°±æ˜¯å¯¹ç°æœ‰å…¸å‹è¿ç»´ä¸šåŠ¡çš„å®¹å™¨åŒ–æŠ½è±¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ ä¸€å®šæœ‰æ–¹æ³•åœ¨ä¸ä½¿ç”¨Kubernetesã€ç”šè‡³ä¸ä½¿ç”¨å®¹å™¨çš„æƒ…å†µä¸‹ï¼Œè‡ªå·±DIYä¸€ä¸ªç±»ä¼¼çš„æ–¹æ¡ˆå‡ºæ¥ã€‚ä½†æ˜¯ï¼Œä¸€æ—¦æ¶‰åŠåˆ°å‡çº§ã€ç‰ˆæœ¬ç®¡ç†ç­‰æ›´å·¥ç¨‹åŒ–çš„èƒ½åŠ›ï¼ŒKubernetesçš„å¥½å¤„ï¼Œæ‰ä¼šæ›´åŠ å‡¸ç°ã€‚</p><p>æ¯”å¦‚ï¼Œå¦‚ä½•å¯¹StatefulSetè¿›è¡Œâ€œæ»šåŠ¨æ›´æ–°â€ï¼ˆrolling updateï¼‰ï¼Ÿ</p><p>å¾ˆç®€å•ã€‚ä½ åªè¦ä¿®æ”¹StatefulSetçš„Podæ¨¡æ¿ï¼Œå°±ä¼šè‡ªåŠ¨è§¦å‘â€œæ»šåŠ¨æ›´æ–°â€:</p><pre><code>$ kubectl patch statefulset mysql --type='json' -p='[{&quot;op&quot;: &quot;replace&quot;, &quot;path&quot;: &quot;/spec/template/spec/containers/0/image&quot;, &quot;value&quot;:&quot;mysql:5.7.23&quot;}]'\nstatefulset.apps/mysql patched\n</code></pre><p>åœ¨è¿™é‡Œï¼Œæˆ‘ä½¿ç”¨äº†kubectl patchå‘½ä»¤ã€‚å®ƒçš„æ„æ€æ˜¯ï¼Œä»¥â€œè¡¥ä¸â€çš„æ–¹å¼ï¼ˆJSONæ ¼å¼çš„ï¼‰ä¿®æ”¹ä¸€ä¸ªAPIå¯¹è±¡çš„æŒ‡å®šå­—æ®µï¼Œä¹Ÿå°±æ˜¯æˆ‘åœ¨åé¢æŒ‡å®šçš„â€œspec/template/spec/containers/0/imageâ€ã€‚</p><p>è¿™æ ·ï¼ŒStatefulSet Controllerå°±ä¼šæŒ‰ç…§ä¸Podç¼–å·ç›¸åçš„é¡ºåºï¼Œä»æœ€åä¸€ä¸ªPodå¼€å§‹ï¼Œé€ä¸€æ›´æ–°è¿™ä¸ªStatefulSetç®¡ç†çš„æ¯ä¸ªPodã€‚è€Œå¦‚æœæ›´æ–°å‘ç”Ÿäº†é”™è¯¯ï¼Œè¿™æ¬¡â€œæ»šåŠ¨æ›´æ–°â€å°±ä¼šåœæ­¢ã€‚æ­¤å¤–ï¼ŒStatefulSetçš„â€œæ»šåŠ¨æ›´æ–°â€è¿˜å…è®¸æˆ‘ä»¬è¿›è¡Œæ›´ç²¾ç»†çš„æ§åˆ¶ï¼Œæ¯”å¦‚é‡‘ä¸é›€å‘å¸ƒï¼ˆCanary Deployï¼‰æˆ–è€…ç°åº¦å‘å¸ƒï¼Œ<strong>è¿™æ„å‘³ç€åº”ç”¨çš„å¤šä¸ªå®ä¾‹ä¸­è¢«æŒ‡å®šçš„ä¸€éƒ¨åˆ†ä¸ä¼šè¢«æ›´æ–°åˆ°æœ€æ–°çš„ç‰ˆæœ¬ã€‚</strong></p><!-- [[[read_end]]] --><p>è¿™ä¸ªå­—æ®µï¼Œæ­£æ˜¯StatefulSetçš„spec.updateStrategy.rollingUpdateçš„partitionå­—æ®µã€‚</p><p>æ¯”å¦‚ï¼Œç°åœ¨æˆ‘å°†å‰é¢è¿™ä¸ªStatefulSetçš„partitionå­—æ®µè®¾ç½®ä¸º2ï¼š</p><pre><code>$ kubectl patch statefulset mysql -p '{&quot;spec&quot;:{&quot;updateStrategy&quot;:{&quot;type&quot;:&quot;RollingUpdate&quot;,&quot;rollingUpdate&quot;:{&quot;partition&quot;:2}}}}'\nstatefulset.apps/mysql patched\n</code></pre><p>å…¶ä¸­ï¼Œkubectl patchå‘½ä»¤åé¢çš„å‚æ•°ï¼ˆJSONæ ¼å¼çš„ï¼‰ï¼Œå°±æ˜¯partitionå­—æ®µåœ¨APIå¯¹è±¡é‡Œçš„è·¯å¾„ã€‚æ‰€ä»¥ï¼Œä¸Šè¿°æ“ä½œç­‰åŒäºç›´æ¥ä½¿ç”¨ kubectl editå‘½ä»¤ï¼Œæ‰“å¼€è¿™ä¸ªå¯¹è±¡ï¼ŒæŠŠpartitionå­—æ®µä¿®æ”¹ä¸º2ã€‚</p><p>è¿™æ ·ï¼Œæˆ‘å°±æŒ‡å®šäº†å½“Podæ¨¡æ¿å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œæ¯”å¦‚MySQLé•œåƒæ›´æ–°åˆ°5.7.23ï¼Œé‚£ä¹ˆåªæœ‰åºå·å¤§äºæˆ–è€…ç­‰äº2çš„Podä¼šè¢«æ›´æ–°åˆ°è¿™ä¸ªç‰ˆæœ¬ã€‚å¹¶ä¸”ï¼Œå¦‚æœä½ åˆ é™¤æˆ–è€…é‡å¯äº†åºå·å°äº2çš„Podï¼Œç­‰å®ƒå†æ¬¡å¯åŠ¨åï¼Œä¹Ÿä¼šä¿æŒåŸå…ˆçš„5.7.2ç‰ˆæœ¬ï¼Œç»ä¸ä¼šè¢«å‡çº§åˆ°5.7.23ç‰ˆæœ¬ã€‚</p><p>StatefulSetå¯ä»¥è¯´æ˜¯Kubernetesé¡¹ç›®ä¸­æœ€ä¸ºå¤æ‚çš„ç¼–æ’å¯¹è±¡ï¼Œå¸Œæœ›ä½ è¯¾åèƒ½è®¤çœŸæ¶ˆåŒ–ï¼ŒåŠ¨æ‰‹å®è·µä¸€ä¸‹è¿™ä¸ªä¾‹å­ã€‚</p><p>è€Œåœ¨ä»Šå¤©è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä¼šä¸ºä½ é‡ç‚¹è®²è§£ä¸€ä¸ªç›¸å¯¹è½»æ¾çš„çŸ¥è¯†ç‚¹ï¼šDaemonSetã€‚</p><p>é¡¾åæ€ä¹‰ï¼ŒDaemonSetçš„ä¸»è¦ä½œç”¨ï¼Œæ˜¯è®©ä½ åœ¨Kubernetesé›†ç¾¤é‡Œï¼Œè¿è¡Œä¸€ä¸ªDaemon Podã€‚ æ‰€ä»¥ï¼Œè¿™ä¸ªPodæœ‰å¦‚ä¸‹ä¸‰ä¸ªç‰¹å¾ï¼š</p><ol>\n<li>\n<p>è¿™ä¸ªPodè¿è¡Œåœ¨Kubernetesé›†ç¾¤é‡Œçš„æ¯ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆNodeï¼‰ä¸Šï¼›</p>\n</li>\n<li>\n<p>æ¯ä¸ªèŠ‚ç‚¹ä¸Šåªæœ‰ä¸€ä¸ªè¿™æ ·çš„Podå®ä¾‹ï¼›</p>\n</li>\n<li>\n<p>å½“æœ‰æ–°çš„èŠ‚ç‚¹åŠ å…¥Kubernetesé›†ç¾¤åï¼Œè¯¥Podä¼šè‡ªåŠ¨åœ°åœ¨æ–°èŠ‚ç‚¹ä¸Šè¢«åˆ›å»ºå‡ºæ¥ï¼›è€Œå½“æ—§èŠ‚ç‚¹è¢«åˆ é™¤åï¼Œå®ƒä¸Šé¢çš„Podä¹Ÿç›¸åº”åœ°ä¼šè¢«å›æ”¶æ‰ã€‚</p>\n</li>\n</ol><p>è¿™ä¸ªæœºåˆ¶å¬èµ·æ¥å¾ˆç®€å•ï¼Œä½†Daemon Podçš„æ„ä¹‰ç¡®å®æ˜¯éå¸¸é‡è¦çš„ã€‚æˆ‘éšä¾¿ç»™ä½ åˆ—ä¸¾å‡ ä¸ªä¾‹å­ï¼š</p><ol>\n<li>\n<p>å„ç§ç½‘ç»œæ’ä»¶çš„Agentç»„ä»¶ï¼Œéƒ½å¿…é¡»è¿è¡Œåœ¨æ¯ä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œç”¨æ¥å¤„ç†è¿™ä¸ªèŠ‚ç‚¹ä¸Šçš„å®¹å™¨ç½‘ç»œï¼›</p>\n</li>\n<li>\n<p>å„ç§å­˜å‚¨æ’ä»¶çš„Agentç»„ä»¶ï¼Œä¹Ÿå¿…é¡»è¿è¡Œåœ¨æ¯ä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œç”¨æ¥åœ¨è¿™ä¸ªèŠ‚ç‚¹ä¸ŠæŒ‚è½½è¿œç¨‹å­˜å‚¨ç›®å½•ï¼Œæ“ä½œå®¹å™¨çš„Volumeç›®å½•ï¼›</p>\n</li>\n<li>\n<p>å„ç§ç›‘æ§ç»„ä»¶å’Œæ—¥å¿—ç»„ä»¶ï¼Œä¹Ÿå¿…é¡»è¿è¡Œåœ¨æ¯ä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œè´Ÿè´£è¿™ä¸ªèŠ‚ç‚¹ä¸Šçš„ç›‘æ§ä¿¡æ¯å’Œæ—¥å¿—æœé›†ã€‚</p>\n</li>\n</ol><p>æ›´é‡è¦çš„æ˜¯ï¼Œè·Ÿå…¶ä»–ç¼–æ’å¯¹è±¡ä¸ä¸€æ ·ï¼ŒDaemonSetå¼€å§‹è¿è¡Œçš„æ—¶æœºï¼Œå¾ˆå¤šæ—¶å€™æ¯”æ•´ä¸ªKubernetesé›†ç¾¤å‡ºç°çš„æ—¶æœºéƒ½è¦æ—©ã€‚</p><p>è¿™ä¸ªä¹ä¸€å¬èµ·æ¥å¯èƒ½æœ‰ç‚¹å„¿å¥‡æ€ªã€‚ä½†å…¶å®ä½ æ¥æƒ³ä¸€ä¸‹ï¼šå¦‚æœè¿™ä¸ªDaemonSetæ­£æ˜¯ä¸€ä¸ªç½‘ç»œæ’ä»¶çš„Agentç»„ä»¶å‘¢ï¼Ÿ</p><p>è¿™ä¸ªæ—¶å€™ï¼Œæ•´ä¸ªKubernetesé›†ç¾¤é‡Œè¿˜æ²¡æœ‰å¯ç”¨çš„å®¹å™¨ç½‘ç»œï¼Œæ‰€æœ‰WorkerèŠ‚ç‚¹çš„çŠ¶æ€éƒ½æ˜¯NotReadyï¼ˆNetworkReady=falseï¼‰ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œæ™®é€šçš„Podè‚¯å®šä¸èƒ½è¿è¡Œåœ¨è¿™ä¸ªé›†ç¾¤ä¸Šã€‚æ‰€ä»¥ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€DaemonSetçš„è®¾è®¡ï¼Œå¿…é¡»è¦æœ‰æŸç§â€œè¿‡äººä¹‹å¤„â€æ‰è¡Œã€‚</p><p>ä¸ºäº†å¼„æ¸…æ¥šDaemonSetçš„å·¥ä½œåŸç†ï¼Œæˆ‘ä»¬è¿˜æ˜¯æŒ‰ç…§è€è§„çŸ©ï¼Œå…ˆä»å®ƒçš„APIå¯¹è±¡çš„å®šä¹‰è¯´èµ·ã€‚</p><pre><code>apiVersion: apps/v1\nkind: DaemonSet\nmetadata:\n  name: fluentd-elasticsearch\n  namespace: kube-system\n  labels:\n    k8s-app: fluentd-logging\nspec:\n  selector:\n    matchLabels:\n      name: fluentd-elasticsearch\n  template:\n    metadata:\n      labels:\n        name: fluentd-elasticsearch\n    spec:\n      tolerations:\n      - key: node-role.kubernetes.io/master\n        effect: NoSchedule\n      containers:\n      - name: fluentd-elasticsearch\n        image: k8s.gcr.io/fluentd-elasticsearch:1.20\n        resources:\n          limits:\n            memory: 200Mi\n          requests:\n            cpu: 100m\n            memory: 200Mi\n        volumeMounts:\n        - name: varlog\n          mountPath: /var/log\n        - name: varlibdockercontainers\n          mountPath: /var/lib/docker/containers\n          readOnly: true\n      terminationGracePeriodSeconds: 30\n      volumes:\n      - name: varlog\n        hostPath:\n          path: /var/log\n      - name: varlibdockercontainers\n        hostPath:\n          path: /var/lib/docker/containers\n</code></pre><p>è¿™ä¸ªDaemonSetï¼Œç®¡ç†çš„æ˜¯ä¸€ä¸ªfluentd-elasticsearché•œåƒçš„Podã€‚è¿™ä¸ªé•œåƒçš„åŠŸèƒ½éå¸¸å®ç”¨ï¼šé€šè¿‡fluentdå°†Dockerå®¹å™¨é‡Œçš„æ—¥å¿—è½¬å‘åˆ°ElasticSearchä¸­ã€‚</p><p>å¯ä»¥çœ‹åˆ°ï¼ŒDaemonSetè·ŸDeploymentå…¶å®éå¸¸ç›¸ä¼¼ï¼Œåªä¸è¿‡æ˜¯æ²¡æœ‰replicaså­—æ®µï¼›å®ƒä¹Ÿä½¿ç”¨selectoré€‰æ‹©ç®¡ç†æ‰€æœ‰æºå¸¦äº†name=fluentd-elasticsearchæ ‡ç­¾çš„Podã€‚</p><p>è€Œè¿™äº›Podçš„æ¨¡æ¿ï¼Œä¹Ÿæ˜¯ç”¨templateå­—æ®µå®šä¹‰çš„ã€‚åœ¨è¿™ä¸ªå­—æ®µä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªä½¿ç”¨ fluentd-elasticsearch:1.20é•œåƒçš„å®¹å™¨ï¼Œè€Œä¸”è¿™ä¸ªå®¹å™¨æŒ‚è½½äº†ä¸¤ä¸ªhostPathç±»å‹çš„Volumeï¼Œåˆ†åˆ«å¯¹åº”å®¿ä¸»æœºçš„/var/logç›®å½•å’Œ/var/lib/docker/containersç›®å½•ã€‚</p><p>æ˜¾ç„¶ï¼Œfluentdå¯åŠ¨ä¹‹åï¼Œå®ƒä¼šä»è¿™ä¸¤ä¸ªç›®å½•é‡Œæœé›†æ—¥å¿—ä¿¡æ¯ï¼Œå¹¶è½¬å‘ç»™ElasticSearchä¿å­˜ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬é€šè¿‡ElasticSearchå°±å¯ä»¥å¾ˆæ–¹ä¾¿åœ°æ£€ç´¢è¿™äº›æ—¥å¿—äº†ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒDockerå®¹å™¨é‡Œåº”ç”¨çš„æ—¥å¿—ï¼Œé»˜è®¤ä¼šä¿å­˜åœ¨å®¿ä¸»æœºçš„/var/lib/docker/containers/{{.å®¹å™¨ID}}/{{.å®¹å™¨ID}}-json.logæ–‡ä»¶é‡Œï¼Œæ‰€ä»¥è¿™ä¸ªç›®å½•æ­£æ˜¯fluentdçš„æœé›†ç›®æ ‡ã€‚</p><p>é‚£ä¹ˆï¼Œ<strong>DaemonSetåˆæ˜¯å¦‚ä½•ä¿è¯æ¯ä¸ªNodeä¸Šæœ‰ä¸”åªæœ‰ä¸€ä¸ªè¢«ç®¡ç†çš„Podå‘¢ï¼Ÿ</strong></p><p>æ˜¾ç„¶ï¼Œè¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„â€œæ§åˆ¶å™¨æ¨¡å‹â€èƒ½å¤Ÿå¤„ç†çš„é—®é¢˜ã€‚</p><p>DaemonSet Controllerï¼Œé¦–å…ˆä»Etcdé‡Œè·å–æ‰€æœ‰çš„Nodeåˆ—è¡¨ï¼Œç„¶åéå†æ‰€æœ‰çš„Nodeã€‚è¿™æ—¶ï¼Œå®ƒå°±å¯ä»¥å¾ˆå®¹æ˜“åœ°å»æ£€æŸ¥ï¼Œå½“å‰è¿™ä¸ªNodeä¸Šæ˜¯ä¸æ˜¯æœ‰ä¸€ä¸ªæºå¸¦äº†name=fluentd-elasticsearchæ ‡ç­¾çš„Podåœ¨è¿è¡Œã€‚</p><p>è€Œæ£€æŸ¥çš„ç»“æœï¼Œå¯èƒ½æœ‰è¿™ä¹ˆä¸‰ç§æƒ…å†µï¼š</p><ol>\n<li>\n<p>æ²¡æœ‰è¿™ç§Podï¼Œé‚£ä¹ˆå°±æ„å‘³ç€è¦åœ¨è¿™ä¸ªNodeä¸Šåˆ›å»ºè¿™æ ·ä¸€ä¸ªPodï¼›</p>\n</li>\n<li>\n<p>æœ‰è¿™ç§Podï¼Œä½†æ˜¯æ•°é‡å¤§äº1ï¼Œé‚£å°±è¯´æ˜è¦æŠŠå¤šä½™çš„Podä»è¿™ä¸ªNodeä¸Šåˆ é™¤æ‰ï¼›</p>\n</li>\n<li>\n<p>æ­£å¥½åªæœ‰ä¸€ä¸ªè¿™ç§Podï¼Œé‚£è¯´æ˜è¿™ä¸ªèŠ‚ç‚¹æ˜¯æ­£å¸¸çš„ã€‚</p>\n</li>\n</ol><p>å…¶ä¸­ï¼Œåˆ é™¤èŠ‚ç‚¹ï¼ˆNodeï¼‰ä¸Šå¤šä½™çš„Podéå¸¸ç®€å•ï¼Œç›´æ¥è°ƒç”¨Kubernetes APIå°±å¯ä»¥äº†ã€‚</p><p>ä½†æ˜¯ï¼Œ<strong>å¦‚ä½•åœ¨æŒ‡å®šçš„Nodeä¸Šåˆ›å»ºæ–°Podå‘¢ï¼Ÿ</strong></p><p>å¦‚æœä½ å·²ç»ç†Ÿæ‚‰äº†Pod APIå¯¹è±¡çš„è¯ï¼Œé‚£ä¸€å®šå¯ä»¥ç«‹åˆ»è¯´å‡ºç­”æ¡ˆï¼šç”¨nodeSelectorï¼Œé€‰æ‹©Nodeçš„åå­—å³å¯ã€‚</p><pre><code>nodeSelector:\n    name: &lt;Nodeåå­—&gt;\n</code></pre><p>æ²¡é”™ã€‚</p><p>ä¸è¿‡ï¼Œåœ¨Kubernetesé¡¹ç›®é‡Œï¼ŒnodeSelectorå…¶å®å·²ç»æ˜¯ä¸€ä¸ªå°†è¦è¢«åºŸå¼ƒçš„å­—æ®µäº†ã€‚å› ä¸ºï¼Œç°åœ¨æœ‰äº†ä¸€ä¸ªæ–°çš„ã€åŠŸèƒ½æ›´å®Œå–„çš„å­—æ®µå¯ä»¥ä»£æ›¿å®ƒï¼Œå³ï¼šnodeAffinityã€‚æˆ‘æ¥ä¸¾ä¸ªä¾‹å­ï¼š</p><pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: with-node-affinity\nspec:\n  affinity:\n    nodeAffinity:\n      requiredDuringSchedulingIgnoredDuringExecution:\n        nodeSelectorTerms:\n        - matchExpressions:\n          - key: metadata.name\n            operator: In\n            values:\n            - node-geektime\n</code></pre><p>åœ¨è¿™ä¸ªPodé‡Œï¼Œæˆ‘å£°æ˜äº†ä¸€ä¸ªspec.affinityå­—æ®µï¼Œç„¶åå®šä¹‰äº†ä¸€ä¸ªnodeAffinityã€‚å…¶ä¸­ï¼Œspec.affinityå­—æ®µï¼Œæ˜¯Podé‡Œè·Ÿè°ƒåº¦ç›¸å…³çš„ä¸€ä¸ªå­—æ®µã€‚å…³äºå®ƒçš„å®Œæ•´å†…å®¹ï¼Œæˆ‘ä¼šåœ¨è®²è§£è°ƒåº¦ç­–ç•¥çš„æ—¶å€™å†è¯¦ç»†é˜è¿°ã€‚</p><p>è€Œåœ¨è¿™é‡Œï¼Œæˆ‘å®šä¹‰çš„nodeAffinityçš„å«ä¹‰æ˜¯ï¼š</p><ol>\n<li>\n<p>requiredDuringSchedulingIgnoredDuringExecutionï¼šå®ƒçš„æ„æ€æ˜¯è¯´ï¼Œè¿™ä¸ªnodeAffinityå¿…é¡»åœ¨æ¯æ¬¡è°ƒåº¦çš„æ—¶å€™äºˆä»¥è€ƒè™‘ã€‚åŒæ—¶ï¼Œè¿™ä¹Ÿæ„å‘³ç€ä½ å¯ä»¥è®¾ç½®åœ¨æŸäº›æƒ…å†µä¸‹ä¸è€ƒè™‘è¿™ä¸ªnodeAffinityï¼›</p>\n</li>\n<li>\n<p>è¿™ä¸ªPodï¼Œå°†æ¥åªå…è®¸è¿è¡Œåœ¨â€œ<code>metadata.name</code>â€æ˜¯â€œnode-geektimeâ€çš„èŠ‚ç‚¹ä¸Šã€‚</p>\n</li>\n</ol><p>åœ¨è¿™é‡Œï¼Œä½ åº”è¯¥æ³¨æ„åˆ°nodeAffinityçš„å®šä¹‰ï¼Œå¯ä»¥æ”¯æŒæ›´åŠ ä¸°å¯Œçš„è¯­æ³•ï¼Œæ¯”å¦‚operator: Inï¼ˆå³ï¼šéƒ¨åˆ†åŒ¹é…ï¼›å¦‚æœä½ å®šä¹‰operator: Equalï¼Œå°±æ˜¯å®Œå…¨åŒ¹é…ï¼‰ï¼Œè¿™ä¹Ÿæ­£æ˜¯nodeAffinityä¼šå–ä»£nodeSelectorçš„åŸå› ä¹‹ä¸€ã€‚</p><blockquote>\n<p>å¤‡æ³¨ï¼šå…¶å®åœ¨å¤§å¤šæ•°æ—¶å€™ï¼Œè¿™äº›Operatorè¯­ä¹‰æ²¡å•¥ç”¨å¤„ã€‚æ‰€ä»¥è¯´ï¼Œåœ¨å­¦ä¹ å¼€æºé¡¹ç›®çš„æ—¶å€™ï¼Œä¸€å®šè¦å­¦ä¼šæŠ“ä½â€œä¸»çº¿â€ã€‚ä¸è¦é¡¾æ­¤å¤±å½¼ã€‚</p>\n</blockquote><p>æ‰€ä»¥ï¼Œ<strong>æˆ‘ä»¬çš„DaemonSet Controllerä¼šåœ¨åˆ›å»ºPodçš„æ—¶å€™ï¼Œè‡ªåŠ¨åœ¨è¿™ä¸ªPodçš„APIå¯¹è±¡é‡Œï¼ŒåŠ ä¸Šè¿™æ ·ä¸€ä¸ªnodeAffinityå®šä¹‰</strong>ã€‚å…¶ä¸­ï¼Œéœ€è¦ç»‘å®šçš„èŠ‚ç‚¹åå­—ï¼Œæ­£æ˜¯å½“å‰æ­£åœ¨éå†çš„è¿™ä¸ªNodeã€‚</p><p>å½“ç„¶ï¼ŒDaemonSetå¹¶ä¸éœ€è¦ä¿®æ”¹ç”¨æˆ·æäº¤çš„YAMLæ–‡ä»¶é‡Œçš„Podæ¨¡æ¿ï¼Œè€Œæ˜¯åœ¨å‘Kuberneteså‘èµ·è¯·æ±‚ä¹‹å‰ï¼Œç›´æ¥ä¿®æ”¹æ ¹æ®æ¨¡æ¿ç”Ÿæˆçš„Podå¯¹è±¡ã€‚è¿™ä¸ªæ€è·¯ï¼Œä¹Ÿæ­£æ˜¯æˆ‘åœ¨å‰é¢è®²è§£Podå¯¹è±¡æ—¶ä»‹ç»è¿‡çš„ã€‚</p><p>æ­¤å¤–ï¼ŒDaemonSetè¿˜ä¼šç»™è¿™ä¸ªPodè‡ªåŠ¨åŠ ä¸Šå¦å¤–ä¸€ä¸ªä¸è°ƒåº¦ç›¸å…³çš„å­—æ®µï¼Œå«ä½œtolerationsã€‚è¿™ä¸ªå­—æ®µæ„å‘³ç€è¿™ä¸ªPodï¼Œä¼šâ€œå®¹å¿â€ï¼ˆTolerationï¼‰æŸäº›Nodeçš„â€œæ±¡ç‚¹â€ï¼ˆTaintï¼‰ã€‚</p><p>è€ŒDaemonSetè‡ªåŠ¨åŠ ä¸Šçš„tolerationså­—æ®µï¼Œæ ¼å¼å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: with-toleration\nspec:\n  tolerations:\n  - key: node.kubernetes.io/unschedulable\n    operator: Exists\n    effect: NoSchedule\n</code></pre><p>è¿™ä¸ªTolerationçš„å«ä¹‰æ˜¯ï¼šâ€œå®¹å¿â€æ‰€æœ‰è¢«æ ‡è®°ä¸ºunschedulableâ€œæ±¡ç‚¹â€çš„Nodeï¼›â€œå®¹å¿â€çš„æ•ˆæœæ˜¯å…è®¸è°ƒåº¦ã€‚</p><blockquote>\n<p>å¤‡æ³¨ï¼šå…³äºå¦‚ä½•ç»™ä¸€ä¸ªNodeæ ‡è®°ä¸Šâ€œæ±¡ç‚¹â€ï¼Œä»¥åŠè¿™é‡Œå…·ä½“çš„è¯­æ³•å®šä¹‰ï¼Œæˆ‘ä¼šåœ¨åé¢ä»‹ç»è°ƒåº¦å™¨çš„æ—¶å€™åšè¯¦ç»†ä»‹ç»ã€‚è¿™é‡Œï¼Œä½ å¯ä»¥ç®€å•åœ°æŠŠâ€œæ±¡ç‚¹â€ç†è§£ä¸ºä¸€ç§ç‰¹æ®Šçš„Labelã€‚</p>\n</blockquote><p>è€Œåœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œè¢«æ ‡è®°äº†unschedulableâ€œæ±¡ç‚¹â€çš„Nodeï¼Œæ˜¯ä¸ä¼šæœ‰ä»»ä½•Podè¢«è°ƒåº¦ä¸Šå»çš„ï¼ˆeffect: NoScheduleï¼‰ã€‚å¯æ˜¯ï¼ŒDaemonSetè‡ªåŠ¨åœ°ç»™è¢«ç®¡ç†çš„PodåŠ ä¸Šäº†è¿™ä¸ªç‰¹æ®Šçš„Tolerationï¼Œå°±ä½¿å¾—è¿™äº›Podå¯ä»¥å¿½ç•¥è¿™ä¸ªé™åˆ¶ï¼Œç»§è€Œä¿è¯æ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ½ä¼šè¢«è°ƒåº¦ä¸€ä¸ªPodã€‚å½“ç„¶ï¼Œå¦‚æœè¿™ä¸ªèŠ‚ç‚¹æœ‰æ•…éšœçš„è¯ï¼Œè¿™ä¸ªPodå¯èƒ½ä¼šå¯åŠ¨å¤±è´¥ï¼Œè€ŒDaemonSetåˆ™ä¼šå§‹ç»ˆå°è¯•ä¸‹å»ï¼Œç›´åˆ°Podå¯åŠ¨æˆåŠŸã€‚</p><p>è¿™æ—¶ï¼Œä½ åº”è¯¥å¯ä»¥çŒœåˆ°ï¼Œæˆ‘åœ¨å‰é¢ä»‹ç»åˆ°çš„<strong>DaemonSetçš„â€œè¿‡äººä¹‹å¤„â€ï¼Œå…¶å®å°±æ˜¯ä¾é Tolerationå®ç°çš„ã€‚</strong></p><p>å‡å¦‚å½“å‰DaemonSetç®¡ç†çš„ï¼Œæ˜¯ä¸€ä¸ªç½‘ç»œæ’ä»¶çš„Agent Podï¼Œé‚£ä¹ˆä½ å°±å¿…é¡»åœ¨è¿™ä¸ªDaemonSetçš„YAMLæ–‡ä»¶é‡Œï¼Œç»™å®ƒçš„Podæ¨¡æ¿åŠ ä¸Šä¸€ä¸ªèƒ½å¤Ÿâ€œå®¹å¿â€<code>node.kubernetes.io/network-unavailable</code>â€œæ±¡ç‚¹â€çš„Tolerationã€‚æ­£å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­æ‰€ç¤ºï¼š</p><pre><code>...\ntemplate:\n    metadata:\n      labels:\n        name: network-plugin-agent\n    spec:\n      tolerations:\n      - key: node.kubernetes.io/network-unavailable\n        operator: Exists\n        effect: NoSchedule\n</code></pre><p>åœ¨Kubernetesé¡¹ç›®ä¸­ï¼Œå½“ä¸€ä¸ªèŠ‚ç‚¹çš„ç½‘ç»œæ’ä»¶å°šæœªå®‰è£…æ—¶ï¼Œè¿™ä¸ªèŠ‚ç‚¹å°±ä¼šè¢«è‡ªåŠ¨åŠ ä¸Šåä¸º<code>node.kubernetes.io/network-unavailable</code>çš„â€œæ±¡ç‚¹â€ã€‚</p><p><strong>è€Œé€šè¿‡è¿™æ ·ä¸€ä¸ªTolerationï¼Œè°ƒåº¦å™¨åœ¨è°ƒåº¦è¿™ä¸ªPodçš„æ—¶å€™ï¼Œå°±ä¼šå¿½ç•¥å½“å‰èŠ‚ç‚¹ä¸Šçš„â€œæ±¡ç‚¹â€ï¼Œä»è€ŒæˆåŠŸåœ°å°†ç½‘ç»œæ’ä»¶çš„Agentç»„ä»¶è°ƒåº¦åˆ°è¿™å°æœºå™¨ä¸Šå¯åŠ¨èµ·æ¥ã€‚</strong></p><p>è¿™ç§æœºåˆ¶ï¼Œæ­£æ˜¯æˆ‘ä»¬åœ¨éƒ¨ç½²Kubernetesé›†ç¾¤çš„æ—¶å€™ï¼Œèƒ½å¤Ÿå…ˆéƒ¨ç½²Kubernetesæœ¬èº«ã€å†éƒ¨ç½²ç½‘ç»œæ’ä»¶çš„æ ¹æœ¬åŸå› ï¼šå› ä¸ºå½“æ—¶æˆ‘ä»¬æ‰€åˆ›å»ºçš„Weaveçš„YAMLï¼Œå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªDaemonSetã€‚</p><blockquote>\n<p>è¿™é‡Œï¼Œä½ ä¹Ÿå¯ä»¥å†å›é¡¾ä¸€ä¸‹ç¬¬11ç¯‡æ–‡ç« <a href=\"https://time.geekbang.org/column/article/39724\">ã€Šä»0åˆ°1ï¼šæ­å»ºä¸€ä¸ªå®Œæ•´çš„Kubernetesé›†ç¾¤ã€‹</a>ä¸­çš„ç›¸å…³å†…å®¹ã€‚</p>\n</blockquote><p>è‡³æ­¤ï¼Œé€šè¿‡ä¸Šé¢è¿™äº›å†…å®¹ï¼Œä½ åº”è¯¥èƒ½å¤Ÿæ˜ç™½ï¼Œ<strong>DaemonSetå…¶å®æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„æ§åˆ¶å™¨</strong>ã€‚åœ¨å®ƒçš„æ§åˆ¶å¾ªç¯ä¸­ï¼Œåªéœ€è¦éå†æ‰€æœ‰èŠ‚ç‚¹ï¼Œç„¶åæ ¹æ®èŠ‚ç‚¹ä¸Šæ˜¯å¦æœ‰è¢«ç®¡ç†Podçš„æƒ…å†µï¼Œæ¥å†³å®šæ˜¯å¦è¦åˆ›å»ºæˆ–è€…åˆ é™¤ä¸€ä¸ªPodã€‚</p><p>åªä¸è¿‡ï¼Œåœ¨åˆ›å»ºæ¯ä¸ªPodçš„æ—¶å€™ï¼ŒDaemonSetä¼šè‡ªåŠ¨ç»™è¿™ä¸ªPodåŠ ä¸Šä¸€ä¸ªnodeAffinityï¼Œä»è€Œä¿è¯è¿™ä¸ªPodåªä¼šåœ¨æŒ‡å®šèŠ‚ç‚¹ä¸Šå¯åŠ¨ã€‚åŒæ—¶ï¼Œå®ƒè¿˜ä¼šè‡ªåŠ¨ç»™è¿™ä¸ªPodåŠ ä¸Šä¸€ä¸ªTolerationï¼Œä»è€Œå¿½ç•¥èŠ‚ç‚¹çš„unschedulableâ€œæ±¡ç‚¹â€ã€‚</p><p>å½“ç„¶ï¼Œ<strong>ä½ ä¹Ÿå¯ä»¥åœ¨Podæ¨¡æ¿é‡ŒåŠ ä¸Šæ›´å¤šç§ç±»çš„Tolerationï¼Œä»è€Œåˆ©ç”¨DaemonSetè¾¾åˆ°è‡ªå·±çš„ç›®çš„</strong>ã€‚æ¯”å¦‚ï¼Œåœ¨è¿™ä¸ªfluentd-elasticsearch DaemonSeté‡Œï¼Œæˆ‘å°±ç»™å®ƒåŠ ä¸Šäº†è¿™æ ·çš„Tolerationï¼š</p><pre><code>tolerations:\n- key: node-role.kubernetes.io/master\n  effect: NoSchedule\n</code></pre><p>è¿™æ˜¯å› ä¸ºåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒKubernetesé›†ç¾¤ä¸å…è®¸ç”¨æˆ·åœ¨MasterèŠ‚ç‚¹éƒ¨ç½²Podã€‚å› ä¸ºï¼ŒMasterèŠ‚ç‚¹é»˜è®¤æºå¸¦äº†ä¸€ä¸ªå«ä½œ<code>node-role.kubernetes.io/master</code>çš„â€œæ±¡ç‚¹â€ã€‚æ‰€ä»¥ï¼Œä¸ºäº†èƒ½åœ¨MasterèŠ‚ç‚¹ä¸Šéƒ¨ç½²DaemonSetçš„Podï¼Œæˆ‘å°±å¿…é¡»è®©è¿™ä¸ªPodâ€œå®¹å¿â€è¿™ä¸ªâ€œæ±¡ç‚¹â€ã€‚</p><p>åœ¨ç†è§£äº†DaemonSetçš„å·¥ä½œåŸç†ä¹‹åï¼Œæ¥ä¸‹æ¥æˆ‘å°±é€šè¿‡ä¸€ä¸ªå…·ä½“çš„å®è·µæ¥å¸®ä½ æ›´æ·±å…¥åœ°æŒæ¡DaemonSetçš„ä½¿ç”¨æ–¹æ³•ã€‚</p><blockquote>\n<p>å¤‡æ³¨ï¼šéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨Kubernetes v1.11ä¹‹å‰ï¼Œç”±äºè°ƒåº¦å™¨å°šä¸å®Œå–„ï¼ŒDaemonSetæ˜¯ç”±DaemonSet Controllerè‡ªè¡Œè°ƒåº¦çš„ï¼Œå³å®ƒä¼šç›´æ¥è®¾ç½®Podçš„spec.nodenameå­—æ®µï¼Œè¿™æ ·å°±å¯ä»¥è·³è¿‡è°ƒåº¦å™¨äº†ã€‚ä½†æ˜¯ï¼Œè¿™æ ·çš„åšæ³•å¾ˆå¿«å°±ä¼šè¢«åºŸé™¤ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œæˆ‘ä¹Ÿä¸æ¨èä½ å†èŠ±æ—¶é—´å­¦ä¹ è¿™ä¸ªæµç¨‹äº†ã€‚</p>\n</blockquote><p><strong>é¦–å…ˆï¼Œåˆ›å»ºè¿™ä¸ªDaemonSetå¯¹è±¡ï¼š</strong></p><pre><code>$ kubectl create -f fluentd-elasticsearch.yaml\n</code></pre><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨DaemonSetä¸Šï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½åº”è¯¥åŠ ä¸Šresourceså­—æ®µï¼Œæ¥é™åˆ¶å®ƒçš„CPUå’Œå†…å­˜ä½¿ç”¨ï¼Œé˜²æ­¢å®ƒå ç”¨è¿‡å¤šçš„å®¿ä¸»æœºèµ„æºã€‚</p><p>è€Œåˆ›å»ºæˆåŠŸåï¼Œä½ å°±èƒ½çœ‹åˆ°ï¼Œå¦‚æœæœ‰Nä¸ªèŠ‚ç‚¹ï¼Œå°±ä¼šæœ‰Nä¸ªfluentd-elasticsearch Podåœ¨è¿è¡Œã€‚æ¯”å¦‚åœ¨æˆ‘ä»¬çš„ä¾‹å­é‡Œï¼Œä¼šæœ‰ä¸¤ä¸ªPodï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>$ kubectl get pod -n kube-system -l name=fluentd-elasticsearch\nNAME                          READY     STATUS    RESTARTS   AGE\nfluentd-elasticsearch-dqfv9   1/1       Running   0          53m\nfluentd-elasticsearch-pf9z5   1/1       Running   0          53m\n</code></pre><p>è€Œå¦‚æœä½ æ­¤æ—¶é€šè¿‡kubectl getæŸ¥çœ‹ä¸€ä¸‹Kubernetesé›†ç¾¤é‡Œçš„DaemonSetå¯¹è±¡ï¼š</p><pre><code>$ kubectl get ds -n kube-system fluentd-elasticsearch\nNAME                    DESIRED   CURRENT   READY     UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE\nfluentd-elasticsearch   2         2         2         2            2           &lt;none&gt;          1h\n</code></pre><blockquote>\n<p>å¤‡æ³¨ï¼šKubernetesé‡Œæ¯”è¾ƒé•¿çš„APIå¯¹è±¡éƒ½æœ‰çŸ­åå­—ï¼Œæ¯”å¦‚DaemonSetå¯¹åº”çš„æ˜¯dsï¼ŒDeploymentå¯¹åº”çš„æ˜¯deployã€‚</p>\n</blockquote><p>å°±ä¼šå‘ç°DaemonSetå’ŒDeploymentä¸€æ ·ï¼Œä¹Ÿæœ‰DESIREDã€CURRENTç­‰å¤šä¸ªçŠ¶æ€å­—æ®µã€‚è¿™ä¹Ÿå°±æ„å‘³ç€ï¼ŒDaemonSetå¯ä»¥åƒDeploymenté‚£æ ·ï¼Œè¿›è¡Œç‰ˆæœ¬ç®¡ç†ã€‚è¿™ä¸ªç‰ˆæœ¬ï¼Œå¯ä»¥ä½¿ç”¨kubectl rollout historyçœ‹åˆ°ï¼š</p><pre><code>$ kubectl rollout history daemonset fluentd-elasticsearch -n kube-system\ndaemonsets &quot;fluentd-elasticsearch&quot;\nREVISION  CHANGE-CAUSE\n1         &lt;none&gt;\n</code></pre><p><strong>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥æŠŠè¿™ä¸ªDaemonSetçš„å®¹å™¨é•œåƒç‰ˆæœ¬åˆ°v2.2.0ï¼š</strong></p><pre><code>$ kubectl set image ds/fluentd-elasticsearch fluentd-elasticsearch=k8s.gcr.io/fluentd-elasticsearch:v2.2.0 --record -n=kube-system\n</code></pre><p>è¿™ä¸ªkubectl set imageå‘½ä»¤é‡Œï¼Œç¬¬ä¸€ä¸ªfluentd-elasticsearchæ˜¯DaemonSetçš„åå­—ï¼Œç¬¬äºŒä¸ªfluentd-elasticsearchæ˜¯å®¹å™¨çš„åå­—ã€‚</p><p>è¿™æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨kubectl rollout statuså‘½ä»¤çœ‹åˆ°è¿™ä¸ªâ€œæ»šåŠ¨æ›´æ–°â€çš„è¿‡ç¨‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>$ kubectl rollout status ds/fluentd-elasticsearch -n kube-system\nWaiting for daemon set &quot;fluentd-elasticsearch&quot; rollout to finish: 0 out of 2 new pods have been updated...\nWaiting for daemon set &quot;fluentd-elasticsearch&quot; rollout to finish: 0 out of 2 new pods have been updated...\nWaiting for daemon set &quot;fluentd-elasticsearch&quot; rollout to finish: 1 of 2 updated pods are available...\ndaemon set &quot;fluentd-elasticsearch&quot; successfully rolled out\n</code></pre><p>æ³¨æ„ï¼Œç”±äºè¿™ä¸€æ¬¡æˆ‘åœ¨å‡çº§å‘½ä»¤åé¢åŠ ä¸Šäº†â€“recordå‚æ•°ï¼Œæ‰€ä»¥è¿™æ¬¡å‡çº§ä½¿ç”¨åˆ°çš„æŒ‡ä»¤å°±ä¼šè‡ªåŠ¨å‡ºç°åœ¨DaemonSetçš„rollout historyé‡Œé¢ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>$ kubectl rollout history daemonset fluentd-elasticsearch -n kube-system\ndaemonsets &quot;fluentd-elasticsearch&quot;\nREVISION  CHANGE-CAUSE\n1         &lt;none&gt;\n2         kubectl set image ds/fluentd-elasticsearch fluentd-elasticsearch=k8s.gcr.io/fluentd-elasticsearch:v2.2.0 --namespace=kube-system --record=true\n</code></pre><p>æœ‰äº†ç‰ˆæœ¬å·ï¼Œä½ ä¹Ÿå°±å¯ä»¥åƒDeploymentä¸€æ ·ï¼Œå°†DaemonSetå›æ»šåˆ°æŸä¸ªæŒ‡å®šçš„å†å²ç‰ˆæœ¬äº†ã€‚</p><p>è€Œæˆ‘åœ¨å‰é¢çš„æ–‡ç« ä¸­è®²è§£Deploymentå¯¹è±¡çš„æ—¶å€™ï¼Œæ›¾ç»æåˆ°è¿‡ï¼ŒDeploymentç®¡ç†è¿™äº›ç‰ˆæœ¬ï¼Œé çš„æ˜¯â€œä¸€ä¸ªç‰ˆæœ¬å¯¹åº”ä¸€ä¸ªReplicaSetå¯¹è±¡â€ã€‚å¯æ˜¯ï¼ŒDaemonSetæ§åˆ¶å™¨æ“ä½œçš„ç›´æ¥å°±æ˜¯Podï¼Œä¸å¯èƒ½æœ‰ReplicaSetè¿™æ ·çš„å¯¹è±¡å‚ä¸å…¶ä¸­ã€‚<strong>é‚£ä¹ˆï¼Œå®ƒçš„è¿™äº›ç‰ˆæœ¬åˆæ˜¯å¦‚ä½•ç»´æŠ¤çš„å‘¢ï¼Ÿ</strong></p><p>æ‰€è°“ï¼Œä¸€åˆ‡çš†å¯¹è±¡ï¼</p><p>åœ¨Kubernetesé¡¹ç›®ä¸­ï¼Œä»»ä½•ä½ è§‰å¾—éœ€è¦è®°å½•ä¸‹æ¥çš„çŠ¶æ€ï¼Œéƒ½å¯ä»¥è¢«ç”¨APIå¯¹è±¡çš„æ–¹å¼å®ç°ã€‚å½“ç„¶ï¼Œâ€œç‰ˆæœ¬â€ä¹Ÿä¸ä¾‹å¤–ã€‚</p><p>Kubernetes v1.7ä¹‹åæ·»åŠ äº†ä¸€ä¸ªAPIå¯¹è±¡ï¼Œåå«<strong>ControllerRevision</strong>ï¼Œä¸“é—¨ç”¨æ¥è®°å½•æŸç§Controllerå¯¹è±¡çš„ç‰ˆæœ¬ã€‚æ¯”å¦‚ï¼Œä½ å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹fluentd-elasticsearchå¯¹åº”çš„ControllerRevisionï¼š</p><pre><code>$ kubectl get controllerrevision -n kube-system -l name=fluentd-elasticsearch\nNAME                               CONTROLLER                             REVISION   AGE\nfluentd-elasticsearch-64dc6799c9   daemonset.apps/fluentd-elasticsearch   2          1h\n</code></pre><p>è€Œå¦‚æœä½ ä½¿ç”¨kubectl describeæŸ¥çœ‹è¿™ä¸ªControllerRevisionå¯¹è±¡ï¼š</p><pre><code>$ kubectl describe controllerrevision fluentd-elasticsearch-64dc6799c9 -n kube-system\nName:         fluentd-elasticsearch-64dc6799c9\nNamespace:    kube-system\nLabels:       controller-revision-hash=2087235575\n              name=fluentd-elasticsearch\nAnnotations:  deprecated.daemonset.template.generation=2\n              kubernetes.io/change-cause=kubectl set image ds/fluentd-elasticsearch fluentd-elasticsearch=k8s.gcr.io/fluentd-elasticsearch:v2.2.0 --record=true --namespace=kube-system\nAPI Version:  apps/v1\nData:\n  Spec:\n    Template:\n      $ Patch:  replace\n      Metadata:\n        Creation Timestamp:  &lt;nil&gt;\n        Labels:\n          Name:  fluentd-elasticsearch\n      Spec:\n        Containers:\n          Image:              k8s.gcr.io/fluentd-elasticsearch:v2.2.0\n          Image Pull Policy:  IfNotPresent\n          Name:               fluentd-elasticsearch\n...\nRevision:                  2\nEvents:                    &lt;none&gt;\n</code></pre><p>å°±ä¼šçœ‹åˆ°ï¼Œè¿™ä¸ªControllerRevisionå¯¹è±¡ï¼Œå®é™…ä¸Šæ˜¯åœ¨Dataå­—æ®µä¿å­˜äº†è¯¥ç‰ˆæœ¬å¯¹åº”çš„å®Œæ•´çš„DaemonSetçš„APIå¯¹è±¡ã€‚å¹¶ä¸”ï¼Œåœ¨Annotationå­—æ®µä¿å­˜äº†åˆ›å»ºè¿™ä¸ªå¯¹è±¡æ‰€ä½¿ç”¨çš„kubectlå‘½ä»¤ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•å°†è¿™ä¸ªDaemonSetå›æ»šåˆ°Revision=1æ—¶çš„çŠ¶æ€ï¼š</p><pre><code>$ kubectl rollout undo daemonset fluentd-elasticsearch --to-revision=1 -n kube-system\ndaemonset.extensions/fluentd-elasticsearch rolled back\n</code></pre><p>è¿™ä¸ªkubectl rollout undoæ“ä½œï¼Œå®é™…ä¸Šç›¸å½“äºè¯»å–åˆ°äº†Revision=1çš„ControllerRevisionå¯¹è±¡ä¿å­˜çš„Dataå­—æ®µã€‚è€Œè¿™ä¸ªDataå­—æ®µé‡Œä¿å­˜çš„ä¿¡æ¯ï¼Œå°±æ˜¯Revision=1æ—¶è¿™ä¸ªDaemonSetçš„å®Œæ•´APIå¯¹è±¡ã€‚</p><p>æ‰€ä»¥ï¼Œç°åœ¨DaemonSet Controllerå°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªå†å²APIå¯¹è±¡ï¼Œå¯¹ç°æœ‰çš„DaemonSetåšä¸€æ¬¡PATCHæ“ä½œï¼ˆç­‰ä»·äºæ‰§è¡Œä¸€æ¬¡kubectl apply -f â€œæ—§çš„DaemonSetå¯¹è±¡â€ï¼‰ï¼Œä»è€ŒæŠŠè¿™ä¸ªDaemonSetâ€œæ›´æ–°â€åˆ°ä¸€ä¸ªæ—§ç‰ˆæœ¬ã€‚</p><p>è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆï¼Œåœ¨æ‰§è¡Œå®Œè¿™æ¬¡å›æ»šå®Œæˆåï¼Œä½ ä¼šå‘ç°ï¼ŒDaemonSetçš„Revisionå¹¶ä¸ä¼šä»Revision=2é€€å›åˆ°1ï¼Œè€Œæ˜¯ä¼šå¢åŠ æˆRevision=3ã€‚è¿™æ˜¯å› ä¸ºï¼Œä¸€ä¸ªæ–°çš„ControllerRevisionè¢«åˆ›å»ºäº†å‡ºæ¥ã€‚</p><h2>æ€»ç»“</h2><p>åœ¨ä»Šå¤©è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘é¦–å…ˆç®€å•ä»‹ç»äº†StatefulSetçš„â€œæ»šåŠ¨æ›´æ–°â€ï¼Œç„¶åé‡ç‚¹è®²è§£äº†æœ¬ä¸“æ çš„ç¬¬ä¸‰ä¸ªé‡è¦ç¼–æ’å¯¹è±¡ï¼šDaemonSetã€‚</p><p>ç›¸æ¯”äºDeploymentï¼ŒDaemonSetåªç®¡ç†Podå¯¹è±¡ï¼Œç„¶åé€šè¿‡nodeAffinityå’ŒTolerationè¿™ä¸¤ä¸ªè°ƒåº¦å™¨çš„å°åŠŸèƒ½ï¼Œä¿è¯äº†æ¯ä¸ªèŠ‚ç‚¹ä¸Šæœ‰ä¸”åªæœ‰ä¸€ä¸ªPodã€‚è¿™ä¸ªæ§åˆ¶å™¨çš„å®ç°åŸç†ç®€å•æ˜“æ‡‚ï¼Œå¸Œæœ›ä½ èƒ½å¤Ÿå¿«é€ŸæŒæ¡ã€‚</p><p>ä¸æ­¤åŒæ—¶ï¼ŒDaemonSetä½¿ç”¨ControllerRevisionï¼Œæ¥ä¿å­˜å’Œç®¡ç†è‡ªå·±å¯¹åº”çš„â€œç‰ˆæœ¬â€ã€‚è¿™ç§â€œé¢å‘APIå¯¹è±¡â€çš„è®¾è®¡æ€è·¯ï¼Œå¤§å¤§ç®€åŒ–äº†æ§åˆ¶å™¨æœ¬èº«çš„é€»è¾‘ï¼Œä¹Ÿæ­£æ˜¯Kubernetesé¡¹ç›®â€œå£°æ˜å¼APIâ€çš„ä¼˜åŠ¿æ‰€åœ¨ã€‚</p><p>è€Œä¸”ï¼Œç›¸ä¿¡èªæ˜çš„ä½ æ­¤æ—¶å·²ç»æƒ³åˆ°äº†ï¼ŒStatefulSetä¹Ÿæ˜¯ç›´æ¥æ§åˆ¶Podå¯¹è±¡çš„ï¼Œé‚£ä¹ˆå®ƒæ˜¯ä¸æ˜¯ä¹Ÿåœ¨ä½¿ç”¨ControllerRevisionè¿›è¡Œç‰ˆæœ¬ç®¡ç†å‘¢ï¼Ÿ</p><p>æ²¡é”™ã€‚åœ¨Kubernetesé¡¹ç›®é‡Œï¼ŒControllerRevisionå…¶å®æ˜¯ä¸€ä¸ªé€šç”¨çš„ç‰ˆæœ¬ç®¡ç†å¯¹è±¡ã€‚è¿™æ ·ï¼ŒKubernetesé¡¹ç›®å°±å·§å¦™åœ°é¿å…äº†æ¯ç§æ§åˆ¶å™¨éƒ½è¦ç»´æŠ¤ä¸€å¥—å†—ä½™çš„ä»£ç å’Œé€»è¾‘çš„é—®é¢˜ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>æˆ‘åœ¨æ–‡ä¸­æåˆ°ï¼Œåœ¨Kubernetes v1.11ä¹‹å‰ï¼ŒDaemonSetæ‰€ç®¡ç†çš„Podçš„è°ƒåº¦è¿‡ç¨‹ï¼Œå®é™…ä¸Šéƒ½æ˜¯ç”±DaemonSet Controllerè‡ªå·±è€Œä¸æ˜¯ç”±è°ƒåº¦å™¨å®Œæˆçš„ã€‚ä½ èƒ½è¯´å‡ºè¿™å…¶ä¸­æœ‰å“ªäº›åŸå› å—ï¼Ÿ</p><p>æ„Ÿè°¢ä½ çš„æ”¶å¬ï¼Œæ¬¢è¿ä½ ç»™æˆ‘ç•™è¨€ï¼Œä¹Ÿæ¬¢è¿åˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹ä¸€èµ·é˜…è¯»ã€‚</p>","neighbors":{"left":{"article_title":"20 | æ·±å…¥ç†è§£StatefulSetï¼ˆä¸‰ï¼‰ï¼šæœ‰çŠ¶æ€åº”ç”¨å®è·µ","id":41217},"right":{"article_title":"22 | æ’¬åŠ¨ç¦»çº¿ä¸šåŠ¡ï¼šJobä¸CronJob","id":41607}},"comments":[{"had_liked":false,"id":31269,"user_name":"è™è™â¤ï¸","can_delete":false,"product_type":"c1","uid":1086535,"ip_address":"","ucode":"157F261E80291A","user_header":"https://static001.geekbang.org/account/avatar/00/10/94/47/75875257.jpg","comment_is_top":false,"comment_ctime":1539140305,"is_pvip":false,"replies":[{"id":"11257","content":"æ˜¯çš„ï¼Œå…³é”®å°±åœ¨äºï¼Œè°ƒåº¦ä¼˜å…ˆçº§è¿™ä¸ªç‰¹æ€§å‡ºç°äº†ã€‚æ‰€ä»¥ç°åœ¨çš„è®¾è®¡å…¶å®æ²¡å•¥ç‰¹åˆ«çš„åœ°æ–¹ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1539142595,"ip_address":"","comment_id":31269,"utype":1}],"discussion_count":2,"race_medal":0,"score":"280712014545","product_id":100015201,"comment_content":"æ€è€ƒé¢˜ï¼Œ<br><br>æˆ‘è§‰å¾—åº”è¯¥æ˜¯æ•ˆç‡çš„é—®é¢˜ã€‚<br><br>æŸ¥äº†ä¸€ä¸‹v1.11 çš„ release notesã€‚schedulerå…³äºaffinityè°“è¯çš„æ€§èƒ½å¤§å¤§æé«˜äº†ã€‚<br><br>æŸ¥é˜…äº†Dsç”¨é»˜è®¤è°ƒåº¦å™¨ä»£æ›¿controllerçš„è®¾è®¡æ–‡æ¡£<br>ä¹‹å‰çš„åšæ³•æ˜¯ï¼š<br>controlleråˆ¤æ–­è°ƒåº¦è°“è¯ï¼Œç¬¦åˆçš„è¯ç›´æ¥åœ¨controllerä¸­ç›´æ¥è®¾ç½®spec.hostNameå»è°ƒåº¦ã€‚<br>ç›®å‰çš„åšæ³•æ˜¯ï¼š<br>controllerä¸å†åˆ¤æ–­è°ƒåº¦æ¡ä»¶ï¼Œç»™æ¯ä¸ªpodeè®¾ç½®NodeAffinityã€‚æ§åˆ¶å™¨æ ¹æ®NodeAffinityå»æ£€æŸ¥æ¯ä¸ªnodeä¸Šæ˜¯å¦å¯åŠ¨äº†ç›¸åº”çš„Podã€‚å¹¶ä¸”å¯ä»¥åˆ©ç”¨è°ƒåº¦ä¼˜å…ˆçº§å»ä¼˜å…ˆè°ƒåº¦å…³é”®çš„ds podsã€‚","like_count":65,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"å¼ ç£Š Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426272,"discussion_content":"æ˜¯çš„ï¼Œå…³é”®å°±åœ¨äºï¼Œè°ƒåº¦ä¼˜å…ˆçº§è¿™ä¸ªç‰¹æ€§å‡ºç°äº†ã€‚æ‰€ä»¥ç°åœ¨çš„è®¾è®¡å…¶å®æ²¡å•¥ç‰¹åˆ«çš„åœ°æ–¹ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1539142595,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1043072,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/80/8759e4c1.jpg","nickname":"ğŸ»","note":"","ucode":"534EDAD496A0E6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":377654,"discussion_content":"è¯·é—®æ‚¨è¯´çš„ controller æ˜¯æŒ‡ Controller Manager å—ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1622766982,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":124356,"user_name":"ç´«å¤œ","can_delete":false,"product_type":"c1","uid":1205423,"ip_address":"","ucode":"88CFF4C188B65A","user_header":"https://static001.geekbang.org/account/avatar/00/12/64/af/6dbbb482.jpg","comment_is_top":false,"comment_ctime":1565865883,"is_pvip":false,"replies":[{"id":"46511","content":"åˆ°ç›®å‰ä¸ºæ­¢ï¼ŒDSåªæœ‰ä¸€ç§ç­–ç•¥å°±æ˜¯å…ˆåˆ é™¤å†åˆ›å»º OnDelete","user_name":"ä½œè€…å›å¤","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1566351141,"ip_address":"","comment_id":124356,"utype":1}],"discussion_count":4,"race_medal":0,"score":"117529982875","product_id":100015201,"comment_content":"å¼ è€å¸ˆï¼ŒDaemonSetçš„æ»šåŠ¨æ›´æ–°ï¼Œæ˜¯å…ˆdeleteæ—§çš„podï¼Œå†å¯åŠ¨æ–°çš„podï¼Œè¿˜æ˜¯å’ŒDeploymentä¸€æ ·ï¼Œå…ˆåˆ›å»ºæ–°çš„podï¼Œå†åˆ é™¤æ—§çš„pod?","like_count":27,"discussions":[{"author":{"id":2112134,"avatar":"https://static001.geekbang.org/account/avatar/00/20/3a/86/92c20959.jpg","nickname":"Free","note":"","ucode":"0AD38A0B3611E6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":381195,"discussion_content":"1.21ç‰ˆæœ¬ï¼ŒDaemonSet æœ‰ä¸¤ç§æ›´æ–°ç­–ç•¥ï¼š\n\nOnDelete: ä½¿ç”¨ OnDelete æ›´æ–°ç­–ç•¥æ—¶ï¼Œåœ¨æ›´æ–° DaemonSet æ¨¡æ¿åï¼Œåªæœ‰å½“ä½ æ‰‹åŠ¨åˆ é™¤è€çš„ DaemonSet pods ä¹‹åï¼Œæ–°çš„ DaemonSet Pod æ‰ä¼šè¢«è‡ªåŠ¨åˆ›å»ºã€‚è·Ÿ Kubernetes 1.6 ä»¥å‰çš„ç‰ˆæœ¬ç±»ä¼¼ã€‚\nRollingUpdate: è¿™æ˜¯é»˜è®¤çš„æ›´æ–°ç­–ç•¥ã€‚ä½¿ç”¨ RollingUpdate æ›´æ–°ç­–ç•¥æ—¶ï¼Œåœ¨æ›´æ–° DaemonSet æ¨¡æ¿åï¼Œ è€çš„ DaemonSet pods å°†è¢«ç»ˆæ­¢ï¼Œå¹¶ä¸”å°†ä»¥å—æ§æ–¹å¼è‡ªåŠ¨åˆ›å»ºæ–°çš„ DaemonSet podsã€‚ æ›´æ–°æœŸé—´ï¼Œæœ€å¤šåªèƒ½æœ‰ DaemonSet çš„ä¸€ä¸ª Pod è¿è¡Œäºæ¯ä¸ªèŠ‚ç‚¹ä¸Šã€‚","likes_number":6,"is_delete":false,"is_hidden":false,"ctime":1624951478,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"å¼ ç£Š Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":463132,"discussion_content":"åˆ°ç›®å‰ä¸ºæ­¢ï¼ŒDSåªæœ‰ä¸€ç§ç­–ç•¥å°±æ˜¯å…ˆåˆ é™¤å†åˆ›å»º OnDelete","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1566351141,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1227639,"avatar":"https://static001.geekbang.org/account/avatar/00/12/bb/77/e1391dd8.jpg","nickname":"æ—ºæ—º","note":"","ucode":"2067D3BCCA7C0A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":334916,"discussion_content":"æˆ‘çœ‹æˆ‘éƒ¨ç½²å¾—1.18ç‰ˆæœ¬å¾—æ›´æ–°ç­–ç•¥åˆå˜æˆäº†rollingupdate","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608026123,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1223106,"avatar":"https://static001.geekbang.org/account/avatar/00/12/a9/c2/f9fe5e90.jpg","nickname":"ants","note":"","ucode":"5FAF7576F305DB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":41794,"discussion_content":"mark","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572506211,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":31448,"user_name":"åŒ—å¡","can_delete":false,"product_type":"c1","uid":1218128,"ip_address":"","ucode":"2D947A61689FC6","user_header":"https://static001.geekbang.org/account/avatar/00/12/96/50/bde525b1.jpg","comment_is_top":false,"comment_ctime":1539182456,"is_pvip":false,"replies":[{"id":"11323","content":"æ˜¯çš„ã€‚å‡†ç¡®çš„è¯´ï¼Œæ˜¯ä¸€æ­¥ä¸€æ­¥çš„å‡å°partition ï¼Œä¸€ç›´å‡æˆ0ã€‚å°±å‘å¸ƒå®Œäº†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1539223495,"ip_address":"","comment_id":31448,"utype":1}],"discussion_count":1,"race_medal":0,"score":"117503299448","product_id":100015201,"comment_content":"æˆ‘è·Ÿä¸Šé¢çš„æœ‹å‹æœ‰åŒæ ·çš„ç–‘é—®ï¼Œå…³äºPartitionæ›´æ–°çš„ã€‚<br><br>æˆ‘è®¾ç½®äº†Partitionï¼Œç”¨éƒ¨åˆ†podæ¥åšç°åº¦å‘å¸ƒï¼Œç„¶åå‘ç°æ²¡é—®é¢˜ï¼Œæˆ‘è¦å…¨éƒ¨æ›´æ–°ï¼Œå°±åªéœ€è¦å»æ‰Partitionå­—æ®µå—ï¼Ÿ<br>ç„¶åæˆ‘ä¸‹ä¸€æ¬¡æ›´æ–°çš„æ—¶å€™ï¼Œå°±è¦å†å…ˆåŠ ä¸ŠPartitionï¼Œç„¶åå†æ›´æ–°ã€‚å…¨éƒ¨æ›´æ–°æ—¶å†å»æ‰ã€‚<br><br>æˆ‘çœ‹äº†è€å¸ˆçš„å›å¤ï¼Œè¡¨è¾¾çš„æ˜¯è¿™ä¸ªæ„æ€å—ï¼Ÿ","like_count":27,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"å¼ ç£Š Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426345,"discussion_content":"æ˜¯çš„ã€‚å‡†ç¡®çš„è¯´ï¼Œæ˜¯ä¸€æ­¥ä¸€æ­¥çš„å‡å°partition ï¼Œä¸€ç›´å‡æˆ0ã€‚å°±å‘å¸ƒå®Œäº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539223495,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":31155,"user_name":"DJH","can_delete":false,"product_type":"c1","uid":1256740,"ip_address":"","ucode":"2BDEF123B3DB6A","user_header":"https://static001.geekbang.org/account/avatar/00/13/2d/24/28acca15.jpg","comment_is_top":false,"comment_ctime":1539129768,"is_pvip":false,"replies":[{"id":"11254","content":"å·²ç»è§£é‡Šã€‚ä¸ä¼šï¼Œé‡å¯ä¸ä¼šç ´åæ‹“æ‰‘è§„åˆ™ï¼Œè€Œä¸”æ–‡ç« é‡Œè¯´äº†ï¼Œä½ è¦ç¡®ä¿ä½ çš„è„šæœ¬ä¸å—é‡å¯å½±å“ã€‚å»æ‰partitionã€‚å¤šä¸ªå¯¹è±¡ã€‚æ”¯æŒï¼Œå­—æ®µä¹Ÿä¸€æ ·ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1539138973,"ip_address":"","comment_id":31155,"utype":1}],"discussion_count":1,"race_medal":0,"score":"96028410280","product_id":100015201,"comment_content":"å¼ è€å¸ˆï¼Œè¯·æ•™å‡ ä¸ªåŸºç¡€é—®é¢˜ï¼š<br>1. åœ¨ä¸Šä¸€è®²ä¸­ï¼Œæœ‰ä¸€ç‚¹æˆ‘è¿˜æ˜¯æ²¡æƒ³é€šï¼Œä¸ºä½•MySQLçš„æ•°æ®å¤åˆ¶æ“ä½œå¿…é¡»è¦ç”¨sidecarå®¹å™¨æ¥å¤„ç†ï¼Œè€Œä¸ç”¨Mysqlä¸»å®¹å™¨æ¥ä¸€å¹¶è§£å†³ï¼Œä½ å½“æ—¶æåˆ°è¯´æ˜¯å› ä¸ºå®¹å™¨æ˜¯å•è¿›ç¨‹æ¨¡å‹ã€‚å¦‚æœå–æ¶ˆsidecarå®¹å™¨ï¼ŒæŠŠæ•°æ®å¤åˆ¶æ“ä½œå’Œå¯åŠ¨MySQLæœåŠ¡è¿™ä¸¤ä¸ªæ“ä½œä¸€å¹¶å†™åˆ°MySQLä¸»å®¹å™¨çš„sh -cå‘½ä»¤ä¸­ï¼Œè¿™æ ·ç®—ä¸ç®—ä¸€ä¸ªè¿›ç¨‹å‘¢ï¼Ÿ<br><br>2. StatefulSetçš„å®¹å™¨å¯åŠ¨æœ‰å…ˆåé¡ºåºï¼Œé‚£ä¹ˆå½“åºå·è¾ƒå°çš„å®¹å™¨ç”±äºæŸç§åŸå› éœ€è¦é‡å¯æ—¶ï¼Œä¼šä¸ä¼šå…ˆæŠŠåºå·è¾ƒå¤§çš„å®¹å™¨KILLæ‰ï¼Œå†æŒ‰ç…§å®ƒä»¬æœ¬æ¥çš„é¡ºåºé‡æ–°å¯åŠ¨ä¸€æ¬¡ï¼Ÿ<br><br>3. åœ¨è¿™ä¸€è®²ä¸­ï¼Œä½ æåˆ°äº†æ»šåŠ¨å‡çº§æ—¶StatefulSetæ§åˆ¶æ–°æ—§å‰¯æœ¬æ•°çš„spec.updateStrategy.rollingUpdate.Partitionå­—æ®µã€‚å‡è®¾æˆ‘ç°åœ¨å·²ç»ç”¨è¿™ä¸ªåŠŸèƒ½å·²ç»å®Œæˆäº†ç°åº¦å‘å¸ƒï¼Œéœ€è¦æŠŠæ‰€æœ‰PODéƒ½æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯Editæˆ–è€…Patchè¿™ä¸ªStatefulSetï¼ŒæŠŠspec.updateStrategy.rollingUpdate.Partitionå­—æ®µä¿®æ”¹æˆæ€»çš„PODæ•°å³å¯ï¼Ÿ<br><br>4. åœ¨è¿™ä¸€è®²ä¸­æåˆ°ControllerRevisionè¿™ä¸ªAPIå¯¹è±¡ï¼ŒK8Sä¼šå¯¹StatefulSetæˆ–DaemonSetçš„æ¯ä¸€æ¬¡æ»šåŠ¨å‡çº§éƒ½ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„ControllerRevisionå¯¹è±¡ï¼Œè¿˜æ˜¯æ¯ä¸ªStatefulSetæˆ–DaemonSetå¯¹è±¡åªä¼šæœ‰ä¸€ä¸ªå…³è”çš„ControllerRevisionå¯¹è±¡ï¼Œä¸åŒçš„revisionè®°å½•åˆ°åŒä¸€ä¸ªControllerRevisionå¯¹è±¡ä¸­ï¼Ÿ<br><br>5. Deploymenté‡Œå¯ä»¥æ§åˆ¶ä¿ç•™å†å²ReplicaSetçš„æ•°é‡ï¼Œé‚£ä¹ˆControllerRevisionè¿™ä¸ªAPIå¯¹è±¡èƒ½ä¸èƒ½åšåˆ°ä¿ç•™æŒ‡å®šæ•°é‡çš„ç‰ˆæœ¬è®°å½•ï¼Ÿ<br><br>é—®é¢˜æ¯”è¾ƒå¤šï¼Œè°¢è°¢ï¼","like_count":22,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"å¼ ç£Š Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426251,"discussion_content":"å·²ç»è§£é‡Šã€‚ä¸ä¼šï¼Œé‡å¯ä¸ä¼šç ´åæ‹“æ‰‘è§„åˆ™ï¼Œè€Œä¸”æ–‡ç« é‡Œè¯´äº†ï¼Œä½ è¦ç¡®ä¿ä½ çš„è„šæœ¬ä¸å—é‡å¯å½±å“ã€‚å»æ‰partitionã€‚å¤šä¸ªå¯¹è±¡ã€‚æ”¯æŒï¼Œå­—æ®µä¹Ÿä¸€æ ·ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1539138973,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":31373,"user_name":"Kanner","can_delete":false,"product_type":"c1","uid":1024243,"ip_address":"","ucode":"28743D9F413602","user_header":"https://static001.geekbang.org/account/avatar/00/0f/a0/f3/871e4a54.jpg","comment_is_top":false,"comment_ctime":1539165354,"is_pvip":false,"replies":[{"id":"11282","content":"ç¬¬ä¸€ï¼Œå®ƒæ¯”è¾ƒè€ã€‚ç¬¬äºŒï¼Œå®ƒè¦ç”¨replicasetã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1539173319,"ip_address":"","comment_id":31373,"utype":1}],"discussion_count":1,"race_medal":0,"score":"78848576682","product_id":100015201,"comment_content":"é‚£ä¸ºä»€ä¹ˆDeploymentä¸ç”¨ControllerRevisonç®¡ç†ç‰ˆæœ¬å‘¢","like_count":18,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"å¼ ç£Š Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426310,"discussion_content":"ç¬¬ä¸€ï¼Œå®ƒæ¯”è¾ƒè€ã€‚ç¬¬äºŒï¼Œå®ƒè¦ç”¨replicasetã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539173319,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":229796,"user_name":"Andy","can_delete":false,"product_type":"c1","uid":1119133,"ip_address":"","ucode":"4BCA899B8E4E85","user_header":"https://static001.geekbang.org/account/avatar/00/11/13/9d/0ff43179.jpg","comment_is_top":false,"comment_ctime":1593148339,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"57427723187","product_id":100015201,"comment_content":"k8s.gcr.io&#47;fluentd-elasticsearché•œåƒä¸‹ä¸åˆ°ï¼Œç™¾åº¦æœåˆ°æœ‰äººç”¨ mirrorgooglecontainers&#47;å‰å¤´çš„é•œåƒæ›¿ä»£â€œç§‘å­¦ä¸Šç½‘â€ï¼Œ<br>äºæ˜¯è®¿é—® https:&#47;&#47;hub.docker.com&#47;r&#47;é•œåƒå&#47;tags æ¥æŸ¥çœ‹æ›¿ä»£é•œåƒçš„æ‰€æœ‰ç‰ˆæœ¬ã€‚<br><br>https:&#47;&#47;hub.docker.com&#47;r&#47;mirrorgooglecontainers&#47;fluentd-elasticsearch&#47;tags<br><br>æ‰¾åˆ°äº†ä»¥ä¸‹ä¸¤ä¸ªç‰ˆæœ¬æ¥åšå®éªŒã€‚<br>mirrorgooglecontainers&#47;fluentd-elasticsearch:v2.0.0<br><br>mirrorgooglecontainers&#47;fluentd-elasticsearch:v2.4.0","like_count":13,"discussions":[{"author":{"id":2762955,"avatar":"https://static001.geekbang.org/account/avatar/00/2a/28/cb/42c9b1a0.jpg","nickname":"å¸ˆå¸ˆ","note":"","ucode":"AF3EB5FDA6285C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":400119,"discussion_content":"docker searchä¸€ä¸ªç‰ˆæœ¬ï¼Œpullä¸‹æ¥tagæˆapié‡Œçš„ç‰ˆæœ¬è¿è¡Œå³å¯ï¼Œè¿™æ˜¯å¸¸ç”¨æŠ€å·§","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1633172254,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":31379,"user_name":"å®‹æ™“æ˜","can_delete":false,"product_type":"c1","uid":1146507,"ip_address":"","ucode":"DC866DCE2FBA9E","user_header":"https://static001.geekbang.org/account/avatar/00/11/7e/8b/3cc461b3.jpg","comment_is_top":false,"comment_ctime":1539166422,"is_pvip":false,"replies":[{"id":"11283","content":"å°è§„æ¨¡ç”¨ç”¨å¯ä»¥ï¼Œä¸Šç”Ÿäº§ç¯å¢ƒè¿˜æ˜¯è¦ç”¨æ ‡å‡†çš„åŠŸèƒ½ã€‚ä½ ä¼šå‘ç°è¶Šç”¨è¶Šçˆ½ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1539173389,"ip_address":"","comment_id":31379,"utype":1}],"discussion_count":3,"race_medal":0,"score":"40193872086","product_id":100015201,"comment_content":"è€å¸ˆï¼šæœ‰æ²¡æœ‰å…¬å¸è¿™æ ·ç”¨k8sçš„ï¼šapiserverç®¡ç†å¾ˆå¤špod æ¯ä¸ªpodçš„ipåœ°å€å…¨éƒ¨æš´éœ²å‡ºæ¥ nginxçš„upstreamé…ç½®å…¨æ˜¯podçš„ipåœ°å€ï¼Œè®¿é—®æµç¨‹ä¹Ÿå°±æ˜¯clientâ€”&gt;nginxâ€”&gt;pod:port  è¿˜æœ‰ä¸€ä¸ªç¨‹åºä¼šç›‘æ§podåœ°å€å˜åŒ–ï¼Œä¸€æ—¦å˜åŒ–ï¼Œè‡ªåŠ¨æ›´æ–°nginxé…ç½®ã€‚è¿™æ˜¯æ–°å…¬å¸ä½¿ç”¨k8sçš„æµç¨‹ï¼Œæ„Ÿè§‰å¥½å¤šk8sç‰¹æ€§éƒ½æ²¡ç”¨åˆ°ï¼Œæ¯”å¦‚serviceï¼Œingressç­‰ å¤§æå°ç”¨äº†ã€‚ã€‚ã€‚","like_count":9,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"å¼ ç£Š Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426314,"discussion_content":"å°è§„æ¨¡ç”¨ç”¨å¯ä»¥ï¼Œä¸Šç”Ÿäº§ç¯å¢ƒè¿˜æ˜¯è¦ç”¨æ ‡å‡†çš„åŠŸèƒ½ã€‚ä½ ä¼šå‘ç°è¶Šç”¨è¶Šçˆ½ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539173389,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1147711,"avatar":"https://static001.geekbang.org/account/avatar/00/11/83/3f/bc2ea80d.jpg","nickname":"é™Œ.å¯’å“²","note":"","ucode":"B7079FF211D712","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":5849,"discussion_content":"ä½ è¿™ç§å°±æ˜¯å…¸å‹çš„é€‚åˆä½¿ç”¨ingressçš„","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1566485198,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2179383,"avatar":"https://static001.geekbang.org/account/avatar/00/21/41/37/b89f3d67.jpg","nickname":"æˆ‘åœ¨ç¡è§‰","note":"","ucode":"6503B611151D3C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":339046,"discussion_content":"è¿™ä¹ˆç”¨è·Ÿç”¨ä¼ ç»Ÿäº‘ä¹Ÿæ²¡å•¥åŒºåˆ«ã€‚ã€‚ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609484494,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":31236,"user_name":"è™è™â¤ï¸","can_delete":false,"product_type":"c1","uid":1086535,"ip_address":"","ucode":"157F261E80291A","user_header":"https://static001.geekbang.org/account/avatar/00/10/94/47/75875257.jpg","comment_is_top":false,"comment_ctime":1539134705,"is_pvip":false,"replies":[{"id":"11252","content":"ç³»ç»Ÿç”¨çš„å’Œç”¨æˆ·ç”¨çš„ã€‚taintæ˜¯specçš„ä¸€ä¸ªå­—æ®µ","user_name":"ä½œè€…å›å¤","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1539138585,"ip_address":"","comment_id":31236,"utype":1}],"discussion_count":1,"race_medal":0,"score":"35898873073","product_id":100015201,"comment_content":"ä¸€ç›´ä¸ç†è§£notationå’Œlabelçš„åŒºåˆ«ï¼Œä»–ä»¬çš„è®¾è®¡æ€æƒ³æ˜¯ä»€ä¹ˆå‘¢ï¼ŸåŠ æ±¡ç‚¹æ˜¯å‰è€…è¿˜æ˜¯åè€…ï¼Ÿ","like_count":8,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"å¼ ç£Š Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426262,"discussion_content":"ç³»ç»Ÿç”¨çš„å’Œç”¨æˆ·ç”¨çš„ã€‚taintæ˜¯specçš„ä¸€ä¸ªå­—æ®µ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539138585,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":38176,"user_name":"å°è°¢åŒå­¦","can_delete":false,"product_type":"c1","uid":1032544,"ip_address":"","ucode":"E809E6BC470631","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c1/60/fc3689d0.jpg","comment_is_top":false,"comment_ctime":1541983562,"is_pvip":false,"replies":[{"id":"13733","content":"ä¸æ˜¯ã€‚ç›´æ¥ç®¡pod","user_name":"ä½œè€…å›å¤","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1542000534,"ip_address":"","comment_id":38176,"utype":1}],"discussion_count":1,"race_medal":0,"score":"31606754634","product_id":100015201,"comment_content":"Stateful set ç®¡ç†çš„replica ä¸æ˜¯é€šè¿‡RSå®ç°çš„ä¹ˆï¼Ÿ","like_count":7,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"å¼ ç£Š Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":428631,"discussion_content":"ä¸æ˜¯ã€‚ç›´æ¥ç®¡pod","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1542000534,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":31215,"user_name":"donson","can_delete":false,"product_type":"c1","uid":1019482,"ip_address":"","ucode":"186A4BA2AD81DA","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8e/5a/2ed0cdec.jpg","comment_is_top":false,"comment_ctime":1539132691,"is_pvip":false,"replies":[{"id":"11255","content":"è°ƒåº¦å™¨åªæ˜¯åŸå› ä¹‹ä¸€ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1539139029,"ip_address":"","comment_id":31215,"utype":1}],"discussion_count":1,"race_medal":0,"score":"31603903763","product_id":100015201,"comment_content":"â€œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ Kubernetes v1.11 ä¹‹å‰ï¼Œç”±äºè°ƒåº¦å™¨å°šä¸å®Œå–„ï¼ŒDaemonSet æ˜¯ç”± DaemonSet Controller è‡ªè¡Œè°ƒåº¦çš„ï¼Œå³å®ƒä¼šç›´æ¥è®¾ç½® Pod çš„ spec.nodename å­—æ®µï¼Œè¿™æ ·å°±å¯ä»¥è·³è¿‡è°ƒåº¦å™¨äº†ã€‚â€ï¼Œåæ¥éšç€è°ƒåº¦å™¨çš„å®Œå–„ï¼Œè°ƒåº¦å™¨å°±æŠŠDaemonSetçš„è°ƒåº¦é€»è¾‘æ”¶å›ï¼Œç”±è°ƒåº¦å™¨ç»Ÿä¸€è°ƒåº¦ã€‚åˆ’æ¸…è¾¹ç•Œï¼Œé¢†åŸŸå†…èš","like_count":7,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"å¼ ç£Š Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426258,"discussion_content":"è°ƒåº¦å™¨åªæ˜¯åŸå› ä¹‹ä¸€ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539139029,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":240321,"user_name":"é™ˆæ°´é‡‘","can_delete":false,"product_type":"c1","uid":1085908,"ip_address":"","ucode":"2CF1FDE6E5EE4D","user_header":"https://static001.geekbang.org/account/avatar/00/10/91/d4/f530914a.jpg","comment_is_top":false,"comment_ctime":1596859259,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"23071695739","product_id":100015201,"comment_content":"è€å¸ˆæ‚¨å¥½ï¼Œæœ‰ä¸¤ä¸ªé—®é¢˜è¯·æ•™æ‚¨:1.æ—¢ç„¶æœ‰ControllerVersionè¿™æ ·é€šç”¨çš„ç‰ˆæœ¬ç®¡ç†å¯¹è±¡ï¼Œä¸ºä»€ä¹ˆDeploymentè¿˜éœ€è¦é€šè¿‡ReplicaSetæ¥è¿›è¡Œç‰ˆæœ¬æ§åˆ¶å‘¢ï¼Ÿ2.Deploymentçš„ownerReferenceåˆæ˜¯è°å‘¢ï¼ŸæœŸå¾…è€å¸ˆçš„è§£æƒ‘","like_count":5},{"had_liked":false,"id":35878,"user_name":"åˆå­¦è€…","can_delete":false,"product_type":"c1","uid":1042833,"ip_address":"","ucode":"9471A905D07CE1","user_header":"https://static001.geekbang.org/account/avatar/00/0f/e9/91/4219d305.jpg","comment_is_top":false,"comment_ctime":1540828270,"is_pvip":true,"replies":[{"id":"12794","content":"æ‰€ä»¥ä½ å°±å¾—åœ¨daemonset controlleré‡Œå†™è°ƒåº¦äº†","user_name":"ä½œè€…å›å¤","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1540875318,"ip_address":"","comment_id":35878,"utype":1}],"discussion_count":1,"race_medal":0,"score":"23015664750","product_id":100015201,"comment_content":"è¿˜æ˜¯æ²¡æœ‰æ˜ç™½damonsetçš„å®ç°ä¸&quot;æ±¡ç‚¹&quot;çš„å…³ç³»ï¼Œç†è®ºä¸Šä¸ºäº†å®ç°æ¯ä¸ªnodeä¸Šæœ‰ä¸”åªæœ‰pod, daemonset controller å’Œnodeaffinityå°±å¯ä»¥äº†ï¼Œä¸ºå•¥éœ€è¦&quot;æ±¡ç‚¹&quot;æœºåˆ¶ï¼Ÿ","like_count":5,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"å¼ ç£Š Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":427698,"discussion_content":"æ‰€ä»¥ä½ å°±å¾—åœ¨daemonset controlleré‡Œå†™è°ƒåº¦äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1540875318,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":157353,"user_name":"Tao","can_delete":false,"product_type":"c1","uid":1466809,"ip_address":"","ucode":"75FBDF49C601F4","user_header":"https://static001.geekbang.org/account/avatar/00/16/61/b9/dbf629c0.jpg","comment_is_top":false,"comment_ctime":1575119165,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"14460021053","product_id":100015201,"comment_content":"DaemonSetå¦‚ä½•ä¿è¯æ¯ä¸ªnodeä¸Šåªè¿è¡Œä¸€ä¸ªpodã€‚<br>\tæˆ‘ç†è§£Nodeaffinityä¿è¯äº†daemonSetæŒ‡å®šè¿è¡Œåœ¨å“ªäº›nodeä¸Šï¼ŒTolerationä¿è¯äº†æŒ‡å®šçš„Nodeä¸Šéƒ½å¯ä»¥è¿è¡Œpodï¼›<br>\tä½†æ˜¯æ²¡æœ‰çœ‹åˆ°é‚£ä¸ªåœ°æ–¹é™åˆ¶äº†DaemonSetä¿è¯åœ¨nodeä¸Šåªå…è®¸ä¸€ä¸ªpodã€‚","like_count":3,"discussions":[{"author":{"id":1227336,"avatar":"https://static001.geekbang.org/account/avatar/00/12/ba/48/c892a35b.jpg","nickname":"csoulsi","note":"","ucode":"96C9BBE9097FB3","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":81843,"discussion_content":"ä½œè€…è¯´äº†ï¼Œå½“æ§åˆ¶å™¨é‡Œçš„æ•°é‡å’Œ pod etcdä¸­æ•°é‡ä¸åŒï¼Œæ¯”å¦‚å¤šä½™ä¸€ä¸ªæ—¶ï¼Œä¼šè°ƒç”¨api è¿›è¡Œåˆ é™¤ã€‚","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1576288422,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":31352,"user_name":"è™è™â¤ï¸","can_delete":false,"product_type":"c1","uid":1086535,"ip_address":"","ucode":"157F261E80291A","user_header":"https://static001.geekbang.org/account/avatar/00/10/94/47/75875257.jpg","comment_is_top":false,"comment_ctime":1539156214,"is_pvip":false,"replies":[{"id":"11284","content":"ç›®å‰æ²¡æœ‰è‡ªåŠ¨åŒ–çš„æ‰‹æ®µï¼Œéœ€è¦ä½ åˆ é™¤é”™è¯¯podï¼Œrolloutæ­£ç¡®çš„ç‰ˆæœ¬ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1539173488,"ip_address":"","comment_id":31352,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14424058102","product_id":100015201,"comment_content":"sts åœ¨updateçš„è¿‡ç¨‹ä¸­å¦‚æœå¤±è´¥ï¼Œå¹¶ä¸”æ²¡æœ‰åŠæ³•restoreï¼Œæ¯”å¦‚pulling image failã€‚è¿™ç§æƒ…å†µåº”è¯¥æ€ä¹ˆæ¢å¤ï¼Ÿ<br><br>æˆ‘å°è¯•å†patchä¸€ä¸ªæ­£ç¡®çš„image è·¯å¾„ï¼Œä½†æ˜¯æ²¡æœ‰ååº”ã€‚ ç„¶åæˆ‘deleteæ‰äº†å‡ºé”™çš„podã€‚æ­£å¸¸çš„åšæ³•åº”è¯¥æ˜¯ä»€ä¹ˆï¼Ÿroll out åˆ°ä¸Šä¸€ä¸ª&#47;ä¸‹ä¸€ä¸ªæ­£ç¡®ç‰ˆæœ¬ï¼Ÿ","like_count":3,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"å¼ ç£Š Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426301,"discussion_content":"ç›®å‰æ²¡æœ‰è‡ªåŠ¨åŒ–çš„æ‰‹æ®µï¼Œéœ€è¦ä½ åˆ é™¤é”™è¯¯podï¼Œrolloutæ­£ç¡®çš„ç‰ˆæœ¬ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539173488,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":31285,"user_name":"æ”¾å¼€é‚£å¨ä¾¿ä¾¿","can_delete":false,"product_type":"c1","uid":1227208,"ip_address":"","ucode":"A5767662EBC9F1","user_header":"https://static001.geekbang.org/account/avatar/00/12/b9/c8/be96e383.jpg","comment_is_top":false,"comment_ctime":1539142835,"is_pvip":false,"replies":[{"id":"11267","content":"è¿™é‡Œå†™çš„ä¸å‡†ç¡®äº†ã€‚ä¸æ˜¯è‡ªåŠ¨å›æ»šï¼Œè€Œæ˜¯ä¸æ–­ä½¿ç”¨å½“å‰ç‰ˆæœ¬é‡æ–°åˆ›å»ºã€‚å¯¹äºå·²ç»æ›´æ–°è¿‡çš„ï¼Œå½“å‰ç‰ˆæœ¬å°±æ˜¯æ–°ç‰ˆæœ¬ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1539152590,"ip_address":"","comment_id":31285,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14424044723","product_id":100015201,"comment_content":"â€œè¿™æ ·ï¼Œmysql è¿™ä¸ª StatefulSet å°±ä¼šä¸¥æ ¼æŒ‰ç…§ Pod çš„åºå·ï¼Œé€ä¸€æ›´æ–° MySQL å®¹å™¨çš„é•œåƒã€‚è€Œå¦‚æœæ›´æ–°æœ‰é”™è¯¯ï¼Œå®ƒä¼šè‡ªåŠ¨å›æ»šåˆ°åŸå…ˆçš„ç‰ˆæœ¬ã€‚â€<br><br>æˆ‘æµ‹è¯•çš„æ—¶å€™æ²¡æœ‰è‡ªåŠ¨å›æ»šï¼Œè¯·é—®è‡ªåŠ¨å›æ»šæ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿéœ€è¦ä¿®æ”¹ä»€ä¹ˆé…ç½®ä¹ˆï¼Ÿ","like_count":3,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"å¼ ç£Š Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426276,"discussion_content":"è¿™é‡Œå†™çš„ä¸å‡†ç¡®äº†ã€‚ä¸æ˜¯è‡ªåŠ¨å›æ»šï¼Œè€Œæ˜¯ä¸æ–­ä½¿ç”¨å½“å‰ç‰ˆæœ¬é‡æ–°åˆ›å»ºã€‚å¯¹äºå·²ç»æ›´æ–°è¿‡çš„ï¼Œå½“å‰ç‰ˆæœ¬å°±æ˜¯æ–°ç‰ˆæœ¬ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539152590,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":315363,"user_name":"é™ˆæ–¯ä½³","can_delete":false,"product_type":"c1","uid":1259323,"ip_address":"","ucode":"C236F874FC767A","user_header":"https://static001.geekbang.org/account/avatar/00/13/37/3b/495e2ce6.jpg","comment_is_top":false,"comment_ctime":1633860125,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10223794717","product_id":100015201,"comment_content":"ç¬¬äºŒåä¸€è¯¾:å®¹å™¨åŒ–å®ˆæŠ¤è¿›ç¨‹çš„æ„ä¹‰:DaemonSet<br>DaemonSetçš„ä¸»è¦ä½œç”¨æ˜¯è®©ä½ åœ¨Kuberneteé›†ç¾¤é‡Œï¼Œè¿è¡Œæœ‰ä¸”åªæœ‰ä¸€ä¸ªDaemonSet Podï¼Œå¹¶ä¸”ä¼šéšç€æ–°çš„Nodeæ·»åŠ æˆ–è€çš„Nodeåˆ é™¤è€Œæ·»åŠ &#47;åˆ é™¤Nodeä¸Šçš„Podã€‚å®ƒçš„åº”ç”¨åœºæ™¯æœ‰ç½‘ç»œæ’ä»¶ã€å­˜å‚¨æ’ä»¶å’Œç›‘æ§ä»¥åŠæ—¥å¿—æ”¶é›†ã€‚å®ƒå¾ˆå¤šæ—¶å€™æ¯”Kubernetesé›†ç¾¤å‡ºç°çš„æ—¶æœºéƒ½è¦æ—©ã€‚<br><br>è¿™ç§æ·»åŠ åˆ é™¤çš„è¿‡ç¨‹æ˜¯ï¼Œé¦–å…ˆä»Etcdé‡Œè·å–æ‰€æœ‰çš„Nodeåˆ—è¡¨ï¼Œç„¶åéå†æ‰€æœ‰çš„Nodeï¼Œçœ‹çœ‹å®ƒæ˜¯å¦æœ‰è¿è¡Œç€å¸¦æœ‰æŸç§labelçš„Podã€‚å¦‚æœæ²¡æœ‰ï¼Œå°±åˆ›å»ºä¸€ä¸ªï¼›å¦‚æœå¤šäº†å°±åˆ é™¤å¤šä½™çš„ã€‚åœ¨åˆ›å»ºçš„æ—¶å€™ï¼Œé€šè¿‡nodeSelectoræˆ–è€…nodeAffiinityå­—æ®µï¼Œè¿˜æœ‰tolerationså­—æ®µæ¥å’Œéœ€è¦è¿è¡Œçš„Nodeè¿›è¡Œä¸€å¯¹ä¸€ç»‘å®šã€‚å…¶ä¸­tolerationså­—æ®µä½¿å¾—DaemonSetèƒ½å¤Ÿæ¯”å…¶ä»–æ§åˆ¶å™¨æ›´æ—©å‡ºç°åœ¨Kubernetesé›†ç¾¤å¯åŠ¨æ—¶å€™ã€‚å¯¹äº†ï¼Œè¿™ä¸ªä¹Ÿé¡ºå¸¦è§£å†³äº†æˆ‘ä¸€ä¸ªç–‘æƒ‘ï¼Œå°±æ˜¯æˆ‘ç°åœ¨K8sç¯å¢ƒé‡Œçš„Grafanaä¸ºå•¥æ²¡æœ‰ç›‘æ§åˆ°masteræœåŠ¡å™¨ï¼Œå› ä¸ºå°‘äº†ä»¥ä¸‹è¿™ä¸ªå­—æ®µ<br><br>tolerations:<br>- key: node-role.kubernetes.io&#47;master<br>  effect: NoSchedule<br><br>K8sä¸­è¿˜æœ‰ä¸€ä¸ªä¸“é—¨çš„APIç”¨äºç‰ˆæœ¬æ§åˆ¶ï¼Œå®ƒæ˜¯ControllerRevisionï¼Œå®ƒåœ¨è‡ªå·±çš„Dataå­—æ®µé‡Œä¿å­˜äº†å¯¹åº”ç‰ˆæœ¬DaemonSetçš„APIå¯¹è±¡ï¼Œè¿˜æœ‰åœ¨Annotationé‡Œä¿å­˜äº†kubectlçš„å‘½ä»¤","like_count":2},{"had_liked":false,"id":304862,"user_name":"å¤§ä¸Šæµ·","can_delete":false,"product_type":"c1","uid":1092861,"ip_address":"","ucode":"3969C018D6C0DC","user_header":"https://static001.geekbang.org/account/avatar/00/10/ac/fd/f70a6e3e.jpg","comment_is_top":false,"comment_ctime":1627645032,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10217579624","product_id":100015201,"comment_content":"GFWé—®é¢˜æ‹‰ä¸ä¸‹æ¥ï¼Œå¯ä»¥è‡ªå·±å…ˆæ‹‰ä¸‹æ¥ï¼Œå†åˆ›å»º<br><br>docker pull mirrorgooglecontainers&#47;fluentd-elasticsearch:v2.4.0<br><br>docker tag docker.io&#47;mirrorgooglecontainers&#47;fluentd-elasticsearch:v2.4.0 k8s.gcr.io&#47;fluentd-elasticsearch:v2.4.0","like_count":2},{"had_liked":false,"id":238944,"user_name":"ç½—ç½—","can_delete":false,"product_type":"c1","uid":1052878,"ip_address":"","ucode":"410E21E5BAFD31","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/QKbgfE8mY91fjkLuyDKHUGlpfxKyhiaib5v3ic3YT6qrLibFWxoiaKCxzLeuJROiaWquCb0cNI0lCjiaDY92hSAKHsHUg/132","comment_is_top":false,"comment_ctime":1596377248,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5891344544","product_id":100015201,"comment_content":"åœ¨è¿™é‡Œï¼Œä½ åº”è¯¥æ³¨æ„åˆ° nodeAffinity çš„å®šä¹‰ï¼Œå¯ä»¥æ”¯æŒæ›´åŠ ä¸°å¯Œçš„è¯­æ³•ï¼Œæ¯”å¦‚ operator: Inï¼ˆå³ï¼šéƒ¨åˆ†åŒ¹é…ï¼›å¦‚æœä½ å®šä¹‰ operator: Equalï¼Œå°±æ˜¯å®Œå…¨åŒ¹é…ï¼‰  ","like_count":1},{"had_liked":false,"id":71775,"user_name":"æ— åæ°","can_delete":false,"product_type":"c1","uid":1001023,"ip_address":"","ucode":"D1F322E386430E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/46/3f/7825378a.jpg","comment_is_top":false,"comment_ctime":1551430092,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"5846397388","product_id":100015201,"comment_content":"å‡è®¾æœ‰è¿™ä¹ˆä¸€ç§åœºæ™¯ï¼Œä¸šåŠ¡Podéœ€è¦åœ¨æ¯ä¸ªNodeä¸Šæœ‰ä¸”åªæœ‰1ä¸ªï¼Œåœ¨ç°åº¦å‡çº§æ—¶ï¼ŒæŒ‰10%ï¼Œ30%ï¼Œ50%ï¼Œ100%æ‰¹é‡å‡çº§ï¼Œåç»­æŸä¸ªç‰ˆæœ¬å†æ¬¡å‡çº§æ—¶ï¼Œè¿™ç§å‡çº§ç­–ç•¥å¯èƒ½ä¼šå˜æ›´ï¼Œæ¯”å¦‚10%ï¼Œ70%ï¼Œ100%ï¼Œè¯·é—®æ€ä¹ˆå¤„ç†ï¼Œè°¢è°¢ã€‚","like_count":1,"discussions":[{"author":{"id":1971269,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/oltLEqTrmHm2aJP99BK6tHu5h7hp4aj08wR5Wt6H31iadFduDAVvjYKmhQ2nvGbLV3lkVdiat2GRasgWXoJeTibUg/132","nickname":"æ¨","note":"","ucode":"7EFEFE285975C6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":404232,"discussion_content":"æ–‡ç« ä¸Šå†™çš„ç°åº¦å‡çº§éœ€è¦ç”¨åˆ°statefulsetä¸­çš„partitionå­—æ®µ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634263524,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":31241,"user_name":"è™è™â¤ï¸","can_delete":false,"product_type":"c1","uid":1086535,"ip_address":"","ucode":"157F261E80291A","user_header":"https://static001.geekbang.org/account/avatar/00/10/94/47/75875257.jpg","comment_is_top":false,"comment_ctime":1539135208,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5834102504","product_id":100015201,"comment_content":"DJH é—®çš„é—®é¢˜å¾ˆå¥½ï¼Œæœ‰æ—¶å€™æˆ‘ä¹Ÿæœ‰è¿‡è¿™æ ·çš„ç–‘é—®ï¼Œç¨çºµå³é€ï¼Œæ²¡æœ‰è®°å½•ä¸‹æ¥ã€‚æˆ‘è¯•ç€å›ç­”ä¸€ä¸‹ã€‚<br><br>1. å¦‚æœåœ¨ä¸€ä¸ªå®¹å™¨é‡Œï¼Œå‘½ä»¤æ€»æœ‰å…ˆåé¡ºåºã€‚é‚£ä¹ˆä½ loadæ•°æ®çš„sqlåœ¨serverå¯åŠ¨å‰å¦‚ä½•æ‰§è¡Œã€‚<br>2. åº”è¯¥ä¸ä¼škillå§ï¼Œä¸çŸ¥é“æœ‰æ²¡æœ‰å‚æ•°æ§åˆ¶ã€‚è¿™æ ·æ˜¯ä¸æ˜¯è¦æœ‰ä¸€ä¸ªdowntimeå»åšå‡çº§ï¼Ÿå› ä¸ºå¯èƒ½å‡ºç°ç‰ˆæœ¬ä¸ä¸€è‡´ä¸­é—´çŠ¶æ€<br>3 åº”è¯¥æŠŠpartationå‚æ•°å»æ‰å§ï¼Œå¦åˆ™ä»¥åå¢åŠ èŠ‚ç‚¹ä¼šä¸ä¼šå‡ºç°æ„æƒ³ä¸åˆ°çš„é—®é¢˜ï¼Ÿ<br>4åº”è¯¥æ˜¯ä¸€ä¸ªç‰ˆæœ¬ä¸€ä¸ªå¯¹è±¡ï¼Œæ¯ä¸ªç‰ˆæœ¬å¯¹è±¡ç‰ˆæœ¬å·ä¸ä¸€æ ·<br>5 ä¸äº†è§£ï¼Œä½†æ˜¯è®¾è®¡åº”è¯¥æ˜¯ä¸€è‡´çš„ã€‚å¯èƒ½æœ‰","like_count":1},{"had_liked":false,"id":360841,"user_name":"ç¬¬ä¸€è£…ç”²é›†ç¾¤å¸ä»¤å…‹è±æ–¯ç‰¹","can_delete":false,"product_type":"c1","uid":1265707,"ip_address":"åŒ—äº¬","ucode":"4E8FBB23AD860B","user_header":"https://static001.geekbang.org/account/avatar/00/13/50/2b/2344cdaa.jpg","comment_is_top":false,"comment_ctime":1666916765,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1666916765","product_id":100015201,"comment_content":"é›†å›¢å†›ç¾¤","like_count":0},{"had_liked":false,"id":337155,"user_name":"è¶…çº§èŠ’æœå†°","can_delete":false,"product_type":"c1","uid":1188976,"ip_address":"","ucode":"97480FBFA4F699","user_header":"https://static001.geekbang.org/account/avatar/00/12/24/70/4e7751f3.jpg","comment_is_top":false,"comment_ctime":1646651778,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1646651778","product_id":100015201,"comment_content":"è€å¸ˆï¼Œâ€œè¿™ä¸ª Podï¼Œå°†æ¥åªå…è®¸è¿è¡Œåœ¨â€œmetadata.nameâ€æ˜¯â€œnode-geektimeâ€çš„èŠ‚ç‚¹ä¸Šâ€  è¿™æ˜¯åŸæ–‡ã€‚æƒ³é—®ä¸‹ï¼Œæ€ä¹ˆç»™ç»™ç‚¹çš„metadata.nameå±æ€§æ ‡è®°ä¸Šnode-geektimeï¼Œä»€ä¹ˆæ—¶å€™å¯ä»¥æ ‡è®°ï¼Ÿ","like_count":0},{"had_liked":false,"id":282473,"user_name":"nullptr","can_delete":false,"product_type":"c1","uid":1283847,"ip_address":"","ucode":"D309EABB70F0BF","user_header":"https://static001.geekbang.org/account/avatar/00/13/97/07/7406fe30.jpg","comment_is_top":false,"comment_ctime":1615270227,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1615270227","product_id":100015201,"comment_content":"è€å¸ˆï¼Œagentå¯ä»¥ææˆDaemonSetï¼Œé‚£æ€ä¹ˆä¿è¯ä»–æ¯”åº”ç”¨podå…ˆå¯åŠ¨å‘¢ï¼Ÿ","like_count":0},{"had_liked":false,"id":280234,"user_name":"ä¸ä¹æ´ª","can_delete":false,"product_type":"c1","uid":1264392,"ip_address":"","ucode":"549CE57AB20B49","user_header":"https://static001.geekbang.org/account/avatar/00/13/4b/08/52954cd7.jpg","comment_is_top":false,"comment_ctime":1614138612,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1614138612","product_id":100015201,"comment_content":"æœ‰æ²¡æœ‰playgroundï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1740409,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/8e/79/f9d5dd3a.jpg","nickname":"å•è¶…","note":"","ucode":"B36883984BE16B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":352964,"discussion_content":"https://labs.play-with-k8s.com/","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1614928768,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":280093,"user_name":"è‘£æ°¸åˆš","can_delete":false,"product_type":"c1","uid":1169147,"ip_address":"","ucode":"ADA792B226A6CD","user_header":"https://static001.geekbang.org/account/avatar/00/11/d6/fb/837af7bf.jpg","comment_is_top":false,"comment_ctime":1614078619,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1614078619","product_id":100015201,"comment_content":"ä¸ºä»€ä¹ˆçœ‹çš„æ—¶å€™å¾ˆæ˜ç™½ï¼Œä½†æ˜¯å®é™…æ“ä½œçš„æ—¶å€™å°±å„ç§é—®é¢˜ï¼Œæ¡‘å¿ƒ","like_count":0,"discussions":[{"author":{"id":1030861,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJrqLEic7DVicYY1s9ldH0vGBialDoplVGpicZUJ0Fdaklw27Frv8Ac67eicb5LibhL74SUxAzlick2nfltA/132","nickname":"jiangb","note":"","ucode":"A09415749CA88D","race_medal":1,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":563518,"discussion_content":"ä¸€æ ·ï¼Œå¤šçœ‹å‡ éã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1650014714,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":248274,"user_name":"ch_ort","can_delete":false,"product_type":"c1","uid":1580926,"ip_address":"","ucode":"B79746E687F29E","user_header":"","comment_is_top":false,"comment_ctime":1600087366,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1600087366","product_id":100015201,"comment_content":"replicasetæ˜¯ä¸æ˜¯ä¹Ÿç”¨controllerversionæ¥ç®¡ç†ç‰ˆæœ¬çš„å‘¢ï¼Ÿ ","like_count":0},{"had_liked":false,"id":248273,"user_name":"ch_ort","can_delete":false,"product_type":"c1","uid":1580926,"ip_address":"","ucode":"B79746E687F29E","user_header":"","comment_is_top":false,"comment_ctime":1600087348,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1600087348","product_id":100015201,"comment_content":"DaemonSetåœ¨æ¯ä¸ªNodeä¸Šå¯ä¸€ä¸ªPodå®ä¾‹ï¼Œéšç€Nodeçš„å¢åˆ æ¥èµ·åœå¯¹åº”çš„Podã€‚<br><br>Deploymentã€StatefuleSetã€DaemonSetä¸‰è€…çš„å¯¹æ¯”ï¼š<br><br>  ç±»åˆ«  \tDeployment\tStatefulSet       \tDaemonSet         <br>  æ•°é‡  \tReplicas  \tReplicas          \tNodeæ•°é‡            <br>  ç‰ˆæœ¬  \tReplicates\tControllerVevision\tControllerVevision<br><br>åœ¨ Kubernetes é¡¹ç›®é‡Œï¼ŒControllerRevision æ˜¯ä¸€ä¸ªé€šç”¨çš„ç‰ˆæœ¬ç®¡ç†å¯¹è±¡ã€‚è¿™æ ·ï¼ŒKubernetes é¡¹ç›®å°±å·§å¦™åœ°é¿å…äº†æ¯ç§æ§åˆ¶å™¨éƒ½è¦ç»´æŠ¤ä¸€å¥—å†—ä½™çš„ä»£ç å’Œé€»è¾‘çš„é—®é¢˜ã€‚<br>","like_count":0},{"had_liked":false,"id":238945,"user_name":"ç½—ç½—","can_delete":false,"product_type":"c1","uid":1052878,"ip_address":"","ucode":"410E21E5BAFD31","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/QKbgfE8mY91fjkLuyDKHUGlpfxKyhiaib5v3ic3YT6qrLibFWxoiaKCxzLeuJROiaWquCb0cNI0lCjiaDY92hSAKHsHUg/132","comment_is_top":false,"comment_ctime":1596377376,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1596377376","product_id":100015201,"comment_content":"åœ¨è¿™é‡Œï¼Œä½ åº”è¯¥æ³¨æ„åˆ° nodeAffinity çš„å®šä¹‰ï¼Œå¯ä»¥æ”¯æŒæ›´åŠ ä¸°å¯Œçš„è¯­æ³•ï¼Œæ¯”å¦‚ operator: Inï¼ˆå³ï¼šéƒ¨åˆ†åŒ¹é…ï¼›å¦‚æœä½ å®šä¹‰ operator: Equalï¼Œå°±æ˜¯å®Œå…¨åŒ¹é…ï¼‰<br><br>æ–‡ä¸­è¿™å¥è¯çš„operatorå®šä¹‰ï¼Œæˆ‘åœ¨å®˜ç½‘ä¸Šåªè¯´æœ‰Inï¼ŒNotInï¼ŒExistsï¼ŒDoesNotExistï¼ŒGtï¼ŒLtç­‰ï¼Œæ˜¯ä¸æ˜¯å†™é”™äº†ï¼Ÿhttps:&#47;&#47;kubernetes.io&#47;docs&#47;concepts&#47;scheduling-eviction&#47;assign-pod-node&#47;","like_count":0},{"had_liked":false,"id":237068,"user_name":"è‰ºè¶…(é²é¸£)","can_delete":false,"product_type":"c1","uid":1029436,"ip_address":"","ucode":"7F749FA543E0F1","user_header":"https://static001.geekbang.org/account/avatar/00/0f/b5/3c/967d7291.jpg","comment_is_top":false,"comment_ctime":1595665426,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1595665426","product_id":100015201,"comment_content":"è€å¸ˆå¥½ï¼Œè¯·æ•™ä¸€ä¸‹<br>æ˜¯è¯´æ¯ä¸ªnodeä¸Šï¼Œå¯ä»¥æœ‰å¤šä¸ªDaemonSet Podï¼Œä½†æ˜¯åªæ˜¯ä¿è¯æ¯ç§åªæœ‰ä¸€ä¸ªæ˜¯è¿™ä¸ªæ„æ€å—ï¼Œæ¯”å¦‚ä¼šæœ‰æ—¥å¿—æ”¶é›†çš„DaemonSet podï¼Œä¹Ÿä¼šæœ‰network-agentçš„DaemonSet podï¼Ÿ<br>è¿˜æ˜¯å¦å¤–ä¸€ä¸ªæ„æ€å‘¢ï¼Œå®é™…ä¸Šæ¯ä¸ªNodeä¸Šåªèƒ½æœ‰ä¸€ä¸ªDaemonSet podï¼Œé‡Œé¢ä¼šåŒ…å«å¤šä¸ªå®¹å™¨ï¼Œ æ—¥å¿—æ”¶é›†+xxx agentï¼Ÿ","like_count":0},{"had_liked":false,"id":135283,"user_name":"æ†¶æµ·æ‹¾è²","can_delete":false,"product_type":"c1","uid":1054727,"ip_address":"","ucode":"99E883A8601DED","user_header":"https://static001.geekbang.org/account/avatar/00/10/18/07/9f5f5dd3.jpg","comment_is_top":false,"comment_ctime":1569117932,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1569117932","product_id":100015201,"comment_content":"&gt; åˆ°ç›®å‰ä¸ºæ­¢ï¼ŒDSåªæœ‰ä¸€ç§ç­–ç•¥å°±æ˜¯å…ˆåˆ é™¤å†åˆ›å»º OnDelete.<br>æˆ‘æŸ¥k8sçš„dsæºç ä»¥åŠk8sçš„dsæ–‡æ¡£,éƒ½æœ‰æåˆ°RollingUpdate.<br>æ‰€ä»¥ç‰¹åˆ«å¥½å¥‡å¼ sirè¯„è®ºä¸­çš„è¿™æ¡å›å¤, dsä¸ä½¿ç”¨RollingUpdateç­–ç•¥æ›´æ–°, æ˜¯å› ä¸ºRollingUpdateå‘æ¯”è¾ƒå¤š,æ‰€ä»¥å®è·µä¸­æ¨èä½¿ç”¨OnDelete?","like_count":0},{"had_liked":false,"id":131583,"user_name":"ç´«å¤œ","can_delete":false,"product_type":"c1","uid":1205423,"ip_address":"","ucode":"88CFF4C188B65A","user_header":"https://static001.geekbang.org/account/avatar/00/12/64/af/6dbbb482.jpg","comment_is_top":false,"comment_ctime":1567818249,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1567818249","product_id":100015201,"comment_content":"å¼ è€å¸ˆï¼Œæˆ‘æƒ³è¯·æ•™ä¸ªé—®é¢˜ï¼Œdaemonsetä½¿ç”¨æ»šåŠ¨æ›´æ–°ç­–ç•¥ï¼Œå¦‚æœupdateæ—¶åªæ˜¯å˜æ›´äº†nodeaffinityï¼Œtemplateä¸­å…¶ä»–å­—æ®µä¿æŒä¸å˜ï¼Œæ§åˆ¶å™¨æ˜¯å¦‚ä½•å¤„ç†çš„ï¼Ÿæ¯”å¦‚æˆ‘åœ¨nodeaffinityä¸­æ–°å¢äº†ä¸€ä¸ªnode,æ˜¯åªåœ¨æ–°å¢çš„nodeä¸Šéƒ¨ç½²ä¸€ä¸ªpodï¼Œå…¶å®ƒpodä¿æŒä¸å˜ï¼Œè¿˜æ˜¯æ‰€æœ‰èŠ‚ç‚¹ä¸Šçš„podéƒ½ä¼šæ›´æ–°ï¼Ÿ","like_count":0},{"had_liked":false,"id":126475,"user_name":"å¯»","can_delete":false,"product_type":"c1","uid":1167430,"ip_address":"","ucode":"473B2CC14158A7","user_header":"https://static001.geekbang.org/account/avatar/00/11/d0/46/7f9af8de.jpg","comment_is_top":false,"comment_ctime":1566392124,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1566392124","product_id":100015201,"comment_content":"å¼ è€å¸ˆï¼Œæ‚¨å¥½ Daemonsetæ—¢ç„¶å‡ºç°çš„æ—¶æœºæ¯”kubernetesé›†ç¾¤è®¾ç½®éƒ½è¦æ—©ï¼Œé‚£ä¸ºä»€ä¹ˆè¿˜èƒ½è°ƒç”¨apiserverç»„ä»¶ï¼Ÿ","like_count":0},{"had_liked":false,"id":122095,"user_name":"å†·é£","can_delete":false,"product_type":"c1","uid":1206550,"ip_address":"","ucode":"7C53078CDE16D1","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEJaeQkzjMYtz2O4Ala7bhzQdicaryDkH9314IhlY9icx9bZ2uSEw4thSzTSXkPaWm8m1tlB33XegqsQ/132","comment_is_top":false,"comment_ctime":1565286803,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1565286803","product_id":100015201,"comment_content":"è€å¸ˆè¯·æ•™ä¸€ä¸ªé—®é¢˜ï¼Œæ˜¯å¦å¯ä»¥å¯¹daemonsetå¯åŠ¨çš„æ¯ä¸ªpodè®¾ç½®ä¸åŒçš„hostname? æ„Ÿè°¢å›ç­”ï¼","like_count":0},{"had_liked":false,"id":93534,"user_name":"beenchaos","can_delete":false,"product_type":"c1","uid":1007348,"ip_address":"","ucode":"1BAA2F4F216899","user_header":"https://static001.geekbang.org/account/avatar/00/0f/5e/f4/776ad2df.jpg","comment_is_top":false,"comment_ctime":1557489750,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1557489750","product_id":100015201,"comment_content":"è¯·é—®è€å¸ˆï¼Œåœ¨ä¸€ä¸ªé›†ç¾¤ä¸Šéƒ¨ç½²ä¸€ç±»daemonsetç±»å‹çš„æœåŠ¡ï¼Œèƒ½å¦è¿›è¡Œç°åº¦å‘å¸ƒå‘¢ï¼Ÿ","like_count":0},{"had_liked":false,"id":78306,"user_name":"ichiro","can_delete":false,"product_type":"c1","uid":1086179,"ip_address":"","ucode":"D1708D87538F42","user_header":"https://static001.geekbang.org/account/avatar/00/10/92/e3/1be13204.jpg","comment_is_top":false,"comment_ctime":1553129194,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1553129194","product_id":100015201,"comment_content":"è€å¸ˆï¼Œä¸ºä»€ä¹ˆdeployment setï¼Œä¸ç”¨controllerrevisonæ¥ä½œä¸ºç‰ˆæœ¬ç®¡ç†ä¹ˆï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1147642,"avatar":"https://static001.geekbang.org/account/avatar/00/11/82/fa/42a2eb88.jpg","nickname":"åƒä¸ªå­©å­","note":"","ucode":"117B0336011F8F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":320555,"discussion_content":"deployment setç®¡ç†çš„æ˜¯replicationSetï¼ŒreplicationSetåšç‰ˆæœ¬ç®¡ç†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604397018,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":76731,"user_name":"bluefantasy1","can_delete":false,"product_type":"c1","uid":1106810,"ip_address":"","ucode":"83440E87C4EED3","user_header":"","comment_is_top":false,"comment_ctime":1552697972,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1552697972","product_id":100015201,"comment_content":"è¯·æ•™è€å¸ˆä¸€ä¸ªé—®é¢˜ï¼šå¦‚æœç›´æ¥åœ¨ä¸€å°ç‰©ç†æœºä¸Šéƒ¨ç½²å„ä¸ªpodï¼Œè‚¯å®šä¸éœ€è¦å®‰è£…ç½‘ç»œæ’ä»¶å’Œå­˜å‚¨æ’ä»¶äº†å§ï¼Ÿ","like_count":0},{"had_liked":false,"id":47121,"user_name":"abc","can_delete":false,"product_type":"c1","uid":1198332,"ip_address":"","ucode":"A4E989E85848D9","user_header":"https://static001.geekbang.org/account/avatar/00/12/48/fc/f46062b6.jpg","comment_is_top":false,"comment_ctime":1544060317,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1544060317","product_id":100015201,"comment_content":"å¼ è€å¸ˆï¼ŒDSçš„æ»šåŠ¨å‡çº§æ˜¯å…ˆåˆ›å»ºæ–°çš„å†åˆ é™¤æ—§çš„å—ï¼Ÿè¿˜æ˜¯è¯´æ»šåŠ¨å‡çº§æœ‰ç­–ç•¥å¯ä»¥é…ç½®ã€‚è¯¥å¦‚ä½•é…ç½®ï¼Ÿ","like_count":0},{"had_liked":false,"id":44635,"user_name":"Terry Hu","can_delete":false,"product_type":"c1","uid":1219820,"ip_address":"","ucode":"9487EEECC051B5","user_header":"https://static001.geekbang.org/account/avatar/00/12/9c/ec/5da5c049.jpg","comment_is_top":false,"comment_ctime":1543467756,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1543467756","product_id":100015201,"comment_content":"å‘ç°ä¸€ä¸ªå¥½åƒæ˜¯bug,æˆ‘åœ¨set image çš„æ—¶å€™ï¼Œk8s.gcr.io&#47;fluentd-elasticsearchçš„v2.1.0ç‰ˆæœ¬å³ä½¿æˆ‘åŠ äº†--recordï¼Œåœ¨rollout historyé‡Œé¢ä¹Ÿæ˜¾ç¤ºv2.2.0ï¼Œä¸çŸ¥é“æ˜¯ä¸ºå•¥ã€‚ã€‚","like_count":0},{"had_liked":false,"id":31845,"user_name":"abc","can_delete":false,"product_type":"c1","uid":1198332,"ip_address":"","ucode":"A4E989E85848D9","user_header":"https://static001.geekbang.org/account/avatar/00/12/48/fc/f46062b6.jpg","comment_is_top":false,"comment_ctime":1539310496,"is_pvip":false,"replies":[{"id":"11497","content":"å¯ä»¥çš„","user_name":"ä½œè€…å›å¤","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1539311759,"ip_address":"","comment_id":31845,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1539310496","product_id":100015201,"comment_content":"è€å¸ˆï¼Œå’¨è¯¢ä¸ªé—®é¢˜ï¼šæ—¢ç„¶DaemonSetä¹Ÿæ˜¯å¯ä»¥å®šä¹‰selectorçš„ï¼Œé‚£æ˜¯ä¸æ˜¯å¯ä»¥ç†è§£ä¸ºå¯ä»¥äººä¸ºå¹²é¢„DaemonSet Podè°ƒåº¦åˆ°æŒ‡å®šçš„èŠ‚ç‚¹ä¸Šå»ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"å¼ ç£Š Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426536,"discussion_content":"å¯ä»¥çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539311759,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":31361,"user_name":"starnop","can_delete":false,"product_type":"c1","uid":1124858,"ip_address":"","ucode":"2064FA9AC3F99F","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIbKCwLRY5icgW3WtLn0JD7EDksicGFqLAsXTm89SjNhR0KIt3N5iaQEmeic4Ld50Yxsceicia5kBODibZPA/132","comment_is_top":false,"comment_ctime":1539160026,"is_pvip":false,"replies":[{"id":"11287","content":"ç›®å‰åªèƒ½è¿™ä¹ˆå¹²","user_name":"ä½œè€…å›å¤","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1539173655,"ip_address":"","comment_id":31361,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1539160026","product_id":100015201,"comment_content":"ç£Šå“¥ï¼Œè¯·æ•™ä¸€ä¸ªé—®é¢˜ï¼Œ ä½¿ç”¨kubeadm éƒ¨ç½²kubernetes ï¼Œå®¿ä¸»æœºipä½¿ç”¨dhcpæ–¹å¼ï¼Œæ— æ³•å›ºå®šï¼Œåœ¨é‡å¯åipæ”¹å˜ï¼Œè¿™ä¸ªé—®é¢˜ç›®å‰çœ‹åˆ°çš„ä¸€ç§è§£æ³•æ˜¯ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œé‡æ–°ç”Ÿæˆè¯ä¹¦ç­‰æ“ä½œï¼Œæ¯æ¬¡å¼€æœºåšè¿™ä¸ªæ“ä½œæœ‰äº›ç¹çï¼Œä¸çŸ¥æœ‰æ²¡æœ‰ä»€ä¹ˆåˆ«çš„è§£æ³•ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"å¼ ç£Š Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426308,"discussion_content":"ç›®å‰åªèƒ½è¿™ä¹ˆå¹²","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539173655,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}