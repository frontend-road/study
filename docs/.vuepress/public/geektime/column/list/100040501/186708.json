{"id":186708,"title":"20 | å†…å­˜æ¨¡å‹å’Œatomicï¼šç†è§£å¹¶å‘çš„å¤æ‚æ€§","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å´å’ç‚œã€‚</p><p>ä¸Šä¸€è®²æˆ‘ä»¬è®¨è®ºäº†ä¸€äº›å¹¶å‘ç¼–ç¨‹çš„åŸºæœ¬æ¦‚å¿µï¼Œä»Šå¤©æˆ‘ä»¬æ¥è®¨è®ºä¸€ä¸ªç•¥æœ‰ç‚¹ç»•çš„é—®é¢˜ï¼ŒC++ é‡Œçš„å†…å­˜æ¨¡å‹å’ŒåŸå­é‡ã€‚</p><h2>C++98 çš„æ‰§è¡Œé¡ºåºé—®é¢˜</h2><p>C++98 çš„å¹´ä»£é‡Œï¼Œå¼€å‘è€…ä»¬å·²ç»äº†è§£äº†çº¿ç¨‹çš„æ¦‚å¿µï¼Œä½† C++ çš„æ ‡å‡†é‡Œåˆ™å®Œå…¨æ²¡æœ‰æåˆ°çº¿ç¨‹ã€‚ä»å®è·µä¸Šï¼Œä¼°è®¡å¤§å®¶è§‰å¾—ä¸æçº¿ç¨‹ï¼ŒC++ ä¹Ÿä¸€æ ·èƒ½å®ç°å¤šçº¿ç¨‹çš„åº”ç”¨ç¨‹åºå§ã€‚ä¸è¿‡ï¼Œå¾ˆå¤šèªæ˜äººéƒ½å¿½ç•¥äº†ï¼Œä¸‹é¢çš„äº‹å®å¯èƒ½ä¼šäº§ç”Ÿä¸ç¬¦åˆç›´è§‰é¢„æœŸçš„ç»“æœï¼š</p><ul>\n<li>ä¸ºäº†ä¼˜åŒ–çš„å¿…è¦ï¼Œç¼–è¯‘å™¨æ˜¯å¯ä»¥è°ƒæ•´ä»£ç çš„æ‰§è¡Œé¡ºåºçš„ã€‚å”¯ä¸€çš„è¦æ±‚æ˜¯ï¼Œç¨‹åºçš„â€œå¯è§‚æµ‹â€å¤–éƒ¨è¡Œä¸ºæ˜¯ä¸€è‡´çš„ã€‚</li>\n<li>å¤„ç†å™¨ä¹Ÿä¼šå¯¹ä»£ç çš„æ‰§è¡Œé¡ºåºè¿›è¡Œè°ƒæ•´ï¼ˆæ‰€è°“çš„ CPU ä¹±åºæ‰§è¡Œï¼‰ã€‚åœ¨å•å¤„ç†å™¨çš„æƒ…å†µä¸‹ï¼Œè¿™ç§ä¹±åºæ— æ³•è¢«ç¨‹åºè§‚å¯Ÿåˆ°ï¼›ä½†åœ¨å¤šå¤„ç†å™¨çš„æƒ…å†µä¸‹ï¼Œåœ¨å¦å¤–ä¸€ä¸ªå¤„ç†å™¨ä¸Šè¿è¡Œçš„å¦ä¸€ä¸ªçº¿ç¨‹å°±å¯èƒ½ä¼šå¯Ÿè§‰åˆ°è¿™ç§ä¸åŒé¡ºåºçš„åæœäº†ã€‚</li>\n</ul><p>å¯¹äºä¸Šé¢çš„åä¸€ç‚¹ï¼Œå¤§éƒ¨åˆ†å¼€å‘è€…å¹¶æ²¡æœ‰æ„è¯†åˆ°ã€‚åŸå› æœ‰å¥½å‡ ä¸ªæ–¹é¢ï¼š</p><ul>\n<li>å¤šå¤„ç†å™¨çš„ç³»ç»Ÿåœ¨é‚£æ—¶è¿˜ä¸å¸¸è§</li>\n<li>ä¸»æµçš„ x86 ä½“ç³»æ¶æ„ä»ä¿æŒç€è¾ƒä¸¥æ ¼çš„å†…å­˜è®¿é—®é¡ºåº</li>\n<li>åªæœ‰åœ¨æ•°æ®ç«äº‰ï¼ˆdata raceï¼‰æ¿€çƒˆçš„æƒ…å†µä¸‹æ‰èƒ½çœ‹åˆ°â€œæ„å¤–â€çš„åæœ</li>\n</ul><p>ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ªå…¨å±€å˜é‡ï¼š</p><pre><code class=\"language-c++\">int x = 0;\nint y = 0;\n</code></pre><p>ç„¶åæˆ‘ä»¬åœ¨ä¸€ä¸ªçº¿ç¨‹é‡Œæ‰§è¡Œï¼š</p><pre><code class=\"language-c++\">x = 1;\ny = 2;\n</code></pre><p>åœ¨å¦ä¸€ä¸ªçº¿ç¨‹é‡Œæ‰§è¡Œï¼š</p><pre><code class=\"language-c++\">if (y == 2) {\n  x = 3;\n  y = 4;\n}\n</code></pre><!-- [[[read_end]]] --><p>æƒ³ä¸€ä¸‹ï¼Œä½ è®¤ä¸ºä¸Šé¢çš„ä»£ç è¿è¡Œå®Œä¹‹åï¼Œ<code>x</code>ã€<code>y</code> çš„æ•°å€¼æœ‰å‡ ç§å¯èƒ½ï¼Ÿ</p><p>ä½ å¦‚æœè®¤ä¸ºæœ‰ä¸¤ç§å¯èƒ½ï¼Œ1ã€2 å’Œ 3ã€4 çš„è¯ï¼Œé‚£è¯´æ˜ä½ æ˜¯æŒ‰å…¸å‹ç¨‹åºå‘˜çš„æ€ç»´æ¨¡å¼çœ‹é—®é¢˜çš„â€”â€”æ²¡æœ‰åƒç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¸€æ ·å¤„ç†é—®é¢˜ã€‚äº‹å®ä¸Šï¼Œ1ã€4 ä¹Ÿæ˜¯ä¸€ç§ç»“æœçš„å¯èƒ½ã€‚æœ‰ä¸¤ä¸ªåŸºæœ¬çš„åŸå› å¯ä»¥é€ æˆè¿™ä¸€åæœï¼š</p><ul>\n<li>ç¼–è¯‘å™¨æ²¡æœ‰ä¹‰åŠ¡ä¸€å®šæŒ‰ä»£ç é‡Œç»™å‡ºçš„é¡ºåºäº§ç”Ÿä»£ç ã€‚äº‹å®ä¸Šï¼Œè·Ÿæ®ä¸Šä¸‹æ–‡è°ƒæ•´ä»£ç çš„æ‰§è¡Œé¡ºåºï¼Œä½¿å…¶æœ€æœ‰åˆ©äºå¤„ç†å™¨çš„æ¶æ„ï¼Œæ˜¯ä¼˜åŒ–ä¸­å¾ˆé‡è¦çš„ä¸€æ­¥ã€‚å°±å•ä¸ªçº¿ç¨‹è€Œè¨€ï¼Œå…ˆæ‰§è¡Œ <code>x = 1</code> è¿˜æ˜¯å…ˆæ‰§è¡Œ <code>y = 2</code> å®Œå…¨æ˜¯ä»¶æ— å…³ç´§è¦çš„äº‹ï¼šå®ƒä»¬æ²¡æœ‰å¤–éƒ¨â€œå¯è§‚å¯Ÿâ€çš„åŒºåˆ«ã€‚</li>\n<li>åœ¨å¤šå¤„ç†å™¨æ¶æ„ä¸­ï¼Œå„ä¸ªå¤„ç†å™¨å¯èƒ½å­˜åœ¨ç¼“å­˜ä¸ä¸€è‡´æ€§é—®é¢˜ã€‚å–å†³äºå…·ä½“çš„å¤„ç†å™¨ç±»å‹ã€ç¼“å­˜ç­–ç•¥å’Œå˜é‡åœ°å€ï¼Œå¯¹å˜é‡ <code>y</code> çš„å†™å…¥æœ‰å¯èƒ½å…ˆåæ˜ åˆ°ä¸»å†…å­˜ä¸­å»ã€‚ä¹‹æ‰€ä»¥è¿™ä¸ªé—®é¢˜ä¼¼ä¹å¹¶ä¸å¸¸è§ï¼Œæ˜¯å› ä¸ºå¸¸è§çš„ x86 å’Œ x86-64 å¤„ç†å™¨æ˜¯åœ¨é¡ºåºæ‰§è¡Œæ–¹é¢åšå¾—æœ€ä¿å®ˆçš„â€”â€”å¤§éƒ¨åˆ†å…¶ä»–å¤„ç†å™¨ï¼Œå¦‚ ARMã€DEC Alphaã€PA-RISCã€IBM Powerã€IBM zæ¶æ„å’Œ Intel Itanium åœ¨å†…å­˜åºé—®é¢˜ä¸Šéƒ½æ¯”è¾ƒâ€œæ¾æ•£â€ã€‚x86 ä½¿ç”¨çš„å†…å­˜æ¨¡å‹åŸºæœ¬æä¾›äº†é¡ºåºä¸€è‡´æ€§ï¼ˆsequential consistencyï¼‰ï¼›ç›¸å¯¹çš„ï¼ŒARM ä½¿ç”¨çš„å†…å­˜æ¨¡å‹å°±åªæ˜¯æ¾æ•£ä¸€è‡´æ€§ï¼ˆrelaxed consistencyï¼‰ã€‚è¾ƒä¸ºä¸¥æ ¼çš„æè¿°ï¼Œè¯·æŸ¥çœ‹å‚è€ƒèµ„æ–™ <span class=\"orange\">[1]</span> å’Œé‡Œé¢æä¾›çš„è¿›ä¸€æ­¥èµ„æ–™ã€‚</li>\n</ul><p>è™½è¯´ Intel æ¶æ„å¤„ç†å™¨çš„é¡ºåºä¸€è‡´æ€§æ¯”è¾ƒå¥½ï¼Œä½†åœ¨å¤šå¤„ç†å™¨ï¼ˆåŒ…æ‹¬å¤šæ ¸ï¼‰çš„æƒ…å†µä¸‹ä»ç„¶èƒ½å¤Ÿå‡ºç°å†™è¯»åºåˆ—å˜æˆè¯»å†™åºåˆ—çš„æƒ…å†µï¼Œäº§ç”Ÿæ„æ–™ä¹‹å¤–çš„åæœã€‚å‚è€ƒèµ„æ–™ <span class=\"orange\">[2]</span> ä¸­æä¾›äº†å®Œæ•´çš„ä¾‹å­ï¼ŒåŒ…æ‹¬ç¤ºä¾‹ä»£ç ã€‚å¯¹äºç¼“å­˜ä¸ä¸€è‡´æ€§é—®é¢˜çš„ä¸€èˆ¬ä¸­æ–‡ä»‹ç»ï¼Œå¯ä»¥æŸ¥çœ‹å‚è€ƒèµ„æ–™ <span class=\"orange\">[3]</span>ã€‚</p><h3>åŒé‡æ£€æŸ¥é”å®š</h3><p>åœ¨å¤šçº¿ç¨‹å¯èƒ½å¯¹åŒä¸€ä¸ªå•ä»¶è¿›è¡Œåˆå§‹åŒ–çš„æƒ…å†µä¸‹ï¼Œæœ‰ä¸€ä¸ªåŒé‡æ£€æŸ¥é”å®šçš„æŠ€å·§ï¼Œå¯åŸºæœ¬ç¤ºæ„å¦‚ä¸‹ï¼š</p><pre><code class=\"language-c++\">// å¤´æ–‡ä»¶\nclass singleton {\npublic:\n  static singleton* instance();\n  â€¦\nprivate:\n  static singleton* inst_ptr_;\n};\n\n// å®ç°æ–‡ä»¶\nsingleton* singleton::inst_ptr_ =\n  nullptr;\n\nsingleton* singleton::instance()\n{\n  if (inst_ptr_ == nullptr) {\n    lock_guard lock;  // åŠ é”\n    if (inst_ptr_ == nullptr) {\n      inst_ptr_ = new singleton();\n    }\n  }\n  return inst_ptr_;\n}\n</code></pre><p>è¿™ä¸ªä»£ç çš„ç›®çš„æ˜¯æ¶ˆé™¤å¤§éƒ¨åˆ†æ‰§è¡Œè·¯å¾„ä¸Šçš„åŠ é”å¼€é”€ã€‚åŸæœ¬çš„æ„å›¾æ˜¯ï¼šå¦‚æœ <code>inst_ptr_</code> æ²¡æœ‰è¢«åˆå§‹åŒ–ï¼Œæ‰§è¡Œæ‰ä¼šè¿›å…¥åŠ é”çš„è·¯å¾„ï¼Œé˜²æ­¢å•ä»¶è¢«æ„é€ å¤šæ¬¡ï¼›å¦‚æœ <code>inst_ptr_</code> å·²ç»è¢«åˆå§‹åŒ–ï¼Œé‚£å®ƒå°±ä¼šè¢«ç›´æ¥è¿”å›ï¼Œä¸ä¼šäº§ç”Ÿé¢å¤–çš„å¼€é”€ã€‚è™½ç„¶çœ‹ä¸Šå»å¾ˆç¾ï¼Œä½†å®ƒä¸€æ ·æœ‰ç€ä¸Šé¢æåˆ°çš„é—®é¢˜ã€‚Scott Meyers å’Œ Andrei Alexandrecu è¯¦å°½åœ°åˆ†æäº†è¿™ä¸ªç”¨æ³• <span class=\"orange\">[4]</span>ï¼Œç„¶åå¾—å‡ºç»“è®ºï¼šå³ä½¿èŠ±ä¸Šå†å¤§çš„åŠ›æ°”ï¼Œè¿™ä¸ªç”¨æ³•ä»ç„¶æœ‰ç€éå¸¸å¤šçš„éš¾ä»¥å¡«è¡¥çš„æ¼æ´ã€‚æœ¬è´¨ä¸Šè¿˜æ˜¯ä¸Šé¢è¯´çš„ï¼Œä¼˜åŒ–ç¼–è¯‘å™¨ä¼šåŠªåŠ›å‡»è´¥ä½ è¯•å›¾æƒ³é˜²æ­¢ä¼˜åŒ–çš„åŠªåŠ›ï¼Œè€Œå¤šå¤„ç†å™¨ä¼šä»¥ä»¤äººæ„å¤–çš„æ–¹å¼è®©ä»£ç èµ°åˆ°é”™è¯¯çš„æ‰§è¡Œè·¯å¾„ä¸Šå»ã€‚ä»–ä»¬åˆ†æå¾—éå¸¸è¯¦ç»†ï¼Œå»ºè®®ä½ å¯ä»¥èŠ±æ—¶é—´å­¦ä¹ ä¸€ä¸‹ã€‚</p><h3>volatile</h3><p>åœ¨æŸäº›ç¼–è¯‘å™¨é‡Œï¼Œä½¿ç”¨ <code>volatile</code> å…³é”®å­—å¯ä»¥è¾¾åˆ°å†…å­˜åŒæ­¥çš„æ•ˆæœã€‚ä½†æˆ‘ä»¬å¿…é¡»è®°ä½ï¼Œè¿™ä¸æ˜¯ <code>volatile</code> çš„è®¾è®¡æ„å›¾ï¼Œä¹Ÿä¸èƒ½é€šç”¨åœ°è¾¾åˆ°å†…å­˜åŒæ­¥çš„æ•ˆæœã€‚<code>volatile</code> çš„è¯­ä¹‰åªæ˜¯é˜²æ­¢ç¼–è¯‘å™¨â€œä¼˜åŒ–â€æ‰å¯¹å†…å­˜çš„è¯»å†™è€Œå·²ã€‚å®ƒçš„åˆé€‚ç”¨æ³•ï¼Œç›®å‰ä¸»è¦æ˜¯ç”¨æ¥è¯»å†™æ˜ å°„åˆ°å†…å­˜åœ°å€ä¸Šçš„ I/O æ“ä½œã€‚</p><p>ç”±äº <code>volatile</code> ä¸èƒ½åœ¨å¤šå¤„ç†å™¨çš„ç¯å¢ƒä¸‹ç¡®ä¿å¤šä¸ªçº¿ç¨‹èƒ½çœ‹åˆ°åŒæ ·é¡ºåºçš„æ•°æ®å˜åŒ–ï¼Œåœ¨ä»Šå¤©çš„é€šç”¨åº”ç”¨ç¨‹åºä¸­ï¼Œä¸åº”è¯¥å†çœ‹åˆ° <code>volatile</code> çš„å‡ºç°ã€‚</p><h2>C++11 çš„å†…å­˜æ¨¡å‹</h2><p>ä¸ºäº†ä»æ ¹æœ¬ä¸Šæ¶ˆé™¤è¿™äº›æ¼æ´ï¼ŒC++11 é‡Œå¼•å…¥äº†é€‚åˆå¤šçº¿ç¨‹çš„å†…å­˜æ¨¡å‹ã€‚æˆ‘ä»¬å¯ä»¥åœ¨å‚è€ƒèµ„æ–™ <span class=\"orange\">[5]</span> é‡Œäº†è§£æ›´å¤šçš„ç»†èŠ‚ã€‚è·Ÿæˆ‘ä»¬å¼€å‘å¯†åˆ‡ç›¸å…³çš„æ˜¯ï¼šç°åœ¨æˆ‘ä»¬æœ‰äº†åŸå­å¯¹è±¡ï¼ˆatomicï¼‰å’Œä½¿ç”¨åŸå­å¯¹è±¡çš„è·å¾—ï¼ˆacquireï¼‰ã€é‡Šæ”¾ï¼ˆreleaseï¼‰è¯­ä¹‰ï¼Œå¯ä»¥çœŸæ­£ç²¾ç¡®åœ°æ§åˆ¶å†…å­˜è®¿é—®çš„é¡ºåºæ€§ï¼Œä¿è¯æˆ‘ä»¬éœ€è¦çš„å†…å­˜åºã€‚</p><h3>å†…å­˜å±éšœå’Œè·å¾—ã€é‡Šæ”¾è¯­ä¹‰</h3><p>æ‹¿åˆšæ‰çš„é‚£ä¸ªä¾‹å­æ¥è¯´ï¼Œå¦‚æœæˆ‘ä»¬å¸Œæœ›ç»“æœåªèƒ½æ˜¯ 1ã€2 æˆ– 3ã€4ï¼Œå³æ»¡è¶³ç¨‹åºå‘˜å¿ƒä¸­çš„å®Œå…¨å­˜å‚¨åºï¼ˆtotal store orderingï¼‰ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ <code>x = 1</code> å’Œ <code>y = 2</code> ä¸¤å¥è¯­å¥ä¹‹é—´åŠ å…¥å†…å­˜å±éšœï¼Œç¦æ­¢è¿™ä¸¤å¥è¯­å¥äº¤æ¢é¡ºåºã€‚æˆ‘ä»¬åœ¨æ­¤ç§æƒ…å†µä¸‹æœ€å¸¸ç”¨çš„ä¸¤ä¸ªæ¦‚å¿µæ˜¯â€œè·å¾—â€å’Œâ€œé‡Šæ”¾â€ï¼š</p><ul>\n<li><strong>è·å¾—</strong>æ˜¯ä¸€ä¸ªå¯¹å†…å­˜çš„<strong>è¯»</strong>æ“ä½œï¼Œå½“å‰çº¿ç¨‹çš„ä»»ä½•åé¢çš„è¯»å†™æ“ä½œéƒ½ä¸å…è®¸é‡æ’åˆ°è¿™ä¸ªæ“ä½œçš„<strong>å‰é¢</strong>å»ã€‚</li>\n<li><strong>é‡Šæ”¾</strong>æ˜¯ä¸€ä¸ªå¯¹å†…å­˜çš„<strong>å†™</strong>æ“ä½œï¼Œå½“å‰çº¿ç¨‹çš„ä»»ä½•å‰é¢çš„è¯»å†™æ“ä½œéƒ½ä¸å…è®¸é‡æ’åˆ°è¿™ä¸ªæ“ä½œçš„<strong>åé¢</strong>å»ã€‚</li>\n</ul><p>å…·ä½“åˆ°æˆ‘ä»¬ä¸Šé¢çš„ç¬¬ä¸€ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬éœ€è¦æŠŠ <code>y</code> å£°æ˜æˆ <code>atomic&lt;int&gt;</code>ã€‚ç„¶åï¼Œæˆ‘ä»¬åœ¨çº¿ç¨‹ 1 éœ€è¦ä½¿ç”¨é‡Šæ”¾è¯­ä¹‰ï¼š</p><pre><code class=\"language-c++\">x = 1;\ny.store(2, memory_order_release);\n</code></pre><p>åœ¨çº¿ç¨‹ 2 æˆ‘ä»¬å¯¹ <code>y</code> çš„è¯»å–åº”å½“ä½¿ç”¨è·å¾—è¯­ä¹‰ï¼Œä½†å­˜å‚¨åªéœ€è¦æ¾æ•£å†…å­˜åºå³å¯ï¼š</p><pre><code class=\"language-c++\">if (y.load(memory_order_acquire) ==\n    2) {\n  x = 3;\n  y.store(4, memory_order_relaxed);\n}\n</code></pre><p>æˆ‘ä»¬å¯ä»¥ç”¨ä¸‹å›¾ç¤ºæ„ä¸€ä¸‹ï¼Œæ¯ä¸€è¾¹çš„ä»£ç éƒ½ä¸å…è®¸é‡æ’è¶Šè¿‡é»„è‰²åŒºåŸŸï¼Œä¸”å¦‚æœ <code>y</code> ä¸Šçš„é‡Šæ”¾æ—©äº <code>y</code> ä¸Šçš„è·å–çš„è¯ï¼Œé‡Šæ”¾å‰å¯¹å†…å­˜çš„ä¿®æ”¹éƒ½åœ¨å¦ä¸€ä¸ªçº¿ç¨‹çš„è·å–æ“ä½œåå¯è§ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/33/14/33484c6762bb98d91ce8d30a752e2614.png?wh=4758*1458\" alt=\"\"></p><p>äº‹å®ä¸Šï¼Œåœ¨æˆ‘ä»¬æŠŠ <code>y</code> æ”¹æˆ <code>atomic&lt;int&gt;</code> ä¹‹åï¼Œä¸¤ä¸ªçº¿ç¨‹çš„ä»£ç ä¸€è¡Œä¸æ”¹ï¼Œæ‰§è¡Œç»“æœéƒ½ä¼šæ˜¯ç¬¦åˆæˆ‘ä»¬çš„æœŸæœ›çš„ã€‚å› ä¸º <code>atomic</code> å˜é‡çš„å†™æ“ä½œç¼ºçœå°±æ˜¯é‡Šæ”¾è¯­ä¹‰ï¼Œè¯»æ“ä½œç¼ºçœå°±æ˜¯è·å¾—è¯­ä¹‰ï¼ˆä¸ä¸¥æ ¼çš„è¯´æ³•ï¼Œç²¾ç¡®è¡¨è¿°è§ä¸‹é¢çš„å†…å­˜åºéƒ¨åˆ†ï¼‰ã€‚å³</p><ul>\n<li><code>y = 2</code> ç›¸å½“äº <code>y.store(2, memory_order_release)</code></li>\n<li><code>y == 2</code> ç›¸å½“äº <code>y.load(memory_order_acquire) == 2</code></li>\n</ul><p>ä½†æ˜¯ï¼Œç¼ºçœè¡Œä¸ºå¯èƒ½æ˜¯å¯¹æ€§èƒ½ä¸åˆ©çš„ï¼šæˆ‘ä»¬å¹¶ä¸éœ€è¦åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½ä¿è¯æ“ä½œçš„é¡ºåºæ€§ã€‚</p><p>å¦å¤–ï¼Œæˆ‘ä»¬åº”å½“æ³¨æ„ä¸€ä¸‹ï¼Œacquire å’Œ release é€šå¸¸éƒ½æ˜¯é…å¯¹å‡ºç°çš„ï¼Œç›®çš„æ˜¯ä¿è¯å¦‚æœå¯¹åŒä¸€ä¸ªåŸå­å¯¹è±¡çš„ release å‘ç”Ÿåœ¨ acquire ä¹‹å‰çš„è¯ï¼Œrelease ä¹‹å‰å‘ç”Ÿçš„å†…å­˜ä¿®æ”¹èƒ½å¤Ÿè¢« acquire ä¹‹åçš„å†…å­˜è¯»å–å…¨éƒ¨çœ‹åˆ°ã€‚</p><h3>atomic</h3><p>åˆšæ‰æ˜¯å¯¹ atomic ç”¨æ³•çš„ä¸€ä¸ªéæ­£å¼ä»‹ç»ã€‚ä¸‹é¢æˆ‘ä»¬å¯¹ atomic åšä¸€ä¸ªç¨å®Œæ•´äº›çš„è¯´æ˜ï¼ˆæ›´å®Œæ•´çš„è§ <span class=\"orange\">[6]</span>ï¼‰ã€‚</p><p>C++11 åœ¨ &lt;atomic&gt; å¤´æ–‡ä»¶ä¸­å¼•å…¥äº† <code>atomic</code> æ¨¡æ¿ï¼Œå¯¹åŸå­å¯¹è±¡è¿›è¡Œäº†å°è£…ã€‚æˆ‘ä»¬å¯ä»¥å°†å…¶åº”ç”¨åˆ°ä»»ä½•ç±»å‹ä¸Šå»ã€‚å½“ç„¶å¯¹äºä¸åŒçš„ç±»å‹æ•ˆæœè¿˜æ˜¯æœ‰æ‰€ä¸åŒçš„ï¼šå¯¹äºæ•´å‹é‡å’ŒæŒ‡é’ˆç­‰ç®€å•ç±»å‹ï¼Œé€šå¸¸ç»“æœæ˜¯æ— é”çš„åŸå­å¯¹è±¡ï¼›è€Œå¯¹äºå¦å¤–ä¸€äº›ç±»å‹ï¼Œæ¯”å¦‚ 64 ä½æœºå™¨ä¸Šå¤§å°ä¸æ˜¯ 1ã€2ã€4ã€8ï¼ˆæœ‰äº›å¹³å°/ç¼–è¯‘å™¨ä¹Ÿæ”¯æŒå¯¹æ›´å¤§çš„æ•°æ®è¿›è¡Œæ— é”åŸå­æ“ä½œï¼‰çš„ç±»å‹ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨ä¸ºè¿™äº›åŸå­å¯¹è±¡çš„æ“ä½œåŠ ä¸Šé”ã€‚ç¼–è¯‘å™¨æä¾›äº†ä¸€ä¸ªåŸå­å¯¹è±¡çš„æˆå‘˜å‡½æ•° <code>is_lock_free</code>ï¼Œå¯ä»¥æ£€æŸ¥è¿™ä¸ªåŸå­å¯¹è±¡ä¸Šçš„æ“ä½œæ˜¯å¦æ˜¯æ— é”çš„ã€‚</p><p>åŸå­æ“ä½œæœ‰ä¸‰ç±»ï¼š</p><ul>\n<li>è¯»ï¼šåœ¨è¯»å–çš„è¿‡ç¨‹ä¸­ï¼Œè¯»å–ä½ç½®çš„å†…å®¹ä¸ä¼šå‘ç”Ÿä»»ä½•å˜åŠ¨ã€‚</li>\n<li>å†™ï¼šåœ¨å†™å…¥çš„è¿‡ç¨‹ä¸­ï¼Œå…¶ä»–æ‰§è¡Œçº¿ç¨‹ä¸ä¼šçœ‹åˆ°éƒ¨åˆ†å†™å…¥çš„ç»“æœã€‚</li>\n<li>è¯»â€ä¿®æ”¹â€å†™ï¼šè¯»å–å†…å­˜ã€ä¿®æ”¹æ•°å€¼ã€ç„¶åå†™å›å†…å­˜ï¼Œæ•´ä¸ªæ“ä½œçš„è¿‡ç¨‹ä¸­é—´ä¸ä¼šæœ‰å…¶ä»–å†™å…¥æ“ä½œæ’å…¥ï¼Œå…¶ä»–æ‰§è¡Œçº¿ç¨‹ä¸ä¼šçœ‹åˆ°éƒ¨åˆ†å†™å…¥çš„ç»“æœã€‚</li>\n</ul><p>&lt;atomic&gt; å¤´æ–‡ä»¶ä¸­è¿˜å®šä¹‰äº†å†…å­˜åºï¼Œåˆ†åˆ«æ˜¯ï¼š</p><ul>\n<li><code>memory_order_relaxed</code>ï¼šæ¾æ•£å†…å­˜åºï¼Œåªç”¨æ¥ä¿è¯å¯¹åŸå­å¯¹è±¡çš„æ“ä½œæ˜¯åŸå­çš„</li>\n<li><code>memory_order_consume</code>ï¼šç›®å‰ä¸é¼“åŠ±ä½¿ç”¨ï¼Œæˆ‘å°±ä¸è¯´æ˜äº†</li>\n<li><code>memory_order_acquire</code>ï¼šè·å¾—æ“ä½œï¼Œåœ¨è¯»å–æŸåŸå­å¯¹è±¡æ—¶ï¼Œå½“å‰çº¿ç¨‹çš„ä»»ä½•åé¢çš„è¯»å†™æ“ä½œéƒ½ä¸å…è®¸é‡æ’åˆ°è¿™ä¸ªæ“ä½œçš„å‰é¢å»ï¼Œå¹¶ä¸”å…¶ä»–çº¿ç¨‹åœ¨å¯¹åŒä¸€ä¸ªåŸå­å¯¹è±¡é‡Šæ”¾ä¹‹å‰çš„æ‰€æœ‰å†…å­˜å†™å…¥éƒ½åœ¨å½“å‰çº¿ç¨‹å¯è§</li>\n<li><code>memory_order_release</code>ï¼šé‡Šæ”¾æ“ä½œï¼Œåœ¨å†™å…¥æŸåŸå­å¯¹è±¡æ—¶ï¼Œå½“å‰çº¿ç¨‹çš„ä»»ä½•å‰é¢çš„è¯»å†™æ“ä½œéƒ½ä¸å…è®¸é‡æ’åˆ°è¿™ä¸ªæ“ä½œçš„åé¢å»ï¼Œå¹¶ä¸”å½“å‰çº¿ç¨‹çš„æ‰€æœ‰å†…å­˜å†™å…¥éƒ½åœ¨å¯¹åŒä¸€ä¸ªåŸå­å¯¹è±¡è¿›è¡Œè·å–çš„å…¶ä»–çº¿ç¨‹å¯è§</li>\n<li><code>memory_order_acq_rel</code>ï¼šè·å¾—é‡Šæ”¾æ“ä½œï¼Œä¸€ä¸ªè¯»â€ä¿®æ”¹â€å†™æ“ä½œåŒæ—¶å…·æœ‰è·å¾—è¯­ä¹‰å’Œé‡Šæ”¾è¯­ä¹‰ï¼Œå³å®ƒå‰åçš„ä»»ä½•è¯»å†™æ“ä½œéƒ½ä¸å…è®¸é‡æ’ï¼Œå¹¶ä¸”å…¶ä»–çº¿ç¨‹åœ¨å¯¹åŒä¸€ä¸ªåŸå­å¯¹è±¡é‡Šæ”¾ä¹‹å‰çš„æ‰€æœ‰å†…å­˜å†™å…¥éƒ½åœ¨å½“å‰çº¿ç¨‹å¯è§ï¼Œå½“å‰çº¿ç¨‹çš„æ‰€æœ‰å†…å­˜å†™å…¥éƒ½åœ¨å¯¹åŒä¸€ä¸ªåŸå­å¯¹è±¡è¿›è¡Œè·å–çš„å…¶ä»–çº¿ç¨‹å¯è§</li>\n<li><code>memory_order_seq_cst</code>ï¼šé¡ºåºä¸€è‡´æ€§è¯­ä¹‰ï¼Œå¯¹äºè¯»æ“ä½œç›¸å½“äºè·å–ï¼Œå¯¹äºå†™æ“ä½œç›¸å½“äºé‡Šæ”¾ï¼Œå¯¹äºè¯»â€ä¿®æ”¹â€å†™æ“ä½œç›¸å½“äºè·å¾—é‡Šæ”¾ï¼Œ<strong>æ˜¯æ‰€æœ‰åŸå­æ“ä½œçš„é»˜è®¤å†…å­˜åº</strong>ï¼ˆé™¤æ­¤ä¹‹å¤–ï¼Œé¡ºåºä¸€è‡´æ€§è¿˜ä¿è¯äº†å¤šä¸ªåŸå­é‡çš„ä¿®æ”¹åœ¨æ‰€æœ‰çº¿ç¨‹é‡Œè§‚å¯Ÿåˆ°çš„ä¿®æ”¹é¡ºåºéƒ½ç›¸åŒï¼›æˆ‘ä»¬ç›®å‰çš„è®¨è®ºæš‚ä¸æ¶‰åŠå¤šä¸ªåŸå­é‡çš„ä¿®æ”¹ï¼‰</li>\n</ul><p><code>atomic</code> æœ‰ä¸‹é¢è¿™äº›å¸¸ç”¨çš„æˆå‘˜å‡½æ•°ï¼š</p><ul>\n<li>é»˜è®¤æ„é€ å‡½æ•°ï¼ˆåªæ”¯æŒé›¶åˆå§‹åŒ–ï¼‰</li>\n<li>æ‹·è´æ„é€ å‡½æ•°è¢«åˆ é™¤</li>\n<li>ä½¿ç”¨å†…ç½®å¯¹è±¡ç±»å‹çš„æ„é€ å‡½æ•°ï¼ˆä¸æ˜¯åŸå­æ“ä½œï¼‰</li>\n<li>å¯ä»¥ä»å†…ç½®å¯¹è±¡ç±»å‹èµ‹å€¼åˆ°åŸå­å¯¹è±¡ï¼ˆç›¸å½“äº <code>store</code>ï¼‰</li>\n<li>å¯ä»¥ä»åŸå­å¯¹è±¡éšå¼è½¬æ¢æˆå†…ç½®å¯¹è±¡ï¼ˆç›¸å½“äº <code>load</code>ï¼‰</li>\n<li><code>store</code>ï¼Œå†™å…¥å¯¹è±¡åˆ°åŸå­å¯¹è±¡é‡Œï¼Œç¬¬äºŒä¸ªå¯é€‰å‚æ•°æ˜¯å†…å­˜åºç±»å‹</li>\n<li><code>load</code>ï¼Œä»åŸå­å¯¹è±¡è¯»å–å†…ç½®å¯¹è±¡ï¼Œæœ‰ä¸ªå¯é€‰å‚æ•°æ˜¯å†…å­˜åºç±»å‹</li>\n<li><code>is_lock_free</code>ï¼Œåˆ¤æ–­å¯¹åŸå­å¯¹è±¡çš„æ“ä½œæ˜¯å¦æ— é”ï¼ˆæ˜¯å¦å¯ä»¥ç”¨å¤„ç†å™¨çš„æŒ‡ä»¤ç›´æ¥å®ŒæˆåŸå­æ“ä½œï¼‰</li>\n<li><code>exchange</code>ï¼Œäº¤æ¢æ“ä½œï¼Œç¬¬äºŒä¸ªå¯é€‰å‚æ•°æ˜¯å†…å­˜åºç±»å‹ï¼ˆè¿™æ˜¯è¯»â€ä¿®æ”¹â€å†™æ“ä½œï¼‰</li>\n<li><code>compare_exchange_weak</code> å’Œ <code>compare_exchange_strong</code>ï¼Œä¸¤ä¸ªæ¯”è¾ƒåŠ äº¤æ¢ï¼ˆCASï¼‰çš„ç‰ˆæœ¬ï¼Œä½ å¯ä»¥åˆ†åˆ«æŒ‡å®šæˆåŠŸå’Œå¤±è´¥æ—¶çš„å†…å­˜åºï¼Œä¹Ÿå¯ä»¥åªæŒ‡å®šä¸€ä¸ªï¼Œæˆ–ä½¿ç”¨é»˜è®¤çš„æœ€å®‰å…¨å†…å­˜åºï¼ˆè¿™æ˜¯è¯»â€ä¿®æ”¹â€å†™æ“ä½œï¼‰</li>\n<li><code>fetch_add</code> å’Œ <code>fetch_sub</code>ï¼Œä»…å¯¹æ•´æ•°å’ŒæŒ‡é’ˆå†…ç½®å¯¹è±¡æœ‰æ•ˆï¼Œå¯¹ç›®æ ‡åŸå­å¯¹è±¡æ‰§è¡ŒåŠ æˆ–å‡æ“ä½œï¼Œè¿”å›å…¶åŸå§‹å€¼ï¼Œç¬¬äºŒä¸ªå¯é€‰å‚æ•°æ˜¯å†…å­˜åºç±»å‹ï¼ˆè¿™æ˜¯è¯»â€ä¿®æ”¹â€å†™æ“ä½œï¼‰</li>\n<li><code>++</code> å’Œ <code>--</code>ï¼ˆå‰ç½®å’Œåç½®ï¼‰ï¼Œä»…å¯¹æ•´æ•°å’ŒæŒ‡é’ˆå†…ç½®å¯¹è±¡æœ‰æ•ˆï¼Œå¯¹ç›®æ ‡åŸå­å¯¹è±¡æ‰§è¡Œå¢ä¸€æˆ–å‡ä¸€ï¼Œæ“ä½œä½¿ç”¨é¡ºåºä¸€è‡´æ€§è¯­ä¹‰ï¼Œå¹¶æ³¨æ„è¿”å›çš„ä¸æ˜¯åŸå­å¯¹è±¡çš„å¼•ç”¨ï¼ˆè¿™æ˜¯è¯»â€ä¿®æ”¹â€å†™æ“ä½œï¼‰</li>\n<li><code>+=</code> å’Œ <code>-=</code>ï¼Œä»…å¯¹æ•´æ•°å’ŒæŒ‡é’ˆå†…ç½®å¯¹è±¡æœ‰æ•ˆï¼Œå¯¹ç›®æ ‡åŸå­å¯¹è±¡æ‰§è¡ŒåŠ æˆ–å‡æ“ä½œï¼Œè¿”å›æ“ä½œä¹‹åçš„æ•°å€¼ï¼Œæ“ä½œä½¿ç”¨é¡ºåºä¸€è‡´æ€§è¯­ä¹‰ï¼Œå¹¶æ³¨æ„è¿”å›çš„ä¸æ˜¯åŸå­å¯¹è±¡çš„å¼•ç”¨ï¼ˆè¿™æ˜¯è¯»â€ä¿®æ”¹â€å†™æ“ä½œï¼‰</li>\n</ul><p>æœ‰äº†åŸå­å¯¹è±¡ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥è½»è€Œæ˜“ä¸¾åœ°æŠŠ<a href=\"https://time.geekbang.org/column/article/169263\">[ç¬¬ 2 è®²]</a> ä¸­çš„ <code>shared_count</code> å˜æˆçº¿ç¨‹å®‰å…¨ã€‚æˆ‘ä»¬åªéœ€è¦åŒ…å« &lt;atomic&gt; å¤´æ–‡ä»¶ï¼Œå¹¶æŠŠä¸‹é¢è¿™è¡Œ</p><pre><code class=\"language-c++\">  long count_;\n</code></pre><p>ä¿®æ”¹æˆ</p><pre><code class=\"language-c++\">  std::atomic_long count_;\n</code></pre><p>å³å¯ï¼ˆ<code>atomic_long</code> æ˜¯ <code>atomic&lt;long&gt;</code> çš„ç±»å‹åˆ«åï¼‰ã€‚ä¸è¿‡ï¼Œç”±äºæˆ‘ä»¬å¹¶ä¸éœ€è¦ <code>++</code> ä¹‹åè®¡æ•°å€¼å½±å“å…¶ä»–è¡Œä¸ºï¼Œåœ¨ <code>add_count</code> ä¸­æ‰§è¡Œç®€å•çš„ <code>++</code>ã€ä½¿ç”¨é¡ºåºä¸€è‡´æ€§è¯­ä¹‰ç•¥æœ‰æµªè´¹ã€‚æ›´å¥½çš„åšæ³•æ˜¯å°†å…¶å®ç°æˆï¼š</p><pre><code class=\"language-c++\">  void add_count() noexcept\n  {\n    count_.fetch_add(\n      1, std::memory_order_relaxed);\n  }\n</code></pre><h4>is_lock_free çš„å¯èƒ½é—®é¢˜</h4><p>æ³¨æ„ï¼ŒmacOS ä¸Šåœ¨ä½¿ç”¨ Clang æ—¶ä¼¼ä¹ä¸æ”¯æŒå¯¹éœ€è¦åŠ é”çš„å¯¹è±¡ä½¿ç”¨ <code>is_lock_free</code> æˆå‘˜å‡½æ•°ï¼Œæ­¤æ—¶é“¾æ¥ä¼šå‡ºé”™ã€‚è€Œ GCC åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œéœ€è¦ç¡®ä¿ç³»ç»Ÿä¸Šè£…äº† libatomicã€‚ä»¥ CentOS 7 ä¸‹çš„ GCC 7 ä¸ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„è¯­å¥æ¥å®‰è£…ï¼š</p><blockquote>\n<p><code>sudo yum install devtoolset-7-libatomic-devel</code></p>\n</blockquote><p>ç„¶åï¼Œç”¨ä¸‹é¢çš„è¯­å¥ç¼–è¯‘å¯ä»¥é€šè¿‡ï¼š</p><blockquote>\n<p><code>g++ -pthread test.cpp -latomic</code></p>\n</blockquote><p>Windows ä¸‹ä½¿ç”¨ MSVC åˆ™æ²¡æœ‰é—®é¢˜ã€‚</p><h3>mutex</h3><p>ä¸Šä¸€è®²æˆ‘ä»¬å·²ç»è®¨è®ºäº†äº’æ–¥é‡ã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬åªéœ€è¦è¡¥å……ä¸¤ç‚¹ï¼š</p><ul>\n<li>äº’æ–¥é‡çš„åŠ é”æ“ä½œï¼ˆ<code>lock</code>ï¼‰å…·æœ‰è·å¾—è¯­ä¹‰</li>\n<li>äº’æ–¥é‡çš„è§£é”æ“ä½œï¼ˆ<code>unlock</code>ï¼‰å…·æœ‰é‡Šæ”¾è¯­ä¹‰</li>\n</ul><p>æœ‰äº†ç›®å‰è®²è¿‡çš„è¿™äº›çŸ¥è¯†ï¼Œæˆ‘ä»¬ç»ˆäºå¯ä»¥å®ç°ä¸€ä¸ªçœŸæ­£å®‰å…¨çš„åŒé‡æ£€æŸ¥é”å®šäº†ï¼š</p><pre><code class=\"language-c++\">// å¤´æ–‡ä»¶\nclass singleton {\npublic:\n  static singleton* instance();\n  â€¦\nprivate:\n  static mutex lock_;\n  static atomic&lt;singleton*&gt;\n    inst_ptr_;\n};\n\n// å®ç°æ–‡ä»¶\nmutex singleton::lock_;\natomic&lt;singleton*&gt;\n  singleton::inst_ptr_;\n\nsingleton* singleton::instance()\n{\n  singleton* ptr = inst_ptr_.load(\n    memory_order_acquire);\n  if (ptr == nullptr) {\n    lock_guard&lt;mutex&gt; guard{lock_};\n    ptr = inst_ptr_.load(\n      memory_order_relaxed);\n    if (ptr == nullptr) {\n      ptr = new singleton();\n      inst_ptr_.store(\n        ptr, memory_order_release);\n    }\n  }\n  return inst_ptr_;\n}\n</code></pre><h2>å¹¶å‘é˜Ÿåˆ—çš„æ¥å£</h2><p>åœ¨ç»“æŸè¿™ä¸€è®²ä¹‹å‰ï¼Œæˆ‘ä»¬æ¥æ£€æŸ¥ä¸€ä¸‹å¹¶å‘å¯¹ç¼–ç¨‹æ¥å£çš„å†²å‡»ã€‚å›æƒ³æˆ‘ä»¬ä¹‹å‰è®²åˆ°æ ‡å‡†åº“é‡Œ <code>queue</code> æœ‰ä¸‹é¢è¿™æ ·çš„æ¥å£ï¼š</p><pre><code class=\"language-c++\">template &lt;typename T&gt;\nclass queue {\npublic:\n  â€¦\n  T&amp; front();\n  const T&amp; front() const;\n  void pop();\n  â€¦\n}\n</code></pre><p>æˆ‘ä»¬ä¹‹å‰è¿˜é—®è¿‡ä¸ºä»€ä¹ˆ <code>pop</code> ä¸ç›´æ¥è¿”å›ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚å¯åˆ°äº†å¹¶å‘çš„å¹´ä»£ï¼Œæˆ‘ä»¬ä¸ç¦è¦é—®ï¼Œè¿™æ ·çš„æ¥å£è®¾è®¡åˆ°åº•æ˜æ™ºå—ï¼Ÿ</p><p><strong>ä¼šä¸ä¼šåœ¨æˆ‘ä»¬æ­£åœ¨è®¿é—® <code>front()</code> çš„æ—¶å€™ï¼Œè¿™ä¸ªå…ƒç´ å°±è¢« <code>pop</code> æ‰äº†ï¼Ÿ</strong></p><p>äº‹å®ä¸Šï¼Œä¸Šé¢è¿™æ ·çš„æ¥å£æ˜¯ä¸å¯èƒ½åšåˆ°å¹¶å‘å®‰å…¨çš„ã€‚å¹¶å‘å®‰å…¨çš„æ¥å£å¤§æ¦‚é•¿ä¸‹é¢è¿™ä¸ªæ ·å­ï¼š</p><pre><code class=\"language-c++\">template &lt;typename T&gt;\nclass queue {\npublic:\n  â€¦\n  void wait_and_pop(T&amp; dest)\n  bool try_pop(T&amp; dest);\n  â€¦\n}\n</code></pre><p>æ¢å¥è¯è¯´ï¼Œè¦å‡†å¤‡å¥½ä½ç½®å»æ¥æ”¶ï¼›ç„¶åå¦‚æœæ¥æ”¶æˆåŠŸäº†ï¼Œæ‰å®‰å®‰é™é™åœ°åœ¨è‡ªå·±çš„çº¿ç¨‹é‡Œå¤„ç†å·²ç»è¢«å¼¹å‡ºé˜Ÿåˆ—çš„å¯¹è±¡ã€‚æ¥æ”¶æ–¹å¼è¿˜å¾—åˆ†ä¸¤ç§ï¼Œé˜»å¡å¼çš„å’Œéé˜»å¡å¼çš„â€¦â€¦</p><p>é‚£æˆ‘ä¸ºä»€ä¹ˆè¦åœ¨å†…å­˜æ¨¡å‹å’ŒåŸå­é‡è¿™ä¸€è®²é‡Œè®¨è®ºè¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿå› ä¸ºå¹¶å‘é˜Ÿåˆ—çš„å®ç°ï¼Œç»å¸¸æ˜¯ç”¨åŸå­é‡æ¥è¾¾åˆ°æ— é”å’Œé«˜æ€§èƒ½çš„ã€‚å•ç”Ÿäº§è€…ã€å•æ¶ˆè´¹è€…çš„å¹¶å‘é˜Ÿåˆ—ï¼Œç”¨åŸå­é‡å’Œè·å¾—ã€é‡Šæ”¾è¯­ä¹‰å°±èƒ½ç®€å•å®ç°ã€‚å¯¹äºå¤šç”Ÿäº§è€…æˆ–å¤šæ¶ˆè´¹è€…çš„æƒ…å†µï¼Œé‚£å®ç°å°±æ¯”è¾ƒå¤æ‚äº†ï¼Œä¸€èˆ¬ä¼šä½¿ç”¨ <code>compare_exchange_strong</code> æˆ– <code>compare_exchange_weak</code>ã€‚è®¨è®ºè¿™ä¸ªè¯é¢˜çš„å¤æ‚æ€§ï¼Œå°±å¤§å¤§è¶…å‡ºäº†æœ¬ä¸“æ çš„èŒƒå›´äº†ã€‚ä½ å¦‚æœæ„Ÿå…´è¶£çš„è¯ï¼Œå¯ä»¥æŸ¥çœ‹ä¸‹é¢å‡ é¡¹å†…å®¹ï¼š</p><ul>\n<li>nvwa::fc_queue <span class=\"orange\">[7]</span> ç»™å‡ºäº†ä¸€ä¸ªå•ç”Ÿäº§è€…ã€å•æ¶ˆè´¹è€…çš„æ— é”å¹¶å‘å®šé•¿ç¯å½¢é˜Ÿåˆ—ï¼Œä»£ç é•¿åº¦æ˜¯å‡ ç™¾è¡Œçš„é‡çº§ã€‚</li>\n<li>moodycamel::ConcurrentQueue <span class=\"orange\">[8]</span> ç»™å‡ºäº†ä¸€ä¸ªå¤šç”Ÿäº§è€…ã€å¤šæ¶ˆè´¹è€…çš„æ— é”é€šç”¨å¹¶å‘é˜Ÿåˆ—ï¼Œä»£ç é•¿åº¦æ˜¯å‡ åƒè¡Œçš„é‡çº§ã€‚</li>\n<li>é™ˆçš“ç»™å‡ºäº†ä¸€ç¯‡å¾ˆæ£’çš„å¯¹æ— é”é˜Ÿåˆ—çš„ä¸­æ–‡æè¿° <span class=\"orange\">[9]</span>ï¼Œæ¨èé˜…è¯»ã€‚</li>\n</ul><h2>å†…å®¹å°ç»“</h2><p>åœ¨è¿™ä¸€è®²é‡Œï¼Œæˆ‘ä»¬è®¨è®ºäº† C++ å¯¹å¹¶å‘çš„åº•å±‚æ”¯æŒï¼Œç‰¹åˆ«æ˜¯å†…å­˜æ¨¡å‹å’ŒåŸå­é‡ã€‚è¿™äº›åº•å±‚æ¦‚å¿µï¼Œæ˜¯åœ¨ C++ é‡Œå†™å‡ºé«˜æ€§èƒ½å¹¶å‘ä»£ç çš„åŸºç¡€ã€‚</p><h2>è¯¾åæ€è€ƒ</h2><p>åœ¨ä¼ ç»Ÿ PC ä¸Šå¼€å‘çš„ç¨‹åºå‘˜ï¼Œåº”å½“æ¯”è¾ƒå°‘æ¥è§¦å…·æœ‰æ¾æ•£æˆ–å¼±å†…å­˜ä¸€è‡´æ€§çš„ç³»ç»Ÿï¼Œä½†åŸå­é‡å’Œæ™®é€šå˜é‡çš„åŒºåˆ«è¿˜æ˜¯å¾ˆå®¹æ˜“åœ¨ä»£ç ä¸­è¡¨ç°å‡ºæ¥çš„ã€‚è¯·ä½ å°è¯•ä¸€ä¸‹å¤šä¸ªçº¿ç¨‹å¯¹ä¸€ä¸ªåŸå­é‡å’Œä¸€ä¸ªæ™®é€šå…¨å±€å˜é‡åšå¤šæ¬¡å¢ä¸€æ“ä½œï¼Œè§‚å¯Ÿæœ€åçš„ç»“æœã€‚</p><p>åœ¨ Intel å¤„ç†å™¨æ¶æ„ä¸Šï¼Œå”¯ä¸€å¯è§çš„é‡æ’æ˜¯å¤šå¤„ç†å™¨ä¸‹çš„å†™è¯»æ“ä½œã€‚å¤§åŠ›æ¨èä½ å°è¯•ä¸€ä¸‹å‚è€ƒèµ„æ–™ <span class=\"orange\">[2]</span> ä¸­çš„ä¾‹å­ï¼ˆWindows å’Œ Linux ä¸‹å¯ç›´æ¥è¿è¡Œï¼›macOS ä¸‹éœ€è¦ä½¿ç”¨æˆ‘çš„<a href=\"https://gist.github.com/adah1972/8ee7484647ea9a1795089219a3704574\">ä¿®æ”¹ç‰ˆæœ¬</a>æˆ–å¤‡ç”¨<a href=\"http://wyw.dcweb.cn/download.asp?path=&file=ordering.cpp\">ä¸‹è½½é“¾æ¥</a>æ¥è¦†ç›–ä¸‹è½½ä»£ç ä¸­çš„ gcc/ordering.cppï¼‰ï¼Œå¹¶ä¿®æ”¹é¢„å®šä¹‰å®ã€‚å¦å¤–ä¸€ç§æ”¹æ³•å°±æ˜¯æŠŠä»£ç ä¸­çš„ <code>X</code>ã€<code>Y</code> çš„ç±»å‹æ”¹æˆ <code>atomic_int</code>ï¼Œé‡æ’ä¹Ÿå°±æ¶ˆå¤±äº†ã€‚</p><p>å¦‚æœé‡åˆ°ä»»ä½•ç‰¹åˆ«é—®é¢˜ï¼Œæ¬¢è¿ç•™è¨€ä¸æˆ‘äº¤æµã€‚</p><h2><span class=\"reference\">å‚è€ƒèµ„æ–™</span></h2><p><span class=\"reference\">[1] Wikipedia, â€œMemory orderingâ€. <a href=\"https://en.wikipedia.org/wiki/Memory_ordering\">https://en.wikipedia.org/wiki/Memory_ordering</a> </span></p><p><span class=\"reference\">[1a] ç»´åŸºç™¾ç§‘, â€œå†…å­˜æ’åºâ€. <a href=\"https://zh.wikipedia.org/zh-cn/%E5%86%85%E5%AD%98%E6%8E%92%E5%BA%8F\">https://zh.wikipedia.org/zh-cn/å†…å­˜æ’åº</a> </span></p><p><span class=\"reference\">[2]  Jeff Preshing, â€œMemory reordering caught in the actâ€. <a href=\"https://preshing.com/20120515/memory-reordering-caught-in-the-act/\">https://preshing.com/20120515/memory-reordering-caught-in-the-act/</a> </span></p><p><span class=\"reference\">[3] ç‹æ¬¢æ˜, ã€Šå¤šå¤„ç†å™¨ç¼–ç¨‹ï¼šä»ç¼“å­˜ä¸€è‡´æ€§åˆ°å†…å­˜æ¨¡å‹ã€‹. <a href=\"https://zhuanlan.zhihu.com/p/35386457\">https://zhuanlan.zhihu.com/p/35386457</a> </span></p><p><span class=\"reference\">[4] Scott Meyers and Andrei Alexandrescu, â€œC++ and the perils of double-checked lockingâ€. <a href=\"https://www.aristeia.com/Papers/DDJ_Jul_Aug_2004_revised.pdf\">https://www.aristeia.com/Papers/DDJ_Jul_Aug_2004_revised.pdf</a> </span></p><p><span class=\"reference\">[5] cppreference.com, â€œMemory modelâ€. <a href=\"https://en.cppreference.com/w/cpp/language/memory_model\">https://en.cppreference.com/w/cpp/language/memory_model</a> </span></p><p><span class=\"reference\">[5a] cppreference.com, â€œå†…å­˜æ¨¡å‹â€. <a href=\"https://zh.cppreference.com/w/cpp/language/memory_model\">https://zh.cppreference.com/w/cpp/language/memory_model</a> </span></p><p><span class=\"reference\">[6] cppreference.com, â€œstd::atomicâ€. <a href=\"https://en.cppreference.com/w/cpp/atomic/atomic\">https://en.cppreference.com/w/cpp/atomic/atomic</a> </span></p><p><span class=\"reference\">[6a] cppreference.com, â€œstd::atomicâ€. <a href=\"https://zh.cppreference.com/w/cpp/atomic/atomic\">https://zh.cppreference.com/w/cpp/atomic/atomic</a> </span></p><p><span class=\"reference\">[7] å´å’ç‚œ, nvwa. <a href=\"https://github.com/adah1972/nvwa\">https://github.com/adah1972/nvwa</a> </span></p><p><span class=\"reference\">[8] Cameron Desrochers, moodycamel::ConcurrentQueue. <a href=\"https://github.com/cameron314/concurrentqueue\">https://github.com/cameron314/concurrentqueue</a> </span></p><p><span class=\"reference\">[9] é™ˆçš“, ã€Šæ— é”é˜Ÿåˆ—çš„å®ç°ã€‹. <a href=\"https://coolshell.cn/articles/8239.html\">https://coolshell.cn/articles/8239.html</a> </span></p>","neighbors":{"left":{"article_title":"19 | threadå’Œfutureï¼šé¢†ç•¥å¼‚æ­¥ä¸­çš„æœªæ¥","id":186689},"right":{"article_title":"21 | å·¥å…·æ¼«è°ˆï¼šç¼–è¯‘ã€æ ¼å¼åŒ–ã€ä»£ç æ£€æŸ¥ã€æ’é”™å„æ˜¾èº«æ‰‹","id":187980}},"comments":[{"had_liked":false,"id":170701,"user_name":"tt","can_delete":false,"product_type":"c1","uid":1489957,"ip_address":"","ucode":"7753B79AD5A9AC","user_header":"https://static001.geekbang.org/account/avatar/00/16/bc/25/1c92a90c.jpg","comment_is_top":false,"comment_ctime":1578668825,"is_pvip":false,"replies":[{"id":"66197","content":"æ€è€ƒå¾—æŒºæ·±å…¥ï¼Œå¾ˆå¥½ã€‚ğŸ‘<br><br>æ“ä½œç³»ç»Ÿçš„ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œå†…å­˜åºçš„å…³ç³»æˆ‘ç•¥æœ‰ä¸åŒæ„è§ã€‚å†…å­˜å±éšœçš„å¼€é”€æˆ‘æŸ¥ä¸‹æ¥å¤§æ¦‚æ˜¯ 100ã€200 ä¸ªæ—¶é’Ÿå‘¨æœŸï¼Œä¹Ÿå°±æ˜¯çº¦ 50 çº³ç§’å·¦å³å§ã€‚è€Œ Linux çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€çº¦åœ¨ 1 å¾®ç§’å¤šï¼Œä¹Ÿå°±æ˜¯ä¸¤è€…ä¹‹å‰çš„æ€§èƒ½å·®å¼‚è¶…è¿‡ 20 å€ã€‚å› æ­¤ï¼Œå†…å­˜å±éšœä¸å¤ªå¯èƒ½æ˜¯ä¸Šä¸‹æ–‡åˆ‡æ¢æ€§èƒ½å¼€é”€çš„ä¸»å› ã€‚<br><br>ä¸Šä¸‹æ–‡åˆ‡æ¢å®é™…éœ€è¦åšçš„äº‹æƒ…éå¸¸å¤šï¼Œé‚£åº”è¯¥æ‰æ˜¯ä¸»è¦åŸå› ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å´å’ç‚œ","uid":"1645639","ctime":1578734596,"ip_address":"","comment_id":170701,"utype":1}],"discussion_count":1,"race_medal":0,"score":"70298145561","product_id":100040501,"comment_content":"æ„Ÿè§‰è¿™é‡Œçš„æ— é”æ“ä½œå°±åƒåˆ†å¸ƒå¼ç³»ç»Ÿé‡Œé¢è°ˆåˆ°çš„ä¹è§‚é”ï¼Œæ™®é€šçš„äº’æ–¥é‡å°±åƒæ‚²è§‚é”ã€‚åªæ˜¯CPUçº§çš„ä¹è§‚é”ç”±CPUæä¾›æŒ‡ä»¤é›†çº§åˆ«çš„æ”¯æŒã€‚<br><br>å†…å­˜é‡æ’ä¼šå¼•èµ·å†…å­˜æ•°æ®çš„ä¸ä¸€è‡´æ€§ï¼Œå°¤å…¶æ˜¯åœ¨å¤šCPUçš„ç³»ç»Ÿé‡Œã€‚è¿™åˆè®©æˆ‘æƒ³èµ·åˆ†å¸ƒå¼ç³»ç»Ÿé‡Œè®²çš„CAPç†è®ºã€‚<br><br>å¤šçº¿ç¨‹å°±åƒåˆ†å¸ƒå¼ç³»ç»Ÿé‡Œçš„å¤šä¸ªèŠ‚ç‚¹ï¼Œæ¯ä¸ªCPUå¯¹è‡ªå·±ç¼“å­˜çš„å†™æ“ä½œåœ¨CPUåŒæ­¥ä¹‹å‰å°±é€ æˆäº†ä¸»å†…å­˜ä¸­æ•°æ®çš„å€¼åœ¨æ¯ä¸ªCPUç¼“å­˜ä¸­çš„ä¸ä¸€è‡´ï¼Œç›¸å½“äºåˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„åˆ†åŒºã€‚<br><br>æˆ‘å¤§æ¦‚çœ‹äº†å‚è€ƒæ–‡çŒ®ä¸€çœ¼ï¼Œå› ä¸ºä¸€çº§ç¼“å­˜ç›¸å¯¹ä¸»å†…å­˜é€Ÿåº¦æœ‰æ•°é‡çº§ä¸Šçš„ä¼˜åŠ¿ï¼Œæ‰€ä»¥å„ä¸ªç¼“å­˜é€‰æ‹©çš„ç­–ç•¥ç›¸å½“äºåˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„å¯ç”¨æ€§ï¼Œå³ä¿ç•™äº†APï¼ˆåˆ†åŒºå®¹é”™æ€§ä¸å¯ç”¨æ€§ï¼Œæ”¾å¼ƒæ•°æ®çš„ä¸€è‡´æ€§ï¼‰ï¼Œç„¶ååœ¨æ¶‰åŠåˆ°ç¼“å­˜æ•°æ®ä¸€è‡´æ€§é—®é¢˜ä¸Šï¼Œç›¸å½“äºé‡‡å–äº†æœ€ç»ˆä¸€è‡´æ€§ã€‚<br><br>å…¶å®æˆ‘è§‰å¾—ä¸è®ºæ˜¯ä»€ä¹ˆç³»ç»Ÿï¼Œæ—¶é—´é¢—è¶³å¤Ÿå°çš„è¯ï¼Œéƒ½ä¼šå­˜åœ¨æ•°æ®çš„ä¸ä¸€è‡´ï¼Œåªæ˜¯CPUçš„é€Ÿåº¦å¤ªå¿«äº†ï¼Œæ‰€ä»¥çœ‹èµ·æ¥éƒ½æ˜¯æœ€ç»ˆä¸€è‡´æ€§ã€‚åœ¨ä¿è¯å¯ç”¨æ€§çš„æ—¶å€™ï¼Œæ•´ä¸ªç¨‹åºçš„æŸä¸ªå˜é‡æˆ–å†…å­˜ä¸­çš„å€¼çœ‹èµ·æ¥å°±æ˜¯è¿›è¡Œäº†é‡æ’ã€‚<br><br>åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å°†å¤šä¸ªèŠ‚ç‚¹è§£è€¦çš„æ–¹å¼æ˜¯ç”¨å¼‚æ­¥ã€ç”¨å¯¹åˆ—ã€‚ç”Ÿäº§è€…æŠŠå˜åŒ–äº‹ä»¶å†™åˆ°å¯¹åˆ—é‡Œå°±è¿”å›ï¼Œç„¶åç”±æ¶ˆè´¹è€…å–å‡ºæ¥å¼‚æ­¥çš„å®æ–½è¿™äº›æ“ä½œï¼Œè¾¾åˆ°æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚<br><br>çœ‹èµ„æ–™é‡Œï¼Œå¤šCPUåŒæ­¥æ—¶ï¼Œä¹Ÿæœ‰åœ¨CPUä¹‹é—´å¼•å…¥å¯¹åˆ—ã€‚å½“éœ€è¦â€œé‡Šæ”¾å‰å¯¹å†…å­˜çš„ä¿®æ”¹éƒ½åœ¨å¦ä¸€ä¸ªçº¿ç¨‹çš„è·å–æ“ä½œåå¯è§â€æ—¶ï¼Œæˆ‘çš„ç†è§£å°±æ˜¯ç”¨äº†æ‰€è°“çš„â€œå†…å­˜å±éšœâ€å¼ºåˆ¶è®©æ¶ˆè´¹è€…æ¶ˆè´¹å®Œå¯¹åˆ—é‡Œçš„&quot;CPUçº§çš„äº‹ç‰©&quot;ã€‚æ‰€ä»¥æ‰ä¼šåœ¨è¾¾åˆ°ä¸¥æ ¼å†…å­˜åºçš„è¿‡ç¨‹ä¸­é™ä½äº†ç¨‹åºçš„æ€§èƒ½ã€‚<br><br>ä¹Ÿè®¸ï¼Œè¿™ä¸ªå’Œæ“ä½œç³»ç»Ÿåœ¨è°ƒåº¦çº¿ç¨‹æ—¶ï¼Œè¿‡å¤šçš„ä¸Šä¸‹æ–‡åˆ‡æ¢ä¼šå¯¼è‡´ç³»ç»Ÿæ€§èƒ½é™ä½æœ‰å…³ç³»ã€‚","like_count":17,"discussions":[{"author":{"id":1645639,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/47/53c48284.jpg","nickname":"å´å’ç‚œ","note":"","ucode":"8C24C10AEC779F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":481071,"discussion_content":"æ€è€ƒå¾—æŒºæ·±å…¥ï¼Œå¾ˆå¥½ã€‚ğŸ‘\n\næ“ä½œç³»ç»Ÿçš„ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œå†…å­˜åºçš„å…³ç³»æˆ‘ç•¥æœ‰ä¸åŒæ„è§ã€‚å†…å­˜å±éšœçš„å¼€é”€æˆ‘æŸ¥ä¸‹æ¥å¤§æ¦‚æ˜¯ 100ã€200 ä¸ªæ—¶é’Ÿå‘¨æœŸï¼Œä¹Ÿå°±æ˜¯çº¦ 50 çº³ç§’å·¦å³å§ã€‚è€Œ Linux çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€çº¦åœ¨ 1 å¾®ç§’å¤šï¼Œä¹Ÿå°±æ˜¯ä¸¤è€…ä¹‹å‰çš„æ€§èƒ½å·®å¼‚è¶…è¿‡ 20 å€ã€‚å› æ­¤ï¼Œå†…å­˜å±éšœä¸å¤ªå¯èƒ½æ˜¯ä¸Šä¸‹æ–‡åˆ‡æ¢æ€§èƒ½å¼€é”€çš„ä¸»å› ã€‚\n\nä¸Šä¸‹æ–‡åˆ‡æ¢å®é™…éœ€è¦åšçš„äº‹æƒ…éå¸¸å¤šï¼Œé‚£åº”è¯¥æ‰æ˜¯ä¸»è¦åŸå› ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578734596,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":170943,"user_name":"æœ¨ç“œ777","can_delete":false,"product_type":"c1","uid":1512537,"ip_address":"","ucode":"FC52A499AF6374","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/aFAYPyw7ywC1xE9h1qibnTBwtWn2ClJqlicy5cMomhZVaruMyqSq76wMkS279mUaGhrLGwWo9ZnW0WCWfmMovlXw/132","comment_is_top":false,"comment_ctime":1578795331,"is_pvip":false,"replies":[{"id":"66410","content":"ç”¨åŸå­é‡çš„åœ°æ–¹ï¼Œç²—æƒ³ä¸€ä¸‹ï¼Œä½ ç”¨é”éƒ½å¯ä»¥ã€‚ä½†å¦‚æœé”å¯¼è‡´é˜»å¡çš„è¯ï¼Œæ€§èƒ½æ¯”èµ·åŸå­é‡é‚£æ˜¯ä¼šæœ‰å¥½å‡ ä¸ªæ•°é‡çº§çš„å·®å¼‚äº†ã€‚é”å³ä½¿ä¸å¯¼è‡´é˜»å¡ï¼Œæ€§èƒ½ä¹Ÿä¼šæ¯”åŸå­é‡ä½â€”â€”é”æœ¬èº«çš„å®ç°å°±ä¼šç”¨åˆ°åŸå­é‡ï¼Œæ˜¯ä¸ªå¤æ‚çš„å¤åˆæ“ä½œã€‚<br><br>åè¿‡æ¥ä¸æˆç«‹ï¼Œç”¨äº’æ–¥é‡çš„åœ°æ–¹ä¸èƒ½éƒ½æ”¹ç”¨åŸå­é‡ã€‚åŸå­é‡æœ¬èº«æ²¡æœ‰é˜»å¡æœºåˆ¶ï¼Œæ²¡æœ‰ä¿æŠ¤ä»£ç æ®µçš„åŠŸèƒ½ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å´å’ç‚œ","uid":"1645639","ctime":1578897431,"ip_address":"","comment_id":170943,"utype":1}],"discussion_count":1,"race_medal":0,"score":"23053631811","product_id":100040501,"comment_content":"æ‚¨å¥½ï¼Œçœ‹äº†è¿™ç¯‡åï¼Œå¯¹äº’æ–¥é‡å’ŒåŸå­é‡çš„ä½¿ç”¨ æœ‰äº›ä¸æ˜ç™½ï¼Œä»€ä¹ˆæ—¶å€™åº”è¯¥ç”¨äº’æ–¥é‡ï¼Œä»€ä¹ˆæ—¶å€™ç”¨åŸå­é‡ï¼Œä»€ä¹ˆæ—¶å€™ä¸€èµ·ä½¿ç”¨ï¼Ÿ","like_count":5,"discussions":[{"author":{"id":1645639,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/47/53c48284.jpg","nickname":"å´å’ç‚œ","note":"","ucode":"8C24C10AEC779F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":481176,"discussion_content":"ç”¨åŸå­é‡çš„åœ°æ–¹ï¼Œç²—æƒ³ä¸€ä¸‹ï¼Œä½ ç”¨é”éƒ½å¯ä»¥ã€‚ä½†å¦‚æœé”å¯¼è‡´é˜»å¡çš„è¯ï¼Œæ€§èƒ½æ¯”èµ·åŸå­é‡é‚£æ˜¯ä¼šæœ‰å¥½å‡ ä¸ªæ•°é‡çº§çš„å·®å¼‚äº†ã€‚é”å³ä½¿ä¸å¯¼è‡´é˜»å¡ï¼Œæ€§èƒ½ä¹Ÿä¼šæ¯”åŸå­é‡ä½â€”â€”é”æœ¬èº«çš„å®ç°å°±ä¼šç”¨åˆ°åŸå­é‡ï¼Œæ˜¯ä¸ªå¤æ‚çš„å¤åˆæ“ä½œã€‚\n\nåè¿‡æ¥ä¸æˆç«‹ï¼Œç”¨äº’æ–¥é‡çš„åœ°æ–¹ä¸èƒ½éƒ½æ”¹ç”¨åŸå­é‡ã€‚åŸå­é‡æœ¬èº«æ²¡æœ‰é˜»å¡æœºåˆ¶ï¼Œæ²¡æœ‰ä¿æŠ¤ä»£ç æ®µçš„åŠŸèƒ½ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578897431,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":171534,"user_name":"prowu","can_delete":false,"product_type":"c1","uid":1000532,"ip_address":"","ucode":"F7866D8DEA0FBB","user_header":"https://static001.geekbang.org/account/avatar/00/0f/44/54/7e40e592.jpg","comment_is_top":false,"comment_ctime":1578963415,"is_pvip":false,"replies":[{"id":"66478","content":"1. â€œå¯è§â€ï¼Œå¯ä»¥ç†è§£æˆè·å¾—å’Œé‡Šæ”¾æ“ä½œçš„ä¸¤ä¸ªçº¿ç¨‹èƒ½è§‚å¯Ÿåˆ°ç›¸åŒçš„å†…å­˜ä¿®æ”¹ç»“æœã€‚<br><br>2. åŸåˆ™ä¸Šä»»ä½•å¤šçº¿ç¨‹è®¿é—®çš„å˜é‡åº”è¯¥è¦ä¹ˆæ˜¯åŸå­é‡ï¼Œè¦ä¹ˆæœ‰äº’æ–¥é‡æ¥ä¿æŠ¤ï¼Œè¿™æ ·æœ€å®‰å…¨ã€‚ç‰¹åˆ«è¦è€ƒè™‘å†…å­˜åºçš„ï¼Œå½“ç„¶å°±æ˜¯æœ‰å¤šä¸ªæœ‰é€»è¾‘ç›¸å…³æ€§çš„å…±äº«å˜é‡äº†ã€‚å¯¹äºå•ä¸ªçš„å˜é‡ï¼Œæ¯”å¦‚æ£€æŸ¥çº¿ç¨‹æ˜¯å¦åº”è¯¥é€€å‡ºçš„å¸ƒå°”å˜é‡ï¼Œåªè¦æ¶ˆé™¤äº†ç¼–è¯‘å™¨ä¼˜åŒ–ï¼Œä¸éœ€è¦ä¿è¯è®¿é—®é¡ºåºä¹Ÿå¯ä»¥æ­£å¸¸å·¥ä½œï¼›è¿™æ ·åŸå­é‡å¯ä»¥ä½¿ç”¨ relaxed çš„è®¿é—®æ–¹å¼ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å´å’ç‚œ","uid":"1645639","ctime":1578966242,"ip_address":"","comment_id":171534,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18758832599","product_id":100040501,"comment_content":"å´è€å¸ˆï¼Œæ‚¨å¥½ï¼æœ‰ä¸¤ä¸ªé—®é¢˜è¯·å¸®å¿™è§£ç­”ä¸‹ï¼š<br>1ã€åœ¨è§£é‡Šç›¸å…³memory_order_acquire, memory_order_releaseç­‰æ—¶ï¼Œéƒ½æœ‰æåˆ°â€œå½“å‰çº¿ç¨‹å¯è§â€ï¼Œè¿™ä¸ªâ€œå¯è§â€è¯¥æ€ä¹ˆç†è§£ï¼Ÿ<br>2ã€å¯ä»¥å¸®å¿™æ€»ç»“ä¸‹ï¼Œåœ¨ä»€ä¹ˆåœºæ™¯ä¸‹éœ€è¦ä¿è¯å†…å­˜åºï¼Œæ¯”å¦‚ï¼šæ»¡è¶³äº†ä»¥ä¸‹æ¡ä»¶ï¼Œå°±éœ€è¦è€ƒè™‘æ˜¯å¦ä¿è¯å†…å­˜åºäº†ï¼š<br>ï¼ˆ1ï¼‰å¤šçº¿ç¨‹ç¯å¢ƒä¸‹<br>ï¼ˆ2ï¼‰å­˜åœ¨å¤šä¸ªå˜é‡æ˜¯å¯å¤šä¸ªçº¿ç¨‹å…±äº«çš„ï¼Œæ¯”å¦‚ï¼šç±»æˆå‘˜å˜é‡ã€å…¨å±€å˜é‡<br>ï¼ˆ3ï¼‰è¿™å¤šä¸ªå…±äº«å˜é‡åœ¨å®ç°é€»è¾‘ä¸Šå­˜åœ¨ç›¸äº’ä¾èµ–çš„å…³ç³»<br>ï¼ˆ4ï¼‰...<br><br>è°¢è°¢ï¼","like_count":4,"discussions":[{"author":{"id":1645639,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/47/53c48284.jpg","nickname":"å´å’ç‚œ","note":"","ucode":"8C24C10AEC779F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":481401,"discussion_content":"1. â€œå¯è§â€ï¼Œå¯ä»¥ç†è§£æˆè·å¾—å’Œé‡Šæ”¾æ“ä½œçš„ä¸¤ä¸ªçº¿ç¨‹èƒ½è§‚å¯Ÿåˆ°ç›¸åŒçš„å†…å­˜ä¿®æ”¹ç»“æœã€‚\n\n2. åŸåˆ™ä¸Šä»»ä½•å¤šçº¿ç¨‹è®¿é—®çš„å˜é‡åº”è¯¥è¦ä¹ˆæ˜¯åŸå­é‡ï¼Œè¦ä¹ˆæœ‰äº’æ–¥é‡æ¥ä¿æŠ¤ï¼Œè¿™æ ·æœ€å®‰å…¨ã€‚ç‰¹åˆ«è¦è€ƒè™‘å†…å­˜åºçš„ï¼Œå½“ç„¶å°±æ˜¯æœ‰å¤šä¸ªæœ‰é€»è¾‘ç›¸å…³æ€§çš„å…±äº«å˜é‡äº†ã€‚å¯¹äºå•ä¸ªçš„å˜é‡ï¼Œæ¯”å¦‚æ£€æŸ¥çº¿ç¨‹æ˜¯å¦åº”è¯¥é€€å‡ºçš„å¸ƒå°”å˜é‡ï¼Œåªè¦æ¶ˆé™¤äº†ç¼–è¯‘å™¨ä¼˜åŒ–ï¼Œä¸éœ€è¦ä¿è¯è®¿é—®é¡ºåºä¹Ÿå¯ä»¥æ­£å¸¸å·¥ä½œï¼›è¿™æ ·åŸå­é‡å¯ä»¥ä½¿ç”¨ relaxed çš„è®¿é—®æ–¹å¼ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578966242,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":171788,"user_name":"ç¦¾æ¡ƒ","can_delete":false,"product_type":"c1","uid":1477855,"ip_address":"","ucode":"9FE85C34A9E9E0","user_header":"https://static001.geekbang.org/account/avatar/00/16/8c/df/77acb793.jpg","comment_is_top":false,"comment_ctime":1579011990,"is_pvip":false,"replies":[{"id":"66750","content":"è¿™ç¯‡å¤ªç®€å•äº†ï¼ŒåŸºæœ¬ä¸Šåªæ˜¯è¦†ç›–å°è¯•åŠ é”è¿™ä¸€æ­¥ï¼ˆå¤§è‡´æ˜¯ compare_exchange_strongï¼‰ã€‚è€Œä¸”ï¼Œç°ä»£æ“ä½œç³»ç»Ÿä¸Šè°ä¼šç”¨å…³ä¸­æ–­å•Šã€‚<br><br>æœ€å…³é”®çš„æ˜¯ï¼Œä¸€ä¸ªçº¿ç¨‹åœ¨åŠ é”å¤±è´¥æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆã€‚æ“ä½œç³»ç»Ÿä¼šæŒ‚èµ·è¿™ä¸ªçº¿ç¨‹ï¼Œå¹¶åœ¨é”é‡Šæ”¾æ—¶å¯èƒ½ä¼šé‡æ–°å”¤èµ·è¿™ä¸ªçº¿ç¨‹ã€‚æ–‡ä¸­å®Œå…¨æ²¡æœ‰æè¿™ä¸ªã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å´å’ç‚œ","uid":"1645639","ctime":1579098378,"ip_address":"","comment_id":171788,"utype":1}],"discussion_count":4,"race_medal":0,"score":"14463913878","product_id":100040501,"comment_content":"å’Œå¤§å®¶åˆ†äº«ä¸€ä¸ªé“¾æ¥<br><br><br>æ“ä½œç³»ç»Ÿä¸­é”çš„å®ç°åŸç†<br><br><br>https:&#47;&#47;mp.weixin.qq.com&#47;s&#47;6MRi_UEcMybKn4YXi6qWng","like_count":3,"discussions":[{"author":{"id":1645639,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/47/53c48284.jpg","nickname":"å´å’ç‚œ","note":"","ucode":"8C24C10AEC779F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":481509,"discussion_content":"è¿™ç¯‡å¤ªç®€å•äº†ï¼ŒåŸºæœ¬ä¸Šåªæ˜¯è¦†ç›–å°è¯•åŠ é”è¿™ä¸€æ­¥ï¼ˆå¤§è‡´æ˜¯ compare_exchange_strongï¼‰ã€‚è€Œä¸”ï¼Œç°ä»£æ“ä½œç³»ç»Ÿä¸Šè°ä¼šç”¨å…³ä¸­æ–­å•Šã€‚\n\næœ€å…³é”®çš„æ˜¯ï¼Œä¸€ä¸ªçº¿ç¨‹åœ¨åŠ é”å¤±è´¥æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆã€‚æ“ä½œç³»ç»Ÿä¼šæŒ‚èµ·è¿™ä¸ªçº¿ç¨‹ï¼Œå¹¶åœ¨é”é‡Šæ”¾æ—¶å¯èƒ½ä¼šé‡æ–°å”¤èµ·è¿™ä¸ªçº¿ç¨‹ã€‚æ–‡ä¸­å®Œå…¨æ²¡æœ‰æè¿™ä¸ªã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579098378,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1477855,"avatar":"https://static001.geekbang.org/account/avatar/00/16/8c/df/77acb793.jpg","nickname":"ç¦¾æ¡ƒ","note":"","ucode":"9FE85C34A9E9E0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":135781,"discussion_content":"æœŸå¾…å´è€å¸ˆæ¥ä¸€ç¯‡:)","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579100671,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1645639,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/47/53c48284.jpg","nickname":"å´å’ç‚œ","note":"","ucode":"8C24C10AEC779F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":1477855,"avatar":"https://static001.geekbang.org/account/avatar/00/16/8c/df/77acb793.jpg","nickname":"ç¦¾æ¡ƒ","note":"","ucode":"9FE85C34A9E9E0","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":136552,"discussion_content":"å¤ªå¤æ‚â€¦â€¦å¯¹ä¸€èˆ¬çš„å¼€å‘æ²¡ä»€ä¹ˆå¸®åŠ©ã€‚è€Œä¸”ï¼Œè¿™ä¸»è¦æ˜¯æ“ä½œç³»ç»Ÿå±‚é¢çš„äº‹ï¼Œåº•å±‚æ“ä½œï¼Œæ²¡æ³•é€šç”¨åœ°å†™å‡ºæ¥ã€‚\n\næˆ‘æƒ³ï¼Œè¯´ä¸å®šè®²Linuxçš„ä¸“æ é‡Œæœ‰å‰–æäº’æ–¥é‡æ˜¯å¦‚ä½•å®ç°çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579147829,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":135781,"ip_address":""},"score":136552,"extra":""},{"author":{"id":1477855,"avatar":"https://static001.geekbang.org/account/avatar/00/16/8c/df/77acb793.jpg","nickname":"ç¦¾æ¡ƒ","note":"","ucode":"9FE85C34A9E9E0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1645639,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/47/53c48284.jpg","nickname":"å´å’ç‚œ","note":"","ucode":"8C24C10AEC779F","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":136872,"discussion_content":"å—¯å—¯ï¼Œå¤šè°¢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579169537,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":136552,"ip_address":""},"score":136872,"extra":""}]}]},{"had_liked":false,"id":292961,"user_name":"Counting stars","can_delete":false,"product_type":"c1","uid":1242983,"ip_address":"","ucode":"EF2BD8F2921B59","user_header":"https://static001.geekbang.org/account/avatar/00/12/f7/67/4997eebf.jpg","comment_is_top":false,"comment_ctime":1621098546,"is_pvip":false,"replies":[{"id":"106087","content":"è¿™ä¸ªé—®é¢˜æå¾—ç›¸å½“å¥½ã€‚äº‹å®ä¸Šï¼Œè¿™ä¸ªè¡Œä¸ºæ˜¯æ ‡å‡†çš„ï¼ŒGCC&#47;Clangä¸‹ä¹Ÿå¯ä»¥éªŒè¯è¿™ä¸ªæ•ˆæœã€‚<br><br>ä»”ç»†çœ‹ä¸€ä¸‹ä½ ä¼šå‘ç°releaseå¯ä»¥é˜²æ­¢å‰é¢çš„è¯»å†™è¢«é‡æ’åˆ°åé¢ï¼Œè€Œacquireå¯ä»¥é˜²æ­¢åé¢çš„è¯»å†™è¢«é‡æ’åˆ°å‰é¢ã€‚ä½†åªç”¨acquire&#47;releaseæœºåˆ¶ä¸èƒ½é˜²æ­¢ä¾‹å­ä¸­çš„è¯»æå‰ï¼Œå“ªæ€•æŠŠXã€Yã€r1ã€r2å…¨éƒ¨å˜æˆåŸå­é‡ä¹Ÿä¸è¡Œï¼â€”â€”æˆ‘ä»¬æ˜¯æƒ³é˜²æ­¢loadè¢«æå‰ï¼Œä½†releaseåªèƒ½é˜²æ­¢å»¶åï¼Œä¸èƒ½é˜²æ­¢æå‰ã€‚<br><br>acquire&#47;releaseæœºåˆ¶ä¸€èˆ¬ç”¨äºåŸºäºå•ä¸ªåŸå­é‡çš„åŒæ­¥ï¼ŒåŸºäºå¤šä¸ªåŸå­é‡çš„åŒæ­¥ï¼Œå°±éœ€è¦é¡ºåºä¸€è‡´æ€§äº†ã€‚åªæœ‰â€œé¡ºåºä¸€è‡´æ€§è¿˜ä¿è¯äº†å¤šä¸ªåŸå­é‡çš„ä¿®æ”¹åœ¨æ‰€æœ‰çº¿ç¨‹é‡Œè§‚å¯Ÿåˆ°çš„ä¿®æ”¹é¡ºåºéƒ½ç›¸åŒâ€ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å´å’ç‚œ","uid":"1645639","ctime":1621170148,"ip_address":"","comment_id":292961,"utype":1}],"discussion_count":2,"race_medal":0,"score":"10211033138","product_id":100040501,"comment_content":"é“¾æ¥[2]çš„ä»£ç åœ¨msvcç¼–è¯‘å™¨releaseæ¨¡å¼ä¸‹ç”¨atomic intæµ‹è¯•äº†ä¸€ä¸‹ï¼ŒX Yé€šè¿‡ storeçš„æŒ‡å®šmemory_order_releaseå¹¶æ²¡æœ‰è¾¾åˆ°æœŸæœ›çš„å†…å­˜å±éšœæ•ˆæœï¼Œä»ç„¶å‡ºç°äº†å†™è¯»åºåˆ—å˜æˆè¯»å†™åºåˆ—çš„é—®é¢˜ï¼Œä»”ç»†åˆ†æäº†ä¸€ä¸‹ï¼š<br>memory_order_releaseåœ¨x86&#47;64ä¸Šçœ‹æºç æœ‰ä¸€ä¸ªæç¤ºï¼Œ<br>case memory_order_release:<br>            _Compiler_or_memory_barrier();<br>            _ISO_VOLATILE_STORE32(_Storage, _As_bytes);<br>            return;<br>æŸ¥çœ‹äº†ä¸€ä¸‹å…·ä½“å®šä¹‰<br>#elif defined(_M_IX86) || defined(_M_X64)<br>&#47;&#47; x86&#47;x64 hardware only emits memory barriers inside _Interlocked intrinsics<br>#define _Compiler_or_memory_barrier() _Compiler_barrier()<br>çœ‹èµ·æ¥msvcçš„åšæ³•ï¼Œå¹¶æ²¡æœ‰é’ˆå¯¹memory_order_releaseå®ç°æ ‡å‡†çš„å†…å­˜å±éšœæ”¯æŒ<br>å‚è€ƒè€å¸ˆæä¾›ç¤ºä¾‹è¿æ¥ä¸­çš„ä¾‹å­MemoryBarrier()æ˜¯å¯ä»¥æ‰‹åŠ¨æ•ˆæœå®ç°è¿™ä¸€ä¸ªæ•ˆæœ<br>æœ€ç»ˆç»“è®ºå¦‚ä¸‹ï¼š<br>msvc2019ä¸‹ï¼Œmemory_order_releaseå¹¶ä¸èƒ½ä¿è¯å†…å­˜å±éšœæ•ˆæœï¼Œåªèƒ½é€šè¿‡é»˜è®¤çš„memory_order_seq_cstæ¥ä¿è¯<br>è€å¸ˆå¯ä»¥å’Œæ‚¨äº¤æµä¸€ä¸‹æˆ‘çš„è§‚ç‚¹å—","like_count":2,"discussions":[{"author":{"id":1645639,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/47/53c48284.jpg","nickname":"å´å’ç‚œ","note":"","ucode":"8C24C10AEC779F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":520029,"discussion_content":"è¿™ä¸ªé—®é¢˜æå¾—ç›¸å½“å¥½ã€‚äº‹å®ä¸Šï¼Œè¿™ä¸ªè¡Œä¸ºæ˜¯æ ‡å‡†çš„ï¼ŒGCC/Clangä¸‹ä¹Ÿå¯ä»¥éªŒè¯è¿™ä¸ªæ•ˆæœã€‚\n\nä»”ç»†çœ‹ä¸€ä¸‹ä½ ä¼šå‘ç°releaseå¯ä»¥é˜²æ­¢å‰é¢çš„è¯»å†™è¢«é‡æ’åˆ°åé¢ï¼Œè€Œacquireå¯ä»¥é˜²æ­¢åé¢çš„è¯»å†™è¢«é‡æ’åˆ°å‰é¢ã€‚ä½†åªç”¨acquire/releaseæœºåˆ¶ä¸èƒ½é˜²æ­¢ä¾‹å­ä¸­çš„è¯»æå‰ï¼Œå“ªæ€•æŠŠXã€Yã€r1ã€r2å…¨éƒ¨å˜æˆåŸå­é‡ä¹Ÿä¸è¡Œï¼â€”â€”æˆ‘ä»¬æ˜¯æƒ³é˜²æ­¢loadè¢«æå‰ï¼Œä½†releaseåªèƒ½é˜²æ­¢å»¶åï¼Œä¸èƒ½é˜²æ­¢æå‰ã€‚\n\nacquire/releaseæœºåˆ¶ä¸€èˆ¬ç”¨äºåŸºäºå•ä¸ªåŸå­é‡çš„åŒæ­¥ï¼ŒåŸºäºå¤šä¸ªåŸå­é‡çš„åŒæ­¥ï¼Œå°±éœ€è¦é¡ºåºä¸€è‡´æ€§äº†ã€‚åªæœ‰â€œé¡ºåºä¸€è‡´æ€§è¿˜ä¿è¯äº†å¤šä¸ªåŸå­é‡çš„ä¿®æ”¹åœ¨æ‰€æœ‰çº¿ç¨‹é‡Œè§‚å¯Ÿåˆ°çš„ä¿®æ”¹é¡ºåºéƒ½ç›¸åŒâ€ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621170148,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1242983,"avatar":"https://static001.geekbang.org/account/avatar/00/12/f7/67/4997eebf.jpg","nickname":"Counting stars","note":"","ucode":"EF2BD8F2921B59","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":374417,"discussion_content":"æ„Ÿè°¢è€å¸ˆçš„æŒ‡å¯¼ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621172773,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":175881,"user_name":"czh","can_delete":false,"product_type":"c1","uid":1159078,"ip_address":"","ucode":"649FE5C9269D69","user_header":"https://static001.geekbang.org/account/avatar/00/11/af/a6/3f15ba2f.jpg","comment_is_top":false,"comment_ctime":1580877714,"is_pvip":false,"replies":[{"id":"68420","content":"ä½ ä»éœ€æ±‚æ–¹é¢ç†è§£çš„ 1ã€2ã€3 æˆ‘è§‰å¾—éƒ½å¯¹ï¼Œå¾ˆå¥½ï¼<br><br>â€œäº’æ–¥é‡åªæœ‰å’Œé”é…åˆâ€è¿™ä¸ªææ³•æˆ‘è§‰å¾—å¾ˆæ€ªï¼šäº’æ–¥é‡æ˜¯ä¸ªå¯¹è±¡ï¼Œï¼ˆåŠ &#47;è§£ï¼‰é”æ˜¯äº’æ–¥é‡æ”¯æŒçš„åŠ¨ä½œâ€”â€”å¦‚æœä½ æŒ‡ lock_guard ä¹‹ç±»çš„ç±»ï¼Œé‚£æ˜¯è¾…åŠ©çš„ RAII å¯¹è±¡ï¼Œç›®çš„åªæ˜¯è‡ªåŠ¨åŒ–äº’æ–¥é‡ä¸Šçš„å¯¹åº”æ“ä½œè€Œå·²ã€‚<br><br>ä½ å¯èƒ½æ˜¯è¢«â€œæ“ä½œç³»ç»Ÿä¸­é”çš„å®ç°åŸç†â€è¿™æ ·çš„ææ³•å¸¦åäº†ã€‚æ²¡æœ‰ä½œä¸ºåå­—çš„ä¸“é—¨é”å¯¹è±¡ï¼Œåªæœ‰äº’æ–¥é‡ã€æ¡ä»¶å˜é‡ã€åŸå­é‡ã€‚æˆ‘ä¹Ÿè¢«å¸¦åäº†ï¼Œæˆ‘åœ¨æŸä¸ªè¯„è®ºé‡Œè¯´â€œé”â€çš„æ—¶å€™ï¼ŒæŒ‡çš„å°±æ˜¯äº’æ–¥é‡åŠ é”ã€‚<br><br>","user_name":"ä½œè€…å›å¤","user_name_real":"å´å’ç‚œ","uid":"1645639","ctime":1580917057,"ip_address":"","comment_id":175881,"utype":1}],"discussion_count":2,"race_medal":0,"score":"10170812306","product_id":100040501,"comment_content":"ä¸“æ é‡Œé¢çš„è¯„è®ºéƒ½æ»¡åœ°æ˜¯å®ï¼Œè¿™å°±æ˜¯æ¯”å•ƒä¹¦æœ¬å¼ºå¤ªå¤šçš„åœ°æ–¹ï¼Œå¤§å®¶å¯ä»¥è®¨è®ºè¯·æ•™ã€‚æ–‡ç« éœ€è¦å¤ä¹ ï¼Œè¯„è®ºä¹ŸåŒæ ·éœ€è¦å¤ä¹ ï¼Œçœ‹çœ‹æ˜¯å¦æœ‰äº†æ–°çš„æƒ³æ³•ğŸ’¡ã€‚<br><br>åœ¨é˜…è¯»çš„æ—¶å€™ï¼Œæˆ‘å¿ƒé‡Œä¹Ÿæœ‰å‰é¢å‡ ä¸ªè¯»è€…çš„å…³äºé”ã€äº’æ–¥é‡ã€åŸå­æ“ä½œçš„åŒºåˆ«ä¸è”ç³»çš„ç–‘é—®ğŸ¤”ï¸ã€‚<br><br>æˆ‘å°è¯•è¯´ä¸€ä¸‹æˆ‘çš„ç†è§£ï¼šç«™åœ¨éœ€æ±‚çš„è§’åº¦<br>1.å¯¹å•ç‹¬æ²¡æœ‰é€»è¾‘è”ç³»çš„å˜é‡ï¼Œç›´æ¥ä½¿ç”¨åŸå­é‡çš„relaxedå°±å¤Ÿäº†ï¼Œæ²¡å¿…è¦åŠ ä¸Šå†…å­˜åº<br>2.å¯¹äºæœ‰è”ç³»çš„å¤šä¸ªå¤šçº¿ç¨‹ä¸­çš„å˜é‡ï¼Œè¿™æ—¶å°±éœ€è¦è€ƒè™‘ä½¿ç”¨åŸå­é‡çš„å†…å­˜åº<br>3.å¯¹äºä»£ç æ®µçš„ä¿æŠ¤ï¼Œç”±äºåŸå­é‡æ²¡æœ‰é˜»å¡ï¼Œæ‰€ä»¥å¿…é¡»ä½¿ç”¨äº’æ–¥é‡å’Œé”æ¥è§£å†³<br>psï¼šäº’æ–¥é‡+é”çš„æ“ä½œ   å¯å–ä»£  åŸå­é‡ã€‚åä¹‹ä¸å¯ã€‚<br><br>å¦å¤–ï¼Œè¿˜äº§ç”Ÿæ–°çš„ç–‘é—®ï¼š<br>1.äº’æ–¥é‡çš„å®šä¹‰ä¸­ï¼Œä¸€ä¸ªäº’æ–¥é‡åªå…è®¸åœ¨å¤šçº¿ç¨‹ä¸­åŠ ä¸€æŠŠé”ï¼Œé‚£ä¹ˆæ˜¯å¦å¯ä»¥è¯´äº’æ–¥é‡åªæœ‰å’Œé”é…åˆè¾¾åˆ°ä¿æŠ¤ä»£ç æ®µçš„ä½œç”¨ï¼Œäº’æ–¥é‡è¿˜æœ‰å…¶ä»–å•ç‹¬çš„ç”¨æ³•å—ï¼Ÿ<br>2.æ›´è¿‘ä¸€æ­¥ï¼ŒåŸå­é‡+é”ï¼Œæ˜¯å¦å¯ä»¥å®Œæˆå¯¹ä»£ç æ®µçš„ä¿æŠ¤ï¼Ÿè€Œå´è€å¸ˆä¹Ÿåœ¨è¯„è®ºåŒºé‡Œæåˆ°ï¼šé”æ˜¯ç”±åŸå­é‡æ„æˆçš„ã€‚<br><br>æœ›è€å¸ˆè§£ç­”ï¼Œçº æ­£ã€‚","like_count":3,"discussions":[{"author":{"id":1645639,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/47/53c48284.jpg","nickname":"å´å’ç‚œ","note":"","ucode":"8C24C10AEC779F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":482938,"discussion_content":"ä½ ä»éœ€æ±‚æ–¹é¢ç†è§£çš„ 1ã€2ã€3 æˆ‘è§‰å¾—éƒ½å¯¹ï¼Œå¾ˆå¥½ï¼\n\nâ€œäº’æ–¥é‡åªæœ‰å’Œé”é…åˆâ€è¿™ä¸ªææ³•æˆ‘è§‰å¾—å¾ˆæ€ªï¼šäº’æ–¥é‡æ˜¯ä¸ªå¯¹è±¡ï¼Œï¼ˆåŠ /è§£ï¼‰é”æ˜¯äº’æ–¥é‡æ”¯æŒçš„åŠ¨ä½œâ€”â€”å¦‚æœä½ æŒ‡ lock_guard ä¹‹ç±»çš„ç±»ï¼Œé‚£æ˜¯è¾…åŠ©çš„ RAII å¯¹è±¡ï¼Œç›®çš„åªæ˜¯è‡ªåŠ¨åŒ–äº’æ–¥é‡ä¸Šçš„å¯¹åº”æ“ä½œè€Œå·²ã€‚\n\nä½ å¯èƒ½æ˜¯è¢«â€œæ“ä½œç³»ç»Ÿä¸­é”çš„å®ç°åŸç†â€è¿™æ ·çš„ææ³•å¸¦åäº†ã€‚æ²¡æœ‰ä½œä¸ºåå­—çš„ä¸“é—¨é”å¯¹è±¡ï¼Œåªæœ‰äº’æ–¥é‡ã€æ¡ä»¶å˜é‡ã€åŸå­é‡ã€‚æˆ‘ä¹Ÿè¢«å¸¦åäº†ï¼Œæˆ‘åœ¨æŸä¸ªè¯„è®ºé‡Œè¯´â€œé”â€çš„æ—¶å€™ï¼ŒæŒ‡çš„å°±æ˜¯äº’æ–¥é‡åŠ é”ã€‚\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580917057,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1543040,"avatar":"https://static001.geekbang.org/account/avatar/00/17/8b/80/8702bd5f.jpg","nickname":"evan","note":"","ucode":"491B073D5AFEDE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":336954,"discussion_content":"&#34;psï¼šäº’æ–¥é‡+é”çš„æ“ä½œ å¯å–ä»£ åŸå­é‡ã€‚åä¹‹ä¸å¯ã€‚&#34;\næ²¡çœ‹æ‡‚.. ä½ çš„è¯­å¢ƒé‡Œäº’æ–¥é‡æŒ‡çš„æ˜¯ std::mutexå—?\nè¿™é‡Œçš„mutexæœ¬èº«ä¸å°±æ˜¯&#34;é”&#34;çš„ä¸€ç§å— ç§°ä¸ºäº’æ–¥é”, è¿˜æœ‰è¯»å†™é”ç­‰..\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608733699,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":171055,"user_name":"ç¦¾æ¡ƒ","can_delete":false,"product_type":"c1","uid":1477855,"ip_address":"","ucode":"9FE85C34A9E9E0","user_header":"https://static001.geekbang.org/account/avatar/00/16/8c/df/77acb793.jpg","comment_is_top":false,"comment_ctime":1578834184,"is_pvip":false,"replies":[{"id":"66399","content":"#1<br><br>ä¸ä¸€å®šã€‚æ¯”å¦‚ï¼Œå¯¹äº storeï¼Œç”Ÿæˆå¯èƒ½å°±åªæ˜¯ mov æŒ‡ä»¤åŠ ä¸ª mfenceã€‚<br><br>#2<br><br>æ˜¯ã€‚<br><br>#3<br><br>ä½ å¯ä»¥å¯¹æ¯”ä¸€ä¸‹ç¼–è¯‘å™¨ç”Ÿæˆçš„æ±‡ç¼–ä»£ç ï¼š<br><br>https:&#47;&#47;godbolt.org&#47;z&#47;UHsDRj","user_name":"ä½œè€…å›å¤","user_name_real":"å´å’ç‚œ","uid":"1645639","ctime":1578895057,"ip_address":"","comment_id":171055,"utype":1}],"discussion_count":3,"race_medal":0,"score":"5873801480","product_id":100040501,"comment_content":"is_lock_freeï¼Œåˆ¤æ–­å¯¹åŸå­å¯¹è±¡çš„æ“ä½œæ˜¯å¦æ— é”ï¼ˆæ˜¯å¦å¯ä»¥ç”¨å¤„ç†å™¨çš„æŒ‡ä»¤ç›´æ¥å®ŒæˆåŸå­æ“ä½œï¼‰<br><br>#1<br>è¿™é‡Œçš„å¤„ç†å™¨çš„æŒ‡ä»¤æŒ‡çš„æ˜¯ï¼Œ<br>â€œlock cmpxchgâ€?<br><br>#2<br>â€œæ˜¯å¦å¯ä»¥ç”¨å¤„ç†å™¨çš„æŒ‡ä»¤ç›´æ¥å®ŒæˆåŸå­æ“ä½œâ€, è¿™é‡Œçš„ç›´æ¥æŒ‡çš„æ˜¯ä»…ä½¿ç”¨â€œå¤„ç†å™¨çš„æŒ‡ä»¤å—ï¼Ÿ<br><br>#3<br>èƒ½éº»çƒ¦ç»™ä¸ªis_not_lock_freeçš„å¯¹åŸå­å¯¹è±¡çš„æ“ä½œçš„å¤§æ¦‚ä»€ä¹ˆæ ·å­å—ï¼Ÿ<br><br>è°¢è°¢ï¼","like_count":1,"discussions":[{"author":{"id":1645639,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/47/53c48284.jpg","nickname":"å´å’ç‚œ","note":"","ucode":"8C24C10AEC779F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":481223,"discussion_content":"#1\n\nä¸ä¸€å®šã€‚æ¯”å¦‚ï¼Œå¯¹äº storeï¼Œç”Ÿæˆå¯èƒ½å°±åªæ˜¯ mov æŒ‡ä»¤åŠ ä¸ª mfenceã€‚\n\n#2\n\næ˜¯ã€‚\n\n#3\n\nä½ å¯ä»¥å¯¹æ¯”ä¸€ä¸‹ç¼–è¯‘å™¨ç”Ÿæˆçš„æ±‡ç¼–ä»£ç ï¼š\n\nhttps://godbolt.org/z/UHsDRj","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578895057,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1477855,"avatar":"https://static001.geekbang.org/account/avatar/00/16/8c/df/77acb793.jpg","nickname":"ç¦¾æ¡ƒ","note":"","ucode":"9FE85C34A9E9E0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":131915,"discussion_content":"#4 \nmutexçš„å®ç°ä»£ç é‡Œæœ‰ç”¨åˆ°ï¼Œå¤„ç†å™¨çš„æŒ‡ä»¤\nâ€œlock cmpxchgâ€å—ï¼Ÿ\n\nç”¨mutex,å°±æ˜¯is_not_lock_free;\nç›´æ¥ç”¨â€œlock cmpxcha, å°±æ˜¯is_lock_free.\n\nè¿™ä¹ˆç†è§£æœ‰é—®é¢˜å—ï¼Ÿ\nå¦‚æœæ²¡æœ‰çš„è¯ï¼Œis_lock_freeå’Œis_not_lock_freeéƒ½ç›´æ¥æˆ–é—´æ¥çš„ä½¿ç”¨äº†â€lock cmpxchaâ€,ä»–ä»¬ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¹ˆå¤§çš„åŒºåˆ«ï¼Ÿ\n\nè°¢è°¢ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578874867,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1645639,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/47/53c48284.jpg","nickname":"å´å’ç‚œ","note":"","ucode":"8C24C10AEC779F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":1477855,"avatar":"https://static001.geekbang.org/account/avatar/00/16/8c/df/77acb793.jpg","nickname":"ç¦¾æ¡ƒ","note":"","ucode":"9FE85C34A9E9E0","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":132364,"discussion_content":"æœ€åŸºæœ¬çš„åŒºåˆ«ï¼Œäº’æ–¥é‡å¯èƒ½å¯¼è‡´é˜»å¡ï¼ˆä»è€Œæœ‰æ­»é”çš„å¯èƒ½ï¼‰ã€‚ä¸€æ—¦é˜»å¡ï¼Œæ¯”èµ·åŸå­æ“ä½œæ¥æ€§èƒ½ä¸‹é™æ˜¯è‡³å°‘æˆåƒä¸Šä¸‡å€ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578901181,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":131915,"ip_address":""},"score":132364,"extra":""}]}]},{"had_liked":false,"id":171045,"user_name":"èŠ±æ™¨å°‘å¹´","can_delete":false,"product_type":"c1","uid":1098987,"ip_address":"","ucode":"6AA3537A6BA10E","user_header":"https://static001.geekbang.org/account/avatar/00/10/c4/eb/2285a345.jpg","comment_is_top":false,"comment_ctime":1578831472,"is_pvip":false,"replies":[{"id":"66407","content":"çœ‹å‚è€ƒèµ„æ–™4å§ã€‚å¦‚æœå«Œå¤ªé•¿ï¼Œå°±åªçœ‹ä»£ç ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨çœ¼é‡Œå…è®¸é‡æ’æˆçš„æ ·å­ã€‚<br><br>ç®€å•è¯´ï¼Œå°±æ˜¯èµ‹å€¼é¡ºåºçš„é—®é¢˜ã€‚è‡³å°‘åœ¨æŸäº›å¤„ç†å™¨ä¸Šï¼Œå…¶ä»–çº¿ç¨‹å¯èƒ½å…ˆçœ‹åˆ° inst_ptr_ è¢«ä¿®æ”¹ï¼Œå†çœ‹åˆ°å•ä»¶çš„æ„é€ å®Œæˆã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å´å’ç‚œ","uid":"1645639","ctime":1578896813,"ip_address":"","comment_id":171045,"utype":1}],"discussion_count":3,"race_medal":0,"score":"5873798768","product_id":100040501,"comment_content":"è¿™ä¸€èŠ‚è®²çš„å®åœ¨æ˜¯å¤ªå¥½äº†ï¼Œæˆ‘å¯¹å‰å‡ èŠ‚çš„ç¼–è¯‘å™¨æ¨¡ç‰ˆç›¸å…³çš„ä¸æ˜¯å¾ˆæ„Ÿå†’ï¼Œè¦æ˜¯èƒ½æŠŠè¿™æœŸæ›´æ·±å…¥çš„ç»†èŠ‚æ¢è®¨ä¸€ä¸‹ï¼Œå¤šåšå‡ èŠ‚ï¼Œå°±æ›´å¥½äº†ã€‚<br><br>singleton* singleton::instance()<br>{<br>  @a<br>  if (inst_ptr_ == nullptr) {&#47;&#47;@1<br>    @b<br>    lock_guard lock;  &#47;&#47;  åŠ é”<br>    if (inst_ptr_ == nullptr) {<br>\t@c<br>      inst_ptr_ = new singleton();&#47;&#47;@2<br>        @d<br>    }<br>  }<br>  return inst_ptr_;<br>}<br><br>æœ‰ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å¯¹double checké‚£ä¸ªä¾‹å­çš„ç–‘æƒ‘ï¼Œä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜ï¼Ÿ<br>inst_ptr_åº”è¯¥å°±ä¸¤ç§çŠ¶æ€ï¼Œnullå’Œénullã€‚<br>å¦‚æœçº¿ç¨‹1åœ¨@bå¤„ï¼Œç­‰å¾…é”ï¼Œè¿™ä¸ªæ—¶å€™çº¿ç¨‹2ä¸ç®¡åœ¨@cæˆ–è€…@då¤„ï¼Œçº¿ç¨‹aè·å¾—é”çš„æ—¶å€™ï¼Œéƒ½ä¸ä¼šè¿›å…¥@cï¼Œå› ä¸ºinst_ptrå·²ç»éç©ºã€‚<br>å¦‚æœçº¿ç¨‹1åœ¨@aå¤„ï¼Œçº¿ç¨‹2åœ¨@2å¤„ï¼Œæ‰§è¡Œnewæ“ä½œï¼Œéš¾é“@2è¿™ä¸ªè¯­å¥æœ‰ä»€ä¹ˆé—®é¢˜å—ï¼Œéš¾é“@2ä¸æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œä¼šå¯¼è‡´çº¿ç¨‹1å·²ç»å¾—åˆ°çº¿ç¨‹2åˆ†é…çš„å¯¹è±¡åœ°å€ï¼Œè€Œå†…å­˜è¿˜æ²¡æœ‰å‡†å¤‡å¥½å—ï¼Ÿå¦‚æœæ˜¯è¿™ç§æƒ…å†µçš„è¯ï¼Œ<br>é‚£ä¹ˆä¸‹é¢åŠ å…¥äº†åŸå­æ“ä½œåï¼Œä¹Ÿæ²¡æœ‰è§£å†³newé—®é¢˜å•Šï¼Œ<br><br>singleton* singleton::instance()<br>{<br>  singleton* ptr = inst_ptr_.load(<br>    memory_order_acquire);<br>  if (ptr == nullptr) {<br>    lock_guard&lt;mutex&gt; guard{lock_};<br>    ptr = inst_ptr_.load(<br>      memory_order_relaxed);<br>    if (ptr == nullptr) {<br>      ptr = new singleton();<br>      inst_ptr_.store(<br>        ptr, memory_order_release);<br>    }<br>  }<br>  return inst_ptr_;<br>}","like_count":1,"discussions":[{"author":{"id":1645639,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/47/53c48284.jpg","nickname":"å´å’ç‚œ","note":"","ucode":"8C24C10AEC779F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":481217,"discussion_content":"çœ‹å‚è€ƒèµ„æ–™4å§ã€‚å¦‚æœå«Œå¤ªé•¿ï¼Œå°±åªçœ‹ä»£ç ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨çœ¼é‡Œå…è®¸é‡æ’æˆçš„æ ·å­ã€‚\n\nç®€å•è¯´ï¼Œå°±æ˜¯èµ‹å€¼é¡ºåºçš„é—®é¢˜ã€‚è‡³å°‘åœ¨æŸäº›å¤„ç†å™¨ä¸Šï¼Œå…¶ä»–çº¿ç¨‹å¯èƒ½å…ˆçœ‹åˆ° inst_ptr_ è¢«ä¿®æ”¹ï¼Œå†çœ‹åˆ°å•ä»¶çš„æ„é€ å®Œæˆã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578896813,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1304195,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKtlEYuHnR8VdRkNPcmkIqTM9DKahpcpicDdBvcmBWMIAAhBrd0QNWvl09slqrzB5TibryVcIfPmb7Q/132","nickname":"raisecomer","note":"","ucode":"32EA488E46471F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":591933,"discussion_content":"ä¸è¦å±€é™äºC++æºä»£ç çº§ï¼Œè¦ä»æŒ‡ä»¤çº§ä¸Šåˆ†æï¼Œå¦‚æœç¼–è¯‘å™¨åœ¨ç¼–è¯‘æ—¶è¿›è¡Œäº†ä¼˜åŒ–ï¼ŒæŠŠæ„é€ å‡½æ•°å†…è”äº†ï¼Œç»„æˆæ„é€ å‡½æ•°çš„æŒ‡ä»¤å°±æœ‰å¯èƒ½ä¼šå’Œå‘¨è¾¹çš„æŒ‡ä»¤ä¹±åºï¼Œå¯¼è‡´äº†inst_ptr_ å…ˆåˆå§‹åŒ–ï¼Œè€Œå•ä»¶çš„æˆå‘˜è¿˜æ²¡æœ‰åˆå§‹åŒ–å®Œã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1666940919,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"åŒ—äº¬"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1098987,"avatar":"https://static001.geekbang.org/account/avatar/00/10/c4/eb/2285a345.jpg","nickname":"èŠ±æ™¨å°‘å¹´","note":"","ucode":"6AA3537A6BA10E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":132589,"discussion_content":"å—¯ï¼Œå¥½çš„ï¼Œæˆ‘çœ‹çœ‹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578919042,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":170699,"user_name":"ç¦¾æ¡ƒ","can_delete":false,"product_type":"c1","uid":1477855,"ip_address":"","ucode":"9FE85C34A9E9E0","user_header":"https://static001.geekbang.org/account/avatar/00/16/8c/df/77acb793.jpg","comment_is_top":false,"comment_ctime":1578668507,"is_pvip":false,"replies":[{"id":"66172","content":"delayéƒ¨åˆ†å’Œç¬¬äºŒä¸ªé—®é¢˜çš„å›ç­”æ˜¯â€œæ˜¯â€ã€‚<br><br>ç¬¬ä¸€ä¸ªé—®é¢˜ä½ è¿™ä¹ˆè¯´ä¼¼ä¹ä¹Ÿå¯¹ï¼Œä½†è¿™ä¸ªasmè¯­å¥çš„ä¸»è¦ç›®çš„æ˜¯é˜²æ­¢ç¼–è¯‘å™¨åšå‡ºä»»ä½•é‡æ’ï¼Œè€Œæ²¡æœ‰å¯¹å¤„ç†å™¨æå‡ºè¦æ±‚ã€‚ç»“æœæ˜¯ä¼šè·Ÿä½ è¯´çš„ä¸€æ ·ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å´å’ç‚œ","uid":"1645639","ctime":1578721735,"ip_address":"","comment_id":170699,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5873635803","product_id":100040501,"comment_content":"Preshing <br><br>â€œIn particular, each processor is allowed to delay the effect of a store past any load from a different location. â€œ<br><br>è¿™é‡Œçš„â€delayâ€æŒ‡çš„æ˜¯1å·²ç»è¢«å†™åˆ°X_cpu_cache, ä½†æ˜¯è¿˜æ²¡æœ‰æ²¡åˆ°æ¨é€åˆ°X_memeory?<br><br>#1<br>X = 1;<br>asm volatile(&quot;&quot; ::: &quot;memory&quot;);  &#47;&#47; Prevent memory reordering<br>r1 = Y;<br><br>ä¸Šé¢çš„ä»£ç ,èƒ½ç¡®ä¿cpuä¼šå…ˆæ‰§è¡Œstore,ï¼ˆè‡³å°‘å…ˆå†™åˆ°X_cpu_cache,æ— æ³•ä¿è¯1è¢«æ¨é€åˆ°X_memory)ï¼Œç„¶åå†read?<br><br><br>#2<br>X = 1;<br>asm volatile(&quot;mfence&quot; ::: &quot;memory&quot;); <br>r1 = Y;<br><br>ä¸Šé¢çš„ä»£ç ,èƒ½ç¡®ä¿cpuä¼šå…ˆæ‰§è¡Œstoreï¼ˆåŒ…æ‹¬æŠŠ1å†™åˆ°X_cpu_cacheï¼Œå†æ¨é€è‡³X_memoery), ç„¶åå†read?<br><br>ä¸Šé¢çš„ä»£ç ï¼Œcpu æ‰§è¡Œåˆ°mfenceæ—¶ï¼Œä¼šç¡®ä¿1ä»X_cpu_cacheæ¨é€åˆ°X_memory, ç„¶åå†å»è¯»Y?<br><br>è°¢è°¢ï¼","like_count":1,"discussions":[{"author":{"id":1645639,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/47/53c48284.jpg","nickname":"å´å’ç‚œ","note":"","ucode":"8C24C10AEC779F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":481070,"discussion_content":"delayéƒ¨åˆ†å’Œç¬¬äºŒä¸ªé—®é¢˜çš„å›ç­”æ˜¯â€œæ˜¯â€ã€‚\n\nç¬¬ä¸€ä¸ªé—®é¢˜ä½ è¿™ä¹ˆè¯´ä¼¼ä¹ä¹Ÿå¯¹ï¼Œä½†è¿™ä¸ªasmè¯­å¥çš„ä¸»è¦ç›®çš„æ˜¯é˜²æ­¢ç¼–è¯‘å™¨åšå‡ºä»»ä½•é‡æ’ï¼Œè€Œæ²¡æœ‰å¯¹å¤„ç†å™¨æå‡ºè¦æ±‚ã€‚ç»“æœæ˜¯ä¼šè·Ÿä½ è¯´çš„ä¸€æ ·ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578721735,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":343938,"user_name":"raisecomer","can_delete":false,"product_type":"c1","uid":1304195,"ip_address":"","ucode":"32EA488E46471F","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKtlEYuHnR8VdRkNPcmkIqTM9DKahpcpicDdBvcmBWMIAAhBrd0QNWvl09slqrzB5TibryVcIfPmb7Q/132","comment_is_top":false,"comment_ctime":1651130605,"is_pvip":false,"replies":[{"id":"125679","content":"åˆ†æå¾—ä¸é”™ã€‚release è¿™é‡Œä¸å¯ä»¥æ”¹ relaxedã€‚ä¸è¿‡ï¼Œacquire å’Œ release è¿˜æ˜¯é…å¯¹ä½¿ç”¨æ›´æ¸…æ™°ï¼Œä¹Ÿä¸å®¹æ˜“å‡ºé”™ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1645639","ctime":1651411755,"ip_address":"","comment_id":343938,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1651130605","product_id":100040501,"comment_content":"å…³äºå•ä¾‹çš„åŒæ£€æŸ¥é”å®šçš„ä¾‹å­ï¼Œä¸ªäººè®¤ä¸ºinst_ptr_.storeè¿˜æ˜¯åº”è¯¥ä½¿ç”¨releaseè¯­ä¹‰ï¼Œè™½ç„¶å®ƒç¡®å®åœ¨äº’æ–¥é‡çš„ä¿æŠ¤èŒƒå›´å†…ï¼Œäº’æ–¥é‡åªèƒ½ä¿è¯å®ƒä»¥åŠå®ƒå‰é¢çš„æ„é€ å‡½æ•°è°ƒç”¨æ—¶å¯¹å†…å­˜çš„å†™æ“ä½œï¼Œéƒ½åœ¨äº’æ–¥é‡é‡Šæ”¾é”ä¹‹å‰å®Œæˆã€‚ä½†æ˜¯åœ¨ç¬¬19è¡Œè¯»å–inst_ptr_æ—¶å¹¶æ²¡æœ‰äº’æ–¥é‡çš„ä¿æŠ¤ï¼Œæ—¢ç„¶ä¸å—ä¿æŠ¤ï¼Œåˆ«çš„çº¿ç¨‹åœ¨æ­¤å¤„æ˜¯å¯ä»¥ï¼ˆä¸ç»è¿‡äº’æ–¥é‡ï¼‰ç›´æ¥è¯»å–å®ƒçš„ï¼Œä¹Ÿå°±æ²¡æœ‰äº’æ–¥é‡åŠ é”æ—¶çš„acquireå’Œåœ¨29è¡Œäº’æ–¥é‡è§£é”æ—¶çš„releaseå½¢æˆçš„release-acquireè¯­ä¹‰ï¼Œè€Œ26ã€27è¡Œè™½ç„¶éƒ½åœ¨äº’æ–¥é‡çš„ä¿æŠ¤èŒƒå›´å†…ï¼Œå¦‚æœåœ¨27è¡Œä½¿ç”¨relaxedè¯­ä¹‰ï¼Œå¯èƒ½ä¼šé€ æˆ26ã€27è¡Œä¹±åºï¼ˆä¸è¿‡ï¼Œ26ã€27ä¸ç®¡è°å…ˆè°åï¼Œå®ƒä»¬æ•´ä½“éƒ½åœ¨äº’æ–¥é‡é‡Šæ”¾é”ä¹‹å‰å®Œæˆï¼‰ï¼Œé€ æˆåŸå­é‡inst_ptr_è™½ç„¶å·²ç»storeäº†ï¼Œä½†æ˜¯æ„é€ å‡½æ•°æ²¡æœ‰å®Œæˆï¼ˆå½“ç„¶ï¼Œä¸æ˜¯è¡¨é¢ä¸Šçœ‹åˆ°çš„c++è¯­å¥ï¼Œè€Œæ˜¯æŒ‡æ±‡ç¼–æŒ‡ä»¤çº§ä¸Šçš„å†™å†…å­˜ï¼Œå¯èƒ½ä¼˜åŒ–åä¹±åºï¼‰ï¼Œè¿™æ ·å¦ä¸€ä¸ªçº¿ç¨‹åœ¨19è¡Œå¯èƒ½å¾—åˆ°çš„æ˜¯inst_ptr_å·²ç»ä¸ä¸ºnullpträº†ï¼Œä½†å•ä¾‹è¿˜æœªå®Œå…¨åˆå§‹åŒ–çš„å¯¹è±¡å®ä¾‹ã€‚<br>æ°æ°ç›¸åï¼Œå¯ä»¥åœ¨19è¡ŒæŠŠå†…å­˜åºæ”¹ä¸ºmemory_order_relaxedï¼Œå› ä¸ºinst_ptr_åŸå­é‡åœ¨æ­¤å¤„å¹¶æ²¡æœ‰è¦ä¿è¯å…¶å®ƒå†…å­˜è¯»å–æ•°æ®çš„é¡ºåºè¦æ±‚ï¼Œåªè¦å®ƒä¸æ˜¯nullptrï¼Œå°±èƒ½ä¿è¯å•ä¾‹å¯¹è±¡æ„é€ æ—¶çš„å†™å†…å­˜æ“ä½œå·²ç»å®Œæˆï¼Œè¿™æ˜¯ç”±28è¡Œçš„releaseå†…å­˜åºä¿è¯çš„ã€‚","like_count":0,"discussions":[{"author":{"id":1645639,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/47/53c48284.jpg","nickname":"å´å’ç‚œ","note":"","ucode":"8C24C10AEC779F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":569346,"discussion_content":"åˆ†æå¾—ä¸é”™ã€‚release è¿™é‡Œä¸å¯ä»¥æ”¹ relaxedã€‚ä¸è¿‡ï¼Œacquire å’Œ release è¿˜æ˜¯é…å¯¹ä½¿ç”¨æ›´æ¸…æ™°ï¼Œä¹Ÿä¸å®¹æ˜“å‡ºé”™ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1651411755,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":318803,"user_name":"Slience-0Â°C","can_delete":false,"product_type":"c1","uid":1151612,"ip_address":"","ucode":"B50665EC6A80F5","user_header":"https://static001.geekbang.org/account/avatar/00/11/92/7c/12c571b6.jpg","comment_is_top":false,"comment_ctime":1635428597,"is_pvip":false,"replies":[{"id":"115694","content":"åŠ é”å½“ç„¶å¯ä»¥è§£å†³å¤§éƒ¨åˆ†é—®é¢˜ï¼Œä½†æ€§èƒ½å¼€é”€å°±å¤§äº†ã€‚<br><br>äº‹å®ä¸Šï¼ŒåŠ é”åœ¨åº•å±‚ä¹Ÿæ˜¯ä¼šä½¿ç”¨åŸå­æ“ä½œçš„ï¼Œå¹¶ä¸”åœ¨äº§ç”Ÿå†²çªçš„æ—¶å€™é˜»å¡ç¨‹åºæ‰§è¡Œã€‚ä¸åŠ é”æŒ‡ä»¤æ¯”è¾ƒå°‘ï¼Œå¼€é”€æ›´ä½ï¼Œå¹¶åœ¨ç®€å•çš„ç±»ä¼¼åŠ ä¸€ã€å‡ä¸€çš„æ“ä½œæ—¶ä¸ä¼šé˜»å¡ã€‚å½“ç„¶ï¼Œå¦‚æœç”¨åŸå­æ“ä½œå®ç°è‡ªæ—‹é”ä¹‹ç±»çš„æ“ä½œï¼Œå°±éœ€è¦è®¤çœŸè€ƒè™‘æ˜¯ä¸æ˜¯ç”¨åŸå­æ“ä½œä¸€å®šèƒ½å¸¦æ¥æ€§èƒ½ä¸Šçš„æé«˜äº†ï¼šåŸå­æ“ä½œç¼–ç¨‹æ›´ä¸ºå¤æ‚ï¼Œè€Œä¸”ç°ä»£çš„ mutex å®ç°æ€§èƒ½å·²ç»éå¸¸é«˜äº†ï¼ˆå–å†³äºæ“ä½œç³»ç»Ÿï¼Œè¾ƒæ–°çš„ä¸€èˆ¬éƒ½å®ç°å¾—æ¯”è¾ƒå¥½ï¼‰ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å´å’ç‚œ","uid":"1645639","ctime":1635642502,"ip_address":"","comment_id":318803,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1635428597","product_id":100040501,"comment_content":"æœ€å¼€å§‹çš„é—®é¢˜ï¼Œå¯¹x,yåŠ é”ï¼Œä¸å°±èƒ½å®ç°æƒ³è¦çš„ç»“æœäº†ä¹ˆï¼Ÿå½“ç„¶åŠ é”è‚¯å®šæœ‰æŸè€—ï¼Œå†…å­˜æ¨¡å‹ï¼Œä¸€ç›´æ²¡æœ‰ç†è§£ä¸ºäº†è§£å†³ä»€ä¹ˆé—®é¢˜","like_count":0,"discussions":[{"author":{"id":1645639,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/47/53c48284.jpg","nickname":"å´å’ç‚œ","note":"","ucode":"8C24C10AEC779F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":529381,"discussion_content":"åŠ é”å½“ç„¶å¯ä»¥è§£å†³å¤§éƒ¨åˆ†é—®é¢˜ï¼Œä½†æ€§èƒ½å¼€é”€å°±å¤§äº†ã€‚\n\näº‹å®ä¸Šï¼ŒåŠ é”åœ¨åº•å±‚ä¹Ÿæ˜¯ä¼šä½¿ç”¨åŸå­æ“ä½œçš„ï¼Œå¹¶ä¸”åœ¨äº§ç”Ÿå†²çªçš„æ—¶å€™é˜»å¡ç¨‹åºæ‰§è¡Œã€‚ä¸åŠ é”æŒ‡ä»¤æ¯”è¾ƒå°‘ï¼Œå¼€é”€æ›´ä½ï¼Œå¹¶åœ¨ç®€å•çš„ç±»ä¼¼åŠ ä¸€ã€å‡ä¸€çš„æ“ä½œæ—¶ä¸ä¼šé˜»å¡ã€‚å½“ç„¶ï¼Œå¦‚æœç”¨åŸå­æ“ä½œå®ç°è‡ªæ—‹é”ä¹‹ç±»çš„æ“ä½œï¼Œå°±éœ€è¦è®¤çœŸè€ƒè™‘æ˜¯ä¸æ˜¯ç”¨åŸå­æ“ä½œä¸€å®šèƒ½å¸¦æ¥æ€§èƒ½ä¸Šçš„æé«˜äº†ï¼šåŸå­æ“ä½œç¼–ç¨‹æ›´ä¸ºå¤æ‚ï¼Œè€Œä¸”ç°ä»£çš„ mutex å®ç°æ€§èƒ½å·²ç»éå¸¸é«˜äº†ï¼ˆå–å†³äºæ“ä½œç³»ç»Ÿï¼Œè¾ƒæ–°çš„ä¸€èˆ¬éƒ½å®ç°å¾—æ¯”è¾ƒå¥½ï¼‰ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635642502,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":300471,"user_name":"Geek_64affe","can_delete":false,"product_type":"c1","uid":2415213,"ip_address":"","ucode":"17F255ACC29717","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epWuRmpg9jWibtRH3mO9I0Sc9Y86fJpiaJDdLia39eib89R1raTkxMg9AOkjb0OTRkmXiaialJgHC5ve59g/132","comment_is_top":false,"comment_ctime":1625187436,"is_pvip":false,"replies":[{"id":"108918","content":"é€»è¾‘æ˜¯éœ€è¦ä»£ç æœ¬èº«æ¥ä¿è¯çš„ã€‚æˆ‘è¿™å„¿çš„ä»£ç ä¸ä¼šäº§ç”Ÿè¿™æ ·çš„æƒ…å†µã€‚è¿™å„¿ä¸»è¦è¯´æ˜çš„æ˜¯å¯èƒ½ä¼šè®©å³ä½¿è€ƒè™‘äº†å¤šçº¿ç¨‹æƒ…å†µçš„ç¨‹åºå‘˜éƒ½ä¼šæƒŠè®¶çš„é—®é¢˜â€”â€”ä¹±åºã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å´å’ç‚œ","uid":"1645639","ctime":1625272526,"ip_address":"","comment_id":300471,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1625187436","product_id":100040501,"comment_content":"è€å¸ˆï¼Œæœ‰ä¸ªç–‘é—®<br><br>1. if (y.load(memory_order_acquire) ==<br>    2) {<br>2.   x = 3;<br>3.   y.store(4, memory_order_relaxed);<br>4. }<br><br>å¦‚æœå…¶ä»–çº¿ç¨‹åœ¨ ç¬¬2è¡Œ æˆ–è€… ç¬¬3è¡ŒæœŸé—´ ä¿®æ”¹äº† y çš„å€¼ï¼Œé€»è¾‘ä¸å°±å‡ºé”™äº†å—","like_count":0,"discussions":[{"author":{"id":1645639,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/47/53c48284.jpg","nickname":"å´å’ç‚œ","note":"","ucode":"8C24C10AEC779F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":522743,"discussion_content":"é€»è¾‘æ˜¯éœ€è¦ä»£ç æœ¬èº«æ¥ä¿è¯çš„ã€‚æˆ‘è¿™å„¿çš„ä»£ç ä¸ä¼šäº§ç”Ÿè¿™æ ·çš„æƒ…å†µã€‚è¿™å„¿ä¸»è¦è¯´æ˜çš„æ˜¯å¯èƒ½ä¼šè®©å³ä½¿è€ƒè™‘äº†å¤šçº¿ç¨‹æƒ…å†µçš„ç¨‹åºå‘˜éƒ½ä¼šæƒŠè®¶çš„é—®é¢˜â€”â€”ä¹±åºã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625272526,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":273282,"user_name":"Dooms","can_delete":false,"product_type":"c1","uid":1211011,"ip_address":"","ucode":"DA12C8BEDF7602","user_header":"https://static001.geekbang.org/account/avatar/00/12/7a/83/b62508b4.jpg","comment_is_top":false,"comment_ctime":1610522848,"is_pvip":false,"replies":[{"id":"99055","content":"ä½ å¯ä»¥åœ¨godbolt.orgä¸Šæ£€æŸ¥ç”Ÿæˆçš„æ±‡ç¼–ã€‚<br><br>æ ¹æ®å…·ä½“çš„æ“ä½œã€å†…å­˜åºè¦æ±‚å’Œæ¶æ„ï¼Œæœ‰äº›æƒ…å†µä¸‹å°±æ˜¯ç®€å•çš„ç§»åŠ¨æŒ‡ä»¤ï¼Œæœ‰äº›ä¼šä½¿ç”¨lockå‰ç¼€ï¼Œæœ‰äº›ä¼šæ’å…¥å†…å­˜å±éšœæŒ‡ä»¤ï¼Œç­‰ç­‰ã€‚åŸå­é‡çš„æ„ä¹‰å°±æ˜¯è¦å±è”½å¹³å°å·®å¼‚ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å´å’ç‚œ","uid":"1645639","ctime":1610583339,"ip_address":"","comment_id":273282,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1610522848","product_id":100040501,"comment_content":"#include &lt;thread&gt;<br>#include &lt;iostream&gt;<br>#include &lt;atomic&gt;<br><br>int x = 0;<br>std::atomic&lt;int&gt; y;<br><br>void a()<br>{<br>    x = 1;<br>    y.store(2, std::memory_order_release);<br>    &#47;&#47; ä¿è¯x = 1çš„å†™æ“ä½œ, ä¸ä¼šå› ä¸ºæŒ‡ä»¤é‡æ’, å¯¼è‡´å‡ºç°åœ¨yèµ‹å€¼çš„åæ‰§è¡Œ. <br>    x = 2;<br>    y.store(3, std::memory_order_release);<br>}<br><br>void b()<br>{<br>    &#47;&#47; ä¿è¯yè¯»æ“ä½œ, åç»­çš„è¯»å†™æ“ä½œéƒ½ä¸ä¼šé‡æ’åˆ°è¿™ä¸ªæŒ‡ä»¤ä¹‹å‰.<br>    &#47;&#47; å¹¶ä¸”çº¿ç¨‹aä¸­yçš„é‡Šæ”¾(å†™å…¥), å¯¹å†…å­˜çš„ä¿®æ”¹, åœ¨bçº¿ç¨‹çš„è·å–(è¯»å–)æ“ä½œæ˜¯å¿…å®šå¯è§çš„, <br>    &#47;&#47; å°±æ˜¯è¯´aåªè¦åœ¨æ‰§è¡Œyå†™å…¥å, bçº¿ç¨‹æ‰§è¡Œåˆ°yè¯»å–çš„æ—¶å€™, ä¸€å®šä¼šè¯»å–åˆ°açº¿ç¨‹å†™å…¥çš„å€¼.  å½“è¯»å–åˆ° y = 2 çš„æ—¶å€™, x çš„æ˜¯ 1 è¿˜æ˜¯ 2 å‘¢? <br>    if (y.load(std::memory_order_acquire) == 2)<br>    {<br>        printf(&quot;%d %d\\n&quot;, x, y.load(std::memory_order_acquire)); &#47;&#47; è¿™é‡Œè¯»å–åˆ°çš„æ˜¯ x = 2, y = 3 æœ‰æ²¡å¯èƒ½x = 2, y = 2 æˆ–è€… x = 1, y = 2 ?? è¿˜æ˜¯è¯´è¿™ä¸ªå…·ä½“çš„å€¼æ˜¯ä¸ç¡®å®šçš„ ??<br>        x = 3;<br>        y.store(4, std::memory_order_relaxed);<br>    }<br>}<br><br>int main()<br>{<br>    y = 0;<br>    std::thread t1(a);<br>    std::thread t2(b);<br>    t1.detach();<br>    t2.detach();<br>    std::this_thread::sleep_for(std::chrono::microseconds(1500));<br>    printf(&quot;%d %d\\n&quot;, x, y.load(std::memory_order_acquire));<br>    return 0;<br>}<br><br>std::atomic çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆ? å†…å­˜å±éšœæŒ‡ä»¤å—?","like_count":0,"discussions":[{"author":{"id":1645639,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/47/53c48284.jpg","nickname":"å´å’ç‚œ","note":"","ucode":"8C24C10AEC779F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":513554,"discussion_content":"ä½ å¯ä»¥åœ¨godbolt.orgä¸Šæ£€æŸ¥ç”Ÿæˆçš„æ±‡ç¼–ã€‚\n\næ ¹æ®å…·ä½“çš„æ“ä½œã€å†…å­˜åºè¦æ±‚å’Œæ¶æ„ï¼Œæœ‰äº›æƒ…å†µä¸‹å°±æ˜¯ç®€å•çš„ç§»åŠ¨æŒ‡ä»¤ï¼Œæœ‰äº›ä¼šä½¿ç”¨lockå‰ç¼€ï¼Œæœ‰äº›ä¼šæ’å…¥å†…å­˜å±éšœæŒ‡ä»¤ï¼Œç­‰ç­‰ã€‚åŸå­é‡çš„æ„ä¹‰å°±æ˜¯è¦å±è”½å¹³å°å·®å¼‚ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1610583339,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":250883,"user_name":"é²Â·æœ¬","can_delete":false,"product_type":"c1","uid":1209939,"ip_address":"","ucode":"F1DEB30C21B48E","user_header":"https://static001.geekbang.org/account/avatar/00/12/76/53/21d62a23.jpg","comment_is_top":false,"comment_ctime":1601271180,"is_pvip":false,"replies":[{"id":"91849","content":"â€œload å–å‡ºçš„æŒ‡é’ˆ,ç›´æ¥ä¿®æ”¹æŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡çš„å†…å®¹,ä¸è°ƒç”¨store,å…¶ä»–çº¿ç¨‹ä¹Ÿèƒ½çœ‹åˆ°ä¿®æ”¹çš„â€<br><br>åŸå­å¯¹è±¡æ˜¯ä¸ºäº†ä¿è¯æ— è®ºåœ¨ä»€ä¹ˆæ¶æ„ä¸‹å’Œå¼€å¯äº†ä»€ä¹ˆç¨‹åº¦çš„ä¼˜åŒ–ï¼Œä»£ç éƒ½å¯ä»¥æ­£å¸¸å·¥ä½œã€‚è€Œä¸æ˜¯è¯´ï¼Œä½ ä¸è¿™ä¹ˆå†™ï¼Œå°±ä¸€å®šä¸èƒ½æ­£å¸¸å·¥ä½œã€‚åŸå­ã€åŠ é”ä¸æ­£ç¡®æ—¶ï¼Œæœ‰å¯èƒ½åœ¨å¼€å‘æœºä¸Šï¼Œæˆ–è€…å¤§éƒ¨åˆ†æƒ…å†µä¸‹ä»£ç æ˜¯æ­£å¸¸çš„ï¼Œä½†åœ¨é«˜å¹¶å‘æƒ…å†µä¸‹ï¼Œæˆ–è€…åœ¨ä¸åŒçš„ç¡¬ä»¶ç¯å¢ƒä¸‹ï¼Œæˆ–è€…ä¸åŒçš„ç¼–è¯‘å™¨é€‰é¡¹ä¸‹ï¼Œä»£ç å°±ä¼šå‡ºé”™ã€‚<br><br>â€œè¦æ€ä¹ˆå¯¹åŸå­å¯¹è±¡è¿›è¡ŒåŸå­ä¿®æ”¹å‘¢ï¼Ÿâ€<br><br>å¦‚æœä½ æŒ‡çš„æ˜¯ä»£ç ä¸­çš„ Serverï¼Œå®ƒä¸æ˜¯ä¸€ä¸ªåŸå­å¯¹è±¡â€”â€”ä½ åªå®šä¹‰äº† Server* ä½œä¸ºåŸå­å¯¹è±¡ã€‚ä¿®æ”¹ä¸€ä¸ª int å€¼ï¼Œåœ¨ç»å¤§å¤šæ•°å¹³å°ä¸Šä¹Ÿæ˜¯ä¸éœ€è¦åŠ é”çš„ã€‚æˆ‘ä¸å¤ªçœ‹å¾—å‡ºä½ çš„ä»£ç çš„ç”¨æ„ï¼Œä½†ä¸€èˆ¬çš„å¹¶å‘ä»£ç é‡Œæ˜¯ä¸å»ºè®®å»ç›´æ¥æ”¹ä½ çš„ pS æŒ‡å‘çš„å†…å®¹ã€‚æ›´å¸¸è§„çš„åšæ³•æ˜¯ç”Ÿæˆæ–°çš„ï¼Œç„¶åä½¿ç”¨äº¤æ¢çš„æ“ä½œå»å°è¯•ä¿®æ”¹ã€‚ä½ éœ€è¦ä¸€ä¸ªæ›´çœŸå®çš„ä¾‹å­æ‰èƒ½è®©ä½ çš„ä»£ç æ›´æœ‰æ„ä¹‰ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å´å’ç‚œ","uid":"1645639","ctime":1601392213,"ip_address":"","comment_id":250883,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1601271180","product_id":100040501,"comment_content":"#include &lt;thread&gt;<br>#include &lt;atomic&gt;<br>#include &lt;cassert&gt;<br>#include &lt;string&gt;<br>#include &lt;iostream&gt;<br>#include &lt;unistd.h&gt;<br><br>struct ServerT<br>{<br>    int id;<br>    int port;<br>};<br>typedef struct ServerT serverT;<br><br>std::atomic&lt;ServerT*&gt; ptr;<br><br>void set()<br>{<br>    ServerT* pS  = new serverT;<br><br>    ptr.store(pS, std::memory_order_release);<br>    std::cout &lt;&lt; std::this_thread::get_id() &lt;&lt; &quot; &quot; &lt;&lt;  __FUNCTION__ &lt;&lt; &quot; 1 port:&quot; &lt;&lt; pS-&gt;port &lt;&lt; std::endl;<br>    pS-&gt;port = 2345;<br>    std::cout &lt;&lt; std::this_thread::get_id() &lt;&lt; &quot; &quot; &lt;&lt;  __FUNCTION__ &lt;&lt; &quot; 2 port:&quot; &lt;&lt; pS-&gt;port &lt;&lt; std::endl;<br>}<br><br>void get()<br>{<br>    ServerT* pS = nullptr;<br>    while (!(pS = ptr.load(std::memory_order_acquire)));<br>    std::cout &lt;&lt; std::this_thread::get_id() &lt;&lt; &quot; &quot; &lt;&lt;  __FUNCTION__ &lt;&lt; &quot; 1 port:&quot; &lt;&lt; pS-&gt;port &lt;&lt; std::endl;<br>    pS-&gt;port = 4567;<br>    std::cout &lt;&lt; std::this_thread::get_id() &lt;&lt; &quot; &quot; &lt;&lt;  __FUNCTION__ &lt;&lt; &quot; 2 port:&quot; &lt;&lt; pS-&gt;port &lt;&lt; std::endl;<br>}<br><br>int main()<br>{<br>    std::thread t1(set);<br>    sleep(1);<br>    std::thread t2(get);<br>    sleep(2);<br>    std::thread t3(get);<br>    t1.join();<br>    t2.join();<br>    t3.join();<br>}<br><br>è¿è¡Œç»“æœ:<br><br>140388121650944 set 1 port:0<br>140388121650944 set 2 port:2345<br>140388111161088 get 1 port:2345<br>140388111161088 get 2 port:4567<br>140388100671232 get 1 port:4567<br>140388100671232 get 2 port:4567<br><br>è€å¸ˆ,æ‚¨çœ‹è¿™ä¸ªä¾‹å­,load å–å‡ºçš„æŒ‡é’ˆ,ç›´æ¥ä¿®æ”¹æŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡çš„å†…å®¹,ä¸è°ƒç”¨store,å…¶ä»–çº¿ç¨‹ä¹Ÿèƒ½çœ‹åˆ°ä¿®æ”¹çš„, é‚£ä¹ˆè¿™ç§æƒ…å†µ, è¦æ€ä¹ˆå¯¹åŸå­å¯¹è±¡è¿›è¡ŒåŸå­ä¿®æ”¹å‘¢? éš¾é“è¦åœ¨ä¿®æ”¹çš„åœ°æ–¹åŠ ä¸Šäº’æ–¥é”?","like_count":0,"discussions":[{"author":{"id":1645639,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/47/53c48284.jpg","nickname":"å´å’ç‚œ","note":"","ucode":"8C24C10AEC779F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":506325,"discussion_content":"â€œload å–å‡ºçš„æŒ‡é’ˆ,ç›´æ¥ä¿®æ”¹æŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡çš„å†…å®¹,ä¸è°ƒç”¨store,å…¶ä»–çº¿ç¨‹ä¹Ÿèƒ½çœ‹åˆ°ä¿®æ”¹çš„â€\n\nåŸå­å¯¹è±¡æ˜¯ä¸ºäº†ä¿è¯æ— è®ºåœ¨ä»€ä¹ˆæ¶æ„ä¸‹å’Œå¼€å¯äº†ä»€ä¹ˆç¨‹åº¦çš„ä¼˜åŒ–ï¼Œä»£ç éƒ½å¯ä»¥æ­£å¸¸å·¥ä½œã€‚è€Œä¸æ˜¯è¯´ï¼Œä½ ä¸è¿™ä¹ˆå†™ï¼Œå°±ä¸€å®šä¸èƒ½æ­£å¸¸å·¥ä½œã€‚åŸå­ã€åŠ é”ä¸æ­£ç¡®æ—¶ï¼Œæœ‰å¯èƒ½åœ¨å¼€å‘æœºä¸Šï¼Œæˆ–è€…å¤§éƒ¨åˆ†æƒ…å†µä¸‹ä»£ç æ˜¯æ­£å¸¸çš„ï¼Œä½†åœ¨é«˜å¹¶å‘æƒ…å†µä¸‹ï¼Œæˆ–è€…åœ¨ä¸åŒçš„ç¡¬ä»¶ç¯å¢ƒä¸‹ï¼Œæˆ–è€…ä¸åŒçš„ç¼–è¯‘å™¨é€‰é¡¹ä¸‹ï¼Œä»£ç å°±ä¼šå‡ºé”™ã€‚\n\nâ€œè¦æ€ä¹ˆå¯¹åŸå­å¯¹è±¡è¿›è¡ŒåŸå­ä¿®æ”¹å‘¢ï¼Ÿâ€\n\nå¦‚æœä½ æŒ‡çš„æ˜¯ä»£ç ä¸­çš„ Serverï¼Œå®ƒä¸æ˜¯ä¸€ä¸ªåŸå­å¯¹è±¡â€”â€”ä½ åªå®šä¹‰äº† Server* ä½œä¸ºåŸå­å¯¹è±¡ã€‚ä¿®æ”¹ä¸€ä¸ª int å€¼ï¼Œåœ¨ç»å¤§å¤šæ•°å¹³å°ä¸Šä¹Ÿæ˜¯ä¸éœ€è¦åŠ é”çš„ã€‚æˆ‘ä¸å¤ªçœ‹å¾—å‡ºä½ çš„ä»£ç çš„ç”¨æ„ï¼Œä½†ä¸€èˆ¬çš„å¹¶å‘ä»£ç é‡Œæ˜¯ä¸å»ºè®®å»ç›´æ¥æ”¹ä½ çš„ pS æŒ‡å‘çš„å†…å®¹ã€‚æ›´å¸¸è§„çš„åšæ³•æ˜¯ç”Ÿæˆæ–°çš„ï¼Œç„¶åä½¿ç”¨äº¤æ¢çš„æ“ä½œå»å°è¯•ä¿®æ”¹ã€‚ä½ éœ€è¦ä¸€ä¸ªæ›´çœŸå®çš„ä¾‹å­æ‰èƒ½è®©ä½ çš„ä»£ç æ›´æœ‰æ„ä¹‰ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1601392213,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":250747,"user_name":"é²Â·æœ¬","can_delete":false,"product_type":"c1","uid":1209939,"ip_address":"","ucode":"F1DEB30C21B48E","user_header":"https://static001.geekbang.org/account/avatar/00/12/76/53/21d62a23.jpg","comment_is_top":false,"comment_ctime":1601208988,"is_pvip":false,"replies":[{"id":"91761","content":"loadè¿”å›çš„ä¸æ˜¯åœ°å€ï¼Œæ˜¯å®é™…çš„æ•°å€¼ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å´å’ç‚œ","uid":"1645639","ctime":1601223810,"ip_address":"","comment_id":250747,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1601208988","product_id":100040501,"comment_content":"è€å¸ˆloadè¿”å›çš„æŒ‡é’ˆæ˜¯åŸå§‹å†…å­˜åœ°å€ï¼Œè¿˜æ˜¯å‰¯æœ¬åœ°å€ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1645639,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/47/53c48284.jpg","nickname":"å´å’ç‚œ","note":"","ucode":"8C24C10AEC779F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":506276,"discussion_content":"loadè¿”å›çš„ä¸æ˜¯åœ°å€ï¼Œæ˜¯å®é™…çš„æ•°å€¼ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1601223810,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":247775,"user_name":"ç‹å¤§ä¸º","can_delete":false,"product_type":"c1","uid":1248950,"ip_address":"","ucode":"E182E280C82431","user_header":"https://static001.geekbang.org/account/avatar/00/13/0e/b6/37b19725.jpg","comment_is_top":false,"comment_ctime":1599833647,"is_pvip":false,"replies":[{"id":"90991","content":"æ–‡ä¸­æˆ‘å·²ç»å†™äº†ï¼š<br><br>ã€Œåœ¨çº¿ç¨‹ 2 æˆ‘ä»¬å¯¹ y çš„è¯»å–åº”å½“ä½¿ç”¨è·å¾—è¯­ä¹‰ï¼Œä½†å­˜å‚¨åªéœ€è¦æ¾æ•£å†…å­˜åºå³å¯ã€<br><br>è¿™å„¿æ²¡æœ‰ä½¿ç”¨é‡Šæ”¾è¯­ä¹‰çš„å¿…è¦ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å´å’ç‚œ","uid":"1645639","ctime":1599835989,"ip_address":"","comment_id":247775,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1599833647","product_id":100040501,"comment_content":"y.store(4, memory_order_relaxed);<br>åº”è¯¥æ˜¯releasedå§ï¼ŸæŸæ®µä»£ç ç¬¬4è¡Œ","like_count":1,"discussions":[{"author":{"id":1645639,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/47/53c48284.jpg","nickname":"å´å’ç‚œ","note":"","ucode":"8C24C10AEC779F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":505492,"discussion_content":"æ–‡ä¸­æˆ‘å·²ç»å†™äº†ï¼š\n\nã€Œåœ¨çº¿ç¨‹ 2 æˆ‘ä»¬å¯¹ y çš„è¯»å–åº”å½“ä½¿ç”¨è·å¾—è¯­ä¹‰ï¼Œä½†å­˜å‚¨åªéœ€è¦æ¾æ•£å†…å­˜åºå³å¯ã€\n\nè¿™å„¿æ²¡æœ‰ä½¿ç”¨é‡Šæ”¾è¯­ä¹‰çš„å¿…è¦ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599835989,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":171224,"user_name":"èŠ±æ™¨å°‘å¹´","can_delete":false,"product_type":"c1","uid":1098987,"ip_address":"","ucode":"6AA3537A6BA10E","user_header":"https://static001.geekbang.org/account/avatar/00/10/c4/eb/2285a345.jpg","comment_is_top":false,"comment_ctime":1578883958,"is_pvip":false,"replies":[{"id":"66408","content":"memory_order_seq_cst ä¸æ˜¯æ‹¿æ¥å’Œ memory_order_acq_rel å¯¹æ¯”çš„ï¼Œè€Œæ˜¯å’Œ memory_order_relaxed å¯¹æ¯”çš„ã€‚æ­£å¦‚æˆ‘åœ¨å¦å¤–ä¸€ä¸ªå›ç­”é‡Œè¯´çš„ï¼Œè¿™é‡Œä½¿ç”¨ memory_order_acq_rel å¯èƒ½æ˜¯éæ³•çš„ã€‚æ¯”å¦‚ loadï¼Œåªèƒ½ä½¿ç”¨ relaxedã€acquire å’Œ seq_cstï¼Œå¹¶ä¸”åä¸¤è€…æ˜¯ç­‰ä»·çš„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å´å’ç‚œ","uid":"1645639","ctime":1578897022,"ip_address":"","comment_id":171224,"utype":1}],"discussion_count":3,"race_medal":0,"score":"1578883958","product_id":100040501,"comment_content":"https:&#47;&#47;en.cppreference.com&#47;w&#47;cpp&#47;atomic&#47;memory_orderæœ€åä¸€æ®µè®²è§£<br>memory_order_seq_cstæåˆ°ï¼Œå¦‚æœè¦ä¿è¯æœ€åçš„æ–­è¨€&quot;assert(z.load() != 0);&quot;ä¸ä¼šå‘ç”Ÿï¼Œå¿…é¡»ä½¿ç”¨<br>memory_order_seq_cstï¼Œè¿™é‡Œå¾ˆä¸ç†è§£ã€‚<br>ä¸‹é¢æ˜¯ä»£ç <br><br>#include &lt;thread&gt;<br>#include &lt;atomic&gt;<br>#include &lt;cassert&gt;<br> <br>std::atomic&lt;bool&gt; x = {false};<br>std::atomic&lt;bool&gt; y = {false};<br>std::atomic&lt;int&gt; z = {0};<br> <br>void write_x()<br>{<br>    x.store(true, std::memory_order_seq_cst);<br>}<br> <br>void write_y()<br>{<br>    y.store(true, std::memory_order_seq_cst);<br>}<br> <br>void read_x_then_y()<br>{<br>    while (!x.load(std::memory_order_seq_cst))&#47;&#47;@1<br>        ;<br>    if (y.load(std::memory_order_seq_cst)) {&#47;&#47;@2<br>        ++z;<br>    }<br>}<br> <br>void read_y_then_x()<br>{<br>    while (!y.load(std::memory_order_seq_cst))<br>        ;&#47;&#47;@3<br>    if (x.load(std::memory_order_seq_cst)) {&#47;&#47;@4<br>        ++z;<br>    }<br>}<br> <br>int main()<br>{<br>    std::thread a(write_x);<br>    std::thread b(write_y);<br>    std::thread c(read_x_then_y);<br>    std::thread d(read_y_then_x);<br>    a.join(); b.join(); c.join(); d.join();<br>    assert(z.load() != 0);  &#47;&#47; will never happen<br>}<br><br>æŠŠä»£ç å…¨éƒ¨æ”¹æˆmemory_order_acq_relæ“ä½œä¸ºä»€ä¹ˆä¸å¯ä»¥?<br>æŒ‰ç…§memory_order_acq_relçš„æè¿°ï¼Œåœ¨å…¶ä»–çº¿ç¨‹ä¸­,@2çš„æ‰€æœ‰æ“ä½œåº”è¯¥éƒ½ä¸ä¼šè¢«é‡æ’åˆ°@1ä¹‹å‰ï¼Œ<br>@4çš„æ“ä½œä¹Ÿä¸ä¼šè¢«é‡æ’åˆ°@3ä¹‹å‰ï¼Œ<br>é‚£å¦‚æœæ˜¯è¿™æ ·çš„è¯ï¼Œä¹Ÿèƒ½ç¡®ä¿æ–­è¨€æ°¸è¿œä¸ä¼šå‘ç”Ÿã€‚<br>","like_count":0,"discussions":[{"author":{"id":1645639,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/47/53c48284.jpg","nickname":"å´å’ç‚œ","note":"","ucode":"8C24C10AEC779F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":481266,"discussion_content":"memory_order_seq_cst ä¸æ˜¯æ‹¿æ¥å’Œ memory_order_acq_rel å¯¹æ¯”çš„ï¼Œè€Œæ˜¯å’Œ memory_order_relaxed å¯¹æ¯”çš„ã€‚æ­£å¦‚æˆ‘åœ¨å¦å¤–ä¸€ä¸ªå›ç­”é‡Œè¯´çš„ï¼Œè¿™é‡Œä½¿ç”¨ memory_order_acq_rel å¯èƒ½æ˜¯éæ³•çš„ã€‚æ¯”å¦‚ loadï¼Œåªèƒ½ä½¿ç”¨ relaxedã€acquire å’Œ seq_cstï¼Œå¹¶ä¸”åä¸¤è€…æ˜¯ç­‰ä»·çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578897022,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1098987,"avatar":"https://static001.geekbang.org/account/avatar/00/10/c4/eb/2285a345.jpg","nickname":"èŠ±æ™¨å°‘å¹´","note":"","ucode":"6AA3537A6BA10E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":132588,"discussion_content":"å—¯ï¼Œä¸ä½¿ç”¨memory_order_acq_relï¼Œå°±ä½¿ç”¨æ™®é€šçš„acqå’Œrelæ›¿æ¢æ‰memory_order_acq_relï¼Œä¸ºä»€ä¹ˆä¼šæœ‰é—®é¢˜ï¼Œè€å¸ˆèƒ½ç»™è®²è§£ä¸‹å—ï¼Œæƒ³ä¸æ˜ç™½\nä»£ç å¦‚ä¸‹æ‰€ç¤º,æ–­è¨€è¿˜æ˜¯ä¼šæ‰§è¡Œã€‚\n\nstd::atomic<bool> x = {false};\nstd::atomic<bool> y = {false};\nstd::atomic<int> z = {0};\n \nvoid write_x()\n{\n    x.store(true, std:: memory_order_release);\n}\n \nvoid write_y()\n{\n    y.store(true, std:: memory_order_release);\n}\n \nvoid read_x_then_y()\n{\n    while (!x.load(std:: memory_order_acquire))\n        ;\n    if (y.load(std:: memory_order_acquire)) {\n        ++z;\n    }\n}\n \nvoid read_y_then_x()\n{\n    while (!y.load(std:: memory_order_acquire))\n        ;\n    if (x.load(std:: memory_order_acquire)) {\n        ++z;\n    }\n}\n \nint main()\n{\n    std::thread a(write_x);\n    std::thread b(write_y);\n    std::thread c(read_x_then_y);\n    std::thread d(read_y_then_x);\n    a.join(); b.join(); c.join(); d.join();\n    assert(z.load() != 0);  // will never happen\n}","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578919022,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1645639,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/47/53c48284.jpg","nickname":"å´å’ç‚œ","note":"","ucode":"8C24C10AEC779F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":1098987,"avatar":"https://static001.geekbang.org/account/avatar/00/10/c4/eb/2285a345.jpg","nickname":"èŠ±æ™¨å°‘å¹´","note":"","ucode":"6AA3537A6BA10E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":136558,"discussion_content":"æ²¡æœ‰é—®é¢˜ã€‚sequential ordering is necessaryï¼Œä¸ç­‰äºä¸€å®šè¦å†™ seq_cstã€‚seq_cst æœ¬æ¥åœ¨ load æ—¶å°±ç­‰ä»·äº acquire çš„ï¼Œç­‰ç­‰ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579148497,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":132588,"ip_address":""},"score":136558,"extra":""}]}]},{"had_liked":false,"id":171046,"user_name":"ç¦¾æ¡ƒ","can_delete":false,"product_type":"c1","uid":1477855,"ip_address":"","ucode":"9FE85C34A9E9E0","user_header":"https://static001.geekbang.org/account/avatar/00/16/8c/df/77acb793.jpg","comment_is_top":false,"comment_ctime":1578831869,"is_pvip":false,"replies":[{"id":"66400","content":"å¥½é—®é¢˜ã€‚è¿™ä¸ªé—®é¢˜æˆ‘ä¹‹å‰æ²¡ç»†ç©¶ï¼Œä½†ç°åœ¨ä»”ç»†ä¸€çœ‹ï¼Œå¸¸è§æ¶æ„ä¸Šå†…å­˜åºå‚æ•°å¯¹ fetch_add æ˜¯æ²¡å½±å“çš„â€¦â€¦ä¼¼ä¹è¯»-ä¿®æ”¹-å†™æ“ä½œé‡Œï¼Œä¸€èˆ¬éƒ½æ˜¯å®ç°æˆé¡ºåºä¸€è‡´çš„ã€‚<br><br>ä¹Ÿæœ‰ä¾‹å¤–ï¼Œå¦‚ Powerã€Raspbian Busterã€RISC-Vï¼š<br><br>https:&#47;&#47;godbolt.org&#47;z&#47;Du85RX","user_name":"ä½œè€…å›å¤","user_name_real":"å´å’ç‚œ","uid":"1645639","ctime":1578895897,"ip_address":"","comment_id":171046,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1578831869","product_id":100040501,"comment_content":"<br>  void add_count() noexcept<br>  {<br>    count_.fetch_add(<br>      1, std::memory_order_relaxed);<br>  }<br><br>  void add_count() noexcept<br>  {<br>    count_.fetch_add(<br>      1, std::memory_order_seq_cst);<br>  }<br><br><br>std::memory_order_seq_cst æ¯”std::memory_order_relaxedï¼Œ<br>æ€§èƒ½æ–¹é¢çš„æµªè´¹ï¼Œå…·ä½“æŒ‡çš„æ˜¯ä»€ä¹ˆï¼Ÿ<br><br>è°¢è°¢ï¼","like_count":0,"discussions":[{"author":{"id":1645639,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/47/53c48284.jpg","nickname":"å´å’ç‚œ","note":"","ucode":"8C24C10AEC779F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":481218,"discussion_content":"å¥½é—®é¢˜ã€‚è¿™ä¸ªé—®é¢˜æˆ‘ä¹‹å‰æ²¡ç»†ç©¶ï¼Œä½†ç°åœ¨ä»”ç»†ä¸€çœ‹ï¼Œå¸¸è§æ¶æ„ä¸Šå†…å­˜åºå‚æ•°å¯¹ fetch_add æ˜¯æ²¡å½±å“çš„â€¦â€¦ä¼¼ä¹è¯»-ä¿®æ”¹-å†™æ“ä½œé‡Œï¼Œä¸€èˆ¬éƒ½æ˜¯å®ç°æˆé¡ºåºä¸€è‡´çš„ã€‚\n\nä¹Ÿæœ‰ä¾‹å¤–ï¼Œå¦‚ Powerã€Raspbian Busterã€RISC-Vï¼š\n\nhttps://godbolt.org/z/Du85RX","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578895897,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1098987,"avatar":"https://static001.geekbang.org/account/avatar/00/10/c4/eb/2285a345.jpg","nickname":"èŠ±æ™¨å°‘å¹´","note":"","ucode":"6AA3537A6BA10E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":132225,"discussion_content":"cpuä¹±åºæ‰§è¡Œç­‰ä¼˜åŒ–è¢«é™åˆ¶ï¼Œç¼–è¯‘å™¨ä¼˜åŒ–è¢«é™åˆ¶","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578889040,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":171039,"user_name":"èŠ±æ™¨å°‘å¹´","can_delete":false,"product_type":"c1","uid":1098987,"ip_address":"","ucode":"6AA3537A6BA10E","user_header":"https://static001.geekbang.org/account/avatar/00/10/c4/eb/2285a345.jpg","comment_is_top":false,"comment_ctime":1578830010,"is_pvip":false,"replies":[{"id":"66362","content":"åˆ«æ¼äº†å‰é¢é‚£å‡ å¥ï¼š<br><br>ã€Œ`memory_order_seq_cst`ï¼šé¡ºåºä¸€è‡´æ€§è¯­ä¹‰ï¼Œå¯¹äºè¯»æ“ä½œç›¸å½“äºè·å–ï¼Œå¯¹äºå†™æ“ä½œç›¸å½“äºé‡Šæ”¾ã€","user_name":"ä½œè€…å›å¤","user_name_real":"å´å’ç‚œ","uid":"1645639","ctime":1578880574,"ip_address":"","comment_id":171039,"utype":1}],"discussion_count":4,"race_medal":0,"score":"1578830010","product_id":100040501,"comment_content":"ä»‹ç»memory_order_seq_cstæ—¶ï¼Œè¯´è¿™æ˜¯æ‰€æœ‰åŸå­æ“ä½œçš„é»˜è®¤å†…å­˜åºï¼Œä½†æ˜¯åœ¨æ–‡ç« å‰é¢åˆè¯´ <br><br>y = 2 ç›¸å½“äº y.store(2, memory_order_release)<br>y == 2 ç›¸å½“äº y.load(memory_order_acquire) == 2<br>ï¼Ÿ<br>æœ‰ç‚¹å‡Œä¹±ï¼Œè¿™é‡Œã€‚","like_count":0,"discussions":[{"author":{"id":1645639,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/47/53c48284.jpg","nickname":"å´å’ç‚œ","note":"","ucode":"8C24C10AEC779F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":481214,"discussion_content":"åˆ«æ¼äº†å‰é¢é‚£å‡ å¥ï¼š\n\nã€Œ`memory_order_seq_cst`ï¼šé¡ºåºä¸€è‡´æ€§è¯­ä¹‰ï¼Œå¯¹äºè¯»æ“ä½œç›¸å½“äºè·å–ï¼Œå¯¹äºå†™æ“ä½œç›¸å½“äºé‡Šæ”¾ã€","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578880574,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1477855,"avatar":"https://static001.geekbang.org/account/avatar/00/16/8c/df/77acb793.jpg","nickname":"ç¦¾æ¡ƒ","note":"","ucode":"9FE85C34A9E9E0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":131898,"discussion_content":"æ–‡ä¸­è²Œä¼¼å·²ç»è§£é‡Šè¿‡äº†ã€‚\n\nmemory_order_seq_cstï¼š\né¡ºåºä¸€è‡´æ€§è¯­ä¹‰ï¼Œ\n\nå¯¹äºè¯»æ“ä½œ(load)ç›¸å½“äºè·å–â€”>memory_order_acquire\n\nå¯¹äºå†™æ“ä½œ(store)ç›¸å½“äºé‡Šæ”¾â€”>memory_order_release\n\nå¯¹äºè¯»â€ä¿®æ”¹â€å†™æ“ä½œç›¸å½“äºè·å¾—é‡Šæ”¾â€”>memory_order_release\n\n\næ˜¯æ‰€æœ‰åŸå­æ“ä½œçš„é»˜è®¤å†…å­˜åº","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578874031,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1098987,"avatar":"https://static001.geekbang.org/account/avatar/00/10/c4/eb/2285a345.jpg","nickname":"èŠ±æ™¨å°‘å¹´","note":"","ucode":"6AA3537A6BA10E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1477855,"avatar":"https://static001.geekbang.org/account/avatar/00/16/8c/df/77acb793.jpg","nickname":"ç¦¾æ¡ƒ","note":"","ucode":"9FE85C34A9E9E0","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":132153,"discussion_content":"seq_cstæ˜¯é¡ºåºä¸€è‡´æ€§ï¼Œå¯¹äºè¯»è²Œä¼¼ä¸èƒ½å’Œmemory_order_acquireåˆ’ç­‰å·ï¼Œå¯¹äºå†™ä¹Ÿä¸èƒ½å’Œmemory_order_releaseåˆ’ç­‰å·.\nåº”è¯¥æ˜¯memory_order_acq_relå¯ä»¥åˆ’ç­‰å·.","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578884068,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":131898,"ip_address":""},"score":132153,"extra":""},{"author":{"id":1645639,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/47/53c48284.jpg","nickname":"å´å’ç‚œ","note":"","ucode":"8C24C10AEC779F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":1098987,"avatar":"https://static001.geekbang.org/account/avatar/00/10/c4/eb/2285a345.jpg","nickname":"èŠ±æ™¨å°‘å¹´","note":"","ucode":"6AA3537A6BA10E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":132367,"discussion_content":"ä½ ç†è§£é”™äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578901256,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":132153,"ip_address":""},"score":132367,"extra":""}]}]},{"had_liked":false,"id":171037,"user_name":"èŠ±æ™¨å°‘å¹´","can_delete":false,"product_type":"c1","uid":1098987,"ip_address":"","ucode":"6AA3537A6BA10E","user_header":"https://static001.geekbang.org/account/avatar/00/10/c4/eb/2285a345.jpg","comment_is_top":false,"comment_ctime":1578829732,"is_pvip":false,"replies":[{"id":"66402","content":"æŒ‰æ ‡å‡†çš„è§„å®šï¼Œstore åªèƒ½ç”¨ relaxedã€release æˆ– seq_cstï¼Œload åªèƒ½ç”¨ relaxedã€acquire æˆ– seq_cstï¼Œç­‰ç­‰ã€‚å…¶ä»–ç»„åˆåœ¨æ ‡å‡†ä¸­æ˜ç¡®è¯´æ˜¯æœªå®šä¹‰è¡Œä¸ºï¼Œå°±ç®—èƒ½è¿‡ä¹Ÿæœ‰ç‚¹å‡‘å·§ï¼Œä¸ä¿è¯æ¢ä¸ªç¼–è¯‘å™¨æˆ–ç”šè‡³æ¢ä¸ªç‰ˆæœ¬è¿˜èƒ½ç»§ç»­å·¥ä½œã€‚<br><br>ä¸è¦è¿™ä¹ˆåšã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å´å’ç‚œ","uid":"1645639","ctime":1578896187,"ip_address":"","comment_id":171037,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1578829732","product_id":100040501,"comment_content":"memory_order_acq_relåªèƒ½ä½œç”¨åˆ°è¯»å–-ä¿®æ”¹-å†™æ“ä½œå—ï¼Œè²Œä¼¼å•çº¯çš„è¯»æˆ–è€…å†™æ“ä½œä¹Ÿå¯ä»¥ç”¨è¿™ä¸ªorder.<br>é‚£è¿™ä¸ªorderå’Œseq_cstè²Œä¼¼å¹¶æ²¡æœ‰å¾ˆå¤§çš„åŒºåˆ«ï¼Œ<br>ä¸æ˜ç™½è¿™ä¸¤ä¸ªorderçš„ä¸æ­¢åŒºåˆ«æ˜¯ä»€","like_count":0,"discussions":[{"author":{"id":1645639,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/47/53c48284.jpg","nickname":"å´å’ç‚œ","note":"","ucode":"8C24C10AEC779F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":481212,"discussion_content":"æŒ‰æ ‡å‡†çš„è§„å®šï¼Œstore åªèƒ½ç”¨ relaxedã€release æˆ– seq_cstï¼Œload åªèƒ½ç”¨ relaxedã€acquire æˆ– seq_cstï¼Œç­‰ç­‰ã€‚å…¶ä»–ç»„åˆåœ¨æ ‡å‡†ä¸­æ˜ç¡®è¯´æ˜¯æœªå®šä¹‰è¡Œä¸ºï¼Œå°±ç®—èƒ½è¿‡ä¹Ÿæœ‰ç‚¹å‡‘å·§ï¼Œä¸ä¿è¯æ¢ä¸ªç¼–è¯‘å™¨æˆ–ç”šè‡³æ¢ä¸ªç‰ˆæœ¬è¿˜èƒ½ç»§ç»­å·¥ä½œã€‚\n\nä¸è¦è¿™ä¹ˆåšã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578896187,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":170848,"user_name":"æäº®äº®","can_delete":false,"product_type":"c1","uid":1116508,"ip_address":"","ucode":"290907F930B261","user_header":"https://static001.geekbang.org/account/avatar/00/11/09/5c/b5d79d20.jpg","comment_is_top":false,"comment_ctime":1578739336,"is_pvip":false,"replies":[{"id":"66247","content":"è®¡ç®—çš„ä¸–ç•ŒçœŸæ˜¯å¤æ‚ã€‚C++æ˜¯ä¸ºäº†æ€§èƒ½ï¼Œè®©ä½ èƒ½å¤Ÿçœ‹åˆ°è¿™äº›å¤æ‚æ€§è€Œå·²ã€‚å¯¹æ€§èƒ½æ²¡é‚£ä¹ˆå…³æ³¨çš„ï¼Œå¯ä»¥æŠŠè¿™äº›å¤æ‚æ€§éšè—æ‰ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å´å’ç‚œ","uid":"1645639","ctime":1578794136,"ip_address":"","comment_id":170848,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1578739336","product_id":100040501,"comment_content":"C++çœŸæ˜¯åšå¤§ç²¾æ·±","like_count":0,"discussions":[{"author":{"id":1645639,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/47/53c48284.jpg","nickname":"å´å’ç‚œ","note":"","ucode":"8C24C10AEC779F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":481136,"discussion_content":"è®¡ç®—çš„ä¸–ç•ŒçœŸæ˜¯å¤æ‚ã€‚C++æ˜¯ä¸ºäº†æ€§èƒ½ï¼Œè®©ä½ èƒ½å¤Ÿçœ‹åˆ°è¿™äº›å¤æ‚æ€§è€Œå·²ã€‚å¯¹æ€§èƒ½æ²¡é‚£ä¹ˆå…³æ³¨çš„ï¼Œå¯ä»¥æŠŠè¿™äº›å¤æ‚æ€§éšè—æ‰ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578794136,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}