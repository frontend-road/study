{"id":403351,"title":"30 | ORM：CURD 神器 GORM 包介绍及实战","content":"<p>你好，我是孔令飞。</p><p>在用Go开发项目时，我们免不了要和数据库打交道。每种语言都有优秀的ORM可供选择，在Go中也不例外，比如<a href=\"https://github.com/go-gorm/gorm\">gorm</a>、<a href=\"https://github.com/go-xorm/xorm\">xorm</a>、<a href=\"https://github.com/gohouse/gorose\">gorose</a>等。目前，GitHub上 star数最多的是GORM，它也是当前Go项目中使用最多的ORM。</p><p>IAM项目也使用了GORM。这一讲，我就来详细讲解下GORM的基础知识，并介绍iam-apiserver是如何使用GORM，对数据进行CURD操作的。</p><h2>GORM基础知识介绍</h2><p>GORM是Go语言的ORM包，功能强大，调用方便。像腾讯、华为、阿里这样的大厂，都在使用GORM来构建企业级的应用。GORM有很多特性，开发中常用的核心特性如下：</p><ul>\n<li>功能全。使用ORM操作数据库的接口，GORM都有，可以满足我们开发中对数据库调用的各类需求。</li>\n<li>支持钩子方法。这些钩子方法可以应用在Create、Save、Update、Delete、Find方法中。</li>\n<li>开发者友好，调用方便。</li>\n<li>支持Auto Migration。</li>\n<li>支持关联查询。</li>\n<li>支持多种关系数据库，例如MySQL、Postgres、SQLite、SQLServer等。</li>\n</ul><p>GORM有两个版本，<a href=\"https://github.com/jinzhu/gorm\">V1</a>和<a href=\"https://github.com/go-gorm/gorm\">V2</a>。遵循用新不用旧的原则，IAM项目使用了最新的V2版本。</p><!-- [[[read_end]]] --><h2>通过示例学习GORM</h2><p>接下来，我们先快速看一个使用GORM的示例，通过该示例来学习GORM。示例代码存放在<a href=\"https://github.com/marmotedu/gopractise-demo/blob/main/gorm/main.go\">marmotedu/gopractise-demo/gorm/main.go</a>文件中。因为代码比较长，你可以使用以下命令克隆到本地查看：</p><pre><code class=\"language-bash\">$ mkdir -p $GOPATH/src/github.com/marmotedu\n$ cd $GOPATH/src/github.com/marmotedu\n$ git clone https://github.com/marmotedu/gopractise-demo\n$ cd gopractise-demo/gorm/\n</code></pre><p>假设我们有一个MySQL数据库，连接地址和端口为 <code>127.0.0.1:3306</code> ，用户名为 <code>iam</code> ，密码为 <code>iam1234</code> 。创建完main.go文件后，执行以下命令来运行：</p><pre><code class=\"language-bash\">$ go run main.go -H 127.0.0.1:3306 -u iam -p iam1234 -d test\n2020/10/17 15:15:50 totalcount: 1\n2020/10/17 15:15:50 \tcode: D42, price: 100\n2020/10/17 15:15:51 totalcount: 1\n2020/10/17 15:15:51 \tcode: D42, price: 200\n2020/10/17 15:15:51 totalcount: 0\n</code></pre><p>在企业级Go项目开发中，使用GORM库主要用来完成以下数据库操作：</p><ul>\n<li>连接和关闭数据库。连接数据库时，可能需要设置一些参数，比如最大连接数、最大空闲连接数、最大连接时长等。</li>\n<li>插入表记录。可以插入一条记录，也可以批量插入记录。</li>\n<li>更新表记录。可以更新某一个字段，也可以更新多个字段。</li>\n<li>查看表记录。可以查看某一条记录，也可以查看符合条件的记录列表。</li>\n<li>删除表记录。可以删除某一个记录，也可以批量删除。删除还支持永久删除和软删除。</li>\n<li>在一些小型项目中，还会用到GORM的表结构自动迁移功能。</li>\n</ul><p>GORM功能强大，上面的示例代码展示的是比较通用的一种操作方式。</p><p>上述代码中，首先定义了一个GORM模型（Models），Models是标准的Go struct，用来代表数据库中的一个表结构。我们可以给 Models 添加 TableName 方法，来告诉 GORM 该Models映射到数据库中的哪张表。Models定义如下：</p><pre><code class=\"language-go\">type Product struct {\n    gorm.Model\n    Code  string `gorm:\"column:code\"`\n    Price uint   `gorm:\"column:price\"`\n}\n\n// TableName maps to mysql table name.\nfunc (p *Product) TableName() string {\n    return \"product\"\n}\n</code></pre><p>如果没有指定表名，则GORM使用结构体名的蛇形复数作为表名。例如：结构体名为 <code>DockerInstance</code> ，则表名为 <code>dockerInstances</code> 。</p><p>在之后的代码中，使用Pflag来解析命令行的参数，通过命令行参数指定数据库的地址、用户名、密码和数据库名。之后，使用这些参数生成建立 MySQL 连接需要的配置文件，并调用 <code>gorm.Open</code> 建立数据库连接：</p><pre><code class=\"language-go\">var (\n    host     = pflag.StringP(\"host\", \"H\", \"127.0.0.1:3306\", \"MySQL service host address\")\n    username = pflag.StringP(\"username\", \"u\", \"root\", \"Username for access to mysql service\")\n    password = pflag.StringP(\"password\", \"p\", \"root\", \"Password for access to mysql, should be used pair with password\")\n    database = pflag.StringP(\"database\", \"d\", \"test\", \"Database name to use\")\n    help     = pflag.BoolP(\"help\", \"h\", false, \"Print this help message\")\n)\n\nfunc main() {\n    // Parse command line flags\n    pflag.CommandLine.SortFlags = false\n    pflag.Usage = func() {\n        pflag.PrintDefaults()\n    }\n    pflag.Parse()\n    if *help {\n        pflag.Usage()\n        return\n    }\n\n    dsn := fmt.Sprintf(`%s:%s@tcp(%s)/%s?charset=utf8&amp;parseTime=%t&amp;loc=%s`,\n        *username,\n        *password,\n        *host,\n        *database,\n        true,\n        \"Local\")\n    db, err := gorm.Open(mysql.Open(dsn), &amp;gorm.Config{})\n    if err != nil {\n        panic(\"failed to connect database\")\n    }\n}\n</code></pre><p>创建完数据库连接之后，会返回数据库实例 <code>db</code> ，之后就可以调用db实例中的方法，完成数据库的CURD操作。具体操作如下，一共可以分为六个操作：</p><p>第一个操作，自动迁移表结构。</p><pre><code class=\"language-go\">// 1. Auto migration for given models\ndb.AutoMigrate(&amp;Product{})\n</code></pre><p><strong>我不建议你在正式的代码中自动迁移表结构。</strong>因为变更现网数据库是一个高危操作，现网数据库字段的添加、类型变更等，都需要经过严格的评估才能实施。这里将变更隐藏在代码中，在组件发布时很难被研发人员感知到，如果组件启动，就可能会自动修改现网表结构，也可能会因此引起重大的现网事故。</p><p>GORM的AutoMigrate方法，只对新增的字段或索引进行变更，理论上是没有风险的。在实际的Go项目开发中，也有很多人使用AutoMigrate方法自动同步表结构。但我更倾向于规范化、可感知的操作方式，所以我在实际开发中，都是手动变更表结构的。当然，具体使用哪种方法，你可以根据需要自行选择。</p><p>第二个操作，插入表记录。</p><pre><code class=\"language-go\">// 2. Insert the value into database\nif err := db.Create(&amp;Product{Code: \"D42\", Price: 100}).Error; err != nil {\n    log.Fatalf(\"Create error: %v\", err)\n}\nPrintProducts(db)\n</code></pre><p>通过 <code>db.Create</code> 方法创建了一条记录。插入记录后，通过调用 <code>PrintProducts</code> 方法打印当前表中的所有数据记录，来测试是否成功插入。</p><p>第三个操作，获取符合条件的记录。</p><pre><code class=\"language-go\">// 3. Find first record that match given conditions\nproduct := &amp;Product{}\nif err := db.Where(\"code= ?\", \"D42\").First(&amp;product).Error; err != nil {\n    log.Fatalf(\"Get product error: %v\", err)\n}\n</code></pre><p>First方法只会返回符合条件的记录列表中的第一条，你可以使用First方法来获取某个资源的详细信息。</p><p>第四个操作，更新表记录。</p><pre><code class=\"language-go\">// 4. Update value in database, if the value doesn't have primary key, will insert it\nproduct.Price = 200\nif err := db.Save(product).Error; err != nil {\n    log.Fatalf(\"Update product error: %v\", err)\n}\nPrintProducts(db)\n</code></pre><p>通过Save方法，可以把 product 变量中所有跟数据库不一致的字段更新到数据库中。具体操作是：先获取某个资源的详细信息，再通过 <code>product.Price = 200</code> 这类赋值语句，对其中的一些字段重新赋值。最后，调用 <code>Save</code> 方法更新这些字段。你可以将这些操作看作一种更新数据库的更新模式。</p><p>第五个操作，删除表记录。</p><p>通过 <code>Delete</code> 方法删除表记录，代码如下：</p><pre><code class=\"language-go\">// 5. Delete value match given conditions\nif err := db.Where(\"code = ?\", \"D42\").Delete(&amp;Product{}).Error; err != nil {\n    log.Fatalf(\"Delete product error: %v\", err)\n}\nPrintProducts(db)\n</code></pre><p>这里需要注意，因为 <code>Product</code> 中有 <code>gorm.DeletedAt</code> 字段，所以，上述删除操作不会真正把记录从数据库表中删除掉，而是通过设置数据库 <code>product</code> 表 <code>deletedAt</code> 字段为当前时间的方法来删除。</p><p>第六个操作，获取表记录列表。</p><pre><code class=\"language-go\">products := make([]*Product, 0)\nvar count int64\nd := db.Where(\"code like ?\", \"%D%\").Offset(0).Limit(2).Order(\"id desc\").Find(&amp;products).Offset(-1).Limit(-1).Count(&amp;count)\nif d.Error != nil {\n    log.Fatalf(\"List products error: %v\", d.Error)\n}\n</code></pre><p>在PrintProducts函数中，会打印当前的所有记录，你可以根据输出，判断数据库操作是否成功。</p><h2>GORM常用操作讲解</h2><p>看完上面的示例，我想你已经初步掌握了GORM的使用方法。接下来，我再来给你详细介绍下GORM所支持的数据库操作。</p><h3>模型定义</h3><p>GORM使用模型（Models）来映射一个数据库表。默认情况下，使用ID作为主键，使用结构体名的 <code>snake_cases</code> 作为表名，使用字段名的 <code>snake_case</code> 作为列名，并使用 CreatedAt、UpdatedAt、DeletedAt字段追踪创建、更新和删除时间。</p><p>使用GORM的默认规则，可以减少代码量，但我更喜欢的方式是<strong>直接指明字段名和表名</strong>。例如，有以下模型：</p><pre><code class=\"language-go\">type Animal struct {\n  AnimalID int64        // 列名 `animal_id`\n  Birthday time.Time    // 列名 `birthday`\n  Age      int64        // 列名 `age`\n}\n</code></pre><p>上述模型对应的表名为 <code>animals</code> ，列名分别为 <code>animal_id</code> 、 <code>birthday</code> 和 <code>age</code> 。我们可以通过以下方式来重命名表名和列名，并将 <code>AnimalID</code> 设置为表的主键：</p><pre><code class=\"language-go\">type Animal struct {\n    AnimalID int64     `gorm:\"column:animalID;primarykey\"` // 将列名设为 `animalID`\n    Birthday time.Time `gorm:\"column:birthday\"`            // 将列名设为 `birthday`\n    Age      int64     `gorm:\"column:age\"`                 // 将列名设为 `age`\n}\n\nfunc (a *Animal) TableName() string {\n    return \"animal\"\n}\n</code></pre><p>上面的代码中，通过 <code>primaryKey</code> 标签指定主键，使用 <code>column</code> 标签指定列名，通过给Models添加 <code>TableName</code> 方法指定表名。</p><p>数据库表通常会包含4个字段。</p><ul>\n<li>ID：自增字段，也作为主键。</li>\n<li>CreatedAt：记录创建时间。</li>\n<li>UpdatedAt：记录更新时间。</li>\n<li>DeletedAt：记录删除时间（软删除时有用）。</li>\n</ul><p>GORM也预定义了包含这4个字段的Models，在我们定义自己的Models时，可以直接内嵌到结构体内，例如：</p><pre><code class=\"language-go\">type Animal struct {\n    gorm.Model\n    AnimalID int64     `gorm:\"column:animalID\"` // 将列名设为 `animalID`\n    Birthday time.Time `gorm:\"column:birthday\"` // 将列名设为 `birthday`\n    Age      int64     `gorm:\"column:age\"`      // 将列名设为 `age`\n}\n</code></pre><p>Models中的字段能支持很多GORM标签，但如果我们不使用GORM自动创建表和迁移表结构的功能，很多标签我们实际上是用不到的。在开发中，用得最多的是 <code>column</code> 标签。</p><h3>连接数据库</h3><p>在进行数据库的CURD操作之前，我们首先需要连接数据库。你可以通过以下代码连接MySQL数据库：</p><pre><code class=\"language-go\">import (\n  \"gorm.io/driver/mysql\"\n  \"gorm.io/gorm\"\n)\n\nfunc main() {\n  // 参考 https://github.com/go-sql-driver/mysql#dsn-data-source-name 获取详情\n  dsn := \"user:pass@tcp(127.0.0.1:3306)/dbname?charset=utf8mb4&amp;parseTime=True&amp;loc=Local\"\n  db, err := gorm.Open(mysql.Open(dsn), &amp;gorm.Config{})\n}\n</code></pre><p>如果需要GORM正确地处理 <code>time.Time</code> 类型，在连接数据库时需要带上 <code>parseTime</code> 参数。如果要支持完整的UTF-8编码，可将<code>charset=utf8</code>更改为<code>charset=utf8mb4</code>。</p><p>GORM支持连接池，底层是用 <code>database/sql</code> 包来维护连接池的，连接池设置如下：</p><pre><code class=\"language-go\">sqlDB, err := db.DB()\nsqlDB.SetMaxIdleConns(100)              // 设置MySQL的最大空闲连接数（推荐100）\nsqlDB.SetMaxOpenConns(100)             // 设置MySQL的最大连接数（推荐100）\nsqlDB.SetConnMaxLifetime(time.Hour)    // 设置MySQL的空闲连接最大存活时间（推荐10s）\n</code></pre><p>上面这些设置，也可以应用在大型后端项目中。</p><h3>创建记录</h3><p>我们可以通过 <code>db.Create</code> 方法来创建一条记录：</p><pre><code class=\"language-go\">type User struct {\n  gorm.Model\n  Name         string\n  Age          uint8\n  Birthday     *time.Time\n}\nuser := User{Name: \"Jinzhu\", Age: 18, Birthday: time.Now()}\nresult := db.Create(&amp;user) // 通过数据的指针来创建\n</code></pre><p>db.Create函数会返回如下3个值：</p><ul>\n<li>user.ID：返回插入数据的主键，这个是直接赋值给user变量。</li>\n<li>result.Error：返回error。</li>\n<li>result.RowsAffected：返回插入记录的条数。</li>\n</ul><p>当需要插入的数据量比较大时，可以批量插入，以提高插入性能：</p><pre><code class=\"language-go\">var users = []User{{Name: \"jinzhu1\"}, {Name: \"jinzhu2\"}, {Name: \"jinzhu3\"}}\nDB.Create(&amp;users)\n\nfor _, user := range users {\n  user.ID // 1,2,3\n}\n</code></pre><h3>删除记录</h3><p>我们可以通过Delete方法删除记录：</p><pre><code class=\"language-go\">// DELETE from users where id = 10 AND name = \"jinzhu\";\ndb.Where(\"name = ?\", \"jinzhu\").Delete(&amp;user)\n</code></pre><p>GORM也支持根据主键进行删除，例如：</p><pre><code class=\"language-go\">// DELETE FROM users WHERE id = 10;\ndb.Delete(&amp;User{}, 10)\n</code></pre><p>不过，我更喜欢使用db.Where的方式进行删除，这种方式有两个优点。</p><p>第一个优点是删除方式更通用。使用db.Where不仅可以根据主键删除，还能够随意组合条件进行删除。</p><p>第二个优点是删除方式更显式，这意味着更易读。如果使用<code>db.Delete(&amp;User{}, 10)</code>，你还需要确认User的主键，如果记错了主键，还可能会引入Bug。</p><p>此外，GORM也支持批量删除：</p><pre><code class=\"language-go\">db.Where(\"name in (?)\", []string{\"jinzhu\", \"colin\"}).Delete(&amp;User{})\n</code></pre><p>GORM支持两种删除方法：软删除和永久删除。下面我来分别介绍下。</p><ol>\n<li>软删除</li>\n</ol><p>软删除是指执行Delete时，记录不会被从数据库中真正删除。GORM会将 <code>DeletedAt</code> 设置为当前时间，并且不能通过正常的方式查询到该记录。如果模型包含了一个 <code>gorm.DeletedAt</code> 字段，GORM在执行删除操作时，会软删除该记录。</p><p>下面的删除方法就是一个软删除：</p><pre><code class=\"language-go\">// UPDATE users SET deleted_at=\"2013-10-29 10:23\" WHERE age = 20;\ndb.Where(\"age = ?\", 20).Delete(&amp;User{})\n\n// SELECT * FROM users WHERE age = 20 AND deleted_at IS NULL;\ndb.Where(\"age = 20\").Find(&amp;user)\n</code></pre><p>可以看到，GORM并没有真正把记录从数据库删除掉，而是只更新了 <code>deleted_at</code> 字段。在查询时，GORM查询条件中新增了<code>AND deleted_at IS NULL</code>条件，所以这些被设置过 <code>deleted_at</code> 字段的记录不会被查询到。对于一些比较重要的数据，我们可以通过软删除的方式删除记录，软删除可以使这些重要的数据后期能够被恢复，并且便于以后的排障。</p><p>我们可以通过下面的方式查找被软删除的记录：</p><pre><code class=\"language-go\">// SELECT * FROM users WHERE age = 20;\ndb.Unscoped().Where(\"age = 20\").Find(&amp;users)\n</code></pre><ol start=\"2\">\n<li>永久删除</li>\n</ol><p>如果想永久删除一条记录，可以使用Unscoped：</p><pre><code class=\"language-go\">// DELETE FROM orders WHERE id=10;\ndb.Unscoped().Delete(&amp;order)\n</code></pre><p>或者，你也可以在模型中去掉gorm.DeletedAt。</p><h3>更新记录</h3><p>GORM中，最常用的更新方法如下：</p><pre><code class=\"language-go\">db.First(&amp;user)\n\nuser.Name = \"jinzhu 2\"\nuser.Age = 100\n// UPDATE users SET name='jinzhu 2', age=100, birthday='2016-01-01', updated_at = '2013-11-17 21:34:10' WHERE id=111;\ndb.Save(&amp;user)\n</code></pre><p>上述方法会保留所有字段，所以执行Save时，需要先执行First，获取某个记录的所有列的值，然后再对需要更新的字段设置值。</p><p>还可以指定更新单个列：</p><pre><code class=\"language-go\">// UPDATE users SET age=200, updated_at='2013-11-17 21:34:10' WHERE name='colin';\ndb.Model(&amp;User{}).Where(\"name = ?\", \"colin\").Update(\"age\", 200)\n</code></pre><p>也可以指定更新多个列：</p><pre><code class=\"language-go\">// UPDATE users SET name='hello', age=18, updated_at = '2013-11-17 21:34:10' WHERE name = 'colin';\ndb.Model(&amp;user).Where(\"name\", \"colin\").Updates(User{Name: \"hello\", Age: 18, Active: false})\n</code></pre><p>这里要注意，这个方法只会更新非零值的字段。</p><h3>查询数据</h3><p>GORM支持不同的查询方法，下面我来讲解三种在开发中经常用到的查询方式，分别是检索单个记录、查询所有符合条件的记录和智能选择字段。</p><ol>\n<li>检索单个记录</li>\n</ol><p>下面是检索单个记录的示例代码：</p><pre><code class=\"language-go\">// 获取第一条记录（主键升序）\n// SELECT * FROM users ORDER BY id LIMIT 1;\ndb.First(&amp;user)\n\n// 获取最后一条记录（主键降序）\n// SELECT * FROM users ORDER BY id DESC LIMIT 1;\ndb.Last(&amp;user)\nresult := db.First(&amp;user)\nresult.RowsAffected // 返回找到的记录数\nresult.Error        // returns error\n\n// 检查 ErrRecordNotFound 错误\nerrors.Is(result.Error, gorm.ErrRecordNotFound)\n</code></pre><p>如果model类型没有定义主键，则按第一个字段排序。</p><ol start=\"2\">\n<li>查询所有符合条件的记录</li>\n</ol><p>示例代码如下：</p><pre><code class=\"language-go\">users := make([]*User, 0)\n\n// SELECT * FROM users WHERE name &lt;&gt; 'jinzhu';\ndb.Where(\"name &lt;&gt; ?\", \"jinzhu\").Find(&amp;users)\n</code></pre><ol start=\"3\">\n<li>智能选择字段</li>\n</ol><p>你可以通过Select方法，选择特定的字段。我们可以定义一个较小的结构体来接受选定的字段：</p><pre><code class=\"language-go\">type APIUser struct {\n  ID   uint\n  Name string\n}\n\n// SELECT `id`, `name` FROM `users` LIMIT 10;\ndb.Model(&amp;User{}).Limit(10).Find(&amp;APIUser{})\n</code></pre><p>除了上面讲的三种常用的基本查询方法，GORM还支持高级查询，下面我来介绍下。</p><h3>高级查询</h3><p>GORM支持很多高级查询功能，这里我主要介绍4种。</p><ol>\n<li>指定检索记录时的排序方式</li>\n</ol><p>示例代码如下：</p><pre><code class=\"language-go\">// SELECT * FROM users ORDER BY age desc, name;\ndb.Order(\"age desc, name\").Find(&amp;users)\n</code></pre><ol start=\"2\">\n<li>Limit &amp; Offset</li>\n</ol><p>Offset指定从第几条记录开始查询，Limit指定返回的最大记录数。Offset和Limit值为-1时，消除Offset和Limit条件。另外，Limit和Offset位置不同，效果也不同。</p><pre><code class=\"language-go\">// SELECT * FROM users OFFSET 5 LIMIT 10;\ndb.Limit(10).Offset(5).Find(&amp;users)\n</code></pre><ol start=\"3\">\n<li>Distinct</li>\n</ol><p>Distinct可以从数据库记录中选择不同的值。</p><pre><code class=\"language-go\">db.Distinct(\"name\", \"age\").Order(\"name, age desc\").Find(&amp;results)\n</code></pre><ol start=\"4\">\n<li>Count</li>\n</ol><p>Count可以获取匹配的条数。</p><pre><code class=\"language-go\">var count int64\n// SELECT count(1) FROM users WHERE name = 'jinzhu'; (count)\ndb.Model(&amp;User{}).Where(\"name = ?\", \"jinzhu\").Count(&amp;count)\n</code></pre><p>GORM还支持很多高级查询功能，比如内联条件、Not 条件、Or 条件、Group &amp; Having、Joins、Group、FirstOrInit、FirstOrCreate、迭代、FindInBatches等。因为IAM项目中没有用到这些高级特性，我在这里就不展开介绍了。你如果感兴趣，可以看下<a href=\"https://gorm.io/zh_CN/docs/index.html\">GORM的官方文档</a>。</p><h3>原生SQL</h3><p>GORM支持原生查询SQL和执行SQL。原生查询SQL用法如下：</p><pre><code class=\"language-go\">type Result struct {\n  ID   int\n  Name string\n  Age  int\n}\n\nvar result Result\ndb.Raw(\"SELECT id, name, age FROM users WHERE name = ?\", 3).Scan(&amp;result)\n</code></pre><p>原生执行SQL用法如下；</p><pre><code class=\"language-go\">db.Exec(\"DROP TABLE users\")\ndb.Exec(\"UPDATE orders SET shipped_at=? WHERE id IN ?\", time.Now(), []int64{1,2,3})\n</code></pre><h3>GORM钩子</h3><p>GORM支持钩子功能，例如下面这个在插入记录前执行的钩子：</p><pre><code class=\"language-go\">func (u *User) BeforeCreate(tx *gorm.DB) (err error) {\n  u.UUID = uuid.New()\n\n    if u.Name == \"admin\" {\n        return errors.New(\"invalid name\")\n    }\n    return\n}\n</code></pre><p>GORM支持的钩子见下表：</p><p><img src=\"https://static001.geekbang.org/resource/image/20/2c/20fb0b6a11dbcebd9ddf428517240d2c.jpg?wh=1920x1338\" alt=\"图片\"></p><h2>iam-apiserver中的CURD操作实战</h2><p>接下来，我来介绍下iam-apiserver是如何使用GORM，对数据进行CURD操作的。</p><p><strong>首先，</strong>我们需要配置连接MySQL的各类参数。iam-apiserver通过<a href=\"https://github.com/marmotedu/iam/blob/v1.0.4/internal/pkg/options/mysql_options.go#L29\">NewMySQLOptions</a>函数创建了一个带有默认值的<a href=\"https://github.com/marmotedu/iam/blob/v1.0.4/internal/pkg/options/mysql_options.go#L17\">MySQLOptions</a>类型的变量，将该变量传给<a href=\"https://github.com/marmotedu/iam/blob/v1.0.4/pkg/app/app.go#L157\">NewApp</a>函数。在App框架中，最终会调用MySQLOptions提供的AddFlags方法，将MySQLOptions提供的命令行参数添加到Cobra命令行中。</p><p><strong>接着，</strong>在<a href=\"https://github.com/marmotedu/iam/blob/v1.0.4/internal/apiserver/server.go#L81\">PrepareRun</a>函数中，调用<a href=\"https://github.com/marmotedu/iam/blob/v1.0.4/internal/apiserver/store/mysql/mysql.go#L55\">GetMySQLFactoryOr</a>函数，初始化并获取仓库层的实例<a href=\"https://github.com/marmotedu/iam/blob/v1.0.4/internal/apiserver/store/mysql/mysql.go#L50\">mysqlFactory</a>。实现了仓库层<a href=\"https://github.com/marmotedu/iam/blob/v1.0.4/internal/apiserver/store/store.go#L12\">store.Factory</a>接口：</p><pre><code class=\"language-go\">type Factory interface {\n    Users() UserStore\n    Secrets() SecretStore\n    Policies() PolicyStore\n    Close() error\n}\n</code></pre><p>GetMySQLFactoryOr函数采用了我们在 <a href=\"https://time.geekbang.org/column/article/386238\">11讲</a> 中提过的单例模式，确保iam-apiserver进程中只有一个仓库层的实例，这样可以减少内存开支和系统的性能开销。</p><p>GetMySQLFactoryOr函数中，使用<a href=\"https://github.com/marmotedu/iam/blob/v1.0.4/pkg/db/mysql.go#L30\">github.com/marmotedu/iam/pkg/db</a>包提供的New函数，创建了MySQL实例。New函数代码如下：</p><pre><code class=\"language-go\">func New(opts *Options) (*gorm.DB, error) {&nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; dsn := fmt.Sprintf(`%s:%s@tcp(%s)/%s?charset=utf8&amp;parseTime=%t&amp;loc=%s`,&nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; opts.Username,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; opts.Password,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; opts.Host,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; opts.Database,&nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; true,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; \"Local\")&nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; db, err := gorm.Open(mysql.Open(dsn), &amp;gorm.Config{&nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; Logger: logger.New(opts.LogLevel),&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;\n&nbsp; &nbsp; })&nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; if err != nil {&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; return nil, err&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;\n&nbsp; &nbsp; }&nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; sqlDB, err := db.DB()&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; if err != nil {&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; return nil, err&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; }&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;\n&nbsp; &nbsp; // SetMaxOpenConns sets the maximum number of open connections to the database.\n&nbsp; &nbsp; sqlDB.SetMaxOpenConns(opts.MaxOpenConnections)\n\n&nbsp; &nbsp; // SetConnMaxLifetime sets the maximum amount of time a connection may be reused.\n&nbsp; &nbsp; sqlDB.SetConnMaxLifetime(opts.MaxConnectionLifeTime)\n\n&nbsp; &nbsp; // SetMaxIdleConns sets the maximum number of connections in the idle connection pool.\n&nbsp; &nbsp; sqlDB.SetMaxIdleConns(opts.MaxIdleConnections)\n\n&nbsp; &nbsp; return db, nil\n}\n</code></pre><p>上述代码中，我们先创建了一个 <code>*gorm.DB</code> 类型的实例，并对该实例进行了如下设置：</p><ul>\n<li>通过SetMaxOpenConns方法，设置了MySQL的最大连接数（推荐100）。</li>\n<li>通过SetConnMaxLifetime方法，设置了MySQL的空闲连接最大存活时间（推荐10s）。</li>\n<li>通过SetMaxIdleConns方法，设置了MySQL的最大空闲连接数（推荐100）。</li>\n</ul><p>GetMySQLFactoryOr函数最后创建了datastore类型的变量mysqlFactory，该变量是仓库层的变量。mysqlFactory变量中，又包含了 <code>*gorm.DB</code> 类型的字段 <code>db</code> 。</p><p><strong>最终</strong><strong>，</strong>我们通过仓库层的变量mysqlFactory，调用其 <code>db</code> 字段提供的方法来完成数据库的CURD操作。例如，创建密钥、更新密钥、删除密钥、获取密钥详情、查询密钥列表，具体代码如下（代码位于<a href=\"https://github.com/marmotedu/iam/blob/v1.0.4/internal/apiserver/store/mysql/secret.go\">secret.go</a>文件中）：</p><pre><code class=\"language-go\">// Create creates a new secret.\nfunc (s *secrets) Create(ctx context.Context, secret *v1.Secret, opts metav1.CreateOptions) error {\n\treturn s.db.Create(&amp;secret).Error\n}\n\n// Update updates an secret information by the secret identifier.\nfunc (s *secrets) Update(ctx context.Context, secret *v1.Secret, opts metav1.UpdateOptions) error {\n\treturn s.db.Save(secret).Error\n}\n\n// Delete deletes the secret by the secret identifier.\nfunc (s *secrets) Delete(ctx context.Context, username, name string, opts metav1.DeleteOptions) error {\n\tif opts.Unscoped {\n\t\ts.db = s.db.Unscoped()\n\t}\n\n\terr := s.db.Where(\"username = ? and name = ?\", username, name).Delete(&amp;v1.Secret{}).Error\n\tif err != nil &amp;&amp; !errors.Is(err, gorm.ErrRecordNotFound) {\n\t\treturn errors.WithCode(code.ErrDatabase, err.Error())\n\t}\n\n\treturn nil\n}\n\n// Get return an secret by the secret identifier.\nfunc (s *secrets) Get(ctx context.Context, username, name string, opts metav1.GetOptions) (*v1.Secret, error) {\n\tsecret := &amp;v1.Secret{}\n\terr := s.db.Where(\"username = ? and name= ?\", username, name).First(&amp;secret).Error\n\tif err != nil {\n\t\tif errors.Is(err, gorm.ErrRecordNotFound) {\n\t\t\treturn nil, errors.WithCode(code.ErrSecretNotFound, err.Error())\n\t\t}\n\n\t\treturn nil, errors.WithCode(code.ErrDatabase, err.Error())\n\t}\n\n\treturn secret, nil\n}\n\n// List return all secrets.\nfunc (s *secrets) List(ctx context.Context, username string, opts metav1.ListOptions) (*v1.SecretList, error) {\n\tret := &amp;v1.SecretList{}\n\tol := gormutil.Unpointer(opts.Offset, opts.Limit)\n\n\tif username != \"\" {\n\t\ts.db = s.db.Where(\"username = ?\", username)\n\t}\n\n\tselector, _ := fields.ParseSelector(opts.FieldSelector)\n\tname, _ := selector.RequiresExactMatch(\"name\")\n\n\td := s.db.Where(\" name like ?\", \"%\"+name+\"%\").\n\t\tOffset(ol.Offset).\n\t\tLimit(ol.Limit).\n\t\tOrder(\"id desc\").\n\t\tFind(&amp;ret.Items).\n\t\tOffset(-1).\n\t\tLimit(-1).\n\t\tCount(&amp;ret.TotalCount)\n\n\treturn ret, d.Error\n}\n</code></pre><p>上面的代码中， <code>s.db</code> 就是 <code>*gorm.DB</code> 类型的字段。</p><p>上面的代码段执行了以下操作：</p><ul>\n<li>通过 <code>s.db.Save</code> 来更新数据库表的各字段；</li>\n<li>通过 <code>s.db.Unscoped</code> 来永久性从表中删除一行记录。对于支持软删除的资源，我们还可以通过 <code>opts.Unscoped</code> 选项来控制是否永久删除记录。 <code>true</code> 永久删除， <code>false</code> 软删除，默认软删除。</li>\n<li>通过 <code>errors.Is(err, gorm.ErrRecordNotFound)</code> 来判断GORM返回的错误是否是没有找到记录的错误类型。</li>\n<li>通过下面两行代码，来获取查询条件name的值：</li>\n</ul><pre><code class=\"language-go\">selector, _ := fields.ParseSelector(opts.FieldSelector)&nbsp; &nbsp;&nbsp;\nname, _ := selector.RequiresExactMatch(\"name\")\n</code></pre><p>我们的整个调用链是：控制层 -&gt; 业务层 -&gt; 仓库层。这里你可能要问：<strong>我们<strong><strong>是</strong></strong>如何<strong><strong>调用</strong></strong>到<strong><strong>仓库层的</strong></strong>实例mysqlFactory<strong><strong>的</strong></strong>呢？</strong></p><p>这是因为我们的控制层实例包含了业务层的实例。在创建控制层实例时，我们传入了业务层的实例：</p><pre><code class=\"language-go\">type UserController struct {&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; srv srvv1.Service&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;\n}&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;\n// NewUserController creates a user handler.&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;\nfunc NewUserController(store store.Factory) *UserController {\n&nbsp; &nbsp; return &amp;UserController{&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; srv: srvv1.NewService(store),&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;\n&nbsp; &nbsp; }&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;\n}&nbsp;\n</code></pre><p>业务层的实例包含了仓库层的实例。在创建业务层实例时，传入了仓库层的实例：</p><pre><code class=\"language-go\">type service struct {&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; store store.Factory&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;\n}&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;\n// NewService returns Service interface.&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;\nfunc NewService(store store.Factory) Service {&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; return &amp;service{&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; store: store,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;\n&nbsp; &nbsp; }\n}\n</code></pre><p>通过这种包含关系，我们在控制层可以调用业务层的实例，在业务层又可以调用仓库层的实例。这样，我们最终通过仓库层实例的 <code>db</code> 字段（<code>*gorm.DB</code> 类型）完成数据库的CURD操作。</p><h2>总结</h2><p>在Go项目中，我们需要使用ORM来进行数据库的CURD操作。在Go生态中，当前最受欢迎的ORM是GORM，IAM项目也使用了GORM。GORM有很多功能，常用的功能有模型定义、连接数据库、创建记录、删除记录、更新记录和查询数据。这些常用功能的常见使用方式如下：</p><pre><code class=\"language-go\">package main\n\nimport (\n\t\"fmt\"\n\t\"log\"\n\n\t\"github.com/spf13/pflag\"\n\t\"gorm.io/driver/mysql\"\n\t\"gorm.io/gorm\"\n)\n\ntype Product struct {\n\tgorm.Model\n\tCode&nbsp; string `gorm:\"column:code\"`\n\tPrice uint&nbsp; &nbsp;`gorm:\"column:price\"`\n}\n\n// TableName maps to mysql table name.\nfunc (p *Product) TableName() string {\n\treturn \"product\"\n}\n\nvar (\n\thost&nbsp; &nbsp; &nbsp;= pflag.StringP(\"host\", \"H\", \"127.0.0.1:3306\", \"MySQL service host address\")\n\tusername = pflag.StringP(\"username\", \"u\", \"root\", \"Username for access to mysql service\")\n\tpassword = pflag.StringP(\"password\", \"p\", \"root\", \"Password for access to mysql, should be used pair with password\")\n\tdatabase = pflag.StringP(\"database\", \"d\", \"test\", \"Database name to use\")\n\thelp&nbsp; &nbsp; &nbsp;= pflag.BoolP(\"help\", \"h\", false, \"Print this help message\")\n)\n\nfunc main() {\n\t// Parse command line flags\n\tpflag.CommandLine.SortFlags = false\n\tpflag.Usage = func() {\n\t\tpflag.PrintDefaults()\n\t}\n\tpflag.Parse()\n\tif *help {\n\t\tpflag.Usage()\n\t\treturn\n\t}\n\n\tdsn := fmt.Sprintf(`%s:%s@tcp(%s)/%s?charset=utf8&amp;parseTime=%t&amp;loc=%s`,\n\t\t*username,\n\t\t*password,\n\t\t*host,\n\t\t*database,\n\t\ttrue,\n\t\t\"Local\")\n\tdb, err := gorm.Open(mysql.Open(dsn), &amp;gorm.Config{})\n\tif err != nil {\n\t\tpanic(\"failed to connect database\")\n\t}\n\n\t// 1. Auto migration for given models\n\tdb.AutoMigrate(&amp;Product{})\n\n\t// 2. Insert the value into database\n\tif err := db.Create(&amp;Product{Code: \"D42\", Price: 100}).Error; err != nil {\n\t\tlog.Fatalf(\"Create error: %v\", err)\n\t}\n\tPrintProducts(db)\n\n\t// 3. Find first record that match given conditions\n\tproduct := &amp;Product{}\n\tif err := db.Where(\"code= ?\", \"D42\").First(&amp;product).Error; err != nil {\n\t\tlog.Fatalf(\"Get product error: %v\", err)\n\t}\n\n\t// 4. Update value in database, if the value doesn't have primary key, will insert it\n\tproduct.Price = 200\n\tif err := db.Save(product).Error; err != nil {\n\t\tlog.Fatalf(\"Update product error: %v\", err)\n\t}\n\tPrintProducts(db)\n\n\t// 5. Delete value match given conditions\n\tif err := db.Where(\"code = ?\", \"D42\").Delete(&amp;Product{}).Error; err != nil {\n\t\tlog.Fatalf(\"Delete product error: %v\", err)\n\t}\n\tPrintProducts(db)\n}\n\n// List products\nfunc PrintProducts(db *gorm.DB) {\n\tproducts := make([]*Product, 0)\n\tvar count int64\n\td := db.Where(\"code like ?\", \"%D%\").Offset(0).Limit(2).Order(\"id desc\").Find(&amp;products).Offset(-1).Limit(-1).Count(&amp;count)\n\tif d.Error != nil {\n\t\tlog.Fatalf(\"List products error: %v\", d.Error)\n\t}\n\n\tlog.Printf(\"totalcount: %d\", count)\n\tfor _, product := range products {\n\t\tlog.Printf(\"\\tcode: %s, price: %d\\n\", product.Code, product.Price)\n\t}\n}\n</code></pre><p>此外，GORM还支持原生查询SQL和原生执行SQL，可以满足更加复杂的SQL场景。</p><p>GORM中，还有一个非常有用的功能是支持Hooks。Hooks可以在执行某个CURD操作前被调用。在Hook中，可以添加一些非常有用的功能，例如生成唯一ID。目前，GORM支持 <code>BeforeXXX</code> 、 <code>AfterXXX</code> 和 <code>AfterFind</code> Hook，其中 <code>XXX</code> 可以是 Save、Create、Delete、Update。</p><p>最后，我还介绍了IAM项目的GORM实战，具体使用方式跟总结中的示例代码大体保持一致，你可以返回文稿查看。</p><h2>课后练习</h2><ol>\n<li>GORM支持AutoMigrate功能，思考下，你的生产环境是否可以使用AutoMigrate功能，为什么？</li>\n<li>查看<a href=\"https://gorm.io/zh_CN/docs/index.html\">GORM官方文档</a>，看下如何用GORM实现事务回滚功能。</li>\n</ol><p>欢迎你在留言区与我交流讨论，我们下一讲见。</p>","neighbors":{"left":{"article_title":"29｜控制流（下）：iam-apiserver服务核心功能实现讲解","id":402206},"right":{"article_title":"31 | 数据流：通过iam-authz-server设计，看数据流服务的设计","id":404542}},"comments":[{"had_liked":false,"id":307499,"user_name":"Sch0ng","can_delete":false,"product_type":"c1","uid":1145554,"ip_address":"","ucode":"73F6113931B1AC","user_header":"https://static001.geekbang.org/account/avatar/00/11/7a/d2/4ba67c0c.jpg","comment_is_top":false,"comment_ctime":1629125381,"is_pvip":false,"replies":[{"id":"111382","content":"是这样的，老哥学习课程很认真！","user_name":"作者回复","comment_id":307499,"uid":"1167883","ip_address":"","utype":1,"ctime":1629242622,"user_name_real":"CK1.0"}],"discussion_count":1,"race_medal":0,"score":"27398929157","product_id":100079601,"comment_content":"go语言中，orm使用gorm包。<br>gorm功能全，操作界面符合直觉，不需要额外的理解负担。","like_count":6,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"孔令飞","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":525178,"discussion_content":"是这样的，老哥学习课程很认真！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629242622,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":324513,"user_name":"yandongxiao","can_delete":false,"product_type":"c1","uid":1017700,"ip_address":"","ucode":"D397F4DB0109C8","user_header":"https://static001.geekbang.org/account/avatar/00/0f/87/64/3882d90d.jpg","comment_is_top":false,"comment_ctime":1638466804,"is_pvip":false,"replies":[{"id":"118461","content":"6666","user_name":"作者回复","comment_id":324513,"uid":"1167883","ip_address":"","utype":1,"ctime":1639453830,"user_name_real":"编辑"}],"discussion_count":1,"race_medal":0,"score":"10228401396","product_id":100079601,"comment_content":"总结：<br>1. 首先定义一个 GORM 模型（Models），GORM模型就是一个普普通通的golang struct。使用结构体名的 snake_cases 作为表名，使用字段名的 snake_case 作为列名。<br>2. gorm.Model 为表增加了 ID、CreatedAt、UpdatedAt、DeletedAt 等字段。如果是资源表，建议统一资源的元数据。参见第29章节。<br>3. 在结构体中，通过 tag，指定数据库中字段的名称。<br>4. gorm 支持表CRUD操作，每种操作也会有各种变形，与 数据库操作相对应。<br>","like_count":2,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"孔令飞","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":538600,"discussion_content":"6666","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639453830,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":320640,"user_name":"helloworld","can_delete":false,"product_type":"c1","uid":1105161,"ip_address":"","ucode":"1EECCA0F43E278","user_header":"https://static001.geekbang.org/account/avatar/00/10/dd/09/feca820a.jpg","comment_is_top":false,"comment_ctime":1636433611,"is_pvip":false,"replies":[{"id":"116854","content":"感谢反馈，我修复下","user_name":"作者回复","comment_id":320640,"uid":"1167883","ip_address":"","utype":1,"ctime":1637061916,"user_name_real":"编辑"}],"discussion_count":1,"race_medal":0,"score":"10226368203","product_id":100079601,"comment_content":"测试发现项目中的软删除功能不起作用, 需要将源码<br>https:&#47;&#47;github.com&#47;marmotedu&#47;component-base&#47;blob&#47;master&#47;pkg&#47;meta&#47;v1&#47;types.go 中的<br>DeletedAt *time.Time `json:&quot;-&quot; gorm:&quot;column:deletedAt;index:idx_deletedAt&quot;` <br>改为: \t<br>DeletedAt gorm.DeletedAt `json:&quot;-&quot; gorm:&quot;index;column:deletedAt&quot;`<br><br>","like_count":2,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"孔令飞","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":530371,"discussion_content":"感谢反馈，我修复下","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637061916,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":315847,"user_name":"XI","can_delete":false,"product_type":"c1","uid":2187234,"ip_address":"","ucode":"2CEBC094EA1E87","user_header":"https://static001.geekbang.org/account/avatar/00/21/5f/e2/e6d3d9bf.jpg","comment_is_top":false,"comment_ctime":1634021299,"is_pvip":false,"replies":[{"id":"114947","content":"回头整理下。","user_name":"作者回复","comment_id":315847,"uid":"1167883","ip_address":"","utype":1,"ctime":1634743643,"user_name_real":"孔令飞"}],"discussion_count":1,"race_medal":0,"score":"10223955891","product_id":100079601,"comment_content":"go的连接池网上教程有点少，go 连接redis,monggodb 应该都需要连接池，gorm官方文档连接池的讲解也是寥寥数语，老师能不能详细补充点连接池相关的，如何使用，如果能再加上redis ，mongdb 的连接池一类的就更好了","like_count":2,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"孔令飞","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":528183,"discussion_content":"回头整理下。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634743643,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":324630,"user_name":"liaomars","can_delete":false,"product_type":"c1","uid":2104856,"ip_address":"","ucode":"4FCA97EE9FB57D","user_header":"https://static001.geekbang.org/account/avatar/00/20/1e/18/9d1f1439.jpg","comment_is_top":false,"comment_ctime":1638521515,"is_pvip":false,"replies":[{"id":"118348","content":"100哈，代码我找编辑更正下。","user_name":"作者回复","comment_id":324630,"uid":"1167883","ip_address":"","utype":1,"ctime":1639400090,"user_name_real":"编辑"}],"discussion_count":1,"race_medal":0,"score":"5933488811","product_id":100079601,"comment_content":"老师：<br>sqlDB.SetMaxIdleConns(10)              &#47;&#47; 设置MySQL的最大空闲连接数（推荐100）<br>这个最大空闲连接数是10还是100？代码写的是10，注释写的是100","like_count":1,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"孔令飞","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":538345,"discussion_content":"100哈，代码我找编辑更正下。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639400090,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":323512,"user_name":"刘世杰","can_delete":false,"product_type":"c1","uid":2847254,"ip_address":"","ucode":"1AB733184E732A","user_header":"","comment_is_top":false,"comment_ctime":1637941686,"is_pvip":false,"replies":[{"id":"117699","content":"没用过 github.com&#47;go-xorm&#47;xorm这个包。<br><br>建议使用gorm包哈，有问题可以问我，这个包我熟悉","user_name":"作者回复","comment_id":323512,"uid":"1167883","ip_address":"","utype":1,"ctime":1638363509,"user_name_real":"编辑"}],"discussion_count":1,"race_medal":0,"score":"5932908982","product_id":100079601,"comment_content":"老师您好，<br>我在使用 github.com&#47;go-xorm&#47;xorm 这个包连接 mycat 的时候<br>当我执行带 ? 号的 sql 语句时出现 {&quot;Number&quot;:1047,&quot;Message&quot;:&quot;Prepare unsupported!&quot;} 报错<br>我应该怎么配置连接信息呢？<br>以下是我的数据库连接信息<br>user:pass@tcp(127.0.0.1:3306)&#47;db?charset=utf8&amp;interpolateparams=true<br>以下是我执行的代码<br>engine := model.Get()<br>uid := 1<br>var list []model.User<br>res1 := engine.SQL(&quot;select * from tr_user where id = ?&quot;, uid).Find(&amp;list)<br>res := engine.SQL(&quot;select * from tr_user where id = 1&quot;).Find(&amp;list)<br>data := map[string]interface{}{<br>\t&quot;userid&quot;: con.Uid,<br>\t&quot;res&quot;: res,<br>\t&quot;res1&quot;: res1,<br>\t&quot;list&quot;: list,<br>}<br>以上 res1 打印的信息是 &quot;res1&quot;:{&quot;Number&quot;:1047,&quot;Message&quot;:&quot;Prepare unsupported!&quot;}<br>res 运行的 sql 能够正常运行<br>直连数据库的时候，本地连接数据库，以上代码均正常<br>使用 mycat 时，无法正常执行 sql<br>网上看了一些文档，说是 interpolateparams 这个参数的问题，但是我试了都没有用","like_count":1,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"孔令飞","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":535184,"discussion_content":"没用过 github.com/go-xorm/xorm这个包。\n\n建议使用gorm包哈，有问题可以问我，这个包我熟悉","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638363509,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":322938,"user_name":"徐海浪","can_delete":false,"product_type":"c1","uid":1078528,"ip_address":"","ucode":"21801C420D0610","user_header":"https://static001.geekbang.org/account/avatar/00/10/75/00/618b20da.jpg","comment_is_top":false,"comment_ctime":1637666398,"is_pvip":false,"replies":[{"id":"117683","content":"是的，生产环境最好别使用AutoMigrate","user_name":"作者回复","comment_id":322938,"uid":"1167883","ip_address":"","utype":1,"ctime":1638362605,"user_name_real":"编辑"}],"discussion_count":2,"race_medal":1,"score":"5932633694","product_id":100079601,"comment_content":"生产环境不应该使用AutoMigrate，除非有靠谱的code review流程，否则随着协作的人数越多，越容易失控","like_count":1,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"孔令飞","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":535164,"discussion_content":"是的，生产环境最好别使用AutoMigrate","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638362605,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1800603,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/79/9b/66570110.jpg","nickname":"土拨鼠","note":"","ucode":"716867DA4C85D5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":534059,"discussion_content":"开发之前就应该定义好相关的数据库格式，数据库的格式一般不会变动的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638083527,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":319985,"user_name":"helloworld","can_delete":false,"product_type":"c1","uid":1105161,"ip_address":"","ucode":"1EECCA0F43E278","user_header":"https://static001.geekbang.org/account/avatar/00/10/dd/09/feca820a.jpg","comment_is_top":false,"comment_ctime":1636028105,"is_pvip":false,"replies":[{"id":"116892","content":"GetMySQLFactoryOr这个函数如果实例不存在会返回err，这个地方你可以根据需要，判断err是否为nil，如果!=nil，可以终止程序。<br><br>iam之所以没有退出，原因如下：<br>1. 后续在执行请求时，如果初始化数据库失败，请求会报错，也就是说，如果初始化数据库失败，一定能够被感知到，并被修复。<br>2. 当时是方便测试吧，数据库初始化失败，不会影响程序启动，不会影响其他功能。","user_name":"作者回复","comment_id":319985,"uid":"1167883","ip_address":"","utype":1,"ctime":1637078995,"user_name_real":"编辑"}],"discussion_count":1,"race_medal":0,"score":"5930995401","product_id":100079601,"comment_content":"看了下iam启动过程的源码，发现依赖的mysql实例获取不到也不会退出程序，个人感觉这样设计是否更好：写两个函数，一个用来初始化mysql单例，一个用来获取mysql单例，在server的Preparerun函数中来初始化，初始化失败则退出程序提示用户，在router中来获取已经初始化过的mysql单例，这样感觉更清晰一些～","like_count":1,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"孔令飞","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":530527,"discussion_content":"GetMySQLFactoryOr这个函数如果实例不存在会返回err，这个地方你可以根据需要，判断err是否为nil，如果!=nil，可以终止程序。\n\niam之所以没有退出，原因如下：\n1. 后续在执行请求时，如果初始化数据库失败，请求会报错，也就是说，如果初始化数据库失败，一定能够被感知到，并被修复。\n2. 当时是方便测试吧，数据库初始化失败，不会影响程序启动，不会影响其他功能。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637078995,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":318529,"user_name":"Derek","can_delete":false,"product_type":"c1","uid":1146983,"ip_address":"","ucode":"A4D5DED1E00F60","user_header":"https://static001.geekbang.org/account/avatar/00/11/80/67/4e381da5.jpg","comment_is_top":false,"comment_ctime":1635324346,"is_pvip":false,"replies":[{"id":"115979","content":"可以这么来定义下：<br>&#47;&#47; Factory defines the iam platform storage interface.    <br>type DBIns2Store interface { <br>    Users() UserStore<br>    Secrets() SecretStore<br>    Policies() PolicyStore<br>    Close() error<br>}<br><br>type DBIns2Store interface { <br>}<br><br>type Factory interface {               <br>    DBIns1Store DBIns2Store                                                           <br>    DBIns2Store DBIns2Store                            <br>}","user_name":"作者回复","comment_id":318529,"uid":"1167883","ip_address":"","utype":1,"ctime":1636005222,"user_name_real":"孔令飞"}],"discussion_count":1,"race_medal":0,"score":"5930291642","product_id":100079601,"comment_content":"老师，拿要是连接多个数据库，不同的struct使用不同的库要怎么搞，是不是要初始化好几个连接，然后指定一下struct用的库？","like_count":1,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"孔令飞","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":529286,"discussion_content":"可以这么来定义下：\n// Factory defines the iam platform storage interface.    \ntype DBIns2Store interface { \n    Users() UserStore\n    Secrets() SecretStore\n    Policies() PolicyStore\n    Close() error\n}\n\ntype DBIns2Store interface { \n}\n\ntype Factory interface {               \n    DBIns1Store DBIns2Store                                                           \n    DBIns2Store DBIns2Store                            \n}","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1636005222,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":312142,"user_name":"潘达","can_delete":false,"product_type":"c1","uid":1119323,"ip_address":"","ucode":"90F60F47063956","user_header":"https://static001.geekbang.org/account/avatar/00/11/14/5b/a1656a72.jpg","comment_is_top":false,"comment_ctime":1631662775,"is_pvip":false,"replies":[{"id":"113683","content":"试试这个：https:&#47;&#47;github.com&#47;Shelnutt2&#47;db2struct","user_name":"作者回复","comment_id":312142,"uid":"1167883","ip_address":"","utype":1,"ctime":1632759765,"user_name_real":"CK1.0"}],"discussion_count":1,"race_medal":0,"score":"5926630071","product_id":100079601,"comment_content":"gorm下是否有从表中直接生成struct的工具呢，xorm下的反向生成工具还是挺实用的","like_count":1,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"孔令飞","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":526876,"discussion_content":"试试这个：https://github.com/Shelnutt2/db2struct","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632759765,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":306921,"user_name":"helloworld","can_delete":false,"product_type":"c1","uid":1105161,"ip_address":"","ucode":"1EECCA0F43E278","user_header":"https://static001.geekbang.org/account/avatar/00/10/dd/09/feca820a.jpg","comment_is_top":false,"comment_ctime":1628776912,"is_pvip":false,"replies":[{"id":"111396","content":"这里写的有问题，我找编辑更新下，感谢反馈","user_name":"作者回复","comment_id":306921,"uid":"1167883","ip_address":"","utype":1,"ctime":1629243469,"user_name_real":"CK1.0"}],"discussion_count":1,"race_medal":0,"score":"5923744208","product_id":100079601,"comment_content":"“如果没有指定表名，则 GORM 使用结构体名的蛇形复数作为表名。例如：结构体名为 DockerInstance ，则表名为 dockerInstances 。”，蛇形不是下划线连接吗","like_count":1,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"孔令飞","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":524975,"discussion_content":"这里写的有问题，我找编辑更新下，感谢反馈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629243469,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":306229,"user_name":"二三闲语","can_delete":false,"product_type":"c1","uid":1418587,"ip_address":"","ucode":"7948FFF9712432","user_header":"https://static001.geekbang.org/account/avatar/00/15/a5/5b/164dc7d2.jpg","comment_is_top":false,"comment_ctime":1628441877,"is_pvip":false,"replies":[{"id":"110897","content":"主从，是mysql实例层保证的，应用层可以不用关注。<br><br>多库，可以参照现有的实现，在Store层添加一个新的db实例","user_name":"作者回复","comment_id":306229,"uid":"1167883","ip_address":"","utype":1,"ctime":1628524636,"user_name_real":"CK1.0"}],"discussion_count":3,"race_medal":0,"score":"5923409173","product_id":100079601,"comment_content":"怎么配置主从，多库","like_count":1,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"孔令飞","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":524673,"discussion_content":"主从，是mysql实例层保证的，应用层可以不用关注。\n\n多库，可以参照现有的实现，在Store层添加一个新的db实例","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628524636,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2654999,"avatar":"https://static001.geekbang.org/account/avatar/00/28/83/17/df99b53d.jpg","nickname":"随风而过","note":"","ucode":"FFD17BAA3B2312","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":392400,"discussion_content":"配置主从很简单，mysql配置文件 指定一个master 一个slave（主要同步延迟问题），多数据源gorm文档有","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1630996051,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1059873,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLsia5hqVlTLn17lUBwSpSUzraib7MSH3gOUNWOx8qUwpz3Lp6gFtkIibOMUAouyMGj5RIeTcePUfNkw/132","nickname":"jg4igianshu","note":"","ucode":"DE1001BF2D383E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":388175,"discussion_content":"参考文档https://gorm.io/zh_CN/docs/dbresolver.html","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1628644488,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":305395,"user_name":"友","can_delete":false,"product_type":"c1","uid":2536820,"ip_address":"","ucode":"972A4333A8B101","user_header":"https://static001.geekbang.org/account/avatar/00/26/b5/74/cd80b9f4.jpg","comment_is_top":false,"comment_ctime":1627957953,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5922925249","product_id":100079601,"comment_content":"目前用过几款orm。有beego自带的  gorm ent","like_count":1},{"had_liked":false,"id":305394,"user_name":"那时刻","can_delete":false,"product_type":"c1","uid":1150927,"ip_address":"","ucode":"B0D150856C3A4A","user_header":"https://static001.geekbang.org/account/avatar/00/11/8f/cf/890f82d6.jpg","comment_is_top":false,"comment_ctime":1627957952,"is_pvip":false,"replies":[{"id":"110638","content":"不用哈，如果没连接成功功能测试时，你是能感觉到的，那时候可以修复下。<br><br>不过加上也可以","user_name":"作者回复","comment_id":305394,"uid":"1167883","ip_address":"","utype":1,"ctime":1628165674,"user_name_real":"CK1.0"}],"discussion_count":1,"race_medal":1,"score":"5922925248","product_id":100079601,"comment_content":"请问老师，在链接数据库New方法里，是否要调用下sqlDB.ping来确定链接是否成功呢？","like_count":1,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"孔令飞","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":524374,"discussion_content":"不用哈，如果没连接成功功能测试时，你是能感觉到的，那时候可以修复下。\n\n不过加上也可以","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628165674,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":305369,"user_name":"pedro","can_delete":false,"product_type":"c1","uid":1200704,"ip_address":"","ucode":"F40C839DDFD599","user_header":"https://static001.geekbang.org/account/avatar/00/12/52/40/e57a736e.jpg","comment_is_top":false,"comment_ctime":1627947541,"is_pvip":false,"replies":[{"id":"110639","content":"是的呀，最好别用AutoMigrate","user_name":"作者回复","comment_id":305369,"uid":"1167883","ip_address":"","utype":1,"ctime":1628165694,"user_name_real":"CK1.0"}],"discussion_count":3,"race_medal":0,"score":"5922914837","product_id":100079601,"comment_content":"GORM 支持 AutoMigrate 功能，思考下，你的生产环境是否可以使用 AutoMigrate 功能，为什么？<br><br>肯定不能啊，生产环境严格的要死，提交的SQL都要一圈的审核，怎么能直接偏移，爆炸了年奖全都没了","like_count":1,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"孔令飞","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":524366,"discussion_content":"是的呀，最好别用AutoMigrate","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628165694,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2536820,"avatar":"https://static001.geekbang.org/account/avatar/00/26/b5/74/cd80b9f4.jpg","nickname":"友","note":"","ucode":"972A4333A8B101","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":387038,"discussion_content":"我目前在小公司都是直接auromigrate 🌚🌚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627957912,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2654999,"avatar":"https://static001.geekbang.org/account/avatar/00/28/83/17/df99b53d.jpg","nickname":"随风而过","note":"","ucode":"FFD17BAA3B2312","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2536820,"avatar":"https://static001.geekbang.org/account/avatar/00/26/b5/74/cd80b9f4.jpg","nickname":"友","note":"","ucode":"972A4333A8B101","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":392401,"discussion_content":"谨慎使用，小心删库跑路","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630996135,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":387038,"ip_address":""},"score":392401,"extra":""}]}]},{"had_liked":false,"id":360671,"user_name":"czy","can_delete":false,"product_type":"c1","uid":2398831,"ip_address":"北京","ucode":"660826F2ABA3E4","user_header":"https://static001.geekbang.org/account/avatar/00/24/9a/6f/c4490cf2.jpg","comment_is_top":false,"comment_ctime":1666747332,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1666747332","product_id":100079601,"comment_content":"<br>&#47;&#47; DELETE from users where id = 10 AND name = &quot;jinzhu&quot;;<br>db.Where(&quot;name = ?&quot;, &quot;jinzhu&quot;).Delete(&amp;user)<br>这段代码是不是有问题？没有添加id过滤条件呀？","like_count":0},{"had_liked":false,"id":356733,"user_name":"Geek_c2083d","can_delete":false,"product_type":"c1","uid":3170814,"ip_address":"福建","ucode":"124E13F664E45A","user_header":"","comment_is_top":false,"comment_ctime":1662539777,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1662539777","product_id":100079601,"comment_content":"java用惯了mybatis-plus 感觉这个好难用呀，sql写在代码里面不是很难维护码，","like_count":0},{"had_liked":false,"id":353285,"user_name":"wei 丶","can_delete":false,"product_type":"c1","uid":1234929,"ip_address":"北京","ucode":"331DE893F75B95","user_header":"https://static001.geekbang.org/account/avatar/00/12/d7/f1/ce10759d.jpg","comment_is_top":false,"comment_ctime":1659332828,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1659332828","product_id":100079601,"comment_content":"孔大，ent咋样 有没有ent的讲解呢 👀","like_count":0},{"had_liked":false,"id":345416,"user_name":"左耳朵东","can_delete":false,"product_type":"c1","uid":1160678,"ip_address":"","ucode":"60134ACF12BB52","user_header":"https://static001.geekbang.org/account/avatar/00/11/b5/e6/c67f12bd.jpg","comment_is_top":false,"comment_ctime":1652258694,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1652258694","product_id":100079601,"comment_content":"“接着，在PrepareRun函数中，调用GetMySQLFactoryOr函数，初始化并获取仓库层的实例mysqlFactory” <br>PrepareRun 函数中调用 GetMySQLFactoryOr 获取的仓库层实例是为了在优雅关停时关闭数据库，初始化仓库层实例步骤是在这个方法里完成的：func (c *completedExtraConfig) New() (*grpcAPIServer, error)","like_count":0},{"had_liked":false,"id":333395,"user_name":"yangchnet","can_delete":false,"product_type":"c1","uid":1805922,"ip_address":"","ucode":"0527DE4777A5DB","user_header":"https://static001.geekbang.org/account/avatar/00/1b/8e/62/5cb377fd.jpg","comment_is_top":false,"comment_ctime":1644323579,"is_pvip":true,"replies":[{"id":"123445","content":"1. 不了解<br>2. MySQL数据库迁移吗，这个可以github上或者网上搜索下，如何搜索，可以参考：结束语 | 如何让自己的 Go 研发之路走得更远？里面如何选择开源项目的指南","user_name":"作者回复","comment_id":333395,"uid":"1167883","ip_address":"","utype":1,"ctime":1647039431,"user_name_real":"编辑"}],"discussion_count":1,"race_medal":0,"score":"1644323579","product_id":100079601,"comment_content":"问题：<br>1. 请问老师了解sqlc这个包吗<br>2. 数据库版本迁移老师有没有靠谱好用的工具推荐","like_count":0,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"孔令飞","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":555705,"discussion_content":"1. 不了解\n2. MySQL数据库迁移吗，这个可以github上或者网上搜索下，如何搜索，可以参考：结束语 | 如何让自己的 Go 研发之路走得更远？里面如何选择开源项目的指南","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1647039432,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":327688,"user_name":"geek_geek","can_delete":false,"product_type":"c1","uid":2656812,"ip_address":"","ucode":"30DDE06BB2FA2D","user_header":"","comment_is_top":false,"comment_ctime":1640239106,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1640239106","product_id":100079601,"comment_content":"老是请问事物怎么启动？","like_count":0},{"had_liked":false,"id":326494,"user_name":"huining","can_delete":false,"product_type":"c1","uid":2723681,"ip_address":"","ucode":"68645DEC41B191","user_header":"https://static001.geekbang.org/account/avatar/00/29/8f/61/cf0d0a95.jpg","comment_is_top":false,"comment_ctime":1639539826,"is_pvip":false,"replies":[{"id":"119694","content":"如果要用事务，肯定是要传*db参数。<br><br>或者在失败时调用defer func() {s.srv.Delete()}()这样的语句，来回滚","user_name":"作者回复","user_name_real":"编辑","uid":"1167883","ctime":1640824806,"ip_address":"","comment_id":326494,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1639539826","product_id":100079601,"comment_content":"如果按照这样写，那用不了事务啊，比如老师的代码里删除用户时，是先调用polices.delete(),然后再delete用户，那假如中途出错，也无法回滚。我的做法是再加一个*DB参数，但是感觉写起来很丑，方法里要判断之前是否启动了事务。所以如果想要添加对事务的支持应该怎么做呢？","like_count":0,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"孔令飞","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":542637,"discussion_content":"如果要用事务，肯定是要传*db参数。\n\n或者在失败时调用defer func() {s.srv.Delete()}()这样的语句，来回滚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640824806,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":326306,"user_name":"邵俊达","can_delete":false,"product_type":"c1","uid":1281460,"ip_address":"","ucode":"4B7DACE6DBCF95","user_header":"https://static001.geekbang.org/account/avatar/00/13/8d/b4/ff82483d.jpg","comment_is_top":false,"comment_ctime":1639466108,"is_pvip":false,"replies":[{"id":"119692","content":"是的，可能要用另外的封装方式了","user_name":"作者回复","user_name_real":"编辑","uid":"1167883","ctime":1640824689,"ip_address":"","comment_id":326306,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1639466108","product_id":100079601,"comment_content":"请问 gorm 如何处理操作多张表的事务？比如类似<br>```<br>begin<br> User.save<br> Book.update<br> Account.update<br>commit<br>```<br><br>用 gorm 的 transaction 就要用他的 tx 来操作数据，那封装好的 dao 是不是就没法用了？","like_count":0,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"孔令飞","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":542635,"discussion_content":"是的，可能要用另外的封装方式了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640824689,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":307237,"user_name":"先听","can_delete":false,"product_type":"c1","uid":1151409,"ip_address":"","ucode":"82D8DA7A2FEB4B","user_header":"https://static001.geekbang.org/account/avatar/00/11/91/b1/fb117c21.jpg","comment_is_top":false,"comment_ctime":1628957533,"is_pvip":false,"replies":[{"id":"111387","content":"根据需要自行封装吧","user_name":"作者回复","user_name_real":"CK1.0","uid":"1167883","ctime":1629242935,"ip_address":"","comment_id":307237,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1628957533","product_id":100079601,"comment_content":"请问 事务的嵌套，有没有什么好的解决方案呢","like_count":0,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"孔令飞","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":525090,"discussion_content":"根据需要自行封装吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629242935,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}