{"id":1609,"title":"26 | 分布式系统关键技术：流量与数据调度","content":"<p>你好，我是陈皓，网名左耳朵耗子。</p>\n<p>关于流量调度，现在很多架构师都把这个事和服务治理混为一谈了。我觉得还是应该分开的。一方面，服务治理是内部系统的事，而流量调度可以是内部的，更是外部接入层的事。另一方面，服务治理是数据中心的事，而流量调度要做得好，应该是数据中心之外的事，也就是我们常说的边缘计算，是应该在类似于CDN上完成的事。</p>\n<p>所以，流量调度和服务治理是在不同层面上的，不应该混在一起，所以在系统架构上应该把它们分开。</p>\n<h1>流量调度的主要功能</h1>\n<p>对于一个流量调度系统来说，其应该具有的主要功能是：</p>\n<ol>\n<li>\n<p>依据系统运行的情况，自动地进行流量调度，在无需人工干预的情况下，提升整个系统的稳定性；</p>\n</li>\n<li>\n<p>让系统应对爆品等突发事件时，在弹性计算扩缩容的较长时间窗口内或底层资源消耗殆尽的情况下，保护系统平稳运行。</p>\n</li>\n</ol>\n<p>这还是为了提高系统架构的稳定性和高可用性。</p>\n<p>此外，这个流量调度系统还可以完成以下几方面的事情。</p>\n<ul>\n<li><strong>服务流控</strong>。服务发现、服务路由、服务降级、服务熔断、服务保护等。</li>\n<li><strong>流量控制</strong>。负载均衡、流量分配、流量控制、异地灾备（多活）等。</li>\n<li><strong>流量管理</strong>。协议转换、请求校验、数据缓存、数据计算等。</li>\n</ul>\n<p>所有的这些都应该是一个API Gateway应该做的事。</p>\n<h1>流量调度的关键技术</h1>\n<p>但是，作为一个API Gateway来说，因为要调度流量，首先需要扛住流量，而且还需要有一些比较轻量的业务逻辑，所以一个好的API Gateway需要具备以下的关键技术。</p>\n<!-- [[[read_end]]] -->\n<ol>\n<li>\n<p><strong>高性能</strong>。API Gateway必须使用高性能的技术，所以，也就需要使用高性能的语言。</p>\n</li>\n<li>\n<p><strong>扛流量</strong>。要能扛流量，就需要使用集群技术。集群技术的关键点是在集群内的各个结点中共享数据。这就需要使用像Paxos、Raft、Gossip这样的通讯协议。因为Gateway需要部署在广域网上，所以还需要集群的分组技术。</p>\n</li>\n<li>\n<p><strong>业务逻辑</strong>。API Gateway需要有简单的业务逻辑，所以，最好是像AWS的Lambda 服务一样，可以让人注入不同语言的简单业务逻辑。</p>\n</li>\n<li>\n<p><strong>服务化</strong>。一个好的API Gateway需要能够通过Admin API来不停机地管理配置变更，而不是通过一个.conf文件来人肉地修改配置。</p>\n</li>\n</ol>\n<p>基于上述的这几个技术要求，就其本质来说，目前可以做成这样的API Gateway几乎没有。这也是为什么我现在自己自主开发的原因（你可以到我的官网MegaEase.com上查看相关的产品和技术信息）。</p>\n<h1>状态数据调度</h1>\n<p>对于服务调度来说，最难办的就是有状态的服务了。这里的状态是State，也就是说，有些服务会保存一些数据，而这些数据是不能丢失的，所以，这些数据是需要随服务一起调度的。</p>\n<p>一般来说，我们会通过“转移问题”的方法来让服务变成“无状态的服务”。也就是说，会把这些有状态的东西存储到第三方服务上，比如Redis、MySQL、ZooKeeper，或是NFS、Ceph的文件系统中。</p>\n<p>这些“转移问题”的方式把问题转移到了第三方服务上，于是自己的Java或PHP服务中没有状态，但是Redis和MySQL上则有了状态。所以，我们可以看到，现在的分布式系统架构中出问题的基本都是这些存储状态的服务。</p>\n<p>因为数据存储结点在Scale上比较困难，所以成了一个单点的瓶颈。</p>\n<h1>分布式事务一致性的问题</h1>\n<p>要解决数据结点的Scale问题，也就是让数据服务可以像无状态的服务一样在不同的机器上进行调度，这就会涉及数据的replication问题。而数据replication则会带来数据一致性的问题，进而对性能带来严重的影响。</p>\n<p>要解决数据不丢失的问题，只能通过数据冗余的方法，就算是数据分区，每个区也需要进行数据冗余处理。这就是数据副本。当出现某个节点的数据丢失时，可以从副本读到。数据副本是分布式系统解决数据丢失异常的唯一手段。简单来说：</p>\n<ol>\n<li>要想让数据有高可用性，就得写多份数据。</li>\n<li>写多份会引起数据一致性的问题。</li>\n<li>数据一致性的问题又会引发性能问题。</li>\n</ol>\n<p>在解决数据副本间的一致性问题时，我们有一些技术方案。</p>\n<ul>\n<li>Master-Slave方案。</li>\n<li>Master-Master方案。</li>\n<li>两阶段和三阶段提交方案。</li>\n<li>Paxos方案。</li>\n</ul>\n<p>你可以仔细地读一下我在3年前写的<a href=\"https://coolshell.cn/articles/10910.html\">《分布式系统的事务处理》这篇文章</a>。其中我引用了Google App Engine联合创始人赖安·巴里特（Ryan Barrett）在2009年Google I/O上的演讲<a href=\"http://www.youtube.com/watch?v=srOgpXECblk\">Transaction Across DataCenter视频</a> 中的一张图。</p>\n<p><img src=\"https://static001.geekbang.org/resource/image/82/33/826e501a90a297815469564d23454233.jpg?wh=1563x1134\" alt=\"\" /><br />\n从上面这张经典的图中，我们可以看到各种不同方案的对比。</p>\n<p>现在，很多公司的分布式系统事务基本上都是两阶段提交的变种。比如：阿里推出的TCC–Try–Confirm–Cancel，或是我在亚马逊见到的Plan–Reserve–Confirm的方式，等等。凡是通过业务补偿，或是在业务应用层上做的分布式事务的玩法，基本上都是两阶段提交，或是两阶段提交的变种。</p>\n<p>换句话说，迄今为止，在应用层上解决事务问题，只有“两阶段提交”这样的方式，而在数据层解决事务问题，Paxos算法则是不二之选。</p>\n<h1>数据结点的分布式方案</h1>\n<p>真正完整解决数据Scale问题的应该还是数据结点自身。只有数据结点自身解决了这个问题，才能做到对上层业务层的透明，业务层可以像操作单机数据库一样来操作分布式数据库，这样才能做到整个分布式服务架构的调度。</p>\n<p>也就是说，这个问题应该解决在数据存储方。但是因为数据存储结果有太多不同的Scheme，所以现在的数据存储也是多种多样的，有文件系统，有对象型的，有Key-Value式，有时序的，有搜索型的，有关系型的……</p>\n<p>这就是为什么分布式数据存储系统比较难做，因为很难做出来一个放之四海皆准的方案。类比一下编程中的各种不同的数据结构你就会明白为什么会有这么多的数据存储方案了。</p>\n<p>但是我们可以看到，这个“数据存储的动物园”中，基本上都在解决数据副本、数据一致性和分布式事务的问题。</p>\n<p>比如AWS的Aurora，就是改写了MySQL的InnoDB引擎。为了承诺高可用的SLA，所以需要写6个副本，但实现方式上，它不像MySQL通过bin log的数据复制方式，而是更为“惊艳”地复制SQL语句，然后拼命地使用各种tricky的方式来降低latency。比如，使用多线程并行、使用SQL操作的merge等。</p>\n<p>MySQL官方也有MySQL Cluster的技术方案。此外，MongoDB、国内的PingCAP的TiDB、国外的CockroachDB，还有阿里的OceanBase都是为了解决大规模数据的写入和读取的问题而出现的数据库软件。所以，我觉得成熟的可以用到生产线上的分布式数据库这个事估计也不远了。</p>\n<p>而对于一些需要文件存储的，则需要分布式文件系统的支持。试想，一个Kafka或ZooKeeper需要把它们的数据存储到文件系统上。当这个结点有问题时，我们需要再启动一个Kafka或ZooKeeper的实例，那么也需要把它们持久化的数据搬迁到另一台机器上。</p>\n<p>（注意，虽然Kafka和ZooKeeper是HA的，数据会在不同的结点中进行复制，但是我们也应该搬迁数据，这样有利用于新结点的快速启动。否则，新的结点需要等待数据同步，这个时间会比较长，可能会导致数据层的其它问题。）</p>\n<p>于是，我们就需要一个底层是分布式的文件系统，这样新的结点只需要做一个简单的远程文件系统的mount就可以把数据调度到另外一台机器上了。</p>\n<p>所以，真正解决数据结点调度的方案应该是底层的数据结点。在它们上面做这个事才是真正有效和优雅的。而像阿里的用于分库分表的数据库中间件TDDL或是别的公司叫什么DAL之类的这样的中间件都会成为过渡技术。</p>\n<h2>状态数据调度小结</h2>\n<p>接下来，我们对状态数据调度做个小小的总结。</p>\n<ul>\n<li>\n<p>对于应用层上的分布式事务一致性，只有两阶段提交这样的方式。</p>\n</li>\n<li>\n<p>而底层存储可以解决这个问题的方式是通过一些像Paxos、Raft或是NWR这样的算法和模型来解决。</p>\n</li>\n<li>\n<p>状态数据调度应该是由分布式存储系统来解决的，这样会更为完美。但是因为数据存储的Scheme太多，所以，导致我们有各式各样的分布式存储系统，有文件对象的，有关系型数据库的，有NoSQL的，有时序数据的，有搜索数据的，有队列的……</p>\n</li>\n</ul>\n<p>总之，我相信状态数据调度应该是在IaaS层的数据存储解决的问题，而不是在PaaS层或者SaaS层来解决的。</p>\n<p>在IaaS层上解决这个问题，一般来说有三种方案，一种是使用比较廉价的开源产品，如：NFS、Ceph、TiDB、CockroachDB、ElasticSearch、InfluxDB、MySQL Cluster和Redis Cluster之类的；另一种是用云计算厂商的方案。当然，如果不差钱的话，可以使用更为昂贵的商业网络存储方案。</p>\n<h1>小结</h1>\n<p>回顾一下今天分享的主要内容。首先，我先明确表态，不要将流量调度和服务治理混为一谈（当然，服务治理是流量调度的前提），并比较了两者有何不同。</p>\n<p>然后，讲述了流量调度的主要功能和关键技术。接着进入本文的第二个话题——状态数据调度，讲述了真正完整解决数据Scale问题的应该还是数据结点自身，并给出了相应的技术方案，随后对状态数据调度进行了小结。</p>\n<p>欢迎你也谈一谈自己经历过的技术场景中是采用了哪些流量和数据调度的技术和产品，遇到过什么样的问题，是怎样解决的？</p>\n<p>下节课中，我们将开启一个全新的话题——洞悉PaaS平台的本质。</p>\n<p>下面我列出了系列课程《分布式系统架构的本质》的目录，以方便你快速找到自己感兴趣的内容。如果你在分布式系统架构方面，有其他想了解的话题和内容，欢迎留言给我。</p>\n<ul>\n<li><a href=\"https://time.geekbang.org/column/article/1411\">分布式系统架构的冰与火</a></li>\n<li><a href=\"https://time.geekbang.org/column/article/1505\">从亚马逊的实践，谈分布式系统的难点</a></li>\n<li><a href=\"https://time.geekbang.org/column/article/1512\">分布式系统的技术栈</a></li>\n<li><a href=\"https://time.geekbang.org/column/article/1513\">分布式系统关键技术：全栈监控</a></li>\n<li><a href=\"https://time.geekbang.org/column/article/1604\">分布式系统关键技术：服务调度</a></li>\n<li><a href=\"https://time.geekbang.org/column/article/1609\">分布式系统关键技术：流量与数据调度</a></li>\n<li><a href=\"https://time.geekbang.org/column/article/1610\">洞悉PaaS平台的本质</a></li>\n<li><a href=\"https://time.geekbang.org/column/article/2080\">推荐阅读：分布式系统架构经典资料</a></li>\n<li><a href=\"https://time.geekbang.org/column/article/2421\">推荐阅读：分布式数据调度相关论文</a></li>\n</ul>\n","neighbors":{"left":{"article_title":"25 | 分布式系统关键技术：服务调度","id":1604},"right":{"article_title":"27 | 洞悉PaaS平台的本质","id":1610}},"comments":[{"had_liked":false,"id":1744,"user_name":"永靖","can_delete":false,"product_type":"c1","uid":1030310,"ip_address":"","ucode":"6CE95F363AC211","user_header":"https://wx.qlogo.cn/mmopen/vi_32/2nM9PaEsM4UiaUc0R3iaiaOumFVkcugGhdUObpEBq0bEKnjF6DSTmjsibFbmJHtUphfXsFGd1ueJwMoonia3jicyPC1w/132","comment_is_top":false,"comment_ctime":1514331046,"is_pvip":false,"replies":[{"id":"287","content":"你说的是语言吧。C&#47;C++、Java、Go。我觉的Go最好","user_name":"作者回复","user_name_real":"左耳朵","uid":"1001269","ctime":1514422591,"ip_address":"","comment_id":1744,"utype":1}],"discussion_count":2,"race_medal":0,"score":"121773415334","product_id":100002201,"comment_content":"APIGateway采用什么语音实现比较好？","like_count":28,"discussions":[{"author":{"id":1001269,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/35/89726f5f.jpg","nickname":"左耳朵","note":"","ucode":"8A4741D677702E","race_medal":0,"user_type":2,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":415517,"discussion_content":"你说的是语言吧。C/C++、Java、Go。我觉的Go最好","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1514422591,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1487584,"avatar":"https://static001.geekbang.org/account/avatar/00/16/b2/e0/d856f5a4.jpg","nickname":"鱼","note":"","ucode":"89EC9CE3AD0281","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":232172,"discussion_content":"基于OpenResty，然后参考kong的功能去自己实现。当然也可以直接购买kong。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586858648,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":1788,"user_name":"摇滚代码","can_delete":false,"product_type":"c1","uid":1008926,"ip_address":"","ucode":"99194B80D85F18","user_header":"https://static001.geekbang.org/account/avatar/00/0f/65/1e/083be80c.jpg","comment_is_top":false,"comment_ctime":1514461685,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"53054069237","product_id":100002201,"comment_content":"每一篇都值得精读，重复读","like_count":12},{"had_liked":false,"id":55395,"user_name":"钱","can_delete":false,"product_type":"c1","uid":1009652,"ip_address":"","ucode":"2C92A243A463D4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg","comment_is_top":false,"comment_ctime":1546158143,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"48790798399","product_id":100002201,"comment_content":"水平有限这节没完全理解，记一笔，后面再看几遍","like_count":11},{"had_liked":false,"id":28161,"user_name":"Ryoma","can_delete":false,"product_type":"c1","uid":1130590,"ip_address":"","ucode":"7F692369239692","user_header":"https://static001.geekbang.org/account/avatar/00/11/40/5e/b8fada94.jpg","comment_is_top":false,"comment_ctime":1538013462,"is_pvip":true,"replies":[{"id":"10736","content":"挺好的","user_name":"作者回复","user_name_real":"左耳朵","uid":"1001269","ctime":1538612674,"ip_address":"","comment_id":28161,"utype":1}],"discussion_count":1,"race_medal":2,"score":"44487686422","product_id":100002201,"comment_content":"耗子哥觉得 Kong 这个API Gateway如何？","like_count":10,"discussions":[{"author":{"id":1001269,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/35/89726f5f.jpg","nickname":"左耳朵","note":"","ucode":"8A4741D677702E","race_medal":0,"user_type":2,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":425160,"discussion_content":"挺好的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1538612674,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":9583,"user_name":"springchan","can_delete":false,"product_type":"c1","uid":1021742,"ip_address":"","ucode":"39D665D03EC6B7","user_header":"https://static001.geekbang.org/account/avatar/00/0f/97/2e/100345a3.jpg","comment_is_top":false,"comment_ctime":1526963539,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"40181669203","product_id":100002201,"comment_content":"耗子哥，我想咨询个问题:以前你在微信朋友圈发过一个治疗痛风的药:GPro,效果如何？","like_count":9},{"had_liked":false,"id":3889,"user_name":"javaworker","can_delete":false,"product_type":"c1","uid":1056209,"ip_address":"","ucode":"ABF9DDDBD3BDBF","user_header":"https://static001.geekbang.org/account/avatar/00/10/1d/d1/f427b83e.jpg","comment_is_top":false,"comment_ctime":1520914729,"is_pvip":true,"replies":[{"id":"950","content":"可以的。最好传文可灵活配置list大小的","user_name":"作者回复","user_name_real":"左耳朵","uid":"1001269","ctime":1521703284,"ip_address":"","comment_id":3889,"utype":1}],"discussion_count":2,"race_medal":0,"score":"31585685801","product_id":100002201,"comment_content":"耗子哥，一个服务号有1亿的关注关系，我们有5个类似的服务号，也就是有约5亿的关注关系，我们都存在一张表里了，这张表只做了分区。发送1亿条消息时，我们会反复的查这张表，所以这就是瓶颈，我打算把这张表的数据都存到redis里，分成多个list存，类似表的分区，发时多个线程并行发送，每个线程负责一个redis的list，这样设计可以吗，耗子哥？","like_count":7,"discussions":[{"author":{"id":1001269,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/35/89726f5f.jpg","nickname":"左耳朵","note":"","ucode":"8A4741D677702E","race_medal":0,"user_type":2,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":416097,"discussion_content":"可以的。最好传文可灵活配置list大小的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1521703284,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1451391,"avatar":"https://static001.geekbang.org/account/avatar/00/16/25/7f/473d5a77.jpg","nickname":"曾轼麟","note":"","ucode":"D418371AC11270","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":100050,"discussion_content":"其实我觉得你可以把这一亿条消息查询出来封装成dto，使用类似kafka的中间件发送，这样收到消息的时候就不用再查询表了，可以直接拿起来就用","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577235373,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":102093,"user_name":"西北偏北","can_delete":false,"product_type":"c1","uid":1043160,"ip_address":"","ucode":"64BD69C84EE6A1","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erdpKbFgRLnicjsr6qkrPVKZcFrG3aS2V51HhjFP6Mh2CYcjWric9ud1Qiclo8A49ia3eZ1NhibDib0AOCg/132","comment_is_top":false,"comment_ctime":1560135146,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"23034971626","product_id":100002201,"comment_content":"流量控制，采用api gateway <br><br>数据的分布式一致性和事务，应由数据组件自己负责，而不是在业务中，分库分表，这些思想体现在让功能分离，专业的组件做专业的事，从而才能那个不同的组件够精简，同时把自己关注的事情发挥到极致。","like_count":5},{"had_liked":false,"id":64431,"user_name":"沙漠之鹰","can_delete":false,"product_type":"c1","uid":1222887,"ip_address":"","ucode":"9FB290B874317F","user_header":"https://static001.geekbang.org/account/avatar/00/12/a8/e7/b86938a1.jpg","comment_is_top":false,"comment_ctime":1548774686,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"23023611166","product_id":100002201,"comment_content":"在 IaaS 层上解决这个问题，一般来说有三种方案，一种是使用比较廉价的开源产品，如：NFS、Ceph、TiDB、CockroachDB、ElasticSearch、InfluxDB、MySQL Cluster 和 Redis Cluster 之类的；另一种是用云计算厂商的方案。<br><br>耗子哥，这些应该是paas层吧","like_count":5,"discussions":[{"author":{"id":1110437,"avatar":"https://static001.geekbang.org/account/avatar/00/10/f1/a5/6cc9f728.jpg","nickname":"秋天的透明雨🌧️","note":"","ucode":"9363B49BFA6C14","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":307745,"discussion_content":"有相同的疑惑","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600748034,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":3554,"user_name":"javaworker","can_delete":false,"product_type":"c1","uid":1056209,"ip_address":"","ucode":"ABF9DDDBD3BDBF","user_header":"https://static001.geekbang.org/account/avatar/00/10/1d/d1/f427b83e.jpg","comment_is_top":false,"comment_ctime":1519885787,"is_pvip":true,"replies":[{"id":"761","content":"现在的具体瓶颈是……？","user_name":"作者回复","user_name_real":"左耳朵","uid":"1001269","ctime":1520471720,"ip_address":"","comment_id":3554,"utype":1}],"discussion_count":1,"race_medal":0,"score":"22994722267","product_id":100002201,"comment_content":"耗子哥，请教个问题，我在做一个类似微信的app，公司有个需求，要求1亿条消息在5分钟内发送到用户，现系统1亿条消息大概需要1小时才能都发给用户，您能提示我一些优化方向吗，谢谢","like_count":5,"discussions":[{"author":{"id":1001269,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/35/89726f5f.jpg","nickname":"左耳朵","note":"","ucode":"8A4741D677702E","race_medal":0,"user_type":2,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":415936,"discussion_content":"现在的具体瓶颈是……？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1520471720,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":2103,"user_name":"vvsuperman","can_delete":false,"product_type":"c1","uid":1021518,"ip_address":"","ucode":"F393A3FB894124","user_header":"https://static001.geekbang.org/account/avatar/00/0f/96/4e/2acbc3a8.jpg","comment_is_top":false,"comment_ctime":1515892161,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"14400794049","product_id":100002201,"comment_content":"阿里不是还有个rocketmq用来做分布式事务么，这个怎样呢","like_count":3,"discussions":[{"author":{"id":1139413,"avatar":"https://static001.geekbang.org/account/avatar/00/11/62/d5/1f5c5ab6.jpg","nickname":"大大大熊myeh","note":"","ucode":"4832C2E7CEB151","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":279700,"discussion_content":"只能保证数据的最终一致性","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591398480,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":210235,"user_name":"Geek_4139c9","can_delete":false,"product_type":"c1","uid":1974213,"ip_address":"","ucode":"ADC36DFE4611F1","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIStbRtibGOfVcJDMeWSAqtkneTYB7aRGUIo60opdj4NicWVSDRUFO7GLLDZAfg6EcElvaL1sXZGphA/132","comment_is_top":false,"comment_ctime":1587702402,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10177636994","product_id":100002201,"comment_content":"redis cluster明显是中间件，怎么会划到iaas层去呢？","like_count":2},{"had_liked":false,"id":5118,"user_name":"向飞","can_delete":false,"product_type":"c1","uid":1079484,"ip_address":"","ucode":"80F909039E5F84","user_header":"https://static001.geekbang.org/account/avatar/00/10/78/bc/a00f6a30.jpg","comment_is_top":false,"comment_ctime":1522745213,"is_pvip":false,"replies":[{"id":"1399","content":"谢谢","user_name":"作者回复","user_name_real":"左耳朵","uid":"1001269","ctime":1522978839,"ip_address":"","comment_id":5118,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10112679805","product_id":100002201,"comment_content":"收获很大，帮助将自己的很多知识点进行了系统化的梳理，理解更加清晰和深刻，非常感谢！<br><br>另外，megaease的“联系我们”部分有语病：这样能才提供最好的服务和支持。","like_count":2,"discussions":[{"author":{"id":1001269,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/35/89726f5f.jpg","nickname":"左耳朵","note":"","ucode":"8A4741D677702E","race_medal":0,"user_type":2,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":416612,"discussion_content":"谢谢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1522978839,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":331734,"user_name":"小乙哥","can_delete":false,"product_type":"c1","uid":1063308,"ip_address":"","ucode":"C77E79BEA0C325","user_header":"https://static001.geekbang.org/account/avatar/00/10/39/8c/089525aa.jpg","comment_is_top":false,"comment_ctime":1642744628,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5937711924","product_id":100002201,"comment_content":"两年前看文章有点晕，看不太明白。现在回头看，发现感受完全不一样了，开心自己这两年的成长","like_count":1},{"had_liked":false,"id":232517,"user_name":"梅端","can_delete":false,"product_type":"c1","uid":1525335,"ip_address":"","ucode":"FEC08731457770","user_header":"https://static001.geekbang.org/account/avatar/00/17/46/57/fe38a6db.jpg","comment_is_top":false,"comment_ctime":1594026522,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5888993818","product_id":100002201,"comment_content":"我也感觉这篇文章有点深，需要反复读才行，加油。","like_count":1},{"had_liked":false,"id":109967,"user_name":"FWW","can_delete":false,"product_type":"c1","uid":1101616,"ip_address":"","ucode":"41DB68B08DAC81","user_header":"https://static001.geekbang.org/account/avatar/00/10/cf/30/87b9093b.jpg","comment_is_top":false,"comment_ctime":1562142579,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5857109875","product_id":100002201,"comment_content":"smasMegaEase.com 这个地址访问不了","like_count":1},{"had_liked":false,"id":102356,"user_name":"edisonhuang","can_delete":false,"product_type":"c1","uid":1530167,"ip_address":"","ucode":"BB2F639A779F96","user_header":"https://static001.geekbang.org/account/avatar/00/17/59/37/bd2de0a4.jpg","comment_is_top":false,"comment_ctime":1560212580,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5855179876","product_id":100002201,"comment_content":"流量调度的功能在于可以自动扩展调度流量，可以应对突发情况，需要做服务流量调度，流量控制。<br>流量调度的关键性能要保证高性能，扛流量，可编程，服务化。<br>同时流量调度存在状态数据调度的问题，应该在iaas层解决有状态数据的问题","like_count":1},{"had_liked":false,"id":78673,"user_name":"songgoogle","can_delete":false,"product_type":"c1","uid":1225810,"ip_address":"","ucode":"B45BC4007C08E7","user_header":"https://static001.geekbang.org/account/avatar/00/12/b4/52/75c44c71.jpg","comment_is_top":false,"comment_ctime":1553215950,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5848183246","product_id":100002201,"comment_content":"这块之前没有涉及太多，部分需要再消化","like_count":1},{"had_liked":false,"id":55852,"user_name":"幼儿编程教学","can_delete":false,"product_type":"c1","uid":1237199,"ip_address":"","ucode":"F13F3150E6CAE9","user_header":"https://static001.geekbang.org/account/avatar/00/12/e0/cf/43f201f2.jpg","comment_is_top":false,"comment_ctime":1546328266,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5841295562","product_id":100002201,"comment_content":"tidb和mysql cluster，请教，这2种比较，如何?","like_count":1},{"had_liked":false,"id":27881,"user_name":"骨汤鸡蛋面","can_delete":false,"product_type":"c1","uid":1050002,"ip_address":"","ucode":"2AC141A523E710","user_header":"https://static001.geekbang.org/account/avatar/00/10/05/92/b609f7e3.jpg","comment_is_top":false,"comment_ctime":1537961202,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"5832928498","product_id":100002201,"comment_content":"为什么paxos不可以用在应用层呢？是因为数据层主要是副本一致性，比较适合paxos么？","like_count":1},{"had_liked":false,"id":356953,"user_name":"vance","can_delete":false,"product_type":"c1","uid":1933032,"ip_address":"广东","ucode":"441E4A9A60616E","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eor3yhoBAvuFO4dibF4dWC6CaGZiaIwgNCsYnJwKgbu69mqYAYTW3Wmv93HHI7jUMiaM4lCbXzaEgMVQ/132","comment_is_top":false,"comment_ctime":1662722038,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1662722038","product_id":100002201,"comment_content":"老哥，聊流量调度的时候你竟然不提httpdns，gslb这些总感觉少了点什么","like_count":0},{"had_liked":false,"id":355280,"user_name":"她微笑的脸y","can_delete":false,"product_type":"c1","uid":1813614,"ip_address":"浙江","ucode":"E3B559B10B4A70","user_header":"https://static001.geekbang.org/account/avatar/00/1b/ac/6e/c13d131c.jpg","comment_is_top":false,"comment_ctime":1661244507,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1661244507","product_id":100002201,"comment_content":"个人感觉条理性不是很好，阅读起来跨度很大，也可能是我水平有限。","like_count":0},{"had_liked":false,"id":340796,"user_name":"William Ning","can_delete":false,"product_type":"c1","uid":1592279,"ip_address":"","ucode":"4DB8D05E69E5F3","user_header":"https://static001.geekbang.org/account/avatar/00/18/4b/d7/f46c6dfd.jpg","comment_is_top":false,"comment_ctime":1649146801,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1649146801","product_id":100002201,"comment_content":"个人读了两遍，觉得作者讲得条理方面差了些～～ 有些地方不够准确，甚至有冲突～～<br>对于希望系统地学习分布式系统，感觉更凌乱了～","like_count":0},{"had_liked":false,"id":325166,"user_name":"lark.","can_delete":false,"product_type":"c1","uid":1008078,"ip_address":"","ucode":"1E685F651D2BC7","user_header":"https://static001.geekbang.org/account/avatar/00/0f/61/ce/8420013e.jpg","comment_is_top":false,"comment_ctime":1638847041,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1638847041","product_id":100002201,"comment_content":"耗子哥你好，公司目前遇到一个问题：我们的web服务是用IP-Hash的方式分发到不同分区的，分区之间没有共享缓存。 而DNS解析和流量分发，是通过同步策略给运营商来实现的。 目前频繁出现两次请求被分发的不同分区的问题，需要用户重登陆。 <br>请问这种可以通过什么方式来解决？业界是怎么解决这个问题的。","like_count":0},{"had_liked":false,"id":316889,"user_name":"方勇(gopher)","can_delete":false,"product_type":"c1","uid":1290625,"ip_address":"","ucode":"D199911C4CFEF5","user_header":"https://static001.geekbang.org/account/avatar/00/13/b1/81/13f23d1e.jpg","comment_is_top":false,"comment_ctime":1634606038,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1634606038","product_id":100002201,"comment_content":"流量流量调度和服务治理确实是分开的，我们在PaaS上也分为两个不同的模块！入口流量调度用的Kong,由于目前大部分还在虚拟机阶段，用的sidecar转发流量，服务的熔断限流也就在这一块。","like_count":0},{"had_liked":false,"id":309210,"user_name":"木木","can_delete":false,"product_type":"c1","uid":1486846,"ip_address":"","ucode":"2AD54B5B3F8298","user_header":"https://static001.geekbang.org/account/avatar/00/16/af/fe/e9127277.jpg","comment_is_top":false,"comment_ctime":1629986383,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1629986383","product_id":100002201,"comment_content":"数据副本，数据一致性，分布式事务","like_count":0},{"had_liked":false,"id":282045,"user_name":"我不是廖梓鉴","can_delete":false,"product_type":"c1","uid":2368408,"ip_address":"","ucode":"F19E246F0A5827","user_header":"https://static001.geekbang.org/account/avatar/00/24/23/98/2925cdaf.jpg","comment_is_top":false,"comment_ctime":1615028141,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1615028141","product_id":100002201,"comment_content":"因为数据存储结点在 Scale 上比较困难，所以成了一个单点的瓶颈。<br>请问一下这句话怎么理解？scale我查询字典是范围的意思，但是语义实在不通顺呢","like_count":0,"discussions":[{"author":{"id":1122641,"avatar":"https://static001.geekbang.org/account/avatar/00/11/21/51/a6020b74.jpg","nickname":"刘旭","note":"","ucode":"DD628C59BEB81D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":360105,"discussion_content":"集群横向扩容难的意思","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1616373732,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":222472,"user_name":"locke.wei","can_delete":false,"product_type":"c1","uid":1351535,"ip_address":"","ucode":"58C70AC52A0C84","user_header":"https://static001.geekbang.org/account/avatar/00/14/9f/6f/aee1732a.jpg","comment_is_top":false,"comment_ctime":1590814502,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1590814502","product_id":100002201,"comment_content":"高屋建瓴，值得反复精读","like_count":0},{"had_liked":false,"id":211594,"user_name":"arch","can_delete":false,"product_type":"c1","uid":1078931,"ip_address":"","ucode":"A69EBFE0520B85","user_header":"https://static001.geekbang.org/account/avatar/00/10/76/93/64ed7385.jpg","comment_is_top":false,"comment_ctime":1587987077,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1587987077","product_id":100002201,"comment_content":"限流算法：漏斗+令牌桶， 也可以自己实现基于性能、响应时常、吞吐量等指标实现","like_count":0},{"had_liked":false,"id":211410,"user_name":"Geek_130e9e","can_delete":false,"product_type":"c1","uid":1587628,"ip_address":"","ucode":"518AAF2F228C17","user_header":"","comment_is_top":false,"comment_ctime":1587959159,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1587959159","product_id":100002201,"comment_content":"实现APIGateway最好的语言还是Go。Kong的确不错。使用云计算厂商的方案和使用廉价开源产品都是paas层的解决方案。","like_count":0},{"had_liked":false,"id":210355,"user_name":"宇智波胖虎","can_delete":false,"product_type":"c1","uid":1859034,"ip_address":"","ucode":"FEC531448AE87B","user_header":"https://static001.geekbang.org/account/avatar/00/1c/5d/da/e0bb4a89.jpg","comment_is_top":false,"comment_ctime":1587727056,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1587727056","product_id":100002201,"comment_content":"已经重复听了很多次，好文","like_count":0},{"had_liked":false,"id":209821,"user_name":"mark","can_delete":false,"product_type":"c1","uid":1063172,"ip_address":"","ucode":"42CBC7FA8F31F4","user_header":"https://static001.geekbang.org/account/avatar/00/10/39/04/3295d5eb.jpg","comment_is_top":false,"comment_ctime":1587620476,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1587620476","product_id":100002201,"comment_content":"每一篇都值得精读，重复读","like_count":0},{"had_liked":false,"id":195945,"user_name":"GZC","can_delete":false,"product_type":"c1","uid":1928513,"ip_address":"","ucode":"1A96BC07D8BC42","user_header":"https://static001.geekbang.org/account/avatar/00/1d/6d/41/256f7238.jpg","comment_is_top":false,"comment_ctime":1585225340,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1585225340","product_id":100002201,"comment_content":"路漫漫其修远兮，吾将上下左右前后而求索！","like_count":0},{"had_liked":false,"id":190185,"user_name":"ipofss","can_delete":false,"product_type":"c1","uid":1018620,"ip_address":"","ucode":"DE3061C9259F9E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8a/fc/d1dd57dd.jpg","comment_is_top":false,"comment_ctime":1584611356,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1584611356","product_id":100002201,"comment_content":"听个提纲，日后回来复习","like_count":0},{"had_liked":false,"id":165348,"user_name":"番茄炒西红柿","can_delete":false,"product_type":"c1","uid":1690242,"ip_address":"","ucode":"13F47BABAB2110","user_header":"https://static001.geekbang.org/account/avatar/00/19/ca/82/85f6a1a2.jpg","comment_is_top":false,"comment_ctime":1577205065,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1577205065","product_id":100002201,"comment_content":"真正解决数据状态调度，其实就是有一个分布式且支持事务的数据库，突然想到最近新起的newsql数据库不就是为了解决这个问题而来的。 ","like_count":0},{"had_liked":false,"id":165091,"user_name":"slark","can_delete":false,"product_type":"c1","uid":1143574,"ip_address":"","ucode":"7E8DE962AA23A7","user_header":"https://static001.geekbang.org/account/avatar/00/11/73/16/595b0342.jpg","comment_is_top":false,"comment_ctime":1577159001,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1577159001","product_id":100002201,"comment_content":"API网关，分布式技术。这篇文章里提到应用层两段提交的方案以及分布式存储。从技术上讲，无状态服务在分布式中可以比较顺利地扩展，但无状态说明状态存在了其他地方，比如数据库或者本地文件。但数据库的数据复制和同步本身也是一个复杂的问题。如果能从底层文件系统出发直接实现底层文件系统就是分布式的，那么在数据同步方面会更简单。","like_count":0},{"had_liked":false,"id":164311,"user_name":"十里坡剑神","can_delete":false,"product_type":"c1","uid":1675980,"ip_address":"","ucode":"06DD3DFAE50CC6","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIIb51lMmiapEpT1594HNrYbRevRVonBfQSHVgFdNL7jrGhCawqoqDAGrkWpvuIDaUE0UwJoHXj1pw/132","comment_is_top":false,"comment_ctime":1576933653,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1576933653","product_id":100002201,"comment_content":"请问大哥：这篇文章发布在两年前，国内外各家大厂的技术也在进化。请问两年前您下的一些判断，现在是否有什么变化？有什么更新？“成熟的可以用到生产线上的分布式数据库这个事估计也不远了”，这个现在有了吗？","like_count":0,"discussions":[{"author":{"id":1015771,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/7f/db/e6f0b668.jpg","nickname":"爪哇咖啡","note":"","ucode":"F7F856E24BE299","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":102205,"discussion_content":"阿里的oceanbase吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577330780,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1675980,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIIb51lMmiapEpT1594HNrYbRevRVonBfQSHVgFdNL7jrGhCawqoqDAGrkWpvuIDaUE0UwJoHXj1pw/132","nickname":"十里坡剑神","note":"","ucode":"06DD3DFAE50CC6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1015771,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/7f/db/e6f0b668.jpg","nickname":"爪哇咖啡","note":"","ucode":"F7F856E24BE299","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":114262,"discussion_content":"阿里的OceanBase有多成熟？陈皓大哥说的都满足了？\n\n与华为的GaussDB相比呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577966410,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":102205,"ip_address":""},"score":114262,"extra":""}]}]},{"had_liked":false,"id":164152,"user_name":"Haan","can_delete":false,"product_type":"c1","uid":1388133,"ip_address":"","ucode":"7A7BBE0D0CD39E","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eq8qpSvBoZz89u3BhGXWLibs2OibCkZl8bx74aLSJ58f467bR8anNaTiccJklcqjBdhfvvJpvLVmYesA/132","comment_is_top":false,"comment_ctime":1576896371,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1576896371","product_id":100002201,"comment_content":"mark","like_count":0}]}