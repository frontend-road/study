{"id":621930,"title":"79｜怎样将 Python 和 C++ 结合起来混合编程？","content":"<p><strong>本讲相关链接</strong><br>\n1.使用ctypes库加载C++编写的动态链接库，参考链接：<a href=\"https://docs.python.org/zh-cn/3.10/library/ctypes.html\">https://docs.python.org/zh-cn/3.10/library/ctypes.html</a><br>\n2. 使用pybind将C++编译为Python库，参考链接：<a href=\"https://github.com/pybind/python_example\">https://github.com/pybind/python_example</a><br>\n3. 使用Pythran库将Python直接转换为C++代码，参考链接：<a href=\"https://pypi.org/project/pythran\">https://pypi.org/project/pythran</a></p><p><strong>课后习题</strong><br>\n请你基于Pythran编写一个计算圆周率的Python函数，并使用C++调用该函数，运行后，比较一下纯Python代码和C++代码的运行时间。</p><p><strong>课程代码、课件及其他相关资料地址</strong><br>\n<a href=\"https://gitee.com/wilsonyin/zero-basics-python\">https://gitee.com/wilsonyin/zero-basics-python</a></p>","comments":[{"had_liked":false,"id":366400,"user_name":"Matthew","can_delete":false,"product_type":"c3","uid":2843865,"ip_address":"江苏","ucode":"96093089773740","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEKSVuNarJuDhBSvHY0giaq6yriceEBKiaKuc04wCYWOuso50noqDexaPJJibJN7PHwvcQppnzsDia1icZkw/132","comment_is_top":false,"comment_ctime":1673705884,"is_pvip":false,"replies":[{"id":133627,"content":"这里就不得不看 cal_pi() 函数的C++ 实现方法了， 里面可能有某些“潜在规则”导致转换之后出错， 比如Python对待某个变量是浮点数，但是转换成C++代码时，被当做了整数，就出现结果不精确的问题，解决办法是显示的使用float(变量)，确保转换时不要被C++曲解成int()数据类型","user_name":"作者回复","user_name_real":"编辑","uid":1056235,"ctime":1674201282,"ip_address":"广东","comment_id":366400,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100310001,"comment_content":"import random\n\n# 蒙特卡洛方法\ndef cal_pi(n:int) -&gt; float:\n    count = 0\n\n    for i in range(int(n)):\n        x = random.random()\n        y = random.random()\n        d = (x - 0.5) ** 2 + (y - 0.5) ** 2\n        if d &lt;= 0.5 ** 2:\n            count+=1\n        else:\n            pass\n\n    return (4*count)&#47;n\n\n----------------------------------\n我将上述代码封装成 cal_pi.py ，然后通过 Pythran 得到 cal_pi.hpp ；\n写了一个 cal_pi.cpp ，如下：\n----------------------------------\n#include &quot;cal_pi.hpp&quot;\nusing namespace __pythran_cal_pi ;\n\nint main() \n{ \n    int n = 10000;\n\n    float pi = cal_pi()(n);\n    printf(&quot;%f\\n&quot;, pi);\n    \n    return 0 ; \n}\n----------------------------------\n但是得到结果却是 4.000000 ，和直接调用 Python 函数的结果不一样，问下是什么原因呢？","like_count":1,"discussions":[{"author":{"id":1056235,"avatar":"https://static001.geekbang.org/account/avatar/00/10/1d/eb/b2123759.jpg","nickname":"尹会生","note":"","ucode":"D1093DBD093617","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":600311,"discussion_content":"这里就不得不看 cal_pi() 函数的C++ 实现方法了， 里面可能有某些“潜在规则”导致转换之后出错， 比如Python对待某个变量是浮点数，但是转换成C++代码时，被当做了整数，就出现结果不精确的问题，解决办法是显示的使用float(变量)，确保转换时不要被C++曲解成int()数据类型","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1674201282,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":379573,"user_name":"好困啊","can_delete":false,"product_type":"c3","uid":2094450,"ip_address":"上海","ucode":"D49429660F2DC8","user_header":"https://static001.geekbang.org/account/avatar/00/1f/f5/72/8cbc5cb3.jpg","comment_is_top":false,"comment_ctime":1692116014,"is_pvip":false,"replies":[{"id":138343,"content":"ChatGPT是个好帮手，相比搜索引擎，它能继续追问，是我觉得学习编程时非常有用的功能， 但是务必要让ChatGPT编写测试用例，有时候ChatGPT提供的代码有bug，不够精确。这一点不要被ChatGPT误导","user_name":"作者回复","user_name_real":"编辑","uid":1056235,"ctime":1692534556,"ip_address":"甘肃","comment_id":379573,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100310001,"comment_content":"晚上搞了 3 个小时终于弄出来了，基于chatgpt帮我查找错误修改代码，最开始用的是pythran script.py来生成c++共享库，结果调用c++的时候一直说函数找不到或者有问题，然后按照老师的代码操作，其中又修改了.hpp的文件，终于执行成功了","like_count":0,"discussions":[{"author":{"id":1056235,"avatar":"https://static001.geekbang.org/account/avatar/00/10/1d/eb/b2123759.jpg","nickname":"尹会生","note":"","ucode":"D1093DBD093617","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":626098,"discussion_content":"ChatGPT是个好帮手，相比搜索引擎，它能继续追问，是我觉得学习编程时非常有用的功能， 但是务必要让ChatGPT编写测试用例，有时候ChatGPT提供的代码有bug，不够精确。这一点不要被ChatGPT误导","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1692534556,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"甘肃","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":369760,"user_name":"yanyu-xin","can_delete":false,"product_type":"c3","uid":1899757,"ip_address":"广东","ucode":"3AA389F9E4C236","user_header":"","comment_is_top":false,"comment_ctime":1677900448,"is_pvip":false,"replies":[{"id":134851,"content":"默认会安装在site-packages下，而且site-packages在python安装后会自动加入到命令搜索路径， 所以视频中安装后直接可以使用。\n\n如果无法运行，你可以尝试先关闭终端，再打开，重新加载终端是否可行\n另一个办法就是手动解决，通过python -m site 找到site-packages文件夹， 再找到pythran所在的路径，将路径加入 windows 环境变量的PATH中，仍然要重启终端生效","user_name":"作者回复","user_name_real":"编辑","uid":1056235,"ctime":1678156285,"ip_address":"广东","comment_id":369760,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100310001,"comment_content":"请问老师：\nwindow环境下，在Anaconda下的Powershell Prompt 下 pip 安装完pythran后。下一步是在哪个运行环境执行pythran命令行的？\n搜索不到pythran的命令行运行文件","like_count":0,"discussions":[{"author":{"id":1056235,"avatar":"https://static001.geekbang.org/account/avatar/00/10/1d/eb/b2123759.jpg","nickname":"尹会生","note":"","ucode":"D1093DBD093617","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":607849,"discussion_content":"默认会安装在site-packages下，而且site-packages在python安装后会自动加入到命令搜索路径， 所以视频中安装后直接可以使用。\n\n如果无法运行，你可以尝试先关闭终端，再打开，重新加载终端是否可行\n另一个办法就是手动解决，通过python -m site 找到site-packages文件夹， 再找到pythran所在的路径，将路径加入 windows 环境变量的PATH中，仍然要重启终端生效","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1678156285,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1899757,"avatar":"","nickname":"yanyu-xin","note":"","ucode":"3AA389F9E4C236","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":608258,"discussion_content":"谢谢老师。反复搜索研究，用各种参数重新安装库，发现是安装pythran有错，并且依赖库版本高不兼容。（pip简易安装时没有提示错误）。折腾了很久尚需要继续学习，研究解决问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1678350052,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广西","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":389078,"user_name":"冯丽娟","can_delete":false,"product_type":"c3","uid":2362891,"ip_address":"北京","ucode":"C470B564979A1C","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJ3ibJunUcvkAibM9tBDyVB9PoiaWgf3dMZgCBbeAZUF1ISr0fiaicjRjNgThebJyHJHgxr0vjh2JeYSlA/132","comment_is_top":false,"comment_ctime":1711512193,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100310001,"comment_content":"执行：pythran -e test.py  -p pythran.optimizations.ConstantFolding -o output.hpp\n提示：WARNING: No pythran specification, nothing will be exported\n没有生成.cpp文件。\ntest.py文件内容如下：\nimport random\n\ndef calculate_pi(n):\n    num_points_circle = 0\n    num_points_total = 0\n    for _ in range(n):\n        x = random.uniform(0, 1)\n        y = random.uniform(0, 1)\n        distance = x ** 2 + y ** 2\n        if distance &lt;= 1:\n            num_points_circle += 1\n        num_points_total += 1\n    pi=4 * num_points_circle &#47; num_points_total\n    print(pi)\n    return pi\n# if __name__ == &#39;__main__&#39;:\n#     calculate_pi(10000000)","like_count":0},{"had_liked":false,"id":385143,"user_name":"蓝定月","can_delete":false,"product_type":"c3","uid":1497795,"ip_address":"上海","ucode":"3765E44A958022","user_header":"https://static001.geekbang.org/account/avatar/00/16/da/c3/4133a67a.jpg","comment_is_top":false,"comment_ctime":1702195634,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100310001,"comment_content":"# pythran export calculate_pi(int)\nimport random\nimport time\n\n\n# 计算圆周率，使用蒙特卡洛方法\ndef calculate_pi(n):\n    start_time = time.time()\n    num_in = 0\n    for i in range(n):\n        x, y = random.random(), random.random()\n        if x * x + y * y &lt;= 1:\n            num_in += 1\n    pi = 4 * num_in &#47; n\n    end_time = time.time()\n    elased_time = end_time - start_time\n    print(&#39;time: %.5f s&#39; % elased_time)\n    return pi\n    \nc++代码：\n#inclue &quot;test_pi.hpp&quot;\nusing namespace __pythran_first-1;\nint main()\n{\n        int n = 100000000;\n        pi = calculate_pi()(n);\n        print(&quot;%f\\n&quot;,pi);\n        return 0;\n}\n\npython代码用时14.15630s，结果为3.14150672\nc++代码用时10.09400s，结果为3.141633","like_count":0},{"had_liked":false,"id":384682,"user_name":"依托答辩","can_delete":false,"product_type":"c3","uid":2383299,"ip_address":"上海","ucode":"4BE79E8A030813","user_header":"https://static001.geekbang.org/account/avatar/00/24/5d/c3/b8bb888c.jpg","comment_is_top":false,"comment_ctime":1701335129,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100310001,"comment_content":"PS D:\\PythonLearning\\python-homework\\tong\\practice&gt; pythran -e customModule.py -p pythran.optimizations.ConstantFolding -o customModule.hpp\nTraceback (most recent call last):\n  File &quot;&lt;frozen runpy&gt;&quot;, line 198, in _run_module_as_main\n  File &quot;&lt;frozen runpy&gt;&quot;, line 88, in _run_code\n  File &quot;C:\\Users\\tong_zheng\\AppData\\Local\\Packages\\PythonSoftwareFoundation.Python.3.12_qbz5n2kfra8p0\\LocalCache\\local-packages\\Python312\\Scripts\\pythran.exe\\__main__.py&quot;, line 4, in &lt;module&gt;\n  File &quot;C:\\Users\\tong_zheng\\AppData\\Local\\Packages\\PythonSoftwareFoundation.Python.3.12_qbz5n2kfra8p0\\LocalCache\\local-packages\\Python312\\site-packages\\pythran\\run.py&quot;, line 13, in &lt;module&gt; \n    from distutils.errors import CompileError\nModuleNotFoundError: No module named &#39;distutils&#39;\n\n执行这个命令后为什么报错ModuleNotFoundError: No module named &#39;distutils&#39;","like_count":0},{"had_liked":false,"id":382735,"user_name":"MarkG","can_delete":false,"product_type":"c3","uid":3675806,"ip_address":"山东","ucode":"454082595FE769","user_header":"https://static001.geekbang.org/account/avatar/00/38/16/9e/48621655.jpg","comment_is_top":false,"comment_ctime":1697933764,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100310001,"comment_content":"pi.py\n# pythran export compute_pi(int)\n\ndef compute_pi(n):\n    sum = 0.0\n    for i in range(n):\n        x = (i + 0.5) &#47; n\n        sum += 4.0 &#47; (1.0 + x * x)\n    pi = sum &#47; n\n    return pi\n\npi.cpp\n#include &quot;pi.hpp&quot;\nusing namespace __pythran_pi;\n\nint main()\n{\n    int n = 100000000;\n    float pi = compute_pi()(n);\n    printf(&quot;%f\\n&quot;, pi);\n    return 0;\n}\n\nc++比py，以100000000为里\n执行感官：\nc++ 2~3s\npy 10s","like_count":0},{"had_liked":false,"id":382133,"user_name":"William","can_delete":false,"product_type":"c3","uid":1346215,"ip_address":"吉林","ucode":"55F5D9DEE485B1","user_header":"https://static001.geekbang.org/account/avatar/00/14/8a/a7/674c1864.jpg","comment_is_top":false,"comment_ctime":1696755516,"is_pvip":true,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100310001,"comment_content":"3.使用Pvthran库将Python直接转换为C++代码\n        参考链接: https:&#47;&#47;pypi.org&#47;project&#47;pythran\n        \n        1、编写可执行的py函数\n            79_pyAndC.py\n               使用的老师的那个hello文件 \n                \n        2、将py转换为.hpp 文件\n        pythran -e 79_pyAndC.py 要转为c++的python 路径\n                -p pythran.optimizations.ConstantFolding（格式化）\n                -o 79_pyAndCoutput.hpp (输出的文件)\n        \n        例如：\n        pythran -e 79_pyAndC.py -p pythran.optimizations.ConstantFolding -o 79_pyAndCoutput.hpp\n        会生成一个 79_pyAndCoutput.hpp 文件。 \n            \n        3、编写调用py函数的 cpp的程序\n            79_pyAndC.cpp\n            \n        4、将 79_pyAndCoutput.hpp 文件 ，变异为可执行文件\n        `pythran-config --compiler --cflags` -std=c++11 79_pyAndC.cpp -o 79_pyAndCoutput\n       \n        5、执行文件\n        .&#47;79_pyAndCoutput","like_count":0},{"had_liked":false,"id":380824,"user_name":"浩仔是程序员","can_delete":false,"product_type":"c3","uid":1104601,"ip_address":"广东","ucode":"A7E5CF9E1571A2","user_header":"https://static001.geekbang.org/account/avatar/00/10/da/d9/f051962f.jpg","comment_is_top":false,"comment_ctime":1694239506,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100310001,"comment_content":"编译完可执行文件之后，怎么在python代码中调用呢","like_count":0},{"had_liked":false,"id":373559,"user_name":"事已至此开始撤退","can_delete":false,"product_type":"c3","uid":2901316,"ip_address":"上海","ucode":"1076FDF53DA81D","user_header":"https://static001.geekbang.org/account/avatar/00/2c/45/44/8df79d3c.jpg","comment_is_top":false,"comment_ctime":1682661696,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100310001,"comment_content":"这节不错","like_count":0},{"had_liked":false,"id":367681,"user_name":"聪少 Jeff","can_delete":false,"product_type":"c3","uid":1159983,"ip_address":"广东","ucode":"C791ACA9B47679","user_header":"https://static001.geekbang.org/account/avatar/00/11/b3/2f/d08a1363.jpg","comment_is_top":false,"comment_ctime":1675417620,"is_pvip":false,"replies":null,"discussion_count":4,"race_medal":0,"score":3,"product_id":100310001,"comment_content":"老师，之前提问我已经找到答案啦，是我没有认真看好py和cpp代码中重要信息。","like_count":0,"discussions":[{"author":{"id":1179005,"avatar":"https://static001.geekbang.org/account/avatar/00/11/fd/7d/b0ca572b.jpg","nickname":"jefferyqjy","note":"","ucode":"30A2191B644966","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":607575,"discussion_content":"帅哥我也遇到跟你一样的问题~请教下，你找到的是什么原因哈？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1677953702,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"江苏","group_id":0},"score":2,"extra":"","child_discussion_number":3,"child_discussions":[{"author":{"id":1159983,"avatar":"https://static001.geekbang.org/account/avatar/00/11/b3/2f/d08a1363.jpg","nickname":"聪少 Jeff","note":"","ucode":"C791ACA9B47679","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1179005,"avatar":"https://static001.geekbang.org/account/avatar/00/11/fd/7d/b0ca572b.jpg","nickname":"jefferyqjy","note":"","ucode":"30A2191B644966","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":607613,"discussion_content":"其实也没有什么，就是本次课程老师演示代码当中的c语言文件在gitee里面有，需要提前下载准备一下而已。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1678016506,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":607575,"ip_address":"广东","group_id":0},"score":607613,"extra":""},{"author":{"id":1179005,"avatar":"https://static001.geekbang.org/account/avatar/00/11/fd/7d/b0ca572b.jpg","nickname":"jefferyqjy","note":"","ucode":"30A2191B644966","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1159983,"avatar":"https://static001.geekbang.org/account/avatar/00/11/b3/2f/d08a1363.jpg","nickname":"聪少 Jeff","note":"","ucode":"C791ACA9B47679","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":607653,"discussion_content":"嗷嗷，好的👌🏻","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1678068450,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":607613,"ip_address":"江苏","group_id":0},"score":607653,"extra":""},{"author":{"id":1179005,"avatar":"https://static001.geekbang.org/account/avatar/00/11/fd/7d/b0ca572b.jpg","nickname":"jefferyqjy","note":"","ucode":"30A2191B644966","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1159983,"avatar":"https://static001.geekbang.org/account/avatar/00/11/b3/2f/d08a1363.jpg","nickname":"聪少 Jeff","note":"","ucode":"C791ACA9B47679","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":607654,"discussion_content":"谢谢哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1678068456,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":607613,"ip_address":"江苏","group_id":0},"score":607654,"extra":""}]}]},{"had_liked":false,"id":367676,"user_name":"聪少 Jeff","can_delete":false,"product_type":"c3","uid":1159983,"ip_address":"广东","ucode":"C791ACA9B47679","user_header":"https://static001.geekbang.org/account/avatar/00/11/b3/2f/d08a1363.jpg","comment_is_top":false,"comment_ctime":1675416151,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":3,"product_id":100310001,"comment_content":"请问老师，我在命令行工具（mac）使用转换py文件转换成hpp时命令，出现警告如下：\nWARNING:root:No pythran specification, nothing will be exported\n但是，文件转换是成功的，就是不知道这个警告是什么原因造成的？","like_count":0,"discussions":[{"author":{"id":1483179,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epr30DNcGHZ61PJicNvaBPNZVlLDqCcVPVgYCsicgArxWThibyK4L7pDge2sTlD9SugfB3qLIkIK4gjw/132","nickname":"Geek_adc450","note":"","ucode":"59FBC6D59F9BE5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":623425,"discussion_content":"# pythran export foo()\n# pythran export msg\n前两行注释不能省略","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1689476230,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}