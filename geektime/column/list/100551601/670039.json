{"id":670039,"title":"05｜限流：别说算法了，就问你“阈值”怎么算？","content":"<p>你好，我是大明。今天我们来聊一聊微服务架构下的限流功能。</p><p>熔断、降级和限流是最常见的三种微服务架构可用性保障措施。和熔断、降级比起来，限流要更加复杂一些。大部分情况下，面试官面试限流就是随便问问算法，最多就是问问 BBR 之类的动态算法。但是有一个问题，很多人都答不好，就是<strong>限流需要确定一个流量阈值，这个阈值该怎么算？</strong></p><p>今天我就带你深入讨论限流的这个问题。</p><h2>前置知识</h2><p>限流是通过限制住流量大小来保护系统，它尤其能够<strong>解决异常突发流量打崩系统的问题</strong>。例如常见的某个攻击者攻击你维护的系统，那么限流就能极大程度上保护住你的系统。</p><p>要想全面掌握限流这个知识点，我们需要深入理解限流的算法、对象，以及限流后的做法。下面我们一个一个来看。</p><h3>算法</h3><p>限流算法也可以像负载均衡算法那样，划分成静态算法和动态算法两类。</p><ul>\n<li>静态算法包含令牌桶、漏桶、固定窗口和滑动窗口。这些算法就是要求研发人员提前设置好阈值。在算法运行期间它是不会管服务器的真实负载的。</li>\n<li>动态算法也叫做自适应限流算法，典型的是 BBR 算法。这一类算法利用一系列指标来判定是否应该减少流量或者放大流量。动态算法和 TCP 的拥塞控制是非常接近的，只不过 TCP 控制的是报文流量，而微服务控制的是请求流量。</li>\n</ul><!-- [[[read_end]]] --><p>除了我这里列举的算法，你也可以考虑参考熔断和降级里面的思路，选用一些指标来设计自己的限流算法。例如你的业务需要很多内存，那么你可以根据剩余空闲内存来判断要不要执行限流。</p><p>下面我们就从静态算法中的令牌桶看起，掌握限流中常见的算法。</p><h4>令牌桶</h4><p><strong>系统会以一个恒定的速率产生令牌，这些令牌会放到一个桶里面，每个请求只有拿到了令牌才会被执行</strong>。每当一个请求过来的时候，就需要尝试从桶里面拿一个令牌。如果拿到了令牌，那么请求就会被处理；如果没有拿到，那么这个请求就被限流了。</p><p><img src=\"https://static001.geekbang.org/resource/image/ab/7f/aba7bdeb91f372d5edca85b2fb689b7f.png?wh=1920x1253\" alt=\"图片\"></p><p>你需要注意<strong>，本身令牌桶是可以积攒一定数量的令牌的</strong>。比如说桶的容量是 100，也就是这里面最多积攒 100 个令牌。那么当某一时刻突然来了 100 个请求，它们都能拿到令牌。</p><h4>漏桶</h4><p>漏桶是指当请求以不均匀的速度到达服务器之后，限流器会以固定的速率转交给业务逻辑。</p><p><img src=\"https://static001.geekbang.org/resource/image/bb/8c/bba1cbc3cf682e09a18098e3da96e18c.png?wh=1434x1320\" alt=\"图片\"></p><p>某种程度上，你可以将漏桶算法看作是令牌桶算法的一种特殊形态。你将令牌桶中桶的容量设想为 0，就是漏桶了。</p><p><img src=\"https://static001.geekbang.org/resource/image/ea/bd/ea8c6daacd9fa20c26a1cf96990b88bd.png?wh=1882x1316\" alt=\"图片\"></p><p>所以你可以看到，在漏桶里面，令牌产生之后你就需要取走，没取走的话也不会积攒下来。因此<strong>漏桶是绝对均匀的</strong>，而令牌桶不是绝对均匀的。</p><h4>固定窗口与滑动窗口</h4><p><img src=\"https://static001.geekbang.org/resource/image/8a/68/8a76e55b50edcyyf6c7d3789d6b49f68.png?wh=1920x801\" alt=\"图片\"></p><p><strong>固定窗口是指在一个固定时间段，只允许执行固定数量的请求</strong>。比如说在一秒钟之内只能执行 100 个请求。</p><p>滑动窗口类似于固定窗口，<strong>也是指在一个固定时间段内，只允许执行固定数量的请求</strong>。区别就在于，滑动窗口是平滑地挪动窗口，而不像固定窗口那样突然地挪动窗口。</p><p>假设窗口大小是一分钟。此时时间是 t1，那么窗口的起始位置是 t1-1分钟。过了2秒之后，窗口大小依旧是1分钟，但是窗口的起始位置也向后挪动了2秒，变成了t1 - 1 分钟 + 2 秒。这也就是滑动的含义。</p><h3>限流对象</h3><p>此外我们还要进一步考虑限流对象，也就是针对什么来进行限流。</p><p>从单机或者集群的角度看，可以分为单机限流或者集群限流。集群限流一般需要借助 Redis 之类的中间件来记录流量和阈值。换句话说，就是你需要用 Redis 等工具来实现前面提到的限流算法。当然如果是利用网关来实现集群限流，那么可以摆脱 Redis。</p><p><img src=\"https://static001.geekbang.org/resource/image/62/f8/621c771862ce464cde5eb0627ed109f8.png?wh=1920x1035\" alt=\"图片\"></p><p>针对业务对象限流，这一类限流对象就非常多样。</p><ul>\n<li>VIP 用户不限流而普通用户限流。</li>\n<li>针对 IP 限流。用户登录或者参与秒杀都可以使用这种限流，比方说设置一秒钟最多只能有 50 个请求，即便考虑到公共 IP 的问题，正常的用户手速也是没那么快的。</li>\n<li>针对业务 ID 限流，例如针对用户 ID 进行限流。</li>\n</ul><p><img src=\"https://static001.geekbang.org/resource/image/f5/e5/f52b2265cd34769a594c9ceeb05d9ce5.png?wh=1920x728\" alt=\"图片\"></p><h3>限流后的做法</h3><p>即使一个请求被限流了，那么我们也可以设计一些精巧的方案来处理。</p><ul>\n<li>同步阻塞等待一段时间。如果是偶发性地触发了限流，那么稍微阻塞等待一会儿，后面就有极大的概率能得到处理。比如说限流设置为一秒钟 100 个请求，恰好来了 101 个请求。多出来的一个请求只需要等一秒钟，下一秒钟就会被处理。但是要注意控制住超时，也就是说你不能让人无限期地等待下去。</li>\n</ul><p><img src=\"https://static001.geekbang.org/resource/image/79/7d/795d6977dc03e134e0894080c57b577d.png?wh=1920x890\" alt=\"图片\"></p><ul>\n<li>同步转异步。这里我们又一次看到了这个手段，它是指如果一个请求没被限流，那就直接同步处理；而如果被限流了，那么这个请求就会被存储起来，等到业务低峰期的时候再处理。这个其实跟降级差不多。</li>\n<li>调整负载均衡算法。如果某个请求被限流了，那么就相当于告诉负载均衡器，应该尽可能少给这个节点发送请求。我在熔断里面给你讲过类似的方案。不过在熔断里面是负载均衡器后续不再发请求，而在限流这里还是会发送请求，只是会降低转发请求到该节点的概率。调整节点的权重就能达成这种效果。</li>\n</ul><p><img src=\"https://static001.geekbang.org/resource/image/47/01/479c735177d75bd9782c8187e753da01.png?wh=1920x1039\" alt=\"图片\"></p><h2>面试准备</h2><p>理论上，你要能够说出各种算法的基本原理。但动态算法，比如 BBR，就不作硬性的要求了。这主要是因为 BBR 的原理和实现都很有难度，大多数微服务框架都没提供 BBR 的限流器实现。不过还是那句老话，你要是有时间和精力，还是可以了解一下 BBR 的基本原理。</p><p>有些时候面试官可能会让你手写限流算法，那么漏桶、令牌桶、滑动窗口和固定窗口这几个算法你都要能写出来，至少要能把基本思路写清楚。如果你还有时间和精力，那么我建议你为一些开源框架提供限流插件，比如说为 gRPC 提供各种限流算法实现的插件。</p><p>你可能会说，现在开源的那么多，你写出来的插件还有人用吗？大概率没人用，但是你的目标也不是让人用，而是<strong>作为一个证据</strong>，来证明你懂限流，你很熟悉 gRPC，你喜欢开源。</p><p><img src=\"https://static001.geekbang.org/resource/image/0b/8b/0b228d3eb3bb92364f4bbb1b8951778b.png?wh=1920x968\" alt=\"图片\"></p><p>除了这些基本的知识，在面试前，你还需要了解清楚你们公司使用限流的情况。正常来说，核心 HTTP 请求和核心服务都应该使用限流来保障系统的可用性。对于每一个限流，你都要了解这些信息。</p><ul>\n<li>限流的阈值是多少，为什么设定成这个阈值？</li>\n<li>被限流的请求会被怎么处理，是直接拒绝还是阻塞直到超时，还是转为异步处理？</li>\n</ul><p>同样，面试限流的最好策略就是为自己打造一个掌握了高可用微服务架构的人设。而限流就是你在提高系统可用性时的一个具体策略。如果你前面和面试官已经聊到了熔断和降级，那么就可以直接把话题引导到限流上。比如：</p><ul>\n<li>在讨论对外的API，如HTTP 接口或者公共API时，可以强调使用限流来保护系统。</li>\n<li>在讨论TCP拥塞控制时，你可以提起在服务治理上限流也借鉴了TCP拥塞控制的一些思想。</li>\n<li>在讨论Redis或者类似产品的时候，你可以提你用 Redis 实现过集群限流。</li>\n</ul><p>如果你维护的服务或者接口还没有使用限流来保护系统，那么你就可以考虑加上限流。而为了确定具体的阈值，你可以尝试对接口进行压力测试，找准限流的阈值。这个也是需要你通过实践来加深印象、把握细节的。</p><h2>基本思路</h2><p>如果面试官问到了限流，那么你就可以先阐述限流的总体目标，然后回答前置知识里面的三个点：算法、限流对象和限流后的做法，最后再把话题引到计算阈值上。</p><blockquote>\n<p>限流是为了保证系统可用性，防止系统因为流量过大而崩溃的一种服务治理手段。从算法上来说，有令牌桶、漏桶、固定窗口和滑动窗口算法。还有动态限流算法，或者说自适应限流算法，比较有名的就是参考了 TCP 拥塞控制算法 BBR 衍生出来的算法，比如说 B 站开源的 Kratos 框架就有一个实现。这些算法之间比较重要的一个区别是<strong>能否处理小规模的突发流量</strong>。<br>\n&nbsp;<br>\n从限流对象上来说，可以是集群限流或者单机限流，也可以是针对具体业务来做限流。比如说在登录的时候，我们经常针对 IP 进行限流。又或者在一些增值服务里面，非付费用户也会被限流。<br>\n&nbsp;<br>\n触发限流之后，具体的措施也可以非常灵活。被限流的请求可以同步阻塞一段时间，也可以考虑同步转异步。如果负载均衡算法灵活的话，也可以做一些调整，减少发到该节点的概率。<br>\n&nbsp;<br>\n用好限流的一个重要前提是能够设置准确的阈值，例如每秒钟限制在 100 个请求还是限制在 200 个请求。如果阈值过低，那么系统资源就容易闲置浪费；如果阈值太高，那么系统可能撑不住那么多流量，导致崩溃。</p>\n</blockquote><p>同时你还要补充一个简单的例子，关键词是<strong>IP限流</strong>。你也可以考虑使用你的真实案例。</p><blockquote>\n<p>我在我们公司的登录接口里面就引入了限流机制。正常情况下，一个用户在一秒钟内最多点击一次登录，所以针对每一个 IP，我限制它最多只能在一秒内提交 50 次登录请求。这个 50 充分考虑到了公共 IP 的问题，正常用户是不可能触发这个阈值的。这个限流虽然很简单，但是能够有效防范一些攻击。不过限流再怎么防范，还是会出现系统撑不住流量的情况。</p>\n</blockquote><p><img src=\"https://static001.geekbang.org/resource/image/f5/bc/f5db9767957167ffee24685a233dddbc.png?wh=1920x1031\" alt=\"图片\"></p><p>注意在上面的回答里，我们没有说任何的细节，只是宽泛地介绍了一下限流，那么面试官接下来大概会问每一个算法、不同的限流对象，以及限流后的不同做法的细节。这部分你按照前置知识里面的内容来回答就可以。</p><p>同时，如果你开源了一个限流的仓库，你可以一起介绍一下。</p><blockquote>\n<p>我在 GitHub 上有一个开源仓库，里面放了我为 gRPC 实现的各种限流算法，包括基于 Redis 实现的集群限流版本。</p>\n</blockquote><p>如果你是跨语言面试，比如你是 Python 转 Go，你就可以强调一下，这个原本在我司是 Python 写的，后来我用 Go 又写了一遍。如果你有进行一些改进，你可以把你具体改进的内容表述出来。</p><p>接下来是一些对限流的深入讨论，这部分内容能让你刷出不少的亮点。</p><h3>突发流量</h3><p>前面我们提到了“算法之间比较重要的一个区别是能否处理小规模的突发流量”，就是为这个部分的详细阐述留下了一个引子。</p><p>假如说正常你的限流是一秒钟 100 个请求，但是如果某一秒钟来了 101 个请求，你依旧会觉得第 101 个请求应该尽可能处理掉。在这种场景下，漏桶是做不到的，因为漏桶是非常均匀的。一秒钟 100 个请求在漏桶里面就是 10 毫秒一个请求，绝对不会多也不会少。</p><p>而令牌桶就能够处理。比如说令牌桶产生令牌的速率是 100 个每秒，但是桶的容量是 20 个，那么也就是说某一秒钟内，最多可以处理 120个请求。</p><p>$$20（前一秒攒的令牌）+ 100（当下这一秒）=120$$</p><p><img src=\"https://static001.geekbang.org/resource/image/81/f9/813cb06153d11bccb3abca6e394c5df9.png?wh=1920x880\" alt=\"图片\"></p><p>固定窗口和滑动窗口则有另外一个类似的问题，就是毛刺问题。</p><p>假如一个窗口大小是一分钟 1000 个请求，你预计这1000 个请求会均匀分散在这一分钟内。那么有没有可能第一秒钟就来了 1000 个请求？当然可能。那当下这一秒系统有没有可能崩溃？自然也是可能的。</p><p><img src=\"https://static001.geekbang.org/resource/image/6e/53/6e474byy5b9f9769d49f0c41f075ab53.png?wh=1618x1146\" alt=\"图片\"></p><p>所以固定窗口和滑动窗口的窗口时间不能太长。比如说以秒为单位是合适的，但是以分钟作为单位就是不合适的。</p><p>那么在面试官问到，或者你在介绍了漏桶或令牌桶算法之后，就可以补充这一段。</p><blockquote>\n<p>漏桶算法非常均匀，但是令牌桶相比之下就没那么均匀。令牌桶本身允许积攒一部分令牌，所以如果有偶发的突发流量，那么这一部分请求也能得到正常处理。但是要小心令牌桶的容量，不能设置太大。不然积攒的令牌太多的话就起不到限流效果了。例如容量设置为 1000，那么要是积攒了 1000 个令牌之后真的突然来了 1000 个请求，它们都能拿到令牌，那么系统可能撑不住这突如其来的 1000 个请求。</p>\n</blockquote><h3>请求大小</h3><p>刚刚我们讨论的限流是针对请求的个数进行的，但并没有考虑到另一个非常关键的问题，就是请求的大小。我在负载均衡里曾提过到这个问题，就是负载均衡算法基本上都没有考虑请求所需的资源。同理在限流算法也是如此。</p><p>限流是针对请求个数进行的，那么显然，如果有两台实例，一台实例处理的都是小请求，另一台实例处理的都是大请求，那么都限流在每秒 100 个请求。可能第一台实例什么问题都没有，而第二台实例就崩溃了。</p><p>所以如果面试官问到为什么使用了限流，系统还是有可能崩溃，或者你在负载均衡里面聊到了请求大小的问题，都可以这样来回答，关键词是<strong>请求大小</strong>。</p><blockquote>\n<p>限流和负载均衡有点儿像，基本没有考虑请求的资源消耗问题。所以负载均衡不管怎么样，都会有偶发性负载不均衡的问题，限流也是如此。例如即便我将一个实例限制在每秒 100 个请求，但是万一这个 100 个请求都是消耗资源很多的请求，那么最终这个实例也可能会承受不住负载而崩溃。动态限流算法一定程度上能够缓解这个问题，但是也无法根治，因为一个请求只有到它被执行的时候，我们才知道它是不是大请求。</p>\n</blockquote><p>以上就是我们在回答限流相关问题时的基本思路，如果可以回答出来，基本上就可以拿到一个70分的成绩，你满意吗？相信你和我一样，还想要更加出类拔萃一点，那这时候就要从计算阈值上面下功夫了。</p><h2>计算阈值</h2><p>在面试限流的基本回答里面，你已经主动提起了限流阈值难以确定。那么不出所料，面试官就会问你怎么确定阈值。又或者你使用了限流的不同案例，那么面试官也会问你限流的阈值是怎么确定的。</p><p>总体上思路有四个：看服务的观测数据、压测、借鉴、手动计算。</p><p>看服务的性能数据属于常规解法，基本上就是看业务高峰期的 QPS 来确定整个集群的阈值。如果要确定单机的阈值，那就再除以实例个数。所以你可以这样来回答，关键词是<strong>业务性能数据</strong>。</p><blockquote>\n<p>我们公司有完善的监控，所以我可以通过观测到的性能数据来确定阈值。比如说观察线上的数据，如果在业务高峰期整个集群的 QPS 都没超过 1000，那么就可以考虑将阈值设定在 1200，多出来的 200 就是余量。<br>\n&nbsp;<br>\n不过这种方式有一个要求，就是服务必须先上线，有了线上的观测数据才能确定阈值。并且，整个阈值很有可能是偏低的。因为业务巅峰并不意味着是集群性能的瓶颈。如果集群本身可以承受每秒3000个请求，但是因为业务量不够，每秒只有 1000 个请求，那么我这里预估出来的阈值是显著低于集群真实瓶颈 QPS 的。</p>\n</blockquote><p>注意你在回答的时候也解释了这种方法的缺陷，这算是一个小亮点。然后我们可以继续讨论其他的思路，关键词是<strong>压测</strong>。</p><blockquote>\n<p>不过我个人觉得，最好的方式应该是在线上执行全链路压测，测试出瓶颈。即便不能做全链路压测，也可以考虑模拟线上环境进行压测，再差也应该在测试环境做一个压力测试。</p>\n</blockquote><p>在这个回答里面你其实已经回答出了最正确的思路：做压测，而且你要强调全链路压测。理由很简单，限流针对的是线上环境，那么自然要尽可能模拟线上环境。最符合这个要求的就是全链路压测了，它就是直接在线上环境执行的，因此结果也是最准的。</p><p>然后你需要进一步解释，怎么利用压测结果。大部分性能测试的结果类似于图片里展示的这样，当然你是不太可能搞出来那么优雅的图形，多少会有些偏差。</p><p><img src=\"https://static001.geekbang.org/resource/image/f2/78/f2aae0a1846ae59b4ff218b8b742b778.png?wh=1710x1310\" alt=\"图片\"></p><p>从理论上来说，你可以选择 A、B、C 当中的任何一个点作为你的限流的阈值。</p><p>A是性能最好的点。A 之前 QPS 虽然在上升，但是响应时间稳定不变。在这个时候资源利用率也在提升，所以选择 A 你可以得到最好的性能和较高的资源利用率。</p><p>B是系统快要崩溃的临界点。很多人会选择这个点作为限流的阈值。这个点响应时间已经比较长了，但是系统还能撑住。选择这个点意味着能撑住更高的并发，但是性能不是最好的，吞吐量也不是最高的。</p><p>C是吞吐量最高的点。实际上，有些时候你压测出来的 B 和 C 可能对应到同一个 QPS 的值。选择这个点作为限流阈值，你可以得到最好的吞吐量。</p><p>你在回答怎么选之前，最好给面试官比划一下上面这张图中的三条曲线，然后解释这三个点，口诀就是<strong>性能A、并发B、吞吐量C</strong>。</p><blockquote>\n<p>综合来说，如果是性能苛刻的服务，我会选择 A 点。如果是追求最高并发的服务，我会选择 B 点，如果是追求吞吐量的服务，我会选择 C 点。</p>\n</blockquote><p>面试官多半会杠你，压力测试特别难，或者有些服务根本测不了，那你怎么办。这个时候，你需要说点正确但没用的废话，关键词<strong>压测是基操</strong>。你在表述的时候语气要委婉，态度要坚决。</p><blockquote>\n<p>一般我会认为一家公司应该把压测作为提高系统性能和可用性的一个关键措施，毕竟没有压测数据，性能优化和可用性改进也不知道怎么下手。所以我还是比较建议尽可能把压测搞起来，反正压测这个东西是迟早要有的。</p>\n</blockquote><p>然后你就要转过话头，顺着面试官的话往下说，讨论真的做不了压测的时候怎么确定阈值。关键词就是<strong>借鉴。</strong></p><blockquote>\n<p>不过如果真的做不了，或者来不及，或者没资源，那么还可以考虑参考类似服务的阈值。比如说如果A、B服务是紧密相关的，也就是通常调用了A服务就会调用B服务，那么可以用 A 已经确定的阈值作为 B 的阈值。又或者 A 服务到 B 服务之间有一个转化关系。比如说创建订单到支付，会有一个转化率，假如说是 90%，如果创建订单的接口阈值是 100，那么支付的接口就可以设置为 90。</p>\n</blockquote><p><img src=\"https://static001.geekbang.org/resource/image/0c/c8/0c61db166f5445570c28f134c73096c8.png?wh=1920x977\" alt=\"图片\"></p><p>这个时候面试官可能会继续问：如果我这是一个全新的业务呢？也就是说，你都没得借鉴。这个时候就只剩下最后一招了——<strong>手动计算</strong>。</p><blockquote>\n<p>实在没办法了，就只能手动计算了。也就是沿着整条调用链路统计出现了多少次数据库查询、多少次微服务调用、多少次第三方中间件访问，如Redis，Kafka等。举一个最简单的例子，假如说一个非常简单的服务，整个链路只有一次数据库查询，这是一个会回表的数据库查询，根据公司的平均数据这一次查询会耗时 10ms，那么再增加 10 ms 作为 CPU 计算耗时。也就是说这一个接口预期的响应时间是 20ms。如果一个实例是 4 核，那么就可以简单用$1000ms\\div 20ms \\times 4 = 200$得到阈值。</p>\n</blockquote><p>这个时候你还可以进一步补充一些手动计算要考虑的事情。</p><blockquote>\n<p>手动计算准确度是很差的。比如说垃圾回收类型语言，还要刨除垃圾回收的开销，相当于 200 打个折扣。折扣多大又取决于你的垃圾回收频率和消耗。</p>\n</blockquote><p>最后再升华一下主题。</p><blockquote>\n<p>最好还是把阈值做成可以动态调整的。那么在最开始上线的时候就可以把阈值设置得比较小。后面通过观测发现系统还很健康，就可以继续上调阈值。</p>\n</blockquote><h2>面试思路总结</h2><p>这节课我们讨论了限流的主要问题，包括限流算法，限流对象以及限流之后的做法。在讨论怎么计算阈值的问题时，你尤其要<strong>记住里面提到的 ABC 三个点</strong>。不仅仅是面试中，在你实际工作中也用得上的。</p><p>我也再次强调一下，你应该在面试前尽可能在公司里面应用一下限流，同时尝试做一做压测。如果公司没有这种压测的环境，那么这正好是你刷 KPI 的机会。你把压测环境准备好，流程标准化之后，这件事情本身也可以作为你面试时候的一个亮点。</p><p>同样地，这里有我整理的思维导图，你可以参考。</p><p><img src=\"https://static001.geekbang.org/resource/image/8f/4d/8f957b9ae283f9bdac1ce4395e3e0f4d.jpg?wh=2708x2206\" alt=\"\"></p><h2>思考题</h2><p>最后你来思考几个问题。</p><ul>\n<li>针对 IP 限流是一个非常常见的限流方案，那么怎么获得用户的 IP 呢？尤其是在请求经过了网关的情况下，怎么避免自己拿到的是网关的 IP？</li>\n<li>我在阈值里面提到的 ABC 三个点，你能说出你的业务应该使用哪个点吗？</li>\n</ul><p>欢迎你把你的答案分享在评论区，也欢迎你把这节课的内容分享给需要的朋友，我们下节课再见！</p>","comments":[{"had_liked":false,"id":376974,"user_name":"3.0的A7","can_delete":false,"product_type":"c1","uid":1211991,"ip_address":"北京","ucode":"23C5F02B45CE39","user_header":"https://static001.geekbang.org/account/avatar/00/12/7e/57/8c1051b6.jpg","comment_is_top":false,"comment_ctime":1687784974,"is_pvip":false,"replies":[{"id":137397,"content":"优秀优秀！哈哈哈，能够找准资料也是一种能力！","user_name":"作者回复","user_name_real":"编辑","uid":1176655,"ctime":1687786857,"ip_address":"广东","comment_id":376974,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100551601,"comment_content":"获取用户的真实IP，有一下集中方法，分别是应用层方法、传输层方法、网络层方法：\n1、应用层方法：X-Forwarded-For\n缺点:会被伪造、多个X-Forwarded-For头部、不能解决HTTP和SMTP之外的真实源IP获取的需求\n2、传输层方法：利用 TCP Options 的字段来承载真实源 IP 信息、Proxy Protocol、NetScaler 的 TCP IP header\n3、网络层：隧道 +DSR 模式\n贴一下参考(照抄)来源吧:https:&#47;&#47;time.geekbang.org&#47;column&#47;article&#47;497864","like_count":25,"discussions":[{"author":{"id":1176655,"avatar":"https://static001.geekbang.org/account/avatar/00/11/f4/4f/aa916c8c.jpg","nickname":"邓小明","note":"","ucode":"02243D1F7492A6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":621944,"discussion_content":"优秀优秀！哈哈哈，能够找准资料也是一种能力！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1687786857,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":376940,"user_name":"虎虎生威的程坚强","can_delete":false,"product_type":"c1","uid":1299095,"ip_address":"广东","ucode":"321C89298D3682","user_header":"https://static001.geekbang.org/account/avatar/00/13/d2/97/5f4cd8da.jpg","comment_is_top":false,"comment_ctime":1687756240,"is_pvip":false,"replies":[{"id":137402,"content":"赞！要小心 X-Forwarded-For 是可以伪造的。","user_name":"作者回复","user_name_real":"编辑","uid":1176655,"ctime":1687787448,"ip_address":"广东","comment_id":376940,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100551601,"comment_content":"一般代理服务器把http请求转发到下一个节点时，会在http header头中加入“X-Forwarded-For”字段，用以记录这个请求从哪里来的，所以看这个字段的第一个值就是原始的用户ip","like_count":8,"discussions":[{"author":{"id":1176655,"avatar":"https://static001.geekbang.org/account/avatar/00/11/f4/4f/aa916c8c.jpg","nickname":"邓小明","note":"","ucode":"02243D1F7492A6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":621949,"discussion_content":"赞！要小心 X-Forwarded-For 是可以伪造的。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1687787448,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":377374,"user_name":"penbox","can_delete":false,"product_type":"c1","uid":1052938,"ip_address":"四川","ucode":"59C4F47ACCB7F2","user_header":"https://static001.geekbang.org/account/avatar/00/10/11/0a/59639f1f.jpg","comment_is_top":false,"comment_ctime":1688393505,"is_pvip":true,"replies":[{"id":137526,"content":"赞！","user_name":"作者回复","user_name_real":"编辑","uid":1176655,"ctime":1688454648,"ip_address":"中国台湾","comment_id":377374,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100551601,"comment_content":"1. 针对 IP 限流是一个非常常见的限流方案，那么怎么获取用户的 IP 呢？尤其是在请求经过网关的情况下，怎么避免拿到的是网关的 IP ？\n可以是用 HTTP 请求头中的，X-Forwarded-For（XFF）自定有头字段。可以获取客户端的真实地址，还可以获取整个请求链中的所有代理服务器 IP 地址。\n但要注意 X-Forwarded-For 头是可伪造的字段。\n2. 我在阈值里面提到的 ABC 三点，你能说出你的业务应该使用哪个点吗？\n我觉得需要根据系统的整体情况来考虑。\n如果系统很少会触发阈值，可以考虑 B 点，追求最大并发数。触发限流之后，系统一般阻塞下，扛一扛就过去了。\n如果系统长时间在阈值附近徘徊，说明系统性能已经接近极限了，就算把请求阻塞下，最后多半也是超时。这个时候选 C 点更好，最大吞吐量，能处理掉最多的请求。\n如果系统对性能要求苛刻，比如整条链路超时时间很短，那就只能选 A 点，最大化性能。但凡请求的响应时间长一点，可能就整体超时了。","like_count":7,"discussions":[{"author":{"id":1176655,"avatar":"https://static001.geekbang.org/account/avatar/00/11/f4/4f/aa916c8c.jpg","nickname":"邓小明","note":"","ucode":"02243D1F7492A6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":622594,"discussion_content":"赞！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1688454648,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"中国台湾","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":380581,"user_name":"sheep","can_delete":false,"product_type":"c1","uid":2770150,"ip_address":"广东","ucode":"DAC2036F08CE27","user_header":"https://static001.geekbang.org/account/avatar/00/2a/44/e6/2c97171c.jpg","comment_is_top":false,"comment_ctime":1693842960,"is_pvip":false,"replies":[{"id":138637,"content":"不是。比如说，我和女朋友在家里用一个路由器，又或者运营商给我们整个小区的公共 IP 都是同一个。或者你可以认为，你到某地连上 wifi 之后，可能共享这个 wifi 的所有人，在对外的 IP 都是同一个。","user_name":"作者回复","user_name_real":"编辑","uid":1176655,"ctime":1694182574,"ip_address":"广东","comment_id":380581,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100551601,"comment_content":"&quot;这个 50 充分考虑到了公共 IP 的问题&quot;，这里指的是，用户可能连这个wifi或者另外一个wifi，又或者使用流量。以至于ip不一样，这种情况么","like_count":3,"discussions":[{"author":{"id":1176655,"avatar":"https://static001.geekbang.org/account/avatar/00/11/f4/4f/aa916c8c.jpg","nickname":"邓小明","note":"","ucode":"02243D1F7492A6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":627487,"discussion_content":"不是。比如说，我和女朋友在家里用一个路由器，又或者运营商给我们整个小区的公共 IP 都是同一个。或者你可以认为，你到某地连上 wifi 之后，可能共享这个 wifi 的所有人，在对外的 IP 都是同一个。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1694182574,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":377183,"user_name":"有何不可","can_delete":false,"product_type":"c1","uid":1965953,"ip_address":"北京","ucode":"908B51CF27F63F","user_header":"https://static001.geekbang.org/account/avatar/00/1d/ff/81/0bfa6b9d.jpg","comment_is_top":false,"comment_ctime":1688030573,"is_pvip":false,"replies":[{"id":137468,"content":"总结很到位！\n单机限流第三点是值得讨论的。因为本身在单机限流的时候，你可以不再考虑集群整个流量限制多少了。比如说每台机器限流 100，已经有两台了，也就是整个限流是 200。但是如果你再加一个机器，这个机器其实也可以限流 100。\n\n这也就是说，你单机限流是从单机的处理能力角度考虑的。","user_name":"作者回复","user_name_real":"编辑","uid":1176655,"ctime":1688107827,"ip_address":"广东","comment_id":377183,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100551601,"comment_content":"限流还分单机限流和集群限流两种模式。单机限流即每台实例维护自己的计数器，而集群限流则是共用一个中央模式的计数器；\n单机限流有以下特点：\n1、会出现误限的情况，比如说有两台实例 A 和 B，每个单机限流阈值为 10，那么整体限流阈值是 20，但是如果出现负载不均，某一秒 A 接收的请求是 15，B 接收的请求是 5，那么根据单机阈值，A 将放行 10 个请求，B 放行 5 个请求，这一秒内实际只承接了 15 个请求，而我们的期望是 20；\n2、无法很好的设置精确的限流值，一般情况下，单机限流阈值 = 整体限流阈值 &#47; 实例数。比如说实例数有 50 个，但是想要 80 的限流值就无法精确匹配。 单机限流阈值设置为 1 的情况下整体限流阈值只有 50 ，单机限流阈值设置为 2 的情况下整体限流阈值则达到了 100。\n3、如果整体限流值不变，实例进行扩、缩容是单机限流阈值要跟着更新单机限流阈值；\n集群限流的特点：\n1、使用中央模式的计数器，不会出现单机限流出现的误限、无法精确匹配限流值以及扩、缩容调整问题，限流值比较准确；\n2、依赖提供中央技术器的服务，如果该服务不可用，那么限流功能将不可用，此时可以考虑降级到单机限流；\n","like_count":3,"discussions":[{"author":{"id":1176655,"avatar":"https://static001.geekbang.org/account/avatar/00/11/f4/4f/aa916c8c.jpg","nickname":"邓小明","note":"","ucode":"02243D1F7492A6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":622328,"discussion_content":"总结很到位！\n单机限流第三点是值得讨论的。因为本身在单机限流的时候，你可以不再考虑集群整个流量限制多少了。比如说每台机器限流 100，已经有两台了，也就是整个限流是 200。但是如果你再加一个机器，这个机器其实也可以限流 100。\n\n这也就是说，你单机限流是从单机的处理能力角度考虑的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1688107827,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":377021,"user_name":"spark","can_delete":false,"product_type":"c1","uid":1958536,"ip_address":"浙江","ucode":"5D34AB26EA95C0","user_header":"https://static001.geekbang.org/account/avatar/00/1d/e2/88/3e73c2c2.jpg","comment_is_top":false,"comment_ctime":1687845769,"is_pvip":false,"replies":[{"id":137427,"content":"在努力写了，尽量更新！","user_name":"作者回复","user_name_real":"编辑","uid":1176655,"ctime":1687925998,"ip_address":"广东","comment_id":377021,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100551601,"comment_content":"老师，能不能每次更新的章节多一点，因为课程题目是面经，那么订阅的人肯定目前都是有面试需求的，拜托了","like_count":3,"discussions":[{"author":{"id":1176655,"avatar":"https://static001.geekbang.org/account/avatar/00/11/f4/4f/aa916c8c.jpg","nickname":"邓小明","note":"","ucode":"02243D1F7492A6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":622110,"discussion_content":"在努力写了，尽量更新！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1687925998,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":379297,"user_name":"Young","can_delete":false,"product_type":"c1","uid":2621738,"ip_address":"湖北","ucode":"143CDD255DFC25","user_header":"https://static001.geekbang.org/account/avatar/00/28/01/2a/b4600b36.jpg","comment_is_top":false,"comment_ctime":1691674257,"is_pvip":false,"replies":[{"id":138210,"content":"哈哈哈，因为日常接触到的，比较少内存反而是瓶颈的任务，因此基本上都没有考虑过内存开支。\n用最一般的说法，计算阈值就看你的业务所需的关键资源。如果是 CPU 就是 CPU，如果是内存就是内存，如果是磁盘 IO 就是磁盘 IO。","user_name":"作者回复","user_name_real":"编辑","uid":1176655,"ctime":1691754656,"ip_address":"广东","comment_id":379297,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100551601,"comment_content":"对了，在计算阈值时候通常考虑cpu的QPS，但内存容量是不是应该也考虑下，对于内存有：QPS = (TotalRAM &#47; TaskMemoryUsage) &#47;  (1&#47;Taskduration)，抄自：https:&#47;&#47;medium.com&#47;geekculture&#47;how-to-calculate-server-max-requests-per-second-38a39bb96a85","like_count":1,"discussions":[{"author":{"id":1176655,"avatar":"https://static001.geekbang.org/account/avatar/00/11/f4/4f/aa916c8c.jpg","nickname":"邓小明","note":"","ucode":"02243D1F7492A6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":625492,"discussion_content":"哈哈哈，因为日常接触到的，比较少内存反而是瓶颈的任务，因此基本上都没有考虑过内存开支。\n用最一般的说法，计算阈值就看你的业务所需的关键资源。如果是 CPU 就是 CPU，如果是内存就是内存，如果是磁盘 IO 就是磁盘 IO。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1691754656,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":386718,"user_name":"nadream","can_delete":false,"product_type":"c1","uid":1337149,"ip_address":"浙江","ucode":"B907871D6414FC","user_header":"https://static001.geekbang.org/account/avatar/00/14/67/3d/71031021.jpg","comment_is_top":false,"comment_ctime":1705398249,"is_pvip":false,"replies":[{"id":141055,"content":"已经离职了，不好说了。不过你可以参考别的大厂出来做的分享，他们很喜欢分享 xxx 系统的监控之类的主题。","user_name":"作者回复","user_name_real":"编辑","uid":1176655,"ctime":1705927218,"ip_address":"广东","comment_id":386718,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100551601,"comment_content":"关于贵公司的监控，可以详细展开说说吗，怎么破？","like_count":0,"discussions":[{"author":{"id":1176655,"avatar":"https://static001.geekbang.org/account/avatar/00/11/f4/4f/aa916c8c.jpg","nickname":"邓小明","note":"","ucode":"02243D1F7492A6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":636302,"discussion_content":"已经离职了，不好说了。不过你可以参考别的大厂出来做的分享，他们很喜欢分享 xxx 系统的监控之类的主题。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1705927218,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":386544,"user_name":"Geek_6c2524","can_delete":false,"product_type":"c1","uid":2225632,"ip_address":"上海","ucode":"148788C1DA6D0C","user_header":"","comment_is_top":false,"comment_ctime":1705048367,"is_pvip":false,"replies":[{"id":141057,"content":"QPS 侧重的是请求数量，吞吐量侧重的是任务数量或者数据数量。在互联网里面，这两个是很接近的，但是在批处理之类的场景里面，这两者会有点区别。","user_name":"作者回复","user_name_real":"编辑","uid":1176655,"ctime":1705927495,"ip_address":"广东","comment_id":386544,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100551601,"comment_content":"请问老师，QPS和吞吐量有什么区别？Jmeter通常展示的结果里的throughput（吞吐量）好像就是QPS；这两者在您的图里面有什么区别呢？","like_count":0,"discussions":[{"author":{"id":1176655,"avatar":"https://static001.geekbang.org/account/avatar/00/11/f4/4f/aa916c8c.jpg","nickname":"邓小明","note":"","ucode":"02243D1F7492A6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":636304,"discussion_content":"QPS 侧重的是请求数量，吞吐量侧重的是任务数量或者数据数量。在互联网里面，这两个是很接近的，但是在批处理之类的场景里面，这两者会有点区别。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1705927495,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":384845,"user_name":"梦倚栏杆","can_delete":false,"product_type":"c1","uid":1095857,"ip_address":"北京","ucode":"BDEB97F2822445","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/bvj76PmeUvW8kokyu91IZWuRATKmabibDWbzAj2TajeEic7WvKCJOLaOh6jibEmdQ36EO3sBUZ0HibAiapsrZo64U8w/132","comment_is_top":false,"comment_ctime":1701679127,"is_pvip":false,"replies":[{"id":140339,"content":"这算是一个非常好的问题。如果你要综合考虑多个服务的话，你需要模拟线上流量的比例来进行压测。比如说 A 接口和 B 接口各自占据了 70% 和 30%，那么你在压测的时候，压测流量额的 70% 是给 A 的，30% 是给 B 的。","user_name":"作者回复","user_name_real":"编辑","uid":1176655,"ctime":1701846157,"ip_address":"广东","comment_id":384845,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100551601,"comment_content":"关于压测和阈值我想问，一个服务肯定有多个接口，这多个接口有些处理时间长，有些慢，他们共用一系列资源，相互之间是有影响的，单独一个接口压到顶峰，可能其他接口直接就凉凉了，这个时候应该怎么来设置，怎么压测呢？另外写接口或者post接口也可以压测吗？","like_count":0,"discussions":[{"author":{"id":1176655,"avatar":"https://static001.geekbang.org/account/avatar/00/11/f4/4f/aa916c8c.jpg","nickname":"邓小明","note":"","ucode":"02243D1F7492A6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":633114,"discussion_content":"这算是一个非常好的问题。如果你要综合考虑多个服务的话，你需要模拟线上流量的比例来进行压测。比如说 A 接口和 B 接口各自占据了 70% 和 30%，那么你在压测的时候，压测流量额的 70% 是给 A 的，30% 是给 B 的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1701846157,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":382297,"user_name":"3.0的A7","can_delete":false,"product_type":"c1","uid":1211991,"ip_address":"北京","ucode":"23C5F02B45CE39","user_header":"https://static001.geekbang.org/account/avatar/00/12/7e/57/8c1051b6.jpg","comment_is_top":false,"comment_ctime":1697015188,"is_pvip":false,"replies":[{"id":139367,"content":"1. 实际上，我就搞过全部接口有一个限流阈值，以及单一的核心接口又有一个阈值，双重限流。\n2. 是的，但是没办法，因为你作为一个服务端你不知道他们是归属于同一个业务的请求。\n3. 其实我也见过 Go 的客户端。如果你要跨语言的话，最好就是手写了。比如说用 Redis，那么写好一个 lua 脚本，各个语言都调用同一个脚本。又或者，自己照着抄一个别的语言的 sentinel, hystrix。","user_name":"作者回复","user_name_real":"编辑","uid":1176655,"ctime":1697726147,"ip_address":"广东","comment_id":382297,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100551601,"comment_content":"关于限流有几个疑问：\n1、目前一些方案都是基于接口粒度的，这样的话，是需要针对每一个接口都要进行限流的配置吗，这样的话，如果一个服务能承受的最大qps是3000，共有10个接口，假设每个接口的访问频率都差不多，是不是要针对每个接口设置最大300？\n2、如果针对单机维度进行3000的限流，会不会出现一种情况，就是如果一个完整的业务需要n多个接口，前m个都通过了，结果后边突然被限制，这样前边m个接口的计算资源是不是也被浪费了？\n\n3、目前sentinel、Hystrix 都是针对java的，如果公司内部技术栈比较多，有没有通用的限流方案呢？nginx可以限，但是可能解决不了上面的两个问题。","like_count":0,"discussions":[{"author":{"id":1176655,"avatar":"https://static001.geekbang.org/account/avatar/00/11/f4/4f/aa916c8c.jpg","nickname":"邓小明","note":"","ucode":"02243D1F7492A6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":629870,"discussion_content":"1. 实际上，我就搞过全部接口有一个限流阈值，以及单一的核心接口又有一个阈值，双重限流。\n2. 是的，但是没办法，因为你作为一个服务端你不知道他们是归属于同一个业务的请求。\n3. 其实我也见过 Go 的客户端。如果你要跨语言的话，最好就是手写了。比如说用 Redis，那么写好一个 lua 脚本，各个语言都调用同一个脚本。又或者，自己照着抄一个别的语言的 sentinel, hystrix。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1697726147,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":382295,"user_name":"Geek_680632","can_delete":false,"product_type":"c1","uid":3730160,"ip_address":"浙江","ucode":"9421FB33A0C6A9","user_header":"","comment_is_top":false,"comment_ctime":1697014540,"is_pvip":false,"replies":[{"id":139366,"content":"1. 确实，关键是这个地方核心是网关要记录好原始的客户端IP。","user_name":"作者回复","user_name_real":"编辑","uid":1176655,"ctime":1697726002,"ip_address":"广东","comment_id":382295,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100551601,"comment_content":"1.用户真实请求IP可以放在上下文中进行传递；2.业务上会优先选择B或者C。","like_count":0,"discussions":[{"author":{"id":1176655,"avatar":"https://static001.geekbang.org/account/avatar/00/11/f4/4f/aa916c8c.jpg","nickname":"邓小明","note":"","ucode":"02243D1F7492A6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":629869,"discussion_content":"1. 确实，关键是这个地方核心是网关要记录好原始的客户端IP。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1697726002,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":381436,"user_name":"lager","can_delete":false,"product_type":"c1","uid":1337612,"ip_address":"河南","ucode":"601480F851D705","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/W3E7AhVKOWLSyCagIhch9AO4ibWgoxdaXyPesl97vo6xKFItu2ibFmwe4QKkARJGHZI5osRmVGaCJ6GnW2oU7jnA/132","comment_is_top":false,"comment_ctime":1695202175,"is_pvip":true,"replies":[{"id":139042,"content":"你说的这个是实现机制，漏桶也可以不用队列实现。我这里强调的是，令牌桶如果不允许积攒令牌，就相当于漏桶了。","user_name":"作者回复","user_name_real":"编辑","uid":1176655,"ctime":1695728796,"ip_address":"广东","comment_id":381436,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100551601,"comment_content":"老师，我的理解中漏桶也是桶，是有容量的。因此，如果简单的理解为“某种程度上，你可以将漏桶算法看作是令牌桶算法的一种特殊形态。你将令牌桶中桶的容量设想为 0，就是漏桶了”是会引起误解的。\n虽然令牌桶的以“恒定的速率产生令牌”和漏桶的“以固定的速率转交给业务逻辑”比较类似，但在桶的实现上，漏桶往往是有一个队列的，这个队列的大小就是漏桶的容量；而令牌桶可以不带队列。","like_count":0,"discussions":[{"author":{"id":1176655,"avatar":"https://static001.geekbang.org/account/avatar/00/11/f4/4f/aa916c8c.jpg","nickname":"邓小明","note":"","ucode":"02243D1F7492A6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":628709,"discussion_content":"你说的这个是实现机制，漏桶也可以不用队列实现。我这里强调的是，令牌桶如果不允许积攒令牌，就相当于漏桶了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1695728797,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":377746,"user_name":"humor","can_delete":false,"product_type":"c1","uid":1181867,"ip_address":"浙江","ucode":"9B48C4C7BEC92C","user_header":"https://static001.geekbang.org/account/avatar/00/12/08/ab/caec7bca.jpg","comment_is_top":false,"comment_ctime":1689140368,"is_pvip":false,"replies":[{"id":137661,"content":"感谢指正，这里应该是 20ms，我修改一下。","user_name":"作者回复","user_name_real":"编辑","uid":1176655,"ctime":1689143337,"ip_address":"广东","comment_id":377746,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100551601,"comment_content":"也就是说这一个接口预期的响应时间是 20ms。如果一个实例是 4 核，那么就可以简单用 1000ms\\div 10ms \\times 4 = 400 得到阈值。\n\n这里为什么会除以10ms，而不是除以20ms呢","like_count":0,"discussions":[{"author":{"id":1176655,"avatar":"https://static001.geekbang.org/account/avatar/00/11/f4/4f/aa916c8c.jpg","nickname":"邓小明","note":"","ucode":"02243D1F7492A6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":623190,"discussion_content":"感谢指正，这里应该是 20ms，我修改一下。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1689143337,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":377316,"user_name":"白日梦想家","can_delete":false,"product_type":"c1","uid":2912063,"ip_address":"广东","ucode":"D1CC3F4EB74317","user_header":"https://static001.geekbang.org/account/avatar/00/2c/6f/3f/2b1c605e.jpg","comment_is_top":false,"comment_ctime":1688311631,"is_pvip":false,"replies":[{"id":137501,"content":"感谢感谢，已经修改啦","user_name":"编辑回复","user_name_real":"编辑","uid":2843479,"ctime":1688362257,"ip_address":"北京","comment_id":377316,"utype":2}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100551601,"comment_content":"脑图里面静态算法那里是不是写错了","like_count":0,"discussions":[{"author":{"id":2843479,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/63/57/cba4c68b.jpg","nickname":"小虎子🐯","note":"","ucode":"4C9530B3FB407B","race_medal":0,"user_type":8,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":622498,"discussion_content":"感谢感谢，已经修改啦","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1688362257,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":8}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":376998,"user_name":"一本书","can_delete":false,"product_type":"c1","uid":2767251,"ip_address":"广东","ucode":"4C07047F052BB4","user_header":"https://static001.geekbang.org/account/avatar/00/2a/39/93/f0247cf8.jpg","comment_is_top":false,"comment_ctime":1687824253,"is_pvip":true,"replies":[{"id":137430,"content":"嘿嘿，坦白说，从非常功利的角度，也就是面试的角度，你能理解就可以出去吹牛逼了。有机会就可以尽量在公司实践一下。","user_name":"作者回复","user_name_real":"编辑","uid":1176655,"ctime":1687926089,"ip_address":"广东","comment_id":376998,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100551601,"comment_content":"老师讲的真好，虽然没用过，但是懂了。自己也尝试画图理解问题试试。","like_count":0,"discussions":[{"author":{"id":1176655,"avatar":"https://static001.geekbang.org/account/avatar/00/11/f4/4f/aa916c8c.jpg","nickname":"邓小明","note":"","ucode":"02243D1F7492A6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":622113,"discussion_content":"嘿嘿，坦白说，从非常功利的角度，也就是面试的角度，你能理解就可以出去吹牛逼了。有机会就可以尽量在公司实践一下。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1687926089,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":376973,"user_name":"peter","can_delete":false,"product_type":"c1","uid":1058183,"ip_address":"北京","ucode":"261C3FC001DE2D","user_header":"https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg","comment_is_top":false,"comment_ctime":1687784240,"is_pvip":false,"replies":[{"id":137396,"content":"我之前回了，不过那时候我还不知道怎么用作者身份回复的。所以你能看到同名的我账号，但是没有标注老师。\n\n我个人用的是亿图全家桶，你可以看看我觉得还不错。一般大促的时候一千块左右就有终身版。","user_name":"作者回复","user_name_real":"编辑","uid":1176655,"ctime":1687786835,"ip_address":"广东","comment_id":376973,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100551601,"comment_content":"Q1：第02课我有几个问题，提得比较晚，麻烦老师回头帮我解答一下，非常感谢！\nQ2：专栏的图是用什么软件制作的，感觉很不错。","like_count":0,"discussions":[{"author":{"id":1176655,"avatar":"https://static001.geekbang.org/account/avatar/00/11/f4/4f/aa916c8c.jpg","nickname":"邓小明","note":"","ucode":"02243D1F7492A6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":621943,"discussion_content":"我之前回了，不过那时候我还不知道怎么用作者身份回复的。所以你能看到同名的我账号，但是没有标注老师。\n\n我个人用的是亿图全家桶，你可以看看我觉得还不错。一般大促的时候一千块左右就有终身版。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1687786835,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":376944,"user_name":"3.0的A7","can_delete":false,"product_type":"c1","uid":1211991,"ip_address":"北京","ucode":"23C5F02B45CE39","user_header":"https://static001.geekbang.org/account/avatar/00/12/7e/57/8c1051b6.jpg","comment_is_top":false,"comment_ctime":1687759731,"is_pvip":false,"replies":[{"id":137400,"content":"坦白来说，如果真的考虑攻击者非常强大的话，几乎可以肯定你拿到的必然是错误的 IP。\n\n所以只能是尽可能防君子不防小人，防菜鸡攻击者防不住大佬攻击者。\n\nX-Forwarded-For 一般也可以信任一下，比如说自己网关主动添加的，不过要是网关拿到的就是错的就没办法了。\n\n但是如果自己有办法调用传输层的接口，效果要好很多，虎虎生风提到的另外两个更加底层的办法。\n\n目前我注意到大部分针对 IP 限流的实现，都是用 X-Forwarded-For 比较多。","user_name":"作者回复","user_name_real":"编辑","uid":1176655,"ctime":1687787302,"ip_address":"广东","comment_id":376944,"utype":1}],"discussion_count":3,"race_medal":0,"score":3,"product_id":100551601,"comment_content":"虎虎生风说的对，但是我百度了下说X-Forwarded-For: client, proxy1, proxy2，这个值是可以被伪造的，那这时候如果还通过ip限流的话，这种方式就不行了，是不是有什么更好的获取ip的方式呢？难道要客户端自己上传吗","like_count":0,"discussions":[{"author":{"id":1176655,"avatar":"https://static001.geekbang.org/account/avatar/00/11/f4/4f/aa916c8c.jpg","nickname":"邓小明","note":"","ucode":"02243D1F7492A6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":621947,"discussion_content":"坦白来说，如果真的考虑攻击者非常强大的话，几乎可以肯定你拿到的必然是错误的 IP。\n\n所以只能是尽可能防君子不防小人，防菜鸡攻击者防不住大佬攻击者。\n\nX-Forwarded-For 一般也可以信任一下，比如说自己网关主动添加的，不过要是网关拿到的就是错的就没办法了。\n\n但是如果自己有办法调用传输层的接口，效果要好很多，虎虎生风提到的另外两个更加底层的办法。\n\n目前我注意到大部分针对 IP 限流的实现，都是用 X-Forwarded-For 比较多。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1687787302,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2033337,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/06/b9/f9bf6696.jpg","nickname":"牧童倒拔垂杨柳","note":"","ucode":"8621DCB8B65CBB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":621928,"discussion_content":"我之前做爬虫会伪造ip，就是从一个ip池里面去随机拿，每一次都不一样，这个如果是对方刻意的规避其实是没法防的，也可以在客户端代码里获取下真实的ip，但那样违法，所以我觉得最好还是不要只有一种限流策略","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1687780702,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"河北","group_id":0},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1211991,"avatar":"https://static001.geekbang.org/account/avatar/00/12/7e/57/8c1051b6.jpg","nickname":"3.0的A7","note":"","ucode":"23C5F02B45CE39","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2033337,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/06/b9/f9bf6696.jpg","nickname":"牧童倒拔垂杨柳","note":"","ucode":"8621DCB8B65CBB","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":621963,"discussion_content":"你所说的 ip 池其实是 ip 代理池，常见的有付费的，也可以自己搭， 这个代理池的机制是使用这个 ip 代理你的爬取数据的请求，否则你随机一个 ip 也能达到你说的目的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1687794283,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":621928,"ip_address":"北京","group_id":0},"score":621963,"extra":""}]}]},{"had_liked":false,"id":395358,"user_name":"open！？","can_delete":false,"product_type":"c1","uid":2278966,"ip_address":"浙江","ucode":"53E6D336DB7F22","user_header":"https://static001.geekbang.org/account/avatar/00/22/c6/36/70f2083c.jpg","comment_is_top":false,"comment_ctime":1730419475,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100551601,"comment_content":"如果大单体架构如何设计限流方案？","like_count":0},{"had_liked":false,"id":392188,"user_name":"一颗星的夜","can_delete":false,"product_type":"c1","uid":1597035,"ip_address":"广东","ucode":"7AAD2AD9691C5D","user_header":"https://static001.geekbang.org/account/avatar/00/18/5e/6b/b8fce3a1.jpg","comment_is_top":false,"comment_ctime":1720191382,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100551601,"comment_content":"压测数据的A、B、C在数学图形上的意义是什么呀？怎么确定具体的值呢","like_count":0}]}