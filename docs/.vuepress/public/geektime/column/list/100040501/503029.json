{"id":503029,"title":"34ï½œå¿«é€Ÿåˆ†é…å’Œé‡Šæ”¾å†…å­˜ï¼šå†…å­˜æ± ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å´å’ç‚œã€‚</p><p>åœ¨ä¸Šä¸€è®²è®²è¿‡äº†æ€§èƒ½æµ‹è¯•ä¹‹åï¼Œæˆ‘ä»¬ç»ˆäºå¯ä»¥å›åˆ°å†…å­˜æ± è¿™ä¸ªè¯é¢˜ï¼Œæ¥æ·±å…¥è®¨è®ºä¸€ä¸‹äº†ã€‚</p><h2>ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹</h2><p>å¦‚æœä½ æƒ³ç”¨å†…å­˜æ± ï¼Œé‚£æˆ‘çš„ç¬¬ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œä½ åˆ°åº•æ˜¯ä¸æ˜¯éœ€è¦ä½¿ç”¨å†…å­˜æ± ï¼Ÿ</p><p>ä¸‹é¢æ˜¯ä¸€äº›ä½ å¯èƒ½æƒ³ä½¿ç”¨å†…å­˜æ± çš„ç†ç”±ï¼š</p><ul>\n<li>å¸Œæœ›å‡å°‘å†…å­˜åˆ†é…å’Œé‡Šæ”¾çš„æ—¶é—´å¼€é”€â€”â€”æ›´å¿«çš„åˆ†é…å’Œé‡Šæ”¾</li>\n<li>å¸Œæœ›å‡å°‘å†…å­˜åˆ†é…å’Œé‡Šæ”¾çš„ç©ºé—´å¼€é”€â€”â€”æ›´å°‘çš„æ€»ä½“å†…å­˜ä½¿ç”¨</li>\n</ul><p>ä¸‹é¢åˆ™æ˜¯ä¸€äº›åå¯¹ä½¿ç”¨å†…å­˜æ± çš„ç†ç”±ï¼š</p><ul>\n<li>ä½ çš„é€šç”¨å†…å­˜åˆ†é…å™¨å¯èƒ½å·²ç»è¶³å¤Ÿå¿«äº†</li>\n<li>ä½¿ç”¨å†…å­˜æ± å¯èƒ½å¯¼è‡´æ“ä½œç³»ç»Ÿæ›´éš¾å›æ”¶ä½ å·²ç»ä¸å†éœ€è¦çš„å†…å­˜</li>\n<li>ä½¿ç”¨å†…å­˜æ± å¯èƒ½ä½¿å¾—ä½ çš„å¯¹è±¡è¾ƒéš¾è·Ÿå…¶ä»–å¯¹è±¡è¿›è¡Œäº¤äº’ï¼ˆå‚è€ƒ<a href=\"https://time.geekbang.org/column/article/491227\">ç¬¬ 32 è®²</a>ï¼Œåœ¨ PMR ä¹‹å‰åˆ†é…å™¨æ˜¯å®¹å™¨ç±»å‹çš„ä¸€éƒ¨åˆ†ï¼‰</li>\n</ul><p>å½“ç„¶ï¼Œæ—¢ç„¶ä½ çœ‹åˆ°è¿™é‡Œäº†ï¼Œä½ è‚¯å®šæ˜¯æƒ³è¦ä½¿ç”¨å†…å­˜æ± çš„ã€‚ä¸è¿‡ï¼Œæˆ‘ä»¬éœ€è¦èƒ½å¤Ÿè¡¡é‡ä½¿ç”¨å†…å­˜æ± çš„æ•ˆæœï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è¿›è¡Œæµ‹è¯•ã€‚</p><p>å¦‚æœä½ æƒ³è¦è¿›è¡ŒæŸä¸ªæ“ä½œçš„æ€§èƒ½æµ‹è¯•ï¼Œä½ å°±éœ€è¦æŸç§â€œå…¸å‹åœºæ™¯â€ã€‚ä½œä¸ºä¾‹å­ï¼Œæˆ‘è¿™å„¿æ‹¿ä¸€ä¸ªæºå…¥äº†éšæœºæ“ä½œçš„è¿‡ç¨‹å½“ä½œæµ‹è¯•åœºæ™¯ã€‚å…·ä½“æ¥è¯´ï¼Œæˆ‘åšçš„äº‹æƒ…æ˜¯ï¼š</p><ol>\n<li>äº§ç”Ÿéšæœºæ•°</li>\n<li>æŠŠè¿™äº›éšæœºæ•°æ’å…¥åˆ°ä¸€ä¸ª <code>unordered_set</code> ä¸­ï¼Œæµ‹é‡æ‰€éœ€çš„æ—¶é—´</li>\n<li>æŠŠè¿™äº›éšæœºæ•°ä»è¿™ä¸ª <code>unordered_set</code> é‡Œé€ä¸ªåˆ é™¤ï¼Œæµ‹é‡æ‰€éœ€çš„æ—¶é—´</li>\n<li>å†æŠŠè¿™äº›éšæœºæ•°é‡æ–°æ’å…¥åˆ° <code>unordered_set</code> ä¸­ï¼Œæµ‹é‡æ‰€éœ€çš„æ—¶é—´</li>\n</ol><!-- [[[read_end]]] --><p>è¿™è™½ç„¶ä¸æ˜¯ä¸€ä¸ªå®Œç¾çš„ä¾‹å­ï¼Œä½†ç¡®å®å¯ä»¥è®©æˆ‘ä»¬è§‚å¯Ÿåˆ°å†…å­˜æ± çš„ä½œç”¨ã€‚å¦‚æœä½ æœ‰çœŸå®çš„åœºæ™¯ï¼Œä¹Ÿå¯ä»¥å€Ÿé‰´è¿™ç§æ–¹å¼æ¥è¿›è¡Œæµ‹è¯•ã€‚</p><p>æˆ‘ä»¬çš„å¾…æµ‹å¯¹è±¡å’Œç±»å‹éå¸¸ç®€å•ï¼š</p><pre><code class=\"language-cpp\">using TestType = unordered_set&lt;int&gt;;\nTestType s;\n</code></pre><p>äº§ç”Ÿéšæœºæ•°çš„ä»£ç ç•¥å¤æ‚ä¸€ç‚¹ç‚¹ï¼š</p><pre><code class=\"language-cpp\">mt19937 engine;\nuniform_int_distribution&lt;int&gt; dist;\narray&lt;int, LEN&gt; rand_nums{};\nfor (int&amp; num : rand_nums) {\n  num = dist(engine);\n}\n</code></pre><p>æˆ‘ä»¬å¸Œæœ›å¾—åˆ°è·¨å¹³å°çš„ç¨³å®šæµ‹è¯•ç»“æœï¼Œå› æ­¤æŒ‡å®šäº†ä¸€ä¸ªåå£°ä¸é”™çš„ä¼ªéšæœºæ•°å¼•æ“ <code>mt19937</code>ï¼ˆå¦åˆ™é»˜è®¤çš„ä¼ªéšæœºæ•°å¼•æ“ <code>default_random_engine</code> ä¹Ÿæ²¡ä»€ä¹ˆé—®é¢˜ï¼‰ã€‚æˆ‘ä»¬åªéœ€è¦ä¸€ä¸ªç®€å•çš„éšæœºå‡åŒ€åˆ†å¸ƒï¼Œå› è€Œä½¿ç”¨äº†é»˜è®¤æ„é€ çš„ <code>uniform_int_distribution</code>ï¼Œä¸ç»™å‡ºéšæœºæ•°çš„èŒƒå›´ï¼Œæ¥äº§ç”Ÿæ‰€æœ‰åˆæ³•æ•´æ•°èŒƒå›´å†…çš„éšæœºæ•°ã€‚ç„¶åï¼Œæˆ‘ä»¬åœ¨é•¿åº¦ä¸º <code>LEN</code> çš„æ•°ç»„ä¸­ï¼Œæ¯ä¸€é¡¹ï¼ˆæ³¨æ„æ­¤å¤„å¿…é¡»ä½¿ç”¨å¼•ç”¨çš„æ–¹å¼æ¥èŒƒå›´éå† <code>rand_nums</code>ï¼‰éƒ½å†™å…¥ä¸€ä¸ªéšæœºçš„æ•´æ•°ã€‚ç”±äºæˆ‘ä»¬æ²¡æœ‰å¯¹éšæœºæ•°å¼•æ“ä½¿ç”¨çœŸæ­£éšæœºçš„ç§å­æ¥åˆå§‹åŒ–ï¼Œè¿™äº›éšæœºæ•°æ¯æ¬¡éƒ½æ˜¯ç›¸åŒçš„ï¼Œå¯ä»¥ä¿è¯æµ‹è¯•çš„ç¨³å®šæ€§ã€‚</p><p>åˆå§‹æ’å…¥æ“ä½œå°±ç®€å•äº†ï¼Œåªæ˜¯æŠŠæ•°ç»„ <code>rand_nums</code> é‡Œçš„æ¯ä¸€é¡¹æ’å…¥åˆ° <code>s</code> é‡Œã€‚ç”±äº <code>s</code> è¿™ä¸ªå˜é‡çš„æ“ä½œå®åœ¨æœ‰ç‚¹å¤æ‚ï¼Œä¸ç®¡å®ƒæ˜¯å…¨å±€å˜é‡è¿˜æ˜¯æœ¬åœ°å˜é‡ï¼Œç¼–è¯‘å™¨éƒ½ä¸å¤ªå¯èƒ½æŠŠè¿™äº›æ“ä½œä¼˜åŒ–æ‰äº†ã€‚æˆ‘ä»¬è¿™ä¸ªæµ‹è¯•å¯ä»¥ç®€å•åœ°æµ‹é‡æ€»ä½“è€—æ—¶ï¼š</p><pre><code class=\"language-cpp\">t1 = rdtsc();\nfor (int num : rand_nums) {\n  s.insert(num);\n}\nt2 = rdtsc();\n</code></pre><p>åˆ é™¤æ“ä½œä¹Ÿå·®ä¸å¤šï¼Œæˆ‘ä»¬ä»ç„¶ä½¿ç”¨ <code>rand_nums</code> æ¥åˆ é™¤ <code>s</code> ä¸­çš„æ¯ä¸€é¡¹ï¼š</p><pre><code class=\"language-cpp\">t1 = rdtsc();\nfor (int num : rand_nums) {\n  s.erase(num);\n}\nt2 = rdtsc();\n</code></pre><p>æœ€åï¼Œæˆ‘ä»¬å†é‡å¤ä¸€éæ’å…¥çš„è¿‡ç¨‹ï¼Œçœ‹çœ‹é‡æ–°æ’å…¥çš„æ€§èƒ½æœ‰æ²¡æœ‰å˜åŒ–ã€‚å®Œæ•´çš„æµ‹è¯•ä»£ç å¯ä»¥çœ‹ä¸€ä¸‹<a href=\"https://github.com/adah1972/geek_time_cpp\">ä»£ç åº“</a>ã€‚</p><p>ä¸‹é¢æ˜¯æŸç¡¬ä»¶ç¯å¢ƒä¸‹çš„åˆæ­¥æµ‹è¯•ç»“æœã€‚</p><p>Apple Clang 12.0ï¼ŒmacOS Catalina 10.15ï¼š</p><blockquote>\n<p><code>It took 449 cycles by average to insert a number</code><br>\n<code>It took 492 cycles by average to erase  a number</code><br>\n<code>It took 305 cycles by average to insert a number again</code></p>\n</blockquote><p>MSVC 19.29ï¼ŒWindows 10ï¼š</p><blockquote>\n<p><code>It took 366 cycles by average to insert a number</code><br>\n<code>It took 185 cycles by average to erase  a number</code><br>\n<code>It took 300 cycles by average to insert a number again</code></p>\n</blockquote><p>GCC 10.3ï¼ŒUbuntu Linux 20.04 LTSï¼š</p><blockquote>\n<p><code>It took 307 cycles by average to insert a number</code><br>\n<code>It took 162 cycles by average to erase  a number</code><br>\n<code>It took 176 cycles by average to insert a number again</code></p>\n</blockquote><p>å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨ä¸åŒçš„å¹³å°å’Œç¼–è¯‘å™¨ï¼Œç»“æœå·®å¼‚æ¯”è¾ƒå¤§ã€‚ä½†æˆ‘ä»¬ç¡®å®å¯ä»¥çœ‹åˆ°ï¼Œå†æ¬¡æ’å…¥çš„æ€§èƒ½æ¯”ç¬¬ä¸€æ¬¡è¦é«˜ï¼Œåœ¨ Linux ä¸Šå°¤å…¶æ˜æ˜¾ã€‚</p><p>äº‹å®ä¸Šï¼Œè¿™è¿˜åªæ˜¯ä½¿ç”¨é»˜è®¤çš„å†…å­˜åˆ†é…å™¨çš„ç»“æœã€‚ä½¿ç”¨ä¸åŒçš„å†…å­˜åˆ†é…å™¨ä¹Ÿèƒ½è·å¾—ä¸åŒçš„æ•ˆæœã€‚æ¯”å¦‚ï¼Œåœ¨ Linux ä¸Šä½¿ç”¨ tcmalloc <span class=\"orange\">[1]</span> æ¥å–ä»£é»˜è®¤çš„åˆ†é…å™¨ <span class=\"orange\">[2]</span>ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°æ›´å¥½çš„æµ‹è¯•ç»“æœï¼š</p><blockquote>\n<p><code>It took 250 cycles by average to insert a number</code><br>\n<code>It took 116 cycles by average to erase  a number</code><br>\n<code>It took 117 cycles by average to insert a number again</code></p>\n</blockquote><p>å–å†³äºä½ ä½¿ç”¨çš„å¹³å°çš„å†…å­˜åˆ†é…å™¨çš„æ€§èƒ½ï¼Œä¹Ÿå–å†³äºä½ æ˜¯å¦éœ€è¦è·¨å¹³å°åœ°å¾—åˆ°æ›´å¥½çš„å†…å­˜åˆ†é…æ€§èƒ½ï¼Œå†…å­˜æ± ä¹Ÿè®¸å¯¹ä½ å¾ˆæœ‰ç”¨ï¼Œä¹Ÿè®¸å¯¹ä½ ç”¨å¤„ä¸å¤§ã€‚ç›®å‰ï¼Œæˆ‘å°±å‡è®¾å†…å­˜æ± ä¼šå¯¹ä½ æœ‰ç”¨å§ï¼ˆæ—¢ç„¶ä½ å·²ç»è¯»åˆ°è¿™é‡Œäº†ğŸ˜ï¼‰ã€‚</p><h2>PMR å†…å­˜æ± </h2><p>æœ‰äº†æµ‹è¯•ç”¨ä¾‹ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥éªŒè¯ä¸€ä¸‹å¤šæ€åˆ†é…å™¨ï¼ˆ<a href=\"https://time.geekbang.org/column/article/491227\">ç¬¬ 32 è®²</a>ï¼‰é‡Œæä¾›çš„å†…å­˜æ± çš„ä½œç”¨äº†ã€‚æˆ‘ä»¬åªéœ€è¦å¯¹æµ‹è¯•ç”¨ä¾‹åšä¸€ä¸‹å°ä¿®æ”¹ï¼ŒæŠŠ <code>TestType</code> ç›¸å…³çš„ä¸¤è¡Œæ”¹æˆä¸‹é¢è¿™æ ·å­å°±è¡Œï¼š</p><pre><code class=\"language-cpp\">using TestType = pmr::unordered_set&lt;int&gt;;\npmr::unsynchronized_pool_resource res;\npmr::polymorphic_allocator&lt;int&gt; a{&amp;res};\nTestType s(a);\n</code></pre><p>å–å†³äºå¹³å°ï¼Œä½ å¯èƒ½ä¼šçœ‹åˆ°ä¸åŒçš„æ€§èƒ½ç»“æœã€‚æ¯”å¦‚ï¼Œåœ¨ Linux ä¸Šæˆ‘å¾—åˆ°äº†ä¸‹é¢çš„æµ‹è¯•ç»“æœï¼š</p><blockquote>\n<p><code>It took 272 cycles by average to insert a number</code><br>\n<code>It took 210 cycles by average to erase  a number</code><br>\n<code>It took 169 cycles by average to insert a number again</code></p>\n</blockquote><p>æ€§èƒ½æ•°æ®æœ‰å¾—æœ‰å¤±ã€‚è€Œåœ¨ macOS å’Œ Windows ä¸Šï¼Œæˆ‘çœ‹åˆ°äº†æ›´å¤§çš„ã€å…¨æ–¹ä½çš„æ€§èƒ½æå‡ã€‚å¯¹äºè·¨å¹³å°çš„åº”ç”¨ï¼Œè¿™æ ·çš„å†…å­˜æ± ç¡®å®ä¼šæœ‰æ•ˆæœã€‚</p><p>æ³¨æ„ï¼Œæˆ‘ä¸Šé¢ä½¿ç”¨çš„æ˜¯æ— å¤šçº¿ç¨‹åŒæ­¥çš„ <code>unsynchronized_pool_resource</code>ã€‚æœ‰å¤šçº¿ç¨‹åŒæ­¥çš„å†…å­˜æ± å°±æ˜¯å¦å¤–ä¸€ä¸ªæ•…äº‹äº†ã€‚åœ¨ Linux ä¸Šï¼Œæ€§èƒ½åè€Œä¼šæœ‰ä¸‹é™ï¼›è€Œåœ¨å…¶ä»–å¹³å°ä¸Šï¼Œæ€§èƒ½æå‡ä¹Ÿå¾ˆä¸æ˜æ˜¾ã€‚â€”â€”ä¸€èˆ¬è€Œè¨€ï¼Œå¯¹äºå¤šçº¿ç¨‹çš„å¤„ç†ï¼Œé€šç”¨å†…å­˜åˆ†é…å™¨å·²ç»åšäº†å……è¶³çš„ä¼˜åŒ–ï¼Œæ€§èƒ½ä¸Šå¯èƒ½åè€Œä¼šè¶…å‡ºä¸€èˆ¬ç®€å•å®ç°çš„å†…å­˜æ± ã€‚å†…å­˜æ± é€šå¸¸åº”è¯¥åœ¨<strong>å•çº¿ç¨‹</strong>æˆ–<strong>çº¿ç¨‹æœ¬åœ°</strong>ï¼ˆthread_localï¼‰çš„åœºæ™¯ä½¿ç”¨ï¼Œè‡³å°‘ä»æ‰§è¡Œæ—¶é—´çš„è§’åº¦æ¥è®²æ˜¯å¦‚æ­¤ã€‚</p><h2>è‡ªå®šä¹‰å†…å­˜æ± </h2><p>åœ¨<a href=\"https://time.geekbang.org/column/article/489409\">ç¬¬ 31 è®²</a>æˆ‘æåˆ°è¿‡ï¼Œåˆ©ç”¨åŒä¸€ç±»å‹çš„å¯¹è±¡çš„å¤§å°å®Œå…¨ç›¸åŒè¿™ä¸€ç‰¹æ€§ï¼Œå¯ä»¥å®ç°ä¸€ä¸ªé«˜åº¦ä¼˜åŒ–çš„å†…å­˜æ± ã€‚åªæ˜¯åˆ©ç”¨ç±»ç‰¹å®šçš„åˆ†é…å’Œé‡Šæ”¾å‡½æ•°ï¼Œä½¿ç”¨åœºæ™¯ä¼šæ¯”è¾ƒå—é™ã€‚ä¸‹é¢æˆ‘ä¼šæè¿°åˆ©ç”¨è¿™ä¸ªæ€è·¯å®ç°çš„ä¸€ä¸ªå†…å­˜æ± ï¼Œæ—¢å¯ä»¥ç”¨åœ¨ç±»ç‰¹å®šçš„åˆ†é…å’Œé‡Šæ”¾å‡½æ•°é‡Œï¼Œä¹Ÿå¯ä»¥ç”¨åœ¨å®¹å™¨çš„åˆ†é…å™¨é‡Œã€‚</p><h3>åŸºæœ¬ç­–ç•¥</h3><p>ä½œä¸ºå†…å­˜æ± ï¼Œæœ€åŸºæœ¬çš„è¦æ±‚å°±æ˜¯å‡å°‘å‘ç³»ç»Ÿçš„å†…å­˜åˆ†é…å™¨è¯·æ±‚å†…å­˜çš„æ¬¡æ•°ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¸Œæœ›å•æ¬¡å†…å­˜åˆ†é…å°±è·å¾—å¤§å—çš„å†…å­˜ï¼ˆchunkï¼‰ï¼Œç„¶ååˆ†å‰²å¼€ç»™å„ä¸ªå¯¹è±¡ä½¿ç”¨ã€‚è¿™æ ·çš„å†…å­˜å—ï¼Œé€šå¸¸æ˜¯æŸä¸ªç‰¹å®šå¤§å°çš„æ•´æ•°å€ã€‚</p><p>ä¸‹ä¸€æ­¥ï¼Œæˆ‘ä»¬æœ‰ä¸¤ç§ä¸åŒçš„åšæ³•ï¼š</p><ol>\n<li>ä»»ä½•è¦æ±‚æŸä¸ªå¤§å°ï¼ˆæˆ–æŸä¸ªå¤§å°èŒƒå›´ï¼‰çš„å†…å­˜åˆ†é…è¯·æ±‚éƒ½åˆ°æŸä¸€ä¸ªå†…å­˜æ± é‡Œåˆ†é…å’Œé‡Šæ”¾</li>\n<li>ä»»ä½•è¦æ±‚æŸä¸ªç‰¹å®šç±»å‹çš„å¯¹è±¡çš„å†…å­˜åˆ†é…è¯·æ±‚éƒ½åˆ°æŸä¸€ä¸ªå†…å­˜æ± é‡Œåˆ†é…å’Œé‡Šæ”¾</li>\n</ol><p>ç¬¬ä¸€ç§åšæ³•è·Ÿ SGI STL å·®ä¸å¤šï¼Œè€Œç¬¬äºŒç§åšæ³•æ˜¯ C++ çš„å†…å­˜åˆ†é…æœºåˆ¶ç»™æˆ‘ä»¬çš„é¢å¤–ä¼˜åŒ–æœºä¼šã€‚ä¸¤ç§åšæ³•å„æœ‰ä¸€äº›ä¼˜ç¼ºç‚¹ï¼Œè€Œæˆ‘ç›®å‰æ˜¯é‡‡å–äº†ç¬¬äºŒç§åšæ³•ï¼Œä¸»è¦è€ƒè™‘ä¸‹é¢è¿™äº›å› ç´ ï¼š</p><ul>\n<li>ä¸åŒç±»å‹çš„å¯¹è±¡ä½¿ç”¨ä¸åŒçš„å†…å­˜æ± ï¼Œå³ä½¿å®ƒä»¬çš„å¤§å°ç›¸åŒã€‚åœ¨å¾ˆå¤šåœºæ™¯ä¸‹ï¼ŒæŠŠåŒä¸€ç±»å‹çš„å¯¹è±¡æ”¾åœ¨ä¸€èµ·ï¼Œç¨‹åºä¼šæœ‰æ›´å¥½çš„å±€åŸŸæ€§ã€‚</li>\n<li>é€šè¿‡å¯¹è±¡ç±»å‹å¯ä»¥å¾—å‡ºå¯¹è±¡å¤§å°ï¼Œä½†åè¿‡æ¥åˆ™ä¸å¯ä»¥ã€‚æ¢å¥è¯è¯´ï¼ŒæŒ‰æˆ‘ç›®å‰çš„æ–¹å¼ï¼Œä½ å¯ä»¥æŠŠæ–¹æ¡ˆé€€åŒ–æˆä¸ºåªä½¿ç”¨å¯¹è±¡å¤§å°ï¼Œå› è€Œè®²è§£ç›®å‰è¿™ç§æ–¹å¼æ›´å…·æœ‰é€šç”¨æ€§ã€‚</li>\n</ul><p>æˆ‘åšçš„å¦å¤–ä¸€ä¸ªé€‰æ‹©æ˜¯åœ¨å¤§éƒ¨åˆ†æ—¶é—´é‡Œ<strong>ä¸</strong>è¿”å›å†…å­˜ç»™å†…å­˜åˆ†é…å™¨ã€‚åŸå› æ˜¯ï¼š</p><ul>\n<li>è¿”å›å†…å­˜ç»™å†…å­˜åˆ†é…å™¨åè€Œæ›´å®¹æ˜“å¯¼è‡´å†…å­˜ç¢ç‰‡ï¼Œå¯¼è‡´åç»­å†…å­˜ä¸è¶³æˆ–æ¶ˆè€—æ›´å¤§ã€‚</li>\n<li>è¿”å›å†…å­˜ç»™å†…å­˜åˆ†é…å™¨ï¼Œé€šå¸¸å†…å­˜åˆ†é…å™¨ä¹Ÿæ²¡æ³•è¿”å›ç»™æ“ä½œç³»ç»Ÿï¼ˆå› ä¸ºå†…å­˜ç¢ç‰‡çš„åŸå› ï¼‰ï¼Œå› æ­¤å¹¶ä¸èƒ½å‡å°‘ç¨‹åºçš„è¿è¡ŒæœŸå†…å­˜å¼€é”€ã€‚</li>\n<li>ä¸è¿”å›å†…å­˜ç»™å†…å­˜åˆ†é…å™¨çš„è¯ï¼Œå®ç°ç®€å•ï¼Œä»£ç æ›´å°ã€æ›´å¿«ã€‚</li>\n</ul><p>æˆ‘çš„ä¸€äº›å®éªŒè¡¨æ˜ï¼Œå†…å­˜æ± ä¹Ÿå¾ˆéš¾å†³å®šä»€ä¹ˆæ—¶å€™è¿”å›å†…å­˜ç»™å†…å­˜åˆ†é…å™¨ã€‚å¦‚æœæŸä¸ªå†…å­˜å—ï¼ˆchunkï¼‰å…¨ç©ºå°±è¿”å›çš„è¯ï¼Œç¨‹åºå‘å†…å­˜åˆ†é…å™¨è¯·æ±‚å†…å­˜çš„æ¬¡æ•°ä¼šæ˜æ˜¾å¢åŠ ã€‚ç›®å‰æˆ‘èƒ½æƒ³åˆ°çš„å”¯ä¸€å¥½å¤„ï¼Œæ˜¯ç¨‹åºçš„å¯¹è±¡æ•°é‡ä¼šæœ‰æ˜æ˜¾çš„æ³¢åŠ¨çš„æ—¶å€™ï¼šåœ¨æŸä¸ªæ—¶åˆ»ï¼Œç¨‹åºä¼šäº§ç”Ÿå¤§é‡çš„ A å¯¹è±¡ï¼Œç„¶åé‡Šæ”¾æ‰ï¼›åœ¨å¦ä¸€æ—¶åˆ»ï¼Œåˆä¼šäº§ç”Ÿå¤§é‡çš„ B å¯¹è±¡ï¼Œç„¶åé‡Šæ”¾æ‰ã€‚ä»…åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘çš„ä¸è¿”å›é€‰æ‹©ä¼šå¢åŠ ç¨‹åºçš„æœ€å¤§å†…å­˜å¼€é”€ã€‚ç›®å‰æˆ‘å°±æš‚ä¸è€ƒè™‘è¿™ç§ç‰¹æ®Šåœºæ™¯äº†ã€‚</p><h3>å¯¹è±¡å†…å­˜æ± </h3><p>æ ¹æ®ä¸Šé¢çš„è®¨è®ºï¼Œæˆ‘ä»¬éœ€è¦æœ‰ä¸€ä¸ªå†…å­˜å—çš„æ•°æ®ç»“æ„ï¼Œä¹Ÿéœ€è¦å†³å®šä¸€ä¸ªå†…å­˜å—é‡Œæ”¾å¤šå°‘ä¸ªå¯¹è±¡ã€‚æˆ‘ä»¬é‡‡ç”¨ä¸€ä¸ªå¯ç‰¹åŒ–çš„å‚æ•°æ¥å†³å®šåè€…ï¼š</p><pre><code class=\"language-cpp\">template &lt;typename T&gt;\ninline constexpr size_t\n  memory_chunk_size = 64;\n</code></pre><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>memory_chunk_size</code> é»˜è®¤å¤§å°æ˜¯ 64ï¼Œä½†ä½ å¯ä»¥é’ˆå¯¹æŸä¸€ç‰¹å®šç±»å‹æ¥è¿›è¡Œç‰¹åŒ–ï¼Œæ”¹å˜å…¶å¤§å°ã€‚æ¯”å¦‚ï¼Œä½ æƒ³é’ˆå¯¹ä½ çš„æŸä¸€ç‰¹å®š <code>Obj</code> ç±»å‹æŠŠå¤§å°æ”¹æˆ 32ï¼Œä½ å¯ä»¥å†™ï¼š</p><pre><code class=\"language-cpp\">template &lt;&gt;\ninline constexpr size_t\n  memory_chunk_size&lt;Obj&gt; = 32;\n</code></pre><p>å½“ç„¶ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä½ æ²¡å¿…è¦è¿™ä¹ˆåšã€‚åœ¨å¤§éƒ¨åˆ†éœ€è¦å†…å­˜æ± çš„åœºæ™¯ï¼Œé»˜è®¤å¤§å°å·²ç»å·¥ä½œå¾—æŒºå¥½äº†ã€‚</p><p>ç„¶åï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œå¯ä»¥å­˜æ”¾æŸç§å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥æŠŠå†…å­˜å—ä¸²æˆä¸€ä¸ªé“¾è¡¨ã€‚æ˜¾ç„¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ª unionï¼š</p><pre><code class=\"language-cpp\">union node {\n  T data;\n  node* next;\n};\n</code></pre><p>ç›´æ¥ä½¿ç”¨ <code>T</code> ç±»å‹çš„å¥½å¤„æ˜¯æˆ‘ä»¬å¯ä»¥è‡ªç„¶åœ°ä½¿ç”¨ <code>T</code> ç±»å‹çš„å¯¹é½ç‰¹å¾ï¼Œè€Œä¸éœ€è¦ä½¿ç”¨ <code>alignas</code> ä¹‹ç±»çš„éº»çƒ¦æ–¹å¼ã€‚ä¸è¿‡ï¼Œæˆ‘ä»¬ä¹Ÿæœ‰ä¸€äº›å°å¤æ‚æ€§éœ€è¦è§£å†³ï¼šå½“ <code>T</code> æ˜¯ä¸€ä¸ªå¸¦æœ‰éå¹³å‡¡æ„é€ å‡½æ•°å’Œææ„å‡½æ•°çš„å¯¹è±¡æ—¶ï¼Œä¸Šé¢çš„ä»£ç ç¼–è¯‘ä¼šæœ‰é—®é¢˜ï¼Œå› ä¸ºç¼–è¯‘å™¨ä¸çŸ¥é“åœ¨æ„é€ å’Œææ„æ—¶åˆ°åº•è¯¥æ€ä¹ˆåŠäº†ã€‚æˆ‘ä»¬åªç”¨è¿™ä¸ªç»“ç‚¹æ¥ç®¡ç†å†…å­˜ï¼Œå› æ­¤æˆ‘ä»¬å£°æ˜ç©ºçš„æ„é€ å‡½æ•°å’Œææ„å‡½æ•°å°±å¥½ï¼ˆæ³¨æ„ï¼Œæ­¤å¤„ä¸èƒ½ä½¿ç”¨ <code>= default</code>ï¼‰ã€‚æ­¤å¤–ï¼Œè¿™æ ·çš„å†…å­˜ç»“ç‚¹æ˜¾ç„¶ä¹Ÿä¸åº”è¯¥è¿›è¡Œå¤åˆ¶ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬æœ€å¥½è¦ç¦ç”¨æ‹·è´æ„é€ å‡½æ•°å’Œæ‹·è´èµ‹å€¼è¿ç®—ç¬¦ã€‚</p><pre><code class=\"language-cpp\">union node {\n  T data;\n  node* next;\n  node() {}\n  ~node() {}\n  node(const node&amp;) = delete;\n  node&amp;\n  operator=(const node&amp;) = delete;\n};\n</code></pre><p>ç„¶åï¼Œæˆ‘ä»¬å°±å¯ä»¥å®šä¹‰å‡ºå†…å­˜å—äº†ï¼š</p><pre><code class=\"language-cpp\">template &lt;typename T&gt;\nclass memory_chunk {\npublic:\n  union node {\n    â€¦\n  };\n  memory_chunk(\n    memory_chunk* next_chunk);\n  node* get_free_nodes()\n  {\n    return storage_.data();\n  }\n  memory_chunk* get_next() const\n  {\n    return next_chunk_;\n  }\n\nprivate:\n  memory_chunk* next_chunk_{};\n  array&lt;node, memory_chunk_size&lt;T&gt;&gt;\n    storage_;\n};\n</code></pre><p>å†…å­˜å—å°±æ˜¯ç»“ç‚¹çš„æ•°ç»„ï¼ŒåŠ ä¸ŠæŒ‡å‘ä¸‹ä¸€ä¸ªå†…å­˜å—çš„æŒ‡é’ˆï¼Œæ¥æŠŠå†…å­˜å—ä¸²æˆä¸€ä¸ªé“¾è¡¨ã€‚æˆ‘ä»¬é€šè¿‡æ„é€ å‡½æ•°æ¥åˆå§‹åŒ–å†…å­˜å—ï¼š</p><pre><code class=\"language-cpp\">template &lt;typename T&gt;\nmemory_chunk&lt;T&gt;::memory_chunk(\n  memory_chunk* next_chunk)\n  : next_chunk_(next_chunk)\n{\n  for (size_t i = 0;\n       i &lt; storage_.size() - 1;\n       ++i) {\n    storage_[i].next =\n      &amp;storage_[i + 1];\n  }\n  storage_[storage_.size() - 1]\n    .next = nullptr;\n}\n</code></pre><p>â€œä¸‹ä¸€ä¸ªâ€å†…å­˜å—çš„æŒ‡é’ˆç”±å¤–éƒ¨ä¼ å…¥ã€‚å¯¹äºç»“ç‚¹çš„æ•°ç»„ï¼Œæˆ‘ä»¬ä½¿æ¯ä¸ªç»“ç‚¹çš„ <code>next</code> æŒ‡é’ˆæŒ‡å‘ä¸‹ä¸€é¡¹ï¼›é™¤äº†æœ€åä¸€é¡¹ï¼Œå…¶ <code>next</code> æŒ‡é’ˆä¸ºç©ºã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬æŠŠå†…å­˜å—ä¸²æˆäº†ä¸€ä¸ªé“¾è¡¨ï¼Œä¾›åé¢å†…å­˜æ± æ¥ä½¿ç”¨ã€‚</p><p>æœ‰äº†è¿™äº›åŸæ–™ï¼Œæˆ‘ä»¬çš„å†…å­˜æ± å°±å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å†™å‡ºæ¥äº†ã€‚ç±»çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><pre><code class=\"language-cpp\">template &lt;typename T&gt;\nclass memory_pool {\npublic:\n  using node =\n    typename memory_chunk&lt;T&gt;::node;\n  memory_pool() = default;\n  memory_pool(const memory_pool&amp;) =\n    delete;\n  memory_pool&amp; operator=(\n    const memory_pool&amp;) = delete;\n  ~memory_pool();\n  T* allocate();\n  void deallocate(T* ptr);\n\nprivate:\n  node* free_list_{};\n  memory_chunk&lt;T&gt;* chunk_list_{};\n};\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œå†…å­˜æ± å¯¹è±¡åªæœ‰ä¸¤ä¸ªæˆå‘˜å˜é‡ï¼Œ<code>free_list_</code> å’Œ <code>chunk_list_</code>ï¼ŒåŠä¸‰ä¸ªæˆå‘˜å‡½æ•°ï¼Œææ„å‡½æ•°ã€<code>allocate</code> å’Œ <code>deallocate</code>ã€‚<code>free_list_</code> æ˜¯ç©ºé—²ç»“ç‚¹çš„é“¾è¡¨ï¼Œ<code>chunk_list_</code> æ˜¯æ‰€æœ‰å†…å­˜å—çš„é“¾è¡¨ã€‚è€Œåœ¨ä¸‰ä¸ªæˆå‘˜å‡½æ•°é‡Œï¼Œææ„å‡½æ•°çš„æ„ä¹‰æ˜¯è´Ÿè´£é‡Šæ”¾æ‰€æœ‰çš„å†…å­˜å—ï¼š</p><pre><code class=\"language-cpp\">template &lt;typename T&gt;\nmemory_pool&lt;T&gt;::~memory_pool()\n{\n  while (chunk_list_) {\n    memory_chunk&lt;T&gt;* chunk =\n      chunk_list_;\n    chunk_list_ =\n      chunk_list_-&gt;get_next();\n    delete chunk;\n  }\n}\n</code></pre><p><code>allocate</code> è´Ÿè´£å†…å­˜çš„åˆ†é…ï¼š</p><pre><code class=\"language-cpp\">template &lt;typename T&gt;\nT* memory_pool&lt;T&gt;::allocate()\n{\n  if (free_list_ == nullptr) {\n    chunk_list_ =\n      new memory_chunk&lt;T&gt;(\n        chunk_list_);\n    free_list_ =\n      chunk_list_-&gt;get_free_nodes();\n  }\n  T* result = &amp;free_list_-&gt;data;\n  free_list_ = free_list_-&gt;next;\n  return result;\n}\n</code></pre><p>æˆ‘ä»¬é¦–å…ˆæ£€æŸ¥ç©ºé—²åˆ—è¡¨ <code>free_list_</code> æ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºåˆ™è¯´æ˜å†…å­˜æ± é‡Œå·²ç»æ²¡æœ‰å†…å­˜ä¾›å¯¹è±¡ä½¿ç”¨ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æ–°ç”³è¯·ä¸€ä¸ªå†…å­˜å—ï¼Œç„¶åè®© <code>chunk_list_</code> æŒ‡å‘è¿™ä¸ªæ–°å†…å­˜å—ï¼Œå¹¶è®© <code>free_list</code> æŒ‡å‘å…¶é¦–é¡¹ã€‚éšåï¼Œåˆ†é…å†…å­˜åªæ˜¯ç®€å•åœ°ä»ç»“ç‚¹é“¾è¡¨ä¸Šæ‘˜ä¸‹ä¸€é¡¹ï¼Œå¹¶è°ƒæ•´é“¾è¡¨çš„é¦–é¡¹æŒ‡é’ˆã€‚</p><p><code>deallocate</code> å½“ç„¶å°±æ˜¯è´Ÿè´£å†…å­˜çš„é‡Šæ”¾ï¼š</p><pre><code class=\"language-cpp\">template &lt;typename T&gt;\nvoid memory_pool&lt;T&gt;::deallocate(T* ptr)\n{\n  auto free_item =\n    reinterpret_cast&lt;node*&gt;(ptr);\n  free_item-&gt;next = free_list_;\n  free_list_ = free_item;\n}\n</code></pre><p>è¿™å°±æ›´ç®€å•äº†ï¼Œå°±æ˜¯æŠŠç”¨æˆ·ä¼ è¿›æ¥çš„æŒ‡é’ˆå½“æˆç»“ç‚¹çš„æŒ‡é’ˆï¼Œç„¶åæ”¾å›åˆ°ç©ºé—²åˆ—è¡¨é‡Œè€Œå·²ã€‚</p><p>é¡ºä¾¿è¯´ä¸€å¥ï¼Œå¯¹äºè°ƒæ•´é“¾è¡¨è¿™æ ·çš„æ“ä½œï¼Œæ ‡å‡†åº“æä¾›çš„ <code>std::exchange</code> å·¥å…·å¯ä»¥è®©ä»£ç æ›´åŠ ç®€æ´ã€‚æ¯”å¦‚ï¼Œ<code>allocate</code> çš„æœ€åä¸‰æ¡è¯­å¥å¯ä»¥ç¼©æˆä¸€æ¡ï¼š<code>return &amp;exchange(free_list_, free_list_-&gt;next)-&gt;data;</code>ã€‚</p><h3>å†…å­˜æ± åº”ç”¨ï¼šç±»ç‰¹å®šçš„åˆ†é…å’Œé‡Šæ”¾å‡½æ•°</h3><p>è™½ç„¶ç±»ç‰¹å®šçš„åˆ†é…å’Œé‡Šæ”¾å‡½æ•°å·²ç»ä¸é‚£ä¹ˆç»å¸¸ä½¿ç”¨ï¼Œæˆ‘ä»¬è¿˜æ˜¯å¯ä»¥çœ‹ä¸€ä¸‹å¦‚ä½•æŠŠå†…å­˜æ± ç”¨åˆ°è¿™ä¸€æœ€ç®€å•çš„åº”ç”¨åœºæ™¯ä¸­ã€‚è¿™ä¹Ÿå¯ä»¥è®©æˆ‘ä»¬æµ‹ä¸€ä¸‹è¿™ç§æç«¯æƒ…å†µä¸‹çš„å†…å­˜æ± æ”¶ç›Šã€‚</p><p>ä¹‹å‰æè¿‡ï¼Œå¯¹äºæŸä¸€ä¸ªç±» <code>Obj</code>ï¼Œæˆ‘ä»¬è¦ä½¿ç”¨ç±»ç‰¹å®šçš„åˆ†é…å’Œé‡Šæ”¾å‡½æ•°ï¼Œåªéœ€åœ¨å…¶ä¸­å£°æ˜è¿™æ ·ä¸¤ä¸ªæˆå‘˜å‡½æ•°ï¼š</p><pre><code class=\"language-cpp\">class Obj {\npublic:\n  â€¦\n  void* operator new(size_t size);\n  void operator delete(\n    void* ptr) noexcept;\n};\n</code></pre><p>è¿™é‡Œæˆ‘çœå»äº†å£°æ˜å‰çš„ <code>static</code>ï¼Œè¿™æ˜¯å…è®¸çš„ï¼Œæ•ˆæœç›¸åŒï¼ˆä¸ç®¡å†™ä¸å†™ <code>static</code>ï¼Œè¿™ä¸¤ä¸ªæˆå‘˜å‡½æ•°éƒ½æ˜¯é™æ€çš„ï¼‰ã€‚æˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸ªç±»çš„å®ç°æ–‡ä»¶ï¼ˆéå¤´æ–‡ä»¶ï¼‰é‡ŒåŠ å…¥ä¸‹é¢çš„å†…å®¹å³å¯ä½¿ç”¨å†…å­˜æ± ï¼š</p><pre><code class=\"language-cpp\">memory_pool&lt;Obj&gt; obj_pool;\n\nvoid* Obj::operator new(size_t size)\n{\n  assert(size == sizeof(Obj));\n  return obj_pool.allocate();\n}\n\nvoid Obj::operator delete(\n  void* ptr) noexcept\n{\n  obj_pool.deallocate(\n    static_cast&lt;Obj*&gt;(ptr));\n}\n</code></pre><p>å¯¹äºè¿™æ ·çš„å¯¹è±¡ï¼ŒåŠæ²¡æœ‰ç±»ç‰¹å®šçš„åˆ†é…å’Œé‡Šæ”¾å‡½æ•°çš„å¯¹è±¡ï¼Œåˆ†åˆ«åšå¤§é‡çš„ <code>new</code> å’Œ <code>delete</code> æ“ä½œï¼Œæˆ‘åœ¨ Linuxï¼ˆé»˜è®¤åˆ†é…å’Œé‡Šæ”¾æ€§èƒ½æœ€å¥½çš„ä¸»æµå¹³å°ï¼‰ä¸Šå¾—åˆ°ï¼š</p><blockquote>\n<p><code>107 cycles for each allocation and deallocations on normal Obj</code><br>\n<code>  8 cycles for each allocation and deallocations on pooled Obj</code>\\</p>\n</blockquote><p>ä¸ä½¿ç”¨å†…å­˜æ± æ—¶å¹³å‡æ¯æ¬¡åˆ†é…å’Œé‡Šæ”¾è€—æ—¶ 107 ä¸ªæ—¶é’Ÿå‘¨æœŸï¼Œä½¿ç”¨å†…å­˜æ± åˆ™é™ä¸º 8 ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚</p><p>å¦‚æœä½¿ç”¨ tcmallocï¼ŒåŒºåˆ«å°±å°ä¸€ç‚¹äº†ï¼š</p><blockquote>\n<p><code> 27 cycles for each allocation and deallocations on normal Obj</code><br>\n<code>  8 cycles for each allocation and deallocations on pooled Obj</code>\\</p>\n</blockquote><p>ä¸ä½¿ç”¨å†…å­˜æ± ä¹Ÿåªè¦ 27 ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚</p><h3>å†…å­˜æ± åº”ç”¨ï¼šåˆ†é…å™¨</h3><p>ä¸Šé¢çš„æµ‹è¯•å¯ä»¥è®©æˆ‘ä»¬çœ‹åˆ°å†…å­˜æ± å¸¦æ¥çš„æ”¶ç›Šä¼šæœ‰å¤šå¤§ï¼Œä½†æ‰‹å·¥ä½¿ç”¨ <code>new</code> å’Œ <code>delete</code> æ—©å°±å·²ç»ä¸æ˜¯æ¨èçš„åšæ³•äº†ã€‚æœ€å¸¸è§çš„æƒ…å†µï¼Œæˆ‘ä»¬éœ€è¦æŠŠå¯¹è±¡æ”¾åœ¨å®¹å™¨é‡Œé¢ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦è®©åˆ†é…å™¨æ”¯æŒå†…å­˜æ± ã€‚</p><p>é™¤äº†æˆ‘ä»¬å®šä¹‰åˆ†é…å™¨éœ€è¦çš„é‚£äº›å¿…è¦å®šä¹‰å¤–ï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰çš„æ ¸å¿ƒæˆå‘˜å‡½æ•°æ˜¯ <code>allocate</code> å’Œ <code>deallocate</code>ã€‚å®ç°çš„ç¤ºæ„å¦‚ä¸‹ï¼š</p><pre><code class=\"language-cpp\">template &lt;typename T&gt;\nmemory_pool&lt;T&gt;&amp; get_memory_pool()\n{\n  thread_local memory_pool&lt;T&gt; pool;\n  return pool;\n}\n\ntemplate &lt;typename T,\n          typename Base =\n            allocator&lt;T&gt;&gt;\nstruct pooled_allocator\n  : private Base {\n  â€¦\n\n  T* allocate(size_t n)\n  {\n    if (n == 1) {\n      return get_memory_pool&lt;T&gt;()\n        .allocate();\n    } else {\n      return Base::allocate(n);\n    }\n  }\n\n  void deallocate(T* p, size_t n)\n  {\n    if (n == 1) {\n      return get_memory_pool&lt;T&gt;()\n        .deallocate(p);\n    } else {\n      return Base::deallocate(p, n);\n    }\n  }\n};\n</code></pre><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºæ¯ä¸€ç§ç‰¹å®šç±»å‹ <code>T</code>ï¼Œæˆ‘ä»¬éƒ½æœ‰ä¸€ä¸ªä¸“å±çš„çº¿ç¨‹æœ¬åœ°å†…å­˜æ± ã€‚è¿™ä¸ªå†…å­˜æ± ä¼šåœ¨é¦–æ¬¡ä½¿ç”¨è¢«åˆ›å»ºï¼Œåœ¨çº¿ç¨‹é€€å‡ºæ—¶è¢«é”€æ¯ã€‚</p><p>åœ¨ <code>allocate</code> å’Œ <code>deallocate</code> å‡½æ•°é‡Œï¼Œæˆ‘ä»¬é¦–å…ˆæ£€æŸ¥éœ€è¦åˆ†é…æˆ–é‡Šæ”¾çš„å¯¹è±¡ä¸ªæ•°ã€‚å½“å‰çš„å®ç°ä¸èƒ½å¤„ç†è¶…è¿‡å•ä¸ªå¯¹è±¡å¤§å°çš„åˆ†é…å’Œé‡Šæ”¾ï¼Œå› æ­¤è¿™æ ·çš„è¯·æ±‚ä¼šç›´æ¥è½¬åˆ°åŸºç±»çš„å†…å­˜åˆ†é…å™¨è¿›è¡Œå¤„ç†ï¼Œ é»˜è®¤æƒ…å†µä¸‹æ˜¯ç³»ç»Ÿçš„ <code>std::allocator</code>ï¼Œå®ƒä¼šä½¿ç”¨ <code>operator new</code> å’Œ <code>operator delete</code> æ¥è¿›è¡Œåˆ†é…å’Œé‡Šæ”¾ã€‚æˆ‘ä»¬ä»…é’ˆå¯¹å•ä¸ªå¯¹è±¡çš„å†…å­˜åˆ†é…å’Œé‡Šæ”¾ä½¿ç”¨çº¿ç¨‹æœ¬åœ°å†…å­˜æ± ï¼Œå› æ­¤è¿™ä¸ªåˆ†é…å™¨é€‚åˆ <code>list</code>ã€<code>map</code>ã€<code>set</code> è¿™æ ·çš„å¯¹å…ƒç´ å•ç‹¬åˆ†é…å†…å­˜çš„å®¹å™¨ï¼Œè€Œä¸é€‚åˆ <code>vector</code>ã€<code>deque</code> è¿™æ ·çš„æ‰¹é‡åˆ†é…å†…å­˜çš„å®¹å™¨ã€‚â€”â€”åè€…å®é™…ä¸Šä¹ŸåŸºæœ¬æ²¡æœ‰ä½¿ç”¨å†…å­˜æ± çš„å¿…è¦äº†ã€‚</p><p>ä½¿ç”¨è¿™ä¸ªå†…å­˜æ± å¾ˆç®€å•ï¼ŒæŠŠå®¹å™¨çš„ <code>Allocator</code> æ¨¡æ¿å‚æ•°è®¾æˆç›®å‰å®ç°çš„ <code>pooled_allocator</code> å³å¯ã€‚ä½¿ç”¨ä¹‹å‰çš„æµ‹è¯•ï¼Œæˆ‘ä»¬éœ€è¦æŠŠ <code>TestType</code> å®šä¹‰æˆä¸‹é¢çš„å½¢å¼ï¼š</p><pre><code class=\"language-cpp\">using TestType = unordered_set&lt;\n  int, hash&lt;int&gt;, equal_to&lt;int&gt;,\n  pooled_allocator&lt;int&gt;&gt;;\n</code></pre><p>ç”±äº <code>Allocator</code> æ˜¯æœ€åä¸€ä¸ªå‚æ•°ï¼Œæˆ‘ä»¬å¿…é¡»æŠŠä¹‹å‰ç±»æ¨¡æ¿çš„é»˜è®¤æ¨¡æ¿å‚æ•°ä¹Ÿæ‰‹å·¥è¡¥ä¸Šï¼Œä¹Ÿå°±æ˜¯ <code>hash&lt;int&gt;</code> å’Œ <code>equal_to&lt;int&gt;</code> è¿™ä¸¤ä¸ªã€‚è¿™æ ·åšä¸€ä¸‹ç®€å•ä¿®æ”¹ä¹‹åï¼Œæˆ‘ä»¬å°±èƒ½çœ‹åˆ°æµ‹è¯•çš„æ€§èƒ½æå‡ã€‚åœ¨ Linux ä¸Šæˆ‘å¾—åˆ°äº†ï¼š</p><blockquote>\n<p><code>It took 199 cycles by average to insert a number</code><br>\n<code>It took 112 cycles by average to erase  a number</code><br>\n<code>It took 110 cycles by average to insert a number again</code></p>\n</blockquote><p>ç¡®å®æ˜¯è¿„ä»Šä¸ºæ­¢æœ€å¥½çš„æ€§èƒ½æµ‹è¯•ç»“æœï¼</p><h3>ç”Ÿå‘½å‘¨æœŸé™·é˜±</h3><p>å¥½å§ï¼Œæˆ‘æ’’äº†ä¸ªå°è°ã€‚å¦‚æœä½ åŸå°ä¸åŠ¨æŒ‰æˆ‘ç›®å‰ç»™å‡ºçš„ä»£ç æ¥è‡ªå·±å®ç°ä¸€éçš„è¯ï¼Œä½ å¾ˆå¯èƒ½çœ‹åˆ°ç¨‹åºåœ¨é€€å‡ºæ—¶æŒ‚èµ·æˆ–å´©æºƒã€‚é—®é¢˜æ˜¯è¿™æ ·å‘ç”Ÿçš„ï¼š</p><ol>\n<li>æˆ‘ä»¬æœ‰ä¸€ä¸ªå…¨å±€å¯¹è±¡ï¼Œåœ¨æ„é€ æ—¶ä¼šæŠŠå®ƒçš„ææ„å‡½æ•°è°ƒç”¨æŒ‚åˆ°ç¨‹åºé€€å‡ºæ—¶éœ€è¦æ‰§è¡Œçš„ä»£ç ä¸­ã€‚</li>\n<li>åœ¨è¿™ä¸ªå…¨å±€å¯¹è±¡é¦–æ¬¡éœ€è¦å†…å­˜æ—¶ï¼Œæˆ‘ä»¬ä¼šåˆå§‹åŒ–å†…å­˜æ± çš„å®ä¾‹ã€‚åŒæ—¶ï¼Œå®ƒçš„ææ„å‡½æ•°ä¼šæŒ‚åˆ°çº¿ç¨‹é€€å‡ºéœ€è¦æ‰§è¡Œçš„ä»£ç ä¸­ã€‚æ³¨æ„è¿™æ¯”ç¬¬ 1 æ­¥è¦æ™šã€‚</li>\n<li>å†…å­˜æ± ææ„ä¼šå‘ç”Ÿåœ¨å…¨å±€å¯¹è±¡ææ„ä¹‹å‰ï¼ˆå³ä½¿å®ƒä»¬éƒ½æ˜¯å…¨å±€å¯¹è±¡æˆ–è€…éƒ½æ˜¯çº¿ç¨‹æœ¬åœ°å¯¹è±¡ï¼Œä¹Ÿä¸€å®šæ˜¯åæ„é€ çš„å…ˆææ„ï¼‰ï¼Œå®ƒä¼šé‡Šæ”¾æ‰€æœ‰çš„å†…å­˜ã€‚</li>\n<li>åœ¨å…¨å±€å¯¹è±¡ææ„æ—¶ï¼Œå¦‚æœæœ‰ä»»ä½•è¯»å†™ä¹‹å‰åˆ†é…çš„å †ä¸Šå†…å­˜çš„æ“ä½œï¼Œéƒ½æ˜¯æœªå®šä¹‰è¡Œä¸ºï¼</li>\n</ol><p>é‚£ä¹ˆé—®é¢˜å¦‚ä½•è§£å†³å‘¢ï¼Ÿç›®å‰çœ‹èµ·æ¥ï¼Œæœ€ç®€å•å¯è¡Œçš„æ–¹æ¡ˆæ˜¯ï¼š</p><ul>\n<li>æŠŠå…¨å±€å¯¹è±¡æ”¹æˆ thread_localï¼ˆæˆ–è€…å¦‚æœæˆ‘ä»¬åªéœ€è¦å•çº¿ç¨‹æ“ä½œçš„è¯ï¼Œå¯ä»¥æŠŠ <code>get_memory_pool</code> é‡Œçš„ <code>thread_local</code> æ”¹æˆ <code>static</code>ï¼‰ã€‚æ˜¾ç„¶ï¼Œå¯¹è±¡å’Œå†…å­˜æ± ä¸åŒæ—¶ä½¿ç”¨ thread_localï¼Œè¯­ä¹‰ä¸Šè‚¯å®šæ˜¯æœ‰é—®é¢˜çš„ã€‚</li>\n<li>è®© <code>pooled_allocator</code> çš„æ„é€ å‡½æ•°è°ƒç”¨ <code>get_memory_pool&lt;T&gt;()</code>ï¼Œç¡®ä¿å†…å­˜æ± åœ¨å¯¹è±¡è¢«å®Œæ•´æ„é€ å‡ºæ¥ä¹‹å‰å·²ç»å­˜åœ¨ã€‚</li>\n</ul><p>åœ¨ä¿®æ”¹ <code>pooled_allocator</code> çš„æ„é€ å‡½æ•°ä¹‹å‰ï¼Œæˆ‘å¯ä»¥åœ¨ GCC å’Œ Clang ä¸‹è§‚å¯Ÿåˆ°ç¨‹åºå´©æºƒã€‚è¿™ä¸€ä¿®æ”¹ä¹‹åï¼Œç¨‹åºå°±å¯ä»¥æ­£å¸¸è¿è¡Œäº†ã€‚</p><h2>å†…å®¹å°ç»“</h2><p>åœ¨æœ¬è®²ä¸­æˆ‘ä»¬å®Œæ•´è®¨è®ºäº†å†…å­˜æ± ï¼ŒåŒ…æ‹¬å®ƒçš„æµ‹è¯•å’Œå®ç°ã€‚ä½ åœ¨å­¦å®Œè¿™ä¸€è®²ä¹‹åï¼Œåº”è¯¥å·²ç»å¯¹å†…å­˜æ± æœ‰äº†å……åˆ†çš„äº†è§£ï¼ŒçŸ¥é“ä»€ä¹ˆæƒ…å†µä¸‹ã€è¯¥å¦‚ä½•å»å®ç°ä¸€ä¸ªå†…å­˜æ± ã€‚</p><h2>è¯¾åæ€è€ƒ</h2><p>è¯·ç»ƒä¹ ä¸€ä¸‹æœ¬è®²çš„ä»£ç ï¼Œå¤ç°å†…å­˜æ± ç”Ÿå‘½å‘¨æœŸçš„é—®é¢˜ï¼Œå¹¶å°è¯•ä½¿ç”¨ä¸åŒçš„è§£å†³æ–¹æ¡ˆã€‚ç„¶åï¼š</p><ol>\n<li>å°è¯•ä¸€ä¸‹ï¼Œåœ¨ <code>memory_pool</code> ä¸­åŠ å…¥å¯¹è±¡è®¡æ•°ï¼Œå¹¶åœ¨ææ„æ—¶æ£€æŸ¥å¯¹è±¡æ•°æ˜¯å¦ä¸ºé›¶ï¼Œä»…åœ¨ä¸ºé›¶æ—¶æ‰é‡Šæ”¾å†…å­˜ã€‚</li>\n<li>è€ƒè™‘ä¸€ä¸‹ï¼Œå¦‚ä½•å‘ç°ä½ çš„å®¹å™¨ç»“ç‚¹ç©¶ç«Ÿæ˜¯ä»€ä¹ˆç±»å‹ï¼Ÿ</li>\n</ol><p>å¦‚æœæœ‰ä»»ä½•é—®é¢˜ï¼Œæ¬¢è¿ç•™è¨€å’Œæˆ‘è¿›è¡Œè®¨è®ºã€‚</p><h2><span class=\"reference\">å‚è€ƒèµ„æ–™</span></h2><p><span class=\"reference\">[1] Google, â€œgperftoolsâ€. <a href=\"https://github.com/gperftools/gperftools\">https://github.com/gperftools/gperftools</a></span></p><p><span class=\"reference\">[2] GNU, â€œThe GNU allocatorâ€. <a href=\"https://www.gnu.org/software/libc/manual/html_node/The-GNU-Allocator.html\">https://www.gnu.org/software/libc/manual/html_node/The-GNU-Allocator.html</a></span></p>","comments":[{"had_liked":false,"id":383886,"user_name":"æäº‘é¾™","can_delete":false,"product_type":"c1","uid":3201926,"ip_address":"éŸ©å›½","ucode":"785924B16BE788","user_header":"https://static001.geekbang.org/account/avatar/00/30/db/86/51ec4c41.jpg","comment_is_top":false,"comment_ctime":1699871236,"is_pvip":false,"replies":[{"id":140074,"content":"å¯¹ï¼Œå†…å­˜å·²ç»å˜â€œçƒ­â€äº†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1645639,"ctime":1699941462,"ip_address":"å¹¿ä¸œ","comment_id":383886,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100040501,"comment_content":"è€å¸ˆï¼Œä¸ºä»€ä¹ˆç¬¬äºŒæ¬¡æ’å…¥çš„æ—¶å€™ä¼šå˜å¿«ï¼Ÿä¼¼ä¹æ‰€æœ‰çš„æ€§èƒ½æµ‹è¯•éƒ½æ˜¯è¿™æ ·çš„ï¼Œè·Ÿå±€éƒ¨æ€§å’Œç¼“å­˜æœ‰å…³ç³»å—ï¼Ÿ","like_count":3},{"had_liked":false,"id":380336,"user_name":"Geek_595be5","can_delete":false,"product_type":"c1","uid":3242942,"ip_address":"æ–°åŠ å¡","ucode":"5C29AC709897C0","user_header":"https://static001.geekbang.org/account/avatar/00/31/7b/be/791d0f5e.jpg","comment_is_top":false,"comment_ctime":1693389610,"is_pvip":false,"replies":[{"id":138524,"content":"æˆ‘å°±æ˜¯è¦ä¸€æ¬¡æ€§åˆ†é…ä¸€å—å†…å­˜å‡ºæ¥ï¼Œarray è¶³çŸ£ã€‚è¿™é‡Œä½¿ç”¨ vector åœ¨æ—¶é—´å’Œç©ºé—´ä¸Šéƒ½ä¼šæ›´å·®ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1645639,"ctime":1693464096,"ip_address":"ä¸Šæµ·","comment_id":380336,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040501,"comment_content":"ä¸Šé¢ä¾‹å­ä¸­å®šä¹‰å†…å­˜æ•°æ®storage_ç”¨çš„arrayç±»å‹ï¼Œè¯·é—®è¿™æ˜¯å•çº¯å‡ºäºä¸ªäººä¹ æƒ¯åå¥½å‘¢ï¼Ÿè¿˜æ˜¯arrayæ¯”vectoråœ¨è¿™é‡Œæ›´åˆé€‚å‘¢ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1645639,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/47/53c48284.jpg","nickname":"å´å’ç‚œ","note":"","ucode":"8C24C10AEC779F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":631761,"discussion_content":"å¯¹ï¼Œå†…å­˜å·²ç»å˜â€œçƒ­â€äº†ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1699941462,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2436694,"avatar":"https://static001.geekbang.org/account/avatar/00/25/2e/56/6f38de90.jpg","nickname":"Vä¸‡èƒ½çš„å°é»‘V","note":"","ucode":"262051F1B7847A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":643941,"discussion_content":"å› ä¸ºè¿™å°±æ˜¯ä½¿ç”¨å†…å­˜æ± çš„ä½œç”¨â€”â€”ä¸å†æ¬¡åˆ†é…å†…å­˜","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1714815021,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"ç¾å›½","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":363893,"user_name":"æ€ªå…½","can_delete":false,"product_type":"c1","uid":1324007,"ip_address":"ä¸Šæµ·","ucode":"3342C55CB83B08","user_header":"https://static001.geekbang.org/account/avatar/00/14/33/e7/145be2f9.jpg","comment_is_top":false,"comment_ctime":1670317664,"is_pvip":false,"replies":[{"id":132356,"content":"è§„å®šã€‚è¿™ä¸¤ä¸ªå¿…é¡»æ˜¯é™æ€çš„ï¼Œå¦åˆ™æ²¡æœ‰æ„ä¹‰ã€‚ï¼ˆå¯¹äºå·²ç»å­˜åœ¨çš„å¯¹è±¡æ€ä¹ˆ newï¼Ÿï¼‰","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1645639,"ctime":1670548670,"ip_address":"ä¸Šæµ·","comment_id":363893,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040501,"comment_content":"è¯·é—®ä¸€ä¸‹è€å¸ˆï¼Œåœ¨&quot;å†…å­˜æ± åº”ç”¨ï¼šç±»ç‰¹å®šçš„åˆ†é…å’Œé‡Šæ”¾å‡½æ•°&quot;å°èŠ‚é‡Œï¼ŒåŸæ–‡è¯´&quot;ä¸ç®¡å†™ä¸å†™ staticï¼Œè¿™ä¸¤ä¸ªæˆå‘˜å‡½æ•°éƒ½æ˜¯é™æ€çš„&quot;ï¼Œæ²¡æ˜ç™½ä¸ºä»€ä¹ˆä¸å†™staticä¹Ÿæ˜¯é™æ€çš„ã€‚","like_count":1,"discussions":[{"author":{"id":1645639,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/47/53c48284.jpg","nickname":"å´å’ç‚œ","note":"","ucode":"8C24C10AEC779F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":626878,"discussion_content":"æˆ‘å°±æ˜¯è¦ä¸€æ¬¡æ€§åˆ†é…ä¸€å—å†…å­˜å‡ºæ¥ï¼Œarray è¶³çŸ£ã€‚è¿™é‡Œä½¿ç”¨ vector åœ¨æ—¶é—´å’Œç©ºé—´ä¸Šéƒ½ä¼šæ›´å·®ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1693464096,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":392545,"user_name":"å†·æš–æœ±æ§¿","can_delete":false,"product_type":"c1","uid":1185971,"ip_address":"å¹¿ä¸œ","ucode":"DE116B3E32C2FA","user_header":"https://static001.geekbang.org/account/avatar/00/12/18/b3/1cc77804.jpg","comment_is_top":false,"comment_ctime":1721202652,"is_pvip":false,"replies":[{"id":142827,"content":"ä¸ç”¨ unionï¼Œç”¨å•¥å‘¢ï¼Ÿç”¨ union æ˜¯æˆ‘çœ‹æ¥æœ€è‡ªç„¶çš„æ–¹å¼ã€‚\n\né¦–å…ˆï¼Œç»“ç‚¹æ—¢å¯èƒ½æ˜¯ T ç±»å‹çš„å¯¹è±¡ï¼Œä¹Ÿå¯èƒ½æ˜¯æŒ‡é’ˆï¼Œunion åœ¨è¯­ä¹‰ä¸Šå°±å»åˆã€‚å…¶æ¬¡ï¼Œä½¿ç”¨ union æˆ‘ä»¬å¯ä»¥è‡ªç„¶åœ°è·å¾—å¯¹é½ã€‚\n\næˆ‘ä»¥å‰ä¹Ÿç”¨è¿‡ aligned_storageï¼Œæ²¡è§‰å¾—æ›´æ–¹ä¾¿ã€‚è¿™ç©æ„å„¿ç°åœ¨è¿˜è¢«åºŸå¼ƒäº†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1645639,"ctime":1723345178,"ip_address":"ä¸Šæµ·","comment_id":392545,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100040501,"comment_content":"è€å¸ˆï¼Œè¿™é‡Œä¸ºå•¥è¦ç”¨unionç±»å‹å®šä¹‰nodeï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1645639,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/47/53c48284.jpg","nickname":"å´å’ç‚œ","note":"","ucode":"8C24C10AEC779F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":595989,"discussion_content":"è§„å®šã€‚è¿™ä¸¤ä¸ªå¿…é¡»æ˜¯é™æ€çš„ï¼Œå¦åˆ™æ²¡æœ‰æ„ä¹‰ã€‚ï¼ˆå¯¹äºå·²ç»å­˜åœ¨çš„å¯¹è±¡æ€ä¹ˆ newï¼Ÿï¼‰","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1670548670,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":377934,"user_name":"coming","can_delete":false,"product_type":"c1","uid":1262181,"ip_address":"ä¸Šæµ·","ucode":"7625CE61D9A2D2","user_header":"https://static001.geekbang.org/account/avatar/00/13/42/65/5bfd0a65.jpg","comment_is_top":false,"comment_ctime":1689574775,"is_pvip":false,"replies":[{"id":137764,"content":"å¼€ä¼˜åŒ–äº†å—ï¼Ÿä½ çš„æ•°å­—æ¯”æˆ‘çš„å¤§å¤šäº†ã€‚\n\nå¦å¤–ï¼Œç”¨ tcmalloc ä¸éœ€è¦æ”¹ä»£ç çš„ã€‚ç›´æ¥é“¾æ¥ libtcmalloc.so å°±è¡Œã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1645639,"ctime":1689730694,"ip_address":"ä¸Šæµ·","comment_id":377934,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100040501,"comment_content":"    t1 = rdtsc();\n    for (int i = 0; i &lt; LOOPS; ++i) {\n        for (auto &amp;ptr : ptr_array1) {\n            ptr = (normal::Obj*)tc_malloc(sizeof(normal::Obj));\n        }\n        for (auto ptr : ptr_array1) {\n            tc_free(ptr);\n        }\n    }\n    t2 = rdtsc();\n\nè¿™ç§ä½¿ç”¨tc_mallocæ–¹å¼æ­£ç¡®å§, ä½†æ˜¯å¾ˆå¥‡æ€ªå•Š, æ˜¾ç¤ºCPUå‘¨æœŸæ¯”è¾ƒ, pooledæœ€æ…¢äº†\n68 cycles for each allocation and deallocations on normal Obj\n94 cycles for each allocation and deallocations on pooled Obj\n51 cycles for each allocation and deallocations on tcmalloced Obj\n","like_count":0,"discussions":[{"author":{"id":1645639,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/47/53c48284.jpg","nickname":"å´å’ç‚œ","note":"","ucode":"8C24C10AEC779F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":623650,"discussion_content":"å¼€ä¼˜åŒ–äº†å—ï¼Ÿä½ çš„æ•°å­—æ¯”æˆ‘çš„å¤§å¤šäº†ã€‚\n\nå¦å¤–ï¼Œç”¨ tcmalloc ä¸éœ€è¦æ”¹ä»£ç çš„ã€‚ç›´æ¥é“¾æ¥ libtcmalloc.so å°±è¡Œã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1689730694,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1262181,"avatar":"https://static001.geekbang.org/account/avatar/00/13/42/65/5bfd0a65.jpg","nickname":"coming","note":"","ucode":"7625CE61D9A2D2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":623657,"discussion_content":"è°¢è°¢ï¼Œå´è€å¸ˆï¼Œæˆ‘ç”¨çš„ç¬”è®°æœ¬çš„wslï¼Œæ€§èƒ½å¾ˆå·®ğŸ˜‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1689733343,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":365157,"user_name":"Geek_power","can_delete":false,"product_type":"c1","uid":1762151,"ip_address":"ä¸Šæµ·","ucode":"C0A8D3AA1F12A1","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKSEVQdSoW2S5AnBWq1LQyRiakCJVORLdyFI2ttl8AWdicQOQG24BiccbEkcKBuxAH2Q5wWh9T8qkb0Q/132","comment_is_top":false,"comment_ctime":1672200822,"is_pvip":false,"replies":[{"id":132998,"content":"Linux ä¸‹æ¨èä½¿ç”¨ã€‚å»ºè®®å…ˆä½¿ç”¨ profiling å·¥å…·æˆ–è‡ªå·±æµ‹è¯•æ€§èƒ½æ¥æ¯”è¾ƒä¸€ä¸‹ã€‚\n\nä»»ä½•æ€§èƒ½é—®é¢˜éƒ½éœ€è¦æµ‹é‡æ¥å¾—åˆ°æœ€åå†³å®šéœ€è¦çš„æ•°æ®ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1645639,"ctime":1672229406,"ip_address":"ä¸Šæµ·","comment_id":365157,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040501,"comment_content":"è€å¸ˆï¼Œè¯·é—®ä¸‹å‚è€ƒèµ„æ–™1æ˜¯æ‚¨æåŠ›æ¨èçš„å†…å­˜ç®¡ç†åº“å—ï¼Œæˆ‘å‡†å¤‡ç ”ç©¶å¹¶å¾€é¡¹ç›®ä½¿ç”¨","like_count":0,"discussions":[{"author":{"id":1645639,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/47/53c48284.jpg","nickname":"å´å’ç‚œ","note":"","ucode":"8C24C10AEC779F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":623650,"discussion_content":"å¼€ä¼˜åŒ–äº†å—ï¼Ÿä½ çš„æ•°å­—æ¯”æˆ‘çš„å¤§å¤šäº†ã€‚\n\nå¦å¤–ï¼Œç”¨ tcmalloc ä¸éœ€è¦æ”¹ä»£ç çš„ã€‚ç›´æ¥é“¾æ¥ libtcmalloc.so å°±è¡Œã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1689730694,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1262181,"avatar":"https://static001.geekbang.org/account/avatar/00/13/42/65/5bfd0a65.jpg","nickname":"coming","note":"","ucode":"7625CE61D9A2D2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":623657,"discussion_content":"è°¢è°¢ï¼Œå´è€å¸ˆï¼Œæˆ‘ç”¨çš„ç¬”è®°æœ¬çš„wslï¼Œæ€§èƒ½å¾ˆå·®ğŸ˜‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1689733343,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":363897,"user_name":"æ€ªå…½","can_delete":false,"product_type":"c1","uid":1324007,"ip_address":"ä¸Šæµ·","ucode":"3342C55CB83B08","user_header":"https://static001.geekbang.org/account/avatar/00/14/33/e7/145be2f9.jpg","comment_is_top":false,"comment_ctime":1670321462,"is_pvip":false,"replies":[{"id":132355,"content":"ä¸æ˜¯ã€‚ç¬¬äºŒç‚¹å’Œç¬¬ä¸‰ç‚¹æ˜¯ä¸€è‡´çš„ã€‚åæ„é€ çš„å…ˆææ„ï¼Œæ™šæŒ‚åˆ°é€€å‡ºæ‰§è¡Œé“¾ä¸Šçš„ä»£ç å…ˆæ‰§è¡Œã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1645639,"ctime":1670548538,"ip_address":"ä¸Šæµ·","comment_id":363897,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040501,"comment_content":"è€å¸ˆï¼Œè¿˜æœ‰ä¸ªç–‘é—®ï¼Œåœ¨&quot;ç”Ÿå‘½å‘¨æœŸé™·é˜±&quot;å°èŠ‚é‡Œï¼Œæœ‰4ç‚¹æè¿°ã€‚å…¶ä¸­ç¬¬2ç‚¹è¯´&quot;å®ƒçš„ææ„å‡½æ•°ä¼šæŒ‚åˆ°çº¿ç¨‹é€€å‡ºéœ€è¦æ‰§è¡Œçš„ä»£ç ä¸­ã€‚æ³¨æ„è¿™æ¯”ç¬¬ 1 æ­¥è¦æ™š&quot;ï¼Œè¿™é‡Œçš„æ„æ€æ˜¯æŒ‡å†…å­˜æ± çš„ææ„æ¯”å…¨å±€å¯¹è±¡çš„ææ„è¦æ™šå§ã€‚ç„¶åç¬¬3ç‚¹åˆè¯´ï¼Œ&quot;åæ„é€ çš„å…ˆææ„&quot;ï¼Œæ„æ€æ˜¯å†…å­˜æ± çš„ææ„æ¯”å…¨å±€å¯¹è±¡çš„ææ„è¦æ—©å§ï¼Ÿè¿™ä¸çŸ›ç›¾äº†å—ï¼Ÿæˆ‘å“ªé‡Œç†è§£å‡ºé—®é¢˜äº†ï¼Ÿéº»çƒ¦è€å¸ˆæŒ‡æ­£ä¸€ä¸‹ã€‚","like_count":0,"discussions":[{"author":{"id":1645639,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/47/53c48284.jpg","nickname":"å´å’ç‚œ","note":"","ucode":"8C24C10AEC779F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":597787,"discussion_content":"Linux ä¸‹æ¨èä½¿ç”¨ã€‚å»ºè®®å…ˆä½¿ç”¨ profiling å·¥å…·æˆ–è‡ªå·±æµ‹è¯•æ€§èƒ½æ¥æ¯”è¾ƒä¸€ä¸‹ã€‚\n\nä»»ä½•æ€§èƒ½é—®é¢˜éƒ½éœ€è¦æµ‹é‡æ¥å¾—åˆ°æœ€åå†³å®šéœ€è¦çš„æ•°æ®ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1672229406,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":366515,"user_name":"ç‹è·¯é£","can_delete":false,"product_type":"c1","uid":3020234,"ip_address":"é™•è¥¿","ucode":"46BCC1EE104AE1","user_header":"https://static001.geekbang.org/account/avatar/00/2e/15/ca/4800a10c.jpg","comment_is_top":false,"comment_ctime":1673864814,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100040501,"comment_content":"è¿™å°±æ˜¯äºŒåå¹´çš„åŠŸåŠ›å—","like_count":3},{"had_liked":false,"id":340868,"user_name":"03125555","can_delete":false,"product_type":"c1","uid":2538251,"ip_address":"","ucode":"13928A7DE0AF4A","user_header":"https://static001.geekbang.org/account/avatar/00/26/bb/0b/7cd7f95e.jpg","comment_is_top":false,"comment_ctime":1649207114,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":2,"product_id":100040501,"comment_content":"å±…ç„¶è¿˜åœ¨æ›´æ–°ï¼\n","like_count":1,"discussions":[{"author":{"id":1645639,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/47/53c48284.jpg","nickname":"å´å’ç‚œ","note":"","ucode":"8C24C10AEC779F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":595988,"discussion_content":"ä¸æ˜¯ã€‚ç¬¬äºŒç‚¹å’Œç¬¬ä¸‰ç‚¹æ˜¯ä¸€è‡´çš„ã€‚åæ„é€ çš„å…ˆææ„ï¼Œæ™šæŒ‚åˆ°é€€å‡ºæ‰§è¡Œé“¾ä¸Šçš„ä»£ç å…ˆæ‰§è¡Œã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1670548538,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":380869,"user_name":"DDRH","can_delete":false,"product_type":"c1","uid":3044278,"ip_address":"å¹¿ä¸œ","ucode":"047BF2A1D1A27A","user_header":"https://static001.geekbang.org/account/avatar/00/2e/73/b6/73f85077.jpg","comment_is_top":false,"comment_ctime":1694360415,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100040501,"comment_content":"å±…ç„¶è¿˜åœ¨æ›´æ–°ï¼å¤ªèµäº†","like_count":0,"discussions":[{"author":{"id":1356014,"avatar":"https://static001.geekbang.org/account/avatar/00/14/b0/ee/7409a0d3.jpg","nickname":"å†¬é’","note":"","ucode":"14576781B499FB","race_medal":0,"user_type":8,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":565657,"discussion_content":"ä½ å¥½æˆ‘æ˜¯å°ç¼–ï¼Œç›®å‰çš„æ›´æ–°å‘¨æœŸæ˜¯2å‘¨ä¸€èŠ‚è¯¾ï¼Œå¯ä»¥è¹²ä¸€ä¸‹å“¦ï½ç®—æ˜¯è€å¸ˆçš„æ²‰æ·€å’Œå…è´¹é€ç»™è€ç”¨æˆ·çš„è¯¾ç¨‹å•¦ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1650510239,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":383886,"user_name":"æäº‘é¾™","can_delete":false,"product_type":"c1","uid":3201926,"ip_address":"éŸ©å›½","ucode":"785924B16BE788","user_header":"https://static001.geekbang.org/account/avatar/00/30/db/86/51ec4c41.jpg","comment_is_top":false,"comment_ctime":1699871236,"is_pvip":false,"replies":[{"id":140074,"content":"å¯¹ï¼Œå†…å­˜å·²ç»å˜â€œçƒ­â€äº†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1645639,"ctime":1699941462,"ip_address":"å¹¿ä¸œ","comment_id":383886,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100040501,"comment_content":"è€å¸ˆï¼Œä¸ºä»€ä¹ˆç¬¬äºŒæ¬¡æ’å…¥çš„æ—¶å€™ä¼šå˜å¿«ï¼Ÿä¼¼ä¹æ‰€æœ‰çš„æ€§èƒ½æµ‹è¯•éƒ½æ˜¯è¿™æ ·çš„ï¼Œè·Ÿå±€éƒ¨æ€§å’Œç¼“å­˜æœ‰å…³ç³»å—ï¼Ÿ","like_count":3,"discussions":[{"author":{"id":1645639,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/47/53c48284.jpg","nickname":"å´å’ç‚œ","note":"","ucode":"8C24C10AEC779F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":631761,"discussion_content":"å¯¹ï¼Œå†…å­˜å·²ç»å˜â€œçƒ­â€äº†ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1699941462,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2436694,"avatar":"https://static001.geekbang.org/account/avatar/00/25/2e/56/6f38de90.jpg","nickname":"Vä¸‡èƒ½çš„å°é»‘V","note":"","ucode":"262051F1B7847A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":643941,"discussion_content":"å› ä¸ºè¿™å°±æ˜¯ä½¿ç”¨å†…å­˜æ± çš„ä½œç”¨â€”â€”ä¸å†æ¬¡åˆ†é…å†…å­˜","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1714815021,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"ç¾å›½","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":380336,"user_name":"Geek_595be5","can_delete":false,"product_type":"c1","uid":3242942,"ip_address":"æ–°åŠ å¡","ucode":"5C29AC709897C0","user_header":"https://static001.geekbang.org/account/avatar/00/31/7b/be/791d0f5e.jpg","comment_is_top":false,"comment_ctime":1693389610,"is_pvip":false,"replies":[{"id":138524,"content":"æˆ‘å°±æ˜¯è¦ä¸€æ¬¡æ€§åˆ†é…ä¸€å—å†…å­˜å‡ºæ¥ï¼Œarray è¶³çŸ£ã€‚è¿™é‡Œä½¿ç”¨ vector åœ¨æ—¶é—´å’Œç©ºé—´ä¸Šéƒ½ä¼šæ›´å·®ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1645639,"ctime":1693464096,"ip_address":"ä¸Šæµ·","comment_id":380336,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040501,"comment_content":"ä¸Šé¢ä¾‹å­ä¸­å®šä¹‰å†…å­˜æ•°æ®storage_ç”¨çš„arrayç±»å‹ï¼Œè¯·é—®è¿™æ˜¯å•çº¯å‡ºäºä¸ªäººä¹ æƒ¯åå¥½å‘¢ï¼Ÿè¿˜æ˜¯arrayæ¯”vectoråœ¨è¿™é‡Œæ›´åˆé€‚å‘¢ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1645639,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/47/53c48284.jpg","nickname":"å´å’ç‚œ","note":"","ucode":"8C24C10AEC779F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":626878,"discussion_content":"æˆ‘å°±æ˜¯è¦ä¸€æ¬¡æ€§åˆ†é…ä¸€å—å†…å­˜å‡ºæ¥ï¼Œarray è¶³çŸ£ã€‚è¿™é‡Œä½¿ç”¨ vector åœ¨æ—¶é—´å’Œç©ºé—´ä¸Šéƒ½ä¼šæ›´å·®ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1693464096,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":363893,"user_name":"æ€ªå…½","can_delete":false,"product_type":"c1","uid":1324007,"ip_address":"ä¸Šæµ·","ucode":"3342C55CB83B08","user_header":"https://static001.geekbang.org/account/avatar/00/14/33/e7/145be2f9.jpg","comment_is_top":false,"comment_ctime":1670317664,"is_pvip":false,"replies":[{"id":132356,"content":"è§„å®šã€‚è¿™ä¸¤ä¸ªå¿…é¡»æ˜¯é™æ€çš„ï¼Œå¦åˆ™æ²¡æœ‰æ„ä¹‰ã€‚ï¼ˆå¯¹äºå·²ç»å­˜åœ¨çš„å¯¹è±¡æ€ä¹ˆ newï¼Ÿï¼‰","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1645639,"ctime":1670548670,"ip_address":"ä¸Šæµ·","comment_id":363893,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040501,"comment_content":"è¯·é—®ä¸€ä¸‹è€å¸ˆï¼Œåœ¨&quot;å†…å­˜æ± åº”ç”¨ï¼šç±»ç‰¹å®šçš„åˆ†é…å’Œé‡Šæ”¾å‡½æ•°&quot;å°èŠ‚é‡Œï¼ŒåŸæ–‡è¯´&quot;ä¸ç®¡å†™ä¸å†™ staticï¼Œè¿™ä¸¤ä¸ªæˆå‘˜å‡½æ•°éƒ½æ˜¯é™æ€çš„&quot;ï¼Œæ²¡æ˜ç™½ä¸ºä»€ä¹ˆä¸å†™staticä¹Ÿæ˜¯é™æ€çš„ã€‚","like_count":1,"discussions":[{"author":{"id":1645639,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/47/53c48284.jpg","nickname":"å´å’ç‚œ","note":"","ucode":"8C24C10AEC779F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":595989,"discussion_content":"è§„å®šã€‚è¿™ä¸¤ä¸ªå¿…é¡»æ˜¯é™æ€çš„ï¼Œå¦åˆ™æ²¡æœ‰æ„ä¹‰ã€‚ï¼ˆå¯¹äºå·²ç»å­˜åœ¨çš„å¯¹è±¡æ€ä¹ˆ newï¼Ÿï¼‰","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1670548670,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":392545,"user_name":"å†·æš–æœ±æ§¿","can_delete":false,"product_type":"c1","uid":1185971,"ip_address":"å¹¿ä¸œ","ucode":"DE116B3E32C2FA","user_header":"https://static001.geekbang.org/account/avatar/00/12/18/b3/1cc77804.jpg","comment_is_top":false,"comment_ctime":1721202652,"is_pvip":false,"replies":[{"id":142827,"content":"ä¸ç”¨ unionï¼Œç”¨å•¥å‘¢ï¼Ÿç”¨ union æ˜¯æˆ‘çœ‹æ¥æœ€è‡ªç„¶çš„æ–¹å¼ã€‚\n\né¦–å…ˆï¼Œç»“ç‚¹æ—¢å¯èƒ½æ˜¯ T ç±»å‹çš„å¯¹è±¡ï¼Œä¹Ÿå¯èƒ½æ˜¯æŒ‡é’ˆï¼Œunion åœ¨è¯­ä¹‰ä¸Šå°±å»åˆã€‚å…¶æ¬¡ï¼Œä½¿ç”¨ union æˆ‘ä»¬å¯ä»¥è‡ªç„¶åœ°è·å¾—å¯¹é½ã€‚\n\næˆ‘ä»¥å‰ä¹Ÿç”¨è¿‡ aligned_storageï¼Œæ²¡è§‰å¾—æ›´æ–¹ä¾¿ã€‚è¿™ç©æ„å„¿ç°åœ¨è¿˜è¢«åºŸå¼ƒäº†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1645639,"ctime":1723345178,"ip_address":"ä¸Šæµ·","comment_id":392545,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100040501,"comment_content":"è€å¸ˆï¼Œè¿™é‡Œä¸ºå•¥è¦ç”¨unionç±»å‹å®šä¹‰nodeï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1645639,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/47/53c48284.jpg","nickname":"å´å’ç‚œ","note":"","ucode":"8C24C10AEC779F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":649415,"discussion_content":"ä¸ç”¨ unionï¼Œç”¨å•¥å‘¢ï¼Ÿç”¨ union æ˜¯æˆ‘çœ‹æ¥æœ€è‡ªç„¶çš„æ–¹å¼ã€‚\n\né¦–å…ˆï¼Œç»“ç‚¹æ—¢å¯èƒ½æ˜¯ T ç±»å‹çš„å¯¹è±¡ï¼Œä¹Ÿå¯èƒ½æ˜¯æŒ‡é’ˆï¼Œunion åœ¨è¯­ä¹‰ä¸Šå°±å»åˆã€‚å…¶æ¬¡ï¼Œä½¿ç”¨ union æˆ‘ä»¬å¯ä»¥è‡ªç„¶åœ°è·å¾—å¯¹é½ã€‚\n\næˆ‘ä»¥å‰ä¹Ÿç”¨è¿‡ aligned_storageï¼Œæ²¡è§‰å¾—æ›´æ–¹ä¾¿ã€‚è¿™ç©æ„å„¿ç°åœ¨è¿˜è¢«åºŸå¼ƒäº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1723345178,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1495361,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/mXUvBq6VficHf0kMotLiahOFL1bpIKMMw15T98vHedYnxpxNRiaicSxMo4ZlaykyxT0qJMr9zZWVcPt7iaS68fD9iazA/132","nickname":"cola","note":"","ucode":"3C3360022EBD3D","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":649395,"discussion_content":"1. unionå¯ä»¥é¿å…å†…éƒ¨æˆå‘˜åˆå§‹åŒ–.  åˆ†é…å™¨åªæƒ³åˆ†é…å†…å­˜ 2 ç”¨unionå ç”¨ç©ºé—´å°.  freelistæŒ‡é’ˆç›´æ¥åˆ†é…åˆ°å¯¹è±¡å†…å­˜ç©ºé—´ä¸Š. ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1723280162,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"æ¹–åŒ—","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":377934,"user_name":"coming","can_delete":false,"product_type":"c1","uid":1262181,"ip_address":"ä¸Šæµ·","ucode":"7625CE61D9A2D2","user_header":"https://static001.geekbang.org/account/avatar/00/13/42/65/5bfd0a65.jpg","comment_is_top":false,"comment_ctime":1689574775,"is_pvip":false,"replies":[{"id":137764,"content":"å¼€ä¼˜åŒ–äº†å—ï¼Ÿä½ çš„æ•°å­—æ¯”æˆ‘çš„å¤§å¤šäº†ã€‚\n\nå¦å¤–ï¼Œç”¨ tcmalloc ä¸éœ€è¦æ”¹ä»£ç çš„ã€‚ç›´æ¥é“¾æ¥ libtcmalloc.so å°±è¡Œã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1645639,"ctime":1689730694,"ip_address":"ä¸Šæµ·","comment_id":377934,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100040501,"comment_content":"    t1 = rdtsc();\n    for (int i = 0; i &lt; LOOPS; ++i) {\n        for (auto &amp;ptr : ptr_array1) {\n            ptr = (normal::Obj*)tc_malloc(sizeof(normal::Obj));\n        }\n        for (auto ptr : ptr_array1) {\n            tc_free(ptr);\n        }\n    }\n    t2 = rdtsc();\n\nè¿™ç§ä½¿ç”¨tc_mallocæ–¹å¼æ­£ç¡®å§, ä½†æ˜¯å¾ˆå¥‡æ€ªå•Š, æ˜¾ç¤ºCPUå‘¨æœŸæ¯”è¾ƒ, pooledæœ€æ…¢äº†\n68 cycles for each allocation and deallocations on normal Obj\n94 cycles for each allocation and deallocations on pooled Obj\n51 cycles for each allocation and deallocations on tcmalloced Obj\n","like_count":0,"discussions":[{"author":{"id":1645639,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/47/53c48284.jpg","nickname":"å´å’ç‚œ","note":"","ucode":"8C24C10AEC779F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":649415,"discussion_content":"ä¸ç”¨ unionï¼Œç”¨å•¥å‘¢ï¼Ÿç”¨ union æ˜¯æˆ‘çœ‹æ¥æœ€è‡ªç„¶çš„æ–¹å¼ã€‚\n\né¦–å…ˆï¼Œç»“ç‚¹æ—¢å¯èƒ½æ˜¯ T ç±»å‹çš„å¯¹è±¡ï¼Œä¹Ÿå¯èƒ½æ˜¯æŒ‡é’ˆï¼Œunion åœ¨è¯­ä¹‰ä¸Šå°±å»åˆã€‚å…¶æ¬¡ï¼Œä½¿ç”¨ union æˆ‘ä»¬å¯ä»¥è‡ªç„¶åœ°è·å¾—å¯¹é½ã€‚\n\næˆ‘ä»¥å‰ä¹Ÿç”¨è¿‡ aligned_storageï¼Œæ²¡è§‰å¾—æ›´æ–¹ä¾¿ã€‚è¿™ç©æ„å„¿ç°åœ¨è¿˜è¢«åºŸå¼ƒäº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1723345178,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1495361,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/mXUvBq6VficHf0kMotLiahOFL1bpIKMMw15T98vHedYnxpxNRiaicSxMo4ZlaykyxT0qJMr9zZWVcPt7iaS68fD9iazA/132","nickname":"cola","note":"","ucode":"3C3360022EBD3D","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":649395,"discussion_content":"1. unionå¯ä»¥é¿å…å†…éƒ¨æˆå‘˜åˆå§‹åŒ–.  åˆ†é…å™¨åªæƒ³åˆ†é…å†…å­˜ 2 ç”¨unionå ç”¨ç©ºé—´å°.  freelistæŒ‡é’ˆç›´æ¥åˆ†é…åˆ°å¯¹è±¡å†…å­˜ç©ºé—´ä¸Š. ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1723280162,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"æ¹–åŒ—","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":365157,"user_name":"Geek_power","can_delete":false,"product_type":"c1","uid":1762151,"ip_address":"ä¸Šæµ·","ucode":"C0A8D3AA1F12A1","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKSEVQdSoW2S5AnBWq1LQyRiakCJVORLdyFI2ttl8AWdicQOQG24BiccbEkcKBuxAH2Q5wWh9T8qkb0Q/132","comment_is_top":false,"comment_ctime":1672200822,"is_pvip":false,"replies":[{"id":132998,"content":"Linux ä¸‹æ¨èä½¿ç”¨ã€‚å»ºè®®å…ˆä½¿ç”¨ profiling å·¥å…·æˆ–è‡ªå·±æµ‹è¯•æ€§èƒ½æ¥æ¯”è¾ƒä¸€ä¸‹ã€‚\n\nä»»ä½•æ€§èƒ½é—®é¢˜éƒ½éœ€è¦æµ‹é‡æ¥å¾—åˆ°æœ€åå†³å®šéœ€è¦çš„æ•°æ®ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1645639,"ctime":1672229406,"ip_address":"ä¸Šæµ·","comment_id":365157,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040501,"comment_content":"è€å¸ˆï¼Œè¯·é—®ä¸‹å‚è€ƒèµ„æ–™1æ˜¯æ‚¨æåŠ›æ¨èçš„å†…å­˜ç®¡ç†åº“å—ï¼Œæˆ‘å‡†å¤‡ç ”ç©¶å¹¶å¾€é¡¹ç›®ä½¿ç”¨","like_count":0,"discussions":[{"author":{"id":1645639,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/47/53c48284.jpg","nickname":"å´å’ç‚œ","note":"","ucode":"8C24C10AEC779F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":597787,"discussion_content":"Linux ä¸‹æ¨èä½¿ç”¨ã€‚å»ºè®®å…ˆä½¿ç”¨ profiling å·¥å…·æˆ–è‡ªå·±æµ‹è¯•æ€§èƒ½æ¥æ¯”è¾ƒä¸€ä¸‹ã€‚\n\nä»»ä½•æ€§èƒ½é—®é¢˜éƒ½éœ€è¦æµ‹é‡æ¥å¾—åˆ°æœ€åå†³å®šéœ€è¦çš„æ•°æ®ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1672229406,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":363897,"user_name":"æ€ªå…½","can_delete":false,"product_type":"c1","uid":1324007,"ip_address":"ä¸Šæµ·","ucode":"3342C55CB83B08","user_header":"https://static001.geekbang.org/account/avatar/00/14/33/e7/145be2f9.jpg","comment_is_top":false,"comment_ctime":1670321462,"is_pvip":false,"replies":[{"id":132355,"content":"ä¸æ˜¯ã€‚ç¬¬äºŒç‚¹å’Œç¬¬ä¸‰ç‚¹æ˜¯ä¸€è‡´çš„ã€‚åæ„é€ çš„å…ˆææ„ï¼Œæ™šæŒ‚åˆ°é€€å‡ºæ‰§è¡Œé“¾ä¸Šçš„ä»£ç å…ˆæ‰§è¡Œã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1645639,"ctime":1670548538,"ip_address":"ä¸Šæµ·","comment_id":363897,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040501,"comment_content":"è€å¸ˆï¼Œè¿˜æœ‰ä¸ªç–‘é—®ï¼Œåœ¨&quot;ç”Ÿå‘½å‘¨æœŸé™·é˜±&quot;å°èŠ‚é‡Œï¼Œæœ‰4ç‚¹æè¿°ã€‚å…¶ä¸­ç¬¬2ç‚¹è¯´&quot;å®ƒçš„ææ„å‡½æ•°ä¼šæŒ‚åˆ°çº¿ç¨‹é€€å‡ºéœ€è¦æ‰§è¡Œçš„ä»£ç ä¸­ã€‚æ³¨æ„è¿™æ¯”ç¬¬ 1 æ­¥è¦æ™š&quot;ï¼Œè¿™é‡Œçš„æ„æ€æ˜¯æŒ‡å†…å­˜æ± çš„ææ„æ¯”å…¨å±€å¯¹è±¡çš„ææ„è¦æ™šå§ã€‚ç„¶åç¬¬3ç‚¹åˆè¯´ï¼Œ&quot;åæ„é€ çš„å…ˆææ„&quot;ï¼Œæ„æ€æ˜¯å†…å­˜æ± çš„ææ„æ¯”å…¨å±€å¯¹è±¡çš„ææ„è¦æ—©å§ï¼Ÿè¿™ä¸çŸ›ç›¾äº†å—ï¼Ÿæˆ‘å“ªé‡Œç†è§£å‡ºé—®é¢˜äº†ï¼Ÿéº»çƒ¦è€å¸ˆæŒ‡æ­£ä¸€ä¸‹ã€‚","like_count":0,"discussions":[{"author":{"id":1645639,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/47/53c48284.jpg","nickname":"å´å’ç‚œ","note":"","ucode":"8C24C10AEC779F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":595988,"discussion_content":"ä¸æ˜¯ã€‚ç¬¬äºŒç‚¹å’Œç¬¬ä¸‰ç‚¹æ˜¯ä¸€è‡´çš„ã€‚åæ„é€ çš„å…ˆææ„ï¼Œæ™šæŒ‚åˆ°é€€å‡ºæ‰§è¡Œé“¾ä¸Šçš„ä»£ç å…ˆæ‰§è¡Œã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1670548538,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":366515,"user_name":"ç‹è·¯é£","can_delete":false,"product_type":"c1","uid":3020234,"ip_address":"é™•è¥¿","ucode":"46BCC1EE104AE1","user_header":"https://static001.geekbang.org/account/avatar/00/2e/15/ca/4800a10c.jpg","comment_is_top":false,"comment_ctime":1673864814,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100040501,"comment_content":"è¿™å°±æ˜¯äºŒåå¹´çš„åŠŸåŠ›å—","like_count":3},{"had_liked":false,"id":340868,"user_name":"03125555","can_delete":false,"product_type":"c1","uid":2538251,"ip_address":"","ucode":"13928A7DE0AF4A","user_header":"https://static001.geekbang.org/account/avatar/00/26/bb/0b/7cd7f95e.jpg","comment_is_top":false,"comment_ctime":1649207114,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":2,"product_id":100040501,"comment_content":"å±…ç„¶è¿˜åœ¨æ›´æ–°ï¼\n","like_count":1,"discussions":[{"author":{"id":1356014,"avatar":"https://static001.geekbang.org/account/avatar/00/14/b0/ee/7409a0d3.jpg","nickname":"å†¬é’","note":"","ucode":"14576781B499FB","race_medal":0,"user_type":8,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":565657,"discussion_content":"ä½ å¥½æˆ‘æ˜¯å°ç¼–ï¼Œç›®å‰çš„æ›´æ–°å‘¨æœŸæ˜¯2å‘¨ä¸€èŠ‚è¯¾ï¼Œå¯ä»¥è¹²ä¸€ä¸‹å“¦ï½ç®—æ˜¯è€å¸ˆçš„æ²‰æ·€å’Œå…è´¹é€ç»™è€ç”¨æˆ·çš„è¯¾ç¨‹å•¦ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1650510239,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":380869,"user_name":"DDRH","can_delete":false,"product_type":"c1","uid":3044278,"ip_address":"å¹¿ä¸œ","ucode":"047BF2A1D1A27A","user_header":"https://static001.geekbang.org/account/avatar/00/2e/73/b6/73f85077.jpg","comment_is_top":false,"comment_ctime":1694360415,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100040501,"comment_content":"å±…ç„¶è¿˜åœ¨æ›´æ–°ï¼å¤ªèµäº†","like_count":0}]}