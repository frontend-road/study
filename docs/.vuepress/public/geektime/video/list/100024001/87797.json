{"id":87797,"title":"38 | 反射编程","content":"<h1>课件及源代码地址</h1><p><a href=\"https://gitee.com/geektime-geekbang/go_learning\">https://gitee.com/geektime-geekbang/go_learning</a></p><h2>书目推荐</h2><p><a href=\"time://mall?url=https%3A%2F%2Fh5.youzan.com%2Fv2%2Fgoods%2F1ycmk3uob0ryw\">《计算机程序的构造和解释》</a></p>","comments":[{"had_liked":false,"id":133582,"user_name":"blackpiglet","can_delete":false,"product_type":"c3","uid":1032928,"ip_address":"","ucode":"58AA8329C91767","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c2/e0/7188aa0a.jpg","comment_is_top":false,"comment_ctime":1568614679,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"改了好几遍程序，终于明白为什么要写成这样了， e := &amp;Employee{1, &quot;Mike&quot;, 30} \n原因是：\n1. UpdateAge 必须得声明为 e *Employee 类型的成员变量才能将修改的值保存；\n2. Call 调用 UpdateAge 就必须得传入 *Employee 类型的变量才能调用成功。","like_count":10},{"had_liked":false,"id":285393,"user_name":"数字记忆","can_delete":false,"product_type":"c3","uid":1227797,"ip_address":"","ucode":"26E16F65F559A1","user_header":"https://static001.geekbang.org/account/avatar/00/12/bc/15/23ce17f9.jpg","comment_is_top":false,"comment_ctime":1616771759,"is_pvip":false,"replies":null,"discussion_count":2,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"这个课程仅作了解，没啥深层次的东西","like_count":9,"discussions":[{"author":{"id":2621412,"avatar":"https://static001.geekbang.org/account/avatar/00/27/ff/e4/927547a9.jpg","nickname":"无名无姓","note":"","ucode":"487BD5AA2CD305","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":390936,"discussion_content":"同求","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630160681,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1020525,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/92/6d/becd841a.jpg","nickname":"escray","note":"","ucode":"1F4204930E47C4","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":366501,"discussion_content":"什么样的内容算是深层次的东西？如果有好的学习资料可以推荐一下","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618097402,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":186910,"user_name":"james","can_delete":false,"product_type":"c3","uid":1049208,"ip_address":"","ucode":"5701899403917C","user_header":"https://static001.geekbang.org/account/avatar/00/10/02/78/23c56bce.jpg","comment_is_top":false,"comment_ctime":1583968904,"is_pvip":false,"replies":null,"discussion_count":3,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"获取反射方法的方法名必须要首字母大写, 否则报错","like_count":7,"discussions":[{"author":{"id":1435172,"avatar":"https://static001.geekbang.org/account/avatar/00/15/e6/24/30806a88.jpg","nickname":"right-chen","note":"","ucode":"E0E940E80E7A2D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583322,"discussion_content":"我也是遇到这个问题了，方法名改为大写就好了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660033297,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1182219,"avatar":"https://static001.geekbang.org/account/avatar/00/12/0a/0b/985d3800.jpg","nickname":"郭星","note":"","ucode":"8A0F5DF80E0C61","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":291859,"discussion_content":"大写字母开头代表可以包外访问(public),小写字母开头代表仅限包内访问(private)","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594977522,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1102422,"avatar":"https://static001.geekbang.org/account/avatar/00/10/d2/56/62423b4c.jpg","nickname":"sharp","note":"","ucode":"7215CE28FFCBEF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":286153,"discussion_content":"字段名称也是","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1593075992,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":236029,"user_name":"郭星","can_delete":false,"product_type":"c3","uid":1182219,"ip_address":"","ucode":"8A0F5DF80E0C61","user_header":"https://static001.geekbang.org/account/avatar/00/12/0a/0b/985d3800.jpg","comment_is_top":false,"comment_ctime":1595294655,"is_pvip":false,"replies":null,"discussion_count":2,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"reflect.ValueOf(指针).MethodByName()\nreflect.ValueOf(实例).FieldByName()\n为什么MethodByName 是指针,而FieldByName是实例?","like_count":3,"discussions":[{"author":{"id":2633127,"avatar":"https://static001.geekbang.org/account/avatar/00/28/2d/a7/c7b0c34e.jpg","nickname":"Roy","note":"","ucode":"2B1675B084D3A6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":383913,"discussion_content":"MethodByName 用来调用外部的方法，Go的指针拥有实例所拥有的的所有方法，还能拥有外部定义的方法，例如本节就额外给指针定义了一个 UpdateAge()方法，这个方法只有指针能访问，实例是访问不了的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1626283578,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2633127,"avatar":"https://static001.geekbang.org/account/avatar/00/28/2d/a7/c7b0c34e.jpg","nickname":"Roy","note":"","ucode":"2B1675B084D3A6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":383912,"discussion_content":"源码里面写了，FieldByName 需要传 实例\nfunc (t *rtype) FieldByName(name string) (StructField, bool) {\n\tif t.Kind() != Struct {\n\t\tpanic(&#34;reflect: FieldByName of non-struct type &#34; + t.String())\n\t}\n\ttt := (*structType)(unsafe.Pointer(t))\n\treturn tt.FieldByName(name)\n}","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1626283407,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":308480,"user_name":"陈启航","can_delete":false,"product_type":"c3","uid":2177436,"ip_address":"","ucode":"89246B9BFD3269","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/ajNVdqHZLLC4IhKmJDYdWhQms3dmZqJ5YMDGTlPa1o52DnKSErYjsqfc6iaRJrBDZpx0RqQx7eZAED797kiaV6aw/132","comment_is_top":false,"comment_ctime":1629639659,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"主要就是教基础语法 后半部分感觉没有太多逻辑性了","like_count":2},{"had_liked":false,"id":131066,"user_name":"Hao","can_delete":false,"product_type":"c3","uid":1644394,"ip_address":"","ucode":"95B9D62AA86766","user_header":"https://static001.geekbang.org/account/avatar/00/19/17/6a/fc76fa23.jpg","comment_is_top":false,"comment_ctime":1567622393,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"reflect.ValueOf(&lt;pointer type&gt;).MethodByName()\nreflect.ValueOf(&lt;non-pointer type&gt;).FieldByName()\n\nWhy does MethodByName requires a pointer type while FieldByName not? Is there any reason about it?\n","like_count":2,"discussions":[{"author":{"id":1081987,"avatar":"https://static001.geekbang.org/account/avatar/00/10/82/83/b96a8b7a.jpg","nickname":"flow","note":"","ucode":"0AD565ECBF461E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":258203,"discussion_content":"看看UpdateAge的定义就知道了","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1588664081,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":287667,"user_name":"escray","can_delete":false,"product_type":"c3","uid":1020525,"ip_address":"","ucode":"1F4204930E47C4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/92/6d/becd841a.jpg","comment_is_top":false,"comment_ctime":1618097156,"is_pvip":true,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"其实之前对于 C# 和 Java 中的反射都有些概念模糊，看代码能看到，但是在项目中主动使用的很少。\n\n反射最大的用途可能就是通过字符串或者以字符的形式来调用类型中的某一个方法，或者通过传入变量或者方法的名字访问某一个成员。\n\n其实在 JavaScript 或者 Ruby 中也用到了反射，只是有时候用了而不自知。\n\n对于留言中的问题，为什么 MethodByName 之前的 ValueOf 传递的参数是指针，而 FieldByName 之前 ValueOf 传递的是实例，我也不太明白，抄一段官方文档：\n\n```\nfunc (v Value) FieldByName(name string) Value\n```\n\nFieldByName returns the struct field with the given name. It returns the zero Value if no field was found. It panics if v&#39;s Kind is not struct.\n\n```\nfunc (v Value) MethodByName(name string) Value\n```\n\nMethodByName returns a function value corresponding to the method of v with the given name. The arguments to a Call on the returned function should not include a receiver; the returned function will always use v as the receiver. It returns the zero Value if no method was found.","like_count":1},{"had_liked":false,"id":154355,"user_name":"疯琴","can_delete":false,"product_type":"c3","uid":1099379,"ip_address":"","ucode":"82ACAA4A27753D","user_header":"https://static001.geekbang.org/account/avatar/00/10/c6/73/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1574413900,"is_pvip":false,"replies":null,"discussion_count":2,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"请问老师，为什么.FieldByName前面要用reflect.ValueOf(*e)而MethodByName前面要用reflect.ValueOf(e)，一个是值一个是指针。另外reflect.TypeOf(e).MethodByName(&quot;UpdateAge&quot;)为什么没有Call方法了？","like_count":1,"discussions":[{"author":{"id":1603004,"avatar":"https://static001.geekbang.org/account/avatar/00/18/75/bc/89d88775.jpg","nickname":"Calvin","note":"","ucode":"0EEF5B207623B5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":381301,"discussion_content":"应该是看定义吧，e 本身是一个指针变量，*e 就表示是取 e 指针变量的值，也就是 Employee 实例，实例的 Name 变量的值 / 类型，而 UpdateAge 方法是定义给 *Employee 类型的，也就是调用者需要是指针类型，也就是 e 了。感觉我还得再复习一下 C 语言才行了，* 和 &amp; 的区别，哈哈。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1624986142,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1363634,"avatar":"https://static001.geekbang.org/account/avatar/00/14/ce/b2/1f914527.jpg","nickname":"海盗船长","note":"","ucode":"ECB28BA21A4113","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":320359,"discussion_content":"也是有的。reflect.TypeOf(e).MethodByName(&#34;UpdateAge&#34;).Func.Call()","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604328709,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":303896,"user_name":"看不见的城市","can_delete":false,"product_type":"c3","uid":1905705,"ip_address":"","ucode":"A33F894543C90F","user_header":"https://static001.geekbang.org/account/avatar/00/1d/14/29/48ad4b9d.jpg","comment_is_top":false,"comment_ctime":1627053913,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"Name string `format:&quot;normal&quot;` 这个后面 format 啥意思","like_count":0},{"had_liked":false,"id":302596,"user_name":"Roy","can_delete":false,"product_type":"c3","uid":2633127,"ip_address":"","ucode":"2B1675B084D3A6","user_header":"https://static001.geekbang.org/account/avatar/00/28/2d/a7/c7b0c34e.jpg","comment_is_top":false,"comment_ctime":1626275027,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"提交一下边学编写的代码：\npackage reflect_test\n\nimport (\n\t&quot;fmt&quot;\n\t&quot;reflect&quot;\n\t&quot;testing&quot;\n)\n\ntype Employee struct {\n\tEmployeeId int\n\t&#47;&#47;注意后面的 struct tag 的写法\n\tName string\t\t`format:&quot;normal&quot;`\n\tAge int\n}\n\n&#47;&#47;更新名字，注意这里的 e 是指针类型\nfunc (e *Employee) UpdateName (newVal string) {\n\te.Name = newVal\n}\n\n&#47;&#47;通过反射调用结构体的方法\nfunc TestInvokeByName(t *testing.T)  {\n\te := Employee{1, &quot;Jane&quot;, 18}\n\t&#47;&#47;reflect.TypeOf()可以返回两个值，，第二个值可以用来判断这个值有没有；\n\t&#47;&#47;儿reflect.ValueOf()只会返回一个值\n\tif nameField, ok := reflect.TypeOf(e).FieldByName(&quot;Name&quot;); !ok {\n\t\tt.Error(&quot;Failed to get &#39;Name&#39; field&quot;)\n\t} else {\n\t\t&#47;&#47;获取反射取到的字段的 tag 的值\n\t\tt.Log(&quot;Tag:Format&quot;, nameField.Tag.Get(&quot;format&quot;))\n\t}\n\n\treflect.ValueOf(&amp;e).MethodByName(&quot;UpdateName&quot;).Call([]reflect.Value{reflect.ValueOf(&quot;Mike&quot;)})\n\n\tt.Log(&quot;After update name: &quot;, e)\n}\n&#47;*\n=== RUN   TestInvokeByName\nreflect_test.go:28: Tag:Format normal\nreflect_test.go:33: After update name:  {1 Mike 18}\n--- PASS: TestInvokeByName (0.00s)\nPASS\n*&#47;\n\n&#47;&#47;检查反射类型\n&#47;&#47;用空接口接收任意类型\nfunc CheckType(v interface{})  {\n\tt := reflect.TypeOf(v)\n\tswitch t.Kind() {\n\tcase reflect.Int, reflect.Int32, reflect.Int64:\n\t\tfmt.Println(&quot;Int&quot;)\n\tcase reflect.Float32, reflect.Float64:\n\t\tfmt.Println(&quot;Float&quot;)\n\tdefault:\n\t\tfmt.Println(&quot;unknown type&quot;)\n\t}\n}\n\n&#47;&#47;func TestBasicType(t *testing.T)  {\n&#47;&#47;\tvar f float32 = 1.23\n&#47;&#47;\tCheckType(f)\n&#47;&#47;}\n&#47;*\n=== RUN   TestBasicType\nFloat\n--- PASS: TestBasicType (0.00s)\nPASS\n*&#47;\n","like_count":0}]}