{"id":233614,"title":"28 | 守卫网格：配置TLS安全网关","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/geektime-servicemesh\">https://gitee.com/geektime-geekbang/geektime-servicemesh</a></p>","comments":[{"had_liked":false,"id":252732,"user_name":"城市猎人","can_delete":false,"product_type":"c3","uid":1197979,"ip_address":"","ucode":"4EA53D24F89F63","user_header":"https://static001.geekbang.org/account/avatar/00/12/47/9b/a9241ab4.jpg","comment_is_top":false,"comment_ctime":1602471957,"is_pvip":false,"replies":[{"id":92575,"content":"是envoy的守护进程，你可以进入到envoy的容器看到一个pilot-agent的进程","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1602747612,"ip_address":"","comment_id":252732,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"istio-agent这个是跟envoy一起启动的吗？ 貌似看不到这个单独的进程","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":506853,"discussion_content":"是envoy的守护进程，你可以进入到envoy的容器看到一个pilot-agent的进程","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1602747612,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":247539,"user_name":"suke","can_delete":false,"product_type":"c3","uid":1007753,"ip_address":"","ucode":"C0287C31A4F45B","user_header":"","comment_is_top":false,"comment_ctime":1599734338,"is_pvip":false,"replies":[{"id":91194,"content":"不用，路由能打到对应的服务就行，服务自己暴露出来的接口可以直接访问。","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1600061577,"ip_address":"","comment_id":247539,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"老师您这是不是少了一步，就是需要把http-bin这个服务验证的status 接口通过VirtualService 暴露出路由，然后才可以访问的通吧","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":505430,"discussion_content":"不用，路由能打到对应的服务就行，服务自己暴露出来的接口可以直接访问。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600061577,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":231124,"user_name":"Geek_66dcc6","can_delete":false,"product_type":"c3","uid":1317851,"ip_address":"","ucode":"0EC9C087C5008B","user_header":"","comment_is_top":false,"comment_ctime":1593589182,"is_pvip":false,"replies":[{"id":85718,"content":"可以参考一下：\nhttps:&#47;&#47;istio.io&#47;latest&#47;docs&#47;ops&#47;integrations&#47;certmanager&#47; ","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1593951554,"ip_address":"","comment_id":231124,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"cert-manager 这种方式去生成证书有介绍吗？cert-manager 在istio 中安装的话需要额外指定吗？与1.4 版本的istio 的cert-manager 有没有什么差别，谢谢老师","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":500165,"discussion_content":"可以参考一下：\nhttps://istio.io/latest/docs/ops/integrations/certmanager/ ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1593951554,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":224170,"user_name":"xyz","can_delete":false,"product_type":"c3","uid":1592979,"ip_address":"","ucode":"DDDE99420E8047","user_header":"https://static001.geekbang.org/account/avatar/00/18/4e/93/b947574c.jpg","comment_is_top":false,"comment_ctime":1591294533,"is_pvip":false,"replies":[{"id":82573,"content":"tls安全网关的背后运作原理就是sds","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1591335636,"ip_address":"","comment_id":224170,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"没理解 28课 先讲sds 然后说讲一个例子 就讲了网关https配置  这个网关https和sds没有任何关系吧 怎么能用这个网关https配置来解释sds呢","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":497385,"discussion_content":"tls安全网关的背后运作原理就是sds","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591335636,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1592979,"avatar":"https://static001.geekbang.org/account/avatar/00/18/4e/93/b947574c.jpg","nickname":"xyz","note":"","ucode":"DDDE99420E8047","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":279384,"discussion_content":"sds是请求证书 签发证书 派发证书这一套呀 tls网关是你k8s命令new了一个tls证书 和原生k8s ingress挂载tls证书是一回事 怎么和sds有关系呢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591338025,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":220439,"user_name":"陈斌","can_delete":false,"product_type":"c3","uid":1182085,"ip_address":"","ucode":"795FCC4D4B2D0D","user_header":"https://static001.geekbang.org/account/avatar/00/12/09/85/7d56342f.jpg","comment_is_top":false,"comment_ctime":1590242319,"is_pvip":false,"replies":[{"id":81395,"content":"```\nkubectl create -n istio-system secret generic httpbin-credential \\\n--from-file=key=httpbin.example.com&#47;3_application&#47;private&#47;httpbin.example.com.key.pem \\\n--from-file=cert=httpbin.example.com&#47;3_application&#47;certs&#47;httpbin.example.com.cert.pem\n``` 有同学说的上传的证书有问题，试试这个","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1590298858,"ip_address":"","comment_id":220439,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"老师请问一下这个问题：\n我是在阿里云ack的k8s上面安装istio-1.5.2开的测试环境,所以不能使用localhost来访问服务\n在Ingress Gateway那一节中，我为httpbin服务增加了外部端口，在阿里云环境会生成一个SLB  192.168.181.233:8000 \n 然后修改本机&#47;etc&#47;hosts 增加记录192.168.181.233 httpbin.example.com  \n最后执行curl -I -HHost:httpbin.example.com http:&#47;&#47;httpbin.example.com:8000&#47;status&#47;200 就成功了。\n但是在tls这一节中，升级了本机openssl, 编译升级了curl 7.70.0 以后，其他似乎配置都ok\n我使用 curl https:&#47;&#47;www.github.com --verbose 一切正常\n但使用这个命令 curl -v -HHost:httpbin.example.com --resolve httpbin.example.com:443:192.168.181.233 --cacert example.com.crt https:&#47;&#47;httpbin.example.com:443&#47;status&#47;418\n* Added httpbin.example.com:443:192.168.181.233 to DNS cache\n* Hostname httpbin.example.com was found in DNS cache\n*   Trying 192.168.181.233:443...\n* Connected to httpbin.example.com (192.168.181.233) port 443 (#0)\n* ALPN, offering http&#47;1.1\n* successfully set certificate verify locations:\n*   CAfile: example.com.crt\n  CApath: none\n* TLSv1.3 (OUT), TLS handshake, Client hello (1):\n* error:1408F10B:SSL routines:ssl3_get_record:wrong version number\n* Closing connection 0\ncurl: (35) error:1408F10B:SSL routines:ssl3_get_record:wrong version number\n就出错了。看样子似乎服务端的https没有生效。但我的mygateway 和 httpbin的 VirtualService都是按老师的代码设置的。 \n不知道是什么问题？或者有什么方法可以找出问题？谢谢! \n\n  \n","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":496141,"discussion_content":"```\nkubectl create -n istio-system secret generic httpbin-credential \\\n--from-file=key=httpbin.example.com/3_application/private/httpbin.example.com.key.pem \\\n--from-file=cert=httpbin.example.com/3_application/certs/httpbin.example.com.cert.pem\n``` 有同学说的上传的证书有问题，试试这个","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590298858,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":272395,"discussion_content":"有同学说证书生成有问题，我稍后检查一下，你用这个试试\n```\nkubectl create -n istio-system secret generic httpbin-credential \\\n--from-file=key=httpbin.example.com/3_application/private/httpbin.example.com.key.pem \\\n--from-file=cert=httpbin.example.com/3_application/certs/httpbin.example.com.cert.pem\n```","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590298808,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1182085,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/85/7d56342f.jpg","nickname":"陈斌","note":"","ucode":"795FCC4D4B2D0D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":272403,"discussion_content":"已用 kubectl create -n istio-system secret generic httpbin-credential \\\n--from-file=key=httpbin.example.com/3_application/private/httpbin.example.com.key.pem \\\n--from-file=cert=httpbin.example.com/3_application/certs/httpbin.example.com.cert.pem\n重新生成证书。然后curl命令也改成了\ncurl -v -HHost:httpbin.example.com --resolve httpbin.example.com:443:192.168.181.233 --cacert httpbin.example.com/3_application/certs/httpbin.example.com.cert.pem https://httpbin.example.com:443/status/418\n\n* Added httpbin.example.com:443:192.168.181.233 to DNS cache\n*   Trying 192.168.181.233:8000...\n* Connected to httpbin.example.com (192.168.181.233) port 443 (#0)\n* ALPN, offering http/1.1\n* successfully set certificate verify locations:\n*   CAfile: httpbin.example.com/3_application/certs/httpbin.example.com.cert.pem\n  CApath: none\n* TLSv1.3 (OUT), TLS handshake, Client hello (1):\n* error:1408F10B:SSL routines:ssl3_get_record:wrong version number\n* Closing connection 0\ncurl: (35) error:1408F10B:SSL routines:ssl3_get_record:wrong version number\n\n但似乎还是原来的错误没变","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590300278,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":272395,"ip_address":"","group_id":0},"score":272403,"extra":""}]}]},{"had_liked":false,"id":217490,"user_name":"我来也","can_delete":false,"product_type":"c3","uid":1205253,"ip_address":"","ucode":"773D6104F56767","user_header":"https://static001.geekbang.org/account/avatar/00/12/64/05/6989dce6.jpg","comment_is_top":false,"comment_ctime":1589513788,"is_pvip":false,"replies":[{"id":80735,"content":"感谢提醒，我重新push下：）","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1589776868,"ip_address":"","comment_id":217490,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"老师的视频中是通过openssl生成的证书,而github上的code.txt是用脚本生成的证书.\n导致code.txt的第三步不匹配.\n换成如下语句就可以了:\n\n```\nkubectl create -n istio-system secret generic httpbin-credential \\\n--from-file=key=httpbin.example.com&#47;3_application&#47;private&#47;httpbin.example.com.key.pem \\\n--from-file=cert=httpbin.example.com&#47;3_application&#47;certs&#47;httpbin.example.com.cert.pem\n```","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":495164,"discussion_content":"感谢提醒，我重新push下：）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589776868,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":380985,"user_name":"jmtm","can_delete":false,"product_type":"c3","uid":1394783,"ip_address":"上海","ucode":"3130D45EC7ACC6","user_header":"https://static001.geekbang.org/account/avatar/00/15/48/5f/5542ef0a.jpg","comment_is_top":false,"comment_ctime":1694529818,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"老师我想问下关于tls的问题，生成了证书和私钥，创建了secrets，Istio Gateway 设置为tls SIMPLE模式，为什么视频中使用curl请求的是时候需要携带证书？客户端不需要提供证书，只需验证服务端的证书是否受信任，这这样吗？","like_count":0}]}