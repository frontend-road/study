{"id":292574,"title":"29 | Window Function","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/geektime-Flink\">https://gitee.com/geektime-geekbang/geektime-Flink</a></p>","comments":[{"had_liked":false,"id":253873,"user_name":"yang","can_delete":false,"product_type":"c3","uid":1074310,"ip_address":"","ucode":"1AA1497C5A293C","user_header":"https://static001.geekbang.org/account/avatar/00/10/64/86/f5a9403a.jpg","comment_is_top":false,"comment_ctime":1602925577,"is_pvip":false,"replies":[{"id":93252,"content":"可以的 大部分聚合算子都是这么实现的","user_name":"作者回复","user_name_real":"张利兵","uid":1119779,"ctime":1603529475,"ip_address":"","comment_id":253873,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100058801,"comment_content":"看到有位同学说 对 WindowProcessFunction 做 state 保留，保留每次计算结果。\n可是 WindowProcessFunction 本身是全量处理当前窗口中的元素呀，也就是到达触发条件了才一次性做全量计算。\n所以，我认为应该是不能解决老师说的整合问题的。\n\n我想，可不可以将 WindowProcessFunction 封装进 类似 ReduceFunction 这样的增量计算函数中， 从而达到以全量的计算方式计算增量的数据？ 既要保证计算结果的正确性、还要保证快速。","like_count":5,"discussions":[{"author":{"id":1119779,"avatar":"https://static001.geekbang.org/account/avatar/00/11/16/23/99c7ede5.jpg","nickname":"张利兵","note":"","ucode":"DBAE17970AB143","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":507210,"discussion_content":"可以的 大部分聚合算子都是这么实现的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603529475,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1613919,"avatar":"https://static001.geekbang.org/account/avatar/00/18/a0/5f/cf72d453.jpg","nickname":"小豹哥","note":"","ucode":"115FF45CAA6FAD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":626997,"discussion_content":"没太明白，有代码示例看看嘛","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1693570760,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"湖南","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":272476,"user_name":"碧雪天虹","can_delete":false,"product_type":"c3","uid":1258359,"ip_address":"","ucode":"313CC048C7E341","user_header":"https://static001.geekbang.org/account/avatar/00/13/33/77/0c593044.jpg","comment_is_top":false,"comment_ctime":1610096660,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100058801,"comment_content":"ProcessWindowFunction 处理性能弱的原因, 主要有两点:\n1. 时间上, 因为要等待窗口内所有数据到达后才开始计算, 所以计算负载在时间线上是不均衡的.\n2. 空间上, 同样因为要等待窗口内所有数据, 造成数据会滞留一段时间, 所以缓冲负载在时间线上是不均衡的.\n\n综上所述, 优化的方向就是分阶段, 先增量预计算, 再全量汇总.\n\n就像老师讲的求平均数计算, 从数学上来说这是需要全量数据的, 但是可以拆分为两个阶段:\n1. 局部增量计算累加值, 局部增量计算累计数, 这里使用增量函数在多个分区分别计算, 几乎没有停滞完成了数据的预计算.\n2. 全量合并累加值, 全量合并累计数, 最后用总累加值除以总累计数, 得到平均值, 这里使用全量函数汇总到单个算子, 但是相比收集所有的原始数据计算, 第二阶段不论是计算压力还是存储压力都比一次性计算要小.","like_count":14},{"had_liked":false,"id":288207,"user_name":"suke","can_delete":false,"product_type":"c3","uid":1007753,"ip_address":"","ucode":"C0287C31A4F45B","user_header":"","comment_is_top":false,"comment_ctime":1618365055,"is_pvip":false,"replies":null,"discussion_count":2,"race_medal":0,"score":2,"product_id":100058801,"comment_content":"老师讲了这么多算子，连一个可以跑的代码也没讲过","like_count":3,"discussions":[{"author":{"id":2028957,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/f5/9d/104bb8ea.jpg","nickname":"Geek2014","note":"","ucode":"9EB356D8DF287E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":404757,"discussion_content":"有工程，看一下git","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634396493,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2309076,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/hvb2KFTy9wdlpTA5dPVPyow44pDtAFH3abXphxktutTlpe2yveiaTqicz68icsUXkZGTjQnQ5zjX6ZQSRn5C6OicaA/132","nickname":"Geek_904551","note":"","ucode":"8AE24B32FBCD24","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":369554,"discussion_content":"开始都说了只讲原理\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619077480,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":252711,"user_name":"starwolf","can_delete":false,"product_type":"c3","uid":1340759,"ip_address":"","ucode":"124152634E7CC7","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eondPEiaia6ugMDzWTRZXt6X5RLVtsYPBwiaskicyJADq1hD0KxyiaNiaRhBxgwTGia1fmDgfDo0y8YxjzKQ/132","comment_is_top":false,"comment_ctime":1602464027,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100058801,"comment_content":"我觉得，如果想获得增量方法的性能，可以将processFunction的处理结果存入state，这样下次有数据来的时候，可以与其中的某些中间结果做比较，而不用再将所有数据全部处理一遍，从而达到接近增量方法性能的目的。","like_count":1},{"had_liked":false,"id":363733,"user_name":"李新卫  ","can_delete":false,"product_type":"c3","uid":1948980,"ip_address":"北京","ucode":"AA3B138B3B49F8","user_header":"https://static001.geekbang.org/account/avatar/00/1d/bd/34/49ef96b2.jpg","comment_is_top":false,"comment_ctime":1670076408,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100058801,"comment_content":"呜呼哀哉","like_count":0},{"had_liked":false,"id":316251,"user_name":"tiny🌾","can_delete":false,"product_type":"c3","uid":1119851,"ip_address":"","ucode":"7A4DE00381D1F3","user_header":"https://static001.geekbang.org/account/avatar/00/11/16/6b/af7c7745.jpg","comment_is_top":false,"comment_ctime":1634221164,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100058801,"comment_content":"有2个工程上的问题问题不太清楚\n 1.聚合的维度数据有长有短，比如用户1天的下载文件次数，用户5分钟下载文件次数，这2种是都在flink里计算，还是计算5分钟的，然后用5分钟的在聚合成一天的？\n2.像这么多维度，这么多指标一般怎么存储比较方便？ redis,mysql或者其他存储？","like_count":0}]}