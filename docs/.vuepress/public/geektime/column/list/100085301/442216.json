{"id":442216,"title":"33ï½œå¹¶å‘å¤„ç†ï¼ˆä¸Šï¼‰ï¼šä»atomicsåˆ°Channelï¼ŒRustéƒ½æä¾›äº†ä»€ä¹ˆå·¥å…·ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯é™ˆå¤©ã€‚</p><p>ä¸çŸ¥ä¸è§‰æˆ‘ä»¬å·²ç»å¹¶è‚©ä½œæˆ˜ä¸‰åå¤šè®²äº†ï¼Œå¸Œæœ›ä½ é€šè¿‡è¿™æ®µæ—¶é—´çš„å­¦ä¹ ï¼Œæœ‰ä¸€ç§â€œæˆ‘æˆä¸ºæ›´å¥½çš„ç¨‹åºå‘˜å•¦ï¼â€è¿™æ ·çš„æ„Ÿè§‰ã€‚è¿™æ˜¯æˆ‘æƒ³é€šè¿‡ä»‹ç» Rust çš„æ€æƒ³ã€å¤„ç†é—®é¢˜çš„æ€è·¯ã€è®¾è®¡æ¥å£çš„ç†å¿µç­‰ç­‰ä¼ é€’ç»™ä½ çš„ã€‚å¦‚ä»Šï¼Œæˆ‘ä»¬ç»ˆäºæ¥åˆ°äº†å¤‡å—æœŸå¾…çš„å¹¶å‘å’Œå¼‚æ­¥çš„ç¯‡ç« ã€‚</p><p>å¾ˆå¤šäººåˆ†ä¸æ¸…å¹¶å‘å’Œå¹¶è¡Œçš„æ¦‚å¿µï¼ŒRob Pikeï¼ŒGolang çš„åˆ›å§‹äººä¹‹ä¸€ï¼Œå¯¹æ­¤æœ‰å¾ˆç²¾è¾Ÿå¾ˆç›´è§‚çš„è§£é‡Šï¼š</p><blockquote>\n<p>Concurrency is about&nbsp;<strong>dealing with</strong>&nbsp;lots of things at once. Parallelism is about&nbsp;<strong>doing</strong>&nbsp;lots of things at once.</p>\n</blockquote><p>å¹¶å‘æ˜¯ä¸€ç§åŒæ—¶å¤„ç†å¾ˆå¤šäº‹æƒ…çš„èƒ½åŠ›ï¼Œå¹¶è¡Œæ˜¯ä¸€ç§åŒæ—¶æ‰§è¡Œå¾ˆå¤šäº‹æƒ…çš„æ‰‹æ®µã€‚</p><p>æˆ‘ä»¬æŠŠè¦åšçš„äº‹æƒ…æ”¾åœ¨å¤šä¸ªçº¿ç¨‹ä¸­ï¼Œæˆ–è€…å¤šä¸ªå¼‚æ­¥ä»»åŠ¡ä¸­å¤„ç†ï¼Œè¿™æ˜¯å¹¶å‘çš„èƒ½åŠ›ã€‚åœ¨å¤šæ ¸å¤š CPU çš„æœºå™¨ä¸ŠåŒæ—¶è¿è¡Œè¿™äº›çº¿ç¨‹æˆ–è€…å¼‚æ­¥ä»»åŠ¡ï¼Œæ˜¯å¹¶è¡Œçš„æ‰‹æ®µã€‚å¯ä»¥è¯´ï¼Œå¹¶å‘æ˜¯ä¸ºå¹¶è¡Œèµ‹èƒ½ã€‚å½“æˆ‘ä»¬å…·å¤‡äº†å¹¶å‘çš„èƒ½åŠ›ï¼Œå¹¶è¡Œå°±æ˜¯æ°´åˆ°æ¸ æˆçš„äº‹æƒ…ã€‚</p><p>å…¶å®ä¹‹å‰å·²ç»æ¶‰åŠäº†å¾ˆå¤šå’Œå¹¶å‘ç›¸å…³çš„å†…å®¹ã€‚æ¯”å¦‚ç”¨ std::thread æ¥åˆ›å»ºçº¿ç¨‹ã€ç”¨ std::sync ä¸‹çš„å¹¶å‘åŸè¯­ï¼ˆMutexï¼‰æ¥å¤„ç†å¹¶å‘è¿‡ç¨‹ä¸­çš„åŒæ­¥é—®é¢˜ã€ç”¨ Send/Sync trait æ¥ä¿è¯å¹¶å‘çš„å®‰å…¨ç­‰ç­‰ã€‚</p><!-- [[[read_end]]] --><p>åœ¨å¤„ç†å¹¶å‘çš„è¿‡ç¨‹ä¸­ï¼Œ<strong>éš¾ç‚¹å¹¶ä¸åœ¨äºå¦‚ä½•åˆ›å»ºå¤šä¸ªçº¿ç¨‹æ¥åˆ†é…å·¥ä½œï¼Œåœ¨äºå¦‚ä½•åœ¨è¿™äº›å¹¶å‘çš„ä»»åŠ¡ä¸­è¿›è¡ŒåŒæ­¥</strong>ã€‚æˆ‘ä»¬æ¥çœ‹å¹¶å‘çŠ¶æ€ä¸‹å‡ ç§å¸¸è§çš„å·¥ä½œæ¨¡å¼ï¼šè‡ªç”±ç«äº‰æ¨¡å¼ã€map/reduce æ¨¡å¼ã€DAG æ¨¡å¼ï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/00/58/003294c9ba4b291e47585fa1a599a358.jpg?wh=2364x1142\" alt=\"\"></p><p>åœ¨è‡ªç”±ç«äº‰æ¨¡å¼ä¸‹ï¼Œå¤šä¸ªå¹¶å‘ä»»åŠ¡ä¼šç«äº‰åŒä¸€ä¸ªä¸´ç•ŒåŒºçš„è®¿é—®æƒã€‚ä»»åŠ¡ä¹‹é—´åœ¨ä½•æ—¶ã€ä»¥ä½•ç§æ–¹å¼å»è®¿é—®ä¸´ç•ŒåŒºï¼Œæ˜¯ä¸ç¡®å®šçš„ï¼Œæˆ–è€…è¯´æ˜¯æœ€ä¸ºçµæ´»çš„ï¼Œåªè¦åœ¨è¿›å…¥ä¸´ç•ŒåŒºæ—¶è·å¾—ç‹¬å è®¿é—®å³å¯ã€‚</p><p>åœ¨è‡ªç”±ç«äº‰çš„åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥é™åˆ¶å¹¶å‘çš„åŒæ­¥æ¨¡å¼ï¼Œå…¸å‹çš„æœ‰ map/reduce æ¨¡å¼å’Œ DAG æ¨¡å¼ã€‚map/reduce æ¨¡å¼ï¼ŒæŠŠå·¥ä½œæ‰“æ•£ï¼ŒæŒ‰ç…§ç›¸åŒçš„å¤„ç†å®Œæˆåï¼Œå†æŒ‰ç…§ä¸€å®šçš„é¡ºåºå°†ç»“æœç»„ç»‡èµ·æ¥ï¼›DAG æ¨¡å¼ï¼ŒæŠŠå·¥ä½œåˆ‡æˆä¸ç›¸äº¤çš„ã€æœ‰ä¾èµ–å…³ç³»çš„å­ä»»åŠ¡ï¼Œç„¶åæŒ‰ä¾èµ–å…³ç³»å¹¶å‘æ‰§è¡Œã€‚</p><p>è¿™ä¸‰ç§åŸºæœ¬æ¨¡å¼ç»„åˆèµ·æ¥ï¼Œå¯ä»¥å¤„ç†éå¸¸å¤æ‚çš„å¹¶å‘åœºæ™¯ã€‚æ‰€ä»¥ï¼Œå½“æˆ‘ä»¬å¤„ç†å¤æ‚é—®é¢˜çš„æ—¶å€™ï¼Œåº”è¯¥<strong>å…ˆå˜æ¸…å…¶è„‰ç»œï¼Œç”¨åˆ†æ²»çš„æ€æƒ³æŠŠé—®é¢˜æ‹†è§£æˆæ­£äº¤çš„å­é—®é¢˜ï¼Œç„¶åç»„åˆåˆé€‚çš„å¹¶å‘æ¨¡å¼æ¥å¤„ç†è¿™äº›å­é—®é¢˜</strong>ã€‚</p><p>åœ¨è¿™äº›å¹¶å‘æ¨¡å¼èƒŒåï¼Œéƒ½æœ‰å“ªäº›å¹¶å‘åŸè¯­å¯ä»¥ä¸ºæˆ‘ä»¬æ‰€ç”¨å‘¢ï¼Œè¿™ä¸¤è®²ä¼šé‡ç‚¹è®²è§£å’Œæ·±å…¥äº”ä¸ªæ¦‚å¿µAtomicã€Mutexã€Condvarã€Channel å’Œ Actor modelã€‚ä»Šå¤©å…ˆè®²å‰ä¸¤ä¸ªAtomicå’ŒMutexã€‚</p><h2>Atomic</h2><p>Atomic æ˜¯æ‰€æœ‰å¹¶å‘åŸè¯­çš„åŸºç¡€ï¼Œå®ƒä¸ºå¹¶å‘ä»»åŠ¡çš„åŒæ­¥å¥ å®šäº†åšå®çš„åŸºç¡€ã€‚</p><p>è°ˆåˆ°åŒæ­¥ï¼Œç›¸ä¿¡ä½ é¦–å…ˆä¼šæƒ³åˆ°é”ï¼Œæ‰€ä»¥åœ¨å…·ä½“ä»‹ç» atomic ä¹‹å‰ï¼Œæˆ‘ä»¬ä»æœ€åŸºæœ¬çš„é”è¯¥å¦‚ä½•å®ç°è®²èµ·ã€‚è‡ªç”±ç«äº‰æ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ç”¨äº’æ–¥é”æ¥ä¿æŠ¤æŸä¸ªä¸´ç•ŒåŒºï¼Œä½¿è¿›å…¥ä¸´ç•ŒåŒºçš„ä»»åŠ¡æ‹¥æœ‰ç‹¬å è®¿é—®çš„æƒé™ã€‚</p><p>ä¸ºäº†ç®€ä¾¿èµ·è§ï¼Œåœ¨è·å–è¿™æŠŠé”çš„æ—¶å€™ï¼Œå¦‚æœè·å–ä¸åˆ°ï¼Œå°±ä¸€ç›´æ­»å¾ªç¯ï¼Œç›´åˆ°æ‹¿åˆ°é”ä¸ºæ­¢ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=de58e0ed23b546b3025c566ecbded4e5\">ä»£ç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">use std::{cell::RefCell, fmt, sync::Arc, thread};\n\nstruct Lock&lt;T&gt; {\n    locked: RefCell&lt;bool&gt;,\n    data: RefCell&lt;T&gt;,\n}\n\nimpl&lt;T&gt; fmt::Debug for Lock&lt;T&gt;\nwhere\n    T: fmt::Debug,\n{\n    fn fmt(&amp;self, f: &amp;mut fmt::Formatter&lt;'_&gt;) -&gt; fmt::Result {\n        write!(f, \"Lock&lt;{:?}&gt;\", self.data.borrow())\n    }\n}\n\n// SAFETY: æˆ‘ä»¬ç¡®ä¿¡ Lock&lt;T&gt; å¾ˆå®‰å…¨ï¼Œå¯ä»¥åœ¨å¤šä¸ªçº¿ç¨‹ä¸­å…±äº«\nunsafe impl&lt;T&gt; Sync for Lock&lt;T&gt; {}\n\nimpl&lt;T&gt; Lock&lt;T&gt; {\n    pub fn new(data: T) -&gt; Self {\n        Self {\n            data: RefCell::new(data),\n            locked: RefCell::new(false),\n        }\n    }\n\n    pub fn lock(&amp;self, op: impl FnOnce(&amp;mut T)) {\n        // å¦‚æœæ²¡æ‹¿åˆ°é”ï¼Œå°±ä¸€ç›´ spin\n        while *self.locked.borrow() != false {} // **1\n\n        // æ‹¿åˆ°ï¼Œèµ¶ç´§åŠ é”\n        *self.locked.borrow_mut() = true; // **2\n\n        // å¼€å§‹å¹²æ´»\n        op(&amp;mut self.data.borrow_mut()); // **3\n\n        // è§£é”\n        *self.locked.borrow_mut() = false; // **4\n    }\n}\n\nfn main() {\n    let data = Arc::new(Lock::new(0));\n\n    let data1 = data.clone();\n    let t1 = thread::spawn(move || {\n        data1.lock(|v| *v += 10);\n    });\n\n    let data2 = data.clone();\n    let t2 = thread::spawn(move || {\n        data2.lock(|v| *v *= 10);\n    });\n    t1.join().unwrap();\n    t2.join().unwrap();\n\n    println!(\"data: {:?}\", data);\n}\n</code></pre><p>è¿™æ®µä»£ç æ¨¡æ‹Ÿäº† Mutex çš„å®ç°ï¼Œå®ƒçš„æ ¸å¿ƒéƒ¨åˆ†æ˜¯ lock() æ–¹æ³•ã€‚</p><p>æˆ‘ä»¬ä¹‹å‰è¯´è¿‡ï¼ŒMutex åœ¨è°ƒç”¨ lock() åï¼Œä¼šå¾—åˆ°ä¸€ä¸ª MutexGuard çš„ RAII ç»“æ„ï¼Œè¿™é‡Œä¸ºäº†ç®€ä¾¿èµ·è§ï¼Œè¦æ±‚è°ƒç”¨è€…ä¼ å…¥ä¸€ä¸ªé—­åŒ…ï¼Œæ¥å¤„ç†åŠ é”åçš„äº‹åŠ¡ã€‚<strong>åœ¨ lock() æ–¹æ³•é‡Œï¼Œæ‹¿ä¸åˆ°é”çš„å¹¶å‘ä»»åŠ¡ä¼šä¸€ç›´ spinï¼Œæ‹¿åˆ°é”çš„ä»»åŠ¡å¯ä»¥å¹²æ´»ï¼Œå¹²å®Œæ´»åä¼šè§£é”ï¼Œè¿™æ ·ä¹‹å‰ spin çš„ä»»åŠ¡ä¼šç«äº‰åˆ°é”ï¼Œè¿›å…¥ä¸´ç•ŒåŒº</strong>ã€‚</p><p>è¿™æ ·çš„å®ç°çœ‹ä¸Šå»ä¼¼ä¹é—®é¢˜ä¸å¤§ï¼Œä½†æ˜¯ä½ ç»†æƒ³ï¼Œå®ƒæœ‰å¥½å‡ ä¸ªé—®é¢˜ï¼š</p><ol>\n<li>åœ¨å¤šæ ¸æƒ…å†µä¸‹ï¼Œ<code>**1</code> å’Œ <code>**2</code> ä¹‹é—´ï¼Œæœ‰å¯èƒ½å…¶å®ƒçº¿ç¨‹ä¹Ÿç¢°å·§ spin ç»“æŸï¼ŒæŠŠ locked ä¿®æ”¹ä¸º trueã€‚è¿™æ ·ï¼Œå­˜åœ¨å¤šä¸ªçº¿ç¨‹æ‹¿åˆ°è¿™æŠŠé”ï¼Œç ´åäº†ä»»ä½•çº¿ç¨‹éƒ½æœ‰ç‹¬å è®¿é—®çš„ä¿è¯ã€‚</li>\n<li>å³ä¾¿åœ¨å•æ ¸æƒ…å†µä¸‹ï¼Œ<code>**1</code> å’Œ <code>**2</code> ä¹‹é—´ï¼Œä¹Ÿå¯èƒ½å› ä¸ºæ“ä½œç³»ç»Ÿçš„å¯æŠ¢å å¼è°ƒåº¦ï¼Œå¯¼è‡´é—®é¢˜1å‘ç”Ÿã€‚</li>\n<li>å¦‚ä»Šçš„ç¼–è¯‘å™¨ä¼šæœ€å¤§ç¨‹åº¦ä¼˜åŒ–ç”Ÿæˆçš„æŒ‡ä»¤ï¼Œå¦‚æœæ“ä½œä¹‹é—´æ²¡æœ‰ä¾èµ–å…³ç³»ï¼Œå¯èƒ½ä¼šç”Ÿæˆä¹±åºçš„æœºå™¨ç ï¼Œæ¯”å¦‚<code>**3</code> è¢«ä¼˜åŒ–æ”¾åœ¨ <code>**1</code> ä¹‹å‰ï¼Œä»è€Œç ´åäº†è¿™ä¸ª lock çš„ä¿è¯ã€‚</li>\n<li>å³ä¾¿ç¼–è¯‘å™¨ä¸åšä¹±åºå¤„ç†ï¼ŒCPU ä¹Ÿä¼šæœ€å¤§ç¨‹åº¦åšæŒ‡ä»¤çš„ä¹±åºæ‰§è¡Œï¼Œè®©æµæ°´çº¿çš„æ•ˆç‡æœ€é«˜ã€‚åŒæ ·ä¼šå‘ç”Ÿ 3 çš„é—®é¢˜ã€‚</li>\n</ol><p>æ‰€ä»¥ï¼Œæˆ‘ä»¬å®ç°è¿™ä¸ªé”çš„è¡Œä¸ºæ˜¯æœªå®šä¹‰çš„ã€‚å¯èƒ½å¤§éƒ¨åˆ†æ—¶é—´å¦‚æˆ‘ä»¬æ‰€æ„¿ï¼Œä½†ä¼šéšæœºå‡ºç°å¥‡å¥‡æ€ªæ€ªçš„è¡Œä¸ºã€‚ä¸€æ—¦è¿™æ ·çš„äº‹æƒ…å‘ç”Ÿï¼Œbug å¯èƒ½ä¼šä»¥å„ç§ä¸åŒçš„é¢è²Œå‡ºç°åœ¨ç³»ç»Ÿçš„å„ä¸ªè§’è½ã€‚è€Œä¸”ï¼Œè¿™æ ·çš„ bug å‡ ä¹æ˜¯æ— è§£çš„ï¼Œå› ä¸ºå®ƒå¾ˆéš¾ç¨³å®šå¤ç°ï¼Œè¡¨ç°è¡Œä¸ºå¾ˆä¸ä¸€è‡´ï¼Œç”šè‡³ï¼Œåªåœ¨æŸä¸ª CPU ä¸‹å‡ºç°ã€‚</p><p>è¿™é‡Œå†å¼ºè°ƒä¸€ä¸‹ unsafe ä»£ç éœ€è¦è¶³å¤Ÿä¸¥è°¨ï¼Œéœ€è¦éå¸¸æœ‰ç»éªŒçš„å·¥ç¨‹å¸ˆå»å®¡æŸ¥ï¼Œè¿™æ®µä»£ç ä¹‹æ‰€ä»¥ç ´å¿«äº†å¹¶å‘å®‰å…¨æ€§ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬é”™è¯¯åœ°è®¤ä¸ºï¼šä¸º Lock&lt;T&gt; å®ç° Syncï¼Œæ˜¯å®‰å…¨çš„ã€‚</p><p>ä¸ºäº†è§£å†³ä¸Šé¢è¿™æ®µä»£ç çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨ CPU å±‚é¢åšä¸€äº›ä¿è¯ï¼Œè®©æŸäº›æ“ä½œæˆä¸ºåŸå­æ“ä½œã€‚</p><p>æœ€åŸºç¡€çš„ä¿è¯æ˜¯ï¼š<strong>å¯ä»¥é€šè¿‡ä¸€æ¡æŒ‡ä»¤è¯»å–æŸä¸ªå†…å­˜åœ°å€ï¼Œåˆ¤æ–­å…¶å€¼æ˜¯å¦ç­‰äºæŸä¸ªå‰ç½®å€¼ï¼Œå¦‚æœç›¸ç­‰ï¼Œå°†å…¶ä¿®æ”¹ä¸ºæ–°çš„å€¼ã€‚è¿™å°±æ˜¯ Compare-and-swap æ“ä½œï¼Œç®€ç§°</strong><a href=\"https://en.wikipedia.org/wiki/Compare-and-swap\">CAS</a>ã€‚å®ƒæ˜¯æ“ä½œç³»ç»Ÿçš„å‡ ä¹æ‰€æœ‰å¹¶å‘åŸè¯­çš„åŸºçŸ³ï¼Œä½¿å¾—æˆ‘ä»¬èƒ½å®ç°ä¸€ä¸ªå¯ä»¥æ­£å¸¸å·¥ä½œçš„é”ã€‚</p><p>æ‰€ä»¥ï¼Œåˆšæ‰çš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠä¸€å¼€å§‹çš„å¾ªç¯æ”¹æˆï¼š</p><pre><code class=\"language-rust\">while self\n\t.locked\n\t.compare_exchange(false, true, Ordering::Acquire, Ordering::Relaxed)\n\t.is_err() {}\n</code></pre><p>è¿™å¥çš„æ„æ€æ˜¯ï¼šå¦‚æœ locked å½“å‰çš„å€¼æ˜¯ <code>false</code>ï¼Œå°±å°†å…¶æ”¹æˆ <code>true</code>ã€‚è¿™æ•´ä¸ªæ“ä½œåœ¨ä¸€æ¡æŒ‡ä»¤é‡Œå®Œæˆï¼Œä¸ä¼šè¢«å…¶å®ƒçº¿ç¨‹æ‰“æ–­æˆ–è€…ä¿®æ”¹ï¼›å¦‚æœ locked çš„å½“å‰å€¼ä¸æ˜¯ <code>false</code>ï¼Œé‚£ä¹ˆå°±ä¼šè¿”å›é”™è¯¯ï¼Œæˆ‘ä»¬ä¼šåœ¨æ­¤ä¸åœ spinï¼Œç›´åˆ°å‰ç½®æ¡ä»¶å¾—åˆ°æ»¡è¶³ã€‚è¿™é‡Œï¼Œ<code>compare_exchange</code> æ˜¯ Rust æä¾›çš„ CAS æ“ä½œï¼Œå®ƒä¼šè¢«ç¼–è¯‘æˆ CPU çš„å¯¹åº” CAS æŒ‡ä»¤ã€‚</p><p>å½“è¿™å¥æ‰§è¡ŒæˆåŠŸåï¼Œlocked å¿…ç„¶ä¼šè¢«æ”¹å˜ä¸º <code>true</code>ï¼Œæˆ‘ä»¬æˆåŠŸæ‹¿åˆ°äº†é”ï¼Œè€Œä»»ä½•å…¶ä»–çº¿ç¨‹éƒ½ä¼šåœ¨è¿™å¥è¯ä¸Š spinã€‚</p><p>åŒæ ·åœ¨é‡Šæ”¾é”çš„æ—¶å€™ï¼Œç›¸åº”åœ°éœ€è¦ä½¿ç”¨ atomic çš„ç‰ˆæœ¬ï¼Œè€Œéç›´æ¥èµ‹å€¼æˆ <code>false</code>ï¼š</p><pre><code class=\"language-rust\">self.locked.store(false, Ordering::Release);\n</code></pre><p>å½“ç„¶ï¼Œä¸ºäº†é…åˆè¿™æ ·çš„æ”¹åŠ¨ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æŠŠ locked ä» <code>bool</code> æ”¹æˆ <code>AtomicBool</code>ã€‚åœ¨ Rusté‡Œï¼Œ<code>std::sync::atomic</code> æœ‰å¤§é‡çš„ atomic æ•°æ®ç»“æ„ï¼Œå¯¹åº”å„ç§åŸºç¡€ç»“æ„ã€‚æˆ‘ä»¬çœ‹ä½¿ç”¨äº† AtomicBool çš„æ–°å®ç°ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=9636a125b2104ab203fb6a9d536f3cf6\">ä»£ç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">use std::{\n    cell::RefCell,\n    fmt,\n    sync::{\n        atomic::{AtomicBool, Ordering},\n        Arc,\n    },\n    thread,\n};\n\nstruct Lock&lt;T&gt; {\n    locked: AtomicBool,\n    data: RefCell&lt;T&gt;,\n}\n\nimpl&lt;T&gt; fmt::Debug for Lock&lt;T&gt;\nwhere\n    T: fmt::Debug,\n{\n    fn fmt(&amp;self, f: &amp;mut fmt::Formatter&lt;'_&gt;) -&gt; fmt::Result {\n        write!(f, \"Lock&lt;{:?}&gt;\", self.data.borrow())\n    }\n}\n\n// SAFETY: æˆ‘ä»¬ç¡®ä¿¡ Lock&lt;T&gt; å¾ˆå®‰å…¨ï¼Œå¯ä»¥åœ¨å¤šä¸ªçº¿ç¨‹ä¸­å…±äº«\nunsafe impl&lt;T&gt; Sync for Lock&lt;T&gt; {}\n\nimpl&lt;T&gt; Lock&lt;T&gt; {\n    pub fn new(data: T) -&gt; Self {\n        Self {\n            data: RefCell::new(data),\n            locked: AtomicBool::new(false),\n        }\n    }\n\n    pub fn lock(&amp;self, op: impl FnOnce(&amp;mut T)) {\n        // å¦‚æœæ²¡æ‹¿åˆ°é”ï¼Œå°±ä¸€ç›´ spin\n        while self\n            .locked\n            .compare_exchange(false, true, Ordering::Acquire, Ordering::Relaxed)\n            .is_err()\n        {} // **1\n\n        // å·²ç»æ‹¿åˆ°å¹¶åŠ é”ï¼Œå¼€å§‹å¹²æ´»\n        op(&amp;mut self.data.borrow_mut()); // **3\n\n        // è§£é”\n        self.locked.store(false, Ordering::Release);\n    }\n}\n\nfn main() {\n    let data = Arc::new(Lock::new(0));\n\n    let data1 = data.clone();\n    let t1 = thread::spawn(move || {\n        data1.lock(|v| *v += 10);\n    });\n\n    let data2 = data.clone();\n    let t2 = thread::spawn(move || {\n        data2.lock(|v| *v *= 10);\n    });\n    t1.join().unwrap();\n    t2.join().unwrap();\n\n    println!(\"data: {:?}\", data);\n}\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡ä½¿ç”¨ <code>compare_exchange</code> ï¼Œè§„é¿äº† 1 å’Œ 2 é¢ä¸´çš„é—®é¢˜ï¼Œä½†å¯¹äºå’Œç¼–è¯‘å™¨/CPUè‡ªåŠ¨ä¼˜åŒ–ç›¸å…³çš„ 3 å’Œ 4ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€äº›é¢å¤–å¤„ç†ã€‚è¿™å°±æ˜¯è¿™ä¸ªå‡½æ•°é‡Œé¢å¤–çš„ä¸¤ä¸ªå’Œ <code>Ordering</code> æœ‰å…³çš„å¥‡æ€ªå‚æ•°ã€‚</p><p>å¦‚æœä½ æŸ¥çœ‹ atomic çš„æ–‡æ¡£ï¼Œå¯ä»¥çœ‹åˆ° <a href=\"https://doc.rust-lang.org/std/sync/atomic/enum.Ordering.html\">Ordering</a> æ˜¯ä¸€ä¸ª enumï¼š</p><pre><code class=\"language-rust\">pub enum Ordering {\n    Relaxed,\n    Release,\n    Acquire,\n    AcqRel,\n    SeqCst,\n}\n</code></pre><p>æ–‡æ¡£é‡Œè§£é‡Šäº†å‡ ç§ Ordering çš„ç”¨é€”ï¼Œæˆ‘æ¥ç¨ç¨æ‰©å±•ä¸€ä¸‹ã€‚</p><p>ç¬¬ä¸€ä¸ªRelaxedï¼Œè¿™æ˜¯æœ€å®½æ¾çš„è§„åˆ™ï¼Œå®ƒå¯¹ç¼–è¯‘å™¨å’Œ CPU ä¸åšä»»ä½•é™åˆ¶ï¼Œå¯ä»¥ä¹±åºæ‰§è¡Œã€‚</p><p>Releaseï¼Œå½“æˆ‘ä»¬<strong>å†™å…¥æ•°æ®</strong>ï¼ˆæ¯”å¦‚ä¸Šé¢ä»£ç é‡Œçš„ storeï¼‰çš„æ—¶å€™ï¼Œå¦‚æœç”¨äº† <code>Release</code> orderï¼Œé‚£ä¹ˆï¼š</p><ul>\n<li>å¯¹äºå½“å‰çº¿ç¨‹ï¼Œä»»ä½•è¯»å–æˆ–å†™å…¥æ“ä½œéƒ½ä¸èƒ½è¢«ä¹±åºæ’åœ¨è¿™ä¸ª store <strong>ä¹‹å</strong>ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ä¸Šé¢çš„ä¾‹å­é‡Œï¼ŒCPU æˆ–è€…ç¼–è¯‘å™¨ä¸èƒ½æŠŠ <code>**3</code> æŒªåˆ° <code>**4</code> ä¹‹åæ‰§è¡Œã€‚</li>\n<li>å¯¹äºå…¶å®ƒçº¿ç¨‹ï¼Œå¦‚æœä½¿ç”¨äº† <code>Acquire</code> æ¥è¯»å–è¿™ä¸ª atomic çš„æ•°æ®ï¼Œ é‚£ä¹ˆå®ƒä»¬çœ‹åˆ°çš„æ˜¯ä¿®æ”¹åçš„ç»“æœã€‚ä¸Šé¢ä»£ç æˆ‘ä»¬åœ¨ <code>compare_exchange</code> é‡Œä½¿ç”¨äº† <code>Acquire</code> æ¥è¯»å–ï¼Œæ‰€ä»¥èƒ½ä¿è¯è¯»åˆ°æœ€æ–°çš„å€¼ã€‚</li>\n</ul><p>è€ŒAcquireæ˜¯å½“æˆ‘ä»¬<strong>è¯»å–æ•°æ®</strong>çš„æ—¶å€™ï¼Œå¦‚æœç”¨äº† <code>Acquire</code> orderï¼Œé‚£ä¹ˆï¼š</p><ul>\n<li>å¯¹äºå½“å‰çº¿ç¨‹ï¼Œä»»ä½•è¯»å–æˆ–è€…å†™å…¥æ“ä½œéƒ½ä¸èƒ½è¢«ä¹±åºæ’åœ¨è¿™ä¸ªè¯»å–<strong>ä¹‹å‰</strong>ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­é‡Œï¼ŒCPU æˆ–è€…ç¼–è¯‘å™¨ä¸èƒ½æŠŠ <code>**3</code> æŒªåˆ° <code>**1</code> ä¹‹å‰æ‰§è¡Œã€‚</li>\n<li>å¯¹äºå…¶å®ƒçº¿ç¨‹ï¼Œå¦‚æœä½¿ç”¨äº† <code>Release</code> æ¥ä¿®æ”¹æ•°æ®ï¼Œé‚£ä¹ˆï¼Œä¿®æ”¹çš„å€¼å¯¹å½“å‰çº¿ç¨‹å¯è§ã€‚</li>\n</ul><p>ç¬¬å››ä¸ªAcqRelæ˜¯Acquire å’Œ Release çš„ç»“åˆï¼ŒåŒæ—¶æ‹¥æœ‰ Acquire å’Œ Release çš„ä¿è¯ã€‚è¿™ä¸ªä¸€èˆ¬ç”¨åœ¨ <code>fetch_xxx</code> ä¸Šï¼Œæ¯”å¦‚ä½ è¦å¯¹ä¸€ä¸ª atomic è‡ªå¢ 1ï¼Œä½ å¸Œæœ›è¿™ä¸ªæ“ä½œä¹‹å‰å’Œä¹‹åçš„è¯»å–æˆ–å†™å…¥æ“ä½œä¸ä¼šè¢«ä¹±åºï¼Œå¹¶ä¸”æ“ä½œçš„ç»“æœå¯¹å…¶å®ƒçº¿ç¨‹å¯è§ã€‚</p><p>æœ€åçš„SeqCstæ˜¯æœ€ä¸¥æ ¼çš„ orderingï¼Œé™¤äº† <code>AcqRel</code> çš„ä¿è¯å¤–ï¼Œå®ƒè¿˜ä¿è¯æ‰€æœ‰çº¿ç¨‹çœ‹åˆ°çš„æ‰€æœ‰ <code>SeqCst</code> æ“ä½œçš„é¡ºåºæ˜¯ä¸€è‡´çš„ã€‚</p><p><strong>å› ä¸º CAS å’Œ ordering éƒ½æ˜¯ç³»ç»Ÿçº§çš„æ“ä½œï¼Œæ‰€ä»¥è¿™é‡Œæè¿°çš„ Ordering çš„ç”¨é€”åœ¨å„ç§è¯­è¨€ä¸­éƒ½å¤§åŒå°å¼‚</strong>ã€‚å¯¹äº Rust æ¥è¯´ï¼Œå®ƒçš„ atomic åŸè¯­<a href=\"https://en.cppreference.com/w/cpp/atomic/memory_order\">ç»§æ‰¿äº C++</a>ã€‚å¦‚æœè¯» Rust çš„æ–‡æ¡£ä½ æ„Ÿè§‰äº‘é‡Œé›¾é‡Œï¼Œé‚£ä¹ˆ C++ å…³äº ordering çš„æ–‡æ¡£è¦æ¸…æ™°å¾—å¤šã€‚</p><p>å…¶å®ä¸Šé¢è·å–é”çš„ spin è¿‡ç¨‹æ€§èƒ½ä¸å¤Ÿå¥½ï¼Œæ›´å¥½çš„æ–¹å¼æ˜¯è¿™æ ·å¤„ç†ä¸€ä¸‹ï¼š</p><pre><code class=\"language-rust\">while self\n    .locked\n    .compare_exchange(false, true, Ordering::Acquire, Ordering::Relaxed)\n    .is_err()\n{\n    // æ€§èƒ½ä¼˜åŒ–ï¼šcompare_exchange éœ€è¦ç‹¬å è®¿é—®ï¼Œå½“æ‹¿ä¸åˆ°é”æ—¶ï¼Œæˆ‘ä»¬\n    // å…ˆä¸åœæ£€æµ‹ locked çš„çŠ¶æ€ï¼Œç›´åˆ°å…¶ unlocked åï¼Œå†å°è¯•æ‹¿é”\n    while self.locked.load(Ordering::Relaxed) == true {}\n}\n</code></pre><p>æ³¨æ„ï¼Œæˆ‘ä»¬åœ¨ while loop é‡Œï¼ŒåˆåµŒå…¥äº†ä¸€ä¸ª loopã€‚è¿™æ˜¯å› ä¸º CAS æ˜¯ä¸ªä»£ä»·æ¯”è¾ƒé«˜çš„æ“ä½œï¼Œå®ƒéœ€è¦è·å¾—å¯¹åº”å†…å­˜çš„ç‹¬å è®¿é—®ï¼ˆexclusive accessï¼‰ï¼Œæˆ‘ä»¬å¸Œæœ›å¤±è´¥çš„æ—¶å€™åªæ˜¯ç®€å•è¯»å– atomic çš„çŠ¶æ€ï¼Œåªæœ‰ç¬¦åˆæ¡ä»¶çš„æ—¶å€™å†å»åšç‹¬å è®¿é—®ï¼Œè¿›è¡Œ CASã€‚æ‰€ä»¥ï¼Œçœ‹ä¸Šå»å¤šåšäº†ä¸€å±‚å¾ªç¯ï¼Œå®é™…ä»£ç çš„æ•ˆç‡æ›´é«˜ã€‚</p><p>ä»¥ä¸‹æ˜¯ä¸¤ä¸ªçº¿ç¨‹åŒæ­¥çš„è¿‡ç¨‹ï¼Œä¸€å¼€å§‹ t1 æ‹¿åˆ°é”ã€t2 spinï¼Œä¹‹å t1 é‡Šæ”¾é”ã€t2 è¿›å…¥åˆ°ä¸´ç•ŒåŒºæ‰§è¡Œï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/5f/62/5fc2678a12c993768365851fe5531662.jpg?wh=2364x1625\" alt=\"\"></p><p>è®²åˆ°è¿™é‡Œï¼Œç›¸ä¿¡ä½ å¯¹ atomic ä»¥åŠå…¶èƒŒåçš„ CAS æœ‰åˆæ­¥çš„äº†è§£äº†ã€‚é‚£ä¹ˆï¼Œatomic é™¤äº†åšå…¶å®ƒå¹¶å‘åŸè¯­ï¼Œè¿˜æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ</p><p>æˆ‘ä¸ªäººç”¨çš„æœ€å¤šçš„æ˜¯åšå„ç§ lock-free çš„æ•°æ®ç»“æ„ã€‚æ¯”å¦‚ï¼Œéœ€è¦ä¸€ä¸ªå…¨å±€çš„ ID ç”Ÿæˆå™¨ã€‚å½“ç„¶å¯ä»¥ä½¿ç”¨ UUID è¿™æ ·çš„æ¨¡å—æ¥ç”Ÿæˆå”¯ä¸€çš„ IDï¼Œä½†å¦‚æœæˆ‘ä»¬åŒæ—¶éœ€è¦è¿™ä¸ª ID æ˜¯æœ‰åºçš„ï¼Œé‚£ä¹ˆ <code>AtomicUsize</code> å°±æ˜¯æœ€å¥½çš„é€‰æ‹©ã€‚</p><p>ä½ å¯ä»¥ç”¨ <code>fetch_add</code> æ¥å¢åŠ è¿™ä¸ª IDï¼Œè€Œ <code>fetch_add</code> è¿”å›çš„ç»“æœå°±å¯ä»¥ç”¨äºå½“å‰çš„ IDã€‚è¿™æ ·ï¼Œä¸éœ€è¦åŠ é”ï¼Œå°±å¾—åˆ°äº†ä¸€ä¸ªå¯ä»¥åœ¨å¤šçº¿ç¨‹ä¸­å®‰å…¨ä½¿ç”¨çš„ ID ç”Ÿæˆå™¨ã€‚</p><p>å¦å¤–ï¼Œatomic è¿˜å¯ä»¥ç”¨äºè®°å½•ç³»ç»Ÿçš„å„ç§ metricsã€‚æ¯”å¦‚ä¸€ä¸ªç®€å•çš„ in-memory Metrics æ¨¡å—ï¼š</p><pre><code class=\"language-rust\">use std::{\n    collections::HashMap,\n    sync::atomic::{AtomicUsize, Ordering},\n};\n\n// server statistics\npub struct Metrics(HashMap&lt;&amp;'static str, AtomicUsize&gt;);\n\nimpl Metrics {\n    pub fn new(names: &amp;[&amp;'static str]) -&gt; Self {\n        let mut metrics: HashMap&lt;&amp;'static str, AtomicUsize&gt; = HashMap::new();\n        for name in names.iter() {\n            metrics.insert(name, AtomicUsize::new(0));\n        }\n        Self(metrics)\n    }\n\n    pub fn inc(&amp;self, name: &amp;'static str) {\n        if let Some(m) = self.0.get(name) {\n            m.fetch_add(1, Ordering::Relaxed);\n        }\n    }\n\n    pub fn add(&amp;self, name: &amp;'static str, val: usize) {\n        if let Some(m) = self.0.get(name) {\n            m.fetch_add(val, Ordering::Relaxed);\n        }\n    }\n\n    pub fn dec(&amp;self, name: &amp;'static str) {\n        if let Some(m) = self.0.get(name) {\n            m.fetch_sub(1, Ordering::Relaxed);\n        }\n    }\n\n    pub fn snapshot(&amp;self) -&gt; Vec&lt;(&amp;'static str, usize)&gt; {\n        self.0\n            .iter()\n            .map(|(k, v)| (*k, v.load(Ordering::Relaxed)))\n            .collect()\n    }\n}\n</code></pre><p>å®ƒå…è®¸ä½ åˆå§‹åŒ–ä¸€ä¸ªå…¨å±€çš„ metrics è¡¨ï¼Œç„¶ååœ¨ç¨‹åºçš„ä»»ä½•åœ°æ–¹ï¼Œæ— é”åœ°æ“ä½œç›¸åº”çš„ metricsï¼š</p><pre><code class=\"language-rust\">lazy_static! {\n    pub(crate) static ref METRICS: Metrics = Metrics::new(&amp;[\n        \"topics\",\n        \"clients\",\n        \"peers\",\n        \"broadcasts\",\n        \"servers\",\n        \"states\",\n        \"subscribers\"\n    ]);\n}\n\nfn main() {\n    METRICS.inc(\"topics\");\n    METRICS.inc(\"subscribers\");\n\n    println!(\"{:?}\", METRICS.snapshot());\n}\n</code></pre><p>å®Œæ•´ä»£ç è§ <a href=\"https://github.com/tyrchen/geektime-rust\">GitHub repo</a> æˆ–è€… <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=5299292be00c8e897360e1b05387670e\">playground</a>ã€‚</p><h2>Mutex</h2><p>Atomic è™½ç„¶å¯ä»¥å¤„ç†è‡ªç”±ç«äº‰æ¨¡å¼ä¸‹åŠ é”çš„éœ€æ±‚ï¼Œä½†æ¯•ç«Ÿç”¨èµ·æ¥ä¸é‚£ä¹ˆæ–¹ä¾¿ï¼Œæˆ‘ä»¬éœ€è¦æ›´é«˜å±‚çš„å¹¶å‘åŸè¯­ï¼Œæ¥ä¿è¯è½¯ä»¶ç³»ç»Ÿæ§åˆ¶å¤šä¸ªçº¿ç¨‹å¯¹åŒä¸€ä¸ªå…±äº«èµ„æºçš„è®¿é—®ï¼Œä½¿å¾—æ¯ä¸ªçº¿ç¨‹åœ¨è®¿é—®å…±äº«èµ„æºçš„æ—¶å€™ï¼Œå¯ä»¥ç‹¬å æˆ–è€…è¯´äº’æ–¥è®¿é—®ï¼ˆmutual exclusive accessï¼‰ã€‚</p><p>æˆ‘ä»¬çŸ¥é“ï¼Œå¯¹äºä¸€ä¸ªå…±äº«èµ„æºï¼Œå¦‚æœæ‰€æœ‰çº¿ç¨‹åªåšè¯»æ“ä½œï¼Œé‚£ä¹ˆæ— éœ€äº’æ–¥ï¼Œå¤§å®¶éšæ—¶å¯ä»¥è®¿é—®ï¼Œå¾ˆå¤š immutable languageï¼ˆå¦‚ Erlang / Elixirï¼‰åšäº†è¯­è¨€å±‚é¢çš„åªè¯»ä¿è¯ï¼Œç¡®ä¿äº†å¹¶å‘ç¯å¢ƒä¸‹çš„æ— é”æ“ä½œã€‚è¿™ç‰ºç‰²äº†ä¸€äº›æ•ˆç‡ï¼ˆå¸¸è§çš„ list/hashmap éœ€è¦ä½¿ç”¨ <a href=\"https://en.wikipedia.org/wiki/Persistent_data_structure\">persistent data structure</a>ï¼‰ï¼Œé¢å¤–åšäº†ä¸å°‘å†…å­˜æ‹·è´ï¼Œæ¢æ¥äº†å¹¶å‘æ§åˆ¶ä¸‹çš„ç®€å•è½»çµã€‚</p><p>ç„¶è€Œï¼Œ<strong>ä¸€æ—¦æœ‰ä»»ä½•ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹è¦ä¿®æ”¹å…±äº«èµ„æºï¼Œä¸ä½†å†™è€…ä¹‹é—´è¦äº’æ–¥ï¼Œè¯»å†™ä¹‹é—´ä¹Ÿéœ€è¦äº’æ–¥</strong>ã€‚æ¯•ç«Ÿå¦‚æœè¯»å†™ä¹‹é—´ä¸äº’æ–¥çš„è¯ï¼Œè¯»è€…è½»åˆ™è¯»åˆ°è„æ•°æ®ï¼Œé‡åˆ™ä¼šè¯»åˆ°å·²ç»è¢«ç ´åçš„æ•°æ®ï¼Œå¯¼è‡´ crashã€‚æ¯”å¦‚è¯»è€…è¯»åˆ°é“¾è¡¨é‡Œçš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè€Œå†™è€…æ°å·§æŠŠè¿™ä¸ªèŠ‚ç‚¹çš„å†…å­˜é‡Šæ”¾æ‰äº†ï¼Œå¦‚æœä¸åšäº’æ–¥è®¿é—®ï¼Œç³»ç»Ÿä¸€å®šä¼šå´©æºƒã€‚</p><p>æ‰€ä»¥æ“ä½œç³»ç»Ÿæä¾›äº†ç”¨æ¥è§£å†³è¿™ç§è¯»å†™äº’æ–¥é—®é¢˜çš„åŸºæœ¬å·¥å…·ï¼šMutexï¼ˆRwLock æˆ‘ä»¬æ”¾ä¸‹ä¸è¡¨ï¼‰ã€‚</p><p>å…¶å®ä¸Šæ–‡ä¸­ï¼Œä¸ºäº†å±•ç¤ºå¦‚ä½•ä½¿ç”¨ atomicï¼Œæˆ‘ä»¬åˆ¶ä½œäº†ä¸€ä¸ªéå¸¸ç²—ç³™ç®€å•çš„ SpinLockï¼Œå°±å¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªå¹¿ä¹‰çš„ Mutexã€‚<strong>SpinLock</strong>ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯çº¿ç¨‹é€šè¿‡ CPU ç©ºè½¬ï¼ˆspinï¼Œå°±åƒå‰é¢çš„ while loopï¼‰å¿™ç­‰ï¼ˆbusy waitï¼‰ï¼Œæ¥ç­‰å¾…æŸä¸ªä¸´ç•ŒåŒºå¯ç”¨çš„ä¸€ç§é”ã€‚</p><p>ç„¶è€Œï¼Œè¿™ç§é€šè¿‡ SpinLock åšäº’æ–¥çš„å®ç°æ–¹å¼æœ‰ä½¿ç”¨åœºæ™¯çš„é™åˆ¶ï¼šå¦‚æœå—ä¿æŠ¤çš„ä¸´ç•ŒåŒºå¤ªå¤§ï¼Œé‚£ä¹ˆæ•´ä½“çš„æ€§èƒ½ä¼šæ€¥å‰§ä¸‹é™ï¼Œ CPU å¿™ç­‰ï¼Œæµªè´¹èµ„æºè¿˜ä¸å¹²å®äº‹ï¼Œä¸é€‚åˆä½œä¸ºä¸€ç§é€šç”¨çš„å¤„ç†æ–¹æ³•ã€‚</p><p>æ›´é€šç”¨çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼šå½“å¤šä¸ªçº¿ç¨‹ç«äº‰åŒä¸€ä¸ª Mutex æ—¶ï¼Œè·å¾—é”çš„çº¿ç¨‹å¾—åˆ°ä¸´ç•ŒåŒºçš„è®¿é—®ï¼Œå…¶å®ƒçº¿ç¨‹è¢«æŒ‚èµ·ï¼Œæ”¾å…¥è¯¥ Mutex ä¸Šçš„ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—é‡Œã€‚<strong>å½“è·å¾—é”çš„çº¿ç¨‹å®Œæˆå·¥ä½œï¼Œé€€å‡ºä¸´ç•ŒåŒºæ—¶ï¼ŒMutex ä¼šç»™ç­‰å¾…é˜Ÿåˆ—å‘ä¸€ä¸ªä¿¡å·ï¼ŒæŠŠé˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªçº¿ç¨‹å”¤é†’</strong>ï¼Œäºæ˜¯è¿™ä¸ªçº¿ç¨‹å¯ä»¥è¿›è¡Œåç»­çš„è®¿é—®ã€‚æ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹ï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/54/dc/54caee8ebf240e2812da0022cb099bdc.jpg?wh=2364x1142\" alt=\"\"></p><p>æˆ‘ä»¬å‰é¢ä¹Ÿè®²è¿‡ï¼Œçº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ä»£ä»·å¾ˆå¤§ï¼Œæ‰€ä»¥é¢‘ç¹å°†çº¿ç¨‹æŒ‚èµ·å†å”¤é†’ï¼Œä¼šé™ä½æ•´ä¸ªç³»ç»Ÿçš„æ•ˆç‡ã€‚æ‰€ä»¥å¾ˆå¤š Mutex å…·ä½“çš„å®ç°ä¼šå°† SpinLockï¼ˆç¡®åˆ‡åœ°è¯´æ˜¯ spin waitï¼‰å’Œçº¿ç¨‹æŒ‚èµ·ç»“åˆä½¿ç”¨ï¼š<strong>çº¿ç¨‹çš„ lock è¯·æ±‚å¦‚æœæ‹¿ä¸åˆ°ä¼šå…ˆå°è¯• spin ä¸€ä¼šï¼Œç„¶åå†æŒ‚èµ·æ·»åŠ åˆ°ç­‰å¾…é˜Ÿåˆ—</strong>ã€‚Rust ä¸‹çš„ <a href=\"https://github.com/Amanieu/parking_lot\">parking_lot</a> å°±æ˜¯è¿™æ ·å®ç°çš„ã€‚</p><p>å½“ç„¶ï¼Œè¿™æ ·å®ç°ä¼šå¸¦æ¥å…¬å¹³æ€§çš„é—®é¢˜ï¼šå¦‚æœæ–°æ¥çš„çº¿ç¨‹æ°å·§åœ¨ spin è¿‡ç¨‹ä¸­æ‹¿åˆ°äº†é”ï¼Œè€Œå½“å‰ç­‰å¾…é˜Ÿåˆ—ä¸­è¿˜æœ‰å…¶å®ƒçº¿ç¨‹åœ¨ç­‰å¾…é”ï¼Œé‚£ä¹ˆç­‰å¾…çš„çº¿ç¨‹åªèƒ½ç»§ç»­ç­‰å¾…ä¸‹å»ï¼Œè¿™ä¸ç¬¦åˆ FIFOï¼Œä¸é€‚åˆé‚£äº›éœ€è¦ä¸¥æ ¼æŒ‰å…ˆæ¥ååˆ°æ’é˜Ÿçš„ä½¿ç”¨åœºæ™¯ã€‚ä¸ºæ­¤ï¼Œparking_lot æä¾›äº† fair mutexã€‚</p><p>Mutex çš„å®ç°ä¾èµ–äº CPU æä¾›çš„ atomicã€‚ä½ å¯ä»¥æŠŠ Mutex æƒ³è±¡æˆä¸€ä¸ªç²’åº¦æ›´å¤§çš„ atomicï¼Œåªä¸è¿‡è¿™ä¸ª atomic æ— æ³•ç”± CPU ä¿è¯ï¼Œè€Œæ˜¯é€šè¿‡è½¯ä»¶ç®—æ³•æ¥å®ç°ã€‚</p><p>è‡³äºæ“ä½œç³»ç»Ÿé‡Œå¦ä¸€ä¸ªé‡è¦çš„æ¦‚å¿µä¿¡å·é‡ï¼ˆsemaphoreï¼‰ï¼Œä½ å¯ä»¥è®¤ä¸ºæ˜¯ Mutex æ›´é€šç”¨çš„è¡¨ç°å½¢å¼ã€‚æ¯”å¦‚åœ¨æ–°å† ç–«æƒ…ä¸‹ï¼Œå›¾ä¹¦é¦†è¦æ§åˆ¶åŒæ—¶åœ¨é¦†å†…çš„äººæ•°ï¼Œå¦‚æœæ»¡äº†ï¼Œå…¶ä»–äººå°±å¿…é¡»æ’é˜Ÿï¼Œå‡ºæ¥ä¸€ä¸ªæ‰èƒ½å†è¿›ä¸€ä¸ªã€‚è¿™é‡Œï¼Œå¦‚æœæ€»äººæ•°é™åˆ¶ä¸º 1ï¼Œå°±æ˜¯ Mutexï¼Œå¦‚æœ &gt; 1ï¼Œå°±æ˜¯ semaphoreã€‚</p><h2>å°ç»“</h2><p>ä»Šå¤©æˆ‘ä»¬å­¦ä¹ äº†ä¸¤ä¸ªåŸºæœ¬çš„å¹¶å‘åŸè¯­ Atomic å’Œ Mutexã€‚Atomic æ˜¯ä¸€åˆ‡å¹¶å‘åŒæ­¥çš„åŸºç¡€ï¼Œé€šè¿‡CPU æä¾›ç‰¹æ®Šçš„ CAS æŒ‡ä»¤ï¼Œæ“ä½œç³»ç»Ÿå’Œåº”ç”¨è½¯ä»¶å¯ä»¥æ„å»ºæ›´åŠ é«˜å±‚çš„å¹¶å‘åŸè¯­ï¼Œæ¯”å¦‚ SpinLock å’Œ Mutexã€‚</p><p>SpinLockå’Œ Mutex æœ€å¤§çš„ä¸åŒæ˜¯ï¼Œ<strong>ä½¿ç”¨ SpinLockï¼Œçº¿ç¨‹åœ¨å¿™ç­‰ï¼ˆbusy waitï¼‰ï¼Œè€Œä½¿ç”¨ Mutex lockï¼Œçº¿ç¨‹åœ¨ç­‰å¾…é”çš„æ—¶å€™ä¼šè¢«è°ƒåº¦å‡ºå»ï¼Œç­‰é”å¯ç”¨æ—¶å†è¢«è°ƒåº¦å›æ¥</strong>ã€‚</p><p>å¬ä¸Šå» SpinLock ä¼¼ä¹æ•ˆç‡å¾ˆä½ï¼Œå…¶å®ä¸æ˜¯ï¼Œè¿™è¦å…·ä½“çœ‹é”çš„ä¸´ç•ŒåŒºå¤§å°ã€‚å¦‚æœä¸´ç•ŒåŒºè¦æ‰§è¡Œçš„ä»£ç å¾ˆå°‘ï¼Œé‚£ä¹ˆå’Œ Mutex lock å¸¦æ¥çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆcontext switchï¼‰ç›¸æ¯”ï¼ŒSpinLock æ˜¯å€¼å¾—çš„ã€‚åœ¨ Linux Kernel ä¸­ï¼Œå¾ˆå¤šæ—¶å€™æˆ‘ä»¬åªèƒ½ä½¿ç”¨ SpinLockã€‚</p><h3>æ€è€ƒé¢˜</h3><p>ä½ å¯ä»¥æƒ³æƒ³å¯ä»¥æ€ä¹ˆå®ç° semaphoreï¼Œä¹Ÿå¯ä»¥æƒ³æƒ³åƒå›¾ä¹¦é¦†é‡Œé‚£æ ·çš„äººæ•°æ§åˆ¶ç³»ç»Ÿæ€ä¹ˆç”¨ä¿¡å·é‡å®ç°ï¼ˆæç¤ºï¼šRust ä¸‹ tokio æä¾›äº† <a href=\"https://docs.rs/tokio/1.13.0/tokio/sync/struct.Semaphore.html\">tokio::sync::Semaphore</a>ï¼‰ã€‚</p><p>æ¬¢è¿åœ¨ç•™è¨€åŒºåˆ†äº«ä½ çš„æ€è€ƒï¼Œæ„Ÿè°¢ä½ çš„é˜…è¯»ã€‚ä¸‹ä¸€è®²æˆ‘ä»¬ç»§ç»­å­¦ä¹ å¹¶å‘çš„å¦å¤–ä¸‰ä¸ªæ¦‚å¿µCondvarã€Channel å’Œ Actor modelï¼Œä¸‹ä¸€è®²è§ï½</p><h3>å‚è€ƒèµ„æ–™</h3><ol>\n<li>Robe Pikeçš„æ¼”è®² <a href=\"https://go.dev/blog/waza-talk\">concurrency is not parallelism</a>ï¼Œå¦‚æœä½ æ²¡æœ‰çœ‹è¿‡ï¼Œå»ºè®®å»çœ‹çœ‹ã€‚</li>\n<li>é€šè¿‡ä»Šå¤©çš„ä¾‹å­ï¼Œç›¸ä¿¡ä½ å¯¹ atomic ä»¥åŠå…¶èƒŒåçš„ CAS æœ‰ä¸ªåˆæ­¥çš„äº†è§£ï¼Œå¦‚æœä½ è¿˜æƒ³æ›´æ·±å…¥å­¦ä¹  Rust ä¸‹å¦‚ä½•ä½¿ç”¨ atomicï¼Œå¯ä»¥çœ‹ Jon Gjengset çš„è§†é¢‘ï¼š<a href=\"https://www.youtube.com/watch?v=rMGWeSjctlY\">Crust of Rust: Atomics and Memory Ordering</a>ã€‚</li>\n<li>Rust çš„ <a href=\"https://github.com/mvdnes/spin-rs\">spin-rs crate</a> æä¾›äº† Spinlock çš„å®ç°ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥çœ‹çœ‹å®ƒçš„å®ç°ã€‚</li>\n</ol>","neighbors":{"left":{"article_title":"32ï½œå®æ“é¡¹ç›®ï¼šä½¿ç”¨PyO3å¼€å‘Python3æ¨¡å—","id":437569},"right":{"article_title":"34ï½œå¹¶å‘å¤„ç†ï¼ˆä¸‹ï¼‰ï¼šä»atomicsåˆ°Channelï¼ŒRustéƒ½æä¾›äº†ä»€ä¹ˆå·¥å…·ï¼Ÿ","id":442217}},"comments":[{"had_liked":false,"id":321782,"user_name":"Ethan Liu","can_delete":false,"product_type":"c1","uid":1070043,"ip_address":"","ucode":"231F944F7CD56A","user_header":"https://static001.geekbang.org/account/avatar/00/10/53/db/858337e3.jpg","comment_is_top":false,"comment_ctime":1637045681,"is_pvip":true,"replies":[{"id":"116885","content":"æ–‡ä¸­å·²ç»è®²äº†ï¼ŒRust çš„ä¼˜ç‚¹æ˜¯æ‰€æœ‰æ–¹æ¡ˆéƒ½æ”¯æŒï¼Œç¼ºç‚¹æ˜¯ä½ éœ€è¦è€ƒè™‘åˆé€‚çš„åœºæ™¯ç”¨åˆé€‚çš„å·¥å…·ï¼Œå¦å¤– Rust channel åœ¨æŸäº›æƒ…å†µä¸‹æ€§èƒ½ä¸å¦‚ golangï¼›golang  çš„ä¼˜ç‚¹æ˜¯ç®€å•ï¼ŒCSP ä¸€æ‹›é²œï¼Œå¤§éƒ¨åˆ†åœºæ™¯ channel  éƒ½èƒ½å¾ˆå¥½é€‚ç”¨ï¼Œç¼ºç‚¹æ˜¯é‡åˆ° channel ä¸å¥½è§£å†³çš„é—®é¢˜ï¼Œæˆ–è€…æ•ˆç‡ä¸é«˜çš„é—®é¢˜ï¼Œå°±æ¯”è¾ƒå°´å°¬","user_name":"ä½œè€…å›å¤","comment_id":321782,"uid":"1079375","ip_address":"","utype":1,"ctime":1637077496,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"23111882161","product_id":100085301,"comment_content":"rustç›¸æ¯”goåœ¨å¹¶å‘å¤„ç†ä¸Š æœ‰ä»€ä¹ˆä¼˜ç‚¹å’Œç¼ºç‚¹ï¼Ÿ","like_count":6,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":530498,"discussion_content":"æ–‡ä¸­å·²ç»è®²äº†ï¼ŒRust çš„ä¼˜ç‚¹æ˜¯æ‰€æœ‰æ–¹æ¡ˆéƒ½æ”¯æŒï¼Œç¼ºç‚¹æ˜¯ä½ éœ€è¦è€ƒè™‘åˆé€‚çš„åœºæ™¯ç”¨åˆé€‚çš„å·¥å…·ï¼Œå¦å¤– Rust channel åœ¨æŸäº›æƒ…å†µä¸‹æ€§èƒ½ä¸å¦‚ golangï¼›golang  çš„ä¼˜ç‚¹æ˜¯ç®€å•ï¼ŒCSP ä¸€æ‹›é²œï¼Œå¤§éƒ¨åˆ†åœºæ™¯ channel  éƒ½èƒ½å¾ˆå¥½é€‚ç”¨ï¼Œç¼ºç‚¹æ˜¯é‡åˆ° channel ä¸å¥½è§£å†³çš„é—®é¢˜ï¼Œæˆ–è€…æ•ˆç‡ä¸é«˜çš„é—®é¢˜ï¼Œå°±æ¯”è¾ƒå°´å°¬","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637077496,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":326910,"user_name":"Geek_b52974","can_delete":false,"product_type":"c1","uid":1298252,"ip_address":"","ucode":"59884399646620","user_header":"","comment_is_top":false,"comment_ctime":1639745416,"is_pvip":true,"replies":[{"id":"120819","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","comment_id":326910,"uid":"1079375","ip_address":"","utype":1,"ctime":1642311219,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"5934712712","product_id":100085301,"comment_content":"ä½œæ¥­:<br>use std::sync::Arc;<br><br>use tokio::{sync::Semaphore, task::JoinHandle};<br><br>#[tokio::main]<br>async fn main() {<br>    let library = Box::new(Library::new(3));<br>    let mut tasks: Vec&lt;JoinHandle&lt;()&gt;&gt; = vec![];<br>    for i in 0..10 {<br>        tasks.push(library.enter(move || println!(&quot;no: {}, borrow book&quot;, i)));<br>    }<br>    for task in tasks {<br>        task.await.unwrap();<br>    }<br>    println!(&quot;{:?}&quot;, library.semaphore.available_permits());<br>}<br><br>struct Library {<br>    semaphore: Arc&lt;Semaphore&gt;,<br>}<br><br>impl Library {<br>    fn new(capacity: usize) -&gt; Self {<br>        Self {<br>            semaphore: Arc::new(Semaphore::new(capacity)),<br>        }<br>    }<br><br>    fn enter(&amp;self, chore: impl Fn() + Send + &#39;static) -&gt; JoinHandle&lt;()&gt; {<br>        let semaphore = self.semaphore.clone();<br>        tokio::spawn(async move {<br>            &#47;&#47; remove this you will get panic<br>            &#47;&#47; semaphore.close();<br>            println!(&quot;{} quota left&quot;, semaphore.available_permits());<br>            let s = semaphore.acquire_owned().await.unwrap();<br>            chore();<br>            drop(s);<br>        })<br>    }<br>}","like_count":1,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546462,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642311219,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":321394,"user_name":"D. D","can_delete":false,"product_type":"c1","uid":2186992,"ip_address":"","ucode":"C416E5602C8814","user_header":"https://static001.geekbang.org/account/avatar/00/21/5e/f0/62d8cf9e.jpg","comment_is_top":false,"comment_ctime":1636827889,"is_pvip":true,"replies":[{"id":"118929","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","comment_id":321394,"uid":"1079375","ip_address":"","utype":1,"ctime":1639853726,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"5931795185","product_id":100085301,"comment_content":"æ—¢ç„¶ Semaphore æ˜¯ Mutex çš„æ¨å¹¿ï¼Œé‚£ä¹ˆå®ç°çš„æ€è·¯åº”è¯¥æœ‰ç‚¹ç±»ä¼¼ã€‚<br>å‚è€ƒè€å¸ˆæ–‡ç« ä¸­æ‰€è¯´çš„ Mutex çš„å®ç°æ–¹æ³•ï¼Œå®ç° Semaphore çš„ä¸€ä¸ªæ€è·¯æ˜¯ï¼š<br>æˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ª AtomicUsize è®°å½•å¯ç”¨çš„ permits çš„æ•°é‡ã€‚åœ¨è·å– permits çš„æ—¶å€™ï¼Œå¦‚æœæ— æ³•è·å–åˆ°è¶³å¤Ÿçš„ permitsï¼Œå°±æŠŠå½“å‰çº¿ç¨‹æŒ‚èµ·ï¼Œæ”¾å…¥ Semaphore çš„ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—é‡Œã€‚è·å–åˆ° permits çš„çº¿ç¨‹å®Œæˆå·¥ä½œåé€€å‡ºä¸´ç•ŒåŒºæ—¶ï¼ŒSemaphore ç»™ç­‰å¾…é˜Ÿåˆ—å‘é€ä¿¡å·ï¼ŒæŠŠé˜Ÿå¤´çš„çº¿ç¨‹å”¤é†’ã€‚<br><br>è‡³äºåƒå›¾ä¹¦é¦†é‚£æ ·çš„äººæ•°æ§åˆ¶ç³»ç»Ÿï¼Œtokio çš„ Semaphore æ–‡æ¡£ä¸­ä½¿ç”¨ Semaphore::acquire_owned çš„ä¾‹å­å¯ä»¥è¯´å°±æ˜¯è¿™ç§åœºæ™¯çš„æ¨¡æ‹Ÿã€‚","like_count":2,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539890,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639853727,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":321212,"user_name":"ç»ˆç”Ÿæ»éš","can_delete":false,"product_type":"c1","uid":2739953,"ip_address":"","ucode":"4E21A631545D22","user_header":"https://static001.geekbang.org/account/avatar/00/29/ce/f1/d2fc86bb.jpg","comment_is_top":false,"comment_ctime":1636709021,"is_pvip":false,"replies":[{"id":"118935","content":"Duration æœ‰ from_secs &#47; from_millis ç­‰æ–¹æ³•ï¼Œä¸å¿…ç”¨ Duration::newï¼Œè¿™ä¸ªæ¥å£ä¸ç›´è§‚ã€‚","user_name":"ä½œè€…å›å¤","comment_id":321212,"uid":"1079375","ip_address":"","utype":1,"ctime":1639853864,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"5931676317","product_id":100085301,"comment_content":"&#47;&#47; [dependencies]<br>&#47;&#47; tokio = { version = &quot;1&quot;, features = [&quot;full&quot;] }<br>&#47;&#47; chrono = &quot;*&quot;<br><br><br>use tokio::sync::{Semaphore, TryAcquireError};<br>use std::sync::Arc;<br>use std::thread;<br>use std::time::Duration;<br>use chrono::prelude::*;<br><br>#[tokio::main]<br>async fn main() {<br>    let semaphore = Arc::new(Semaphore::new(3));<br>    let mut join_handles = Vec::new();<br><br>    for c in 0..5 {<br>        let permit = semaphore.clone().acquire_owned().await.unwrap();<br>        join_handles.push(tokio::spawn(async move {<br>            let local: DateTime&lt;Local&gt; = Local::now();<br>            println!(&quot;count{} start time: {}&quot;, c+1, local);<br>            thread::sleep(Duration::new(10, 0));<br>            drop(permit);<br>        }));<br>    }<br><br>    for handle in join_handles {<br>        handle.await.unwrap();<br>    }<br>}","like_count":1,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539896,"discussion_content":"Duration æœ‰ from_secs / from_millis ç­‰æ–¹æ³•ï¼Œä¸å¿…ç”¨ Duration::newï¼Œè¿™ä¸ªæ¥å£ä¸ç›´è§‚ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639853864,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":358654,"user_name":"è¿›å‡»çš„Lancelot","can_delete":false,"product_type":"c1","uid":2620407,"ip_address":"å¹¿ä¸œ","ucode":"3BCC355801DC61","user_header":"https://static001.geekbang.org/account/avatar/00/27/fb/f7/88ab6f83.jpg","comment_is_top":false,"comment_ctime":1664519594,"is_pvip":true,"discussion_count":0,"race_medal":1,"score":"1664519594","product_id":100085301,"comment_content":"ä½œä¸šï¼šhttps:&#47;&#47;play.rust-lang.org&#47;?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=453c39051a8257931b0cb167bf8fc60f","like_count":0},{"had_liked":false,"id":351280,"user_name":"ELSE","can_delete":false,"product_type":"c1","uid":1172907,"ip_address":"","ucode":"72448D7271C8B0","user_header":"https://static001.geekbang.org/account/avatar/00/11/e5/ab/56f348e5.jpg","comment_is_top":false,"comment_ctime":1657675722,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1657675722","product_id":100085301,"comment_content":"golangä¸æ˜¯ä¹Ÿæ”¯æŒatomic, mutexè¿™äº›åŸè¯­å—ï¼Œä¸ºä»€ä¹ˆè¯´é‡åˆ°channelä¸å¥½è§£å†³çš„æ—¶å€™å°±æ¯”è¾ƒå°´å°¬å‘¢ï¼Œä¸å¥½ç†è§£","like_count":0},{"had_liked":false,"id":348904,"user_name":"BeCool","can_delete":false,"product_type":"c1","uid":1474104,"ip_address":"","ucode":"0A62B0C2ABE28D","user_header":"https://static001.geekbang.org/account/avatar/00/16/7e/38/ae659af9.jpg","comment_is_top":false,"comment_ctime":1655533985,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1655533985","product_id":100085301,"comment_content":"è€å¸ˆï¼Œæˆ‘æ˜¯åˆšå­¦ä¹ çš„èŒæ–°ï¼Œæƒ³é—®ä¸‹ï¼Œè¿™æ®µä»£ç æœ‰æ—¶å€™æ˜¯100æœ‰æ—¶å€™æ˜¯10ï¼Œæ­£å¸¸å—","like_count":0,"discussions":[{"author":{"id":1192115,"avatar":"","nickname":"preston","note":"","ucode":"A98A587D4B716C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":581102,"discussion_content":"æ˜¯æ­£å¸¸çš„ï¼Œå› ä¸ºçº¿ç¨‹çš„joinä¸ç­‰äºé©¬ä¸Šå°±è°ƒç”¨ï¼Œå…·ä½“ä¼šå…ˆè°ƒç”¨è°è¦çœ‹ç³»ç»Ÿè°ƒåº¦ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1658496443,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":347186,"user_name":"è…ç”°","can_delete":false,"product_type":"c1","uid":1228201,"ip_address":"","ucode":"75668DE75FF7BF","user_header":"https://static001.geekbang.org/account/avatar/00/12/bd/a9/688b9bc6.jpg","comment_is_top":false,"comment_ctime":1653803634,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1653803634","product_id":100085301,"comment_content":"çœ‹äº†ä¸€éè€å¸ˆçš„æ–‡ç« ä¹‹åç»“åˆcrustçš„youtubeè§†é¢‘ï¼Œæœ‰ä¸€ç‚¹è¿˜æ˜¯æ²¡å¼„æ˜ç™½ï¼šä»€ä¹ˆæƒ…å†µä¸‹å¯ä»¥ä¸ä½¿ç”¨SeqCstï¼Ÿ<br>è¿˜æœ‰æˆ‘å¯¹Orderingçš„ç†è§£æ˜¯å¦æ­£ç¡®ï¼š<br>1. Ordering æ˜¯å¯¹åŒä¸€ä¸ªAtomicçš„å€¼çš„ä½¿ç”¨çš„é™åˆ¶ï¼Œå¦‚æœæ¶‰åŠå¤šä¸ªatomicçš„å€¼æ—¶åº”è¯¥ä½¿ç”¨SeqCstæ¥ä¿è¯é¡ºåºï¼›<br>2. åœ¨å¯¹åŒä¸€ä¸ªå€¼è¯»å†™æ—¶ï¼Œloadæ—¶ä½¿ç”¨Acquireï¼Œåœ¨storeæ—¶ä½¿ç”¨Releaseï¼Œç”¨è¿™Acquire ã€Releaseä»£ç åŒ…è£¹èµ·æ¥ä¸­é—´çš„è¯»å†™æ“ä½œæ˜¯å®‰å…¨çš„ï¼Ÿæ¯”æ–¹è¯´ï¼š<br>```<br>while !x.load(Ordering::Acquire) {<br>}<br>x.store(&#47;** );**&#47;<br>x.store(&#47;** );**&#47;<br>x.store(&#47;** );**&#47; &#47;&#47; è¿™ä¸‰å¥storeéƒ½æ˜¯å®‰å…¨çš„ï¼Œåœ¨è¢«åˆ«çš„çº¿ç¨‹loadçš„æ—¶å€™éƒ½æ˜¯åœ¨x.store(1)ä¹‹åçš„ç»“æœï¼Ÿå…¶ä»–çº¿ç¨‹åœ¨æ­¤æœŸé—´ä¸ä¼šæ’å…¥è¿›æ¥ï¼›<br>x.store(1, Ordering::Release);<br><br>```","like_count":0},{"had_liked":false,"id":342911,"user_name":"Geek_9f3c8c","can_delete":false,"product_type":"c1","uid":2342031,"ip_address":"","ucode":"6E4E43E9504749","user_header":"","comment_is_top":false,"comment_ctime":1650530988,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1650530988","product_id":100085301,"comment_content":"è¯¥æ–‡ç« å…³äºCASçš„ä»£ç ç¤ºä¾‹ä¼¼ä¹å¹¶æœªå®ç°çº¿ç¨‹é—´åŒæ­¥ï¼Œåªæ˜¯å®ç°äº†å¯¹ä¸´ç•ŒåŒºè®¿é—®çš„äº’æ–¥ã€‚è¯¥ç¤ºä¾‹è¿è¡Œç»“æœå¯èƒ½æ˜¯100æˆ–è€…10ã€‚","like_count":0},{"had_liked":false,"id":330584,"user_name":"Milittle","can_delete":false,"product_type":"c1","uid":1045455,"ip_address":"","ucode":"80E566639A8ABB","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f3/cf/851dab01.jpg","comment_is_top":false,"comment_ctime":1642057433,"is_pvip":true,"replies":[{"id":"120685","content":"å¯¹","user_name":"ä½œè€…å›å¤","comment_id":330584,"uid":"1079375","ip_address":"","utype":1,"ctime":1642292639,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"1642057433","product_id":100085301,"comment_content":"casæ˜¯æŒ‡ä»¤é›†æŒ‡ä»¤æä¾›çš„èƒ½åŠ› ä¸€èˆ¬è¯­è¨€å°è£…çš„å¹¶å‘åŸè¯­éƒ½æ˜¯åœ¨è¿™ä¸ªåŸºç¡€ä¸Šçš„","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546294,"discussion_content":"å¯¹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642292639,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":330142,"user_name":"æ…•é«˜è¿ª","can_delete":false,"product_type":"c1","uid":1448126,"ip_address":"","ucode":"EB1CB5EA4E3A90","user_header":"https://static001.geekbang.org/account/avatar/00/16/18/be/ad3127e0.jpg","comment_is_top":false,"comment_ctime":1641812541,"is_pvip":false,"replies":[{"id":"120701","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","comment_id":330142,"uid":"1079375","ip_address":"","utype":1,"ctime":1642293587,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"1641812541","product_id":100085301,"comment_content":"æ„Ÿè§‰å’Œjavaå¯¹åº”çš„åŠŸèƒ½ï¼ŒåŸç†ä¸€è‡´","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546310,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642293588,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":324854,"user_name":"æ ¸æ¡ƒ","can_delete":false,"product_type":"c1","uid":1385204,"ip_address":"","ucode":"7AB05270CBCCCB","user_header":"https://static001.geekbang.org/account/avatar/00/15/22/f4/9fd6f8f0.jpg","comment_is_top":false,"comment_ctime":1638688510,"is_pvip":false,"replies":[{"id":"118858","content":"ä¸åˆ†åœºåˆåœ°ä½¿ç”¨ Relaxedï¼Œä¼šå¯¼è‡´ä¸ä¸€è‡´çš„æ›´æ–°ï¼›ä¸åˆ†åœºåˆåœ°ä½¿ç”¨ SeqCstï¼Œä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ã€‚","user_name":"ä½œè€…å›å¤","comment_id":324854,"uid":"1079375","ip_address":"","utype":1,"ctime":1639848182,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"1638688510","product_id":100085301,"comment_content":"å¦å¤–å…³äºOrderingé‚£å‡ ä¸ªçš„åŒºåˆ«ï¼Œä¸ªäººå†™ä»£ç çš„æ—¶å€™ï¼Œç»å¤§éƒ¨åˆ†æ—¶å€™ï¼Œè¦ä¹ˆæœ€ç®€å•çš„Relaxedï¼Œè¦ä¹ˆæœ€ä¸¥æ ¼çš„SeqCstï¼Œå‰©ä¸‹çš„ï¼Œä¸ä¸€å®šè€ƒè™‘é‚£ä¹ˆå¤šï¼Œé™¤éç‰¹æ®Šéœ€è¦æ‰å»æŸ¥ä¸€ä¸‹åŒºåˆ«ï¼Œå¹³æ—¶è®°ä¸ä½çš„ã€‚ã€‚ã€‚","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539818,"discussion_content":"ä¸åˆ†åœºåˆåœ°ä½¿ç”¨ Relaxedï¼Œä¼šå¯¼è‡´ä¸ä¸€è‡´çš„æ›´æ–°ï¼›ä¸åˆ†åœºåˆåœ°ä½¿ç”¨ SeqCstï¼Œä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639848182,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":324853,"user_name":"æ ¸æ¡ƒ","can_delete":false,"product_type":"c1","uid":1385204,"ip_address":"","ucode":"7AB05270CBCCCB","user_header":"https://static001.geekbang.org/account/avatar/00/15/22/f4/9fd6f8f0.jpg","comment_is_top":false,"comment_ctime":1638688346,"is_pvip":false,"replies":[{"id":"118856","content":"ä¸æ˜¯ã€‚atomic operation æ˜¯ç¡¬ä»¶æä¾›çš„æ— æ³•è¢«ä¸­æ–­æ‰“æ–­çš„æŒ‡ä»¤ï¼Œå¹¶ä¸æ˜¯å»å…³é—­ä¸­æ–­ã€‚<br>è¿™é‡Œæˆ‘ä»¬ç”¨ atomic å®ç°çš„ mutexï¼Œå°±æ˜¯ä¸€ä¸ª spinlockã€‚","user_name":"ä½œè€…å›å¤","comment_id":324853,"uid":"1079375","ip_address":"","utype":1,"ctime":1639848097,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"1638688346","product_id":100085301,"comment_content":"ç†è§£ä¸€ä¸‹ï¼Œå¯¹äºæ‰€è°“çš„æŒ‡ä»¤åŸå­æ“ä½œï¼Œåœ¨è®¡ç®—æœºåº•å±‚é‡Œé¢ï¼Œæ²¡è®°é”™å°±æ˜¯ä¸­æ–­æ€»çº¿å…³é—­å§ã€‚<br><br>ç„¶åé‚£æ®µä¼˜åŒ–çš„ä»£ç ï¼Œå°±æ˜¯æ‹¿ä¸åˆ°é”å…ˆwhileç©ºè½¬ä¸€ä¸‹ï¼Œè¿™é‡Œå°±æœ‰ç‚¹åƒjavaçš„è‡ªæ—‹é”çš„æ¦‚å¿µé‚£æ ·ã€‚<br>å½“ç„¶è¿™é‡Œä¸ºä»€ä¹ˆç©ºè½¬æ€§èƒ½ä¼šæ¯”spinå¥½ï¼Œä»ç³»ç»Ÿçš„è§’åº¦ç†è§£ï¼Œç©ºè½¬æ²¡æœ‰è°ƒç”¨ç³»ç»Ÿè°ƒç”¨ï¼Œé‚£ä¹ˆå°±æ²¡æœ‰å¤ªå¤šçš„è¿›ç¨‹æˆ–è€…çº¿ç¨‹åˆ‡æ¢ï¼Œè€Œåˆ‡æ¢è¿™ä¸ªæ˜¯æ¶‰åŠä¸Šä¸‹æ–‡å˜æ›´çš„ã€‚ä¸ç®¡è¿›ç¨‹è¿˜æ˜¯çº¿ç¨‹ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ—¶å€™ï¼Œå…¶å®äº”å¤§ç»“æ„éƒ½æ˜¯è¦è€ƒè™‘çš„ï¼Œä¾‹å¦‚ä¿¡å·é‡é‚£äº›æ˜¯å¦è¦ä¿å­˜èµ·æ¥ç­‰ç­‰ï¼Œé‚£æ ·ä»£ç è‡ªç„¶ä¼šå¤§å¾ˆå¤šäº†ã€‚<br><br>ä¸çŸ¥é“è¿™æ ·ç†è§£æ˜¯å¦å¯¹å“ˆã€‚","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539816,"discussion_content":"ä¸æ˜¯ã€‚atomic operation æ˜¯ç¡¬ä»¶æä¾›çš„æ— æ³•è¢«ä¸­æ–­æ‰“æ–­çš„æŒ‡ä»¤ï¼Œå¹¶ä¸æ˜¯å»å…³é—­ä¸­æ–­ã€‚\nè¿™é‡Œæˆ‘ä»¬ç”¨ atomic å®ç°çš„ mutexï¼Œå°±æ˜¯ä¸€ä¸ª spinlockã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639848097,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":321778,"user_name":"Geek_b52974","can_delete":false,"product_type":"c1","uid":1298252,"ip_address":"","ucode":"59884399646620","user_header":"","comment_is_top":false,"comment_ctime":1637044058,"is_pvip":true,"replies":[{"id":"118915","content":"ä½ å¯ä»¥è¯¦ç»†çœ‹æ–‡æ¡£ï¼šhttps:&#47;&#47;doc.rust-lang.org&#47;std&#47;sync&#47;atomic&#47;struct.AtomicBool.html#method.compare_exchange","user_name":"ä½œè€…å›å¤","comment_id":321778,"uid":"1079375","ip_address":"","utype":1,"ctime":1639852711,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"1637044058","product_id":100085301,"comment_content":"compare_exchange(false, true, Ordering::Acquire, Ordering::Relaxed)<br>æƒ³é—®ä¸€ä¸‹ç¬¬ä¸‰ä¸ªå‚æ•° ä¸ºä½•ä¸æ˜¯ acqRelï¼Œè¿™æ ·å…¶ä»–çº¿ç¨‹ä¼šçŸ¥é“å—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539876,"discussion_content":"ä½ å¯ä»¥è¯¦ç»†çœ‹æ–‡æ¡£ï¼šhttps://doc.rust-lang.org/std/sync/atomic/struct.AtomicBool.html#method.compare_exchange","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639852712,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":321161,"user_name":"ç½—æ°","can_delete":false,"product_type":"c1","uid":1320487,"ip_address":"","ucode":"96BAFAA147341F","user_header":"https://static001.geekbang.org/account/avatar/00/14/26/27/eba94899.jpg","comment_is_top":false,"comment_ctime":1636695041,"is_pvip":false,"replies":[{"id":"118936","content":"å—¯","user_name":"ä½œè€…å›å¤","comment_id":321161,"uid":"1079375","ip_address":"","utype":1,"ctime":1639853871,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":2,"score":"1636695041","product_id":100085301,"comment_content":"CAS çš„åŸç†æŒºç»•çš„ï¼Œéœ€è¦å¥½å¥½çš„æ¶ˆåŒ–ï¼Œæœ€è¿‘ä¹Ÿåœ¨çœ‹â€œGo å¹¶å‘å®æˆ˜è¯¾â€ï¼Œæœ‰ä¸€äº›äº’é€šçš„åœ°æ–¹ã€‚","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539897,"discussion_content":"å—¯","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639853871,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}