{"id":73651,"title":"07 | 启动优化（上）：从启动过程看启动速度优化","content":"<blockquote>\n<p>在超市排队结账，扫码支付启动十几秒都还没完成，只能换一个工具支付？</p>\n</blockquote><blockquote>\n<p>想买本书充实一下，页面刷出来时候十几秒都不能操作，那就换一个应用购买？</p>\n</blockquote><p>用户如果想打开一个应用，就一定要经过“启动”这个步骤。启动时间的长短，不只是用户体验的问题，对于淘宝、京东这些应用来说，会直接影响留存和转化等核心数据。对研发人员来说，启动速度是我们的“门面”，它清清楚楚可以被所有人看到，我们都希望自己应用的启动速度可以秒杀所有竞争对手。</p><p>那启动过程究竟会出现哪些问题？我们应该怎么去优化和监控应用的启动速度呢？今天我们一起来看看这些问题该如何解决。</p><h2>启动分析</h2><p>在真正动手开始优化之前，我们应该先搞清楚从用户点击图标开始，整个启动过程经过哪几个关键阶段，又会给用户带来哪些体验问题。</p><p><strong>1. 启动过程分析</strong></p><p><img src=\"https://static001.geekbang.org/resource/image/0d/43/0da2051f1f8d182a531063eb202abf43.png?wh=1368*560\" alt=\"\"></p><p>我以微信为例，用户从桌面点击图标开始，会经过4个关键阶段。</p><ul>\n<li>\n<p><strong>T1预览窗口显示</strong>。系统在拉起微信进程之前，会先根据微信的Theme属性创建预览窗口。当然如果我们禁用预览窗口或者将预览窗口指定为透明，用户在这段时间依然看到的是桌面。</p>\n</li>\n<li>\n<p><strong>T2闪屏显示</strong>。在微信进程和闪屏窗口页面创建完毕，并且完成一系列inflate view、onmeasure、onlayout等准备工作后，用户终于可以看到熟悉的“小地球”。</p>\n</li>\n<li>\n<p><strong>T3主页显示</strong>。在完成主窗口创建和页面显示的准备工作后，用户可以看到微信的主界面。</p>\n</li>\n<li>\n<p><strong>T4界面可操作</strong>。在启动完成后，微信会有比较多的工作需要继续执行，例如聊天和朋友圈界面的预加载、小程序框架和进程的准备等。在这些工作完成后，用户才可以真正开始愉快地聊天。</p>\n</li>\n</ul><!-- [[[read_end]]] --><p><strong>2. 启动问题分析</strong></p><p>从启动流程的4个关键阶段，我们可以推测出用户启动过程会遇到的3个问题。这3个问题其实也是大多数应用在启动时可能会遇到的。</p><ul>\n<li>问题1：点击图标很久都不响应</li>\n</ul><p>如果我们禁用了预览窗口或者指定了透明的皮肤，那用户点击了图标之后，需要T2时间才能真正看到应用闪屏。对于用户体验来说，点击了图标，过了几秒还是停留在桌面，看起来就像没有点击成功，这在中低端机中更加明显。</p><ul>\n<li>问题2：首页显示太慢</li>\n</ul><p>现在应用启动流程越来越复杂，闪屏广告、热修复框架、插件化框架、大前端框架，所有准备工作都需要集中在启动阶段完成。上面说的T3首页显示时间对于中低端机来说简直就是噩梦，经常会达到十几秒的时间。</p><ul>\n<li>问题3：首页显示后无法操作。</li>\n</ul><p>既然首页显示那么慢，那我能不能把尽量多的工作都通过异步化延后执行呢？很多应用的确就是这么做的，但这会造成两种后果：要么首页会出现白屏，要么首页出来后用户根本无法操作。</p><p>很多应用把启动结束时间的统计放到首页刚出现的时候，这对用户是不负责任的。看到一个首页，但是停住十几秒都不能滑动，这对用户来说完全没有意义。<strong>启动优化不能过于KPI化，要从用户的真实体验出发，要着眼从点击图标到用户可操作的整个过程。</strong></p><h2>启动优化</h2><p>启动速度优化的方法和卡顿优化基本相同，不过因为启动实在是太重要了，我们会更加“精打细算”。我们希望启动期间加载的每个功能和业务都是必须的，它们的实现都是经过“千锤百炼”的，特别是在中低端机上面的表现。</p><p><strong>1. 优化工具</strong></p><p>“工欲善其事必先利其器”，我们需要先找到一款适合做启动优化分析的工具。</p><p>你可以先回忆一下“卡顿优化”提到的几种工具。Traceview性能损耗太大，得出的结果并不真实；Nanoscope非常真实，不过暂时只支持Nexus 6P和x86模拟器，无法针对中低端机做测试；Simpleperf的火焰图并不适合做启动流程分析；systrace可以很方便地追踪关键系统调用的耗时情况，但是不支持应用程序代码的耗时分析。</p><p>综合来看，在卡顿优化中提到“systrace + 函数插桩”似乎是比较理想的方案，而且它还可以看到系统的一些关键事件，例如GC、System Server、CPU调度等。</p><p>我们可以通过下面的命令，可以查看手机支持哪些systrace类型。不同的系统支持的类型有所差别，其中Dalvik、sched、ss、app都是我们比较关心的。</p><pre><code>python systrace.py --list-categories\n</code></pre><p>通过插桩，我们可以看到应用主线程和其他线程的函数调用流程。它的实现原理非常简单，就是将下面的两个函数分别插入到每个方法的入口和出口。</p><pre><code>class Trace {\n  public static void i(String tag) {\n    Trace.beginSection(name);\n  }\n\n\n  public static void o() {\n      Trace.endSection();\n  }\n}\n</code></pre><p>当然这里面有非常多的细节需要考虑，比如怎么样降低插桩对性能的影响、哪些函数需要被排除掉。最终改良版的systrace性能损耗在一倍以内，基本可以反映真实的启动流程。函数插桩后的效果如下，你也可以参考课后练习的Sample。</p><pre><code>class Test {\n  public void test() {\n    Trace.i(&quot;Test.test()&quot;);\n    //原来的工作\n    Trace.o()；\n  }\n}\n</code></pre><p><strong>只有准确的数据评估才能指引优化的方向，这一步是非常非常重要的。我见过太多同学在没有充分评估或者评估使用了错误的方法，最终得到了错误的方向。辛辛苦苦一两个月，最后发现根本达不到预期的效果。</strong></p><p><strong>2. 优化方式</strong></p><p>在拿到整个启动流程的全景图之后，我们可以清楚地看到这段时间内系统、应用各个进程和线程的运行情况，现在我们要开始真正开始“干活”了。</p><p>具体的优化方式，我把它们分为闪屏优化、业务梳理、业务优化、线程优化、GC优化和系统调用优化。</p><ul>\n<li>闪屏优化</li>\n</ul><p>今日头条把预览窗口实现成闪屏的效果，这样用户只需要很短的时间就可以看到“预览闪屏”。这种完全“跟手”的感觉在高端机上体验非常好，但对于中低端机，会把总的的闪屏时间变得更长。</p><p>如果点击图标没有响应，用户主观上会认为是手机系统响应比较慢。所以<strong>我比较推荐的做法是，只在Android 6.0或者Android 7.0以上才启用“预览闪屏”方案，让手机性能好的用户可以有更好的体验</strong>。</p><p>微信做的另外一个优化是合并闪屏和主页面的Activity，减少一个Activity会给线上带来100毫秒左右的优化。但是如果这样做的话，管理时会非常复杂，特别是有很多例如PWA、扫一扫这样的第三方启动流程的时候。</p><ul>\n<li>业务梳理</li>\n</ul><p>我们首先需要梳理清楚当前启动过程正在运行的每一个模块，哪些是一定需要的、哪些可以砍掉、哪些可以懒加载。我们也可以根据业务场景来决定不同的启动模式，例如通过扫一扫启动只需要加载需要的几个模块即可。对于中低端机器，我们要学会降级，学会推动产品经理做一些功能取舍。但是需要注意的是，<strong>懒加载要防止集中化，否则容易出现首页显示后用户无法操作的情形</strong>。</p><ul>\n<li>业务优化</li>\n</ul><p>通过梳理之后，剩下的都是启动过程一定要用的模块。这个时候，我们只能硬着头皮去做进一步的优化。优化前期需要“抓大放小”，先看看主线程究竟慢在哪里。最理想是通过算法进行优化，例如一个数据解密操作需要1秒，通过算法优化之后变成10毫秒。退而求其次，我们要考虑这些任务是不是可以通过异步线程预加载实现，<strong>但需要注意的是过多的线程预加载会让我们的逻辑变得更加复杂。</strong></p><p>业务优化做到后面，会发现一些架构和历史包袱会拖累我们前进的步伐。比较常见的是一些事件会被各个业务模块监听，大量的回调导致很多工作集中执行，部分框架初始化“太厚”，例如一些插件化框架，启动过程各种反射、各种Hook，整个耗时至少几百毫秒。还有一些历史包袱又非常沉重，而且“牵一发动全身”，改动风险比较大。但是我想说，如果有合适的时机，我们依然需要勇敢去偿还这些“历史债务”。</p><ul>\n<li>线程优化</li>\n</ul><p>线程优化就像做填空题和解锁题，我们希望能把所有的时间片都利用上，因此主线程和各个线程都是一直满载的。当然我们也希望每个线程都开足马力向前跑，而不是作为接力棒。<strong>所以线程的优化主要在于减少CPU调度带来的波动，让应用的启动时间更加稳定。</strong></p><p>从具体的做法来看，线程的优化一方面是控制线程数量，线程数量太多会相互竞争CPU资源，因此要有统一的线程池，并且根据机器性能来控制数量。</p><p>线程切换的数据我们可以通过卡顿优化中学到的sched文件查看，这里特别需要注意nr_involuntary_switches被动切换的次数。</p><pre><code>proc/[pid]/sched:\n  nr_voluntary_switches：     \n  主动上下文切换次数，因为线程无法获取所需资源导致上下文切换，最普遍的是IO。    \n  nr_involuntary_switches：   \n  被动上下文切换次数，线程被系统强制调度导致上下文切换，例如大量线程在抢占CPU。\n</code></pre><p>另一方面是检查线程间的锁。为了提高启动过程任务执行的速度，有一次我们把主线程内的一个耗时任务放到线程中并发执行，但是发现这样做根本没起作用。仔细检查后发现线程内部会持有一个锁，主线程很快就有其他任务因为这个锁而等待。通过systrace可以看到锁等待的事件，我们需要排查这些等待是否可以优化，特别是防止主线程出现长时间的空转。</p><p><img src=\"https://static001.geekbang.org/resource/image/36/b2/36316813548502f6cf241189e2a73cb2.png?wh=1272*688\" alt=\"\"></p><p>特别是现在有很多启动框架，会使用Pipeline机制，根据业务优先级规定业务初始化时机。比如微信内部使用的<a href=\"http://mp.weixin.qq.com/s/6Q818XA5FaHd7jJMFBG60w\">mmkernel</a>、阿里最近开源的<a href=\"http://github.com/alibaba/alpha\">Alpha</a>启动框架，它们为各个任务建立依赖关系，最终构成一个有向无环图。对于可以并发的任务，会通过线程池最大程度提升启动速度。如果任务的依赖关系没有配置好，很容易出现下图这种情况，即主线程会一直等待taskC结束，空转2950毫秒。</p><p><img src=\"https://static001.geekbang.org/resource/image/86/db/868a5f4c47224be920e97b82d03905db.png?wh=908*376\" alt=\"\"></p><ul>\n<li>GC优化</li>\n</ul><p>在启动过程，要尽量减少GC的次数，避免造成主线程长时间的卡顿，特别是对Dalvik来说，我们可以通过systrace单独查看整个启动过程GC的时间。</p><pre><code>python systrace.py dalvik -b 90960 -a com.sample.gc\n</code></pre><p>对于GC各个事件的具体含义，你可以参考<a href=\"http://developer.android.com/studio/profile/investigate-ram?hl=zh-cn\">《调查RAM使用情况》</a>。</p><p><img src=\"https://static001.geekbang.org/resource/image/d9/93/d9b93eb8de70426f9a487b006d335093.png?wh=1920*446\" alt=\"\"></p><p>不知道你是否还记得我在“内存优化”中提到Debug.startAllocCounting，我们也可以使用它来监控启动过程总GC的耗时情况，特别是阻塞式同步GC的总次数和耗时。</p><pre><code>// GC使用的总耗时，单位是毫秒\nDebug.getRuntimeStat(&quot;art.gc.gc-time&quot;);\n// 阻塞式GC的总耗时\nDebug.getRuntimeStat(&quot;art.gc.blocking-gc-time&quot;);\n</code></pre><p>如果我们发现主线程出现比较多的GC同步等待，那就需要通过Allocation工具做进一步的分析。启动过程避免进行大量的字符串操作，特别是序列化跟反序列化过程。一些频繁创建的对象，例如网络库和图片库中的Byte数组、Buffer可以复用。如果一些模块实在需要频繁创建对象，可以考虑移到Native实现。</p><p>Java对象的逃逸也很容易引起GC问题，我们在写代码的时候比较容易忽略这个点。我们应该保证对象生命周期尽量的短，在栈上就进行销毁。</p><ul>\n<li>系统调用优化</li>\n</ul><p>通过systrace的System Service类型，我们可以看到启动过程System Server的CPU工作情况。在启动过程，我们尽量不要做系统调用，例如PackageManagerService操作、Binder调用等待。</p><p>在启动过程也不要过早地拉起应用的其他进程，System Server和新的进程都会竞争CPU资源。特别是系统内存不足的时候，当我们拉起一个新的进程，可能会成为“压死骆驼的最后一根稻草”。它可能会触发系统的low memory killer机制，导致系统杀死和拉起（保活）大量的进程，从而影响前台进程的CPU。</p><p>讲个实践的案例，之前我们的一个程序在启动过程会拉起下载和视频播放进程，改为按需拉起后，线上启动时间提高了3%，对于1GB以下的低端机优化，整个启动时间可以优化5%～8%，效果还是非常明显的。</p><h2>总结</h2><p>今天我们首先学习了启动的整个流程，其中比较关键的是4个阶段。在这4个阶段中，用户可能会出现“点击图标很久都不响应“”首页显示太慢“和”首页显示后无法操作“这3个问题。</p><p>接着我们学习了启动优化和监控的一些常规方法。针对不同的业务场景、不同性能的机器，需要采用不同的策略。<strong>有些知识点似乎比较“浅尝辄止”，我更希望你能够通过学习和实践将它们丰富起来。</strong></p><p>我讲到的大部分内容都是跟业务相关，业务的梳理和优化也是最快出成果的。不过这个过程我们要学会取舍，你可能遇到过，很多产品经理为了提升自己负责的模块的数据，总会逼迫开发做各种各样的预加载。但是大家都想快，最后的结果就是代码一团糟，肯定都快不起来。</p><p>比如只有1%用户使用的功能，却让所有用户都做预加载。面对这种情况，我们要狠下心来，只留下那些真正不能删除的业务，或者通过场景化直接找到那1%的用户。跟产品经理PK可能不是那么容易，关键在于数据。<strong>我们需要证明启动优化带来整体留存、转化的正向价值，是大于某个业务取消预加载带来的负面影响</strong>。</p><p>启动优化是性能优化工作非常重要的一环，<span class=\"orange\">今天的课后作业是，在你过去的工作中，曾经针对启动做过哪些优化，最终效果又是怎样的呢？</span>请你在留言区分享一下今天学习、练习的收获与心得。</p><h2>课后练习</h2><p>“工欲善其事必先利其器”，我多次提到“systrace + 函数插桩”是一个非常不错的卡顿排查工具，那么通过今天的<a href=\"http://github.com/AndroidAdvanceWithGeektime/Chapter07\">Sample</a>，我们一起来看一下它是如何实现的。需要注意的是Sample选择了ASM插桩的方式，感兴趣的同学可以课后学习一下它的使用方法，在后续我们也会有关于插桩的专门课程。</p><p>我们可以将Sample运用到自己的应用中，虽然它过滤了大部分的函数，但是我们还是需要注意白名单的配置。例如log、加解密等在底层非常频繁调用的函数，都要在白名单中配置过滤掉，不然可能会出现类似下面这样大量的毛刺。</p><p><img src=\"https://static001.geekbang.org/resource/image/6e/92/6e217938a569f32adffa84ff4eedc492.png?wh=1440*190\" alt=\"\"></p><p>欢迎你点击“请朋友读”，把今天的内容分享给好友，邀请他一起学习。最后别忘了在评论区提交今天的作业，我也为认真完成作业的同学准备了丰厚的“学习加油礼包”，期待与你一起切磋进步哦。</p><p></p>","comments":[{"had_liked":false,"id":140291,"user_name":"海贼凯","can_delete":false,"product_type":"c1","uid":1124978,"ip_address":"","ucode":"207E3D67692924","user_header":"https://static001.geekbang.org/account/avatar/00/11/2a/72/d2f27024.jpg","comment_is_top":false,"comment_ctime":1570871523,"is_pvip":false,"replies":[{"id":"62087","content":"一般都是提前准备好闪屏页的，在下一次生效","user_name":"作者回复","user_name_real":"张绍文","uid":"1009577","ctime":1576683666,"ip_address":"","comment_id":140291,"utype":1}],"discussion_count":1,"race_medal":0,"score":"44520544483","product_id":100021101,"comment_content":"闪屏页需要网络请求怎么进行优化？","like_count":10,"discussions":[{"author":{"id":1009577,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/67/a9/e251ace7.jpg","nickname":"张绍文","note":"","ucode":"94B49E5F80BFDE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":470332,"discussion_content":"一般都是提前准备好闪屏页的，在下一次生效","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576683666,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":88794,"user_name":"PP","can_delete":false,"product_type":"c1","uid":1187449,"ip_address":"","ucode":"402B6A4316DFBB","user_header":"https://static001.geekbang.org/account/avatar/00/12/1e/79/54a1635c.jpg","comment_is_top":false,"comment_ctime":1556001734,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"40210707398","product_id":100021101,"comment_content":"Unable to select a master clock domain because no path can be found from &quot;SYSTRACE&quot; to &quot;LINUX_FTRACE_GLOBAL&quot;.解决方法<br><br>在chrome浏览器的地址栏中输入：chrome:&#47;&#47;tracing<br>之后点击左上角的load加载你生成的test.log.html文件就可以正常查看。","like_count":9},{"had_liked":false,"id":52271,"user_name":"天蓝若空","can_delete":false,"product_type":"c1","uid":1134751,"ip_address":"","ucode":"28E56D6E36537A","user_header":"https://static001.geekbang.org/account/avatar/00/11/50/9f/28a206c8.jpg","comment_is_top":false,"comment_ctime":1545356564,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"35905094932","product_id":100021101,"comment_content":"请问下张老师，延迟拉起进程要怎么处理，在清单文件中四大组件有多进程，默认就初始化了所有的进程，这个有点不明白","like_count":8,"discussions":[{"author":{"id":1329463,"avatar":"https://static001.geekbang.org/account/avatar/00/14/49/37/6a10e3dd.jpg","nickname":"yk","note":"","ucode":"C1BFF39DABD812","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":340488,"discussion_content":"除了provider是在onAttachContent中初始化的，其他三大组件都是启动之后对应的进程才会起来的","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1610015883,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":51950,"user_name":"Kenny","can_delete":false,"product_type":"c1","uid":1234061,"ip_address":"","ucode":"E57D67DCE27967","user_header":"https://static001.geekbang.org/account/avatar/00/12/d4/8d/a3fd8957.jpg","comment_is_top":false,"comment_ctime":1545280629,"is_pvip":false,"discussion_count":3,"race_medal":0,"score":"27315084405","product_id":100021101,"comment_content":"张老师，你好，我们在做了启动优化跟张老师所说90%相同，目前情况来看也取得了50%<br>以上的启动速度提升，但是我们想做更加极致，现在发现有些手机有jit线程，这个在启动过程中占了大量的cpu时间片，我也翻看了源码，发现这个线程是在activitythread里面初始化的，是一个jvm线程，请问张老师，这个有方案关闭吗？","like_count":6,"discussions":[{"author":{"id":1330065,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/N0NACGUr8dNAbN6BdiagPHBaB0EnyDsI9zWpwJteqTY38apOEnTOA7JkBAQnzYKJBgxu3Q8YMUILwLAB6camn4w/132","nickname":"Swing","note":"","ucode":"55FCA9ECEFBBEB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":224602,"discussion_content":"这个不能关。。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586318230,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1419779,"avatar":"https://static001.geekbang.org/account/avatar/00/15/aa/03/c984e2b6.jpg","nickname":"杰","note":"","ucode":"0BC2A9775169DD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":155099,"discussion_content":"未做编译预优化，关闭jit会后续启动会很慢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580215167,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1330090,"avatar":"https://static001.geekbang.org/account/avatar/00/14/4b/aa/05605f52.jpg","nickname":"柏拉图式的黑洞","note":"","ucode":"3040B4710F55A5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":7717,"discussion_content":"jit好像可以通过编译的时候配置关闭？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567650458,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":54844,"user_name":"山鬼","can_delete":false,"product_type":"c1","uid":1344110,"ip_address":"","ucode":"8A6AA48BB8D510","user_header":"https://static001.geekbang.org/account/avatar/00/14/82/6e/f552d036.jpg","comment_is_top":false,"comment_ctime":1545969205,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"23020805685","product_id":100021101,"comment_content":"老师，示例的tranfrom注册方法和直接调用registerTransform有什么区别吗？这块不是太懂","like_count":5},{"had_liked":false,"id":76180,"user_name":"menty","can_delete":false,"product_type":"c1","uid":1379491,"ip_address":"","ucode":"6B03C6D686907F","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKw77qmuyx5tPjGznNo7DmKvpU688GpazMQtfdafxj6Z0MSviaIlBtuEs2ibtYxCmibfWpOkKIoXibiavA/132","comment_is_top":false,"comment_ctime":1552545302,"is_pvip":false,"replies":[{"id":"31111","content":"这个是在pc的shell环境下执行的，不是在手机的shell里执行的，然后这个脚本的地址在AndroidSdk\\platform-tools\\systrace 下","user_name":"作者回复","user_name_real":"孙鹏飞","uid":"1171070","ctime":1555397608,"ip_address":"","comment_id":76180,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14437447190","product_id":100021101,"comment_content":"python systrace.py --list-cate...<br>请问这种命令在什么环境运行，试了在adb shell中运行不了","like_count":4,"discussions":[{"author":{"id":1171070,"avatar":"https://static001.geekbang.org/account/avatar/00/11/de/7e/5c2b1efe.jpg","nickname":"孙鹏飞","note":"","ucode":"18ADF5C2B78938","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":443208,"discussion_content":"这个是在pc的shell环境下执行的，不是在手机的shell里执行的，然后这个脚本的地址在AndroidSdk\\platform-tools\\systrace 下","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1555397608,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":1}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":70726,"user_name":"马志峰","can_delete":false,"product_type":"c1","uid":1107556,"ip_address":"","ucode":"2B84A7CA8000D9","user_header":"https://static001.geekbang.org/account/avatar/00/10/e6/64/13af2c3a.jpg","comment_is_top":false,"comment_ctime":1551169973,"is_pvip":true,"replies":[{"id":"25268","content":"需要，特别是后台线程优先级过高，导致系统真繁忙时的主线程卡顿。可以去看每个线程的utime stime","user_name":"作者回复","user_name_real":"张绍文","uid":"1009577","ctime":1551185967,"ip_address":"","comment_id":70726,"utype":1}],"discussion_count":1,"race_medal":1,"score":"14436071861","product_id":100021101,"comment_content":"王老师，请问线程的优先级是否需要考虑？","like_count":3,"discussions":[{"author":{"id":1009577,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/67/a9/e251ace7.jpg","nickname":"张绍文","note":"","ucode":"94B49E5F80BFDE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440797,"discussion_content":"需要，特别是后台线程优先级过高，导致系统真繁忙时的主线程卡顿。可以去看每个线程的utime stime","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551185967,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":52246,"user_name":"人生如歌","can_delete":false,"product_type":"c1","uid":1072897,"ip_address":"","ucode":"079135DC45B414","user_header":"https://static001.geekbang.org/account/avatar/00/10/5f/01/d3a1eb4d.jpg","comment_is_top":false,"comment_ctime":1545354102,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"10135288694","product_id":100021101,"comment_content":"你好，下面的说法:在启动过程也不要过早地拉起应用的其他进程，System Server 和新的进程都会竞争 CPU 资源。有点疑惑<br>按道理开机启动拉起新进程是监听开机广播后拉起的，而SystemServer中的service启动完了之后才会发送开机广播；当然，如果是因为监听开机广播的进程太多，导致过多的请求SystemServer中的AMS，也会导致新进程与System Server竞争cpu资源<br>另外，再请教一个问题，像微信这种国民级应用，系统很难杀死，因为几乎看不到微信启动的过程，一打开就出现了聊天界面，是不是各大厂商都有对他进行特殊保活，还是因为设置了更低的adj值导致系统不杀呢？谢谢","like_count":2,"discussions":[{"author":{"id":2342666,"avatar":"https://static001.geekbang.org/account/avatar/00/23/bf/0a/7845315c.jpg","nickname":"Matrix-Neo","note":"","ucode":"ADE671713889C8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":329403,"discussion_content":"厂商有保活","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1606380105,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":76559,"user_name":"66","can_delete":false,"product_type":"c1","uid":1234711,"ip_address":"","ucode":"616F01B886475B","user_header":"https://static001.geekbang.org/account/avatar/00/12/d7/17/cddc5f3a.jpg","comment_is_top":false,"comment_ctime":1552632454,"is_pvip":false,"replies":[{"id":"28186","content":"主要还是以主线程的耗时为主，看它会不会因为锁，空转，被抢占，或者本身慢，导致界面刷出来慢了","user_name":"作者回复","user_name_real":"张绍文","uid":"1009577","ctime":1552916762,"ip_address":"","comment_id":76559,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5847599750","product_id":100021101,"comment_content":"请问对于生成的trace文件，分析的重点应该是在哪几个指标？界面上指标参数有点多","like_count":1,"discussions":[{"author":{"id":1009577,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/67/a9/e251ace7.jpg","nickname":"张绍文","note":"","ucode":"94B49E5F80BFDE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":443355,"discussion_content":"主要还是以主线程的耗时为主，看它会不会因为锁，空转，被抢占，或者本身慢，导致界面刷出来慢了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1552916762,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":62231,"user_name":"信仰年轻","can_delete":false,"product_type":"c1","uid":1329011,"ip_address":"","ucode":"B2BD881D25FCDD","user_header":"https://static001.geekbang.org/account/avatar/00/14/47/73/63a3cb41.jpg","comment_is_top":false,"comment_ctime":1547989095,"is_pvip":false,"replies":[{"id":"23109","content":"可以看看其他人的答案","user_name":"作者回复","user_name_real":"张绍文","uid":"1009577","ctime":1549102544,"ip_address":"","comment_id":62231,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5842956391","product_id":100021101,"comment_content":"Unable to select a master clock domain because no path can be found from &quot;SYSTRACE&quot; to &quot;LINUX_FTRACE_GLOBAL  老师，我查看生成的test.log.html报这个错误啊","like_count":1,"discussions":[{"author":{"id":1009577,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/67/a9/e251ace7.jpg","nickname":"张绍文","note":"","ucode":"94B49E5F80BFDE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437147,"discussion_content":"可以看看其他人的答案","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1549102544,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":54908,"user_name":"奚岩","can_delete":false,"product_type":"c1","uid":1107769,"ip_address":"","ucode":"E7D3A56216EE47","user_header":"https://static001.geekbang.org/account/avatar/00/10/e7/39/b47b1bc0.jpg","comment_is_top":false,"comment_ctime":1545980421,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5840947717","product_id":100021101,"comment_content":"sample 跑在真机出现下面错误：<br>Unable to select a master clock domain because no path can be found from &quot;SYSTRACE&quot; to &quot;LINUX_FTRACE_GLOBAL&quot;.<br><br>换模拟器好了，有遇见类似的么😂","like_count":1},{"had_liked":false,"id":54804,"user_name":"无知","can_delete":false,"product_type":"c1","uid":1329204,"ip_address":"","ucode":"905803028D8980","user_header":"https://static001.geekbang.org/account/avatar/00/14/48/34/40cb22a7.jpg","comment_is_top":false,"comment_ctime":1545964074,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5840931370","product_id":100021101,"comment_content":"虽然更新的很慢，但是我还是没有跟上节奏。前几篇都没有跑起来，今天的才真正的按照老师说的做了一次，加油。","like_count":1},{"had_liked":false,"id":52544,"user_name":"朱蓝天","can_delete":false,"product_type":"c1","uid":1330847,"ip_address":"","ucode":"61402573C38C7D","user_header":"https://static001.geekbang.org/account/avatar/00/14/4e/9f/ece713ac.jpg","comment_is_top":false,"comment_ctime":1545413162,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5840380458","product_id":100021101,"comment_content":"没有闪屏页面的APP情何以堪，老板还要求用户在没有闪屏过渡的情况下做到无感知启动。。","like_count":1},{"had_liked":false,"id":352090,"user_name":"Geek_eea446","can_delete":false,"product_type":"c1","uid":2823750,"ip_address":"","ucode":"A1AF5D0188EA5C","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/PrUDxP61MBnVAMWsKUPLYuPh5LkWc9wcYze7Lia0XpXgoJAI5eR2pavIQCVdqYQmM39SFJJNlYgdbKiaPGCU1vEA/132","comment_is_top":false,"comment_ctime":1658382241,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1658382241","product_id":100021101,"comment_content":"我这么理解，预览窗口是starting window，想请教下闪屏页是什么","like_count":0},{"had_liked":false,"id":263118,"user_name":"Lilee","can_delete":false,"product_type":"c1","uid":1183091,"ip_address":"","ucode":"2CA6914B79EB2D","user_header":"https://static001.geekbang.org/account/avatar/00/12/0d/73/01598bd5.jpg","comment_is_top":false,"comment_ctime":1606012968,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1606012968","product_id":100021101,"comment_content":"老师，文中提到的预览窗口是个activity吗？如果不是的话，怎么在theme中设置？我找了一下，好似没有这方面的方法。","like_count":0},{"had_liked":false,"id":263077,"user_name":"曹晶","can_delete":false,"product_type":"c1","uid":1003884,"ip_address":"","ucode":"C15CF8030DEED1","user_header":"https://static001.geekbang.org/account/avatar/00/0f/51/6c/26890599.jpg","comment_is_top":false,"comment_ctime":1605971610,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1605971610","product_id":100021101,"comment_content":"张老师，我把插件集成到我们项目里，发现这几个问题，求解答：<br>1. 抓trace和比不抓trace，app本身性能差了不少，明显卡顿很多。比较报告中掉帧的情况也明显差，在RenderThread上明显都耗时很多，这是什么原因？<br>2. 想抓启动的trace，发现生成报告失败，报错是MemoryError()，求教是什么原因，难道超了Python内存了？","like_count":0,"discussions":[{"author":{"id":1488594,"avatar":"https://static001.geekbang.org/account/avatar/00/16/b6/d2/294aad1b.jpg","nickname":"处下","note":"","ucode":"8CA4014BF99BCB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":531337,"discussion_content":"大佬 我集成进自己项目后。编译后没有生成插桩后的class。你们有遇到吗 ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637288942,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"user_type\":1}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":226817,"user_name":"wind","can_delete":false,"product_type":"c1","uid":1183721,"ip_address":"","ucode":"7FB9F4E3418ADA","user_header":"https://static001.geekbang.org/account/avatar/00/12/0f/e9/9f9202e8.jpg","comment_is_top":false,"comment_ctime":1592209618,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1592209618","product_id":100021101,"comment_content":"systrace + 函数插桩 生成的文件导入chrome后应该如何查看呢？","like_count":0},{"had_liked":false,"id":158166,"user_name":"this is it","can_delete":false,"product_type":"c1","uid":1714099,"ip_address":"","ucode":"C431302C248B12","user_header":"https://static001.geekbang.org/account/avatar/00/1a/27/b3/e9c55f7c.jpg","comment_is_top":false,"comment_ctime":1575341301,"is_pvip":false,"replies":[{"id":"62059","content":"主要看出现了什么问题","user_name":"作者回复","user_name_real":"张绍文","uid":"1009577","ctime":1576680478,"ip_address":"","comment_id":158166,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1575341301","product_id":100021101,"comment_content":"请问Sample如何移植到自己的项目中去，我尝试移植一直不成功，还请能给出详细的移植操作步骤，感谢！","like_count":0,"discussions":[{"author":{"id":1009577,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/67/a9/e251ace7.jpg","nickname":"张绍文","note":"","ucode":"94B49E5F80BFDE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":476647,"discussion_content":"主要看出现了什么问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576680478,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1003884,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/51/6c/26890599.jpg","nickname":"曹晶","note":"","ucode":"C15CF8030DEED1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":325846,"discussion_content":"我也想移植，但是移植过去后发现连原来的trace都抓不到了。\ndebugable页对的，反编译看也插成功了，但就是抓不到","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605443597,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":151068,"user_name":"希夷","can_delete":false,"product_type":"c1","uid":1028673,"ip_address":"","ucode":"2E3E86AC7A19EC","user_header":"https://static001.geekbang.org/account/avatar/00/0f/b2/41/d9dcc7ef.jpg","comment_is_top":false,"comment_ctime":1573650381,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1573650381","product_id":100021101,"comment_content":"apk release包可以使用systrace么？我在项目里边，使用debug版本的apk生成的html有每个方法的tag，但是release版本没有","like_count":0},{"had_liked":false,"id":146894,"user_name":"勇敢地追","can_delete":false,"product_type":"c1","uid":1497082,"ip_address":"","ucode":"29B94AC2ABC2BB","user_header":"","comment_is_top":false,"comment_ctime":1572692180,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1572692180","product_id":100021101,"comment_content":"启动优化以前搞过，就是用TraceView将CPU&#47;Call从1000左右降到400左右，缩短app打开时间。看来还有好多东西，值得好好学习","like_count":0},{"had_liked":false,"id":131801,"user_name":"龙衣","can_delete":false,"product_type":"c1","uid":1076853,"ip_address":"","ucode":"8061EB2F254161","user_header":"https://static001.geekbang.org/account/avatar/00/10/6e/75/d8445043.jpg","comment_is_top":false,"comment_ctime":1567911846,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1567911846","product_id":100021101,"comment_content":"运行python $ANDROID_HOME&#47;platform-tools&#47;systrace&#47;systrace.py gfx view wm am pm ss dalvik app sched -b 90960 -a com.sample.systrace  -o test.log.html<br>提示 Systrace does not support Python 3.7. Please use Python 2.7.<br>python 环境问题有什么办法解决吗？","like_count":0},{"had_liked":false,"id":129232,"user_name":"未央","can_delete":false,"product_type":"c1","uid":1189625,"ip_address":"","ucode":"83409C7A7ADF0E","user_header":"https://static001.geekbang.org/account/avatar/00/12/26/f9/a0b24fac.jpg","comment_is_top":false,"comment_ctime":1567066969,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1567066969","product_id":100021101,"comment_content":"test.log.html会在什么位置生成，也是systrace_output文件夹下面吗","like_count":0},{"had_liked":false,"id":100408,"user_name":"Geek_6061ea","can_delete":false,"product_type":"c1","uid":1124903,"ip_address":"","ucode":"5C017923512BE4","user_header":"https://static001.geekbang.org/account/avatar/00/11/2a/27/1dd7f2a2.jpg","comment_is_top":false,"comment_ctime":1559550492,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1559550492","product_id":100021101,"comment_content":"运行：python C:\\Users\\Administrator\\AppData\\Local\\Android\\Sdk\\platform-tools\\systrace\\systrace.py gfx view wm am pm ss dalvik app sched -b 90960 -a com.sample.systrace -o test.html 后报错：<br>ValueError: invalid literal for int() with base 10: &#39;&#39;<br>","like_count":0},{"had_liked":false,"id":78086,"user_name":"磊","can_delete":false,"product_type":"c1","uid":1121671,"ip_address":"","ucode":"D68191F49FCD6E","user_header":"https://static001.geekbang.org/account/avatar/00/11/1d/87/c291de43.jpg","comment_is_top":false,"comment_ctime":1553069160,"is_pvip":false,"replies":[{"id":"31136","content":"每个应用的启动结束点都不一样，基本不会是闪屏的时候。所以一般都是应用内部自己的启动统计框架","user_name":"作者回复","user_name_real":"张绍文","uid":"1009577","ctime":1555401912,"ip_address":"","comment_id":78086,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1553069160","product_id":100021101,"comment_content":"hi 老师，代码如何计算启动耗时啊？ad shell am start -W 计算规则怎么看的？","like_count":0,"discussions":[{"author":{"id":1009577,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/67/a9/e251ace7.jpg","nickname":"张绍文","note":"","ucode":"94B49E5F80BFDE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":443962,"discussion_content":"每个应用的启动结束点都不一样，基本不会是闪屏的时候。所以一般都是应用内部自己的启动统计框架","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1555401912,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":77372,"user_name":"Egos","can_delete":false,"product_type":"c1","uid":1071143,"ip_address":"","ucode":"9F0055B140E935","user_header":"https://static001.geekbang.org/account/avatar/00/10/58/27/1188e017.jpg","comment_is_top":false,"comment_ctime":1552913991,"is_pvip":false,"replies":[{"id":"28181","content":"Systrace和traceview都可以把","user_name":"作者回复","user_name_real":"张绍文","uid":"1009577","ctime":1552916542,"ip_address":"","comment_id":77372,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1552913991","product_id":100021101,"comment_content":"张老师，你好！我们app 统计耗时和文章说的差不多，在主页onWindowFocusChanged 时计算最终时长。分析的时候发现在主页onResume 和onWindowFocusChanged 之间的时间差很大，看了源代码以后发现onResume 和onWindowFocusChanged 之间会执行ViewRootImpl#performMeasure，但是performMeasure 也远小于他们的时间差(大概小了1倍)。这种情况该怎么去分析呢，有办法dump 这段时间有什么耗时操作？","like_count":0,"discussions":[{"author":{"id":1009577,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/67/a9/e251ace7.jpg","nickname":"张绍文","note":"","ucode":"94B49E5F80BFDE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":443703,"discussion_content":"Systrace和traceview都可以把","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1552916542,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":74756,"user_name":"Neil","can_delete":false,"product_type":"c1","uid":1206345,"ip_address":"","ucode":"909A2103DFEE1B","user_header":"https://static001.geekbang.org/account/avatar/00/12/68/49/418a9486.jpg","comment_is_top":false,"comment_ctime":1552292758,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1552292758","product_id":100021101,"comment_content":"Unable to select a master clock domain because no path can be found from &quot;SYSTRACE&quot; to &quot;LINUX_FTRACE_GLOBAL&quot;.<br> 这个是什么意思","like_count":0},{"had_liked":false,"id":70097,"user_name":"炸山哥","can_delete":false,"product_type":"c1","uid":1345038,"ip_address":"","ucode":"A8608D28174447","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoSMRiaMtAcqQ81wsudfqcVOdLmQYwjyZgzDPhhdBMEvIA2jasd8tU9S8kUebdov6M6CwlibwRL31Hw/132","comment_is_top":false,"comment_ctime":1550994301,"is_pvip":false,"replies":[{"id":"31069","content":"因为我们是想修改原来transform的逻辑，通过hook的方式可以控制的更好，而且关键还有时序的问题。","user_name":"作者回复","user_name_real":"张绍文","uid":"1009577","ctime":1555395483,"ip_address":"","comment_id":70097,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1550994301","product_id":100021101,"comment_content":"张老师，请问project.getProperties().get(&quot;android&quot;).registerTransform跟示例的注册Transform方式哪一种更好点呢？我见上面也有人问了同样的问题。","like_count":0,"discussions":[{"author":{"id":1009577,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/67/a9/e251ace7.jpg","nickname":"张绍文","note":"","ucode":"94B49E5F80BFDE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440438,"discussion_content":"因为我们是想修改原来transform的逻辑，通过hook的方式可以控制的更好，而且关键还有时序的问题。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1555395483,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":56848,"user_name":"greg","can_delete":false,"product_type":"c1","uid":1189197,"ip_address":"","ucode":"BEE952C7ED2C84","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/0o2FEeJiav8lK9Y49JUOBretDypyHic2FL9dSZYnweBPZ5ibm3vgfm3q7kgXmQEOGOLJFgPEcMweVFj5QTrt4Vb4g/132","comment_is_top":false,"comment_ctime":1546567400,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1546567400","product_id":100021101,"comment_content":"张老师， https:&#47;&#47;mp.weixin.qq.com&#47;s&#47;6Q818XA5FaHd7jJMFBG60w? 这篇文章中写到的 改变通信方式 部分，注册接口和访问接口是怎样的一个实现？  没有看懂。","like_count":0},{"had_liked":false,"id":56405,"user_name":"iniesta2014","can_delete":false,"product_type":"c1","uid":1128692,"ip_address":"","ucode":"D978A8CF0B40E2","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKE7KHyLv1Zian5yzyby3ricSClVp0wwia8evbicGPH9icSAVYHhREVO39CtcHc77x05XONNK61JXoNXfg/132","comment_is_top":false,"comment_ctime":1546438715,"is_pvip":false,"replies":[{"id":"20362","content":"是6.0以下的手机吗？<br><br>可以这样使用<br>cd &amp;ANDROID_HOME&#47;tools <br>.&#47;monitor<br><br>直接使用android monitor来进行systrace<br>","user_name":"作者回复","user_name_real":"张绍文","uid":"1009577","ctime":1546480965,"ip_address":"","comment_id":56405,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1546438715","product_id":100021101,"comment_content":" 使用此插件集成到项目里面，然后打开生成的trace.html ，报了“Unable to select a master clock domain because no path can be found from &quot;SYSTRACE&quot; to &quot;LINUX_FTRACE_GLOBAL&quot;. 关闭插件可以正常查看trace.html 。前面也有人遇到了","like_count":0,"discussions":[{"author":{"id":1009577,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/67/a9/e251ace7.jpg","nickname":"张绍文","note":"","ucode":"94B49E5F80BFDE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435023,"discussion_content":"是6.0以下的手机吗？\n\n可以这样使用\ncd &amp;amp;ANDROID_HOME/tools \n./monitor\n\n直接使用android monitor来进行systrace\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546480965,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":56317,"user_name":"Moruna","can_delete":false,"product_type":"c1","uid":1334794,"ip_address":"","ucode":"7B3F80C85C36C2","user_header":"https://static001.geekbang.org/account/avatar/00/14/5e/0a/cee81344.jpg","comment_is_top":false,"comment_ctime":1546420529,"is_pvip":false,"replies":[{"id":"20278","content":"改一下路径就可以，或者直接用monitor","user_name":"作者回复","user_name_real":"张绍文","uid":"1009577","ctime":1546424861,"ip_address":"","comment_id":56317,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1546420529","product_id":100021101,"comment_content":"张老师，Sample涉及的操作都是在linux系统下执行的吗？windows跑有问题<br>python $ANDROID_HOME&#47;platform-tools&#47;systrace&#47;systrace.py gfx view wm am pm ss dalvik app sched -b 90960 -a com.sample.systrace  -o test.log.html<br>报错","like_count":0,"discussions":[{"author":{"id":1009577,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/67/a9/e251ace7.jpg","nickname":"张绍文","note":"","ucode":"94B49E5F80BFDE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434984,"discussion_content":"改一下路径就可以，或者直接用monitor","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546424861,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":54580,"user_name":"Kyleจุ๊บ","can_delete":false,"product_type":"c1","uid":1336463,"ip_address":"","ucode":"891F2B8A5C9090","user_header":"https://static001.geekbang.org/account/avatar/00/14/64/8f/4afeafd6.jpg","comment_is_top":false,"comment_ctime":1545905196,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1545905196","product_id":100021101,"comment_content":"虽然用了代理，但是我在运行gradle task &quot;:systrace-gradle-plugin:buildAndPublishToLocalMaven&quot;时也出现这个问题<br>* What went wrong:<br>A problem occurred evaluating root project &#39;Chapter07&#39;.<br>&gt; Could not find method google() for arguments [] on repository container.<br><br>将google()删掉，会报Could not find com.android.tools.build:gradle:3.0.1.<br>","like_count":0},{"had_liked":false,"id":53413,"user_name":"龙在天涯","can_delete":false,"product_type":"c1","uid":1152745,"ip_address":"","ucode":"EBD41F33DC98F0","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/BicH0Lne3tjR0QwEIz0tsoZ6LgfHjtGbZFnP553XpfO9h7VvpGNrOBF1cOMwiccicM1uuLubLeruZsMvEialjpCtSQ/132","comment_is_top":false,"comment_ctime":1545640318,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1545640318","product_id":100021101,"comment_content":"运行demo生成trace，打开test.log.html报下面的错是什么原因","like_count":0},{"had_liked":false,"id":53391,"user_name":"戴寅华","can_delete":false,"product_type":"c1","uid":1330189,"ip_address":"","ucode":"5E2CBAEE637CA0","user_header":"https://static001.geekbang.org/account/avatar/00/14/4c/0d/0f7450e6.jpg","comment_is_top":false,"comment_ctime":1545637472,"is_pvip":false,"replies":[{"id":"19343","content":"这个是google的maven库，连个代理看看？或者把build.gradle的google()删掉，换成其他替代的","user_name":"作者回复","user_name_real":"张绍文","uid":"1009577","ctime":1545645139,"ip_address":"","comment_id":53391,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1545637472","product_id":100021101,"comment_content":"张老师您好，在练习Sample，操作运行gradle task &quot;:systrace-gradle-plugin:buildAndPublishToLocalMaven&quot; 编译plugin插件后，提示了Could not find method google() for arguments [] on repository container. 望指点迷津，谢谢","like_count":0,"discussions":[{"author":{"id":1009577,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/67/a9/e251ace7.jpg","nickname":"张绍文","note":"","ucode":"94B49E5F80BFDE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434125,"discussion_content":"这个是google的maven库，连个代理看看？或者把build.gradle的google()删掉，换成其他替代的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545645139,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":52021,"user_name":"IOT..Yang","can_delete":false,"product_type":"c1","uid":1240343,"ip_address":"","ucode":"11589D83B67FE9","user_header":"https://static001.geekbang.org/account/avatar/00/12/ed/17/c3eb014f.jpg","comment_is_top":false,"comment_ctime":1545295733,"is_pvip":false,"replies":[{"id":"18853","content":"可以更新一下sample解决了这个问题，如果不加入白名单会导致死循环了，因为在插桩的类里面又插了函数。<br><br>那个plugin是用asm来插桩的","user_name":"作者回复","user_name_real":"张绍文","uid":"1009577","ctime":1545308932,"ip_address":"","comment_id":52021,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1545295733","product_id":100021101,"comment_content":"运行sample时，会一直白屏卡住了，看comment中有人说需要把TraceTag也配置到blackMethodList里（为什么这样做？），的确如此，配置一下就OK了，成功生成了trace.html文件，但目前对这个不太熟悉，里面看得有点懵，今天学习了好长时间，大概了解了些基础，我想问下张哥systrace-gradle-plugin插件库有什么作用，我看官网主要介绍systrace和Trace的使用。<br><br>正好最近要优化app启动时间，纸上得来总觉浅，绝知此事要躬行，fighting！","like_count":0,"discussions":[{"author":{"id":1009577,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/67/a9/e251ace7.jpg","nickname":"张绍文","note":"","ucode":"94B49E5F80BFDE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433702,"discussion_content":"可以更新一下sample解决了这个问题，如果不加入白名单会导致死循环了，因为在插桩的类里面又插了函数。\n\n那个plugin是用asm来插桩的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545308932,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":52010,"user_name":"kchang244","can_delete":false,"product_type":"c1","uid":1340874,"ip_address":"","ucode":"18CCF5B7436F15","user_header":"","comment_is_top":false,"comment_ctime":1545293236,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1545293236","product_id":100021101,"comment_content":"请问网络加载方面的优化后面会讲吗？谢谢","like_count":0},{"had_liked":false,"id":51894,"user_name":"catkin","can_delete":false,"product_type":"c1","uid":1127815,"ip_address":"","ucode":"2E7ECACBC30CEC","user_header":"https://static001.geekbang.org/account/avatar/00/11/35/87/b2a1e5cc.jpg","comment_is_top":false,"comment_ctime":1545274368,"is_pvip":false,"replies":[{"id":"19026","content":"这块内容确实复杂一些，资料也少，不过源码是最好的文档","user_name":"作者回复","user_name_real":"孙鹏飞","uid":"1171070","ctime":1545368700,"ip_address":"","comment_id":51894,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1545274368","product_id":100021101,"comment_content":"终于看到稍微简单的了，前面理解真的很难，看breakpad源码，和inline hook真的难死了，才明白一点点，还得继续努力啊！到java这块还是很简单了，自信又回来了！那么多hook技术啥时候讲讲呗！","like_count":0,"discussions":[{"author":{"id":1171070,"avatar":"https://static001.geekbang.org/account/avatar/00/11/de/7e/5c2b1efe.jpg","nickname":"孙鹏飞","note":"","ucode":"18ADF5C2B78938","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433664,"discussion_content":"这块内容确实复杂一些，资料也少，不过源码是最好的文档","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545368700,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":1}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":51874,"user_name":"热心网友","can_delete":false,"product_type":"c1","uid":1329547,"ip_address":"","ucode":"8779205D59C409","user_header":"https://static001.geekbang.org/account/avatar/00/14/49/8b/844e70df.jpg","comment_is_top":false,"comment_ctime":1545272756,"is_pvip":false,"replies":[{"id":"18808","content":"对，我修改一下，改了一下包名忘了更新了","user_name":"作者回复","user_name_real":"张绍文","uid":"1009577","ctime":1545278182,"ip_address":"","comment_id":51874,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1545272756","product_id":100021101,"comment_content":"张老师，Simple启动就StackOverflowError了，是不是需要把TraceTag也配置到blackMethodList里","like_count":0,"discussions":[{"author":{"id":1009577,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/67/a9/e251ace7.jpg","nickname":"张绍文","note":"","ucode":"94B49E5F80BFDE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433658,"discussion_content":"对，我修改一下，改了一下包名忘了更新了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545278182,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":51836,"user_name":"Carlitos丶胖胖","can_delete":false,"product_type":"c1","uid":1329560,"ip_address":"","ucode":"FA0EF229441231","user_header":"https://static001.geekbang.org/account/avatar/00/14/49/98/9e23d25f.jpg","comment_is_top":false,"comment_ctime":1545268685,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1545268685","product_id":100021101,"comment_content":"学习了","like_count":0},{"had_liked":false,"id":51824,"user_name":"从前有只🐻","can_delete":false,"product_type":"c1","uid":1110417,"ip_address":"","ucode":"F8C9805E00A746","user_header":"https://static001.geekbang.org/account/avatar/00/10/f1/91/4bbc7f73.jpg","comment_is_top":false,"comment_ctime":1545267499,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1545267499","product_id":100021101,"comment_content":"文章每一句话可能就包含一个新的知识点，确实需要课后补充自学的点还是很多的，加油吧","like_count":0},{"had_liked":false,"id":51819,"user_name":"金樽明月","can_delete":false,"product_type":"c1","uid":1014542,"ip_address":"","ucode":"127A360FE0DB88","user_header":"https://static001.geekbang.org/account/avatar/00/0f/7b/0e/6d4109ee.jpg","comment_is_top":false,"comment_ctime":1545267218,"is_pvip":false,"replies":[{"id":"18776","content":"其实都一样，关键是搞懂难在哪里，然后指定策略，类似预加载，增加并发。<br><br>我们有类似的框架，但是我们做的比较底层是直接修改内部的一些代码","user_name":"作者回复","user_name_real":"张绍文","uid":"1009577","ctime":1545269819,"ip_address":"","comment_id":51819,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1545267218","product_id":100021101,"comment_content":"你好，能讲一下 React Native 应用的具体优化吗？由于启动时要启动很多RN的东西，所以比一般的安卓应用慢了好多……最近一直在愁","like_count":0,"discussions":[{"author":{"id":1009577,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/67/a9/e251ace7.jpg","nickname":"张绍文","note":"","ucode":"94B49E5F80BFDE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433633,"discussion_content":"其实都一样，关键是搞懂难在哪里，然后指定策略，类似预加载，增加并发。\n\n我们有类似的框架，但是我们做的比较底层是直接修改内部的一些代码","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545269819,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}