{"id":68964,"title":"38 | 从外界连通Service与Service调试“三板斧”","content":"<p>你好，我是张磊。今天我和你分享的主题是：从外界连通Service与Service调试“三板斧”。</p><p>在上一篇文章中，我为你介绍了Service机制的工作原理。通过这些讲解，你应该能够明白这样一个事实：Service的访问信息在Kubernetes集群之外，其实是无效的。</p><p>这其实也容易理解：所谓Service的访问入口，其实就是每台宿主机上由kube-proxy生成的iptables规则，以及kube-dns生成的DNS记录。而一旦离开了这个集群，这些信息对用户来说，也就自然没有作用了。</p><p>所以，在使用Kubernetes的Service时，一个必须要面对和解决的问题就是：<strong>如何从外部（Kubernetes集群之外），访问到Kubernetes里创建的Service？</strong></p><p>这里<span class=\"orange\">最常用的一种方式就是：NodePort</span>。我来为你举个例子。</p><pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: my-nginx\n  labels:\n    run: my-nginx\nspec:\n  type: NodePort\n  ports:\n  - nodePort: 8080\n    targetPort: 80\n    protocol: TCP\n    name: http\n  - nodePort: 443\n    protocol: TCP\n    name: https\n  selector:\n    run: my-nginx\n</code></pre><p>在这个Service的定义里，我们声明它的类型是，type=NodePort。然后，我在ports字段里声明了Service的8080端口代理Pod的80端口，Service的443端口代理Pod的443端口。</p><p>当然，如果你不显式地声明nodePort字段，Kubernetes就会为你分配随机的可用端口来设置代理。这个端口的范围默认是30000-32767，你可以通过kube-apiserver的–service-node-port-range参数来修改它。</p><!-- [[[read_end]]] --><p>那么这时候，要访问这个Service，你只需要访问：</p><pre><code>&lt;任何一台宿主机的IP地址&gt;:8080\n</code></pre><p>就可以访问到某一个被代理的Pod的80端口了。</p><p>而在理解了我在上一篇文章中讲解的Service的工作原理之后，NodePort模式也就非常容易理解了。显然，kube-proxy要做的，就是在每台宿主机上生成这样一条iptables规则：</p><pre><code>-A KUBE-NODEPORTS -p tcp -m comment --comment &quot;default/my-nginx: nodePort&quot; -m tcp --dport 8080 -j KUBE-SVC-67RL4FN6JRUPOJYM\n</code></pre><p>而我在上一篇文章中已经讲到，KUBE-SVC-67RL4FN6JRUPOJYM其实就是一组随机模式的iptables规则。所以接下来的流程，就跟ClusterIP模式完全一样了。</p><p>需要注意的是，在NodePort方式下，Kubernetes会在IP包离开宿主机发往目的Pod时，对这个IP包做一次SNAT操作，如下所示：</p><pre><code>-A KUBE-POSTROUTING -m comment --comment &quot;kubernetes service traffic requiring SNAT&quot; -m mark --mark 0x4000/0x4000 -j MASQUERADE\n</code></pre><p>可以看到，这条规则设置在POSTROUTING检查点，也就是说，它给即将离开这台主机的IP包，进行了一次SNAT操作，将这个IP包的源地址替换成了这台宿主机上的CNI网桥地址，或者宿主机本身的IP地址（如果CNI网桥不存在的话）。</p><p>当然，这个SNAT操作只需要对Service转发出来的IP包进行（否则普通的IP包就被影响了）。而iptables做这个判断的依据，就是查看该IP包是否有一个“0x4000”的“标志”。你应该还记得，这个标志正是在IP包被执行DNAT操作之前被打上去的。</p><p>可是，<strong>为什么一定要对流出的包做SNAT<strong><strong>操作</strong></strong>呢？</strong></p><p>这里的原理其实很简单，如下所示：</p><pre><code>           client\n             \\ ^\n              \\ \\\n               v \\\n   node 1 &lt;--- node 2\n    | ^   SNAT\n    | |   ---&gt;\n    v |\n endpoint\n</code></pre><p>当一个外部的client通过node 2的地址访问一个Service的时候，node 2上的负载均衡规则，就可能把这个IP包转发给一个在node 1上的Pod。这里没有任何问题。</p><p>而当node 1上的这个Pod处理完请求之后，它就会按照这个IP包的源地址发出回复。</p><p>可是，如果没有做SNAT操作的话，这时候，被转发来的IP包的源地址就是client的IP地址。<strong>所以此时，Pod就会直接将回复发<strong><strong>给</strong></strong>client。</strong>对于client来说，它的请求明明发给了node 2，收到的回复却来自node 1，这个client很可能会报错。</p><p>所以，在上图中，当IP包离开node 2之后，它的源IP地址就会被SNAT改成node 2的CNI网桥地址或者node 2自己的地址。这样，Pod在处理完成之后就会先回复给node 2（而不是client），然后再由node 2发送给client。</p><p>当然，这也就意味着这个Pod只知道该IP包来自于node 2，而不是外部的client。对于Pod需要明确知道所有请求来源的场景来说，这是不可以的。</p><p>所以这时候，你就可以将Service的spec.externalTrafficPolicy字段设置为local，这就保证了所有Pod通过Service收到请求之后，一定可以看到真正的、外部client的源地址。</p><p>而这个机制的实现原理也非常简单：<strong>这时候，一台宿主机上的iptables规则，会设置为只将IP包转发给运行在这台宿主机上的Pod</strong>。所以这时候，Pod就可以直接使用源地址将回复包发出，不需要事先进行SNAT了。这个流程，如下所示：</p><pre><code>       client\n       ^ /   \\\n      / /     \\\n     / v       X\n   node 1     node 2\n    ^ |\n    | |\n    | v\n endpoint\n</code></pre><p>当然，这也就意味着如果在一台宿主机上，没有任何一个被代理的Pod存在，比如上图中的node 2，那么你使用node 2的IP地址访问这个Service，就是无效的。此时，你的请求会直接被DROP掉。</p><p><span class=\"orange\">从外部访问Service的第二种方式，适用于公有云上的Kubernetes服务。这时候，你可以指定一个LoadBalancer类型的Service</span>，如下所示：</p><pre><code>---\nkind: Service\napiVersion: v1\nmetadata:\n  name: example-service\nspec:\n  ports:\n  - port: 8765\n    targetPort: 9376\n  selector:\n    app: example\n  type: LoadBalancer\n</code></pre><p>在公有云提供的Kubernetes服务里，都使用了一个叫作CloudProvider的转接层，来跟公有云本身的 API进行对接。所以，在上述LoadBalancer类型的Service被提交后，Kubernetes就会调用CloudProvider在公有云上为你创建一个负载均衡服务，并且把被代理的Pod的IP地址配置给负载均衡服务做后端。</p><p><span class=\"orange\">而第三种方式，是Kubernetes在1.7之后支持的一个新特性，叫作ExternalName。</span>举个例子：</p><pre><code>kind: Service\napiVersion: v1\nmetadata:\n  name: my-service\nspec:\n  type: ExternalName\n  externalName: my.database.example.com\n</code></pre><p>在上述Service的YAML文件中，我指定了一个externalName=my.database.example.com的字段。而且你应该会注意到，这个YAML文件里不需要指定selector。</p><p>这时候，当你通过Service的DNS名字访问它的时候，比如访问：my-service.default.svc.cluster.local。那么，Kubernetes为你返回的就是<code>my.database.example.com</code>。所以说，ExternalName类型的Service，其实是在kube-dns里为你添加了一条CNAME记录。这时，访问my-service.default.svc.cluster.local就和访问my.database.example.com这个域名是一个效果了。</p><p>此外，Kubernetes的Service还允许你为Service分配公有IP地址，比如下面这个例子：</p><pre><code>kind: Service\napiVersion: v1\nmetadata:\n  name: my-service\nspec:\n  selector:\n    app: MyApp\n  ports:\n  - name: http\n    protocol: TCP\n    port: 80\n    targetPort: 9376\n  externalIPs:\n  - 80.11.12.10\n</code></pre><p>在上述Service中，我为它指定的externalIPs=80.11.12.10，那么此时，你就可以通过访问80.11.12.10:80访问到被代理的Pod了。不过，在这里Kubernetes要求externalIPs必须是至少能够路由到一个Kubernetes的节点。你可以想一想这是为什么。</p><p>实际上，<span class=\"orange\">在理解了Kubernetes Service机制的工作原理之后，很多与Service相关的问题，其实都可以通过分析Service在宿主机上对应的iptables规则（或者IPVS配置）得到解决。</span></p><p>比如，当你的Service没办法通过DNS访问到的时候。你就需要区分到底是Service本身的配置问题，还是集群的DNS出了问题。一个行之有效的方法，就是检查Kubernetes自己的Master节点的Service DNS是否正常：</p><pre><code># 在一个Pod里执行\n$ nslookup kubernetes.default\nServer:    10.0.0.10\nAddress 1: 10.0.0.10 kube-dns.kube-system.svc.cluster.local\n\nName:      kubernetes.default\nAddress 1: 10.0.0.1 kubernetes.default.svc.cluster.local\n</code></pre><p>如果上面访问kubernetes.default返回的值都有问题，那你就需要检查kube-dns的运行状态和日志了。否则的话，你应该去检查自己的 Service 定义是不是有问题。</p><p>而如果你的Service没办法通过ClusterIP访问到的时候，你首先应该检查的是这个Service是否有Endpoints：</p><pre><code>$ kubectl get endpoints hostnames\nNAME        ENDPOINTS\nhostnames   10.244.0.5:9376,10.244.0.6:9376,10.244.0.7:9376\n</code></pre><p>需要注意的是，如果你的Pod的readniessProbe没通过，它也不会出现在Endpoints列表里。</p><p>而如果Endpoints正常，那么你就需要确认kube-proxy是否在正确运行。在我们通过kubeadm部署的集群里，你应该看到kube-proxy输出的日志如下所示：</p><pre><code>I1027 22:14:53.995134    5063 server.go:200] Running in resource-only container &quot;/kube-proxy&quot;\nI1027 22:14:53.998163    5063 server.go:247] Using iptables Proxier.\nI1027 22:14:53.999055    5063 server.go:255] Tearing down userspace rules. Errors here are acceptable.\nI1027 22:14:54.038140    5063 proxier.go:352] Setting endpoints for &quot;kube-system/kube-dns:dns-tcp&quot; to [10.244.1.3:53]\nI1027 22:14:54.038164    5063 proxier.go:352] Setting endpoints for &quot;kube-system/kube-dns:dns&quot; to [10.244.1.3:53]\nI1027 22:14:54.038209    5063 proxier.go:352] Setting endpoints for &quot;default/kubernetes:https&quot; to [10.240.0.2:443]\nI1027 22:14:54.038238    5063 proxier.go:429] Not syncing iptables until Services and Endpoints have been received from master\nI1027 22:14:54.040048    5063 proxier.go:294] Adding new service &quot;default/kubernetes:https&quot; at 10.0.0.1:443/TCP\nI1027 22:14:54.040154    5063 proxier.go:294] Adding new service &quot;kube-system/kube-dns:dns&quot; at 10.0.0.10:53/UDP\nI1027 22:14:54.040223    5063 proxier.go:294] Adding new service &quot;kube-system/kube-dns:dns-tcp&quot; at 10.0.0.10:53/TCP\n</code></pre><p>如果kube-proxy一切正常，你就应该仔细查看宿主机上的iptables了。而<strong>一个iptables模式的Service对应的规则，我在上一篇以及这一篇文章里已经全部介绍到了，它们包括：</strong></p><ol>\n<li>\n<p>KUBE-SERVICES或者KUBE-NODEPORTS规则对应的Service的入口链，这个规则应该与VIP和Service端口一一对应；</p>\n</li>\n<li>\n<p>KUBE-SEP-(hash)规则对应的DNAT链，这些规则应该与Endpoints一一对应；</p>\n</li>\n<li>\n<p>KUBE-SVC-(hash)规则对应的负载均衡链，这些规则的数目应该与 Endpoints 数目一致；</p>\n</li>\n<li>\n<p>如果是NodePort模式的话，还有POSTROUTING处的SNAT链。</p>\n</li>\n</ol><p>通过查看这些链的数量、转发目的地址、端口、过滤条件等信息，你就能很容易发现一些异常的蛛丝马迹。</p><p>当然，<strong>还有一种典型问题，就是Pod没办法通过Service访问到自己</strong>。这往往就是因为kubelet的hairpin-mode没有被正确设置。关于Hairpin的原理我在前面已经介绍过，这里就不再赘述了。你只需要确保将kubelet的hairpin-mode设置为hairpin-veth或者promiscuous-bridge即可。</p><blockquote>\n<p>这里，你可以再回顾下第34篇文章<a href=\"https://time.geekbang.org/column/article/67351\">《Kubernetes网络模型与CNI网络插件》</a>中的相关内容。</p>\n</blockquote><p>其中，在hairpin-veth模式下，你应该能看到CNI 网桥对应的各个VETH设备，都将Hairpin模式设置为了1，如下所示：</p><pre><code>$ for d in /sys/devices/virtual/net/cni0/brif/veth*/hairpin_mode; do echo &quot;$d = $(cat $d)&quot;; done\n/sys/devices/virtual/net/cni0/brif/veth4bfbfe74/hairpin_mode = 1\n/sys/devices/virtual/net/cni0/brif/vethfc2a18c5/hairpin_mode = 1\n</code></pre><p>而如果是promiscuous-bridge模式的话，你应该看到CNI网桥的混杂模式（PROMISC）被开启，如下所示：</p><pre><code>$ ifconfig cni0 |grep PROMISC\nUP BROADCAST RUNNING PROMISC MULTICAST  MTU:1460  Metric:1\n</code></pre><h2>总结</h2><p>在本篇文章中，我为你详细讲解了从外部访问Service的三种方式（NodePort、LoadBalancer 和 External Name）和具体的工作原理。然后，我还为你讲述了当Service出现故障的时候，如何根据它的工作原理，按照一定的思路去定位问题的可行之道。</p><p>通过上述讲解不难看出，所谓Service，其实就是Kubernetes为Pod分配的、固定的、基于iptables（或者IPVS）的访问入口。而这些访问入口代理的Pod信息，则来自于Etcd，由kube-proxy通过控制循环来维护。</p><p>并且，你可以看到，Kubernetes里面的Service和DNS机制，也都不具备强多租户能力。比如，在多租户情况下，每个租户应该拥有一套独立的Service规则（Service只应该看到和代理同一个租户下的Pod）。再比如DNS，在多租户情况下，每个租户应该拥有自己的kube-dns（kube-dns只应该为同一个租户下的Service和Pod创建DNS Entry）。</p><p>当然，在Kubernetes中，kube-proxy和kube-dns其实也是普通的插件而已。你完全可以根据自己的需求，实现符合自己预期的Service。</p><h2>思考题</h2><p>为什么Kubernetes要求externalIPs必须是至少能够路由到一个Kubernetes的节点？</p><p>感谢你的收听，欢迎你给我留言，也欢迎分享给更多的朋友一起阅读。<br>\n</p>","comments":[{"had_liked":false,"id":205419,"user_name":"我来也","can_delete":false,"product_type":"c1","uid":1205253,"ip_address":"","ucode":"773D6104F56767","user_header":"https://static001.geekbang.org/account/avatar/00/12/64/05/6989dce6.jpg","comment_is_top":false,"comment_ctime":1586613408,"is_pvip":false,"discussion_count":7,"race_medal":0,"score":"358068898976","product_id":100015201,"comment_content":"课后思考题:<br>为什么 Kubernetes 要求 externalIPs 必须是至少能够路由到一个 Kubernetes 的节点？<br><br>因为k8s只是在集群中的每个节点上创建了一个 externalIPs 与kube-ipvs0网卡的绑定关系.<br>若流量都无法路由到任意的一个k8s节点,那自然无法将流量转给具体的service.<br><br>--------------------------------<br>最近在这个externalIPs上面踩了一个坑.<br>在阿里云上提交了工单.第二天,应该是换了第3个售后工程师,才解决的.<br>给你们分享一下,哈哈!<br><br>事情是这样的:<br>我的k8s集群中有3个节点,假设分别是:<br>A: 192.168.1.1<br>B: 192.168.1.2<br>C: 192.168.1.3<br><br>症状是:<br>我在节点B&#47;C上,ssh 192.168.1.1, 最终都是登录到了本机,并未成功登录节点A.<br>但是节点A登录节点B&#47;C, 节点B和节点C互相登录都正常.<br>只有节点B和节点C上,登录节点A不成功.<br><br>就是因为我的某一个service服务就配置了 externalIPs, 配置的IP就是 192.168.1.1(A)<br>--------------------------------<br>那个售后工程师发现在节点B和C上有这么一条记录<br>$ ip addr<br>inet 192.168.1.1&#47;32 brd 192.168.1.1 scope global kube-ipvs0<br><br>那么在节点B和节点C上,访问192.168.1.1的流量,全都转到了kube-ipvs0.<br>最终这个流量都转到本机了,并未真的发送到远端真实的IP:192.168.1.1<br><br>我立马就意识到,我的service绑定了节点的IP.可能是这个导致的.<br>后来把externalIPs移除掉节点的IP后,该规则就不见了,节点B和节点C也可以正常访问节点A了.<br><br>--------------------------------<br>这个 externalIPs 其实可以填多个,且不要求本机就有对应的IP.<br>比如你可以填集群中根本就不存在的IP 172.17.0.1,<br>那么在k8s所有节点上,你都可以通过netstat -ant | grep 172.17.0.1 查看到,有监听该IP的端口.<br><br>","like_count":84,"discussions":[{"author":{"id":1205253,"avatar":"https://static001.geekbang.org/account/avatar/00/12/64/05/6989dce6.jpg","nickname":"我来也","note":"","ucode":"773D6104F56767","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":295369,"discussion_content":"最近有同事在这个上面又栽了跟头,症状类似,也是跟IPVS相关.\n这里把找到的一篇博文也放在这里,给有需要的朋友一个参考.\n\n启用IPVS的K8S集群无法从Pod经外部访问自己的排障\nhttps://chanjarster.github.io/post/k8s/k8s-ipvs-cannot-access-self-from-cluster/","likes_number":13,"is_delete":false,"is_hidden":false,"ctime":1596177473,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1052859,"avatar":"https://static001.geekbang.org/account/avatar/00/10/10/bb/f1061601.jpg","nickname":"Demon.Lee","note":"","ucode":"7F0E5493A8E345","race_medal":1,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":378239,"discussion_content":"非常感谢分享，我们就遇到了类似问题。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1623121919,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2899801,"avatar":"https://static001.geekbang.org/account/avatar/00/2c/3f/59/3b9da34b.jpg","nickname":"初心?固执?","note":"","ucode":"061802402BCEBC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":548991,"discussion_content":"弱弱的问下，请问ExternalIPS是给公用使用的吗？可以配置成器中一个node的公网IP吗？还有externalName配置成公网的域名，解析到其中一个node的公网IP","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1643498722,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2647659,"avatar":"","nickname":"Dream","note":"","ucode":"01B8AAF5D4DDD7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":381907,"discussion_content":"遇到过 只不过是测试环境","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625283982,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1218501,"avatar":"https://static001.geekbang.org/account/avatar/00/12/97/c5/84491beb.jpg","nickname":"罗峰","note":"","ucode":"5F3D6AF8F28322","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":376125,"discussion_content":"所以externalips不应该乱配，正常是一个eip吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621987419,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2356047,"avatar":"","nickname":"Geek_164ff0","note":"","ucode":"9CFCF96DC1AEB9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":339233,"discussion_content":"那应该是有概率登陆成功吧？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609572802,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1205253,"avatar":"https://static001.geekbang.org/account/avatar/00/12/64/05/6989dce6.jpg","nickname":"我来也","note":"","ucode":"773D6104F56767","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2356047,"avatar":"","nickname":"Geek_164ff0","note":"","ucode":"9CFCF96DC1AEB9","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":339239,"discussion_content":"实际是完全没有概率登录成功。流量根本就没有出本机。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609573810,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":339233,"ip_address":""},"score":339239,"extra":""}]}]},{"had_liked":false,"id":40449,"user_name":"swordholder","can_delete":false,"product_type":"c1","uid":1002569,"ip_address":"","ucode":"3D1361126AD3CB","user_header":"https://static001.geekbang.org/account/avatar/00/0f/4c/49/d21c134f.jpg","comment_is_top":false,"comment_ctime":1542620607,"is_pvip":false,"discussion_count":7,"race_medal":0,"score":"108916803007","product_id":100015201,"comment_content":"对ExternalName的作用没太理解。<br>访问my-service.default.svc.cluster.local被替换为my.database.example.com，这和我从外部访问到 Kubernetes 里的服务有什么关系？<br>感觉这更像是从Kubernetes内访问外部资源的方法。","like_count":26,"discussions":[{"author":{"id":1117803,"avatar":"https://static001.geekbang.org/account/avatar/00/11/0e/6b/9ee9f422.jpg","nickname":"wx","note":"","ucode":"7AA8F0FEFD1128","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":385666,"discussion_content":"看的一篇文章 说的是 迁移外部 服务到k8s ， ExternalName 用的比较多:\n1. 如 有app01、pythonSvr 两个服务; 预计将两者都迁移到 k8s中;\n2. app01 先迁移, 预计pythonSvr 不久之后也迁移:\n我们先修改app01 的配置，让其访问pythonSvr 不再通过 pythonSvr.example.com; 而是通过 pythonSvr.default.svc.cluster.local;\n3. 我们此时创建一个 ExternalName类型的 Service,将 pythonSvr.default.svc.cluster.local 指向外部的 pythonSvr.example.com;\n4. pythonSvr 迁移完成后，我们修改c中创建的Service，修改其配置类型为 ClusterIP;\n5. app01 的配置不需要动，也无需重启，因为他一开始访问的域名 pythonSvr.default.svc.cluster.local 就是对的;\n","likes_number":12,"is_delete":false,"is_hidden":false,"ctime":1627200558,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1691380,"avatar":"https://static001.geekbang.org/account/avatar/00/19/ce/f4/d68fa921.jpg","nickname":"jason","note":"","ucode":"5F01F0E913C16F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":347168,"discussion_content":"有时候集群内部的应用需要一个服务入口，\n例如图片服务，开发人员希望这个入口是稳定的，\n实际上这个服务是运维同事搭建的或者其它供应商提供的，所以就有了这个域名转换的需求","likes_number":5,"is_delete":false,"is_hidden":false,"ctime":1612170406,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1822259,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/ce/33/933a0f19.jpg","nickname":"pluschen","note":"","ucode":"C839E7FB406E4B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":411109,"discussion_content":"看博客上一些文章，externalName是为了兼容一些外部服务还没有迁入k8s的情况。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1635852101,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1156643,"avatar":"https://static001.geekbang.org/account/avatar/00/11/a6/23/91e74c43.jpg","nickname":"leo","note":"","ucode":"73E8917E5156FC","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":3997,"discussion_content":"使用内部dns时很有用。在dns上加一条a记录，my.database.example.com，解析地址为master的内网ip，这样就能通过域名访问到pod","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565053366,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":3,"child_discussions":[{"author":{"id":1062859,"avatar":"https://static001.geekbang.org/account/avatar/00/10/37/cb/47842ec5.jpg","nickname":"XY","note":"","ucode":"ADC87289842CF6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1156643,"avatar":"https://static001.geekbang.org/account/avatar/00/11/a6/23/91e74c43.jpg","nickname":"leo","note":"","ucode":"73E8917E5156FC","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":135273,"discussion_content":"扯淡。。。。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579082196,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":3997,"ip_address":""},"score":135273,"extra":""},{"author":{"id":1195278,"avatar":"https://static001.geekbang.org/account/avatar/00/12/3d/0e/92176eaa.jpg","nickname":"左氧佛沙星人","note":"","ucode":"0D8295E1DABA8C","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1062859,"avatar":"https://static001.geekbang.org/account/avatar/00/10/37/cb/47842ec5.jpg","nickname":"XY","note":"","ucode":"ADC87289842CF6","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":202439,"discussion_content":"我也觉得。。。这明明是外部用的，我理解应该是跟node port或者什么一起用的，不单单只是externalName","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583918266,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":135273,"ip_address":""},"score":202439,"extra":""},{"author":{"id":1271918,"avatar":"https://static001.geekbang.org/account/avatar/00/13/68/6e/eb079ed7.jpg","nickname":"永健_何","note":"","ucode":"7746F1B2A7542A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1195278,"avatar":"https://static001.geekbang.org/account/avatar/00/12/3d/0e/92176eaa.jpg","nickname":"左氧佛沙星人","note":"","ucode":"0D8295E1DABA8C","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":308052,"discussion_content":"我理解就是node port和externalName一起用","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600831530,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":202439,"ip_address":""},"score":308052,"extra":""}]}]},{"had_liked":false,"id":42666,"user_name":"王天明","can_delete":false,"product_type":"c1","uid":1012262,"ip_address":"","ucode":"60C51851C73A37","user_header":"https://static001.geekbang.org/account/avatar/00/0f/72/26/7387fc89.jpg","comment_is_top":false,"comment_ctime":1542995839,"is_pvip":false,"replies":[{"id":"15306","content":"对","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1543042390,"ip_address":"","comment_id":42666,"utype":1}],"discussion_count":6,"race_medal":0,"score":"96032276351","product_id":100015201,"comment_content":"终于算是清楚了，在nodePort模式下，关于端口的有三个参数，port, nodePort, targetPort。<br>如果如下定义，（请张老师指出是否有理解偏差）<br>spec:<br>  type: NodePort<br>  ports:<br>    - name: http<br>      port: 8080<br>      nodePort: 30080<br>      targetPort: 80<br>      protocol: TCP<br><br>则svc信息如下，（注意下面无targetPort信息，只是ClustorPort与NodePort，注意后者为Nodeport）<br>ingress-nginx   ingress-nginx                 NodePort    10.105.192.34    &lt;none&gt;        8080:30080&#47;TCP,8443:30443&#47;TCP   28m<br><br>则可访问的组合为<br>1. clusterIP + port: 10.105.192.34:8080<br>2. 内网IP&#47;公网ip + nodePort: 172.31.14.16:30080。（172.31.14.16我的aws局域网ip.）<br><br>30080为nodePort也可以在iptables-save中映证。<br>还有，就是port参数是必要指定的，nodePort即使是显式指定，也必须是在指定范围内。<br><br>（在三板斧中也问过张老师如何使用nodePort打通外网的问题，一并谢谢了）<br>","like_count":22,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":430152,"discussion_content":"对","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1543042390,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1474931,"avatar":"","nickname":"Geek_df0ab0","note":"","ucode":"32669D2692BFF1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":273655,"discussion_content":"client  -->  nodeIP:nodePort  -->  serviceVIP:port  -->  podIp:targetPort","likes_number":11,"is_delete":false,"is_hidden":false,"ctime":1590484662,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":3,"child_discussions":[{"author":{"id":2405411,"avatar":"https://static001.geekbang.org/account/avatar/00/24/b4/23/0e296758.jpg","nickname":"姜尧","note":"","ucode":"D813E046DD81E8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1474931,"avatar":"","nickname":"Geek_df0ab0","note":"","ucode":"32669D2692BFF1","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":362400,"discussion_content":"service在前面吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1616936961,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":273655,"ip_address":""},"score":362400,"extra":""},{"author":{"id":1790474,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/52/0a/d25549c0.jpg","nickname":"xiaoc","note":"","ucode":"6BBCF8FA77C7B1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1474931,"avatar":"","nickname":"Geek_df0ab0","note":"","ucode":"32669D2692BFF1","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":373940,"discussion_content":"client --> nodeIP:nodePort  --> podIp:targetPort\nclient --> serviceIP:port   --> podIp:targetPort","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1620920399,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":273655,"ip_address":""},"score":373940,"extra":""},{"author":{"id":1261493,"avatar":"https://static001.geekbang.org/account/avatar/00/13/3f/b5/5fe77e16.jpg","nickname":"不经意间","note":"","ucode":"C39D98697ACB8B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2405411,"avatar":"https://static001.geekbang.org/account/avatar/00/24/b4/23/0e296758.jpg","nickname":"姜尧","note":"","ucode":"D813E046DD81E8","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":382249,"discussion_content":"外部访问","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625487033,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":362400,"ip_address":""},"score":382249,"extra":""}]},{"author":{"id":1490198,"avatar":"https://static001.geekbang.org/account/avatar/00/16/bd/16/c940b1a3.jpg","nickname":"幸运的人","note":"","ucode":"F0FF3C3112A7A8","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":300787,"discussion_content":"这几天恰好在这里纠结了很久，感谢释疑","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598264241,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":41287,"user_name":"虎虎❤️","can_delete":false,"product_type":"c1","uid":1086535,"ip_address":"","ucode":"157F261E80291A","user_header":"https://static001.geekbang.org/account/avatar/00/10/94/47/75875257.jpg","comment_is_top":false,"comment_ctime":1542764291,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"31607535363","product_id":100015201,"comment_content":"思考题 pod的external ip 应该是通过iptables进行配置。可能是一个虚拟ip，在网络中没有对应的设备。所以，必须有路由规则支持。否则客户端可能没办法找到该ip的路径，得到目的网络不可达的回复。","like_count":7,"discussions":[{"author":{"id":1350159,"avatar":"https://static001.geekbang.org/account/avatar/00/14/9a/0f/da7ed75a.jpg","nickname":"芒果少侠","note":"","ucode":"98D0BBB52BB80F","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":201271,"discussion_content":"恩，因为service还是一个虚拟ip。所以还是依赖k8s集群的iptables路由规则才能找到最终endpoints（调用的服务）","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1583768048,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":148579,"user_name":"坤","can_delete":false,"product_type":"c1","uid":1010922,"ip_address":"","ucode":"74E6838226A405","user_header":"https://static001.geekbang.org/account/avatar/00/0f/6c/ea/ce9854a5.jpg","comment_is_top":false,"comment_ctime":1573032982,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"23047869462","product_id":100015201,"comment_content":"nodePort下必须要指定Service的port,我用的v1.14，可能检查的更严格了。","like_count":5},{"had_liked":false,"id":40244,"user_name":"LEON","can_delete":false,"product_type":"c1","uid":1109922,"ip_address":"","ucode":"58F7AF5302FCAD","user_header":"https://static001.geekbang.org/account/avatar/00/10/ef/a2/6ea5bb9e.jpg","comment_is_top":false,"comment_ctime":1542585773,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"18722454957","product_id":100015201,"comment_content":"在我们通过 kubeadm 部署的集群里，你应该看到 kube-proxy 输出的日志如下所示：—输出日志的命令是什么？","like_count":4,"discussions":[{"author":{"id":1500888,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e6/d8/8939848a.jpg","nickname":"Andy","note":"","ucode":"E895030BE6D4CB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":50927,"discussion_content":"kubectl logs <kube-proxy-pod-name>","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1573788089,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":300545,"user_name":"Geek_5baa01","can_delete":false,"product_type":"c1","uid":2470693,"ip_address":"","ucode":"EE194170C4B30E","user_header":"","comment_is_top":false,"comment_ctime":1625213236,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10215147828","product_id":100015201,"comment_content":"我一直再想 LoadBalancer 的问题，如果他是负载到 k8s node 上，那么我应该选择那些 node 做它的负载端点呢？这里被负载的 node 需要额外承担更多的网络流程，这对这些 node 带宽容量评估是个问题，另外还需要考虑 HA 问题，肯定要选择多个 node 作为负载端点，要怎么选择呢？","like_count":2},{"had_liked":false,"id":41922,"user_name":"勤劳的小胖子-libo","can_delete":false,"product_type":"c1","uid":1158344,"ip_address":"","ucode":"5BB20CD5A56568","user_header":"https://static001.geekbang.org/account/avatar/00/11/ac/c8/4b1c0d40.jpg","comment_is_top":false,"comment_ctime":1542873739,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10132808331","product_id":100015201,"comment_content":"写了一个简单的nodeport,可以访问上一节的hostname deployment.<br>apiVersion: v1<br>kind: Service<br>metadata:<br>  name: hostnames<br>  labels:<br>    app: hostnames<br>spec:<br>  type: NodePort<br>  selector:<br>    app: hostnames<br>  ports:<br>  - nodePort: 30225<br>    port: 80<br>    targetPort: 9376<br>    protocol: TCP<br>    name: http<br><br><br>通过curl &lt;任意Node&gt;:30225可以访问。<br>vagrant@kubeadm1:~&#47;37ServiceDns$ curl 192.168.0.24:30225<br>hostnames-84985c9fdd-sgwpp<br><br>另外感觉我这边的输出关于kube-proxy:<br>vagrant@kubeadm1:~&#47;37ServiceDns$ kubectl logs -n kube-system kube-proxy-pscvh<br>W1122 10:13:18.794590       1 server_others.go:295] Flag proxy-mode=&quot;&quot; unknown, assuming iptables proxy<br>I1122 10:13:18.817014       1 server_others.go:148] Using iptables Proxier.<br>I1122 10:13:18.817394       1 server_others.go:178] Tearing down inactive rules.<br>E1122 10:13:18.874465       1 proxier.go:532] Error removing iptables rules in ipvs proxier: error deleting chain &quot;KUBE-MARK-MASQ&quot;: exit status 1: iptables: Too many links.<br>I1122 10:13:18.894045       1 server.go:447] Version: v1.12.2<br><br>后面信息都是正常的。不知道上面这些信息可以ignore吗？","like_count":2},{"had_liked":false,"id":41548,"user_name":"Len","can_delete":false,"product_type":"c1","uid":1022767,"ip_address":"","ucode":"53C623CE17973F","user_header":"https://static001.geekbang.org/account/avatar/00/0f/9b/2f/b7a3625e.jpg","comment_is_top":false,"comment_ctime":1542804005,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"10132738597","product_id":100015201,"comment_content":"因为 kubernetes 维护着 externalIPs IP + PORT 到具体服务的 endpoints 路由规则。","like_count":2,"discussions":[{"author":{"id":1350159,"avatar":"https://static001.geekbang.org/account/avatar/00/14/9a/0f/da7ed75a.jpg","nickname":"芒果少侠","note":"","ucode":"98D0BBB52BB80F","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":201261,"discussion_content":"最终还是要通过iptables跳转到k8s集群上来","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583767857,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":40248,"user_name":"LEON","can_delete":false,"product_type":"c1","uid":1109922,"ip_address":"","ucode":"58F7AF5302FCAD","user_header":"https://static001.geekbang.org/account/avatar/00/10/ef/a2/6ea5bb9e.jpg","comment_is_top":false,"comment_ctime":1542586087,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"10132520679","product_id":100015201,"comment_content":"而如果你的 Service 没办法通过 ClusterIP 访问到的时候，你首先应该检查的是这个 Service 是否有 Endpoints：———请问老师service ip与cluster ip有什么区别？为什么这块不直接是service ip?","like_count":2,"discussions":[{"author":{"id":1705587,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/06/73/c9c6fb6a.jpg","nickname":"Deephug","note":"","ucode":"E32B54889F7E87","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":198026,"discussion_content":"这不是一样的么\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583463286,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":252596,"user_name":"我来也","can_delete":false,"product_type":"c1","uid":1205253,"ip_address":"","ucode":"773D6104F56767","user_header":"https://static001.geekbang.org/account/avatar/00/12/64/05/6989dce6.jpg","comment_is_top":false,"comment_ctime":1602395566,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5897362862","product_id":100015201,"comment_content":"关于源IP的问题，简易看看这篇官方文档：<br><br>文档 教程 Services 使用 Source IP<br>https:&#47;&#47;kubernetes.io&#47;zh&#47;docs&#47;tutorials&#47;services&#47;source-ip&#47;","like_count":2},{"had_liked":false,"id":221222,"user_name":"Andy","can_delete":false,"product_type":"c1","uid":1119133,"ip_address":"","ucode":"4BCA899B8E4E85","user_header":"https://static001.geekbang.org/account/avatar/00/11/13/9d/0ff43179.jpg","comment_is_top":false,"comment_ctime":1590449706,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5885417002","product_id":100015201,"comment_content":"应该可以通过这章学的内容，访问  Dashboard 可视化插件了吧！试试","like_count":1},{"had_liked":false,"id":104375,"user_name":"随欲而安","can_delete":false,"product_type":"c1","uid":1171512,"ip_address":"","ucode":"BE701473CB8BAD","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKmbibsVRmAdEqAtZL9R00FjIZuibW9fTQCXd0OCwhxsR5dfzEKJOcleIpjDqyJnpK4ArY7uGrpcgag/132","comment_is_top":false,"comment_ctime":1560740359,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5855707655","product_id":100015201,"comment_content":"对ExternalName的作用没太理解，老师能解释一下么","like_count":1,"discussions":[{"author":{"id":2899801,"avatar":"https://static001.geekbang.org/account/avatar/00/2c/3f/59/3b9da34b.jpg","nickname":"初心?固执?","note":"","ucode":"061802402BCEBC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":548989,"discussion_content":"同问","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1643497177,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":85608,"user_name":"Flying","can_delete":false,"product_type":"c1","uid":1284267,"ip_address":"","ucode":"44B86B33AA461E","user_header":"","comment_is_top":false,"comment_ctime":1555139273,"is_pvip":false,"replies":[{"id":"31574","content":"对的","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1555696072,"ip_address":"","comment_id":85608,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5850106569","product_id":100015201,"comment_content":"老师，你好，使用NodePort类型的Service，会创建 -A KUBE-NODEPORTS 类的 iptables规则及 SNAT规则，如果kube-proxy使用的是 ipvs模式，也同样会创建这两个规则吗","like_count":1,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":446734,"discussion_content":"对的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1555696072,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":59437,"user_name":"Chenl07","can_delete":false,"product_type":"c1","uid":1089132,"ip_address":"","ucode":"0A0A086168A8F7","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/0FI2bUjegtznv7XPC9DB9RJaqiaMiamWkibibPOibuUC3DCvI7XMvBANr6sDjRNbc1jwPic9pIaFxrdaib88VqUJKXSTQ/132","comment_is_top":false,"comment_ctime":1547369457,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5842336753","product_id":100015201,"comment_content":"老师，我创建一个externalip的service后，对应的service端口为30100，externalip是一个VIP，实际指向集群中某两个节点。创建后，集群中任意节点上都没有侦听这个端口(netstat grep)，那通过我的VIP，怎么能访问到30100这个端口了？","like_count":1,"discussions":[{"author":{"id":1024057,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a0/39/ddcf26ac.jpg","nickname":"bruceding","note":"","ucode":"D35A2B05487EAE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":7037,"discussion_content":"iptables","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567308576,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":41934,"user_name":"勤劳的小胖子-libo","can_delete":false,"product_type":"c1","uid":1158344,"ip_address":"","ucode":"5BB20CD5A56568","user_header":"https://static001.geekbang.org/account/avatar/00/11/ac/c8/4b1c0d40.jpg","comment_is_top":false,"comment_ctime":1542877572,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5837844868","product_id":100015201,"comment_content":"请问一下什么应用场景下：“还有一种典型问题，就是 Pod 没办法通过 Service 访问自己？”<br>为什么要访问自己？","like_count":1,"discussions":[{"author":{"id":1624590,"avatar":"https://static001.geekbang.org/account/avatar/00/18/ca/0e/5009c5ff.jpg","nickname":"遇见","note":"","ucode":"FAF53CD4C28494","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":376158,"discussion_content":"mongodb replica set 集群部署","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621997300,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":357281,"user_name":"yuling朱","can_delete":false,"product_type":"c1","uid":2318586,"ip_address":"广东","ucode":"94BE6631ED6593","user_header":"https://static001.geekbang.org/account/avatar/00/23/60/fa/9da0c30e.jpg","comment_is_top":false,"comment_ctime":1663132986,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1663132986","product_id":100015201,"comment_content":"&quot;在 NodePort 方式下，Kubernetes 会在 IP 包离开宿主机发往目的 Pod 时，对这个 IP 包做一次 SNAT 操作&quot;,有个疑问，这里表述是不是有点不准确，在ClusterIP下就不会做SNAT了吗？<br>只要转发到其他节点就会做SNAT。","like_count":0},{"had_liked":false,"id":348704,"user_name":"国少","can_delete":false,"product_type":"c1","uid":1737962,"ip_address":"","ucode":"793E58BD13A04F","user_header":"https://static001.geekbang.org/account/avatar/00/1a/84/ea/124f0291.jpg","comment_is_top":false,"comment_ctime":1655314874,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1655314874","product_id":100015201,"comment_content":"有同学了解 会话保持 这部分吗？","like_count":0},{"had_liked":false,"id":348132,"user_name":"窝窝头","can_delete":false,"product_type":"c1","uid":1063866,"ip_address":"","ucode":"5C2635ED6484F8","user_header":"https://static001.geekbang.org/account/avatar/00/10/3b/ba/3b30dcde.jpg","comment_is_top":false,"comment_ctime":1654763895,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1654763895","product_id":100015201,"comment_content":"如果都不能路由的kubernetes的节点的话就没什么用了，请求都无法路由进去","like_count":0},{"had_liked":false,"id":332694,"user_name":"初心?固执?","can_delete":false,"product_type":"c1","uid":2899801,"ip_address":"","ucode":"061802402BCEBC","user_header":"https://static001.geekbang.org/account/avatar/00/2c/3f/59/3b9da34b.jpg","comment_is_top":false,"comment_ctime":1643496914,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1643496914","product_id":100015201,"comment_content":"弱弱的问下，这个ExternalName是外部访问的域名吗？需要解析到其中一个node IP的这种？","like_count":0},{"had_liked":false,"id":322661,"user_name":"神毓逍遥","can_delete":false,"product_type":"c1","uid":2147220,"ip_address":"","ucode":"83351CB18B190E","user_header":"https://static001.geekbang.org/account/avatar/00/20/c3/94/e89ebc50.jpg","comment_is_top":false,"comment_ctime":1637545826,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1637545826","product_id":100015201,"comment_content":"这篇文档很实用，自己再部署搭建集群，需要允许 pod 被外部访问时，会用到，自己实验的平台是 AWS&#47;QINGCLOUD","like_count":0},{"had_liked":false,"id":319057,"user_name":"陈斯佳","can_delete":false,"product_type":"c1","uid":1259323,"ip_address":"","ucode":"C236F874FC767A","user_header":"https://static001.geekbang.org/account/avatar/00/13/37/3b/495e2ce6.jpg","comment_is_top":false,"comment_ctime":1635554883,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1635554883","product_id":100015201,"comment_content":"第三十八课:从外界连通你好Service与Service调试“三板斧”<br>Service的类型分为ClusterIP,NodePort, ExternalIP,ExternalName.<br><br>当Service没办法通过DNS访问到的时候，可以先检查Master节点的Service DNS是否可以访问到:<br># 在一个Pod里执行<br>$ nslookup kubernetes.default<br><br>如果有问题，就去看kube-dns日志，否则，就要看Service本身定义是否有问题<br><br><br>如果Service没办法通过ClusterIP访问，应该先检查这个Service是否有Endpoint:<br>$ kubectl get endpoints hostnames<br><br>如果Endpoint正确，就要检查kube-proxy是否正确运行，如果正常，就要检查一下iptables<br><br>如果Pod没办法访问到自己，就要看看是不是kubelet 的 hairpin-mode 没有被正确设置。你只需要确保将 kubelet 的 hairpin-mode 设置为 hairpin-veth 或者 promiscuous-bridge 即可。<br><br>所谓的Service,其实就是k8s为Pod分配的、固定的、基于iptables的访问入口。<br>","like_count":0},{"had_liked":false,"id":313760,"user_name":"aroll","can_delete":false,"product_type":"c1","uid":1023524,"ip_address":"","ucode":"3A1A1267C88CC3","user_header":"https://static001.geekbang.org/account/avatar/00/0f/9e/24/0d6a7987.jpg","comment_is_top":false,"comment_ctime":1632650924,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1632650924","product_id":100015201,"comment_content":"通过Service 暴漏 Nodeport之后，外网是可以访问，为什么容器内部通过 宿主机ip+Nodeport访问不通？","like_count":0},{"had_liked":false,"id":300546,"user_name":"Geek_5baa01","can_delete":false,"product_type":"c1","uid":2470693,"ip_address":"","ucode":"EE194170C4B30E","user_header":"","comment_is_top":false,"comment_ctime":1625213792,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1625213792","product_id":100015201,"comment_content":"老师我还有一个问题，我在用 aliyun LoadBalancer 时发现它其实是设置了 service nodeport ，然后创建了 SLB 指向k8s node ，并且映射了 80 到对应的 nodeport ，这种方式的网络链路更长，应该会增加网络延时，有没有更好的方式呢？","like_count":0},{"had_liked":false,"id":285426,"user_name":"LbbNiu","can_delete":false,"product_type":"c1","uid":1142526,"ip_address":"","ucode":"AD0D05864C6913","user_header":"https://static001.geekbang.org/account/avatar/00/11/6e/fe/79955244.jpg","comment_is_top":false,"comment_ctime":1616810347,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1616810347","product_id":100015201,"comment_content":"修改了&#47;etc&#47;kubernetes&#47;manifests&#47;kube-apiserver.yaml 中 service-node-port-range 怎么才能生效呢","like_count":0,"discussions":[{"author":{"id":1137214,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqzPOHJjMtAyicMn3bbnmtOqfAKyyvZN3bVa1JqWR5tzoVpMJA93aiaAjKyV3GlEgVtpuNsAQbeTccg/132","nickname":"iqoiwer","note":"","ucode":"D54B2CAD0B588D","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":381413,"discussion_content":"master节点依次重启kubelet服务，促使apiserver更新配置自重启","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625044633,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":257223,"user_name":"极客精英","can_delete":false,"product_type":"c1","uid":1944962,"ip_address":"","ucode":"ED4A435488CC40","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIZ2Kr6TQt91Mdr16atJvwEkyYq1YGh8qR7BPCqPlgO7ZoyM95z4uLbSkMyzcP33fyIRAcHAUdN8Q/132","comment_is_top":false,"comment_ctime":1603886352,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1603886352","product_id":100015201,"comment_content":"老师，请问如果有很多微服务，需要暴露很多tcp端口，用nodeport方式暴露。但node节点非常多，考虑node本身也需要负载均衡和高可用，是不是也应该把node也挂到在均衡器下？ 外部服务通过这个负载均衡器来进入k8s集群？","like_count":0},{"had_liked":false,"id":251328,"user_name":"Heaven","can_delete":false,"product_type":"c1","uid":1694207,"ip_address":"","ucode":"FA33FBCC66C911","user_header":"https://static001.geekbang.org/account/avatar/00/19/d9/ff/b23018a6.jpg","comment_is_top":false,"comment_ctime":1601466444,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1601466444","product_id":100015201,"comment_content":"如果任何的Kubernetes都无法路由到,那么自然无法将流量转发给具体的Service<br>","like_count":0},{"had_liked":false,"id":200829,"user_name":"殷佳毅","can_delete":false,"product_type":"c1","uid":1284594,"ip_address":"","ucode":"2FC6E44332CCBA","user_header":"https://static001.geekbang.org/account/avatar/00/13/99/f2/54c30dbf.jpg","comment_is_top":false,"comment_ctime":1585657771,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1585657771","product_id":100015201,"comment_content":"老师好，service能不能做到pod在通过svc访问时如果这个svc的后端pod有在同一个worker上时流量有限从同worker的pod走，同一个worker上没有pod时再走其他worker上的pod？","like_count":0},{"had_liked":false,"id":198683,"user_name":"vincent","can_delete":false,"product_type":"c1","uid":1796234,"ip_address":"","ucode":"9FAD09D87C1E42","user_header":"","comment_is_top":false,"comment_ctime":1585463787,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1585463787","product_id":100015201,"comment_content":"service 如声明externalIPs:- 192.168.122.10 但是kubernets依然会在多个node上创建service<br>但是我理解声明了externalIPs，应该只在有192.168.122.10这个ip的node上创建service<br>不知道是不是我理解错了","like_count":0,"discussions":[{"author":{"id":1205253,"avatar":"https://static001.geekbang.org/account/avatar/00/12/64/05/6989dce6.jpg","nickname":"我来也","note":"","ucode":"773D6104F56767","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":229137,"discussion_content":"你理解错了.\n你可以试试, 带externalIPs的service,在所有节点上都会监听这个IP的端口.\n即使当前节点没有网卡的IP是这个IP, 在netstat上也会看到监听的状态.","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586611268,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2899801,"avatar":"https://static001.geekbang.org/account/avatar/00/2c/3f/59/3b9da34b.jpg","nickname":"初心?固执?","note":"","ucode":"061802402BCEBC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1205253,"avatar":"https://static001.geekbang.org/account/avatar/00/12/64/05/6989dce6.jpg","nickname":"我来也","note":"","ucode":"773D6104F56767","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":548990,"discussion_content":"请问externalIP一定要公网的IP吗？还有ExternalName是域名吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1643497304,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":229137,"ip_address":""},"score":548990,"extra":""}]}]},{"had_liked":false,"id":198679,"user_name":"vincent","can_delete":false,"product_type":"c1","uid":1796234,"ip_address":"","ucode":"9FAD09D87C1E42","user_header":"","comment_is_top":false,"comment_ctime":1585463646,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1585463646","product_id":100015201,"comment_content":"service 中 externalIPs: 是否可以声明多个IP","like_count":0,"discussions":[{"author":{"id":1205253,"avatar":"https://static001.geekbang.org/account/avatar/00/12/64/05/6989dce6.jpg","nickname":"我来也","note":"","ucode":"773D6104F56767","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":229138,"discussion_content":"是可以声明多个IP的, 并且不要求该IP在本机存在.","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586611298,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":185087,"user_name":"Shuttle","can_delete":false,"product_type":"c1","uid":1118235,"ip_address":"","ucode":"3837AA626997B8","user_header":"https://static001.geekbang.org/account/avatar/00/11/10/1b/d17ea26b.jpg","comment_is_top":false,"comment_ctime":1583480246,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1583480246","product_id":100015201,"comment_content":"老师，你好<br>我node节点join的时候提示forbidden呢？版本都是一样的<br>CGROUPS_MEMORY: enabled<br>\t[WARNING SystemVerification]: unsupported docker version: 18.09.9<br>[discovery] Trying to connect to API Server &quot;10.1.126.33:6443&quot;<br>[discovery] Created cluster-info discovery client, requesting info from &quot;https:&#47;&#47;10.1.126.33:6443&quot;<br>[discovery] Requesting info from &quot;https:&#47;&#47;10.1.126.33:6443&quot; again to validate TLS against the pinned public key<br>[discovery] Cluster info signature and contents are valid and TLS certificate validates against pinned roots, will use API Server &quot;10.1.126.33:6443&quot;<br>[discovery] Successfully established connection with API Server &quot;10.1.126.33:6443&quot;<br>[kubelet] Downloading configuration for the kubelet from the &quot;kubelet-config-1.11&quot; ConfigMap in the kube-system namespace<br>configmaps &quot;kubelet-config-1.11&quot; is forbidden: User &quot;system:bootstrap:lu5nla&quot; cannot get resource &quot;configmaps&quot; in API group &quot;&quot; in the namespace &quot;kube-system&quot;<br><br><br>","like_count":0,"discussions":[{"author":{"id":1137214,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqzPOHJjMtAyicMn3bbnmtOqfAKyyvZN3bVa1JqWR5tzoVpMJA93aiaAjKyV3GlEgVtpuNsAQbeTccg/132","nickname":"iqoiwer","note":"","ucode":"D54B2CAD0B588D","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":381414,"discussion_content":"应该是work节点的docker版本不对吧，也要和主节点一致的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625044728,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":163088,"user_name":"LH","can_delete":false,"product_type":"c1","uid":1211178,"ip_address":"","ucode":"819B9B2409E834","user_header":"https://static001.geekbang.org/account/avatar/00/12/7b/2a/7d8b5943.jpg","comment_is_top":false,"comment_ctime":1576654854,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1576654854","product_id":100015201,"comment_content":"到了某个节点上才可以使用iptables转发请求到具体到pod","like_count":0},{"had_liked":false,"id":67581,"user_name":"程序修行","can_delete":false,"product_type":"c1","uid":1257409,"ip_address":"","ucode":"2CCD5ACAFF0E8D","user_header":"","comment_is_top":false,"comment_ctime":1550201350,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1550201350","product_id":100015201,"comment_content":"一个有趣的问题，我每次从外部浏览器访问一个nodeport类型的service，在抓取访问客户端的源IP（source IP）的时候，总是抓取到10.1.0.0这样的pod的内部IP，而不是我本机的9.x.x.x这样的真实的我的IP。","like_count":0},{"had_liked":false,"id":42615,"user_name":"王天明","can_delete":false,"product_type":"c1","uid":1012262,"ip_address":"","ucode":"60C51851C73A37","user_header":"https://static001.geekbang.org/account/avatar/00/0f/72/26/7387fc89.jpg","comment_is_top":false,"comment_ctime":1542979761,"is_pvip":false,"replies":[{"id":"15261","content":"你这主机是不是有防火墙？","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1542985840,"ip_address":"","comment_id":42615,"utype":1}],"discussion_count":3,"race_medal":0,"score":"1542979761","product_id":100015201,"comment_content":"张老师，我在使用NodePort暴露外网访问一直不成功，无论是公网IP还是局域网IP但不成功，只能使用ClusterIP+NodePort访问。查看events也都正常，只几节课里使用NodePort都有类似的问题。是我理解哪里存在偏差吗？","like_count":0,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":430141,"discussion_content":"你这主机是不是有防火墙？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1542985840,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1052859,"avatar":"https://static001.geekbang.org/account/avatar/00/10/10/bb/f1061601.jpg","nickname":"Demon.Lee","note":"","ucode":"7F0E5493A8E345","race_medal":1,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":377385,"discussion_content":"你好，请问这个问题，你最后解决了么，如何解决地，谢谢。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1622624796,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2318586,"avatar":"https://static001.geekbang.org/account/avatar/00/23/60/fa/9da0c30e.jpg","nickname":"yuling朱","note":"","ucode":"94BE6631ED6593","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1052859,"avatar":"https://static001.geekbang.org/account/avatar/00/10/10/bb/f1061601.jpg","nickname":"Demon.Lee","note":"","ucode":"7F0E5493A8E345","race_medal":1,"user_type":1,"is_pvip":false},"discussion":{"id":587527,"discussion_content":"可以查看下iptables是否存在对应规则，如果是IPVS模式，查询对应的ipvs转发规则。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1663132654,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":377385,"ip_address":"广东"},"score":587527,"extra":""}]}]},{"had_liked":false,"id":41849,"user_name":"foghost","can_delete":false,"product_type":"c1","uid":1066977,"ip_address":"","ucode":"7CBA2CC64E9C33","user_header":"https://static001.geekbang.org/account/avatar/00/10/47/e1/6cbca5c2.jpg","comment_is_top":false,"comment_ctime":1542858792,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1542858792","product_id":100015201,"comment_content":"请教张老师，我在几个不同环境中实验ipvs模式下externalTrafficPolicy=local策略时发现，这个策略在ipvs模式下并不会只转发到本机pod，而是依然转发到了其他机器上到pod，ipvs 规则中hostname -i 对应的规则下有其他机器的pod，查了很多资料都没有结果，我在想这是不是k8s ipvs模式的bug，还请张老师解惑","like_count":0,"discussions":[{"author":{"id":1053390,"avatar":"https://static001.geekbang.org/account/avatar/00/10/12/ce/a8c8b5e8.jpg","nickname":"Jason","note":"","ucode":"ABB3F1A63E102A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":297551,"discussion_content":"只有当type被设置为LoadBalancer而externalTrafficPolicy被设置为Local时，它才会生效。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596967486,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2318586,"avatar":"https://static001.geekbang.org/account/avatar/00/23/60/fa/9da0c30e.jpg","nickname":"yuling朱","note":"","ucode":"94BE6631ED6593","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1053390,"avatar":"https://static001.geekbang.org/account/avatar/00/10/12/ce/a8c8b5e8.jpg","nickname":"Jason","note":"","ucode":"ABB3F1A63E102A","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":587526,"discussion_content":"还有NodePort。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1663132554,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":297551,"ip_address":"广东"},"score":587526,"extra":""}]}]},{"had_liked":false,"id":41001,"user_name":"硕","can_delete":false,"product_type":"c1","uid":1310756,"ip_address":"","ucode":"661AE1FC22C943","user_header":"https://static001.geekbang.org/account/avatar/00/14/00/24/6ff7cb37.jpg","comment_is_top":false,"comment_ctime":1542711557,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1542711557","product_id":100015201,"comment_content":"ingress 做转发也行 作者能讲解一下吗？<br>","like_count":0},{"had_liked":false,"id":40527,"user_name":"Gray13","can_delete":false,"product_type":"c1","uid":1309152,"ip_address":"","ucode":"3C7FEFE31CDB51","user_header":"https://static001.geekbang.org/account/avatar/00/13/f9/e0/2cdd1bc9.jpg","comment_is_top":false,"comment_ctime":1542629758,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1542629758","product_id":100015201,"comment_content":"第一时间提示更新了 噢耶 小板凳坐前排","like_count":0},{"had_liked":false,"id":40372,"user_name":"余功鹏","can_delete":false,"product_type":"c1","uid":1197135,"ip_address":"","ucode":"8BE5EFFF40E2F2","user_header":"https://static001.geekbang.org/account/avatar/00/12/44/4f/a6f32382.jpg","comment_is_top":false,"comment_ctime":1542606955,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1542606955","product_id":100015201,"comment_content":"Ingress这个不介绍吗？","like_count":0},{"had_liked":false,"id":40338,"user_name":"arlose","can_delete":false,"product_type":"c1","uid":1154358,"ip_address":"","ucode":"C58C16EC025AE6","user_header":"https://static001.geekbang.org/account/avatar/00/11/9d/36/2f36e1a8.jpg","comment_is_top":false,"comment_ctime":1542595254,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1542595254","product_id":100015201,"comment_content":"老师，我这边有3台机器，在不同的局域网，然后一台作为master节点，然后kube init以后，生成的join语句的ip是内网ip，我另外两台机器想加入集群个怎么操作？","like_count":0},{"had_liked":false,"id":40304,"user_name":"wilder","can_delete":false,"product_type":"c1","uid":1007682,"ip_address":"","ucode":"C176379126D007","user_header":"https://static001.geekbang.org/account/avatar/00/0f/60/42/8a79c613.jpg","comment_is_top":false,"comment_ctime":1542591137,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1542591137","product_id":100015201,"comment_content":"前几天刚好调试 externalTrafficPolicy问题，听了老师的课之后终于明白了，大赞张老师的k8s课程呀","like_count":0},{"had_liked":false,"id":40254,"user_name":"LEON","can_delete":false,"product_type":"c1","uid":1109922,"ip_address":"","ucode":"58F7AF5302FCAD","user_header":"https://static001.geekbang.org/account/avatar/00/10/ef/a2/6ea5bb9e.jpg","comment_is_top":false,"comment_ctime":1542586498,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1542586498","product_id":100015201,"comment_content":"老师cluster ip和node port是必须要配合使用才能够把服务暴露出去吗？还有别的模式吗？","like_count":0,"discussions":[{"author":{"id":1021690,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/96/fa/937f8edf.jpg","nickname":"jon","note":"","ucode":"FBC9BC23F5A47C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":4444,"discussion_content":"Ingress","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565425647,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":40239,"user_name":"DJH","can_delete":false,"product_type":"c1","uid":1256740,"ip_address":"","ucode":"2BDEF123B3DB6A","user_header":"https://static001.geekbang.org/account/avatar/00/13/2d/24/28acca15.jpg","comment_is_top":false,"comment_ctime":1542585106,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1542585106","product_id":100015201,"comment_content":"“为什么 Kubernetes 要求 externalIPs ...“这个是不是因为最终客户端还是通过external IP的转发，通过宿主机NodePort的方式访问到POD，POD的IP对于external IP也是不可直接访问的。","like_count":0}]}