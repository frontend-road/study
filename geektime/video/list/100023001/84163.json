{"id":84163,"title":"51 | 模型部署与效果演示","content":"<h2>课件及源码下载地址：</h2><p><a href=\"https://gitee.com/geektime-geekbang/tensorflow-101/tree/master/beginners\">https://gitee.com/geektime-geekbang/tensorflow-101/tree/master/beginners</a></p>","comments":[{"had_liked":false,"id":78751,"user_name":"沉枫y","can_delete":false,"product_type":"c3","uid":1379253,"ip_address":"","ucode":"23FA566231DEEF","user_header":"https://static001.geekbang.org/account/avatar/00/15/0b/b5/6f876b6e.jpg","comment_is_top":false,"comment_ctime":1553229910,"is_pvip":false,"replies":[{"id":36071,"content":"👍赞","user_name":"作者回复","user_name_real":"彭靖田","uid":1067283,"ctime":1559535171,"ip_address":"","comment_id":78751,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100023001,"comment_content":"windows用户不在虚拟环境下的：\nset FLASK_ENV=development &amp;&amp;  flask run --host=0.0.0.0\ncurl -X POST -F image=@1459.png http:&#47;&#47;localhost:5000&#47;ping","like_count":0,"discussions":[{"author":{"id":1067283,"avatar":"https://static001.geekbang.org/account/avatar/00/10/49/13/51b1fe81.jpg","nickname":"彭靖田","note":"","ucode":"D3F1C281F38390","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":444222,"discussion_content":"👍赞","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1559535171,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":108484,"user_name":"无趣的灵魂","can_delete":false,"product_type":"c3","uid":1140720,"ip_address":"","ucode":"34FAB222F015D6","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/7Kt7kBRAia6xAnYXFooKJa6CrAAxybwEa6cw3T2e1wS5dTgbjib9othu1K2udhdYZka0Z4gqdZfxNH5KDlfddHCg/132","comment_is_top":false,"comment_ctime":1561781772,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100023001,"comment_content":"请问flask 三张测试的图片放在那里呢？，为什么放在flask-test路径里自动就可以找到图片呢？","like_count":1},{"had_liked":false,"id":180461,"user_name":"被梦想通缉的树袋熊","can_delete":false,"product_type":"c3","uid":1719677,"ip_address":"","ucode":"38E73B375F66FE","user_header":"https://static001.geekbang.org/account/avatar/00/1a/3d/7d/d61d344c.jpg","comment_is_top":false,"comment_ctime":1582287618,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":2,"product_id":100023001,"comment_content":"老师，您好，我在运行这个flask程序的模型预测时报错了，看上去好像是没有初始化全局变量的原因，但看老师的代码中没有这个，所以特向老师请教。\ntensorflow.python.framework.errors_impl.FailedPreconditionError: Error while reading resource variable fc2&#47;kernel from Container: localhost. This could mean that the variable was uninitialized. Not found: Container localhost does not exist. (Could not find resource: localhost&#47;fc2&#47;kernel)\n","like_count":0,"discussions":[{"author":{"id":1719677,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/3d/7d/d61d344c.jpg","nickname":"被梦想通缉的树袋熊","note":"","ucode":"38E73B375F66FE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":181296,"discussion_content":"经查询后发现是flask中部署tensorflow的问题，只能在预测代码前加上模型加载代码才能正常运行，但这种每次请求都会重复加载模型，暂时没有更好的解决办法。\n        if received_img:\n            image = np.array(Image.open(BytesIO(image)))\n            image = rgb2gray(image).reshape(1, 60, 160, 1).astype(&#39;float32&#39;) / 255\n            model = load_model(MODEL_FILE)\n            graph = tf.compat.v1.get_default_graph()\n            with graph.as_default():\n                pred = model.predict(image)\n            response[&#39;predication&#39;] = vec2text(pred)\n            response[&#39;success&#39;] = True","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582357574,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":170005,"user_name":"勿忘初心","can_delete":false,"product_type":"c3","uid":1384327,"ip_address":"","ucode":"0206AAE5C641A4","user_header":"https://static001.geekbang.org/account/avatar/00/15/1f/87/54a5695c.jpg","comment_is_top":false,"comment_ctime":1578491471,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100023001,"comment_content":"* Serving Flask app &quot;app.py&quot; (lazy loading)\n * Environment: development\n * Debug mode: on\n * Running on http:&#47;&#47;0.0.0.0:5000&#47; (Press CTRL+C to quit)\n * Restarting with stat\n * Debugger is active!\n * Debugger PIN: 225-553-833\nTraceback (most recent call last):\n。。。。\n\n    return _bootstrap._gcd_import(name[level:], package, level)\n  File &quot;&lt;frozen importlib._bootstrap&gt;&quot;, line 1006, in _gcd_import\n  File &quot;&lt;frozen importlib._bootstrap&gt;&quot;, line 983, in _find_and_load\n  File &quot;&lt;frozen importlib._bootstrap&gt;&quot;, line 965, in _find_and_load_unlocked\nModuleNotFoundError: No module named &#39;tensorflow_core.keras&#39;\nUsing TensorFlow backend.\nUsing TensorFlow backend.\n","like_count":0},{"had_liked":false,"id":170001,"user_name":"勿忘初心","can_delete":false,"product_type":"c3","uid":1384327,"ip_address":"","ucode":"0206AAE5C641A4","user_header":"https://static001.geekbang.org/account/avatar/00/15/1f/87/54a5695c.jpg","comment_is_top":false,"comment_ctime":1578491366,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":2,"product_id":100023001,"comment_content":"环境中tf 和keras 能正常引用 但是在flask启动的时候 就报错 ModuleNotFoundError: No module named &#39;tensorflow_core.keras&#39;\n","like_count":0,"discussions":[{"author":{"id":1067724,"avatar":"https://static001.geekbang.org/account/avatar/00/10/4a/cc/ae44e01e.jpg","nickname":"张先生。","note":"","ucode":"9B085DBD700B98","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":162205,"discussion_content":"keras单独安装 pip3 install keras","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580972151,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":166641,"user_name":"J.Smile","can_delete":false,"product_type":"c3","uid":1336475,"ip_address":"","ucode":"C4D98DFDBF7584","user_header":"https://static001.geekbang.org/account/avatar/00/14/64/9b/d1ab239e.jpg","comment_is_top":false,"comment_ctime":1577527491,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100023001,"comment_content":" with graph.as_default():\nAttributeError: &#39;function&#39; object has no attribute &#39;as_default&#39;\n报错了呢","like_count":0},{"had_liked":false,"id":138765,"user_name":"AA-DENNIS","can_delete":false,"product_type":"c3","uid":1180746,"ip_address":"","ucode":"6429DE3C02EFD1","user_header":"https://static001.geekbang.org/account/avatar/00/12/04/4a/356ce5e2.jpg","comment_is_top":false,"comment_ctime":1570442833,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100023001,"comment_content":"老师，你好，我在deploy_app.py中添加了下面的代码：\nif __name__ == &#39;__main__&#39;:\n    app.run(host=&#39;0.0.0.0&#39;\n            port= 5001,   \n            debug=True)   \n　启动命令：\npython deploy_app.py\n出现下面的异常需要如何解决呢？\n    if not _DISABLE_TRACKING.value:\nAttributeError: &#39;_thread._local&#39; object has no attribute &#39;value&#39;\n","like_count":0}]}