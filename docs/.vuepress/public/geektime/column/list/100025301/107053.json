{"id":107053,"title":"34 | Amazonçƒ­é”€æ¦œBeam Pipelineå®æˆ˜","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯è”¡å…ƒæ¥ ã€‚</p><p>ä»Šå¤©æˆ‘è¦ä¸ä½ åˆ†äº«çš„ä¸»é¢˜æ˜¯â€œAmazonçƒ­é”€æ¦œBeam Pipelineå®æˆ˜â€ã€‚</p><p>ä¸¤ä¸ªæœˆå‰ï¼Œäºšé©¬é€Šï¼ˆAmazonï¼‰å®£å¸ƒå°†å…³é—­ä¸­å›½å›½å†…ç”µå•†ä¸šåŠ¡çš„æ¶ˆæ¯ä½ ä¸€å®šè¿˜è®°å¿†çŠ¹æ–°ã€‚è™½ç„¶äºšé©¬é€Šé—æ†¾ç¦»åœºï¼Œä½†å®ƒä¾ç„¶æ˜¯ç›®å‰å…¨çƒå¸‚å€¼æœ€é«˜çš„ç”µå•†å…¬å¸ã€‚</p><p>ä½œä¸ºç¾å›½æœ€å¤§çš„ä¸€å®¶ç½‘ç»œç”µå­å•†åŠ¡å…¬å¸ï¼Œäºšé©¬é€Šçš„æ€»éƒ¨ä½äºåç››é¡¿å·çš„è¥¿é›…å›¾ã€‚ç±»ä¼¼äºBATåœ¨å›½å†…çš„åœ°ä½ï¼Œäºšé©¬é€Šä¹Ÿæ˜¯åŒ—ç¾äº’è”ç½‘FAANGäº”å¤§å·¨å¤´ä¹‹ä¸€ï¼Œå…¶ä»–å››ä¸ªåˆ†åˆ«æ˜¯Facebookã€Appleã€Netflixå’ŒGoogleã€‚</p><p>äºšé©¬é€Šçš„çƒ­é”€å•†å“ç³»ç»Ÿå°±å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/df/b0/dff4faae3353f26d7e413a0c1f7983b0.png?wh=1576*758\" alt=\"\"></p><p>å½“æˆ‘æœç´¢â€œæ”€å²©é‹â€æ—¶ï¼Œæœç´¢ç»“æœçš„ç¬¬ä¸‰ä¸ªè¢«æ‰“ä¸Šäº†â€œçƒ­é”€å•†å“â€çš„æ ‡ç­¾ï¼Œè¿™æ ·èƒ½å¸®åŠ©æ¶ˆè´¹è€…å¿«é€Ÿåšå‡ºè´­ä¹°å†³ç­–ã€‚</p><p>å½“æˆ‘ç‚¹å‡»è¿™ä¸ªâ€œBest Sellerâ€çš„æ ‡ç­¾æ—¶ï¼Œæˆ‘å¯ä»¥æµè§ˆâ€œæ”€å²©é‹â€è¿™ä¸ªå•†å“åˆ†ç±»ä¸­æµè§ˆé”€é‡æœ€é«˜çš„å‰100ä¸ªå•†å“ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/a7/4c/a7a0b8187b1caf1b31fcda87720e494c.png?wh=1788*1262\" alt=\"\"></p><p>è¿™äº›è´´å¿ƒçš„åŠŸèƒ½éƒ½æ˜¯ç”±çƒ­é”€å•†å“ç³»ç»Ÿå®ç°çš„ã€‚</p><p>è¿™ä¸€è®²æˆ‘ä»¬å°±æ¥çœ‹çœ‹åœ¨è¿™æ ·çš„çƒ­é”€å•†å“ç³»ç»Ÿä¸­ï¼Œæ€æ ·åº”ç”¨ä¹‹å‰æ‰€å­¦çš„Beamæ•°æ®å¤„ç†æŠ€æœ¯å§ã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬ä¸»è¦ä¼šè§£å†³ä¸€ä¸ªçƒ­é”€å•†å“ç³»ç»Ÿæ•°æ®å¤„ç†æ¶æ„ä¸­çš„è¿™å‡ ä¸ªé—®é¢˜ï¼š</p><ol>\n<li>æ€æ ·ç”¨æ‰¹å¤„ç†è®¡ç®—åŸºç¡€çš„çƒ­é”€å•†å“åˆ—è¡¨ã€çƒ­é”€å•†å“çš„å­˜å‚¨å’Œservingè®¾è®¡ï¼Ÿ</li>\n<li>æ€æ ·è®¾è®¡æ¯å°æ—¶æ›´æ–°çš„çƒ­é”€æ¦œå•ï¼Ÿ</li>\n<li>æ€æ ·è®¾è®¡å•†å“å»é‡å¤„ç†æµæ°´çº¿å’Œæ€æ ·æ ¹æ®å•†å“åœ¨å”®çŠ¶æ€è¿‡æ»¤çƒ­é”€å•†å“ï¼Ÿ</li>\n<li>æ€æ ·æŒ‰ä¸åŒçš„å•†å“é—¨ç±»ç”Ÿæˆæ¦œå•ï¼Ÿ</li>\n</ol><!-- [[[read_end]]] --><h3>1.æ€æ ·ç”¨æ‰¹å¤„ç†è®¡ç®—åŸºç¡€çš„çƒ­é”€å•†å“åˆ—è¡¨ã€çƒ­é”€å•†å“çš„å­˜å‚¨å’Œservingè®¾è®¡ï¼Ÿ</h3><p>æˆ‘ä»¬å…ˆæ¥çœ‹æœ€ç®€å•çš„é—®é¢˜è®¾ç½®ï¼Œæ€æ ·ç”¨æ‰¹å¤„ç†è®¡ç®—åŸºç¡€çš„çƒ­é”€å•†å“åˆ—è¡¨ã€‚</p><p>å‡è®¾ä½ çš„ç”µå•†ç½‘ç«™é”€å”®ç€10äº¿ä»¶å•†å“ï¼Œå¹¶ä¸”å·²ç»è·Ÿè¸ªäº†ç½‘ç«™çš„é”€å”®è®°å½•ï¼šå•†å“idå’Œè´­ä¹°æ—¶é—´ {product_id, timestamp}ï¼Œæ•´ä¸ªäº¤æ˜“è®°å½•æ˜¯1000äº¿è¡Œæ•°æ®ï¼ŒTBçº§ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬çš„æ•°æ®æ˜¯è¿™æ ·çš„ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/bd/9d/bdafa7f74c568c107c38317e0a1a669d.png?wh=1031*582\" alt=\"\"></p><p>æˆ‘ä»¬å¯ä»¥æŠŠçƒ­é”€æ¦œæŒ‰ product_id æ’åä¸ºï¼š1ï¼Œ2ï¼Œ3ã€‚</p><p>ä½ ç°åœ¨æœ‰æ²¡æœ‰è§‰å¾—è¿™ä¸ªé—®é¢˜ä¼¼æ›¾ç›¸è¯†å‘¢ï¼Ÿçš„ç¡®ï¼Œæˆ‘ä»¬åœ¨<a href=\"https://time.geekbang.org/column/article/91125\">ç¬¬3è®²â€œå¤§è§„æ¨¡æ•°æ®åˆä½“éªŒâ€</a>ä¸­ç”¨è¿™ä¸ªä¾‹å­å¼•å‡ºäº†æ•°æ®å¤„ç†æ¡†æ¶è®¾è®¡çš„åŸºæœ¬éœ€æ±‚ã€‚</p><p>è¿™ä¸€è®²ä¸­ï¼Œæˆ‘ä»¬ä¼šä»è¿™ä¸ªåŸºæœ¬é—®é¢˜è®¾ç½®å¼€å§‹ï¼Œé€æ­¥æ·±å…¥æ¢ç´¢ã€‚</p><p>åœ¨ç¬¬3è®²ä¸­ï¼Œæˆ‘ä»¬æŠŠæˆ‘ä»¬çš„æ•°æ®å¤„ç†æµç¨‹åˆ†æˆäº†ä¸¤ä¸ªæ­¥éª¤ï¼Œåˆ†åˆ«æ˜¯ï¼š</p><ol>\n<li>ç»Ÿè®¡æ¯ä¸ªå•†å“çš„é”€é‡</li>\n<li>æ‰¾å‡ºé”€é‡å‰K</li>\n</ol><p>æˆ‘ä»¬å…ˆæ¥çœ‹ç¬¬ä¸€ä¸ªæ­¥éª¤çš„ç»Ÿè®¡å•†å“é”€é‡åº”è¯¥å¦‚ä½•åœ¨Beamä¸­å®ç°ã€‚æˆ‘ä»¬åœ¨ç¬¬3è®²ä¸­æ˜¯ç”»äº†è¿™æ ·çš„è®¡ç®—é›†ç¾¤çš„ç¤ºæ„å›¾ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/8e/8a/8eeff3376743e886d5f2d481ca8ddb8a.jpg?wh=1626*1018\" alt=\"\"></p><p>å¦‚æœä½ æš‚æ—¶æ²¡æœ‰æ€è·¯çš„è¯ï¼Œæˆ‘ä»¬ä¸å¦¨è¯•è¯•æ¢ä¸€ä¸ªè§’åº¦æ¥æ€è€ƒè¿™ä¸ªé—®é¢˜ã€‚</p><p>ç»Ÿè®¡å•†å“çš„é”€é‡ï¼Œæ¢å¥è¯è¯´ï¼Œå…¶å®å°±æ˜¯è®¡ç®—åŒæ ·çš„å•†å“idåœ¨æˆ‘ä»¬çš„é”€å”®è®°å½•æ•°æ®åº“ä¸­å‡ºç°äº†å¤šå°‘æ¬¡ã€‚è¿™æœ‰æ²¡æœ‰è®©ä½ è”æƒ³åˆ°ä»€ä¹ˆå‘¢ï¼Ÿæ²¡é”™ï¼Œå°±æ˜¯æˆ‘ä»¬åœ¨<a href=\"https://time.geekbang.org/column/article/105324\">ç¬¬31è®²</a>ä¸­è®²åˆ°çš„WordCountä¾‹å­ã€‚WordCountæ˜¯ç»Ÿè®¡åŒæ ·çš„å•è¯å‡ºç°çš„æ¬¡æ•°ï¼Œè€Œå•†å“é”€é‡å°±æ˜¯ç»Ÿè®¡åŒæ ·çš„å•†å“idå‡ºç°çš„æ¬¡æ•°ã€‚</p><p>æ‰€ä»¥ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥ç”¨WordCountä¸­çš„éƒ¨åˆ†ä»£ç è§£å†³å•†å“é”€é‡ç»Ÿè®¡çš„è¿™éƒ¨åˆ†æ•°æ®å¤„ç†é€»è¾‘ã€‚</p><p>åœ¨WordCountä¸­ï¼Œæˆ‘ä»¬ç”¨words.apply(Count.perElement())æŠŠä¸€ä¸ªåˆ†è¯åçš„PCollectionè½¬æ¢æˆäº†â€œå•è¯ä¸ºkeyï¼Œcountä¸ºvalueâ€çš„ä¸€ä¸ªkey/valueç»„åˆã€‚</p><p>åœ¨è¿™é‡Œå‘¢ï¼Œæˆ‘ä»¬åŒæ ·ä½¿ç”¨salesRecords.apply(Count.perElement())æŠŠä¸€ä¸ªå•†å“idçš„PCollectionè½¬æ¢æˆâ€œkeyä¸ºå•†å“idï¼Œvalueä¸ºcountâ€çš„key/valueç»„åˆã€‚</p><p>Java</p><pre><code>// WordCountçš„ç»Ÿè®¡è¯é¢‘æ­¥éª¤\nwordCount = words.apply(Count.perElement())\n\n// æˆ‘ä»¬è¿™é‡Œçš„ç»Ÿè®¡é”€é‡æ­¥éª¤\nsalesCount = salesRecords.apply(Count.perElement())\n</code></pre><p>è§£å†³äº†ç»Ÿè®¡æ¯ä¸ªå•†å“çš„é”€é‡æ­¥éª¤ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹æ€æ ·ç»Ÿè®¡é”€é‡å‰Kçš„å•†å“ã€‚åœ¨ç¬¬3è®²ä¸­ï¼Œæˆ‘ä»¬æ˜¯ç”»äº†ä¸€ä¸ªè®¡ç®—é›†ç¾¤æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/38/fc/38933e25ca315bd56321753573d5bbfc.jpg?wh=1616*1010\" alt=\"\"></p><p>ä½†æ˜¯Beamæä¾›äº†å¾ˆå¥½çš„APIä¾›æˆ‘ä»¬ä½¿ç”¨ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Top() è¿™ä¸ªTransformã€‚</p><p>Topæ¥å—çš„ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯æˆ‘ä»¬è¿™é‡Œçš„Kï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æœ€ç»ˆè¦è¾“å‡ºçš„å‰å‡ ä¸ªå…ƒç´ ã€‚æˆ‘ä»¬éœ€è¦å®ç°çš„æ˜¯ä¸€ä¸ªJava Comparator interfaceã€‚</p><p>Java</p><pre><code>PCollection&lt;KV&lt;String, Long&gt;&gt; topK =\n      salesCount.apply(Top.of(K, new Comparator&lt;KV&lt;String, Long&gt;&gt;() {\n          @Override\n          public int compare(KV&lt;String, Long&gt; a, KV&lt;String, Long&gt; b) {\n            return b.getValue.compareTo(a.getValue());\n          }\n      }));\n</code></pre><p>åˆ°è¿™é‡Œï¼Œé”€é‡å‰Kçš„äº§å“å°±å·²ç»è¢«è®¡ç®—å‡ºæ¥äº†ã€‚</p><p>å’Œæ‰€æœ‰æ•°æ®å¤„ç†æµæ°´çº¿ä¸€æ ·ï¼Œæˆ‘ä»¬éœ€è¦çš„æ˜¯ä¸€ä¸ªå®Œæ•´çš„ç³»ç»Ÿã€‚é‚£ä¹ˆä½ å°±ä¸èƒ½ä»…ä»…æ»¡è¶³äºè®¡ç®—å‡ºç»“æœï¼Œå¿…é¡»è¦è€ƒè™‘ä½ çš„æ•°æ®å¤„ç†ç»“æœå°†æ€æ ·è¢«ä½¿ç”¨ã€‚åœ¨æœ¬æ–‡å¼€å¤´çš„æˆªå›¾ä¸­ï¼Œä½ èƒ½çœ‹åˆ°ï¼Œçƒ­é”€å•†å“éƒ½è¢«æ‰“ä¸Šäº†â€œBest Sellerâ€çš„æ ‡ç­¾ï¼Œç‚¹å‡»â€œBest Sellerâ€æ ‡ç­¾æˆ‘ä»¬è¿˜èƒ½çœ‹åˆ°å®Œæ•´çš„çƒ­é”€æ¦œå•ã€‚</p><p>é‚£ä¹ˆä½ å¯ä»¥è€ƒè™‘ä¸¤ç§servingçš„æ–¹æ¡ˆã€‚</p><p>ä¸€ç§æ˜¯æŠŠçƒ­é”€å•†å“çš„ç»“æœå­˜å‚¨åœ¨ä¸€ä¸ªå•ç‹¬çš„æ•°æ®åº“ä¸­ã€‚ä½†æ˜¯åœ¨servingæ—¶å€™ï¼Œä½ éœ€è¦æŠŠå•†å“æœç´¢ç»“æœå’Œçƒ­é”€å•†å“ç»“æœè¿›è¡Œäº¤å‰æŸ¥è¯¢ã€‚å¦‚æœæœç´¢ç»“æœå­˜åœ¨äºçƒ­é”€å•†å“æ•°æ®åº“ä¸­ï¼Œä½ å°±åœ¨è¿”å›çš„æœç´¢ç»“æœå…ƒç´ ä¸­æŠŠå®ƒæ ‡æ³¨æˆâ€œBest Sellerâ€ã€‚</p><p>å¦ä¸€ä¸ªå¯èƒ½ä¸å¤ªçµæ´»ï¼Œå°±æ˜¯æŠŠçƒ­é”€å•†å“çš„ç»“æœå†™å›åŸæ¥çš„å•†å“æ•°æ®åº“ä¸­ã€‚å¦‚æœæ˜¯çƒ­é”€å•†å“ï¼Œä½ å°±åœ¨â€œæ˜¯çƒ­é”€å•†å“â€è¿™ä¸€åˆ—åšæ ‡è®°ã€‚è¿™ç§æ–¹æ¡ˆçš„ç¼ºç‚¹æ˜¯æ¯æ¬¡æ›´æ–°çƒ­é”€ç»“æœåï¼Œéƒ½è¦å»åŸæ¥çš„æ•°æ®åº“è¿›è¡Œå¤§é‡æ›´æ–°ï¼Œä¸ä»…è¦æŠŠæ–°æˆä¸ºçƒ­é”€çš„å•†å“è¿›è¡Œæ ‡è®°ï¼Œè¿˜è¦å°†è½é€‰å•†å“çš„æ ‡è®°å»é™¤ã€‚</p><p>ä¸¤ç§servingæ–¹æ¡ˆçš„é€‰æ‹©å½±å“äº†ä½ å¯¹äºæ•°æ®å¤„ç†è¾“å‡ºçš„ä¸šåŠ¡éœ€æ±‚ã€‚ç›¸åº”çš„ï¼Œä½ å¯ä»¥æŠŠè¾“å‡ºçš„å‰Ké”€é‡äº§å“ä½¿ç”¨Pipeline outputè¾“å‡ºåˆ°ä¸€ä¸ªå•ç‹¬æ•°æ®åº“ï¼Œä¹Ÿå¯ä»¥ç»Ÿä¸€æ›´æ–°æ‰€æœ‰æ•°æ®åº“ä¸­çš„å•†å“ã€‚</p><h3>2.æ€æ ·è®¾è®¡æ¯å°æ—¶æ›´æ–°çš„çƒ­é”€æ¦œå•ï¼Ÿ</h3><p>åœ¨è®¾è®¡å®ŒåŸºç¡€çš„çƒ­é”€å•†å“å¤„ç†ç³»ç»Ÿåï¼Œæˆ‘ä»¬æ³¨æ„åˆ°åœ¨Amazonçš„çƒ­é”€æ¦œä¸Šæœ‰ä¸€è¡Œå°å­— â€œUpdated hourlyâ€ï¼Œä¹Ÿå°±æ˜¯â€œæ¯å°æ—¶æ›´æ–°â€ã€‚çš„ç¡®ï¼Œçƒ­é”€å•†å“å¾€å¾€æ˜¯æœ‰æ—¶æ•ˆæ€§çš„ã€‚å»å¹´çƒ­é”€çš„iPhone Xä»Šå¹´å°±å˜æˆäº†iPhone XSã€‚Amazoné€‰æ‹©äº†ä»¥å°æ—¶ä¸ºå•ä½æ›´æ–°çƒ­é”€æ¦œå•ç¡®å®æ˜¯åˆç†çš„äº§å“è®¾è®¡ã€‚</p><p>é‚£ä¹ˆæ€æ ·ç”¨Beamå®ç°è¿™ç§å®šæ—¶æ›´æ–°çš„æ•°æ®å¤„ç†ç³»ç»Ÿå‘¢ï¼Ÿ</p><p>å¯èƒ½ä½ åœ¨çœ‹åˆ°â€œæ—¶é—´â€è¿™ä¸ªå…³é”®è¯çš„æ—¶å€™ï¼Œå°±é©¬ä¸Šè”æƒ³åˆ°äº†ç¬¬32è®²ä»‹ç»çš„Beam Windowã€‚ç¡®å®ï¼Œç”¨åŸºäºWindowçš„æµå¤„ç†æ¨¡å¼æ˜¯ä¸€ä¸ªå€¼å¾—è€ƒè™‘çš„æ–¹æ¡ˆã€‚æˆ‘åœ¨è¿™é‡Œæ•…æ„æŠŠé—®é¢˜è®¾ç½®å¾—æ¯”è¾ƒæ¨¡ç³Šã€‚å…¶å®æ˜¯å› ä¸ºè¿™éœ€è¦å–å†³äºå…·ä½“çš„ä¸šåŠ¡éœ€æ±‚ï¼Œå®é™…ä¸Šä½ ä¹Ÿå¯ä»¥é€‰æ‹©æ‰¹å¤„ç†æˆ–è€…æµå¤„ç†çš„æ–¹å¼ã€‚</p><p>æˆ‘ä»¬å…ˆä»ç®€å•çš„æ‰¹å¤„ç†æ¨¡å¼å¼€å§‹ã€‚</p><p>åœ¨å¤„ç†å·¥ç¨‹é—®é¢˜æ—¶ï¼Œæˆ‘ä»¬éƒ½æ˜¯å…ˆçœ‹æœ€ç®€å•çš„æ–¹æ¡ˆèƒ½å¦æ”¯æ’‘èµ·æ¥ä¸šåŠ¡éœ€æ±‚ï¼Œé¿å…ä¸ºäº†ä½“ç°å·¥ç¨‹éš¾åº¦è€Œæ•…æ„å°†ç³»ç»Ÿå¤æ‚åŒ–ã€‚é‡‡ç”¨æ‰¹å¤„ç†çš„æ–¹å¼çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥æ¯éš”ä¸€ä¸ªå°æ—¶è¿è¡Œä¸€éä¸Šä¸€ä¸ªå°æ ‡é¢˜ä¸­çš„åŸºç¡€ç‰ˆçƒ­é”€å•†å“ç³»ç»Ÿï¼Œä¹Ÿå°±æ˜¯éƒ¨ç½²æˆcron jobçš„æ¨¡å¼ã€‚</p><p>ä½†ä½ è¦æ³¨æ„ï¼Œå¦‚æœæˆ‘ä»¬ä¸ä¿®æ”¹ä»£ç çš„è¯ï¼Œæ¯ä¸€æ¬¡è¿è¡Œéƒ½ä¼šè®¡ç®—ç›®å‰ä¸ºæ­¢æ‰€æœ‰é”€å”®çš„å•†å“ã€‚å¦‚æœè¿™ä¸æ˜¯ä½ çš„ä¸šåŠ¡éœ€æ±‚ï¼Œä½ å¯ä»¥åœ¨æ‰¹å¤„ç†çš„æ•°æ®è¾“å…¥æ­¥éª¤ä¸­ï¼Œæ ¹æ®ä½ çš„é”€å”®è®°å½•è¡¨çš„æ—¶é—´æˆ³æ¥ç­›é€‰æƒ³è¦è®¡ç®—çš„æ—¶é—´æ®µã€‚æ¯”å¦‚ï¼Œä½ å¯ä»¥è®¾ç½®æˆæ¯ä¸€æ¬¡è¿è¡Œéƒ½åªè®¡ç®—ä»è¿è¡Œæ—¶é—´å‰6ä¸ªæœˆåˆ°è¯¥è¿è¡Œæ—¶é—´ä¸ºæ­¢ã€‚</p><p>å…¶å®ï¼Œæ‰¹å¤„ç†çš„æ¨¡å¼å·²ç»èƒ½è§£å†³æˆ‘ä»¬ç›®å‰ä¸ºæ­¢çš„å¤§éƒ¨åˆ†ä¸šåŠ¡éœ€æ±‚ã€‚ä½†æœ‰æ—¶å€™æˆ‘ä»¬ä¸å¾—ä¸å»ä½¿ç”¨æµå¤„ç†ã€‚æ¯”å¦‚ï¼Œå¦‚æœå­˜å‚¨é”€å”®è®°å½•çš„å›¢é˜Ÿå’Œä½ å±äºä¸åŒçš„éƒ¨é—¨ï¼Œä½ æ²¡æœ‰æƒé™å»ç›´æ¥è¯»å–ä»–ä»¬çš„æ•°æ®åº“ï¼Œä»–ä»¬éƒ¨é—¨åªå¯¹å¤–åˆ†äº«ä¸€ä¸ªPub/Subçš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚è¿™æ—¶å€™å°±æ˜¯æµå¤„ç†åº”ç”¨çš„ç»ä½³åœºæ™¯ã€‚</p><p>ä¸çŸ¥é“ä½ è¿˜è®°ä¸è®°å¾—ç¬¬33è®²ä¸­æˆ‘æåˆ°è¿‡ï¼Œåœ¨Streamingç‰ˆæœ¬çš„WordCountä¸­ç›‘å¬ä¸€ä¸ªKafkaæ¶ˆæ¯é˜Ÿåˆ—çš„ä¾‹å­ã€‚åŒæ ·çš„ï¼Œè¿™æ—¶å€™ä½ å¯ä»¥è®¢é˜…æ¥è‡ªè¿™ä¸ªéƒ¨é—¨çš„é”€å”®æ¶ˆæ¯ã€‚</p><p>Java</p><pre><code>pipeline\n    .apply(KafkaIO.&lt;String, Long&gt;read()\n       .withBootstrapServers(&quot;broker_1:9092,broker_2:9092&quot;)\n       .withTopic(&quot;sales_record&quot;)  // use withTopics(List&lt;String&gt;) to read from multiple topics.\n       .withKeyDeserializer(StringDeserializer.class)\n       .withValueDeserializer(StringDeserializer.class)\n       .withLogAppendTime()\n    )\n</code></pre><p>ä¹‹åä½ å¯ä»¥ä¸ºä½ çš„è¾“å…¥PCollectionæ·»åŠ çª—å£ï¼Œå’ŒWordCountä¸€æ ·ã€‚ä¸è¿‡è¿™æ—¶å€™ä½ å¾ˆæœ‰å¯èƒ½éœ€è¦æ»‘åŠ¨çª—å£ï¼Œå› ä¸ºä½ çš„çª—å£æ˜¯æ¯å°æ—¶ç§»åŠ¨ä¸€æ¬¡ã€‚</p><p>Java</p><pre><code>PCollection&lt;String&gt; windowedProductIds = input\n  .apply(Window.&lt;String&gt;into(\n    SlidingWindows.of(Duration.standardMonths(options.getWindowSize()))));\n</code></pre><h3>3.æ€æ ·è®¾è®¡å•†å“å»é‡å¤„ç†æµæ°´çº¿å’Œæ€æ ·æ ¹æ®å•†å“åœ¨å”®çŠ¶æ€è¿‡æ»¤çƒ­é”€å•†å“ï¼Ÿ</h3><p>é€šè¿‡å‰é¢çš„å†…å®¹ï¼Œæˆ‘ä»¬å·²ç»è®¾è®¡å‡ºäº†èƒ½å¤Ÿæ¯å°æ—¶æ›´æ–°çš„çƒ­é”€æ¦œå•ã€‚ä½†ä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰æ³¨æ„åˆ°ï¼Œå…¶å®æˆ‘ä»¬ä¹‹å‰çš„é—®é¢˜è®¾ç½®æ˜¯è¿‡äºç®€åŒ–äº†ï¼Œå¿½ç•¥äº†å¾ˆå¤šç°å®è€Œé‡è¦çš„é—®é¢˜ï¼Œæ¯”å¦‚ï¼š</p><ul>\n<li>æ€æ ·å¤„ç†é€€è´§çš„å•†å“ï¼Ÿ</li>\n<li>æ€æ ·å¤„ç†åº—å®¶å› ä¸ºæ”¶åˆ°å·®è¯„æ•…æ„æŠŠå•†å“ä¸‹æ¶æ¢ä¸ªé©¬ç”²é‡æ–°ä¸Šæ¶ï¼Ÿ</li>\n<li>æ€æ ·å¤„ç†é‚£äº›è™½ç„¶æ›¾ç»çƒ­é”€ä½†æ˜¯ç°åœ¨å·²ç»ä¸å†å‡ºå”®çš„å•†å“ï¼Ÿ</li>\n</ul><p>è¿™äº›é—®é¢˜éƒ½éœ€è¦ä½¿ç”¨ç¬¬28è®²ä¸­ä»‹ç»çš„Pipelineçš„åŸºæœ¬è®¾è®¡æ¨¡å¼ï¼šè¿‡æ»¤æ¨¡å¼ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/47/0f/47498fc9b2d41c59ffb286d84c4f220f.jpg?wh=1674*1244\" alt=\"\"></p><p>æˆ‘ä»¬è¿™ä¸ªæ¡ˆä¾‹ä¸­æ‰€éœ€è¦çš„è¿‡æ»¤æ¡ä»¶æ˜¯ï¼š</p><ul>\n<li>æŠŠé€€è´§çš„å•†å“é”€é‡å‡å»</li>\n<li>æŠŠé‡å¤çš„å•†å“é”€é‡è¿›è¡Œå åŠ </li>\n<li>å°†åœ¨å”®å•†å“è¿‡æ»¤å‡ºæ¥</li>\n</ul><p>ä¸€èµ·æ¥æƒ³æƒ³è¿™äº›è¿‡æ»¤æ¡ä»¶åº”è¯¥æ€ä¹ˆå®ç°å§ã€‚</p><p>å¯¹äºé€€è´§å•†å“ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæ‰€æœ‰é€€è´§çš„è®°å½•æŒ‘å‡ºæ¥è¿›è¡Œç»Ÿè®¡ã€‚åŒæ ·å¯¹äºæ¯ä¸€ä¸ªå•†å“idï¼Œå¦‚æœæˆ‘ä»¬æŠŠå‡ºå”®çš„è®¡æ•°å‡å»é€€è´§çš„è®¡æ•°å°±å¯ä»¥å¾—åˆ°æˆåŠŸé”€å”®çš„è®¡æ•°ã€‚</p><p>è€Œäº‹å®ä¸Šï¼Œå®é™…äº¤æ˜“ç³»ç»Ÿå¯¹äºå•†å“çŠ¶æ€çš„è·Ÿè¸ªä¼šè¯¦ç»†å¾—å¤šï¼Œæ¯ä¸€ä¸ªè®¢å•æœ€ç»ˆè½åœ¨é€€è´§çŠ¶æ€è¿˜æ˜¯æˆåŠŸé”€å”®çŠ¶æ€éƒ½å¯ä»¥åœ¨äº¤æ˜“æ•°æ®åº“ä¸­æŸ¥è¯¢å¾—åˆ°ã€‚æˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸ªå°è£…åœ¨isSuccessfulSale()æ–¹æ³•ä¸­ã€‚</p><p>é‡å¤çš„å•†å“åœ¨ä¸€ä¸ªæˆç†Ÿçš„äº¤æ˜“ç³»ç»Ÿä¸­ä¸€èˆ¬ä¼šæœ‰å¦å¤–ä¸€ä¸ªå»é‡çš„æ•°æ®å¤„ç†æµæ°´çº¿ã€‚å®ƒèƒ½æ ¹æ®å•†å“æè¿°ã€å•†å“å›¾ç‰‡ç­‰æ¨æµ‹é‡å¤çš„å•†å“ã€‚æˆ‘ä»¬å‡è®¾åœ¨æˆ‘ä»¬ç³»ç»Ÿä¸­å·²ç»æœ‰äº†product_unique_idè¿™æ ·ä¸€ä¸ªè®°å½•ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªè¦æŠŠä¹‹å‰è¿›è¡Œç»Ÿè®¡çš„product_idæ›¿æ¢æˆç»Ÿè®¡product_unique_idå°±è¡Œäº†ã€‚</p><p>è¿‡æ»¤åœ¨å”®çš„å•†å“å¯èƒ½æœ‰å¤šç§å®ç°æ–¹å¼ï¼Œå–å†³äºä½ çš„å°ç»„æœ‰æ²¡æœ‰æƒé™è¯»å–æ‰€éœ€çš„æ•°æ®åº“ã€‚</p><p>å‡å¦‚ä½ å¯ä»¥è¯»å–ä¸€ä¸ªå•†å“çŠ¶æ€çš„æ•°æ®åº“åˆ—ï¼Œé‚£ä½ å¯ä»¥ç›´æ¥æ ¹æ® [å•†å“çŠ¶æ€=åœ¨å”®] è¿™æ ·çš„åˆ¤æ–­æ¡ä»¶è¿›è¡Œè¿‡æ»¤ã€‚å‡å¦‚ä½ ä¸èƒ½è¯»å–å•†å“çŠ¶æ€ï¼Œé‚£ä½ å¯èƒ½éœ€è¦æŸ¥è¯¢åœ¨å”®çš„å•†å“ä¸­æ˜¯å¦æœ‰ä½ çš„è¿™ä¸ªå•†å“idæ¥è¿›è¡Œåˆ¤æ–­ã€‚ä½†åœ¨è¿™ä¸€è®²ä¸­ï¼Œæˆ‘ä»¬å…ˆå¿½ç•¥å®ç°ç»†èŠ‚ï¼ŒæŠŠè¿™ä¸ªè¿‡æ»¤é€»è¾‘å°è£…åœ¨isInStock()æ–¹æ³•ä¸­ã€‚</p><p>æœ€ç»ˆæˆ‘ä»¬çš„è¿‡æ»¤å¤„ç†æ­¥éª¤ä¼šæ˜¯ç±»ä¼¼ä¸‹é¢è¿™æ ·çš„ã€‚åªæœ‰åŒæ—¶æ»¡è¶³isSuccessfulSale()å’ŒisInStock()çš„product_unique_idï¼Œæ‰ä¼šè¢«æˆ‘ä»¬åç»­çš„é”€é‡ç»Ÿè®¡æ­¥éª¤æ‰€è®¡ç®—ã€‚</p><p>Java</p><pre><code>PCollection&lt;Product&gt; productCollection = ...;\n\nPCollection&lt;Product&gt; qualifiedProductCollection = productCollection\n  .apply(â€œuniqueProductTransformâ€, Distinct.withRepresentativeValueFn(\n      new SerializableFunction&lt;Product, Long&gt;() {\n        @Override\n        public Long apply(Product input) {\n          return input.productUniqueId();\n        }\n      }).withRepresentativeType(TypeDescriptor.of(Long.class))\n  )\n    .apply(&quot;filterProductTransform&quot;, ParDo.of(new DoFn&lt;Product, Product&gt;(){\n    @ProcessElement\n    public void processElement(ProcessContext c) {\n      if (isSuccessfulSale(c.element()) &amp;&amp; isInStockc.element())) {\n        c.output(c.element());\n      }\n    }\n  }));\n</code></pre><h3>4.æ€æ ·æŒ‰ä¸åŒçš„å•†å“é—¨ç±»ç”Ÿæˆæ¦œå•ï¼Ÿ</h3><p>æˆ‘ä»¬è¿˜æ³¨æ„åˆ°äºšé©¬é€Šçš„çƒ­é”€æ¦œæ˜¯æŒ‰ç…§ä¸åŒçš„å•†å“ç§ç±»çš„ã€‚ä¹Ÿå°±è¯´æ¯ä¸€ä¸ªå•†å“åˆ†ç±»éƒ½æœ‰è‡ªå·±çš„æ¦œå•ã€‚è¿™æ˜¯å¾ˆåˆç†çš„ä¸šåŠ¡è®¾è®¡ï¼Œå› ä¸ºä½ ä¸å¯èƒ½ä¼šå»æŠŠé£æœºçš„é”€é‡å’Œæ‰‹æœºçš„é”€é‡ç›¸æ¯”ï¼Œæ‰‹æœºå¯èƒ½äººæ‰‹ä¸€ä¸ªï¼Œé£æœºæ— æ³•äººæ‰‹ä¸€ä¸ªã€‚</p><p>è¿™æ—¶å€™æˆ‘ä»¬åœ¨ç¬¬28è®²æ‰€å­¦çš„åˆ†ç¦»æ¨¡å¼è®¾è®¡å°±èƒ½å¤§æ˜¾èº«æ‰‹äº†ã€‚åˆ†ç¦»æ¨¡å¼æŠŠä¸€ä¸ªPCollectionæŒ‰ç…§ç±»åˆ«åˆ†ç¦»æˆäº†å‡ ä¸ªå°çš„å­PCollectionã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/c5/85/c5d84c2aab2e02cc6e1d2e9f7c40e185.jpg?wh=1902*936\" alt=\"\"></p><p>åœ¨è¿™ä¸ªæ¡ˆä¾‹é‡Œï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦å¯¹å•†å“è¿›è¡Œåˆ†ç¦»ã€‚</p><p>ä¸ç»å…¸çš„åˆ†ç¦»æ¨¡å¼ä¸åŒï¼Œæˆ‘ä»¬è¿™é‡Œæ¯ä¸€ä¸ªå•†å“å¯èƒ½éƒ½å±äºå¤šä¸ªç±»åˆ«ã€‚æ¯”å¦‚ä¸€åŒé‹å­ï¼Œå®ƒå¯èƒ½æ—¢å½’ç±»ä¸ºâ€œæˆ·å¤–â€ï¼Œä¹Ÿå½’ç±»ä¸ºâ€œæ½®é‹â€ã€‚è¿˜è®°å¾—åˆ†ç¦»æ¨¡å¼åœ¨Beamä¸­æ€ä¹ˆå®ç°å—ï¼Ÿæ²¡é”™å°±æ˜¯ä½¿ç”¨output tagã€‚æˆ‘ä»¬å…ˆè¦ä¸ºæ¯ä¸€ç§åˆ†ç±»å®šä¹‰tagï¼Œæ¯”å¦‚åˆšæ‰è¯´çš„outdoorTagå’ŒfashionTagã€‚å†æŠŠç›¸åº”çš„å•†å“è¾“å‡ºè¿›å¯¹åº”çš„tagä¸­ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><p>Java</p><pre><code>// é¦–å…ˆå®šä¹‰æ¯ä¸€ä¸ªoutputçš„tag\nfinal TupleTag&lt;Product&gt; outdoorTag = new TupleTag&lt;Product&gt;(){};\nfinal TupleTag&lt;Product&gt; fashionTag = new TupleTag&lt;Product&gt;(){};\n\nPCollection&lt;Product&gt; salesCollection = ...;\n\nPCollectionTuple mixedCollection =\n    userCollection.apply(ParDo\n        .of(new DoFn&lt;Product, Product&gt;() {\n          @ProcessElement\n          public void processElement(ProcessContext c) {\n            if (isOutdoorProduct(c.element())) {\n              c.output(c.element());\n            } else if (isFashionProduct(c.element())) {\n              c.output(fashionTag, c.element());\n\t        }\n          }\n        })\n        .withOutputTags(outdoorTag, TupleTagList.of(fashionTag)));\n\n// åˆ†ç¦»å‡ºä¸åŒçš„å•†å“åˆ†ç±»\nmixedCollection.get(outdoorTag).apply(...);\n\nmixedCollection.get(fashionTag).apply(...);\n</code></pre><h2>å°ç»“</h2><p>è¿™ä¸€è®²æˆ‘ä»¬ä»åŸºç¡€å•†å“æ’è¡Œæ¦œç³»ç»Ÿå‡ºå‘ï¼Œåˆ©ç”¨åˆ°äº†ä¹‹å‰å­¦çš„æ•°æ®å¤„ç†è®¾è®¡æ¨¡å¼å’ŒBeamç¼–ç¨‹æ–¹æ³•ã€‚</p><p>åŒæ—¶ï¼Œæ¢ç´¢äº†ä»¥æ‰¹å¤„ç†è®¡ç®—ä¸ºåŸºç¡€çš„çƒ­é”€å•†å“åˆ—è¡¨ã€‚æˆ‘ä»¬è®¾è®¡äº†æ¯å°æ—¶æ›´æ–°çš„çƒ­é”€æ¦œå•ã€å•†å“å»é‡å¤„ç†æµæ°´çº¿ï¼Œæ ¹æ®å•†å“åœ¨å”®çŠ¶æ€è¿‡æ»¤å‡ºçƒ­é”€å•†å“ï¼Œå¹¶æŒ‰ä¸åŒçš„å•†å“é—¨ç±»ç”Ÿæˆæ¦œå•ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>ä¸€ä¸ªå•†å“æ’åç³»ç»Ÿä¸­è¿˜æœ‰å¤ªå¤šéœ€è¦è§£å†³çš„å·¥ç¨‹é—®é¢˜ï¼Œä½ è§‰å¾—å“ªäº›ä¹Ÿå¯ä»¥åˆ©ç”¨å¤§è§„æ¨¡æ•°æ®å¤„ç†æŠ€æœ¯è®¾è®¡è§£å†³ï¼Ÿ</p><p>æ¬¢è¿ä½ æŠŠç­”æ¡ˆå†™åœ¨ç•™è¨€åŒºï¼Œä¸æˆ‘å’Œå…¶ä»–åŒå­¦ä¸€èµ·è®¨è®ºã€‚å¦‚æœä½ è§‰å¾—æœ‰æ‰€æ”¶è·ï¼Œä¹Ÿæ¬¢è¿æŠŠæ–‡ç« åˆ†äº«ç»™ä½ çš„æœ‹å‹ã€‚</p><p></p>","neighbors":{"left":{"article_title":"33 | æ¨ªçœ‹æˆå²­ä¾§æˆå³°ï¼šå†æˆ˜Streaming WordCount","id":106491},"right":{"article_title":"35 | Facebookæ¸¸æˆå®æ—¶æµå¤„ç†Beam Pipelineå®æˆ˜ï¼ˆä¸Šï¼‰","id":107529}},"comments":[{"had_liked":false,"id":113645,"user_name":"Ming","can_delete":false,"product_type":"c1","uid":1516011,"ip_address":"","ucode":"69BB73B8AB7E3F","user_header":"https://static001.geekbang.org/account/avatar/00/17/21/eb/bb2e7a3b.jpg","comment_is_top":false,"comment_ctime":1563104103,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"40217809767","product_id":100025301,"comment_content":"æœ¬è®²æ˜¯è¿™ä¸ªè¯¾ç¨‹ä¸­ä¿¡æ¯é‡æœ€é«˜çš„æ–‡ç« ä¹‹ä¸€ ğŸ‘ğŸ‘ğŸ‘ <br><br>ä¸è¿‡æˆ‘ç›¸ä¿¡å…·ä½“å®ç°ä¸­çš„ç»†èŠ‚åº”è¯¥è¿˜æœ‰å¾ˆå¤šã€‚ä¸çŸ¥é“ä½œè€…æœ‰æ²¡æœ‰æœºä¼šåˆ†äº«ä¸€ä¸‹å¸¸è§çš„å®ç°è¯¯åŒºå’Œpitfallï¼Ÿ<br><br>é™¤æ­¤ä¹‹å¤–ï¼Œä¸çŸ¥é“æ–‡ç« è¯´çš„è¿™äº›æ–¹æ¡ˆåœ¨å¹¶å‘çš„èƒ½åŠ›ä¸Šå¦‚ä½•ï¼Ÿå‡å¦‚æœ‰adhoc+å¹¶å‘çš„å¤§æ•°æ®åœºæ™¯ï¼Œå¸¸è§çš„å¤§æ•°æ®æ–¹æ¡ˆä¼¼ä¹åœ¨æˆæœ¬ä¸Šéƒ½å¾ˆé«˜ã€‚è¿™ç®—æ˜¯ä¸ªå¤§æ•°æ®ä¸Šçš„å›ºæœ‰(intrinsic)éš¾é¢˜åš’ï¼Ÿ","like_count":10},{"had_liked":false,"id":113496,"user_name":"YZJ","can_delete":false,"product_type":"c1","uid":1260810,"ip_address":"","ucode":"88B2A495A33197","user_header":"https://static001.geekbang.org/account/avatar/00/13/3d/0a/5f2a9a4c.jpg","comment_is_top":false,"comment_ctime":1563032452,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"14447934340","product_id":100025301,"comment_content":"æœ‰äººçœ‹æ˜ç™½ä¸ºå•¥è¦ç”¨Distinct.withRepresentativeValueFnäº†ä¹ˆï¼Œ æˆ‘ç†è§£å°±æ˜¯ä¸ªæ™®é€šçš„è½¬æ¢ï¼Œå°†productIdè½¬æˆproducetUniqueId, ä¸ºä»€ä¹ˆè¦ç”¨Distinctå‘¢ï¼Ÿ<br>","like_count":3,"discussions":[{"author":{"id":1503644,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIlfPxNV992tuuic57ehdqaSQMUlWZH5JJ7RGVUW32U2rDOl4ialRbRqfFy4H2YbCNy1Zg0HL4zzlmA/132","nickname":"Loic","note":"","ucode":"E594167599123A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":353472,"discussion_content":"çœ‹èµ·æ¥æ˜¯å»é‡é¿å…é‡å¤è®¡ç®—ï¼Ÿè¿™æ®µä»£ç åº”è¯¥æ˜¯é’ˆå¯¹ç¬¬ä¸‰ç‚¹å»æ‰éåœ¨å”®å•†å“åšçš„å¤„ç†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1615167523,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":187934,"user_name":"Fiery","can_delete":false,"product_type":"c1","uid":1897610,"ip_address":"","ucode":"CDB000687A6B14","user_header":"","comment_is_top":false,"comment_ctime":1584279672,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10174214264","product_id":100025301,"comment_content":"&quot;æŒ‰ä¸åŒçš„å•†å“é—¨ç±»ç”Ÿæˆæ¦œå•&quot;è¿™ä¸ªéƒ¨åˆ†ï¼Œæ–‡ç« åªæ˜¯ç®€å•è¯´äº†ä¸€ä¸‹æ€ä¹ˆç”¨APIè€Œå·²ï¼Œä½†æ˜¯å®é™…ä½¿ç”¨ä¸­å•†å“é—¨ç±»éå¸¸ä¹‹å¤šï¼Œå¦‚ä½•ä½¿ç”¨åˆç†çš„æ–¹æ¡ˆå¤„ç†Amazonä¸Šåƒç§é—¨ç±»ï¼Œä¸Šä¸‡ç§å•†å“ï¼ˆæ¯ç§å•†å“å¯èƒ½å±äºå¤šä¸ªé—¨ç±»ï¼‰çš„å®æ—¶é”€é‡åœ¨pipelineä¸­æ‰¹é‡å¤„ç†çš„æƒ…å†µï¼Ÿè¿˜è¯·ä»”ç»†è®²ä¸€ä¸‹ï¼Œæ¯•ç«Ÿæ˜¯â€œå®æˆ˜â€ä¸æ˜¯åªæ˜¯è¿‡å®¶å®¶çš„toy appã€‚","like_count":3},{"had_liked":false,"id":133912,"user_name":"æ¥šå¤©è¡Œ","can_delete":false,"product_type":"c1","uid":1100648,"ip_address":"","ucode":"B4DD986060ECD4","user_header":"https://static001.geekbang.org/account/avatar/00/10/cb/68/d8a4f907.jpg","comment_is_top":false,"comment_ctime":1568696508,"is_pvip":true,"discussion_count":2,"race_medal":0,"score":"10158631100","product_id":100025301,"comment_content":"è€å¸ˆä½ å¥½ï¼Œè¿™é‡Œæœ‰ä¸¤ç‚¹ç–‘é—®ï¼š<br>ï¼ˆ1ï¼‰isSuccessfulSale å’Œ inStockï¼Œä¸èƒ½æ€»æ˜¯å»äº¤æ˜“ç³»ç»Ÿå®æ—¶å»æŸ¥çš„å§ï¼Ÿè¿™æ ·å¼€é”€ä¼šå¾ˆå¤§ã€‚<br>ï¼ˆ2ï¼‰æ˜¯å¦å¯ä»¥æœ€ååœ¨å¤„ç†è¿™ä¸ªçŠ¶æ€ï¼Ÿè™½ç„¶æ˜¯æœ€åè¢«åˆå¹¶åçš„å€¼ï¼Œè¿™æ ·åªéœ€è¦å¾ˆå°‘çš„è°ƒç”¨æ¬¡æ•°å°±å¯ä»¥å®ç°äº†æ•ˆæœ","like_count":2,"discussions":[{"author":{"id":1897610,"avatar":"","nickname":"Fiery","note":"","ucode":"CDB000687A6B14","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":204832,"discussion_content":"é€€è´§è¿™ä¸ªæ„Ÿè§‰è¿˜æ˜¯æœ€å¥½æŠŠé€€è´§äº‹ä»¶filterå‡ºæ¥ç„¶åå•ç‹¬æ±‚countï¼Œç„¶åå’Œsaleçš„countåšstream joinå¥½ä¸€äº›å§ï¼Œä½†æ˜¯stream joinéƒ½æ˜¯æœ‰watermarkå’Œæ—¶æ•ˆæ€§é™åˆ¶çš„ï¼Œå¦åˆ™å†…å­˜å‹åŠ›å¤ªå¤§äº†ï¼Œæ€»ä¸èƒ½è®¾å®šjoinçš„æœ‰æ•ˆæ—¶é•¿æˆé€€è´§æœŸé™çš„30å¤©90å¤©è¿™æ ·å§ï¼Ÿè¿˜æ˜¯è¯´å› ä¸ºåªæ˜¯å­˜äº§å“çš„countæ‰€ä»¥ç”Ÿäº§ä¸­çš„å¤§è§„æ¨¡é›†ç¾¤çœŸçš„æ˜¯è¿™ä¹ˆæçš„?","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1584230949,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1100648,"avatar":"https://static001.geekbang.org/account/avatar/00/10/cb/68/d8a4f907.jpg","nickname":"æ¥šå¤©è¡Œ","note":"","ucode":"B4DD986060ECD4","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1897610,"avatar":"","nickname":"Fiery","note":"","ucode":"CDB000687A6B14","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":243517,"discussion_content":"éš¾","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587547317,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":204832,"ip_address":""},"score":243517,"extra":""}]}]},{"had_liked":false,"id":119417,"user_name":"_yiunia##è¿œ","can_delete":false,"product_type":"c1","uid":1138369,"ip_address":"","ucode":"AF508C3D0EB954","user_header":"https://static001.geekbang.org/account/avatar/00/11/5e/c1/cd721d46.jpg","comment_is_top":false,"comment_ctime":1564582504,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5859549800","product_id":100025301,"comment_content":"â€œæ€æ ·è®¾è®¡æ¯å°æ—¶æ›´æ–°çš„çƒ­é”€æ¦œå•â€<br>æ»‘åŠ¨çª—å£ä¸€å°æ—¶æ»šåŠ¨ä¸€æ¬¡ï¼Œè€Œæ•°æ®æµåœ¨ä¸€ç›´æ‹‰å–ï¼Œè¿™æ®µæ—¶é—´å†…çš„æ•°æ®éƒ½æ˜¯å­˜åœ¨å†…å­˜é‡Œä¹ˆï¼Ÿä¸ä¼šçˆ†æ‰ä¹ˆï¼Ÿè¿˜æ˜¯å¦å¤–æœ‰èšåˆçš„é€»è¾‘","like_count":1},{"had_liked":false,"id":117105,"user_name":"æå­Ÿ","can_delete":false,"product_type":"c1","uid":1006768,"ip_address":"","ucode":"AD2349CB12F130","user_header":"https://static001.geekbang.org/account/avatar/00/0f/5c/b0/77e5f8c8.jpg","comment_is_top":false,"comment_ctime":1563968863,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1563968863","product_id":100025301,"comment_content":"è€å¸ˆæˆ‘æƒ³é—®ä¸‹ï¼Œ PCollection&lt;String&gt;è¿™ä¸ªç§æ‡’åŠ è½½å‡ºæ¥çš„é›†åˆæ€ä¹ˆè½¬å­˜æˆä¸´æ—¶çš„listé›†åˆï¼Ÿ","like_count":0},{"had_liked":false,"id":114460,"user_name":"Tim","can_delete":false,"product_type":"c1","uid":1393323,"ip_address":"","ucode":"A3ECD9832D630D","user_header":"https://static001.geekbang.org/account/avatar/00/15/42/ab/75fb1cd6.jpg","comment_is_top":false,"comment_ctime":1563322283,"is_pvip":false,"replies":[{"id":"42081","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"å»¿ä¸ƒ","uid":"1386753","ctime":1563514964,"ip_address":"","comment_id":114460,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1563322283","product_id":100025301,"comment_content":"æ€»ç®—è¿½ä¸Šè¿›åº¦äº†ï¼Œmarkä¸‹ï½æ•´ç†ç‚¹ç–‘é—®ç»§ç»­è¿½åŠ è¿‡æ¥ï½","like_count":0,"discussions":[{"author":{"id":1386753,"avatar":"https://static001.geekbang.org/account/avatar/00/15/29/01/20caec2f.jpg","nickname":"Yeon","note":"","ucode":"ED3549F94EB36E","race_medal":0,"user_type":4,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":458673,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563514964,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":4}","child_discussion_number":0,"child_discussions":[]}]}]}