{"id":80801,"title":"40 | insertè¯­å¥çš„é”ä¸ºä»€ä¹ˆè¿™ä¹ˆå¤šï¼Ÿ","content":"<p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘æåˆ°MySQLå¯¹è‡ªå¢ä¸»é”®é”åšäº†ä¼˜åŒ–ï¼Œå°½é‡åœ¨ç”³è¯·åˆ°è‡ªå¢idä»¥åï¼Œå°±é‡Šæ”¾è‡ªå¢é”ã€‚</p><p>å› æ­¤ï¼Œinsertè¯­å¥æ˜¯ä¸€ä¸ªå¾ˆè½»é‡çš„æ“ä½œã€‚ä¸è¿‡ï¼Œè¿™ä¸ªç»“è®ºå¯¹äºâ€œæ™®é€šçš„insertè¯­å¥â€æ‰æœ‰æ•ˆã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿˜æœ‰äº›insertè¯­å¥æ˜¯å±äºâ€œç‰¹æ®Šæƒ…å†µâ€çš„ï¼Œåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­éœ€è¦ç»™å…¶ä»–èµ„æºåŠ é”ï¼Œæˆ–è€…æ— æ³•åœ¨ç”³è¯·åˆ°è‡ªå¢idä»¥åå°±ç«‹é©¬é‡Šæ”¾è‡ªå¢é”ã€‚</p><p>é‚£ä¹ˆï¼Œä»Šå¤©è¿™ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬å°±ä¸€èµ·æ¥èŠèŠè¿™ä¸ªè¯é¢˜ã€‚</p><h1>insert â€¦ select è¯­å¥</h1><p>æˆ‘ä»¬å…ˆä»æ˜¨å¤©çš„é—®é¢˜è¯´èµ·å§ã€‚è¡¨tå’Œt2çš„è¡¨ç»“æ„ã€åˆå§‹åŒ–æ•°æ®è¯­å¥å¦‚ä¸‹ï¼Œä»Šå¤©çš„ä¾‹å­æˆ‘ä»¬è¿˜æ˜¯é’ˆå¯¹è¿™ä¸¤ä¸ªè¡¨å±•å¼€ã€‚</p><pre><code>CREATE TABLE `t` (\n  `id` int(11) NOT NULL AUTO_INCREMENT,\n  `c` int(11) DEFAULT NULL,\n  `d` int(11) DEFAULT NULL,\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `c` (`c`)\n) ENGINE=InnoDB;\n\ninsert into t values(null, 1,1);\ninsert into t values(null, 2,2);\ninsert into t values(null, 3,3);\ninsert into t values(null, 4,4);\n\ncreate table t2 like t\n</code></pre><p>ç°åœ¨ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹ä¸ºä»€ä¹ˆåœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œbinlog_format=statementæ—¶æ‰§è¡Œï¼š</p><pre><code>insert into t2(c,d) select c,d from t;\n</code></pre><p>è¿™ä¸ªè¯­å¥æ—¶ï¼Œéœ€è¦å¯¹è¡¨tçš„æ‰€æœ‰è¡Œå’Œé—´éš™åŠ é”å‘¢ï¼Ÿ</p><p>å…¶å®ï¼Œè¿™ä¸ªé—®é¢˜æˆ‘ä»¬éœ€è¦è€ƒè™‘çš„è¿˜æ˜¯æ—¥å¿—å’Œæ•°æ®çš„ä¸€è‡´æ€§ã€‚æˆ‘ä»¬çœ‹ä¸‹è¿™ä¸ªæ‰§è¡Œåºåˆ—ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/33/86/33e513ee55d5700dc67f32bcdafb9386.png?wh=931*104\" alt=\"\"></p><center><span class=\"reference\">å›¾1 å¹¶å‘insertåœºæ™¯</span></center><p>å®é™…çš„æ‰§è¡Œæ•ˆæœæ˜¯ï¼Œå¦‚æœsession Bå…ˆæ‰§è¡Œï¼Œç”±äºè¿™ä¸ªè¯­å¥å¯¹è¡¨tä¸»é”®ç´¢å¼•åŠ äº†(-âˆ,1]è¿™ä¸ªnext-key lockï¼Œä¼šåœ¨è¯­å¥æ‰§è¡Œå®Œæˆåï¼Œæ‰å…è®¸session Açš„insertè¯­å¥æ‰§è¡Œã€‚</p><p>ä½†å¦‚æœæ²¡æœ‰é”çš„è¯ï¼Œå°±å¯èƒ½å‡ºç°session Bçš„insertè¯­å¥å…ˆæ‰§è¡Œï¼Œä½†æ˜¯åå†™å…¥binlogçš„æƒ…å†µã€‚äºæ˜¯ï¼Œåœ¨binlog_format=statementçš„æƒ…å†µä¸‹ï¼Œbinlogé‡Œé¢å°±è®°å½•äº†è¿™æ ·çš„è¯­å¥åºåˆ—ï¼š</p><!-- [[[read_end]]] --><pre><code>insert into t values(-1,-1,-1);\ninsert into t2(c,d) select c,d from t;\n</code></pre><p>è¿™ä¸ªè¯­å¥åˆ°äº†å¤‡åº“æ‰§è¡Œï¼Œå°±ä¼šæŠŠid=-1è¿™ä¸€è¡Œä¹Ÿå†™åˆ°è¡¨t2ä¸­ï¼Œå‡ºç°ä¸»å¤‡ä¸ä¸€è‡´ã€‚</p><h1>insert å¾ªç¯å†™å…¥</h1><p>å½“ç„¶äº†ï¼Œæ‰§è¡Œinsert â€¦ select çš„æ—¶å€™ï¼Œå¯¹ç›®æ ‡è¡¨ä¹Ÿä¸æ˜¯é”å…¨è¡¨ï¼Œè€Œæ˜¯åªé”ä½éœ€è¦è®¿é—®çš„èµ„æºã€‚</p><p>å¦‚æœç°åœ¨æœ‰è¿™ä¹ˆä¸€ä¸ªéœ€æ±‚ï¼šè¦å¾€è¡¨t2ä¸­æ’å…¥ä¸€è¡Œæ•°æ®ï¼Œè¿™ä¸€è¡Œçš„cå€¼æ˜¯è¡¨tä¸­cå€¼çš„æœ€å¤§å€¼åŠ 1ã€‚</p><p>æ­¤æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è¿™ä¹ˆå†™è¿™æ¡SQLè¯­å¥ ï¼š</p><pre><code>insert into t2(c,d)  (select c+1, d from t force index(c) order by c desc limit 1);\n</code></pre><p>è¿™ä¸ªè¯­å¥çš„åŠ é”èŒƒå›´ï¼Œå°±æ˜¯è¡¨tç´¢å¼•cä¸Šçš„(3,4]å’Œ(4,supremum]è¿™ä¸¤ä¸ªnext-key lockï¼Œä»¥åŠä¸»é”®ç´¢å¼•ä¸Šid=4è¿™ä¸€è¡Œã€‚</p><p>å®ƒçš„æ‰§è¡Œæµç¨‹ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œä»è¡¨tä¸­æŒ‰ç…§ç´¢å¼•cå€’åºï¼Œæ‰«æç¬¬ä¸€è¡Œï¼Œæ‹¿åˆ°ç»“æœå†™å…¥åˆ°è¡¨t2ä¸­ã€‚</p><p>å› æ­¤æ•´æ¡è¯­å¥çš„æ‰«æè¡Œæ•°æ˜¯1ã€‚</p><p>è¿™ä¸ªè¯­å¥æ‰§è¡Œçš„æ…¢æŸ¥è¯¢æ—¥å¿—ï¼ˆslow logï¼‰ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/3e/74/3efdf8256309a44e23d93089459eda74.png?wh=932*85\" alt=\"\"></p><center><span class=\"reference\">å›¾2 æ…¢æŸ¥è¯¢æ—¥å¿—--å°†æ•°æ®æ’å…¥è¡¨t2</span></center><p>é€šè¿‡è¿™ä¸ªæ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œæˆ‘ä»¬çœ‹åˆ°Rows_examined=1ï¼Œæ­£å¥½éªŒè¯äº†æ‰§è¡Œè¿™æ¡è¯­å¥çš„æ‰«æè¡Œæ•°ä¸º1ã€‚</p><p>é‚£ä¹ˆï¼Œå¦‚æœæˆ‘ä»¬æ˜¯è¦æŠŠè¿™æ ·çš„ä¸€è¡Œæ•°æ®æ’å…¥åˆ°è¡¨tä¸­çš„è¯ï¼š</p><pre><code>insert into t(c,d)  (select c+1, d from t force index(c) order by c desc limit 1);\n</code></pre><p>è¯­å¥çš„æ‰§è¡Œæµç¨‹æ˜¯æ€æ ·çš„ï¼Ÿæ‰«æè¡Œæ•°åˆæ˜¯å¤šå°‘å‘¢ï¼Ÿ</p><p>è¿™æ—¶å€™ï¼Œæˆ‘ä»¬å†çœ‹æ…¢æŸ¥è¯¢æ—¥å¿—å°±ä¼šå‘ç°ä¸å¯¹äº†ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/6f/18/6f90b04c09188bff11dae6e788abb918.png?wh=925*76\" alt=\"\"></p><center><span class=\"reference\">å›¾3 æ…¢æŸ¥è¯¢æ—¥å¿—--å°†æ•°æ®æ’å…¥è¡¨t</span></center><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™æ—¶å€™çš„Rows_examinedçš„å€¼æ˜¯5ã€‚</p><p>æˆ‘åœ¨å‰é¢çš„æ–‡ç« ä¸­æåˆ°è¿‡ï¼Œå¸Œæœ›ä½ éƒ½èƒ½å¤Ÿå­¦ä¼šç”¨explainçš„ç»“æœæ¥â€œè„‘è¡¥â€æ•´æ¡è¯­å¥çš„æ‰§è¡Œè¿‡ç¨‹ã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬å°±æ¥ä¸€èµ·è¯•è¯•ã€‚</p><p>å¦‚å›¾4æ‰€ç¤ºå°±æ˜¯è¿™æ¡è¯­å¥çš„explainç»“æœã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/d7/2a/d7270781ee3f216325b73bd53999b82a.png?wh=1390*168\" alt=\"\"></p><center><span class=\"reference\">å›¾4 explainç»“æœ</span></center><p>ä»Extraå­—æ®µå¯ä»¥çœ‹åˆ°â€œUsing temporaryâ€å­—æ ·ï¼Œè¡¨ç¤ºè¿™ä¸ªè¯­å¥ç”¨åˆ°äº†ä¸´æ—¶è¡¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œéœ€è¦æŠŠè¡¨tçš„å†…å®¹è¯»å‡ºæ¥ï¼Œå†™å…¥ä¸´æ—¶è¡¨ã€‚</p><p>å›¾ä¸­rowsæ˜¾ç¤ºçš„æ˜¯1ï¼Œæˆ‘ä»¬ä¸å¦¨å…ˆå¯¹è¿™ä¸ªè¯­å¥çš„æ‰§è¡Œæµç¨‹åšä¸€ä¸ªçŒœæµ‹ï¼šå¦‚æœè¯´æ˜¯æŠŠå­æŸ¥è¯¢çš„ç»“æœè¯»å‡ºæ¥ï¼ˆæ‰«æ1è¡Œï¼‰ï¼Œå†™å…¥ä¸´æ—¶è¡¨ï¼Œç„¶åå†ä»ä¸´æ—¶è¡¨è¯»å‡ºæ¥ï¼ˆæ‰«æ1è¡Œï¼‰ï¼Œå†™å›è¡¨tä¸­ã€‚é‚£ä¹ˆï¼Œè¿™ä¸ªè¯­å¥çš„æ‰«æè¡Œæ•°å°±åº”è¯¥æ˜¯2ï¼Œè€Œä¸æ˜¯5ã€‚</p><p>æ‰€ä»¥ï¼Œè¿™ä¸ªçŒœæµ‹ä¸å¯¹ã€‚å®é™…ä¸Šï¼ŒExplainç»“æœé‡Œçš„rows=1æ˜¯å› ä¸ºå—åˆ°äº†limit 1 çš„å½±å“ã€‚</p><p>ä»å¦ä¸€ä¸ªè§’åº¦è€ƒè™‘çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹çœ‹InnoDBæ‰«æäº†å¤šå°‘è¡Œã€‚å¦‚å›¾5æ‰€ç¤ºï¼Œæ˜¯åœ¨æ‰§è¡Œè¿™ä¸ªè¯­å¥å‰åæŸ¥çœ‹Innodb_rows_readçš„ç»“æœã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/48/d7/489281d8029e8f60979cb7c4494010d7.png?wh=1038*451\" alt=\"\"></p><center><span class=\"reference\">å›¾5 æŸ¥çœ‹ Innodb_rows_readå˜åŒ–</span></center><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªè¯­å¥æ‰§è¡Œå‰åï¼ŒInnodb_rows_readçš„å€¼å¢åŠ äº†4ã€‚å› ä¸ºé»˜è®¤ä¸´æ—¶è¡¨æ˜¯ä½¿ç”¨Memoryå¼•æ“çš„ï¼Œæ‰€ä»¥è¿™4è¡ŒæŸ¥çš„éƒ½æ˜¯è¡¨tï¼Œä¹Ÿå°±æ˜¯è¯´å¯¹è¡¨tåšäº†å…¨è¡¨æ‰«æã€‚</p><p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±æŠŠæ•´ä¸ªæ‰§è¡Œè¿‡ç¨‹ç†æ¸…æ¥šäº†ï¼š</p><ol>\n<li>\n<p>åˆ›å»ºä¸´æ—¶è¡¨ï¼Œè¡¨é‡Œæœ‰ä¸¤ä¸ªå­—æ®µcå’Œdã€‚</p>\n</li>\n<li>\n<p>æŒ‰ç…§ç´¢å¼•cæ‰«æè¡¨tï¼Œä¾æ¬¡å–c=4ã€3ã€2ã€1ï¼Œç„¶åå›è¡¨ï¼Œè¯»åˆ°cå’Œdçš„å€¼å†™å…¥ä¸´æ—¶è¡¨ã€‚è¿™æ—¶ï¼ŒRows_examined=4ã€‚</p>\n</li>\n<li>\n<p>ç”±äºè¯­ä¹‰é‡Œé¢æœ‰limit 1ï¼Œæ‰€ä»¥åªå–äº†ä¸´æ—¶è¡¨çš„ç¬¬ä¸€è¡Œï¼Œå†æ’å…¥åˆ°è¡¨tä¸­ã€‚è¿™æ—¶ï¼ŒRows_examinedçš„å€¼åŠ 1ï¼Œå˜æˆäº†5ã€‚</p>\n</li>\n</ol><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªè¯­å¥ä¼šå¯¼è‡´åœ¨è¡¨tä¸Šåšå…¨è¡¨æ‰«æï¼Œå¹¶ä¸”ä¼šç»™ç´¢å¼•cä¸Šçš„æ‰€æœ‰é—´éš™éƒ½åŠ ä¸Šå…±äº«çš„next-key lockã€‚æ‰€ä»¥ï¼Œè¿™ä¸ªè¯­å¥æ‰§è¡ŒæœŸé—´ï¼Œå…¶ä»–äº‹åŠ¡ä¸èƒ½åœ¨è¿™ä¸ªè¡¨ä¸Šæ’å…¥æ•°æ®ã€‚</p><p>è‡³äºè¿™ä¸ªè¯­å¥çš„æ‰§è¡Œä¸ºä»€ä¹ˆéœ€è¦ä¸´æ—¶è¡¨ï¼ŒåŸå› æ˜¯è¿™ç±»ä¸€è¾¹éå†æ•°æ®ï¼Œä¸€è¾¹æ›´æ–°æ•°æ®çš„æƒ…å†µï¼Œå¦‚æœè¯»å‡ºæ¥çš„æ•°æ®ç›´æ¥å†™å›åŸè¡¨ï¼Œå°±å¯èƒ½åœ¨éå†è¿‡ç¨‹ä¸­ï¼Œè¯»åˆ°åˆšåˆšæ’å…¥çš„è®°å½•ï¼Œæ–°æ’å…¥çš„è®°å½•å¦‚æœå‚ä¸è®¡ç®—é€»è¾‘ï¼Œå°±è·Ÿè¯­ä¹‰ä¸ç¬¦ã€‚</p><p>ç”±äºå®ç°ä¸Šè¿™ä¸ªè¯­å¥æ²¡æœ‰åœ¨å­æŸ¥è¯¢ä¸­å°±ç›´æ¥ä½¿ç”¨limit 1ï¼Œä»è€Œå¯¼è‡´äº†è¿™ä¸ªè¯­å¥çš„æ‰§è¡Œéœ€è¦éå†æ•´ä¸ªè¡¨tã€‚å®ƒçš„ä¼˜åŒ–æ–¹æ³•ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯ç”¨å‰é¢ä»‹ç»çš„æ–¹æ³•ï¼Œå…ˆinsert intoåˆ°ä¸´æ—¶è¡¨temp_tï¼Œè¿™æ ·å°±åªéœ€è¦æ‰«æä¸€è¡Œï¼›ç„¶åå†ä»è¡¨temp_té‡Œé¢å–å‡ºè¿™è¡Œæ•°æ®æ’å…¥è¡¨t1ã€‚</p><p>å½“ç„¶ï¼Œç”±äºè¿™ä¸ªè¯­å¥æ¶‰åŠçš„æ•°æ®é‡å¾ˆå°ï¼Œä½ å¯ä»¥è€ƒè™‘ä½¿ç”¨å†…å­˜ä¸´æ—¶è¡¨æ¥åšè¿™ä¸ªä¼˜åŒ–ã€‚ä½¿ç”¨å†…å­˜ä¸´æ—¶è¡¨ä¼˜åŒ–æ—¶ï¼Œè¯­å¥åºåˆ—çš„å†™æ³•å¦‚ä¸‹ï¼š</p><pre><code>create temporary table temp_t(c int,d int) engine=memory;\ninsert into temp_t  (select c+1, d from t force index(c) order by c desc limit 1);\ninsert into t select * from temp_t;\ndrop table temp_t;\n</code></pre><h1>insert å”¯ä¸€é”®å†²çª</h1><p>å‰é¢çš„ä¸¤ä¸ªä¾‹å­æ˜¯ä½¿ç”¨insert â€¦ selectçš„æƒ…å†µï¼Œæ¥ä¸‹æ¥æˆ‘è¦ä»‹ç»çš„è¿™ä¸ªä¾‹å­å°±æ˜¯æœ€å¸¸è§çš„insertè¯­å¥å‡ºç°å”¯ä¸€é”®å†²çªçš„æƒ…å†µã€‚</p><p>å¯¹äºæœ‰å”¯ä¸€é”®çš„è¡¨ï¼Œæ’å…¥æ•°æ®æ—¶å‡ºç°å”¯ä¸€é”®å†²çªä¹Ÿæ˜¯å¸¸è§çš„æƒ…å†µäº†ã€‚æˆ‘å…ˆç»™ä½ ä¸¾ä¸€ä¸ªç®€å•çš„å”¯ä¸€é”®å†²çªçš„ä¾‹å­ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/83/ca/83fb2d877932941b230d6b5be8cca6ca.png?wh=934*279\" alt=\"\"></p><center><span class=\"reference\">å›¾6 å”¯ä¸€é”®å†²çªåŠ é”</span></center><p>è¿™ä¸ªä¾‹å­ä¹Ÿæ˜¯åœ¨å¯é‡å¤è¯»ï¼ˆrepeatable readï¼‰éš”ç¦»çº§åˆ«ä¸‹æ‰§è¡Œçš„ã€‚å¯ä»¥çœ‹åˆ°ï¼Œsession Bè¦æ‰§è¡Œçš„insertè¯­å¥è¿›å…¥äº†é”ç­‰å¾…çŠ¶æ€ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œsession Aæ‰§è¡Œçš„insertè¯­å¥ï¼Œå‘ç”Ÿå”¯ä¸€é”®å†²çªçš„æ—¶å€™ï¼Œå¹¶ä¸åªæ˜¯ç®€å•åœ°æŠ¥é”™è¿”å›ï¼Œè¿˜åœ¨å†²çªçš„ç´¢å¼•ä¸ŠåŠ äº†é”ã€‚æˆ‘ä»¬å‰é¢è¯´è¿‡ï¼Œä¸€ä¸ªnext-key lockå°±æ˜¯ç”±å®ƒå³è¾¹ç•Œçš„å€¼å®šä¹‰çš„ã€‚è¿™æ—¶å€™ï¼Œsession AæŒæœ‰ç´¢å¼•cä¸Šçš„(5,10]å…±äº«next-key lockï¼ˆè¯»é”ï¼‰ã€‚</p><p>è‡³äºä¸ºä»€ä¹ˆè¦åŠ è¿™ä¸ªè¯»é”ï¼Œå…¶å®æˆ‘ä¹Ÿæ²¡æœ‰æ‰¾åˆ°åˆç†çš„è§£é‡Šã€‚ä»ä½œç”¨ä¸Šæ¥çœ‹ï¼Œè¿™æ ·åšå¯ä»¥é¿å…è¿™ä¸€è¡Œè¢«åˆ«çš„äº‹åŠ¡åˆ æ‰ã€‚</p><p>è¿™é‡Œ<a href=\"https://dev.mysql.com/doc/refman/8.0/en/innodb-locks-set.html\">å®˜æ–¹æ–‡æ¡£</a>æœ‰ä¸€ä¸ªæè¿°é”™è¯¯ï¼Œè®¤ä¸ºå¦‚æœå†²çªçš„æ˜¯ä¸»é”®ç´¢å¼•ï¼Œå°±åŠ è®°å½•é”ï¼Œå”¯ä¸€ç´¢å¼•æ‰åŠ next-key lockã€‚ä½†å®é™…ä¸Šï¼Œè¿™ä¸¤ç±»ç´¢å¼•å†²çªåŠ çš„éƒ½æ˜¯next-key lockã€‚</p><blockquote>\n<p>å¤‡æ³¨ï¼šè¿™ä¸ªbugï¼Œæ˜¯æˆ‘åœ¨å†™è¿™ç¯‡æ–‡ç« æŸ¥é˜…æ–‡æ¡£æ—¶å‘ç°çš„ï¼Œå·²ç»<a href=\"https://bugs.mysql.com/bug.php?id=93806\">å‘ç»™å®˜æ–¹</a>å¹¶è¢«verifiedäº†ã€‚</p>\n</blockquote><p>æœ‰åŒå­¦åœ¨å‰é¢æ–‡ç« çš„è¯„è®ºåŒºé—®åˆ°ï¼Œåœ¨æœ‰å¤šä¸ªå”¯ä¸€ç´¢å¼•çš„è¡¨ä¸­å¹¶å‘æ’å…¥æ•°æ®æ—¶ï¼Œä¼šå‡ºç°æ­»é”ã€‚ä½†æ˜¯ï¼Œç”±äºä»–æ²¡æœ‰æä¾›å¤ç°æ–¹æ³•æˆ–è€…ç°åœºï¼Œæˆ‘ä¹Ÿæ— æ³•åšåˆ†æã€‚æ‰€ä»¥ï¼Œæˆ‘å»ºè®®ä½ åœ¨è¯„è®ºåŒºå‘é—®é¢˜çš„æ—¶å€™ï¼Œå°½é‡åŒæ—¶é™„ä¸Šå¤ç°æ–¹æ³•ï¼Œæˆ–è€…ç°åœºä¿¡æ¯ï¼Œè¿™æ ·æˆ‘æ‰å¥½å’Œä½ ä¸€èµ·åˆ†æé—®é¢˜ã€‚</p><p>è¿™é‡Œï¼Œæˆ‘å°±å…ˆå’Œä½ åˆ†äº«ä¸€ä¸ªç»å…¸çš„æ­»é”åœºæ™¯ï¼Œå¦‚æœä½ è¿˜é‡åˆ°è¿‡å…¶ä»–å”¯ä¸€é”®å†²çªå¯¼è‡´çš„æ­»é”åœºæ™¯ï¼Œä¹Ÿæ¬¢è¿ç»™æˆ‘ç•™è¨€ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/63/2d/63658eb26e7a03b49f123fceed94cd2d.png?wh=934*277\" alt=\"\"></p><center><span class=\"reference\">å›¾7 å”¯ä¸€é”®å†²çª--æ­»é”</span></center><p>åœ¨session Aæ‰§è¡Œrollbackè¯­å¥å›æ»šçš„æ—¶å€™ï¼Œsession Cå‡ ä¹åŒæ—¶å‘ç°æ­»é”å¹¶è¿”å›ã€‚</p><p>è¿™ä¸ªæ­»é”äº§ç”Ÿçš„é€»è¾‘æ˜¯è¿™æ ·çš„ï¼š</p><ol>\n<li>\n<p>åœ¨T1æ—¶åˆ»ï¼Œå¯åŠ¨session Aï¼Œå¹¶æ‰§è¡Œinsertè¯­å¥ï¼Œæ­¤æ—¶åœ¨ç´¢å¼•cçš„c=5ä¸ŠåŠ äº†è®°å½•é”ã€‚æ³¨æ„ï¼Œè¿™ä¸ªç´¢å¼•æ˜¯å”¯ä¸€ç´¢å¼•ï¼Œå› æ­¤é€€åŒ–ä¸ºè®°å½•é”ï¼ˆå¦‚æœä½ çš„å°è±¡æ¨¡ç³Šäº†ï¼Œå¯ä»¥å›é¡¾ä¸‹<a href=\"https://time.geekbang.org/column/article/75659\">ç¬¬21ç¯‡æ–‡ç« </a>ä»‹ç»çš„åŠ é”è§„åˆ™ï¼‰ã€‚</p>\n</li>\n<li>\n<p>åœ¨T2æ—¶åˆ»ï¼Œsession Bè¦æ‰§è¡Œç›¸åŒçš„insertè¯­å¥ï¼Œå‘ç°äº†å”¯ä¸€é”®å†²çªï¼ŒåŠ ä¸Šè¯»é”ï¼›åŒæ ·åœ°ï¼Œsession Cä¹Ÿåœ¨ç´¢å¼•cä¸Šï¼Œc=5è¿™ä¸€ä¸ªè®°å½•ä¸Šï¼ŒåŠ äº†è¯»é”ã€‚</p>\n</li>\n<li>\n<p>T3æ—¶åˆ»ï¼Œsession Aå›æ»šã€‚è¿™æ—¶å€™ï¼Œsession Bå’Œsession Céƒ½è¯•å›¾ç»§ç»­æ‰§è¡Œæ’å…¥æ“ä½œï¼Œéƒ½è¦åŠ ä¸Šå†™é”ã€‚ä¸¤ä¸ªsessionéƒ½è¦ç­‰å¾…å¯¹æ–¹çš„è¡Œé”ï¼Œæ‰€ä»¥å°±å‡ºç°äº†æ­»é”ã€‚</p>\n</li>\n</ol><p>è¿™ä¸ªæµç¨‹çš„çŠ¶æ€å˜åŒ–å›¾å¦‚ä¸‹æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/3e/b8/3e0bf1a1241931c14360e73fd10032b8.jpg?wh=1142*880\" alt=\"\"></p><center><span class=\"reference\">å›¾8 çŠ¶æ€å˜åŒ–å›¾--æ­»é”</span></center><h1>insert into â€¦ on duplicate key update</h1><p>ä¸Šé¢è¿™ä¸ªä¾‹å­æ˜¯ä¸»é”®å†²çªåç›´æ¥æŠ¥é”™ï¼Œå¦‚æœæ˜¯æ”¹å†™æˆ</p><pre><code>insert into t values(11,10,10) on duplicate key update d=100; \n</code></pre><p>çš„è¯ï¼Œå°±ä¼šç»™ç´¢å¼•cä¸Š(5,10] åŠ ä¸€ä¸ªæ’ä»–çš„next-key lockï¼ˆå†™é”ï¼‰ã€‚</p><p><strong>insert into â€¦ on duplicate key update è¿™ä¸ªè¯­ä¹‰çš„é€»è¾‘æ˜¯ï¼Œæ’å…¥ä¸€è¡Œæ•°æ®ï¼Œå¦‚æœç¢°åˆ°å”¯ä¸€é”®çº¦æŸï¼Œå°±æ‰§è¡Œåé¢çš„æ›´æ–°è¯­å¥ã€‚</strong></p><p>æ³¨æ„ï¼Œå¦‚æœæœ‰å¤šä¸ªåˆ—è¿åäº†å”¯ä¸€æ€§çº¦æŸï¼Œå°±ä¼šæŒ‰ç…§ç´¢å¼•çš„é¡ºåºï¼Œä¿®æ”¹è·Ÿç¬¬ä¸€ä¸ªç´¢å¼•å†²çªçš„è¡Œã€‚</p><p>ç°åœ¨è¡¨té‡Œé¢å·²ç»æœ‰äº†(1,1,1)å’Œ(2,2,2)è¿™ä¸¤è¡Œï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹ä¸‹é¢è¿™ä¸ªè¯­å¥æ‰§è¡Œçš„æ•ˆæœï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/5f/02/5f384d6671c87a60e1ec7e490447d702.png?wh=767*230\" alt=\"\"></p><center><span class=\"reference\">å›¾9 ä¸¤ä¸ªå”¯ä¸€é”®åŒæ—¶å†²çª</span></center><p>å¯ä»¥çœ‹åˆ°ï¼Œä¸»é”®idæ˜¯å…ˆåˆ¤æ–­çš„ï¼ŒMySQLè®¤ä¸ºè¿™ä¸ªè¯­å¥è·Ÿid=2è¿™ä¸€è¡Œå†²çªï¼Œæ‰€ä»¥ä¿®æ”¹çš„æ˜¯id=2çš„è¡Œã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ‰§è¡Œè¿™æ¡è¯­å¥çš„affected rowsè¿”å›çš„æ˜¯2ï¼Œå¾ˆå®¹æ˜“é€ æˆè¯¯è§£ã€‚å®é™…ä¸Šï¼ŒçœŸæ­£æ›´æ–°çš„åªæœ‰ä¸€è¡Œï¼Œåªæ˜¯åœ¨ä»£ç å®ç°ä¸Šï¼Œinsertå’Œupdateéƒ½è®¤ä¸ºè‡ªå·±æˆåŠŸäº†ï¼Œupdateè®¡æ•°åŠ äº†1ï¼Œ insertè®¡æ•°ä¹ŸåŠ äº†1ã€‚</p><h1>å°ç»“</h1><p>ä»Šå¤©è¿™ç¯‡æ–‡ç« ï¼Œæˆ‘å’Œä½ ä»‹ç»äº†å‡ ç§ç‰¹æ®Šæƒ…å†µä¸‹çš„insertè¯­å¥ã€‚</p><p>insert â€¦ select æ˜¯å¾ˆå¸¸è§çš„åœ¨ä¸¤ä¸ªè¡¨ä¹‹é—´æ‹·è´æ•°æ®çš„æ–¹æ³•ã€‚ä½ éœ€è¦æ³¨æ„ï¼Œåœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œè¿™ä¸ªè¯­å¥ä¼šç»™selectçš„è¡¨é‡Œæ‰«æåˆ°çš„è®°å½•å’Œé—´éš™åŠ è¯»é”ã€‚</p><p>è€Œå¦‚æœinsertå’Œselectçš„å¯¹è±¡æ˜¯åŒä¸€ä¸ªè¡¨ï¼Œåˆ™æœ‰å¯èƒ½ä¼šé€ æˆå¾ªç¯å†™å…¥ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦å¼•å…¥ç”¨æˆ·ä¸´æ—¶è¡¨æ¥åšä¼˜åŒ–ã€‚</p><p>insert è¯­å¥å¦‚æœå‡ºç°å”¯ä¸€é”®å†²çªï¼Œä¼šåœ¨å†²çªçš„å”¯ä¸€å€¼ä¸ŠåŠ å…±äº«çš„next-key lock(Sé”)ã€‚å› æ­¤ï¼Œç¢°åˆ°ç”±äºå”¯ä¸€é”®çº¦æŸå¯¼è‡´æŠ¥é”™åï¼Œè¦å°½å¿«æäº¤æˆ–å›æ»šäº‹åŠ¡ï¼Œé¿å…åŠ é”æ—¶é—´è¿‡é•¿ã€‚</p><p>æœ€åï¼Œæˆ‘ç»™ä½ ç•™ä¸€ä¸ªé—®é¢˜å§ã€‚</p><p>ä½ å¹³æ—¶åœ¨ä¸¤ä¸ªè¡¨ä¹‹é—´æ‹·è´æ•°æ®ç”¨çš„æ˜¯ä»€ä¹ˆæ–¹æ³•ï¼Œæœ‰ä»€ä¹ˆæ³¨æ„äº‹é¡¹å—ï¼Ÿåœ¨ä½ çš„åº”ç”¨åœºæ™¯é‡Œï¼Œè¿™ä¸ªæ–¹æ³•ï¼Œç›¸è¾ƒäºå…¶ä»–æ–¹æ³•çš„ä¼˜åŠ¿æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><p>ä½ å¯ä»¥æŠŠä½ çš„ç»éªŒå’Œåˆ†æå†™åœ¨è¯„è®ºåŒºï¼Œæˆ‘ä¼šåœ¨ä¸‹ä¸€ç¯‡æ–‡ç« çš„æœ«å°¾é€‰å–æœ‰è¶£çš„è¯„è®ºæ¥å’Œä½ ä¸€èµ·åˆ†æã€‚æ„Ÿè°¢ä½ çš„æ”¶å¬ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™ç¯‡æ–‡ç« åˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹ä¸€èµ·é˜…è¯»ã€‚</p><h1>ä¸ŠæœŸé—®é¢˜æ—¶é—´</h1><p>æˆ‘ä»¬å·²ç»åœ¨æ–‡ç« ä¸­å›ç­”äº†ä¸ŠæœŸé—®é¢˜ã€‚</p><p>æœ‰åŒå­¦æåˆ°ï¼Œå¦‚æœåœ¨insert â€¦ select æ‰§è¡ŒæœŸé—´æœ‰å…¶ä»–çº¿ç¨‹æ“ä½œåŸè¡¨ï¼Œä¼šå¯¼è‡´é€»è¾‘é”™è¯¯ã€‚å…¶å®ï¼Œè¿™æ˜¯ä¸ä¼šçš„ï¼Œå¦‚æœä¸åŠ é”ï¼Œå°±æ˜¯å¿«ç…§è¯»ã€‚</p><p>ä¸€æ¡è¯­å¥æ‰§è¡ŒæœŸé—´ï¼Œå®ƒçš„ä¸€è‡´æ€§è§†å›¾æ˜¯ä¸ä¼šä¿®æ”¹çš„ï¼Œæ‰€ä»¥å³ä½¿æœ‰å…¶ä»–äº‹åŠ¡ä¿®æ”¹äº†åŸè¡¨çš„æ•°æ®ï¼Œä¹Ÿä¸ä¼šå½±å“è¿™æ¡è¯­å¥çœ‹åˆ°çš„æ•°æ®ã€‚</p><p>è¯„è®ºåŒºç•™è¨€ç‚¹èµæ¿ï¼š</p><blockquote>\n<p>@é•¿æ° åŒå­¦å›ç­”å¾—éå¸¸å‡†ç¡®ã€‚</p>\n</blockquote><p></p>","neighbors":{"left":{"article_title":"39 | è‡ªå¢ä¸»é”®ä¸ºä»€ä¹ˆä¸æ˜¯è¿ç»­çš„ï¼Ÿ","id":80531},"right":{"article_title":"41 | æ€ä¹ˆæœ€å¿«åœ°å¤åˆ¶ä¸€å¼ è¡¨ï¼Ÿ","id":81925}},"comments":[{"had_liked":false,"id":66978,"user_name":"huolang","can_delete":false,"product_type":"c1","uid":1346708,"ip_address":"","ucode":"FDC4A6B6151C5E","user_header":"https://static001.geekbang.org/account/avatar/00/14/8c/94/5282994c.jpg","comment_is_top":false,"comment_ctime":1550050426,"is_pvip":false,"replies":[{"id":"23782","content":"1. æ˜¯çš„<br>2. è¿™ä¸ªæˆ‘è§‰å¾—æ˜¯ä¸ºäº†é˜²æ­¢è¿™ä¸ªè®°å½•å†è¢«åˆ é™¤ï¼ˆä¸è¿‡è¿™ä¸ªç†ç”±ä¸æ˜¯å¾ˆç¡¬ï¼Œæˆ‘è¿˜æ²¡æœ‰æ‰¾åˆ°å…¶ä»–è§£é‡Š<br>3. äº’æ–¥çš„ï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªè¯­å¥éƒ½åœ¨ç­‰å¾…ã€‚æ³¨æ„next-key lockæ˜¯ç”±é—´éš™é”å’Œè®°å½•é”ç»„æˆçš„å“¦ï¼Œ é—´éš™é”åŠ æˆåŠŸäº†çš„ã€‚å¥½é—®é¢˜ã€‚<br>4. è¿˜æ²¡æœ‰æäº¤ï¼Œä½†æ˜¯è¿™ä¸ªè®°å½•å·²ç»ä½œä¸ºæœ€æ–°è®°å½•å†™è¿›å»äº†ï¼Œå¤ä¹ ä¸€ä¸‹08ç¯‡å“ˆ","user_name":"ä½œè€…å›å¤","comment_id":66978,"uid":"1264162","ip_address":"","utype":1,"ctime":1550112317,"user_name_real":"æ—æ™“æ–Œ"}],"discussion_count":23,"race_medal":0,"score":"405276976250","product_id":100020801,"comment_content":"è€å¸ˆï¼Œæ­»é”çš„ä¾‹å­ï¼Œå…³äºsessionAæ‹¿åˆ°çš„c=5çš„è®°å½•é”ï¼ŒsessionBå’ŒsessionCå‘ç°å”¯ä¸€é”®å†²çªä¼šåŠ ä¸Šè¯»é”æˆ‘æœ‰å‡ ä¸ªç–‘æƒ‘ï¼š<br>1. sessionAæ‹¿åˆ°çš„c=5çš„è®°å½•é”æ˜¯å†™é”å—ï¼Ÿ<br>2. ä¸ºä»€ä¹ˆsessionBå’ŒsessionCå‘ç°å”¯ä¸€é”®å†²çªä¼šåŠ ä¸Šè¯»é”ï¼Ÿ<br>3. å¦‚æœsessionAæ‹¿åˆ°c=5çš„è®°å½•æ‰€æ˜¯å†™é”ï¼Œé‚£ä¸ºä»€ä¹ˆsessionBå’ŒsessionCè¿˜èƒ½åŠ c=5çš„è¯»é”ï¼Œå†™é”å’Œè¯»é”ä¸åº”è¯¥æ˜¯äº’æ–¥çš„å—ï¼Ÿ<br>4.  sessionAè¿˜æ²¡æœ‰æäº¤ï¼Œä¸ºä»€ä¹ˆsessionBå’ŒsessionCèƒ½å‘ç°å”¯ä¸€é”®å†²çªï¼Ÿ","like_count":94,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"æ—æ™“æ–Œ","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438998,"discussion_content":"1. æ˜¯çš„\n2. è¿™ä¸ªæˆ‘è§‰å¾—æ˜¯ä¸ºäº†é˜²æ­¢è¿™ä¸ªè®°å½•å†è¢«åˆ é™¤ï¼ˆä¸è¿‡è¿™ä¸ªç†ç”±ä¸æ˜¯å¾ˆç¡¬ï¼Œæˆ‘è¿˜æ²¡æœ‰æ‰¾åˆ°å…¶ä»–è§£é‡Š\n3. äº’æ–¥çš„ï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªè¯­å¥éƒ½åœ¨ç­‰å¾…ã€‚æ³¨æ„next-key lockæ˜¯ç”±é—´éš™é”å’Œè®°å½•é”ç»„æˆçš„å“¦ï¼Œ é—´éš™é”åŠ æˆåŠŸäº†çš„ã€‚å¥½é—®é¢˜ã€‚\n4. è¿˜æ²¡æœ‰æäº¤ï¼Œä½†æ˜¯è¿™ä¸ªè®°å½•å·²ç»ä½œä¸ºæœ€æ–°è®°å½•å†™è¿›å»äº†ï¼Œå¤ä¹ ä¸€ä¸‹08ç¯‡å“ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550112317,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1213495,"avatar":"https://static001.geekbang.org/account/avatar/00/12/84/37/a13d867a.jpg","nickname":"zc","note":"","ucode":"07900D4B6A3135","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":143579,"discussion_content":"è¿™é‡Œä¸èƒ½è¯´æˆåŠ ä¸Šè¯»é”ï¼Œåº”è¯¥æ˜¯åˆ¤æ–­æ•°æ®æ˜¯å¦èƒ½å†™å…¥éœ€è¦è¿›è¡Œå½“å‰è¯»ï¼Œè¿›è¡Œå½“å‰è¯»éœ€è¦å…ˆåŠ è¯»é”ï¼Œç„¶åå°±è¢«å†™é”é˜»å¡ä½äº†ï¼Œæœ€åsession aå›æ»šï¼Œbå’ŒcæˆåŠŸåŠ ä¸Šè¯»é”ï¼Œä¸”è¯»å–åˆ¤æ–­æ˜¯å¦å¯å†™å…¥ï¼Œå¾—åˆ°çš„ç­”æ¡ˆæ˜¯å¯ä»¥ï¼Œç„¶åéƒ½è¿›è¡Œé”å‡çº§ï¼Œäºæ˜¯æ­»é”äº†","likes_number":33,"is_delete":false,"is_hidden":false,"ctime":1579515199,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":3,"child_discussions":[{"author":{"id":1061402,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/y5NFbibdKCFCg0lHKK5ERGOQWXYYK7jhnqm2BxQ6r7tWvXx8uDmibglweejDWU39BTmDSAtBJGj1ibOZK2uIHQyqg/132","nickname":"Mr_freezing37","note":"","ucode":"BB605A6FEDCEB6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1213495,"avatar":"https://static001.geekbang.org/account/avatar/00/12/84/37/a13d867a.jpg","nickname":"zc","note":"","ucode":"07900D4B6A3135","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":253143,"discussion_content":"å¦‚æœæ˜¯å½“å‰è¯»-å‡çº§è¿™ä¸ªé€»è¾‘ã€‚\nä¸¤ä¸ªsessionæ˜¯å¹¶å‘å…³ç³»ï¼Œè¿™ä¸ªç»“æœå°±ä¸æ˜¯å¿…ç°ã€‚","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1588219613,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":143579,"ip_address":""},"score":253143,"extra":""},{"author":{"id":2052476,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Qq6oLfOTgKzjiculoUDicdv7WoY1iabPfOTumibWeInVP2Mnod9XVPrNSClvIiaLbvtDlIjRnWUNaXcYwREGzlcaDog/132","nickname":"Geek_åœ¨ä¸‹èŸ‘è‚ç‹","note":"","ucode":"E1F5BBB5BC5962","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1061402,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/y5NFbibdKCFCg0lHKK5ERGOQWXYYK7jhnqm2BxQ6r7tWvXx8uDmibglweejDWU39BTmDSAtBJGj1ibOZK2uIHQyqg/132","nickname":"Mr_freezing37","note":"","ucode":"BB605A6FEDCEB6","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":324374,"discussion_content":"ä¸åŒæ„ã€‚æˆ‘è§‰å¾—å¿…ç„¶å‡ºç°çš„ã€‚\nå› ä¸ºsession bçš„è¯»é”å’Œsession cè¯»é”åœ¨aé‡Šæ”¾å†™é”ååŒæ—¶æ‹¿åˆ°è¯»é”ã€‚è¯»é”ä¸äº’æ–¥ï¼Œæ²¡ç†ç”±ä¸åŒæ—¶æ‹¿åˆ°ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605096279,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":253143,"ip_address":""},"score":324374,"extra":""},{"author":{"id":2566445,"avatar":"https://static001.geekbang.org/account/avatar/00/27/29/2d/39637017.jpg","nickname":"çƒŸç«","note":"","ucode":"2CE0BBFD5E6AC6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1213495,"avatar":"https://static001.geekbang.org/account/avatar/00/12/84/37/a13d867a.jpg","nickname":"zc","note":"","ucode":"07900D4B6A3135","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":372409,"discussion_content":"è¿™é‡Œsesion Aå›æ»šåï¼ŒB Cçš„é—´éš™é”èŒƒå›´å˜æˆ(4,+æ— ç©·),ç„¶åéƒ½åŠ è¯»é”ï¼Œç„¶åæ­»é”ç­‰å¾…äº†","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1620309987,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":143579,"ip_address":""},"score":372409,"extra":""}]},{"author":{"id":1788647,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/4a/e7/6c16af5d.jpg","nickname":"æ±‰æ±Ÿ","note":"","ucode":"01622D984B8F9B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":361057,"discussion_content":"å¥½åƒæœ‰ç‚¹æ‡‚äº†  å‘ç”Ÿç´¢å¼•å†²çªåŠ çš„next-key è¿™æ•´ä¸ªéƒ½æ˜¯è¯»é”ï¼Œnext-key åŒ…æ‹¬ gap lock å’Œ record lock  é‚£å¯¹gap lockï¼Œ  session Bå’Œsession C éƒ½å…ˆåŠ è¯»é”æˆåŠŸ ï¼Œç„¶ååŠ  c=5 è¿™ä¸€è¡Œçš„è¯»é” å› ä¸º session A å¯¹c=5åŠ äº†å†™é” æ‰€ä»¥ session Bå’Œsession C  å¯¹ c=5  åŠ è¯»é” ç­‰å¾…ï¼Œå½“ session A å›æ»šçš„æ—¶å€™ï¼Œsession Bå’Œsession C  å¯¹ c=5  åŠ è¯»é”æˆåŠŸï¼Œç„¶åsession Bå’Œsession Cå¼€å§‹æ’å…¥c=5å†™é” ,éƒ½å› ä¸ºè¦ç­‰å¾…å¯¹æ–¹é‡Šæ”¾ c=5 è¯»é”è€Œäº§ç”Ÿæ­»é”","likes_number":12,"is_delete":false,"is_hidden":false,"ctime":1616589666,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":6,"child_discussions":[{"author":{"id":2448277,"avatar":"https://static001.geekbang.org/account/avatar/00/25/5b/95/462890c6.jpg","nickname":"å¶æ¶›","note":"","ucode":"B45348979BE159","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1788647,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/4a/e7/6c16af5d.jpg","nickname":"æ±‰æ±Ÿ","note":"","ucode":"01622D984B8F9B","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":373664,"discussion_content":"ä¸æ˜ç™½ä¸ºå•¥Bå’ŒCä¼šæœ‰çœ‹åˆ°Açš„æ’å…¥æ•°æ®ï¼Œé€ æˆå†²çª","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620816831,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":361057,"ip_address":""},"score":373664,"extra":""},{"author":{"id":2064501,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/80/75/c00e3116.jpg","nickname":"niss","note":"","ucode":"7449D8B30EE0E1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2448277,"avatar":"https://static001.geekbang.org/account/avatar/00/25/5b/95/462890c6.jpg","nickname":"å¶æ¶›","note":"","ucode":"B45348979BE159","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":386339,"discussion_content":"cæ˜¯å”¯ä¸€ç´¢å¼•ï¼Œæ’å…¥æ•°æ®éœ€è¦å…ˆè¯»æ•°æ®ï¼Œåˆ¤æ–­æ²¡æœ‰å†²çªå†å†™ã€‚è¯»çš„æ—¶å€™æ˜¯å½“å‰è¯»ï¼Œæ‰€ä»¥å¯ä»¥çœ‹åˆ°Aæ’å…¥çš„æ•°æ®ã€‚\nå¦‚æœæŠŠcçš„å”¯ä¸€ç´¢å¼•å»æ‰ï¼Œå°±ä¸éœ€è¦åˆ¤æ–­æ˜¯å¦æœ‰å†²çªäº†ï¼Œè¿™æ—¶å€™session Bå’Œsession Céƒ½å¯ä»¥æ‰§è¡ŒæˆåŠŸ","likes_number":6,"is_delete":false,"is_hidden":false,"ctime":1627538552,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":373664,"ip_address":""},"score":386339,"extra":""},{"author":{"id":1780797,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/2c/3d/0bd58aa4.jpg","nickname":"Em","note":"","ucode":"32012A5C603C8A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1788647,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/4a/e7/6c16af5d.jpg","nickname":"æ±‰æ±Ÿ","note":"","ucode":"01622D984B8F9B","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":578388,"discussion_content":"ä½ è¿™è¿˜æ˜¯ä¸å¯¹      åŠ è¡Œé”è¿˜åˆ†å…ˆåŠ è¯»å†åŠ å†™?    insertä¸ç›´æ¥åŠ è¿™ä¸€è¡Œçš„å†™é”äº†?","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1656692952,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":361057,"ip_address":""},"score":578388,"extra":""}]},{"author":{"id":1466840,"avatar":"https://static001.geekbang.org/account/avatar/00/16/61/d8/3bc19bff.jpg","nickname":"æ‹åœ¨é‚£æ—¶","note":"","ucode":"7F026B4B708C7D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":280608,"discussion_content":"æˆ‘è®¤ä¸ºæ˜¯è¿™æ ·çš„ï¼šnext-key-lock å…ˆåŠ çš„æ˜¯é—´éš™é”ï¼Œå†åŠ è¡Œé”ï¼ŒåŠ é—´éš™é”æ˜¯æ²¡é—®é¢˜çš„ï¼ŒåŠ è¡Œé”çš„æ—¶å€™å‘ç°è¢«å µå¡äº†ï¼Œå½“sessionArollbackçš„æ—¶å€™ï¼ŒsessionBå’ŒSessionCæ’å…¥éƒ½ä¼šè¢«å¯¹æ–¹çš„é—´éš™é”é”ä½ï¼Œé€ æˆäº†æ­»é”","likes_number":8,"is_delete":false,"is_hidden":false,"ctime":1591578128,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":4,"child_discussions":[{"author":{"id":1324314,"avatar":"https://static001.geekbang.org/account/avatar/00/14/35/1a/9fa38dc9.jpg","nickname":"å­ç»","note":"","ucode":"5C26FF10934534","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1466840,"avatar":"https://static001.geekbang.org/account/avatar/00/16/61/d8/3bc19bff.jpg","nickname":"æ‹åœ¨é‚£æ—¶","note":"","ucode":"7F026B4B708C7D","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":325823,"discussion_content":"é—´éš™é”æ˜¯å¼€åŒºé—´çš„ï¼Œ sessionBå’ŒsessionCæ’å…¥æ€ä¹ˆä¼šè¢«å¯¹æ–¹çš„é—´éš™é”é”ä½å‘¢ï¼Œè¿™ä¸ªç‚¹æ„Ÿè§‰è¯´ä¸é€š","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1605439890,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":280608,"ip_address":""},"score":325823,"extra":""},{"author":{"id":2021212,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/MdmRMTV2IwvQZF2IO0G0CFWbKxT9CIibmcdicS3J4SmrA4P1e36jCwyXZpia06ItwP4GibGnCrPJHicBbd5y9libTpiaA/132","nickname":"^_^","note":"","ucode":"301EE75D170771","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1466840,"avatar":"https://static001.geekbang.org/account/avatar/00/16/61/d8/3bc19bff.jpg","nickname":"æ‹åœ¨é‚£æ—¶","note":"","ucode":"7F026B4B708C7D","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":348506,"discussion_content":"é—´éš™é”æ˜¯å…±äº«é”å‘€ï¼Œä½ åŠ æˆ‘ä¹Ÿå¯ä»¥åŠ ","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1612604931,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":280608,"ip_address":""},"score":348506,"extra":""},{"author":{"id":1978838,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/31/d6/4bfaa08c.jpg","nickname":"é˜¿å·Arc","note":"","ucode":"4D990D6E3152A6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1324314,"avatar":"https://static001.geekbang.org/account/avatar/00/14/35/1a/9fa38dc9.jpg","nickname":"å­ç»","note":"","ucode":"5C26FF10934534","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":370830,"discussion_content":"ä¸æ˜¯å•Š ä»–çš„æ„æ€åº”è¯¥æ˜¯sessionBçš„æ’å…¥æ“ä½œè¢«sessionCçš„é—´éš™é”é˜»å¡äº†ï¼ŒsessionCçš„æ’å…¥è¢«sessionBçš„é—´éš™é”é˜»å¡äº†ã€‚é—´éš™é”è·Ÿæ’å…¥è¡Œä¸ºæ˜¯äº’æ–¥çš„å‘€","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619539428,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":325823,"ip_address":""},"score":370830,"extra":""}]},{"author":{"id":1397351,"avatar":"https://static001.geekbang.org/account/avatar/00/15/52/67/fcba0967.jpg","nickname":"zapup","note":"","ucode":"388D6BB5D7B137","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":294079,"discussion_content":"é—®çš„çœŸå¥½","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1595775782,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2048666,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/bvIkMsUBo7glPEWJjpBEM7ice9nLySxsCibicZg2Uubuia27KZGXXYibPhMhIT6m1GVCIM1l1ILJnj74kwvOqqRSKjg/132","nickname":"å¼ºå¼º","note":"","ucode":"86E0C8A6B5CF55","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":301385,"discussion_content":"å½“å‰è¯»","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1598511819,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":4,"child_discussions":[{"author":{"id":2448277,"avatar":"https://static001.geekbang.org/account/avatar/00/25/5b/95/462890c6.jpg","nickname":"å¶æ¶›","note":"","ucode":"B45348979BE159","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2048666,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/bvIkMsUBo7glPEWJjpBEM7ice9nLySxsCibicZg2Uubuia27KZGXXYibPhMhIT6m1GVCIM1l1ILJnj74kwvOqqRSKjg/132","nickname":"å¼ºå¼º","note":"","ucode":"86E0C8A6B5CF55","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":373641,"discussion_content":"å½“å‰è¯»ä¹Ÿè¯»ä¸åˆ°å…¶ä»–äº‹åŠ¡æœªæäº¤çš„å•Šï¼Œé‚£ä¸æˆäº†è„è¯»","likes_number":5,"is_delete":false,"is_hidden":false,"ctime":1620809645,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":301385,"ip_address":""},"score":373641,"extra":""},{"author":{"id":1710200,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/VUnspzjpBcmEibUicMJoDpnvsElyX5R6Eia9pjNuP3MaD9iaJpBS4vZ4krzLIniaZucFVrKnfJ1VumLLZ8gRt9KnCLQ/132","nickname":"Geek_39958b","note":"","ucode":"500FC31A7627AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2448277,"avatar":"https://static001.geekbang.org/account/avatar/00/25/5b/95/462890c6.jpg","nickname":"å¶æ¶›","note":"","ucode":"B45348979BE159","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":386998,"discussion_content":"å…¶å®æ˜¯å¯ä»¥çš„ï¼Œè¿™é‡Œæ¶‰åŠåˆ°éšå¼é”ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œinsertè¯­å¥æ’å…¥çš„æ•°æ®æ˜¯ä¸éœ€è¦ç”Ÿæˆå†…å­˜é”çš„ï¼Œä¸€èˆ¬é€šè¿‡éšå¼é”æ¥æ§åˆ¶ã€‚ç­–ç•¥å°±æ˜¯ï¼Œæ’å…¥çš„èšé›†ç´¢å¼•è®°å½•åŒ…å«äº†ä¸€ä¸ªtrx_idï¼Œç„¶åå…¶ä»–äº‹åŠ¡è¦è·å–è¯¥è®°å½•çš„xé”æˆ–è€…sé”çš„æ—¶å€™ï¼Œä¼šåˆ¤æ–­trx_idæ˜¯ä¸æ˜¯å½“å‰æ´»è·ƒäº‹åŠ¡ã€‚å¦‚æœæ˜¯å¸®è¯¥è®°å½•åˆ›å»ºä¸€ä¸ªxé”ï¼Œç„¶åä¸ºè‡ªå·±åˆ›å»ºä¸€ä¸ªé”ï¼Œè¿›å…¥ç­‰å¾…ã€‚","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1627924382,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":373641,"ip_address":""},"score":386998,"extra":""},{"author":{"id":1922583,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaELVtQAW8IIDLKcn36XM9noEfKuAKpJQrwruJzXeibDfmibIiawicj5vaoflct0LuTAiaKcmCY3gK9MknEw/132","nickname":"è¿œæ–¹","note":"","ucode":"0E2FCC59EDCAD4","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1710200,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/VUnspzjpBcmEibUicMJoDpnvsElyX5R6Eia9pjNuP3MaD9iaJpBS4vZ4krzLIniaZucFVrKnfJ1VumLLZ8gRt9KnCLQ/132","nickname":"Geek_39958b","note":"","ucode":"500FC31A7627AE","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":388680,"discussion_content":"é‚£æ˜¯å…ˆè·å–éšå¼é”äº†è¿˜æ˜¯å…ˆæ£€æŸ¥ä¸»é”®äº†ï¼Ÿ æˆ‘è§‰å¾—åº”è¯¥æ˜¯å…ˆè·å–é”","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628909154,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":386998,"ip_address":""},"score":388680,"extra":""}]}]},{"had_liked":false,"id":73298,"user_name":"è½»æ¾çš„é±¼","can_delete":false,"product_type":"c1","uid":1219198,"ip_address":"","ucode":"F4FF653209C47B","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIEl3fX9nvzUF26ekUIicp4sgA5jZ1mGvGMhIHkwJabbjt9h5uTLw5zzU1U6JZbCSpRXBNQwuejLJg/132","comment_is_top":false,"comment_ctime":1551853526,"is_pvip":false,"replies":[{"id":"28008","content":"å¯¹","user_name":"ä½œè€…å›å¤","comment_id":73298,"uid":"1264162","ip_address":"","utype":1,"ctime":1552724124,"user_name_real":"æ—æ™“æ–Œ"}],"discussion_count":11,"race_medal":0,"score":"259249891286","product_id":100020801,"comment_content":"è€å¸ˆå¥½ï¼Œæƒ³è¯·æ•™ä¸€ä¸‹æ­»é”çš„ä¾‹å­ä¸­ï¼š<br>1. åœ¨ session A rollback å‰ï¼Œsession B&#47;C éƒ½å› ä¸ºå”¯ä¸€æ€§å†²çªç”³è¯·äº† S Next-key lockï¼Œä½†æ˜¯è¢« session A çš„ X but not gap lock é˜»å¡ï¼›<br>2. åœ¨ session A rollbak åï¼Œsession B&#47;C é¡ºåˆ©è·å¾— S Next-key lockï¼Œå¹¶ä¸”éƒ½è¦ç»§ç»­è¿›è¡Œæ’å…¥ï¼Œè¿™æ—¶å€™æˆ‘è®¤ä¸ºæ˜¯å› ä¸ºæ’å…¥æ„å‘é”ï¼ˆLOCK_INSERT_INTENTIONï¼‰å¯¼è‡´çš„æ­»é”ï¼Œå› ä¸ºæ’å…¥æ„å‘é”ä¼šè¢« gap lock é˜»å¡ï¼Œé€ æˆäº†ç›¸äº’ç­‰å¾…ã€‚è¿˜æ²¡æœ‰è¿›å…¥åˆ°è®°å½• X lockã€‚<br>ä¸çŸ¥é“æˆ‘åˆ†æçš„å¯¹ä¸å¯¹ï¼Ÿ","like_count":60,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"æ—æ™“æ–Œ","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":442011,"discussion_content":"å¯¹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1552724124,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2448277,"avatar":"https://static001.geekbang.org/account/avatar/00/25/5b/95/462890c6.jpg","nickname":"å¶æ¶›","note":"","ucode":"B45348979BE159","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":373652,"discussion_content":"çœ‹åˆ°è¿™é‡Œæ›´è¿·ç³Šäº†ã€‚ã€‚ã€‚è€å¸ˆä¹Ÿæ²¡æœ‰è®²è¿‡æ„å‘é”å•Š","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1620814514,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1351117,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/2au3iaQvydOVeVY1vlSVeGia7SvrpWFVibdxdjKiafof3RhzFO9e8sxKIBxKXJQibRNpO9pCH2hmibkibsGv7YKF3yjEw/132","nickname":"ç§‹ä¸€åŒ¹","note":"","ucode":"BEBDBF8C15C6BC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":328285,"discussion_content":"æŒ‰ç°åœ¨çš„æ€è·¯æ¥è¯´ï¼Œå¹¶ä¸æ˜¯é—´éš™é”é˜»å¡æ’å…¥æ„å‘é”å¯¼è‡´çš„æ­»é”ã€‚å› ä¸ºé—´éš™é”æ˜¯ä¸åŒ…å«5è¿™æ¡è®°å½•çš„ã€‚è¿˜æ˜¯5ä¸Šçš„è®°å½•é”ï¼ˆsï¼‰å¯¼è‡´çš„æ­»é”","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1606118582,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":3056474,"avatar":"","nickname":"Geek_f5618b","note":"","ucode":"FF7F8BF3A47B30","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1351117,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/2au3iaQvydOVeVY1vlSVeGia7SvrpWFVibdxdjKiafof3RhzFO9e8sxKIBxKXJQibRNpO9pCH2hmibkibsGv7YKF3yjEw/132","nickname":"ç§‹ä¸€åŒ¹","note":"","ucode":"BEBDBF8C15C6BC","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":580636,"discussion_content":"Aå›æ»šåé—´éš™é”æ‰©å¤§åˆ°æ­£æ— ç©·","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1658301676,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":328285,"ip_address":""},"score":580636,"extra":""},{"author":{"id":3189388,"avatar":"https://static001.geekbang.org/account/avatar/00/30/aa/8c/eaa0f576.jpg","nickname":".","note":"","ucode":"66FAAB07BD7B17","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":3056474,"avatar":"","nickname":"Geek_f5618b","note":"","ucode":"FF7F8BF3A47B30","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":588983,"discussion_content":"ä¸ºä»€ä¹ˆï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1664286759,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":580636,"ip_address":"æ¹–åŒ—"},"score":588983,"extra":""}]},{"author":{"id":1024486,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a1/e6/50da1b2d.jpg","nickname":"æ—­ä¸œ(Frank)","note":"","ucode":"176FA629800062","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":78748,"discussion_content":"ä¸»é”®å†²çªä¹Ÿæ˜¯ä¸€æ ·çš„é—®é¢˜å§","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1576003864,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2736955,"avatar":"https://static001.geekbang.org/account/avatar/00/29/c3/3b/c9ae499f.jpg","nickname":"impwang","note":"","ucode":"149DF7CA8D56C9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":582326,"discussion_content":"è¿™é‡Œæ’å…¥æ„å‘é”æ€ä¹ˆå’Œgapé”æ„æˆæ­»é”äº†ï¼ŸåŠ é”æµç¨‹æ˜¯ä»€ä¹ˆå•Šï¼Ÿæœ‰ç‚¹æ™•äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659369435,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"åŒ—äº¬"},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1986739,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/50/b3/9269cd59.jpg","nickname":"LWD","note":"","ucode":"DDA444DB113C01","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2736955,"avatar":"https://static001.geekbang.org/account/avatar/00/29/c3/3b/c9ae499f.jpg","nickname":"impwang","note":"","ucode":"149DF7CA8D56C9","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":588485,"discussion_content":"å¾ˆå¤šè¯„è®ºéƒ½æ˜¯è‡ªå·±å¼ºå¥—ä¹±æƒ³çš„æ¦‚å¿µï¼Œæ¨èçœ‹ä¸‹æ­»é”æ—¥å¿—å°±æ˜ç™½äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1663782328,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":582326,"ip_address":"å¹¿ä¸œ"},"score":588485,"extra":""}]},{"author":{"id":1613760,"avatar":"https://static001.geekbang.org/account/avatar/00/18/9f/c0/86febfff.jpg","nickname":"Master","note":"","ucode":"79D0145B853C9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":376100,"discussion_content":"å†è¡¥å……ä¸€ä¸‹ï¼Œæ„å‘é”æ˜¯å¼•æ“è‡ªå·±åŠ çš„ï¼Œæ˜¯åœ¨è·å–è¡Œé”ä¹‹å‰å»åŠ ï¼Œé‚£ä¹ˆæœ¬è¯¾çš„ä¾‹å­ï¼ŒsessionAå›æ»šï¼Œé‚£ä¹ˆBå’ŒCå°è¯•å»æ“ä½œï¼Œäº‹å…ˆéƒ½åœ¨è¯¥å†²çªè¡Œè·å–äº†è¯»é”ï¼Œåé¢å†å„è‡ªæƒ³æ‰§è¡Œï¼Œå°±è¦åŠ å†™é”äº†ï¼Œé‚£ä¹ˆå°±å­˜åœ¨äº†å†²çªï¼Œæ­¤æ—¶æ˜¯IX","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621955144,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1613760,"avatar":"https://static001.geekbang.org/account/avatar/00/18/9f/c0/86febfff.jpg","nickname":"Master","note":"","ucode":"79D0145B853C9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":376098,"discussion_content":"è¿™é‡Œè¯•ç€å›ç­”ä¸€ä¸‹ï¼Œæ„å‘é”ä¸Šä¸‹æ–‡ç¡®å®æ²¡æœ‰æåˆ°ï¼Œä½†æ˜¯é€šè¿‡è€å¸ˆçš„å›å¤ï¼Œæˆ‘è§‰å¾—å¾—è·³å‡ºæœ¬æ–‡ï¼Œå›åˆ°åŠ é”è¿™é‡Œï¼Œæ„å‘é”è¯´ç™½äº†å°±æ˜¯ä¸ºäº†æ›´å¿«çš„åˆ¤å®šèƒ½ä¸èƒ½åŠ é”æ‰§è¡Œï¼Œå› æ­¤åœ¨å†™æ“ä½œä¸Šï¼Œinnodbä¼šé€šè¿‡äº‹å…ˆå°è¯•è·å–æ„å‘é”æ¥è¿›è¡ŒåŠ é”åˆ¤æ–­ï¼Œæ¯•ç«Ÿæ˜¯è¡¨çº§åˆ«çš„é”ï¼Œå†å›åˆ°æœ¬æ–‡æ­»é”é‚£ä¸ªcaseï¼Œè§‰å¾—ä¹Ÿæ˜¯å…ˆè·å–æ„å‘é”","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621954667,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1219198,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIEl3fX9nvzUF26ekUIicp4sgA5jZ1mGvGMhIHkwJabbjt9h5uTLw5zzU1U6JZbCSpRXBNQwuejLJg/132","nickname":"è½»æ¾çš„é±¼","note":"","ucode":"F4FF653209C47B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1613760,"avatar":"https://static001.geekbang.org/account/avatar/00/18/9f/c0/86febfff.jpg","nickname":"Master","note":"","ucode":"79D0145B853C9E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":376204,"discussion_content":"æ’å…¥æ„å‘é”æ˜¯ä¸€ç§ç‰¹æ®Šçš„é—´éš™é”ï¼Œå’Œæ„å‘é”æ˜¯ä¸¤ä¸ªä¸åŒçš„ä¸œè¥¿","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1622014769,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":376098,"ip_address":""},"score":376204,"extra":""}]}]},{"had_liked":false,"id":67395,"user_name":"sonic","can_delete":false,"product_type":"c1","uid":1309000,"ip_address":"","ucode":"E59D298909E948","user_header":"https://static001.geekbang.org/account/avatar/00/13/f9/48/bf570bab.jpg","comment_is_top":false,"comment_ctime":1550139438,"is_pvip":false,"replies":[{"id":"23999","content":"å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œäº‹åŠ¡æ˜¯å¯ä»¥çœ‹åˆ°è‡ªå·±åˆšåˆšä¿®æ”¹çš„æ•°æ®çš„ ï¼Œå¥½é—®é¢˜","user_name":"ä½œè€…å›å¤","comment_id":67395,"uid":"1264162","ip_address":"","utype":1,"ctime":1550298458,"user_name_real":"æ—æ™“æ–Œ"}],"discussion_count":2,"race_medal":0,"score":"194823667758","product_id":100020801,"comment_content":"ä½ å¥½ï¼Œ<br>æˆ‘æƒ³é—®ä¸‹æ–‡ç« ä¸­å…³äºä¸ºä»€ä¹ˆéœ€è¦åˆ›å»ºä¸´æ—¶è¡¨æœ‰è¿™ä¸€å¥è¯ï¼š<br>å¦‚æœè¯»å‡ºæ¥çš„æ•°æ®ç›´æ¥å†™å›åŸè¡¨ï¼Œå°±å¯èƒ½åœ¨éå†è¿‡ç¨‹ä¸­ï¼Œè¯»åˆ°åˆšåˆšæ’å…¥çš„è®°å½•ï¼Œæ–°æ’å…¥çš„è®°å½•å¦‚æœå‚ä¸è®¡ç®—é€»è¾‘ï¼Œå°±è·Ÿè¯­ä¹‰ä¸ç¬¦ã€‚<br><br>æˆ‘çš„ç–‘é—®æ˜¯ï¼šæ—¢ç„¶éš”ç¦»çº§åˆ«æ˜¯å¯é‡å¤è¯»ï¼Œç…§ç†æ¥è¯´æ–°æ’å…¥çš„çš„è®°å½•åº”è¯¥ä¸ä¼šå‚ä¸è®¡ç®—é€»è¾‘å‘€ã€‚","like_count":45,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"æ—æ™“æ–Œ","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":439177,"discussion_content":"å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œäº‹åŠ¡æ˜¯å¯ä»¥çœ‹åˆ°è‡ªå·±åˆšåˆšä¿®æ”¹çš„æ•°æ®çš„ ï¼Œå¥½é—®é¢˜","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550298458,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1744257,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/9d/81/d748b7eb.jpg","nickname":"åƒé”¤ç™¾ç‚¼é¢†æ‚Ÿä¹‹æé™","note":"","ucode":"224B5CF2101716","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":589362,"discussion_content":"å³ä½¿åœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œè‡ªå·±äº‹åŠ¡æ›´æ–°çš„ç»“æœè¿˜æ˜¯è¦è®¤çš„ï¼Œå½“å‰è¯»äº†è§£ä¸€ä¸‹ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1664767174,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å¹¿ä¸œ"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":66826,"user_name":"å¤¹å¿ƒé¢åŒ…","can_delete":false,"product_type":"c1","uid":1301957,"ip_address":"","ucode":"002BBA49D83D17","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJCscgdVibmoPyRLRaicvk6rjTJxePZ6VFHvGjUQvtfhCS6kO4OZ1AVibbhNGKlWZmpEFf2yA6ptsqHw/132","comment_is_top":false,"comment_ctime":1550026252,"is_pvip":false,"replies":[{"id":"23666","content":"ğŸ‘ï¼Œè¿™ä¸¤ç‚¹éƒ½æ˜¯å¾ˆæœ‰ç”¨çš„å»ºè®®","user_name":"ä½œè€…å›å¤","comment_id":66826,"uid":"1264162","ip_address":"","utype":1,"ctime":1550043549,"user_name_real":"æ—æ™“æ–Œ"}],"discussion_count":2,"race_medal":0,"score":"194823554572","product_id":100020801,"comment_content":"<br>1 å…³äºinserté€ æˆæ­»é”çš„æƒ…å†µ,æˆ‘ä¹‹å‰åšè¿‡æµ‹è¯•,äº‹åŠ¡1å¹¶éåªæœ‰insert,deleteå’Œupdateéƒ½å¯èƒ½é€ æˆæ­»é”é—®é¢˜,æ ¸å¿ƒè¿˜æ˜¯æ’å…¥å”¯ä¸€å€¼å†²çªå¯¼è‡´çš„.æˆ‘ä»¬çº¿ä¸Šçš„å¤„ç†åŠæ³•æ˜¯ 1 å»æ‰å”¯ä¸€å€¼æ£€æµ‹ 2å‡å°‘é‡å¤å€¼çš„æ’å…¥ 3é™ä½å¹¶å‘çº¿ç¨‹æ•°é‡<br>2 å…³äºæ•°æ®æ‹·è´å¤§è¡¨æˆ‘å»ºè®®é‡‡ç”¨pt-archiver,è¿™ä¸ªå·¥å…·èƒ½è‡ªåŠ¨æ§åˆ¶é¢‘ç‡å’Œé€Ÿåº¦,æ•ˆæœå¾ˆä¸é”™,æè®®åœ¨ä½å³°æœŸè¿›è¡Œæ•°æ®æ“ä½œ","like_count":45,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"æ—æ™“æ–Œ","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438933,"discussion_content":"ğŸ‘ï¼Œè¿™ä¸¤ç‚¹éƒ½æ˜¯å¾ˆæœ‰ç”¨çš„å»ºè®®","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550043549,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1069127,"avatar":"https://static001.geekbang.org/account/avatar/00/10/50/47/46da4585.jpg","nickname":"Fan()","note":"","ucode":"FED79EC7D78E91","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":309164,"discussion_content":"é‚“æ€»å¥½","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1601203327,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":70935,"user_name":"Mr.Strive.Z.H.L","can_delete":false,"product_type":"c1","uid":1030198,"ip_address":"","ucode":"6D97E159E2EECD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/b8/36/542c96bf.jpg","comment_is_top":false,"comment_ctime":1551229906,"is_pvip":false,"replies":[{"id":"25436","content":"æ˜¯è¿™æ ·çš„ï¼Œgap lockæ˜¯æ— æ‰€è°“Sè¿˜æ˜¯Xçš„ã€‚<br>ä½†æ˜¯record lock æœ‰ã€‚<br><br>Gap lock + æ’ä»–çš„record å°±ç§°ä½œ æ’ä»–çš„next-key lock å§ğŸ˜„<br><br>","user_name":"ä½œè€…å›å¤","comment_id":70935,"uid":"1264162","ip_address":"","utype":1,"ctime":1551242843,"user_name_real":"æ—æ™“æ–Œ"}],"discussion_count":2,"race_medal":0,"score":"134695216082","product_id":100020801,"comment_content":"è€å¸ˆæ‚¨å¥½ï¼š<br>å…³äºæ–‡ä¸­çš„é”æè¿°æœ‰æ‰€ç–‘æƒ‘ã€‚<br><br>æ–‡ä¸­å‡ºç°è¿‡ å…±äº«çš„next-keyé” å’Œ æ’ä»–çš„next-keyé”ã€‚<br><br>æˆ‘ä»¬çŸ¥é“next-keyæ˜¯ç”± gap lock å’Œ è¡Œé”ç»„æˆçš„ã€‚<br><br>æˆ‘ä¸€ç›´ä»¥æ¥çš„è®¤çŸ¥æ˜¯ gap lockéƒ½æ˜¯sé”ï¼Œæ²¡æœ‰xé”ã€‚<br>è€Œè¡Œé”æœ‰sé”å’Œxé”ã€‚<br>æ¯”å¦‚ selectâ€¦â€¦â€¦lock in share modeï¼Œè¡Œé”æ˜¯s<br>é”ã€‚<br>æ¯”å¦‚selectâ€¦â€¦â€¦for updateï¼Œè¡Œé”å°±æ˜¯xé”ã€‚<br>ä½†æ˜¯gap lock å§‹ç»ˆæ˜¯sé”ã€‚<br><br>æ–‡ä¸­ç›´æ¥æè¿°next-key lockæ˜¯æ’ä»–çš„ï¼Œæ€»è®©æˆ‘è®¤ä¸ºgap lockå’Œè¡Œé”éƒ½æ˜¯xé”ã€‚<br><br>ä¸çŸ¥é“æˆ‘ç†è§£å¾—å¯¹ä¸å¯¹ï¼Ÿ","like_count":31,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"æ—æ™“æ–Œ","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440907,"discussion_content":"æ˜¯è¿™æ ·çš„ï¼Œgap lockæ˜¯æ— æ‰€è°“Sè¿˜æ˜¯Xçš„ã€‚\nä½†æ˜¯record lock æœ‰ã€‚\n\nGap lock + æ’ä»–çš„record å°±ç§°ä½œ æ’ä»–çš„next-key lock å§ğŸ˜„\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551242843,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1179156,"avatar":"https://static001.geekbang.org/account/avatar/00/11/fe/14/f1532dec.jpg","nickname":"é²ç­å¤§å¸ˆ","note":"","ucode":"4F9615DF87B031","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":251899,"discussion_content":"é—´éš™é”æ˜¯è§£å†³å¹»è¯»é—®é¢˜çš„ï¼Œä¸ç®¡å±äºè¯»é”è¿˜æ˜¯å†™é”ï¼Œéƒ½ä¼šé˜»å¡å…¶ä»–äº‹åŠ¡çš„å†™è¯·æ±‚ã€‚ä»è¿™ä¸ªè§’åº¦æ¥çœ‹ï¼Œä¹Ÿå°±æ˜¯æ— æ‰€è°“è¯»é”è¿˜æ˜¯å†™é”äº†ã€‚","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1588125077,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":67064,"user_name":"è€æ¨åŒå¿—","can_delete":false,"product_type":"c1","uid":1246199,"ip_address":"","ucode":"3F334F0CFD3DE6","user_header":"https://static001.geekbang.org/account/avatar/00/13/03/f7/3a493bec.jpg","comment_is_top":false,"comment_ctime":1550065941,"is_pvip":false,"replies":[{"id":"23801","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","comment_id":67064,"uid":"1264162","ip_address":"","utype":1,"ctime":1550127544,"user_name_real":"æ—æ™“æ–Œ"}],"discussion_count":1,"race_medal":0,"score":"126104117525","product_id":100020801,"comment_content":"è¯¾åé—®é¢˜ï¼š<br>      æˆ‘ç”¨çš„æœ€å¤šè¿˜æ˜¯insert into select ã€‚å¦‚æœæ•°é‡æ¯”è¾ƒå¤§ï¼Œä¼šåŠ ä¸Šlimit 100,000è¿™ç§ã€‚å¹¶ä¸”çœ‹çœ‹åé¢çš„selectæ¡ä»¶æ˜¯å¦èµ°ç´¢å¼•ã€‚ç¼ºç‚¹æ˜¯ä¼šé”selectçš„è¡¨ã€‚æ–¹æ³•äºŒï¼šå¯¼å‡ºæˆexcelï¼Œç„¶åæ‹¼sql æˆ insert into values(),(),()çš„å½¢å¼ã€‚æ–¹æ³•3ï¼Œå†™ç±»ä¼¼æ·˜å®è°ƒåŠ¨çš„å®šæ—¶ä»»åŠ¡ï¼Œä»»åŠ¡çš„é€»è¾‘æ˜¯æŸ¥è¯¢100æ¡è®°å½•ï¼Œç„¶åå¤šä¸ªçº¿ç¨‹åˆ†åˆ°å‡ ä¸ªä»»åŠ¡æ‰§è¡Œï¼Œæ¯”å¦‚æ˜¯ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹10æ¡è®°å½•ï¼Œæ’å…¥åï¼Œåœ¨æŸ¥è¯¢æ–°çš„100æ¡è®°å½•å¤„ç†ã€‚<br>      ","like_count":29,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"æ—æ™“æ–Œ","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":439038,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550127544,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":67707,"user_name":"Justin","can_delete":false,"product_type":"c1","uid":1305601,"ip_address":"","ucode":"D49723FEA66731","user_header":"https://static001.geekbang.org/account/avatar/00/13/ec/01/978d54af.jpg","comment_is_top":false,"comment_ctime":1550226433,"is_pvip":false,"replies":[{"id":"24011","content":"é¢ï¼Œ<br>è¿™é‡Œæˆ‘ä»¬è¦æ¾„æ¸…ä¸€ä¸‹å“ˆ<br>åªæœ‰ä¸€ä¸ªgap lockï¼Œå°±æ˜¯ next key lock = gap lock + record lockï¼›<br><br>æˆ‘ä»¬è¯´ä¸€ä¸ªinsertè¯­å¥å¦‚æœè¦æ’å…¥ä¸€ä¸ªé—´éš™ï¼Œè€Œè¿™ä¸ªé—´éš™ä¸Šæœ‰gap lockçš„è¯ï¼Œinsertè¯­å¥ä¼šè¢«å µä½ï¼Œè¿™ä¸ªè¢«å µä½çš„æ•ˆæœï¼Œå®ç°æœºåˆ¶ä¸Šæ˜¯ç”¨æ’å…¥æ„å‘é”å’Œgap lockç›¸äº’ä½œç”¨æ¥å®ç°çš„ã€‚<br>gap lockå¹¶ä¸å±äºæ’å…¥æ„å‘é”çš„ä¸€éƒ¨åˆ† ï¼Œå°±æ²¡æœ‰â€œæ’å…¥æ„å‘é”çš„gal lockâ€è¿™ä¸ªæ¦‚å¿µå“ˆ","user_name":"ä½œè€…å›å¤","comment_id":67707,"uid":"1264162","ip_address":"","utype":1,"ctime":1550299441,"user_name_real":"æ—æ™“æ–Œ"}],"discussion_count":5,"race_medal":0,"score":"91744539649","product_id":100020801,"comment_content":"æ’å…¥æ„å‘é”çš„gal lockå’Œnext key lockä¸­çš„ gaplockäº’æ–¥å—ï¼Ÿ","like_count":21,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"æ—æ™“æ–Œ","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":439338,"discussion_content":"é¢ï¼Œ\nè¿™é‡Œæˆ‘ä»¬è¦æ¾„æ¸…ä¸€ä¸‹å“ˆ\nåªæœ‰ä¸€ä¸ªgap lockï¼Œå°±æ˜¯ next key lock = gap lock + record lockï¼›\n\næˆ‘ä»¬è¯´ä¸€ä¸ªinsertè¯­å¥å¦‚æœè¦æ’å…¥ä¸€ä¸ªé—´éš™ï¼Œè€Œè¿™ä¸ªé—´éš™ä¸Šæœ‰gap lockçš„è¯ï¼Œinsertè¯­å¥ä¼šè¢«å µä½ï¼Œè¿™ä¸ªè¢«å µä½çš„æ•ˆæœï¼Œå®ç°æœºåˆ¶ä¸Šæ˜¯ç”¨æ’å…¥æ„å‘é”å’Œgap lockç›¸äº’ä½œç”¨æ¥å®ç°çš„ã€‚\ngap lockå¹¶ä¸å±äºæ’å…¥æ„å‘é”çš„ä¸€éƒ¨åˆ† ï¼Œå°±æ²¡æœ‰â€œæ’å…¥æ„å‘é”çš„gal lockâ€è¿™ä¸ªæ¦‚å¿µå“ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550299441,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1541014,"avatar":"https://static001.geekbang.org/account/avatar/00/17/83/96/73ff13a0.jpg","nickname":"å¤©äº®å‰è¯´æ™šå®‰","note":"","ucode":"1D82EE562A7C71","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":202676,"discussion_content":"é‚£æ’å…¥æ„å‘é”æ˜¯å•¥å•Šï¼Ÿ","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1583939497,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1411040,"avatar":"https://static001.geekbang.org/account/avatar/00/15/87/e0/63e7d43d.jpg","nickname":"æ˜Ÿç©º","note":"","ucode":"636A0A14608EF0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":388592,"discussion_content":"è¿™å¥è¯ â€œè€Œè¿™ä¸ªé—´éš™ä¸Šæœ‰gap lockçš„è¯ï¼Œinsertè¯­å¥ä¼šè¢«å µä½â€   ä¸è§£ï¼Œgap lock å°±æ˜¯é—´éš™é”å§ï¼Œä¸æ˜¯è¯´é—´éš™é”æ˜¯å…±äº«çš„å—ï¼Œä¸ºä»€ä¹ˆä¼šè¢«é—´éš™é”å µä½","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628843288,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":2771089,"avatar":"","nickname":"Geek_126edf","note":"","ucode":"D5C8819DF40803","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1411040,"avatar":"https://static001.geekbang.org/account/avatar/00/15/87/e0/63e7d43d.jpg","nickname":"æ˜Ÿç©º","note":"","ucode":"636A0A14608EF0","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":398603,"discussion_content":"æˆ‘çš„ç†è§£ï¼Œé—´éš™é”æ˜¯å…±äº«çš„ï¼Œæ‰€ä»¥å¦ä¸€ä¸ªçº¿ç¨‹ä¹Ÿå¯ä»¥æ‹¿åˆ°é—´éš™é”ï¼Œä½†æ˜¯ä»–è¿˜æ˜¯ä¸èƒ½æ‰§è¡Œinsertè¯­å¥","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632820124,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":388592,"ip_address":""},"score":398603,"extra":""},{"author":{"id":1341276,"avatar":"https://static001.geekbang.org/account/avatar/00/14/77/5c/8d53165e.jpg","nickname":"bingo","note":"","ucode":"DD96820EC8871D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1411040,"avatar":"https://static001.geekbang.org/account/avatar/00/15/87/e0/63e7d43d.jpg","nickname":"æ˜Ÿç©º","note":"","ucode":"636A0A14608EF0","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":405441,"discussion_content":"é—´éš™é”å’Œé—´éš™é”å¯ä»¥å…±å­˜ï¼Œå’Œåˆ«çš„é”éƒ½ä¼šå†²çªã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634566768,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":388592,"ip_address":""},"score":405441,"extra":""}]}]},{"had_liked":false,"id":66898,"user_name":"ä¸€å¤§åªğŸ˜´","can_delete":false,"product_type":"c1","uid":1310960,"ip_address":"","ucode":"92F3D2B7F63568","user_header":"https://static001.geekbang.org/account/avatar/00/14/00/f0/08409e78.jpg","comment_is_top":false,"comment_ctime":1550039188,"is_pvip":false,"replies":[{"id":"23805","content":"â€œé‚£è¿™é‡Œçš„session Båº”è¯¥æ˜¯åŠ äº†ä¸ª(22,25]çš„next-key lockï¼Œå¹¶æ²¡æœ‰å› ä¸ºæ˜¯å”¯ä¸€é”®é€€åŒ–æˆè®°å½•é”â€ ç”±äºinsertä¸»é”®å†²çªå¯¼è‡´çš„é”ï¼Œæ˜¯ä¸ä¼šé€€åŒ–çš„ã€‚<br><br>session B åŠ äº†next-key lockï¼Œ<br>è¿™æ ·session Cæ’å…¥ä¹Ÿè¦ç­‰å¾…ï¼Œç„¶åç­‰session Bè¶…æ—¶ï¼Œé‡Šæ”¾äº†è¿™ä¸ªnext-key lockï¼Œsession Cå°±å¯ä»¥æ‰§è¡Œäº†ã€‚<br>è·Ÿæˆ‘ä»¬æ–‡ä¸­è¯´çš„æ˜¯ä¸€è‡´çš„å“¦ã€‚<br><br><br>ä½ è¿™ä¸ªéªŒè¯æŒºåˆç†çš„å‘€ï¼Œ<br><br>ä¸ä¼šæœ‰å› ä¸ºâ€œé—´éš™éå¸¸å°ï¼Œæ‰€ä»¥å°†ä»–å½“æˆè®°å½•é”â€è¿™ç§é€»è¾‘å“ˆ, aå’Œa+1ä¹‹é—´ä¹Ÿæ˜¯æœ‰é—´éš™çš„ğŸ˜†ã€‚<br><br>ä¸è¿‡è¿™ä¸ªæ˜¯ä¸ªå¥½çš„å®éªŒå’Œå¥½é—®é¢˜ğŸ‘","user_name":"ä½œè€…å›å¤","comment_id":66898,"uid":"1264162","ip_address":"","utype":1,"ctime":1550133640,"user_name_real":"æ—æ™“æ–Œ"}],"discussion_count":2,"race_medal":0,"score":"78859450516","product_id":100020801,"comment_content":"è€å¸ˆï¼Œæˆ‘æƒ³é—®ä¸‹ï¼šinsert è¯­å¥å‡ºç°å”¯ä¸€é”®å†²çªï¼Œä¼šåŠ next-key lockï¼Œè€Œäº§ç”Ÿæ­»é”çš„ä¾‹å­ä¸­ï¼ŒåŒæ ·ä¹Ÿæ˜¯å”¯ä¸€é”®å†²çªå´åªåŠ äº†è®°å½•é”ï¼Œç„¶åæˆ‘æŒ‰ç…§å”¯ä¸€é”®å†²çªä¸­çš„ä¸¤ä¸ªä¾‹å­è¯•äº†è¯•<br>1ã€æ¯”å¦‚tè¡¨ä¸­æœ‰ä¸¤æ¡è®°å½•(19,19,19)ï¼Œ(22,22,22)ï¼Œè¿™æ—¶å€™æˆ‘å†insert (22,22,22)é€ æˆäº†ä¸»é”®å†²çªï¼Œè¿™æ—¶å€™åŠ çš„å°±æ˜¯(19,22]çš„next-key lockï¼Œè¿™ä¸ªinsertä¸ºå•¥ä¸æ˜¯ç­‰å€¼æŸ¥è¯¢ï¼Ÿ<br>2ã€æ ¹æ®æ­»é”çš„ä¾‹å­ï¼Œæˆ‘åˆåœ¨tè¡¨ä¸­å‡†å¤‡æ’å…¥ä¸€è¡Œ<br>      session A :begin; insert into t values (25,25,25)<br>      session B :insert into t values (25,25,25)  è¿™æ—¶å€™sessionBé”ç­‰å¾…<br>      session Cï¼šinsert into t values (24,24,24)  é”ç­‰å¾…ï¼Œç­‰Bé”ç­‰å¾…è¶…æ—¶ï¼Œsession Cæ’å…¥æˆåŠŸ<br>      é‚£è¿™é‡Œçš„session Båº”è¯¥æ˜¯åŠ äº†ä¸ª(22,25]çš„next-key lockï¼Œå¹¶æ²¡æœ‰å› ä¸ºæ˜¯å”¯ä¸€é”®é€€åŒ–æˆè®°å½•é”<br>æˆ‘æƒ³æ­»é”çš„ä¾‹å­ä¸­tè¡¨å·²ç»æœ‰äº†(1,1,1),(2,2,2),(3,3,3),(4,4,4)4æ¡è®°å½•ï¼Œè¿™æ—¶å€™insert (null,5,5)ï¼Œæ˜¯ä¸æ˜¯åŠ çš„(4,5]è¿™ä¸ªnext-key lockï¼Œç”±äºæ˜¯æ•´å‹å¹¶ä¸”é—´éš™éå¸¸å°ï¼Œæ‰€ä»¥å°†ä»–å½“æˆè®°å½•é”ï¼Ÿ","like_count":18,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"æ—æ™“æ–Œ","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438965,"discussion_content":"â€œé‚£è¿™é‡Œçš„session Båº”è¯¥æ˜¯åŠ äº†ä¸ª(22,25]çš„next-key lockï¼Œå¹¶æ²¡æœ‰å› ä¸ºæ˜¯å”¯ä¸€é”®é€€åŒ–æˆè®°å½•é”â€ ç”±äºinsertä¸»é”®å†²çªå¯¼è‡´çš„é”ï¼Œæ˜¯ä¸ä¼šé€€åŒ–çš„ã€‚\n\nsession B åŠ äº†next-key lockï¼Œ\nè¿™æ ·session Cæ’å…¥ä¹Ÿè¦ç­‰å¾…ï¼Œç„¶åç­‰session Bè¶…æ—¶ï¼Œé‡Šæ”¾äº†è¿™ä¸ªnext-key lockï¼Œsession Cå°±å¯ä»¥æ‰§è¡Œäº†ã€‚\nè·Ÿæˆ‘ä»¬æ–‡ä¸­è¯´çš„æ˜¯ä¸€è‡´çš„å“¦ã€‚\n\n\nä½ è¿™ä¸ªéªŒè¯æŒºåˆç†çš„å‘€ï¼Œ\n\nä¸ä¼šæœ‰å› ä¸ºâ€œé—´éš™éå¸¸å°ï¼Œæ‰€ä»¥å°†ä»–å½“æˆè®°å½•é”â€è¿™ç§é€»è¾‘å“ˆ, aå’Œa+1ä¹‹é—´ä¹Ÿæ˜¯æœ‰é—´éš™çš„ğŸ˜†ã€‚\n\nä¸è¿‡è¿™ä¸ªæ˜¯ä¸ªå¥½çš„å®éªŒå’Œå¥½é—®é¢˜ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550133640,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1537709,"avatar":"https://static001.geekbang.org/account/avatar/00/17/76/ad/f192d95e.jpg","nickname":"ï¼Ÿæ–°ï¼","note":"","ucode":"56E547E279A10A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":376203,"discussion_content":"é—®é¢˜1  ä½ è¦ææ¸…æ¥šï¼Œæ˜¯ä¸»é”®çš„(19,22]è¿˜æ˜¯ å”¯ä¸€ç´¢å¼•çš„å“¦ï¼Œå®éªŒçš„æ—¶å€™ä¸€å®šè¦ä¿è¯å¥½åœºæ™¯çš„éš”ç¦»ï¼Œåˆ« é‡å äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1622014611,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":66950,"user_name":"roaming","can_delete":false,"product_type":"c1","uid":1039232,"ip_address":"","ucode":"2736679690AB81","user_header":"https://static001.geekbang.org/account/avatar/00/0f/db/80/6b7629d7.jpg","comment_is_top":false,"comment_ctime":1550046519,"is_pvip":false,"replies":[{"id":"23806","content":"çœ‹æ¥æ˜¯çš„äº†ï¼Œ<br><br>ğŸ‘ï¼Œå¾ˆå¥½çš„éªŒè¯ï¼Œæˆ‘åŠ åˆ°æ˜å¤©æ–‡ç« æœ«å°¾è¯´æ˜","user_name":"ä½œè€…å›å¤","comment_id":66950,"uid":"1264162","ip_address":"","utype":1,"ctime":1550133674,"user_name_real":"æ—æ™“æ–Œ"}],"discussion_count":1,"race_medal":0,"score":"53089654071","product_id":100020801,"comment_content":"MySQL8.0.12ç¯å¢ƒä¸‹ï¼Œ<br>æ‰§è¡Œinsert into t(c,d)  (select c+1, d from t force index(c) order by c desc limit 1);<br>slow log Rows_examined: 2<br>Innodb_rows_read çš„å€¼å¢åŠ 1<br><br>æ˜¯ä¸æ˜¯MySQL8è¿›è¡Œäº†ä¼˜åŒ–ï¼Œå…ˆæŠŠå­æŸ¥è¯¢çš„ç»“æœè¯»å‡ºæ¥ï¼Œå†å†™å…¥ä¸´æ—¶è¡¨ï¼Ÿ","like_count":12,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"æ—æ™“æ–Œ","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438990,"discussion_content":"çœ‹æ¥æ˜¯çš„äº†ï¼Œ\n\nğŸ‘ï¼Œå¾ˆå¥½çš„éªŒè¯ï¼Œæˆ‘åŠ åˆ°æ˜å¤©æ–‡ç« æœ«å°¾è¯´æ˜","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550133674,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":83545,"user_name":"inrtyx","can_delete":false,"product_type":"c1","uid":1246178,"ip_address":"","ucode":"81CD18FF34ABAB","user_header":"https://static001.geekbang.org/account/avatar/00/13/03/e2/5768d26e.jpg","comment_is_top":false,"comment_ctime":1554645563,"is_pvip":true,"replies":[{"id":"30222","content":"è¦çœ‹éœ€æ±‚ï¼Œä¸è¿‡å› ä¸ºè¡¨æƒ…ç”¨çš„å¾ˆå¤šäº†ï¼Œutf8mb4å¾ˆå¸¸ç”¨äº†","user_name":"ä½œè€…å›å¤","comment_id":83545,"uid":"1264162","ip_address":"","utype":1,"ctime":1554652890,"user_name_real":"æ—æ™“æ–Œ"}],"discussion_count":1,"race_medal":0,"score":"48799285819","product_id":100020801,"comment_content":"ç°åœ¨ä¸€èˆ¬éƒ½ç”¨utf8mb4?","like_count":11,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"æ—æ™“æ–Œ","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":446066,"discussion_content":"è¦çœ‹éœ€æ±‚ï¼Œä¸è¿‡å› ä¸ºè¡¨æƒ…ç”¨çš„å¾ˆå¤šäº†ï¼Œutf8mb4å¾ˆå¸¸ç”¨äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1554652890,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":67948,"user_name":"ä¿¡ä¿¡","can_delete":false,"product_type":"c1","uid":1303865,"ip_address":"","ucode":"8DF0EC045579FD","user_header":"https://static001.geekbang.org/account/avatar/00/13/e5/39/951f89c8.jpg","comment_is_top":false,"comment_ctime":1550333239,"is_pvip":false,"replies":[{"id":"24093","content":"ä½ è¯´çš„å¯¹ï¼Œè¿™é‡Œå…¶å®æ˜¯â€œå‘å·¦æ‰«æâ€ï¼ŒåŠ é”èŒƒå›´åº”è¯¥æ˜¯(3,4] å’Œ (4, supremum]ã€‚<br>ğŸ‘<br>","user_name":"ä½œè€…å›å¤","comment_id":67948,"uid":"1264162","ip_address":"","utype":1,"ctime":1550369367,"user_name_real":"æ—æ™“æ–Œ"}],"discussion_count":1,"race_medal":0,"score":"48794973495","product_id":100020801,"comment_content":"è€å¸ˆå¥½ï¼Œæ–‡ä¸­æåˆ°ï¼šinsert into t2(c,d) (select c+1, d from t force index(c) order by c desc limit 1)çš„åŠ é”èŒƒå›´æ˜¯è¡¨ t ç´¢å¼• c ä¸Šçš„ (4,supremum] è¿™ä¸ª next-key lock å’Œä¸»é”®ç´¢å¼•ä¸Š id=4 è¿™ä¸€è¡Œã€‚<br>å¯æ˜¯å¦‚æœæˆ‘æŠŠè¡¨tçš„idä¸º3è¿™è¡Œå…ˆåˆ é™¤ï¼Œå†æ‰§è¡Œè¿™ä¸ªinsert...selectï¼Œé‚£ä¹ˆåˆ«çš„ä¼šè¯æ‰§è¡Œinsert into t values(3,3,3)ä¼šè¢«é˜»å¡ï¼Œè¿™è¯´æ˜4ä¹‹å‰ä¹Ÿæ˜¯æœ‰é—´éš™é”çš„ï¼Ÿ<br>å¦å¤–ï¼Œselect c+1, d from t force index(c) order by c desc limit 1 for update æ˜¯ä¸æ˜¯ä¸èƒ½ç”¨ä½œç­‰å€¼æŸ¥è¯¢é‚£æ ·åˆ†æï¼Ÿå› ä¸ºå¦‚æœç®—ç­‰å€¼æŸ¥è¯¢ï¼Œæ ¹æ®ä¼˜åŒ–1æ˜¯æ²¡æœ‰é—´éš™é”çš„ã€‚","like_count":11,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"æ—æ™“æ–Œ","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":439435,"discussion_content":"ä½ è¯´çš„å¯¹ï¼Œè¿™é‡Œå…¶å®æ˜¯â€œå‘å·¦æ‰«æâ€ï¼ŒåŠ é”èŒƒå›´åº”è¯¥æ˜¯(3,4] å’Œ (4, supremum]ã€‚\nğŸ‘\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550369367,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":67383,"user_name":"ä¿¡ä¿¡","can_delete":false,"product_type":"c1","uid":1303865,"ip_address":"","ucode":"8DF0EC045579FD","user_header":"https://static001.geekbang.org/account/avatar/00/13/e5/39/951f89c8.jpg","comment_is_top":false,"comment_ctime":1550137503,"is_pvip":false,"replies":[{"id":"23998","content":"1. ä½ è¯´å¾—å¯¹ï¼ŒğŸ‘ç»†è‡´ï¼Œå‘èµ·å‹˜è¯¯äº†å“ˆ<br>2. å›¾7 è¿™é‡Œè¯´çš„å”¯ä¸€é”®å†²çªï¼Œå°±æ˜¯å‘ç°â€œå·²ç»æœ‰ä¸€ä¸ªc=5çš„è¡Œå­˜åœ¨â€ï¼Œæ‰€ä»¥è½¬ä¸ºåŠ next-key lockï¼Œæ²¡æœ‰å•ç‹¬çš„åŠ è¡Œé”çš„é€»è¾‘å“ˆ","user_name":"ä½œè€…å›å¤","comment_id":67383,"uid":"1264162","ip_address":"","utype":1,"ctime":1550298429,"user_name_real":"æ—æ™“æ–Œ"}],"discussion_count":3,"race_medal":0,"score":"40204843167","product_id":100020801,"comment_content":"è€å¸ˆå¥½ï¼Œ<br>å›¾6ä¸‹æ–¹â€œå‘ç”Ÿä¸»é”®å†²çªçš„æ—¶å€™â€æ˜¯ä¸æ˜¯åº”è¯¥æ”¹ä¸ºâ€œå‘ç”Ÿå”¯ä¸€é”®å†²çªçš„æ—¶å€™â€ï¼Ÿå› ä¸ºcä¸æ˜¯ä¸»é”®ã€‚<br>è¿˜æœ‰ï¼Œå›¾7ä¸‹æ–¹ï¼šT2æ—¶åˆ»session b å‘ç°â€œå”¯ä¸€é”®å†²çªâ€ï¼Œè¿™é‡Œä¸ºå•¥ä¸æ˜¯é”å†²çªï¼Ÿå› ä¸ºå¦‚æœæ²¡æœ‰é”å†²çªï¼Œä»…æœ‰å”¯ä¸€é”®å†²çªï¼Œå°±å¯¹åº”å›¾6çš„æƒ…å†µï¼Œè¿™æ—¶åŠ çš„æ˜¯next-key lockï¼Œè€Œä¸ä»…ä»…æ˜¯è®°å½•é”äº†ã€‚","like_count":9,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"æ—æ™“æ–Œ","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":439171,"discussion_content":"1. ä½ è¯´å¾—å¯¹ï¼ŒğŸ‘ç»†è‡´ï¼Œå‘èµ·å‹˜è¯¯äº†å“ˆ\n2. å›¾7 è¿™é‡Œè¯´çš„å”¯ä¸€é”®å†²çªï¼Œå°±æ˜¯å‘ç°â€œå·²ç»æœ‰ä¸€ä¸ªc=5çš„è¡Œå­˜åœ¨â€ï¼Œæ‰€ä»¥è½¬ä¸ºåŠ next-key lockï¼Œæ²¡æœ‰å•ç‹¬çš„åŠ è¡Œé”çš„é€»è¾‘å“ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550298429,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2448277,"avatar":"https://static001.geekbang.org/account/avatar/00/25/5b/95/462890c6.jpg","nickname":"å¶æ¶›","note":"","ucode":"B45348979BE159","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":373654,"discussion_content":"è¯´å‡ºäº†æˆ‘æƒ³é—®çš„é—®é¢˜ï¼š\né¦–å…ˆä¸ºå•¥Bå’ŒCå¯ä»¥çœ‹åˆ°Aæ²¡æœ‰æäº¤çš„c=5è¿™è¡Œå‘¢ï¼Ÿ\nå…¶æ¬¡ä¸ºå•¥ä¸ä¼šå‡ºç°å”¯ä¸€ç´¢å¼•å†²çªçš„æŠ¥é”™å‘¢ã€‚ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620815147,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":3007210,"avatar":"","nickname":"Geek_a1699c","note":"","ucode":"CF7DB00BE36B77","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2448277,"avatar":"https://static001.geekbang.org/account/avatar/00/25/5b/95/462890c6.jpg","nickname":"å¶æ¶›","note":"","ucode":"B45348979BE159","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":577844,"discussion_content":"1ã€å½“å‰è¯»ï¼Œæ‰€ä»¥å¯ä»¥çœ‹åˆ°\n2ã€è¿™ä¸ªæˆ‘è‡ªå·±è¯•éªŒäº†ï¼ŒçŒœæµ‹åº”è¯¥æ˜¯è¦å…ˆæ‹¿åˆ°å†™é”ï¼Œç„¶åå†åˆ¤æ–­æ˜¯å¦é‡å¤ã€‚æ‹¿å†™é”çš„æ—¶å€™å°±é˜»å¡äº†ï¼Œè¿˜æ²¡åˆ°é‡å¤æ£€éªŒæŠ¥é”™é‚£ä¸€æ­¥","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1656387337,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":373654,"ip_address":""},"score":577844,"extra":""}]}]},{"had_liked":false,"id":68566,"user_name":"ç‹ä¼¯è½©","can_delete":false,"product_type":"c1","uid":1108650,"ip_address":"","ucode":"546814BA7E5839","user_header":"https://static001.geekbang.org/account/avatar/00/10/ea/aa/cdd13ad2.jpg","comment_is_top":false,"comment_ctime":1550545108,"is_pvip":false,"replies":[{"id":"24323","content":"è¿™å°±æ˜¯å‹åŠ›å¤ªå¤§äº†ã€‚ã€‚ ä¸€èˆ¬ä¼´éšç€ioutilå¾ˆå¤§ï¼Œè¯­å¥æ‰§è¡Œç‰¹åˆ«æ…¢ï¼Œåˆ«çš„è¯­å¥å°±è¢«å µç€ç­‰é”ï¼Œç­‰è¶…æ—¶å°±è‡ªå·±crash","user_name":"ä½œè€…å›å¤","comment_id":68566,"uid":"1264162","ip_address":"","utype":1,"ctime":1550551506,"user_name_real":"æ—æ™“æ–Œ"}],"discussion_count":4,"race_medal":0,"score":"35910283476","product_id":100020801,"comment_content":"è€å¸ˆä½ å¥½,å»å¹´åŒ11ç¢°åˆ°äº†dbcrashæ‰çš„æƒ…å†µ.è‡³ä»Šæ²¡æœ‰æ‰¾åˆ°ç­”æ¡ˆ,å¿ƒé‡Œæ¸—å¾—æ…Œ.è€å¸ˆå¸®å¿™åˆ†æä¸‹.  <br>æˆ‘æ˜¯ä¸€ä¸ªå¼€å‘,å…³äºdbçš„çŸ¥è¯†æ›´å¤šæ˜¯åœ¨åº”ç”¨å’ŒåŸºæœ¬åŸç†ä¸Šé¢,å®åœ¨æ˜¯æ‰¾ä¸åˆ°åŸå› . æˆ‘ä¹Ÿæœäº†ä¸€äº›èµ„æ–™ æ„Ÿè§‰åƒæ˜¯mysqlçš„bug,ä¸è¿‡åœ¨å…¶buglistä¸­æ²¡æœ‰æ‰¾åˆ°å®Œå…¨ä¸€è‡´çš„ï¼Œå½“ç„¶ä¹Ÿå¯èƒ½æ˜¯æˆ‘ä»¬ä¸šåŠ¡ä¹Ÿè®¸å¯¼è‡´åº“çš„å‹åŠ›å¤§çš„åŸå› .   <br>åº”ç”¨ç«¯çœ‹åˆ°çš„ç°è±¡æ˜¯dbæ²¡æœ‰å“åº”ï¼Œåº”ç”¨éœ€è¦è®¿é—®dbçš„çº¿ç¨‹å…¨éƒ¨åƒµæ­».dbè¡¨ç°æ˜¯hangä½ , å½“æ—¶çš„è¯Šæ–­æ—¥å¿—å¦‚ä¸‹ï¼Œè¡¨é¢è¡¨ç°ä¸ºä¸€ç›´è·å–ä¸åˆ°latché”ï¼ˆè¢«ä¸€ä¸ªinsertçº¿ç¨‹æŒæœ‰ä¸é‡Šæ”¾ï¼‰ https:&#47;&#47;note.youdao.com&#47;ynoteshare1&#47;index.html?id=1771445db3ff1e08cbdd8328ea6765a7&amp;type=note#&#47;  éš”ç¦»çº§åˆ«æ˜¯rr<br><br>åŒæ ·çš„crashåŒ11å½“å¤©åé¢åˆå‡ºç°äº†ä¸€æ¬¡ï¼ˆå“­æ­»ï¼‰,<br>éƒ½æ˜¯é‡å¯æ•°æ®åº“è§£å†³çš„,<br><br>åé¢åº”ç”¨å±‚é¢åšäº†ä¸€æ ·ä¼˜åŒ–,æ²¡æœ‰å†crashè¿‡ï¼Œä¼˜åŒ–ä¸»è¦å¦‚ä¸‹ï¼š<br>1.å‡å°è¯»å‹åŠ›ï¼Œå»é™¤ä¸€äº›ä¸å¿…è¦çš„æŸ¥è¯¢ï¼Œ<br>2.ä¼˜åŒ–å‰ï¼Œæœ‰å¹¶å‘äº‹åŠ¡å†™å’ŒæŸ¥è¯¢åŒä¸€æ¡æ•°æ®è®°å½•ï¼Œå³äº‹åŠ¡aæ‰§è¡Œinsert å°šæœªæäº¤ï¼Œäº‹åŠ¡bå°±æ¥æŸ¥è¯¢ï¼ˆå¿«ç…§è¯»ï¼‰ï¼Œä¼˜åŒ–åä¿è¯æŸ¥è¯¢æ—¶insertäº‹åŠ¡å·²ç»æäº¤","like_count":8,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"æ—æ™“æ–Œ","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":439733,"discussion_content":"è¿™å°±æ˜¯å‹åŠ›å¤ªå¤§äº†ã€‚ã€‚ ä¸€èˆ¬ä¼´éšç€ioutilå¾ˆå¤§ï¼Œè¯­å¥æ‰§è¡Œç‰¹åˆ«æ…¢ï¼Œåˆ«çš„è¯­å¥å°±è¢«å µç€ç­‰é”ï¼Œç­‰è¶…æ—¶å°±è‡ªå·±crash","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550551506,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2171678,"avatar":"https://static001.geekbang.org/account/avatar/00/21/23/1e/cc62c8a8.jpg","nickname":"å¤§æ¡ƒå­åˆå¥½åƒ","note":"","ucode":"C84EBAB4B1DF15","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":309850,"discussion_content":"éš”ç¦»çº§åˆ«ä¸ºä»€ä¹ˆè¦ç”¨RR ?","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1601461849,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1101234,"avatar":"https://static001.geekbang.org/account/avatar/00/10/cd/b2/807137b9.jpg","nickname":"åŒ—æ–¹æ˜“åˆ","note":"","ucode":"C57FDBD37F43E6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2171678,"avatar":"https://static001.geekbang.org/account/avatar/00/21/23/1e/cc62c8a8.jpg","nickname":"å¤§æ¡ƒå­åˆå¥½åƒ","note":"","ucode":"C84EBAB4B1DF15","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":579082,"discussion_content":"é»˜è®¤ä¸æ˜¯ RRå—ï¼Ÿä½ ç»™ä¸€ä¸ªä¸ç”¨é»˜è®¤çš„ç†ç”± ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1657167589,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":309850,"ip_address":""},"score":579082,"extra":""}]},{"author":{"id":1253416,"avatar":"https://static001.geekbang.org/account/avatar/00/13/20/28/14540c7c.jpg","nickname":"äº®ä»”","note":"","ucode":"7EB5943F729221","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":139500,"discussion_content":"ä½ çš„éš”ç¦»å‡ ç¬”æ˜¯éƒ½æœªæäº¤å—ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579277001,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":67628,"user_name":"Justin","can_delete":false,"product_type":"c1","uid":1305601,"ip_address":"","ucode":"D49723FEA66731","user_header":"https://static001.geekbang.org/account/avatar/00/13/ec/01/978d54af.jpg","comment_is_top":false,"comment_ctime":1550212780,"is_pvip":false,"replies":[{"id":"23959","content":"æ˜¯è¯´æ’å…¥ç¢°åˆ°å”¯ä¸€é”®å†²çªçš„æ—¶å€™æ‰ä¼šå“ˆ","user_name":"ä½œè€…å›å¤","comment_id":67628,"uid":"1264162","ip_address":"","utype":1,"ctime":1550217913,"user_name_real":"æ—æ™“æ–Œ"}],"discussion_count":1,"race_medal":0,"score":"35909951148","product_id":100020801,"comment_content":"ä¸ºä»€ä¹ˆinsert è¿˜ä¼šä½¿ç”¨åˆ°next key lock å‘¢ ï¼Œæˆ‘è®°å¾—æˆ‘åŸæ¥çœ‹çš„èµ„æ–™å†™çš„æ˜¯æ’å…¥ä½¿ç”¨çš„æ˜¯æ’å…¥æ„å‘é”å•Š","like_count":8,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"æ—æ™“æ–Œ","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":439288,"discussion_content":"æ˜¯è¯´æ’å…¥ç¢°åˆ°å”¯ä¸€é”®å†²çªçš„æ—¶å€™æ‰ä¼šå“ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550217913,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":67724,"user_name":"phpzheng","can_delete":false,"product_type":"c1","uid":1187120,"ip_address":"","ucode":"4C7F89AD84F4D1","user_header":"https://static001.geekbang.org/account/avatar/00/12/1d/30/3e280597.jpg","comment_is_top":false,"comment_ctime":1550232277,"is_pvip":false,"replies":[{"id":"24012","content":"insertä»¥å<br>select last_insert_id,<br>å†updateï¼Œ<br>åªèƒ½è¿™ä¹ˆåšå•¦<br><br>å¦‚æœè¦å¿«ä¸€äº›ï¼Œå¯èƒ½å¯ä»¥è€ƒè™‘å‡å°‘äº¤äº’ï¼Œæ¯”å¦‚å†™æˆå­˜å‚¨è¿‡ç¨‹","user_name":"ä½œè€…å›å¤","comment_id":67724,"uid":"1264162","ip_address":"","utype":1,"ctime":1550299497,"user_name_real":"æ—æ™“æ–Œ"}],"discussion_count":1,"race_medal":0,"score":"31615003349","product_id":100020801,"comment_content":"å¾ªç¯æ’å…¥æ•°æ®ï¼Œç„¶åæ‹¿ç€åˆšåˆšæ’å…¥çš„ä¸»é”®idï¼Œæ›´æ–°æ•°æ®ã€‚è¯·é—®æ€ä¹ˆæé«˜è¿™ä¸ªæƒ…å†µçš„æ•ˆç‡","like_count":7,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"æ—æ™“æ–Œ","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":439345,"discussion_content":"insertä»¥å\nselect last_insert_id,\nå†updateï¼Œ\nåªèƒ½è¿™ä¹ˆåšå•¦\n\nå¦‚æœè¦å¿«ä¸€äº›ï¼Œå¯èƒ½å¯ä»¥è€ƒè™‘å‡å°‘äº¤äº’ï¼Œæ¯”å¦‚å†™æˆå­˜å‚¨è¿‡ç¨‹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550299497,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":81822,"user_name":"å¸¸è¶…","can_delete":false,"product_type":"c1","uid":1138665,"ip_address":"","ucode":"4AE7743B4ADF20","user_header":"https://static001.geekbang.org/account/avatar/00/11/5f/e9/95ef44f3.jpg","comment_is_top":false,"comment_ctime":1554043339,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"27323847115","product_id":100020801,"comment_content":"å¯¹è¿™ä¸ªSQL æ‰§è¡Œè¿‡ç¨‹çš„è§£é‡Šï¼Œ<br>insert into t(c,d)  (select c+1, d from t force index(c) order by c desc limit 1);<br><br>&gt;ç”±äºå®ç°ä¸Šè¿™ä¸ªè¯­å¥æ²¡æœ‰åœ¨å­æŸ¥è¯¢ä¸­å°±ç›´æ¥ä½¿ç”¨ limit 1ï¼Œä»è€Œå¯¼è‡´äº†è¿™ä¸ªè¯­å¥çš„æ‰§è¡Œéœ€è¦éå†æ•´ä¸ªè¡¨ tã€‚<br>æ²¡å¤ªçœ‹æ‡‚â€œç”±äºâ€é‚£å¥è¯ï¼Œæ—¢ç„¶åœ¨å­æŸ¥è¯¢ä¸­æœ‰äº†limit 1ï¼Œä¸ºä»€ä¹ˆä¸èƒ½åªæŠŠæœ€åä¸€æ¡è®°å½•æ’å…¥ä¸´æ—¶è¡¨å‘¢ï¼Ÿ<br>è€å¸ˆèƒ½åœ¨è¯´æ˜ä¸€ä¸‹å—ï¼Ÿ","like_count":6,"discussions":[{"author":{"id":1644950,"avatar":"https://static001.geekbang.org/account/avatar/00/19/19/96/3b49b437.jpg","nickname":"éƒ­æŸæŸ","note":"","ucode":"5E53B60527DCDF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":292324,"discussion_content":"åŒé—®","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595175409,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":67583,"user_name":"å¤¹å¿ƒé¢åŒ…","can_delete":false,"product_type":"c1","uid":1301957,"ip_address":"","ucode":"002BBA49D83D17","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJCscgdVibmoPyRLRaicvk6rjTJxePZ6VFHvGjUQvtfhCS6kO4OZ1AVibbhNGKlWZmpEFf2yA6ptsqHw/132","comment_is_top":false,"comment_ctime":1550201793,"is_pvip":false,"replies":[{"id":"24009","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","comment_id":67583,"uid":"1264162","ip_address":"","utype":1,"ctime":1550299272,"user_name_real":"æ—æ™“æ–Œ"}],"discussion_count":1,"race_medal":0,"score":"27320005569","product_id":100020801,"comment_content":"æˆ‘æ¥è¡¥å……åº”ç”¨è¡¨ç©ºé—´è¿ç§»çš„åœºæ™¯<br>1  å†·æ•°æ®è¡¨çš„å¤åˆ¶å’Œè¿ç§»<br>2 å¤§è¡¨æ•°æ®çš„æ¢å¤,çº¿ä¸ŠDDLæ“ä½œå¤±è¯¯,éœ€è¦æ¢å¤æ—¶,åˆ©ç”¨å¤‡ä»½+binlogè¿›è¡Œæ¢å¤å,è¡¨ç©ºé—´è¿ç§»è¿›è¡Œå¯¼å…¥<br>å¯¹äºçƒ­è¡¨æ•°æ®çš„å¤åˆ¶å»ºè®®è¿˜æ˜¯é‡‡ç”¨pt-archiveræ…¢æ…¢æ","like_count":6,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"æ—æ™“æ–Œ","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":439260,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550299272,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":69878,"user_name":"å‘æ¡æ©™å­ ã€‚","can_delete":false,"product_type":"c1","uid":1259218,"ip_address":"","ucode":"ED076F4534FFED","user_header":"https://static001.geekbang.org/account/avatar/00/13/36/d2/c7357723.jpg","comment_is_top":false,"comment_ctime":1550895451,"is_pvip":false,"replies":[{"id":"24918","content":"ä¸æ˜¯éƒ½ä¼šï¼Œæ˜¯åœ¨è¦å†™å…¥çš„æ—¶å€™ï¼Œå‘ç°æœ‰ä¸»é”®å†²çªï¼Œæ‰ä¼šåŠ ä¸Šè¿™ä¸ªnext-key lockçš„é”","user_name":"ä½œè€…å›å¤","comment_id":69878,"uid":"1264162","ip_address":"","utype":1,"ctime":1550936934,"user_name_real":"æ—æ™“æ–Œ"}],"discussion_count":2,"race_medal":0,"score":"23025731931","product_id":100020801,"comment_content":"è€å¸ˆï¼Œå¹´åè¿‡æ¥ç‹‚è¡¥è¯¾ç¨‹äº†å“ˆå“ˆ ï¼Œ çœ‹åˆ°è€å¸ˆçš„bugç•™è¨€å·²ç»è¢«fixæ‰å‡†å¤‡åœ¨æœ€æ–°ç‰ˆæœ¬å‘å¸ƒäº†å‘¢ã€‚ <br><br>è¿™é‡Œæˆ‘æœ‰ä¸€ä¸ªç–‘é—®ï¼Œ æˆ‘ä¹‹å‰ä»¥ä¸ºåªæœ‰æ›´æ–°çš„æ—¶å€™æ‰ä¼šåŠ é”ï¼Œ å‚è€ƒå‰é¢çš„æ–‡ç« ï¼Œinnodbè¦å…ˆæ‰«æè¡¨ä¸­æ•°æ®ï¼Œè¢«æ‰«æåˆ°çš„è¡Œè¦åŠ é” ã€‚<br><br>æˆ–è€…æˆ‘ä»¬æ‰§è¡Œ select çš„æ—¶å€™æ‰‹åŠ¨åŠ ä¸Š æ’ä»–é” æˆ–è€… å…±äº«é”ï¼Œä¹Ÿä¼šé”ä½ã€‚<br><br>è¿™é‡Œè€å¸ˆè®²åˆ°å¦‚æœç´¢å¼•å”¯ä¸€é”®å†²çªï¼Œ innodbä¸ºäº†åšå¤„ç†åŠ äº† next_key lockï¼ˆSï¼‰ è¿™ä¸ªå¯ä»¥ç†è§£ã€‚<br><br>insert .. select ä¹Ÿæ˜¯å› ä¸ºæœ‰ select ç´¢å¼•ä¼šåŠ é” ä¹Ÿå¯ä»¥ç†è§£<br><br>é—®é¢˜ ï¼š<br><br>å›¾7é‚£ä¸ªæ­»é”çš„æ¡ˆä¾‹ï¼Œ session A çš„æ—¶å€™ åªæ˜¯æ‰§è¡Œäº† insert è¯­å¥ï¼Œæ‰§è¡Œ insertçš„æ—¶å€™ä¹Ÿæ²¡æœ‰selectä¹‹ç±»çš„ï¼Œä¸ºä»€ä¹ˆä¹Ÿä¼šåœ¨ç´¢å¼•cä¸ŠåŠ ä¸ªé”ï¼Œ æ˜¯ä»€ä¹ˆæ—¶å€™åŠ çš„å‘¢ ï¼Ÿï¼Ÿï¼Ÿ æ˜¯ insert è¯­å¥æœ‰ç´¢å¼•çš„è¯éƒ½ä¼šç»™ç´¢å¼•åŠ é”ä¹ˆï¼Ÿï¼Ÿ<br><br>","like_count":5,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"æ—æ™“æ–Œ","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440326,"discussion_content":"ä¸æ˜¯éƒ½ä¼šï¼Œæ˜¯åœ¨è¦å†™å…¥çš„æ—¶å€™ï¼Œå‘ç°æœ‰ä¸»é”®å†²çªï¼Œæ‰ä¼šåŠ ä¸Šè¿™ä¸ªnext-key lockçš„é”","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550936934,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1117852,"avatar":"https://static001.geekbang.org/account/avatar/00/11/0e/9c/2413fd6f.jpg","nickname":"ETLshow","note":"","ucode":"B57C574B3343CD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":559958,"discussion_content":"æˆ‘ç°åœ¨è¿˜æ˜¯å¥‡æ€ªè¿™ä¸ªé—®é¢˜","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649080806,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":69369,"user_name":"æ»”æ»”","can_delete":false,"product_type":"c1","uid":1303342,"ip_address":"","ucode":"6968B5771AF79D","user_header":"https://static001.geekbang.org/account/avatar/00/13/e3/2e/77ad18f4.jpg","comment_is_top":false,"comment_ctime":1550729253,"is_pvip":false,"replies":[{"id":"24990","content":"ä¸æ˜¯ï¼Œå‘ç°å†²çªç›´æ¥åŠ çš„å°±æ˜¯å†™é”","user_name":"ä½œè€…å›å¤","comment_id":69369,"uid":"1264162","ip_address":"","utype":1,"ctime":1550997675,"user_name_real":"æ—æ™“æ–Œ"}],"discussion_count":1,"race_medal":0,"score":"23025565733","product_id":100020801,"comment_content":"è€å¸ˆï¼Œæœ‰ä¸ªé—®é¢˜insert into â€¦ on duplicate key updateè¯­å¥åœ¨å‘ç”Ÿå†²çªçš„æ—¶å€™æ˜¯å…ˆåŠ next keyè¯»é”ï¼Œç„¶ååœ¨æ‰§è¡Œåé¢çš„updateè¯­å¥æ—¶å†ç»™å†²çªè®°å½•åŠ ä¸Šå†™é”ï¼Œä»è€ŒæŠŠä¹‹å‰åŠ çš„next keyè¯»é”å˜æˆäº†å†™é”ï¼Œæ˜¯è¿™æ ·çš„å—ï¼Ÿ","like_count":5,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"æ—æ™“æ–Œ","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440084,"discussion_content":"ä¸æ˜¯ï¼Œå‘ç°å†²çªç›´æ¥åŠ çš„å°±æ˜¯å†™é”","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550997675,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":68201,"user_name":"ç‹ä¼¯è½©","can_delete":false,"product_type":"c1","uid":1108650,"ip_address":"","ucode":"546814BA7E5839","user_header":"https://static001.geekbang.org/account/avatar/00/10/ea/aa/cdd13ad2.jpg","comment_is_top":false,"comment_ctime":1550456715,"is_pvip":false,"replies":[{"id":"24142","content":"è¿™ä¸ªç³»åˆ—é‡Œæ²¡è®²åˆ°äº†<br><br>è¿™ç§æˆ‘ç¢°åˆ°æ¯”è¾ƒå¤šçš„æ˜¯ioå‹åŠ›ç‰¹åˆ«å¤§ï¼Œå¯¼è‡´æœ‰çš„äº‹åŠ¡æ‰§è¡Œä¸ä¸‹å»ï¼Œä½†æ˜¯å ç€é”<br><br>ç„¶åå…¶ä»–äº‹åŠ¡å°±æ‹¿ä¸åˆ°é”ï¼Œæœ‰ä¸€ä¸ª600è®¡æ—¶ï¼Œè¶…è¿‡å°±crashäº†","user_name":"ä½œè€…å›å¤","comment_id":68201,"uid":"1264162","ip_address":"","utype":1,"ctime":1550463303,"user_name_real":"æ—æ™“æ–Œ"}],"discussion_count":1,"race_medal":0,"score":"23025293195","product_id":100020801,"comment_content":"å†…å­˜é” å¤§å¤§è®¡åˆ’è®²ä¸‹ä¹ˆ,å®é™…ä¸­ç¢°åˆ°å†…å­˜é”è¢«æŒæœ‰åä¸€ç›´ä¸é‡Šæ”¾å¯¼è‡´dbç›´æ¥crashæ‰","like_count":5,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"æ—æ™“æ–Œ","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":439563,"discussion_content":"è¿™ä¸ªç³»åˆ—é‡Œæ²¡è®²åˆ°äº†\n\nè¿™ç§æˆ‘ç¢°åˆ°æ¯”è¾ƒå¤šçš„æ˜¯ioå‹åŠ›ç‰¹åˆ«å¤§ï¼Œå¯¼è‡´æœ‰çš„äº‹åŠ¡æ‰§è¡Œä¸ä¸‹å»ï¼Œä½†æ˜¯å ç€é”\n\nç„¶åå…¶ä»–äº‹åŠ¡å°±æ‹¿ä¸åˆ°é”ï¼Œæœ‰ä¸€ä¸ª600è®¡æ—¶ï¼Œè¶…è¿‡å°±crashäº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550463303,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":67028,"user_name":"é¢œæµ·èˆª","can_delete":false,"product_type":"c1","uid":1308159,"ip_address":"","ucode":"5644F6328BF901","user_header":"https://static001.geekbang.org/account/avatar/00/13/f5/ff/523fb378.jpg","comment_is_top":false,"comment_ctime":1550057977,"is_pvip":false,"replies":[{"id":"23991","content":"è¿™ä¸ªæ˜¯å› ä¸ºå¤‡åº“åº”ç”¨æ—¥å¿—å¤ªæ…¢ï¼Œç´¯ç§¯è¿‡å¤š<br><br>ä½†æ˜¯è¿™ä¸ªæƒ…å†µåº”è¯¥ä¸è‡³äºä¼šå¯¼è‡´æ•°æ®åº“é‡å¯è¯¶~ï¼Œ<br>MySQLå¸¸è§çš„è‡ªå·±é‡å¯æ˜¯ioå‹åŠ›è¿‡å¤§ï¼Œå¯èƒ½ä¼šè‡ªå·±é‡å¯<br><br>ä½ è¿™ä¸ªå¤‡åº“åº”ç”¨è¿‡æ…¢å¯èƒ½ä¹Ÿåªæ˜¯â€œè¢«å½±å“çš„æ•ˆæœâ€<br><br>å¯å¦è´´ä¸€ä¸‹errorloog","user_name":"ä½œè€…å›å¤","user_name_real":"æ—æ™“æ–Œ","uid":"1264162","ctime":1550297426,"ip_address":"","comment_id":67028,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18729927161","product_id":100020801,"comment_content":"[Note] Multi-threaded slave: Coordinator has waited 8551 times hitting slave_pending_jobs_<br>size_max; current event size = 8198. è€å¸ˆ æˆ‘ä»¬æ•°æ®åº“ä¸€ç›´æŠ¥è¿™ä¸ªé”™ï¼Œç„¶åæ•°æ®åº“å°±è¿›è¡Œcrash recoveryï¼Œæ˜¯æ˜¯ä»€ä¹ˆçŠ¶å†µã€‚ã€‚","like_count":4,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"æ—æ™“æ–Œ","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":439021,"discussion_content":"è¿™ä¸ªæ˜¯å› ä¸ºå¤‡åº“åº”ç”¨æ—¥å¿—å¤ªæ…¢ï¼Œç´¯ç§¯è¿‡å¤š\n\nä½†æ˜¯è¿™ä¸ªæƒ…å†µåº”è¯¥ä¸è‡³äºä¼šå¯¼è‡´æ•°æ®åº“é‡å¯è¯¶~ï¼Œ\nMySQLå¸¸è§çš„è‡ªå·±é‡å¯æ˜¯ioå‹åŠ›è¿‡å¤§ï¼Œå¯èƒ½ä¼šè‡ªå·±é‡å¯\n\nä½ è¿™ä¸ªå¤‡åº“åº”ç”¨è¿‡æ…¢å¯èƒ½ä¹Ÿåªæ˜¯â€œè¢«å½±å“çš„æ•ˆæœâ€\n\nå¯å¦è´´ä¸€ä¸‹errorloog","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550297426,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":66879,"user_name":"æ»”æ»”","can_delete":false,"product_type":"c1","uid":1303342,"ip_address":"","ucode":"6968B5771AF79D","user_header":"https://static001.geekbang.org/account/avatar/00/13/e3/2e/77ad18f4.jpg","comment_is_top":false,"comment_ctime":1550034232,"is_pvip":false,"replies":[{"id":"23779","content":"ä¸€èˆ¬select ...lock in share modeå°±æ˜¯å…±äº«é”ï¼›<br>select ... for update å’Œ IUDè¯­å¥ï¼Œå°±æ˜¯æ’ä»–é”ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"æ—æ™“æ–Œ","uid":"1264162","ctime":1550110558,"ip_address":"","comment_id":66879,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18729903416","product_id":100020801,"comment_content":"è€å¸ˆæ‚¨å¥½ï¼Œæƒ³é—®ä¸€ä¸‹next key lockæ˜¯gapé”å’Œè¡Œé”çš„ç»„åˆï¼Œä½†ç©¶ç«Ÿæ˜¯gapé”å’Œå…±äº«é”è¿˜æ˜¯æ’å®ƒé”çš„ç»„åˆæ˜¯ä¸æ˜¯è¦çœ‹å…·ä½“çš„sqlè¯­å¥ï¼Ÿå…·ä½“å“ªäº›sqlè¯­å¥ä¸­çš„next key lockæ˜¯ç”±å…±äº«é”ç»„æˆï¼Œå“ªäº›æ˜¯ç”±æ’å®ƒé”ç»„æˆå‘¢ï¼ŸğŸ¤”","like_count":4,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"æ—æ™“æ–Œ","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438956,"discussion_content":"ä¸€èˆ¬select ...lock in share modeå°±æ˜¯å…±äº«é”ï¼›\nselect ... for update å’Œ IUDè¯­å¥ï¼Œå°±æ˜¯æ’ä»–é”ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550110558,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":212914,"user_name":"ä¾§è€³å€¾å¬","can_delete":false,"product_type":"c1","uid":1512642,"ip_address":"","ucode":"5BF2A2440B54F0","user_header":"https://static001.geekbang.org/account/avatar/00/17/14/c2/46ebe3a0.jpg","comment_is_top":false,"comment_ctime":1588237501,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"14473139389","product_id":100020801,"comment_content":"åŸæ–‡:è‡³äºä¸ºä»€ä¹ˆè¦åŠ è¿™ä¸ªè¯»é”ï¼Œå…¶å®æˆ‘ä¹Ÿæ²¡æœ‰æ‰¾åˆ°åˆç†çš„è§£é‡Šã€‚<br>ç†è§£:æ–—èƒ†è§£é‡Šä¸€ä¸‹ï¼Œä¸çŸ¥å¯¹ä¸å¯¹ã€‚<br>å½“è¦æ’å…¥ä¸€æ¡è®°å½•çš„æ—¶å€™ï¼Œå› ä¸ºåœ¨å¹¶å‘ç¯å¢ƒä¸‹ï¼ŒåŒä¸€æ—¶ç‚¹å¯èƒ½ä¼šæœ‰å¤šä¸ªsessionåŒæ—¶æ’å…¥ï¼Œå‡è®¾å½“å‰è¡¨é‡Œæ²¡æœ‰è¿™æ¡æ•°æ®ï¼Œä¸¤ä¸ªsessionåœ¨åŒä¸€æ—¶ç‚¹åŒæ—¶checkæ•°æ®æ˜¯å¦å­˜åœ¨ï¼Œè¿”å›ç»“æœéƒ½æ˜¯ä¸å­˜åœ¨ï¼ŒåˆåŒæ—¶æ’å…¥è¯¥æ•°æ®ï¼Œè¿™ç§æƒ…å†µä¸‹å¿…é¡»é€šè¿‡åŠ é”æ¥äº’æ–¥","like_count":3},{"had_liked":false,"id":121982,"user_name":"é’±","can_delete":false,"product_type":"c1","uid":1009652,"ip_address":"","ucode":"2C92A243A463D4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg","comment_is_top":false,"comment_ctime":1565263387,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"14450165275","product_id":100020801,"comment_content":"è€å¸ˆï¼Œä¹Ÿè®¸é—®é¢˜æœ‰ç‚¹å‚»ï¼Œä¸è¿‡æˆ‘è¿˜æ˜¯æƒ³é—®ä¸€ä¸‹ã€‚<br>é”ï¼Œåœ¨è®¡ç®—æœºä¸–ç•Œä¸­æ˜¯éå¸¸é‡è¦çš„ï¼Œåªè¦æœ‰å¹¶å‘å¿…ç„¶ä¼šæœ‰é”ï¼Œè¿™ä¸ªé”ä¸åƒè¿™æŠŠğŸ”’ï¼Œçœ‹çš„è§ä¹Ÿå¸¸è§å¾ˆå®¹æ˜“ç†è§£ã€‚<br>1ï¼šé”ï¼Œåœ¨è®¡ç®—æœºä¸–ç•Œç©¶ç«Ÿæ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ï¼Ÿä¸€ç§æ•°æ®ç»“æ„ï¼Ÿä¸€å¥è®¡ç®—æœºå‘½ä»¤ï¼Ÿä¸€ç§åŒæ­¥æœºåˆ¶ï¼Ÿåœ¨JAVAä¸­æœ‰è®¸å¤šé”çš„ç±»ï¼Œèƒ½äº§ç”Ÿé”çš„å¯¹è±¡ï¼Œå®ç°é”çš„åŠŸèƒ½ï¼Œä½†æ˜¯å®ƒæ€ä¹ˆé”çš„ï¼Ÿæˆ‘å¾ˆå¥½å¥‡ï¼Œæ²¡å®Œå…¨å¼„æ˜ç™½ã€‚<br>2ï¼šé”ï¼Œæ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿæ˜¯æ‰“ä¸ªæ ‡è®°å˜›ï¼Ÿæ–°æ¥çš„çº¿ç¨‹ä¸€çœ‹æœ‰æ ‡è®°å°±ç­‰ç€ï¼Œè‡ªå·±ä¹Ÿæ‰“ä¸€ä¸ªã€‚JAVAä¸­çœ‹åˆ°è¿‡ç”¨ä¸€ä¸ªå˜é‡å½“é”ï¼Œè¿›å…¥é”å˜é‡åŠ ä¸€è§£é”å˜é‡å‡ä¸€ï¼Œè¿™æ ·æ ¹æ®å˜é‡å€¼å°±çŸ¥é“æ˜¯å¦åŠ é”äº†ï¼ŒMySQLä¹Ÿæ˜¯å¦‚æ­¤å—ï¼Ÿ<br>3ï¼šé”ï¼Œè¯´åŠ åœ¨ç´¢å¼•ä¸Šï¼Œè¿™ä¸ªåŠ åœ¨ç´¢å¼•ä¸Šæ€ä¹ˆåŠ çš„å‘¢ï¼Ÿç´¢å¼•æ˜¯ä¸€æ£µæ ‘ï¼Œä¹Ÿæ˜¯ä»¥ä¸€ä¸ªå¯¹è±¡çš„å½¢å¼å­˜åœ¨çš„å—ï¼Ÿ<br>æ€»æ˜¯å¬åˆ°è¿™ä¸ªé”é‚£ä¸ªé”çš„ï¼Œæˆ‘è§‰å¾—æ²¡æœ‰ç†è§£é”çš„æœ¬è´¨æ˜¯å•¥ï¼Œæˆ–è€…é”è¿™ä¸ªæ¦‚å¿µæ˜¯æ“ä½œç³»ç»Ÿä¸–ç•Œçš„è¯ï¼Œåœ¨æ“ä½œç³»ç»Ÿå±‚é¢æ›´å®¹æ˜“ç†è§£ä¸€äº›ï¼Œåœ¨å„ç§åº”ç”¨è½¯ä»¶ä¸­å°±æ˜¯ä¸€æ®µä»£ç ï¼Œåªæ˜¯åŠŸèƒ½å’Œç°å®ä¸­é”é—¨çš„é”çš„åŠŸèƒ½ç›¸ä¼¼è€Œå·²ã€‚<br>4ï¼šæœ‰ç­‰å¾…å°±æœ‰å”¤é†’ï¼Œå”¤é†’å°±æ˜¯å”¤é†’çº¿ç¨‹å˜›ï¼Ÿè¿™ä¸ªå”¤é†’å°±æ€ä¹ˆå”¤é†’å‘¢ï¼Ÿæ˜¯ä»ç­‰å¾…çš„é˜Ÿåˆ—ä¸­è·å–ä¸€ä¸ªçº¿ç¨‹å˜›ï¼Ÿé‚£ä»–åˆæ€ä¹ˆçŸ¥é“ä¹‹å‰æ‰§è¡Œåˆ°å“ªï¼Ÿè¯¥æ€ä¹ˆæ‰§è¡Œå•¦ï¼Ÿ","like_count":3,"discussions":[{"author":{"id":1997293,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/79/ed/4737a49b.jpg","nickname":"é›ªã®é›«Â·é›¨ã®éŸ³","note":"","ucode":"0693DA3939A321","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":273319,"discussion_content":"æ•°æ®åº“çš„é”æ€ä¹ˆå®ç°çš„ã€‚ã€‚æˆ‘å°±ä¸æ¸…æ¥šäº†ï¼Œä¸è¿‡é”çš„å®ç°æ— éä¸‰ç§æ–¹æ³•ï¼Œä¸€ç§æ˜¯è½¯ä»¶å±‚é¢çš„å®ç°ï¼Œä¸€ç§æ˜¯ä¾èµ–äºæ“ä½œç³»ç»Ÿåº•å±‚ï¼Œè¿˜æœ‰ä¸€ç§å°±æ˜¯åˆ©ç”¨ç¡¬ä»¶åŒæ­¥åŸè¯­ã€‚ä¼°è®¡MySQLè‚¯å®šä¹Ÿæ˜¯ç”¨è¿™ä¸‰ç§æ–¹æ³•å…¶ä¸­çš„ä¸€ç§æˆ–è€…å‡ ç§å®ç°çš„å§","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590429305,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1997293,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/79/ed/4737a49b.jpg","nickname":"é›ªã®é›«Â·é›¨ã®éŸ³","note":"","ucode":"0693DA3939A321","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":273318,"discussion_content":"åœ¨javaä¸­æœ‰çš„é”æ˜¯é€šè¿‡ç¡¬ä»¶åŒæ­¥åŸè¯­å®ç°çš„ï¼Œæ¯”å¦‚CASï¼Œè¿˜æœ‰çš„æ˜¯ä¾èµ–äºæ“ä½œç³»ç»Ÿåº•å±‚å®ç°çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590429226,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":67686,"user_name":"Justin","can_delete":false,"product_type":"c1","uid":1305601,"ip_address":"","ucode":"D49723FEA66731","user_header":"https://static001.geekbang.org/account/avatar/00/13/ec/01/978d54af.jpg","comment_is_top":false,"comment_ctime":1550222808,"is_pvip":false,"replies":[{"id":"24010","content":"å¦‚æœå‘ç”Ÿå†²çªï¼Œå°±ä¸æ˜¯æ’å…¥åœ¨é—´éš™é‡Œé¢ï¼Œè¿™é‡Œå°±è¿˜æ²¡åˆ°â€œæ’å…¥æ„å‘é”â€çš„é€»è¾‘å“ˆ","user_name":"ä½œè€…å›å¤","user_name_real":"æ—æ™“æ–Œ","uid":"1264162","ctime":1550299324,"ip_address":"","comment_id":67686,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14435124696","product_id":100020801,"comment_content":"é‚£å¦‚æœæ˜¯å†²çªæ—¶ ä¼šåŠ next key lockçš„è¯ é—´éš™é”å’Œæ’å…¥æ„å‘é”ä¸ä¼šå†²çªå—ï¼Ÿ","like_count":3,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"æ—æ™“æ–Œ","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":439326,"discussion_content":"å¦‚æœå‘ç”Ÿå†²çªï¼Œå°±ä¸æ˜¯æ’å…¥åœ¨é—´éš™é‡Œé¢ï¼Œè¿™é‡Œå°±è¿˜æ²¡åˆ°â€œæ’å…¥æ„å‘é”â€çš„é€»è¾‘å“ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550299324,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":66899,"user_name":"æ»”æ»”","can_delete":false,"product_type":"c1","uid":1303342,"ip_address":"","ucode":"6968B5771AF79D","user_header":"https://static001.geekbang.org/account/avatar/00/13/e3/2e/77ad18f4.jpg","comment_is_top":false,"comment_ctime":1550039300,"is_pvip":false,"replies":[{"id":"23780","content":"å¥½é—®é¢˜<br><br>è¿™ç§æƒ…å†µä¸‹ä¸€èˆ¬æ˜¯é€ æˆé”ç­‰å¾…ï¼Œä¸ä¼šé€ æˆæ­»é”å§ ğŸ˜†","user_name":"ä½œè€…å›å¤","user_name_real":"æ—æ™“æ–Œ","uid":"1264162","ctime":1550110686,"ip_address":"","comment_id":66899,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14434941188","product_id":100020801,"comment_content":"è€å¸ˆï¼Œä¹‹å‰æåˆ°çš„ä¸€ä¸ªæœ‰è¶£çš„é—®é¢˜&quot;Aã€Bä¸¤ä¸ªç”¨æˆ·ï¼Œå¦‚æœäº’ç›¸å–œæ¬¢ï¼Œåˆ™æˆä¸ºå¥½å‹ã€‚è®¾è®¡ä¸Šæ˜¯æœ‰ä¸¤å¼ è¡¨ï¼Œä¸€ä¸ªæ˜¯likeè¡¨ï¼Œä¸€ä¸ªæ˜¯friendè¡¨ï¼Œlikeè¡¨æœ‰user_idã€liker_idä¸¤ä¸ªå­—æ®µï¼Œæˆ‘è®¾ç½®ä¸ºå¤åˆå”¯ä¸€ç´¢å¼•å³uk_user_id_liker_idã€‚è¯­å¥æ‰§è¡Œé¡ºåºæ˜¯è¿™æ ·çš„ï¼š<br>ä»¥Aå–œæ¬¢Bä¸ºä¾‹ï¼š<br>1ã€å…ˆæŸ¥è¯¢å¯¹æ–¹æœ‰æ²¡æœ‰å–œæ¬¢è‡ªå·±ï¼ˆBæœ‰æ²¡æœ‰å–œæ¬¢Aï¼‰<br>select * from like where user_id = B and liker_id = A<br>2ã€å¦‚æœæœ‰ï¼Œåˆ™æˆä¸ºå¥½å‹<br>insert into friend<br>3ã€æ²¡æœ‰ï¼Œåˆ™åªæ˜¯å–œæ¬¢å…³ç³»<br>insert into like&quot;ï¼Œè¿™ä¸ªé—®é¢˜ä¸­å¦‚æœæŠŠselectè¯­å¥æ”¹æˆ&quot;å½“å‰è¯»&quot;ï¼Œåˆ™å½“å‡ºç°A,Bä¸¤ä¸ªäººåŒæ—¶å–œæ¬¢å¯¹æ–¹çš„æƒ…å†µä¸‹ï¼Œæ˜¯ä¸æ˜¯ä¼šå‡ºç°ç”±äº&quot;å½“å‰è¯»&quot;åŠ çš„gapé”å¯¼è‡´åé¢insertè¯­å¥é˜»å¡ï¼Œä»è€Œå‘ç”Ÿæ­»é”ï¼Ÿ","like_count":3,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"æ—æ™“æ–Œ","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438966,"discussion_content":"å¥½é—®é¢˜\n\nè¿™ç§æƒ…å†µä¸‹ä¸€èˆ¬æ˜¯é€ æˆé”ç­‰å¾…ï¼Œä¸ä¼šé€ æˆæ­»é”å§ ğŸ˜†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550110686,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":207493,"user_name":"çº¢é¢œé“­å¿ƒ","can_delete":false,"product_type":"c1","uid":1889026,"ip_address":"","ucode":"18F94E5444C71A","user_header":"","comment_is_top":false,"comment_ctime":1587093484,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"10177028076","product_id":100020801,"comment_content":"1.SessionAå†™å…¥è®°å½• è§¦å‘Unique Keyçš„å†²çªæ£€æŸ¥ï¼Œè§¦å‘å½“å‰è¯»ï¼Œè·å–è¡Œè®°å½•next-key X lockï¼Œç­‰å€¼æŸ¥è¯¢+å”¯ä¸€ç´¢å¼• ä¼˜åŒ–é™çº§C=5è®°å½•é”ã€‚<br>2.SessionBå†™å…¥è®°å½• è§¦å‘Unique Keyçš„å†²çªæ£€æŸ¥ï¼Œå†²çªåè·å–(4,5]next-key S lockï¼Œè¢«C=5çš„X Locké˜»å¡ï¼Œ(4,5)gap lockåŠ é”æˆåŠŸï¼Œç­‰å¾…C=5è¯»é”ã€‚<br>3.SessionCå†™å…¥è®°å½• è§¦å‘Unique Keyçš„å†²çªæ£€æŸ¥ï¼Œå†²çªåè·å–(4,5]next-key S lockï¼Œè¢«C=5çš„X Locké˜»å¡ï¼Œ(4,5)gap lockåŠ é”æˆåŠŸï¼Œç­‰å¾…C=5è¯»é”ã€‚<br>4.SessionAå›æ»šåé‡Šæ”¾C=5è®°å½•é”ï¼ŒSessionBå’ŒCåŒæ—¶äº‰æŠ¢åˆ°C=5è¯»é”ã€‚<br>5.SessionBå’ŒCåœ¨æ‰§è¡Œæ’å…¥æ“ä½œï¼Œæ’å…¥æ„å‘é”å’Œè¯»é”äº’æ–¥ï¼Œå¾ªç¯å†²çªæ­»é”ã€‚<br>6.Unique Keyæ£€æŸ¥é€»è¾‘:è‹¥æ’å…¥è®°å½•çš„ç›®æ ‡é¡µåœ¨å†…å­˜ä¸­ï¼Œæ ‘æœç´¢æ‰¾åˆ°æ’å…¥ä½ç½®åˆ¤æ–­æ˜¯å¦å­˜åœ¨å†²çª;è‹¥ä¸åœ¨å†…å­˜é¡µï¼Œéœ€è¦å°†æ’å…¥ä½ç½®çš„ç›®æ ‡é¡µåŠ è½½åˆ°å†…å­˜å†åˆ¤æ–­ã€‚","like_count":2,"discussions":[{"author":{"id":2057540,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqTFWQ9M0qy9XW5Ts8yr1wBFYvGMrXwmeufkuo0E8dF3uXFsmhQMBmWiaovurza3mtuib33qlUPNkgw/132","nickname":"Geek_eb32d1","note":"","ucode":"3306F694BA00BF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":330371,"discussion_content":"å…ˆèµåé—®\nunique keyæ£€æŸ¥é€»è¾‘åº”è¯¥æ˜¯éœ€è¦åŠ é”çš„å§ï¼Œä¸ç„¶å¯èƒ½ä¼šå‡ºç°ä¸¤ä¸ªäº‹åŠ¡éƒ½æ£€æŸ¥é€šè¿‡ï¼ŒåŒæ—¶æ’å…¥çš„æƒ…å†µï¼Œè¯·é—®è¿™é‡Œmysqlæ˜¯é€šè¿‡ä»€ä¹ˆæ–¹å¼é¿å…çš„å‘¢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606581396,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":76558,"user_name":"ä¼Ÿä»”_Hoo","can_delete":false,"product_type":"c1","uid":1323341,"ip_address":"","ucode":"74945AEE48DD62","user_header":"https://static001.geekbang.org/account/avatar/00/14/31/4d/ea8ac77c.jpg","comment_is_top":false,"comment_ctime":1552632445,"is_pvip":false,"replies":[{"id":"27969","content":"session Açš„selectè¯­å¥æ²¡æœ‰åŠ  for update æˆ–è€… lock in share mode ?","user_name":"ä½œè€…å›å¤","user_name_real":"æ—æ™“æ–Œ","uid":"1264162","ctime":1552694136,"ip_address":"","comment_id":76558,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10142567037","product_id":100020801,"comment_content":"è€å¸ˆï¼Œçœ‹åˆ°æ‚¨çš„å›å¤ï¼Œå½“select c+1, d from t force index(c) order by c desc limit 1;è¿™æ¡è¯­å¥å•ç‹¬æ‰§è¡Œæ˜¯ä¼šåœ¨cç´¢å¼•ä¸ŠåŠ (4,sup] è¿™ä¸ªnext key lock, äºæ˜¯æˆ‘è¿›è¡Œäº†å°è¯•<br>sessionA: <br>begin;<br>select c+1, d from t3 force index(c) order by c desc limit 1;<br>sessionB:<br>insert into t3 values(5, 5, 5);<br>ç»“æœæ˜¯ï¼ŒsessionBæ’å…¥æˆåŠŸï¼Œæ˜¯ä¸æ˜¯æˆ‘å“ªé‡Œç†è§£é”™äº†ï¼Ÿæˆ‘çš„ç‰ˆæœ¬æ˜¯5.7.23","like_count":2,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"æ—æ™“æ–Œ","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":443354,"discussion_content":"session Açš„selectè¯­å¥æ²¡æœ‰åŠ  for update æˆ–è€… lock in share mode ?","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1552694136,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":74262,"user_name":"Lilian","can_delete":false,"product_type":"c1","uid":1324238,"ip_address":"","ucode":"92F87DA351543A","user_header":"https://static001.geekbang.org/account/avatar/00/14/34/ce/289dadb6.jpg","comment_is_top":false,"comment_ctime":1552147543,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"10142082135","product_id":100020801,"comment_content":"è€å¸ˆï¼Œèƒ½å¸®å¿™çœ‹ä¸‹è¿™ä¸ªæ­»é”è®°å½•å—ï¼Ÿå¯¹äºduplicate keyæ’å…¥æœ‰ä»€ä¹ˆé˜»æ­¢çš„å¥½æ–¹æ³•ï¼ŸLATEST DETECTED DEADLOCK<br>------------------------<br>190222  8:37:45<br>*** (1) TRANSACTION:<br>TRANSACTION 16FEC1AE, ACTIVE 0 sec inserting<br>mysql tables in use 1, locked 1<br>LOCK WAIT 6 lock struct(s), heap size 1248, 3 row lock(s)<br>MySQL thread id 169973, OS thread handle 0x2ba0fa040700, query id 41915315 10.45.133.181 W59FFHKU<br>INSERT INTO resource (<br>                        Id<br>                      , Name<br>                      , Date<br>                      , User<br>                    ) VALUES (99127, &#39;RS_2098185e367d11e9878202a98a7af318&#39;, &#39;&#39;, &#39;JR&#39;)<br>*** (1) WAITING FOR THIS LOCK TO BE GRANTED:<br>RECORD LOCKS space id 78 page no 71 n bits 160 index `PRIMARY` of table `resource` trx id 16FEC1AE lock_mode X insert intention waiting<br>Record lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0<br> 0: len 8; hex 73757072656d756d; asc supremum;;<br>*** (2) TRANSACTION:<br>TRANSACTION 16FEC1AF, ACTIVE 0 sec inserting<br>mysql tables in use 1, locked 1<br>6 lock struct(s), heap size 1248, 3 row lock(s)<br>MySQL thread id 169996, OS thread handle 0x2ba0ffec2700, query id 41915317 10.45.133.181 W59FFHKU<br>INSERT INTO resource (<br>                        Id<br>                      , Name<br>                      , Date<br>                      , User<br>                    ) VALUES (99125, &#39;RS_2098b778367d11e9878202a98a7af318&#39;, &#39;&#39;, &#39;JR&#39;)<br>*** (2) HOLDS THE LOCK(S):<br>RECORD LOCKS space id 78 page no 71 n bits 160 index `PRIMARY` of table `resource` trx id 16FEC1AF lock mode S<br>Record lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0<br> 0: len 8; hex 73757072656d756d; asc supremum;;<br>*** (2) WAITING FOR THIS LOCK TO BE GRANTED:<br>RECORD LOCKS space id 78 page no 71 n bits 160 index `PRIMARY` of table `resource` trx id 16FEC1AF lock_mode X insert intention waiting<br>Record lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0<br> 0: len 8; hex 73757072656d756d; asc supremum;;<br>*** WE ROLL BACK TRANSACTION (2)","like_count":2,"discussions":[{"author":{"id":1105854,"avatar":"https://static001.geekbang.org/account/avatar/00/10/df/be/c6f8953f.jpg","nickname":"ä¸‡äº‹å±‹","note":"","ucode":"57C08B85373B0D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":575876,"discussion_content":"sessionæ”¹æˆRCåº”è¯¥å¯ä»¥å§","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655168684,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2457512,"avatar":"","nickname":"Geek_d1a3d2","note":"","ucode":"08C95F1859767D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":383276,"discussion_content":"æˆ‘ä¹Ÿç¢°åˆ°äº†ï¼Œè¿˜æ²¡è§£å†³ğŸ˜­","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1626018530,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":74190,"user_name":"Lilian","can_delete":false,"product_type":"c1","uid":1324238,"ip_address":"","ucode":"92F87DA351543A","user_header":"https://static001.geekbang.org/account/avatar/00/14/34/ce/289dadb6.jpg","comment_is_top":false,"comment_ctime":1552139503,"is_pvip":false,"replies":[{"id":"27144","content":"è¿™ä¸ªå–å†³äºä¸šåŠ¡éœ€æ±‚ï¼Œå¦‚æœæ˜¯æ˜ç¡®ä¼šå­˜åœ¨è¿™æ ·çš„æƒ…å†µï¼Œå¹¶ä¸”å¯ä»¥å¿½ç•¥ï¼Œæ˜¯å¯ä»¥è¿™ä¹ˆç”¨çš„","user_name":"ä½œè€…å›å¤","user_name_real":"æ—æ™“æ–Œ","uid":"1264162","ctime":1552146625,"ip_address":"","comment_id":74190,"utype":1}],"discussion_count":2,"race_medal":0,"score":"10142074095","product_id":100020801,"comment_content":"è€å¸ˆï¼Œé‡å¤ä¸»é”®æ’å…¥å†²çªæ˜¯å¦æ¨èinsert ignoreæ–¹æ³•ï¼Ÿ","like_count":2,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"æ—æ™“æ–Œ","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":442489,"discussion_content":"è¿™ä¸ªå–å†³äºä¸šåŠ¡éœ€æ±‚ï¼Œå¦‚æœæ˜¯æ˜ç¡®ä¼šå­˜åœ¨è¿™æ ·çš„æƒ…å†µï¼Œå¹¶ä¸”å¯ä»¥å¿½ç•¥ï¼Œæ˜¯å¯ä»¥è¿™ä¹ˆç”¨çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1552146625,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1188023,"avatar":"https://static001.geekbang.org/account/avatar/00/12/20/b7/bdb3bcf0.jpg","nickname":"Eternal","note":"","ucode":"EA6FE7CC98F740","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":400101,"discussion_content":"ä½†æ˜¯è¿™æ ·æ˜¯ä¸æ˜¯æŠŠé€»è¾‘ä¸‹å±‚åˆ°SQLå±‚äº†ï¼Œ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633165652,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":71437,"user_name":"å¼ æ°¸å¿—","can_delete":false,"product_type":"c1","uid":1208727,"ip_address":"","ucode":"E54B75EF3F63B3","user_header":"https://static001.geekbang.org/account/avatar/00/12/71/97/f1a3d398.jpg","comment_is_top":false,"comment_ctime":1551342673,"is_pvip":false,"replies":[{"id":"25547","content":"æ˜¯ä¸ºäº†å®ç°è¿™ä¸ªç›®çš„ï¼Œæ˜¯å§ğŸ˜€","user_name":"ä½œè€…å›å¤","user_name_real":"æ—æ™“æ–Œ","uid":"1264162","ctime":1551349212,"ip_address":"","comment_id":71437,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10141277265","product_id":100020801,"comment_content":"å¯¹ä¸»é”®æ’å…¥åŠ è¯»é”çš„ä¸ªäººç†è§£ï¼Œä¸¤ä¸ªä¼šè¯insertåŒæ ·è®°å½•ï¼Œåœ¨æ²¡æœ‰æäº¤æƒ…å†µä¸‹ï¼Œinsertä¸»é”®åŠ è¯»é”æ˜¯ä¸ºäº†é¿å…ç¬¬ä¸€ä¸ªä¼šè¯å›æ»šåï¼Œç¬¬äºŒä¸ªä¼šè¯å¯ä»¥æ­£å¸¸æ‰§è¡Œï¼›ç¬¬ä¸€ä¸ªä¼šè¯æäº¤åï¼Œç¬¬äºŒä¸ªä¼šè¯å†æŠ¥é”™ã€‚","like_count":2,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"æ—æ™“æ–Œ","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":441148,"discussion_content":"æ˜¯ä¸ºäº†å®ç°è¿™ä¸ªç›®çš„ï¼Œæ˜¯å§ğŸ˜€","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551349212,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":290472,"user_name":"è½»æ¾çš„é±¼","can_delete":false,"product_type":"c1","uid":1219198,"ip_address":"","ucode":"F4FF653209C47B","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIEl3fX9nvzUF26ekUIicp4sgA5jZ1mGvGMhIHkwJabbjt9h5uTLw5zzU1U6JZbCSpRXBNQwuejLJg/132","comment_is_top":false,"comment_ctime":1619579032,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5914546328","product_id":100020801,"comment_content":"insert into t2 select * from tï¼Œå·²çŸ¥ï¼šRR éš”ç¦»çº§åˆ«æ—¶ï¼Œä¼šå¯¹ t è¡¨æ‰€æœ‰è®°å½•åŠ  S next key lockï¼Œæ˜¯ä¸€ä¸ªå½“å‰è¯»ã€‚<br><br>ä½†æ˜¯åŠ é”å¹¶ä¸æ˜¯ä¸€æ¬¡æ€§å¯¹æ‰€æœ‰è®°å½•åŠ é”çš„ï¼Œè€Œæ˜¯æ‰«ä¸€è¡ŒåŠ ä¸€è¡Œï¼ˆåŒ…æ‹¬é—´éš™ï¼‰ï¼Œå¦‚æœ t è¡¨å¾ˆå¤§ï¼Œå½“åŠ é”åªåŠ åˆ° id=100000 æ—¶ï¼Œæ­¤æ—¶å…¶ä»–äº‹åŠ¡æ˜¯å¯ä»¥å¯¹ id&lt;100000 çš„æ•°æ®è¿›è¡Œä¿®æ”¹ã€æ’å…¥ã€åˆ é™¤çš„ã€‚ç”±äºåŸäº‹åŠ¡å¯¹ t è¡¨æ˜¯ä¸ªå½“å‰è¯»ï¼Œå°±èƒ½å¤Ÿè¯»åˆ°å…¶ä»–äº‹åŠ¡ä¿®æ”¹çš„æ•°æ®ã€‚è¿™æ˜¯ä¸æ˜¯å±äºé€»è¾‘é”™è¯¯ï¼Ÿå½“ç„¶è¿™é‡Œèƒ½ä¿è¯binlog çš„ä¸€è‡´ã€‚<br><br>ç›¸åRCéš”ç¦»çº§åˆ«ï¼Œå¯¹ t è¡¨è®°å½•æ˜¯ä¸åŠ é”çš„ï¼Œè€Œä¸”åšçš„æ˜¯å¿«ç…§è¯»ï¼Œç¡®å®æ²¡æœ‰é€»è¾‘é—®é¢˜ï¼Œä¹Ÿä¸ä¼šæœ‰ä¸ binlog ä¸ä¸€è‡´çš„é—®é¢˜ï¼ˆå› ä¸ºRCéš”ç¦»çº§åˆ«ï¼Œstatementæ ¼å¼å‹æ ¹ä¸å…è®¸åšä¿®æ”¹æ•°æ®çš„æ“ä½œï¼‰ã€‚<br><br>æ‰€ä»¥æœ€ç»ˆé—®é¢˜æ˜¯ï¼š<br>1. RRéš”ç¦»çº§åˆ«ï¼Œstatementæ ¼å¼ï¼Œinsert into t2 select * from tï¼Œæœ‰æ²¡æœ‰é€»è¾‘é—®é¢˜ï¼Ÿ<br>2. RRéš”ç¦»çº§åˆ«ï¼Œrowæ ¼å¼ï¼Œä¸ºä»€ä¹ˆä¹Ÿè¦å¯¹ t è¡¨è®°å½•åŠ é”ï¼Ÿä¸ºä»€ä¹ˆä¸èƒ½å’ŒRCéš”ç¦»çº§åˆ«ä¸€æ ·åšå¿«ç…§è¯»ï¼Ÿ<br>","like_count":1},{"had_liked":false,"id":225248,"user_name":"Bing","can_delete":false,"product_type":"c1","uid":1355177,"ip_address":"","ucode":"01C276F21AD2D6","user_header":"https://static001.geekbang.org/account/avatar/00/14/ad/a9/031a0cc1.jpg","comment_is_top":false,"comment_ctime":1591694318,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5886661614","product_id":100020801,"comment_content":"mvcc+next-keyæ˜¯å¦å¯ä»¥è§£å†³å¹»è¯»å‘¢ï¼Ÿ","like_count":1},{"had_liked":false,"id":206786,"user_name":"æ¸…é£","can_delete":false,"product_type":"c1","uid":1129749,"ip_address":"","ucode":"59932E13FAF607","user_header":"https://static001.geekbang.org/account/avatar/00/11/3d/15/7f5fd6d3.jpg","comment_is_top":false,"comment_ctime":1586934714,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5881902010","product_id":100020801,"comment_content":"è€å¸ˆ æˆ‘18å¹´çœ‹çš„ä½ æ–‡ç« ï¼Œ2020å¹´äº†åˆæ¥çœ‹ä¸€ä¸‹ã€‚replace into è¿™ä¸ªsql  ä¹Ÿä¼šå‡ºç°å”¯ä¸€ç´¢å¼•å¹¶å‘æ’å…¥çš„åˆ°æœ€åæ­»é”çš„é—®é¢˜ï¼Œè¿™ä¸ªé—®é¢˜åº”è¯¥å’Œinsert into å”¯ä¸€ç´¢å¼•å†²çªå¯¼è‡´çš„é—®é¢˜åº”è¯¥æ˜¯ä¸€è‡´çš„","like_count":1},{"had_liked":false,"id":66974,"user_name":"skyoo","can_delete":false,"product_type":"c1","uid":1302503,"ip_address":"","ucode":"EBC0528BA02DD7","user_header":"https://static001.geekbang.org/account/avatar/00/13/df/e7/4ce5ed27.jpg","comment_is_top":false,"comment_ctime":1550050123,"is_pvip":false,"replies":[{"id":"23781","content":"å¾ˆå¥½çš„éªŒè¯ğŸ‘<br>ä½ å†è¯•è¯•ä¸€ä¸ªinsertæ’å…¥å¤šè¡Œçš„ä¾‹å­ï¼Œå°±å®Œæ•´äº†ğŸ˜†","user_name":"ä½œè€…å›å¤","user_name_real":"æ—æ™“æ–Œ","uid":"1264162","ctime":1550111526,"ip_address":"","comment_id":66974,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5845017419","product_id":100020801,"comment_content":"mysql&gt; insert into t select null,5,5; å·²ç»åˆ4æ¡è®°å½•<br>mysql&gt; select * from t;<br>| 1 | 1 | 1 |<br>| 2 | 2 | 100 |<br>| 3 | 3 | 3 |<br>| 4 | 4 | 4 |<br>| 5 | 5 | 5 |<br>+----+------+------+<br>5 rows in set (0.00 sec)<br><br>mysql&gt; select last_insert_id();<br>+------------------+<br>| last_insert_id() |<br>+------------------+<br>| 5 |<br>+------------------+<br>1 row in set (0.00 sec)<br><br>mysql&gt; select * from t2; å·²ç»æœ‰ä¸‰æ¡è®°å½•<br>+----+------+------+<br>| id | c | d |<br>+----+------+------+<br>| 5 | 1 | NULL |<br>| 6 | 6 | 6 |<br>| 7 | 7 | 7 |<br>+----+------+------+<br>3 rows in set (0.01 sec)<br>mysql&gt; select last_insert_id(); æ­¤å¤„çš„è‡ªå¢ID æ˜¯å¦ç†è§£ä¸º æœ€è¿‘ä¸€æ¬¡çš„ insert æ“ä½œçš„ è·å–çš„ID<br>+------------------+<br>| last_insert_id() |<br>+------------------+<br>| 5 |<br>+------------------+<br>1 row in set (0.00 sec)<br><br>mysql&gt; insert into t2 select null,8,8;<br>Query OK, 1 row affected (0.01 sec)<br>Records: 1 Duplicates: 0 Warnings: 0<br><br>mysql&gt; select last_insert_id();<br>+------------------+<br>| last_insert_id() |<br>+------------------+<br>| 8 |<br>+------------------+<br>1 row in set (0.00 sec)<br><br>mysql&gt; select * from t2;<br>+----+------+------+<br>| id | c | d |<br>+----+------+------+<br>| 5 | 1 | NULL |<br>| 6 | 6 | 6 |<br>| 7 | 7 | 7 |<br>| 8 | 8 | 8 |<br>+----+------+------+<br>4 rows in set (0.00 sec)<br>mysql&gt; select last_insert_id(); æ­¤å¤„çš„è‡ªå¢ID æ˜¯å¦ç†è§£ä¸º æœ€è¿‘ä¸€æ¬¡çš„ insert æ“ä½œçš„ è·å–çš„ID<br>+------------------+<br>| last_insert_id() |<br>+------------------+<br>| 8 |<br>+------------------+<br>1 row in set (0.00 sec)<br>ä¸Šé¢çš„ ID ä¸é‚£ä¸ªè¡¨æ²¡æœ‰å…³ç³», è‡³äºå½“å‰session insert æœ€æ–°ä¸€æ¬¡è®°å½•ä¸ºå‡† <br>mysql&gt; select last_insert_id();<br>|                8 |<br>+------------------+<br>1 row in set (0.00 sec)<br>mysql&gt; insert into t2 select 19,19,19;<br>mysql&gt; select last_insert_id();<br>+------------------+<br>| last_insert_id() |<br>+------------------+<br>|                8 |<br>+------------------+<br>1 row in set (0.00 sec)<br>mysql&gt; insert into t2 select null,20,20;<br>Query OK, 1 row affected (0.01 sec)<br>Records: 1  Duplicates: 0  Warnings: 0<br><br>mysql&gt; select last_insert_id();<br>+------------------+<br>| last_insert_id() |<br>+------------------+<br>|               20 |<br>+------------------+<br>ID é™¤éä¸ºç©ºçš„æ—¶å€™ æ‰èƒ½è·å–åˆ°æ–°çš„last_insert_id","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"æ—æ™“æ–Œ","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438997,"discussion_content":"å¾ˆå¥½çš„éªŒè¯ğŸ‘\nä½ å†è¯•è¯•ä¸€ä¸ªinsertæ’å…¥å¤šè¡Œçš„ä¾‹å­ï¼Œå°±å®Œæ•´äº†ğŸ˜†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550111526,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":66972,"user_name":"éƒ­çƒŠåƒçº","can_delete":false,"product_type":"c1","uid":1302416,"ip_address":"","ucode":"15736D91964DA3","user_header":"https://static001.geekbang.org/account/avatar/00/13/df/90/68408c1b.jpg","comment_is_top":false,"comment_ctime":1550050019,"is_pvip":false,"replies":[{"id":"25098","content":"ç¡®å®ä¸å‡† ğŸ˜…<br>ä¸€èˆ¬å¾ˆå°‘æœ‰å‚è€ƒè¿™ä¸‰ä¸ªå€¼çš„é€»è¾‘","user_name":"ä½œè€…å›å¤","user_name_real":"æ—æ™“æ–Œ","uid":"1264162","ctime":1551081201,"ip_address":"","comment_id":66972,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5845017315","product_id":100020801,"comment_content":"æœ‰ä¸ªé—®é¢˜æƒ³è¯·æ•™ä¸‹å¤§ç¥  information_schema.tables  è¡¨é‡Œçš„è¿™ä¸‰ä¸ªå­—æ®µdata_length  data_free  index_lengthçš„å€¼å‡†ç¡®å—ï¼Œmysqlå†…éƒ¨æ˜¯æ€ä¹ˆè®¡ç®—æ¯ä¸ªè¡¨çš„è¿™ä¸ªä¸‰ä¸ªå€¼çš„ï¼Ÿåœ¨æ²¡æœ‰ç¢ç‰‡çš„æƒ…å†µä¸‹ï¼Œå®è·µä¸Šç”¨du å‘½ä»¤ç»Ÿè®¡çš„ibdçš„å¤§å°å’Œè¿™å‡ ä¸ªå­—æ®µçš„å€¼æ„Ÿè§‰å·®åˆ«å¾ˆå¤§ï¼Œæ‰€ä»¥å¾ˆæƒ³çŸ¥é“è¿™å‡ ä¸ªå­—æ®µçš„å€¼å¾—å‡†ç¡®åº¦å¦‚ä½•ï¼Œè¿˜æ˜¯ä»…ä¾›å‚è€ƒï¼Œå› ä¸ºå®è·µä¸­å¯èƒ½éœ€è¦çŸ¥é“æ˜¯å¦æœ‰ç¢ç‰‡ï¼Œå¦‚æœdate_freeå€¼ä¸å‡†ç¡®ï¼Œè€Œç›²ç›®çš„alter tableä¸€ä¸‹ï¼Œè¡¨å¤§çš„è¯ä»£ä»·å¾ˆé«˜å•Š æ±‚å›ç­”å•Š æ„Ÿè§‰è¿™ä¹Ÿæ˜¯å¾ˆå¤šdbaå…³å¿ƒçš„ä¸€ä¸ªé—®é¢˜","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"æ—æ™“æ–Œ","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438996,"discussion_content":"ç¡®å®ä¸å‡† ğŸ˜…\nä¸€èˆ¬å¾ˆå°‘æœ‰å‚è€ƒè¿™ä¸‰ä¸ªå€¼çš„é€»è¾‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551081201,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":360241,"user_name":"Mangoå›ğŸ˜Š","can_delete":false,"product_type":"c1","uid":1114643,"ip_address":"å¹¿ä¸œ","ucode":"FD47F4A4F2329A","user_header":"https://static001.geekbang.org/account/avatar/00/11/02/13/78a2cbf4.jpg","comment_is_top":false,"comment_ctime":1666333884,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1666333884","product_id":100020801,"comment_content":"è€å¸ˆï¼Œinsert å”¯ä¸€é”®å†²çªçš„ä¾‹å­ä¸­ï¼Œç¬¬ä¸€ä¸ªäº‹åŠ¡æŠŠ rollback æ”¹æˆ commit åï¼Œä¸ºä»€ä¹ˆä¸ä¼šæ­»é”å‘¢","like_count":0},{"had_liked":false,"id":359714,"user_name":"Geek_f265e1","can_delete":false,"product_type":"c1","uid":2319817,"ip_address":"å››å·","ucode":"3CD7E3A8347702","user_header":"","comment_is_top":false,"comment_ctime":1665801169,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1665801169","product_id":100020801,"comment_content":"æä¸ªé—®é¢˜ï¼Œåœ¨dmlä¸­å¦‚æœæŸ¥æ‰¾æ•°æ®ä½¿ç”¨çš„äºŒçº§ç´¢å¼•ï¼Œé‚£ä¹ˆä¸ç®¡è¿™ä¸ªäºŒçº§ç´¢å¼•çš„æ•°æ®æ˜¯å¦ä¼šæ›´æ–°ï¼Œéƒ½ä¼šåŠ ä¸€ä¸ªxé”ã€‚è¿™é‡Œæ˜¯å‡ºäºä»€ä¹ˆè€ƒé‡è¦ç»™ä»–åŠ ä¸€ä¸ªxé”è€Œä¸æ˜¯sé”å‘¢ï¼Ÿ","like_count":0},{"had_liked":false,"id":358423,"user_name":".","can_delete":false,"product_type":"c1","uid":3189388,"ip_address":"æ¹–åŒ—","ucode":"66FAAB07BD7B17","user_header":"https://static001.geekbang.org/account/avatar/00/30/aa/8c/eaa0f576.jpg","comment_is_top":false,"comment_ctime":1664286589,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1664286589","product_id":100020801,"comment_content":"Cæ˜¯å”¯ä¸€ç´¢å¼•ï¼Œä¸ºä»€ä¹ˆsessionAæŒæœ‰çš„ä¸æ˜¯è¡Œé”10è€Œæ˜¯(5,10]?ä¸åº”è¯¥é€€åŒ–å—ï¼Ÿ","like_count":0},{"had_liked":false,"id":356543,"user_name":"Geek_323a60","can_delete":false,"product_type":"c1","uid":2797976,"ip_address":"å››å·","ucode":"CDC276EC255411","user_header":"","comment_is_top":false,"comment_ctime":1662389217,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1662389217","product_id":100020801,"comment_content":"<br>insert into t(c,d)  (select c+1, d from t force index(c) order by c desc limit 1); çš„åˆ†æä¸­ä» t ä¸­è¯»å–å…¨éƒ¨çš„æ•°æ®ï¼ˆä¸€å…± 4 è¡Œï¼‰å»ºç«‹ä¸´æ—¶è¡¨ã€‚åœ¨æ‰§è¡Œ limit 1 æ—¶åˆè¯»å–äº†ä¸€è¡Œï¼Œä¸ºä»€ä¹ˆ innodb_rows_read çš„å€¼åªå¢åŠ äº† 4 è€Œä¸æ˜¯ 5 å‘¢ï¼Ÿ","like_count":0},{"had_liked":false,"id":354329,"user_name":"fourge","can_delete":false,"product_type":"c1","uid":1015184,"ip_address":"å¹¿ä¸œ","ucode":"F3E3FFC4990358","user_header":"https://static001.geekbang.org/account/avatar/00/0f/7d/90/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1660285427,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1660285427","product_id":100020801,"comment_content":"åŸæ¥è¿˜æœ‰è¿™ä¹ˆå¤šçš„é—¨é“ï¼","like_count":0},{"had_liked":false,"id":352845,"user_name":"è‘£æ²›éœ–","can_delete":false,"product_type":"c1","uid":1460229,"ip_address":"é™•è¥¿","ucode":"D223C52555C57F","user_header":"https://static001.geekbang.org/account/avatar/00/16/48/05/2ef4b9fb.jpg","comment_is_top":false,"comment_ctime":1658979002,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1658979002","product_id":100020801,"comment_content":"å“¦ä¸å¯¹ï¼Œæˆ‘è‡ªå·±ç†è§£é”™äº†å“ˆå“ˆï¼Œæ‰“æ‰°äº†","like_count":0},{"had_liked":false,"id":352839,"user_name":"è‘£æ²›éœ–","can_delete":false,"product_type":"c1","uid":1460229,"ip_address":"","ucode":"D223C52555C57F","user_header":"https://static001.geekbang.org/account/avatar/00/16/48/05/2ef4b9fb.jpg","comment_is_top":false,"comment_ctime":1658977820,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1658977820","product_id":100020801,"comment_content":"è€å¸ˆæ‚¨å¥½ï¼Œæˆ‘è§‰å¾— &quot;insert å”¯ä¸€é”®å†²çª çš„å›¾6ä¸­çš„ä¾‹å­&quot; å¥½åƒä¸å¤ªå¯¹ï¼Œsession B çš„é”ç­‰å¾…ä¼¼ä¹ä¸æ˜¯ç”± session A åŠ åœ¨ index c ä¸Šçš„ next-key é”å¯¼è‡´çš„ï¼Œè€Œæ˜¯ç”± session A åŠ åœ¨ primary key ä¸Šçš„ X é”ï¼ˆsupremum pseudo-recordï¼‰å¯¼è‡´çš„ã€‚<br>è™½ç„¶æˆ‘æµ‹è¯•ä¹Ÿå¾—å‡ºäº† &quot;ä¸¤ç±»ç´¢å¼•å†²çªåŠ çš„éƒ½æ˜¯ next-key lock&quot; è¿™ä¸€ç»“è®ºï¼Œä½†åœ¨ session A æ‰§è¡Œ &quot;insert into t values(10,10,10);&quot; åå†æ‰§è¡Œä¸€ä¸ª &quot;insert into t values(13,13,13);&quot; å¯èƒ½æ›´ä¸¥è°¨ä¸€äº›ã€‚","like_count":0},{"had_liked":false,"id":348643,"user_name":"ææ³°æ±›","can_delete":false,"product_type":"c1","uid":1880234,"ip_address":"","ucode":"379E06A90A30D9","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erZxgDrR65vd6wo2ibFQM3r0IdqlY0sG0ZOJAnMuhjVfJmib4ib3dbNlnz0MH4YmjV9ajQ6IXXiaVYRlg/132","comment_is_top":false,"comment_ctime":1655276095,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1655276095","product_id":100020801,"comment_content":"æ‰“æ‰°ä¸€ä¸‹ï¼Œè€å¸ˆï¼ŒInsert select é‚£ä¸ªä¾‹å­ï¼ŒåŠ çš„åº”è¯¥ä¸æ˜¯ Next-key lock å§ï¼Œè€Œæ˜¯å•çº¯çš„ gap lock (-âˆ, 1) ã€‚å› ä¸ºè¡¨ä¸­éƒ½è¿˜æ²¡æœ‰è®°å½•ï¼Œä½•æ¥ Next-key lock ã€‚","like_count":0},{"had_liked":false,"id":345331,"user_name":"å¹¼ç¨šå›­çš„å°æœ‹å‹","can_delete":false,"product_type":"c1","uid":2725596,"ip_address":"","ucode":"EF63C355BD58A7","user_header":"https://static001.geekbang.org/account/avatar/00/29/96/dc/8adf8971.jpg","comment_is_top":false,"comment_ctime":1652194127,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1652194127","product_id":100020801,"comment_content":"*** (1) TRANSACTION:<br><br>äº‹åŠ¡ç¼–å· 835455303 æ´»è·ƒ1s <br>TRANSACTION 835455303, ACTIVE 1 sec inserting<br>mysql tables in use 1, locked 1<br>LOCK WAIT 2 lock struct(s), heap size 1136, 1 row lock(s), undo log entries 1<br>MySQL thread id 4757995, OS thread handle 140065991382784, query id 6012480542 10.5.144.251 sp_center_user update<br>INSERT INTO t_bill_product_sp_0353 (bill_code, product_code, product_version, forecast_disp_site_code, sign_site_code , flow, template_code, service_point_code, status, version) VALUE<br>S (&#39;782624393196770&#39;, &#39;PRO_PDD_CALL&#39;, &#39;8&#39;, &#39;41210&#39;, &#39;30074&#39; , &#39;SIGN&#39;, &#39;PO-h201txin&#39;, &#39;SER_SIGN_CALL&#39;, 0, 1)<br>*** (1) WAITING FOR THIS LOCK TO BE GRANTED:<br>RECORD LOCKS space id 382 page no 6507 n bits 208 index uk_bill_flow_code of table `sp_center_00`.`t_bill_product_sp_0353` trx id 835455303 lock mode S waiting<br>Record lock, heap no 141 PHYSICAL RECORD: n_fields 5; compact format; info bits 0<br> 0: len 14; hex 3738323637353933313936373730; asc 78267593196770;;<br> 1: len 4; hex 5349474e; asc SIGN;;<br> 2: len 11; hex 504f2d683230317478696e; asc PO-h201txin;;<br> 3: len 13; hex 5345525f5349474e5f43414c4c; asc SER_SIGN_CALL;;<br> 4: len 8; hex 000000000003e531; asc        1;;","like_count":0},{"had_liked":false,"id":345330,"user_name":"å¹¼ç¨šå›­çš„å°æœ‹å‹","can_delete":false,"product_type":"c1","uid":2725596,"ip_address":"","ucode":"EF63C355BD58A7","user_header":"https://static001.geekbang.org/account/avatar/00/29/96/dc/8adf8971.jpg","comment_is_top":false,"comment_ctime":1652194114,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1652194114","product_id":100020801,"comment_content":"<br>è€å¸ˆ æƒ³è¯·é—®ä¸‹ è¿™ä¸ªæ­»é”è¯¥æ€ä¹ˆåˆ†æå‘¢ ç¯å¢ƒæ˜¯rc ä¸ºä»€ä¹ˆäº‹åŠ¡2ä¼šæŒæœ‰ä¸€æŠŠä¸æ˜¯è‡ªå·±è¦æ’å…¥çš„è®°å½•çš„è®°å½•é”å‘¢*** (2) TRANSACTION:<br>TRANSACTION 835455263, ACTIVE 2 sec inserting<br>mysql tables in use 1, locked 1<br>3 lock struct(s), heap size 1136, 2 row lock(s), undo log entries 3<br>MySQL thread id 4764977, OS thread handle 140065988409088, query id 6012481814 10.5.144.218 sp_center_user update<br>INSERT INTO t_bill_product_sp_0353 (bill_code, product_code, product_version, forecast_disp_site_code, sign_site_code , flow, template_code, service_point_code, status, version) VALUE<br>S (&#39;782624393196770&#39;, &#39;PRO_PDD_CALL&#39;, &#39;8&#39;, &#39;41210&#39;, &#39;30074&#39; , &#39;DISPATCH&#39;, &#39;PO-skldaFsd32&#39;, &#39;SER_SIGN_CALL_PDD&#39;, 0, 1)<br><br><br>&#47;&#47; locks rec but not gap è®°å½•é”  lock_mode X next-keyé”  locks gap before rec é—´éš™é” locks gap before rec insert intention æ’å…¥æ„å‘é”<br>&#47;&#47; é—´éš™é”<br>*** (2) HOLDS THE LOCK(S):<br>RECORD LOCKS space id 382 page no 6507 n bits 208 index uk_bill_flow_code of table `sp_center_00`.`t_bill_product_sp_0353` trx id 835455263 lock_mode X locks rec but not gap<br>Record lock, heap no 141 PHYSICAL RECORD: n_fields 5; compact format; info bits 0<br> 0: len 14; hex 3738323637353933313936373730; asc 78267593196770;;<br> 1: len 4; hex 5349474e; asc SIGN;;<br> 2: len 11; hex 504f2d683230317478696e; asc PO-h201txin;;<br> 3: len 13; hex 5345525f5349474e5f43414c4c; asc SER_SIGN_CALL;;<br> 4: len 8; hex 000000000003e531; asc        1;;<br><br>*** (2) WAITING FOR THIS LOCK TO BE GRANTED:<br>RECORD LOCKS space id 382 page no 6507 n bits 208 index uk_bill_flow_code of table `sp_center_00`.`t_bill_product_sp_0353` trx id 835455263 lock_mode X locks gap before rec insert intention waiting<br>Record lock, heap no 141 PHYSICAL RECORD: n_fields 5; compact format; info bits 0<br> 0: len 14; hex 3738323637353933313936373730; asc 78267593196770;;<br> 1: len 4; hex 5349474e; asc SIGN;;<br> 2: len 11; hex 504f2d683230317478696e; asc PO-h201txin;;<br> 3: len 13; hex 5345525f5349474e5f43414c4c; asc SER_SIGN_CALL;;<br><br>å¤ªé•¿äº† è€å¸ˆ æˆ‘åˆ†ä¸ºä¸¤ä¸ª","like_count":0},{"had_liked":false,"id":342105,"user_name":"Niverkk","can_delete":false,"product_type":"c1","uid":2179875,"ip_address":"","ucode":"F9220C10107E44","user_header":"https://static001.geekbang.org/account/avatar/00/21/43/23/d98fb8f7.jpg","comment_is_top":false,"comment_ctime":1650015182,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1650015182","product_id":100020801,"comment_content":"è€å¸ˆï¼Œé’ˆå¯¹å›¾1æƒ…å†µ å…¶å®ç›¸å½“äºé”è¡¨äº†å§ï¼Ÿ","like_count":0},{"had_liked":false,"id":337970,"user_name":"Curiosity","can_delete":false,"product_type":"c1","uid":1879290,"ip_address":"","ucode":"A6732CAE6CBE8E","user_header":"https://static001.geekbang.org/account/avatar/00/1c/ac/fa/a32099e7.jpg","comment_is_top":false,"comment_ctime":1647188999,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1647188999","product_id":100020801,"comment_content":"æ­»é”çš„ä¾‹å­ï¼Œæœ‰äº›ä¸æ˜ç™½ï¼Œåˆ°åº•æ˜¯å…ˆåŠ çš„è¯»é”ï¼Œè¿˜æ˜¯å…ˆåŠ çš„æ„å‘é”ï¼Œinsertè¯­å¥åœ¨æ’å…¥ä¹‹å‰éœ€è¦å…ˆè¯»åˆ¤æ–­ï¼Œé‚£ä¹ˆè¿™ä¸ªå…ˆè¯»åˆ¤æ–­åŠ çš„æ˜¯ä»€ä¹ˆé”å‘¢ï¼Œæ¡ˆä¾‹æ˜¯åœ¨è¿™ä¸ªå…ˆè¯»åˆ¤æ–­çš„ä½ç½®é”ä½çš„ä¹ˆï¼Œè¯„è®ºä¸­æœ‰æåˆ°æ„å‘é”ï¼Œè¿™ä¸ªæ„å‘é”åˆæ˜¯ä»€ä¹ˆï¼Œå®Œå…¨ä¸æ‡‚å‘€","like_count":0},{"had_liked":false,"id":336175,"user_name":"Geek_fb333","can_delete":false,"product_type":"c1","uid":2011553,"ip_address":"","ucode":"F0904774D027A3","user_header":"https://static001.geekbang.org/account/avatar/00/1e/b1/a1/b1fd3903.jpg","comment_is_top":false,"comment_ctime":1645970440,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1645970440","product_id":100020801,"comment_content":"<br>create temporary table temp_t(c int,d int) engine=memory;<br>insert into temp_t  (select c+1, d from t force index(c) order by c desc limit 1);<br>insert into t select * from temp_t;<br>drop table temp_t;<br><br>ç”¨RRéš”ç¦»çº§åˆ« åŠ for update æˆ–è€…Serializable éš”ç¦»çº§åˆ« å°±ä¸ä¼šåˆ›å»ºä¸´æ—¶è¡¨äº†ï¼Œ","like_count":0},{"had_liked":false,"id":323289,"user_name":"Kaine","can_delete":false,"product_type":"c1","uid":2799936,"ip_address":"","ucode":"970FBF356F3F59","user_header":"https://static001.geekbang.org/account/avatar/00/2a/b9/40/e350862c.jpg","comment_is_top":false,"comment_ctime":1637821223,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1637821223","product_id":100020801,"comment_content":"è€å¸ˆæ‚¨å¥½ï¼Œåœ¨å›¾6çš„ä¾‹å­ä¸­ï¼Œmysqlç‰ˆæœ¬8.0.21ï¼ŒsessionBæ‰§è¡Œçš„è¯­å¥ä¸ä¼šè¢«é˜»å¡ã€‚<br>æˆ‘æŸ¥çœ‹äº†èµ„æ–™æ˜¯8.0.21è§£å†³äº†å”¯ä¸€ç´¢å¼•é—´éš™é”çš„bugã€‚<br>è¿™é‡Œæ˜¯mysqlå°†next-key lock é—´éš™é”é€€åŒ–æˆäº†è¡Œé”äº†å—ï¼Ÿ","like_count":0},{"had_liked":false,"id":322538,"user_name":"K","can_delete":false,"product_type":"c1","uid":1151163,"ip_address":"","ucode":"0ED6CDDE3A8F5C","user_header":"https://static001.geekbang.org/account/avatar/00/11/90/bb/61dfc022.jpg","comment_is_top":false,"comment_ctime":1637474023,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1637474023","product_id":100020801,"comment_content":"è€å¸ˆï¼Œè¯·æ•™ä¸‹innodbçš„change buffer å’ŒLog buffer åŒºåˆ«ï¼Œå½“æœ‰ä¸€æ¡insert è¯­å¥ï¼Œinsertçš„æ•°æ®æ˜¯å…ˆæ”¾åœ¨change bufferï¼Œç„¶åå†æ”¾å…¥Log buffer å—","like_count":0},{"had_liked":false,"id":302883,"user_name":"muse","can_delete":false,"product_type":"c1","uid":2365071,"ip_address":"","ucode":"43B0C82639E39F","user_header":"https://static001.geekbang.org/account/avatar/00/24/16/8f/c1baee96.jpg","comment_is_top":false,"comment_ctime":1626421908,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1626421908","product_id":100020801,"comment_content":"æ’å…¥æ„å‘é”ä¸æ˜¯gapé”çš„è¯æ˜¯ä»€ä¹ˆå‘¢","like_count":0},{"had_liked":false,"id":283368,"user_name":"kiplove","can_delete":false,"product_type":"c1","uid":1143832,"ip_address":"","ucode":"50F038D52F015D","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83ep0RT83ws2ELSs4vmzPv2fr2d5WE0T7CuGfp7HtcHXuiaQUwXNLLsRzkYCPYicI2CyuQPSdbfxaYExA/132","comment_is_top":false,"comment_ctime":1615730527,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1615730527","product_id":100020801,"comment_content":"è€å¸ˆï¼Œæˆ‘è¯•äº†ä¸€ä¸‹INSERT INTO t(c,d) (SELECT c+1, d FROM t FORCE INDEX(c) ORDER BY c DESC LIMIT 1); å…¶ä»–äº‹åŠ¡è¿˜æ˜¯èƒ½åœ¨è¿™ä¸ªè¡¨ä¸Šæ’å…¥æ•°æ®ï¼Œè€Œä¸”æ‰§è¡Œå‰åSHOW STATUS LIKE &#39;%Innodb_rows_read%&#39;ï¼Œå˜åŒ–åªæœ‰ä¸€è¡Œã€‚è¿™ä¸ªç‰ˆæœ¬8.0.13","like_count":0},{"had_liked":false,"id":276832,"user_name":"Geek1560","can_delete":false,"product_type":"c1","uid":2028949,"ip_address":"","ucode":"5F27A28B8002E6","user_header":"https://static001.geekbang.org/account/avatar/00/1e/f5/95/a362f01b.jpg","comment_is_top":false,"comment_ctime":1612148639,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1612148639","product_id":100020801,"comment_content":"è€å¸ˆæˆ‘æƒ³å’¨è¯¢ä¸‹ï¼Œå¯¹äºè”åˆå”¯ä¸€ç´¢å¼•ï¼Œåœ¨insertçš„æ—¶å€™éƒ½ä¼šåŠ ä»€ä¹ˆé”ã€‚","like_count":0},{"had_liked":false,"id":273409,"user_name":"å°˜","can_delete":false,"product_type":"c1","uid":1244251,"ip_address":"","ucode":"2C71FBCED5BFE6","user_header":"https://static001.geekbang.org/account/avatar/00/12/fc/5b/caa6a2a6.jpg","comment_is_top":false,"comment_ctime":1610589906,"is_pvip":false,"discussion_count":0,"race_medal":1,"score":"1610589906","product_id":100020801,"comment_content":"æ‰§è¡Œinsert into t2(c,d) select c,d from tæ—¶ï¼Œä¸ºä»€ä¹ˆå¯¹è¡¨tä¸»é”®åŠ é”çš„èŒƒå›´æ˜¯(-âˆ,1]ï¼Œè€Œä¸æ˜¯(-âˆ,å½“å‰ä¸»é”®çš„æœ€å¤§å€¼]ï¼Ÿ","like_count":0},{"had_liked":false,"id":268489,"user_name":"Edison","can_delete":false,"product_type":"c1","uid":1135701,"ip_address":"","ucode":"734A561F363720","user_header":"https://static001.geekbang.org/account/avatar/00/11/54/55/613ddc42.jpg","comment_is_top":false,"comment_ctime":1608215627,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1608215627","product_id":100020801,"comment_content":"è€å¸ˆï¼Œæˆ‘æƒ³é—®ä¸€ä¸‹ï¼Œå‡å¦‚æˆ‘ä»¬ä¸€æ¬¡æ€§è¦å‘æ•°æ®åº“ä¸­æ’å…¥å‡ åƒæ¡æ•°æ®ï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆä¼˜åŒ–çš„æ–¹æ³•ï¼Ÿæé«˜é€Ÿåº¦","like_count":0},{"had_liked":false,"id":259051,"user_name":"å‡ºå–çµé­‚çš„æ•™ç»ƒKerry","can_delete":false,"product_type":"c1","uid":1807943,"ip_address":"","ucode":"8C64517DA556FE","user_header":"https://static001.geekbang.org/account/avatar/00/1b/96/47/93838ff7.jpg","comment_is_top":false,"comment_ctime":1604623915,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1604623915","product_id":100020801,"comment_content":"è€å¸ˆä½ å¥½ï¼Œä¸ºä»€ä¹ˆæ’å…¥tå’Œt2æ‰«ææ¬¡æ•°ä¸åŒå‘¢ï¼Ÿè¿˜æ˜¯çŠ¯ç³Šæ¶‚ï¼Ÿ","like_count":0},{"had_liked":false,"id":256842,"user_name":"Young","can_delete":false,"product_type":"c1","uid":1736553,"ip_address":"","ucode":"90422D17DF9C15","user_header":"https://static001.geekbang.org/account/avatar/00/1a/7f/69/f618b7a5.jpg","comment_is_top":false,"comment_ctime":1603764025,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1603764025","product_id":100020801,"comment_content":"è€å¸ˆï¼Œæ¯”å¦‚rpcæ¥å£æˆ‘éœ€è¦è½10000æ¡è®¢å•æ•°æ®ï¼Œè®¢å•æ•°æ‹†åˆ†å¤šå°‘è¿›è¡Œæ‰¹é‡æ’å…¥åˆé€‚å‘¢?","like_count":0},{"had_liked":false,"id":256765,"user_name":"èœ‰è£","can_delete":false,"product_type":"c1","uid":1229070,"ip_address":"","ucode":"77CF92496855D4","user_header":"https://static001.geekbang.org/account/avatar/00/12/c1/0e/2b987d54.jpg","comment_is_top":false,"comment_ctime":1603724675,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1603724675","product_id":100020801,"comment_content":"è€å¸ˆå¥½ï¼Œåœ¨ insert å”¯ä¸€é”®å†²çª å°èŠ‚ä¸­ï¼Œç¬¬ä¸€ä¸ªç¤ºä¾‹ï¼Œåœ¨æˆ‘çš„æœ¬åœ°ç¯å¢ƒä¸Šæ— æ³•å¤ç°ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒsessionB å¯ä»¥ç›´æ¥æ‰§è¡ŒæˆåŠŸï¼Œä¸ä¼šè¢«å µå¡ã€‚æˆ‘çš„ MySQL ç‰ˆæœ¬æ—¶ 5.7.31 ï¼Œäº‹åŠ¡éš”ç¦»çº§åˆ«ä¸º RRã€‚è¯·é—®è¿™ä¸ª bug æ˜¯è¢«ä¿®å¤äº†å—ï¼Ÿ","like_count":0},{"had_liked":false,"id":254627,"user_name":"å¼ å“","can_delete":false,"product_type":"c1","uid":1209049,"ip_address":"","ucode":"AD840AF264C32E","user_header":"https://static001.geekbang.org/account/avatar/00/12/72/d9/488739d1.jpg","comment_is_top":false,"comment_ctime":1603159832,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1603159832","product_id":100020801,"comment_content":"insert å”¯ä¸€é”®å†²çªé€ æˆçš„æ­»é”åœ¨MySQL8.0.21ä¸­å·²ç»å¤ç°ä¸å‡ºæ¥äº†","like_count":0},{"had_liked":false,"id":243395,"user_name":"mgs2002","can_delete":false,"product_type":"c1","uid":1812970,"ip_address":"","ucode":"F5931108BD509B","user_header":"https://static001.geekbang.org/account/avatar/00/1b/a9/ea/5bfce6c5.jpg","comment_is_top":false,"comment_ctime":1598086100,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1598086100","product_id":100020801,"comment_content":"è¡¨æ‹·è´æˆ‘è¿™è¾¹å¸¸ç”¨çš„æ–¹æ³•è¿˜æ˜¯insert....selectï¼Œå¦‚æœè¡¨çš„æ•°æ®ç‰¹åˆ«å¤§ä½¿ç”¨ç¨‹åºæ¥æ§åˆ¶æ¯æ¬¡æ’å…¥çš„æ¡æ•°ï¼Œä½¿ç”¨å¤šçº¿ç¨‹çš„æ–¹å¼å°†å¤§è¡¨æ•°æ®åˆ†æˆå‡ å—åˆ†ç‰‡æ’å…¥","like_count":0},{"had_liked":false,"id":208091,"user_name":"Tarn","can_delete":false,"product_type":"c1","uid":1112416,"ip_address":"","ucode":"A2717CB81DF84B","user_header":"https://static001.geekbang.org/account/avatar/00/10/f9/60/8e0f0f17.jpg","comment_is_top":false,"comment_ctime":1587274500,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1587274500","product_id":100020801,"comment_content":"<br>insert into t2(c,d) select c,d from t; è€å¸ˆï¼Œä¸ºå•¥è¿™ä¸ªå­è¯­å¥çš„select c d from tä¼šåŠ next key lockï¼Ÿä¸æ˜¯è¯´ä¹‹åfor updateå’Œlock in share mode æ‰ä¼šåŠ é”å—ï¼Ÿè¿˜æ˜¯å› ä¸ºå­è¯­å¥ä¸­é»˜è®¤å°±åŠ é”å‘€ï¼Ÿ","like_count":0},{"had_liked":false,"id":186856,"user_name":"å¤©äº®å‰è¯´æ™šå®‰","can_delete":false,"product_type":"c1","uid":1541014,"ip_address":"","ucode":"1D82EE562A7C71","user_header":"https://static001.geekbang.org/account/avatar/00/17/83/96/73ff13a0.jpg","comment_is_top":false,"comment_ctime":1583939410,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1583939410","product_id":100020801,"comment_content":"æˆ‘å°±é‡åˆ°æ­»é”é—®é¢˜ï¼Œåœºæ™¯æ˜¯ä¸€ä¸ªè¡¨æœ‰ä¸»é”®idã€å”¯ä¸€ç´¢å¼•å­—æ®µã€å…¶ä»–å­—æ®µcã€‚æˆ‘æƒ³å¯¼å…¥æ•°æ®ï¼Œæ‰€ä»¥å¼€äº†ä¸€ä¸ªçº¿ç¨‹æ± å»åšå¯¼å…¥æ•°æ®çš„æ´»ï¼Œçº¿ç¨‹æ± å¤§å°16ï¼Œæ¯å¯¼å…¥ä¸€æ¡æ•°æ®ï¼Œæˆ‘å°±è¦åˆ¤æ–­è¡¨é‡Œæ˜¯å¦æœ‰å«æœ‰å”¯ä¸€å­—æ®µçš„è®°å½•ï¼Œå¦‚æœæœ‰å°±å…¶ä»–å­—æ®µcåŠ 1ï¼Œå¦åˆ™å°±æ’å…¥ä¸€æ¡æ•°æ®ã€‚æ•°æ®åº“éš”ç¦»çº§åˆ«è¯»å·²æäº¤ï¼Œç‰ˆæœ¬5.7.28ã€‚æ²¡ææ˜ç™½æ€ä¹ˆå›äº‹ï¼Œæ±‚è§£ç­”ã€‚","like_count":0},{"had_liked":false,"id":148218,"user_name":"Icy:S LYZ","can_delete":false,"product_type":"c1","uid":1683788,"ip_address":"","ucode":"73C983E11A43C2","user_header":"https://static001.geekbang.org/account/avatar/00/19/b1/4c/9f06f199.jpg","comment_is_top":false,"comment_ctime":1572959952,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1572959952","product_id":100020801,"comment_content":"è€å¸ˆï¼Œè¯·æ•™ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœå”¯ä¸€ç´¢å¼•æ˜¯varcharå‘¢ï¼Ÿä¼šæ€ä¹ˆåŠ é”ï¼Ÿ","like_count":0},{"had_liked":false,"id":139611,"user_name":"mid_kingking","can_delete":false,"product_type":"c1","uid":1634591,"ip_address":"","ucode":"C46A173765C5D2","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIO8fTPkx9hWIcK25lnRr2KG5BMR1ENvPEqEMGkiaUeiaKScOlClgqicGXFh0wC2z798CYwWicxUIyyKw/132","comment_is_top":false,"comment_ctime":1570690268,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1570690268","product_id":100020801,"comment_content":"æƒ³é—®ä¸€ä¸‹è€å¸ˆï¼Œä¸ºä½•ä¾‹å­insert å”¯ä¸€é”®å†²çªä¸­çš„é—´éš™é”æ˜¯(5,10]ï¼Œcæ˜¯å”¯ä¸€ç´¢å¼•ï¼Œä¸åº”è¯¥é€€åŒ–ä¸ºè¡Œé”ä¹ˆï¼Œè€Œä¸”cå€¼æ˜¯å®šå€¼10","like_count":0},{"had_liked":false,"id":123092,"user_name":"å¼ å¾·","can_delete":false,"product_type":"c1","uid":1101929,"ip_address":"","ucode":"31FE63E8725EFC","user_header":"https://static001.geekbang.org/account/avatar/00/10/d0/69/5dbdc245.jpg","comment_is_top":false,"comment_ctime":1565603615,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1565603615","product_id":100020801,"comment_content":"æ‹·è´è¡¨   æˆ‘ä¸€èˆ¬æ˜¯è½¬å‚¨æ•´ä¸ªè¡¨çš„SQLæ–‡ä»¶    ç„¶åå¤åˆ¶å‡ºSQLè¯­å¥  ç„¶ååˆ‡æ¢è¡¨å   ç„¶åæ‰§è¡Œ","like_count":0},{"had_liked":false,"id":105560,"user_name":"Jzzw","can_delete":false,"product_type":"c1","uid":1508208,"ip_address":"","ucode":"4B642AADF48BD6","user_header":"https://static001.geekbang.org/account/avatar/00/17/03/70/01dc4853.jpg","comment_is_top":false,"comment_ctime":1561031487,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1561031487","product_id":100020801,"comment_content":"æ­»é”çš„é‚£ä¸ªé—®é¢˜ï¼Œsession bå’Œ session c åº”è¯¥éƒ½æ˜¯åœ¨ç”³è¯·æ„å‘å†™é”å§ï¼Œsession aé‡Šæ”¾æ‰å†™é”åï¼Œsession bå’Œcåº”è¯¥éƒ½å¯ä»¥ç”³è¯·åˆ°æ„å‘å†™é”ï¼Œä½†æ˜¯å› ä¸ºæ„å‘å†™é”å’Œå†™é”ä¹Ÿæ˜¯äº’æ–¥çš„ï¼Œæ‰€ä»¥ä»–ä»¬éƒ½åœ¨ç­‰ç€å¯¹æ–¹æŠŠæ„å‘å†™é”é‡Šæ”¾æ‰ç„¶åè‡ªå·±å¯ä»¥ç”³è¯·å†™é”ï¼Œäºæ˜¯ä¹äº§ç”Ÿäº†æ­»é”","like_count":0},{"had_liked":false,"id":104168,"user_name":"è¯»ä¹¦çœ‹æŠ¥","can_delete":false,"product_type":"c1","uid":1306147,"ip_address":"","ucode":"3B4717314B52A9","user_header":"https://static001.geekbang.org/account/avatar/00/13/ee/23/b92b0811.jpg","comment_is_top":false,"comment_ctime":1560673397,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1560673397","product_id":100020801,"comment_content":"*** (1) TRANSACTION:<br>TRANSACTION 21795520, ACTIVE 21 sec inserting<br>mysql tables in use 1, locked 1<br>LOCK WAIT 7 lock struct(s), heap size 1136, 5 row lock(s), undo log entries 2<br>MySQL thread id 13257, OS thread handle <br>INSERT INTO baq_rygj_sp(id,mid) VALUES (<br>\t\t\t&#39;02911c3db73a4738839f5c06f5ce0c4a&#39;,&#39;099d0b0283ac4e4dad478de8fe5ab128&#39;)<br>*** (1) WAITING FOR THIS LOCK TO BE GRANTED:<br>RECORD LOCKS space id 2790 page no 7997 n bits 120 index PRIMARY of table `baq`.`baq_rygj_sp` trx id 21795520 lock_mode X locks gap before rec insert intention waiting<br>Record lock, heap no 4 PHYSICAL RECORD: n_fields 25; compact format; info bits 0<br> 0: len 30; hex 303239313464353064373862343332386263343338313339643136633038; asc 02914d50d78b4328bc438139d16c08; <br>*** (2) TRANSACTION:<br>TRANSACTION 21795516, ACTIVE 24 sec fetching rows, thread declared inside InnoDB 871<br>mysql tables in use 1, locked 1<br>2834 lock struct(s), heap size 254160, 99649 row lock(s)<br>MySQL thread id 13232, OS thread handle 108936, query id 75199918 IP USER updating<br>delete from baq_rygj_sp where mid=&#39;31a263af486549f89b95e552dcf45ca3&#39;<br>*** (2) HOLDS THE LOCK(S):<br>RECORD LOCKS space id 2790 page no 7997 n bits 120 index PRIMARY of table `baq`.`baq_rygj_sp` trx id 21795516 lock_mode X<br>Record lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0<br> 0: len 8; hex 73757072656d756d; asc supremum;;<br>......çœç•¥<br>Record lock, heap no 4 PHYSICAL RECORD: n_fields 25; compact format; info bits 0<br> 0: len 30; hex 303239313464353064373862343332386263343338313339643136633038; asc 02914d50d78b4328bc438139d16c08; <br>......çœç•¥<br>*** (2) WAITING FOR THIS LOCK TO BE GRANTED:<br>RECORD LOCKS space id 2790 page no 6662 n bits 120 index PRIMARY of table `baq`.`baq_rygj_sp` trx id 21795516 lock_mode X waiting<br>Record lock, heap no 48 PHYSICAL RECORD: n_fields 25; compact format; info bits 0<br> 0: len 30; hex 346163366131663536643236343734336139633935323763626133616163; asc 4ac6a1f56d264743a9c9527cba3aac; <br>*** WE ROLL BACK TRANSACTION (1)","like_count":0},{"had_liked":false,"id":104167,"user_name":"è¯»ä¹¦çœ‹æŠ¥","can_delete":false,"product_type":"c1","uid":1306147,"ip_address":"","ucode":"3B4717314B52A9","user_header":"https://static001.geekbang.org/account/avatar/00/13/ee/23/b92b0811.jpg","comment_is_top":false,"comment_ctime":1560673150,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1560673150","product_id":100020801,"comment_content":"ä¸€æ¡Deleteè¯­å¥ï¼Œç”¨çš„æ¡ä»¶å­—æ®µæ²¡æœ‰åŠ ç´¢å¼•ï¼Œå’ŒInsertè¯­å¥é€ æˆæ­»é”;<br>deleteç”±äºæ¡ä»¶å­—æ®µæ²¡æœ‰å»ºç«‹ç´¢å¼•ï¼Œæ‰€ä»¥ä¼šå¯¹èšç°‡ç´¢å¼•é€æ¡æ‰«æåŠ Next-Key Lock ï¼ŒInsertæ“ä½œæ—¶ä¼šå‘ç°æ’å…¥çš„é—´éš™å­˜åœ¨Gapé”ï¼Œæ‰€ä»¥ä¼šåŠ æ’å…¥æ„å‘é”ï¼Œå¹¶å¤„äºç­‰å¾…çŠ¶æ€ï¼Œå¯æ˜¯æ­»é”æ—¥å¿—æ˜¾ç¤ºdeleteè¯­å¥çš„äº‹åŠ¡ä¹Ÿåœ¨ç­‰å¾…ä¸€ä¸ª Xé”ï¼Œé€ æˆäº†æ­»é”ï¼Œä¸ç†è§£åé¢è¿™æ®µï¼Œæˆ‘è´´ä¸‹æ—¥å¿—ï¼Œéº»çƒ¦è€å¸ˆå¸®å¿™è§£ç­”ä¸‹ç–‘é—®ï¼Ÿ","like_count":0},{"had_liked":false,"id":103706,"user_name":"Tunayoyo","can_delete":false,"product_type":"c1","uid":1447213,"ip_address":"","ucode":"E77AFDE575CE04","user_header":"https://static001.geekbang.org/account/avatar/00/16/15/2d/8447e8c8.jpg","comment_is_top":false,"comment_ctime":1560495457,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1560495457","product_id":100020801,"comment_content":"è€å¸ˆï¼Œinsert into t2(c,d) select c,d from t;è¿™å¥è¯çš„ä¸»é”®ç´¢å¼•åŠ é”èŒƒå›´æ€ä¹ˆæ¥çš„ï¼Ÿ<br>","like_count":0},{"had_liked":false,"id":101055,"user_name":"Leonå»–","can_delete":false,"product_type":"c1","uid":1018550,"ip_address":"","ucode":"3BB340F2C8F00D","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/pftx8PrTibZqu39dxkicUdrXbaMe6v4rcoTzOoF9Z04OibIIDgbpRIrDS9lYBYc97QAscGp77vU6nN5uxRiceRER3Q/132","comment_is_top":false,"comment_ctime":1559706577,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1559706577","product_id":100020801,"comment_content":"ç¢°åˆ°insertçš„æ­»é”é—®é¢˜ï¼Œæƒ³èµ·æ¥å›æ¥çœ‹çœ‹è¯¾ç¨‹ä¸ºä»€ä¹ˆduplicate-keyé”™è¯¯ä¸ºä»€ä¹ˆä¼šé”åŒºé—´ï¼Œçœ‹æ¥è¿™é‡Œä¹Ÿæ— è§£ã€‚<br><br>å›¾7çš„æ­»é”é—®é¢˜ï¼Œä¸€å¼€å§‹rollbackå‰T1,T2åŠ ä¸Šçš„æ˜¯è®°å½•Sé”<br>+-----------------+-------------+-----------+-----------+---------------+------------+------------+-----------+----------+-----------+<br>| lock_id         | lock_trx_id | lock_mode | lock_type | lock_table    | lock_index | lock_space | lock_page | lock_rec | lock_data |<br>+-----------------+-------------+-----------+-----------+---------------+------------+------------+-----------+----------+-----------+<br>| 1429539:155:4:6 | 1429539     | S         | RECORD    | `db80801`.`t` | c          |        155 |         4 |        6 | 5         |<br>| 1429537:155:4:6 | 1429537     | X         | RECORD    | `db80801`.`t` | c          |        155 |         4 |        6 | 5         |<br>| 1429538:155:4:6 | 1429538     | S         | RECORD    | `db80801`.`t` | c          |        155 |         4 |        6 | 5         |<br>+-----------------+-------------+-----------+-----------+---------------+------------+------------+-----------+----------+-----------+<br><br>rollbackåï¼Œè²Œä¼¼Session B, Session Céƒ½æ‹¿åˆ°äº†(4,sup]çš„S Next-key lock<br>*** (2) HOLDS THE LOCK(S):<br>RECORD LOCKS space id 155 page no 4 n bits 72 index c of table `db80801`.`t` trx id 1429539 lock mode S<br>Record lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0<br> 0: len 8; hex 73757072656d756d; asc supremum;;<br><br>ä¸æ˜¯å¾ˆç†è§£ä¸ºä»€ä¹ˆè¦é”ä½(4,sup]è¿™ä¸ªåŒºé—´ï¼Ÿ<br><br>å¦å¤–å¦‚æœæŠŠT3çš„rollbackæ¢æˆdelete from t where where c=5;commit;<br>æ­»é”å°±ä¸ä¼šå‘ç”Ÿã€‚ä¹Ÿæ˜¯æœ‰ç‚¹è´¹è§£","like_count":0},{"had_liked":false,"id":85942,"user_name":"å”¯å¥¹å‘½","can_delete":false,"product_type":"c1","uid":1240398,"ip_address":"","ucode":"8F687E8D306840","user_header":"https://static001.geekbang.org/account/avatar/00/12/ed/4e/ef406442.jpg","comment_is_top":false,"comment_ctime":1555297535,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1555297535","product_id":100020801,"comment_content":"è€å¸ˆä½ å¥½ï¼Œæ­»é”é‚£ä¸ªä¾‹å­<br>ç”±äºsessionAè¿˜æ²¡æœ‰æäº¤ï¼Œè€ŒsessionBç¡®èƒ½å¤Ÿæ£€æµ‹åˆ°å”¯ä¸€é”®å†²çªã€‚æ˜¯å› ä¸ºå½“å‰è¯»å—ï¼Ÿ","like_count":0},{"had_liked":false,"id":85755,"user_name":"å”¯å¥¹å‘½","can_delete":false,"product_type":"c1","uid":1240398,"ip_address":"","ucode":"8F687E8D306840","user_header":"https://static001.geekbang.org/account/avatar/00/12/ed/4e/ef406442.jpg","comment_is_top":false,"comment_ctime":1555223857,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1555223857","product_id":100020801,"comment_content":"è€å¸ˆï¼Œå‘ç°æ–‡ç« ä¸­å¥½åƒå­˜åœ¨é—®é¢˜ï¼Œ<br>å›¾7<br>â€œåœ¨ T2 æ—¶åˆ»ï¼Œsession B è¦æ‰§è¡Œç›¸åŒçš„ insert è¯­å¥ï¼Œå‘ç°äº†å”¯ä¸€é”®å†²çªï¼ŒåŠ ä¸Šè¯»é”ï¼›åŒæ ·åœ°ï¼Œsession C ä¹Ÿåœ¨ç´¢å¼• c ä¸Šï¼Œc=5 è¿™ä¸€ä¸ªè®°å½•ä¸Šï¼ŒåŠ äº†è¯»é”ã€‚â€<br>ç”±äºsession A åœ¨ç´¢å¼•C åŠ äº† c=5çš„è¡Œé”ï¼Œæ‰€ä»¥session Bè¢«å µä½äº†ï¼Œæ­¤æ—¶å¹¶æ²¡æœ‰å‘ç°å”¯ä¸€é”®å†²çªï¼Œä¹Ÿä¸ä¼šåŠ è¡Œé”ï¼ï¼ï¼å› ä¸ºè¯­å¥è¢«å µä½äº†ï¼Œæ ¹æœ¬æ²¡æœ‰æ‰§è¡Œï¼Œå¸Œæœ›è€å¸ˆè§£ç­”<br>","like_count":0},{"had_liked":false,"id":84322,"user_name":"äº®çš„å¤ªé˜³","can_delete":false,"product_type":"c1","uid":1475752,"ip_address":"","ucode":"8BD77740812984","user_header":"https://static001.geekbang.org/account/avatar/00/16/84/a8/b0746eea.jpg","comment_is_top":false,"comment_ctime":1554826712,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1554826712","product_id":100020801,"comment_content":"ç”±äºå®ç°ä¸Šè¿™ä¸ªè¯­å¥æ²¡æœ‰åœ¨å­æŸ¥è¯¢ä¸­å°±ç›´æ¥ä½¿ç”¨ limit 1<br><br>è¿™å¥è¯ä»€ä¹ˆæ„æ€å•Šï¼Œä¸ºä»€ä¹ˆä¼šå…¨è¡¨æ‰«å‘¢ï¼Ÿ","like_count":0},{"had_liked":false,"id":79458,"user_name":"ç€›å¯°æœå¥‡","can_delete":false,"product_type":"c1","uid":1181108,"ip_address":"","ucode":"E6EE9FCC5C264F","user_header":"https://static001.geekbang.org/account/avatar/00/12/05/b4/506c2bb3.jpg","comment_is_top":false,"comment_ctime":1553486138,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1553486138","product_id":100020801,"comment_content":"è€å¸ˆï¼ŒinsertæˆåŠŸåä¼šå¯¹è¯¥è®°å½•åŠ æ’ä»–é”ï¼Œé‚£ä¹ˆä¸»é”®å†²çªçš„æ—¶å€™å…¶ä»–äº‹åŠ¡ç»™è¿™æ¡è®°å½•åŠ è¯»é”ä¸ºä»€ä¹ˆä¼šæˆåŠŸï¼Ÿ  ä¿©é”ä¸æ˜¯ä¸å…¼å®¹å—","like_count":0},{"had_liked":false,"id":77738,"user_name":"Kuzhang","can_delete":false,"product_type":"c1","uid":1305570,"ip_address":"","ucode":"EAC381039D2F91","user_header":"https://static001.geekbang.org/account/avatar/00/13/eb/e2/db65ce49.jpg","comment_is_top":false,"comment_ctime":1552989485,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1552989485","product_id":100020801,"comment_content":"ï¼šï¼‰è¿‡å¹´è½ä¸‹å¤ªå¤šäº†ï¼Œä¸€ç›´åœ¨è¡¥â€¦â€¦<br><br>replace into...é‡å¤ï¼Œåˆ é™¤é‡å¤æ•°æ®ï¼Œinsertæ–°æ•°æ®ï¼›<br>insert...on duplicate key update...é‡å¤ï¼Œupdateï¼›<br><br>æƒ³è¯·é—®ä¸€ä¸‹ï¼Œè¿™ä¸¤è€…æœ‰ä»€ä¹ˆåŒºåˆ«å—ï¼Ÿ<br><br>è®°å¾—updateåŸç†å¥½åƒå°±æ˜¯ delete flag è®°å½•+insert æ–°è®°å½•ï¼Œè¿™æ ·ç®—ä¸‹æ¥ï¼Œè¿™ä¸¤è€…æ˜¯ä¸æ˜¯åŸºæœ¬æ²¡å•¥åŒºåˆ«ï¼Œä¹Ÿå°±è¯­æ³•ä¸åŒè€Œå·²äº†ã€‚ã€‚","like_count":0},{"had_liked":false,"id":77207,"user_name":"ä¼Ÿä»”_Hoo","can_delete":false,"product_type":"c1","uid":1323341,"ip_address":"","ucode":"74945AEE48DD62","user_header":"https://static001.geekbang.org/account/avatar/00/14/31/4d/ea8ac77c.jpg","comment_is_top":false,"comment_ctime":1552886112,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1552886112","product_id":100020801,"comment_content":"è€å¸ˆï¼Œçœ‹åˆ°æ‚¨çš„å›å¤ï¼Œå½“select c+1, d from t force index(c) order by c desc limit 1;è¿™æ¡è¯­å¥å•ç‹¬æ‰§è¡Œæ˜¯ä¼šåœ¨cç´¢å¼•ä¸ŠåŠ (4,sup] è¿™ä¸ªnext key lock, äºæ˜¯æˆ‘è¿›è¡Œäº†å°è¯•<br>sessionA: <br>begin;<br>select c+1, d from t force index(c) order by c desc limit 1;<br>sessionB:<br>insert into t values(5, 5, 5);<br>ç»“æœæ˜¯ï¼ŒsessionBæ’å…¥æˆåŠŸï¼Œæ˜¯ä¸æ˜¯æˆ‘å“ªé‡Œç†è§£é”™äº†ï¼Ÿæˆ‘çš„ç‰ˆæœ¬æ˜¯5.7.23<br>ä½œè€…å›å¤: session Açš„selectè¯­å¥æ²¡æœ‰åŠ  for update æˆ–è€… lock in share mode ?<br><br>è€å¸ˆï¼Œçœ‹åˆ°æ‚¨çš„å›å¤ä¹‹åï¼Œæˆ‘åœ¨session AåŠ äº†lock in share mode, ç„¶ååœ¨sessionBåˆ†åˆ«æ‰§è¡Œ3æ¬¡æ“ä½œï¼š<br>1.insert into t values(5, 5, 5); ç»“æœé”ç­‰å¾…è¶…æ—¶ã€‚<br>2.update t set c=4 where c=4;ä¹Ÿæ˜¯é”ç­‰å¾…è¶…æ—¶ã€‚<br>3.update t set c=2 where c=2;æ‰§è¡ŒæˆåŠŸã€‚<br>ä½†æ˜¯ä¸åŠ lock in share modeçš„è¯ï¼š<br>1.insert into t values(5, 5, 5); æ‰§è¡ŒæˆåŠŸã€‚<br>2.update t set c=4 where c=4;æ‰§è¡ŒæˆåŠŸã€‚<br>3.update t set c=2 where c=2;æ‰§è¡ŒæˆåŠŸã€‚<br>æ‰€ä»¥ç»“è®ºæ˜¯ï¼ŒåŠ äº†lock in share mode,c ç´¢å¼•åŠ é”èŒƒå›´æ˜¯(3,4]ï¼Œ(4, sup]ï¼›ä¸åŠ lock in share modeï¼Œc ç´¢å¼•ä¸åŠ é”ï¼Œè¿™æ ·å¯¹å—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1361746,"avatar":"https://static001.geekbang.org/account/avatar/00/14/c7/52/c5adf218.jpg","nickname":"å–œæ¬¢åœ°çƒçš„é˜¿åŸ¹åŒå­¦","note":"","ucode":"5F97037585F857","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":10166,"discussion_content":"å…„å˜šï¼Œä¸åŠ lock in share modeï¼Œé‚£ä¹ˆselect æŸ¥è¯¢èµ°çš„å°±æ˜¯MVVCå¿«ç…§è¯»ï¼Œä¸ä¼šåŠ é”çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1568269224,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":77100,"user_name":"zhou","can_delete":false,"product_type":"c1","uid":1065310,"ip_address":"","ucode":"E5D21F2A3359CB","user_header":"https://static001.geekbang.org/account/avatar/00/10/41/5e/9d2953a3.jpg","comment_is_top":false,"comment_ctime":1552833659,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1552833659","product_id":100020801,"comment_content":"è€å¸ˆï¼Œè¯·æ•™ä¸€ä¸ªæ­»é”é—®é¢˜ï¼š<br>create table  t (<br>`id` int not null, <br>`c` int , <br>primary key(`id`),<br>unique key `c`(`c`)<br>)engine=innodb default charset=utf8;<br><br>RRéš”ç¦»çº§åˆ«<br><br>insert into t value(1, 1);<br><br>session1:                                     <br>Time1:  begin;<br>Time2: select * from t where c=1 for update;<br>Time3: update t set id=id+1 where c=1;<br>Time4: <br>Time5: select * from where c=1 for update;<br><br>session2:<br>Time1:<br>Time2:<br>Time3:<br>Time4: select * from t where c=1 for update;<br>Time5:<br><br>session2åœ¨session1æ‰§è¡Œå®Œupdateåï¼Œæ‰§è¡Œselect...for updateä¼šç­‰å¾…ã€‚ç„¶åsession1å†æ‰§è¡Œselect...for updateï¼ˆå³Time5æ—¶åˆ»æ‰§è¡Œçš„è¯­å¥ï¼‰åï¼Œsession2è¿”å›Deadlockã€‚<br><br>æˆ‘çš„åˆ†æï¼š<br>session1æ‰§è¡Œç¬¬ä¸€æ¡select...for updateåº”è¯¥ä¼šè·å¾—c=1çš„è®°å½•é”å§ï¼Œç„¶åupdate c=1,å‰é¢å·²æ‹¿åˆ°c=1çš„è®°å½•é”ã€‚<br>æ­¤æ—¶session2æ‰§è¡Œselect...for updateä¹Ÿè¦è·å–c=1çš„è®°å½•é”ï¼Œç­‰å¾…ã€‚<br>æœ€åsession1æ‰§è¡Œselect...for updateï¼Œç”±äºä¹‹å‰å·²ç»è·å–c=1çš„è®°å½•é”ï¼Œå¯ä»¥æ‰§è¡Œã€‚<br><br>ä½†ä¸ºä»€ä¹ˆå®é™…ä¸Šä¼šå‡ºç°æ­»é”ï¼Ÿå‡ºç°æ­»é”å°±æ˜¯å‡ºç°äº†é”ç­‰å¾…é—­ç¯ï¼Œsession2ä¸­çš„select...for updateåº”è¯¥å·²ç»è·å¾—ä¸€ä¸ªæŠŠé”ï¼Œä¸ç„¶ä¸ä¼šå‡ºç°é”ç­‰å¾…é—­ç¯å§ï¼Œæ²¡æƒ³æ˜ç™½è·å¾—äº†ä»€ä¹ˆé”ã€‚<br>","like_count":0},{"had_liked":false,"id":74338,"user_name":"çŒ«å°å¦–çš„å°¾å·´","can_delete":false,"product_type":"c1","uid":1309248,"ip_address":"","ucode":"250777C6DFC468","user_header":"https://static001.geekbang.org/account/avatar/00/13/fa/40/6f4949d3.jpg","comment_is_top":false,"comment_ctime":1552194435,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1552194435","product_id":100020801,"comment_content":"è€å¸ˆï¼Œæˆ‘ä»¬çš„ä¸šåŠ¡ä¸­æœ‰ç”¨åˆ°insert â€¦on duplicate key updateå¯¼è‡´æ­»é”çš„æƒ…å†µï¼Œè¡¨æ˜¯æœ‰å”¯ä¸€ç´¢å¼•ï¼ŒDBAé‚£è¾¹çš„è§£é‡Šæ˜¯æœ‰å”¯ä¸€ç´¢å¼•çš„insertéœ€è¦ä¸¤æŠŠé”ï¼Œäº‹åŠ¡1å…ˆç”³è¯·Xé”æˆåŠŸ, ç„¶åç”³è¯·Sé”, ä½†æ˜¯äº‹åŠ¡2æ­£åœ¨ç”³è¯·Xé”, ä¸äº‹åŠ¡1çš„Sé”å†²çª, ç³»ç»Ÿå†³å®šå›æ»šäº‹åŠ¡2ï¼Œç„¶åæˆ‘å°±æ”¹æˆå…ˆæŸ¥è¯¢å­˜åœ¨ç›´æ¥updateä¸å­˜åœ¨å†ç”¨åŸæ¥çš„é€»è¾‘ï¼Œä¸è¿‡æˆ‘æ„Ÿè§‰è¿˜æ˜¯ä¸å¤ªæ˜ç™½ï¼Œä½ å¯ä»¥è§£é‡Šä¸€ä¸‹å—<br>","like_count":0},{"had_liked":false,"id":70118,"user_name":"æ»”æ»”","can_delete":false,"product_type":"c1","uid":1303342,"ip_address":"","ucode":"6968B5771AF79D","user_header":"https://static001.geekbang.org/account/avatar/00/13/e3/2e/77ad18f4.jpg","comment_is_top":false,"comment_ctime":1551000534,"is_pvip":false,"replies":[{"id":"25018","content":"(4,sup]<br><br>ä»¥é˜²ä¼˜åŒ–å™¨ä¸èµ°ç´¢å¼•ï¼Œå½±å“æˆ‘ä»¬ç»“è®ºï¼ˆæ¯”å¦‚æ•°æ®é‡æ¯”è¾ƒå°çš„æ—¶å€™ï¼‰","user_name":"ä½œè€…å›å¤","user_name_real":"æ—æ™“æ–Œ","uid":"1264162","ctime":1551050488,"ip_address":"","comment_id":70118,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1551000534","product_id":100020801,"comment_content":"è€å¸ˆï¼Œselect c+1, d from t force index(c) order by c desc limit 1;è¿™æ¡è¯­å¥å¦‚æœå•ç‹¬æ‰§è¡Œï¼Œæ˜¯ä¼šå¯¹è¡¨tè¿›è¡Œå…¨è¡¨åŠ é”ï¼Œè¿˜æ˜¯åªåŠ (3,4],(4,sup]è¿™ä¸¤ä¸ªnext keyé”ã€‚è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œè¿™é‡Œä¸ºä»€ä¹ˆè¦åŠ force index(c)ï¼Œä¸åŠ ä¼šæ˜¯æ€æ ·çš„æ•ˆæœå‘¢ï¼ŸğŸ¤”","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"æ—æ™“æ–Œ","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440447,"discussion_content":"(4,sup]\n\nä»¥é˜²ä¼˜åŒ–å™¨ä¸èµ°ç´¢å¼•ï¼Œå½±å“æˆ‘ä»¬ç»“è®ºï¼ˆæ¯”å¦‚æ•°æ®é‡æ¯”è¾ƒå°çš„æ—¶å€™ï¼‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551050488,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":67339,"user_name":"cyberbit","can_delete":false,"product_type":"c1","uid":1303197,"ip_address":"","ucode":"1BD53A25F5277F","user_header":"https://static001.geekbang.org/account/avatar/00/13/e2/9d/fbbd4611.jpg","comment_is_top":false,"comment_ctime":1550132259,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1550132259","product_id":100020801,"comment_content":"åœ¨è¡¨ä»¶è¿ç§»æ‹·è´æ•°æ®ï¼Œç”¨çš„pt-archiverå·¥å…·åšçš„ï¼Œä½†æ˜¯å®ƒä¸æ”¯æŒutf8mb4å­—ç¬¦é›†ï¼Œè¿™ä¸ªé—®é¢˜ä¸€ç›´å›°æ‰°æˆ‘ï¼Œä¸çŸ¥é“æ€ä¹ˆè§£å†³ã€‚","like_count":0},{"had_liked":false,"id":67009,"user_name":"å¤œç©ºä¸­æœ€äº®çš„æ˜Ÿ","can_delete":false,"product_type":"c1","uid":1267566,"ip_address":"","ucode":"ADC3E7B6789955","user_header":"https://static001.geekbang.org/account/avatar/00/13/57/6e/b6795c44.jpg","comment_is_top":false,"comment_ctime":1550055280,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1550055280","product_id":100020801,"comment_content":"è€å¸ˆå¨æ­¦ã€‚<br>ç»ˆäºè¿½ä¸Šæ›´æ–°äº†ã€‚","like_count":0},{"had_liked":false,"id":66813,"user_name":"Kå…ˆç”Ÿ","can_delete":false,"product_type":"c1","uid":1145942,"ip_address":"","ucode":"D9D3ED28943334","user_header":"https://static001.geekbang.org/account/avatar/00/11/7c/56/c743bc9a.jpg","comment_is_top":false,"comment_ctime":1550024530,"is_pvip":false,"replies":[{"id":"23669","content":"show engine innodb status\\G<br>é‡Œé¢lastest deadlocké‚£ä¸€æ®µå‘æ¥çœ‹ä¸‹å“ˆ<br>","user_name":"ä½œè€…å›å¤","user_name_real":"æ—æ™“æ–Œ","uid":"1264162","ctime":1550047309,"ip_address":"","comment_id":66813,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1550024530","product_id":100020801,"comment_content":"è¡¨ç»“æ„<br>CREATE TABLE `PushTask` (<br>  `Id` int(11) NOT NULL AUTO_INCREMENT COMMENT &#39;ä¸»é”®IDï¼Œè‡ªå¢é•¿&#39;,<br>  `DpId` varchar(100) NOT NULL DEFAULT &#39;&#39;,<br>  `DetailId` int(11) NOT NULL,<br>  `SceneType` tinyint(1) DEFAULT NULL,<br>  `DataId` int(11) DEFAULT NULL,<br>  `SendTime` datetime NOT NULL,<br>  `AddTime` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,<br>  `UpdateTime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,<br>  `Status` tinyint(1) DEFAULT &#39;0&#39;,<br>  `SendDate` date DEFAULT NULL,<br>  PRIMARY KEY (`Id`),<br>  UNIQUE KEY `IX_DpId_SendDate_DetailId` (`DpId`,`SendDate`,`DetailId`),<br>  KEY `IX_UpdateTime` (`UpdateTime`),<br>  KEY `IX_SendTime` (`SendTime`)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8;<br><br>è¯·é—®è€å¸ˆï¼Œä¸ºå•¥insert ... ON DUPLICATE KEY UPDATE<br>        UpdateTime = now()çš„æ—¶å€™ä¼šå‡ºç°æ­»é”ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"æ—æ™“æ–Œ","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438924,"discussion_content":"show engine innodb status\\G\né‡Œé¢lastest deadlocké‚£ä¸€æ®µå‘æ¥çœ‹ä¸‹å“ˆ\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550047309,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}