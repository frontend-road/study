{"id":442217,"title":"34ï½œå¹¶å‘å¤„ç†ï¼ˆä¸‹ï¼‰ï¼šä»atomicsåˆ°Channelï¼ŒRustéƒ½æä¾›äº†ä»€ä¹ˆå·¥å…·ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯é™ˆå¤©ã€‚</p><p>å¯¹äºå¹¶å‘çŠ¶æ€ä¸‹è¿™ä¸‰ç§å¸¸è§çš„å·¥ä½œæ¨¡å¼ï¼šè‡ªç”±ç«äº‰æ¨¡å¼ã€map/reduce æ¨¡å¼ã€DAG æ¨¡å¼ï¼Œæˆ‘ä»¬çš„éš¾ç‚¹æ˜¯å¦‚ä½•åœ¨è¿™äº›å¹¶å‘çš„ä»»åŠ¡ä¸­è¿›è¡ŒåŒæ­¥ã€‚atomic / Mutex è§£å†³äº†è‡ªç”±ç«äº‰æ¨¡å¼ä¸‹å¹¶å‘ä»»åŠ¡çš„åŒæ­¥é—®é¢˜ï¼Œä¹Ÿèƒ½å¤Ÿå¾ˆå¥½åœ°è§£å†³ map/reduce æ¨¡å¼ä¸‹çš„åŒæ­¥é—®é¢˜ï¼Œå› ä¸ºæ­¤æ—¶åŒæ­¥åªå‘ç”Ÿåœ¨ map å’Œ reduce ä¸¤ä¸ªé˜¶æ®µã€‚<br>\n<img src=\"https://static001.geekbang.org/resource/image/00/58/003294c9ba4b291e47585fa1a599a358.jpg?wh=2364x1142\" alt=\"\"></p><p>ç„¶è€Œï¼Œå®ƒä»¬æ²¡æœ‰è§£å†³ä¸€ä¸ªæ›´é«˜å±‚æ¬¡çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯ DAG æ¨¡å¼ï¼šå¦‚æœè¿™ç§è®¿é—®éœ€è¦æŒ‰ç…§ä¸€å®šé¡ºåºè¿›è¡Œæˆ–è€…å‰åæœ‰ä¾èµ–å…³ç³»ï¼Œè¯¥æ€ä¹ˆåšï¼Ÿ</p><p>è¿™ä¸ªé—®é¢˜çš„å…¸å‹åœºæ™¯æ˜¯<strong>ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ï¼šç”Ÿäº§è€…ç”Ÿäº§å‡ºæ¥å†…å®¹åï¼Œéœ€è¦æœ‰æœºåˆ¶é€šçŸ¥æ¶ˆè´¹è€…å¯ä»¥æ¶ˆè´¹</strong>ã€‚æ¯”å¦‚ socket ä¸Šæœ‰æ•°æ®äº†ï¼Œé€šçŸ¥å¤„ç†çº¿ç¨‹æ¥å¤„ç†æ•°æ®ï¼Œå¤„ç†å®Œæˆä¹‹åï¼Œå†é€šçŸ¥ socket æ”¶å‘çš„çº¿ç¨‹å‘é€æ•°æ®ã€‚</p><h2>Condvar</h2><p>æ‰€ä»¥ï¼Œæ“ä½œç³»ç»Ÿè¿˜æä¾›äº† Condvarã€‚Condvar æœ‰ä¸¤ç§çŠ¶æ€ï¼š</p><ul>\n<li>ç­‰å¾…ï¼ˆwaitï¼‰ï¼šçº¿ç¨‹åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…ï¼Œç›´åˆ°æ»¡è¶³æŸä¸ªæ¡ä»¶ã€‚</li>\n<li>é€šçŸ¥ï¼ˆnotifyï¼‰ï¼šå½“ condvar çš„æ¡ä»¶æ»¡è¶³æ—¶ï¼Œå½“å‰çº¿ç¨‹é€šçŸ¥å…¶ä»–ç­‰å¾…çš„çº¿ç¨‹å¯ä»¥è¢«å”¤é†’ã€‚é€šçŸ¥å¯ä»¥æ˜¯å•ä¸ªé€šçŸ¥ï¼Œä¹Ÿå¯ä»¥æ˜¯å¤šä¸ªé€šçŸ¥ï¼Œç”šè‡³å¹¿æ’­ï¼ˆé€šçŸ¥æ‰€æœ‰äººï¼‰ã€‚</li>\n</ul><p>åœ¨å®è·µä¸­ï¼ŒCondvar å¾€å¾€å’Œ Mutex ä¸€èµ·ä½¿ç”¨ï¼š<strong>Mutex ç”¨äºä¿è¯æ¡ä»¶åœ¨è¯»å†™æ—¶äº’æ–¥ï¼ŒCondvar ç”¨äºæ§åˆ¶çº¿ç¨‹çš„ç­‰å¾…å’Œå”¤é†’</strong>ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p><!-- [[[read_end]]] --><pre><code class=\"language-rust\">use std::sync::{Arc, Condvar, Mutex};\nuse std::thread;\nuse std::time::Duration;\n\nfn main() {\n    let pair = Arc::new((Mutex::new(false), Condvar::new()));\n    let pair2 = Arc::clone(&amp;pair);\n\n    thread::spawn(move || {\n        let (lock, cvar) = &amp;*pair2;\n        let mut started = lock.lock().unwrap();\n        *started = true;\n        eprintln!(\"I'm a happy worker!\");\n        // é€šçŸ¥ä¸»çº¿ç¨‹\n        cvar.notify_one();\n        loop {\n            thread::sleep(Duration::from_secs(1));\n            println!(\"working...\");\n        }\n    });\n\n    // ç­‰å¾…å·¥ä½œçº¿ç¨‹çš„é€šçŸ¥\n    let (lock, cvar) = &amp;*pair;\n    let mut started = lock.lock().unwrap();\n    while !*started {\n        started = cvar.wait(started).unwrap();\n    }\n    eprintln!(\"Worker started!\");\n}\n</code></pre><p>è¿™æ®µä»£ç é€šè¿‡ condvarï¼Œæˆ‘ä»¬å®ç°äº† worker çº¿ç¨‹åœ¨æ‰§è¡Œåˆ°ä¸€å®šé˜¶æ®µåé€šçŸ¥ä¸»çº¿ç¨‹ï¼Œç„¶åä¸»çº¿ç¨‹å†åšä¸€äº›äº‹æƒ…ã€‚</p><p>è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ª Mutex ä½œä¸ºäº’æ–¥æ¡ä»¶ï¼Œç„¶ååœ¨ <a href=\"https://doc.rust-lang.org/src/std/sync/condvar.rs.html#184-191\">cvar.wait()</a> ä¸­ä¼ å…¥è¿™ä¸ª Mutexã€‚è¿™ä¸ªæ¥å£éœ€è¦ä¸€ä¸ª MutexGuardï¼Œä»¥ä¾¿äºçŸ¥é“éœ€è¦å”¤é†’å“ªä¸ª Mutex ä¸‹ç­‰å¾…çš„çº¿ç¨‹ï¼š</p><pre><code class=\"language-rust\">pub fn wait&lt;'a, T&gt;(\n    &amp;self,\n    guard: MutexGuard&lt;'a, T&gt;\n) -&gt; LockResult&lt;MutexGuard&lt;'a, T&gt;&gt;\n</code></pre><h2>Channel</h2><p>ä½†æ˜¯ç”¨ Mutex å’Œ Condvar æ¥å¤„ç†å¤æ‚çš„ DAG å¹¶å‘æ¨¡å¼ä¼šæ¯”è¾ƒåƒåŠ›ã€‚æ‰€ä»¥ï¼ŒRust è¿˜æä¾›äº†å„ç§å„æ ·çš„ Channel ç”¨äºå¤„ç†å¹¶å‘ä»»åŠ¡ä¹‹é—´çš„é€šè®¯ã€‚</p><p>ç”±äº Golang ä¸é—ä½™åŠ›åœ°æ¨å¹¿ï¼ŒChannel å¯èƒ½æ˜¯æœ€å¹¿ä¸ºäººçŸ¥çš„å¹¶å‘æ‰‹æ®µã€‚ç›¸å¯¹äº Mutexï¼ŒChannel çš„æŠ½è±¡ç¨‹åº¦æœ€é«˜ï¼Œæ¥å£æœ€ä¸ºç›´è§‚ï¼Œä½¿ç”¨èµ·æ¥çš„å¿ƒç†è´Ÿæ‹…ä¹Ÿæ²¡é‚£ä¹ˆå¤§ã€‚ä½¿ç”¨ Mutex æ—¶ï¼Œä½ éœ€è¦å¾ˆå°å¿ƒåœ°é¿å…æ­»é”ï¼Œæ§åˆ¶ä¸´ç•ŒåŒºçš„å¤§å°ï¼Œé˜²æ­¢ä¸€åˆ‡å¯èƒ½å‘ç”Ÿçš„æ„å¤–ã€‚</p><p>è™½ç„¶åœ¨ Rust é‡Œï¼Œæˆ‘ä»¬å¯ä»¥â€œæ— ç•å¹¶å‘â€ï¼ˆFearless concurrencyï¼‰â€”â€” å½“ä»£ç ç¼–è¯‘é€šè¿‡ï¼Œç»å¤§å¤šæ•°å¹¶å‘é—®é¢˜éƒ½å¯ä»¥è§„é¿ï¼Œä½†æ€§èƒ½ä¸Šçš„é—®é¢˜ã€é€»è¾‘ä¸Šçš„æ­»é”è¿˜éœ€è¦å¼€å‘è€…ç…§æ–™ã€‚</p><p><strong>Channel æŠŠé”å°è£…åœ¨äº†é˜Ÿåˆ—å†™å…¥å’Œè¯»å–çš„å°å—åŒºåŸŸå†…ï¼Œç„¶åæŠŠè¯»è€…å’Œå†™è€…å®Œå…¨åˆ†ç¦»</strong>ï¼Œä½¿å¾—è¯»è€…è¯»å–æ•°æ®å’Œå†™è€…å†™å…¥æ•°æ®ï¼Œå¯¹å¼€å‘è€…è€Œè¨€ï¼Œé™¤äº†æ½œåœ¨çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å¤–ï¼Œå®Œå…¨å’Œé”æ— å…³ï¼Œå°±åƒè®¿é—®ä¸€ä¸ªæœ¬åœ°é˜Ÿåˆ—ä¸€æ ·ã€‚æ‰€ä»¥ï¼Œå¯¹äºå¤§éƒ¨åˆ†å¹¶å‘é—®é¢˜ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥ç”¨ Channel æˆ–è€…ç±»ä¼¼çš„æ€æƒ³æ¥å¤„ç†ï¼ˆæ¯”å¦‚ actor modelï¼‰ã€‚</p><p>Channel åœ¨å…·ä½“å®ç°çš„æ—¶å€™ï¼Œæ ¹æ®ä¸åŒçš„ä½¿ç”¨åœºæ™¯ï¼Œä¼šé€‰æ‹©ä¸åŒçš„å·¥å…·ã€‚Rust æä¾›äº†ä»¥ä¸‹å››ç§ Channelï¼š</p><ul>\n<li>oneshotï¼šè¿™å¯èƒ½æ˜¯æœ€ç®€å•çš„ Channelï¼Œå†™è€…å°±åªå‘ä¸€æ¬¡æ•°æ®ï¼Œè€Œè¯»è€…ä¹Ÿåªè¯»ä¸€æ¬¡ã€‚è¿™ç§ä¸€æ¬¡æ€§çš„ã€å¤šä¸ªçº¿ç¨‹é—´çš„åŒæ­¥å¯ä»¥ç”¨ oneshot channel å®Œæˆã€‚ç”±äº oneshot ç‰¹æ®Šçš„ç”¨é€”ï¼Œå®ç°çš„æ—¶å€™å¯ä»¥ç›´æ¥ç”¨ atomic swap æ¥å®Œæˆã€‚</li>\n<li>rendezvousï¼šå¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬åªéœ€è¦é€šè¿‡ Channel æ¥æ§åˆ¶çº¿ç¨‹é—´çš„åŒæ­¥ï¼Œå¹¶ä¸éœ€è¦å‘é€æ•°æ®ã€‚rendezvous channel æ˜¯ channel size ä¸º 0 çš„ä¸€ç§ç‰¹æ®Šæƒ…å†µã€‚</li>\n</ul><p>è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ç”¨ Mutex + Condvar å®ç°å°±è¶³å¤Ÿäº†ï¼Œåœ¨å…·ä½“å®ç°ä¸­ï¼Œrendezvous channel å…¶å®ä¹Ÿå°±æ˜¯ Mutex + Condvar çš„ä¸€ä¸ªåŒ…è£…ã€‚</p><ul>\n<li>boundedï¼š<strong>bounded channel æœ‰ä¸€ä¸ªé˜Ÿåˆ—ï¼Œä½†é˜Ÿåˆ—æœ‰ä¸Šé™ã€‚ä¸€æ—¦é˜Ÿåˆ—è¢«å†™æ»¡äº†ï¼Œå†™è€…ä¹Ÿéœ€è¦è¢«æŒ‚èµ·ç­‰å¾…</strong>ã€‚å½“é˜»å¡å‘ç”Ÿåï¼Œè¯»è€…ä¸€æ—¦è¯»å–æ•°æ®ï¼Œchannel å†…éƒ¨å°±ä¼šä½¿ç”¨ Condvar çš„ <code>notify_one</code> é€šçŸ¥å†™è€…ï¼Œå”¤é†’æŸä¸ªå†™è€…ä½¿å…¶èƒ½å¤Ÿç»§ç»­å†™å…¥ã€‚</li>\n</ul><p>å› æ­¤ï¼Œå®ç°ä¸­ï¼Œä¸€èˆ¬ä¼šç”¨åˆ° Mutex + Condvar + VecDeque æ¥å®ç°ï¼›å¦‚æœä¸ç”¨ Condvarï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ thread::park + thread::notify æ¥å®Œæˆï¼ˆ<a href=\"https://github.com/zesterer/flume\">flume</a> çš„åšæ³•ï¼‰ï¼›å¦‚æœä¸ç”¨ VecDequeï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨åŒå‘é“¾è¡¨æˆ–è€…å…¶å®ƒçš„ ring buffer çš„å®ç°ã€‚</p><ul>\n<li>unboundedï¼šqueue æ²¡æœ‰ä¸Šé™ï¼Œå¦‚æœå†™æ»¡äº†ï¼Œå°±è‡ªåŠ¨æ‰©å®¹ã€‚æˆ‘ä»¬çŸ¥é“ï¼ŒRust çš„å¾ˆå¤šæ•°æ®ç»“æ„å¦‚ <code>Vec</code> ã€<code>VecDeque</code> éƒ½æ˜¯è‡ªåŠ¨æ‰©å®¹çš„ã€‚unbounded å’Œ bounded ç›¸æ¯”ï¼Œé™¤äº†ä¸é˜»å¡å†™è€…ï¼Œå…¶å®ƒå®ç°éƒ½å¾ˆç±»ä¼¼ã€‚</li>\n</ul><p>æ‰€æœ‰è¿™äº› channel ç±»å‹ï¼ŒåŒæ­¥å’Œå¼‚æ­¥çš„å®ç°æ€è·¯å¤§åŒå°å¼‚ï¼Œä¸»è¦çš„åŒºåˆ«åœ¨äºæŒ‚èµ·/å”¤é†’çš„å¯¹è±¡ã€‚<strong>åœ¨åŒæ­¥çš„ä¸–ç•Œé‡Œï¼ŒæŒ‚èµ·/å”¤é†’çš„å¯¹è±¡æ˜¯çº¿ç¨‹ï¼›è€Œå¼‚æ­¥çš„ä¸–ç•Œé‡Œï¼Œæ˜¯ç²’åº¦å¾ˆå°çš„ task</strong>ã€‚<br>\n<img src=\"https://static001.geekbang.org/resource/image/a4/61/a4372f4dd810ced7a99f54d50695cc61.jpg?wh=2364x1610\" alt=\"\"></p><p>æ ¹æ® Channel è¯»è€…å’Œå†™è€…çš„æ•°é‡ï¼ŒChannel åˆå¯ä»¥åˆ†ä¸ºï¼š</p><ul>\n<li>SPSCï¼šSingle-Producer Single-Consumerï¼Œå•ç”Ÿäº§è€…ï¼Œå•æ¶ˆè´¹è€…ã€‚æœ€ç®€å•ï¼Œå¯ä»¥ä¸ä¾èµ–äº Mutexï¼Œåªç”¨ atomics å°±å¯ä»¥å®ç°ã€‚</li>\n<li>SPMCï¼šSingle-Producer Multi-Consumerï¼Œå•ç”Ÿäº§è€…ï¼Œå¤šæ¶ˆè´¹è€…ã€‚éœ€è¦åœ¨æ¶ˆè´¹è€…è¿™ä¾§è¯»å–æ—¶åŠ é”ã€‚</li>\n<li>MPSCï¼šMulti-Producer Single-Consumerï¼Œå¤šç”Ÿäº§è€…ï¼Œå•æ¶ˆè´¹è€…ã€‚éœ€è¦åœ¨ç”Ÿäº§è€…è¿™ä¾§å†™å…¥æ—¶åŠ é”ã€‚</li>\n<li>MPMCï¼šMulti-Producer Multi-Consumerã€‚å¤šç”Ÿäº§è€…ï¼Œå¤šæ¶ˆè´¹è€…ã€‚éœ€è¦åœ¨ç”Ÿäº§è€…å†™å…¥æˆ–è€…æ¶ˆè´¹è€…è¯»å–æ—¶åŠ é”ã€‚</li>\n</ul><p>åœ¨ä¼—å¤š Channel ç±»å‹ä¸­ï¼Œä½¿ç”¨æœ€å¹¿çš„æ˜¯ MPSC channelï¼Œå¤šç”Ÿäº§è€…ï¼Œå•æ¶ˆè´¹è€…ï¼Œ<strong>å› ä¸ºå¾€å¾€æˆ‘ä»¬å¸Œæœ›é€šè¿‡å•æ¶ˆè´¹è€…æ¥ä¿è¯ï¼Œç”¨äºå¤„ç†æ¶ˆæ¯çš„æ•°æ®ç»“æ„æœ‰ç‹¬å çš„å†™è®¿é—®</strong>ã€‚<br>\n<img src=\"https://static001.geekbang.org/resource/image/4f/12/4fbacc0fecf5618d30b976d110838912.jpg?wh=2364x1433\" alt=\"\"></p><p>æ¯”å¦‚ï¼Œåœ¨ <a href=\"https://github.com/tyrchen/xunmi/blob/master/src/indexer.rs#L50\">xunmi</a> çš„å®ç°ä¸­ï¼Œindex writer å†…éƒ¨æ˜¯ä¸€ä¸ªå¤šçº¿ç¨‹çš„å®ç°ï¼Œä½†åœ¨ä½¿ç”¨æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ç”¨åˆ°å®ƒçš„å¯å†™å¼•ç”¨ã€‚</p><p>å¦‚æœè¦èƒ½å¤Ÿåœ¨å„ç§ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨ index writerï¼Œæˆ‘ä»¬å°±ä¸å¾—ä¸å°†å…¶ç”¨ Arc&lt;Mutex&lt;T&gt;&gt; åŒ…è£¹èµ·æ¥ï¼Œä½†è¿™æ ·åœ¨ç´¢å¼•å¤§é‡æ•°æ®æ—¶æ•ˆç‡å¤ªä½ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨ MPSC channelï¼Œè®©å„ç§ä¸Šä¸‹æ–‡éƒ½æŠŠæ•°æ®å‘é€ç»™å•ä¸€çš„çº¿ç¨‹ï¼Œä½¿ç”¨ index writer ç´¢å¼•ï¼Œè¿™æ ·å°±é¿å…äº†é”ï¼š</p><pre><code class=\"language-rust\">pub struct IndexInner {\n    index: Index,\n    reader: IndexReader,\n    config: IndexConfig,\n    updater: Sender&lt;Input&gt;,\n}\n\npub struct IndexUpdater {\n    sender: Sender&lt;Input&gt;,\n    t2s: bool,\n    schema: Schema,\n}\n\nimpl Indexer {\n    // æ‰“å¼€æˆ–è€…åˆ›å»ºä¸€ä¸ª index\n    pub fn open_or_create(config: IndexConfig) -&gt; Result&lt;Self&gt; {\n        let schema = config.schema.clone();\n        let index = if let Some(dir) = &amp;config.path {\n            fs::create_dir_all(dir)?;\n            let dir = MmapDirectory::open(dir)?;\n            Index::open_or_create(dir, schema.clone())?\n        } else {\n            Index::create_in_ram(schema.clone())\n        };\n\n        Self::set_tokenizer(&amp;index, &amp;config);\n\n        let mut writer = index.writer(config.writer_memory)?;\n\n        // åˆ›å»ºä¸€ä¸ª unbounded MPSC channel\n        let (s, r) = unbounded::&lt;Input&gt;();\n\n        // å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ï¼Œä» channel çš„ reader ä¸­è¯»å–æ•°æ®\n        thread::spawn(move || {\n            for input in r {\n                // ç„¶åç”¨ index writer å¤„ç†è¿™ä¸ª input\n                if let Err(e) = input.process(&amp;mut writer, &amp;schema) {\n                    warn!(\"Failed to process input. Error: {:?}\", e);\n                }\n            }\n        });\n\n        // æŠŠ channel çš„ sender éƒ¨åˆ†å­˜å…¥ IndexInner ç»“æ„\n        Self::new(index, config, s)\n    }\n\n    pub fn get_updater(&amp;self) -&gt; IndexUpdater {\n        let t2s = TextLanguage::Chinese(true) == self.config.text_lang;\n        // IndexUpdater å†…éƒ¨åŒ…å« channel çš„ sender éƒ¨åˆ†\n        // ç”±äºæ˜¯ MPSC channelï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥ç®€å• clone ä¸€ä¸‹ sender\n        // è¿™ä¹Ÿæ„å‘³ç€ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä»»æ„å¤šä¸ª IndexUpdater åœ¨ä¸åŒä¸Šä¸‹æ–‡å‘é€æ•°æ®\n        // è€Œæ•°æ®æœ€ç»ˆéƒ½ä¼šé€šè¿‡ channel ç»™åˆ°ä¸Šé¢åˆ›å»ºçš„çº¿ç¨‹ï¼Œç”± index writer å¤„ç†\n        IndexUpdater::new(self.updater.clone(), self.index.schema(), t2s)\n    }\n}\n</code></pre><h2>Actor</h2><p>æœ€åæˆ‘ä»¬ç®€å•ä»‹ç»ä¸€ä¸‹ <a href=\"https://en.wikipedia.org/wiki/Actor_model\">actor model</a>ï¼Œå®ƒåœ¨ä¸šç•Œä¸»è¦çš„ä½¿ç”¨è€…æ˜¯ Erlang VMä»¥åŠ <a href=\"https://akka.io/\">akka</a>ã€‚</p><p>actor æ˜¯ä¸€ç§æœ‰æ ˆåç¨‹ã€‚æ¯ä¸ª actorï¼Œæœ‰è‡ªå·±çš„ä¸€ä¸ªç‹¬ç«‹çš„ã€è½»é‡çº§çš„è°ƒç”¨æ ˆï¼Œä»¥åŠä¸€ä¸ªç”¨æ¥æ¥å—æ¶ˆæ¯çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆmailbox æˆ–è€… message queueï¼‰ï¼Œå¤–ç•Œè·Ÿ actor æ‰“äº¤é“çš„å”¯ä¸€æ‰‹æ®µå°±æ˜¯ï¼Œç»™å®ƒå‘é€æ¶ˆæ¯ã€‚</p><p>Rust æ ‡å‡†åº“æ²¡æœ‰ actor çš„å®ç°ï¼Œä½†æ˜¯ç¤¾åŒºé‡Œæœ‰æ¯”è¾ƒæˆç†Ÿçš„ <a href=\"https://github.com/actix/actix\">actix</a>ï¼ˆå¤§åé¼é¼çš„ actix-web å°±æ˜¯åŸºäº actix å®ç°çš„ï¼‰ï¼Œä»¥åŠ <a href=\"https://github.com/bastion-rs/bastion\">bastion</a>ã€‚</p><p>ä¸‹é¢çš„ä»£ç ç”¨ actix å®ç°äº†ä¸€ä¸ªç®€å•çš„ DummyActorï¼Œå®ƒå¯ä»¥æ¥æ”¶ä¸€ä¸ª InMsgï¼Œè¿”å›ä¸€ä¸ª OutMsgï¼š</p><pre><code class=\"language-rust\">use actix::prelude::*;\nuse anyhow::Result;\n\n// actor å¯ä»¥å¤„ç†çš„æ¶ˆæ¯\n#[derive(Message, Debug, Clone, PartialEq)]\n#[rtype(result = \"OutMsg\")]\nenum InMsg {\n    Add((usize, usize)),\n    Concat((String, String)),\n}\n\n#[derive(MessageResponse, Debug, Clone, PartialEq)]\nenum OutMsg {\n    Num(usize),\n    Str(String),\n}\n\n// Actor\nstruct DummyActor;\n\nimpl Actor for DummyActor {\n    type Context = Context&lt;Self&gt;;\n}\n\n// å®ç°å¤„ç† InMsg çš„ Handler trait\nimpl Handler&lt;InMsg&gt; for DummyActor {\n    type Result = OutMsg; // &lt;-  è¿”å›çš„æ¶ˆæ¯\n\n    fn handle(&amp;mut self, msg: InMsg, _ctx: &amp;mut Self::Context) -&gt; Self::Result {\n        match msg {\n            InMsg::Add((a, b)) =&gt; OutMsg::Num(a + b),\n            InMsg::Concat((mut s1, s2)) =&gt; {\n                s1.push_str(&amp;s2);\n                OutMsg::Str(s1)\n            }\n        }\n    }\n}\n\n#[actix::main]\nasync fn main() -&gt; Result&lt;()&gt; {\n    let addr = DummyActor.start();\n    let res = addr.send(InMsg::Add((21, 21))).await?;\n    let res1 = addr\n        .send(InMsg::Concat((\"hello, \".into(), \"world\".into())))\n        .await?;\n\n    println!(\"res: {:?}, res1: {:?}\", res, res1);\n\n    Ok(())\n}\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œå¯¹ DummyActorï¼Œæˆ‘ä»¬åªéœ€è¦å®ç° Actor traitå’ŒHandler&lt;InMsg&gt; trait ã€‚</p><h2>ä¸€ç‚¹å°ç»“</h2><p>å­¦å®Œè¿™å‰åä¸¤è®²ï¼Œæˆ‘ä»¬å°ç»“ä¸€ä¸‹å„ç§å¹¶å‘åŸè¯­çš„ä½¿ç”¨åœºæ™¯Atomicã€Mutexã€RwLockã€Semaphoreã€Condvarã€Channelã€Actorã€‚</p><ul>\n<li>Atomic åœ¨å¤„ç†ç®€å•çš„åŸç”Ÿç±»å‹æ—¶éå¸¸æœ‰ç”¨ï¼Œå¦‚æœä½ å¯ä»¥é€šè¿‡ AtomicXXX ç»“æ„è¿›è¡ŒåŒæ­¥ï¼Œé‚£ä¹ˆå®ƒä»¬æ˜¯æœ€å¥½çš„é€‰æ‹©ã€‚</li>\n<li>å½“ä½ çš„æ•°æ®ç»“æ„æ— æ³•ç®€å•é€šè¿‡ AtomicXXX è¿›è¡ŒåŒæ­¥ï¼Œä½†ä½ åˆçš„ç¡®éœ€è¦åœ¨å¤šä¸ªçº¿ç¨‹ä¸­å…±äº«æ•°æ®ï¼Œé‚£ä¹ˆ Mutex / RwLock å¯ä»¥æ˜¯ä¸€ç§é€‰æ‹©ã€‚ä¸è¿‡ï¼Œä½ éœ€è¦è€ƒè™‘é”çš„ç²’åº¦ï¼Œç²’åº¦å¤ªå¤§çš„ Mutex / RwLock æ•ˆç‡å¾ˆä½ã€‚</li>\n<li>å¦‚æœä½ æœ‰ N ä»½èµ„æºå¯ä»¥ä¾›å¤šä¸ªå¹¶å‘ä»»åŠ¡ç«äº‰ä½¿ç”¨ï¼Œé‚£ä¹ˆï¼ŒSemaphore æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚æ¯”å¦‚ä½ è¦åšä¸€ä¸ª DB è¿æ¥æ± ã€‚</li>\n<li>å½“ä½ éœ€è¦åœ¨å¹¶å‘ä»»åŠ¡ä¸­é€šçŸ¥ã€åä½œæ—¶ï¼ŒCondvar æä¾›äº†æœ€åŸºæœ¬çš„é€šçŸ¥æœºåˆ¶ï¼Œè€ŒChannel æŠŠè¿™ä¸ªé€šçŸ¥æœºåˆ¶è¿›ä¸€æ­¥å¹¿æ³›æ‰©å±•å¼€ï¼Œäºæ˜¯ä½ å¯ä»¥ç”¨ Condvar è¿›è¡Œç‚¹å¯¹ç‚¹çš„åŒæ­¥ï¼Œç”¨ Channel åšä¸€å¯¹å¤šã€å¤šå¯¹ä¸€ã€å¤šå¯¹å¤šçš„åŒæ­¥ã€‚</li>\n</ul><p>æ‰€ä»¥ï¼Œå½“æˆ‘ä»¬åšå¤§éƒ¨åˆ†å¤æ‚çš„ç³»ç»Ÿè®¾è®¡æ—¶ï¼ŒChannel å¾€å¾€æ˜¯æœ€æœ‰åŠ›çš„æ­¦å™¨ï¼Œé™¤äº†å¯ä»¥è®©æ•°æ®ç©¿æ¢­äºå„ä¸ªçº¿ç¨‹ã€å„ä¸ªå¼‚æ­¥ä»»åŠ¡é—´ï¼Œå®ƒçš„æ¥å£è¿˜å¯ä»¥å¾ˆä¼˜é›…åœ°è·Ÿ stream é€‚é…ã€‚</p><p>å¦‚æœè¯´åœ¨åšæ•´ä¸ªåç«¯çš„ç³»ç»Ÿæ¶æ„æ—¶ï¼Œæˆ‘ä»¬ç€çœ¼çš„æ˜¯ï¼šæœ‰å“ªäº›æœåŠ¡ã€æœåŠ¡å’ŒæœåŠ¡ä¹‹é—´å¦‚ä½•é€šè®¯ã€æ•°æ®å¦‚ä½•æµåŠ¨ã€æœåŠ¡å’ŒæœåŠ¡é—´å¦‚ä½•åŒæ­¥ï¼›é‚£ä¹ˆ<strong>åœ¨åšæŸä¸€ä¸ªæœåŠ¡çš„æ¶æ„æ—¶ï¼Œç€çœ¼çš„æ˜¯æœ‰å“ªäº›åŠŸèƒ½æ€§çš„çº¿ç¨‹ï¼ˆå¼‚æ­¥ä»»åŠ¡ï¼‰ã€å®ƒä»¬ä¹‹é—´çš„æ¥å£æ˜¯ä»€ä¹ˆæ ·å­ã€æ•°æ®å¦‚ä½•æµåŠ¨ã€å¦‚ä½•åŒæ­¥</strong>ã€‚</p><p>åœ¨è¿™é‡Œï¼ŒChannel å…¼å…·æ¥å£ã€åŒæ­¥å’Œæ•°æ®æµä¸‰ç§åŠŸèƒ½ï¼Œæ‰€ä»¥æˆ‘è¯´æ˜¯æœ€æœ‰åŠ›çš„æ­¦å™¨ã€‚</p><p>ç„¶è€Œå®ƒä¸è¯¥æ˜¯å”¯ä¸€çš„æ­¦å™¨ã€‚æˆ‘ä»¬é¢ä¸´çš„çœŸå®ä¸–ç•Œçš„å¹¶å‘é—®é¢˜æ˜¯å¤šæ ·çš„ï¼Œè§£å†³æ–¹æ¡ˆä¹Ÿåº”è¯¥æ˜¯å¤šæ ·çš„ï¼Œè®¡ç®—æœºç§‘å­¦å®¶ä»¬åœ¨è¿‡å»çš„å‡ åå¹´é‡Œä¸æ–­æ¢ç´¢ï¼Œæ„å»ºäº†ä¸€ç³»åˆ—çš„å¹¶å‘åŸè¯­ï¼Œä¹Ÿè¯´æ˜äº†å¾ˆéš¾æœ‰ä¸€ç§é“¶å¼¹è§£å†³æ‰€æœ‰é—®é¢˜ã€‚</p><p>å°±è¿ Mutex æœ¬èº«ï¼Œåœ¨å®ç°ä¸­ï¼Œè¿˜ä¼šæ ¹æ®ä¸åŒçš„åœºæ™¯åšä¸åŒçš„å¦¥åï¼ˆæ¯”å¦‚åš faireness çš„å¦¥åï¼‰ï¼Œå› ä¸ºè¿™ä¸ªä¸–ç•Œå°±æ˜¯è¿™æ ·ï¼Œé±¼ä¸ç†ŠæŒä¸å¯å…¼å¾—ï¼Œæ²¡æœ‰å®Œç¾çš„è§£å†³æ–¹æ¡ˆï¼Œåªæœ‰å¦¥åå‡ºæ¥çš„è§£å†³æ–¹æ¡ˆã€‚æ‰€ä»¥ Channel ä¸æ˜¯é“¶å¼¹ï¼Œactor model ä¸æ˜¯é“¶å¼¹ï¼Œlock ä¸æ˜¯é“¶å¼¹ã€‚</p><p><strong>ä¸€é—¨å¥½çš„ç¼–ç¨‹è¯­è¨€ï¼Œå¯ä»¥æä¾›å¤§éƒ¨åˆ†åœºæ™¯ä¸‹çš„æœ€ä½³å®è·µï¼ˆå¦‚ Erlang/Golangï¼‰ï¼Œä½†ä¸è¯¥è¥é€ ä¸€ç§æ°”æ°›ï¼Œåªæœ‰æŸä¸ªæœ€ä½³å®è·µæ‰æ˜¯å”¯ä¸€æ–¹æ¡ˆ</strong>ã€‚æˆ‘å¾ˆå–œæ¬¢ Erlang çš„ actor model å’Œ Golang çš„ Channelï¼Œä½†å¾ˆå¯æƒœï¼Œå®ƒä»¬è¿‡åˆ†ä¾èµ–ç‰¹å®šçš„ã€å”¯ä¸€çš„å¹¶å‘æ–¹æ¡ˆï¼Œä½¿å¾—å¼€å‘è€…æ‹¿ç€æ¦”å¤´ï¼Œçœ‹ä»€ä¹ˆéƒ½æ˜¯é’‰å­ã€‚</p><p>ç›¸åï¼ŒRust æä¾›å‡ ä¹ä½ éœ€è¦çš„æ‰€æœ‰è§£å†³æ–¹æ¡ˆï¼Œå¹¶ä¸”å¹¶ä¸é¼“å¹å®ƒä»¬çš„ä¼˜åŠ£ï¼Œå®Œå…¨äº¤ç”±ä½ æŒ‰éœ€é€‰æ‹©ã€‚æˆ‘åœ¨ç”¨ Rust æ’°å†™å¤šçº¿ç¨‹åº”ç”¨æ—¶ï¼ŒChannel ä»ç„¶æ˜¯ç¬¬ä¸€é€‰æ‹©ï¼Œä½†æˆ‘è¿˜æ˜¯ä¼šåœ¨åˆé€‚çš„æ—¶å€™ä½¿ç”¨ Mutexã€RwLockã€Semaphoreã€Condvarã€Atomic ç­‰å·¥å…·ï¼Œè€Œä¸æ˜¯è¯•å›¾ç¬¨æ‹™åœ°ç”¨ Channel å åŠ  Channel æ¥åº”å¯¹æ‰€æœ‰çš„åœºæ™¯ã€‚</p><h3>æ€è€ƒé¢˜</h3><ol>\n<li>è¯·ä»”ç»†é˜…è¯»æ ‡å‡†åº“çš„æ–‡æ¡£ <a href=\"https://doc.rust-lang.org/std/sync/index.html\">std::sync</a>ï¼Œä»¥åŠ <a href=\"https://doc.rust-lang.org/std/sync/atomic/index.html\">std::sync::atomic</a> å’Œ <a href=\"https://doc.rust-lang.org/std/sync/mpsc/index.html\">std::sync::mpsc</a>ã€‚ å°è¯•ç€ä½¿ç”¨ mpsc::channel åœ¨ä¸¤ä¸ªçº¿ç¨‹ä¸­<strong>æ¥å›</strong>å‘é€æ¶ˆæ¯ã€‚æ¯”å¦‚çº¿ç¨‹ A ç»™çº¿ç¨‹ B å‘é€ï¼šhello world!ï¼Œçº¿ç¨‹ B æ”¶åˆ°ä¹‹åå›å¤ goodbye!ã€‚</li>\n<li>æƒ³æƒ³çœ‹ï¼Œå¦‚æœè¦ä½ å®ç° actor modelï¼Œåˆ©ç”¨ç°æœ‰çš„å¹¶å‘åŸè¯­ï¼Œä½ è¯¥å¦‚ä½•å®ç°å‘¢ï¼Ÿ</li>\n</ol><p>æ¬¢è¿åœ¨ç•™è¨€åŒºåˆ†äº«ä½ çš„æ€è€ƒï¼Œæ„Ÿè°¢ä½ çš„é˜…è¯»ã€‚ä½ å·²ç»å®ŒæˆRustå­¦ä¹ çš„ç¬¬34æ¬¡æ‰“å¡å•¦ï¼Œå¦‚æœè§‰å¾—æœ‰æ”¶è·ï¼Œä¹Ÿæ¬¢è¿ä½ åˆ†äº«ç»™èº«è¾¹çš„æœ‹å‹ï¼Œé‚€ä»–ä¸€èµ·è®¨è®ºã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ã€‚</p>","comments":[{"had_liked":false,"id":326882,"user_name":"Ã—22","can_delete":false,"product_type":"c1","uid":2412446,"ip_address":"","ucode":"68DA918813054E","user_header":"https://static001.geekbang.org/account/avatar/00/24/cf/9e/e695885e.jpg","comment_is_top":false,"comment_ctime":1639731336,"is_pvip":false,"replies":[{"id":"118772","content":"dashmapï¼Œå¦‚æœä½ çš„ä½¿ç”¨åœºæ™¯é€‚åˆçš„è¯ï¼Œä¹Ÿå¯ä»¥å°è¯• Jon å†™çš„ left-right: https:&#47;&#47;github.com&#47;jonhoo&#47;left-right","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1079375","ctime":1639791893,"ip_address":"","comment_id":326882,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10229665928","product_id":100085301,"comment_content":"è¯·é—®ä¸€ä¸‹ï¼Œç›®å‰rustçš„æ ‡å‡†åº“ä¸­å¹¶æ²¡æœ‰ç±»ä¼¼concurrent hash mapç­‰å¹¶å‘å®‰å…¨çš„é›†åˆï¼Œè™½ç„¶ç¬¬ä¸‰æ–¹åº“æœ‰ä¸€äº›å®ç°ï¼Œä½†æ˜¯ä¸å®¹æ˜“ä»ä¸­åšå‡ºé€‰æ‹©ï¼Œè¯·é—®è€å¸ˆæœ‰ä»€ä¹ˆæ¨èå—","like_count":3,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539621,"discussion_content":"dashmapï¼Œå¦‚æœä½ çš„ä½¿ç”¨åœºæ™¯é€‚åˆçš„è¯ï¼Œä¹Ÿå¯ä»¥å°è¯• Jon å†™çš„ left-right: https://github.com/jonhoo/left-right","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639791893,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":324864,"user_name":"æ ¸æ¡ƒ","can_delete":false,"product_type":"c1","uid":1385204,"ip_address":"","ucode":"7AB05270CBCCCB","user_header":"https://static001.geekbang.org/account/avatar/00/15/22/f4/9fd6f8f0.jpg","comment_is_top":false,"comment_ctime":1638692922,"is_pvip":false,"replies":[{"id":"118859","content":"å¯¹ï¼Œé«˜çº§çš„å¹¶å‘åŸè¯­éƒ½æ˜¯ä½çº§çš„åŸè¯­çš„ç»„åˆå’Œåšäº†ç²¾å¿ƒçš„ä½¿ç”¨é™åˆ¶ã€‚æˆ‘æ–‡ä¸­æœ‰è®²åˆ°ä»€ä¹ˆæ ·çš„ channel å¤§æ¦‚ç”¨äº†ä»€ä¹ˆæ ·çš„æŠ€æœ¯å»å®ç°ã€‚æ¯”å¦‚ mpscï¼Œå› ä¸º consumer åªæœ‰ä¸€ä¸ªï¼Œæ‰€ä»¥å®ç°åœ°å¥½çš„è¯ consumer ä¾§ä¸éœ€è¦é”ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1079375","ctime":1639848336,"ip_address":"","comment_id":324864,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10228627514","product_id":100085301,"comment_content":"Channel æŠŠé”å°è£…åœ¨äº†é˜Ÿåˆ—å†™å…¥å’Œè¯»å–çš„å°å—åŒºåŸŸå†…ï¼Œç„¶åæŠŠè¯»è€…å’Œå†™è€…å®Œå…¨åˆ†ç¦»ï¼Œä½¿å¾—è¯»è€…è¯»å–æ•°æ®å’Œå†™è€…å†™å…¥æ•°æ®ï¼Œå¯¹å¼€å‘è€…è€Œè¨€ï¼Œé™¤äº†æ½œåœ¨çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å¤–ï¼Œå®Œå…¨å’Œé”æ— å…³ï¼Œå°±åƒè®¿é—®ä¸€ä¸ªæœ¬åœ°é˜Ÿåˆ—ä¸€æ ·<br><br>è¿™æ®µæ–‡å­—ï¼Œæˆ‘è¿˜æ˜¯æ²¡æœ‰å¾ˆæ˜ç™½ï¼Œæ‰€è°“å¯¹äºchannelå’Œmutexé”çš„åŒºåˆ«ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥è¿™æ ·ç†è§£ï¼Ÿchannelå¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ªé˜Ÿåˆ—(vecé‚£æ ·çš„)ï¼Œç„¶åchannelè¿™é‡Œå°±æ˜¯ä¸€å¤´å†™å…¥ä¸€å¤´æ¶ˆè´¹ï¼Œé‚£ä¹ˆå¦‚æœæœ‰å¹¶å‘çš„æ—¶å€™ï¼Œå°±æ˜¯å¯¹å¤´å°¾è¿›è¡ŒåŠ é”ï¼Œå¹¶ä¸”ä¼šåšå¤šä¸€äº›å…¶ä»–çš„è¾…åŠ©æ“ä½œï¼Œä¾‹å¦‚é˜Ÿåˆ—æ»¡äº†æˆ–è€…ç©ºçš„æ—¶å€™å„ç§å®‰å…¨æ£€æŸ¥åˆ¤æ–­ç­‰ç­‰ï¼Œå®é™…ä¸Šchannelå°±æ˜¯å¯¹mutex+queueçš„æŠ½è±¡å°è£…ï¼Ÿ å¤šè°¢äº†","like_count":2,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539819,"discussion_content":"å¯¹ï¼Œé«˜çº§çš„å¹¶å‘åŸè¯­éƒ½æ˜¯ä½çº§çš„åŸè¯­çš„ç»„åˆå’Œåšäº†ç²¾å¿ƒçš„ä½¿ç”¨é™åˆ¶ã€‚æˆ‘æ–‡ä¸­æœ‰è®²åˆ°ä»€ä¹ˆæ ·çš„ channel å¤§æ¦‚ç”¨äº†ä»€ä¹ˆæ ·çš„æŠ€æœ¯å»å®ç°ã€‚æ¯”å¦‚ mpscï¼Œå› ä¸º consumer åªæœ‰ä¸€ä¸ªï¼Œæ‰€ä»¥å®ç°åœ°å¥½çš„è¯ consumer ä¾§ä¸éœ€è¦é”ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639848337,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":350969,"user_name":"Geek_e188ed","can_delete":false,"product_type":"c1","uid":2264479,"ip_address":"","ucode":"A7CCFE385E7C3E","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/UmdVZ3v0axr9ymauQGQRyexSK58icbICh9h2hIycfDB7pJFPeYvYVRFW4ql6icXbE7s1RqScra0TP5HL2XWVN5Nw/132","comment_is_top":false,"comment_ctime":1657431055,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5952398351","product_id":100085301,"comment_content":"è€å¸ˆï¼Œä»£ç ç¤ºä¾‹æœ‰ç‚¹å°‘å•Šï¼Œæ¯”å¦‚Channelè¿™å—ï¼Œä½ çš„æ–‡å­—æè¿°æˆ‘éƒ½çœ‹æ‡‚äº†ï¼Œä½†æ˜¯æ²¡æœ‰ä½¿ç”¨Channelçš„ä»£ç ç¤ºä¾‹ï¼Œå¯èƒ½æ€ä¹ˆè°ƒç”¨æˆ‘éƒ½ä¸çŸ¥é“","like_count":1,"discussions":[{"author":{"id":2648083,"avatar":"https://static001.geekbang.org/account/avatar/00/28/68/13/452e9331.jpg","nickname":"å¤ªå—å–¬ Serendipity!","note":"","ucode":"F1DA88F7E8B2F3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":580235,"discussion_content":"æ–‡æª”è£¡é¢æœ‰ç¯„ä¾‹çš„\nhttps://doc.rust-lang.org/std/sync/mpsc/index.html","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1658033622,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":321848,"user_name":"newzai","can_delete":false,"product_type":"c1","uid":1102367,"ip_address":"","ucode":"D5E34D427D65FD","user_header":"https://static001.geekbang.org/account/avatar/00/10/d2/1f/2ef2514b.jpg","comment_is_top":false,"comment_ctime":1637065827,"is_pvip":false,"replies":[{"id":"118912","content":"ä½ å¯ä»¥ä½¿ç”¨å•ç‹¬çš„ channelï¼Œä¹Ÿå¯ä»¥ç”¨ condvarï¼Œä¹Ÿå¯ä»¥ç”¨ç¬¬ä¸‰æ–¹å°è£…å¥½çš„ signalã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1079375","ctime":1639852339,"ip_address":"","comment_id":321848,"utype":1}],"discussion_count":1,"race_medal":1,"score":"5932033123","product_id":100085301,"comment_content":"goç»å¸¸ä¼šä½¿ç”¨ chan struct æ¥ä½œä¸ºactorå¯¹è±¡çš„é€€å‡ºä¿¡å·ï¼Œrustæœ‰ä»€ä¹ˆå»ºè®®ä¸ï¼Ÿä¸æƒ³å’Œæ•°æ®channelæ··åˆåœ¨ä¸€èµ·ã€‚","like_count":1,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539873,"discussion_content":"ä½ å¯ä»¥ä½¿ç”¨å•ç‹¬çš„ channelï¼Œä¹Ÿå¯ä»¥ç”¨ condvarï¼Œä¹Ÿå¯ä»¥ç”¨ç¬¬ä¸‰æ–¹å°è£…å¥½çš„ signalã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639852340,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":321567,"user_name":"ç»ˆç”Ÿæ»éš","can_delete":false,"product_type":"c1","uid":2739953,"ip_address":"","ucode":"4E21A631545D22","user_header":"https://static001.geekbang.org/account/avatar/00/29/ce/f1/d2fc86bb.jpg","comment_is_top":false,"comment_ctime":1636948722,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5931916018","product_id":100085301,"comment_content":"#[test]<br>fn test_mpsc() {<br>    let (a2btx, a2brx) = mpsc::channel();<br>    let (b2atx, b2arx) = mpsc::channel();<br><br>    let threada = thread::spawn(move || {<br>        a2btx.send(&quot;hello world!&quot;.to_string()).unwrap();<br>        for re in b2arx {<br>            println!(&quot;{}\\n&quot;, re);<br>            thread::sleep(Duration::from_secs(1));<br>            a2btx.send(&quot;hello world!&quot;.to_string()).unwrap();<br>        }<br>    });<br><br>    let threadb = thread::spawn(move || {<br>        for re in a2brx {<br>            println!(&quot;{}\\n&quot;, re);<br>            thread::sleep(Duration::from_secs(1));<br>            b2atx.send(&quot;goodbye!&quot;.to_string()).unwrap();<br>        }<br>    });<br><br>    thread::sleep(Duration::from_secs(10));<br>    return<br>}","like_count":1},{"had_liked":false,"id":359885,"user_name":"çº¦ä¹¦äºš","can_delete":false,"product_type":"c1","uid":1046714,"ip_address":"å¤©æ´¥","ucode":"81EA27ADD9EC1A","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f8/ba/14e05601.jpg","comment_is_top":false,"comment_ctime":1666013244,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1666013244","product_id":100085301,"comment_content":"golangä¹Ÿæ˜¯æœ‰atomicï¼Œmutexï¼Œrwlockï¼Œcondçš„ï¼Œè€Œä¸”å„ç§ä¸‰æ–¹åº“ä¹Ÿæ˜¯æŠŠè¿™äº›åŸè¯­ç”¨å¾—é£èµ·ã€‚åªæ˜¯å®˜æ–¹ä¸€ç›´åœ¨å¼ºçƒˆå»ºè®®ä½¿ç”¨channelæ¥ç”¨åœ¨å¤§å¤šæ•°åœºæ™¯ï¼Œè¿™å¯èƒ½å°±æ˜¯æ–‡ä¸­è¯´çš„â€œä½†ä¸è¯¥è¥é€ ä¸€ç§æ°”æ°›â€?","like_count":0},{"had_liked":false,"id":358661,"user_name":"è¿›å‡»çš„Lancelot","can_delete":false,"product_type":"c1","uid":2620407,"ip_address":"å¹¿ä¸œ","ucode":"3BCC355801DC61","user_header":"https://static001.geekbang.org/account/avatar/00/27/fb/f7/88ab6f83.jpg","comment_is_top":false,"comment_ctime":1664523634,"is_pvip":true,"discussion_count":0,"race_medal":1,"score":"1664523634","product_id":100085301,"comment_content":"æ€è€ƒé¢˜ï¼šhttps:&#47;&#47;play.rust-lang.org&#47;?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=3604e3e575fd7dbc98c1e926c62583eb","like_count":0},{"had_liked":false,"id":349577,"user_name":"æœ±å¶å­","can_delete":false,"product_type":"c1","uid":2819942,"ip_address":"","ucode":"015C66AE526F20","user_header":"https://static001.geekbang.org/account/avatar/00/2b/07/66/b703a6e5.jpg","comment_is_top":false,"comment_ctime":1656084650,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1656084650","product_id":100085301,"comment_content":"å·¥ä½œçº¿ç¨‹ä¸­ï¼Œç¼ºäº†drop(started)ï¼Œå¯¼è‡´ä¸»çº¿ç¨‹æ— æ³•è·å–mutex","like_count":0},{"had_liked":false,"id":338999,"user_name":"ä¸€é›„","can_delete":false,"product_type":"c1","uid":1898574,"ip_address":"","ucode":"DB71F9125BEED5","user_header":"https://static001.geekbang.org/account/avatar/00/1c/f8/4e/3026516d.jpg","comment_is_top":false,"comment_ctime":1647854298,"is_pvip":true,"discussion_count":0,"race_medal":4,"score":"1647854298","product_id":100085301,"comment_content":"è€å¸ˆï¼Œå‰é¢å‘çš„ä»£ç ï¼Œå’Œå°ä¼™ä¼´è®¨è®ºäº†ä¸€ä¸‹ä»¥åï¼ŒçŸ¥é“é—®é¢˜åœ¨å“ªé‡Œäº†ã€‚åœ¨å­çº¿ç¨‹ä¸Šï¼Œlockéœ€è¦åœ¨é€šçŸ¥å®Œäº†condvarä¹‹åï¼Œéœ€è¦é‡Šæ”¾ï¼Œé‚£ä¸ªlockã€‚æˆ‘æƒ³åˆ°çš„æ‰“è¡¥ä¸çš„æ–¹æ³•æ˜¯ï¼ŒåŠ ä¸ªå¤§æ‹¬å·ï¼Œå’Œè€å¸ˆä¿¡æ¯æ›´æ–°ä¸€ä¸‹","like_count":0},{"had_liked":false,"id":338989,"user_name":"ä¸€é›„","can_delete":false,"product_type":"c1","uid":1898574,"ip_address":"","ucode":"DB71F9125BEED5","user_header":"https://static001.geekbang.org/account/avatar/00/1c/f8/4e/3026516d.jpg","comment_is_top":false,"comment_ctime":1647850865,"is_pvip":true,"discussion_count":2,"race_medal":4,"score":"1647850865","product_id":100085301,"comment_content":"<br>use std::sync::{Arc, Condvar, Mutex};<br>use std::thread;<br>use std::time::Duration;<br><br>fn main() {<br>    let pair = Arc::new((Mutex::new(false), Condvar::new()));<br>    let pair2 = Arc::clone(&amp;pair);<br><br>    thread::spawn(move || {<br>        let (lock, cvar) = &amp;*pair2;<br>        let mut started = lock.lock().unwrap();<br>        *started = true;<br>        eprintln!(&quot;I&#39;m a happy worker!&quot;);<br>        &#47;&#47; é€šçŸ¥ä¸»çº¿ç¨‹<br>        cvar.notify_one();<br>        loop {<br>            thread::sleep(Duration::from_secs(1));<br>            println!(&quot;working...&quot;);<br>        }<br>    });<br><br>    &#47;&#47; ç­‰å¾…å·¥ä½œçº¿ç¨‹çš„é€šçŸ¥<br>    let (lock, cvar) = &amp;*pair;<br>    let mut started = lock.lock().unwrap();<br>    while !*started {<br>        started = cvar.wait(started).unwrap();<br>    }<br>    eprintln!(&quot;Worker started!&quot;);<br>}<br><br>è€å¸ˆéº»çƒ¦çœ‹ä¸€ä¸‹ï¼Œè¿™ä¸ªdemoè·‘ä¸èµ·æ¥ï¼Œæˆ‘å°è¯•æŠŠloopæ‹¿æ‰å‘ç°æ˜¯æœ‰æ•ˆçš„ï¼Œä½†æ²¡ç†è§£ä¸ºä»€ä¹ˆåŠ äº†loopå°±æ— æ•ˆäº†","like_count":0,"discussions":[{"author":{"id":1448126,"avatar":"https://static001.geekbang.org/account/avatar/00/16/18/be/ad3127e0.jpg","nickname":"æ…•é«˜è¿ª","note":"","ucode":"EB1CB5EA4E3A90","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":560086,"discussion_content":"fn main() {\n    let pair = Arc::new((Mutex::new(false), Condvar::new()));\n    let pair2 = Arc::clone(&amp;pair);\n\n    thread::spawn(move || {\n        let (lock, cvar) = &amp;*pair2;\n        let mut started = lock.lock().unwrap();\n        *started = true;\n        eprintln!(&#34;I&#39;m a happy worker!&#34;);\n\n        drop(started); \n\n        // é€šçŸ¥ä¸»çº¿ç¨‹\n        cvar.notify_one();\n\n       \n        loop{\n            thread::sleep(Duration::from_secs(1)); \n            println!(&#34;working...&#34;);\n        }\n    });\n\n    // ç­‰å¾…å·¥ä½œçº¿ç¨‹çš„é€šçŸ¥\n    let (lock, cvar) = &amp;*pair;\n    let mut started = lock.lock().unwrap();\n    while !*started {\n        started = cvar.wait(started).unwrap();\n    }\n    eprintln!(&#34;Worker started!&#34;);\n    thread::sleep(Duration::from_secs(10)); \n}","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649165678,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1898574,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/f8/4e/3026516d.jpg","nickname":"ä¸€é›„","note":"","ucode":"DB71F9125BEED5","race_medal":4,"user_type":1,"is_pvip":true},"reply_author":{"id":1448126,"avatar":"https://static001.geekbang.org/account/avatar/00/16/18/be/ad3127e0.jpg","nickname":"æ…•é«˜è¿ª","note":"","ucode":"EB1CB5EA4E3A90","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":560274,"discussion_content":"å—¯ï¼Œåæ¥è§£å†³äº†ï¼Œè°¢è°¢å…„å¼Ÿã€‚è§£å†³æ–¹å¼å’Œä½ ä¸€æ ·ï¼Œæ›´åŠ é€å½»åœ°ç†è§£äº†ï¼Œlockçš„æœºåˆ¶","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649246189,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":560086,"ip_address":""},"score":560274,"extra":""}]}]},{"had_liked":false,"id":321753,"user_name":"åƒå›ç™¾è½¬æ— åŠ«å±±","can_delete":false,"product_type":"c1","uid":1456256,"ip_address":"","ucode":"2C249889C00929","user_header":"","comment_is_top":false,"comment_ctime":1637030758,"is_pvip":true,"replies":[{"id":"118916","content":"ç†è§£æ­£ç¡®","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1079375","ctime":1639852756,"ip_address":"","comment_id":321753,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1637030758","product_id":100085301,"comment_content":"è¯»å®Œæœ¬èŠ‚æœ‰ä¸€ä¸ªæ„Ÿæ‚Ÿï¼Œactor modelæ˜¯å¼‚æ­¥ä»»åŠ¡çº§åˆ«çš„â€œå¾®æœåŠ¡â€ï¼šå‘é€ä¿¡æ¯ç»™ä¸€ä¸ªactorï¼Œç„¶åä»actorå†æ¥æ”¶ä¿¡æ¯ï¼Œå°±ç±»ä¼¼äºåç«¯ä¸­å‘é€ä¸€ä¸ªè¯·æ±‚ç»™ä¸€ä¸ªå¾®æœåŠ¡ï¼Œå†æ¥æ”¶å“åº”ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªactorå¯¹åº”ä¸€ä¸ªâ€œâ€å¾®æœåŠ¡â€œâ€ï¼Œä¸çŸ¥é“è¿™ç§ç†è§£æ˜¯å¦æ­£ç¡®ï¼Ÿè¿˜æœ‰å°±æ˜¯ï¼Œä¸€ä¸ªactorå¯¹åº”çš„æ˜¯ç±»ä¼¼äºtokioçš„ä¸€ä¸ªtaskå—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539877,"discussion_content":"ç†è§£æ­£ç¡®","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639852756,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":321555,"user_name":"ç½—æ°","can_delete":false,"product_type":"c1","uid":1320487,"ip_address":"","ucode":"96BAFAA147341F","user_header":"https://static001.geekbang.org/account/avatar/00/14/26/27/eba94899.jpg","comment_is_top":false,"comment_ctime":1636946064,"is_pvip":false,"replies":[{"id":"118919","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1079375","ctime":1639853083,"ip_address":"","comment_id":321555,"utype":1}],"discussion_count":1,"race_medal":2,"score":"1636946064","product_id":100085301,"comment_content":"å¯¹ï¼Œåˆç†çš„ä½¿ç”¨ Channelï¼Œä¸åº”è¯¥æ­»æ¬ç¡¬å¥—ã€‚","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539880,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639853083,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":321524,"user_name":"GengTeng","can_delete":false,"product_type":"c1","uid":1224623,"ip_address":"","ucode":"3F926F5EF1D075","user_header":"https://static001.geekbang.org/account/avatar/00/12/af/af/8b03ce2c.jpg","comment_is_top":false,"comment_ctime":1636939089,"is_pvip":false,"replies":[{"id":"118921","content":"å“ˆå“ˆ","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1079375","ctime":1639853097,"ip_address":"","comment_id":321524,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1636939089","product_id":100085301,"comment_content":"ç¬¨æ‹™åœ°ç”¨ Channel å åŠ  Channel æ¥åº”å¯¹æ‰€æœ‰çš„åœºæ™¯?Go: ä½ ç›´æ¥è¯´æˆ‘åå„¿å¾—äº†ã€‚","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539882,"discussion_content":"å“ˆå“ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639853097,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1462209,"avatar":"https://static001.geekbang.org/account/avatar/00/16/4f/c1/7f596aba.jpg","nickname":"ç»™æˆ‘ç‚¹é˜³å…‰å°±ç¿çƒ‚","note":"","ucode":"F3B0439BE0D062","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":415042,"discussion_content":"Goè¡¨ç¤ºä¸æ¥é”…ï¼Œæˆ‘ä¹Ÿæœ‰atomic å’Œ mutex","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1636970228,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}