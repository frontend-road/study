{"id":833028,"title":"04ï½œå•æœºååä¼˜åŒ–ï¼ˆäºŒï¼‰ï¼šé«˜æ€§èƒ½æ•°æ®å¤„ç†ä¸‰æ¿æ–§","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å¾é€¸ã€‚</p><p>é€šè¿‡ä¸ŠèŠ‚è¯¾çš„å­¦ä¹ ï¼Œæˆ‘ä»¬çŸ¥é“äº†æå‡å•æœºååçš„æ€è·¯æ˜¯å®šä½åˆ°å•æœºç“¶é¢ˆèµ„æºã€‚å¯¹äºç“¶é¢ˆèµ„æºï¼Œè¦ä¹ˆå¢åŠ èµ„æºï¼Œæ¯”å¦‚æå‡å•æœºCPUã€å†…å­˜ç­‰çš„è§„æ ¼ï¼›è¦ä¹ˆå‡å°‘å•ä¸ªè¯·æ±‚å¯¹ç“¶é¢ˆèµ„æºçš„æ¶ˆè€—ï¼Œè®©ç›¸åŒçš„èµ„æºå¯ä»¥å¤„ç†æ›´å¤šè¯·æ±‚ã€‚</p><p>å¯¹äºCPUå’Œå†…å­˜ç“¶é¢ˆï¼Œæˆ‘ä»¬ä¹Ÿä»‹ç»äº†å®¹å™¨ç±»å‹çš„ä½¿ç”¨æ–¹æ³•ï¼Œä»è€Œé™ä½CPUå’Œå†…å­˜èµ„æºæ¶ˆè€—ï¼Œæå‡å•æœºååã€‚</p><p>æœ‰äº†æ•°æ®ç±»å‹ï¼Œè‡ªç„¶å°‘ä¸äº†å¯¹æ•°æ®çš„å¤„ç†ã€‚ä»Šå¤©æˆ‘ä»¬å°±æ¥èŠèŠå¯¹äºCPUå’Œå†…å­˜ç“¶é¢ˆï¼Œæœ‰å“ªäº›å¸¸ç”¨çš„é«˜æ€§èƒ½æ•°æ®å¤„ç†æŠ€å·§ã€‚åªè¦èƒ½å¤Ÿçµæ´»è¿ç”¨è¿™äº›æŠ€å·§ï¼Œæˆ‘ä»¬å°±èƒ½é™ä½å•ä¸ªè¯·æ±‚å¯¹CPUå’Œå†…å­˜èµ„æºæ¶ˆè€—ï¼Œæå‡å•æœºååã€‚</p><p>ä¸ºäº†ä¾¿äºè¯´æ˜ï¼Œæˆ‘å…ˆæ„é€ ä¸€æ®µä»£ç ï¼Œè¿™æ®µä»£ç ä¼šå¾ªç¯åšå­—ç¬¦ä¸²æ‹¼æ¥ã€æ•´å‹è½¬å­—ç¬¦ä¸²å’Œå­—ç¬¦ä¸²è½¬å­—èŠ‚åˆ‡ç‰‡æ“ä½œã€‚æˆ‘ä»¬ä»Šå¤©ä¼šåŸºäºè¿™æ®µä»£ç çš„æ€§èƒ½ä¼˜åŒ–è¿‡ç¨‹ï¼Œå¸¦ä½ æŒæ¡è¿™äº›é«˜æ€§èƒ½æŠ€å·§ã€‚</p><pre><code class=\"language-go\">package performance\n\nimport (\n    \"fmt\"\n)\n\ntype User struct {\n    Id   int\n    Name string\n}\n\n// GenerateIdsRaw åŸå§‹å¾…ä¼˜åŒ–å‡½æ•°\nfunc GenerateIdsRaw(users []*User) (string, string, []byte) {\n    names := \"\"\n    idStr := \"\"\n    var nameByte []byte\n    for index := range users {\n        idStr = fmt.Sprint(users[index].Id)\n        names = names + \",\" + users[index].Name\n        nameByte = []byte(users[index].Name)\n    }\n    return idStr, names, nameByte\n}\n</code></pre><!-- [[[read_end]]] --><p>æ¥ä¸‹æ¥æ˜¯Benchmarkä»£ç ï¼Œä¹Ÿå°±æ˜¯å¯¹å‰é¢æ„é€ çš„é‚£æ®µä»£ç åšåŸºå‡†æµ‹è¯•ï¼Œè¯„ä¼°å‰é¢ä»£ç åœ¨å¤§è§„æ¨¡ç”¨æˆ·æ•°æ®å¤„ç†æ—¶çš„æ€§èƒ½ã€‚</p><pre><code class=\"language-go\">package performance\n\nimport (\n    \"fmt\"\n    \"testing\"\n)\n\n// åˆå§‹åŒ–æ„é€ æµ‹è¯•ç”¨ä¾‹\nvar users []*User\n\nfunc init() {\n    for i := 0; i &lt; 1000; i++ {\n        users = append(users, &amp;User{Id: i, Name: fmt.Sprintf(\"user%d\", i)})\n    }\n}\n\nfunc BenchmarkGenerateIdsRaw(b *testing.B) {\n    for n := 0; n &lt; b.N; n++ {\n        GenerateIdsRaw(users)\n    }\n}\n</code></pre><p>åé¢è¦è®²çš„æŠ€å·§æ—¢å¯ä»¥é™ä½CPUæ¶ˆè€—ï¼Œä¹Ÿå¯ä»¥é™ä½å†…å­˜æ¶ˆè€—ã€‚ä¸ºäº†å™è¿°æ–¹ä¾¿ï¼Œæˆ‘ä»¬è¿™é‡Œä»¥é™ä½CPUæ¶ˆè€—ä¸ºä¾‹ã€‚ä½†åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå¦‚æœä½ çš„èµ„æºç“¶é¢ˆæ˜¯å†…å­˜ï¼Œä¹Ÿå¯ä»¥ç”¨è¿™äº›æŠ€å·§é™ä½å†…å­˜å ç”¨ã€‚</p><p>ç°åœ¨è®©æˆ‘ä»¬åŸºäºå‰é¢çš„Benchmarkä»£ç æ¥ç”Ÿæˆå¹¶æŸ¥çœ‹ä¸€ä¸‹CPUç«ç„°å›¾ï¼Œçœ‹ä¸‹å“ªæ®µé€»è¾‘æ¶ˆè€—CPUèµ„æºæ¯”è¾ƒé«˜ï¼Œæˆ‘ä»¬å†é’ˆå¯¹æœ€æ¶ˆè€—CPUçš„ä»£ç é€»è¾‘è¿›è¡Œä¼˜åŒ–ã€‚</p><pre><code class=\"language-shell\">go test -run=none -bench=BenchmarkGenerateIdsRaw -benchtime=10s -gcflags=all=-l -cpuprofile cpu.prof\ngo tool pprof -http=\":8081\" cpu.prof\n</code></pre><p><img src=\"https://static001.geekbang.org/resource/image/a0/23/a0e48982f12d0328c132dd8e596bff23.jpg?wh=3814x1600\" alt=\"\" title=\"å›¾1 åŸå§‹å‡½æ•° CPU ç«ç„°å›¾\"></p><p>ä»ç«ç„°å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ¶ˆè€—CPUæœ€å¤šçš„æ˜¯runtime.concatstringså‡½æ•°ï¼Œè€Œè¿™ä¸ªå‡½æ•°æ˜¯Goè¯­è¨€ â€œ+â€ æ“ä½œç¬¦è¿›è¡Œå­—ç¬¦ä¸²æ‹¼æ¥çš„åº•å±‚å®ç°å‡½æ•°ã€‚</p><h2>é«˜æ€§èƒ½å­—ç¬¦ä¸²æ‹¼æ¥</h2><p>é‚£è¿™ä¸ª â€œ+â€ æ“ä½œç¬¦åˆ°åº•æ˜¯æ€ä¹ˆæ‹¼æ¥å­—ç¬¦ä¸²çš„å‘¢ï¼Ÿè¿™é‡Œé¢æ˜¯ä¸æ˜¯æœ‰å•¥ä¼˜åŒ–ç©ºé—´å‘¢ï¼Ÿæƒ³è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å°±éœ€è¦å…ˆå¼„æ¸…æ¥š â€œ+â€ æ“ä½œç¬¦æ‹¼æ¥å­—ç¬¦ä¸²çš„é€»è¾‘ã€‚</p><p>å½“<strong>ç”¨ â€œ+â€ è¿æ¥ç¬¦æ‹¼æ¥ä¸¤ä¸ªå­—ç¬¦ä¸²çš„æ—¶å€™ï¼Œå¾—å…ˆå¼€è¾Ÿä¸€å—æ–°çš„å†…å­˜ç©ºé—´æ¥å­˜æ”¾æ‹¼æ¥åçš„å­—ç¬¦ä¸²ï¼Œç„¶åæŠŠè¿™ä¸¤ä¸ªå­—ç¬¦ä¸²æŒ‰ç…§æ‹¼æ¥çš„é¡ºåºæ‹·è´åˆ°æ–°ç©ºé—´</strong>ã€‚è¿™ä¸ªæ–°ç©ºé—´çš„å¤§å°ç­‰äºåŸæ¥ä¸¤ä¸ªå­—ç¬¦ä¸²é•¿åº¦çš„å’Œã€‚</p><p>æ¯”å¦‚å­—ç¬¦ä¸²â€œabâ€ å’Œ å­—ç¬¦ä¸²â€œcdâ€ è¦æ‹¼æ¥ï¼Œå°±å¾—å…ˆç»™ç»“æœå­—ç¬¦ä¸²æ‰¾ä¸ªåœ°æ–¹ï¼Œç„¶åæŠŠå­—ç¬¦ä¸²â€œabâ€ å’Œ â€œcdâ€ åˆ†åˆ«æ‹·è´è¿‡å»ï¼Œè¿™æ ·å°±å¾—åˆ°äº†æ–°çš„å­—ç¬¦ä¸²ã€‚</p><pre><code class=\"language-go\">s1 := \"ab\" + \"cd\"\n</code></pre><p><img src=\"https://static001.geekbang.org/resource/image/21/35/210c1dfaf94486225dbc39d8711c7735.jpg?wh=1212x540\" alt=\"\" title=\"å›¾2 â€œ+â€ æ“ä½œç¬¦æ‹¼æ¥å­—ç¬¦ä¸²\"></p><p>å¦‚æœæ˜¯å¾ªç¯æ‹¼æ¥å­—ç¬¦ä¸²ï¼Œæ¯æ¬¡å¾ªç¯è¿­ä»£éƒ½è¦åˆ†é…æ–°ç©ºé—´çš„è¯ï¼Œå°±éœ€è¦<strong>ä¸åœåœ°åœ¨å †ä¸Šåˆ†é…å†…å­˜</strong>ã€‚è€Œä¸”æ¯æ¬¡è¿­ä»£è¿˜å¾—æŠŠæ‹¼æ¥çš„å­—ç¬¦ä¸²éƒ½æ‹·è´åˆ°ç»“æœç©ºé—´ï¼Œéœ€è¦<strong>ä¸åœåœ°æ‹·è´</strong>ã€‚è€Œå †å†…å­˜åˆ†é…å’Œæ‹·è´éƒ½æ˜¯æ¯”è¾ƒæ¶ˆè€—CPUçš„æ“ä½œã€‚</p><p>å› æ­¤ï¼Œè¦å‡å°‘å­—ç¬¦ä¸²æ‹¼æ¥æ“ä½œå¯¹CPUèµ„æºçš„æ¶ˆè€—ï¼Œå°±éœ€è¦å‡å°‘å­—ç¬¦ä¸²æ‹¼æ¥çš„å†…å­˜åˆ†é…å’Œæ‹·è´ã€‚Go è¯­è¨€æœ‰æ²¡æœ‰ä»€ä¹ˆå¥½åŠæ³•å‘¢ï¼Ÿ</p><p>æœ‰ã€‚Go è¯­è¨€é‡Œæœ‰ä¸ª <strong>strings.Builder ç±»å‹</strong>ï¼Œè¿™ä¸ª strings.Builder ç±»å‹å¯ä»¥å‡å°‘å†…å­˜åˆ†é…å’Œæ‹·è´ï¼Œé«˜æ•ˆåœ°æ‹¼æ¥å­—ç¬¦ä¸²ã€‚</p><p>ç»™ä½ çœ‹çœ‹å®ƒæ˜¯æ€ä¹ˆç”¨çš„ï¼š</p><pre><code class=\"language-go\">package main\n\nimport (\n        \"fmt\"\n        \"strings\"\n)\n\nfunc main() {\n    var b strings.Builder\n    for i := 3; i &gt;= 1; i-- {\n            fmt.Fprintf(&amp;b, \"%d...\", i)\n    }\n    b.WriteString(\"ignition\")\n    fmt.Println(b.String()) // è¾“å‡º 3...2...1...ignition\n}\n</code></pre><p>è¿™ä¸ª strings.Builder ç±»å‹æœ‰ä¸¤ä¸ªå¾ˆå‰å®³çš„åœ°æ–¹ã€‚</p><p>ç¬¬ä¸€ä¸ªæ˜¯å®ƒæœ‰<strong>å†…å­˜é¢„åˆ†é…</strong>çš„åŠŸèƒ½ã€‚è¿™ä¸ªç±»å‹æœ‰ä¸€ä¸ª Grow æ–¹æ³•ï¼Œå¯ä»¥æå‰æŠŠå†…å­˜åˆ†é…å¥½ï¼Œå®ç°é¢„åˆ†é…åŠŸèƒ½ã€‚è¿™æ ·æ¯æ¬¡å¾ªç¯è¿­ä»£æ—¶å°±ä¸ç”¨é‡æ–°åˆ†é…å†…å­˜ï¼Œå†…å­˜é¢‘ç¹åˆ†é…çš„é—®é¢˜å°±è§£å†³äº†ã€‚</p><pre><code class=\"language-go\">// Grow grows b's capacity, if necessary, to guarantee space for another n bytes. \n// After Grow(n), at least n bytes can be written to b without another allocation. \nfunc (b *Builder) Grow(n int)\n</code></pre><p>ç¬¬äºŒä¸ªå‰å®³çš„åœ°æ–¹æ˜¯ï¼Œ<strong>å­—ç¬¦ä¸²æ‹¼æ¥æ—¶ï¼Œå†…å­˜æ‹·è´æ¬¡æ•°æ›´å°‘</strong>ã€‚</p><p>ä¸ºå•¥å‘¢ï¼Ÿå› ä¸º Builder åº•å±‚æ˜¯ç”¨ [] byte ç±»å‹æ¥å­˜å­—ç¬¦ä¸²çš„ã€‚å¾€ Builder é‡Œå†™ä¸œè¥¿çš„æ—¶å€™ï¼Œåªæœ‰å®ƒçš„ buf å®¹é‡ä¸å¤Ÿã€éœ€è¦æ‰©å®¹æ—¶ï¼Œæ‰ä¼šå‘ç”Ÿå†…å­˜è¿ç§»æ‹·è´ï¼Œä¸åƒä¹‹å‰æ¯æ¬¡å¾ªç¯éƒ½å¾—æ‹·è´å­—ç¬¦ä¸²ã€‚è¦æ˜¯æå‰ç”¨ Grow æ–¹æ³•åˆ†é…å¥½è¶³å¤Ÿçš„å†…å­˜ï¼Œåœ¨å¾ªç¯æ‹¼æ¥çš„æ—¶å€™ï¼Œå°±ä¸ä¼šå‘ç”Ÿæ‰©å®¹è¿ç§»ï¼Œå¯¼è‡´æ‹·è´äº†ã€‚</p><pre><code class=\"language-go\">type Builder struct {\n    buf  []byte\n}\n\n// WriteString appends the contents of s to b's buffer.\n// It returns the length of s and a nil error.\nfunc (b *Builder) WriteString(s string) (int, error) {\n    b.buf = append(b.buf, s...)\n    return len(s), nil\n}\n</code></pre><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬ç”¨è¿™ä¸ª strings.Builder æ¥é‡æ–°å®ç°ä¸€ä¸‹æˆ‘ä»¬çš„å‡½æ•°ï¼š</p><pre><code class=\"language-go\">// GenerateIdsBuilder ä½¿ç”¨strings.Builderæ‹¼æ¥å­—ç¬¦ä¸²\nfunc GenerateIdsBuilder(users []*User) (string, string, []byte) {\n    names := \"\"\n    idStr := \"\"\n    var nameByte []byte\n    length := 0\n    for index := range users {\n        idStr = fmt.Sprint(users[index].Id)\n        nameByte = []byte(users[index].Name)\n        length += len(users[index].Name) + 1\n    }\n    var builder strings.Builder\n    builder.Grow(length) // é¢„åˆ†é…\n    for index := range users {\n        builder.WriteString(\",\")\n        builder.WriteString(users[index].Name)\n    }\n    return idStr, names, nameByte\n}\n</code></pre><p>åˆ°åº• strings.Builderç±»å‹æœ‰æ²¡æœ‰æˆ‘ä»¬è¯´çš„è¿™ä¹ˆå‰å®³å‘¢ï¼Ÿå’±ä»¬æ¥åšä¸ªæµ‹è¯•ï¼Œç”¨ Benchmark æ¥æµ‹ä¸€æµ‹ â€œ+â€ æ“ä½œç¬¦å®ç°å­—ç¬¦ä¸²æ‹¼æ¥å’Œstrings.Builderå®ç°å­—ç¬¦ä¸²æ‹¼æ¥çš„æ€§èƒ½ã€‚</p><p>ä¸‹é¢æ˜¯æˆ‘ä»¬çš„Benchmarkè„šæœ¬ï¼š</p><pre><code class=\"language-go\">package performance\n\nimport (\n    \"fmt\"\n    \"testing\"\n)\n\n// åˆå§‹åŒ–æ„é€ æµ‹è¯•ç”¨ä¾‹\nvar users []*User\n\nfunc init() {\n    for i := 0; i &lt; 1000; i++ {\n        users = append(users, &amp;User{Id: i, Name: fmt.Sprintf(\"user%d\", i)})\n    }\n}\n\nfunc BenchmarkGenerateIdsRaw(b *testing.B) {\n    for n := 0; n &lt; b.N; n++ {\n        GenerateIdsRaw(users)\n    }\n}\n\nfunc BenchmarkGenerateIdsBuilder(b *testing.B) {\n    for n := 0; n &lt; b.N; n++ {\n        GenerateIdsBuilder(users)\n    }\n}\n</code></pre><p>æµ‹è¯•ç»“æœå‡ºæ¥äº†ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°<strong>ç”¨strings.Builderæ‹¼æ¥å­—ç¬¦ä¸²çš„æ–¹å¼ï¼Œæ€§èƒ½æœ‰å·¨å¤§çš„æå‡</strong>ã€‚</p><pre><code class=\"language-shell\">killianxu@KILLIANXU-MB0 performance % go test -run=none -benchmem&nbsp; -bench=. -gcflags=all=-l\ngoos: darwin\ngoarch: amd64\npkg: example.com/performance\ncpu: Intel(R) Core(TM) i5-7360U CPU @ 2.30GHz\nBenchmarkGenerateIdsRaw-4&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 862&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1190253 ns/op&nbsp; 4194661 B/op&nbsp; &nbsp; &nbsp; &nbsp; 3739 allocs/op\nBenchmarkGenerateIdsBuilder-4&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;6018&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 167267 ns/op&nbsp; &nbsp; 30069 B/op&nbsp; &nbsp; &nbsp; &nbsp; 2735 allocs/op\n</code></pre><ul>\n<li>\n<p>ä» CPU èµ„æºæ¶ˆè€—æ¥çœ‹ï¼Œâ€œ+â€ æ“ä½œç¬¦æ‹¼æ¥å­—ç¬¦ä¸²çš„æ–¹å¼ï¼Œå•æ¬¡å‡½æ•°è°ƒç”¨è¦1190253nsï¼Œè€Œstrings.Builder æ‹¼æ¥æ–¹å¼åªè¦167267nsï¼ŒèŠ‚çº¦äº† 86% å·¦å³çš„ CPU èµ„æºã€‚</p>\n</li>\n<li>\n<p>ä»å†…å­˜æ¶ˆè€—æ¥çœ‹ï¼Œâ€œ+â€ æ“ä½œç¬¦æ‹¼æ¥å­—ç¬¦ä¸²çš„æ–¹å¼ï¼Œå•æ¬¡å‡½æ•°è°ƒç”¨è¦4194661å­—èŠ‚å†…å­˜ï¼Œè€Œç”¨ strings.Builder æ‹¼æ¥å­—ç¬¦ä¸²çš„æ–¹å¼ï¼Œæ¯æ¬¡å‡½æ•°è°ƒç”¨åªè¦30069å­—èŠ‚å†…å­˜ï¼ŒèŠ‚çº¦äº† 99% å·¦å³çš„å†…å­˜èµ„æºã€‚</p>\n</li>\n</ul><p>å…¶å®ï¼Œåœ¨Golangå®˜æ–¹æ–‡æ¡£æ³¨é‡Šä¸­ï¼Œä¹Ÿç‰¹æ„æåˆ°äº†strings.Builderã€‚</p><blockquote>\n<p>A Builder is used to efficiently build a string using&nbsp;Builder.Write&nbsp;methods. It minimizes memory copying. The zero value is ready to use. Do not copy a non-zero Builder.</p>\n</blockquote><p>è€Œä¸”ï¼ŒGoæœ¬èº«çš„åº“å‡½æ•°ï¼Œä¹Ÿæœ‰å¾ˆå¤šæ˜¯ç”¨strings.Builderå®ç°çš„ã€‚æ¯”å¦‚æˆ‘ä»¬å¸¸ç”¨çš„strings.Joinå’Œstrings.Replaceå‡½æ•°ã€‚</p><pre><code class=\"language-go\">func Join(elems []string, sep string) string {\n    n := len(sep) * (len(elems) - 1)\n    for i := 0; i &lt; len(elems); i++ {\n        n += len(elems[i])\n    }\n\n    var b Builder\n    b.Grow(n)\n    b.WriteString(elems[0])\n    for _, s := range elems[1:] {\n        b.WriteString(sep)\n        b.WriteString(s)\n    }\n    return b.String()\n}\n\nfunc Replace(s, old, new string, n int) string {\n    if old == new || n == 0 {\n        return s // avoid allocation\n    }\n\n    // Compute number of replacements.\n    if m := Count(s, old); m == 0 {\n        return s // avoid allocation\n    } else if n &lt; 0 || m &lt; n {\n        n = m\n    }\n\n    // Apply replacements to buffer.\n    var b Builder\n    b.Grow(len(s) + n*(len(new)-len(old)))\n    start := 0\n    for i := 0; i &lt; n; i++ {\n        j := start\n        if len(old) == 0 {\n            if i &gt; 0 {\n                _, wid := utf8.DecodeRuneInString(s[start:])\n                j += wid\n            }\n        } else {\n            j += Index(s[start:], old)\n        }\n        b.WriteString(s[start:j])\n        b.WriteString(new)\n        start = j + len(old)\n    }\n    b.WriteString(s[start:])\n    return b.String()\n}\n</code></pre><p>ç°åœ¨è®©æˆ‘ä»¬å†çœ‹ä¸€ä¸‹CPUç«ç„°å›¾ï¼Œçœ‹çœ‹å°†å­—ç¬¦ä¸²æ‹¼æ¥æ–¹å¼ä¼˜åŒ–åï¼Œæˆ‘ä»¬çš„ä»£ç æ˜¯å¦è¿˜æœ‰ä¼˜åŒ–ç©ºé—´ã€‚</p><pre><code class=\"language-shell\">go test  -run=none -bench=BenchmarkGenerateIdsBuilder -benchtime=10s -gcflags=all=-l -cpuprofile cpu.prof\ngo tool pprof -http=\":8081\" cpu.prof\n</code></pre><p><img src=\"https://static001.geekbang.org/resource/image/cc/cc/cc79cb9813e62875bccd8c38f6a25dcc.jpg?wh=5655x1693\" alt=\"\" title=\"å›¾3 ç”¨ strings.Builder ä¼˜åŒ–åçš„ç«ç„°å›¾\"></p><p>ä»ç«ç„°å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œç”¨strings.Builderä¼˜åŒ–åï¼Œæ¶ˆè€—CPUæœ€å¤šçš„å‡½æ•°å˜æˆäº†fmt.Sprintå‡½æ•°ã€‚</p><h2>é«˜æ€§èƒ½æ•´å‹è½¬å­—ç¬¦ä¸²</h2><p>è¿™ä¸ªå‡½æ•°åœ¨æˆ‘ä»¬ä»£ç é‡Œçš„ä½œç”¨æ˜¯å°†æ•´å‹è½¬åŒ–ä¸ºå­—ç¬¦ä¸²ã€‚è¿™ä¸ªfmt.Sprintå‡½æ•°ä¸ºä»€ä¹ˆä¼šæ¶ˆè€—CPUï¼Ÿè¿™é‡Œé¢æ˜¯ä¸æ˜¯ä¹Ÿæœ‰ä¼˜åŒ–ç©ºé—´å‘¢ï¼Ÿ</p><pre><code class=\"language-go\">idStr := fmt.Sprint(user.Id)\n</code></pre><p>fmt.SprintåŠå…¶å˜ä½“å‡½æ•°ï¼Œéœ€è¦ç”¨åå°„æ¥è¯†åˆ«å®ƒä»¬æ­£åœ¨å¤„ç†çš„ç±»å‹ï¼Œç„¶åç¡®å®šå¦‚ä½•å°†å…¶æ ¼å¼åŒ–ä¸ºå­—ç¬¦ä¸²ã€‚è€Œè¿™ä¸¤è€…éƒ½å¢åŠ äº†æ—¶é—´å’Œå†…å­˜å¼€é”€ã€‚</p><pre><code class=\"language-go\">func (p *pp) doPrint(a []any) {\n    prevString := false\n    for argNum, arg := range a {\n        // åå°„\n        isString := arg != nil &amp;&amp; reflect.TypeOf(arg).Kind() == reflect.String\n        // Add a space between two non-string arguments.\n        if argNum &gt; 0 &amp;&amp; !isString &amp;&amp; !prevString {\n            p.buf.writeByte(' ')\n        }\n        // æ ¼å¼åŒ–é€»è¾‘\n        p.printArg(arg, 'v')\n        prevString = isString\n    }\n}\n</code></pre><p>æœ‰æ²¡æœ‰å¼€é”€æ›´å°çš„æ•´å‹è½¬å­—ç¬¦ä¸²çš„æ–¹å¼å‘¢ï¼Ÿ</p><p>è¿™æ—¶å€™ä¸€ä¸ªå«strconv&nbsp;åº“çš„ä¸œè¥¿å°±æ´¾ä¸Šç”¨åœºäº†ã€‚strconvåº“é‡Œé¢çš„å‡½æ•°æ˜¯ä¸ºç‰¹å®šçš„è½¬æ¢ä»»åŠ¡è®¾è®¡çš„ï¼Œæ‰€ä»¥å®ƒä»¬æ¯”æ›´é€šç”¨çš„&nbsp;fmt&nbsp;å‡½æ•°æ‰§è¡Œå¾—æ›´å¿«ã€‚</p><p>è®©æˆ‘ä»¬ç”¨strconvåº“æ¥é‡æ–°å®ç°ä¸€ä¸‹æˆ‘ä»¬çš„å‡½æ•°ï¼š</p><pre><code class=\"language-go\">// GenerateIdsStrconv ä½¿ç”¨strconvå®ç°æ•´å‹è½¬å­—ç¬¦ä¸²\nfunc GenerateIdsStrconv(users []*User) (string, string, []byte) {\n    names := \"\"\n    idStr := \"\"\n    var nameByte []byte\n    length := 0\n    for index := range users {\n        idStr = strconv.Itoa(users[index].Id)\n        nameByte = []byte(users[index].Name)\n        length += len(users[index].Name) + 1\n    }\n    var builder strings.Builder\n    builder.Grow(length) // é¢„åˆ†é…\n    for index := range users {\n        builder.WriteString(\",\")\n        builder.WriteString(users[index].Name)\n    }\n    return idStr, names, nameByte\n}\n</code></pre><p>strconvåº“çš„ä½¿ç”¨ï¼Œåˆèƒ½ç»™å’±ä»¬å¸¦æ¥å¤šå¤§çš„æ€§èƒ½æå‡å‘¢ï¼Ÿå’±ä»¬ç»§ç»­ç”¨Benchmarkæ¥æµ‹ä¸€æµ‹ã€‚</p><p>ä¸‹é¢æ˜¯Benchmarkè„šæœ¬ï¼š</p><pre><code class=\"language-go\">func BenchmarkGenerateIdsStrconv(b *testing.B) {\n    for n := 0; n &lt; b.N; n++ {\n        GenerateIdsStrconv(users)\n    }\n}\n</code></pre><p>ç„¶åä½ ä¼šå‘ç°ï¼Œ<strong>ä½¿ç”¨strconvåº“å°†æ•´å‹è½¬æ¢ä¸ºå­—ç¬¦ä¸²çš„æ–¹å¼ï¼Œæ€§èƒ½æå‡æ˜æ˜¾ã€‚</strong></p><pre><code class=\"language-shell\">killianxu@KILLIANXU-MB0 performance % go test -run=none -benchmem&nbsp; -bench=. -gcflags=all=-l&nbsp;\ngoos: darwin\ngoarch: amd64\npkg: example.com/performance\ncpu: Intel(R) Core(TM) i5-7360U CPU @ 2.30GHz\nBenchmarkGenerateIdsBuilder-4&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;7215&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 165601 ns/op&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;30069 B/op&nbsp; &nbsp; &nbsp; &nbsp;2735 allocs/op\nBenchmarkGenerateIdsStrconv-4&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 15163&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;79333 ns/op&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;23392 B/op&nbsp; &nbsp; &nbsp; &nbsp;1901 allocs/op\n</code></pre><ul>\n<li>\n<p>ä» CPU èµ„æºæ¶ˆè€—æ¥çœ‹ï¼Œfmtçš„æ–¹å¼ï¼Œå•æ¬¡å‡½æ•°è°ƒç”¨è¦165601nsï¼Œè€Œstrconvçš„æ–¹å¼ï¼Œåªè¦ 79333nsï¼ŒèŠ‚çº¦äº† 52% å·¦å³çš„ CPU èµ„æºã€‚</p>\n</li>\n<li>\n<p>ä»å†…å­˜æ¶ˆè€—æ¥çœ‹ï¼Œfmtçš„æ–¹å¼ï¼Œå•æ¬¡å‡½æ•°è°ƒç”¨è¦30069å­—èŠ‚å†…å­˜ï¼Œè€Œstrconvçš„æ–¹å¼ï¼Œæ¯æ¬¡å‡½æ•°è°ƒç”¨åªè¦23392å­—èŠ‚å†…å­˜ï¼ŒèŠ‚çº¦äº† 22% å·¦å³çš„å†…å­˜èµ„æºã€‚</p>\n</li>\n</ul><p>ç°åœ¨è®©æˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹ç«ç„°å›¾ï¼Œçœ‹çœ‹å°†æ•´å‹è½¬åŒ–ä¸ºå­—ç¬¦ä¸²çš„æ–¹å¼æ”¹ä¸ºstrconvåº“åï¼Œæˆ‘ä»¬çš„ä»£ç æ˜¯å¦è¿˜æœ‰ä¼˜åŒ–ç©ºé—´ã€‚</p><pre><code class=\"language-shell\">go test  -run=none -bench=GenerateIdsStrconv -benchtime=10s -gcflags=all=-l -cpuprofile cpu.prof\ngo tool pprof -http=\":8081\" cpu.prof\n</code></pre><p><img src=\"https://static001.geekbang.org/resource/image/1b/96/1bce63a310977cf52b070bef2106e696.jpg?wh=3761x1213\" alt=\"\" title=\"å›¾4 ç”¨ strconv åº“ä¼˜åŒ–åçš„ç«ç„°å›¾\"></p><p>ä»ç«ç„°å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œç”¨strconvåº“ä¼˜åŒ–åï¼Œé™¤äº†å·²ç»ä¼˜åŒ–è¿‡çš„å­—ç¬¦ä¸²æ‹¼æ¥å’Œæ•´å‹è½¬å­—ç¬¦ä¸²æ“ä½œï¼Œè¿˜æœ‰ä¸ªruntime.stringtoslicebyteå‡½æ•°æ¶ˆè€—CPUèµ„æºä¹Ÿæ¯”è¾ƒå¤šã€‚</p><h2>é«˜æ€§èƒ½å­—ç¬¦ä¸²è½¬å­—èŠ‚åˆ‡ç‰‡</h2><p>è¿™ä¸ªå‡½æ•°å…¶å®å°±æ˜¯æˆ‘ä»¬çš„å­—ç¬¦ä¸²è½¬å­—èŠ‚åˆ‡ç‰‡æ“ä½œã€‚runtime.stringtoslicebyteå‡½æ•°æ˜¯æ€ä¹ˆå®ç°å­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—èŠ‚åˆ‡ç‰‡çš„å‘¢ï¼Ÿè¿™é‡Œé¢æ˜¯ä¸æ˜¯ä¹Ÿæœ‰ä¼˜åŒ–ç©ºé—´å‘¢ï¼Ÿ</p><pre><code class=\"language-shell\">nameByte = []byte(users[index].Name)\n</code></pre><p>åœ¨ææ˜ç™½runtime.stringtoslicebyteå‡½æ•°çš„å®ç°é€»è¾‘ä¹‹å‰ï¼Œå’±ä»¬å…ˆçœ‹çœ‹å­—ç¬¦ä¸²å’Œåˆ‡ç‰‡çš„æ•°æ®ç»“æ„ã€‚</p><p><strong>å­—ç¬¦ä¸²åœ¨Golangåº•å±‚å¯¹åº”çš„æ˜¯ stringStruct ç»“æ„ï¼Œè¿™ä¸ªç»“æ„é‡Œæœ‰ä¸¤ä¸ªæˆå‘˜å˜é‡ï¼Œstr æŒ‡é’ˆå’Œlenï¼ŒstræŒ‡é’ˆæŒ‡å‘å­—ç¬¦ä¸²çš„å†…å®¹ï¼Œlen å­˜å‚¨å­—ç¬¦ä¸²çš„é•¿åº¦ã€‚</strong></p><p><strong>åˆ‡ç‰‡å¯¹åº”çš„æ˜¯ slice ç»“æ„ï¼Œè¿™ä¸ªç»“æ„é‡Œæœ‰ä¸‰ä¸ªæˆå‘˜å˜é‡ï¼Œarrayã€len å’Œ capã€‚array æ˜¯æŒ‡å‘æ•°ç»„çš„æŒ‡é’ˆï¼Œè¿™ä¸ªæ•°ç»„é‡Œé¢å­˜çš„å°±æ˜¯åˆ‡ç‰‡å†…å®¹ï¼Œlen è¡¨ç¤ºåˆ‡ç‰‡çš„é•¿åº¦ï¼Œcap è¡¨ç¤ºåˆ‡ç‰‡çš„å®¹é‡ã€‚</strong></p><pre><code class=\"language-go\">// å­—ç¬¦ä¸²æ•°æ®ç»“æ„\ntype stringStruct struct {\n    str unsafe.Pointer //æŒ‡é’ˆç±»å‹ï¼ŒæŒ‡å‘å­—èŠ‚æ•°ç»„\n    len int\n}\n\n// åˆ‡ç‰‡æ•°æ®ç»“æ„\ntype slice struct {\n    array unsafe.Pointer // æ•°ç»„æŒ‡é’ˆç±»å‹ï¼ŒæŒ‡å‘æ•°æ®æ•°ç»„\n    len   int\n    cap   int\n}\n</code></pre><p>å›åˆ°å‰é¢çš„é—®é¢˜ï¼Œruntime.stringtoslicebyteå‡½æ•°æ˜¯æ€ä¹ˆå®ç°å­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—èŠ‚åˆ‡ç‰‡çš„å‘¢ï¼Ÿè¿™é‡Œé¢æœ‰ä¸‰ä¸ªæ­¥éª¤ã€‚</p><ul>\n<li>\n<p>ç¬¬ä¸€æ­¥ï¼Œæ ¹æ®å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œä¸ºå­—èŠ‚æ•°ç»„ç”³è¯·å†…å­˜ã€‚</p>\n</li>\n<li>\n<p>ç¬¬äºŒæ­¥ï¼Œæ„å»ºå­—èŠ‚åˆ‡ç‰‡å¯¹è±¡ï¼Œè®¾ç½®sliceç»“æ„çš„æˆå‘˜å˜é‡ã€‚</p>\n</li>\n<li>\n<p>ç¬¬ä¸‰æ­¥ï¼ŒæŠŠå­—ç¬¦ä¸²çš„å†…å®¹æ‹·è´åˆ°å­—èŠ‚åˆ‡ç‰‡çš„åº•å±‚æ•°ç»„é‡Œã€‚</p>\n</li>\n</ul><p>è¿™ä¸ªå‡½æ•°çš„å…·ä½“å®ç°é€»è¾‘å¦‚ä¸‹ï¼š</p><pre><code class=\"language-go\">func stringtoslicebyte(s string) []byte {\n    var b []byte\n    // åˆ†é…å†…å­˜ï¼Œæ„å»ºå­—èŠ‚åˆ‡ç‰‡å¯¹è±¡\n    b := rawbyteslice(len(s))\n    // å­—ç¬¦ä¸²æ‹·è´åˆ°å­—èŠ‚åˆ‡ç‰‡çš„arrayæ•°ç»„\n    copy(b, s)\n    return b\n}\n// rawbyteslice allocates a new byte slice. The byte slice is not zeroed.\nfunc rawbyteslice(size int) (b []byte) {\n    cap := roundupsize(uintptr(size))\n    // åˆ†é…å†…å­˜\n    p := mallocgc(cap, nil, false)\n    *(*slice)(unsafe.Pointer(&amp;b)) = slice{p, size, int(cap)}\n    return\n}\n</code></pre><p>å¯ä»¥çœ‹å‡º<strong>ï¼Œå½“å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—èŠ‚åˆ‡ç‰‡æ—¶ï¼Œä¼šå‘ç”Ÿåº•å±‚å­—èŠ‚æ•°ç»„ç©ºé—´çš„å†…å­˜ç”³è¯·å’Œæ‹·è´ã€‚è€Œä¸”éšç€å­—ç¬¦ä¸²é•¿åº¦å˜é•¿ï¼Œå†…å­˜æ‹·è´çš„æ€§èƒ½æŸè€—ä¹Ÿä¼šå˜å¤§</strong>ã€‚</p><p>æœ‰æ²¡æœ‰ä¸€ç§æ–¹æ³•ï¼Œå¯ä»¥ä¸ç”¨ç”³è¯·å­—èŠ‚æ•°ç»„å†…å­˜å’Œåšå†…å­˜æ‹·è´ï¼Œå®ç°é«˜æ€§èƒ½è½¬æ¢å‘¢ï¼Ÿ</p><p>åœ¨è¯´è¿™ä¸ªæ–¹æ³•ä¹‹å‰ï¼Œå’±ä»¬å…ˆäº†è§£ä¸€äº›å‰ç½®çŸ¥è¯†ï¼Œunsafe åŒ…å’Œ Go è¯­è¨€é‡Œå‡ ä¸ªç±»å‹çš„å¤§å°ã€‚</p><p><strong>unsafe åŒ…å¯ä»¥åšä¸€äº›ç»•è¿‡ Go ç±»å‹å®‰å…¨æ£€æŸ¥çš„æ“ä½œï¼Œæ›´çµæ´»åœ°æ“ä½œå†…å­˜ã€‚</strong>å®ƒæœ‰ä¸¤ä¸ªå¾ˆé‡è¦çš„åŠŸèƒ½ã€‚</p><p><strong>ç¬¬ä¸€ä¸ªæ˜¯å®šä¹‰äº† Pointer ç±»å‹ï¼Œä»»ä½•ç±»å‹çš„æŒ‡é’ˆéƒ½èƒ½å’Œè¿™ä¸ª Pointer äº’ç›¸è½¬æ¢</strong>ï¼Œæœ‰ç‚¹åƒ C è¯­è¨€é‡Œçš„ä¸‡èƒ½æŒ‡é’ˆvoid*ã€‚</p><pre><code class=\"language-go\">var a int = 1\np := unsafe.Pointer(&amp;a) // å…¶å®ƒç±»å‹æŒ‡é’ˆè½¬Pointer\nb := (*int)(p) // Pointerç±»å‹è½¬å…¶å®ƒç±»å‹æŒ‡é’ˆ\nfmt.Println(*b) // è¾“å‡º1\n</code></pre><p><strong>ç¬¬äºŒä¸ªåŠŸèƒ½æ˜¯å®šä¹‰äº† uintptr ç±»å‹ï¼ŒPointer å’Œ uintptr å¯ä»¥äº’ç›¸è½¬æ¢</strong>ï¼Œè¿™æ ·å°±èƒ½åšæŒ‡é’ˆçš„åŠ å‡ç­‰ç®—æœ¯è¿ç®—äº†ã€‚</p><pre><code class=\"language-go\">type Person struct {\n    age int\n    name string\n}\nperson := Person{age:18,name:\"kå“¥\"}\np := unsafe.Pointer(&amp;person) // å…¶å®ƒç±»å‹æŒ‡é’ˆè½¬Pointer\nu := uintptr(p) // Pointerç±»å‹è½¬ä¸ºuintptr\nu=u+8 // uintptråŠ å‡æ“ä½œ\npName := unsafe.Pointer(u) // uintptrè½¬æ¢ä¸ºPointer\nname := *(*string)(pName)\nfmt.Println(name) // è¾“å‡ºkå“¥\n</code></pre><p><strong>åœ¨ Go è¯­è¨€é‡Œï¼Œintã€uintptrã€unsafe.Pointer è¿™ä¸‰ä¸ªç±»å‹æ‰€å çš„å¤§å°æ˜¯ç›¸ç­‰çš„ï¼Œ32 ä½æœºå™¨ä¸Šæ˜¯ 4 å­—èŠ‚ï¼Œ64 ä½æœºå™¨ä¸Šæ˜¯ 8 å­—èŠ‚ã€‚</strong></p><p>å’±ä»¬å¯ä»¥å†™ä¸ªå°æµ‹è¯•æ¥çœ‹çœ‹ï¼š</p><pre><code class=\"language-go\">func TestSize(t *testing.T) {\n    var i int\n    var u uintptr\n    var p unsafe.Pointer\n    fmt.Printf(\"int size: %d byte\\n\", unsafe.Sizeof(i))\n    fmt.Printf(\"uintptr size: %d byte\\n\", unsafe.Sizeof(u))\n    fmt.Printf(\"unsafe.Pointer size: %d byte\\n\", unsafe.Sizeof(p))\n}\n</code></pre><p>è¿è¡Œè¿™ä¸ªæµ‹è¯•å‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°intã€uintptrå’Œunsafe.Pointeréƒ½æ˜¯å äº†8å­—èŠ‚ã€‚</p><pre><code class=\"language-shell\">=== RUN   TestSize\nint size: 8 byte\nuintptr size: 8 byte\nunsafe.Pointer size: 8 byte\n</code></pre><p>æœ‰äº†è¿™äº›åŠŸèƒ½ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”¨ unsafe åŒ…å’Œè¿™å‡ ä¸ªç±»å‹å¤§å°ç›¸ç­‰çš„ç‰¹æ€§ï¼Œé‡æ–°è§£é‡Šåº•å±‚çš„æ•°æ®ç»“æ„ï¼Œé¿å…å­—èŠ‚æ•°ç»„çš„å†…å­˜åˆ†é…å’Œæ‹·è´ï¼Œå®ç°é«˜æ€§èƒ½ç±»å‹è½¬æ¢ã€‚</p><p>è®©æˆ‘ä»¬ç”¨unsafeåŒ…å®ç°ä¸€ä¸ªå­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—èŠ‚åˆ‡ç‰‡çš„å‡½æ•°ã€‚</p><ul>\n<li>\n<p>ç¬¬ä¸€æ­¥ï¼Œå¯ä»¥æŠŠå­—ç¬¦ä¸²å¯¹è±¡æƒ³è±¡æˆä¸€ä¸ªé•¿åº¦ä¸º 2 çš„ uintptr ç±»å‹æ•°ç»„ xï¼Œè¿™ä¸ªæ•°ç»„çš„ 0 å·ä½ç½®å…¶å®å°±æ˜¯å­—ç¬¦ä¸²çš„ str æˆå‘˜å˜é‡ï¼Œ1 å·ä½ç½®å°±æ˜¯å­—ç¬¦ä¸²çš„ len æˆå‘˜å˜é‡ã€‚</p>\n</li>\n<li>\n<p>ç¬¬äºŒæ­¥ï¼Œæ„é€ ä¸€ä¸ªé•¿åº¦ä¸º 3 çš„ uintptr ç±»å‹æ•°ç»„ bï¼Œ0 å·ä½ç½®ä»£è¡¨å­—èŠ‚æ•°ç»„æŒ‡é’ˆï¼Œ1 å·ä½ç½®ä»£è¡¨å­—èŠ‚åˆ‡ç‰‡é•¿åº¦ï¼Œ2 å·ä½ç½®ä»£è¡¨å­—èŠ‚åˆ‡ç‰‡å®¹é‡ã€‚</p>\n</li>\n<li>\n<p>ç¬¬ä¸‰æ­¥ï¼ŒæŠŠè¿™ä¸ª uintptr ç±»å‹æ•°ç»„é‡æ–°è§£é‡Šæˆå­—èŠ‚åˆ‡ç‰‡ã€‚</p>\n</li>\n</ul><pre><code class=\"language-go\">func Str2Bytes(s string) []byte {\n    x := (*[2]uintptr)(unsafe.Pointer(&amp;s))\n    b := [3]uintptr{x[0], x[1], x[1]}\n    res := *(*[]byte)(unsafe.Pointer(&amp;b))\n    return res\n}\n</code></pre><p><img src=\"https://static001.geekbang.org/resource/image/38/60/38d75690338afaf1e57d9275a4eb3a60.jpg?wh=2703x1358\" alt=\"\" title=\"å›¾5 unsafe åŒ…å­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—èŠ‚åˆ‡ç‰‡\"></p><p>è®©æˆ‘ä»¬ç”¨unsafeåŒ…æ¥é‡æ–°å®ç°ä¸€ä¸‹æˆ‘ä»¬çš„å‡½æ•°ï¼š</p><pre><code class=\"language-go\">func GenerateIdsUnsafe(users []*User) (string, string, []byte) {\n    names := \"\"\n    idStr := \"\"\n    var nameByte []byte\n    length := 0\n    for index := range users {\n        idStr = strconv.Itoa(users[index].Id)\n        // unsafeåŒ…å®ç°å­—ç¬¦ä¸²è½¬å­—èŠ‚åˆ‡ç‰‡\n        nameByte = Str2Bytes(users[index].Name)\n        length += len(users[index].Name) + 1\n    }\n    var builder strings.Builder\n    builder.Grow(length) // é¢„åˆ†é…\n    for index := range users {\n        builder.WriteString(\",\")\n        builder.WriteString(users[index].Name)\n    }\n    return idStr, names, nameByte\n}\n</code></pre><p>ä½¿ç”¨unsafeåŒ…å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—èŠ‚åˆ‡ç‰‡ï¼Œåˆèƒ½ç»™å’±ä»¬å¸¦æ¥å¤šå¤§çš„æ€§èƒ½æå‡å‘¢ï¼Ÿå’±ä»¬ç”¨ Benchmark æ¥æµ‹ä¸€æµ‹ã€‚ä¸‹é¢æ˜¯Benchmarkè„šæœ¬ï¼š</p><pre><code class=\"language-go\">func BenchmarkGenerateIdsUnsafe(b *testing.B) {\n    for n := 0; n &lt; b.N; n++ {\n        GenerateIdsUnsafe(users)\n    }\n}\n</code></pre><p>æœç„¶ï¼Œä½¿ç”¨ <strong>unsafeåŒ…å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—èŠ‚åˆ‡ç‰‡çš„æ–¹å¼ï¼Œæ€§èƒ½æå‡éå¸¸æ˜æ˜¾ã€‚</strong></p><pre><code class=\"language-shell\">killianxu@KILLIANXU-MB0 performance % go test -run=none -benchmem&nbsp; -bench=. -gcflags=all=-l\ngoos: darwin\ngoarch: amd64\npkg: example.com/performance\ncpu: Intel(R) Core(TM) i5-7360U CPU @ 2.30GHz\nBenchmarkGenerateIdsStrconv-4&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 14966&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;78975 ns/op&nbsp; &nbsp; 23392 B/op&nbsp; &nbsp; &nbsp; &nbsp; 1901 allocs/op\nBenchmarkGenerateIdsUnsafe-4&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;26529&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;44976 ns/op&nbsp; &nbsp; 11072 B/op&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;901 allocs/op\n</code></pre><ul>\n<li>\n<p>ä» CPU èµ„æºæ¶ˆè€—æ¥çœ‹ï¼Œruntime.stringtoslicebyteçš„æ–¹å¼ï¼Œå•æ¬¡å‡½æ•°è°ƒç”¨è¦78975nsï¼Œè€ŒunsafeåŒ…çš„æ–¹å¼ï¼Œåªè¦44976nsï¼ŒèŠ‚çº¦äº† 43% å·¦å³çš„ CPU èµ„æºã€‚</p>\n</li>\n<li>\n<p>ä»å†…å­˜æ¶ˆè€—æ¥çœ‹ï¼Œruntime.stringtoslicebyteçš„æ–¹å¼ï¼Œå•æ¬¡å‡½æ•°è°ƒç”¨è¦23392å­—èŠ‚å†…å­˜ï¼Œè€ŒunsafeåŒ…çš„æ–¹å¼ï¼Œæ¯æ¬¡å‡½æ•°è°ƒç”¨åªè¦11072å­—èŠ‚å†…å­˜ï¼ŒèŠ‚çº¦äº† 52.7% å·¦å³çš„å†…å­˜èµ„æºã€‚</p>\n</li>\n</ul><p>å®é™…ä¸Šï¼ŒunsafeåŒ…é™¤äº†å¯ä»¥é«˜æ•ˆåœ°å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—èŠ‚åˆ‡ç‰‡ï¼Œä¹Ÿå¯ä»¥é«˜æ•ˆåœ°å°†å­—èŠ‚åˆ‡ç‰‡è½¬æ¢ä¸ºå­—ç¬¦ä¸²ã€‚</p><pre><code class=\"language-go\">func Bytes2Str(b []byte) string {\n    return *(*string)(unsafe.Pointer(&amp;b))\n}\n</code></pre><p>å…¶å®ç”¨unsafeåŒ…å°†å­—èŠ‚åˆ‡ç‰‡è½¬æ¢ä¸ºå­—ç¬¦ä¸²çš„æ“ä½œï¼Œåœ¨Golangåº“é‡Œä¹Ÿå¾ˆå¸¸è§ï¼Œæ¯”å¦‚æˆ‘ä»¬åœ¨å‰é¢ä»‹ç»çš„é«˜æ€§èƒ½å­—ç¬¦ä¸²æ‹¼æ¥ï¼ŒBuilderç±»å‹æœ€åè½¬åŒ–ä¸ºå­—ç¬¦ä¸²çš„æºç ï¼Œå°±æ˜¯ç”¨unsafeåŒ…å®ç°çš„ã€‚</p><pre><code class=\"language-go\">// String returns the accumulated string.\nfunc (b *Builder) String() string {\n    return *(*string)(unsafe.Pointer(&amp;b.buf))\n}\n</code></pre><p>è®©æˆ‘ä»¬ç”¨ç«ç„°å›¾å†çœ‹çœ‹æˆ‘ä»¬çš„å‡½æ•°æ˜¯å¦è¿˜æœ‰ä¼˜åŒ–ç©ºé—´ã€‚</p><pre><code class=\"language-go\">go test  -run=none -bench=BenchmarkGenerateIdsUnsafe -benchtime=10s -gcflags=all=-l -cpuprofile cpu.prof\ngo tool pprof -http=\":8081\" cpu.prof\n</code></pre><p><img src=\"https://static001.geekbang.org/resource/image/e2/e5/e27f9f3d73702f46099ee110e20163e5.jpg?wh=3775x1339\" alt=\"\" title=\"å›¾6 ç”¨ unsafe åŒ…ä¼˜åŒ–åçš„ç«ç„°å›¾\"></p><p>ä»ç«ç„°å›¾ä¸Šå¯ä»¥çœ‹å‡ºï¼Œç»è¿‡å‰é¢å‡ æ¬¡çš„ä¼˜åŒ–ï¼Œæˆ‘ä»¬çš„å‡½æ•°æœ€è€—æ—¶çš„æ“ä½œå°±åªå‰©ä¸‹å·²ç»ä¼˜åŒ–è¿‡ä¹‹åçš„å­—ç¬¦ä¸²è½¬å­—èŠ‚åˆ‡ç‰‡ã€æ•´å‹è½¬å­—ç¬¦ä¸²å’Œå­—ç¬¦ä¸²æ‹¼æ¥è¿™3ä¸ªæ“ä½œï¼Œå› æ­¤æ²¡æœ‰è¿›ä¸€æ­¥ä¼˜åŒ–çš„ç©ºé—´äº†ã€‚</p><p>è®©æˆ‘ä»¬æ¥å’Œæœ€åˆå®ç°çš„å‡½æ•°é€»è¾‘å¯¹æ¯”ä¸‹ï¼Œçœ‹ä¸‹ç»è¿‡å‰é¢å‡ æ¬¡çš„ä¼˜åŒ–ï¼Œæˆ‘ä»¬çš„æ€§èƒ½æ€»ä½“æå‡äº†å¤šå°‘ã€‚</p><pre><code class=\"language-go\">killianxu@KILLIANXU-MB0 performance % go test -run=none -benchmem&nbsp; -bench=. -gcflags=all=-l&nbsp;\ngoos: darwin\ngoarch: amd64\npkg: example.com/performance\ncpu: Intel(R) Core(TM) i5-7360U CPU @ 2.30GHz\nBenchmarkGenerateIdsRaw-4&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 951&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1226580 ns/op&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4194656 B/op&nbsp; &nbsp; &nbsp; &nbsp;3739 allocs/op\nBenchmarkGenerateIdsUnsafe-4&nbsp; &nbsp; &nbsp; &nbsp;26372&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;45221 ns/op&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;11072 B/op&nbsp; &nbsp; &nbsp; &nbsp; 901 allocs/op\n</code></pre><p>ä»Benchmarkæµ‹è¯•ï¼Œå¯ä»¥çœ‹å‡ºæ¥ï¼Œæˆ‘ä»¬å¯¹CPUèµ„æºçš„æ¶ˆè€—é™ä½äº†27å€ï¼Œå¯¹å†…å­˜çš„æ¶ˆè€—é™ä½äº†379å€ã€‚</p><h2>å°ç»“</h2><p>ä»Šå¤©è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¥ä¸€æ®µå¾…ä¼˜åŒ–çš„å‡½æ•°ä»£ç ä¸ºä¾‹ï¼Œåœ¨é€æ­¥ä¼˜åŒ–å…¶å¯¹CPUèµ„æºçš„æ¶ˆè€—è¿‡ç¨‹ä¸­ï¼Œå‘ä½ å±•ç¤ºäº†èƒ½é™ä½CPUå’Œå†…å­˜èµ„æºæ¶ˆè€—çš„3ä¸ªé«˜æ€§èƒ½æ•°æ®å¤„ç†æŠ€å·§ã€‚</p><ul>\n<li>\n<p>é«˜æ€§èƒ½å­—ç¬¦ä¸²æ‹¼æ¥æŠ€å·§ã€‚å½“æˆ‘ä»¬ä»£ç æœ‰å¤§é‡å­—ç¬¦ä¸²æ‹¼æ¥æ“ä½œæ—¶ï¼Œå¯ä»¥ä½¿ç”¨ <strong>strings.Builder</strong> ç±»å‹ï¼Œå¹¶åˆ©ç”¨å®ƒçš„å†…å­˜é¢„åˆ†é…åŠŸèƒ½åšå­—ç¬¦ä¸²æ‹¼æ¥ã€‚</p>\n</li>\n<li>\n<p>é«˜æ€§èƒ½æ•´å‹è½¬å­—ç¬¦ä¸²æŠ€å·§ã€‚å½“æˆ‘ä»¬ä»£ç æœ‰å¤§é‡æ•´å‹è½¬å­—ç¬¦ä¸²æ“ä½œæ—¶ï¼Œå¯ä»¥ç”¨ <strong>strconv</strong> åº“åšè½¬æ¢ï¼Œé¿å…ä½¿ç”¨fmt.Sprintå‡½æ•°çš„åå°„å’Œæ ¼å¼åŒ–èµ„æºæ¶ˆè€—ã€‚</p>\n</li>\n<li>\n<p>é«˜æ€§èƒ½å­—ç¬¦ä¸²è½¬å­—èŠ‚åˆ‡ç‰‡æŠ€å·§ã€‚å½“æˆ‘ä»¬ä»£ç æœ‰å¤§é‡å­—ç¬¦ä¸²è½¬å­—èŠ‚åˆ‡ç‰‡æ“ä½œæ—¶ï¼Œå¯ä»¥ç”¨ <strong>unsafe</strong> åŒ…ï¼Œé€šè¿‡å­—ç¬¦ä¸²å’Œå­—èŠ‚åˆ‡ç‰‡åº•å±‚æ•°ç»„ç©ºé—´å…±ç”¨ï¼Œå®ç°é«˜æ€§èƒ½è½¬æ¢ã€‚å¹¶ä¸”ï¼Œä¹Ÿå¯ä»¥ç”¨unsafeåŒ…å°†å­—èŠ‚åˆ‡ç‰‡è½¬æ¢ä¸ºå­—ç¬¦ä¸²ã€‚</p>\n</li>\n</ul><p>å¸Œæœ›ä½ å¥½å¥½ä½“ä¼šè¿™ä¸ªç”¨ç«ç„°å›¾å¯»æ‰¾ç“¶é¢ˆï¼Œå†ç»“åˆGoè¯­è¨€åº•å±‚å®ç°åˆ†æå¯»æ‰¾æ›´ä¼˜æ–¹æ¡ˆçš„è¿‡ç¨‹ã€‚åœ¨é‡åˆ°å†…å­˜å’ŒCPUç“¶é¢ˆæ—¶ï¼Œåˆ«å¿˜äº†å°è¯•è¿ç”¨è¿™äº›é«˜æ€§èƒ½æ“ä½œæŠ€å·§ï¼Œå¸®ä½ èŠ‚çº¦æ›´å¤šCPUå’Œå†…å­˜èµ„æºï¼Œæå‡å•æœºååã€‚</p><h2>æ€è€ƒé¢˜</h2><p>é™¤äº†è¿™èŠ‚è¯¾é‡Œæåˆ°çš„3ç§é«˜æ€§èƒ½æ•°æ®å¤„ç†æŠ€å·§ï¼Œä½ è¿˜çŸ¥é“å“ªäº›é«˜æ€§èƒ½æ•°æ®å¤„ç†æŠ€å·§å‘¢ï¼Ÿ</p><p>æ¬¢è¿ä½ æŠŠä½ çš„ç­”æ¡ˆåˆ†äº«åœ¨è¯„è®ºåŒºï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾çš„å†…å®¹åˆ†äº«ç»™éœ€è¦çš„æœ‹å‹ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼</p>","neighbors":{"left":{"article_title":"03ï½œå•æœºååä¼˜åŒ–ï¼ˆä¸€ï¼‰ï¼šæ— éœ€ç¡¬ä»¶å‡çº§ä¹Ÿèƒ½æå‡åå","id":832423},"right":{"article_title":"05ï½œå•æœºååä¼˜åŒ–ï¼ˆä¸‰ï¼‰ï¼šç§‘å­¦å¤ç”¨å¯¹è±¡å’Œåç¨‹èµ„æº","id":833743}},"comments":[{"had_liked":false,"id":396450,"user_name":"lJ","can_delete":false,"product_type":"c1","uid":2562558,"ip_address":"æ±Ÿè‹","ucode":"CC29D06A16FF93","user_header":"https://static001.geekbang.org/account/avatar/00/27/19/fe/d31344db.jpg","comment_is_top":false,"comment_ctime":1734507998,"is_pvip":false,"replies":[{"id":143922,"content":"ğŸ‘ğŸ‘ï¼Œç¬¬ä¸€ä¸ªé«˜æ€§èƒ½jsonå¤„ç†ï¼Œå¯ä»¥è¯•ä¸‹å­—èŠ‚å¼€æºçš„sonicåº“https:&#47;&#47;github.com&#47;bytedance&#47;sonicï¼Œæˆ‘ä»¬æœ‰ä¸ªåœºæ™¯ï¼ŒæŠŠjson-iteratoræ¢æˆsonicåšlistå¾ªç¯ååºåˆ—åŒ–ï¼Œæ¥å£å»¶æ—¶ä»21msé™åˆ°äº†17ms","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1313417,"ctime":1734533485,"ip_address":"å¹¿ä¸œ","comment_id":396450,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100843701,"comment_content":"1. ä½¿ç”¨æ ‡å‡†åº“çš„ encoding&#47;json ç¼–è§£ç æ€§èƒ½è¾ƒä½ï¼Œæ¨èä½¿ç”¨github.com&#47;json-iterator&#47;goã€‚\n2. ä½¿ç”¨ io.Reader å’Œ io.Writer è¿›è¡Œæµå¼ä¼ è¾“ï¼Œio.Copy æ–¹æ³•æ˜¯ä¸€ä¸ªé«˜æ•ˆå®ç°çš„æ‹·è´å·¥å…·ï¼Œå¯ä»¥åœ¨ä¸¤ä¸ªæµä¹‹é—´ä¼ è¾“æ•°æ®ã€‚æ¯”å¦‚ï¼Œå¦‚æœ src å®ç°äº† WriterTo æ¥å£ï¼ˆå¦‚ TCPConnï¼‰ï¼Œä¼šç›´æ¥è°ƒç”¨ src.WriteTo(dst)ã€‚è¿™é¿å…äº† io.Copy æ‰‹åŠ¨åˆ†é…ç¼“å†²åŒºå¹¶å¾ªç¯è¯»å–&#47;å†™å…¥çš„è¿‡ç¨‹ï¼Œå°†é«˜æ•ˆä¼ è¾“çš„è´£ä»»äº¤ç»™åº•å±‚ç±»å‹çš„å®ç°ã€‚ä¼˜å…ˆå°è¯•è°ƒç”¨å†…æ ¸çš„ splice ç³»ç»Ÿè°ƒç”¨ï¼Œé¿å…æ•°æ®ä»å†…æ ¸ç©ºé—´æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´å†æ‹·è´å›å†…æ ¸ç©ºé—´çš„å¼€é”€ã€‚å¦‚æœ spliceTo æ— æ³•å¤„ç†ï¼Œåˆ™å›é€€åˆ°é€šç”¨çš„æ‹·è´é€»è¾‘ genericWriteToã€‚","like_count":1,"discussions":[{"author":{"id":1313417,"avatar":"https://static001.geekbang.org/account/avatar/00/14/0a/89/eb8c28a4.jpg","nickname":"å¾é€¸","note":"","ucode":"DCFDEE08FD263A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":655291,"discussion_content":"ğŸ‘ğŸ‘ï¼Œç¬¬ä¸€ä¸ªé«˜æ€§èƒ½jsonå¤„ç†ï¼Œå¯ä»¥è¯•ä¸‹å­—èŠ‚å¼€æºçš„sonicåº“https://github.com/bytedance/sonicï¼Œæˆ‘ä»¬æœ‰ä¸ªåœºæ™¯ï¼ŒæŠŠjson-iteratoræ¢æˆsonicåšlistå¾ªç¯ååºåˆ—åŒ–ï¼Œæ¥å£å»¶æ—¶ä»21msé™åˆ°äº†17ms","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1734533485,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":2,"child_discussions":[{"author":{"id":2562558,"avatar":"https://static001.geekbang.org/account/avatar/00/27/19/fe/d31344db.jpg","nickname":"lJ","note":"","ucode":"CC29D06A16FF93","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1313417,"avatar":"https://static001.geekbang.org/account/avatar/00/14/0a/89/eb8c28a4.jpg","nickname":"å¾é€¸","note":"","ucode":"DCFDEE08FD263A","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":655301,"discussion_content":"ğŸ‘ğŸ‘ğŸ‘ï¼Œè€å¸ˆ ä»€ä¹ˆæ ·çš„åœºæ™¯éœ€è¦é«˜æ€§èƒ½çš„jsonå®ç°ï¼Œæœ‰ä¸ªç–‘é—®ï¼Œk8sæºç ä¼¼ä¹æ²¡æœ‰ä½¿ç”¨ç¬¬ä¸‰æ–¹jsonï¼Œè¿™é‡Œæœ‰å“ªäº›è€ƒè™‘å‘¢ï¼Ÿå¯èƒ½è€ƒè™‘åˆ°äº†å…¼å®¹æ€§å’Œç»´æŠ¤æ€§ã€‚æ–¹ä¾¿ç»†è¯´ä¸‹ä½ ä»¬å½“æ—¶é‡åˆ°çš„é—®é¢˜ï¼Œåˆ†ææ–¹æ³•ï¼Œæ–¹æ¡ˆé€‰å‹è€ƒé‡å˜›ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1734576491,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":655291,"ip_address":"æ±Ÿè‹","group_id":0},"score":655301,"extra":""},{"author":{"id":1313417,"avatar":"https://static001.geekbang.org/account/avatar/00/14/0a/89/eb8c28a4.jpg","nickname":"å¾é€¸","note":"","ucode":"DCFDEE08FD263A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":2562558,"avatar":"https://static001.geekbang.org/account/avatar/00/27/19/fe/d31344db.jpg","nickname":"lJ","note":"","ucode":"CC29D06A16FF93","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":655337,"discussion_content":"ä¸»è¦æ˜¯jsonåºåˆ—åŒ–ååºåˆ—åŒ–cpuæ¶ˆè€—æ¯”è¾ƒå¤§ã€‚ä¸ºäº†é€šç”¨ï¼Œåˆä¸æ–¹ä¾¿æ¢æˆPBçš„æƒ…å†µä¸‹ï¼Œåœ¨é€šç”¨å’Œæ€§èƒ½ä¸Šæƒè¡¡ï¼Œå°±éœ€è¦ç”¨é«˜æ€§èƒ½jsonåº“","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1734617581,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":655301,"ip_address":"å¹¿ä¸œ","group_id":0},"score":655337,"extra":""}]}]},{"had_liked":false,"id":396461,"user_name":"jxs1211","can_delete":false,"product_type":"c1","uid":1101006,"ip_address":"é‡åº†","ucode":"B7F1F2D84389E7","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKELX1Rd1vmLRWibHib8P95NA87F4zcj8GrHKYQL2RcLDVnxNy1ia2geTWgW6L2pWn2kazrPNZMRVrIg/132","comment_is_top":false,"comment_ctime":1734576813,"is_pvip":false,"replies":[{"id":143927,"content":"ğŸ‘ä¹Ÿå¯ä»¥çš„ï½","user_name":"ä½œè€…å›å¤","user_name_real":"ä½œè€…","uid":1313417,"ctime":1734617387,"ip_address":"å¹¿ä¸œ","comment_id":396461,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100843701,"comment_content":"è¿™ç§å†™æ³•å¯ä»¥å—ï¼Œbenchmarkæµ‹ä¸‹æ¥æ„Ÿè§‰å·®ä¸å¤š\nfunc Str2Bytes(s string) []byte {\n\treturn *(*[]byte)(unsafe.Pointer(&amp;s))\n}","like_count":0,"discussions":[{"author":{"id":1313417,"avatar":"https://static001.geekbang.org/account/avatar/00/14/0a/89/eb8c28a4.jpg","nickname":"å¾é€¸","note":"","ucode":"DCFDEE08FD263A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":655336,"discussion_content":"ğŸ‘ä¹Ÿå¯ä»¥çš„ï½","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1734617387,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]}]}