{"id":802420,"title":"03ï½œæ•°æ®åº“è¿æ¥é—®é¢˜è¯Šæ–­åˆ†æ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯ä¿Šè¾¾ã€‚</p><p>ä»Šå¤©æˆ‘ä»¬æ¥èŠä¸€èŠæ•°æ®åº“è¿æ¥çš„ä¸€äº›äº‹æƒ…ã€‚åœ¨è¿™é‡Œï¼Œè¿æ¥è¿™ä¸ªè¯æœ‰ä¸¤ä¸ªæ„æ€ã€‚é¦–å…ˆè¿æ¥æ˜¯ä¸€ä¸ªåŠ¨è¯ï¼Œè¡¨ç¤ºå®¢æˆ·ç«¯è¿æ¥åˆ°æ•°æ®åº“çš„è¿™ä¸ªè¿‡ç¨‹ã€‚å…¶æ¬¡è¿æ¥è¿˜æ˜¯ä¸€ä¸ªåè¯ï¼Œè¡¨ç¤ºå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å»ºç«‹çš„ä¸€ä¸ªé€šé“ï¼Œå®¢æˆ·ç«¯çš„å‘½ä»¤ã€SQLã€æœåŠ¡å™¨ç«¯è¿”å›çš„æ•°æ®éƒ½ä¼šç»è¿‡è¿™ä¸ªé€šé“æ¥ä¼ è¾“ã€‚è¿™ä¸€è®²ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥åˆ†ææ•°æ®åº“è¿æ¥ä¸ä¸Šçš„é—®é¢˜ï¼Œä»¥åŠè¿æ¥å¼‚å¸¸ä¸­æ–­çš„é—®é¢˜ã€‚</p><h2>ä¸ºä»€ä¹ˆè¿æ¥ä¸ä¸Šæ•°æ®åº“ï¼Ÿ</h2><p>å®¢æˆ·ç«¯æ‰§è¡Œå‘½ä»¤æˆ–SQLå‰ï¼Œéœ€è¦å…ˆåˆ›å»ºä¸€ä¸ªåˆ°æ•°æ®åº“æœåŠ¡ç«¯çš„è¿æ¥ï¼Œå¹¶å®Œæˆç”¨æˆ·è®¤è¯ã€‚MySQLæœåŠ¡ç«¯ä½¿ç”¨æ’ä»¶çš„æ–¹å¼è®¤è¯å®¢æˆ·ç«¯çš„ç”¨æˆ·èº«ä»½ã€‚ä¸åŒçš„æ’ä»¶åœ¨éªŒè¯ç”¨æˆ·å¯†ç æ—¶ï¼Œç»†èŠ‚ä¸Šä¼šæœ‰æ‰€ä¸åŒã€‚MySQLä¸­ï¼Œè®¤è¯æ’ä»¶å’Œç”¨æˆ·ç›¸å…³ï¼Œä¸åŒç”¨æˆ·å¯ä»¥ä½¿ç”¨ä¸åŒçš„æ’ä»¶è¿›è¡Œå¯†ç éªŒè¯ã€‚åˆ›å»ºç”¨æˆ·æ—¶ï¼Œå¦‚æœä¸æ˜¾å¼æŒ‡å®šï¼Œä¼šä½¿ç”¨å‚æ•°default_authentication_pluginæŒ‡å®šçš„æ’ä»¶ã€‚ä»MySQL 8.0å¼€å§‹ï¼Œä½¿ç”¨caching_sha2_passwordä½œä¸ºé»˜è®¤çš„è®¤è¯æ’ä»¶ï¼Œè€Œ5.7ä½¿ç”¨çš„é»˜è®¤æ’ä»¶æ˜¯mysql_native_passwordã€‚</p><pre><code class=\"language-plain\">mysql&gt; show variables like 'default_authentication_plugin';\n+-------------------------------+-----------------------+\n| Variable_name                 | Value                 |\n+-------------------------------+-----------------------+\n| default_authentication_plugin | caching_sha2_password |\n+-------------------------------+-----------------------+\n</code></pre><!-- [[[read_end]]] --><p>å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨åˆ›å»ºç”¨æˆ·çš„æ—¶å€™æŒ‡å®šè®¤è¯æ’ä»¶ï¼Œæˆ–è€…é€šè¿‡alter userå‘½ä»¤ä¿®æ”¹ç”¨æˆ·çš„è®¤è¯æ’ä»¶ã€‚</p><pre><code class=\"language-plain\">mysql&gt; create user 'user_01'@'%' identified by 'somepass';\nQuery OK, 0 rows affected (0.27 sec)\n\nmysql&gt; create user 'user_02'@'%' identified with 'mysql_native_password' by 'somepass';\nQuery OK, 0 rows affected (0.56 sec)\n\nmysql&gt; create user 'user_03'@'%' identified by 'somepass';\nQuery OK, 0 rows affected (0.26 sec)\n\nmysql&gt; alter user 'user_03'@'%' identified with 'sha256_password' by 'somepass';\nQuery OK, 0 rows affected (0.06 sec)\n</code></pre><p>ä»mysql.userè¡¨å¯ä»¥æŸ¥çœ‹æ¯ä¸ªç”¨æˆ·ä½¿ç”¨äº†å“ªä¸ªè®¤è¯æ’ä»¶ã€‚</p><pre><code class=\"language-plain\">mysql&gt; select user,host,plugin,substring(authentication_string, 1, 18) as passwd \n  from mysql.user where user like 'user%';\n+---------+------+-----------------------+--------------------+\n| user    | host | plugin                | passwd             |\n+---------+------+-----------------------+--------------------+\n| user_01 | %    | caching_sha2_password | $A$005$M,PHGCm7 |\n| user_02 | %    | mysql_native_password | *13883BDDBE566ECEC |\n| user_03 | %    | sha256_password       | $5$N3kzW9A@+;+P'g |\n+---------+------+-----------------------+--------------------+\n</code></pre><h3>caching_sha2_passwordå®Œæ•´ç™»å½•æµç¨‹</h3><p>æˆ‘ä»¬ä»¥MySQL 8.0é»˜è®¤çš„æ’ä»¶caching_sha2_passwordä¸ºä¾‹ï¼Œåˆ†æè¿æ¥å»ºç«‹çš„è¿‡ç¨‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/31/60/31c372d077bb545308762309785e3c60.jpg?wh=3135x2851\" alt=\"\"></p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä½¿ç”¨caching_sha2_passwordæ’ä»¶æ—¶ï¼Œç™»å½•è¿‡ç¨‹ä¸­æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯éœ€è¦è¿›è¡Œè¿™äº›äº¤äº’ã€‚</p><ol>\n<li>å®¢æˆ·ç«¯é¦–å…ˆè¦å’ŒæœåŠ¡ç«¯å»ºç«‹ä¸€ä¸ªTCPè¿æ¥ã€‚TCPè¿æ¥å»ºç«‹æˆåŠŸåï¼Œæ‰èƒ½è¿›è¡Œåç»­çš„æ­¥éª¤ã€‚</li>\n<li>æœåŠ¡ç«¯å‘é€æ¡æ‰‹åè®®åŒ…ï¼ˆServerHandshakeï¼‰ï¼Œæ¡æ‰‹åè®®åŒ…é‡Œé¢åŒ…å«äº†æœåŠ¡å™¨ç‰ˆæœ¬ã€ä½¿ç”¨çš„åè®®ç‰ˆæœ¬ã€æœåŠ¡ç«¯æ”¯æŒçš„ç‰¹æ€§ï¼ˆå¦‚æ˜¯å¦æ”¯æŒåŠ å¯†è¿æ¥ï¼‰ã€æœåŠ¡ç«¯ä½¿ç”¨çš„è®¤è¯æ’ä»¶ï¼ˆcaching_sha2_passwordï¼‰ã€ä¸€ä¸²éšæœºæ•°æ®ã€‚</li>\n<li>å®¢æˆ·ç«¯è¯»å–å’Œè§£ææœåŠ¡ç«¯çš„åè®®åŒ…ï¼Œå‘é€æ¡æ‰‹åè®®å›åŒ…ï¼Œå›åŒ…é‡Œé¢æœ‰ç”¨æˆ·åã€é€šè¿‡ä¸€å®šè§„åˆ™è®¡ç®—å¾—åˆ°çš„å¯†ç å“ˆå¸Œå€¼ã€å®¢æˆ·ç«¯æ”¯æŒçš„ç‰¹æ€§ã€å®¢æˆ·ç«¯ä½¿ç”¨çš„è®¤è¯æ’ä»¶ã€å®¢æˆ·ç«¯ç‰ˆæœ¬ç­‰ä¿¡æ¯ã€‚ä¸åŒç‰ˆæœ¬çš„å®¢æˆ·ç«¯å¯èƒ½ä¼šä½¿ç”¨ä¸åŒçš„é»˜è®¤è®¤è¯æ’ä»¶ã€‚å¦‚MySQL 5.7ç‰ˆæœ¬çš„å®¢æˆ·ç«¯é»˜è®¤ä½¿ç”¨mysql_native_passwordæ’ä»¶ï¼ŒMySQL 8.0é»˜è®¤ä½¿ç”¨caching_sha2_passwordæ’ä»¶ã€‚å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä½¿ç”¨çš„é»˜è®¤æ’ä»¶å¯ä»¥ä¸ä¸€æ ·ã€‚</li>\n<li>æœåŠ¡ç«¯åœ¨æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ¡æ‰‹åè®®å›åŒ…ä¹‹å‰ï¼Œå¹¶ä¸çŸ¥é“å®¢æˆ·ç«¯ä½¿ç”¨çš„ç”¨æˆ·åï¼Œå› æ­¤ä¹Ÿä¸çŸ¥é“ç”¨æˆ·ä½¿ç”¨çš„è®¤è¯æ’ä»¶ã€‚æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„å›åŒ…åï¼ŒæœåŠ¡ç«¯ä»é‡Œé¢è§£æå‡ºç”¨æˆ·åï¼Œåˆ°ç”¨æˆ·åˆ—è¡¨ä¸­è·å–åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œå¾—åˆ°ç”¨æˆ·çš„è®¤è¯æ’ä»¶ã€‚å¦‚æœç”¨æˆ·ä½¿ç”¨çš„è®¤è¯æ’ä»¶å’ŒæœåŠ¡å™¨çš„é»˜è®¤æ’ä»¶ä¸ä¸€æ ·ï¼Œæˆ–è€…å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä½¿ç”¨çš„è®¤è¯æ’ä»¶ä¸ä¸€æ ·ï¼ŒæœåŠ¡ç«¯å°±éœ€è¦å‘Šè¯‰å®¢æˆ·ç«¯åˆ‡æ¢è®¤è¯æ–¹å¼ã€‚</li>\n<li>å¦‚æœå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„è®¤è¯æ’ä»¶ä¸ä¸€è‡´ï¼Œå®¢æˆ·ç«¯éœ€è¦æ ¹æ®æœåŠ¡ç«¯çš„è¦æ±‚ï¼Œé‡æ–°è®¡ç®—å¯†ç å“ˆå¸Œåå†å‘é€åˆ°æœåŠ¡ç«¯ã€‚æœåŠ¡ç«¯æ¥æ”¶åˆ°å®¢æˆ·ç«¯æ–°å‘é€è¿‡æ¥çš„è®¤è¯åŒ…ä¹‹åï¼Œå°±å¯ä»¥éªŒè¯ç”¨æˆ·å¯†ç æ˜¯å¦åŒ¹é…äº†ã€‚å¯¹äºcaching_sha2_passwordæ’ä»¶ï¼Œè¿™é‡Œåˆ†ä¸ºä¸¤ç§æƒ…å†µã€‚</li>\n</ol><ul>\n<li>ç”¨æˆ·é¦–æ¬¡ç™»å½•æ—¶ï¼ŒæœåŠ¡ç«¯æ²¡æœ‰ç¼“å­˜ç”¨æˆ·çš„å¯†ç ä¿¡æ¯ï¼Œæ­¤æ—¶éœ€è¦è¿›è¡Œå®Œæ•´çš„ç™»å½•æµç¨‹ï¼Œå°±æ˜¯ä¸Šå›¾ä¸­çš„6ã€7ã€8ã€9è¿™å‡ ä¸ªæ­¥éª¤ã€‚</li>\n<li>ç”¨æˆ·ç™»å½•æˆåŠŸåï¼Œä¼šåœ¨æœåŠ¡ç«¯ç¼“å­˜å“ˆå¸Œåçš„å¯†ç ä¿¡æ¯ã€‚ä¸‹ä¸€æ¬¡ç”¨æˆ·ç™»å½•æ—¶ï¼Œå°±å¯ä»¥æ ¹æ®ç¼“å­˜çš„å¯†ç å“ˆå¸Œæ¥éªŒè¯ï¼Œä¸éœ€è¦è¿›è¡Œå®Œæ•´çš„ç™»å½•æµç¨‹ã€‚ç¼“å­˜çš„å¯†ç å“ˆå¸Œä¼šåœ¨æ‰§è¡ŒALTER USERã€Flush Privilegesæˆ–é‡å¯æ•°æ®åº“åå¤±æ•ˆã€‚</li>\n</ul><ol start=\"6\">\n<li>ä½¿ç”¨caching_sha2_passwordæ—¶ï¼Œå¦‚æœæœåŠ¡ç«¯è¿˜æ²¡æœ‰ç¼“å­˜ç”¨æˆ·çš„å¯†ç å“ˆå¸Œï¼Œä¼šé€šçŸ¥å®¢æˆ·ç«¯å‘é€æ˜æ–‡çš„å¯†ç ã€‚</li>\n<li>å¦‚æœå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å»ºç«‹äº†åŠ å¯†è¿æ¥ï¼Œåˆ™å¯ä»¥ç›´æ¥å‘é€æ˜æ–‡å¯†ç ã€‚ä½†å¦‚æœå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¹‹é—´çš„è¿æ¥æ²¡æœ‰åŠ å¯†ï¼Œç›´æ¥å‘é€æ˜æ–‡å¯†ç æ˜¯ä¸å®‰å…¨çš„ï¼Œæ­¤æ—¶å®¢æˆ·ç«¯å¯ä»¥å‘æœåŠ¡ç«¯è¯·æ±‚RSAå…¬é’¥ï¼Œç”¨äºåŠ å¯†æ˜æ–‡çš„å¯†ç ã€‚</li>\n<li>æœåŠ¡ç«¯å°†RSAå…¬é’¥å‘é€ç»™å®¢æˆ·ç«¯ã€‚</li>\n<li>å®¢æˆ·ç«¯ä½¿ç”¨æ¥æ”¶åˆ°çš„RSAå…¬é’¥åŠ å¯†æ˜æ–‡å¯†ç ï¼Œå‘é€åˆ°æœåŠ¡ç«¯ã€‚</li>\n<li>æœåŠ¡ç«¯å¾—åˆ°åŸå§‹å¯†ç åï¼Œæ ¹æ®ä¸€å®šçš„è§„åˆ™è®¡ç®—å“ˆå¸Œå€¼ï¼Œç„¶åå†è·Ÿå­˜å‚¨åœ¨ç”¨æˆ·è¡¨ä¸­çš„authentication_stringè¿›è¡Œå¯¹æ¯”ã€‚ç”¨æˆ·è®¤è¯æˆåŠŸåï¼ŒæœåŠ¡ç«¯å°†å¯†ç å“ˆå¸Œç¼“å­˜èµ·æ¥ã€‚ç”¨æˆ·å†æ¬¡ç™»å½•æ—¶ï¼Œå°±å¯ä»¥åŸºäºç¼“å­˜çš„å¯†ç å“ˆå¸Œæ¥éªŒè¯ç”¨æˆ·ç™»å½•ä¿¡æ¯ã€‚</li>\n</ol><p>å¦‚æœæœåŠ¡ç«¯ã€å®¢æˆ·ç«¯ä»¥åŠç”¨æˆ·çš„è®¤è¯æ’ä»¶éƒ½ä¸€æ ·ï¼Œå¹¶ä¸”ç”¨æˆ·ä¿¡æ¯å·²ç»ç¼“å­˜åœ¨æœåŠ¡ç«¯ï¼Œé‚£ä¹ˆä¸Šè¿°4ï½9ä¹‹é—´çš„æ­¥éª¤éƒ½ä¼šè·³è¿‡ï¼Œåªéœ€æ‰§è¡Œæ­¥éª¤1ã€2ã€3ã€10ã€‚</p><h3>åŠ å¯†è¿æ¥</h3><p>MySQLæ”¯æŒä½¿ç”¨TLSåè®®å»ºç«‹åŠ å¯†è¿æ¥ã€‚ä½¿ç”¨MySQLå®¢æˆ·ç«¯è¿æ¥æ•°æ®åº“æ—¶ï¼Œé»˜è®¤å°±ä¼šå¼€å¯è¿æ¥åŠ å¯†ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/5c/bd/5c4409c7cfbacb9a514705c5d00489bd.png?wh=1920x2016\" alt=\"å›¾ç‰‡\"></p><p>ä½¿ç”¨MySQLå®¢æˆ·ç«¯ç™»å½•æœåŠ¡å™¨åï¼Œæ‰§è¡Œ\\sï¼ŒæŸ¥çœ‹SSLè¿™ä¸€è¡Œçš„è¾“å‡ºï¼Œå¦‚æœæ˜¾ç¤ºâ€œCipher in use â€¦â€ï¼Œåˆ™è¯´æ˜å½“å‰è¿æ¥å¯ç”¨äº†åŠ å¯†ã€‚</p><pre><code class=\"language-plain\"># mysql -uuser_01 -h172.16.121.234 -P3306 -psomepass\n\nmysql&gt; \\s\n--------------\nmysql  Ver 8.0.32 for Linux on x86_64 (MySQL Community Server - GPL)\n\nConnection id:\t\t121\nCurrent database:\nCurrent user:\t\tuser_01@172-16-121-234\nSSL:\t\t\tCipher in use is ECDHE-RSA-AES128-GCM-SHA256\n...\n--------------\n</code></pre><p>å½“ç„¶ï¼Œä¹Ÿå¯ä»¥åœ¨è¿æ¥æ•°æ®åº“æ—¶æŒ‡å®šå‚æ•°ï¼Œä¸å¼€å¯è¿æ¥åŠ å¯†ï¼Œæ­¤æ—¶â€œSSLâ€è¿™ä¸€è¡Œæ˜¾ç¤ºâ€œNot in useâ€ã€‚</p><pre><code class=\"language-plain\"># mysql --ssl-mode=disabled -uuser_01 -h172.16.121.234 -P3306 -psomepass\n\nmysql&gt; \\s\n--------------\nmysql  Ver 8.0.32 for Linux on x86_64 (MySQL Community Server - GPL)\n\nConnection id:\t\t123\nCurrent database:\nCurrent user:\t\tuser_01@172-16-121-234\nSSL:\t\t\tNot in use\n...\n--------------\n</code></pre><p>ä½¿ç”¨JDBCæˆ–å…¶ä»–è¯­è¨€çš„å®¢æˆ·ç«¯é©±åŠ¨è¿æ¥æ•°æ®åº“æ—¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ç›¸åº”çš„å‚æ•°æ¥æ§åˆ¶æ˜¯å¦å¼€å¯è¿æ¥åŠ å¯†ã€‚</p><p>ä¸ºäº†ä¿éšœæ•°æ®åº“è¿æ¥çš„å®‰å…¨æ€§ï¼Œæˆ‘ä»¬å¯ä»¥å¼ºåˆ¶è¦æ±‚æŸäº›ç”¨æˆ·å¿…é¡»ä½¿ç”¨åŠ å¯†è¿æ¥ï¼Œè¿™å¯ä»¥åœ¨åˆ›å»ºç”¨æˆ·æ—¶æŒ‡å®šï¼Œæˆ–è€…é€šè¿‡ALTER USERå‘½ä»¤ä¿®æ”¹ã€‚ä¸‹é¢åˆ›å»ºçš„å‡ ä¸ªç”¨æˆ·éƒ½éœ€è¦å¼€å¯è¿æ¥åŠ å¯†ã€‚å…¶ä¸­user_06å’Œuser_07åœ¨ç™»å½•æ—¶è¿˜å¿…é¡»æä¾›å®¢æˆ·ç«¯çš„è¯ä¹¦ï¼Œuser_06å¯¹è¯ä¹¦subjectæœ‰è¦æ±‚ï¼Œuser_07å¯¹è¯ä¹¦issueræœ‰è¦æ±‚ï¼Œå¦‚æœæä¾›çš„è¯ä¹¦ä¸æ»¡è¶³è¦æ±‚ï¼Œä¹Ÿæ— æ³•ç™»å½•æ•°æ®åº“ã€‚</p><pre><code class=\"language-plain\">mysql&gt; create user 'user_05'@'%' identified by 'somepass' require ssl;\nmysql&gt; create user 'user_06'@'%' identified by 'somepass' require subject '/CN=MySQL_Server_8.0.32_Auto_Generated_Client_Certificate';\nmysql&gt; create user 'user_07'@'%' identified by 'somepass' require issuer '/helloworld';\n</code></pre><p>ä½¿ç”¨è¿™å‡ ä¸ªè´¦å·ç™»å½•æ—¶ï¼Œå¿…é¡»å¼€å¯åŠ å¯†è¿æ¥ï¼Œå¦åˆ™æ— æ³•ç™»å½•æ•°æ®åº“ã€‚</p><pre><code class=\"language-plain\"># mysql -uuser_05 -h127.0.0.1 -psomepass --ssl-mode=disabled\nERROR 1045 (28000): Access denied for user 'user_05'@'localhost' (using password: YES)\n</code></pre><p>ä½¿ç”¨user_06å’Œuser_07ç™»å½•æ—¶ï¼Œè¿˜å¿…é¡»æŒ‡å®šæ­£ç¡®çš„è¯ä¹¦ï¼Œå¦åˆ™ä¹Ÿæ— æ³•ç™»å½•æ•°æ®åº“ã€‚ä¸‹é¢çš„æµ‹è¯•æ¡ˆä¾‹ä¸­ï¼Œä½¿ç”¨äº†MySQLæ•°æ®åº“åˆå§‹åŒ–è¿‡ç¨‹ä¸­è‡ªåŠ¨åˆ›å»ºçš„è¯ä¹¦ï¼Œè¯ä¹¦éƒ½åœ¨æ•°æ®åº“çš„datadirç›®å½•ä¸‹ã€‚</p><pre><code class=\"language-plain\"># mysql -uuser_06 -h127.0.0.1 -psomepass --ssl-key=server-key.pem --ssl-cert=server-cert.pem -e 'select 1';\nERROR 1045 (28000): Access denied for user 'user_06'@'localhost' (using password: YES)\n\n# mysql -uuser_06 -h127.0.0.1 -psomepass --ssl-key=client-key.pem --ssl-cert=client-cert.pem -e 'select 1';\n+---+\n| 1 |\n+---+\n| 1 |\n+---+\n</code></pre><p>æœªå¼€å¯åŠ å¯†è¿æ¥æˆ–è¯ä¹¦ä¸å¯¹è€Œæ— æ³•ç™»å½•æ•°æ®åº“æ—¶ï¼ŒæœåŠ¡ç«¯è¿”å›çš„æŠ¥é”™ä¹Ÿæ˜¯ERROR 1045ï¼Œè·Ÿå¯†ç ä¸å¯¹æ—¶çš„æŠ¥é”™ä¿¡æ¯æ˜¯ä¸€æ ·çš„ã€‚åœ¨ç¡®è®¤å¯†ç æ²¡æœ‰é—®é¢˜åï¼Œå¦‚æœè¿˜æ˜¯æŠ¥ERROR 1045ï¼Œéœ€è¦æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰åŠ å¯†è¿æ¥å’Œè¯ä¹¦ç›¸å…³çš„è¦æ±‚ã€‚è¿™ä¸€é¡¹æˆ‘ä»¬å¯ä»¥åˆ°mysql.userè¡¨æŸ¥çœ‹ã€‚</p><pre><code class=\"language-plain\">mysql&gt; select user,host,ssl_type, cast(ssl_cipher as char) cipher, \n        cast(x509_issuer as char) issuer, cast(x509_subject as char) subject    \n    from mysql.user where user in ('user_05', 'user_06', 'user_07');\n+---------+------+-----------+--------+-------------+-----------------------------------------------------------+\n| user    | host | ssl_type  | cipher | issuer      | subject                                                   |\n+---------+------+-----------+--------+-------------+-----------------------------------------------------------+\n| user_05 | %    | ANY       |        |             |                                                           |\n| user_06 | %    | SPECIFIED |        |             | /CN=MySQL_Server_8.0.32_Auto_Generated_Client_Certificate |\n| user_07 | %    | SPECIFIED |        | /helloworld |                                                           |\n+---------+------+-----------+--------+-------------+-----------------------------------------------------------+\n</code></pre><p>ä»æœåŠ¡ç«¯çš„é”™è¯¯æ—¥å¿—ä¸­ï¼Œä¹Ÿå¯ä»¥çœ‹åˆ°ä¸€äº›ç›¸å…³çš„é”™è¯¯ä¿¡æ¯ï¼ˆéœ€è¦å°†å‚æ•°log_error_verbosityè®¾ç½®ä¸º3ï¼‰ã€‚</p><pre><code class=\"language-plain\">### alert.log\n[Note] [MY-010290] [Server] X.509 issuer mismatch: should be '/helloworld' but is '/CN=MySQL_Server_8.0.32_Auto_Generated_CA_Certificate'\n[Note] [MY-010926] [Server] Access denied for user 'user_07'@'localhost' (using password: YES)\n</code></pre><h3>æ•°æ®åº“æ— æ³•è¿æ¥é—®é¢˜</h3><p>é€šè¿‡å‰é¢çš„å†…å®¹ï¼Œä½ åº”è¯¥å·²ç»äº†è§£äº†MySQLå»ºç«‹è¿æ¥çš„å¤§è‡´è¿‡ç¨‹ã€‚ç°åœ¨æˆ‘ä»¬æ¥æ€»ç»“ä¸‹æ•°æ®åº“è¿æ¥ä¸ä¸Šæ—¶ï¼Œåˆ†æé—®é¢˜çš„ä¸€èˆ¬æ€è·¯ã€‚</p><ol>\n<li><strong>æ£€æŸ¥æ•°æ®åº“ç›‘å¬æ˜¯å¦æ­£å¸¸å¼€å¯ã€‚</strong></li>\n</ol><p>å¯ä»¥åœ¨æ•°æ®åº“æœåŠ¡å™¨ä¸Šé€šè¿‡netstatæˆ–sså‘½ä»¤æŸ¥çœ‹æ•°æ®åº“ç«¯å£çš„ç›‘å¬æ˜¯å¦æ­£å¸¸å¼€å¯ã€‚è¿™é‡Œéœ€è¦æ³¨æ„ç›‘å¬çš„IPï¼Œå¦‚æœç›‘å¬çš„IPæ˜¯127.0.0.1ï¼Œåˆ™åªèƒ½åœ¨æœ¬åœ°è¿æ¥åˆ°æ•°æ®åº“ã€‚</p><pre><code class=\"language-plain\"># ss -nltp | grep 3306\nLISTEN  0   128   [::]:3306  [::]:*  users:((\"mysqld\",pid=13600,fd=33))\n\n# netstat -nltp | grep 3306\ntcp6    0   0 :::3306    :::*    LISTEN  13600/mysqld\n</code></pre><ol start=\"2\">\n<li><strong>æ£€æŸ¥å®¢æˆ·ç«¯åˆ°æœåŠ¡ç«¯ä¹‹é—´çš„ç½‘ç»œæ˜¯å¦èƒ½è¿é€šã€‚</strong></li>\n</ol><p>å¯ä»¥ä½¿ç”¨telnetç­‰å·¥å…·æ£€æŸ¥å®¢æˆ·ç«¯åˆ°æœåŠ¡ç«¯å£æ˜¯å¦èƒ½è¿é€šã€‚</p><pre><code class=\"language-plain\"># telnet 172.16.121.234 3306\nTrying 172.16.121.234...\ntelnet: connect to address 172.16.121.234: No route to host\n</code></pre><p>å¦‚æœç«¯å£ä¸é€šï¼Œä½¿ç”¨MySQLå®¢æˆ·ç«¯è®¿é—®æ•°æ®åº“çš„æ—¶å€™ï¼Œä¹Ÿä¼šæœ‰ç›¸åº”çš„æŠ¥é”™ä¿¡æ¯ã€‚</p><pre><code class=\"language-plain\"># mysql  -h 172.16.121.234 -P 3306\nERROR 2003 (HY000): Can't connect to MySQL server on '172.16.121.234:3306' (113)\n\n# mysql  -h 172.16.121.234 -P3307 -uuser_01 -psomepass\nERROR 2003 (HY000): Can't connect to MySQL server on '172.16.121.234:3307' (111)\n</code></pre><p>æ³¨æ„åˆ°ä¸Šé¢æŠ¥é”™ä¿¡æ¯æœ€åæ‹¬å·é‡Œçš„æ•°å­—ï¼Œè¿™å¯èƒ½æ˜¯æ“ä½œç³»ç»Ÿè¿”å›çš„é”™è¯¯ç ï¼Œå¯ä»¥ä½¿ç”¨MySQLæä¾›çš„å·¥å…·perroræŸ¥çœ‹è·Ÿé”™è¯¯ç å…³è”çš„é”™è¯¯ä¿¡æ¯ã€‚</p><pre><code class=\"language-plain\"># perror 111\nOS error code 111:  Connection refused\n\n# perror 113\nOS error code 113:  No route to host\n</code></pre><p>è¿™é‡Œçš„é”™è¯¯ç è·Ÿæ“ä½œç³»ç»Ÿæœ‰å…³ï¼Œæ¯”å¦‚åœ¨macä¸‹ï¼Œé”™è¯¯ç å°±å˜æˆäº†61ï¼Œéœ€è¦åœ¨macç¯å¢ƒä¸‹ä½¿ç”¨perrorå·¥å…·æŸ¥çœ‹ã€‚</p><pre><code class=\"language-plain\">$ mysql -uuser_01 -h172.16.121.234 -psomepass\nERROR 2003 (HY000): Can't connect to MySQL server on '172.16.121.234' (61)\n\n$ perror 61\nOS error code  61:  Connection refused\n</code></pre><p>å¦‚æœè¿ç«¯å£éƒ½ä¸é€šï¼Œé‚£ä¹ˆå°±æ— æ³•å»ºç«‹TCPè¿æ¥ï¼Œå› æ­¤ä¹Ÿæ— æ³•è¿æ¥åˆ°æ•°æ®åº“ã€‚æœ‰æ—¶å€™ï¼Œå®¢æˆ·ç«¯åˆ°æœåŠ¡ç«¯ä¹‹é—´çš„ç½‘ç»œé“¾è·¯å¯èƒ½æ¯”è¾ƒå¤æ‚ï¼Œå¯èƒ½ä¼šå­˜åœ¨é˜²ç«å¢™ï¼Œæˆ–è€…æ˜¯å—æŸäº›ç½‘ç»œè®¿é—®ç­–ç•¥çš„é™åˆ¶ï¼Œéœ€è¦ä»ç½‘ç»œå±‚é¢è¿›è¡Œæ’æŸ¥ã€‚</p><ol start=\"3\">\n<li><strong>æ˜¯å¦æ˜¯è®¤è¯é˜¶æ®µå‡ºäº†é—®é¢˜ã€‚</strong></li>\n</ol><p>å®¢æˆ·ç«¯è¿æ¥åˆ°æ•°æ®åº“æ—¶ï¼Œéœ€è¦ç»è¿‡ä¸€ä¸ªå¤æ‚çš„è®¤è¯è¿‡ç¨‹ï¼Œè®¤è¯é˜¶æ®µå„ä¸ªæ­¥éª¤éƒ½å¯èƒ½å‡ºé”™ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬åˆ†æä¸€äº›æ¯”è¾ƒå¸¸è§çš„æŠ¥é”™ä¿¡æ¯ã€‚</p><ul>\n<li>ERROR 2059ï¼ŒAuthentication plugin â€˜caching_sha2_passwordâ€™ cannot be loaded</li>\n</ul><pre><code class=\"language-plain\">/opt/mysql5.6/bin/mysql -uuser_01 -h127.0.0.1 -psomepass\nERROR 2059 (HY000): Authentication plugin 'caching_sha2_password' cannot be loaded: /usr/local/mysql/lib/plugin/caching_sha2_password.so: cannot open shared object file: No such file or directory\n</code></pre><p>è¿™ä¸ªæŠ¥é”™é€šå¸¸æ˜¯å› ä¸ºå®¢æˆ·ç«¯çš„ç‰ˆæœ¬å¤ªä½äº†ï¼Œä¸æ”¯æŒcaching_sha2_passwordè®¤è¯æ’ä»¶ã€‚è§£å†³æ–¹æ³•æ˜¯ä½¿ç”¨æ–°ç‰ˆæœ¬çš„å®¢æˆ·ç«¯ã€‚</p><ul>\n<li>ERROR 2061ï¼ŒAuthentication requires secure connection</li>\n</ul><pre><code class=\"language-plain\"># mysql --ssl-mode=disabled  -uuser_01 -h127.0.0.1 -psomepass\nERROR 2061 (HY000): Authentication plugin 'caching_sha2_password' reported error: Authentication requires secure connection.\n</code></pre><p>ä½¿ç”¨caching_sha2_passwordè®¤è¯æ’ä»¶æ—¶ï¼Œç”¨æˆ·é¦–æ¬¡ç™»å½•æ—¶è¿˜æ²¡æœ‰è¢«ç¼“å­˜ï¼ŒæœåŠ¡ç«¯éœ€è¦è·å–ç”¨æˆ·çš„æ˜æ–‡å¯†ç ï¼Œå¦‚æœå®¢æˆ·ç«¯æ²¡æœ‰å¼€å¯è¿æ¥åŠ å¯†ï¼Œå‘é€æ˜æ–‡å¯†ç æœ‰å®‰å…¨é£é™©ï¼Œå°±ä¼šæŠ¥è¿™ä¸ªé”™è¯¯ã€‚å¼€å¯è¿æ¥åŠ å¯†å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥åœ¨å®¢æˆ·ç«¯æŒ‡å®šget-server-public-keyé€‰é¡¹ã€‚</p><pre><code class=\"language-plain\">mysql --get-server-public-key --ssl-mode=disabled -uuser_01 -h127.0.0.1 -psomepass\n</code></pre><p>å½“ç„¶ï¼Œä¸åŒçš„å®¢æˆ·ç«¯æŒ‡å®šå‚æ•°çš„æ–¹å¼å¯èƒ½ä¼šæœ‰ä¸€äº›å·®å¼‚ï¼Œæ¯”å¦‚ä½¿ç”¨JDBCæ—¶éœ€è¦æ·»åŠ è¿æ¥å±æ€§allowPublicKeyRetrieval=trueã€‚</p><p>MySQLå¤‡åº“è¿æ¥åˆ°ä¸»åº“æ—¶ï¼Œä¹Ÿå¯èƒ½ä¼šé‡åˆ°ä¸€æ ·çš„é—®é¢˜ï¼Œå¯ä»¥åœ¨å»ºç«‹å¤åˆ¶æ—¶ï¼ŒæŒ‡å®šGET_MASTER_PUBLIC_KEYæˆ–GET_SOURCE_PUBLIC_KEYé€‰é¡¹ã€‚</p><pre><code class=\"language-plain\">## ä½¿ç”¨change master\nchange master to master_host='master-host-name', \n   master_user='repl', \n   master_password='somepass',\n   master_auto_position=1,\n   GET_MASTER_PUBLIC_KEY=1;\n\n## æˆ–è€…ä½¿ç”¨change replication source\nchange replication source to \n   source_host='master-host-name', \n   source_user='repl', \n   source_password='somepass',\n   source_auto_position=1,\n   GET_SOURCE_PUBLIC_KEY=1;\n</code></pre><p>ä½¿ç”¨MySQLç»„å¤åˆ¶ï¼ˆMGRï¼‰å¦‚æœé‡åˆ°è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®å‚æ•°group_replication_recovery_get_public_keyæ¥è§£å†³ã€‚</p><pre><code class=\"language-plain\">set global group_replication_recovery_get_public_key=ON;\n</code></pre><p>å…³äºå¤åˆ¶å’Œç»„å¤åˆ¶åœ¨åç»­çš„è¯¾ç¨‹ä¸­æˆ‘ä¼šè¯¦ç»†ä»‹ç»ã€‚</p><ul>\n<li>ERROR 1045 (28000): Access denied for user â€˜usernameâ€™@â€˜hostnameâ€™</li>\n</ul><pre><code class=\"language-plain\"># mysql -uuser_07 -h172.16.121.234 -psomepassx --ssl-key=client-key.pem --ssl-cert=client-cert.pem -e 'select 1'\nERROR 1045 (28000): Access denied for user 'user_07'@'172-16-121-234' (using password: YES)\n</code></pre><p>ERROR 1045å¯èƒ½æ˜¯æˆ‘ä»¬å¹³æ—¶é‡åˆ°æœ€å¤šçš„ä¸€ä¸ªæŠ¥é”™ï¼Œé€šå¸¸è¿™æ˜¯ç”±äºå®¢æˆ·ç«¯è¾“å…¥çš„å¯†ç ä¸æ­£ç¡®å¼•èµ·çš„ã€‚ä½†æ˜¯æˆ‘ä»¬åœ¨è¿™ä¸€è®²å‰é¢åŠ å¯†è¿æ¥æ¼”ç¤ºè¿‡ï¼Œå¦‚æœå¼ºåˆ¶è¦æ±‚ç”¨æˆ·ä½¿ç”¨åŠ å¯†è¿æ¥ï¼Œæˆ–è€…å¯¹å®¢æˆ·ç«¯çš„è¯ä¹¦æœ‰è¦æ±‚ï¼Œè€Œå®¢æˆ·ç«¯æ²¡æœ‰æ»¡è¶³è¿™äº›æ¡ä»¶ï¼Œé‚£ä¹ˆè¿æ¥æ—¶ä¹Ÿä¼šæŠ¥è¿™ä¸ªé”™ã€‚å¯ä»¥åˆ°mysql.userè¡¨æŸ¥çœ‹ç”¨æˆ·æ˜¯å¦æœ‰SSLç›¸å…³è¦æ±‚ã€‚åŒæ—¶ä¹Ÿå¯ä»¥åˆ°æ•°æ®åº“çš„é”™è¯¯æ—¥å¿—ä¸­æŸ¥çœ‹æ˜¯å¦æœ‰ç›¸åº”çš„æŠ¥é”™ä¿¡æ¯ã€‚</p><ol start=\"4\">\n<li><strong>æ•°æ®åº“è¿æ¥æ•°é™åˆ¶</strong></li>\n</ol><p>MySQLä¸­æœ‰å‡ ä¸ªåœ°æ–¹é™åˆ¶ç”¨æˆ·çš„è¿æ¥æ•°ã€‚å‚æ•°max_connectionsé™åˆ¶äº†æ•°æ®åº“å…è®¸åˆ›å»ºçš„æ€»è¿æ¥æ•°ã€‚å‚æ•°max_user_connectionsé™åˆ¶äº†åŒä¸€ä¸ªç”¨æˆ·å…è®¸åˆ›å»ºçš„æœ€å¤§è¿æ¥æ•°ã€‚æˆ‘ä»¬è¿˜å¯ä»¥æŒ‡å®šæŸä¸ªå…·ä½“çš„ç”¨æˆ·å…è®¸åˆ›å»ºçš„æœ€å¤§è¿æ¥æ•°ã€‚</p><pre><code class=\"language-plain\">mysql&gt; create user 'user_09'@'%' identified by 'somepass' \n    with MAX_USER_CONNECTIONS 2;\nQuery OK, 0 rows affected (0.04 sec)\n</code></pre><p>å¦‚æœè¿æ¥æ•°è¶…è¿‡äº†é™åˆ¶ï¼Œæ ¹æ®ä¸Šé¢å‡ ç§æƒ…å†µï¼Œåˆ†åˆ«ä¼šæŠ¥ä¸‹é¢è¿™3ä¸ªé”™è¯¯ã€‚</p><ul>\n<li>ERROR 1040 (08004): Too many connections</li>\n<li>ERROR 1203 (42000): User user_01 already has more than â€˜max_user_connectionsâ€™ active connections</li>\n<li>ERROR 1226 (42000): User â€˜user_09â€™ has exceeded the â€˜max_user_connectionsâ€™ resource (current value: 2)</li>\n</ul><ol start=\"5\">\n<li><strong>æ“ä½œç³»ç»Ÿèµ„æºé™åˆ¶</strong></li>\n</ol><p>MySQLåˆ›å»ºè¿æ¥æ—¶ï¼Œéœ€è¦æ¶ˆè€—æ“ä½œç³»ç»Ÿèµ„æºï¼Œå¦‚æœæ“ä½œç³»ç»Ÿèµ„æºè¶…å‡ºäº†é™åˆ¶ï¼Œä¹Ÿä¼šå¯¼è‡´å®¢æˆ·ç«¯è¿æ¥å¤±è´¥ã€‚ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­ï¼ŒMySQLæœåŠ¡ç«¯æ— æ³•åˆ›å»ºæ–°çš„çº¿ç¨‹ã€‚</p><ul>\n<li>ERROR 1135 (HY000): Canâ€™t create a new thread (errno 11)</li>\n</ul><pre><code class=\"language-plain\"># mysql -uroot -h127.0.0.1 -pabc123\nERROR 1135 (HY000): Can't create a new thread (errno 11);\n if you are not out of available memory, you can consult the manual \n for a possible OS-dependent bug\n\n# perror 11\nOS error code  11:  Resource temporarily unavailable\n</code></pre><p>å¦‚æœæ–‡ä»¶å¥æŸ„æ•°è¶…å‡ºäº†é™åˆ¶ï¼Œåœ¨æ•°æ®åº“çš„é”™è¯¯æ—¥å¿—ä¸­è¿˜å¯èƒ½ä¼šå‡ºç°è¿™æ ·çš„æŠ¥é”™ä¿¡æ¯ã€‚</p><pre><code class=\"language-plain\">[ERROR] [MY-010283] [Server] Error in accept: Too many open files\n</code></pre><p>åœ¨è¿™ä¸ªè¯¾ç¨‹ä¸­çš„ç¬¬12è®²ï½œæ“ä½œç³»ç»Ÿæ˜¯å¦å­˜åœ¨ç“¶é¢ˆï¼ŸLinuxé—®é¢˜è¯Šæ–­å…¥é—¨ï¼Œæˆ‘ä»¬ä¼šä»‹ç»æ“ä½œç³»ç»Ÿç›¸å…³é—®é¢˜çš„æ’æŸ¥ã€‚</p><ol start=\"6\">\n<li><strong>å…¶å®ƒé”™è¯¯</strong></li>\n</ol><pre><code class=\"language-plain\">ERROR 1129 (HY000): Host '172.16.121.237' is blocked because of many connection errors; unblock with 'mysqladmin flush-hosts'\n</code></pre><p>è¿™ä¹Ÿæ˜¯ä¸€ä¸ªæ¯”è¾ƒè‡´å‘½çš„é—®é¢˜ã€‚å®¢æˆ·ç«¯ä»æŸå°æœºå™¨è¿æ¥æ•°æ®åº“æ—¶ï¼Œè¿ç»­å‡ºé”™ï¼Œå‡ºé”™çš„æ¬¡æ•°è¶…è¿‡äº†å‚æ•°max_connect_errorsçš„è®¾ç½®åï¼ŒæœåŠ¡ç«¯ä¼šç¦æ­¢è¿™å°æœºå™¨åç»­çš„è¿æ¥ã€‚è¿™é‡Œé™åˆ¶çš„æ˜¯å®¢æˆ·ç«¯çš„IPï¼Œä¹Ÿå°±æ˜¯ä»è¿™ä¸ªIPçš„å‘èµ·æ‰€æœ‰è¿æ¥éƒ½ä¼šè¢«é™åˆ¶ã€‚ä»performance_schema.host_cacheè¡¨é‡Œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®¢æˆ·ç«¯çš„è¿æ¥é”™è¯¯æ¬¡æ•°ã€‚</p><pre><code class=\"language-plain\">mysql&gt; select * from performance_schema.host_cache\\G\n*************************** 1. row ***************************\n                                        IP: 172.16.121.237\n                                      HOST: 172-16-121-237\n                            HOST_VALIDATED: YES\n                        SUM_CONNECT_ERRORS: 10\n                 COUNT_HOST_BLOCKED_ERRORS: 5\n           COUNT_NAMEINFO_TRANSIENT_ERRORS: 0\n           COUNT_NAMEINFO_PERMANENT_ERRORS: 0\n                       COUNT_FORMAT_ERRORS: 0\n           COUNT_ADDRINFO_TRANSIENT_ERRORS: 0\n           COUNT_ADDRINFO_PERMANENT_ERRORS: 0\n                       COUNT_FCRDNS_ERRORS: 0\n                     COUNT_HOST_ACL_ERRORS: 0\n               COUNT_NO_AUTH_PLUGIN_ERRORS: 0\n                  COUNT_AUTH_PLUGIN_ERRORS: 0\n                    COUNT_HANDSHAKE_ERRORS: 10\n                   COUNT_PROXY_USER_ERRORS: 0\n               COUNT_PROXY_USER_ACL_ERRORS: 0\n               COUNT_AUTHENTICATION_ERRORS: 0\n                          COUNT_SSL_ERRORS: 0\n         COUNT_MAX_USER_CONNECTIONS_ERRORS: 0\nCOUNT_MAX_USER_CONNECTIONS_PER_HOUR_ERRORS: 0\n             COUNT_DEFAULT_DATABASE_ERRORS: 0\n                 COUNT_INIT_CONNECT_ERRORS: 0\n                        COUNT_LOCAL_ERRORS: 0\n                      COUNT_UNKNOWN_ERRORS: 0\n                                FIRST_SEEN: 2024-07-04 15:24:54\n                                 LAST_SEEN: 2024-07-04 15:37:46\n                          FIRST_ERROR_SEEN: 2024-07-04 15:24:54\n                           LAST_ERROR_SEEN: 2024-07-04 15:37:46\n</code></pre><p>å…¶å®ä¸Šé¢çš„æŠ¥é”™ä¿¡æ¯ä¸­å°±æä¾›äº†è§£å†³æ–¹æ³•ï¼šæ‰§è¡Œflush hostsæ“ä½œã€‚</p><pre><code class=\"language-plain\">mysql&gt; flush hosts;\nQuery OK, 0 rows affected, 1 warning (0.14 sec)\n</code></pre><p>å¹¶ä¸æ˜¯æ‰€æœ‰çš„è¿æ¥é”™è¯¯éƒ½ä¼šå¼•èµ·å®¢æˆ·ç«¯è¢«ç¦ï¼Œæ¯”å¦‚å¯†ç é”™è¯¯å¹¶ä¸ä¼šå¯¼è‡´å®¢æˆ·ç«¯è¢«ç¦ã€‚host_cacheè¡¨çš„COUNT_HANDSHAKE_ERRORSè¾¾åˆ°max_connect_errorsï¼Œæ‰ä¼šå¯¼è‡´å®¢æˆ·ç«¯è¢«ç¦ã€‚æ¯”å¦‚è¿ç»­telnet mysqlçš„ç«¯å£ä¼šå¼•èµ·è¿™ä¸ªé—®é¢˜ï¼Œæˆ–è€…ä½¿ç”¨äº†æ— æ•ˆçš„sslè¯ä¹¦å¯èƒ½ä¼šå¯¼è‡´è¿™ä¸ªé—®é¢˜ã€‚</p><pre><code class=\"language-plain\"># mysql  -uuser_06 -h 172.16.121.234 -psomepass --ssl-cert=client-cert.pem --ssl-key=client-key.pem --ssl-ca=ca.pem\nERROR 2026 (HY000): SSL connection error: error:14090086:SSL routines:ssl3_get_server_certificate:certificate verify failed\n</code></pre><h2>è¿æ¥ä¸­æ–­é—®é¢˜</h2><p>è¿æ¥ä¸­æ–­ä¹Ÿæ˜¯æˆ‘ä»¬æ—¥å¸¸ä½¿ç”¨MySQLè¿‡ç¨‹ä¸­ç»å¸¸ä¼šé‡åˆ°çš„é—®é¢˜ã€‚ä¸åŒçš„å®¢æˆ·ç«¯åœ¨é‡åˆ°è¿æ¥ä¸­æ–­æ—¶ï¼Œå…·ä½“çš„æŠ¥é”™ä¿¡æ¯å¯èƒ½ä¼šä¸ä¸€æ ·ã€‚æ¯”å¦‚ä½¿ç”¨MySQLè‡ªå¸¦çš„å‘½ä»¤è¡Œå®¢æˆ·ç«¯æ—¶ï¼Œå¯èƒ½ä¼šé‡åˆ°ä¸‹é¢è¿™å‡ ä¸ªæŠ¥é”™ã€‚</p><ul>\n<li>ERROR 2013 (HY000): Lost connection to MySQL server during query</li>\n<li>ERROR 4031 (HY000): The client was disconnected by the server because of inactivity. See wait_timeout and interactive_timeout for configuring this behavior.</li>\n</ul><p>è€Œä½¿ç”¨Javaç¼–å†™çš„åº”ç”¨ç¨‹åºï¼Œåœ¨è®¿é—®MySQLæ•°æ®åº“æ—¶ï¼Œæ¯”è¾ƒå¸¸è§çš„æŠ¥é”™æœ‰2ä¸ªã€‚</p><ul>\n<li>CommunicationsException: The last packet successfully received from the server was 15,032 milliseconds ago. The last packet sent successfully to the server was 15,035 milliseconds ago. is longer than the server configured value of â€˜wait_timeoutâ€™.</li>\n<li>Can not read response from server. Expected to read 4 bytes, read 0 bytes before connection was unexpectedly lost.</li>\n</ul><p>ä¸Šé¢è¿™å‡ ä¸ªæŠ¥é”™ä¿¡æ¯å®é™…ä¸Šéƒ½æ˜¯åœ¨è¯´å®¢æˆ·ç«¯åˆ°æœåŠ¡å™¨ä¹‹é—´çš„è¿æ¥æ–­å¼€äº†ï¼Œè‡³äºè¿æ¥ä¸ºä»€ä¹ˆä¼šæ–­å¼€ï¼Œç°å®ä¸­å­˜åœ¨å¾ˆå¤šä¸åŒçš„æƒ…å†µï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¼šå¯¹ä¸€äº›æƒ…å†µåšä¸€äº›åˆ†æã€‚</p><h2>æƒ…å†µ1ï¼šè¿æ¥è¢«Kill</h2><p>å¦‚æœæœ‰äººä½¿ç”¨Killå‘½ä»¤ç»ˆæ­¢äº†æŸä¸ªä¼šè¯ï¼Œé‚£ä¹ˆåŸå…ˆçš„é‚£ä¸ªå®¢æˆ·ç«¯å†æ‰§è¡ŒSQLæ—¶ï¼Œå°±ä¼šå‘ç°è¿æ¥å·²ç»ä¸­æ–­äº†ã€‚</p><pre><code class=\"language-plain\">mysql&gt; show processlist;\n+----+-----------------+----------------------+------+---------+------+\n| Id | User            | Host                 | db   | Command | Time |\n+----+-----------------+----------------------+------+---------+------+\n| 30 | user_01         | 192.168.113.13:58850 | db01 | Sleep   |    5 |\n+----+-----------------+----------------------+------+---------+------+\n\nmysql&gt; kill 30;\nQuery OK, 0 rows affected (0.00 sec)\n</code></pre><h2>æƒ…å†µ2ï¼šæ•°æ®åº“é‡å¯äº†</h2><p>å¦‚æœæ•°æ®åº“é‡å¯å‘ç”Ÿäº†é‡å¯ï¼Œé‚£ä¹ˆåŸå…ˆæ‰€æœ‰çš„è¿æ¥éƒ½ä¼šæ–­å¼€ã€‚æœ‰ä¸€ç§æ¯”è¾ƒç‰¹æ®Šçš„æƒ…å†µï¼Œç”±äºæ•°æ®åº“åº•å±‚æ•°æ®æ–‡ä»¶æŸåç­‰åŸå› ï¼Œæ•°æ®åº“åœ¨ä¸åœåœ°é‡å¯ã€‚è¡¨ç°å‡ºæ¥çš„ç°è±¡æ˜¯å¯ä»¥è¿æ¥åˆ°æ•°æ®åº“ï¼Œä½†æ˜¯æ‰§è¡ŒSQLæ—¶ï¼Œè¿æ¥å·²ç»æ–­å¼€äº†ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡æŸ¥çœ‹æ•°æ®åº“çš„UptimeçŠ¶æ€å˜é‡æ¥åˆ¤æ–­æ•°æ®åº“æœ€è¿‘æ˜¯å¦æœ‰é‡å¯ã€‚Uptimeè®°å½•äº†æ•°æ®åº“ä»å¯åŠ¨åè‡³ä»Šç»è¿‡çš„ç§’æ•°ã€‚</p><pre><code class=\"language-plain\">mysql&gt; show global status where variable_name in ('Uptime');\n+---------------+-------+\n| Variable_name | Value |\n+---------------+-------+\n| Uptime        | 64909 |\n+---------------+-------+\n</code></pre><h2>æƒ…å†µ3ï¼šè¿æ¥ç©ºé—²æ—¶é—´è¶…æ—¶</h2><p>MySQLä¸­å‚æ•°interactive_timeoutå’Œwait_timeoutç”¨æ¥æ§åˆ¶è¿æ¥çš„ç©ºé—²è¶…æ—¶ï¼Œå¦‚æœä¸€ä¸ªè¿æ¥åœ¨æŒ‡å®šçš„æ—¶é—´å†…æ²¡æœ‰å‘èµ·ä»»ä½•è¯·æ±‚ï¼Œå°±ä¼šè¢«æœåŠ¡å™¨æ–­å¼€ã€‚</p><pre><code class=\"language-plain\">mysql&gt; show global variables where variable_name in ('wait_timeout', 'interactive_timeout');\n+---------------------+-------+\n| Variable_name       | Value |\n+---------------------+-------+\n| interactive_timeout | 28800 |\n| wait_timeout        | 28800 |\n+---------------------+-------+\n</code></pre><p>å…¨å±€å˜é‡interactive_timeoutç”¨æ¥æ§åˆ¶äº¤äº’å¼è¿æ¥çš„ç©ºé—²è¶…æ—¶æ—¶é—´ï¼Œwait_timeoutç”¨æ¥æ§åˆ¶éäº¤äº’å¼è¿æ¥çš„ç©ºé—²è¶…æ—¶æ—¶é—´ã€‚wait_timeoutè¿˜æ˜¯ä¸€ä¸ªä¼šè¯çº§åˆ«çš„å‚æ•°ï¼Œæ¯ä¸ªä¼šè¯å¯ä»¥åˆ†åˆ«è®¾ç½®ä¸åŒçš„è¶…æ—¶æ—¶é—´ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒæœåŠ¡å™¨åœ¨åˆ›å»ºä¸€ä¸ªè¿æ¥æ—¶ï¼Œæ ¹æ®å®¢æˆ·ç«¯çš„è¿æ¥ç±»å‹æ¥è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œå¯¹äºäº¤äº’å¼è¿æ¥ï¼ŒæœåŠ¡å™¨åŸºäºinteractive_timeoutæ¥è®¾ç½®è¿æ¥çš„è¶…æ—¶æ—¶é—´ï¼Œå¯¹äºéäº¤äº’å¼è¿æ¥ï¼ŒæœåŠ¡å™¨æ ¹æ®å…¨å±€å˜é‡wait_timeoutæ¥è®¾ç½®è¶…æ—¶æ—¶é—´ã€‚è¿æ¥è¿˜å¯ä»¥è‡ªå·±åœ¨ä¼šè¯çº§åˆ«ä¿®æ”¹è¶…æ—¶æ—¶é—´ã€‚</p><p>è¦æŸ¥çœ‹ä¸€ä¸ªè¿æ¥çœŸå®çš„è¶…æ—¶æ—¶é—´ï¼Œæœ€ç®€å•çš„åŠæ³•æ˜¯é€šè¿‡è¿™ä¸ªè¿æ¥æŸ¥çœ‹ä¼šè¯å˜é‡wait_timeoutçš„å€¼ã€‚</p><pre><code class=\"language-plain\">mysql&gt; set wait_timeout=3600;\nQuery OK, 0 rows affected (0.00 sec)\n\nmysql&gt; show  variables where variable_name in ('wait_timeout');\n+---------------+-------+\n| Variable_name | Value |\n+---------------+-------+\n| wait_timeout  | 3600  |\n+---------------+-------+\n\nmysql&gt; select @@wait_timeout;\n+----------------+\n| @@wait_timeout |\n+----------------+\n|           3600 |\n+----------------+\n1 row in set (0.00 sec)\n</code></pre><h2>æƒ…å†µ4ï¼šä»£ç†ï¼ˆProxyï¼‰è¶…æ—¶</h2><p>æœ‰çš„æ—¶å€™ï¼Œæ•°æ®åº“è¿æ¥è‡ªèº«çš„ç©ºé—²è¶…æ—¶è®¾ç½®å¾—æ¯”è¾ƒå¤§ï¼Œä½†æ˜¯åœ¨æ•°æ®åº“ä¹‹å‰é…ç½®äº†ä»£ç†ï¼Œè€Œä»£ç†çš„ç©ºé—²è¶…æ—¶æ—¶é—´æ¯”è¾ƒçŸ­ã€‚åº”ç”¨ç¨‹åºé€šè¿‡ä»£ç†è®¿é—®æ•°æ®åº“æ—¶ï¼Œå°±å¯èƒ½ä¼šé‡åˆ°è¿æ¥ä¸­æ–­çš„é—®é¢˜ã€‚</p><p>ä¸‹é¢æ˜¯nginxçš„4å±‚ä»£ç†çš„ä¸€ä¸ªä¾‹å­ã€‚nginx 4å±‚ä»£ç†é»˜è®¤çš„è¶…æ—¶æ—¶é—´æ˜¯10åˆ†é’Ÿï¼Œä¹Ÿå°±æ˜¯å¦‚æœ10åˆ†é’Ÿå†…æ²¡æœ‰ä»»ä½•è¯·æ±‚ï¼Œå°±ä¼šæŠŠè¿æ¥æ–­å¼€ã€‚</p><pre><code class=\"language-plain\">## /etc/nginx/nginx.conf\nstream {\n        server {\n             listen 13306;\n             ##proxy_timeout 10m; # é»˜è®¤10åˆ†é’Ÿ\n             proxy_pass 172.16.121.234:3306;\n        }\n}\n</code></pre><p>å¦‚æœåº”ç”¨ç¨‹åºé€šè¿‡nginxæ¥è®¿é—®æ•°æ®åº“ï¼Œç©ºé—²æ—¶é—´è¶…è¿‡10åˆ†é’Ÿåè¿æ¥å°±ä¼šè¢«æ–­å¼€ã€‚è€Œä¸”è¿˜æœ‰ä¸€ä¸ªæ›´ä¸¥é‡çš„é—®é¢˜ï¼Œé€šè¿‡ä»£ç†æ— æ³•æ‰§è¡Œè€—æ—¶è¶…è¿‡10åˆ†é’Ÿçš„SQLã€‚</p><pre><code class=\"language-plain\">mysql&gt; select sleep(610);\nERROR 2013 (HY000): Lost connection to MySQL server during query\n</code></pre><p>é‚£ä¹ˆè¿æ¥æ–­å¼€çš„é—®é¢˜åº”è¯¥æ€ä¹ˆè§£å†³å‘¢ï¼Ÿ</p><p>é¦–å…ˆå¯ä»¥æ ¹æ®ä¸šåŠ¡çš„å®é™…æƒ…å†µï¼Œå°†ç©ºé—²è¶…æ—¶æ—¶é—´è®¾ç½®å¾—é•¿ä¸€äº›ã€‚å¦‚æœä½¿ç”¨äº†ä»£ç†ï¼Œéœ€è¦æ³¨æ„ä»£ç†çš„è¶…æ—¶è®¾ç½®ã€‚å¯¹äºJavaåº”ç”¨ç¨‹åºï¼Œä¸€èˆ¬ä¼šä½¿ç”¨æ•°æ®åº“è¿æ¥æ± ï¼Œè¦æ­£ç¡®åœ°è®¾ç½®è¿æ¥æ± çš„å‚æ•°ã€‚æœ‰çš„è¿æ¥æ± æ”¯æŒç©ºé—²è¿æ¥å›æ”¶ï¼Œæœ‰çš„è¿æ¥æ± æ”¯æŒè¿æ¥æ¢æ´»ï¼ˆKeepaliveï¼‰ï¼Œä¹Ÿå°±æ˜¯æ¯éš”ä¸€å®šæ—¶é—´å°±æ‰§è¡Œä¸€ä¸ªKeepaliveçš„SQLï¼Œéœ€è¦æ³¨æ„è¿æ¥æ± çš„Keepaliveæ‰§è¡Œé—´éš”è¦æ¯”æ•°æ®åº“çš„wait_timeoutæˆ–ä»£ç†çš„ç©ºé—²è¶…æ—¶æ—¶é—´è®¾ç½®å¾—æ›´çŸ­ã€‚</p><p>ä½†æ˜¯ï¼Œæˆ‘ä»¬å…¶å®å¾ˆéš¾å®Œå…¨é¿å¼€æ•°æ®åº“è¿æ¥ä¸­æ–­çš„é—®é¢˜ï¼Œå› ä¸ºç°å®ä¸­æ€»ä¼šå­˜åœ¨ä¸€äº›æ„å¤–ï¼Œæ¯”å¦‚è¿è¡Œæ•°æ®åº“çš„æœåŠ¡å™¨å¼‚å¸¸é‡å¯äº†ï¼Œæˆ–è€…åº”ç”¨ç¨‹åºåˆ°æ•°æ®åº“ä¹‹é—´çš„æŸä¸ªç½‘ç»œè®¾å¤‡å‡ºæ•…éšœäº†ç­‰ç­‰å„ç§æƒ…å†µã€‚å› æ­¤æˆ‘ä»¬çš„ç¨‹åºéœ€è¦èƒ½å¤„ç†è¿™äº›å¼‚å¸¸ï¼Œè¿›è¡Œé‡è¿æ•°æ®åº“ã€é‡æ–°æ‰§è¡ŒSQLã€‚</p><h2>æ€»ç»“</h2><p>è¿™ä¸€è®²ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†MySQLå»ºç«‹è¿æ¥å’Œè®¤è¯ç”¨æˆ·çš„è¿‡ç¨‹ã€‚æœ‰å¾ˆå¤šåŸå› ä¼šå¯¼è‡´è¿æ¥æ•°æ®åº“å¤±è´¥ï¼Œé‡åˆ°é—®é¢˜æ—¶é¦–å…ˆè¦æ‹¿åˆ°æ•°æ®åº“å…·ä½“çš„æŠ¥é”™ä¿¡æ¯ã€é”™è¯¯ç¼–å·ã€‚è¿™ä¸€è®²æˆ‘ä¹Ÿæåˆ°äº†ä¸€äº›ä½ å¯èƒ½ä¼šé‡åˆ°çš„æŠ¥é”™ä¿¡æ¯ã€‚å¦‚æœä½ é‡åˆ°çš„è¿æ¥é—®é¢˜åœ¨è¯¾ç¨‹ä¸­æ²¡æœ‰æåˆ°ï¼Œå¯ä»¥æ ¹æ®æˆ‘ä»¬æä¾›çš„æ­¥éª¤ï¼Œåˆ†æè¿æ¥çš„å“ªä¸ªé˜¶æ®µå‡ºç°äº†é—®é¢˜ã€‚</p><p>æ­¤å¤–æˆ‘ä»¬è¿˜åˆ†æäº†æ•°æ®åº“è¿æ¥å¼‚å¸¸ä¸­æ–­çš„ä¸€äº›æƒ…å†µã€‚é€šè¿‡æ­£ç¡®è®¾ç½®æ•°æ®åº“å‚æ•°ã€ä»£ç†è½¯ä»¶å‚æ•°å’Œåº”ç”¨ç¨‹åºçš„è¿æ¥æ± å‚æ•°ï¼Œå¯ä»¥é¿å…ä¸€éƒ¨åˆ†è¿æ¥ä¸­æ–­çš„é—®é¢˜ã€‚åº”ç”¨ç¨‹åºä¹Ÿè¦æœ‰èƒ½åŠ›å¤„ç†ä¸­æ–­çš„è¿æ¥ï¼Œè¿›è¡Œé‡è¿ã€é‡è¯•ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>å¼€å‘åŒå­¦åé¦ˆè®¿é—®æ•°æ®åº“æ€»æ˜¯æŠ¥é”™ï¼Œå¹¶æä¾›äº†ä¸€äº›æŠ¥é”™æ—¥å¿—ã€‚ä½ åº”è¯¥æ€ä¹ˆæ¥åˆ†æå’Œè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ</p><pre><code class=\"language-plain\">ERROR druid.sql.Statement -{conn-10094, stmt-26348} execute error. SELECT 1 FROM DUAL\ncom.mysql.cj.jdbc.exceptions.CommunicationsException: The last packet successfully received from the server was 11,394,944 milliseconds ago. The last packet sent successfully to the server was 11,394,950 milliseconds ago. is longer than the server configured value of 'wait_timeout'. You should consider either expiring and/or testing connection validity before use in your application, increasing the server configured values for client timeouts, or using the Connector/J connection property 'autoReconnect=true' to avoid this problem.\n\nThe last packet successfully received from the server was 899,883 milliseconds ago. The last packet sent successfully to the server was 899,890 milliseconds ago.\nCaused by: java.io.EOFException: Can not read response from server. Expected to read 4 bytes, read 0 bytes before connection was unexpectedly lost.\n\nThe last packet successfully received from the server was 1,799,883 milliseconds ago. The last packet sent successfully to the server was 1,799,891 milliseconds ago.\nCaused by: java.io.EOFException: Can not read response from server. Expected to read 4 bytes, read 0 bytes before connection was unexpectedly lost.\n</code></pre><p>æœŸå¾…ä½ çš„æ€è€ƒï¼Œæ¬¢è¿åœ¨ç•™è¨€åŒºä¸­ä¸æˆ‘äº¤æµã€‚å¦‚æœä»Šå¤©çš„è¯¾ç¨‹è®©ä½ æœ‰æ‰€æ”¶è·ï¼Œä¹Ÿæ¬¢è¿è½¬å‘ç»™æœ‰éœ€è¦çš„æœ‹å‹ã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼</p>","comments":[{"had_liked":false,"id":393632,"user_name":"Geek_0126","can_delete":false,"product_type":"c1","uid":3952196,"ip_address":"æµ™æ±Ÿ","ucode":"2916F7FB3F6D71","user_header":"https://static001.geekbang.org/account/avatar/00/3c/4e/44/49b29792.jpg","comment_is_top":false,"comment_ctime":1724398186,"is_pvip":false,"replies":[{"id":142947,"content":"1. é¦–å…ˆç¡®è®¤è¿æ¥çš„ç©ºé—²è¶…æ—¶æ—¶é—´ï¼Œ8.0å¯ä»¥è¿™ä¹ˆæŸ¥ï¼šselect * from performance_schema.variables_by_thread where variable_name = &#39;wait_timeout&#39;ã€‚è€ä¸€ç‚¹çš„ç‰ˆæœ¬å¯ä»¥é€šè¿‡åº”ç”¨ç¨‹åºæ‰§è¡Œshow variables where variable_name in (&#39;wait_timeout&#39;)æ¥ç¡®è®¤ã€‚\n\n2. ç¡®è®¤æŠ¥é”™æ—¶ï¼Œç¦»è¿™ä¸ªè¿æ¥ä¸­çš„ä¸Šä¸€ä¸ªè¯·æ±‚è¿‡äº†å¤šå°‘æ—¶é—´ã€‚jdbcæŠ¥é”™ä¿¡æ¯ä¸­å°±æä¾›äº†è¿™ä¸ªæ—¶é—´ã€‚æœ‰æ—¶ç¨‹åºåˆšå¯åŠ¨æ²¡å¤šä¹…å°±æŠ¥è¿æ¥æ–­å¼€ï¼Œé‚£ä¹ˆè¦æŸ¥çœ‹æ•°æ®åº“æˆ–è€…åº”ç”¨åˆ°æ•°æ®åº“ä¹‹é—´çš„ç½‘ç»œé“¾è·¯æœ‰æ²¡æœ‰å¼‚å¸¸ã€‚\n\n3. é€šè¿‡show processlistè§‚å¯Ÿcommandä¸ºSleepçš„è¿æ¥ï¼Œæ—¶é—´æ˜¯å¤šå°‘ã€‚\n\n4. è¿˜å¯ä»¥æ‰§è¡Œä¸€äº›è€—æ—¶æ¯”è¾ƒé•¿çš„SQLï¼Œçœ‹çœ‹æ˜¯å¦èƒ½æ­£å¸¸æ‰§è¡Œã€‚æ¯”å¦‚select sleep(901);  æœ‰ä¸€ä¸ªæ¡ˆä¾‹ä¸­ï¼Œåº”ç”¨é€šè¿‡ä»£ç†è®¿é—®æ•°æ®åº“ï¼Œä»£ç†çš„è¶…æ—¶æ—¶é—´æ˜¯900ç§’ï¼Œå› æ­¤ select sleep(901)æ— æ³•æ‰§è¡Œå®Œæˆã€‚\n\n5. å¦‚æœä½¿ç”¨äº†è¿æ¥æ± ï¼Œè¦ç¡®è®¤è¿æ¥æ± çš„ä¸€äº›å‚æ•°æ˜¯å¦ç”Ÿæ•ˆã€‚æ¯”å¦‚é…ç½®äº†Keepaliveï¼Œé‚£ä¹ˆè¦çœ‹çœ‹æ˜¯ä¸æ˜¯åœ¨è®¾ç½®çš„é—´éš”æ—¶é—´é‡Œç¡®å®å‘é€äº†keepaliveçš„SQLã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3898827,"ctime":1724547693,"ip_address":"æµ™æ±Ÿ","comment_id":393632,"utype":1}],"discussion_count":0,"race_medal":0,"score":2,"product_id":100799401,"comment_content":"æ€è€ƒé¢˜è¿™ç§æŠ¥é”™ç¡®å®ç»å¸¸é‡åˆ°ï¼Œå¼€å‘è¯´æ˜¯æ•°æ®åº“é—®é¢˜ï¼ŒDBAè¯´æ˜¯ç¨‹åºé…ç½®é—®é¢˜ï¼Œä¸€èˆ¬éƒ½æ˜¯å»ºè®®æ’æŸ¥ç¨‹åºè¿æ¥æ± åŠé‡å¯åº”ç”¨ï¼ŒæœŸå¾…è€å¸ˆçš„å›ç­”ã€‚","like_count":3},{"had_liked":false,"id":394128,"user_name":"ç¬™ é¸¢","can_delete":false,"product_type":"c1","uid":3951358,"ip_address":"ä¸Šæµ·","ucode":"477AF524212C6D","user_header":"https://static001.geekbang.org/account/avatar/00/3c/4a/fe/7b6bd101.jpg","comment_is_top":false,"comment_ctime":1725896259,"is_pvip":false,"replies":[{"id":143078,"content":"å¦‚æœæ˜¯mysqlè‡ªå¸¦çš„å‘½ä»¤è¡Œå®¢æˆ·ç«¯ï¼Œè¿æ¥åˆ°æ•°æ®åº“æ—¶ï¼Œä¼šå°†ä¼šè¯çš„wait_timeoutè®¾ç½®ä¸ºinteractive_timeoutã€‚ä½ å¯ä»¥çœ‹ä¸€ä¸‹show global variables like &#39;interactive_timeout&#39;;","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3898827,"ctime":1725947484,"ip_address":"æµ™æ±Ÿ","comment_id":394128,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100799401,"comment_content":"è€å¸ˆï¼Œshow variables like &quot;wait_timeout&quot;;å’Œshow global variables like &quot;wait_timeout&quot;ä¸ä¸€è‡´ï¼Œå¯æ˜¯è¿æ¥æ•°æ®åº“ä¹‹åå¹¶æ²¡æœ‰set ä¿®æ”¹ä¼šè¯å˜é‡å€¼å•Šï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå•Šï¼Ÿ","like_count":1,"discussions":[{"author":{"id":3898827,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/7d/cb/fa3dae58.jpg","nickname":"ä¿Šè¾¾","note":"","ucode":"F79BF9651AD086","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":650960,"discussion_content":"å¦‚æœæ˜¯mysqlè‡ªå¸¦çš„å‘½ä»¤è¡Œå®¢æˆ·ç«¯ï¼Œè¿æ¥åˆ°æ•°æ®åº“æ—¶ï¼Œä¼šå°†ä¼šè¯çš„wait_timeoutè®¾ç½®ä¸ºinteractive_timeoutã€‚ä½ å¯ä»¥çœ‹ä¸€ä¸‹show global variables like &#39;interactive_timeout&#39;;","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1725947484,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":393803,"user_name":"TheOne","can_delete":false,"product_type":"c1","uid":1582134,"ip_address":"åŒ—äº¬","ucode":"2A359780156A8B","user_header":"https://static001.geekbang.org/account/avatar/00/18/24/36/0829cbdc.jpg","comment_is_top":false,"comment_ctime":1724931381,"is_pvip":false,"replies":[{"id":142990,"content":"ä¼šè¯çº§åˆ«å˜é‡æ˜¯æŒ‡æ¯ä¸ªè¿æ¥å¯ä»¥å„è‡ªçš„å˜é‡ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3898827,"ctime":1724998660,"ip_address":"æµ™æ±Ÿ","comment_id":393803,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100799401,"comment_content":"è€å¸ˆï¼Œæ–‡ä¸­çš„ä¼šè¯çº§åˆ«å˜é‡æ˜¯ä»€ä¹ˆæ„æ€ï¼Œæ˜¯è¯´ä¸€ä¸ªè¿æ¥é‡Œå¯ä»¥ç›´æ¥è®¾ç½®çš„å˜é‡ï¼Œè¿˜æ˜¯è¯´ä¸€ä¸ªäº‹åŠ¡é‡Œå¯ä»¥è®¾ç½®çš„å˜é‡ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":3898827,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/7d/cb/fa3dae58.jpg","nickname":"ä¿Šè¾¾","note":"","ucode":"F79BF9651AD086","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":650443,"discussion_content":"ä¼šè¯çº§åˆ«å˜é‡æ˜¯æŒ‡æ¯ä¸ªè¿æ¥å¯ä»¥å„è‡ªçš„å˜é‡ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1724998660,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":393629,"user_name":"ç¾å¦™çš„ä»£ç ","can_delete":false,"product_type":"c1","uid":1111985,"ip_address":"å››å·","ucode":"9DADD72C193296","user_header":"https://static001.geekbang.org/account/avatar/00/10/f7/b1/982ea185.jpg","comment_is_top":false,"comment_ctime":1724381882,"is_pvip":true,"replies":[{"id":142946,"content":"çœ‹è¿™é‡Œçš„å‚æ•°è®¾ç½®ï¼Œå¯¹äºåº”ç”¨ç¨‹åºçš„è¿æ¥ï¼Œç©ºé—²è¶…æ—¶åº”è¯¥æ˜¯3600ç§’ã€‚é‚£ä¹ˆå¦‚æœè¿æ¥ç¡®å®æ—¶ç©ºé—²è¶…è¿‡äº†3600ï¼Œé‚£ä¹ˆè¿æ¥æ–­å¼€æ˜¯ç¬¦åˆMySQLçš„æ­£å¸¸è¡Œä¸ºçš„ã€‚\n\nä½†æ˜¯è¿æ¥åˆ°åº•ç©ºé—²äº†å¤šå°‘æ—¶é—´å‘¢ï¼Ÿå¦‚æœæ˜¯JDBCï¼Œå¯ä»¥æ ¹æ®æŠ¥é”™ä¿¡æ¯é‡Œçš„æ—¶é—´æ¥åˆ¤æ–­ï¼Œæ¯”å¦‚â€œThe last packet successfully received from the server was 1,799,883 millisecondsâ€ agoï¼Œä¸Šä¸€ä¸ªè¯·æ±‚æ˜¯1800ä¹‹å‰çš„ã€‚\n\nå…¶ä»–å®¢æˆ·ç«¯å¯èƒ½æ²¡æä¾›è¿™ä¸ªæ—¶é—´ä¿¡æ¯ã€‚å¯ä»¥ä½¿ç”¨show processlistè§‚å¯Ÿä¼šè¯çš„Sleepæ—¶é—´ã€‚æœ‰ä¸€ä¸ªåœºæ™¯ä¸‹ï¼Œæˆ‘å‘ç°Sleepæ—¶é—´ä¸€åˆ°900ç§’ï¼Œè¿æ¥å°±æ¶ˆå¤±äº†ï¼Œè¿œè¿œå°äºwait_timeoutçš„é…ç½®ï¼Œé‚£ä¹ˆå°±è¦è€ƒè™‘å…¶ä»–åŸå› äº†ã€‚\n\nå¦å¤–ä¸€ç§æƒ…å†µï¼Œå¯èƒ½æ˜¯åº”ç”¨ç¨‹åºè®¾ç½®äº†ä¸åŒçš„ç©ºé—²è¶…æ—¶æ—¶é—´ï¼Œä½ å¯ä»¥é€šè¿‡åº”ç”¨ç¨‹åºæ‰§è¡Œshow variables where variable_name in (&#39;wait_timeout&#39;)ï¼Œçœ‹çœ‹å®é™…çš„è¶…æ—¶æ—¶é—´æ˜¯å¤šå°‘ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3898827,"ctime":1724546638,"ip_address":"æµ™æ±Ÿ","comment_id":393629,"utype":1}],"discussion_count":0,"race_medal":1,"score":2,"product_id":100799401,"comment_content":"è€å¸ˆï¼Œæˆ‘è¿™è¾¹æœ‰ä¸ªæ¡ˆä¾‹ï¼š\nserver å‚æ•°ï¼š\nwait_timeout ï¼š3600   \ninteractive_timeout ï¼š7200  \nmax_allowed_packet ï¼š1G\n\nå®¢æœç«¯ç»å¸¸å‡ºç°é”™è¯¯ï¼š(MySQLdb.OperationalError) (2013, &#39;Lost connection to MySQL server during query&#39;)\nMySQLæœåŠ¡å™¨ç»å¸¸çœ‹è§é”™è¯¯ï¼š Aborted connection 87082567 to db: &#39;test&#39; user: &#39;test&#39; host: &#39;x.x.x.x&#39; (Got timeout reading communication packets)\n\nè¿™æ˜¯å“ªå„¿æ²¡æœ‰é…ç½®å¯¹å—ï¼Ÿè¿˜æ˜¯å…¶ä»–é—®é¢˜ï¼Ÿ","like_count":0},{"had_liked":false,"id":393625,"user_name":"kalid","can_delete":false,"product_type":"c1","uid":1146743,"ip_address":"å¹¿ä¸œ","ucode":"DAB173AC689C5E","user_header":"https://static001.geekbang.org/account/avatar/00/11/7f/77/8c34e407.jpg","comment_is_top":false,"comment_ctime":1724351782,"is_pvip":true,"replies":[{"id":142944,"content":"è¯¾ç¨‹æŒç»­æ›´æ–°ä¸­ï¼šï¼‰","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3898827,"ctime":1724466805,"ip_address":"æµ™æ±Ÿ","comment_id":393625,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100799401,"comment_content":"å—ç”¨ï¼Œå‚¬æ›´ğŸ˜„","like_count":0,"discussions":[{"author":{"id":3898827,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/7d/cb/fa3dae58.jpg","nickname":"ä¿Šè¾¾","note":"","ucode":"F79BF9651AD086","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":650156,"discussion_content":"è¯¾ç¨‹æŒç»­æ›´æ–°ä¸­ï¼šï¼‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1724466805,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]}]}