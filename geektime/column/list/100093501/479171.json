{"id":479171,"title":"35ï½œå³å­¦å³ç»ƒï¼šå¦‚ä½•å®ç°ä¸€ä¸ªè½»é‡çº§çº¿ç¨‹æ± ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯Tony Baiã€‚</p><p>åœ¨è¿™ä¸€è®²çš„å¼€å§‹ï¼Œé¦–å…ˆæ­å–œä½ å®Œæˆäº†è¿™é—¨è¯¾æ ¸å¿ƒç¯‡è¯­æ³•éƒ¨åˆ†çš„å­¦ä¹ ã€‚è¿™ä¸€éƒ¨åˆ†çš„ç¯‡å¹…ä¸å¤šï¼Œä¸»è¦è®²è§£äº†Goçš„ä¸¤ä¸ªæ ¸å¿ƒè¯­æ³•çŸ¥è¯†ç‚¹ï¼šæ¥å£ä¸å¹¶å‘åŸè¯­ã€‚å®ƒä»¬åˆ†åˆ«æ˜¯è€¦åˆè®¾è®¡ä¸å¹¶å‘è®¾è®¡çš„ä¸»è¦å‚ä¸è€…ï¼ŒGoåº”ç”¨çš„éª¨æ¶è®¾è®¡ç¦»ä¸å¼€å®ƒä»¬ã€‚</p><p>ä½†ç†è®ºå’Œå®è·µæ¯•ç«Ÿæ˜¯ä¸¤å›äº‹ï¼Œå­¦å®Œäº†åŸºæœ¬è¯­æ³•ï¼Œä¹Ÿéœ€è¦å®æ“æ¥å¸®åŠ©æˆ‘ä»¬è½åœ°ã€‚æ‰€ä»¥ï¼Œåœ¨è¿™æ ¸å¿ƒç¯‡çš„æœ€åä¸€è®²ï¼Œæˆ‘ä¾ç„¶ä¼šç”¨ä¸€ä¸ªå°å®æˆ˜é¡¹ç›®ï¼Œå¸®åŠ©ä½ å­¦ä¼šçµæ´»è¿ç”¨è¿™éƒ¨åˆ†çš„è¯­æ³•ç‚¹ã€‚</p><p>ä¸è¿‡ï¼Œå…³äºæ¥å£ç±»å‹åšä¸ºâ€œå…³èŠ‚â€ä½œç”¨çš„æ¼”ç¤ºï¼Œæˆ‘ä»¬å‰é¢çš„ä¸¤ä¸ªå°å®æˆ˜é¡¹ç›®ä¸­éƒ½æœ‰ä¸€å®šçš„ä½“ç°äº†ï¼Œåªæ˜¯é‚£æ—¶è¿˜æ²¡æœ‰è®²åˆ°æ¥å£ç±»å‹ï¼Œä½ ç°åœ¨å¯ä»¥åœä¸‹æ¥ï¼Œå›é¡¾ä¸€ä¸‹<a href=\"https://time.geekbang.org/column/article/434017\">09è®²</a>å’Œ<a href=\"https://time.geekbang.org/column/article/471138\">27è®²</a>çš„ä»£ç ï¼Œçœ‹çœ‹æ˜¯å¦æœ‰æ›´æ·±åˆ»çš„ä½“ä¼šã€‚</p><p>è€Œä¸”ï¼Œæ¥å£ç±»å‹å¯¹Goåº”ç”¨é™æ€éª¨æ¶çš„ç¼–ç»‡ä½œç”¨ï¼Œåœ¨æ¥å£ç±»å‹æ•°é‡è¾ƒå¤šçš„é¡¹ç›®ä¸­ä½“ç°å¾—æ›´æ˜æ˜¾ï¼Œç”±äºç¯‡å¹…æœ‰é™ï¼Œæˆ‘å¾ˆéš¾æ‰¾åˆ°ä¸€ä¸ªåˆé€‚çš„æ¼”ç¤ºé¡¹ç›®ã€‚</p><p>å› æ­¤ï¼Œè¿™ä¸€è®²çš„å®æˆ˜é¡¹ç›®ï¼Œæˆ‘ä»¬ä¸»è¦å›´ç»•Goå¹¶å‘æ¥åšï¼Œå®ç°ä¸€ä¸ªè½»é‡çº§çº¿ç¨‹æ± ï¼Œä¹Ÿå°±æ˜¯Goroutineæ± ã€‚</p><h2>ä¸ºä»€ä¹ˆè¦ç”¨åˆ°Goroutineæ± ï¼Ÿ</h2><p>åœ¨<a href=\"https://time.geekbang.org/column/article/475959\">ç¬¬31è®²</a>å­¦ä¹ Goroutineçš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±è¯´è¿‡ï¼šç›¸å¯¹äºæ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼ŒGoroutineçš„å¼€é”€ååˆ†å°ï¼Œä¸€ä¸ªGoroutineçš„èµ·å§‹æ ˆå¤§å°ä¸º2KBï¼Œè€Œä¸”åˆ›å»ºã€åˆ‡æ¢ä¸é”€æ¯çš„ä»£ä»·å¾ˆä½ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºæˆåƒä¸Šä¸‡ç”šè‡³æ›´å¤šGoroutineã€‚</p><!-- [[[read_end]]] --><p>æ‰€ä»¥å’Œå…¶ä»–è¯­è¨€ä¸åŒçš„æ˜¯ï¼ŒGoåº”ç”¨é€šå¸¸å¯ä»¥ä¸ºæ¯ä¸ªæ–°å»ºç«‹çš„è¿æ¥åˆ›å»ºä¸€ä¸ªå¯¹åº”çš„æ–°Goroutineï¼Œç”šè‡³æ˜¯ä¸ºæ¯ä¸ªä¼ å…¥çš„è¯·æ±‚ç”Ÿæˆä¸€ä¸ªGoroutineå»å¤„ç†ã€‚è¿™ç§è®¾è®¡è¿˜æœ‰ä¸€ä¸ªå¥½å¤„ï¼Œå®ç°èµ·æ¥ååˆ†ç®€å•ï¼ŒGopherä»¬åœ¨ç¼–å†™ä»£ç æ—¶ä¹Ÿæ²¡æœ‰å¾ˆé«˜çš„å¿ƒæ™ºè´Ÿæ‹…ã€‚</p><p><strong>ä¸è¿‡ï¼ŒGoroutineçš„å¼€é”€è™½ç„¶â€œå»‰ä»·â€ï¼Œä½†ä¹Ÿä¸æ˜¯å…è´¹çš„</strong>ã€‚</p><p>æœ€æ˜æ˜¾çš„ï¼Œä¸€æ—¦è§„æ¨¡åŒ–åï¼Œè¿™ç§éé›¶æˆæœ¬ä¹Ÿä¼šæˆä¸ºç“¶é¢ˆã€‚æˆ‘ä»¬ä»¥ä¸€ä¸ªGoroutineåˆ†é…2KBæ‰§è¡Œæ ˆä¸ºä¾‹ï¼Œ100w Goroutineå°±æ˜¯2GBçš„å†…å­˜æ¶ˆè€—ã€‚</p><p>å…¶æ¬¡ï¼ŒGoroutineä»<a href=\"https://go.dev/doc/go1.4\">Go 1.4ç‰ˆæœ¬</a>å¼€å§‹é‡‡ç”¨äº†è¿ç»­æ ˆçš„æ–¹æ¡ˆï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªGoroutineçš„æ‰§è¡Œæ ˆéƒ½æ˜¯ä¸€å—è¿ç»­å†…å­˜ï¼Œå¦‚æœç©ºé—´ä¸è¶³ï¼Œè¿è¡Œæ—¶ä¼šåˆ†é…ä¸€ä¸ªæ›´å¤§çš„è¿ç»­å†…å­˜ç©ºé—´ä½œä¸ºè¿™ä¸ªGoroutineçš„æ‰§è¡Œæ ˆï¼Œå°†åŸæ ˆå†…å®¹æ‹·è´åˆ°æ–°åˆ†é…çš„ç©ºé—´ä¸­æ¥ã€‚</p><p>è¿ç»­æ ˆçš„æ–¹æ¡ˆï¼Œè™½ç„¶èƒ½é¿å…Go 1.3é‡‡ç”¨çš„åˆ†æ®µæ ˆä¼šå¯¼è‡´çš„<a href=\"https://docs.google.com/document/d/1wAaf1rYoM4S4gtnPh0zOlGzWtrZFQ5suE8qr2sD8uWQ/pub\">â€œhot splitâ€é—®é¢˜</a>ï¼Œä½†è¿ç»­æ ˆçš„åŸç†ä¹Ÿå†³å®šäº†ï¼Œä¸€æ—¦Goroutineçš„æ‰§è¡Œæ ˆå‘ç”Ÿäº†growï¼Œé‚£ä¹ˆå³ä¾¿è¿™ä¸ªGoroutineä¸å†éœ€è¦é‚£ä¹ˆå¤§çš„æ ˆç©ºé—´ï¼Œè¿™ä¸ªGoroutineçš„æ ˆç©ºé—´ä¹Ÿä¸ä¼šè¢«Shrinkï¼ˆæ”¶ç¼©ï¼‰äº†ï¼Œè¿™äº›ç©ºé—´å¯èƒ½ä¼šå¤„äºé•¿æ—¶é—´é—²ç½®çš„çŠ¶æ€ï¼Œç›´åˆ°Goroutineé€€å‡ºã€‚</p><p>å¦å¤–ï¼Œéšç€Goroutineæ•°é‡çš„å¢åŠ ï¼ŒGoè¿è¡Œæ—¶è¿›è¡ŒGoroutineè°ƒåº¦çš„å¤„ç†å™¨æ¶ˆè€—ï¼Œä¹Ÿä¼šéšä¹‹å¢åŠ ï¼Œæˆä¸ºé˜»ç¢Goåº”ç”¨æ€§èƒ½æå‡çš„é‡è¦å› ç´ ã€‚</p><p>é‚£ä¹ˆé¢å¯¹è¿™æ ·çš„é—®é¢˜ï¼Œå¸¸è§çš„åº”å¯¹æ–¹å¼æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><p>Goroutineæ± å°±æ˜¯ä¸€ç§å¸¸è§çš„è§£å†³æ–¹æ¡ˆã€‚è¿™ä¸ªæ–¹æ¡ˆçš„æ ¸å¿ƒæ€æƒ³æ˜¯å¯¹Goroutineçš„é‡ç”¨ï¼Œä¹Ÿå°±æ˜¯æŠŠMä¸ªè®¡ç®—ä»»åŠ¡è°ƒåº¦åˆ°Nä¸ªGoroutineä¸Šï¼Œè€Œä¸æ˜¯ä¸ºæ¯ä¸ªè®¡ç®—ä»»åŠ¡åˆ†é…ä¸€ä¸ªç‹¬äº«çš„Goroutineï¼Œä»è€Œæé«˜è®¡ç®—èµ„æºçš„åˆ©ç”¨ç‡ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥çœŸæ­£å®ç°ä¸€ä¸ªç®€å•çš„Goroutineæ± ï¼Œæˆ‘ä»¬å«å®ƒ <strong>workerpool</strong>ã€‚</p><h2>workerpoolçš„å®ç°åŸç†</h2><p>workerpoolçš„å·¥ä½œé€»è¾‘é€šå¸¸éƒ½å¾ˆç®€å•ï¼Œæ‰€ä»¥å³ä¾¿æ˜¯ç”¨äºç”Ÿäº§ç¯å¢ƒçš„workerpoolå®ç°ï¼Œä»£ç è§„æ¨¡ä¹Ÿéƒ½åœ¨åƒè¡Œå·¦å³ã€‚</p><p>å½“ç„¶ï¼Œworkerpoolæœ‰å¾ˆå¤šç§å®ç°æ–¹å¼ï¼Œè¿™é‡Œä¸ºäº†æ›´å¥½åœ°æ¼”ç¤ºGoå¹¶å‘æ¨¡å‹çš„åº”ç”¨æ¨¡å¼ï¼Œä»¥åŠå¹¶å‘åŸè¯­é—´çš„åä½œï¼Œæˆ‘ä»¬é‡‡ç”¨å®Œå…¨åŸºäºchannel+selectçš„å®ç°æ–¹æ¡ˆï¼Œä¸ä½¿ç”¨å…¶ä»–æ•°æ®ç»“æ„ï¼Œä¹Ÿä¸ä½¿ç”¨syncåŒ…æä¾›çš„å„ç§åŒæ­¥ç»“æ„ï¼Œæ¯”å¦‚Mutexã€RWMutexï¼Œä»¥åŠCondç­‰ã€‚</p><p>workerpoolçš„å®ç°ä¸»è¦åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š</p><ul>\n<li>poolçš„åˆ›å»ºä¸é”€æ¯ï¼›</li>\n<li>poolä¸­workerï¼ˆGoroutineï¼‰çš„ç®¡ç†ï¼›</li>\n<li>taskçš„æäº¤ä¸è°ƒåº¦ã€‚</li>\n</ul><p>å…¶ä¸­ï¼Œåä¸¤éƒ¨åˆ†æ˜¯poolçš„â€œç²¾é«“â€æ‰€åœ¨ï¼Œè¿™ä¸¤éƒ¨åˆ†çš„åŸç†æˆ‘ä¹Ÿç”¨ä¸€å¼ å›¾è¡¨ç¤ºäº†å‡ºæ¥ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/d4/fd/d48ba3a204ca6e8961a4425573afa0fd.jpg?wh=1920x1047\" alt=\"å›¾ç‰‡\"></p><p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹å›¾ä¸­poolå¯¹workerçš„ç®¡ç†ã€‚</p><p>capacityæ˜¯poolçš„ä¸€ä¸ªå±æ€§ï¼Œä»£è¡¨æ•´ä¸ªpoolä¸­workerçš„æœ€å¤§å®¹é‡ã€‚æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªå¸¦ç¼“å†²çš„channelï¼šactiveï¼Œä½œä¸ºworkerçš„â€œè®¡æ•°å™¨â€ï¼Œè¿™ç§channelä½¿ç”¨æ¨¡å¼å°±æ˜¯æˆ‘ä»¬åœ¨ç¬¬33è®²ä¸­è®²è¿‡çš„<strong>è®¡æ•°ä¿¡å·é‡</strong>ï¼Œå¦‚æœè®°ä¸å¤ªæ¸…äº†å¯ä»¥å¤ä¹ ä¸€ä¸‹<a href=\"https://time.geekbang.org/column/article/477365\">ç¬¬33è®²</a>ä¸­çš„ç›¸å…³å†…å®¹ã€‚</p><p>å½“active channelå¯å†™æ—¶ï¼Œæˆ‘ä»¬å°±åˆ›å»ºä¸€ä¸ªworkerï¼Œç”¨äºå¤„ç†ç”¨æˆ·é€šè¿‡Scheduleå‡½æ•°æäº¤çš„å¾…å¤„ç†çš„è¯·æ±‚ã€‚å½“active channelæ»¡äº†çš„æ—¶å€™ï¼Œpoolå°±ä¼šåœæ­¢workerçš„åˆ›å»ºï¼Œç›´åˆ°æŸä¸ªworkerå› æ•…é€€å‡ºï¼Œactive channelåˆç©ºå‡ºä¸€ä¸ªä½ç½®æ—¶ï¼Œpoolæ‰ä¼šåˆ›å»ºæ–°çš„workerå¡«è¡¥é‚£ä¸ªç©ºä½ã€‚</p><p>è¿™å¼ å›¾é‡Œï¼Œæˆ‘ä»¬æŠŠç”¨æˆ·è¦æäº¤ç»™workerpoolæ‰§è¡Œçš„è¯·æ±‚æŠ½è±¡ä¸ºä¸€ä¸ªTaskã€‚Taskçš„æäº¤ä¸è°ƒåº¦ä¹Ÿå¾ˆç®€å•ï¼šTaské€šè¿‡Scheduleå‡½æ•°æäº¤åˆ°ä¸€ä¸ªtask channelä¸­ï¼Œå·²ç»åˆ›å»ºçš„workerå°†ä»è¿™ä¸ªtask channelä¸­è¯»å–taskå¹¶æ‰§è¡Œã€‚</p><p>å¥½äº†ï¼â€œTalk is cheapï¼Œshow me the codeâ€ï¼æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥å†™ä¸€ç‰ˆworkerpoolçš„ä»£ç ï¼Œæ¥éªŒè¯ä¸€ä¸‹è¿™é‡Œåˆ†æçš„åŸç†æ˜¯å¦å¯è¡Œã€‚</p><h2>workerpoolçš„ä¸€ä¸ªæœ€å°å¯è¡Œå®ç°</h2><p>æˆ‘ä»¬å…ˆå»ºç«‹workerpoolç›®å½•ä½œä¸ºå®æˆ˜é¡¹ç›®çš„æºç æ ¹ç›®å½•ï¼Œç„¶åä¸ºè¿™ä¸ªé¡¹ç›®åˆ›å»ºgo moduleï¼š</p><pre><code class=\"language-plain\">$mkdir workerpool1\n$cd workerpool1\n$go mod init github.com/bigwhite/workerpool\n</code></pre><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ›å»ºpool.goä½œä¸ºworkpoolåŒ…çš„ä¸»è¦æºç æ–‡ä»¶ã€‚åœ¨è¿™ä¸ªæºç æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†Poolç»“æ„ä½“ç±»å‹ï¼Œè¿™ä¸ªç±»å‹çš„å®ä¾‹ä»£è¡¨ä¸€ä¸ªworkerpoolï¼š</p><pre><code class=\"language-plain\">type Pool struct {\n    capacity int         // workerpoolå¤§å°\n\n    active chan struct{} // å¯¹åº”ä¸Šå›¾ä¸­çš„active channel\n    tasks  chan Task     // å¯¹åº”ä¸Šå›¾ä¸­çš„task channel\n\n    wg   sync.WaitGroup  // ç”¨äºåœ¨poolé”€æ¯æ—¶ç­‰å¾…æ‰€æœ‰workeré€€å‡º\n    quit chan struct{}   // ç”¨äºé€šçŸ¥å„ä¸ªworkeré€€å‡ºçš„ä¿¡å·channel\n}\n</code></pre><p>workerpoolåŒ…å¯¹å¤–ä¸»è¦æä¾›ä¸‰ä¸ªAPIï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ï¼š</p><ul>\n<li>workerpool.Newï¼šç”¨äºåˆ›å»ºä¸€ä¸ªpoolç±»å‹å®ä¾‹ï¼Œå¹¶å°†poolæ± çš„workerç®¡ç†æœºåˆ¶è¿è¡Œèµ·æ¥ï¼›</li>\n<li>workerpool.Freeï¼šç”¨äºé”€æ¯ä¸€ä¸ªpoolæ± ï¼Œåœæ‰æ‰€æœ‰poolæ± ä¸­çš„workerï¼›</li>\n<li>Pool.Scheduleï¼šè¿™æ˜¯Poolç±»å‹çš„ä¸€ä¸ªå¯¼å‡ºæ–¹æ³•ï¼ŒworkerpoolåŒ…çš„ç”¨æˆ·é€šè¿‡è¯¥æ–¹æ³•å‘poolæ± æäº¤å¾…æ‰§è¡Œçš„ä»»åŠ¡ï¼ˆTaskï¼‰ã€‚</li>\n</ul><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±é‡ç‚¹çœ‹çœ‹è¿™ä¸‰ä¸ªAPIçš„å®ç°ã€‚</p><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹workerpool.Newæ˜¯å¦‚ä½•åˆ›å»ºä¸€ä¸ªpoolå®ä¾‹çš„ï¼š</p><pre><code class=\"language-plain\">func New(capacity int) *Pool {\n    if capacity &lt;= 0 {\n        capacity = defaultCapacity\n    }\n    if capacity &gt; maxCapacity { \n        capacity = maxCapacity\n    } \n\n    p := &amp;Pool{\n        capacity: capacity,\n        tasks:    make(chan Task),\n        quit:     make(chan struct{}),\n        active:   make(chan struct{}, capacity),\n    }\n\n    fmt.Printf(\"workerpool start\\n\")\n\n    go p.run()\n\n    return p\n}\n</code></pre><p>æˆ‘ä»¬çœ‹åˆ°ï¼ŒNewå‡½æ•°æ¥å—ä¸€ä¸ªå‚æ•°capacityç”¨äºæŒ‡å®šworkerpoolæ± çš„å®¹é‡ï¼Œè¿™ä¸ªå‚æ•°ç”¨äºæ§åˆ¶workerpoolæœ€å¤šåªèƒ½æœ‰capacityä¸ªworkerï¼Œå…±åŒå¤„ç†ç”¨æˆ·æäº¤çš„ä»»åŠ¡è¯·æ±‚ã€‚å‡½æ•°å¼€å§‹å¤„æœ‰ä¸€ä¸ªå¯¹capacityå‚æ•°çš„â€œé˜²å¾¡æ€§â€æ ¡éªŒï¼Œå½“ç”¨æˆ·ä¼ å…¥ä¸åˆç†çš„å€¼æ—¶ï¼Œå‡½æ•°Newä¼šå°†å®ƒçº æ­£ä¸ºåˆç†çš„å€¼ã€‚</p><p>Poolç±»å‹å®ä¾‹å˜é‡på®Œæˆåˆå§‹åŒ–åï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„Goroutineï¼Œç”¨äºå¯¹workerpoolè¿›è¡Œç®¡ç†ï¼Œè¿™ä¸ªGoroutineæ‰§è¡Œçš„æ˜¯Poolç±»å‹çš„runæ–¹æ³•ï¼š</p><pre><code class=\"language-plain\">func (p *Pool) run() { \n    idx := 0 \n\n    for { \n        select { \n        case &lt;-p.quit:\n            return\n        case p.active &lt;- struct{}{}:\n            // create a new worker\n            idx++\n            p.newWorker(idx)\n        } \n    } \n}\n</code></pre><p>runæ–¹æ³•å†…æ˜¯ä¸€ä¸ªæ— é™å¾ªç¯ï¼Œå¾ªç¯ä½“ä¸­ä½¿ç”¨selectç›‘è§†Poolç±»å‹å®ä¾‹çš„ä¸¤ä¸ªchannelï¼šquitå’Œactiveã€‚è¿™ç§åœ¨forä¸­ä½¿ç”¨selectç›‘è§†å¤šä¸ªchannelçš„å®ç°ï¼Œåœ¨Goä»£ç ä¸­ååˆ†å¸¸è§ï¼Œæ˜¯ä¸€ç§æƒ¯ç”¨æ³•ã€‚</p><p>å½“æ¥æ”¶åˆ°æ¥è‡ªquit channelçš„é€€å‡ºâ€œä¿¡å·â€æ—¶ï¼Œè¿™ä¸ªGoroutineå°±ä¼šç»“æŸè¿è¡Œã€‚è€Œå½“active channelå¯å†™æ—¶ï¼Œrunæ–¹æ³•å°±ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„worker Goroutineã€‚ æ­¤å¤–ï¼Œä¸ºäº†æ–¹ä¾¿åœ¨ç¨‹åºä¸­åŒºåˆ†å„ä¸ªworkerè¾“å‡ºçš„æ—¥å¿—ï¼Œæˆ‘è¿™é‡Œå°†ä¸€ä¸ªä»1å¼€å§‹çš„å˜é‡idxä½œä¸ºworkerçš„ç¼–å·ï¼Œå¹¶æŠŠå®ƒä»¥å‚æ•°çš„å½¢å¼ä¼ ç»™åˆ›å»ºworkerçš„æ–¹æ³•ã€‚</p><p>æˆ‘ä»¬å†å°†åˆ›å»ºæ–°çš„worker goroutineçš„èŒè´£ï¼Œå°è£…åˆ°ä¸€ä¸ªåä¸ºnewWorkerçš„æ–¹æ³•ä¸­ï¼š</p><pre><code class=\"language-plain\">func (p *Pool) newWorker(i int) {\n    p.wg.Add(1)\n    go func() {\n        defer func() {\n            if err := recover(); err != nil {\n                fmt.Printf(\"worker[%03d]: recover panic[%s] and exit\\n\", i, err)\n                &lt;-p.active\n            }\n            p.wg.Done()\n        }()\n\n        fmt.Printf(\"worker[%03d]: start\\n\", i)\n\n        for {\n            select {\n            case &lt;-p.quit:\n                fmt.Printf(\"worker[%03d]: exit\\n\", i)\n                &lt;-p.active\n                return\n            case t := &lt;-p.tasks:\n                fmt.Printf(\"worker[%03d]: receive a task\\n\", i)\n                t()\n            }\n        }\n    }()\n}\n</code></pre><p>æˆ‘ä»¬çœ‹åˆ°ï¼Œåœ¨åˆ›å»ºä¸€ä¸ªæ–°çš„worker goroutineä¹‹å‰ï¼ŒnewWorkeræ–¹æ³•ä¼šå…ˆè°ƒç”¨p.wg.Addæ–¹æ³•å°†WaitGroupçš„ç­‰å¾…è®¡æ•°åŠ ä¸€ã€‚ç”±äºæ¯ä¸ªworkerè¿è¡Œäºä¸€ä¸ªç‹¬ç«‹çš„Goroutineä¸­ï¼ŒnewWorkeræ–¹æ³•é€šè¿‡goå…³é”®å­—åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„Goroutineä½œä¸ºworkerã€‚</p><p>æ–°workerçš„æ ¸å¿ƒï¼Œä¾ç„¶æ˜¯ä¸€ä¸ªåŸºäºfor-selectæ¨¡å¼çš„å¾ªç¯è¯­å¥ï¼Œåœ¨å¾ªç¯ä½“ä¸­ï¼Œæ–°workeré€šè¿‡selectç›‘è§†quitå’Œtasksä¸¤ä¸ªchannelã€‚å’Œå‰é¢çš„runæ–¹æ³•ä¸€æ ·ï¼Œå½“æ¥æ”¶åˆ°æ¥è‡ªquit channelçš„é€€å‡ºâ€œä¿¡å·â€æ—¶ï¼Œè¿™ä¸ªworkerå°±ä¼šç»“æŸè¿è¡Œã€‚tasks channelä¸­æ”¾ç½®çš„æ˜¯ç”¨æˆ·é€šè¿‡Scheduleæ–¹æ³•æäº¤çš„è¯·æ±‚ï¼Œæ–°workerä¼šä»è¿™ä¸ªchannelä¸­è·å–æœ€æ–°çš„Taskå¹¶è¿è¡Œè¿™ä¸ªTaskã€‚</p><p>Taskæ˜¯ä¸€ä¸ªå¯¹ç”¨æˆ·æäº¤çš„è¯·æ±‚çš„æŠ½è±¡ï¼Œå®ƒçš„æœ¬è´¨å°±æ˜¯ä¸€ä¸ªå‡½æ•°ç±»å‹ï¼š</p><pre><code class=\"language-plain\">type Task func()\n</code></pre><p>è¿™æ ·ï¼Œç”¨æˆ·é€šè¿‡Scheduleæ–¹æ³•å®é™…ä¸Šæäº¤çš„æ˜¯ä¸€ä¸ªå‡½æ•°ç±»å‹çš„å®ä¾‹ã€‚</p><p>åœ¨æ–°workerä¸­ï¼Œä¸ºäº†é˜²æ­¢ç”¨æˆ·æäº¤çš„taskæŠ›å‡ºpanicï¼Œè¿›è€Œå¯¼è‡´æ•´ä¸ªworkerpoolå—åˆ°å½±å“ï¼Œæˆ‘ä»¬åœ¨workerä»£ç çš„å¼€å§‹å¤„ï¼Œä½¿ç”¨äº†defer+recoverå¯¹panicè¿›è¡Œæ•æ‰ï¼Œæ•æ‰åworkerä¹Ÿæ˜¯è¦é€€å‡ºçš„ï¼Œäºæ˜¯æˆ‘ä»¬è¿˜é€šè¿‡<code>&lt;-p.active</code>æ›´æ–°äº†workerè®¡æ•°å™¨ã€‚å¹¶ä¸”ä¸€æ—¦worker goroutineé€€å‡ºï¼Œp.wg.Doneä¹Ÿéœ€è¦è¢«è°ƒç”¨ï¼Œè¿™æ ·å¯ä»¥å‡å°‘WaitGroupçš„Goroutineç­‰å¾…æ•°é‡ã€‚</p><p>æˆ‘ä»¬å†æ¥çœ‹workerpoolæä¾›ç»™ç”¨æˆ·æäº¤è¯·æ±‚çš„å¯¼å‡ºæ–¹æ³•Scheduleï¼š</p><pre><code class=\"language-plain\">var ErrWorkerPoolFreed    = errors.New(\"workerpool freed\")       // workerpoolå·²ç»ˆæ­¢è¿è¡Œ\n\nfunc (p *Pool) Schedule(t Task) error {\n    select {\n    case &lt;-p.quit:\n        return ErrWorkerPoolFreed\n    case p.tasks &lt;- t:\n        return nil\n    }\n}\n</code></pre><p>Scheduleæ–¹æ³•çš„æ ¸å¿ƒé€»è¾‘ï¼Œæ˜¯å°†ä¼ å…¥çš„Taskå®ä¾‹å‘é€åˆ°workerpoolçš„tasks channelä¸­ã€‚ä½†è€ƒè™‘åˆ°ç°åœ¨workerpoolå·²ç»è¢«é”€æ¯çš„çŠ¶æ€ï¼Œæˆ‘ä»¬è¿™é‡Œé€šè¿‡ä¸€ä¸ªselectï¼Œæ£€è§†quit channelæ˜¯å¦æœ‰â€œä¿¡å·â€å¯è¯»ï¼Œå¦‚æœæœ‰ï¼Œå°±è¿”å›ä¸€ä¸ªå“¨å…µé”™è¯¯ErrWorkerPoolFreedã€‚å¦‚æœæ²¡æœ‰ï¼Œä¸€æ—¦p.taskså¯å†™ï¼Œæäº¤çš„Taskå°±ä¼šè¢«å†™å…¥tasks channelï¼Œä»¥ä¾›poolä¸­çš„workerå¤„ç†ã€‚</p><p>è¿™é‡Œè¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„Poolç»“æ„ä½“ä¸­çš„tasksæ˜¯ä¸€ä¸ªæ— ç¼“å†²çš„channelï¼Œå¦‚æœpoolä¸­workeræ•°é‡å·²è¾¾ä¸Šé™ï¼Œè€Œä¸”workeréƒ½åœ¨å¤„ç†taskçš„çŠ¶æ€ï¼Œé‚£ä¹ˆScheduleæ–¹æ³•å°±ä¼šé˜»å¡ï¼Œç›´åˆ°æœ‰workerå˜ä¸ºidleçŠ¶æ€æ¥è¯»å–tasks channelï¼Œscheduleçš„è°ƒç”¨é˜»å¡æ‰ä¼šè§£é™¤ã€‚</p><p>è‡³æ­¤ï¼Œworkerpoolçš„æœ€å°å¯è¡Œå®ç°çš„ä¸»è¦é€»è¾‘éƒ½å®ç°å®Œäº†ã€‚æˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹å®ƒæ˜¯å¦èƒ½æŒ‰ç…§æˆ‘ä»¬çš„é¢„æœŸé€»è¾‘è¿è¡Œã€‚</p><p>ç°åœ¨æˆ‘ä»¬å»ºç«‹ä¸€ä¸ªä½¿ç”¨workerpoolçš„é¡¹ç›®demo1ï¼š</p><pre><code class=\"language-plain\">$mkdir demo1\n$cd demo1\n$go mod init demo1\n</code></pre><p>ç”±äºæˆ‘ä»¬è¦å¼•ç”¨æœ¬åœ°çš„moduleï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ‰‹å·¥ä¿®æ”¹ä¸€ä¸‹demo1çš„go.modæ–‡ä»¶ï¼Œå¹¶åˆ©ç”¨replaceæŒ‡ç¤ºç¬¦å°†demo1å¯¹workerpoolçš„å¼•ç”¨æŒ‡å‘æœ¬åœ°workerpool1è·¯å¾„ï¼š</p><pre><code class=\"language-plain\">module demo1\n\ngo 1.17\n\nrequire github.com/bigwhite/workerpool v1.0.0\n\nreplace github.com/bigwhite/workerpool v1.0.0 =&gt; ../workerpool1\n</code></pre><p>ç„¶ååˆ›å»ºdemo1çš„main.goæ–‡ä»¶ï¼Œæºç å¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">package main\n  \nimport (\n    \"time\"\n    \"github.com/bigwhite/workerpool\"\n)\n\nfunc main() {\n    p := workerpool.New(5)\n\n    for i := 0; i &lt; 10; i++ {\n        err := p.Schedule(func() {\n            time.Sleep(time.Second * 3)\n        })\n        if err != nil {\n            println(\"task: \", i, \"err:\", err)\n        }\n    }\n\n    p.Free()\n}\n</code></pre><p>è¿™ä¸ªç¤ºä¾‹ç¨‹åºåˆ›å»ºäº†ä¸€ä¸ªcapacityä¸º5çš„workerpoolå®ä¾‹ï¼Œå¹¶è¿ç»­å‘è¿™ä¸ªworkerpoolæäº¤äº†10ä¸ªtaskï¼Œæ¯ä¸ªtaskçš„é€»è¾‘å¾ˆç®€å•ï¼Œåªæ˜¯Sleep 3ç§’åå°±é€€å‡ºã€‚mainå‡½æ•°åœ¨æäº¤å®Œä»»åŠ¡åï¼Œè°ƒç”¨workerpoolçš„Freeæ–¹æ³•é”€æ¯poolï¼Œpoolä¼šç­‰å¾…æ‰€æœ‰workeræ‰§è¡Œå®Œtaskåå†é€€å‡ºã€‚</p><p>demo1ç¤ºä¾‹çš„è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">workerpool start\nworker[005]: start\nworker[005]: receive a task\nworker[003]: start\nworker[003]: receive a task\nworker[004]: start\nworker[004]: receive a task\nworker[001]: start\nworker[002]: start\nworker[001]: receive a task\nworker[002]: receive a task\nworker[004]: receive a task\nworker[005]: receive a task\nworker[003]: receive a task\nworker[002]: receive a task\nworker[001]: receive a task\nworker[001]: exit\nworker[005]: exit\nworker[002]: exit\nworker[003]: exit\nworker[004]: exit\nworkerpool freed\n</code></pre><p>ä»è¿è¡Œçš„è¾“å‡ºç»“æœæ¥çœ‹ï¼Œworkerpoolçš„æœ€å°å¯è¡Œå®ç°çš„è¿è¡Œé€»è¾‘ä¸æˆ‘ä»¬çš„åŸç†å›¾æ˜¯ä¸€è‡´çš„ã€‚</p><p>ä¸è¿‡ï¼Œç›®å‰çš„workerpoolå®ç°å¥½æ¯”â€œé“æ¿ä¸€å—â€ï¼Œè™½ç„¶æˆ‘ä»¬å¯ä»¥é€šè¿‡capacityå‚æ•°å¯ä»¥æŒ‡å®šworkerpoolå®¹é‡ï¼Œä½†æˆ‘ä»¬æ— æ³•å¯¹workerpoolçš„è¡Œä¸ºè¿›è¡Œå®šåˆ¶ã€‚</p><p>æ¯”å¦‚å½“workerpoolä¸­çš„workeræ•°é‡å·²è¾¾ä¸Šé™ï¼Œè€Œä¸”workeréƒ½åœ¨å¤„ç†taskæ—¶ï¼Œç”¨æˆ·è°ƒç”¨Scheduleæ–¹æ³•å°†é˜»å¡ï¼Œå¦‚æœç”¨æˆ·ä¸æƒ³é˜»å¡åœ¨è¿™é‡Œï¼Œä»¥æˆ‘ä»¬ç›®å‰çš„å®ç°æ˜¯åšä¸åˆ°çš„ã€‚</p><p>é‚£æˆ‘ä»¬å¯ä»¥æ€ä¹ˆæ”¹è¿›å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥å°è¯•åœ¨ä¸Šé¢å®ç°çš„åŸºç¡€ä¸Šï¼Œä¸ºworkerpoolæ·»åŠ åŠŸèƒ½é€‰é¡¹ï¼ˆfunctional optionï¼‰æœºåˆ¶ã€‚</p><h2>æ·»åŠ åŠŸèƒ½é€‰é¡¹æœºåˆ¶</h2><p>åŠŸèƒ½é€‰é¡¹æœºåˆ¶ï¼Œå¯ä»¥è®©æŸä¸ªåŒ…çš„ç”¨æˆ·å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚ï¼Œé€šè¿‡è®¾ç½®ä¸åŒåŠŸèƒ½é€‰é¡¹æ¥å®šåˆ¶åŒ…çš„è¡Œä¸ºã€‚Goè¯­è¨€ä¸­å®ç°åŠŸèƒ½é€‰é¡¹æœºåˆ¶æœ‰å¤šç§æ–¹æ³•ï¼Œä½†Goç¤¾åŒºç›®å‰ä½¿ç”¨æœ€ä¸ºå¹¿æ³›çš„ä¸€ä¸ªæ–¹æ¡ˆï¼Œæ˜¯Goè¯­è¨€ä¹‹çˆ¶Rob Pikeåœ¨2014å¹´åœ¨åšæ–‡<a href=\"https://commandcenter.blogspot.com/2014/01/self-referential-functions-and-design.html\">ã€Šè‡ªå¼•ç”¨å‡½æ•°ä¸é€‰é¡¹è®¾è®¡ã€‹</a>ä¸­è®ºè¿°çš„ä¸€ç§ï¼Œè¿™ç§æ–¹æ¡ˆä¹Ÿè¢«åäººç§°ä¸ºâ€œåŠŸèƒ½é€‰é¡¹ï¼ˆfunctional optionï¼‰â€æ–¹æ¡ˆã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥çœ‹çœ‹å¦‚ä½•ä½¿ç”¨Rob Pikeçš„è¿™ç§â€œåŠŸèƒ½é€‰é¡¹â€æ–¹æ¡ˆï¼Œè®©workerpoolæ”¯æŒè¡Œä¸ºå®šåˆ¶æœºåˆ¶ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬å°†workerpool1ç›®å½•æ‹·è´ä¸€ä»½å½¢æˆworkerpool2ç›®å½•ï¼Œæˆ‘ä»¬å°†åœ¨è¿™ä¸ªç›®å½•ä¸‹ä¸ºworkerpoolåŒ…æ·»åŠ åŠŸèƒ½é€‰é¡¹æœºåˆ¶ã€‚</p><p>ç„¶åï¼Œæˆ‘ä»¬åœ¨workerpool2ç›®å½•ä¸‹åˆ›å»ºoption.goæ–‡ä»¶ï¼Œåœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰ç”¨äºä»£è¡¨åŠŸèƒ½é€‰é¡¹çš„ç±»å‹Optionï¼š</p><pre><code class=\"language-plain\">type Option func(*Pool)\n</code></pre><p>æˆ‘ä»¬çœ‹åˆ°ï¼Œè¿™ä¸ªOptionå®è´¨æ˜¯ä¸€ä¸ªæ¥å—*Poolç±»å‹å‚æ•°çš„å‡½æ•°ç±»å‹ã€‚é‚£ä¹ˆå¦‚ä½•è¿ç”¨è¿™ä¸ªOptionç±»å‹å‘¢ï¼Ÿåˆ«æ€¥ï¼Œé©¬ä¸Šä½ å°±ä¼šçŸ¥é“ã€‚ç°åœ¨æˆ‘ä»¬å…ˆè¦åšçš„æ˜¯ï¼Œæ˜ç¡®ç»™workerpoolæ·»åŠ ä»€ä¹ˆåŠŸèƒ½é€‰é¡¹ã€‚è¿™é‡Œæˆ‘ä»¬ä¸ºworkerpoolæ·»åŠ ä¸¤ä¸ªåŠŸèƒ½é€‰é¡¹ï¼šScheduleè°ƒç”¨æ˜¯å¦é˜»å¡ï¼Œä»¥åŠæ˜¯å¦é¢„åˆ›å»ºæ‰€æœ‰çš„workerã€‚</p><p>ä¸ºäº†æ”¯æŒè¿™ä¸¤ä¸ªåŠŸèƒ½é€‰é¡¹ï¼Œæˆ‘ä»¬éœ€è¦åœ¨Poolç±»å‹ä¸­å¢åŠ ä¸¤ä¸ªboolç±»å‹çš„å­—æ®µï¼Œå­—æ®µçš„å…·ä½“å«ä¹‰ï¼Œæˆ‘ä¹Ÿåœ¨ä»£ç ä¸­æ³¨é‡Šäº†ï¼š</p><pre><code class=\"language-plain\">type Pool struct {\n    ... ...\n    preAlloc bool // æ˜¯å¦åœ¨åˆ›å»ºpoolçš„æ—¶å€™å°±é¢„åˆ›å»ºworkersï¼Œé»˜è®¤å€¼ä¸ºï¼šfalse\n\n    // å½“poolæ»¡çš„æƒ…å†µä¸‹ï¼Œæ–°çš„Scheduleè°ƒç”¨æ˜¯å¦é˜»å¡å½“å‰goroutineã€‚é»˜è®¤å€¼ï¼štrue\n    // å¦‚æœblock = falseï¼Œåˆ™Scheduleè¿”å›ErrNoWorkerAvailInPool\n    block  bool\n    ... ...\n}\n</code></pre><p>é’ˆå¯¹è¿™ä¸¤ä¸ªå­—æ®µï¼Œæˆ‘ä»¬åœ¨option.goä¸­æ·»åŠ ä¸¤ä¸ªåŠŸèƒ½é€‰é¡¹ï¼ŒWithBlockä¸WithPreAllocWorkersï¼š</p><pre><code class=\"language-plain\">func WithBlock(block bool) Option {\n    return func(p *Pool) {\n        p.block = block\n    }\n}\n\nfunc WithPreAllocWorkers(preAlloc bool) Option {\n    return func(p *Pool) {\n        p.preAlloc = preAlloc\n    }\n}\n</code></pre><p>æˆ‘ä»¬çœ‹åˆ°ï¼Œè¿™ä¸¤ä¸ªåŠŸèƒ½é€‰é¡¹å®è´¨ä¸Šæ˜¯ä¸¤ä¸ªè¿”å›é—­åŒ…å‡½æ•°çš„å‡½æ•°ã€‚</p><p>ä¸ºäº†æ”¯æŒå°†è¿™ä¸¤ä¸ªOptionä¼ ç»™workerpoolï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ”¹é€ ä¸€ä¸‹workerpoolåŒ…çš„Newå‡½æ•°ï¼Œæ”¹é€ åçš„Newå‡½æ•°ä»£ç å¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">func New(capacity int, opts ...Option) *Pool {\n    ... ...\n    for _, opt := range opts {\n        opt(p)\n    }\n\n    fmt.Printf(\"workerpool start(preAlloc=%t)\\n\", p.preAlloc)\n\n    if p.preAlloc {\n        // create all goroutines and send into works channel\n        for i := 0; i &lt; p.capacity; i++ {\n            p.newWorker(i + 1)\n            p.active &lt;- struct{}{}\n        }\n    }\n\n    go p.run()\n\n    return p\n}\n</code></pre><p>æ–°ç‰ˆNewå‡½æ•°é™¤äº†æ¥å—capacityå‚æ•°ä¹‹å¤–ï¼Œè¿˜åœ¨å®ƒçš„å‚æ•°åˆ—è¡¨ä¸­å¢åŠ äº†ä¸€ä¸ªç±»å‹ä¸ºOptionçš„å¯å˜é•¿å‚æ•°optsã€‚åœ¨Newå‡½æ•°ä½“ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªforå¾ªç¯ï¼Œå°†ä¼ å…¥çš„Optionè¿ç”¨åˆ°Poolç±»å‹çš„å®ä¾‹ä¸Šã€‚</p><p>æ–°ç‰ˆNewå‡½æ•°è¿˜ä¼šæ ¹æ®preAllocçš„å€¼æ¥åˆ¤æ–­æ˜¯å¦é¢„åˆ›å»ºæ‰€æœ‰çš„workerï¼Œå¦‚æœéœ€è¦ï¼Œå°±è°ƒç”¨newWorkeræ–¹æ³•æŠŠæ‰€æœ‰workeréƒ½åˆ›å»ºå‡ºæ¥ã€‚newWorkerçš„å®ç°ä¸ä¸Šä¸€ç‰ˆä»£ç å¹¶æ²¡æœ‰ä»€ä¹ˆå·®å¼‚ï¼Œè¿™é‡Œå°±ä¸å†è¯¦è¯´äº†ã€‚</p><p>ä½†ç”±äºpreAllocé€‰é¡¹çš„åŠ å…¥ï¼ŒPoolçš„runæ–¹æ³•çš„å®ç°æœ‰äº†å˜åŒ–ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ï¼š</p><pre><code class=\"language-plain\"> func (p *Pool) run() {\n     idx := len(p.active)\n \n     if !p.preAlloc {\n     loop:\n         for t := range p.tasks {\n             p.returnTask(t)\n             select {\n             case &lt;-p.quit:\n                 return\n             case p.active &lt;- struct{}{}:\n                 idx++\n                 p.newWorker(idx)\n             default:\n                 break loop\n             }\n         }\n     }\n \n     for {\n         select {\n         case &lt;-p.quit:\n             return\n         case p.active &lt;- struct{}{}:\n             // create a new worker\n             idx++\n             p.newWorker(idx)\n         }\n     }\n }\n</code></pre><p>æ–°ç‰ˆrunæ–¹æ³•åœ¨preAlloc=falseæ—¶ï¼Œä¼šæ ¹æ®tasks channelçš„æƒ…å†µåœ¨é€‚åˆçš„æ—¶å€™åˆ›å»ºworkerï¼ˆç¬¬4è¡Œ~ç¬¬18è¡Œ)ï¼Œç›´åˆ°active channelå†™æ»¡ï¼Œæ‰ä¼šè¿›å…¥åˆ°å’Œç¬¬ä¸€ç‰ˆä»£ç ä¸€æ ·çš„è°ƒåº¦é€»è¾‘ä¸­ï¼ˆç¬¬20è¡Œ~ç¬¬29è¡Œï¼‰ã€‚</p><p>è€Œä¸”ï¼Œæä¾›ç»™ç”¨æˆ·çš„Scheduleå‡½æ•°ä¹Ÿå› WithBlocké€‰é¡¹ï¼Œæœ‰äº†ä¸€äº›å˜åŒ–ï¼š</p><pre><code class=\"language-plain\"> func (p *Pool) Schedule(t Task) error {\n     select {\n     case &lt;-p.quit:\n         return ErrWorkerPoolFreed\n     case p.tasks &lt;- t:\n         return nil\n     default:\n         if p.block {\n             p.tasks &lt;- t\n             return nil\n         }\n         return ErrNoIdleWorkerInPool\n     }\n }\n</code></pre><p>Scheduleåœ¨tasks chanelæ— æ³•å†™å…¥çš„æƒ…å†µä¸‹ï¼Œè¿›å…¥defaultåˆ†æ”¯ã€‚åœ¨defaultåˆ†æ”¯ä¸­ï¼ŒScheduleæ ¹æ®blockå­—æ®µçš„å€¼ï¼Œå†³å®šç©¶ç«Ÿæ˜¯ç»§ç»­é˜»å¡åœ¨tasks channelä¸Šï¼Œè¿˜æ˜¯è¿”å›ErrNoIdleWorkerInPoolé”™è¯¯ã€‚</p><p>å’Œç¬¬ä¸€ç‰ˆworkerä»£ç ä¸€æ ·ï¼Œæˆ‘ä»¬ä¹Ÿæ¥éªŒè¯ä¸€ä¸‹æ–°å¢çš„åŠŸèƒ½é€‰é¡¹æ˜¯å¦å¥½ç”¨ã€‚æˆ‘ä»¬å»ºç«‹ä¸€ä¸ªä½¿ç”¨æ–°ç‰ˆworkerpoolçš„é¡¹ç›®demo2ï¼Œdemo2çš„go.modä¸demo1çš„go.modç›¸ä¼¼ï¼š</p><pre><code class=\"language-plain\">module demo2\n\ngo 1.17\n\nrequire github.com/bigwhite/workerpool v1.0.0\n\nreplace github.com/bigwhite/workerpool v1.0.0 =&gt; ../workerpool2\n</code></pre><p>demo2çš„main.goæ–‡ä»¶å¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">package main\n  \nimport (\n    \"fmt\"\n    \"time\"\n\n    \"github.com/bigwhite/workerpool\"\n)\n\nfunc main() {\n    p := workerpool.New(5, workerpool.WithPreAllocWorkers(false), workerpool.WithBlock(false))\n\n    time.Sleep(time.Second * 2)\n    for i := 0; i &lt; 10; i++ {\n        err := p.Schedule(func() {\n            time.Sleep(time.Second * 3)\n        })\n        if err != nil {\n            fmt.Printf(\"task[%d]: error: %s\\n\", i, err.Error())\n        }\n    }\n\n    p.Free()\n}\n</code></pre><p>åœ¨demo2ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨workerpoolåŒ…æä¾›çš„åŠŸèƒ½é€‰é¡¹ï¼Œè®¾ç½®äº†æˆ‘ä»¬æœŸæœ›çš„workerpoolçš„è¿ä½œè¡Œä¸ºï¼ŒåŒ…æ‹¬ä¸è¦é¢„åˆ›å»ºworkerï¼Œä»¥åŠä¸è¦é˜»å¡Scheduleè°ƒç”¨ã€‚</p><p>è€ƒè™‘åˆ°Goroutineè°ƒåº¦çš„æ¬¡åºçš„ä¸ç¡®å®šæ€§ï¼Œè¿™é‡Œæˆ‘åœ¨åˆ›å»ºworkerpoolä¸çœŸæ­£å¼€å§‹è°ƒç”¨Scheduleæ–¹æ³•ä¹‹é—´ï¼Œåšäº†ä¸€ä¸ªSleepï¼Œå°½é‡å‡å°‘Scheduleéƒ½è¿”å›å¤±è´¥çš„é¢‘ç‡ï¼ˆä½†è¿™ä»ç„¶æ— æ³•ä¿è¯è¿™ç§æƒ…å†µä¸ä¼šå‘ç”Ÿï¼‰ã€‚</p><p>è¿è¡Œdemo2ï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°è¿™ä¸ªç»“æœï¼š</p><pre><code class=\"language-plain\">workerpool start(preAlloc=false)\ntask[1]: error: no idle worker in pool\nworker[001]: start\ntask[2]: error: no idle worker in pool\ntask[4]: error: no idle worker in pool\ntask[5]: error: no idle worker in pool\ntask[6]: error: no idle worker in pool\ntask[7]: error: no idle worker in pool\ntask[8]: error: no idle worker in pool\ntask[9]: error: no idle worker in pool\nworker[001]: receive a task\nworker[002]: start\nworker[002]: exit\nworker[001]: receive a task\nworker[001]: exit\nworkerpool freed(preAlloc=false)\n</code></pre><p>ä¸è¿‡ï¼Œç”±äºGoroutineè°ƒåº¦çš„ä¸ç¡®å®šæ€§ï¼Œè¿™ä¸ªç»“æœä»…ä»…æ˜¯å¾ˆå¤šç§ç»“æœçš„ä¸€ç§ã€‚æˆ‘ä»¬çœ‹åˆ°ï¼Œä»…ä»…001è¿™ä¸ªworkeræ”¶åˆ°äº†taskï¼Œå…¶ä½™çš„workeréƒ½å› ä¸ºworkerå°šæœªåˆ›å»ºå®Œæ¯•ï¼Œè€Œè¿”å›äº†é”™è¯¯ï¼Œè€Œä¸æ˜¯åƒdemo1é‚£æ ·é˜»å¡åœ¨Scheduleè°ƒç”¨ä¸Šã€‚</p><h2>å°ç»“</h2><p>å¥½äº†ï¼Œä»Šå¤©çš„è¯¾è®²åˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œç°åœ¨æˆ‘ä»¬ä¸€èµ·æ¥å›é¡¾ä¸€ä¸‹å§ã€‚</p><p>åœ¨è¿™ä¸€è®²ä¸­ï¼Œæˆ‘ä»¬åŸºäºæˆ‘ä»¬å‰é¢æ‰€è®²çš„Goå¹¶å‘æ–¹é¢çš„å†…å®¹ï¼Œè®¾è®¡å¹¶å®ç°äº†ä¸€ä¸ªworkerpoolçš„æœ€å°å¯è¡Œå®ç°ï¼Œåªç”¨äº†ä¸åˆ°200è¡Œä»£ç ã€‚ä¸ºäº†å¸®åŠ©ä½ ç†è§£Goå¹¶å‘åŸè¯­æ˜¯å¦‚ä½•è¿ç”¨çš„ï¼Œè¿™ä¸ªworkerpoolå®ç°å®Œå…¨åŸºäºchannel+selectï¼Œå¹¶æ²¡æœ‰ä½¿ç”¨åˆ°syncåŒ…æä¾›çš„å„ç§é”ã€‚</p><p>æˆ‘ä»¬è¿˜åŸºäºworkerpoolçš„æœ€å°å¯è¡Œå®ç°ï¼Œä¸ºè¿™ä¸ªpoolå¢åŠ äº†åŠŸèƒ½é€‰é¡¹çš„æ”¯æŒï¼Œæˆ‘ä»¬é‡‡ç”¨çš„åŠŸèƒ½é€‰é¡¹æ–¹æ¡ˆä¹Ÿæ˜¯Goç¤¾åŒºæœ€ä¸ºæµè¡Œçš„æ–¹æ¡ˆï¼Œæ—¥å¸¸ç¼–ç ä¸­å¦‚æœä½ é‡åˆ°äº†ç±»ä¼¼çš„éœ€æ±‚å¯ä»¥é‡ç‚¹å‚è€ƒã€‚</p><p>æœ€åæˆ‘è¦æé†’ä½ ï¼šä¸Šé¢è®¾è®¡ä¸å®ç°çš„workerpoolåªæ˜¯ä¸€ä¸ªæ¼”ç¤ºé¡¹ç›®ï¼Œä¸èƒ½ä½œä¸ºç”Ÿäº§é¡¹ç›®ä½¿ç”¨ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>å…³äºworkerpoolè¿™æ ·çš„é¡¹ç›®ï¼Œå¦‚æœè®©ä½ æ¥è®¾è®¡ï¼Œä½ çš„è®¾è®¡æ€è·¯æ˜¯ä»€ä¹ˆï¼Œä¸å¦¨åœ¨ç•™è¨€åŒºæ•å¼€è°ˆè°ˆï¼Ÿ</p><p>æ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™æ›´å¤šæ„Ÿå…´è¶£çš„æœ‹å‹ã€‚æˆ‘æ˜¯Tony Baiï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ã€‚</p><h3><a href=\"https://github.com/bigwhite/publication/tree/master/column/timegeek/go-first-course/35\">ä»Šå¤©çš„é¡¹ç›®æºç åœ¨è¿™é‡Œï¼</a></h3>","comments":[{"had_liked":false,"id":338386,"user_name":"ivhong","can_delete":false,"product_type":"c1","uid":2659871,"ip_address":"","ucode":"9947B228807AC9","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJ8ic8eLTo5rnqIMJicUfpkVBrOUJAW4fANicKIbHdC54O9SOdwSoeK6o8icibaUbh7ZUXAkGF9zwHqo0Q/132","comment_is_top":false,"comment_ctime":1647479909,"is_pvip":false,"replies":[{"id":123699,"content":"å¥½é—®é¢˜ã€‚\n\n1. ä¼ ç»Ÿç†è§£çš„coroutineä¸€èˆ¬æ˜¯é¢å‘åä½œå¼ï¼Œè€ŒéæŠ¢å å¼ã€‚åƒpythonä¸­é€šè¿‡yieldå…³é”®å­—åˆ›å»ºçš„åç¨‹ï¼Œä¸ä¸»routineä¹‹é—´æ˜¯åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸Šå®ç°çš„åˆ‡æ¢æ‰§è¡Œï¼Œä»è®¾è®¡è§’åº¦æ˜¯é€šè¿‡coroutineå®ç°äº†å¹¶å‘(concurrency)ï¼Œä½†å…¶å®å®ƒä»¬è¿˜æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼Œä¸ä¼šçœŸæ­£å¹¶è¡Œ(paralellism)ï¼Œå³ä¾¿åœ¨å¤šæ ¸å¤„ç†å™¨ä¸Šã€‚\n                                                                                             \nåŸºäºä¸Šé¢çš„ç†è§£ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ„è¯†åˆ°goroutineå¹¶éä¼ ç»Ÿæ„ä¹‰ä¸Šçš„coroutineï¼Œæ˜¯æ”¯æŒæŠ¢å çš„ï¼Œè€Œä¸”ä¹Ÿå¿…é¡»ä¾èµ–æŠ¢å å®ç°runtimeå¯¹goroutineçš„è°ƒåº¦ã€‚å®ƒæ›´åƒthreadï¼Œå¯ä»¥ç»‘å®šä¸åŒçš„cpuæ ¸å¹¶è¡Œæ‰§è¡Œï¼ˆå¦‚æœæ˜¯åœ¨å¤šæ ¸å¤„ç†å™¨ä¸Šçš„è¯ï¼‰ã€‚åŒæ—¶åŸºäºgoroutineçš„è®¾è®¡ä¹Ÿä¼šä¸€ç§å¹¶å‘çš„è®¾è®¡ã€‚\n\nè€Œgoroutineä¸threadåˆä¸åŒï¼Œgoroutineæ˜¯åœ¨ç”¨æˆ·å±‚(ç›¸è¾ƒäºosçš„å†…æ ¸å±‚ï¼‰è°ƒåº¦çš„ï¼Œoså¹¶ä¸çŸ¥é“å…¶å­˜åœ¨ï¼Œgoroutineçš„åˆ‡æ¢ç›¸å¯¹è½»é‡ã€‚è€Œthreadæ˜¯os\næ¥è°ƒåº¦çš„ï¼Œåˆ‡æ¢ä»£ä»·æ›´é«˜ä¸€äº›ã€‚\n\næ‰€ä»¥æ–‡ä¸­å°†goroutineç§°ä¸ºâ€œè½»é‡çº§çº¿ç¨‹â€ï¼Œè€Œä¸æ˜¯åç¨‹ã€‚\n\n2. ä½ ç†è§£çš„æ²¡é”™ã€‚è¿™èŠ‚è¯¾æ˜¯ä¸ºäº†æ¼”ç¤ºgoroutineã€channelä¹‹é—´çš„è°ƒåº¦ä¸é€šä¿¡æœºåˆ¶è€Œâ€œè®¾è®¡â€å‡ºæ¥çš„ã€‚goroutineä½¿ç”¨ä»£ä»·å¾ˆä½ï¼Œé€šå¸¸ä¸ç”¨è€ƒè™‘æ± åŒ–ã€‚ä½†æ˜¯åœ¨ä¸€äº›å¤§å‹ç½‘ç»œæœåŠ¡ç¨‹åºæ—¶ï¼Œä¸€æ—¦goroutineæ•°é‡è¿‡å¤šï¼Œå†…å­˜å ç”¨ä»¥åŠè°ƒåº¦goroutineçš„ä»£ä»·å°±ä¸èƒ½ä¸è€ƒè™‘äº†ã€‚äºæ˜¯æœ‰äº†â€œæ± åŒ–â€çš„æ€è·¯ã€‚è¿™ä¸ä¼ ç»Ÿçš„çº¿ç¨‹æ± çš„æ€è·¯çš„ç¡®æ˜¯ä¸€è„‰ç›¸æ‰¿çš„\n\n3. goæ˜¯gcçš„ï¼Œå†…å­˜ä¸ä¼šè¶Šæ¥è¶Šå¤§ã€‚\n","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1647495219,"ip_address":"","comment_id":338386,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100093501,"comment_content":"éå¸¸æ„Ÿè°¢è€å¸ˆå¸¦ç€åšäº†ä¸€æ¬¡è¿™æ ·çš„å®ç°ï¼Œå› ä¸ºæˆ‘è‡ªå·±ä¹Ÿå°è¯•è¿‡è¿™ç§å®ç°ï¼ˆçº¯ç²¹æ˜¯ä¸ºäº†å­¦ä¹ ç”¨ï¼‰ã€‚æœ‰å‡ ä¸ªé—®é¢˜æˆ‘ä¸æ˜¯ç‰¹åˆ«æ˜ç™½ï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯å’Œè€å¸ˆç†è§£çš„ä¸€æ ·ï¼Œæœ›è€å¸ˆé—²æš‡ä¹‹ä½™ç»™äºˆæŒ‡æ­£ï¼Œè°¢è°¢ï¼\n1. è¿™ä¸ªæ˜¯ä¸æ˜¯å«â€œåç¨‹æ± â€ï¼Œä¸ºä»€ä¹ˆå«åšâ€œçº¿ç¨‹æ± â€ï¼Ÿä¸¤è€…æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿæˆ–è€…æ˜¯åˆ°åº•ä»€ä¹ˆæ˜¯â€œåç¨‹â€å‘¢ï¼Ÿ\n2. æ˜¯ä¸æ˜¯è¿™èŠ‚è¯¾çš„å®ç°ï¼Œä¹Ÿçº¯ç²¹æ˜¯ä¸ºäº†å­¦ä¹ è€Œå®ç°çš„ï¼Œä¸ªäººç†è§£ï¼Œgoå®ç°Goroutineï¼Œå°±æ˜¯ä¸ºäº†è§£å†³â€œçº¿ç¨‹æ± â€çš„ç¹çï¼Œè®©â€œå¹¶å‘â€å®ç°çš„ä¸ç”¨é‚£ä¹ˆçš„éº»çƒ¦ï¼Œå¦‚æœæ˜¯è¶…å°â€œä»»åŠ¡â€ï¼Œä¸ç”¨è€ƒè™‘çº¿ç¨‹é¢‘ç¹åˆ‡æ¢å¯¼è‡´ç³»ç»Ÿèµ„æºçš„æµªè´¹ã€‚å¦‚æœå†å®ç°â€œåç¨‹æ± â€çš„è¯ï¼Œæ˜¯ä¸æ˜¯ä¸¢å¤±äº†è¿™ç§ä¼˜ç‚¹ï¼Ÿ\n3. å¸¸é©»å†…å­˜çš„Goroutineï¼Œåå¤ä½¿ç”¨ï¼Œä¼šå¯¼è‡´è¿™ä¸ªGoroutineçš„å†…å­˜è¶Šæ¥è¶Šå¤§ï¼Œæˆ–è€…å…¶ä»–éšè—çš„é£é™©ä¹ˆï¼Ÿ","like_count":14},{"had_liked":false,"id":331114,"user_name":"$ä¾¯","can_delete":false,"product_type":"c1","uid":1019939,"ip_address":"","ucode":"488B1BD3924E7E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/90/23/5c74e9b7.jpg","comment_is_top":false,"comment_ctime":1642430185,"is_pvip":false,"replies":[{"id":120983,"content":"åŸæ–‡ä¸­æœ‰æºç çš„é“¾æ¥ï¼Œåœ¨æœ€åã€‚\n\næºç åœ¨ https:&#47;&#47;github.com&#47;bigwhite&#47;publication&#47;tree&#47;master&#47;column&#47;timegeek&#47;go-first-course&#47;35\n\nçœ‹äº†åï¼Œå°±å¯ä»¥å›ç­”ä½ çš„é—®é¢˜äº†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ä½œè€…","uid":1026224,"ctime":1642475072,"ip_address":"","comment_id":331114,"utype":1}],"discussion_count":7,"race_medal":0,"score":2,"product_id":100093501,"comment_content":"è€å¸ˆæ‚¨å¥½è¯·æ•™å‡ ä¸ªé—®é¢˜ï¼š\nç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œdemo1ä¸­æ²¡æœ‰çœ‹åˆ°p.Freeçš„ä»£ç ç¤ºä¾‹ï¼ŒFreeæ–¹æ³•åªæ˜¯å‘p.quit &lt;- struct{}{}å‘é€ä¸€ä¸ªç©ºç»“æ„ä½“å°±å¯ä»¥å—ï¼Œè¯·æ•™ä¸‹Freeæ–¹å¼è¯¥å¦‚ä½•å†™\nç¬¬äºŒä¸ªé—®é¢˜ï¼Œdemo1ä¸­å¥½åƒä¹Ÿæ²¡çœ‹çœ‹åˆ°p.wg.Wait()","like_count":3,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":556741,"discussion_content":"å¥½é—®é¢˜ã€‚\n\n1. ä¼ ç»Ÿç†è§£çš„coroutineä¸€èˆ¬æ˜¯é¢å‘åä½œå¼ï¼Œè€ŒéæŠ¢å å¼ã€‚åƒpythonä¸­é€šè¿‡yieldå…³é”®å­—åˆ›å»ºçš„åç¨‹ï¼Œä¸ä¸»routineä¹‹é—´æ˜¯åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸Šå®ç°çš„åˆ‡æ¢æ‰§è¡Œï¼Œä»è®¾è®¡è§’åº¦æ˜¯é€šè¿‡coroutineå®ç°äº†å¹¶å‘(concurrency)ï¼Œä½†å…¶å®å®ƒä»¬è¿˜æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼Œä¸ä¼šçœŸæ­£å¹¶è¡Œ(paralellism)ï¼Œå³ä¾¿åœ¨å¤šæ ¸å¤„ç†å™¨ä¸Šã€‚\n                                                                                             \nåŸºäºä¸Šé¢çš„ç†è§£ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ„è¯†åˆ°goroutineå¹¶éä¼ ç»Ÿæ„ä¹‰ä¸Šçš„coroutineï¼Œæ˜¯æ”¯æŒæŠ¢å çš„ï¼Œè€Œä¸”ä¹Ÿå¿…é¡»ä¾èµ–æŠ¢å å®ç°runtimeå¯¹goroutineçš„è°ƒåº¦ã€‚å®ƒæ›´åƒthreadï¼Œå¯ä»¥ç»‘å®šä¸åŒçš„cpuæ ¸å¹¶è¡Œæ‰§è¡Œï¼ˆå¦‚æœæ˜¯åœ¨å¤šæ ¸å¤„ç†å™¨ä¸Šçš„è¯ï¼‰ã€‚åŒæ—¶åŸºäºgoroutineçš„è®¾è®¡ä¹Ÿä¼šä¸€ç§å¹¶å‘çš„è®¾è®¡ã€‚\n\nè€Œgoroutineä¸threadåˆä¸åŒï¼Œgoroutineæ˜¯åœ¨ç”¨æˆ·å±‚(ç›¸è¾ƒäºosçš„å†…æ ¸å±‚ï¼‰è°ƒåº¦çš„ï¼Œoså¹¶ä¸çŸ¥é“å…¶å­˜åœ¨ï¼Œgoroutineçš„åˆ‡æ¢ç›¸å¯¹è½»é‡ã€‚è€Œthreadæ˜¯os\næ¥è°ƒåº¦çš„ï¼Œåˆ‡æ¢ä»£ä»·æ›´é«˜ä¸€äº›ã€‚\n\næ‰€ä»¥æ–‡ä¸­å°†goroutineç§°ä¸ºâ€œè½»é‡çº§çº¿ç¨‹â€ï¼Œè€Œä¸æ˜¯åç¨‹ã€‚\n\n2. ä½ ç†è§£çš„æ²¡é”™ã€‚è¿™èŠ‚è¯¾æ˜¯ä¸ºäº†æ¼”ç¤ºgoroutineã€channelä¹‹é—´çš„è°ƒåº¦ä¸é€šä¿¡æœºåˆ¶è€Œâ€œè®¾è®¡â€å‡ºæ¥çš„ã€‚goroutineä½¿ç”¨ä»£ä»·å¾ˆä½ï¼Œé€šå¸¸ä¸ç”¨è€ƒè™‘æ± åŒ–ã€‚ä½†æ˜¯åœ¨ä¸€äº›å¤§å‹ç½‘ç»œæœåŠ¡ç¨‹åºæ—¶ï¼Œä¸€æ—¦goroutineæ•°é‡è¿‡å¤šï¼Œå†…å­˜å ç”¨ä»¥åŠè°ƒåº¦goroutineçš„ä»£ä»·å°±ä¸èƒ½ä¸è€ƒè™‘äº†ã€‚äºæ˜¯æœ‰äº†â€œæ± åŒ–â€çš„æ€è·¯ã€‚è¿™ä¸ä¼ ç»Ÿçš„çº¿ç¨‹æ± çš„æ€è·¯çš„ç¡®æ˜¯ä¸€è„‰ç›¸æ‰¿çš„\n\n3. goæ˜¯gcçš„ï¼Œå†…å­˜ä¸ä¼šè¶Šæ¥è¶Šå¤§ã€‚\n","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1647495219,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":331112,"user_name":"Darren","can_delete":false,"product_type":"c1","uid":1254968,"ip_address":"","ucode":"CCD2B2C492BE9A","user_header":"https://static001.geekbang.org/account/avatar/00/13/26/38/ef063dc2.jpg","comment_is_top":false,"comment_ctime":1642429951,"is_pvip":false,"replies":[{"id":121004,"content":"çœ‹çš„çœŸç»†è‡´ï¼ğŸ‘\n\n1. workerä¸€æ—¦åˆ›å»ºåï¼Œé™¤äº†panicå’Œquité€šçŸ¥é€€å‡ºï¼Œworkeræ˜¯ä¸ä¼šé€€å‡ºçš„ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰æ‰€è°“â€œæ­£å¸¸é€€å‡ºâ€çš„æƒ…å†µã€‚æ‰€ä»¥æ²¡åœ¨deferä¸­è°ƒç”¨&lt;-p.activeã€‚\n2. çš„ç¡®æ˜¯ç¬”è¯¯,æ„Ÿè°¢æŒ‡å‡ºã€‚\n3. åœ¨æ–‡åæœ‰æºç é“¾æ¥ã€‚è¿™é‡Œçš„taskä»…æ˜¯è§¦å‘äº†workeråˆ›å»ºï¼Œè¿™é‡Œæ˜¯è°ƒåº¦å¾ªç¯ï¼Œä¸å¤„ç†taskï¼Œæ‰€ä»¥è¦æŠŠtaskæ‰”å›tasks channelï¼Œç­‰workerå¯åŠ¨åå†å¤„ç†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1642488429,"ip_address":"","comment_id":331112,"utype":1}],"discussion_count":12,"race_medal":0,"score":2,"product_id":100093501,"comment_content":"è€å¸ˆä»¥ä¸‹å‡ ä¸ªé—®é¢˜å“ˆï¼š\n1ã€ç¬¬ä¸€ç§å®ç°ä¸­ï¼Œè¿™å—æ˜¯ä¸æ˜¯æœ‰ç‚¹é—®é¢˜ï¼š\n\ngo func() {\n    defer func() {\n        if err := recover(); err != nil {\n            fmt.Printf(&quot;worker[%03d]: recover panic[%s] and exit\\n&quot;, i, err)\n            &lt;-p.active\n        }\n        p.wg.Done()\n    }()\n\n  &lt;-p.activeæ˜¯ä¸æ˜¯åº”è¯¥è¦æ”¾åˆ°ifçš„å¤–é¢ï¼Œå¦‚æœtaskæ‰§è¡Œæœ¬èº«æ²¡æœ‰å‡ºé”™ï¼Œæ­£å¸¸ç»“æŸäº†ï¼Œactiveæ²¡æœ‰å‡å°‘çš„åœ°æ–¹\n\n2ã€è¿™å—æ–‡å­—æè¿°æœ‰ç‚¹é—®é¢˜ï¼Œp&lt;-activeåº”è¯¥æ˜¯&lt;-p.active\nâ€œä½¿ç”¨äº† defer+recover å¯¹ panic è¿›è¡Œæ•æ‰ï¼Œæ•æ‰å worker ä¹Ÿæ˜¯è¦é€€å‡ºçš„ï¼Œäºæ˜¯æˆ‘ä»¬è¿˜é€šè¿‡p&lt;-activeæ›´æ–°äº† worker è®¡æ•°å™¨â€\n\n3ã€ç¬¬äºŒç§å®ç°ä¸­ï¼Œå½“æ²¡æœ‰æå‰åˆ›å»ºworkerï¼Œé‚£ä¹ˆå½“tasksä¸­æœ‰ä»»åŠ¡çš„æ—¶å€™ï¼Œp.returnTaskæ–¹æ³•æ˜¯å¹²å•¥çš„ï¼Ÿæ–‡ç« ä¸­æ²¡æœ‰è¿™ä¸ªæ–¹æ³•ï¼Œä¸”æ–‡å­—ä¹Ÿæ²¡æœ‰è¯´æ˜å‘€\n\n func (p *Pool) run() {\n     idx := len(p.active)\n \n     if !p.preAlloc {\n     loop:\n         for t := range p.tasks {\n             p.returnTask(t)\n             select {\n             case &lt;-p.quit:\n                 return\n             case p.active &lt;- struct{}{}:\n                 idx++\n                 p.newWorker(idx)\n             default:\n                 break loop\n             }\n         }\n     }\n ","like_count":3,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546988,"discussion_content":"çœ‹çš„çœŸç»†è‡´ï¼ğŸ‘\n\n1. workerä¸€æ—¦åˆ›å»ºåï¼Œé™¤äº†panicå’Œquité€šçŸ¥é€€å‡ºï¼Œworkeræ˜¯ä¸ä¼šé€€å‡ºçš„ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰æ‰€è°“â€œæ­£å¸¸é€€å‡ºâ€çš„æƒ…å†µã€‚æ‰€ä»¥æ²¡åœ¨deferä¸­è°ƒç”¨&lt;-p.activeã€‚\n2. çš„ç¡®æ˜¯ç¬”è¯¯,æ„Ÿè°¢æŒ‡å‡ºã€‚\n3. åœ¨æ–‡åæœ‰æºç é“¾æ¥ã€‚è¿™é‡Œçš„taskä»…æ˜¯è§¦å‘äº†workeråˆ›å»ºï¼Œè¿™é‡Œæ˜¯è°ƒåº¦å¾ªç¯ï¼Œä¸å¤„ç†taskï¼Œæ‰€ä»¥è¦æŠŠtaskæ‰”å›tasks channelï¼Œç­‰workerå¯åŠ¨åå†å¤„ç†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642488429,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":3,"child_discussions":[{"author":{"id":1254968,"avatar":"https://static001.geekbang.org/account/avatar/00/13/26/38/ef063dc2.jpg","nickname":"Darren","note":"","ucode":"CCD2B2C492BE9A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":547022,"discussion_content":"è°¢è°¢è€å¸ˆï¼Œæˆ‘åœ¨çœ‹ä¸‹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642498665,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":546988,"ip_address":"","group_id":0},"score":547022,"extra":""},{"author":{"id":2285931,"avatar":"https://static001.geekbang.org/account/avatar/00/22/e1/6b/74a8b7d8.jpg","nickname":"Hugh","note":"","ucode":"77434E01E1D715","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":566228,"discussion_content":"&gt; è¿™é‡Œçš„taskä»…æ˜¯è§¦å‘äº†workeråˆ›å»ºï¼Œè¿™é‡Œæ˜¯è°ƒåº¦å¾ªç¯ï¼Œä¸å¤„ç†taskï¼Œæ‰€ä»¥è¦æŠŠtaskæ‰”å›tasks channelï¼Œç­‰workerå¯åŠ¨åå†å¤„ç†ã€‚\n\nå…³äºè¿™ä¸€ç‚¹æƒ³é—®ä¸€ä¸‹ï¼Œå¦‚æœæŠŠtaské‡æ–°æ‰”å›channelï¼Œæ˜¯ä¸æ˜¯æ‰“ä¹±äº†taskçš„æ‰§è¡Œé¡ºåºã€‚è€Œä¸”newWorkerå’Œrunæ–¹æ³•é‡Œéƒ½ä¼šä»task channelç›‘å¬taskï¼Œåˆ™æ„å‘³ç€æœ‰çš„taskç›´æ¥ä¼šè¢«æ‰§è¡Œï¼Œæœ‰çš„å›åˆ°äº†é˜Ÿå°¾ã€‚è€Œä¸”æç«¯æƒ…å†µä¸‹å¯èƒ½ä¼šåå¤è¢«æ”¾å›é˜Ÿå°¾ï¼Œä»è€Œå¯¼è‡´æ°¸è¿œè½®ä¸åˆ°è¢«æ‰§è¡Œã€‚è€Œä¸”è¿™ç§ç°è±¡å­˜åœ¨workpollçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1650633652,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":546988,"ip_address":"","group_id":0},"score":566228,"extra":""},{"author":{"id":1932430,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/7c/8e/830017ff.jpg","nickname":"é¦™æ¦­çš„æ«å¶ğŸ‚","note":"","ucode":"6EB2522892A0DC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2285931,"avatar":"https://static001.geekbang.org/account/avatar/00/22/e1/6b/74a8b7d8.jpg","nickname":"Hugh","note":"","ucode":"77434E01E1D715","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":591339,"discussion_content":"taskæ˜¯æ— ç¼“å†²çš„channelï¼Œæ²¡æœ‰æ’é˜Ÿçš„é—®é¢˜å§","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1666520426,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":566228,"ip_address":"åŒ—äº¬","group_id":0},"score":591339,"extra":""}]},{"author":{"id":1019939,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/23/5c74e9b7.jpg","nickname":"$ä¾¯","note":"","ucode":"488B1BD3924E7E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546959,"discussion_content":"ç¬¬ä¸€ä¸ªé—®é¢˜ä¸­ï¼Œé™¤étaskæœ‰é—®é¢˜recoveräº†å¦åˆ™æ˜¯ä¸éœ€è¦å‡å°‘çš„ï¼Œè¿™5ä¸ªactiveåœ¨quitå’Œç¨‹åºç»“æŸå‰æ˜¯ä¸€ç›´åœ¨çš„","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1642479140,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1254968,"avatar":"https://static001.geekbang.org/account/avatar/00/13/26/38/ef063dc2.jpg","nickname":"Darren","note":"","ucode":"CCD2B2C492BE9A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1019939,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/23/5c74e9b7.jpg","nickname":"$ä¾¯","note":"","ucode":"488B1BD3924E7E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":547024,"discussion_content":"è°¢è°¢å¤§ä½¬","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642498682,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":546959,"ip_address":"","group_id":0},"score":547024,"extra":""}]},{"author":{"id":1214303,"avatar":"https://static001.geekbang.org/account/avatar/00/12/87/5f/6bf8b74a.jpg","nickname":"Kepler","note":"","ucode":"0C9CA3DB8B3CF0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":559889,"discussion_content":"æ„Ÿè§‰ç¬¬äºŒç‰ˆçš„!preAlloc + !blockå®ç°ï¼Œå¤§ç™½è€å¸ˆæ˜¯ä¸ºäº†ç»™æˆ‘ä»¬å±•ç¤ºè¿™ç§ç”¨æ³•ï¼Œå®æˆ˜åº”è¯¥é‡‡ç”¨preAlloc + !blockçš„ç»„åˆï¼Œè€Œä¸”taskChané‡‡ç”¨ç¼“å†²æ–¹å¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649043619,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1603004,"avatar":"https://static001.geekbang.org/account/avatar/00/18/75/bc/89d88775.jpg","nickname":"Calvin","note":"","ucode":"0EEF5B207623B5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546968,"discussion_content":"æˆ‘è‡ªå·±ç†äº†ä¸‹ï¼Œè¯•ç€å¸®è€å¸ˆå›ç­”ä¸‹è¿™äº›é—®é¢˜ï¼Œå¸Œæœ›æœ‰é”™å¸®å¿™æŒ‡æ­£ï¼\n1ã€&lt;-p.active ä¸æ”¾åœ¨ if å¤–é¢ï¼Œå› ä¸ºåªæœ‰å‘ç”Ÿpanicæ—¶æ‰éœ€è¦æŠŠ p.active è®¡æ•°å‡ä¸€ï¼ˆæ­¤æ—¶runåˆä¼šé‡æ–°newä¸€ä¸ªæ–°çš„workerï¼Œä¿æŒâ€œæ± â€ä¸­æ´»è·ƒ goroutine æ•°æ’å®šï¼‰ï¼›\n2ã€ä½ è¯´çš„å¯¹ï¼›\n3ã€returnTaskæ–¹æ³•ï¼Œä¸å®ƒçš„åå­—å­—é¢å«ä¹‰ä¸€æ ·ï¼Œä½œç”¨æ˜¯â€œå½’è¿˜â€taskç»™p.tasksé€šé“ï¼Œå› ä¸ºfor-rangeå¤„è¯»å–tasksçš„æœ¬æ„åªæ˜¯ä¸ºäº†æœ‰å¤šå°‘ä¸ªtaskå°±åˆ›å»ºå¤šå°‘ä¸ªgoroutineçš„workerï¼ˆç›´åˆ°æ•°é‡è¾¾åˆ°capacityï¼Œå†break loopé€€å‡ºå¾ªç¯æ‰§è¡Œä¸‹é¢çš„é€»è¾‘ï¼‰ï¼Œæ­¤å¤„å¹¶ä¸çœŸæ­£æ‰§è¡Œä»»åŠ¡ï¼Œæ‰€ä»¥å°†å®ƒå½’è¿˜å›å»ï¼Œä»¥ä¾¿å¦ä¸€å¤„çœŸæ­£æ‰§è¡Œä»»åŠ¡çš„åœ°æ–¹èƒ½æ¥æ”¶åˆ°ä»»åŠ¡ï¼ˆt := &lt;-p.tasksï¼‰ã€‚å®Œæ•´æºç åœ¨githubæœ‰ï¼šæ–‡ç« æœ€åæœ‰é“¾æ¥ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642483301,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":4,"child_discussions":[{"author":{"id":1254968,"avatar":"https://static001.geekbang.org/account/avatar/00/13/26/38/ef063dc2.jpg","nickname":"Darren","note":"","ucode":"CCD2B2C492BE9A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1603004,"avatar":"https://static001.geekbang.org/account/avatar/00/18/75/bc/89d88775.jpg","nickname":"Calvin","note":"","ucode":"0EEF5B207623B5","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":547023,"discussion_content":"è°¢è°¢å¤§ä½¬æŒ‡ç‚¹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642498676,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":546968,"ip_address":"","group_id":0},"score":547023,"extra":""},{"author":{"id":1184102,"avatar":"https://static001.geekbang.org/account/avatar/00/12/11/66/ac631a36.jpg","nickname":"Geralt","note":"","ucode":"2F31ED777D06A0","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1603004,"avatar":"https://static001.geekbang.org/account/avatar/00/18/75/bc/89d88775.jpg","nickname":"Calvin","note":"","ucode":"0EEF5B207623B5","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":547035,"discussion_content":"è°ƒç”¨returnTaskå½’è¿˜çš„taskè¿˜æ˜¯æœ‰å¯èƒ½è¢«for rangeè·å–åˆ°çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642500842,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":546968,"ip_address":"","group_id":0},"score":547035,"extra":""},{"author":{"id":1603004,"avatar":"https://static001.geekbang.org/account/avatar/00/18/75/bc/89d88775.jpg","nickname":"Calvin","note":"","ucode":"0EEF5B207623B5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1184102,"avatar":"https://static001.geekbang.org/account/avatar/00/12/11/66/ac631a36.jpg","nickname":"Geralt","note":"","ucode":"2F31ED777D06A0","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":547054,"discussion_content":"æ˜¯çš„ï¼Œæ‰€ä»¥æˆ‘è§‰å¾—è¿™é‡Œå¯ä»¥ä¼˜åŒ–ä¸‹ã€‚å¦å¤–ææˆè·Ÿjavaçš„é‚£æ ·ï¼Œå¸¦ä»»åŠ¡å¯åŠ¨æ–°workerï¼Œç›´åˆ°è¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1642510138,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":547035,"ip_address":"","group_id":0},"score":547054,"extra":""}]}]},{"had_liked":false,"id":372125,"user_name":"Geek_0d5d37","can_delete":false,"product_type":"c1","uid":3522132,"ip_address":"å››å·","ucode":"1BB4AEF1328C64","user_header":"","comment_is_top":false,"comment_ctime":1680764743,"is_pvip":false,"replies":[{"id":135834,"content":"å½“preAlloc=falseæ—¶ï¼Œå³ä¸é¢„åˆ†é…æ—¶ã€‚è¿™æ ·å°±æ ¹æ®tasksçš„æƒ…å†µæ¥åˆ›å»ºworkerã€‚å¦‚æœå½“å‰æ²¡æœ‰taskï¼Œå®é™…ä¸Šç³»ç»Ÿä¸­æ²¡æœ‰workerè¢«åˆ›å»ºå‡ºæ¥ï¼Œç›´åˆ°æœ‰taskæ‰ä¼šåˆ›å»ºworkerã€‚ä¸€ç›´åˆ°active channelæ»¡äº†ï¼è¿™æ ·poolä¸­æ‰€æœ‰workeréƒ½åˆ›å»ºå‡ºæ¥åï¼Œå†è·³å‡ºå¾ªç¯ï¼Œè¿›å…¥ä¸‹é¢çš„quitç›‘å¬ã€‚\n\nä¸è¿‡workpool2çš„è¿™æ®µä»£ç çš„ç¡®æœ‰refactorçš„ç©ºé—´ğŸ˜ã€‚å¯ä»¥å†™çš„æ›´å¥½ç†è§£ä¸€äº›ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1680843383,"ip_address":"åŒ—äº¬","comment_id":372125,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100093501,"comment_content":"è€å¸ˆæ‚¨å¥½ï¼Œè¿™ä¸ªæ®µä»£ç ä½œç”¨æˆ‘ä¹Ÿä¸å¤ªç†è§£\nif !p.preAlloc {\n\tloop:\n\t\tfor t := range p.tasks {\n\t\t\tp.returnTask(t)\n\t\t\tselect {\n\t\t\tcase &lt;-p.quit:\n\t\t\t\treturn\n\t\t\tcase p.active &lt;- struct{}{}:\n\t\t\t\tidx++\n\t\t\t\tp.newWorker(idx)\n\t\t\tdefault:\n\t\t\t\tbreak loop\n\t\t\t}\n\t\t}\n\t}\n\næ‚¨åœ¨ç•™è¨€ä¸­å›ç­” å½“preAlloc=falseæ—¶æœ‰ç”¨ ï¼Œå¦‚æœæ˜¯è¿™æ ·demo1 å°±æ˜¯ç­‰äºfasleçš„æƒ…å†µæ²¡ä½¿ç”¨è¿™æ®µä»£ç çš„ ï¼Œè¯·è€å¸ˆæœ‰ç©ºå›ç­”ä¸€ä¸‹","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546988,"discussion_content":"çœ‹çš„çœŸç»†è‡´ï¼ğŸ‘\n\n1. workerä¸€æ—¦åˆ›å»ºåï¼Œé™¤äº†panicå’Œquité€šçŸ¥é€€å‡ºï¼Œworkeræ˜¯ä¸ä¼šé€€å‡ºçš„ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰æ‰€è°“â€œæ­£å¸¸é€€å‡ºâ€çš„æƒ…å†µã€‚æ‰€ä»¥æ²¡åœ¨deferä¸­è°ƒç”¨&lt;-p.activeã€‚\n2. çš„ç¡®æ˜¯ç¬”è¯¯,æ„Ÿè°¢æŒ‡å‡ºã€‚\n3. åœ¨æ–‡åæœ‰æºç é“¾æ¥ã€‚è¿™é‡Œçš„taskä»…æ˜¯è§¦å‘äº†workeråˆ›å»ºï¼Œè¿™é‡Œæ˜¯è°ƒåº¦å¾ªç¯ï¼Œä¸å¤„ç†taskï¼Œæ‰€ä»¥è¦æŠŠtaskæ‰”å›tasks channelï¼Œç­‰workerå¯åŠ¨åå†å¤„ç†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642488429,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":3,"child_discussions":[{"author":{"id":1254968,"avatar":"https://static001.geekbang.org/account/avatar/00/13/26/38/ef063dc2.jpg","nickname":"Darren","note":"","ucode":"CCD2B2C492BE9A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":547022,"discussion_content":"è°¢è°¢è€å¸ˆï¼Œæˆ‘åœ¨çœ‹ä¸‹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642498665,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":546988,"ip_address":"","group_id":0},"score":547022,"extra":""},{"author":{"id":2285931,"avatar":"https://static001.geekbang.org/account/avatar/00/22/e1/6b/74a8b7d8.jpg","nickname":"Hugh","note":"","ucode":"77434E01E1D715","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":566228,"discussion_content":"&gt; è¿™é‡Œçš„taskä»…æ˜¯è§¦å‘äº†workeråˆ›å»ºï¼Œè¿™é‡Œæ˜¯è°ƒåº¦å¾ªç¯ï¼Œä¸å¤„ç†taskï¼Œæ‰€ä»¥è¦æŠŠtaskæ‰”å›tasks channelï¼Œç­‰workerå¯åŠ¨åå†å¤„ç†ã€‚\n\nå…³äºè¿™ä¸€ç‚¹æƒ³é—®ä¸€ä¸‹ï¼Œå¦‚æœæŠŠtaské‡æ–°æ‰”å›channelï¼Œæ˜¯ä¸æ˜¯æ‰“ä¹±äº†taskçš„æ‰§è¡Œé¡ºåºã€‚è€Œä¸”newWorkerå’Œrunæ–¹æ³•é‡Œéƒ½ä¼šä»task channelç›‘å¬taskï¼Œåˆ™æ„å‘³ç€æœ‰çš„taskç›´æ¥ä¼šè¢«æ‰§è¡Œï¼Œæœ‰çš„å›åˆ°äº†é˜Ÿå°¾ã€‚è€Œä¸”æç«¯æƒ…å†µä¸‹å¯èƒ½ä¼šåå¤è¢«æ”¾å›é˜Ÿå°¾ï¼Œä»è€Œå¯¼è‡´æ°¸è¿œè½®ä¸åˆ°è¢«æ‰§è¡Œã€‚è€Œä¸”è¿™ç§ç°è±¡å­˜åœ¨workpollçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1650633652,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":546988,"ip_address":"","group_id":0},"score":566228,"extra":""},{"author":{"id":1932430,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/7c/8e/830017ff.jpg","nickname":"é¦™æ¦­çš„æ«å¶ğŸ‚","note":"","ucode":"6EB2522892A0DC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2285931,"avatar":"https://static001.geekbang.org/account/avatar/00/22/e1/6b/74a8b7d8.jpg","nickname":"Hugh","note":"","ucode":"77434E01E1D715","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":591339,"discussion_content":"taskæ˜¯æ— ç¼“å†²çš„channelï¼Œæ²¡æœ‰æ’é˜Ÿçš„é—®é¢˜å§","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1666520426,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":566228,"ip_address":"åŒ—äº¬","group_id":0},"score":591339,"extra":""}]},{"author":{"id":1019939,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/23/5c74e9b7.jpg","nickname":"$ä¾¯","note":"","ucode":"488B1BD3924E7E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546959,"discussion_content":"ç¬¬ä¸€ä¸ªé—®é¢˜ä¸­ï¼Œé™¤étaskæœ‰é—®é¢˜recoveräº†å¦åˆ™æ˜¯ä¸éœ€è¦å‡å°‘çš„ï¼Œè¿™5ä¸ªactiveåœ¨quitå’Œç¨‹åºç»“æŸå‰æ˜¯ä¸€ç›´åœ¨çš„","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1642479140,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1254968,"avatar":"https://static001.geekbang.org/account/avatar/00/13/26/38/ef063dc2.jpg","nickname":"Darren","note":"","ucode":"CCD2B2C492BE9A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1019939,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/23/5c74e9b7.jpg","nickname":"$ä¾¯","note":"","ucode":"488B1BD3924E7E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":547024,"discussion_content":"è°¢è°¢å¤§ä½¬","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642498682,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":546959,"ip_address":"","group_id":0},"score":547024,"extra":""}]},{"author":{"id":1214303,"avatar":"https://static001.geekbang.org/account/avatar/00/12/87/5f/6bf8b74a.jpg","nickname":"Kepler","note":"","ucode":"0C9CA3DB8B3CF0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":559889,"discussion_content":"æ„Ÿè§‰ç¬¬äºŒç‰ˆçš„!preAlloc + !blockå®ç°ï¼Œå¤§ç™½è€å¸ˆæ˜¯ä¸ºäº†ç»™æˆ‘ä»¬å±•ç¤ºè¿™ç§ç”¨æ³•ï¼Œå®æˆ˜åº”è¯¥é‡‡ç”¨preAlloc + !blockçš„ç»„åˆï¼Œè€Œä¸”taskChané‡‡ç”¨ç¼“å†²æ–¹å¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649043619,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1603004,"avatar":"https://static001.geekbang.org/account/avatar/00/18/75/bc/89d88775.jpg","nickname":"Calvin","note":"","ucode":"0EEF5B207623B5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546968,"discussion_content":"æˆ‘è‡ªå·±ç†äº†ä¸‹ï¼Œè¯•ç€å¸®è€å¸ˆå›ç­”ä¸‹è¿™äº›é—®é¢˜ï¼Œå¸Œæœ›æœ‰é”™å¸®å¿™æŒ‡æ­£ï¼\n1ã€&lt;-p.active ä¸æ”¾åœ¨ if å¤–é¢ï¼Œå› ä¸ºåªæœ‰å‘ç”Ÿpanicæ—¶æ‰éœ€è¦æŠŠ p.active è®¡æ•°å‡ä¸€ï¼ˆæ­¤æ—¶runåˆä¼šé‡æ–°newä¸€ä¸ªæ–°çš„workerï¼Œä¿æŒâ€œæ± â€ä¸­æ´»è·ƒ goroutine æ•°æ’å®šï¼‰ï¼›\n2ã€ä½ è¯´çš„å¯¹ï¼›\n3ã€returnTaskæ–¹æ³•ï¼Œä¸å®ƒçš„åå­—å­—é¢å«ä¹‰ä¸€æ ·ï¼Œä½œç”¨æ˜¯â€œå½’è¿˜â€taskç»™p.tasksé€šé“ï¼Œå› ä¸ºfor-rangeå¤„è¯»å–tasksçš„æœ¬æ„åªæ˜¯ä¸ºäº†æœ‰å¤šå°‘ä¸ªtaskå°±åˆ›å»ºå¤šå°‘ä¸ªgoroutineçš„workerï¼ˆç›´åˆ°æ•°é‡è¾¾åˆ°capacityï¼Œå†break loopé€€å‡ºå¾ªç¯æ‰§è¡Œä¸‹é¢çš„é€»è¾‘ï¼‰ï¼Œæ­¤å¤„å¹¶ä¸çœŸæ­£æ‰§è¡Œä»»åŠ¡ï¼Œæ‰€ä»¥å°†å®ƒå½’è¿˜å›å»ï¼Œä»¥ä¾¿å¦ä¸€å¤„çœŸæ­£æ‰§è¡Œä»»åŠ¡çš„åœ°æ–¹èƒ½æ¥æ”¶åˆ°ä»»åŠ¡ï¼ˆt := &lt;-p.tasksï¼‰ã€‚å®Œæ•´æºç åœ¨githubæœ‰ï¼šæ–‡ç« æœ€åæœ‰é“¾æ¥ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642483301,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":4,"child_discussions":[{"author":{"id":1254968,"avatar":"https://static001.geekbang.org/account/avatar/00/13/26/38/ef063dc2.jpg","nickname":"Darren","note":"","ucode":"CCD2B2C492BE9A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1603004,"avatar":"https://static001.geekbang.org/account/avatar/00/18/75/bc/89d88775.jpg","nickname":"Calvin","note":"","ucode":"0EEF5B207623B5","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":547023,"discussion_content":"è°¢è°¢å¤§ä½¬æŒ‡ç‚¹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642498676,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":546968,"ip_address":"","group_id":0},"score":547023,"extra":""},{"author":{"id":1184102,"avatar":"https://static001.geekbang.org/account/avatar/00/12/11/66/ac631a36.jpg","nickname":"Geralt","note":"","ucode":"2F31ED777D06A0","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1603004,"avatar":"https://static001.geekbang.org/account/avatar/00/18/75/bc/89d88775.jpg","nickname":"Calvin","note":"","ucode":"0EEF5B207623B5","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":547035,"discussion_content":"è°ƒç”¨returnTaskå½’è¿˜çš„taskè¿˜æ˜¯æœ‰å¯èƒ½è¢«for rangeè·å–åˆ°çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642500842,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":546968,"ip_address":"","group_id":0},"score":547035,"extra":""},{"author":{"id":1603004,"avatar":"https://static001.geekbang.org/account/avatar/00/18/75/bc/89d88775.jpg","nickname":"Calvin","note":"","ucode":"0EEF5B207623B5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1184102,"avatar":"https://static001.geekbang.org/account/avatar/00/12/11/66/ac631a36.jpg","nickname":"Geralt","note":"","ucode":"2F31ED777D06A0","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":547054,"discussion_content":"æ˜¯çš„ï¼Œæ‰€ä»¥æˆ‘è§‰å¾—è¿™é‡Œå¯ä»¥ä¼˜åŒ–ä¸‹ã€‚å¦å¤–ææˆè·Ÿjavaçš„é‚£æ ·ï¼Œå¸¦ä»»åŠ¡å¯åŠ¨æ–°workerï¼Œç›´åˆ°è¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1642510138,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":547035,"ip_address":"","group_id":0},"score":547054,"extra":""}]}]},{"had_liked":false,"id":370067,"user_name":"Six Days","can_delete":false,"product_type":"c1","uid":1322463,"ip_address":"å¹¿ä¸œ","ucode":"8587F2EEFFFD11","user_header":"https://static001.geekbang.org/account/avatar/00/14/2d/df/4949b250.jpg","comment_is_top":false,"comment_ctime":1678348129,"is_pvip":false,"replies":[{"id":134931,"content":"demo1åˆ›å»ºgoroutineåæ²¡æœ‰å›æ”¶ï¼Œä¸€ç›´æ˜¯å¤ç”¨çš„ï¼Œæœ€å¤šåˆ›å»ºcapacityä¸ªgoroutineï¼Œç›´åˆ°poolé”€æ¯ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1678435665,"ip_address":"åŒ—äº¬","comment_id":370067,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100093501,"comment_content":"è¯·æ•™ä¸€ä¸‹ï¼Œæ± åŒ–çš„è¯ï¼Œå½“å‰çš„demo1åœºæ™¯æ˜¯ä¸æ˜¯æ²¡æœ‰è€ƒè™‘ä½¿ç”¨åŒä¸€ä¸ªworkerè¿›è¡Œtä»»åŠ¡çš„å¤„ç†ï¼Œè€Œæ˜¯é€šè¿‡ä¸æ–­çš„åˆ›å»º Goroutineå®ç°çš„ï¼Œé€šè¿‡capacityæ§åˆ¶äº†å¤„ç†ä»»åŠ¡Goroutineçš„æ•°é‡ï¼Œé€šè¿‡Go gc æ¥å®ç°Goroutineçš„å›æ”¶ï¼Œæ˜¯ä¸æ˜¯å› ä¸ºGoroutine çš„å å†…å­˜æ¯”è¾ƒå°ï¼Œä¸ºæ­¤æ²¡æœ‰åšGoroutine çš„å¤ç”¨ï¼Œæ‰€ä»¥é‡‡ç”¨ä¸æ–­åˆ›å»ºï¼Œè¿˜æ˜¯å½“å‰ä¸ºäº†ç®€å•æ¼”ç¤ºå‘¢ï¼Œå®é™…è¿˜æ˜¯éœ€è¦å¤ç”¨Goroutine çš„å‘¢ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":612674,"discussion_content":"å½“preAlloc=falseæ—¶ï¼Œå³ä¸é¢„åˆ†é…æ—¶ã€‚è¿™æ ·å°±æ ¹æ®tasksçš„æƒ…å†µæ¥åˆ›å»ºworkerã€‚å¦‚æœå½“å‰æ²¡æœ‰taskï¼Œå®é™…ä¸Šç³»ç»Ÿä¸­æ²¡æœ‰workerè¢«åˆ›å»ºå‡ºæ¥ï¼Œç›´åˆ°æœ‰taskæ‰ä¼šåˆ›å»ºworkerã€‚ä¸€ç›´åˆ°active channelæ»¡äº†ï¼è¿™æ ·poolä¸­æ‰€æœ‰workeréƒ½åˆ›å»ºå‡ºæ¥åï¼Œå†è·³å‡ºå¾ªç¯ï¼Œè¿›å…¥ä¸‹é¢çš„quitç›‘å¬ã€‚\n\nä¸è¿‡workpool2çš„è¿™æ®µä»£ç çš„ç¡®æœ‰refactorçš„ç©ºé—´ğŸ˜ã€‚å¯ä»¥å†™çš„æ›´å¥½ç†è§£ä¸€äº›ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1680843383,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":3522132,"avatar":"","nickname":"Geek_0d5d37","note":"","ucode":"1BB4AEF1328C64","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":612686,"discussion_content":"è€å¸ˆæˆ‘æ˜¯ä¸æ˜¯å¯ä»¥è¿™æ ·ç†è§£demo2è¿™æ®µä»£ç åªæ˜¯ä¸ºäº†åŒºåˆ«å½“preAlloc=falseæ—¶ï¼Œå³ä¸é¢„åˆ†é…æ—¶ã€‚ ä½“ç°å‡ºworkeræ²¡æœ‰æå‰åˆ›å»ºè€Œå·²ã€‚ åªæ˜¯è¿™é‡Œé€šè¿‡éå†tasksé˜»å¡äº†workeråˆ›å»ºæ¥å®ç°","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1680850746,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å››å·","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":3522132,"avatar":"","nickname":"Geek_0d5d37","note":"","ucode":"1BB4AEF1328C64","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":612684,"discussion_content":"è°¢è°¢è€å¸ˆçš„å›å¤","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1680850231,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å››å·","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":370065,"user_name":"Six Days","can_delete":false,"product_type":"c1","uid":1322463,"ip_address":"å¹¿ä¸œ","ucode":"8587F2EEFFFD11","user_header":"https://static001.geekbang.org/account/avatar/00/14/2d/df/4949b250.jpg","comment_is_top":false,"comment_ctime":1678346270,"is_pvip":false,"replies":[{"id":134932,"content":"runåœ¨Newä¸­è°ƒç”¨ï¼Œactiveæ»¡äº†ï¼Œä»£è¡¨capacityä¸ªworker goroutineå·²ç»åˆ›å»ºå®Œæ¯•ï¼Œåç»­å°†é‡ç”¨è¿™äº›goroutineã€‚è¿™æ—¶å€™runä¼šé˜»å¡åœ¨selectä¸Šç›´åˆ°quit channelæœ‰æ•°æ®æ‰ä¼šé€€å‡ºã€‚p.active é‚£ä¸ªcaseåç»­æ²¡ç”¨äº†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1678436361,"ip_address":"åŒ—äº¬","comment_id":370065,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100093501,"comment_content":"è¯·æ•™ä¸€ä¸‹ï¼Œp.active çš„chan å®¹é‡æŒ‡å®šæ˜¯capacityï¼Œè€Œåªæœ‰runçš„æ—¶å€™ï¼Œæ‰ä¼šé€šè¿‡p.active &lt;- struct{}{} å¾€p.activeä¸­ä¸¢ä¸œè¥¿ï¼Œp.active æ‰ä¼šå˜å¤šï¼Œè¾¾åˆ°capacityæ—¶ã€‚ä»»åŠ¡Tåˆ™é˜»å¡ï¼Œæˆ‘ç†è§£ run åªä¼šNewçš„æ—¶å€™è§¦å‘ï¼Œè¯·é—®æ˜¯å¦ä¸æ–‡ä¸­æè¿°ä¸€è‡´å‘¢ï¼Ÿ\nfunc (p *Pool) run() {\n\tidx := 0\n\n\tfor {\n\t\tselect {\n\t\tcase &lt;-p.quit:\n\t\t\treturn\n\t\tcase p.active &lt;- struct{}{}:\n\t\t\t&#47;&#47; create a new worker\n\t\t\tidx++\n\t\t\tp.newWorker(idx)\n\t\t}\n\t}\n}","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":608422,"discussion_content":"demo1åˆ›å»ºgoroutineåæ²¡æœ‰å›æ”¶ï¼Œä¸€ç›´æ˜¯å¤ç”¨çš„ï¼Œæœ€å¤šåˆ›å»ºcapacityä¸ªgoroutineï¼Œç›´åˆ°poolé”€æ¯ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1678435665,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":3647096,"avatar":"","nickname":"Geek_38ea75","note":"","ucode":"5295680D787299","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":629987,"discussion_content":"æ²¡æœ‰ä»»åŠ¡å°±é˜»å¡ï¼Œæ¯ä¸ªåç¨‹å°±æ˜¯åœ¨å¤ç”¨ï¼Œé™¤éæœ‰å¼‚å¸¸æƒ…å†µåç¨‹æ‰ä¼šé€€å‡ºï¼Œå³ä½¿æœ‰åç¨‹é€€å‡ºï¼Œè¿˜ä¼šæœ‰æ–°çš„åç¨‹è¢«åˆ›å»ºã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1697960462,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":366834,"user_name":"demajiao","can_delete":false,"product_type":"c1","uid":1907425,"ip_address":"æµ™æ±Ÿ","ucode":"1632CFCC16A5DF","user_header":"https://static001.geekbang.org/account/avatar/00/1d/1a/e1/1acde886.jpg","comment_is_top":false,"comment_ctime":1674396836,"is_pvip":false,"replies":[{"id":133706,"content":"å½“preAlloc=falseæ—¶ï¼Œå³ä¸é¢„åˆ†é…æ—¶ï¼Œæœ‰ç”¨ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ä½œè€…","uid":1026224,"ctime":1674692595,"ip_address":"è¾½å®","comment_id":366834,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100093501,"comment_content":"if !p.preAlloc {\n\tloop:\n\t\tfor t := range p.tasks {\n\t\t\tp.returnTask(t)\n\t\t\tselect {\n\t\t\tcase &lt;-p.quit:\n\t\t\t\treturn\n\t\t\tcase p.active &lt;- struct{}{}:\n\t\t\t\tidx++\n\t\t\t\tp.newWorker(idx)\n\t\t\tdefault:\n\t\t\t\tbreak loop\n\t\t\t}\n\t\t}\n\t}\n\nè¿™æ®µä»£ç æ„Ÿè§‰æ²¡ç”¨å‘€ã€‚","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":608424,"discussion_content":"runåœ¨Newä¸­è°ƒç”¨ï¼Œactiveæ»¡äº†ï¼Œä»£è¡¨capacityä¸ªworker goroutineå·²ç»åˆ›å»ºå®Œæ¯•ï¼Œåç»­å°†é‡ç”¨è¿™äº›goroutineã€‚è¿™æ—¶å€™runä¼šé˜»å¡åœ¨selectä¸Šç›´åˆ°quit channelæœ‰æ•°æ®æ‰ä¼šé€€å‡ºã€‚p.active é‚£ä¸ªcaseåç»­æ²¡ç”¨äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1678436361,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":366388,"user_name":"æ’•å½±","can_delete":false,"product_type":"c1","uid":3222094,"ip_address":"æ¹–å—","ucode":"8DC169F8B8E653","user_header":"https://static001.geekbang.org/account/avatar/00/31/2a/4e/a3f53cae.jpg","comment_is_top":false,"comment_ctime":1673682649,"is_pvip":false,"replies":[{"id":133538,"content":"â€œå…³é”®å˜åŒ–â€ï¼ŒæŒ‡çš„æ˜¯ï¼Ÿ","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1673857137,"ip_address":"åŒ—äº¬","comment_id":366388,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100093501,"comment_content":"ä¸ºä½•å…³é”®å˜åŒ–ä¸å†™å‡ºæ¥ï¼Ÿå¤ªä»“ä¿ƒäº†å§ï¼Œä¸€ç¯‡æœ€åä¸€èŠ‚ä»¥æ²¡çœ‹æ‡‚æ”¶åœºï¼Œå¯¹å­¦ç”Ÿæ‰“å‡»å¯ä¸å°å•Šè€å¸ˆ","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":600651,"discussion_content":"å½“preAlloc=falseæ—¶ï¼Œå³ä¸é¢„åˆ†é…æ—¶ï¼Œæœ‰ç”¨ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1674692596,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"è¾½å®","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":363111,"user_name":"Sunrise","can_delete":false,"product_type":"c1","uid":2820643,"ip_address":"è¾½å®","ucode":"791BC042992385","user_header":"https://static001.geekbang.org/account/avatar/00/2b/0a/23/c26f4e50.jpg","comment_is_top":false,"comment_ctime":1669250308,"is_pvip":false,"replies":[{"id":132082,"content":"æœ€åä¸€ç‰ˆScheduleåŠ å…¥äº†defaultåˆ†æ”¯ï¼Œå½“poolèµ„æºä¸å¤Ÿåˆè®¾ç½®ä¸ºnon blockæ—¶ï¼Œscheduleè‚¯å®šä¼šè¿”å›errorå•Šã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1669491203,"ip_address":"è¾½å®","comment_id":363111,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100093501,"comment_content":"è€ƒè™‘åˆ° Goroutine è°ƒåº¦çš„æ¬¡åºçš„ä¸ç¡®å®šæ€§ï¼Œè¿™é‡Œæˆ‘åœ¨åˆ›å»º workerpool ä¸çœŸæ­£å¼€å§‹è°ƒç”¨ Schedule æ–¹æ³•ä¹‹é—´ï¼Œåšäº†ä¸€ä¸ª Sleepï¼Œå°½é‡å‡å°‘ Schedule éƒ½è¿”å›å¤±è´¥çš„é¢‘ç‡\nè¿™å—ä¹Ÿä¸å¤ªæ‡‚ï¼Œä¸ºå•¥ä¸åŠ  Sleep ä¼šå…¨è¿”å›å¤±è´¥å‘¢ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":599883,"discussion_content":"â€œå…³é”®å˜åŒ–â€ï¼ŒæŒ‡çš„æ˜¯ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1673857138,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":363058,"user_name":"Sunrise","can_delete":false,"product_type":"c1","uid":2820643,"ip_address":"åŒ—äº¬","ucode":"791BC042992385","user_header":"https://static001.geekbang.org/account/avatar/00/2b/0a/23/c26f4e50.jpg","comment_is_top":false,"comment_ctime":1669188776,"is_pvip":false,"replies":[{"id":132042,"content":"é—®é¢˜1ï¼šä¸»è¦æ˜¯ä¸ºäº†å¯é€‰å‚æ•°å§ã€‚ä¸ºä»€ä¹ˆgoæ²¡æœ‰åŸç”Ÿæ”¯æŒé»˜è®¤å‚æ•°ä¸å¯é€‰å‚æ•°ï¼Œæˆ‘çŒœæ˜¯å› ä¸ºgoè®¾è®¡è€…å‹æ ¹å°±ä¸æƒ³å¼•å…¥è¿™ä¸ªå¤æ‚æ€§ã€‚\n\né—®é¢˜2: å’Œgoroutineçš„è°ƒåº¦é¡ºåºæœ‰å…³ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1669251802,"ip_address":"åŒ—äº¬","comment_id":363058,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100093501,"comment_content":"æœ‰å‡ ä¸ªé—®é¢˜ä¸å¤§ç†è§£ï¼Œæœ›è€å¸ˆæŠ½ç©ºè§£ç­”ï¼š\n1ï¼‰è‡ªå¼•ç”¨å‡½æ•°ä¸é€‰é¡¹è®¾è®¡æ˜¯ä¸ºäº†è§£å†³ go å‡½æ•°æ²¡æœ‰é»˜è®¤å‚æ•°å’Œå¯é€‰å‚æ•°å—? go å‡½æ•°ä¸ºä»€ä¹ˆæ²¡æœ‰è®¾è®¡é»˜è®¤å‚æ•°å’Œå¯é€‰å‚æ•°å‘¢ï¼Ÿ\n2ï¼‰ä¸ºä»€ä¹ˆä¸‹é¢çš„ for { select ... }  æ”¾åˆ° goroutine ä¸­ æ‰ä¼šè¾“å‡º ch2: 2 ch1: 1 doneï¼Œ å¦‚æœç›´æ¥æ”¾åˆ°å¤–é¢åªä¼šè¾“å‡º doneï¼Ÿ\n  func TestSelect(t *testing.T) {\n\tch1 := make(chan int)\n\tch2 := make(chan int)\n\n\tgo func() {\n\t\tch1 &lt;- 1\n\t}()\n\n\tgo func() {\n\t\tch2 &lt;- 2\n\t}()\n\n\tgo func() {\n\t\tfor {\n\t\t\tselect {\n\t\t\tcase i := &lt;-ch1:\n\t\t\t\tfmt.Println(&quot;ch1:&quot;, i)\n\t\t\tcase j := &lt;-ch2:\n\t\t\t\tfmt.Println(&quot;ch2:&quot;, j)\n\t\t\tdefault:\n\t\t\t\tfmt.Println(&quot;done&quot;)\n\t\t\t\treturn\n\t\t\t}\n\t\t}\n\t}()\n\t&#47;&#47; ch2: 2 ch1: 1 done\n}","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":594864,"discussion_content":"æœ€åä¸€ç‰ˆScheduleåŠ å…¥äº†defaultåˆ†æ”¯ï¼Œå½“poolèµ„æºä¸å¤Ÿåˆè®¾ç½®ä¸ºnon blockæ—¶ï¼Œscheduleè‚¯å®šä¼šè¿”å›errorå•Šã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1669491203,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"è¾½å®","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":338386,"user_name":"ivhong","can_delete":false,"product_type":"c1","uid":2659871,"ip_address":"","ucode":"9947B228807AC9","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJ8ic8eLTo5rnqIMJicUfpkVBrOUJAW4fANicKIbHdC54O9SOdwSoeK6o8icibaUbh7ZUXAkGF9zwHqo0Q/132","comment_is_top":false,"comment_ctime":1647479909,"is_pvip":false,"replies":[{"id":123699,"content":"å¥½é—®é¢˜ã€‚\n\n1. ä¼ ç»Ÿç†è§£çš„coroutineä¸€èˆ¬æ˜¯é¢å‘åä½œå¼ï¼Œè€ŒéæŠ¢å å¼ã€‚åƒpythonä¸­é€šè¿‡yieldå…³é”®å­—åˆ›å»ºçš„åç¨‹ï¼Œä¸ä¸»routineä¹‹é—´æ˜¯åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸Šå®ç°çš„åˆ‡æ¢æ‰§è¡Œï¼Œä»è®¾è®¡è§’åº¦æ˜¯é€šè¿‡coroutineå®ç°äº†å¹¶å‘(concurrency)ï¼Œä½†å…¶å®å®ƒä»¬è¿˜æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼Œä¸ä¼šçœŸæ­£å¹¶è¡Œ(paralellism)ï¼Œå³ä¾¿åœ¨å¤šæ ¸å¤„ç†å™¨ä¸Šã€‚\n                                                                                             \nåŸºäºä¸Šé¢çš„ç†è§£ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ„è¯†åˆ°goroutineå¹¶éä¼ ç»Ÿæ„ä¹‰ä¸Šçš„coroutineï¼Œæ˜¯æ”¯æŒæŠ¢å çš„ï¼Œè€Œä¸”ä¹Ÿå¿…é¡»ä¾èµ–æŠ¢å å®ç°runtimeå¯¹goroutineçš„è°ƒåº¦ã€‚å®ƒæ›´åƒthreadï¼Œå¯ä»¥ç»‘å®šä¸åŒçš„cpuæ ¸å¹¶è¡Œæ‰§è¡Œï¼ˆå¦‚æœæ˜¯åœ¨å¤šæ ¸å¤„ç†å™¨ä¸Šçš„è¯ï¼‰ã€‚åŒæ—¶åŸºäºgoroutineçš„è®¾è®¡ä¹Ÿä¼šä¸€ç§å¹¶å‘çš„è®¾è®¡ã€‚\n\nè€Œgoroutineä¸threadåˆä¸åŒï¼Œgoroutineæ˜¯åœ¨ç”¨æˆ·å±‚(ç›¸è¾ƒäºosçš„å†…æ ¸å±‚ï¼‰è°ƒåº¦çš„ï¼Œoså¹¶ä¸çŸ¥é“å…¶å­˜åœ¨ï¼Œgoroutineçš„åˆ‡æ¢ç›¸å¯¹è½»é‡ã€‚è€Œthreadæ˜¯os\næ¥è°ƒåº¦çš„ï¼Œåˆ‡æ¢ä»£ä»·æ›´é«˜ä¸€äº›ã€‚\n\næ‰€ä»¥æ–‡ä¸­å°†goroutineç§°ä¸ºâ€œè½»é‡çº§çº¿ç¨‹â€ï¼Œè€Œä¸æ˜¯åç¨‹ã€‚\n\n2. ä½ ç†è§£çš„æ²¡é”™ã€‚è¿™èŠ‚è¯¾æ˜¯ä¸ºäº†æ¼”ç¤ºgoroutineã€channelä¹‹é—´çš„è°ƒåº¦ä¸é€šä¿¡æœºåˆ¶è€Œâ€œè®¾è®¡â€å‡ºæ¥çš„ã€‚goroutineä½¿ç”¨ä»£ä»·å¾ˆä½ï¼Œé€šå¸¸ä¸ç”¨è€ƒè™‘æ± åŒ–ã€‚ä½†æ˜¯åœ¨ä¸€äº›å¤§å‹ç½‘ç»œæœåŠ¡ç¨‹åºæ—¶ï¼Œä¸€æ—¦goroutineæ•°é‡è¿‡å¤šï¼Œå†…å­˜å ç”¨ä»¥åŠè°ƒåº¦goroutineçš„ä»£ä»·å°±ä¸èƒ½ä¸è€ƒè™‘äº†ã€‚äºæ˜¯æœ‰äº†â€œæ± åŒ–â€çš„æ€è·¯ã€‚è¿™ä¸ä¼ ç»Ÿçš„çº¿ç¨‹æ± çš„æ€è·¯çš„ç¡®æ˜¯ä¸€è„‰ç›¸æ‰¿çš„\n\n3. goæ˜¯gcçš„ï¼Œå†…å­˜ä¸ä¼šè¶Šæ¥è¶Šå¤§ã€‚\n","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1647495219,"ip_address":"","comment_id":338386,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100093501,"comment_content":"éå¸¸æ„Ÿè°¢è€å¸ˆå¸¦ç€åšäº†ä¸€æ¬¡è¿™æ ·çš„å®ç°ï¼Œå› ä¸ºæˆ‘è‡ªå·±ä¹Ÿå°è¯•è¿‡è¿™ç§å®ç°ï¼ˆçº¯ç²¹æ˜¯ä¸ºäº†å­¦ä¹ ç”¨ï¼‰ã€‚æœ‰å‡ ä¸ªé—®é¢˜æˆ‘ä¸æ˜¯ç‰¹åˆ«æ˜ç™½ï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯å’Œè€å¸ˆç†è§£çš„ä¸€æ ·ï¼Œæœ›è€å¸ˆé—²æš‡ä¹‹ä½™ç»™äºˆæŒ‡æ­£ï¼Œè°¢è°¢ï¼\n1. è¿™ä¸ªæ˜¯ä¸æ˜¯å«â€œåç¨‹æ± â€ï¼Œä¸ºä»€ä¹ˆå«åšâ€œçº¿ç¨‹æ± â€ï¼Ÿä¸¤è€…æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿæˆ–è€…æ˜¯åˆ°åº•ä»€ä¹ˆæ˜¯â€œåç¨‹â€å‘¢ï¼Ÿ\n2. æ˜¯ä¸æ˜¯è¿™èŠ‚è¯¾çš„å®ç°ï¼Œä¹Ÿçº¯ç²¹æ˜¯ä¸ºäº†å­¦ä¹ è€Œå®ç°çš„ï¼Œä¸ªäººç†è§£ï¼Œgoå®ç°Goroutineï¼Œå°±æ˜¯ä¸ºäº†è§£å†³â€œçº¿ç¨‹æ± â€çš„ç¹çï¼Œè®©â€œå¹¶å‘â€å®ç°çš„ä¸ç”¨é‚£ä¹ˆçš„éº»çƒ¦ï¼Œå¦‚æœæ˜¯è¶…å°â€œä»»åŠ¡â€ï¼Œä¸ç”¨è€ƒè™‘çº¿ç¨‹é¢‘ç¹åˆ‡æ¢å¯¼è‡´ç³»ç»Ÿèµ„æºçš„æµªè´¹ã€‚å¦‚æœå†å®ç°â€œåç¨‹æ± â€çš„è¯ï¼Œæ˜¯ä¸æ˜¯ä¸¢å¤±äº†è¿™ç§ä¼˜ç‚¹ï¼Ÿ\n3. å¸¸é©»å†…å­˜çš„Goroutineï¼Œåå¤ä½¿ç”¨ï¼Œä¼šå¯¼è‡´è¿™ä¸ªGoroutineçš„å†…å­˜è¶Šæ¥è¶Šå¤§ï¼Œæˆ–è€…å…¶ä»–éšè—çš„é£é™©ä¹ˆï¼Ÿ","like_count":14,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":556741,"discussion_content":"å¥½é—®é¢˜ã€‚\n\n1. ä¼ ç»Ÿç†è§£çš„coroutineä¸€èˆ¬æ˜¯é¢å‘åä½œå¼ï¼Œè€ŒéæŠ¢å å¼ã€‚åƒpythonä¸­é€šè¿‡yieldå…³é”®å­—åˆ›å»ºçš„åç¨‹ï¼Œä¸ä¸»routineä¹‹é—´æ˜¯åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸Šå®ç°çš„åˆ‡æ¢æ‰§è¡Œï¼Œä»è®¾è®¡è§’åº¦æ˜¯é€šè¿‡coroutineå®ç°äº†å¹¶å‘(concurrency)ï¼Œä½†å…¶å®å®ƒä»¬è¿˜æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼Œä¸ä¼šçœŸæ­£å¹¶è¡Œ(paralellism)ï¼Œå³ä¾¿åœ¨å¤šæ ¸å¤„ç†å™¨ä¸Šã€‚\n                                                                                             \nåŸºäºä¸Šé¢çš„ç†è§£ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ„è¯†åˆ°goroutineå¹¶éä¼ ç»Ÿæ„ä¹‰ä¸Šçš„coroutineï¼Œæ˜¯æ”¯æŒæŠ¢å çš„ï¼Œè€Œä¸”ä¹Ÿå¿…é¡»ä¾èµ–æŠ¢å å®ç°runtimeå¯¹goroutineçš„è°ƒåº¦ã€‚å®ƒæ›´åƒthreadï¼Œå¯ä»¥ç»‘å®šä¸åŒçš„cpuæ ¸å¹¶è¡Œæ‰§è¡Œï¼ˆå¦‚æœæ˜¯åœ¨å¤šæ ¸å¤„ç†å™¨ä¸Šçš„è¯ï¼‰ã€‚åŒæ—¶åŸºäºgoroutineçš„è®¾è®¡ä¹Ÿä¼šä¸€ç§å¹¶å‘çš„è®¾è®¡ã€‚\n\nè€Œgoroutineä¸threadåˆä¸åŒï¼Œgoroutineæ˜¯åœ¨ç”¨æˆ·å±‚(ç›¸è¾ƒäºosçš„å†…æ ¸å±‚ï¼‰è°ƒåº¦çš„ï¼Œoså¹¶ä¸çŸ¥é“å…¶å­˜åœ¨ï¼Œgoroutineçš„åˆ‡æ¢ç›¸å¯¹è½»é‡ã€‚è€Œthreadæ˜¯os\næ¥è°ƒåº¦çš„ï¼Œåˆ‡æ¢ä»£ä»·æ›´é«˜ä¸€äº›ã€‚\n\næ‰€ä»¥æ–‡ä¸­å°†goroutineç§°ä¸ºâ€œè½»é‡çº§çº¿ç¨‹â€ï¼Œè€Œä¸æ˜¯åç¨‹ã€‚\n\n2. ä½ ç†è§£çš„æ²¡é”™ã€‚è¿™èŠ‚è¯¾æ˜¯ä¸ºäº†æ¼”ç¤ºgoroutineã€channelä¹‹é—´çš„è°ƒåº¦ä¸é€šä¿¡æœºåˆ¶è€Œâ€œè®¾è®¡â€å‡ºæ¥çš„ã€‚goroutineä½¿ç”¨ä»£ä»·å¾ˆä½ï¼Œé€šå¸¸ä¸ç”¨è€ƒè™‘æ± åŒ–ã€‚ä½†æ˜¯åœ¨ä¸€äº›å¤§å‹ç½‘ç»œæœåŠ¡ç¨‹åºæ—¶ï¼Œä¸€æ—¦goroutineæ•°é‡è¿‡å¤šï¼Œå†…å­˜å ç”¨ä»¥åŠè°ƒåº¦goroutineçš„ä»£ä»·å°±ä¸èƒ½ä¸è€ƒè™‘äº†ã€‚äºæ˜¯æœ‰äº†â€œæ± åŒ–â€çš„æ€è·¯ã€‚è¿™ä¸ä¼ ç»Ÿçš„çº¿ç¨‹æ± çš„æ€è·¯çš„ç¡®æ˜¯ä¸€è„‰ç›¸æ‰¿çš„\n\n3. goæ˜¯gcçš„ï¼Œå†…å­˜ä¸ä¼šè¶Šæ¥è¶Šå¤§ã€‚\n","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1647495219,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":331114,"user_name":"$ä¾¯","can_delete":false,"product_type":"c1","uid":1019939,"ip_address":"","ucode":"488B1BD3924E7E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/90/23/5c74e9b7.jpg","comment_is_top":false,"comment_ctime":1642430185,"is_pvip":false,"replies":[{"id":120983,"content":"åŸæ–‡ä¸­æœ‰æºç çš„é“¾æ¥ï¼Œåœ¨æœ€åã€‚\n\næºç åœ¨ https:&#47;&#47;github.com&#47;bigwhite&#47;publication&#47;tree&#47;master&#47;column&#47;timegeek&#47;go-first-course&#47;35\n\nçœ‹äº†åï¼Œå°±å¯ä»¥å›ç­”ä½ çš„é—®é¢˜äº†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ä½œè€…","uid":1026224,"ctime":1642475072,"ip_address":"","comment_id":331114,"utype":1}],"discussion_count":7,"race_medal":0,"score":2,"product_id":100093501,"comment_content":"è€å¸ˆæ‚¨å¥½è¯·æ•™å‡ ä¸ªé—®é¢˜ï¼š\nç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œdemo1ä¸­æ²¡æœ‰çœ‹åˆ°p.Freeçš„ä»£ç ç¤ºä¾‹ï¼ŒFreeæ–¹æ³•åªæ˜¯å‘p.quit &lt;- struct{}{}å‘é€ä¸€ä¸ªç©ºç»“æ„ä½“å°±å¯ä»¥å—ï¼Œè¯·æ•™ä¸‹Freeæ–¹å¼è¯¥å¦‚ä½•å†™\nç¬¬äºŒä¸ªé—®é¢˜ï¼Œdemo1ä¸­å¥½åƒä¹Ÿæ²¡çœ‹çœ‹åˆ°p.wg.Wait()","like_count":3,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546943,"discussion_content":"åŸæ–‡ä¸­æœ‰æºç çš„é“¾æ¥ï¼Œåœ¨æœ€åã€‚\n\næºç åœ¨ https://github.com/bigwhite/publication/tree/master/column/timegeek/go-first-course/35\n\nçœ‹äº†åï¼Œå°±å¯ä»¥å›ç­”ä½ çš„é—®é¢˜äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642475072,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":6,"child_discussions":[{"author":{"id":1019939,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/23/5c74e9b7.jpg","nickname":"$ä¾¯","note":"","ucode":"488B1BD3924E7E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":546945,"discussion_content":"çœ‹åˆ°æœ€åå‘ç°äº†ï¼Œä¸çŸ¥é“æ€ä¹ˆåˆ è¯„è®º[æ‚è„¸]","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642475212,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":546943,"ip_address":"","group_id":0},"score":546945,"extra":""},{"author":{"id":1603004,"avatar":"https://static001.geekbang.org/account/avatar/00/18/75/bc/89d88775.jpg","nickname":"Calvin","note":"","ucode":"0EEF5B207623B5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":546967,"discussion_content":"è€å¸ˆï¼Œè¯•äº†ä¸‹è‡ªå·±æ‰‹åŠ¨å‘ struct{}{}åˆ°p.quitä¼šdeadlockï¼Œè°ƒç”¨close(p.quit)å°±ä¸ä¼šï¼Œä¸¤è€…æœ‰å•¥åŒºåˆ«å‘¢ï¼Ÿæˆ–è€…è¯´closeå‡½æ•°æ˜¯å¦è¿˜å¤šå®ç°äº†å“ªäº›æ“ä½œï¼Ÿ\n\nå¦å¤–ï¼Œp.activeå’Œp.tasksä¸ç”¨closeå—ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642482584,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":546943,"ip_address":"","group_id":0},"score":546967,"extra":""},{"author":{"id":1019939,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/23/5c74e9b7.jpg","nickname":"$ä¾¯","note":"","ucode":"488B1BD3924E7E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1603004,"avatar":"https://static001.geekbang.org/account/avatar/00/18/75/bc/89d88775.jpg","nickname":"Calvin","note":"","ucode":"0EEF5B207623B5","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546987,"discussion_content":"æˆ‘çš„ç†è§£æ˜¯æœ‰å¥½å¤šä¸ªåœ°æ–¹çš„p.quitåœ¨ç­‰ç€æ¥æ”¶ï¼Œå¦‚æœä½ å¾€p.quitå‘é€äº†ä¸€ä¸ªstruct{}{}ï¼Œé™¤äº†æŠ¢åˆ°è¿™ä¸ªstruct{}{}çš„å…¶ä»–åœ°æ–¹çš„å°±deadlockäº†ï¼Œè€Œcloseå…³é—­ä¼šå‘æ‰€æœ‰çš„p.quitå‘å‡ºä¸€ä¸ªé€šçŸ¥ï¼Œåƒå‰é¢ç¬¬33ç« èŠ‚é‡Œä»‹ç»çš„ä¸€å¯¹å¤šå…³ç³»çš„ä¿¡å·é‡çš„é‚£ä¸ªä¾‹å­","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1642488356,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":546967,"ip_address":"","group_id":0},"score":546987,"extra":""}]}]},{"had_liked":false,"id":331112,"user_name":"Darren","can_delete":false,"product_type":"c1","uid":1254968,"ip_address":"","ucode":"CCD2B2C492BE9A","user_header":"https://static001.geekbang.org/account/avatar/00/13/26/38/ef063dc2.jpg","comment_is_top":false,"comment_ctime":1642429951,"is_pvip":false,"replies":[{"id":121004,"content":"çœ‹çš„çœŸç»†è‡´ï¼ğŸ‘\n\n1. workerä¸€æ—¦åˆ›å»ºåï¼Œé™¤äº†panicå’Œquité€šçŸ¥é€€å‡ºï¼Œworkeræ˜¯ä¸ä¼šé€€å‡ºçš„ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰æ‰€è°“â€œæ­£å¸¸é€€å‡ºâ€çš„æƒ…å†µã€‚æ‰€ä»¥æ²¡åœ¨deferä¸­è°ƒç”¨&lt;-p.activeã€‚\n2. çš„ç¡®æ˜¯ç¬”è¯¯,æ„Ÿè°¢æŒ‡å‡ºã€‚\n3. åœ¨æ–‡åæœ‰æºç é“¾æ¥ã€‚è¿™é‡Œçš„taskä»…æ˜¯è§¦å‘äº†workeråˆ›å»ºï¼Œè¿™é‡Œæ˜¯è°ƒåº¦å¾ªç¯ï¼Œä¸å¤„ç†taskï¼Œæ‰€ä»¥è¦æŠŠtaskæ‰”å›tasks channelï¼Œç­‰workerå¯åŠ¨åå†å¤„ç†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1642488429,"ip_address":"","comment_id":331112,"utype":1}],"discussion_count":12,"race_medal":0,"score":2,"product_id":100093501,"comment_content":"è€å¸ˆä»¥ä¸‹å‡ ä¸ªé—®é¢˜å“ˆï¼š\n1ã€ç¬¬ä¸€ç§å®ç°ä¸­ï¼Œè¿™å—æ˜¯ä¸æ˜¯æœ‰ç‚¹é—®é¢˜ï¼š\n\ngo func() {\n    defer func() {\n        if err := recover(); err != nil {\n            fmt.Printf(&quot;worker[%03d]: recover panic[%s] and exit\\n&quot;, i, err)\n            &lt;-p.active\n        }\n        p.wg.Done()\n    }()\n\n  &lt;-p.activeæ˜¯ä¸æ˜¯åº”è¯¥è¦æ”¾åˆ°ifçš„å¤–é¢ï¼Œå¦‚æœtaskæ‰§è¡Œæœ¬èº«æ²¡æœ‰å‡ºé”™ï¼Œæ­£å¸¸ç»“æŸäº†ï¼Œactiveæ²¡æœ‰å‡å°‘çš„åœ°æ–¹\n\n2ã€è¿™å—æ–‡å­—æè¿°æœ‰ç‚¹é—®é¢˜ï¼Œp&lt;-activeåº”è¯¥æ˜¯&lt;-p.active\nâ€œä½¿ç”¨äº† defer+recover å¯¹ panic è¿›è¡Œæ•æ‰ï¼Œæ•æ‰å worker ä¹Ÿæ˜¯è¦é€€å‡ºçš„ï¼Œäºæ˜¯æˆ‘ä»¬è¿˜é€šè¿‡p&lt;-activeæ›´æ–°äº† worker è®¡æ•°å™¨â€\n\n3ã€ç¬¬äºŒç§å®ç°ä¸­ï¼Œå½“æ²¡æœ‰æå‰åˆ›å»ºworkerï¼Œé‚£ä¹ˆå½“tasksä¸­æœ‰ä»»åŠ¡çš„æ—¶å€™ï¼Œp.returnTaskæ–¹æ³•æ˜¯å¹²å•¥çš„ï¼Ÿæ–‡ç« ä¸­æ²¡æœ‰è¿™ä¸ªæ–¹æ³•ï¼Œä¸”æ–‡å­—ä¹Ÿæ²¡æœ‰è¯´æ˜å‘€\n\n func (p *Pool) run() {\n     idx := len(p.active)\n \n     if !p.preAlloc {\n     loop:\n         for t := range p.tasks {\n             p.returnTask(t)\n             select {\n             case &lt;-p.quit:\n                 return\n             case p.active &lt;- struct{}{}:\n                 idx++\n                 p.newWorker(idx)\n             default:\n                 break loop\n             }\n         }\n     }\n ","like_count":3,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546943,"discussion_content":"åŸæ–‡ä¸­æœ‰æºç çš„é“¾æ¥ï¼Œåœ¨æœ€åã€‚\n\næºç åœ¨ https://github.com/bigwhite/publication/tree/master/column/timegeek/go-first-course/35\n\nçœ‹äº†åï¼Œå°±å¯ä»¥å›ç­”ä½ çš„é—®é¢˜äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642475072,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":6,"child_discussions":[{"author":{"id":1019939,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/23/5c74e9b7.jpg","nickname":"$ä¾¯","note":"","ucode":"488B1BD3924E7E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":546945,"discussion_content":"çœ‹åˆ°æœ€åå‘ç°äº†ï¼Œä¸çŸ¥é“æ€ä¹ˆåˆ è¯„è®º[æ‚è„¸]","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642475212,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":546943,"ip_address":"","group_id":0},"score":546945,"extra":""},{"author":{"id":1603004,"avatar":"https://static001.geekbang.org/account/avatar/00/18/75/bc/89d88775.jpg","nickname":"Calvin","note":"","ucode":"0EEF5B207623B5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":546967,"discussion_content":"è€å¸ˆï¼Œè¯•äº†ä¸‹è‡ªå·±æ‰‹åŠ¨å‘ struct{}{}åˆ°p.quitä¼šdeadlockï¼Œè°ƒç”¨close(p.quit)å°±ä¸ä¼šï¼Œä¸¤è€…æœ‰å•¥åŒºåˆ«å‘¢ï¼Ÿæˆ–è€…è¯´closeå‡½æ•°æ˜¯å¦è¿˜å¤šå®ç°äº†å“ªäº›æ“ä½œï¼Ÿ\n\nå¦å¤–ï¼Œp.activeå’Œp.tasksä¸ç”¨closeå—ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642482584,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":546943,"ip_address":"","group_id":0},"score":546967,"extra":""},{"author":{"id":1019939,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/23/5c74e9b7.jpg","nickname":"$ä¾¯","note":"","ucode":"488B1BD3924E7E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1603004,"avatar":"https://static001.geekbang.org/account/avatar/00/18/75/bc/89d88775.jpg","nickname":"Calvin","note":"","ucode":"0EEF5B207623B5","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546987,"discussion_content":"æˆ‘çš„ç†è§£æ˜¯æœ‰å¥½å¤šä¸ªåœ°æ–¹çš„p.quitåœ¨ç­‰ç€æ¥æ”¶ï¼Œå¦‚æœä½ å¾€p.quitå‘é€äº†ä¸€ä¸ªstruct{}{}ï¼Œé™¤äº†æŠ¢åˆ°è¿™ä¸ªstruct{}{}çš„å…¶ä»–åœ°æ–¹çš„å°±deadlockäº†ï¼Œè€Œcloseå…³é—­ä¼šå‘æ‰€æœ‰çš„p.quitå‘å‡ºä¸€ä¸ªé€šçŸ¥ï¼Œåƒå‰é¢ç¬¬33ç« èŠ‚é‡Œä»‹ç»çš„ä¸€å¯¹å¤šå…³ç³»çš„ä¿¡å·é‡çš„é‚£ä¸ªä¾‹å­","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1642488356,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":546967,"ip_address":"","group_id":0},"score":546987,"extra":""}]}]},{"had_liked":false,"id":372125,"user_name":"Geek_0d5d37","can_delete":false,"product_type":"c1","uid":3522132,"ip_address":"å››å·","ucode":"1BB4AEF1328C64","user_header":"","comment_is_top":false,"comment_ctime":1680764743,"is_pvip":false,"replies":[{"id":135834,"content":"å½“preAlloc=falseæ—¶ï¼Œå³ä¸é¢„åˆ†é…æ—¶ã€‚è¿™æ ·å°±æ ¹æ®tasksçš„æƒ…å†µæ¥åˆ›å»ºworkerã€‚å¦‚æœå½“å‰æ²¡æœ‰taskï¼Œå®é™…ä¸Šç³»ç»Ÿä¸­æ²¡æœ‰workerè¢«åˆ›å»ºå‡ºæ¥ï¼Œç›´åˆ°æœ‰taskæ‰ä¼šåˆ›å»ºworkerã€‚ä¸€ç›´åˆ°active channelæ»¡äº†ï¼è¿™æ ·poolä¸­æ‰€æœ‰workeréƒ½åˆ›å»ºå‡ºæ¥åï¼Œå†è·³å‡ºå¾ªç¯ï¼Œè¿›å…¥ä¸‹é¢çš„quitç›‘å¬ã€‚\n\nä¸è¿‡workpool2çš„è¿™æ®µä»£ç çš„ç¡®æœ‰refactorçš„ç©ºé—´ğŸ˜ã€‚å¯ä»¥å†™çš„æ›´å¥½ç†è§£ä¸€äº›ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1680843383,"ip_address":"åŒ—äº¬","comment_id":372125,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100093501,"comment_content":"è€å¸ˆæ‚¨å¥½ï¼Œè¿™ä¸ªæ®µä»£ç ä½œç”¨æˆ‘ä¹Ÿä¸å¤ªç†è§£\nif !p.preAlloc {\n\tloop:\n\t\tfor t := range p.tasks {\n\t\t\tp.returnTask(t)\n\t\t\tselect {\n\t\t\tcase &lt;-p.quit:\n\t\t\t\treturn\n\t\t\tcase p.active &lt;- struct{}{}:\n\t\t\t\tidx++\n\t\t\t\tp.newWorker(idx)\n\t\t\tdefault:\n\t\t\t\tbreak loop\n\t\t\t}\n\t\t}\n\t}\n\næ‚¨åœ¨ç•™è¨€ä¸­å›ç­” å½“preAlloc=falseæ—¶æœ‰ç”¨ ï¼Œå¦‚æœæ˜¯è¿™æ ·demo1 å°±æ˜¯ç­‰äºfasleçš„æƒ…å†µæ²¡ä½¿ç”¨è¿™æ®µä»£ç çš„ ï¼Œè¯·è€å¸ˆæœ‰ç©ºå›ç­”ä¸€ä¸‹","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":612674,"discussion_content":"å½“preAlloc=falseæ—¶ï¼Œå³ä¸é¢„åˆ†é…æ—¶ã€‚è¿™æ ·å°±æ ¹æ®tasksçš„æƒ…å†µæ¥åˆ›å»ºworkerã€‚å¦‚æœå½“å‰æ²¡æœ‰taskï¼Œå®é™…ä¸Šç³»ç»Ÿä¸­æ²¡æœ‰workerè¢«åˆ›å»ºå‡ºæ¥ï¼Œç›´åˆ°æœ‰taskæ‰ä¼šåˆ›å»ºworkerã€‚ä¸€ç›´åˆ°active channelæ»¡äº†ï¼è¿™æ ·poolä¸­æ‰€æœ‰workeréƒ½åˆ›å»ºå‡ºæ¥åï¼Œå†è·³å‡ºå¾ªç¯ï¼Œè¿›å…¥ä¸‹é¢çš„quitç›‘å¬ã€‚\n\nä¸è¿‡workpool2çš„è¿™æ®µä»£ç çš„ç¡®æœ‰refactorçš„ç©ºé—´ğŸ˜ã€‚å¯ä»¥å†™çš„æ›´å¥½ç†è§£ä¸€äº›ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1680843383,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":3522132,"avatar":"","nickname":"Geek_0d5d37","note":"","ucode":"1BB4AEF1328C64","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":612686,"discussion_content":"è€å¸ˆæˆ‘æ˜¯ä¸æ˜¯å¯ä»¥è¿™æ ·ç†è§£demo2è¿™æ®µä»£ç åªæ˜¯ä¸ºäº†åŒºåˆ«å½“preAlloc=falseæ—¶ï¼Œå³ä¸é¢„åˆ†é…æ—¶ã€‚ ä½“ç°å‡ºworkeræ²¡æœ‰æå‰åˆ›å»ºè€Œå·²ã€‚ åªæ˜¯è¿™é‡Œé€šè¿‡éå†tasksé˜»å¡äº†workeråˆ›å»ºæ¥å®ç°","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1680850746,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å››å·","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":3522132,"avatar":"","nickname":"Geek_0d5d37","note":"","ucode":"1BB4AEF1328C64","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":612684,"discussion_content":"è°¢è°¢è€å¸ˆçš„å›å¤","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1680850231,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å››å·","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":370067,"user_name":"Six Days","can_delete":false,"product_type":"c1","uid":1322463,"ip_address":"å¹¿ä¸œ","ucode":"8587F2EEFFFD11","user_header":"https://static001.geekbang.org/account/avatar/00/14/2d/df/4949b250.jpg","comment_is_top":false,"comment_ctime":1678348129,"is_pvip":false,"replies":[{"id":134931,"content":"demo1åˆ›å»ºgoroutineåæ²¡æœ‰å›æ”¶ï¼Œä¸€ç›´æ˜¯å¤ç”¨çš„ï¼Œæœ€å¤šåˆ›å»ºcapacityä¸ªgoroutineï¼Œç›´åˆ°poolé”€æ¯ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1678435665,"ip_address":"åŒ—äº¬","comment_id":370067,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100093501,"comment_content":"è¯·æ•™ä¸€ä¸‹ï¼Œæ± åŒ–çš„è¯ï¼Œå½“å‰çš„demo1åœºæ™¯æ˜¯ä¸æ˜¯æ²¡æœ‰è€ƒè™‘ä½¿ç”¨åŒä¸€ä¸ªworkerè¿›è¡Œtä»»åŠ¡çš„å¤„ç†ï¼Œè€Œæ˜¯é€šè¿‡ä¸æ–­çš„åˆ›å»º Goroutineå®ç°çš„ï¼Œé€šè¿‡capacityæ§åˆ¶äº†å¤„ç†ä»»åŠ¡Goroutineçš„æ•°é‡ï¼Œé€šè¿‡Go gc æ¥å®ç°Goroutineçš„å›æ”¶ï¼Œæ˜¯ä¸æ˜¯å› ä¸ºGoroutine çš„å å†…å­˜æ¯”è¾ƒå°ï¼Œä¸ºæ­¤æ²¡æœ‰åšGoroutine çš„å¤ç”¨ï¼Œæ‰€ä»¥é‡‡ç”¨ä¸æ–­åˆ›å»ºï¼Œè¿˜æ˜¯å½“å‰ä¸ºäº†ç®€å•æ¼”ç¤ºå‘¢ï¼Œå®é™…è¿˜æ˜¯éœ€è¦å¤ç”¨Goroutine çš„å‘¢ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":608422,"discussion_content":"demo1åˆ›å»ºgoroutineåæ²¡æœ‰å›æ”¶ï¼Œä¸€ç›´æ˜¯å¤ç”¨çš„ï¼Œæœ€å¤šåˆ›å»ºcapacityä¸ªgoroutineï¼Œç›´åˆ°poolé”€æ¯ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1678435665,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":3647096,"avatar":"","nickname":"Geek_38ea75","note":"","ucode":"5295680D787299","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":629987,"discussion_content":"æ²¡æœ‰ä»»åŠ¡å°±é˜»å¡ï¼Œæ¯ä¸ªåç¨‹å°±æ˜¯åœ¨å¤ç”¨ï¼Œé™¤éæœ‰å¼‚å¸¸æƒ…å†µåç¨‹æ‰ä¼šé€€å‡ºï¼Œå³ä½¿æœ‰åç¨‹é€€å‡ºï¼Œè¿˜ä¼šæœ‰æ–°çš„åç¨‹è¢«åˆ›å»ºã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1697960462,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":370065,"user_name":"Six Days","can_delete":false,"product_type":"c1","uid":1322463,"ip_address":"å¹¿ä¸œ","ucode":"8587F2EEFFFD11","user_header":"https://static001.geekbang.org/account/avatar/00/14/2d/df/4949b250.jpg","comment_is_top":false,"comment_ctime":1678346270,"is_pvip":false,"replies":[{"id":134932,"content":"runåœ¨Newä¸­è°ƒç”¨ï¼Œactiveæ»¡äº†ï¼Œä»£è¡¨capacityä¸ªworker goroutineå·²ç»åˆ›å»ºå®Œæ¯•ï¼Œåç»­å°†é‡ç”¨è¿™äº›goroutineã€‚è¿™æ—¶å€™runä¼šé˜»å¡åœ¨selectä¸Šç›´åˆ°quit channelæœ‰æ•°æ®æ‰ä¼šé€€å‡ºã€‚p.active é‚£ä¸ªcaseåç»­æ²¡ç”¨äº†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1678436361,"ip_address":"åŒ—äº¬","comment_id":370065,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100093501,"comment_content":"è¯·æ•™ä¸€ä¸‹ï¼Œp.active çš„chan å®¹é‡æŒ‡å®šæ˜¯capacityï¼Œè€Œåªæœ‰runçš„æ—¶å€™ï¼Œæ‰ä¼šé€šè¿‡p.active &lt;- struct{}{} å¾€p.activeä¸­ä¸¢ä¸œè¥¿ï¼Œp.active æ‰ä¼šå˜å¤šï¼Œè¾¾åˆ°capacityæ—¶ã€‚ä»»åŠ¡Tåˆ™é˜»å¡ï¼Œæˆ‘ç†è§£ run åªä¼šNewçš„æ—¶å€™è§¦å‘ï¼Œè¯·é—®æ˜¯å¦ä¸æ–‡ä¸­æè¿°ä¸€è‡´å‘¢ï¼Ÿ\nfunc (p *Pool) run() {\n\tidx := 0\n\n\tfor {\n\t\tselect {\n\t\tcase &lt;-p.quit:\n\t\t\treturn\n\t\tcase p.active &lt;- struct{}{}:\n\t\t\t&#47;&#47; create a new worker\n\t\t\tidx++\n\t\t\tp.newWorker(idx)\n\t\t}\n\t}\n}","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":608424,"discussion_content":"runåœ¨Newä¸­è°ƒç”¨ï¼Œactiveæ»¡äº†ï¼Œä»£è¡¨capacityä¸ªworker goroutineå·²ç»åˆ›å»ºå®Œæ¯•ï¼Œåç»­å°†é‡ç”¨è¿™äº›goroutineã€‚è¿™æ—¶å€™runä¼šé˜»å¡åœ¨selectä¸Šç›´åˆ°quit channelæœ‰æ•°æ®æ‰ä¼šé€€å‡ºã€‚p.active é‚£ä¸ªcaseåç»­æ²¡ç”¨äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1678436361,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":366834,"user_name":"demajiao","can_delete":false,"product_type":"c1","uid":1907425,"ip_address":"æµ™æ±Ÿ","ucode":"1632CFCC16A5DF","user_header":"https://static001.geekbang.org/account/avatar/00/1d/1a/e1/1acde886.jpg","comment_is_top":false,"comment_ctime":1674396836,"is_pvip":false,"replies":[{"id":133706,"content":"å½“preAlloc=falseæ—¶ï¼Œå³ä¸é¢„åˆ†é…æ—¶ï¼Œæœ‰ç”¨ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ä½œè€…","uid":1026224,"ctime":1674692595,"ip_address":"è¾½å®","comment_id":366834,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100093501,"comment_content":"if !p.preAlloc {\n\tloop:\n\t\tfor t := range p.tasks {\n\t\t\tp.returnTask(t)\n\t\t\tselect {\n\t\t\tcase &lt;-p.quit:\n\t\t\t\treturn\n\t\t\tcase p.active &lt;- struct{}{}:\n\t\t\t\tidx++\n\t\t\t\tp.newWorker(idx)\n\t\t\tdefault:\n\t\t\t\tbreak loop\n\t\t\t}\n\t\t}\n\t}\n\nè¿™æ®µä»£ç æ„Ÿè§‰æ²¡ç”¨å‘€ã€‚","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":600651,"discussion_content":"å½“preAlloc=falseæ—¶ï¼Œå³ä¸é¢„åˆ†é…æ—¶ï¼Œæœ‰ç”¨ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1674692596,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"è¾½å®","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":366388,"user_name":"æ’•å½±","can_delete":false,"product_type":"c1","uid":3222094,"ip_address":"æ¹–å—","ucode":"8DC169F8B8E653","user_header":"https://static001.geekbang.org/account/avatar/00/31/2a/4e/a3f53cae.jpg","comment_is_top":false,"comment_ctime":1673682649,"is_pvip":false,"replies":[{"id":133538,"content":"â€œå…³é”®å˜åŒ–â€ï¼ŒæŒ‡çš„æ˜¯ï¼Ÿ","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1673857137,"ip_address":"åŒ—äº¬","comment_id":366388,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100093501,"comment_content":"ä¸ºä½•å…³é”®å˜åŒ–ä¸å†™å‡ºæ¥ï¼Ÿå¤ªä»“ä¿ƒäº†å§ï¼Œä¸€ç¯‡æœ€åä¸€èŠ‚ä»¥æ²¡çœ‹æ‡‚æ”¶åœºï¼Œå¯¹å­¦ç”Ÿæ‰“å‡»å¯ä¸å°å•Šè€å¸ˆ","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":599883,"discussion_content":"â€œå…³é”®å˜åŒ–â€ï¼ŒæŒ‡çš„æ˜¯ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1673857138,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":363111,"user_name":"Sunrise","can_delete":false,"product_type":"c1","uid":2820643,"ip_address":"è¾½å®","ucode":"791BC042992385","user_header":"https://static001.geekbang.org/account/avatar/00/2b/0a/23/c26f4e50.jpg","comment_is_top":false,"comment_ctime":1669250308,"is_pvip":false,"replies":[{"id":132082,"content":"æœ€åä¸€ç‰ˆScheduleåŠ å…¥äº†defaultåˆ†æ”¯ï¼Œå½“poolèµ„æºä¸å¤Ÿåˆè®¾ç½®ä¸ºnon blockæ—¶ï¼Œscheduleè‚¯å®šä¼šè¿”å›errorå•Šã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1669491203,"ip_address":"è¾½å®","comment_id":363111,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100093501,"comment_content":"è€ƒè™‘åˆ° Goroutine è°ƒåº¦çš„æ¬¡åºçš„ä¸ç¡®å®šæ€§ï¼Œè¿™é‡Œæˆ‘åœ¨åˆ›å»º workerpool ä¸çœŸæ­£å¼€å§‹è°ƒç”¨ Schedule æ–¹æ³•ä¹‹é—´ï¼Œåšäº†ä¸€ä¸ª Sleepï¼Œå°½é‡å‡å°‘ Schedule éƒ½è¿”å›å¤±è´¥çš„é¢‘ç‡\nè¿™å—ä¹Ÿä¸å¤ªæ‡‚ï¼Œä¸ºå•¥ä¸åŠ  Sleep ä¼šå…¨è¿”å›å¤±è´¥å‘¢ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":594864,"discussion_content":"æœ€åä¸€ç‰ˆScheduleåŠ å…¥äº†defaultåˆ†æ”¯ï¼Œå½“poolèµ„æºä¸å¤Ÿåˆè®¾ç½®ä¸ºnon blockæ—¶ï¼Œscheduleè‚¯å®šä¼šè¿”å›errorå•Šã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1669491203,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"è¾½å®","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":363058,"user_name":"Sunrise","can_delete":false,"product_type":"c1","uid":2820643,"ip_address":"åŒ—äº¬","ucode":"791BC042992385","user_header":"https://static001.geekbang.org/account/avatar/00/2b/0a/23/c26f4e50.jpg","comment_is_top":false,"comment_ctime":1669188776,"is_pvip":false,"replies":[{"id":132042,"content":"é—®é¢˜1ï¼šä¸»è¦æ˜¯ä¸ºäº†å¯é€‰å‚æ•°å§ã€‚ä¸ºä»€ä¹ˆgoæ²¡æœ‰åŸç”Ÿæ”¯æŒé»˜è®¤å‚æ•°ä¸å¯é€‰å‚æ•°ï¼Œæˆ‘çŒœæ˜¯å› ä¸ºgoè®¾è®¡è€…å‹æ ¹å°±ä¸æƒ³å¼•å…¥è¿™ä¸ªå¤æ‚æ€§ã€‚\n\né—®é¢˜2: å’Œgoroutineçš„è°ƒåº¦é¡ºåºæœ‰å…³ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1669251802,"ip_address":"åŒ—äº¬","comment_id":363058,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100093501,"comment_content":"æœ‰å‡ ä¸ªé—®é¢˜ä¸å¤§ç†è§£ï¼Œæœ›è€å¸ˆæŠ½ç©ºè§£ç­”ï¼š\n1ï¼‰è‡ªå¼•ç”¨å‡½æ•°ä¸é€‰é¡¹è®¾è®¡æ˜¯ä¸ºäº†è§£å†³ go å‡½æ•°æ²¡æœ‰é»˜è®¤å‚æ•°å’Œå¯é€‰å‚æ•°å—? go å‡½æ•°ä¸ºä»€ä¹ˆæ²¡æœ‰è®¾è®¡é»˜è®¤å‚æ•°å’Œå¯é€‰å‚æ•°å‘¢ï¼Ÿ\n2ï¼‰ä¸ºä»€ä¹ˆä¸‹é¢çš„ for { select ... }  æ”¾åˆ° goroutine ä¸­ æ‰ä¼šè¾“å‡º ch2: 2 ch1: 1 doneï¼Œ å¦‚æœç›´æ¥æ”¾åˆ°å¤–é¢åªä¼šè¾“å‡º doneï¼Ÿ\n  func TestSelect(t *testing.T) {\n\tch1 := make(chan int)\n\tch2 := make(chan int)\n\n\tgo func() {\n\t\tch1 &lt;- 1\n\t}()\n\n\tgo func() {\n\t\tch2 &lt;- 2\n\t}()\n\n\tgo func() {\n\t\tfor {\n\t\t\tselect {\n\t\t\tcase i := &lt;-ch1:\n\t\t\t\tfmt.Println(&quot;ch1:&quot;, i)\n\t\t\tcase j := &lt;-ch2:\n\t\t\t\tfmt.Println(&quot;ch2:&quot;, j)\n\t\t\tdefault:\n\t\t\t\tfmt.Println(&quot;done&quot;)\n\t\t\t\treturn\n\t\t\t}\n\t\t}\n\t}()\n\t&#47;&#47; ch2: 2 ch1: 1 done\n}","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":594641,"discussion_content":"é—®é¢˜1ï¼šä¸»è¦æ˜¯ä¸ºäº†å¯é€‰å‚æ•°å§ã€‚ä¸ºä»€ä¹ˆgoæ²¡æœ‰åŸç”Ÿæ”¯æŒé»˜è®¤å‚æ•°ä¸å¯é€‰å‚æ•°ï¼Œæˆ‘çŒœæ˜¯å› ä¸ºgoè®¾è®¡è€…å‹æ ¹å°±ä¸æƒ³å¼•å…¥è¿™ä¸ªå¤æ‚æ€§ã€‚\n\né—®é¢˜2: å’Œgoroutineçš„è°ƒåº¦é¡ºåºæœ‰å…³ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1669251802,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":357118,"user_name":"è èå¹é›ªâ€”Code","can_delete":false,"product_type":"c1","uid":1650378,"ip_address":"è¾½å®","ucode":"A5B2FC661EE17D","user_header":"https://static001.geekbang.org/account/avatar/00/19/2e/ca/469f7266.jpg","comment_is_top":false,"comment_ctime":1662973407,"is_pvip":false,"replies":[{"id":130003,"content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1663098593,"ip_address":"è¾½å®","comment_id":357118,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100093501,"comment_content":"ä¸­ç§‹å‡æœŸæ‰“å¡","like_count":1},{"had_liked":false,"id":355492,"user_name":"H","can_delete":false,"product_type":"c1","uid":1019263,"ip_address":"è¾½å®","ucode":"1A31369846B553","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/QUCB325iaqkJCz8uzRFicXgoISWnlund6DdE25ibjlCTV2zkiccQsZ4Nib9XNdcCJpuPa2XaZ9GnRwp6ibJq4VegHsug/132","comment_is_top":false,"comment_ctime":1661425613,"is_pvip":false,"replies":[{"id":129461,"content":"1. æ˜¯çš„ã€‚\n2. åŸå› å°±æ˜¯é—®é¢˜1çš„æè¿°","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1661691110,"ip_address":"è¾½å®","comment_id":355492,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100093501,"comment_content":"æœ‰äº›æ²¡å¤ªæ‡‚ï¼š\n1. runé‡Œé¢ p.returnTask(t)ï¼Œç›¸å½“äºåˆæŠŠ task å¼‚æ­¥æ‰”p.tasks é‡Œé¢äº†ï¼Œç„¶ååˆ›å»ºworkerç­‰å¾…ä» p.tasksé‡Œé¢å–taskæ‰§è¡Œã€‚å› ä¸ºreturnTaskå’ŒnewWorkeréƒ½æ˜¯å¼‚æ­¥ï¼Œæ‰€ä»¥æ— æ³•ä¿è¯æ˜¯range p.tasksè¿˜æ˜¯workerå…ˆæ‰§è¡Œ\n2.åœ¨æˆ‘ç†è§£ï¼Œæ—¢ç„¶æ˜¯æƒ³å¼€5ä¸ªå®¹é‡çš„éé¢„åŠ è½½çš„çº¿ç¨‹æ± ï¼Œ10ä¸ªå¾ªç¯ä¸­åº”è¯¥å‰5ä¸ªåº”è¯¥éƒ½åˆ›å»ºwokerå‘€","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":587488,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1663098593,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"è¾½å®","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":354964,"user_name":"éªšåŠ¨","can_delete":false,"product_type":"c1","uid":2280216,"ip_address":"åŒ—äº¬","ucode":"EBEBF417C866D4","user_header":"https://static001.geekbang.org/account/avatar/00/22/cb/18/0139e086.jpg","comment_is_top":false,"comment_ctime":1660917165,"is_pvip":false,"replies":[{"id":129245,"content":"åœ¨çº¿å·¥å…·ï¼Œå¯ä»¥ç”¨processon.comï¼Œç¦»çº¿çš„æˆ‘ä¸€èˆ¬ç”¨draw.ioã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1661217333,"ip_address":"åŒ—äº¬","comment_id":354964,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100093501,"comment_content":"è€å¸ˆï¼Œè¯·æ•™ä¸€ä¸‹ï¼Œè¿™ç§è½¯ä»¶æ¶æ„å›¾æ˜¯ç”¨ä»€ä¹ˆç”»çš„å•Šï¼Ÿå¹³æ—¶è‡ªå·±ä¹Ÿæƒ³ç”»ç”»è‡ªå·±åšçš„ä¸œè¥¿çš„æ¶æ„å›¾ï¼Œä½†æ˜¯æ²¡æ‰¾åˆ°ä»€ä¹ˆåˆé€‚çš„å·¥å…·","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":585588,"discussion_content":"1. æ˜¯çš„ã€‚\n2. åŸå› å°±æ˜¯é—®é¢˜1çš„æè¿°","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661691110,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"è¾½å®","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":352037,"user_name":"æˆ‘å¥½åƒä¸€ç‚¹éƒ½ä¸åƒç¨‹åºå‘˜","can_delete":false,"product_type":"c1","uid":1435733,"ip_address":"","ucode":"F479190923355C","user_header":"https://static001.geekbang.org/account/avatar/00/15/e8/55/63189817.jpg","comment_is_top":false,"comment_ctime":1658361801,"is_pvip":false,"replies":[{"id":128098,"content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1658401847,"ip_address":"","comment_id":352037,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100093501,"comment_content":"åŠŸèƒ½é€‰é¡¹è¿™ç§å°è£…çš„æ–¹å¼ç¡®å®æ‹“å±•æ€§å¾ˆå¥½ï¼Œå’Œä¼ ç»Ÿçš„å‚æ•°ä¼ å…¥å¹¶è‡ªåŠ¨ç»‘å®šæ¥è¯´ï¼Œä¸éœ€è¦æ›´æ”¹New çš„ä»£ç ï¼Œåªéœ€è¦åœ¨å¤–æ‹“å±•","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":584906,"discussion_content":"åœ¨çº¿å·¥å…·ï¼Œå¯ä»¥ç”¨processon.comï¼Œç¦»çº¿çš„æˆ‘ä¸€èˆ¬ç”¨draw.ioã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661217333,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":351028,"user_name":"Geek_a6104e","can_delete":false,"product_type":"c1","uid":1711967,"ip_address":"","ucode":"29A56792216DC8","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/GJXKh8OG00U5ial64plAIibbIuwkzhPc8uYic9Hibl8SbqvhnS2JImHgCD4JGvTktiaVnCjHQWbA5wicaxRUN5aTEWnQ/132","comment_is_top":false,"comment_ctime":1657463972,"is_pvip":false,"replies":[{"id":127788,"content":"ç¤ºä¾‹åŸæ„å°±æ˜¯è®¾è®¡ä¸€ä¸ªåŒæ­¥æäº¤çš„workerpoolæ± ã€‚å³å¦‚æœScheduleæ–¹æ³•è¿”å›æˆåŠŸï¼Œè¯´æ˜ç”¨æˆ·æäº¤çš„taskè‚¯å®šè¢«æŸä¸ªworkerå¤„ç†äº†ã€‚\n\nå¦‚æœè¦è®¾è®¡ä¸ºå¼‚æ­¥æäº¤è¯­ä¹‰ï¼Œå¯ä»¥ä½¿ç”¨å¸¦ç¼“å†²çš„tasks channelã€‚é‚£æ ·scheduleæ–¹æ³•æäº¤åï¼Œtaskå¯èƒ½ä¸€ç›´åœ¨channelä¸­å­˜ç€ï¼Œç›´åˆ°æœ‰workerå¤„ç†ã€‚ä½†å½“ç¼“å†²åŒºæ»¡äº†ï¼Œè¿˜æ˜¯ä¼šé€€åŒ–ä¸ºåŒæ­¥æäº¤ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1657700552,"ip_address":"","comment_id":351028,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100093501,"comment_content":"è¯·é—®tasksé€šé“ä¸ºä»€ä¹ˆæ˜¯ä¸å¸¦ç¼“å­˜åŒºçš„","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":580915,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1658401847,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":346066,"user_name":"Hugh","can_delete":false,"product_type":"c1","uid":2285931,"ip_address":"","ucode":"77434E01E1D715","user_header":"https://static001.geekbang.org/account/avatar/00/22/e1/6b/74a8b7d8.jpg","comment_is_top":false,"comment_ctime":1652798680,"is_pvip":false,"replies":[{"id":126261,"content":"è¿™æ˜¯ä¸¤ä¸ªå±‚é¢çš„å¤ç”¨ã€‚GMPå¯¹Gæ•°æ®ç»“æ„çš„å¤ç”¨æ˜¯åœ¨runtimeè°ƒåº¦å±‚é¢ï¼Œä½†è¿™ç§å¤ç”¨ ç”¨æˆ·å±‚æ— æ³•æ§åˆ¶ï¼ŒGä¹Ÿä¸æ˜¯æ€»èƒ½è¢«å¤ç”¨ï¼Œå°±åƒsync.Poolä¸­æ•°æ®é¡¹ï¼Œåœ¨ä¸€å®šæ—¶é—´å†…å¦‚æœæ²¡æœ‰goroutineå»ä»æ± ä¸­getï¼Œé‚£ä¹ˆè¿˜æ˜¯ä¼šè¢«é‡Šæ”¾çš„ã€‚\n\nå½“ç„¶ç”¨æˆ·å±‚é¢å®ç°çš„goroutine æ± ä¹Ÿå¯ä»¥å¢åŠ idleé‡Šæ”¾çš„ç‰¹æ€§(è¿™ä¸€è®²ä¸­çš„ä¾‹å­ä¸æ”¯æŒ)ï¼Œä½†è¿™ç§é‡Šæ”¾æ˜¯ç”¨æˆ·å±‚å¯æ§çš„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1652822694,"ip_address":"","comment_id":346066,"utype":1}],"discussion_count":2,"race_medal":0,"score":3,"product_id":100093501,"comment_content":"è€å¸ˆæ‚¨å¥½ï¼Œè¯·æ•™ä¸ªé—®é¢˜ï¼Œä¹‹å‰è¯´è¿‡åœ¨GMPæ¨¡å‹ä¸­æ•°æ®ç»“æ„Gæ˜¯å¯ä»¥è¢«å¤ç”¨çš„ï¼Œé‚£ä¹ˆåç¨‹æ± è¿˜æœ‰å¿…è¦å—ï¼Ÿå› ä¸ºåç¨‹æ± çš„ä¸€å¤§ä¼˜åŠ¿å°±æ˜¯å¤ç”¨åç¨‹ï¼Œé¿å…åå¤åˆ›å»ºåç¨‹ï¼Œé‚£ä¹ˆå…¶å®go schedulerå·²ç»åšåˆ°äº†","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":579818,"discussion_content":"ç¤ºä¾‹åŸæ„å°±æ˜¯è®¾è®¡ä¸€ä¸ªåŒæ­¥æäº¤çš„workerpoolæ± ã€‚å³å¦‚æœScheduleæ–¹æ³•è¿”å›æˆåŠŸï¼Œè¯´æ˜ç”¨æˆ·æäº¤çš„taskè‚¯å®šè¢«æŸä¸ªworkerå¤„ç†äº†ã€‚\n\nå¦‚æœè¦è®¾è®¡ä¸ºå¼‚æ­¥æäº¤è¯­ä¹‰ï¼Œå¯ä»¥ä½¿ç”¨å¸¦ç¼“å†²çš„tasks channelã€‚é‚£æ ·scheduleæ–¹æ³•æäº¤åï¼Œtaskå¯èƒ½ä¸€ç›´åœ¨channelä¸­å­˜ç€ï¼Œç›´åˆ°æœ‰workerå¤„ç†ã€‚ä½†å½“ç¼“å†²åŒºæ»¡äº†ï¼Œè¿˜æ˜¯ä¼šé€€åŒ–ä¸ºåŒæ­¥æäº¤ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1657700553,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":343782,"user_name":"Geek_as","can_delete":false,"product_type":"c1","uid":1534500,"ip_address":"","ucode":"AB7B70DBC2B5F8","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/qhonwcQle1RBufvLdTm4MgSNl554GBXUZtNNH65oYajbbRLxKsZX4hM9vFtrLLpDM0H93ZNWRFAZSrIZC7yAsQ/132","comment_is_top":false,"comment_ctime":1651052596,"is_pvip":false,"replies":[{"id":125588,"content":"demo2ä½¿ç”¨Workpool2ä¸­çš„returnTaskä»£ç å¦‚ä¸‹ï¼š\n\nfunc (p *Pool) returnTask(t Task) {\n    go func() {\n        p.tasks &lt;- t\n    }()\n}\n\nreturnTaskä¸­åˆ›å»ºäº†ä¸€ä¸ªæ–°goroutineæ¥å¼‚æ­¥send taskï¼ŒreturnTaskæ€ä¹ˆä¼šå¡ä½å‘¢ï¼Ÿ","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1651138411,"ip_address":"","comment_id":343782,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100093501,"comment_content":"è€å¸ˆï¼Œæœ€åä¸€ä¸ªä¾‹å­å¥½åƒæœ‰é—®é¢˜ï¼Œå‡å¦‚æˆ‘è®¾ç½®çš„æ˜¯å½“æ²¡æœ‰æ´»åŠ¨go workerçš„æ—¶å€™é˜»å¡ï¼Œç„¶åå½“å‰çº¿ç¨‹ä¸ä¼šé¢„åˆ›å»ºï¼Œè¿™æ—¶å€™æˆ‘å¾€æ± é‡Œé¢æ·»åŠ ä¸€ä¸ªä»»åŠ¡ï¼Œç”±äºæ²¡æœ‰workerå¯ä»¥æ¥æ”¶ï¼Œå¯¼è‡´å®ƒèµ°åˆ°äº†default,ç”±äºæˆ‘æ˜¯è®¾ç½®äº†è·å–ä¸åˆ°å°±é˜»å¡,æ‰€ä»¥æˆ‘çš„ä»£ç èµ°åˆ°äº†\nif p.block{\n\t\t\tp.tasks &lt;- t\n}\nè¿™é‡Œï¼Œè¿™æ—¶å€™runæ–¹æ³•æ£€æµ‹åˆ°taskç®¡é“é‡Œæœ‰taskï¼Œå°±æ¥æ”¶ä¸‹æ¥ï¼Œå‰é¢çš„p.tasks &lt;- té˜»å¡é‡Šæ”¾äº†ï¼Œä¼šç»§ç»­èµ°ä¸‹å»ï¼Œç„¶årunçš„è¯ï¼Œåœ¨æ¥æ”¶äº†ç®¡é“çš„taskåï¼Œæ‰§è¡Œçš„ä¸‹ä¸€æ­¥æ“ä½œæ˜¯returnTask,ç„¶ååˆ›å»ºæ´»åŠ¨workerï¼Œå»æ‰§è¡ŒreturnTaskè¿”å›çš„taskï¼Œä½†å‡ºç°äº†ç¥å¥‡çš„ä¸€å¹•ï¼Œrunçš„æ‰§è¡Œæµç¨‹å¡åœ¨returnTaskçš„p.tasks &lt;- taskä¸­ï¼Œå¯¼è‡´åé¢çš„æ´»åŠ¨workeræ²¡æ³•åˆ›å»ºï¼Œä¸€ç›´å¡åœ¨returnTaské‚£é‡Œï¼Œåé¢æˆ‘åˆ†æäº†ä¸€ä¸‹ï¼Œæ„Ÿè§‰åº”è¯¥æ˜¯æˆ‘çš„tasksæ˜¯æ— ç¼“å†²é˜Ÿåˆ—ï¼Œæ‰€ä»¥returnTaskæ‰§è¡Œp.tasks &lt;- taskçš„æ—¶å€™å°±å¡åœ¨è¿™é‡Œï¼Œç­‰å¾…å…¶ä»–äººçš„æ¥æ”¶ï¼Œä½†è¿™æ ·å°±æœ‰é—®é¢˜äº†ï¼Œå› ä¸ºæ¥æ”¶æ“ä½œè¦ä¹ˆåœ¨runçš„rangeä¸­ï¼Œè¦ä¹ˆæ˜¯ç”±æ´»åŠ¨workeræ¥æ”¶ï¼Œå› ä¸ºå¡åœ¨returnTaskè¿™é‡Œï¼Œæ‰€ä»¥æ²¡æ³•åˆ›å»ºæ´»åŠ¨workerï¼Œä¹Ÿå°±æ²¡workeræ¶ˆè´¹ï¼Œå˜æˆäº†ç±»ä¼¼äºæ­»é”çš„æ ·å­ï¼Œå‡å¦‚æˆ‘é…ç½®äº†é˜»å¡ï¼Œå’Œä¸é¢„åˆ›å»ºï¼Œç†è®ºä¸Šæˆ‘æäº¤ç»™æ± é‡Œé¢çš„æ‰€æœ‰ä»»åŠ¡éƒ½ä¸ä¼šè¢«æ‰§è¡Œï¼Œæˆ‘è¯•äº†ä¸€ä¸‹ï¼Œå½“æäº¤çš„ä»»åŠ¡è¶…è¿‡ä¸¤ä¸ªå°±ä¼šçˆ†æ­»é”å¼‚å¸¸ï¼Œåé¢æˆ‘å°†returnTaskè¿™ä¸€æ­¥åŠ¨ä½œç§»åŠ¨åˆ°äº†åˆ›å»ºworkerä¹‹åï¼Œå°±è§£å†³äº†è¿™ä¸ªé—®é¢˜","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":568445,"discussion_content":"demo2ä½¿ç”¨Workpool2ä¸­çš„returnTaskä»£ç å¦‚ä¸‹ï¼š\n\nfunc (p *Pool) returnTask(t Task) {\n    go func() {\n        p.tasks &lt;- t\n    }()\n}\n\nreturnTaskä¸­åˆ›å»ºäº†ä¸€ä¸ªæ–°goroutineæ¥å¼‚æ­¥send taskï¼ŒreturnTaskæ€ä¹ˆä¼šå¡ä½å‘¢ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1651138411,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":338596,"user_name":"æœ¨æœ¨","can_delete":false,"product_type":"c1","uid":2704565,"ip_address":"","ucode":"86820F26A27308","user_header":"https://static001.geekbang.org/account/avatar/00/29/44/b5/7eba5a0e.jpg","comment_is_top":false,"comment_ctime":1647587716,"is_pvip":false,"replies":[{"id":123854,"content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1647810501,"ip_address":"","comment_id":338596,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100093501,"comment_content":"å­¦åˆ°å¾ˆå¤šï¼æ„Ÿè°¢","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":557431,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1647810501,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":335569,"user_name":"å¿«ä¹çš„è‡­è±†è…","can_delete":false,"product_type":"c1","uid":1115249,"ip_address":"","ucode":"1E0F2B55FF3023","user_header":"https://static001.geekbang.org/account/avatar/00/11/04/71/7e5d7c85.jpg","comment_is_top":false,"comment_ctime":1645590240,"is_pvip":false,"replies":[{"id":122616,"content":"æ˜¯é˜»å¡äº†ã€‚tasksæ˜¯ä¸å¸¦ç¼“å†²çš„channelï¼Œå¦‚æœ5ä¸ªworkeréƒ½åœ¨å¤„ç†taskï¼Œé‚£ä¹ˆæ²¡æœ‰ç©ºé—²çš„workerå»ä»tasksä¸­è¯»å–ï¼Œè¿™æ—¶scheduleæ–°taskä¼šé˜»å¡ã€‚ç›´åˆ°æœ‰ç©ºé—²workerã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1645607500,"ip_address":"","comment_id":335569,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100093501,"comment_content":"è€å¸ˆæ‚¨å¥½ï¼Œæœ‰ä¸ªåœ°æ–¹ä¸æ˜¯å¾ˆç†è§£ï¼Œå¸Œæœ›æ‚¨è§£ç­”ä¸€ä¸‹\n\nä»¥ç¬¬ä¸€ç‰ˆçš„WorkPoolä¸ºä¾‹\næˆ‘å°è¯•åœ¨Scheduleå‡½æ•°è¿½åŠ äº†printå‡½æ•°ï¼Œ\nfmt.Printf(&quot;%s: Scheduling task\\n&quot;, time.Now())\nå‘ç°æ‰€æœ‰çš„Taskå¹¶ä¸æ˜¯ä¸€æ¬¡æ€§åŠ å…¥åˆ°poolçš„\nå½“poolçš„capacity=5æ—¶ï¼Œä¼šå…ˆåŠ å…¥6ä¸ªtaskç„¶åç­‰æœ‰taskç»“æŸåå†Scheduleå‰©ä½™çš„taskï¼Œè¯·é—®è¿™æ˜¯è¢«é˜»å¡äº†å—ï¼Ÿç†è®ºä¸Šp.activeæ‰æœ‰capacityé™åˆ¶ï¼Œp.tasksåº”è¯¥æ˜¯ä¸€æ¬¡æ€§å†™å…¥çš„\n\n\n","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":552836,"discussion_content":"æ˜¯é˜»å¡äº†ã€‚tasksæ˜¯ä¸å¸¦ç¼“å†²çš„channelï¼Œå¦‚æœ5ä¸ªworkeréƒ½åœ¨å¤„ç†taskï¼Œé‚£ä¹ˆæ²¡æœ‰ç©ºé—²çš„workerå»ä»tasksä¸­è¯»å–ï¼Œè¿™æ—¶scheduleæ–°taskä¼šé˜»å¡ã€‚ç›´åˆ°æœ‰ç©ºé—²workerã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1645607500,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":333857,"user_name":"Witt","can_delete":false,"product_type":"c1","uid":1005864,"ip_address":"","ucode":"19C8BCA266130A","user_header":"https://static001.geekbang.org/account/avatar/00/0f/59/28/943709cb.jpg","comment_is_top":false,"comment_ctime":1644564434,"is_pvip":false,"replies":[{"id":122063,"content":"é¦–å…ˆè¿™ä»…æ˜¯ä¸€ä¸ªdemoã€‚goroutineæ± æœ‰å¾ˆå¤šç§å®ç°æ–¹å¼ï¼Œç”šè‡³åŸºäºåŒä¸€ç§æ–¹å¼ï¼Œæ¯”å¦‚æ–‡ä¸­çš„channelä¹Ÿæœ‰ä¸åŒçš„ç­–ç•¥è®¾å®šã€‚ä¹Ÿè®¸æ–‡ä¸­çš„demoè®¾å®šçš„å½“p.tasksé˜»å¡å°±è¿”å›é”™è¯¯ï¼ˆå½“p.block=falseæ—¶ï¼‰æœ‰äº›ä¸åˆç†ã€‚\n\n&quot;è®©è°ƒåº¦æ—¶ä¸é˜»å¡ï¼Œæ˜¯ä¸æ˜¯æŠŠ task æ”¾åˆ°ä¸€ä¸ªé˜Ÿåˆ—é‡Œæ’é˜Ÿæ›´åˆç†ï¼Œå†åŠ ä¸Šä¸€ä¸ªä¸¢å¼ƒç­–ç•¥ï¼Œç±»ä¼¼ Java ä¸­çš„çº¿ç¨‹æ± &quot; -- å¾ˆå¥½çš„æè®®ã€‚è¿™ä¹Ÿæ˜¯ä¸€ç§è®¾è®¡è¿‡ç¨‹çš„è®¾å®šï¼Œåœ¨æˆ‘çš„demoçš„åŸºç¡€ä¸Šï¼Œç¨ä½œä¿®æ”¹åº”è¯¥å°±èƒ½å®ç°ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1644762667,"ip_address":"","comment_id":333857,"utype":1}],"discussion_count":2,"race_medal":0,"score":3,"product_id":100093501,"comment_content":"è€å¸ˆï¼Œæ—¢ç„¶æ²¡æœ‰è¾¾åˆ°æœ€å¤§ worker æ•°ï¼Œä¸ºä»€ä¹ˆä¸æ˜¯å»åˆ›å»ºæ–°çš„ worker è€Œæ˜¯ç›´æ¥è¿”å›é”™è¯¯å‘¢ï¼Ÿè¿™ä¸€ç‚¹ä¸æ˜¯å¾ˆç†è§£ï¼Œä¸åº”è¯¥æ˜¯æ ¹æ® task è‡ªåŠ¨åˆ›å»ºé¢„æœŸå†…çš„ worker ç›´åˆ° worker æ•°æ»¡äº†å†è¿”å›æ²¡æœ‰ç©ºé—²çš„ worker é”™è¯¯å—\n\nå†ä¸€ä¸ªå°±æ˜¯ï¼Œè®©è°ƒåº¦æ—¶ä¸é˜»å¡ï¼Œæ˜¯ä¸æ˜¯æŠŠ task æ”¾åˆ°ä¸€ä¸ªé˜Ÿåˆ—é‡Œæ’é˜Ÿæ›´åˆç†ï¼Œå†åŠ ä¸Šä¸€ä¸ªä¸¢å¼ƒç­–ç•¥ï¼Œç±»ä¼¼ Java ä¸­çš„çº¿ç¨‹æ± ","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":550863,"discussion_content":"é¦–å…ˆè¿™ä»…æ˜¯ä¸€ä¸ªdemoã€‚goroutineæ± æœ‰å¾ˆå¤šç§å®ç°æ–¹å¼ï¼Œç”šè‡³åŸºäºåŒä¸€ç§æ–¹å¼ï¼Œæ¯”å¦‚æ–‡ä¸­çš„channelä¹Ÿæœ‰ä¸åŒçš„ç­–ç•¥è®¾å®šã€‚ä¹Ÿè®¸æ–‡ä¸­çš„demoè®¾å®šçš„å½“p.tasksé˜»å¡å°±è¿”å›é”™è¯¯ï¼ˆå½“p.block=falseæ—¶ï¼‰æœ‰äº›ä¸åˆç†ã€‚\n\n&#34;è®©è°ƒåº¦æ—¶ä¸é˜»å¡ï¼Œæ˜¯ä¸æ˜¯æŠŠ task æ”¾åˆ°ä¸€ä¸ªé˜Ÿåˆ—é‡Œæ’é˜Ÿæ›´åˆç†ï¼Œå†åŠ ä¸Šä¸€ä¸ªä¸¢å¼ƒç­–ç•¥ï¼Œç±»ä¼¼ Java ä¸­çš„çº¿ç¨‹æ± &#34; -- å¾ˆå¥½çš„æè®®ã€‚è¿™ä¹Ÿæ˜¯ä¸€ç§è®¾è®¡è¿‡ç¨‹çš„è®¾å®šï¼Œåœ¨æˆ‘çš„demoçš„åŸºç¡€ä¸Šï¼Œç¨ä½œä¿®æ”¹åº”è¯¥å°±èƒ½å®ç°ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644762667,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1005864,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/59/28/943709cb.jpg","nickname":"Witt","note":"","ucode":"19C8BCA266130A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":550900,"discussion_content":"æ„Ÿè°¢è€å¸ˆè€å¿ƒè§£ç­”","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644804613,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":550863,"ip_address":"","group_id":0},"score":550900,"extra":""}]}]},{"had_liked":false,"id":357118,"user_name":"è èå¹é›ªâ€”Code","can_delete":false,"product_type":"c1","uid":1650378,"ip_address":"è¾½å®","ucode":"A5B2FC661EE17D","user_header":"https://static001.geekbang.org/account/avatar/00/19/2e/ca/469f7266.jpg","comment_is_top":false,"comment_ctime":1662973407,"is_pvip":false,"replies":[{"id":130003,"content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1663098593,"ip_address":"è¾½å®","comment_id":357118,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100093501,"comment_content":"ä¸­ç§‹å‡æœŸæ‰“å¡","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":587488,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1663098593,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"è¾½å®","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":355492,"user_name":"H","can_delete":false,"product_type":"c1","uid":1019263,"ip_address":"è¾½å®","ucode":"1A31369846B553","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/QUCB325iaqkJCz8uzRFicXgoISWnlund6DdE25ibjlCTV2zkiccQsZ4Nib9XNdcCJpuPa2XaZ9GnRwp6ibJq4VegHsug/132","comment_is_top":false,"comment_ctime":1661425613,"is_pvip":false,"replies":[{"id":129461,"content":"1. æ˜¯çš„ã€‚\n2. åŸå› å°±æ˜¯é—®é¢˜1çš„æè¿°","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1661691110,"ip_address":"è¾½å®","comment_id":355492,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100093501,"comment_content":"æœ‰äº›æ²¡å¤ªæ‡‚ï¼š\n1. runé‡Œé¢ p.returnTask(t)ï¼Œç›¸å½“äºåˆæŠŠ task å¼‚æ­¥æ‰”p.tasks é‡Œé¢äº†ï¼Œç„¶ååˆ›å»ºworkerç­‰å¾…ä» p.tasksé‡Œé¢å–taskæ‰§è¡Œã€‚å› ä¸ºreturnTaskå’ŒnewWorkeréƒ½æ˜¯å¼‚æ­¥ï¼Œæ‰€ä»¥æ— æ³•ä¿è¯æ˜¯range p.tasksè¿˜æ˜¯workerå…ˆæ‰§è¡Œ\n2.åœ¨æˆ‘ç†è§£ï¼Œæ—¢ç„¶æ˜¯æƒ³å¼€5ä¸ªå®¹é‡çš„éé¢„åŠ è½½çš„çº¿ç¨‹æ± ï¼Œ10ä¸ªå¾ªç¯ä¸­åº”è¯¥å‰5ä¸ªåº”è¯¥éƒ½åˆ›å»ºwokerå‘€","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":585588,"discussion_content":"1. æ˜¯çš„ã€‚\n2. åŸå› å°±æ˜¯é—®é¢˜1çš„æè¿°","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661691110,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"è¾½å®","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":354964,"user_name":"éªšåŠ¨","can_delete":false,"product_type":"c1","uid":2280216,"ip_address":"åŒ—äº¬","ucode":"EBEBF417C866D4","user_header":"https://static001.geekbang.org/account/avatar/00/22/cb/18/0139e086.jpg","comment_is_top":false,"comment_ctime":1660917165,"is_pvip":false,"replies":[{"id":129245,"content":"åœ¨çº¿å·¥å…·ï¼Œå¯ä»¥ç”¨processon.comï¼Œç¦»çº¿çš„æˆ‘ä¸€èˆ¬ç”¨draw.ioã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1661217333,"ip_address":"åŒ—äº¬","comment_id":354964,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100093501,"comment_content":"è€å¸ˆï¼Œè¯·æ•™ä¸€ä¸‹ï¼Œè¿™ç§è½¯ä»¶æ¶æ„å›¾æ˜¯ç”¨ä»€ä¹ˆç”»çš„å•Šï¼Ÿå¹³æ—¶è‡ªå·±ä¹Ÿæƒ³ç”»ç”»è‡ªå·±åšçš„ä¸œè¥¿çš„æ¶æ„å›¾ï¼Œä½†æ˜¯æ²¡æ‰¾åˆ°ä»€ä¹ˆåˆé€‚çš„å·¥å…·","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":584906,"discussion_content":"åœ¨çº¿å·¥å…·ï¼Œå¯ä»¥ç”¨processon.comï¼Œç¦»çº¿çš„æˆ‘ä¸€èˆ¬ç”¨draw.ioã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661217333,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":352037,"user_name":"æˆ‘å¥½åƒä¸€ç‚¹éƒ½ä¸åƒç¨‹åºå‘˜","can_delete":false,"product_type":"c1","uid":1435733,"ip_address":"","ucode":"F479190923355C","user_header":"https://static001.geekbang.org/account/avatar/00/15/e8/55/63189817.jpg","comment_is_top":false,"comment_ctime":1658361801,"is_pvip":false,"replies":[{"id":128098,"content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1658401847,"ip_address":"","comment_id":352037,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100093501,"comment_content":"åŠŸèƒ½é€‰é¡¹è¿™ç§å°è£…çš„æ–¹å¼ç¡®å®æ‹“å±•æ€§å¾ˆå¥½ï¼Œå’Œä¼ ç»Ÿçš„å‚æ•°ä¼ å…¥å¹¶è‡ªåŠ¨ç»‘å®šæ¥è¯´ï¼Œä¸éœ€è¦æ›´æ”¹New çš„ä»£ç ï¼Œåªéœ€è¦åœ¨å¤–æ‹“å±•","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":580915,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1658401847,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":351028,"user_name":"Geek_a6104e","can_delete":false,"product_type":"c1","uid":1711967,"ip_address":"","ucode":"29A56792216DC8","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/GJXKh8OG00U5ial64plAIibbIuwkzhPc8uYic9Hibl8SbqvhnS2JImHgCD4JGvTktiaVnCjHQWbA5wicaxRUN5aTEWnQ/132","comment_is_top":false,"comment_ctime":1657463972,"is_pvip":false,"replies":[{"id":127788,"content":"ç¤ºä¾‹åŸæ„å°±æ˜¯è®¾è®¡ä¸€ä¸ªåŒæ­¥æäº¤çš„workerpoolæ± ã€‚å³å¦‚æœScheduleæ–¹æ³•è¿”å›æˆåŠŸï¼Œè¯´æ˜ç”¨æˆ·æäº¤çš„taskè‚¯å®šè¢«æŸä¸ªworkerå¤„ç†äº†ã€‚\n\nå¦‚æœè¦è®¾è®¡ä¸ºå¼‚æ­¥æäº¤è¯­ä¹‰ï¼Œå¯ä»¥ä½¿ç”¨å¸¦ç¼“å†²çš„tasks channelã€‚é‚£æ ·scheduleæ–¹æ³•æäº¤åï¼Œtaskå¯èƒ½ä¸€ç›´åœ¨channelä¸­å­˜ç€ï¼Œç›´åˆ°æœ‰workerå¤„ç†ã€‚ä½†å½“ç¼“å†²åŒºæ»¡äº†ï¼Œè¿˜æ˜¯ä¼šé€€åŒ–ä¸ºåŒæ­¥æäº¤ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1657700552,"ip_address":"","comment_id":351028,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100093501,"comment_content":"è¯·é—®tasksé€šé“ä¸ºä»€ä¹ˆæ˜¯ä¸å¸¦ç¼“å­˜åŒºçš„","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":579818,"discussion_content":"ç¤ºä¾‹åŸæ„å°±æ˜¯è®¾è®¡ä¸€ä¸ªåŒæ­¥æäº¤çš„workerpoolæ± ã€‚å³å¦‚æœScheduleæ–¹æ³•è¿”å›æˆåŠŸï¼Œè¯´æ˜ç”¨æˆ·æäº¤çš„taskè‚¯å®šè¢«æŸä¸ªworkerå¤„ç†äº†ã€‚\n\nå¦‚æœè¦è®¾è®¡ä¸ºå¼‚æ­¥æäº¤è¯­ä¹‰ï¼Œå¯ä»¥ä½¿ç”¨å¸¦ç¼“å†²çš„tasks channelã€‚é‚£æ ·scheduleæ–¹æ³•æäº¤åï¼Œtaskå¯èƒ½ä¸€ç›´åœ¨channelä¸­å­˜ç€ï¼Œç›´åˆ°æœ‰workerå¤„ç†ã€‚ä½†å½“ç¼“å†²åŒºæ»¡äº†ï¼Œè¿˜æ˜¯ä¼šé€€åŒ–ä¸ºåŒæ­¥æäº¤ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1657700553,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":346066,"user_name":"Hugh","can_delete":false,"product_type":"c1","uid":2285931,"ip_address":"","ucode":"77434E01E1D715","user_header":"https://static001.geekbang.org/account/avatar/00/22/e1/6b/74a8b7d8.jpg","comment_is_top":false,"comment_ctime":1652798680,"is_pvip":false,"replies":[{"id":126261,"content":"è¿™æ˜¯ä¸¤ä¸ªå±‚é¢çš„å¤ç”¨ã€‚GMPå¯¹Gæ•°æ®ç»“æ„çš„å¤ç”¨æ˜¯åœ¨runtimeè°ƒåº¦å±‚é¢ï¼Œä½†è¿™ç§å¤ç”¨ ç”¨æˆ·å±‚æ— æ³•æ§åˆ¶ï¼ŒGä¹Ÿä¸æ˜¯æ€»èƒ½è¢«å¤ç”¨ï¼Œå°±åƒsync.Poolä¸­æ•°æ®é¡¹ï¼Œåœ¨ä¸€å®šæ—¶é—´å†…å¦‚æœæ²¡æœ‰goroutineå»ä»æ± ä¸­getï¼Œé‚£ä¹ˆè¿˜æ˜¯ä¼šè¢«é‡Šæ”¾çš„ã€‚\n\nå½“ç„¶ç”¨æˆ·å±‚é¢å®ç°çš„goroutine æ± ä¹Ÿå¯ä»¥å¢åŠ idleé‡Šæ”¾çš„ç‰¹æ€§(è¿™ä¸€è®²ä¸­çš„ä¾‹å­ä¸æ”¯æŒ)ï¼Œä½†è¿™ç§é‡Šæ”¾æ˜¯ç”¨æˆ·å±‚å¯æ§çš„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1652822694,"ip_address":"","comment_id":346066,"utype":1}],"discussion_count":2,"race_medal":0,"score":3,"product_id":100093501,"comment_content":"è€å¸ˆæ‚¨å¥½ï¼Œè¯·æ•™ä¸ªé—®é¢˜ï¼Œä¹‹å‰è¯´è¿‡åœ¨GMPæ¨¡å‹ä¸­æ•°æ®ç»“æ„Gæ˜¯å¯ä»¥è¢«å¤ç”¨çš„ï¼Œé‚£ä¹ˆåç¨‹æ± è¿˜æœ‰å¿…è¦å—ï¼Ÿå› ä¸ºåç¨‹æ± çš„ä¸€å¤§ä¼˜åŠ¿å°±æ˜¯å¤ç”¨åç¨‹ï¼Œé¿å…åå¤åˆ›å»ºåç¨‹ï¼Œé‚£ä¹ˆå…¶å®go schedulerå·²ç»åšåˆ°äº†","like_count":1,"discussions":[{"author":{"id":1435733,"avatar":"https://static001.geekbang.org/account/avatar/00/15/e8/55/63189817.jpg","nickname":"æˆ‘å¥½åƒä¸€ç‚¹éƒ½ä¸åƒç¨‹åºå‘˜","note":"","ucode":"F479190923355C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":580943,"discussion_content":"ç»™ä½ ä¸¾ä¸ªä¾‹å­ï¼Œä¸€ä¸ªæ˜¯å…¬å¸å±‚çº§çš„è°ƒåº¦å¤ç”¨ï¼Œä½ æ— æ³•æ§åˆ¶äººå‘˜æµåŠ¨ï¼Œä¸€ä¸ªæ˜¯ä½ ç»„å†…çš„äººå‘˜è°ƒåº¦å¤ç”¨ï¼Œä½ å¯ä»¥é€‚å½“æ§åˆ¶ï¼Œè¾¾åˆ°å‡å°‘å†…è€—çš„ä½œç”¨","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1658411634,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":572507,"discussion_content":"è¿™æ˜¯ä¸¤ä¸ªå±‚é¢çš„å¤ç”¨ã€‚GMPå¯¹Gæ•°æ®ç»“æ„çš„å¤ç”¨æ˜¯åœ¨runtimeè°ƒåº¦å±‚é¢ï¼Œä½†è¿™ç§å¤ç”¨ ç”¨æˆ·å±‚æ— æ³•æ§åˆ¶ï¼ŒGä¹Ÿä¸æ˜¯æ€»èƒ½è¢«å¤ç”¨ï¼Œå°±åƒsync.Poolä¸­æ•°æ®é¡¹ï¼Œåœ¨ä¸€å®šæ—¶é—´å†…å¦‚æœæ²¡æœ‰goroutineå»ä»æ± ä¸­getï¼Œé‚£ä¹ˆè¿˜æ˜¯ä¼šè¢«é‡Šæ”¾çš„ã€‚\n\nå½“ç„¶ç”¨æˆ·å±‚é¢å®ç°çš„goroutine æ± ä¹Ÿå¯ä»¥å¢åŠ idleé‡Šæ”¾çš„ç‰¹æ€§(è¿™ä¸€è®²ä¸­çš„ä¾‹å­ä¸æ”¯æŒ)ï¼Œä½†è¿™ç§é‡Šæ”¾æ˜¯ç”¨æˆ·å±‚å¯æ§çš„ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1652822694,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":343782,"user_name":"Geek_as","can_delete":false,"product_type":"c1","uid":1534500,"ip_address":"","ucode":"AB7B70DBC2B5F8","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/qhonwcQle1RBufvLdTm4MgSNl554GBXUZtNNH65oYajbbRLxKsZX4hM9vFtrLLpDM0H93ZNWRFAZSrIZC7yAsQ/132","comment_is_top":false,"comment_ctime":1651052596,"is_pvip":false,"replies":[{"id":125588,"content":"demo2ä½¿ç”¨Workpool2ä¸­çš„returnTaskä»£ç å¦‚ä¸‹ï¼š\n\nfunc (p *Pool) returnTask(t Task) {\n    go func() {\n        p.tasks &lt;- t\n    }()\n}\n\nreturnTaskä¸­åˆ›å»ºäº†ä¸€ä¸ªæ–°goroutineæ¥å¼‚æ­¥send taskï¼ŒreturnTaskæ€ä¹ˆä¼šå¡ä½å‘¢ï¼Ÿ","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1651138411,"ip_address":"","comment_id":343782,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100093501,"comment_content":"è€å¸ˆï¼Œæœ€åä¸€ä¸ªä¾‹å­å¥½åƒæœ‰é—®é¢˜ï¼Œå‡å¦‚æˆ‘è®¾ç½®çš„æ˜¯å½“æ²¡æœ‰æ´»åŠ¨go workerçš„æ—¶å€™é˜»å¡ï¼Œç„¶åå½“å‰çº¿ç¨‹ä¸ä¼šé¢„åˆ›å»ºï¼Œè¿™æ—¶å€™æˆ‘å¾€æ± é‡Œé¢æ·»åŠ ä¸€ä¸ªä»»åŠ¡ï¼Œç”±äºæ²¡æœ‰workerå¯ä»¥æ¥æ”¶ï¼Œå¯¼è‡´å®ƒèµ°åˆ°äº†default,ç”±äºæˆ‘æ˜¯è®¾ç½®äº†è·å–ä¸åˆ°å°±é˜»å¡,æ‰€ä»¥æˆ‘çš„ä»£ç èµ°åˆ°äº†\nif p.block{\n\t\t\tp.tasks &lt;- t\n}\nè¿™é‡Œï¼Œè¿™æ—¶å€™runæ–¹æ³•æ£€æµ‹åˆ°taskç®¡é“é‡Œæœ‰taskï¼Œå°±æ¥æ”¶ä¸‹æ¥ï¼Œå‰é¢çš„p.tasks &lt;- té˜»å¡é‡Šæ”¾äº†ï¼Œä¼šç»§ç»­èµ°ä¸‹å»ï¼Œç„¶årunçš„è¯ï¼Œåœ¨æ¥æ”¶äº†ç®¡é“çš„taskåï¼Œæ‰§è¡Œçš„ä¸‹ä¸€æ­¥æ“ä½œæ˜¯returnTask,ç„¶ååˆ›å»ºæ´»åŠ¨workerï¼Œå»æ‰§è¡ŒreturnTaskè¿”å›çš„taskï¼Œä½†å‡ºç°äº†ç¥å¥‡çš„ä¸€å¹•ï¼Œrunçš„æ‰§è¡Œæµç¨‹å¡åœ¨returnTaskçš„p.tasks &lt;- taskä¸­ï¼Œå¯¼è‡´åé¢çš„æ´»åŠ¨workeræ²¡æ³•åˆ›å»ºï¼Œä¸€ç›´å¡åœ¨returnTaské‚£é‡Œï¼Œåé¢æˆ‘åˆ†æäº†ä¸€ä¸‹ï¼Œæ„Ÿè§‰åº”è¯¥æ˜¯æˆ‘çš„tasksæ˜¯æ— ç¼“å†²é˜Ÿåˆ—ï¼Œæ‰€ä»¥returnTaskæ‰§è¡Œp.tasks &lt;- taskçš„æ—¶å€™å°±å¡åœ¨è¿™é‡Œï¼Œç­‰å¾…å…¶ä»–äººçš„æ¥æ”¶ï¼Œä½†è¿™æ ·å°±æœ‰é—®é¢˜äº†ï¼Œå› ä¸ºæ¥æ”¶æ“ä½œè¦ä¹ˆåœ¨runçš„rangeä¸­ï¼Œè¦ä¹ˆæ˜¯ç”±æ´»åŠ¨workeræ¥æ”¶ï¼Œå› ä¸ºå¡åœ¨returnTaskè¿™é‡Œï¼Œæ‰€ä»¥æ²¡æ³•åˆ›å»ºæ´»åŠ¨workerï¼Œä¹Ÿå°±æ²¡workeræ¶ˆè´¹ï¼Œå˜æˆäº†ç±»ä¼¼äºæ­»é”çš„æ ·å­ï¼Œå‡å¦‚æˆ‘é…ç½®äº†é˜»å¡ï¼Œå’Œä¸é¢„åˆ›å»ºï¼Œç†è®ºä¸Šæˆ‘æäº¤ç»™æ± é‡Œé¢çš„æ‰€æœ‰ä»»åŠ¡éƒ½ä¸ä¼šè¢«æ‰§è¡Œï¼Œæˆ‘è¯•äº†ä¸€ä¸‹ï¼Œå½“æäº¤çš„ä»»åŠ¡è¶…è¿‡ä¸¤ä¸ªå°±ä¼šçˆ†æ­»é”å¼‚å¸¸ï¼Œåé¢æˆ‘å°†returnTaskè¿™ä¸€æ­¥åŠ¨ä½œç§»åŠ¨åˆ°äº†åˆ›å»ºworkerä¹‹åï¼Œå°±è§£å†³äº†è¿™ä¸ªé—®é¢˜","like_count":1,"discussions":[{"author":{"id":1435733,"avatar":"https://static001.geekbang.org/account/avatar/00/15/e8/55/63189817.jpg","nickname":"æˆ‘å¥½åƒä¸€ç‚¹éƒ½ä¸åƒç¨‹åºå‘˜","note":"","ucode":"F479190923355C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":580943,"discussion_content":"ç»™ä½ ä¸¾ä¸ªä¾‹å­ï¼Œä¸€ä¸ªæ˜¯å…¬å¸å±‚çº§çš„è°ƒåº¦å¤ç”¨ï¼Œä½ æ— æ³•æ§åˆ¶äººå‘˜æµåŠ¨ï¼Œä¸€ä¸ªæ˜¯ä½ ç»„å†…çš„äººå‘˜è°ƒåº¦å¤ç”¨ï¼Œä½ å¯ä»¥é€‚å½“æ§åˆ¶ï¼Œè¾¾åˆ°å‡å°‘å†…è€—çš„ä½œç”¨","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1658411634,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":572507,"discussion_content":"è¿™æ˜¯ä¸¤ä¸ªå±‚é¢çš„å¤ç”¨ã€‚GMPå¯¹Gæ•°æ®ç»“æ„çš„å¤ç”¨æ˜¯åœ¨runtimeè°ƒåº¦å±‚é¢ï¼Œä½†è¿™ç§å¤ç”¨ ç”¨æˆ·å±‚æ— æ³•æ§åˆ¶ï¼ŒGä¹Ÿä¸æ˜¯æ€»èƒ½è¢«å¤ç”¨ï¼Œå°±åƒsync.Poolä¸­æ•°æ®é¡¹ï¼Œåœ¨ä¸€å®šæ—¶é—´å†…å¦‚æœæ²¡æœ‰goroutineå»ä»æ± ä¸­getï¼Œé‚£ä¹ˆè¿˜æ˜¯ä¼šè¢«é‡Šæ”¾çš„ã€‚\n\nå½“ç„¶ç”¨æˆ·å±‚é¢å®ç°çš„goroutine æ± ä¹Ÿå¯ä»¥å¢åŠ idleé‡Šæ”¾çš„ç‰¹æ€§(è¿™ä¸€è®²ä¸­çš„ä¾‹å­ä¸æ”¯æŒ)ï¼Œä½†è¿™ç§é‡Šæ”¾æ˜¯ç”¨æˆ·å±‚å¯æ§çš„ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1652822694,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":338596,"user_name":"æœ¨æœ¨","can_delete":false,"product_type":"c1","uid":2704565,"ip_address":"","ucode":"86820F26A27308","user_header":"https://static001.geekbang.org/account/avatar/00/29/44/b5/7eba5a0e.jpg","comment_is_top":false,"comment_ctime":1647587716,"is_pvip":false,"replies":[{"id":123854,"content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1647810501,"ip_address":"","comment_id":338596,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100093501,"comment_content":"å­¦åˆ°å¾ˆå¤šï¼æ„Ÿè°¢","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":568445,"discussion_content":"demo2ä½¿ç”¨Workpool2ä¸­çš„returnTaskä»£ç å¦‚ä¸‹ï¼š\n\nfunc (p *Pool) returnTask(t Task) {\n    go func() {\n        p.tasks &lt;- t\n    }()\n}\n\nreturnTaskä¸­åˆ›å»ºäº†ä¸€ä¸ªæ–°goroutineæ¥å¼‚æ­¥send taskï¼ŒreturnTaskæ€ä¹ˆä¼šå¡ä½å‘¢ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1651138411,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":335569,"user_name":"å¿«ä¹çš„è‡­è±†è…","can_delete":false,"product_type":"c1","uid":1115249,"ip_address":"","ucode":"1E0F2B55FF3023","user_header":"https://static001.geekbang.org/account/avatar/00/11/04/71/7e5d7c85.jpg","comment_is_top":false,"comment_ctime":1645590240,"is_pvip":false,"replies":[{"id":122616,"content":"æ˜¯é˜»å¡äº†ã€‚tasksæ˜¯ä¸å¸¦ç¼“å†²çš„channelï¼Œå¦‚æœ5ä¸ªworkeréƒ½åœ¨å¤„ç†taskï¼Œé‚£ä¹ˆæ²¡æœ‰ç©ºé—²çš„workerå»ä»tasksä¸­è¯»å–ï¼Œè¿™æ—¶scheduleæ–°taskä¼šé˜»å¡ã€‚ç›´åˆ°æœ‰ç©ºé—²workerã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1645607500,"ip_address":"","comment_id":335569,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100093501,"comment_content":"è€å¸ˆæ‚¨å¥½ï¼Œæœ‰ä¸ªåœ°æ–¹ä¸æ˜¯å¾ˆç†è§£ï¼Œå¸Œæœ›æ‚¨è§£ç­”ä¸€ä¸‹\n\nä»¥ç¬¬ä¸€ç‰ˆçš„WorkPoolä¸ºä¾‹\næˆ‘å°è¯•åœ¨Scheduleå‡½æ•°è¿½åŠ äº†printå‡½æ•°ï¼Œ\nfmt.Printf(&quot;%s: Scheduling task\\n&quot;, time.Now())\nå‘ç°æ‰€æœ‰çš„Taskå¹¶ä¸æ˜¯ä¸€æ¬¡æ€§åŠ å…¥åˆ°poolçš„\nå½“poolçš„capacity=5æ—¶ï¼Œä¼šå…ˆåŠ å…¥6ä¸ªtaskç„¶åç­‰æœ‰taskç»“æŸåå†Scheduleå‰©ä½™çš„taskï¼Œè¯·é—®è¿™æ˜¯è¢«é˜»å¡äº†å—ï¼Ÿç†è®ºä¸Šp.activeæ‰æœ‰capacityé™åˆ¶ï¼Œp.tasksåº”è¯¥æ˜¯ä¸€æ¬¡æ€§å†™å…¥çš„\n\n\n","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":557431,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1647810501,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":333857,"user_name":"Witt","can_delete":false,"product_type":"c1","uid":1005864,"ip_address":"","ucode":"19C8BCA266130A","user_header":"https://static001.geekbang.org/account/avatar/00/0f/59/28/943709cb.jpg","comment_is_top":false,"comment_ctime":1644564434,"is_pvip":false,"replies":[{"id":122063,"content":"é¦–å…ˆè¿™ä»…æ˜¯ä¸€ä¸ªdemoã€‚goroutineæ± æœ‰å¾ˆå¤šç§å®ç°æ–¹å¼ï¼Œç”šè‡³åŸºäºåŒä¸€ç§æ–¹å¼ï¼Œæ¯”å¦‚æ–‡ä¸­çš„channelä¹Ÿæœ‰ä¸åŒçš„ç­–ç•¥è®¾å®šã€‚ä¹Ÿè®¸æ–‡ä¸­çš„demoè®¾å®šçš„å½“p.tasksé˜»å¡å°±è¿”å›é”™è¯¯ï¼ˆå½“p.block=falseæ—¶ï¼‰æœ‰äº›ä¸åˆç†ã€‚\n\n&quot;è®©è°ƒåº¦æ—¶ä¸é˜»å¡ï¼Œæ˜¯ä¸æ˜¯æŠŠ task æ”¾åˆ°ä¸€ä¸ªé˜Ÿåˆ—é‡Œæ’é˜Ÿæ›´åˆç†ï¼Œå†åŠ ä¸Šä¸€ä¸ªä¸¢å¼ƒç­–ç•¥ï¼Œç±»ä¼¼ Java ä¸­çš„çº¿ç¨‹æ± &quot; -- å¾ˆå¥½çš„æè®®ã€‚è¿™ä¹Ÿæ˜¯ä¸€ç§è®¾è®¡è¿‡ç¨‹çš„è®¾å®šï¼Œåœ¨æˆ‘çš„demoçš„åŸºç¡€ä¸Šï¼Œç¨ä½œä¿®æ”¹åº”è¯¥å°±èƒ½å®ç°ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1644762667,"ip_address":"","comment_id":333857,"utype":1}],"discussion_count":2,"race_medal":0,"score":3,"product_id":100093501,"comment_content":"è€å¸ˆï¼Œæ—¢ç„¶æ²¡æœ‰è¾¾åˆ°æœ€å¤§ worker æ•°ï¼Œä¸ºä»€ä¹ˆä¸æ˜¯å»åˆ›å»ºæ–°çš„ worker è€Œæ˜¯ç›´æ¥è¿”å›é”™è¯¯å‘¢ï¼Ÿè¿™ä¸€ç‚¹ä¸æ˜¯å¾ˆç†è§£ï¼Œä¸åº”è¯¥æ˜¯æ ¹æ® task è‡ªåŠ¨åˆ›å»ºé¢„æœŸå†…çš„ worker ç›´åˆ° worker æ•°æ»¡äº†å†è¿”å›æ²¡æœ‰ç©ºé—²çš„ worker é”™è¯¯å—\n\nå†ä¸€ä¸ªå°±æ˜¯ï¼Œè®©è°ƒåº¦æ—¶ä¸é˜»å¡ï¼Œæ˜¯ä¸æ˜¯æŠŠ task æ”¾åˆ°ä¸€ä¸ªé˜Ÿåˆ—é‡Œæ’é˜Ÿæ›´åˆç†ï¼Œå†åŠ ä¸Šä¸€ä¸ªä¸¢å¼ƒç­–ç•¥ï¼Œç±»ä¼¼ Java ä¸­çš„çº¿ç¨‹æ± ","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":552836,"discussion_content":"æ˜¯é˜»å¡äº†ã€‚tasksæ˜¯ä¸å¸¦ç¼“å†²çš„channelï¼Œå¦‚æœ5ä¸ªworkeréƒ½åœ¨å¤„ç†taskï¼Œé‚£ä¹ˆæ²¡æœ‰ç©ºé—²çš„workerå»ä»tasksä¸­è¯»å–ï¼Œè¿™æ—¶scheduleæ–°taskä¼šé˜»å¡ã€‚ç›´åˆ°æœ‰ç©ºé—²workerã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1645607500,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":333231,"user_name":"ä¸è´Ÿé’æ˜¥ä¸è´Ÿå·±ğŸ¤˜","can_delete":false,"product_type":"c1","uid":1363671,"ip_address":"","ucode":"A6DD8E8B20EA6E","user_header":"https://static001.geekbang.org/account/avatar/00/14/ce/d7/5315f6ce.jpg","comment_is_top":false,"comment_ctime":1644223329,"is_pvip":false,"replies":[{"id":121816,"content":"å¦‚æœæ—¥å¸¸ä»…æ˜¯å¼€å‘ä¸€äº›cliæˆ–webï¼Œé‚£ä¹ˆgoæ ‡å‡†åº“å°±èƒ½æ»¡è¶³ï¼Œæ²¡å¿…è¦å¼„é‚£ä¹ˆå¤šç¬¬ä¸‰æ–¹çš„æ¡†æ¶ã€‚å…³äºèµ„æ–™ï¼Œä¸“æ ä¸­çš„ä¸€ç¯‡åŠ é¤ä¸­æåˆ°ä¸€äº›ï¼Œhttps:&#47;&#47;time.geekbang.org&#47;column&#47;article&#47;468213 ä¸çŸ¥é“æ˜¯å¦æ»¡è¶³ä½ çš„éœ€æ±‚ã€‚ ","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1644298249,"ip_address":"","comment_id":333231,"utype":1}],"discussion_count":3,"race_medal":0,"score":4,"product_id":100093501,"comment_content":"æƒ³é—®ä¸€ä¸‹,æˆ‘æ˜¯DBA,å¹³å¸¸å¼€å‘åå°è£…æˆ–è€…å†™å·¥å…·ï¼Œé‚£æ˜¯ä¸æ˜¯è¦å¤šçœ‹ä¸€ä¸‹CLIæˆ–è€…web çš„é¡¹ç›®ï¼Œç›®å‰æ˜¯Pythonåšç›¸å…³çš„å·¥å…·ï¼Œç›¸å¯¹æˆ‘æ¥è¯´ï¼ŒGoçš„ä¼˜åŠ¿å°±æ˜¯ä¸è¦è€ƒè™‘Pythonåº“ä¾èµ–çš„é—®é¢˜ï¼Œè¿˜æœ‰å°±æ˜¯å¥½å¤šå¼€æºå·¥å…·éƒ½è¯´Goå†™çš„,å‡ºäº†é—®é¢˜å¯ä»¥çœ‹æºä»£ç ï¼Œè€å¸ˆæœ‰æ¨èè¿›é˜¶çš„æ–¹å¼ä¹¦ç±æˆ–è€…å…¶ä»–ç›¸å…³çš„ï¼Œç½‘ä¸Šä¸€èˆ¬éƒ½æ˜¯åä¸šåŠ¡æ–¹é¢çš„ï¼Œè·Ÿå·¥ä½œä¸ç›¸å…³","like_count":1},{"had_liked":false,"id":332003,"user_name":"lesserror","can_delete":false,"product_type":"c1","uid":1351076,"ip_address":"","ucode":"25A54D1165FCF6","user_header":"https://static001.geekbang.org/account/avatar/00/14/9d/a4/e481ae48.jpg","comment_is_top":false,"comment_ctime":1642955484,"is_pvip":false,"replies":[{"id":121612,"content":"1. å¹¶ä¸æ˜¯ç­‰åˆ°main goroutineé€€å‡ºæ‰é€€å‡ºã€‚å½“Worker poolæ»¡å‘˜æ—¶ï¼Œè¿™é‡Œä¼šèµ°åˆ°defaultåˆ†æ”¯ï¼Œè·³å‡ºè¯¥loopï¼Œè¿›å…¥åˆ°ä¸‹é¢é‚£ä¸ªforå¾ªç¯ï¼Œåé¢çš„forå¾ªç¯æ‰æ˜¯çœŸæ­£ç»´æŠ¤è¿™ä¸ªpoolçš„ä¸»å¾ªç¯ã€‚\n2. è¿™ç¯‡å†™çš„çš„ç¡®æœ‰äº›ä»“ä¿ƒã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1643541735,"ip_address":"","comment_id":332003,"utype":1}],"discussion_count":1,"race_medal":0,"score":4,"product_id":100093501,"comment_content":"å¤§ç™½è€å¸ˆï¼Œè°¢è°¢ä½ è¿™ä¸€ç« èŠ‚ç²¾å½©çš„å†…å®¹ã€‚æœ‰ä»¥ä¸‹å›°æƒ‘ï¼Œéº»çƒ¦æŠ½ç©ºè§£å¿§ã€‚\n\n1.. ç¬¬äºŒç‰ˆçš„Goroutineæ± çš„å®ç°ä¸­ï¼Œæœ€åçš„æµ‹è¯•è¿è¡Œè¾“å‡ºç¯èŠ‚ä¸­ï¼Œè¿è¡Œåˆ° runæ–¹æ³• è¿™ä¸ªGoroutineä¸­æ—¶ï¼Œ!p.preAlloc ä¸ºtrueï¼Œforæ— é™å¾ªç¯å…¶å®ä¸€ç›´åœ¨è¿è¡Œ è¿™ä¸ª case p.active &lt;- struct{}{}:ã€‚æœ€åæ˜¯å› ä¸ºä¸»main Goroutineé€€å‡ºäº†ï¼Œè¿è¡Œè¿™ä¸ª æ— é™forå¾ªç¯çš„ Goroutineä¹Ÿè·Ÿç€é€€å‡ºäº†ï¼Œæ‰€ä»¥è¿™ä¸ªæ— é™forå¾ªç¯ä¹Ÿé€€å‡ºäº†ï¼Œå¯ä»¥è¿™ä¹ˆç†è§£å—ï¼Ÿ\n\n2. Goroutineçš„è¿è¡Œä¸ç¡®å®šæ€§ï¼Œåœ¨å¹¶å‘ç¨‹åºä¸­çš„ç†è§£å¿ƒæ™ºè´Ÿæ‹…å¾ˆå¤§å‘€ï¼Œç¨å¾®å¤æ‚çš„ç¨‹åºï¼Œä¼šå¾ˆä¸å®¹æ˜“ç†è§£ç¨‹åºçš„è¿è¡ŒåŸç†ã€‚è€å¸ˆè¿™ä¸ªè¯¾ç¨‹ï¼Œå¯¹äº Goroutine åœ¨ç¨å¾®å¤æ‚çš„ç¼–å‘ç¨‹åºä¸­æ˜¯å¦‚ä½•è¿è¡Œçš„ï¼Œå¥½åƒæ²¡æœ‰è¿‡å¤šçš„è§£é‡Šï¼Œå¾ˆå®¹æ˜“è®©æ–°æ‰‹ä¸çŸ¥æ‰€ä»¥ç„¶ã€‚è‡³å°‘ï¼Œæœ€åè¿™ä¸ªç‰ˆæœ¬çš„ Goroutine æ± çš„ä¸­ï¼Œæœ€åçš„æµ‹è¯•è¿è¡Œè¾“å‡ºåº”è¯¥è§£é‡Šä¸€ä¸‹ï¼Œè¾“å‡ºä¸ºä½•æ˜¯è¿™æ ·çš„ã€‚å¦‚æœä¸è¿è¡Œï¼Œè¦èƒ½æƒ³åˆ°ç¨‹åºçš„è¾“å‡ºç»“æœï¼Œæˆ‘è§‰å¾—è¿™æ‰å«å®Œå…¨ç†è§£äº†ã€‚æˆ‘è§‰å¾—æˆ‘ç°åœ¨ç›®å‰å¾ˆéš¾åšåˆ°ã€‚\n\nPSï¼šreturnTask é‚£é‡Œçš„é€»è¾‘èƒ½è¡¥å……è¯´æ˜å°±å¥½äº†ï¼Œåˆšçœ‹åˆ°é‚£é‡Œä¹Ÿæ˜¯æœ‰ç‚¹æ‡µï¼ˆçœ‹äº†è¯„è®ºæ‰ç†è§£ï¼‰ã€‚","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":549928,"discussion_content":"å¦‚æœæ—¥å¸¸ä»…æ˜¯å¼€å‘ä¸€äº›cliæˆ–webï¼Œé‚£ä¹ˆgoæ ‡å‡†åº“å°±èƒ½æ»¡è¶³ï¼Œæ²¡å¿…è¦å¼„é‚£ä¹ˆå¤šç¬¬ä¸‰æ–¹çš„æ¡†æ¶ã€‚å…³äºèµ„æ–™ï¼Œä¸“æ ä¸­çš„ä¸€ç¯‡åŠ é¤ä¸­æåˆ°ä¸€äº›ï¼Œhttps://time.geekbang.org/column/article/468213 ä¸çŸ¥é“æ˜¯å¦æ»¡è¶³ä½ çš„éœ€æ±‚ã€‚ ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644298250,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1363671,"avatar":"https://static001.geekbang.org/account/avatar/00/14/ce/d7/5315f6ce.jpg","nickname":"ä¸è´Ÿé’æ˜¥ä¸è´Ÿå·±ğŸ¤˜","note":"","ucode":"A6DD8E8B20EA6E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":550005,"discussion_content":"æ—¥å¸¸èƒ½å¤Ÿæ¥è§¦åˆ°ä¸‰ä¸ªé¡¹ç›®ï¼Œä¸€ä¸ªgoå†™æ•°æ®åº“ha(ä»£ç èµ°è¯»è¿‡ï¼Œè·Ÿæ—¥å¸¸ç›¸å…³æœ€å¤§),ä¸€ä¸ªæ˜¯goå†™çš„åˆ†å¸ƒå¼æ•°æ®åº“ï¼Œè¿˜æœ‰ç°åœ¨åšæ•°æ®åº“å®¹å™¨åŒ–ï¼Œæoperatorçš„ï¼Œå“ªä¸ªæ¯”è¾ƒæ¨è","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1644327266,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":549928,"ip_address":"","group_id":0},"score":550005,"extra":""}]},{"author":{"id":1079702,"avatar":"https://static001.geekbang.org/account/avatar/00/10/79/96/fb0d8a65.jpg","nickname":"æäº®","note":"","ucode":"E26284C3BF7DF1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":592454,"discussion_content":"Powerful command-line tools with Go\nGo for DevOps","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1667412477,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å››å·","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":331203,"user_name":"ç½—æ°","can_delete":false,"product_type":"c1","uid":1320487,"ip_address":"","ucode":"96BAFAA147341F","user_header":"https://static001.geekbang.org/account/avatar/00/14/26/27/eba94899.jpg","comment_is_top":false,"comment_ctime":1642483839,"is_pvip":false,"replies":[{"id":121005,"content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1642488442,"ip_address":"","comment_id":331203,"utype":1}],"discussion_count":1,"race_medal":0,"score":4,"product_id":100093501,"comment_content":"å®æˆ˜é¡¹ç›®æ£’æ£’å“’","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546990,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642488442,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":331093,"user_name":"ã‚éª‘ç€å°è½¦å»å…œé£ã€‚","can_delete":false,"product_type":"c1","uid":2600957,"ip_address":"","ucode":"35F9E5360DF42C","user_header":"https://static001.geekbang.org/account/avatar/00/27/af/fd/a1708649.jpg","comment_is_top":false,"comment_ctime":1642418928,"is_pvip":false,"replies":[{"id":121592,"content":"ä¸çŸ¥é“ åœ¨æœ€åå®æˆ˜ç¯‡çš„ä¸‰èŠ‚è¯¾ æ˜¯å¦èƒ½åˆæ­¥å›ç­”ä½ çš„é—®é¢˜ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1643525140,"ip_address":"","comment_id":331093,"utype":1}],"discussion_count":1,"race_medal":0,"score":4,"product_id":100093501,"comment_content":"çœ‹äº†è¿™ä¹ˆé•¿æ—¶é—´çš„ä¸“æ ï¼Œæ„Ÿè§‰å—ç›ŠåŒªæµ…ã€‚ä¹‹å‰è™½ç„¶ç”¨è¿‡goä½†æ˜¯ä¸€ç›´æ²¡æœ‰ç³»ç»Ÿçš„å­¦ä¹ è¿‡ï¼Œåœ¨å¼€å‘è¿‡ç¨‹ä¸­ä¹Ÿé‡åˆ°äº†è®¸å¤šå‘ã€‚è¿™æ®µæ—¶é—´åˆ·äº†ä¸¤æ¬¡å‡½æ•°æ–¹æ³•å’Œæ¥å£æ¯æ¬¡éƒ½èƒ½å‘æ˜åˆ°æ–°çš„çŸ¥è¯†ç‚¹ï¼Œæ„Ÿè§‰å¯¹goæœ‰äº†å…¨æ–°çš„è®¤è¯†ã€‚å¯¹äºä»Šå¤©è¿™ä¸ªå°é¡¹ç›®å®Œå…¨å¯ä»¥çœ‹çš„æ˜ç™½ï¼Œä½†æ˜¯å¦‚æœè¯´ç°åœ¨è®©æˆ‘å®ç°ä¸€ä¸ªç±»ä¼¼çš„åç¨‹æ± ï¼Œå°±æ„Ÿè§‰è‡ªå·±æ²¡æœ‰è¿™ç§æ€æƒ³å¤´ç»ªä¸çŸ¥é“ä»å“ªä¸‹æ‰‹è§£å†³ã€‚æˆ‘æƒ³é—®è€å¸ˆçš„æ˜¯ï¼šæ€ä¹ˆèƒ½å¤Ÿå°†è‡ªå·±æ‰€å­¦çš„çŸ¥è¯†å’Œå®é™…çš„é—®é¢˜åœºæ™¯ç»“åˆèµ·æ¥å»è§£å†³å®é™…é—®é¢˜ï¼Œæœ‰å“ªäº›å»ºè®®å‘¢ï¼Œè¿˜éœ€è¦åŸ¹å…»å“ªäº›æŠ€èƒ½ï¼Ÿ  æ„Ÿè°¢è€å¸ˆ","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546990,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642488442,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":331034,"user_name":"åœ¨ä¸‹å®é¾™ã€","can_delete":false,"product_type":"c1","uid":1618030,"ip_address":"","ucode":"0735B64EB61CAC","user_header":"https://static001.geekbang.org/account/avatar/00/18/b0/6e/921cb700.jpg","comment_is_top":false,"comment_ctime":1642389149,"is_pvip":false,"replies":[{"id":120905,"content":"sleepçš„2så¹¶æ²¡æœ‰åˆ›å»ºworkerå•Šã€‚è¿™é‡ŒæŒ‡å®šçš„WithPreAllocWorkers(false)ï¼Œå³ä¸é¢„åˆ›å»ºã€‚runé˜»å¡åœ¨å¯¹tasks channelçš„è¯»å–ä¸Šï¼Œç›´åˆ°åé¢main goroutineç¬¬ä¸€æ¬¡è°ƒç”¨Scheduleå†™å…¥ä¸€ä¸ªtaskï¼Œè¿™æ—¶runæ‰ä¼šå¼€å§‹æŒ‰éœ€åˆ›å»ºWorkerã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1642412036,"ip_address":"","comment_id":331034,"utype":1}],"discussion_count":5,"race_medal":0,"score":4,"product_id":100093501,"comment_content":"æœ€åä¸€ä¸ªä¾‹å­ï¼Œp := workerpool.New(5, workerpool.WithPreAllocWorkers(false),workerpool.WithBlock(false))    \ntime.Sleep(time.Second * 2)\néƒ½ç»™äº†ä¸¤ç§’åˆ›å»ºworker éƒ½æ²¡åˆ›å»ºå¥½worker å—ï¼Ÿï¼ŒæŒ‰ç…§ä»£ç çš„æ„æ€ï¼Œå³ä½¿ä¸å…è®¸é¢„å…ˆåˆ†é…workerï¼Œä½œè€…runé‡Œé¢ï¼Œç»§ç»­åˆ†é…worker äº†å•Šï¼Œå¹¶ä¸”ä¸€å¼€å§‹æ²¡æœ‰taskï¼Œç›´æ¥å°±èµ°default break loopäº†ï¼Œæ„Ÿè§‰æ˜¯ä¸æ˜¯å¤šæ­¤ä¸€ä¸¾äº†è¿™é‡Œå†™çš„ï¼Œbreak loopä¹‹åï¼Œå°±å¼€å§‹æ ¹æ®active åˆ›å»ºworkerï¼Œè®¾ç½®æ˜¯ 5ï¼Œé‚£ä¸¤ç§’è‚¯å®šåˆ›å»º5ä¸ªworkerï¼Œæ‰€ä»¥ä¸æ‡‚ä¸ºç”šä¹ˆè¯´wokerä¸å¤Ÿã€‚ æ˜¯ä¸æ˜¯ p.returnTask(t) è¿™ä¸ªç¼˜æ•…","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":549035,"discussion_content":"ä¸çŸ¥é“ åœ¨æœ€åå®æˆ˜ç¯‡çš„ä¸‰èŠ‚è¯¾ æ˜¯å¦èƒ½åˆæ­¥å›ç­”ä½ çš„é—®é¢˜ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1643525140,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":331019,"user_name":"æ— åæ— å§“","can_delete":false,"product_type":"c1","uid":2621412,"ip_address":"","ucode":"487BD5AA2CD305","user_header":"https://static001.geekbang.org/account/avatar/00/27/ff/e4/927547a9.jpg","comment_is_top":false,"comment_ctime":1642382389,"is_pvip":false,"replies":[{"id":120906,"content":"å¯ä»¥æŠŠé—®é¢˜æçš„å…·ä½“ä¸€ç‚¹ğŸ˜ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1642412062,"ip_address":"","comment_id":331019,"utype":1}],"discussion_count":1,"race_medal":0,"score":4,"product_id":100093501,"comment_content":"è¿˜æ˜¯æœ‰äº›ä¸ç†è§£","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546743,"discussion_content":"å¯ä»¥æŠŠé—®é¢˜æçš„å…·ä½“ä¸€ç‚¹ğŸ˜ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642412063,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":390461,"user_name":"Geek_b745bf","can_delete":false,"product_type":"c1","uid":2104889,"ip_address":"æ¹–åŒ—","ucode":"6EB395F6AE0C15","user_header":"","comment_is_top":false,"comment_ctime":1715399231,"is_pvip":false,"replies":[{"id":142036,"content":"ä¸“æ ä¸­çš„ä»£ç æ›´å¤šæ˜¯ä¸ºäº†è®²è§£çŸ¥è¯†ç‚¹ç›®çš„ä½¿ç”¨ï¼Œä¸å»ºè®®åœ¨ç”Ÿäº§ä¸­ä½¿ç”¨ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1715418642,"ip_address":"åŒ—äº¬","comment_id":390461,"utype":1}],"discussion_count":1,"race_medal":0,"score":4,"product_id":100093501,"comment_content":"è€å¸ˆï¼Œå‡å¦‚æ˜¯è¿ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒï¼Œä»¥è¿™ä¸ªç¤ºä¾‹æ¥çœ‹å¤§æ¦‚è¿˜éœ€è¦è¡¥å……ä¸€äº›ä»€ä¹ˆå‘¢","like_count":0,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":644674,"discussion_content":"ä¸“æ ä¸­çš„ä»£ç æ›´å¤šæ˜¯ä¸ºäº†è®²è§£çŸ¥è¯†ç‚¹ç›®çš„ä½¿ç”¨ï¼Œä¸å»ºè®®åœ¨ç”Ÿäº§ä¸­ä½¿ç”¨ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1715418642,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":383663,"user_name":"çˆ±åƒèƒ¡èåœ","can_delete":false,"product_type":"c1","uid":1459413,"ip_address":"å¹¿ä¸œ","ucode":"35FCF84D1E04C5","user_header":"https://static001.geekbang.org/account/avatar/00/16/44/d5/ca522e83.jpg","comment_is_top":false,"comment_ctime":1699423974,"is_pvip":false,"replies":[{"id":139930,"content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1699481986,"ip_address":"è¾½å®","comment_id":383663,"utype":1}],"discussion_count":1,"race_medal":0,"score":4,"product_id":100093501,"comment_content":"å¯¹äºdemo2ä¸ªäºº è®¤ä¸ºå†™çš„ä¸å¥½ï¼Œä¸€ä¸‹æ˜¯æˆ‘çš„ä¸ªäººæµ…è§\n\n```go\n&#47;&#47; New å‡½æ•°ä»£ç ç‰‡æ®µ\nif p.preAlloc {\n     &#47;&#47; create all goroutines and send into works channel \n     for i := 0; i &lt; p.capacity; i++ { \n        p.newWorker(i + 1) p.active &lt;- struct{}{}\n        } \n    }\n```\n\n```go\n&#47;&#47; runå‡½æ•°ä»£ç ç‰‡æ®µ\nfor { \n    select { \n        case &lt;-p.quit: return \n        case p.active &lt;- struct{}{}: \n        &#47;&#47; create a new worker \n            idx++ \n            p.newWorker(idx) \n        } \n    }\n```\n\nè¿™ä¸¤ä¸ªä»£ç ç‰‡æ®µæ˜¯ç­‰æ•ˆçš„ï¼Œ é¦–å…ˆåœ¨newå‡½æ•°é‡Œ &lt;-p.quit è¿™ä¸ªå€¼æ˜¯ä¸å¯èƒ½è§¦å‘çš„ï¼Œå³demo1äº‹å®ä¸Šå°±æ˜¯å®ç°çš„preAllocç­–ç•¥ï¼Œ\næˆ‘ä»¬åº”è¯¥åªéœ€è¦æ·»åŠ ï¼PreAllocç­–ç•¥å³å¯","like_count":0,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":631388,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1699481986,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"è¾½å®","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":380524,"user_name":"phylony-lu","can_delete":false,"product_type":"c1","uid":1342724,"ip_address":"ä¸Šæµ·","ucode":"00666300AD0E7F","user_header":"https://static001.geekbang.org/account/avatar/00/14/7d/04/d606b6a8.jpg","comment_is_top":false,"comment_ctime":1693757832,"is_pvip":false,"replies":[{"id":138580,"content":"è°ƒç”¨returnTaskï¼Œä¸»è¦æ˜¯å› ä¸ºæ˜¯åœ¨p.preAlloc=falseçš„æƒ…å†µä¸‹ï¼Œä¹Ÿå°±æ˜¯ä¸é¢„å…ˆåˆ›å»ºworker poolçš„æƒ…å†µä¸‹ã€‚å½“ScheduleTaskåï¼Œç”±taskæ¥é©±åŠ¨workerçš„åˆ›å»ºï¼Œä½†taskå·²ç»è¢«è¯»å–äº†å‡ºæ¥ï¼Œè¯¥taskåº”è¯¥é‡æ–°æ”¾å›channelï¼Œç”±workerå–å‡ºå¹¶æ‰§è¡Œã€‚å—¯ï¼Œè¿™é‡Œçš„ç¡®ä¸å¤Ÿä¼˜é›…ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1693814560,"ip_address":"åŒ—äº¬","comment_id":380524,"utype":1}],"discussion_count":1,"race_medal":0,"score":4,"product_id":100093501,"comment_content":"è€å¸ˆï¼Œæˆ‘è¿˜æ˜¯æœ‰äº›ä¸æ˜¯å¾ˆæ˜ç™½ï¼Œä¸ºä»€ä¹ˆè¦åœ¨runå‡½æ•°é‡Œæ‰§è¡Œfor t := range p.tasksï¼Œtasksæ˜¯æ— ç¼“å­˜å¾—channelï¼Œé»˜è®¤æ²¡æœ‰æ¨é€å°±æ˜¯ä¼šé˜»å¡ï¼Œæœ‰æ¨é€å°±æ˜¯ä¼šè¿›å…¥å¾ªç¯ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦è°ƒç”¨returnTaskå†æ¨é€ä¸€æ¬¡æ¶ˆæ¯ç»™taskså¾—channelå‘¢ï¼Ÿè¿™æ ·åšæ˜¯ä¸æ˜¯è¦ç­‰åˆ°è¯¥taskè¢«æ¶ˆè´¹æ‰ä¼šå…è®¸å†æ¬¡æ¨é€å€¼è¿›æ¥ï¼Ÿ\t\t\t\nfmt.Println(&quot;Add:&quot;, idx, t)\n&#47;&#47;p.returnTask(t)\nåœ¨newworkderå¾—å‡½æ•°é‡Œselectä¹Ÿä¸€ç›´åœ¨ç›‘å¬&lt;-p.taskï¼Œæœ‰æ›´æ–°å°±ä¼šè°ƒç”¨ã€‚é‚£ç†è®ºä¸Šæ¥è¯´ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥å°†runå¾—ä»£ç ç²¾ç®€ä¸ºå»æ‰loopçš„å‰©ä½™éƒ¨åˆ†ã€‚å› ä¸ºp.acitveçš„channelå †æ»¡åä¹Ÿå°±æ˜¯ä¸ä¼šå†è°ƒç”¨goroutineäº†ã€‚ä¸çŸ¥é“è¿™æ ·ç†è§£å¯¹ä¸å¯¹ï¼Œè¯·è€å¸ˆå¸®å¿™è§£ç­”ç–‘æƒ‘ï¼Œæ„Ÿè°¢ã€‚\n","like_count":0,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":627114,"discussion_content":"è°ƒç”¨returnTaskï¼Œä¸»è¦æ˜¯å› ä¸ºæ˜¯åœ¨p.preAlloc=falseçš„æƒ…å†µä¸‹ï¼Œä¹Ÿå°±æ˜¯ä¸é¢„å…ˆåˆ›å»ºworker poolçš„æƒ…å†µä¸‹ã€‚å½“ScheduleTaskåï¼Œç”±taskæ¥é©±åŠ¨workerçš„åˆ›å»ºï¼Œä½†taskå·²ç»è¢«è¯»å–äº†å‡ºæ¥ï¼Œè¯¥taskåº”è¯¥é‡æ–°æ”¾å›channelï¼Œç”±workerå–å‡ºå¹¶æ‰§è¡Œã€‚å—¯ï¼Œè¿™é‡Œçš„ç¡®ä¸å¤Ÿä¼˜é›…ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1693814561,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":347732,"user_name":"Aeins","can_delete":false,"product_type":"c1","uid":1045910,"ip_address":"","ucode":"D5BF220767541D","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f5/96/0cf9f3c7.jpg","comment_is_top":false,"comment_ctime":1654358903,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100093501,"comment_content":"1. demo01 çš„å®ç°ï¼Œå·²ç»æ˜¯ä¸€ç§é¢„åˆ†é…çš„å®ç°ï¼Œdemo02 åœ¨ New é‡Œé¢ å»é¢„åˆ†é…ï¼Œæ²¡æœ‰å¿…è¦\n\n2.  demo02 ï¼Œtask å–å‡ºæ¥ï¼Œå†æ”¾å›å»ï¼Œæ€»æ„Ÿè§‰ä¸ä¼˜é›…ã€‚\n","like_count":3,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":627114,"discussion_content":"è°ƒç”¨returnTaskï¼Œä¸»è¦æ˜¯å› ä¸ºæ˜¯åœ¨p.preAlloc=falseçš„æƒ…å†µä¸‹ï¼Œä¹Ÿå°±æ˜¯ä¸é¢„å…ˆåˆ›å»ºworker poolçš„æƒ…å†µä¸‹ã€‚å½“ScheduleTaskåï¼Œç”±taskæ¥é©±åŠ¨workerçš„åˆ›å»ºï¼Œä½†taskå·²ç»è¢«è¯»å–äº†å‡ºæ¥ï¼Œè¯¥taskåº”è¯¥é‡æ–°æ”¾å›channelï¼Œç”±workerå–å‡ºå¹¶æ‰§è¡Œã€‚å—¯ï¼Œè¿™é‡Œçš„ç¡®ä¸å¤Ÿä¼˜é›…ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1693814561,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":333231,"user_name":"ä¸è´Ÿé’æ˜¥ä¸è´Ÿå·±ğŸ¤˜","can_delete":false,"product_type":"c1","uid":1363671,"ip_address":"","ucode":"A6DD8E8B20EA6E","user_header":"https://static001.geekbang.org/account/avatar/00/14/ce/d7/5315f6ce.jpg","comment_is_top":false,"comment_ctime":1644223329,"is_pvip":false,"replies":[{"id":121816,"content":"å¦‚æœæ—¥å¸¸ä»…æ˜¯å¼€å‘ä¸€äº›cliæˆ–webï¼Œé‚£ä¹ˆgoæ ‡å‡†åº“å°±èƒ½æ»¡è¶³ï¼Œæ²¡å¿…è¦å¼„é‚£ä¹ˆå¤šç¬¬ä¸‰æ–¹çš„æ¡†æ¶ã€‚å…³äºèµ„æ–™ï¼Œä¸“æ ä¸­çš„ä¸€ç¯‡åŠ é¤ä¸­æåˆ°ä¸€äº›ï¼Œhttps:&#47;&#47;time.geekbang.org&#47;column&#47;article&#47;468213 ä¸çŸ¥é“æ˜¯å¦æ»¡è¶³ä½ çš„éœ€æ±‚ã€‚ ","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1644298249,"ip_address":"","comment_id":333231,"utype":1}],"discussion_count":3,"race_medal":0,"score":4,"product_id":100093501,"comment_content":"æƒ³é—®ä¸€ä¸‹,æˆ‘æ˜¯DBA,å¹³å¸¸å¼€å‘åå°è£…æˆ–è€…å†™å·¥å…·ï¼Œé‚£æ˜¯ä¸æ˜¯è¦å¤šçœ‹ä¸€ä¸‹CLIæˆ–è€…web çš„é¡¹ç›®ï¼Œç›®å‰æ˜¯Pythonåšç›¸å…³çš„å·¥å…·ï¼Œç›¸å¯¹æˆ‘æ¥è¯´ï¼ŒGoçš„ä¼˜åŠ¿å°±æ˜¯ä¸è¦è€ƒè™‘Pythonåº“ä¾èµ–çš„é—®é¢˜ï¼Œè¿˜æœ‰å°±æ˜¯å¥½å¤šå¼€æºå·¥å…·éƒ½è¯´Goå†™çš„,å‡ºäº†é—®é¢˜å¯ä»¥çœ‹æºä»£ç ï¼Œè€å¸ˆæœ‰æ¨èè¿›é˜¶çš„æ–¹å¼ä¹¦ç±æˆ–è€…å…¶ä»–ç›¸å…³çš„ï¼Œç½‘ä¸Šä¸€èˆ¬éƒ½æ˜¯åä¸šåŠ¡æ–¹é¢çš„ï¼Œè·Ÿå·¥ä½œä¸ç›¸å…³","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":549928,"discussion_content":"å¦‚æœæ—¥å¸¸ä»…æ˜¯å¼€å‘ä¸€äº›cliæˆ–webï¼Œé‚£ä¹ˆgoæ ‡å‡†åº“å°±èƒ½æ»¡è¶³ï¼Œæ²¡å¿…è¦å¼„é‚£ä¹ˆå¤šç¬¬ä¸‰æ–¹çš„æ¡†æ¶ã€‚å…³äºèµ„æ–™ï¼Œä¸“æ ä¸­çš„ä¸€ç¯‡åŠ é¤ä¸­æåˆ°ä¸€äº›ï¼Œhttps://time.geekbang.org/column/article/468213 ä¸çŸ¥é“æ˜¯å¦æ»¡è¶³ä½ çš„éœ€æ±‚ã€‚ ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644298250,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1363671,"avatar":"https://static001.geekbang.org/account/avatar/00/14/ce/d7/5315f6ce.jpg","nickname":"ä¸è´Ÿé’æ˜¥ä¸è´Ÿå·±ğŸ¤˜","note":"","ucode":"A6DD8E8B20EA6E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":550005,"discussion_content":"æ—¥å¸¸èƒ½å¤Ÿæ¥è§¦åˆ°ä¸‰ä¸ªé¡¹ç›®ï¼Œä¸€ä¸ªgoå†™æ•°æ®åº“ha(ä»£ç èµ°è¯»è¿‡ï¼Œè·Ÿæ—¥å¸¸ç›¸å…³æœ€å¤§),ä¸€ä¸ªæ˜¯goå†™çš„åˆ†å¸ƒå¼æ•°æ®åº“ï¼Œè¿˜æœ‰ç°åœ¨åšæ•°æ®åº“å®¹å™¨åŒ–ï¼Œæoperatorçš„ï¼Œå“ªä¸ªæ¯”è¾ƒæ¨è","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1644327266,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":549928,"ip_address":"","group_id":0},"score":550005,"extra":""}]},{"author":{"id":1079702,"avatar":"https://static001.geekbang.org/account/avatar/00/10/79/96/fb0d8a65.jpg","nickname":"æäº®","note":"","ucode":"E26284C3BF7DF1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":592454,"discussion_content":"Powerful command-line tools with Go\nGo for DevOps","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1667412477,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å››å·","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":332003,"user_name":"lesserror","can_delete":false,"product_type":"c1","uid":1351076,"ip_address":"","ucode":"25A54D1165FCF6","user_header":"https://static001.geekbang.org/account/avatar/00/14/9d/a4/e481ae48.jpg","comment_is_top":false,"comment_ctime":1642955484,"is_pvip":false,"replies":[{"id":121612,"content":"1. å¹¶ä¸æ˜¯ç­‰åˆ°main goroutineé€€å‡ºæ‰é€€å‡ºã€‚å½“Worker poolæ»¡å‘˜æ—¶ï¼Œè¿™é‡Œä¼šèµ°åˆ°defaultåˆ†æ”¯ï¼Œè·³å‡ºè¯¥loopï¼Œè¿›å…¥åˆ°ä¸‹é¢é‚£ä¸ªforå¾ªç¯ï¼Œåé¢çš„forå¾ªç¯æ‰æ˜¯çœŸæ­£ç»´æŠ¤è¿™ä¸ªpoolçš„ä¸»å¾ªç¯ã€‚\n2. è¿™ç¯‡å†™çš„çš„ç¡®æœ‰äº›ä»“ä¿ƒã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1643541735,"ip_address":"","comment_id":332003,"utype":1}],"discussion_count":1,"race_medal":0,"score":4,"product_id":100093501,"comment_content":"å¤§ç™½è€å¸ˆï¼Œè°¢è°¢ä½ è¿™ä¸€ç« èŠ‚ç²¾å½©çš„å†…å®¹ã€‚æœ‰ä»¥ä¸‹å›°æƒ‘ï¼Œéº»çƒ¦æŠ½ç©ºè§£å¿§ã€‚\n\n1.. ç¬¬äºŒç‰ˆçš„Goroutineæ± çš„å®ç°ä¸­ï¼Œæœ€åçš„æµ‹è¯•è¿è¡Œè¾“å‡ºç¯èŠ‚ä¸­ï¼Œè¿è¡Œåˆ° runæ–¹æ³• è¿™ä¸ªGoroutineä¸­æ—¶ï¼Œ!p.preAlloc ä¸ºtrueï¼Œforæ— é™å¾ªç¯å…¶å®ä¸€ç›´åœ¨è¿è¡Œ è¿™ä¸ª case p.active &lt;- struct{}{}:ã€‚æœ€åæ˜¯å› ä¸ºä¸»main Goroutineé€€å‡ºäº†ï¼Œè¿è¡Œè¿™ä¸ª æ— é™forå¾ªç¯çš„ Goroutineä¹Ÿè·Ÿç€é€€å‡ºäº†ï¼Œæ‰€ä»¥è¿™ä¸ªæ— é™forå¾ªç¯ä¹Ÿé€€å‡ºäº†ï¼Œå¯ä»¥è¿™ä¹ˆç†è§£å—ï¼Ÿ\n\n2. Goroutineçš„è¿è¡Œä¸ç¡®å®šæ€§ï¼Œåœ¨å¹¶å‘ç¨‹åºä¸­çš„ç†è§£å¿ƒæ™ºè´Ÿæ‹…å¾ˆå¤§å‘€ï¼Œç¨å¾®å¤æ‚çš„ç¨‹åºï¼Œä¼šå¾ˆä¸å®¹æ˜“ç†è§£ç¨‹åºçš„è¿è¡ŒåŸç†ã€‚è€å¸ˆè¿™ä¸ªè¯¾ç¨‹ï¼Œå¯¹äº Goroutine åœ¨ç¨å¾®å¤æ‚çš„ç¼–å‘ç¨‹åºä¸­æ˜¯å¦‚ä½•è¿è¡Œçš„ï¼Œå¥½åƒæ²¡æœ‰è¿‡å¤šçš„è§£é‡Šï¼Œå¾ˆå®¹æ˜“è®©æ–°æ‰‹ä¸çŸ¥æ‰€ä»¥ç„¶ã€‚è‡³å°‘ï¼Œæœ€åè¿™ä¸ªç‰ˆæœ¬çš„ Goroutine æ± çš„ä¸­ï¼Œæœ€åçš„æµ‹è¯•è¿è¡Œè¾“å‡ºåº”è¯¥è§£é‡Šä¸€ä¸‹ï¼Œè¾“å‡ºä¸ºä½•æ˜¯è¿™æ ·çš„ã€‚å¦‚æœä¸è¿è¡Œï¼Œè¦èƒ½æƒ³åˆ°ç¨‹åºçš„è¾“å‡ºç»“æœï¼Œæˆ‘è§‰å¾—è¿™æ‰å«å®Œå…¨ç†è§£äº†ã€‚æˆ‘è§‰å¾—æˆ‘ç°åœ¨ç›®å‰å¾ˆéš¾åšåˆ°ã€‚\n\nPSï¼šreturnTask é‚£é‡Œçš„é€»è¾‘èƒ½è¡¥å……è¯´æ˜å°±å¥½äº†ï¼Œåˆšçœ‹åˆ°é‚£é‡Œä¹Ÿæ˜¯æœ‰ç‚¹æ‡µï¼ˆçœ‹äº†è¯„è®ºæ‰ç†è§£ï¼‰ã€‚","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":549072,"discussion_content":"1. å¹¶ä¸æ˜¯ç­‰åˆ°main goroutineé€€å‡ºæ‰é€€å‡ºã€‚å½“Worker poolæ»¡å‘˜æ—¶ï¼Œè¿™é‡Œä¼šèµ°åˆ°defaultåˆ†æ”¯ï¼Œè·³å‡ºè¯¥loopï¼Œè¿›å…¥åˆ°ä¸‹é¢é‚£ä¸ªforå¾ªç¯ï¼Œåé¢çš„forå¾ªç¯æ‰æ˜¯çœŸæ­£ç»´æŠ¤è¿™ä¸ªpoolçš„ä¸»å¾ªç¯ã€‚\n2. è¿™ç¯‡å†™çš„çš„ç¡®æœ‰äº›ä»“ä¿ƒã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1643541735,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":331203,"user_name":"ç½—æ°","can_delete":false,"product_type":"c1","uid":1320487,"ip_address":"","ucode":"96BAFAA147341F","user_header":"https://static001.geekbang.org/account/avatar/00/14/26/27/eba94899.jpg","comment_is_top":false,"comment_ctime":1642483839,"is_pvip":false,"replies":[{"id":121005,"content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1642488442,"ip_address":"","comment_id":331203,"utype":1}],"discussion_count":1,"race_medal":0,"score":4,"product_id":100093501,"comment_content":"å®æˆ˜é¡¹ç›®æ£’æ£’å“’","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":549072,"discussion_content":"1. å¹¶ä¸æ˜¯ç­‰åˆ°main goroutineé€€å‡ºæ‰é€€å‡ºã€‚å½“Worker poolæ»¡å‘˜æ—¶ï¼Œè¿™é‡Œä¼šèµ°åˆ°defaultåˆ†æ”¯ï¼Œè·³å‡ºè¯¥loopï¼Œè¿›å…¥åˆ°ä¸‹é¢é‚£ä¸ªforå¾ªç¯ï¼Œåé¢çš„forå¾ªç¯æ‰æ˜¯çœŸæ­£ç»´æŠ¤è¿™ä¸ªpoolçš„ä¸»å¾ªç¯ã€‚\n2. è¿™ç¯‡å†™çš„çš„ç¡®æœ‰äº›ä»“ä¿ƒã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1643541735,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":331093,"user_name":"ã‚éª‘ç€å°è½¦å»å…œé£ã€‚","can_delete":false,"product_type":"c1","uid":2600957,"ip_address":"","ucode":"35F9E5360DF42C","user_header":"https://static001.geekbang.org/account/avatar/00/27/af/fd/a1708649.jpg","comment_is_top":false,"comment_ctime":1642418928,"is_pvip":false,"replies":[{"id":121592,"content":"ä¸çŸ¥é“ åœ¨æœ€åå®æˆ˜ç¯‡çš„ä¸‰èŠ‚è¯¾ æ˜¯å¦èƒ½åˆæ­¥å›ç­”ä½ çš„é—®é¢˜ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1643525140,"ip_address":"","comment_id":331093,"utype":1}],"discussion_count":1,"race_medal":0,"score":4,"product_id":100093501,"comment_content":"çœ‹äº†è¿™ä¹ˆé•¿æ—¶é—´çš„ä¸“æ ï¼Œæ„Ÿè§‰å—ç›ŠåŒªæµ…ã€‚ä¹‹å‰è™½ç„¶ç”¨è¿‡goä½†æ˜¯ä¸€ç›´æ²¡æœ‰ç³»ç»Ÿçš„å­¦ä¹ è¿‡ï¼Œåœ¨å¼€å‘è¿‡ç¨‹ä¸­ä¹Ÿé‡åˆ°äº†è®¸å¤šå‘ã€‚è¿™æ®µæ—¶é—´åˆ·äº†ä¸¤æ¬¡å‡½æ•°æ–¹æ³•å’Œæ¥å£æ¯æ¬¡éƒ½èƒ½å‘æ˜åˆ°æ–°çš„çŸ¥è¯†ç‚¹ï¼Œæ„Ÿè§‰å¯¹goæœ‰äº†å…¨æ–°çš„è®¤è¯†ã€‚å¯¹äºä»Šå¤©è¿™ä¸ªå°é¡¹ç›®å®Œå…¨å¯ä»¥çœ‹çš„æ˜ç™½ï¼Œä½†æ˜¯å¦‚æœè¯´ç°åœ¨è®©æˆ‘å®ç°ä¸€ä¸ªç±»ä¼¼çš„åç¨‹æ± ï¼Œå°±æ„Ÿè§‰è‡ªå·±æ²¡æœ‰è¿™ç§æ€æƒ³å¤´ç»ªä¸çŸ¥é“ä»å“ªä¸‹æ‰‹è§£å†³ã€‚æˆ‘æƒ³é—®è€å¸ˆçš„æ˜¯ï¼šæ€ä¹ˆèƒ½å¤Ÿå°†è‡ªå·±æ‰€å­¦çš„çŸ¥è¯†å’Œå®é™…çš„é—®é¢˜åœºæ™¯ç»“åˆèµ·æ¥å»è§£å†³å®é™…é—®é¢˜ï¼Œæœ‰å“ªäº›å»ºè®®å‘¢ï¼Œè¿˜éœ€è¦åŸ¹å…»å“ªäº›æŠ€èƒ½ï¼Ÿ  æ„Ÿè°¢è€å¸ˆ","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":549035,"discussion_content":"ä¸çŸ¥é“ åœ¨æœ€åå®æˆ˜ç¯‡çš„ä¸‰èŠ‚è¯¾ æ˜¯å¦èƒ½åˆæ­¥å›ç­”ä½ çš„é—®é¢˜ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1643525140,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":331034,"user_name":"åœ¨ä¸‹å®é¾™ã€","can_delete":false,"product_type":"c1","uid":1618030,"ip_address":"","ucode":"0735B64EB61CAC","user_header":"https://static001.geekbang.org/account/avatar/00/18/b0/6e/921cb700.jpg","comment_is_top":false,"comment_ctime":1642389149,"is_pvip":false,"replies":[{"id":120905,"content":"sleepçš„2så¹¶æ²¡æœ‰åˆ›å»ºworkerå•Šã€‚è¿™é‡ŒæŒ‡å®šçš„WithPreAllocWorkers(false)ï¼Œå³ä¸é¢„åˆ›å»ºã€‚runé˜»å¡åœ¨å¯¹tasks channelçš„è¯»å–ä¸Šï¼Œç›´åˆ°åé¢main goroutineç¬¬ä¸€æ¬¡è°ƒç”¨Scheduleå†™å…¥ä¸€ä¸ªtaskï¼Œè¿™æ—¶runæ‰ä¼šå¼€å§‹æŒ‰éœ€åˆ›å»ºWorkerã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1642412036,"ip_address":"","comment_id":331034,"utype":1}],"discussion_count":5,"race_medal":0,"score":4,"product_id":100093501,"comment_content":"æœ€åä¸€ä¸ªä¾‹å­ï¼Œp := workerpool.New(5, workerpool.WithPreAllocWorkers(false),workerpool.WithBlock(false))    \ntime.Sleep(time.Second * 2)\néƒ½ç»™äº†ä¸¤ç§’åˆ›å»ºworker éƒ½æ²¡åˆ›å»ºå¥½worker å—ï¼Ÿï¼ŒæŒ‰ç…§ä»£ç çš„æ„æ€ï¼Œå³ä½¿ä¸å…è®¸é¢„å…ˆåˆ†é…workerï¼Œä½œè€…runé‡Œé¢ï¼Œç»§ç»­åˆ†é…worker äº†å•Šï¼Œå¹¶ä¸”ä¸€å¼€å§‹æ²¡æœ‰taskï¼Œç›´æ¥å°±èµ°default break loopäº†ï¼Œæ„Ÿè§‰æ˜¯ä¸æ˜¯å¤šæ­¤ä¸€ä¸¾äº†è¿™é‡Œå†™çš„ï¼Œbreak loopä¹‹åï¼Œå°±å¼€å§‹æ ¹æ®active åˆ›å»ºworkerï¼Œè®¾ç½®æ˜¯ 5ï¼Œé‚£ä¸¤ç§’è‚¯å®šåˆ›å»º5ä¸ªworkerï¼Œæ‰€ä»¥ä¸æ‡‚ä¸ºç”šä¹ˆè¯´wokerä¸å¤Ÿã€‚ æ˜¯ä¸æ˜¯ p.returnTask(t) è¿™ä¸ªç¼˜æ•…","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546741,"discussion_content":"sleepçš„2så¹¶æ²¡æœ‰åˆ›å»ºworkerå•Šã€‚è¿™é‡ŒæŒ‡å®šçš„WithPreAllocWorkers(false)ï¼Œå³ä¸é¢„åˆ›å»ºã€‚runé˜»å¡åœ¨å¯¹tasks channelçš„è¯»å–ä¸Šï¼Œç›´åˆ°åé¢main goroutineç¬¬ä¸€æ¬¡è°ƒç”¨Scheduleå†™å…¥ä¸€ä¸ªtaskï¼Œè¿™æ—¶runæ‰ä¼šå¼€å§‹æŒ‰éœ€åˆ›å»ºWorkerã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642412036,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1097315,"avatar":"https://static001.geekbang.org/account/avatar/00/10/be/63/ad364db5.jpg","nickname":"ç‹å“²","note":"","ucode":"72FE449A06BD1B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546760,"discussion_content":"ä½†æ˜¯åœ¨å¹¶å‘è°ƒç”¨Scheduleçš„æ—¶å€™ï¼Œç”±äºä¸ç¡®å®š case p.tasks &lt;- t å†™å…¥ channel çš„é€Ÿåº¦å¿«è¿˜æ˜¯ for t := range p.tasks ä¸­è¯»å– channel çš„é€Ÿåº¦å¿«ï¼Œä»è€Œä¼šå¯¼è‡´å¹¶å‘å†™å…¥æ—¶ï¼Œå¯èƒ½ä¹‹å‰å†™å…¥ channel ä¸­çš„ task å°šæœªå¤„ç†ï¼ˆæ²¡æœ‰åˆ›å»ºå¯¹åº”çš„workerï¼‰ï¼Œå¯¼è‡´ç›´æ¥é€€å‡ºã€‚\nå°†ä»£ç ä¿®æ”¹å¦‚ä¸‹åå¯ä¿è¯æ­£å¸¸æ‰§è¡Œï¼š\nfunc main() {\n\tp := workerpool.New(5, workerpool.WithPreAllocWorkers(false), workerpool.WithBlock(false))\n\n\ttime.Sleep(10 * time.Millisecond)\n\n\tfor i := 0; i &lt; 10; i++ {\n\t\terr := p.Schedule(func() {\n\t\t\ttime.Sleep(time.Second * 3)\n\t\t})\n\t\ttime.Sleep(10 * time.Millisecond)\n\t\tif err != nil {\n\t\t\tfmt.Printf(&#34;task[%d]: error: %s\\n&#34;, i, err.Error())\n\t\t}\n\t}\n\n\tp.Free()\n}","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1642417203,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1175507,"avatar":"https://static001.geekbang.org/account/avatar/00/11/ef/d3/241d0b84.jpg","nickname":"upup","note":"","ucode":"25DB114677EF58","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":575326,"discussion_content":"â€œruné˜»å¡åœ¨å¯¹tasks channelçš„è¯»å–ä¸Šâ€ï¼Œå½“æ²¡æœ‰å‘é€ç«¯çš„æ—¶å€™ï¼Œfor range channelçš„æ—¶å€™ï¼Œæ¥æ”¶ç«¯ä¼šé˜»å¡çš„ï¼›å½“æ¥äº†taskä¹‹åï¼Œä¼šåˆ›å»ºæ–°çš„workerï¼Œå¦‚æœæœ‰5ä¸ªtaskï¼Œpool capä¸º3çš„è¯ï¼Œé‚£ä¹ˆåªèƒ½åˆ›å»º3ä¸ªworkerï¼Œåœ¨ç¬¬å››æ¬¡æ‰§è¡Œå¾ªç¯ä½“çš„æ—¶å€™ï¼Œæ‰ä¼šæ‰§è¡Œåˆ°defaultåˆ†æ”¯ï¼›æ‰€ä»¥ä¸Šé¢çš„ä¸¤ä¸ªcaseåˆ†æ”¯æ˜¯å¯ä»¥ç”¨åˆ°çš„ï¼Œä¹Ÿå°±ä¸æ˜¯â€œå¤šæ­¤ä¸€ä¸¾â€ï¼›","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1654748756,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1351076,"avatar":"https://static001.geekbang.org/account/avatar/00/14/9d/a4/e481ae48.jpg","nickname":"lesserror","note":"","ucode":"25A54D1165FCF6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":548134,"discussion_content":"å…„å¼Ÿï¼Œæˆ‘è§‰å¾—ä½ ç†è§£é”™äº†ã€‚è¿™é‡Œçš„Scheduleå¹¶ä¸æ˜¯å¹¶å‘è°ƒç”¨çš„å‘€ã€‚åªæ˜¯åœ¨forå¾ªç¯ä¸­è°ƒç”¨å‘€ã€‚ä½ è¿™åªæ˜¯æ·»åŠ äº†sleepçš„æ—¶é—´å‘€ã€‚æˆ‘è¿è¡Œå’Œè€å¸ˆçš„ç»“æœä¸€æ ·å‘€ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1643036556,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1603004,"avatar":"https://static001.geekbang.org/account/avatar/00/18/75/bc/89d88775.jpg","nickname":"Calvin","note":"","ucode":"0EEF5B207623B5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546824,"discussion_content":"ä¸€å¼€å§‹å’Œæ¥¼ä¸»ä¸€æ ·æœ‰ç–‘æƒ‘ï¼Œè‡ªå·±å†™ä»£ç æµ‹è¯•äº†ä¸‹ï¼Œfor t := range p.tasks é‚£é‡Œæ˜¯ä¼šé˜»å¡ä½çš„ï¼ˆå› ä¸º New æ—¶ p.tasks è¿˜æ˜¯ç©ºçš„ï¼‰ï¼Œæ‰€ä»¥è°ƒç”¨ Schedule ä¹‹å‰ Sleep çš„é‚£ 2 ç§’é’Ÿå…¶å®ä¹Ÿæ˜¯ä¸ä¼šåˆ›å»ºå‡º workers çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642433183,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":331019,"user_name":"æ— åæ— å§“","can_delete":false,"product_type":"c1","uid":2621412,"ip_address":"","ucode":"487BD5AA2CD305","user_header":"https://static001.geekbang.org/account/avatar/00/27/ff/e4/927547a9.jpg","comment_is_top":false,"comment_ctime":1642382389,"is_pvip":false,"replies":[{"id":120906,"content":"å¯ä»¥æŠŠé—®é¢˜æçš„å…·ä½“ä¸€ç‚¹ğŸ˜ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1642412062,"ip_address":"","comment_id":331019,"utype":1}],"discussion_count":1,"race_medal":0,"score":4,"product_id":100093501,"comment_content":"è¿˜æ˜¯æœ‰äº›ä¸ç†è§£","like_count":1,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546741,"discussion_content":"sleepçš„2så¹¶æ²¡æœ‰åˆ›å»ºworkerå•Šã€‚è¿™é‡ŒæŒ‡å®šçš„WithPreAllocWorkers(false)ï¼Œå³ä¸é¢„åˆ›å»ºã€‚runé˜»å¡åœ¨å¯¹tasks channelçš„è¯»å–ä¸Šï¼Œç›´åˆ°åé¢main goroutineç¬¬ä¸€æ¬¡è°ƒç”¨Scheduleå†™å…¥ä¸€ä¸ªtaskï¼Œè¿™æ—¶runæ‰ä¼šå¼€å§‹æŒ‰éœ€åˆ›å»ºWorkerã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642412036,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1097315,"avatar":"https://static001.geekbang.org/account/avatar/00/10/be/63/ad364db5.jpg","nickname":"ç‹å“²","note":"","ucode":"72FE449A06BD1B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546760,"discussion_content":"ä½†æ˜¯åœ¨å¹¶å‘è°ƒç”¨Scheduleçš„æ—¶å€™ï¼Œç”±äºä¸ç¡®å®š case p.tasks &lt;- t å†™å…¥ channel çš„é€Ÿåº¦å¿«è¿˜æ˜¯ for t := range p.tasks ä¸­è¯»å– channel çš„é€Ÿåº¦å¿«ï¼Œä»è€Œä¼šå¯¼è‡´å¹¶å‘å†™å…¥æ—¶ï¼Œå¯èƒ½ä¹‹å‰å†™å…¥ channel ä¸­çš„ task å°šæœªå¤„ç†ï¼ˆæ²¡æœ‰åˆ›å»ºå¯¹åº”çš„workerï¼‰ï¼Œå¯¼è‡´ç›´æ¥é€€å‡ºã€‚\nå°†ä»£ç ä¿®æ”¹å¦‚ä¸‹åå¯ä¿è¯æ­£å¸¸æ‰§è¡Œï¼š\nfunc main() {\n\tp := workerpool.New(5, workerpool.WithPreAllocWorkers(false), workerpool.WithBlock(false))\n\n\ttime.Sleep(10 * time.Millisecond)\n\n\tfor i := 0; i &lt; 10; i++ {\n\t\terr := p.Schedule(func() {\n\t\t\ttime.Sleep(time.Second * 3)\n\t\t})\n\t\ttime.Sleep(10 * time.Millisecond)\n\t\tif err != nil {\n\t\t\tfmt.Printf(&#34;task[%d]: error: %s\\n&#34;, i, err.Error())\n\t\t}\n\t}\n\n\tp.Free()\n}","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1642417203,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1175507,"avatar":"https://static001.geekbang.org/account/avatar/00/11/ef/d3/241d0b84.jpg","nickname":"upup","note":"","ucode":"25DB114677EF58","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":575326,"discussion_content":"â€œruné˜»å¡åœ¨å¯¹tasks channelçš„è¯»å–ä¸Šâ€ï¼Œå½“æ²¡æœ‰å‘é€ç«¯çš„æ—¶å€™ï¼Œfor range channelçš„æ—¶å€™ï¼Œæ¥æ”¶ç«¯ä¼šé˜»å¡çš„ï¼›å½“æ¥äº†taskä¹‹åï¼Œä¼šåˆ›å»ºæ–°çš„workerï¼Œå¦‚æœæœ‰5ä¸ªtaskï¼Œpool capä¸º3çš„è¯ï¼Œé‚£ä¹ˆåªèƒ½åˆ›å»º3ä¸ªworkerï¼Œåœ¨ç¬¬å››æ¬¡æ‰§è¡Œå¾ªç¯ä½“çš„æ—¶å€™ï¼Œæ‰ä¼šæ‰§è¡Œåˆ°defaultåˆ†æ”¯ï¼›æ‰€ä»¥ä¸Šé¢çš„ä¸¤ä¸ªcaseåˆ†æ”¯æ˜¯å¯ä»¥ç”¨åˆ°çš„ï¼Œä¹Ÿå°±ä¸æ˜¯â€œå¤šæ­¤ä¸€ä¸¾â€ï¼›","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1654748756,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1351076,"avatar":"https://static001.geekbang.org/account/avatar/00/14/9d/a4/e481ae48.jpg","nickname":"lesserror","note":"","ucode":"25A54D1165FCF6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":548134,"discussion_content":"å…„å¼Ÿï¼Œæˆ‘è§‰å¾—ä½ ç†è§£é”™äº†ã€‚è¿™é‡Œçš„Scheduleå¹¶ä¸æ˜¯å¹¶å‘è°ƒç”¨çš„å‘€ã€‚åªæ˜¯åœ¨forå¾ªç¯ä¸­è°ƒç”¨å‘€ã€‚ä½ è¿™åªæ˜¯æ·»åŠ äº†sleepçš„æ—¶é—´å‘€ã€‚æˆ‘è¿è¡Œå’Œè€å¸ˆçš„ç»“æœä¸€æ ·å‘€ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1643036556,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1603004,"avatar":"https://static001.geekbang.org/account/avatar/00/18/75/bc/89d88775.jpg","nickname":"Calvin","note":"","ucode":"0EEF5B207623B5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546824,"discussion_content":"ä¸€å¼€å§‹å’Œæ¥¼ä¸»ä¸€æ ·æœ‰ç–‘æƒ‘ï¼Œè‡ªå·±å†™ä»£ç æµ‹è¯•äº†ä¸‹ï¼Œfor t := range p.tasks é‚£é‡Œæ˜¯ä¼šé˜»å¡ä½çš„ï¼ˆå› ä¸º New æ—¶ p.tasks è¿˜æ˜¯ç©ºçš„ï¼‰ï¼Œæ‰€ä»¥è°ƒç”¨ Schedule ä¹‹å‰ Sleep çš„é‚£ 2 ç§’é’Ÿå…¶å®ä¹Ÿæ˜¯ä¸ä¼šåˆ›å»ºå‡º workers çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642433183,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":390461,"user_name":"Geek_b745bf","can_delete":false,"product_type":"c1","uid":2104889,"ip_address":"æ¹–åŒ—","ucode":"6EB395F6AE0C15","user_header":"","comment_is_top":false,"comment_ctime":1715399231,"is_pvip":false,"replies":[{"id":142036,"content":"ä¸“æ ä¸­çš„ä»£ç æ›´å¤šæ˜¯ä¸ºäº†è®²è§£çŸ¥è¯†ç‚¹ç›®çš„ä½¿ç”¨ï¼Œä¸å»ºè®®åœ¨ç”Ÿäº§ä¸­ä½¿ç”¨ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1715418642,"ip_address":"åŒ—äº¬","comment_id":390461,"utype":1}],"discussion_count":1,"race_medal":0,"score":4,"product_id":100093501,"comment_content":"è€å¸ˆï¼Œå‡å¦‚æ˜¯è¿ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒï¼Œä»¥è¿™ä¸ªç¤ºä¾‹æ¥çœ‹å¤§æ¦‚è¿˜éœ€è¦è¡¥å……ä¸€äº›ä»€ä¹ˆå‘¢","like_count":0,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546743,"discussion_content":"å¯ä»¥æŠŠé—®é¢˜æçš„å…·ä½“ä¸€ç‚¹ğŸ˜ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642412063,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":383663,"user_name":"çˆ±åƒèƒ¡èåœ","can_delete":false,"product_type":"c1","uid":1459413,"ip_address":"å¹¿ä¸œ","ucode":"35FCF84D1E04C5","user_header":"https://static001.geekbang.org/account/avatar/00/16/44/d5/ca522e83.jpg","comment_is_top":false,"comment_ctime":1699423974,"is_pvip":false,"replies":[{"id":139930,"content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1699481986,"ip_address":"è¾½å®","comment_id":383663,"utype":1}],"discussion_count":1,"race_medal":0,"score":4,"product_id":100093501,"comment_content":"å¯¹äºdemo2ä¸ªäºº è®¤ä¸ºå†™çš„ä¸å¥½ï¼Œä¸€ä¸‹æ˜¯æˆ‘çš„ä¸ªäººæµ…è§\n\n```go\n&#47;&#47; New å‡½æ•°ä»£ç ç‰‡æ®µ\nif p.preAlloc {\n     &#47;&#47; create all goroutines and send into works channel \n     for i := 0; i &lt; p.capacity; i++ { \n        p.newWorker(i + 1) p.active &lt;- struct{}{}\n        } \n    }\n```\n\n```go\n&#47;&#47; runå‡½æ•°ä»£ç ç‰‡æ®µ\nfor { \n    select { \n        case &lt;-p.quit: return \n        case p.active &lt;- struct{}{}: \n        &#47;&#47; create a new worker \n            idx++ \n            p.newWorker(idx) \n        } \n    }\n```\n\nè¿™ä¸¤ä¸ªä»£ç ç‰‡æ®µæ˜¯ç­‰æ•ˆçš„ï¼Œ é¦–å…ˆåœ¨newå‡½æ•°é‡Œ &lt;-p.quit è¿™ä¸ªå€¼æ˜¯ä¸å¯èƒ½è§¦å‘çš„ï¼Œå³demo1äº‹å®ä¸Šå°±æ˜¯å®ç°çš„preAllocç­–ç•¥ï¼Œ\næˆ‘ä»¬åº”è¯¥åªéœ€è¦æ·»åŠ ï¼PreAllocç­–ç•¥å³å¯","like_count":0,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":644674,"discussion_content":"ä¸“æ ä¸­çš„ä»£ç æ›´å¤šæ˜¯ä¸ºäº†è®²è§£çŸ¥è¯†ç‚¹ç›®çš„ä½¿ç”¨ï¼Œä¸å»ºè®®åœ¨ç”Ÿäº§ä¸­ä½¿ç”¨ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1715418642,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":380524,"user_name":"phylony-lu","can_delete":false,"product_type":"c1","uid":1342724,"ip_address":"ä¸Šæµ·","ucode":"00666300AD0E7F","user_header":"https://static001.geekbang.org/account/avatar/00/14/7d/04/d606b6a8.jpg","comment_is_top":false,"comment_ctime":1693757832,"is_pvip":false,"replies":[{"id":138580,"content":"è°ƒç”¨returnTaskï¼Œä¸»è¦æ˜¯å› ä¸ºæ˜¯åœ¨p.preAlloc=falseçš„æƒ…å†µä¸‹ï¼Œä¹Ÿå°±æ˜¯ä¸é¢„å…ˆåˆ›å»ºworker poolçš„æƒ…å†µä¸‹ã€‚å½“ScheduleTaskåï¼Œç”±taskæ¥é©±åŠ¨workerçš„åˆ›å»ºï¼Œä½†taskå·²ç»è¢«è¯»å–äº†å‡ºæ¥ï¼Œè¯¥taskåº”è¯¥é‡æ–°æ”¾å›channelï¼Œç”±workerå–å‡ºå¹¶æ‰§è¡Œã€‚å—¯ï¼Œè¿™é‡Œçš„ç¡®ä¸å¤Ÿä¼˜é›…ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1026224,"ctime":1693814560,"ip_address":"åŒ—äº¬","comment_id":380524,"utype":1}],"discussion_count":1,"race_medal":0,"score":4,"product_id":100093501,"comment_content":"è€å¸ˆï¼Œæˆ‘è¿˜æ˜¯æœ‰äº›ä¸æ˜¯å¾ˆæ˜ç™½ï¼Œä¸ºä»€ä¹ˆè¦åœ¨runå‡½æ•°é‡Œæ‰§è¡Œfor t := range p.tasksï¼Œtasksæ˜¯æ— ç¼“å­˜å¾—channelï¼Œé»˜è®¤æ²¡æœ‰æ¨é€å°±æ˜¯ä¼šé˜»å¡ï¼Œæœ‰æ¨é€å°±æ˜¯ä¼šè¿›å…¥å¾ªç¯ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦è°ƒç”¨returnTaskå†æ¨é€ä¸€æ¬¡æ¶ˆæ¯ç»™taskså¾—channelå‘¢ï¼Ÿè¿™æ ·åšæ˜¯ä¸æ˜¯è¦ç­‰åˆ°è¯¥taskè¢«æ¶ˆè´¹æ‰ä¼šå…è®¸å†æ¬¡æ¨é€å€¼è¿›æ¥ï¼Ÿ\t\t\t\nfmt.Println(&quot;Add:&quot;, idx, t)\n&#47;&#47;p.returnTask(t)\nåœ¨newworkderå¾—å‡½æ•°é‡Œselectä¹Ÿä¸€ç›´åœ¨ç›‘å¬&lt;-p.taskï¼Œæœ‰æ›´æ–°å°±ä¼šè°ƒç”¨ã€‚é‚£ç†è®ºä¸Šæ¥è¯´ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥å°†runå¾—ä»£ç ç²¾ç®€ä¸ºå»æ‰loopçš„å‰©ä½™éƒ¨åˆ†ã€‚å› ä¸ºp.acitveçš„channelå †æ»¡åä¹Ÿå°±æ˜¯ä¸ä¼šå†è°ƒç”¨goroutineäº†ã€‚ä¸çŸ¥é“è¿™æ ·ç†è§£å¯¹ä¸å¯¹ï¼Œè¯·è€å¸ˆå¸®å¿™è§£ç­”ç–‘æƒ‘ï¼Œæ„Ÿè°¢ã€‚\n","like_count":0,"discussions":[{"author":{"id":1026224,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","nickname":"Tony Bai","note":"","ucode":"B6B08985F6FA89","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":631388,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1699481986,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"è¾½å®","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":347732,"user_name":"Aeins","can_delete":false,"product_type":"c1","uid":1045910,"ip_address":"","ucode":"D5BF220767541D","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f5/96/0cf9f3c7.jpg","comment_is_top":false,"comment_ctime":1654358903,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100093501,"comment_content":"1. demo01 çš„å®ç°ï¼Œå·²ç»æ˜¯ä¸€ç§é¢„åˆ†é…çš„å®ç°ï¼Œdemo02 åœ¨ New é‡Œé¢ å»é¢„åˆ†é…ï¼Œæ²¡æœ‰å¿…è¦\n\n2.  demo02 ï¼Œtask å–å‡ºæ¥ï¼Œå†æ”¾å›å»ï¼Œæ€»æ„Ÿè§‰ä¸ä¼˜é›…ã€‚\n","like_count":3},{"had_liked":false,"id":351585,"user_name":"æ›¾ç¥¥é‡‘","can_delete":false,"product_type":"c1","uid":2362279,"ip_address":"","ucode":"CBBB7FC1EA00D6","user_header":"","comment_is_top":false,"comment_ctime":1657960956,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":5,"product_id":100093501,"comment_content":"æ„Ÿè§‰é€€å‡ºå¯ä»¥ç”¨contextå¤„ç†","like_count":1},{"had_liked":false,"id":331863,"user_name":"gamePlayer","can_delete":false,"product_type":"c1","uid":2890781,"ip_address":"","ucode":"A340ED6240F30A","user_header":"","comment_is_top":false,"comment_ctime":1642837691,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":5,"product_id":100093501,"comment_content":"ä¸ºä»€ä¹ˆè¦æåç¨‹æ± ï¼Œgoçš„ä¼˜åŠ¿ä½•åœ¨ï¼Œå¿ƒæ™ºè´Ÿæ‹…æé«˜ï¼Œä¸å…¶é€‰æ‹©å¤–è¾¹è‰¯è ä¸é½çš„å®ç°ï¼Œä½•ä¸ç”¨java jucçš„çº¿ç¨‹æ± ? äººäº‘äº¦äº‘ï¼Œæçš„goè¯­è¨€è¶Šæ¥è¶Šè¾£é¸¡\n","like_count":1},{"had_liked":false,"id":351585,"user_name":"æ›¾ç¥¥é‡‘","can_delete":false,"product_type":"c1","uid":2362279,"ip_address":"","ucode":"CBBB7FC1EA00D6","user_header":"","comment_is_top":false,"comment_ctime":1657960956,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":5,"product_id":100093501,"comment_content":"æ„Ÿè§‰é€€å‡ºå¯ä»¥ç”¨contextå¤„ç†","like_count":1},{"had_liked":false,"id":331863,"user_name":"gamePlayer","can_delete":false,"product_type":"c1","uid":2890781,"ip_address":"","ucode":"A340ED6240F30A","user_header":"","comment_is_top":false,"comment_ctime":1642837691,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":5,"product_id":100093501,"comment_content":"ä¸ºä»€ä¹ˆè¦æåç¨‹æ± ï¼Œgoçš„ä¼˜åŠ¿ä½•åœ¨ï¼Œå¿ƒæ™ºè´Ÿæ‹…æé«˜ï¼Œä¸å…¶é€‰æ‹©å¤–è¾¹è‰¯è ä¸é½çš„å®ç°ï¼Œä½•ä¸ç”¨java jucçš„çº¿ç¨‹æ± ? äººäº‘äº¦äº‘ï¼Œæçš„goè¯­è¨€è¶Šæ¥è¶Šè¾£é¸¡\n","like_count":1}]}