{"id":205636,"title":"34 | MediatR：轻松实现命令查询职责分离模式（CQRS）","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/NET-Core\">https://gitee.com/geektime-geekbang/NET-Core</a></p>","comments":[{"had_liked":false,"id":184822,"user_name":"Geek_7c4953","can_delete":false,"product_type":"c3","uid":1809168,"ip_address":"","ucode":"359745D4725D4F","user_header":"","comment_is_top":false,"comment_ctime":1583413462,"is_pvip":false,"replies":[{"id":71564,"content":"你自己实现一套跟使用MidatR本质上是一样的，MidatR没有引入其它依赖，足够轻，因此依赖它不会造成负担，有现成的经过验证的组件可以用，何乐而不为呢。","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1583562686,"ip_address":"","comment_id":184822,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"我最近一直在纠结一个问题，就是项目紧密耦合MidatR算不算紧耦合。我自己倒是照着这套架构撸了一套让领域事件和处理类不必实现INotification和I...Handler的接口。不过也是费了老大劲了，又是看源码，又是研究反射的。就是不知道这么做有没有必要。","like_count":4,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":486135,"discussion_content":"你自己实现一套跟使用MidatR本质上是一样的，MidatR没有引入其它依赖，足够轻，因此依赖它不会造成负担，有现成的经过验证的组件可以用，何乐而不为呢。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583562686,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":214274,"discussion_content":"又造了一遍轮子","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585157255,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":185036,"user_name":"Coder77","can_delete":false,"product_type":"c3","uid":1809759,"ip_address":"","ucode":"5A133D1BA9981C","user_header":"https://static001.geekbang.org/account/avatar/00/1b/9d/5f/8ac80c01.jpg","comment_is_top":false,"comment_ctime":1583468640,"is_pvip":false,"replies":[{"id":71561,"content":"MediatR 进程内的事件传递，适合领域事件在进程内的传递，CAP是跨进程跨应用的传递","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1583562230,"ip_address":"","comment_id":185036,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"为什么用来CAP还要在用MediatR呢？感觉CAP组件已经涵盖了MediatR的功能了。","like_count":3,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":486223,"discussion_content":"MediatR 进程内的事件传递，适合领域事件在进程内的传递，CAP是跨进程跨应用的传递","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583562230,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1028301,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b0/cd/c54572fe.jpg","nickname":"沐雪","note":"","ucode":"0C42BF0D75FD9B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":383378,"discussion_content":"如果这么说的话，CAP完全可以替代MediatR的功能；而且CAP解耦更加彻底。感觉还是没必要用MediatR啊。难道是我理解错了？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1626074339,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":183556,"user_name":"川杰","can_delete":false,"product_type":"c3","uid":1099750,"ip_address":"","ucode":"815211E1D698E6","user_header":"https://static001.geekbang.org/account/avatar/00/10/c7/e6/11f21cb4.jpg","comment_is_top":false,"comment_ctime":1583065542,"is_pvip":false,"replies":[{"id":71574,"content":"你举例的这个场景是需要领域事件来驱动的，领域事件驱动物流、积分等模块的处理，也就是EventHandler","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1583563366,"ip_address":"","comment_id":183556,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"老师，个人想法，如果这个框架，只能一个Command对应一个Handler，是不是太弱了？\n打个比方，订单创建成功命令发出；需要，物流模块，积分模块，等其他几个模块去同时相应；按照目前的方式，只能将这些逻辑写在一个Handler里。但真实代码中，物流，积分等往往是写在不同模块的；\n如果这个框架有这个限制，那我觉得应用场景就太窄了；","like_count":2,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":485712,"discussion_content":"你举例的这个场景是需要领域事件来驱动的，领域事件驱动物流、积分等模块的处理，也就是EventHandler","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583563366,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":214276,"discussion_content":"一点都不弱，很强的，如果是在一个服务中，通过ED调用不同聚合。如果是不同的服务，通过领域事件驱动集成事件，达成最终一致性。一切的目的都是为了解耦。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585157380,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":184888,"user_name":"Geek_7c4953","can_delete":false,"product_type":"c3","uid":1809168,"ip_address":"","ucode":"359745D4725D4F","user_header":"","comment_is_top":false,"comment_ctime":1583424946,"is_pvip":false,"replies":[{"id":71581,"content":"这里的核心是命令发起的逻辑，完全与Handle的逻辑隔离开，没有任何依赖。我们可以为这两段逻辑分别构建单元测试","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1583565409,"ip_address":"","comment_id":184888,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"希望老师再讲讲request&#47;response与response.Handle(request)的区别。想了半天也没想明白有什么区别。\n如果说前者request发起方不必依赖response的话，那后者用接口应该也能实现这一点啊。如果说业务变动，\n该修改Handle方法的还是修改，该修改request参数的也还是要修改。\nrequest&#47;response到底有什么好处呢？","like_count":1,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":486160,"discussion_content":"这里的核心是命令发起的逻辑，完全与Handle的逻辑隔离开，没有任何依赖。我们可以为这两段逻辑分别构建单元测试","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583565409,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":183043,"user_name":"zy","can_delete":false,"product_type":"c3","uid":1817487,"ip_address":"","ucode":"54C318B06B8D3A","user_header":"https://static001.geekbang.org/account/avatar/00/1b/bb/8f/13de6ff8.jpg","comment_is_top":false,"comment_ctime":1582940753,"is_pvip":false,"replies":[{"id":70981,"content":"发送命令的方式，可以更方便些单元测试，让测试代码更聚焦。\n代码的组织和依赖关系形成约定后，查找引用的诉求会相对弱一些，可以接受。","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1583044101,"ip_address":"","comment_id":183043,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"用发送命令的方式以后就不能愉快的使用查找定义和引用了，个人还是喜欢对象引用的方法。","like_count":1,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":485544,"discussion_content":"发送命令的方式，可以更方便些单元测试，让测试代码更聚焦。\n代码的组织和依赖关系形成约定后，查找引用的诉求会相对弱一些，可以接受。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583044101,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":214277,"discussion_content":"可以在命令处理类中照样可以查找定义和引用，包了一层而矣。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585157452,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":183040,"user_name":"zy","can_delete":false,"product_type":"c3","uid":1817487,"ip_address":"","ucode":"54C318B06B8D3A","user_header":"https://static001.geekbang.org/account/avatar/00/1b/bb/8f/13de6ff8.jpg","comment_is_top":false,"comment_ctime":1582940036,"is_pvip":false,"replies":[{"id":70982,"content":"建议定期归档一段时间，然后再删除。","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1583044134,"ip_address":"","comment_id":183040,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"事件表中状态为succeed记录可以删吗。业务会有影响吗","like_count":1,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":485543,"discussion_content":"建议定期归档一段时间，然后再删除。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583044134,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1200680,"avatar":"https://static001.geekbang.org/account/avatar/00/12/52/28/2457f3cc.jpg","nickname":"油条","note":"","ucode":"0E07462BC6903E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":191860,"discussion_content":"保存24小时后会自动删除，失败的会保存15天","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1583041151,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":231690,"user_name":"Quintos","can_delete":false,"product_type":"c3","uid":1313882,"ip_address":"","ucode":"DD1FB190599279","user_header":"https://static001.geekbang.org/account/avatar/00/14/0c/5a/3b01789e.jpg","comment_is_top":false,"comment_ctime":1593749214,"is_pvip":true,"replies":[{"id":85996,"content":"mediatR可以让controller与service解耦","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1594221583,"ip_address":"","comment_id":231690,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"现在项目里是使用的是controller调用service的形式, action接收的model是request对象，调用完service,返回的是response对象，这种模式和mediat的有什么区别呢？","like_count":0,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":500410,"discussion_content":"mediatR可以让controller与service解耦","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594221583,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":223338,"user_name":"CSharp","can_delete":false,"product_type":"c3","uid":1881988,"ip_address":"","ucode":"1BBA29DF5A6C6D","user_header":"https://static001.geekbang.org/account/avatar/00/1c/b7/84/e4bddc9f.jpg","comment_is_top":false,"comment_ctime":1591066761,"is_pvip":false,"replies":[{"id":83288,"content":"是的","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1591950142,"ip_address":"","comment_id":223338,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"老师，请问下每个Handler只能有一个处理方法吗，如果这样的话，那不是说每一个不同的命令或者查询都要写一个Handler来单独处理吗？","like_count":0,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":497105,"discussion_content":"是的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591950142,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1153650,"avatar":"https://static001.geekbang.org/account/avatar/00/11/9a/72/234b43b9.jpg","nickname":"洼塘","note":"","ucode":"BCDE11F076A10C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":287140,"discussion_content":"可以多个，这里只是蜻蜓点水，可以看看微软的指导文档，也可看看Martin Fowler的叙述。https://docs.microsoft.com/en-us/azure/architecture/patterns/cqrs","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1593390731,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":328950,"user_name":"Aaron.","can_delete":false,"product_type":"c3","uid":1809131,"ip_address":"","ucode":"F9BE389E808162","user_header":"https://static001.geekbang.org/account/avatar/00/1b/9a/eb/cfbfab0d.jpg","comment_is_top":false,"comment_ctime":1640949445,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"老师，您的案例中，post调用CreateOrder接口，传入{“ItemCount”：0}就行了，但如果我要上传自定义类型的对象，应该如何调用，使得接口能方便拿到这个对象呢？","like_count":0},{"had_liked":false,"id":262586,"user_name":"东东","can_delete":false,"product_type":"c3","uid":2087878,"ip_address":"","ucode":"24DCFEFF41538E","user_header":"https://static001.geekbang.org/account/avatar/00/1f/db/c6/b2608595.jpg","comment_is_top":false,"comment_ctime":1605774608,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"DDD设计方法中CQRS，做到读写模型分离，读，专门有读的模型和处理方式；写，专门有写的模型何处理方式。但我没能理解的是，使用MediatR 都是使用事件传递，在于领域层与基础设施层之间的解耦。 CQRS感觉这完全是两回事呢？","like_count":0},{"had_liked":false,"id":262325,"user_name":"二狗子的大哥","can_delete":false,"product_type":"c3","uid":1184403,"ip_address":"","ucode":"C4E1D95DD7EE66","user_header":"https://static001.geekbang.org/account/avatar/00/12/12/93/db4bf1c4.jpg","comment_is_top":false,"comment_ctime":1605692620,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100044601,"comment_content":"老师，如果后期我们需要新加视图，从eventstore中获取，但是可能系统用的久，有两年的数据的command，如何才能做到不用太大的代价就可以从中计算出新视图的值呢？","like_count":0},{"had_liked":false,"id":239222,"user_name":"Luke 💨","can_delete":false,"product_type":"c3","uid":1504276,"ip_address":"","ucode":"343C168A06B30A","user_header":"https://static001.geekbang.org/account/avatar/00/16/f4/14/c1c81d88.jpg","comment_is_top":false,"comment_ctime":1596462049,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100044601,"comment_content":"这和.net中Subscribe订阅和observer响应式流有啥区别，感觉功能还弱化了。","like_count":0},{"had_liked":false,"id":234061,"user_name":"Geek_1d4f70","can_delete":false,"product_type":"c3","uid":1808484,"ip_address":"","ucode":"9A814621A2BC50","user_header":"","comment_is_top":false,"comment_ctime":1594569038,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100044601,"comment_content":"学习了","like_count":0}]}