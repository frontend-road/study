{"id":94604,"title":"32 | Balkingæ¨¡å¼ï¼šå†è°ˆçº¿ç¨‹å®‰å…¨çš„å•ä¾‹æ¨¡å¼","content":"<p>ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬æåˆ°å¯ä»¥ç”¨â€œå¤šçº¿ç¨‹ç‰ˆæœ¬çš„ifâ€æ¥ç†è§£Guarded Suspensionæ¨¡å¼ï¼Œä¸åŒäºå•çº¿ç¨‹ä¸­çš„ifï¼Œè¿™ä¸ªâ€œå¤šçº¿ç¨‹ç‰ˆæœ¬çš„ifâ€æ˜¯éœ€è¦ç­‰å¾…çš„ï¼Œè€Œä¸”è¿˜å¾ˆæ‰§ç€ï¼Œå¿…é¡»è¦ç­‰åˆ°æ¡ä»¶ä¸ºçœŸã€‚ä½†å¾ˆæ˜¾ç„¶è¿™ä¸ªä¸–ç•Œï¼Œä¸æ˜¯æ‰€æœ‰åœºæ™¯éƒ½éœ€è¦è¿™ä¹ˆæ‰§ç€ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬è¿˜éœ€è¦å¿«é€Ÿæ”¾å¼ƒã€‚</p><p>éœ€è¦å¿«é€Ÿæ”¾å¼ƒçš„ä¸€ä¸ªæœ€å¸¸è§çš„ä¾‹å­æ˜¯å„ç§ç¼–è¾‘å™¨æä¾›çš„è‡ªåŠ¨ä¿å­˜åŠŸèƒ½ã€‚è‡ªåŠ¨ä¿å­˜åŠŸèƒ½çš„å®ç°é€»è¾‘ä¸€èˆ¬éƒ½æ˜¯éš”ä¸€å®šæ—¶é—´è‡ªåŠ¨æ‰§è¡Œå­˜ç›˜æ“ä½œï¼Œå­˜ç›˜æ“ä½œçš„å‰ææ˜¯æ–‡ä»¶åšè¿‡ä¿®æ”¹ï¼Œå¦‚æœæ–‡ä»¶æ²¡æœ‰æ‰§è¡Œè¿‡ä¿®æ”¹æ“ä½œï¼Œå°±éœ€è¦å¿«é€Ÿæ”¾å¼ƒå­˜ç›˜æ“ä½œã€‚ä¸‹é¢çš„ç¤ºä¾‹ä»£ç å°†è‡ªåŠ¨ä¿å­˜åŠŸèƒ½ä»£ç åŒ–äº†ï¼Œå¾ˆæ˜¾ç„¶AutoSaveEditorè¿™ä¸ªç±»ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå› ä¸ºå¯¹å…±äº«å˜é‡changedçš„è¯»å†™æ²¡æœ‰ä½¿ç”¨åŒæ­¥ï¼Œé‚£å¦‚ä½•ä¿è¯AutoSaveEditorçš„çº¿ç¨‹å®‰å…¨æ€§å‘¢ï¼Ÿ</p><pre><code>class AutoSaveEditor{\n  //æ–‡ä»¶æ˜¯å¦è¢«ä¿®æ”¹è¿‡\n  boolean changed=false;\n  //å®šæ—¶ä»»åŠ¡çº¿ç¨‹æ± \n  ScheduledExecutorService ses = \n    Executors.newSingleThreadScheduledExecutor();\n  //å®šæ—¶æ‰§è¡Œè‡ªåŠ¨ä¿å­˜\n  void startAutoSave(){\n    ses.scheduleWithFixedDelay(()-&gt;{\n      autoSave();\n    }, 5, 5, TimeUnit.SECONDS);  \n  }\n  //è‡ªåŠ¨å­˜ç›˜æ“ä½œ\n  void autoSave(){\n    if (!changed) {\n      return;\n    }\n    changed = false;\n    //æ‰§è¡Œå­˜ç›˜æ“ä½œ\n    //çœç•¥ä¸”å®ç°\n    this.execSave();\n  }\n  //ç¼–è¾‘æ“ä½œ\n  void edit(){\n    //çœç•¥ç¼–è¾‘é€»è¾‘\n    ......\n    changed = true;\n  }\n}\n</code></pre><p>è§£å†³è¿™ä¸ªé—®é¢˜ç›¸ä¿¡ä½ ä¸€å®šæ‰‹åˆ°æ“’æ¥äº†ï¼šè¯»å†™å…±äº«å˜é‡changedçš„æ–¹æ³•autoSave()å’Œedit()éƒ½åŠ äº’æ–¥é”å°±å¯ä»¥äº†ã€‚è¿™æ ·åšè™½ç„¶ç®€å•ï¼Œä½†æ˜¯æ€§èƒ½å¾ˆå·®ï¼ŒåŸå› æ˜¯é”çš„èŒƒå›´å¤ªå¤§äº†ã€‚é‚£æˆ‘ä»¬å¯ä»¥å°†é”çš„èŒƒå›´ç¼©å°ï¼Œåªåœ¨è¯»å†™å…±äº«å˜é‡changedçš„åœ°æ–¹åŠ é”ï¼Œå®ç°ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>//è‡ªåŠ¨å­˜ç›˜æ“ä½œ\nvoid autoSave(){\n  synchronized(this){\n    if (!changed) {\n      return;\n    }\n    changed = false;\n  }\n  //æ‰§è¡Œå­˜ç›˜æ“ä½œ\n  //çœç•¥ä¸”å®ç°\n  this.execSave();\n}\n//ç¼–è¾‘æ“ä½œ\nvoid edit(){\n  //çœç•¥ç¼–è¾‘é€»è¾‘\n  ......\n  synchronized(this){\n    changed = true;\n  }\n}  \n</code></pre><p>å¦‚æœä½ æ·±å…¥åœ°åˆ†æä¸€ä¸‹è¿™ä¸ªç¤ºä¾‹ç¨‹åºï¼Œä½ ä¼šå‘ç°ï¼Œç¤ºä¾‹ä¸­çš„å…±äº«å˜é‡æ˜¯ä¸€ä¸ªçŠ¶æ€å˜é‡ï¼Œä¸šåŠ¡é€»è¾‘ä¾èµ–äºè¿™ä¸ªçŠ¶æ€å˜é‡çš„çŠ¶æ€ï¼šå½“çŠ¶æ€æ»¡è¶³æŸä¸ªæ¡ä»¶æ—¶ï¼Œæ‰§è¡ŒæŸä¸ªä¸šåŠ¡é€»è¾‘ï¼Œå…¶æœ¬è´¨å…¶å®ä¸è¿‡å°±æ˜¯ä¸€ä¸ªifè€Œå·²ï¼Œæ”¾åˆ°å¤šçº¿ç¨‹åœºæ™¯é‡Œï¼Œå°±æ˜¯ä¸€ç§â€œå¤šçº¿ç¨‹ç‰ˆæœ¬çš„ifâ€ã€‚è¿™ç§â€œå¤šçº¿ç¨‹ç‰ˆæœ¬çš„ifâ€çš„åº”ç”¨åœºæ™¯è¿˜æ˜¯å¾ˆå¤šçš„ï¼Œæ‰€ä»¥ä¹Ÿæœ‰äººæŠŠå®ƒæ€»ç»“æˆäº†ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œå«åš<strong>Balkingæ¨¡å¼</strong>ã€‚</p><!-- [[[read_end]]] --><h2>Balkingæ¨¡å¼çš„ç»å…¸å®ç°</h2><p>Balkingæ¨¡å¼æœ¬è´¨ä¸Šæ˜¯ä¸€ç§è§„èŒƒåŒ–åœ°è§£å†³â€œå¤šçº¿ç¨‹ç‰ˆæœ¬çš„ifâ€çš„æ–¹æ¡ˆï¼Œå¯¹äºä¸Šé¢è‡ªåŠ¨ä¿å­˜çš„ä¾‹å­ï¼Œä½¿ç”¨Balkingæ¨¡å¼è§„èŒƒåŒ–ä¹‹åçš„å†™æ³•å¦‚ä¸‹æ‰€ç¤ºï¼Œä½ ä¼šå‘ç°ä»…ä»…æ˜¯å°†edit()æ–¹æ³•ä¸­å¯¹å…±äº«å˜é‡changedçš„èµ‹å€¼æ“ä½œæŠ½å–åˆ°äº†change()ä¸­ï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯å°†å¹¶å‘å¤„ç†é€»è¾‘å’Œä¸šåŠ¡é€»è¾‘åˆ†å¼€ã€‚</p><pre><code>boolean changed=false;\n//è‡ªåŠ¨å­˜ç›˜æ“ä½œ\nvoid autoSave(){\n  synchronized(this){\n    if (!changed) {\n      return;\n    }\n    changed = false;\n  }\n  //æ‰§è¡Œå­˜ç›˜æ“ä½œ\n  //çœç•¥ä¸”å®ç°\n  this.execSave();\n}\n//ç¼–è¾‘æ“ä½œ\nvoid edit(){\n  //çœç•¥ç¼–è¾‘é€»è¾‘\n  ......\n  change();\n}\n//æ”¹å˜çŠ¶æ€\nvoid change(){\n  synchronized(this){\n    changed = true;\n  }\n}\n</code></pre><h2>ç”¨volatileå®ç°Balkingæ¨¡å¼</h2><p>å‰é¢æˆ‘ä»¬ç”¨synchronizedå®ç°äº†Balkingæ¨¡å¼ï¼Œè¿™ç§å®ç°æ–¹å¼æœ€ä¸ºç¨³å¦¥ï¼Œå»ºè®®ä½ å®é™…å·¥ä½œä¸­ä¹Ÿä½¿ç”¨è¿™ä¸ªæ–¹æ¡ˆã€‚ä¸è¿‡åœ¨æŸäº›ç‰¹å®šåœºæ™¯ä¸‹ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨volatileæ¥å®ç°ï¼Œä½†<strong>ä½¿ç”¨volatileçš„å‰ææ˜¯å¯¹åŸå­æ€§æ²¡æœ‰è¦æ±‚</strong>ã€‚</p><p>åœ¨<a href=\"https://time.geekbang.org/column/article/93154\">ã€Š29 | Copy-on-Writeæ¨¡å¼ï¼šä¸æ˜¯å»¶æ—¶ç­–ç•¥çš„COWã€‹</a>ä¸­ï¼Œæœ‰ä¸€ä¸ªRPCæ¡†æ¶è·¯ç”±è¡¨çš„æ¡ˆä¾‹ï¼Œåœ¨RPCæ¡†æ¶ä¸­ï¼Œæœ¬åœ°è·¯ç”±è¡¨æ˜¯è¦å’Œæ³¨å†Œä¸­å¿ƒè¿›è¡Œä¿¡æ¯åŒæ­¥çš„ï¼Œåº”ç”¨å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šå°†åº”ç”¨ä¾èµ–æœåŠ¡çš„è·¯ç”±è¡¨ä»æ³¨å†Œä¸­å¿ƒåŒæ­¥åˆ°æœ¬åœ°è·¯ç”±è¡¨ä¸­ï¼Œå¦‚æœåº”ç”¨é‡å¯çš„æ—¶å€™æ³¨å†Œä¸­å¿ƒå®•æœºï¼Œé‚£ä¹ˆä¼šå¯¼è‡´è¯¥åº”ç”¨ä¾èµ–çš„æœåŠ¡å‡ä¸å¯ç”¨ï¼Œå› ä¸ºæ‰¾ä¸åˆ°ä¾èµ–æœåŠ¡çš„è·¯ç”±è¡¨ã€‚ä¸ºäº†é˜²æ­¢è¿™ç§æç«¯æƒ…å†µå‡ºç°ï¼ŒRPCæ¡†æ¶å¯ä»¥å°†æœ¬åœ°è·¯ç”±è¡¨è‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶ä¸­ï¼Œå¦‚æœé‡å¯çš„æ—¶å€™æ³¨å†Œä¸­å¿ƒå®•æœºï¼Œé‚£ä¹ˆå°±ä»æœ¬åœ°æ–‡ä»¶ä¸­æ¢å¤é‡å¯å‰çš„è·¯ç”±è¡¨ã€‚è¿™å…¶å®ä¹Ÿæ˜¯ä¸€ç§é™çº§çš„æ–¹æ¡ˆã€‚</p><p>è‡ªåŠ¨ä¿å­˜è·¯ç”±è¡¨å’Œå‰é¢ä»‹ç»çš„ç¼–è¾‘å™¨è‡ªåŠ¨ä¿å­˜åŸç†æ˜¯ä¸€æ ·çš„ï¼Œä¹Ÿå¯ä»¥ç”¨Balkingæ¨¡å¼å®ç°ï¼Œä¸è¿‡æˆ‘ä»¬è¿™é‡Œé‡‡ç”¨volatileæ¥å®ç°ï¼Œå®ç°çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ä¹‹æ‰€ä»¥å¯ä»¥é‡‡ç”¨volatileæ¥å®ç°ï¼Œæ˜¯å› ä¸ºå¯¹å…±äº«å˜é‡changedå’Œrtçš„å†™æ“ä½œä¸å­˜åœ¨åŸå­æ€§çš„è¦æ±‚ï¼Œè€Œä¸”é‡‡ç”¨scheduleWithFixedDelay()è¿™ç§è°ƒåº¦æ–¹å¼èƒ½ä¿è¯åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡ŒautoSave()æ–¹æ³•ã€‚</p><pre><code>//è·¯ç”±è¡¨ä¿¡æ¯\npublic class RouterTable {\n  //Key:æ¥å£å\n  //Value:è·¯ç”±é›†åˆ\n  ConcurrentHashMap&lt;String, CopyOnWriteArraySet&lt;Router&gt;&gt; \n    rt = new ConcurrentHashMap&lt;&gt;();    \n  //è·¯ç”±è¡¨æ˜¯å¦å‘ç”Ÿå˜åŒ–\n  volatile boolean changed;\n  //å°†è·¯ç”±è¡¨å†™å…¥æœ¬åœ°æ–‡ä»¶çš„çº¿ç¨‹æ± \n  ScheduledExecutorService ses=\n    Executors.newSingleThreadScheduledExecutor();\n  //å¯åŠ¨å®šæ—¶ä»»åŠ¡\n  //å°†å˜æ›´åçš„è·¯ç”±è¡¨å†™å…¥æœ¬åœ°æ–‡ä»¶\n  public void startLocalSaver(){\n    ses.scheduleWithFixedDelay(()-&gt;{\n      autoSave();\n    }, 1, 1, MINUTES);\n  }\n  //ä¿å­˜è·¯ç”±è¡¨åˆ°æœ¬åœ°æ–‡ä»¶\n  void autoSave() {\n    if (!changed) {\n      return;\n    }\n    changed = false;\n    //å°†è·¯ç”±è¡¨å†™å…¥æœ¬åœ°æ–‡ä»¶\n    //çœç•¥å…¶æ–¹æ³•å®ç°\n    this.save2Local();\n  }\n  //åˆ é™¤è·¯ç”±\n  public void remove(Router router) {\n    Set&lt;Router&gt; set=rt.get(router.iface);\n    if (set != null) {\n      set.remove(router);\n      //è·¯ç”±è¡¨å·²å‘ç”Ÿå˜åŒ–\n      changed = true;\n    }\n  }\n  //å¢åŠ è·¯ç”±\n  public void add(Router router) {\n    Set&lt;Router&gt; set = rt.computeIfAbsent(\n      route.iface, r -&gt; \n        new CopyOnWriteArraySet&lt;&gt;());\n    set.add(router);\n    //è·¯ç”±è¡¨å·²å‘ç”Ÿå˜åŒ–\n    changed = true;\n  }\n}\n</code></pre><p>Balkingæ¨¡å¼æœ‰ä¸€ä¸ªéå¸¸å…¸å‹çš„åº”ç”¨åœºæ™¯å°±æ˜¯å•æ¬¡åˆå§‹åŒ–ï¼Œä¸‹é¢çš„ç¤ºä¾‹ä»£ç æ˜¯å®ƒçš„å®ç°ã€‚è¿™ä¸ªå®ç°æ–¹æ¡ˆä¸­ï¼Œæˆ‘ä»¬å°†init()å£°æ˜ä¸ºä¸€ä¸ªåŒæ­¥æ–¹æ³•ï¼Œè¿™æ ·åŒä¸€ä¸ªæ—¶åˆ»å°±åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿæ‰§è¡Œinit()æ–¹æ³•ï¼›init()æ–¹æ³•åœ¨ç¬¬ä¸€æ¬¡æ‰§è¡Œå®Œæ—¶ä¼šå°†initedè®¾ç½®ä¸ºtrueï¼Œè¿™æ ·åç»­æ‰§è¡Œinit()æ–¹æ³•çš„çº¿ç¨‹å°±ä¸ä¼šå†æ‰§è¡ŒdoInit()äº†ã€‚</p><pre><code>class InitTest{\n  boolean inited = false;\n  synchronized void init(){\n    if(inited){\n      return;\n    }\n    //çœç•¥doInitçš„å®ç°\n    doInit();\n    inited=true;\n  }\n}\n</code></pre><p>çº¿ç¨‹å®‰å…¨çš„å•ä¾‹æ¨¡å¼æœ¬è´¨ä¸Šå…¶å®ä¹Ÿæ˜¯å•æ¬¡åˆå§‹åŒ–ï¼Œæ‰€ä»¥å¯ä»¥ç”¨Balkingæ¨¡å¼æ¥å®ç°çº¿ç¨‹å®‰å…¨çš„å•ä¾‹æ¨¡å¼ï¼Œä¸‹é¢çš„ç¤ºä¾‹ä»£ç æ˜¯å…¶å®ç°ã€‚è¿™ä¸ªå®ç°è™½ç„¶åŠŸèƒ½ä¸Šæ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯æ€§èƒ½å´å¾ˆå·®ï¼Œå› ä¸ºäº’æ–¥é”synchronizedå°†getInstance()æ–¹æ³•ä¸²è¡ŒåŒ–äº†ï¼Œé‚£æœ‰æ²¡æœ‰åŠæ³•å¯ä»¥ä¼˜åŒ–ä¸€ä¸‹å®ƒçš„æ€§èƒ½å‘¢ï¼Ÿ</p><pre><code>class Singleton{\n  private static\n    Singleton singleton;\n  //æ„é€ æ–¹æ³•ç§æœ‰åŒ–  \n  private Singleton(){}\n  //è·å–å®ä¾‹ï¼ˆå•ä¾‹ï¼‰\n  public synchronized static \n  Singleton getInstance(){\n    if(singleton == null){\n      singleton=new Singleton();\n    }\n    return singleton;\n  }\n}\n</code></pre><p>åŠæ³•å½“ç„¶æ˜¯æœ‰çš„ï¼Œé‚£å°±æ˜¯ç»å…¸çš„<strong>åŒé‡æ£€æŸ¥</strong>ï¼ˆDouble Checkï¼‰æ–¹æ¡ˆï¼Œä¸‹é¢çš„ç¤ºä¾‹ä»£ç æ˜¯å…¶è¯¦ç»†å®ç°ã€‚åœ¨åŒé‡æ£€æŸ¥æ–¹æ¡ˆä¸­ï¼Œä¸€æ—¦Singletonå¯¹è±¡è¢«æˆåŠŸåˆ›å»ºä¹‹åï¼Œå°±ä¸ä¼šæ‰§è¡Œsynchronized(Singleton.class){}ç›¸å…³çš„ä»£ç ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ­¤æ—¶getInstance()æ–¹æ³•çš„æ‰§è¡Œè·¯å¾„æ˜¯æ— é”çš„ï¼Œä»è€Œè§£å†³äº†æ€§èƒ½é—®é¢˜ã€‚ä¸è¿‡éœ€è¦ä½ æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªæ–¹æ¡ˆä¸­ä½¿ç”¨äº†volatileæ¥ç¦æ­¢ç¼–è¯‘ä¼˜åŒ–ï¼Œå…¶åŸå› ä½ å¯ä»¥å‚è€ƒ<a href=\"https://time.geekbang.org/column/article/83682\">ã€Š01 | å¯è§æ€§ã€åŸå­æ€§å’Œæœ‰åºæ€§é—®é¢˜ï¼šå¹¶å‘ç¼–ç¨‹Bugçš„æºå¤´ã€‹</a>ä¸­ç›¸å…³çš„å†…å®¹ã€‚è‡³äºè·å–é”åçš„äºŒæ¬¡æ£€æŸ¥ï¼Œåˆ™æ˜¯å‡ºäºå¯¹å®‰å…¨æ€§è´Ÿè´£ã€‚</p><pre><code>class Singleton{\n  private static volatile \n    Singleton singleton;\n  //æ„é€ æ–¹æ³•ç§æœ‰åŒ–  \n  private Singleton() {}\n  //è·å–å®ä¾‹ï¼ˆå•ä¾‹ï¼‰\n  public static Singleton \n  getInstance() {\n    //ç¬¬ä¸€æ¬¡æ£€æŸ¥\n    if(singleton==null){\n      synchronize(Singleton.class){\n        //è·å–é”åäºŒæ¬¡æ£€æŸ¥\n        if(singleton==null){\n          singleton=new Singleton();\n        }\n      }\n    }\n    return singleton;\n  }\n}\n</code></pre><h2>æ€»ç»“</h2><p>Balkingæ¨¡å¼å’ŒGuarded Suspensionæ¨¡å¼ä»å®ç°ä¸Šçœ‹ä¼¼ä¹æ²¡æœ‰å¤šå¤§çš„å…³ç³»ï¼ŒBalkingæ¨¡å¼åªéœ€è¦ç”¨äº’æ–¥é”å°±èƒ½è§£å†³ï¼Œè€ŒGuarded Suspensionæ¨¡å¼åˆ™è¦ç”¨åˆ°ç®¡ç¨‹è¿™ç§é«˜çº§çš„å¹¶å‘åŸè¯­ï¼›ä½†æ˜¯ä»åº”ç”¨çš„è§’åº¦æ¥çœ‹ï¼Œå®ƒä»¬è§£å†³çš„éƒ½æ˜¯â€œçº¿ç¨‹å®‰å…¨çš„ifâ€è¯­ä¹‰ï¼Œä¸åŒä¹‹å¤„åœ¨äºï¼ŒGuarded Suspensionæ¨¡å¼ä¼šç­‰å¾…ifæ¡ä»¶ä¸ºçœŸï¼Œè€ŒBalkingæ¨¡å¼ä¸ä¼šç­‰å¾…ã€‚</p><p>Balkingæ¨¡å¼çš„ç»å…¸å®ç°æ˜¯ä½¿ç”¨äº’æ–¥é”ï¼Œä½ å¯ä»¥ä½¿ç”¨Javaè¯­è¨€å†…ç½®synchronizedï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨SDKæä¾›Lockï¼›å¦‚æœä½ å¯¹äº’æ–¥é”çš„æ€§èƒ½ä¸æ»¡æ„ï¼Œå¯ä»¥å°è¯•é‡‡ç”¨volatileæ–¹æ¡ˆï¼Œä¸è¿‡ä½¿ç”¨volatileæ–¹æ¡ˆéœ€è¦ä½ æ›´åŠ è°¨æ…ã€‚</p><p>å½“ç„¶ä½ ä¹Ÿå¯ä»¥å°è¯•ä½¿ç”¨åŒé‡æ£€æŸ¥æ–¹æ¡ˆæ¥ä¼˜åŒ–æ€§èƒ½ï¼ŒåŒé‡æ£€æŸ¥ä¸­çš„ç¬¬ä¸€æ¬¡æ£€æŸ¥ï¼Œå®Œå…¨æ˜¯å‡ºäºå¯¹æ€§èƒ½çš„è€ƒé‡ï¼šé¿å…æ‰§è¡ŒåŠ é”æ“ä½œï¼Œå› ä¸ºåŠ é”æ“ä½œå¾ˆè€—æ—¶ã€‚è€ŒåŠ é”ä¹‹åçš„äºŒæ¬¡æ£€æŸ¥ï¼Œåˆ™æ˜¯å‡ºäºå¯¹å®‰å…¨æ€§è´Ÿè´£ã€‚åŒé‡æ£€æŸ¥æ–¹æ¡ˆåœ¨ä¼˜åŒ–åŠ é”æ€§èƒ½æ–¹é¢ç»å¸¸ç”¨åˆ°ï¼Œä¾‹å¦‚<a href=\"https://time.geekbang.org/column/article/88909\">ã€Š17 | ReadWriteLockï¼šå¦‚ä½•å¿«é€Ÿå®ç°ä¸€ä¸ªå®Œå¤‡çš„ç¼“å­˜ï¼Ÿã€‹</a>ä¸­å®ç°ç¼“å­˜æŒ‰éœ€åŠ è½½åŠŸèƒ½æ—¶ï¼Œä¹Ÿç”¨åˆ°äº†åŒé‡æ£€æŸ¥æ–¹æ¡ˆã€‚</p><h2>è¯¾åæ€è€ƒ</h2><p>ä¸‹é¢çš„ç¤ºä¾‹ä»£ç ä¸­ï¼Œinit()æ–¹æ³•çš„æœ¬æ„æ˜¯ï¼šä»…éœ€è®¡ç®—ä¸€æ¬¡countçš„å€¼ï¼Œé‡‡ç”¨äº†Balkingæ¨¡å¼çš„volatileå®ç°æ–¹å¼ï¼Œä½ è§‰å¾—è¿™ä¸ªå®ç°æ˜¯å¦æœ‰é—®é¢˜å‘¢ï¼Ÿ</p><pre><code>class Test{\n  volatile boolean inited = false;\n  int count = 0;\n  void init(){\n    if(inited){\n      return;\n    }\n    inited = true;\n    //è®¡ç®—countçš„å€¼\n    count = calc();\n  }\n}  \n</code></pre><p>æ¬¢è¿åœ¨ç•™è¨€åŒºä¸æˆ‘åˆ†äº«ä½ çš„æƒ³æ³•ï¼Œä¹Ÿæ¬¢è¿ä½ åœ¨ç•™è¨€åŒºè®°å½•ä½ çš„æ€è€ƒè¿‡ç¨‹ã€‚æ„Ÿè°¢é˜…è¯»ï¼Œå¦‚æœä½ è§‰å¾—è¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©çš„è¯ï¼Œä¹Ÿæ¬¢è¿æŠŠå®ƒåˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹ã€‚</p>","neighbors":{"left":{"article_title":"31 | Guarded Suspensionæ¨¡å¼ï¼šç­‰å¾…å”¤é†’æœºåˆ¶çš„è§„èŒƒå®ç°","id":94097},"right":{"article_title":"33 | Thread-Per-Messageæ¨¡å¼ï¼šæœ€ç®€å•å®ç”¨çš„åˆ†å·¥æ–¹æ³•","id":95098}},"comments":[{"had_liked":false,"id":93619,"user_name":"zero","can_delete":false,"product_type":"c1","uid":1299615,"ip_address":"","ucode":"528DD5C8399AEC","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKlwpFM3tkeG15YqyJTYWkfqkdmro9POq6SicYm57TaEFDOUZCXjoe0Z0Iz6UibGQqic3icJRsHdFzibtw/132","comment_is_top":false,"comment_ctime":1557536879,"is_pvip":true,"replies":[{"id":"33803","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç‹å®ä»¤","uid":"1269969","ctime":1557843670,"ip_address":"","comment_id":93619,"utype":1}],"discussion_count":3,"race_medal":0,"score":"224895836271","product_id":100023901,"comment_content":"æ˜¯æœ‰é—®é¢˜çš„ï¼Œvolatileå…³é”®å­—åªèƒ½ä¿è¯å¯è§æ€§ï¼Œæ— æ³•ä¿è¯åŸå­æ€§å’Œäº’æ–¥æ€§ã€‚æ‰€ä»¥calcæ–¹æ³•æœ‰å¯èƒ½è¢«é‡å¤æ‰§è¡Œã€‚","like_count":53,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":449702,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1557843670,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1057179,"avatar":"https://static001.geekbang.org/account/avatar/00/10/21/9b/347301f6.jpg","nickname":"å…³ç¾½","note":"","ucode":"6FC2CDA20191DB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":298692,"discussion_content":"é‚£ä¸ºä»€ä¹ˆç­¾åå•ä¾‹çš„åŒé‡æ£€æŸ¥å¯ä»¥ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597379339,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1687656,"avatar":"https://static001.geekbang.org/account/avatar/00/19/c0/68/314e8306.jpg","nickname":"å¨å…ˆæ£®","note":"","ucode":"5F445C6832274B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1057179,"avatar":"https://static001.geekbang.org/account/avatar/00/10/21/9b/347301f6.jpg","nickname":"å…³ç¾½","note":"","ucode":"6FC2CDA20191DB","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":410992,"discussion_content":"åŒé‡æ•ˆéªŒåœ¨synchronizedé˜»å¡äº†å¤šçº¿ç¨‹ï¼Œä¿è¯äº†äº’æ–¥æ€§ï¼Œé‡Œé¢çš„åˆ¤æ–­ä¿è¯äº†å®‰å…¨æ€§ï¼Œåœ¨ç¬¬ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†flagæ ‡è¯†åï¼Œç¬¬äºŒä¸ªçº¿ç¨‹ä¸ä¼šè·³è¿‡å¯¹flagæ ‡è¯†çš„åˆ¤æ–­ï¼Œä¸ä¼šæœ‰é‡å¤æ‰§è¡Œçš„é—®é¢˜","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1635821995,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":298692,"ip_address":""},"score":410992,"extra":""}]}]},{"had_liked":false,"id":94548,"user_name":"leon","can_delete":false,"product_type":"c1","uid":1217955,"ip_address":"","ucode":"97610F35D2543A","user_header":"https://static001.geekbang.org/account/avatar/00/12/95/a3/0a3cde60.jpg","comment_is_top":false,"comment_ctime":1557838803,"is_pvip":false,"replies":[{"id":"33798","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç‹å®ä»¤","uid":"1269969","ctime":1557842834,"ip_address":"","comment_id":94548,"utype":1}],"discussion_count":1,"race_medal":0,"score":"194831367123","product_id":100023901,"comment_content":"æ€è€ƒé¢˜ä»£ç ç›¸å½“äºï¼š<br>ifï¼ˆintied == falseï¼‰ {  &#47;&#47; 1<br>     inited = true;          &#47;&#47;2<br>     count = calc()<br>}<br><br>å¯èƒ½æœ‰å¤šæ¡çº¿ç¨‹åŒæ—¶åˆ°1çš„ä½ç½®ï¼Œåˆ¤æ–­åˆ°initedä¸ºfalseï¼Œéƒ½è¿›å…¥2æ‰§è¡Œã€‚<br>è§£å†³æ–¹æ¡ˆï¼š<br>ï¼ˆ1ï¼‰åŠ é”ä¿æŠ¤ä¸´ç•ŒåŒº<br>ï¼ˆ2ï¼‰ AtomicBoolean.compareAndSet(false, true)<br>","like_count":46,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":450103,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1557842834,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":93735,"user_name":"Corner","can_delete":false,"product_type":"c1","uid":1446316,"ip_address":"","ucode":"7862D593172536","user_header":"https://static001.geekbang.org/account/avatar/00/16/11/ac/9cc5e692.jpg","comment_is_top":false,"comment_ctime":1557574483,"is_pvip":false,"replies":[{"id":"33943","content":"å®šæ—¶å™¨ä»»åŠ¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼ŒautosaveåŠ ä¸åŠ åŒæ­¥å°±æ— æ‰€è°“äº†ï¼Œå¤šä¿å­˜ä¸€æ¬¡ä¹Ÿæ²¡å…³ç³»ï¼Œè¿™ç§æ¦‚ç‡æ¯•ç«Ÿå¾ˆå°<br>","user_name":"ä½œè€…å›å¤","user_name_real":"ç‹å®ä»¤","uid":"1269969","ctime":1557931081,"ip_address":"","comment_id":93735,"utype":1}],"discussion_count":4,"race_medal":0,"score":"65982083923","product_id":100023901,"comment_content":"æœ€å¥½å°±ä¸è¦å•ç‹¬ä½¿ç”¨volatileé˜²æ­¢äº§ç”Ÿçº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚å› ä¸ºå˜é‡çš„è¯»å†™æ˜¯ä¸¤ä¸ªæ“ä½œï¼Œå’Œæˆ‘ä»¬çš„ç›´è§‰ä¸ä¸€æ ·ï¼Œå¾ˆå®¹æ˜“å‡ºé—®é¢˜ã€‚è€å¸ˆçš„é‚£ä¸ªvolatileå°±æ²¡æœ‰é—®é¢˜å—ï¼Ÿå¦‚æœä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†è·¯ç”±è¡¨ï¼Œæ­¤æ—¶å®šæ—¶å™¨ä»»åŠ¡åˆ¤æ–­å…±äº«å˜é‡ä¸ºtrueï¼Œåœ¨å°†å…¶ä¿®æ”¹ä¸ºfalseä¹‹å‰ï¼Œæ­¤æ—¶å¦ä¸€ä¸ªçº¿ç¨‹åˆä¿®æ”¹äº†è·¯ç”±è¡¨ï¼Œç„¶åå®šæ—¶ä»»åŠ¡ç»§ç»­æ‰§è¡Œä¼šå°†å…¶ä¿®æ”¹ä¸ºfalseï¼Œè¿™å°±å‡ºç°é—®é¢˜äº†ã€‚æœ€åè¿˜æ˜¯è¦åœ¨autoSaveæ–¹æ³•ä¸ŠåšåŒæ­¥çš„ã€‚","like_count":15,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":449752,"discussion_content":"å®šæ—¶å™¨ä»»åŠ¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼ŒautosaveåŠ ä¸åŠ åŒæ­¥å°±æ— æ‰€è°“äº†ï¼Œå¤šä¿å­˜ä¸€æ¬¡ä¹Ÿæ²¡å…³ç³»ï¼Œè¿™ç§æ¦‚ç‡æ¯•ç«Ÿå¾ˆå°\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1557931081,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1446728,"avatar":"https://static001.geekbang.org/account/avatar/00/16/13/48/54e8250b.jpg","nickname":"frandblinkc","note":"","ucode":"B5CD43CAA76866","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":373813,"discussion_content":"è·¯ç”±è¡¨ä¿®æ”¹äº†ä¸¤æ¬¡, autosaveä¸€æ¬¡æ²¡æœ‰é—®é¢˜å•Š, autosaveå­˜çš„æ˜¯æ‰€æœ‰çš„è·¯ç”±è¡¨ä¿¡æ¯, è€Œä¸æ˜¯æ”¹åŠ¨çš„éƒ¨åˆ†.\n\nè¿™é‡Œä¹‹æ‰€ä»¥ä¸è¦æ±‚changeçš„åŸå­æ€§æ­£æ˜¯å› ä¸ºautoSave() ä¸­, changedè¯»å’Œå†™ä¹‹é—´æœ‰remove() æˆ–è€… add()æ–¹æ³•å°†changed æ›´æ”¹ä¸ºtrue, ç„¶åè¢«è¦†ç›–ä¸ºfalseå®Œå…¨ä¸å½±å“autosave.\n\nè€ŒScheduledExecutorService ä¿è¯ä¸€æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œ autoSave(), autoSaveä¹‹é—´ä¸å­˜åœ¨contention.","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1620882262,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1361746,"avatar":"https://static001.geekbang.org/account/avatar/00/14/c7/52/c5adf218.jpg","nickname":"å–œæ¬¢åœ°çƒçš„é˜¿åŸ¹åŒå­¦","note":"","ucode":"5F97037585F857","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":167318,"discussion_content":"è€å¸ˆï¼Œè¿™åº”è¯¥ä¸æ˜¯ å¤šä¿å­˜ä¸€æ¬¡çš„å…³ç³»å§ã€‚è€Œæ˜¯è·¯ç”±è¡¨ä¿®æ”¹æœ‰ä¸¤æ¬¡ï¼Œä½†åªæ‰§è¡Œäº†ä¸€æ¬¡ä¿å­˜æ“ä½œã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581477372,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1135604,"avatar":"https://static001.geekbang.org/account/avatar/00/11/53/f4/e277325d.jpg","nickname":"bin.chen","note":"","ucode":"5BA49358AB8A1A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1361746,"avatar":"https://static001.geekbang.org/account/avatar/00/14/c7/52/c5adf218.jpg","nickname":"å–œæ¬¢åœ°çƒçš„é˜¿åŸ¹åŒå­¦","note":"","ucode":"5F97037585F857","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":283129,"discussion_content":"ä¿å­˜çš„ä¸€æ¬¡ä¹Ÿæ˜¯æœ€æ–°çš„è·¯ç”±ä¿¡æ¯-ä¸å½±å“æ•°æ®çš„æ­£ç¡®æ€§ï¼›ä¸è¿‡ä¸ºäº†é˜²æ­¢é”™è¯¯æ¦‚ç‡è¿˜æ˜¯ä½¿ç”¨CASæ¥ç®€å•çš„è§£å†³ä¸€ä¸‹è¿˜æ˜¯å¯ä»¥çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592191758,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":167318,"ip_address":""},"score":283129,"extra":""}]}]},{"had_liked":false,"id":94368,"user_name":"å­™å¿—å¼º","can_delete":false,"product_type":"c1","uid":1325997,"ip_address":"","ucode":"9C070F1E4EC6FF","user_header":"https://static001.geekbang.org/account/avatar/00/14/3b/ad/31193b83.jpg","comment_is_top":false,"comment_ctime":1557796711,"is_pvip":true,"replies":[{"id":"33940","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç‹å®ä»¤","uid":"1269969","ctime":1557930686,"ip_address":"","comment_id":94368,"utype":1}],"discussion_count":1,"race_medal":0,"score":"57392371559","product_id":100023901,"comment_content":"initedå˜é‡éœ€è¦ä½¿ç”¨CASçš„æ–¹å¼è¿›è¡Œèµ‹å€¼ï¼Œèµ‹å€¼å¤±è´¥å°±returnï¼Œä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥ä¿®æ”¹initedå˜é‡ã€‚","like_count":14,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":450040,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1557930686,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":93594,"user_name":"éƒ‘æ™¨Cc","can_delete":false,"product_type":"c1","uid":1324942,"ip_address":"","ucode":"57146E444D6329","user_header":"https://static001.geekbang.org/account/avatar/00/14/37/8e/cf0b4575.jpg","comment_is_top":false,"comment_ctime":1557512509,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"35917250877","product_id":100023901,"comment_content":"ç¬¬8è¡Œ inited = trueï¼›æ”¹æˆcasæ“ä½œ<br>å¤±è´¥ç›´æ¥returnã€‚æˆåŠŸç»§ç»­æ‰§è¡Œcalæ–¹æ³•","like_count":9},{"had_liked":false,"id":121511,"user_name":"å²¥ç¾½","can_delete":false,"product_type":"c1","uid":1391037,"ip_address":"","ucode":"0CD1C34BD7CD4F","user_header":"https://static001.geekbang.org/account/avatar/00/15/39/bd/74059999.jpg","comment_is_top":false,"comment_ctime":1565149662,"is_pvip":false,"replies":[{"id":"94109","content":"booleanå˜é‡è¯»å†™æ˜¯ä¸€æ¡æœºå™¨æŒ‡ä»¤å®Œæˆçš„","user_name":"ä½œè€…å›å¤","user_name_real":"ç‹å®ä»¤","uid":"1269969","ctime":1604447042,"ip_address":"","comment_id":121511,"utype":1}],"discussion_count":2,"race_medal":0,"score":"23039986142","product_id":100023901,"comment_content":"è€å¸ˆï¼Œè‡ªåŠ¨ä¿å­˜è·¯ç”±è¡¨ç”¨ Balking æ¨¡å¼çš„volatileæ–¹å¼å®ç°ä¸­ï¼Œä¸ºä»€ä¹ˆå¯¹å…±äº«å˜é‡ changed å’Œ rt çš„å†™æ“ä½œä¸å­˜åœ¨åŸå­æ€§çš„è¦æ±‚ï¼Ÿ","like_count":5,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":461828,"discussion_content":"booleanå˜é‡è¯»å†™æ˜¯ä¸€æ¡æœºå™¨æŒ‡ä»¤å®Œæˆçš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604447042,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1596047,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIlZ9AObDSXrfSEibY94uyQvMQ4tOvbb7iaQH9H7QQ6ibNaqFKUGq1TboaFpBSLuP0MCcSXvmqHNg0IA/132","nickname":"Geek_8c5f9c","note":"","ucode":"70CD441EAF490F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":187595,"discussion_content":"æˆ‘è§‰å¾—æ˜¯æœ‰åŸå­æ€§çš„è¦æ±‚çš„, åªæ˜¯åŸå­æ€§ä¸éœ€è¦é¢å¤–å†™ç¨‹åºæ¥ä¿è¯ã€‚booleanç±»å‹çš„æ“ä½œåŸæœ¬å°±æ˜¯åŸå­æ€§çš„ã€‚ConcurrentHashMapå’ŒCopyOnWriteArraySetçš„å†™æ“ä½œä¹Ÿæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥è¿™é‡Œç”¨volatileå°±ä¿è¯å¯è§æ€§å°±å¤Ÿäº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582738620,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":93621,"user_name":"é”¦","can_delete":false,"product_type":"c1","uid":1468298,"ip_address":"","ucode":"CB0EB4B68C468B","user_header":"https://static001.geekbang.org/account/avatar/00/16/67/8a/babd74dc.jpg","comment_is_top":false,"comment_ctime":1557536947,"is_pvip":false,"replies":[{"id":"34451","content":"ä½ æ²¡æœ‰åŠæ³•æ§åˆ¶è°ƒç”¨æ–¹çš„çº¿ç¨‹æ•°ï¼Œautosaveä½ æ˜¯èƒ½æ§åˆ¶çš„ã€‚ä¸è¿‡åŠ é”ä»¥åå°±ä¸²è¡Œäº†","user_name":"ä½œè€…å›å¤","user_name_real":"ç‹å®ä»¤","uid":"1269969","ctime":1558361816,"ip_address":"","comment_id":93621,"utype":1}],"discussion_count":1,"race_medal":0,"score":"23032373427","product_id":100023901,"comment_content":"å›ç­”é—®é¢˜ï¼š<br>æœ‰é—®é¢˜ï¼Œvolatileä¸èƒ½ä¿è¯åŸå­æ€§ï¼Œé¢˜ç›®è¦æ±‚åªéœ€è®¡ç®—ä¸€æ¬¡Countï¼Œæ‰€ä»¥éœ€è¦å¯¹å…±äº«å˜é‡initedåŠ é”ä¿æŠ¤ã€‚<br><br>ç–‘é—®ï¼š<br>public class RouterTable ç±»ä¸­AutoSaveæ–¹æ³•åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ï¼Œè€ŒRemoveå’ŒAddæ–¹æ³•ä¹Ÿæ˜¯è¦æ±‚ä½¿ç”¨æ–¹å•çº¿ç¨‹è®¿é—®å—ï¼Ÿåœ¨å®é™…å¼€å‘ä¸­ä¸€èˆ¬é‡‡ç”¨ä»€ä¹ˆæ–¹å¼è¾¾æˆè¿™ç§çº¦å®šå‘¢ï¼Ÿ","like_count":5,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":449703,"discussion_content":"ä½ æ²¡æœ‰åŠæ³•æ§åˆ¶è°ƒç”¨æ–¹çš„çº¿ç¨‹æ•°ï¼Œautosaveä½ æ˜¯èƒ½æ§åˆ¶çš„ã€‚ä¸è¿‡åŠ é”ä»¥åå°±ä¸²è¡Œäº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1558361816,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":104092,"user_name":"Jxin","can_delete":false,"product_type":"c1","uid":1251111,"ip_address":"","ucode":"4C03928388C413","user_header":"https://static001.geekbang.org/account/avatar/00/13/17/27/ec30d30a.jpg","comment_is_top":false,"comment_ctime":1560649573,"is_pvip":false,"replies":[{"id":"38362","content":"å±€éƒ¨å˜é‡æ˜¯ä¸ä¼šåœ¨çº¿ç¨‹é—´å…±äº«çš„ï¼Œä¹Ÿæ²¡æœ‰volatileç‰¹æ€§","user_name":"ä½œè€…å›å¤","user_name_real":"ç‹å®ä»¤","uid":"1269969","ctime":1561192161,"ip_address":"","comment_id":104092,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18740518757","product_id":100023901,"comment_content":"volativeä¿®é¥°çš„å±æ€§ã€‚æˆ‘è§è¿‡åœ¨æ–¹æ³•ä¸­ã€‚ç”¨å±€éƒ¨å˜é‡æ¥æ”¶è¯¥å±æ€§å€¼ï¼Œæ–¹æ³•åç»­çš„æ“ä½œéƒ½åŸºäºè¯¥å±€éƒ¨å˜é‡ã€‚è¿™æ ·æ˜¯ä¸æ˜¯å°±ä¸å†æœ‰volativeçš„ç‰¹æ€§äº†ï¼Ÿæ€§èƒ½è™½ç„¶æé«˜äº†ï¼Œæ¯•ç«Ÿèƒ½èµ°ç¼“å­˜å’Œç¼–è¯‘ä¼˜åŒ–äº†ã€‚ä½†æ˜¯å°±åƒä¸Šä¾‹åŒé‡æ£€æŸ¥çš„åœºæ™¯ã€‚è¿™ä¹ˆä¸ªæ“ä½œå°±ä¾æ—§ä¼šæœ‰ç©ºæŒ‡é’ˆå¼‚å¸¸çš„å¯èƒ½ã€‚è¯·é—®è€å¸ˆæˆ‘ç†è§£å¯¹å—ã€‚","like_count":4,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":454122,"discussion_content":"å±€éƒ¨å˜é‡æ˜¯ä¸ä¼šåœ¨çº¿ç¨‹é—´å…±äº«çš„ï¼Œä¹Ÿæ²¡æœ‰volatileç‰¹æ€§","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561192161,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":129406,"user_name":"é€†æµçš„é±¼","can_delete":false,"product_type":"c1","uid":1258399,"ip_address":"","ucode":"AA3DDE44A83C40","user_header":"https://static001.geekbang.org/account/avatar/00/13/33/9f/8dbd9558.jpg","comment_is_top":false,"comment_ctime":1567126281,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"14452028169","product_id":100023901,"comment_content":"è¿™ä¸¤ä¸ªæ¨¡å¼æ€ä¹ˆè¿™ä¹ˆè¿å’Œï¼Œçªå…€ï¼Œè™å¤´è™è„‘çš„","like_count":3},{"had_liked":false,"id":93661,"user_name":"J.M.Liu","can_delete":false,"product_type":"c1","uid":1200037,"ip_address":"","ucode":"B2CB84B8E923A6","user_header":"https://static001.geekbang.org/account/avatar/00/12/4f/a5/71358d7b.jpg","comment_is_top":false,"comment_ctime":1557551163,"is_pvip":false,"replies":[{"id":"33676","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç‹å®ä»¤","uid":"1269969","ctime":1557758003,"ip_address":"","comment_id":93661,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14442453051","product_id":100023901,"comment_content":"æœ‰é—®é¢˜ï¼Œå­˜åœ¨ç«æ€æ¡ä»¶","like_count":3,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":449718,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1557758003,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":93663,"user_name":"çƒ­å°","can_delete":false,"product_type":"c1","uid":1316603,"ip_address":"","ucode":"7F49BBDD170CA8","user_header":"https://static001.geekbang.org/account/avatar/00/14/16/fb/c8a52099.jpg","comment_is_top":false,"comment_ctime":1557551858,"is_pvip":false,"replies":[{"id":"33675","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç‹å®ä»¤","uid":"1269969","ctime":1557757994,"ip_address":"","comment_id":93663,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10147486450","product_id":100023901,"comment_content":"å›ç­”é—®é¢˜<br>1ï¼Œcalï¼ˆï¼‰å¯èƒ½è¢«æ‰§è¡Œå¤šæ¬¡<br>2.  ä¹Ÿå¯èƒ½calï¼ˆï¼‰æ‰§è¡Œç»“æŸå‰ï¼Œcountå°±è¢«ä½¿ç”¨<br><br>è§£å†³æ–¹æ³•<br>inited èµ‹å€¼å’Œcalï¼ˆï¼‰æ‰§è¡Œæ”¾åœ¨ä¸€ä¸ªåŒæ­¥å—ä¸­ï¼Œå¹¶å¢åŠ åŒé‡check","like_count":2,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":449720,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1557757994,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":350367,"user_name":"ç å°å‘†","can_delete":false,"product_type":"c1","uid":2055809,"ip_address":"","ucode":"44532D6ABF9340","user_header":"https://static001.geekbang.org/account/avatar/00/1f/5e/81/82709d6e.jpg","comment_is_top":false,"comment_ctime":1656856171,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1656856171","product_id":100023901,"comment_content":"æ„Ÿè§‰éœ€è¦åŠ é”,æ— æ³•ä¿è¯åŸå­æ€§","like_count":0},{"had_liked":false,"id":318298,"user_name":"èŠ±è›‹å£³","can_delete":false,"product_type":"c1","uid":1111006,"ip_address":"","ucode":"917BB219120BD2","user_header":"https://static001.geekbang.org/account/avatar/00/10/f3/de/c6509355.jpg","comment_is_top":false,"comment_ctime":1635235533,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1635235533","product_id":100023901,"comment_content":"æŠŠä»£ç  inited = true; æ”¾åœ¨ initæ–¹æ³•ç¬¬ä¸€è¡Œæ‰§è¡Œå¯ä¸å¯è¡Œï¼Ÿ","like_count":0},{"had_liked":false,"id":308414,"user_name":"å¬é£æœ‰ä¿¡","can_delete":false,"product_type":"c1","uid":2683430,"ip_address":"","ucode":"2CCB467114FF5C","user_header":"https://static001.geekbang.org/account/avatar/00/28/f2/26/a8ac6b42.jpg","comment_is_top":false,"comment_ctime":1629612368,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1629612368","product_id":100023901,"comment_content":"AutoSaveEditoræ˜¯ä¸æ˜¯ä¹Ÿå¯ä»¥ç”¨volatileä¿è¯å¯è§æ€§å°±è¡Œäº†ï¼Ÿ","like_count":0},{"had_liked":false,"id":284196,"user_name":"ä¿ºèƒ½å­¦ä¸ªå•¥","can_delete":false,"product_type":"c1","uid":1026742,"ip_address":"","ucode":"30740C5B58774C","user_header":"https://static001.geekbang.org/account/avatar/00/0f/aa/b6/46a5bbf3.jpg","comment_is_top":false,"comment_ctime":1616118551,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1616118551","product_id":100023901,"comment_content":"å¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œå®Œifåˆ¤æ–­åè¿›å…¥åˆ°inited=trueèµ‹å€¼æ“ä½œï¼Œè¿™ä¸€æ­¥æ— æ³•ç¡®è®¤å•ä¸ªçº¿ç¨‹é€šè¿‡ï¼Œå¯ä»¥å¯¹ifåˆ¤æ–­éƒ¨åˆ†åŠ é”","like_count":0},{"had_liked":false,"id":247623,"user_name":"geoxs","can_delete":false,"product_type":"c1","uid":1147331,"ip_address":"","ucode":"1B377DB0A58F89","user_header":"","comment_is_top":false,"comment_ctime":1599781651,"is_pvip":false,"replies":[{"id":"91015","content":"æœ‰æ²¡æœ‰å¹¶å‘é—®é¢˜å¯ä»¥å¤šçœ‹çœ‹ç¬¬ä¸€éƒ¨åˆ†","user_name":"ä½œè€…å›å¤","user_name_real":"ç‹å®ä»¤","uid":"1269969","ctime":1599915913,"ip_address":"","comment_id":247623,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1599781651","product_id":100023901,"comment_content":"æˆ‘æœ‰ä¸ªé—®é¢˜ï¼Œå¦‚æœéœ€æ±‚ä¸è¦æ±‚åªæ‰§è¡Œä¸€æ¬¡å‘¢ï¼Œæ¯”å¦‚è®¡ç®—å¾ˆç®€å•ï¼Œè€—è´¹èµ„æºä¸å¤§ï¼Œå¤šè®¡ç®—å‡ æ¬¡æ˜¯å¯ä»¥æ¥å—çš„ï¼Œå¯ä¸å¯ä»¥è¿™æ ·å†™ï¼Œæœ‰æ²¡æœ‰å¹¶å‘é—®é¢˜å‘¢ï¼Œç”šè‡³æˆ‘æŠŠvolitaleå…³é”®å­—å»æ‰å¯ä¸å¯ä»¥å‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":505455,"discussion_content":"æœ‰æ²¡æœ‰å¹¶å‘é—®é¢˜å¯ä»¥å¤šçœ‹çœ‹ç¬¬ä¸€éƒ¨åˆ†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599915913,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":226735,"user_name":"bin.chen","can_delete":false,"product_type":"c1","uid":1135604,"ip_address":"","ucode":"5BA49358AB8A1A","user_header":"https://static001.geekbang.org/account/avatar/00/11/53/f4/e277325d.jpg","comment_is_top":false,"comment_ctime":1592191955,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1592191955","product_id":100023901,"comment_content":"1.è®¡ç®—countå€¼ä¼šé€ æˆæ‰§è¡Œå¤šæ¬¡<br>è§£å†³æ–¹æ¡ˆ1:ä¸ä½¿ç”¨volatile ç›´æ¥ä½¿ç”¨é”è§£å†³<br>è§£å†³æ–¹æ¡ˆ2:è®¾ç½®inited=trueçš„åœ°æ–¹ä½¿ç”¨CASç±»è§£å†³å¤šæ¬¡é‡å¤æ“ä½œæ‰§è¡Œè®¡ç®—çš„é—®é¢˜","like_count":0},{"had_liked":false,"id":224682,"user_name":"Just","can_delete":false,"product_type":"c1","uid":2022626,"ip_address":"","ucode":"35FA6917DE1D04","user_header":"https://static001.geekbang.org/account/avatar/00/1e/dc/e2/a3abd320.jpg","comment_is_top":false,"comment_ctime":1591505974,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1591505974","product_id":100023901,"comment_content":"1ï¼‰å¹¶å‘æƒ…å†µä¸‹ï¼Œcalcä¼šè¢«æ‰§è¡Œå¤šæ¬¡<br>2ï¼‰countçš„å€¼æœ‰å¯èƒ½ä¸æ­£ç¡®","like_count":0},{"had_liked":false,"id":217421,"user_name":"æ¹®æ±","can_delete":false,"product_type":"c1","uid":1106268,"ip_address":"","ucode":"FB6185621891E5","user_header":"https://static001.geekbang.org/account/avatar/00/10/e1/5c/86606d9c.jpg","comment_is_top":false,"comment_ctime":1589502674,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1589502674","product_id":100023901,"comment_content":"ç”¨ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå»æ§åˆ¶ä¸šåŠ¡ä»£ç çš„æµç¨‹ã€‚ä½†æ˜¯è¦æ³¨æ„è¿™ä¸ªä¸šåŠ¡ä»£ç çš„æµç¨‹ä¼šä¸ä¼šå­˜åœ¨â€œå¹¶å‘â€ï¼Œå¦‚æœä¸å­˜åœ¨å¹¶å‘ï¼Œå¯ä»¥åªç”¨volatileï¼›å¦‚æœå­˜åœ¨ï¼Œé‚£ä¹ˆå¿…é¡»è¦ç”¨ç®¡ç¨‹æ§åˆ¶åŸå­æ€§ï¼","like_count":0,"discussions":[{"author":{"id":1493907,"avatar":"https://static001.geekbang.org/account/avatar/00/16/cb/93/4adea49a.jpg","nickname":"åŠªåŠ›åŠªåŠ›å†åŠªåŠ›","note":"","ucode":"0C6EEA28FCE8C7","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583970,"discussion_content":"å“ˆå“ˆå“ˆï¼Œæ±ç¥ï¼Œæˆ‘æ¬£å¥","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660539062,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å¹¿ä¸œ"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":210215,"user_name":"å¿†æ°´å¯’","can_delete":false,"product_type":"c1","uid":1147453,"ip_address":"","ucode":"E3F86BD8AA8903","user_header":"https://static001.geekbang.org/account/avatar/00/11/82/3d/356fc3d6.jpg","comment_is_top":false,"comment_ctime":1587698824,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1587698824","product_id":100023901,"comment_content":"è‚¯å®šæœ‰é—®é¢˜çš„ï¼Œæœ€ç®€å•çš„å¯ä»¥åŠ ä¸ªsynchronizeè§£å†³ã€‚å°±åƒä¸Šé¢InitTestç±»åˆå§‹åŒ–ä¸€æ¬¡ä¸€æ ·è§£å†³ã€‚","like_count":0},{"had_liked":false,"id":203110,"user_name":"Geek_c22199","can_delete":false,"product_type":"c1","uid":1441876,"ip_address":"","ucode":"1CE5B65513E360","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI2vn8hyjICTCletGs0omz28lhriaZKX2XX9icYzAEon2IEoRnlXqyOia2bEPP0j7T6xexTnr77JJic8w/132","comment_is_top":false,"comment_ctime":1586140986,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1586140986","product_id":100023901,"comment_content":"è·¯ç”±è¡¨çš„ä¾‹å­ä¸­ä¸åŠ é”çš„è¯å°±ä¸èƒ½ä¿è¯change=trueä¼šå†™å…¥æˆåŠŸï¼Œå†™å…¥ä¸æˆåŠŸå°±å¯èƒ½ä¼šä¸¢å¤±ä¸€éƒ¨åˆ†æ”¹å˜çš„è·¯ç”±è¡¨","like_count":0},{"had_liked":false,"id":195897,"user_name":"å¥”è·‘çš„çŒª","can_delete":false,"product_type":"c1","uid":1602593,"ip_address":"","ucode":"94375121A233F4","user_header":"https://static001.geekbang.org/account/avatar/00/18/74/21/6c64afa9.jpg","comment_is_top":false,"comment_ctime":1585222629,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1585222629","product_id":100023901,"comment_content":"volatileå…³é”®å­—åªèƒ½ä¿è¯å¯è§æ€§ï¼Œæ— æ³•ä¿è¯äº’æ–¥æ€§ï¼Œæ‰€ä»¥æ€è€ƒé¢˜ä¸­volatileå˜é‡çš„æ­£ç¡®ä½¿ç”¨å§¿åŠ¿å¦‚ä¸‹ï¼š<br>public class Test {<br><br>    private volatile boolean inited = false;<br><br>    @Getter<br>    private int count = 0;<br><br>    public void init() {<br>        if (inited) {<br>            return;<br>        }<br><br>        &#47;&#47; å†™volatileå˜é‡å‰å…ˆæ‰§è¡Œä¸€æ®µç©ºå¾ªç¯ï¼Œå¢åŠ è¯»åˆ°initedä¸ºfalseçš„å¹¶å‘å‡ ç‡<br>        IntStream.range(0, Integer.MAX_VALUE).forEach(i -&gt; { });<br>        &#47;&#47; æ­£ç¡®ç”¨æ³•1ï¼šå†™volatileå˜é‡å‰å…ˆé€šè¿‡CASåˆ¤æ–­æ˜¯å¦å¯ä»¥å†™æˆåŠŸ<br>        if (!new AtomicBoolean(inited).compareAndSet(false, true)) {<br>            return;<br>        }<br>        inited = true;<br>        &#47;&#47; æ­£ç¡®ç”¨æ³•2ï¼šå†™volatileå˜é‡æ—¶åŠ é”ï¼Œå¹¶åœ¨å†™ä¹‹å‰åšåŒé‡Check<br>&#47;&#47;        synchronized (this) {<br>&#47;&#47;            if (inited) {<br>&#47;&#47;                return;<br>&#47;&#47;            }<br>&#47;&#47;            inited = true;<br>&#47;&#47;        }<br>        try {<br>            calc();<br>        } catch (Exception e) {<br>            inited = false;<br>            e.printStackTrace();<br>        }<br>    }<br><br>    private void calc() {<br>        count = count + 1;<br>    }<br><br>    public static void main(String[] args) throws InterruptedException {<br>        Test test = new Test();<br>        int taskTotal = 10000;<br>        CountDownLatch counter = new CountDownLatch(taskTotal);<br>        ExecutorService exec = Executors.newFixedThreadPool(5);<br>        for (int i = 0; i &lt; taskTotal; i++) {<br>            exec.submit(() -&gt; {<br>                test.init();<br>                counter.countDown();<br>            });<br>        }<br>        counter.await();<br>        System.out.println(&quot;count = &quot; + test.getCount());<br>        exec.shutdown();<br>    }<br>}","like_count":0},{"had_liked":false,"id":195674,"user_name":"Mr.wang","can_delete":false,"product_type":"c1","uid":1224805,"ip_address":"","ucode":"86F341A5316BBC","user_header":"https://static001.geekbang.org/account/avatar/00/12/b0/65/90387745.jpg","comment_is_top":false,"comment_ctime":1585211245,"is_pvip":false,"discussion_count":0,"race_medal":1,"score":"1585211245","product_id":100023901,"comment_content":"Balkingæ¨¡å¼éœ€è¦ä¿æŒäº’æ–¥æ€§ï¼Œè¿™é‡Œæ²¡æœ‰ä¿è¯äº’æ–¥ï¼Œåªæ˜¯æœ‰ä½¿ç”¨voliateå…³é”®å­—ï¼Œæ²¡æ³•ä¿è¯åŸå­æ€§å’Œä¸€è‡´æ€§ã€‚","like_count":0},{"had_liked":false,"id":188213,"user_name":"Evan","can_delete":false,"product_type":"c1","uid":1344281,"ip_address":"","ucode":"B877ABD0CF4661","user_header":"https://static001.geekbang.org/account/avatar/00/14/83/19/0a3fe8c1.jpg","comment_is_top":false,"comment_ctime":1584327944,"is_pvip":false,"discussion_count":0,"race_medal":1,"score":"1584327944","product_id":100023901,"comment_content":"ä»è¡¨é¢ä¸Šçœ‹ï¼Œè¿™æ®µä»£ç çš„æ€§èƒ½è¿˜å¯ä»¥äº†ï¼Œä½†ä»å®‰å…¨æ€§æ–¹é¢è€ƒè™‘å¤šçº¿ç¨‹ä¼šå‡ºç°Data Raceï¼Œä¹Ÿå°±æ²¡æœ‰åŠæ³•åŸå­æ€§ã€‚ è€Œvolatiledåªè§£å†³äº†å¯è§æ€§é—®é¢˜","like_count":0},{"had_liked":false,"id":154765,"user_name":"ææ¹˜æ²³","can_delete":false,"product_type":"c1","uid":1349528,"ip_address":"","ucode":"DB078B5DAAE82E","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoViaN0hP07cXOl7vOIvHPu7DZ3wxHBz4iaLVEqG1TFfiagm1wUaiczbCyicwib7oDWw0vD4cXg9eZ0Okqg/132","comment_is_top":false,"comment_ctime":1574557739,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1574557739","product_id":100023901,"comment_content":"Volatileåªèƒ½ä¿è¯å¯è§æ€§ï¼Œæ— æ³•ä¿è¯äº’æ–¥æ€§","like_count":0},{"had_liked":false,"id":137406,"user_name":"DFighting","can_delete":false,"product_type":"c1","uid":1233193,"ip_address":"","ucode":"F3BA2426FF8582","user_header":"https://static001.geekbang.org/account/avatar/00/12/d1/29/1b1234ed.jpg","comment_is_top":false,"comment_ctime":1569733369,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1569733369","product_id":100023901,"comment_content":"volatileæ²¡åŠæ³•ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼Œä¹Ÿå°±æ˜¯åœ¨ç¬¬ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œinited=trueæ—¶å¯èƒ½ä¼šå‘ç”Ÿæ—¶é—´ç‰‡çš„åˆ‡æ¢ï¼Œå¯¼è‡´ä¸‹ä¸€ä¸ªçº¿ç¨‹åœ¨åˆ¤æ–­æ˜¯å¦åˆå§‹åŒ–çš„æ—¶å€™ç»§ç»­æ‰§è¡Œcalc()æ“ä½œï¼Œä¹Ÿå°±æ˜¯è¯´æ²¡åŠæ³•ä¿è¯calc()çš„å”¯ä¸€æ€§ï¼Œå¯¹æ¯”è€å¸ˆç»™çš„ä»£ç ï¼Œåº”è¯¥ä¸ºæ•´ä¸ªæ–¹æ³•åŠ ä¸Šsynchronizedä»¥è¾¾åˆ°åªè®¡ç®—ä¸€æ¬¡calc()çš„ç›®çš„","like_count":0},{"had_liked":false,"id":106020,"user_name":"ç†Šç†Šå‘¨å‘¨","can_delete":false,"product_type":"c1","uid":1115763,"ip_address":"","ucode":"FE746FFC213226","user_header":"https://static001.geekbang.org/account/avatar/00/11/06/73/4d6b1f09.jpg","comment_is_top":false,"comment_ctime":1561128954,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1561128954","product_id":100023901,"comment_content":"inited = true;<br>é™¤éä»£ç æ‰€å·¥ä½œçš„æ“ä½œç³»ç»Ÿå¹³å°ç¯å¢ƒæˆ–è€…javaå®˜æ–¹æŒ‡å®šè¿™ä¸ªæ“ä½œæ˜¯åŸå­æ€§æ“ä½œï¼Œçº¿ç¨‹å®‰å…¨çš„ã€‚æˆ‘ä»¬ä¸åº”è¯¥æŠŠå®ƒå½“åšåŸå­æ€§çš„æ“ä½œï¼Œçº¿ç¨‹å®‰å…¨æ€§çš„æ“ä½œã€‚<br>è§£å†³äº†åŸå§‹æ•°æ®ç±»å‹èµ‹å€¼æ˜¯å¦æ˜¯åŸå­æ€§æ“ä½œçš„ç–‘é—®","like_count":0,"discussions":[{"author":{"id":1135912,"avatar":"https://static001.geekbang.org/account/avatar/00/11/55/28/31b0cf2f.jpg","nickname":"é»‘è‰²æ¯›è¡£","note":"","ucode":"FF7E235F91BA5C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":57590,"discussion_content":"èµ‹å€¼æ˜¯åŸå­æ€§çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574619662,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":101217,"user_name":"å¥‡å¥‡","can_delete":false,"product_type":"c1","uid":1399097,"ip_address":"","ucode":"BC86B0CB55E35A","user_header":"","comment_is_top":false,"comment_ctime":1559743377,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1559743377","product_id":100023901,"comment_content":"è¯¾åæ€è€ƒé¢˜åº”è¯¥æ˜¯!inited ä»£ç æ˜¯é”™çš„","like_count":0},{"had_liked":false,"id":99707,"user_name":"points","can_delete":false,"product_type":"c1","uid":1315891,"ip_address":"","ucode":"2AB84EA7E6ACA6","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/oY8Qg85SpcfqUzbAwe2suaFV9faxgtfG1nvfSe9uX5KlOWu5BkTBDXY1e5Z4fWLsThoJvWxVUiaWmqg3caQiauGA/132","comment_is_top":false,"comment_ctime":1559283312,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1559283312","product_id":100023901,"comment_content":"class Test{<br>\t<br>\tAtomicBoolean inited = new AtomicBoolean(false);<br>\t<br>\tvoid inited( ){<br>\t\tif( inited.getAndSet(true) ){<br>\t\t\treturn ;<br>\t\t}<br>\t\t<br>\t}<br>}","like_count":0},{"had_liked":false,"id":96857,"user_name":"Rancood","can_delete":false,"product_type":"c1","uid":1204333,"ip_address":"","ucode":"052BDF2221F480","user_header":"https://static001.geekbang.org/account/avatar/00/12/60/6d/e2576fda.jpg","comment_is_top":false,"comment_ctime":1558523323,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1558523323","product_id":100023901,"comment_content":"è¿™ä¸ªBalkingæ¨¡å¼çš„å¥½å¤„å°±æ˜¯å°†å¹¶å‘å¤„ç†é€»è¾‘ä¸ä¸šåŠ¡é€»è¾‘åˆ†ç¦»å—","like_count":0},{"had_liked":false,"id":96470,"user_name":"è´ºå®‡","can_delete":false,"product_type":"c1","uid":1445040,"ip_address":"","ucode":"55854825CC4AD2","user_header":"https://static001.geekbang.org/account/avatar/00/16/0c/b0/26c0e53f.jpg","comment_is_top":false,"comment_ctime":1558430862,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1558430862","product_id":100023901,"comment_content":"è¿™ä¸ªé—®é¢˜å¥½åƒå’Œä¿¡å·é‡é‚£ç« çš„é—®é¢˜å¾ˆç›¸ä¼¼","like_count":0},{"had_liked":false,"id":95718,"user_name":"ZOUå¿—ä¼Ÿ","can_delete":false,"product_type":"c1","uid":1029179,"ip_address":"","ucode":"439779871CC992","user_header":"https://static001.geekbang.org/account/avatar/00/0f/b4/3b/a1f7e3a4.jpg","comment_is_top":false,"comment_ctime":1558148305,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1558148305","product_id":100023901,"comment_content":"ç«æ€æ¡ä»¶é—®é¢˜","like_count":0},{"had_liked":false,"id":95120,"user_name":"å¤šè¥„ä¸¸","can_delete":false,"product_type":"c1","uid":1074310,"ip_address":"","ucode":"1AA1497C5A293C","user_header":"https://static001.geekbang.org/account/avatar/00/10/64/86/f5a9403a.jpg","comment_is_top":false,"comment_ctime":1557970552,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1557970552","product_id":100023901,"comment_content":"æ²¡æœ‰é” æœ‰å…±äº«å˜é‡ å¤šä¸ªçº¿ç¨‹ å¯èƒ½åŒæ—¶è¯»åˆ°falseå“‡ï¼Œ å°±å¯èƒ½æœ‰å¤šä¸ªçº¿ç¨‹initè€Œè®©countå€¼è¶…è¿‡1å“‡ã€‚ <br><br>å°½ç®¡è¯»åˆ°äº†init=false, çœŸæ­£çš„cal()ä¹Ÿåº”è¯¥åœ¨åŒæ­¥é‡Œé¢ï¼Œå¹¶ä¸”initæ­¤æ—¶ä»»ç„¶æ˜¯falseå“‡~","like_count":0},{"had_liked":false,"id":93878,"user_name":"å¼ ä¸‰","can_delete":false,"product_type":"c1","uid":1004092,"ip_address":"","ucode":"1155528FAE1546","user_header":"https://static001.geekbang.org/account/avatar/00/0f/52/3c/d6fcb93a.jpg","comment_is_top":false,"comment_ctime":1557649431,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1557649431","product_id":100023901,"comment_content":"æœ‰é—®é¢˜ï¼Œåœ¨æ‰§è¡Œcalc()æ–¹æ³•ä¹‹å‰ï¼Œå¦‚æœæœ‰åˆ«çš„çº¿ç¨‹è¿›æ¥ï¼Œåˆ™ç›´æ¥è¿”å›count=0äº†ï¼Œä½†ç¬¬ä¸€ä¸ªçº¿ç¨‹è¿˜æ˜¯ä¼šæ‰§è¡Œcalc()æ–¹æ³•æ›´æ–°countå€¼ï¼Œå®‰å…¨æ€§é—®é¢˜ã€‚","like_count":0},{"had_liked":false,"id":93805,"user_name":"æ™“æ°","can_delete":false,"product_type":"c1","uid":1441546,"ip_address":"","ucode":"1174C88EEBF8A6","user_header":"https://static001.geekbang.org/account/avatar/00/15/ff/0a/12faa44e.jpg","comment_is_top":false,"comment_ctime":1557623643,"is_pvip":false,"replies":[{"id":"33669","content":"ä¸é€‚ç”¨åˆ†å¸ƒå¼æƒ…å†µçš„å•ä¾‹","user_name":"ä½œè€…å›å¤","user_name_real":"ç‹å®ä»¤","uid":"1269969","ctime":1557757517,"ip_address":"","comment_id":93805,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1557623643","product_id":100023901,"comment_content":"åœ¨å¾®æœåŠ¡çš„åœºæ™¯ä¸‹ï¼Œsynchornizeåº”è¯¥ä¸é€‚ç”¨äº†å§","like_count":0,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":449778,"discussion_content":"ä¸é€‚ç”¨åˆ†å¸ƒå¼æƒ…å†µçš„å•ä¾‹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1557757517,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1438352,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI4akcIyIOXB2OqibTe7FF90hwsBicxkjdicUNTMorGeIictdr3OoMxhc20yznmZWwAvQVThKPFWgOyMw/132","nickname":"Chuan","note":"","ucode":"FACEC5DAC36A7A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":164906,"discussion_content":"è¯·é—®ä¸‹åˆ†å¸ƒå¼æƒ…å†µçš„å•ä¾‹çš„åœºæ™¯å’Œå®ç°æ–¹å¼æ˜¯æ€æ ·çš„å‘¢ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581234311,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":93733,"user_name":"æ‹’ç»","can_delete":false,"product_type":"c1","uid":1335155,"ip_address":"","ucode":"CB0264C4D3FE17","user_header":"https://static001.geekbang.org/account/avatar/00/14/5f/73/bb3dc468.jpg","comment_is_top":false,"comment_ctime":1557574139,"is_pvip":false,"replies":[{"id":"33674","content":"ğŸ‘å¯¹çš„","user_name":"ä½œè€…å›å¤","user_name_real":"ç‹å®ä»¤","uid":"1269969","ctime":1557757953,"ip_address":"","comment_id":93733,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1557574139","product_id":100023901,"comment_content":"è€å¸ˆï¼Œvolatileåªèƒ½ä¿è¯å˜é‡çš„å¯è§æ€§ï¼Œåœ¨å¤šçº¿ç¨‹ä¸‹ï¼Œå‘ç”Ÿçº¿ç¨‹åˆ‡æ¢ä¼šéƒ½è¯»å–åˆ°å˜é‡ä¸ºfalseï¼Œåˆ™è®¡ç®—countæ–¹æ³•è¢«è°ƒç”¨å¤šæ¬¡ï¼Œå¯¹å—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":449750,"discussion_content":"ğŸ‘å¯¹çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1557757953,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":93649,"user_name":"ack","can_delete":false,"product_type":"c1","uid":1440912,"ip_address":"","ucode":"69CA1233EEA8E2","user_header":"https://static001.geekbang.org/account/avatar/00/15/fc/90/c9df0459.jpg","comment_is_top":false,"comment_ctime":1557544958,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1557544958","product_id":100023901,"comment_content":"æœ‰é—®é¢˜ï¼Œinitedå…±äº«å˜é‡å’Œcalï¼ˆï¼‰å†™æ“ä½œéœ€è¦ä¿è¯åŸå­æ€§æ‰§è¡Œï¼Œä¸Šé¢çš„åˆå§‹åŒ–æ“ä½œå¯èƒ½ä¼šæ‰§è¡Œå¤šæ¬¡","like_count":0},{"had_liked":false,"id":93603,"user_name":"å¼ ä¸‰","can_delete":false,"product_type":"c1","uid":1004092,"ip_address":"","ucode":"1155528FAE1546","user_header":"https://static001.geekbang.org/account/avatar/00/0f/52/3c/d6fcb93a.jpg","comment_is_top":false,"comment_ctime":1557533520,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1557533520","product_id":100023901,"comment_content":"æ‰“å¡ï¼Œæ–‡ä¸­å…³äºä½¿ç”¨volatileä¸éœ€è¦è€ƒè™‘åŸå­æ€§çš„æƒ…å†µæ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1812970,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/a9/ea/5bfce6c5.jpg","nickname":"mgs2002","note":"","ucode":"F5931108BD509B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":315346,"discussion_content":"å•çº¯è¯»çš„æƒ…å†µï¼Œä¸éœ€è¦å†™","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603265509,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}