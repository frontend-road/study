{"id":373089,"title":"27 | å¤§è¡¨Joinå°è¡¨ï¼šå¹¿æ’­å˜é‡å®¹ä¸ä¸‹å°è¡¨æ€ä¹ˆåŠï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å´ç£Šã€‚</p><p>åœ¨æ•°æ®åˆ†æé¢†åŸŸï¼Œå¤§è¡¨Joinå°è¡¨çš„åœºæ™¯éå¸¸æ™®éã€‚ä¸è¿‡ï¼Œå¤§å°æ˜¯ä¸ªç›¸å¯¹çš„æ¦‚å¿µï¼Œé€šå¸¸æ¥è¯´ï¼Œå¤§è¡¨ä¸å°è¡¨å°ºå¯¸ç›¸å·®3å€ä»¥ä¸Šï¼Œæˆ‘ä»¬å°±å°†å…¶å½’ç±»ä¸ºâ€œå¤§è¡¨Joinå°è¡¨â€çš„è®¡ç®—åœºæ™¯ã€‚å› æ­¤ï¼Œå¤§è¡¨Joinå°è¡¨ï¼Œä»…ä»…æ„å‘³ç€å‚ä¸å…³è”çš„ä¸¤å¼ è¡¨å°ºå¯¸æ‚¬æ®Šã€‚</p><p>å¯¹äºå¤§è¡¨Joinå°è¡¨è¿™ç§åœºæ™¯ï¼Œæˆ‘ä»¬åº”è¯¥ä¼˜å…ˆè€ƒè™‘BHJï¼Œå®ƒæ˜¯Sparkæ”¯æŒçš„5ç§Joinç­–ç•¥ä¸­æ‰§è¡Œæ•ˆç‡æœ€é«˜çš„ã€‚<strong>BHJå¤„ç†å¤§è¡¨Joinå°è¡¨æ—¶çš„å‰ææ¡ä»¶æ˜¯ï¼Œå¹¿æ’­å˜é‡èƒ½å¤Ÿå®¹çº³å°è¡¨çš„å…¨é‡æ•°æ®ã€‚</strong>ä½†æ˜¯ï¼Œå¦‚æœå°è¡¨çš„æ•°æ®é‡è¶…è¿‡å¹¿æ’­é˜ˆå€¼ï¼Œæˆ‘ä»¬åˆè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ</p><p>ä»Šå¤©è¿™ä¸€è®²ï¼Œæˆ‘ä»¬å°±ç»“åˆ3ä¸ªçœŸå®çš„ä¸šåŠ¡æ¡ˆä¾‹ï¼Œæ¥èŠä¸€èŠè¿™ç§æƒ…å†µçš„è§£å†³åŠæ³•ã€‚è™½ç„¶è¿™3ä¸ªæ¡ˆä¾‹ä¸å¯èƒ½è¦†ç›–â€œå¤§è¡¨Joinå°è¡¨â€åœºæ™¯ä¸­çš„æ‰€æœ‰æƒ…å†µï¼Œä½†æ˜¯ï¼Œåˆ†æå¹¶æ±‡æ€»æ¡ˆä¾‹çš„åº”å¯¹ç­–ç•¥å’Œè§£å†³åŠæ³•ï¼Œæœ‰åˆ©äºæˆ‘ä»¬åœ¨è°ƒä¼˜çš„è¿‡ç¨‹ä¸­å¼€é˜”æ€è·¯ã€å‘æ•£æ€ç»´ï¼Œä»è€Œé¿å…é™·å…¥â€œé¢å¯¹é—®é¢˜æ— æ‰€é€‚ä»â€çš„çª˜å¢ƒã€‚</p><h2>æ¡ˆä¾‹1ï¼šJoin Keyè¿œå¤§äºPayload</h2><p>åœ¨ç¬¬ä¸€ä¸ªæ¡ˆä¾‹ä¸­ï¼Œå¤§è¡¨100GBã€å°è¡¨10GBï¼Œå®ƒä»¬å…¨éƒ½è¿œè¶…å¹¿æ’­å˜é‡é˜ˆå€¼ï¼ˆé»˜è®¤10MBï¼‰ã€‚å› ä¸ºå°è¡¨çš„å°ºå¯¸å·²ç»è¶…è¿‡8GBï¼Œåœ¨å¤§äº8GBçš„æ•°æ®é›†ä¸Šåˆ›å»ºå¹¿æ’­å˜é‡ï¼ŒSparkä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œä¸­æ–­ä»»åŠ¡æ‰§è¡Œï¼Œæ‰€ä»¥Sparkæ˜¯æ²¡æœ‰åŠæ³•åº”ç”¨BHJæœºåˆ¶çš„ã€‚é‚£æˆ‘ä»¬è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿå…ˆåˆ«æ€¥ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªæ¡ˆä¾‹çš„ä¸šåŠ¡éœ€æ±‚ã€‚</p><!-- [[[read_end]]] --><p>è¿™ä¸ªæ¡ˆä¾‹æ¥æºäºè®¡ç®—å¹¿å‘Šä¸šåŠ¡ä¸­çš„æµé‡é¢„æµ‹ï¼Œæµé‡æŒ‡çš„æ˜¯ç³»ç»Ÿä¸­ä¸€æ®µæ—¶é—´å†…ä¸åŒç±»å‹ç”¨æˆ·çš„è®¿é—®é‡ã€‚è¿™é‡Œæœ‰ä¸‰ä¸ªå…³é”®è¯ï¼Œç¬¬ä¸€ä¸ªæ˜¯â€œç³»ç»Ÿâ€ï¼Œç¬¬äºŒä¸ªæ˜¯â€œä¸€æ®µæ—¶é—´â€ï¼Œç¬¬ä¸‰ä¸ªæ˜¯â€œç”¨æˆ·ç±»å‹â€ã€‚æ—¶é—´ç²’åº¦å¥½ç†è§£ï¼Œå°±æ˜¯ä»¥å°æ—¶ä¸ºå•ä½å»ç»Ÿè®¡æµé‡ã€‚ç”¨æˆ·ç±»å‹æŒ‡çš„æ˜¯é‡‡ç”¨ä¸åŒçš„ç»´åº¦æ¥åˆ»ç”»ç”¨æˆ·ï¼Œæ¯”å¦‚æ€§åˆ«ã€å¹´é¾„ã€æ•™è‚²ç¨‹åº¦ã€èŒä¸šã€åœ°ç†ä½ç½®ã€‚ç³»ç»ŸæŒ‡çš„æ˜¯æµé‡æ¥æºï¼Œæ¯”å¦‚å¹³å°ã€ç«™ç‚¹ã€é¢‘é“ã€åª’ä½“åŸŸåã€‚</p><p>åœ¨ç³»ç»Ÿå’Œç”¨æˆ·çš„ç»´åº¦ç»„åˆä¹‹ä¸‹ï¼Œæµé‡è¢«ç»†åˆ†ä¸ºæ•°ä»¥ç™¾ä¸‡è®¡çš„ä¸åŒâ€œç§ç±»â€ã€‚æ¯”å¦‚ï¼Œæ¥è‡ªXXå¹³å°XXç«™ç‚¹çš„åœ¨æ ¡å¤§å­¦ç”Ÿçš„è®¿é—®é‡ï¼Œæˆ–æ˜¯æ¥è‡ªXXåª’ä½“XXé¢‘é“25-45å²å¥³æ€§çš„è®¿é—®é‡ç­‰ç­‰ã€‚</p><p>æˆ‘ä»¬çŸ¥é“ï¼Œæµé‡é¢„æµ‹æœ¬èº«æ˜¯ä¸ªæ—¶åºé—®é¢˜ï¼Œå®ƒå’Œè‚¡ä»·é¢„æµ‹ç±»ä¼¼ï¼Œéƒ½æ˜¯åŸºäºå†å²ã€å»é¢„æµ‹æœªæ¥ã€‚åœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ï¼Œä¸ºäº†é¢„æµ‹ä¸Šç™¾ä¸‡ç§ä¸åŒçš„æµé‡ï¼Œå’±ä»¬å¾—å…ˆä¸ºæ¯ç§æµé‡ç”Ÿæˆæ—¶åºåºåˆ—ï¼Œç„¶åå†æŠŠè¿™äº›æ—¶åºåºåˆ—å–‚ç»™æœºå™¨å­¦ä¹ ç®—æ³•è¿›è¡Œæ¨¡å‹è®­ç»ƒã€‚</p><p>ç»Ÿè®¡æµé‡çš„æ•°æ®æºæ˜¯çº¿ä¸Šçš„è®¿é—®æ—¥å¿—ï¼Œå®ƒè®°å½•äº†å“ªç±»ç”¨æˆ·åœ¨ä»€ä¹ˆæ—¶é—´è®¿é—®äº†å“ªäº›ç«™ç‚¹ã€‚è¦çŸ¥é“ï¼Œæˆ‘ä»¬è¦æ„å»ºçš„ï¼Œæ˜¯ä»¥å°æ—¶ä¸ºå•ä½çš„æ—¶åºåºåˆ—ï¼Œä½†ç”±äºæµé‡çš„åˆ‡å‰²ç²’åº¦éå¸¸ç»†è‡´ï¼Œå› æ­¤æœ‰äº›ç§ç±»çš„æµé‡ä¸æ˜¯æ¯ä¸ªå°æ—¶éƒ½æœ‰è®¿é—®é‡çš„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/7e/9f/7e8fc62ca38cb1a0a557b6b7eb1af99f.jpg?wh=2934*924\" alt=\"\" title=\"æŸç§æµé‡åœ¨è¿‡å»24å°æ—¶çš„è®°å½•æƒ…å†µ\"></p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¿‡å»çš„24å°æ—¶ä¸­ï¼ŒæŸç§æµé‡ä»…åœ¨20-24ç‚¹è¿™5ä¸ªæ—¶æ®µæœ‰æ•°æ®è®°å½•ï¼Œå…¶ä»–æ—¶æ®µæ— è®°å½•ï¼Œä¹Ÿå°±æ˜¯æµé‡ä¸ºé›¶ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°±éœ€è¦ç”¨â€œé›¶â€å»è¡¥é½ç¼ºå¤±æ—¶æ®µçš„åºåˆ—å€¼ã€‚é‚£ä¹ˆæˆ‘ä»¬è¯¥æ€ä¹ˆè¡¥å‘¢ï¼Ÿ</p><p><strong>å› ä¸ºä¸šåŠ¡éœ€æ±‚æ˜¯å¡«è¡¥ç¼ºå¤±å€¼ï¼Œæ‰€ä»¥åœ¨å®ç°å±‚é¢ï¼Œæˆ‘ä»¬ä¸å¦¨å…ˆæ„å»ºå‡ºå®Œæ•´çš„å…¨é›¶åºåˆ—ï¼Œç„¶åä»¥ç³»ç»Ÿã€ç”¨æˆ·å’Œæ—¶é—´è¿™äº›ç»´åº¦ç»„åˆä¸ºç²’åº¦ï¼Œç”¨ç»Ÿè®¡æµé‡å»æ›¿æ¢å…¨é›¶åºåˆ—ä¸­ç›¸åº”ä½ç½®çš„â€œé›¶æµé‡â€ã€‚</strong>è¿™ä¸ªæ€è·¯æè¿°èµ·æ¥æ¯”è¾ƒå¤æ‚ï¼Œç”¨å›¾æ¥ç†è§£ä¼šæ›´ç›´è§‚ã€æ›´è½»æ¾ä¸€äº›ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/90/fe/90d03196d4c71c133344f913e4f69dfe.jpg?wh=3999*1554\" alt=\"\"></p><p>é¦–å…ˆï¼Œæˆ‘ä»¬ç”Ÿæˆä¸€å¼ å…¨é›¶æµé‡è¡¨ï¼Œå¦‚å›¾ä¸­å·¦ä¾§çš„â€œè´Ÿæ ·æœ¬è¡¨â€æ‰€ç¤ºã€‚è¿™å¼ è¡¨çš„ä¸»é”®æ˜¯åˆ’åˆ†æµé‡ç§ç±»çš„å„ç§ç»´åº¦ï¼Œå¦‚æ€§åˆ«ã€å¹´é¾„ã€å¹³å°ã€ç«™ç‚¹ã€å°æ—¶æ—¶æ®µç­‰ç­‰ã€‚è¡¨çš„Payloadåªæœ‰ä¸€åˆ—ï¼Œä¹Ÿå³è®¿é—®é‡ï¼Œåœ¨ç”Ÿæˆâ€œè´Ÿæ ·æœ¬è¡¨â€çš„æ—¶å€™ï¼Œè¿™ä¸€åˆ—å…¨éƒ¨ç½®é›¶ã€‚</p><p>ç„¶åï¼Œæˆ‘ä»¬ä»¥åŒæ ·çš„ç»´åº¦ç»„åˆç»Ÿè®¡æ—¥å¿—ä¸­çš„è®¿é—®é‡ï¼Œå°±å¯ä»¥å¾—åˆ°å›¾ä¸­å³ä¾§çš„â€œæ­£æ ·æœ¬è¡¨â€ã€‚ä¸éš¾å‘ç°ï¼Œä¸¤å¼ è¡¨çš„Schemaå®Œå…¨ä¸€è‡´ï¼Œè¦æƒ³è·å¾—å®Œæ•´çš„æ—¶åºåºåˆ—ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠå¤–è¡¨ä»¥â€œå·¦è¿æ¥ï¼ˆLeft Outer Joinï¼‰â€çš„å½¢å¼å’Œå†…è¡¨åšå…³è”å°±å¥½äº†ã€‚å…·ä½“çš„æŸ¥è¯¢è¯­å¥å¦‚ä¸‹ï¼š</p><pre><code>//å·¦è¿æ¥æŸ¥è¯¢è¯­å¥\nselect t1.gender, t1.age, t1.city, t1.platform, t1.site, t1.hour, coalesce(t2.access, t1.access) as access\nfrom t1 left join t2 on\nt1.gender = t2.gender and\nt1.age = t2.age and\nt1.city = t2.city and\nt1.platform = t2.platform and\nt1.site = t2.site and\nt1.hour = t2.hour\n</code></pre><p>ä½¿ç”¨å·¦è¿æ¥çš„æ–¹å¼ï¼Œæˆ‘ä»¬åˆšå¥½å¯ä»¥ç”¨å†…è¡¨ä¸­çš„è®¿é—®é‡æ›¿æ¢å¤–è¡¨ä¸­çš„é›¶æµé‡ï¼Œä¸¤è¡¨å…³è”çš„ç»“æœæ­£æ˜¯æˆ‘ä»¬æƒ³è¦çš„æ—¶åºåºåˆ—ã€‚â€œæ­£æ ·æœ¬è¡¨â€æ¥è‡ªè®¿é—®æ—¥å¿—ï¼ŒåªåŒ…å«é‚£äº›å­˜åœ¨æµé‡çš„æ—¶æ®µï¼Œè€Œâ€œè´Ÿæ ·æœ¬è¡¨â€æ˜¯ç”Ÿæˆè¡¨ï¼Œå®ƒåŒ…å«äº†æ‰€æœ‰çš„æ—¶æ®µã€‚å› æ­¤ï¼Œåœ¨æ•°æ®ä½“é‡ä¸Šï¼Œè´Ÿæ ·æœ¬è¡¨è¿œå¤§äºæ­£æ ·æœ¬è¡¨ï¼Œè¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„â€œå¤§è¡¨Joinå°è¡¨â€åœºæ™¯ã€‚å°½ç®¡å°è¡¨ï¼ˆ10GBï¼‰ä¸å¤§è¡¨ï¼ˆ100GBï¼‰ç›¸æ¯”ï¼Œåœ¨å°ºå¯¸ä¸Šç›¸å·®ä¸€ä¸ªæ•°é‡çº§ï¼Œä½†ä¸¤è€…çš„ä½“é‡éƒ½ä¸æ»¡è¶³BHJçš„å…ˆå†³æ¡ä»¶ã€‚å› æ­¤ï¼ŒSparkåªå¥½é€€è€Œæ±‚å…¶æ¬¡ï¼Œé€‰æ‹©SMJï¼ˆShuffle Sort Merge Joinï¼‰çš„å®ç°æ–¹å¼ã€‚</p><p>æˆ‘ä»¬çŸ¥é“ï¼ŒSMJæœºåˆ¶ä¼šå¼•å…¥Shuffleï¼Œå°†ä¸Šç™¾GBçš„æ•°æ®åœ¨å…¨ç½‘åˆ†å‘å¯ä¸æ˜¯ä¸€ä¸ªæ˜æ™ºçš„é€‰æ‹©ã€‚é‚£ä¹ˆï¼Œæ ¹æ®â€œèƒ½çœåˆ™çœâ€çš„å¼€å‘åŸåˆ™ï¼Œæˆ‘ä»¬æœ‰æ²¡æœ‰å¯èƒ½â€œçœå»â€è¿™é‡Œçš„Shuffleå‘¢ï¼Ÿè¦æƒ³çœå»Shuffleï¼Œæˆ‘ä»¬åªæœ‰ä¸€ä¸ªåŠæ³•ï¼Œå°±æ˜¯æŠŠSMJè½¬åŒ–æˆBHJã€‚ä½ å¯èƒ½ä¼šè¯´ï¼šâ€œéƒ½è¯´äº†å¥½å‡ éäº†ï¼Œå°è¡¨çš„å°ºå¯¸10GBè¿œè¶…å¹¿æ’­é˜ˆå€¼ï¼Œæˆ‘ä»¬è¿˜èƒ½æ€ä¹ˆè½¬åŒ–å‘¢ï¼Ÿâ€</p><p>åŠæ³•æ€»æ¯”å›°éš¾å¤šï¼Œæˆ‘ä»¬å…ˆæ¥åæ€ï¼Œå…³è”è¿™ä¸¤å¼ è¡¨çš„ç›®çš„æ˜¯ä»€ä¹ˆï¼Ÿç›®çš„æ˜¯ä»¥ç»´åº¦ç»„åˆï¼ˆJoin Keysï¼‰ä¸ºåŸºå‡†ï¼Œç”¨å†…è¡¨çš„è®¿é—®é‡æ›¿æ¢æ‰å¤–è¡¨çš„é›¶å€¼ã€‚é‚£ä¹ˆï¼Œè¿™ä¸¤å¼ è¡¨æœ‰å“ªäº›ç‰¹ç‚¹å‘¢ï¼Ÿ<strong>é¦–å…ˆï¼Œä¸¤å¼ è¡¨çš„Schemaå®Œå…¨ä¸€è‡´ã€‚å…¶æ¬¡ï¼Œæ— è®ºæ˜¯åœ¨æ•°é‡ã€è¿˜æ˜¯å°ºå¯¸ä¸Šï¼Œä¸¤å¼ è¡¨çš„Join Keyséƒ½è¿œå¤§äºPayloadã€‚</strong>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œè¦è¾¾åˆ°æˆ‘ä»¬çš„ç›®çš„ï¼Œä¸€å®šè¦ç”¨é‚£ä¹ˆå¤šã€é‚£ä¹ˆé•¿çš„Join Keysåšå…³è”å—ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯å¦å®šçš„ã€‚åœ¨ä¸Šä¸€è®²ï¼Œæˆ‘ä»¬ä»‹ç»è¿‡Hash Joinçš„å®ç°åŸç†ï¼Œåœ¨Buildé˜¶æ®µï¼ŒHash Joinä½¿ç”¨å“ˆå¸Œç®—æ³•ç”Ÿæˆå“ˆå¸Œè¡¨ã€‚åœ¨Probeé˜¶æ®µï¼Œå“ˆå¸Œè¡¨ä¸€æ–¹é¢å¯ä»¥æä¾›O(1)çš„æŸ¥æ‰¾æ•ˆç‡ï¼Œå¦ä¸€æ–¹é¢ï¼Œåœ¨æŸ¥æ‰¾è¿‡ç¨‹ä¸­ï¼ŒHash Keysä¹‹é—´çš„å¯¹æ¯”è¿œæ¯”Join Keysä¹‹é—´çš„å¯¹æ¯”è¦é«˜æ•ˆå¾—å¤šã€‚å—æ­¤å¯å‘ï¼Œæˆ‘ä»¬ä¸ºä»€ä¹ˆä¸èƒ½è®¡ç®—Join Keysçš„å“ˆå¸Œå€¼ï¼Œç„¶åæŠŠç”Ÿæˆçš„å“ˆå¸Œå€¼å½“ä½œæ˜¯æ–°çš„Join Keyå‘¢ï¼Ÿ</p><p><img src=\"https://static001.geekbang.org/resource/image/1c/69/1c93475b8d2d5d18d6b49fb7a258db69.jpg?wh=4719*1869\" alt=\"\"></p><p>æˆ‘ä»¬å®Œå…¨å¯ä»¥åŸºäºç°æœ‰çš„Join Keyså»ç”Ÿæˆä¸€ä¸ªå…¨æ–°çš„æ•°æ®åˆ—ï¼Œå®ƒå¯ä»¥å«â€œHash Keyâ€ã€‚ç”Ÿæˆçš„æ–¹æ³•åˆ†ä¸¤æ­¥ï¼š</p><ul>\n<li>æŠŠæ‰€æœ‰Join Keysæ‹¼æ¥åœ¨ä¸€èµ·ï¼ŒæŠŠæ€§åˆ«ã€å¹´é¾„ã€ä¸€ç›´åˆ°å°æ—¶æ‹¼æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå¦‚å›¾ä¸­æ­¥éª¤1ã€3æ‰€ç¤º</li>\n<li>ä½¿ç”¨å“ˆå¸Œç®—æ³•ï¼ˆå¦‚MD5æˆ–SHA256ï¼‰å¯¹æ‹¼æ¥åçš„å­—ç¬¦ä¸²åšå“ˆå¸Œè¿ç®—ï¼Œå¾—åˆ°å“ˆå¸Œå€¼å³ä¸ºâ€œHash Keyâ€ï¼Œå¦‚ä¸Šå›¾æ­¥éª¤2ã€4æ‰€ç¤º</li>\n</ul><p>åœ¨ä¸¤å¼ è¡¨ä¸Šï¼Œæˆ‘ä»¬éƒ½è¿›è¡Œè¿™æ ·çš„æ“ä½œã€‚å¦‚æ­¤ä¸€æ¥ï¼Œåœ¨åšå·¦è¿æ¥çš„æ—¶å€™ï¼Œä¸ºäº†æŠŠä¸»é”®ä¸€è‡´çš„è®°å½•å…³è”åœ¨ä¸€èµ·ï¼Œæˆ‘ä»¬ä¸å¿…å†ä½¿ç”¨æ•°é‡ä¼—å¤šã€å†—é•¿çš„åŸå§‹Join Keysï¼Œç”¨å•ä¸€çš„ç”Ÿæˆåˆ—Hash Keyå°±å¯ä»¥äº†ã€‚ç›¸åº”åœ°ï¼ŒSQLæŸ¥è¯¢è¯­å¥ä¹Ÿå˜æˆäº†å¦‚ä¸‹çš„æ ·å­ã€‚</p><pre><code>//è°ƒæ•´åçš„å·¦è¿æ¥æŸ¥è¯¢è¯­å¥\nselect t1.gender, t1.age, t1.city, t1.platform, t1.site, t1.hour, coalesce(t2.access, t1.access) as access\nfrom t1 left join t2 on\nt1.hash_key = t2. hash_key\n</code></pre><p>æ·»åŠ äº†è¿™ä¸€åˆ—ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠå†…è¡¨ï¼Œä¹Ÿå°±æ˜¯â€œæ­£æ ·æœ¬è¡¨â€ä¸­æ‰€æœ‰çš„Join Keysæ¸…é™¤æ‰ï¼Œå¤§å¹…ç¼©å‡å†…è¡¨çš„å­˜å‚¨ç©ºé—´ï¼Œä¸Šå›¾ä¸­çš„æ­¥éª¤5æ¼”ç¤ºäº†è¿™ä¸ªè¿‡ç¨‹ã€‚å½“å†…è¡¨ç¼©å‡åˆ°è¶³ä»¥æ”¾è¿›å¹¿æ’­å˜é‡çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠSMJè½¬åŒ–ä¸ºBHJï¼Œä»è€ŒæŠŠSMJä¸­çš„Shuffleç¯èŠ‚å½»åº•çœæ‰ã€‚</p><p>è¿™æ ·ä¸€æ¥ï¼Œæ¸…é™¤æ‰Join Keysçš„å†…è¡¨çš„å­˜å‚¨å¤§å°å°±å˜æˆäº†1.5GBã€‚å¯¹äºè¿™æ ·çš„å­˜å‚¨é‡çº§ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥ä½¿ç”¨é…ç½®é¡¹æˆ–æ˜¯å¼ºåˆ¶å¹¿æ’­çš„æ–¹å¼ï¼Œæ¥å®ŒæˆShuffle Joinåˆ°Broadcast Joinçš„è½¬åŒ–ï¼Œå…·ä½“çš„è½¬åŒ–æ–¹æ³•ä½ å¯ä»¥å‚è€ƒå¹¿æ’­å˜é‡é‚£ä¸€è®²ï¼ˆ<a href=\"https://time.geekbang.org/column/article/360837\">ç¬¬13è®²</a>ï¼‰ã€‚</p><p>æ¡ˆä¾‹1è¯´åˆ°è¿™é‡Œï¼Œå…¶å®å·²ç»åŸºæœ¬è§£å†³äº†ï¼Œä¸è¿‡è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªå°ç»†èŠ‚éœ€è¦æˆ‘ä»¬ç‰¹åˆ«æ³¨æ„ã€‚<strong>æ¡ˆä¾‹1ä¼˜åŒ–çš„å…³é”®åœ¨äºï¼Œå…ˆç”¨Hash Keyå–ä»£Join Keysï¼Œå†æ¸…é™¤å†…è¡¨å†—ä½™æ•°æ®ã€‚Hash Keyå®é™…ä¸Šæ˜¯Join Keysæ‹¼æ¥ä¹‹åçš„å“ˆå¸Œå€¼ã€‚æ—¢ç„¶å­˜åœ¨å“ˆå¸Œè¿ç®—ï¼Œæˆ‘ä»¬å°±å¿…é¡»è¦è€ƒè™‘å“ˆå¸Œå†²çªçš„é—®é¢˜ã€‚</strong></p><p>å“ˆå¸Œå†²çªæˆ‘ä»¬éƒ½å¾ˆç†Ÿæ‚‰ï¼Œå®ƒæŒ‡çš„å°±æ˜¯ä¸åŒçš„æ•°æ®æºç»è¿‡å“ˆå¸Œè¿ç®—ä¹‹åï¼Œå¾—åˆ°çš„å“ˆå¸Œå€¼ç›¸åŒã€‚åœ¨æ¡ˆä¾‹1å½“ä¸­ï¼Œå¦‚æœæˆ‘ä»¬ä¸ºäº†ä¼˜åŒ–å¼•å…¥çš„å“ˆå¸Œè®¡ç®—å‡ºç°äº†å“ˆå¸Œå†²çªï¼Œå°±ä¼šç ´ååŸæœ‰çš„å…³è”å…³ç³»ã€‚æ¯”å¦‚ï¼Œæœ¬æ¥ä¸¤ä¸ªä¸ç›¸ç­‰çš„Join Keysï¼Œå› ä¸ºå“ˆå¸Œå€¼æ°å·§ç›¸åŒè€Œè¢«å…³è”åˆ°äº†ä¸€èµ·ã€‚æ˜¾ç„¶ï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ç»“æœã€‚</p><p>æ¶ˆé™¤å“ˆå¸Œå†²çªéšæ‚£çš„æ–¹æ³•å…¶å®å¾ˆå¤šï¼Œæ¯”å¦‚â€œäºŒæ¬¡å“ˆå¸Œâ€ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ç”¨ä¸¤ç§å“ˆå¸Œç®—æ³•æ¥ç”ŸæˆHash Keyæ•°æ®åˆ—ã€‚ä¸¤æ¡ä¸åŒçš„æ•°æ®è®°å½•åœ¨ä¸¤ç§ä¸åŒå“ˆå¸Œç®—æ³•è¿ç®—ä¸‹çš„ç»“æœå®Œå…¨ç›¸åŒï¼Œè¿™ç§æ¦‚ç‡å‡ ä¹ä¸ºé›¶ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/bb/bf/bb79544467e98f9d2b6f13a437bb2dbf.jpg?wh=1500*1584\" alt=\"\"></p><h2>æ¡ˆä¾‹2ï¼šè¿‡æ»¤æ¡ä»¶çš„Selectivityè¾ƒé«˜</h2><p>é™¤äº†Join Keysè¿œå¤§äºPayloadçš„æƒ…å†µä¼šå¯¼è‡´æˆ‘ä»¬æ— æ³•é€‰æ‹©BHJï¼Œè¿˜æœ‰ä¸€ç§æƒ…å†µæ˜¯è¿‡æ»¤æ¡ä»¶çš„Selectivityè¾ƒé«˜ã€‚è¿™ä¸ªæ¡ˆä¾‹æ¥æºäºç”µå­å•†åŠ¡åœºæ™¯ï¼Œåœ¨æ˜Ÿå‹ï¼ˆStart Schemaï¼‰æ•°ä»“ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸¤å¼ è¡¨ï¼Œä¸€å¼ æ˜¯è®¢å•è¡¨ordersï¼Œå¦ä¸€å¼ æ˜¯ç”¨æˆ·è¡¨usersã€‚è®¢å•è¡¨æ˜¯äº‹å®è¡¨ï¼ˆFactï¼‰ï¼Œè€Œç”¨æˆ·è¡¨æ˜¯ç»´åº¦è¡¨ï¼ˆDimensionï¼‰ã€‚</p><p>è¿™ä¸ªæ¡ˆä¾‹çš„ä¸šåŠ¡éœ€æ±‚å¾ˆç®€å•ï¼Œæ˜¯ç»Ÿè®¡æ‰€æœ‰å¤´éƒ¨ç”¨æˆ·è´¡çŒ®çš„è¥ä¸šé¢ï¼Œå¹¶æŒ‰ç…§è¥ä¸šé¢å€’åºæ’åºã€‚è®¢å•è¡¨å’Œç”¨æˆ·è¡¨çš„Schemaå¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p><pre><code>// è®¢å•è¡¨orderså…³é”®å­—æ®µ\nuserId, Int\nitemId, Int\nprice, Float\nquantity, Int\n \n// ç”¨æˆ·è¡¨userså…³é”®å­—æ®µ\nid, Int\nname, String\ntype, String //æšä¸¾å€¼ï¼Œåˆ†ä¸ºå¤´éƒ¨ç”¨æˆ·å’Œé•¿å°¾ç”¨æˆ·\n\n</code></pre><p>ç»™å®šä¸Šè¿°æ•°æ®è¡¨ï¼Œæˆ‘ä»¬åªéœ€æŠŠä¸¤å¼ è¡¨åšå†…å…³è”ï¼Œç„¶ååˆ†ç»„ã€èšåˆã€æ’åºï¼Œå°±å¯ä»¥å®ç°ä¸šåŠ¡é€»è¾‘ï¼Œå…·ä½“çš„æŸ¥è¯¢è¯­å¥å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>//æŸ¥è¯¢è¯­å¥\nselect (orders.price * order.quantity) as revenue, users.name\nfrom orders inner join users on orders.userId = users.id\nwhere users.type = â€˜Head Userâ€™\ngroup by users.name\norder by revenue desc\n</code></pre><p>åœ¨è¿™ä¸ªæ¡ˆä¾‹ä¸­ï¼Œäº‹å®è¡¨çš„å­˜å‚¨å®¹é‡åœ¨TBé‡çº§ï¼Œç»´åº¦è¡¨æ˜¯20GBå·¦å³ï¼Œä¹Ÿéƒ½è¶…è¿‡äº†å¹¿æ’­é˜ˆå€¼ã€‚å…¶å®ï¼Œè¿™æ ·çš„å…³è”åœºæ™¯åœ¨ç”µå­å•†åŠ¡ã€è®¡ç®—å¹¿å‘Šä»¥åŠæ¨èæœç´¢é¢†åŸŸéƒ½å¾ˆå¸¸è§ã€‚</p><p><strong>å¯¹äºä¸¤å¼ è¡¨éƒ½è¿œè¶…å¹¿æ’­é˜ˆå€¼çš„å…³è”åœºæ™¯æ¥è¯´ï¼Œå¦‚æœæˆ‘ä»¬ä¸åšä»»ä½•è°ƒä¼˜çš„ï¼ŒSparkå°±ä¼šé€‰æ‹©SMJç­–ç•¥è®¡ç®—ã€‚</strong>åœ¨10å°C5.4xlarge AWS EC2çš„åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼ŒSMJè¦èŠ±è´¹å°†è¿‘5ä¸ªå°æ—¶æ‰å®Œæˆä¸¤å¼ è¡¨çš„å…³è”è®¡ç®—ã€‚è¿™æ ·çš„æ‰§è¡Œæ•ˆç‡ï¼Œæˆ‘ä»¬è‚¯å®šæ— æ³•æ¥å—ï¼Œä½†æˆ‘ä»¬åˆèƒ½åšå“ªäº›ä¼˜åŒ–å‘¢ï¼Ÿä½ ä¸å¦¨å…ˆèŠ±ä¸Šä¸¤åˆ†é’Ÿå»æƒ³ä¸€æƒ³ï¼Œç„¶åå†æ¥ä¸€èµ·è·Ÿæˆ‘å»åˆ†æã€‚</p><p>ä»”ç»†è§‚å¯Ÿä¸Šé¢çš„æŸ¥è¯¢è¯­å¥ï¼Œæˆ‘ä»¬å‘ç°è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„æ˜Ÿå‹æŸ¥è¯¢ï¼Œä¹Ÿå°±æ˜¯äº‹å®è¡¨ä¸ç»´åº¦è¡¨å…³è”ï¼Œä¸”ç»´è¡¨å¸¦è¿‡æ»¤æ¡ä»¶ã€‚ç»´è¡¨ä¸Šçš„è¿‡æ»¤æ¡ä»¶æ˜¯users.type = â€˜Head Userâ€™ï¼Œå³åªé€‰å–å¤´éƒ¨ç”¨æˆ·ã€‚è€Œé€šå¸¸æ¥è¯´ï¼Œç›¸æ¯”æ™®é€šç”¨æˆ·ï¼Œå¤´éƒ¨ç”¨æˆ·çš„å æ¯”å¾ˆä½ã€‚æ¢å¥è¯è¯´ï¼Œè¿™ä¸ªè¿‡æ»¤æ¡ä»¶çš„é€‰æ‹©æ€§ï¼ˆSelectivityï¼‰å¾ˆé«˜ï¼Œå®ƒå¯ä»¥å¸®åŠ©ä½ è¿‡æ»¤æ‰å¤§éƒ¨åˆ†çš„ç»´è¡¨æ•°æ®ã€‚åœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ï¼Œç”±äºå¤´éƒ¨ç”¨æˆ·å æ¯”ä¸è¶…è¿‡åƒåˆ†ä¹‹ä¸€ï¼Œå› æ­¤è¿‡æ»¤åçš„ç»´è¡¨å°ºå¯¸å¾ˆå°ï¼Œæ”¾è¿›å¹¿æ’­å˜é‡ç»°ç»°æœ‰ä½™ã€‚</p><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±è¦ç”¨åˆ°AQEäº†ï¼Œæˆ‘ä»¬çŸ¥é“AQEå…è®¸Spark SQLåœ¨è¿è¡Œæ—¶åŠ¨æ€åœ°è°ƒæ•´Joinç­–ç•¥ã€‚æˆ‘ä»¬åˆšå¥½å¯ä»¥åˆ©ç”¨è¿™ä¸ªç‰¹æ€§ï¼ŒæŠŠæœ€åˆåˆ¶å®šçš„SMJç­–ç•¥è½¬åŒ–ä¸ºBHJç­–ç•¥ï¼ˆåƒä¸‡åˆ«å¿˜äº†ï¼ŒAQEé»˜è®¤æ˜¯å…³é—­çš„ï¼Œè¦æƒ³åˆ©ç”¨å®ƒæä¾›çš„ç‰¹æ€§ï¼Œæˆ‘ä»¬å¾—å…ˆæŠŠspark.sql.adaptive.enabledé…ç½®é¡¹æ‰“å¼€ï¼‰ã€‚</p><p>ä¸è¿‡ï¼Œå³ä¾¿è¿‡æ»¤æ¡ä»¶çš„é€‰æ‹©æ€§å¾ˆé«˜ï¼Œåœ¨åƒåˆ†ä¹‹ä¸€å·¦å³ï¼Œè¿‡æ»¤ä¹‹åçš„ç»´è¡¨è¿˜æ˜¯æœ‰20MBå¤§å°ï¼Œè¿™ä¸ªå°ºå¯¸è¿˜æ˜¯è¶…è¿‡äº†é»˜è®¤å€¼å¹¿æ’­é˜ˆå€¼10MBã€‚å› æ­¤ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æŠŠå¹¿æ’­é˜ˆå€¼spark.sql.autoBroadcastJoinThresholdè°ƒé«˜ä¸€äº›ï¼Œæ¯”å¦‚1GBï¼ŒAQEæ‰ä¼šæŠŠSMJé™çº§ä¸ºBHJã€‚åšäº†è¿™äº›è°ƒä¼˜ä¹‹åï¼Œåœ¨åŒæ ·çš„é›†ç¾¤è§„æ¨¡ä¸‹ï¼Œä½œä¸šçš„ç«¯åˆ°ç«¯æ‰§è¡Œæ—¶é—´ä»ä¹‹å‰çš„5ä¸ªå°æ—¶ç¼©å‡ä¸º30åˆ†é’Ÿã€‚</p><p>è®©ä½œä¸šçš„æ‰§è¡Œæ€§èƒ½æå‡äº†ä¸€ä¸ªæ•°é‡çº§ä¹‹åï¼Œæˆ‘ä»¬çš„è°ƒä¼˜å°±ç»“æŸäº†å—ï¼Ÿåœ¨è°ƒä¼˜çš„æœ¬è´¨é‚£ä¸€è®²ï¼Œæˆ‘ä»¬ä¸€å†å¼ºè°ƒï¼Œéšç€æœ¨æ¡¶çŸ­æ¿çš„æ­¤æ¶ˆå½¼é•¿ï¼Œè°ƒä¼˜æ˜¯ä¸€ä¸ªä¸æ–­æŒç»­çš„è¿‡ç¨‹ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å› å¾ªç“¶é¢ˆçš„å˜åŒ–ï¼ŒåŠ¨æ€åœ°åˆ‡æ¢è°ƒä¼˜æ–¹æ³•ï¼Œå»è¿½æ±‚ä¸€ç§æ‰€æœ‰æœ¨æ¿é½å¹³ã€æ²¡æœ‰ç“¶é¢ˆçš„çŠ¶æ€ã€‚</p><p>é‚£ä¹ˆï¼Œå½“æˆ‘ä»¬ç”¨åŠ¨æ€Joinç­–ç•¥ï¼ŒæŠŠSMJç­–ç•¥ä¸­Shuffleå¼•å…¥çš„æµ·é‡æ•°æ®åˆ†å‘è¿™å—çŸ­æ¿è¡¥é½ä¹‹åï¼Œè¿˜æœ‰æ²¡æœ‰â€œæ–°æ™‹â€çš„çŸ­æ¿éœ€è¦ä¿®ç†å‘¢ï¼Ÿ</p><p><strong>å¯¹äºæ¡ˆä¾‹ä¸­çš„è¿™ç§æ˜Ÿå‹å…³è”ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åˆ©ç”¨DPPæœºåˆ¶æ¥å‡å°‘äº‹å®è¡¨çš„æ‰«æé‡ï¼Œè¿›ä¸€æ­¥å‡å°‘I/Oå¼€é”€ã€æå‡æ€§èƒ½ã€‚</strong>å’ŒAQEä¸åŒï¼ŒDPPå¹¶ä¸éœ€è¦å¼€å‘è€…ç‰¹åˆ«è®¾ç½®äº›ä»€ä¹ˆï¼Œåªè¦æ»¡è¶³æ¡ä»¶ï¼ŒDPPæœºåˆ¶ä¼šè‡ªåŠ¨è§¦å‘ã€‚</p><p>ä½†æ˜¯æƒ³è¦ä½¿ç”¨DPPåšä¼˜åŒ–ï¼Œè¿˜æœ‰3ä¸ªå…ˆå†³æ¡ä»¶éœ€è¦æ»¡è¶³ï¼š</p><ul>\n<li>DPPä»…æ”¯æŒç­‰å€¼Joinsï¼Œä¸æ”¯æŒå¤§äºæˆ–è€…å°äºè¿™ç§ä¸ç­‰å€¼å…³è”å…³ç³»</li>\n<li>ç»´è¡¨è¿‡æ»¤ä¹‹åçš„æ•°æ®é›†ï¼Œå¿…é¡»è¦å°äºå¹¿æ’­é˜ˆå€¼ï¼Œå› æ­¤å¼€å‘è€…è¦æ³¨æ„è°ƒæ•´é…ç½®é¡¹spark.sql.autoBroadcastJoinThreshold</li>\n<li>äº‹å®è¡¨å¿…é¡»æ˜¯åˆ†åŒºè¡¨ï¼Œä¸”åˆ†åŒºå­—æ®µï¼ˆå¯ä»¥æ˜¯å¤šä¸ªï¼‰å¿…é¡»åŒ…å«Join Key</li>\n</ul><p>æˆ‘ä»¬å¯ä»¥ç›´æ¥åˆ¤æ–­å‡ºæŸ¥è¯¢æ»¡è¶³å‰ä¸¤ä¸ªæ¡ä»¶ï¼Œæ»¡è¶³ç¬¬ä¸€ä¸ªæ¡ä»¶å¾ˆå¥½ç†è§£ã€‚æ»¡è¶³ç¬¬äºŒä¸ªæ¡ä»¶æ˜¯å› ä¸ºï¼Œç»è¿‡ç¬¬ä¸€æ­¥AQEçš„ä¼˜åŒ–ä¹‹åï¼Œå¹¿æ’­é˜ˆå€¼è¶³å¤Ÿå¤§ï¼Œè¶³ä»¥å®¹çº³è¿‡æ»¤ä¹‹åçš„ç»´è¡¨ã€‚é‚£ä¹ˆï¼Œè¦æƒ³åˆ©ç”¨DPPæœºåˆ¶ï¼Œæˆ‘ä»¬å¿…é¡»è¦è®©ordersæˆä¸ºåˆ†åŒºè¡¨ï¼Œä¹Ÿå°±æ˜¯åšä¸¤ä»¶äº‹æƒ…ï¼š</p><ul>\n<li>åˆ›å»ºä¸€å¼ æ–°çš„è®¢å•è¡¨orders_newï¼Œå¹¶æŒ‡å®šuserIdä¸ºåˆ†åŒºé”®</li>\n<li>æŠŠåŸè®¢å•è¡¨ordersçš„å…¨éƒ¨æ•°æ®ï¼ŒçŒè¿›è¿™å¼ æ–°çš„è®¢å•è¡¨orders_new</li>\n</ul><pre><code>//æŸ¥è¯¢è¯­å¥\nselect (orders_new.price * orders_new.quantity) as revenue, users.name\nfrom orders_new inner join users on orders_new.userId = users.id\nwhere users.type = â€˜Head Userâ€™\ngroup by users.name\norder by revenue desc\n</code></pre><p>ç”¨orders_newè¡¨æ›¿æ¢ordersè¡¨ä¹‹åï¼Œåœ¨åŒæ ·çš„åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ï¼ŒæŸ¥è¯¢æ—¶é—´å°±ä»30åˆ†é’Ÿè¿›ä¸€æ­¥ç¼©çŸ­åˆ°äº†15åˆ†é’Ÿã€‚</p><p>ä½ å¯èƒ½ä¼šè¯´ï¼šâ€œä¸ºäº†åˆ©ç”¨DPPï¼Œé‡æ–°å»ºè¡¨ã€çŒè¡¨ï¼Œè¿™æ ·ä¹Ÿéœ€è¦èŠ±è´¹ä¸å°‘æ—¶é—´å•Šï¼è¿™ä¸æ˜¯ç›¸å½“äºæŠŠè¿è¡Œæ—¶é—´ä»æŸ¥è¯¢è½¬å«åˆ°å»ºè¡¨ã€çŒæ•°äº†å—ï¼Ÿâ€ä½ è¯´çš„æ²¡é”™ï¼Œç¡®å®æ˜¯è¿™ä¹ˆå›äº‹ã€‚å¦‚æœä¸ºäº†æŸ¥è¯¢æ•ˆæœï¼Œä¸´æ—¶å†å»ä¿®æ”¹è¡¨ç»“æ„ã€è¿ç§»æ•°æ®ç¡®å®åˆ’ä¸æ¥ï¼Œå±äºâ€œä¸´æ—¶æŠ±ä½›è„šâ€ã€‚å› æ­¤ï¼Œä¸ºäº†æœ€å¤§é™åº¦åœ°åˆ©ç”¨DPPï¼Œåœ¨åšæ•°ä»“è§„åˆ’çš„æ—¶å€™ï¼Œå¼€å‘è€…å°±åº”è¯¥ç»“åˆå¸¸ç”¨æŸ¥è¯¢ä¸å…¸å‹åœºæ™¯ï¼Œæå‰åšå¥½è¡¨ç»“æ„çš„è®¾è®¡ï¼Œè¿™è‡³å°‘åŒ…æ‹¬Schemaã€åˆ†åŒºé”®ã€å­˜å‚¨æ ¼å¼ç­‰ç­‰ã€‚</p><h2>æ¡ˆä¾‹3ï¼šå°è¡¨æ•°æ®åˆ†å¸ƒå‡åŒ€</h2><p>åœ¨ä¸Šé¢çš„ä¸¤ä¸ªæ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬éƒ½æ˜¯éµå¾ªâ€œèƒ½çœåˆ™çœâ€çš„å¼€å‘åŸåˆ™ï¼Œæƒ³æ–¹è®¾æ³•åœ°æŠŠShuffle Joinsåˆ‡æ¢ä¸ºBroadcast Joinsï¼Œä»è€Œæ¶ˆé™¤Shuffleã€‚ä½†æ˜¯ï¼Œæ€»æœ‰é‚£ä¹ˆä¸€äº›â€œé¡½å›ºâ€çš„åœºæ™¯ï¼Œæ— è®ºæˆ‘ä»¬æ€ä¹ˆä¼˜åŒ–ï¼Œä¹Ÿæ²¡åŠæ³•åšåˆ°è¿™ä¸€ç‚¹ã€‚é‚£ä¹ˆå¯¹äºè¿™äº›â€œé¡½å›ºåˆ†å­â€ï¼Œæˆ‘ä»¬è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ</p><p>æˆ‘ä»¬çŸ¥é“ï¼Œå¦‚æœå…³è”åœºæ™¯ä¸æ»¡è¶³BHJæ¡ä»¶ï¼ŒSpark SQLä¼šä¼˜å…ˆé€‰æ‹©SMJç­–ç•¥å®Œæˆå…³è”è®¡ç®—ã€‚ä½†æ˜¯åœ¨ä¸Šä¸€è®²æˆ‘ä»¬è¯´åˆ°ï¼Œ<strong>å½“å‚ä¸Joinçš„ä¸¤å¼ è¡¨å°ºå¯¸ç›¸å·®æ‚¬æ®Šä¸”å°è¡¨æ•°æ®åˆ†å¸ƒå‡åŒ€çš„æ—¶å€™ï¼ŒSHJå¾€å¾€æ¯”SMJçš„æ‰§è¡Œæ•ˆç‡æ›´é«˜</strong>ã€‚åŸå› å¾ˆç®€å•ï¼Œå°è¡¨æ„å»ºå“ˆå¸Œè¡¨çš„å¼€é”€è¦å°äºä¸¤å¼ è¡¨æ’åºçš„å¼€é”€ã€‚</p><p>æˆ‘ä»¬è¿˜æ˜¯ä»¥ä¸Šä¸€ä¸ªæ¡ˆä¾‹çš„æŸ¥è¯¢ä¸ºä¾‹ï¼Œä¸è¿‡å‘¢ï¼Œè¿™æ¬¡æˆ‘ä»¬æŠŠç»´è¡¨çš„è¿‡æ»¤æ¡ä»¶å»æ‰ï¼Œå»ç»Ÿè®¡æ‰€æœ‰ç”¨æˆ·è´¡çŒ®çš„è¥ä¸šé¢ã€‚åœ¨10å°C5.4xlarge AWS EC2çš„åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼Œå»æ‰è¿‡æ»¤æ¡ä»¶çš„SMJèŠ±è´¹äº†å°†è¿‘7ä¸ªå°æ—¶æ‰å®Œæˆä¸¤å¼ è¡¨çš„å…³è”è®¡ç®—ã€‚</p><pre><code>//æŸ¥è¯¢è¯­å¥\nselect (orders.price * order.quantity) as revenue, users.name\nfrom orders inner join users on orders.userId = users.id\ngroup by users.name\norder by revenue desc\n</code></pre><p>ç”±äºç»´è¡¨çš„æŸ¥è¯¢æ¡ä»¶ä¸å¤å­˜åœ¨ï¼Œå› æ­¤æ¡ˆä¾‹2ä¸­çš„ä¸¤ä¸ªä¼˜åŒ–æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯AQE Joinç­–ç•¥è°ƒæ•´å’ŒDPPæœºåˆ¶ï¼Œä¹Ÿéƒ½å¤±å»äº†ç”Ÿæ•ˆçš„å‰æã€‚<strong>è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸å¦¨ä½¿ç”¨Join Hintsæ¥å¼ºåˆ¶Spark SQLå»é€‰æ‹©SHJç­–ç•¥è¿›è¡Œå…³è”è®¡ç®—</strong>ï¼Œè°ƒæ•´åçš„æŸ¥è¯¢è¯­å¥å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p><pre><code>//æ·»åŠ Join hintsä¹‹åçš„æŸ¥è¯¢è¯­å¥\nselect /*+ shuffle_hash(orders) */ (orders.price * order.quantity) as revenue, users.name\nfrom orders inner join users on orders.userId = users.id\ngroup by users.name\norder by revenue desc\n</code></pre><p>å°†Joinç­–ç•¥è°ƒæ•´ä¸ºSHJä¹‹åï¼Œåœ¨åŒæ ·çš„é›†ç¾¤è§„æ¨¡ä¸‹ï¼Œä½œä¸šçš„ç«¯åˆ°ç«¯æ‰§è¡Œæ—¶é—´ä»ä¹‹å‰çš„7ä¸ªå°æ—¶ç¼©å‡åˆ°5ä¸ªå°æ—¶ï¼Œç›¸æ¯”è°ƒä¼˜å‰ï¼Œæˆ‘ä»¬è·å¾—äº†å°†è¿‘30%çš„æ€§èƒ½æå‡ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<strong>SHJè¦æƒ³æˆåŠŸåœ°å®Œæˆè®¡ç®—ã€ä¸æŠ›OOMå¼‚å¸¸ï¼Œéœ€è¦ä¿è¯å°è¡¨çš„æ¯ä¸ªæ•°æ®åˆ†ç‰‡éƒ½èƒ½æ”¾è¿›å†…å­˜</strong>ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆï¼Œæˆ‘ä»¬è¦æ±‚å°è¡¨çš„æ•°æ®åˆ†å¸ƒå¿…é¡»æ˜¯å‡åŒ€çš„ã€‚å¦‚æœå°è¡¨å­˜åœ¨æ•°æ®å€¾æ–œçš„é—®é¢˜ï¼Œé‚£ä¹ˆå€¾æ–œåˆ†åŒºçš„OOMå°†ä¼šæ˜¯ä¸€ä¸ªå¤§æ¦‚ç‡äº‹ä»¶ï¼ŒSHJçš„è®¡ç®—ä¹Ÿä¼šå› æ­¤è€Œä¸­æ–­ã€‚</p><h2>å°ç»“</h2><p>ä»Šå¤©è¿™ä¸€è®²ï¼Œæˆ‘ä»¬ä»3ä¸ªæ¡ˆä¾‹å‡ºå‘ï¼Œæ¢è®¨å¹¶è§£é”äº†ä¸åŒåœºæ™¯ä¸‹â€œå¤§è¡¨Joinå°è¡¨â€çš„ä¼˜åŒ–æ€è·¯å’Œåº”å¯¹æ–¹æ³•ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰äº†ä»€ä¹ˆæ˜¯â€œå¤§è¡¨Joinå°è¡¨â€ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå‚ä¸Joinçš„ä¸¤å¼ è¡¨åœ¨å°ºå¯¸ä¸Šç›¸å·®3å€ä»¥ä¸Šï¼Œå°±å¯ä»¥çœ‹ä½œæ˜¯â€œå¤§è¡¨Joinå°è¡¨â€çš„è®¡ç®—åœºæ™¯ã€‚</p><p>å…¶æ¬¡ï¼Œæˆ‘ä»¬è®²äº†3ä¸ªå¤§è¡¨Joinå°è¡¨åœºæ™¯ä¸‹ï¼Œæ— æ³•é€‰æ‹©BHJçš„æ¡ˆä¾‹ã€‚</p><p>ç¬¬ä¸€ä¸ªæ¡ˆä¾‹æ˜¯Join Keysè¿œå¤§äºPayloadçš„æ•°æ®å…³è”ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ˜ å°„æ–¹æ³•ï¼ˆå¦‚å“ˆå¸Œè¿ç®—ï¼‰ï¼Œç”¨è¾ƒçŸ­çš„å­—ç¬¦ä¸²æ¥æ›¿æ¢è¶…é•¿çš„Join Keysï¼Œä»è€Œå¤§å¹…ç¼©å‡å°è¡¨çš„å­˜å‚¨ç©ºé—´ã€‚å¦‚æœç¼©å‡åçš„å°è¡¨ï¼Œè¶³ä»¥æ”¾è¿›å¹¿æ’­å˜é‡ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†SMJè½¬æ¢ä¸ºBHJï¼Œ=æ¥æ¶ˆé™¤ç¹é‡çš„Shuffleè®¡ç®—ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ˜ å°„æ–¹æ³•è¦èƒ½å¤Ÿæœ‰æ•ˆåœ°é¿å…â€œæ˜ å°„å†²çªâ€çš„é—®é¢˜ï¼Œé¿å…å‡ºç°ä¸åŒçš„Join Keysè¢«æ˜ å°„æˆåŒä¸€ä¸ªæ•°å€¼ã€‚</p><p>ç¬¬äºŒä¸ªæ¡ˆä¾‹æ˜¯ï¼Œå¦‚æœå°è¡¨æºå¸¦è¿‡æ»¤æ¡ä»¶ï¼Œä¸”è¿‡æ»¤æ¡ä»¶çš„é€‰æ‹©æ€§å¾ˆé«˜ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¼€å¯AQEçš„Joinç­–ç•¥è°ƒæ•´ç‰¹æ€§ï¼Œåœ¨è¿è¡Œæ—¶æŠŠSMJè½¬æ¢ä¸ºBHJï¼Œä»è€Œå¤§å¹…æå‡æ‰§è¡Œæ€§èƒ½ã€‚è¿™é‡Œæœ‰ä¸¤ç‚¹éœ€è¦æˆ‘ä»¬ç‰¹åˆ«æ³¨æ„ï¼šä¸€æ˜¯ï¼Œä¸ºäº†èƒ½å¤ŸæˆåŠŸå®Œæˆè½¬æ¢ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿è¿‡æ»¤ä¹‹åçš„ç»´è¡¨å°ºå¯¸å°äºå¹¿æ’­é˜ˆå€¼ï¼›äºŒæ˜¯ï¼Œå¦‚æœå¤§è¡¨æœ¬èº«æ˜¯æŒ‰ç…§Join Keysè¿›è¡Œåˆ†åŒºçš„è¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿˜å¯ä»¥å……åˆ†åˆ©ç”¨DPPæœºåˆ¶ï¼Œæ¥è¿›ä¸€æ­¥ç¼©å‡å¤§è¡¨æ‰«æçš„I/Oå¼€é”€ï¼Œä»è€Œæå‡æ€§èƒ½ã€‚</p><p>ç¬¬ä¸‰ä¸ªæ¡ˆä¾‹æ˜¯ï¼Œå¦‚æœå°è¡¨ä¸å¸¦è¿‡æ»¤æ¡ä»¶ï¼Œä¸”å°ºå¯¸è¿œè¶…å¹¿æ’­é˜ˆå€¼ã€‚å¦‚æœå°è¡¨æœ¬èº«çš„æ•°æ®åˆ†å¸ƒæ¯”è¾ƒå‡åŒ€ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘ä½¿ç”¨Join hintså¼ºè¡Œè¦æ±‚Spark SQLåœ¨è¿è¡Œæ—¶é€‰æ‹©SHJå…³è”ç­–ç•¥ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œåœ¨â€œå¤§è¡¨Joinå°è¡¨â€çš„åœºæ™¯ä¸­ï¼Œç›¸æ¯”SMJï¼ŒSHJçš„æ‰§è¡Œæ•ˆç‡ä¼šæ›´å¥½ä¸€äº›ã€‚èƒŒåçš„åŸå› åœ¨äºï¼Œå°è¡¨æ„å»ºå“ˆå¸Œè¡¨çš„å¼€é”€ï¼Œè¦å°äºä¸¤å¼ è¡¨æ’åºçš„å¼€é”€ã€‚</p><h2>æ¯æ—¥ä¸€ç»ƒ</h2><ol>\n<li>å¯¹äºæ¡ˆä¾‹1ï¼Œæˆ‘ä»¬çš„æ ¸å¿ƒæ€è·¯æ˜¯ç”¨å“ˆå¸Œå€¼æ¥æ›¿ä»£è¶…é•¿çš„Join Keysï¼Œé™¤äº†ç”¨å“ˆå¸Œå€¼ä»¥å¤–ï¼Œä½ è§‰å¾—è¿˜æœ‰å…¶ä»–çš„æ€è·¯æˆ–æ˜¯åŠæ³•ï¼Œå»ç”¨è¾ƒçŸ­çš„å­—ç¬¦ä¸²æ¥å–ä»£è¶…é•¿çš„Join Keyså—ï¼Ÿ</li>\n<li>å¯¹äºæ¡ˆä¾‹2ï¼Œåˆ©ç”¨AQE Joinç­–ç•¥è°ƒæ•´å’ŒDDPæœºåˆ¶çš„å…³é”®ï¼Œæ˜¯ç¡®ä¿è¿‡æ»¤åçš„ç»´è¡¨å°äºå¹¿æ’­é˜ˆå€¼ã€‚ä½ èƒ½è¯´è¯´ï¼Œéƒ½æœ‰å“ªäº›æ–¹æ³•å¯ä»¥ç”¨æ¥è®¡ç®—è¿‡æ»¤åçš„ç»´è¡¨å¤§å°å—ï¼Ÿ</li>\n<li>å¯¹äºæ¡ˆä¾‹3ï¼Œå‡è®¾20GBçš„å°è¡¨å­˜åœ¨æ•°æ®å€¾æ–œï¼Œå¼ºè¡ŒæŠŠSMJè½¬åŒ–ä¸ºSHJä¼šæŠ›OOMå¼‚å¸¸ã€‚è¿™ä¸ªæ—¶å€™ï¼Œä½ è®¤ä¸ºè¿˜æœ‰å¯èƒ½ç»§ç»­ä¼˜åŒ–å—ï¼Ÿ</li>\n</ol><p>æœŸå¾…åœ¨ç•™è¨€åŒºçœ‹åˆ°ä½ çš„æ€è€ƒå’Œç­”æ¡ˆï¼Œæˆ‘ä»¬ä¸‹ä¸€è®²è§ï¼</p>","comments":[{"had_liked":false,"id":292863,"user_name":"FendoraèŒƒä¸œ_","can_delete":false,"product_type":"c1","uid":1187106,"ip_address":"","ucode":"63EE9DBEE08D70","user_header":"https://static001.geekbang.org/account/avatar/00/12/1d/22/f04cea4c.jpg","comment_is_top":false,"comment_ctime":1621043344,"is_pvip":false,"replies":[{"id":"106271","content":"ç¬¬ä¸€é¢˜è¶…èµ~ è¿™ä¸ªæ–¹æ³•éå¸¸å¥½ï¼Œå®é™…ä¸Šæˆ‘è§‰å¾—æ¯”è¾ƒhashçš„æ–¹æ³•è¿˜æ£’ï¼å› ä¸ºå®ƒå¤©ç„¶èƒ½é¿å¼€å†²çªçš„é—®é¢˜ï¼Œè€Œä¸”å­˜å‚¨æ•ˆç‡å¾ˆé«˜ï¼Œæœºæ™ºå¦‚ä½ ~ çœŸçš„ç‰¹åˆ«å¥½çš„æ–¹æ³•ï¼Œå…¶å®æœ¬è´¨ä¸Šè¿™å¯ä»¥çœ‹æˆæ˜¯ä¸€ç§ç¼–ç æ–¹å¼äº†ï¼Œè€å¼Ÿä½ ä¹Ÿææœºå™¨å­¦ä¹ å—ï¼Ÿç¼–ç çš„æ€è·¯åœ¨Machine Learningç”¨çš„éå¸¸æ™®é~ å½“ç„¶è¿™é‡Œæœ‰ä¸€ä¸ªå­—å…¸ç»´æŠ¤çš„æˆæœ¬ï¼Œä¸è¿‡å¦‚æœJoin Keysçš„cardinalityä¸æ˜¯å¾ˆå¤¸å¼ çš„è¯ï¼Œå…¶å®è¿˜å¥½~<br><br>2ã€3çš„æ€è·¯éƒ½æ²¡é—®é¢˜~ ","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1621408869,"ip_address":"","comment_id":292863,"utype":1}],"discussion_count":4,"race_medal":0,"score":"18800912528","product_id":100073401,"comment_content":"é—®é¢˜å›ç­”<br>1.ç»™join keysæ¯ä¸ªå­—æ®µç»´æŠ¤ä¸€ä¸ªå­—å…¸ï¼Œæ¯ä¸ªå­—æ®µå€¼åœ¨å­—å…¸å†…å¯¹åº”ä¸€ä¸ªå”¯ä¸€çš„æ•´æ•°ã€‚æ‹¿åˆ°æ¯ä¸ªå­—æ®µæŒ‡å®šçš„ç§æ•´æ•°ï¼Œç„¶åç»„è£…èµ·æ¥ï¼Œä½œä¸ºæ–°çš„join keyã€‚<br> 2.æŠŠç»´åº¦è¡¨æŸ¥è¯¢sqlå•ç‹¬æ‹¿å‡ºæ¥ï¼Œç¼“å­˜å…¶dfï¼ŒæŸ¥çœ‹å…¶å±‹é‡Œè®¡åˆ’ï¼Œå¯ä»¥çŸ¥é“å®ƒç»“æœé›†å¤§å°ã€‚<br>3.å‚è€ƒAQEçš„è‡ªåŠ¨å€¾æ–œå¤„ç†ç‰¹æ€§ï¼ŒæŠŠæ•°æ®å€¾æ–œçš„åˆ†åŒºæ‹†åˆ†å¼€ï¼Œç„¶åå†è¿›è¡ŒSHJ","like_count":5,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":519989,"discussion_content":"ç¬¬ä¸€é¢˜è¶…èµ~ è¿™ä¸ªæ–¹æ³•éå¸¸å¥½ï¼Œå®é™…ä¸Šæˆ‘è§‰å¾—æ¯”è¾ƒhashçš„æ–¹æ³•è¿˜æ£’ï¼å› ä¸ºå®ƒå¤©ç„¶èƒ½é¿å¼€å†²çªçš„é—®é¢˜ï¼Œè€Œä¸”å­˜å‚¨æ•ˆç‡å¾ˆé«˜ï¼Œæœºæ™ºå¦‚ä½ ~ çœŸçš„ç‰¹åˆ«å¥½çš„æ–¹æ³•ï¼Œå…¶å®æœ¬è´¨ä¸Šè¿™å¯ä»¥çœ‹æˆæ˜¯ä¸€ç§ç¼–ç æ–¹å¼äº†ï¼Œè€å¼Ÿä½ ä¹Ÿææœºå™¨å­¦ä¹ å—ï¼Ÿç¼–ç çš„æ€è·¯åœ¨Machine Learningç”¨çš„éå¸¸æ™®é~ å½“ç„¶è¿™é‡Œæœ‰ä¸€ä¸ªå­—å…¸ç»´æŠ¤çš„æˆæœ¬ï¼Œä¸è¿‡å¦‚æœJoin Keysçš„cardinalityä¸æ˜¯å¾ˆå¤¸å¼ çš„è¯ï¼Œå…¶å®è¿˜å¥½~\n\n2ã€3çš„æ€è·¯éƒ½æ²¡é—®é¢˜~ ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621408869,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1187106,"avatar":"https://static001.geekbang.org/account/avatar/00/12/1d/22/f04cea4c.jpg","nickname":"FendoraèŒƒä¸œ_","note":"","ucode":"63EE9DBEE08D70","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375068,"discussion_content":"ç£Šå“¥ï¼Œæˆ‘æ˜¯æolapæ•°æ®åº“å†…æ ¸æ–¹å‘çš„ğŸ˜€","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1621473628,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":1187106,"avatar":"https://static001.geekbang.org/account/avatar/00/12/1d/22/f04cea4c.jpg","nickname":"FendoraèŒƒä¸œ_","note":"","ucode":"63EE9DBEE08D70","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375927,"discussion_content":"666~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621870918,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":375068,"ip_address":""},"score":375927,"extra":""}]},{"author":{"id":1581708,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eozzWrelqaW7GWmbGGMejOV3DIDsMXTpib5ib9W5yHM0s1oDpvOb70G2SdjRs7evxv8T3VVjZTeEeyQ/132","nickname":"Geek_c12c37","note":"","ucode":"7EFDD2E596F18E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":382406,"discussion_content":"æœ‰ç‚¹ç±»ä¼¼bitmap","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625558877,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":298764,"user_name":"è¶…çº§ä¸¹","can_delete":false,"product_type":"c1","uid":1300070,"ip_address":"","ucode":"6735EF97F10649","user_header":"https://static001.geekbang.org/account/avatar/00/13/d6/66/62206d01.jpg","comment_is_top":false,"comment_ctime":1624318779,"is_pvip":false,"replies":[{"id":"108449","content":"ç¡®å®ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯Join Keyå’Œåˆ†åŒºé”®çš„çŸ›ç›¾ã€‚<br><br>åˆ†åŒºé”®è¦æ±‚Cardinalityä¸èƒ½å¤ªé«˜ï¼Œå¦åˆ™å°±ä¼šå‡ºç°æ–‡ä»¶åˆ†å¸ƒè¿‡ç»†ã€è¿‡æ•£ï¼Œåˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿè´Ÿæ‹…è¿‡é‡ã€‚ä½†æ˜¯å¦ä¸€æ–¹é¢ï¼ŒJoin Keyå¾€å¾€æ˜¯userIdã€orderIdã€txIdè¿™ç±»Cardinalityå¾ˆå¤§çš„å­—æ®µï¼Œè¿™ä¸ªæ˜¯ç”±ä¸šåŠ¡é€»è¾‘å†³å®šçš„ï¼Œå¾ˆéš¾æ”¹å˜ã€‚<br><br>å› æ­¤ï¼Œåˆ†åŒºé”®å’ŒJoin Keyå°±ä¼šå­˜åœ¨åšå¼ˆï¼Œæ¢å¥è¯è¯´ï¼Œæ˜¯ç‰ºç‰²æ–‡ä»¶ç³»ç»Ÿæ•ˆç‡æ¥å¼ºè¡Œè§¦å‘DPPï¼Œè¿˜æ˜¯ä¿è¯æ–‡ä»¶ç³»ç»Ÿæ•ˆç‡è€Œæ”¾å¼ƒDPPï¼Œè¿™é‡Œé¢å°±ä¼šæœ‰ä¸€ä¸ªå–èˆçš„é—®é¢˜ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1624433671,"ip_address":"","comment_id":298764,"utype":1}],"discussion_count":2,"race_medal":0,"score":"10214253371","product_id":100073401,"comment_content":"è€å¸ˆï¼Œæˆ‘æœ‰ä¸ªç–‘é—®ï¼Œdppï¼Œä¸ä¼šå¯¼è‡´inodeè¿‡é«˜å—ï¼Ÿ ç‰¹åˆ«æ˜¯åœ¨ç”¨æˆ·ä¸Šåšåˆ†åŒºè¿™ç§ã€‚ã€‚ã€‚","like_count":2,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":522235,"discussion_content":"ç¡®å®ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯Join Keyå’Œåˆ†åŒºé”®çš„çŸ›ç›¾ã€‚\n\nåˆ†åŒºé”®è¦æ±‚Cardinalityä¸èƒ½å¤ªé«˜ï¼Œå¦åˆ™å°±ä¼šå‡ºç°æ–‡ä»¶åˆ†å¸ƒè¿‡ç»†ã€è¿‡æ•£ï¼Œåˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿè´Ÿæ‹…è¿‡é‡ã€‚ä½†æ˜¯å¦ä¸€æ–¹é¢ï¼ŒJoin Keyå¾€å¾€æ˜¯userIdã€orderIdã€txIdè¿™ç±»Cardinalityå¾ˆå¤§çš„å­—æ®µï¼Œè¿™ä¸ªæ˜¯ç”±ä¸šåŠ¡é€»è¾‘å†³å®šçš„ï¼Œå¾ˆéš¾æ”¹å˜ã€‚\n\nå› æ­¤ï¼Œåˆ†åŒºé”®å’ŒJoin Keyå°±ä¼šå­˜åœ¨åšå¼ˆï¼Œæ¢å¥è¯è¯´ï¼Œæ˜¯ç‰ºç‰²æ–‡ä»¶ç³»ç»Ÿæ•ˆç‡æ¥å¼ºè¡Œè§¦å‘DPPï¼Œè¿˜æ˜¯ä¿è¯æ–‡ä»¶ç³»ç»Ÿæ•ˆç‡è€Œæ”¾å¼ƒDPPï¼Œè¿™é‡Œé¢å°±ä¼šæœ‰ä¸€ä¸ªå–èˆçš„é—®é¢˜ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1624433671,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1549032,"avatar":"","nickname":"Zzz","note":"","ucode":"9323254354868B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":382501,"discussion_content":"æˆ‘è§‰å¾—è¿™å¯èƒ½ä¸æ˜¯åšå¼ˆçš„é—®é¢˜ï¼Œè€Œæ˜¯æ•°ä»“çš„è®¾è®¡è€…åœ¨è®¾è®¡ä¹‹åˆå¾ˆå¤§ç¨‹åº¦ä¸Šä¸ä¼šæŒ‰ç…§è¿™äº›idå­—æ®µå»ºåˆ†åŒºï¼Œå³ä½¿ä»–çŸ¥é“æœ‰äº›idåé¢ä¼šè¢«é¢‘ç¹ä½¿ç”¨ï¼Œä½†æ˜¯ä¿ä¸å‡†åé¢æœ‰ä»€ä¹ˆå…¶ä»–éœ€æ±‚ï¼Œå•çº¯æŒ‰ç…§idåšåˆ†åŒºå¤ªå†’é™©äº†ï¼Œåœ¨å®é™…åœºæ™¯å‡ ä¹æ²¡æœ‰","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1625620110,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":302843,"user_name":"é™ˆå¨æ´‹","can_delete":false,"product_type":"c1","uid":2264679,"ip_address":"","ucode":"DCF84B4D3A7354","user_header":"https://static001.geekbang.org/account/avatar/00/22/8e/67/afb412fb.jpg","comment_is_top":false,"comment_ctime":1626404994,"is_pvip":false,"replies":[{"id":"109815","content":"å‰ä¸¤é¢˜æ»¡åˆ†ğŸ’¯~ <br><br>ç¬¬ä¸‰é¢˜çš„è¯ï¼ŒAQEæ˜¯éœ€è¦Shuffleæ‰èƒ½ç”Ÿæ•ˆçš„ï¼Œå› æ­¤ï¼Œè¦æƒ³åˆ©ç”¨AQEæ¶ˆé™¤æ•°æ®å€¾æ–œï¼Œå¾—å…ˆå¯¹å°è¡¨åšrepartitionæ‰è¡Œã€‚<br><br>å¦å¤–ä¸€ç§å¯è¡Œçš„åŠæ³•ï¼Œå°±æ˜¯å¯ä»¥å‚è€ƒåé¢29è®²è´Ÿéš…é¡½æŠ—é‡Œé¢çš„â€œä¸¤é˜¶æ®µåŠ ç›Shuffleâ€ï¼Œé€šè¿‡åŠ ç›æŠŠæ•°æ®æ‰“æ•£ï¼Œè®©åŸæœ¬ä¸å‡è¡¡çš„æ•°æ®ï¼Œå˜å¾—å‡è¡¡ï¼Œç„¶åå†ç”¨SHJå»åšå…³è”ã€‚å½“ç„¶ï¼Œè¿™ç§æ–¹æ³•çš„å¼€å‘æˆæœ¬ä¼šé«˜å¾ˆå¤šï¼Œä¸è¿‡ç®—æ˜¯ä¸€ç§æ¯”è¾ƒé€šç”¨çš„æ–¹æ³•ã€‚<br><br>è¿™äº›æ–¹æ³•ï¼Œè¿™äº›â€œæ‹›å„¿â€ï¼Œå…¶å®ä¸å¥½è¯´å­°ä¼˜å­°åŠ£ï¼Œè¿˜è¦ç»“åˆå…·ä½“æ•°æ®é‡ã€åœºæ™¯ï¼Œç»“åˆå®é™…æ•ˆæœå»çœ‹ã€‚ä¸è¿‡ï¼Œè‰ºå¤šä¸å‹èº«ï¼Œè°ƒä¼˜æ¯”è¾ƒé‡è¦çš„ä¸€ç‚¹ï¼Œå°±æ˜¯è¦æ€è€ƒå¹¿ã€â€œæ‹›å„¿â€å¤šï¼Œç„¶åé€šè¿‡å¯¹æ¯”ä¸åŒä¼˜åŒ–æ–¹æ³•çš„ä¼˜åŠ£åŠ¿å’Œæ•ˆæœå·®å¼‚ï¼Œæ¥æ›´å¥½åœ°ç†è§£Sparkï¼Œè¿™æ ·åé¢å†æœ‰ç±»ä¼¼æƒ…å†µï¼Œå°±èƒ½è½»è½¦ç†Ÿè·¯å•¦~","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1626775258,"ip_address":"","comment_id":302843,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5921372290","product_id":100073401,"comment_content":"é—®é¢˜å›ç­”ã€‚<br><br>ç¬¬ä¸€é¢˜ï¼š<br>å¯¹æ¯ä¸ªå­—æ®µçš„å€¼ç”Ÿæˆä¸€ä¸ªç‹¬çƒ­ç¼–ç ï¼Œä»¥å­—å…¸æ¥ç»´æŠ¤ï¼Œç„¶åå†ç»„åˆå„ä¸ªå­—æ®µçš„ç‹¬çƒ­ç¼–ç ï¼Œå½¢æˆä¸€ä¸ªæ–°çš„join keyã€‚å½“ç„¶è¿™é‡Œä¸ä¸€å®šç”¨ç‹¬çƒ­ç¼–ç ï¼Œä¹Ÿèƒ½ç”¨äºŒè¿›åˆ¶ç¼–ç ï¼Œå¦‚æœæƒ³æ›´åŠ èŠ‚çœç©ºé—´æ›´åŠ æŠ˜è…¾ï¼Œå¯ä»¥ä½¿ç”¨ å“ˆå¤«æ›¼ç¼–ç ï¼Œå“ˆå¤«æ›¼ç¼–ç  ä»æœ¬è´¨ä¸Šè®²ï¼Œæ˜¯å°†æœ€å®è´µçš„èµ„æºï¼ˆæœ€çŸ­çš„ç¼–ç ï¼‰ç»™å‡ºç°æ¦‚ç‡æœ€å¤§çš„ä¿¡æ¯ã€‚<br><br>ç¬¬äºŒé¢˜ï¼š<br>å…ˆ Cacheï¼Œå†æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ï¼Œæœ‰ç¤ºä¾‹ä»£ç ï¼Œåœ¨ç¬¬17ç¯‡å†…å­˜è§†è§’ï¼ˆä¸‰ï¼‰ï¼šOMMéƒ½æ˜¯è°çš„é”…ï¼Ÿæ€ä¹ˆç ´ï¼Ÿ<br><br>ç¬¬ä¸‰é¢˜ï¼š<br>AQEçš„è‡ªåŠ¨å€¾æ–œå¤„ç†ï¼Œåœ¨ Reduce é˜¶æ®µï¼Œå½“ Reduce Task æ‰€éœ€å¤„ç†çš„åˆ†åŒºå°ºå¯¸å¤§äºä¸€å®šé˜ˆå€¼æ—¶ï¼Œåˆ©ç”¨ OptimizeSkewedJoin ç­–ç•¥ï¼ŒAQE ä¼šæŠŠå¤§åˆ†åŒºæ‹†æˆå¤šä¸ªå°åˆ†åŒºã€‚ï¼ˆé˜€å€¼å¯è‡ªè¡Œè®¾ç½®çš„ï¼‰","like_count":2,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":523453,"discussion_content":"å‰ä¸¤é¢˜æ»¡åˆ†ğŸ’¯~ \n\nç¬¬ä¸‰é¢˜çš„è¯ï¼ŒAQEæ˜¯éœ€è¦Shuffleæ‰èƒ½ç”Ÿæ•ˆçš„ï¼Œå› æ­¤ï¼Œè¦æƒ³åˆ©ç”¨AQEæ¶ˆé™¤æ•°æ®å€¾æ–œï¼Œå¾—å…ˆå¯¹å°è¡¨åšrepartitionæ‰è¡Œã€‚\n\nå¦å¤–ä¸€ç§å¯è¡Œçš„åŠæ³•ï¼Œå°±æ˜¯å¯ä»¥å‚è€ƒåé¢29è®²è´Ÿéš…é¡½æŠ—é‡Œé¢çš„â€œä¸¤é˜¶æ®µåŠ ç›Shuffleâ€ï¼Œé€šè¿‡åŠ ç›æŠŠæ•°æ®æ‰“æ•£ï¼Œè®©åŸæœ¬ä¸å‡è¡¡çš„æ•°æ®ï¼Œå˜å¾—å‡è¡¡ï¼Œç„¶åå†ç”¨SHJå»åšå…³è”ã€‚å½“ç„¶ï¼Œè¿™ç§æ–¹æ³•çš„å¼€å‘æˆæœ¬ä¼šé«˜å¾ˆå¤šï¼Œä¸è¿‡ç®—æ˜¯ä¸€ç§æ¯”è¾ƒé€šç”¨çš„æ–¹æ³•ã€‚\n\nè¿™äº›æ–¹æ³•ï¼Œè¿™äº›â€œæ‹›å„¿â€ï¼Œå…¶å®ä¸å¥½è¯´å­°ä¼˜å­°åŠ£ï¼Œè¿˜è¦ç»“åˆå…·ä½“æ•°æ®é‡ã€åœºæ™¯ï¼Œç»“åˆå®é™…æ•ˆæœå»çœ‹ã€‚ä¸è¿‡ï¼Œè‰ºå¤šä¸å‹èº«ï¼Œè°ƒä¼˜æ¯”è¾ƒé‡è¦çš„ä¸€ç‚¹ï¼Œå°±æ˜¯è¦æ€è€ƒå¹¿ã€â€œæ‹›å„¿â€å¤šï¼Œç„¶åé€šè¿‡å¯¹æ¯”ä¸åŒä¼˜åŒ–æ–¹æ³•çš„ä¼˜åŠ£åŠ¿å’Œæ•ˆæœå·®å¼‚ï¼Œæ¥æ›´å¥½åœ°ç†è§£Sparkï¼Œè¿™æ ·åé¢å†æœ‰ç±»ä¼¼æƒ…å†µï¼Œå°±èƒ½è½»è½¦ç†Ÿè·¯å•¦~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1626775258,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2264679,"avatar":"https://static001.geekbang.org/account/avatar/00/22/8e/67/afb412fb.jpg","nickname":"é™ˆå¨æ´‹","note":"","ucode":"DCF84B4D3A7354","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":384877,"discussion_content":"éå¸¸æ„Ÿè°¢è€å¸ˆè€å¿ƒçš„å›ç­”ï¼Œå—ç›Šè‰¯å¤šã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1626779642,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":293963,"user_name":"CycleGAN","can_delete":false,"product_type":"c1","uid":1679661,"ip_address":"","ucode":"9FD04813911A02","user_header":"https://static001.geekbang.org/account/avatar/00/19/a1/2d/599e9051.jpg","comment_is_top":false,"comment_ctime":1621652093,"is_pvip":false,"replies":[{"id":"106637","content":"å¯¹ï¼Œåšå°ç»´è¡¨çš„ç›®çš„ï¼Œå®é™…ä¸Šè¿˜æ˜¯æŠŠShuffle joinsè½¬åŒ–æˆBroadcast joinsï¼Œè¿™ä¸ªè½¬åŒ–å¸¦æ¥çš„æ”¶ç›Šå®åœ¨æ˜¯å¤ªå¤§äº†ï¼æ‰€ä»¥åƒæ–¹ç™¾è®¡åœ°å°è¯•åšBroadcast joinsï¼Œç¡®å®æ˜¯éå¸¸å€¼å¾—çš„ä¸€ä»¶äº‹~<br><br>é¢„ä¼°å¤§å°UIæ²¡é—®é¢˜ï¼Œå¦å¤–è¿˜å¯ä»¥ç”¨executePlanæŸ¥çœ‹æ‰§è¡Œè®¡åˆ’çš„æ–¹æ³•åšé¢„ä¼°ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1621695668,"ip_address":"","comment_id":293963,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5916619389","product_id":100073401,"comment_content":"æˆ‘ä»¬ç”Ÿäº§ç«¯ç”¨çš„2.4ä¹Ÿæ²¡æœ‰AQEæœºåˆ¶ï¼Œä½†æ˜¯æˆ‘è§‰å¾—å‡å°ç»´åº¦è¡¨çš„å¤§å°ä¹Ÿèƒ½æ¨¡æ‹Ÿå‡ºæ¥ï¼Œè¦åœ¨ç»´åº¦è¡¨ä¸Šåšè®¾è®¡ï¼Œæœ€æœ‰æ•ˆçš„è¿˜æ˜¯åˆ†åŒºåšå¥½ï¼Œæ¯”å¦‚æˆ‘ä»¬æŒ‰æ—¶é—´åˆ†åŒºï¼Œæ¯ä¸ªåˆ†åŒºçš„æ•°æ®å±€å°å¾ˆå¤šï¼Œç„¶åæ‘˜å‡ºæ¥éœ€è¦çš„åˆ—ï¼Œåˆ—ä¸Šçš„é•¿stråšç¼–ç ï¼Œå†åæ˜ å°„ï¼Œåˆ—ä¸Šçš„é•¿join keyåšç¼–ç ç­‰ã€‚æ„Ÿè§‰æŠŠç»´è¡¨åšå°è¿˜æ˜¯å€¼å¾—çš„ï¼Œæ€§ä»·æ¯”å¾ˆé«˜ã€‚<br>ç„¶ååˆ†æå¤§å°çš„è¯ï¼Œä¸€æ˜¯çœ‹cacheåçœ‹å¤§å°ï¼Œä¸»è¦è¿˜æ˜¯uié¡µé¢é‡Œçš„sqlè®¡åˆ’é‡Œçœ‹æ˜¯ä¸æ˜¯Broadcastï¼Œå€’æ˜¯ä¹Ÿä¸éœ€è¦éå¸¸ç²¾å‡†ã€‚<br>","like_count":1,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":520449,"discussion_content":"å¯¹ï¼Œåšå°ç»´è¡¨çš„ç›®çš„ï¼Œå®é™…ä¸Šè¿˜æ˜¯æŠŠShuffle joinsè½¬åŒ–æˆBroadcast joinsï¼Œè¿™ä¸ªè½¬åŒ–å¸¦æ¥çš„æ”¶ç›Šå®åœ¨æ˜¯å¤ªå¤§äº†ï¼æ‰€ä»¥åƒæ–¹ç™¾è®¡åœ°å°è¯•åšBroadcast joinsï¼Œç¡®å®æ˜¯éå¸¸å€¼å¾—çš„ä¸€ä»¶äº‹~\n\né¢„ä¼°å¤§å°UIæ²¡é—®é¢˜ï¼Œå¦å¤–è¿˜å¯ä»¥ç”¨executePlanæŸ¥çœ‹æ‰§è¡Œè®¡åˆ’çš„æ–¹æ³•åšé¢„ä¼°ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621695668,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":293033,"user_name":"zxk","can_delete":false,"product_type":"c1","uid":1221195,"ip_address":"","ucode":"4BB2BD9D2BCD04","user_header":"https://static001.geekbang.org/account/avatar/00/12/a2/4b/b72f724f.jpg","comment_is_top":false,"comment_ctime":1621163182,"is_pvip":false,"replies":[{"id":"106286","content":"ä¸å¯ä»¥å“ˆï¼ŒSpark SQLç›®å‰è¿˜æ²¡æœ‰é‚£ä¹ˆæ™ºèƒ½ï¼Œä½ è¿™ä¹ˆå†™çš„æ•ˆæœï¼Œå’Œå•ç‹¬æŠŠusers.type = â€˜Head Userâ€™å½“ä½œè¿‡æ»¤æ¡ä»¶çš„æ•ˆæœæ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯é€šè¿‡Spark SQL AQEæ¥åŠ¨æ€è§¦å‘Joinç­–ç•¥è°ƒæ•´ï¼Œè¿˜åšä¸åˆ°åœ¨é™æ€ä¼˜åŒ–é˜¶æ®µå°±æå‰å†³å®šåœ¨è¿è¡Œæ—¶æŠŠShuffle Joinsè½¬åŒ–ä¸ºBroadcast Joinsã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1621413176,"ip_address":"","comment_id":293033,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5916130478","product_id":100073401,"comment_content":"è€å¸ˆæˆ‘æƒ³è¯·é—®ä¸‹ï¼Œåœ¨ç¬¬äºŒä¸ªæ¡ˆä¾‹ä¸­ï¼Œå¦‚æœæˆ‘å°† join æ¡ä»¶å†™æˆ on orders.userId = users.id and users.type = â€˜Head Userâ€™  ï¼Œæ˜¯å¦èƒ½å®ç°ç»´åº¦è¡¨æå‰è¿‡æ»¤å¹¶è¾¾åˆ° Broadcast çš„è¦æ±‚ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":520047,"discussion_content":"ä¸å¯ä»¥å“ˆï¼ŒSpark SQLç›®å‰è¿˜æ²¡æœ‰é‚£ä¹ˆæ™ºèƒ½ï¼Œä½ è¿™ä¹ˆå†™çš„æ•ˆæœï¼Œå’Œå•ç‹¬æŠŠusers.type = â€˜Head Userâ€™å½“ä½œè¿‡æ»¤æ¡ä»¶çš„æ•ˆæœæ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯é€šè¿‡Spark SQL AQEæ¥åŠ¨æ€è§¦å‘Joinç­–ç•¥è°ƒæ•´ï¼Œè¿˜åšä¸åˆ°åœ¨é™æ€ä¼˜åŒ–é˜¶æ®µå°±æå‰å†³å®šåœ¨è¿è¡Œæ—¶æŠŠShuffle Joinsè½¬åŒ–ä¸ºBroadcast Joinsã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621413176,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1549032,"avatar":"","nickname":"Zzz","note":"","ucode":"9323254354868B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":382495,"discussion_content":"ä¸ºä»€ä¹ˆä¸å¯ä»¥ï¼Œå¦‚æœå…ˆå¯¹å°è¡¨ç»“åˆè¿‡æ»¤æ¡ä»¶æ”¾å…¥ä¸´æ—¶è¡¨ï¼Œç„¶åå¤§è¡¨å…³è”è¿™å¼ ä¸´æ—¶å°è¡¨ï¼Œæœ‰äººä¼šè¯´ï¼Œå»ºç«‹ä¸´æ—¶è¡¨æœ‰å¼€é”€ï¼Œæˆ‘è®°å¾—å‰å‡ è®²ä¸­è¿™å¼ å°è¡¨çš„åˆ†åŒºå­—æ®µå°±æ˜¯typeï¼Œè€Œä¸”ä»å®é™…çš„æ•ˆæœæ¥çœ‹ï¼Œå³ä½¿è¿™å¼ å°è¡¨åˆ†åŒºå­—æ®µä¸æ˜¯typeä¹Ÿå…³ç³»ä¸å¤§ï¼Œå®é™…åšè¿‡æ»¤ä¹Ÿæ˜¯å¾ˆå¿«çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625617200,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":356199,"user_name":"æ—çº¢æ³¢ :)","can_delete":false,"product_type":"c1","uid":3163171,"ip_address":"ç¦å»º","ucode":"C4EEA6BFDEEF11","user_header":"https://static001.geekbang.org/account/avatar/00/30/44/23/8f5d80ad.jpg","comment_is_top":false,"comment_ctime":1662036061,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1662036061","product_id":100073401,"comment_content":"è€å¸ˆï¼Œç¬¬äºŒä¸ªæ¡ˆä¾‹ä¸æ˜¯é€šè¿‡è°“è¯ä¸‹æ¨ï¼Œç»´è¡¨çš„æ•°æ®é‡å·²ç»é™ä¸‹æ¥äº†å—ï¼Ÿä¸ºä»€ä¹ˆè¿˜è¦å¼€å¯AQEï¼ŸAQEä¸æ˜¯é€šè¿‡åˆ¤æ–­shuffle mapè¾“å‡ºçš„ä¸­é—´æ–‡ä»¶æ¥æ‰§è¡Œçš„å—ï¼Ÿ","like_count":0},{"had_liked":false,"id":337867,"user_name":"é™Œç”Ÿçš„å¿ƒé…¸","can_delete":false,"product_type":"c1","uid":2829738,"ip_address":"","ucode":"2F221D93403D20","user_header":"https://static001.geekbang.org/account/avatar/00/2b/2d/aa/e33e9edd.jpg","comment_is_top":false,"comment_ctime":1647097425,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1647097425","product_id":100073401,"comment_content":"æœ‰ä¸ªç–‘é—®ï¼Œå¯¹äºæ–¹æ¡ˆäºŒï¼Œå¦‚æœç»´è¡¨ã€ç”¨æˆ·è¡¨ã€‘æœ¬èº«userIDè¶…å¤§ï¼Œè¿˜ç”¨æ¥å»ºåˆ†åŒºè¡¨ï¼Œè¿™ä¸ªæ˜¯ä¸æ˜¯ä¼šå¯¼è‡´hdfs namenodeè´Ÿè½½è¿‡é‡ï¼Œç”šè‡³å¯¼è‡´è¶…è¿‡hiveé™åˆ¶çš„åˆ†åŒºæ•°é‡ï¼Œåˆ›å»ºå¤±è´¥ï¼Ÿ","like_count":0},{"had_liked":false,"id":331416,"user_name":"Unknown element","can_delete":false,"product_type":"c1","uid":2028277,"ip_address":"","ucode":"34A129800D0238","user_header":"https://static001.geekbang.org/account/avatar/00/1e/f2/f5/b82f410d.jpg","comment_is_top":false,"comment_ctime":1642580491,"is_pvip":false,"replies":[{"id":"121204","content":"ç¡®å®ï¼Œå¯ä»¥åˆ©ç”¨AQEçš„è‡ªåŠ¨å€¾æ–œå¤„ç†æ¥handle 20Gçš„å°è¡¨ï¼Œä¸è¿‡å…¶å®æˆ‘ä»¬åœ¨ä¸‹ä¸€ç« èŠ‚ä¼šä»‹ç»ï¼ŒAQEçš„è‡ªåŠ¨å€¾æ–œå¤„ç†ï¼Œåªèƒ½handle taskç²’åº¦çš„å€¾æ–œï¼Œæ²¡æœ‰åŠæ³•å¤„ç†Executorsç²’åº¦çš„å€¾æ–œï¼Œè¿™ä¸ªæ—¶å€™ï¼Œè¿˜æ˜¯éœ€è¦ä¾èµ–ä¸¤é˜¶æ®µçš„Shuffleæ¥å®Œæˆï¼Œå…·ä½“çš„åŠ ç›æ“ä½œå¯ä»¥å‚è€ƒåé¢ä¸€ç« å“ˆ","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1043100","ctime":1642780285,"ip_address":"","comment_id":331416,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1642580491","product_id":100073401,"comment_content":"è€å¸ˆæ‚¨å¥½ æ‚¨åœ¨è¯„è®º @é™ˆå¨æ´‹ å¯¹é—®é¢˜3çš„å›ç­”æ—¶è¯´ &quot;AQEæ˜¯éœ€è¦Shuffleæ‰èƒ½ç”Ÿæ•ˆçš„ï¼Œå› æ­¤ï¼Œè¦æƒ³åˆ©ç”¨AQEæ¶ˆé™¤æ•°æ®å€¾æ–œï¼Œå¾—å…ˆå¯¹å°è¡¨åšrepartitionæ‰è¡Œ&quot;ï¼Œä½†æ˜¯é—®é¢˜3çš„èƒŒæ™¯å·²ç»æ˜¯å°è¡¨å°ºå¯¸å¤§äºå¹¿æ’­é˜ˆå€¼ å› æ­¤å¿…é¡»èµ°shuffleäº†å‘€ï¼Œé‚£AQEåœ¨è¿™ä¸ªshuffleçš„mapæ–‡ä»¶è¾“å‡ºä¹‹åè¿›è¡Œåˆ†åŒºå€¾æ–œå¤„ç†ä¸å°±å¯ä»¥äº†å—ï¼Ÿä¸ºä»€ä¹ˆè¦é¢å¤–å¯¹å°è¡¨è¿›è¡Œä¸€æ¬¡ repartition å‘¢ï¼Ÿè°¢è°¢è€å¸ˆ~","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":547649,"discussion_content":"ç¡®å®ï¼Œå¯ä»¥åˆ©ç”¨AQEçš„è‡ªåŠ¨å€¾æ–œå¤„ç†æ¥handle 20Gçš„å°è¡¨ï¼Œä¸è¿‡å…¶å®æˆ‘ä»¬åœ¨ä¸‹ä¸€ç« èŠ‚ä¼šä»‹ç»ï¼ŒAQEçš„è‡ªåŠ¨å€¾æ–œå¤„ç†ï¼Œåªèƒ½handle taskç²’åº¦çš„å€¾æ–œï¼Œæ²¡æœ‰åŠæ³•å¤„ç†Executorsç²’åº¦çš„å€¾æ–œï¼Œè¿™ä¸ªæ—¶å€™ï¼Œè¿˜æ˜¯éœ€è¦ä¾èµ–ä¸¤é˜¶æ®µçš„Shuffleæ¥å®Œæˆï¼Œå…·ä½“çš„åŠ ç›æ“ä½œå¯ä»¥å‚è€ƒåé¢ä¸€ç« å“ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642780285,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":323467,"user_name":"å­å…®","can_delete":false,"product_type":"c1","uid":2767208,"ip_address":"","ucode":"BA213EAB26DF16","user_header":"https://static001.geekbang.org/account/avatar/00/2a/39/68/56dfc8c0.jpg","comment_is_top":false,"comment_ctime":1637916729,"is_pvip":false,"replies":[{"id":"117406","content":"SHJå’ŒSMJï¼Œæœ€ä¸»è¦çš„åŒºåˆ«ï¼Œæ˜¯SMJå¯ä»¥åˆ©ç”¨å¤–æ’ï¼Œæˆ–è€…è¯´å¯ä»¥ä¾èµ–ç£ç›˜ï¼Œå¯¹äºå†…å­˜çš„ä¾èµ–ï¼Œæ²¡é‚£ä¸ªé‡ã€‚ä½†æ˜¯SHJå°±ä¸åŒï¼ŒHJçš„build phaseï¼Œå¿…é¡»å®Œå…¨ä¾èµ–å†…å­˜ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä¼šå¯¹å°è¡¨çš„æ•°é‡ä½“é‡ã€æ•°æ®åˆ†å¸ƒæœ‰è¦æ±‚ã€‚ä¸€æ—¦å°è¡¨æŸä¸€ä¸ªåˆ†åŒºï¼Œè¶…è¿‡Taskå†…å­˜ä¸Šé™ï¼Œå°±ç›´æ¥æŠ¥OOMï¼Œæ•´ä¸ªJobä¹Ÿå°±failäº†<br>","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1043100","ctime":1637985971,"ip_address":"","comment_id":323467,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1637916729","product_id":100073401,"comment_content":"è€å¸ˆï¼ŒSHJ è¦æ±‚å°è¡¨æ•°æ®å‡åŒ€ï¼Œé˜²æ­¢æŸä¸€åˆ†åŒºOOMï¼Œæ˜¯å› ä¸ºå°è¡¨hash åï¼Œä¼šæŠŠç›¸åŒçš„key, reduceåˆ°ä¸€ä¸ªåˆ†åŒºå—ï¼Ÿé‚£ä¹ˆè¿™æ ·SMJ åŒæ ·ä¹Ÿä¼šåœ¨shuffle åæœ‰oom çš„é£é™©å‘€ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":533817,"discussion_content":"SHJå’ŒSMJï¼Œæœ€ä¸»è¦çš„åŒºåˆ«ï¼Œæ˜¯SMJå¯ä»¥åˆ©ç”¨å¤–æ’ï¼Œæˆ–è€…è¯´å¯ä»¥ä¾èµ–ç£ç›˜ï¼Œå¯¹äºå†…å­˜çš„ä¾èµ–ï¼Œæ²¡é‚£ä¸ªé‡ã€‚ä½†æ˜¯SHJå°±ä¸åŒï¼ŒHJçš„build phaseï¼Œå¿…é¡»å®Œå…¨ä¾èµ–å†…å­˜ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä¼šå¯¹å°è¡¨çš„æ•°é‡ä½“é‡ã€æ•°æ®åˆ†å¸ƒæœ‰è¦æ±‚ã€‚ä¸€æ—¦å°è¡¨æŸä¸€ä¸ªåˆ†åŒºï¼Œè¶…è¿‡Taskå†…å­˜ä¸Šé™ï¼Œå°±ç›´æ¥æŠ¥OOMï¼Œæ•´ä¸ªJobä¹Ÿå°±failäº†\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637985971,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":307277,"user_name":"wow_xiaodi","can_delete":false,"product_type":"c1","uid":1511712,"ip_address":"","ucode":"B3FB301556A7EA","user_header":"https://static001.geekbang.org/account/avatar/00/17/11/20/9f31c4f4.jpg","comment_is_top":false,"comment_ctime":1629000339,"is_pvip":false,"replies":[{"id":"111313","content":"ç¼–ç çš„æ€è·¯å¾ˆèµ~ ä¸è¿‡ç”¨è‡ªå¢åˆ—æ˜¯ä¸è¡Œçš„ï¼ŒåŒæ ·çš„Join Keyï¼Œåº”è¯¥æœ‰åŒæ ·çš„ç¼–ç ï¼Œè¿™æ ·æ‰ä¸å½±å“åŸæœ‰çš„å…³è”é€»è¾‘ï¼Œè‡ªå¢åˆ—ä¼šå¯¼è‡´åŒæ ·çš„Join Keyï¼Œæœ‰ä¸åŒçš„ç¼–ç ã€‚<br><br>æ¯”å¦‚ï¼ŒJoin Keyæ˜¯order_idï¼Œé‚£ä¹ˆåœ¨transactionsè¡¨ä¸­ï¼Œä¼šæœ‰å¤šä¸ªåŒæ ·çš„order_idå‡ºç°ï¼Œä¹Ÿå°±æ˜¯å¤šç¬”äº¤æ˜“åŒå±äºä¸€ä¸ªè®¢å•ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œè‡ªå¢åˆ—ç¼–ç æ˜¯ä¸è¡Œçš„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1629105601,"ip_address":"","comment_id":307277,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1629000339","product_id":100073401,"comment_content":"ç¬¬ä¸€é¢˜é¦–å…ˆæ‰“å¼€aqeï¼Œå¯¹åŸºè¡¨df.dropDupilcates(***).withColumn(&quot;code&quot;, monotonically_increasing_id())ï¼Œè¿™æ ·å°±å®Œæˆå…¨å±€ç¼–ç äº†ã€‚ç„¶åé©±åŠ¨è¡¨å’ŒåŸºè¡¨éƒ½joinä¸Šè¿™ä¸ªå­—å…¸è¡¨ï¼Œå°†ç»„åˆjoin keysè½¬æ¢ä¸ºå­—å…¸å€¼","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":525102,"discussion_content":"ç¼–ç çš„æ€è·¯å¾ˆèµ~ ä¸è¿‡ç”¨è‡ªå¢åˆ—æ˜¯ä¸è¡Œçš„ï¼ŒåŒæ ·çš„Join Keyï¼Œåº”è¯¥æœ‰åŒæ ·çš„ç¼–ç ï¼Œè¿™æ ·æ‰ä¸å½±å“åŸæœ‰çš„å…³è”é€»è¾‘ï¼Œè‡ªå¢åˆ—ä¼šå¯¼è‡´åŒæ ·çš„Join Keyï¼Œæœ‰ä¸åŒçš„ç¼–ç ã€‚\n\næ¯”å¦‚ï¼ŒJoin Keyæ˜¯order_idï¼Œé‚£ä¹ˆåœ¨transactionsè¡¨ä¸­ï¼Œä¼šæœ‰å¤šä¸ªåŒæ ·çš„order_idå‡ºç°ï¼Œä¹Ÿå°±æ˜¯å¤šç¬”äº¤æ˜“åŒå±äºä¸€ä¸ªè®¢å•ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œè‡ªå¢åˆ—ç¼–ç æ˜¯ä¸è¡Œçš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629105601,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":307168,"user_name":"wow_xiaodi","can_delete":false,"product_type":"c1","uid":1511712,"ip_address":"","ucode":"B3FB301556A7EA","user_header":"https://static001.geekbang.org/account/avatar/00/17/11/20/9f31c4f4.jpg","comment_is_top":false,"comment_ctime":1628919198,"is_pvip":false,"replies":[{"id":"111317","content":"æ˜¯çš„ï¼Œ è¿™ä¸ªuse caseæ¯”è¾ƒç‰¹æ®Šï¼Œå°±æ˜¯Join Keysç‰¹åˆ«å¤šï¼Œè€Œä¸”éƒ½æ˜¯Stringç±»å‹ï¼Œå› æ­¤æ•´ä½“æ•°æ®ä½“é‡å¾ˆå¤§ã€‚ç¡®å®ï¼Œåƒä½ è¯´çš„ï¼Œä½¿ç”¨å“ˆå¸Œçš„ç›®çš„ï¼Œå°±æ˜¯ç¼©å‡Join Keyså¤§å°ï¼Œé‚£ä¹ˆå’±ä»¬è‡ªç„¶è¦ç¡®è®¤ç¼©å‡ä¹‹åçš„Join Keysï¼Œä¸€å®šè¦è¿œè¿œå°äºåŸå§‹çš„Join Keysï¼Œå¦åˆ™åšè¿™ä»¶äº‹å°±æ²¡æœ‰æ„ä¹‰å•¦~<br><br>Tungstené‚£ä¸ªï¼Œæ•´å‹å ç”¨4ä¸ªå­—èŠ‚ï¼Œè¿™ä¸ªå’Œæ•°æ®ç±»å‹æœ‰å…³ï¼Œå…¶å®å’ŒTungstenæ²¡ä»€ä¹ˆå…³ç³»çš„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1629107961,"ip_address":"","comment_id":307168,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1628919198","product_id":100073401,"comment_content":"è€å¸ˆï¼Œå¯¹äºå“ˆå¸Œå¤„ç†join keysæˆ–è®¸è¦è€ƒè™‘åŸºè¡¨çš„åˆ—æ•°é‡å’Œæ¯åˆ—æ•°æ®ç±»å‹ï¼Œå› ä¸ºæ¯•ç«Ÿä¸¤ä¸ªå“ˆå¸Œå‡½æ•°è®¡ç®—å‡ºæ¥çš„ç»“æœå†æ‹¼æ¥ï¼Œé•¿åº¦ä¸ä¸‹äº32ç”šè‡³å¤§äº64ã€‚å‡å¦‚åŸå§‹åˆ—å†…å®¹å¤§éƒ¨åˆ†éƒ½æ˜¯è‹±æ–‡å’Œæ•°å­—ï¼Œè€Œä¸”å¤§å°æˆ–é•¿åº¦éƒ½ä¸å‰å®³ï¼Œå“ˆå¸Œå¤„ç†åå­˜å‚¨å¼€é”€ä¼šä¸ä¼šæ›´åŠ å¤§äº†å‘¢ï¼Ÿæœ€åæœ‰ä¸€ä¸ªé—®é¢˜éœ€è¦ç¡®è®¤ä¸‹ï¼Œåœ¨tungstençš„æ•°æ®ç»“æ„é‡Œï¼Œä¸€ä¸ªæ•´å½¢æ•°æ®ï¼Œæ˜¯å¦ç”¨åˆ°äº†32bitçš„å­˜å‚¨ç©ºé—´å‘¢ï¼Ÿä¸€ä¸ªutf-8ç¼–ç çš„ä¸­æ–‡æ˜¯å¦å ç”¨2-4ä¸ªå­—èŠ‚ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":525067,"discussion_content":"æ˜¯çš„ï¼Œ è¿™ä¸ªuse caseæ¯”è¾ƒç‰¹æ®Šï¼Œå°±æ˜¯Join Keysç‰¹åˆ«å¤šï¼Œè€Œä¸”éƒ½æ˜¯Stringç±»å‹ï¼Œå› æ­¤æ•´ä½“æ•°æ®ä½“é‡å¾ˆå¤§ã€‚ç¡®å®ï¼Œåƒä½ è¯´çš„ï¼Œä½¿ç”¨å“ˆå¸Œçš„ç›®çš„ï¼Œå°±æ˜¯ç¼©å‡Join Keyså¤§å°ï¼Œé‚£ä¹ˆå’±ä»¬è‡ªç„¶è¦ç¡®è®¤ç¼©å‡ä¹‹åçš„Join Keysï¼Œä¸€å®šè¦è¿œè¿œå°äºåŸå§‹çš„Join Keysï¼Œå¦åˆ™åšè¿™ä»¶äº‹å°±æ²¡æœ‰æ„ä¹‰å•¦~\n\nTungstené‚£ä¸ªï¼Œæ•´å‹å ç”¨4ä¸ªå­—èŠ‚ï¼Œè¿™ä¸ªå’Œæ•°æ®ç±»å‹æœ‰å…³ï¼Œå…¶å®å’ŒTungstenæ²¡ä»€ä¹ˆå…³ç³»çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629107961,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":301896,"user_name":"siys","can_delete":false,"product_type":"c1","uid":1950249,"ip_address":"","ucode":"3F6E368A53CF9B","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/z2z2OI0z9rbCngwkzrnP8mmUOXqDjS5I2u4ibfbb2eyvLicFwiclymCYFduU7gtksO6aAvSkbkfEhqCM4fXXQwCsg/132","comment_is_top":false,"comment_ctime":1625965579,"is_pvip":true,"replies":[{"id":"109765","content":"é‡‡ç”¨userIdåšåˆ†åŒºé”®ç¡®å®å¤ªç»†ï¼Œå®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬å‡ ä¹ä¸ä¼šç”¨è¿™ä¹ˆç»†çš„IDåšåˆ†åŒºé”®ã€‚<br><br>å…ˆæ¥è¯´åˆ†æ¡¶å§ï¼Œé¦–å…ˆåˆ†æ¡¶ä¸€æ¥èƒ½é¿å…shuffleï¼ŒäºŒæ¥èƒ½èŠ‚çœI&#47;Oï¼ˆBucketing pruningï¼‰ï¼Œä¸è¿‡ï¼Œå•çº¯ç”¨åˆ†æ¡¶ï¼Œæ˜¯ä¸èƒ½è§¦å‘DPPæœºåˆ¶çš„ã€‚<br><br>å†æ¥è¯´è¯´åˆ†åŒº+åˆ†æ¡¶ï¼Œä½ æ˜¯æŒ‡é‡‡ç”¨ä¸åŒçš„Keyså—ï¼Ÿæ¯”å¦‚åˆ†åŒºç”¨æ¯”è¾ƒç²—ç²’åº¦çš„å­—æ®µã€åˆ†æ¡¶ç”¨userIdï¼Œæ˜¯è¿™ä¸ªæ„æ€å—ï¼Ÿå‡è®¾åˆ†åŒºé”®ä¸æ˜¯userIdï¼Œé‚£ä¹ˆå³ä¾¿åˆ†æ¡¶ç”¨äº†userIdï¼ŒSpark SQLä¹Ÿä¸ä¼šè§¦å‘DPPã€‚<br><br>DPPçš„æ¡ä»¶ç¡®å®æ¯”è¾ƒè‹›åˆ»ï¼Œè¦æ±‚åˆ†åŒºé”®åŒ…å«Join Keysï¼Œå› æ­¤åˆ†æ¡¶å¹¶ä¸èƒ½å¸®ä¸Šä»€ä¹ˆå¿™ã€‚<br><br>ä¸è¿‡ï¼Œå°½ç®¡å¦‚æ­¤ï¼Œåˆ†æ¡¶åœ¨é¿å…Shuffleä¸Šå€’ç¡®å®æ˜¯æŠŠå¥½æ‰‹~","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1626692392,"ip_address":"","comment_id":301896,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1625965579","product_id":100073401,"comment_content":"æ¡ˆä¾‹2ä¸­orders_newå¦‚æœé‡‡ç”¨åˆ†åŒºåŠ åˆ†æ¡¶çš„æ–¹å¼èƒ½å¤Ÿè§¦å‘DPPå—ï¼Œé‡‡ç”¨useridåˆ†çš„å¤ªç»†äº†","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":523120,"discussion_content":"é‡‡ç”¨userIdåšåˆ†åŒºé”®ç¡®å®å¤ªç»†ï¼Œå®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬å‡ ä¹ä¸ä¼šç”¨è¿™ä¹ˆç»†çš„IDåšåˆ†åŒºé”®ã€‚\n\nå…ˆæ¥è¯´åˆ†æ¡¶å§ï¼Œé¦–å…ˆåˆ†æ¡¶ä¸€æ¥èƒ½é¿å…shuffleï¼ŒäºŒæ¥èƒ½èŠ‚çœI/Oï¼ˆBucketing pruningï¼‰ï¼Œä¸è¿‡ï¼Œå•çº¯ç”¨åˆ†æ¡¶ï¼Œæ˜¯ä¸èƒ½è§¦å‘DPPæœºåˆ¶çš„ã€‚\n\nå†æ¥è¯´è¯´åˆ†åŒº+åˆ†æ¡¶ï¼Œä½ æ˜¯æŒ‡é‡‡ç”¨ä¸åŒçš„Keyså—ï¼Ÿæ¯”å¦‚åˆ†åŒºç”¨æ¯”è¾ƒç²—ç²’åº¦çš„å­—æ®µã€åˆ†æ¡¶ç”¨userIdï¼Œæ˜¯è¿™ä¸ªæ„æ€å—ï¼Ÿå‡è®¾åˆ†åŒºé”®ä¸æ˜¯userIdï¼Œé‚£ä¹ˆå³ä¾¿åˆ†æ¡¶ç”¨äº†userIdï¼ŒSpark SQLä¹Ÿä¸ä¼šè§¦å‘DPPã€‚\n\nDPPçš„æ¡ä»¶ç¡®å®æ¯”è¾ƒè‹›åˆ»ï¼Œè¦æ±‚åˆ†åŒºé”®åŒ…å«Join Keysï¼Œå› æ­¤åˆ†æ¡¶å¹¶ä¸èƒ½å¸®ä¸Šä»€ä¹ˆå¿™ã€‚\n\nä¸è¿‡ï¼Œå°½ç®¡å¦‚æ­¤ï¼Œåˆ†æ¡¶åœ¨é¿å…Shuffleä¸Šå€’ç¡®å®æ˜¯æŠŠå¥½æ‰‹~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1626692392,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1511712,"avatar":"https://static001.geekbang.org/account/avatar/00/17/11/20/9f31c4f4.jpg","nickname":"wow_xiaodi","note":"","ucode":"B3FB301556A7EA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":388694,"discussion_content":"åˆ†æ¡¶å‡ ä¹æ²¡å•¥ç”¨ï¼Œå‡è®¾æ˜¯æŒ‰useridåˆ†æ¡¶ï¼Œä½ ä¸èƒ½ç¡®ä¿ç”¨æˆ·è¡¨ç­›é€‰å‡ºçš„useridåˆ†å¸ƒåˆšåˆšå¥½åœ¨æŸä¸ªæ¡¶å†…ï¼Œåˆ°æœ€åï¼Œä½ è¿˜æ˜¯å¾—å…¨é‡æ‰«ææ•°æ®","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628916362,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":294702,"user_name":"å§šå…ˆç”Ÿ","can_delete":false,"product_type":"c1","uid":1181069,"ip_address":"","ucode":"B2FAE540D562E1","user_header":"https://static001.geekbang.org/account/avatar/00/12/05/8d/27db1e0f.jpg","comment_is_top":false,"comment_ctime":1622048362,"is_pvip":false,"replies":[{"id":"107058","content":"ä¸€ç‚¹éƒ½æ²¡æƒ³é”™ï¼Œå®Œå…¨åŒæ„ä½ è¯´çš„ã€‚è¿™ä¸ªæ¡ˆä¾‹ç¡®å®æœ‰äº›ç‰µå¼ºï¼Œå¯¹ä¸ä½å¤§å®¶ï¼Œæ—¶é—´æ¯”è¾ƒæ€¥ï¼Œæ²¡æœ‰æ‰¾åˆ°æ›´å¥½çš„æ¡ˆä¾‹ã€‚è¿™é‡Œç¡®å®å­˜åœ¨ä½ è¯´çš„éšæ‚£ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯Join Keyå’Œåˆ†åŒºé”®çš„çŸ›ç›¾ã€‚<br><br>åˆ†åŒºé”®è¦æ±‚Cardinalityä¸èƒ½å¤ªé«˜ï¼Œå¦åˆ™å°±ä¼šå‡ºç°æ–‡ä»¶åˆ†å¸ƒè¿‡ç»†ã€è¿‡æ•£ï¼Œåˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿè´Ÿæ‹…è¿‡é‡ã€‚ä½†æ˜¯å¦ä¸€æ–¹é¢ï¼ŒJoin Keyå¾€å¾€æ˜¯userIdã€orderIdã€txIdè¿™ç±»Cardinalityå¾ˆå¤§çš„å­—æ®µï¼Œè¿™ä¸ªæ˜¯ç”±ä¸šåŠ¡é€»è¾‘å†³å®šçš„ï¼Œå¾ˆéš¾æ”¹å˜ã€‚<br><br>å› æ­¤ï¼Œåˆ†åŒºé”®å’ŒJoin Keyå°±ä¼šå­˜åœ¨åšå¼ˆï¼Œæ¢å¥è¯è¯´ï¼Œæ˜¯ç‰ºç‰²æ–‡ä»¶ç³»ç»Ÿæ•ˆç‡æ¥å¼ºè¡Œè§¦å‘DPPï¼Œè¿˜æ˜¯ä¿è¯æ–‡ä»¶ç³»ç»Ÿæ•ˆç‡è€Œæ”¾å¼ƒDPPï¼Œè¿™é‡Œé¢å°±ä¼šæœ‰ä¸€ä¸ªå–èˆçš„é—®é¢˜ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1622125623,"ip_address":"","comment_id":294702,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1622048362","product_id":100073401,"comment_content":"ä¸ªäººæ„Ÿè§‰ï¼Œæ¡ˆä¾‹2çš„è§£å†³æ–¹æ¡ˆç•¥æ˜¾ç‰µå¼ºã€‚ä¸çŸ¥é“æ˜¯ä¸æ˜¯æƒ³é”™äº†ï¼Œåˆ†äº«ä¸€ä¸‹ã€‚ordersè¡¨çš„åˆ†åŒºé”®æ”¹ä¸ºuserIdï¼Œhdfsæ–‡ä»¶ä¼šæœ‰count(distinct userId)ä¸ªæ–‡ä»¶å¤¹ï¼Œå¯èƒ½çš„é—®é¢˜ï¼š1.å°æ–‡ä»¶è¿‡å¤šé€ æˆæ‰«ææ–‡ä»¶çš„taskæ•°ç›®è¿‡å¤šè¿›è€Œå¢å¤§è°ƒåº¦å¼€é”€;2.hdfs namenodeè´Ÿè½½é—®é¢˜","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":520774,"discussion_content":"ä¸€ç‚¹éƒ½æ²¡æƒ³é”™ï¼Œå®Œå…¨åŒæ„ä½ è¯´çš„ã€‚è¿™ä¸ªæ¡ˆä¾‹ç¡®å®æœ‰äº›ç‰µå¼ºï¼Œå¯¹ä¸ä½å¤§å®¶ï¼Œæ—¶é—´æ¯”è¾ƒæ€¥ï¼Œæ²¡æœ‰æ‰¾åˆ°æ›´å¥½çš„æ¡ˆä¾‹ã€‚è¿™é‡Œç¡®å®å­˜åœ¨ä½ è¯´çš„éšæ‚£ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯Join Keyå’Œåˆ†åŒºé”®çš„çŸ›ç›¾ã€‚\n\nåˆ†åŒºé”®è¦æ±‚Cardinalityä¸èƒ½å¤ªé«˜ï¼Œå¦åˆ™å°±ä¼šå‡ºç°æ–‡ä»¶åˆ†å¸ƒè¿‡ç»†ã€è¿‡æ•£ï¼Œåˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿè´Ÿæ‹…è¿‡é‡ã€‚ä½†æ˜¯å¦ä¸€æ–¹é¢ï¼ŒJoin Keyå¾€å¾€æ˜¯userIdã€orderIdã€txIdè¿™ç±»Cardinalityå¾ˆå¤§çš„å­—æ®µï¼Œè¿™ä¸ªæ˜¯ç”±ä¸šåŠ¡é€»è¾‘å†³å®šçš„ï¼Œå¾ˆéš¾æ”¹å˜ã€‚\n\nå› æ­¤ï¼Œåˆ†åŒºé”®å’ŒJoin Keyå°±ä¼šå­˜åœ¨åšå¼ˆï¼Œæ¢å¥è¯è¯´ï¼Œæ˜¯ç‰ºç‰²æ–‡ä»¶ç³»ç»Ÿæ•ˆç‡æ¥å¼ºè¡Œè§¦å‘DPPï¼Œè¿˜æ˜¯ä¿è¯æ–‡ä»¶ç³»ç»Ÿæ•ˆç‡è€Œæ”¾å¼ƒDPPï¼Œè¿™é‡Œé¢å°±ä¼šæœ‰ä¸€ä¸ªå–èˆçš„é—®é¢˜ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1622125623,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":293402,"user_name":"è¾°","can_delete":false,"product_type":"c1","uid":2172635,"ip_address":"","ucode":"2E898EAC5AA141","user_header":"https://static001.geekbang.org/account/avatar/00/21/26/db/27724a6f.jpg","comment_is_top":false,"comment_ctime":1621384411,"is_pvip":false,"replies":[{"id":"106262","content":"å’±ä»¬ä¸¾äº†3ä¸ªæ¡ˆä¾‹ï¼Œå…¶ä¸­ç¬¬äºŒä¸ªæ¡ˆä¾‹éœ€è¦ç”¨åˆ°3.0çš„AQEï¼Œå…·ä½“æ¥è¯´æ˜¯Joinç­–ç•¥è°ƒæ•´ï¼›ç¬¬ä¸‰ä¸ªæ¡ˆä¾‹æ˜¯ç”¨join hintsæŠŠShuffle SMJè½¬åŒ–ä¸ºShuffle HJã€‚è¿™ä¸¤ä¸ªcaseåˆ©ç”¨çš„æ–°ç‰¹æ€§ï¼Œç¡®å®æ˜¯3.0æ‰æ”¯æŒã€‚<br><br>ä¸è¿‡ç¬¬ä¸€ä¸ªï¼Œä¹Ÿå°±æ˜¯Join Keysæ¯”Payloadå¤§å¾ˆå¤šï¼Œè¿™ä¸ªæŠ€å·§å¹¶ä¸éœ€è¦3.0å“ˆ~","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1621399953,"ip_address":"","comment_id":293402,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1621384411","product_id":100073401,"comment_content":"è€å¸ˆï¼Œè¿™äº›éƒ½æ˜¯åŸºäºspark3.0çš„æ–°ç‰¹æ€§ï¼Œé‚£å¯¹äº3.0ä¹‹å‰çš„ç‰ˆæœ¬åˆè¯¥æ€ä¹ˆè§£å†³å‘¢ï¼Œæ¯•ç«Ÿ3.0ç‰ˆæœ¬æ˜¯æ–°å‡ºçš„ï¼Œå¯¹äºå¤§å¤šæ•°å…¬å¸ä¸ä¸€å®šä½¿ç”¨äº†è¯¥ç‰ˆæœ¬","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":520197,"discussion_content":"å’±ä»¬ä¸¾äº†3ä¸ªæ¡ˆä¾‹ï¼Œå…¶ä¸­ç¬¬äºŒä¸ªæ¡ˆä¾‹éœ€è¦ç”¨åˆ°3.0çš„AQEï¼Œå…·ä½“æ¥è¯´æ˜¯Joinç­–ç•¥è°ƒæ•´ï¼›ç¬¬ä¸‰ä¸ªæ¡ˆä¾‹æ˜¯ç”¨join hintsæŠŠShuffle SMJè½¬åŒ–ä¸ºShuffle HJã€‚è¿™ä¸¤ä¸ªcaseåˆ©ç”¨çš„æ–°ç‰¹æ€§ï¼Œç¡®å®æ˜¯3.0æ‰æ”¯æŒã€‚\n\nä¸è¿‡ç¬¬ä¸€ä¸ªï¼Œä¹Ÿå°±æ˜¯Join Keysæ¯”Payloadå¤§å¾ˆå¤šï¼Œè¿™ä¸ªæŠ€å·§å¹¶ä¸éœ€è¦3.0å“ˆ~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621399953,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}