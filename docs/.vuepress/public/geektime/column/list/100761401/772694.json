{"id":772694,"title":"04ï½œå­—èŠ‚ç æ–‡ä»¶ï¼šç¼–è¯‘å™¨ä¸è™šæ‹Ÿæœºçš„æ ‡å‡†åˆçº¦","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯æµ·çº³ã€‚</p><p>ä»ä¸Šä¸€èŠ‚è¯¾çš„ä¾‹å­ä¸­å¯ä»¥çœ‹å‡ºï¼Œå­—èŠ‚ç æ–‡ä»¶åœ¨æ•´ä¸ª Python è¯­è¨€çš„å®ç°ä¸­ä½äºä¸­æ¢åœ°ä½ï¼Œè¿™ä¸€èŠ‚è¯¾ï¼Œæˆ‘ä»¬å°±èšç„¦å­—èŠ‚ç æ–‡ä»¶çš„æ ¼å¼ï¼Œç›®æ ‡æ˜¯<strong>æŠŠ Python 3.8 çš„å­—èŠ‚ç æˆåŠŸåœ°åŠ è½½è¿›å†…å­˜</strong>ã€‚</p><p>CPython è™šæ‹Ÿæœºæ—¢å¯ä»¥æ‰§è¡Œ py æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æ‰§è¡Œç¼–è¯‘è¿‡çš„ pyc æ–‡ä»¶ï¼Œè¿™æ˜¯å› ä¸º CPython é‡ŒåŒ…å«äº†ä¸€ä¸ªå¯ä»¥ç¼–è¯‘ py æ–‡ä»¶çš„ç¼–è¯‘å™¨ï¼Œåœ¨æ‰§è¡Œ py æ–‡ä»¶æ—¶ï¼Œç¬¬ä¸€æ­¥å°±æ˜¯è¦æŠŠ py æ–‡ä»¶å…ˆç¿»è¯‘æˆå­—èŠ‚ç æ–‡ä»¶ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æ·±å…¥åˆ†æ pyc æ–‡ä»¶ç»“æ„ï¼Œå®ç° pyc æ–‡ä»¶çš„è§£æï¼Œå°†æ–‡ä»¶å†…å®¹åŠ è½½è¿›å†…å­˜ï¼Œå¹¶ä¸”åšå¥½æ‰§è¡Œçš„å‡†å¤‡ã€‚</p><h2>å­—èŠ‚ç æ–‡ä»¶æ ¼å¼</h2><p>æˆ‘ä»¬å…ˆå‡†å¤‡ä¸€ä¸ª pyc æ–‡ä»¶ã€‚æ–°å»ºä¸€ä¸ªåä¸º hello.py çš„æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><pre><code class=\"language-c++\">print(255)\n</code></pre><p>ç„¶åæ‰§è¡Œ python -m compileall hello.py å‘½ä»¤ï¼Œå°±å¯ä»¥å¾—åˆ° hello.pyc æ–‡ä»¶ã€‚è¿˜æœ‰ä¸€ç§åŠæ³•ï¼Œå°±æ˜¯ç›´æ¥è¿è¡Œ&nbsp;python å‘½ä»¤ï¼Œè¿›å…¥ CPython çš„äº¤äº’å¼ç•Œé¢ï¼Œç„¶åæ‰§è¡Œ import helloï¼Œä¹Ÿå¯ä»¥ç”Ÿæˆ hello.pyc æ–‡ä»¶ã€‚</p><pre><code class=\"language-plain\"># python3\nPython 3.10.13 (main, Feb 19 2024, 20:13:37) [GCC 9.4.0] on linux\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n&gt;&gt;&gt; import hello\n255\n</code></pre><!-- [[[read_end]]] --><p>å¯¹äº Python 3.x ç‰ˆæœ¬ï¼Œç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶ä½äº__pycache__ä¸‹ã€‚</p><p>åœ¨ Windows ç³»ç»Ÿä¸Šï¼Œå¯ä»¥é€šè¿‡ Notepad++ã€UltraEdit ç­‰ 16 è¿›åˆ¶æŸ¥çœ‹å·¥å…·æ¥æ‰“å¼€ pyc æ–‡ä»¶ã€‚åœ¨ Linux ç³»ç»Ÿä¸Šï¼Œåˆ™å¯ä»¥é€šè¿‡ xxd å‘½ä»¤æ¥æŸ¥çœ‹è¿™ä¸ªæ–‡ä»¶çš„å†…å®¹ã€‚</p><pre><code class=\"language-plain\"># xxd hello.cpython-310.pyc\n00000000: 6f0d 0d0a 0000 0000 1f47 d365 0b00 0000&nbsp; o........G.e....\n00000010: e300 0000 0000 0000 0000 0000 0000 0000&nbsp; ................\n00000020: 0002 0000 0040 0000 0073 0c00 0000 6500&nbsp; .....@...s....e.\n00000030: 6400 8301 0100 6401 5300 2902 e9ff 0000&nbsp; d.....d.S.).....\n00000040: 004e 2901 da05 7072 696e 74a9 0072 0300&nbsp; .N)...print..r..\n00000050: 0000 7203 0000 00fa 0868 656c 6c6f 2e70&nbsp; ..r......hello.p\n00000060: 79da 083c 6d6f 6475 6c65 3e01 0000 0073&nbsp; y..&lt;module&gt;....s\n00000070: 0200 0000 0c00&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;......\n</code></pre><p>è§†é¢‘è®²è§£å­—èŠ‚ç ï¼š<br>\n<video poster=\"https://media001.geekbang.org/4070ba9d165471ef80b06633b79f0102/snapshots/42582638a4434c1787cc162aa92f0cda-00005.jpg\" preload=\"none\" controls=\"\"><source src=\"https://media001.geekbang.org/customerTrans/7e27d07d27d407ebcc195a0e78395f55/344c7866-18f93ee3d18-0000-0000-01d-dbacd.mp4\" type=\"video/mp4\"><source src=\" https://media001.geekbang.org/10c53831165571ef81300764a0ec0102/ceed36a3267448be89de1cfccfabd651-24f3c1e190adba52e9e4c1602d5c5ee7-sd.m3u8\" type=\"application/x-mpegURL\"></video></p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¸€èµ·ç ”ç©¶ pyc æ–‡ä»¶çš„å„ä¸ªç»„æˆéƒ¨åˆ†ã€‚</p><p>pyc æ–‡ä»¶çš„å¤´éƒ¨åŒ…å«å››ä¸ªéƒ¨åˆ†ã€‚2.7 ç‰ˆæœ¬çš„å­—èŠ‚ç æ–‡ä»¶åªæœ‰ä¸¤ä¸ªéƒ¨åˆ†ï¼Œåˆ†åˆ«æ˜¯é­”æ•°å’Œæ–‡ä»¶æ—¶é—´æˆ³ã€‚3.8 ç‰ˆæœ¬åˆ™æ‰©å±•ä¸ºå››ä¸ªï¼Œè¿™æ˜¯ç”± <a href=\"https://peps.python.org/pep-0552/\">PEP 552 è§„èŒƒ</a> å¼•å…¥çš„ï¼Œæ–°å¼•å…¥çš„ç¬¬äºŒå­—æ®µå’Œç¬¬å››å­—æ®µå¯¹æˆ‘ä»¬å®ç°ä¸€ä¸ªç®€å•çš„è™šæ‹Ÿæœºæ²¡æœ‰å¤ªå¤§å½±å“ï¼Œæ‰€ä»¥è¿™é‡Œå°±ä¸å†ä»‹ç»äº†ï¼Œå¦‚æœä½ æ„Ÿå…´è¶£çš„è¯å¯ä»¥é˜…è¯»PEPæ–‡æ¡£äº†è§£ä¸€ä¸‹ã€‚</p><p>æ–‡ä»¶å¼€å§‹çš„ 4 ä¸ªå­—èŠ‚ä»£è¡¨ä¸€ä¸ªæ•´æ•°ï¼Œè¢«ç§°ä¸ºé­”æ•°ï¼ˆmagic numberï¼‰ï¼Œç”¨äºæ ‡è¯†æ–‡ä»¶ç±»å‹å’Œç‰ˆæœ¬ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ–‡ä»¶ä¸­é«˜å­—èŠ‚å­˜å‚¨åœ¨é«˜ä½ï¼Œä½å­—èŠ‚å­˜å‚¨åœ¨ä½ä½ã€‚ä¸åŒç‰ˆæœ¬çš„å­—èŠ‚ç æ–‡ä»¶ï¼Œé­”æ•°ä¸ç›¸åŒã€‚ä½¿ç”¨ Python 3.8 ç¼–è¯‘å¾—åˆ°çš„ pyc æ–‡ä»¶çš„é­”æ•°æ˜¯ 0xa0d0d55ã€‚</p><p>å‰é¢æˆ‘ä»¬è®²è¿‡ï¼Œç¬¬äºŒéƒ¨åˆ†ä¹Ÿæ˜¯ 4 ä¸ªå­—èŠ‚ï¼Œè¿™é‡Œä¸å†é‡å¤äº†ã€‚</p><p>ç¬¬ä¸‰éƒ¨åˆ†æ˜¯å­—èŠ‚ç æ–‡ä»¶çš„åˆ›å»ºæ—¶é—´ï¼Œç”¨ 4 ä¸ªå­—èŠ‚è®°å½•äº†ä¸€ä¸ªæ—¶é—´æˆ³ï¼Œåªéœ€è¦ç®€å•åœ°å°†å®ƒè¯»å‡ºæ¥å°±å¯ä»¥äº†ï¼Œç›®å‰å¯¹æˆ‘ä»¬çš„æ„ä¹‰ä¹Ÿä¸å¤§ã€‚å¦‚æœä½ æœ‰å…´è¶£ï¼Œå¯ä»¥å°†å®ƒè½¬æ¢æˆå…·ä½“çš„æ—¶é—´å¹¶æ‰“å°å‡ºæ¥ï¼Œæ–¹ä¾¿éªŒè¯ã€‚</p><p>æ¥ä¸‹æ¥ä¸€å®šä¼šæ˜¯ä¸€ä¸ªå­—ç¬¦ <code>'c'</code>ï¼Œåœ¨å­—èŠ‚ç æ–‡ä»¶ä¸­å°±æ˜¯ 16 è¿›åˆ¶çš„ 0xe3ã€‚åœ¨è€çš„ç‰ˆæœ¬æ–‡ä»¶é‡Œï¼Œè¿™ä¸ªå­—ç¬¦æ˜¯ 0x63ï¼Œæ­£å¥½æ˜¯å­—ç¬¦ <code>'c'</code> çš„ ASCII ç ï¼Œä½†æ˜¯åœ¨ Python 3.x ç‰ˆæœ¬é‡Œï¼Œæ ‡è¯†å­—ç¬¦çš„æœ€é«˜ä½è¢«ç”¨äº REF æ ‡å¿—ï¼Œèµ·åˆ°ä¼˜åŒ–æ–‡ä»¶ç»“æ„çš„ä½œç”¨ã€‚</p><p>ç±»å‹æ ‡å¿—çš„æœ€é«˜ä½å¦‚æœç½®ä¸º 1ï¼Œå°±ä»£è¡¨è¿™ä¸ªå€¼åº”è¯¥è¢«ç¼“å­˜èµ·æ¥ï¼Œå¦‚æœä¸‹ä¸€æ¬¡é‡åˆ°å­—ç¬¦ <code>'r'</code> æ—¶ï¼Œå°±ç›´æ¥ä»ç¼“å­˜è¡¨é‡Œæ ¹æ®ä¸‹æ ‡æ‰¾åˆ°è¿™ä¸ªç¼“å­˜å€¼ã€‚æ‰€ä»¥è¿™æ®µå­—èŠ‚ä¸²å°†ä¼šè¢«ç¼“å­˜ï¼Œå¹¶ä¸”å…¶åºå·ä¸º 0ã€‚</p><p>ç›´æ¥å°† 0xe3 ä¸ 0x7f è¿›è¡Œä¸è¿ç®—ï¼Œå¯ä»¥å°†é«˜ä½æ¸…é›¶ï¼Œä»è€Œå¾—åˆ°å­—ç¬¦ <code>'c'</code>ã€‚</p><p>è¿™ä¸ªå­—ç¬¦çš„æ„ä¹‰æ˜¯å‘Šè¯‰æˆ‘ä»¬æ¥ä¸‹æ¥æ˜¯ä¸€ä¸ªCodeObjectç»“æ„ã€‚è¿™ä¸ªæ˜¯è™šæ‹Ÿæœºä¸­çš„æ ¸å¿ƒç»“æ„ï¼Œä¸‹é¢æˆ‘æ¥è¯¦ç»†è§£é‡Šè¿™ä¸ªç»“æ„ã€‚</p><h2>CodeObjectç»“æ„</h2><p>CodeObject çš„ç¬¬ä¸€ä¸ªåŸŸæ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œä»£è¡¨å‚æ•°ä¸ªæ•°ï¼Œæˆ‘ä»¬è®°ä¸º argcountã€‚å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ hello.pyc&nbsp;è¿™ä¸ªä¾‹å­ä¸­ï¼Œargcount çš„å€¼ä¸º 0ã€‚ç¬¬äºŒä¸ªåŸŸä¹Ÿæ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œä»£è¡¨ä½ç½®å‚æ•°çš„ä¸ªæ•°ï¼Œè®°ä¸ºposonlyargcountã€‚åœ¨å½“å‰çš„ä¾‹å­é‡Œï¼Œå®ƒçš„å€¼ä¸º 0ã€‚</p><p>ç¬¬ä¸‰ä¸ªåŸŸæ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œä»£è¡¨é”®å‚æ•°çš„ä¸ªæ•°ï¼Œè®°ä¸ºkwonlyargcountã€‚åœ¨å½“å‰ä¾‹å­ä¸­ï¼Œå®ƒçš„å€¼ä¸º 0ã€‚ä½ç½®å‚æ•°å’Œé”®å‚æ•°æ˜¯ Python åœ¨è°ƒç”¨å‡½æ•°æ—¶ä¸¤ç§ç‰¹æ®Šçš„ä¼ é€’å‚æ•°çš„æ–¹å¼ï¼Œåœ¨å®ç°å‡½æ•°æœºåˆ¶çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šè¯¦ç»†åœ°ä»‹ç»ã€‚</p><p>ç¬¬å››ä¸ªåŸŸæ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œä»£è¡¨å±€éƒ¨å˜é‡çš„ä¸ªæ•°ï¼Œè®°ä¸º nlocalsï¼Œåœ¨å½“å‰çš„ä¾‹å­ä¸­ä¹Ÿæ˜¯ 0ã€‚ç¬¬äº”ä¸ªåŸŸæ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œä»£è¡¨æ‰§è¡Œè¿™æ®µ code æ‰€ä½¿ç”¨çš„æ“ä½œæ•°æ ˆçš„æ·±åº¦çš„æœ€å¤§å€¼ï¼Œè®°ä¸º stacksizeï¼Œåœ¨ç°åœ¨çš„ä¾‹å­ä¸­ï¼Œå€¼æ˜¯ 2ã€‚ç¬¬å…­ä¸ªåŸŸæ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œä»£è¡¨ code çš„å±æ€§å€¼ï¼Œè®°ä¸º flagsï¼Œå€¼ä¸º 0x40ã€‚ä»‹ç»å‡½æ•°æ—¶ï¼Œæˆ‘ä»¬ä¼šè¯¦ç»†è®²åˆ°ï¼Œè¿™é‡Œå…ˆç•¥è¿‡ã€‚</p><p>å†æ¥ä¸‹æ¥å°±æ˜¯æˆ‘ä»¬è¿™èŠ‚è¯¾è¦ä»‹ç»çš„é‡ç‚¹äº†â€”â€”å­—èŠ‚ç ã€‚å®ƒä»¥ä¸€ä¸ªå­—ç¬¦ <code>'s'</code> å¼€å¤´ï¼Œæ¥ä¸‹æ¥æ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œä»£è¡¨äº†è¿™æ®µ code çš„å­—èŠ‚ç é•¿åº¦ã€‚åœ¨ xxd ç»“æœçš„ç¬¬äºŒè¡Œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨å­—ç¬¦ <code>'s'</code> åé¢ç´§è·Ÿç€ä¸€ä¸ªæ•´æ•° 0xcï¼Œè¿™å°±ä»£è¡¨äº†è¿™æ®µå­—èŠ‚ç çš„é•¿åº¦æ˜¯12ã€‚æ¥ä¸‹æ¥çš„ 12 ä¸ªå­—èŠ‚ï¼Œå°±æ˜¯å­—èŠ‚ç äº†ã€‚</p><p>åœ¨å­—èŠ‚ç ä¹‹åï¼Œæ˜¯å¸¸é‡è¡¨ï¼Œè®°ä¸º constsï¼Œé‡Œé¢å­˜ç€ç¨‹åºæ‰€ä½¿ç”¨çš„æ‰€æœ‰å¸¸é‡ã€‚å®ƒæ˜¯ä¸€ä¸ªå…ƒç»„ï¼Œåœ¨ç°é˜¶æ®µï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒç†è§£æˆä¸€ä¸ªåˆ—è¡¨ï¼Œæˆ–è€…æ˜¯æ•°ç»„ã€‚è¿™ä¸ªå…ƒç»„ä»¥å­—ç¬¦ <code>')'</code> ä½œä¸ºå¼€å¤´ï¼Œç´§æ¥ç€çš„æ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œä»£è¡¨äº†å…ƒç»„ä¸­çš„å…ƒç´ ä¸ªæ•°ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå¸¸é‡è¡¨çš„å…ƒç´ ä¸ªæ•°ä¸º 2ã€‚æ¥ç€å°±æ˜¯å¸¸é‡è¡¨ä¸­çš„ 2 ä¸ªå…ƒç´ ã€‚</p><p>ç¬¬ä¸€ä¸ªå…ƒç´ çš„ç±»å‹ç”±å­—ç¬¦ <code>'i'</code> è¡¨ç¤ºï¼Œè¿™é‡Œå®ƒçš„åå…­è¿›åˆ¶æ•°æ˜¯ 0xe9ï¼Œå»æ‰æœ€é«˜ä½ä»¥åå°±æ˜¯0x69ï¼Œä¹Ÿå°±æ˜¯å­—ç¬¦ <code>'i'</code>ï¼ŒåŒæ—¶ï¼Œå®ƒä¹Ÿåº”è¯¥è¢«ç¼“å­˜ï¼Œç¼“å­˜åºå·ä¸º 1ï¼Œè¿™è¡¨ç¤ºç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œå®ƒçš„å€¼æ˜¯æ¥ä¸‹æ¥çš„å››ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯ 0xffï¼Œè¿™æ­£æ˜¯æºç ä¸­æ•´æ•° 255 çš„åå…­è¿›åˆ¶è¡¨ç¤ºã€‚</p><p>å†å¾€åå°±æ˜¯ä¸€ä¸ªå­—ç¬¦ <code>'N'</code>ï¼Œä»£è¡¨äº† Python ä¸­çš„ Noneï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆä¸å…³å¿ƒè¿™ä¸ª&nbsp;None æ˜¯ä»€ä¹ˆï¼Œåœ¨åé¢å®ç°å¯¹è±¡ç³»ç»Ÿçš„æ—¶å€™ï¼Œä½ è‡ªç„¶å°±ä¼šçŸ¥é“è¿™ä¸ª None æ˜¯æ€ä¹ˆæ¥çš„ã€‚å¸¸é‡è¡¨åˆ°è¿™é‡Œå°±ç»“æŸäº†ã€‚</p><p>æ¥ä¸‹æ¥æ˜¯å˜é‡è¡¨ï¼Œè®°ä¸º namesã€‚åœ¨ä¸€ä¸ª <code>')'</code> å­—ç¬¦ä¹‹åï¼Œç´§è·Ÿä¸€ä¸ªæ•´æ•° 1ï¼Œä»£è¡¨å˜é‡è¡¨åªæœ‰ä¸€ä¸ªå…ƒç´ ã€‚è¿™ä¸ªå…ƒç´ çš„ç±»å‹æ˜¯ <code>'Z'</code>ï¼ˆç¬¬6è¡Œçš„0xdaï¼Œå»æ‰æœ€é«˜ä½ä»¥åå°±æ˜¯0x5aï¼Œæ˜¯ <code>'Z'</code> çš„ASCIIç å€¼ï¼‰ï¼Œä»£è¡¨è¿™æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼ŒåŒæ—¶è¿™ä¸ªå­—ç¬¦ä¸²åº”è¯¥è¢«ç¼“å­˜ï¼Œåºå·ä¸º 2ã€‚å­—ç¬¦ä¸²çš„é•¿åº¦ä¸º 5ï¼Œå…¶å€¼ä¸º <code>print</code>ï¼Œè¿™æ­£æ˜¯æºä»£ç ä¸­ä½¿ç”¨çš„å‡½æ•°åå­—ã€‚</p><p>å­—èŠ‚ç æ–‡ä»¶ä¸­ä»£è¡¨å­—ç¬¦ä¸²ç±»å‹çš„å­—ç¬¦æœ‰ 6 ç§ï¼Œåˆ†åˆ«æ˜¯ï¼š</p><ol>\n<li>å­—ç¬¦ <code>'s'</code>ï¼Œè™šæ‹Ÿæœºå†…éƒ¨è¡¨ç¤ºä¸º TYPE_STRINGï¼Œæ™®é€šçš„å­—ç¬¦ä¸²ã€å­—èŠ‚ç æ˜¯è¿™ç§ç±»å‹çš„ã€‚</li>\n<li>å­—ç¬¦ <code>'t'</code>ï¼Œå†…éƒ¨è¡¨ç¤ºä¸º TYPE_INTERNEDï¼Œä¹Ÿæ˜¯å­—ç¬¦ä¸²ï¼Œä½†æ˜¯è¿™ä¸ªå­—ç¬¦ä¸²åº”è¯¥è¢«ç¼“å­˜åˆ°ç¼“å†²åŒºé‡Œï¼Œä¸‹ä¸€æ¬¡ä½¿ç”¨æ—¶ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨åºå·è¿›è¡Œå¼•ç”¨ï¼Œä¸éœ€è¦å°†ç›¸åŒçš„å­—ç¬¦ä¸²å†ç¼–ç ä¸€æ¬¡ã€‚</li>\n<li>å­—ç¬¦ <code>'a'</code>ï¼Œå†…éƒ¨è¡¨ç¤ºä¸º TYPE_ASCIIï¼Œä»£è¡¨å­—ç¬¦ä¸²ä¸­çš„æ¯ä¸ªå­—ç¬¦éƒ½æ˜¯ä¸è¶…è¿‡ 255 çš„ä¸€ä¸ªå­—ç¬¦ã€‚</li>\n<li>å­—ç¬¦ <code>'A'</code>ï¼Œå†…éƒ¨è¡¨ç¤ºä¸º TYPE_ASCII_INTERNEDï¼Œä»£è¡¨å­—ç¬¦ä¸²çš„å­—ç¬¦éƒ½æ˜¯ä¸è¶…è¿‡ 255 çš„ä¸€ä¸ªå­—ç¬¦ï¼Œè€Œä¸”è¿™ä¸ªå­—ç¬¦åº”è¯¥è¢«ç¼“å­˜ã€‚</li>\n<li>å­—ç¬¦ <code>'z'</code>ï¼Œå†…éƒ¨è¡¨ç¤ºä¸º TYPE_SHORT_ASCIIï¼Œä»£è¡¨å­—ç¬¦ä¸²ä¸­çš„æ¯ä¸ªå­—ç¬¦éƒ½æ˜¯ä¸è¶…è¿‡ 128 çš„å­—ç¬¦ï¼Œå¤§å¤šæ•°é”®ç›˜å¯ä»¥è¾“å…¥çš„å­—ç¬¦ã€‚</li>\n<li>å­—ç¬¦ <code>'Z'</code>ï¼Œå†…éƒ¨è¡¨ç¤ºä¸º TYPE_SHORT_ASCII_INTERNEDï¼Œä»£è¡¨å­—ç¬¦ä¸²ä¸­çš„æ¯ä¸ªå­—ç¬¦éƒ½æ˜¯ä¸è¶…è¿‡ 128 çš„å­—ç¬¦ï¼Œè€Œä¸”å­—ç¬¦ä¸²åº”è¯¥è¢«ç¼“å­˜ã€‚</li>\n</ol><p>å˜é‡è¡¨ä¹‹ååˆ™æ˜¯å‚æ•°åˆ—è¡¨ã€‚è¿™ä¸€é¡¹åªåœ¨å‡½æ•°å’Œæ–¹æ³•é‡Œæœ‰ç”¨ï¼Œä»£è¡¨äº†å‡½æ•°çš„è¾“å…¥å‚æ•°ã€‚è¿™é‡Œå¯ä»¥å…ˆç•¥è¿‡ã€‚è¿™ä¸ªç©ºçš„å‚æ•°åˆ—è¡¨çš„ç±»å‹æ ‡å¿—æ˜¯ <code>')'</code>ï¼Œå­—èŠ‚ç æ–‡ä»¶ä¸­çš„å€¼æ˜¯ 0xa9ï¼Œæ‰€ä»¥å®ƒçš„æœ€é«˜ä½æ˜¯ 1ï¼Œä»£è¡¨å®ƒä¹Ÿåº”è¯¥è¢«ç¼“å­˜ï¼Œåºå·æ˜¯ 3ã€‚</p><p>æ¥ä¸‹æ¥è¿˜æœ‰ä¸¤ä¸ªç©ºçš„å…ƒç»„ï¼Œåˆ†åˆ«æ˜¯ cell_var å’Œ free_varã€‚å®ƒä»¬åœ¨å­—èŠ‚ç æ–‡ä»¶ä¸­ä¸æ˜¯ä½¿ç”¨ <code>')'</code> æ¥æ ‡å¿—çš„ï¼Œè€Œæ˜¯ä½¿ç”¨ <code>'r'</code>ï¼Œå¹¶ä¸”åºå·æ˜¯ 3ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸¤ä¸ªå€¼éœ€è¦åœ¨ç¼“å­˜åˆ—è¡¨ä¸­æŸ¥æ‰¾ï¼Œè€Œç¼“å­˜åˆ—è¡¨ä¸­åºå·ä¸º 3 çš„å€¼æ­£æ˜¯å‰é¢è¯´çš„å‚æ•°åˆ—è¡¨ã€‚</p><p>cell_var å’Œ free_var ç”¨äºæ„å»ºé—­åŒ…ï¼ˆClousreï¼‰ï¼Œé—­åŒ…æ˜¯ Python å‡½æ•°ä¸­çš„æ ¸å¿ƒæœºåˆ¶ä¹‹ä¸€ï¼Œåœ¨è®²è§£å‡½æ•°çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šé‡ç‚¹ä»‹ç»å®ƒï¼Œè¿™é‡Œå…ˆç•¥è¿‡ã€‚</p><p>å†æ¥ä¸‹æ¥åˆ™æ˜¯ä¸€ä¸ªå­—ç¬¦ <code>'z'</code>ï¼Œæˆ‘ä»¬å‰é¢ä»‹ç»è¿‡ï¼Œè¿™ä»£è¡¨ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ¥ä¸‹æ¥æ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œä»£è¡¨äº†å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ªå­—ç¬¦ä¸²é•¿åº¦ä¸º 8ï¼Œå…¶å€¼ä¸º <code>\"hello.py\"</code>ï¼Œä»£è¡¨äº†æºæ–‡ä»¶çš„åå­—ã€‚</p><p>å†æ¥ä¸‹æ¥æ˜¯ä¸€ä¸ªå­—ç¬¦ <code>'Z'</code>ï¼Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ ¼å¼ä¸ <code>'s'</code> æ˜¯å®Œå…¨ç›¸åŒçš„ã€‚ä»£è¡¨äº†å½“å‰codeæ‰€å±æ¨¡å—ã€‚</p><p>æœ€åä¸€é¡¹ä¹Ÿæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä»¥å­—ç¬¦ <code>'s'</code> æ ‡å¿—ã€‚å®ƒæ˜¯ä¸€ä¸ªåä¸º line number table çš„ç»“æ„ï¼Œåœ¨å®ç° Traceback&nbsp;æ—¶ï¼Œæˆ‘ä»¬è¦æ‰“å°è¯¦ç»†çš„è°ƒç”¨æ ˆï¼Œä¼šä½¿ç”¨è¿™ä¸ªæ•°æ®ç»“æ„ã€‚è¿™é‡Œå°±å…ˆç•¥è¿‡ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/ba/15/ba9ee25d195e399f277b56905c3bc315.jpg?wh=2188x1148\" alt=\"å›¾ç‰‡\"></p><h2>åŠ è½½CodeObject</h2><p>ç»è¿‡ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬å¤§æ¦‚äº†è§£äº†ä¸€ä¸ª .pyc æ–‡ä»¶çš„ç»“æ„ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥å†™ä¸€ä¸ª .pyc æ–‡ä»¶çš„åˆ†æç¨‹åºï¼Œåœ¨å†…å­˜ä¸­é‡å»º CodeObjectï¼Œç„¶åå°è¯•ç€å»æ‰§è¡Œå®ƒã€‚</p><p>æˆ‘ä»¬è¦åšçš„ç¬¬ä¸€ä»¶äº‹å°±æ˜¯å†™ç¨‹åºæ‰“å¼€ .pyc æ–‡ä»¶ï¼Œå¹¶å°†å…¶å†…å®¹æŒ‰ç»“æ„è¯»å…¥ã€‚ä¸Šä¸€èŠ‚è¯¾æˆ‘ä»¬å·²ç»å®ç°äº†æ‰“å¼€æ–‡ä»¶å’Œè¯»å–æ•°æ®çš„åŠŸèƒ½ï¼Œè¿™é‡Œç»§ç»­å®ç°ç›¸å…³çš„ç»“æ„ã€‚ç¬¬ä¸€ä¸ªè¦å®ç°çš„ç»“æ„å°±æ˜¯<strong>åˆ—è¡¨</strong>ã€‚</p><h3>å®ç°åˆ—è¡¨</h3><p>ä¸ºäº†èŠ‚çº¦åœ°ä½¿ç”¨å†…å­˜ï¼Œæˆ‘ä»¬å¸Œæœ›è¿™ä¸ªåˆ—è¡¨æ˜¯å¯ä»¥åŠ¨æ€æ‰©å±•çš„ã€‚è¿™æ ·çš„è¯ï¼Œå¯ä»¥åœ¨ä¸€å¼€å§‹è®©åˆ—è¡¨çš„å®¹é‡å°ä¸€äº›ï¼Œå½“å…ƒç´ è¶Šæ¥è¶Šå¤šçš„æ—¶å€™ï¼Œå†é‡æ–°åˆ†é…å†…å­˜ã€‚å¦å¤–ï¼Œåˆ—è¡¨ä½œä¸ºä¸€ä¸ªå®¹å™¨ï¼Œæˆ‘ä»¬å¸Œæœ›å®ƒèƒ½å®¹çº³å„ç§ç±»å‹çš„å…ƒç´ ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨æ¨¡æ¿æ¥å®ç°åˆ—è¡¨ã€‚</p><pre><code class=\"language-c++\">#ifndef ARRAY_LIST_HPP\n#define ARRAY_LIST_HPP\n\n#include &lt;stdio.h&gt;\n\ntemplate &lt;typename T&gt;\nclass ArrayList {\nprivate:\n&nbsp; &nbsp; int _length;\n&nbsp; &nbsp; T*&nbsp; _array;\n&nbsp; &nbsp; int _size;\n\n&nbsp; &nbsp; void expand();\n\npublic:\n&nbsp; &nbsp; ArrayList(int n = 8);\n\n&nbsp; &nbsp; void add(T t);\n&nbsp; &nbsp; void insert(int index, T t);\n&nbsp; &nbsp; T&nbsp; &nbsp; get(int index);\n&nbsp; &nbsp; void set(int index, T t);\n&nbsp; &nbsp; int&nbsp; size();\n&nbsp; &nbsp; int&nbsp; length();\n&nbsp; &nbsp; T&nbsp; &nbsp; pop();\n};\n\n#endif\n</code></pre><p>ArrayList ç±»é‡Œå®šä¹‰äº†å…ƒç´ æ•°ç»„çš„å¤§å° _capacityï¼ŒæŒ‡å‘å…ƒç´ æ•°ç»„çš„æŒ‡é’ˆ _arrayï¼Œå¹¶ä¸”ä½¿ç”¨&nbsp;_length æ¥æŒ‡ç¤ºå½“å‰åˆ—è¡¨é‡Œæœ‰å¤šå°‘ä¸ªæœ‰æ•ˆå…ƒç´ ã€‚ç„¶ååˆå®šä¹‰äº† add æ–¹æ³•ï¼Œç”¨æ¥å‘åˆ—è¡¨çš„æœ«å°¾æ’å…¥å…ƒç´ ï¼Œinsert æ–¹æ³•å‘æŒ‡å®šçš„ä½ç½®æ’å…¥å…ƒç´ ï¼Œget æ–¹æ³•ç”¨æ¥è·å–æŒ‡å®šä½ç½®çš„å…ƒç´ ï¼Œset æ–¹æ³•ç”¨æ¥è®¾ç½®æŒ‡å®šä½ç½®çš„å…ƒç´ ã€‚</p><p>ç§æœ‰æ–¹æ³• expand çš„ä½œç”¨æ˜¯å½“æœ‰æ•ˆå…ƒç´ æ•°é‡è¶…è¿‡å…ƒç´ æ•°ç»„å®¹é‡çš„æ—¶å€™ï¼Œå¯ä»¥æ‰©å±•å…ƒç´ æ•°ç»„ã€‚ä½ å¯ä»¥çœ‹ä¸€ä¸‹å®ƒçš„å…·ä½“å®ç°ã€‚</p><pre><code class=\"language-c++\">#include \"arrayList.hpp\"\n#include &lt;stdio.h&gt;\n\ntemplate &lt;typename T&gt;\nArrayList&lt;T&gt;::ArrayList(int n) {\n&nbsp; &nbsp; _length = n;\n&nbsp; &nbsp; _size&nbsp; &nbsp;= 0;\n&nbsp; &nbsp; _array&nbsp; = new T[n];\n}\n\ntemplate &lt;typename T&gt;\nvoid ArrayList&lt;T&gt;::add(T t) {\n&nbsp; &nbsp; if (_size &gt;= _length)\n&nbsp; &nbsp; &nbsp; &nbsp; expand();\n\n&nbsp; &nbsp; _array[_size++] = t;\n}\n\ntemplate &lt;typename T&gt;\nvoid ArrayList&lt;T&gt;::insert(int index, T t) {\n&nbsp; &nbsp; add(NULL);\n\n&nbsp; &nbsp; for (int i = _size; i &gt; index; i--) {\n&nbsp; &nbsp; &nbsp; &nbsp; _array[i] = _array[i - 1];\n&nbsp; &nbsp; }\n\n&nbsp; &nbsp; _array[index] = t;\n}\n\ntemplate &lt;typename T&gt;\nvoid ArrayList&lt;T&gt;::expand() {\n&nbsp; &nbsp; T* new_array = new T[_length &lt;&lt; 1];\n&nbsp; &nbsp; for (int i = 0; i &lt; _length; i++) {\n&nbsp; &nbsp; &nbsp; &nbsp; new_array[i] = _array[i];\n&nbsp; &nbsp; }\n&nbsp; &nbsp; _array = new_array;\n&nbsp; &nbsp; delete[] _array;\n\n&nbsp; &nbsp; _length &lt;&lt;= 1;\n&nbsp; &nbsp; printf(\"expand an array to %d, size is %d\\n\", _length, _size);\n}\n\ntemplate &lt;typename T&gt;\nint ArrayList&lt;T&gt;::size() {\n&nbsp; &nbsp; return _size;\n}\n\ntemplate &lt;typename T&gt;\nint ArrayList&lt;T&gt;::length() {\n&nbsp; &nbsp; return _length;\n}\n\ntemplate &lt;typename T&gt;\nT ArrayList&lt;T&gt;::get(int index) {\n&nbsp; &nbsp; return _array[index];\n}\n\ntemplate &lt;typename T&gt;\nvoid ArrayList&lt;T&gt;::set(int index, T t) {\n&nbsp; &nbsp; if (_size &lt;= index)\n&nbsp; &nbsp; &nbsp; &nbsp; _size = index + 1;\n\n&nbsp; &nbsp; while (_size &gt; _length)\n&nbsp; &nbsp; &nbsp; &nbsp; expand();\n\n&nbsp; &nbsp; _array[index] = t;\n}\n\ntemplate &lt;typename T&gt;\nT ArrayList&lt;T&gt;::pop() {\n&nbsp; &nbsp; return _array[--_size];\n}\n</code></pre><p>ä»£ç çš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œå°±ä¸å†è¿‡å¤šè§£é‡Šäº†ã€‚</p><p>è¿™èŠ‚è¯¾çš„ä¾‹å­ä¸­è¿˜åŒ…æ‹¬äº†å­—ç¬¦ä¸²å’Œæ•´æ•°ï¼Œæ‰€ä»¥è¦è§£æè¿™ä¸ªå­—èŠ‚ç æ–‡ä»¶ï¼Œè¿˜è¦è¿›ä¸€æ­¥æ”¯æŒå­—ç¬¦ä¸²å’Œæ•´æ•°ã€‚ç¬¬äºŒèŠ‚è¯¾æˆ‘ä»¬å·²ç»å®ç°äº†å­—ç¬¦ä¸²çš„åŸºæœ¬åŠŸèƒ½ï¼Œæ¥ä¸‹æ¥è¦å°†å®ƒç»Ÿä¸€åˆ° Python çš„å¯¹è±¡ä½“ç³»ä¸­ã€‚</p><h3>é‡æ„å­—ç¬¦ä¸²</h3><p>åœ¨ Python ä¸­ï¼Œæ‰€æœ‰çš„æ•°æ®éƒ½æ˜¯å¯¹è±¡ï¼Œå­—ç¬¦ä¸²ã€æ•´æ•°ã€æµ®ç‚¹æ•°æ˜¯å¯¹è±¡ï¼Œç”šè‡³ç±»å®šä¹‰ã€æ¨¡å—ã€å‡½æ•°ä¹Ÿæ˜¯å¯¹è±¡ã€‚å®ƒä»¬éƒ½æœ‰å…±åŒçš„åŸºç±» objectã€‚è¿™é‡Œæˆ‘ä»¬ä¹Ÿå¼•å…¥äº†ä¸€ä¸ªè¶…ç±»ï¼Œå®šä¹‰ä¸º HiObjectã€‚å®ƒå°±æ˜¯ Python è¯­è¨€ä¸­çš„è¶…åŸºç±» objectã€‚</p><p>è™šæ‹Ÿæœºä¸­å¤„ç†çš„æ‰€æœ‰æ•°æ®éƒ½å°†ä¼šæ˜¯ä¸€ä¸ª HiObject çš„å®ä¾‹ã€‚æ•´æ•°ã€å­—ç¬¦ä¸²ä¹ŸåŒæ ·ä¼šæ˜¯å®ƒçš„å­ç±»ã€‚ä½ å¯ä»¥çœ‹ä¸€ä¸‹HiObject çš„å®šä¹‰ã€‚</p><pre><code class=\"language-c++\">// object/hiObject.hpp\n\n#ifndef _HI_OBJECT_HPP\n#define _HI_OBJECT_HPP\n\nclass HiObject {\npublic:\n    virtual void print() {\n        printf(\"This is an object.\\n\");\n    }\n};\n\n#endif\n</code></pre><p>ç„¶åé‡æ„ä¸Šä¸€èŠ‚è¯¾æ‰€å®ç°çš„å­—ç¬¦ä¸²ç±»ï¼Œä½¿å®ƒç»§æ‰¿è‡ª HiObjectã€‚</p><pre><code class=\"language-c++\">// object/hiString.hpp\n\nclass HiString : public HiObject {\n// ....\n};\n</code></pre><p>HiString ç±»çš„å®ç°æ²¡æœ‰ä»»ä½•æ”¹åŠ¨ï¼Œæˆ‘ä»¬åªæ˜¯ä¿®æ”¹äº†å®ƒçš„ç±»ç»§æ‰¿ç»“æ„ï¼Œé€šè¿‡è¿™ç§æ–¹å¼å°±å¯ä»¥å®ç°è¯­è¨€çš„æ³›å‹èƒ½åŠ›ã€‚</p><h3>å®ç°æ•´æ•°</h3><p>åœ¨ Python ä¸­ï¼Œæ•´æ•°ä¹Ÿæ˜¯å¯¹è±¡ã€‚å› æ­¤ï¼Œæˆ‘ä»¬ä¹Ÿé€‰æ‹©å®ç°æ•´æ•°ç±»ï¼Œç»§æ‰¿è‡ª HiObjectï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š</p><pre><code class=\"language-c++\">#ifndef _HI_INTEGER_HPP\n#define _HI_INTEGER_HPP\n\n#include \"hiObject.hpp\"\n\nclass HiInteger : public HiObject {\nprivate:\n&nbsp; &nbsp; int _value;\n\npublic:\n&nbsp; &nbsp; HiInteger(int x);\n&nbsp; &nbsp; int value() { return _value; }\n};\n\n#endif\n</code></pre><p>æ•´æ•°ç±»çš„å®šä¹‰éå¸¸ç®€å•ï¼Œæˆ‘å°±ä¸å†è®²è§£äº†ã€‚</p><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»æŠŠè§£æ pyc æ‰€éœ€è¦çš„å·¥å…·ç±»å…¨éƒ¨å‡†å¤‡å¥½äº†ã€‚æ¥ä¸‹æ¥ï¼Œå°±æ˜¯è¦ä½¿ç”¨è¿™äº›å·¥å…·å»å®Œæˆè¿™èŠ‚è¯¾çš„æœ€ç»ˆç›®æ ‡ï¼Œä»æ–‡ä»¶ä¸­è¯»å…¥å­—èŠ‚æµï¼Œå¹¶åœ¨å†…å­˜ä¸­å»ºç«‹ CodeObjectã€‚</p><h3>åˆ›å»º CodeObject</h3><p>å¼€å¤´æˆ‘ä»¬åˆ†æè¿‡ pyc æ–‡ä»¶çš„ç»“æ„ï¼Œæˆ‘ä»¬è®²åˆ° CodeObject é‡Œï¼ŒåŒ…å«äº†å¸¸é‡è¡¨ã€å˜é‡è¡¨ã€å‚æ•°åˆ—è¡¨ã€å­—èŠ‚ç ã€è¡Œå·è¡¨ç­‰ç­‰ã€‚æ ¹æ®è¿™äº›å±æ€§ï¼Œæˆ‘ä»¬æ¥å®šä¹‰ CodeObjectã€‚</p><pre><code class=\"language-c++\">class CodeObject : public HiObject {\npublic:\n    int _argcount;\n    int _posonlyargcount;\n    int _kwonlyargcount;\n    int _nlocals;\n    int _stack_size;\n    int _flag;\n\n    HiString* _bytecodes;\n    HiList*  _names;\n    HiList*  _consts;\n    HiList*  _var_names;\n\n    HiList*  _free_vars;\n    HiList*  _cell_vars;\n\n    HiString* _co_name;\n    HiString* _file_name;\n\n    int _lineno;\n    HiString* _notable;\n\n    CodeObject(int argcount, int posonlyargcount, int kwonlyargcount, int nlocals, int stacksize, \n        int flag, HiString* bytecodes, HiList* consts, \n        HiList* names, HiList* varnames, HiList* freevars, HiList* cellvars,\n        HiString* file_name, HiString* co_name, int lineno, HiString* notable);\n};\n</code></pre><p>åœ¨å®šä¹‰äº† CodeObject ä¹‹åï¼Œç»ˆäºå¯ä»¥å¼€å§‹è§£æçš„å·¥ä½œäº†ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±ç»§ç»­å®Œå–„ BinaryFileParser ç±»æ¥å®Œæˆè¿™ä¸ªå·¥ä½œã€‚</p><p>æˆ‘ä»¬å…ˆé‡æ„å®ƒçš„ parse æ–¹æ³•ã€‚</p><pre><code class=\"language-c++\">CodeObject* BinaryFileParser::parse() {\n    int magic_number = file_stream-&gt;read_int();\n    printf(\"magic number is 0x%x\\n\", magic_number);\n    int file_flag = file_stream-&gt;read_int();\n\n    // æ‰“å°æ—¶é—´æˆ³\n    char buffer[80];\n    time_t moddate = (time_t)file_stream-&gt;read_int();\n    struct tm * timeinfo = localtime(&amp;moddate);\n    strftime(buffer, 80, \"%Y-%m-%d %H:%M:%S\", timeinfo);\n    printf(\"%s\\n\", buffer);\n\n    int file_size = file_stream-&gt;read_int();\n    printf(\"size of source file is %d\\n\", file_size);\n\n    char object_type = file_stream-&gt;read();\n    bool ref_flag = (object_type &amp; 0x80) != 0;\n    object_type &amp;= 0x7f;\n\n    if (object_type == 'c') {\n        // è¿™é‡Œéœ€è¦å…ˆå ä½\n        int index = 0;\n        if (ref_flag) {\n            index = _cache.size();\n            _cache.add(NULL);\n        }\n\n        CodeObject* result = get_code_object();\n\n        if (ref_flag) {\n            _cache.set(index, result);\n        }\n\n        printf(\"parse OK!\\n\");\n        return result;\n    }\n\n    return NULL;\n}\n</code></pre><p>BinaryFileParser ç±»ä¸­è¿˜å®šä¹‰äº†å¾ˆå¤šç”¨äºè§£æå„ç§æ•°æ®ç»“æ„çš„å‡½æ•°ï¼Œå®ƒä»¬çš„é€»è¾‘ç›¸å¯¹ç®€å•è€Œä¸”æœ‰ä¸€äº›é‡å¤çš„ä»£ç ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘å°±ä¸è¯¦ç»†åˆ—å‡ºäº†ï¼Œä½ å¯ä»¥é€šè¿‡<a href=\"https://gitee.com/hinus/pythonvm/tree/geektime/\">ä»£ç ä»“åº“</a>è‡ªè¡ŒæŸ¥çœ‹ã€‚</p><p>æ‰§è¡Œ parse å‡½æ•°ï¼Œè™šæ‹Ÿæœºå°±ä»å­—èŠ‚ç æ–‡ä»¶ä¸­æˆåŠŸåŠ è½½äº† CodeObjectã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å®ç°ä¸€ä¸ªç®€å•çš„è§£é‡Šå™¨æ¥æ‰§è¡Œå­—èŠ‚ç ï¼Œè¿›ä¸€æ­¥éªŒè¯ CodeObject æ˜¯æ­£ç¡®çš„ã€‚</p><h2>æ‰§è¡Œå­—èŠ‚ç </h2><p>å°±åƒæˆ‘ä»¬å‰é¢åˆ†æçš„ï¼Œå­—èŠ‚ç æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä½äº CodeObject çš„ _code å±æ€§é‡Œï¼Œæ‰€ä»¥è§£é‡Šå™¨ä¹Ÿè¦åšç›¸åº”çš„ä¿®æ”¹ã€‚ä½ å¯ä»¥çœ‹ä¸€ä¸‹å®ƒçš„ä»£ç ã€‚</p><pre><code class=\"language-c++\">void Interpreter::run(CodeObject* codes) {\n    int pc = 0;\n    int code_length = codes-&gt;_bytecodes-&gt;length();\n\n    _stack  = new ArrayList&lt;HiObject*&gt;(codes-&gt;_stack_size);\n    _consts = codes-&gt;_consts;\n\n    while (pc &lt; code_length) {\n        unsigned char op_code = codes-&gt;_bytecodes-&gt;value()[pc++];\n        short op_arg = (codes-&gt;_bytecodes-&gt;value()[pc++] &amp; 0xFF);\n\n        HiInteger* lhs, * rhs;\n        HiObject* v, * w, * u, * attr;\n\n        switch (op_code) {\n            case ByteCode::LOAD_CONST:\n                _stack-&gt;add(_consts-&gt;get(op_arg));\n                break;\n\n            case ByteCode::LOAD_NAME:\n                // \"print\", do nothig.\n                _stack-&gt;add(nullptr);\n                break;\n\n            case ByteCode::CALL_FUNCTION:\n                v = _stack-&gt;pop();\n                v-&gt;print();\n                printf(\"\\n\");\n                break;\n\n            case ByteCode::POP_TOP:\n                _stack-&gt;pop();\n                break;\n\n            case ByteCode::RETURN_VALUE:\n                _stack-&gt;pop(); \n                break;\n\n            default:\n                printf(\"Error: Unrecognized byte code %d\\n\", op_code);\n        }\n    }\n}\n</code></pre><p>è¿™æ®µä»£ç æœ‰å‡ ä¸ªç‚¹éœ€è¦å…³æ³¨ã€‚</p><ol>\n<li>run æ–¹æ³•çš„å‚æ•°æ˜¯ CodeObjectï¼Œè€Œä¸æ˜¯ä¹‹å‰çš„ HiStringï¼ŒæŒ‡ä»¤éƒ½æ˜¯ä» _code å±æ€§ä¸­è·å–çš„ï¼ˆç¬¬ 9 è¡Œï¼‰ã€‚</li>\n<li>ä¸ç®¡æ˜¯å¸¦æ“ä½œæ•°çš„å­—èŠ‚ç ï¼Œä¾‹å¦‚ LOAD_CONSTï¼Œè¿˜æ˜¯ä¸å¸¦æ“ä½œæ•°çš„å­—èŠ‚ç ï¼Œä¾‹å¦‚ POP_TOPï¼Œå®ƒä»¬çš„æŒ‡ä»¤é•¿åº¦éƒ½æ˜¯ 2ï¼Œåªä¸è¿‡ä¸å¸¦æŒ‡ä»¤çš„å­—èŠ‚ç ç¬¬äºŒä¸ªå­—èŠ‚ä¸èµ·ä½œç”¨ï¼ˆç¬¬ 10 è¡Œï¼‰ã€‚</li>\n<li>print åœ¨ Python 3 ä¸­æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè€Œä¸æ˜¯å…³é”®å­—ï¼Œè¿™ä¸€ç‚¹å’Œ Python 2 æœ‰å¾ˆå¤§çš„ä¸åŒã€‚ä½†æˆ‘ä»¬ç°åœ¨æ²¡æœ‰å®ç° LOAD_NAME å’Œ CALL_FUNCTION æŒ‡ä»¤ï¼Œå› ä¸ºå®ƒä»¬åˆ†åˆ«éœ€è¦å˜é‡æœºåˆ¶å’Œå‡½æ•°æœºåˆ¶ï¼Œæ‰€ä»¥ç°åœ¨åªèƒ½å°†å®ƒç»•è¿‡å»ã€‚åœ¨ CALL_FUNCTION æŒ‡ä»¤é‡Œï¼Œç›´æ¥è°ƒç”¨ print æ–¹æ³•ï¼ˆç¬¬ 25 è‡³ 29 è¡Œï¼‰ï¼Œè¿™æ˜¯å› ä¸ºç°é˜¶æ®µï¼Œé™¤äº† print ä¹‹å¤–ï¼Œæˆ‘ä»¬ä¸å¯èƒ½å†ä½¿ç”¨å…¶ä»–çš„å‡½æ•°äº†ï¼Œæ‰€ä»¥è¿™ä¹Ÿä¸ä¼šå¸¦æ¥ä»€ä¹ˆå¤§çš„é—®é¢˜ã€‚</li>\n</ol><p>ç¼–è¯‘å¹¶æ‰§è¡Œå¼€å¤´çš„é‚£ä¸ª hello.pycï¼Œå°±èƒ½çœ‹åˆ°ä»¥ä¸‹ç»“æœï¼š</p><pre><code class=\"language-plain\">magic number is 0xa0d0d55\n2024-04-07 19:44:59\nsize of source file is 15\nflags is 0x40\nparse OK!\n255\n</code></pre><p>å‰è¾¹ 5 è¡Œæ˜¯å„ç§æ‰“å°ä¿¡æ¯ï¼Œæœ€åä¸€è¡Œæ˜¯å­—èŠ‚ç çš„æ‰§è¡Œç»“æœã€‚å¯ä»¥çœ‹åˆ°ï¼Œæ­£ç¡®åœ°æ‰“å°äº†æ•°å­— 255ï¼Œè¿™è¯´æ˜æˆ‘ä»¬çš„è™šæ‹Ÿæœºæ˜¯æ­£ç¡®çš„ï¼Œå·²ç»å°†å­—èŠ‚ç åŠ è½½è¿›æ¥å¹¶ä¸”æ‰§è¡Œäº†ã€‚</p><h2>æ€»ç»“</h2><p>è¿™èŠ‚è¯¾æˆ‘ä»¬è®²è§£äº†å­—èŠ‚ç æ–‡ä»¶çš„æ ¼å¼ï¼Œå®ƒæ˜¯ä¸€ä¸ªç»“æ„åŒ–çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè™šæ‹Ÿæœºé€šè¿‡äºŒè¿›åˆ¶è¯»å†™æ¥å£å°†æ–‡ä»¶åŠ è½½è¿›æ¥ï¼Œç„¶åè¿›è¡Œè§£æã€‚å­—èŠ‚ç æ–‡ä»¶ä¸­æœ€ä¸»è¦çš„ç»“æ„å°±æ˜¯ CodeObjectï¼Œå®ƒåŒ…å«äº†å¾ˆå¤šé‡è¦çš„å±æ€§ã€‚å…¶ä¸­ï¼Œå­—èŠ‚ç æŒ‡ä»¤æ˜¯æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œå¸¸é‡è¡¨ã€å˜é‡è¡¨ç­‰ç»“æ„æˆ‘ä»¬åé¢ä¼šä¸€ä¸€ä»‹ç»ã€‚</p><p>è™šæ‹Ÿæœºä¹Ÿå®ç°äº† parse æ–¹æ³•æ¥è§£æ CodeObjectï¼Œå°†ä»£ç å¯¹è±¡åœ¨å†…å­˜ä¸­é‡å»ºå‡ºæ¥ã€‚æœ€åï¼ŒInterpreter çš„ run æ–¹æ³•ä¸­å®ç°äº†æœ€ç®€å•çš„å‡ æ¡è™šæ‹ŸæœºæŒ‡ä»¤ï¼Œä»è€Œå®ç°äº†æ‰“å°æ•°å­—çš„åŠŸèƒ½ã€‚å®é™…ä¸Šï¼Œåˆ°ç°åœ¨ä¸ºæ­¢ï¼Œè™šæ‹Ÿæœºä¹Ÿå¯ä»¥æ‰“å°å­—ç¬¦ä¸²ï¼Œä½ å¯ä»¥è‡ªå·±è¯•éªŒä¸€ä¸‹ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å°†ä»æœ€ç®€å•çš„ç¨‹åºç»“æ„å¼€å§‹å®ç°è™šæ‹Ÿæœºçš„æ›´å¤šåŠŸèƒ½ï¼Œä¸‹ä¸€èŠ‚è¯¾æˆ‘ä»¬ä¼šä»‹ç»æ¡ä»¶åˆ†æ”¯è¯­å¥ã€‚</p><p><span class=\"reference\">æ³¨ï¼šç‚¹å‡»é“¾æ¥æŸ¥çœ‹<a href=\"https://gitee.com/hinus/pythonvm/tree/geektime/\">è¯¾ç¨‹ä»£ç åœ°å€</a></span></p><h2>æ€è€ƒé¢˜</h2><p>è¯·ä½ ä½¿ç”¨ Python 2.7 å’Œ Python 3.8 åˆ†åˆ«ç¼–è¯‘è¿™èŠ‚è¯¾å¼€å¤´çš„æ–‡ä»¶ï¼Œä½“ä¼šä¸€ä¸‹ print ä½œä¸ºå…³é”®å­—å’Œä½œä¸ºå‡½æ•°åæœ‰ä»€ä¹ˆä¸åŒã€‚æ¬¢è¿ä½ æŠŠä½ ç¼–è¯‘åçš„ç»“æœåˆ†äº«åˆ°è¯„è®ºåŒºï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾çš„å†…å®¹åˆ†äº«ç»™å…¶ä»–æœ‹å‹ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼</p>","comments":[{"had_liked":false,"id":390803,"user_name":"éª¨æ±¤é¸¡è›‹é¢","can_delete":false,"product_type":"c1","uid":1050002,"ip_address":"ä¸Šæµ·","ucode":"2AC141A523E710","user_header":"https://static001.geekbang.org/account/avatar/00/10/05/92/b609f7e3.jpg","comment_is_top":false,"comment_ctime":1716343458,"is_pvip":false,"replies":[{"id":142129,"content":"ç†è§£åˆ°è¿™ä¸ªå±‚é¢ï¼Œä½ å°±çœŸçš„å¾—å…¶ä¸­ä¸‰å‘³äº†ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1360512,"ctime":1716377309,"ip_address":"ä¸Šæµ·","comment_id":390803,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100761401,"comment_content":"å­—èŠ‚ç æ˜¯ä¸æ˜¯å¯ä»¥è§†ä¸ºä¸€ä¸ªdslæ–‡ä»¶ï¼Œç„¶åç”¨c++ å†™äº†ä¸€ä¸ªç¨‹åº&#47;å¼•æ“å»æ‰§è¡Œè¿™ä¸ªæ–‡ä»¶ã€‚","like_count":3,"discussions":[{"author":{"id":1360512,"avatar":"https://static001.geekbang.org/account/avatar/00/14/c2/80/6ebf32e8.jpg","nickname":"æµ·çº³","note":"","ucode":"AB9F7ADB1428D2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":645572,"discussion_content":"ç†è§£åˆ°è¿™ä¸ªå±‚é¢ï¼Œä½ å°±çœŸçš„å¾—å…¶ä¸­ä¸‰å‘³äº†ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1716377309,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":390528,"user_name":"ç»†é›¨å¹³æ¹–","can_delete":false,"product_type":"c1","uid":1144394,"ip_address":"åŒ—äº¬","ucode":"D7F571A24388F2","user_header":"https://static001.geekbang.org/account/avatar/00/11/76/4a/014c6775.jpg","comment_is_top":false,"comment_ctime":1715568627,"is_pvip":false,"replies":[{"id":142057,"content":"å®‰æ’ã€‚æ”¾åˆ°ç›´æ’­ç­”ç–‘é‡Œã€‚è®°å¾—åŠ å…¥å¾®ä¿¡ç¾¤ã€‚åŠæ—¶è·å–æœ€æ–°çš„ç›´æ’­ç­”ç–‘ä¿¡æ¯ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1360512,"ctime":1715613107,"ip_address":"æµ™æ±Ÿ","comment_id":390528,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100761401,"comment_content":"è€å¸ˆï¼Œèƒ½ä¸èƒ½æŒ‰ç…§è¡Œå·ï¼Œä¸€è¡Œä¸€è¡Œè®²è§£â€œhello.pycâ€å­—èŠ‚ç æ–‡ä»¶ï¼Ÿç°åœ¨è¿™ä¸ªè®²æ³•ï¼Œå®Œå…¨çœ‹ä¸æ‡‚å•Šã€‚","like_count":2,"discussions":[{"author":{"id":1360512,"avatar":"https://static001.geekbang.org/account/avatar/00/14/c2/80/6ebf32e8.jpg","nickname":"æµ·çº³","note":"","ucode":"AB9F7ADB1428D2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":644931,"discussion_content":"å®‰æ’ã€‚æ”¾åˆ°ç›´æ’­ç­”ç–‘é‡Œã€‚è®°å¾—åŠ å…¥å¾®ä¿¡ç¾¤ã€‚åŠæ—¶è·å–æœ€æ–°çš„ç›´æ’­ç­”ç–‘ä¿¡æ¯ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1715613107,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":395076,"user_name":"ifelse","can_delete":false,"product_type":"c1","uid":2550743,"ip_address":"æµ™æ±Ÿ","ucode":"D0565908C99695","user_header":"https://static001.geekbang.org/account/avatar/00/26/eb/d7/90391376.jpg","comment_is_top":false,"comment_ctime":1729311060,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":3,"score":2,"product_id":100761401,"comment_content":"å­¦ä¹ æ‰“å¡","like_count":0}]}