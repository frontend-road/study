{"id":496701,"title":"09｜TDD中的驱动（2）：重构发挥了什么作用？","content":"<p>你好，我是徐昊。今天我们来继续讨论测试驱动开发中的驱动。</p><p>在上节课，我们讲了单元级别功能测试能够驱动其对应单元（功能上下文或变化点）的外在功能需求。但是当对应单元过大时，会带来一系列麻烦（比如测试构造困难、问题定位不准确等），那么就需要将对应单元的功能上下文继续分解成更小的粒度，然后通过测试来驱动实现。</p><p>从“驱动”的角度讲，TDD并不是一种编码技术，它无法驱动你写出你不会实现的代码。<strong>TDD是一种架构技术</strong>，它能通过测试与重构，驱动单元的划分以及功能的归属，因而是一种更为落地的架构软件的方式。</p><p>在TDD中，重构是和测试一样重要的驱动力，驱使我们得到更好的架构和更清晰的代码结构，因而熟练掌握几种常用的重构手法，也是十分必要的。</p><h2>语义化的查找替换（Semantic Find and Replace）</h2><p>首先要介绍的重构手法是提取方法（Extract Method）和内联方法（Inline Method）。这是最重要的两种重构手法，它们相当于查找（Find）/替换（Replace）。所不同的是，这种查找替换是语义化的：在不破坏现在代码结构的前提下，完成查找替换。视频演示如下：</p><p><video poster=\"https://media001.geekbang.org/8e3a9db8fa0f480a82a599688a732bc9/snapshots/987c2732aea746ab9e96e08ca9affee5-00005.jpg\" preload=\"none\" controls=\"\"><source src=\"https://media001.geekbang.org/customerTrans/7e27d07d27d407ebcc195a0e78395f55/355cf44-17fb9ee3d28-0000-0000-01d-dbacd.mp4\" type=\"video/mp4\"><source src=\" https://media001.geekbang.org/ea5a7b9acc9b4ca48db803f85e18e006/6f5c1a8793d54bd887d5ff56012d2785-495a909ecd303d452d6c0f965ecfb89d-sd.m3u8\" type=\"application/x-mpegURL\"></video></p><p>正如视频中所展示的，这个手法是将需要修改的代码提取到新方法中。在新方法内完成要做的修改，再通过内联方法在所有调用这个新方法的地方完成修改。我们需要将这两种手法看作修改代码的基本方式。</p><!-- [[[read_end]]] --><h2>通过提取/合并单元进行重架构（Extract and Merge Units）</h2><p>在提取方法的基础上，我们可以进一步将提取出的行为从当前对象中分离出去，也就是提取对象（Extract Object）。视频演示如下：</p><p><video poster=\"https://media001.geekbang.org/35a101792fa64959b5a91b269f1cf58b/snapshots/561c09e9cc9b44aab77ff6f7452b9377-00005.jpg\" preload=\"none\" controls=\"\"><source src=\"https://media001.geekbang.org/customerTrans/7e27d07d27d407ebcc195a0e78395f55/4e9b9ab6-17fb9ee395e-0000-0000-01d-dbacd.mp4\" type=\"video/mp4\"><source src=\" https://media001.geekbang.org/1fe6dfaab68b47568d9bac7a66de4715/d8d328a313274b3083ed23eea43b0041-5991f7bf5cfa04f18c2df25b20e35616-sd.m3u8\" type=\"application/x-mpegURL\"></video></p><p>一旦提取出对象，我们就能通过类内字段（Field）、参数（Parameter）等方式，不再直接引用当前对象上下文，从而将其与当前对象上下文分离。对应地，我们可以使用的重构手法有引入字段（Introduce Field）、引入参数（Introduce Parameter）等。视频演示如下：</p><p><video poster=\"https://media001.geekbang.org/9bacb9fbc74248b6970f93ea1061ea4d/snapshots/baf91fd4d01c4d03a72770ae28b9bca5-00005.jpg\" preload=\"none\" controls=\"\"><source src=\"https://media001.geekbang.org/customerTrans/7e27d07d27d407ebcc195a0e78395f55/3c167398-17fb9ee3622-0000-0000-01d-dbacd.mp4\" type=\"video/mp4\"><source src=\" https://media001.geekbang.org/8643c29f7f1444788f2277a2b6a40442/630430e2e1684bb2bc71612bc8626310-6df9730b1ce5fd723f4cf8aabc2879de-sd.m3u8\" type=\"application/x-mpegURL\"></video></p><p>通过这些重构手法，我们对类结构进行了调整，也就是<strong>模块的重划分</strong>和<strong>功能的重分配</strong>。都不用四舍五入，这就是对已有代码的<strong>重架构</strong>（Re-architecture）。</p><p>当然，能分自然能合。如果模块结构不合理，那么完全可以通过刚才介绍的语义化的查找替换来完成单元的合并。视频演示如下：</p><p><video poster=\"https://media001.geekbang.org/15260fdac62d48c3ac4dd1823a802dc8/snapshots/616866cc80c9413fa490dbc58cb3c663-00005.jpg\" preload=\"none\" controls=\"\"><source src=\"https://media001.geekbang.org/customerTrans/7e27d07d27d407ebcc195a0e78395f55/5e6f05ea-17fb9ee3217-0000-0000-01d-dbacd.mp4\" type=\"video/mp4\"><source src=\" https://media001.geekbang.org/dfb53bab8bb348e284cd9837d25697f3/1e4d76c26941477e89fa15fe6e36afc7-e4db8274b047153fdd45813ae990dd59-sd.m3u8\" type=\"application/x-mpegURL\"></video></p><p>到此为止，我们介绍了重构的基本手法。通过这一组操作，我们可以完成对于代码的修改，以及对于架构的调整。这些手法如此基础，<strong>应该被看作修改代码的基本功，而不是重构：</strong>谈不上什么消除坏味道，就是高效修改代码而已。</p><h2>使用多态替换条件</h2><p>组合使用这些基础手法，我们就可以进行一些更大规模的重构。比如我们之前在Args例子中展示过的使用多态替换条件分支。现在请你重新看一遍<a href=\"http://time.geekbang.org/column/article/494212\">第二讲</a>中的前两段视频。</p><p><video poster=\"https://static001.geekbang.org/resource/image/c3/a2/c3f7a5d53abb98f63d4e37c24ed023a2.jpg\" preload=\"none\" controls=\"\"><source src=\"https://media001.geekbang.org/customerTrans/7e27d07d27d407ebcc195a0e78395f55/3373f638-17f91553b08-0000-0000-01d-dbacd.mp4\" type=\"video/mp4\"><source src=\" https://media001.geekbang.org/6dea22b14c3b4caab62466461955821c/039596878d2540718e32ca87786130f7-77887e32b1a08347a96fc82fe56a0e50-sd.m3u8\" type=\"application/x-mpegURL\"></video></p><p><video poster=\"https://static001.geekbang.org/resource/image/c3/a2/c3f7a5d53abb98f63d4e37c24ed023a2.jpg\" preload=\"none\" controls=\"\"><source src=\"https://media001.geekbang.org/customerTrans/7e27d07d27d407ebcc195a0e78395f55/e47c810-17f916ecdb2-0000-0000-01d-dbacd.mp4\" type=\"video/mp4\"><source src=\" https://media001.geekbang.org/c68b68b21dd84319931b5e9db355a045/4757539d9a1b4d0793c751c6e1af4486-7f004010fed712c2a8cca7c455fc2879-sd.m3u8\" type=\"application/x-mpegURL\"></video></p><p>这两段视频中展示的重构与刚才介绍的几种手法不同，我们消除了坏味道并强化了开放封闭原则（Open-Closed Principle，OCP）：新增的类型解析不需要修改Args的实现，可以通过扩展OptionParser接口实现。<strong>对修改封闭，对扩展开放</strong>。</p><p>这种架构改进方法叫做<strong>重构到模式</strong>（Refactoring to Patterns），即：将架构上的坏味道替换为设计模式（Design Pattern）。这是一种更有效的架构软件的方法，用公认的好设计（模式）替换了公认的不好的设计（坏味道），还能满足功能的需求，必然能是更好的架构（而不用虚无缥缈地归结于“品味”或“经验”）。</p><p>对于TDD，行业中存在这样一种困惑：从功能测试出发，逐步完成软件开发，这或许没问题。但架构怎么办？实际上，红/绿/重构循环中的重构就是解决架构问题的。只不过架构并不是<strong>预先设计的</strong>（Upfront Design），而是在完成功能的前提下<strong>演进而来的，因而也称演进式设计</strong>（Evlutionary Design）。</p><p>通过重构到模式演进式地获得架构，是一种实效主义编码架构风格（Pragmatic Coding Architect）。这是习惯了预先设计的PPT架构师们不曾体验过的经历，因而不被理解也是很正常的了。</p><p>顺便说一句，Joshua Kerievsky在2004年写过一本书，就叫 <em>_Refactoring to Patterns</em>_ 。这本书的价值远被低估了，是关于软件架构非常重要的著作！</p><h2>小结</h2><p>这节课我们介绍了四种基本的重构手法，分别是提取方法、内联方法、引入参数和引入字段。这几种手法应该被看作修改代码的基本功。</p><p>此外，如果无法借助自动化重构工具高效修改代码，那么TDD带来的效率将会大打折扣。而无法支持这几个核心手法的IDE，也不足以支撑TDD的实施。</p><p>我们还展示了通过组合使用这些基本手法，来完成较大规模重构的例子。并简略介绍了TDD原生的架构方法，也就是<strong>重构到模式</strong>。对于常见的架构上的坏味道，我们都可以通过某些模式将其消除，从而得到更好的架构。</p><h2>思考题</h2><p>除了重构之外，如果架构预先设计好了，那么要怎么使用TDD？</p><p><strong>编辑来信</strong>：</p><blockquote>\n<p>TDD是一项技能，唯有动手实操、反复练习，才能有所小成。为了帮助你更快地进步，徐昊老师特发起了<strong>“代码评点”</strong>活动。<br>\n<strong>　</strong><br>\n在第一个实战项目结束后，我们会根据你提交的<a href=\"https://jinshuju.net/f/TvdN15\">学习反馈</a>，手动选出其中几位进行代码评点与解疑答惑。而评点的详细内容我们也将制成加餐，展示在专栏里，供其他同学学习与参考。<br>\n<strong>　</strong><br>\n划重点！如果学完第1-10讲再写反馈，将会大大提高你入选的机会！另，此次收集时间截至4月3日零点。所以非常希望你能跟上我们的更新进度，多动手实操，并记录学习体会。<br>\n<strong>　</strong><br>\n最后，希望我们都能好好学习，更上层楼！</p>\n</blockquote>","neighbors":{"left":{"article_title":"08｜TDD中的驱动（1）：驱动的极限是什么？","id":496700},"right":{"article_title":"10｜TDD中的驱动（3）：何为经典学派？何为伦敦学派？","id":496702}},"comments":[{"had_liked":false,"id":340220,"user_name":"aoe","can_delete":false,"product_type":"c1","uid":1121758,"ip_address":"","ucode":"1C6201EDB4E954","user_header":"https://static001.geekbang.org/account/avatar/00/11/1d/de/62bfa83f.jpg","comment_is_top":false,"comment_ctime":1648683831,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"14533585719","product_id":100109401,"comment_content":"非常惊喜的发现了一本关于软件架构非常重要的著作<br>Joshua Kerievsky 在 2004 年写过一本书，《Refactoring to Patterns》（中文版《重构与模式》）","like_count":4,"discussions":[{"author":{"id":1503064,"avatar":"https://static001.geekbang.org/account/avatar/00/16/ef/58/d05ec302.jpg","nickname":"Frode","note":"","ucode":"B7B8DBF9980EA1","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":559296,"discussion_content":"已加入购物车哈哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1648691144,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1121758,"avatar":"https://static001.geekbang.org/account/avatar/00/11/1d/de/62bfa83f.jpg","nickname":"aoe","note":"","ucode":"1C6201EDB4E954","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1503064,"avatar":"https://static001.geekbang.org/account/avatar/00/16/ef/58/d05ec302.jpg","nickname":"Frode","note":"","ucode":"B7B8DBF9980EA1","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":559327,"discussion_content":"我已加入书单","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1648707203,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":559296,"ip_address":""},"score":559327,"extra":""}]}]},{"had_liked":false,"id":340144,"user_name":"枫中的刀剑","can_delete":false,"product_type":"c1","uid":1322387,"ip_address":"","ucode":"4B086F538184AA","user_header":"https://static001.geekbang.org/account/avatar/00/14/2d/93/0f1cbf44.jpg","comment_is_top":false,"comment_ctime":1648627795,"is_pvip":false,"replies":[{"id":"124381","content":"good","user_name":"作者回复","user_name_real":"编辑","uid":"2537798","ctime":1648629214,"ip_address":"","comment_id":340144,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14533529683","product_id":100109401,"comment_content":"如果架构预先设计好了， 可以使用test double 技术来替换那些暂时你不需要实现或者不知道如何实现的类。等当前这个功能实现后在依次实现剩下已经划分好的功能，逐步替换就好了。","like_count":4,"discussions":[{"author":{"id":2537798,"avatar":"https://static001.geekbang.org/account/avatar/00/26/b9/46/758ecf4a.jpg","nickname":"徐八叉","note":"","ucode":"DA6D1EB08A7396","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":559156,"discussion_content":"good","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1648629214,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":340187,"user_name":"邓志国","can_delete":false,"product_type":"c1","uid":1043844,"ip_address":"","ucode":"380AE67ED7B9D7","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ed/84/0b8e2d25.jpg","comment_is_top":false,"comment_ctime":1648647813,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5943615109","product_id":100109401,"comment_content":"如果架构预先已经设计好了，那么TDD我觉得更简单：针对架构里面的接缝处找出适当的单元粒度编写测试并实现就好了。","like_count":1},{"had_liked":false,"id":340073,"user_name":"Numbpad1","can_delete":false,"product_type":"c1","uid":1114772,"ip_address":"","ucode":"2F075AC7E3847D","user_header":"https://static001.geekbang.org/account/avatar/00/11/02/94/2bf394f3.jpg","comment_is_top":false,"comment_ctime":1648570673,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5943537969","product_id":100109401,"comment_content":"”这些手法如此基础，应该被看作修改代码的基本功，而不是重构：谈不上什么消除坏味道，就是高效修改代码而已。”<br><br>确实如此基础，据我观察，我身边很多用这IntelliJ IDEA的程序员，大部分都是不知道，更没办法熟练运用这些技巧的，也包括我。<br><br>还好订阅了这个专栏，学到这么多基本功，现在在项目中已经在慢慢练习老师所教授的技巧， 给我带来的一个最直观的感受就是，高效+减少手动修改带来的BUG。","like_count":2},{"had_liked":false,"id":340072,"user_name":"Numbpad1","can_delete":false,"product_type":"c1","uid":1114772,"ip_address":"","ucode":"2F075AC7E3847D","user_header":"https://static001.geekbang.org/account/avatar/00/11/02/94/2bf394f3.jpg","comment_is_top":false,"comment_ctime":1648569946,"is_pvip":false,"replies":[{"id":"124340","content":"对于某些语言 工具没有提供这个重构。我们讲的是最基本的自动化支持。","user_name":"作者回复","user_name_real":"编辑","uid":"2537798","ctime":1648600295,"ip_address":"","comment_id":340072,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5943537242","product_id":100109401,"comment_content":"换入参顺序，可以使用Refactor里面的Change Signature... ，只需要在弹窗里面移动顺序，是不需要手动替换的。 ","like_count":1,"discussions":[{"author":{"id":2537798,"avatar":"https://static001.geekbang.org/account/avatar/00/26/b9/46/758ecf4a.jpg","nickname":"徐八叉","note":"","ucode":"DA6D1EB08A7396","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":559048,"discussion_content":"对于某些语言 工具没有提供这个重构。我们讲的是最基本的自动化支持。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1648600295,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":346439,"user_name":"姑射仙人","can_delete":false,"product_type":"c1","uid":1008517,"ip_address":"","ucode":"3EFC1F3E592165","user_header":"https://static001.geekbang.org/account/avatar/00/0f/63/85/1dc41622.jpg","comment_is_top":false,"comment_ctime":1653136845,"is_pvip":false,"replies":[{"id":"126402","content":"重构就是结果我不喜欢 我要改 没什么为什么","user_name":"作者回复","user_name_real":"编辑","uid":"2537798","ctime":1653211803,"ip_address":"","comment_id":346439,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1653136845","product_id":100109401,"comment_content":" 老师，将OptionClass提取出来的动机是什么，我能理解将问题分解到不同的模块。但是，这是倒果为因的讲法。在实际开发中，这种重构思路是依据经验吗？","like_count":0,"discussions":[{"author":{"id":2537798,"avatar":"https://static001.geekbang.org/account/avatar/00/26/b9/46/758ecf4a.jpg","nickname":"徐八叉","note":"","ucode":"DA6D1EB08A7396","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":573122,"discussion_content":"重构就是结果我不喜欢 我要改 没什么为什么","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1653211803,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":344231,"user_name":"keep_curiosity","can_delete":false,"product_type":"c1","uid":1246273,"ip_address":"","ucode":"794DC1D3FB9214","user_header":"https://static001.geekbang.org/account/avatar/00/13/04/41/082e2706.jpg","comment_is_top":false,"comment_ctime":1651382700,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1651382700","product_id":100109401,"comment_content":"# TDD 打卡＃跟练地址：https:&#47;&#47;github.com&#47;codingthought&#47;TDD-DI","like_count":0},{"had_liked":false,"id":341267,"user_name":"davix","can_delete":false,"product_type":"c1","uid":1074465,"ip_address":"","ucode":"CBFB39BAD7938B","user_header":"https://static001.geekbang.org/account/avatar/00/10/65/21/101a7075.jpg","comment_is_top":false,"comment_ctime":1649491575,"is_pvip":false,"replies":[{"id":"124744","content":"那就是重写","user_name":"作者回复","user_name_real":"编辑","uid":"2537798","ctime":1649495927,"ip_address":"","comment_id":341267,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1649491575","product_id":100109401,"comment_content":"老師，重構都在單元內吧（不變外在行為）。如果要優化調整單元的接口，響應測試也得調整，沒什麼辦法了吧","like_count":1,"discussions":[{"author":{"id":2537798,"avatar":"https://static001.geekbang.org/account/avatar/00/26/b9/46/758ecf4a.jpg","nickname":"徐八叉","note":"","ucode":"DA6D1EB08A7396","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":560946,"discussion_content":"那就是重写","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1649495927,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}