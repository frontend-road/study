{"id":625640,"title":"48 | å®Œå–„æ ¸å¿ƒèƒ½åŠ›ï¼šMasterè¯·æ±‚è½¬å‘ä¸Workerèµ„æºç®¡ç†","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯éƒ‘å»ºå‹‹ã€‚</p><p>è¿™èŠ‚è¯¾ï¼Œè®©æˆ‘ä»¬ç»§ç»­ä¼˜åŒ–MasteræœåŠ¡ï¼Œå®ç°Masterè¯·æ±‚è½¬å‘å’Œå¹¶å‘æƒ…å†µä¸‹çš„èµ„æºä¿æŠ¤ï¼ŒåŒæ—¶å®ç°Workerå¯¹åˆ†é…èµ„æºçš„ç›‘å¬ã€‚</p><h2>å°†Masterè¯·æ±‚è½¬å‘åˆ°Leader</h2><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦è€ƒè™‘ä¸€ä¸‹ï¼Œå½“Masteræ˜¯FollowerçŠ¶æ€ï¼ŒåŒæ—¶è¿˜æ¥æ”¶åˆ°äº†è¯·æ±‚çš„æƒ…å½¢ã€‚åœ¨ä¹‹å‰çš„è®¾è®¡ä¸­ï¼Œä¸ºäº†é¿å…å¹¶å‘å¤„ç†æ—¶å¯èƒ½å‡ºç°çš„å¼‚å¸¸æƒ…å†µï¼Œæˆ‘ä»¬åªæ‰“ç®—è®©Leaderæ¥å¤„ç†è¯·æ±‚ã€‚æ‰€ä»¥ï¼Œå½“MasterèŠ‚ç‚¹æ¥æ”¶åˆ°è¯·æ±‚æ—¶ï¼Œå¦‚æœå½“å‰èŠ‚ç‚¹ä¸æ˜¯Leaderï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æŠ¥é”™ï¼Œç”±å®¢æˆ·ç«¯é€‰æ‹©æ­£ç¡®çš„LeaderèŠ‚ç‚¹ã€‚å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code class=\"language-plain\">func (m *Master) AddResource(ctx context.Context, req *proto.ResourceSpec, resp *proto.NodeSpec) error {\n\tif !m.IsLeader() {\n\t\treturn errors.New(\"no leader\")\n\t}\n}\n</code></pre><p>æˆ‘ä»¬è¿˜å¯ä»¥é‡‡ç”¨å¦å¤–ä¸€ç§æ›´å¸¸è§çš„æ–¹å¼ï¼šå°†æ¥æ”¶åˆ°çš„è¯·æ±‚è½¬å‘ç»™Leaderã€‚è¦å®ç°è¿™ä¸€ç‚¹ï¼Œé¦–å…ˆæ‰€æœ‰MasterèŠ‚ç‚¹è¦åœ¨Leaderå‘ç”Ÿå˜æ›´æ—¶ï¼Œå°†å½“å‰æœ€æ–°çš„Leaderåœ°å€ä¿å­˜åˆ°leaderIDä¸­ã€‚</p><pre><code class=\"language-plain\">func (m *Master) Campaign() {\n\tselect {\n\t\tcase resp := &lt;-leaderChange:\n\t\t\tm.logger.Info(\"watch leader change\", zap.String(\"leader:\", string(resp.Kvs[0].Value)))\n\t\t\tm.leaderID = string(resp.Kvs[0].Value)\n\t\t}\t\n\t\tfor {\n\t\t\tselect {\n\t\t\tcase err := &lt;-leaderCh:\n\t\t\t\t\tm.leaderID = m.ID\n\t\t\tcase resp := &lt;-leaderChange:\n\t\t\t\tif len(resp.Kvs) &gt; 0 {\n\t\t\t\t\tm.logger.Info(\"watch leader change\", zap.String(\"leader:\", string(resp.Kvs[0].Value)))\n\t\t\t\t\tm.leaderID = string(resp.Kvs[0].Value)\n\t\t\t\t}\n\t\t}\n}\n</code></pre><!-- [[[read_end]]] --><p>åœ¨å¤„ç†è¯·æ±‚å‰ï¼Œé¦–å…ˆåˆ¤æ–­å½“å‰Masterçš„çŠ¶æ€ï¼Œå¦‚æœå®ƒä¸æ˜¯Leaderï¼Œå°±è·å–Leaderçš„åœ°å€å¹¶å®Œæˆè¯·æ±‚çš„è½¬å‘ã€‚æ³¨æ„ï¼Œè¿™é‡Œå¦‚æœä¸æŒ‡å®šLeaderçš„åœ°å€ï¼Œgo-microå°±ä¼šéšæœºé€‰æ‹©ä¸€ä¸ªåœ°å€è¿›è¡Œè½¬å‘ã€‚</p><pre><code class=\"language-plain\">func (m *Master) AddResource(ctx context.Context, req *proto.ResourceSpec, resp *proto.NodeSpec) error {\n\tif !m.IsLeader() &amp;&amp; m.leaderID != \"\" &amp;&amp; m.leaderID != m.ID {\n\t\taddr := getLeaderAddress(m.leaderID)\n\t\tnodeSpec, err := m.forwardCli.AddResource(ctx, req, client.WithAddress(addr))\n\t\tresp.Id = nodeSpec.Id\n\t\tresp.Address = nodeSpec.Address\n\t\treturn err\n\t}\n\n\tnodeSpec, err := m.addResources(&amp;ResourceSpec{Name: req.Name})\n\tif nodeSpec != nil {\n\t\tresp.Id = nodeSpec.Node.Id\n\t\tresp.Address = nodeSpec.Node.Address\n\t}\n\treturn err\n}\n</code></pre><p>åœ¨è½¬å‘æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†microç”Ÿæˆçš„GRPCå®¢æˆ·ç«¯ï¼Œè¿™æ˜¯é€šè¿‡åœ¨åˆå§‹åŒ–æ—¶å¯¼å…¥ micro GRPC clientçš„æ’ä»¶å®ç°çš„ã€‚SetForwardCliæ–¹æ³•å°†ç”Ÿæˆçš„GRPC client æ³¨å…¥åˆ°äº†Masterç»“æ„ä½“ä¸­ã€‚</p><pre><code class=\"language-plain\">import (\n\tgrpccli \"github.com/go-micro/plugins/v4/client/grpc\"\n)\n\nfunc RunGRPCServer(m *master.Master, logger *zap.Logger, reg registry.Registry, cfg ServerConfig) {\n\tservice := micro.NewService(\n\t\t...\n\t\tmicro.Client(grpccli.NewClient()),\n\t)\n\n\tcl := proto.NewCrawlerMasterService(cfg.Name, service.Client())\n\tm.SetForwardCli(cl)\n}\n</code></pre><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹æœåŠ¡æ˜¯å¦èƒ½å¤Ÿæ­£ç¡®åœ°è½¬å‘ã€‚</p><p>é¦–å…ˆå¯åŠ¨ä¸€ä¸ª Workerå’Œä¸€ä¸ªMasteræœåŠ¡ï¼Œå½“å‰çš„ Leaderä¼šå˜æˆmaster2ï¼ŒIPåœ°å€ä¸º192.168.0.105:9091ã€‚</p><pre><code class=\"language-plain\">Â» go run main.go worker  --pprof=:9983\nÂ» go run main.go master --id=2 --http=:8081  --grpc=:9091\n</code></pre><p>ç°åœ¨æˆ‘ä»¬å¯åŠ¨ä¸€ä¸ªæ–°çš„MasteræœåŠ¡master3ã€‚</p><pre><code class=\"language-plain\">Â» go run main.go master --id=3 --http=:8082  --grpc=:9092 --pprof=:9982\n</code></pre><p>æ¥ç€è®¿é—®master3æœåŠ¡æš´éœ²çš„HTTPæ¥å£ã€‚è™½ç„¶master3å¹¶ä¸æ˜¯Leaderï¼Œä½†æ˜¯è®¿é—®master3æ·»åŠ èµ„æºæ—¶ï¼Œæ“ä½œä»ç„¶èƒ½å¤ŸæˆåŠŸã€‚</p><pre><code class=\"language-plain\">Â» curl  --request POST 'http://localhost:8082/crawler/resource' --header 'Content-Type: application/json' --data '{\"id\":\"zjx\",\"name\": \"task-forward\"}' \n{\"id\":\"go.micro.server.worker-1\",\"Address\":\"192.168.0.105:9090\"}\n</code></pre><p>åŒæ—¶ï¼Œæˆ‘ä»¬åœ¨LeaderæœåŠ¡çš„æ—¥å¿—ä¸­èƒ½å¤Ÿçœ‹åˆ°è¯·æ±‚ä¿¡æ¯ï¼ŒéªŒè¯æˆåŠŸã€‚</p><pre><code class=\"language-plain\">{\"level\":\"INFO\",\"ts\":\"2022-12-29T17:23:55.792+0800\",\"caller\":\"master/master.go:198\",\"msg\":\"receive request\",\"method\":\"CrawlerMaster.AddResource\",\"Service\":\"go.micro.server.master\",\"request param:\":{\"id\":\"zjx\",\"name\":\"task-forward\"}}\n</code></pre><h2>èµ„æºä¿æŠ¤</h2><p>ç”±äºWorkerèŠ‚ç‚¹ä¸Resourceèµ„æºä¸€ç›´åœ¨åŠ¨æ€å˜åŒ–å½“ä¸­ï¼Œå› æ­¤å¦‚æœä¸è€ƒè™‘æ•°æ®çš„å¹¶å‘å®‰å…¨ï¼Œåœ¨å¤æ‚çº¿ä¸Šåœºæ™¯ä¸‹ï¼Œå°±å¯èƒ½å‡ºç°å¾ˆå¤šéš¾ä»¥è§£é‡Šçš„ç°è±¡ã€‚</p><p>ä¸ºäº†é¿å…æ•°æ®çš„å¹¶å‘å®‰å…¨é—®é¢˜ï¼Œæˆ‘ä»¬ä¹‹å‰åˆ©ç”¨äº†é€šé“æ¥è¿›è¡Œåç¨‹é—´çš„é€šä¿¡ï¼Œä½†<strong>å¦‚æœæˆ‘ä»¬ç°åœ¨å¸Œæœ›ä¿æŠ¤WorkerèŠ‚ç‚¹ä¸Resourceèµ„æºï¼Œ</strong><strong>å…¶å®å½“å‰åœºæ™¯ä¸‹æ›´å¥½çš„æ–¹å¼æ˜¯ä½¿ç”¨åŸç”Ÿçš„äº’æ–¥é”ã€‚</strong>è¿™æ˜¯å› ä¸ºæˆ‘ä»¬åªå¸Œæœ›åœ¨å…³é”®ä½ç½®åŠ é”ï¼Œå…¶ä»–çš„é€»è¾‘ä»ç„¶æ˜¯å¹¶è¡Œçš„ã€‚å¦‚æœæˆ‘ä»¬åœ¨è¯»å–ä¸€ä¸ªå˜é‡æ—¶è¿˜è¦ç”¨é€šé“æ¥é€šä¿¡ï¼Œä»£ç ä¼šå˜å¾—ä¸ä¼˜é›…ã€‚</p><p>æˆ‘ä»¬æ¥çœ‹ä¸‹ä½¿ç”¨åŸç”Ÿäº’æ–¥é”çš„æ“ä½œæ˜¯æ€æ ·çš„ã€‚å¦‚ä¸‹ï¼Œåœ¨Masterä¸­æ·»åŠ sync.Mutexäº’æ–¥é”ï¼Œç”¨äºèµ„æºçš„å¹¶å‘å®‰å…¨ã€‚</p><pre><code class=\"language-plain\">type Master struct {\n\t...\n\tID         string\n\trlock      sync.Mutex\n\n\toptions\n}\n</code></pre><p>æˆ‘ä»¬å¯ä»¥åœ¨èµ„æºæ›´æ–°ï¼ˆèµ„æºåŠ è½½ä¸å¢åˆ æŸ¥æ”¹ï¼‰ã€WorkerèŠ‚ç‚¹æ›´æ–°ã€èµ„æºåˆ†é…çš„é˜¶æ®µéƒ½åŠ å…¥äº’æ–¥é”å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code class=\"language-plain\">func (m *Master) DeleteResource(ctx context.Context, spec *proto.ResourceSpec, empty *empty.Empty) error {\n\tm.rlock.Lock()\n\tdefer m.rlock.Unlock()\n\n\tr, ok := m.resources[spec.Name]\n\t...\n}\n\nfunc (m *Master) AddResource(ctx context.Context, req *proto.ResourceSpec, resp *proto.NodeSpec) error {\n\t...\n\tm.rlock.Lock()\n\tdefer m.rlock.Lock()\n\tnodeSpec, err := m.addResources(&amp;ResourceSpec{Name: req.Name})\n\tif nodeSpec != nil {\n\t\tresp.Id = nodeSpec.Node.Id\n\t\tresp.Address = nodeSpec.Node.Address\n\t}\n\treturn err\n}\n\nfunc (m *Master) updateWorkNodes() {\n\tservices, err := m.registry.GetService(worker.ServiceName)\n\tif err != nil {\n\t\tm.logger.Error(\"get service\", zap.Error(err))\n\t}\n\n\tm.rlock.Lock()\n\tdefer m.rlock.Unlock()\n\t...\n\tm.workNodes = nodes\n}\n\nfunc (m *Master) loadResource() error {\n\tresp, err := m.etcdCli.Get(context.Background(), RESOURCEPATH, clientv3.WithPrefix(), clientv3.WithSerializable())\n\t...\n\tresources := make(map[string]*ResourceSpec)\n\tm.rlock.Lock()\n\tdefer m.rlock.Unlock()\n\tm.resources = resources\n}\n\nfunc (m *Master) reAssign() {\n\trs := make([]*ResourceSpec, 0, len(m.resources))\n\n\tm.rlock.Lock()\n\tdefer m.rlock.Unlock()\n\n\tfor _, r := range m.resources {...}\n\n\tfor _, r := range rs {\n\t\tm.addResources(r)\n\t}\n}\n</code></pre><p>å½“å¤–éƒ¨è®¿é—®Leaderçš„HTTPæ¥å£æ—¶ï¼Œå®é™…ä¸ŠæœåŠ¡ç«¯ä¼šå¼€è¾Ÿä¸€ä¸ªåç¨‹å¹¶å‘å¤„ç†è¯·æ±‚ã€‚é€šè¿‡ä½¿ç”¨äº’æ–¥é”ï¼Œæˆ‘ä»¬æ¶ˆé™¤äº†å¹¶å‘è®¿é—®åŒä¸€èµ„æºå¯èƒ½å‡ºç°çš„é—®é¢˜ã€‚åœ¨å®è·µä¸­ï¼Œéœ€è¦åˆç†åœ°ä½¿ç”¨äº’æ–¥é”ï¼Œå°½é‡è®©é”å®šçš„èŒƒå›´è¶³å¤Ÿå°ï¼Œé”å®šçš„èµ„æºè¶³å¤Ÿå°‘ï¼Œå‡å°‘é”ç­‰å¾…çš„æ—¶é—´ã€‚</p><h2>Workerå•æœºæ¨¡å¼</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬å›åˆ°Workerã€‚Workerå¯ä»¥æœ‰ä¸¤ç§æ¨¡å¼ï¼Œé›†ç¾¤æ¨¡å¼ä¸å•æœºæ¨¡å¼ã€‚æˆ‘ä»¬å¯ä»¥åœ¨Workerä¸­åŠ ä¸€ä¸ªflagæ¥åˆ‡æ¢Workerè¿è¡Œçš„æ¨¡å¼ã€‚</p><p>å¯¹äºå°‘é‡çš„ä»»åŠ¡ï¼Œå¯ä»¥ç›´æ¥ç”¨å•æœºç‰ˆçš„Workeræ¥å¤„ç†ï¼Œç§å­èŠ‚ç‚¹æ¥è‡ªäºé…ç½®æ–‡ä»¶ã€‚è€Œå¯¹äºé›†ç¾¤ç‰ˆçš„Workerï¼Œä»»åŠ¡å°†æ¥è‡ªMasterçš„åˆ†é…ã€‚</p><p>è¦åˆ‡æ¢Workeræ¨¡å¼åªè¦åˆ¤æ–­ä¸€ä¸ªflagå€¼clusterå³å¯åšåˆ°ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼Œåœ¨å¯åŠ¨Workeræ—¶ï¼Œå¦‚æœclusterä¸ºfalseï¼Œä»£è¡¨ä¸ºå•æœºæ¨¡å¼ã€‚å¦‚æœclusterä¸ºtrueï¼Œä»£è¡¨æ˜¯é›†ç¾¤æ¨¡å¼ã€‚</p><pre><code class=\"language-plain\">\nWorkerCmd.Flags().BoolVar(\n\t\t&amp;cluster, \"cluster\", true, \"run mode\")\nvar cluster bool\n\nfunc (c *Crawler) Run(cluster bool) {\n\tif !cluster {\n\t\tc.handleSeeds()\n\t}\n\n\tgo c.Schedule()\n\tfor i := 0; i &lt; c.WorkCount; i++ {\n\t\tgo c.CreateWork()\n\t}\n\tc.HandleResult()\n}\n</code></pre><h2>Workeré›†ç¾¤æ¨¡å¼</h2><p>åœ¨é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¹¦å†™WorkeråŠ è½½å’Œç›‘å¬etcdèµ„æºè¿™ä¸€é‡è¦çš„åŠŸèƒ½ã€‚é¦–å…ˆæ¥çœ‹çœ‹åˆå§‹åŒ–æ—¶çš„èµ„æºåŠ è½½ï¼Œåœ¨åˆå§‹æ—¶ï¼Œæˆ‘ä»¬ç”Ÿæˆäº†etcd clientï¼Œå¹¶æ³¨å…¥åˆ°Crawlerç»“æ„ä¸­ã€‚</p><pre><code class=\"language-plain\">endpoints := []string{e.registryURL}\ncli, err := clientv3.New(clientv3.Config{Endpoints: endpoints})\nif err != nil {\n\treturn nil, err\n}\ne.etcdCli = cli\n</code></pre><h3>èµ„æºåŠ è½½</h3><p>Crawler.loadResourceæ–¹æ³•ç”¨äºä»etcdä¸­åŠ è½½èµ„æºã€‚æˆ‘ä»¬è°ƒç”¨etcd Getæ–¹æ³•ï¼Œè·å–å‰ç¼€ä¸º<code>/resources</code> çš„å…¨é‡èµ„æºåˆ—è¡¨ã€‚è§£æè¿™äº›èµ„æºï¼ŒæŸ¥çœ‹å½“å‰èµ„æºåˆ†é…çš„èŠ‚ç‚¹æ˜¯å¦ä¸ºå½“å‰èŠ‚ç‚¹ã€‚å¦‚æœåˆ†é…çš„èŠ‚ç‚¹å’Œå½“å‰èŠ‚ç‚¹åŒ¹é…ï¼Œæ„å‘³ç€å½“å‰èµ„æºæ˜¯åˆ†é…ç»™å½“å‰èŠ‚ç‚¹çš„ï¼Œä¸æ˜¯å½“å‰èŠ‚ç‚¹çš„èµ„æºå°†ä¼šè¢«ç›´æ¥å¿½ç•¥ã€‚</p><pre><code class=\"language-plain\">func (c *Crawler) loadResource() error {\n\tresp, err := c.etcdCli.Get(context.Background(), master.RESOURCEPATH, clientv3.WithPrefix(), clientv3.WithSerializable())\n\tif err != nil {\n\t\treturn fmt.Errorf(\"etcd get failed\")\n\t}\n\n\tresources := make(map[string]*master.ResourceSpec)\n\tfor _, kv := range resp.Kvs {\n\t\tr, err := master.Decode(kv.Value)\n\t\tif err == nil &amp;&amp; r != nil {\n\t\t\tid := getID(r.AssignedNode)\n\t\t\tif len(id) &gt; 0 &amp;&amp; c.id == id {\n\t\t\t\tresources[r.Name] = r\n\t\t\t}\n\t\t}\n\t}\n\tc.Logger.Info(\"leader init load resource\", zap.Int(\"lenth\", len(resources)))\n\tc.rlock.Lock()\n\tdefer c.rlock.Unlock()\n\tc.resources = resources\n\tfor _, r := range c.resources {\n\t\tc.runTasks(r.Name)\n\t}\n\n\treturn nil\n}\n</code></pre><p>èµ„æºåŠ è½½å®Œæ¯•åï¼Œåˆ†é…ç»™å½“å‰èŠ‚ç‚¹çš„ä»»åŠ¡ä¼šæ‰§è¡ŒrunTaskæ–¹æ³•ï¼Œé€šè¿‡ä»»åŠ¡åä»å…¨å±€ä»»åŠ¡æ± ä¸­è·å–çˆ¬è™«ä»»åŠ¡ï¼Œè°ƒç”¨t.Rule.Root()è·å–ç§å­è¯·æ±‚ï¼Œå¹¶æ”¾å…¥åˆ°è°ƒåº¦å™¨ä¸­æ‰§è¡Œã€‚</p><pre><code class=\"language-plain\">func (c *Crawler) runTasks(taskName string) {\n\tt, ok := Store.Hash[taskName]\n\tif !ok {\n\t\tc.Logger.Error(\"can not find preset tasks\", zap.String(\"task name\", taskName))\n\t\treturn\n\t}\n\tres, err := t.Rule.Root()\n\n\tif err != nil {\n\t\tc.Logger.Error(\"get root failed\",\n\t\t\tzap.Error(err),\n\t\t)\n\t\treturn\n\t}\n\n\tfor _, req := range res {\n\t\treq.Task = t\n\t}\n\tc.scheduler.Push(res...)\n}\n</code></pre><h3>èµ„æºç›‘å¬</h3><p>é™¤äº†åŠ è½½èµ„æºï¼Œåœ¨åˆå§‹åŒ–æ—¶æˆ‘ä»¬è¿˜éœ€è¦å¼€è¾Ÿä¸€ä¸ªæ–°çš„åç¨‹c.watchResourceæ¥ç›‘å¬èµ„æºçš„å˜åŒ–ã€‚</p><pre><code class=\"language-plain\">func (c *Crawler) Run(id string, cluster bool) {\n\tc.id = id\n\tif !cluster {\n\t\tc.handleSeeds()\n\t}\n\tgo c.loadResource()\n\tgo c.watchResource()\n\tgo c.Schedule()\n\tfor i := 0; i &lt; c.WorkCount; i++ {\n\t\tgo c.CreateWork()\n\t}\n\tc.HandleResult()\n}\n</code></pre><p>å¦‚ä¸‹æ‰€ç¤ºï¼Œæˆ‘åœ¨watchResourceå‡½æ•°ä¸­ä¹¦å†™äº†ä¸€ä¸ªç›‘å¬æ–°å¢èµ„æºçš„åŠŸèƒ½ã€‚watchResourceå€ŸåŠ©etcd client çš„Watchæ–¹æ³•ç›‘å¬èµ„æºçš„å˜åŒ–ã€‚Watchè¿”å›å€¼æ˜¯ä¸€ä¸ªé€šé“ï¼Œå½“etcd clientç›‘å¬åˆ°etcdä¸­å‰ç¼€ä¸º <code>/resources</code> çš„èµ„æºå‘ç”Ÿå˜åŒ–æ—¶ï¼Œå°±ä¼šå°†ä¿¡æ¯å†™å…¥åˆ°é€šé“Watchä¸­ã€‚é€šè¿‡é€šé“è¿”å›çš„ä¿¡æ¯ï¼Œä¸ä»…èƒ½å¤Ÿå¾—åˆ°å½“å‰æœ‰å˜åŠ¨çš„èµ„æºæœ€æ–°çš„å€¼ï¼Œè¿˜å¯ä»¥å¾—çŸ¥å½“å‰èµ„æºå˜åŠ¨çš„äº‹ä»¶æ˜¯æ–°å¢ã€æ›´æ–°è¿˜æ˜¯åˆ é™¤ã€‚å¦‚æœæ˜¯æ–°å¢äº‹ä»¶ï¼Œé‚£å°±è°ƒç”¨runTaskså¯åŠ¨è¯¥èµ„æºå¯¹åº”çš„çˆ¬è™«ä»»åŠ¡ã€‚</p><pre><code class=\"language-plain\">func (c *Crawler) watchResource() {\n\twatch := c.etcdCli.Watch(context.Background(), master.RESOURCEPATH, clientv3.WithPrefix())\n\tfor w := range watch {\n\t\tif w.Err() != nil {\n\t\t\tc.Logger.Error(\"watch resource failed\", zap.Error(w.Err()))\n\t\t\tcontinue\n\t\t}\n\t\tif w.Canceled {\n\t\t\tc.Logger.Error(\"watch resource canceled\")\n\t\t\treturn\n\t\t}\n\t\tfor _, ev := range w.Events {\n\t\t\tspec, err := master.Decode(ev.Kv.Value)\n\t\t\tif err != nil {\n\t\t\t\tc.Logger.Error(\"decode etcd value failed\", zap.Error(err))\n\t\t\t}\n\n\t\t\tswitch ev.Type {\n\t\t\tcase clientv3.EventTypePut:\n\t\t\t\tif ev.IsCreate() {\n\t\t\t\t\tc.Logger.Info(\"receive create resource\", zap.Any(\"spec\", spec))\n\n\t\t\t\t} else if ev.IsModify() {\n\t\t\t\t\tc.Logger.Info(\"receive update resource\", zap.Any(\"spec\", spec))\n\t\t\t\t}\n\t\t\t\tc.runTasks(spec.Name)\n\t\t\tcase clientv3.EventTypeDelete:\n\t\t\t\tc.Logger.Info(\"receive delete resource\", zap.Any(\"spec\", spec))\n\t\t\t}\n\t\t}\n\t}\n}\n</code></pre><p>ç°åœ¨è®©æˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹æ–°å¢èµ„æºçš„åŠŸèƒ½ï¼Œå¯åŠ¨Masterä¸WorkerèŠ‚ç‚¹ã€‚</p><pre><code class=\"language-plain\">Â» go run main.go master --id=3 --http=:8082  --grpc=:9092 --pprof=:9982\nÂ» go run main.go worker  --pprof=:9983\n</code></pre><p>ç´§æ¥ç€è°ƒç”¨Masterçš„æ·»åŠ èµ„æºæ¥å£ã€‚</p><pre><code class=\"language-plain\">Â» curl -H \"content-type: application/json\" -d '{\"id\":\"zjx\",\"name\": \"douban_book_list\"}' &lt;http://localhost:8082/crawler/resource&gt;         jackson@localhost\n{\"id\":\"go.micro.server.worker-1\", \"Address\":\"192.168.0.105:9090\"}\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼ŒWorkeræ—¥å¿—ä¸­ä»»åŠ¡å¼€å§‹æ­£å¸¸åœ°æ‰§è¡Œäº†ï¼ŒéªŒè¯æˆåŠŸã€‚å®Œæ•´ä»£ç ä½ å¯ä»¥æŸ¥çœ‹<a href=\"https://github.com/dreamerjackson/crawler\">v0.4.1åˆ†æ”¯</a>ã€‚</p><pre><code class=\"language-plain\">{\"level\":\"DEBUG\",\"ts\":\"2022-12-30T21:06:56.743+0800\",\"caller\":\"doubanbook/book.go:77\",\"msg\":\"parse book tag,count: 47\"}\n{\"level\":\"DEBUG\",\"ts\":\"2022-12-30T21:07:00.532+0800\",\"caller\":\"doubanbook/book.go:108\",\"msg\":\"parse book list,count: 20 url: &lt;https://book.douban.com/tag/éšç¬”&gt;\"}\n{\"level\":\"DEBUG\",\"ts\":\"2022-12-30T21:07:04.240+0800\",\"caller\":\"doubanbook/book.go:108\",\"msg\":\"parse book list,count: 20 url: &lt;https://book.douban.com/tag/æ•£æ–‡&gt;\"}\n</code></pre><h3>èµ„æºåˆ é™¤</h3><p>æ¥ä¸‹æ¥è®©æˆ‘ä»¬ç»§ç»­çœ‹çœ‹å¦‚ä½•åˆ é™¤ä¸€ä¸ªçˆ¬è™«ä»»åŠ¡ã€‚</p><p>æˆ‘ä»¬éœ€è¦åœ¨Watchçš„é€‰é¡¹ä¸­è®¾ç½® <code>clientv3.WithPrevKV()</code>ï¼Œè¿™æ ·ï¼Œå½“ç›‘å¬åˆ°èµ„æºçš„åˆ é™¤æ—¶ï¼Œå°±èƒ½å¤Ÿè·å–å½“å‰åˆ é™¤çš„èµ„æºä¿¡æ¯ï¼Œæ¥ç€å°±å¯ä»¥è°ƒç”¨ <code>c.deleteTasks</code> æ¥åˆ é™¤ä»»åŠ¡äº†ã€‚</p><pre><code class=\"language-plain\">func (c *Crawler) watchResource() {\n\twatch := c.etcdCli.Watch(context.Background(), master.RESOURCEPATH, clientv3.WithPrefix(), clientv3.WithPrevKV())\n\tfor w := range watch {\n\t\tfor _, ev := range w.Events {\n\t\t\tswitch ev.Type {\n\t\t\t...\n\t\t\tcase clientv3.EventTypeDelete:\n\t\t\t\tspec, err := master.Decode(ev.PrevKv.Value)\n\t\t\t\tc.Logger.Info(\"receive delete resource\", zap.Any(\"spec\", spec))\n\t\t\t\tif err != nil {\n\t\t\t\t\tc.Logger.Error(\"decode etcd value failed\", zap.Error(err))\n\t\t\t\t}\n\t\t\t\tc.rlock.Lock()\n\t\t\t\tc.deleteTasks(spec.Name)\n\t\t\t\tc.rlock.Unlock()\n\t\t\t}\n\t\t}\n\t}\n}\n</code></pre><p>deleteTasks ä¼šåˆ é™¤ <code>c.resources</code> ä¸­å­˜å‚¨çš„å½“å‰Taskï¼Œå¹¶ä¸”å°†Taskçš„Closedå˜é‡è®¾ç½®ä¸ºtrueã€‚</p><pre><code class=\"language-plain\">func (c *Crawler) deleteTasks(taskName string) {\n\tt, ok := Store.Hash[taskName]\n\tif !ok {\n\t\tc.Logger.Error(\"can not find preset tasks\", zap.String(\"task name\", taskName))\n\t\treturn\n\t}\n\tt.Closed = true\n\tdelete(c.resources, taskName)\n}\n</code></pre><p>æˆ‘ä»¬åœ¨Taskä¸­è®¾è®¡äº†ä¸€ä¸ªæ–°çš„å˜é‡Closedç”¨äºæ ‡è¯†å½“å‰çš„ä»»åŠ¡æ˜¯å¦å·²ç»è¢«åˆ é™¤äº†ã€‚è¿™æ˜¯å› ä¸ºè¢«åˆ é™¤çš„ä»»åŠ¡å¯èƒ½ç°åœ¨è¿˜åœ¨è¿è¡Œå½“ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡è¯¥å˜é‡ç¡®è®¤å®ƒå·²ç»ä¸å†è¿è¡Œäº†ã€‚</p><p>åœ¨ä¸€äº›åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å°†æ ‡è¯†ä»»åŠ¡æ˜¯å¦å·²ç»ç»“æŸçš„å˜é‡è®¾è®¡ä¸ºé€šé“ç±»å‹æˆ–è€…context.Contextï¼Œç„¶åä¸selectè¯­å¥ç»“åˆèµ·æ¥å®ç°å¤šè·¯å¤ç”¨ã€‚æˆ‘ä»¬åœ¨HTTPæ ‡å‡†åº“ä¸­ä¹Ÿç»å¸¸çœ‹åˆ°è¿™ç§ç”¨æ³•ï¼Œå®ƒå¯ä»¥åˆ¤æ–­é€šé“çš„äº‹ä»¶ä¸å…¶ä»–äº‹ä»¶å“ªä¸€ä¸ªå…ˆå‘ç”Ÿã€‚</p><pre><code class=\"language-plain\">type Task struct {\n\tVisited     map[string]bool\n\tVisitedLock sync.Mutex\n\n\t//\n\tClosed bool\n\n\tRule RuleTree\n\tOptions\n}\n</code></pre><p>ä¸è¿‡æˆ‘ä»¬è¿™é‡Œä½¿ç”¨ä¸€ä¸ªæ ‡è¯†ä»»åŠ¡æ˜¯å¦å…³é—­çš„boolç±»å‹å°±è¶³å¤Ÿäº†ã€‚åœ¨ä»»åŠ¡æµç¨‹çš„æ ¸å¿ƒä½ç½®ï¼Œæˆ‘ä»¬éƒ½éœ€è¦æ£€æµ‹è¯¥å˜é‡ã€‚æ£€æµ‹åˆ°ä»»åŠ¡å…³é—­æ—¶ï¼Œå°±ä¸å†æ‰§è¡Œåç»­çš„æµç¨‹ã€‚</p><p>å…·ä½“æ“ä½œæ˜¯åœ¨request.Checkæ–¹æ³•ä¸­ï¼ŒåŠ å…¥å¯¹ä»»åŠ¡æ˜¯å¦å…³é—­çš„åˆ¤æ–­ã€‚</p><pre><code class=\"language-plain\">func (r *Request) Check() error {\n\tif r.Depth &gt; r.Task.MaxDepth {\n\t\treturn errors.New(\"max depth limit reached\")\n\t}\n\n\tif r.Task.Closed {\n\t\treturn errors.New(\"task has Closed\")\n\t}\n\n\treturn nil\n}\n</code></pre><p>æ¥ç€ï¼Œåœ¨ä»»åŠ¡çš„é‡‡é›†å’Œè°ƒåº¦çš„ä¸¤ä¸ªæ ¸å¿ƒä½ç½®æ£€æµ‹ä»»åŠ¡çš„æœ‰æ•ˆæ€§ã€‚ä¸€æ—¦å‘ç°ä»»åŠ¡å·²ç»è¢«å…³é—­ï¼Œå®ƒæ‰€æœ‰çš„è¯·æ±‚å°†ä¸å†è¢«è°ƒåº¦å’Œé‡‡é›†ã€‚</p><pre><code class=\"language-plain\">func (c *Crawler) CreateWork() {\n\tfor {\n\t\treq := c.scheduler.Pull()\n\t\tif err := req.Check(); err != nil {\n\t\t\tc.Logger.Debug(\"check failed\",\n\t\t\t\tzap.Error(err),\n\t\t\t)\n\n\t\t\tcontinue\n\t\t}\n}\n\nfunc (s *Schedule) Schedule() {\n\tvar ch chan *spider.Request\n\n\tvar req *spider.Request\n\n\tfor {\n\t\t...\n\t\t// è¯·æ±‚æ ¡éªŒ\n\t\tif req != nil {\n\t\t\tif err := req.Check(); err != nil {\n\t\t\t\tzap.S().Debug(\"check failed\",\n\t\t\t\t\tzap.Error(err),\n\t\t\t\t)\n\t\t\t\treq = nil\n\t\t\t\tch = nil\n\t\t\t\tcontinue\n\t\t\t}\n\t\t}\n}\n</code></pre><p>ä¸‹é¢è®©æˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹ä»»åŠ¡çš„åˆ é™¤åŠŸèƒ½æ˜¯å¦æ­£å¸¸ï¼Œé¦–å…ˆå¯åŠ¨ä¸€ä¸ªMasterå’Œä¸€ä¸ªWorkeræœåŠ¡ã€‚</p><pre><code class=\"language-plain\">Â» go run main.go master --id=3 --http=:8082  --grpc=:9092 --pprof=:9982\nÂ» go run main.go worker  --pprof=:9983\n</code></pre><p>ç´§æ¥ç€ï¼Œè°ƒç”¨Masterçš„æ·»åŠ èµ„æºæ¥å£ï¼Œå¯ä»¥çœ‹åˆ°çˆ¬è™«ä»»åŠ¡æ˜¯æ­£å¸¸æ‰§è¡Œçš„ã€‚</p><pre><code class=\"language-plain\">Â» curl -H \"content-type: application/json\" -d '{\"id\":\"zjx\",\"name\": \"douban_book_list\"}' &lt;http://localhost:8082/crawler/resource&gt;         jackson@localhost\n{\"id\":\"go.micro.server.worker-1\", \"Address\":\"192.168.0.105:9090\"}\n</code></pre><p>ç„¶åï¼Œæˆ‘ä»¬è°ƒç”¨Masterçš„åˆ é™¤èµ„æºæ¥å£ï¼Œä»Workerä¸­çš„æ—¥å¿—å¯ä»¥çœ‹åˆ°ï¼ŒWorkerç›‘å¬åˆ°äº†åˆ é™¤èµ„æºçš„äº‹ä»¶ã€‚åœ¨æ—¥å¿—æ‰“å°å‡º <code>\"task has Closed\"</code> çš„é”™è¯¯ä¿¡æ¯ä¹‹åï¼Œåˆ é™¤çš„çˆ¬è™«ä»»åŠ¡å°†ä¸å†è¿è¡Œã€‚</p><pre><code class=\"language-plain\">{\"level\":\"INFO\",\"ts\":\"2022-12-31T14:06:33.528+0800\",\"caller\":\"engine/schedule.go:479\",\"msg\":\"receive delete resource\",\"spec\":{\"ID\":\"1609068436011356160\",\"Name\":\"douban_book_list\",\"AssignedNode\":\"go.micro.server.worker-1|192.168.0.105:9090\",\"CreationTime\":1672466784878532000}\n{\"level\":\"DEBUG\",\"ts\":\"2022-12-31T14:06:33.845+0800\",\"caller\":\"engine/schedule.go:336\",\"msg\":\"check failed\",\"error\":\"task has Closed\"}\n{\"level\":\"DEBUG\",\"ts\":\"2022-12-31T14:06:33.845+0800\",\"caller\":\"engine/schedule.go:269\",\"msg\":\"check failed\",\"error\":\"task has Closed\"}\n</code></pre><p>æ­¤åï¼Œå½“æˆ‘ä»¬å†æ¬¡è°ƒç”¨Masterçš„æ·»åŠ èµ„æºæ¥å£æ—¶ï¼Œçˆ¬è™«ä»»åŠ¡åˆå°†æ¢å¤å¦‚åˆã€‚åˆ é™¤åŠŸèƒ½éªŒè¯æˆåŠŸã€‚</p><h2>æ€»ç»“</h2><p>å¥½äº†ï¼Œè¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬è®¾è®¡äº†å°†Masterè¯·æ±‚è½¬å‘åˆ°Leaderçš„åŠŸèƒ½ï¼Œè®©æ‰€æœ‰çš„Masteréƒ½å…·å¤‡äº†æ¥æ”¶è¯·æ±‚çš„èƒ½åŠ›ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜ä½¿ç”¨äº†åŸç”Ÿçš„äº’æ–¥é”è§£å†³äº†å¹¶å‘å®‰å…¨é—®é¢˜ã€‚å› ä¸ºé€šé“å¹¶ä¸æ€»æ˜¯è§£å†³å¹¶å‘å®‰å…¨é—®é¢˜çš„æœ€ä½³æ–¹å¼ï¼Œåœ¨è¿™é‡Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨é€šé“ä¼šå‡æ…¢ç¨‹åºçš„å¹¶å‘æ€§ï¼Œä½¿ä»£ç å˜å¾—ä¸ä¼˜é›…ã€‚</p><p>æœ€åï¼Œæˆ‘ä»¬è¿˜å®ç°äº†åœ¨Workeré›†ç¾¤æ¨¡å¼ä¸‹ä»»åŠ¡çš„åŠ è½½ä¸ç›‘å¬ã€‚åœ¨åˆå§‹åŒ–æ—¶ï¼Œæˆ‘ä»¬é€šè¿‡åŠ è½½etcdä¸­å±äºå½“å‰èŠ‚ç‚¹çš„èµ„æºè·å–äº†å…¨é‡çš„çˆ¬è™«ä»»åŠ¡ã€‚æˆ‘ä»¬è¿˜å¯åŠ¨äº†å¯¹etcdèµ„æºçš„ç›‘å¬ï¼Œå®ç°äº†èµ„æºçš„åŠ¨æ€æ·»åŠ å’Œåˆ é™¤ã€‚è‡³æ­¤ï¼ŒMasterä¸Workerçš„æ ¸å¿ƒåŠŸèƒ½ä¸äº¤äº’éƒ½å·²ç»èƒ½å¤Ÿæ­£å¸¸å·¥ä½œäº†ã€‚</p><h2>è¯¾åé¢˜</h2><p>æœ€åï¼Œè¿˜æ˜¯ç»™ä½ ç•™ä¸€é“æ€è€ƒé¢˜ã€‚</p><p>åœ¨æˆ‘ä»¬çš„è®¾è®¡ä¸­ï¼Œé»˜è®¤ä¸€ä¸ªçˆ¬è™«ä»»åŠ¡æ˜¯ä¸èƒ½å¤Ÿè¢«æ·»åŠ å¤šæ¬¡çš„ã€‚é‚£æœ‰æ²¡æœ‰ä¸€ç§åœºæ™¯ï¼Œå¯ä»¥è®©åŒä¸€ä¸ªçˆ¬è™«ä»»åŠ¡æ·»åŠ å¤šæ¬¡ï¼Œä¹Ÿå°±æ˜¯è®©å¤šä¸ªWorkerå¯ä»¥åŒæ—¶æ‰§è¡ŒåŒä¸€ä¸ªçˆ¬è™«ä»»åŠ¡å‘¢? å¦‚æœæœ‰è¿™æ ·çš„åœºæ™¯ï¼Œæˆ‘ä»¬åº”è¯¥å¦‚ä½•ä¿®æ”¹è®¾è®¡ï¼Ÿ</p><p>æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºä¸æˆ‘äº¤æµè®¨è®ºï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼</p>","comments":[{"had_liked":false,"id":368906,"user_name":"Geek_crazydaddy","can_delete":false,"product_type":"c1","uid":2663289,"ip_address":"æ±Ÿè‹","ucode":"11A6FF71825CA7","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEIqvYMQ1yscgB6xS4nDkoOuP6KiaCiaichQA1OiaQ9rFmNtT9icgrZxeH1WRn5HfiaibDguj8e0lBpo65ricA/132","comment_is_top":false,"comment_ctime":1676882755,"is_pvip":false,"replies":null,"discussion_count":2,"race_medal":0,"score":2,"product_id":100124001,"comment_content":"watchResourceé‡Œè·å–å’Œåˆ é™¤ä»»åŠ¡æ—¶ä¸ºå•¥éƒ½ä¸åˆ¤æ–­ä»»åŠ¡æ˜¯ä¸æ˜¯åˆ†é…ç»™å½“å‰workeräº†ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1393764,"avatar":"https://static001.geekbang.org/account/avatar/00/15/44/64/3380fc05.jpg","nickname":"Ares","note":"","ucode":"5E8D4387D35911","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":648403,"discussion_content":"æˆ‘ä¹Ÿæœ‰è¿™ä¸ªç–‘é—®ğŸ¤” @éƒ‘è€å¸ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1721544784,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2908917,"avatar":"https://static001.geekbang.org/account/avatar/00/2c/62/f5/339046cd.jpg","nickname":"å—¨äº†","note":"","ucode":"72AECB49813E7F","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":627227,"discussion_content":"æˆ‘ä¹Ÿè§‰å¾— @ä½œè€…","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1693903061,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":367962,"user_name":"Realm","can_delete":false,"product_type":"c1","uid":1081299,"ip_address":"æµ™æ±Ÿ","ucode":"30CBEBE619D1A2","user_header":"https://static001.geekbang.org/account/avatar/00/10/7f/d3/b5896293.jpg","comment_is_top":false,"comment_ctime":1675768199,"is_pvip":true,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100124001,"comment_content":"followèŠ‚ç‚¹åœ¨æ”¶åˆ°èµ„æºå˜æ›´è¯·æ±‚ï¼Œå½“è¯·æ±‚åˆ°è¾¾grpcæœåŠ¡å±‚æ—¶ï¼Œé€šè¿‡æ³¨å…¥è¿›æ¥çš„master grpc clientï¼Œå‘masterå‘èµ·è¯·æ±‚ï¼Œå‚æ•°ä¸å˜ï¼Œå®ç°äº†è½¬å‘åŠŸèƒ½ï¼Œè¿™ä¸ªè®¾è®¡å¾ˆèµï¼ğŸ‘","like_count":0}]}