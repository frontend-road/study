{"id":543912,"title":"59｜RESTful Web Services（23）：如何构造测试数据？","content":"<p>你好，我是徐昊。今天我们继续使用TDD的方式实现RESTful Web Services。</p><h2>回顾架构愿景与任务列表</h2><p>目前我们已经实现了ResourceRouter，和UriTemplate整体的架构愿景如下：</p><p><img src=\"https://static001.geekbang.org/resource/image/59/24/59ee2d534a4ae87623a736157e848924.jpg?wh=2284x1285\" alt=\"\"><br>\n<img src=\"https://static001.geekbang.org/resource/image/2e/a4/2ef7e84ba450b36d1df67cfce9e61da4.jpg?wh=2284x1285\" alt=\"\"></p><p>目前的任务列表：</p><ul>\n<li>Resource/RootResource/ResourceMethod\n<ul>\n<li>\n<p><s>从Path标注中获取UriTemplate</s></p>\n<ul>\n<li>如不存在Path标注，则抛出异常</li>\n</ul>\n</li>\n<li>\n<p><s>在处理请求派分时，可以根据客户端提供的Http方法，选择对应的资源方法</s></p>\n<ul>\n<li><s>当请求与资源方法的Uri模版一致，且Http方法一致时，派分到该方法</s></li>\n<li><s>没有资源方法于请求的Uri和Http方法一致时，返回404</s></li>\n</ul>\n</li>\n<li>\n<p>在处理请求派分时，可以支持多级子资源</p>\n<ul>\n<li>当没有资源方法可以匹配请求时，选择最优匹配SubResourceLocater，通过它继续进行派分</li>\n<li>如果SubResourceLocator也无法找到满足的请求时，返回404</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul><p>代码为：</p><pre><code>class RootResourceClass implements ResourceRouter.RootResource {\n    private PathTemplate uriTemplate;\n    private Class&lt;?&gt; resourceClass;\n    private Map&lt;String, List&lt;ResourceRouter.ResourceMethod&gt;&gt; resourceMethods;\n    public RootResourceClass(Class&lt;?&gt; resourceClass) {\n        this.resourceClass = resourceClass;\n        this.uriTemplate = new PathTemplate(resourceClass.getAnnotation(Path.class).value());\n        this.resourceMethods = Arrays.stream(resourceClass.getMethods()).filter(m -&gt; Arrays.stream(m.getAnnotations())\n                        .anyMatch(a -&gt; a.annotationType().isAnnotationPresent(HttpMethod.class)))\n                .map(DefaultResourceMethod::new)\n                .collect(Collectors.groupingBy(ResourceRouter.ResourceMethod::getHttpMethod));\n    }\n    @Override\n    public Optional&lt;ResourceRouter.ResourceMethod&gt; match(UriTemplate.MatchResult result, String method, String[] mediaTypes, UriInfoBuilder builder) {\n        String remaining = Optional.ofNullable(result.getRemaining()).orElse(&quot;&quot;);\n        return Optional.ofNullable(resourceMethods.get(method)).flatMap(methods -&gt; methods.stream().map(m -&gt; match(remaining, m)).filter(Result::isMatched).sorted()\n                .findFirst().map(Result::resourceMethod));\n    }\n    @Override\n    public UriTemplate getUriTemplate() {\n        return uriTemplate;\n    }\n    private Result match(String path, ResourceRouter.ResourceMethod method) {\n        return new Result(method.getUriTemplate().match(path), method);\n    }\n    record Result(Optional&lt;UriTemplate.MatchResult&gt; matched,\n                  ResourceRouter.ResourceMethod resourceMethod) implements Comparable&lt;Result&gt; {\n        public boolean isMatched() {\n            return matched.map(r -&gt; r.getRemaining() == null).orElse(false);\n        }\n        @Override\n        public int compareTo(Result o) {\n            return matched.flatMap(x -&gt; o.matched.map(x::compareTo)).orElse(0);\n        }\n    }\n    static class DefaultResourceMethod implements ResourceRouter.ResourceMethod {\n        private String httpMethod;\n        private UriTemplate uriTemplate;\n        private Method method;\n        public DefaultResourceMethod(Method method) {\n            this.method = method;\n            this.uriTemplate = new PathTemplate(Optional.ofNullable(method.getAnnotation(Path.class)).map(Path::value).orElse(&quot;&quot;));\n            this.httpMethod = Arrays.stream(method.getAnnotations()).filter(a -&gt; a.annotationType().isAnnotationPresent(HttpMethod.class))\n                    .findFirst().get().annotationType().getAnnotation(HttpMethod.class).value();\n        }\n        @Override\n        public String getHttpMethod() {\n            return httpMethod;\n        }\n        @Override\n        public UriTemplate getUriTemplate() {\n            return uriTemplate;\n        }\n        @Override\n        public GenericEntity&lt;?&gt; call(ResourceContext resourceContext, UriInfoBuilder builder) {\n            return null;\n        }\n        @Override\n        public String toString() {\n            return method.getDeclaringClass().getSimpleName() + &quot;.&quot; + method.getName();\n        }\n    }\n}\n</code></pre><h2>视频演示</h2><p>进入今天的环节：</p><p><video poster=\"https://media001.geekbang.org/9372355fc4cb4976a7521c80af647396/snapshots/c897bd7e363344ad8beffa58fd08fb86-00005.jpg\" preload=\"none\" controls=\"\"><source src=\"https://media001.geekbang.org/customerTrans/7e27d07d27d407ebcc195a0e78395f55/1554dd4f-182f8bde6ec-0000-0000-01d-dbacd.mp4\" type=\"video/mp4\"><source src=\" https://media001.geekbang.org/cde75cfd756e47449f05dc81fff009a9/efd574d45de24e75b9d9861e8d931bc5-26bed3563559e52fd1e1c32db8686f31-sd.m3u8\" type=\"application/x-mpegURL\"></video></p><h2>思考题</h2><p>RootResource的测试要如何改造？</p><p>欢迎把你的想法分享在留言区，也欢迎把你的项目代码分享出来。相信经过你的思考与实操，学习效果会更好！</p><!-- [[[read_end]]] -->","neighbors":{"left":{"article_title":"58｜RESTful Web Services（22）：重构还是继续完成功能？","id":541083},"right":{"article_title":"60｜RESTful Web Services（24）：RootResource的测试要如何改造？","id":543931}},"comments":[{"had_liked":false,"id":353084,"user_name":"aoe","can_delete":false,"product_type":"c1","uid":1121758,"ip_address":"陕西","ucode":"1C6201EDB4E954","user_header":"https://static001.geekbang.org/account/avatar/00/11/1d/de/62bfa83f.jpg","comment_is_top":false,"comment_ctime":1659150567,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1659150567","product_id":100109401,"comment_content":"因为测试数据是一样的，可以将其打包成 Stream&lt;DynamicTest&gt;，简化测试","like_count":0}]}