{"id":88543,"title":"42 | 实现micro-kernel framework","content":"<h1>课件及源代码地址</h1><p><a href=\"https://gitee.com/geektime-geekbang/go_learning\">https://gitee.com/geektime-geekbang/go_learning</a></p><h2>书目推荐</h2><p><a href=\"time://mall?url=https%3A%2F%2Fh5.youzan.com%2Fv2%2Fgoods%2F1ycmk3uob0ryw\">《计算机程序的构造和解释》</a></p>","comments":[{"had_liked":false,"id":273263,"user_name":"小寞子。(≥3≤)","can_delete":false,"product_type":"c3","uid":1206545,"ip_address":"","ucode":"6D978BDCBB2862","user_header":"https://static001.geekbang.org/account/avatar/00/12/69/11/831cec7d.jpg","comment_is_top":false,"comment_ctime":1610517308,"is_pvip":false,"replies":[{"id":99526,"content":"这里的锁实际要保护的是 errs.CollectorErrors的读写。\n为了提高程序的性能，锁的范围要尽量小","user_name":"作者回复","user_name_real":"蔡超","uid":1008262,"ctime":1610891866,"ip_address":"","comment_id":273263,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"mutex.Lock() 应该在 err = collector.Start(ctx)之前吧 不然用啥锁。。","like_count":3,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":513544,"discussion_content":"这里的锁实际要保护的是 errs.CollectorErrors的读写。\n为了提高程序的性能，锁的范围要尽量小","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1610891866,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":303392,"user_name":"8849","can_delete":false,"product_type":"c3","uid":1422391,"ip_address":"","ucode":"5660F6039156A7","user_header":"https://static001.geekbang.org/account/avatar/00/15/b4/37/5d2a5288.jpg","comment_is_top":false,"comment_ctime":1626766831,"is_pvip":false,"replies":[{"id":110074,"content":"谢谢你的支持.","user_name":"作者回复","user_name_real":"蔡超","uid":1008262,"ctime":1627304989,"ip_address":"","comment_id":303392,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"老师什么时候出门架构师的课一定支持，哈哈哈","like_count":2,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":523657,"discussion_content":"谢谢你的支持.","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627304989,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":268330,"user_name":"5423","can_delete":false,"product_type":"c3","uid":2168005,"ip_address":"","ucode":"2667A1A39A6291","user_header":"https://static001.geekbang.org/account/avatar/00/21/14/c5/5ac20144.jpg","comment_is_top":false,"comment_ctime":1608138061,"is_pvip":false,"replies":[{"id":97497,"content":"是我们的软件设计，有一些可以参考的模式。","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1608340058,"ip_address":"","comment_id":268330,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"请问这个章节讲的是什么呢？没有太懂？是自己的程序套什么‘公式’吗？应该这样理解吗？概念上的？","like_count":2,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":511917,"discussion_content":"是我们的软件设计，有一些可以参考的模式。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608340058,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":84737,"user_name":"Coder4","can_delete":false,"product_type":"c3","uid":1048453,"ip_address":"","ucode":"71DAC6B3D112DB","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJcvQzf86HsxOkPcRpibBdCxDW0IK9wel9TmkEhicHPUHPRhzKna8wecDcJcVbNHNSrUMt4GHLxY3iaA/132","comment_is_top":false,"comment_ctime":1554900442,"is_pvip":false,"replies":[{"id":30504,"content":"依赖是通过接口的，不会有这个问题\n","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1554980975,"ip_address":"","comment_id":84737,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"老师。微内核模式，会有对象循环引用的问题么？","like_count":1,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":446434,"discussion_content":"依赖是通过接口的，不会有这个问题\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1554980975,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":323074,"user_name":"圆滚滚","can_delete":false,"product_type":"c3","uid":1351012,"ip_address":"","ucode":"E4D81822A87D50","user_header":"https://static001.geekbang.org/account/avatar/00/14/9d/64/272dc1b7.jpg","comment_is_top":false,"comment_ctime":1637720335,"is_pvip":false,"replies":[{"id":118043,"content":"Collect是接口","user_name":"作者回复","user_name_real":"编辑","uid":1008262,"ctime":1638882939,"ip_address":"","comment_id":323074,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"为什么RegisterCollector的入参中类型是Collector而不是*Collector, 传入Collector类型的变量,会造成对象拷贝么?","like_count":0,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":536865,"discussion_content":"Collect是接口","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638882939,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":272805,"user_name":"森美","can_delete":false,"product_type":"c3","uid":2297583,"ip_address":"","ucode":"1BBEC7540005D5","user_header":"https://static001.geekbang.org/account/avatar/00/23/0e/ef/011d7ea0.jpg","comment_is_top":false,"comment_ctime":1610290218,"is_pvip":false,"replies":[{"id":99528,"content":"看以下两端代码：\nfunc (agt *Agent) Start() error {\n\tif agt.state != Waiting {\n\t\treturn WrongStateError\n\t}\n\tagt.state = Running\n\tagt.ctx, agt.cancel = context.WithCancel(context.Background())\n\tgo agt.EventProcessGroutine()\n\treturn agt.startCollectors()\n}\n\nfunc (agt *Agent) startCollectors() error {\n\tvar err error\n\tvar errs CollectorsError\n\tvar mutex sync.Mutex\n\n\tfor name, collector := range agt.collectors {\n\t\tgo func(name string, collector Collector, ctx context.Context) {\n\t\t\tdefer func() {\n\t\t\t\tmutex.Unlock()\n\t\t\t}()\n\t\t\terr = collector.Start(ctx)\n\t\t\tmutex.Lock()\n\t\t\tif err != nil {\n\t\t\t\terrs.CollectorErrors = append(errs.CollectorErrors,\n\t\t\t\t\terrors.New(name+&quot;:&quot;+err.Error()))\n\t\t\t}\n\t\t}(name, collector, agt.ctx)\n\t}\n\tif len(errs.CollectorErrors) == 0 {\n\t\treturn nil\n\t}\n\treturn errs\n}","user_name":"作者回复","user_name_real":"蔡超","uid":1008262,"ctime":1610892479,"ip_address":"","comment_id":272805,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"老师，我看这个章节的源码里面，在测试代码agent_test.go这里，用于测试的DemoCollector有个属性是上下文agtCtx, 但观察测试代码的逻辑，我发现好像并没有哪里使用到这个上下文agtCtx。像Start方法里面，如果检测到上下文有发出cancel通知，那就结束任务，只不过这里的上下文是Agent的上下文，不是DemoCollector的上下文。","like_count":0,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":513394,"discussion_content":"看以下两端代码：\nfunc (agt *Agent) Start() error {\n\tif agt.state != Waiting {\n\t\treturn WrongStateError\n\t}\n\tagt.state = Running\n\tagt.ctx, agt.cancel = context.WithCancel(context.Background())\n\tgo agt.EventProcessGroutine()\n\treturn agt.startCollectors()\n}\n\nfunc (agt *Agent) startCollectors() error {\n\tvar err error\n\tvar errs CollectorsError\n\tvar mutex sync.Mutex\n\n\tfor name, collector := range agt.collectors {\n\t\tgo func(name string, collector Collector, ctx context.Context) {\n\t\t\tdefer func() {\n\t\t\t\tmutex.Unlock()\n\t\t\t}()\n\t\t\terr = collector.Start(ctx)\n\t\t\tmutex.Lock()\n\t\t\tif err != nil {\n\t\t\t\terrs.CollectorErrors = append(errs.CollectorErrors,\n\t\t\t\t\terrors.New(name+&amp;quot;:&amp;quot;+err.Error()))\n\t\t\t}\n\t\t}(name, collector, agt.ctx)\n\t}\n\tif len(errs.CollectorErrors) == 0 {\n\t\treturn nil\n\t}\n\treturn errs\n}","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1610892479,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1020525,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/92/6d/becd841a.jpg","nickname":"escray","note":"","ucode":"1F4204930E47C4","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":366903,"discussion_content":"确实没有用到，我的 IDE 有提示，VS Code","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618214271,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2297583,"avatar":"https://static001.geekbang.org/account/avatar/00/23/0e/ef/011d7ea0.jpg","nickname":"森美","note":"","ucode":"1BBEC7540005D5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":343025,"discussion_content":"老师我又仔细看了遍代码，发现结构体DemoCollector的属性agtCtx确实没有被用到呀。不论是在初始化它的时候，还是在真正的Agent里面调用startCollectors方法的时候，每开启一个协程，都会将Agent自身的上下文通过值传递的方式传给DemoCollector实例.....","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1610930098,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":212932,"user_name":"光","can_delete":false,"product_type":"c3","uid":1447871,"ip_address":"","ucode":"A52F6E3F18EA4B","user_header":"https://static001.geekbang.org/account/avatar/00/16/17/bf/f35bdd6e.jpg","comment_is_top":false,"comment_ctime":1588239637,"is_pvip":false,"replies":[{"id":81852,"content":"那样是可以的。但是程序就无法管理这个停止过程中Agent产生的错误了","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1590669232,"ip_address":"","comment_id":212932,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"请问下这里为什么要用一个stopChan来给stop()传递停止的指令呢？stop()里面是否可以直接用&lt;-c.evtReceiver.ctx.Done()?","like_count":0,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493650,"discussion_content":"那样是可以的。但是程序就无法管理这个停止过程中Agent产生的错误了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590669232,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":186392,"user_name":"forrestsun","can_delete":false,"product_type":"c3","uid":1013306,"ip_address":"","ucode":"940B84D46882A2","user_header":"https://static001.geekbang.org/account/avatar/00/0f/76/3a/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1583834343,"is_pvip":false,"replies":[{"id":72385,"content":"很好的发现。这个是因为Agent.Start()返回时，没有等待Collector的start过程结束。所以，要修正这个问题，只要同步一下就可以。\nfunc (agt *Agent) startCollectors() error {\n\tvar err error\n\tvar errs CollectorsError\n\tvar mutex sync.Mutex\n\tvar wg sync.WaitGroup\n\tfor name, collector := range agt.collectors {\n\t\twg.Add(1)\n\t\tgo func(name string, collector Collector, ctx context.Context) {\n\t\t\tdefer func() {\n\t\t\t\tmutex.Unlock()\n\t\t\t}()\n\t\t\terr = collector.Start(ctx)\n\t\t\tmutex.Lock()\n\t\t\tif err != nil {\n\t\t\t\terrs.CollectorErrors = append(errs.CollectorErrors,\n\t\t\t\t\terrors.New(name+&quot;:&quot;+err.Error()))\n\t\t\t}\n\t\t\twg.Done()\n\t\t}(name, collector, agt.ctx)\n\t}\n\twg.Wait()\n\treturn errs\n}","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1584177253,"ip_address":"","comment_id":186392,"utype":1}],"discussion_count":4,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"老师您好，startCollectors 函数对子协程中的返回的错误判断不到。\nif len(errs.CollectorErrors) == 0 {\nreturn nil\n}\n","like_count":0,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":486736,"discussion_content":"很好的发现。这个是因为Agent.Start()返回时，没有等待Collector的start过程结束。所以，要修正这个问题，只要同步一下就可以。\nfunc (agt *Agent) startCollectors() error {\n\tvar err error\n\tvar errs CollectorsError\n\tvar mutex sync.Mutex\n\tvar wg sync.WaitGroup\n\tfor name, collector := range agt.collectors {\n\t\twg.Add(1)\n\t\tgo func(name string, collector Collector, ctx context.Context) {\n\t\t\tdefer func() {\n\t\t\t\tmutex.Unlock()\n\t\t\t}()\n\t\t\terr = collector.Start(ctx)\n\t\t\tmutex.Lock()\n\t\t\tif err != nil {\n\t\t\t\terrs.CollectorErrors = append(errs.CollectorErrors,\n\t\t\t\t\terrors.New(name+&amp;quot;:&amp;quot;+err.Error()))\n\t\t\t}\n\t\t\twg.Done()\n\t\t}(name, collector, agt.ctx)\n\t}\n\twg.Wait()\n\treturn errs\n}","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584177253,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1020525,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/92/6d/becd841a.jpg","nickname":"escray","note":"","ucode":"1F4204930E47C4","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":366900,"discussion_content":"按老师的这段代码，改完之后会停不下来……","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618213997,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2005222,"avatar":"","nickname":"Geek_120488","note":"","ucode":"234FA68074C133","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":273634,"discussion_content":"这样改也会有问题，因为collector.Start()并非开了一个新协程，这里会被阻塞导致wg.Done()永远执行不到，最终导致wg.Wait()执行不到startCollectors一直被阻塞","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590481589,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1182219,"avatar":"https://static001.geekbang.org/account/avatar/00/12/0a/0b/985d3800.jpg","nickname":"郭星","note":"","ucode":"8A0F5DF80E0C61","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2005222,"avatar":"","nickname":"Geek_120488","note":"","ucode":"234FA68074C133","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":293284,"discussion_content":"可以通过start 和 stop 多协程的模式,如果在同一个协程内,wg.Wait会一直阻塞","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595498455,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":273634,"ip_address":"","group_id":0},"score":293284,"extra":""}]}]},{"had_liked":false,"id":180924,"user_name":"Geek_tgq","can_delete":false,"product_type":"c3","uid":1522000,"ip_address":"","ucode":"CA1F4AA5F2D8D6","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/pV7g6NclSVCnQFX3EyQLsI0BtopYGIjmvBFSB3pXiawdxKOFn0Zhvb2l5UEGjukVAkll83amjOyM9RZK8wU191A/132","comment_is_top":false,"comment_ctime":1582444648,"is_pvip":false,"replies":[{"id":71764,"content":"因为Collector工作在不同的协程中，所以访问CollectorErrors（[] error）添加错误时，需要通过同步量（mutex）来实现线程安全。","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1583673053,"ip_address":"","comment_id":180924,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"老师，您好，这课中有一个地方不是很理解。\nstartCollectors函数中mutex是要对errs.CollectorErrors这个slice进行加锁吗？感觉这里可以不加锁，加锁是为了什么？另外外层函数对子协程中的返回的错误判断不到。\nif len(errs.CollectorErrors) == 0 {\n\t\treturn nil\n\t}","like_count":0,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":484847,"discussion_content":"因为Collector工作在不同的协程中，所以访问CollectorErrors（[] error）添加错误时，需要通过同步量（mutex）来实现线程安全。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583673053,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":123206,"user_name":"Geek_007","can_delete":false,"product_type":"c3","uid":1467182,"ip_address":"","ucode":"C80107538EAA7F","user_header":"https://static001.geekbang.org/account/avatar/00/16/63/2e/e49116d1.jpg","comment_is_top":false,"comment_ctime":1565626184,"is_pvip":false,"replies":[{"id":45479,"content":"func (agt *Agent) startCollectors() error {\n\tvar err error\n\tvar errs CollectorsError\n\tvar mutex sync.Mutex\n\n\tfor name, collector := range agt.collectors {\n\t\tgo func(name string, collector Collector, ctx context.Context) {\n\t\t\tdefer func() {\n\t\t\t\tmutex.Unlock()\n\t\t\t}()\n\t\t\terr = collector.Start(ctx)\n\t\t\tmutex.Lock()\n\t\t\tif err != nil {\n\t\t\t\terrs.CollectorErrors = append(errs.CollectorErrors,\n\t\t\t\t\terrors.New(name+&quot;:&quot;+err.Error()))\n\t\t\t}\n\t\t}(name, collector, agt.ctx)\n\t}\n\tif len(errs.CollectorErrors) == 0 {\n\t\treturn nil\n\t}\n\treturn errs\n}\n在相关代码中添加：\nif len(errs.CollectorErrors) == 0 {\n\t\treturn nil\n\t}","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1565794875,"ip_address":"","comment_id":123206,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"老师 。\nif err = agt.Start();err != nil {\n\tgoto ERR\n}\n\n这样写会出错，因为err 就是 != nil 了。我试了好多次，都无法对start的返回值进行错误判断，\n似乎因为 Start() 的error 被CollectorsError 封装了一层的缘故，老师能给下 Start() 如何进行错误判断的方式吗？","like_count":0,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":462580,"discussion_content":"func (agt *Agent) startCollectors() error {\n\tvar err error\n\tvar errs CollectorsError\n\tvar mutex sync.Mutex\n\n\tfor name, collector := range agt.collectors {\n\t\tgo func(name string, collector Collector, ctx context.Context) {\n\t\t\tdefer func() {\n\t\t\t\tmutex.Unlock()\n\t\t\t}()\n\t\t\terr = collector.Start(ctx)\n\t\t\tmutex.Lock()\n\t\t\tif err != nil {\n\t\t\t\terrs.CollectorErrors = append(errs.CollectorErrors,\n\t\t\t\t\terrors.New(name+&amp;quot;:&amp;quot;+err.Error()))\n\t\t\t}\n\t\t}(name, collector, agt.ctx)\n\t}\n\tif len(errs.CollectorErrors) == 0 {\n\t\treturn nil\n\t}\n\treturn errs\n}\n在相关代码中添加：\nif len(errs.CollectorErrors) == 0 {\n\t\treturn nil\n\t}","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565794875,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1522000,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/pV7g6NclSVCnQFX3EyQLsI0BtopYGIjmvBFSB3pXiawdxKOFn0Zhvb2l5UEGjukVAkll83amjOyM9RZK8wU191A/132","nickname":"Geek_tgq","note":"","ucode":"CA1F4AA5F2D8D6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":182633,"discussion_content":"if len(errs.CollectorErrors) == 0 {\nreturn nil\n}\n老师，添加以上代码对子协程中返回的错误会收集不到。外层判断等不到子协程处理完并append.","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582443562,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":88030,"user_name":"小春","can_delete":false,"product_type":"c3","uid":1180678,"ip_address":"","ucode":"3175BFBE5EF04F","user_header":"https://static001.geekbang.org/account/avatar/00/12/04/06/73013b1a.jpg","comment_is_top":false,"comment_ctime":1555818733,"is_pvip":false,"replies":[{"id":31721,"content":"你的命令行是怎样的，是不是只是指定了agent_test.go，你在包含agent.go和agent_test.go的路径下直接运行以下命令，go test -v ","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1555900891,"ip_address":"","comment_id":88030,"utype":1}],"discussion_count":2,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"老师，您好，我在您提供的github地址中，下载并执行micro kernal部分代码时，会报如下错误，\n# command-line-arguments [command-line-arguments.test]\n.\\agent_test.go:12:14: undefined: EventReceiver\n","like_count":0,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":447689,"discussion_content":"你的命令行是怎样的，是不是只是指定了agent_test.go，你在包含agent.go和agent_test.go的路径下直接运行以下命令，go test -v ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1555900891,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1141406,"avatar":"https://static001.geekbang.org/account/avatar/00/11/6a/9e/37bcc853.jpg","nickname":"王掌柜","note":"","ucode":"70AD0DF9B261BD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":153999,"discussion_content":"代码拷贝出来新建一个项目运行","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580102645,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":93611,"user_name":"坤","can_delete":false,"product_type":"c3","uid":1010922,"ip_address":"","ucode":"74E6838226A405","user_header":"https://static001.geekbang.org/account/avatar/00/0f/6c/ea/ce9854a5.jpg","comment_is_top":false,"comment_ctime":1557536016,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"区块链项目EOS的C++ 实现就是用的这种模式，感兴趣的同学可以考虑下其golang 实现。","like_count":4},{"had_liked":false,"id":211195,"user_name":"Geek_952t4a","can_delete":false,"product_type":"c3","uid":1109586,"ip_address":"","ucode":"B3F1FA2D833DC4","user_header":"https://static001.geekbang.org/account/avatar/00/10/ee/52/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1587912575,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"collector.Init(agt) 这里不是很理解，这里为什么可以直接传agt","like_count":1,"discussions":[{"author":{"id":1113733,"avatar":"https://static001.geekbang.org/account/avatar/00/10/fe/85/9ab352a7.jpg","nickname":"iMARS","note":"","ucode":"10C5C31908AA09","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":327165,"discussion_content":"因为实现了init方法所需要的接口成员","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605757364,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":322286,"user_name":"Rootrl","can_delete":false,"product_type":"c3","uid":1035390,"ip_address":"","ucode":"50FE3BBA92D417","user_header":"https://static001.geekbang.org/account/avatar/00/0f/cc/7e/0d050964.jpg","comment_is_top":false,"comment_ctime":1637289838,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"命令行运行：go test -v agent.go agent_test.go","like_count":0},{"had_liked":false,"id":287907,"user_name":"escray","can_delete":false,"product_type":"c3","uid":1020525,"ip_address":"","ucode":"1F4204930E47C4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/92/6d/becd841a.jpg","comment_is_top":false,"comment_ctime":1618214185,"is_pvip":true,"replies":null,"discussion_count":1,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"老师在代码里面写了好几个 destory，搞得我也快不认识 destroy 了，最后还查了字典。之前写 Ruby 代码的时候，就经常手滑写错。\n\n微内核，大部分 IDE 都是微内核模式，比如 VS Code 通过增加 Go 插件，增加对 Go 语言的处理。\n\n（IDE）进程内的 plugin 发生错误的时候，微内核模式也可以很好的隔离错误，不影响其他的 plugin，也不会影响内核进程。\n\n（IDE）保持架构一致性，通过插件支持不同的语言\n\n抄代码，这可能是单个文件代码行数最多的。\n\n这节课感觉难度是比较大的，看了好几遍代码，还是有些地方没有搞清楚，比如按照老师的回复，添加了 WaitGroup，结果代码停不下来了……原因可能是 wg.Done() 没有被执行到。","like_count":0,"discussions":[{"author":{"id":1603004,"avatar":"https://static001.geekbang.org/account/avatar/00/18/75/bc/89d88775.jpg","nickname":"Calvin","note":"","ucode":"0EEF5B207623B5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":381974,"discussion_content":"是的，加了之后，agent 的 startCollectors() 方法 的 err = collector.Start(ctx) 这句会一直在死循环执行而不返回，永远不会 Done，所以 wg.Wait() 也就执行不到了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625326535,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":105140,"user_name":"月夜风","can_delete":false,"product_type":"c3","uid":1239356,"ip_address":"","ucode":"097A259DAAB9AE","user_header":"https://static001.geekbang.org/account/avatar/00/12/e9/3c/1cd0a8dc.jpg","comment_is_top":false,"comment_ctime":1560928413,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"这节课信息量真大.. 从上节课开始 不从github上下代码 很难直接跟得上课程节奏了","like_count":0,"discussions":[{"author":{"id":1351012,"avatar":"https://static001.geekbang.org/account/avatar/00/14/9d/64/272dc1b7.jpg","nickname":"圆滚滚","note":"","ucode":"E4D81822A87D50","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":532851,"discussion_content":"是的,课程需要暂停一下,把代码写出来,才能跟上,写代码的时候还是有一些收获的,会有一些疑问出现","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637720395,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"user_type\":1}","child_discussion_number":0,"child_discussions":[]}]}]}