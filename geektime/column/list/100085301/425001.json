{"id":425001,"title":"21ï½œé˜¶æ®µå®æ“ï¼ˆ1ï¼‰ï¼šæ„å»ºä¸€ä¸ªç®€å•çš„KV server-åŸºæœ¬æµç¨‹","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯é™ˆå¤©ã€‚</p><p>ä»ç¬¬ä¸ƒè®²å¼€å§‹ï¼Œæˆ‘ä»¬ä¸€è·¯è¿‡å…³æ–©å°†ï¼Œå’Œæ‰€æœ‰æƒã€ç”Ÿå‘½å‘¨æœŸæ­»ç£•ï¼Œè·Ÿç±»å‹ç³»ç»Ÿå’Œ trait åå¤æ‹‰é”¯ï¼Œä¸ºçš„æ˜¯å•¥ï¼Ÿå°±æ˜¯ä¸ºäº†èƒ½å¤Ÿè¯»æ‡‚åˆ«äººå†™çš„ä»£ç ï¼Œè¿›è€Œè®©è‡ªå·±ä¹Ÿèƒ½å†™å‡ºè¶Šæ¥è¶Šå¤æ‚ä¸”ä¼˜é›…çš„ä»£ç ã€‚</p><p>ä»Šå¤©å°±åˆ°æ£€éªŒè‡ªèº«å®åŠ›çš„æ—¶å€™äº†ï¼Œæ¯•ç«Ÿtalk is cheapï¼ŒçŸ¥è¯†ç‚¹æŒæ¡å¾—å†å¤šï¼Œè‡ªå·±å†™ä¸å‡ºæ¥ä¹Ÿç™½æ­ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠä¹‹å‰å­¦çš„çŸ¥è¯†éƒ½è¿ç”¨èµ·æ¥ï¼Œä¸€èµ·å†™ä¸ªç®€å•çš„ KV serverã€‚</p><p>ä¸è¿‡è¿™æ¬¡å’Œ get hands dirty é‡æ„Ÿæ€§ä½“éªŒçš„ä»£ç ä¸åŒï¼Œæˆ‘ä¼šå¸¦ä½ ä¸€æ­¥æ­¥çœŸå®æ‰“ç£¨ï¼Œè®²å¾—æ¯”è¾ƒç»†è‡´ï¼Œæ‰€ä»¥å†…å®¹ä¹Ÿä¼šæ¯”è¾ƒå¤šï¼Œæˆ‘åˆ†æˆäº†ä¸Šä¸‹ä¸¤ç¯‡æ–‡ç« ï¼Œå¸Œæœ›ä½ èƒ½è€å¿ƒçœ‹å®Œï¼Œè®¤çœŸæ„Ÿå— Rust best practice åœ¨æ¶æ„è®¾è®¡ä»¥åŠä»£ç å®ç°æ€è·¯ä¸Šçš„ä½“ç°ã€‚</p><p>ä¸ºä»€ä¹ˆé€‰ KV server æ¥å®æ“å‘¢ï¼Ÿå› ä¸ºå®ƒæ˜¯ä¸€ä¸ª<strong>è¶³å¤Ÿç®€å•åˆè¶³å¤Ÿå¤æ‚</strong>çš„æœåŠ¡ã€‚å‚è€ƒå·¥ä½œä¸­ç”¨åˆ°çš„ Redis / Memcached ç­‰æœåŠ¡ï¼Œæ¥æ¢³ç†å®ƒçš„éœ€æ±‚ã€‚</p><ul>\n<li>æœ€æ ¸å¿ƒçš„åŠŸèƒ½æ˜¯æ ¹æ®ä¸åŒçš„å‘½ä»¤è¿›è¡Œè¯¸å¦‚æ•°æ®å­˜è´®ã€è¯»å–ã€ç›‘å¬ç­‰æ“ä½œï¼›</li>\n<li>è€Œå®¢æˆ·ç«¯è¦èƒ½é€šè¿‡ç½‘ç»œè®¿é—® KV serverï¼Œå‘é€åŒ…å«å‘½ä»¤çš„è¯·æ±‚ï¼Œå¾—åˆ°ç»“æœï¼›</li>\n<li>æ•°æ®è¦èƒ½æ ¹æ®éœ€è¦ï¼Œå­˜å‚¨åœ¨å†…å­˜ä¸­æˆ–è€…æŒä¹…åŒ–åˆ°ç£ç›˜ä¸Šã€‚</li>\n</ul><h2>å…ˆæ¥ä¸€ä¸ªçŸ­å¹³ç³™çš„å®ç°</h2><p>å¦‚æœæ˜¯ä¸ºäº†å®Œæˆä»»åŠ¡æ„å»º KV serverï¼Œå…¶å®æœ€åˆçš„ç‰ˆæœ¬ä¸¤ä¸‰ç™¾è¡Œä»£ç å°±å¯ä»¥æå®šï¼Œä½†æ˜¯è¿™æ ·çš„ä»£ç ä»¥åç»´æŠ¤èµ·æ¥å°±æ˜¯ç¾éš¾ã€‚</p><!-- [[[read_end]]] --><p>æˆ‘ä»¬çœ‹ä¸€ä¸ªçœå´äº†ä¸å°‘ç»†èŠ‚çš„æ„å¤§åˆ©é¢æ¡å¼çš„ç‰ˆæœ¬ï¼Œä½ å¯ä»¥éšç€æˆ‘çš„æ³¨é‡Šé‡ç‚¹çœ‹æµç¨‹ï¼š</p><pre><code class=\"language-rust\">use anyhow::Result;\nuse async_prost::AsyncProstStream;\nuse dashmap::DashMap;\nuse futures::prelude::*;\nuse kv::{\n    command_request::RequestData, CommandRequest, CommandResponse, Hset, KvError, Kvpair, Value,\n};\nuse std::sync::Arc;\nuse tokio::net::TcpListener;\nuse tracing::info;\n\n#[tokio::main]\nasync fn main() -&gt; Result&lt;()&gt; {\n    // åˆå§‹åŒ–æ—¥å¿—\n    tracing_subscriber::fmt::init();\n\n    let addr = \"127.0.0.1:9527\";\n    let listener = TcpListener::bind(addr).await?;\n    info!(\"Start listening on {}\", addr);\n\n    // ä½¿ç”¨ DashMap åˆ›å»ºæ”¾åœ¨å†…å­˜ä¸­çš„ kv store\n    let table: Arc&lt;DashMap&lt;String, Value&gt;&gt; = Arc::new(DashMap::new());\n\n    loop {\n        // å¾—åˆ°ä¸€ä¸ªå®¢æˆ·ç«¯è¯·æ±‚\n        let (stream, addr) = listener.accept().await?;\n        info!(\"Client {:?} connected\", addr);\n\n        // å¤åˆ¶ dbï¼Œè®©å®ƒåœ¨ tokio ä»»åŠ¡ä¸­å¯ä»¥ä½¿ç”¨\n        let db = table.clone();\n\n        // åˆ›å»ºä¸€ä¸ª tokio ä»»åŠ¡å¤„ç†è¿™ä¸ªå®¢æˆ·ç«¯\n        tokio::spawn(async move {\n            // ä½¿ç”¨ AsyncProstStream æ¥å¤„ç† TCP Frame\n            // Frame: ä¸¤å­—èŠ‚ frame é•¿åº¦ï¼Œåé¢æ˜¯ protobuf äºŒè¿›åˆ¶\n            let mut stream =\n                AsyncProstStream::&lt;_, CommandRequest, CommandResponse, _&gt;::from(stream).for_async();\n\n            // ä» stream é‡Œå–ä¸‹ä¸€ä¸ªæ¶ˆæ¯ï¼ˆæ‹¿å‡ºæ¥åå·²ç»è‡ªåŠ¨ decode äº†ï¼‰\n            while let Some(Ok(msg)) = stream.next().await {\n                info!(\"Got a new command: {:?}\", msg);\n                let resp: CommandResponse = match msg.request_data {\n                    // ä¸ºæ¼”ç¤ºæˆ‘ä»¬å°±å¤„ç† HSET\n                    Some(RequestData::Hset(cmd)) =&gt; hset(cmd, &amp;db),\n                    // å…¶å®ƒæš‚ä¸å¤„ç†\n                    _ =&gt; unimplemented!(),\n                };\n\n                info!(\"Got response: {:?}\", resp);\n                // æŠŠ CommandResponse å‘é€ç»™å®¢æˆ·ç«¯\n                stream.send(resp).await.unwrap();\n            }\n        });\n    }\n}\n\n// å¤„ç† hset å‘½ä»¤\nfn hset(cmd: Hset, db: &amp;DashMap&lt;String, Value&gt;) -&gt; CommandResponse {\n    match cmd.pair {\n        Some(Kvpair {\n            key,\n            value: Some(v),\n        }) =&gt; {\n            // å¾€ db é‡Œå†™å…¥\n            let old = db.insert(key, v).unwrap_or_default();\n            // æŠŠ value è½¬æ¢æˆ CommandResponse\n            old.into()\n        }\n        v =&gt; KvError::InvalidCommand(format!(\"hset: {:?}\", v)).into(),\n    }\n}\n</code></pre><p>è¿™æ®µä»£ç éå¸¸åœ°å¹³é“ºç›´å™ï¼Œä»è¾“å…¥åˆ°è¾“å‡ºï¼Œä¸€è¹´è€Œå°±ï¼Œå¦‚æœè¿™æ ·å†™ï¼Œä»»åŠ¡ç¡®å®èƒ½å¾ˆå¿«å®Œæˆï¼Œä½†æ˜¯å®ƒæœ‰ç§â€œå®Œæˆä¹‹åï¼Œå“ªç®¡æ´ªæ°´æ»”å¤©â€çš„æ„Ÿè§‰ã€‚</p><p>ä½ å¤åˆ¶ä»£ç åï¼Œæ‰“å¼€ä¸¤ä¸ªçª—å£ï¼Œåˆ†åˆ«è¿è¡Œ â€œcargo run --example naive_serverâ€ å’Œ â€œcargo run --example clientâ€ï¼Œå°±å¯ä»¥çœ‹åˆ°è¿è¡Œ server çš„çª—å£æœ‰å¦‚ä¸‹æ‰“å°ï¼š</p><pre><code class=\"language-bash\">Sep 19 22:25:34.016  INFO naive_server: Start listening on 127.0.0.1:9527\nSep 19 22:25:38.401  INFO naive_server: Client 127.0.0.1:51650 connected\nSep 19 22:25:38.401  INFO naive_server: Got a new command: CommandRequest { request_data: Some(Hset(Hset { table: \"table1\", pair: Some(Kvpair { key: \"hello\", value: Some(Value { value: Some(String(\"world\")) }) }) })) }\nSep 19 22:25:38.401  INFO naive_server: Got response: CommandResponse { status: 200, message: \"\", values: [Value { value: None }], pairs: [] }\n</code></pre><p>è™½ç„¶æ•´ä½“åŠŸèƒ½ç®—æ˜¯æå®šäº†ï¼Œä¸è¿‡ä»¥åæƒ³ç»§ç»­ä¸ºè¿™ä¸ª KV server å¢åŠ æ–°çš„åŠŸèƒ½ï¼Œå°±éœ€è¦æ¥æ¥å›å›æ”¹è¿™æ®µä»£ç ã€‚</p><p>æ­¤å¤–ï¼Œä¹Ÿä¸å¥½åšå•å…ƒæµ‹è¯•ï¼Œå› ä¸ºæ‰€æœ‰çš„é€»è¾‘éƒ½è¢«å‹ç¼©åœ¨ä¸€èµ·äº†ï¼Œæ²¡æœ‰â€œå•å…ƒâ€å¯è¨€ã€‚è™½ç„¶æœªæ¥å¯ä»¥é€æ­¥æŠŠä¸åŒçš„é€»è¾‘åˆ†ç¦»åˆ°ä¸åŒçš„å‡½æ•°ï¼Œä½¿ä¸»æµç¨‹å°½å¯èƒ½ç®€å•ä¸€äº›ã€‚ä½†æ˜¯ï¼Œå®ƒä»¬ä¾æ—§æ˜¯è€¦åˆåœ¨ä¸€èµ·çš„ï¼Œå¦‚æœä¸åšå¤§çš„é‡æ„ï¼Œè¿˜æ˜¯è§£å†³ä¸äº†å®è´¨çš„é—®é¢˜ã€‚</p><p>æ‰€ä»¥ä¸ç®¡ç”¨ä»€ä¹ˆè¯­è¨€å¼€å‘ï¼Œè¿™æ ·çš„ä»£ç éƒ½æ˜¯æˆ‘ä»¬è¦æåŠ›é¿å…çš„ï¼Œä¸å…‰è‡ªå·±ä¸è¦è¿™ä¹ˆå†™ï¼Œcode review é‡åˆ°åˆ«äººè¿™ä¹ˆå†™ä¹Ÿè¦ä¸¥æ ¼åœ°æªå‡ºæ¥ã€‚</p><h2>æ¶æ„å’Œè®¾è®¡</h2><p>é‚£ä¹ˆï¼Œæ€æ ·æ‰ç®—æ˜¯å¥½çš„å®ç°å‘¢ï¼Ÿ</p><p>å¥½çš„å®ç°åº”è¯¥æ˜¯åœ¨åˆ†æå®Œéœ€æ±‚åï¼Œé¦–å…ˆä»ç³»ç»Ÿçš„ä¸»æµç¨‹å¼€å§‹ï¼Œææ¸…æ¥šä»å®¢æˆ·ç«¯çš„è¯·æ±‚åˆ°æœ€ç»ˆå®¢æˆ·ç«¯æ”¶åˆ°å“åº”ï¼Œéƒ½ä¼šç»è¿‡å“ªäº›ä¸»è¦çš„æ­¥éª¤ï¼›ç„¶åæ ¹æ®è¿™äº›æ­¥éª¤ï¼Œæ€è€ƒå“ªäº›ä¸œè¥¿éœ€è¦å»¶è¿Ÿç»‘å®šï¼Œæ„å»ºä¸»è¦çš„æ¥å£å’Œ traitï¼›ç­‰è¿™äº›ä¸œè¥¿æ·±æ€ç†Ÿè™‘ä¹‹åï¼Œæœ€åå†è€ƒè™‘å®ç°ã€‚ä¹Ÿå°±æ˜¯æ‰€è°“çš„â€œè°‹å®šè€ŒååŠ¨â€ã€‚</p><p>å¼€å¤´å·²ç»åˆ†æ KV server è¿™ä¸ªéœ€æ±‚ï¼Œç°åœ¨æˆ‘ä»¬æ¥æ¢³ç†ä¸»æµç¨‹ã€‚ä½ å¯ä»¥å…ˆè‡ªå·±æƒ³æƒ³ï¼Œå†å‚è€ƒç¤ºæ„å›¾çœ‹çœ‹æœ‰æ²¡æœ‰ç¼ºæ¼ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/67/dc/67894066ecedd65897d5644f949b8cdc.jpg?wh=2617x1584\" alt=\"\"></p><p>è¿™ä¸ªæµç¨‹ä¸­æœ‰ä¸€äº›å…³é”®é—®é¢˜éœ€è¦è¿›ä¸€æ­¥æ¢ç´¢ï¼š</p><ol>\n<li>å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç”¨ä»€ä¹ˆåè®®é€šä¿¡ï¼ŸTCPï¼ŸgRPCï¼ŸHTTPï¼Ÿæ”¯æŒä¸€ç§è¿˜æ˜¯å¤šç§ï¼Ÿ</li>\n<li>å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´äº¤äº’çš„åº”ç”¨å±‚åè®®å¦‚ä½•å®šä¹‰ï¼Ÿæ€ä¹ˆåšåºåˆ—åŒ–/ååºåˆ—åŒ–ï¼Ÿæ˜¯ç”¨ Protobufã€JSON è¿˜æ˜¯ Redis RESPï¼Ÿæˆ–è€…ä¹Ÿå¯ä»¥æ”¯æŒå¤šç§ï¼Ÿ</li>\n<li>æœåŠ¡å™¨éƒ½æ”¯æŒå“ªäº›å‘½ä»¤ï¼Ÿç¬¬ä¸€ç‰ˆä¼˜å…ˆæ”¯æŒå“ªäº›ï¼Ÿ</li>\n<li>å…·ä½“çš„å¤„ç†é€»è¾‘ä¸­ï¼Œéœ€ä¸éœ€è¦åŠ  hookï¼Œåœ¨å¤„ç†è¿‡ç¨‹ä¸­å‘å¸ƒä¸€äº›äº‹ä»¶ï¼Œè®©å…¶ä»–æµç¨‹å¯ä»¥å¾—åˆ°é€šçŸ¥ï¼Œè¿›è¡Œé¢å¤–çš„å¤„ç†ï¼Ÿè¿™äº› hook å¯ä¸å¯ä»¥æå‰ç»ˆæ­¢æ•´ä¸ªæµç¨‹çš„å¤„ç†ï¼Ÿ</li>\n<li>å¯¹äºå­˜å‚¨ï¼Œè¦æ”¯æŒä¸åŒçš„å­˜å‚¨å¼•æ“ä¹ˆï¼Ÿæ¯”å¦‚ MemDBï¼ˆå†…å­˜ï¼‰ã€RocksDBï¼ˆç£ç›˜ï¼‰ã€SledDBï¼ˆç£ç›˜ï¼‰ç­‰ã€‚å¯¹äº MemDBï¼Œæˆ‘ä»¬è€ƒè™‘æ”¯æŒ WALï¼ˆWrite-Ahead Logï¼‰ å’Œ snapshot ä¹ˆï¼Ÿ</li>\n<li>æ•´ä¸ªç³»ç»Ÿå¯ä»¥é…ç½®ä¹ˆï¼Ÿæ¯”å¦‚æœåŠ¡ä½¿ç”¨å“ªä¸ªç«¯å£ã€å“ªä¸ªå­˜å‚¨å¼•æ“ï¼Ÿ</li>\n<li>â€¦</li>\n</ol><p><strong>å¦‚æœä½ æƒ³åšå¥½æ¶æ„ï¼Œé‚£ä¹ˆï¼Œé—®å‡ºè¿™äº›é—®é¢˜ï¼Œå¹¶ä¸”æ‰¾åˆ°è¿™äº›é—®é¢˜çš„ç­”æ¡ˆå°±å¾ˆé‡è¦</strong>ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œé¢å¾ˆå¤šé—®é¢˜äº§å“ç»ç†å¹¶ä¸èƒ½å¸®ä½ å›ç­”ï¼Œæˆ–è€…TAçš„å›ç­”ä¼šå°†ä½ å¸¦å…¥æ­§è·¯ã€‚ä½œä¸ºä¸€ä¸ªæ¶æ„å¸ˆï¼Œæˆ‘ä»¬éœ€è¦å¯¹ç³»ç»Ÿæœªæ¥å¦‚ä½•åº”å¯¹å˜åŒ–è´Ÿè´£ã€‚</p><p>ä¸‹é¢æ˜¯æˆ‘çš„æ€è€ƒï¼Œä½ å¯ä»¥å‚è€ƒï¼š</p><p>1.åƒ KV server è¿™æ ·éœ€è¦é«˜æ€§èƒ½çš„åœºæ™¯ï¼Œé€šä¿¡åº”è¯¥ä¼˜å…ˆè€ƒè™‘ TCP åè®®ã€‚æ‰€ä»¥æˆ‘ä»¬æš‚æ—¶åªæ”¯æŒ TCPï¼Œæœªæ¥å¯ä»¥æ ¹æ®éœ€è¦æ”¯æŒæ›´å¤šçš„åè®®ï¼Œå¦‚ HTTP2/gRPCã€‚è¿˜æœ‰ï¼Œæœªæ¥å¯èƒ½å¯¹å®‰å…¨æ€§æœ‰é¢å¤–çš„è¦æ±‚ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ä¿è¯ TLS è¿™æ ·çš„å®‰å…¨åè®®å¯ä»¥å³æ’å³ç”¨ã€‚æ€»ä¹‹ï¼Œ<strong>ç½‘ç»œå±‚éœ€è¦çµæ´»</strong>ã€‚</p><p>2.åº”ç”¨å±‚åè®®æˆ‘ä»¬å¯ä»¥ç”¨ protobuf å®šä¹‰ã€‚protobuf ç›´æ¥è§£å†³äº†åè®®çš„å®šä¹‰ä»¥åŠå¦‚ä½•åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚Redis çš„ <a href=\"https://redis.io/topics/protocol\">RESP</a> å›ºç„¶ä¸é”™ï¼Œä½†å®ƒçš„çŸ­æ¿ä¹Ÿæ˜¾è€Œæ˜“è§ï¼Œå‘½ä»¤éœ€è¦é¢å¤–çš„è§£æï¼Œè€Œä¸”å¤§é‡çš„ \\r\\n æ¥åˆ†éš”å‘½ä»¤æˆ–è€…æ•°æ®ï¼Œä¹Ÿæœ‰äº›æµªè´¹å¸¦å®½ã€‚ä½¿ç”¨ JSON çš„è¯æ›´åŠ æµªè´¹å¸¦å®½ï¼Œä¸” JSON çš„è§£ææ•ˆç‡ä¸é«˜ï¼Œå°¤å…¶æ˜¯æ•°æ®é‡å¾ˆå¤§çš„æ—¶å€™ã€‚</p><p>protobuf å°±å¾ˆé€‚åˆ KV server è¿™æ ·çš„åœºæ™¯ï¼Œçµæ´»ã€å¯å‘åå…¼å®¹å¼å‡çº§ã€è§£ææ•ˆç‡å¾ˆé«˜ã€ç”Ÿæˆçš„äºŒè¿›åˆ¶éå¸¸çœå¸¦å®½ï¼Œå”¯ä¸€çš„ç¼ºç‚¹æ˜¯éœ€è¦é¢å¤–çš„å·¥å…· protoc æ¥ç¼–è¯‘æˆä¸åŒçš„è¯­è¨€ã€‚è™½ç„¶ protobuf æ˜¯é¦–é€‰ï¼Œä½†ä¹Ÿè®¸æœªæ¥ä¸ºäº†å’Œ Redis å®¢æˆ·ç«¯äº’é€šï¼Œè¿˜æ˜¯è¦æ”¯æŒ RESPã€‚</p><p>3.æœåŠ¡å™¨æ”¯æŒçš„å‘½ä»¤æˆ‘ä»¬å¯ä»¥å‚è€ƒ<a href=\"https://redis.io/commands\">Redis çš„å‘½ä»¤é›†</a>ã€‚ç¬¬ä¸€ç‰ˆå…ˆæ¥æ”¯æŒ <a href=\"https://redis.io/commands/hset\">HXXX å‘½ä»¤</a>ï¼Œæ¯”å¦‚ HSETã€HMSETã€HGETã€HMGET ç­‰ã€‚ä»å‘½ä»¤åˆ°å‘½ä»¤çš„å“åº”ï¼Œå¯ä»¥åšä¸ª trait æ¥æŠ½è±¡ã€‚</p><p>4.å¤„ç†æµç¨‹ä¸­è®¡åˆ’åŠ è¿™äº› hookï¼šæ”¶åˆ°å®¢æˆ·ç«¯çš„å‘½ä»¤å OnRequestReceivedã€å¤„ç†å®Œå®¢æˆ·ç«¯çš„å‘½ä»¤å OnRequestExecutedã€å‘é€å“åº”ä¹‹å‰ BeforeResponseSendã€å‘é€å“åº”ä¹‹å AfterResponseSendã€‚è¿™æ ·ï¼Œ<strong>å¤„ç†è¿‡ç¨‹ä¸­çš„ä¸»è¦æ­¥éª¤éƒ½æœ‰äº‹ä»¶æš´éœ²å‡ºå»ï¼Œè®©æˆ‘ä»¬çš„ KV server å¯ä»¥éå¸¸çµæ´»ï¼Œæ–¹ä¾¿è°ƒç”¨è€…åœ¨åˆå§‹åŒ–æœåŠ¡çš„æ—¶å€™æ³¨å…¥é¢å¤–çš„å¤„ç†é€»è¾‘</strong>ã€‚</p><p>5.å­˜å‚¨å¿…ç„¶éœ€è¦è¶³å¤Ÿçµæ´»ã€‚å¯ä»¥å¯¹å­˜å‚¨åšä¸ª trait æ¥æŠ½è±¡å…¶åŸºæœ¬çš„è¡Œä¸ºï¼Œä¸€å¼€å§‹å¯ä»¥å°±åªåš MemDBï¼Œæœªæ¥è‚¯å®šéœ€è¦æœ‰æ”¯æŒæŒä¹…åŒ–çš„å­˜å‚¨ã€‚</p><p>6.éœ€è¦æ”¯æŒé…ç½®ï¼Œä½†ä¼˜å…ˆçº§ä¸é«˜ã€‚ç­‰åŸºæœ¬æµç¨‹æå®šï¼Œä½¿ç”¨è¿‡ç¨‹ä¸­å‘ç°è¶³å¤Ÿçš„ç—›ç‚¹ï¼Œå°±å¯ä»¥è€ƒè™‘é…ç½®æ–‡ä»¶å¦‚ä½•å¤„ç†äº†ã€‚</p><p>å½“è¿™äº›é—®é¢˜éƒ½æ•²å®šä¸‹æ¥ï¼Œç³»ç»Ÿçš„åŸºæœ¬æ€è·¯å°±æœ‰äº†ã€‚æˆ‘ä»¬å¯ä»¥å…ˆæŠŠå‡ ä¸ªé‡è¦çš„æ¥å£å®šä¹‰å‡ºæ¥ï¼Œç„¶åä»”ç»†å®¡è§†è¿™äº›æ¥å£ã€‚</p><p>æœ€é‡è¦çš„å‡ ä¸ªæ¥å£å°±æ˜¯<strong>ä¸‰ä¸ªä¸»ä½“äº¤äº’çš„æ¥å£ï¼šå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çš„æ¥å£æˆ–è€…è¯´åè®®ã€æœåŠ¡å™¨å’Œå‘½ä»¤å¤„ç†æµç¨‹çš„æ¥å£ã€æœåŠ¡å™¨å’Œå­˜å‚¨çš„æ¥å£</strong>ã€‚</p><h3>å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨é—´çš„åè®®</h3><p>é¦–å…ˆæ˜¯å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„åè®®ã€‚æ¥è¯•ç€ç”¨ protobuf å®šä¹‰ä¸€ä¸‹æˆ‘ä»¬ç¬¬ä¸€ç‰ˆæ”¯æŒçš„å®¢æˆ·ç«¯å‘½ä»¤ï¼š</p><pre><code class=\"language-protobuf\">syntax = \"proto3\";\n\npackage abi;\n\n// æ¥è‡ªå®¢æˆ·ç«¯çš„å‘½ä»¤è¯·æ±‚\nmessage CommandRequest {\n  oneof request_data {\n    Hget hget = 1;\n    Hgetall hgetall = 2;\n    Hmget hmget = 3;\n    Hset hset = 4;\n    Hmset hmset = 5;\n    Hdel hdel = 6;\n    Hmdel hmdel = 7;\n    Hexist hexist = 8;\n    Hmexist hmexist = 9;\n  }\n}\n\n// æœåŠ¡å™¨çš„å“åº”\nmessage CommandResponse {\n  // çŠ¶æ€ç ï¼›å¤ç”¨ HTTP 2xx/4xx/5xx çŠ¶æ€ç \n  uint32 status = 1;\n  // å¦‚æœä¸æ˜¯ 2xxï¼Œmessage é‡ŒåŒ…å«è¯¦ç»†çš„ä¿¡æ¯\n  string message = 2;\n  // æˆåŠŸè¿”å›çš„ values\n  repeated Value values = 3;\n  // æˆåŠŸè¿”å›çš„ kv pairs\n  repeated Kvpair pairs = 4;\n}\n\n// ä» table ä¸­è·å–ä¸€ä¸ª keyï¼Œè¿”å› value\nmessage Hget {\n  string table = 1;\n  string key = 2;\n}\n\n// ä» table ä¸­è·å–æ‰€æœ‰çš„ Kvpair\nmessage Hgetall { string table = 1; }\n\n// ä» table ä¸­è·å–ä¸€ç»„ keyï¼Œè¿”å›å®ƒä»¬çš„ value\nmessage Hmget {\n  string table = 1;\n  repeated string keys = 2;\n}\n\n// è¿”å›çš„å€¼\nmessage Value {\n  oneof value {\n    string string = 1;\n    bytes binary = 2;\n    int64 integer = 3;\n    double float = 4;\n    bool bool = 5;\n  }\n}\n\n// è¿”å›çš„ kvpair\nmessage Kvpair {\n  string key = 1;\n  Value value = 2;\n}\n\n// å¾€ table é‡Œå­˜ä¸€ä¸ª kvpairï¼Œ\n// å¦‚æœ table ä¸å­˜åœ¨å°±åˆ›å»ºè¿™ä¸ª table\nmessage Hset {\n  string table = 1;\n  Kvpair pair = 2;\n}\n\n// å¾€ table ä¸­å­˜ä¸€ç»„ kvpairï¼Œ\n// å¦‚æœ table ä¸å­˜åœ¨å°±åˆ›å»ºè¿™ä¸ª table\nmessage Hmset {\n  string table = 1;\n  repeated Kvpair pairs = 2;\n}\n\n// ä» table ä¸­åˆ é™¤ä¸€ä¸ª keyï¼Œè¿”å›å®ƒä¹‹å‰çš„å€¼\nmessage Hdel {\n  string table = 1;\n  string key = 2;\n}\n\n// ä» table ä¸­åˆ é™¤ä¸€ç»„ keyï¼Œè¿”å›å®ƒä»¬ä¹‹å‰çš„å€¼\nmessage Hmdel {\n  string table = 1;\n  repeated string keys = 2;\n}\n\n// æŸ¥çœ‹ key æ˜¯å¦å­˜åœ¨\nmessage Hexist {\n  string table = 1;\n  string key = 2;\n}\n\n// æŸ¥çœ‹ä¸€ç»„ key æ˜¯å¦å­˜åœ¨\nmessage Hmexist {\n  string table = 1;\n  repeated string keys = 2;\n}\n</code></pre><p>é€šè¿‡ <a href=\"https://github.com/tokio-rs/prost\">prost</a>ï¼Œè¿™ä¸ª protobuf æ–‡ä»¶å¯ä»¥è¢«ç¼–è¯‘æˆ Rust ä»£ç ï¼ˆä¸»è¦æ˜¯ struct å’Œ enumï¼‰ï¼Œä¾›æˆ‘ä»¬ä½¿ç”¨ã€‚ä½ åº”è¯¥è¿˜è®°å¾—ï¼Œä¹‹å‰åœ¨<a href=\"https://time.geekbang.org/column/article/413634\">ç¬¬ 5 è®²</a>è°ˆåˆ° thumbor çš„å¼€å‘æ—¶ï¼Œå·²ç»è§è¯†åˆ°äº† prost å¤„ç† protobuf çš„æ–¹å¼äº†ã€‚</p><h3>CommandService trait</h3><p>å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨é—´çš„åè®®æ•²å®šä¹‹åï¼Œå°±è¦æ€è€ƒå¦‚ä½•å¤„ç†è¯·æ±‚çš„å‘½ä»¤ï¼Œè¿”å›å“åº”ã€‚</p><p>æˆ‘ä»¬ç›®å‰æ‰“ç®—æ”¯æŒ 9 ç§å‘½ä»¤ï¼Œæœªæ¥å¯èƒ½æ”¯æŒæ›´å¤šå‘½ä»¤ã€‚æ‰€ä»¥æœ€å¥½<strong>å®šä¹‰ä¸€ä¸ª trait æ¥ç»Ÿä¸€å¤„ç†æ‰€æœ‰çš„å‘½ä»¤ï¼Œè¿”å›å¤„ç†ç»“æœ</strong>ã€‚åœ¨å¤„ç†å‘½ä»¤çš„æ—¶å€™ï¼Œéœ€è¦å’Œå­˜å‚¨å‘ç”Ÿå…³ç³»ï¼Œè¿™æ ·æ‰èƒ½æ ¹æ®è¯·æ±‚ä¸­æºå¸¦çš„å‚æ•°è¯»å–æ•°æ®ï¼Œæˆ–è€…æŠŠè¯·æ±‚ä¸­çš„æ•°æ®å­˜å…¥å­˜å‚¨ç³»ç»Ÿä¸­ã€‚æ‰€ä»¥ï¼Œè¿™ä¸ª trait å¯ä»¥è¿™ä¹ˆå®šä¹‰ï¼š</p><pre><code class=\"language-rust\">/// å¯¹ Command çš„å¤„ç†çš„æŠ½è±¡\npub trait CommandService {\n    /// å¤„ç† Commandï¼Œè¿”å› Response\n    fn execute(self, store: &amp;impl Storage) -&gt; CommandResponse;\n}\n</code></pre><p>æœ‰äº†è¿™ä¸ª traitï¼Œå¹¶ä¸”æ¯ä¸€ä¸ªå‘½ä»¤éƒ½å®ç°äº†è¿™ä¸ª trait åï¼Œdispatch æ–¹æ³•å°±å¯ä»¥æ˜¯ç±»ä¼¼è¿™æ ·çš„ä»£ç ï¼š</p><pre><code class=\"language-rust\">// ä» Request ä¸­å¾—åˆ° Responseï¼Œç›®å‰å¤„ç† HGET/HGETALL/HSET\npub fn dispatch(cmd: CommandRequest, store: &amp;impl Storage) -&gt; CommandResponse {\n    match cmd.request_data {\n        Some(RequestData::Hget(param)) =&gt; param.execute(store),\n        Some(RequestData::Hgetall(param)) =&gt; param.execute(store),\n        Some(RequestData::Hset(param)) =&gt; param.execute(store),\n        None =&gt; KvError::InvalidCommand(\"Request has no data\".into()).into(),\n        _ =&gt; KvError::Internal(\"Not implemented\".into()).into(),\n    }\n}\n</code></pre><p>è¿™æ ·ï¼Œæœªæ¥æˆ‘ä»¬æ”¯æŒæ–°å‘½ä»¤æ—¶ï¼Œåªéœ€è¦åšä¸¤ä»¶äº‹ï¼šä¸ºå‘½ä»¤å®ç° CommandServiceã€åœ¨ dispatch æ–¹æ³•ä¸­æ·»åŠ æ–°å‘½ä»¤çš„æ”¯æŒã€‚</p><h3>Storage trait</h3><p>å†æ¥çœ‹ä¸ºä¸åŒçš„å­˜å‚¨è€Œè®¾è®¡çš„ Storage traitï¼Œå®ƒæä¾› KV store çš„ä¸»è¦æ¥å£ï¼š</p><pre><code class=\"language-rust\">/// å¯¹å­˜å‚¨çš„æŠ½è±¡ï¼Œæˆ‘ä»¬ä¸å…³å¿ƒæ•°æ®å­˜åœ¨å“ªå„¿ï¼Œä½†éœ€è¦å®šä¹‰å¤–ç•Œå¦‚ä½•å’Œå­˜å‚¨æ‰“äº¤é“\npub trait Storage {\n    /// ä»ä¸€ä¸ª HashTable é‡Œè·å–ä¸€ä¸ª key çš„ value\n    fn get(&amp;self, table: &amp;str, key: &amp;str) -&gt; Result&lt;Option&lt;Value&gt;, KvError&gt;;\n    /// ä»ä¸€ä¸ª HashTable é‡Œè®¾ç½®ä¸€ä¸ª key çš„ valueï¼Œè¿”å›æ—§çš„ value\n    fn set(&amp;self, table: &amp;str, key: String, value: Value) -&gt; Result&lt;Option&lt;Value&gt;, KvError&gt;;\n    /// æŸ¥çœ‹ HashTable ä¸­æ˜¯å¦æœ‰ key\n    fn contains(&amp;self, table: &amp;str, key: &amp;str) -&gt; Result&lt;bool, KvError&gt;;\n    /// ä» HashTable ä¸­åˆ é™¤ä¸€ä¸ª key\n    fn del(&amp;self, table: &amp;str, key: &amp;str) -&gt; Result&lt;Option&lt;Value&gt;, KvError&gt;;\n    /// éå† HashTableï¼Œè¿”å›æ‰€æœ‰ kv pairï¼ˆè¿™ä¸ªæ¥å£ä¸å¥½ï¼‰\n    fn get_all(&amp;self, table: &amp;str) -&gt; Result&lt;Vec&lt;Kvpair&gt;, KvError&gt;;\n    /// éå† HashTableï¼Œè¿”å› kv pair çš„ Iterator\n    fn get_iter(&amp;self, table: &amp;str) -&gt; Result&lt;Box&lt;dyn Iterator&lt;Item = Kvpair&gt;&gt;, KvError&gt;;\n}\n</code></pre><p>åœ¨ CommandService trait ä¸­å·²ç»çœ‹åˆ°ï¼Œåœ¨å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚çš„æ—¶å€™ï¼Œä¸ä¹‹æ‰“äº¤é“çš„æ˜¯ Storage traitï¼Œè€Œéå…·ä½“çš„æŸä¸ª storeã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œ<strong>æœªæ¥æ ¹æ®ä¸šåŠ¡çš„éœ€è¦ï¼Œåœ¨ä¸åŒçš„åœºæ™¯ä¸‹æ·»åŠ ä¸åŒçš„ storeï¼Œåªéœ€è¦ä¸ºå…¶å®ç°  Storage trait å³å¯ï¼Œä¸å¿…ä¿®æ”¹ CommandService æœ‰å…³çš„ä»£ç </strong>ã€‚</p><p>æ¯”å¦‚åœ¨ HGET å‘½ä»¤çš„å®ç°æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ Storage::get æ–¹æ³•ï¼Œä» table ä¸­è·å–æ•°æ®ï¼Œå®ƒè·ŸæŸä¸ªå…·ä½“çš„å­˜å‚¨æ–¹æ¡ˆæ— å…³ï¼š</p><pre><code class=\"language-rust\">impl CommandService for Hget {\n    fn execute(self, store: &amp;impl Storage) -&gt; CommandResponse {\n        match store.get(&amp;self.table, &amp;self.key) {\n            Ok(Some(v)) =&gt; v.into(),\n            Ok(None) =&gt; KvError::NotFound(self.table, self.key).into(),\n            Err(e) =&gt; e.into(),\n        }\n    }\n}\n</code></pre><p>Storage trait é‡Œé¢çš„ç»å¤§å¤šæ•°æ–¹æ³•ç›¸ä¿¡ä½ å¯ä»¥å®šä¹‰å‡ºæ¥ï¼Œä½† get_iter() è¿™ä¸ªæ¥å£å¯èƒ½ä½ ä¼šæ¯”è¾ƒå›°æƒ‘ï¼Œå› ä¸ºå®ƒè¿”å›äº†ä¸€ä¸ª Box&lt;dyn Iterator&gt;ï¼Œä¸ºä»€ä¹ˆï¼Ÿ</p><p>ä¹‹å‰ï¼ˆ<a href=\"https://time.geekbang.org/column/article/420028\">ç¬¬ 13 è®²</a>ï¼‰è®²è¿‡è¿™æ˜¯ trait objectã€‚</p><p>è¿™é‡Œæˆ‘ä»¬æƒ³è¿”å›ä¸€ä¸ª iteratorï¼Œè°ƒç”¨è€…ä¸å…³å¿ƒå®ƒå…·ä½“æ˜¯ä»€ä¹ˆç±»å‹ï¼Œåªè¦å¯ä»¥ä¸åœåœ°è°ƒç”¨ next() æ–¹æ³•å–åˆ°ä¸‹ä¸€ä¸ªå€¼å°±å¯ä»¥äº†ã€‚ä¸åŒçš„å®ç°ï¼Œå¯èƒ½è¿”å›ä¸åŒçš„ iteratorï¼Œå¦‚æœè¦ç”¨åŒä¸€ä¸ªæ¥å£æ‰¿è½½ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ trait objectã€‚åœ¨ä½¿ç”¨ trait object æ—¶ï¼Œå› ä¸º Iterator æ˜¯ä¸ªå¸¦æœ‰å…³è”ç±»å‹çš„ traitï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦æŒ‡æ˜å…³è”ç±»å‹ Item æ˜¯ä»€ä¹ˆç±»å‹ï¼Œè¿™æ ·è°ƒç”¨è€…æ‰å¥½æ‹¿åˆ°è¿™ä¸ªç±»å‹è¿›è¡Œå¤„ç†ã€‚</p><p>ä½ ä¹Ÿè®¸ä¼šæœ‰ç–‘é—®ï¼Œset / del æ˜æ˜¾æ˜¯ä¸ªä¼šå¯¼è‡´ self ä¿®æ”¹çš„æ–¹æ³•ï¼Œä¸ºä»€ä¹ˆå®ƒçš„æ¥å£ä¾æ—§ä½¿ç”¨çš„æ˜¯ &amp;self å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬æ€è€ƒä¸€ä¸‹å®ƒçš„ç”¨æ³•ã€‚å¯¹äº Storage traitï¼Œæœ€ç®€å•çš„å®ç°æ˜¯ in-memory çš„ HashMapã€‚ç”±äºæˆ‘ä»¬æ”¯æŒçš„æ˜¯ HSET / HGET è¿™æ ·çš„å‘½ä»¤ï¼Œ<strong>å®ƒä»¬å¯ä»¥ä»ä¸åŒçš„è¡¨ä¸­è¯»å–æ•°æ®ï¼Œæ‰€ä»¥éœ€è¦åµŒå¥—çš„ HashMap</strong>ï¼Œç±»ä¼¼ HashMap&lt;String, HashMap&lt;String, Value&gt;&gt;ã€‚</p><p>å¦å¤–ï¼Œç”±äº<strong>è¦åœ¨å¤šçº¿ç¨‹/å¼‚æ­¥ç¯å¢ƒä¸‹è¯»å–å’Œæ›´æ–°å†…å­˜ä¸­çš„ HashMap</strong>ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç±»ä¼¼ Arc&lt;RwLock&lt;HashMap&lt;String, Arc&lt;RwLock&lt;HashMap&lt;String, Value&gt;&gt;&gt;&gt;&gt;&gt; çš„ç»“æ„ã€‚è¿™ä¸ªç»“æ„æ˜¯ä¸€ä¸ªå¤šçº¿ç¨‹ç¯å¢ƒä¸‹å…·æœ‰å†…éƒ¨å¯å˜æ€§çš„æ•°æ®ç»“æ„ï¼Œæ‰€ä»¥ get / set çš„æ¥å£æ˜¯ &amp;self å°±è¶³å¤Ÿäº†ã€‚</p><h2>å°ç»“</h2><p>åˆ°ç°åœ¨ï¼Œæˆ‘ä»¬æ¢³ç†äº† KV server çš„ä¸»è¦éœ€æ±‚å’Œä¸»æµç¨‹ï¼Œæ€è€ƒäº†æµç¨‹ä¸­å¯èƒ½å‡ºç°çš„é—®é¢˜ï¼Œä¹Ÿæ•²å®šäº†ä¸‰ä¸ªé‡è¦çš„æ¥å£ï¼šå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çš„åè®®ã€CommandService traitã€Storage traitã€‚ä¸‹ä¸€è®²ç»§ç»­å®ç° KV serverï¼Œåœ¨çœ‹è®²è§£ä¹‹å‰ï¼Œä½ å¯ä»¥å…ˆæƒ³ä¸€æƒ³è‡ªå·±å¹³æ—¶æ˜¯æ€ä¹ˆå¼€å‘çš„ã€‚</p><h3>æ€è€ƒé¢˜</h3><p>æƒ³ä¸€æƒ³ï¼Œå¯¹äº Storage traitï¼Œä¸ºä»€ä¹ˆè¿”å›å€¼éƒ½ç”¨äº† Result&lt;T, E&gt;ï¼Ÿåœ¨å®ç° MemTable çš„æ—¶å€™ï¼Œä¼¼ä¹æ‰€æœ‰è¿”å›éƒ½æ˜¯ Ok(T) å•Šï¼Ÿ</p><p>æ¬¢è¿åœ¨ç•™è¨€åŒºåˆ†äº«ä½ çš„æ€è€ƒã€‚æˆ‘ä»¬ä¸‹ç¯‡è§ï½</p>","comments":[{"had_liked":false,"id":317033,"user_name":"Roy Liang","can_delete":false,"product_type":"c1","uid":1098898,"ip_address":"","ucode":"1DF5FC831A35DA","user_header":"https://static001.geekbang.org/account/avatar/00/10/c4/92/338b5609.jpg","comment_is_top":false,"comment_ctime":1634644594,"is_pvip":false,"replies":[{"id":"115250","content":"å¯¹çš„ï¼","user_name":"ä½œè€…å›å¤","comment_id":317033,"uid":"1079375","ip_address":"","utype":1,"ctime":1635123451,"user_name_real":"Tyr"}],"discussion_count":1,"race_medal":0,"score":"27404448370","product_id":100085301,"comment_content":"å¯¹äº Storage traitï¼Œä¸ºä»€ä¹ˆè¿”å›å€¼éƒ½ç”¨äº† Resultï¼Ÿåœ¨å®ç° MemTable çš„æ—¶å€™ï¼Œä¼¼ä¹æ‰€æœ‰è¿”å›éƒ½æ˜¯ Ok(T) å•Šï¼Ÿ<br><br>æˆ‘è§‰å¾—Storageä½œä¸ºtraitï¼Œéœ€è¦å…³æ³¨IOæ“ä½œå¤±è´¥çš„é”™è¯¯æƒ…å†µï¼Œè€ŒMemTableå®ç°ï¼Œéƒ½æ˜¯å†…å­˜æ“ä½œï¼Œå‡ ä¹ä¸ä¼šå¤±è´¥ï¼Œæ‰€ä»¥è¿”å›Ok(T)å°±å¯ä»¥äº†","like_count":7,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":528622,"discussion_content":"å¯¹çš„ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635123451,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":337170,"user_name":"jostan","can_delete":false,"product_type":"c1","uid":1045720,"ip_address":"","ucode":"0A46739F079DFB","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f4/d8/f01a9c2b.jpg","comment_is_top":false,"comment_ctime":1646659255,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"10236593847","product_id":100085301,"comment_content":"ä¸ºä»€ä¹ˆ get_iter çš„è¿”å›å€¼éœ€è¦ç”¨åˆ° Box å‘¢ï¼Ÿ","like_count":3,"discussions":[{"author":{"id":2620407,"avatar":"https://static001.geekbang.org/account/avatar/00/27/fb/f7/88ab6f83.jpg","nickname":"è¿›å‡»çš„Lancelot","note":"","ucode":"3BCC355801DC61","race_medal":1,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":587554,"discussion_content":"rust ä¸­ trait object çš„è¡¨ç°å½¢å¼ä¸»è¦æ˜¯ä¸¤ç§ï¼š&amp;dyn trait å’Œ Box&lt;dyn trait&gt;ï¼Œä½¿ç”¨ Box çš„è¯ï¼Œè¿™é‡Œå¯ä»¥å¸®åŠ©ä½ è‡ªåŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸã€‚å¦‚æœä½ ä½¿ç”¨ &amp;dyn traitï¼Œé‚£å®ƒçš„ç”Ÿå‘½å‘¨æœŸä¼šå’Œ self ä¸€æ ·é•¿ï¼Œè¿™æ—¶å€™å¦‚æœä½ è¦å°†è¿™ä¸ªè¿­ä»£å™¨ä¼ é€’å‡ºå»ï¼Œå°±ä¼šé¢ä¸´ trait object ç”Ÿå‘½å‘¨æœŸ outlive self çš„æƒ…å†µ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1663142641,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å¹¿ä¸œ"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":316187,"user_name":"Marvichov","can_delete":false,"product_type":"c1","uid":1111835,"ip_address":"","ucode":"7482099415C41C","user_header":"https://static001.geekbang.org/account/avatar/00/10/f7/1b/db7a0edc.jpg","comment_is_top":false,"comment_ctime":1634195362,"is_pvip":false,"replies":[{"id":"115253","content":"åºåˆ—åŒ–ååºåˆ—åŒ–çš„ç›®çš„æ˜¯æŠŠå†…å­˜ä¸­æ•°æ®ç»“æ„çš„è¡¨è¿°è½¬æ¢æˆç½‘ç»œä¸­æˆ–è€…æ–‡ä»¶ä¸­å¯ä»¥å­˜å‚¨çš„è¡¨è¿°ã€‚æ¯”å¦‚ä¸€ä¸ª Box&lt;T&gt; æ˜¾ç„¶æ— æ³•ç›´æ¥åœ¨ç½‘ç»œä¸­ä¼ è¾“çš„ã€‚json æ˜¯æœ€å¸¸è§çš„åºåˆ—åŒ–æ–¹å¼ï¼Œä½† json æ•ˆç‡å¤ªä½ï¼ˆxml å°±æ›´ä½äº†ï¼‰ã€‚protobuf æ•ˆç‡å¾ˆé«˜ï¼Œä¸”å…¶äºŒè¿›åˆ¶çš„æ ¼å¼éå¸¸ç²¾ç®€ï¼ˆæ¯”å¦‚é•¿åº¦éƒ½æ˜¯ varintï¼‰ï¼Œå¾ˆçœå¸¦å®½ã€‚","user_name":"ä½œè€…å›å¤","comment_id":316187,"uid":"1079375","ip_address":"","utype":1,"ctime":1635123698,"user_name_real":"Tyr"}],"discussion_count":1,"race_medal":0,"score":"10224129954","product_id":100085301,"comment_content":"è¿™æ¬¡çš„é€‰å›¾å‘ç”Ÿåœ¨æœ€è¿‘çš„ä¸€ä¸ªå¤§åœ°è‰ºæœ¯: åŒ…è£¹å‡¯æ—‹é—¨!<br><br>æƒ³äº†æƒ³ä¸ºä»€ä¹ˆéœ€è¦åºåˆ—åŒ–&#47;ååºåˆ—åŒ–, http, jsonæˆ–è€…xmlå·²ç»æ˜¯structuredçš„dataäº†å•Š; åæ¥æ„è¯†åˆ°, éœ€è¦æŠŠtext dataè½¬åŒ–æˆæŸç§rustçš„æ•°æ®ç»“æ„(data + algorithm)æ‰èƒ½ä½¿ç”¨ä¸æ•°æ®ç»‘å®šçš„algorithm (OOP)<br><br>æ¯”å¦‚ç”¨protobufç”Ÿæˆå¯¹åº”çš„rust struct (or enum)â€¦ç„¶åå¯¹é‚£äº›structå®ç°CommandService trait æˆ–è€… Into, newä¹‹ç±»çš„æ–¹æ³•","like_count":3,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":528299,"discussion_content":"åºåˆ—åŒ–ååºåˆ—åŒ–çš„ç›®çš„æ˜¯æŠŠå†…å­˜ä¸­æ•°æ®ç»“æ„çš„è¡¨è¿°è½¬æ¢æˆç½‘ç»œä¸­æˆ–è€…æ–‡ä»¶ä¸­å¯ä»¥å­˜å‚¨çš„è¡¨è¿°ã€‚æ¯”å¦‚ä¸€ä¸ª Box&amp;lt;T&amp;gt; æ˜¾ç„¶æ— æ³•ç›´æ¥åœ¨ç½‘ç»œä¸­ä¼ è¾“çš„ã€‚json æ˜¯æœ€å¸¸è§çš„åºåˆ—åŒ–æ–¹å¼ï¼Œä½† json æ•ˆç‡å¤ªä½ï¼ˆxml å°±æ›´ä½äº†ï¼‰ã€‚protobuf æ•ˆç‡å¾ˆé«˜ï¼Œä¸”å…¶äºŒè¿›åˆ¶çš„æ ¼å¼éå¸¸ç²¾ç®€ï¼ˆæ¯”å¦‚é•¿åº¦éƒ½æ˜¯ varintï¼‰ï¼Œå¾ˆçœå¸¦å®½ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1635123698,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":353096,"user_name":"zahi","can_delete":false,"product_type":"c1","uid":1447887,"ip_address":"åŒ—äº¬","ucode":"F64ABEB63C6D1F","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIofiaCAziajdQnbvrfpEkpCKVFgO62y6zicamhjF1BAWZSRcCVaTBXLIerLsGeZCic7XS7KOEkTN4fRg/132","comment_is_top":false,"comment_ctime":1659162330,"is_pvip":true,"replies":[{"id":"128392","content":"çŸ­å¹³ç³™çš„ç‰ˆæœ¬æ˜¯ä¸ªç¤ºæ„","user_name":"ç¼–è¾‘å›å¤","comment_id":353096,"uid":"2547771","ip_address":"åŒ—äº¬","utype":2,"ctime":1659171054,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"1659162330","product_id":100085301,"comment_content":"é‚£ä¸ªçŸ­å¹³ç³™çš„å®ç°ä»£ç ï¼Œé‚£ä¸ªå¼•ç”¨kvä¸‹é¢çš„ç»“æ„æ ¹æœ¬æ‰¾ä¸åˆ°å—ï¼Œgithubä¸Šä¹Ÿæ‰¾ä¸åˆ°è¿™ä¸ªä»£ç ã€‚","like_count":0,"discussions":[{"author":{"id":2547771,"avatar":"https://static001.geekbang.org/account/avatar/00/26/e0/3b/8ec916b2.jpg","nickname":"å¤šå°‘","note":"","ucode":"0A6EF7AA6E4BB7","race_medal":0,"user_type":4,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":582058,"discussion_content":"çŸ­å¹³ç³™çš„ç‰ˆæœ¬æ˜¯ä¸ªç¤ºæ„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659171054,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬"},"score":2,"extra":"{\"reply\":true,\"user_type\":4}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":337515,"user_name":"å°å¼º","can_delete":false,"product_type":"c1","uid":1155961,"ip_address":"","ucode":"AFA06753068BD7","user_header":"https://static001.geekbang.org/account/avatar/00/11/a3/79/ef7e9920.jpg","comment_is_top":false,"comment_ctime":1646878277,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1646878277","product_id":100085301,"comment_content":"ä¸ºä»€ä¹ˆä½¿ç”¨oneofï¼Œä¸ä½¿ç”¨unionï¼Ÿ","like_count":0},{"had_liked":false,"id":330919,"user_name":"å¦‚æœå°±æ˜¯é£ç¡•","can_delete":false,"product_type":"c1","uid":1019186,"ip_address":"","ucode":"280B9E4E94E0AA","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/uI4ufWlFvKqgK54s903icMx1WmibibjbbUicukgSGrtUt5ibjXXmOHiaGTTojsDOfPagprIwhSGVmibEgdsjYthXWFQgQ/132","comment_is_top":false,"comment_ctime":1642299696,"is_pvip":false,"replies":[{"id":"120750","content":"å…ˆå®šä¹‰æ¥å£","user_name":"ä½œè€…å›å¤","comment_id":330919,"uid":"1079375","ip_address":"","utype":1,"ctime":1642308047,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"1642299696","product_id":100085301,"comment_content":"æˆ‘ç†è§£å…ˆè¦åšè®¾è®¡ï¼Œè¿™ä¸ªè®¾è®¡æ˜¯é’ˆå¯¹éœ€æ±‚ï¼Œè®¾è®¡å®ç°éœ€æ±‚çš„æ•´ä¸ªæµç¨‹ï¼Œæµç¨‹ä¸­çš„æ¯ä¸€ä¸ªæ­¥éª¤éƒ½æ˜¯åšä»€ä¹ˆï¼Œè€Œä¸è¦è€ƒè™‘æ€ä¹ˆåšï¼Œæ€ä¹ˆåšæ˜¯éœ€è¦å»¶è¿Ÿå†³ç­–å¤„ç†çš„ã€‚è¿™æ ·åšå‡ºæ¥çš„è®¾è®¡æ‰èƒ½ç®€å•æ¸…æ™°ã€‚","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546388,"discussion_content":"å…ˆå®šä¹‰æ¥å£","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642308047,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":322719,"user_name":"Lionel","can_delete":false,"product_type":"c1","uid":2818265,"ip_address":"","ucode":"A6AD53F2F92EE9","user_header":"https://static001.geekbang.org/account/avatar/00/2b/00/d9/f7c658cf.jpg","comment_is_top":false,"comment_ctime":1637565750,"is_pvip":false,"replies":[{"id":"118901","content":"ä½ å¯ä»¥å°±è¿è¡Œ `cargo build`","user_name":"ä½œè€…å›å¤","comment_id":322719,"uid":"1079375","ip_address":"","utype":1,"ctime":1639851796,"user_name_real":"ç¼–è¾‘"}],"discussion_count":2,"race_medal":0,"score":"1637565750","product_id":100085301,"comment_content":"è¯·é—®è€å¸ˆï¼Œæ€ä¹ˆç‹¬ç«‹è¿è¡Œbuild.rs ? è­¬å¦‚protoæ–‡ä»¶ä¿®æ”¹åï¼Œæˆ‘åªæƒ³è®©ç”Ÿæˆæ–°çš„abi.rsï¼Œè¯¥å¦‚ä½•æ“ä½œï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539862,"discussion_content":"ä½ å¯ä»¥å°±è¿è¡Œ `cargo build`","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639851796,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1218666,"avatar":"https://static001.geekbang.org/account/avatar/00/12/98/6a/3ddeca6e.jpg","nickname":"losuika","note":"","ucode":"19685B1B00A4F3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":534102,"discussion_content":"cargo build","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638098432,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":317032,"user_name":"Roy Liang","can_delete":false,"product_type":"c1","uid":1098898,"ip_address":"","ucode":"1DF5FC831A35DA","user_header":"https://static001.geekbang.org/account/avatar/00/10/c4/92/338b5609.jpg","comment_is_top":false,"comment_ctime":1634644511,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1634644511","product_id":100085301,"comment_content":"å¯¹äº Storage traitï¼Œä¸ºä»€ä¹ˆè¿”å›å€¼éƒ½ç”¨äº† Resultï¼Ÿåœ¨å®ç° MemTable çš„æ—¶å€™ï¼Œä¼¼ä¹æ‰€æœ‰è¿”å›éƒ½æ˜¯ Ok(T) å•Šï¼Ÿ","like_count":0},{"had_liked":false,"id":317025,"user_name":"ç½—æ°","can_delete":false,"product_type":"c1","uid":1320487,"ip_address":"","ucode":"96BAFAA147341F","user_header":"https://static001.geekbang.org/account/avatar/00/14/26/27/eba94899.jpg","comment_is_top":false,"comment_ctime":1634643229,"is_pvip":false,"replies":[{"id":"115251","content":"å“¦ï¼Œè¿˜æœ‰è¿™æ ·çš„å‘","user_name":"ä½œè€…å›å¤","comment_id":317025,"uid":"1079375","ip_address":"","utype":1,"ctime":1635123500,"user_name_real":"Tyr"}],"discussion_count":2,"race_medal":2,"score":"1634643229","product_id":100085301,"comment_content":"Windows User ç”¨æˆ·ç›®å½•ä¸‹ä¸­æ–‡åç§° proto ç¼–è¯‘å‡ºé”™ï¼Œéœ€è¦ä¿®æ”¹ build.rsï¼Œåƒä¸‡ä¸è¦ä¹±ä¿®æ”¹ä¸­æ–‡åç§°ï¼Œè¿™ä¸ªå¾ˆå‘ã€‚","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":528618,"discussion_content":"å“¦ï¼Œè¿˜æœ‰è¿™æ ·çš„å‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635123500,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1320487,"avatar":"https://static001.geekbang.org/account/avatar/00/14/26/27/eba94899.jpg","nickname":"ç½—æ°","note":"","ucode":"96BAFAA147341F","race_medal":2,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":405833,"discussion_content":"fn main() {\n    prost_build::Config::new()\n        .out_dir(&#34;src/pb&#34;)\n        .file_descriptor_set_path(&#34;target/tmp&#34;)\n        .compile_protos(&amp;[&#34;abi.proto&#34;], &amp;[&#34;.&#34;])\n        .unwrap();\n}","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634652079,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":317021,"user_name":"ç½—æ°","can_delete":false,"product_type":"c1","uid":1320487,"ip_address":"","ucode":"96BAFAA147341F","user_header":"https://static001.geekbang.org/account/avatar/00/14/26/27/eba94899.jpg","comment_is_top":false,"comment_ctime":1634642984,"is_pvip":false,"replies":[{"id":"115252","content":"åŠ æ²¹ï¼","user_name":"ä½œè€…å›å¤","comment_id":317021,"uid":"1079375","ip_address":"","utype":1,"ctime":1635123511,"user_name_real":"Tyr"}],"discussion_count":1,"race_medal":2,"score":"1634642984","product_id":100085301,"comment_content":"æœ€è¿‘äº‹æƒ…å¤šï¼Œå¿«è·Ÿä¸ä¸Šäº†ï¼Œä»£ç è¿˜æ˜¯è¦äº²è‡ªå†™ï¼Œåˆ‡èº«æ„Ÿå—ã€‚","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":528616,"discussion_content":"åŠ æ²¹ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635123511,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":315884,"user_name":"D. D","can_delete":false,"product_type":"c1","uid":2186992,"ip_address":"","ucode":"C416E5602C8814","user_header":"https://static001.geekbang.org/account/avatar/00/21/5e/f0/62d8cf9e.jpg","comment_is_top":false,"comment_ctime":1634031322,"is_pvip":true,"replies":[{"id":"115286","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","comment_id":315884,"uid":"1079375","ip_address":"","utype":1,"ctime":1635132500,"user_name_real":"Tyr"}],"discussion_count":1,"race_medal":0,"score":"1634031322","product_id":100085301,"comment_content":"å®šä¹‰Storage traitå°±æ˜¯ä¸ºäº†ä»¥åå¯ä»¥çµæ´»çš„ä½¿ç”¨ä¸åŒçš„å…·ä½“çš„å­˜å‚¨æ–¹æ¡ˆã€‚å¦‚æœä¹‹åè¦æ±‚æŒä¹…åŒ–ï¼Œå…¶ä¸­æ¶‰åŠåˆ°ä¾‹å¦‚I&#47;Oä¹‹ç±»çš„æ“ä½œï¼Œå°±å¾ˆæœ‰å¯èƒ½è¦è¿”å›Erräº†ã€‚<br>æ­¤å¤–ï¼Œåœ¨å¹¶å‘åœºæ™¯ä¸‹ï¼Œä¹Ÿä¼šæœ‰ä¾‹å¦‚è·å–é”å¤±è´¥ä¹‹ç±»çš„æƒ…å†µã€‚","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":528192,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635132500,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":315529,"user_name":"pedro","can_delete":false,"product_type":"c1","uid":1200704,"ip_address":"","ucode":"F40C839DDFD599","user_header":"https://static001.geekbang.org/account/avatar/00/12/52/40/e57a736e.jpg","comment_is_top":false,"comment_ctime":1633915400,"is_pvip":false,"replies":[{"id":"115295","content":"å—¯ï¼Œè¿˜æœ‰ä¸€ä¸ªåŸå› æ˜¯ trait ä»¥åå¯èƒ½ä¼šè¢«ç”¨åœ¨å…¶å®ƒåœºæ™¯ï¼Œæ¯”å¦‚æ–‡ä»¶ç³»ç»Ÿä¸­çš„ kv storeï¼Œæ­¤æ—¶å°±å¯èƒ½æœ‰ IO errorï¼Œæ‰€ä»¥ï¼Œå³ä½¿ç°åœ¨ in memory store è¿˜ç”¨ä¸ç€ï¼Œä½†ä»¥åæœ‰å¯èƒ½ç”¨åˆ°ã€‚","user_name":"ä½œè€…å›å¤","comment_id":315529,"uid":"1079375","ip_address":"","utype":1,"ctime":1635133162,"user_name_real":"Tyr"}],"discussion_count":1,"race_medal":0,"score":"1633915400","product_id":100085301,"comment_content":"æƒ³ä¸€æƒ³ï¼Œå¯¹äº Storage traitï¼Œä¸ºä»€ä¹ˆè¿”å›å€¼éƒ½ç”¨äº† Result&lt;T, E&gt;ï¼Ÿåœ¨å®ç° MemTable çš„æ—¶å€™ï¼Œä¼¼ä¹æ‰€æœ‰è¿”å›éƒ½æ˜¯ Ok(T) å•Šï¼Ÿ<br><br>Result è¿™ä¸ªæšä¸¾æœ‰ä¸¤ä¸ªç±»å‹Tï¼ŒEï¼Œå½“æŸ¥è¯¢å‡ºé”™æ—¶ï¼Œé€šè¿‡ E ç»™å‡ºå‡ºé”™åŸå› ï¼Œæ–¹ä¾¿å®¢æˆ·ç«¯åŠæ—¶åšå‡ºçº é”™å’Œè°ƒæ•´ï¼Œè€Œ Ok åªæœ‰ 1 å’Œ 0 çš„åŒºåˆ†ã€‚","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":528059,"discussion_content":"å—¯ï¼Œè¿˜æœ‰ä¸€ä¸ªåŸå› æ˜¯ trait ä»¥åå¯èƒ½ä¼šè¢«ç”¨åœ¨å…¶å®ƒåœºæ™¯ï¼Œæ¯”å¦‚æ–‡ä»¶ç³»ç»Ÿä¸­çš„ kv storeï¼Œæ­¤æ—¶å°±å¯èƒ½æœ‰ IO errorï¼Œæ‰€ä»¥ï¼Œå³ä½¿ç°åœ¨ in memory store è¿˜ç”¨ä¸ç€ï¼Œä½†ä»¥åæœ‰å¯èƒ½ç”¨åˆ°ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635133162,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":315425,"user_name":"ç»™æˆ‘ç‚¹é˜³å…‰å°±ç¿çƒ‚","can_delete":false,"product_type":"c1","uid":1462209,"ip_address":"","ucode":"F3B0439BE0D062","user_header":"https://static001.geekbang.org/account/avatar/00/16/4f/c1/7f596aba.jpg","comment_is_top":false,"comment_ctime":1633887517,"is_pvip":true,"replies":[{"id":"115297","content":"ä½ å¯ä»¥ä½¿ç”¨å¯ä»¥åš demonize çš„åº“æ¥ç”Ÿæˆä¸€ä¸ª damonã€‚<br><br>æ¯”å¦‚ï¼šhttps:&#47;&#47;github.com&#47;knsd&#47;daemonize","user_name":"ä½œè€…å›å¤","comment_id":315425,"uid":"1079375","ip_address":"","utype":1,"ctime":1635133388,"user_name_real":"Tyr"}],"discussion_count":1,"race_medal":0,"score":"1633887517","product_id":100085301,"comment_content":"è€å¸ˆåœ¨ä»¥åçš„ç« èŠ‚ä¸­å¯ä¸å¯ä»¥è®²ä¸€ä¸‹ï¼Œå¦‚ä½•æŠŠserverå®ç°ç±»ä¼¼docker ä¸€æ ·çš„socket å®ˆæŠ¤è¿›ç¨‹","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527974,"discussion_content":"ä½ å¯ä»¥ä½¿ç”¨å¯ä»¥åš demonize çš„åº“æ¥ç”Ÿæˆä¸€ä¸ª damonã€‚\n\næ¯”å¦‚ï¼šhttps://github.com/knsd/daemonize","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635133388,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}