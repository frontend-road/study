{"id":287038,"title":"20 | DataStream API实践原理","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/geektime-Flink\">https://gitee.com/geektime-geekbang/geektime-Flink</a></p>","comments":[{"had_liked":false,"id":293332,"user_name":"杨杰","can_delete":false,"product_type":"c3","uid":1131823,"ip_address":"","ucode":"74817EA9499843","user_header":"https://static001.geekbang.org/account/avatar/00/11/45/2f/b0b0dd74.jpg","comment_is_top":false,"comment_ctime":1621339304,"is_pvip":false,"replies":[{"id":106751,"content":"需要结合CDC和Checkpoint，实现数据一致性保证，这边避免数据重复消费的问题；","user_name":"作者回复","user_name_real":"张利兵","uid":1119779,"ctime":1621852225,"ip_address":"","comment_id":293332,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100058801,"comment_content":"我想请教一个问题，虽然可能跟这节课程无关，但是一直是比较困扰我的。\n一般我们用flink构建实时数据中心的时候，都难免涉及到一个从交易系统数据库进行CDC的过程，如果这个CDC的过程中间出现中断了（或者其他的数据源产生的过程由于故障中断了），那就会对整个的统计产生比较大的影响，请问在实际生产环境下是如何避免这个问题的呢？","like_count":1,"discussions":[{"author":{"id":1119779,"avatar":"https://static001.geekbang.org/account/avatar/00/11/16/23/99c7ede5.jpg","nickname":"张利兵","note":"","ucode":"DBAE17970AB143","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":520164,"discussion_content":"需要结合CDC和Checkpoint，实现数据一致性保证，这边避免数据重复消费的问题；","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621852225,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":248993,"user_name":"geek2020","can_delete":false,"product_type":"c3","uid":2045843,"ip_address":"","ucode":"3E7F7F8D419A75","user_header":"","comment_is_top":false,"comment_ctime":1600397478,"is_pvip":false,"replies":[{"id":91399,"content":"Flink中如果是Stream模式下，计算WordCount都是基于Window来计算的，只有在离线模式下才会统计全量数据，如果要做全量数据的WordCount可以基于状态来统计，但是不太建议，毕竟单词数量还是不小的。","user_name":"作者回复","user_name_real":"张利兵","uid":1119779,"ctime":1600481365,"ip_address":"","comment_id":248993,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100058801,"comment_content":"老师，我跑了个WordCount的用例，有个疑问想请教下。flink内存中，存储的是word的具体内容，还是每轮计算之后的结果？比如我给flink的输入是&quot;a a a b b&quot;，那flink算完后在内存中保存的是(a, 3)、(b, 2)，还是保存a、a、a、b、b这个明细？另外，如果任务跑的时间久了，比如累计统计了几十亿个不同的word，会不会有内存溢出的风险？","like_count":0,"discussions":[{"author":{"id":1119779,"avatar":"https://static001.geekbang.org/account/avatar/00/11/16/23/99c7ede5.jpg","nickname":"张利兵","note":"","ucode":"DBAE17970AB143","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":505793,"discussion_content":"Flink中如果是Stream模式下，计算WordCount都是基于Window来计算的，只有在离线模式下才会统计全量数据，如果要做全量数据的WordCount可以基于状态来统计，但是不太建议，毕竟单词数量还是不小的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600481365,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2045843,"avatar":"","nickname":"geek2020","note":"","ucode":"3E7F7F8D419A75","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":307125,"discussion_content":"老师，我的关键代码如下。按您说的“Flink中如果是Stream模式下，计算WordCount都是基于Window来计算的”，那我这个任务的window怎么理解（滑窗还是滚窗？周期是啥？）\n\npublic class SocketTextStreamWordCount {\n    public static void main(String[] args) throws Exception {\n        //参数检查\n        if (args.length != 2) {\n            System.err.println(&#34;USAGE:\\nSocketTextStreamWordCount <hostname> <port>&#34;);\n            return;\n        }\n\n        String hostname = args[0];\n        Integer port = Integer.parseInt(args[1]);\n\n\n        // set up the streaming execution environment\n        final StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();\n\n        //获取数据\n        DataStreamSource<String> stream = env.socketTextStream(hostname, port);\n\n        //计数\n        SingleOutputStreamOperator<Tuple2<String, Integer>> sum = stream.flatMap(new LineSplitter())\n                .keyBy(0)\n                .sum(1);\n\n        sum.print();\n\n        env.execute(&#34;Java WordCount from SocketTextStream Example&#34;);\n    }\n\n    public static final class LineSplitter implements FlatMapFunction<String, Tuple2<String, Integer>> {\n        @Override\n        public void flatMap(String s, Collector<Tuple2<String, Integer>> collector) {\n            String[] tokens = s.toLowerCase().split(&#34;\\\\W+&#34;);\n\n            for (String token: tokens) {\n                if (token.length() > 0) {\n                    collector.collect(new Tuple2<String, Integer>(token, 1));\n                }\n            }\n        }\n    }\n}","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600504835,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":262600,"user_name":"Geek_f9d390","can_delete":false,"product_type":"c3","uid":2034725,"ip_address":"","ucode":"521B60A2DCABD4","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/UGqtO7nj9EXt7tbicojstIcLnMgzY2cWaUyXWzQU7G0c1YttVcxlslKXTev1ohonFfJBWQZ1oNT3C9GQ6jjlhyw/132","comment_is_top":false,"comment_ctime":1605777315,"is_pvip":false,"replies":null,"discussion_count":6,"race_medal":0,"score":2,"product_id":100058801,"comment_content":"没有开发经验，感觉听起来有点累","like_count":7,"discussions":[{"author":{"id":1112676,"avatar":"https://static001.geekbang.org/account/avatar/00/10/fa/64/457325e6.jpg","nickname":"Sam Fu","note":"","ucode":"EA285A4943271F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":595382,"discussion_content":"确实 听着好痛苦","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1669985056,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2771298,"avatar":"https://static001.geekbang.org/account/avatar/00/2a/49/62/db480ab6.jpg","nickname":"跳跳","note":"","ucode":"8999B46CF6D197","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":584209,"discussion_content":"实践后二刷，会有不少收获。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660693112,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1355505,"avatar":"","nickname":"Geek_3d1bee","note":"","ucode":"B436356BF91CAF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":573862,"discussion_content":"跟你没关系，这个讲课的“老师”照着PPT念，你能听懂才怪","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1653698082,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1940461,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/9b/ed/e633460a.jpg","nickname":"Geek_225244","note":"","ucode":"43A0711FFAB44A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1355505,"avatar":"","nickname":"Geek_3d1bee","note":"","ucode":"B436356BF91CAF","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":585858,"discussion_content":"说实话，他确实讲得不好","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661850344,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":573862,"ip_address":"上海","group_id":0},"score":585858,"extra":""},{"author":{"id":1940461,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/9b/ed/e633460a.jpg","nickname":"Geek_225244","note":"","ucode":"43A0711FFAB44A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1355505,"avatar":"","nickname":"Geek_3d1bee","note":"","ucode":"B436356BF91CAF","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":585859,"discussion_content":"这种都能当中台架构师，说明第四范式公司确实不咋地","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661850465,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":573862,"ip_address":"上海","group_id":0},"score":585859,"extra":""}]},{"author":{"id":1046152,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f6/88/ee32fde9.jpg","nickname":"章光辉","note":"","ucode":"49ACA750CAF19E","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":382178,"discussion_content":"实践一遍就好了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625464190,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":280112,"user_name":"Allan","can_delete":false,"product_type":"c3","uid":1310388,"ip_address":"","ucode":"8DA4DBECC2C45C","user_header":"https://static001.geekbang.org/account/avatar/00/13/fe/b4/295338e7.jpg","comment_is_top":false,"comment_ctime":1614082359,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100058801,"comment_content":"datastream主要操作四部分：1、单条处理 2、窗口处理 3、合并处理 4、拆分处理，这样一分就容易针对每个算子属于哪一部分说明了","like_count":4},{"had_liked":false,"id":338925,"user_name":"Geek_7ixbah","can_delete":false,"product_type":"c3","uid":1048356,"ip_address":"","ucode":"9F110914D7EB00","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ff/24/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1647790035,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100058801,"comment_content":"这里有个疑问，KeyedStream、物理分组，等等，都是什么场景下会使用呢？老师能举个例子嘛","like_count":1},{"had_liked":false,"id":376342,"user_name":"Geek_f8cc0e","can_delete":false,"product_type":"c3","uid":3177282,"ip_address":"广东","ucode":"84ABCECE37FFC8","user_header":"","comment_is_top":false,"comment_ctime":1686724908,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100058801,"comment_content":"方便加微信吗","like_count":0},{"had_liked":false,"id":370384,"user_name":"Geek_3360b0","can_delete":false,"product_type":"c3","uid":3553421,"ip_address":"福建","ucode":"8E16877BCD71EC","user_header":"","comment_is_top":false,"comment_ctime":1678777299,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100058801,"comment_content":"这里感觉应该也结合经典的 ETL 进行解释下，甚至 CDC","like_count":0},{"had_liked":false,"id":279872,"user_name":"马来酸","can_delete":false,"product_type":"c3","uid":1108744,"ip_address":"","ucode":"2F33F120E76A43","user_header":"https://static001.geekbang.org/account/avatar/00/10/eb/08/54fabe39.jpg","comment_is_top":false,"comment_ctime":1613988106,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100058801,"comment_content":"老师我想问如果keyby两次, 然后再window()会有几个窗口？\n&#47;&#47; 我想对不同船(id)的轨迹进行预测, 然后统计各个区域(area)内每一秒的轨迹信息\n&#47;&#47; 像下面这样写, 最后的窗口是只按area划分的吗, 能达到预期效果嘛?\n&gt;&gt; stream.keyby(&quot;id&quot;)\n&#47;&#47; 在里面使用key state存储每条船最新的三个轨迹点\n&#47;&#47; 根据三个轨迹点 对轨迹进行预测, 输出未来10的预测轨迹\n&gt;&gt; .richflatmap() \n&gt;&gt; .assignTime() &#47;&#47; 修改轨迹eventTime为预测出的时间\n&gt;&gt; .keyby(&quot;area&quot;)\n&gt;&gt; .window(1s) &#47;&#47; 只根据区域划分窗口, 长度为1s的滚动窗口\n&gt;&gt; .process() &#47;&#47; 统计各个区域内某一秒时是否有距离过近的两艘船","like_count":0},{"had_liked":false,"id":249550,"user_name":"Brave chan","can_delete":false,"product_type":"c3","uid":1102884,"ip_address":"","ucode":"D98D103178B156","user_header":"https://static001.geekbang.org/account/avatar/00/10/d4/24/b5f13de3.jpg","comment_is_top":false,"comment_ctime":1600689183,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100058801,"comment_content":"老师，我想问下，我的stream在按照id进行keyby后再执行多并行度的算子时可以保证同一个id的数据落算子的同一个子线程任务中吗？","like_count":0}]}