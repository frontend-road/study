{"id":502205,"title":"21 | 网约车系统重构：如何用 DDD 重构网约车系统设计？","content":"<p>你好，我是李智慧。</p><p>软件开发是一个过程，这个过程中相关方对软件系统的认知会不断改变。当系统现状和大家的认知有严重冲突的时候，不重构系统就难以继续开发下去。此外，在持续的需求迭代过程中，代码本身会逐渐腐坏，变得僵硬、脆弱、难以维护，需求开发周期越来越长，bug却越来越多，系统也必须要进行重构。</p><p>我们在前一篇讨论的Udi网约车系统经过了几年的快速发展，随着业务越来越复杂，功能模块越来越多，开发团队越来越庞大，整个系统也越来越笨拙、难以维护。以前两三天就能开发完成的新功能，现在要几个星期，开发人员多了，工作效率却下降了。</p><p>Udi使用微服务架构，开始的时候业务比较简单，几个微服务就可以搞定。后面随着功能越来越多，微服务也越来越多，微服务之间的依赖关系也变得越来越复杂，常常要开发一个小功能，却需要在好几个微服务中进行修改。后来开发人员为了避免这种复杂性，倾向于把所有功能都写在一个微服务里，结果整个系统架构又开始退回到单体架构。</p><p>基于以上原因，我们准备对Udi进行一次重构，核心就是要解决微服务设计的混乱，梳理、重构出更加清晰的微服务边界和微服务之间的依赖关系。我们准备使用DDD，即领域驱动设计的方法进行这次重构。</p><!-- [[[read_end]]] --><p>那么，领域驱动设计的核心思想是什么？设计的一般方法是什么？如何将这些方法应用到Udi的重构过程中？这些就是我们今天要解决的主要问题。</p><h2>DDD的一般方法</h2><p>领域是一个组织所做的事情以及其包含的一切，通俗地说，就是组织的业务范围和做事方式，也是软件开发的目标范围。比如对于淘宝这样一个以电子商务为主要业务的组织，C2C电子商务就是它的领域。<strong>领域驱动设计就是从领域出发，分析领域内模型及其关系，进而设计软件系统的方法。</strong></p><p>但是如果我们说要对C2C电子商务这个领域进行建模设计，那么这个范围就太大了，不知道该如何下手。所以通常的做法是把整个领域拆分成多个<strong>子域</strong>，比如用户、商品、订单、库存、物流、发票等。强相关的多个子域组成一个<strong>限界上下文</strong>，它是对业务领域范围的描述，对于系统实现而言，限界上下文相当于是一个子系统或者一个模块。限界上下文和子域共同组成组织的领域，如下：</p><p><img src=\"https://static001.geekbang.org/resource/image/29/fb/297fa4e7e64e9fcdf91e600f28d56cfb.jpg?wh=1280x917\" alt=\"图片\"></p><p>不同的限界上下文，也就是不同的子系统或者模块之间会有各种的交互合作。如何设计这些交互合作呢？DDD使用<strong>上下文映射图</strong>来完成，如下：</p><p><img src=\"https://static001.geekbang.org/resource/image/b6/a6/b661e8bfabe968794ae80d01b81f73a6.jpg?wh=1920x593\" alt=\"图片\"></p><p>在DDD中，领域模型对象也被称为<strong>实体</strong>。先通过业务分析，识别出实体对象，然后通过相关的业务逻辑，设计实体的属性和方法。而限界上下文和上下文映射图则是微服务设计的关键，通常在实践中，限界上下文被设计为微服务，而上下文映射图就是微服务之间的依赖关系。具体设计过程如下图：</p><p><img src=\"https://static001.geekbang.org/resource/image/cc/31/cc4aac65f24bfcfd2f965973070f3331.jpg?wh=1920x1279\" alt=\"图片\"></p><p>首先，领域专家和团队一起讨论分析业务领域，确认业务期望，将业务分解成若干个业务场景。然后，针对每个场景画UML活动图，活动图中包含泳道，通过高内聚原则对功能逻辑不断调整，使功能和泳道之间的归属关系变得更加清晰合理。<strong>这些泳道最终就是限界上下文，泳道内的功能就是将来微服务的功能边界，泳道之间的调用流程关系，就是将来微服务之间的依赖关系，即上下文映射图。</strong></p><p>但是，这个状态的泳道还不能直接转化成限界上下文。有些限界上下文可能会很大，有些依赖关系可能会比较强。而一个限界上下文不应该超过一个团队的职责范围，因为根据康威定律：组织<strong>架构决定系统架构</strong>，两个团队维护一个微服务，必然会将这个微服务搞成事实上的两个微服务。所以，我们还需要根据团队特性、过往的工作职责、技能经验，重新对泳道图进行调整，使其符合团队的职责划分，这时候才得到限界上下文。</p><p>在这个限界上下文基础上，考虑技术框架、非功能需求、服务重用性等因素，进一步进行调整，就得到最终的限界上下文设计，形成我们的微服务架构设计。</p><p>我们将遵循上述DDD方法过程对Udi微服务进行重新分析设计，并进行系统重构。</p><h2>Udi DDD 重构设计</h2><p>首先分析我们的业务领域，通过头脑/事件风暴的形式，收集领域内的所有事件/命令，并识别事件/命令的发起方即对应的实体。最后识别出来的实体以及相关活动如下表：</p><p><img src=\"https://static001.geekbang.org/resource/image/09/29/09e53a303016b07a49da69aec0145729.jpg?wh=1920x1412\" alt=\"图片\"></p><p>基于核心实体模型，绘制实体关系图，如下：</p><p><img src=\"https://static001.geekbang.org/resource/image/4f/81/4fc8ebe70deae09e043194b27e15ed81.png?wh=768x493\" alt=\"图片\"></p><p>在实体间关系明确且完整的前提下，我们就可以针对各个业务场景，绘制场景活动图。活动图比较多，这里仅用拼车场景作为示例，如下：</p><p><img src=\"https://static001.geekbang.org/resource/image/86/1b/8611bb0513340f6a0a46946ba34a8f1b.png?wh=1254x2248\" alt=\"图片\"></p><p>依据各种重要场景的活动图，参考团队职责范围，结合微服务重用性考虑及非功能需求，产生限界上下文如下表：</p><p><img src=\"https://static001.geekbang.org/resource/image/59/93/597f2ccf6576d1acc4868600b66eea93.jpg?wh=1920x1709\" alt=\"图片\"></p><p>针对每个限界上下文进一步设计其内部的聚合、聚合根、实体、值对象、功能边界。以订单限界上下文为例：</p><p><img src=\"https://static001.geekbang.org/resource/image/99/e9/99452cc01307c21866a662ae1fe37ce9.jpg?wh=1920x1591\" alt=\"图片\"></p><p>上述订单实体的属性和功能如下表：</p><p><img src=\"https://static001.geekbang.org/resource/image/ec/29/ecd11ebbec719a3b1beed7d7f8103029.jpg?wh=1920x954\" alt=\"图片\"></p><p>最后，在实现层面，设计对应的微服务架构如下图：</p><p><img src=\"https://static001.geekbang.org/resource/image/e3/41/e3efb97e6376f10774d99dd8d5cd8b41.png?wh=1188x998\" alt=\"图片\"></p><p>这是一个基于领域模型的分层架构，最下层为聚合根对象，组合实体与值对象，完成核心业务逻辑处理。上面一层为领域服务层，主要调用聚合根对象完成订单子域的业务，根据业务情况，也会在这一层和其他微服务通信，完成更复杂的、超出当前实体职责的业务，所以这一层也是一个聚合层。</p><p>再上面一层是应用服务层，将实体的功能封装成各种服务，供各种应用场景调用。而最上面是一个接口层，提供微服务调用接口。</p><h2>小结</h2><p>领域驱动设计很多时候雷声大，雨点小，说起来各种术语满天飞，真正开发实践的时候又无从下手。这节的案例来自一个真实落地的DDD重构设计文档，你可以参考这个文档，按图索骥，应用到自己的开发实践中。</p><p>既然说到“按图索骥”，那我认为也有必要在这一节的最后，帮你画一个更有概括性的DDD重构路线图，我们把使用DDD进行系统重构的过程分为以下六步：</p><ol>\n<li>讨论当前系统存在的问题，发现问题背后的根源。比如：架构与代码混乱，需求迭代困难，部署麻烦，bug率逐渐升高；微服务边界不清晰，调用依赖关系复杂，团队职责混乱。</li>\n<li>针对问题分析具体原因。比如：微服务 A 太庞大，微服务B和C职责不清，团队内业务理解不一致，内部代码设计不良，硬编码和耦合太多。</li>\n<li>重新梳理业务流程，明确业务术语，进行DDD战略设计，具体又可以分为三步。<br>\na. 进行头脑风暴，分析业务现状和期望，构建领域语言；<br>\nb. 画泳道活动图、结合团队特性设计限界上下文；<br>\nc. 根据架构方案和非功能需求确定微服务设计。</li>\n<li>针对当前系统实现和DDD设计不匹配的地方，设计微服务重构方案。比如：哪些微服务需要重新开发，哪些微服务的功能需要从A调整到B，哪些微服务需要分拆。</li>\n<li>DDD技术验证。针对比较重要、问题比较多的微服务进行重构打样，设计聚合根、实体、值对象，重构关键代码，验证设计是否合理以及团队能否驾驭DDD。</li>\n<li>任务分解与持续重构。在尽量不影响业务迭代的前提下，按照重构方案，将重构开发和业务迭代有机融合。</li>\n</ol><h2>思考题</h2><p>你认为DDD最大的价值是什么？如何才能成功落地DDD？</p><p>欢迎在评论区分享你的思考，我们共同进步。</p><blockquote>\n<p>【编辑温馨提示】4月10日12点前，提交<a href=\"http://https://time.geekbang.org/column/article/495175\">期中测试</a>作业，有机会获得老师精心准备的奖励哦~</p>\n</blockquote>","neighbors":{"left":{"article_title":"20 | 网约车系统设计：怎样设计一个日赚 5 亿的网约车系统？","id":501543},"right":{"article_title":"22 | 大数据平台设计：如何用数据为用户创造价值？","id":501586}},"comments":[{"had_liked":false,"id":344942,"user_name":"wkq2786130","can_delete":false,"product_type":"c1","uid":1256821,"ip_address":"","ucode":"0F3A9DF9928C67","user_header":"https://static001.geekbang.org/account/avatar/00/13/2d/75/e7c29de4.jpg","comment_is_top":false,"comment_ctime":1651889630,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5946856926","product_id":100105701,"comment_content":"我理解DDD的价值在于 <br>1. 把职责思考清楚，边界划分相对清楚一些，能够降低耦合度，复杂度;<br>2. 能够把一些能力沉淀下来，进行复用。","like_count":1},{"had_liked":false,"id":361146,"user_name":"Elroy","can_delete":false,"product_type":"c1","uid":1630622,"ip_address":"北京","ucode":"B9578EE4A3C98C","user_header":"https://static001.geekbang.org/account/avatar/00/18/e1/9e/4107db55.jpg","comment_is_top":false,"comment_ctime":1667273313,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1667273313","product_id":100105701,"comment_content":"我认为 DDD 有很多隐性价值：<br>提高产研团队的协同效率（统一语言、共同建模）；<br>减少团队间的耦合（模块和团队的边界划分更合理）；<br>提高新服务的开发效率（融入DDD的开发规范、项目代码骨架）；<br>对团队成长也很有帮助（领域知识的传承和沉淀、重视设计质量、重视思考和抽象能力、提升业务研发人员的成就感）；<br>","like_count":0},{"had_liked":false,"id":360745,"user_name":"不要挑战自己的智商","can_delete":false,"product_type":"c1","uid":2063114,"ip_address":"美国","ucode":"4910FF07C35DC5","user_header":"https://static001.geekbang.org/account/avatar/00/1f/7b/0a/b65e1fae.jpg","comment_is_top":false,"comment_ctime":1666802401,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1666802401","product_id":100105701,"comment_content":"超级用心的一课","like_count":0},{"had_liked":false,"id":354986,"user_name":"🐺 🐶","can_delete":false,"product_type":"c1","uid":2704444,"ip_address":"四川","ucode":"84712B0436EC6F","user_header":"https://static001.geekbang.org/account/avatar/00/29/44/3c/8bb9e8b4.jpg","comment_is_top":false,"comment_ctime":1660956149,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1660956149","product_id":100105701,"comment_content":"领域可以是一个业务过程，也可以是整体业务过程的细分子域，换个角度就是用适合的技术手段满足业务需求，将一个整体拆分为一个一个的界限上下文就是将复杂的东西细分，根据各个界限上下文绘制流程图，将每个流程清晰的展现出来，这样就从一个整体到细节的拆分，也能找到各个界限上下文之间的关系，感觉似乎有一点理解了皮毛，但是又似乎吃的是冰淇淋，眼前是一座冰山，结合自身工作再细嚼慢咽一番","like_count":0},{"had_liked":false,"id":345729,"user_name":"～风铃～","can_delete":false,"product_type":"c1","uid":1116191,"ip_address":"","ucode":"4EEA12C17BA913","user_header":"https://static001.geekbang.org/account/avatar/00/11/08/1f/b24a561d.jpg","comment_is_top":false,"comment_ctime":1652528856,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1652528856","product_id":100105701,"comment_content":"怎么感觉熟悉了业务，根据经验就能拆分，好像不用DDD。可能在不熟悉业务的情况下要划分服务，用DDD就有用。","like_count":0},{"had_liked":false,"id":341859,"user_name":"My","can_delete":false,"product_type":"c1","uid":1336427,"ip_address":"","ucode":"B2528724F99280","user_header":"https://static001.geekbang.org/account/avatar/00/14/64/6b/5b23d6f0.jpg","comment_is_top":false,"comment_ctime":1649865393,"is_pvip":false,"replies":[{"id":"124898","content":"如果现在有人拿了几十亿找你做技术合伙人，一起搞个网约车平台，你一下就懂了~~~","user_name":"作者回复","user_name_real":"编辑","uid":"1007349","ctime":1649908044,"ip_address":"","comment_id":341859,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1649865393","product_id":100105701,"comment_content":"似乎懂了，又似乎没懂！！愁人","like_count":0,"discussions":[{"author":{"id":1007349,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/5e/f5/018907ac.jpg","nickname":"李智慧","note":"","ucode":"8C9980C438AFD1","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":562921,"discussion_content":"如果现在有人拿了几十亿找你做技术合伙人，一起搞个网约车平台，你一下就懂了~~~","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1649908045,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1336427,"avatar":"https://static001.geekbang.org/account/avatar/00/14/64/6b/5b23d6f0.jpg","nickname":"My","note":"","ucode":"B2528724F99280","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":563240,"discussion_content":"哈哈，那可能不用几十亿。我一直做开发，感觉私思维被局限啦，有关最后那个订单微服务分层架构来说，我思来想去，如何在代码服务层面去落地。可是感觉还是无从下手","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649952464,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":341456,"user_name":"叹暮","can_delete":false,"product_type":"c1","uid":2187360,"ip_address":"","ucode":"3BED1AF31F98BF","user_header":"https://static001.geekbang.org/account/avatar/00/21/60/60/32f4df47.jpg","comment_is_top":false,"comment_ctime":1649638178,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1649638178","product_id":100105701,"comment_content":"所以老师能不能花一节课讲讲ddd的价值勒","like_count":0},{"had_liked":false,"id":341337,"user_name":"HappyHasson","can_delete":false,"product_type":"c1","uid":2911084,"ip_address":"","ucode":"B84CC43E349CFA","user_header":"https://static001.geekbang.org/account/avatar/00/2c/6b/6c/3e80afaf.jpg","comment_is_top":false,"comment_ctime":1649556316,"is_pvip":true,"replies":[{"id":"124784","content":"意识到问题的存在和并知道了解决问题的方向，就已经成功了一半","user_name":"作者回复","user_name_real":"编辑","uid":"1007349","ctime":1649641339,"ip_address":"","comment_id":341337,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1649556316","product_id":100105701,"comment_content":"这节课平时没接触过，或者没有仔细思考过，个人感觉挺难的，现在我们系统中确实有设计混乱的问题，但是个人感觉还是无从下手","like_count":0,"discussions":[{"author":{"id":1007349,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/5e/f5/018907ac.jpg","nickname":"李智慧","note":"","ucode":"8C9980C438AFD1","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":561443,"discussion_content":"意识到问题的存在和并知道了解决问题的方向，就已经成功了一半","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649641339,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":2911084,"avatar":"https://static001.geekbang.org/account/avatar/00/2c/6b/6c/3e80afaf.jpg","nickname":"HappyHasson","note":"","ucode":"B84CC43E349CFA","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1007349,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/5e/f5/018907ac.jpg","nickname":"李智慧","note":"","ucode":"8C9980C438AFD1","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":561642,"discussion_content":"嗯嗯，再仔细想想，想不通的继续请教老师","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649688802,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":561443,"ip_address":""},"score":561642,"extra":""}]}]},{"had_liked":false,"id":340915,"user_name":"Steven","can_delete":false,"product_type":"c1","uid":1253652,"ip_address":"","ucode":"3FE64459842015","user_header":"https://static001.geekbang.org/account/avatar/00/13/21/14/423a821f.jpg","comment_is_top":false,"comment_ctime":1649228739,"is_pvip":false,"replies":[{"id":"124669","content":"1 UML 组件图 <br>2 派单","user_name":"作者回复","user_name_real":"编辑","uid":"1007349","ctime":1649296196,"ip_address":"","comment_id":340915,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1649228739","product_id":100105701,"comment_content":"这节课的话题太大，有两个问题请教老师：<br><br>1，子域和限界上下文的图，用什么工具可以画？<br>2，订单上下文部分，订单聚合不应该有的功能（比如抢单）要放在什么上下文里面？<br>","like_count":0,"discussions":[{"author":{"id":1007349,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/5e/f5/018907ac.jpg","nickname":"李智慧","note":"","ucode":"8C9980C438AFD1","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":560354,"discussion_content":"1 UML 组件图 \n2 派单","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649296196,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":340854,"user_name":"peter","can_delete":false,"product_type":"c1","uid":1058183,"ip_address":"","ucode":"261C3FC001DE2D","user_header":"https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg","comment_is_top":false,"comment_ctime":1649203198,"is_pvip":true,"replies":[{"id":"124610","content":"1 小创业公司意味着业务比较简单，将来的业务变化可能性大，用DDD确实收益不大。但是说DDD比较难也不恰当，DDD的进入门槛比较高，其实熟练了也并不难。","user_name":"作者回复","user_name_real":"作者","uid":"1007349","ctime":1649209230,"ip_address":"","comment_id":340854,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1649203198","product_id":100105701,"comment_content":"请教老师两个问题啊：<br>Q1：DDD比较难吧，小的创业公司，限于技术水平，是不是不宜采用DDD来设计系统？<br>Q2：能否讲一下红包系统设计？","like_count":0,"discussions":[{"author":{"id":1007349,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/5e/f5/018907ac.jpg","nickname":"李智慧","note":"","ucode":"8C9980C438AFD1","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":560124,"discussion_content":"1 小创业公司意味着业务比较简单，将来的业务变化可能性大，用DDD确实收益不大。但是说DDD比较难也不恰当，DDD的进入门槛比较高，其实熟练了也并不难。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649209230,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1227789,"avatar":"https://static001.geekbang.org/account/avatar/00/12/bc/0d/e65ca230.jpg","nickname":"👻","note":"","ucode":"1648C82AC73C1D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":566896,"discussion_content":"小公司还是别搞这些闹眼子的东西吧，钱多烧得慌么😄","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1650792628,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}