{"id":71634,"title":"18 | å¦‚ä½•è‡ªå·±å¼€å‘ä¸€ä¸ªå¤§æ•°æ®SQLå¼•æ“ï¼Ÿ","content":"<p>ä»ä»Šå¤©å¼€å§‹æˆ‘ä»¬å°±è¿›å…¥äº†ä¸“æ çš„ç¬¬ä¸‰ä¸ªæ¨¡å—ï¼Œä¸€èµ·æ¥çœ‹çœ‹å¤§æ•°æ®å¼€å‘å®è·µè¿‡ç¨‹ä¸­çš„é—¨é“ã€‚å­¦ä¹ ä¸€æ ·æŠ€æœ¯ï¼Œå¦‚æœåªæ˜¯ä½œä¸ºå­¦ä¹ è€…ï¼Œè¢«åŠ¨æ¥å—æ€»æ˜¯å›°éš¾çš„ã€‚<strong>ä½†å¦‚æœä»å¼€å‘è€…çš„è§†è§’çœ‹ï¼Œå¾ˆå¤šä¸œè¥¿å°±è±ç„¶å¼€æœ—äº†ï¼Œæ˜ç™½äº†åŸç†ï¼Œæœ‰æ—¶ç”šè‡³ä¸éœ€è¦å­¦ä¹ ï¼Œé¡ºç€åŸç†å°±å¯ä»¥æ¨å¯¼å‡ºå„ç§å®ç°ç»†èŠ‚</strong>ã€‚</p><p>å„ç§çŸ¥è¯†ä»è¡¨è±¡ä¸Šçœ‹ï¼Œæ€»æ˜¯æ‚ä¹±æ— ç« çš„ï¼Œå¦‚æœåªæ˜¯å­¦ä¹ è¿™äº›ç¹æ‚çš„çŸ¥è¯†ç‚¹ï¼Œå›ºç„¶è‡ªå·±çš„çŸ¥è¯†é¢æ˜¯æœ‰é™çš„ï¼Œå¹¶ä¸”é‡åˆ°é—®é¢˜çš„åº”å˜èƒ½åŠ›ä¹Ÿå¾ˆéš¾æé«˜ã€‚æ‰€ä»¥æœ‰äº›é«˜æ‰‹çœ‹èµ·æ¥ä¼¼ä¹æ— æ‰€ä¸çŸ¥ï¼Œä¸è®ºè°ˆè®ºèµ·ä»€ä¹ˆæŠ€æœ¯ï¼Œéƒ½èƒ½å¤´å¤´æ˜¯é“ï¼Œå…¶å®å¹¶ä¸æ˜¯ä»–ä»¬å­¦ä¹ ã€æŒæ¡äº†æ‰€æœ‰æŠ€æœ¯ï¼Œè€Œæ˜¯ä»–ä»¬æ˜¯åœ¨è°ˆåˆ°è¿™ä¸ªé—®é¢˜çš„æ—¶å€™ï¼Œæ‰å¼€å§‹è¿›è¡Œæ¨å¯¼ï¼Œå¹¶è¿…é€Ÿå¾—å‡ºç»“è®ºã€‚</p><p>æˆ‘åœ¨Intelçš„æ—¶å€™ï¼Œé¢è¯•è¿‡ä¸€ä¸ªäº¤å¤§çš„å®ä¹ ç”Ÿï¼Œå¥¹å¤§æ¦‚åªå­¦è¿‡ä¸€ç‚¹MapReduceçš„åŸºæœ¬çŸ¥è¯†ï¼Œæˆ‘é—®å¥¹å¦‚ä½•ç”¨MapReduceå®ç°æ•°æ®åº“çš„joinæ“ä½œï¼Œå¯ä»¥æ˜æ˜¾çœ‹å‡ºå¥¹æ²¡å­¦ä¹ è¿‡è¿™éƒ¨åˆ†çŸ¥è¯†ã€‚å¥¹è¯´ï¼šæˆ‘æƒ³ä¸€ä¸‹ï¼Œç„¶åç›¯ç€æ¡Œå­çœ‹äº†ä¸¤ä¸‰ç§’çš„æ—¶é—´ï¼Œå°±å¼€å§‹å›ç­”ï¼ŒåŸºæœ¬è·ŸHiveçš„å®ç°æœºåˆ¶ä¸€æ ·ã€‚ä»å¥¹çš„å›ç­”å°±èƒ½çœ‹å‡ºè¿™ä¸ªå¥³ç”Ÿå°±æ˜¯ä¸€ä¸ªé«˜æ‰‹ï¼Œé«˜æ‰‹ä¸ä¸€å®šè¦å¾ˆèµ„æ·±ã€ç»éªŒä¸°å¯Œï¼ŒæŠŠæ¡ä½äº†æŠ€æœ¯çš„æ ¸å¿ƒæœ¬è´¨ï¼ŒæŒæ¡äº†å¿«é€Ÿåˆ†ææ¨å¯¼çš„èƒ½åŠ›ï¼Œèƒ½å¤Ÿè¿…é€Ÿå°†è‡ªå·±çš„çŸ¥è¯†æŠ€èƒ½æ¨è¿›åˆ°é™Œç”Ÿçš„é¢†åŸŸï¼Œå°±æ˜¯é«˜æ‰‹ã€‚</p><p>è¿™ä¹Ÿæ˜¯æˆ‘è¿™ä¸ªä¸“æ çš„ç›®çš„ï¼Œè®²è¿°å¤§æ•°æ®æŠ€æœ¯çš„æ ¸å¿ƒåŸç†ï¼Œåˆ†äº«ä¸€äº›é«˜æ•ˆçš„æ€è€ƒå’Œæ€ç»´æ–¹å¼ï¼Œå¸®åŠ©ä½ æ„å»ºèµ·è‡ªå·±çš„æŠ€æœ¯çŸ¥è¯†ä½“ç³»ã€‚</p><!-- [[[read_end]]] --><p>åœ¨è¿™ä¸ªæ¨¡å—é‡Œï¼Œæˆ‘å°†ä»¥å¤§æ•°æ®å¼€å‘è€…çš„è§†è§’ï¼Œè®²è¿°å¤§æ•°æ®å¼€å‘éœ€è¦å…³æ³¨çš„å„ç§é—®é¢˜ï¼Œä»¥åŠç›¸åº”çš„è§£å†³æ–¹æ¡ˆã€‚å¸Œæœ›ä½ å¯ä»¥è¿›å…¥æˆ‘çš„è§’è‰²ï¼Œè·³å‡ºçº·ç¹å¤æ‚çš„çŸ¥è¯†è¡¨è±¡ï¼ŒæŒæ¡æ ¸å¿ƒåŸç†å’Œæ€ç»´æ–¹å¼ï¼Œè¿›è€Œèä¼šè´¯é€šå„ç§æŠ€æœ¯ï¼Œå†é€šè¿‡å„ç§å®è·µè®­ç»ƒï¼Œæœ€ç»ˆæˆä¸ºçœŸæ­£çš„é«˜æ‰‹ã€‚</p><p>å‰é¢ä¸“æ æˆ‘ä»¬æåˆ°è¿‡ï¼Œç¨‹åºå‘˜çš„ä¸‰å¤§æ¢¦æƒ³ï¼Œä¹Ÿå°±æ˜¯å¼€å‘æ•°æ®åº“ã€æ“ä½œç³»ç»Ÿå’Œç¼–è¯‘å™¨ã€‚ä»Šå¤©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªæ”¯æŒæ ‡å‡†SQLè¯­æ³•çš„å¤§æ•°æ®ä»“åº“å¼•æ“çš„è®¾è®¡å¼€å‘æ¡ˆä¾‹ï¼Œçœ‹çœ‹<span class=\"orange\">å¦‚ä½•è‡ªå·±å¼€å‘ä¸€ä¸ªå¤§æ•°æ®SQLå¼•æ“</span>ã€‚</p><p>åœ¨å­¦ä¹ ä»Šå¤©çš„å†…å®¹å‰ï¼Œæˆ‘ä»¬å…ˆå›é¡¾ä¸€ä¸‹å‰é¢è®¨è®ºè¿‡çš„å¤§æ•°æ®ä»“åº“Hiveã€‚ä½œä¸ºä¸€ä¸ªæˆåŠŸçš„å¤§æ•°æ®ä»“åº“ï¼Œå®ƒå°†SQLè¯­å¥è½¬æ¢æˆMapReduceæ‰§è¡Œè¿‡ç¨‹ï¼Œå¹¶æŠŠå¤§æ•°æ®åº”ç”¨çš„é—¨æ§›ä¸‹é™åˆ°æ™®é€šæ•°æ®åˆ†æå¸ˆå’Œå·¥ç¨‹å¸ˆå°±å¯ä»¥å¾ˆå¿«ä¸Šæ‰‹çš„åœ°æ­¥ã€‚è¿™éƒ¨åˆ†å†…å®¹å¦‚æœä½ å¿˜è®°äº†ï¼Œå¯ä»¥è¿”å›<a href=\"http://time.geekbang.org/column/article/69459\">ä¸“æ ç¬¬11æœŸ</a>å¤ä¹ ä¸€ä¸‹ã€‚</p><p>ä½†æ˜¯Hiveä¹Ÿæœ‰è‡ªå·±çš„é—®é¢˜ï¼Œç”±äºå®ƒä½¿ç”¨è‡ªå·±å®šä¹‰çš„Hive QLè¯­æ³•ï¼Œè¿™å¯¹å·²ç»ç†Ÿæ‚‰Oracleç­‰ä¼ ç»Ÿæ•°æ®ä»“åº“çš„åˆ†æå¸ˆæ¥è¯´ï¼Œè¿˜æ˜¯æœ‰ä¸€å®šçš„ä¸Šæ‰‹éš¾åº¦ã€‚ç‰¹åˆ«æ˜¯å¾ˆå¤šä¼ä¸šä½¿ç”¨ä¼ ç»Ÿæ•°æ®ä»“åº“è¿›è¡Œæ•°æ®åˆ†æå·²ç»ç”±æ¥å·²ä¹…ï¼Œæ²‰æ·€äº†å¤§é‡çš„SQLè¯­å¥ï¼Œå¹¶ä¸”è¿™äº›SQLç»è¿‡å¤šå¹´çš„ä¿®æ”¹æ‰“ç£¨ï¼Œéå¸¸åºå¤§ä¹Ÿéå¸¸å¤æ‚ã€‚æˆ‘æ›¾ç»è§è¿‡æŸé“¶è¡Œçš„ä¸€æ¡ç»Ÿè®¡æŠ¥è¡¨SQLï¼Œæ‰“å°å‡ºæ¥è¶³è¶³ä¸¤å¼ A4çº¸ã€‚è¿™æ ·çš„SQLå…‰æ˜¯å®Œå…¨ç†è§£å¯èƒ½å°±è¦èŠ±å¾ˆé•¿æ—¶é—´ï¼Œå†è½¬åŒ–æˆHive QLå°±æ›´åŠ è´¹åŠ›ï¼Œè¿˜ä¸è¯´è½¬åŒ–ä¿®æ”¹è¿‡ç¨‹ä¸­å¯èƒ½å¼•å…¥çš„bugã€‚</p><p>2012å¹´é‚£ä¼šï¼Œæˆ‘è¿˜åœ¨Inteläºšå¤ªç ”å‘ä¸­å¿ƒå¤§æ•°æ®å›¢é˜Ÿï¼Œå½“æ—¶å›¢é˜Ÿå†³å®šå¼€å‘ä¸€æ¬¾èƒ½å¤Ÿæ”¯æŒæ ‡å‡†æ•°æ®åº“SQLçš„å¤§æ•°æ®ä»“åº“å¼•æ“ï¼Œå¸Œæœ›è®©é‚£äº›åœ¨Oracleä¸Šè¿è¡Œè‰¯å¥½çš„SQLå¯ä»¥ç›´æ¥è¿è¡Œåœ¨Hadoopä¸Šï¼Œè€Œä¸éœ€è¦é‡å†™æˆHive QLã€‚è¿™å°±æ˜¯åæ¥çš„<a href=\"http://github.com/intel-hadoop/project-panthera-ase\">Panthera</a>é¡¹ç›®ã€‚</p><p>åœ¨å¼€å‘Pantheraå‰ï¼Œæˆ‘ä»¬åˆ†æä¸€ä¸‹Hiveçš„ä¸»è¦å¤„ç†è¿‡ç¨‹ï¼Œå¤§ä½“ä¸Šåˆ†æˆä¸‰æ­¥ï¼š</p><p>1.å°†è¾“å…¥çš„Hive QLç»è¿‡è¯­æ³•è§£æå™¨è½¬æ¢æˆHiveæŠ½è±¡è¯­æ³•æ ‘ï¼ˆHive ASTï¼‰ã€‚<br>\n2.å°†Hive ASTç»è¿‡è¯­ä¹‰åˆ†æå™¨è½¬æ¢æˆMapReduceæ‰§è¡Œè®¡åˆ’ã€‚<br>\n3.å°†ç”Ÿæˆçš„MapReduceæ‰§è¡Œè®¡åˆ’å’ŒHiveæ‰§è¡Œå‡½æ•°ä»£ç æäº¤åˆ°Hadoopä¸Šæ‰§è¡Œã€‚</p><p>Pantheraçš„è®¾è®¡æ€è·¯æ˜¯ä¿ç•™Hiveè¯­ä¹‰åˆ†æå™¨ä¸åŠ¨ï¼Œæ›¿æ¢Hiveè¯­æ³•è§£æå™¨ï¼Œä½¿å…¶å°†æ ‡å‡†SQLè¯­å¥è½¬æ¢æˆHiveè¯­ä¹‰åˆ†æå™¨èƒ½å¤Ÿå¤„ç†çš„HiveæŠ½è±¡è¯­æ³•æ ‘ã€‚ç”¨å›¾å½¢æ¥è¡¨ç¤ºçš„è¯ï¼Œæ˜¯ç”¨çº¢æ¡†å†…çš„éƒ¨åˆ†ä»£æ›¿é»‘æ¡†å†…åŸæ¥Hiveçš„éƒ¨åˆ†ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/72/b0/7236e0335857fd75d7d773634eaf51b0.png?wh=1114*324\" alt=\"\"></p><p>çº¢æ¡†å†…çš„ç»„ä»¶æˆ‘ä»¬é‡æ–°å¼€å‘è¿‡ï¼Œæµ…è“è‰²çš„æ˜¯æˆ‘ä»¬ä½¿ç”¨çš„ä¸€ä¸ªå¼€æºçš„SQLè¯­æ³•è§£æå™¨ï¼Œå°†æ ‡å‡†SQLè§£ææˆæ ‡å‡†SQLæŠ½è±¡è¯­æ³•æ ‘ï¼ˆSQL ASTï¼‰ï¼Œåé¢æ·±è“è‰²çš„å°±æ˜¯å›¢é˜Ÿè‡ªå·±å¼€å‘çš„SQLæŠ½è±¡è¯­æ³•æ ‘åˆ†æä¸è½¬æ¢å™¨ï¼Œå°†SQL ASTè½¬æ¢æˆHive ASTã€‚</p><p>é‚£ä¹ˆæ ‡å‡†SQLå’ŒHive QLçš„å·®åˆ«åœ¨å“ªé‡Œå‘¢ï¼Ÿ</p><p>æ ‡å‡†SQLå’ŒHive QLçš„å·®åˆ«ä¸»è¦æœ‰ä¸¤ä¸ªæ–¹é¢ï¼Œä¸€ä¸ªæ˜¯è¯­æ³•è¡¨è¾¾æ–¹å¼ï¼ŒHive QLè¯­æ³•å’Œæ ‡å‡†SQLè¯­æ³•ç•¥æœ‰ä¸åŒï¼›å¦ä¸€ä¸ªæ˜¯Hive QLæ”¯æŒçš„è¯­æ³•å…ƒç´ æ¯”æ ‡å‡†SQLè¦å°‘å¾ˆå¤šï¼Œæ¯”å¦‚ï¼Œæ•°æ®ä»“åº“é¢†åŸŸä¸»è¦çš„æµ‹è¯•é›†<a href=\"http://www.tpc.org/tpch/\">TPC-H</a>æ‰€æœ‰çš„SQLè¯­å¥Hiveéƒ½ä¸æ”¯æŒã€‚å°¤å…¶æ˜¯Hiveä¸æ”¯æŒå¤æ‚çš„åµŒå¥—å­æŸ¥è¯¢ï¼Œè€Œå¯¹äºæ•°æ®ä»“åº“åˆ†æè€Œè¨€ï¼ŒåµŒå¥—å­æŸ¥è¯¢å‡ ä¹æ˜¯æ— å¤„ä¸åœ¨çš„ã€‚æ¯”å¦‚ä¸‹é¢è¿™æ ·çš„SQLï¼Œåœ¨whereæŸ¥è¯¢æ¡ä»¶existesé‡Œé¢åŒ…å«äº†å¦ä¸€æ¡SQLè¯­å¥ã€‚</p><pre><code>select o_orderpriority, count(*) as order_count \nfrom orders \nwhere o_orderdate &gt;= date '[DATE]' \nand o_orderdate &lt; date '[DATE]' + interval '3' month \nand exists \n( select * from lineitem \nwhere l_orderkey = o_orderkey and l_commitdate &lt; l_receiptdate ) \ngroup by o_orderpriority order by o_orderpriority;\n</code></pre><p>æ‰€ä»¥å¼€å‘æ”¯æŒæ ‡å‡†SQLè¯­æ³•çš„SQLå¼•æ“çš„éš¾ç‚¹ï¼Œå°±å˜æˆ<strong>å¦‚ä½•å°†å¤æ‚çš„åµŒå¥—å­æŸ¥è¯¢æ¶ˆé™¤æ‰</strong>ï¼Œä¹Ÿå°±æ˜¯whereæ¡ä»¶é‡Œä¸åŒ…å«selectã€‚</p><p>SQLçš„ç†è®ºåŸºç¡€æ˜¯å…³ç³»ä»£æ•°ï¼Œè€Œå…³ç³»ä»£æ•°çš„ä¸»è¦æ“ä½œåªæœ‰5ç§ï¼Œåˆ†åˆ«æ˜¯å¹¶ã€å·®ã€ç§¯ã€é€‰æ‹©ã€æŠ•å½±ã€‚æ‰€æœ‰çš„SQLè¯­å¥æœ€åéƒ½èƒ½ç”¨è¿™5ç§æ“ä½œç»„åˆå®Œæˆã€‚è€Œä¸€ä¸ªåµŒå¥—å­æŸ¥è¯¢å¯ä»¥ç­‰ä»·è½¬æ¢æˆä¸€ä¸ªè¿æ¥ï¼ˆjoinï¼‰æ“ä½œã€‚</p><p>æ¯”å¦‚è¿™æ¡SQL</p><pre><code>select s_grade from staff where s_city not in (select p_city from proj where s_empname=p_pname)\n</code></pre><p>è¿™æ˜¯ä¸€ä¸ªåœ¨whereæ¡ä»¶é‡ŒåµŒå¥—äº†not inå­æŸ¥è¯¢çš„SQLè¯­å¥ï¼Œå®ƒå¯ä»¥ç”¨left outer joinå’Œleft semi joinè¿›è¡Œç­‰ä»·è½¬æ¢ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼Œè¿™æ˜¯Pantheraè‡ªåŠ¨è½¬æ¢å®Œæˆå¾—åˆ°çš„ç­‰ä»·SQLã€‚è¿™æ¡SQLè¯­å¥ä¸å†åŒ…å«åµŒå¥—å­æŸ¥è¯¢ï¼Œ</p><pre><code>select panthera_10.panthera_1 as s_grade from (select panthera_1, panthera_4, panthera_6, s_empname, s_city from (select s_grade as panthera_1, s_city as panthera_4, s_empname as panthera_6, s_empname as s_empname, s_city as s_city from staff) panthera_14 left outer join (select panthera_16.panthera_7 as panthera_7, panthera_16.panthera_8 as panthera_8, panthera_16.panthera_9 as panthera_9, panthera_16.panthera_12 as panthera_12, panthera_16.panthera_13 as panthera_13 from (select panthera_0.panthera_1 as panthera_7, panthera_0.panthera_4 as panthera_8, panthera_0.panthera_6 as panthera_9, panthera_0.s_empname as panthera_12, panthera_0.s_city as panthera_13 from (select s_grade as panthera_1, s_city as panthera_4, s_empname as panthera_6, s_empname, s_city from staff) panthera_0 left semi join (select p_city as panthera_3, p_pname as panthera_5 from proj) panthera_2 on (panthera_0.panthera_4 = panthera_2.panthera_3) and (panthera_0.panthera_6 = panthera_2.panthera_5) where true) panthera_16 group by panthera_16.panthera_7, panthera_16.panthera_8, panthera_16.panthera_9, panthera_16.panthera_12, panthera_16.panthera_13) panthera_15 on ((((panthera_14.panthera_1 &lt;=&gt; panthera_15.panthera_7) and (panthera_14.panthera_4 &lt;=&gt; panthera_15.panthera_8)) and (panthera_14.panthera_6 &lt;=&gt; panthera_15.panthera_9)) and (panthera_14.s_empname &lt;=&gt; panthera_15.panthera_12)) and (panthera_14.s_city &lt;=&gt; panthera_15.panthera_13) where ((((panthera_15.panthera_7 is null) and (panthera_15.panthera_8 is null)) and (panthera_15.panthera_9 is null)) and (panthera_15.panthera_12 is null)) and (panthera_15.panthera_13 is null)) panthera_10 ;\n</code></pre><p>é€šè¿‡å¯è§†åŒ–å·¥å…·å°†ä¸Šé¢ä¸¤æ¡SQLçš„è¯­æ³•æ ‘å±•ç¤ºå‡ºæ¥ï¼Œæ˜¯è¿™æ ·çš„ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/2e/2b/2ebce9da37fff01e5701342699b69f2b.png?wh=590*346\" alt=\"\"></p><p>è¿™æ˜¯åŸå§‹çš„SQLæŠ½è±¡è¯­æ³•æ ‘ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/3a/15/3aafd8cf731eb6fd5b0e125847084f15.png?wh=1440*232\" alt=\"\"></p><p>è¿™æ˜¯ç­‰ä»·è½¬æ¢åçš„æŠ½è±¡è¯­æ³•æ ‘ï¼Œå†…å®¹å¤ªå¤šè¢«å‹ç¼©å¾—æ— æ³•çœ‹æ¸…ï¼Œä¸è¿‡ä½ å¯ä»¥æ„Ÿå—ä¸€ä¸‹ï¼ˆç¬‘ï¼‰ã€‚</p><p>é‚£ä¹ˆï¼Œåœ¨ç¨‹åºè®¾è®¡ä¸Šå¦‚ä½•å®ç°è¿™æ ·å¤æ‚çš„è¯­æ³•è½¬æ¢å‘¢ï¼Ÿå½“æ—¶Pantheraé¡¹ç›®ç»„åˆä½¿ç”¨äº†å‡ ç§ç»å…¸çš„è®¾è®¡æ¨¡å¼ï¼Œæ¯ä¸ªè¯­æ³•ç‚¹è¢«å°è£…åˆ°ä¸€ä¸ªç±»é‡Œå»å¤„ç†ï¼Œæ¯ä¸ªç±»é€šå¸¸ä¸è¿‡å‡ åè¡Œä»£ç ï¼Œè¿™æ ·æ•´ä¸ªç¨‹åºéå¸¸ç®€å•ã€æ¸…çˆ½ã€‚å¦‚æœåœ¨æµ‹è¯•è¿‡ç¨‹ä¸­é‡åˆ°ä¸æ”¯æŒçš„è¯­æ³•ç‚¹ï¼Œåªéœ€ä¸ºè¿™ä¸ªè¯­æ³•ç‚¹æ–°å¢åŠ ä¸€ä¸ªç±»å³å¯ï¼Œå›¢é˜Ÿåä½œä¸ä»£ç ç»´æŠ¤éå¸¸å®¹æ˜“ã€‚</p><p>ä½¿ç”¨è£…é¥°æ¨¡å¼çš„è¯­æ³•ç­‰ä»·è½¬æ¢ç±»çš„æ„é€ ï¼ŒPantheraæ¯å¢åŠ ä¸€ç§æ–°çš„è¯­æ³•è½¬æ¢èƒ½åŠ›ï¼Œåªéœ€è¦å¼€å‘ä¸€ä¸ªæ–°çš„Transformerç±»ï¼Œç„¶åæ·»åŠ åˆ°ä¸‹é¢çš„æ„é€ å‡½æ•°ä»£ç é‡Œå³å¯ã€‚</p><pre><code>   private static SqlASTTransformer tf =\n      new RedundantSelectGroupItemTransformer(\n      new DistinctTransformer(\n      new GroupElementNormalizeTransformer(\n      new PrepareQueryInfoTransformer(\n      new OrderByTransformer(\n      new OrderByFunctionTransformer(\n      new MinusIntersectTransformer(\n      new PrepareQueryInfoTransformer(\n      new UnionTransformer(\n      new Leftsemi2LeftJoinTransformer(\n      new CountAsteriskPositionTransformer(\n      new FilterInwardTransformer(\n      //use leftJoin method to handle not exists for correlated\n      new CrossJoinTransformer(\n      new PrepareQueryInfoTransformer(\n      new SubQUnnestTransformer(\n      new PrepareFilterBlockTransformer(\n      new PrepareQueryInfoTransformer(\n      new TopLevelUnionTransformer(\n      new FilterBlockAdjustTransformer(\n      new PrepareFilterBlockTransformer(\n      new ExpandAsteriskTransformer(\n      new PrepareQueryInfoTransformer(\n      new CrossJoinTransformer(\n      new PrepareQueryInfoTransformer(\n      new ConditionStructTransformer(\n      new MultipleTableSelectTransformer(\n      new WhereConditionOptimizationTransformer(\n      new PrepareQueryInfoTransformer(\n      new InTransformer(\n      new TopLevelUnionTransformer(\n      new MinusIntersectTransformer(\n      new NaturalJoinTransformer(\n      new OrderByNotInSelectListTransformer(\n      new RowNumTransformer(\n      new BetweenTransformer(\n      new UsingTransformer(\n      new SchemaDotTableTransformer(\n      new NothingTransformer())))))))))))))))))))))))))))))))))))));\n</code></pre><p>è€Œåœ¨å…·ä½“çš„Transformerç±»ä¸­ï¼Œåˆ™ä½¿ç”¨ç»„åˆæ¨¡å¼å¯¹æŠ½è±¡è¯­æ³•æ ‘ASTè¿›è¡Œéå†ï¼Œä»¥ä¸‹ä¸ºBetweenè¯­æ³•èŠ‚ç‚¹çš„éå†ã€‚æˆ‘ä»¬çœ‹åˆ°ä½¿ç”¨ç»„åˆæ¨¡å¼è¿›è¡Œæ ‘çš„éå†ä¸éœ€è¦ç”¨é€’å½’ç®—æ³•ï¼Œå› ä¸ºé€’å½’çš„ç‰¹æ€§å·²ç»éšè—åœ¨æ ‘çš„ç»“æ„é‡Œé¢äº†ã€‚</p><pre><code>  @Override\n  protected void transform(CommonTree tree, TranslateContext context) throws SqlXlateException {\n    tf.transformAST(tree, context);\n    trans(tree, context);\n  }\n\n  void trans(CommonTree tree, TranslateContext context) {\n    // deep firstly\n    for (int i = 0; i &lt; tree.getChildCount(); i++) {\n      trans((CommonTree) (tree.getChild(i)), context);\n    }\n    if (tree.getType() == PantheraExpParser.SQL92_RESERVED_BETWEEN) {\n      transBetween(false, tree, context);\n    }\n    if (tree.getType() == PantheraExpParser.NOT_BETWEEN) {\n      transBetween(true, tree, context);\n    }\n  }\n</code></pre><p>å°†ç­‰ä»·è½¬æ¢åçš„æŠ½è±¡è¯­æ³•æ ‘ASTå†è¿›ä¸€æ­¥è½¬æ¢æˆHiveæ ¼å¼çš„æŠ½è±¡è¯­æ³•æ ‘ï¼Œå°±å¯ä»¥äº¤ç»™Hiveçš„è¯­ä¹‰åˆ†æå™¨å»å¤„ç†äº†ï¼Œä»è€Œä¹Ÿå°±å®ç°äº†å¯¹æ ‡å‡†SQLçš„æ”¯æŒã€‚</p><p>å½“æ—¶Facebookä¸ºäº†è¯æ˜Hiveå¯¹æ•°æ®ä»“åº“çš„æ”¯æŒï¼ŒFacebookçš„å·¥ç¨‹å¸ˆæ‰‹å·¥å°†TPC-Hçš„æµ‹è¯•SQLè½¬æ¢æˆHive QLï¼Œæˆ‘ä»¬å°†è¿™äº›æ‰‹å·¥Hive QLå’ŒPantheraè¿›è¡Œå¯¹æ¯”æµ‹è¯•ï¼Œä¸¤è€…æ€§èƒ½å„æœ‰æ‰€é•¿ï¼Œæ€»ä½“ä¸Šä¸ç›¸ä¸Šä¸‹ï¼Œè¿™è¯´æ˜Pantheraè‡ªåŠ¨è¿›è¡Œè¯­æ³•åˆ†æå’Œè½¬æ¢çš„æ•ˆç‡è¿˜æ˜¯ä¸é”™çš„ã€‚</p><p>Pantheraï¼ˆASEï¼‰å’ŒFacebookæ‰‹å·¥Hive QLå¯¹æ¯”æµ‹è¯•ç»“æœå¦‚ä¸‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/c1/6f/c1866cede6eb563481d917b0f06b176f.png?wh=1014*598\" alt=\"\"></p><p>äº‹å®ä¸Šï¼Œæ ‡å‡†SQLè¯­æ³•é›†çš„è¯­æ³•ç‚¹éå¸¸å¤šï¼Œæˆ‘ä»¬ç»è¿‡è¿‘ä¸¤å¹´çš„åŠªåŠ›ï¼Œç»å°½è„‘æ±è¿›è¡Œå„ç§å…³ç³»ä»£æ•°ç­‰ä»·å˜å½¢ï¼Œä¾ç„¶æ²¡æœ‰å…¨éƒ¨é€‚é…æ‰€æœ‰çš„æ ‡å‡†SQLè¯­æ³•ã€‚</p><p>æˆ‘åœ¨å¼€å‘Pantheraçš„æ—¶å€™ï¼ŒæŸ¥é˜…äº†å¾ˆå¤šå…³äºSQLå’Œæ•°æ®åº“çš„ç½‘ç«™å’Œæ–‡æ¡£ï¼Œå‘ç°åœ¨æˆ‘ä»¬è€³ç†Ÿèƒ½è¯¦çš„é‚£äº›ä¸»æµæ•°æ®åº“ä¹‹å¤–è¿˜æœ‰å¾ˆå¤šåä¸è§ç»ä¼ çš„æ•°æ®åº“ï¼Œæ­¤å¤–ï¼Œè¿˜æœ‰å¤§é‡çš„å…³äºSQLçš„è¯­æ³•è§£æå™¨ã€æµ‹è¯•æ•°æ®å’Œè„šæœ¬é›†ã€å„ç§å‘¨è¾¹å·¥å…·ã€‚æˆ‘ä»¬ç»å¸¸çœ‹åˆ°çš„MySQLã€Oracleè¿™äº›äº§å“ä»…ä»…æ˜¯æ•´ä¸ªæ•°æ®åº“ç”Ÿæ€ä½“ç³»çš„å†°å±±ä¸€è§’ã€‚è¿˜æœ‰å¾ˆå¤šä¼˜ç§€çš„æ•°æ®åº“åœ¨ç«äº‰ä¸­è½äº†ä¸‹é£ã€é»˜é»˜æ— é—»ï¼Œè€Œæ›´å¤šçš„æ”¯æ’‘èµ·è¿™äº›ä¼˜ç§€æ•°æ®åº“çš„è®ºæ–‡ã€å·¥å…·ï¼Œéä¸šå†…äººå£«å‡ ä¹é—»æ‰€æœªé—»ã€‚</p><p>è¿™ä¸ªè®¤è¯†ç»™äº†æˆ‘å¾ˆå¤§è§¦åŠ¨ï¼Œæˆ‘ä¸€ç›´æœŸå¾…æˆ‘ä»¬ä¸­å›½äººèƒ½å¼€å‘å‡ºè‡ªå·±çš„æ“ä½œç³»ç»Ÿã€æ•°æ®åº“ã€ç¼–ç¨‹è¯­è¨€ï¼Œä¹Ÿçœ‹åˆ°æœ‰å¾ˆå¤šäººå‰ä»†åç»§æŠ•å…¥å…¶ä¸­ã€‚ä½†æ˜¯è¿™ä¹ˆå¤šå¹´è¿‡å»äº†ï¼Œå¤§éƒ¨åˆ†åŠªåŠ›æƒ¨æ·¡æ”¶åœºï¼Œå°éƒ¨åˆ†ç»“æœæ²¦è½ä¸ºç¬‘æŸ„ï¼Œæˆä¸ºäººä»¬é¥­åçš„è°ˆèµ„ã€‚æˆ‘æ›¾ç»æ€è€ƒè¿‡ï¼Œä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿ</p><p>å¼€å‘Pantheraä¹‹åï¼Œæˆ‘æƒ³ï¼Œæˆ‘ä»¬å›½å®¶è™½ç„¶ä»äº‹è½¯ä»¶å¼€å‘çš„äººæ•°å¾ˆå¤šï¼Œä½†æ˜¯ç»å¤§å¤šæ•°éƒ½åœ¨åšæœ€é¡¶å±‚çš„åº”ç”¨å¼€å‘ï¼Œåº•å±‚æŠ€æœ¯å¼€å‘å’Œç ”ç©¶çš„äººå¤ªå°‘ï¼Œåšå‡ºæ¥çš„æˆæœä¹Ÿå¤ªå°‘ã€‚æˆ‘ä»¬åœ¨ä¸€ä¸ªç¼ºä¹å‘¨è¾¹ç”Ÿæ€ä½“ç³»ã€æ²¡æœ‰è¶³å¤Ÿçš„ç«äº‰äº§å“çš„æƒ…å†µä¸‹ï¼Œå°±æƒ³ç›´æ¥å¼€å‘å‡ºè‡ªå·±æœ‰å½±å“åŠ›çš„æ“ä½œç³»ç»Ÿã€æ•°æ®åº“ã€ç¼–ç¨‹è¯­è¨€ï¼Œæ— å¼‚äºæƒ³åœ¨æ²™æ¼ é‡Œç§å‡ºå‡ æ£µå‚å¤©å¤§æ ‘ã€‚</p><p>ä¸è¿‡ï¼Œåº†å¹¸çš„æ˜¯ï¼Œæˆ‘ä¹Ÿçœ‹åˆ°è¶Šæ¥è¶Šå¤šæœ‰å…¨çƒå½±å“åŠ›çš„åº•å±‚æŠ€æœ¯äº§å“ä¸­å‡ºç°ä¸­å›½äººçš„èº«å½±ï¼Œå°è‰å·²ç»åœ¨é»˜é»˜ç”Ÿé•¿ï¼Œå‡ä»¥æ—¶æ—¥ï¼Œæ–™æƒ³å¿…æœ‰å¤§æ ‘å‡ºç°ã€‚</p><p>ä»Šå¤©æˆ‘è®²çš„æ˜¯ä¸€ä¸ªSQLå¼•æ“æ˜¯å¦‚ä½•è®¾è®¡å‡ºæ¥çš„ï¼Œä¹Ÿè®¸åœ¨ä½ çš„å·¥ä½œå‡ ä¹ä¸å¯èƒ½å»å¼€å‘SQLå¼•æ“ï¼Œä½†æ˜¯äº†è§£è¿™äº›åŸºç¡€çš„çŸ¥è¯†ï¼Œäº†è§£ä¸€äº›è®¾è®¡çš„æŠ€å·§ï¼Œå¯¹ä½ ç”¨å¥½æ•°æ®åº“ï¼Œå¼€å‘æ›´åŠ çµæ´»ã€æœ‰å¼¹æ€§çš„ç³»ç»Ÿä¹Ÿä¼šå¾ˆæœ‰å¸®åŠ©ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>SQLæ³¨å…¥æ˜¯ä¸€ç§å¸¸è§çš„Webæ”»å‡»æ‰‹æ®µï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ”»å‡»è€…åœ¨HTTPè¯·æ±‚ä¸­æ³¨å…¥æ¶æ„SQLå‘½ä»¤ï¼ˆdrop table users;ï¼‰ï¼ŒæœåŠ¡å™¨ç”¨è¯·æ±‚å‚æ•°æ„é€ æ•°æ®åº“SQLå‘½ä»¤æ—¶ï¼Œæ¶æ„SQLè¢«ä¸€èµ·æ„é€ ï¼Œå¹¶åœ¨æ•°æ®åº“ä¸­æ‰§è¡Œã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/8c/4f/8c92076fc8b4005ce075734e9641cd4f.png?wh=1352*566\" alt=\"\"></p><p>ä½†æ˜¯JDBCçš„PrepareStatementå¯ä»¥é˜»æ­¢SQLæ³¨å…¥æ”»å‡»ï¼ŒMyBatisä¹‹ç±»çš„ORMæ¡†æ¶ä¹Ÿå¯ä»¥é˜»æ­¢SQLæ³¨å…¥ï¼Œè¯·ä»æ•°æ®åº“å¼•æ“çš„å·¥ä½œæœºåˆ¶è§£é‡ŠPrepareStatementå’ŒMyBatisçš„é˜²æ³¨å…¥æ”»å‡»çš„åŸç†ã€‚</p><p>æ¬¢è¿ä½ ç‚¹å‡»â€œè¯·æœ‹å‹è¯»â€ï¼ŒæŠŠä»Šå¤©çš„æ–‡ç« åˆ†äº«ç»™å¥½å‹ã€‚ä¹Ÿæ¬¢è¿ä½ å†™ä¸‹è‡ªå·±çš„æ€è€ƒæˆ–ç–‘é—®ï¼Œä¸æˆ‘å’Œå…¶ä»–åŒå­¦ä¸€èµ·è®¨è®ºã€‚</p>","neighbors":{"left":{"article_title":"17 | æ¨¡å—ç­”ç–‘ï¼šè¿™ä¹ˆå¤šæŠ€æœ¯ï¼Œåˆ°åº•éƒ½èƒ½ç”¨åœ¨ä»€ä¹ˆåœºæ™¯é‡Œï¼Ÿ","id":71366},"right":{"article_title":"19 | Sparkçš„æ€§èƒ½ä¼˜åŒ–æ¡ˆä¾‹åˆ†æï¼ˆä¸Šï¼‰","id":72056}},"comments":[{"had_liked":false,"id":50528,"user_name":"çº¯æ´çš„æ†æ¶","can_delete":false,"product_type":"c1","uid":1130512,"ip_address":"","ucode":"5E9757DE6F45DF","user_header":"https://static001.geekbang.org/account/avatar/00/11/40/10/b6bf3c3c.jpg","comment_is_top":false,"comment_ctime":1545007065,"is_pvip":true,"replies":[{"id":"18179","content":"æ¸…æ™°ğŸ‘ğŸ»","user_name":"ä½œè€…å›å¤","comment_id":50528,"uid":"1007349","ip_address":"","utype":1,"ctime":1545024618,"user_name_real":"ææ™ºæ…§"}],"discussion_count":1,"race_medal":0,"score":"138983960537","product_id":100020201,"comment_content":"åŸºäºSQLçš„å¤§æ•°æ®ä»“åº“å¼•æ“pantheraçš„æ ¸å¿ƒä»»åŠ¡æ˜¯æŠŠSQLè¯­ä¹‰ä¸Hive ASTå¯¹åº”èµ·æ¥ã€‚éš¾ç‚¹æ˜¯SQLçš„è¯­ä¹‰è¿œæ¯”Hive ASTä¸°å¯Œï¼Œè€Œå¹¸è¿çš„äº‹SQLä¸°å¯Œçš„è¡¨æ„é€»è¾‘ä¸»è¦æºäºå®ƒçš„åµŒå¥—å­è¯­å¥ï¼Œè¿™åœ¨Hive ASTä¸­æ˜¯ä¸å­˜åœ¨çš„ã€‚ä½†æ˜¯SQLçš„åµŒå¥—å­è¯­å¥å¯ä»¥ç­‰ä»·äºè‹¥å¹²jionæ“ä½œã€‚<br><br>ä¸ºäº†åœ¨å·¥ç¨‹ä¸Šé™ä½å®ç°éš¾åº¦ï¼Œç‰¹æ„ä¸ºæ¯ä¸ªè¯­æ³•ç‚¹è®¾è®¡ä¸€ä¸ªå¯¹è±¡ï¼ˆç±»ï¼‰ï¼Œè¿™å°±å°†å¤æ‚é—®é¢˜åˆ†è§£ä¸ºæ— æ•°ä¸ªå°æ­¥éª¤ï¼Œå¯ä»¥æŒç»­äº¤ä»˜ï¼Œä¸ç”¨é•¿æœŸç­‰å¾…ï¼Œä»è€Œå°†ä¸å¯èƒ½æœ‰æ¡ä»¶çš„å˜ä¸ºå¯èƒ½ã€‚è€Œä¸”æ¯ä¸ªç±»çš„ä»£ç ååˆ†ç®€æ´ï¼Œé‡åˆ°é—®é¢˜ä¹Ÿä¾¿äºå„ä¸ªå‡»ç ´ã€‚","like_count":32,"discussions":[{"author":{"id":1007349,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/5e/f5/018907ac.jpg","nickname":"ææ™ºæ…§","note":"","ucode":"8C9980C438AFD1","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433011,"discussion_content":"æ¸…æ™°ğŸ‘ğŸ»","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545024618,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":48105,"user_name":"æäºŒæœ¨","can_delete":false,"product_type":"c1","uid":1103091,"ip_address":"","ucode":"30E03BB84ADB27","user_header":"https://static001.geekbang.org/account/avatar/00/10/d4/f3/129d6dfe.jpg","comment_is_top":false,"comment_ctime":1544355360,"is_pvip":true,"replies":[{"id":"17341","content":"ä¼šï¼Œæ­£åœ¨èµ°å‘","user_name":"ä½œè€…å›å¤","comment_id":48105,"uid":"1007349","ip_address":"","utype":1,"ctime":1544488062,"user_name_real":"ææ™ºæ…§"}],"discussion_count":1,"race_medal":0,"score":"126098406944","product_id":100020201,"comment_content":"Oracleä¼šæœ‰èµ°å‘è¡°è½å—ï¼Ÿ","like_count":29,"discussions":[{"author":{"id":1007349,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/5e/f5/018907ac.jpg","nickname":"ææ™ºæ…§","note":"","ucode":"8C9980C438AFD1","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432028,"discussion_content":"ä¼šï¼Œæ­£åœ¨èµ°å‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544488062,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":47833,"user_name":"galen","can_delete":false,"product_type":"c1","uid":1119804,"ip_address":"","ucode":"93056616C4450C","user_header":"https://static001.geekbang.org/account/avatar/00/11/16/3c/eee3e6f5.jpg","comment_is_top":false,"comment_ctime":1544232679,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"100328480487","product_id":100020201,"comment_content":"å› ä¸ºSQLè¯­å¥åœ¨ç¨‹åºè¿è¡Œå‰å·²ç»è¿›è¡Œäº†é¢„ç¼–è¯‘ï¼Œåœ¨ç¨‹åºè¿è¡Œæ—¶ç¬¬ä¸€æ¬¡æ“ä½œæ•°æ®åº“ä¹‹å‰ï¼ŒSQLè¯­å¥å·²ç»è¢«æ•°æ®åº“åˆ†æï¼Œç¼–è¯‘å’Œä¼˜åŒ–ï¼Œå¯¹åº”çš„æ‰§è¡Œè®¡åˆ’ä¹Ÿä¼šç¼“å­˜ä¸‹æ¥å¹¶å…è®¸æ•°æ®åº“å·²å‚æ•°åŒ–çš„å½¢å¼è¿›è¡ŒæŸ¥è¯¢ï¼Œå½“è¿è¡Œæ—¶åŠ¨æ€åœ°æŠŠå‚æ•°ä¼ ç»™PreprareStatementæ—¶ï¼Œå³ä½¿å‚æ•°é‡Œæœ‰æ•æ„Ÿå­—ç¬¦å¦‚ or &#39;1=1&#39;ä¹Ÿæ•°æ®åº“ä¼šä½œä¸ºä¸€ä¸ªå‚æ•°ä¸€ä¸ªå­—æ®µçš„å±æ€§å€¼æ¥å¤„ç†è€Œä¸ä¼šä½œä¸ºä¸€ä¸ªSQLæŒ‡ä»¤ï¼Œå¦‚æ­¤ï¼Œå°±èµ·åˆ°äº†SQLæ³¨å…¥çš„ä½œç”¨äº†","like_count":24},{"had_liked":false,"id":47822,"user_name":"æ¬§å˜‰æƒFelix","can_delete":false,"product_type":"c1","uid":1109587,"ip_address":"","ucode":"5257A38D4D3884","user_header":"https://static001.geekbang.org/account/avatar/00/10/ee/53/b8fe4560.jpg","comment_is_top":false,"comment_ctime":1544230265,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"61673772409","product_id":100020201,"comment_content":"å¦‚æœç”¨statement jdbcä¼šç®€å•æ‹¼æ¥å­—ç¬¦ä¸²ç„¶åä½œä¸ºsqlæ‰§è¡Œ<br>preparedstatementå°±ä¼šè¿›è¡Œé¢„ç¼–è¯‘ å¯¹å…¶ä¸­çš„æ¢è¡Œç¬¦ç­‰å­—ç¬¦åšè½¬ä¹‰ å¯¹æ³¨å…¥çš„sqlä¼šèµ·åˆ°æ··æ·†çš„ä½œç”¨<br>mybatisè¿™äº›ormæ¡†æ¶ä¹Ÿæ˜¯åŸºäºpreparedstatement mybatiså°½é‡ä½¿ç”¨#å ä½ç¬¦","like_count":14},{"had_liked":false,"id":50676,"user_name":"Well_Ksun","can_delete":false,"product_type":"c1","uid":1054147,"ip_address":"","ucode":"1FAE508F2FFDB2","user_header":"https://static001.geekbang.org/account/avatar/00/10/15/c3/d8564fe2.jpg","comment_is_top":false,"comment_ctime":1545028569,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"35904766937","product_id":100020201,"comment_content":"è€å¸ˆèƒ½ç®€å•èŠèŠprestoå—ï¼Ÿä¹Ÿæ˜¯faceboookå¼€æºå‡ºæ¥çš„ã€‚æ®è¯´AWS çš„ Athena å°±æ˜¯åŸºäº Presto çš„äº§å“ã€‚","like_count":8},{"had_liked":false,"id":48014,"user_name":"æ°ä¹‹7","can_delete":false,"product_type":"c1","uid":1297232,"ip_address":"","ucode":"F7DA2E21085332","user_header":"https://static001.geekbang.org/account/avatar/00/13/cb/50/66d0bd7f.jpg","comment_is_top":false,"comment_ctime":1544322538,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"35904060906","product_id":100020201,"comment_content":"ä»è¿™ç¯‡æ–‡ç« å¼€å§‹ï¼Œå¤§æ•°æ®æŠ€æœ¯çš„ä½“ç³»æ¶æ„çŸ¥è¯†å°±å‘Šä¸€æ®µè½ï¼Œä½†å¹¶ä¸æ„å‘³ç€å·²ç»å®Œå…¨æŒæ¡ï¼Œæˆ‘éœ€è¦ä¸æ–­çš„å›é¡¾ä½“ç³»æ¶æ„åŸç†ï¼Œè¿™æ ·æ‰ä¼šæœ‰å¯èƒ½æ²¿ç€è¿™ä¸ªæ€è·¯æœ‰è‡ªå·±çš„ä¸€ç‚¹æ‹“å±•ã€‚å›åˆ°æœ¬ç¯‡å†…å®¹ï¼Œå¦‚ä½•è‡ªå·±å¼€å‘SQLå¼•æ“ï¼Œç”±äºHiveè¯­æ³•å…ƒç´ å°‘äºæ ‡å‡†SQL,ä¸”ä¸æ”¯æŒå¤æ‚çš„åµŒå¥—å­æŸ¥è¯¢ï¼Œæ‰€ä»¥å¼€å‘çš„éš¾ç‚¹å°±æ˜¯å¦‚ä½•å°†å¤æ‚åµŒå¥—æ¶ˆé™¤è½¬åŒ–æˆæ ‡å‡†SQLã€‚åœ¨è€å¸ˆè®²è¿°çš„è¿‡ç¨‹ä¸­ï¼Œä¸»è¦é€šè¿‡è£…é¥°æ¨¡å¼ç­‰ä»·è½¬åŒ–ç±»çš„æ„é€ ï¼Œå¯¹äºæ¯ä¸€ç§æ–°çš„è¯­æ³•é€šè¿‡å¼€å‘æ–°çš„Transformerç±»ï¼Œç„¶åé€šè¿‡ç»„åˆæ¨¡å¼å°†æŠ½è±¡è¯­æ³•æ ‘ASTè¿›è¡Œéå†ï¼Œæœ€åè½¬åŒ–æˆHiveæ ¼å¼çš„æŠ½è±¡è¯­æ³•æ ‘ã€‚é€šè¿‡è¿™æ ·çš„æ•´ä¸ªè¿‡ç¨‹ï¼Œå°±å®Œæˆçš„å¯¹Hiveè¯­æ³•è§£æå™¨çš„æ›¿æ¢ï¼Œä¿ç•™äº†Hiveè¯­ä¹‰åˆ†æå™¨ã€‚é€šè¿‡æœ¬èŠ‚çš„å­¦ä¹ ï¼Œæˆ‘ç›¸ä¿¡è€å¸ˆè¯´çš„è¿™å¥—æ€è·¯ï¼Œé‚£äº›æŠ€æœ¯å‰å®³çš„äººä¸æ˜¯æŒæ¡äº†æ¯ä¸€ç§æŠ€æœ¯ï¼Œè€Œæ˜¯æŒæ¡äº†æŠ€æœ¯èƒŒåçš„ä½“ç³»å’ŒåŸç†ï¼Œå½“æœ‰æ–°çš„æŠ€æœ¯å‡ºç°æ—¶ï¼ŒåŒæ ·å…ˆå»æ€è€ƒæŠ€æœ¯èƒŒåçš„åŸç†æ˜¯ä»€ä¹ˆï¼Œè¿™æ ·å°±ç®—æ²¡æœ‰å‚ä¸å…¶ä¸­çš„æŠ€æœ¯ï¼Œä¹Ÿä¼šæ–°çš„æŠ€æœ¯æœ‰ä¸€ä¸ªå¥½çš„è®¤è¯†ã€‚","like_count":8},{"had_liked":false,"id":49656,"user_name":"ååº”æ…¢","can_delete":false,"product_type":"c1","uid":1183924,"ip_address":"","ucode":"B7311CDFF2DC5D","user_header":"https://static001.geekbang.org/account/avatar/00/12/10/b4/00680e1f.jpg","comment_is_top":false,"comment_ctime":1544750431,"is_pvip":false,"replies":[{"id":"18185","content":"èµï¼Œsparkä¹Ÿå¾€è¿™ä¸ªæ–¹å‘èµ°ã€‚","user_name":"ä½œè€…å›å¤","comment_id":49656,"uid":"1007349","ip_address":"","utype":1,"ctime":1545025664,"user_name_real":"ææ™ºæ…§"}],"discussion_count":1,"race_medal":0,"score":"23019586911","product_id":100020201,"comment_content":"ä¹‹å‰æœ‰ä¸€æ®µæ—¶é—´åœ¨å­¦ä¹ å‡½æ•°å¼ç¼–ç¨‹ï¼Œå’Œsqlä¸€æ ·å±äºå‘½ä»¤å¼ç¼–ç¨‹ï¼Œæ‰€ä»¥æ„Ÿè§‰ä»¥å‡½æ•°å»è§£æsqlæ˜¯æ°´åˆ°æ¸ æˆçš„äº‹æƒ…ã€‚ä¸è¿‡è‡³ä»Šæ²¡æœ‰åŠ¨æ‰‹å»å®ç°ä¸€ä¸‹ï¼Œæ¯”è¾ƒé—æ†¾","like_count":4,"discussions":[{"author":{"id":1007349,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/5e/f5/018907ac.jpg","nickname":"ææ™ºæ…§","note":"","ucode":"8C9980C438AFD1","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432705,"discussion_content":"èµï¼Œsparkä¹Ÿå¾€è¿™ä¸ªæ–¹å‘èµ°ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545025664,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":48010,"user_name":"å‘¨ç¿”","can_delete":false,"product_type":"c1","uid":1068734,"ip_address":"","ucode":"E5E12D9B02AF59","user_header":"https://static001.geekbang.org/account/avatar/00/10/4e/be/693b5e5e.jpg","comment_is_top":false,"comment_ctime":1544321063,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"18724190247","product_id":100020201,"comment_content":"é¢„ç¼–è¯‘å°±æ˜¯sqlå‘½ä»¤çš„æ¨¡æ¿å½’æ¨¡æ¿ï¼Œå‚æ•°å½’å‚æ•°ï¼Œå‚æ•°å°±ä¸ä¼šæ··åˆåˆ°åŸsqlï¼Œæ”¹å˜åŸæœ‰çš„sqlè¯­å¥å’Œæ‰§è¡Œé€»è¾‘ã€‚é™¤äº†æ•°æ®è®¿é—®æ¡†æ¶æœ¬èº«prepare statementåŠŸèƒ½ï¼Œè¿˜å¯ä»¥ä»æœåŠ¡å±‚æ¥æ”¶å‚æ•°å°±å¯ä»¥å±è”½ã€‚","like_count":4},{"had_liked":false,"id":171683,"user_name":"è’™","can_delete":false,"product_type":"c1","uid":1327952,"ip_address":"","ucode":"A2246D60EE666B","user_header":"https://static001.geekbang.org/account/avatar/00/14/43/50/ef2cfbce.jpg","comment_is_top":false,"comment_ctime":1578991290,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"14463893178","product_id":100020201,"comment_content":"sqlé¢„ç¼–è¯‘ï¼Œåº”è¯¥æ˜¯å°†åŸå§‹sqlå…ˆè§£ææˆè¯­æ³•æ ‘ï¼Œå…¥å‚ä¸èƒ½å½±å“è¯­æ³•æ ‘çš„å˜åŒ–","like_count":4},{"had_liked":false,"id":51772,"user_name":"æ˜äº®","can_delete":false,"product_type":"c1","uid":1303015,"ip_address":"","ucode":"DAFB3424C4C2D7","user_header":"https://static001.geekbang.org/account/avatar/00/13/e1/e7/d1b2e914.jpg","comment_is_top":false,"comment_ctime":1545236223,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"14430138111","product_id":100020201,"comment_content":"å¯ä»¥æ¨èä¸€äº›SQLè§£æçš„æ¥æºäº§å“å’Œèµ„æ–™å—<br>","like_count":3,"discussions":[{"author":{"id":1066058,"avatar":"https://static001.geekbang.org/account/avatar/00/10/44/4a/b85c906d.jpg","nickname":"dashboard","note":"","ucode":"03C1433D3F2E00","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":302825,"discussion_content":"é˜¿é‡Œå¼€å‘çš„ Druid è¿æ¥æ± é‡Œæœ‰ä¸ªçº¯æ‰‹å·¥çš„ SQL è§£æå™¨","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1599039424,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":47863,"user_name":"Oliver","can_delete":false,"product_type":"c1","uid":1045957,"ip_address":"","ucode":"7B47D6031FD295","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f5/c5/c9a67483.jpg","comment_is_top":false,"comment_ctime":1544239056,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"14429140944","product_id":100020201,"comment_content":"ä¿è¯ç”¨æˆ·è¾“å…¥çš„å†…å®¹ä»…ä»…ä¸”åªèƒ½ä½œä¸ºæŸ¥è¯¢æ¡ä»¶ï¼Œæ¶‰åŠä¸€äº›å­—ç¬¦è½¬ä¹‰æ“ä½œ","like_count":3},{"had_liked":false,"id":149201,"user_name":"GeekGay","can_delete":false,"product_type":"c1","uid":1027335,"ip_address":"","ucode":"9194E1FB5964A1","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ad/07/20e7d3cf.jpg","comment_is_top":false,"comment_ctime":1573175136,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10163109728","product_id":100020201,"comment_content":"https:&#47;&#47;github.com&#47;lealone<br><br>æ¥çœ‹çœ‹æˆ‘ä»¬æ¡‚æ—çš„å¤§æ‰å­zhh-4096ï¼Œä¸€ä¸ªäººå¼€å‘6å¹´çš„åˆ—é”ææ•°æ®åº“ï¼Œä¹‹å‰ä¹Ÿå»æ·˜å®åšä¸ªä¸€ä¸¤å¹´æ•°æ®åº“äº§å“çš„ã€‚","like_count":2},{"had_liked":false,"id":47838,"user_name":"æ¯›æ¯›","can_delete":false,"product_type":"c1","uid":1249698,"ip_address":"","ucode":"AD520D0011227D","user_header":"https://static001.geekbang.org/account/avatar/00/13/11/a2/33be69a6.jpg","comment_is_top":false,"comment_ctime":1544233327,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10134167919","product_id":100020201,"comment_content":"PreparedStatementä¼šå…ˆåˆå§‹åŒ–SQLï¼Œè¯­å¥ä¸­åªæœ‰éƒ¨åˆ†å˜é‡å¯ä»¥è¢«â€œï¼Ÿâ€æ›¿ä»£ï¼Œæ‰€ä»¥sqlæ³¨å…¥çš„æ”»å‡»æ–¹å¼æ— æ•ˆã€‚","like_count":2},{"had_liked":false,"id":182842,"user_name":"îˆ± è‡£é¦Ÿé£æ‰¬îˆ°","can_delete":false,"product_type":"c1","uid":1116188,"ip_address":"","ucode":"F2F882B7678055","user_header":"https://static001.geekbang.org/account/avatar/00/11/08/1c/ef15e661.jpg","comment_is_top":false,"comment_ctime":1582873849,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5877841145","product_id":100020201,"comment_content":"è²Œä¼¼Pantheraé¡¹ç›®æ²¡æœ‰æ€èµ·ä»»ä½•æ³¢æ¾œã€‚ã€‚ã€‚","like_count":1},{"had_liked":false,"id":93860,"user_name":"éƒ½å¸‚å¤œå½’äºº","can_delete":false,"product_type":"c1","uid":1071909,"ip_address":"","ucode":"DFF59BE3D80B42","user_header":"https://static001.geekbang.org/account/avatar/00/10/5b/25/d78cc1fe.jpg","comment_is_top":false,"comment_ctime":1557642189,"is_pvip":true,"replies":[{"id":"33528","content":"äº‹å®ä¸Šæ˜¯éå¸¸ç®€å•~~ å°†éå¸¸å¤æ‚çš„SQLè¯­æ³•è½¬æ¢è§£è€¦åˆï¼Œæœ‰å…´è¶£å»ºè®®çœ‹çœ‹æ›´è¯¦ç»†çš„ä»£ç ","user_name":"ä½œè€…å›å¤","comment_id":93860,"uid":"1007349","ip_address":"","utype":1,"ctime":1557658542,"user_name_real":"ææ™ºæ…§"}],"discussion_count":2,"race_medal":0,"score":"5852609485","product_id":100020201,"comment_content":"   private static SqlASTTransformer tf =<br>      new RedundantSelectGroupItemTransformer(<br>      new DistinctTransformer(<br>      new GroupElementNormalizeTransformer(<br>      new PrepareQueryInfoTransformer(<br>      new OrderByTransformer(<br>      new OrderByFunctionTransformer(<br>      new MinusIntersectTransformer(<br>      new PrepareQueryInfoTransformer(<br>      new UnionTransformer(<br>      new Leftsemi2LeftJoinTransformer(<br>      new CountAsteriskPositionTransformer(<br>      new FilterInwardTransformer(<br>      &#47;&#47;use leftJoin method to handle not exists for correlated<br>      new CrossJoinTransformer(<br>      new PrepareQueryInfoTransformer(<br>      new SubQUnnestTransformer(<br>      new PrepareFilterBlockTransformer(<br>      new PrepareQueryInfoTransformer(<br>      new TopLevelUnionTransformer(<br>      new FilterBlockAdjustTransformer(<br>      new PrepareFilterBlockTransformer(<br>      new ExpandAsteriskTransformer(<br>      new PrepareQueryInfoTransformer(<br>      new CrossJoinTransformer(<br>      new PrepareQueryInfoTransformer(<br>      new ConditionStructTransformer(<br>      new MultipleTableSelectTransformer(<br>      new WhereConditionOptimizationTransformer(<br>      new PrepareQueryInfoTransformer(<br>      new InTransformer(<br>      new TopLevelUnionTransformer(<br>      new MinusIntersectTransformer(<br>      new NaturalJoinTransformer(<br>      new OrderByNotInSelectListTransformer(<br>      new RowNumTransformer(<br>      new BetweenTransformer(<br>      new UsingTransformer(<br>      new SchemaDotTableTransformer(<br>      new NothingTransformer())))))))))))))))))))))))))))))))))))));<br>è¿™ä¸ªç±»åœ¨ä½¿ç”¨çš„æ—¶å€™è¯¥æœ‰å¤šéº»çƒ¦å•Šï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1007349,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/5e/f5/018907ac.jpg","nickname":"ææ™ºæ…§","note":"","ucode":"8C9980C438AFD1","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":449799,"discussion_content":"äº‹å®ä¸Šæ˜¯éå¸¸ç®€å•~~ å°†éå¸¸å¤æ‚çš„SQLè¯­æ³•è½¬æ¢è§£è€¦åˆï¼Œæœ‰å…´è¶£å»ºè®®çœ‹çœ‹æ›´è¯¦ç»†çš„ä»£ç ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1557658542,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":2930333,"avatar":"https://static001.geekbang.org/account/avatar/00/2c/b6/9d/5ba3db6e.jpg","nickname":"é‡‘æ¡”ğŸŠ","note":"","ucode":"BB69BBE9886F37","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1007349,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/5e/f5/018907ac.jpg","nickname":"ææ™ºæ…§","note":"","ucode":"8C9980C438AFD1","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":554241,"discussion_content":"æ±‚è¯¦ç»†ä»£ç ï¼Œè†œæ‹œå¤§ç¥ingâ€¦â€¦","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1646278455,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":449799,"ip_address":""},"score":554241,"extra":""}]}]},{"had_liked":false,"id":72695,"user_name":"cwx0220","can_delete":false,"product_type":"c1","uid":1235642,"ip_address":"","ucode":"8DEB4BD6FA5D72","user_header":"https://static001.geekbang.org/account/avatar/00/12/da/ba/032800bc.jpg","comment_is_top":false,"comment_ctime":1551696471,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5846663767","product_id":100020201,"comment_content":"æ­£å¸¸æƒ…å†µä¸‹ï¼Œå½“httpè¯·æ±‚å‚æ•°å¸¦æœ‰sqlè¯­å¥çš„æ¡ä»¶æ—¶ï¼Œåœ¨ SQL æ³¨å…¥ä¸­ï¼Œå‚æ•°å€¼ä½œä¸º SQL æŒ‡ä»¤çš„ä¸€éƒ¨åˆ†ï¼Œä¼šè¢«æ•°æ®åº“è¿›è¡Œç¼–è¯‘&#47;è§£é‡Šæ‰§è¡Œã€‚å½“ä½¿ç”¨äº† PreparedStatementï¼Œå¸¦å ä½ç¬¦ ( ? ) çš„ sql è¯­å¥åªä¼šè¢«ç¼–è¯‘ä¸€æ¬¡ï¼Œä¹‹åæ‰§è¡Œåªæ˜¯å°†å ä½ç¬¦æ›¿æ¢ä¸ºå‚æ•°å€¼ï¼Œå¹¶ä¸ä¼šå†æ¬¡ç¼–è¯‘&#47;è§£é‡Šï¼Œå› æ­¤ä»æ ¹æœ¬ä¸Šé˜²æ­¢äº† SQL æ³¨å…¥é—®é¢˜ã€‚","like_count":1},{"had_liked":false,"id":349912,"user_name":"ç²¾æ€å…¥ç¥","can_delete":false,"product_type":"c1","uid":1035038,"ip_address":"","ucode":"D5F47DD3C7530A","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJUzv6S9wroyaa2CANjhHJcwRwNESncu4lfWTtdkMh3viaVCgEg5vMXFJ4Ne4SaDtLNd9dvkUrFqPg/132","comment_is_top":false,"comment_ctime":1656423033,"is_pvip":true,"discussion_count":0,"race_medal":1,"score":"1656423033","product_id":100020201,"comment_content":"è¿™èŠ‚æœ€å¤§çš„å¯å‘æ˜¯ï¼Œè¦ä»è®¾è®¡è€…çš„è§’åº¦å»ç†è§£ï¼Œè€Œä¸æ˜¯è€ä»¥å­¦ä¹ è€…è‡ªå±…ã€‚å¦åˆ™ï¼Œæ°¸æ— å‡ºå¤´ä¹‹æ—¥çŸ£ã€‚","like_count":0},{"had_liked":false,"id":137236,"user_name":"é’±","can_delete":false,"product_type":"c1","uid":1009652,"ip_address":"","ucode":"2C92A243A463D4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg","comment_is_top":false,"comment_ctime":1569663114,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1569663114","product_id":100020201,"comment_content":"çŒœæµ‹æ•°æ®åº“å¼•æ“ä¼šé€šè¿‡æŸç§æ–¹å¼ï¼ŒæŠŠå‚æ•°å°±ç”¨ä½œå‚æ•°è€Œä¸ä¼šä½œä¸ºSQLè¯­å¥å»æ‰§è¡Œã€‚<br>å‡¡äº‹å¸¸ç”¨å¸¦å…¥åˆ›é€ è€…çš„æ–¹å¼å»æ€è€ƒï¼Œç¡®å®æ˜¯ä¸ªå¥½æ–¹æ³•ï¼Œé•¿æœŸè®­ç»ƒä¹Ÿè®¸ï¼ŒçœŸèƒ½åšåˆ°åº–ä¸è§£ç‰›çš„æ•ˆæœã€‚","like_count":0},{"had_liked":false,"id":61504,"user_name":"å°è€é¼ ","can_delete":false,"product_type":"c1","uid":1257460,"ip_address":"","ucode":"C663A0C863A515","user_header":"https://static001.geekbang.org/account/avatar/00/13/2f/f4/2dede51a.jpg","comment_is_top":false,"comment_ctime":1547709185,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1547709185","product_id":100020201,"comment_content":"Hive QLä¹Ÿæ”¯æŒé¢„ç¼–è¯‘å—ï¼Ÿ","like_count":0},{"had_liked":false,"id":55261,"user_name":"æ¡ƒå›­æ‚ ç„¶åœ¨","can_delete":false,"product_type":"c1","uid":1017637,"ip_address":"","ucode":"704460D9CAD1CB","user_header":"https://static001.geekbang.org/account/avatar/00/0f/87/25/898dea4e.jpg","comment_is_top":false,"comment_ctime":1546080904,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1546080904","product_id":100020201,"comment_content":"è¯·é—®è€å¸ˆï¼Œå¦‚æœç›®å‰æ‰‹å¤´ä½¿ç”¨çš„hiveå¯ä»¥æ”¯æŒåµŒå¥—å­æŸ¥è¯¢ï¼Œæ˜¯å¦è¯´æ˜å·²ç»å®šåˆ¶ä¼˜åŒ–è¿‡äº†ï¼Ÿ","like_count":0}]}