{"id":167679,"title":"11 | 实验：搭建MongoDB复制集","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/geektime-mongodb-course\">https://gitee.com/geektime-geekbang/geektime-mongodb-course</a></p>","comments":[{"had_liked":false,"id":227569,"user_name":"cording","can_delete":false,"product_type":"c3","uid":1786385,"ip_address":"","ucode":"82063AEC231613","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKlllSKrpQkhSXyNj0glDoCiaMKp23ey4Fw0nr54MKKhYAIxxU7toQuukJe2qZjwUC990ojdNmeicVQ/132","comment_is_top":false,"comment_ctime":1592412674,"is_pvip":false,"replies":[{"id":88174,"content":"“但有时候主会切换成其他副节点” 你是在同一台服务器上起了几个不同端口的实例？这样的复制集&#47;副本集是没有意义的。\n\n这种场景是常见的，在mongo世界里。你的连接串要同时包含3个节点的IP：PORT，这样在切主的时候mongo的驱动会自动连到下一个主节点，你的应用程序无需处理。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1596279092,"ip_address":"","comment_id":227569,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师，请教一下采用多副本集后，主节点写，其他复制集读，但有时候主会切换成其他副节点，导致访问mongodb的端口变化，调用程序无法连接上之前主节点进行写入操作，前端调用程序该如何处理？","like_count":5,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":498691,"discussion_content":"“但有时候主会切换成其他副节点” 你是在同一台服务器上起了几个不同端口的实例？这样的复制集/副本集是没有意义的。\n\n这种场景是常见的，在mongo世界里。你的连接串要同时包含3个节点的IP：PORT，这样在切主的时候mongo的驱动会自动连到下一个主节点，你的应用程序无需处理。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596279092,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":2485664,"avatar":"https://static001.geekbang.org/account/avatar/00/25/ed/a0/cc89c128.jpg","nickname":"大聖","note":"","ucode":"5FD991D883BE78","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":545010,"discussion_content":"追问一下老师：1）关于程序去连接副本集这块后面是否有详细的介绍？2）连接字符串里包含了3个节点的IP:Port，那么对于mongo的读和写，驱动是不是有自己的机制去判断读操作是去主节点还是从节点？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641800840,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":498691,"ip_address":"","group_id":0},"score":545010,"extra":""}]}]},{"had_liked":false,"id":154029,"user_name":"公众号：程序员大兵","can_delete":false,"product_type":"c3","uid":1142526,"ip_address":"","ucode":"AD0D05864C6913","user_header":"https://static001.geekbang.org/account/avatar/00/11/6e/fe/79955244.jpg","comment_is_top":false,"comment_ctime":1574350527,"is_pvip":true,"replies":[{"id":59423,"content":"后续的事务性方面还会涉及到复制集。已定目录更新完后也会考虑根据用户的反馈追加一些内容。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1574551308,"ip_address":"","comment_id":154029,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"后续还有复制集集群的调优讲解吗","like_count":3,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":475356,"discussion_content":"后续的事务性方面还会涉及到复制集。已定目录更新完后也会考虑根据用户的反馈追加一些内容。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574551308,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":165827,"user_name":"Lee","can_delete":false,"product_type":"c3","uid":1755439,"ip_address":"","ucode":"0768D6F20B4D0E","user_header":"https://static001.geekbang.org/account/avatar/00/1a/c9/2f/5dd9f654.jpg","comment_is_top":false,"comment_ctime":1577327839,"is_pvip":false,"replies":[{"id":66853,"content":"那个命令可能不是太合适，用来做精确判断。考虑用个脚本，来做比较准确的判断会好一点，基于change stream或者oplog。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1579170413,"ip_address":"","comment_id":165827,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"oplog 类似mysql row格式log mongo   rs.printSlaveReplicationInfo()总能监控到几秒的延时， 读写分离的架构对于mongo如何使用呢","like_count":2,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":479285,"discussion_content":"那个命令可能不是太合适，用来做精确判断。考虑用个脚本，来做比较准确的判断会好一点，基于change stream或者oplog。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579170413,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":157042,"user_name":"公众号：程序员大兵","can_delete":false,"product_type":"c3","uid":1142526,"ip_address":"","ucode":"AD0D05864C6913","user_header":"https://static001.geekbang.org/account/avatar/00/11/6e/fe/79955244.jpg","comment_is_top":false,"comment_ctime":1575017082,"is_pvip":true,"replies":[{"id":60780,"content":"这个通常和你的hostname是否可以被解析相关。\n\n试试下面这个：\n\nrs.initiate({\n    _id: &quot;rs0&quot;,\n    members: [{\n        _id: 0,\n        host: &quot;localhost:28017&quot;\n    }]\n})","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1575469019,"ip_address":"","comment_id":157042,"utype":1}],"discussion_count":4,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"macos 下 rs.initiate() 执行报错，是不是macos下必须传默认配置\n{\n\t&quot;operationTime&quot; : Timestamp(0, 0),\n\t&quot;ok&quot; : 0,\n\t&quot;errmsg&quot; : &quot;No host described in new configuration 1 for replica set lbbniu maps to this node&quot;,\n\t&quot;code&quot; : 93,\n\t&quot;codeName&quot; : &quot;InvalidReplicaSetConfig&quot;,\n\t&quot;$clusterTime&quot; : {\n\t\t&quot;clusterTime&quot; : Timestamp(0, 0),\n\t\t&quot;signature&quot; : {\n\t\t\t&quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),\n\t\t\t&quot;keyId&quot; : NumberLong(0)\n\t\t}\n\t}\n}\n","like_count":2,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":476311,"discussion_content":"这个通常和你的hostname是否可以被解析相关。\n\n试试下面这个：\n\nrs.initiate({\n    _id: &amp;quot;rs0&amp;quot;,\n    members: [{\n        _id: 0,\n        host: &amp;quot;localhost:28017&amp;quot;\n    }]\n})","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1575469019,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1142526,"avatar":"https://static001.geekbang.org/account/avatar/00/11/6e/fe/79955244.jpg","nickname":"公众号：程序员大兵","note":"","ucode":"AD0D05864C6913","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":318343,"discussion_content":"有add方法","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603712832,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1165455,"avatar":"https://static001.geekbang.org/account/avatar/00/11/c8/8f/e13a6552.jpg","nickname":"polk","note":"","ucode":"1B6E948BA4DFAF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":291531,"discussion_content":"我按照这样成功启动了，问题是如何add节点呢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594863400,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2354474,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/UNC7eWZWvRyAPWUpIJicgZBWLNpkljMbgeaFVWU3QNmWgaibchc8aGFfAG7gWh7eghHSrtSuSqMDp2ibVnvE2eLJg/132","nickname":"Geek_a88948","note":"","ucode":"C7FF3099A180D6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1165455,"avatar":"https://static001.geekbang.org/account/avatar/00/11/c8/8f/e13a6552.jpg","nickname":"polk","note":"","ucode":"1B6E948BA4DFAF","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":352038,"discussion_content":"rs.add(&#34;localhost:28018&#34;)，注意replicationName名字一样","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1614581181,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":291531,"ip_address":"","group_id":0},"score":352038,"extra":""}]}]},{"had_liked":false,"id":153879,"user_name":"齐宝金","can_delete":false,"product_type":"c3","uid":1305074,"ip_address":"","ucode":"F783442C82FCC2","user_header":"https://static001.geekbang.org/account/avatar/00/13/e9/f2/9067371a.jpg","comment_is_top":false,"comment_ctime":1574324487,"is_pvip":false,"replies":[{"id":59927,"content":"第一个问题你可以先看下这篇博客：\n\nhttps:&#47;&#47;www.cnblogs.com&#47;Joans&#47;p&#47;7723554.html\n如果进一步了解的话，源码也可以尝试阅读下\n\n第二个问题也在上面的文章里有提及\n\n第三个问题：可以的，但是要通过对local库下面的一些表做个手脚。如果你用MongoDB的Ops Manager的话，它就提供这种方法来快速恢复一个从节点。\n\nhttps:&#47;&#47;docs.opsmanager.mongodb.com&#47;v1.4&#47;tutorial&#47;use-restore-to-seed-secondary&#47;\n\n其中关键的集合是system.replset 以及oplog.rs。 system.replset必须包含对应的配置（和其他节点一致）和时间戳。oplog.rs必须包含至少一条和主节点oplog一样的记录用来匹配同步点。\n","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1574813518,"ip_address":"","comment_id":153879,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师您好：\n\n第一个问题：关于复制集这块的secondary是怎么从主库来来取oplog的，实现的细节是什么？想了解这块的出发点就是作为dba的话，会经常遇到一些生产问题，需要从原理上解决问题？\n\n\n第二个问题：在local下，有几个关于副本集的集合，这几个集合是干什么用的，排查问题的时候，这几个表有什么作用？\n\n第三个问题: 我有一个副本集，现在对一个secondary进行了物理的热备，之后，想把这个节点加入现有集群,是只需要配置参数文件，add加入副本集就可以吗？如果可以加入副本集的话，他是通过哪个集合来判断从哪个时间点开始来取oplog的？\n\n","like_count":2,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":475306,"discussion_content":"第一个问题你可以先看下这篇博客：\n\nhttps://www.cnblogs.com/Joans/p/7723554.html\n如果进一步了解的话，源码也可以尝试阅读下\n\n第二个问题也在上面的文章里有提及\n\n第三个问题：可以的，但是要通过对local库下面的一些表做个手脚。如果你用MongoDB的Ops Manager的话，它就提供这种方法来快速恢复一个从节点。\n\nhttps://docs.opsmanager.mongodb.com/v1.4/tutorial/use-restore-to-seed-secondary/\n\n其中关键的集合是system.replset 以及oplog.rs。 system.replset必须包含对应的配置（和其他节点一致）和时间戳。oplog.rs必须包含至少一条和主节点oplog一样的记录用来匹配同步点。\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574813518,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1305074,"avatar":"https://static001.geekbang.org/account/avatar/00/13/e9/f2/9067371a.jpg","nickname":"齐宝金","note":"","ucode":"F783442C82FCC2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":64008,"discussion_content":"谢谢老师","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574930287,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":241783,"user_name":"cording","can_delete":false,"product_type":"c3","uid":1786385,"ip_address":"","ucode":"82063AEC231613","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKlllSKrpQkhSXyNj0glDoCiaMKp23ey4Fw0nr54MKKhYAIxxU7toQuukJe2qZjwUC990ojdNmeicVQ/132","comment_is_top":false,"comment_ctime":1597420595,"is_pvip":false,"replies":[{"id":89367,"content":"意义不是很大，你crash了一个进程，另一个进程也是没法正常服务（需要3个节点才可以有HA）。硬盘的容错直接用RAID就可以。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1597626269,"ip_address":"","comment_id":241783,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师，我们的生产环境只有一台服务器，但有2个硬盘。做一主一从副本集，有意义吗？","like_count":1,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":503840,"discussion_content":"意义不是很大，你crash了一个进程，另一个进程也是没法正常服务（需要3个节点才可以有HA）。硬盘的容错直接用RAID就可以。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597626269,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":204822,"user_name":"竹真","can_delete":false,"product_type":"c3","uid":1333642,"ip_address":"","ucode":"451C7393CBCA80","user_header":"https://static001.geekbang.org/account/avatar/00/14/59/8a/82587883.jpg","comment_is_top":false,"comment_ctime":1586479676,"is_pvip":false,"replies":[{"id":77496,"content":"1: 是的。\n2: 配置。开始搭建集群时候就要配置一下（或者通过add方法增加节点）","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1587097515,"ip_address":"","comment_id":204822,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师，您好，我有两个问题。1从节点是主动监听主节点的op log并拉取吗？ mongo 选举的时候，怎么知道集群中一共有多少节点？还有就是自己是和大多数节点互通的？","like_count":1,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":491298,"discussion_content":"1: 是的。\n2: 配置。开始搭建集群时候就要配置一下（或者通过add方法增加节点）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587097515,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":177901,"user_name":"Liam","can_delete":false,"product_type":"c3","uid":1094597,"ip_address":"","ucode":"1D15D3B64F2606","user_header":"https://static001.geekbang.org/account/avatar/00/10/b3/c5/7fc124e2.jpg","comment_is_top":false,"comment_ctime":1581524965,"is_pvip":false,"replies":[{"id":69148,"content":"复制集提供高可用，分片集在此基础上横向扩充，增加系统对数据量&#47;并发量的支持。分片集由2个或多个复制集组成。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1581647647,"ip_address":"","comment_id":177901,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师你好，复制集和分片机制有什么区别？我们可以对数据分片到不同机器上的同时保留复制集吗？部署配置方式有区别吗","like_count":1,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":483589,"discussion_content":"复制集提供高可用，分片集在此基础上横向扩充，增加系统对数据量/并发量的支持。分片集由2个或多个复制集组成。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581647647,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":165724,"user_name":"满怀","can_delete":false,"product_type":"c3","uid":1483113,"ip_address":"","ucode":"EFAC662A37D684","user_header":"https://static001.geekbang.org/account/avatar/00/16/a1/69/0ddda908.jpg","comment_is_top":false,"comment_ctime":1577289481,"is_pvip":false,"replies":[{"id":65209,"content":"你要把具体操作的步骤和输出贴出来，我才能诊断。听上去比较奇怪，切主节点正常的，但是数据应该在的","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1577970207,"ip_address":"","comment_id":165724,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师 我之前按照您的方法搭建了复制集 但是过了一星期后 期间没有启动复制集 发现主复制集从28017变成了28018，并且原先三个复制集中数据都是同步端 现在只有主复制集28018中含有数据 调用rs.statu()依然能看到另外两个复制集 但是另外两个中的数据消失了 这是怎么回事呢 我后来通过rs.remove方法删除掉了那两个空复制集 然后又rs.add将其加上 复制集中又有数据了","like_count":1,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":479268,"discussion_content":"你要把具体操作的步骤和输出贴出来，我才能诊断。听上去比较奇怪，切主节点正常的，但是数据应该在的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577970207,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":156942,"user_name":"qbit","can_delete":false,"product_type":"c3","uid":1262927,"ip_address":"","ucode":"96C70A1E47B93D","user_header":"https://static001.geekbang.org/account/avatar/00/13/45/4f/f94caf47.jpg","comment_is_top":false,"comment_ctime":1574999306,"is_pvip":false,"replies":[{"id":60779,"content":"这里面最关键的是内存大小。\n\n考虑为summary建一个covered index，然后保证你的索引能够装在内存里 （所有索引大小加起来要小于物理内存的一半那样）。\n\n如果你用分片的话，比如说4个分片，那每个分片只需要处理2.5亿（在2.5亿里寻找，4个分片同时进行），理论上肯定更快了。但是最终还是要看你总的内存的数量。\n\n","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1575468589,"ip_address":"","comment_id":156942,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"如果要在 10 亿数据中查找摘要包含 MongoDB 的记录，{summary:&#47;MongoDB&#47;}，要求 1000 毫秒内返回结果，应该怎么玩？一定要单机配置很好的集群吗？单机配置一般，个数可以无限增加可以玩吗？分片是为了解决这类问题吗？","like_count":1,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":476276,"discussion_content":"这里面最关键的是内存大小。\n\n考虑为summary建一个covered index，然后保证你的索引能够装在内存里 （所有索引大小加起来要小于物理内存的一半那样）。\n\n如果你用分片的话，比如说4个分片，那每个分片只需要处理2.5亿（在2.5亿里寻找，4个分片同时进行），理论上肯定更快了。但是最终还是要看你总的内存的数量。\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1575468589,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1262927,"avatar":"https://static001.geekbang.org/account/avatar/00/13/45/4f/f94caf47.jpg","nickname":"qbit","note":"","ucode":"96C70A1E47B93D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":72952,"discussion_content":"好的，谢谢。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1575544735,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":153936,"user_name":"нáпの゛","can_delete":false,"product_type":"c3","uid":1130666,"ip_address":"","ucode":"834FA877EFBAF7","user_header":"https://static001.geekbang.org/account/avatar/00/11/40/aa/49bbb007.jpg","comment_is_top":false,"comment_ctime":1574334206,"is_pvip":false,"replies":[{"id":59386,"content":"oplog 和 binlog类似。并且在压力超大的时候，也有可能在从节点造成一些延迟。当然mongodb可以用多线程同时来会放","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1574519387,"ip_address":"","comment_id":153936,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"老师你好，\n之前试过用mysql 做读写分离，开了binlog做主从同步。遇到一种情况，主库写太频繁(load file操作，没有事务)，从库同步延迟越来越大。\noplog的原理是否也是记录成文件之后传输到从节点，由专门线程回放？\nmongodb是否也会出现这种问题？","like_count":1,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":475330,"discussion_content":"oplog 和 binlog类似。并且在压力超大的时候，也有可能在从节点造成一些延迟。当然mongodb可以用多线程同时来会放","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574519387,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":153666,"user_name":"Oracleblog","can_delete":false,"product_type":"c3","uid":1043729,"ip_address":"","ucode":"DC9C5E721A55E6","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ed/11/c296d424.jpg","comment_is_top":false,"comment_ctime":1574295508,"is_pvip":false,"replies":[{"id":59395,"content":"可以的 - 如果能用hostname最好","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1574520942,"ip_address":"","comment_id":153666,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"老师你好，请问下配置复制集的时候用IP+端口的方式可以吗？","like_count":1,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":475241,"discussion_content":"可以的 - 如果能用hostname最好","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574520942,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":226184,"user_name":"fusion","can_delete":false,"product_type":"c3","uid":1388534,"ip_address":"","ucode":"83D68543435122","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoMGQgj0b7PWkqB2dL2hejUrvkQA5NNHw4EibMu23XhLnHVR9vrK9jicG5EfG9BzHVyW4dY5czuc9iaw/132","comment_is_top":false,"comment_ctime":1591973273,"is_pvip":false,"replies":[{"id":88235,"content":"从你docker里面你可以ping 通172.18.0.3吗?\n\n看下rs.config() 里面的members.hostname 必须在3个节点之间互相可以解析访问。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1596358847,"ip_address":"","comment_id":226184,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"老师我的3个mong实例是通过docker启动的，mogo shell登录需要用户验证的，类似这样启动mogo实例，“docker run --name mongo-1 -p 27017:27017 -v &#47;root&#47;docker-data&#47;mongo&#47;db1:&#47;data&#47;db -e MONGO_INITDB_ROOT_USERNAME=admin -e MONGO_INITDB_ROOT_PASSWORD=admin -d mongo-mine --replSet rs1”，\n进行rs.add的时候报错如下，帮我看看怎么解决：\nrs1:PRIMARY&gt; rs.add(&quot;172.18.0.3:27017&quot;)\n{\n        &quot;operationTime&quot; : Timestamp(1591972438, 1),\n        &quot;ok&quot; : 0,\n        &quot;errmsg&quot; : &quot;Quorum check failed because not enough voting nodes responded; required 2 but only the following 1 voting nodes responded: 1bd920a129ca:27017; the following nodes did not respond affirmatively: 172.18.0.3:27017 failed with command replSetHeartbeat requires authentication&quot;,\n        &quot;code&quot; : 74,\n        &quot;codeName&quot; : &quot;NodeNotFound&quot;,\n        &quot;$clusterTime&quot; : {\n                &quot;clusterTime&quot; : Timestamp(1591972438, 1),\n                &quot;signature&quot; : {\n                        &quot;hash&quot; : BinData(0,&quot;hawAdjgwqgubLaS4UzQys+XbKMs=&quot;),\n                        &quot;keyId&quot; : NumberLong(&quot;6837467323960393730&quot;)\n                }\n        }\n}\n","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":498138,"discussion_content":"从你docker里面你可以ping 通172.18.0.3吗?\n\n看下rs.config() 里面的members.hostname 必须在3个节点之间互相可以解析访问。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596358847,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":185901,"user_name":"bb","can_delete":false,"product_type":"c3","uid":1770466,"ip_address":"","ucode":"9E480BA11D4D89","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q3auHgzwzM4fPb1ic9W9IHrz4fxE9t2y9BqRxdibllS5pQfnNiabvib7kc6Ql7YJnVh2PPzxrpXqN3eMsCyvoZrxfw/132","comment_is_top":false,"comment_ctime":1583722581,"is_pvip":false,"replies":[{"id":72146,"content":"顺序是：\n1） 关掉mongo 服务\n2）以复制集模式重新启动mongo（加replSet 参数)\n3)  初始化复制集\n4）增加第二（三）个节点（新的节点）\n5） 等待initialSync 完成\n\n这个时候你的原来的节点会是主节点。\n","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1584002657,"ip_address":"","comment_id":185901,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"请问，在做复制架构是在现有的环境做，这样是会自动将现有的节点设置为主吗？还是要将现有节点数据同步到新节点上。还是要在初始化的时候指定优先级","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":486544,"discussion_content":"顺序是：\n1） 关掉mongo 服务\n2）以复制集模式重新启动mongo（加replSet 参数)\n3)  初始化复制集\n4）增加第二（三）个节点（新的节点）\n5） 等待initialSync 完成\n\n这个时候你的原来的节点会是主节点。\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584002657,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":180363,"user_name":"密码123456","can_delete":false,"product_type":"c3","uid":1126593,"ip_address":"","ucode":"9889463CC0EA71","user_header":"https://static001.geekbang.org/account/avatar/00/11/30/c1/2dde6700.jpg","comment_is_top":false,"comment_ctime":1582267762,"is_pvip":false,"replies":[{"id":70067,"content":"如果可以接受从节点读，那么可以使用  readPreference: secondary&#47;nearest (后续有讲如何使用）。这种方式可以使用更多的节点来支持读操作。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1582341084,"ip_address":"","comment_id":180363,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"我有多个复制集，当我想提升读能力的时候。是不是在读的时候，要动态切换这些复制集的地址？","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":484627,"discussion_content":"如果可以接受从节点读，那么可以使用  readPreference: secondary/nearest (后续有讲如何使用）。这种方式可以使用更多的节点来支持读操作。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582341084,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":166626,"user_name":"wu526","can_delete":false,"product_type":"c3","uid":1022129,"ip_address":"","ucode":"69282EB175B48E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/98/b1/f89a84d0.jpg","comment_is_top":false,"comment_ctime":1577523505,"is_pvip":false,"replies":[{"id":65199,"content":"可能的问题：\n1. 没有为各个节点配置KeyFile，或者\n2. 启用认证之后没有创建管理员账户。rs.add()需要权限才能执行。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1577967727,"ip_address":"","comment_id":166626,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"老师您好，我在搭建集群的过程中遇到一个问题。 如果我集群中的所有节点都设置了密码，在使用rs.add(&quot;host:port&quot;)时会报没有权限。此时我该如何解决呢？","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":479563,"discussion_content":"可能的问题：\n1. 没有为各个节点配置KeyFile，或者\n2. 启用认证之后没有创建管理员账户。rs.add()需要权限才能执行。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577967727,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":164405,"user_name":"dream","can_delete":false,"product_type":"c3","uid":1117793,"ip_address":"","ucode":"65B33D32FA8BE9","user_header":"https://static001.geekbang.org/account/avatar/00/11/0e/61/ae68f8eb.jpg","comment_is_top":false,"comment_ctime":1576980104,"is_pvip":false,"replies":[{"id":62952,"content":"不能用local 库。那个是系统保留的。用任意其他库都可以。如 use test\n","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1577182549,"ip_address":"","comment_id":164405,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"老师，请问一下，我按照你的操作是没有问题的。但是在复制集搭建成功后做如下操作，从节点却获取不到数据时怎么回事呀？\n\n主节点：\nmongo --port 28017\nuse local\ndb.test.insert({ a:1 })\n\n从节点：\nmongo --port 28018\nrs.slaveOk()\nuse local\n\n此时在从节点使用 db.test.find() 却获取不到数据是怎么回事呢？复制集的状态是没有问题的。","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":478750,"discussion_content":"不能用local 库。那个是系统保留的。用任意其他库都可以。如 use test\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577182549,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":161513,"user_name":"cliff","can_delete":false,"product_type":"c3","uid":1637634,"ip_address":"","ucode":"8A311E94AD47FD","user_header":"https://static001.geekbang.org/account/avatar/00/18/fd/02/4c261784.jpg","comment_is_top":false,"comment_ctime":1576220534,"is_pvip":false,"replies":[{"id":66774,"content":"先记录下来了，谢谢反馈","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1579132605,"ip_address":"","comment_id":161513,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"老板能不能加一节课说mongo s的配置","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":477743,"discussion_content":"先记录下来了，谢谢反馈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579132605,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":159496,"user_name":"罗罗","can_delete":false,"product_type":"c3","uid":1202791,"ip_address":"","ucode":"43F3403300597A","user_header":"https://static001.geekbang.org/account/avatar/00/12/5a/67/b01d0f41.jpg","comment_is_top":false,"comment_ctime":1575638361,"is_pvip":false,"replies":[{"id":66765,"content":"Windows下搭建的命令在材料里面都已经给出。\n\n密码验证已经在第三章安全加固那一节里讲述。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1579130871,"ip_address":"","comment_id":159496,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"老师有讲解在window下如何搭建吗，如果有密码验证该如何做","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":477078,"discussion_content":"Windows下搭建的命令在材料里面都已经给出。\n\n密码验证已经在第三章安全加固那一节里讲述。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579130871,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":158219,"user_name":"stringbo","can_delete":false,"product_type":"c3","uid":1395154,"ip_address":"","ucode":"B27A6F611444BB","user_header":"https://wx.qlogo.cn/mmopen/vi_32/DYAIOgq83eq5IibxSqcZYFzIhR2HDF86YfsKZkAARSrFKO2qNLMFgBmaYPxOy8rne14BL4ibtptibDcDULZn1W6icA/132","comment_is_top":false,"comment_ctime":1575352823,"is_pvip":false,"replies":[{"id":60786,"content":"1： 这个是你假设的问题还是真实的问题？ 节点之间用的是一个heartbeat，主节点如果还能响应heartbeat说明可能没有假死。触发选举的话可以考虑直接关掉主节点。\n\n2） reconfig 原则上不会触发全量同步，除非是加入新的节点","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1575470937,"ip_address":"","comment_id":158219,"utype":1}],"discussion_count":2,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"老师您好：\n      问题1:目前有个5节点的副本集，其中有一个主节点服务器假死，能PING通，除PING能通外任何命令都执行不了，因为能PING通，所以其他从节点认为主节点还存活，不能进行选举，但此时服务已经不可用了。想问下，通过什么方式可以强制触发选举？（注：在不能重启服务器的情况下）\n     问题2:如果在从节点强制执行副本集reconfig，force：true，会引发副本集的全量同步吗？","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":476679,"discussion_content":"1： 这个是你假设的问题还是真实的问题？ 节点之间用的是一个heartbeat，主节点如果还能响应heartbeat说明可能没有假死。触发选举的话可以考虑直接关掉主节点。\n\n2） reconfig 原则上不会触发全量同步，除非是加入新的节点","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1575470937,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1395154,"avatar":"https://wx.qlogo.cn/mmopen/vi_32/DYAIOgq83eq5IibxSqcZYFzIhR2HDF86YfsKZkAARSrFKO2qNLMFgBmaYPxOy8rne14BL4ibtptibDcDULZn1W6icA/132","nickname":"stringbo","note":"","ucode":"B27A6F611444BB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":72702,"discussion_content":"问题1:是真实的案例，服务器假死，副本集也没有进行选举，最后是通过重启服务器解决的。（mongodb 的版本是3.2.16）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1575518084,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":155142,"user_name":"cheriston","can_delete":false,"product_type":"c3","uid":1309984,"ip_address":"","ucode":"617CBFCE0925C4","user_header":"https://static001.geekbang.org/account/avatar/00/13/fd/20/2761ef0e.jpg","comment_is_top":false,"comment_ctime":1574650485,"is_pvip":false,"replies":[{"id":59921,"content":"抱歉这个问题不清楚不知道如何回答。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1574812998,"ip_address":"","comment_id":155142,"utype":1}],"discussion_count":1,"race_medal":0,"score":4,"product_id":100040001,"comment_content":"老师，mongodb 有没有海量数据的备份脚本，求思路","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":475670,"discussion_content":"抱歉这个问题不清楚不知道如何回答。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574812998,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":154442,"user_name":"朱仁欢","can_delete":false,"product_type":"c3","uid":1307047,"ip_address":"","ucode":"1FF64ED7A60B0F","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/lUnAGTC1HOCZPicMibj9SWpT2WkGLCuGA5XuFlVEJoCic6Y9z1JianocKibTeApsY4HOWKQ7D0zGKmJttwD5sTQTG0w/132","comment_is_top":false,"comment_ctime":1574431276,"is_pvip":false,"replies":[{"id":59928,"content":"可以提供下完整的配置文件吗","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1574813541,"ip_address":"","comment_id":154442,"utype":1}],"discussion_count":1,"race_medal":0,"score":4,"product_id":100040001,"comment_content":"我发现linux下配置文件中复制集的名字要这么写:replSet＝rs0. 不能写成:replSetName＝rs0. 否则就报错:unrecognized option &#39;replSetName&#39;","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":475470,"discussion_content":"可以提供下完整的配置文件吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574813541,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":153780,"user_name":"燕行","can_delete":false,"product_type":"c3","uid":1048380,"ip_address":"","ucode":"AE2BEFD3C5F31F","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ff/3c/215aecca.jpg","comment_is_top":false,"comment_ctime":1574306098,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100040001,"comment_content":"老师的授课风格单刀直入，没有丝毫拖泥带水，操作部分经常需要反复观看，质量很高","like_count":3},{"had_liked":false,"id":376692,"user_name":"Paul","can_delete":false,"product_type":"c3","uid":1050294,"ip_address":"广东","ucode":"7018DE791BBAE7","user_header":"https://static001.geekbang.org/account/avatar/00/10/06/b6/4db00076.jpg","comment_is_top":false,"comment_ctime":1687231496,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100040001,"comment_content":"老师 请教一下报这个错误该如何解决？咱这好像还没涉及到账号的问题，为啥报这个错误呢：\n2023-06-20T11:13:40.486+0800 E QUERY    [js] Error: count failed: {\n        &quot;operationTime&quot; : Timestamp(1687230814, 1),\n        &quot;ok&quot; : 0,\n        &quot;errmsg&quot; : &quot;not authorized on local to execute command { count: \\&quot;system.replset\\&quot;, query: {}, fields: {}, lsid: { id: UUID(\\&quot;b60985a7-a9a7-4216-906a-19625fd5c865\\&quot;) }, $clusterTime: { clusterTime: Timestamp(1687230794, 1), signature: { hash: BinData(0, CD79E3807BC3E0169319FA1B40E9AD05040A14D7), keyId: 7246341183973097473 } }, $db: \\&quot;local\\&quot; }&quot;,\n        &quot;code&quot; : 13,\n        &quot;codeName&quot; : &quot;Unauthorized&quot;,\n        &quot;$clusterTime&quot; : {\n                &quot;clusterTime&quot; : Timestamp(1687230814, 1),\n                &quot;signature&quot; : {\n                        &quot;hash&quot; : BinData(0,&quot;H3&#47;GPlP9DsUJAJah3856uOewWSY=&quot;),\n                        &quot;keyId&quot; : NumberLong(&quot;7246341183973097473&quot;)\n                }\n        }\n} :","like_count":0},{"had_liked":false,"id":359136,"user_name":"Geek_fe9cd6","can_delete":false,"product_type":"c3","uid":3180971,"ip_address":"广东","ucode":"CE6F3F59513E9F","user_header":"","comment_is_top":false,"comment_ctime":1665285645,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100040001,"comment_content":"window配置：\nsystemLog:\n    destination: file\n    path: D:\\data\\db1\\mongod.log \n    logAppend: true\nstorage:\n    dbPath: D:\\data\\db1 \nnet:\n    bindIp: 0.0.0.0\n    port: 28017 \nreplication:\n    replSetName: rs0\n\n老师我的window配置文件是上面的 在cmd窗口输入mongod -f d:\\data\\db1\\mongod.conf 只看到光标在闪烁没有下文了 ，老师能帮我看看什么问题吗？","like_count":0},{"had_liked":false,"id":336141,"user_name":"Geek_66968d","can_delete":false,"product_type":"c3","uid":2873455,"ip_address":"","ucode":"A5E85EE9E54EC8","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJVpGfkkH8rqDSv2zqAKkLSSwXnIPmC96xSVS8Mq1BUrjLAk97NlhOvqUicWzJILlqDpaNCiaGtw0Yw/132","comment_is_top":false,"comment_ctime":1645952505,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100040001,"comment_content":"老师，要是做了误删除库的操作，还设置了1个小时的延迟节点，那用延迟节点来恢复数据不就有数据丢失？怎么避免这种情况呢？","like_count":0},{"had_liked":false,"id":333137,"user_name":"知三四郎","can_delete":false,"product_type":"c3","uid":1448616,"ip_address":"","ucode":"D5BF0F80178C86","user_header":"https://static001.geekbang.org/account/avatar/00/16/1a/a8/1b365fa7.jpg","comment_is_top":false,"comment_ctime":1644123914,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100040001,"comment_content":"mysql对一个32位长度字符串做索引的时候，可以通过控制索引长度，比如仅索引前8位，达到在效果基本相同的情况下，极大缩小索引文件的体积，mongodb能否实现，怎么写？","like_count":0},{"had_liked":false,"id":287441,"user_name":"健","can_delete":false,"product_type":"c3","uid":1791940,"ip_address":"","ucode":"C67C04203C59AA","user_header":"https://static001.geekbang.org/account/avatar/00/1b/57/c4/9a7e6636.jpg","comment_is_top":false,"comment_ctime":1617952480,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100040001,"comment_content":"老师，您好，想请教下，用 延迟节点的方式，备份mongodb 集群数据, 那 config server 是否也需要配置延迟节点？","like_count":0},{"had_liked":false,"id":260649,"user_name":"这时间太少","can_delete":false,"product_type":"c3","uid":1477839,"ip_address":"","ucode":"2CD6923158D98F","user_header":"https://static001.geekbang.org/account/avatar/00/16/8c/cf/2d8da55b.jpg","comment_is_top":false,"comment_ctime":1605077744,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100040001,"comment_content":"老师您好，我在搭建3节点复制集时，遇到这种情况无法解决：初始化节点1和节点2且都正常（一主一从），节点3通过 rs.add 添加，执行成功后出现 &quot;stateStr&quot; : &quot;(not reachable&#47;healthy)&quot; \n&quot;optimeDate&quot; : ISODate(&quot;1970-01-01T00:00:00Z&quot;)\n&quot;optimeDurableDate&quot; : ISODate(&quot;1970-01-01T00:00:00Z&quot;)\n&quot;lastHeartbeatRecv&quot; : ISODate(&quot;1970-01-01T00:00:00Z&quot;),\n&quot;lastHeartbeatMessage&quot; : &quot;Couldn&#39;t get a connection within the time limit of 1000ms&quot; \n（3个节点之间能够互相ping通）\n\n在节点3中：\n&gt; rs.status()\n{\n\t&quot;operationTime&quot; : Timestamp(0, 0),\n\t&quot;ok&quot; : 0,\n\t&quot;errmsg&quot; : &quot;no replset config has been received&quot;,\n\t&quot;code&quot; : 94,\n\t&quot;codeName&quot; : &quot;NotYetInitialized&quot;,\n\t&quot;$clusterTime&quot; : {\n\t\t&quot;clusterTime&quot; : Timestamp(0, 0),\n\t\t&quot;signature&quot; : {\n\t\t\t&quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),\n\t\t\t&quot;keyId&quot; : NumberLong(0)\n\t\t}\n\t}\n}\n","like_count":0},{"had_liked":false,"id":249076,"user_name":"book尾汁","can_delete":false,"product_type":"c3","uid":1446375,"ip_address":"","ucode":"AE2B8DFC643ACC","user_header":"https://static001.geekbang.org/account/avatar/00/16/11/e7/044a9a6c.jpg","comment_is_top":false,"comment_ctime":1600421243,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":4,"product_id":100040001,"comment_content":"已经恢复了，通过之前掉线的一个节点 的全量数据大概到今年6月份，又通过oplog重放了几天的日志，还是缺了几个月的数据，还可以接受，\n另外再问老师两个问题，有密码认证的情况下怎么将新的机器加入进来，目前我是先关闭认证然后加入集群的。\n还有就是今天我在做复制集群的时候，就是用add的方式一台台加入的，当我加入成功了一台新机器以后，我在新机器上执行rs.init初始化集群这个命令，原来的主的机器变成从了，而新加入的机器变成主了，但是因为原来的主服务器是有密码的，所以新的主连不上原来的服务器，这种情况该怎么做，目前打算先把原来有数据的主库变成单实例的，然后删除local库重新初始化，以非认证模式启动，重新配置集群，老师有什么更好的方法吗","like_count":0,"discussions":[{"author":{"id":1035744,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/cd/e0/c85bb948.jpg","nickname":"朱雯","note":"","ucode":"064C45FBF6B51F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":369551,"discussion_content":"我的办法是加入认证机制  通关文件密钥的方式来做 ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619076065,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":205722,"user_name":"苗","can_delete":false,"product_type":"c3","uid":1088710,"ip_address":"","ucode":"5ECCC6C855E541","user_header":"https://static001.geekbang.org/account/avatar/00/10/9c/c6/05a6798f.jpg","comment_is_top":false,"comment_ctime":1586709805,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":5,"product_id":100040001,"comment_content":"本机搭建复制集真的不难，跟着一步步操作就OK。","like_count":0},{"had_liked":false,"id":183454,"user_name":"test","can_delete":false,"product_type":"c3","uid":1303963,"ip_address":"","ucode":"2AEB293A81E969","user_header":"https://static001.geekbang.org/account/avatar/00/13/e5/9b/db9a6a8c.jpg","comment_is_top":false,"comment_ctime":1583044809,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":5,"product_id":100040001,"comment_content":"老师请问下：我用mongorestore恢复数据进单实例需要14分钟，恢复数据进复制集需要1个多小时，我检查了writeconcern也是1，我还可以检查哪些，从而解决这个问题？谢谢","like_count":0},{"had_liked":false,"id":161441,"user_name":"Ink Leaf","can_delete":false,"product_type":"c3","uid":1729814,"ip_address":"","ucode":"2C1507836D1EB0","user_header":"https://static001.geekbang.org/account/avatar/00/1a/65/16/08e3e62c.jpg","comment_is_top":false,"comment_ctime":1576206766,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":5,"product_id":100040001,"comment_content":"老师，\n&quot;Our set name did not match that of localhost\n\n&quot;Our set name did not match that of ecs-s6-xlarge-2-linux-20191111183245:27019\n\n搭建时出现这种问题改怎样解决","like_count":0,"discussions":[{"author":{"id":2354474,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/UNC7eWZWvRyAPWUpIJicgZBWLNpkljMbgeaFVWU3QNmWgaibchc8aGFfAG7gWh7eghHSrtSuSqMDp2ibVnvE2eLJg/132","nickname":"Geek_a88948","note":"","ucode":"C7FF3099A180D6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":352039,"discussion_content":"第一个问题我也遇到了，解决方法是conf文件中rs一样","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1614581240,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":153451,"user_name":"乘坐Tornado的线程魔法师","can_delete":false,"product_type":"c3","uid":1132661,"ip_address":"","ucode":"C4C9915866E769","user_header":"https://static001.geekbang.org/account/avatar/00/11/48/75/02b4366a.jpg","comment_is_top":false,"comment_ctime":1574237451,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":5,"product_id":100040001,"comment_content":"github中md文（课件）件中的代码示例与视频中讲解的目录略微有出入：\npath那一行与dbPath那一行的路径需要修改成下方这样\n\nsystemLog:\n  destination: file\n  path: &#47;data&#47;db1&#47;mongod.log   # 日志文件路径\n  logAppend: true\nstorage:\n  dbPath: &#47;data&#47;db1    # 数据目录\nnet:\n  bindIp: 0.0.0.0\n  port: 28019   # 端口\nreplication:\n  replSetName: rs0\nprocessManagement:\n  fork: true\n","like_count":0}]}