{"id":176917,"title":"34 | 降级熔断：如何屏蔽非核心系统故障的影响？","content":"<p>你好，我是唐扬。</p><p>到目前为止，你的电商系统已经搭建了完善的服务端和客户端监控系统，并且完成了全链路压测。现在呢，你们已经发现和解决了垂直电商系统中很多的性能问题和隐患。但是千算万算，还是出现了纰漏。</p><p>本来，你们对于应对“双十一”的考验信心满满，但因为欠缺了一些面对巨大流量的经验，在促销过程中出现了几次短暂的服务不可用，这给部分用户造成了不好的使用体验。事后，你们进行了细致的复盘，追查出现故障的根本原因，你发现，原因主要可以归结为两大类。</p><ul>\n<li>\n<p>第一类原因是由于依赖的资源或者服务不可用，最终导致整体服务宕机。举例来说，在你的电商系统中就可能由于数据库访问缓慢，导致整体服务不可用。</p>\n</li>\n<li>\n<p>另一类原因是你们乐观地预估了可能到来的流量，当有超过系统承载能力的流量到来时，系统不堪重负，从而出现拒绝服务的情况。</p>\n</li>\n</ul><p>那么，你要如何避免再次出现这两类问题呢？我建议你采取降级、熔断以及限流的方案。限流是解决第二类问题的主要思路（下一节课，我会着重讲解）。今天这节课，我主要讲一下解决第一类问题的思路：降级和熔断。</p><p>不过在此之前，我先带你了解一下这个问题为何存在，因为你只有弄清楚出现故障的原理，才能更好地理解熔断降级带来的好处。</p><h2>雪崩是如何发生的</h2><!-- [[[read_end]]] --><p>局部故障最终导致全局故障，这种情况有一个专业的名词儿，叫做“雪崩”。那么，为什么会发生雪崩呢？我们知道，系统在运行的时候是需要消耗一些资源的，包括CPU、内存等系统资源，也包括执行业务逻辑的时候，需要的线程资源。</p><p>举个例子，一般在业务执行的容器内，都会定义一些线程池来分配执行任务的线程，比如在Tomcat这种Web容器的内部，定义了线程池来处理HTTP请求；RPC框架也给RPC服务端初始化了线程池来处理RPC请求。</p><p>这些线程池中的线程资源是有限的，如果这些线程资源被耗尽，那么服务自然也就无法处理新的请求，服务提供方也就宕机了。比如，你的垂直电商系统有四个服务A、B、C、D，A调用B，B调用C和D。其中，A、B、D服务是系统的核心服务（像是电商系统中的订单服务、支付服务等等），C是非核心服务（像反垃圾服务、审核服务）。</p><p>所以，一旦作为入口的A流量增加，你可能会考虑把A、B和D服务扩容，忽略C。那么C就有可能因为无法承担这么大的流量，导致请求处理缓慢，进一步会让B在调用C的时候，B中的请求被阻塞，等待C返回响应结果。这样一来，B服务中被占用的线程资源就不能释放。</p><p>久而久之，B就会因为线程资源被占满，无法处理后续的请求。那么从A发往B的请求，就会被放入B服务线程池的队列中，然后A调用B响应时间变长，进而拖垮A服务。你看，仅仅因为非核心服务C的响应时间变长，就可以导致整体服务宕机，<strong>这就是我们经常遇到的一种服务雪崩情况。</strong></p><p><img src=\"https://static001.geekbang.org/resource/image/42/43/42ccaedc09f890924caae689f0323443.jpg?wh=1142*339\" alt=\"\"></p><p>那么我们要如何避免出现上面这种情况呢？从我刚刚的介绍中你可以看到，因为服务调用方等待服务提供方的响应时间过长，它的资源被耗尽，才引发了级联反应，发生雪崩。</p><p>所以在分布式环境下，系统最怕的反而不是某一个服务或者组件宕机，而是最怕它响应缓慢，因为，某一个服务或者组件宕机也许只会影响系统的部分功能，但它响应一慢，就会出现雪崩拖垮整个系统。</p><p>而我们在部门内部讨论方案的时候，会格外注意这个问题，解决的思路就是在检测到某一个服务的响应时间出现异常时，切断调用它的服务与它之间的联系，让服务的调用快速返回失败，从而释放这次请求持有的资源。<strong>这个思路也就是我们经常提到的降级和熔断机制。</strong></p><p>那么降级和熔断分别是怎么做的呢？它们之间有什么相同点和不同点呢？你在自己的项目中要如何实现熔断降级呢？</p><h2>熔断机制是如何做的</h2><p>首先，我们来看看熔断机制的实现方式。这个机制参考的是电路中保险丝的保护机制，当电路超负荷运转的时候，保险丝会断开电路，保证整体电路不受损害。而服务治理中的熔断机制指的是在发起服务调用的时候，如果返回错误或者超时的次数超过一定阈值，则后续的请求不再发向远程服务而是暂时返回错误。</p><p>这种实现方式在云计算领域又称为断路器模式，在这种模式下，服务调用方为每一个调用的服务维护一个有限状态机，在这个状态机中会有三种状态：关闭（调用远程服务）、半打开（尝试调用远程服务）和打开（返回错误）。这三种状态之间切换的过程是下面这个样子。</p><ul>\n<li>当调用失败的次数累积到一定的阈值时，熔断状态从关闭态切换到打开态。一般在实现时，如果调用成功一次，就会重置调用失败次数。</li>\n<li>当熔断处于打开状态时，我们会启动一个超时计时器，当计时器超时后，状态切换到半打开态。你也可以通过设置一个定时器，定期地探测服务是否恢复。</li>\n<li>在熔断处于半打开状态时，请求可以达到后端服务，如果累计一定的成功次数后，状态切换到关闭态；如果出现调用失败的情况，则切换到打开态。</li>\n</ul><p><img src=\"https://static001.geekbang.org/resource/image/9f/87/9fc3934e1e0923fe990e0bdbe3aec787.jpg?wh=1142*643\" alt=\"\"></p><p>其实，不仅仅微服务之间调用需要熔断的机制，我们在调用Redis、Memcached等资源的时候也可以引入这套机制。在我的团队自己封装的Redis客户端中，就实现了一套简单的熔断机制。首先，在系统初始化的时候，我们定义了一个定时器，当熔断器处于Open状态时，定期地检测Redis组件是否可用：</p><pre><code>new Timer(&quot;RedisPort-Recover&quot;, true).scheduleAtFixedRate(new TimerTask() {\n    @Override\n    public void run() {\n        if (breaker.isOpen()) {\n            Jedis jedis = null;\n            try {\n                jedis = connPool.getResource();\n                jedis.ping(); //验证redis是否可用\n                successCount.set(0); //重置连续成功的计数\n                breaker.setHalfOpen(); //设置为半打开态\n            } catch (Exception ignored) {\n            } finally {\n                if (jedis != null) {\n                    jedis.close();\n                }\n            }\n        }\n    }\n}, 0, recoverInterval); //初始化定时器定期检测redis是否可用\n</code></pre><p>在通过Redis客户端操作Redis中的数据时，我们会在其中加入熔断器的逻辑。比如，当节点处于熔断状态时，直接返回空值以及熔断器三种状态之间的转换，具体的示例代码像下面这样：</p><pre><code>if (breaker.isOpen()) { \n    return null;  // 断路器打开则直接返回空值\n}\n\nK value = null;\nJedis jedis = null;\n\ntry {\n     jedis = connPool.getResource();\n     value = callback.call(jedis);\n     if(breaker.isHalfOpen()) { //如果是半打开状态\n          if(successCount.incrementAndGet() &gt;= SUCCESS_THRESHOLD) {//成功次数超过阈值\n                failCount.set(0);  //清空失败数\n                breaker.setClose(); //设置为关闭态\n          }\n     }\n     return value;\n} catch (JedisException je) {\n     if(breaker.isClose()){  //如果是关闭态\n         if(failCount.incrementAndGet() &gt;= FAILS_THRESHOLD){ //失败次数超过阈值\n            breaker.setOpen();  //设置为打开态\n         }\n     } else if(breaker.isHalfOpen()) {  //如果是半打开态\n         breaker.setOpen();    //直接设置为打开态\n     }\n     throw  je;\n} finally {\n     if (jedis != null) {\n           jedis.close();\n     }\n}\n</code></pre><p>这样，当某一个Redis节点出现问题，Redis客户端中的熔断器就会实时监测到，并且不再请求有问题的Redis节点，避免单个节点的故障导致整体系统的雪崩。</p><h2>降级机制要如何做</h2><p>除了熔断之外，我们在听业内分享的时候，听到最多的服务容错方式就是降级，那么降级又是怎么做的呢？它和熔断有什么关系呢？</p><p>其实在我看来，相比熔断来说，降级是一个更大的概念。因为它是站在整体系统负载的角度上，放弃部分非核心功能或者服务，保证整体的可用性的方法，是一种有损的系统容错方式。这样看来，熔断也是降级的一种，除此之外还有限流降级、开关降级等等（限流降级我会在下一节课中提到，这节课主要讲一下开关降级）。</p><p>开关降级指的是在代码中预先埋设一些“开关”，用来控制服务调用的返回值。比方说，开关关闭的时候正常调用远程服务，开关打开时则执行降级的策略。这些开关的值可以存储在配置中心中，当系统出现问题需要降级时，只需要通过配置中心动态更改开关的值，就可以实现不重启服务快速地降级远程服务了。</p><p>还是以电商系统为例，你的电商系统在商品详情页面除了展示商品数据以外，还需要展示评论的数据，但是主体还是商品数据，在必要时可以降级评论数据。所以，你可以定义这个开关为“degrade.comment”，写入到配置中心中，具体的代码也比较简单，就像下面这样：</p><pre><code>boolean switcherValue = getFromConfigCenter(&quot;degrade.comment&quot;); //从配置中心获取开关的值\nif (!switcherValue) {\n  List&lt;Comment&gt; comments = getCommentList(); //开关关闭则获取评论数据\n} else {\n  List&lt;Comment&gt; comments = new ArrayList(); //开关打开，则直接返回空评论数据\n}\n</code></pre><p>当然了，我们在设计开关降级预案的时候，首先要区分哪些是核心服务，哪些是非核心服务。因为我们只能针对非核心服务来做降级处理，然后就可以针对具体的业务，制定不同的降级策略了。我给你列举一些常见场景下的降级策略，你在实际的工作中可以参考借鉴。</p><ul>\n<li>针对读取数据的场景，我们一般采用的策略是直接返回降级数据。比如，如果数据库的压力比较大，我们在降级的时候，可以考虑只读取缓存的数据，而不再读取数据库中的数据；如果非核心接口出现问题，可以直接返回服务繁忙或者返回固定的降级数据。</li>\n<li>对于一些轮询查询数据的场景，比如每隔30秒轮询获取未读数，可以降低获取数据的频率（将获取频率下降到10分钟一次）。</li>\n<li>而对于写数据的场景，一般会考虑把同步写转换成异步写，这样可以牺牲一些数据一致性保证系统的可用性。</li>\n</ul><p><strong>我想强调的是，只有经过演练的开关才是有用的开关，</strong>有些同学在给系统加了开关之后并不测试，结果出了问题真要使用的时候，却发现开关并不生效。因此，你在为系统增加降级开关时，一定要在流量低峰期的时候做验证演练，也可以在不定期的压力测试过程中演练，保证开关的可用性。</p><h2>课程小结</h2><p>以上就是本节课的全部内容了。本节课我带你了解了雪崩产生的原因，服务熔断的实现方式以及服务降级的策略，这里你需要了解的重点是：</p><ol>\n<li>在分布式环境下最怕的是服务或者组件慢，因为这样会导致调用者持有的资源无法释放，最终拖垮整体服务。</li>\n<li>服务熔断的实现是一个有限状态机，关键是三种状态之间的转换过程。</li>\n<li>开关降级的实现策略主要有返回降级数据、降频和异步三种方案。</li>\n</ol><p>其实，开关不仅仅应该在你的降级策略中使用，在我的项目中，只要上线新的功能必然要加开关控制业务逻辑是运行新的功能还是运行旧的功能。这样，一旦新的功能上线后，出现未知的问题（比如性能问题），那么可以通过切换开关的方式来实现快速的回滚，减少问题的持续时间。</p><p>总之，熔断和降级是保证系统稳定性和可用性的重要手段，在你访问第三方服务或者资源的时候都需要考虑增加降级开关或者熔断机制，保证资源或者服务出现问题时，不会对整体系统产生灾难性的影响。</p><h2>一课一思</h2><p>结合你的实际工作经历，讲一讲你的项目中都制定了哪些降级的预案呢？在制定降级方案时的考虑点是什么呢？欢迎在留言区与我分享你的经验。</p><p>最后，感谢你的阅读，如果这篇文章让你有所收获，也欢迎你将它分享给更多的朋友。</p>","neighbors":{"left":{"article_title":"33 | 配置管理：成千上万的配置项要如何管理？","id":175164},"right":{"article_title":"35 |  流量控制：高并发系统中我们如何操纵流量？","id":177796}},"comments":[{"had_liked":false,"id":161552,"user_name":"阿卡牛","can_delete":false,"product_type":"c1","uid":1022247,"ip_address":"","ucode":"0BC43A904C3199","user_header":"https://static001.geekbang.org/account/avatar/00/0f/99/27/47aa9dea.jpg","comment_is_top":false,"comment_ctime":1576228336,"is_pvip":false,"replies":[{"id":"62155","content":"很形象，^_^","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1576737188,"ip_address":"","comment_id":161552,"utype":1}],"discussion_count":3,"race_medal":0,"score":"181964854768","product_id":100035801,"comment_content":"不怕你说不行，就怕你不吭声","like_count":43,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":477758,"discussion_content":"很形象，^_^","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576737188,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1915085,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/38/cd/4aa749cd.jpg","nickname":"果冻慢慢跑","note":"","ucode":"584220B6AFB026","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":342390,"discussion_content":"深刻","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1610671422,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1175495,"avatar":"https://static001.geekbang.org/account/avatar/00/11/ef/c7/07bffbf3.jpg","nickname":"小土豆爸爸","note":"","ucode":"E3FED198AB803A","race_medal":1,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":274167,"discussion_content":"深有体会\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590549334,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":212439,"user_name":"︶ㄣ.ァ黃帥傑︶ㄣ","can_delete":false,"product_type":"c1","uid":1106574,"ip_address":"","ucode":"C1A1F80E282C80","user_header":"https://static001.geekbang.org/account/avatar/00/10/e2/8e/667d23d1.jpg","comment_is_top":false,"comment_ctime":1588123889,"is_pvip":false,"replies":[{"id":"83122","content":"核心业务降级不就是故障了。。","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1591803773,"ip_address":"","comment_id":212439,"utype":1}],"discussion_count":1,"race_medal":0,"score":"57422698737","product_id":100035801,"comment_content":"老师，为啥核心业务不能降级哇","like_count":14,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493506,"discussion_content":"核心业务降级不就是故障了。。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591803773,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":166024,"user_name":"丁丁历险记","can_delete":false,"product_type":"c1","uid":1661704,"ip_address":"","ucode":"A43829E454C067","user_header":"https://static001.geekbang.org/account/avatar/00/19/5b/08/b0b0db05.jpg","comment_is_top":false,"comment_ctime":1577365514,"is_pvip":false,"replies":[{"id":"63333","content":"必须要演练","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1577417860,"ip_address":"","comment_id":166024,"utype":1}],"discussion_count":3,"race_medal":0,"score":"31642136586","product_id":100035801,"comment_content":"好的开关需要经过演练。","like_count":7,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":479355,"discussion_content":"必须要演练","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577417860,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1013036,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/75/2c/df8aaf20.jpg","nickname":"小楼一夜听春雨","note":"","ucode":"64ADD745A5DDC0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":346340,"discussion_content":"降级不一定是开关，也可以是简化业务逻辑，简化业务流程，甚至通过配置静态数据来替代动态数据，不同的业务场景基于用户体验可以采取不同的策略。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1611913748,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1175495,"avatar":"https://static001.geekbang.org/account/avatar/00/11/ef/c7/07bffbf3.jpg","nickname":"小土豆爸爸","note":"","ucode":"E3FED198AB803A","race_medal":1,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":274114,"discussion_content":"确实要演练，不然没用\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590543062,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":160768,"user_name":"蓝魔丶","can_delete":false,"product_type":"c1","uid":1219438,"ip_address":"","ucode":"2AE4359E263558","user_header":"https://static001.geekbang.org/account/avatar/00/12/9b/6e/edd2da0c.jpg","comment_is_top":false,"comment_ctime":1576030792,"is_pvip":false,"replies":[{"id":"61404","content":"可以使用限流，也可以设置合适的超时时间，还可以扩容","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1576116841,"ip_address":"","comment_id":160768,"utype":1}],"discussion_count":2,"race_medal":0,"score":"31640801864","product_id":100035801,"comment_content":"请教老师一个问题，熔断和开关降级都是有损的处理方式，文中提到是针对非核心业务，但是如果核心业务也遇到两类问题的困扰的时候，需要怎么处理？不能采用熔断和开关降级这种方式吗？如果采用后面讲到限流降级可以保证核心业务的可用性，但是还是感觉是有损的，毕竟可能会丢弃部分请求，或者返回错误，所以针对核心业务有什么更好的方式处理吗？尽量对核心业务的损耗更低","like_count":8,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":477473,"discussion_content":"可以使用限流，也可以设置合适的超时时间，还可以扩容","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576116841,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2586341,"avatar":"","nickname":"石头","note":"","ucode":"EB3C9A277C7B0C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":370208,"discussion_content":"核心服务应该考虑它的限流和容灾吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619330140,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":215408,"user_name":"钱","can_delete":false,"product_type":"c1","uid":1009652,"ip_address":"","ucode":"2C92A243A463D4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg","comment_is_top":false,"comment_ctime":1588987361,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"18768856545","product_id":100035801,"comment_content":"视具体情况而定，大促应急预案演练都会写明，也会抽时间抽人现场操练操练。<br>大体降级策略如下：<br>第一降日志<br>第二降非核心服务<br>第三降降核心服务<br>基本第一就OK，第二也有启用的时候，不过第三三年来未曾启用过。具体降什么？怎么降？何时恢复？这些都必须做好前期准备，另外前期的压测扩容，也是保障服务高可用的重要环节，前期准备越好后面问题越少，所以，降级的操作也就可以少做了，大促时主要是观察监控项，随时准备解决突发问题。","like_count":4},{"had_liked":false,"id":209286,"user_name":"木木","can_delete":false,"product_type":"c1","uid":1205341,"ip_address":"","ucode":"B446FD36734E75","user_header":"https://static001.geekbang.org/account/avatar/00/12/64/5d/de0536e8.jpg","comment_is_top":false,"comment_ctime":1587529793,"is_pvip":false,"replies":[{"id":"78264","content":"也可以看看阿里开源的哨兵~","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1587623800,"ip_address":"","comment_id":209286,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18767398977","product_id":100035801,"comment_content":"hystrix源码去翻一遍，再结合这个看看。收获颇多。只可惜原来的项目中不够重视","like_count":4,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492761,"discussion_content":"也可以看看阿里开源的哨兵~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587623800,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":162680,"user_name":"电光火石","can_delete":false,"product_type":"c1","uid":1013160,"ip_address":"","ucode":"3AD33BB4AA940F","user_header":"https://static001.geekbang.org/account/avatar/00/0f/75/a8/dfe4cade.jpg","comment_is_top":false,"comment_ctime":1576577064,"is_pvip":false,"replies":[{"id":"62147","content":"应该是限流吧。<br>另外支付调用银行的接口可以是异步的，然后等待银行的回调，这样就可以把支付请求放入队列，用户的感知是支付成功有些延迟","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1576736087,"ip_address":"","comment_id":162680,"utype":1}],"discussion_count":5,"race_medal":0,"score":"14461478952","product_id":100035801,"comment_content":"请问，如果核心业务，比如说双十一的时候，支付场景下，银行跟不上这么大的流量，那这个时候熔断和降级其实都不合适，应该怎么做，谢谢了！","like_count":3,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":478124,"discussion_content":"应该是限流吧。\n另外支付调用银行的接口可以是异步的，然后等待银行的回调，这样就可以把支付请求放入队列，用户的感知是支付成功有些延迟","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576736087,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1235812,"avatar":"https://static001.geekbang.org/account/avatar/00/12/db/64/f9628492.jpg","nickname":"七号叽","note":"","ucode":"0CB7E5C3297511","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":220091,"discussion_content":"双十一时京东等了好像有十分钟才显示订单支付成功233 估计是老师说的异步？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1585835161,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1013493,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/76/f5/e3f5bd8d.jpg","nickname":"宝仔","note":"","ucode":"A0F17DFF99DB21","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":218465,"discussion_content":"双11大促的时候好像只能用支付宝支付吧，其实就是降级","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1585660916,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1015754,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/7f/ca/ea85bfdd.jpg","nickname":"helloworld","note":"","ucode":"00DF2FEC58D2E6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1013493,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/76/f5/e3f5bd8d.jpg","nickname":"宝仔","note":"","ucode":"A0F17DFF99DB21","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":294264,"discussion_content":"哈哈哈哈，这是夸支付宝","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595843101,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":218465,"ip_address":""},"score":294264,"extra":""}]},{"author":{"id":1794261,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLf3rtBCgIYcxghSJzmQH53r3geicqKx75u1ZsZE8hMIGZ2xxO1V2zqEwgmh0ZQTO68N6oGia2LzIiaA/132","nickname":"Geek_e5d4b7","note":"","ucode":"CAF59B0F2178C0","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":313070,"discussion_content":"支付结果可以延迟处理，支付动作如何异步","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1602927408,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":160707,"user_name":"tt","can_delete":false,"product_type":"c1","uid":1489957,"ip_address":"","ucode":"7753B79AD5A9AC","user_header":"https://static001.geekbang.org/account/avatar/00/16/bc/25/1c92a90c.jpg","comment_is_top":false,"comment_ctime":1576024358,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"14460926246","product_id":100035801,"comment_content":"嗯，新功能上线时通过开关来实现快速的回滚，即从高版本回滚到低版本也是一种降级。<br><br>这样有选择的降级就和蓝绿发布连接在一起了","like_count":3},{"had_liked":false,"id":237484,"user_name":"helloworld","can_delete":false,"product_type":"c1","uid":1015754,"ip_address":"","ucode":"00DF2FEC58D2E6","user_header":"https://static001.geekbang.org/account/avatar/00/0f/7f/ca/ea85bfdd.jpg","comment_is_top":false,"comment_ctime":1595843401,"is_pvip":false,"discussion_count":4,"race_medal":0,"score":"5890810697","product_id":100035801,"comment_content":"往往新功能和旧功能的代码是柔和到一起的，通过开关来控制新功能和旧功能的切换感觉想法是好的，但是现实中不可行","like_count":1,"discussions":[{"author":{"id":2756576,"avatar":"https://static001.geekbang.org/account/avatar/00/2a/0f/e0/b53a7701.jpg","nickname":"骑车上天空","note":"","ucode":"364365E2721122","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583556,"discussion_content":"用版本号控制","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660202246,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1255277,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLDVXsv6JOOficLK07867AkAb21eoG5KBgYFmwhMXKJooU5B6iaIZwyDxExicokVQSiaKEwZ4qPicqVFcg/132","nickname":"拼yin世界","note":"","ucode":"9571428A12B72A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":403249,"discussion_content":"我们公司，一直都是这么干的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634039463,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1064902,"avatar":"https://static001.geekbang.org/account/avatar/00/10/3f/c6/c2bf55bd.jpg","nickname":"devilyaos","note":"","ucode":"5FE075608F03F7","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":384400,"discussion_content":"这种一般是做冗余代码，在入口切分开，再通过开关选分支，新功能有限复用老功能代码，或者干脆不用。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1626571126,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1112676,"avatar":"https://static001.geekbang.org/account/avatar/00/10/fa/64/457325e6.jpg","nickname":"Sam Fu","note":"","ucode":"EA285A4943271F","race_medal":1,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":360700,"discussion_content":"确实不好搞。开关多久能下掉？还是有很多问题的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1616506885,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":160722,"user_name":"魏春河","can_delete":false,"product_type":"c1","uid":1117048,"ip_address":"","ucode":"DDD2998C157639","user_header":"https://static001.geekbang.org/account/avatar/00/11/0b/78/22410c47.jpg","comment_is_top":false,"comment_ctime":1576025671,"is_pvip":false,"discussion_count":2,"race_medal":1,"score":"5870992967","product_id":100035801,"comment_content":"看着熔断状态变更示意图有问题，状态变化和箭头提示对应有错误","like_count":1,"discussions":[{"author":{"id":1886331,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/c8/7b/153181d7.jpg","nickname":"夜辉","note":"","ucode":"9421385F51FF9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":364986,"discussion_content":"没问题呀，打开指熔断器打开，直接返回空值","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617678445,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1015754,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/7f/ca/ea85bfdd.jpg","nickname":"helloworld","note":"","ucode":"00DF2FEC58D2E6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":294265,"discussion_content":"同感！上面的文字描述和图示不一致，感觉","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595843140,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":342190,"user_name":"剑八","can_delete":false,"product_type":"c1","uid":1297630,"ip_address":"","ucode":"0A09F41DB8A4E7","user_header":"https://static001.geekbang.org/account/avatar/00/13/cc/de/e28c01e1.jpg","comment_is_top":false,"comment_ctime":1650093577,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1650093577","product_id":100035801,"comment_content":"熔断和降级比更偏自动化，不需要人工介入<br>相应熔断实现中失败数的限值很重要，还有从打开到半关闭的超时时间，以及从半关闭到关闭的成功数限值","like_count":0},{"had_liked":false,"id":328177,"user_name":"亚林","can_delete":false,"product_type":"c1","uid":1018972,"ip_address":"","ucode":"4A5A6D24314B79","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8c/5c/3f164f66.jpg","comment_is_top":false,"comment_ctime":1640589700,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1640589700","product_id":100035801,"comment_content":"我们连配置中心还没有😭","like_count":0},{"had_liked":false,"id":286916,"user_name":"夜辉","can_delete":false,"product_type":"c1","uid":1886331,"ip_address":"","ucode":"9421385F51FF9E","user_header":"https://static001.geekbang.org/account/avatar/00/1c/c8/7b/153181d7.jpg","comment_is_top":false,"comment_ctime":1617678214,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1617678214","product_id":100035801,"comment_content":"请问老师，那一体化的系统，可以使用这些工具嘛？<br>我看定义时**面向云原生微服务**的高可用流控防护组件","like_count":0},{"had_liked":false,"id":176520,"user_name":"nestle","can_delete":false,"product_type":"c1","uid":1762252,"ip_address":"","ucode":"469800BED81B54","user_header":"https://static001.geekbang.org/account/avatar/00/1a/e3/cc/0947ff0b.jpg","comment_is_top":false,"comment_ctime":1581080486,"is_pvip":false,"replies":[{"id":"68821","content":"如果是对于http服务的熔断，你不要了能知道后面调用的是哪一个节点","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1581334755,"ip_address":"","comment_id":176520,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1581080486","product_id":100035801,"comment_content":"请问处于熔断状态，为啥直接返回空，而不是换一个节点重试呢？","like_count":0,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":483129,"discussion_content":"如果是对于http服务的熔断，你不要了能知道后面调用的是哪一个节点","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581334755,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":161770,"user_name":"星空123","can_delete":false,"product_type":"c1","uid":1596920,"ip_address":"","ucode":"E998A7C585671B","user_header":"https://static001.geekbang.org/account/avatar/00/18/5d/f8/7de2c1cc.jpg","comment_is_top":false,"comment_ctime":1576322022,"is_pvip":false,"replies":[{"id":"62228","content":"是框架提供的降级策略","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1576756103,"ip_address":"","comment_id":161770,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1576322022","product_id":100035801,"comment_content":"dubbo的监控中心也有降级","like_count":0,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":477850,"discussion_content":"是框架提供的降级策略","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576756103,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}