{"id":409307,"title":"37 | ä»£ç æµ‹è¯•ï¼ˆä¸‹ï¼‰ï¼šGo è¯­è¨€å…¶ä»–æµ‹è¯•ç±»å‹åŠ IAM æµ‹è¯•ä»‹ç»","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å­”ä»¤é£ã€‚</p><p><a href=\"https://time.geekbang.org/column/article/408529\">ä¸Šä¸€è®²</a>ï¼Œæˆ‘ä»‹ç»äº†Goä¸­çš„ä¸¤ç±»æµ‹è¯•ï¼šå•å…ƒæµ‹è¯•å’Œæ€§èƒ½æµ‹è¯•ã€‚åœ¨Goä¸­ï¼Œè¿˜æœ‰ä¸€äº›å…¶ä»–çš„æµ‹è¯•ç±»å‹å’Œæµ‹è¯•æ–¹æ³•ï¼Œå€¼å¾—æˆ‘ä»¬å»äº†è§£å’ŒæŒæ¡ã€‚æ­¤å¤–ï¼ŒIAMé¡¹ç›®ä¹Ÿç¼–å†™äº†å¤§é‡æµ‹è¯•ç”¨ä¾‹ï¼Œè¿™äº›æµ‹è¯•ç”¨ä¾‹ä½¿ç”¨äº†ä¸åŒçš„ç¼–å†™æ–¹æ³•ï¼Œä½ å¯ä»¥é€šè¿‡å­¦ä¹ IAMçš„æµ‹è¯•ç”¨ä¾‹æ¥éªŒè¯ä½ å­¦åˆ°çš„æµ‹è¯•çŸ¥è¯†ã€‚</p><p>ä»Šå¤©ï¼Œæˆ‘å°±æ¥ä»‹ç»ä¸‹Go è¯­è¨€ä¸­çš„å…¶ä»–æµ‹è¯•ç±»å‹ï¼šç¤ºä¾‹æµ‹è¯•ã€TestMainå‡½æ•°ã€Mockæµ‹è¯•ã€Fakeæµ‹è¯•ç­‰ï¼Œå¹¶ä¸”ä»‹ç»ä¸‹IAMé¡¹ç›®æ˜¯å¦‚ä½•ç¼–å†™å’Œè¿è¡Œæµ‹è¯•ç”¨ä¾‹çš„ã€‚</p><h2>ç¤ºä¾‹æµ‹è¯•</h2><p>ç¤ºä¾‹æµ‹è¯•ä»¥<code>Example</code>å¼€å¤´ï¼Œæ²¡æœ‰è¾“å…¥å’Œè¿”å›å‚æ•°ï¼Œé€šå¸¸ä¿å­˜åœ¨<code>example_test.go</code>æ–‡ä»¶ä¸­ã€‚ç¤ºä¾‹æµ‹è¯•å¯èƒ½åŒ…å«ä»¥<code>Output:</code>æˆ–è€…<code>Unordered output:</code>å¼€å¤´çš„æ³¨é‡Šï¼Œè¿™äº›æ³¨é‡Šæ”¾åœ¨å‡½æ•°çš„ç»“å°¾éƒ¨åˆ†ã€‚<code>Unordered output:</code>å¼€å¤´çš„æ³¨é‡Šä¼šå¿½ç•¥è¾“å‡ºè¡Œçš„é¡ºåºã€‚</p><p>æ‰§è¡Œ<code>go test</code>å‘½ä»¤æ—¶ï¼Œä¼šæ‰§è¡Œè¿™äº›ç¤ºä¾‹æµ‹è¯•ï¼Œå¹¶ä¸”go testä¼šå°†ç¤ºä¾‹æµ‹è¯•è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºçš„å†…å®¹ï¼Œè·Ÿæ³¨é‡Šä½œå¯¹æ¯”ï¼ˆæ¯”è¾ƒæ—¶å°†å¿½ç•¥è¡Œå‰åçš„ç©ºæ ¼ï¼‰ã€‚å¦‚æœç›¸ç­‰ï¼Œåˆ™ç¤ºä¾‹æµ‹è¯•é€šè¿‡æµ‹è¯•ï¼›å¦‚æœä¸ç›¸ç­‰ï¼Œåˆ™ç¤ºä¾‹æµ‹è¯•ä¸é€šè¿‡æµ‹è¯•ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹æµ‹è¯•ï¼ˆä½äºexample_test.goæ–‡ä»¶ä¸­ï¼‰ï¼š</p><pre><code class=\"language-go\">func ExampleMax() {\n    fmt.Println(Max(1, 2))\n    // Output:\n    // 2\n}\n</code></pre><!-- [[[read_end]]] --><p>æ‰§è¡Œgo testå‘½ä»¤ï¼Œæµ‹è¯•<code>ExampleMax</code>ç¤ºä¾‹æµ‹è¯•ï¼š</p><pre><code class=\"language-bash\">$ go test -v -run='Example.*'\n=== RUN   ExampleMax\n--- PASS: ExampleMax (0.00s)\nPASS\nok      github.com/marmotedu/gopractise-demo/31/test    0.004s\n</code></pre><p>å¯ä»¥çœ‹åˆ°<code>ExampleMax</code>æµ‹è¯•é€šè¿‡ã€‚è¿™é‡Œæµ‹è¯•é€šè¿‡æ˜¯å› ä¸º<code>fmt.Println(Max(1, 2))</code>å‘æ ‡å‡†è¾“å‡ºè¾“å‡ºäº†<code>2</code>ï¼Œè·Ÿ<code>// Output:</code>åé¢çš„<code>2</code>ä¸€è‡´ã€‚</p><p>å½“ç¤ºä¾‹æµ‹è¯•ä¸åŒ…å«<code>Output:</code>æˆ–è€…<code>Unordered output:</code>æ³¨é‡Šæ—¶ï¼Œæ‰§è¡Œ<code>go test</code>åªä¼šç¼–è¯‘è¿™äº›å‡½æ•°ï¼Œä½†ä¸ä¼šæ‰§è¡Œè¿™äº›å‡½æ•°ã€‚</p><h3>ç¤ºä¾‹æµ‹è¯•å‘½åè§„èŒƒ</h3><p>ç¤ºä¾‹æµ‹è¯•éœ€è¦éµå¾ªä¸€äº›å‘½åè§„èŒƒï¼Œå› ä¸ºåªæœ‰è¿™æ ·ï¼ŒGodocæ‰èƒ½å°†ç¤ºä¾‹æµ‹è¯•å’ŒåŒ…çº§åˆ«çš„æ ‡è¯†ç¬¦è¿›è¡Œå…³è”ã€‚ä¾‹å¦‚ï¼Œæœ‰ä»¥ä¸‹ç¤ºä¾‹æµ‹è¯•ï¼ˆä½äºexample_test.goæ–‡ä»¶ä¸­ï¼‰ï¼š</p><pre><code class=\"language-go\">package stringutil_test\n\nimport (\n    \"fmt\"\n\n    \"github.com/golang/example/stringutil\"\n)\n\nfunc ExampleReverse() {\n    fmt.Println(stringutil.Reverse(\"hello\"))\n    // Output: olleh\n}\n</code></pre><p>Godocå°†åœ¨<code>Reverse</code>å‡½æ•°çš„æ–‡æ¡£æ—è¾¹æä¾›æ­¤ç¤ºä¾‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/d8/93/d8ae5e99fe1d159e9b3ba1f815b24693.png?wh=540x374\" alt=\"å›¾ç‰‡\"></p><p>ç¤ºä¾‹æµ‹è¯•åä»¥<code>Example</code>å¼€å¤´ï¼Œåé¢å¯ä»¥ä¸è·Ÿä»»ä½•å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥è·Ÿå‡½æ•°åã€ç±»å‹åæˆ–è€…<code>ç±»å‹_æ–¹æ³•å</code>ï¼Œä¸­é—´ç”¨ä¸‹åˆ’çº¿<code>_</code>è¿æ¥ï¼Œä¾‹å¦‚ï¼š</p><pre><code class=\"language-go\">func Example() { ... } // ä»£è¡¨äº†æ•´ä¸ªåŒ…çš„ç¤ºä¾‹\nfunc ExampleF() { ... } // å‡½æ•°Fçš„ç¤ºä¾‹\nfunc ExampleT() { ... } // ç±»å‹Tçš„ç¤ºä¾‹\nfunc ExampleT_M() { ... } // æ–¹æ³•T_Mçš„ç¤ºä¾‹\n</code></pre><p>å½“æŸä¸ªå‡½æ•°/ç±»å‹/æ–¹æ³•æœ‰å¤šä¸ªç¤ºä¾‹æµ‹è¯•æ—¶ï¼Œå¯ä»¥é€šè¿‡åç¼€æ¥åŒºåˆ†ï¼Œåç¼€å¿…é¡»ä»¥å°å†™å­—æ¯å¼€å¤´ï¼Œä¾‹å¦‚ï¼š</p><pre><code class=\"language-go\">func ExampleReverse()\nfunc ExampleReverse_second()\nfunc ExampleReverse_third()\n</code></pre><h3>å¤§å‹ç¤ºä¾‹</h3><p>æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦ç¼–å†™ä¸€ä¸ªå¤§å‹çš„ç¤ºä¾‹æµ‹è¯•ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ªæ•´æ–‡ä»¶çš„ç¤ºä¾‹ï¼ˆwhole file exampleï¼‰ï¼Œå®ƒæœ‰è¿™å‡ ä¸ªç‰¹ç‚¹ï¼šæ–‡ä»¶åä»¥<code>_test.go</code>ç»“å°¾ï¼›åªåŒ…å«ä¸€ä¸ªç¤ºä¾‹æµ‹è¯•ï¼Œæ–‡ä»¶ä¸­æ²¡æœ‰å•å…ƒæµ‹è¯•å‡½æ•°å’Œæ€§èƒ½æµ‹è¯•å‡½æ•°ï¼›è‡³å°‘åŒ…å«ä¸€ä¸ªåŒ…çº§åˆ«çš„å£°æ˜ï¼›å½“å±•ç¤ºè¿™ç±»ç¤ºä¾‹æµ‹è¯•æ—¶ï¼Œgodocä¼šç›´æ¥å±•ç¤ºæ•´ä¸ªæ–‡ä»¶ã€‚ä¾‹å¦‚ï¼š</p><pre><code class=\"language-go\">package sort_test\n\nimport (\n    \"fmt\"\n    \"sort\"\n)\n\ntype Person struct {\n    Name string\n    Age  int\n}\n\nfunc (p Person) String() string {\n    return fmt.Sprintf(\"%s: %d\", p.Name, p.Age)\n}\n\n// ByAge implements sort.Interface for []Person based on\n// the Age field.\ntype ByAge []Person\n\nfunc (a ByAge) Len() int           { return len(a) }\nfunc (a ByAge) Swap(i, j int)      { a[i], a[j] = a[j], a[i] }\nfunc (a ByAge) Less(i, j int) bool { return a[i].Age &lt; a[j].Age }\n\nfunc Example() {\n    people := []Person{\n        {\"Bob\", 31},\n        {\"John\", 42},\n        {\"Michael\", 17},\n        {\"Jenny\", 26},\n    }\n\n    fmt.Println(people)\n    sort.Sort(ByAge(people))\n    fmt.Println(people)\n\n    // Output:\n    // [Bob: 31 John: 42 Michael: 17 Jenny: 26]\n    // [Michael: 17 Jenny: 26 Bob: 31 John: 42]\n}\n</code></pre><p>ä¸€ä¸ªåŒ…å¯ä»¥åŒ…å«å¤šä¸ªwhole file exampleï¼Œä¸€ä¸ªç¤ºä¾‹ä¸€ä¸ªæ–‡ä»¶ï¼Œä¾‹å¦‚<code>example_interface_test.go</code>ã€<code>example_keys_test.go</code>ã€<code>example_search_test.go</code>ç­‰ã€‚</p><h2>TestMainå‡½æ•°</h2><p>æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬åœ¨åšæµ‹è¯•çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šåœ¨æµ‹è¯•ä¹‹å‰åšäº›å‡†å¤‡å·¥ä½œï¼Œä¾‹å¦‚åˆ›å»ºæ•°æ®åº“è¿æ¥ç­‰ï¼›åœ¨æµ‹è¯•ä¹‹ååšäº›æ¸…ç†å·¥ä½œï¼Œä¾‹å¦‚å…³é—­æ•°æ®åº“è¿æ¥ã€æ¸…ç†æµ‹è¯•æ–‡ä»¶ç­‰ã€‚è¿™æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨<code>_test.go</code>æ–‡ä»¶ä¸­æ·»åŠ <code>TestMain</code>å‡½æ•°ï¼Œå…¶å…¥å‚ä¸º<code>*testing.M</code>ã€‚</p><p><code>TestMain</code>æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å‡½æ•°ï¼ˆç›¸å½“äºmainå‡½æ•°ï¼‰ï¼Œæµ‹è¯•ç”¨ä¾‹åœ¨æ‰§è¡Œæ—¶ï¼Œä¼šå…ˆæ‰§è¡Œ<code>TestMain</code>å‡½æ•°ï¼Œç„¶åå¯ä»¥åœ¨<code>TestMain</code>ä¸­è°ƒç”¨<code>m.Run()</code>å‡½æ•°æ‰§è¡Œæ™®é€šçš„æµ‹è¯•å‡½æ•°ã€‚åœ¨<code>m.Run()</code>å‡½æ•°å‰é¢æˆ‘ä»¬å¯ä»¥ç¼–å†™å‡†å¤‡é€»è¾‘ï¼Œåœ¨<code>m.Run()</code>åé¢æˆ‘ä»¬å¯ä»¥ç¼–å†™æ¸…ç†é€»è¾‘ã€‚</p><p>æˆ‘ä»¬åœ¨ç¤ºä¾‹æµ‹è¯•æ–‡ä»¶<a href=\"https://github.com/marmotedu/gopractise-demo/blob/master/test/math_test.go\">math_test.go</a>ä¸­æ·»åŠ å¦‚ä¸‹TestMainå‡½æ•°ï¼š</p><pre><code class=\"language-go\">func TestMain(m *testing.M) {\n    fmt.Println(\"do some setup\")\n    m.Run()\n    fmt.Println(\"do some cleanup\")\n}\n</code></pre><p>æ‰§è¡Œgo testï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š</p><pre><code class=\"language-bash\">$ go test -v\ndo some setup\n=== RUN   TestAbs\n--- PASS: TestAbs (0.00s)\n...\n=== RUN   ExampleMax\n--- PASS: ExampleMax (0.00s)\nPASS\ndo some cleanup\nok  \tgithub.com/marmotedu/gopractise-demo/31/test\t0.006s\n</code></pre><p>åœ¨æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹ä¹‹å‰ï¼Œæ‰“å°äº†<code>do some setup</code>ï¼Œåœ¨æµ‹è¯•ç”¨ä¾‹è¿è¡Œå®Œæˆä¹‹åï¼Œæ‰“å°äº†<code>do some cleanup</code>ã€‚</p><p>IAMé¡¹ç›®çš„æµ‹è¯•ç”¨ä¾‹ä¸­ï¼Œä½¿ç”¨TestMainå‡½æ•°åœ¨æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹å‰è¿æ¥äº†ä¸€ä¸ªfakeæ•°æ®åº“ï¼Œä»£ç å¦‚ä¸‹ï¼ˆä½äº<a href=\"https://github.com/marmotedu/iam/blob/v1.0.8/internal/apiserver/service/v1/user_test.go\">internal/apiserver/service/v1/user_test.go</a>æ–‡ä»¶ä¸­ï¼‰ï¼š</p><pre><code class=\"language-go\">func TestMain(m *testing.M) {\n    fakeStore, _ := fake.NewFakeStore()\n    store.SetClient(fakeStore)\n    os.Exit(m.Run())\n}\n</code></pre><p>å•å…ƒæµ‹è¯•ã€æ€§èƒ½æµ‹è¯•ã€ç¤ºä¾‹æµ‹è¯•ã€TestMainå‡½æ•°æ˜¯go testæ”¯æŒçš„æµ‹è¯•ç±»å‹ã€‚æ­¤å¤–ï¼Œä¸ºäº†æµ‹è¯•åœ¨å‡½æ•°å†…ä½¿ç”¨äº†Go Interfaceçš„å‡½æ•°ï¼Œæˆ‘ä»¬è¿˜å»¶ä¼¸å‡ºäº†Mockæµ‹è¯•å’ŒFakeæµ‹è¯•ä¸¤ç§æµ‹è¯•ç±»å‹ã€‚</p><h2>Mockæµ‹è¯•</h2><p>ä¸€èˆ¬æ¥è¯´ï¼Œå•å…ƒæµ‹è¯•ä¸­æ˜¯ä¸å…è®¸æœ‰å¤–éƒ¨ä¾èµ–çš„ï¼Œé‚£ä¹ˆä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™äº›å¤–éƒ¨ä¾èµ–éƒ½éœ€è¦è¢«æ¨¡æ‹Ÿã€‚åœ¨Goä¸­ï¼Œä¸€èˆ¬ä¼šå€ŸåŠ©å„ç±»Mockå·¥å…·æ¥æ¨¡æ‹Ÿä¸€äº›ä¾èµ–ã€‚</p><p>GoMockæ˜¯ç”±Golangå®˜æ–¹å¼€å‘ç»´æŠ¤çš„æµ‹è¯•æ¡†æ¶ï¼Œå®ç°äº†è¾ƒä¸ºå®Œæ•´çš„åŸºäºinterfaceçš„MockåŠŸèƒ½ï¼Œèƒ½å¤Ÿä¸Golangå†…ç½®çš„testingåŒ…è‰¯å¥½é›†æˆï¼Œä¹Ÿèƒ½ç”¨äºå…¶ä»–çš„æµ‹è¯•ç¯å¢ƒä¸­ã€‚GoMockæµ‹è¯•æ¡†æ¶åŒ…å«äº†GoMockåŒ…å’Œmockgenå·¥å…·ä¸¤éƒ¨åˆ†ï¼Œå…¶ä¸­GoMockåŒ…ç”¨æ¥å®Œæˆå¯¹è±¡ç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†ï¼Œmockgenå·¥å…·ç”¨æ¥ç”Ÿæˆinterfaceå¯¹åº”çš„Mockç±»æºæ–‡ä»¶ã€‚ä¸‹é¢ï¼Œæˆ‘æ¥åˆ†åˆ«è¯¦ç»†ä»‹ç»ä¸‹GoMockåŒ…å’Œmockgenå·¥å…·ï¼Œä»¥åŠå®ƒä»¬çš„ä½¿ç”¨æ–¹æ³•ã€‚</p><h3>å®‰è£…GoMock</h3><p>è¦ä½¿ç”¨GoMockï¼Œé¦–å…ˆéœ€è¦å®‰è£…GoMockåŒ…å’Œmockgenå·¥å…·ï¼Œå®‰è£…æ–¹æ³•å¦‚ä¸‹:</p><pre><code class=\"language-bash\">$ go get github.com/golang/mock/gomock\n$ go install github.com/golang/mock/mockgen\n</code></pre><p>ä¸‹é¢ï¼Œæˆ‘é€šè¿‡ä¸€ä¸ª<strong>è·å–å½“å‰Golangæœ€æ–°ç‰ˆæœ¬çš„ä¾‹å­</strong>ï¼Œæ¥ç»™ä½ æ¼”ç¤ºä¸‹å¦‚ä½•ä½¿ç”¨GoMockã€‚ç¤ºä¾‹ä»£ç ç›®å½•ç»“æ„å¦‚ä¸‹ï¼ˆç›®å½•ä¸‹çš„ä»£ç è§<a href=\"https://github.com/marmotedu/gopractise-demo/tree/master/gomock\">gomock</a>ï¼‰ï¼š</p><pre><code class=\"language-bash\">tree .\n.\nâ”œâ”€â”€ go_version.go\nâ”œâ”€â”€ main.go\nâ””â”€â”€ spider\n    â””â”€â”€ spider.go\n</code></pre><p><code>spider.go</code>æ–‡ä»¶ä¸­å®šä¹‰äº†ä¸€ä¸ª<code>Spider</code>æ¥å£ï¼Œ<code>spider.go</code>ä»£ç å¦‚ä¸‹ï¼š</p><pre><code class=\"language-go\">package spider\n\ntype Spider interface {\n    GetBody() string\n}\n</code></pre><p><code>Spider</code>æ¥å£ä¸­çš„GetBodyæ–¹æ³•å¯ä»¥æŠ“å–<code>https://golang.org</code>é¦–é¡µçš„<code>Build version</code>å­—æ®µï¼Œæ¥è·å–Golangçš„æœ€æ–°ç‰ˆæœ¬ã€‚</p><p>æˆ‘ä»¬åœ¨<code>go_version.go</code>æ–‡ä»¶ä¸­ï¼Œè°ƒç”¨<code>Spider</code>æ¥å£çš„<code>GetBody</code>æ–¹æ³•ï¼Œ<code>go_version.go</code>ä»£ç å¦‚ä¸‹ï¼š</p><pre><code class=\"language-go\">package gomock\n\nimport (\n    \"github.com/marmotedu/gopractise-demo/gomock/spider\"\n)\n\nfunc GetGoVersion(s spider.Spider) string {\n    body := s.GetBody()\n    return body\n}\n</code></pre><p><code>GetGoVersion</code>å‡½æ•°ç›´æ¥è¿”å›è¡¨ç¤ºç‰ˆæœ¬çš„å­—ç¬¦ä¸²ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šå†™å‡ºå¦‚ä¸‹çš„å•å…ƒæµ‹è¯•ä»£ç ï¼š</p><pre><code class=\"language-go\">func TestGetGoVersion(t *testing.T) {\n    v := GetGoVersion(spider.CreateGoVersionSpider())\n    if v != \"go1.8.3\" {\n        t.Error(\"Get wrong version %s\", v)\n    }\n}\n</code></pre><p>ä¸Šé¢çš„æµ‹è¯•ä»£ç ï¼Œä¾èµ–<code>spider.CreateGoVersionSpider()</code>è¿”å›ä¸€ä¸ªå®ç°äº†<code>Spider</code>æ¥å£çš„å®ä¾‹ï¼ˆçˆ¬è™«ï¼‰ã€‚ä½†å¾ˆå¤šæ—¶å€™ï¼Œ<code>spider.CreateGoVersionSpider()</code>çˆ¬è™«å¯èƒ½è¿˜æ²¡æœ‰å®ç°ï¼Œæˆ–è€…åœ¨å•å…ƒæµ‹è¯•ç¯å¢ƒä¸‹ä¸èƒ½è¿è¡Œï¼ˆæ¯”å¦‚ï¼Œåœ¨å•å…ƒæµ‹è¯•ç¯å¢ƒä¸­è¿æ¥æ•°æ®åº“ï¼‰ï¼Œè¿™æ—¶å€™<code>TestGetGoVersion</code>æµ‹è¯•ç”¨ä¾‹å°±æ— æ³•æ‰§è¡Œã€‚</p><p>é‚£ä¹ˆï¼Œå¦‚ä½•æ‰èƒ½åœ¨è¿™ç§æƒ…å†µä¸‹è¿è¡Œ<code>TestGetGoVersion</code>æµ‹è¯•ç”¨ä¾‹å‘¢ï¼Ÿè¿™æ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡Mockå·¥å…·ï¼ŒMockä¸€ä¸ªçˆ¬è™«å®ä¾‹ã€‚æ¥ä¸‹æ¥æˆ‘è®²è®²å…·ä½“æ“ä½œã€‚</p><p>é¦–å…ˆï¼Œç”¨ GoMock æä¾›çš„mockgenå·¥å…·ï¼Œç”Ÿæˆè¦ Mock çš„æ¥å£çš„å®ç°ï¼Œæˆ‘ä»¬åœ¨gomockç›®å½•ä¸‹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><pre><code class=\"language-bash\">$ mockgen -destination spider/mock/mock_spider.go -package spider github.com/marmotedu/gopractise-demo/gomock/spider Spider\n</code></pre><p>ä¸Šé¢çš„å‘½ä»¤ä¼šåœ¨<code>spider/mock</code>ç›®å½•ä¸‹ç”Ÿæˆ<code>mock_spider.go</code>æ–‡ä»¶ï¼š</p><pre><code class=\"language-bash\">$ tree .\n.\nâ”œâ”€â”€ go_version.go\nâ”œâ”€â”€ go_version_test.go\nâ”œâ”€â”€ go_version_test_traditional_method.go~\nâ””â”€â”€ spider\n    â”œâ”€â”€ mock\n    â”‚&nbsp;&nbsp; â””â”€â”€ mock_spider.go\n    â””â”€â”€ spider.go\n</code></pre><p><code>mock_spider.go</code>æ–‡ä»¶ä¸­ï¼Œå®šä¹‰äº†ä¸€äº›å‡½æ•°/æ–¹æ³•ï¼Œå¯ä»¥æ”¯æŒæˆ‘ä»¬ç¼–å†™<code>TestGetGoVersion</code>æµ‹è¯•å‡½æ•°ã€‚è¿™æ—¶å€™ï¼Œæˆ‘ä»¬çš„å•å…ƒæµ‹è¯•ä»£ç å¦‚ä¸‹ï¼ˆè§<a href=\"https://github.com/marmotedu/gopractise-demo/blob/master/gomock/go_version_test.go\">go_version_test.go</a>æ–‡ä»¶ï¼‰ï¼š</p><pre><code class=\"language-go\">package gomock\n\nimport (\n\t\"testing\"\n\n\t\"github.com/golang/mock/gomock\"\n\n\tspider \"github.com/marmotedu/gopractise-demo/gomock/spider/mock\"\n)\n\nfunc TestGetGoVersion(t *testing.T) {\n\tctrl := gomock.NewController(t)\n\tdefer ctrl.Finish()\n\n\tmockSpider := spider.NewMockSpider(ctrl)\n\tmockSpider.EXPECT().GetBody().Return(\"go1.8.3\")\n\tgoVer := GetGoVersion(mockSpider)\n\n\tif goVer != \"go1.8.3\" {\n\t\tt.Errorf(\"Get wrong version %s\", goVer)\n\t}\n}\n</code></pre><p>è¿™ä¸€ç‰ˆæœ¬çš„<code>TestGetGoVersion</code>é€šè¿‡GoMockï¼Œ Mockäº†ä¸€ä¸ª<code>Spider</code>æ¥å£ï¼Œè€Œä¸ç”¨å»å®ç°ä¸€ä¸ª<code>Spider</code>æ¥å£ã€‚è¿™å°±å¤§å¤§é™ä½äº†å•å…ƒæµ‹è¯•ç”¨ä¾‹ç¼–å†™çš„å¤æ‚åº¦ã€‚é€šè¿‡Mockï¼Œå¾ˆå¤šä¸èƒ½æµ‹è¯•çš„å‡½æ•°ä¹Ÿå˜å¾—å¯æµ‹è¯•äº†ã€‚</p><p>é€šè¿‡ä¸Šé¢çš„æµ‹è¯•ç”¨ä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒGoMock å’Œ<a href=\"https://time.geekbang.org/column/article/408529\">ä¸Šä¸€è®²</a>ä»‹ç»çš„testingå•å…ƒæµ‹è¯•æ¡†æ¶å¯ä»¥ç´§å¯†åœ°ç»“åˆèµ·æ¥å·¥ä½œã€‚</p><h3>mockgenå·¥å…·ä»‹ç»</h3><p>ä¸Šé¢ï¼Œæˆ‘ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨ GoMock ç¼–å†™å•å…ƒæµ‹è¯•ç”¨ä¾‹ã€‚å…¶ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨åˆ°äº†<code>mockgen</code>å·¥å…·æ¥ç”Ÿæˆ Mockä»£ç ï¼Œ<code>mockgen</code>å·¥å…·æä¾›äº†å¾ˆå¤šæœ‰ç”¨çš„åŠŸèƒ½ï¼Œè¿™é‡Œæˆ‘æ¥è¯¦ç»†ä»‹ç»ä¸‹ã€‚</p><p><code>mockgen</code>å·¥å…·æ˜¯ GoMock æä¾›çš„ï¼Œç”¨æ¥Mockä¸€ä¸ªGoæ¥å£ã€‚å®ƒå¯ä»¥æ ¹æ®ç»™å®šçš„æ¥å£ï¼Œæ¥è‡ªåŠ¨ç”ŸæˆMockä»£ç ã€‚è¿™é‡Œï¼Œæœ‰ä¸¤ç§æ¨¡å¼å¯ä»¥ç”ŸæˆMockä»£ç ï¼Œåˆ†åˆ«æ˜¯æºç æ¨¡å¼å’Œåå°„æ¨¡å¼ã€‚</p><ol>\n<li>æºç æ¨¡å¼</li>\n</ol><p>å¦‚æœæœ‰æ¥å£æ–‡ä»¶ï¼Œåˆ™å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ¥ç”ŸæˆMockä»£ç ï¼š</p><pre><code class=\"language-bash\">$ mockgen -destination spider/mock/mock_spider.go -package spider -source spider/spider.go\n</code></pre><p>ä¸Šé¢çš„å‘½ä»¤ï¼ŒMockäº†<code>spider/spider.go</code>æ–‡ä»¶ä¸­å®šä¹‰çš„<code>Spider</code>æ¥å£ï¼Œå¹¶å°†Mockä»£ç ä¿å­˜åœ¨<code>spider/mock/mock_spider.go</code>æ–‡ä»¶ä¸­ï¼Œæ–‡ä»¶çš„åŒ…åä¸º<code>spider</code>ã€‚</p><p>mockgenå·¥å…·çš„å‚æ•°è¯´æ˜è§ä¸‹è¡¨ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/e7/9c/e72102362e2ae3225e868f125654689c.jpg?wh=1920x1210\" alt=\"å›¾ç‰‡\"></p><ol start=\"2\">\n<li>åå°„æ¨¡å¼</li>\n</ol><p>æ­¤å¤–ï¼Œmockgenå·¥å…·è¿˜æ”¯æŒé€šè¿‡ä½¿ç”¨åå°„ç¨‹åºæ¥ç”Ÿæˆ Mock ä»£ç ã€‚å®ƒé€šè¿‡ä¼ é€’ä¸¤ä¸ªéæ ‡å¿—å‚æ•°ï¼Œå³å¯¼å…¥è·¯å¾„å’Œé€—å·åˆ†éš”çš„æ¥å£åˆ—è¡¨æ¥å¯ç”¨ï¼Œå…¶ä»–å‚æ•°å’Œæºç æ¨¡å¼å…±ç”¨ï¼Œä¾‹å¦‚ï¼š</p><pre><code class=\"language-bash\">$ mockgen -destination spider/mock/mock_spider.go -package spider github.com/marmotedu/gopractise-demo/gomock/spider Spider\n</code></pre><h3>é€šè¿‡æ³¨é‡Šä½¿ç”¨mockgen</h3><p>å¦‚æœæœ‰å¤šä¸ªæ–‡ä»¶ï¼Œå¹¶ä¸”åˆ†æ•£åœ¨ä¸åŒçš„ä½ç½®ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¦ç”ŸæˆMockæ–‡ä»¶çš„æ—¶å€™ï¼Œéœ€è¦å¯¹æ¯ä¸ªæ–‡ä»¶æ‰§è¡Œå¤šæ¬¡mockgenå‘½ä»¤ï¼ˆè¿™é‡Œå‡è®¾åŒ…åä¸ç›¸åŒï¼‰ã€‚è¿™ç§æ“ä½œè¿˜æ˜¯æ¯”è¾ƒç¹ççš„ï¼Œmockgenè¿˜æä¾›äº†ä¸€ç§é€šè¿‡æ³¨é‡Šç”ŸæˆMockæ–‡ä»¶çš„æ–¹å¼ï¼Œæ­¤æ—¶éœ€è¦å€ŸåŠ©<code>go generate</code>å·¥å…·ã€‚</p><p>åœ¨æ¥å£æ–‡ä»¶çš„ä»£ç ä¸­ï¼Œæ·»åŠ ä»¥ä¸‹æ³¨é‡Šï¼ˆå…·ä½“ä»£ç è§<a href=\"https://github.com/marmotedu/gopractise-demo/blob/master/gomock/spider/spider.go#L3\">spider.go</a>æ–‡ä»¶ï¼‰ï¼š</p><pre><code class=\"language-go\">//go:generate mockgen -destination mock_spider.go -package spider github.com/cz-it/blog/blog/Go/testing/gomock/example/spider Spider\n</code></pre><p>è¿™æ—¶å€™ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨<code>gomock</code>ç›®å½•ä¸‹ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå°±å¯ä»¥è‡ªåŠ¨ç”ŸæˆMockä»£ç ï¼š</p><pre><code class=\"language-bash\">$ go generate ./...\n</code></pre><h3>ä½¿ç”¨Mockä»£ç ç¼–å†™å•å…ƒæµ‹è¯•ç”¨ä¾‹</h3><p>ç”Ÿæˆäº†Mockä»£ç ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨å®ƒä»¬äº†ã€‚è¿™é‡Œæˆ‘ä»¬ç»“åˆ<code>testing</code>æ¥ç¼–å†™ä¸€ä¸ªä½¿ç”¨äº†Mockä»£ç çš„å•å…ƒæµ‹è¯•ç”¨ä¾‹ã€‚</p><p><strong>é¦–å…ˆï¼Œ</strong>éœ€è¦åœ¨å•å…ƒæµ‹è¯•ä»£ç é‡Œåˆ›å»ºä¸€ä¸ªMockæ§åˆ¶å™¨ï¼š</p><pre><code class=\"language-go\">ctrl := gomock.NewController(t)\n</code></pre><p>å°†<code>*testing.T</code>ä¼ é€’ç»™GoMock ï¼Œç”Ÿæˆä¸€ä¸ª<code>Controller</code>å¯¹è±¡ï¼Œè¯¥å¯¹è±¡æ§åˆ¶äº†æ•´ä¸ªMockçš„è¿‡ç¨‹ã€‚åœ¨æ“ä½œå®Œåï¼Œè¿˜éœ€è¦è¿›è¡Œå›æ”¶ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¼šåœ¨<code>NewController</code>åé¢deferä¸€ä¸ªFinishï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre><code class=\"language-go\">defer ctrl.Finish()\n</code></pre><p><strong>ç„¶åï¼Œ</strong>å°±å¯ä»¥è°ƒç”¨Mockçš„å¯¹è±¡äº†ï¼š</p><pre><code class=\"language-go\">mockSpider := spider.NewMockSpider(ctrl)\n</code></pre><p>è¿™é‡Œçš„<code>spider</code>æ˜¯mockgenå‘½ä»¤é‡Œé¢ä¼ é€’çš„åŒ…åï¼Œåé¢æ˜¯<code>NewMockXxxx</code>æ ¼å¼çš„å¯¹è±¡åˆ›å»ºå‡½æ•°ï¼Œ<code>Xxx</code>æ˜¯æ¥å£åã€‚è¿™é‡Œï¼Œæˆ‘ä»¬éœ€è¦ä¼ é€’æ§åˆ¶å™¨å¯¹è±¡è¿›å»ï¼Œè¿”å›ä¸€ä¸ªMockå®ä¾‹ã€‚</p><p><strong>æ¥ç€ï¼Œ</strong>æœ‰äº†Mockå®ä¾‹ï¼Œæˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨å…¶æ–­è¨€æ–¹æ³•<code>EXPECT()</code>äº†ã€‚</p><p>gomocké‡‡ç”¨äº†é“¾å¼è°ƒç”¨æ³•ï¼Œé€šè¿‡<code>.</code>è¿æ¥å‡½æ•°è°ƒç”¨ï¼Œå¯ä»¥åƒé“¾æ¡ä¸€æ ·è¿æ¥ä¸‹å»ã€‚ä¾‹å¦‚ï¼š</p><pre><code class=\"language-go\">mockSpider.EXPECT().GetBody().Return(\"go1.8.3\")\n</code></pre><p>Mockä¸€ä¸ªæ¥å£çš„æ–¹æ³•ï¼Œæˆ‘ä»¬éœ€è¦Mockè¯¥æ–¹æ³•çš„å…¥å‚å’Œè¿”å›å€¼ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å‚æ•°åŒ¹é…æ¥Mockå…¥å‚ï¼Œé€šè¿‡Mockå®ä¾‹çš„ <code>Return</code> æ–¹æ³•æ¥Mockè¿”å›å€¼ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥åˆ†åˆ«çœ‹ä¸‹å¦‚ä½•æŒ‡å®šå…¥å‚å’Œè¿”å›å€¼ã€‚</p><p>å…ˆæ¥çœ‹å¦‚ä½•æŒ‡å®šå…¥å‚ã€‚å¦‚æœå‡½æ•°æœ‰å‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å‚æ•°åŒ¹é…æ¥æŒ‡ä»£å‡½æ•°çš„å‚æ•°ï¼Œä¾‹å¦‚ï¼š</p><pre><code class=\"language-go\">mockSpider.EXPECT().GetBody(gomock.Any(), gomock.Eq(\"admin\")).Return(\"go1.8.3\")\n</code></pre><p>gomockæ”¯æŒä»¥ä¸‹å‚æ•°åŒ¹é…ï¼š</p><ul>\n<li>gomock.Any()ï¼Œå¯ä»¥ç”¨æ¥è¡¨ç¤ºä»»æ„çš„å…¥å‚ã€‚</li>\n<li>gomock.Eq(value)ï¼Œç”¨æ¥è¡¨ç¤ºä¸ value ç­‰ä»·çš„å€¼ã€‚</li>\n<li>gomock.Not(value)ï¼Œç”¨æ¥è¡¨ç¤ºé value ä»¥å¤–çš„å€¼ã€‚</li>\n<li>gomock.Nil()ï¼Œç”¨æ¥è¡¨ç¤º None å€¼ã€‚</li>\n</ul><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹å¦‚ä½•æŒ‡å®šè¿”å›å€¼ã€‚</p><p><code>EXPECT()</code>å¾—åˆ°Mockçš„å®ä¾‹ï¼Œç„¶åè°ƒç”¨Mockå®ä¾‹çš„æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿”å›ç¬¬ä¸€ä¸ª<code>Call</code>å¯¹è±¡ï¼Œç„¶åå¯ä»¥å¯¹å…¶è¿›è¡Œæ¡ä»¶çº¦æŸï¼Œæ¯”å¦‚ä½¿ç”¨Mockå®ä¾‹çš„ <code>Return</code> æ–¹æ³•çº¦æŸå…¶è¿”å›å€¼ã€‚<code>Call</code>å¯¹è±¡è¿˜æä¾›äº†ä»¥ä¸‹æ–¹æ³•æ¥çº¦æŸMockå®ä¾‹ï¼š</p><pre><code class=\"language-go\">func (c *Call) After(preReq *Call) *Call // Afterå£°æ˜è°ƒç”¨åœ¨preReqå®Œæˆåæ‰§è¡Œ\nfunc (c *Call) AnyTimes() *Call // å…è®¸è°ƒç”¨æ¬¡æ•°ä¸º 0 æ¬¡æˆ–æ›´å¤šæ¬¡\nfunc (c *Call) Do(f interface{}) *Call // å£°æ˜åœ¨åŒ¹é…æ—¶è¦è¿è¡Œçš„æ“ä½œ\nfunc (c *Call) MaxTimes(n int) *Call // è®¾ç½®æœ€å¤§çš„è°ƒç”¨æ¬¡æ•°ä¸º n æ¬¡\nfunc (c *Call) MinTimes(n int) *Call // è®¾ç½®æœ€å°çš„è°ƒç”¨æ¬¡æ•°ä¸º n æ¬¡\nfunc (c *Call) Return(rets ...interface{}) *Call //  // å£°æ˜æ¨¡æ‹Ÿå‡½æ•°è°ƒç”¨è¿”å›çš„å€¼\nfunc (c *Call) SetArg(n int, value interface{}) *Call // å£°æ˜ä½¿ç”¨æŒ‡é’ˆè®¾ç½®ç¬¬ n ä¸ªå‚æ•°çš„å€¼\nfunc (c *Call) Times(n int) *Call // è®¾ç½®è°ƒç”¨æ¬¡æ•°ä¸º n æ¬¡\n</code></pre><p>ä¸Šé¢åˆ—å‡ºäº†å¤šä¸ª <code>Call</code> å¯¹è±¡æä¾›çš„çº¦æŸæ–¹æ³•ï¼Œæ¥ä¸‹æ¥æˆ‘ä¼šä»‹ç»3ä¸ªå¸¸ç”¨çš„çº¦æŸæ–¹æ³•ï¼šæŒ‡å®šè¿”å›å€¼ã€æŒ‡å®šæ‰§è¡Œæ¬¡æ•°å’ŒæŒ‡å®šæ‰§è¡Œé¡ºåºã€‚</p><ol>\n<li>æŒ‡å®šè¿”å›å€¼</li>\n</ol><p>æˆ‘ä»¬å¯ä»¥æä¾›è°ƒç”¨<code>Call</code>çš„<code>Return</code>å‡½æ•°ï¼Œæ¥æŒ‡å®šæ¥å£çš„è¿”å›å€¼ï¼Œä¾‹å¦‚ï¼š</p><pre><code class=\"language-go\">mockSpider.EXPECT().GetBody().Return(\"go1.8.3\")\n</code></pre><ol start=\"2\">\n<li>æŒ‡å®šæ‰§è¡Œæ¬¡æ•°</li>\n</ol><p>æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦æŒ‡å®šå‡½æ•°æ‰§è¡Œå¤šå°‘æ¬¡ï¼Œä¾‹å¦‚ï¼šå¯¹äºæ¥å—ç½‘ç»œè¯·æ±‚çš„å‡½æ•°ï¼Œè®¡ç®—å…¶æ‰§è¡Œäº†å¤šå°‘æ¬¡ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>Call</code>çš„<code>Times</code>å‡½æ•°æ¥æŒ‡å®šæ‰§è¡Œæ¬¡æ•°ï¼š</p><pre><code class=\"language-go\">mockSpider.EXPECT().Recv().Return(nil).Times(3)\n</code></pre><p>ä¸Šè¿°ä»£ç ï¼Œæ‰§è¡Œäº†ä¸‰æ¬¡Recvå‡½æ•°ï¼Œè¿™é‡Œgomockè¿˜æ”¯æŒå…¶ä»–çš„æ‰§è¡Œæ¬¡æ•°é™åˆ¶ï¼š</p><ul>\n<li>AnyTimes()ï¼Œè¡¨ç¤ºæ‰§è¡Œ0åˆ°å¤šæ¬¡ã€‚</li>\n<li>MaxTimes(n int)ï¼Œè¡¨ç¤ºå¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œæœ€å¤šæ‰§è¡Œnæ¬¡ã€‚</li>\n<li>MinTimes(n int)ï¼Œè¡¨ç¤ºå¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œæœ€å°‘æ‰§è¡Œnæ¬¡ã€‚</li>\n</ul><ol start=\"3\">\n<li>æŒ‡å®šæ‰§è¡Œé¡ºåº</li>\n</ol><p>æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬è¿˜è¦æŒ‡å®šæ‰§è¡Œé¡ºåºï¼Œæ¯”å¦‚è¦å…ˆæ‰§è¡Œ Init æ“ä½œï¼Œç„¶åæ‰èƒ½æ‰§è¡ŒRecvæ“ä½œï¼š</p><pre><code class=\"language-go\">initCall := mockSpider.EXPECT().Init()\nmockSpider.EXPECT().Recv().After(initCall)\n</code></pre><p>æœ€åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>go test</code>æ¥æµ‹è¯•ä½¿ç”¨äº†Mockä»£ç çš„å•å…ƒæµ‹è¯•ä»£ç ï¼š</p><pre><code class=\"language-bash\">$ go test -v\n=== RUN   TestGetGoVersion\n--- PASS: TestGetGoVersion (0.00s)\nPASS\nok  \tgithub.com/marmotedu/gopractise-demo/gomock\t0.002s\n</code></pre><h2>Fakeæµ‹è¯•</h2><p>åœ¨Goé¡¹ç›®å¼€å‘ä¸­ï¼Œå¯¹äºæ¯”è¾ƒå¤æ‚çš„æ¥å£ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥Fakeä¸€ä¸ªæ¥å£å®ç°ï¼Œæ¥è¿›è¡Œæµ‹è¯•ã€‚æ‰€è°“Fakeæµ‹è¯•ï¼Œå…¶å®å°±æ˜¯é’ˆå¯¹æ¥å£å®ç°ä¸€ä¸ªå‡ï¼ˆfakeï¼‰çš„å®ä¾‹ã€‚è‡³äºå¦‚ä½•å®ç°Fakeå®ä¾‹ï¼Œéœ€è¦ä½ æ ¹æ®ä¸šåŠ¡è‡ªè¡Œå®ç°ã€‚ä¾‹å¦‚ï¼šIAMé¡¹ç›®ä¸­iam-apiserverç»„ä»¶å°±å®ç°äº†ä¸€ä¸ªfake storeï¼Œä»£ç è§<a href=\"https://github.com/marmotedu/iam/tree/v1.0.8/internal/apiserver/store/fake\">fake</a>ç›®å½•ã€‚å› ä¸ºè¿™ä¸€è®²åé¢çš„IAMé¡¹ç›®æµ‹è¯•å®æˆ˜éƒ¨åˆ†æœ‰ä»‹ç»ï¼Œæ‰€ä»¥è¿™é‡Œä¸å†å±•å¼€è®²è§£ã€‚</p><h2>ä½•æ—¶ç¼–å†™å’Œæ‰§è¡Œå•å…ƒæµ‹è¯•ç”¨ä¾‹ï¼Ÿ</h2><p>ä¸Šé¢ï¼Œæˆ‘ä»‹ç»äº†Goä»£ç æµ‹è¯•çš„åŸºç¡€çŸ¥è¯†ï¼Œè¿™é‡Œæˆ‘å†æ¥åˆ†äº«ä¸‹åœ¨åšæµ‹è¯•æ—¶ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„çŸ¥è¯†ç‚¹ï¼šä½•æ—¶ç¼–å†™å’Œæ‰§è¡Œå•å…ƒæµ‹è¯•ç”¨ä¾‹ã€‚</p><h3>ç¼–ç å‰ï¼šTDD</h3><p><img src=\"https://static001.geekbang.org/resource/image/48/b2/4830b21b55d194eccf1ec74637ee3eb2.png?wh=538x516\" alt=\"å›¾ç‰‡\"></p><p>Test-Driven Developmentï¼Œä¹Ÿå°±æ˜¯æµ‹è¯•é©±åŠ¨å¼€å‘ï¼Œæ˜¯æ•æ·å¼€å‘çš„â¼€é¡¹æ ¸å¿ƒå®è·µå’ŒæŠ€æœ¯ï¼Œä¹Ÿæ˜¯â¼€ç§è®¾è®¡æ–¹æ³•è®ºã€‚ç®€å•æ¥è¯´ï¼ŒTDDåŸç†å°±æ˜¯ï¼šå¼€å‘åŠŸèƒ½ä»£ç ä¹‹å‰ï¼Œå…ˆç¼–å†™æµ‹è¯•ç”¨ä¾‹ä»£ç ï¼Œç„¶åé’ˆå¯¹æµ‹è¯•ç”¨ä¾‹ç¼–å†™åŠŸèƒ½ä»£ç ï¼Œä½¿å…¶èƒ½å¤Ÿé€šè¿‡ã€‚è¿™æ ·åšçš„å¥½å¤„åœ¨äºï¼Œé€šè¿‡æµ‹è¯•çš„æ‰§è¡Œä»£ç è‚¯å®šæ»¡è¶³éœ€æ±‚ï¼Œè€Œä¸”æœ‰åŠ©äºé¢å‘æ¥å£ç¼–ç¨‹ï¼Œé™ä½ä»£ç è€¦åˆï¼Œä¹Ÿæå¤§é™ä½äº†bugçš„å‡ºç°å‡ ç‡ã€‚</p><p>ç„¶è€Œï¼ŒTDDçš„åå¤„ä¹Ÿæ˜¾è€Œæ˜“è§ï¼šç”±äºæµ‹è¯•ç”¨ä¾‹æ˜¯åœ¨è¿›è¡Œä»£ç è®¾è®¡ä¹‹å‰å†™çš„ï¼Œå¾ˆæœ‰å¯èƒ½é™åˆ¶å¼€å‘è€…å¯¹ä»£ç çš„æ•´ä½“è®¾è®¡ï¼›å¹¶ä¸”ï¼Œç”±äºTDDå¯¹å¼€å‘â¼ˆå‘˜è¦æ±‚éå¸¸é«˜ï¼Œä½“ç°çš„æ€æƒ³è·Ÿä¼ ç»Ÿå¼€å‘æ€ç»´ä¹Ÿä¸â¼€æ ·ï¼Œå› æ­¤å®æ–½èµ·æ¥æ¯”è¾ƒå›°éš¾ï¼›æ­¤å¤–ï¼Œå› ä¸ºè¦å…ˆç¼–å†™æµ‹è¯•ç”¨ä¾‹ï¼ŒTDDä¹Ÿå¯èƒ½ä¼šå½±å“é¡¹ç›®çš„ç ”å‘è¿›åº¦ã€‚æ‰€ä»¥ï¼Œåœ¨å®¢è§‚æƒ…å†µä¸æ»¡è¶³çš„æƒ…å†µä¸‹ï¼Œä¸åº”è¯¥ç›²ç›®è¿½æ±‚å¯¹ä¸šåŠ¡ä»£ç ä½¿ç”¨TDDçš„å¼€å‘æ¨¡å¼ã€‚</p><h3>ä¸ç¼–ç åŒæ­¥è¿›è¡Œï¼šå¢é‡</h3><p>åŠæ—¶ä¸ºå¢é‡ä»£ç å†™å•æµ‹æ˜¯ä¸€ç§è‰¯å¥½çš„ä¹ æƒ¯ã€‚ä¸€æ–¹é¢æ˜¯å› ä¸ºï¼Œæ­¤æ—¶æˆ‘ä»¬å¯¹éœ€æ±‚æœ‰ä¸€å®šçš„ç†è§£ï¼Œèƒ½å¤Ÿæ›´å¥½åœ°å†™å‡ºå•å…ƒæµ‹è¯•æ¥éªŒè¯æ­£ç¡®æ€§ã€‚å¹¶ä¸”ï¼Œåœ¨å•æµ‹é˜¶æ®µå°±å‘ç°é—®é¢˜ï¼Œè€Œä¸æ˜¯ç­‰åˆ°è”è°ƒæµ‹è¯•ä¸­æ‰å‘ç°ï¼Œä¿®å¤çš„æˆæœ¬ä¹Ÿæ˜¯æœ€å°çš„ã€‚</p><p>å¦ä¸€æ–¹é¢ï¼Œåœ¨å†™å•æµ‹çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿèƒ½å¤Ÿåæ€ä¸šåŠ¡ä»£ç çš„æ­£ç¡®æ€§ã€åˆç†æ€§ï¼Œæ¨åŠ¨æˆ‘ä»¬åœ¨å®ç°çš„è¿‡ç¨‹ä¸­æ›´å¥½åœ°åæ€ä»£ç çš„è®¾è®¡ï¼Œå¹¶åŠæ—¶è°ƒæ•´ã€‚</p><h3>ç¼–ç åï¼šå­˜é‡</h3><p>åœ¨å®Œæˆä¸šåŠ¡éœ€æ±‚åï¼Œæˆ‘ä»¬å¯èƒ½ä¼šé‡åˆ°è¿™ç§æƒ…å†µï¼šå› ä¸ºä¸Šçº¿æ—¶é—´æ¯”è¾ƒç´§å¼ ã€æ²¡æœ‰å•æµ‹ç›¸å…³è§„åˆ’ï¼Œå¼€å‘é˜¶æ®µåªæ‰‹åŠ¨æµ‹è¯•äº†ä»£ç æ˜¯å¦ç¬¦åˆåŠŸèƒ½ã€‚</p><p>å¦‚æœè¿™éƒ¨åˆ†å­˜é‡ä»£ç å‡ºç°è¾ƒå¤§çš„æ–°éœ€æ±‚ï¼Œæˆ–è€…ç»´æŠ¤å·²ç»æˆä¸ºé—®é¢˜ï¼Œéœ€è¦å¤§è§„æ¨¡é‡æ„ï¼Œè¿™æ­£æ˜¯æ¨åŠ¨è¡¥å…¨å•æµ‹çš„å¥½æ—¶æœºã€‚ä¸ºå­˜é‡ä»£ç è¡¥å……ä¸Šå•æµ‹ï¼Œä¸€æ–¹é¢èƒ½å¤Ÿæ¨è¿›é‡æ„è€…è¿›ä¸€æ­¥ç†è§£åŸå…ˆçš„é€»è¾‘ï¼Œå¦ä¸€æ–¹é¢ä¹Ÿèƒ½å¤Ÿå¢å¼ºé‡æ„è€…é‡æ„ä»£ç åçš„ä¿¡å¿ƒï¼Œé™ä½é£é™©ã€‚</p><p>ä½†æ˜¯ï¼Œè¡¥å……å­˜é‡å•æµ‹å¯èƒ½éœ€è¦å†æ¬¡å›å¿†ç†è§£éœ€æ±‚å’Œé€»è¾‘è®¾è®¡ç­‰ç»†èŠ‚ï¼Œè€Œæœ‰æ—¶å†™å•æµ‹çš„äººå¹¶ä¸æ˜¯åŸç¼–ç çš„è®¾è®¡è€…ï¼Œæ‰€ä»¥ç¼–ç åç¼–å†™å’Œæ‰§è¡Œå•å…ƒæµ‹è¯•ç”¨ä¾‹ä¹Ÿæœ‰ä¸€å®šçš„ä¸è¶³ã€‚</p><h2>æµ‹è¯•è¦†ç›–ç‡</h2><p>æˆ‘ä»¬å†™å•å…ƒæµ‹è¯•çš„æ—¶å€™åº”è¯¥æƒ³å¾—å¾ˆå…¨é¢ï¼Œèƒ½å¤Ÿè¦†ç›–åˆ°æ‰€æœ‰çš„æµ‹è¯•ç”¨ä¾‹ï¼Œä½†æœ‰æ—¶ä¹Ÿä¼šæ¼è¿‡ä¸€äº› caseï¼ŒGoæä¾›äº†coverå·¥å…·æ¥ç»Ÿè®¡æµ‹è¯•è¦†ç›–ç‡ã€‚å…·ä½“å¯ä»¥åˆ†ä¸ºä¸¤å¤§æ­¥éª¤ã€‚</p><p>ç¬¬ä¸€æ­¥ï¼Œç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æ•°æ®ï¼š</p><pre><code class=\"language-bash\">$ go test -coverprofile=coverage.out\ndo some setup\nPASS\ncoverage: 40.0% of statements\ndo some cleanup\nok  \tgithub.com/marmotedu/gopractise-demo/test\t0.003s\n</code></pre><p>ä¸Šé¢çš„å‘½ä»¤åœ¨å½“å‰ç›®å½•ä¸‹ç”Ÿæˆäº†<code>coverage.out</code>è¦†ç›–ç‡æ•°æ®æ–‡ä»¶ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/3c/01/3c11a0d41d6ed736f364c1693a2eff01.png?wh=1920x366\" alt=\"å›¾ç‰‡\"></p><p>ç¬¬äºŒæ­¥ï¼Œåˆ†æè¦†ç›–ç‡æ–‡ä»¶ï¼š</p><pre><code class=\"language-bash\">$ go tool cover -func=coverage.out\ndo some setup\nPASS\ncoverage: 40.0% of statements\ndo some cleanup\nok  \tgithub.com/marmotedu/gopractise-demo/test\t0.003s\n[colin@dev test]$ go tool cover -func=coverage.out\ngithub.com/marmotedu/gopractise-demo/test/math.go:9:\tAbs\t\t100.0%\ngithub.com/marmotedu/gopractise-demo/test/math.go:14:\tMax\t\t100.0%\ngithub.com/marmotedu/gopractise-demo/test/math.go:19:\tMin\t\t0.0%\ngithub.com/marmotedu/gopractise-demo/test/math.go:24:\tRandInt\t\t0.0%\ngithub.com/marmotedu/gopractise-demo/test/math.go:29:\tFloor\t\t0.0%\ntotal:\t\t\t\t\t\t\t(statements)\t40.0%\n</code></pre><p>åœ¨ä¸Šè¿°å‘½ä»¤çš„è¾“å‡ºä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥çœ‹åˆ°å“ªäº›å‡½æ•°æ²¡æœ‰æµ‹è¯•ï¼Œå“ªäº›å‡½æ•°å†…éƒ¨çš„åˆ†æ”¯æ²¡æœ‰æµ‹è¯•å®Œå…¨ã€‚coverå·¥å…·ä¼šæ ¹æ®è¢«æ‰§è¡Œä»£ç çš„è¡Œæ•°ä¸æ€»è¡Œæ•°çš„æ¯”ä¾‹è®¡ç®—å‡ºè¦†ç›–ç‡ã€‚å¯ä»¥çœ‹åˆ°ï¼ŒAbså’ŒMaxå‡½æ•°çš„æµ‹è¯•è¦†ç›–ç‡ä¸º100%ï¼ŒMinå’ŒRandIntçš„æµ‹è¯•è¦†ç›–ç‡ä¸º0ã€‚</p><p>æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨<code>go tool cover -html</code>ç”Ÿæˆ<code>HTML</code>æ ¼å¼çš„åˆ†ææ–‡ä»¶ï¼Œå¯ä»¥æ›´åŠ æ¸…æ™°åœ°å±•ç¤ºä»£ç çš„æµ‹è¯•æƒ…å†µï¼š</p><pre><code class=\"language-bash\">$ go tool cover -html=coverage.out -o coverage.html\n</code></pre><p>ä¸Šè¿°å‘½ä»¤ä¼šåœ¨å½“å‰ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ª<code>coverage.html</code>æ–‡ä»¶ï¼Œç”¨æµè§ˆå™¨æ‰“å¼€<code>coverage.html</code>æ–‡ä»¶ï¼Œå¯ä»¥æ›´åŠ æ¸…æ™°åœ°çœ‹åˆ°ä»£ç çš„æµ‹è¯•æƒ…å†µï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/f0/5e/f089f5d44ba06f052c1c46c858c2b75e.png?wh=1524x1075\" alt=\"\"></p><p>é€šè¿‡ä¸Šå›¾ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“çº¢è‰²éƒ¨åˆ†çš„ä»£ç æ²¡æœ‰è¢«æµ‹è¯•åˆ°ï¼Œå¯ä»¥è®©æˆ‘ä»¬æ¥ä¸‹æ¥æœ‰é’ˆå¯¹æ€§åœ°æ·»åŠ æµ‹è¯•ç”¨ä¾‹ï¼Œè€Œä¸æ˜¯ä¸€å¤´é›¾æ°´ï¼Œä¸çŸ¥é“éœ€è¦ä¸ºå“ªäº›ä»£ç ç¼–å†™æµ‹è¯•ç”¨ä¾‹ã€‚</p><p>åœ¨Goé¡¹ç›®å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¾€å¾€ä¼šæŠŠæµ‹è¯•è¦†ç›–ç‡ä½œä¸ºä»£ç åˆå¹¶çš„ä¸€ä¸ªå¼ºåˆ¶è¦æ±‚ï¼Œæ‰€ä»¥éœ€è¦åœ¨è¿›è¡Œä»£ç æµ‹è¯•æ—¶ï¼ŒåŒæ—¶ç”Ÿæˆä»£ç è¦†ç›–ç‡æ•°æ®æ–‡ä»¶ã€‚åœ¨è¿›è¡Œä»£ç æµ‹è¯•æ—¶ï¼Œå¯ä»¥é€šè¿‡åˆ†æè¯¥æ–‡ä»¶ï¼Œæ¥åˆ¤æ–­æˆ‘ä»¬çš„ä»£ç æµ‹è¯•è¦†ç›–ç‡æ˜¯å¦æ»¡è¶³è¦æ±‚ï¼Œå¦‚æœä¸æ»¡è¶³åˆ™ä»£ç æµ‹è¯•å¤±è´¥ã€‚</p><h2>IAMé¡¹ç›®æµ‹è¯•å®æˆ˜</h2><p>æ¥ä¸‹æ¥ï¼Œæˆ‘æ¥ä»‹ç»ä¸‹IAMé¡¹ç›®æ˜¯å¦‚ä½•ç¼–å†™å’Œè¿è¡Œæµ‹è¯•ç”¨ä¾‹çš„ï¼Œä½ å¯ä»¥é€šè¿‡IAMé¡¹ç›®çš„æµ‹è¯•ç”¨ä¾‹ï¼ŒåŠ æ·±å¯¹ä¸Šé¢å†…å®¹çš„ç†è§£ã€‚</p><h3>IAMé¡¹ç›®æ˜¯å¦‚ä½•è¿è¡Œæµ‹è¯•ç”¨ä¾‹çš„ï¼Ÿ</h3><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹IAMé¡¹ç›®æ˜¯å¦‚ä½•æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹çš„ã€‚</p><p>åœ¨IAMé¡¹ç›®çš„æºç æ ¹ç›®å½•ä¸‹ï¼Œå¯ä»¥é€šè¿‡è¿è¡Œ<code>make test</code>æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹ï¼Œ<code>make test</code>ä¼šæ‰§è¡Œ<code>iam/scripts/make-rules/golang.mk</code>æ–‡ä»¶ä¸­çš„<code>go.test</code>ä¼ªç›®æ ‡ï¼Œè§„åˆ™å¦‚ä¸‹ï¼š</p><pre><code class=\"language-makefile\">.PHONY: go.test\ngo.test: tools.verify.go-junit-report\n  @echo \"===========&gt; Run unit test\"\n  @set -o pipefail;$(GO) test -race -cover -coverprofile=$(OUTPUT_DIR)/coverage.out \\\\\n    -timeout=10m -short -v `go list ./...|\\\n    egrep -v $(subst $(SPACE),'|',$(sort $(EXCLUDE_TESTS)))` 2&gt;&amp;1 | \\\\\n    tee &gt;(go-junit-report --set-exit-code &gt;$(OUTPUT_DIR)/report.xml)\n  @sed -i '/mock_.*.go/d' $(OUTPUT_DIR)/coverage.out # remove mock_.*.go files from test coverage\n  @$(GO) tool cover -html=$(OUTPUT_DIR)/coverage.out -o $(OUTPUT_DIR)/coverage.html\n</code></pre><p>åœ¨ä¸Šè¿°è§„åˆ™ä¸­ï¼Œæˆ‘ä»¬æ‰§è¡Œ<code>go test</code>æ—¶è®¾ç½®äº†è¶…æ—¶æ—¶é—´ã€ç«æ€æ£€æŸ¥ï¼Œå¼€å¯äº†ä»£ç è¦†ç›–ç‡æ£€æŸ¥ï¼Œè¦†ç›–ç‡æµ‹è¯•æ•°æ®ä¿å­˜åœ¨äº†<code>coverage.out</code>æ–‡ä»¶ä¸­ã€‚åœ¨Goé¡¹ç›®å¼€å‘ä¸­ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„åŒ…éƒ½éœ€è¦å•å…ƒæµ‹è¯•ï¼Œæ‰€ä»¥ä¸Šé¢çš„å‘½ä»¤è¿˜è¿‡æ»¤æ‰äº†ä¸€äº›ä¸éœ€è¦æµ‹è¯•çš„åŒ…ï¼Œè¿™äº›åŒ…é…ç½®åœ¨<code>EXCLUDE_TESTS</code>å˜é‡ä¸­ï¼š</p><pre><code class=\"language-makefile\">EXCLUDE_TESTS=github.com/marmotedu/iam/test github.com/marmotedu/iam/pkg/log github.com/marmotedu/iam/third_party github.com/marmotedu/iam/internal/pump/storage github.com/marmotedu/iam/internal/pump github.com/marmotedu/iam/internal/pkg/logger\n</code></pre><p>åŒæ—¶ï¼Œä¹Ÿè°ƒç”¨äº†<code>go-junit-report</code>å°†go testçš„ç»“æœè½¬åŒ–æˆäº†xmlæ ¼å¼çš„æŠ¥å‘Šæ–‡ä»¶ï¼Œè¯¥æŠ¥å‘Šæ–‡ä»¶ä¼šè¢«ä¸€äº›CIç³»ç»Ÿï¼Œä¾‹å¦‚Jenkinsæ‹¿æ¥è§£æå¹¶å±•ç¤ºç»“æœã€‚ä¸Šè¿°ä»£ç ä¹ŸåŒæ—¶ç”Ÿæˆäº†coverage.htmlæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å¯ä»¥å­˜æ”¾åœ¨åˆ¶å“åº“ä¸­ï¼Œä¾›æˆ‘ä»¬åæœŸåˆ†ææŸ¥çœ‹ã€‚</p><p>è¿™é‡Œéœ€è¦æ³¨æ„ï¼ŒMockçš„ä»£ç æ˜¯ä¸éœ€è¦ç¼–å†™æµ‹è¯•ç”¨ä¾‹çš„ï¼Œä¸ºäº†é¿å…å½±å“é¡¹ç›®çš„å•å…ƒæµ‹è¯•è¦†ç›–ç‡ï¼Œéœ€è¦å°†Mockä»£ç çš„å•å…ƒæµ‹è¯•è¦†ç›–ç‡æ•°æ®ä»<code>coverage.out</code>æ–‡ä»¶ä¸­åˆ é™¤æ‰ï¼Œ<code>go.test</code>è§„åˆ™é€šè¿‡ä»¥ä¸‹å‘½ä»¤åˆ é™¤è¿™äº›æ— ç”¨çš„æ•°æ®ï¼š</p><pre><code class=\"language-bash\">sed -i '/mock_.*.go/d' $(OUTPUT_DIR)/coverage.out # remove mock_.*.go files from test coverage\n</code></pre><p>å¦å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡<code>make cover</code>æ¥è¿›è¡Œå•å…ƒæµ‹è¯•è¦†ç›–ç‡æµ‹è¯•ï¼Œ<code>make cover</code>ä¼šæ‰§è¡Œ<code>iam/scripts/make-rules/golang.mk</code>æ–‡ä»¶ä¸­çš„<code>go.test.cover</code>ä¼ªç›®æ ‡ï¼Œè§„åˆ™å¦‚ä¸‹ï¼š</p><pre><code class=\"language-makefile\">.PHONY: go.test.cover\ngo.test.cover: go.test\n  @$(GO) tool cover -func=$(OUTPUT_DIR)/coverage.out | \\\\\n    awk -v target=$(COVERAGE) -f $(ROOT_DIR)/scripts/coverage.awk\n</code></pre><p>ä¸Šè¿°ç›®æ ‡ä¾èµ–<code>go.test</code>ï¼Œä¹Ÿå°±æ˜¯è¯´æ‰§è¡Œå•å…ƒæµ‹è¯•è¦†ç›–ç‡ç›®æ ‡ä¹‹å‰ï¼Œä¼šå…ˆè¿›è¡Œå•å…ƒæµ‹è¯•ï¼Œç„¶åä½¿ç”¨å•å…ƒæµ‹è¯•äº§ç”Ÿçš„è¦†ç›–ç‡æ•°æ®<code>coverage.out</code>è®¡ç®—å‡ºæ€»çš„å•å…ƒæµ‹è¯•è¦†ç›–ç‡ï¼Œè¿™é‡Œæ˜¯é€šè¿‡<a href=\"https://github.com/marmotedu/iam/blob/v1.0.8/scripts/coverage.awk\">coverage.awk</a>è„šæœ¬æ¥è®¡ç®—çš„ã€‚</p><p>å¦‚æœå•å…ƒæµ‹è¯•è¦†ç›–ç‡ä¸è¾¾æ ‡ï¼ŒMakefileä¼šæŠ¥é”™å¹¶é€€å‡ºã€‚å¯ä»¥é€šè¿‡Makefileçš„<a href=\"https://github.com/marmotedu/iam/blob/master/scripts/make-rules/common.mk#L39-L41\">COVERAGE</a>å˜é‡æ¥è®¾ç½®å•å…ƒæµ‹è¯•è¦†ç›–ç‡é˜ˆå€¼ã€‚</p><p>COVERAGEçš„é»˜è®¤å€¼ä¸º60ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨å‘½ä»¤è¡Œæ‰‹åŠ¨æŒ‡å®šï¼Œä¾‹å¦‚ï¼š</p><pre><code class=\"language-bash\">$ make cover COVERAGE=80\n</code></pre><p>ä¸ºäº†ç¡®ä¿é¡¹ç›®çš„å•å…ƒæµ‹è¯•è¦†ç›–ç‡è¾¾æ ‡ï¼Œéœ€è¦è®¾ç½®å•å…ƒæµ‹è¯•è¦†ç›–ç‡è´¨é‡çº¢çº¿ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè¿™äº›çº¢çº¿å¾ˆéš¾é å¼€å‘è€…çš„è‡ªè§‰æ€§å»ä¿éšœï¼Œæ‰€ä»¥å¥½çš„æ–¹æ³•æ˜¯å°†è´¨é‡çº¢çº¿åŠ å…¥åˆ°CICDæµç¨‹ä¸­ã€‚</p><p>æ‰€ä»¥ï¼Œåœ¨<code>Makefile</code>æ–‡ä»¶ä¸­ï¼Œæˆ‘å°†<code>cover</code>æ”¾åœ¨<code>all</code>ç›®æ ‡çš„ä¾èµ–ä¸­ï¼Œå¹¶ä¸”ä½äºbuildä¹‹å‰ï¼Œä¹Ÿå°±æ˜¯<code>all: gen add-copyright format lint cover build</code>ã€‚è¿™æ ·æ¯æ¬¡å½“æˆ‘ä»¬æ‰§è¡Œmakeæ—¶ï¼Œä¼šè‡ªåŠ¨è¿›è¡Œä»£ç æµ‹è¯•ï¼Œå¹¶è®¡ç®—å•å…ƒæµ‹è¯•è¦†ç›–ç‡ï¼Œå¦‚æœè¦†ç›–ç‡ä¸è¾¾æ ‡ï¼Œåˆ™åœæ­¢æ„å»ºï¼›å¦‚æœè¾¾æ ‡ï¼Œç»§ç»­è¿›å…¥ä¸‹ä¸€æ­¥çš„æ„å»ºæµç¨‹ã€‚</p><h3>IAMé¡¹ç›®æµ‹è¯•æ¡ˆä¾‹åˆ†äº«</h3><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä¼šç»™ä½ å±•ç¤ºä¸€äº›IAMé¡¹ç›®çš„æµ‹è¯•æ¡ˆä¾‹ï¼Œå› ä¸ºè¿™äº›æµ‹è¯•æ¡ˆä¾‹çš„å®ç°æ–¹æ³•ï¼Œæˆ‘åœ¨<a href=\"https://time.geekbang.org/column/article/408529\">36è®²</a> å’Œè¿™ä¸€è®²çš„å‰åŠéƒ¨åˆ†å·²æœ‰è¯¦ç»†ä»‹ç»ï¼Œæ‰€ä»¥è¿™é‡Œï¼Œæˆ‘åªåˆ—å‡ºå…·ä½“çš„å®ç°ä»£ç ï¼Œä¸ä¼šå†ä»‹ç»è¿™äº›ä»£ç çš„å®ç°æ–¹æ³•ã€‚</p><ol>\n<li>å•å…ƒæµ‹è¯•æ¡ˆä¾‹</li>\n</ol><p>æˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨ç¼–å†™å•å…ƒæµ‹è¯•ä»£ç ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨gotestså·¥å…·ç”Ÿæˆå•å…ƒæµ‹è¯•ä»£ç ã€‚</p><p>å…ˆæ¥çœ‹æ‰‹åŠ¨ç¼–å†™æµ‹è¯•ä»£ç çš„æ¡ˆä¾‹ã€‚è¿™é‡Œå•å…ƒæµ‹è¯•ä»£ç è§<a href=\"https://github.com/marmotedu/iam/blob/v1.0.8/pkg/log/log_test.go#L52-L62\">Test_Option</a>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre><code class=\"language-go\">func Test_Option(t *testing.T) {\n    fs := pflag.NewFlagSet(\"test\", pflag.ExitOnError)\n    opt := log.NewOptions()\n    opt.AddFlags(fs)\n\n    args := []string{\"--log.level=debug\"}\n    err := fs.Parse(args)\n    assert.Nil(t, err)\n\n    assert.Equal(t, \"debug\", opt.Level)\n}\n</code></pre><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œä½¿ç”¨äº†<code>github.com/stretchr/testify/assert</code>åŒ…æ¥å¯¹æ¯”ç»“æœã€‚</p><p>å†æ¥çœ‹ä½¿ç”¨gotestså·¥å…·ç”Ÿæˆå•å…ƒæµ‹è¯•ä»£ç çš„æ¡ˆä¾‹ï¼ˆTable-Driven çš„æµ‹è¯•æ¨¡å¼ï¼‰ã€‚å‡ºäºæ•ˆç‡ä¸Šçš„è€ƒè™‘ï¼ŒIAMé¡¹ç›®çš„å•å…ƒæµ‹è¯•ç”¨ä¾‹ï¼ŒåŸºæœ¬éƒ½æ˜¯ä½¿ç”¨gotestså·¥å…·ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹æ¨¡æ¿ä»£ç ï¼Œå¹¶åŸºäºè¿™äº›æ¨¡æ¿ä»£ç å¡«å……æµ‹è¯•Caseçš„ã€‚ä»£ç è§<a href=\"https://github.com/marmotedu/iam/blob/v1.0.8/internal/apiserver/service/v1/service_test.go\">service_test.go</a>æ–‡ä»¶ã€‚</p><ol start=\"2\">\n<li>æ€§èƒ½æµ‹è¯•æ¡ˆä¾‹</li>\n</ol><p>IAMé¡¹ç›®çš„æ€§èƒ½æµ‹è¯•ç”¨ä¾‹ï¼Œè§<a href=\"https://github.com/marmotedu/iam/blob/v1.0.8/internal/apiserver/service/v1/user_test.go#L27-L41\">BenchmarkListUser</a>æµ‹è¯•å‡½æ•°ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><pre><code class=\"language-go\">func BenchmarkListUser(b *testing.B) {\n\topts := metav1.ListOptions{\n\t\tOffset: pointer.ToInt64(0),\n\t\tLimit:  pointer.ToInt64(50),\n\t}\n\tstoreIns, _ := fake.GetFakeFactoryOr()\n\tu := &amp;userService{\n\t\tstore: storeIns,\n\t}\n\n\tfor i := 0; i &lt; b.N; i++ {\n\t\t_, _ = u.List(context.TODO(), opts)\n\t}\n}\n</code></pre><ol start=\"3\">\n<li>ç¤ºä¾‹æµ‹è¯•æ¡ˆä¾‹</li>\n</ol><p>IAMé¡¹ç›®çš„ç¤ºä¾‹æµ‹è¯•ç”¨ä¾‹è§<a href=\"https://github.com/marmotedu/errors/blob/v1.0.2/example_test.go\">example_test.go</a>æ–‡ä»¶ã€‚<code>example_test.go</code>ä¸­çš„ä¸€ä¸ªç¤ºä¾‹æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p><pre><code class=\"language-go\">func ExampleNew() {\n\terr := New(\"whoops\")\n\tfmt.Println(err)\n\n\t// Output: whoops\n}\n</code></pre><ol start=\"4\">\n<li>TestMainæµ‹è¯•æ¡ˆä¾‹</li>\n</ol><p>IAMé¡¹ç›®çš„TestMainæµ‹è¯•æ¡ˆä¾‹ï¼Œè§<a href=\"https://github.com/marmotedu/iam/blob/v1.0.8/internal/apiserver/service/v1/user_test.go\">user_test.go</a>æ–‡ä»¶ä¸­çš„<code>TestMain</code>å‡½æ•°ï¼š</p><pre><code class=\"language-go\">func TestMain(m *testing.M) {\n    _, _ = fake.GetFakeFactoryOr()\n    os.Exit(m.Run())\n}\n</code></pre><p><code>TestMain</code>å‡½æ•°åˆå§‹åŒ–äº†fake Factoryï¼Œç„¶åè°ƒç”¨<code>m.Run</code>æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹ã€‚</p><ol start=\"5\">\n<li>Mockæµ‹è¯•æ¡ˆä¾‹</li>\n</ol><p>Mockä»£ç è§<a href=\"https://github.com/marmotedu/iam/blob/v1.0.8/internal/apiserver/service/v1/mock_service.go\">internal/apiserver/service/v1/mock_service.go</a>ï¼Œä½¿ç”¨Mockçš„æµ‹è¯•ç”¨ä¾‹è§<a href=\"https://github.com/marmotedu/iam/blob/v1.0.8/internal/apiserver/controller/v1/user/create_test.go\">internal/apiserver/controller/v1/user/create_test.go</a>æ–‡ä»¶ã€‚å› ä¸ºä»£ç æ¯”è¾ƒå¤šï¼Œè¿™é‡Œå»ºè®®ä½ æ‰“å¼€é“¾æ¥ï¼ŒæŸ¥çœ‹æµ‹è¯•ç”¨ä¾‹çš„å…·ä½“å®ç°ã€‚</p><p>æˆ‘ä»¬å¯ä»¥åœ¨IAMé¡¹ç›®çš„æ ¹ç›®å½•ä¸‹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œæ¥è‡ªåŠ¨ç”Ÿæˆæ‰€æœ‰çš„Mockæ–‡ä»¶ï¼š</p><pre><code class=\"language-bash\">$ go generate ./...\n</code></pre><ol start=\"6\">\n<li>Fakeæµ‹è¯•æ¡ˆä¾‹</li>\n</ol><p>fake storeä»£ç å®ç°ä½äº<a href=\"https://github.com/marmotedu/iam/tree/v1.0.8/internal/apiserver/store/fake\">internal/apiserver/store/fake</a>ç›®å½•ä¸‹ã€‚fake storeçš„ä½¿ç”¨æ–¹å¼ï¼Œè§<a href=\"https://github.com/marmotedu/iam/blob/v1.0.8/internal/apiserver/service/v1/user_test.go\">user_test.go</a>æ–‡ä»¶ï¼š</p><pre><code class=\"language-go\">func TestMain(m *testing.M) {\n    _, _ = fake.GetFakeFactoryOr()\n    os.Exit(m.Run())\n}\n\nfunc BenchmarkListUser(b *testing.B) {\n    opts := metav1.ListOptions{\n        Offset: pointer.ToInt64(0),\n        Limit:  pointer.ToInt64(50),\n    }\n    storeIns, _ := fake.GetFakeFactoryOr()\n    u := &amp;userService{\n        store: storeIns,\n    }\n\n    for i := 0; i &lt; b.N; i++ {\n        _, _ = u.List(context.TODO(), opts)\n    }\n}\n</code></pre><p>ä¸Šè¿°ä»£ç é€šè¿‡<code>TestMain</code>åˆå§‹åŒ–fakeå®ä¾‹ï¼ˆ<a href=\"https://github.com/marmotedu/iam/blob/v1.0.8/internal/apiserver/store/store.go#L12-L17\">store.Factory</a>æ¥å£ç±»å‹ï¼‰ï¼š</p><pre><code class=\"language-go\">func GetFakeFactoryOr() (store.Factory, error) {\n    once.Do(func() {\n        fakeFactory = &amp;datastore{\n            users:    FakeUsers(ResourceCount),\n            secrets:  FakeSecrets(ResourceCount),\n            policies: FakePolicies(ResourceCount),\n        }\n    })\n\n    if fakeFactory == nil {\n        return nil, fmt.Errorf(\"failed to get mysql store fatory, mysqlFactory: %+v\", fakeFactory)\n    }\n\n    return fakeFactory, nil\n}\n</code></pre><p><code>GetFakeFactoryOr</code>å‡½æ•°ï¼Œåˆ›å»ºäº†ä¸€äº›fake usersã€secretsã€policiesï¼Œå¹¶ä¿å­˜åœ¨äº†<code>fakeFactory</code>å˜é‡ä¸­ï¼Œä¾›åé¢çš„æµ‹è¯•ç”¨ä¾‹ä½¿ç”¨ï¼Œä¾‹å¦‚BenchmarkListUserã€Test_newUsersç­‰ã€‚</p><h2>å…¶ä»–æµ‹è¯•å·¥å…·/åŒ…</h2><p>æœ€åï¼Œæˆ‘å†æ¥åˆ†äº«ä¸‹Goé¡¹ç›®æµ‹è¯•ä¸­å¸¸ç”¨çš„å·¥å…·/åŒ…ï¼Œå› ä¸ºå†…å®¹è¾ƒå¤šï¼Œæˆ‘å°±ä¸è¯¦ç»†ä»‹ç»äº†ï¼Œå¦‚æœæ„Ÿå…´è¶£ä½ å¯ä»¥ç‚¹è¿›é“¾æ¥è‡ªè¡Œå­¦ä¹ ã€‚æˆ‘å°†è¿™äº›æµ‹è¯•å·¥å…·/åŒ…åˆ†ä¸ºäº†ä¸¤ç±»ï¼Œåˆ†åˆ«æ˜¯æµ‹è¯•æ¡†æ¶å’ŒMockå·¥å…·ã€‚</p><h3>æµ‹è¯•æ¡†æ¶</h3><ul>\n<li><a href=\"https://github.com/stretchr/testify\">Testifyæ¡†æ¶</a>ï¼šTestifyæ˜¯Go testçš„é¢„åˆ¤å·¥å…·ï¼Œå®ƒèƒ½è®©ä½ çš„æµ‹è¯•ä»£ç å˜å¾—æ›´ä¼˜é›…å’Œé«˜æ•ˆï¼Œæµ‹è¯•ç»“æœä¹Ÿå˜å¾—æ›´è¯¦ç»†ã€‚</li>\n<li><a href=\"https://github.com/smartystreets/goconvey\">GoConveyæ¡†æ¶</a>ï¼šGoConveyæ˜¯ä¸€æ¬¾é’ˆå¯¹Golangçš„æµ‹è¯•æ¡†æ¶ï¼Œå¯ä»¥ç®¡ç†å’Œè¿è¡Œæµ‹è¯•ç”¨ä¾‹ï¼ŒåŒæ—¶æä¾›äº†ä¸°å¯Œçš„æ–­è¨€å‡½æ•°ï¼Œå¹¶æ”¯æŒå¾ˆå¤š Web ç•Œé¢ç‰¹æ€§ã€‚</li>\n</ul><h3>Mockå·¥å…·</h3><p>è¿™ä¸€è®²é‡Œï¼Œæˆ‘ä»‹ç»äº†Goå®˜æ–¹æä¾›çš„Mockæ¡†æ¶GoMockï¼Œä¸è¿‡è¿˜æœ‰ä¸€äº›å…¶ä»–çš„ä¼˜ç§€Mockå·¥å…·å¯ä¾›æˆ‘ä»¬ä½¿ç”¨ã€‚è¿™äº›Mockå·¥å…·åˆ†åˆ«ç”¨åœ¨ä¸åŒçš„Mockåœºæ™¯ä¸­ï¼Œæˆ‘åœ¨ <a href=\"https://time.geekbang.org/column/article/384648\">10è®²</a>ä¸­å·²ç»ä»‹ç»è¿‡ã€‚ä¸è¿‡ï¼Œä¸ºäº†ä½¿æˆ‘ä»¬è¿™ä¸€è®²çš„æµ‹è¯•çŸ¥è¯†ä½“ç³»æ›´åŠ å®Œæ•´ï¼Œè¿™é‡Œæˆ‘è¿˜æ˜¯å†æä¸€æ¬¡ï¼Œä½ å¯ä»¥å¤ä¹ ä¸€éã€‚</p><ul>\n<li><a href=\"https://github.com/DATA-DOG/go-sqlmock\">sqlmock</a>ï¼šå¯ä»¥ç”¨æ¥æ¨¡æ‹Ÿæ•°æ®åº“è¿æ¥ã€‚æ•°æ®åº“æ˜¯é¡¹ç›®ä¸­æ¯”è¾ƒå¸¸è§çš„ä¾èµ–ï¼Œåœ¨é‡åˆ°æ•°æ®åº“ä¾èµ–æ—¶éƒ½å¯ä»¥ç”¨å®ƒã€‚</li>\n<li><a href=\"https://github.com/jarcoal/httpmock\">httpmock</a>ï¼šå¯ä»¥ç”¨æ¥Mock HTTPè¯·æ±‚ã€‚</li>\n<li><a href=\"https://github.com/bouk/monkey\">bouk/monkey</a>ï¼šçŒ´å­è¡¥ä¸ï¼Œèƒ½å¤Ÿé€šè¿‡æ›¿æ¢å‡½æ•°æŒ‡é’ˆçš„æ–¹å¼æ¥ä¿®æ”¹ä»»æ„å‡½æ•°çš„å®ç°ã€‚å¦‚æœgolang/mockã€sqlmockå’Œhttpmockè¿™å‡ ç§æ–¹æ³•éƒ½ä¸èƒ½æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•ç”¨çŒ´å­è¡¥ä¸çš„æ–¹å¼æ¥Mockä¾èµ–ã€‚å¯ä»¥è¿™ä¹ˆè¯´ï¼ŒçŒ´å­è¡¥ä¸æä¾›äº†å•å…ƒæµ‹è¯• Mock ä¾èµ–çš„æœ€ç»ˆè§£å†³æ–¹æ¡ˆã€‚</li>\n</ul><h2>æ€»ç»“</h2><p>è¿™ä¸€è®²ï¼Œæˆ‘ä»‹ç»äº†é™¤å•å…ƒæµ‹è¯•å’Œæ€§èƒ½æµ‹è¯•ä¹‹å¤–çš„å¦ä¸€äº›æµ‹è¯•æ–¹æ³•ã€‚</p><p>é™¤äº†ç¤ºä¾‹æµ‹è¯•å’ŒTestMainå‡½æ•°ï¼Œæˆ‘è¿˜è¯¦ç»†ä»‹ç»äº†Mockæµ‹è¯•ï¼Œä¹Ÿå°±æ˜¯å¦‚ä½•ä½¿ç”¨GoMockæ¥æµ‹è¯•ä¸€äº›åœ¨å•å…ƒæµ‹è¯•ç¯å¢ƒä¸‹ä¸å¥½å®ç°çš„æ¥å£ã€‚ç»å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨GoMockæ¥Mockæ¥å£ï¼Œä½†æ˜¯å¯¹äºä¸€äº›ä¸šåŠ¡é€»è¾‘æ¯”è¾ƒå¤æ‚çš„æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡Fakeä¸€ä¸ªæ¥å£å®ç°ï¼Œæ¥å¯¹ä»£ç è¿›è¡Œæµ‹è¯•ï¼Œè¿™ä¹Ÿç§°ä¸ºFakeæµ‹è¯•ã€‚</p><p>æ­¤å¤–ï¼Œæˆ‘è¿˜ä»‹ç»äº†ä½•æ—¶ç¼–å†™å’Œæ‰§è¡Œæµ‹è¯•ç”¨ä¾‹ã€‚æˆ‘ä»¬å¯ä»¥æ ¹æ®éœ€è¦ï¼Œé€‰æ‹©åœ¨ç¼–å†™ä»£ç å‰ã€ç¼–å†™ä»£ç ä¸­ã€ç¼–å†™ä»£ç åç¼–å†™æµ‹è¯•ç”¨ä¾‹ã€‚</p><p>ä¸ºäº†ä¿è¯å•å…ƒæµ‹è¯•è¦†ç›–ç‡ï¼Œæˆ‘ä»¬è¿˜åº”è¯¥ä¸ºæ•´ä¸ªé¡¹ç›®è®¾ç½®å•å…ƒæµ‹è¯•è¦†ç›–ç‡è´¨é‡çº¢çº¿ï¼Œå¹¶å°†è¯¥è´¨é‡çº¢çº¿åŠ å…¥åˆ°CICDæµç¨‹ä¸­ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>go test -coverprofile=coverage.out</code> å‘½ä»¤æ¥ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æ•°æ®ï¼Œé€šè¿‡<code>go tool cover -func=coverage.out</code> å‘½ä»¤æ¥åˆ†æè¦†ç›–ç‡æ–‡ä»¶ã€‚</p><p>IAMé¡¹ç›®ä¸­ä½¿ç”¨äº†å¤§é‡çš„æµ‹è¯•æ–¹æ³•å’ŒæŠ€å·§æ¥æµ‹è¯•ä»£ç ï¼Œä¸ºäº†åŠ æ·±ä½ å¯¹æµ‹è¯•çŸ¥è¯†çš„ç†è§£ï¼Œæˆ‘ä¹Ÿåˆ—ä¸¾äº†ä¸€äº›æµ‹è¯•æ¡ˆä¾‹ï¼Œä¾›ä½ å‚è€ƒã€å­¦ä¹ å’ŒéªŒè¯ã€‚å…·ä½“çš„æµ‹è¯•æ¡ˆä¾‹ï¼Œä½ å¯ä»¥è¿”å›å‰é¢æŸ¥çœ‹ä¸‹ã€‚</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨å…¶ä»–ä¸€äº›æµ‹è¯•æ¡†æ¶ï¼Œä¾‹å¦‚Testifyæ¡†æ¶å’ŒGoConveyæ¡†æ¶ã€‚åœ¨Goä»£ç æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬æœ€å¸¸ä½¿ç”¨çš„æ˜¯Goå®˜æ–¹æä¾›çš„Mockæ¡†æ¶GoMockï¼Œä½†ä»ç„¶æœ‰å…¶ä»–ä¼˜ç§€çš„Mockå·¥å…·ï¼Œå¯ä¾›æˆ‘ä»¬åœ¨ä¸åŒåœºæ™¯ä¸‹ä½¿ç”¨ï¼Œä¾‹å¦‚sqlmockã€httpmockã€bouk/monkeyç­‰ã€‚</p><h2>è¯¾åä¹ é¢˜</h2><ol>\n<li>è¯·ä½¿ç”¨ <a href=\"https://github.com/DATA-DOG/go-sqlmock\">sqlmock</a> æ¥Mockä¸€ä¸ªGORMæ•°æ®åº“å®ä¾‹ï¼Œå¹¶å®ŒæˆGORMçš„CURDå•å…ƒæµ‹è¯•ç”¨ä¾‹ç¼–å†™ã€‚</li>\n<li>æ€è€ƒä¸‹ï¼Œåœ¨Goé¡¹ç›®å¼€å‘ä¸­ï¼Œè¿˜æœ‰å“ªäº›ä¼˜ç§€çš„æµ‹è¯•æ¡†æ¶ã€æµ‹è¯•å·¥å…·ã€Mockå·¥å…·ä»¥åŠæµ‹è¯•æŠ€å·§ï¼Ÿæ¬¢è¿ä½ åœ¨ç•™è¨€åŒºåˆ†äº«ã€‚</li>\n</ol><p>æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºä¸æˆ‘äº¤æµè®¨è®ºï¼Œæˆ‘ä»¬ä¸‹ä¸€è®²è§ã€‚</p>","neighbors":{"left":{"article_title":"36 | ä»£ç æµ‹è¯•ï¼ˆä¸Šï¼‰ï¼šå¦‚ä½•ç¼–å†™ Go è¯­è¨€å•å…ƒæµ‹è¯•å’Œæ€§èƒ½æµ‹è¯•ç”¨ä¾‹ï¼Ÿ","id":408529},"right":{"article_title":"38ï½œæ€§èƒ½åˆ†æï¼ˆä¸Šï¼‰ï¼šå¦‚ä½•åˆ†æ Go è¯­è¨€ä»£ç çš„æ€§èƒ½ï¼Ÿ","id":410205}},"comments":[{"had_liked":false,"id":344333,"user_name":"i-neojos","can_delete":false,"product_type":"c1","uid":1702997,"ip_address":"","ucode":"1808C25269948A","user_header":"https://static001.geekbang.org/account/avatar/00/19/fc/55/e03bb6db.jpg","comment_is_top":false,"comment_ctime":1651476910,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"14536378798","product_id":100079601,"comment_content":"è¿™ç¯‡æ–‡ç« å®ç”¨æ€§ç‰¹åˆ«å¼ºï¼Œå¯¹æµ‹è¯•å¹³å°å¾ˆæœ‰å‚è€ƒæ„ä¹‰","like_count":3},{"had_liked":false,"id":341393,"user_name":"ç®¡æ¸…éºŸ","can_delete":false,"product_type":"c1","uid":1198013,"ip_address":"","ucode":"7CA1651D0DE257","user_header":"https://static001.geekbang.org/account/avatar/00/12/47/bd/5c34df95.jpg","comment_is_top":false,"comment_ctime":1649577803,"is_pvip":false,"replies":[{"id":"125536","content":"æ˜¯  ç«æ€æ£€æŸ¥","user_name":"ä½œè€…å›å¤","comment_id":341393,"uid":"1167883","ip_address":"","utype":1,"ctime":1651079031,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"5944545099","product_id":100079601,"comment_content":"é™æ€æ£€æŸ¥å§ï¼Œä¸æ˜¯ç«æ€æ£€æŸ¥","like_count":1,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"å­”ä»¤é£","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":568227,"discussion_content":"æ˜¯  ç«æ€æ£€æŸ¥","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1651079031,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":353886,"user_name":"æ˜¯åœ¨ä¸‹è¾“äº†","can_delete":false,"product_type":"c1","uid":3068955,"ip_address":"å¹¿ä¸œ","ucode":"901D83EC269ACB","user_header":"https://static001.geekbang.org/account/avatar/00/2e/d4/1b/82a32d66.jpg","comment_is_top":false,"comment_ctime":1659886710,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1659886710","product_id":100079601,"comment_content":"åœ¨ç›®å½•ä¸‹æ‰§è¡Œgo test -coverprofile=coverage.out æ²¡æœ‰ç”Ÿæˆ coverage.out æ–‡ä»¶","like_count":0},{"had_liked":false,"id":353758,"user_name":"NULL","can_delete":false,"product_type":"c1","uid":1191550,"ip_address":"å±±ä¸œ","ucode":"2A323DD05352BC","user_header":"https://static001.geekbang.org/account/avatar/00/12/2e/7e/ebc28e10.jpg","comment_is_top":false,"comment_ctime":1659753213,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1659753213","product_id":100079601,"comment_content":"bouk&#47;monkeyè®¸å¯è¯å¥½åƒæœ‰é—®é¢˜<br><br>ä¹Ÿå¯ä»¥çœ‹çœ‹è¿™ä¸ª https:&#47;&#47;github.com&#47;agiledragon&#47;gomonkey<br><br>agiledragon&#47;gomonkeyè¢«bouk&#47;monkeyçš„ä½œè€…æ¨èè¿‡, è§https:&#47;&#47;esoteric.codes&#47;blog&#47;bouk-monkey-satirical-code-used-by-people-who-dont-get-the-joke","like_count":0},{"had_liked":false,"id":353716,"user_name":"NULL","can_delete":false,"product_type":"c1","uid":1191550,"ip_address":"å±±ä¸œ","ucode":"2A323DD05352BC","user_header":"https://static001.geekbang.org/account/avatar/00/12/2e/7e/ebc28e10.jpg","comment_is_top":false,"comment_ctime":1659691690,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1659691690","product_id":100079601,"comment_content":"go1.18åˆæ–°å¢äº†ä¸€ç§fuzzingæµ‹è¯•<br>https:&#47;&#47;go.dev&#47;doc&#47;fuzz&#47;","like_count":0},{"had_liked":false,"id":349955,"user_name":"å®™æ–¯","can_delete":false,"product_type":"c1","uid":2041396,"ip_address":"","ucode":"80DF36BAD298AD","user_header":"https://static001.geekbang.org/account/avatar/00/1f/26/34/891dd45b.jpg","comment_is_top":false,"comment_ctime":1656470559,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1656470559","product_id":100079601,"comment_content":"fakeæµ‹è¯•å’Œmockæµ‹è¯•æœ‰ä»€ä¹ˆåŒºåˆ«å—ï¼Ÿæ„Ÿè§‰æ˜¯ä¸€æ ·çš„ä¸œè¥¿ï¼Œæ²¡çœ‹å‡ºä¾§é‡ç‚¹","like_count":0},{"had_liked":false,"id":338460,"user_name":"ğŸ’A","can_delete":false,"product_type":"c1","uid":1075412,"ip_address":"","ucode":"914FFA92CA2713","user_header":"https://static001.geekbang.org/account/avatar/00/10/68/d4/c9b5d3f9.jpg","comment_is_top":false,"comment_ctime":1647508491,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1647508491","product_id":100079601,"comment_content":"è¶Šåˆ°åé¢äººè¶Šå°‘","like_count":0},{"had_liked":false,"id":329343,"user_name":"~\\(â‰§â–½â‰¦)&#47;~","can_delete":false,"product_type":"c1","uid":1001106,"ip_address":"","ucode":"2F4A77723F5E41","user_header":"","comment_is_top":false,"comment_ctime":1641293176,"is_pvip":false,"replies":[{"id":"120960","content":"å¯ä»¥ä½¿ç”¨httpmockè¿›è¡Œæµ‹è¯•ã€‚<br><br>ä½†ä¸€èˆ¬å»ºè®®é€šè¿‡æ¥å£è¿›è¡Œæµ‹è¯•","user_name":"ä½œè€…å›å¤","comment_id":329343,"uid":"1167883","ip_address":"","utype":1,"ctime":1642434991,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"1641293176","product_id":100079601,"comment_content":"è€å¸ˆï¼Œè°ƒç”¨ç¬¬ä¸‰æ–¹rest apiæ¥å£éœ€è¦ç”¨åˆ°mockè¿›è¡Œæµ‹è¯•å—","like_count":0,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"å­”ä»¤é£","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546863,"discussion_content":"å¯ä»¥ä½¿ç”¨httpmockè¿›è¡Œæµ‹è¯•ã€‚\n\nä½†ä¸€èˆ¬å»ºè®®é€šè¿‡æ¥å£è¿›è¡Œæµ‹è¯•","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642434991,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":328052,"user_name":"return","can_delete":false,"product_type":"c1","uid":1135528,"ip_address":"","ucode":"42B8A3380DF04B","user_header":"https://static001.geekbang.org/account/avatar/00/11/53/a8/abc96f70.jpg","comment_is_top":false,"comment_ctime":1640504126,"is_pvip":false,"replies":[{"id":"119707","content":"å·®ä¸å¤šå°±æ˜¯è¿™ä¹ˆæ¥æµ‹è¯•çš„","user_name":"ä½œè€…å›å¤","comment_id":328052,"uid":"1167883","ip_address":"","utype":1,"ctime":1640825746,"user_name_real":"ç¼–è¾‘"}],"discussion_count":2,"race_medal":0,"score":"1640504126","product_id":100079601,"comment_content":"è€å¸ˆï¼Œè¯·æ•™ä¸€ä¸‹ï¼Œä¸€èˆ¬å¯¹ rest api çš„æµ‹è¯• åº”è¯¥æ€ä¹ˆåšæ¯”è¾ƒå¥½ï¼Œ<br>æˆ‘ä»¬ç°åœ¨æ˜¯ æŒ‰ç…§å†™å•å…ƒæµ‹è¯•çš„æ–¹å¼ï¼Œ æµ‹è¯•å‡½æ•°å†… è°ƒç”¨httpè¯·æ±‚ï¼Œåˆ¤æ–­responseã€‚<br>ä¸çŸ¥é“æœ‰æ²¡æœ‰æ›´å¥½çš„æ–¹å¼ã€‚","like_count":0,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"å­”ä»¤é£","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":542652,"discussion_content":"å·®ä¸å¤šå°±æ˜¯è¿™ä¹ˆæ¥æµ‹è¯•çš„","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1640825746,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1135528,"avatar":"https://static001.geekbang.org/account/avatar/00/11/53/a8/abc96f70.jpg","nickname":"return","note":"","ucode":"42B8A3380DF04B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"å­”ä»¤é£","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":542659,"discussion_content":"å¥½çš„ï¼Œéå¸¸æ„Ÿè°¢è€å¸ˆè§£ç­”ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640826545,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":542652,"ip_address":""},"score":542659,"extra":""}]}]},{"had_liked":false,"id":326686,"user_name":"zero","can_delete":false,"product_type":"c1","uid":1684113,"ip_address":"","ucode":"27019747CA63FF","user_header":"https://static001.geekbang.org/account/avatar/00/19/b2/91/fbc34225.jpg","comment_is_top":false,"comment_ctime":1639630854,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1639630854","product_id":100079601,"comment_content":"æ”¶è·æ»¡æ»¡","like_count":0},{"had_liked":false,"id":324766,"user_name":"yandongxiao","can_delete":false,"product_type":"c1","uid":1017700,"ip_address":"","ucode":"D397F4DB0109C8","user_header":"https://static001.geekbang.org/account/avatar/00/0f/87/64/3882d90d.jpg","comment_is_top":false,"comment_ctime":1638609162,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1638609162","product_id":100079601,"comment_content":"æ€»ç»“ï¼š<br>1. ä»‹ç»äº†Exampleã€Mockã€Fake æµ‹è¯•è§„èŒƒï¼Œä»¥åŠå¸¸è§çš„æ¡†æ¶ã€‚<br>2. é‡ç‚¹ä»‹ç»äº† gomock package çš„ä½¿ç”¨æ–¹æ³•ã€‚åŒ…æ‹¬è¿è¡Œ mockgen çš„ä¸¤ç§æ–¹å¼ï¼šsource mode &amp; reflect modeï¼›å¦‚ä½•å¯¹è¾“å…¥å’Œè¾“å‡ºå‚æ•°çš„çº¦æŸã€‚<br>3. å¯¹äºå¤æ‚çš„ interfaceï¼Œä½ ä¹Ÿå¯ä»¥é‡‡ç”¨è‡ªå·±å®ç°fakeæµ‹è¯•ã€‚<br>4. iam æä¾›äº† make test å’Œ make cover ä¸¤ä¸ªå‘½ä»¤ã€‚","like_count":0},{"had_liked":false,"id":313639,"user_name":"Daiver","can_delete":false,"product_type":"c1","uid":1466447,"ip_address":"","ucode":"9B1A03AFBC79BC","user_header":"https://static001.geekbang.org/account/avatar/00/16/60/4f/db0e62b3.jpg","comment_is_top":false,"comment_ctime":1632577482,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1632577482","product_id":100079601,"comment_content":"å…¶å®å¯ä»¥æŠŠè‡ªåŠ¨ç”Ÿæˆmockå’Œ test æ”¾makefileä¸­ç®¡ç†","like_count":0},{"had_liked":false,"id":312150,"user_name":"å€ªæ˜Š","can_delete":false,"product_type":"c1","uid":1236631,"ip_address":"","ucode":"790CB649341D37","user_header":"https://static001.geekbang.org/account/avatar/00/12/de/97/cda3f551.jpg","comment_is_top":false,"comment_ctime":1631667215,"is_pvip":true,"replies":[{"id":"113682","content":"éƒ½å¯ä»¥åšçš„ï¼Œä½†ä¸šåŠ¡å±‚ä¼šæ¯”è¾ƒå¤šäº›","user_name":"ä½œè€…å›å¤","comment_id":312150,"uid":"1167883","ip_address":"","utype":1,"ctime":1632759601,"user_name_real":"CK1.0"}],"discussion_count":1,"race_medal":0,"score":"1631667215","product_id":100079601,"comment_content":"è€å¸ˆè¯·é—®å•å…ƒæµ‹è¯•ä¸€èˆ¬å¯¹å“ªå‡ éƒ¨åˆ†ä»£ç åšå‘¢ï¼Ÿæ§åˆ¶å±‚ï¼Œserviceå±‚ï¼Œä»“åº“å±‚éƒ½è¦åšå—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"å­”ä»¤é£","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":526880,"discussion_content":"éƒ½å¯ä»¥åšçš„ï¼Œä½†ä¸šåŠ¡å±‚ä¼šæ¯”è¾ƒå¤šäº›","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632759601,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":311229,"user_name":"éšé£è€Œè¿‡","can_delete":false,"product_type":"c1","uid":2654999,"ip_address":"","ucode":"FFD17BAA3B2312","user_header":"https://static001.geekbang.org/account/avatar/00/28/83/17/df99b53d.jpg","comment_is_top":false,"comment_ctime":1631113381,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1631113381","product_id":100079601,"comment_content":"ä¸€èˆ¬å¼€å‘ä¸­å°±åšäº†å•å…ƒæµ‹è¯•å’Œmockæµ‹è¯•ã€‚è€Œä¸”è¿˜éƒ½æ˜¯æ‰‹å†™ï¼ŒCVå¤åˆ¶ï¼Œæ²¡æƒ³åˆ°è¿˜æœ‰å¤§é‡å·¥å…·æ¥è‡ªåŠ¨ç”Ÿæˆï¼ŒåŒ…æ‹¬å¾ˆå¤šæµ‹è¯•æ¡†æ¶ï¼Œgeiåˆ°äº†","like_count":0},{"had_liked":false,"id":308095,"user_name":"Sch0ng","can_delete":false,"product_type":"c1","uid":1145554,"ip_address":"","ucode":"73F6113931B1AC","user_header":"https://static001.geekbang.org/account/avatar/00/11/7a/d2/4ba67c0c.jpg","comment_is_top":false,"comment_ctime":1629387174,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1629387174","product_id":100079601,"comment_content":"ä»‹ç»äº†ç¤ºä¾‹æµ‹è¯•ã€TestMain æµ‹è¯•ã€Mock æµ‹è¯•ã€Fake æµ‹è¯•ï¼ŒåŠ ä¸Šä¸Šä¸€è®²ä¸­çš„å•å…ƒæµ‹è¯•å’Œæ€§èƒ½æµ‹è¯•ï¼Œå…±6ç§æµ‹è¯•ç±»å‹ã€‚<br>æ–‡ä¸­æä¾›äº†æ¯ç§æµ‹è¯•çš„ç¤ºä¾‹ï¼Œå¯ä»¥ä½œä¸ºæµ‹è¯•æ–¹æ³•å¤§å…¨ï¼Œä¾›åç»­éœ€è¦çš„æ—¶å€™æŸ¥çœ‹ã€‚","like_count":0,"discussions":[{"author":{"id":2628969,"avatar":"https://static001.geekbang.org/account/avatar/00/28/1d/69/c21d2644.jpg","nickname":"josephzxy","note":"","ucode":"71E8006733420D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":393596,"discussion_content":"TestMain æµ‹è¯•ã€Mock æµ‹è¯•ã€Fake æµ‹è¯• åº”è¯¥ç®—æ˜¯å¯¹å•å…ƒæµ‹è¯•ï¼Œæ€§èƒ½æµ‹è¯•å’Œç¤ºä¾‹æµ‹è¯•çš„è¾…åŠ©ã€‚æ¯”å¦‚å¯¹äºå•æµ‹ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨TestMainæ¥å®ç°setupå’Œteardownï¼Œç”¨mockå’Œfakeæµ‹è¯•æ¥mockæ‰€éœ€çš„ä¾èµ–ï¼ˆå¦‚æ•°æ®åº“ï¼Œç½‘ç»œioç­‰ï¼‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631508300,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}