{"id":159459,"title":"31 | 实现服务器端编解码","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/geek_netty\">https://gitee.com/geektime-geekbang/geek_netty</a></p>","comments":[{"had_liked":false,"id":149419,"user_name":"小不点","can_delete":false,"product_type":"c3","uid":1351860,"ip_address":"","ucode":"C307D44A185C34","user_header":"https://static001.geekbang.org/account/avatar/00/14/a0/b4/5173f1af.jpg","comment_is_top":false,"comment_ctime":1573214219,"is_pvip":false,"replies":[{"id":57924,"content":"你打卡打的真心不错！","user_name":"作者回复","user_name_real":"Geek_9bc307","uid":1638649,"ctime":1573569036,"ip_address":"","comment_id":149419,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"终于实战了，源码看的我头都大了，强忍着自己看完，不过还是有收获的，计划是实战完之后再战源码的，打卡，下周三见！！！","like_count":6,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":473856,"discussion_content":"你打卡打的真心不错！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573569036,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":171735,"user_name":"btshanghaib","can_delete":false,"product_type":"c3","uid":1270638,"ip_address":"","ucode":"825FDD05F32421","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/iaQZhTib9pUoE6icavnTy9YCC3aZNxxZtfKPRS51icicxqzzcQVnmVCMzv3bLZqx0kibicYd4e86E2IfXpE9gpyHW8vyA/132","comment_is_top":false,"comment_ctime":1579003997,"is_pvip":false,"replies":[{"id":66656,"content":"1 应该释放，你没有看到释放，是因为在它继承的父类中：\nMessageToMessageDecoder#channelRead\n                try {\n                    decode(ctx, cast, out);\n                } finally {\n                    ReferenceCountUtil.release(cast);\n}\n\n2 没有效果，因为它的实现是这样的：\n        if (msg instanceof ReferenceCounted) {\n            return ((ReferenceCounted) msg).release();\n        }\n\n好处就是不用管这些细致末节了，直接release，需要release的会释放，不需要的（没有实现ReferenceCounted）不释放。所以对我们来说省心友好。","user_name":"作者回复","user_name_real":"stroller","uid":1638649,"ctime":1579053540,"ip_address":"","comment_id":171735,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"这里请教老师一个问题，在 OrderProtocolDecoder  里，原始传入的ByteBuf 已经被转成 RequestMessage 了，而这个 ByteBuf 后面页不会再被接下来的Handler使用，不是应该手动释放release它吗？转换成的 RequestMessage 本身并不是一个ReferenceCounted， 在SimpleChannelInboundHandler 对它release应该是没有效果的吧？  这里应该怎么理解呢？","like_count":3,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":481488,"discussion_content":"1 应该释放，你没有看到释放，是因为在它继承的父类中：\nMessageToMessageDecoder#channelRead\n                try {\n                    decode(ctx, cast, out);\n                } finally {\n                    ReferenceCountUtil.release(cast);\n}\n\n2 没有效果，因为它的实现是这样的：\n        if (msg instanceof ReferenceCounted) {\n            return ((ReferenceCounted) msg).release();\n        }\n\n好处就是不用管这些细致末节了，直接release，需要release的会释放，不需要的（没有实现ReferenceCounted）不释放。所以对我们来说省心友好。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579053540,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":157278,"user_name":"空白","can_delete":false,"product_type":"c3","uid":1147753,"ip_address":"","ucode":"65DA67B52A16B9","user_header":"https://static001.geekbang.org/account/avatar/00/11/83/69/77256c74.jpg","comment_is_top":false,"comment_ctime":1575102077,"is_pvip":false,"replies":[{"id":61400,"content":"是的，因为finally语句中会尝试释放，但是肯定不执行释放因为释放的时候会判断：\n    public static boolean release(Object msg) {\n        if (msg instanceof ReferenceCounted) {\n            return ((ReferenceCounted) msg).release();\n        }\n        return false;\n    }","user_name":"作者回复","user_name_real":"stroller","uid":1638649,"ctime":1576116242,"ip_address":"","comment_id":157278,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"OrderServerProcessHandler中传入的参数是RequestMessage，不是ByteBuf ，SimpleChannelInboundHandler也会帮忙释放?  ","like_count":1,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":476383,"discussion_content":"是的，因为finally语句中会尝试释放，但是肯定不执行释放因为释放的时候会判断：\n    public static boolean release(Object msg) {\n        if (msg instanceof ReferenceCounted) {\n            return ((ReferenceCounted) msg).release();\n        }\n        return false;\n    }","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576116242,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":390403,"user_name":"5-刘新波(Arvin)","can_delete":false,"product_type":"c3","uid":1174199,"ip_address":"陕西","ucode":"DBD135D2587A93","user_header":"https://static001.geekbang.org/account/avatar/00/11/ea/b7/1a18a39d.jpg","comment_is_top":false,"comment_ctime":1715267490,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"FrameDecoder里的lengthFeildLength为什么是2，消息的长度是int,应该是4才对吧","like_count":0},{"had_liked":false,"id":258585,"user_name":"冬渐暖","can_delete":false,"product_type":"c3","uid":1586800,"ip_address":"","ucode":"907E41AAE9A36C","user_header":"https://static001.geekbang.org/account/avatar/00/18/36/70/00122b24.jpg","comment_is_top":false,"comment_ctime":1604492175,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"编解ma的过程为\n1.一个请求过来了，先解决粘包半包 decoder。。。。可以以frameDecoder结尾，需要extends LengthFieldBasedFrameDecoder \n2.为了把这个数据给业务层处理，需要把这个解ma后的给解成我们想要的 。吧byteBuffer转成requestMessage。可以以protocolDecoder结尾  extends MessageToMessageDecoder&lt;ByteBuf&gt; \n3.把处理好的编码转成byteBuffer。可以以protocolEncoder结尾 extends MessageToMessageEncoder&lt;ResponseMessage&gt;\n4.为了帮客户端解决粘包半包，我们把这个数据加密出来。可以以protocolEncoder结尾 需要extends LengthFieldPrepender 。这个LengthFieldBasedFrameDecoder就是之前说的自定义长度解ma器\n\n很好记的一点 和客户端做交互的叫frame，和自己交互的叫protocol，需要处理什么参数，就传什么样的数据类型","like_count":0},{"had_liked":false,"id":257134,"user_name":"请弄脏我的身体","can_delete":false,"product_type":"c3","uid":2210402,"ip_address":"","ucode":"3A739BCE645191","user_header":"http://thirdwx.qlogo.cn/mmopen/h0KAdRFKjCOSLRjzictvlaMl1IOiaXpuDgjiaIRMxQkib4sT82zUTKd5EDeIxmCIXjYj0HVAVy8skI9lC3HialEbak5QPIZHX6sFB/132","comment_is_top":false,"comment_ctime":1603856385,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"为什么项目里的OrderFrameEncoder的参数设置是2？OrderFrameDecoder的参数设置是super(Integer.MAX_VALUE, 0, 2, 0, 2)？换成别的就会报错？","like_count":0,"discussions":[{"author":{"id":2251534,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLia4qBUs5bFs5tU3yVCcBapIcnVftM60nrJ73eu30YDMbDNvjhvnibct3pMYlj62G1c7nH8jSBaiaLw/132","nickname":"李文彬","note":"","ucode":"4CD326DC443028","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":351654,"discussion_content":"因为预设的length长度是2","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1614381614,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":225022,"user_name":"左琪","can_delete":false,"product_type":"c3","uid":1468773,"ip_address":"","ucode":"6B797070168A12","user_header":"https://static001.geekbang.org/account/avatar/00/16/69/65/eb778125.jpg","comment_is_top":false,"comment_ctime":1591618967,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"为啥orderframeencoder要继承LengthFieldPrepender,这个对象转byte,为什么不用MessageToByteEncoder的子类呢","like_count":0,"discussions":[{"author":{"id":1701485,"avatar":"https://static001.geekbang.org/account/avatar/00/19/f6/6d/412b5dc4.jpg","nickname":"李家鑫","note":"","ucode":"83A47B7F95E12B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":286641,"discussion_content":"这个时候只需要在头部写上长度字段就行了吧，继承LengthFieldPrepender，构造器传2就完事儿了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1593251969,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":206112,"user_name":"hexl94","can_delete":false,"product_type":"c3","uid":1516057,"ip_address":"","ucode":"B39A898B9554F5","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEJESm0Lvu0HbFuSX0wFFX8JWtTHfa9kzlKbjRNlWXch3AdD2iadxj5KR1xiaOYsST6nSVbPQzl36OTQ/132","comment_is_top":false,"comment_ctime":1586788358,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"我想问下，未什么设计协议时候为什么没加魔数，不加魔数判断，是不是所有协议都会解码下，是不是浪费资源","like_count":0},{"had_liked":false,"id":193867,"user_name":"yang","can_delete":false,"product_type":"c3","uid":1074310,"ip_address":"","ucode":"1AA1497C5A293C","user_header":"https://static001.geekbang.org/account/avatar/00/10/64/86/f5a9403a.jpg","comment_is_top":false,"comment_ctime":1584975400,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"老师， 我用浏览器打开 htt:&#47;&#47;127.0.0.1:8090 或者 curl http:&#47;&#47;127.0.0.1:8090 都报同样的异常:\n\n22:53:02 [worker-3-7] DefaultChannelPipeline: An exceptionCaught() event was fired, and it reached at the tail of the pipeline. It usually means the last handler in the pipeline did not handle the exception.\nio.netty.handler.codec.TooLongFrameException: Adjusted frame length exceeds 10240: 18247 - discarded\n\n说是最大能接受的frame大小为10240， http发送的是18247， 它丢弃了。\n我想问一下，为啥浏览器 和 curl 发送的frame大小是一样的呢？\n","like_count":0},{"had_liked":false,"id":193858,"user_name":"NoBody","can_delete":false,"product_type":"c3","uid":1173766,"ip_address":"","ucode":"72E1B4FCDA2469","user_header":"https://static001.geekbang.org/account/avatar/00/11/e9/06/038a9cea.jpg","comment_is_top":false,"comment_ctime":1584974768,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"打卡打卡！","like_count":0}]}