{"id":483364,"title":"06 | äº‹ä»¶è§¦å‘ï¼šå„ç±» eBPF ç¨‹åºçš„è§¦å‘æœºåˆ¶åŠå…¶åº”ç”¨åœºæ™¯","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å€ªæœ‹é£ã€‚</p><p>ä¸Šä¸€è®²ï¼Œæˆ‘å¸¦ä½ ä¸€èµ·æ¢³ç†äº† eBPF ç¨‹åºè·Ÿå†…æ ¸äº¤äº’çš„åŸºæœ¬æ–¹æ³•ã€‚ä¸€ä¸ªå®Œæ•´çš„ eBPF ç¨‹åºé€šå¸¸åŒ…å«ç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¸¤éƒ¨åˆ†ï¼šç”¨æˆ·æ€ç¨‹åºé€šè¿‡ BPF ç³»ç»Ÿè°ƒç”¨ï¼Œå®Œæˆ eBPF ç¨‹åºçš„åŠ è½½ã€äº‹ä»¶æŒ‚è½½ä»¥åŠæ˜ å°„åˆ›å»ºå’Œæ›´æ–°ï¼Œè€Œå†…æ ¸æ€ä¸­çš„ eBPF ç¨‹åºåˆ™éœ€è¦é€šè¿‡ BPF è¾…åŠ©å‡½æ•°å®Œæˆæ‰€éœ€çš„ä»»åŠ¡ã€‚</p><p>åœ¨ä¸Šä¸€è®²ä¸­æˆ‘ä¹Ÿæåˆ°ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„è¾…åŠ©å‡½æ•°éƒ½å¯ä»¥åœ¨ eBPF ç¨‹åºä¸­éšæ„ä½¿ç”¨ï¼Œä¸åŒç±»å‹çš„ eBPF ç¨‹åºæ‰€æ”¯æŒçš„è¾…åŠ©å‡½æ•°æ˜¯ä¸åŒçš„ã€‚é‚£ä¹ˆï¼ŒeBPF ç¨‹åºéƒ½æœ‰å“ªäº›ç±»å‹ï¼Œè€Œä¸åŒç±»å‹çš„ eBPF ç¨‹åºåˆæœ‰å“ªäº›ç‹¬ç‰¹çš„åº”ç”¨åœºæ™¯å‘¢ï¼Ÿä»Šå¤©ï¼Œæˆ‘å°±å¸¦ä½ ä¸€èµ·æ¥çœ‹çœ‹ã€‚</p><h2>eBPF ç¨‹åºå¯ä»¥åˆ†æˆå‡ ç±»ï¼Ÿ</h2><p>eBPF ç¨‹åºç±»å‹å†³å®šäº†ä¸€ä¸ª eBPF ç¨‹åºå¯ä»¥æŒ‚è½½çš„äº‹ä»¶ç±»å‹å’Œäº‹ä»¶å‚æ•°ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€ï¼Œå†…æ ¸ä¸­ä¸åŒäº‹ä»¶ä¼šè§¦å‘ä¸åŒç±»å‹çš„ eBPF ç¨‹åºã€‚</p><p>æ ¹æ®å†…æ ¸å¤´æ–‡ä»¶ <a href=\"https://elixir.bootlin.com/linux/v5.13/source/include/uapi/linux/bpf.h#L908\">include/uapi/linux/bpf.h</a> ä¸­  <code>bpf_prog_type</code> çš„å®šä¹‰ï¼ŒLinux å†…æ ¸ v5.13 å·²ç»æ”¯æŒ 30 ç§ä¸åŒç±»å‹çš„ eBPF ç¨‹åºï¼ˆæ³¨æ„ï¼Œ&nbsp;<code>BPF_PROG_TYPE_UNSPEC</code>è¡¨ç¤ºæœªå®šä¹‰ï¼‰ï¼š</p><pre><code class=\"language-c++\">enum bpf_prog_type {\n\tBPF_PROG_TYPE_UNSPEC, /* Reserve 0 as invalid program type */\n\tBPF_PROG_TYPE_SOCKET_FILTER,\n\tBPF_PROG_TYPE_KPROBE,\n\tBPF_PROG_TYPE_SCHED_CLS,\n\tBPF_PROG_TYPE_SCHED_ACT,\n\tBPF_PROG_TYPE_TRACEPOINT,\n\tBPF_PROG_TYPE_XDP,\n\tBPF_PROG_TYPE_PERF_EVENT,\n\tBPF_PROG_TYPE_CGROUP_SKB,\n\tBPF_PROG_TYPE_CGROUP_SOCK,\n\tBPF_PROG_TYPE_LWT_IN,\n\tBPF_PROG_TYPE_LWT_OUT,\n\tBPF_PROG_TYPE_LWT_XMIT,\n\tBPF_PROG_TYPE_SOCK_OPS,\n\tBPF_PROG_TYPE_SK_SKB,\n\tBPF_PROG_TYPE_CGROUP_DEVICE,\n\tBPF_PROG_TYPE_SK_MSG,\n\tBPF_PROG_TYPE_RAW_TRACEPOINT,\n\tBPF_PROG_TYPE_CGROUP_SOCK_ADDR,\n\tBPF_PROG_TYPE_LWT_SEG6LOCAL,\n\tBPF_PROG_TYPE_LIRC_MODE2,\n\tBPF_PROG_TYPE_SK_REUSEPORT,\n\tBPF_PROG_TYPE_FLOW_DISSECTOR,\n\tBPF_PROG_TYPE_CGROUP_SYSCTL,\n\tBPF_PROG_TYPE_RAW_TRACEPOINT_WRITABLE,\n\tBPF_PROG_TYPE_CGROUP_SOCKOPT,\n\tBPF_PROG_TYPE_TRACING,\n\tBPF_PROG_TYPE_STRUCT_OPS,\n\tBPF_PROG_TYPE_EXT,\n\tBPF_PROG_TYPE_LSM,\n\tBPF_PROG_TYPE_SK_LOOKUP,\n};\n</code></pre><!-- [[[read_end]]] --><p>å¯¹äºå…·ä½“çš„å†…æ ¸æ¥è¯´ï¼Œå› ä¸ºä¸åŒå†…æ ¸çš„ç‰ˆæœ¬å’Œç¼–è¯‘é…ç½®é€‰é¡¹ä¸åŒï¼Œä¸€ä¸ªå†…æ ¸å¹¶ä¸ä¼šæ”¯æŒæ‰€æœ‰çš„ç¨‹åºç±»å‹ã€‚ä½ å¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œæ¥æŸ¥è¯¢å½“å‰ç³»ç»Ÿæ”¯æŒçš„ç¨‹åºç±»å‹ï¼š</p><pre><code class=\"language-plain\">bpftool feature probe | grep program_type\n</code></pre><p>æ‰§è¡Œåï¼Œä½ ä¼šå¾—åˆ°å¦‚ä¸‹çš„è¾“å‡ºï¼š</p><pre><code class=\"language-plain\">eBPF program_type socket_filter is available\neBPF program_type kprobe is available\neBPF program_type sched_cls is available\neBPF program_type sched_act is available\neBPF program_type tracepoint is available\neBPF program_type xdp is available\neBPF program_type perf_event is available\n...\neBPF program_type ext is NOT available\neBPF program_type lsm is NOT available\neBPF program_type sk_lookup is available\n</code></pre><p>åœ¨è¿™äº›è¾“å‡ºä¸­ï¼Œä½ å¯ä»¥çœ‹åˆ°å½“å‰å†…æ ¸æ”¯æŒ kprobeã€xdpã€perf_event ç­‰ç¨‹åºç±»å‹ï¼Œè€Œä¸æ”¯æŒ extã€lsm ç­‰ç¨‹åºç±»å‹ã€‚</p><p>æ ¹æ®å…·ä½“åŠŸèƒ½å’Œåº”ç”¨åœºæ™¯çš„ä¸åŒï¼Œè¿™äº›ç¨‹åºç±»å‹å¤§è‡´å¯ä»¥åˆ’åˆ†ä¸ºä¸‰ç±»ï¼š</p><ul>\n<li>ç¬¬ä¸€ç±»æ˜¯è·Ÿè¸ªï¼Œå³ä»å†…æ ¸å’Œç¨‹åºçš„è¿è¡ŒçŠ¶æ€ä¸­æå–è·Ÿè¸ªä¿¡æ¯ï¼Œæ¥äº†è§£å½“å‰ç³»ç»Ÿæ­£åœ¨å‘ç”Ÿä»€ä¹ˆã€‚</li>\n<li>ç¬¬äºŒç±»æ˜¯ç½‘ç»œï¼Œå³å¯¹ç½‘ç»œæ•°æ®åŒ…è¿›è¡Œè¿‡æ»¤å’Œå¤„ç†ï¼Œä»¥ä¾¿äº†è§£å’Œæ§åˆ¶ç½‘ç»œæ•°æ®åŒ…çš„æ”¶å‘è¿‡ç¨‹ã€‚</li>\n<li>ç¬¬ä¸‰ç±»æ˜¯é™¤è·Ÿè¸ªå’Œç½‘ç»œä¹‹å¤–çš„å…¶ä»–ç±»å‹ï¼ŒåŒ…æ‹¬å®‰å…¨æ§åˆ¶ã€BPF æ‰©å±•ç­‰ç­‰ã€‚</li>\n</ul><p>æ¥ä¸‹æ¥ï¼Œæˆ‘å°±å¸¦ä½ ä¸€èµ·åˆ†åˆ«çœ‹çœ‹ï¼Œæ¯ä¸€ç±» eBPF ç¨‹åºéƒ½æœ‰å“ªäº›å…·ä½“çš„ç±»å‹ï¼Œä»¥åŠè¿™äº›ä¸åŒç±»å‹çš„ç¨‹åºéƒ½æ˜¯ç”±å“ªäº›äº‹ä»¶è§¦å‘æ‰§è¡Œçš„ã€‚</p><h2>è·Ÿè¸ªç±» eBPF ç¨‹åº</h2><p>å…ˆçœ‹ç¬¬ä¸€ç±»ï¼Œä¹Ÿå°±æ˜¯è·Ÿè¸ªç±» eBPF ç¨‹åºã€‚</p><p><strong>è·Ÿè¸ªç±» eBPF ç¨‹åºä¸»è¦ç”¨äºä»ç³»ç»Ÿä¸­æå–è·Ÿè¸ªä¿¡æ¯ï¼Œè¿›è€Œä¸ºç›‘æ§ã€æ’é”™ã€æ€§èƒ½ä¼˜åŒ–ç­‰æä¾›æ•°æ®æ”¯æ’‘ã€‚</strong>æ¯”å¦‚ï¼Œæˆ‘ä»¬å‰å‡ è®²ä¸­çš„ Hello World ç¤ºä¾‹å°±æ˜¯ä¸€ä¸ª <code>BPF_PROG_TYPE_KPROBE</code> ç±»å‹çš„è·Ÿè¸ªç¨‹åºï¼Œå®ƒçš„ç›®çš„æ˜¯è·Ÿè¸ªå†…æ ¸å‡½æ•°æ˜¯å¦è¢«æŸä¸ªè¿›ç¨‹è°ƒç”¨äº†ã€‚</p><p>ä¸ºäº†æ–¹ä¾¿ä½ æŸ¥è¯¢ï¼Œæˆ‘æŠŠå¸¸è§çš„è·Ÿè¸ªç±» BPF ç¨‹åºçš„ä¸»è¦åŠŸèƒ½ä»¥åŠä½¿ç”¨é™åˆ¶æ•´ç†æˆäº†ä¸€ä¸ªè¡¨æ ¼ï¼Œä½ å¯ä»¥åœ¨éœ€è¦æ—¶å‚è€ƒã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/04/38/042fe319b51yy6bc153ce0f877f54a38.jpg?wh=1920x1098\" alt=\"å›¾ç‰‡\"></p><p>è¿™å…¶ä¸­ï¼ŒKPROBEã€TRACEPOINT ä»¥åŠ PERF_EVENT éƒ½æ˜¯æœ€å¸¸ç”¨çš„ eBPF ç¨‹åºç±»å‹ï¼Œå¤§é‡åº”ç”¨äºç›‘æ§è·Ÿè¸ªã€æ€§èƒ½ä¼˜åŒ–ä»¥åŠè°ƒè¯•æ’é”™ç­‰åœºæ™¯ä¸­ã€‚æˆ‘ä»¬å‰å‡ è®²ä¸­æåˆ°çš„ <a href=\"https://github.com/iovisor/bcc\">BCC</a>å·¥å…·é›†ï¼Œå…¶ä¸­åŒ…å«çš„ç»å¤§éƒ¨åˆ†å·¥å…·ä¹Ÿéƒ½å±äºè¿™ä¸ªç±»å‹ã€‚</p><h2>ç½‘ç»œç±» eBPF ç¨‹åº</h2><p>çœ‹å®Œè·Ÿè¸ªç±» eBPF ç¨‹åºï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹ç½‘ç»œç±» eBPF ç¨‹åºã€‚</p><p><strong>ç½‘ç»œç±» eBPF ç¨‹åºä¸»è¦ç”¨äºå¯¹ç½‘ç»œæ•°æ®åŒ…è¿›è¡Œè¿‡æ»¤å’Œå¤„ç†ï¼Œè¿›è€Œå®ç°ç½‘ç»œçš„è§‚æµ‹ã€è¿‡æ»¤ã€æµé‡æ§åˆ¶ä»¥åŠæ€§èƒ½ä¼˜åŒ–ç­‰å„ç§ä¸°å¯Œçš„åŠŸèƒ½ã€‚</strong>æ ¹æ®äº‹ä»¶è§¦å‘ä½ç½®çš„ä¸åŒï¼Œç½‘ç»œç±» eBPF ç¨‹åºåˆå¯ä»¥åˆ†ä¸º XDPï¼ˆeXpress Data Pathï¼Œé«˜é€Ÿæ•°æ®è·¯å¾„ï¼‰ç¨‹åºã€TCï¼ˆTraffic Controlï¼Œæµé‡æ§åˆ¶ï¼‰ç¨‹åºã€å¥—æ¥å­—ç¨‹åºä»¥åŠ cgroup ç¨‹åºï¼Œä¸‹é¢æˆ‘ä»¬æ¥åˆ†åˆ«çœ‹çœ‹ã€‚</p><h3><strong>XDP ç¨‹åº</strong></h3><p>XDP ç¨‹åºçš„ç±»å‹å®šä¹‰ä¸º <code>BPF_PROG_TYPE_XDP</code>ï¼Œå®ƒåœ¨<strong>ç½‘ç»œé©±åŠ¨ç¨‹åºåˆšåˆšæ”¶åˆ°æ•°æ®åŒ…æ—¶</strong>è§¦å‘æ‰§è¡Œã€‚ç”±äºæ— éœ€é€šè¿‡ç¹æ‚çš„å†…æ ¸ç½‘ç»œåè®®æ ˆï¼ŒXDP ç¨‹åºå¯ç”¨æ¥å®ç°é«˜æ€§èƒ½çš„ç½‘ç»œå¤„ç†æ–¹æ¡ˆï¼Œå¸¸ç”¨äº DDoS é˜²å¾¡ã€é˜²ç«å¢™ã€4 å±‚è´Ÿè½½å‡è¡¡ç­‰åœºæ™¯ã€‚</p><p>ä½ éœ€è¦æ³¨æ„ï¼ŒXDP ç¨‹åºå¹¶ä¸æ˜¯ç»•è¿‡äº†å†…æ ¸åè®®æ ˆï¼Œå®ƒåªæ˜¯åœ¨å†…æ ¸åè®®æ ˆä¹‹å‰å¤„ç†æ•°æ®åŒ…ï¼Œè€Œå¤„ç†è¿‡çš„æ•°æ®åŒ…è¿˜å¯ä»¥æ­£å¸¸é€šè¿‡å†…æ ¸åè®®æ ˆç»§ç»­å¤„ç†ã€‚ä½ å¯ä»¥é€šè¿‡ä¸‹é¢çš„å›¾ç‰‡ï¼ˆå›¾ç‰‡æ¥è‡ª <a href=\"https://www.iovisor.org/technology/xdp\">iovisor.org</a>ï¼‰åŠ æ·±å¯¹&nbsp;XDP ç›¸å¯¹å†…æ ¸åè®®æ ˆä½ç½®çš„ç†è§£ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/3b/31/3b77fea948d6264bfb4b4c266526dd31.png?wh=768x420\" alt=\"å›¾ç‰‡\" title=\"XDPæ¦‚è§ˆ\"></p><p>æ ¹æ®ç½‘å¡å’Œç½‘å¡é©±åŠ¨æ˜¯å¦åŸç”Ÿæ”¯æŒ XDP ç¨‹åºï¼ŒXDP è¿è¡Œæ¨¡å¼å¯ä»¥åˆ†ä¸ºä¸‹é¢è¿™ä¸‰ç§ï¼š</p><ul>\n<li>é€šç”¨æ¨¡å¼ã€‚å®ƒä¸éœ€è¦ç½‘å¡å’Œç½‘å¡é©±åŠ¨çš„æ”¯æŒï¼ŒXDP ç¨‹åºåƒå¸¸è§„çš„ç½‘ç»œåè®®æ ˆä¸€æ ·è¿è¡Œåœ¨å†…æ ¸ä¸­ï¼Œæ€§èƒ½ç›¸å¯¹è¾ƒå·®ï¼Œä¸€èˆ¬ç”¨äºæµ‹è¯•ï¼›</li>\n<li>åŸç”Ÿæ¨¡å¼ã€‚å®ƒéœ€è¦ç½‘å¡é©±åŠ¨ç¨‹åºçš„æ”¯æŒï¼ŒXDP ç¨‹åºåœ¨ç½‘å¡é©±åŠ¨ç¨‹åºçš„æ—©æœŸè·¯å¾„è¿è¡Œï¼›</li>\n<li>å¸è½½æ¨¡å¼ã€‚å®ƒéœ€è¦ç½‘å¡å›ºä»¶æ”¯æŒ XDP å¸è½½ï¼ŒXDP ç¨‹åºç›´æ¥è¿è¡Œåœ¨ç½‘å¡ä¸Šï¼Œè€Œä¸å†éœ€è¦æ¶ˆè€—ä¸»æœºçš„ CPU èµ„æºï¼Œå…·æœ‰æœ€å¥½çš„æ€§èƒ½ã€‚</li>\n</ul><p>æ— è®ºå“ªç§æ¨¡å¼ï¼ŒXDP ç¨‹åºåœ¨å¤„ç†è¿‡ç½‘ç»œåŒ…ä¹‹åï¼Œéƒ½éœ€è¦æ ¹æ® eBPF ç¨‹åºæ‰§è¡Œç»“æœï¼Œå†³å®šæ•°æ®åŒ…çš„å»å¤„ã€‚è¿™äº›æ‰§è¡Œç»“æœå¯¹åº”ä»¥ä¸‹ 5 ç§ XDP ç¨‹åºç»“æœç ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/a2/a7/a2cayy9f21129590a91ca07604b070a7.jpg?wh=1920x1237\" alt=\"å›¾ç‰‡\"></p><p>é€šå¸¸æ¥è¯´ï¼ŒXDP ç¨‹åºé€šè¿‡ <code>ip link</code> å‘½ä»¤åŠ è½½åˆ°å…·ä½“çš„ç½‘å¡ä¸Šï¼ŒåŠ è½½æ ¼å¼ä¸ºï¼š</p><pre><code class=\"language-bash\"># eth1 ä¸ºç½‘å¡å\n# xdpgeneric è®¾ç½®è¿è¡Œæ¨¡å¼ä¸ºé€šç”¨æ¨¡å¼\n# xdp-example.o ä¸ºç¼–è¯‘åçš„ XDP å­—èŠ‚ç \nsudo ip link set dev eth1 xdpgeneric object xdp-example.o\n</code></pre><p>è€Œå¸è½½ XDP ç¨‹åºä¹Ÿæ˜¯é€šè¿‡ <code>ip link</code> å‘½ä»¤ï¼Œå…·ä½“å‚æ•°å¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">sudo ip link set veth1 xdpgeneric off\n</code></pre><p>é™¤äº† <code>ip link</code>ä¹‹å¤–ï¼Œ BCC ä¹Ÿæä¾›äº†æ–¹ä¾¿çš„åº“å‡½æ•°ï¼Œè®©æˆ‘ä»¬å¯ä»¥åœ¨åŒä¸€ä¸ªç¨‹åºä¸­ç®¡ç† XDP ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸï¼š</p><pre><code class=\"language-python\">from bcc import BPF\n\n# ç¼–è¯‘XDPç¨‹åº\nb = BPF(src_file=\"xdp-example.c\")\nfn = b.load_func(\"xdp-example\", BPF.XDP)\n\n# åŠ è½½XDPç¨‹åºåˆ°eth0ç½‘å¡\ndevice = \"eth0\"\nb.attach_xdp(device, fn, 0)\n\n# å…¶ä»–å¤„ç†é€»è¾‘\n...\n\n# å¸è½½XDPç¨‹åº\nb.remove_xdp(device)\n</code></pre><h3><strong>TC ç¨‹åº</strong></h3><p>TC ç¨‹åºçš„ç±»å‹å®šä¹‰ä¸º <code>BPF_PROG_TYPE_SCHED_CLS</code> å’Œ <code>BPF_PROG_TYPE_SCHED_ACT</code>ï¼Œåˆ†åˆ«ä½œä¸º <a href=\"https://tldp.org/HOWTO/Traffic-Control-HOWTO/index.html\">Linux æµé‡æ§åˆ¶</a> çš„åˆ†ç±»å™¨å’Œæ‰§è¡Œå™¨ã€‚Linux æµé‡æ§åˆ¶é€šè¿‡ç½‘å¡é˜Ÿåˆ—ã€æ’é˜Ÿè§„åˆ™ã€åˆ†ç±»å™¨ã€è¿‡æ»¤å™¨ä»¥åŠæ‰§è¡Œå™¨ç­‰ï¼Œå®ç°äº†å¯¹ç½‘ç»œæµé‡çš„æ•´å½¢è°ƒåº¦å’Œå¸¦å®½æ§åˆ¶ã€‚</p><p>ä¸‹å›¾ï¼ˆå›¾ç‰‡æ¥è‡ª <a href=\"http://linux-ip.net/articles/Traffic-Control-HOWTO/\">linux-ip.net</a>ï¼‰å±•ç¤ºäº†&nbsp;HTBï¼ˆHierarchical Token Bucketï¼Œå±‚çº§ä»¤ç‰Œæ¡¶ï¼‰æµé‡æ§åˆ¶çš„å·¥ä½œåŸç†ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/3c/69/3c445830476ed2f32d71e99309b26369.png?wh=1369x1049\" alt=\"å›¾ç‰‡\" title=\"HTB æµé‡æ§åˆ¶\"></p><p>ç”±äº Linux æµé‡æ§åˆ¶å¹¶éæœ¬è¯¾ç¨‹çš„é‡ç‚¹ï¼Œè¿™é‡Œæˆ‘å°±ä¸è¿‡å¤šå±•å¼€äº†ã€‚å¦‚æœä½ å¯¹å®ƒè¿˜ä¸ç†Ÿæ‚‰ï¼Œå¯ä»¥å‚è€ƒ&nbsp;<a href=\"https://tldp.org/HOWTO/Traffic-Control-HOWTO/index.html\">å®˜æ–¹æ–‡æ¡£</a>&nbsp;è¿›è¡Œå­¦ä¹ ã€‚</p><p>å¾—ç›Šäºå†…æ ¸ v4.4 å¼•å…¥çš„ <a href=\"https://docs.cilium.io/en/v1.8/bpf/#tc-traffic-control\">direct-action</a> æ¨¡å¼ï¼ŒTC ç¨‹åºå¯ä»¥ç›´æ¥åœ¨ä¸€ä¸ªç¨‹åºå†…å®Œæˆåˆ†ç±»å’Œæ‰§è¡Œçš„åŠ¨ä½œï¼Œè€Œæ— éœ€å†è°ƒç”¨å…¶ä»–çš„ TC æ’é˜Ÿè§„åˆ™å’Œåˆ†ç±»å™¨ï¼Œå…·ä½“å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/31/d5/31ecf04f2477bd4765be9544a62deed5.jpg?wh=1920x888\" alt=\"å›¾ç‰‡\" title=\"TC eBPF ç¨‹åºä¸ç½‘ç»œåè®®æ ˆçš„å…³ç³»\"></p><p>åŒ XDP ç¨‹åºç›¸æ¯”ï¼ŒTC ç¨‹åºå¯ä»¥<strong>ç›´æ¥è·å–å†…æ ¸è§£æåçš„ç½‘ç»œæŠ¥æ–‡æ•°æ®ç»“æ„</strong><code>sk_buff</code>ï¼ˆXDP åˆ™æ˜¯ <code>xdp_buff</code>ï¼‰ï¼Œå¹¶ä¸”å¯<strong>åœ¨ç½‘å¡çš„æ¥æ”¶å’Œå‘é€ä¸¤ä¸ªæ–¹å‘ä¸Šæ‰§è¡Œ</strong>ï¼ˆXDP åˆ™åªèƒ½ç”¨äºæ¥æ”¶ï¼‰ã€‚ä¸‹é¢æˆ‘ä»¬æ¥å…·ä½“çœ‹çœ‹&nbsp;TC ç¨‹åºçš„æ‰§è¡Œä½ç½®ï¼š</p><ul>\n<li>å¯¹äºæ¥æ”¶çš„ç½‘ç»œåŒ…ï¼ŒTC ç¨‹åºåœ¨ç½‘å¡æ¥æ”¶ï¼ˆGROï¼‰ä¹‹åã€åè®®æ ˆå¤„ç†ï¼ˆåŒ…æ‹¬ IP å±‚å¤„ç†å’Œ iptables ç­‰ï¼‰ä¹‹å‰æ‰§è¡Œï¼›</li>\n<li>å¯¹äºå‘é€çš„ç½‘ç»œåŒ…ï¼ŒTC ç¨‹åºåœ¨åè®®æ ˆå¤„ç†ï¼ˆåŒ…æ‹¬ IP å±‚å¤„ç†å’Œ iptables ç­‰ï¼‰ä¹‹åã€æ•°æ®åŒ…å‘é€åˆ°ç½‘å¡é˜Ÿåˆ—ï¼ˆGSOï¼‰ä¹‹å‰æ‰§è¡Œã€‚</li>\n</ul><p>é™¤æ­¤ä¹‹å¤–ï¼Œç”±äº TC è¿è¡Œåœ¨å†…æ ¸åè®®æ ˆä¸­ï¼Œä¸éœ€è¦ç½‘å¡é©±åŠ¨ç¨‹åºåšä»»ä½•æ”¹åŠ¨ï¼Œå› è€Œå¯ä»¥æŒ‚è½½åˆ°ä»»æ„ç±»å‹çš„ç½‘å¡è®¾å¤‡ï¼ˆåŒ…æ‹¬å®¹å™¨ç­‰ä½¿ç”¨çš„è™šæ‹Ÿç½‘å¡ï¼‰ä¸Šã€‚</p><p>åŒ XDP ç¨‹åºä¸€æ ·ï¼ŒTC eBPF ç¨‹åºä¹Ÿå¯ä»¥é€šè¿‡ Linux å‘½ä»¤è¡Œå·¥å…·æ¥åŠ è½½åˆ°ç½‘å¡ä¸Šï¼Œä¸è¿‡ç›¸åº”çš„å·¥å…·è¦æ¢æˆ <code>tc</code>ã€‚ä½ å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤ï¼Œåˆ†åˆ«åŠ è½½æ¥æ”¶å’Œå‘é€æ–¹å‘çš„ eBPF ç¨‹åºï¼š</p><pre><code class=\"language-bash\"># åˆ›å»º clsact ç±»å‹çš„æ’é˜Ÿè§„åˆ™\nsudo tc qdisc add dev eth0 clsact\n\n# åŠ è½½æ¥æ”¶æ–¹å‘çš„ eBPF ç¨‹åº\nsudo tc filter add dev eth0 ingress bpf da obj tc-example.o sec ingress\n\n# åŠ è½½å‘é€æ–¹å‘çš„ eBPF ç¨‹åº\nsudo tc filter add dev eth0 egress bpf da obj tc-example.o sec egress\n</code></pre><h3><strong>å¥—æ¥å­—ç¨‹åº</strong></h3><p>å¥—æ¥å­—ç¨‹åºç”¨äºè¿‡æ»¤ã€è§‚æµ‹æˆ–é‡å®šå‘å¥—æ¥å­—ç½‘ç»œåŒ…ï¼Œå…·ä½“çš„ç§ç±»ä¹Ÿæ¯”è¾ƒä¸°å¯Œã€‚æ ¹æ®ç±»å‹çš„ä¸åŒï¼Œå¥—æ¥å­— eBPF ç¨‹åºå¯ä»¥æŒ‚è½½åˆ°å¥—æ¥å­—ï¼ˆsocketï¼‰ã€æ§åˆ¶ç»„ï¼ˆcgroup ï¼‰ä»¥åŠç½‘ç»œå‘½åç©ºé—´ï¼ˆnetnsï¼‰ç­‰å„ä¸ªä½ç½®ã€‚ä½ å¯ä»¥æ ¹æ®å…·ä½“çš„åº”ç”¨åœºæ™¯ï¼Œé€‰æ‹©ä¸€ä¸ªæˆ–ç»„åˆå¤šä¸ªç±»å‹çš„ eBPF ç¨‹åºï¼Œå»æ§åˆ¶å¥—æ¥å­—çš„ç½‘ç»œåŒ…æ”¶å‘è¿‡ç¨‹ã€‚</p><p>è¿™é‡Œï¼Œæˆ‘æŠŠå¸¸è§çš„å¥—æ¥å­—ç¨‹åºç±»å‹ï¼Œä»¥åŠå®ƒä»¬çš„åº”ç”¨åœºæ™¯å’ŒæŒ‚è½½æ–¹æ³•æ•´ç†æˆäº†ä¸€ä¸ªè¡¨æ ¼ï¼Œä½ å¯ä»¥åœ¨éœ€è¦æ—¶å‚è€ƒï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/0e/44/0e57bf041262114198fd29e1e5c04044.jpg?wh=1920x1566\" alt=\"å›¾ç‰‡\"></p><h3><strong>cgroup ç¨‹åº</strong></h3><p>cgroup ç¨‹åºç”¨äº<strong>å¯¹ cgroup å†…æ‰€æœ‰è¿›ç¨‹çš„ç½‘ç»œè¿‡æ»¤ã€å¥—æ¥å­—é€‰é¡¹ä»¥åŠè½¬å‘ç­‰è¿›è¡ŒåŠ¨æ€æ§åˆ¶</strong>ï¼Œå®ƒæœ€å…¸å‹çš„åº”ç”¨åœºæ™¯æ˜¯å¯¹å®¹å™¨ä¸­è¿è¡Œçš„å¤šä¸ªè¿›ç¨‹è¿›è¡Œç½‘ç»œæ§åˆ¶ã€‚</p><p>cgroup ç¨‹åºçš„ç§ç±»æ¯”è¾ƒä¸°å¯Œï¼Œæˆ‘ä¹Ÿå¸®ä½ æ•´ç†äº†ä¸€ä¸ªè¡¨æ ¼ï¼Œæ–¹ä¾¿ä½ åœ¨éœ€è¦æ—¶æŸ¥è¯¢ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/c3/52/c37b8849096311726e734e8549fd9452.jpg?wh=1920x1216\" alt=\"å›¾ç‰‡\"></p><p>è¿™äº›ç±»å‹çš„ BPF ç¨‹åºéƒ½å¯ä»¥é€šè¿‡ BPF ç³»ç»Ÿè°ƒç”¨çš„ <code>BPF_PROG_ATTACH</code> å‘½ä»¤æ¥è¿›è¡ŒæŒ‚è½½ï¼Œå¹¶è®¾ç½®<a href=\"https://elixir.bootlin.com/linux/v5.13/source/include/uapi/linux/bpf.h#L942\">æŒ‚è½½ç±»å‹</a>ä¸ºåŒ¹é…çš„ <code>BPF_CGROUP_xxx</code> ç±»å‹ã€‚æ¯”å¦‚ï¼Œåœ¨æŒ‚è½½ <code>BPF_PROG_TYPE_CGROUP_DEVICE</code> ç±»å‹çš„ BPF ç¨‹åºæ—¶ï¼Œéœ€è¦è®¾ç½® <code>bpf_attach_type</code> ä¸º <code>BPF_CGROUP_DEVICE</code>ï¼š</p><pre><code class=\"language-c++\">union bpf_attr attr = {};\nattr.target_fd = target_fd;            // cgroupæ–‡ä»¶æè¿°ç¬¦\nattr.attach_bpf_fd = prog_fd;          // BPFç¨‹åºæ–‡ä»¶æè¿°ç¬¦\nattr.attach_type = BPF_CGROUP_DEVICE;  // æŒ‚è½½ç±»å‹ä¸ºBPF_CGROUP_DEVICE\n\nif (bpf(BPF_PROG_ATTACH, &amp;attr, sizeof(attr)) &lt; 0) {\n  return -errno;\n}\n\n...\n</code></pre><p>æ³¨æ„ï¼Œè¿™å‡ ç±»ç½‘ç»œ eBPF ç¨‹åºæ˜¯åœ¨ä¸åŒçš„äº‹ä»¶è§¦å‘æ—¶æ‰§è¡Œçš„ï¼Œå› æ­¤ï¼Œåœ¨å®é™…åº”ç”¨ä¸­æˆ‘ä»¬é€šå¸¸å¯ä»¥æŠŠå¤šä¸ªç±»å‹çš„ eBPF ç¨‹åºç»“åˆèµ·æ¥ï¼Œä¸€èµ·ä½¿ç”¨ï¼Œæ¥å®ç°å¤æ‚çš„ç½‘ç»œæ§åˆ¶åŠŸèƒ½ã€‚æ¯”å¦‚ï¼Œæœ€æµè¡Œçš„ Kubernetes ç½‘ç»œæ–¹æ¡ˆ Cilium å°±å¤§é‡ä½¿ç”¨äº† XDPã€TC å’Œå¥—æ¥å­— eBPF ç¨‹åºï¼Œå¦‚ä¸‹å›¾ï¼ˆå›¾ç‰‡æ¥è‡ª Cilium <a href=\"https://docs.cilium.io/en/v1.11/concepts/ebpf/lifeofapacket/\">å®˜æ–¹æ–‡æ¡£</a>ï¼Œå›¾ä¸­é»„è‰²éƒ¨åˆ†å³ä¸º Cilium eBPF ç¨‹åºï¼‰æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/45/13/452c809d6e3335fb933a8f991eedf113.png?wh=1454x714\" alt=\"å›¾ç‰‡\" title=\"Cilium eBPF æ•°æ®é¢\"></p><h2>å…¶ä»–ç±» eBPF ç¨‹åº</h2><p>é™¤äº†ä¸Šé¢çš„è·Ÿè¸ªå’Œç½‘ç»œ eBPF ç¨‹åºä¹‹å¤–ï¼ŒLinux å†…æ ¸è¿˜æ”¯æŒå¾ˆå¤šå…¶ä»–çš„ç±»å‹ã€‚è¿™äº›ç±»å‹çš„ eBPF ç¨‹åºè™½ç„¶ä¸å¤ªå¸¸ç”¨ï¼Œä½†åœ¨éœ€è¦çš„æ—¶å€™ä¹Ÿå¯ä»¥å¸®ä½ è§£å†³å¾ˆå¤šç‰¹å®šçš„é—®é¢˜ã€‚</p><p>æˆ‘å°†è¿™äº›æ— æ³•åˆ’åˆ†åˆ°ç½‘ç»œå’Œè·Ÿè¸ªçš„ eBPF ç¨‹åºéƒ½å½’ä¸ºå…¶ä»–ç±»ï¼Œå¹¶å¸®ä½ æ•´ç†äº†ä¸€ä¸ªè¡¨æ ¼ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/93/f2/93ae17801e82579e07937e5f1595a0f2.jpg?wh=1920x1332\" alt=\"å›¾ç‰‡\"></p><p>è¿™ä¸ªè¡¨æ ¼åˆ—å‡ºäº†ä¸€äº›ä¸å¤ªå¸¸ç”¨çš„ eBPF ç¨‹åºç±»å‹ï¼Œä½ å¯ä»¥å…ˆå¤§è‡´æµè§ˆä¸‹ï¼Œåœ¨éœ€è¦çš„æ—¶å€™å†å»æ·±å…¥äº†è§£ã€‚</p><h2>å°ç»“</h2><p>ä»Šå¤©ï¼Œæˆ‘å¸¦ä½ ä¸€èµ·æ¢³ç†äº† eBPF ç¨‹åºçš„ä¸»è¦ç±»å‹ï¼Œä»¥åŠä¸åŒç±»å‹ eBPF ç¨‹åºçš„åº”ç”¨åœºæ™¯ã€‚</p><p>æ ¹æ®å…·ä½“åŠŸèƒ½å’Œåº”ç”¨åœºæ™¯çš„ä¸åŒï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ eBPF ç¨‹åºåˆ†ä¸ºè·Ÿè¸ªã€ç½‘ç»œå’Œå…¶ä»–ä¸‰ç±»ï¼š</p><ul>\n<li>è·Ÿè¸ªç±» eBPF ç¨‹åºä¸»è¦ç”¨äºä»ç³»ç»Ÿä¸­æå–è·Ÿè¸ªä¿¡æ¯ï¼Œè¿›è€Œä¸ºç›‘æ§ã€æ’é”™ã€æ€§èƒ½ä¼˜åŒ–ç­‰æä¾›æ•°æ®æ”¯æ’‘ï¼›</li>\n<li>ç½‘ç»œç±» eBPF ç¨‹åºä¸»è¦ç”¨äºå¯¹ç½‘ç»œæ•°æ®åŒ…è¿›è¡Œè¿‡æ»¤å’Œå¤„ç†ï¼Œè¿›è€Œå®ç°ç½‘ç»œçš„è§‚æµ‹ã€è¿‡æ»¤ã€æµé‡æ§åˆ¶ä»¥åŠæ€§èƒ½ä¼˜åŒ–ç­‰ï¼›</li>\n<li>å…¶ä»–ç±»åˆ™åŒ…å«äº†è·Ÿè¸ªå’Œç½‘ç»œä¹‹å¤–çš„å…¶ä»–&nbsp;eBPF&nbsp;ç¨‹åºç±»å‹ï¼Œå¦‚å®‰å…¨æ§åˆ¶ã€BPF æ‰©å±•ç­‰ã€‚</li>\n</ul><p>è™½ç„¶æ¯ä¸ª eBPF ç¨‹åºéƒ½æœ‰ç‰¹å®šçš„ç±»å‹å’Œè§¦å‘äº‹ä»¶ï¼Œä½†è¿™å¹¶ä¸æ„å‘³ç€å®ƒä»¬éƒ½æ˜¯å®Œå…¨ç‹¬ç«‹çš„ã€‚é€šè¿‡ BPF æ˜ å°„æä¾›çš„çŠ¶æ€å…±äº«æœºåˆ¶ï¼Œå„ç§ä¸åŒç±»å‹çš„ eBPF ç¨‹åºå®Œå…¨å¯ä»¥ç›¸äº’é…åˆï¼Œä¸ä»…å¯ä»¥ç»•è¿‡å•ä¸ª eBPF ç¨‹åºæŒ‡ä»¤æ•°é‡çš„é™åˆ¶ï¼Œè¿˜å¯ä»¥å®ç°æ›´ä¸ºå¤æ‚çš„æ§åˆ¶é€»è¾‘ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>æœ€åï¼Œæˆ‘æƒ³é‚€è¯·ä½ æ¥èŠä¸€èŠï¼š</p><ol>\n<li>ä½ æ˜¯æ€ä¹ˆç†è§£ eBPF ç¨‹åºç±»å‹çš„å‘¢ï¼Ÿ</li>\n<li>å¦‚æœè®©ä½ æ¥é‡æ–°è®¾è®¡ç±»ä¼¼äº Cilium çš„ç½‘ç»œæ–¹æ¡ˆï¼Œä½ ä¼šå¦‚ä½•é€‰æ‹© eBPF ç¨‹åºç±»å‹å‘¢ï¼Ÿ</li>\n</ol><p>æœŸå¾…ä½ åœ¨ç•™è¨€åŒºå’Œæˆ‘è®¨è®ºï¼Œä¹Ÿæ¬¢è¿æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™ä½ çš„åŒäº‹ã€æœ‹å‹ã€‚è®©æˆ‘ä»¬ä¸€èµ·åœ¨å®æˆ˜ä¸­æ¼”ç»ƒï¼Œåœ¨äº¤æµä¸­è¿›æ­¥ã€‚</p>","neighbors":{"left":{"article_title":"05 | ç¼–ç¨‹æ¥å£ï¼šeBPF ç¨‹åºæ˜¯æ€ä¹ˆè·Ÿå†…æ ¸è¿›è¡Œäº¤äº’çš„ï¼Ÿ","id":482459},"right":{"article_title":"07 | å†…æ ¸è·Ÿè¸ªï¼ˆä¸Šï¼‰ï¼šå¦‚ä½•æŸ¥è¯¢å†…æ ¸ä¸­çš„è·Ÿè¸ªç‚¹ï¼Ÿ","id":484207}},"comments":[{"had_liked":false,"id":332746,"user_name":"YF","can_delete":false,"product_type":"c1","uid":2806937,"ip_address":"","ucode":"ED2534DA57C49A","user_header":"https://static001.geekbang.org/account/avatar/00/2a/d4/99/594e35c2.jpg","comment_is_top":false,"comment_ctime":1643541177,"is_pvip":false,"replies":[{"id":"121662","content":"ğŸ‘éå¸¸æ£’ï¼","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1001282","ctime":1643812187,"ip_address":"","comment_id":332746,"utype":1}],"discussion_count":1,"race_medal":0,"score":"31708312249","product_id":100104501,"comment_content":"ä½ æ˜¯æ€ä¹ˆç†è§£ eBPF ç¨‹åºç±»å‹çš„å‘¢ï¼Ÿ<br><br>eBPF å¯¹åº”ä¸å†…æ ¸çš„äº‹ä»¶ç±»å‹ï¼ŒçŠ¹å¦‚è®¢é˜…åŒç±»æ¶ˆæ¯äº‹ä»¶ï¼Œå†…æ ¸å‘ç°å¯¹åº”çš„äº‹ä»¶ï¼Œåˆ™é€šçŸ¥è®¢é˜…è€…å¤„ç†ã€‚","like_count":7,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":549293,"discussion_content":"ğŸ‘éå¸¸æ£’ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1643812187,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":333715,"user_name":"é˜¿ç«‹","can_delete":false,"product_type":"c1","uid":1345286,"ip_address":"","ucode":"4AE3B0360A2F9C","user_header":"https://static001.geekbang.org/account/avatar/00/14/87/06/bedf7932.jpg","comment_is_top":false,"comment_ctime":1644482560,"is_pvip":false,"replies":[{"id":"122037","content":"éƒ½æ˜¯ç½‘ç»œåŒ…äº‹ä»¶é’©å­ï¼Œå½“ç„¶ä¹Ÿæ˜¯ç½‘ç»œå¤„ç†æµç¨‹ä¸­çš„ä¸€éƒ¨åˆ†ã€‚XDPå’ŒTCå…¶å®æœ‰äº›ç±»ä¼¼ï¼Œä½†TCæ€»æ˜¯åœ¨å†…æ ¸ä¸­æ‰§è¡Œï¼Œè€ŒXDPå¯ä»¥å¸è½½åˆ°ç½‘å¡ç¡¬ä»¶ï¼Œä»è€Œè·å¾—æ›´å¥½çš„æ€§èƒ½ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1001282","ctime":1644732052,"ip_address":"","comment_id":333715,"utype":1}],"discussion_count":3,"race_medal":0,"score":"23119319040","product_id":100104501,"comment_content":"ä½œè€…å¤§ä½¬ï¼Œxdpæ˜¯ä¸€ä¸ªå†…æ ¸ç½‘ç»œå¤„ç†æ¨¡å—ï¼Œè¿˜æ˜¯ç½‘ç»œåŒ…è¿›å…¥åè®®æ ˆä¹‹å‰çš„äº‹ä»¶é’©å­ç‚¹å‘¢ï¼Ÿ tcå‘¢ï¼Ÿ","like_count":5,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":550790,"discussion_content":"éƒ½æ˜¯ç½‘ç»œåŒ…äº‹ä»¶é’©å­ï¼Œå½“ç„¶ä¹Ÿæ˜¯ç½‘ç»œå¤„ç†æµç¨‹ä¸­çš„ä¸€éƒ¨åˆ†ã€‚XDPå’ŒTCå…¶å®æœ‰äº›ç±»ä¼¼ï¼Œä½†TCæ€»æ˜¯åœ¨å†…æ ¸ä¸­æ‰§è¡Œï¼Œè€ŒXDPå¯ä»¥å¸è½½åˆ°ç½‘å¡ç¡¬ä»¶ï¼Œä»è€Œè·å¾—æ›´å¥½çš„æ€§èƒ½ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1644732052,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":2,"child_discussions":[{"author":{"id":1340382,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJSOibgpMRJhsdzccmnzD6tvlcuybnytDyLibVnw6DcCRb1srMehLExtrjDIT0TB7j2hyzurtRQNpQA/132","nickname":"äººä»ä¼—","note":"","ucode":"099648810213C3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":553788,"discussion_content":"&#34;å¸è½½åˆ°ç½‘å¡ç¡¬ä»¶&#34;æ€æ ·ç†è§£ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1646094903,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":550790,"ip_address":""},"score":553788,"extra":""},{"author":{"id":2074244,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/KP50Y6ecpjQw9BtpUKoSYPVemhy2PKECndqSqCTvvFbUrEgn9AbOMwJrialqxiac7j2zlFakzqTguDgHSG7iaAx2Q/132","nickname":"andy6689","note":"","ucode":"C11F2C9071A2B3","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1340382,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJSOibgpMRJhsdzccmnzD6tvlcuybnytDyLibVnw6DcCRb1srMehLExtrjDIT0TB7j2hyzurtRQNpQA/132","nickname":"äººä»ä¼—","note":"","ucode":"099648810213C3","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":590366,"discussion_content":"å°±æ˜¯åˆ°ç½‘å¡ä¸Šç‹¬ç«‹æ‰§è¡Œï¼Œä¸ä¾èµ–ä¸»æœºcpu","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1665708909,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":553788,"ip_address":"å¹¿ä¸œ"},"score":590366,"extra":""}]}]},{"had_liked":false,"id":335517,"user_name":"äºç«¶","can_delete":false,"product_type":"c1","uid":1219827,"ip_address":"","ucode":"4A74417B0727A4","user_header":"https://static001.geekbang.org/account/avatar/00/12/9c/f3/e01dfe3a.jpg","comment_is_top":false,"comment_ctime":1645549708,"is_pvip":true,"replies":[{"id":"122625","content":"å—¯å—¯ å¯ä»¥çš„ã€‚ä½†å®é™…ä¸Šåªæ˜¯æµé‡å¤åˆ¶çš„è¯ï¼Œå¹¶ä¸éœ€è¦eBPFï¼Œæ— è®ºæ˜¯ç½‘ç»œç¡¬ä»¶è¿˜æ˜¯OVSã€TCç­‰å·²æœ‰çš„Linuxå·¥å…·æ—©å°±æ”¯æŒæµé‡å¤åˆ¶äº†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1001282","ctime":1645614872,"ip_address":"","comment_id":335517,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14530451596","product_id":100104501,"comment_content":"çœ‹äº†ä¸Šé¢ä»‹ç»çš„ç½‘ç»œç±»å‹çš„eBPFç¨‹åºï¼Œå¥½å¥‡å¯ä¸å¯ä»¥ç”¨æ¥å¼€å‘æµé‡å¤åˆ¶å·¥å…·å‘¢","like_count":3,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":552856,"discussion_content":"å—¯å—¯ å¯ä»¥çš„ã€‚ä½†å®é™…ä¸Šåªæ˜¯æµé‡å¤åˆ¶çš„è¯ï¼Œå¹¶ä¸éœ€è¦eBPFï¼Œæ— è®ºæ˜¯ç½‘ç»œç¡¬ä»¶è¿˜æ˜¯OVSã€TCç­‰å·²æœ‰çš„Linuxå·¥å…·æ—©å°±æ”¯æŒæµé‡å¤åˆ¶äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1645614872,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":341794,"user_name":"å½¬","can_delete":false,"product_type":"c1","uid":2323422,"ip_address":"","ucode":"77ED556AC1C01D","user_header":"https://static001.geekbang.org/account/avatar/00/23/73/de/0e1eda4d.jpg","comment_is_top":false,"comment_ctime":1649834734,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"5944802030","product_id":100104501,"comment_content":"è€å¸ˆåç»­ä¼šæœ‰æ›´å…¨çš„ç¯å¢ƒæ­å»ºå—ï¼Ÿæ¯”å¦‚å‡çº§å†…æ ¸ï¼Œå¦‚æœä¸èƒ½ç›´æ¥aptå®‰è£…bccç­‰éœ€è¦é‡‡å–æºç ç¼–è¯‘ç­‰æƒ…å†µï¼Œå¦‚ä½•åœ¨æœ¬åœ°ç¯å¢ƒä¸­ç¼–è¯‘ç„¶åå‘å¸ƒåˆ°ç”Ÿäº§ç¯å¢ƒç­‰æƒ…å†µè®²è§£æˆ–è€…èµ„æ–™","like_count":1},{"had_liked":false,"id":340021,"user_name":"asdf100","can_delete":false,"product_type":"c1","uid":1043738,"ip_address":"","ucode":"39D8D71453E575","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ed/1a/ce7f7d54.jpg","comment_is_top":false,"comment_ctime":1648543432,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5943510728","product_id":100104501,"comment_content":"æ€ä¹ˆçŸ¥é“ç½‘å¡æ˜¯å¦æ”¯æŒXDPï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1309377,"avatar":"","nickname":"mxmkeep","note":"","ucode":"7068125FE98AB1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":587076,"discussion_content":"https://prototype-kernel.readthedocs.io/en/latest/networking/XDP/implementation/drivers.html\nçœ‹è¿™é‡Œæ˜¯å¦èƒ½å›ç­”ä½ çš„é—®é¢˜","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662740389,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å¹¿ä¸œ"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":337738,"user_name":"ä»»æ™ºæ°byte","can_delete":false,"product_type":"c1","uid":1413409,"ip_address":"","ucode":"5591FB2A5D1CE9","user_header":"https://static001.geekbang.org/account/avatar/00/15/91/21/d38d8391.jpg","comment_is_top":false,"comment_ctime":1646998729,"is_pvip":false,"replies":[{"id":"123551","content":"å¢åŠ æ–°çš„ç±»å‹å°±éœ€è¦ä¿®æ”¹å†…æ ¸æºç äº†","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1001282","ctime":1647166024,"ip_address":"","comment_id":337738,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5941966025","product_id":100104501,"comment_content":"å¦‚ä½•æ‰©å±•ç¨‹åºç±»å‹å‘¢ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":556024,"discussion_content":"å¢åŠ æ–°çš„ç±»å‹å°±éœ€è¦ä¿®æ”¹å†…æ ¸æºç äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1647166024,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":332575,"user_name":"ä¸äº†å³°","can_delete":false,"product_type":"c1","uid":1013424,"ip_address":"","ucode":"E23B96D6A3D4EC","user_header":"https://static001.geekbang.org/account/avatar/00/0f/76/b0/14fec62f.jpg","comment_is_top":false,"comment_ctime":1643352862,"is_pvip":false,"replies":[{"id":"121562","content":"åŠ æ²¹ï¼","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1001282","ctime":1643460840,"ip_address":"","comment_id":332575,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5938320158","product_id":100104501,"comment_content":"æ‰“å¡","like_count":1,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":548959,"discussion_content":"åŠ æ²¹ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1643460840,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":360799,"user_name":"tj.â€¢","can_delete":false,"product_type":"c1","uid":1470635,"ip_address":"å¹¿ä¸œ","ucode":"078D80A68491E8","user_header":"https://static001.geekbang.org/account/avatar/00/16/70/ab/7a7399a7.jpg","comment_is_top":false,"comment_ctime":1666859773,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1666859773","product_id":100104501,"comment_content":"è€å¸ˆï¼Œä½¿ç”¨ciliumä»£æ›¿iptablesä¹‹åï¼Œpodè®¿é—®ä¸€ä¸ªservice ipï¼Œæ˜¯åœ¨å“ªä¸ªhookåšDNATæˆendpoint pod ipçš„ï¼Ÿ","like_count":0},{"had_liked":false,"id":351313,"user_name":"Lime","can_delete":false,"product_type":"c1","uid":2915194,"ip_address":"","ucode":"0F06DCA27EB787","user_header":"https://static001.geekbang.org/account/avatar/00/2c/7b/7a/70c904e9.jpg","comment_is_top":false,"comment_ctime":1657693299,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1657693299","product_id":100104501,"comment_content":"ePBFæœ‰æ²¡æœ‰åŠæ³•ä¿®æ”¹å†…æ ¸ä¼ è¿›æ¥çš„å‚æ•°","like_count":0},{"had_liked":false,"id":344375,"user_name":"ä¸€","can_delete":false,"product_type":"c1","uid":2994528,"ip_address":"","ucode":"3279A52DC22C89","user_header":"https://static001.geekbang.org/account/avatar/00/2d/b1/60/23c03681.jpg","comment_is_top":false,"comment_ctime":1651499565,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1651499565","product_id":100104501,"comment_content":"è€å¸ˆï¼Œæˆ‘æƒ³é—®ä¸€ä¸‹ï¼Œæ¯”å¦‚æˆ‘æƒ³åœ¨ç³»ç»Ÿå¼¹çª—æ—¶æ’è£…ï¼Œæ€ä¹ˆæ‰¾åˆ°ç³»ç»Ÿå¼¹çª—è¿™ä¸ªhookç‚¹å‘¢ï¼Œæ¯”å¦‚SECï¼ˆâ€œuprobe&#47;è¿™ä¸ªåœ°æ–¹åº”è¯¥å¡«ä»€ä¹ˆå‘¢ï¼Œæˆ–è€…è¯´åœ¨å“ªé‡Œæœ‰è¿™ä¸ªuprobeä¸‹é¢hookç‚¹çš„åˆ—è¡¨å‘¢â€ï¼‰","like_count":0,"discussions":[{"author":{"id":1183408,"avatar":"https://static001.geekbang.org/account/avatar/00/12/0e/b0/ebf0afc3.jpg","nickname":"å°æœ¯","note":"","ucode":"D73BB46F2BA736","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":577242,"discussion_content":"bpftrace -l &#34;uprobe:&lt;library_path&gt;*&#34; å¯ä»¥åˆ—å‡ºæŸä¸ªåŠ¨æ€åº“çš„ uprobe hook ç‚¹ï¼Œä½†å…·ä½“è¿™ä¸ªé€»è¾‘åœ¨å“ªä¸ªå¯æ‰§è¡Œæ–‡ä»¶/åŠ¨æ€åº“é‡Œé¢ï¼Œéœ€è¦è‡ªå·±åˆ†æã€‚å°±å¥½æ¯”åšæ‰‹æœ¯ï¼Œæ™ºèƒ½æ‰‹æœ¯åˆ€å¯ä»¥å‘Šè¯‰ä½ å“ªäº›åœ°æ–¹å¯ä»¥åŠ¨åˆ€ï¼Œä½†å…·ä½“åˆ°å“ªä¸ªç—…éœ€è¦åœ¨å“ªä¸ªä½ç½®åŠ¨ï¼Œéœ€è¦åŒ»ç”Ÿè‡ªå·±åˆ¤æ–­ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655982337,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":338758,"user_name":"ç«ç«å¯»","can_delete":false,"product_type":"c1","uid":1120541,"ip_address":"","ucode":"B6DC003A5D89AF","user_header":"https://static001.geekbang.org/account/avatar/00/11/19/1d/d2b6e006.jpg","comment_is_top":false,"comment_ctime":1647702318,"is_pvip":false,"replies":[{"id":"123961","content":"è¿™ä¸ªå¯èƒ½ç›´æ¥ç”¨dubboä¼šæ¯”ebpfè¦æ›´ç®€å•ã€‚ebpfè™½ç„¶ä¹Ÿå¯ä»¥ç”¨ï¼Œä½†æ¯•ç«Ÿè¿è¡Œåœ¨å†…æ ¸ä¸­ï¼Œå®ç°å¤æ‚åº¦ä¼šé«˜ä¸€äº›","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1001282","ctime":1647959204,"ip_address":"","comment_id":338758,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1647702318","product_id":100104501,"comment_content":"è€å¸ˆï¼Œé—®ä¸‹ï¼Œå¦‚æœæƒ³è¦åšä¸šåŠ¡å±‚çš„æµé‡æ§åˆ¶ï¼Œæ¯”å¦‚dubboè¯·æ±‚éƒ¨åˆ†é»‘åå•ä¸è®©è¿›æ¥ï¼Œä½¿ç”¨å“ªç§åˆé€‚ï¼Ÿ<br>","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":557780,"discussion_content":"è¿™ä¸ªå¯èƒ½ç›´æ¥ç”¨dubboä¼šæ¯”ebpfè¦æ›´ç®€å•ã€‚ebpfè™½ç„¶ä¹Ÿå¯ä»¥ç”¨ï¼Œä½†æ¯•ç«Ÿè¿è¡Œåœ¨å†…æ ¸ä¸­ï¼Œå®ç°å¤æ‚åº¦ä¼šé«˜ä¸€äº›","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1647959204,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}