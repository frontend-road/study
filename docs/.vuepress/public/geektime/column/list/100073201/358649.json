{"id":358649,"title":"13 | 临时表：复杂查询，如何保存中间结果？","content":"<p>你好，我是朱晓峰。今天，我来和你聊一聊临时表。</p><p>当我们遇到一些复杂查询的时候，经常无法一步到位，或者是一步到位会导致查询语句太过复杂，开发和维护的成本过高。这个时候，就可以使用临时表。</p><p>下面，我就结合实际的项目来讲解一下，怎么拆解一个复杂的查询，通过临时表来保存中间结果，从而把一个复杂查询变得简单而且容易实现。</p><h2>临时表是什么？</h2><p>临时表是一种特殊的表，用来存储查询的中间结果，并且会随着当前连接的结束而自动删除。<strong>MySQL中有2种临时表，分别是内部临时表和外部临时表</strong>：</p><ul>\n<li>内部临时表主要用于性能优化，由系统自动产生，我们无法看到；</li>\n<li>外部临时表通过SQL语句创建，我们可以使用。</li>\n</ul><p>因为我们不能使用内部临时表，所以我就不多讲了。今天，我来重点讲一讲我们可以创建和使用的外部临时表。</p><p>首先，你要知道临时表的创建语法结构：</p><pre><code>CREATE TEMPORARY TABLE 表名\n(\n字段名 字段类型,\n...\n);\n</code></pre><p>跟普通表相比，临时表有3个不同的特征：</p><ol>\n<li>临时表的创建语法需要用到关键字TEMPORARY；</li>\n<li>临时表创建完成之后，只有当前连接可见，其他连接是看不到的，具有连接隔离性；</li>\n<li>临时表在当前连接结束之后，会被自动删除。</li>\n</ol><p>因为临时表有连接隔离性，不同连接创建相同名称的临时表也不会产生冲突，适合并发程序的运行。而且，连接结束之后，临时表会自动删除，也不用担心大量无用的中间数据会残留在数据库中。因此，我们就可以利用这些特点，用临时表来存储SQL查询的中间结果。</p><!-- [[[read_end]]] --><h2>如何用临时表简化复杂查询？</h2><p>刚刚提到，临时表可以简化复杂查询，具体是怎么实现的呢？我来介绍一下。</p><p>举个例子，超市经营者想要查询2020年12月的一些特定商品销售数量、进货数量、返厂数量，那么，我们就要先把销售、进货、返厂这3个模块分开计算，用临时表来存储中间计算的结果，最后合并在一起，形成超市经营者想要的结果集。</p><p>首先，我们统计一下在2020年12月的商品销售数据。</p><p>假设我们的销售流水表（mysales）如下所示：</p><p><img src=\"https://static001.geekbang.org/resource/image/ay/f5/ayy269bb7dd210a1f1716ebd2947e9f5.jpeg?wh=1494*632\" alt=\"\"></p><p>我们可以用下面的SQL语句，查询出每个单品的销售数量和销售金额，并存入临时表：</p><pre><code>mysql&gt; CREATE TEMPORARY TABLE demo.mysales\n-&gt; SELECT                        -- 用查询的结果直接生成临时表\n-&gt; itemnumber,\n-&gt; SUM(quantity) AS QUANTITY,\n-&gt; SUM(salesvalue) AS salesvalue\n-&gt; FROM\n-&gt; demo.transactiondetails\n-&gt; GROUP BY itemnumber\n-&gt; ORDER BY itemnumber;\nQuery OK, 2 rows affected (0.01 sec)\nRecords: 2 Duplicates: 0 Warnings: 0\n \nmysql&gt; SELECT * FROM demo.mysales;\n+------------+----------+------------+\n| itemnumber | QUANTITY | salesvalue |\n+------------+----------+------------+\n| 1 | 5.000 | 411.18 |\n| 2 | 5.000 | 24.75 |\n+------------+----------+------------+\n2 rows in set (0.01 sec)\n</code></pre><p>需要注意的是，这里我是直接用查询结果来创建的临时表。因为创建临时表就是为了存放某个查询的中间结果。直接用查询语句创建临时表比较快捷，而且连接结束后临时表就会被自动删除，不需要过多考虑表的结构设计问题（比如冗余、效率等）。</p><p>到这里，我们就有了一个存储单品销售统计的临时表。接下来，我们计算一下2020年12月的进货信息。</p><p>我们的进货数据包括进货单头表（importhead）和进货单明细表（importdetails）。</p><p>进货单头表包括进货单编号、供货商编号、仓库编号、操作员编号和验收日期：</p><p><img src=\"https://static001.geekbang.org/resource/image/0a/80/0acf5b6ee4f154414fefd543b33f7180.jpeg?wh=1492*569\" alt=\"\"></p><p>进货单明细表包括进货单编号、商品编号、进货数量、进货价格和进货金额：</p><p><img src=\"https://static001.geekbang.org/resource/image/36/36/368d0f558d497be064d264baaf99e636.jpeg?wh=1429*698\" alt=\"\"></p><p>我们用下面的SQL语句计算进货数据，并且保存在临时表里面：</p><pre><code>mysql&gt; CREATE TEMPORARY TABLE demo.myimport\n-&gt; SELECT b.itemnumber,SUM(b.quantity) AS quantity,SUM(b.importvalue) AS importvalue\n-&gt; FROM demo.importhead a JOIN demo.importdetails b\n-&gt; ON (a.listnumber=b.listnumber)\n-&gt; GROUP BY b.itemnumber;\nQuery OK, 3 rows affected (0.01 sec)\nRecords: 3 Duplicates: 0 Warnings: 0\n \nmysql&gt; SELECT * FROM demo.myimport;\n+------------+----------+-------------+\n| itemnumber | quantity | importvalue |\n+------------+----------+-------------+\n| 1 | 5.000 | 290.00 |\n| 2 | 5.000 | 15.00 |\n| 3 | 8.000 | 40.00 |\n+------------+----------+-------------+\n3 rows in set (0.00 sec)\n</code></pre><p>这样，我们又得到了一个临时表demo.myimport，里面保存了我们需要的进货数据。</p><p>接着，我们来查询单品返厂数据，并且保存到临时表。</p><p>我们的返厂数据表有2个，分别是返厂单头表（returnhead）和返厂单明细表（returndetails）。</p><p>返厂单头表包括返厂单编号、供货商编号、仓库编号、操作员编号和验收日期：</p><p><img src=\"https://static001.geekbang.org/resource/image/20/3e/206c5ba8bdcb13c55c78a1ec1f4aab3e.jpeg?wh=1536*542\" alt=\"\"></p><p>返厂单明细表包括返厂单编号、商品编号、返厂数量、返厂价格和返厂金额：</p><p><img src=\"https://static001.geekbang.org/resource/image/a9/4b/a9bda457d8f15e8f87fc5d0f4e2ee24b.jpeg?wh=1446*681\" alt=\"\"></p><p>我们可以使用下面的SQL语句计算返厂信息，并且保存到临时表中。</p><pre><code>mysql&gt; CREATE TEMPORARY TABLE demo.myreturn\n-&gt; SELECT b.itemnumber,SUM(b.quantity) AS quantity,SUM(b.returnvalue) AS returnvalue\n-&gt; FROM demo.returnhead a JOIN demo.returndetails b\n-&gt; ON (a.listnumber=b.listnumber)\n-&gt; GROUP BY b.itemnumber;\nQuery OK, 3 rows affected (0.01 sec)\nRecords: 3 Duplicates: 0 Warnings: 0\n \nmysql&gt; SELECT * FROM demo.myreturn;\n+------------+----------+-------------+\n| itemnumber | quantity | returnvalue |\n+------------+----------+-------------+\n| 1 | 2.000 | 115.00 |\n| 2 | 1.000 | 3.00 |\n| 3 | 1.000 | 5.00 |\n+------------+----------+-------------+\n3 rows in set (0.00 sec)\n</code></pre><p>这样，我们就获得了单品的返厂信息。</p><p>有了前面计算出来的数据，现在，我们就可以把单品的销售信息、进货信息和返厂信息汇总到一起了。</p><p>如果你跟着实际操作的话，你可能会有这样一个问题：我们现在有3个临时表，分别存储单品的销售信息、进货信息和返厂信息。那么，能不能把这3个表相互关联起来，把这些信息都汇总到对应的单品呢？</p><p>答案是不行，不管是用内连接、还是用外连接，都不可以。因为无论是销售信息、进货信息，还是返厂信息，都存在商品信息缺失的情况。换句话说，就是在指定时间段内，某些商品可能没有销售，某些商品可能没有进货，某些商品可能没有返厂。如果仅仅通过这3个表之间的连接进行查询，我们可能会丢失某些数据。</p><p>为了解决这个问题，我们可以引入商品信息表。因为商品信息表包含所有的商品，因此，把商品信息表放在左边，与其他的表进行左连接，就可以确保所有的商品都包含在结果集中。凡是不存在的数值，都设置为0，然后再筛选一下，把销售、进货、返厂都是0的商品去掉，这样就能得到我们最终希望的查询结果：2020年12月的商品销售数量、进货数量和返厂数量。</p><p>代码如下所示：</p><pre><code>mysql&gt; SELECT\n-&gt; a.itemnumber,\n-&gt; a.goodsname,\n-&gt; ifnull(b.quantity,0) as salesquantity,    -- 如果没有销售记录，销售数量设置为0\n-&gt; ifnull(c.quantity,0) as importquantity,   -- 如果没有进货，进货数量设为0\n-&gt; ifnull(d.quantity,0) as returnquantity    -- 如果没有返厂，返厂数量设为0\n-&gt; FROM\n-&gt; demo.goodsmaster a               -- 商品信息表放在左边进行左连接，确保所有的商品都包含在结果集中\n-&gt; LEFT JOIN demo.mysales b\n-&gt; ON (a.itemnumber=b.itemnumber)\n-&gt; LEFT JOIN demo.myimport c\n-&gt; ON (a.itemnumber=c.itemnumber)\n-&gt; LEFT JOIN demo.myreturn d\n-&gt; ON (a.itemnumber=d.itemnumber)\n-&gt; HAVING salesquantity&gt;0 OR importquantity&gt;0 OR returnquantity&gt;0; -- 在结果集中剔除没有销售，没有进货，也没有返厂的商品\n+------------+-----------+---------------+----------------+----------------+\n| itemnumber | goodsname | salesquantity | importquantity | returnquantity |\n+------------+-----------+---------------+----------------+----------------+\n| 1 | 书 | 5.000 | 5.000 | 2.000 |\n| 2 | 笔 | 5.000 | 5.000 | 1.000 |\n| 3 | 橡皮 | 0.000 | 8.000 | 1.000 |\n+------------+-----------+---------------+----------------+----------------+\n3 rows in set (0.00 sec)\n</code></pre><p>总之，通过临时表，我们就可以把一个复杂的问题拆分成很多个前后关联的步骤，把中间的运行结果存储起来，用于之后的查询。这样一来，就把面向集合的SQL查询变成了面向过程的编程模式，大大降低了难度。</p><h2>内存临时表和磁盘临时表</h2><p>由于采用的存储方式不同，临时表也可分为内存临时表和磁盘临时表，它们有着各自的优缺点，下面我来解释下。</p><p>关于内存临时表，有一点你要注意的是，你可以通过指定引擎类型（比如ENGINE=MEMORY），来告诉MySQL临时表存储在内存中。</p><p>好了，现在我们先来创建一个内存中的临时表：</p><pre><code>mysql&gt; CREATE TEMPORARY TABLE demo.mytrans\n-&gt; (\n-&gt; itemnumber int,\n-&gt; groupnumber int,\n-&gt; branchnumber int\n-&gt; ) ENGINE = MEMORY; （临时表数据存在内存中）\nQuery OK, 0 rows affected (0.00 sec)\n</code></pre><p>接下来，我们在磁盘上创建一个同样结构的临时表。在磁盘上创建临时表时，只要我们不指定存储引擎，MySQL会默认存储引擎是InnoDB，并且把表存放在磁盘上。</p><pre><code>mysql&gt; CREATE TEMPORARY TABLE demo.mytransdisk\n-&gt; (\n-&gt; itemnumber int,\n-&gt; groupnumber int,\n-&gt; branchnumber int\n-&gt; );\nQuery OK, 0 rows affected (0.00 sec)\n</code></pre><p>现在，我们向刚刚的两张表里都插入同样数量的记录，然后再分别做一个查询：</p><pre><code>mysql&gt; SELECT COUNT(*) FROM demo.mytrans;\n+----------+\n| count(*) |\n+----------+\n| 4355 |\n+----------+\n1 row in set (0.00 sec)\n \nmysql&gt; SELECT COUNT(*) FROM demo.mytransdisk;\n+----------+\n| count(*) |\n+----------+\n| 4355 |\n+----------+\n1 row in set (0.21 sec)\n</code></pre><p>可以看到，区别是比较明显的。对于同一条查询，内存中的临时表执行时间不到10毫秒，而磁盘上的表却用掉了210毫秒。显然，内存中的临时表查询速度更快。</p><p>不过，内存中的临时表也有缺陷。因为数据完全在内存中，所以，一旦断电，数据就消失了，无法找回。不过临时表只保存中间结果，所以还是可以用的。</p><p>我画了一张图，汇总了内存临时表和磁盘临时表的优缺点：</p><p><img src=\"https://static001.geekbang.org/resource/image/c5/bf/c5f3d549f5f0fd72e74ec9c5441467bf.jpeg?wh=1781*462\" alt=\"\"></p><h2>总结</h2><p>这节课，我们学习了临时表的概念，以及使用临时表来存储中间结果以拆分复杂查询的方法。临时表可以存储在磁盘中，也可以通过指定引擎的办法存储在内存中，以加快存取速度。</p><p>其实，临时表有很多好处，除了可以帮助我们把复杂的SQL查询拆分成多个简单的SQL查询，而且，因为临时表是连接隔离的，不同的连接可以使用相同的临时表名称，相互之间不会受到影响。除此之外，临时表会在连接结束的时候自动删除，不会占用磁盘空间。</p><p>当然，临时表也有不足，比如会挤占空间。我建议你，<strong>在使用临时表的时候，要从简化查询和挤占资源两个方面综合考虑，既不能过度加重系统的负担，同时又能够通过存储中间结果，最大限度地简化查询</strong>。</p><h2>思考题</h2><p>我们有这样的一个销售流水表：</p><p><img src=\"https://static001.geekbang.org/resource/image/a9/b6/a970618a3807cyyeeaf28ac57fa034b6.jpeg?wh=1458*522\" alt=\"\"></p><p>假设有多个门店，每个门店有多台收款机，每台收款机销售多种商品，请问如何查询每个门店、每台收款机的销售金额占所属门店的销售金额的比率呢？</p><p>欢迎在留言区写下你的思考和答案，我们一起交流讨论。如果你觉得今天的内容对你有所帮助，欢迎你把它分享给你的朋友或同事，我们下节课见。</p>","neighbors":{"left":{"article_title":"12 | 事务：怎么确保关联操作正确执行？","id":357322},"right":{"article_title":"14 | 视图：如何简化查询？","id":359702}},"comments":[{"had_liked":false,"id":289363,"user_name":"朱晓峰","can_delete":false,"product_type":"c1","uid":2356905,"ip_address":"","ucode":"D2F84F44329C29","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLZKoB7sooIiaCHqcdNGI97WI3ZJLJph4mibIiat1qRvrBmkicZTEYvyT5iax1vlLFFgk2xgUibmnWvkicWA/132","comment_is_top":true,"comment_ctime":1618989477,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"9.2233720513586995e+18","product_id":100073201,"comment_content":"你好，我是朱晓峰，下面我就来公布一下上节课思考题的答案：<br><br>上节课，我们学习了事务。下面是思考题的答案：<br><br>这种说法是不对的，事务会确保事务处理中的操作要么全部执行，要么全部不执行，执行中遇到错误，是继续还是回滚，则需要程序员来处理。","like_count":3},{"had_liked":false,"id":286871,"user_name":"undefined","can_delete":false,"product_type":"c1","uid":1100750,"ip_address":"","ucode":"768098DBDBE333","user_header":"https://static001.geekbang.org/account/avatar/00/10/cb/ce/d9e00eb5.jpg","comment_is_top":false,"comment_ctime":1617644197,"is_pvip":false,"replies":[{"id":"106378","content":"临时表的执行效率比较低，数据量大的话，可以考虑其他的方式，比如把中间结果保存在数组中","user_name":"作者回复","user_name_real":"朱晓峰","uid":"2356905","ctime":1621499270,"ip_address":"","comment_id":286871,"utype":1}],"discussion_count":2,"race_medal":0,"score":"35977382565","product_id":100073201,"comment_content":"据了解，临时表的开销很大，不建议在高访问量的线上系统中使用。离线备份库或供数据分析所用的数据库上可以考虑有限制的使用。","like_count":9,"discussions":[{"author":{"id":2356905,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLZKoB7sooIiaCHqcdNGI97WI3ZJLJph4mibIiat1qRvrBmkicZTEYvyT5iax1vlLFFgk2xgUibmnWvkicWA/132","nickname":"朱晓峰","note":"","ucode":"D2F84F44329C29","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":518114,"discussion_content":"临时表的执行效率比较低，数据量大的话，可以考虑其他的方式，比如把中间结果保存在数组中","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621499270,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1201022,"avatar":"https://static001.geekbang.org/account/avatar/00/12/53/7e/b6829040.jpg","nickname":"SevenMonths","note":"","ucode":"62A9740FBD1FAE","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":391524,"discussion_content":"之前就用过把中间数据存储到数组中。\n业务场景是：数据都是通过微服务提供接口进行查询的，甚至要从不同的微服务拿到不同的数据去拼接组合，只能是把各自的数据放到数组然后逻辑拼装组合","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630496470,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":288848,"user_name":"一步","can_delete":false,"product_type":"c1","uid":1005391,"ip_address":"","ucode":"73CEA468CE70C3","user_header":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","comment_is_top":false,"comment_ctime":1618728996,"is_pvip":true,"replies":[{"id":"106445","content":"只要连接关闭，临时表就会被删除。","user_name":"作者回复","user_name_real":"朱晓峰","uid":"2356905","ctime":1621560624,"ip_address":"","comment_id":288848,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14503630884","product_id":100073201,"comment_content":"对于连接池，连接使用完不会销毁，使用完后会放到连接池中。那使用该连接创建临时表是没有被销毁，会不会影响后面再次从连接池取出该连接使用的情况？","like_count":4,"discussions":[{"author":{"id":2356905,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLZKoB7sooIiaCHqcdNGI97WI3ZJLJph4mibIiat1qRvrBmkicZTEYvyT5iax1vlLFFgk2xgUibmnWvkicWA/132","nickname":"朱晓峰","note":"","ucode":"D2F84F44329C29","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":518748,"discussion_content":"只要连接关闭，临时表就会被删除。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621560624,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":286886,"user_name":"giteebravo","can_delete":false,"product_type":"c1","uid":1005290,"ip_address":"","ucode":"C087E8D6B5A98B","user_header":"https://static001.geekbang.org/account/avatar/00/0f/56/ea/32608c44.jpg","comment_is_top":false,"comment_ctime":1617669822,"is_pvip":false,"replies":[{"id":"106380","content":"如果用WHERE，会提示筛选条件中的字段不存在。而HAVING是生成结果集后进行筛选，所以可以用重命名之后的字段名进行筛选","user_name":"作者回复","user_name_real":"朱晓峰","uid":"2356905","ctime":1621500771,"ip_address":"","comment_id":286886,"utype":1}],"discussion_count":5,"race_medal":1,"score":"14502571710","product_id":100073201,"comment_content":"<br>最后左连接的代码中，为什么要使用 having 而不使用 where 呢？<br>","like_count":3,"discussions":[{"author":{"id":2340158,"avatar":"https://static001.geekbang.org/account/avatar/00/23/b5/3e/fa542011.jpg","nickname":"源","note":"","ucode":"A860688E14BAD9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":371153,"discussion_content":"而且用了HAVING为什么可以不用GROUP BY呢？","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1619665927,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1862885,"avatar":"","nickname":"杨丽南","note":"","ucode":"51B9926D6BE429","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2340158,"avatar":"https://static001.geekbang.org/account/avatar/00/23/b5/3e/fa542011.jpg","nickname":"源","note":"","ucode":"A860688E14BAD9","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":379730,"discussion_content":"同问","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1624095445,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":371153,"ip_address":""},"score":379730,"extra":""},{"author":{"id":1201022,"avatar":"https://static001.geekbang.org/account/avatar/00/12/53/7e/b6829040.jpg","nickname":"SevenMonths","note":"","ucode":"62A9740FBD1FAE","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":2340158,"avatar":"https://static001.geekbang.org/account/avatar/00/23/b5/3e/fa542011.jpg","nickname":"源","note":"","ucode":"A860688E14BAD9","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":391525,"discussion_content":"如果不使用 GROUP BY 子句，则 HAVING 的行为与 WHERE 子句一样。\n其实用where也是可以处理的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630496809,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":371153,"ip_address":""},"score":391525,"extra":""}]},{"author":{"id":2356905,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLZKoB7sooIiaCHqcdNGI97WI3ZJLJph4mibIiat1qRvrBmkicZTEYvyT5iax1vlLFFgk2xgUibmnWvkicWA/132","nickname":"朱晓峰","note":"","ucode":"D2F84F44329C29","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":518120,"discussion_content":"如果用WHERE，会提示筛选条件中的字段不存在。而HAVING是生成结果集后进行筛选，所以可以用重命名之后的字段名进行筛选","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1621500771,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2653332,"avatar":"https://static001.geekbang.org/account/avatar/00/28/7c/94/2835e065.jpg","nickname":"epikomos","note":"","ucode":"807F29251C1CFE","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":389022,"discussion_content":"同问","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1629095559,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":286989,"user_name":"星空下","can_delete":false,"product_type":"c1","uid":1183639,"ip_address":"","ucode":"473643B567674A","user_header":"https://static001.geekbang.org/account/avatar/00/12/0f/97/372d8628.jpg","comment_is_top":false,"comment_ctime":1617718326,"is_pvip":false,"replies":[{"id":"106383","content":"如果是小项目，数据库资源充足，可以使用","user_name":"作者回复","user_name_real":"朱晓峰","uid":"2356905","ctime":1621501272,"ip_address":"","comment_id":286989,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10207652918","product_id":100073201,"comment_content":"数据库一般是性能瓶颈点，用临时表太占用数据库资源吧","like_count":2,"discussions":[{"author":{"id":2356905,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLZKoB7sooIiaCHqcdNGI97WI3ZJLJph4mibIiat1qRvrBmkicZTEYvyT5iax1vlLFFgk2xgUibmnWvkicWA/132","nickname":"朱晓峰","note":"","ucode":"D2F84F44329C29","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":518155,"discussion_content":"如果是小项目，数据库资源充足，可以使用","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1621501272,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":286890,"user_name":"洛奇","can_delete":false,"product_type":"c1","uid":1624355,"ip_address":"","ucode":"662B4005721119","user_header":"https://static001.geekbang.org/account/avatar/00/18/c9/23/76511858.jpg","comment_is_top":false,"comment_ctime":1617670482,"is_pvip":false,"replies":[{"id":"106382","content":"是的，断电的话连接中断，无法找回数据了。主要问题还是占用内存空间。","user_name":"作者回复","user_name_real":"朱晓峰","uid":"2356905","ctime":1621501184,"ip_address":"","comment_id":286890,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10207605074","product_id":100073201,"comment_content":"临时表的数据是不是易丢失，这不重要吧？断电后，连接也断了，这时候有去找回临时表的数据的必要吗？","like_count":2,"discussions":[{"author":{"id":2356905,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLZKoB7sooIiaCHqcdNGI97WI3ZJLJph4mibIiat1qRvrBmkicZTEYvyT5iax1vlLFFgk2xgUibmnWvkicWA/132","nickname":"朱晓峰","note":"","ucode":"D2F84F44329C29","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":518123,"discussion_content":"是的，断电的话连接中断，无法找回数据了。主要问题还是占用内存空间。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621501184,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":286887,"user_name":"giteebravo","can_delete":false,"product_type":"c1","uid":1005290,"ip_address":"","ucode":"C087E8D6B5A98B","user_header":"https://static001.geekbang.org/account/avatar/00/0f/56/ea/32608c44.jpg","comment_is_top":false,"comment_ctime":1617669848,"is_pvip":false,"replies":[{"id":"106381","content":"是的，会存储在内存中。","user_name":"作者回复","user_name_real":"朱晓峰","uid":"2356905","ctime":1621500838,"ip_address":"","comment_id":286887,"utype":1}],"discussion_count":2,"race_medal":1,"score":"5912637144","product_id":100073201,"comment_content":"<br>当引擎类型为 memory 时，如果去掉 temporary 那么表还会存储在内存中吗？<br>","like_count":1,"discussions":[{"author":{"id":2356905,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLZKoB7sooIiaCHqcdNGI97WI3ZJLJph4mibIiat1qRvrBmkicZTEYvyT5iax1vlLFFgk2xgUibmnWvkicWA/132","nickname":"朱晓峰","note":"","ucode":"D2F84F44329C29","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":518121,"discussion_content":"是的，会存储在内存中。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621500838,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1005391,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","nickname":"一步","note":"","ucode":"73CEA468CE70C3","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":368813,"discussion_content":"会的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618838080,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":343597,"user_name":"豆豆酱","can_delete":false,"product_type":"c1","uid":2539241,"ip_address":"","ucode":"1F321F2DF51DC5","user_header":"https://static001.geekbang.org/account/avatar/00/26/be/e9/9d597e04.jpg","comment_is_top":false,"comment_ctime":1650946385,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1650946385","product_id":100073201,"comment_content":"临时表不是有内存和磁盘两种么？对于磁盘，应该是永久储存吧，那么连接断开的话，磁盘的临时表也会被删除么？","like_count":0,"discussions":[{"author":{"id":1324550,"avatar":"https://static001.geekbang.org/account/avatar/00/14/36/06/08c46bcd.jpg","nickname":"聂利","note":"","ucode":"808E064089724D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":588306,"discussion_content":"会话存在的时间，数据是存在磁盘上，会话断开，表和数据也删了\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1663659200,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":319774,"user_name":"Geek_8e65ed","can_delete":false,"product_type":"c1","uid":1716374,"ip_address":"","ucode":"FB20872B0C1967","user_header":"","comment_is_top":false,"comment_ctime":1635936427,"is_pvip":false,"replies":[{"id":"116472","content":"☺","user_name":"作者回复","user_name_real":"朱晓峰","uid":"2356905","ctime":1636616920,"ip_address":"","comment_id":319774,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1635936427","product_id":100073201,"comment_content":"🐂🍺","like_count":0,"discussions":[{"author":{"id":2356905,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLZKoB7sooIiaCHqcdNGI97WI3ZJLJph4mibIiat1qRvrBmkicZTEYvyT5iax1vlLFFgk2xgUibmnWvkicWA/132","nickname":"朱晓峰","note":"","ucode":"D2F84F44329C29","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":529765,"discussion_content":"☺","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1636616920,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":313094,"user_name":"彭彬","can_delete":false,"product_type":"c1","uid":2680555,"ip_address":"","ucode":"5AF4F4D7163DFE","user_header":"https://static001.geekbang.org/account/avatar/00/28/e6/eb/7b7c0101.jpg","comment_is_top":false,"comment_ctime":1632277312,"is_pvip":false,"replies":[{"id":"116480","content":"可以的","user_name":"作者回复","user_name_real":"朱晓峰","uid":"2356905","ctime":1636622395,"ip_address":"","comment_id":313094,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1632277312","product_id":100073201,"comment_content":"请问老师：数据量大时，临时表能否建立索引？","like_count":0,"discussions":[{"author":{"id":2356905,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLZKoB7sooIiaCHqcdNGI97WI3ZJLJph4mibIiat1qRvrBmkicZTEYvyT5iax1vlLFFgk2xgUibmnWvkicWA/132","nickname":"朱晓峰","note":"","ucode":"D2F84F44329C29","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527225,"discussion_content":"可以的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1636622395,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":309718,"user_name":"马球先生","can_delete":false,"product_type":"c1","uid":1119609,"ip_address":"","ucode":"858C2CE0E494C5","user_header":"https://static001.geekbang.org/account/avatar/00/11/15/79/efde2a69.jpg","comment_is_top":false,"comment_ctime":1630312549,"is_pvip":false,"replies":[{"id":"113732","content":"可以的<br>","user_name":"作者回复","user_name_real":"朱晓峰","uid":"2356905","ctime":1632797763,"ip_address":"","comment_id":309718,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1630312549","product_id":100073201,"comment_content":"筛选条件写成这样可否？where 替代 having<br>SELECT<br>\ta.itemnumber,<br>\ta.goodsname,<br>\tifnull(b.quantity,0) as salesquantity,<br>\tifnull(c.quantity,0) as importquantity,<br>\tifnull(d.quantity,0) as returnquantity<br>FROM<br>\tdemo.goodsmaster a<br>LEFT JOIN demo.mysales b<br>\tON (a.itemnumber=b.itemnumber)<br>LEFT JOIN demo.myimport c<br>\tON (a.itemnumber=c.itemnumber)<br>LEFT JOIN demo.myreturn d<br>\tON (a.itemnumber=d.itemnumber)<br>WHERE b.quantity &gt; 0 OR c.quantity &gt; 0 OR d.quantity &gt; 0;","like_count":0,"discussions":[{"author":{"id":2356905,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLZKoB7sooIiaCHqcdNGI97WI3ZJLJph4mibIiat1qRvrBmkicZTEYvyT5iax1vlLFFgk2xgUibmnWvkicWA/132","nickname":"朱晓峰","note":"","ucode":"D2F84F44329C29","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":525978,"discussion_content":"可以的\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632797763,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":295350,"user_name":"单色","can_delete":false,"product_type":"c1","uid":1907486,"ip_address":"","ucode":"A1DA6E497FD74C","user_header":"https://static001.geekbang.org/account/avatar/00/1d/1b/1e/f5c16f7e.jpg","comment_is_top":false,"comment_ctime":1622379555,"is_pvip":false,"replies":[{"id":"107691","content":"1. 非常感谢你的细心阅读，返厂价格&#47;金额字段名的拼写确实是错了，已经要求后台更正。<br>2. 客户的要求是查询某个特定时段的数据，为了简便，文稿中的演示数据正好在这个时段中，所以不需要用单头数据中的验收时间字段进行筛选，但实际上，数据一般不会正好在客户需要的区间，所以一般都会用到单头表与明细表的关联","user_name":"作者回复","user_name_real":"朱晓峰","uid":"2356905","ctime":1623056469,"ip_address":"","comment_id":295350,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1622379555","product_id":100073201,"comment_content":"1、返厂单明细表图片中，返厂价格&#47;金额字段名有误。<br>2、进货&#47;返厂信息临时表中，查询字段仅存在于一个表里。为何用了JOIN 链接，可以不用吗，还是说有其他考虑？望老师解答","like_count":0,"discussions":[{"author":{"id":2356905,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLZKoB7sooIiaCHqcdNGI97WI3ZJLJph4mibIiat1qRvrBmkicZTEYvyT5iax1vlLFFgk2xgUibmnWvkicWA/132","nickname":"朱晓峰","note":"","ucode":"D2F84F44329C29","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":521044,"discussion_content":"1. 非常感谢你的细心阅读，返厂价格/金额字段名的拼写确实是错了，已经要求后台更正。\n2. 客户的要求是查询某个特定时段的数据，为了简便，文稿中的演示数据正好在这个时段中，所以不需要用单头数据中的验收时间字段进行筛选，但实际上，数据一般不会正好在客户需要的区间，所以一般都会用到单头表与明细表的关联","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1623056469,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":292209,"user_name":"菜鸟🐤要先飞","can_delete":false,"product_type":"c1","uid":1202379,"ip_address":"","ucode":"56668DB891F7BC","user_header":"https://static001.geekbang.org/account/avatar/00/12/58/cb/daf94c0e.jpg","comment_is_top":false,"comment_ctime":1620721507,"is_pvip":false,"replies":[{"id":"106533","content":"请参考思考题答案","user_name":"作者回复","user_name_real":"朱晓峰","uid":"2356905","ctime":1621566988,"ip_address":"","comment_id":292209,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1620721507","product_id":100073201,"comment_content":"## 创建门店销售额临时表<br>create temporary table branchsales<br>select branchnumber,sum(salesvalue) as salesvalue  from transdetails group by branchnumber;<br><br>## 创建每个门店各自收款机销售额的临时表<br>create temporary table cashiernumber<br>select branchnumber,cashiernumber, salesvalue as salesvalue from transdetails group by branchnumber,cashiernumber;<br><br>计算占比：<br>select a.branchnumber,b.cashiernumber,  b.salesvalue&#47;a.salesvalue as &#39;占比&#39; from branchsales as a join cashiernumber as b on(a.branchnumber = b.branchnumber);<br>","like_count":0,"discussions":[{"author":{"id":2356905,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLZKoB7sooIiaCHqcdNGI97WI3ZJLJph4mibIiat1qRvrBmkicZTEYvyT5iax1vlLFFgk2xgUibmnWvkicWA/132","nickname":"朱晓峰","note":"","ucode":"D2F84F44329C29","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":519730,"discussion_content":"请参考思考题答案","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621566988,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":286998,"user_name":"lesserror","can_delete":false,"product_type":"c1","uid":1351076,"ip_address":"","ucode":"25A54D1165FCF6","user_header":"https://static001.geekbang.org/account/avatar/00/14/9d/a4/e481ae48.jpg","comment_is_top":false,"comment_ctime":1617720244,"is_pvip":false,"replies":[{"id":"106384","content":"好的<br>","user_name":"作者回复","user_name_real":"朱晓峰","uid":"2356905","ctime":1621501288,"ip_address":"","comment_id":286998,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1617720244","product_id":100073201,"comment_content":"之前对临时表的认识停留在对系统性能开销大的理解上。<br><br>开发中也没有尝试过使用临时表。看了这节内容，对临时表如何存储中间结果来简化查询有了一定的认识。<br><br>之后开发中如果有适合临时表的场景，会来再来看看这篇的内容。并分享一下使用心得。","like_count":0,"discussions":[{"author":{"id":2356905,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLZKoB7sooIiaCHqcdNGI97WI3ZJLJph4mibIiat1qRvrBmkicZTEYvyT5iax1vlLFFgk2xgUibmnWvkicWA/132","nickname":"朱晓峰","note":"","ucode":"D2F84F44329C29","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":518158,"discussion_content":"好的\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621501288,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}