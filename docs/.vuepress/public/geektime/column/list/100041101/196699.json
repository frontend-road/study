{"id":196699,"title":"33 | 服务效率提升：如何降低公司运营成本？","content":"<p>你好，我是庄振运。</p><p>我们都知道，支持大量用户的互联网公司，通常会部署相当规模的系统容量来运行各种服务。</p><p>如果你想要有效地运行业务，就应使业务的<strong>容量需求</strong>和<strong>容量供应</strong>尽可能地相等。为什么这么说呢？如果容量供应不能满足需求，那么部分业务将​​因容量不足，不能部署或扩展。如果容量供应过多，那么公司基础设施的效率就降低了。</p><p>服务效率与业务的容量和公司预算直接相关。因此，<strong>提高服务效率</strong>和<strong>适当地预测容量需求</strong>，对于公司的持续成功至关重要。</p><p>那么如何才能降低公司的服务容量需求呢？这就需要<strong>运行的服务尽量高效</strong>，提高服务效率将会帮助降低容量的需求。</p><p>今天我就为你介绍八种提升服务效率的途径和相关的生产经验，以及提升执行服务效率的原则，希望对你有所启发。</p><h2>服务效率提升的途径和类别</h2><p>当各个服务团队的领导和技术骨干下定决心，要花时间在服务效率的时候，经常提出的问题是：<span class=\"orange\">怎么样做才能提高服务效率呢？</span></p><p>要回答这个问题，你就必须先搞清楚一个问题，就是——什么类型的工作才是提升服务效率的工作？</p><p>我多年来帮助很多不同的服务提升了服务效率；在这个过程中我逐渐意识到，一个公司的服务千差万别，可以提升效率的方式也是多种多样。但核心的一点是：任何能够让这个服务降低容量需求的工作，都是服务效率提升的工作。</p><!-- [[[read_end]]] --><p>我把各种各样的服务效率提升工作分为八类：软件效率（Software Efficiency）、服务架构效率（Service Architecture Efficiency）、服务部署效率（Service Deployment Efficiency）、跨平台效率（Cross-platform Efficiency）、硬件效率（Hardware Efficiency）、容量组织效率（Capacity Orgnization Efficiency）、容量资源回收（Capacity Resource Reclamation）、用户效率（User Efficiency）等。</p><p>这八种效率大体上分为两组：<strong>软件服务</strong>和<strong>非软件容量</strong>。</p><p><img src=\"https://static001.geekbang.org/resource/image/5f/e4/5fc0143c23b5a34e8742e761ec547ee4.png?wh=1920*1080\" alt=\"\"></p><p>对每一种服务效率，我先讲基本概念，然后再用具体例子来诠释，希望可以给你些启发。</p><h3>1.软件效率</h3><p>服务的软件程序实现千差万别，但不管哪种实现，它总是可以优化的，比如通过采用更好的数据结构和语言库等等。这方面的效率提升，都可以归类为软件效率。</p><p>软件方面的效率提升比较直白，就是把程序的性能提高。比如减少CPU和内存的使用等等；这方面我们这个专栏前面讲了很多，多数内容都可以归到这方面。</p><h3>2.服务架构效率</h3><p>对一种服务而言，如果能够改进服务的实现架构，比如重新整合了内部的微服务，从而变得更高效，那么就是服务架构的效率提升。</p><p>服务架构的效率又可以分为两种：一种是单独的一个服务，通过进行服务设计的优化来提高效率；另外一种就是通过合理借助其他服务来优化。</p><p>比如一个数据库服务，如果有很多的查询请求，那么采用另外一个缓存服务，就或许可以大幅度地降低数据库服务的资源消耗。如果两个服务（数据库和缓存）的资源使用总和，还是小于仅仅使用数据库（而没有缓存服务）的资源使用，那么这两种服务的结合就是一种更加高效的服务架构。</p><h3>3.服务部署效率</h3><p>一个服务的软件程序总是要部署到硬件容量上。生产实践中，如何部署软件也很重要，也会对服务效率产生影响。比如采用什么操作系统，进行什么样的系统和软件配置，要不要采用NUMA绑定等。这些方面的优化都可以算是服务部署方面的效率提升。</p><p>还记得我们在<a href=\"https://time.geekbang.org/column/article/189200\">第22讲</a>讲过的“使用内存大页面，来装载程序的热文本区域”吗？这其实就是一项服务部署的优化，就是通过提高系统和程序iTLB命中率，从而达到更高的服务效率。</p><h3>4.跨平台效率</h3><p>如果一个公司（尤其是后端）同时提供几种服务平台，提供的功能有重合，而且服务效率不同，那么用户可以迁移到效率更高的服务上去。这种迁移就是跨平台效率提升。</p><p>一个互联网公司，随着时间的推移和规模的增长，内部往往有很多种服务提供重叠的功能。一个明显的例子是数据存储，经常有很多服务都可以提供数据存储的功能。虽然每种存储服务提供的功能并不完全一样，但对于一个要使用存储服务的用户来说，经常同时会有好几个选择。</p><p>这种情况下，这个需要存储的用户，就可以考虑每种存储服务的服务效率；在满足所需功能的前提下，选择一种高效的服务，会帮助公司降低成本。</p><p>对于一个已经在使用某种服务的用户而言，可以重新考虑各种可用服务的效率；如果另外一种服务更加高效，就可以考虑迁移过去。这种操作就是<strong>跨平台的迁移</strong>，其结果也是能够提升公司的服务效率的。</p><p>我最近几年做过很多这方面的优化。比如曾经把一个用户的数据从一个低效的存储服务，整体转移到另外一个高效的存储服务，从而大幅度地降低了公司的容量和运营成本，节省了大约几千万美元。重要的是，用户的端到端性能并没有收到影响。</p><h3>5.硬件效率</h3><p>一个服务会使用各种容量资源（比如CPU）。所以，根据资源使用最大瓶颈的不同，采用不同种的服务器硬件，也会导致不同的服务效率。比如，假设一个服务的存储是最大瓶颈时，那么采用相对较大存储的服务器，结果就会比较高效。</p><p>我就提升过一个存储服务的硬件效率。该服务受到存储空间的限制，并且近年来增长迅速。我评估后得出的结论是，如果这个服务继续快速地增长，公司很快就没有足够的容量来提供给它。</p><p>所以我们决定，通过提升服务效率来减少服务的容量需求。在检查了所有效率提升的方式后，我决定首先提升硬件效率。 具体来说，我们采用了一种新型服务器，这种服务器相对旧的服务器而言，有较大存储容量，并逐步部署。</p><p>下图分别显示了服务的容量规模（也就是服务器的数目），和已部署的总存储容量。</p><p><img src=\"https://static001.geekbang.org/resource/image/38/05/3897e6d4f7862781ec80e4b26e281905.png?wh=2500*1431\" alt=\"\"></p><p><img src=\"https://static001.geekbang.org/resource/image/7d/2e/7de61e4513c9eb1891493af8647d312e.png?wh=2500*1475\" alt=\"\"></p><p>在20天的时间内，我们将服务迁移到新的硬件类型，服务器的数目减少了5％，而存储容量增加了11％。值得一提的是，新旧服务器的单位服务器成本差别不大，所以整个服务的效率得到了很好的提升。</p><h3>6.容量组织效率</h3><p>一个互联网服务在使用数据中心提供的容量时候，一般都是用某种方式把容量（比如服务器）组织在一起，形成一个容量单位。比如把服务器分组、组成集群等。这种容量组织的方式，也可以根据服务的特点，进行调整优化，从而变得更高效，这就是容量组织效率。</p><p>一个规模很大的服务可能会需要很多容量。我曾经合作的一个后台服务，就使用了几十万台服务器。这么多服务器经常会分成几个容量单元，这样做当然有利有弊，但都是经过各种考虑的决定。有时候服务容量的分割也有历史的原因，比如一开始使用一个容量单元，但是随着服务的规模不断扩大，就建立了一个又一个的容量单元。</p><p>分成几个容量单元的一个好处，是降低了容量操作的复杂度。不过也有坏处，其中之一就是资源效率使用率不会特别高，因为不同容量之间的资源不能互补。比如两个容量单元，每个有一千台服务器。一个容量单元是CPU吃紧，另外一个容量单元是内存吃紧。如果二者合并成一个容量单元，或许只需要一千五百台服务器就够了。</p><p>所以适度地优化容量组织，合并容量单元，就可以降低容量的需求，提高容量的效率。</p><h3>7.容量资源回收</h3><p>一个服务所使用的容量，随着时间的变化，有些容量（比如一些服务器）就会处于空闲状态。如果及时回收，从而进行容量的再利用，也可以提升服务效率。</p><p>一个服务从诞生到成熟，会不断地演化；表现在对容量的需求方面，也是不断变化的。可能有一段时期，部署的容量恰好满足服务的需求，容量的效率很高。但是过一段时间，服务的需求和资源使用特征发送了变化，有些容量和相对应的资源使用不再使用。这种情况下就需要进行容量和资源回收。</p><p>这方面一个最直白的表现，就是可能有些容量处在空闲状态。举几个例子，假如有些服务器已经不能运行此种服务了，那么就把这些服务器回收，给其他合适的服务用。又假如一个服务对存储资源的使用下降了，那么对应的存储资源就可以减少，分给别的服务用。</p><h3>8.用户效率</h3><p>使用服务的用户，如果采用合理的方式，也可以帮助提升所使用服务的效率。这方面的效率提升就是用户效率。</p><p>用户在使用服务时，可以尽量做到高效使用。我们曾经帮助一个存储服务提升效率，通过和客户合作，大幅度降低了客户的存储数据量。具体来说，这个客户以前是将数据对象的本来数据和一大堆元数据，都放到了存储服务上，这导致了相当大的物理数据存储。</p><p>我们是怎么提高用户效率的呢？我们首先分析了客户的业务逻辑和数据使用场景，意识到客户存储的目的，是判断数据对象是否已经更改。我们先将存储的数据分为两部分，然后分别存储对象的哈希（例如MD5），而不是对象本身。另外，我们把数据的TTL（生存时间）缩短，并在对象哈希中定期强制清除陈旧数据。</p><p>这样的优化工作取得了很好的效果，节省了93％的存储空间。具体来说，把客户数据大小从2.7PB，降到了0.2PB，如下图所示。</p><p><img src=\"https://static001.geekbang.org/resource/image/55/40/555309613ae7557ddc09718e23a5bf40.png?wh=2589*1643\" alt=\"\"></p><h2>执行服务效率提升的原则</h2><p>除了前面说过的八类服务效率提升方法，在提高服务效率的生产实践中，我也获得了许多执行方面的经验。这些经验对于如何在部门之间协调，有效地执行效率提升，完成预定的效率提升目标等方面，有比较好的指导作用，希望能对你有所帮助。</p><p>1.明确的所有权和承诺。</p><p>根据公司的规模，公司可能会有许多需要提高效率的服务。对于每个这样的服务，每个效率提升工作都需要有明确的拥有者团队，并且需要得到团队的工作承诺。如果不能明确所有者，或者所有者不能承诺完成的时间，那么最后经常会互相扯皮，互相指责，工作失败。</p><p>2.以效率目标为导向的计划和执行。</p><p>对于每个服务及其效率组件，要定期设定要实现的效率目标。例如，针对存储服务的效率目标可以是：“将明年的存储空间利用率从30％提高到40％”。但是注意，目标设定的频率和大小，必须适应服务的特征和团队的工作特点。</p><p>3.为每个效率组件部署检测工具。</p><p>你需要开发一定的工具，来监视整个服务和每个组件的效率水平，以便快速检测到异常。对于异常的效率降低，这些工具必须有自动触发或警报功能。有效的工具，能帮助你及时发现问题，并立即采取行动。</p><p>4.紧密的跨团队协作。</p><p>鉴于当今业务和服务的复杂性，许多服务效率的提高，都需要多个团队共同合作。例如，某个服务可能依赖其他服务，并且该服务的效率提高，也可能需要所依赖服务团队的协作。</p><p>5.公司范围内的协调。</p><p>尽管每个主要的独立服务，都可以通过采用我们提出的框架来独立工作，但也需要在公司范围内进行协调，因为公司需要保证总体业务的需求。</p><h2>总结</h2><p>互联网公司业务复杂，规模庞大，需要有大量的基础设施和容量去支撑。我们这一讲讨论了如何提升服务效率，降低容量需求，从而节省公司成本。</p><p><img src=\"https://static001.geekbang.org/resource/image/c3/35/c3e45332a08bcd75e5963ed5aec1e535.png?wh=2203*1679\" alt=\"\"></p><p>通常一个互联网服务的规模是不断增长的。开始的时候，或许你不在乎它的服务效率和系统容量，但是很快你就需要重视了。所以，你最好未雨绸缪，把相关工作定义好。正如唐朝诗人杜荀鹤的一首《小松》，有两句说：“时人不识凌云木，直待凌云始道高。”如果公司业务发展快，它的服务规模增长也很快，那么服务效率提升的工作就会越发重要。</p><p>我通过多年的容量规划和服务效率提升工作，积累了大量的服务效率优化的知识，今天的分享，希望能帮你开拓思路，提供经验。</p><h2>思考题</h2><p>提升一个互联网服务的效率有很多种方式，其中一个是服务软件的效率。我们前面几讲提到了很多性能优化的工作。你能举出几个可以归类于软件效率提升的例子吗？ 提示一下，优化代码算不算是提升服务软件的效率？</p><p>欢迎你在留言区分享自己的思考，与我和其他同学一起讨论，也欢迎你把文章分享给自己的朋友。</p>","neighbors":{"left":{"article_title":"32 | 服务的容量规划：怎样才能做到有备无患？","id":195572},"right":{"article_title":"34 | 服务需求控制管理：每种需求都是必需的吗？","id":197421}},"comments":[{"had_liked":false,"id":187889,"user_name":"钱","can_delete":false,"product_type":"c1","uid":1009652,"ip_address":"","ucode":"2C92A243A463D4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg","comment_is_top":false,"comment_ctime":1584266202,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5879233498","product_id":100041101,"comment_content":"不是大公司没有规模效应，倒腾机器的成本肯定不如租赁，就算是大公司，这些容量规划、机器利用率的事情，业务研发能插手的也主要集中在代码逻辑优化、代码性能优化，各种机器都是没机会接触的最多就是有些操作页面。<br>术业有专攻吧!老师有机会做这一块精通这一块自然理解深刻，我能意识到她的重要性，在思考问题时也会训练自己性能、效率、成本的意识，涨涨见识!","like_count":1},{"had_liked":false,"id":177316,"user_name":"我来也","can_delete":false,"product_type":"c1","uid":1205253,"ip_address":"","ucode":"773D6104F56767","user_header":"https://static001.geekbang.org/account/avatar/00/12/64/05/6989dce6.jpg","comment_is_top":false,"comment_ctime":1581346270,"is_pvip":false,"replies":[{"id":"68871","content":"对，一切决策都是因时而异的；随着公司和业务的反战，机器和人的成本对比也是不断变化的。<br>不过，有时候需要和老板&#47;公司算算帐，才会让大家比较清楚。另外就是也需要向老板证明，做性能和效率的确可以省钱；很多时候老板可能没有想到。","user_name":"作者回复","user_name_real":"zhenyun2010","uid":"1272838","ctime":1581392599,"ip_address":"","comment_id":177316,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5876313566","product_id":100041101,"comment_content":"羡慕老师能有这样的才能和机遇，能亲亲松松给公司降低几千万美金的成本！<br>中小型公司可能对效率不太重视，有些老板觉得堆机器比堆人划算。<br>这个也不可否认，毕竟要先做出个能用的东西，后面再走一步看一步吧。<br><br>但是对于工程师本身来说，我觉得还是应该精益求精。<br>未雨绸缪是一方面，对自己能力边界的探索更重要。","like_count":1,"discussions":[{"author":{"id":1272838,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/nicib8gqImzrCGJYyJW3QEmsvtDcfuLe02wm55HBdC2mAHt1mqc6wT7I9GHyByS19zQRBiaZx2EeXKnyvslCZd4tQ/132","nickname":"zhenyun2010","note":"","ucode":"567187932468D8","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":483389,"discussion_content":"对，一切决策都是因时而异的；随着公司和业务的反战，机器和人的成本对比也是不断变化的。\n不过，有时候需要和老板/公司算算帐，才会让大家比较清楚。另外就是也需要向老板证明，做性能和效率的确可以省钱；很多时候老板可能没有想到。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581392599,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":213614,"user_name":"benny","can_delete":false,"product_type":"c1","uid":1123043,"ip_address":"","ucode":"E2F30AF0C808D9","user_header":"https://static001.geekbang.org/account/avatar/00/11/22/e3/510b69f9.jpg","comment_is_top":false,"comment_ctime":1588492102,"is_pvip":false,"replies":[{"id":"81049","content":"一部分是相对不变的（Static），另外一部分相对容易变化（Dynamic）。 <br>因为我们的目的是存储监测数据是不是变化了，以前是把整个对象简单存储，差不多的对象也各有一份完整的Copy，占用大量空间。分成两部分就好多了。","user_name":"作者回复","user_name_real":"zhenyun2010","uid":"1272838","ctime":1590027150,"ip_address":"","comment_id":213614,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1588492102","product_id":100041101,"comment_content":"我们先将存储的数据分为两部分，然后分别存储对象的哈希（例如 MD5），而不是对象本身。另外，我们把数据的 TTL（生存时间）缩短，并在对象哈希中定期强制清除陈旧数据。   两部分分别是什么？可以再详细介绍一下这个案例吗?","like_count":0,"discussions":[{"author":{"id":1272838,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/nicib8gqImzrCGJYyJW3QEmsvtDcfuLe02wm55HBdC2mAHt1mqc6wT7I9GHyByS19zQRBiaZx2EeXKnyvslCZd4tQ/132","nickname":"zhenyun2010","note":"","ucode":"567187932468D8","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493828,"discussion_content":"一部分是相对不变的（Static），另外一部分相对容易变化（Dynamic）。 \n因为我们的目的是存储监测数据是不是变化了，以前是把整个对象简单存储，差不多的对象也各有一份完整的Copy，占用大量空间。分成两部分就好多了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590027150,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}