{"id":669873,"title":"30｜推荐系统的后处理及日志回采","content":"<p>你好，我是黄鸿波。</p><p>到现在，可以说我们已经把推荐系统从头到尾学习了一遍。这节课是最后一节正课内容，也就是推荐系统的后续处理和日志回采。</p><p>我把本节课分成了下面三个要点。</p><ol>\n<li>推荐列表给到用户后的操作。</li>\n<li>如何进行推荐系统的后处理。</li>\n<li>如何进行日志回采。</li>\n</ol><p>现在正式开始本节课的内容。</p><p></p><h2>推荐列表给到用户后的操作</h2><p>到现在推荐系统从最开始的数据到最终给到用户的推荐列表策略，都已经完成了。按理来说，已经跑完了整个流程，但站在推荐系统的角度，我们还需要确认用户是否对推荐进行了进一步的了解和行动，以及反馈他们的反应。</p><p>在推荐的后续步骤中，往往需要建立日志系统，记录用户的行为以及系统的运行状态，以便于对系统进行优化和监控，并做好用户反馈等工作。具体来说，主要有下面五个方面。</p><ol>\n<li><strong>建立日志系统</strong>：在推荐系统中建立日志系统来记录用户行为、推荐结果和系统运行状态，可以使用日志收集工具（如Logstash、FluentD等）。在建立日志系统时，需要考虑哪些数据需要记录，如用户ID、访问时间、推荐结果、点击次数等。</li>\n<li><strong>日志分析</strong>：使用数据分析工具（如Hadoop、Spark等）对日志数据进行分析，提取有用的信息，例如用户兴趣、推荐结果点击率等。</li>\n<li><strong>对结果影响评估</strong>：结合分析结果，评估用户行为对推荐结果的影响，发现可能出现的问题，例如推荐结果展现不足、推荐结果与用户兴趣不匹配等。</li>\n<li><strong>改进系统</strong>：针对问题做出改进，例如优化推荐算法、调整推荐策略等，以提高推荐结果的准确性和满意度。</li>\n<li><strong>监控系统</strong>：对系统进行监控，发现问题及时解决，提高系统的稳定性和推荐准确性。在监控过程中，可以使用运维工具（如Nagios、Zabbix等）对系统的运行情况进行实时监控，快速发现和解决问题。</li>\n</ol><!-- [[[read_end]]] --><p></p><h2>如何进行推荐系统的后处理</h2><p>我们来举例说明一下，在推荐系统中如何利用日志系统来改进推荐算法。</p><p>利用日志系统可以收集用户的行为数据（包括用户的点击、浏览、收藏、购买等行为），详细记录用户与推荐系统交互的过程。当拿到这些数据之后，需要对用户行为数据进行多维度的分析和建模，例如根据用户的年龄、性别、地理位置、历史购买记录等建立用户画像。我们也可以使用数据挖掘和机器学习等技术对这些数据进行多维分析和建模，从而对数据进行整体拆解。</p><p>当然，我们还可以通过提取一些关键特征来描述用户的行为习惯（例如点击率、购买频率、购买金额等），从而训练和改进推荐算法。</p><p>在收集用户信息时，一般会在推荐系统中内置统计功能，记录用户的行为数据并上传到服务器。在实际开发中可以使用Numpy、Pandas、Scikit-learn等数据处理常用库，配合TensorFlow或者PyTorch等深度学习方法来进行模型构建。这个过程中，可以使用大数据技术来实现日志处理和分析，以下是五个常用的技术和库。</p><ol>\n<li><strong>高性能分布式文件系统</strong>：可以使用分布式文件系统（如HDFS、AWS S3等），存储海量日志数据，方便高效地进行数据读取和处理。</li>\n<li><strong>高性能分布式数据处理框架</strong>：可以使用分布式计算框架（如Apache Spark、Hadoop MapReduce等），对海量的日志数据进行高效并行化处理。利用分布式计算框架可以通过并行计算的方式，高速安全地进行数据处理。</li>\n<li><strong>分布式数据库</strong>：使用分布式数据库（如Apache HBase、Amazon DynamoDB等），对处理后的日志信息存储和管理，方便进行数据查询、统计和分析。</li>\n<li><strong>分布式 Web 日志收集器</strong>：使用分布式日志采集技术（如Flume、Logstash、Grok等），将推荐系统的请求和响应日志收集到一个中心化的地方，并根据业务需求利用数据预处理和清洗技术将原始的日志转换为结构化数据，方便后续的自动化处理。</li>\n<li><strong>分布式机器学习平台</strong>：使用分布式机器学习平台（如Spark MLlib、Amazon SageMaker等），对海量的推荐系统日志数据进行机器学习建模和数据挖掘。通过并行计算和分布式训练模型，可以更快地实现算法的迭代和更新，达到更准确的结果。</li>\n</ol><p>通过使用上面技术和库，可以方便地对推荐系统的日志进行处理和分析，并实现数据存储、清洗、转换、机器学习建模等一系列操作。</p><h2>如何进行日志回采</h2><p>最后我们再来说说日志回采的问题。对于一个推荐系统而言，常见的日志可以分为原始日志、点击日志、会话日志、反馈行为日志四个类别。</p><ul>\n<li>原始日志是推荐系统最基础的日志，它包含了所有用户在系统中的行为记录，如浏览、搜索、购买等。</li>\n<li>点击日志是用户在推荐系统中进行点击的记录，包括点击的物品、时间、位置、IP地址等。</li>\n<li>会话日志是指用户在推荐系统中的会话记录，一次会话包括多个行为，通常是用户在一段时间内的连续操作。</li>\n<li>反馈行为日志包含用户对推荐结果的反馈记录，如喜欢、不喜欢、加入购物车等。</li>\n</ul><p>这些日志记录了用户的行为，可以用于优化推荐算法，提高系统的准确性和用户的参与度。同时对于推荐系统的评估和监控来说，这些日志也是非常重要的数据来源。</p><p>进行日志采集时，主要使用的方法是<strong>埋点技术</strong>和<strong>服务端日志采集</strong>。</p><h3>埋点技术</h3><p>埋点技术是指在应用程序中添加数据采集代码，以便收集和记录特定事件和活动的详细信息。每当应用程序执行特定操作时，采集代码会触发并生成一个日志记录，其中包含有关事件或活动的详细信息。</p><p>通过使用埋点技术，开发人员可以更轻松地诊断和解决问题，提高应用程序的稳定性和性能，同时还可以提供更好的用户体验。在数据分析和决策制定方面，通过分析采集的数据，企业可以更好地了解用户需求和行为，制定更有效的业务策略。</p><p>一般来讲，埋点通常被添加在客户端。首先，开发人员需要确定需要采集哪些数据，例如用户点击按钮、访问特定页面、触发某些事件等，然后在应用程序中添加代码，以便在触发特定操作时记录日志信息。此代码应该能够获取目标数据并将其存储到日志记录中。</p><p>当应用程序启动时，开发人员需要确保采集代码被正确注册，以确保在触发事件时，可以为其分配正确的代码。一旦采集代码被实现并注册，开发人员需要测试它是否正常工作。可以使用模拟数据以及开发人员工具进行测试，这一步我们称为埋点采集测试。开发人员需要收集输出的日志，以确保数据已正确采集。通过收集并分析日志，开发人员可以了解应用程序的运行情况，及时处理潜在的问题。</p><h3>服务端日志采集</h3><p>对于服务端来说，日志采集主要通过在Controller接口中进行埋点，然后通过AOP技术、Kafka消息等对用户的行为信息进行采集。</p><p>之所以使用AOP技术，是因为可以在不修改原有业务代码的情况下，将日志采集逻辑统一添加到共同的切点中，这样可以提高代码的可维护性和可扩展性。</p><p>而使用Kafka消息系统可以实现日志数据的异步发送，减少日志对系统性能的影响。同时，Kafka可以提供高可靠性的消息传输和消息存储功能，保证日志数据的安全性和完整性。</p><p>最后，使用Logback可以实现对日志数据的规范化和标准化输出，方便后续的日志分析和处理工作。同时，Logback还支持日志级别的配置和动态调整，可以根据实际需要控制日志输出的详细程度和数量。</p><p>这里的AOP技术实际上是指面向切片编程（一种编程范式），旨在提高代码复用性、降低代码耦合度、增强代码可维护性和可扩展性。</p><p>AOP 技术通过将横切关注点（如日志、事务、权限等）从程序主逻辑中抽离出来，再将其统一使用一些特殊的语法或术语来描述和实现，从而使得程序主逻辑更加简洁、可读、可维护和可扩展。</p><p>AOP技术在日志采集方面有非常大的优势。</p><ol>\n<li>它是一种跨越多个对象和代码层次（例如业务逻辑层、持久化层）的编程思想和技术，可以使代码组织结构更加清晰。</li>\n<li>通过增强（Advice）、切点（Pointcut）、连接点（Joinpoint）等概念对代码进行修改，从而实现功能的重用和代码的复用，减少代码的重复性。</li>\n<li>可以将关注点与业务逻辑进行分离，将代码进行模块化划分，便于代码维护和扩展。</li>\n<li>可以在不修改原有代码的情况下，对程序进行拓展和增强，从而实现额外的功能需求。</li>\n<li>提供了更加灵活的扩展机制，可以方便地对功能进行切换、拓展和升级。<br>\n总之，AOP技术是一种很有用的技术，我们可以将它运用到日志采集、事务管理、权限控制等场景中，提高代码的可读性、可维护性和可扩展性。</li>\n</ol><p></p><h2>总结</h2><p>本节课到这里就已经讲完了，我们来做一个简单的总结，学完本节课你应该知道下面五个要点。</p><ol>\n<li>推荐系统根据用户的历史行为、个人信息、社交关系等计算出一组推荐列表，但这些推荐并不一定都能满足用户的需要或兴趣。因此推荐系统把排序列表给到用户后，还需要做其他流程来满足用户的需求。</li>\n<li>推荐系统后处理主要包括用户反馈、用户行为收集、日志分析、改进系统、监控系统等。</li>\n<li>推荐系统通常使用数据处理库和深度学习方法来构建模型，并使用分布式文件系统进行日志处理和存储。</li>\n<li>对于一个推荐系统而言，常见的日志可以分为原始日志、点击日志、会话日志、反馈行为四个类别。</li>\n<li>埋点技术是通过在应用程序中添加代码，记录特定事件和活动的详细信息，从而帮助开发人员更好地诊断和解决问题，提高应用程序的稳定性和性能。</li>\n</ol><h2>思考题</h2><p>学完本节课，给你留两个思考题。</p><ol>\n<li>如果用户不愿意被追踪并收集个人信息，如何在保证推荐准确率的前提下最小化用户信息采集？</li>\n<li>埋点技术可以帮助企业收集用户需求和行为，以制定更有效的业务策略。可以分享一个大数据分析在提高用户体验和企业运营效率上起重要作用的例子吗？</li>\n</ol><p>期待你的分享，如果今天的内容让你有所收获，也欢迎你推荐给有需要的朋友！</p>","neighbors":{"left":{"article_title":"29｜推荐系统的工程化策略及服务部署策略","id":669464},"right":{"article_title":"特别放送｜知识回顾（上）","id":670224}},"comments":[{"had_liked":false,"id":377929,"user_name":"Geek_ccc0fd","can_delete":false,"product_type":"c1","uid":1461544,"ip_address":"","ucode":"DB53D576AEC020","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/EaBxhibOicZe9L7z2icbU4W462l543drFWYqibqczTicj4Msyb2g9pDSGmFTiafW9jibwib7jG6hpAdPMcCowdCiaxHaOdA/132","comment_is_top":false,"comment_ctime":1689564058,"is_pvip":false,"replies":[{"id":140016,"content":"基于TensorFlow的模型实时更新在线上需要一系列步骤。下面是一个大致的实现流程，从数据采集到特征工程，最终到线上更新的步骤：\n\n数据采集：首先，您需要选择合适的数据源来进行数据采集。这可能包括从数据库、API、日志文件、消息队列等地方获取数据。您可以使用Python中的各种库和工具来编写脚本或应用程序来获取数据。\n\n数据预处理：一旦您获得了数据，您需要对其进行预处理。这包括数据清洗、缺失值处理、异常值处理、特征选择、数据转换等。您可以使用Python中的Pandas库或其他相关库来进行数据预处理。\n\n特征工程：接下来，您需要进行特征工程，以提取和构建适合您的模型的特征。这可能包括特征缩放、特征编码、特征选择、特征组合等。您可以使用Scikit-learn等库来进行特征工程。\n\n模型训练与调优：一旦您准备好数据和特征，您可以使用TensorFlow来构建和训练您的模型。您可以选择适合您问题的模型类型，如神经网络、决策树、SVM等。通过迭代训练和调优，您可以提高模型的性能。\n\n模型部署与线上更新：一旦您训练好模型，您需要将其部署到线上进行实时更新。这通常涉及将模型导出为TensorFlow格式，并将其嵌入到您的线上系统中。您可以使用TensorFlow Serving、TensorFlow Lite或将模型封装为API等方式进行线上部署。在线上系统中，您可以定期或实时获取新数据并使用模型进行预测。","user_name":"作者回复","user_name_real":"编辑","uid":1982950,"ctime":1699860397,"ip_address":"广东","comment_id":377929,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100542801,"comment_content":"请问老师：基于tensorflow的模型实时更新在线上是如何实现的，能否讲述一下完整的实现流程，从数据采集到特征工程，及最终的线上更新，分别都是如何实现以及衔接的","like_count":0,"discussions":[{"author":{"id":1982950,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/41/e6/beb42103.jpg","nickname":"黄鸿波","note":"","ucode":"5EB4E6946A363C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":631650,"discussion_content":"基于TensorFlow的模型实时更新在线上需要一系列步骤。下面是一个大致的实现流程，从数据采集到特征工程，最终到线上更新的步骤：\n\n数据采集：首先，您需要选择合适的数据源来进行数据采集。这可能包括从数据库、API、日志文件、消息队列等地方获取数据。您可以使用Python中的各种库和工具来编写脚本或应用程序来获取数据。\n\n数据预处理：一旦您获得了数据，您需要对其进行预处理。这包括数据清洗、缺失值处理、异常值处理、特征选择、数据转换等。您可以使用Python中的Pandas库或其他相关库来进行数据预处理。\n\n特征工程：接下来，您需要进行特征工程，以提取和构建适合您的模型的特征。这可能包括特征缩放、特征编码、特征选择、特征组合等。您可以使用Scikit-learn等库来进行特征工程。\n\n模型训练与调优：一旦您准备好数据和特征，您可以使用TensorFlow来构建和训练您的模型。您可以选择适合您问题的模型类型，如神经网络、决策树、SVM等。通过迭代训练和调优，您可以提高模型的性能。\n\n模型部署与线上更新：一旦您训练好模型，您需要将其部署到线上进行实时更新。这通常涉及将模型导出为TensorFlow格式，并将其嵌入到您的线上系统中。您可以使用TensorFlow Serving、TensorFlow Lite或将模型封装为API等方式进行线上部署。在线上系统中，您可以定期或实时获取新数据并使用模型进行预测。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1699860397,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":376848,"user_name":"peter","can_delete":false,"product_type":"c1","uid":1058183,"ip_address":"北京","ucode":"261C3FC001DE2D","user_header":"https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg","comment_is_top":false,"comment_ctime":1687578960,"is_pvip":false,"replies":[{"id":138335,"content":"一般来讲，推荐系统在一个系统中用作用户留存，还是比较重要的","user_name":"作者回复","user_name_real":"编辑","uid":1982950,"ctime":1692499284,"ip_address":"广东","comment_id":376848,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100542801,"comment_content":"请教老师几个问题：\nQ1：推荐系统在整个网站一般占多大比重？\n一个网站，包含很多系统，推荐系统一般占多大分量？可以从人力投入角度来衡量，或者从硬件资源占用角度等方面来衡量。 \nQ2：用spark来分析日志，具体有什么方法？\nQ3：会话日志和会话记录会和其他日志重复吗？\n如果说会话记录是用户的操作，那么就会和“点击日志”和“反馈行为日志”重复啊，因为后两者就是用户的操作。\nQ4：Java中用了AOP，Python中也有吗？\nQ5：对于日志，不需要用ES(ElasticSearch)吗？","like_count":0,"discussions":[{"author":{"id":1982950,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/41/e6/beb42103.jpg","nickname":"黄鸿波","note":"","ucode":"5EB4E6946A363C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":626049,"discussion_content":"一般来讲，推荐系统在一个系统中用作用户留存，还是比较重要的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1692499284,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}