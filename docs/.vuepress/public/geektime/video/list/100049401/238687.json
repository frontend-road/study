{"id":238687,"title":"32 | 实战演练（二）：实现自动化灰度发布","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/geektime-servicemesh\">https://gitee.com/geektime-geekbang/geektime-servicemesh</a></p>","comments":[{"had_liked":false,"id":232178,"user_name":"光","can_delete":false,"product_type":"c3","uid":1284618,"ip_address":"","ucode":"BDA7F41566E4FE","user_header":"https://static001.geekbang.org/account/avatar/00/13/9a/0a/6c74e932.jpg","comment_is_top":false,"comment_ctime":1593890590,"is_pvip":false,"replies":[{"id":85716,"content":"生成环境肯定是通过路由设置定向不同的用户，比如登录用户都路由到新版本。\nflagger只是调整2个版本的weight，路由的match规则可以自己定义。","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1593950301,"ip_address":"","comment_id":232178,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"问个问题啊。基于流量得灰度发布依靠权重来定义不同流量流向。那会不会一个用户在访经常会在两个流量版本之间多次请求啊。同一个用户多次请求可能看到得页面情况或者数据因为版本差异而不同。这样实际生产中应该有一定问题把。 \n还有一个flagger 可以基于流量比重之外得其他场景得（比如headers） 自动灰度发布么。","like_count":1,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":500547,"discussion_content":"生成环境肯定是通过路由设置定向不同的用户，比如登录用户都路由到新版本。\nflagger只是调整2个版本的weight，路由的match规则可以自己定义。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1593950301,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":220832,"user_name":"Kimi","can_delete":false,"product_type":"c3","uid":1136178,"ip_address":"","ucode":"297DCC32202816","user_header":"https://static001.geekbang.org/account/avatar/00/11/56/32/009be2ac.jpg","comment_is_top":false,"comment_ctime":1590328028,"is_pvip":false,"replies":[{"id":81669,"content":"错误是什么有具体信息吗？\n你看看是不是触发了你配置的回滚指标？删掉指标试试？","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1590507303,"ip_address":"","comment_id":220832,"utype":1}],"discussion_count":7,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"hi there,\n按照C4-2的步骤,在demo的namepsace下,httpbin和sleep服务都启动了\nhpa及canary也生效,\nflagger  Starting canary analysis for httpbin.demo\nNormal   Synced  16m (x3 over 31m)    flagger  Advance httpbin.demo canary weight 20\n\n但是观察vs,就是一直是80&#47;20,不改变.sleep中也一直在curl服务,都是成功返回.最后过了一段时间canary就失败了,就回滚了!\n...\nHttp:\n    Route:\n      Destination:\n        Host:  httpbin-primary\n      Weight:  80\n      Destination:\n        Host:  httpbin-canary\n      Weight:  20\n\ncanary.flagger.app&#47;httpbin   Failed   0\n能请教下,大概是什么原因呢?\n我看了下,为什么我canary的pod不会叫httpbin-canary-xxxx这种pod!","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":496249,"discussion_content":"错误是什么有具体信息吗？\n你看看是不是触发了你配置的回滚指标？删掉指标试试？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590507303,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1136178,"avatar":"https://static001.geekbang.org/account/avatar/00/11/56/32/009be2ac.jpg","nickname":"Kimi","note":"","ucode":"297DCC32202816","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":275160,"discussion_content":"hello,搞定了,canary中的latency配置那里,漏了一步,多谢师傅了!","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590672472,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1462396,"avatar":"https://static001.geekbang.org/account/avatar/00/16/50/7c/f1203495.jpg","nickname":"之一","note":"","ucode":"45307FBDBEA953","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1136178,"avatar":"https://static001.geekbang.org/account/avatar/00/11/56/32/009be2ac.jpg","nickname":"Kimi","note":"","ucode":"297DCC32202816","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":302297,"discussion_content":"兄弟，漏的具体是啥，怎么个配置啊，我也遇到你这个报错","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598872556,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":275160,"ip_address":"","group_id":0},"score":302297,"extra":""},{"author":{"id":1136178,"avatar":"https://static001.geekbang.org/account/avatar/00/11/56/32/009be2ac.jpg","nickname":"Kimi","note":"","ucode":"297DCC32202816","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1462396,"avatar":"https://static001.geekbang.org/account/avatar/00/16/50/7c/f1203495.jpg","nickname":"之一","note":"","ucode":"45307FBDBEA953","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":302560,"discussion_content":"你看c4-2的yaml文件里，MetricTemplate 下的latency这个没创建，Canary中有用到这个latency的的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598954758,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":302297,"ip_address":"","group_id":0},"score":302560,"extra":""}]},{"author":{"id":1136178,"avatar":"https://static001.geekbang.org/account/avatar/00/11/56/32/009be2ac.jpg","nickname":"Kimi","note":"","ucode":"297DCC32202816","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":274485,"discussion_content":"hello,哦,我查了下,我istio的版本是1.6.0,我看官网更新了.应该不会是版本问题吧!","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590587656,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1136178,"avatar":"https://static001.geekbang.org/account/avatar/00/11/56/32/009be2ac.jpg","nickname":"Kimi","note":"","ucode":"297DCC32202816","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":274473,"discussion_content":"Halt advancement no values found for istio metric request-success-rate probably httpbin.default is not receiving traffic: running query failed: no values found, 我用的都是默认的default namespace下的应用.canary中爆出这个错误","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590586561,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1136178,"avatar":"https://static001.geekbang.org/account/avatar/00/11/56/32/009be2ac.jpg","nickname":"Kimi","note":"","ucode":"297DCC32202816","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":274393,"discussion_content":"hello,就是因为没有报错信息,我也没有配置回滚指标,都是按照C4-1,C4-2操作的,所以才觉得奇怪呢,能不能把你操作的每一个步骤都同步下,包括你docker tag是怎么操作的,何时操作的!感谢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590579222,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":340944,"user_name":"Adam","can_delete":false,"product_type":"c3","uid":1305633,"ip_address":"","ucode":"338BA720880E4F","user_header":"https://static001.geekbang.org/account/avatar/00/13/ec/21/b0fe1bfd.jpg","comment_is_top":false,"comment_ctime":1649239159,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"老师，flagger是否支持多集群","like_count":0},{"had_liked":false,"id":333974,"user_name":"Adam","can_delete":false,"product_type":"c3","uid":1305633,"ip_address":"","ucode":"338BA720880E4F","user_header":"https://static001.geekbang.org/account/avatar/00/13/ec/21/b0fe1bfd.jpg","comment_is_top":false,"comment_ctime":1644648753,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"灰度发布过程中有看到，Halt advancement no values found for istio metric request-success-rate probably httpbin.demo-uat is not receiving traffic: running query failed: no values found 这种报错，是什么引起的？","like_count":0,"discussions":[{"author":{"id":1987435,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/53/6b/f432518b.jpg","nickname":"。","note":"","ucode":"3E5E345E8B4F86","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":628146,"discussion_content":"你解决了这个问题了吗？ 我也提示没有request-success-rate 这个指标，这是为啥？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1695009345,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"湖北","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}