{"id":446949,"title":"37ï½œé˜¶æ®µå®æ“ï¼ˆ5ï¼‰ï¼šæ„å»ºä¸€ä¸ªç®€å•çš„KV server-ç½‘ç»œå®‰å…¨","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯é™ˆå¤©ã€‚</p><p>ä¸Šä¸€è®²æˆ‘ä»¬å®Œæˆäº†KV serveræ•´ä¸ªç½‘ç»œéƒ¨åˆ†çš„æ„å»ºã€‚è€Œå®‰å…¨æ˜¯å’Œç½‘ç»œå¯†ä¸å¯åˆ†çš„ç»„æˆéƒ¨åˆ†ï¼Œåœ¨æ„å»ºåº”ç”¨ç¨‹åºçš„æ—¶å€™ï¼Œä¸€å®šè¦æŠŠç½‘ç»œå®‰å…¨ä¹Ÿè€ƒè™‘è¿›å»ã€‚å½“ç„¶ï¼Œå¦‚æœä¸è€ƒè™‘æè‡´çš„æ€§èƒ½ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¯¸å¦‚ gRPC è¿™æ ·çš„ç³»ç»Ÿï¼Œåœ¨æä¾›è‰¯å¥½æ€§èƒ½çš„åŸºç¡€ä¸Šï¼Œå®ƒè¿˜é€šè¿‡ <a href=\"https://en.wikipedia.org/wiki/Transport_Layer_Security\">TLS</a> ä¿è¯äº†å®‰å…¨æ€§ã€‚</p><p>é‚£ä¹ˆï¼Œå½“æˆ‘ä»¬çš„åº”ç”¨æ¶æ„åœ¨ TCP ä¸Šæ—¶ï¼Œå¦‚ä½•ä½¿ç”¨ TLS æ¥ä¿è¯å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨é—´çš„å®‰å…¨æ€§å‘¢ï¼Ÿ</p><h2>ç”Ÿæˆ x509 è¯ä¹¦</h2><p>æƒ³è¦ä½¿ç”¨ TLSï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦ <a href=\"https://en.wikipedia.org/wiki/X.509\">x509 è¯ä¹¦</a>ã€‚TLS éœ€è¦ x509 è¯ä¹¦è®©å®¢æˆ·ç«¯éªŒè¯æœåŠ¡å™¨æ˜¯å¦æ˜¯ä¸€ä¸ªå—ä¿¡çš„æœåŠ¡å™¨ï¼Œç”šè‡³æœåŠ¡å™¨éªŒè¯å®¢æˆ·ç«¯ï¼Œç¡®è®¤å¯¹æ–¹æ˜¯ä¸€ä¸ªå—ä¿¡çš„å®¢æˆ·ç«¯ã€‚</p><p>ä¸ºäº†æµ‹è¯•æ–¹ä¾¿ï¼Œæˆ‘ä»¬è¦æœ‰èƒ½åŠ›ç”Ÿæˆè‡ªå·±çš„ CA è¯ä¹¦ã€æœåŠ¡ç«¯è¯ä¹¦ï¼Œç”šè‡³å®¢æˆ·ç«¯è¯ä¹¦ã€‚è¯ä¹¦ç”Ÿæˆçš„ç»†èŠ‚ä»Šå¤©å°±ä¸è¯¦ç»†ä»‹ç»äº†ï¼Œæˆ‘ä¹‹å‰åšäº†ä¸€ä¸ªå« <a href=\"https://github.com/tyrchen/certify\">certify</a> çš„åº“ï¼Œå¯ä»¥ç”¨æ¥ç”Ÿæˆå„ç§è¯ä¹¦ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ Cargo.toml é‡ŒåŠ å…¥è¿™ä¸ªåº“ï¼š</p><pre><code class=\"language-rust\">[dev-dependencies]\n...\ncertify = \"0.3\"\n...\n</code></pre><p>ç„¶ååœ¨æ ¹ç›®å½•ä¸‹åˆ›å»º fixtures ç›®å½•å­˜æ”¾è¯ä¹¦ï¼Œå†åˆ›å»º examples/gen_cert.rs æ–‡ä»¶ï¼Œæ·»å…¥å¦‚ä¸‹ä»£ç ï¼š</p><pre><code class=\"language-rust\">use anyhow::Result;\nuse certify::{generate_ca, generate_cert, load_ca, CertType, CA};\nuse tokio::fs;\n\nstruct CertPem {\n    cert_type: CertType,\n    cert: String,\n    key: String,\n}\n\n#[tokio::main]\nasync fn main() -&gt; Result&lt;()&gt; {\n    let pem = create_ca()?;\n    gen_files(&amp;pem).await?;\n    let ca = load_ca(&amp;pem.cert, &amp;pem.key)?;\n    let pem = create_cert(&amp;ca, &amp;[\"kvserver.acme.inc\"], \"Acme KV server\", false)?;\n    gen_files(&amp;pem).await?;\n    let pem = create_cert(&amp;ca, &amp;[], \"awesome-device-id\", true)?;\n    gen_files(&amp;pem).await?;\n    Ok(())\n}\n\nfn create_ca() -&gt; Result&lt;CertPem&gt; {\n    let (cert, key) = generate_ca(\n        &amp;[\"acme.inc\"],\n        \"CN\",\n        \"Acme Inc.\",\n        \"Acme CA\",\n        None,\n        Some(10 * 365),\n    )?;\n    Ok(CertPem {\n        cert_type: CertType::CA,\n        cert,\n        key,\n    })\n}\n\nfn create_cert(ca: &amp;CA, domains: &amp;[&amp;str], cn: &amp;str, is_client: bool) -&gt; Result&lt;CertPem&gt; {\n    let (days, cert_type) = if is_client {\n        (Some(365), CertType::Client)\n    } else {\n        (Some(5 * 365), CertType::Server)\n    };\n    let (cert, key) = generate_cert(ca, domains, \"CN\", \"Acme Inc.\", cn, None, is_client, days)?;\n\n    Ok(CertPem {\n        cert_type,\n        cert,\n        key,\n    })\n}\n\nasync fn gen_files(pem: &amp;CertPem) -&gt; Result&lt;()&gt; {\n    let name = match pem.cert_type {\n        CertType::Client =&gt; \"client\",\n        CertType::Server =&gt; \"server\",\n        CertType::CA =&gt; \"ca\",\n    };\n    fs::write(format!(\"fixtures/{}.cert\", name), pem.cert.as_bytes()).await?;\n    fs::write(format!(\"fixtures/{}.key\", name), pem.key.as_bytes()).await?;\n    Ok(())\n}\n</code></pre><!-- [[[read_end]]] --><p>è¿™ä¸ªä»£ç å¾ˆç®€å•ï¼Œå®ƒå…ˆç”Ÿæˆäº†ä¸€ä¸ª CA è¯ä¹¦ï¼Œç„¶åå†ç”ŸæˆæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯è¯ä¹¦ï¼Œå…¨éƒ¨å­˜å…¥åˆšåˆ›å»ºçš„ fixtures ç›®å½•ä¸‹ã€‚ä½ éœ€è¦ <code>cargo run --examples gen_cert</code> è¿è¡Œä¸€ä¸‹è¿™ä¸ªå‘½ä»¤ï¼Œå¾…ä¼šæˆ‘ä»¬ä¼šåœ¨æµ‹è¯•ä¸­ç”¨åˆ°è¿™äº›è¯ä¹¦å’Œå¯†é’¥ã€‚</p><h2>åœ¨ KV server ä¸­ä½¿ç”¨ TLS</h2><p>TLS æ˜¯ç›®å‰æœ€ä¸»è¦çš„åº”ç”¨å±‚å®‰å…¨åè®®ï¼Œè¢«å¹¿æ³›ç”¨äºä¿æŠ¤æ¶æ„åœ¨ TCP ä¹‹ä¸Šçš„ï¼Œæ¯”å¦‚ MySQLã€HTTP ç­‰å„ç§åè®®ã€‚ä¸€ä¸ªç½‘ç»œåº”ç”¨ï¼Œå³ä¾¿æ˜¯åœ¨å†…ç½‘ä½¿ç”¨ï¼Œå¦‚æœæ²¡æœ‰å®‰å…¨åè®®æ¥ä¿æŠ¤ï¼Œéƒ½æ˜¯å¾ˆå±é™©çš„ã€‚</p><p>ä¸‹å›¾å±•ç¤ºäº†å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨è¿›è¡Œ TLS æ¡æ‰‹çš„è¿‡ç¨‹ï¼Œæ¥æº<a href=\"https://commons.wikimedia.org/wiki/File:Full_TLS_1.3_Handshake.svg\">wikimedia</a>ï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/71/f7/71befa0bbf5225582dd01a7330c641f7.png?wh=1280x877\" alt=\"\"></p><p>å¯¹äº KV server æ¥è¯´ï¼Œä½¿ç”¨ TLS ä¹‹åï¼Œæ•´ä¸ªåè®®çš„æ•°æ®å°è£…å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/07/13/077659d231dd45b1617ed3707c74cf13.jpg?wh=2364x1027\" alt=\"\"></p><p>æ‰€ä»¥ä»Šå¤©è¦åšçš„å°±æ˜¯åœ¨ä¸Šä¸€è®²çš„ç½‘ç»œå¤„ç†çš„åŸºç¡€ä¸Šï¼Œæ·»åŠ  TLS æ”¯æŒï¼Œä½¿å¾— KV server çš„å®¢æˆ·ç«¯æœåŠ¡å™¨ä¹‹é—´çš„é€šè®¯è¢«ä¸¥æ ¼ä¿æŠ¤èµ·æ¥ï¼Œç¡®ä¿æœ€å¤§ç¨‹åº¦çš„å®‰å…¨ï¼Œå…é­ç¬¬ä¸‰æ–¹çš„å·çª¥ã€ç¯¡æ”¹ä»¥åŠä»¿é€ ã€‚</p><p>å¥½ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ TLS æ€ä¹ˆå®ç°ã€‚</p><p>ä¼°è®¡å¾ˆå¤šäººä¸€å¬ TLS æˆ–è€… SSLï¼Œå°±å¤´çš®å‘éº»ï¼Œå› ä¸ºä¹‹å‰è·Ÿ <a href=\"https://www.openssl.org/\">openssl</a> æ‰“äº¤é“æœ‰è¿‡å¾ˆå¤šä¸å¥½çš„ç»å†ã€‚openssl çš„ä»£ç åº“å¤ªåºæ‚ï¼ŒAPI ä¸å‹å¥½ï¼Œç¼–è¯‘é“¾æ¥éƒ½å¾ˆè´¹åŠ²ã€‚</p><p>ä¸è¿‡ï¼Œåœ¨ Rust ä¸‹ä½¿ç”¨ TLS çš„ä½“éªŒè¿˜æ˜¯å¾ˆä¸é”™çš„ï¼ŒRust å¯¹ openssl æœ‰å¾ˆä¸é”™çš„<a href=\"https://github.com/sfackler/rust-openssl\">å°è£…</a>ï¼Œä¹Ÿæœ‰ä¸ä¾èµ– openssl ç”¨ Rust æ’°å†™çš„ <a href=\"https://github.com/rustls/rustls\">rustls</a>ã€‚tokio è¿›ä¸€æ­¥æä¾›äº†ç¬¦åˆ tokio ç”Ÿæ€åœˆçš„ <a href=\"https://github.com/tokio-rs/tls\">tls æ”¯æŒ</a>ï¼Œæœ‰ openssl ç‰ˆæœ¬å’Œ rustls ç‰ˆæœ¬å¯é€‰ã€‚</p><p>æˆ‘ä»¬ä»Šå¤©å°±ç”¨ <a href=\"https://github.com/tokio-rs/tls/tree/master/tokio-rustls\">tokio-rustls</a> æ¥æ’°å†™ TLS çš„æ”¯æŒã€‚ç›¸ä¿¡ä½ åœ¨å®ç°è¿‡ç¨‹ä¸­å¯ä»¥çœ‹åˆ°ï¼Œåœ¨åº”ç”¨ç¨‹åºä¸­åŠ å…¥ TLS åè®®æ¥ä¿æŠ¤ç½‘ç»œå±‚ï¼Œæ˜¯å¤šä¹ˆè½»æ¾çš„ä¸€ä»¶äº‹æƒ…ã€‚</p><p>å…ˆåœ¨ Cargo.toml ä¸­æ·»åŠ  tokio-rustlsï¼š</p><pre><code class=\"language-rust\">[dependencies]\n...\ntokio-rustls = \"0.22\"\n...\n</code></pre><p>ç„¶ååˆ›å»º src/network/tls.rsï¼Œæ’°å†™å¦‚ä¸‹ä»£ç ï¼ˆè®°å¾—åœ¨ src/network/mod.rs ä¸­å¼•å…¥è¿™ä¸ªæ–‡ä»¶å“¦ï¼‰ï¼š</p><pre><code class=\"language-rust\">use std::io::Cursor;\nuse std::sync::Arc;\n\nuse tokio::io::{AsyncRead, AsyncWrite};\nuse tokio_rustls::rustls::{internal::pemfile, Certificate, ClientConfig, ServerConfig};\nuse tokio_rustls::rustls::{AllowAnyAuthenticatedClient, NoClientAuth, PrivateKey, RootCertStore};\nuse tokio_rustls::webpki::DNSNameRef;\nuse tokio_rustls::TlsConnector;\nuse tokio_rustls::{\n    client::TlsStream as ClientTlsStream, server::TlsStream as ServerTlsStream, TlsAcceptor,\n};\n\nuse crate::KvError;\n\n/// KV Server è‡ªå·±çš„ ALPN (Application-Layer Protocol Negotiation)\nconst ALPN_KV: &amp;str = \"kv\";\n\n/// å­˜æ”¾ TLS ServerConfig å¹¶æä¾›æ–¹æ³• accept æŠŠåº•å±‚çš„åè®®è½¬æ¢æˆ TLS\n#[derive(Clone)]\npub struct TlsServerAcceptor {\n    inner: Arc&lt;ServerConfig&gt;,\n}\n\n/// å­˜æ”¾ TLS Client å¹¶æä¾›æ–¹æ³• connect æŠŠåº•å±‚çš„åè®®è½¬æ¢æˆ TLS\n#[derive(Clone)]\npub struct TlsClientConnector {\n    pub config: Arc&lt;ClientConfig&gt;,\n    pub domain: Arc&lt;String&gt;,\n}\n\nimpl TlsClientConnector {\n    /// åŠ è½½ client cert / CA certï¼Œç”Ÿæˆ ClientConfig\n    pub fn new(\n        domain: impl Into&lt;String&gt;,\n        identity: Option&lt;(&amp;str, &amp;str)&gt;,\n        server_ca: Option&lt;&amp;str&gt;,\n    ) -&gt; Result&lt;Self, KvError&gt; {\n        let mut config = ClientConfig::new();\n\n        // å¦‚æœæœ‰å®¢æˆ·ç«¯è¯ä¹¦ï¼ŒåŠ è½½ä¹‹\n        if let Some((cert, key)) = identity {\n            let certs = load_certs(cert)?;\n            let key = load_key(key)?;\n            config.set_single_client_cert(certs, key)?;\n        }\n\n        // åŠ è½½æœ¬åœ°ä¿¡ä»»çš„æ ¹è¯ä¹¦é“¾\n        config.root_store = match rustls_native_certs::load_native_certs() {\n            Ok(store) | Err((Some(store), _)) =&gt; store,\n            Err((None, error)) =&gt; return Err(error.into()),\n        };\n\n        // å¦‚æœæœ‰ç­¾ç½²æœåŠ¡å™¨çš„ CA è¯ä¹¦ï¼Œåˆ™åŠ è½½å®ƒï¼Œè¿™æ ·æœåŠ¡å™¨è¯ä¹¦ä¸åœ¨æ ¹è¯ä¹¦é“¾\n        // ä½†æ˜¯è¿™ä¸ª CA è¯ä¹¦èƒ½éªŒè¯å®ƒï¼Œä¹Ÿå¯ä»¥\n        if let Some(cert) = server_ca {\n            let mut buf = Cursor::new(cert);\n            config.root_store.add_pem_file(&amp;mut buf).unwrap();\n        }\n\n        Ok(Self {\n            config: Arc::new(config),\n            domain: Arc::new(domain.into()),\n        })\n    }\n\n    /// è§¦å‘ TLS åè®®ï¼ŒæŠŠåº•å±‚çš„ stream è½¬æ¢æˆ TLS stream\n    pub async fn connect&lt;S&gt;(&amp;self, stream: S) -&gt; Result&lt;ClientTlsStream&lt;S&gt;, KvError&gt;\n    where\n        S: AsyncRead + AsyncWrite + Unpin + Send,\n    {\n        let dns = DNSNameRef::try_from_ascii_str(self.domain.as_str())\n            .map_err(|_| KvError::Internal(\"Invalid DNS name\".into()))?;\n\n        let stream = TlsConnector::from(self.config.clone())\n            .connect(dns, stream)\n            .await?;\n\n        Ok(stream)\n    }\n}\n\nimpl TlsServerAcceptor {\n    /// åŠ è½½ server cert / CA certï¼Œç”Ÿæˆ ServerConfig\n    pub fn new(cert: &amp;str, key: &amp;str, client_ca: Option&lt;&amp;str&gt;) -&gt; Result&lt;Self, KvError&gt; {\n        let certs = load_certs(cert)?;\n        let key = load_key(key)?;\n\n        let mut config = match client_ca {\n            None =&gt; ServerConfig::new(NoClientAuth::new()),\n            Some(cert) =&gt; {\n                // å¦‚æœå®¢æˆ·ç«¯è¯ä¹¦æ˜¯æŸä¸ª CA è¯ä¹¦ç­¾å‘çš„ï¼Œåˆ™æŠŠè¿™ä¸ª CA è¯ä¹¦åŠ è½½åˆ°ä¿¡ä»»é“¾ä¸­\n                let mut cert = Cursor::new(cert);\n                let mut client_root_cert_store = RootCertStore::empty();\n                client_root_cert_store\n                    .add_pem_file(&amp;mut cert)\n                    .map_err(|_| KvError::CertifcateParseError(\"CA\", \"cert\"))?;\n\n                let client_auth = AllowAnyAuthenticatedClient::new(client_root_cert_store);\n                ServerConfig::new(client_auth)\n            }\n        };\n\n        // åŠ è½½æœåŠ¡å™¨è¯ä¹¦\n        config\n            .set_single_cert(certs, key)\n            .map_err(|_| KvError::CertifcateParseError(\"server\", \"cert\"))?;\n        config.set_protocols(&amp;[Vec::from(&amp;ALPN_KV[..])]);\n\n        Ok(Self {\n            inner: Arc::new(config),\n        })\n    }\n\n    /// è§¦å‘ TLS åè®®ï¼ŒæŠŠåº•å±‚çš„ stream è½¬æ¢æˆ TLS stream\n    pub async fn accept&lt;S&gt;(&amp;self, stream: S) -&gt; Result&lt;ServerTlsStream&lt;S&gt;, KvError&gt;\n    where\n        S: AsyncRead + AsyncWrite + Unpin + Send,\n    {\n        let acceptor = TlsAcceptor::from(self.inner.clone());\n        Ok(acceptor.accept(stream).await?)\n    }\n}\n\nfn load_certs(cert: &amp;str) -&gt; Result&lt;Vec&lt;Certificate&gt;, KvError&gt; {\n    let mut cert = Cursor::new(cert);\n    pemfile::certs(&amp;mut cert).map_err(|_| KvError::CertifcateParseError(\"server\", \"cert\"))\n}\n\nfn load_key(key: &amp;str) -&gt; Result&lt;PrivateKey, KvError&gt; {\n    let mut cursor = Cursor::new(key);\n\n    // å…ˆå°è¯•ç”¨ PKCS8 åŠ è½½ç§é’¥\n    if let Ok(mut keys) = pemfile::pkcs8_private_keys(&amp;mut cursor) {\n        if !keys.is_empty() {\n            return Ok(keys.remove(0));\n        }\n    }\n\n    // å†å°è¯•åŠ è½½ RSA key\n    cursor.set_position(0);\n    if let Ok(mut keys) = pemfile::rsa_private_keys(&amp;mut cursor) {\n        if !keys.is_empty() {\n            return Ok(keys.remove(0));\n        }\n    }\n\n    // ä¸æ”¯æŒçš„ç§é’¥ç±»å‹\n    Err(KvError::CertifcateParseError(\"private\", \"key\"))\n}\n</code></pre><p>è¿™ä¸ªä»£ç åˆ›å»ºäº†ä¸¤ä¸ªæ•°æ®ç»“æ„ TlsServerAcceptor / TlsClientConnectorã€‚è™½ç„¶å®ƒæœ‰ 100 å¤šè¡Œï¼Œä½†ä¸»è¦çš„å·¥ä½œå…¶å®å°±æ˜¯<strong>æ ¹æ®æä¾›çš„è¯ä¹¦ï¼Œæ¥ç”Ÿæˆ tokio-tls éœ€è¦çš„ ServerConfig / ClientConfig</strong>ã€‚</p><p>å› ä¸º TLS éœ€è¦éªŒè¯è¯ä¹¦çš„ CAï¼Œæ‰€ä»¥è¿˜éœ€è¦åŠ è½½ CA è¯ä¹¦ã€‚è™½ç„¶å¹³æ—¶åœ¨åš Web å¼€å‘æ—¶ï¼Œæˆ‘ä»¬éƒ½åªä½¿ç”¨æœåŠ¡å™¨è¯ä¹¦ï¼Œä½†å…¶å® TLS æ”¯æŒåŒå‘éªŒè¯ï¼ŒæœåŠ¡å™¨ä¹Ÿå¯ä»¥éªŒè¯å®¢æˆ·ç«¯çš„è¯ä¹¦æ˜¯å¦æ˜¯å®ƒè®¤è¯†çš„ CA ç­¾å‘çš„ã€‚</p><p>å¤„ç†å®Œ config åï¼Œè¿™æ®µä»£ç çš„æ ¸å¿ƒé€»è¾‘å…¶å®å°±æ˜¯å®¢æˆ·ç«¯çš„ connect() æ–¹æ³•å’ŒæœåŠ¡å™¨çš„ accept() æ–¹æ³•ï¼Œå®ƒä»¬éƒ½æ¥å—ä¸€ä¸ªæ»¡è¶³ AsyncRead + AsyncWrite + Unpin + Send çš„ streamã€‚ç±»ä¼¼ä¸Šä¸€è®²ï¼Œæˆ‘ä»¬ä¸å¸Œæœ› TLS ä»£ç åªèƒ½æ¥å— TcpStreamï¼Œæ‰€ä»¥è¿™é‡Œæä¾›äº†ä¸€ä¸ªæ³›å‹å‚æ•° Sï¼š</p><pre><code class=\"language-rust\">/// è§¦å‘ TLS åè®®ï¼ŒæŠŠåº•å±‚çš„ stream è½¬æ¢æˆ TLS stream\npub async fn connect&lt;S&gt;(&amp;self, stream: S) -&gt; Result&lt;ClientTlsStream&lt;S&gt;, KvError&gt;\nwhere\n    S: AsyncRead + AsyncWrite + Unpin + Send,\n{\n    let dns = DNSNameRef::try_from_ascii_str(self.domain.as_str())\n        .map_err(|_| KvError::Internal(\"Invalid DNS name\".into()))?;\n\n    let stream = TlsConnector::from(self.config.clone())\n        .connect(dns, stream)\n        .await?;\n\n    Ok(stream)\n}\n\n/// è§¦å‘ TLS åè®®ï¼ŒæŠŠåº•å±‚çš„ stream è½¬æ¢æˆ TLS stream\npub async fn accept&lt;S&gt;(&amp;self, stream: S) -&gt; Result&lt;ServerTlsStream&lt;S&gt;, KvError&gt;\nwhere\n    S: AsyncRead + AsyncWrite + Unpin + Send,\n{\n    let acceptor = TlsAcceptor::from(self.inner.clone());\n    Ok(acceptor.accept(stream).await?)\n}\n</code></pre><p>åœ¨ä½¿ç”¨ TlsConnector æˆ–è€… TlsAcceptor å¤„ç†å®Œ connect/accept åï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ª TlsStreamï¼Œå®ƒä¹Ÿæ»¡è¶³ AsyncRead + AsyncWrite + Unpin + Sendï¼Œåç»­çš„æ“ä½œå°±å¯ä»¥åœ¨å…¶ä¸Šå®Œæˆäº†ã€‚ç™¾æ¥è¡Œä»£ç å°±æå®šäº† TLSï¼Œæ˜¯ä¸æ˜¯å¾ˆè½»æ¾ï¼Ÿ</p><p>æˆ‘ä»¬æ¥é¡ºç€å¾€ä¸‹å†™æ®µæµ‹è¯•ï¼š</p><pre><code class=\"language-rust\">#[cfg(test)]\nmod tests {\n\n    use std::net::SocketAddr;\n\n    use super::*;\n    use anyhow::Result;\n    use tokio::{\n        io::{AsyncReadExt, AsyncWriteExt},\n        net::{TcpListener, TcpStream},\n    };\n\n    const CA_CERT: &amp;str = include_str!(\"../../fixtures/ca.cert\");\n    const CLIENT_CERT: &amp;str = include_str!(\"../../fixtures/client.cert\");\n    const CLIENT_KEY: &amp;str = include_str!(\"../../fixtures/client.key\");\n    const SERVER_CERT: &amp;str = include_str!(\"../../fixtures/server.cert\");\n    const SERVER_KEY: &amp;str = include_str!(\"../../fixtures/server.key\");\n\n    #[tokio::test]\n    async fn tls_should_work() -&gt; Result&lt;()&gt; {\n        let ca = Some(CA_CERT);\n\n        let addr = start_server(None).await?;\n\n        let connector = TlsClientConnector::new(\"kvserver.acme.inc\", None, ca)?;\n        let stream = TcpStream::connect(addr).await?;\n        let mut stream = connector.connect(stream).await?;\n        stream.write_all(b\"hello world!\").await?;\n        let mut buf = [0; 12];\n        stream.read_exact(&amp;mut buf).await?;\n        assert_eq!(&amp;buf, b\"hello world!\");\n\n        Ok(())\n    }\n\n    #[tokio::test]\n    async fn tls_with_client_cert_should_work() -&gt; Result&lt;()&gt; {\n        let client_identity = Some((CLIENT_CERT, CLIENT_KEY));\n        let ca = Some(CA_CERT);\n\n        let addr = start_server(ca.clone()).await?;\n\n        let connector = TlsClientConnector::new(\"kvserver.acme.inc\", client_identity, ca)?;\n        let stream = TcpStream::connect(addr).await?;\n        let mut stream = connector.connect(stream).await?;\n        stream.write_all(b\"hello world!\").await?;\n        let mut buf = [0; 12];\n        stream.read_exact(&amp;mut buf).await?;\n        assert_eq!(&amp;buf, b\"hello world!\");\n\n        Ok(())\n    }\n\n    #[tokio::test]\n    async fn tls_with_bad_domain_should_not_work() -&gt; Result&lt;()&gt; {\n        let addr = start_server(None).await?;\n\n        let connector = TlsClientConnector::new(\"kvserver1.acme.inc\", None, Some(CA_CERT))?;\n        let stream = TcpStream::connect(addr).await?;\n        let result = connector.connect(stream).await;\n\n        assert!(result.is_err());\n\n        Ok(())\n    }\n\n    async fn start_server(ca: Option&lt;&amp;str&gt;) -&gt; Result&lt;SocketAddr&gt; {\n        let acceptor = TlsServerAcceptor::new(SERVER_CERT, SERVER_KEY, ca)?;\n\n        let echo = TcpListener::bind(\"127.0.0.1:0\").await.unwrap();\n        let addr = echo.local_addr().unwrap();\n\n        tokio::spawn(async move {\n            let (stream, _) = echo.accept().await.unwrap();\n            let mut stream = acceptor.accept(stream).await.unwrap();\n            let mut buf = [0; 12];\n            stream.read_exact(&amp;mut buf).await.unwrap();\n            stream.write_all(&amp;buf).await.unwrap();\n        });\n\n        Ok(addr)\n    }\n}\n</code></pre><p>è¿™æ®µæµ‹è¯•ä»£ç ä½¿ç”¨äº† include_str! å®ï¼Œåœ¨ç¼–è¯‘æœŸæŠŠæ–‡ä»¶åŠ è½½æˆå­—ç¬¦ä¸²æ”¾åœ¨ RODATA æ®µã€‚æˆ‘ä»¬æµ‹è¯•äº†ä¸‰ç§æƒ…å†µï¼šæ ‡å‡†çš„ TLS è¿æ¥ã€å¸¦æœ‰å®¢æˆ·ç«¯è¯ä¹¦çš„ TLS è¿æ¥ï¼Œä»¥åŠå®¢æˆ·ç«¯æä¾›äº†é”™çš„åŸŸåçš„æƒ…å†µã€‚è¿è¡Œ <code>cargo test</code> ï¼Œæ‰€æœ‰æµ‹è¯•éƒ½èƒ½é€šè¿‡ã€‚</p><h2>è®© KV client/server æ”¯æŒ TLS</h2><p>åœ¨ TLS çš„æµ‹è¯•éƒ½é€šè¿‡åï¼Œå°±å¯ä»¥æ·»åŠ  kvså’Œ kvcå¯¹ TLS çš„æ”¯æŒäº†ã€‚</p><p>ç”±äºæˆ‘ä»¬ä¸€è·¯ä»¥æ¥è‰¯å¥½çš„æ¥å£è®¾è®¡ï¼Œå°¤å…¶æ˜¯ ProstClientStream / ProstServerStream éƒ½æ¥å—æ³›å‹å‚æ•°ï¼Œä½¿å¾— TLS çš„ä»£ç å¯ä»¥æ— ç¼åµŒå…¥ã€‚æ¯”å¦‚å®¢æˆ·ç«¯ï¼š</p><pre><code class=\"language-rust\">// æ–°åŠ çš„ä»£ç \nlet connector = TlsClientConnector::new(\"kvserver.acme.inc\", None, Some(ca_cert))?;\n\nlet stream = TcpStream::connect(addr).await?;\n\n// æ–°åŠ çš„ä»£ç \nlet stream = connector.connect(stream).await?;\n\nlet mut client = ProstClientStream::new(stream);\n</code></pre><p>ä»…ä»…éœ€è¦æŠŠä¼ ç»™ ProstClientStream çš„ streamï¼Œä» TcpStream æ¢æˆç”Ÿæˆçš„ TlsStreamï¼Œå°±æ— ç¼æ”¯æŒäº† TLSã€‚</p><p>æˆ‘ä»¬çœ‹å®Œæ•´çš„ä»£ç ï¼Œsrc/server.rsï¼š</p><pre><code class=\"language-rust\">use anyhow::Result;\nuse kv3::{MemTable, ProstServerStream, Service, ServiceInner, TlsServerAcceptor};\nuse tokio::net::TcpListener;\nuse tracing::info;\n\n#[tokio::main]\nasync fn main() -&gt; Result&lt;()&gt; {\n    tracing_subscriber::fmt::init();\n    let addr = \"127.0.0.1:9527\";\n\n    // ä»¥åä»é…ç½®æ–‡ä»¶å–\n    let server_cert = include_str!(\"../fixtures/server.cert\");\n    let server_key = include_str!(\"../fixtures/server.key\");\n\n    let acceptor = TlsServerAcceptor::new(server_cert, server_key, None)?;\n    let service: Service = ServiceInner::new(MemTable::new()).into();\n    let listener = TcpListener::bind(addr).await?;\n    info!(\"Start listening on {}\", addr);\n    loop {\n        let tls = acceptor.clone();\n        let (stream, addr) = listener.accept().await?;\n        info!(\"Client {:?} connected\", addr);\n        let stream = tls.accept(stream).await?;\n        let stream = ProstServerStream::new(stream, service.clone());\n        tokio::spawn(async move { stream.process().await });\n    }\n}\n</code></pre><p>src/client.rsï¼š</p><pre><code class=\"language-rust\">use anyhow::Result;\nuse kv3::{CommandRequest, ProstClientStream, TlsClientConnector};\nuse tokio::net::TcpStream;\nuse tracing::info;\n\n#[tokio::main]\nasync fn main() -&gt; Result&lt;()&gt; {\n    tracing_subscriber::fmt::init();\n\n    // ä»¥åç”¨é…ç½®æ›¿æ¢\n    let ca_cert = include_str!(\"../fixtures/ca.cert\");\n\n    let addr = \"127.0.0.1:9527\";\n    // è¿æ¥æœåŠ¡å™¨\n    let connector = TlsClientConnector::new(\"kvserver.acme.inc\", None, Some(ca_cert))?;\n    let stream = TcpStream::connect(addr).await?;\n    let stream = connector.connect(stream).await?;\n\n    let mut client = ProstClientStream::new(stream);\n\n    // ç”Ÿæˆä¸€ä¸ª HSET å‘½ä»¤\n    let cmd = CommandRequest::new_hset(\"table1\", \"hello\", \"world\".to_string().into());\n\n    // å‘é€ HSET å‘½ä»¤\n    let data = client.execute(cmd).await?;\n    info!(\"Got response {:?}\", data);\n\n    Ok(())\n}\n</code></pre><p>å’Œä¸Šä¸€è®²çš„ä»£ç é¡¹ç›®ç›¸æ¯”ï¼Œæ›´æ–°åçš„å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä»£ç ï¼Œå„è‡ªä»…ä»…å¤šäº†ä¸€è¡Œï¼Œå°±æŠŠ TcpStream å°è£…æˆäº† TlsStreamã€‚è¿™å°±æ˜¯ä½¿ç”¨ trait åšé¢å‘æ¥å£ç¼–ç¨‹çš„å·¨å¤§å¨åŠ›ï¼Œç³»ç»Ÿçš„å„ä¸ªç»„ä»¶å¯ä»¥æ¥è‡ªä¸åŒçš„ cratesï¼Œä½†åªè¦å…¶æ¥å£ä¸€è‡´ï¼ˆæˆ–è€…æˆ‘ä»¬åˆ›å»º adapter ä½¿å…¶æ¥å£ä¸€è‡´ï¼‰ï¼Œå°±å¯ä»¥æ— ç¼æ’å…¥ã€‚</p><p>å®Œæˆä¹‹åï¼Œæ‰“å¼€ä¸€ä¸ªå‘½ä»¤è¡Œçª—å£ï¼Œè¿è¡Œï¼š<code>RUST_LOG=info cargo run --bin kvs --quiet</code>ã€‚ç„¶ååœ¨å¦ä¸€ä¸ªå‘½ä»¤è¡Œçª—å£ï¼Œè¿è¡Œï¼š<code>RUST_LOG=info cargo run --bin kvc --quiet</code>ã€‚æ­¤æ—¶ï¼ŒæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯éƒ½æ”¶åˆ°äº†å½¼æ­¤çš„è¯·æ±‚å’Œå“åº”ï¼Œå¹¶ä¸”å¤„ç†æ­£å¸¸ã€‚</p><p>ç°åœ¨ï¼Œæˆ‘ä»¬çš„ KV server å·²ç»å…·å¤‡è¶³å¤Ÿçš„å®‰å…¨æ€§äº†ï¼ä»¥åï¼Œç­‰æˆ‘ä»¬ä½¿ç”¨é…ç½®æ–‡ä»¶ï¼Œå°±å¯ä»¥æ ¹æ®é…ç½®æ–‡ä»¶è¯»å–è¯ä¹¦å’Œç§é’¥ã€‚è¿™æ ·å¯ä»¥åœ¨éƒ¨ç½²çš„æ—¶å€™ï¼Œæ‰ä» vault ä¸­è·å–ç§é’¥ï¼Œæ—¢ä¿è¯çµæ´»æ€§ï¼Œåˆèƒ½ä¿è¯ç³»ç»Ÿè‡ªèº«çš„å®‰å…¨ã€‚</p><h2>å°ç»“</h2><p>ç½‘ç»œå®‰å…¨æ˜¯å¼€å‘ç½‘ç»œç›¸å…³çš„åº”ç”¨ç¨‹åºä¸­éå¸¸é‡è¦çš„ä¸€ä¸ªç¯èŠ‚ã€‚è™½ç„¶ KV Server è¿™æ ·çš„æœåŠ¡åŸºæœ¬ä¸Šä¼šè¿è¡Œåœ¨äº‘ç«¯å—æ§çš„ç½‘ç»œç¯å¢ƒä¸­ï¼Œä¸ä¼šå¯¹ internet æä¾›æœåŠ¡ï¼Œç„¶è€Œäº‘ç«¯å†…éƒ¨çš„å®‰å…¨æ€§ä¹Ÿä¸å®¹å¿½è§†ã€‚ä½ ä¸å¸Œæœ›æ•°æ®åœ¨æµåŠ¨çš„è¿‡ç¨‹ä¸­è¢«ç¯¡æ”¹ã€‚</p><p>TLS å¾ˆå¥½åœ°è§£å†³äº†å®‰å…¨æ€§çš„é—®é¢˜ï¼Œå¯ä»¥ä¿è¯æ•´ä¸ªä¼ è¾“è¿‡ç¨‹ä¸­æ•°æ®çš„æœºå¯†æ€§å’Œå®Œæ•´æ€§ã€‚å¦‚æœä½¿ç”¨å®¢æˆ·ç«¯è¯ä¹¦çš„è¯ï¼Œè¿˜å¯ä»¥åšä¸€å®šç¨‹åº¦çš„å®¢æˆ·ç«¯åˆæ³•æ€§çš„éªŒè¯ã€‚æ¯”å¦‚ä½ å¯ä»¥åœ¨äº‘ç«¯ä¸ºæ‰€æœ‰æœ‰æƒè®¿é—® KV server çš„å®¢æˆ·ç«¯ç­¾å‘å®¢æˆ·ç«¯è¯ä¹¦ï¼Œè¿™æ ·ï¼Œåªè¦å®¢æˆ·ç«¯çš„ç§é’¥ä¸æ³„éœ²ï¼Œå°±åªæœ‰æ‹¥æœ‰è¯ä¹¦çš„å®¢æˆ·ç«¯æ‰èƒ½è®¿é—® KV serverã€‚</p><p>ä¸çŸ¥é“ä½ ç°åœ¨æœ‰æ²¡æœ‰è§‰å¾—ï¼Œåœ¨ Rust ä¸‹ä½¿ç”¨ TLS æ˜¯éå¸¸æ–¹ä¾¿çš„ä¸€ä»¶äº‹æƒ…ã€‚å¹¶ä¸”ï¼Œæˆ‘ä»¬æ„å»ºçš„ ProstServerStream / ProstClientStreamï¼Œå› ä¸º<strong>æœ‰è¶³å¤Ÿå¥½çš„æŠ½è±¡ï¼Œå¯ä»¥åœ¨ TcpStream å’Œ TlsStream ä¹‹é—´æ¸¸åˆƒæœ‰ä½™åœ°åˆ‡æ¢</strong>ã€‚å½“ä½ æ„å»ºå¥½ç›¸å…³çš„ä»£ç ï¼Œåªéœ€è¦æŠŠ TcpStream æ¢æˆ TlsStreamï¼ŒKV server å°±å¯ä»¥æ— ç¼åˆ‡æ¢åˆ°ä¸€ä¸ªå®‰å…¨çš„ç½‘ç»œåè®®æ ˆã€‚</p><h3>æ€è€ƒé¢˜</h3><ol>\n<li>ç›®å‰æˆ‘ä»¬çš„ kvc / kvs åªåšäº†å•å‘çš„éªŒè¯ï¼Œå¦‚æœæœåŠ¡å™¨è¦éªŒè¯å®¢æˆ·ç«¯çš„è¯ä¹¦ï¼Œè¯¥æ€ä¹ˆåšï¼Ÿå¦‚æœä½ æ²¡æœ‰å¤´ç»ªï¼Œå¯ä»¥å†ä»”ç»†çœ‹çœ‹æµ‹è¯• TLS çš„ä»£ç ï¼Œç„¶åæ”¹åŠ¨ kvc/kvs ä½¿å¾—åŒå‘éªŒè¯ä¹Ÿèƒ½é€šè¿‡å§ã€‚</li>\n<li>é™¤äº† TLSï¼Œå¦å¤–ä¸€ä¸ªè¢«å¹¿æ³›ä½¿ç”¨çš„å¤„ç†åº”ç”¨å±‚å®‰å…¨çš„åè®®æ˜¯ <a href=\"https://noiseprotocol.org/\">noise protocol</a>ã€‚ä½ å¯ä»¥é˜…è¯»æˆ‘çš„<a href=\"https://zhuanlan.zhihu.com/p/96944134\">è¿™ç¯‡æ–‡ç« </a>äº†è§£ noise protocolã€‚Rust ä¸‹æœ‰ <a href=\"https://github.com/mcginty/snow\">snow</a> è¿™ä¸ªå¾ˆä¼˜ç§€çš„åº“å¤„ç† noise protocolã€‚å¯¹äºæœ‰ä½™åŠ›çš„åŒå­¦ï¼Œä½ ä»¬å¯ä»¥çœ‹çœ‹å®ƒçš„æ–‡æ¡£ï¼Œå°è¯•ç€å†™æ®µç±»ä¼¼ <a href=\"http://tls.rs\">tls.rs</a> çš„ä»£ç ï¼Œè®©æˆ‘ä»¬çš„ kvs / kvc å¯ä»¥ä½¿ç”¨ noise protocolã€‚</li>\n</ol><p>æ¬¢è¿åœ¨ç•™è¨€åŒºåˆ†äº«ä½ çš„æ€è€ƒï¼Œæ„Ÿè°¢ä½ çš„æ”¶å¬ï¼Œå¦‚æœä½ è§‰å¾—æœ‰æ”¶è·ï¼Œä¹Ÿæ¬¢è¿ä½ åˆ†äº«ç»™èº«è¾¹çš„æœ‹å‹ï¼Œé‚€ä»–ä¸€èµ·è®¨è®ºã€‚</p><p>æ­å–œä½ å®Œæˆäº†ç¬¬37æ¬¡æ‰“å¡ï¼Œæˆ‘ä»¬çš„Rustå­¦ä¹ ä¹‹æ—…å·²ç»è¿‡ä¸€å¤§åŠå•¦ï¼Œæ›™å…‰å°±åœ¨å‰æ–¹ï¼ŒåšæŒä¸‹å»ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ï½</p>","comments":[{"had_liked":false,"id":323019,"user_name":"ç½—åŒå­¦","can_delete":false,"product_type":"c1","uid":1649119,"ip_address":"","ucode":"909B9EC768B9AD","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/vHujib2CCrUYNBaia32eIwTyJoAcl27vASZ9KGjSdnH1dJhD7CrSUicBib19Tf8nDibWaHjzIsvIfdqcXX6vGrH8bicw/132","comment_is_top":false,"comment_ctime":1637710773,"is_pvip":false,"replies":[{"id":"118898","content":"TLS ä½¿ç”¨éå¯¹ç§°åŠ å¯†ï¼ˆæ¯”å¦‚ ECDHï¼‰æ¥åå•†å‡ºæœ¬æ¬¡ session çš„å¯†é’¥ã€‚é—®é¢˜æ˜¯å®¢æˆ·ç«¯å¦‚ä½•ä¿¡ä»»æœåŠ¡å™¨æä¾›çš„å…¬é’¥å°±æ˜¯æœåŠ¡å™¨æœ¬äººï¼Ÿæ­¤æ—¶éœ€è¦æœ‰äººå¯¹æœåŠ¡å™¨çš„å…¬é’¥è¿›è¡Œç­¾åï¼Œä¸ºå…¶èƒŒä¹¦ï¼Œè¿™ä¸ªèƒŒä¹¦ç€å°±æ˜¯ CAã€‚é‚£ CA åˆæ˜¯è°æ¥èƒŒä¹¦ï¼Ÿå° CA ç”±å¤§ CA èƒŒä¹¦ï¼Œå¤§ CA å†è¢« Root CA èƒŒä¹¦ã€‚å…¨ä¸–ç•Œä¹Ÿå°±å‡ ä¸ªåå‡ ä¸ª Root CAã€‚è¿™äº› Root CA ä¼šè¢«ä½ æ‰€ä½¿ç”¨çš„æ“ä½œç³»ç»Ÿä¿¡ä»»ã€‚è¿™æ ·ï¼ŒæŸä¸ªæœåŠ¡å™¨çš„è¯ä¹¦å°±å¯ä»¥è¢«ä¸€å±‚å±‚è¿½æº¯åˆ° Root CAï¼Œæœ€ç»ˆå®¢æˆ·ç«¯å¯ä»¥ä¿¡ä»»å®ƒã€‚è¿™æ˜¯ PKI ä½“ç³»çš„åŸºç¡€ã€‚æ‰€æœ‰çš„ç½‘ç«™ï¼Œå¦‚æœè¦æ”¯æŒ HTTPSï¼Œéƒ½éœ€è¦æœ‰ä¸€ä¸ªå—ä¿¡çš„è¯ä¹¦ã€‚ä»¥å‰éœ€è¦è´­ä¹°ï¼Œç°åœ¨æœ‰äº† letsencryptï¼ˆèƒŒåæœ‰ google çš„æ”¯æŒï¼‰ï¼Œæ‰€ä»¥å¯ä»¥å…è´¹å¾—åˆ°å—ä¿¡çš„è¯ä¹¦ã€‚<br><br>å½“ä½ æŠŠ TLS ç›´æ¥ç”¨åœ¨ TCP ä¹‹ä¸Šæ—¶ï¼Œå¯ä»¥è‡ªå·±ç”Ÿæˆ CA è¯ä¹¦ã€‚å› ä¸ºæ­¤åˆ»ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éƒ½æ˜¯ä½ è‡ªå·±çš„ä»£ç ï¼Œä½ å¯ä»¥åœ¨å®¢æˆ·ç«¯å†…ç½®ä¿¡ä»»çš„ CA è¯ä¹¦ï¼Œè¿™æ ·å°±å¯ä»¥ä¸ä¾èµ– PKI ä½“ç³»æ¥åœ¨æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ä¹‹é—´æ„å»ºå®‰å…¨ä¿¡é“ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1079375","ctime":1639851517,"ip_address":"","comment_id":323019,"utype":1}],"discussion_count":1,"race_medal":0,"score":"35997449141","product_id":100085301,"comment_content":"ca è¯ä¹¦å’Œ tlsä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿ<br>å¦å¤–ä¸ºä½•ä»¥å‰åšç½‘ç«™çš„æ—¶å€™è¯ä¹¦éƒ½è¦å‘è¿è¥å•†è´­ä¹°ç”³è¯·ï¼Ÿé‚£ä¸ªæ˜¯ä»€ä¹ˆè¯ä¹¦","like_count":9,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539859,"discussion_content":"TLS ä½¿ç”¨éå¯¹ç§°åŠ å¯†ï¼ˆæ¯”å¦‚ ECDHï¼‰æ¥åå•†å‡ºæœ¬æ¬¡ session çš„å¯†é’¥ã€‚é—®é¢˜æ˜¯å®¢æˆ·ç«¯å¦‚ä½•ä¿¡ä»»æœåŠ¡å™¨æä¾›çš„å…¬é’¥å°±æ˜¯æœåŠ¡å™¨æœ¬äººï¼Ÿæ­¤æ—¶éœ€è¦æœ‰äººå¯¹æœåŠ¡å™¨çš„å…¬é’¥è¿›è¡Œç­¾åï¼Œä¸ºå…¶èƒŒä¹¦ï¼Œè¿™ä¸ªèƒŒä¹¦ç€å°±æ˜¯ CAã€‚é‚£ CA åˆæ˜¯è°æ¥èƒŒä¹¦ï¼Ÿå° CA ç”±å¤§ CA èƒŒä¹¦ï¼Œå¤§ CA å†è¢« Root CA èƒŒä¹¦ã€‚å…¨ä¸–ç•Œä¹Ÿå°±å‡ ä¸ªåå‡ ä¸ª Root CAã€‚è¿™äº› Root CA ä¼šè¢«ä½ æ‰€ä½¿ç”¨çš„æ“ä½œç³»ç»Ÿä¿¡ä»»ã€‚è¿™æ ·ï¼ŒæŸä¸ªæœåŠ¡å™¨çš„è¯ä¹¦å°±å¯ä»¥è¢«ä¸€å±‚å±‚è¿½æº¯åˆ° Root CAï¼Œæœ€ç»ˆå®¢æˆ·ç«¯å¯ä»¥ä¿¡ä»»å®ƒã€‚è¿™æ˜¯ PKI ä½“ç³»çš„åŸºç¡€ã€‚æ‰€æœ‰çš„ç½‘ç«™ï¼Œå¦‚æœè¦æ”¯æŒ HTTPSï¼Œéƒ½éœ€è¦æœ‰ä¸€ä¸ªå—ä¿¡çš„è¯ä¹¦ã€‚ä»¥å‰éœ€è¦è´­ä¹°ï¼Œç°åœ¨æœ‰äº† letsencryptï¼ˆèƒŒåæœ‰ google çš„æ”¯æŒï¼‰ï¼Œæ‰€ä»¥å¯ä»¥å…è´¹å¾—åˆ°å—ä¿¡çš„è¯ä¹¦ã€‚\n\nå½“ä½ æŠŠ TLS ç›´æ¥ç”¨åœ¨ TCP ä¹‹ä¸Šæ—¶ï¼Œå¯ä»¥è‡ªå·±ç”Ÿæˆ CA è¯ä¹¦ã€‚å› ä¸ºæ­¤åˆ»ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éƒ½æ˜¯ä½ è‡ªå·±çš„ä»£ç ï¼Œä½ å¯ä»¥åœ¨å®¢æˆ·ç«¯å†…ç½®ä¿¡ä»»çš„ CA è¯ä¹¦ï¼Œè¿™æ ·å°±å¯ä»¥ä¸ä¾èµ– PKI ä½“ç³»æ¥åœ¨æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ä¹‹é—´æ„å»ºå®‰å…¨ä¿¡é“ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639851517,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":345672,"user_name":"æ–°æ–°äººç±»","can_delete":false,"product_type":"c1","uid":2912722,"ip_address":"","ucode":"97EACC93996CCB","user_header":"","comment_is_top":false,"comment_ctime":1652501714,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1652501714","product_id":100085301,"comment_content":"æ€è€ƒé¢˜1: å°† ServerConfig çš„ ClientCertVerifier æ”¹æˆ AllowAnyAuthenticatedClient<br><br>pub fn new(cert: &amp;str, key: &amp;str, client_ca: Option&lt;&amp;str&gt;) -&gt; Result&lt;Self, KvError&gt; {<br>    let certs = load_certs(cert)?;<br>    let key = load_key(key)?;<br><br>    let mut root_store = match rustls_native_certs::load_native_certs() {<br>      Ok(store) | Err((Some(store), _)) =&gt; store,<br>      Err((None, err)) =&gt; {<br>        return Err(err.into());<br>      }<br>    };<br>    &#47;&#47; å¦‚æœæœ‰ç­¾ç½²å®¢æˆ·ç«¯çš„ CA è¯ä¹¦ï¼Œåˆ™åŠ è½½å®ƒï¼Œè¿™æ ·å®¢æˆ·ç«¯è¯ä¹¦ä¸åœ¨æ ¹è¯ä¹¦é“¾<br>    &#47;&#47; ä½†æ˜¯è¿™ä¸ª CA è¯ä¹¦èƒ½éªŒè¯å®ƒï¼Œä¹Ÿå¯ä»¥<br>    if let Some(cert) = client_ca {<br>      let mut buf = Cursor::new(cert);<br>      root_store.add_pem_file(&amp;mut buf).unwrap();<br>    }<br>    &#47;&#47; åŠ è½½ server cert &#47; CA certï¼Œç”Ÿæˆ ServerConfig<br>    let mut config = ServerConfig::new(AllowAnyAuthenticatedClient::new(root_store));<br><br>    &#47;&#47; åŠ è½½æœåŠ¡å™¨è¯ä¹¦<br>    config<br>      .set_single_cert(certs, key)<br>      .map_err(|_| KvError::CertificateParseError(&quot;server&quot;, &quot;cert&quot;))?;<br>    config.set_protocols(&amp;[Vec::from(&amp;ALPN_KV[..])]);<br><br>    Ok(Self {<br>      inner: Arc::new(config),<br>    })<br>  }","like_count":0},{"had_liked":false,"id":323066,"user_name":"ç½—æ°","can_delete":false,"product_type":"c1","uid":1320487,"ip_address":"","ucode":"96BAFAA147341F","user_header":"https://static001.geekbang.org/account/avatar/00/14/26/27/eba94899.jpg","comment_is_top":false,"comment_ctime":1637718304,"is_pvip":false,"replies":[{"id":"118896","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1079375","ctime":1639850786,"ip_address":"","comment_id":323066,"utype":1}],"discussion_count":1,"race_medal":2,"score":"1637718304","product_id":100085301,"comment_content":"ç”Ÿæˆè¯ä¹¦è¿™å—æ˜¯æˆ‘æ¯”è¾ƒæ¬ ç¼ºçš„çŸ¥è¯†ï¼Œå¯ä»¥å¥½å¥½è¡¥å……ä¸€ä¸‹äº†ã€‚","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539857,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639850787,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}