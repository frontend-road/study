{"id":806951,"title":"13ï½œå®šä½MySQLé—®é¢˜çš„æ€è·¯ï¼šæ•°æ®åº“ä¸ºä»€ä¹ˆæ…¢äº†ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯ä¿Šè¾¾ã€‚</p><p>ä½œä¸ºä¸€åDBAï¼Œåœ¨ä½¿ç”¨å’Œè¿ç»´MySQLçš„åå¤šå¹´é‡Œï¼Œæˆ‘é‡åˆ°è¿‡å¾ˆå¤šå„ç§å„æ ·çš„é—®é¢˜ï¼Œæ¯”å¦‚ï¼š</p><ul>\n<li>å¹³æ—¶æ‰§è¡Œå¾ˆæ­£å¸¸çš„ä¸€äº›SQLï¼Œä¸çŸ¥é“ä»€ä¹ˆåŸå› ï¼Œçªç„¶éƒ½å˜æ…¢äº†ã€‚</li>\n<li>æ•°æ®åº“å˜å¾—å¾ˆæ…¢ï¼Œå°±æ˜¯è¿æ¥åˆ°æ•°æ®åº“è¿™ä¹ˆç®€å•çš„æ“ä½œéƒ½éœ€è¦å¥½å‡ ç§’ï¼Œæœ‰æ—¶ç”šè‡³ä¼šè¶…æ—¶ã€‚</li>\n<li>åº”ç”¨ç³»ç»Ÿå‘å¸ƒäº†æ–°çš„ç‰ˆæœ¬ï¼ŒSQLå¥½åƒä¹Ÿæ²¡æœ‰åšå¤§çš„è°ƒæ•´ï¼Œä½†æ˜¯æ•°æ®åº“è´Ÿè½½å°±æ˜¯ä¸Šæ¶¨äº†å¾ˆå¤šã€‚</li>\n<li>æ‰§è¡ŒæŸä¸ªSQLä¸ºä»€ä¹ˆéœ€è¦èŠ±è¿™ä¹ˆé•¿çš„æ—¶é—´ï¼Œæ€»é€‰ä¸åˆ°æ›´å¥½çš„æ‰§è¡Œè®¡åˆ’ã€‚</li>\n</ul><p>è¿™äº›éƒ½æ˜¯æ¯”è¾ƒå¸¸è§çš„æƒ…å†µï¼Œä½ å¹³æ—¶åœ¨ä½¿ç”¨MySQLæ—¶ï¼Œæ˜¯å¦ä¹Ÿé‡åˆ°è¿‡ç±»ä¼¼çš„é—®é¢˜å‘¢ï¼Ÿåœ¨è¿™ä¸€è®²ä¸­ï¼Œæˆ‘ä»¬å°†æä¾›ä¸€äº›æ¯”è¾ƒé€šç”¨çš„æ–¹æ³•ï¼Œç”¨æ¥åˆ†æå’Œå®šä½MySQLçš„å„ç§æ€§èƒ½é—®é¢˜ã€‚</p><h2>é€šç”¨é—®é¢˜åˆ†ææ¡†æ¶</h2><p>æŠŠå¤§è±¡æ”¾å…¥å†°ç®±åªéœ€è¦å‡ ä¸ªç®€å•çš„æ­¥éª¤ï¼šä¸€æ˜¯æ‰“å¼€å†°ç®±é—¨ï¼ŒäºŒæ˜¯å°†å¤§è±¡æ”¾å…¥å†°ç®±ï¼Œä¸‰æ˜¯å…³ä¸Šå†°ç®±é—¨ã€‚åœ¨åˆ†æMySQLç›¸å…³é—®é¢˜æ—¶ï¼Œæˆ‘ä»¬ä¹Ÿé‡‡å–ç±»ä¼¼çš„æ­¥éª¤ï¼Œé¦–å…ˆï¼Œäº†è§£é—®é¢˜ï¼Œç„¶ååˆ†æMySQLè¿è¡Œç¯å¢ƒçš„é—®é¢˜ï¼Œå†åˆ†æMySQLæ•°æ®åº“ï¼Œæœ€ååˆ†æè®¿é—®æ•°æ®åº“çš„å®¢æˆ·ç«¯çš„é—®é¢˜ã€‚</p><h3>äº†è§£é—®é¢˜æœ¬èº«</h3><p>åœ¨æ­£å¼å¼€å§‹è§£å†³é—®é¢˜ä¹‹å‰ï¼Œä½ éœ€è¦å…ˆäº†è§£é—®é¢˜æœ¬èº«ã€‚</p><ul>\n<li>é—®é¢˜æ˜¯ä¸æ˜¯æ­£åœ¨å‘ç”Ÿï¼Ÿæ˜¯å½“å‰æœ‰é—®é¢˜ï¼Œè¿˜æ˜¯è¿‡å»æŸäº›æ—¶é—´å‡ºç°äº†é—®é¢˜ï¼Ÿ</li>\n<li>æ”¶é›†é—®é¢˜çš„è¯¦ç»†ä¿¡æ¯ã€‚é—®é¢˜çš„ç°è±¡æ˜¯ä»€ä¹ˆï¼Œé—®é¢˜å‡ºç°çš„æ—¶é—´æœ‰ä»€ä¹ˆè§„å¾‹å—ï¼Ÿ</li>\n<li>å¦‚æœæœ‰æŠ¥é”™ï¼Œè®°å½•è¯¦ç»†çš„æŠ¥é”™ä¿¡æ¯ï¼Œç‰¹åˆ«æ˜¯è·Ÿæ•°æ®åº“ç›¸å…³çš„æŠ¥é”™ä¿¡æ¯ï¼Œå¦‚é”™è¯¯ç¼–å·ã€é”™è¯¯æ–‡æœ¬ã€‚</li>\n</ul><!-- [[[read_end]]] --><h3>åˆ†ææ“ä½œç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ</h3><p>MySQLè¿è¡Œåœ¨å…·ä½“çš„æ“ä½œç³»ç»Ÿç¯å¢ƒä¸­ï¼Œå…¶è¿è¡Œæ•ˆç‡å—é™äºåº•å±‚æ“ä½œç³»ç»Ÿå’Œç¡¬ä»¶ç¯å¢ƒã€‚ä¸€èˆ¬æˆ‘ä»¬éœ€è¦åˆ†ææ“ä½œç³»ç»Ÿçš„å‡ å¤§æ ¸å¿ƒèµ„æºï¼ˆCPUã€å†…å­˜ã€IOã€æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œï¼‰çš„ä½¿ç”¨æƒ…å†µã€‚å…³äºæ“ä½œç³»ç»Ÿå„å¤§èµ„æºå¦‚ä½•åˆ†æï¼Œé‡Œé¢çš„å†…å®¹æ¯”è¾ƒå¤šï¼Œæˆ‘ä¼šåœ¨åç»­çš„è¯¾ç¨‹ä¸­å•ç‹¬å±•å¼€ç»†èŠã€‚</p><h3>åˆ†æMySQLè¿è¡Œæƒ…å†µ</h3><h4>ProcessList</h4><p>MySQLæ˜¯ä¸€ä¸ªå¤šçº¿ç¨‹æœåŠ¡å™¨ï¼ŒæœåŠ¡ç«¯ä¼šåˆ›å»ºæœåŠ¡çº¿ç¨‹æ¥æ‰§è¡Œå®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„å‘½ä»¤æˆ–SQLã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å‘½ä»¤show processlistæˆ–æŸ¥è¯¢information_schema.processlistè¡¨æ¥è·å–MySQLä¸­æ‰€æœ‰ä¼šè¯çš„å½“å‰çŠ¶æ€ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒæŸ¥çœ‹Processlistéœ€è¦ä¸€å®šçš„æƒé™ã€‚å¦‚æœæ‰§è¡Œå‘½ä»¤çš„è´¦å·ç¼ºå°‘Processæƒé™ï¼Œå°±æ— æ³•æŸ¥çœ‹å®Œæ•´çš„Processlistã€‚ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨user1è´¦å·ç™»å½•æ•°æ®åº“ï¼Œåªçœ‹åˆ°user1è´¦å·åˆ›å»ºçš„ä¼šè¯ã€‚</p><pre><code class=\"language-go\">mysql&gt; show processlist;\n+-----+-------+-----------------+------+---------+------+-------+------------------+\n| Id  | User  | Host            | db   | Command | Time | State | Info             |\n+-----+-------+-----------------+------+---------+------+-------+------------------+\n| 166 | user1 | localhost:53004 | NULL | Query   |    0 | init  | show processlist |\n+-----+-------+-----------------+------+---------+------+-------+------------------+\n</code></pre><p>å¦‚æœæƒ³çœ‹åˆ°æ‰€æœ‰çš„ä¼šè¯ï¼Œå°±éœ€è¦å°†Processæƒé™æˆæƒç»™user1è´¦å·ã€‚</p><pre><code class=\"language-go\">mysql&gt; grant process  on *.* to 'user1'@'%';\nQuery OK, 0 rows affected (0.54 sec)\n</code></pre><p>è·å¾—æˆæƒåï¼Œå°±å¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„ä¼šè¯ä¿¡æ¯äº†ã€‚</p><pre><code class=\"language-go\">mysql&gt; show processlist;\n+-----+-----------------+-----------------+------+---------+---------+----------------------------------------------------------+------------------+\n| Id  | User            | Host            | db   | Command | Time    | State                                                    | Info             |\n+-----+-----------------+-----------------+------+---------+---------+----------------------------------------------------------+------------------+\n|  11 | event_scheduler | localhost       | NULL | Daemon  | 1835399 | Waiting on empty queue                                   | NULL             |\n|  21 | system user     | connecting host | NULL | Connect | 1833985 | Waiting for source to send event                         | NULL             |\n|  22 | system user     |                 | NULL | Query   |  362966 | Replica has read all relay log; waiting for more updates | NULL             |\n|  23 | system user     |                 | NULL | Query   |  362967 | Waiting for an event from Coordinator                    | NULL             |\n|  24 | system user     |                 | NULL | Connect | 1833985 | Waiting for an event from Coordinator                    | NULL             |\n|  25 | system user     |                 | NULL | Connect | 1833985 | Waiting for an event from Coordinator                    | NULL             |\n|  26 | system user     |                 | NULL | Connect | 1833985 | Waiting for an event from Coordinator                    | NULL             |\n| 158 | root            | localhost:51312 | rep  | Sleep   |       7 |                                                          | NULL             |\n| 161 | root            | localhost:52470 | NULL | Sleep   |     686 |                                                          | NULL             |\n| 167 | user1           | localhost:53118 | NULL | Query   |       0 | init                                                     | show processlist |\n+-----+-----------------+-----------------+------+---------+---------+----------------------------------------------------------+------------------+\n</code></pre><p>ä»ProcessListå¯ä»¥è·å–åˆ°è¿™äº›ä¿¡æ¯ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/db/73/db54c2823039988bbded4035ef1a1373.png?wh=1920x1459\" alt=\"å›¾ç‰‡\"></p><p>æ­£å¼çš„ç¯å¢ƒä¸­ï¼ŒProcesslistå¯èƒ½ä¼šåŒ…å«ä¸Šåƒä¸ªä¼šè¯ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€äº›å·¥å…·å¯¹è¾“å‡ºè¿›è¡Œæ±‡æ€»ï¼Œä¾¿äºåˆ¤æ–­é—®é¢˜ã€‚ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨MySQLè‡ªå¸¦å®¢æˆ·ç«¯çš„åŠŸèƒ½ï¼Œå®ç°æŒ‰Stateç»Ÿè®¡ä¼šè¯æ•°é‡ã€‚</p><pre><code class=\"language-go\">mysql&gt; pager grep State | awk -F':' '{print $2}' | sort  | uniq -c | sort -nr\nPAGER set to 'grep State | awk -F':' '{print $2}' | sort  | uniq -c | sort -nr'\n\nmysql&gt; show processlist\\G\n      4  Waiting for an event from Coordinator\n      2  Searching rows for update\n      1  Waiting on empty queue\n      1  Waiting for source to send event\n      1  Replica has read all relay log; waiting for more updates\n      1  init\n      1\n</code></pre><p>Processlistè¾“å‡ºä¸­çš„Stateå­—æ®µæä¾›äº†ä¼šè¯å½“å‰å¤„äºå“ªä¸ªçŠ¶æ€çš„ä¸€äº›å†…éƒ¨ä¿¡æ¯ï¼Œå®è·µä¸­æˆ‘ä»¬ç»å¸¸ä¼šæ ¹æ®ä¼šè¯çš„Stateæ¥åˆ¤æ–­é—®é¢˜çš„å¤§è‡´æ–¹å‘ã€‚ä¸‹é¢è¡¨æ ¼æä¾›äº†æ¯”è¾ƒå¸¸è§çš„ä¸€äº›stateçš„å«ä¹‰å’Œå¯èƒ½çš„åŸå› ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/da/ef/daf1e0abdf4ea4787be1cd56b18de0ef.jpg?wh=1920x2039\" alt=\"å›¾ç‰‡\"></p><p>ä¼šè¯åœ¨ä¸€ä¸ªstateä¸‹ï¼Œå¯èƒ½ä¼šè¿›è¡Œå¾ˆå¤šä¸åŒçš„æ“ä½œï¼Œå•å‡­ä¸€ä¸ªçŠ¶æ€å€¼æ— æ³•ç²¾ç¡®åœ°åˆ¤æ–­MySQLåˆ°åº•åœ¨æ‰§è¡Œæˆ–ç­‰å¾…ä»€ä¹ˆã€‚æœ‰æ—¶å€™æˆ‘ä»¬ä¹Ÿä¼šä½¿ç”¨pstackæ”¶é›†mysqldè¿›ç¨‹é‡Œå„ä¸ªçº¿ç¨‹çš„è°ƒç”¨æ ˆã€‚é€šè¿‡è°ƒç”¨æ ˆå¯ä»¥æ›´åŠ ç²¾ç¡®åœ°åˆ¤æ–­MySQLå½“å‰è¿è¡ŒçŠ¶æ€ã€‚ä¸è¿‡ä½¿ç”¨pstackè¦ç‰¹åˆ«è°¨æ…ï¼Œå› ä¸ºè¿™ä¼šä¸¥é‡å½±å“MySQLçš„æ€§èƒ½ã€‚åœ¨MySQLå·²ç»å¡æ­»çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨pstackå¯ä»¥æ”¶é›†åˆ°å¯¹è¯Šæ–­é—®é¢˜å¾ˆå…³é”®çš„ä¿¡æ¯ï¼Œè¿™æ—¶å¯ä»¥é€‚å½“ä½¿ç”¨pstackã€‚</p><p>åœ¨performance_schema.threadsè¡¨ä¸­ï¼Œä¹Ÿå¯ä»¥è·å–åˆ°ç±»ä¼¼çš„ä¿¡æ¯ï¼Œä»¥åŠæ›´å¤šçš„ä¸€äº›ä¿¡æ¯ï¼Œå¦‚OSçº¿ç¨‹å·ã€çº¿ç¨‹ä½¿ç”¨äº†å¤šå°‘å†…å­˜ã€‚</p><h4>æ…¢æ—¥å¿—</h4><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡processlistæŸ¥çœ‹MySQLåœ¨æŸä¸€ä¸ªæ—¶é—´ç‚¹ä¸Šæ•°æ®åº“å†…å„ä¸ªä¼šè¯çš„è¿è¡Œæƒ…å†µã€‚ä½†å¦‚æœä¸€ä¸ªSQLæ‰§è¡Œæ²¡æœ‰é‚£ä¹ˆæ…¢ï¼Œä½¿ç”¨Processlistå¯èƒ½å°±æŠ“ä¸åˆ°ã€‚è€Œæ…¢æ—¥å¿—å¯ä»¥å°†æ‰§è¡Œè¶…è¿‡ä¸€å®šæ—¶é—´çš„SQLéƒ½è®°å½•ä¸‹æ¥ã€‚æˆ‘ä»¬å»ºè®®éƒ½å¼€å¯æ…¢æ—¥å¿—ã€‚ä»¥ä¸‹æ˜¯å¼€å¯æ…¢æ—¥å¿—çš„æœ€åŸºæœ¬çš„å‚æ•°ã€‚</p><pre><code class=\"language-go\">slow_query_log=ON\nslow_query_log_file=/path/to/slow.log\nlong_query_time=3\n</code></pre><p>æ‰§è¡Œæ—¶é—´è¶…è¿‡long_query_timeçš„SQLä¼šè®°å½•åˆ°æ…¢æ—¥å¿—ä¸­ã€‚è¿™ä¸ªå‚æ•°å¯ä»¥è®¾ç½®ä¸º0ï¼Œä¹Ÿå°±æ˜¯è®°å½•æ‰€æœ‰SQLã€‚å¦‚æœSQLçš„æ‰§è¡Œé¢‘ç‡æ¯”è¾ƒé«˜ï¼Œè¿™ä¹ˆè®¾ç½®ä¼šäº§ç”Ÿå¤§é‡æ—¥å¿—ã€‚æˆ‘ä»¬å¯ä»¥æ ¹æ®ä¸šåŠ¡çš„å…·ä½“è¦æ±‚æ¥è®¾ç½®åˆé€‚çš„long_query_timeå€¼ã€‚è¯¥å‚æ•°å¯ä»¥åŠ¨æ€ä¿®æ”¹ï¼Œä½†æ˜¯MySQLç¤¾åŒºç‰ˆä¸­ï¼Œè¿™ä¸ªå‚æ•°ä¿®æ”¹ååªå¯¹æ–°åˆ›å»ºçš„ä¼šè¯ç”Ÿæ•ˆã€‚</p><p>æ…¢æ—¥å¿—ä¸­è®°å½•äº†è€—æ—¶è¾ƒé•¿çš„SQLçš„ä¸€äº›æŒ‡æ ‡ï¼Œæœ€é‡è¦çš„æŒ‡æ ‡åŒ…æ‹¬ï¼š</p><ul>\n<li>Query_timeï¼šSQLè€—æ—¶ï¼Œå•ä½æ˜¯ç§’ã€‚</li>\n<li>Lock Timeï¼šè·å–è¡Œé”è€—æ—¶ï¼Œå•ä½æ˜¯ç§’ã€‚</li>\n<li>Rows_sentï¼šå‘é€ç»™å®¢æˆ·ç«¯çš„è®°å½•æ•°ã€‚</li>\n<li>Rows_examinedï¼šMySQLæœåŠ¡ç«¯ä»å­˜å‚¨å¼•æ“å±‚è¯»å–çš„è®°å½•æ•°ã€‚</li>\n<li>Timeï¼šSQLå®Œæˆæ‰§è¡Œçš„æ—¶é—´ã€‚æœ‰æ—¶æˆ‘ä»¬æ›´å…³å¿ƒæ…¢SQLå¼€å§‹æ‰§è¡Œçš„æ—¶é—´ã€‚Timeå‡å»Query_timeåå¯ä»¥å¾—åˆ°SQLå¼€å§‹æ‰§è¡Œçš„æ—¶é—´ã€‚</li>\n</ul><p>ä¸‹é¢æ˜¯ç¤¾åŒºç‰ˆMySQLæ…¢æ—¥å¿—çš„ä¸€ä¸ªæ ·ä¾‹ï¼Œä½ å¯ä»¥çœ‹ä¸€ä¸‹ã€‚</p><pre><code class=\"language-go\"># Time: 2024-06-12T08:46:32.839775Z\n# User@Host: root[root] @ localhost [127.0.0.1]  Id:   267\n# Query_time: 25.032283  Lock_time: 0.000013 Rows_sent: 0  Rows_examined: 1\nSET timestamp=1718181967;\nupdate ty set d=d+1 where a=10;\n</code></pre><p>è®°å½•åœ¨æ…¢æ—¥å¿—ä¸­çš„SQLï¼Œæœ‰çš„æ˜¯å› ä¸ºSQLæ‰§è¡Œæ•ˆç‡ç¡®å®æ¯”è¾ƒå·®ï¼Œæœ‰çš„å¯èƒ½æ˜¯å› ä¸ºæœåŠ¡å™¨æ•´ä½“å˜æ…¢äº†æ‰å¯¼è‡´SQLæ‰§è¡Œå˜æ…¢ï¼Œæœ‰çš„æ˜¯å› ä¸ºç­‰å¾…å…¨å±€é”ã€å…ƒæ•°æ®é”æˆ–è¡Œé”æ‰æ‰§è¡Œæ…¢ã€‚å¦‚ä½•åŒºåˆ†è¿™å‡ ç§ä¸åŒçš„æƒ…å†µå‘¢ï¼Ÿ</p><p>é¦–å…ˆè¦è§‚å¯Ÿæ…¢SQLçš„å‡ ä¸ªæŒ‡æ ‡ï¼Œç‰¹åˆ«æ˜¯ <strong>Rows_examined</strong>ã€‚ä¸€èˆ¬çœŸæ­£çš„æ…¢SQLï¼ŒRows_examinedæŒ‡æ ‡ä¼šæ¯”è¾ƒé«˜ã€‚å¦‚æœæ˜¯è¡Œé”çš„é—®é¢˜å¼•èµ·çš„ï¼ŒLock_timeæŒ‡æ ‡å¯èƒ½ä¼šæ¯”è¾ƒå¤§ã€‚å¦‚æœRows_examinedå¾ˆå°ï¼ŒLock_timeä¹Ÿå¾ˆå°ï¼Œä½†SQLæ‰§è¡Œæ—¶é—´æ¯”è¾ƒé•¿ï¼Œéœ€è¦è§‚å¯Ÿä¸‹å‡ºç°æ…¢SQLæ—¶æœåŠ¡å™¨çš„æ•´ä½“è´Ÿè½½æƒ…å†µã€‚</p><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥è€ƒè™‘å¼€å¯log_slow_extraï¼Œè¿™æ ·æ…¢SQLä¸­ä¼šè®°å½•æ›´è¯¦ç»†çš„ä¿¡æ¯ã€‚</p><pre><code class=\"language-go\"># Time: 2024-06-12T09:15:00.262670Z\n# User@Host: root[root] @ localhost [127.0.0.1]  Id:   266\n# Query_time: 83.324812  Lock_time: 0.000058 Rows_sent: 10  Rows_examined: 150010 Thread_id: 266 Errno: 0 Killed: 0 Bytes_received: 78 Bytes_sent: 1468 Read_first: 2 Read_last: 0 Read_key: 2 Read_next: 0 Read_prev: 0 Read_rnd: 0 Read_rnd_next: 363459 Sort_merge_passes: 13 Sort_range_count: 0 Sort_rows: 10 Sort_scan_count: 1 Created_tmp_disk_tables: 1 Created_tmp_tables: 1 Start: 2024-06-12T09:13:36.937858Z End: 2024-06-12T09:15:00.262670Z\nSET timestamp=1718183616;\nselect * from (select * from tab3 limit 150000) t order by b,a limit 10;\n</code></pre><p>å¦‚æœæ…¢SQLå¤ªå¤šäº†ï¼Œæˆ‘ä»¬è¦å€ŸåŠ©ä¸€äº›å·¥å…·å¯¹æ—¥å¿—è¿›è¡Œç»Ÿè®¡åˆ†æã€‚Perconaå…¬å¸å‡ºå“çš„pt-query-digestå°±æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å·¥å…·ã€‚å¦‚æœä½ æœ‰å¤§é‡çš„æ…¢SQLéœ€è¦åˆ†æï¼Œå¯ä»¥å°è¯•ä½¿ç”¨è¿™ä¸ªå·¥å…·ã€‚</p><p>å¯¹äºä¸€ä¸ªå…·ä½“çš„æŸ¥è¯¢è¯­å¥ï¼Œå¯ä»¥åˆ°ä¸€ä¸ªæœåŠ¡å™¨èµ„æºæ¯”è¾ƒç©ºé—²çš„ç¯å¢ƒä¸‹ï¼ˆæ¯”å¦‚åœ¨å¤‡åº“ä¸Šï¼‰è¿›è¡Œåˆ†æï¼ŒæŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ã€‚å¦‚æœæ˜¯UPDATEæˆ–DELETEè¯­å¥ï¼Œä½ å¯ä»¥æ ¹æ®åŸè¯­å¥çš„WHEREæ¡ä»¶ï¼Œå°†SQLæ”¹æˆSELECTåæµ‹è¯•æŸ¥è¯¢çš„æ•ˆç‡ã€‚MySQLåœ¨æ›´æ–°æˆ–åˆ é™¤ä¸€è¡Œæ•°æ®æ—¶ï¼Œéœ€è¦å…ˆå®šä½åˆ°è¿™è¡Œæ•°æ®ï¼Œå¦‚æœå®šä½æ•°æ®çš„è€—æ—¶è¾ƒé«˜ï¼Œé‚£æ›´æ–°æˆ–åˆ é™¤è‡ªç„¶ä¹Ÿä¼šæ…¢ã€‚å…³äºSQLä¼˜åŒ–çš„å…·ä½“æ–¹æ³•ï¼Œåç»­è¯¾ç¨‹ä¸­æˆ‘ä»¬ä¼šåšæ›´è¯¦ç»†çš„è®²è§£ã€‚</p><h4>Performance Schema</h4><p>æœ‰äº›æƒ…å†µä¸‹ï¼Œæ¯”å¦‚ä½¿ç”¨äº†äº‘å‚å•†æä¾›çš„äº‘æ•°æ®åº“ï¼Œä½ å¯èƒ½æ²¡æœ‰æƒé™ç›´æ¥è·å–æ…¢æ—¥å¿—æ–‡ä»¶ï¼Œæˆ–è€…SQLæ‰§è¡Œæ—¶é—´æ²¡æœ‰è¶…è¿‡long_query_timeï¼Œä½ å¯ä»¥ä½¿ç”¨performance schemaï¼Œå½“ç„¶å‰ææ˜¯å¼€å¯äº†performance schemaã€‚</p><pre><code class=\"language-go\">mysql&gt; select * from events_statements_summary_by_digest where digest_text like '%t_prop%' order by SUM_ROWS_EXAMINED desc limit 100\\G\n*************************** 1. row ***************************\n                SCHEMA_NAME: rep\n                     DIGEST: 58fddf65d882f69efcd30fb2f9136010a6c9bd9db54a0b2ef7a54c6448dfcfa1\n                DIGEST_TEXT: SELECT COUNT ( * ) FROM `t_prop` WHERE `pid` + ? = ?\n                 COUNT_STAR: 798588\n             SUM_TIMER_WAIT: 65079266039023000\n             MIN_TIMER_WAIT: 1975837000\n             AVG_TIMER_WAIT: 81492917000\n             MAX_TIMER_WAIT: 798614957000\n              SUM_LOCK_TIME: 67559675000000\n              SUM_ROWS_SENT: 798578\n          SUM_ROWS_EXAMINED: 240372580\n...\n            SUM_SELECT_SCAN: 798588\n      MAX_CONTROLLED_MEMORY: 46416\n           MAX_TOTAL_MEMORY: 25269935\n...\n                 FIRST_SEEN: 2024-06-11 14:21:02.361871\n                  LAST_SEEN: 2024-06-12 17:46:01.910352\n                QUANTILE_95: 199526231496\n                QUANTILE_99: 275422870333\n               QUANTILE_999: 380189396320\n          QUERY_SAMPLE_TEXT: select count(*) from t_prop where pid+0 = 66\n          QUERY_SAMPLE_SEEN: 2024-06-12 17:45:28.662619\n    QUERY_SAMPLE_TIMER_WAIT: 599478717000\n</code></pre><p>performance schemaä¸­çš„è¡¨ï¼Œæ¯”å¦‚events_statements_summary_by_digestï¼Œè®°å½•äº†è¯­å¥æ‰§è¡Œçš„æ±‡æ€»ä¿¡æ¯ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦æŸ¥è¯¢2æ¬¡ï¼Œè®¡ç®—ä¸­é—´çš„å·®å€¼ï¼Œå¾—åˆ°è¯­å¥åœ¨ä¸€ä¸ªæ—¶é—´æ®µå†…çš„æ‰§è¡Œæƒ…å†µã€‚</p><p>ä¹Ÿæœ‰çš„äº‘å‚å•†æœ¬èº«å°±æä¾›äº†å…¨é‡SQLåˆ†æçš„åŠŸèƒ½ï¼Œéœ€è¦æ—¶ä¹Ÿå¯ä»¥ä½¿ç”¨ã€‚ä¸ç®¡ä½¿ç”¨ä»€ä¹ˆå·¥å…·ï¼Œé‡ç‚¹æ˜¯èƒ½è·å–æ•°æ®åº“ä¸­æ‰§è¡Œäº†å“ªäº›SQLï¼Œåˆ†åˆ«è€—è´¹äº†å¤šå°‘æ—¶é—´ã€‚ä¼˜åŒ–æ—¶ä¼˜å…ˆå¤„ç†é‚£äº›è€—æ—¶é•¿ã€æ¶ˆè€—èµ„æºå¤šçš„SQLã€‚</p><h4>InnoDBå­˜å‚¨å¼•æ“çŠ¶æ€</h4><p>å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å»ºè®®åªä½¿ç”¨InnoDBå­˜å‚¨å¼•æ“ã€‚InnoDBæ”¯æŒäº‹åŠ¡ï¼Œå¯ä»¥ä¿è¯æ•°æ®ä¸ä¸¢ï¼Œè€Œä¸”æœ‰å¾ˆå¥½çš„é«˜å¹¶å‘æ”¯æŒã€‚æœ‰æ—¶å› ä¸ºInnoDBå†…éƒ¨å®ç°æœºåˆ¶çš„åŸå› ï¼Œä¹Ÿä¼šå¯¹æ•°æ®åº“çš„æ€§èƒ½æœ‰ä¸€å®šçš„å½±å“ã€‚å¯ä»¥é€šè¿‡ä¸€äº›å‘½ä»¤è·å–InnoDBå¼•æ“çš„è¿è¡ŒæŒ‡æ ‡ï¼Œè§‚å¯ŸInnoDBçš„æ•´ä½“è¿è¡Œæƒ…å†µã€‚</p><p>Show engine innodb statuså°±æ˜¯å¹³æ—¶æ¯”è¾ƒå¸¸ç”¨çš„ä¸€ä¸ªå‘½ä»¤ï¼Œå¯ä»¥è·å–InnoDBå†…éƒ¨çš„å¾ˆå¤šæŒ‡æ ‡ï¼Œå½“ç„¶è§£è¯»è¿™äº›æŒ‡æ ‡éœ€è¦å¯¹InnoDBçš„è¿è¡Œæœºåˆ¶æœ‰ä¸€äº›å…·ä½“çš„ç†è§£ã€‚InnoDBè¿è¡Œæœºåˆ¶åç»­æˆ‘ä»¬ä¼šåšæ›´æ·±å…¥çš„è§£æã€‚è¿™é‡Œå…ˆå¯¹å‘½ä»¤çš„ä¸»è¦è¾“å‡ºåšä¸€äº›ç®€å•çš„ä»‹ç»ã€‚</p><ul>\n<li>ä¿¡å·é‡å’Œé—©é”ä¿¡æ¯ï¼ˆLatchï¼‰ï¼Œè¿™äº›æ˜¯InnoDBå†…éƒ¨ç”¨æ¥æ§åˆ¶å¹¶å‘çš„ä¸€ç§æœºåˆ¶ã€‚é«˜å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œè¿™é‡Œå¯èƒ½ä¼šå‡ºç°æ¯”è¾ƒé«˜çš„äº‰ç”¨ã€‚</li>\n</ul><pre><code class=\"language-go\">----------\nSEMAPHORES\n----------\n-------------\nRW-LATCH INFO\n-------------\nTotal number of rw-locks 16997\nOS WAIT ARRAY INFO: reservation count 792834\nOS WAIT ARRAY INFO: signal count 191788\nRW-shared spins 0, rounds 0, OS waits 0\nRW-excl spins 0, rounds 0, OS waits 0\nRW-sx spins 0, rounds 0, OS waits 0\nSpin rounds per wait: 0.00 RW-shared, 0.00 RW-excl, 0.00 RW-sx\n</code></pre><ul>\n<li>äº‹åŠ¡ä¿¡æ¯</li>\n</ul><p>è¿™é‡Œå¯ä»¥è·å–åˆ°InnoDBå†…éƒ¨çš„äº‹åŠ¡åˆ—è¡¨ï¼Œä»¥åŠäº‹åŠ¡ç³»ç»Ÿä¸­å¾ˆé‡è¦çš„ä¸€ä¸ªæŒ‡æ ‡ï¼šHistory list lengthã€‚å¦‚æœæ•°æ®åº“äº‹åŠ¡é‡å¾ˆé«˜ï¼Œæˆ–è€…æœ‰é•¿äº‹åŠ¡ä¸€ç›´æ²¡æœ‰æäº¤ï¼ŒInnoDBå¯èƒ½æ— æ³•åŠæ—¶å›æ”¶Undoæ®µï¼Œä»è€Œå½±å“æ€§èƒ½ã€‚</p><pre><code class=\"language-go\">------------\nTRANSACTIONS\n------------\nTrx id counter 51205\nPurge done for trx's n:o &lt; 51188 undo n:o &lt; 0 state: running but idle\nHistory list length 0\nTotal number of lock structs in row lock hash table 0\nLIST OF TRANSACTIONS FOR EACH SESSION:\n---TRANSACTION 421605369714584, not started\n0 lock struct(s), heap size 1192, 0 row lock(s)\n</code></pre><ul>\n<li>æ–‡ä»¶IOçº¿ç¨‹å’ŒIOè¯·æ±‚</li>\n</ul><p>InnoDBä½¿ç”¨IOçº¿ç¨‹æ¥è¯»å†™æ•°æ®æ–‡ä»¶ã€‚åº•å±‚IOç³»ç»Ÿå‡ºç°æ€§èƒ½é—®é¢˜æˆ–è¾¾åˆ°æ€§èƒ½ç“¶é¢ˆæ—¶ï¼ŒPending IOå¯èƒ½ä¼šæŒç»­æ¯”è¾ƒé•¿çš„æ—¶é—´ã€‚æœ‰æ—¶ç”šè‡³ä¼šé‡åˆ°IOç³»ç»Ÿå¡æ­»å¯¼è‡´MySQLå´©æºƒçš„æƒ…å†µã€‚</p><pre><code class=\"language-go\">--------\nFILE I/O\n--------\nI/O thread 0 state: waiting for i/o request (insert buffer thread)\nI/O thread 1 state: waiting for i/o request (log thread)\nI/O thread 2 state: waiting for i/o request (read thread)\nI/O thread 3 state: waiting for i/o request (read thread)\nI/O thread 4 state: waiting for i/o request (read thread)\nI/O thread 5 state: waiting for i/o request (read thread)\nI/O thread 6 state: waiting for i/o request (write thread)\nI/O thread 7 state: waiting for i/o request (write thread)\nI/O thread 8 state: waiting for i/o request (write thread)\nI/O thread 9 state: waiting for i/o request (write thread)\nPending normal aio reads: [0, 0, 0, 0] , aio writes: [0, 0, 0, 0] ,\n ibuf aio reads:, log i/o's:\nPending flushes (fsync) log: 0; buffer pool: 18446744073709551615\n33496 OS file reads, 68233 OS file writes, 5534 OS fsyncs\n0.00 reads/s, 0 avg bytes/read, 0.00 writes/s, 0.00 fsyncs/s\n</code></pre><ul>\n<li>Insert Bufferå’Œè‡ªé€‚åº”å“ˆå¸Œç´¢å¼•</li>\n</ul><p>Insert Bufferå’Œè‡ªé€‚åº”å“ˆå¸Œç´¢å¼•æ˜¯MySQLç”¨æ¥æå‡æ€§èƒ½çš„ä¸€äº›æœºåˆ¶ï¼Œè¿™é‡Œå¯ä»¥è§‚å¯Ÿåˆ°ç›¸å…³æŒ‡æ ‡ã€‚</p><pre><code class=\"language-go\">-------------------------------------\nINSERT BUFFER AND ADAPTIVE HASH INDEX\n-------------------------------------\nIbuf: size 1, free list len 0, seg size 2, 100 merges\nmerged operations:\n insert 100, delete mark 100, delete 0\ndiscarded operations:\n insert 0, delete mark 0, delete 0\n</code></pre><ul>\n<li>Redoæ—¥å¿—</li>\n</ul><p>Redoæ—¥å¿—æ˜¯InnoDBç”¨æ¥ä¿æŠ¤æ•°æ®ä¸ä¸¢çš„æ ¸å¿ƒæœºåˆ¶ä¹‹ä¸€ã€‚å¦‚æœcheckpointè·Ÿä¸ä¸Šæ•°æ®å†™å…¥çš„é€Ÿåº¦ï¼Œä¼šå½±å“æ•°æ®åº“çš„ååé‡ï¼Œå¯ä»¥ç›‘æ§è¿™é‡Œä¸åŒæ—¥å¿—åºåˆ—å·ä¹‹é—´çš„å·®å€¼æ¥è¿›è¡Œåˆ¤æ–­ã€‚</p><pre><code class=\"language-go\">---\nLOG\n---\nLog sequence number          543093972\nLog buffer assigned up to    543093972\nLog buffer completed up to   543093972\nLog written up to            543093972\nLog flushed up to            543093972\nAdded dirty pages up to      543093972\nPages flushed up to          543093972\nLast checkpoint at           543093972\nLog minimum file id is       156\nLog maximum file id is       159\n51944 log i/o's done, 0.00 log i/o's/second\n</code></pre><ul>\n<li>Buffer Pool</li>\n</ul><p>è¯»å–å’Œä¿®æ”¹InnoDBä¸­å­˜å‚¨çš„æ•°æ®æ—¶ï¼Œéƒ½éœ€è¦å°†æ•°æ®é¡µå…ˆåŠ è½½åˆ°Buffer Poolä¸­ã€‚è¿™é‡Œæä¾›äº†Buffer Poolçš„ç›¸å…³æŒ‡æ ‡ã€‚</p><pre><code class=\"language-go\">----------------------\nBUFFER POOL AND MEMORY\n----------------------\nTotal large memory allocated 0\nDictionary memory allocated 1405012\nBuffer pool size   8192\nFree buffers       1014\nDatabase pages     7165\nOld database pages 2626\nModified db pages  0\nPending reads      0\nPending writes: LRU 0, flush list 0, single page 0\nPages made young 22345, not young 1124041\n</code></pre><ul>\n<li>è¡Œæ“ä½œè®°å½•</li>\n</ul><p>åœ¨è¿™ä¸€éƒ¨åˆ†å¯ä»¥è§‚å¯ŸInnoDBæ¯ç§’è®¿é—®çš„è¡Œæ•°ï¼Œä»¥åŠInnoDBå†…éƒ¨çš„æŸ¥è¯¢æ•°é‡ã€‚</p><pre><code class=\"language-go\">--------------\nROW OPERATIONS\n--------------\n0 queries inside InnoDB, 0 queries in queue\n0 read views open inside InnoDB\nProcess ID=18646, Main thread ID=140128601237248 , state=sleeping\nNumber of rows inserted 533330, updated 40364, deleted 6, read 422867135\n0.00 inserts/s, 0.00 updates/s, 0.00 deletes/s, 0.00 reads/s\nNumber of system rows inserted 315, updated 526, deleted 238, read 18387\n0.00 inserts/s, 0.00 updates/s, 0.00 deletes/s, 0.00 reads/s\n----------------------------\nEND OF INNODB MONITOR OUTPUT\n============================\n</code></pre><h4>Statuså˜é‡</h4><p>MySQLé€šè¿‡Statuså˜é‡æä¾›äº†æœåŠ¡å±‚å’Œå­˜å‚¨å¼•æ“å±‚çš„å¾ˆå¤šç»Ÿè®¡æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨show global statuså‘½ä»¤è·å–è¿™äº›æ•°æ®ã€‚</p><pre><code class=\"language-go\">mysql&gt; show global status where variable_name in  ('com_select', 'com_insert', 'com_update', 'com_delete');\n+---------------+---------+\n| Variable_name | Value   |\n+---------------+---------+\n| Com_delete    | 4       |\n| Com_insert    | 32      |\n| Com_select    | 1062151 |\n| Com_update    | 43      |\n+---------------+---------+\n\nmysql&gt; show global status like '%innodb_row%';\n+-------------------------------+-----------+\n| Variable_name                 | Value     |\n+-------------------------------+-----------+\n| Innodb_row_lock_current_waits | 0         |\n| Innodb_row_lock_time          | 562805    |\n| Innodb_row_lock_time_avg      | 33106     |\n| Innodb_row_lock_time_max      | 50240     |\n| Innodb_row_lock_waits         | 17        |\n| Innodb_rows_deleted           | 6         |\n| Innodb_rows_inserted          | 533330    |\n| Innodb_rows_read              | 422867135 |\n| Innodb_rows_updated           | 40364     |\n+-------------------------------+-----------+\n\nmysql&gt; show global status like 'threads%';\n+-------------------+-------+\n| Variable_name     | Value |\n+-------------------+-------+\n| Threads_cached    | 47    |\n| Threads_connected | 1     |\n| Threads_created   | 263   |\n| Threads_running   | 2     |\n+-------------------+-------+\n</code></pre><p>è¿™äº›æŒ‡æ ‡ä¸­ï¼Œæœ‰çš„æ˜¯å½“å‰å€¼ï¼Œå¦‚Threads_runningæ˜¯å½“å‰æ­£åœ¨è¿è¡Œä¸­çš„çº¿ç¨‹æ•°ï¼Œæœ‰çš„æ˜¯ç´¯åŠ å€¼ï¼Œå¦‚Com_selectè®°å½•äº†æ•°æ®åº“å¯åŠ¨ä»¥æ¥æ€»å…±æ‰§è¡Œäº†å¤šå°‘Selectè¯­å¥ã€‚å¯¹äºç´¯åŠ å€¼ï¼Œä¸€èˆ¬éœ€è¦è®¡ç®—å·®å€¼ï¼Œå¾—åˆ°ä¸€æ®µæ—¶é—´å†…çš„å¢é‡ã€‚</p><p>æœ€é‡è¦çš„æ˜¯è¦ä½¿ç”¨ç›‘æ§ç³»ç»Ÿå°†è¿™äº›æŒ‡æ ‡è®°å½•ä¸‹æ¥ï¼Œä¸ºä½ çš„æ•°æ®åº“å»ºç«‹ä¸€å¥—åŸºçº¿ï¼Œè¿™å¯¹ä½ åˆ†æå’Œè¯Šæ–­æ•°æ®åº“é—®é¢˜èƒ½æä¾›å¾ˆå¤§çš„å¸®åŠ©ã€‚æ¯”å¦‚é€šè¿‡Com_selectã€Com_insertã€Com_updateã€Com_deleteç­‰æŒ‡æ ‡ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ä¸šåŠ¡çš„è®¿é—®é‡ã€‚</p><p>é€šè¿‡Innodb_rows_readã€Innodb_rows_insertedã€Innodb_rows_updatedã€Innodb_rows_deletedç­‰æŒ‡æ ‡ï¼Œå¯ä»¥çŸ¥é“æœåŠ¡ç«¯è®¿é—®çš„è¡Œæ•°ã€‚å¦‚æœæŸä¸ªæ—¶é—´æ•°æ®åº“æœåŠ¡å™¨è´Ÿè½½å¤§å¹…åº¦ä¸Šæ¶¨ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆæŸ¥çœ‹COM_XXXç³»åˆ—æŒ‡æ ‡ï¼Œåˆ¤æ–­å¤–éƒ¨è¯·æ±‚é‡æ˜¯ä¸æ˜¯æœ‰å¤§å¹…åº¦å¢é•¿ã€‚å¦‚æœä¸šåŠ¡è¯·æ±‚é‡æ²¡æœ‰å¤§å¹…åº¦å¢é•¿ï¼Œè€ŒInnodb_rows_XXXç³»åˆ—æŒ‡æ ‡æœ‰å¤§å¹…åº¦çš„å¢é•¿ï¼Œåˆ™å¾ˆå¯èƒ½æ˜¯è¿è¡Œäº†ä¸€äº›æ€§èƒ½è¾ƒå·®çš„å¤§æŸ¥è¯¢å¯¼è‡´æœåŠ¡å™¨è´Ÿè½½ä¸Šå‡ã€‚</p><p>ç»¼åˆåˆ†æè¿™äº›æŒ‡æ ‡ï¼Œèƒ½å¸®ä½ å¤§è‡´åˆ¤æ–­é—®é¢˜çš„å¯èƒ½æ–¹å‘ï¼Œå†ç»“åˆè¿™ä¸€è®²å‰é¢æåˆ°çš„ä¸€äº›æ–¹æ³•ï¼Œå¯ä»¥æ¯”è¾ƒå¿«é€Ÿæ‰¾åˆ°é—®é¢˜çš„æ ¹æºï¼Œå¹¶é‡‡å–ç›¸åº”çš„æ–¹æ³•æ¥è§£å†³é—®é¢˜ã€‚</p><h4>é”™è¯¯æ—¥å¿—</h4><p>MySQLé”™è¯¯æ—¥å¿—ä¸­è®°å½•äº†ä»å…¶ä»–åœ°æ–¹æ— æ³•è·å–åˆ°çš„ä¸€äº›ä¿¡æ¯ã€‚æ’æŸ¥é—®é¢˜æ‰¾ä¸åˆ°å¤´ç»ªæ—¶ï¼Œå¯ä»¥çœ‹çœ‹é”™è¯¯æ—¥å¿—ï¼Œè¯´ä¸å®šèƒ½æœ‰ä¸€äº›å‘ç°ã€‚</p><pre><code class=\"language-go\">mysql&gt; show variables like 'log_error%';\n+----------------------------+----------------------------------------+\n| Variable_name              | Value                                  |\n+----------------------------+----------------------------------------+\n| log_error                  | /data/mysql01/log/alert.log            |\n| log_error_services         | log_filter_internal; log_sink_internal |\n| log_error_suppression_list |                                        |\n| log_error_verbosity        | 2                                      |\n+----------------------------+----------------------------------------+\n</code></pre><h3>åˆ†æå®¢æˆ·ç«¯çš„æƒ…å†µ</h3><p>æœ‰äº›æ—¶å€™ï¼Œé—®é¢˜å¯èƒ½ä¸ä¸€å®šå‡ºç°åœ¨æ•°æ®åº“å†…éƒ¨ï¼Œè€Œæ˜¯å‡ºç°åœ¨è®¿é—®æ•°æ®åº“çš„å®¢æˆ·ç«¯é‚£ä¸€ä¾§ã€‚æˆ‘ä»¬ä¸è¦å¿½ç•¥è¿™ä¸€ç§å¯èƒ½æ€§ã€‚</p><h2>æ€»ç»“</h2><p>è¿™ä¸€è®²ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†åˆ†æå’Œè¯Šæ–­MySQLé—®é¢˜çš„ä¸€ä¸ªé€šç”¨æ¡†æ¶ã€‚æœ‰å¤šç§ä¸åŒçš„åŸå› éƒ½ä¼šå¯¼è‡´MySQLå‡ºé—®é¢˜ã€‚</p><p>æ¯”å¦‚ï¼š</p><ul>\n<li>æœ‰å¯èƒ½æ˜¯è¿è¡ŒMySQLçš„ç¯å¢ƒæœ¬èº«å­˜åœ¨æ€§èƒ½ç“¶é¢ˆã€‚</li>\n<li>æœ‰å¯èƒ½æ˜¯MySQLåœ¨å¿™ç€æ‰§è¡Œå„ç§SQLï¼Œå¯èƒ½æ˜¯SQLæ‰§è¡Œé¢‘ç‡å¤ªé«˜ï¼Œä¹Ÿå¯èƒ½æ˜¯æœ‰çš„SQLæ‰«æäº†å¤ªå¤šçš„æ•°æ®ã€‚</li>\n<li>æœ‰å¯èƒ½æ˜¯ä¸€ä¸ªä¼šè¯é•¿æ—¶é—´æŒæœ‰é”ï¼Œæ— æ„é—´é”æ­»äº†å¤§é‡ä¼šè¯ã€‚</li>\n<li>æœ‰å¯èƒ½æ˜¯å¹¶å‘å¤ªé«˜ï¼Œå†…éƒ¨èµ„æºå­˜åœ¨ä¸¥é‡çš„äº‰ç”¨</li>\n</ul><p>ç°å®ä¸­ï¼Œä¹Ÿå¾ˆå¯èƒ½ä¼šåŒæ—¶é‡åˆ°ä¸Šé¢çš„å¤šç§æƒ…å†µã€‚å½“ç„¶åœ¨å¦å¤–ä¸€äº›æƒ…å†µä¸‹ï¼Œé—®é¢˜ä¸æ˜¯å‡ºåœ¨æ•°æ®åº“ä¸Šï¼Œè€Œæ˜¯å‡ºç°åœ¨è®¿é—®æ•°æ®åº“çš„å®¢æˆ·ç«¯ã€‚</p><p>é€šè¿‡ç³»ç»Ÿåœ°åˆ†ææ“ä½œç³»ç»Ÿå’ŒMySQLçš„æŒ‡æ ‡ã€æ—¥å¿—ã€å†…éƒ¨çŠ¶æ€ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹éƒ½èƒ½æ‰¾åˆ°é—®é¢˜çš„æ ¹æºã€‚å¯¹äºä¸€äº›é—´æ­‡å‡ºç°ã€éš¾ä»¥å¤ç°ã€åŸå› ä¸æ˜çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥éƒ¨ç½²ä¸€äº›è„šæœ¬ï¼Œå°†å°½å¯èƒ½å¤šçš„ç°åœºä¿¡æ¯é‡‡é›†ä¸‹æ¥ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>å›½åº†èŠ‚å‡æœŸï¼ŒDBAå°æ˜çªç„¶æ¥åˆ°å¤§é‡æ•°æ®åº“å‘Šè­¦ï¼Œç™»å½•æ•°æ®åº“æ‰§è¡ŒSHOW PROCESSLISTåï¼Œå‘ç°å¤§é‡ä¼šè¯è¢«é˜»å¡äº†ã€‚ä¸‹é¢æä¾›äº†éƒ¨åˆ†ä¼šè¯çš„ä¿¡æ¯ã€‚è¯·ä½ æ ¹æ®è¿™äº›ä¿¡æ¯ï¼Œå¸®å°æ˜ä¸€èµ·åˆ†æä¸‹ï¼Œä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™æ ·çš„é—®é¢˜ï¼Ÿåº”è¯¥æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿæœ‰å“ªäº›åœ°æ–¹å¯ä»¥æ”¹è¿›ï¼Ÿ</p><pre><code class=\"language-go\">Id: 1842782 \nUser: user_xx \nHost: xx.xx.xx.xx:59068 \ndb: db_xx \nCommand: Query \nTime: 2326 \nState: Waiting for table\nInfo: update stat_item_detail set sold=sold+1, money=money+19800, Gmt_create=now() where item_id=1234567801 and day='2011-10-07 00:00:00\n\n\nId: 1657130 \nUser: user_xx \nHost: yy.yy.yy.yy:40093 \ndb: db_xx \nCommand: Query \nTime: 184551 \nState: Sending data \nInfo: select item_id, sum(sold) as sold from stat_item_detail where item_id in (select item_id from stat_item_detail where Gmt_create &gt;= '2011-10-05 08:59:00') group by item_id\n\n\nId: 1044\nUser: system user\nHost:\ndb:\nCommand: Connect \nTime: 27406\nState: Flushing tables FLUSH TABLES\nInfo: \n</code></pre><p>æœŸå¾…ä½ çš„æ€è€ƒï¼Œæ¬¢è¿åœ¨ç•™è¨€åŒºä¸­ä¸æˆ‘äº¤æµã€‚å¦‚æœä»Šå¤©çš„è¯¾ç¨‹è®©ä½ æœ‰æ‰€æ”¶è·ï¼Œä¹Ÿæ¬¢è¿è½¬å‘ç»™æœ‰éœ€è¦çš„æœ‹å‹ã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼</p>","neighbors":{"left":{"article_title":"12ï½œè¡¨å¤ªå¤§äº†ï¼Œä¿®æ”¹è¡¨ç»“æ„å¤ªæ…¢æ€ä¹ˆè§£å†³ï¼Ÿï¼ˆä¸‹ï¼‰","id":806946},"right":{"article_title":"14ï½œLinuxé—®é¢˜è¯Šæ–­å…¥é—¨ï¼šæ“ä½œç³»ç»Ÿæ˜¯å¦å­˜åœ¨ç“¶é¢ˆï¼Ÿ","id":806965}},"comments":[{"had_liked":false,"id":394336,"user_name":"å¶æ˜","can_delete":false,"product_type":"c1","uid":1412429,"ip_address":"æ±Ÿè‹","ucode":"D0B4B7660DA766","user_header":"https://static001.geekbang.org/account/avatar/00/15/8d/4d/992070e8.jpg","comment_is_top":false,"comment_ctime":1726540280,"is_pvip":false,"replies":[{"id":143135,"content":"stateå°±æ˜¯Waiting for tableï¼Œè¿™æ˜¯5.1ç‰ˆæœ¬ä¸­çš„ä¸€ä¸ªçŠ¶æ€ã€‚\n\nä½ çš„åˆ†æå®Œå…¨æ­£ç¡®ã€‚ğŸ‘ğŸ‘\n\nåˆ†æprocesslistæ—¶ï¼Œä¸€èˆ¬å¯ä»¥é€šè¿‡Timeå­—æ®µæ¥åˆ¤æ–­å“ªä¸ªäº‹ä»¶å‘ç”Ÿåœ¨å‰é¢ï¼Œå“ªä¸ªäº‹ä»¶å‘ç”Ÿåœ¨åé¢ï¼Œä»¥æ­¤æ¥å®šä½é—®é¢˜çš„æ ¹æºã€‚\n","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3898827,"ctime":1726557371,"ip_address":"æµ™æ±Ÿ","comment_id":394336,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100799401,"comment_content":"ä¼šè¯ 1842782 çš„ state å­—æ®µçš„å®Œæ•´ä¿¡æ¯æ˜¯ä¸æ˜¯ Waiting for table flushï¼Ÿ\n\nä» id å’Œ time å­—æ®µæ¥åˆ†æè¿™ä¸ªè¿‡ç¨‹æ‰§è¡Œçš„é¡ºåºï¼š\né¦–å…ˆï¼Œä¼šè¯ 1657130 ä¸­çš„è¯­å¥è¢«æ‰§è¡Œï¼ŒTime è¾¾åˆ° 184551 ç§’ï¼ŒæŸ¥è¯¢è¯­å¥æ˜¯èšåˆè¯­å¥ï¼Œè¯´æ˜è¿™æ˜¯ä¸€ä¸ªå¤§æŸ¥è¯¢ï¼Œåœ¨æŸ¥è¯¢æ‰§è¡ŒæœŸé—´ï¼Œè¯­å¥ä¸­æ¶‰åŠåˆ°çš„è¡¨ä¼šè¢«æ‰“å¼€ï¼Œä¸”æŒæœ‰ MDL è¯»é”ã€‚\nå…¶æ¬¡ï¼Œå¯èƒ½æ‰§è¡Œäº†ä¸€ä¸ªç±»ä¼¼ flush tables çš„å‘½ä»¤ï¼Œå¯¼è‡´æœ‰åˆ·æ–°è¡¨çš„æ“ä½œï¼Œè¯¥æ“ä½œè¦å…³é—­å¹¶é‡æ–°æ‰“å¼€è¡¨ï¼Œå› ä¸ºä¼šè¯ 1842782 åœ¨æ‰§è¡Œå¤§æŸ¥è¯¢ï¼Œè¡¨å¤„äºæ‰“å¼€çŠ¶æ€ï¼Œå› æ­¤å‘ç”Ÿå†²çªï¼Œä»è€Œè¿›å…¥ç­‰å¾…çŠ¶æ€\næœ€åï¼Œä¼šè¯ 1842782 å¯¹è¯¥è¡¨ä¸­è®°å½•è¿›è¡Œå˜æ›´ï¼Œä» state æ¥çœ‹ï¼Œè¯¥ä¼šè¯å¤„äºç­‰å¾…çŠ¶æ€ï¼Œçœ‹æ¥æ˜¯è¢«æ‰§è¡Œ flush tables çš„ä¼šè¯ 1044 æ‰€é˜»å¡\n\n\nä¼šè¯ 1044 ä¸­çš„ flush table æ“ä½œä¸å¤§æŸ¥è¯¢å†²çªï¼Œå¯¼è‡´åç»­æ¶‰åŠåˆ°è¯¥è¡¨çš„è¯»å†™æ“ä½œçš„ä¼šè¯éƒ½é™·å…¥é˜»å¡ã€‚","like_count":1,"discussions":[{"author":{"id":3898827,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/7d/cb/fa3dae58.jpg","nickname":"ä¿Šè¾¾","note":"","ucode":"F79BF9651AD086","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":651216,"discussion_content":"stateå°±æ˜¯Waiting for tableï¼Œè¿™æ˜¯5.1ç‰ˆæœ¬ä¸­çš„ä¸€ä¸ªçŠ¶æ€ã€‚\n\nä½ çš„åˆ†æå®Œå…¨æ­£ç¡®ã€‚ğŸ‘ğŸ‘\n\nåˆ†æprocesslistæ—¶ï¼Œä¸€èˆ¬å¯ä»¥é€šè¿‡Timeå­—æ®µæ¥åˆ¤æ–­å“ªä¸ªäº‹ä»¶å‘ç”Ÿåœ¨å‰é¢ï¼Œå“ªä¸ªäº‹ä»¶å‘ç”Ÿåœ¨åé¢ï¼Œä»¥æ­¤æ¥å®šä½é—®é¢˜çš„æ ¹æºã€‚\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1726557371,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":394331,"user_name":"binzhang","can_delete":false,"product_type":"c1","uid":1647189,"ip_address":"ç¾å›½","ucode":"F2670F2EA24FAD","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q3auHgzwzM59PTNiaDASVicbVaeWBU1WKmOgyHcqVtl85nDwAqDicib1EUKE2RRoU0x0vZctZO4kbPDUTTke8qKfAw/132","comment_is_top":false,"comment_ctime":1726512636,"is_pvip":false,"replies":[{"id":143136,"content":"è§‚å¯Ÿå¾—å¾ˆä»”ç»†ï¼Œ1044ä¼šè¯çš„ç”¨æˆ·å’ŒCommandéƒ½æ¯”è¾ƒç‰¹åˆ«ã€‚\nå…¶å®è¿™æ˜¯ä¸€ä¸ªSQLçº¿ç¨‹ï¼ŒFlush tableså‘½ä»¤æ˜¯ä»ä¸»åº“ä¸Šå¤åˆ¶è¿‡æ¥çš„ã€‚\n\nä¸è¿‡æ€è¿™ä¸ªä¼šè¯åº”è¯¥æ²¡æœ‰ç”¨ï¼Œé—®é¢˜çš„æ ¹æºæ˜¯ä¼šè¯1657130æ‰§è¡Œçš„Selectè¯­å¥ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3898827,"ctime":1726557570,"ip_address":"æµ™æ±Ÿ","comment_id":394331,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100799401,"comment_content":"æ€è€ƒé¢˜é‡Œé¢1044è¿™ä¸ªthreadå€¼å¾—æ€€ç–‘ ç³»ç»Ÿç”¨æˆ· æ²¡æœ‰æ˜¾ç¤ºå…·ä½“æ˜¯å“ªä¸ªdb åœ¨connecté˜¶æ®µ åšflush tablesæ“ä½œã€‚å…ˆæ€è¿™ä¸ªè¯•è¯•ã€‚ä¸çŸ¥é“ä¸ºå•¥ä¸€ä¸ªconnectå‘½ä»¤ä¼šè§¦å‘flush table","like_count":1,"discussions":[{"author":{"id":3898827,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/7d/cb/fa3dae58.jpg","nickname":"ä¿Šè¾¾","note":"","ucode":"F79BF9651AD086","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":651217,"discussion_content":"è§‚å¯Ÿå¾—å¾ˆä»”ç»†ï¼Œ1044ä¼šè¯çš„ç”¨æˆ·å’ŒCommandéƒ½æ¯”è¾ƒç‰¹åˆ«ã€‚\nå…¶å®è¿™æ˜¯ä¸€ä¸ªSQLçº¿ç¨‹ï¼ŒFlush tableså‘½ä»¤æ˜¯ä»ä¸»åº“ä¸Šå¤åˆ¶è¿‡æ¥çš„ã€‚\n\nä¸è¿‡æ€è¿™ä¸ªä¼šè¯åº”è¯¥æ²¡æœ‰ç”¨ï¼Œé—®é¢˜çš„æ ¹æºæ˜¯ä¼šè¯1657130æ‰§è¡Œçš„Selectè¯­å¥ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1726557570,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":394569,"user_name":"ç‹æ¬¢","can_delete":false,"product_type":"c1","uid":1931030,"ip_address":"å†…è’™å¤","ucode":"A2D5C3AF6F6D7F","user_header":"https://static001.geekbang.org/account/avatar/00/1d/77/16/96ef147f.jpg","comment_is_top":false,"comment_ctime":1727172400,"is_pvip":false,"replies":[{"id":143235,"content":"æŠŠå“ªäº›DMLæ”¾åˆ°ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œæ›´å¤šæ˜¯ä¸šåŠ¡å®ç°ä¸Šçš„å†³ç­–ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3898827,"ctime":1727333174,"ip_address":"æµ™æ±Ÿ","comment_id":394569,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100799401,"comment_content":"mysql å¤§äº‹åŠ¡ï¼Œå¤šæ¡update å’Œ å¤šæ¡delete è¯­å¥ï¼Œ äº‹åŠ¡æ‰§è¡Œæ—¶é—´é•¿æœ‰ä»€ä¹ˆå¥½çš„ä¼˜åŒ–åŠæ³•å—","like_count":0,"discussions":[{"author":{"id":3898827,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/7d/cb/fa3dae58.jpg","nickname":"ä¿Šè¾¾","note":"","ucode":"F79BF9651AD086","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":651724,"discussion_content":"æŠŠå“ªäº›DMLæ”¾åˆ°ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œæ›´å¤šæ˜¯ä¸šåŠ¡å®ç°ä¸Šçš„å†³ç­–ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1727333175,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]}]}