{"id":106490,"title":"45 | å‘é€ç½‘ç»œåŒ…ï¼ˆä¸Šï¼‰ï¼šå¦‚ä½•è¡¨è¾¾æˆ‘ä»¬æƒ³è®©åˆä½œä¼™ä¼´åšä»€ä¹ˆï¼Ÿ","content":"<p>ä¸Šä¸€èŠ‚ï¼Œæˆ‘ä»¬é€šè¿‡socketå‡½æ•°ã€bindå‡½æ•°ã€listenå‡½æ•°ã€acceptå‡½æ•°ä»¥åŠconnectå‡½æ•°ï¼Œåœ¨å†…æ ¸å»ºç«‹å¥½äº†æ•°æ®ç»“æ„ï¼Œå¹¶å®Œæˆäº†TCPè¿æ¥å»ºç«‹çš„ä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹ã€‚</p><p>è¿™ä¸€èŠ‚ï¼Œæˆ‘ä»¬æ¥ç€æ¥åˆ†æï¼Œå‘é€ä¸€ä¸ªç½‘ç»œåŒ…çš„è¿‡ç¨‹ã€‚</p><h2>è§£æsocketçš„Writeæ“ä½œ</h2><p>socketå¯¹äºç”¨æˆ·æ¥è®²ï¼Œæ˜¯ä¸€ä¸ªæ–‡ä»¶ä¸€æ ·çš„å­˜åœ¨ï¼Œæ‹¥æœ‰ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚å› è€Œå¯¹äºç½‘ç»œåŒ…çš„å‘é€ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¯¹äºsocketæ–‡ä»¶çš„å†™å…¥ç³»ç»Ÿè°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯writeç³»ç»Ÿè°ƒç”¨ã€‚</p><p>writeç³»ç»Ÿè°ƒç”¨å¯¹äºä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦çš„æ“ä½œï¼Œå¤§è‡´è¿‡ç¨‹éƒ½æ˜¯ç±»ä¼¼çš„ã€‚åœ¨æ–‡ä»¶ç³»ç»Ÿé‚£ä¸€èŠ‚ï¼Œæˆ‘ä»¬å·²ç»è¯¦ç»†è§£æè¿‡ï¼Œè¿™é‡Œä¸å†å¤šè¯´ã€‚å¯¹äºæ¯ä¸€ä¸ªæ‰“å¼€çš„æ–‡ä»¶éƒ½æœ‰ä¸€ä¸ªstruct fileç»“æ„ï¼Œwriteç³»ç»Ÿè°ƒç”¨ä¼šæœ€ç»ˆè°ƒç”¨stuct fileç»“æ„æŒ‡å‘çš„file_operationsæ“ä½œã€‚</p><p>å¯¹äºsocketæ¥è®²ï¼Œå®ƒçš„file_operationså®šä¹‰å¦‚ä¸‹ï¼š</p><pre><code>static const struct file_operations socket_file_ops = {\n\t.owner =\tTHIS_MODULE,\n\t.llseek =\tno_llseek,\n\t.read_iter =\tsock_read_iter,\n\t.write_iter =\tsock_write_iter,\n\t.poll =\t\tsock_poll,\n\t.unlocked_ioctl = sock_ioctl,\n\t.mmap =\t\tsock_mmap,\n\t.release =\tsock_close,\n\t.fasync =\tsock_fasync,\n\t.sendpage =\tsock_sendpage,\n\t.splice_write = generic_splice_sendpage,\n\t.splice_read =\tsock_splice_read,\n};\n</code></pre><p>æŒ‰ç…§æ–‡ä»¶ç³»ç»Ÿçš„å†™å…¥æµç¨‹ï¼Œè°ƒç”¨çš„æ˜¯sock_write_iterã€‚</p><pre><code>static ssize_t sock_write_iter(struct kiocb *iocb, struct iov_iter *from)\n{\n\tstruct file *file = iocb-&gt;ki_filp;\n\tstruct socket *sock = file-&gt;private_data;\n\tstruct msghdr msg = {.msg_iter = *from,\n\t\t\t     .msg_iocb = iocb};\n\tssize_t res;\n......\n\tres = sock_sendmsg(sock, &amp;msg);\n\t*from = msg.msg_iter;\n\treturn res;\n}\n</code></pre><p>åœ¨sock_write_iterä¸­ï¼Œæˆ‘ä»¬é€šè¿‡VFSä¸­çš„struct fileï¼Œå°†åˆ›å»ºå¥½çš„socketç»“æ„æ‹¿å‡ºæ¥ï¼Œç„¶åè°ƒç”¨sock_sendmsgã€‚è€Œsock_sendmsgä¼šè°ƒç”¨sock_sendmsg_nosecã€‚</p><!-- [[[read_end]]] --><pre><code>static inline int sock_sendmsg_nosec(struct socket *sock, struct msghdr *msg)\n{\n\tint ret = sock-&gt;ops-&gt;sendmsg(sock, msg, msg_data_left(msg));\n......\n}\n</code></pre><p>è¿™é‡Œè°ƒç”¨äº†socketçš„opsçš„sendmsgï¼Œæˆ‘ä»¬åœ¨ä¸Šä¸€èŠ‚å·²ç»é‡åˆ°å®ƒå¥½å‡ æ¬¡äº†ã€‚æ ¹æ®inet_stream_opsçš„å®šä¹‰ï¼Œæˆ‘ä»¬è¿™é‡Œè°ƒç”¨çš„æ˜¯inet_sendmsgã€‚</p><pre><code>int inet_sendmsg(struct socket *sock, struct msghdr *msg, size_t size)\n{\n\tstruct sock *sk = sock-&gt;sk;\n......\n\treturn sk-&gt;sk_prot-&gt;sendmsg(sk, msg, size);\n}\n</code></pre><p>è¿™é‡Œé¢ï¼Œä»socketç»“æ„ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°æ›´åº•å±‚çš„sockç»“æ„ï¼Œç„¶åè°ƒç”¨sk_protçš„sendmsgæ–¹æ³•ã€‚è¿™ä¸ªæˆ‘ä»¬åŒæ ·åœ¨ä¸Šä¸€èŠ‚é‡åˆ°å¥½å‡ æ¬¡äº†ã€‚</p><h2>è§£ætcp_sendmsgå‡½æ•°</h2><p>æ ¹æ®tcp_protçš„å®šä¹‰ï¼Œæˆ‘ä»¬è°ƒç”¨çš„æ˜¯tcp_sendmsgã€‚</p><pre><code>int tcp_sendmsg(struct sock *sk, struct msghdr *msg, size_t size)\n{\n\tstruct tcp_sock *tp = tcp_sk(sk);\n\tstruct sk_buff *skb;\n\tint flags, err, copied = 0;\n\tint mss_now = 0, size_goal, copied_syn = 0;\n\tlong timeo;\n......\n\t/* Ok commence sending. */\n\tcopied = 0;\nrestart:\n\tmss_now = tcp_send_mss(sk, &amp;size_goal, flags);\n\n\twhile (msg_data_left(msg)) {\n\t\tint copy = 0;\n\t\tint max = size_goal;\n\n\t\tskb = tcp_write_queue_tail(sk);\n\t\tif (tcp_send_head(sk)) {\n\t\t\tif (skb-&gt;ip_summed == CHECKSUM_NONE)\n\t\t\t\tmax = mss_now;\n\t\t\tcopy = max - skb-&gt;len;\n\t\t}\n\n\t\tif (copy &lt;= 0 || !tcp_skb_can_collapse_to(skb)) {\n\t\t\tbool first_skb;\n\nnew_segment:\n\t\t\t/* Allocate new segment. If the interface is SG,\n\t\t\t * allocate skb fitting to single page.\n\t\t\t */\n\t\t\tif (!sk_stream_memory_free(sk))\n\t\t\t\tgoto wait_for_sndbuf;\n......\n\t\t\tfirst_skb = skb_queue_empty(&amp;sk-&gt;sk_write_queue);\n\t\t\tskb = sk_stream_alloc_skb(sk,\n\t\t\t\t\t\t  select_size(sk, sg, first_skb),\n\t\t\t\t\t\t  sk-&gt;sk_allocation,\n\t\t\t\t\t\t  first_skb);\n......\n\t\t\tskb_entail(sk, skb);\n\t\t\tcopy = size_goal;\n\t\t\tmax = size_goal;\n......\n\t\t}\n\n\t\t/* Try to append data to the end of skb. */\n\t\tif (copy &gt; msg_data_left(msg))\n\t\t\tcopy = msg_data_left(msg);\n\n\t\t/* Where to copy to? */\n\t\tif (skb_availroom(skb) &gt; 0) {\n\t\t\t/* We have some space in skb head. Superb! */\n\t\t\tcopy = min_t(int, copy, skb_availroom(skb));\n\t\t\terr = skb_add_data_nocache(sk, skb, &amp;msg-&gt;msg_iter, copy);\n......\n\t\t} else {\n\t\t\tbool merge = true;\n\t\t\tint i = skb_shinfo(skb)-&gt;nr_frags;\n\t\t\tstruct page_frag *pfrag = sk_page_frag(sk);\n......\n\t\t\tcopy = min_t(int, copy, pfrag-&gt;size - pfrag-&gt;offset);\n......\n\t\t\terr = skb_copy_to_page_nocache(sk, &amp;msg-&gt;msg_iter, skb,\n\t\t\t\t\t\t       pfrag-&gt;page,\n\t\t\t\t\t\t       pfrag-&gt;offset,\n\t\t\t\t\t\t       copy);\n......\n\t\t\tpfrag-&gt;offset += copy;\n\t\t}\n\n......\n\t\ttp-&gt;write_seq += copy;\n\t\tTCP_SKB_CB(skb)-&gt;end_seq += copy;\n\t\ttcp_skb_pcount_set(skb, 0);\n\n\t\tcopied += copy;\n\t\tif (!msg_data_left(msg)) {\n\t\t\tif (unlikely(flags &amp; MSG_EOR))\n\t\t\t\tTCP_SKB_CB(skb)-&gt;eor = 1;\n\t\t\tgoto out;\n\t\t}\n\n\t\tif (skb-&gt;len &lt; max || (flags &amp; MSG_OOB) || unlikely(tp-&gt;repair))\n\t\t\tcontinue;\n\n\t\tif (forced_push(tp)) {\n\t\t\ttcp_mark_push(tp, skb);\n\t\t\t__tcp_push_pending_frames(sk, mss_now, TCP_NAGLE_PUSH);\n\t\t} else if (skb == tcp_send_head(sk))\n\t\t\ttcp_push_one(sk, mss_now);\n\t\tcontinue;\n......\n\t}\n......\n}\n</code></pre><p>tcp_sendmsgçš„å®ç°è¿˜æ˜¯å¾ˆå¤æ‚çš„ï¼Œè¿™é‡Œé¢åšäº†è¿™æ ·å‡ ä»¶äº‹æƒ…ã€‚</p><p>msgæ˜¯ç”¨æˆ·è¦å†™å…¥çš„æ•°æ®ï¼Œè¿™ä¸ªæ•°æ®è¦æ‹·è´åˆ°å†…æ ¸åè®®æ ˆé‡Œé¢å»å‘é€ï¼›åœ¨å†…æ ¸åè®®æ ˆé‡Œé¢ï¼Œç½‘ç»œåŒ…çš„æ•°æ®éƒ½æ˜¯ç”±struct sk_buffç»´æŠ¤çš„ï¼Œå› è€Œç¬¬ä¸€ä»¶äº‹æƒ…å°±æ˜¯æ‰¾åˆ°ä¸€ä¸ªç©ºé—²çš„å†…å­˜ç©ºé—´ï¼Œå°†ç”¨æˆ·è¦å†™å…¥çš„æ•°æ®ï¼Œæ‹·è´åˆ°struct sk_buffçš„ç®¡è¾–èŒƒå›´å†…ã€‚è€Œç¬¬äºŒä»¶äº‹æƒ…å°±æ˜¯å‘é€struct sk_buffã€‚</p><p>åœ¨tcp_sendmsgä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆé€šè¿‡å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œå°†sockç»“æ„è½¬æ¢ä¸ºstruct tcp_sockï¼Œè¿™ä¸ªæ˜¯ç»´æŠ¤TCPè¿æ¥çŠ¶æ€çš„é‡è¦æ•°æ®ç»“æ„ã€‚</p><p>æ¥ä¸‹æ¥æ˜¯tcp_sendmsgçš„ç¬¬ä¸€ä»¶äº‹æƒ…ï¼ŒæŠŠæ•°æ®æ‹·è´åˆ°struct sk_buffã€‚</p><p>æˆ‘ä»¬å…ˆå£°æ˜ä¸€ä¸ªå˜é‡copiedï¼Œåˆå§‹åŒ–ä¸º0ï¼Œè¿™è¡¨ç¤ºæ‹·è´äº†å¤šå°‘æ•°æ®ã€‚ç´§æ¥ç€æ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œwhile (msg_data_left(msg))ï¼Œä¹Ÿå³å¦‚æœç”¨æˆ·çš„æ•°æ®æ²¡æœ‰å‘é€å®Œæ¯•ï¼Œå°±ä¸€ç›´å¾ªç¯ã€‚å¾ªç¯é‡Œå£°æ˜äº†ä¸€ä¸ªcopyå˜é‡ï¼Œè¡¨ç¤ºè¿™æ¬¡æ‹·è´çš„æ•°å€¼ï¼Œåœ¨å¾ªç¯çš„æœ€åæœ‰copied += copyï¼Œå°†æ¯æ¬¡æ‹·è´çš„æ•°é‡éƒ½åŠ èµ·æ¥ã€‚</p><p>æˆ‘ä»¬è¿™é‡Œåªéœ€è¦çœ‹ä¸€æ¬¡å¾ªç¯åšäº†å“ªäº›äº‹æƒ…ã€‚</p><p><strong>ç¬¬ä¸€æ­¥</strong>ï¼Œtcp_write_queue_tailä»TCPå†™å…¥é˜Ÿåˆ—sk_write_queueä¸­æ‹¿å‡ºæœ€åä¸€ä¸ªstruct sk_buffï¼Œåœ¨è¿™ä¸ªå†™å…¥é˜Ÿåˆ—ä¸­æ’æ»¡äº†è¦å‘é€çš„struct sk_buffï¼Œä¸ºä»€ä¹ˆè¦æ‹¿æœ€åä¸€ä¸ªå‘¢ï¼Ÿè¿™é‡Œé¢åªæœ‰æœ€åä¸€ä¸ªï¼Œå¯èƒ½ä¼šå› ä¸ºä¸Šæ¬¡ç”¨æˆ·ç»™çš„æ•°æ®å¤ªå°‘ï¼Œè€Œæ²¡æœ‰å¡«æ»¡ã€‚</p><p><strong>ç¬¬äºŒæ­¥</strong>ï¼Œtcp_send_mssä¼šè®¡ç®—MSSï¼Œä¹Ÿå³Max Segment Sizeã€‚è¿™æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿè¿™ä¸ªæ„æ€æ˜¯è¯´ï¼Œæˆ‘ä»¬åœ¨ç½‘ç»œä¸Šä¼ è¾“çš„ç½‘ç»œåŒ…çš„å¤§å°æ˜¯æœ‰é™åˆ¶çš„ï¼Œè€Œè¿™ä¸ªé™åˆ¶åœ¨æœ€åº•å±‚å¼€å§‹å°±æœ‰ã€‚</p><p><strong>MTU</strong>ï¼ˆMaximum Transmission Unitï¼Œæœ€å¤§ä¼ è¾“å•å…ƒï¼‰æ˜¯äºŒå±‚çš„ä¸€ä¸ªå®šä¹‰ã€‚ä»¥ä»¥å¤ªç½‘ä¸ºä¾‹ï¼ŒMTUä¸º1500ä¸ªByteï¼Œå‰é¢æœ‰6ä¸ªByteçš„ç›®æ ‡MACåœ°å€ï¼Œ6ä¸ªByteçš„æºMACåœ°å€ï¼Œ2ä¸ªByteçš„ç±»å‹ï¼Œåé¢æœ‰4ä¸ªByteçš„CRCæ ¡éªŒï¼Œå…±1518ä¸ªByteã€‚</p><p>åœ¨IPå±‚ï¼Œä¸€ä¸ªIPæ•°æ®æŠ¥åœ¨ä»¥å¤ªç½‘ä¸­ä¼ è¾“ï¼Œå¦‚æœå®ƒçš„é•¿åº¦å¤§äºè¯¥MTUå€¼ï¼Œå°±è¦è¿›è¡Œåˆ†ç‰‡ä¼ è¾“ã€‚</p><p>åœ¨TCPå±‚æœ‰ä¸ª<strong>MSS</strong>ï¼ˆMaximum Segment Sizeï¼Œæœ€å¤§åˆ†æ®µå¤§å°ï¼‰ï¼Œç­‰äºMTUå‡å»IPå¤´ï¼Œå†å‡å»TCPå¤´ã€‚ä¹Ÿå°±æ˜¯ï¼Œåœ¨ä¸åˆ†ç‰‡çš„æƒ…å†µä¸‹ï¼ŒTCPé‡Œé¢æ”¾çš„æœ€å¤§å†…å®¹ã€‚</p><p>åœ¨è¿™é‡Œï¼Œmaxæ˜¯struct sk_buffçš„æœ€å¤§æ•°æ®é•¿åº¦ï¼Œskb-&gt;lenæ˜¯å½“å‰å·²ç»å ç”¨çš„skbçš„æ•°æ®é•¿åº¦ï¼Œç›¸å‡å¾—åˆ°å½“å‰skbçš„å‰©ä½™æ•°æ®ç©ºé—´ã€‚</p><p><strong>ç¬¬ä¸‰æ­¥</strong>ï¼Œå¦‚æœcopyå°äº0ï¼Œè¯´æ˜æœ€åä¸€ä¸ªstruct sk_buffå·²ç»æ²¡åœ°æ–¹å­˜æ”¾äº†ï¼Œéœ€è¦è°ƒç”¨sk_stream_alloc_skbï¼Œé‡æ–°åˆ†é…struct sk_buffï¼Œç„¶åè°ƒç”¨skb_entailï¼Œå°†æ–°åˆ†é…çš„sk_buffæ”¾åˆ°é˜Ÿåˆ—å°¾éƒ¨ã€‚</p><p>struct sk_buffæ˜¯å­˜å‚¨ç½‘ç»œåŒ…çš„é‡è¦çš„æ•°æ®ç»“æ„ï¼Œåœ¨åº”ç”¨å±‚æ•°æ®åŒ…å«dataï¼Œåœ¨TCPå±‚æˆ‘ä»¬ç§°ä¸ºsegmentï¼Œåœ¨IPå±‚æˆ‘ä»¬å«packetï¼Œåœ¨æ•°æ®é“¾è·¯å±‚ç§°ä¸ºframeã€‚åœ¨struct sk_buffï¼Œé¦–å…ˆæ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œå°†struct sk_buffç»“æ„ä¸²èµ·æ¥ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä»headers_startå¼€å§‹ï¼Œåˆ°headers_endç»“æŸï¼Œé‡Œé¢éƒ½æ˜¯å„å±‚æ¬¡çš„å¤´çš„ä½ç½®ã€‚è¿™é‡Œé¢æœ‰äºŒå±‚çš„mac_headerã€ä¸‰å±‚çš„network_headerå’Œå››å±‚çš„transport_headerã€‚</p><pre><code>struct sk_buff {\n\tunion {\n\t\tstruct {\n\t\t\t/* These two members must be first. */\n\t\t\tstruct sk_buff\t\t*next;\n\t\t\tstruct sk_buff\t\t*prev;\n......\n\t\t};\n\t\tstruct rb_node\trbnode; /* used in netem &amp; tcp stack */\n\t};\n......\n\t/* private: */\n\t__u32\t\t\theaders_start[0];\n\t/* public: */\n......\n\t__u32\t\t\tpriority;\n\tint\t\t\tskb_iif;\n\t__u32\t\t\thash;\n\t__be16\t\t\tvlan_proto;\n\t__u16\t\t\tvlan_tci;\n......\n\tunion {\n\t\t__u32\t\tmark;\n\t\t__u32\t\treserved_tailroom;\n\t};\n\n\tunion {\n\t\t__be16\t\tinner_protocol;\n\t\t__u8\t\tinner_ipproto;\n\t};\n\n\t__u16\t\t\tinner_transport_header;\n\t__u16\t\t\tinner_network_header;\n\t__u16\t\t\tinner_mac_header;\n\n\t__be16\t\t\tprotocol;\n\t__u16\t\t\ttransport_header;\n\t__u16\t\t\tnetwork_header;\n\t__u16\t\t\tmac_header;\n\n\t/* private: */\n\t__u32\t\t\theaders_end[0];\n\t/* public: */\n\n\t/* These elements must be at the end, see alloc_skb() for details.  */\n\tsk_buff_data_t\t\ttail;\n\tsk_buff_data_t\t\tend;\n\tunsigned char\t\t*head,\n\t\t\t\t*data;\n\tunsigned int\t\ttruesize;\n\trefcount_t\t\tusers;\n};\n</code></pre><p>æœ€åå‡ é¡¹ï¼Œ headæŒ‡å‘åˆ†é…çš„å†…å­˜å—èµ·å§‹åœ°å€ã€‚dataè¿™ä¸ªæŒ‡é’ˆæŒ‡å‘çš„ä½ç½®æ˜¯å¯å˜çš„ã€‚å®ƒæœ‰å¯èƒ½éšç€æŠ¥æ–‡æ‰€å¤„çš„å±‚æ¬¡è€Œå˜åŠ¨ã€‚å½“æ¥æ”¶æŠ¥æ–‡æ—¶ï¼Œä»ç½‘å¡é©±åŠ¨å¼€å§‹ï¼Œé€šè¿‡åè®®æ ˆå±‚å±‚å¾€ä¸Šä¼ é€æ•°æ®æŠ¥ï¼Œé€šè¿‡å¢åŠ  skb-&gt;data çš„å€¼ï¼Œæ¥é€æ­¥å‰¥ç¦»åè®®é¦–éƒ¨ã€‚è€Œè¦å‘é€æŠ¥æ–‡æ—¶ï¼Œå„åè®®ä¼šåˆ›å»º sk_buff{}ï¼Œåœ¨ç»è¿‡å„ä¸‹å±‚åè®®æ—¶ï¼Œé€šè¿‡å‡å°‘ skb-&gt;dataçš„å€¼æ¥å¢åŠ åè®®é¦–éƒ¨ã€‚tailæŒ‡å‘æ•°æ®çš„ç»“å°¾ï¼ŒendæŒ‡å‘åˆ†é…çš„å†…å­˜å—çš„ç»“æŸåœ°å€ã€‚</p><p>è¦åˆ†é…è¿™æ ·ä¸€ä¸ªç»“æ„ï¼Œsk_stream_alloc_skbä¼šæœ€ç»ˆè°ƒç”¨åˆ°__alloc_skbã€‚åœ¨è¿™ä¸ªå‡½æ•°é‡Œé¢ï¼Œé™¤äº†åˆ†é…ä¸€ä¸ªsk_buffç»“æ„ä¹‹å¤–ï¼Œè¿˜è¦åˆ†é…sk_buffæŒ‡å‘çš„æ•°æ®åŒºåŸŸã€‚è¿™æ®µæ•°æ®åŒºåŸŸåˆ†ä¸ºä¸‹é¢è¿™å‡ ä¸ªéƒ¨åˆ†ã€‚</p><p>ç¬¬ä¸€éƒ¨åˆ†æ˜¯è¿ç»­çš„æ•°æ®åŒºåŸŸã€‚ç´§æ¥ç€æ˜¯ç¬¬äºŒéƒ¨åˆ†ï¼Œä¸€ä¸ªstruct skb_shared_infoç»“æ„ã€‚è¿™ä¸ªç»“æ„æ˜¯å¯¹äºç½‘ç»œåŒ…å‘é€è¿‡ç¨‹çš„ä¸€ä¸ªä¼˜åŒ–ï¼Œå› ä¸ºä¼ è¾“å±‚ä¹‹ä¸Šå°±æ˜¯åº”ç”¨å±‚äº†ã€‚æŒ‰ç…§TCPçš„å®šä¹‰ï¼Œåº”ç”¨å±‚æ„Ÿå—ä¸åˆ°ä¸‹é¢çš„ç½‘ç»œå±‚çš„IPåŒ…æ˜¯ä¸€ä¸ªä¸ªç‹¬ç«‹çš„åŒ…çš„å­˜åœ¨çš„ã€‚åæ­£å°±æ˜¯ä¸€ä¸ªæµï¼Œå¾€é‡Œå†™å°±æ˜¯äº†ï¼Œå¯èƒ½ä¸€ä¸‹å­å†™å¤šäº†ï¼Œè¶…è¿‡äº†ä¸€ä¸ªIPåŒ…çš„æ‰¿è½½èƒ½åŠ›ï¼Œå°±ä¼šå‡ºç°ä¸Šé¢MSSçš„å®šä¹‰ï¼Œæ‹†åˆ†æˆä¸€ä¸ªä¸ªçš„Segmentæ”¾åœ¨ä¸€ä¸ªä¸ªçš„IPåŒ…é‡Œé¢ï¼Œä¹Ÿå¯èƒ½ä¸€æ¬¡å†™ä¸€ç‚¹ï¼Œä¸€æ¬¡å†™ä¸€ç‚¹ï¼Œè¿™æ ·æ•°æ®æ˜¯åˆ†æ•£çš„ï¼Œåœ¨IPå±‚è¿˜è¦é€šè¿‡å†…å­˜æ‹·è´åˆæˆä¸€ä¸ªIPåŒ…ã€‚</p><p>ä¸ºäº†å‡å°‘å†…å­˜æ‹·è´çš„ä»£ä»·ï¼Œæœ‰çš„ç½‘ç»œè®¾å¤‡æ”¯æŒ<strong>åˆ†æ•£èšåˆ</strong>ï¼ˆScatter/Gatherï¼‰I/Oï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯IPå±‚æ²¡å¿…è¦é€šè¿‡å†…å­˜æ‹·è´è¿›è¡Œèšåˆï¼Œè®©æ•£çš„æ•°æ®é›¶æ•£çš„æ”¾åœ¨åŸå¤„ï¼Œåœ¨è®¾å¤‡å±‚è¿›è¡Œèšåˆã€‚å¦‚æœä½¿ç”¨è¿™ç§æ¨¡å¼ï¼Œç½‘ç»œåŒ…çš„æ•°æ®å°±ä¸ä¼šæ”¾åœ¨è¿ç»­çš„æ•°æ®åŒºåŸŸï¼Œè€Œæ˜¯æ”¾åœ¨struct skb_shared_infoç»“æ„é‡Œé¢æŒ‡å‘çš„ç¦»æ•£æ•°æ®ï¼Œskb_shared_infoçš„æˆå‘˜å˜é‡skb_frag_t frags[MAX_SKB_FRAGS]ï¼Œä¼šæŒ‡å‘ä¸€ä¸ªæ•°ç»„çš„é¡µé¢ï¼Œå°±ä¸èƒ½ä¿è¯è¿ç»­äº†ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/9a/b8/9ad34c3c748978f915027d5085a858b8.png?wh=2203*1843\" alt=\"\"></p><p>äºæ˜¯æˆ‘ä»¬å°±æœ‰äº†<strong>ç¬¬å››æ­¥</strong>ã€‚åœ¨æ³¨é‡Š/* Where to copy to? */åé¢æœ‰ä¸ªif-elseåˆ†æ”¯ã€‚ifåˆ†æ”¯å°±æ˜¯skb_add_data_nocacheå°†æ•°æ®æ‹·è´åˆ°è¿ç»­çš„æ•°æ®åŒºåŸŸã€‚elseåˆ†æ”¯å°±æ˜¯skb_copy_to_page_nocacheå°†æ•°æ®æ‹·è´åˆ°struct skb_shared_infoç»“æ„æŒ‡å‘çš„ä¸éœ€è¦è¿ç»­çš„é¡µé¢åŒºåŸŸã€‚</p><p><strong>ç¬¬äº”æ­¥</strong>ï¼Œå°±æ˜¯è¦å‘ç”Ÿç½‘ç»œåŒ…äº†ã€‚ç¬¬ä¸€ç§æƒ…å†µæ˜¯ç§¯ç´¯çš„æ•°æ®æŠ¥æ•°ç›®å¤ªå¤šäº†ï¼Œå› è€Œæˆ‘ä»¬éœ€è¦é€šè¿‡è°ƒç”¨__tcp_push_pending_frameså‘é€ç½‘ç»œåŒ…ã€‚ç¬¬äºŒç§æƒ…å†µæ˜¯ï¼Œè¿™æ˜¯ç¬¬ä¸€ä¸ªç½‘ç»œåŒ…ï¼Œéœ€è¦é©¬ä¸Šå‘é€ï¼Œè°ƒç”¨tcp_push_oneã€‚æ— è®º__tcp_push_pending_framesè¿˜æ˜¯tcp_push_oneï¼Œéƒ½ä¼šè°ƒç”¨tcp_write_xmitå‘é€ç½‘ç»œåŒ…ã€‚</p><p>è‡³æ­¤ï¼Œtcp_sendmsgè§£æå®Œäº†ã€‚</p><h2>è§£ætcp_write_xmitå‡½æ•°</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ï¼Œtcp_write_xmitæ˜¯å¦‚ä½•å‘é€ç½‘ç»œåŒ…çš„ã€‚</p><pre><code>static bool tcp_write_xmit(struct sock *sk, unsigned int mss_now, int nonagle, int push_one, gfp_t gfp)\n{\n\tstruct tcp_sock *tp = tcp_sk(sk);\n\tstruct sk_buff *skb;\n\tunsigned int tso_segs, sent_pkts;\n\tint cwnd_quota;\n......\n\tmax_segs = tcp_tso_segs(sk, mss_now);\n\twhile ((skb = tcp_send_head(sk))) {\n\t\tunsigned int limit;\n......\n\t\ttso_segs = tcp_init_tso_segs(skb, mss_now);\n......\n\t\tcwnd_quota = tcp_cwnd_test(tp, skb);\n......\n\t\tif (unlikely(!tcp_snd_wnd_test(tp, skb, mss_now))) {\n\t\t\tis_rwnd_limited = true;\n\t\t\tbreak;\n\t\t}\n......\n\t\tlimit = mss_now;\n        if (tso_segs &gt; 1 &amp;&amp; !tcp_urg_mode(tp))\n            limit = tcp_mss_split_point(sk, skb, mss_now, min_t(unsigned int, cwnd_quota, max_segs), nonagle);\n\n\t\tif (skb-&gt;len &gt; limit &amp;&amp;\n\t\t    unlikely(tso_fragment(sk, skb, limit, mss_now, gfp)))\n\t\t\tbreak;\n......\n\t\tif (unlikely(tcp_transmit_skb(sk, skb, 1, gfp)))\n\t\t\tbreak;\n\nrepair:\n\t\t/* Advance the send_head.  This one is sent out.\n\t\t * This call will increment packets_out.\n\t\t */\n\t\ttcp_event_new_data_sent(sk, skb);\n\n\t\ttcp_minshall_update(tp, mss_now, skb);\n\t\tsent_pkts += tcp_skb_pcount(skb);\n\n\t\tif (push_one)\n\t\t\tbreak;\n\t}\n......\n}\n</code></pre><p>è¿™é‡Œé¢ä¸»è¦çš„é€»è¾‘æ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œç”¨æ¥å¤„ç†å‘é€é˜Ÿåˆ—ï¼Œåªè¦é˜Ÿåˆ—ä¸ç©ºï¼Œå°±ä¼šå‘é€ã€‚</p><p>åœ¨ä¸€ä¸ªå¾ªç¯ä¸­ï¼Œæ¶‰åŠTCPå±‚çš„å¾ˆå¤šä¼ è¾“ç®—æ³•ï¼Œæˆ‘ä»¬æ¥ä¸€ä¸€è§£æã€‚</p><p>ç¬¬ä¸€ä¸ªæ¦‚å¿µæ˜¯<strong>TSO</strong>ï¼ˆTCP Segmentation Offloadï¼‰ã€‚å¦‚æœå‘é€çš„ç½‘ç»œåŒ…éå¸¸å¤§ï¼Œå°±åƒä¸Šé¢è¯´çš„ä¸€æ ·ï¼Œè¦è¿›è¡Œåˆ†æ®µã€‚åˆ†æ®µè¿™ä¸ªäº‹æƒ…å¯ä»¥ç”±åè®®æ ˆä»£ç åœ¨å†…æ ¸åšï¼Œä½†æ˜¯ç¼ºç‚¹æ˜¯æ¯”è¾ƒè´¹CPUï¼Œå¦ä¸€ç§æ–¹å¼æ˜¯å»¶è¿Ÿåˆ°ç¡¬ä»¶ç½‘å¡å»åšï¼Œéœ€è¦ç½‘å¡æ”¯æŒå¯¹å¤§æ•°æ®åŒ…è¿›è¡Œè‡ªåŠ¨åˆ†æ®µï¼Œå¯ä»¥é™ä½CPUè´Ÿè½½ã€‚</p><p>åœ¨ä»£ç ä¸­ï¼Œtcp_init_tso_segsä¼šè°ƒç”¨tcp_set_skb_tso_segsã€‚è¿™é‡Œé¢æœ‰è¿™æ ·çš„è¯­å¥ï¼šDIV_ROUND_UP(skb-&gt;len, mss_now)ã€‚ä¹Ÿå°±æ˜¯sk_buffçš„é•¿åº¦é™¤ä»¥mss_nowï¼Œåº”è¯¥åˆ†æˆå‡ ä¸ªæ®µã€‚å¦‚æœç®—å‡ºæ¥è¦åˆ†æˆå¤šä¸ªæ®µï¼Œæ¥ä¸‹æ¥å°±æ˜¯è¦çœ‹ï¼Œæ˜¯åœ¨è¿™é‡Œï¼ˆåè®®æ ˆçš„ä»£ç é‡Œé¢ï¼‰åˆ†å¥½ï¼Œè¿˜æ˜¯ç­‰å¾…åˆ°äº†åº•å±‚ç½‘å¡å†åˆ†ã€‚</p><p>äºæ˜¯ï¼Œè°ƒç”¨å‡½æ•°tcp_mss_split_pointï¼Œå¼€å§‹è®¡ç®—åˆ‡åˆ†çš„limitã€‚è¿™é‡Œé¢ä¼šè®¡ç®—max_len = mss_now * max_segsï¼Œæ ¹æ®ç°åœ¨ä¸åˆ‡åˆ†æ¥è®¡ç®—limitï¼Œæ‰€ä»¥ä¸‹ä¸€æ­¥çš„åˆ¤æ–­ä¸­ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹tso_fragmentä¸ä¼šè¢«è°ƒç”¨ï¼Œç­‰å¾…åˆ°äº†åº•å±‚ç½‘å¡æ¥åˆ‡åˆ†ã€‚</p><p>ç¬¬äºŒä¸ªæ¦‚å¿µæ˜¯<strong>æ‹¥å¡çª—å£</strong>çš„æ¦‚å¿µï¼ˆcwndï¼Œcongestion windowï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸ºäº†é¿å…æ‹¼å‘½å‘åŒ…ï¼ŒæŠŠç½‘ç»œå¡æ»¡äº†ï¼Œå®šä¹‰ä¸€ä¸ªçª—å£çš„æ¦‚å¿µï¼Œåœ¨è¿™ä¸ªçª—å£ä¹‹å†…çš„æ‰èƒ½å‘é€ï¼Œè¶…è¿‡è¿™ä¸ªçª—å£çš„å°±ä¸èƒ½å‘é€ï¼Œæ¥æ§åˆ¶å‘é€çš„é¢‘ç‡ã€‚</p><p>é‚£çª—å£å¤§å°æ˜¯å¤šå°‘å‘¢ï¼Ÿå°±æ˜¯éµå¾ªä¸‹é¢è¿™ä¸ªè‘—åçš„æ‹¥å¡çª—å£å˜åŒ–å›¾ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/40/1f/404a6c5041452c0641ae3cba5319dc1f.png?wh=923*613\" alt=\"\"></p><p>ä¸€å¼€å§‹çš„çª—å£åªæœ‰ä¸€ä¸ªmsså¤§å°å«ä½œslow startï¼ˆæ…¢å¯åŠ¨ï¼‰ã€‚ä¸€å¼€å§‹çš„å¢é•¿é€Ÿåº¦çš„å¾ˆå¿«çš„ï¼Œç¿»å€å¢é•¿ã€‚ä¸€æ—¦åˆ°è¾¾ä¸€ä¸ªä¸´ç•Œå€¼ssthreshï¼Œå°±å˜æˆçº¿æ€§å¢é•¿ï¼Œæˆ‘ä»¬å°±ç§°ä¸º<strong>æ‹¥å¡é¿å…</strong>ã€‚ä»€ä¹ˆæ—¶å€™ç®—çœŸæ­£æ‹¥å¡å‘¢ï¼Ÿå°±æ˜¯å‡ºç°äº†ä¸¢åŒ…ã€‚ä¸€æ—¦ä¸¢åŒ…ï¼Œä¸€ç§æ–¹æ³•æ˜¯é©¬ä¸Šé™å›åˆ°ä¸€ä¸ªmssï¼Œç„¶åé‡å¤å…ˆç¿»å€å†çº¿æ€§å¯¹çš„è¿‡ç¨‹ã€‚å¦‚æœè§‰å¾—å¤ªè¿‡æ¿€è¿›ï¼Œä¹Ÿå¯ä»¥æœ‰ç¬¬äºŒç§æ–¹æ³•ï¼Œå°±æ˜¯é™åˆ°å½“å‰cwndçš„ä¸€åŠï¼Œç„¶åè¿›è¡Œçº¿æ€§å¢é•¿ã€‚</p><p>åœ¨ä»£ç ä¸­ï¼Œtcp_cwnd_testä¼šå°†å½“å‰çš„snd_cwndï¼Œå‡å»å·²ç»åœ¨çª—å£é‡Œé¢å°šæœªå‘é€å®Œæ¯•çš„ç½‘ç»œåŒ…ï¼Œé‚£å°±æ˜¯å‰©ä¸‹çš„çª—å£å¤§å°cwnd_quotaï¼Œä¹Ÿå³å°±èƒ½å‘é€è¿™ä¹ˆå¤šäº†ã€‚</p><p>ç¬¬ä¸‰ä¸ªæ¦‚å¿µå°±æ˜¯<strong>æ¥æ”¶çª—å£</strong>rwndçš„æ¦‚å¿µï¼ˆreceive windowï¼‰ï¼Œä¹Ÿå«æ»‘åŠ¨çª—å£ã€‚å¦‚æœè¯´æ‹¥å¡çª—å£æ˜¯ä¸ºäº†æ€•æŠŠç½‘ç»œå¡æ»¡ï¼Œåœ¨å‡ºç°ä¸¢åŒ…çš„æ—¶å€™å‡å°‘å‘é€é€Ÿåº¦ï¼Œé‚£ä¹ˆæ»‘åŠ¨çª—å£å°±æ˜¯ä¸ºäº†æ€•æŠŠæ¥æ”¶æ–¹å¡æ»¡ï¼Œè€Œæ§åˆ¶å‘é€é€Ÿåº¦ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/97/65/9791e2f9ff63a9d8f849df7cd55fe965.png?wh=1903*793\" alt=\"\"></p><p>æ»‘åŠ¨çª—å£ï¼Œå…¶å®å°±æ˜¯æ¥æ”¶æ–¹å‘Šè¯‰å‘é€æ–¹è‡ªå·±çš„ç½‘ç»œåŒ…çš„æ¥æ”¶èƒ½åŠ›ï¼Œè¶…è¿‡è¿™ä¸ªèƒ½åŠ›ï¼Œæˆ‘å°±å—ä¸äº†äº†ã€‚å› ä¸ºæ»‘åŠ¨çª—å£çš„å­˜åœ¨ï¼Œå°†å‘é€æ–¹çš„ç¼“å­˜åˆ†æˆäº†å››ä¸ªéƒ¨åˆ†ã€‚</p><ul>\n<li>ç¬¬ä¸€éƒ¨åˆ†ï¼šå‘é€äº†å¹¶ä¸”å·²ç»ç¡®è®¤çš„ã€‚è¿™éƒ¨åˆ†æ˜¯å·²ç»å‘é€å®Œæ¯•çš„ç½‘ç»œåŒ…ï¼Œè¿™éƒ¨åˆ†æ²¡æœ‰ç”¨äº†ï¼Œå¯ä»¥å›æ”¶ã€‚</li>\n<li>ç¬¬äºŒéƒ¨åˆ†ï¼šå‘é€äº†ä½†å°šæœªç¡®è®¤çš„ã€‚è¿™éƒ¨åˆ†ï¼Œå‘é€æ–¹è¦ç­‰å¾…ï¼Œä¸‡ä¸€å‘é€ä¸æˆåŠŸï¼Œè¿˜è¦é‡æ–°å‘é€ï¼Œæ‰€ä»¥ä¸èƒ½åˆ é™¤ã€‚</li>\n<li>ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ²¡æœ‰å‘é€ï¼Œä½†æ˜¯å·²ç»ç­‰å¾…å‘é€çš„ã€‚è¿™éƒ¨åˆ†æ˜¯æ¥æ”¶æ–¹ç©ºé—²çš„èƒ½åŠ›ï¼Œå¯ä»¥é©¬ä¸Šå‘é€ï¼Œæ¥æ”¶æ–¹æ”¶å¾—äº†ã€‚</li>\n<li>ç¬¬å››éƒ¨åˆ†ï¼šæ²¡æœ‰å‘é€ï¼Œå¹¶ä¸”æš‚æ—¶è¿˜ä¸ä¼šå‘é€çš„ã€‚è¿™éƒ¨åˆ†å·²ç»è¶…è¿‡äº†æ¥æ”¶æ–¹çš„æ¥æ”¶èƒ½åŠ›ï¼Œå†å‘é€æ¥æ”¶æ–¹å°±æ”¶ä¸äº†äº†ã€‚</li>\n</ul><p><img src=\"https://static001.geekbang.org/resource/image/b6/31/b62eea403e665bb196dceba571392531.png?wh=2017*793\" alt=\"\"></p><p>å› ä¸ºæ»‘åŠ¨çª—å£çš„å­˜åœ¨ï¼Œæ¥æ”¶æ–¹çš„ç¼“å­˜ä¹Ÿè¦åˆ†æˆäº†ä¸‰ä¸ªéƒ¨åˆ†ã€‚</p><ul>\n<li>ç¬¬ä¸€éƒ¨åˆ†ï¼šæ¥å—å¹¶ä¸”ç¡®è®¤è¿‡çš„ä»»åŠ¡ã€‚è¿™éƒ¨åˆ†å®Œå…¨æ¥æ”¶æˆåŠŸäº†ï¼Œå¯ä»¥äº¤ç»™åº”ç”¨å±‚äº†ã€‚</li>\n<li>ç¬¬äºŒéƒ¨åˆ†ï¼šè¿˜æ²¡æ¥æ”¶ï¼Œä½†æ˜¯é©¬ä¸Šå°±èƒ½æ¥æ”¶çš„ä»»åŠ¡ã€‚è¿™éƒ¨åˆ†æœ‰çš„ç½‘ç»œåŒ…åˆ°è¾¾äº†ï¼Œä½†æ˜¯è¿˜æ²¡ç¡®è®¤ï¼Œä¸ç®—å®Œå…¨å®Œæ¯•ï¼Œæœ‰çš„è¿˜æ²¡æœ‰åˆ°è¾¾ï¼Œé‚£å°±æ˜¯æ¥æ”¶æ–¹èƒ½å¤Ÿæ¥å—çš„æœ€å¤§çš„ç½‘ç»œåŒ…æ•°é‡ã€‚</li>\n<li>ç¬¬ä¸‰éƒ¨åˆ†ï¼šè¿˜æ²¡æ¥æ”¶ï¼Œä¹Ÿæ²¡æ³•æ¥æ”¶çš„ä»»åŠ¡ã€‚è¿™éƒ¨åˆ†å·²ç»è¶…å‡ºæ¥æ”¶æ–¹èƒ½åŠ›ã€‚</li>\n</ul><p>åœ¨ç½‘ç»œåŒ…çš„äº¤äº’è¿‡ç¨‹ä¸­ï¼Œæ¥æ”¶æ–¹ä¼šå°†ç¬¬äºŒéƒ¨åˆ†çš„å¤§å°ï¼Œä½œä¸ºAdvertisedWindowå‘é€ç»™å‘é€æ–¹ï¼Œå‘é€æ–¹å°±å¯ä»¥æ ¹æ®ä»–æ¥è°ƒæ•´å‘é€é€Ÿåº¦äº†ã€‚</p><p>åœ¨tcp_snd_wnd_testå‡½æ•°ä¸­ï¼Œä¼šåˆ¤æ–­sk_buffä¸­çš„end_seqå’Œtcp_wnd_end(tp)ä¹‹é—´çš„å…³ç³»ï¼Œä¹Ÿå³è¿™ä¸ªsk_buffæ˜¯å¦åœ¨æ»‘åŠ¨çª—å£çš„å…è®¸èŒƒå›´ä¹‹å†…ã€‚å¦‚æœä¸åœ¨èŒƒå›´å†…ï¼Œè¯´æ˜å‘é€è¦å—é™åˆ¶äº†ï¼Œæˆ‘ä»¬å°±è¦æŠŠis_rwnd_limitedè®¾ç½®ä¸ºtrueã€‚</p><p>æ¥ä¸‹æ¥ï¼Œtcp_mss_split_pointå‡½æ•°è¦è¢«è°ƒç”¨äº†ã€‚</p><pre><code>static unsigned int tcp_mss_split_point(const struct sock *sk,\n                                        const struct sk_buff *skb,\n                                        unsigned int mss_now,\n                                        unsigned int max_segs,\n                                        int nonagle)\n{\n        const struct tcp_sock *tp = tcp_sk(sk);\n        u32 partial, needed, window, max_len;\n\n        window = tcp_wnd_end(tp) - TCP_SKB_CB(skb)-&gt;seq;\n        max_len = mss_now * max_segs;\n\n        if (likely(max_len &lt;= window &amp;&amp; skb != tcp_write_queue_tail(sk)))\n                return max_len;\n\n        needed = min(skb-&gt;len, window);\n\n        if (max_len &lt;= needed)\n                return max_len;\n......\n        return needed;\n}\n</code></pre><p>è¿™é‡Œé¢é™¤äº†ä¼šåˆ¤æ–­ä¸Šé¢è®²çš„ï¼Œæ˜¯å¦ä¼šå› ä¸ºè¶…å‡ºmssè€Œåˆ†æ®µï¼Œè¿˜ä¼šåˆ¤æ–­å¦ä¸€ä¸ªæ¡ä»¶ï¼Œå°±æ˜¯æ˜¯å¦åœ¨æ»‘åŠ¨çª—å£çš„è¿è¡ŒèŒƒå›´ä¹‹å†…ï¼Œå¦‚æœå°äºçª—å£çš„å¤§å°ï¼Œä¹Ÿéœ€è¦åˆ†æ®µï¼Œä¹Ÿå³éœ€è¦è°ƒç”¨tso_fragmentã€‚</p><p>åœ¨ä¸€ä¸ªå¾ªç¯çš„æœ€åï¼Œæ˜¯è°ƒç”¨tcp_transmit_skbï¼ŒçœŸçš„å»å‘é€ä¸€ä¸ªç½‘ç»œåŒ…ã€‚</p><pre><code>static int tcp_transmit_skb(struct sock *sk, struct sk_buff *skb, int clone_it,\n                gfp_t gfp_mask)\n{\n    const struct inet_connection_sock *icsk = inet_csk(sk);\n    struct inet_sock *inet;\n    struct tcp_sock *tp;\n    struct tcp_skb_cb *tcb;\n    struct tcphdr *th;\n    int err;\n\n    tp = tcp_sk(sk);\n\n    skb-&gt;skb_mstamp = tp-&gt;tcp_mstamp;\n    inet = inet_sk(sk);\n    tcb = TCP_SKB_CB(skb);\n    memset(&amp;opts, 0, sizeof(opts));\n\n    tcp_header_size = tcp_options_size + sizeof(struct tcphdr);\n    skb_push(skb, tcp_header_size);\n\n    /* Build TCP header and checksum it. */\n    th = (struct tcphdr *)skb-&gt;data;\n    th-&gt;source      = inet-&gt;inet_sport;\n    th-&gt;dest        = inet-&gt;inet_dport;\n    th-&gt;seq         = htonl(tcb-&gt;seq);\n    th-&gt;ack_seq     = htonl(tp-&gt;rcv_nxt);\n    *(((__be16 *)th) + 6)   = htons(((tcp_header_size &gt;&gt; 2) &lt;&lt; 12) |\n                    tcb-&gt;tcp_flags);\n\n    th-&gt;check       = 0;\n    th-&gt;urg_ptr     = 0;\n......\n    tcp_options_write((__be32 *)(th + 1), tp, &amp;opts);\n    th-&gt;window  = htons(min(tp-&gt;rcv_wnd, 65535U));\n......\n    err = icsk-&gt;icsk_af_ops-&gt;queue_xmit(sk, skb, &amp;inet-&gt;cork.fl);\n......\n}\n</code></pre><p>tcp_transmit_skbè¿™ä¸ªå‡½æ•°æ¯”è¾ƒé•¿ï¼Œä¸»è¦åšäº†ä¸¤ä»¶äº‹æƒ…ï¼Œç¬¬ä¸€ä»¶äº‹æƒ…å°±æ˜¯å¡«å……TCPå¤´ï¼Œå¦‚æœæˆ‘ä»¬å¯¹ç€TCPå¤´çš„æ ¼å¼ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/be/0e/be225a97816a664367f29be9046aa30e.png?wh=2023*1183\" alt=\"\"></p><p>è¿™é‡Œé¢æœ‰æºç«¯å£ï¼Œè®¾ç½®ä¸ºinet_sportï¼Œæœ‰ç›®æ ‡ç«¯å£ï¼Œè®¾ç½®ä¸ºinet_dportï¼›æœ‰åºåˆ—å·ï¼Œè®¾ç½®ä¸ºtcb-&gt;seqï¼›æœ‰ç¡®è®¤åºåˆ—å·ï¼Œè®¾ç½®ä¸ºtp-&gt;rcv_nxtã€‚æˆ‘ä»¬æŠŠæ‰€æœ‰çš„flagsè®¾ç½®ä¸ºtcb-&gt;tcp_flagsã€‚è®¾ç½®é€‰é¡¹ä¸ºoptsã€‚è®¾ç½®çª—å£å¤§å°ä¸ºtp-&gt;rcv_wndã€‚</p><p>å…¨éƒ¨è®¾ç½®å®Œæ¯•ä¹‹åï¼Œå°±ä¼šè°ƒç”¨icsk_af_opsçš„queue_xmitæ–¹æ³•ï¼Œicsk_af_opsæŒ‡å‘ipv4_specificï¼Œä¹Ÿå³è°ƒç”¨çš„æ˜¯ip_queue_xmitå‡½æ•°ã€‚</p><pre><code>const struct inet_connection_sock_af_ops ipv4_specific = {\n        .queue_xmit        = ip_queue_xmit,\n        .send_check        = tcp_v4_send_check,\n        .rebuild_header    = inet_sk_rebuild_header,\n        .sk_rx_dst_set     = inet_sk_rx_dst_set,\n        .conn_request      = tcp_v4_conn_request,\n        .syn_recv_sock     = tcp_v4_syn_recv_sock,\n        .net_header_len    = sizeof(struct iphdr),\n        .setsockopt        = ip_setsockopt,\n        .getsockopt        = ip_getsockopt,\n        .addr2sockaddr     = inet_csk_addr2sockaddr,\n        .sockaddr_len      = sizeof(struct sockaddr_in),\n        .mtu_reduced       = tcp_v4_mtu_reduced,\n};\n</code></pre><h2>æ€»ç»“æ—¶åˆ»</h2><p>è¿™ä¸€èŠ‚ï¼Œæˆ‘ä»¬è§£æäº†å‘é€ä¸€ä¸ªç½‘ç»œåŒ…çš„ä¸€éƒ¨åˆ†è¿‡ç¨‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/dc/44/dc66535fa7e1a10fd6d728865f6c9344.png?wh=2923*2923\" alt=\"\"></p><p>è¿™ä¸ªè¿‡ç¨‹åˆ†æˆå‡ ä¸ªå±‚æ¬¡ã€‚</p><ul>\n<li>VFSå±‚ï¼šwriteç³»ç»Ÿè°ƒç”¨æ‰¾åˆ°struct fileï¼Œæ ¹æ®é‡Œé¢çš„file_operationsçš„å®šä¹‰ï¼Œè°ƒç”¨sock_write_iterå‡½æ•°ã€‚sock_write_iterå‡½æ•°è°ƒç”¨sock_sendmsgå‡½æ•°ã€‚</li>\n<li>Socketå±‚ï¼šä»struct fileé‡Œé¢çš„private_dataå¾—åˆ°struct socketï¼Œæ ¹æ®é‡Œé¢opsçš„å®šä¹‰ï¼Œè°ƒç”¨inet_sendmsgå‡½æ•°ã€‚</li>\n<li>Sockå±‚ï¼šä»struct socketé‡Œé¢çš„skå¾—åˆ°struct sockï¼Œæ ¹æ®é‡Œé¢sk_protçš„å®šä¹‰ï¼Œè°ƒç”¨tcp_sendmsgå‡½æ•°ã€‚</li>\n<li>TCPå±‚ï¼štcp_sendmsgå‡½æ•°ä¼šè°ƒç”¨tcp_write_xmitå‡½æ•°ï¼Œtcp_write_xmitå‡½æ•°ä¼šè°ƒç”¨tcp_transmit_skbï¼Œåœ¨è¿™é‡Œå®ç°äº†TCPå±‚é¢å‘è¿æ¥çš„é€»è¾‘ã€‚</li>\n<li>IPå±‚ï¼šæ‰©å±•struct sockï¼Œå¾—åˆ°struct inet_connection_sockï¼Œæ ¹æ®é‡Œé¢icsk_af_opsçš„å®šä¹‰ï¼Œè°ƒç”¨ip_queue_xmitå‡½æ•°ã€‚</li>\n</ul><h2>è¯¾å ‚ç»ƒä¹ </h2><p>å¦‚æœä½ å¯¹TCPåè®®çš„ç»“æ„ä¸å¤ªç†Ÿæ‚‰ï¼Œå¯ä»¥ä½¿ç”¨tcpdumpå‘½ä»¤æˆªå–ä¸€ä¸ªTCPçš„åŒ…ï¼Œçœ‹çœ‹é‡Œé¢çš„ç»“æ„ã€‚</p><p>æ¬¢è¿ç•™è¨€å’Œæˆ‘åˆ†äº«ä½ çš„ç–‘æƒ‘å’Œè§è§£ ï¼Œä¹Ÿæ¬¢è¿å¯ä»¥æ”¶è—æœ¬èŠ‚å†…å®¹ï¼Œåå¤ç ”è¯»ã€‚ä½ ä¹Ÿå¯ä»¥æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹ï¼Œå’Œä»–ä¸€èµ·å­¦ä¹ å’Œè¿›æ­¥ã€‚</p><p></p>","neighbors":{"left":{"article_title":"44 | Socketå†…æ ¸æ•°æ®ç»“æ„ï¼šå¦‚ä½•æˆç«‹ç‰¹å¤§é¡¹ç›®åˆä½œéƒ¨ï¼Ÿ","id":105980},"right":{"article_title":"46 | å‘é€ç½‘ç»œåŒ…ï¼ˆä¸‹ï¼‰ï¼šå¦‚ä½•è¡¨è¾¾æˆ‘ä»¬æƒ³è®©åˆä½œä¼™ä¼´åšä»€ä¹ˆï¼Ÿ","id":107209}},"comments":[{"had_liked":false,"id":123301,"user_name":"æ˜¯ç”·äººå°±å¼€å·´å·´æ‰˜æ–¯","can_delete":false,"product_type":"c1","uid":1352006,"ip_address":"","ucode":"C65873BBB28D05","user_header":"https://static001.geekbang.org/account/avatar/00/14/a1/46/3136ac25.jpg","comment_is_top":false,"comment_ctime":1565657800,"is_pvip":false,"replies":[{"id":"46306","content":"èµï¼Œå­¦ä»¥è‡´ç”¨","user_name":"ä½œè€…å›å¤","comment_id":123301,"uid":"1001590","ip_address":"","utype":1,"ctime":1566283311,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":5,"race_medal":0,"score":"31630428872","product_id":100024701,"comment_content":"æœ‰ä¸€æ¬¡åˆ†åˆ«åœ¨æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯æŠ“åŒ…<br>æœåŠ¡å™¨ç«¯çš„åŒ…éƒ½æ˜¯å¥½å‡ k åå‡ k.<br>å®¢æˆ·ç«¯çš„åŒ…æ˜¯1400å¤š ä¸€å¼€å§‹æ²¡å¼„æ˜ç™½éƒ½mtuäº†ä¸ºä»€ä¹ˆè¿˜æœ‰å¥½å‡ kçš„åŒ…<br>åæ¥æŸ¥åˆ°å†…æ ¸å¯ä»¥é…ç½®ç½‘ç»œå‚æ•°ï¼Œä¸æŠŠæ‹†åŒ…äº¤ç»™ç½‘å¡å›ºä»¶ï¼Œè‡ªå·±åˆ†åŒ…ã€‚","like_count":7,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":462616,"discussion_content":"èµï¼Œå­¦ä»¥è‡´ç”¨","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566283311,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1002005,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/4a/15/106eaaa8.jpg","nickname":"stackWarn","note":"","ucode":"89672E452DEBA5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":312132,"discussion_content":"è¿™ä¸ªæ˜¯å¯¹çš„ æˆ‘é¢è¯•çš„æ—¶å€™æœ‰æ—¶å€™ä¼šé—®åˆ°","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1602591101,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1398884,"avatar":"https://static001.geekbang.org/account/avatar/00/15/58/64/b715d45a.jpg","nickname":"ä½•æŸ„è","note":"","ucode":"A4C165D1EE3726","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":160578,"discussion_content":"ä½ ç¡®å®šè¿™ä¸ªä¸æ˜¯æŠ“åŒ…è½¯ä»¶çš„æœºåˆ¶ï¼Ÿï¼ŸæœåŠ¡å™¨ä¸€èˆ¬ä¼šè®©åŒ…åå‡ kè¿™ä¹ˆå¤§ï¼Ÿï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580817457,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1352006,"avatar":"https://static001.geekbang.org/account/avatar/00/14/a1/46/3136ac25.jpg","nickname":"æ˜¯ç”·äººå°±å¼€å·´å·´æ‰˜æ–¯","note":"","ucode":"C65873BBB28D05","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1398884,"avatar":"https://static001.geekbang.org/account/avatar/00/15/58/64/b715d45a.jpg","nickname":"ä½•æŸ„è","note":"","ucode":"A4C165D1EE3726","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":177312,"discussion_content":"tsoå‚æ•°äº†è§£ä¸€ä¸‹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582093785,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":160578,"ip_address":""},"score":177312,"extra":""},{"author":{"id":1352006,"avatar":"https://static001.geekbang.org/account/avatar/00/14/a1/46/3136ac25.jpg","nickname":"æ˜¯ç”·äººå°±å¼€å·´å·´æ‰˜æ–¯","note":"","ucode":"C65873BBB28D05","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1398884,"avatar":"https://static001.geekbang.org/account/avatar/00/15/58/64/b715d45a.jpg","nickname":"ä½•æŸ„è","note":"","ucode":"A4C165D1EE3726","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":177322,"discussion_content":"https://blog.csdn.net/hejm0822/article/details/80412392","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1582094431,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":160578,"ip_address":""},"score":177322,"extra":""}]}]},{"had_liked":false,"id":176905,"user_name":"å¿†æ°´å¯’","can_delete":false,"product_type":"c1","uid":1147453,"ip_address":"","ucode":"E3F86BD8AA8903","user_header":"https://static001.geekbang.org/account/avatar/00/11/82/3d/356fc3d6.jpg","comment_is_top":false,"comment_ctime":1581220011,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"23056056491","product_id":100024701,"comment_content":"ä»ç½‘ç»œåè®®ä¸“æ çœ‹å®Œè¿‡æ¥çš„ï¼Œtcpåè®®å®é™…ä¸Šå¾ˆç†Ÿæ‚‰ï¼Œæ‰€ä»¥çœ‹è¿™ç¯‡æ–‡ç« å¤§æ¦‚éƒ½æ‡‚ã€‚ä½†æ˜¯æ¯æ¬¡è¯»éƒ½èƒ½æœ‰æ–°çš„ä½“ä¼šã€‚","like_count":5},{"had_liked":false,"id":154905,"user_name":"è°›å¬","can_delete":false,"product_type":"c1","uid":1228687,"ip_address":"","ucode":"7539D5B06662EA","user_header":"https://static001.geekbang.org/account/avatar/00/12/bf/8f/51f044dc.jpg","comment_is_top":false,"comment_ctime":1574595236,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"23049431716","product_id":100024701,"comment_content":"VFS: æ‹¿åˆ° file ä¸­çš„ socketï¼Œè¿›è€Œå¾—åˆ° sockï¼Œè¿›è€Œè°ƒç”¨ tcp_sendmsg<br>tcp_sendmsg: å°†ç”¨æˆ·æ•°æ®æ‹·åˆ° sk_buffï¼Œä¸æ–­å¾ªç¯å‘é€ï¼Œå‘é€è¿‡ç¨‹ä¸­è®¡ç®— MSSï¼Œæ‹†åˆ†æˆä¸€ä¸ªä¸ªçš„ <br>                    Segment æ”¾åœ¨ä¸€ä¸ªä¸ªçš„ IP åŒ…é‡Œé¢ï¼Œæ•°æ®å¯æ‹·è´åˆ°è¿ç»­çš„åŒºåŸŸï¼Œä¹Ÿå¯ä»¥æ‹·åˆ°ä¸è¿ç»­çš„åŒºåŸŸ<br>                  ï¼ˆ éœ€è¦ç½‘ç»œè®¾å¤‡æ”¯æŒåˆ†æ•£èšåˆï¼‰ï¼Œæœ€åè°ƒç”¨ tcp_write_xmit å‘é€ç½‘ç»œåŒ…<br>tcp_write_xmitï¼šTSO--åˆ†æ®µå¯ç”±å†…æ ¸åšï¼Œæ¯”è¾ƒè€—CPUï¼Œä¹Ÿå»¶è¿Ÿåˆ°ç½‘å¡åšï¼›<br>                       æ‹¥å¡çª—å£--é¿å…æŠŠç½‘ç»œå¡æ»¡ï¼›<br>                       æ»‘åŠ¨çª—å£--é¿å…æŠŠæ¥æ”¶ç«¯å¡æ»¡<br>tcp_transmit_skbï¼šå¡«å……tcpæŠ¥æ–‡ï¼Œå‘é€ç½‘ç»œåŒ…<br>","like_count":6,"discussions":[{"author":{"id":1902002,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/05/b2/93b64021.jpg","nickname":"Geek_jikuo","note":"","ucode":"D4AF9E736701B8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":389514,"discussion_content":"æ„Ÿè°¢æ€»ç»“ï¼Œçœ‹åˆ°æ€»ç»“èŒç”Ÿäº†ä¸€ä¸ªé—®é¢˜ï¼štcp_sendmsgå¦‚æœå·²ç»åˆ†æ®µäº†ï¼Œtcp_write_xmitè¿˜è¦æ¨è¿Ÿåˆ°ç½‘å¡åˆ†æ®µå—TSOå—ï¼Ÿæˆ–è€…è¯´å°±åˆ†æ®µæ¥è¯´ï¼Œtcp_sendmsgï¼Œtcp_write_xmitçš„æœºåˆ¶æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆtcp_sendmsgä»ä»£ç æ¥çœ‹å·²ç»åˆ†æ®µäº†ï¼‰\n\n\nç½‘ä¸Šæœäº†ä¸€ç¯‡èµ„æ–™+æ‹ä»£ç å¾—åˆ°ç­”æ¡ˆï¼š\nï¼ˆè¿æ¥å¤ªé•¿ï¼Œå•ç‹¬èµ·ä¸€ä¸ªè¯„è®ºï¼‰\nç­”æ¡ˆï¼š\nï¼ˆ1ï¼‰TSOæ˜¯ç”±ç¡¬ä»¶ç½‘å¡æ”¯æŒçš„åŠŸèƒ½ï¼Œåˆå§‹åŒ–çš„æ—¶å€™ä¼šé€šçŸ¥tcpå±‚çš„å‡½æ•°\nï¼ˆ2ï¼‰tcp_sock *tp->gso_segsè¿™ä¸ªå‚æ•°å†³å®šäº†æ˜¯å¦è¦è¿›è¡ŒTSO\nï¼ˆ3ï¼‰tcp_sendmsgè‚¯å®šè¦è¿›è¡Œåˆ†æ®µäº†ï¼Œåªä¸è¿‡å¤§å°ä¸ºmssçš„gso_segså€æ•°;å¦‚æœæ”¯æŒTSOï¼Œtcp_sendmsgå°±ä¼šå°†è¶…è¿‡mssçš„æŠ¥æ–‡åˆ†æˆmss * gso_segs\n\néšä¹‹è€Œæ¥çš„é—®é¢˜å°±æ˜¯ï¼šå¦‚æœæ”¯æŒTSOï¼ŒIPè¿˜ä¼šåˆ†ç‰‡å—ï¼Ÿ\n\nç­”æ¡ˆï¼šä¸ä¼šã€‚\nç»§ç»­çœ‹46èŠ‚å°±å¯çŸ¥é“äº†ç­”æ¡ˆï¼ˆæ²¡é”™ï¼Œ45èŠ‚çš„é—®é¢˜ï¼Œæˆ‘æ˜¯çœ‹å®Œ46èŠ‚ä¹‹åå›ç­”çš„ï¼‰\nç­”æ¡ˆå°±åœ¨è¿™ä¸ªå‡½æ•°é‡Œip_finish_output()ï¼Œè¿™ä¸ªå‡½æ•°æˆ‘æ²¡æœ‰ä»”ç»†åœ°é˜…è¯»ï¼Œä½†æ˜¯ä»ä»£ç å¤§é¢æ„æ€ï¼ˆä»¥åŠç½‘ä¸Šèµ„æ–™ï¼‰å¾—å‡ºä¸ä¼šåˆ†ç‰‡ã€‚\n\nip_finish_outputä¸»è¦æœ‰ä¸¤ä¸ªè¿”å›å‡½æ•°ï¼š\n\n(1) return ip_finish_output_gso() ->ip_finish_output2()\nï¼ˆè¿™æ®µä»£ç ï¼Œè€å¸ˆå¾ˆå·§åœ°ç•¥è¿‡äº†ï¼Œä¸è¿‡ç†è§£ï¼Œå†…æ ¸ç¡®å®å¾ˆç²¾å¦™ï¼‰\n\n(2) return ip_finish_output2()\n=====================\nå¦‚æœä¸æ˜¯æœ‰ä¸¤æ®µå¤„ç†é€»è¾‘ï¼Œæ‹¿å¹²å˜›å†™ä¸¤ä¸ªå‘¢ï¼Ÿæ‰€ä»¥æ”¯æŒTSOæ—¶ï¼Œä¸åˆ†ç‰‡ï¼Œç•™ç»™ç½‘å¡ï¼\n\næ¬¢è¿è®¨è®ºæŒ‡æ­£ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629299869,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1902002,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/05/b2/93b64021.jpg","nickname":"Geek_jikuo","note":"","ucode":"D4AF9E736701B8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":389513,"discussion_content":"https://www.cnblogs.com/lvyilong316/p/6818231.html#:~:text=TSO%20%28TCP,Segmentation%20Offload%29%3A%20%E6%98%AF%E4%B8%80%E7%A7%8D%E5%88%A9%E7%94%A8%E7%BD%91%E5%8D%A1%E6%9D%A5%E5%AF%B9%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%8C%85%E8%BF%9B%E8%A1%8C%E8%87%AA%E5%8A%A8%E5%88%86%E6%AE%B5%EF%BC%8C%E9%99%8D%E4%BD%8ECPU%E8%B4%9F%E8%BD%BD%E7%9A%84%E6%8A%80%E6%9C%AF%E3%80%82","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629299781,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":253088,"user_name":"stackWarn","can_delete":false,"product_type":"c1","uid":1002005,"ip_address":"","ucode":"89672E452DEBA5","user_header":"https://static001.geekbang.org/account/avatar/00/0f/4a/15/106eaaa8.jpg","comment_is_top":false,"comment_ctime":1602591145,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5897558441","product_id":100024701,"comment_content":"ä½œä¸ºä¸€ä¸ªè¿ç»´ï¼Œè¿™èŠ‚ç®—æ˜¯è¿™é‡Œé¢å¬çš„æœ€è½»æ¾çš„ä¸€æ¬¡äº†ï¼Œä¹‹å‰çœ‹è¿‡è¿™éƒ¨åˆ†çš„ä»£ç ï¼Œå‡½æ•°åéƒ½æœ‰ç‚¹å°è±¡å“ˆå“ˆ","like_count":1},{"had_liked":false,"id":220595,"user_name":"ä½³ä¿Š","can_delete":false,"product_type":"c1","uid":1385803,"ip_address":"","ucode":"A54445937EEF21","user_header":"https://static001.geekbang.org/account/avatar/00/15/25/4b/4cbd001e.jpg","comment_is_top":false,"comment_ctime":1590292011,"is_pvip":false,"replies":[{"id":"83068","content":"å°±æ˜¯mssçš„é™åˆ¶å‘€","user_name":"ä½œè€…å›å¤","comment_id":220595,"uid":"1001590","ip_address":"","utype":1,"ctime":1591785321,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":2,"race_medal":0,"score":"5885259307","product_id":100024701,"comment_content":"sk_buffå·²ç»å¯¹mssåšäº†åˆ†ç‰‡å¤„ç†äº†ï¼Œä¸ºä»€ä¹ˆè¿˜è¦åœ¨ipå†åšä¸€æ¬¡åˆ†ç‰‡å¤„ç†ã€‚sk_buffæœ‰æœ€å¤§çš„é™åˆ¶å—ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":496184,"discussion_content":"å°±æ˜¯mssçš„é™åˆ¶å‘€","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591785321,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1517457,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKkzrezV2dOBAgickt9DLzabz3dNFYyDEVXENMQ5ibrWhFbFqXIOia3ZaR21pozvB7UfoxJx4Ar688sA/132","nickname":"å¼€å¿ƒ","note":"","ucode":"C8E08E8724C7CE","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":383728,"discussion_content":"æœ‰mssé™åˆ¶ï¼Œé‚£æ¯ä¸ªsk_bufferçš„æ•°æ®å·²ç»ä¸ä¼šè¶…è¿‡mssäº†å‘€ï¼Œä¸ºä»€ä¹ˆåœ¨åç»­é€»è¾‘é‡Œåˆå»åˆ†åŒ…å‘¢ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1626225529,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":112946,"user_name":"W.jyao","can_delete":false,"product_type":"c1","uid":1422582,"ip_address":"","ucode":"C57B3A78B6A795","user_header":"https://static001.geekbang.org/account/avatar/00/15/b4/f6/735673f7.jpg","comment_is_top":false,"comment_ctime":1562853032,"is_pvip":false,"replies":[{"id":"46685","content":"åˆ†ç‰‡å†ç»„åˆä¼šå¢åŠ æ—¶å»¶","user_name":"ä½œè€…å›å¤","comment_id":112946,"uid":"1001590","ip_address":"","utype":1,"ctime":1566380216,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":2,"race_medal":0,"score":"5857820328","product_id":100024701,"comment_content":"è€å¸ˆï¼Œè¯·æ•™ä¸€ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆæµåª’ä½“æœåŠ¡å™¨å‘é€çš„rtpåŒ…éƒ½è¦å°äº1500å·¦å³ï¼Œä¹Ÿå°±æ˜¯å°äºMTUï¼Œç†è®ºä¸Šä¸æ˜¯å¤§äº1500ä¼šåˆ†ç‰‡å—ï¼Ÿä½†æ˜¯å¥½åƒå®ç°çš„ä»£ç éƒ½ä¼šå°äºMtuï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457969,"discussion_content":"åˆ†ç‰‡å†ç»„åˆä¼šå¢åŠ æ—¶å»¶","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566380216,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1219496,"avatar":"https://static001.geekbang.org/account/avatar/00/12/9b/a8/6a391c66.jpg","nickname":"LeonğŸ“·","note":"","ucode":"B9BBD1EFAAE5A2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1892,"discussion_content":"tcpä¼šåœ¨å‘é€çš„æ—¶å€™æ§åˆ¶å¤§å°ï¼Œåˆ†æˆmssæ®µï¼Œudpä¸ä¼šï¼Œä¼šåœ¨é“¾è·¯å±‚è¿›è¡Œåˆ†ç‰‡ï¼Œåˆ°ç›®çš„æ®µè¿›è¡Œé‡ç»„ï¼Œè¿™æ ·å°±ä¼šå½±å“æ¥æ”¶ç«¯çš„æ€§èƒ½ï¼Œrtpå¦‚æœå¤§äº1500.æ¥æ”¶ç«¯å°±è¯†åˆ«ä¸äº†","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1563067116,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":345526,"user_name":"Geek_2b44d4","can_delete":false,"product_type":"c1","uid":2925499,"ip_address":"","ucode":"8283C03D322999","user_header":"","comment_is_top":false,"comment_ctime":1652356784,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1652356784","product_id":100024701,"comment_content":"è¯·æ•™ä¸€ä¸‹ï¼Œè¿™é‡Œè¿›è¡Œåˆ†æ®µåï¼Œæ¯ä¸ªæ®µæ˜¯å¦æ—¶ç±»ä¼¼é“¾è¡¨ç»“æ„ï¼Ÿåˆ†åŒ…å‘é€çš„æ—¶å€™ï¼Œæ˜¯ä¸æ˜¯æ¯ä¸ªåŒ…é‡Œé¢éƒ½æ ‡è®°äº†ä¸Šä¸€ä¸ªä¸ä¸‹ä¸€ä¸ªçš„æ ‡è¯†ï¼Œè¿™æ ·æ¥æ”¶æ–¹æ”¶åˆ°åå°±å¯ä»¥é‡æ’äº†ï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯è¿™æ ·ï¼Ÿ","like_count":0},{"had_liked":false,"id":344343,"user_name":"ç¨‹åºå‘˜è€ç‹","can_delete":false,"product_type":"c1","uid":1025340,"ip_address":"","ucode":"28577A15F064CF","user_header":"https://static001.geekbang.org/account/avatar/00/0f/a5/3c/7c0d2e57.jpg","comment_is_top":false,"comment_ctime":1651481844,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1651481844","product_id":100024701,"comment_content":"send å¾ˆå¤§æ•°æ®ã€‚å‡å¦‚ç½‘ç»œæ­£å¸¸ï¼Œå›å¤±è´¥å—ï¼Ÿskbå›è‡ªåŠ¨å¢åŠ ï¼Œæ²¡æœ‰é˜»å¡å’Œé˜»å¡è€… ä¸€è¯´å§ï¼Ÿ","like_count":0},{"had_liked":false,"id":339403,"user_name":"herongwei","can_delete":false,"product_type":"c1","uid":1153928,"ip_address":"","ucode":"E4158BF7AD2E70","user_header":"https://static001.geekbang.org/account/avatar/00/11/9b/88/34c171f1.jpg","comment_is_top":false,"comment_ctime":1648083241,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1648083241","product_id":100024701,"comment_content":"è€å¸ˆè®²çš„çœŸçš„éå¸¸å¥½ï¼å¸¸çœ‹å¸¸æ–°","like_count":0},{"had_liked":false,"id":281513,"user_name":"jackji","can_delete":false,"product_type":"c1","uid":1464086,"ip_address":"","ucode":"4DDD9A286A785B","user_header":"https://static001.geekbang.org/account/avatar/00/16/57/16/eef7c4ac.jpg","comment_is_top":false,"comment_ctime":1614770539,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1614770539","product_id":100024701,"comment_content":"è€å¸ˆ æ–‡ä¸­ä»£ç å¯¹åº”çš„kernelç‰ˆæœ¬æ˜¯ï¼Ÿ","like_count":0},{"had_liked":false,"id":162469,"user_name":"bbbi","can_delete":false,"product_type":"c1","uid":1682175,"ip_address":"","ucode":"9A539AEF791428","user_header":"https://static001.geekbang.org/account/avatar/00/19/aa/ff/e2c331e0.jpg","comment_is_top":false,"comment_ctime":1576543801,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1576543801","product_id":100024701,"comment_content":"è€å¸ˆä¸€ä¸ªsk_buffå¤šå¤§å‘¢ï¼Ÿè¿™ä¸ªé“¾è¡¨å¯ä»¥æ— é™é•¿å—ï¼Ÿ","like_count":0},{"had_liked":false,"id":155243,"user_name":"è®°äº‹æœ¬","can_delete":false,"product_type":"c1","uid":1362659,"ip_address":"","ucode":"76F2CAFA309437","user_header":"https://static001.geekbang.org/account/avatar/00/14/ca/e3/447aff89.jpg","comment_is_top":false,"comment_ctime":1574671185,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1574671185","product_id":100024701,"comment_content":"è€å¸ˆå¥½  è¿™éƒ¨åˆ†çš„å†…å®¹æœ‰æ²¡æœ‰å‚è€ƒä¹¦å¯ä»¥çœ‹çœ‹çš„ï¼Ÿ","like_count":0},{"had_liked":false,"id":112821,"user_name":"ä¸€æ¢¦å¦‚æ˜¯","can_delete":false,"product_type":"c1","uid":1305308,"ip_address":"","ucode":"9CCB1D0E547C83","user_header":"https://static001.geekbang.org/account/avatar/00/13/ea/dc/9a970e98.jpg","comment_is_top":false,"comment_ctime":1562829201,"is_pvip":false,"replies":[{"id":"46690","content":"Hugepageä¸ä¼šå°†é¡µé¢æ”¾åˆ°ç¼“å­˜é‡Œé¢çš„ï¼Œè€Œæ˜¯TLBç¼“å­˜å‡å°‘ä¸å‘½ä¸­çš„æ¦‚ç‡ã€‚","user_name":"ä½œè€…å›å¤","comment_id":112821,"uid":"1001590","ip_address":"","utype":1,"ctime":1566380629,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":2,"race_medal":0,"score":"1562829201","product_id":100024701,"comment_content":"è€å¸ˆå¥½ï¼Œè¯·æ•™ä¸€ä¸ªå›°æƒ‘å¾ˆä¹…çš„é—®é¢˜ï¼Œcpuçš„L1ï¼ŒL2ï¼ŒL3çº§cacheï¼Œç¼“å­˜çš„æ•°æ®æ˜¯ä»¥å†…å­˜çš„é¡µä¸ºå•ä½çš„å—<br>oracle sgaåœ¨å¤§å†…å­˜æ—¶ï¼Œé€šå¸¸ä¼šé…ç½®hugepageä»¥å‡å°‘TLBçš„å‹åŠ›å’Œswapçš„äº¤æ¢ç”¨æ¥æé«˜æ€§èƒ½ï¼Œlinuxï¼ˆcentos)ä¸‹é»˜è®¤æ˜¯2Mï¼Œè€Œä¸€èˆ¬cpu L1æ˜¯32+32K,L2æ˜¯256Kï¼Œæ˜¯ä¸æ˜¯å°±æ„å‘³ç€æ²¡æ³•ä½¿ç”¨è¿™ä¸¤çº§ç¼“å­˜äº†","like_count":0,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457921,"discussion_content":"Hugepageä¸ä¼šå°†é¡µé¢æ”¾åˆ°ç¼“å­˜é‡Œé¢çš„ï¼Œè€Œæ˜¯TLBç¼“å­˜å‡å°‘ä¸å‘½ä¸­çš„æ¦‚ç‡ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566380629,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1753178,"avatar":"","nickname":"Geek_81c14d","note":"","ucode":"8975EA012433A8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":267245,"discussion_content":"ç¼“å­˜çš„æ•°æ®ä¸æ˜¯ä»¥å†…å­˜é¡µä¸ºå•ä½ç½®æ¢çš„ï¼Œè€Œæ˜¯ä»¥cacheä¸­çš„å—ç½®æ¢çš„ä¸€èˆ¬ä¸º64kb","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589619697,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}