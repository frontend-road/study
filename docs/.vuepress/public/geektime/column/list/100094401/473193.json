{"id":473193,"title":"34 | ç¼–è¯‘åŸç†ï¼ˆä¸‹ï¼‰ï¼šç¼–è¯‘åŸç†ç»™æˆ‘ä»¬å¸¦æ¥äº†ä»€ä¹ˆï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å¤§åœ£ã€‚</p><p>ä¸Šä¸€è®²æˆ‘ä»¬æ·±å…¥ç ”ç©¶äº† Vue é‡Œçš„ compiler-dom å’Œ compiler-core çš„æµç¨‹ï¼Œç›¸ä¿¡å­¦å®Œä¹‹åï¼Œä½ å·²ç»å¯¹ç¼–è¯‘åŸç†çš„åŸºç¡€çŸ¥è¯†å¾ˆç†Ÿæ‚‰äº†ã€‚</p><p>è¿™æ—¶å€™ä½ è‚¯å®šä¼šæœ‰ä¸€ä¸ªç–‘é—®ï¼ŒASTã€transformã€generateè¿™äº›æ¦‚å¿µä»¥å‰å·¥ä½œä¸­ä¹Ÿæ²¡é‡è§è¿‡ï¼Œéš¾é“å­¦äº†è¿™ä¸ªå°±åªèƒ½é¢è¯•ç”¨å—ï¼Ÿ å½“ç„¶ä¸æ˜¯ï¼Œç¼–è¯‘åŸç†ä½œä¸ºè®¡ç®—æœºä¸–ç•Œçš„ä¸€ä¸ªé‡è¦çš„å­¦ç§‘ï¼Œé™¤äº†æ¢ç©¶åŸç†å’Œæºç ä¹‹å¤–ï¼Œæˆ‘ä»¬å·¥ä½œä¸­ä¹Ÿæœ‰å¾ˆå¤šåœ°æ–¹å¯ä»¥ç”¨åˆ°ã€‚</p><p>ä»å®è§‚è§†è§’æ¥çœ‹ï¼Œç¼–è¯‘åŸç†å®ç°çš„åŠŸèƒ½å°±æ˜¯ä»£ç ä¹‹é—´çš„è½¬æ¢ã€‚å“ªæ€•æˆ‘ä»¬åªæ˜¯æŒæ¡äº†å…¥é—¨çŸ¥è¯†ï¼Œä¹Ÿèƒ½å¯ä»¥å®ç°Vueä¸­ templateåˆ°renderå‡½æ•°è½¬åŒ–è¿™æ ·çš„åŠŸèƒ½ã€‚</p><p>ç°åœ¨çš„å‰ç«¯å‘å±•ï¼Œå¾ˆå¤§ç¨‹åº¦ä¸Šç¦»ä¸å¼€ç¼–è¯‘åŸç†åœ¨å‰ç«¯åœˆçš„è½åœ°å®è·µï¼Œåªè¦æ˜¯æˆ‘ä»¬æƒ³åšè‡ªåŠ¨åŒ–ä»£ç è½¬åŒ–çš„åœ°æ–¹ï¼Œéƒ½å¯ä»¥çœ‹åˆ°ç¼–è¯‘çš„èº«å½±ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼ŒBabelæŠŠES6ä¸­çš„æ–°è¯­æ³•è½¬æ¢æˆä½ç‰ˆæœ¬æµè§ˆå™¨æ”¯æŒçš„è¯­æ³•ï¼Œæˆ‘ä»¬æ‰èƒ½åœ¨é¡¹ç›®ä¸­æ„‰å¿«åœ°ä½¿ç”¨ç®­å¤´å‡½æ•°ç­‰ç‰¹æ€§ï¼ŒæŠŠæµè§ˆå™¨çš„å…¼å®¹æ€§äº¤ç»™Babelæ¥å¤„ç†ï¼Œç”šè‡³ç°åœ¨ç¤¾åŒºå†…è¿˜å‡ºç°äº†gogocodeè¿™ç§æŠŠVue 2ä»£ç è½¬æ¢æˆVue 3ä»£ç çš„å·¥å…·ã€‚</p><p>åœ¨å·¥ä½œä¸­æˆ‘ä»¬å¯ä»¥å€ŸåŠ©Babelå’Œviteæä¾›ç»™æˆ‘ä»¬çš„èƒ½åŠ›ï¼Œparseï¼Œtransformï¼Œgenerateç­‰ä»£ç éƒ½ä¸éœ€è¦æˆ‘ä»¬è‡ªå·±å®ç°ï¼Œåªéœ€è¦è€ƒè™‘ä»£ç è½¬æ¢çš„é€»è¾‘å°±å¯ä»¥äº†ï¼Œä¸‹é¢æˆ‘ç»™ä½ ä¸¾å‡ ä¸ªå°ä¾‹å­ã€‚</p><!-- [[[read_end]]] --><h2>vite æ’ä»¶</h2><p>é¦–å…ˆæˆ‘ä»¬åœ¨é¡¹ç›®ä¸­ä½¿ç”¨äº†script setupæ¥ç»„ç»‡æˆ‘ä»¬çš„ä»£ç ï¼Œè™½ç„¶ç»„ä»¶å¼•å…¥ä¹‹åæœ‰äº†è‡ªåŠ¨æ³¨å†Œçš„åŠŸèƒ½ï¼Œä½†æ˜¯æ¯ä¸€ä¸ªç»„ä»¶å†…éƒ¨éƒ½è‚¯å®šè¦ç”¨åˆ°refã€computedç­‰Vueæä¾›çš„APIã€‚æˆ‘ä»¬è¿˜æƒ³è¦å¤šä¸€æ­¥ï¼Œé¡¹ç›®å¤§äº†åªå¼•å…¥refçš„è¯­å¥å°±å†™äº†å‡ ç™¾è¡Œï¼Œå°±ä¼šéå¸¸åœ°ç¹çï¼Œè¿™æ—¶å€™å°±å¯ä»¥ä½¿ç”¨ç¼–è¯‘çš„æ€æƒ³æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><p>é¦–å…ˆrefã€computedã€watchç­‰Vueæä¾›çš„APIï¼Œæˆ‘ä»¬åœ¨åé¢çš„ä»£ç è°ƒç”¨å¯ä»¥é€šè¿‡æ­£åˆ™åŒ¹é…çš„æ–¹å¼ï¼Œå®Œå…¨å¯ä»¥åˆ†æå‡ºæ¥å½“å‰ç»„ä»¶ä¾èµ–çš„APIæœ‰å“ªäº›ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ç»„ä»¶æ‰§è¡Œä¹‹å‰è‡ªåŠ¨å¯¼å…¥è¿™äº›APIã€‚</p><p>æˆ‘ä»¬åœ¨weiyouyié¡¹ç›®ä¸­ä½¿ç”¨viteæ’ä»¶çš„å½¢å¼æ¥å®Œæˆè¿™ä¸ªå·¥ä½œã€‚ç¤¾åŒºå†…å·²ç»æœ‰å¯ç”¨çš„ <a href=\"https://github.com/antfu/unplugin-auto-import\">auto-imput</a> æ’ä»¶äº†ï¼Œä¸è¿‡è¿™é‡Œä¸ºäº†åŠ æ·±å¯¹æŠ€æœ¯çš„ç†è§£ï¼Œå’±ä»¬è¿˜æ˜¯è‡ªå·±æ¥å®ç°ä¸€ä¸ªã€‚</p><p>é¦–å…ˆæˆ‘ä»¬è¿›å…¥åˆ°æ ¹ç›®å½•ä¸‹çš„vite.config.jsæ–‡ä»¶ä¸­ï¼Œå¯¼å…¥autoPluginæ’ä»¶åï¼Œé…ç½®åœ¨viteçš„pluginsæ’ä»¶ä¸­ã€‚</p><pre><code class=\"language-javascript\">import vue from '@vitejs/plugin-vue'\nimport autoPlgin from './src/auto-import'\nexport default defineConfig({\n  plugins: [vue(),autoPlgin()]\n})\n\n</code></pre><p>ç„¶åæˆ‘ä»¬æ¥å®ç°autoPluginå‡½æ•°ï¼Œviteçš„æ’ä»¶å¼€å‘æ–‡æ¡£ä½ å¯ä»¥åœ¨<a href=\"https://cn.vitejs.dev/guide/api-plugin.html\">å®˜ç½‘ä¸­</a>æŸ¥è¯¢ï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†ã€‚</p><p>æˆ‘ä»¬ç›´æ¥çœ‹ä»£ç ï¼Œæˆ‘ä»¬å…ˆå®šä¹‰äº†Vue 3æä¾›çš„APIæ•°ç»„ï¼Œæœ‰refã€computedç­‰ç­‰ã€‚ç„¶åï¼ŒautoImportPluginå‡½æ•°å¯¹å¤–å¯¼å‡ºä¸€ä¸ªå¯¹è±¡ï¼Œtransformå‡½æ•°å°±æ˜¯æ ¸å¿ƒè¦å®ç°çš„é€»è¾‘ã€‚</p><p>è¿™é‡Œçš„helperå’Œæˆ‘ä»¬åœ¨32è®²ä¸­çš„å·¥å…·å‡½æ•°å®ç°é€»è¾‘ä¸€è‡´ï¼Œé€šè¿‡new Regexpåˆ›å»ºæ¯ä¸ªå‡½æ•°åŒ¹é…çš„æ­£åˆ™ã€‚å¦‚æœåŒ¹é…åˆ°å¯¹åº”çš„APIï¼Œå°±æŠŠAPIçš„åå­—åŠ å…¥åˆ°helperé›†åˆä¸­ï¼Œæœ€ååœ¨script setupçš„æœ€ä¸Šæ–¹åŠ å…¥ä¸€è¡Œimportè¯­å¥ã€‚</p><pre><code class=\"language-javascript\">\nconst vue3 = [\n  'ref',\n  'computed',\n  'reactive',\n  'onMounted',\n  'watchEffect',\n  'watch'\n] // è¿˜æœ‰å¾ˆå¤š....\n\nexport default function autoImportPlugin() {\n  return {\n    name: 'vite-plugin-auto-import', // å¿…é¡»çš„ï¼Œå°†ä¼šåœ¨ warning å’Œ error ä¸­æ˜¾ç¤º\n    enforce:'pre',\n    transform(code,id){\n      vueReg = /\\.vue$/\n      if(vueReg.test(id)){\n        const helpers = new Set()\n        vue3.forEach(api=&gt;{\n          const reg = new RegExp(api+\"(.*)\")\n          if(reg.test(code)){\n            helpers.add(api)\n          }\n        })\n        return code.replace('&lt;script setup&gt;',`&lt;script setup&gt;\n\nimport {${[...helpers].join(',')}} from 'vue' //ä¿ºæ˜¯è‡ªåŠ¨å¯¼å…¥çš„        \n`)\n      }\n      return code\n    }\n  }\n}\n</code></pre><p>æ¥ç€ï¼Œæˆ‘ä»¬åœ¨é¡¹ç›®çš„srcç›®å½•ä¸‹æ–°å»ºApp.vueã€‚ä¸‹é¢çš„ä»£ç å®ç°äº†ä¸€ä¸ªç®€æ˜“çš„ç´¯åŠ å™¨ï¼Œå¹¶ä¸”è¿˜ä¼šåœ¨onMountä¹‹åæ‰“å°ä¸€æ¡ä¿¡æ¯ï¼Œè¿™é‡Œçš„refã€computedå’ŒonMountedéƒ½æ˜¯æ²¡æœ‰å¯¼å…¥çš„ã€‚æˆ‘ä»¬åœ¨æµè§ˆå™¨å°±èƒ½çœ‹åˆ°é¡µé¢å¯ä»¥æ­£å¸¸æ˜¾ç¤ºï¼Œè¿™æ—¶æˆ‘ä»¬åœ¨æµè§ˆå™¨è°ƒè¯•çª—å£çš„sourcesé¡µé¢ä¸­ï¼Œå°±å¯ä»¥çœ‹åˆ°App.vueçš„ä»£ç å·²ç»è‡ªåŠ¨åŠ ä¸Šäº†importè¯­å¥ã€‚</p><pre><code class=\"language-javascript\">&lt;template&gt;\n  &lt;div @click=\"add\"&gt;\n    {{num}} * 2 = {{double}}\n  &lt;/div&gt;\n&lt;/template&gt;\n\n&lt;script setup&gt;\nlet num = ref(1)\nlet double = computed(()=&gt;num.value*2)\n\nfunction add(){\n  num.value++\n}\nonMounted(()=&gt;{\n  console.log('mounted')\n})\n\n&lt;/script&gt;\n</code></pre><h2><img src=\"https://static001.geekbang.org/resource/image/77/fd/77db83e745d7345a146f03364d93cbfd.png?wh=1662x790\" alt=\"å›¾ç‰‡\"></h2><p>è¿™é‡Œçš„ä»£ç éƒ½æ˜¯ç¡¬ç¼–ç å®ç°çš„ï¼Œé€»è¾‘ä¹Ÿæ¯”è¾ƒç®€å•ã€‚ä¸è¿‡ï¼Œå®é™…åœºæ™¯ä¸­åˆ¤æ–­refç­‰APIè°ƒç”¨çš„æ­£åˆ™å’Œå¯¼å…¥importçš„æ–¹å¼ï¼Œéƒ½ä¸ä¼šè¿™ä¹ˆç®€å•ã€‚å¦‚æœæˆ‘ä»¬è‡ªå·±æ¯æ¬¡éƒ½å†™ä¸€ä¸ªparseæ¨¡å—æ¯”è¾ƒéº»çƒ¦ï¼Œæ‰€ä»¥æˆ‘ä»¬å®é™…å¼€å‘ä¸­ä¼šå€ŸåŠ©ç°æœ‰çš„å·¥å…·å¯¹ä»£ç è¿›è¡Œè§£æï¼Œè€Œä»£ç è½¬æ¢çš„åœºæ™¯ä¸‹æœ€æˆç†Ÿçš„å·¥å…·å°±æ˜¯Babelã€‚</p><h2>Babel</h2><p>æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­å¼‚æ­¥çš„ä»»åŠ¡æœ‰å¾ˆå¤šï¼Œç»å¸¸ä½¿ç”¨async+ awaitçš„è¯­æ³•æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ï¼Œæ¯”å¦‚ç½‘ç»œæ•°æ®çš„è·å–ã€‚ä½†<strong> awaitæ˜¯å¼‚æ­¥ä»»åŠ¡</strong>ï¼Œå¦‚æœæŠ¥é”™ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨try catchè¯­å¥è¿›è¡Œé”™è¯¯å¤„ç†ï¼Œæ¯ä¸ªcatchè¯­å¥éƒ½æ˜¯ä¸€ä¸ªæ‰“å°è¯­å¥ä¼šè®©ä»£ç å˜å¾—å†—ä½™ï¼Œä½†æˆ‘ä»¬æœ‰äº†ä»£ç è½¬åŒ–çš„æ€è·¯åï¼Œè¿™ä¸€æ­¥å°±èƒ½ç”¨ç¼–è¯‘çš„æ€è·¯è‡ªåŠ¨æ¥å®Œæˆã€‚</p><p>é¦–å…ˆæˆ‘ä»¬åœ¨æ ¹ç›®å½•çš„src/main.jsä¸­æ–°å¢ä¸‹é¢ä»£ç ï¼Œæˆ‘ä»¬ä½¿ç”¨delyErrorå‡½æ•°æ¨¡æ‹Ÿå¼‚æ­¥çš„ä»»åŠ¡æŠ¥é”™ï¼Œåœ¨ä»£ç ä¸­ä½¿ç”¨awaitæ¥æ¨¡æ‹Ÿå¼‚æ­¥ä»»åŠ¡ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬å¸Œæœ›æ¯ä¸ªawaitéƒ½èƒ½è·Ÿç€ä¸€ä¸ªtryä»£ç ï¼Œåœ¨catchä¸­èƒ½å¤Ÿæ‰“å°é”™è¯¯æ¶ˆæ¯æç¤ºçš„åŒæ—¶ï¼Œè¿˜èƒ½å¤Ÿä½¿ç”¨è°ƒç”¨é”™è¯¯ç›‘æ§çš„å‡½æ•°ï¼ŒæŠŠå½“å‰é”™è¯¯ä¿¡æ¯å‘ç»™åç«¯æœåŠ¡å™¨è¿›è¡ŒæŠ¥è­¦ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥æ‰“å°ä¸€ä¸ªè‡ªåŠ¨å»stackoverflowæŸ¥è¯¢çš„é“¾æ¥ã€‚</p><pre><code class=\"language-javascript\">function delyError(message){\n  return new Promise((resolve,reject)=&gt;{\n    setTimeout(()=&gt;{\n      reject({message})\n    },1000)\n  })\n}\nasync function test(){\n    await delyError('ref is not defined')\n}\n// æˆ‘ä»¬æœŸæœ›çš„ä»£ç \nasync function test(){\n  try{\n        await delyError('ref is not defined')\n  }catche(e){\n    console.error(e.message)\n    _errorTrack(e.message,location.pathname)\n     console.log('https://stackoverflow.com/search?q=[js]+'+encodeURI(e.message))\n  }\n\n}\ntest()\n</code></pre><p>é¡µé¢ä¸­awaitè¯­å¥å˜å¤šäº†ä¹‹åï¼Œæ‰‹åŠ¨æ›¿æ¢çš„æˆæœ¬å°±æ¯”è¾ƒé«˜ï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­ä½¿ç”¨viteçš„æ’ä»¶æ¥å®ç°ã€‚è¿™æ¬¡æˆ‘ä»¬å°±æ˜¯ç”¨Babelæä¾›å¥½çš„ä»£ç è§£æèƒ½åŠ›å¯¹ä»£ç è¿›è¡Œè½¬æ¢ã€‚Babeléƒ½æä¾›äº†å“ªäº›APIï¼Œä½ å¯ä»¥åœ¨<a href=\"https://babel.docschina.org/docs/en/babel-parser\">Babelçš„å®˜ç½‘</a>è¿›è¡Œæ·±å…¥å­¦ä¹ ã€‚</p><p>Babelæä¾›äº†å®Œæ•´çš„ç¼–è¯‘ä»£ç çš„åŠŸèƒ½åå‡½æ•°ï¼ŒåŒ…æ‹¬ASTçš„è§£æã€è¯­ä¹‰åˆ†æã€ä»£ç ç”Ÿæˆç­‰ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‡½æ•°å»å®ç°è‡ªå·±çš„æ’ä»¶ã€‚</p><ul>\n<li>@babel/parseræä¾›äº†ä»£ç è§£æçš„èƒ½åŠ›ï¼Œèƒ½å¤ŸæŠŠjsä»£ç è§£ææˆASTï¼Œä»£ç å°±ä»å­—ç¬¦ä¸²å˜æˆäº†æ ‘å½¢ç»“æ„ï¼Œæ–¹ä¾¿æˆ‘ä»¬è¿›è¡Œæ“ä½œï¼›</li>\n<li>@babel/traverseæä¾›äº†éå†ASTçš„èƒ½åŠ›ï¼Œæˆ‘ä»¬å¯ä»¥ä»travserä¸­è·å–æ¯ä¸€ä¸ªèŠ‚ç‚¹çš„ä¿¡æ¯åå»ä¿®æ”¹å®ƒï¼›</li>\n<li>@babe/typesæä¾›äº†ç±»å‹åˆ¤æ–­çš„å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿çš„åˆ¤æ–­æ¯ä¸ªèŠ‚ç‚¹çš„ç±»å‹ï¼›</li>\n<li>@babel/coreæä¾›äº†ä»£ç è½¬åŒ–çš„èƒ½åŠ›ã€‚</li>\n</ul><p>ä¸‹é¢çš„ä»£ç ä¸­æˆ‘ä»¬å®ç°äº†vite-plugin-auto-tryæ’ä»¶ï¼Œç”±babel/parerè§£ææˆä¸ºASTï¼Œé€šè¿‡travseréå†æ•´ä¸ªASTèŠ‚ç‚¹ï¼Œé…ç½®çš„AwaitExpressionä¼šè¯†åˆ«å‡ºASTä¸­çš„awaitè°ƒç”¨è¯­å¥ï¼Œå†ç”¨isTryStatementåˆ¤æ–­awaitå¤–å±‚æ˜¯å¦å·²ç»åŒ…è£¹äº†tryè¯­å¥ã€‚å¦‚æœæ²¡æœ‰tryè¯­å¥çš„è¯ï¼Œå°±ä½¿ç”¨tryStatementå‡½æ•°ç”Ÿæˆæ–°çš„ASTèŠ‚ç‚¹ã€‚</p><p>è¿™ä¸ªASTåŒ…è£¹å½“å‰çš„èŠ‚ç‚¹ï¼Œå¹¶ä¸”æˆ‘ä»¬åœ¨å†…éƒ¨åŠ ä¸Šäº†stackoverflowé“¾æ¥çš„æ‰“å°ã€‚æœ€åï¼Œä½¿ç”¨babel/coreæä¾›çš„transformFromAstSyncå‡½æ•°ï¼ŒæŠŠä¼˜åŒ–åçš„ASTç”Ÿæˆæ–°çš„JavaScriptä»£ç ï¼Œè‡ªåŠ¨æ–°å¢tryä»£ç çš„æ’ä»¶å°±å®ç°äº†ã€‚</p><pre><code class=\"language-javascript\">\n\nimport { parse } from '@babel/parser'\nimport traverse from '@babel/traverse'\nimport {\n  isTryStatement,\n  tryStatement,\n  isBlockStatement,\n  catchClause,\n  identifier,\n  blockStatement,\n} from '@babel/types'\nimport { transformFromAstSync } from '@babel/core'\n\nconst catchStatement = parse(`\n  console.error(err)\n  console.log('https://stackoverflow.com/search?q=[js]+'+encodeURI(err.message))\n`).program.body\n\nexport default function autoImportPlugin() {\n  return {\n    name: 'vite-plugin-auto-try', // å¿…é¡»çš„ï¼Œå°†ä¼šåœ¨ warning å’Œ error ä¸­æ˜¾ç¤º\n    enforce:'pre',\n    transform(code,id){\n        fileReg = /\\.js$/\n        if(fileReg.test(id)){\n        const ast = parse(code, {\n          sourceType: 'module'\n        })\n        traverse(ast, {\n          AwaitExpression(path){\n            console.log(path)\n            if (path.findParent((path) =&gt; isTryStatement(path.node))) {\n              // å·²ç»æœ‰tryäº†\n              return \n            }\n            // isBlockStatement æ˜¯å¦å‡½æ•°ä½“\n            const blockParentPath = path.findParent((path) =&gt; isBlockStatement(path.node))\n            const tryCatchAst  = tryStatement(\n              blockParentPath.node,\n              // astä¸­æ–°å¢tryçš„ast\n              catchClause(\n                identifier('err'),\n                blockStatement(catchStatement),\n              )\n            )\n            // ä½¿ç”¨æœ‰tryçš„astæ›¿æ¢ä¹‹å‰çš„ast\n            blockParentPath.replaceWithMultiple([tryCatchAst])\n\n          }\n        })\n        // ç”Ÿæˆä»£ç ï¼Œgenerate\n        code = transformFromAstSync(ast,\"\",{\n          configFile:false\n        }).code\n\n        return code\n      }\n      return code\n    }\n  }\n}\n</code></pre><p>ç„¶åï¼Œæˆ‘ä»¬åœ¨æ ¹ç›®å½•ä¸‹çš„src/main.jsä¸­å†™å…¥ä¸‹é¢çš„ä»£ç ã€‚ä¸¤ä¸ªawaitè¯­å¥ä¸€ä¸ªä½¿ç”¨tryåŒ…è£¹ï¼Œä¸€ä¸ªæ²¡æœ‰ä½¿ç”¨tryåŒ…è£¹ã€‚</p><p>æ¥ç€æˆ‘ä»¬å¯åŠ¨é¡¹ç›®åï¼Œå°±æ¥åˆ°äº†æµè§ˆå™¨çš„è°ƒè¯•çª—å£ä¸­çš„sourceé¡µé¢ï¼Œå¯ä»¥çœ‹åˆ°ä¸‹å›¾ä¸­è§£æåçš„main.jsä»£ç ï¼Œç°åœ¨æ²¡æœ‰tryçš„awaitè¯­å¥å·²ç»è‡ªåŠ¨åŠ ä¸Šäº†tryè¯­å¥ã€‚</p><p>ä½ çœ‹ï¼Œ<strong>è¿™æ¬¡æˆ‘ä»¬åŸºäºbabelæ¥å®ç°ï¼Œå°±çœå»äº†æˆ‘ä»¬å†™æ­£åˆ™çš„å¼€å‘æˆæœ¬</strong>ã€‚Babelæä¾›äº†ä¸€æ•´å¥—å…³äºJavaScirptä¸­è¯­å¥çš„è½¬åŒ–å‡½æ•°ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å»Babelå®˜ç½‘äº†è§£ã€‚</p><pre><code class=\"language-javascript\">import { createApp } from \"vue\";\nimport App from './App.vue'\n\ncreateApp(App)\n  .mount('#app')\n\nasync function test(){\n  await delyError('ref is not defined')\n}\n\nasync function test2(){\n  try{\n    await delyError('reactive is not defined')\n  }catch(e){\n    console.error(e)\n  }\n}\ntest()\nfunction delyError(message){\n  return new Promise((resolve,reject)=&gt;{\n    setTimeout(()=&gt;{\n      reject({message})\n    },1000)\n  })\n}\n\n</code></pre><h2><img src=\"https://static001.geekbang.org/resource/image/0a/f9/0a00c01yyfdf020eec114fc5a70344f9.png?wh=1920x1056\" alt=\"å›¾ç‰‡\"></h2><p>æœ‰äº†Babelæä¾›çš„èƒ½åŠ›ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥åªå…³æ³¨äºä»£ç ä¸­éœ€è¦è½¬æ¢çš„é€»è¾‘ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Babelå®ç°å›½é™…åŒ–ï¼ŒæŠŠæ¯ç§è¯­è¨€åœ¨ç¼–è¯‘çš„æ—¶å€™è‡ªåŠ¨æ›¿æ¢è¯­è¨€ï¼Œæ‰“åŒ…æˆç‹¬ç«‹çš„é¡¹ç›®ï¼›ä¹Ÿå¯ä»¥å®ç°é¡µé¢çš„è‡ªåŠ¨åŒ–ç›‘æ§ï¼Œåœ¨ä¸€äº›æ“ä½œå‡½æ•°é‡Œé¢åŠ å…¥ç›‘æ§çš„ä»£ç é€»è¾‘ã€‚ä½ å¯ä»¥è‡ªè¡Œå‘æŒ¥æƒ³è±¡åŠ›ï¼Œä½¿ç”¨ç¼–è¯‘çš„æ€æƒ³æ¥æé«˜æ—¥å¸¸çš„å¼€å‘æ•ˆç‡ã€‚</p><p>æœ€åæˆ‘ä»¬å›é¡¾ä¸€ä¸‹Vueä¸­çš„compilerã€‚Vueä¸­çš„compiler-domæä¾›äº†compileå‡½æ•°ï¼Œå…·ä½“çš„compileé€»è¾‘æˆ‘ä»¬åœ¨ä¸Šä¸€è®²ä¸­å·²ç»è¯¦ç»†å­¦ä¹ äº†ã€‚å…¶å®æˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰‹åŠ¨å¯¼å…¥compiler-domåŒ…ä¹‹åï¼Œè‡ªå·±å®ç°å¯¹vue templateçš„è§£æã€‚å¦å¤–ï¼ŒVueä¸­è¿˜æä¾›äº†@vue/compiler-sfcåŒ…ï¼Œç”¨æ¥å®ç°å•æ–‡ä»¶ç»„ä»¶.vueçš„è§£æï¼Œè¿˜æœ‰@vue/compiler-ssråŒ…ï¼Œå®ƒå®ç°äº†æœåŠ¡ç«¯æ¸²æŸ“çš„è§£æã€‚</p><p>ä¸‹ä¸€è®²æˆ‘ä»¬ä¸€èµ·æ¥æ‰‹å†™viteçš„ä»£ç å†…å®¹ï¼Œæˆ‘ä»¬å°±éœ€è¦åœ¨nodejsä¸­å®ç°å¯¹Vueå•æ–‡ä»¶ç»„ä»¶çš„è§£æå·¥ä½œï¼Œå®ç°æµè§ˆå™¨ä¸­ç›´æ¥å¯¼å…¥å•æ–‡ä»¶ç»„ä»¶çš„åŠŸèƒ½ï¼Œæ•¬è¯·æœŸå¾…ã€‚</p><h2>æ€»ç»“</h2><p>æœ€åæˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ä»Šå¤©å­¦åˆ°çš„å†…å®¹ã€‚</p><p>æˆ‘ä»¬æŠŠVueå†…éƒ¨çš„compileråŸç†èä¼šè´¯é€šä¹‹åï¼Œä»Šå¤©å°è¯•æŠŠtemplateåˆ°renderè½¬åŒ–è¿‡ç¨‹çš„æ€æƒ³åº”ç”¨åˆ°å®é™…é¡¹ç›®ä¸­ã€‚Vueä¸­çš„compileråœ¨è½¬åŒ–çš„è¿‡ç¨‹ä¸­è¿˜åšäº†é™æ€æ ‡è®°çš„ä¼˜åŒ–ï¼Œæˆ‘ä»¬åœ¨å®é™…å¼€å‘ä¸­å¯ä»¥å€Ÿé‰´ç¼–è¯‘çš„æ€è·¯ï¼Œæé«˜å¼€å‘çš„æ•ˆç‡ã€‚</p><p>æˆ‘ä»¬ä¸€èµ·å›é¡¾ä¸€ä¸‹ä»£ç è‡ªåŠ¨å¯¼å…¥çš„æ“ä½œæ€è·¯ã€‚é¦–å…ˆæˆ‘ä»¬å¯ä»¥å®ç°é¡µé¢ä¸­refã€computedçš„APIçš„è‡ªåŠ¨åŒ–å¯¼å…¥ï¼Œåœ¨viteæ’ä»¶çš„transformå‡½æ•°ä¸­è·å–åˆ°å¾…è½¬æ¢çš„ä»£ç ï¼Œé€šè¿‡å¯¹ä»£ç çš„å†…å®¹è¿›è¡Œæ­£åˆ™åŒ¹é…ï¼Œå®ç°å¦‚æœå‡ºç°äº†refï¼Œcomputedç­‰å‡½æ•°çš„è°ƒç”¨ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè¿™äº›ä¾èµ–çš„å‡½æ•°æ”¶é›†åœ¨helperä¸­ã€‚æœ€ç»ˆåœ¨script setupæ ‡ç­¾ä¹‹å‰æ–°å¢importè¯­å¥æ¥å¯¼å…¥ä¾èµ–çš„APIï¼Œæœ€ç»ˆå°±å¯ä»¥å®ç°ä»£ç çš„è‡ªåŠ¨å¯¼å…¥ã€‚</p><p><strong>å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠä½¿ç”¨åˆ°çš„ç»„ä»¶åº“Element3ï¼Œå·¥å…·å‡½æ•°vueuseç­‰æ¡†æ¶éƒ½è¿›è¡Œè¯­æ³•çš„è§£æï¼Œå®ç°å‡½æ•°å’Œç»„ä»¶çš„è‡ªåŠ¨åŒ–å¯¼å…¥å’ŒæŒ‰éœ€åŠ è½½ã€‚è¿™æ ·èƒ½åœ¨æé«˜å¼€å‘æ•ˆç‡çš„åŒæ—¶ï¼Œä¹Ÿæé«˜æˆ‘ä»¬ä¹¦å†™viteæ’ä»¶çš„èƒ½åŠ›</strong>ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>æœ€åç•™ä¸€ä¸ªæ€è€ƒé¢˜å§ï¼Œä½ è§‰å¾—åœ¨å·¥ä½œé¡¹ç›®ä¸­æœ‰å“ªé‡Œéœ€è¦ç”¨åˆ°ä»£ç è½¬åŒ–çš„æ€è·¯å‘¢ï¼Ÿæ¬¢è¿åœ¨è¯„è®ºåŒºåˆ†äº«ä½ çš„ç­”æ¡ˆï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™ä¸€è®²çš„å†…å®¹åˆ†äº«ç»™ä½ çš„åŒäº‹å’Œæœ‹å‹ä»¬ï¼Œæˆ‘ä»¬ä¸‹ä¸€è®²å†è§ï¼</p>","comments":[{"had_liked":false,"id":329990,"user_name":"è´¹åŸçš„äºŒé¹","can_delete":false,"product_type":"c1","uid":1101293,"ip_address":"","ucode":"DE768A0CC3053D","user_header":"https://static001.geekbang.org/account/avatar/00/10/cd/ed/825d84ee.jpg","comment_is_top":false,"comment_ctime":1641716399,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10231650991","product_id":100094401,"comment_content":"å¾ˆå¤šé­”æ¿ä»£ç éƒ½å¯ä»¥é€šè¿‡ä»£ç è½¬åŒ–çš„æ–¹å¼å®ç°ï¼Œæˆ‘ä»¬çš„ç½‘ç»œè¯·æ±‚ä»£ç éå¸¸å›ºå®šï¼Œæ‰“ç®—è¯•è¯•ç”¨è¿™ç§æ–¹å¼å‡å°‘æ¨¡æ¿ä»£ç ","like_count":2},{"had_liked":false,"id":329903,"user_name":"SjmBreadrain","can_delete":false,"product_type":"c1","uid":2709219,"ip_address":"","ucode":"6C2F29CF146F50","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/ruxj2Ko6lpWdmf4ePtUCjZU0LpicbVUuTicWaSDRkGHGMB78b3vQNNbfhlqMWlibxCLX6V0IfueFxUyxs5BlryzVQ/132","comment_is_top":false,"comment_ctime":1641635390,"is_pvip":false,"replies":[{"id":"120221","content":"è¯¾ç¨‹ä»‹ç»é¡µæœ‰ä¸ªå¾®ä¿¡ç¾¤","user_name":"ä½œè€…å›å¤","comment_id":329903,"uid":"1003715","ip_address":"","utype":1,"ctime":1641774219,"user_name_real":"ç¼–è¾‘"}],"discussion_count":3,"race_medal":0,"score":"10231569982","product_id":100094401,"comment_content":"é™¤äº†ç•™è¨€ä¹‹å¤–è¿˜æœ‰åˆ«çš„äº’åŠ¨æ–¹å¼ä¸ï¼Ÿ","like_count":2,"discussions":[{"author":{"id":1003715,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/50/c3/0aa50246.jpg","nickname":"èŠ±æœå±±å¤§åœ£","note":"","ucode":"25C0A36D628037","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":544895,"discussion_content":"è¯¾ç¨‹ä»‹ç»é¡µæœ‰ä¸ªå¾®ä¿¡ç¾¤","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641774219,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1673990,"avatar":"https://static001.geekbang.org/account/avatar/00/19/8b/06/fb3be14a.jpg","nickname":"TableBear","note":"","ucode":"A2C0562EEA2725","race_medal":5,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":547232,"discussion_content":"æœ‹å‹ï¼Œæœ‰æ‰¾åˆ°äº’åŠ¨å¾®ä¿¡ç¾¤å—ï¼Œæ±‚åˆ†äº«","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642592430,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1027167,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ac/5f/894761f8.jpg","nickname":"åå…«å“¥","note":"","ucode":"C0130252F97814","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1673990,"avatar":"https://static001.geekbang.org/account/avatar/00/19/8b/06/fb3be14a.jpg","nickname":"TableBear","note":"","ucode":"A2C0562EEA2725","race_medal":5,"user_type":1,"is_pvip":true},"discussion":{"id":588601,"discussion_content":"åŒé—®","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1663895037,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":547232,"ip_address":"åŒ—äº¬"},"score":588601,"extra":""}]}]},{"had_liked":false,"id":346335,"user_name":"é™ˆåšæ³“","can_delete":false,"product_type":"c1","uid":2461961,"ip_address":"","ucode":"75258EE1BF1C2A","user_header":"https://static001.geekbang.org/account/avatar/00/25/91/09/6f0b987a.jpg","comment_is_top":false,"comment_ctime":1653032861,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5948000157","product_id":100094401,"comment_content":"è¿™èŠ‚ä¸é”™ éå¸¸å®ç”¨ å¯ä»¥å‡å°‘å¾ˆå¤šé‡å¤æ€§æ“ä½œ ","like_count":1},{"had_liked":false,"id":330047,"user_name":"æµ·é˜”å¤©ç©º","can_delete":false,"product_type":"c1","uid":1327016,"ip_address":"","ucode":"16C87A0052A08B","user_header":"https://static001.geekbang.org/account/avatar/00/14/3f/a8/8da58e53.jpg","comment_is_top":false,"comment_ctime":1641771600,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5936738896","product_id":100094401,"comment_content":"å‰å®³å‰å®³ï¼Œä»¥å‰ç”¨å¾—æ¯”è¾ƒå¤šçš„å°±æ˜¯cssçš„ç¼–è¯‘ï¼Œless å‡½æ•°çš„ç¼–è¯‘å¤„ç†å…¼å®¹æ€§é—®é¢˜ç­‰ã€‚éƒ¨åˆ†ç”¨åˆ°ç™»å½•ä¿¡æ¯çš„å¤„ç†ã€‚","like_count":1},{"had_liked":false,"id":329922,"user_name":"james","can_delete":false,"product_type":"c1","uid":1232771,"ip_address":"","ucode":"AC42035106E5B9","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/yyibGRYCArsUNBfCAEAibua09Yb9D5AdO8TkCmXymhAepibqmlz0hzg06ggBLxyvXicnjqFVGr7zYF0rQoZ0aXCBAg/132","comment_is_top":false,"comment_ctime":1641647779,"is_pvip":false,"discussion_count":0,"race_medal":1,"score":"5936615075","product_id":100094401,"comment_content":"ä¸é”™ä¸é”™","like_count":1},{"had_liked":false,"id":329721,"user_name":"Johnson","can_delete":false,"product_type":"c1","uid":1326108,"ip_address":"","ucode":"C6B6FF9EA4CC60","user_header":"https://static001.geekbang.org/account/avatar/00/14/3c/1c/47e5b7aa.jpg","comment_is_top":false,"comment_ctime":1641512335,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5936479631","product_id":100094401,"comment_content":"å¾ˆå®ç”¨ã€‚ğŸ˜","like_count":1},{"had_liked":false,"id":356531,"user_name":"çƒ›ç«æ˜Ÿå…‰","can_delete":false,"product_type":"c1","uid":1480933,"ip_address":"æ±Ÿè‹","ucode":"0CF72A5C4EDBCB","user_header":"https://static001.geekbang.org/account/avatar/00/16/98/e5/46c5235b.jpg","comment_is_top":false,"comment_ctime":1662385059,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1662385059","product_id":100094401,"comment_content":"æ¯”å¦‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Babel å®ç°å›½é™…åŒ–<br><br>æƒ³é—®ä¸€ä¸‹ï¼Œè¿™ç©æ„æ€ä¹ˆå®ç°ï¼Œèƒ½ç»™ä¸€ä¸ªç®€å•ç¤ºä¾‹ä¹ˆ","like_count":1},{"had_liked":false,"id":351500,"user_name":"Johnson","can_delete":false,"product_type":"c1","uid":1326108,"ip_address":"","ucode":"C6B6FF9EA4CC60","user_header":"https://static001.geekbang.org/account/avatar/00/14/3c/1c/47e5b7aa.jpg","comment_is_top":false,"comment_ctime":1657853109,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1657853109","product_id":100094401,"comment_content":"è¯•äº†ä¸€ä¸‹ï¼Œä¸‹é¢çš„ä»£ç æ”¾åœ¨main.jsæ—¶ä¼šè‡ªåŠ¨å¢åŠ try...catchï¼Œä½†æ˜¯ä»£ç æ”¾åœ¨ç»„ä»¶ä¸­æ— æ³•è‡ªåŠ¨å¢åŠ ï¼Œè¿™ä¸ªè¦æ€ä¹ˆè§£å†³å¤„ç†å‘¢ï¼Ÿ<br>async function test() {<br>  await delayError(&quot;ref is not defined&quot;);<br>}","like_count":0},{"had_liked":false,"id":350610,"user_name":"henry","can_delete":false,"product_type":"c1","uid":1256109,"ip_address":"","ucode":"55009E8CCC914F","user_header":"https://static001.geekbang.org/account/avatar/00/13/2a/ad/5ea1a719.jpg","comment_is_top":false,"comment_ctime":1657036307,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1657036307","product_id":100094401,"comment_content":"å·¥å…·åº“è‡ªåŠ¨å¯¼å…¥å¦‚ä½•è·Ÿtsçš„ç±»å‹ç³»ç»Ÿä¸€èµ·ç”¨å‘¢ï¼Ÿtsç±»å‹æ£€æŸ¥å’Œç±»å‹æç¤ºåº”è¯¥ä¸èƒ½æ­£å¸¸å·¥ä½œäº†...","like_count":0},{"had_liked":false,"id":344339,"user_name":"Rocky","can_delete":false,"product_type":"c1","uid":1483150,"ip_address":"","ucode":"5FCF390BECDF9D","user_header":"https://static001.geekbang.org/account/avatar/00/16/a1/8e/03aeb9df.jpg","comment_is_top":false,"comment_ctime":1651479732,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1651479732","product_id":100094401,"comment_content":"é«˜","like_count":0}]}