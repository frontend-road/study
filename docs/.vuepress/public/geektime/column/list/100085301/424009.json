{"id":424009,"title":"19ï½œé—­åŒ…ï¼šFnOnceã€FnMutå’ŒFnï¼Œä¸ºä»€ä¹ˆæœ‰è¿™ä¹ˆå¤šç±»å‹ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯é™ˆå¤©ã€‚</p><p>åœ¨ç°ä»£ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œé—­åŒ…æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„å·¥å…·ï¼Œå¯ä»¥è®©æˆ‘ä»¬å¾ˆæ–¹ä¾¿åœ°ä»¥å‡½æ•°å¼ç¼–ç¨‹çš„æ–¹å¼æ¥æ’°å†™ä»£ç ã€‚å› ä¸ºé—­åŒ…å¯ä»¥ä½œä¸ºå‚æ•°ä¼ é€’ç»™å‡½æ•°ï¼Œå¯ä»¥ä½œä¸ºè¿”å›å€¼è¢«å‡½æ•°è¿”å›ï¼Œä¹Ÿå¯ä»¥ä¸ºå®ƒå®ç°æŸä¸ª traitï¼Œä½¿å…¶èƒ½è¡¨ç°å‡ºå…¶ä»–è¡Œä¸ºï¼Œè€Œä¸ä»…ä»…æ˜¯ä½œä¸ºå‡½æ•°è¢«è°ƒç”¨ã€‚</p><p>è¿™äº›éƒ½æ˜¯æ€ä¹ˆåšåˆ°çš„ï¼Ÿè¿™å°±å’Œ Rust é‡Œé—­åŒ…çš„æœ¬è´¨æœ‰å…³äº†ï¼Œæˆ‘ä»¬ä»Šå¤©å°±æ¥å­¦ä¹ åŸºç¡€ç¯‡çš„æœ€åä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼šé—­åŒ…ã€‚</p><h3>é—­åŒ…çš„å®šä¹‰</h3><p>ä¹‹å‰ä»‹ç»äº†é—­åŒ…çš„åŸºæœ¬æ¦‚å¿µå’Œä¸€ä¸ªéå¸¸ç®€å•çš„ä¾‹å­ï¼š</p><blockquote>\n<p>é—­åŒ…æ˜¯å°†å‡½æ•°ï¼Œæˆ–è€…è¯´ä»£ç å’Œå…¶ç¯å¢ƒä¸€èµ·å­˜å‚¨çš„ä¸€ç§æ•°æ®ç»“æ„ã€‚é—­åŒ…å¼•ç”¨çš„ä¸Šä¸‹æ–‡ä¸­çš„è‡ªç”±å˜é‡ï¼Œä¼šè¢«æ•è·åˆ°é—­åŒ…çš„ç»“æ„ä¸­ï¼Œæˆä¸ºé—­åŒ…ç±»å‹çš„ä¸€éƒ¨åˆ†ï¼ˆ<a href=\"https://time.geekbang.org/column/article/410038\">ç¬¬äºŒè®²</a>ï¼‰ã€‚</p>\n</blockquote><p>é—­åŒ…ä¼šæ ¹æ®å†…éƒ¨çš„ä½¿ç”¨æƒ…å†µï¼Œæ•è·ç¯å¢ƒä¸­çš„è‡ªç”±å˜é‡ã€‚åœ¨ Rust é‡Œï¼Œé—­åŒ…å¯ä»¥ç”¨  <code>|args| {code}</code> æ¥è¡¨è¿°ï¼Œå›¾ä¸­é—­åŒ… c æ•è·äº†ä¸Šä¸‹æ–‡ä¸­çš„ a å’Œ bï¼Œå¹¶é€šè¿‡å¼•ç”¨æ¥ä½¿ç”¨è¿™ä¸¤ä¸ªè‡ªç”±å˜é‡ï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/60/93/6060b99f222ef6e435c9fe7c83f46593.jpg?wh=2935x1544\" alt=\"\"></p><p>é™¤äº†ç”¨å¼•ç”¨æ¥æ•è·è‡ªç”±å˜é‡ä¹‹å¤–ï¼Œè¿˜æœ‰å¦å¤–ä¸€ä¸ªæ–¹æ³•ä½¿ç”¨ move å…³é”®å­—  <code>move |args| {code}</code> ã€‚</p><p>ä¹‹å‰çš„è¯¾ç¨‹ä¸­ï¼Œå¤šæ¬¡è§åˆ°äº†åˆ›å»ºæ–°çº¿ç¨‹çš„ thread::spawnï¼Œå®ƒçš„å‚æ•°å°±æ˜¯ä¸€ä¸ªé—­åŒ…ï¼š</p><pre><code class=\"language-rust\">pub fn spawn&lt;F, T&gt;(f: F) -&gt; JoinHandle&lt;T&gt; \nwhere\n    F: FnOnce() -&gt; T,\n    F: Send + 'static,\n    T: Send + 'static,\n</code></pre><!-- [[[read_end]]] --><p>ä»”ç»†çœ‹è¿™ä¸ªæ¥å£ï¼š</p><ol>\n<li>F: FnOnce() â†’ Tï¼Œè¡¨æ˜ F æ˜¯ä¸€ä¸ªæ¥å— 0 ä¸ªå‚æ•°ã€è¿”å› T çš„é—­åŒ…ã€‚FnOnce æˆ‘ä»¬ç¨åå†è¯´ã€‚</li>\n<li>F: Send + 'staticï¼Œè¯´æ˜é—­åŒ… F è¿™ä¸ªæ•°æ®ç»“æ„ï¼Œéœ€è¦é™æ€ç”Ÿå‘½å‘¨æœŸæˆ–è€…æ‹¥æœ‰æ‰€æœ‰æƒï¼Œå¹¶ä¸”å®ƒè¿˜èƒ½è¢«å‘é€ç»™å¦ä¸€ä¸ªçº¿ç¨‹ã€‚</li>\n<li>T: Send + 'staticï¼Œè¯´æ˜é—­åŒ… F è¿”å›çš„æ•°æ®ç»“æ„ Tï¼Œéœ€è¦é™æ€ç”Ÿå‘½å‘¨æœŸæˆ–è€…æ‹¥æœ‰æ‰€æœ‰æƒï¼Œå¹¶ä¸”å®ƒè¿˜èƒ½è¢«å‘é€ç»™å¦ä¸€ä¸ªçº¿ç¨‹ã€‚</li>\n</ol><p>1 å’Œ 3 éƒ½å¾ˆå¥½ç†è§£ï¼Œ2 å°±æœ‰äº›è´¹è§£äº†ã€‚ä¸€ä¸ªé—­åŒ…ï¼Œå®ƒä¸å°±æ˜¯ä¸€æ®µä»£ç  + è¢«æ•è·çš„å˜é‡ä¹ˆï¼Ÿéœ€è¦é™æ€ç”Ÿå‘½å‘¨æœŸæˆ–è€…æ‹¥æœ‰æ‰€æœ‰æƒæ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ</p><p>æ‹†å¼€çœ‹ã€‚ä»£ç è‡ªç„¶æ˜¯é™æ€ç”Ÿå‘½å‘¨æœŸäº†ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯æ„å‘³ç€è¢«æ•è·çš„å˜é‡ï¼Œéœ€è¦é™æ€ç”Ÿå‘½å‘¨æœŸæˆ–è€…æ‹¥æœ‰æ‰€æœ‰æƒï¼Ÿ</p><p>çš„ç¡®å¦‚æ­¤ã€‚åœ¨ä½¿ç”¨ thread::spawn æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ move å…³é”®å­—ï¼ŒæŠŠå˜é‡çš„æ‰€æœ‰æƒä»å½“å‰ä½œç”¨åŸŸç§»åŠ¨åˆ°é—­åŒ…çš„ä½œç”¨åŸŸï¼Œè®© thread::spawn å¯ä»¥æ­£å¸¸ç¼–è¯‘é€šè¿‡ï¼š</p><pre><code class=\"language-rust\">use std::thread;\n\nfn main() {\n    let s = String::from(\"hello world\");\n\n    let handle = thread::spawn(move || {\n        println!(\"moved: {:?}\", s);\n    });\n\n    handle.join().unwrap();\n}\n</code></pre><p>ä½†ä½ æœ‰æ²¡æœ‰å¥½å¥‡è¿‡ï¼ŒåŠ  move å’Œä¸åŠ  moveï¼Œè¿™ä¸¤ç§é—­åŒ…æœ‰ä»€ä¹ˆæœ¬è´¨ä¸Šçš„ä¸åŒï¼Ÿé—­åŒ…ç©¶ç«Ÿæ˜¯ä¸€ç§ä»€ä¹ˆæ ·çš„æ•°æ®ç±»å‹ï¼Œè®©ç¼–è¯‘å™¨å¯ä»¥åˆ¤æ–­å®ƒæ˜¯å¦æ»¡è¶³ Send + 'static å‘¢ï¼Ÿæˆ‘ä»¬ä»é—­åŒ…çš„æœ¬è´¨ä¸‹æ‰‹æ¥å°è¯•å›ç­”è¿™ä¸¤ä¸ªé—®é¢˜ã€‚</p><h3>é—­åŒ…æœ¬è´¨ä¸Šæ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>åœ¨å®˜æ–¹çš„ Rust reference ä¸­ï¼Œæœ‰è¿™æ ·çš„<a href=\"https://doc.rust-lang.org/reference/types/closure.html\">å®šä¹‰</a>ï¼š</p><blockquote>\n<p>A closure expression produces a closure value with a unique, anonymous type that cannot be written out. A closure type is approximately equivalent to a struct which contains the captured variables.</p>\n</blockquote><p>é—­åŒ…æ˜¯ä¸€ç§åŒ¿åç±»å‹ï¼Œ<strong>ä¸€æ—¦å£°æ˜ï¼Œå°±ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„ç±»å‹</strong>ï¼Œä½†è¿™ä¸ªç±»å‹æ— æ³•è¢«å…¶å®ƒåœ°æ–¹ä½¿ç”¨ã€‚<strong>è¿™ä¸ªç±»å‹å°±åƒä¸€ä¸ªç»“æ„ä½“ï¼Œä¼šåŒ…å«æ‰€æœ‰æ•è·çš„å˜é‡</strong>ã€‚</p><p>æ‰€ä»¥é—­åŒ…ç±»ä¼¼ä¸€ä¸ªç‰¹æ®Šçš„ç»“æ„ä½“ï¼Ÿ</p><p>ä¸ºäº†ææ˜ç™½è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¾—å†™æ®µä»£ç æ¢ç´¢ä¸€ä¸‹ï¼Œå»ºè®®ä½ è·Ÿç€æ•²ä¸€éè®¤çœŸæ€è€ƒï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=b68b60542c9bda8dbcbc4a63915a7590\">ä»£ç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">use std::{collections::HashMap, mem::size_of_val};\nfn main() {\n    // é•¿åº¦ä¸º 0\n    let c1 = || println!(\"hello world!\");\n    // å’Œå‚æ•°æ— å…³ï¼Œé•¿åº¦ä¹Ÿä¸º 0\n    let c2 = |i: i32| println!(\"hello: {}\", i);\n    let name = String::from(\"tyr\");\n    let name1 = name.clone();\n    let mut table = HashMap::new();\n    table.insert(\"hello\", \"world\");\n    // å¦‚æœæ•è·ä¸€ä¸ªå¼•ç”¨ï¼Œé•¿åº¦ä¸º 8\n    let c3 = || println!(\"hello: {}\", name);\n    // æ•è·ç§»åŠ¨çš„æ•°æ® name1(é•¿åº¦ 24) + table(é•¿åº¦ 48)ï¼Œclosure é•¿åº¦ 72\n    let c4 = move || println!(\"hello: {}, {:?}\", name1, table);\n    let name2 = name.clone();\n    // å’Œå±€éƒ¨å˜é‡æ— å…³ï¼Œæ•è·äº†ä¸€ä¸ª String name2ï¼Œclosure é•¿åº¦ 24\n    let c5 = move || {\n        let x = 1;\n        let name3 = String::from(\"lindsey\");\n        println!(\"hello: {}, {:?}, {:?}\", x, name2, name3);\n    };\n\n\t\tprintln!(\n        \"c1: {}, c2: {}, c3: {}, c4: {}, c5: {}, main: {}\",\n        size_of_val(&amp;c1),\n        size_of_val(&amp;c2),\n        size_of_val(&amp;c3),\n        size_of_val(&amp;c4),\n        size_of_val(&amp;c5),\n        size_of_val(&amp;main),\n    )\n}\n</code></pre><p>åˆ†åˆ«ç”Ÿæˆäº† 5 ä¸ªé—­åŒ…ï¼š</p><ul>\n<li>c1 æ²¡æœ‰å‚æ•°ï¼Œä¹Ÿæ²¡æ•è·ä»»ä½•å˜é‡ï¼Œä»ä»£ç è¾“å‡ºå¯ä»¥çœ‹åˆ°ï¼Œc1 é•¿åº¦ä¸º 0ï¼›</li>\n<li>c2 æœ‰ä¸€ä¸ª i32 ä½œä¸ºå‚æ•°ï¼Œæ²¡æœ‰æ•è·ä»»ä½•å˜é‡ï¼Œé•¿åº¦ä¹Ÿä¸º 0ï¼Œå¯ä»¥çœ‹å‡ºå‚æ•°è·Ÿé—­åŒ…çš„å¤§å°æ— å…³ï¼›</li>\n<li>c3 æ•è·äº†ä¸€ä¸ªå¯¹å˜é‡ name çš„å¼•ç”¨ï¼Œè¿™ä¸ªå¼•ç”¨æ˜¯ &amp;Stringï¼Œé•¿åº¦ä¸º 8ã€‚è€Œ c3 çš„é•¿åº¦ä¹Ÿæ˜¯ 8ï¼›</li>\n<li>c4 æ•è·äº†å˜é‡ name1 å’Œ tableï¼Œç”±äºç”¨äº† moveï¼Œå®ƒä»¬çš„æ‰€æœ‰æƒç§»åŠ¨åˆ°äº† c4 ä¸­ã€‚c4 é•¿åº¦æ˜¯ 72ï¼Œæ°å¥½ç­‰äº String çš„ 24 å­—èŠ‚ï¼ŒåŠ ä¸Š HashMap çš„ 48 å­—èŠ‚ã€‚</li>\n<li>c5 æ•è·äº† name2ï¼Œname2 çš„æ‰€æœ‰æƒç§»åŠ¨åˆ°äº† c5ï¼Œè™½ç„¶ c5 æœ‰å±€éƒ¨å˜é‡ï¼Œä½†å®ƒçš„å¤§å°å’Œå±€éƒ¨å˜é‡ä¹Ÿæ— å…³ï¼Œc5 çš„å¤§å°ç­‰äº String çš„ 24 å­—èŠ‚ã€‚</li>\n</ul><p>å­¦åˆ°è¿™é‡Œï¼Œå‰é¢çš„ç¬¬ä¸€ä¸ªé—®é¢˜å°±è§£å†³äº†ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œä¸å¸¦ move æ—¶ï¼Œé—­åŒ…æ•è·çš„æ˜¯å¯¹åº”è‡ªç”±å˜é‡çš„å¼•ç”¨ï¼›å¸¦ move æ—¶ï¼Œå¯¹åº”è‡ªç”±å˜é‡çš„æ‰€æœ‰æƒä¼šè¢«ç§»åŠ¨åˆ°é—­åŒ…ç»“æ„ä¸­ã€‚</p><p>ç»§ç»­åˆ†æè¿™æ®µä»£ç çš„è¿è¡Œç»“æœã€‚</p><p>è¿˜çŸ¥é“äº†ï¼Œ<strong>é—­åŒ…çš„å¤§å°è·Ÿå‚æ•°ã€å±€éƒ¨å˜é‡éƒ½æ— å…³ï¼Œåªè·Ÿæ•è·çš„å˜é‡æœ‰å…³</strong>ã€‚å¦‚æœä½ å›é¡¾<a href=\"https://time.geekbang.org/column/article/408409\">ç¬¬ä¸€è®²</a>å‡½æ•°è°ƒç”¨ï¼Œå‚æ•°å’Œå±€éƒ¨å˜é‡åœ¨æ ˆä¸­å¦‚ä½•å­˜æ”¾çš„å›¾ï¼Œå°±å¾ˆæ¸…æ¥šäº†ï¼šå› ä¸ºå®ƒä»¬æ˜¯åœ¨è°ƒç”¨çš„æ—¶åˆ»æ‰åœ¨æ ˆä¸Šäº§ç”Ÿçš„å†…å­˜åˆ†é…ï¼Œè¯´åˆ°åº•å’Œé—­åŒ…ç±»å‹æœ¬èº«æ˜¯æ— å…³çš„ï¼Œæ‰€ä»¥é—­åŒ…çš„å¤§å°è·Ÿå®ƒä»¬è‡ªç„¶æ— å…³ã€‚<br>\n<img src=\"https://static001.geekbang.org/resource/image/56/8f/568023dcb61859029aa0eb48c5eb1c8f.jpg?wh=2059x2601\" alt=\"\"></p><p>é‚£ä¸€ä¸ªé—­åŒ…ç±»å‹åœ¨å†…å­˜ä¸­ç©¶ç«Ÿæ˜¯å¦‚ä½•æ’å¸ƒçš„ï¼Œå’Œç»“æ„ä½“æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿæˆ‘ä»¬è¦å†æ¬¡ç»“åˆ rust-gdb æ¢ç´¢ï¼Œçœ‹çœ‹ä¸Šé¢çš„ä»£ç åœ¨è¿è¡Œç»“æŸå‰ï¼Œå‡ ä¸ªé•¿åº¦ä¸ä¸º 0 é—­åŒ…å†…å­˜é‡Œéƒ½æ”¾äº†ä»€ä¹ˆï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/40/dd/404f3a30a4150a774b8310ab105c3fdd.png?wh=3514x2449\" alt=\"\"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œc3 çš„ç¡®æ˜¯ä¸€ä¸ªå¼•ç”¨ï¼ŒæŠŠå®ƒæŒ‡å‘çš„å†…å­˜åœ°å€çš„ 24 ä¸ªå­—èŠ‚æ‰“å‡ºæ¥ï¼Œæ˜¯ (ptr | cap | len) çš„æ ‡å‡†ç»“æ„ã€‚å¦‚æœæ‰“å° ptr å¯¹åº”çš„å †å†…å­˜çš„ 3 ä¸ªå­—èŠ‚ï¼Œæ˜¯ â€˜tâ€™ â€˜yâ€™ â€˜râ€™ã€‚</p><p>è€Œ c4 æ•è·çš„ name å’Œ tableï¼Œå†…å­˜ç»“æ„å’Œä¸‹é¢çš„ç»“æ„ä½“ä¸€æ¨¡ä¸€æ ·ï¼š</p><pre><code class=\"language-rust\">struct Closure4 {\n    name: String,  // (ptr|cap|len)=24å­—èŠ‚\n    table: HashMap&lt;&amp;str, &amp;str&gt; // (RandomState(16)|mask|ctrl|left|len)=48å­—èŠ‚\n}\n</code></pre><p>ä¸è¿‡ï¼Œå¯¹äº closure ç±»å‹æ¥è¯´ï¼Œç¼–è¯‘å™¨çŸ¥é“åƒå‡½æ•°ä¸€æ ·è°ƒç”¨é—­åŒ… c4() æ˜¯åˆæ³•çš„ï¼Œå¹¶ä¸”çŸ¥é“æ‰§è¡Œ c4() æ—¶ï¼Œä»£ç åº”è¯¥è·³è½¬åˆ°ä»€ä¹ˆåœ°å€æ¥æ‰§è¡Œã€‚åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¦‚æœé‡åˆ° nameã€tableï¼Œå¯ä»¥ä»è‡ªå·±çš„æ•°æ®ç»“æ„ä¸­è·å–ã€‚</p><p>é‚£ä¹ˆå¤šæƒ³ä¸€æ­¥ï¼Œé—­åŒ…æ•è·å˜é‡çš„é¡ºåºï¼Œå’Œå…¶å†…å­˜ç»“æ„çš„é¡ºåºæ˜¯ä¸€è‡´çš„ä¹ˆï¼Ÿçš„ç¡®å¦‚æ­¤ï¼Œå¦‚æœæˆ‘ä»¬è°ƒæ•´é—­åŒ…é‡Œä½¿ç”¨ name1 å’Œ table çš„é¡ºåºï¼š</p><pre><code class=\"language-rust\">let c4 = move || println!(\"hello: {:?}, {}\", table, name1);\n</code></pre><p>å…¶æ•°æ®çš„ä½ç½®æ˜¯ç›¸åçš„ï¼Œç±»ä¼¼äºï¼š</p><pre><code class=\"language-rust\">struct Closure4 {\n    table: HashMap&lt;&amp;str, &amp;str&gt; // (RandomState(16)|mask|ctrl|left|len)=48å­—èŠ‚\n    name: String,  // (ptr|cap|len)=24å­—èŠ‚\n}\n</code></pre><p>ä» gdb ä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°åŒæ ·çš„ç»“æœï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/f2/02/f216f8bb700965f9ac3b79b71196ea02.png?wh=2668x1149\" alt=\"\"></p><p>ä¸è¿‡è¿™åªæ˜¯é€»è¾‘ä¸Šçš„ä½ç½®ï¼Œå¦‚æœä½ è¿˜è®°å¾—<a href=\"https://time.geekbang.org/column/article/418235\">ç¬¬ 11 è®²</a> struct åœ¨å†…å­˜çš„æ’å¸ƒï¼ŒRust ç¼–è¯‘å™¨ä¼šé‡æ’å†…å­˜ï¼Œè®©æ•°æ®èƒ½å¤Ÿä»¥æœ€å°çš„ä»£ä»·å¯¹é½ï¼Œæ‰€ä»¥æœ‰äº›æƒ…å†µä¸‹ï¼Œå†…å­˜ä¸­æ•°æ®çš„é¡ºåºå¯èƒ½å’Œ struct å®šä¹‰ä¸ä¸€è‡´ã€‚</p><p>æ‰€ä»¥å›åˆ°åˆšæ‰é—­åŒ…å’Œç»“æ„ä½“çš„æ¯”è¾ƒã€‚åœ¨ Rust é‡Œï¼Œé—­åŒ…äº§ç”Ÿçš„åŒ¿åæ•°æ®ç±»å‹ï¼Œæ ¼å¼å’Œ struct æ˜¯ä¸€æ ·çš„ã€‚çœ‹å›¾ä¸­ gdb çš„è¾“å‡ºï¼Œ<strong>é—­åŒ…æ˜¯å­˜å‚¨åœ¨æ ˆä¸Šï¼Œå¹¶ä¸”é™¤äº†æ•è·çš„æ•°æ®å¤–ï¼Œé—­åŒ…æœ¬èº«ä¸åŒ…å«ä»»ä½•é¢å¤–å‡½æ•°æŒ‡é’ˆæŒ‡å‘é—­åŒ…çš„ä»£ç </strong>ã€‚å¦‚æœä½ ç†è§£äº† c3 / c4 è¿™ä¸¤ä¸ªé—­åŒ…ï¼Œc5 æ˜¯å¦‚ä½•æ„é€ çš„å°±å¾ˆå¥½ç†è§£äº†ã€‚</p><p>ç°åœ¨ï¼Œä½ æ˜¯ä¸æ˜¯å¯ä»¥å›ç­”ä¸ºä»€ä¹ˆ thread::spawn å¯¹ä¼ å…¥çš„é—­åŒ…çº¦æŸæ˜¯ Send + 'static äº†ï¼Ÿç©¶ç«Ÿä»€ä¹ˆæ ·çš„é—­åŒ…æ»¡è¶³å®ƒå‘¢ï¼Ÿå¾ˆæ˜æ˜¾ï¼Œä½¿ç”¨äº† move ä¸” move åˆ°é—­åŒ…å†…çš„æ•°æ®ç»“æ„æ»¡è¶³ Sendï¼Œå› ä¸ºæ­¤æ—¶ï¼Œé—­åŒ…çš„æ•°æ®ç»“æ„æ‹¥æœ‰æ‰€æœ‰æ•°æ®çš„æ‰€æœ‰æƒï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸæ˜¯ 'staticã€‚</p><p>çœ‹å®ŒRusté—­åŒ…çš„å†…å­˜ç»“æ„ï¼Œä½ æ˜¯ä¸æ˜¯æƒ³è¯´â€œå°±è¿™â€ï¼Œæ²¡å•¥ç‹¬ç‰¹ä¹‹å¤„å§ï¼Ÿä½†æ˜¯å¯¹æ¯”å…¶ä»–è¯­è¨€ï¼Œç»“åˆæ¥ä¸‹æ¥æˆ‘çš„è§£é‡Šï¼Œä½ å†ä»”ç»†æƒ³æƒ³å°±ä¼šæœ‰ä¸€ç§â€œè¿™æ€ä¹ˆå¯èƒ½â€çš„æƒŠè®¶ã€‚</p><h3>ä¸åŒè¯­è¨€çš„é—­åŒ…è®¾è®¡</h3><p>é—­åŒ…æœ€å¤§çš„é—®é¢˜æ˜¯å˜é‡çš„å¤šé‡å¼•ç”¨å¯¼è‡´ç”Ÿå‘½å‘¨æœŸä¸æ˜ç¡®ï¼Œæ‰€ä»¥ä½ å…ˆæƒ³ï¼Œå…¶å®ƒæ”¯æŒé—­åŒ…çš„è¯­è¨€ï¼ˆlambda ä¹Ÿæ˜¯é—­åŒ…ï¼‰ï¼Œå®ƒä»¬çš„é—­åŒ…ä¼šæ”¾åœ¨å“ªé‡Œï¼Ÿ</p><p>æ ˆä¸Šä¹ˆï¼Ÿæ˜¯ï¼Œåˆå¥½åƒä¸æ˜¯ã€‚</p><p>å› ä¸ºé—­åŒ…è¿™ç©æ„ï¼Œä»å½“å‰ä¸Šä¸‹æ–‡ä¸­æ•è·äº†äº›å˜é‡ï¼Œå˜å¾—æœ‰ç‚¹ä¸ä¼¦ä¸ç±»ï¼Œä¸åƒå‡½æ•°é‚£æ ·æ¸…æ¥šï¼Œå°¤å…¶æ˜¯è¿™äº›è¢«æ•è·çš„å˜é‡ï¼Œå®ƒä»¬çš„å½’å±å’Œç”Ÿå‘½å‘¨æœŸå¤„ç†èµ·æ¥å¾ˆéº»çƒ¦ã€‚æ‰€ä»¥ï¼Œå¤§éƒ¨åˆ†ç¼–ç¨‹è¯­è¨€çš„é—­åŒ…å¾ˆå¤šæ—¶å€™æ— æ³•æ”¾åœ¨æ ˆä¸Šï¼Œéœ€è¦é¢å¤–çš„å †åˆ†é…ã€‚ä½ å¯ä»¥çœ‹è¿™ä¸ª <a href=\"https://github.com/golang/go/issues/43210\">Golang çš„ä¾‹å­</a>ã€‚</p><p>ä¸å…‰ Golangï¼ŒJava / Swift / Python / JavaScript ç­‰è¯­è¨€éƒ½æ˜¯å¦‚æ­¤ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå¤§å¤šæ•°ç¼–ç¨‹è¯­è¨€é—­åŒ…çš„æ€§èƒ½è¦è¿œä½äºå‡½æ•°è°ƒç”¨ã€‚å› ä¸ºä½¿ç”¨é—­åŒ…å°±æ„å‘³ç€ï¼šé¢å¤–çš„å †å†…å­˜åˆ†é…ã€æ½œåœ¨çš„åŠ¨æ€åˆ†æ´¾ï¼ˆå¾ˆå¤šè¯­è¨€ä¼šæŠŠé—­åŒ…å¤„ç†æˆå‡½æ•°æŒ‡é’ˆï¼‰ã€é¢å¤–çš„å†…å­˜å›æ”¶ã€‚</p><p>åœ¨æ€§èƒ½ä¸Šï¼Œå”¯æœ‰ C++ çš„ lambda å’Œ Rust é—­åŒ…ç±»ä¼¼ï¼Œä¸è¿‡ C++ çš„é—­åŒ…è¿˜æœ‰<a href=\"http://www.elbeno.com/blog/?p=1068\">ä¸€äº›åœºæ™¯</a>ä¼šè§¦å‘å †å†…å­˜åˆ†é…ã€‚å¦‚æœä½ è¿˜è®°å¾— 16 è®²çš„ Rust / Swift / Kotlin iterator å‡½æ•°å¼ç¼–ç¨‹çš„æ€§èƒ½æµ‹è¯•ï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/c1/d4/c1e1c1909b761cfa3348115bb417d4d4.png?wh=1430x1072\" alt=\"\"></p><p>Kotlin è¿è¡Œè¶…æ—¶ï¼ŒSwift å¾ˆæ…¢ï¼ŒRust çš„æ€§èƒ½å´å’Œä½¿ç”¨å‘½ä»¤å¼ç¼–ç¨‹çš„ C å‡ ä¹ä¸€æ ·ï¼Œé™¤äº†ç¼–è¯‘å™¨ä¼˜åŒ–çš„æ•ˆæœï¼Œä¹Ÿå› ä¸º Rust é—­åŒ…çš„æ€§èƒ½å’Œå‡½æ•°å·®ä¸å¤šã€‚</p><p>ä¸ºä»€ä¹ˆ Rust å¯ä»¥åšåˆ°è¿™æ ·å‘¢ï¼Ÿè¿™åˆè·Ÿ Rust ä»æ ¹æœ¬ä¸Šä½¿ç”¨æ‰€æœ‰æƒå’Œå€Ÿç”¨ï¼Œè§£å†³äº†å†…å­˜å½’å±é—®é¢˜æœ‰å…³ã€‚</p><p>åœ¨å…¶ä»–è¯­è¨€ä¸­ï¼Œé—­åŒ…å˜é‡å› ä¸ºå¤šé‡å¼•ç”¨å¯¼è‡´ç”Ÿå‘½å‘¨æœŸä¸æ˜ç¡®ï¼Œä½† Rust ä»ä¸€å¼€å§‹å°±æ¶ˆç­äº†è¿™ä¸ªé—®é¢˜ï¼š</p><ul>\n<li>å¦‚æœä¸ä½¿ç”¨ move è½¬ç§»æ‰€æœ‰æƒï¼Œé—­åŒ…ä¼šå¼•ç”¨ä¸Šä¸‹æ–‡ä¸­çš„å˜é‡ï¼Œ<strong>è¿™ä¸ªå¼•ç”¨å—å€Ÿç”¨è§„åˆ™çš„çº¦æŸ</strong>ï¼Œæ‰€ä»¥åªè¦ç¼–è¯‘é€šè¿‡ï¼Œé‚£ä¹ˆé—­åŒ…å¯¹å˜é‡çš„å¼•ç”¨å°±ä¸ä¼šè¶…è¿‡å˜é‡çš„ç”Ÿå‘½å‘¨æœŸï¼Œæ²¡æœ‰å†…å­˜å®‰å…¨é—®é¢˜ã€‚</li>\n<li>å¦‚æœä½¿ç”¨ move è½¬ç§»æ‰€æœ‰æƒï¼Œä¸Šä¸‹æ–‡ä¸­çš„å˜é‡åœ¨è½¬ç§»åå°±æ— æ³•è®¿é—®ï¼Œ<strong>é—­åŒ…å®Œå…¨æ¥ç®¡è¿™äº›å˜é‡</strong>ï¼Œå®ƒä»¬çš„ç”Ÿå‘½å‘¨æœŸå’Œé—­åŒ…ä¸€è‡´ï¼Œæ‰€ä»¥ä¹Ÿä¸ä¼šæœ‰å†…å­˜å®‰å…¨é—®é¢˜ã€‚</li>\n</ul><p>è€Œ Rust ä¸ºæ¯ä¸ªé—­åŒ…ç”Ÿæˆä¸€ä¸ªæ–°çš„ç±»å‹ï¼Œåˆä½¿å¾—<strong>è°ƒç”¨é—­åŒ…æ—¶å¯ä»¥ç›´æ¥å’Œä»£ç å¯¹åº”</strong>ï¼Œçœå»äº†ä½¿ç”¨å‡½æ•°æŒ‡é’ˆå†è½¬ä¸€é“æ‰‹çš„é¢å¤–æ¶ˆè€—ã€‚</p><p>æ‰€ä»¥è¿˜æ˜¯é‚£å¥è¯ï¼Œå½“å›å½’åˆ°æœ€åˆçš„æœ¬åŸï¼Œä½ è§£å†³çš„ä¸æ˜¯å•ä¸ªé—®é¢˜ï¼Œè€Œæ˜¯ç”±æ­¤å¼•å‘çš„æ‰€æœ‰é—®é¢˜ã€‚æˆ‘ä»¬ä¸å¿…ä¸ºå †å†…å­˜ç®¡ç†è®¾è®¡ GCã€ä¸å¿…ä¸ºå…¶å®ƒèµ„æºçš„å›æ”¶æä¾› defer å…³é”®å­—ã€ä¸å¿…ä¸ºå¹¶å‘å®‰å…¨è¿›è¡Œè¯¸å¤šé™åˆ¶ã€ä¹Ÿä¸å¿…ä¸ºé—­åŒ…æŒ–ç©ºå¿ƒæ€æä¼˜åŒ–ã€‚</p><h2>Rustçš„é—­åŒ…ç±»å‹</h2><p>ç°åœ¨æˆ‘ä»¬ææ˜ç™½äº†é—­åŒ…ç©¶ç«Ÿæ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ï¼Œåœ¨å†…å­˜ä¸­æ€ä¹ˆè¡¨ç¤ºï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ FnOnce / FnMut / Fn è¿™ä¸‰ç§é—­åŒ…ç±»å‹æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚</p><p>åœ¨å£°æ˜é—­åŒ…çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦æŒ‡å®šé—­åŒ…è¦æ»¡è¶³çš„çº¦æŸï¼Œä½†æ˜¯å½“é—­åŒ…ä½œä¸ºå‡½æ•°çš„å‚æ•°æˆ–è€…æ•°æ®ç»“æ„çš„ä¸€ä¸ªåŸŸæ—¶ï¼Œæˆ‘ä»¬éœ€è¦å‘Šè¯‰è°ƒç”¨è€…ï¼Œå¯¹é—­åŒ…çš„çº¦æŸã€‚è¿˜ä»¥ thread::spawn ä¸ºä¾‹ï¼Œå®ƒè¦æ±‚ä¼ å…¥çš„é—­åŒ…æ»¡è¶³ FnOnce traitã€‚</p><h3>FnOnce</h3><p>å…ˆæ¥çœ‹ FnOnceã€‚å®ƒçš„<a href=\"https://doc.rust-lang.org/std/ops/trait.FnOnce.html\">å®šä¹‰</a>å¦‚ä¸‹ï¼š</p><pre><code class=\"language-rust\">pub trait FnOnce&lt;Args&gt; {\n    type Output;\n    extern \"rust-call\" fn call_once(self, args: Args) -&gt; Self::Output;\n}\n</code></pre><p>FnOnce æœ‰ä¸€ä¸ªå…³è”ç±»å‹ Outputï¼Œæ˜¾ç„¶ï¼Œå®ƒæ˜¯é—­åŒ…è¿”å›å€¼çš„ç±»å‹ï¼›è¿˜æœ‰ä¸€ä¸ªæ–¹æ³• call_onceï¼Œè¦æ³¨æ„çš„æ˜¯ call_once ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ selfï¼Œå®ƒä¼šè½¬ç§» self çš„æ‰€æœ‰æƒåˆ° call_once å‡½æ•°ä¸­ã€‚</p><p>è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ FnOnce è¢«ç§°ä½œ Once ï¼š<strong>å®ƒåªèƒ½è¢«è°ƒç”¨ä¸€æ¬¡</strong>ã€‚å†æ¬¡è°ƒç”¨ï¼Œç¼–è¯‘å™¨å°±ä¼šæŠ¥å˜é‡å·²ç»è¢« move è¿™æ ·çš„å¸¸è§æ‰€æœ‰æƒé”™è¯¯äº†ã€‚</p><p>è‡³äº FnOnce çš„å‚æ•°ï¼Œæ˜¯ä¸€ä¸ªå« Args çš„æ³›å‹å‚æ•°ï¼Œå®ƒå¹¶æ²¡æœ‰ä»»ä½•çº¦æŸã€‚å¦‚æœä½ å¯¹è¿™ä¸ªæ„Ÿå…´è¶£å¯ä»¥çœ‹æ–‡æœ«çš„å‚è€ƒèµ„æ–™ã€‚</p><p>çœ‹ä¸€ä¸ªéšå¼çš„ FnOnce çš„ä¾‹å­ï¼š</p><pre><code class=\"language-rust\">fn main() {\n    let name = String::from(\"Tyr\");\n    // è¿™ä¸ªé—­åŒ…å•¥ä¹Ÿä¸å¹²ï¼Œåªæ˜¯æŠŠæ•è·çš„å‚æ•°è¿”å›å»\n    let c = move |greeting: String| (greeting, name);\n\n    let result = c(\"hello\".to_string());\n\n    println!(\"result: {:?}\", result);\n\n    // æ— æ³•å†æ¬¡è°ƒç”¨\n    let result = c(\"hi\".to_string());\n}\n</code></pre><p>è¿™ä¸ªé—­åŒ… cï¼Œå•¥ä¹Ÿæ²¡åšï¼Œåªæ˜¯æŠŠæ•è·çš„å‚æ•°è¿”å›ã€‚å°±åƒä¸€ä¸ªç»“æ„ä½“é‡Œï¼ŒæŸä¸ªå­—æ®µè¢«è½¬ç§»èµ°ä¹‹åï¼Œå°±ä¸èƒ½å†è®¿é—®ä¸€æ ·ï¼Œé—­åŒ…å†…éƒ¨çš„æ•°æ®ä¸€æ—¦è¢«è½¬ç§»ï¼Œè¿™ä¸ªé—­åŒ…å°±ä¸å®Œæ•´äº†ï¼Œä¹Ÿå°±æ— æ³•å†æ¬¡ä½¿ç”¨ï¼Œæ‰€ä»¥å®ƒæ˜¯ä¸€ä¸ª FnOnce çš„é—­åŒ…ã€‚</p><p>å¦‚æœä¸€ä¸ªé—­åŒ…å¹¶ä¸è½¬ç§»è‡ªå·±çš„å†…éƒ¨æ•°æ®ï¼Œé‚£ä¹ˆå®ƒå°±ä¸æ˜¯ FnOnceï¼Œç„¶è€Œï¼Œä¸€æ—¦å®ƒè¢«å½“åš FnOnce è°ƒç”¨ï¼Œè‡ªå·±ä¼šè¢«è½¬ç§»åˆ° call_once å‡½æ•°çš„ä½œç”¨åŸŸä¸­ï¼Œä¹‹åå°±æ— æ³•å†æ¬¡è°ƒç”¨äº†ï¼Œæˆ‘ä»¬çœ‹ä¸ªä¾‹å­ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=d35767cd6cc747d21a57592088aa5854\">ä»£ç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">fn main() {\n    let name = String::from(\"Tyr\");\n\n    // è¿™ä¸ªé—­åŒ…ä¼š clone å†…éƒ¨çš„æ•°æ®è¿”å›ï¼Œæ‰€ä»¥å®ƒä¸æ˜¯ FnOnce\n    let c = move |greeting: String| (greeting, name.clone());\n\n    // æ‰€ä»¥ c1 å¯ä»¥è¢«è°ƒç”¨å¤šæ¬¡\n\n    println!(\"c1 call once: {:?}\", c(\"qiao\".into()));\n    println!(\"c1 call twice: {:?}\", c(\"bonjour\".into()));\n\n    // ç„¶è€Œä¸€æ—¦å®ƒè¢«å½“æˆ FnOnce è¢«è°ƒç”¨ï¼Œå°±æ— æ³•è¢«å†æ¬¡è°ƒç”¨\n    println!(\"result: {:?}\", call_once(\"hi\".into(), c));\n\n    // æ— æ³•å†æ¬¡è°ƒç”¨\n    // let result = c(\"hi\".to_string());\n\n    // Fn ä¹Ÿå¯ä»¥è¢«å½“æˆ FnOnce è°ƒç”¨ï¼Œåªè¦æ¥å£ä¸€è‡´å°±å¯ä»¥\n    println!(\"result: {:?}\", call_once(\"hola\".into(), not_closure));\n}\n\nfn call_once(arg: String, c: impl FnOnce(String) -&gt; (String, String)) -&gt; (String, String) {\n    c(arg)\n}\n\nfn not_closure(arg: String) -&gt; (String, String) {\n    (arg, \"Rosie\".into())\n}\n</code></pre><h3>FnMut</h3><p>ç†è§£äº† FnOnceï¼Œæˆ‘ä»¬å†æ¥çœ‹ FnMutï¼Œå®ƒçš„<a href=\"https://doc.rust-lang.org/std/ops/trait.FnMut.html\">å®šä¹‰</a>å¦‚ä¸‹ï¼š</p><pre><code class=\"language-rust\">pub trait FnMut&lt;Args&gt;: FnOnce&lt;Args&gt; {\n    extern \"rust-call\" fn call_mut(\n        &amp;mut self, \n        args: Args\n    ) -&gt; Self::Output;\n}\n</code></pre><p>é¦–å…ˆï¼ŒFnMut â€œç»§æ‰¿â€äº† FnOnceï¼Œæˆ–è€…è¯´ FnOnce æ˜¯ FnMut çš„ super traitã€‚æ‰€ä»¥FnMutä¹Ÿæ‹¥æœ‰ Output è¿™ä¸ªå…³è”ç±»å‹å’Œ call_once è¿™ä¸ªæ–¹æ³•ã€‚æ­¤å¤–ï¼Œå®ƒè¿˜æœ‰ä¸€ä¸ª call_mut() æ–¹æ³•ã€‚<strong>æ³¨æ„ call_mut() ä¼ å…¥ &amp;mut selfï¼Œå®ƒä¸ç§»åŠ¨ selfï¼Œæ‰€ä»¥ FnMut å¯ä»¥è¢«å¤šæ¬¡è°ƒç”¨</strong>ã€‚</p><p>å› ä¸º FnOnce æ˜¯ FnMut çš„ super traitï¼Œæ‰€ä»¥ï¼Œä¸€ä¸ª FnMut é—­åŒ…ï¼Œå¯ä»¥è¢«ä¼ ç»™ä¸€ä¸ªéœ€è¦ FnOnce çš„ä¸Šä¸‹æ–‡ï¼Œæ­¤æ—¶è°ƒç”¨é—­åŒ…ç›¸å½“äºè°ƒç”¨äº† call_once()ã€‚</p><p>å¦‚æœä½ ç†è§£äº†å‰é¢è®²çš„é—­åŒ…çš„å†…å­˜ç»„ç»‡ç»“æ„ï¼Œé‚£ä¹ˆ FnMut å°±ä¸éš¾ç†è§£ï¼Œå°±åƒç»“æ„ä½“å¦‚æœæƒ³æ”¹å˜æ•°æ®éœ€è¦ç”¨ let mut å£°æ˜ä¸€æ ·ï¼Œå¦‚æœä½ æƒ³æ”¹å˜é—­åŒ…æ•è·çš„æ•°æ®ç»“æ„ï¼Œé‚£ä¹ˆå°±éœ€è¦ FnMutã€‚æˆ‘ä»¬çœ‹ä¸ªä¾‹å­ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=979173c2269312cb63a73bb439a5b3b8\">ä»£ç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">fn main() {\n    let mut name = String::from(\"hello\");\n    let mut name1 = String::from(\"hola\");\n\n    // æ•è· &amp;mut name\n    let mut c = || {\n        name.push_str(\" Tyr\");\n        println!(\"c: {}\", name);\n    };\n\n    // æ•è· mut name1ï¼Œæ³¨æ„ name1 éœ€è¦å£°æ˜æˆ mut\n    let mut c1 = move || {\n        name1.push_str(\"!\");\n        println!(\"c1: {}\", name1);\n    };\n\n    c();\n    c1();\n\n    call_mut(&amp;mut c);\n    call_mut(&amp;mut c1);\n\n    call_once(c);\n    call_once(c1);\n}\n\n// åœ¨ä½œä¸ºå‚æ•°æ—¶ï¼ŒFnMut ä¹Ÿè¦æ˜¾å¼åœ°ä½¿ç”¨ mutï¼Œæˆ–è€… &amp;mut\nfn call_mut(c: &amp;mut impl FnMut()) {\n    c();\n}\n\n// æƒ³æƒ³çœ‹ï¼Œä¸ºå•¥ call_once ä¸éœ€è¦ mutï¼Ÿ\nfn call_once(c: impl FnOnce()) {\n    c();\n}\n</code></pre><p>åœ¨å£°æ˜çš„é—­åŒ… c å’Œ c1 é‡Œï¼Œæˆ‘ä»¬ä¿®æ”¹äº†æ•è·çš„ name å’Œ name1ã€‚ä¸åŒçš„æ˜¯ name ä½¿ç”¨äº†å¼•ç”¨ï¼Œè€Œ name1 ç§»åŠ¨äº†æ‰€æœ‰æƒï¼Œè¿™ä¸¤ç§æƒ…å†µå’Œå…¶å®ƒä»£ç ä¸€æ ·ï¼Œä¹Ÿéœ€è¦éµå¾ªæ‰€æœ‰æƒå’Œå€Ÿç”¨æœ‰å…³çš„è§„åˆ™ã€‚æ‰€ä»¥ï¼Œå¦‚æœåœ¨é—­åŒ… c é‡Œå€Ÿç”¨äº† nameï¼Œä½ å°±ä¸èƒ½æŠŠ name ç§»åŠ¨ç»™å¦ä¸€ä¸ªé—­åŒ… c1ã€‚</p><p>è¿™é‡Œä¹Ÿå±•ç¤ºäº†ï¼Œc å’Œ c1 è¿™ä¸¤ä¸ªç¬¦åˆ FnMut çš„é—­åŒ…ï¼Œèƒ½ä½œä¸º FnOnce æ¥è°ƒç”¨ã€‚æˆ‘ä»¬åœ¨ä»£ç ä¸­ä¹Ÿç¡®è®¤äº†ï¼ŒFnMut å¯ä»¥è¢«å¤šæ¬¡è°ƒç”¨ï¼Œè¿™æ˜¯å› ä¸º call_mut() ä½¿ç”¨çš„æ˜¯ &amp;mut selfï¼Œä¸ç§»åŠ¨æ‰€æœ‰æƒã€‚</p><h3>Fn</h3><p>æœ€åæˆ‘ä»¬æ¥çœ‹çœ‹ Fn traitã€‚å®ƒçš„<a href=\"https://doc.rust-lang.org/std/ops/trait.Fn.html\">å®šä¹‰</a>å¦‚ä¸‹ï¼š</p><pre><code class=\"language-rust\">pub trait Fn&lt;Args&gt;: FnMut&lt;Args&gt; {\n    extern \"rust-call\" fn call(&amp;self, args: Args) -&gt; Self::Output;\n}\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œå®ƒâ€œç»§æ‰¿â€äº† FnMutï¼Œæˆ–è€…è¯´ FnMut æ˜¯ Fn çš„ super traitã€‚è¿™ä¹Ÿå°±æ„å‘³ç€<strong>ä»»ä½•éœ€è¦ FnOnce æˆ–è€… FnMut çš„åœºåˆï¼Œéƒ½å¯ä»¥ä¼ å…¥æ»¡è¶³ Fn çš„é—­åŒ…</strong>ã€‚æˆ‘ä»¬ç»§ç»­çœ‹ä¾‹å­ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=e00f0e9009d0991f7d7e7ec48e9d93d5\">ä»£ç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">fn main() {\n    let v = vec![0u8; 1024];\n    let v1 = vec![0u8; 1023];\n\n    // Fnï¼Œä¸ç§»åŠ¨æ‰€æœ‰æƒ\n    let mut c = |x: u64| v.len() as u64 * x;\n    // Fnï¼Œç§»åŠ¨æ‰€æœ‰æƒ\n    let mut c1 = move |x: u64| v1.len() as u64 * x;\n\n    println!(\"direct call: {}\", c(2));\n    println!(\"direct call: {}\", c1(2));\n\n    println!(\"call: {}\", call(3, &amp;c));\n    println!(\"call: {}\", call(3, &amp;c1));\n\n    println!(\"call_mut: {}\", call_mut(4, &amp;mut c));\n    println!(\"call_mut: {}\", call_mut(4, &amp;mut c1));\n\n    println!(\"call_once: {}\", call_once(5, c));\n    println!(\"call_once: {}\", call_once(5, c1));\n}\n\nfn call(arg: u64, c: &amp;impl Fn(u64) -&gt; u64) -&gt; u64 {\n    c(arg)\n}\n\nfn call_mut(arg: u64, c: &amp;mut impl FnMut(u64) -&gt; u64) -&gt; u64 {\n    c(arg)\n}\n\nfn call_once(arg: u64, c: impl FnOnce(u64) -&gt; u64) -&gt; u64 {\n    c(arg)\n}\n</code></pre><h2>é—­åŒ…çš„ä½¿ç”¨åœºæ™¯</h2><p>åœ¨è®²å®ŒRustçš„ä¸‰ä¸ªé—­åŒ…ç±»å‹ä¹‹åï¼Œæœ€åæ¥çœ‹çœ‹é—­åŒ…çš„ä½¿ç”¨åœºæ™¯ã€‚è™½ç„¶ä»Šå¤©æ‰å¼€å§‹è®²é—­åŒ…ï¼Œä½†å…¶å®ä¹‹å‰éšæ™¦åœ°ä½¿ç”¨äº†å¾ˆå¤šé—­åŒ…ã€‚</p><p>thread::spawn è‡ªä¸å¿…è¯´ï¼Œæˆ‘ä»¬ç†Ÿæ‚‰çš„ Iterator trait é‡Œé¢å¤§éƒ¨åˆ†å‡½æ•°éƒ½æ¥å—ä¸€ä¸ªé—­åŒ…ï¼Œæ¯”å¦‚ <a href=\"https://doc.rust-lang.org/src/core/iter/traits/iterator.rs.html#682-685\">map</a>ï¼š</p><pre><code class=\"language-rust\">fn map&lt;B, F&gt;(self, f: F) -&gt; Map&lt;Self, F&gt;\nwhere\n\t\tSelf: Sized,\n\t  F: FnMut(Self::Item) -&gt; B,\n{\n\t\tMap::new(self, f)\n}\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼ŒIterator çš„ map() æ–¹æ³•æ¥å—ä¸€ä¸ª FnMutï¼Œå®ƒçš„å‚æ•°æ˜¯ Self::Itemï¼Œè¿”å›å€¼æ˜¯æ²¡æœ‰çº¦æŸçš„æ³›å‹å‚æ•° Bã€‚Self::Item æ˜¯ Iterator::next() æ–¹æ³•åå‡ºæ¥çš„æ•°æ®ï¼Œè¢« map ä¹‹åï¼Œå¯ä»¥å¾—åˆ°å¦ä¸€ä¸ªç»“æœã€‚</p><p>æ‰€ä»¥åœ¨å‡½æ•°çš„å‚æ•°ä¸­ä½¿ç”¨é—­åŒ…ï¼Œæ˜¯é—­åŒ…ä¸€ç§éå¸¸å…¸å‹çš„ç”¨æ³•ã€‚å¦å¤–é—­åŒ…ä¹Ÿå¯ä»¥ä½œä¸ºå‡½æ•°çš„è¿”å›å€¼ï¼Œä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=92a031385725865cc8d11bd3d56bdd69\">ä»£ç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">use std::ops::Mul;\n\nfn main() {\n    let c1 = curry(5);\n    println!(\"5 multiply 2 is: {}\", c1(2));\n\n    let adder2 = curry(3.14);\n    println!(\"pi multiply 4^2 is: {}\", adder2(4. * 4.));\n}\n\nfn curry&lt;T&gt;(x: T) -&gt; impl Fn(T) -&gt; T\nwhere\n    T: Mul&lt;Output = T&gt; + Copy,\n{\n    move |y| x * y\n}\n</code></pre><p>æœ€åï¼Œé—­åŒ…è¿˜æœ‰ä¸€ç§å¹¶ä¸å°‘è§ï¼Œä½†å¯èƒ½ä¸å¤ªå®¹æ˜“ç†è§£çš„ç”¨æ³•ï¼š<strong>ä¸ºå®ƒå®ç°æŸä¸ª trait</strong>ï¼Œä½¿å…¶ä¹Ÿèƒ½è¡¨ç°å‡ºå…¶ä»–è¡Œä¸ºï¼Œè€Œä¸ä»…ä»…æ˜¯ä½œä¸ºå‡½æ•°è¢«è°ƒç”¨ã€‚æ¯”å¦‚è¯´æœ‰äº›æ¥å£æ—¢å¯ä»¥ä¼ å…¥ä¸€ä¸ªç»“æ„ä½“ï¼Œåˆå¯ä»¥ä¼ å…¥ä¸€ä¸ªå‡½æ•°æˆ–è€…é—­åŒ…ã€‚</p><p>æˆ‘ä»¬çœ‹ä¸€ä¸ª <a href=\"https://github.com/hyperium/tonic\">tonic</a>ï¼ˆRust ä¸‹çš„ gRPC åº“ï¼‰çš„<a href=\"https://docs.rs/tonic/0.5.2/src/tonic/service/interceptor.rs.html#41-53\">ä¾‹å­</a>ï¼š</p><pre><code class=\"language-rust\">pub trait Interceptor {\n    /// Intercept a request before it is sent, optionally cancelling it.\n    fn call(&amp;mut self, request: crate::Request&lt;()&gt;) -&gt; Result&lt;crate::Request&lt;()&gt;, Status&gt;;\n}\n\nimpl&lt;F&gt; Interceptor for F\nwhere\n    F: FnMut(crate::Request&lt;()&gt;) -&gt; Result&lt;crate::Request&lt;()&gt;, Status&gt;,\n{\n    fn call(&amp;mut self, request: crate::Request&lt;()&gt;) -&gt; Result&lt;crate::Request&lt;()&gt;, Status&gt; {\n        self(request)\n    }\n}\n</code></pre><p>åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼ŒInterceptor æœ‰ä¸€ä¸ª call æ–¹æ³•ï¼Œå®ƒå¯ä»¥è®© gRPC Request è¢«å‘é€å‡ºå»ä¹‹å‰è¢«ä¿®æ”¹ï¼Œä¸€èˆ¬æ˜¯æ·»åŠ å„ç§å¤´ï¼Œæ¯”å¦‚ Authorization å¤´ã€‚</p><p>æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªç»“æ„ä½“ï¼Œä¸ºå®ƒå®ç° Interceptorï¼Œä¸è¿‡å¤§éƒ¨åˆ†æ—¶å€™ Interceptor å¯ä»¥ç›´æ¥é€šè¿‡ä¸€ä¸ªé—­åŒ…å‡½æ•°å®Œæˆã€‚ä¸ºäº†è®©ä¼ å…¥çš„é—­åŒ…ä¹Ÿèƒ½é€šè¿‡ Interceptor::call() æ¥ç»Ÿä¸€è°ƒç”¨ï¼Œå¯ä»¥ä¸ºç¬¦åˆæŸä¸ªæ¥å£çš„é—­åŒ…å®ç° Interceptor traitã€‚æŒæ¡äº†è¿™ç§ç”¨æ³•ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡æŸäº› trait æŠŠç‰¹å®šçš„ç»“æ„ä½“å’Œé—­åŒ…ç»Ÿä¸€èµ·æ¥è°ƒç”¨ï¼Œæ˜¯ä¸æ˜¯å¾ˆç¥å¥‡ã€‚</p><h2>å°ç»“</h2><p>Rust é—­åŒ…çš„æ•ˆç‡éå¸¸é«˜ã€‚é¦–å…ˆé—­åŒ…æ•è·çš„å˜é‡ï¼Œéƒ½å‚¨å­˜åœ¨æ ˆä¸Šï¼Œæ²¡æœ‰å †å†…å­˜åˆ†é…ã€‚å…¶æ¬¡å› ä¸ºé—­åŒ…åœ¨åˆ›å»ºæ—¶ä¼šéšå¼åœ°åˆ›å»ºè‡ªå·±çš„ç±»å‹ï¼Œæ¯ä¸ªé—­åŒ…éƒ½æ˜¯ä¸€ä¸ªæ–°çš„ç±»å‹ã€‚é€šè¿‡é—­åŒ…è‡ªå·±å”¯ä¸€çš„ç±»å‹ï¼ŒRust ä¸éœ€è¦é¢å¤–çš„å‡½æ•°æŒ‡é’ˆæ¥è¿è¡Œé—­åŒ…ï¼Œæ‰€ä»¥<strong>é—­åŒ…çš„è°ƒç”¨æ•ˆç‡å’Œå‡½æ•°è°ƒç”¨å‡ ä¹ä¸€è‡´</strong>ã€‚</p><p>Rust æ”¯æŒä¸‰ç§ä¸åŒçš„é—­åŒ… traitï¼šFnOnceã€FnMut å’Œ Fnã€‚FnOnce æ˜¯ FnMut çš„ super traitï¼Œè€Œ FnMut åˆæ˜¯ Fn çš„ super traitã€‚ä»è¿™äº› trait çš„æ¥å£å¯ä»¥çœ‹å‡ºï¼Œ</p><ul>\n<li>FnOnce åªèƒ½è°ƒç”¨ä¸€æ¬¡ï¼›</li>\n<li>FnMut å…è®¸åœ¨æ‰§è¡Œæ—¶ä¿®æ”¹é—­åŒ…çš„å†…éƒ¨æ•°æ®ï¼Œå¯ä»¥æ‰§è¡Œå¤šæ¬¡ï¼›</li>\n<li>Fn ä¸å…è®¸ä¿®æ”¹é—­åŒ…çš„å†…éƒ¨æ•°æ®ï¼Œä¹Ÿå¯ä»¥æ‰§è¡Œå¤šæ¬¡ã€‚</li>\n</ul><p>æ€»ç»“ä¸€ä¸‹ä¸‰ç§é—­åŒ…ä½¿ç”¨çš„æƒ…å†µä»¥åŠå®ƒä»¬ä¹‹é—´çš„å…³ç³»ï¼š<img src=\"https://static001.geekbang.org/resource/image/cb/25/cba964802787a05f173099b13d210b25.jpg?wh=2256x1296\" alt=\"\"></p><h3>æ€è€ƒé¢˜</h3><ol>\n<li>ä¸‹é¢çš„ä»£ç ï¼Œé—­åŒ… c ç›¸å½“äºä¸€ä¸ªä»€ä¹ˆæ ·çš„ç»“æ„ä½“ï¼Ÿå®ƒçš„é•¿åº¦å¤šå¤§ï¼Ÿä»£ç çš„æœ€åï¼Œmain() å‡½æ•°è¿˜èƒ½è®¿é—®å˜é‡ name ä¹ˆï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ</li>\n</ol><pre><code class=\"language-rust\">fn main() {\n    let name = String::from(\"Tyr\");\n    let vec = vec![\"Rust\", \"Elixir\", \"Javascript\"];\n    let v = &amp;vec[..];\n    let data = (1, 2, 3, 4);\n    let c = move || {\n        println!(\"data: {:?}\", data);\n        println!(\"v: {:?}, name: {:?}\", v, name.clone());\n    };\n    c();\n\n    // è¯·é—®åœ¨è¿™é‡Œï¼Œè¿˜èƒ½è®¿é—® name ä¹ˆï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ\n}\n</code></pre><ol start=\"2\">\n<li>åœ¨è®²åˆ° FnMut æ—¶ï¼Œæˆ‘ä»¬æ”¾äº†ä¸€æ®µä»£ç ï¼Œåœ¨é‚£æ®µä»£ç é‡Œï¼Œæˆ‘é—®äº†ä¸€ä¸ªé—®é¢˜ï¼šä¸ºå•¥ call_once ä¸éœ€è¦ c æ˜¯ mut å‘¢ï¼Ÿå°±åƒä¸‹é¢è¿™æ ·ï¼š</li>\n</ol><pre><code class=\"language-rust\">// æƒ³æƒ³çœ‹ï¼Œä¸ºå•¥ call_once ä¸éœ€è¦ mutï¼Ÿ\nfn call_once(mut c: impl FnOnce()) {\n    c();\n}\n</code></pre><ol start=\"3\">\n<li>ä¸ºä¸‹é¢çš„ä»£ç æ·»åŠ å®ç°ï¼Œä½¿å…¶èƒ½å¤Ÿæ­£å¸¸å·¥ä½œï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=f29ebd99613bc9da1d358e0f5b758fd6\">ä»£ç </a>ï¼‰ï¼š</li>\n</ol><pre><code class=\"language-rust\">pub trait Executor {\n    fn execute(&amp;self, cmd: &amp;str) -&gt; Result&lt;String, &amp;'static str&gt;;\n}\n\nstruct BashExecutor {\n    env: String,\n}\n\nimpl Executor for BashExecutor {\n    fn execute(&amp;self, cmd: &amp;str) -&gt; Result&lt;String, &amp;'static str&gt; {\n        Ok(format!(\n            \"fake bash execute: env: {}, cmd: {}\",\n            self.env, cmd\n        ))\n    }\n}\n\n// çœ‹çœ‹æˆ‘ç»™çš„ tonic çš„ä¾‹å­ï¼Œæƒ³æƒ³æ€ä¹ˆå®ç°è®© 27 è¡Œå¯ä»¥æ­£å¸¸æ‰§è¡Œ\n\nfn main() {\n    let env = \"PATH=/usr/bin\".to_string();\n\n    let cmd = \"cat /etc/passwd\";\n    let r1 = execute(cmd, BashExecutor { env: env.clone() });\n    println!(\"{:?}\", r1);\n\n    let r2 = execute(cmd, |cmd: &amp;str| {\n        Ok(format!(\"fake fish execute: env: {}, cmd: {}\", env, cmd))\n    });\n    println!(\"{:?}\", r2);\n}\n\nfn execute(cmd: &amp;str, exec: impl Executor) -&gt; Result&lt;String, &amp;'static str&gt; {\n    exec.execute(cmd)\n}\n</code></pre><p>ä½ å·²ç»å®ŒæˆRustå­¦ä¹ çš„ç¬¬19æ¬¡æ‰“å¡ã€‚å¦‚æœä½ è§‰å¾—æœ‰æ”¶è·ï¼Œä¹Ÿæ¬¢è¿ä½ åˆ†äº«ç»™èº«è¾¹çš„æœ‹å‹ï¼Œé‚€TAä¸€èµ·è®¨è®ºã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ï½</p><h2>å‚è€ƒèµ„æ–™</h2><p>æ€ä¹ˆç†è§£ FnOnce çš„ Args æ³›å‹å‚æ•°å‘¢ï¼ŸArgs åˆæ˜¯æ€ä¹ˆå’Œ FnOnce çš„çº¦æŸï¼Œæ¯”å¦‚ FnOnce(String) è¿™æ ·çš„å‚æ•°åŒ¹é…å‘¢ï¼Ÿæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥çœ‹ä¸‹é¢çš„ä¾‹å­ï¼Œå®ƒï¼ˆä¸å®Œå…¨ï¼‰æ¨¡æ‹Ÿäº† FnOnce ä¸­é—­åŒ…çš„ä½¿ç”¨ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=424352c0be4e143b284a0223a4a8bff5\">ä»£ç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">struct ClosureOnce&lt;Captured, Args, Output&gt; {\n    // æ•è·çš„æ•°æ®\n    captured: Captured,\n    // closure çš„æ‰§è¡Œä»£ç \n    func: fn(Args, Captured) -&gt; Output,\n}\n\nimpl&lt;Captured, Args, Output&gt; ClosureOnce&lt;Captured, Args, Output&gt; {\n    // æ¨¡æ‹Ÿ FnOnce çš„ call_onceï¼Œç›´æ¥æ¶ˆè€— self\n    fn call_once(self, greeting: Args) -&gt; Output {\n        (self.func)(greeting, self.captured)\n    }\n}\n\n// ç±»ä¼¼ greeting é—­åŒ…çš„å‡½æ•°ä½“\nfn greeting_code1(args: (String,), captured: (String,)) -&gt; (String, String) {\n    (args.0, captured.0)\n}\n\nfn greeting_code2(args: (String, String), captured: (String, u8)) -&gt; (String, String, String, u8) {\n    (args.0, args.1, captured.0, captured.1)\n}\n\nfn main() {\n    let name = \"Tyr\".into();\n    // æ¨¡æ‹Ÿå˜é‡æ•æ‰\n    let c = ClosureOnce {\n        captured: (name,),\n        func: greeting_code1,\n    };\n\n    // æ¨¡æ‹Ÿé—­åŒ…è°ƒç”¨ï¼Œè¿™é‡Œå’Œ FnOnce ä¸å®Œå…¨ä¸€æ ·ï¼Œä¼ å…¥çš„æ˜¯ä¸€ä¸ª tuple æ¥åŒ¹é… Args å‚æ•°\n    println!(\"{:?}\", c.call_once((\"hola\".into(),)));\n    // è°ƒç”¨ä¸€æ¬¡åæ— æ³•ç»§ç»­è°ƒç”¨\n    // println!(\"{:?}\", clo.call_once(\"hola\".into()));\n\n    // æ›´å¤æ‚ä¸€äº›çš„å¤æ‚çš„é—­åŒ…\n    let c1 = ClosureOnce {\n        captured: (\"Tyr\".into(), 18),\n        func: greeting_code2,\n    };\n\n    println!(\"{:?}\", c1.call_once((\"hola\".into(), \"hallo\".into())));\n}\n</code></pre><h3></h3>","neighbors":{"left":{"article_title":"18ï½œé”™è¯¯å¤„ç†ï¼šä¸ºä»€ä¹ˆRustçš„é”™è¯¯å¤„ç†ä¸ä¼—ä¸åŒï¼Ÿ","id":424002},"right":{"article_title":"20ï½œ4 Steps ï¼šå¦‚ä½•æ›´å¥½åœ°é˜…è¯»Rustæºç ï¼Ÿ","id":424017}},"comments":[{"had_liked":false,"id":314821,"user_name":"D. D","can_delete":false,"product_type":"c1","uid":2186992,"ip_address":"","ucode":"C416E5602C8814","user_header":"https://static001.geekbang.org/account/avatar/00/21/5e/f0/62d8cf9e.jpg","comment_is_top":false,"comment_ctime":1633468174,"is_pvip":true,"replies":[{"id":"114172","content":"èµï¼éå¸¸å¥½ï¼<br><br>","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1633813535,"ip_address":"","comment_id":314821,"utype":1}],"discussion_count":1,"race_medal":0,"score":"91827781390","product_id":100085301,"comment_content":"1. ç›¸å½“äºï¼š<br>struct Closure&lt;&#39;a, &#39;b: &#39;a&gt; {<br>    data: (i32, i32, i32, i32),<br>    v: &amp;&#39;a [&amp;&#39;b str],<br>    name: String,<br>}<br><br>å®ƒçš„é•¿åº¦ç­‰äº 4*4(4ä¸ªi32) + 2*8(ptr, len) + 3*8(ptr, len, cap) = 56å­—èŠ‚ã€‚<br>ä»£ç çš„æœ€åä¸èƒ½è®¿é—®nameäº†ï¼Œå› ä¸ºå·²ç»ä½¿ç”¨äº†moveå…³é”®å­—å°†nameçš„æ‰€æœ‰æƒç§»è‡³é—­åŒ…cä¸­äº†ã€‚<br><br>2. ä»å®šä¹‰å¯ä»¥çœ‹å‡ºï¼Œè°ƒç”¨FnOnceçš„call_onceæ–¹æ³•ä¼šå–å¾—é—­åŒ…çš„æ‰€æœ‰æƒã€‚å› æ­¤å¯¹äºé—­åŒ…cå’Œc1æ¥è¯´ï¼Œå³ä½¿åœ¨å£°æ˜æ—¶ä¸ä½¿ç”¨mutå…³é”®å­—ï¼Œä¹Ÿå¯ä»¥åœ¨å…¶call_onceæ–¹æ³•ä¸­ä½¿ç”¨æ‰€æ•è·çš„å˜é‡çš„å¯å˜å€Ÿç”¨ã€‚<br><br>3.<br>impl&lt;F&gt; Executor for F<br>where<br>    F: Fn(&amp;str) -&gt; Result&lt;String, &amp;&#39;static str&gt;,<br>{<br>    fn execute(&amp;self, cmd: &amp;str) -&gt; Result&lt;String, &amp;&#39;static str&gt; {<br>        self(cmd)<br>    }<br>}","like_count":22,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527802,"discussion_content":"èµï¼éå¸¸å¥½ï¼\n\n","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1633813535,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":314877,"user_name":"f","can_delete":false,"product_type":"c1","uid":2741015,"ip_address":"","ucode":"D37A8E76DB782C","user_header":"https://static001.geekbang.org/account/avatar/00/29/d3/17/22c36063.jpg","comment_is_top":false,"comment_ctime":1633524226,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"70353000962","product_id":100085301,"comment_content":"å‘ç°äº†è€å¸ˆæ–‡ä¸­çš„ä¸€ä¸ªé”™è¯¯ç»“è®ºã€‚å½“é—­åŒ…ä¸ä½¿ç”¨moveæ—¶ï¼Œæ˜¯æ¨æ–­ç€åˆ¤æ–­å¦‚ä½•å»æ•è·å˜é‡çš„ï¼Œå…ˆå°è¯•ä¸å¯å˜å¼•ç”¨ï¼Œç„¶åå°è¯•å¯å˜å¼•ç”¨ï¼Œæœ€åå°è¯•Move&#47;Copyï¼Œä¸€æ—¦å°è¯•æˆåŠŸï¼Œå°†ä¸å†å°è¯•ã€‚å½“ä½¿ç”¨moveæ—¶ï¼Œæ˜¯å¼ºåˆ¶Move&#47;Copyï¼Œè€Œä¸æ˜¯ä¸€æ­¥ä¸€æ­¥åœ°å»æ¨æ–­å°è¯•ã€‚<br><br>åœ¨the rust reference: https:&#47;&#47;doc.rust-lang.org&#47;reference&#47;expressions&#47;closure-expr.htmlé‡Œæœ‰è¯´æ˜ï¼š<br>```<br>Without the move keyword, the closure expression infers how it captures each variable from its environment, preferring to capture by shared reference, effectively borrowing all outer variables mentioned inside the closure&#39;s body. If needed the compiler will infer that instead mutable references should be taken, or that the values should be moved or copied (depending on their type) from the environment. A closure can be forced to capture its environment by copying or moving values by prefixing it with the move keyword. This is often used to ensure that the closure&#39;s lifetime is &#39;static.<br>```<br>ä»£ç éªŒè¯ï¼š<br>```rust<br>fn main() {<br>    let mut name = String::from(&quot;hello&quot;);<br><br>    &#47;&#47; 1.ä¸å¯å˜å¼•ç”¨ï¼Œ&amp;nameè¢«å­˜å‚¨åœ¨é—­åŒ…c1é‡Œ<br>    let c1 = || &amp;name;<br>    &#47;&#47; å¯ä½¿ç”¨æ‰€æœ‰è€…å˜é‡nameï¼Œä¸”å¯å¤šæ¬¡è°ƒç”¨é—­åŒ…<br>    println!(&quot;{}, {:?}, {:?}&quot;, name, c1(), c1());<br><br>    &#47;&#47; 2.å¯å˜å¼•ç”¨ï¼Œ&amp;mut nameè¢«å­˜å‚¨åœ¨é—­åŒ…c2é‡Œï¼Œè°ƒç”¨c2çš„æ—¶å€™è¦ä¿®æ”¹è¿™ä¸ªå­—æ®µï¼Œ<br>    &#47;&#47; å› æ­¤c2ä¹Ÿè¦è®¾ç½®ä¸ºmut c2<br>    let mut c2 = || {<br>        name.push_str(&quot; world &quot;);<br>    };<br>    &#47;&#47; å¯å¤šæ¬¡è°ƒç”¨c2é—­åŒ…<br>    &#47;&#47; ä½†ä¸èƒ½è°ƒç”¨c2ä¹‹å‰å†ä½¿ç”¨nameæˆ–å¼•ç”¨nameï¼Œå› ä¸º&amp;mut nameå·²ç»å­˜å…¥c2é‡Œäº†<br>    &#47;&#47; println!(&quot;{}&quot;, name);  &#47;&#47; å–æ¶ˆæ³¨é‡Šå°†æŠ¥é”™<br>    &#47;&#47; println!(&quot;{}&quot;, &amp;name); &#47;&#47; å–æ¶ˆæ³¨é‡Šå°†æŠ¥é”™<br>    c2();<br>    c2();<br><br>    &#47;&#47; 3.Move&#47;Copyï¼Œå°†nameç§»å…¥åˆ°é—­åŒ…c3ä¸­<br>    let c3 = || {<br>        let x = name;<br>        &#47;&#47; let y = name;  &#47;&#47; å–æ¶ˆæ³¨é‡Šè§æŠ¥é”™ï¼Œuse of moved value<br>    };<br>    &#47;&#47; println!(&quot;{}&quot;, name);  &#47;&#47;å–æ¶ˆæ³¨é‡Šå°†æŠ¥é”™<br>}<br>```<br><br>","like_count":17,"discussions":[{"author":{"id":1046714,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f8/ba/14e05601.jpg","nickname":"çº¦ä¹¦äºš","note":"","ucode":"81EA27ADD9EC1A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":582019,"discussion_content":"å°è±¡é‡Œæœ‰äº›æƒ…å†µç¼–è¯‘å™¨ä¼šæç¤ºåŠ ä¸Šmoveå…³é”®å­—ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆã€‚ä»æ–‡æ¡£å’Œä»£ç æ¥çœ‹ï¼Œç¼–è¯‘å™¨ä¼šè‡ªå·±åˆ¤æ–­ï¼Œä»€ä¹ˆæ—¶å€™éœ€è¦å¼ºåˆ¶è¿›è¡Œmoveå‘¢?","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659139005,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"åŒ—äº¬"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":345265,"user_name":"flyflypeng","can_delete":false,"product_type":"c1","uid":1224113,"ip_address":"","ucode":"7A40FC08D8ACC0","user_header":"https://static001.geekbang.org/account/avatar/00/12/ad/b1/2e96794c.jpg","comment_is_top":false,"comment_ctime":1652163735,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"14537065623","product_id":100085301,"comment_content":"æœ‰ä¸ªç–‘é—®ï¼Œé—­åŒ…ä¸­æ•è·çš„ä¸Šä¸‹æ–‡å˜é‡æ˜¯è¢«å­˜å‚¨åœ¨æ ˆä¸­ï¼Œé‚£ä¹ˆé—­åŒ…ä¸­çš„ä»£ç å—ç¼–è¯‘åæ˜¯å­˜æ”¾åœ¨å“ªé‡Œï¼Ÿé€šè¿‡ä»€ä¹ˆæ–¹å¼æŒ‡å‘è¿™å—ä»£ç åŒºåŸŸå‘¢ï¼Ÿ","like_count":4},{"had_liked":false,"id":314858,"user_name":"ç½—æ°","can_delete":false,"product_type":"c1","uid":1320487,"ip_address":"","ucode":"96BAFAA147341F","user_header":"https://static001.geekbang.org/account/avatar/00/14/26/27/eba94899.jpg","comment_is_top":false,"comment_ctime":1633508011,"is_pvip":false,"replies":[{"id":"114170","content":":)","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1633813416,"ip_address":"","comment_id":314858,"utype":1}],"discussion_count":1,"race_medal":2,"score":"14518409899","product_id":100085301,"comment_content":"Rust é—­åŒ…ï¼Œçœ‹è¿™ä¸€ç¯‡çœŸçš„å°±å¤Ÿäº†","like_count":4,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527814,"discussion_content":":)","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633813416,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":317821,"user_name":"InfoQ_31da8ff7fcb1","can_delete":false,"product_type":"c1","uid":1485279,"ip_address":"","ucode":"AEF58B6E4F9E59","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIzVGyhMctYa2jumzLicZVLia0UCTqrWfiaY8pY4c3AbGH2tH5TxONcbicoXGdE3ia43TpXxbZWPZoS6Jg/132","comment_is_top":false,"comment_ctime":1634980960,"is_pvip":false,"replies":[{"id":"115227","content":"fn  å’Œ Fn &#47; FnMut &#47; FnOnce ä¸æ˜¯ä¸€å›äº‹ï¼Œfn æ˜¯ä¸€ä¸ª function pointerï¼Œä¸æ˜¯é—­åŒ…","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1635121326,"ip_address":"","comment_id":317821,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5929948256","product_id":100085301,"comment_content":"å…³äºç¬¬ä¸‰é¢˜æœ‰ä¸ªé—®é¢˜ï¼Œå¦‚æœæˆ‘æŠŠ<br>impl&lt;F&gt; Executor for F<br>where<br>    F: Fn(&amp;str) -&gt; Result&lt;String, &amp;&#39;static str&gt;<br>å†™æˆï¼š<br>impl Executor for fn(&amp;str) -&gt; Result&lt;String, &amp;&#39;static str&gt; <br><br>ä¼šæŠ¥é”™ï¼š<br>the trait `Executor` is not implemented for<br>åº”è¯¥æ˜¯æ²¡å¯¹é—­åŒ…å®ç°Executorè¿™ä¸ªtrait<br><br>é‚£æˆ‘çš„é‚£ä¸ªå£°æ˜æ˜¯ç»™å“ªä¸ªè°å®ç°äº†Executorè¿™ä¸ªtraitäº†å‘¢ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":528990,"discussion_content":"fn  å’Œ Fn / FnMut / FnOnce ä¸æ˜¯ä¸€å›äº‹ï¼Œfn æ˜¯ä¸€ä¸ª function pointerï¼Œä¸æ˜¯é—­åŒ…","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635121326,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1042983,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/27/a3737d61.jpg","nickname":"Shanks-ç‹å†²","note":"","ucode":"C4B90A17850E20","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":584076,"discussion_content":"ä½ æ˜¯å†™å¿«äº†å˜›ï¼ŒæŠŠ Fn å†™æˆäº† fnï¼Œè€å¸ˆç›´æ¥ç†è§£äº†å‘¢ï¼Ÿæˆ‘ä¹Ÿç›´æ¥ impl Executor for Fn... æŠ¥é”™äº†ï¼Œæ”¹æˆ impl&lt;F&gt; ... å°±æ²¡é—®é¢˜","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660621416,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å¹¿ä¸œ"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":343048,"user_name":"CyNevis","can_delete":false,"product_type":"c1","uid":2271650,"ip_address":"","ucode":"0BF0B6F8D540EB","user_header":"","comment_is_top":false,"comment_ctime":1650609521,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1650609521","product_id":100085301,"comment_content":"&#47;&#47; ä¸ºFnå®ç°Executor trait<br>    impl &lt;F&gt; Executor for F<br>    where<br>        F: Fn(&amp;str) -&gt; Result&lt;String, &amp;&#39;static str&gt;<br>    {<br>        fn execute(&amp;self, cmd: &amp;str) -&gt; Result&lt;String, &amp;&#39;static str&gt; {<br>            self(cmd)<br>        }<br>    }","like_count":0},{"had_liked":false,"id":341857,"user_name":"å°å¥¶ç²¾","can_delete":false,"product_type":"c1","uid":2412264,"ip_address":"","ucode":"EB264B3ADC20AE","user_header":"https://static001.geekbang.org/account/avatar/00/24/ce/e8/8b3126d0.jpg","comment_is_top":false,"comment_ctime":1649863789,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1649863789","product_id":100085301,"comment_content":"è€å¸ˆï¼Œæ„Ÿè§‰rusté—­åŒ…ä¸C#çš„å§”æ‰˜ï¼Œlambdaè¡¨è¾¾å¼å¼‚æ›²åŒå·¥å‘¢","like_count":0},{"had_liked":false,"id":336956,"user_name":"sea","can_delete":false,"product_type":"c1","uid":1220057,"ip_address":"","ucode":"F420664683697E","user_header":"","comment_is_top":false,"comment_ctime":1646489931,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1646489931","product_id":100085301,"comment_content":"impl&lt;F&gt; Executor for F<br>where<br>    F: Fn(&amp;str) -&gt; Result&lt;String, &amp;&#39;static str&gt;<br>{<br>    fn execute(&amp;self, cmd: &amp;str) -&gt; Result&lt;String, &amp;&#39;static str&gt; {<br>        self(cmd)<br>    }<br>}","like_count":0},{"had_liked":false,"id":332349,"user_name":"è…¾è¾¾","can_delete":false,"product_type":"c1","uid":1079876,"ip_address":"","ucode":"72F9CFBA44FDEE","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTL9hlAIKQ1sGDu16oWLOHyCSicr18XibygQSMLMjuDvKk73deDlH9aMphFsj41WYJh121aniaqBLiaMNg/132","comment_is_top":false,"comment_ctime":1643184635,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1643184635","product_id":100085301,"comment_content":"`move |y| x * y` è¿™é‡Œèƒ½ä¸èƒ½å†å¤šè§£é‡Šä¸€ä¸‹ï¼Ÿ æˆ‘ä¸€å¼€å§‹æ²¡æœ‰ åŠ  Copy çº¦æŸ å’Œ move å‡ºç°ç¼–è¯‘é”™è¯¯ï¼Œä¸€æ­¥æ­¥æŠŠè¿™2ä¸ªåŠ ä¸Šï¼Œçœ‹æ¯ä¸€æ­¥çš„ç¼–è¯‘é”™è¯¯ï¼Œæœ€åä¸€ç‚¹ä¸æ˜¯ç‰¹åˆ«æ˜ç™½ï¼ŒCopyåŠ ä¸Šäº†ï¼Œä¸ºä»€ä¹ˆè¿˜è¦åŠ  moveï¼Ÿ ä¸åŠ  moveï¼Œç¼–è¯‘å™¨æŠ¥ï¼šthe parameter type `T` may not live long enoughï¼Œhelp: consider adding an explicit lifetime bound `T: &#39;static`...","like_count":0},{"had_liked":false,"id":321067,"user_name":"TheLudlows","can_delete":false,"product_type":"c1","uid":1069346,"ip_address":"","ucode":"64895727505014","user_header":"https://static001.geekbang.org/account/avatar/00/10/51/22/d12f7a72.jpg","comment_is_top":false,"comment_ctime":1636644087,"is_pvip":false,"replies":[{"id":"118938","content":"è°¢è°¢ï¼","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1079375","ctime":1639853883,"ip_address":"","comment_id":321067,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1636644087","product_id":100085301,"comment_content":"æ€è·¯æ¸…æ™°ï¼Œæ·±å…¥æµ…å‡ºï¼Œä½©æœé™ˆå¤©è€å¸ˆğŸ‘","like_count":1,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539899,"discussion_content":"è°¢è°¢ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639853883,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":319835,"user_name":"Geek_b52974","can_delete":false,"product_type":"c1","uid":1298252,"ip_address":"","ucode":"59884399646620","user_header":"","comment_is_top":false,"comment_ctime":1635956535,"is_pvip":true,"replies":[{"id":"116395","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1636556936,"ip_address":"","comment_id":319835,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1635956535","product_id":100085301,"comment_content":"1. 56<br>2. å‚³å…¥ FnOnce çš„æ™‚å€™æ˜¯åŸ·è¡Œ fn call_once(self, args: Args) -&gt; Self::Output; æ˜¯å‚³å…¥ self, è€Œé &amp;mut self æ‰€ä»¥ä¸éœ€è¦ mut é—œéµå­—<br>3. <br>impl&lt;F&gt; Executor for F where <br>    F: Fn(&amp;str) -&gt; Result&lt;String, &amp;&#39;static str&gt;,<br>{<br>    fn execute(&amp;self, cmd: &amp;str) -&gt; Result&lt;String, &amp;&#39;static str&gt; {<br>        self(cmd)<br>    }<br>}<br>","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":529786,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1636556936,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":315835,"user_name":"Marvichov","can_delete":false,"product_type":"c1","uid":1111835,"ip_address":"","ucode":"7482099415C41C","user_header":"https://static001.geekbang.org/account/avatar/00/10/f7/1b/db7a0edc.jpg","comment_is_top":false,"comment_ctime":1634015982,"is_pvip":false,"replies":[{"id":"115287","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1635132585,"ip_address":"","comment_id":315835,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1634015982","product_id":100085301,"comment_content":"ä¸¤ç‚¹æ€è€ƒ, è¯·è€å¸ˆæŒ‡æ­£<br><br>1. std::functionå¯èƒ½ç±»ä¼¼äºdyn Fn()ä¹‹ç±»çš„trait object...å¯èƒ½ä¼šæ¶‰åŠåˆ°é¢å¤–çš„vtable (http:&#47;&#47;www.elbeno.com&#47;blog&#47;?p=1068 æåˆ°çš„optimizationä¹Ÿå¯èƒ½ä¼˜åŒ–æ‰vtable);<br><br>ä¸è¿‡é‡ç‚¹æ˜¯rustçš„trait objectå¯ä»¥è¢«lifetime é™åˆ¶. è€Œcppä¸è¡Œ, æ‰€ä»¥std::functionéœ€è¦åœ¨heapä¸Šå¾—åˆ°ä¸€ä¸ªpointeråštype erasure<br><br>2. ä¾‹å­ä¸­&amp;mainçš„sizeæ˜¯0...ä»Cppè¿‡æ¥çš„äººè¡¨ç¤ºå¾ˆå¥‡æ€ª...æŸ¥äº†ä¸€ä¸‹:<br><br>mainä¸æ˜¯function pointer; è€Œæ˜¯å’Œclosureæœ‰ç‚¹ç›¸ä¼¼çš„function itemçš„instance (ç±»ä¼¼äºä¸€ä¸ªzero sized struct, ä¸è¿‡åŒ…å«äº†function name, args, lifetimes)<br><br>```<br>    &#47;&#47; found `fn() {main}` -&gt; closure has unique id, so does main<br>    &#47;&#47; it also has a struct for it<br>    &#47;&#47; https:&#47;&#47;github.com&#47;rust-lang&#47;rust&#47;issues&#47;62440<br>    &#47;&#47; size_of_val(main),<br>    size_of_val(&amp;main),<br>```<br><br>https:&#47;&#47;github.com&#47;rust-lang&#47;rust&#47;issues&#47;62440<br><br>&gt; This is the compiler&#39;s way of representing the unique zero sized type that corresponds to the function.<br>&gt; <br>&gt; This is akin to how closures also create a unique type (but in that case, the size may be &gt;= 0 depending on the captured environment).<br><br>function iteméœ€è¦è¢«æ˜¾å¼coerceåˆ°function pointer (https:&#47;&#47;doc.rust-lang.org&#47;nightly&#47;reference&#47;types&#47;function-item.html)<br>","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":528179,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635132585,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":314975,"user_name":"linuxfish","can_delete":false,"product_type":"c1","uid":1078927,"ip_address":"","ucode":"557F21A1CC7EAD","user_header":"","comment_is_top":false,"comment_ctime":1633619373,"is_pvip":false,"replies":[{"id":"114164","content":"è¿™æ˜¯å› ä¸ºä½ ä¼ äº†å¼•ç”¨å•Šï¼Œè¿™å°±ä¸æ˜¯ä»¥ FnOnce æ¥ä½¿ç”¨ï¼Œè€Œæ˜¯ä»¥ Fn æ¥ä½¿ç”¨ï¼ˆFn å®ç°äº† FnOnce æ‰€ä»¥ call_once å‡½æ•°ä¾æ—§å¯ä»¥å·¥ä½œï¼‰ã€‚åœ¨æˆ‘çš„å®ä¾‹ä»£ç ä¸­ c æœ¬èº«æ˜¯ä¸€ä¸ª Fnã€‚ä½ å¯ä»¥æŠŠ name.clone() é‚£ä¸ª clone() å»æ‰ï¼Œä½¿å…¶æˆä¸º FnOnceï¼Œå°±ä¼šå‘ç°å¦‚æœä½ ç”¨ &amp;c æ¥è°ƒç”¨ä¼šå‘ç”Ÿç¼–è¯‘é”™è¯¯ï¼š<br><br>https:&#47;&#47;play.rust-lang.org&#47;?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=ddaea49ed76de9c9dd856a4c7bcebfe3<br>","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1633813120,"ip_address":"","comment_id":314975,"utype":1}],"discussion_count":4,"race_medal":0,"score":"1633619373","product_id":100085301,"comment_content":"â€œç„¶è€Œï¼Œä¸€æ—¦å®ƒè¢«å½“åš FnOnce è°ƒç”¨ï¼Œè‡ªå·±ä¼šè¢«è½¬ç§»åˆ° call_once å‡½æ•°çš„ä½œç”¨åŸŸä¸­ï¼Œä¹‹åå°±æ— æ³•å†æ¬¡è°ƒç”¨äº†â€<br><br>è€å¸ˆï¼Œå®é™…è°ƒè¯•äº†ä¸€ä¸‹ä½ çš„ä»£ç ï¼Œå‘ç°åªè¦åœ¨`call_once`ä¸­ä¼ å…¥é—­åŒ…çš„å¼•ç”¨ï¼Œåç»­æ˜¯å¯ä»¥ç»§ç»­ä½¿ç”¨é—­åŒ…çš„ï¼Œå…·ä½“è¯·çœ‹ï¼š<br><br>https:&#47;&#47;play.rust-lang.org&#47;?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=27cd35717d166f01a4045846721cf989","like_count":1,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527846,"discussion_content":"è¿™æ˜¯å› ä¸ºä½ ä¼ äº†å¼•ç”¨å•Šï¼Œè¿™å°±ä¸æ˜¯ä»¥ FnOnce æ¥ä½¿ç”¨ï¼Œè€Œæ˜¯ä»¥ Fn æ¥ä½¿ç”¨ï¼ˆFn å®ç°äº† FnOnce æ‰€ä»¥ call_once å‡½æ•°ä¾æ—§å¯ä»¥å·¥ä½œï¼‰ã€‚åœ¨æˆ‘çš„å®ä¾‹ä»£ç ä¸­ c æœ¬èº«æ˜¯ä¸€ä¸ª Fnã€‚ä½ å¯ä»¥æŠŠ name.clone() é‚£ä¸ª clone() å»æ‰ï¼Œä½¿å…¶æˆä¸º FnOnceï¼Œå°±ä¼šå‘ç°å¦‚æœä½ ç”¨ &amp;amp;c æ¥è°ƒç”¨ä¼šå‘ç”Ÿç¼–è¯‘é”™è¯¯ï¼š\n\nhttps://play.rust-lang.org/?version=stable&amp;amp;mode=debug&amp;amp;edition=2018&amp;amp;gist=ddaea49ed76de9c9dd856a4c7bcebfe3\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633813120,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2186992,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5e/f0/62d8cf9e.jpg","nickname":"D. D","note":"","ucode":"C416E5602C8814","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":401547,"discussion_content":"é—­åŒ…cå®ç°äº†Fnï¼Œæ‰€ä»¥åœ¨call_onceä¸­ä¼ å…¥é—­åŒ…çš„å¼•ç”¨åï¼Œåœ¨mainä¸­ä¾ç„¶å¯ä»¥ä½¿ç”¨ã€‚\nè€å¸ˆçš„ä¾‹å­ç¡®å®æœ‰ç‚¹é—®é¢˜ï¼Œå› ä¸ºcåœ¨call_onceåä¸èƒ½ä½¿ç”¨çš„åŸå› æ˜¯cçš„æ‰€æœ‰æƒè¢«ç§»åŠ¨åˆ°äº†call_onceä¸­ï¼Œå¹¶ä¸æ˜¯è¢«å½“ä½œFnOnceè°ƒç”¨ã€‚\nä½ å¯ä»¥åœ¨call_onceå‡½æ•°å†…éƒ¨è¿›è¡Œå¤šæ¬¡è°ƒç”¨è¯•è¯•çœ‹ã€‚\n\nhttps://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=55a9ea67a75c9a948301b491ad250a02\n","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1633690585,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1079876,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTL9hlAIKQ1sGDu16oWLOHyCSicr18XibygQSMLMjuDvKk73deDlH9aMphFsj41WYJh121aniaqBLiaMNg/132","nickname":"è…¾è¾¾","note":"","ucode":"72F9CFBA44FDEE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":548408,"discussion_content":"è¿™å°±ä¸æ˜¯ä»¥ FnOnce æ¥ä½¿ç”¨ï¼Œè€Œæ˜¯ä»¥ Fn æ¥ä½¿ç”¨ï¼ˆFn å®ç°äº† FnOnce æ‰€ä»¥ call_once å‡½æ•°ä¾æ—§å¯ä»¥å·¥ä½œï¼‰----å½“ç”¨çˆ¶é‡Œçš„call_onceæ¥æ‰§è¡Œçš„æ—¶å€™ï¼Œå®ƒçš„æ‰€æœ‰æƒä¼šè¢«çˆ¶é‡Œçš„call_onceæ‹¿åˆ°å—ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1643185885,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1133945,"avatar":"https://static001.geekbang.org/account/avatar/00/11/4d/79/803537db.jpg","nickname":"æ…¢åŠ¨ä½œ","note":"","ucode":"62C944F4A4D8AC","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":401863,"discussion_content":"ä¼ &amp;cï¼Œcæ²¡è¢«è½¬ç§»ï¼Œ&amp;cä½œä¸ºFnOnceè°ƒç”¨ï¼ˆä¸çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿï¼‰ï¼Œæ˜¾ç„¶cä¹Ÿæ²¡è½¬ç§»ï¼Œé‚£cå½“ç„¶è¿˜èƒ½ä½¿ç”¨ã€‚FnOnceæ‰ä¼šé»˜è®¤è°ƒç”¨call_onceï¼ŒFnMuté»˜è®¤è°ƒç”¨call_mut","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633752571,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":314864,"user_name":"äºšä¼¦ç¢è¯­","can_delete":false,"product_type":"c1","uid":1014505,"ip_address":"","ucode":"F32E5E1B63CC90","user_header":"https://static001.geekbang.org/account/avatar/00/0f/7a/e9/da5c0203.jpg","comment_is_top":false,"comment_ctime":1633510844,"is_pvip":false,"replies":[{"id":"114169","content":"ğŸ‘ éå¸¸å¥½","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1633813410,"ip_address":"","comment_id":314864,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1633510844","product_id":100085301,"comment_content":"<br>pub trait Executor {<br>    fn execute(&amp;self, cmd: &amp;str) -&gt; Result&lt;String, &amp;&#39;static str&gt;;<br>}<br><br>struct BashExecutor {<br>    env: String,<br>}<br><br>impl&lt;F&gt; Executor for F<br>where<br>    F: Fn(&amp;str) -&gt; Result&lt;String, &amp;&#39;static str&gt;,<br>{<br>    fn execute(&amp;self, cmd: &amp;str) -&gt; Result&lt;String, &amp;&#39;static str&gt; {<br>        self(cmd)<br>    }<br>}<br><br>impl Executor for BashExecutor {<br>    fn execute(&amp;self, cmd: &amp;str) -&gt; Result&lt;String, &amp;&#39;static str&gt; {<br>        Ok(format!(<br>            &quot;fake bash execute: env: {}, cmd: {}&quot;,<br>            self.env, cmd<br>        ))<br>    }<br>}<br><br>&#47;&#47; çœ‹çœ‹æˆ‘ç»™çš„ tonic çš„ä¾‹å­ï¼Œæƒ³æƒ³æ€ä¹ˆå®ç°è®© 27 è¡Œå¯ä»¥æ­£å¸¸æ‰§è¡Œ<br><br>fn main() {<br>    let env = &quot;PATH=&#47;usr&#47;bin&quot;.to_string();<br><br>    let cmd = &quot;cat &#47;etc&#47;passwd&quot;;<br>    let r1 = execute(cmd, BashExecutor { env: env.clone() });<br>    println!(&quot;{:?}&quot;, r1);<br><br>    let r2 = execute(cmd, |cmd: &amp;str| {<br>        Ok(format!(&quot;fake fish execute: env: {}, cmd: {}&quot;, env, cmd))<br>    });<br>    println!(&quot;{:?}&quot;, r2);<br>}<br><br>fn execute(cmd: &amp;str, exec: impl Executor) -&gt; Result&lt;String, &amp;&#39;static str&gt; {<br>    exec.execute(cmd)<br>}","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527818,"discussion_content":"ğŸ‘ éå¸¸å¥½","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633813410,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":314831,"user_name":"è®°äº‹æœ¬","can_delete":false,"product_type":"c1","uid":1401568,"ip_address":"","ucode":"FA942636EE0CC8","user_header":"https://static001.geekbang.org/account/avatar/00/15/62/e0/d2ff52da.jpg","comment_is_top":false,"comment_ctime":1633490220,"is_pvip":false,"replies":[{"id":"114171","content":"ğŸ‘éå¸¸å¥½ï¼","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1633813435,"ip_address":"","comment_id":314831,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1633490220","product_id":100085301,"comment_content":"1ã€ä¸èƒ½è®¿é—®ï¼Œnameå˜é‡çš„æ‰€æœ‰æƒå·²ç»è¢«ç§»åŠ¨é—­åŒ…é‡Œé¢å»äº†ï¼Œmoveå¼ºåˆ¶å¯¼è‡´çš„<br>3ã€pub trait Executor{<br>    fn execute(&amp;self,cmd:&amp;str) -&gt;Result&lt;String,&amp;&#39;static str&gt;;<br>}<br><br>struct BashExecutor{<br>    env:String<br>}<br><br>impl Executor for BashExecutor{<br>    fn execute(&amp;self, cmd:&amp;str) -&gt;Result&lt;String,&amp;&#39;static str&gt; {<br>       Ok(format!(<br>            &quot;fake bash execute:env:{},cmd :{}&quot;,self.env,cmd<br>       )) <br>    }<br>}<br><br>impl &lt;F&gt; Executor for F <br>where F:Fn(&amp;str) -&gt;Result&lt;String,&amp;&#39;static str&gt;<br>{<br><br>    fn execute(&amp;self, cmd:&amp;str) -&gt;Result&lt;String,&amp;&#39;static str&gt; {<br>        self(cmd)<br>    }<br>    <br>}<br><br><br>fn execute(cmd:&amp;str,exec:impl Executor) -&gt; Result&lt;String,&amp;&#39;static str&gt;{<br>    exec.execute(cmd)<br>}<br><br>pub fn test(){<br>    let env = &quot;PATH=&#47;usr&#47;bin&quot;.to_string();<br><br>    let cmd = &quot;cat &#47;etc&#47;passwd&quot;;<br><br>    let r1 = execute(cmd, BashExecutor{env:env.clone()});<br>    println!(&quot;{:?}&quot;,r1);<br><br><br>    let r2 = execute(cmd, |cmd :&amp;str|{<br>        Ok(format!(&quot;fake fish execute: env: {}, cmd: {}&quot;, env, cmd))<br>    });<br>    println!(&quot;{:?}&quot;,r2);<br><br>}<br>","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527805,"discussion_content":"ğŸ‘éå¸¸å¥½ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633813435,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1141192,"avatar":"https://static001.geekbang.org/account/avatar/00/11/69/c8/d6f00a46.jpg","nickname":"wowotuo","note":"","ucode":"D87BCBD3EA61A9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":537642,"discussion_content":"é—­åŒ…çš„æ•°æ®éƒ½åœ¨æ ˆä¸Šï¼Œé‚£ä¹ˆ\nfn main() {\n    let mut vec = vec![&#34;Rust&#34;, &#34;Elixir&#34;, &#34;Javascript&#34;];\n    let mut c = move || {\n        vec.push(&#34;julia&#34;); \n        println!(&#34;v: {:?}&#34;, vec);\n    };\n    c();\n}\né—­åŒ…æ•è·vecåï¼Œvecä¹Ÿå­˜æ”¾åœ¨æ ˆä¸Šï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639127575,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}