{"id":7509,"title":"21 | 【实验】OAuth2安全风险CSRF实验","content":"无","comments":[{"had_liked":false,"id":90563,"user_name":"大鹏","can_delete":false,"product_type":"c3","uid":1270632,"ip_address":"","ucode":"F4611B80B08A3A","user_header":"https://static001.geekbang.org/account/avatar/00/13/63/68/14b98bbc.jpg","comment_is_top":false,"comment_ctime":1556578285,"is_pvip":false,"replies":[{"id":32583,"content":"你好，细节可以参考：\n1. 课程ppt的63页的CSRF交互流程图，https:&#47;&#47;github.com&#47;spring2go&#47;oauth2lab&#47;tree&#47;master&#47;ppt\n2. RFC6749的10.12的Cross-Site Request Forgery，https:&#47;&#47;tools.ietf.org&#47;html&#47;rfc6749\n\n这个案例演示授权请求时候，如果不使用state参数，那么可能被黑客利用，简化步骤（假定黑客和普通用户都是某个客户应用Web App的用户）：\n1，黑客去授权服务器登录，授权并获取授权码，\n2，黑客使用工具截获跳转请求和授权码（本来这个请求会发到客户应用Client App，然后客户应用再去授权服务器换令牌），\n3，黑客伪造带授权码（和黑客账户绑定）的URL，并通过手段诱使普通用户点击这个URL\n4，普通用户点击这个URL（相当于跳转到客户应用Client App，接续之前黑客发起的令牌请求），获取了令牌（假定授权码还没有过期），但是这个令牌其实和黑客账户关联\n5，普通用户操作了受保护的资源，例如保存了自己的银行账户信息，但其实这个账户信息可以被黑客看见，因为操作受保护资源使用了黑客的令牌，相关资源也和黑客关联。\n\n如果使用state，这个state就和用户的认证状态关联，有唯一性，时效性，且只能使用一次。如果使用了Spring Security OAuth2开发的客户应用Web App，它就支持state校验和传递，黑客使用的state只和黑客认证关联，他无法伪造和普通用户认证相关联的state。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1556715800,"ip_address":"","comment_id":90563,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"老师，通过切换客户劫持token这个地方没明白，能详细解释下吗","like_count":3,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":448569,"discussion_content":"你好，细节可以参考：\n1. 课程ppt的63页的CSRF交互流程图，https://github.com/spring2go/oauth2lab/tree/master/ppt\n2. RFC6749的10.12的Cross-Site Request Forgery，https://tools.ietf.org/html/rfc6749\n\n这个案例演示授权请求时候，如果不使用state参数，那么可能被黑客利用，简化步骤（假定黑客和普通用户都是某个客户应用Web App的用户）：\n1，黑客去授权服务器登录，授权并获取授权码，\n2，黑客使用工具截获跳转请求和授权码（本来这个请求会发到客户应用Client App，然后客户应用再去授权服务器换令牌），\n3，黑客伪造带授权码（和黑客账户绑定）的URL，并通过手段诱使普通用户点击这个URL\n4，普通用户点击这个URL（相当于跳转到客户应用Client App，接续之前黑客发起的令牌请求），获取了令牌（假定授权码还没有过期），但是这个令牌其实和黑客账户关联\n5，普通用户操作了受保护的资源，例如保存了自己的银行账户信息，但其实这个账户信息可以被黑客看见，因为操作受保护资源使用了黑客的令牌，相关资源也和黑客关联。\n\n如果使用state，这个state就和用户的认证状态关联，有唯一性，时效性，且只能使用一次。如果使用了Spring Security OAuth2开发的客户应用Web App，它就支持state校验和传递，黑客使用的state只和黑客认证关联，他无法伪造和普通用户认证相关联的state。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1556715800,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2839820,"avatar":"","nickname":"Geek_b3827d","note":"","ucode":"B3870BB7F544EF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":413291,"discussion_content":"根据攻击流程，普通用户没有登录之前，如何获取一个跟用户的认证状态关联的state？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1636439470,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":55583,"user_name":"swortect","can_delete":false,"product_type":"c3","uid":1288071,"ip_address":"","ucode":"A8C294E590C1B6","user_header":"https://static001.geekbang.org/account/avatar/00/13/a7/87/4f2fa359.jpg","comment_is_top":false,"comment_ctime":1546236713,"is_pvip":false,"replies":[{"id":20287,"content":"不能写死，客用应用随机生成并记住（关联当前用户会话），再发起授权码请求，响应回来再比对，对得上表示这个响应是针对同一用户的。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1546434469,"ip_address":"","comment_id":55583,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"生产环境state一般都是怎么生成的，有规律么，我们一般是根据场景写死的，这么看其实黑客也拿的到","like_count":2,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434804,"discussion_content":"不能写死，客用应用随机生成并记住（关联当前用户会话），再发起授权码请求，响应回来再比对，对得上表示这个响应是针对同一用户的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546434469,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2230909,"avatar":"https://static001.geekbang.org/account/avatar/00/22/0a/7d/ac715471.jpg","nickname":"独孤九剑","note":"","ucode":"6C1253E2B8C1D4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":374822,"discussion_content":"有点类似TCP连接的三次握手","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621382594,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":95264,"user_name":"follow","can_delete":false,"product_type":"c3","uid":1509136,"ip_address":"","ucode":"5CB49510077AFD","user_header":"https://static001.geekbang.org/account/avatar/00/17/07/10/7ff147b5.jpg","comment_is_top":false,"comment_ctime":1558000998,"is_pvip":false,"replies":[{"id":34040,"content":"黑客的state是和黑客在客户应用(Client App)上的会话Session相绑定的，给正常用户用的话，正常用户在客户应用的Session会和这个state不匹配，会被客户应用拒绝。Spring Security OAuth2开发的客户应用支持state，并且会将state和session绑定和进行校验。参考：https:&#47;&#47;tools.ietf.org&#47;html&#47;rfc6749#section-10.12","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1558010620,"ip_address":"","comment_id":95264,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"波波老师您好，对于例子中state的使用有一点不明白，黑客请求授权码的时候可以带着state，然后伪造的一个同样带state参数的链接给用户点击，这样不是防御无效了吗？","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":450392,"discussion_content":"黑客的state是和黑客在客户应用(Client App)上的会话Session相绑定的，给正常用户用的话，正常用户在客户应用的Session会和这个state不匹配，会被客户应用拒绝。Spring Security OAuth2开发的客户应用支持state，并且会将state和session绑定和进行校验。参考：https://tools.ietf.org/html/rfc6749#section-10.12","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1558010620,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":55581,"user_name":"swortect","can_delete":false,"product_type":"c3","uid":1288071,"ip_address":"","ucode":"A8C294E590C1B6","user_header":"https://static001.geekbang.org/account/avatar/00/13/a7/87/4f2fa359.jpg","comment_is_top":false,"comment_ctime":1546236513,"is_pvip":false,"replies":[{"id":20288,"content":"不一样，state具有4个特性：1.随机不可预测，2.关联当前用户会话，3.每用户每次请求都唯一，4.时效性，一旦被用则立即失效","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1546434830,"ip_address":"","comment_id":55581,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"实际生产环境每个人的state不一样么","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434802,"discussion_content":"不一样，state具有4个特性：1.随机不可预测，2.关联当前用户会话，3.每用户每次请求都唯一，4.时效性，一旦被用则立即失效","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546434830,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":51006,"user_name":"三三","can_delete":false,"product_type":"c3","uid":1054201,"ip_address":"","ucode":"4A76933C29BDA1","user_header":"https://static001.geekbang.org/account/avatar/00/10/15/f9/0b14785a.jpg","comment_is_top":false,"comment_ctime":1545098365,"is_pvip":false,"replies":[{"id":18447,"content":"黑客可以邮件，聊天消息，或伪造站点等形式诱使正常用户点击伪造url，点击后可获取访问令牌（因为有正确授权码），但是这个令牌其实是和黑客关联的，后面如果正常用户做一些交易动作，那么这些动作其实关联到黑客","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1545136434,"ip_address":"","comment_id":51006,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"这一节csrf攻击还是没明白,第一点正常用户输入完用户名密码后为什么能点击到黑客伪造的url,第二点黑客伪造的授权码url访问后会有什么后果","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433226,"discussion_content":"黑客可以邮件，聊天消息，或伪造站点等形式诱使正常用户点击伪造url，点击后可获取访问令牌（因为有正确授权码），但是这个令牌其实是和黑客关联的，后面如果正常用户做一些交易动作，那么这些动作其实关联到黑客","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545136434,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":64229,"user_name":"yien","can_delete":false,"product_type":"c3","uid":1345013,"ip_address":"","ucode":"37CC1AFAC8B0BC","user_header":"https://static001.geekbang.org/account/avatar/00/14/85/f5/10275c0a.jpg","comment_is_top":false,"comment_ctime":1548723465,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"现在才知道state的用法，除了安全认证，还能防止黑客攻击","like_count":0}]}