{"id":624624,"title":"46ï½œMasterä»»åŠ¡è°ƒåº¦ï¼šæœåŠ¡å‘ç°ä¸èµ„æºç®¡ç†","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯éƒ‘å»ºå‹‹ã€‚</p><p>åœ¨ä¸Šä¸€èŠ‚è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬å®ç°äº†Masterçš„é€‰ä¸»ï¼Œè¿™ä¸€èŠ‚è¯¾ï¼Œæˆ‘ä»¬ç»§ç»­æ·±å…¥Masterçš„å¼€å‘ï¼Œå®ç°ä¸€ä¸‹Masterçš„æœåŠ¡å‘ç°ä¸èµ„æºçš„ç®¡ç†ã€‚</p><h2>MasteræœåŠ¡å‘ç°</h2><p>é¦–å…ˆæˆ‘ä»¬æ¥å®ç°ä¸€ä¸‹Masterå¯¹Workerçš„æœåŠ¡å‘ç°ã€‚</p><p>Masteréœ€è¦ç›‘å¬WorkerèŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œæ„ŸçŸ¥åˆ°WorkerèŠ‚ç‚¹çš„æ³¨å†Œä¸é”€æ¯ã€‚å’ŒæœåŠ¡çš„æ³¨å†Œä¸€æ ·ï¼Œæˆ‘ä»¬çš„æœåŠ¡å‘ç°ä¹Ÿä½¿ç”¨microæä¾›çš„registryåŠŸèƒ½ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><p>m.WatchWorkeræ–¹æ³•è°ƒç”¨registry.Watchç›‘å¬WorkerèŠ‚ç‚¹çš„å˜åŒ–ï¼Œwatch.Next()ä¼šå µå¡ç­‰å¾…èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªäº‹ä»¶ï¼Œå½“Masteræ”¶åˆ°èŠ‚ç‚¹å˜åŒ–äº‹ä»¶æ—¶ï¼Œå°†äº‹ä»¶å‘é€åˆ°workerNodeChangeé€šé“ã€‚m.Campaignæ–¹æ³•æ¥æ”¶åˆ°å˜åŒ–äº‹ä»¶åï¼Œä¼šç”¨æ—¥å¿—æ‰“å°å‡ºå˜åŒ–çš„ä¿¡æ¯ã€‚</p><pre><code class=\"language-plain\">\nfunc (m *Master) Campaign() {\n\t...\n\tworkerNodeChange := m.WatchWorker()\n\n\tfor {\n\t\tselect {\n\t\t...\n\t\tcase resp := &lt;-workerNodeChange:\n\t\t\tm.logger.Info(\"watch worker change\", zap.Any(\"worker:\", resp))\n\t\t}\n\t}\n}\n\nfunc (m *Master) WatchWorker() chan *registry.Result {\n\twatch, err := m.registry.Watch(registry.WatchService(worker.ServiceName))\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\tch := make(chan *registry.Result)\n\tgo func() {\n\t\tfor {\n\t\t\tres, err := watch.Next()\n\t\t\tif err != nil {\n\t\t\t\tm.logger.Info(\"watch worker service failed\", zap.Error(err))\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tch &lt;- res\n\t\t}\n\t}()\n\treturn ch\n\n}\n</code></pre><!-- [[[read_end]]] --><p>Masterä¸­çš„etcd registryå¯¹è±¡æ˜¯æˆ‘ä»¬åœ¨åˆå§‹åŒ–æ—¶æ³¨å†Œåˆ°go-microä¸­çš„ã€‚</p><pre><code class=\"language-plain\">// cmd/master/master.go\nreg := etcd.NewRegistry(registry.Addrs(sconfig.RegistryAddress))\nmaster.New(\n\tmasterID,\n\tmaster.WithLogger(logger.Named(\"master\")),\n\tmaster.WithGRPCAddress(GRPCListenAddress),\n\tmaster.WithregistryURL(sconfig.RegistryAddress),\n\tmaster.WithRegistry(reg),\n\tmaster.WithSeeds(seeds),\n)\n</code></pre><h3>æ·±å…¥go-micro registryæ¥å£</h3><p>go-microæä¾›çš„registryæ¥å£æä¾›äº†è¯¸å¤šAPIï¼Œå…¶ç»“æ„å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code class=\"language-plain\">type Registry interface {\n\tInit(...Option) error\n\tOptions() Options\n\tRegister(*Service, ...RegisterOption) error\n\tDeregister(*Service, ...DeregisterOption) error\n\tGetService(string, ...GetOption) ([]*Service, error)\n\tListServices(...ListOption) ([]*Service, error)\n\tWatch(...WatchOption) (Watcher, error)\n\tString() string\n}\n</code></pre><p>å¯¹äºMasterçš„æœåŠ¡å‘ç°ï¼Œæˆ‘ä»¬å€ŸåŠ©äº†registry.Watchæ–¹æ³•ã€‚Watchæ–¹æ³•å€ŸåŠ©client.Watchå®ç°äº†å¯¹ç‰¹å®šKeyçš„ç›‘å¬ï¼Œå¹¶å°è£…äº†client.Watchè¿”å›çš„ç»“æœã€‚</p><pre><code class=\"language-plain\">func (e *etcdRegistry) Watch(opts ...registry.WatchOption) (registry.Watcher, error) {\n   return newEtcdWatcher(e, e.options.Timeout, opts...)\n}\n\nfunc newEtcdWatcher(r *etcdRegistry, timeout time.Duration, opts ...registry.WatchOption) (registry.Watcher, error) {\n   var wo registry.WatchOptions\n   for _, o := range opts {\n      o(&amp;wo)\n   }\n   watchPath := prefix\n   if len(wo.Service) &gt; 0 {\n      watchPath = servicePath(wo.Service) + \"/\"\n   }\n   return &amp;etcdWatcher{\n      stop:    stop,\n      w:       r.client.Watch(ctx, watchPath, clientv3.WithPrefix(), clientv3.WithPrevKV()),\n      client:  r.client,\n      timeout: timeout,\n   }, nil\n}\n</code></pre><p>registry.Watchæ–¹æ³•è¿”å›äº†Watcheræ¥å£ï¼ŒWatcheræ¥å£ä¸­æœ‰Nextæ–¹æ³•ç”¨äºå®Œæˆäº‹ä»¶çš„è¿­ä»£ã€‚</p><pre><code class=\"language-plain\">type Watcher interface {\n   // Next å µå¡è°ƒç”¨\n   Next() (*Result, error)\n   Stop()\n}\n</code></pre><p>go-micro çš„ etcd æ’ä»¶åº“å®ç°çš„ Next æ–¹æ³•ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œåªè¦ç›‘å¬client.Watchè¿”å›çš„é€šé“ï¼Œå¹¶å°†äº‹ä»¶ä¿¡æ¯å°è£…åè¿”å›å³å¯ã€‚</p><pre><code class=\"language-plain\">func (ew *etcdWatcher) Next() (*registry.Result, error) {\n   for wresp := range ew.w {\n      if wresp.Err() != nil {\n         return nil, wresp.Err()\n      }\n      if wresp.Canceled {\n         return nil, errors.New(\"could not get next\")\n      }\n      for _, ev := range wresp.Events {\n         service := decode(ev.Kv.Value)\n         var action string\n         switch ev.Type {\n         case clientv3.EventTypePut:\n            if ev.IsCreate() {\n               action = \"create\"\n            } else if ev.IsModify() {\n               action = \"update\"\n            }\n         case clientv3.EventTypeDelete:\n            action = \"delete\"\n            // get service from prevKv\n            service = decode(ev.PrevKv.Value)\n         }\n         if service == nil {\n            continue\n         }\n         return &amp;registry.Result{\n            Action:  action,\n            Service: service,\n         }, nil\n      }\n   }\n   return nil, errors.New(\"could not get next\")\n}\n</code></pre><p>å¦å¤–ï¼ŒWorkerèŠ‚ç‚¹ä¹Ÿåˆ©ç”¨äº†registryæ¥å£çš„Registeræ–¹æ³•å®ç°äº†æœåŠ¡çš„æ³¨å†Œã€‚å¦‚ä¸‹æ‰€ç¤ºï¼ŒRegisteræ–¹æ³•æœ€ç»ˆè°ƒç”¨äº†clientv3çš„Putæ–¹æ³•ï¼Œå°†åŒ…å«èŠ‚ç‚¹ä¿¡æ¯çš„é”®å€¼å¯¹å†™å…¥äº†etcdä¸­ã€‚</p><pre><code class=\"language-plain\">func (e *etcdRegistry) Register(s *registry.Service, opts ...registry.RegisterOption) error {\n\t// register each node individually\n\tfor _, node := range s.Nodes {\n\t\terr := e.registerNode(s, node, opts...)\n\t\tif err != nil {\n\t\t\tgerr = err\n\t\t}\n\t}\n\treturn gerr\n}\n\nfunc (e *etcdRegistry) registerNode(s *registry.Service, node *registry.Node, opts ...registry.RegisterOption) error {\n\tservice := &amp;registry.Service{\n\t\tName:      s.Name,\n\t\tVersion:   s.Version,\n\t\tMetadata:  s.Metadata,\n\t\tEndpoints: s.Endpoints,\n\t\tNodes:     []*registry.Node{node},\n\t}\n\t...\n\t// create an entry for the node\n\tif lgr != nil {\n\t\t_, err = e.client.Put(ctx, nodePath(service.Name, node.Id), encode(service), clientv3.WithLease(lgr.ID))\n\t} else {\n\t\t_, err = e.client.Put(ctx, nodePath(service.Name, node.Id), encode(service))\n\t}\n\tif err != nil {\n\t\treturn err\n\t}\n}\n</code></pre><p>ç°åœ¨è®©æˆ‘ä»¬æ¥çœ‹ä¸€çœ‹æœåŠ¡å‘ç°çš„æ•ˆæœã€‚é¦–å…ˆï¼Œå¯åŠ¨MasteræœåŠ¡ã€‚</p><pre><code class=\"language-plain\">Â» go run main.go master --id=2 --http=:8081  --grpc=:9091\n</code></pre><p>æ¥ç€å¯åŠ¨WorkeræœåŠ¡ã€‚</p><pre><code class=\"language-plain\">Â» go run main.go worker --id=2 --http=:8079  --grpc=:9089\n</code></pre><p>Workerå¯åŠ¨åï¼Œåœ¨Masterçš„æ—¥å¿—ä¸­ä¼šçœ‹åˆ°å˜åŒ–çš„äº‹ä»¶ã€‚å…¶ä¸­ï¼Œ<code>\"Action\":\"create\"</code> è¡¨æ˜å½“å‰çš„äº‹ä»¶ä¸ºèŠ‚ç‚¹çš„æ³¨å†Œã€‚</p><pre><code class=\"language-plain\">{\"level\":\"INFO\",\"ts\":\"2022-12-12T16:55:42.798+0800\",\"logger\":\"master\",\"caller\":\"master/master.go:117\",\"msg\":\"watch worker change\",\"worker:\":{\"Action\":\"create\",\"Service\":{\"name\":\"go.micro.server.worker\",\"version\":\"latest\",\"metadata\":null,\"endpoints\":[{\"name\":\"Greeter.Hello\",\"request\":{\"name\":\"Request\",\"type\":\"Request\",\"values\":[{\"name\":\"name\",\"type\":\"string\",\"values\":null}]},\"response\":{\"name\":\"Response\",\"type\":\"Response\",\"values\":[{\"name\":\"greeting\",\"type\":\"string\",\"values\":null}]},\"metadata\":{\"endpoint\":\"Greeter.Hello\",\"handler\":\"rpc\",\"method\":\"POST\",\"path\":\"/greeter/hello\"}}],\"nodes\":[{\"id\":\"go.micro.server.worker-2\",\"address\":\"192.168.0.107:9089\",\"metadata\":{\"broker\":\"http\",\"protocol\":\"grpc\",\"registry\":\"etcd\",\"server\":\"grpc\",\"transport\":\"grpc\"}}]}}}\n</code></pre><p>ä¸­æ­¢WorkerèŠ‚ç‚¹åï¼Œæˆ‘ä»¬è¿˜ä¼šçœ‹åˆ°Masterçš„ä¿¡æ¯ã€‚å…¶ä¸­ï¼Œ<code>\"Action\":\"delete\"</code> è¡¨æ˜å½“å‰çš„äº‹ä»¶ä¸ºèŠ‚ç‚¹çš„åˆ é™¤ã€‚</p><pre><code class=\"language-plain\">{\"level\":\"INFO\",\"ts\":\"2022-12-12T16:58:31.985+0800\",\"logger\":\"master\",\"caller\":\"master/master.go:117\",\"msg\":\"watch worker change\",\"worker:\":{\"Action\":\"delete\",\"Service\":{\"name\":\"go.micro.server.worker\",\"version\":\"latest\",\"metadata\":null,\"endpoints\":[{\"name\":\"Greeter.Hello\",\"request\":{\"name\":\"Request\",\"type\":\"Request\",\"values\":[{\"name\":\"name\",\"type\":\"string\",\"values\":null}]},\"response\":{\"name\":\"Response\",\"type\":\"Response\",\"values\":[{\"name\":\"greeting\",\"type\":\"string\",\"values\":null}]},\"metadata\":{\"endpoint\":\"Greeter.Hello\",\"handler\":\"rpc\",\"method\":\"POST\",\"path\":\"/greeter/hello\"}}],\"nodes\":[{\"id\":\"go.micro.server.worker-2\",\"address\":\"192.168.0.107:9089\",\"metadata\":{\"broker\":\"http\",\"protocol\":\"grpc\",\"registry\":\"etcd\",\"server\":\"grpc\",\"transport\":\"grpc\"}}]}}}\n</code></pre><h3>ç»´æŠ¤WorkerèŠ‚ç‚¹ä¿¡æ¯</h3><p>å®ŒæˆæœåŠ¡å‘ç°ä¹‹åï¼Œè®©æˆ‘ä»¬æ›´è¿›ä¸€æ­¥ï¼Œç»´æŠ¤WorkerèŠ‚ç‚¹çš„ä¿¡æ¯ã€‚åœ¨updateWorkNodeså‡½æ•°ä¸­ï¼Œæˆ‘ä»¬åˆ©ç”¨registry.GetServiceæ–¹æ³•è·å–å½“å‰é›†ç¾¤ä¸­å…¨é‡çš„WorkerèŠ‚ç‚¹ï¼Œå¹¶å°†å®ƒæœ€æ–°çš„çŠ¶æ€ä¿å­˜èµ·æ¥ã€‚</p><pre><code class=\"language-plain\">func (m *Master) Campaign() {\n\t...\n\tworkerNodeChange := m.WatchWorker()\n\n\tfor {\n\t\tselect {\n\t\t...\n\t\tcase resp := &lt;-workerNodeChange:\n\t\t\tm.logger.Info(\"watch worker change\", zap.Any(\"worker:\", resp))\n\t\t}\n\t}\n}\n\ntype Master struct {\n\t...\n\tworkNodes map[string]*registry.Node\n}\n\nfunc (m *Master) updateWorkNodes() {\n\tservices, err := m.registry.GetService(worker.ServiceName)\n\tif err != nil {\n\t\tm.logger.Error(\"get service\", zap.Error(err))\n\t}\n\n\tnodes := make(map[string]*registry.Node)\n\tif len(services) &gt; 0 {\n\t\tfor _, spec := range services[0].Nodes {\n\t\t\tnodes[spec.Id] = spec\n\t\t}\n\t}\n\n\tadded, deleted, changed := workNodeDiff(m.workNodes, nodes)\n\tm.logger.Sugar().Info(\"worker joined: \", added, \", leaved: \", deleted, \", changed: \", changed)\n\n\tm.workNodes = nodes\n\n}\n</code></pre><p>æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ workNodeDiff å‡½æ•°æ¯”è¾ƒé›†ç¾¤ä¸­æ–°æ—§èŠ‚ç‚¹çš„å˜åŒ–ã€‚</p><pre><code class=\"language-plain\">func workNodeDiff(old map[string]*registry.Node, new map[string]*registry.Node) ([]string, []string, []string) {\n\tadded := make([]string, 0)\n\tdeleted := make([]string, 0)\n\tchanged := make([]string, 0)\n\tfor k, v := range new {\n\t\tif ov, ok := old[k]; ok {\n\t\t\tif !reflect.DeepEqual(v, ov) {\n\t\t\t\tchanged = append(changed, k)\n\t\t\t}\n\t\t} else {\n\t\t\tadded = append(added, k)\n\t\t}\n\t}\n\tfor k := range old {\n\t\tif _, ok := new[k]; !ok {\n\t\t\tdeleted = append(deleted, k)\n\t\t}\n\t}\n\treturn added, deleted, changed\n}\n</code></pre><p>å½“èŠ‚ç‚¹å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå¯ä»¥æ‰“å°å‡ºæ—¥å¿—ã€‚</p><pre><code class=\"language-plain\">{\"level\":\"INFO\",\"ts\":\"2022-12-12T16:55:42.810+0800\",\"logger\":\"master\",\"caller\":\"master/master.go:187\",\"msg\":\"worker joined: [go.micro.server.worker-2], leaved: [], changed: []\"}\n{\"level\":\"INFO\",\"ts\":\"2022-12-12T16:58:32.026+0800\",\"logger\":\"master\",\"caller\":\"master/master.go:187\",\"msg\":\"worker joined: [], leaved: [go.micro.server.worker-2], changed: []\"}\n</code></pre><h2>Masterèµ„æºç®¡ç†</h2><p>ä¸‹ä¸€æ­¥ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹å¯¹çˆ¬è™«ä»»åŠ¡çš„ç®¡ç†ã€‚</p><p>çˆ¬è™«ä»»åŠ¡ä¹Ÿå¯ä»¥ç†è§£ä¸ºä¸€ç§èµ„æºã€‚å’ŒWorkerä¸€æ ·ï¼ŒMasterä¸­å¯ä»¥æœ‰ä¸€äº›åˆå§‹åŒ–çš„çˆ¬è™«ä»»åŠ¡å­˜å‚¨åœ¨é…ç½®æ–‡ä»¶ä¸­ã€‚åˆå§‹åŒ–æ—¶ï¼Œç¨‹åºé€šè¿‡è¯»å–é…ç½®æ–‡ä»¶å°†çˆ¬è™«ä»»åŠ¡æ³¨å…¥åˆ°Masterä¸­ã€‚è¿™èŠ‚è¯¾æˆ‘ä»¬å…ˆå°†ä»»åŠ¡æ”¾ç½®åˆ°é…ç½®æ–‡ä»¶ä¸­ï¼Œä¸‹èŠ‚è¯¾æˆ‘ä»¬è¿˜ä¼šæ„å»ºMasterçš„APIæ¥å®Œæˆä»»åŠ¡çš„å¢åˆ æŸ¥æ”¹ã€‚</p><pre><code class=\"language-plain\">seeds := worker.ParseTaskConfig(logger, nil, nil, tcfg)\n\tmaster.New(\n\t\tmasterID,\n\t\tmaster.WithLogger(logger.Named(\"master\")),\n\t\tmaster.WithGRPCAddress(GRPCListenAddress),\n\t\tmaster.WithregistryURL(sconfig.RegistryAddress),\n\t\tmaster.WithRegistry(reg),\n\t\tmaster.WithSeeds(seeds),\n\t)\n</code></pre><p>åœ¨åˆå§‹åŒ–Masteræ—¶ï¼Œè°ƒç”¨m.AddSeedå‡½æ•°å®Œæˆèµ„æºçš„æ·»åŠ ã€‚m.AddSeedä¼šé¦–å…ˆè°ƒç”¨etcdCli.Getæ–¹æ³•ï¼ŒæŸ¥çœ‹å½“å‰ä»»åŠ¡æ˜¯å¦å·²ç»å†™å…¥åˆ°äº†etcdä¸­ã€‚å¦‚æœæ²¡æœ‰ï¼Œåˆ™è°ƒç”¨m.AddResourceå°†ä»»åŠ¡å­˜å‚¨åˆ°etcdï¼Œå­˜å‚¨åœ¨etcdä¸­çš„ä»»åŠ¡çš„Keyä¸º <code>/resources/xxxx</code>ã€‚</p><pre><code class=\"language-plain\">func (m *Master) AddSeed() {\n\trs := make([]*ResourceSpec, 0, len(m.Seeds))\n\tfor _, seed := range m.Seeds {\n\t\tresp, err := m.etcdCli.Get(context.Background(), getResourcePath(seed.Name), clientv3.WithSerializable())\n\t\tif err != nil {\n\t\t\tm.logger.Error(\"etcd get faiiled\", zap.Error(err))\n\t\t\tcontinue\n\t\t}\n\t\tif len(resp.Kvs) == 0 {\n\t\t\tr := &amp;ResourceSpec{\n\t\t\t\tName: seed.Name,\n\t\t\t}\n\t\t\trs = append(rs, r)\n\t\t}\n\t}\n\n\tm.AddResource(rs)\n}\n\nconst (\n\tRESOURCEPATH = \"/resources\"\n)\n\nfunc getResourcePath(name string) string {\n\treturn fmt.Sprintf(\"%s/%s\", RESOURCEPATH, name)\n}\n</code></pre><p>åœ¨æ·»åŠ èµ„æºçš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®èµ„æºçš„IDã€åˆ›å»ºæ—¶é—´ç­‰ã€‚åœ¨è¿™é‡Œæˆ‘å€ŸåŠ©äº†ç¬¬ä¸‰æ–¹åº“ <a href=\"https://github.com/bwmarrin/snowflake\">Snowflake</a> ï¼Œä½¿ç”¨é›ªèŠ±ç®—æ³•æ¥ä¸ºèµ„æºç”Ÿæˆäº†ä¸€ä¸ªå•è°ƒé€’å¢çš„åˆ†å¸ƒå¼IDã€‚</p><pre><code class=\"language-plain\">func (m *Master) AddResource(rs []*ResourceSpec) {\n\tfor _, r := range rs {\n\t\tr.ID = m.IDGen.Generate().String()\n\t\tns, err := m.Assign(r)\n\t\tif err != nil {\n\t\t\tm.logger.Error(\"assign failed\", zap.Error(err))\n\t\t\tcontinue\n\t\t}\n\t\tr.AssignedNode = ns.Id + \"|\" + ns.Address\n\t\tr.CreationTime = time.Now().UnixNano()\n\t\tm.logger.Debug(\"add resource\", zap.Any(\"specs\", r))\n\n\t\t_, err = m.etcdCli.Put(context.Background(), getResourcePath(r.Name), encode(r))\n\t\tif err != nil {\n\t\t\tm.logger.Error(\"put etcd failed\", zap.Error(err))\n\t\t\tcontinue\n\t\t}\n\t\tm.resources[r.Name] = r\n\t}\n}\n</code></pre><p>Snowflake&nbsp;åˆ©ç”¨é›ªèŠ±ç®—æ³•ç”Ÿæˆäº†ä¸€ä¸ª64ä½çš„å”¯ä¸€IDï¼Œå…¶ç»“æ„å¦‚ä¸‹ã€‚</p><pre><code class=\"language-plain\">\n+--------------------------------------------------------------------------+\n| 1 Bit Unused | 41 Bit Timestamp |  10 Bit NodeID  |   12 Bit Sequence ID |\n+--------------------------------------------------------------------------+\n</code></pre><p>å…¶ä¸­ï¼Œ41ä½ç”¨äºå­˜å‚¨æ—¶é—´æˆ³ï¼›10ä½ç”¨äºå­˜å‚¨NodeIDï¼Œåœ¨è¿™é‡Œå°±æ˜¯æˆ‘ä»¬çš„Master IDï¼›æœ€å12ä½ä¸ºåºåˆ—å·ã€‚å¦‚æœæˆ‘ä»¬çš„ç¨‹åºæ‰“ç®—åœ¨åŒä¸€ä¸ªæ¯«ç§’å†…ç”Ÿæˆå¤šä¸ªIDï¼Œé‚£ä¹ˆæ¯ç”Ÿæˆä¸€ä¸ªæ–°çš„IDï¼Œåºåˆ—å·ä¼šé€’å¢1ï¼Œè¿™æ„å‘³ç€æ¯ä¸ªèŠ‚ç‚¹æ¯æ¯«ç§’æœ€å¤šèƒ½å¤Ÿäº§ç”Ÿ4096ä¸ªä¸åŒçš„IDï¼Œè¿™å·²ç»èƒ½æ»¡è¶³æˆ‘ä»¬å½“å‰çš„åœºæ™¯äº†ã€‚é›ªèŠ±ç®—æ³•ç¡®ä¿äº†æˆ‘ä»¬ç”Ÿæˆçš„èµ„æºIDæ˜¯å…¨å±€å”¯ä¸€çš„ã€‚</p><p>æ·»åŠ èµ„æºæ—¶ï¼Œè¿˜æœ‰ä¸€æ­¥å¾ˆé‡è¦ï¼Œé‚£å°±æ˜¯è°ƒç”¨m.Assignè®¡ç®—å‡ºå½“å‰çš„èµ„æºåº”è¯¥è¢«åˆ†é…åˆ°å“ªä¸€ä¸ªèŠ‚ç‚¹ä¸Šã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å…ˆç”¨éšæœºçš„æ–¹å¼é€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåé¢è¿˜ä¼šå†ä¼˜åŒ–è°ƒåº¦é€»è¾‘ã€‚</p><pre><code class=\"language-plain\">func (m *Master) Assign(r *ResourceSpec) (*registry.Node, error) {\n\tfor _, n := range m.workNodes {\n\t\treturn n, nil\n\t}\n\treturn nil, errors.New(\"no worker nodes\")\n}\n</code></pre><p>è®¾ç½®å¥½èµ„æºçš„IDä¿¡æ¯ã€åˆ†é…ä¿¡æ¯ä¹‹åï¼Œè°ƒç”¨etcdCli.Putï¼Œå°†èµ„æºçš„KVä¿¡æ¯å­˜å‚¨åˆ°etcdä¸­ã€‚å…¶ä¸­ï¼Œå­˜å‚¨åˆ°etcdä¸­çš„Valueéœ€è¦æ˜¯stringç±»å‹ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹¦å†™äº†JSONçš„åºåˆ—åŒ–ä¸ååºåˆ—åŒ–å‡½æ•°ï¼Œç”¨äºå­˜å‚¨ä¿¡æ¯çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚</p><pre><code class=\"language-plain\">func encode(s *ResourceSpec) string {\n\tb, _ := json.Marshal(s)\n\treturn string(b)\n}\n\nfunc decode(ds []byte) (*ResourceSpec, error) {\n\tvar s *ResourceSpec\n\terr := json.Unmarshal(ds, &amp;s)\n\treturn s, err\n}\n</code></pre><p>æœ€åä¸€æ­¥ï¼Œå½“Masteræˆä¸ºæ–°çš„Leaderåï¼Œæˆ‘ä»¬è¿˜è¦å…¨é‡åœ°è·å–ä¸€æ¬¡etcdä¸­å½“å‰æœ€æ–°çš„èµ„æºä¿¡æ¯ï¼Œå¹¶æŠŠå®ƒä¿å­˜åˆ°å†…å­˜ä¸­ï¼Œæ ¸å¿ƒé€»è¾‘ä½äºloadResourceå‡½æ•°ä¸­ã€‚</p><pre><code class=\"language-plain\">\nfunc (m *Master) BecomeLeader() error {\n\tif err := m.loadResource(); err != nil {\n\t\treturn fmt.Errorf(\"loadResource failed:%w\", err)\n\t}\n\tatomic.StoreInt32(&amp;m.ready, 1)\n\treturn nil\n}\n\nfunc (m *Master) loadResource() error {\n\tresp, err := m.etcdCli.Get(context.Background(), RESOURCEPATH, clientv3.WithSerializable())\n\tif err != nil {\n\t\treturn fmt.Errorf(\"etcd get failed\")\n\t}\n\n\tresources := make(map[string]*ResourceSpec)\n\tfor _, kv := range resp.Kvs {\n\t\tr, err := decode(kv.Value)\n\t\tif err == nil &amp;&amp; r != nil {\n\t\t\tresources[r.Name] = r\n\t\t}\n\t}\n\tm.logger.Info(\"leader init load resource\", zap.Int(\"lenth\", len(m.resources)))\n\tm.resources = resources\n\treturn nil\n}\n</code></pre><h3>éªŒè¯Masterèµ„æºåˆ†é…ç»“æœ</h3><p>æœ€åè®©æˆ‘ä»¬å®æˆ˜éªŒè¯ä¸€ä¸‹ Masterçš„èµ„æºåˆ†é…ç»“æœã€‚</p><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦å¯åŠ¨Workerã€‚è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœå…ˆå¯åŠ¨äº†Masterï¼Œåˆå§‹çš„ä»»åŠ¡å°†ä¼šç”±äºæ²¡æœ‰å¯¹åº”çš„WorkerèŠ‚ç‚¹è€Œæ·»åŠ å¤±è´¥ã€‚</p><pre><code class=\"language-plain\">Â» go run main.go worker --id=2 --http=:8079&nbsp; --grpc=:9089\n</code></pre><p>æ¥ç€å¯åŠ¨MasteræœåŠ¡ã€‚</p><pre><code class=\"language-plain\">Â» go run main.go master --id=2 --http=:8081  --grpc=:9091\n</code></pre><p>ç°åœ¨æŸ¥çœ‹etcdçš„ä¿¡æ¯ä¼šå‘ç°ï¼Œå½“å‰ä¸¤ä¸ªçˆ¬è™«ä»»åŠ¡éƒ½å·²ç»è®¾ç½®åˆ°etcdä¸­ï¼Œå¹¶ä¸”Masterä¸ºä»–ä»¬åˆ†é…çš„WorkerèŠ‚ç‚¹ä¸º\"go.micro.server.worker-2|192.168.0.107:9089\"ï¼Œè¯´æ˜Masterçš„èµ„æºåˆ†é…æˆåŠŸäº†ã€‚</p><pre><code class=\"language-plain\">Â» docker exec etcd-gcr-v3.5.6 /bin/sh -c \"/usr/local/bin/etcdctl get --prefix /\"                                                                           jackson@bogon\n/micro/registry/go.micro.server.master/go.micro.server.master-2\n{\"name\":\"go.micro.server.master\",\"version\":\"latest\",\"metadata\":null,\"endpoints\":[{\"name\":\"Greeter.Hello\",\"request\":{\"name\":\"Request\",\"type\":\"Request\",\"values\":[{\"name\":\"name\",\"type\":\"string\",\"values\":null}]},\"response\":{\"name\":\"Response\",\"type\":\"Response\",\"values\":[{\"name\":\"greeting\",\"type\":\"string\",\"values\":null}]},\"metadata\":{\"endpoint\":\"Greeter.Hello\",\"handler\":\"rpc\",\"method\":\"POST\",\"path\":\"/greeter/hello\"}}],\"nodes\":[{\"id\":\"go.micro.server.master-2\",\"address\":\"192.168.0.107:9091\",\"metadata\":{\"broker\":\"http\",\"protocol\":\"grpc\",\"registry\":\"etcd\",\"server\":\"grpc\",\"transport\":\"grpc\"}}]}\n\n/micro/registry/go.micro.server.worker/go.micro.server.worker-2\n{\"name\":\"go.micro.server.worker\",\"version\":\"latest\",\"metadata\":null,\"endpoints\":[{\"name\":\"Greeter.Hello\",\"request\":{\"name\":\"Request\",\"type\":\"Request\",\"values\":[{\"name\":\"name\",\"type\":\"string\",\"values\":null}]},\"response\":{\"name\":\"Response\",\"type\":\"Response\",\"values\":[{\"name\":\"greeting\",\"type\":\"string\",\"values\":null}]},\"metadata\":{\"endpoint\":\"Greeter.Hello\",\"handler\":\"rpc\",\"method\":\"POST\",\"path\":\"/greeter/hello\"}}],\"nodes\":[{\"id\":\"go.micro.server.worker-2\",\"address\":\"192.168.0.107:9089\",\"metadata\":{\"broker\":\"http\",\"protocol\":\"grpc\",\"registry\":\"etcd\",\"server\":\"grpc\",\"transport\":\"grpc\"}}]}\n\n/resources/douban_book_list\n{\"ID\":\"1602250527540776960\",\"Name\":\"douban_book_list\",\"AssignedNode\":\"go.micro.server.worker-2|192.168.0.107:9089\",\"CreationTime\":1670841268798763000}\n\n/resources/election/3f3584fc571ae9d0\nmaster2-192.168.0.107:9091\n\n/resources/xxx\n{\"ID\":\"1602250527570137088\",\"Name\":\"xxx\",\"AssignedNode\":\"go.micro.server.worker-2|192.168.0.107:9089\",\"CreationTime\":1670841268805921000}\n</code></pre><h2>æ€»ç»“</h2><p>è¿™èŠ‚è¯¾ã€‚æˆ‘ä»¬å®ç°äº†Masterçš„ä¸¤ä¸ªé‡è¦åŠŸèƒ½ï¼šæœåŠ¡å‘ç°ä¸èµ„æºç®¡ç†ã€‚</p><p>å¯¹äºæœåŠ¡å‘ç°ï¼Œæˆ‘ä»¬å€ŸåŠ©äº†micro registryæä¾›çš„æ¥å£ï¼Œå®ç°äº†èŠ‚ç‚¹çš„æ³¨å†Œã€å‘ç°å’ŒçŠ¶æ€è·å–ã€‚microçš„registryæ¥å£æ˜¯ä¸€ä¸ªæ’ä»¶ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥è½»æ¾ä½¿ç”¨ä¸åŒæ’ä»¶ä¸ä¸åŒçš„æ³¨å†Œä¸­å¿ƒäº¤äº’ã€‚åœ¨è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çš„ä»ç„¶æ˜¯go-microçš„etcdæ’ä»¶ï¼Œå€ŸåŠ©etcd clientv3çš„APIå®ç°äº†æœåŠ¡å‘ç°ä¸æ³¨å†Œçš„ç›¸å…³åŠŸèƒ½ã€‚</p><p>è€Œå¯¹äºèµ„æºç®¡ç†ï¼Œè¿™èŠ‚è¯¾æˆ‘ä»¬ä¸ºèµ„æºåŠ ä¸Šäº†å¿…è¦çš„IDä¿¡æ¯ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†åˆ†å¸ƒå¼çš„é›ªèŠ±ç®—æ³•æ¥ä¿è¯ç”ŸæˆIDå…¨å±€å”¯ä¸€ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬ç”¨éšæœºçš„æ–¹å¼ä¸ºèµ„æºåˆ†é…äº†å…¶æ‰€å±çš„WorkerèŠ‚ç‚¹å¹¶éªŒè¯äº†åˆ†é…çš„æ•ˆæœã€‚åœ¨ä¸‹ä¸€èŠ‚è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬è¿˜ä¼šç»§ç»­å®ç°è´Ÿè½½å‡è¡¡çš„èµ„æºåˆ†é…ã€‚</p><h2>è¯¾åé¢˜</h2><p>å­¦å®Œè¿™èŠ‚è¯¾ï¼Œç»™ä½ ç•™ä¸¤é“æ€è€ƒé¢˜ã€‚</p><ol>\n<li>æˆ‘ä»¬ä»€ä¹ˆæ—¶å€™éœ€è¦å…¨é‡æ‹‰å–èµ„æºï¼Ÿä»€ä¹ˆæ—¶å€™éœ€è¦ä½¿ç”¨äº‹ä»¶ç›‘å¬æœºåˆ¶ï¼Ÿä½ è®¤ä¸ºç›‘å¬æœºåˆ¶æ˜¯å¯é çš„å—ï¼Ÿ</li>\n<li>æˆ‘ä»¬å‰é¢æåˆ°çš„ Snowflake é›ªèŠ±ç®—æ³•ç”Ÿæˆçš„åˆ†å¸ƒå¼IDï¼Œåœ¨ä»€ä¹ˆåœºæ™¯ä¸‹æ˜¯ä¸é€‚ç”¨çš„ï¼Ÿ</li>\n</ol><p>æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºä¸æˆ‘äº¤æµè®¨è®ºï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ã€‚</p>","comments":[{"had_liked":false,"id":367494,"user_name":"Realm","can_delete":false,"product_type":"c1","uid":1081299,"ip_address":"æµ™æ±Ÿ","ucode":"30CBEBE619D1A2","user_header":"https://static001.geekbang.org/account/avatar/00/10/7f/d3/b5896293.jpg","comment_is_top":false,"comment_ctime":1675262559,"is_pvip":true,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100124001,"comment_content":"1 â€œå½“ Master æˆä¸ºæ–°çš„ Leader åï¼Œæˆ‘ä»¬è¿˜è¦å…¨é‡åœ°è·å–ä¸€æ¬¡ etcd ä¸­å½“å‰æœ€æ–°çš„èµ„æºä¿¡æ¯ï¼Œå¹¶æŠŠå®ƒä¿å­˜åˆ°å†…å­˜ä¸­â€ï¼Œ\nå½“æ·»åŠ å•ä¸ªtaskä»»åŠ¡æ—¶ï¼Œä½¿ç”¨äº‹ä»¶ç›‘å¬ï¼›\näº‹ä»¶ç›‘å¬æœºåˆ¶åœ¨æœåŠ¡å¼‚å¸¸æ—¶å¯èƒ½ä¸¢ä¿¡æ¯ï¼Ÿ\næœ›å‹‹å“¥æŒ‡ç‚¹.\n\n2 é›ªèŠ±ç®—æ³•ç”Ÿæˆçš„idæœ‰å¯èƒ½ä¼šå‡ºç°é‡å¤ã€‚\nå¦‚ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼ŒæŠŠæœåŠ¡å™¨æ—¶é’Ÿå›æ‹¨çš„æƒ…å†µï¼›\nå¤šä¸ªèŠ‚ç‚¹æ—¶å€™ï¼Œå‡å¦‚æœåŠ¡å™¨çš„æ ‡å¿—ä½ä¸€æ ·ï¼ŒåŒä¸€æ¯«ç§’ä¸åŒçš„èŠ‚ç‚¹å¯èƒ½äº§ç”Ÿçš„idç›¸åŒï¼›","like_count":1},{"had_liked":false,"id":367514,"user_name":"èƒ¡å†›","can_delete":false,"product_type":"c1","uid":1719006,"ip_address":"æµ™æ±Ÿ","ucode":"4DA22C603EE773","user_header":"https://static001.geekbang.org/account/avatar/00/1a/3a/de/ed40f1bb.jpg","comment_is_top":false,"comment_ctime":1675299303,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100124001,"comment_content":"è€å¸ˆè¯­é€Ÿå¥½å¿«ï¼Œéƒ½æ¥ä¸åŠæ€è€ƒå’Œçœ‹æ–‡æ¡£ğŸ˜…","like_count":0}]}