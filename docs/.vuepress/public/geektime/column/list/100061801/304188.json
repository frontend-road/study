{"id":304188,"title":"13 | Channelï¼šå¦è¾Ÿè¹Šå¾„ï¼Œè§£å†³å¹¶å‘é—®é¢˜","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯é¸Ÿçªã€‚</p><p>Channelæ˜¯Goè¯­è¨€å†…å»ºçš„first-classç±»å‹ï¼Œä¹Ÿæ˜¯Goè¯­è¨€ä¸ä¼—ä¸åŒçš„ç‰¹æ€§ä¹‹ä¸€ã€‚Goè¯­è¨€çš„Channelè®¾è®¡ç²¾å·§ç®€å•ï¼Œä»¥è‡³äºä¹Ÿæœ‰äººç”¨å…¶å®ƒè¯­è¨€ç¼–å†™äº†ç±»ä¼¼Goé£æ ¼çš„Channelåº“ï¼Œæ¯”å¦‚<a href=\"https://github.com/docker/libchan\">docker/libchan</a>ã€<a href=\"https://github.com/tylertreat/chan\">tylertreat/chan</a>ï¼Œä½†æ˜¯å¹¶ä¸åƒGoè¯­è¨€ä¸€æ ·æŠŠChannelå†…ç½®åˆ°äº†è¯­è¨€è§„èŒƒä¸­ã€‚ä»è¿™ä¸€ç‚¹ï¼Œä½ ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼ŒChannelçš„åœ°ä½åœ¨ç¼–ç¨‹è¯­è¨€ä¸­çš„åœ°ä½ä¹‹é«˜ï¼Œæ¯”è¾ƒç½•è§ã€‚</p><p>æ‰€ä»¥ï¼Œè¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬å°±æ¥å­¦ä¹ ä¸‹Channelã€‚</p><h1>Channelçš„å‘å±•</h1><p>è¦æƒ³äº†è§£Channelè¿™ç§Goç¼–ç¨‹è¯­è¨€ä¸­çš„ç‰¹æœ‰çš„æ•°æ®ç»“æ„ï¼Œæˆ‘ä»¬è¦è¿½æº¯åˆ°CSPæ¨¡å‹ï¼Œå­¦ä¹ ä¸€ä¸‹å®ƒçš„å†å²ï¼Œä»¥åŠå®ƒå¯¹Goåˆ›å§‹äººè®¾è®¡Channelç±»å‹çš„å½±å“ã€‚</p><p>CSPæ˜¯Communicating Sequential Process çš„ç®€ç§°ï¼Œä¸­æ–‡ç›´è¯‘ä¸ºé€šä¿¡é¡ºåºè¿›ç¨‹ï¼Œæˆ–è€…å«åšäº¤æ¢ä¿¡æ¯çš„å¾ªåºè¿›ç¨‹ï¼Œæ˜¯ç”¨æ¥æè¿°å¹¶å‘ç³»ç»Ÿä¸­è¿›è¡Œäº¤äº’çš„ä¸€ç§æ¨¡å¼ã€‚</p><p>CSPæœ€æ—©å‡ºç°äºè®¡ç®—æœºç§‘å­¦å®¶Tony Hoare åœ¨1978å¹´å‘è¡¨çš„<a href=\"https://www.cs.cmu.edu/~crary/819-f09/Hoare78.pdf\">è®ºæ–‡</a>ä¸­ï¼ˆä½ å¯èƒ½ä¸ç†Ÿæ‚‰Tony Hoareè¿™ä¸ªåå­—ï¼Œä½†æ˜¯ä½ ä¸€å®šå¾ˆç†Ÿæ‚‰æ’åºç®—æ³•ä¸­çš„Quicksortç®—æ³•ï¼Œä»–å°±æ˜¯Quicksortç®—æ³•çš„ä½œè€…ï¼Œå›¾çµå¥–çš„è·å¾—è€…ï¼‰ã€‚æœ€åˆï¼Œè®ºæ–‡ä¸­æå‡ºçš„CSPç‰ˆæœ¬åœ¨æœ¬è´¨ä¸Šä¸æ˜¯ä¸€ç§è¿›ç¨‹æ¼”ç®—ï¼Œè€Œæ˜¯ä¸€ç§å¹¶å‘ç¼–ç¨‹è¯­è¨€ï¼Œä½†ä¹‹ååˆç»è¿‡äº†ä¸€ç³»åˆ—çš„æ”¹è¿›ï¼Œæœ€ç»ˆå‘å±•å¹¶ç²¾ç‚¼å‡ºCSPçš„ç†è®ºã€‚<strong>CSPå…è®¸ä½¿ç”¨è¿›ç¨‹ç»„ä»¶æ¥æè¿°ç³»ç»Ÿï¼Œå®ƒä»¬ç‹¬ç«‹è¿è¡Œï¼Œå¹¶ä¸”åªé€šè¿‡æ¶ˆæ¯ä¼ é€’çš„æ–¹å¼é€šä¿¡ã€‚</strong></p><!-- [[[read_end]]] --><p>å°±åƒGoçš„åˆ›å§‹äººä¹‹ä¸€Rob Pikeæ‰€è¯´çš„ï¼šâ€œæ¯ä¸€ä¸ªè®¡ç®—æœºç¨‹åºå‘˜éƒ½åº”è¯¥è¯»ä¸€è¯»Tony Hoare 1978å¹´çš„å…³äºCSPçš„è®ºæ–‡ã€‚â€ä»–å’ŒKen Thompsonåœ¨è®¾è®¡Goè¯­è¨€çš„æ—¶å€™ä¹Ÿæ·±å—æ­¤è®ºæ–‡çš„å½±å“ï¼Œå¹¶å°†CSPç†è®ºçœŸæ­£åº”ç”¨äºè¯­è¨€æœ¬èº«ï¼ˆRuss Coxä¸“é—¨å†™äº†ä¸€ç¯‡æ–‡ç« è®°å½•è¿™ä¸ª<a href=\"https://swtch.com/~rsc/thread/\">å†å²</a>ï¼‰ï¼Œé€šè¿‡å¼•å…¥Channelè¿™ä¸ªæ–°çš„ç±»å‹ï¼Œæ¥å®ç°CSPçš„æ€æƒ³ã€‚</p><p><strong>Channelç±»å‹æ˜¯Goè¯­è¨€å†…ç½®çš„ç±»å‹ï¼Œä½ æ— éœ€å¼•å…¥æŸä¸ªåŒ…ï¼Œå°±èƒ½ä½¿ç”¨å®ƒ</strong>ã€‚è™½ç„¶Goä¹Ÿæä¾›äº†ä¼ ç»Ÿçš„å¹¶å‘åŸè¯­ï¼Œä½†æ˜¯å®ƒä»¬éƒ½æ˜¯é€šè¿‡åº“çš„æ–¹å¼æä¾›çš„ï¼Œä½ å¿…é¡»è¦å¼•å…¥syncåŒ…æˆ–è€…atomicåŒ…æ‰èƒ½ä½¿ç”¨å®ƒä»¬ï¼Œè€ŒChannelå°±ä¸ä¸€æ ·äº†ï¼Œå®ƒæ˜¯å†…ç½®ç±»å‹ï¼Œä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ã€‚</p><p>Channelå’ŒGoçš„å¦ä¸€ä¸ªç‹¬ç‰¹çš„ç‰¹æ€§goroutineä¸€èµ·ä¸ºå¹¶å‘ç¼–ç¨‹æä¾›äº†ä¼˜é›…çš„ã€ä¾¿åˆ©çš„ã€ä¸ä¼ ç»Ÿå¹¶å‘æ§åˆ¶ä¸åŒçš„æ–¹æ¡ˆï¼Œå¹¶æ¼”åŒ–å‡ºå¾ˆå¤šå¹¶å‘æ¨¡å¼ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥çœ‹ä¸€çœ‹Channelçš„åº”ç”¨åœºæ™¯ã€‚</p><h1>Channelçš„åº”ç”¨åœºæ™¯</h1><p>é¦–å…ˆï¼Œæˆ‘æƒ³å…ˆå¸¦ä½ çœ‹ä¸€æ¡Goè¯­è¨€ä¸­æµä¼ å¾ˆå¹¿çš„è°šè¯­ï¼š</p><blockquote>\n<p>Donâ€™t communicate by sharing memory, share memory by communicating.</p>\n</blockquote><blockquote>\n<p>Go Proverbs by Rob Pike</p>\n</blockquote><p>è¿™æ˜¯Rob Pikeåœ¨2015å¹´çš„ä¸€æ¬¡Gopherä¼šè®®ä¸­æåˆ°çš„ä¸€å¥è¯ï¼Œè™½ç„¶æœ‰ä¸€ç‚¹ç»•ï¼Œä½†ä¹ŸæŒ‡å‡ºäº†ä½¿ç”¨Goè¯­è¨€çš„å“²å­¦ï¼Œæˆ‘å°è¯•ç€æ¥ç¿»è¯‘ä¸€ä¸‹ï¼šâ€œ<strong>æ‰§è¡Œä¸šåŠ¡å¤„ç†çš„goroutineä¸è¦é€šè¿‡å…±äº«å†…å­˜çš„æ–¹å¼é€šä¿¡ï¼Œè€Œæ˜¯è¦é€šè¿‡Channelé€šä¿¡çš„æ–¹å¼åˆ†äº«æ•°æ®ã€‚</strong>â€</p><p>â€œcommunicate by sharing memoryâ€å’Œâ€œshare memory by communicatingâ€æ˜¯ä¸¤ç§ä¸åŒçš„å¹¶å‘å¤„ç†æ¨¡å¼ã€‚â€œcommunicate by sharing memoryâ€æ˜¯ä¼ ç»Ÿçš„å¹¶å‘ç¼–ç¨‹å¤„ç†æ–¹å¼ï¼Œå°±æ˜¯æŒ‡ï¼Œå…±äº«çš„æ•°æ®éœ€è¦ç”¨é”è¿›è¡Œä¿æŠ¤ï¼Œgoroutineéœ€è¦è·å–åˆ°é”ï¼Œæ‰èƒ½å¹¶å‘è®¿é—®æ•°æ®ã€‚</p><p>â€œshare memory by communicatingâ€åˆ™æ˜¯ç±»ä¼¼äºCSPæ¨¡å‹çš„æ–¹å¼ï¼Œé€šè¿‡é€šä¿¡çš„æ–¹å¼ï¼Œä¸€ä¸ªgoroutineå¯ä»¥æŠŠæ•°æ®çš„â€œæ‰€æœ‰æƒâ€äº¤ç»™å¦å¤–ä¸€ä¸ªgoroutineï¼ˆè™½ç„¶Goä¸­æ²¡æœ‰â€œæ‰€æœ‰æƒâ€çš„æ¦‚å¿µï¼Œä½†æ˜¯ä»é€»è¾‘ä¸Šè¯´ï¼Œä½ å¯ä»¥æŠŠå®ƒç†è§£ä¸ºæ˜¯æ‰€æœ‰æƒçš„è½¬ç§»ï¼‰ã€‚</p><p>ä»Channelçš„å†å²å’Œè®¾è®¡å“²å­¦ä¸Šï¼Œæˆ‘ä»¬å°±å¯ä»¥äº†è§£åˆ°ï¼ŒChannelç±»å‹å’ŒåŸºæœ¬å¹¶å‘åŸè¯­æ˜¯æœ‰ç«äº‰å…³ç³»çš„ï¼Œå®ƒåº”ç”¨äºå¹¶å‘åœºæ™¯ï¼Œæ¶‰åŠåˆ°goroutineä¹‹é—´çš„é€šè®¯ï¼Œå¯ä»¥æä¾›å¹¶å‘çš„ä¿æŠ¤ï¼Œç­‰ç­‰ã€‚</p><p>ç»¼åˆèµ·æ¥ï¼Œæˆ‘æŠŠChannelçš„åº”ç”¨åœºæ™¯åˆ†ä¸ºäº”ç§ç±»å‹ã€‚è¿™é‡Œä½ å…ˆæœ‰ä¸ªå°è±¡ï¼Œè¿™æ ·ä½ å¯ä»¥æœ‰ç›®çš„åœ°å»å­¦ä¹ Channelçš„åŸºæœ¬åŸç†ã€‚ä¸‹èŠ‚è¯¾æˆ‘ä¼šå€ŸåŠ©å…·ä½“çš„ä¾‹å­ï¼Œæ¥å¸¦ä½ æŒæ¡è¿™å‡ ç§ç±»å‹ã€‚</p><ol>\n<li><strong>æ•°æ®äº¤æµ</strong>ï¼šå½“ä½œå¹¶å‘çš„bufferæˆ–è€…queueï¼Œè§£å†³ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜ã€‚å¤šä¸ªgoroutineå¯ä»¥å¹¶å‘å½“ä½œç”Ÿäº§è€…ï¼ˆProducerï¼‰å’Œæ¶ˆè´¹è€…ï¼ˆConsumerï¼‰ã€‚</li>\n<li><strong>æ•°æ®ä¼ é€’</strong>ï¼šä¸€ä¸ªgoroutineå°†æ•°æ®äº¤ç»™å¦ä¸€ä¸ªgoroutineï¼Œç›¸å½“äºæŠŠæ•°æ®çš„æ‹¥æœ‰æƒ(å¼•ç”¨)æ‰˜ä»˜å‡ºå»ã€‚</li>\n<li><strong>ä¿¡å·é€šçŸ¥</strong>ï¼šä¸€ä¸ªgoroutineå¯ä»¥å°†ä¿¡å·(closingã€closedã€data readyç­‰)ä¼ é€’ç»™å¦ä¸€ä¸ªæˆ–è€…å¦ä¸€ç»„goroutine ã€‚</li>\n<li><strong>ä»»åŠ¡ç¼–æ’</strong>ï¼šå¯ä»¥è®©ä¸€ç»„goroutineæŒ‰ç…§ä¸€å®šçš„é¡ºåºå¹¶å‘æˆ–è€…ä¸²è¡Œçš„æ‰§è¡Œï¼Œè¿™å°±æ˜¯ç¼–æ’çš„åŠŸèƒ½ã€‚</li>\n<li><strong>é”</strong>ï¼šåˆ©ç”¨Channelä¹Ÿå¯ä»¥å®ç°äº’æ–¥é”çš„æœºåˆ¶ã€‚</li>\n</ol><p>ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥å…·ä½“å­¦ä¹ ä¸‹Channelçš„åŸºæœ¬ç”¨æ³•ã€‚</p><h1>ChannelåŸºæœ¬ç”¨æ³•</h1><p>ä½ å¯ä»¥å¾€Channelä¸­å‘é€æ•°æ®ï¼Œä¹Ÿå¯ä»¥ä»Channelä¸­æ¥æ”¶æ•°æ®ï¼Œæ‰€ä»¥ï¼ŒChannelç±»å‹ï¼ˆä¸ºäº†è¯´èµ·æ¥æ–¹ä¾¿ï¼Œæˆ‘ä»¬ä¸‹é¢éƒ½æŠŠChannelå«åšchanï¼‰åˆ†ä¸º<strong>åªèƒ½æ¥æ”¶</strong>ã€<strong>åªèƒ½å‘é€</strong>ã€<strong>æ—¢å¯ä»¥æ¥æ”¶åˆå¯ä»¥å‘é€</strong>ä¸‰ç§ç±»å‹ã€‚ä¸‹é¢æ˜¯å®ƒçš„è¯­æ³•å®šä¹‰ï¼š</p><pre><code>ChannelType = ( &quot;chan&quot; | &quot;chan&quot; &quot;&lt;-&quot; | &quot;&lt;-&quot; &quot;chan&quot; ) ElementType .\n</code></pre><p>ç›¸åº”åœ°ï¼ŒChannelçš„æ­£ç¡®è¯­æ³•å¦‚ä¸‹ï¼š</p><pre><code>chan string          // å¯ä»¥å‘é€æ¥æ”¶string\nchan&lt;- struct{}      // åªèƒ½å‘é€struct{}\n&lt;-chan int           // åªèƒ½ä»chanæ¥æ”¶int\n</code></pre><p>æˆ‘ä»¬æŠŠæ—¢èƒ½æ¥æ”¶åˆèƒ½å‘é€çš„chanå«åšåŒå‘çš„chanï¼ŒæŠŠåªèƒ½å‘é€å’Œåªèƒ½æ¥æ”¶çš„chanå«åšå•å‘çš„chanã€‚å…¶ä¸­ï¼Œâ€œ&lt;-â€è¡¨ç¤ºå•å‘çš„chanï¼Œå¦‚æœä½ è®°ä¸ä½ï¼Œæˆ‘å‘Šè¯‰ä½ ä¸€ä¸ªç®€ä¾¿çš„æ–¹æ³•ï¼š<strong>è¿™ä¸ªç®­å¤´æ€»æ˜¯å°„å‘å·¦è¾¹çš„ï¼Œå…ƒç´ ç±»å‹æ€»åœ¨æœ€å³è¾¹ã€‚å¦‚æœç®­å¤´æŒ‡å‘chanï¼Œå°±è¡¨ç¤ºå¯ä»¥å¾€chanä¸­å¡æ•°æ®ï¼›å¦‚æœç®­å¤´è¿œç¦»chanï¼Œå°±è¡¨ç¤ºchanä¼šå¾€å¤–åæ•°æ®</strong>ã€‚</p><p>chanä¸­çš„å…ƒç´ æ˜¯ä»»æ„çš„ç±»å‹ï¼Œæ‰€ä»¥ä¹Ÿå¯èƒ½æ˜¯chanç±»å‹ï¼Œæˆ‘æ¥ä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚ä¸‹é¢çš„chanç±»å‹ä¹Ÿæ˜¯åˆæ³•çš„ï¼š</p><pre><code>chan&lt;- chan int   \nchan&lt;- &lt;-chan int  \n&lt;-chan &lt;-chan int\nchan (&lt;-chan int)\n</code></pre><p>å¯æ˜¯ï¼Œæ€ä¹ˆåˆ¤å®šç®­å¤´ç¬¦å·å±äºå“ªä¸ªchanå‘¢ï¼Ÿå…¶å®ï¼Œâ€œ&lt;-â€æœ‰ä¸ªè§„åˆ™ï¼Œæ€»æ˜¯å°½é‡å’Œå·¦è¾¹çš„chanç»“åˆï¼ˆThe <code>&lt;-</code> operator associates with the leftmost <code>chan</code> possible:ï¼‰ï¼Œå› æ­¤ï¼Œä¸Šé¢çš„å®šä¹‰å’Œä¸‹é¢çš„ä½¿ç”¨æ‹¬å·çš„åˆ’åˆ†æ˜¯ä¸€æ ·çš„ï¼š</p><pre><code>chan&lt;- ï¼ˆchan intï¼‰ // &lt;- å’Œç¬¬ä¸€ä¸ªchanç»“åˆ\nchan&lt;- ï¼ˆ&lt;-chan intï¼‰ // ç¬¬ä¸€ä¸ª&lt;-å’Œæœ€å·¦è¾¹çš„chanç»“åˆï¼Œç¬¬äºŒä¸ª&lt;-å’Œå·¦è¾¹ç¬¬äºŒä¸ªchanç»“åˆ\n&lt;-chan ï¼ˆ&lt;-chan intï¼‰ // ç¬¬ä¸€ä¸ª&lt;-å’Œæœ€å·¦è¾¹çš„chanç»“åˆï¼Œç¬¬äºŒä¸ª&lt;-å’Œå·¦è¾¹ç¬¬äºŒä¸ªchanç»“åˆ \nchan (&lt;-chan int) // å› ä¸ºæ‹¬å·çš„åŸå› ï¼Œ&lt;-å’Œæ‹¬å·å†…ç¬¬ä¸€ä¸ªchanç»“åˆ\n</code></pre><p>é€šè¿‡makeï¼Œæˆ‘ä»¬å¯ä»¥åˆå§‹åŒ–ä¸€ä¸ªchanï¼Œæœªåˆå§‹åŒ–çš„chançš„é›¶å€¼æ˜¯nilã€‚ä½ å¯ä»¥è®¾ç½®å®ƒçš„å®¹é‡ï¼Œæ¯”å¦‚ä¸‹é¢çš„chançš„å®¹é‡æ˜¯9527ï¼Œæˆ‘ä»¬æŠŠè¿™æ ·çš„chanå«åšbuffered chanï¼›å¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œå®ƒçš„å®¹é‡æ˜¯0ï¼Œæˆ‘ä»¬æŠŠè¿™æ ·çš„chanå«åšunbuffered chanã€‚</p><pre><code>make(chan int, 9527)\n</code></pre><p>å¦‚æœchanä¸­è¿˜æœ‰æ•°æ®ï¼Œé‚£ä¹ˆï¼Œä»è¿™ä¸ªchanæ¥æ”¶æ•°æ®çš„æ—¶å€™å°±ä¸ä¼šé˜»å¡ï¼Œå¦‚æœchanè¿˜æœªæ»¡ï¼ˆâ€œæ»¡â€æŒ‡è¾¾åˆ°å…¶å®¹é‡ï¼‰ï¼Œç»™å®ƒå‘é€æ•°æ®ä¹Ÿä¸ä¼šé˜»å¡ï¼Œå¦åˆ™å°±ä¼šé˜»å¡ã€‚unbuffered chanåªæœ‰è¯»å†™éƒ½å‡†å¤‡å¥½ä¹‹åæ‰ä¸ä¼šé˜»å¡ï¼Œè¿™ä¹Ÿæ˜¯å¾ˆå¤šä½¿ç”¨unbuffered chanæ—¶çš„å¸¸è§Bugã€‚</p><p>è¿˜æœ‰ä¸€ä¸ªçŸ¥è¯†ç‚¹éœ€è¦ä½ è®°ä½ï¼šnilæ˜¯chançš„é›¶å€¼ï¼Œæ˜¯ä¸€ç§ç‰¹æ®Šçš„chanï¼Œå¯¹å€¼æ˜¯nilçš„chançš„å‘é€æ¥æ”¶è°ƒç”¨è€…æ€»æ˜¯ä¼šé˜»å¡ã€‚</p><p>ä¸‹é¢ï¼Œæˆ‘æ¥å…·ä½“ç»™ä½ ä»‹ç»å‡ ç§åŸºæœ¬æ“ä½œï¼Œåˆ†åˆ«æ˜¯å‘é€æ•°æ®ã€æ¥æ”¶æ•°æ®ï¼Œä»¥åŠä¸€äº›å…¶å®ƒæ“ä½œã€‚å­¦ä¼šäº†è¿™å‡ ç§æ“ä½œï¼Œä½ å°±èƒ½çœŸæ­£åœ°æŒæ¡Channelçš„ç”¨æ³•äº†ã€‚</p><p><strong>1.å‘é€æ•°æ®</strong></p><p>å¾€chanä¸­å‘é€ä¸€ä¸ªæ•°æ®ä½¿ç”¨â€œch&lt;-â€ï¼Œå‘é€æ•°æ®æ˜¯ä¸€æ¡è¯­å¥:</p><pre><code>ch &lt;- 2000\n</code></pre><p>è¿™é‡Œçš„chæ˜¯chan intç±»å‹æˆ–è€…æ˜¯chan &lt;-intã€‚</p><p><strong>2.æ¥æ”¶æ•°æ®</strong></p><p>ä»chanä¸­æ¥æ”¶ä¸€æ¡æ•°æ®ä½¿ç”¨â€œ&lt;-châ€ï¼Œæ¥æ”¶æ•°æ®ä¹Ÿæ˜¯ä¸€æ¡è¯­å¥ï¼š</p><pre><code>  x := &lt;-ch // æŠŠæ¥æ”¶çš„ä¸€æ¡æ•°æ®èµ‹å€¼ç»™å˜é‡x\n  foo(&lt;-ch) // æŠŠæ¥æ”¶çš„ä¸€ä¸ªçš„æ•°æ®ä½œä¸ºå‚æ•°ä¼ ç»™å‡½æ•°\n  &lt;-ch // ä¸¢å¼ƒæ¥æ”¶çš„ä¸€æ¡æ•°æ®\n</code></pre><p>è¿™é‡Œçš„chç±»å‹æ˜¯chan Tæˆ–è€…&lt;-chan Tã€‚</p><p>æ¥æ”¶æ•°æ®æ—¶ï¼Œè¿˜å¯ä»¥è¿”å›ä¸¤ä¸ªå€¼ã€‚ç¬¬ä¸€ä¸ªå€¼æ˜¯è¿”å›çš„chanä¸­çš„å…ƒç´ ï¼Œå¾ˆå¤šäººä¸å¤ªç†Ÿæ‚‰çš„æ˜¯ç¬¬äºŒä¸ªå€¼ã€‚ç¬¬äºŒä¸ªå€¼æ˜¯boolç±»å‹ï¼Œä»£è¡¨æ˜¯å¦æˆåŠŸåœ°ä»chanä¸­è¯»å–åˆ°ä¸€ä¸ªå€¼ï¼Œå¦‚æœç¬¬äºŒä¸ªå‚æ•°æ˜¯falseï¼Œchanå·²ç»è¢«closeè€Œä¸”chanä¸­æ²¡æœ‰ç¼“å­˜çš„æ•°æ®ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œç¬¬ä¸€ä¸ªå€¼æ˜¯é›¶å€¼ã€‚æ‰€ä»¥ï¼Œå¦‚æœä»chanè¯»å–åˆ°ä¸€ä¸ªé›¶å€¼ï¼Œå¯èƒ½æ˜¯senderçœŸæ­£å‘é€çš„é›¶å€¼ï¼Œä¹Ÿå¯èƒ½æ˜¯closedçš„å¹¶ä¸”æ²¡æœ‰ç¼“å­˜å…ƒç´ äº§ç”Ÿçš„é›¶å€¼ã€‚</p><p><strong>3.å…¶å®ƒæ“ä½œ</strong></p><p>Goå†…å»ºçš„å‡½æ•°closeã€capã€lenéƒ½å¯ä»¥æ“ä½œchanç±»å‹ï¼šcloseä¼šæŠŠchanå…³é—­æ‰ï¼Œcapè¿”å›chançš„å®¹é‡ï¼Œlenè¿”å›chanä¸­ç¼“å­˜çš„è¿˜æœªè¢«å–èµ°çš„å…ƒç´ æ•°é‡ã€‚</p><p>sendå’Œrecvéƒ½å¯ä»¥ä½œä¸ºselectè¯­å¥çš„case clauseï¼Œå¦‚ä¸‹é¢çš„ä¾‹å­ï¼š</p><pre><code>func main() {\n    var ch = make(chan int, 10)\n    for i := 0; i &lt; 10; i++ {\n        select {\n        case ch &lt;- i:\n        case v := &lt;-ch:\n            fmt.Println(v)\n        }\n    }\n}\n</code></pre><p>chanè¿˜å¯ä»¥åº”ç”¨äºfor-rangeè¯­å¥ä¸­ï¼Œæ¯”å¦‚ï¼š</p><pre><code>    for v := range ch {\n        fmt.Println(v)\n    }\n</code></pre><p>æˆ–è€…æ˜¯å¿½ç•¥è¯»å–çš„å€¼ï¼Œåªæ˜¯æ¸…ç©ºchanï¼š</p><pre><code>    for range ch {\n    }\n</code></pre><p>å¥½äº†ï¼Œåˆ°è¿™é‡Œï¼ŒChannelçš„åŸºæœ¬ç”¨æ³•ï¼Œæˆ‘ä»¬å°±å­¦å®Œäº†ã€‚ä¸‹é¢æˆ‘ä»ä»£ç å®ç°çš„è§’åº¦åˆ†æchanç±»å‹çš„å®ç°ã€‚æ¯•ç«Ÿï¼Œåªæœ‰æŒæ¡äº†åŸç†ï¼Œä½ æ‰èƒ½çœŸæ­£åœ°ç”¨å¥½å®ƒã€‚</p><h1>Channelçš„å®ç°åŸç†</h1><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä¼šç»™ä½ ä»‹ç»chançš„æ•°æ®ç»“æ„ã€åˆå§‹åŒ–çš„æ–¹æ³•ä»¥åŠä¸‰ä¸ªé‡è¦çš„æ“ä½œæ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯sendã€recvå’Œcloseã€‚é€šè¿‡å­¦ä¹ Channelçš„åº•å±‚å®ç°ï¼Œä½ ä¼šå¯¹Channelçš„åŠŸèƒ½å’Œå¼‚å¸¸æƒ…å†µæœ‰æ›´æ·±çš„ç†è§£ã€‚</p><h2>chanæ•°æ®ç»“æ„</h2><p>chanç±»å‹çš„æ•°æ®ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå®ƒçš„æ•°æ®ç±»å‹æ˜¯<a href=\"https://github.com/golang/go/blob/master/src/runtime/chan.go#L32\">runtime.hchan</a>ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/81/dd/81304c1f1845d21c66195798b6ba48dd.jpg?wh=2334*2250\" alt=\"\"></p><p>ä¸‹é¢æˆ‘æ¥å…·ä½“è§£é‡Šå„ä¸ªå­—æ®µçš„æ„ä¹‰ã€‚</p><ul>\n<li>qcountï¼šä»£è¡¨chanä¸­å·²ç»æ¥æ”¶ä½†è¿˜æ²¡è¢«å–èµ°çš„å…ƒç´ çš„ä¸ªæ•°ã€‚å†…å»ºå‡½æ•°lenå¯ä»¥è¿”å›è¿™ä¸ªå­—æ®µçš„å€¼ã€‚</li>\n<li>dataqsizï¼šé˜Ÿåˆ—çš„å¤§å°ã€‚chanä½¿ç”¨ä¸€ä¸ªå¾ªç¯é˜Ÿåˆ—æ¥å­˜æ”¾å…ƒç´ ï¼Œå¾ªç¯é˜Ÿåˆ—å¾ˆé€‚åˆè¿™ç§ç”Ÿäº§è€…-æ¶ˆè´¹è€…çš„åœºæ™¯ï¼ˆæˆ‘å¾ˆå¥½å¥‡ä¸ºä»€ä¹ˆè¿™ä¸ªå­—æ®µçœç•¥sizeä¸­çš„eï¼‰ã€‚</li>\n<li>bufï¼šå­˜æ”¾å…ƒç´ çš„å¾ªç¯é˜Ÿåˆ—çš„bufferã€‚</li>\n<li>elemtypeå’Œelemsizeï¼šchanä¸­å…ƒç´ çš„ç±»å‹å’Œsizeã€‚å› ä¸ºchanä¸€æ—¦å£°æ˜ï¼Œå®ƒçš„å…ƒç´ ç±»å‹æ˜¯å›ºå®šçš„ï¼Œå³æ™®é€šç±»å‹æˆ–è€…æŒ‡é’ˆç±»å‹ï¼Œæ‰€ä»¥å…ƒç´ å¤§å°ä¹Ÿæ˜¯å›ºå®šçš„ã€‚</li>\n<li>sendxï¼šå¤„ç†å‘é€æ•°æ®çš„æŒ‡é’ˆåœ¨bufä¸­çš„ä½ç½®ã€‚ä¸€æ—¦æ¥æ”¶äº†æ–°çš„æ•°æ®ï¼ŒæŒ‡é’ˆå°±ä¼šåŠ ä¸Šelemsizeï¼Œç§»å‘ä¸‹ä¸€ä¸ªä½ç½®ã€‚bufçš„æ€»å¤§å°æ˜¯elemsizeçš„æ•´æ•°å€ï¼Œè€Œä¸”bufæ˜¯ä¸€ä¸ªå¾ªç¯åˆ—è¡¨ã€‚</li>\n<li>recvxï¼šå¤„ç†æ¥æ”¶è¯·æ±‚æ—¶çš„æŒ‡é’ˆåœ¨bufä¸­çš„ä½ç½®ã€‚ä¸€æ—¦å–å‡ºæ•°æ®ï¼Œæ­¤æŒ‡é’ˆä¼šç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªä½ç½®ã€‚</li>\n<li>recvqï¼šchanæ˜¯å¤šç”Ÿäº§è€…å¤šæ¶ˆè´¹è€…çš„æ¨¡å¼ï¼Œå¦‚æœæ¶ˆè´¹è€…å› ä¸ºæ²¡æœ‰æ•°æ®å¯è¯»è€Œè¢«é˜»å¡äº†ï¼Œå°±ä¼šè¢«åŠ å…¥åˆ°recvqé˜Ÿåˆ—ä¸­ã€‚</li>\n<li>sendqï¼šå¦‚æœç”Ÿäº§è€…å› ä¸ºbufæ»¡äº†è€Œé˜»å¡ï¼Œä¼šè¢«åŠ å…¥åˆ°sendqé˜Ÿåˆ—ä¸­ã€‚</li>\n</ul><h2>åˆå§‹åŒ–</h2><p>Goåœ¨ç¼–è¯‘çš„æ—¶å€™ï¼Œä¼šæ ¹æ®å®¹é‡çš„å¤§å°é€‰æ‹©è°ƒç”¨makechan64ï¼Œè¿˜æ˜¯makechanã€‚</p><p>ä¸‹é¢çš„ä»£ç æ˜¯å¤„ç†make chançš„é€»è¾‘ï¼Œå®ƒä¼šå†³å®šæ˜¯ä½¿ç”¨makechanè¿˜æ˜¯makechan64æ¥å®ç°chançš„åˆå§‹åŒ–ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/e9/d7/e96f2fee0633c8157a88b8b725f702d7.png?wh=1137*489\" alt=\"\"></p><p><strong>æˆ‘ä»¬åªå…³æ³¨makechanå°±å¥½äº†ï¼Œå› ä¸ºmakechan64åªæ˜¯åšäº†sizeæ£€æŸ¥ï¼Œåº•å±‚è¿˜æ˜¯è°ƒç”¨makechanå®ç°çš„</strong>ã€‚makechançš„ç›®æ ‡å°±æ˜¯ç”Ÿæˆhchanå¯¹è±¡ã€‚</p><p>é‚£ä¹ˆï¼Œæ¥ä¸‹æ¥ï¼Œå°±è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹makechançš„ä¸»è¦é€»è¾‘ã€‚ä¸»è¦çš„é€»è¾‘æˆ‘éƒ½åŠ ä¸Šäº†æ³¨é‡Šï¼Œå®ƒä¼šæ ¹æ®chançš„å®¹é‡çš„å¤§å°å’Œå…ƒç´ çš„ç±»å‹ä¸åŒï¼Œåˆå§‹åŒ–ä¸åŒçš„å­˜å‚¨ç©ºé—´ï¼š</p><pre><code>func makechan(t *chantype, size int) *hchan {\n\t\telem := t.elem\n\t\n        // ç•¥å»æ£€æŸ¥ä»£ç \n        mem, overflow := math.MulUintptr(elem.size, uintptr(size))\n        \n\t\t//\n\t\tvar c *hchan\n\t\tswitch {\n\t\tcase mem == 0:\n\t\t\t// chançš„sizeæˆ–è€…å…ƒç´ çš„sizeæ˜¯0ï¼Œä¸å¿…åˆ›å»ºbuf\n\t\t\tc = (*hchan)(mallocgc(hchanSize, nil, true))\n\t\t\tc.buf = c.raceaddr()\n\t\tcase elem.ptrdata == 0:\n\t\t\t// å…ƒç´ ä¸æ˜¯æŒ‡é’ˆï¼Œåˆ†é…ä¸€å—è¿ç»­çš„å†…å­˜ç»™hchanæ•°æ®ç»“æ„å’Œbuf\n\t\t\tc = (*hchan)(mallocgc(hchanSize+mem, nil, true))\n            // hchanæ•°æ®ç»“æ„åé¢ç´§æ¥ç€å°±æ˜¯buf\n\t\t\tc.buf = add(unsafe.Pointer(c), hchanSize)\n\t\tdefault:\n\t\t\t// å…ƒç´ åŒ…å«æŒ‡é’ˆï¼Œé‚£ä¹ˆå•ç‹¬åˆ†é…buf\n\t\t\tc = new(hchan)\n\t\t\tc.buf = mallocgc(mem, elem, true)\n\t\t}\n\t\n        // å…ƒç´ å¤§å°ã€ç±»å‹ã€å®¹é‡éƒ½è®°å½•ä¸‹æ¥\n\t\tc.elemsize = uint16(elem.size)\n\t\tc.elemtype = elem\n\t\tc.dataqsiz = uint(size)\n\t\tlockInit(&amp;c.lock, lockRankHchan)\n\n\t\treturn c\n\t}\n</code></pre><p>æœ€ç»ˆï¼Œé’ˆå¯¹ä¸åŒçš„å®¹é‡å’Œå…ƒç´ ç±»å‹ï¼Œè¿™æ®µä»£ç åˆ†é…äº†ä¸åŒçš„å¯¹è±¡æ¥åˆå§‹åŒ–hchanå¯¹è±¡çš„å­—æ®µï¼Œè¿”å›hchanå¯¹è±¡ã€‚</p><h2>send</h2><p>Goåœ¨ç¼–è¯‘å‘é€æ•°æ®ç»™chançš„æ—¶å€™ï¼Œä¼šæŠŠsendè¯­å¥è½¬æ¢æˆchansend1å‡½æ•°ï¼Œchansend1å‡½æ•°ä¼šè°ƒç”¨chansendï¼Œæˆ‘ä»¬åˆ†æ®µå­¦ä¹ å®ƒçš„é€»è¾‘ï¼š</p><pre><code>func chansend1(c *hchan, elem unsafe.Pointer) {\n\t\tchansend(c, elem, true, getcallerpc())\n}\nfunc chansend(c *hchan, ep unsafe.Pointer, block bool, callerpc uintptr) bool {\n        // ç¬¬ä¸€éƒ¨åˆ†\n\t\tif c == nil {\n\t\t\tif !block {\n\t\t\t\treturn false\n\t\t\t}\n\t\t\tgopark(nil, nil, waitReasonChanSendNilChan, traceEvGoStop, 2)\n\t\t\tthrow(&quot;unreachable&quot;)\n\t\t}\n\t    ......\n\t}\n</code></pre><p>æœ€å¼€å§‹ï¼Œç¬¬ä¸€éƒ¨åˆ†æ˜¯è¿›è¡Œåˆ¤æ–­ï¼šå¦‚æœchanæ˜¯nilçš„è¯ï¼Œå°±æŠŠè°ƒç”¨è€…goroutine parkï¼ˆé˜»å¡ä¼‘çœ ï¼‰ï¼Œ è°ƒç”¨è€…å°±æ°¸è¿œè¢«é˜»å¡ä½äº†ï¼Œæ‰€ä»¥ï¼Œç¬¬11è¡Œæ˜¯ä¸å¯èƒ½æ‰§è¡Œåˆ°çš„ä»£ç ã€‚</p><pre><code>\t// ç¬¬äºŒéƒ¨åˆ†ï¼Œå¦‚æœchanæ²¡æœ‰è¢«close,å¹¶ä¸”chanæ»¡äº†ï¼Œç›´æ¥è¿”å›\n    if !block &amp;&amp; c.closed == 0 &amp;&amp; full(c) {\n\t\t\treturn false\n\t}\n</code></pre><p>ç¬¬äºŒéƒ¨åˆ†çš„é€»è¾‘æ˜¯å½“ä½ å¾€ä¸€ä¸ªå·²ç»æ»¡äº†çš„chanå®ä¾‹å‘é€æ•°æ®æ—¶ï¼Œå¹¶ä¸”æƒ³ä¸é˜»å¡å½“å‰è°ƒç”¨ï¼Œé‚£ä¹ˆè¿™é‡Œçš„é€»è¾‘æ˜¯ç›´æ¥è¿”å›ã€‚chansend1æ–¹æ³•åœ¨è°ƒç”¨chansendçš„æ—¶å€™è®¾ç½®äº†é˜»å¡å‚æ•°ï¼Œæ‰€ä»¥ä¸ä¼šæ‰§è¡Œåˆ°ç¬¬äºŒéƒ¨åˆ†çš„åˆ†æ”¯é‡Œã€‚</p><pre><code>\t// ç¬¬ä¸‰éƒ¨åˆ†ï¼Œchanå·²ç»è¢«closeçš„æƒ…æ™¯\n    lock(&amp;c.lock) // å¼€å§‹åŠ é”\n    if c.closed != 0 {\n\t\t\tunlock(&amp;c.lock)\n\t\t\tpanic(plainError(&quot;send on closed channel&quot;))\n\t}\n</code></pre><p>ç¬¬ä¸‰éƒ¨åˆ†æ˜¾ç¤ºçš„æ˜¯ï¼Œå¦‚æœchanå·²ç»è¢«closeäº†ï¼Œå†å¾€é‡Œé¢å‘é€æ•°æ®çš„è¯ä¼španicã€‚</p><pre><code>\t    // ç¬¬å››éƒ¨åˆ†ï¼Œä»æ¥æ”¶é˜Ÿåˆ—ä¸­å‡ºé˜Ÿä¸€ä¸ªç­‰å¾…çš„receiver\n        if sg := c.recvq.dequeue(); sg != nil {\n\t\t\t// \n\t\t\tsend(c, sg, ep, func() { unlock(&amp;c.lock) }, 3)\n\t\t\treturn true\n\t\t}\n</code></pre><p>ç¬¬å››éƒ¨åˆ†ï¼Œå¦‚æœç­‰å¾…é˜Ÿåˆ—ä¸­æœ‰ç­‰å¾…çš„receiverï¼Œé‚£ä¹ˆè¿™æ®µä»£ç å°±æŠŠå®ƒä»é˜Ÿåˆ—ä¸­å¼¹å‡ºï¼Œç„¶åç›´æ¥æŠŠæ•°æ®äº¤ç»™å®ƒï¼ˆé€šè¿‡memmove(dst, src, t.size)ï¼‰ï¼Œè€Œä¸éœ€è¦æ”¾å…¥åˆ°bufä¸­ï¼Œé€Ÿåº¦å¯ä»¥æ›´å¿«ä¸€äº›ã€‚</p><pre><code>\t  // ç¬¬äº”éƒ¨åˆ†ï¼Œbufè¿˜æ²¡æ»¡\n      if c.qcount &lt; c.dataqsiz {\n\t\t\tqp := chanbuf(c, c.sendx)\n\t\t\tif raceenabled {\n\t\t\t\traceacquire(qp)\n\t\t\t\tracerelease(qp)\n\t\t\t}\n\t\t\ttypedmemmove(c.elemtype, qp, ep)\n\t\t\tc.sendx++\n\t\t\tif c.sendx == c.dataqsiz {\n\t\t\t\tc.sendx = 0\n\t\t\t}\n\t\t\tc.qcount++\n\t\t\tunlock(&amp;c.lock)\n\t\t\treturn true\n\t\t}\n</code></pre><p>ç¬¬äº”éƒ¨åˆ†è¯´æ˜å½“å‰æ²¡æœ‰receiverï¼Œéœ€è¦æŠŠæ•°æ®æ”¾å…¥åˆ°bufä¸­ï¼Œæ”¾å…¥ä¹‹åï¼Œå°±æˆåŠŸè¿”å›äº†ã€‚</p><pre><code>\t    // ç¬¬å…­éƒ¨åˆ†ï¼Œbufæ»¡ã€‚\n        // chansend1ä¸ä¼šè¿›å…¥ifå—é‡Œï¼Œå› ä¸ºchansend1çš„block=true\n        if !block {\n\t\t\tunlock(&amp;c.lock)\n\t\t\treturn false\n\t\t}\n        ......\n</code></pre><p>ç¬¬å…­éƒ¨åˆ†æ˜¯å¤„ç†bufæ»¡çš„æƒ…å†µã€‚å¦‚æœbufæ»¡äº†ï¼Œå‘é€è€…çš„goroutineå°±ä¼šåŠ å…¥åˆ°å‘é€è€…çš„ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œç›´åˆ°è¢«å”¤é†’ã€‚è¿™ä¸ªæ—¶å€™ï¼Œæ•°æ®æˆ–è€…è¢«å–èµ°äº†ï¼Œæˆ–è€…chanè¢«closeäº†ã€‚</p><h2>recv</h2><p>åœ¨å¤„ç†ä»chanä¸­æ¥æ”¶æ•°æ®æ—¶ï¼ŒGoä¼šæŠŠä»£ç è½¬æ¢æˆchanrecv1å‡½æ•°ï¼Œå¦‚æœè¦è¿”å›ä¸¤ä¸ªè¿”å›å€¼ï¼Œä¼šè½¬æ¢æˆchanrecv2ï¼Œchanrecv1å‡½æ•°å’Œchanrecv2ä¼šè°ƒç”¨chanrecvã€‚æˆ‘ä»¬åˆ†æ®µå­¦ä¹ å®ƒçš„é€»è¾‘ï¼š</p><pre><code>    func chanrecv1(c *hchan, elem unsafe.Pointer) {\n\t\tchanrecv(c, elem, true)\n\t}\n\tfunc chanrecv2(c *hchan, elem unsafe.Pointer) (received bool) {\n\t\t_, received = chanrecv(c, elem, true)\n\t\treturn\n\t}\n\n    func chanrecv(c *hchan, ep unsafe.Pointer, block bool) (selected, received bool) {\n        // ç¬¬ä¸€éƒ¨åˆ†ï¼Œchanä¸ºnil\n\t\tif c == nil {\n\t\t\tif !block {\n\t\t\t\treturn\n\t\t\t}\n\t\t\tgopark(nil, nil, waitReasonChanReceiveNilChan, traceEvGoStop, 2)\n\t\t\tthrow(&quot;unreachable&quot;)\n\t\t}\n</code></pre><p>chanrecv1å’Œchanrecv2ä¼ å…¥çš„blockå‚æ•°çš„å€¼æ˜¯trueï¼Œéƒ½æ˜¯é˜»å¡æ–¹å¼ï¼Œæ‰€ä»¥æˆ‘ä»¬åˆ†æchanrecvçš„å®ç°çš„æ—¶å€™ï¼Œä¸è€ƒè™‘block=falseçš„æƒ…å†µã€‚</p><p>ç¬¬ä¸€éƒ¨åˆ†æ˜¯chanä¸ºnilçš„æƒ…å†µã€‚å’Œsendä¸€æ ·ï¼Œä»nil chanä¸­æ¥æ”¶ï¼ˆè¯»å–ã€è·å–ï¼‰æ•°æ®æ—¶ï¼Œè°ƒç”¨è€…ä¼šè¢«æ°¸è¿œé˜»å¡ã€‚</p><pre><code>\t// ç¬¬äºŒéƒ¨åˆ†, block=falseä¸”cä¸ºç©º\n    if !block &amp;&amp; empty(c) {\n      ......\n    }\n</code></pre><p>ç¬¬äºŒéƒ¨åˆ†ä½ å¯ä»¥ç›´æ¥å¿½ç•¥ï¼Œå› ä¸ºä¸æ˜¯æˆ‘ä»¬è¿™æ¬¡è¦åˆ†æçš„åœºæ™¯ã€‚</p><pre><code>        // åŠ é”ï¼Œè¿”å›æ—¶é‡Šæ”¾é”\n\t    lock(&amp;c.lock)\n\t    // ç¬¬ä¸‰éƒ¨åˆ†ï¼Œcå·²ç»è¢«close,ä¸”chanä¸ºç©ºempty\n\t\tif c.closed != 0 &amp;&amp; c.qcount == 0 {\n\t\t\tunlock(&amp;c.lock)\n\t\t\tif ep != nil {\n\t\t\t\ttypedmemclr(c.elemtype, ep)\n\t\t\t}\n\t\t\treturn true, false\n\t\t}\n</code></pre><p>ç¬¬ä¸‰éƒ¨åˆ†æ˜¯chanå·²ç»è¢«closeçš„æƒ…å†µã€‚å¦‚æœchanå·²ç»è¢«closeäº†ï¼Œå¹¶ä¸”é˜Ÿåˆ—ä¸­æ²¡æœ‰ç¼“å­˜çš„å…ƒç´ ï¼Œé‚£ä¹ˆè¿”å›trueã€falseã€‚</p><pre><code>\t    // ç¬¬å››éƒ¨åˆ†ï¼Œå¦‚æœsendqé˜Ÿåˆ—ä¸­æœ‰ç­‰å¾…å‘é€çš„sender\n        if sg := c.sendq.dequeue(); sg != nil {\n\t\t\trecv(c, sg, ep, func() { unlock(&amp;c.lock) }, 3)\n\t\t\treturn true, true\n\t\t}\n</code></pre><p>ç¬¬å››éƒ¨åˆ†æ˜¯å¤„ç†bufæ»¡çš„æƒ…å†µã€‚è¿™ä¸ªæ—¶å€™ï¼Œå¦‚æœæ˜¯unbufferçš„chanï¼Œå°±ç›´æ¥å°†senderçš„æ•°æ®å¤åˆ¶ç»™receiverï¼Œå¦åˆ™å°±ä»é˜Ÿåˆ—å¤´éƒ¨è¯»å–ä¸€ä¸ªå€¼ï¼Œå¹¶æŠŠè¿™ä¸ªsenderçš„å€¼åŠ å…¥åˆ°é˜Ÿåˆ—å°¾éƒ¨ã€‚</p><pre><code>      // ç¬¬äº”éƒ¨åˆ†, æ²¡æœ‰ç­‰å¾…çš„sender, bufä¸­æœ‰æ•°æ®\n\t  if c.qcount &gt; 0 {\n\t\t\tqp := chanbuf(c, c.recvx)\n\t\t\tif ep != nil {\n\t\t\t\ttypedmemmove(c.elemtype, ep, qp)\n\t\t\t}\n\t\t\ttypedmemclr(c.elemtype, qp)\n\t\t\tc.recvx++\n\t\t\tif c.recvx == c.dataqsiz {\n\t\t\t\tc.recvx = 0\n\t\t\t}\n\t\t\tc.qcount--\n\t\t\tunlock(&amp;c.lock)\n\t\t\treturn true, true\n\t\t}\n\n\t\tif !block {\n\t\t\tunlock(&amp;c.lock)\n\t\t\treturn false, false\n\t\t}\n\n        // ç¬¬å…­éƒ¨åˆ†ï¼Œ bufä¸­æ²¡æœ‰å…ƒç´ ï¼Œé˜»å¡\n        ......\n</code></pre><p>ç¬¬äº”éƒ¨åˆ†æ˜¯å¤„ç†æ²¡æœ‰ç­‰å¾…çš„senderçš„æƒ…å†µã€‚è¿™ä¸ªæ˜¯å’Œchansendå…±ç”¨ä¸€æŠŠå¤§é”ï¼Œæ‰€ä»¥ä¸ä¼šæœ‰å¹¶å‘çš„é—®é¢˜ã€‚å¦‚æœbufæœ‰å…ƒç´ ï¼Œå°±å–å‡ºä¸€ä¸ªå…ƒç´ ç»™receiverã€‚</p><p>ç¬¬å…­éƒ¨åˆ†æ˜¯å¤„ç†bufä¸­æ²¡æœ‰å…ƒç´ çš„æƒ…å†µã€‚å¦‚æœæ²¡æœ‰å…ƒç´ ï¼Œé‚£ä¹ˆå½“å‰çš„receiverå°±ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°å®ƒä»senderä¸­æ¥æ”¶äº†æ•°æ®ï¼Œæˆ–è€…æ˜¯chanè¢«closeï¼Œæ‰è¿”å›ã€‚</p><h2>close</h2><p>é€šè¿‡closeå‡½æ•°ï¼Œå¯ä»¥æŠŠchanå…³é—­ï¼Œç¼–è¯‘å™¨ä¼šæ›¿æ¢æˆclosechanæ–¹æ³•çš„è°ƒç”¨ã€‚</p><p>ä¸‹é¢çš„ä»£ç æ˜¯close chançš„ä¸»è¦é€»è¾‘ã€‚å¦‚æœchanä¸ºnilï¼Œcloseä¼španicï¼›å¦‚æœchanå·²ç»closedï¼Œå†æ¬¡closeä¹Ÿä¼španicã€‚å¦åˆ™çš„è¯ï¼Œå¦‚æœchanä¸ä¸ºnilï¼Œchanä¹Ÿæ²¡æœ‰closedï¼Œå°±æŠŠç­‰å¾…é˜Ÿåˆ—ä¸­çš„senderï¼ˆwriterï¼‰å’Œreceiverï¼ˆreaderï¼‰ä»é˜Ÿåˆ—ä¸­å…¨éƒ¨ç§»é™¤å¹¶å”¤é†’ã€‚</p><p>ä¸‹é¢çš„ä»£ç å°±æ˜¯close chançš„é€»è¾‘:</p><pre><code>    func closechan(c *hchan) {\n\t\tif c == nil { // chanä¸ºnil, panic\n\t\t\tpanic(plainError(&quot;close of nil channel&quot;))\n\t\t}\n\t\n\t\tlock(&amp;c.lock)\n\t\tif c.closed != 0 {// chanå·²ç»closed, panic\n\t\t\tunlock(&amp;c.lock)\n\t\t\tpanic(plainError(&quot;close of closed channel&quot;))\n\t\t}\n\n\t\tc.closed = 1\t\n\n\t\tvar glist gList\n\n\t\t// é‡Šæ”¾æ‰€æœ‰çš„reader\n\t\tfor {\n\t\t\tsg := c.recvq.dequeue()\n\t\t\t......\n\t\t\tgp := sg.g\n\t\t\t......\n\t\t\tglist.push(gp)\n\t\t}\n\t\n\t\t// é‡Šæ”¾æ‰€æœ‰çš„writer (å®ƒä»¬ä¼španic)\n\t\tfor {\n\t\t\tsg := c.sendq.dequeue()\n\t\t\t......\n\t\t\tgp := sg.g\n\t\t\t......\n\t\t\tglist.push(gp)\n\t\t}\n\t\tunlock(&amp;c.lock)\n\t\n\t\tfor !glist.empty() {\n\t\t\tgp := glist.pop()\n\t\t\tgp.schedlink = 0\n\t\t\tgoready(gp, 3)\n\t\t}\n\t}\n</code></pre><p>æŒæ¡äº†Channelçš„åŸºæœ¬ç”¨æ³•å’Œå®ç°åŸç†ï¼Œä¸‹é¢æˆ‘å†æ¥ç»™ä½ è®²ä¸€è®²å®¹æ˜“çŠ¯çš„é”™è¯¯ã€‚ä½ ä¸€å®šè¦è®¤çœŸçœ‹ï¼Œæ¯•ç«Ÿï¼Œè¿™äº›å¯éƒ½æ˜¯å¸®åŠ©ä½ é¿å‘çš„ã€‚</p><h1>ä½¿ç”¨Channelå®¹æ˜“çŠ¯çš„é”™è¯¯</h1><p>æ ¹æ®2019å¹´ç¬¬ä¸€ç¯‡å…¨é¢åˆ†æGoå¹¶å‘Bugçš„<a href=\"https://songlh.github.io/paper/go-study.pdf\">è®ºæ–‡</a>ï¼Œé‚£äº›çŸ¥åçš„Goé¡¹ç›®ä¸­ä½¿ç”¨Channelæ‰€çŠ¯çš„Bugåè€Œæ¯”ä¼ ç»Ÿçš„å¹¶å‘åŸè¯­çš„Bugè¿˜è¦å¤šã€‚ä¸»è¦æœ‰ä¸¤ä¸ªåŸå› ï¼šä¸€ä¸ªæ˜¯ï¼ŒChannelçš„æ¦‚å¿µè¿˜æ¯”è¾ƒæ–°ï¼Œç¨‹åºå‘˜è¿˜ä¸èƒ½å¾ˆå¥½åœ°æŒæ¡ç›¸åº”çš„ä½¿ç”¨æ–¹æ³•å’Œæœ€ä½³å®è·µï¼›ç¬¬äºŒä¸ªæ˜¯ï¼ŒChannelæœ‰æ—¶å€™æ¯”ä¼ ç»Ÿçš„å¹¶å‘åŸè¯­æ›´å¤æ‚ï¼Œä½¿ç”¨èµ·æ¥å¾ˆå®¹æ˜“é¡¾æ­¤å¤±å½¼ã€‚</p><p><strong>ä½¿ç”¨Channelæœ€å¸¸è§çš„é”™è¯¯æ˜¯panicå’Œgoroutineæ³„æ¼</strong>ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥æ€»ç»“ä¸‹ä¼španicçš„æƒ…å†µï¼Œæ€»å…±æœ‰3ç§ï¼š</p><ol>\n<li>closeä¸ºnilçš„chanï¼›</li>\n<li>sendå·²ç»closeçš„chanï¼›</li>\n<li>closeå·²ç»closeçš„chanã€‚</li>\n</ol><p>goroutineæ³„æ¼çš„é—®é¢˜ä¹Ÿå¾ˆå¸¸è§ï¼Œä¸‹é¢çš„ä»£ç ä¹Ÿæ˜¯ä¸€ä¸ªå®é™…é¡¹ç›®ä¸­çš„ä¾‹å­ï¼š</p><pre><code>func process(timeout time.Duration) bool {\n    ch := make(chan bool)\n\n    go func() {\n        // æ¨¡æ‹Ÿå¤„ç†è€—æ—¶çš„ä¸šåŠ¡\n        time.Sleep((timeout + time.Second))\n        ch &lt;- true // block\n        fmt.Println(&quot;exit goroutine&quot;)\n    }()\n    select {\n    case result := &lt;-ch:\n        return result\n    case &lt;-time.After(timeout):\n        return false\n    }\n}\n</code></pre><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œprocesså‡½æ•°ä¼šå¯åŠ¨ä¸€ä¸ªgoroutineï¼Œå»å¤„ç†éœ€è¦é•¿æ—¶é—´å¤„ç†çš„ä¸šåŠ¡ï¼Œå¤„ç†å®Œä¹‹åï¼Œä¼šå‘é€trueåˆ°chanä¸­ï¼Œç›®çš„æ˜¯é€šçŸ¥å…¶å®ƒç­‰å¾…çš„goroutineï¼Œå¯ä»¥ç»§ç»­å¤„ç†äº†ã€‚</p><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ç¬¬10è¡Œåˆ°ç¬¬15è¡Œï¼Œä¸»goroutineæ¥æ”¶åˆ°ä»»åŠ¡å¤„ç†å®Œæˆçš„é€šçŸ¥ï¼Œæˆ–è€…è¶…æ—¶åå°±è¿”å›äº†ã€‚è¿™æ®µä»£ç æœ‰é—®é¢˜å—ï¼Ÿ</p><p>å¦‚æœå‘ç”Ÿè¶…æ—¶ï¼Œprocesså‡½æ•°å°±è¿”å›äº†ï¼Œè¿™å°±ä¼šå¯¼è‡´unbufferedçš„chanä»æ¥å°±æ²¡æœ‰è¢«è¯»å–ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œunbuffered chanå¿…é¡»ç­‰readerå’Œwriteréƒ½å‡†å¤‡å¥½äº†æ‰èƒ½äº¤æµï¼Œå¦åˆ™å°±ä¼šé˜»å¡ã€‚è¶…æ—¶å¯¼è‡´æœªè¯»ï¼Œç»“æœå°±æ˜¯å­goroutineå°±é˜»å¡åœ¨ç¬¬7è¡Œæ°¸è¿œç»“æŸä¸äº†ï¼Œè¿›è€Œå¯¼è‡´goroutineæ³„æ¼ã€‚</p><p>è§£å†³è¿™ä¸ªBugçš„åŠæ³•å¾ˆç®€å•ï¼Œå°±æ˜¯å°†unbuffered chanæ”¹æˆå®¹é‡ä¸º1çš„chanï¼Œè¿™æ ·ç¬¬7è¡Œå°±ä¸ä¼šè¢«é˜»å¡äº†ã€‚</p><p>Goçš„å¼€å‘è€…æåŠ›æ¨èä½¿ç”¨Channelï¼Œä¸è¿‡ï¼Œè¿™ä¸¤å¹´ï¼Œå¤§å®¶æ„è¯†åˆ°ï¼ŒChannelå¹¶ä¸æ˜¯å¤„ç†å¹¶å‘é—®é¢˜çš„â€œé“¶å¼¹â€ï¼Œæœ‰æ—¶å€™ä½¿ç”¨å¹¶å‘åŸè¯­æ›´ç®€å•ï¼Œè€Œä¸”ä¸å®¹æ˜“å‡ºé”™ã€‚æ‰€ä»¥ï¼Œæˆ‘ç»™ä½ æä¾›ä¸€å¥—é€‰æ‹©çš„æ–¹æ³•:</p><ol>\n<li>å…±äº«èµ„æºçš„å¹¶å‘è®¿é—®ä½¿ç”¨ä¼ ç»Ÿå¹¶å‘åŸè¯­ï¼›</li>\n<li>å¤æ‚çš„ä»»åŠ¡ç¼–æ’å’Œæ¶ˆæ¯ä¼ é€’ä½¿ç”¨Channelï¼›</li>\n<li>æ¶ˆæ¯é€šçŸ¥æœºåˆ¶ä½¿ç”¨Channelï¼Œé™¤éåªæƒ³signalä¸€ä¸ªgoroutineï¼Œæ‰ä½¿ç”¨Condï¼›</li>\n<li>ç®€å•ç­‰å¾…æ‰€æœ‰ä»»åŠ¡çš„å®Œæˆç”¨WaitGroupï¼Œä¹Ÿæœ‰Channelçš„æ¨å´‡è€…ç”¨Channelï¼Œéƒ½å¯ä»¥ï¼›</li>\n<li>éœ€è¦å’ŒSelectè¯­å¥ç»“åˆï¼Œä½¿ç”¨Channelï¼›</li>\n<li>éœ€è¦å’Œè¶…æ—¶é…åˆæ—¶ï¼Œä½¿ç”¨Channelå’ŒContextã€‚</li>\n</ol><h1>å®ƒä»¬è¸©è¿‡çš„å‘</h1><p>æ¥ä¸‹æ¥ï¼Œæˆ‘å¸¦ä½ å›´è§‚ä¸‹çŸ¥åGoé¡¹ç›®çš„Channelç›¸å…³çš„Bugã€‚</p><p><a href=\"https://github.com/etcd-io/etcd/pull/6857\">etcd issue 6857</a>æ˜¯ä¸€ä¸ªç¨‹åºhangä½çš„é—®é¢˜ï¼šåœ¨å¼‚å¸¸æƒ…å†µä¸‹ï¼Œæ²¡æœ‰å¾€chanå®ä¾‹ä¸­å¡«å……æ‰€éœ€çš„å…ƒç´ ï¼Œå¯¼è‡´ç­‰å¾…è€…æ°¸è¿œç­‰å¾…ã€‚å…·ä½“æ¥è¯´ï¼ŒStatusæ–¹æ³•çš„é€»è¾‘æ˜¯ç”Ÿæˆä¸€ä¸ªchan Statusï¼Œç„¶åæŠŠè¿™ä¸ªchanäº¤ç»™å…¶å®ƒçš„goroutineå»å¤„ç†å’Œå†™å…¥æ•°æ®ï¼Œæœ€åï¼ŒStatusè¿”å›è·å–çš„çŠ¶æ€ä¿¡æ¯ã€‚</p><p>ä¸å¹¸çš„æ˜¯ï¼Œå¦‚æœæ­£å¥½èŠ‚ç‚¹åœæ­¢äº†ï¼Œæ²¡æœ‰goroutineå»å¡«å……è¿™ä¸ªchanï¼Œä¼šå¯¼è‡´æ–¹æ³•hangåœ¨è¿”å›çš„é‚£ä¸€è¡Œä¸Šï¼ˆä¸‹é¢çš„æˆªå›¾ä¸­çš„ç¬¬466è¡Œï¼‰ã€‚è§£å†³åŠæ³•å°±æ˜¯ï¼Œåœ¨ç­‰å¾…status chanè¿”å›å…ƒç´ çš„åŒæ—¶ï¼Œä¹Ÿæ£€æŸ¥èŠ‚ç‚¹æ˜¯ä¸æ˜¯å·²ç»åœæ­¢äº†ï¼ˆdoneè¿™ä¸ªchanæ˜¯ä¸æ˜¯closeäº†ï¼‰ã€‚</p><p>å½“å‰çš„etcdçš„ä»£ç å°±æ˜¯ä¿®å¤åçš„ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/5f/da/5f3c15c110077714be81be8eb1fd3fda.png?wh=920*481\" alt=\"\"></p><p>å…¶å®ï¼Œæˆ‘æ„Ÿè§‰è¿™ä¸ªä¿®æ”¹è¿˜æ˜¯æœ‰é—®é¢˜çš„ã€‚é—®é¢˜å°±åœ¨äºï¼Œå¦‚æœç¨‹åºæ‰§è¡Œäº†466è¡Œï¼ŒæˆåŠŸåœ°æŠŠcå†™å…¥åˆ°Statuså¾…å¤„ç†é˜Ÿåˆ—åï¼Œæ‰§è¡Œåˆ°ç¬¬467è¡Œæ—¶ï¼Œå¦‚æœåœæ­¢äº†è¿™ä¸ªèŠ‚ç‚¹ï¼Œé‚£ä¹ˆï¼Œè¿™ä¸ªStatusæ–¹æ³•è¿˜æ˜¯ä¼šé˜»å¡åœ¨ç¬¬467è¡Œã€‚ä½ å¯ä»¥è‡ªå·±ç ”ç©¶ç ”ç©¶ï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯è¿™æ ·ã€‚</p><p><a href=\"https://github.com/etcd-io/etcd/issues/5505\">etcd issue 5505</a> è™½ç„¶æ²¡æœ‰ä»»ä½•çš„Bugæè¿°ï¼Œä½†æ˜¯ä»ä¿®å¤å†…å®¹ä¸Šçœ‹ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¾€å·²ç»closeçš„chanå†™æ•°æ®å¯¼è‡´panicçš„é—®é¢˜ã€‚</p><p><a href=\"https://github.com/etcd-io/etcd/issues/11256\">etcd issue 11256</a>  æ˜¯å› ä¸ºunbuffered chan goroutineæ³„æ¼çš„é—®é¢˜ã€‚TestNodeProposeAddLearnerNodeæ–¹æ³•ä¸­ä¸€å¼€å§‹å®šä¹‰äº†ä¸€ä¸ªunbufferedçš„chanï¼Œä¹Ÿå°±æ˜¯applyConfChanï¼Œç„¶åå¯åŠ¨ä¸€ä¸ªå­goroutineï¼Œè¿™ä¸ªå­goroutineä¼šåœ¨å¾ªç¯ä¸­æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼Œå¹¶ä¸”ä¸æ–­åœ°å¾€è¿™ä¸ªchanä¸­æ·»åŠ ä¸€ä¸ªå…ƒç´ ã€‚TestNodeProposeAddLearnerNodeæ–¹æ³•çš„æœ«å°¾å¤„ä¼šä»è¿™ä¸ªchanä¸­è¯»å–ä¸€ä¸ªå…ƒç´ ã€‚</p><p>è¿™æ®µä»£ç åœ¨forå¾ªç¯ä¸­å°±å¾€æ­¤chanä¸­å†™å…¥äº†ä¸€ä¸ªå…ƒç´ ï¼Œç»“æœå¯¼è‡´TestNodeProposeAddLearnerNodeä»è¿™ä¸ªchanä¸­è¯»å–åˆ°å…ƒç´ å°±è¿”å›äº†ã€‚æ‚²å‰§çš„æ˜¯ï¼Œå­goroutineçš„forå¾ªç¯è¿˜åœ¨æ‰§è¡Œï¼Œé˜»å¡åœ¨ä¸‹å›¾ä¸­çº¢è‰²çš„ç¬¬851è¡Œï¼Œå¹¶ä¸”ä¸€ç›´hangåœ¨é‚£é‡Œã€‚</p><p>è¿™ä¸ªBugçš„ä¿®å¤ä¹Ÿå¾ˆç®€å•ï¼Œåªè¦æ”¹åŠ¨ä¸€ä¸‹applyConfChançš„å¤„ç†é€»è¾‘å°±å¯ä»¥äº†ï¼šåªæœ‰å­goroutineçš„forå¾ªç¯ä¸­çš„ä¸»è¦é€»è¾‘å®Œæˆä¹‹åï¼Œæ‰å¾€applyConfChanå‘é€ä¸€ä¸ªå…ƒç´ ï¼Œè¿™æ ·ï¼ŒTestNodeProposeAddLearnerNodeæ”¶åˆ°é€šçŸ¥ç»§ç»­æ‰§è¡Œï¼Œå­goroutineä¹Ÿä¸ä¼šè¢«é˜»å¡ä½äº†ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/d5/9f/d53573c8fc515f78ea590bf73396969f.png?wh=1521*614\" alt=\"\"></p><p><a href=\"https://github.com/etcd-io/etcd/issues/9956\">etcd issue 9956</a> æ˜¯å¾€ä¸€ä¸ªå·²closeçš„chanå‘é€æ•°æ®ï¼Œå…¶å®å®ƒæ˜¯grpcçš„ä¸€ä¸ªbugï¼ˆ<a href=\"https://github.com/grpc/grpc-go/pull/2695\">grpc issue 2695</a>ï¼‰ï¼Œä¿®å¤åŠæ³•å°±æ˜¯ä¸closeè¿™ä¸ªchanå°±å¥½äº†ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/65/21/650f0911b1c7278cc0438c85bbc4yy21.png?wh=1052*185\" alt=\"\"></p><h1>æ€»ç»“</h1><p>chançš„å€¼å’ŒçŠ¶æ€æœ‰å¤šç§æƒ…å†µï¼Œè€Œä¸åŒçš„æ“ä½œï¼ˆsendã€recvã€closeï¼‰åˆå¯èƒ½å¾—åˆ°ä¸åŒçš„ç»“æœï¼Œè¿™æ˜¯ä½¿ç”¨chanç±»å‹æ—¶ç»å¸¸è®©äººå›°æƒ‘çš„åœ°æ–¹ã€‚</p><p>ä¸ºäº†å¸®åŠ©ä½ å¿«é€Ÿåœ°äº†è§£ä¸åŒçŠ¶æ€ä¸‹å„ç§æ“ä½œçš„ç»“æœï¼Œæˆ‘æ€»ç»“äº†ä¸€ä¸ªè¡¨æ ¼ï¼Œä½ ä¸€å®šè¦ç‰¹åˆ«å…³æ³¨ä¸‹é‚£äº›panicçš„æƒ…å†µï¼Œå¦å¤–è¿˜è¦æŒæ¡é‚£äº›ä¼šblockçš„åœºæ™¯ï¼Œå®ƒä»¬æ˜¯å¯¼è‡´æ­»é”æˆ–è€…goroutineæ³„éœ²çš„ç½ªé­ç¥¸é¦–ã€‚</p><p>è¿˜æœ‰ä¸€ä¸ªå€¼å¾—æ³¨æ„çš„ç‚¹æ˜¯ï¼Œåªè¦ä¸€ä¸ªchanè¿˜æœ‰æœªè¯»çš„æ•°æ®ï¼Œå³ä½¿æŠŠå®ƒcloseæ‰ï¼Œä½ è¿˜æ˜¯å¯ä»¥ç»§ç»­æŠŠè¿™äº›æœªè¯»çš„æ•°æ®æ¶ˆè´¹å®Œï¼Œä¹‹åæ‰æ˜¯è¯»å–é›¶å€¼æ•°æ®ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/51/98/5108954ea36559860e5e5aaa42b2f998.jpg?wh=3601*1075\" alt=\"\"></p><h1>æ€è€ƒé¢˜</h1><ol>\n<li>\n<p>æœ‰ä¸€é“ç»å…¸çš„ä½¿ç”¨Channelè¿›è¡Œä»»åŠ¡ç¼–æ’çš„é¢˜ï¼Œä½ å¯ä»¥å°è¯•åšä¸€ä¸‹ï¼šæœ‰å››ä¸ªgoroutineï¼Œç¼–å·ä¸º1ã€2ã€3ã€4ã€‚æ¯ç§’é’Ÿä¼šæœ‰ä¸€ä¸ªgoroutineæ‰“å°å‡ºå®ƒè‡ªå·±çš„ç¼–å·ï¼Œè¦æ±‚ä½ ç¼–å†™ä¸€ä¸ªç¨‹åºï¼Œè®©è¾“å‡ºçš„ç¼–å·æ€»æ˜¯æŒ‰ç…§1ã€2ã€3ã€4ã€1ã€2ã€3ã€4ã€â€¦â€¦çš„é¡ºåºæ‰“å°å‡ºæ¥ã€‚</p>\n</li>\n<li>\n<p>chan T æ˜¯å¦å¯ä»¥ç»™&lt;- chan Tå’Œchan&lt;- Tç±»å‹çš„å˜é‡èµ‹å€¼ï¼Ÿåè¿‡æ¥å‘¢ï¼Ÿ</p>\n</li>\n</ol><p>æ¬¢è¿åœ¨ç•™è¨€åŒºå†™ä¸‹ä½ çš„æ€è€ƒå’Œç­”æ¡ˆï¼Œæˆ‘ä»¬ä¸€èµ·äº¤æµè®¨è®ºã€‚å¦‚æœä½ è§‰å¾—æœ‰æ‰€æ”¶è·ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹æˆ–åŒäº‹ã€‚</p>","neighbors":{"left":{"article_title":"12 | atomicï¼šè¦ä¿è¯åŸå­æ“ä½œï¼Œä¸€å®šè¦ä½¿ç”¨è¿™å‡ ç§æ–¹æ³•","id":304127},"right":{"article_title":"14 | Channelï¼šé€è¿‡ä»£ç çœ‹å…¸å‹çš„åº”ç”¨æ¨¡å¼","id":306614}},"comments":[{"had_liked":false,"id":260008,"user_name":"åšç™½åŒå¼‚","can_delete":false,"product_type":"c1","uid":1375143,"ip_address":"","ucode":"4030C4B64068A6","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/ajZWFgjupJHhmSN3jJ5o9ibecnOQQmJBTxvjwm5ssJjmG1iaNic8XNR6DvZNwIJdjpjkBibicnJYyZUIAnOkw2wwv8w/132","comment_is_top":false,"comment_ctime":1604907309,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"130453926189","product_id":100061801,"comment_content":"æ€è€ƒé¢˜<br>1.<br>func main() {<br>\tch1 := make(chan int)<br>\tch2 := make(chan int)<br>\tch3 := make(chan int)<br>\tch4 := make(chan int)<br>\tgo func() {<br>\t\tfor {<br>\t\t\tfmt.Println(&quot;I&#39;m goroutine 1&quot;)<br>\t\t\ttime.Sleep(1 * time.Second)<br>\t\t\tch2 &lt;-1 &#47;&#47;I&#39;m done, you turn<br>\t\t\t&lt;-ch1<br>\t\t}<br>\t}()<br><br>\tgo func() {<br>\t\tfor {<br>\t\t\t&lt;-ch2<br>\t\t\tfmt.Println(&quot;I&#39;m goroutine 2&quot;)<br>\t\t\ttime.Sleep(1 * time.Second)<br>\t\t\tch3 &lt;-1<br>\t\t}<br><br>\t}()<br><br>\tgo func() {<br>\t\tfor {<br>\t\t\t&lt;-ch3<br>\t\t\tfmt.Println(&quot;I&#39;m goroutine 3&quot;)<br>\t\t\ttime.Sleep(1 * time.Second)<br>\t\t\tch4 &lt;-1<br>\t\t}<br><br>\t}()<br><br>\tgo func() {<br>\t\tfor {<br>\t\t\t&lt;-ch4<br>\t\t\tfmt.Println(&quot;I&#39;m goroutine 4&quot;)<br>\t\t\ttime.Sleep(1 * time.Second)<br>\t\t\tch1 &lt;-1<br>\t\t}<br><br>\t}()<br><br><br><br>\tselect {}<br>}<br>2.åŒå‘é€šé“å¯ä»¥èµ‹å€¼ç»™å•å‘,åè¿‡æ¥ä¸å¯ä»¥.","like_count":30,"discussions":[{"author":{"id":1121588,"avatar":"https://static001.geekbang.org/account/avatar/00/11/1d/34/8201baab.jpg","nickname":"ç«¯è´º","note":"","ucode":"80F1400B138055","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":325511,"discussion_content":"å¯ä»¥æŠŠåé¢3ä¸ªtime#sleepå»æ‰ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1605334942,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":261079,"user_name":"Junes","can_delete":false,"product_type":"c1","uid":1354665,"ip_address":"","ucode":"CD2E829C868970","user_header":"https://static001.geekbang.org/account/avatar/00/14/ab/a9/590d6f02.jpg","comment_is_top":false,"comment_ctime":1605191295,"is_pvip":false,"discussion_count":4,"race_medal":0,"score":"57439766143","product_id":100061801,"comment_content":"ç¬¬ä¸€ä¸ªé—®é¢˜å®ç°çš„æ–¹æ³•æœ‰å¾ˆå¤šï¼Œæœ€å¸¸è§„çš„æ˜¯ç”¨4ä¸ªchannelï¼Œæˆ‘è¿™è¾¹åˆ†äº«ä¸€ä¸ªç”¨å•channelå®ç°çš„æ€è·¯ï¼š<br>å› ä¸ºchannelçš„ç­‰å¾…é˜Ÿåˆ—æ˜¯å…ˆå…¥å…ˆå‡ºçš„ï¼Œæ‰€ä»¥æˆ‘è¿™è¾¹å–å·§åœ°åœ¨goroutineå‰åŠ ä¸€ä¸ªç­‰å¾…æ—¶é—´ï¼Œä¿è¯1~4çš„goroutineï¼Œä»–ä»¬åœ¨åŒä¸ªchané˜»å¡æ—¶æ˜¯æœ‰åºçš„<br><br>func main() {<br>\tch := make(chan struct{})<br>\tfor i := 1; i &lt;= 4; i++ {<br>\t\tgo func(index int) {<br>\t\t\ttime.Sleep(time.Duration(index*10) * time.Millisecond)<br>\t\t\tfor {<br>\t\t\t\t&lt;-ch<br>\t\t\t\tfmt.Printf(&quot;I am No %d Goroutine\\n&quot;, index)<br>\t\t\t\ttime.Sleep(time.Second)<br>\t\t\t\tch &lt;- struct{}{}<br>\t\t\t}<br>\t\t}(i)<br>\t}<br>\tch &lt;- struct{}{}<br>\ttime.Sleep(time.Minute)<br>}","like_count":13,"discussions":[{"author":{"id":2251514,"avatar":"https://static001.geekbang.org/account/avatar/00/22/5a/fa/7ef26657.jpg","nickname":"ğŸ¥","note":"","ucode":"789FEBA6F97E86","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":335825,"discussion_content":"è¿™å¾—ä¿è¯å››ä¸ªgoroutineæŒ‰é¡ºåºæ‰§è¡Œæ‰å¯ä»¥å§ã€‚è¿™æ®µä»£ç ä¿è¯ä¸äº†goroutineæŒ‰1234æ‰§è¡Œ","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1608346107,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1199805,"avatar":"https://static001.geekbang.org/account/avatar/00/12/4e/bd/4b19cda0.jpg","nickname":"å¤§åŠ›","note":"","ucode":"29785E3575761C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2251514,"avatar":"https://static001.geekbang.org/account/avatar/00/22/5a/fa/7ef26657.jpg","nickname":"ğŸ¥","note":"","ucode":"789FEBA6F97E86","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":336434,"discussion_content":"ä¸»è¦ä»–åœ¨æ¯æ¬¡å¾ªç¯è¿­ä»£åéƒ½sleep äº†ï¼Œä¸ç„¶ç¡®å®æ˜¯æ— åºçš„","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1608595496,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":335825,"ip_address":""},"score":336434,"extra":""}]},{"author":{"id":1600340,"avatar":"https://static001.geekbang.org/account/avatar/00/18/6b/54/04866f2e.jpg","nickname":"è•ƒäº†ä¸ªèŒ„","note":"","ucode":"90393ECFF5F0F3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":363716,"discussion_content":"sleepçš„æ—¶é—´æ˜¯è·Ÿç€indexèµ°çš„ï¼Œå¦‚æœéƒ½æ˜¯sleepä¸€æ ·çš„æ—¶é—´ï¼Œç»“æœåº”è¯¥éšæœºçš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617268511,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2226920,"avatar":"https://static001.geekbang.org/account/avatar/00/21/fa/e8/45211b5a.jpg","nickname":"å‡æœŸ","note":"","ucode":"CF6464E859E1F2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":331558,"discussion_content":"å·§å¦™åœ°ç”¨åˆ°äº†receiverä¸­çš„ç­‰å¾…é˜Ÿåˆ—ï¼Œç»™ä½ ç‚¹ä¸ªèµ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606899814,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":261543,"user_name":"ç½—å¸®å¥","can_delete":false,"product_type":"c1","uid":1271773,"ip_address":"","ucode":"8598D116E1FC3C","user_header":"https://static001.geekbang.org/account/avatar/00/13/67/dd/55aa6e07.jpg","comment_is_top":false,"comment_ctime":1605412898,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"44555085858","product_id":100061801,"comment_content":"ä¹‹å‰ä½¿ç”¨go-microæ—¶å€™å°±é‡åˆ°è¿‡ï¼Œunbufferd chanå¯¼è‡´çš„goroutineæ³„éœ²çš„bugï¼Œå½“æ—¶æƒ…å†µæ˜¯å¹¶å‘å‹åŠ›å¤§å¯¼è‡´rpcè°ƒç”¨è¶…æ—¶ï¼Œè¶…æ—¶é€€å‡ºå½“å‰å‡½æ•°å¯¼è‡´äº†goroutineæ³„éœ²ï¼Œgo-microæœ‰ä¸€æ®µç±»ä¼¼çš„ä½¿ç”¨unbuffered chançš„ä»£ç ï¼Œåæ¥æ”¹æˆäº†buffer=1","like_count":10},{"had_liked":false,"id":260764,"user_name":"fhs","can_delete":false,"product_type":"c1","uid":1640934,"ip_address":"","ucode":"941734CC64A296","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJWFdKjyLOXtCzowmdCUFHezNlnux4NPWmYsqETjiaHNbnmb7xdzibDncZqP06nNbpN4AhmD76cpicfw/132","comment_is_top":false,"comment_ctime":1605100607,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"40259806271","product_id":100061801,"comment_content":"func f(i int, input &lt;-chan int, output chan&lt;- int) {<br>\tfor {<br>\t\t&lt;-input<br>\t\tfmt.Println(i)<br>\t\ttime.Sleep(time.Second)<br>\t\toutput &lt;- 1<br>\t}<br>}<br>func TestChannelPlan(t *testing.T) {<br>\tc := [4]chan int{}<br>\tfor i := range []int{1, 2, 3, 4} {<br>\t\tc[i] = make(chan int)<br>\t}<br>\tgo f(1, c[3], c[0])<br>\tgo f(2, c[0], c[1])<br>\tgo f(3, c[1], c[2])<br>\tgo f(4, c[2], c[3])<br>\tc[3] &lt;- 1<br>\tselect {}<br>}<br>","like_count":9},{"had_liked":false,"id":327089,"user_name":"Noir","can_delete":false,"product_type":"c1","uid":1186981,"ip_address":"","ucode":"985D4C4A5E1E85","user_header":"https://static001.geekbang.org/account/avatar/00/12/1c/a5/226ce8a7.jpg","comment_is_top":false,"comment_ctime":1639910265,"is_pvip":false,"replies":[{"id":"119068","content":"å¯¹","user_name":"ä½œè€…å›å¤","comment_id":327089,"uid":"1066613","ip_address":"","utype":1,"ctime":1640046075,"user_name_real":"ç¼–è¾‘"}],"discussion_count":3,"race_medal":0,"score":"31704681337","product_id":100061801,"comment_content":"package main<br><br>import &quot;fmt&quot;<br>import &quot;time&quot;<br><br>func main() {<br>\tchArr := [4]chan struct{} {<br>\t\tmake(chan struct{}),<br>\t\tmake(chan struct{}),<br>\t\tmake(chan struct{}),<br>\t\tmake(chan struct{}),<br>\t}<br><br>\tfor i := 0; i &lt; 4; i++ {<br>\t\tgo func(i int) {<br>\t\t\tfor {<br>\t\t\t\t&lt;- chArr[i % 4]<br>\t\t\t\tfmt.Printf(&quot;i am %d\\n&quot;, i)<br>\t<br>\t\t\t\ttime.Sleep(1 * time.Second)<br>\t\t\t\tchArr[(i + 1) % 4] &lt;- struct{}{}<br>\t\t\t}<br>\t\t}(i)<br>\t}<br><br>\tchArr[0] &lt;- struct{}{}<br>\tselect{}<br>}","like_count":7,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":540357,"discussion_content":"å¯¹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640046075,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":2,"child_discussions":[{"author":{"id":1239066,"avatar":"https://static001.geekbang.org/account/avatar/00/12/e8/1a/bd8fbac0.jpg","nickname":".","note":"","ucode":"423949857434E9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":577335,"discussion_content":"æœ€åçš„selectæœ‰ä»€ä¹ˆç”¨å•Š","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1656040430,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":540357,"ip_address":""},"score":577335,"extra":""},{"author":{"id":2255648,"avatar":"https://static001.geekbang.org/account/avatar/00/22/6b/20/5c8d2d42.jpg","nickname":"åˆ˜å°åœ†","note":"","ucode":"B131E008C42864","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1239066,"avatar":"https://static001.geekbang.org/account/avatar/00/12/e8/1a/bd8fbac0.jpg","nickname":".","note":"","ucode":"423949857434E9","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":591223,"discussion_content":"å¡ä½ä¸è®©mainç»“æŸï¼Œä¸ç„¶ä¸»goroutine ä¸€ç»“æŸå°±å…¨éƒ¨ç»“æŸï¼Œä¸ä¼šæœ‰ä»»ä½•è¾“å‡º","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1666409703,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":577335,"ip_address":"å¹¿è¥¿"},"score":591223,"extra":""}]}]},{"had_liked":false,"id":266056,"user_name":"æ˜Ÿæ˜Ÿä¹‹ç«","can_delete":false,"product_type":"c1","uid":1157566,"ip_address":"","ucode":"98B2A10373A2DE","user_header":"https://static001.geekbang.org/account/avatar/00/11/a9/be/f0b43691.jpg","comment_is_top":false,"comment_ctime":1607152345,"is_pvip":false,"replies":[{"id":"96649","content":"ä¸æ˜¯åŒä¸€ä¸ªï¼Œåªæ˜¯ç±»ä¼¼ã€‚channelä¸­è¿™ä¸ªæ˜¯è¿è¡Œæ—¶å†…éƒ¨ä½¿ç”¨çš„mutex","user_name":"ä½œè€…å›å¤","comment_id":266056,"uid":"1066613","ip_address":"","utype":1,"ctime":1607160105,"user_name_real":"é¸Ÿçª"}],"discussion_count":2,"race_medal":0,"score":"18787021529","product_id":100061801,"comment_content":"channel ä¸­åŒ…å«çš„ mutex æ˜¯ä»€ä¹ˆå‘¢ï¼Œå’Œè¯¾ç¨‹æœ€å¼€å§‹çš„ sync.mutex æ˜¯åŒä¸€ä¸ªä¸œè¥¿å—ï¼Ÿ<br>å› ä¸º sync.mutex æ˜¯ä¾èµ– channel å®ç°çš„ï¼Œæ„Ÿè§‰åº”è¯¥ä¸æ˜¯åŒä¸€ä¸ª mutexï¼Ÿ","like_count":4,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":511134,"discussion_content":"ä¸æ˜¯åŒä¸€ä¸ªï¼Œåªæ˜¯ç±»ä¼¼ã€‚channelä¸­è¿™ä¸ªæ˜¯è¿è¡Œæ—¶å†…éƒ¨ä½¿ç”¨çš„mutex","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1607160105,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1193874,"avatar":"https://static001.geekbang.org/account/avatar/00/12/37/92/961ba560.jpg","nickname":"æˆäººä»¥ğŸŸï¼Œä¸å¦‚æˆäººä»¥æ¸”","note":"","ucode":"BD53829E924B66","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":411847,"discussion_content":"sync.Mutex æ˜¯ä¾èµ– channel å®ç°çš„ï¼Ÿæ²¡çœ‹åˆ° sync.Mutex çš„å®ç°ä¸­æœ‰ channel å‘€ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1636017358,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":260504,"user_name":"Stony.ä¿®è¡Œåƒ§","can_delete":false,"product_type":"c1","uid":1061277,"ip_address":"","ucode":"0F2368F7D93E4A","user_header":"https://static001.geekbang.org/account/avatar/00/10/31/9d/daad92d2.jpg","comment_is_top":false,"comment_ctime":1605042045,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"14489943933","product_id":100061801,"comment_content":"ä¸€ä¸ª goroutine å¯ä»¥æŠŠæ•°æ®çš„â€œæ‰€æœ‰æƒâ€äº¤ç»™å¦å¤–ä¸€ä¸ª goroutineï¼ˆè™½ç„¶ Go ä¸­æ²¡æœ‰â€œæ‰€æœ‰æƒâ€çš„æ¦‚å¿µï¼Œä½†æ˜¯ä»é€»è¾‘ä¸Šè¯´ï¼Œä½ å¯ä»¥æŠŠå®ƒç†è§£ä¸ºæ˜¯æ‰€æœ‰æƒçš„è½¬ç§»ï¼‰<br>è¿™æ˜¯è¦æ¨å¹¿ Rustå•Š","like_count":3},{"had_liked":false,"id":342611,"user_name":"Geek_43dc82","can_delete":false,"product_type":"c1","uid":2753124,"ip_address":"","ucode":"B79FA1C1E94E5A","user_header":"","comment_is_top":false,"comment_ctime":1650363659,"is_pvip":false,"replies":[{"id":"125223","content":"å†™çš„ä¸é”™ï¼Œç®€å•ç›´æ¥","user_name":"ä½œè€…å›å¤","comment_id":342611,"uid":"1066613","ip_address":"","utype":1,"ctime":1650469801,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"10240298251","product_id":100061801,"comment_content":"æˆ‘å®åœ¨æ˜¯å¤ªè ¢äº†ï¼Œåªèƒ½å†™å‡ºè¿™æ ·çš„ä»£ç äº†<br>package main<br><br>import &quot;fmt&quot;<br><br>func main() {<br>\tsignChan1 := make(chan struct{})<br>\tsignChan2 := make(chan struct{})<br>\tsignChan3 := make(chan struct{})<br>\tsignChan4 := make(chan struct{})<br>\tmainSignChan := make(chan struct{})<br><br>\tfor i := 1; i &lt;= 4; i++ {<br>\t\tgo func(i int) {<br>\t\t\tfor {<br>\t\t\t\tselect {<br>\t\t\t\tcase &lt;-signChan1:<br>\t\t\t\t\tfmt.Println(1)<br>\t\t\t\t\tsignChan2 &lt;- struct{}{}<br>\t\t\t\tcase &lt;-signChan2:<br>\t\t\t\t\tfmt.Println(2)<br>\t\t\t\t\tsignChan3 &lt;- struct{}{}<br>\t\t\t\tcase &lt;-signChan3:<br>\t\t\t\t\tfmt.Println(3)<br>\t\t\t\t\tsignChan4 &lt;- struct{}{}<br>\t\t\t\tcase &lt;-signChan4:<br>\t\t\t\t\tfmt.Println(4)<br>\t\t\t\t\tsignChan1 &lt;- struct{}{}<br>\t\t\t\t}<br>\t\t\t}<br>\t\t}(i)<br>\t}<br>\tsignChan1 &lt;- struct{}{}<br>\t&lt;-mainSignChan<br>}<br>","like_count":2,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":565508,"discussion_content":"å†™çš„ä¸é”™ï¼Œç®€å•ç›´æ¥","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1650469801,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":290334,"user_name":"é™Œ","can_delete":false,"product_type":"c1","uid":1152678,"ip_address":"","ucode":"13FF1D4B3181F0","user_header":"https://static001.geekbang.org/account/avatar/00/11/96/a6/aac2a550.jpg","comment_is_top":false,"comment_ctime":1619507686,"is_pvip":true,"replies":[{"id":"105295","content":"ä¼š","user_name":"ä½œè€…å›å¤","comment_id":290334,"uid":"1066613","ip_address":"","utype":1,"ctime":1619623098,"user_name_real":"é¸Ÿçª"}],"discussion_count":1,"race_medal":0,"score":"10209442278","product_id":100061801,"comment_content":"Goroutine æ³„æ¼çš„é‚£ä¸ªä¾‹å­ï¼Œå¦‚æœæŠŠ unbuffered chan æ”¹æˆå®¹é‡ä¸º 1 çš„ buffered chanï¼Œé‚£ä¹ˆå‡å¦‚å‡½æ•°è¶…æ—¶äº†ï¼Œå­ goroutine ä¹Ÿèƒ½å¤Ÿå¾€ channel ä¸­å‘é€æ•°æ®ã€‚é‚£ä¹ˆ GC ä¼šæŠŠè¿™ä¸ª channel å›æ”¶å—?","like_count":2,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":519176,"discussion_content":"ä¼š","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619623098,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":276399,"user_name":"èœ—ç‰›ğŸŒ","can_delete":false,"product_type":"c1","uid":2226557,"ip_address":"","ucode":"F83F22CEB67124","user_header":"https://static001.geekbang.org/account/avatar/00/21/f9/7d/aafe382c.jpg","comment_is_top":false,"comment_ctime":1611910429,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10201845021","product_id":100061801,"comment_content":"channl1 := make(chan int, 0)<br>\tgo func() {<br>\t\tc := time.NewTicker(1 * time.Second)<br>\t\ti := 0<br>\t\tfor {<br>\t\t\tselect {<br>\t\t\tcase &lt;-c.C:<br>\t\t\t\ti++<br>\t\t\t\tchannl1 &lt;- i<br>\t\t\t\tif i == 4 {<br>\t\t\t\t\ti = 0<br>\t\t\t\t}<br>\t\t\t}<br>\t\t}<br>\t}()<br>\tfor {<br>\t\tselect {<br>\t\tcase i := &lt;-channl1:<br>\t\t\tfmt.Println(i)<br>\t\t}<br>\t}","like_count":2},{"had_liked":false,"id":265428,"user_name":"ldeng 7","can_delete":false,"product_type":"c1","uid":1890726,"ip_address":"","ucode":"66B5AA215E57E9","user_header":"https://static001.geekbang.org/account/avatar/00/1c/d9/a6/c97ecf7d.jpg","comment_is_top":false,"comment_ctime":1606895346,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10196829938","product_id":100061801,"comment_content":"å¯¹äº select ç›¸å…³å®ç°çš„æºç ä¸ªäººè®¤ä¸ºè¿˜åº”è¯¥è®²ä¸€ä¸‹","like_count":2},{"had_liked":false,"id":331985,"user_name":"è€çŒ«","can_delete":false,"product_type":"c1","uid":1008270,"ip_address":"","ucode":"7F23297709749A","user_header":"https://static001.geekbang.org/account/avatar/00/0f/62/8e/985cbc25.jpg","comment_is_top":false,"comment_ctime":1642942557,"is_pvip":false,"replies":[{"id":"121326","content":"ğŸ˜ƒ","user_name":"ä½œè€…å›å¤","comment_id":331985,"uid":"1066613","ip_address":"","utype":1,"ctime":1643030203,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"5937909853","product_id":100061801,"comment_content":"func chgoroutine(in,out,stop chan struct{},n int) {<br>\tfor{<br>\t\tselect{<br>\t\t\tcase  &lt;-in:<br>\t\t\t\tfmt.Println(n)<br>\t\t\t\ttime.Sleep(time.Second)<br>\t\t\t\tout &lt;-struct{}{}<br>\t\t\tcase &lt;-stop:<br>\t\t\t\treturn<br>\t\t}<br>\t}<br>}<br><br>func main() {<br>\tch1 := make(chan struct{}, 0)<br>\tch2 := make(chan struct{},0)<br>\tch3 := make(chan struct{},0)<br>\tch4 := make(chan struct{},0)<br>\tstop := make(chan struct{},0)<br><br>\tgo chgoroutine(ch1,ch2,stop,1)<br>\tgo chgoroutine(ch2,ch3,stop,2)<br>\tgo chgoroutine(ch3,ch4,stop,3)<br>\tgo chgoroutine(ch4,ch1,stop,4) <br><br>\tch1 &lt;-struct{}{}<br><br>\ttime.Sleep(time.Second * 20)<br><br>\tstop &lt;-struct{}{}<br>}","like_count":1,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":548102,"discussion_content":"ğŸ˜ƒ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1643030203,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":294416,"user_name":"50%","can_delete":false,"product_type":"c1","uid":1674992,"ip_address":"","ucode":"3E4247B5844B5B","user_header":"https://static001.geekbang.org/account/avatar/00/19/8e/f0/18720510.jpg","comment_is_top":false,"comment_ctime":1621935175,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5916902471","product_id":100061801,"comment_content":"func main() {<br>\tconst n int = 4<br>\tconst maxNum int = 100<br>\tch := make([]chan struct{}, n)<br>\tfor i := range ch {<br>\t\tch[i] = make(chan struct{})<br>\t}<br>\twg := sync.WaitGroup{}<br>\twg.Add(n)<br>\ti := 0<br>\tgo func() {<br>\t\tch[0] &lt;- struct{}{}&#47;&#47;ä¸€ä¸ªå¼€å§‹çš„ä¿¡å·<br>\t}()<br>\tfor j := 0; j &lt; n; j++ {<br>\t\tchanNum := (j + 1) % n<br>\t\tgo func() {<br>\t\t\tdefer wg.Done()<br>\t\t\tfor {<br>\t\t\t\t&lt;-ch[chanNum]<br>\t\t\t\tfmt.Printf(&quot;i am goroutine %d\\n&quot;, chanNum+1)<br>\t\t\t\tfmt.Println(i) &#47;&#47;é¡ºå¸¦ç»ƒä¹ nä¸ªgoroutineäº¤æ›¿æ‰“å° 0 ~ n<br>\t\t\t\tif i &gt;= math.MaxInt64-1 {<br>\t\t\t\t\treturn<br>\t\t\t\t}<br>\t\t\t\ti++<br>\t\t\t\ttime.Sleep(time.Second) &#47;&#47;æ§åˆ¶æ‰“å°é€Ÿç‡<br>\t\t\t\tch[(chanNum+1)%n] &lt;- struct{}{}<br><br>\t\t\t}<br>\t\t}()<br>\t}<br>\twg.Wait()<br>}<br>","like_count":1},{"had_liked":false,"id":280090,"user_name":"butterfly","can_delete":false,"product_type":"c1","uid":1392924,"ip_address":"","ucode":"1B724973303FB0","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/rRCSdTPyqWcW6U8DO9xL55ictNPlbQ38VAcaBNgibqaAhcH7mn1W9ddxIJLlMiaA5sngBicMX02w2HP5pAWpBAJsag/132","comment_is_top":false,"comment_ctime":1614077020,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"5909044316","product_id":100061801,"comment_content":"ä¸€ç›´æœ‰ä¸€ä¸ªç–‘é—®ï¼š channelåº•å±‚ä¹Ÿæ˜¯é€šè¿‡ä¸€ä¸ªmutexä¿æŠ¤ä¸€ä¸ªç¯å½¢é˜Ÿåˆ—ï¼Œè¿™ç§æ–¹å¼å’Œè‡ªå·±é€šè¿‡mutexæ–¹å¼å®ç°çš„å…±äº«èµ„æºè®¿é—®æœ‰ä»€ä¹ˆä¸ä¸€æ ·ï¼Œ å¥½å¤„æ˜¯ä»€ä¹ˆï¼Œæ€§èƒ½æœ‰å¤šå¤§å·®å¼‚ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":350973,"discussion_content":"æœ€åä½ ä¼šå‘ç°ï¼Œä½ å®ç°äº†ä¸€ä¸ªç±»ä¼¼çš„channel","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1614086504,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1310798,"avatar":"https://static001.geekbang.org/account/avatar/00/14/00/4e/be2b206b.jpg","nickname":"å´å°æ™º","note":"","ucode":"C7C9F58B5C9F7B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":381349,"discussion_content":"éšçº¦è®°å¾— channel çš„å®ç°é‡Œæœ‰ goroutine è°ƒåº¦ç›¸å…³çš„é€»è¾‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625020450,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":269126,"user_name":"Atong","can_delete":false,"product_type":"c1","uid":1061005,"ip_address":"","ucode":"7E9D4B8D108E4E","user_header":"https://static001.geekbang.org/account/avatar/00/10/30/8d/a2a4e97e.jpg","comment_is_top":false,"comment_ctime":1608533601,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"5903500897","product_id":100061801,"comment_content":"<br>type NumChan struct {<br>\tjobs []*Job<br>}<br><br>func (n *NumChan) JobNum(m int) {<br>\tfor i := 1; i &lt;= m; i++ {<br>\t\tjob := &amp;Job{<br>\t\t\tID:   i,<br>\t\t\tJobc: make(chan int, 1),<br>\t\t}<br>\t\tgo job.run()<br>\t\tn.jobs = append(n.jobs, job)<br>\t}<br>\tn.run()<br>}<br>func (n *NumChan) run() {<br>\tfor {<br>\t\tn.seq()<br>\t}<br>}<br>func (n *NumChan) seq() {<br>\tfor _, j := range n.jobs {<br>\t\tj.Jobc &lt;- 1<br>\t\ttime.Sleep(time.Second * 1)<br>\t}<br>}<br><br>type Job struct {<br>\tID   int<br>\tJobc chan int<br>}<br><br>func (j *Job) run() {<br>\tfor {<br>\t\tselect {<br>\t\tcase &lt;-j.Jobc:<br>\t\t\tfmt.Printf(&quot;id %d\\n&quot;, j.ID)<br>\t\t}<br>\t}<br>}<br><br>func main() {<br>\tn := &amp;NumChan{}<br>\tn.JobNum(4)<br>}<br>","like_count":1},{"had_liked":false,"id":260969,"user_name":"è™«å­æ¨±æ¡ƒ","can_delete":false,"product_type":"c1","uid":1226331,"ip_address":"","ucode":"F8244A9E9BC5A6","user_header":"https://static001.geekbang.org/account/avatar/00/12/b6/5b/4486e4f9.jpg","comment_is_top":false,"comment_ctime":1605163592,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5900130888","product_id":100061801,"comment_content":"&#47;*<br> * Permission is hereby granted, free of charge, to any person obtaining a copy<br> * of this software and associated documentation files (the &quot;Software&quot;), to deal<br> * in the Software without restriction, including without limitation the rights<br> * to use, copy, modify, merge, publish, distribute, sublicense, and&#47;or sell<br> * copies of the Software, and to permit persons to whom the Software is<br> * furnished to do so, subject to the following conditions:<br> * The above copyright notice and this permission notice shall be included in<br> * all copies or substantial portions of the Software.<br> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR<br> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,<br> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFINGEMENT. IN NO EVENT SHALL THEq<br> * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER<br> * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,<br> * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN<br> * THE SOFTWARE.<br> *&#47;<br><br>package main<br><br>import (<br>\t&quot;fmt&quot;<br>\t&quot;time&quot;<br>)<br><br>type NumberChan struct {<br>\tCh            chan int<br>\tChannelNumber int<br>}<br><br>func (nch *NumberChan) SendNotify() {<br>\tgo func() {<br>\t\tnch.Ch &lt;- nch.ChannelNumber<br>\t}()<br>}<br><br>func (nch *NumberChan) PrintInfo() {<br>\tfmt.Println(nch.ChannelNumber)<br>\ttime.Sleep(time.Second)<br>}<br><br>func NewNumberChan(seq int) *NumberChan {<br>\tnch := NumberChan{<br>\t\tCh:            make(chan int),<br>\t\tChannelNumber: seq,<br>\t}<br>\treturn &amp;nch<br>}<br><br>func main() {<br>\tvar (<br>\t\tnch1 = NewNumberChan(1)<br>\t\tnch2 = NewNumberChan(2)<br>\t\tnch3 = NewNumberChan(3)<br>\t\tnch4 = NewNumberChan(4)<br>\t)<br>\tgo func() {<br>\t\tnch1.SendNotify()<br>\t}()<br>\tfor {<br>\t\tselect {<br>\t\tcase &lt;-nch1.Ch:<br>\t\t\tnch1.PrintInfo()<br>\t\t\tnch2.SendNotify()<br>\t\tcase &lt;-nch2.Ch:<br>\t\t\tnch2.PrintInfo()<br>\t\t\tnch3.SendNotify()<br>\t\tcase &lt;-nch3.Ch:<br>\t\t\tnch3.PrintInfo()<br>\t\t\tnch4.SendNotify()<br>\t\tcase &lt;-nch4.Ch:<br>\t\t\tnch4.PrintInfo()<br>\t\t\tnch1.SendNotify()<br>\t\t}<br>\t}<br><br>}<br>","like_count":1},{"had_liked":false,"id":260202,"user_name":"é‚£æ—¶åˆ»","can_delete":false,"product_type":"c1","uid":1150927,"ip_address":"","ucode":"B0D150856C3A4A","user_header":"https://static001.geekbang.org/account/avatar/00/11/8f/cf/890f82d6.jpg","comment_is_top":false,"comment_ctime":1604940074,"is_pvip":false,"discussion_count":0,"race_medal":1,"score":"5899907370","product_id":100061801,"comment_content":"æ€è€ƒé¢˜1.<br><br>const chanNum int = 4<br>func taskSchedule() {<br>\tchanArr := make([]chan int, chanNum)<br>\tfor i := 0; i &lt; chanNum; i++ {<br>\t\tch := make(chan int, 1)<br>\t\tchanArr[i] = ch<br>\t}<br><br>\tchanArr[0] &lt;- 1<br>\tfor i := 0; i &lt; chanNum; i++ {<br>\t\tnextChanIdx := ( i + 1 ) % chanNum<br>\t\tgo func(cur, next chan int, idx int) {<br>\t\t\tfor {<br>\t\t\t\t&lt;- cur<br>\t\t\t\ttime.Sleep(1 * time.Second)<br>\t\t\t\tfmt.Printf(&quot;%d\\n&quot;, idx + 1)<br>\t\t\t\tnext &lt;- 1<br>\t\t\t}<br>\t\t}(chanArr[i], chanArr[nextChanIdx], i)<br>\t}<br>}","like_count":1},{"had_liked":false,"id":259962,"user_name":"å‡ºå–çµé­‚çš„æ•™ç»ƒKerry","can_delete":false,"product_type":"c1","uid":1807943,"ip_address":"","ucode":"8C64517DA556FE","user_header":"https://static001.geekbang.org/account/avatar/00/1b/96/47/93838ff7.jpg","comment_is_top":false,"comment_ctime":1604897613,"is_pvip":true,"discussion_count":3,"race_medal":0,"score":"5899864909","product_id":100061801,"comment_content":"ä¸€èˆ¬æ¥è¯´ï¼Œå•å‘é€šé“æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1069042,"avatar":"https://static001.geekbang.org/account/avatar/00/10/4f/f2/6ac3bdcf.jpg","nickname":"qingtama","note":"","ucode":"765040243ECE01","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":552475,"discussion_content":"å¦‚æœåªæ˜¯å†™åˆä¸èƒ½è¯»ï¼Œè¿™æœ‰ä»€ä¹ˆç”¨å‘¢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1645491737,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1198953,"avatar":"https://static001.geekbang.org/account/avatar/00/12/4b/69/c02eac91.jpg","nickname":"å¤§æ¼ èƒ¡èåœ","note":"","ucode":"FBE51E4A13EF4F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":326594,"discussion_content":"æˆ‘è§‰å¾—çœŸè¿˜ä¸å¦‚æ²¡æœ‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605622500,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":323779,"discussion_content":"é™åˆ¶ä½¿ç”¨è€…çš„ä½¿ç”¨æ–¹å¼ï¼Œåªèƒ½è¯»æˆ–è€…åªèƒ½å†™","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604995192,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":360198,"user_name":"æ—é’Ÿä¸€","can_delete":false,"product_type":"c1","uid":3200216,"ip_address":"æµ™æ±Ÿ","ucode":"46755D5FC3099A","user_header":"https://static001.geekbang.org/account/avatar/00/30/d4/d8/ee096d57.jpg","comment_is_top":false,"comment_ctime":1666267414,"is_pvip":false,"discussion_count":0,"race_medal":1,"score":"1666267414","product_id":100061801,"comment_content":"package main<br><br>import (<br>\t&quot;fmt&quot;<br>\t&quot;time&quot;<br>)<br><br>func main() {<br>\tnum := make(chan int, 4)<br>\tgo func() {<br>\t\tfor {<br>\t\t\tfor i := 1; i &lt;= 4; i++ {<br>\t\t\t\tnum &lt;- i<br>\t\t\t\ttime.Sleep(time.Second * 1)<br>\t\t\t}<br>\t\t}<br>\t}()<br><br>\tgo func() {<br>\t\tfor {<br>\t\t\tfmt.Println(&lt;-num)<br>\t\t}<br>\t}()<br><br>\tselect {}<br>}<br>æ— é™æ‰“å°1ã€2ã€3ã€4","like_count":0},{"had_liked":false,"id":360027,"user_name":"æ¸…é£","can_delete":false,"product_type":"c1","uid":3199008,"ip_address":"åŒ—äº¬","ucode":"97CC1F43A7EA61","user_header":"https://static001.geekbang.org/account/avatar/00/30/d0/20/dc51f8e7.jpg","comment_is_top":false,"comment_ctime":1666144993,"is_pvip":false,"replies":[{"id":"131005","content":"OK","user_name":"ä½œè€…å›å¤","comment_id":360027,"uid":"1066613","ip_address":"åŒ—äº¬","utype":1,"ctime":1666274554,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"1666144993","product_id":100061801,"comment_content":"func main() {<br>\tchArr := []chan struct{}{<br>\t\tmake(chan struct{}),<br>\t\tmake(chan struct{}),<br>\t\tmake(chan struct{}),<br>\t\tmake(chan struct{}),<br>\t\tmake(chan struct{}),<br>\t\tmake(chan struct{}),<br>\t}<br>\tfor k, _ := range chArr {<br>\t\tif k == len(chArr)-1 {<br>\t\t\tgo goon(chArr[k], chArr[0], k+1)<br>\t\t} else {<br>\t\t\tgo goon(chArr[k], chArr[k+1], k+1)<br>\t\t}<br>\t}<br><br>\tchArr[0] &lt;- struct{}{}<br>\tselect {}<br><br>}<br><br>func goon(ch chan struct{}, ch2 chan struct{}, index int) {<br>\ttime.Sleep(time.Duration(index*10) * time.Millisecond)<br>\tfor {<br>\t\t&lt;-ch<br>\t\tfmt.Printf(&quot;I am No %d Goroutine\\n&quot;, index)<br>\t\ttime.Sleep(time.Second)<br>\t\tch2 &lt;- struct{}{}<br>\t}<br>}<br>","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":591094,"discussion_content":"OK","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1666274554,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":359974,"user_name":"å¼ è§¥","can_delete":false,"product_type":"c1","uid":1341821,"ip_address":"åŒ—äº¬","ucode":"6784E44838EBCA","user_header":"https://static001.geekbang.org/account/avatar/00/14/79/7d/b573c6d9.jpg","comment_is_top":false,"comment_ctime":1666093499,"is_pvip":false,"replies":[{"id":"131006","content":"ä½ è¿™æ ·å¹¶ä¸æ˜¯æ¯ä¸ªgoroutineæ‰“å°è‡ªå·±çš„id","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1066613","ctime":1666274748,"ip_address":"åŒ—äº¬","comment_id":359974,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1666093499","product_id":100061801,"comment_content":"func TestChannel1Practice(t *testing.T) {<br>\tvar ch = make(chan struct{})<br>\twg := sync.WaitGroup{}<br>\twg.Add(4)<br><br>\tgo func() {<br>\t\tch &lt;- struct{}{}<br>\t}()<br><br>\tfor thread := 1; thread &lt;= 4; thread++ {<br>\t\tgo func(thead int) {<br>\t\t\t_, ok := &lt;-ch<br>\t\t\tif ok {<br>\t\t\t\tfor i := 1; i &lt;= 4; i++ {<br>\t\t\t\t\tt.Logf(&quot;%d: %d&quot;, thead, i)<br>\t\t\t\t\ttime.Sleep(1 * time.Second)<br>\t\t\t\t}<br>\t\t\t\twg.Done()<br>\t\t\t\tch &lt;- struct{}{}<br>\t\t\t}<br>\t\t}(thread)<br>\t}<br><br>\twg.Wait()<br>\tt.Log(&quot;finished&quot;)<br>}","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":591095,"discussion_content":"ä½ è¿™æ ·å¹¶ä¸æ˜¯æ¯ä¸ªgoroutineæ‰“å°è‡ªå·±çš„id","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1666274748,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":357605,"user_name":"è‰è‰²é’é’","can_delete":false,"product_type":"c1","uid":1145809,"ip_address":"åŒ—äº¬","ucode":"F346CF962ED330","user_header":"https://static001.geekbang.org/account/avatar/00/11/7b/d1/7eb3b4a4.jpg","comment_is_top":false,"comment_ctime":1663472454,"is_pvip":false,"replies":[{"id":"130220","content":"ğŸ‘ğŸ»","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1066613","ctime":1663598379,"ip_address":"åŒ—äº¬","comment_id":357605,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1663472454","product_id":100061801,"comment_content":"func tt(ctx context.Context, c1, c2 *chan int) {<br>\tfor {<br>\t\tselect {<br>\t\tcase n := &lt;-*c1:<br>\t\t\tfmt.Println(n)<br>\t\t\tnn := n + 1<br>\t\t\tif n == 4 {<br>\t\t\t\tnn = 1<br>\t\t\t}<br>\t\t\t*c2 &lt;- nn<br>\t\t\t&#47;&#47;fmt.Printf(&quot;c1:%p,c2:%p\\n&quot;, c1, c2)<br>\t\tcase &lt;-ctx.Done():<br>\t\t\treturn<br><br>\t\t}<br>\t}<br>}<br>func PrintInfo() {<br>\tctx, cancel := context.WithCancel(context.Background())<br>\tc1, c2, c3, c4 := make(chan int, 2), make(chan int, 2), make(chan int, 2), make(chan int, 2)<br>\tfmt.Printf(&quot;c1:%p,c2:%p,c3:%p,c4:%p\\n&quot;, &amp;c1, &amp;c2, &amp;c3, &amp;c4)<br>\tgo tt(ctx, &amp;c1, &amp;c2)<br>\tgo tt(ctx, &amp;c2, &amp;c3)<br>\tgo tt(ctx, &amp;c3, &amp;c4)<br>\tgo tt(ctx, &amp;c4, &amp;c1)<br>\tc1 &lt;- 1<br><br>\tfmt.Println(&quot;Hello, ä¸–ç•Œ&quot;)<br>\ttime.Sleep(time.Millisecond * 70)<br>\tcancel()<br><br>\tfmt.Println(&quot;Hello, ä¸–ç•Œ&quot;)<br>}","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":588223,"discussion_content":"ğŸ‘ğŸ»","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1663598379,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":338441,"user_name":"Geek_lanehex","can_delete":false,"product_type":"c1","uid":1635941,"ip_address":"","ucode":"4BC1A851F252CC","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/bm90iavKdLVLOzM2rOlYpNCJYylRPGLL4QgJicp5gc3cHNQS98eKfchTkJicLQjn8Ke1uvZPgZtwQslBicUAUsYIYQ/132","comment_is_top":false,"comment_ctime":1647504830,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1647504830","product_id":100061801,"comment_content":"1ã€package main<br><br>import (<br>\t&quot;fmt&quot;<br>\t&quot;time&quot;<br>)<br><br>const n = 4<br><br>func main() {<br>\tvar chanArray = [n]chan int{}<br>\tfor i := 0; i &lt; n; i++ {<br>\t\tchanArray[i] = make(chan int)<br>\t}<br>\tfor i := 0; i &lt; n; i++ {<br>\t\tgo func(ix int) {<br>\t\t\tfor v := range chanArray[ix] {<br>\t\t\t\tfmt.Println(v + 1)<br>\t\t\t}<br>\t\t}(i)<br>\t}<br><br>\tgo func() {<br>\t\tfor i := 0; ; i++ {<br>\t\t\ttime.Sleep(time.Second)<br>\t\t\tchanArray[i%n] &lt;- i % n<br>\t\t}<br>\t}()<br><br>\tfor {<br>\t}<br>}<br>2ã€åŒå‘é€šé“å¯ä»¥èµ‹å€¼ç»™å•å‘é€šé“ï¼Œåä¹‹åˆ™ä¸è¡Œ","like_count":0},{"had_liked":false,"id":337060,"user_name":"å¤","can_delete":false,"product_type":"c1","uid":1010922,"ip_address":"","ucode":"74E6838226A405","user_header":"https://static001.geekbang.org/account/avatar/00/0f/6c/ea/ce9854a5.jpg","comment_is_top":false,"comment_ctime":1646577491,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1646577491","product_id":100061801,"comment_content":"```<br>package main<br><br>import (<br>\t&quot;fmt&quot;<br>\t&quot;os&quot;<br>\t&quot;sync&quot;<br>\t&quot;time&quot;<br>)<br><br>func helper(signal chan int, i int) {<br>\tfor {<br>\t\tsignal &lt;- i<br>\t}<br>}<br>func main() {<br>\tN := 4<br>\tsignals := make([]chan int, N)<br>\tfor i := range signals {<br>\t\tsignals[i] = make(chan int)<br>\t}<br>\tsw := sync.WaitGroup{}<br><br>\tfor i := 0; i &lt; N; i++ {<br>\t\tsw.Add(1)<br>\t\tgo func(i int) {<br>\t\t\tdefer sw.Done()<br>\t\t\thelper(signals[i], i)<br>\t\t}(i)<br><br>\t}<br>\tfor {<br>\t\tfor i := 0; i &lt; N; i++ {<br>\t\t\tfmt.Println(&lt;-signals[i] + 1)<br>\t\t\ttime.Sleep(1 * time.Second)<br>\t\t}<br>\t}<br>\tdefer sw.Wait()<br>\tos.Exit(0)<br>}<br><br>```","like_count":0},{"had_liked":false,"id":333685,"user_name":"xl666","can_delete":false,"product_type":"c1","uid":2046604,"ip_address":"","ucode":"CF9A8086F91053","user_header":"https://static001.geekbang.org/account/avatar/00/1f/3a/8c/fc2c3e5c.jpg","comment_is_top":false,"comment_ctime":1644474254,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1644474254","product_id":100061801,"comment_content":"package main<br><br>import (<br>\t&quot;fmt&quot;<br>\t&quot;sync&quot;<br>\t&quot;time&quot;<br>)<br><br>func chanHadle(first bool, num int, send chan bool, recv chan bool) {<br>\tif first {<br>\t\ttime.Sleep(time.Second)<br>\t\tfmt.Printf(&quot;è¾“å‡º%d \\n&quot;,num)<br>\t\tsend &lt;- true<br>\t}<br>\tfor {<br>\t\t&lt;-recv<br>\t\ttime.Sleep(time.Second)<br>\t\tfmt.Printf(&quot;è¾“å‡º%d \\n&quot;,num)<br>\t\tsend &lt;- true<br>\t}<br><br>}<br><br>func main() {<br>\tvar chan1 chan bool = make(chan bool)<br>\tvar chan2 chan bool = make(chan bool)<br>\tvar chan3 chan bool = make(chan bool)<br>\tvar chan4 chan bool = make(chan bool)<br>\tvar wg sync.WaitGroup<br><br>\twg.Add(4)<br><br>\tgo chanHadle(true,1,chan1,chan4)<br>\tgo chanHadle(false,2,chan2,chan1)<br>\tgo chanHadle(false,3,chan3,chan2)<br>\tgo chanHadle(false,4,chan4,chan3)<br><br>\twg.Wait()<br>}<br>","like_count":0},{"had_liked":false,"id":330866,"user_name":"æˆé•¿æ¯”æˆåŠŸæ›´é‡è¦","can_delete":false,"product_type":"c1","uid":2049063,"ip_address":"","ucode":"090BE5A97E7A8A","user_header":"https://static001.geekbang.org/account/avatar/00/1f/44/27/71bed926.jpg","comment_is_top":false,"comment_ctime":1642234709,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1642234709","product_id":100061801,"comment_content":"ç¬¬ä¸€é¢˜è§£é¢˜æ–¹æ³•å¾ˆå¤šï¼Œä»¥ä¸‹å…¶ä¸­å‚è€ƒç­”æ¡ˆ<br>var ch1 = make(chan bool,1)<br>var ch2 = make(chan bool)<br>func fun1() {<br>\tch1 &lt;- true<br>\tfor i:=1;i&lt;=10;i += 2{<br>\t\t&lt;- ch1<br>\t\tfmt.Print(i)<br>\t\tfmt.Print(i+1,&quot; &quot;)<br>\t\tch2 &lt;- true<br>\t}<br>}<br>func fun2() {<br>\tfor i:=&#39;A&#39;;i&lt;=&#39;J&#39;;i+=2{<br>\t\t&lt;- ch2<br>\t\tfmt.Print(string(i))<br>\t\tfmt.Print(string(i+1),&quot; &quot;)<br>\t\tch1 &lt;- true<br>\t}<br>}<br><br>func main() {<br>\tgo fun1()<br>\tgo fun2()<br>\ttime.Sleep(time.Second)<br>}","like_count":0},{"had_liked":false,"id":327415,"user_name":"Penn","can_delete":false,"product_type":"c1","uid":1107879,"ip_address":"","ucode":"2D73D9C2AED26F","user_header":"https://static001.geekbang.org/account/avatar/00/10/e7/a7/9825371e.jpg","comment_is_top":false,"comment_ctime":1640111145,"is_pvip":false,"replies":[{"id":"119218","content":"å¯ä»¥ã€‚ä»£ç æœ‰é‡å¤ï¼Œè¿˜å¯ä»¥ä¼˜åŒ–ä¸‹","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1066613","ctime":1640185194,"ip_address":"","comment_id":327415,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1640111145","product_id":100061801,"comment_content":"&#47;&#47; 4ä¸ªgoroutine<br>\tch1 := make(chan struct{})<br>\tch2 := make(chan struct{})<br>\tch3 := make(chan struct{})<br>\tch4 := make(chan struct{})<br><br>\tgo func() {<br>\t\tfor {<br>\t\t\t&lt;-ch1<br>\t\t\tfmt.Println(&quot;1&quot;)<br>\t\t\ttime.Sleep(time.Second)<br>\t\t\tch2 &lt;- struct{}{}<br>\t\t\t&#47;&#47; &lt;-ch1<br>\t\t}<br>\t}()<br><br>\tgo func() {<br>\t\tfor {<br>\t\t\t&lt;-ch2<br>\t\t\tfmt.Println(&quot;2&quot;)<br>\t\t\ttime.Sleep(time.Second)<br>\t\t\tch3 &lt;- struct{}{}<br>\t\t}<br>\t}()<br><br>\tgo func() {<br>\t\tfor {<br>\t\t\t&lt;-ch3<br>\t\t\tfmt.Println(&quot;3&quot;)<br>\t\t\ttime.Sleep(time.Second)<br>\t\t\tch4 &lt;- struct{}{}<br>\t\t}<br>\t}()<br><br>\tgo func() {<br>\t\tfor {<br>\t\t\t&lt;-ch4<br>\t\t\tfmt.Println(&quot;4&quot;)<br>\t\t\ttime.Sleep(time.Second)<br>\t\t\tch1 &lt;- struct{}{}<br>\t\t}<br>\t}()<br><br>\tch1 &lt;- struct{}{}<br>\tselect {}","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":540860,"discussion_content":"å¯ä»¥ã€‚ä»£ç æœ‰é‡å¤ï¼Œè¿˜å¯ä»¥ä¼˜åŒ–ä¸‹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640185194,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":322213,"user_name":"jostan","can_delete":false,"product_type":"c1","uid":1045720,"ip_address":"","ucode":"0A46739F079DFB","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f4/d8/f01a9c2b.jpg","comment_is_top":false,"comment_ctime":1637239012,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1637239012","product_id":100061801,"comment_content":"1. ç”¨å››ä¸ª chan, æ¯ä¸ª gorountine å®Œæˆä¹‹åé€šçŸ¥ä¸‹ä¸€ä¸ª<br>```golang<br>func main() {<br>    chans := [4]chan struct{}{}<br>    for i := range chans {<br>        chans[i] = make(chan struct{})<br>    }<br>    task := func(id int) {<br>        c := chans[id-1]<br>        nextC := chans[id%len(chans)]<br>        for {<br>            &lt;-c<br>            fmt.Println(id)<br>            time.Sleep(time.Second)<br>            nextC &lt;- struct{}{}<br>        }<br>    }<br><br>    for i := 1; i &lt;= 4; i++ {<br>        go task(i)<br>    }<br>    chans[0] &lt;- struct{}{}<br>    time.Sleep(100 * time.Second)<br>}<br>```<br>2. åŒå‘é€šé“å¯ä»¥èµ‹å€¼ç»™å•å‘ï¼ˆç›¸å½“äºå…³é—­ä¸€ä¸ªæ–¹å‘ï¼‰ï¼Œåä¹‹ä¸å¯ä»¥","like_count":0},{"had_liked":false,"id":320667,"user_name":"Geek_53efb8","can_delete":false,"product_type":"c1","uid":2598872,"ip_address":"","ucode":"ADC8CFD7C8D16E","user_header":"","comment_is_top":false,"comment_ctime":1636445499,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1636445499","product_id":100061801,"comment_content":"æ€è€ƒé¢˜1 å†™å®Œåå‘ç°çœ‹è¯„è®ºå¥½åƒè·Ÿç¬¬ä¸€ä¸ªåŒå­¦å†™çš„å·®ä¸å¤šã€‚ã€‚ã€‚<br>func main () {<br>\tch1 := make(chan int)<br>\tch2 := make(chan int)<br>\tch3 := make(chan int)<br>\tch4 := make(chan int)<br><br>\tgo func() {<br>\t\tfor  {<br>\t\t\t&lt;-ch1<br>\t\t\tfmt.Println(1)<br>\t\t\tch2 &lt;-1<br>\t\t}<br>\t}()<br>\tgo func() {<br>\t\tfor  {<br>\t\t\t&lt;-ch2<br>\t\t\tfmt.Println(2)<br>\t\t\tch3 &lt;-1<br>\t\t}<br>\t}()<br>\tgo func() {<br>\t\tfor  {<br>\t\t\t&lt;-ch3<br>\t\t\tfmt.Println(3)<br>\t\t\tch4 &lt;- 1<br>\t\t}<br>\t}()<br>\tgo func() {<br>\t\tfor  {<br>\t\t\t&lt;-ch4<br>\t\t\tfmt.Println(4)<br>\t\t}<br>\t}()<br><br>\tfor  {<br>\t\ttime.Sleep(1 * time.Second)<br>\t\tch1 &lt;- 1<br>\t}<br><br>}<br>","like_count":0},{"had_liked":false,"id":318464,"user_name":"ç§¦é»","can_delete":false,"product_type":"c1","uid":2234369,"ip_address":"","ucode":"EC20F60CEBF6A5","user_header":"https://static001.geekbang.org/account/avatar/00/22/18/01/d7b23bf8.jpg","comment_is_top":false,"comment_ctime":1635303365,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1635303365","product_id":100061801,"comment_content":"package main<br><br>import (<br>\t&quot;fmt&quot;<br>\t&quot;time&quot;<br>)<br><br>type Worker struct{}<br><br>&#47;&#47; æŠŠchannel1çš„ä¾‹å­é‡æ–°ç”¨å¦å¤–ä¸€ç§æ–¹å¼æ¥å†™ï¼Œéœ€æ±‚ï¼šæ‰“å°1ï¼Œ2ï¼Œ3ï¼Œ4 å‘¨è€Œå¤å§‹<br><br>func startWorker(workerId int, startWorkChan, nextWorkChan chan Worker) {<br>\tfor {<br>\t\t&#47;&#47; å·¥äººæ¥åˆ°äº†å·¥ä½œ<br>\t\tneedDoWork := &lt;-startWorkChan<br>\t\tfmt.Println(&quot;æ‰“å°---&gt;&quot;, workerId+1)<br>\t\ttime.Sleep(time.Second)<br>\t\t&#47;&#47; å½“å‰å·¥äººç´¯äº†ï¼ŒæŠŠå·¥ä½œäº¤ç»™ä¸‹ä¸€ä¸ªå·¥äºº<br>\t\tnextWorkChan &lt;- needDoWork<br>\t}<br>}<br><br>func main() {<br>\tchs := []chan Worker{make(chan Worker), make(chan Worker), make(chan Worker), make(chan Worker)}<br>\t&#47;&#47; åˆ›å»ºå››ä¸ªå·¥äºº<br>\tvar myWorkerNum = 4<br><br>\t&#47;&#47; ç»™å››ä¸ªå·¥äººåˆ†é…å·¥ä½œ<br>\tfor i := 0; i &lt; myWorkerNum; i++ {<br>\t\tgo startWorker(i, chs[i], chs[(i+1)%myWorkerNum])<br>\t}<br><br>\t&#47;&#47; é¦–å…ˆç»™ç¬¬ä¸€ä¸ªå·¥äººå·¥ä½œå»åšäº‹<br>\tchs[0] &lt;- struct{}{}<br>\tselect {}<br>}<br>","like_count":0},{"had_liked":false,"id":314256,"user_name":"i-neojos","can_delete":false,"product_type":"c1","uid":1702997,"ip_address":"","ucode":"1808C25269948A","user_header":"https://static001.geekbang.org/account/avatar/00/19/fc/55/e03bb6db.jpg","comment_is_top":false,"comment_ctime":1632916190,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1632916190","product_id":100061801,"comment_content":"package main<br><br>import (<br>    &quot;fmt&quot;<br>    &quot;time&quot;<br>)<br><br>func main() {<br>    ch1 := make(chan struct{})<br>    ch2 := make(chan struct{})<br>    ch3 := make(chan struct{})<br>    ch4 := make(chan struct{})<br><br>    go func() {<br>        for {<br>            &lt;-ch1<br>            time.Sleep(time.Second)<br>            fmt.Println(&quot;No.1&quot;)<br>            ch2 &lt;- struct{}{}<br>        }<br>    }()<br><br>    go func() {<br>        for {<br>            &lt;-ch2<br>            time.Sleep(time.Second)<br>            fmt.Println(&quot;No.2&quot;)<br>            ch3 &lt;- struct{}{}<br>        }<br>    }()<br><br>    go func() {<br>        for {<br>            &lt;-ch3<br>            time.Sleep(time.Second)<br>            fmt.Println(&quot;No.3&quot;)<br>            ch4 &lt;- struct{}{}<br>        }<br>    }()<br><br>    go func() {<br>        for {<br>            &lt;-ch4<br>            time.Sleep(time.Second)<br>            fmt.Println(&quot;No.4&quot;)<br>            ch1 &lt;- struct{}{}<br>        }<br>    }()<br><br>    ch1 &lt;- struct{}{}<br>    select {}<br>}<br>","like_count":0},{"had_liked":false,"id":313218,"user_name":"Geek9772","can_delete":false,"product_type":"c1","uid":2689623,"ip_address":"","ucode":"A5E059C92D9950","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/2Iw3M4Myq6G3TO1BQExJP9JKtazBEfptXhG1WcMsnZSWRyiaXCeq0NibsWmmerJVRSpybhfezib8pBGlowlR2wg2A/132","comment_is_top":false,"comment_ctime":1632313106,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1632313106","product_id":100061801,"comment_content":"ç”¨æ¡ä»¶å˜é‡å§","like_count":0},{"had_liked":false,"id":307634,"user_name":"ChuanBing à¸ˆà¸¸à¹Šà¸š","can_delete":false,"product_type":"c1","uid":1628736,"ip_address":"","ucode":"4482E852FC147A","user_header":"https://static001.geekbang.org/account/avatar/00/18/da/40/bda5ad2b.jpg","comment_is_top":false,"comment_ctime":1629185815,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1629185815","product_id":100061801,"comment_content":"func main() {<br>\tch := make(chan interface{}, 0)<br>\tch0 := ch<br>\tmax := 20<br>\tfor i := 0; i &lt; max; i++ {<br>\t\ti := i<br>\t\tif i == max-1 {<br>\t\t\tgo fn(i, ch, ch0)<br>\t\t\tcontinue<br>\t\t}<br>\t\tchNext := make(chan interface{}, 0)<br>\t\tgo fn(i, ch, chNext)<br>\t\tch = chNext<br>\t}<br>\tch0 &lt;- 0<br>\ttime.Sleep(time.Minute)<br>}<br><br>func fn(i int, ch &lt;-chan interface{}, chNext chan&lt;- interface{}) {<br>\tfor {<br>\t\tif i == 0 {<br>\t\t\ttime.Sleep(time.Second)<br>\t\t}<br>\t\t&lt;-ch<br>\t\tfmt.Printf(&quot;ch:%p, chNext:%p, i:%v \\n&quot;, ch, chNext, i)<br>\t\tchNext &lt;- 0<br>\t}<br>}","like_count":0},{"had_liked":false,"id":291207,"user_name":"webmin","can_delete":false,"product_type":"c1","uid":1047014,"ip_address":"","ucode":"98B0CA882454E8","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f9/e6/47742988.jpg","comment_is_top":false,"comment_ctime":1620117264,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1620117264","product_id":100061801,"comment_content":"func main() {<br><br>\twg := sync.WaitGroup{}<br><br>\tchans := []chan int{make(chan int, 1), make(chan int, 1), make(chan int, 1), make(chan int, 1)}<br><br>\tn := len(chans)<br><br>\tctx, cancel := context.WithTimeout(context.Background(), time.Second*10)<br>\tdefer cancel()<br><br>\tproc := func(i int) {<br>\t\tj := i + 1<br>\t\tdefer wg.Done()<br>\t\tfor {<br>\t\t\tselect {<br>\t\t\tcase &lt;-chans[i%n]:<br>\t\t\t\tfmt.Printf(&quot;%d -&gt; &quot;, j)<br>\t\t\t\ttime.After(time.Second)<br><br>\t\t\t\tif ctx.Err() != nil {<br>\t\t\t\t\treturn<br>\t\t\t\t}<br><br>\t\t\t\tchans[j%n] &lt;- j % n<br>\t\t\tcase &lt;-ctx.Done():<br>\t\t\t\treturn<br>\t\t\t}<br>\t\t}<br>\t}<br><br>\tfor i := 0; i &lt; n; i++ {<br>\t\twg.Add(1)<br>\t\tgo proc(i)<br>\t}<br><br>\tchans[0] &lt;- 0<br><br>\twg.Wait()<br>}","like_count":0},{"had_liked":false,"id":287456,"user_name":"é£é±¼à½¼","can_delete":false,"product_type":"c1","uid":1293492,"ip_address":"","ucode":"E64EFABF74A2FC","user_header":"https://static001.geekbang.org/account/avatar/00/13/bc/b4/2ce124d1.jpg","comment_is_top":false,"comment_ctime":1617957519,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1617957519","product_id":100061801,"comment_content":"func main() {<br>\tvar chs[4]chan bool<br>\tfor i := 0; i &lt; 4; i++ {<br>\t\tchs[i] = make(chan bool)<br>\t\tgo printID(i,chs[i])<br>\t}<br>\t<br>\tc := 0<br>\tfor {<br>\t\tid := c%4<br>\t\tchs[id]&lt;-true<br>\t\ttime.Sleep(time.Second)<br>\t\tc++<br>\t}<br>}<br><br>func printID(id int,ch chan bool) {<br>\tfor {<br>\t\tselect {<br>\t\tcase &lt;-ch:<br>\t\t\tfmt.Println(id)<br>\t\t}<br>\t}<br>}","like_count":0},{"had_liked":false,"id":286863,"user_name":"å–ä¸€ä¸ªé•¿é•¿é•¿é•¿çš„åå­—","can_delete":false,"product_type":"c1","uid":1387521,"ip_address":"","ucode":"8C39641B6EBCA1","user_header":"https://static001.geekbang.org/account/avatar/00/15/2c/01/636452b4.jpg","comment_is_top":false,"comment_ctime":1617638150,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1617638150","product_id":100061801,"comment_content":"å¾ˆå¥‡æ€ªä¸ºä»€ä¹ˆchanä¸­çš„closedå­—æ®µæ²¡æœ‰ç”¨uint8æ¥è¡¨ç¤ºï¼Œæ„Ÿè§‰uint32æ²¡æœ‰å•¥å¿…è¦çš„","like_count":0},{"had_liked":false,"id":284213,"user_name":"schwarzeni","can_delete":false,"product_type":"c1","uid":1112540,"ip_address":"","ucode":"C1969191F334BD","user_header":"https://static001.geekbang.org/account/avatar/00/10/f9/dc/0a1eeb4c.jpg","comment_is_top":false,"comment_ctime":1616123852,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1616123852","product_id":100061801,"comment_content":"package main<br><br>import (<br>\t&quot;fmt&quot;<br>\t&quot;time&quot;<br>)<br><br>func main() {<br>\tsize := 4<br>\tsignChans := make([]chan struct{}, size)<br>\tfor i := range signChans {<br>\t\tsignChans[i] = make(chan struct{})<br>\t}<br><br>\tfor i := 1; i &lt;= size; i++ {<br>\t\tgo func(id int, sign chan struct{}) {<br>\t\t\tfor {<br>\t\t\t\t&lt;-sign<br>\t\t\t\tfmt.Println(id)<br>\t\t\t}<br>\t\t}(i, signChans[i-1])<br>\t}<br><br>\t&#47;&#47; controller<br>\tgo func() {<br>\t\tticker := time.NewTicker(time.Second)<br>\t\tid := 1<br>\t\tfor {<br>\t\t\t&lt;-ticker.C<br>\t\t\tsignChans[id-1] &lt;- struct{}{}<br>\t\t\tid++<br>\t\t\tif id &gt; size {<br>\t\t\t\tid = 1<br>\t\t\t}<br>\t\t}<br>\t}()<br><br>\tselect {}<br>}<br>","like_count":0},{"had_liked":false,"id":281527,"user_name":"èŠ’æœå°‘ä¾ ","can_delete":false,"product_type":"c1","uid":1350159,"ip_address":"","ucode":"98D0BBB52BB80F","user_header":"https://static001.geekbang.org/account/avatar/00/14/9a/0f/da7ed75a.jpg","comment_is_top":false,"comment_ctime":1614774814,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1614774814","product_id":100061801,"comment_content":"1. é¢˜ç›®1ï¼Œç”¨å››ä¸ªchannelçš„æ€è·¯è§£å†³<br>2. é¢˜ç›®2ï¼Œé€šè¿‡ç¼–è¯‘å™¨éªŒè¯<br>--------<br>package main<br><br>import (<br>\t&quot;fmt&quot;<br>\t&quot;time&quot;<br>)<br><br>func main()  {<br>\t&#47;&#47; chan Tå¯ä»¥ç»™ &lt;-chan T å’Œ chan&lt;- Tèµ‹å€¼<br>\tch := make(chan int)<br>\tvar a chan&lt;- int = ch<br>\tvar b &lt;-chan int = ch<br>\tfmt.Printf(&quot;%v, %v\\n&quot;, a, b)<br><br>\t&#47;&#47; &lt;-chan T å’Œ chan&lt;- Tä¸å¯ä»¥ç»™ chan Tèµ‹å€¼<br>\t&#47;&#47; ä¸‹è¿°è¯­å¥ä¼šæŠ¥é”™<br>\t&#47;&#47; var chNew chan int<br>\t&#47;&#47; chNew = a<br>\t&#47;&#47; chNew = b<br><br>\t&#47;&#47; goroutine 1<br>\tvar channels [4]chan int<br>\tfor i := 1; i &lt;= 4; i++ {<br>\t\tchannels[i-1] = make(chan int)<br>\t\tgo func(i int, ch chan int) {<br>\t\t\tfor {<br>\t\t\t\t&lt;- ch<br>\t\t\t\tfmt.Println(i)<br>\t\t\t}<br>\t\t}(i, channels[i-1])<br>\t}<br><br>\tvar tick int<br>\tfor {<br>\t\ttime.Sleep(time.Second)<br>\t\tchannels[tick % 4] &lt;- 1<br>\t\ttick ++<br>\t\tif tick == 40 {  &#47;&#47; é˜²æ­¢tickè¿‡å¤§<br>\t\t\ttick = 0<br>\t\t}<br>\t}<br>}<br>","like_count":0},{"had_liked":false,"id":281419,"user_name":"BadNine","can_delete":false,"product_type":"c1","uid":1137621,"ip_address":"","ucode":"69965D3E117D8E","user_header":"https://static001.geekbang.org/account/avatar/00/11/5b/d5/5c2aa991.jpg","comment_is_top":false,"comment_ctime":1614743231,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1614743231","product_id":100061801,"comment_content":"func Test_orderPrint(t *testing.T) {<br>\tc := make(chan int)<br>\tgo func() {<br>\t\tc &lt;- 1<br>\t}()<br>\t<br>\tgo orderPrint(c, 1)<br>\tgo orderPrint(c, 2)<br>\tgo orderPrint(c, 3)<br>\tgo orderPrint(c, 4)<br><br>\tselect {}<br>}<br><br>func orderPrint(c chan int, i int) {<br>\tfor {<br>\t\ttime.Sleep(time.Second)<br>\t\tcur := &lt;-c<br>\t\tif cur == i {<br>\t\t\tfmt.Println(i)<br>\t\t\tif i%4 == 0 {<br>\t\t\t\tc &lt;- 1<br>\t\t\t} else {<br>\t\t\t\tc &lt;- i + 1<br>\t\t\t}<br>\t\t} else {<br>\t\t\tc &lt;- cur<br>\t\t}<br>\t}<br>}","like_count":0},{"had_liked":false,"id":275318,"user_name":"( ï½¥á·„á½¢ï½¥á·… )","can_delete":false,"product_type":"c1","uid":2234129,"ip_address":"","ucode":"E5F5EDEBB74C46","user_header":"https://static001.geekbang.org/account/avatar/00/22/17/11/a63acc6a.jpg","comment_is_top":false,"comment_ctime":1611469601,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1611469601","product_id":100061801,"comment_content":"1.func Print(recv chan int) {<br>\tfor {<br>\t\tindex, ok := &lt;-recv<br>\t\tif !ok {<br>\t\t\treturn<br>\t\t}<br>\t\tfmt.Println(index)<br>\t\tindex++<br>\t\tif index == 5 {<br>\t\t\tindex = 1<br>\t\t}<br><br>\t\ttime.Sleep(1 * time.Second)<br>\t\trecv &lt;- index<br>\t}<br>}<br><br>func main() {<br>\tc := make(chan int)<br>\tgo Print(c)<br>\tgo Print(c)<br>\tgo Print(c)<br>\tgo Print(c)<br>\tc &lt;- 1<br>\ttime.Sleep(20 * time.Second)<br>\tclose(c)<br>}<br>2.ä¸å¯ä»¥","like_count":0},{"had_liked":false,"id":269177,"user_name":"ç»ƒä¹ æ—¶é•¿ä¸¤å¹´åŠ","can_delete":false,"product_type":"c1","uid":2272150,"ip_address":"","ucode":"CDA8E435A8C243","user_header":"https://static001.geekbang.org/account/avatar/00/22/ab/96/227aff6b.jpg","comment_is_top":false,"comment_ctime":1608548202,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1608548202","product_id":100061801,"comment_content":"send ç¬¬6éƒ¨åˆ†æ²¡æœ‰ä»£ç å—ï¼Ÿ<br>è¿˜æœ‰ buf æ˜¯å¾ªç¯é˜Ÿåˆ—ç©ºé—²ç©ºé—´çš„æŒ‡é’ˆå—ï¼Ÿç¬¬6éƒ¨åˆ†åˆ¤æ–­ buf æ»¡å’Œç¬¬2éƒ¨åˆ†åˆ¤æ–­é˜Ÿåˆ—æ»¡ä»€ä¹ˆåŒºåˆ«å•Šï¼Ÿ","like_count":0},{"had_liked":false,"id":264466,"user_name":"æµ·ç›—èˆ¹é•¿","can_delete":false,"product_type":"c1","uid":1363634,"ip_address":"","ucode":"ECB28BA21A4113","user_header":"https://static001.geekbang.org/account/avatar/00/14/ce/b2/1f914527.jpg","comment_is_top":false,"comment_ctime":1606471734,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1606471734","product_id":100061801,"comment_content":"å»¶ä¼¸é˜…è¯»ï¼šhttps:&#47;&#47;github.com&#47;developer-learning&#47;reading-go&#47;issues&#47;450#issuecomment-524663059<br>è¿™é‡Œå¯¹channelçš„åˆ†ææ›´è¯¦ç»†äº›","like_count":0},{"had_liked":false,"id":263701,"user_name":"å­Ÿå‡¡æµ©","can_delete":false,"product_type":"c1","uid":1134774,"ip_address":"","ucode":"77522A196C31D5","user_header":"https://static001.geekbang.org/account/avatar/00/11/50/b6/a60efa42.jpg","comment_is_top":false,"comment_ctime":1606222974,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1606222974","product_id":100061801,"comment_content":"ç¬¬ä¸€é¢˜ï¼š<br>func TestFourGo(t *testing.T) {<br>\tcount := 6<br>\tch := make([]chan bool, 0)<br>\tfor i := 0; i &lt; count; i++ {<br>\t\tch = append(ch, make(chan bool))<br>\t}<br><br>\tgor := func(ch1 chan bool, ch2 chan bool, num int8) {<br>\t\tfor {<br>\t\t\t&lt;-ch1<br>\t\t\ttime.Sleep(time.Second)<br>\t\t\tfmt.Println(num)<br>\t\t\tch2 &lt;- true<br>\t\t}<br>\t}<br>\tfor i := 0; i &lt; count; i++ {<br>\t\tn := i + 1<br>\t\tif i == count-1 {<br>\t\t\tn = 0<br>\t\t}<br>\t\tgo gor(ch[i], ch[n], int8(i+1))<br>\t}<br>\tch[0] &lt;- true<br><br>\ttime.Sleep(time.Hour)<br>}<br>","like_count":0},{"had_liked":false,"id":263446,"user_name":"JYZ1024","can_delete":false,"product_type":"c1","uid":1678716,"ip_address":"","ucode":"3F56C3A6327A08","user_header":"https://static001.geekbang.org/account/avatar/00/19/9d/7c/b3bfc1bf.jpg","comment_is_top":false,"comment_ctime":1606135848,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1606135848","product_id":100061801,"comment_content":"&#47;******* å››ä¸ªåç¨‹ï¼Œå¾ªç¯è¾“å‡º1ï¼Œ2ï¼Œ3ï¼Œ4 ***********&#47;<br>&#47;*æœ‰å››ä¸ª goroutineï¼Œç¼–å·ä¸º 1ã€2ã€3ã€4ã€‚æ¯ç§’é’Ÿä¼šæœ‰ä¸€ä¸ª goroutine æ‰“å°å‡ºå®ƒè‡ªå·±çš„ç¼–å·ï¼Œ<br>è¦æ±‚ä½ ç¼–å†™ä¸€ä¸ªç¨‹åºï¼Œè®©è¾“å‡ºçš„ç¼–å·æ€»æ˜¯æŒ‰ç…§ 1ã€2ã€3ã€4ã€1ã€2ã€3ã€4ã€â€¦â€¦çš„é¡ºåºæ‰“å°å‡ºæ¥ã€‚<br>*&#47;<br>type Tasker struct {<br>\tId int<br>\tSignalCh chan struct{}<br>\tBroadcastChan chan struct{}<br>}<br><br>func NewTask(id int, ch chan struct{},bch chan struct{}) *Tasker {<br>\treturn &amp;Tasker{<br>\t\tId: id,<br>\t\tSignalCh: ch,<br>\t\tBroadcastChan: bch,<br>\t}<br>}<br><br>func (t *Tasker) say() {<br>\tfor {<br>\t\t&lt;-t.SignalCh<br>\t\tfmt.Println(t.Id)<br>\t\ttime.Sleep(time.Second*1)<br>\t\tt.BroadcastChan &lt;- struct{}{}<br>\t}<br>}<br><br>func ChannelArrange(rNum int) {<br>\tchanArray := make([]chan struct{},0,rNum)<br>\tfor i:=0;i&lt;rNum;i++ {<br>\t\tchanArray = append(chanArray,make(chan struct{}))<br>\t}<br>\tworker := make([]*Tasker,0,rNum)<br>\tfor i:=0;i&lt;rNum;i++ {<br>\t\tworker = append(worker,NewTask(i+1,chanArray[(i-1+rNum)%rNum],chanArray[(i + rNum)%rNum]))<br>\t}<br><br>\tfor i:=0;i&lt;rNum;i++ {<br>\t\tcurIndex := i<br>\t\tgo func() {<br>\t\t\tworker[curIndex].say()<br>\t\t}()<br>\t}<br>\tchanArray[rNum-1] &lt;- struct{}{}<br><br>\tselect {<br><br>\t}<br>}<br>","like_count":0},{"had_liked":false,"id":262612,"user_name":"çŸ³å¤´å¨ƒ","can_delete":false,"product_type":"c1","uid":1004982,"ip_address":"","ucode":"F8FDE640574C79","user_header":"https://static001.geekbang.org/account/avatar/00/0f/55/b6/15cf60cb.jpg","comment_is_top":false,"comment_ctime":1605779981,"is_pvip":false,"replies":[{"id":"95289","content":"é€»è¾‘æ²¡é—®é¢˜ï¼Œç¬¦åˆç­”æ¡ˆã€‚å¦‚æœä»£ç å¯ä»¥æŠ½è±¡æ›´å¥½ï¼Œå‡å°‘é‡å¤ä»£ç ","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1605787407,"ip_address":"","comment_id":262612,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1605779981","product_id":100061801,"comment_content":"æ€è€ƒé¢˜ï¼š<br><br>func main() {<br>\tvar a = make(chan int, 1)<br>\tvar b = make(chan int, 1)<br>\tvar c = make(chan int, 1)<br>\tvar d = make(chan int, 1)<br>\tvar e = make(chan string)<br>\tgo func() {<br>\t\tfor {<br>\t\t\tflag := &lt;-d<br>\t\t\tlog.Println(1)<br>\t\t\ta &lt;- flag<br>\t\t}<br>\t}()<br>\tgo func() {<br>\t\tfor {<br>\t\t\tflag := &lt;-a<br>\t\t\tlog.Println(2)<br>\t\t\tb &lt;- flag<br>\t\t}<br>\t}()<br>\tgo func() {<br>\t\tfor {<br>\t\t\tflag := &lt;-b<br>\t\t\tlog.Println(3)<br>\t\t\tc &lt;- flag<br>\t\t}<br>\t}()<br>\tgo func() {<br>\t\tfor {<br>\t\t\tflag := &lt;-c<br>\t\t\tlog.Println(4)<br>\t\t\ttime.Sleep(time.Second)<br>\t\t\td &lt;- flag<br>\t\t}<br>\t}()<br>\td &lt;- 1<br>\t&lt;-e<br>}","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":509897,"discussion_content":"é€»è¾‘æ²¡é—®é¢˜ï¼Œç¬¦åˆç­”æ¡ˆã€‚å¦‚æœä»£ç å¯ä»¥æŠ½è±¡æ›´å¥½ï¼Œå‡å°‘é‡å¤ä»£ç ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605787407,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1113744,"avatar":"https://static001.geekbang.org/account/avatar/00/10/fe/90/19ef108d.jpg","nickname":"techwro","note":"","ucode":"7AF2B319F0AE1B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":364874,"discussion_content":"ç­”æ¡ˆä¸åˆé¢˜æ„å§ã€‚é¢˜ç›®ä¸­è¯´ï¼Œæ¯ç§’é’Ÿä¼šæœ‰ä¸€ä¸ª goroutine æ‰“å°å‡ºå®ƒè‡ªå·±çš„ç¼–å·ï¼Œä½†æ˜¯è¿è¡Œè¿™æ®µä»£ç æ˜¯æ¯éš”ä¸€ç§’é’Ÿä¼šæœ‰å››ä¸ª goroutine æ‰“å°å‡ºå®ƒè‡ªå·±çš„ç¼–å·ï¼Œåº”è¯¥åœ¨æ¯ä¸ª goroutine ä¸­éƒ½åŠ ä¸Š time.Sleepã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617633468,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":261567,"user_name":"å³ªäº”","can_delete":false,"product_type":"c1","uid":1529249,"ip_address":"","ucode":"DCF2DC959D0CD7","user_header":"https://static001.geekbang.org/account/avatar/00/17/55/a1/e77b9612.jpg","comment_is_top":false,"comment_ctime":1605423915,"is_pvip":false,"replies":[{"id":"94916","content":"å› ä¸ºé˜Ÿåˆ—ä¸­çš„è¿™äº›reader&#47;senderéƒ½è¢«é˜»å¡ä½äº†ï¼Œclose chanå”¤é†’å®ƒä»¬ï¼Œè®©å®ƒä»¬ç»§ç»­å·¥ä½œï¼Œå¦åˆ™å°±æ°¸è¿œé˜»å¡äº†","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1605438068,"ip_address":"","comment_id":261567,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1605423915","product_id":100061801,"comment_content":"[closeé€šè¿‡ close å‡½æ•°ï¼Œ<br>å¯ä»¥æŠŠ chan å…³é—­ï¼Œç¼–è¯‘å™¨ä¼šæ›¿æ¢æˆ closechan æ–¹æ³•çš„è°ƒç”¨ã€‚ä¸‹é¢çš„ä»£ç æ˜¯ close chan çš„ä¸»è¦é€»è¾‘ã€‚å¦‚æœ chan ä¸º nilï¼Œclose ä¼š panicï¼›å¦‚æœ chan å·²ç» closedï¼Œå†æ¬¡ close ä¹Ÿä¼š panicã€‚<br>å¦åˆ™çš„è¯ï¼Œå¦‚æœ chan ä¸ä¸º nilï¼Œchan ä¹Ÿæ²¡æœ‰ closedï¼Œå°±æŠŠç­‰å¾…é˜Ÿåˆ—ä¸­çš„ senderï¼ˆwriterï¼‰å’Œ receiverï¼ˆreaderï¼‰ä»é˜Ÿåˆ—ä¸­å…¨éƒ¨ç§»é™¤å¹¶å”¤é†’ã€‚]<br>ç–‘é—®ï¼šè€å¸ˆä½ å¥½ï¼Œå…¨éƒ¨ç§»é™¤èƒ½æ˜ç™½ï¼Œä¸ºä»€ä¹ˆè¦å”¤é†’çš„ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":509522,"discussion_content":"å› ä¸ºé˜Ÿåˆ—ä¸­çš„è¿™äº›reader/senderéƒ½è¢«é˜»å¡ä½äº†ï¼Œclose chanå”¤é†’å®ƒä»¬ï¼Œè®©å®ƒä»¬ç»§ç»­å·¥ä½œï¼Œå¦åˆ™å°±æ°¸è¿œé˜»å¡äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605438068,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":261410,"user_name":"æœ±ä¼Ÿ","can_delete":false,"product_type":"c1","uid":1515720,"ip_address":"","ucode":"A35BB027DC1D97","user_header":"https://static001.geekbang.org/account/avatar/00/17/20/c8/427476db.jpg","comment_is_top":false,"comment_ctime":1605324912,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1605324912","product_id":100061801,"comment_content":"æˆ‘çš„åœºæ™¯æ˜¯ä¸€ä¸ªç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ï¼Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ˜¯å¹¶å‘æ‰§è¡Œï¼Œç”Ÿäº§è€…æŠŠæ•°æ®ç”Ÿäº§å®Œä¹‹åä¼šå…³é—­channelï¼Œæ¶ˆè´¹è€…æ”¹å¦‚ä½•é€€å‡º<br>for {<br>\t\tqv, ok := &lt;-qvCh<br>\t\tif !ok {<br>\t\t\t&#47;&#47;æ¶ˆè´¹è€…é€€å‡º<br><br>\t\t}<br>\t\tif qv == nil || len(qv) == 0 {<br>\t\t\tcontinue<br>\t\t} else {<br>\t\t\t&#47;&#47;æ¶ˆè´¹è€…ä¸šåŠ¡é€»è¾‘<br>\t\t}<br>\t}<br>æˆ‘å‘ç°æœ‰æ—¶å€™ç”Ÿäº§è€…è¿˜æ²¡ç”Ÿäº§æ•°æ®æ¶ˆè´¹è€…å°±é€€å‡ºç»“æŸäº†ï¼Œè¿™ä¸ªå†™æ³•æœ‰é—®é¢˜å—","like_count":0,"discussions":[{"author":{"id":1105098,"avatar":"https://static001.geekbang.org/account/avatar/00/10/dc/ca/de844ac9.jpg","nickname":"Anker_å¼ ","note":"","ucode":"21BCF54C371BB4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":326209,"discussion_content":"å†™æ³•æ²¡é—®é¢˜ï¼Œåº”è¯¥ä¸å­˜åœ¨ä½ çš„é—®é¢˜","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605542506,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":261408,"user_name":"Panmax","can_delete":false,"product_type":"c1","uid":1004871,"ip_address":"","ucode":"9D65E3B84C5519","user_header":"https://static001.geekbang.org/account/avatar/00/0f/55/47/d217c45f.jpg","comment_is_top":false,"comment_ctime":1605323993,"is_pvip":false,"replies":[{"id":"95015","content":"æ˜¯çš„ï¼Œæè¿°é”™è¯¯ï¼Œå·²é€šçŸ¥ç¼–è¾‘ä¿®æ”¹ï¼Œè°¢è°¢","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1605536490,"ip_address":"","comment_id":261408,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1605323993","product_id":100061801,"comment_content":"recv çš„ç¬¬å››éƒ¨åˆ†çš„æè¿°æ˜¯ä¸æ˜¯ä¸å¤ªå¯¹ï¼Œè¿™é‡Œå¹¶æ²¡æœ‰æ£€æŸ¥ bufï¼Œè€Œæ˜¯ç›´æ¥æ£€æŸ¥ senderé˜Ÿåˆ—ï¼Œä¼˜å…ˆæŠŠsenderé˜Ÿåˆ—ä¸­çš„æ•°æ®ç»™å‡ºå»ã€‚<br><br>åŸæ–‡ä¸­å†™çš„æ˜¯ã€Œç¬¬å››éƒ¨åˆ†æ˜¯å¤„ç† sendq é˜Ÿåˆ—ä¸­æœ‰ç­‰å¾…è€…çš„æƒ…å†µã€‚è¿™ä¸ªæ—¶å€™ï¼Œå¦‚æœ buf ä¸­æœ‰æ•°æ®ï¼Œä¼˜å…ˆä» buf ä¸­è¯»å–æ•°æ®ï¼Œå¦åˆ™ç›´æ¥ä»ç­‰å¾…é˜Ÿåˆ—ä¸­å¼¹å‡ºä¸€ä¸ª senderï¼ŒæŠŠå®ƒçš„æ•°æ®å¤åˆ¶ç»™è¿™ä¸ª receiverã€‚ã€","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":509477,"discussion_content":"æ˜¯çš„ï¼Œæè¿°é”™è¯¯ï¼Œå·²é€šçŸ¥ç¼–è¾‘ä¿®æ”¹ï¼Œè°¢è°¢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605536490,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":260964,"user_name":"æš´æ€’ä¾ ï¼ˆæœ‰ç‰™é½¿çš„ITå¦ï¼‰","can_delete":false,"product_type":"c1","uid":1129991,"ip_address":"","ucode":"C75253B6F41D9D","user_header":"https://static001.geekbang.org/account/avatar/00/11/3e/07/2208868d.jpg","comment_is_top":false,"comment_ctime":1605162639,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1605162639","product_id":100061801,"comment_content":"func process(timeout time.Duration) bool { ch := make(chan bool) go func() { &#47;&#47; æ¨¡æ‹Ÿå¤„ç†è€—æ—¶çš„ä¸šåŠ¡ time.Sleep((timeout + time.Second)) ch &lt;- true &#47;&#47; block fmt.Println(&quot;exit goroutine&quot;) }() select { case result := &lt;-ch: return result case &lt;-time.After(timeout): return false }}<br><br>è¿™æ®µä»£ç ï¼Œå³ä½¿è®¾å®¹é‡ä¸º1ï¼Œä¹Ÿè¿˜æ˜¯æ²¡æœ‰è§£å†³é—®é¢˜ï¼Ÿ è¯·è€å¸ˆå¸®åˆ†æä¸€ä¸‹","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":324828,"discussion_content":"ä½ å¾—è¯´æ˜ä½ çš„è¿™æ®µä»£ç è¦å¹²ä»€ä¹ˆ æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿå¦åˆ™ä¹Ÿæ²¡åŠæ³•å›ç­”ä½ å•Š","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605177758,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":260917,"user_name":"ğŸ€æŸ æª¬é±¼ä¹Ÿæ˜¯é±¼","can_delete":false,"product_type":"c1","uid":2178501,"ip_address":"","ucode":"DCF033636465F3","user_header":"https://static001.geekbang.org/account/avatar/00/21/3d/c5/f43fa619.jpg","comment_is_top":false,"comment_ctime":1605151825,"is_pvip":false,"replies":[{"id":"94808","content":"cspç›®çš„ä¸æ˜¯å®ç°mytex,è€Œæ˜¯cspæ¨¡å¼ï¼Œåªä¸è¿‡lockæ˜¯å®ƒçš„ä¸€ä¸ªå‰¯äº§å“è€Œå·²","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1605257710,"ip_address":"","comment_id":260917,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1605151825","product_id":100061801,"comment_content":"channelåº•å±‚ä¹Ÿä½¿ç”¨åˆ°äº†lockï¼Œåœ¨å¤„ç†å¹¶å‘å†™çš„åœºæ™¯ä¸­ï¼Œè¿™å’Œç›´æ¥ä½¿ç”¨mutex.Lockæœ‰ä»€ä¹ˆåŒºåˆ«å‘¢","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":509325,"discussion_content":"cspç›®çš„ä¸æ˜¯å®ç°mytex,è€Œæ˜¯cspæ¨¡å¼ï¼Œåªä¸è¿‡lockæ˜¯å®ƒçš„ä¸€ä¸ªå‰¯äº§å“è€Œå·²","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605257710,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":260630,"user_name":"ç”°ä½³ä¼Ÿ","can_delete":false,"product_type":"c1","uid":1034087,"ip_address":"","ucode":"D31C9799F383D2","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c7/67/0077314b.jpg","comment_is_top":false,"comment_ctime":1605074295,"is_pvip":false,"replies":[{"id":"94679","content":".ä½ è¿™åªæ‰“å°äº†ä¸€æ¬¡ï¼Œé¢˜ç›®è¦æ±‚ä¸€ç›´æ‰“å°ä¸‹å»","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1605099254,"ip_address":"","comment_id":260630,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1605074295","product_id":100061801,"comment_content":"func main() {<br>\tch := make(chan int, 4)<br>\twg := sync.WaitGroup{}<br>\tfor i := 1; i &lt;= 4; i++ {<br>\t\twg.Add(1)<br>\t\tch&lt;-i<br>\t}<br>\tfor i := 1; i &lt;= 4; i++ {<br>\t\tgo func(wg *sync.WaitGroup) {<br>\t\t\ta := &lt;-ch<br>\t\t\ttime.Sleep(time.Second*time.Duration(a))<br>\t\t\tfmt.Println(a)<br>\t\t\twg.Done()<br>\t\t}(&amp;wg)<br>\t}<br>\twg.Wait()<br>\tclose(ch)<br>\tfmt.Println(&quot;finish&quot;)<br>}","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":509250,"discussion_content":".ä½ è¿™åªæ‰“å°äº†ä¸€æ¬¡ï¼Œé¢˜ç›®è¦æ±‚ä¸€ç›´æ‰“å°ä¸‹å»","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605099254,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":260423,"user_name":"æ–¹å—ç¡è¡£","can_delete":false,"product_type":"c1","uid":1074569,"ip_address":"","ucode":"1D355D7FEE5F8C","user_header":"https://static001.geekbang.org/account/avatar/00/10/65/89/e2ceca70.jpg","comment_is_top":false,"comment_ctime":1605001914,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1605001914","product_id":100061801,"comment_content":"2.åŒå‘é€šé“å¯ä»¥èµ‹å€¼ç»™å•å‘,åè¿‡æ¥ä¸å¯ä»¥.","like_count":0},{"had_liked":false,"id":260422,"user_name":"æ–¹å—ç¡è¡£","can_delete":false,"product_type":"c1","uid":1074569,"ip_address":"","ucode":"1D355D7FEE5F8C","user_header":"https://static001.geekbang.org/account/avatar/00/10/65/89/e2ceca70.jpg","comment_is_top":false,"comment_ctime":1605001756,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1605001756","product_id":100061801,"comment_content":"func testChannelTaskSchedule() {<br>\tconst chanNum int = 4<br>\tchanArry := make([]chan int, chanNum)<br>\tfor i := 0; i &lt; chanNum; i++ {<br>\t\tchanArry[i] = make(chan int, 1)<br>\t}<br><br>\telapseSec := 10<br><br>\twg := new(sync.WaitGroup)<br>\twg.Add(chanNum)<br><br>\tquitCh := make(chan struct{})<br>\tchanArry[0] &lt;- 1<br>\tfor i := 0; i &lt; chanNum; i++ {<br>\t\tnextIdx := (i + 1) % chanNum<br>\t\tgo func(curCh, nextCh chan int, idx int, quitCh chan struct{}, wg *sync.WaitGroup) {<br>\t\tLoop:<br>\t\t\tfor {<br>\t\t\t\tselect {<br>\t\t\t\tcase val := &lt;-curCh:<br>\t\t\t\t\tfmt.Printf(&quot;I am goroutine:%d,val:%d\\n&quot;, idx, val)<br>\t\t\t\t\ttime.Sleep(time.Second)<br>\t\t\t\t\tnextCh &lt;- (val + 1)<br>\t\t\t\tcase &lt;-quitCh:<br>\t\t\t\t\tfmt.Printf(&quot;--&gt;goroutine:%d exit!\\n&quot;,idx)<br>\t\t\t\t\tbreak Loop<br>\t\t\t\t}<br>\t\t\t}<br>\t\t\twg.Done()<br>\t\t}(chanArry[i], chanArry[nextIdx], i+1, quitCh, wg)<br>\t}<br><br>\tselect {<br>\tcase &lt;-time.After(time.Second * time.Duration(elapseSec)):<br>\t\tfmt.Println(&quot;--&gt;begin close goroutine....&quot;)<br>\t\tclose(quitCh)<br>\t}<br>\twg.Wait()<br>\tfmt.Println(&quot;all goroutine exit!,will be exit!&quot;)<br>}","like_count":0},{"had_liked":false,"id":260418,"user_name":"Hector","can_delete":false,"product_type":"c1","uid":1496889,"ip_address":"","ucode":"110CAF87ADDC01","user_header":"https://static001.geekbang.org/account/avatar/00/16/d7/39/6698b6a9.jpg","comment_is_top":false,"comment_ctime":1605001338,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1605001338","product_id":100061801,"comment_content":"â€œæ‰§è¡Œä¸šåŠ¡å¤„ç†çš„ goroutine ä¸è¦é€šè¿‡å…±äº«å†…å­˜çš„æ–¹å¼é€šä¿¡ï¼Œè€Œæ˜¯è¦é€šè¿‡ Channel é€šä¿¡çš„æ–¹å¼åˆ†äº«æ•°æ®ã€‚â€è®©æˆ‘æƒ³èµ·äº†ï¼Œåœ¨ä¸šåŠ¡ä¸­ä¸»çº¿ç¨‹å¼€äº†ä¸€ä¸ªå­çº¿ç¨‹å¤„ç†ä¸€ä¸ªä»»åŠ¡ï¼Œä¸»çº¿ç¨‹æ€ä¹ˆå–æ¶ˆæ­£åœ¨å¤„ç†ä»»åŠ¡çš„çº¿ç¨‹å‘¢ï¼Ÿå…±äº«å†…å­˜ä¸­çš„å˜é‡(åˆ†å¸ƒå¼ä¸­ä½¿ç”¨åˆ†å¸ƒå¼é”ä¹‹ç±»çš„å˜é‡)ï¼Œå¥½ä¸€ç‚¹çš„åšæ³•æ˜¯è®©å­çº¿ç¨‹å»forå¾ªç¯æ£€æŸ¥ï¼Œå·®ä¸€ç‚¹æ˜¯åœ¨å­çº¿ç¨‹ä¸­çš„æŸäº›æ“ä½œä¹‹å‰è¿›è¡Œåˆ¤æ–­ã€‚è€Œgoçš„chançš„é€šä¿¡æ–¹å¼åœ¨è¿™é‡Œå°±å¤„ç†çš„å¾ˆå¦™ï¼Œä¼ ç»™goç¨‹å•ç‹¬ä¸€ä¸ªç”¨æ¥æ§åˆ¶å–æ¶ˆçš„doneé€šé“ï¼Œä½¿ç”¨é€šé“çš„ä¸€äº›ç‰¹æ€§å®Œæˆäº†ä¸éœ€è¦å…±äº«å†…å­˜çš„å¤„ç†æ–¹å¼ã€‚è¦çŸ¥é“å…±äº«å†…å­˜åœ¨å¹¶å‘ä¸­å¸¦æ¥çš„é—®é¢˜æ˜¯ç¹æ‚çš„ã€‚è€Œä½¿ç”¨chançš„æ–¹å¼ï¼Œåªè¦æ§åˆ¶å¥½chançš„æ‰€æœ‰æƒï¼Œä¸å­˜åœ¨å…±äº«å†…å­˜çš„æ‚ç³…é—®é¢˜ï¼Œå¹¶ä¸”å¯ä»¥åœ¨doneä¸Šæ¥åšä¸€äº›åŠ¨ä½œï¼Œæ¯”å¦‚è¶…æ—¶å–æ¶ˆï¼Œé‡è¯•æœºåˆ¶ã€‚","like_count":0},{"had_liked":false,"id":260204,"user_name":"é‚£æ—¶åˆ»","can_delete":false,"product_type":"c1","uid":1150927,"ip_address":"","ucode":"B0D150856C3A4A","user_header":"https://static001.geekbang.org/account/avatar/00/11/8f/cf/890f82d6.jpg","comment_is_top":false,"comment_ctime":1604940623,"is_pvip":false,"replies":[{"id":"94509","content":"lockä¿æŠ¤çš„ä¸ä»…ä»…buf,è¿˜æœ‰å…¶ä»–å­—æ®µæ¯”å¦‚sendx,qcount,ä¸æ–¹ä¾¿lockfreeçš„å®ç°","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1604985042,"ip_address":"","comment_id":260204,"utype":1}],"discussion_count":1,"race_medal":1,"score":"1604940623","product_id":100061801,"comment_content":"è€å¸ˆï¼Œè¯·é—®åœ¨hchanç»“æ„ä¸­lockæ˜¯hchanæ‰€æœ‰å­—æ®µä¸­çš„å¤§é”ã€‚æ˜¯å¦å¯ä»¥æŠŠbufæŒ‡å‘çš„å¾ªç¯é˜Ÿåˆ—é‡‡ç”¨lock freeæ–¹å¼ï¼Œè¿™æ ·lockä¸éœ€è¦é”ä½å¾ªç¯é˜Ÿåˆ—ç›¸å…³çš„å˜é‡å‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":509132,"discussion_content":"lockä¿æŠ¤çš„ä¸ä»…ä»…buf,è¿˜æœ‰å…¶ä»–å­—æ®µæ¯”å¦‚sendx,qcount,ä¸æ–¹ä¾¿lockfreeçš„å®ç°","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604985042,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}