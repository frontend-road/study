{"id":3277,"title":"18 | 持续交付流水线软件构建难吗？有哪些关键问题？","content":"<p>上期文章我们介绍了需求分解与应用对应的管理方式，以及提交环节的开发协作模式，今天我们详细介绍一下提交阶段的构建环节，也就是我们经常提到的代码的编译打包。</p>\n<h2>构建环节</h2>\n<p>由于静态语言从过程上要比动态语言复杂一些，代码提交后，对于Java和C++这样的静态语言，我们要进行代码编译和打包。而对于PHP和Python这样的动态语言，就不需要编译，直接打包即可。</p>\n<p>同时，编译过程就开始要依赖多环境以及多环境下的配置管理，并根据不同的环境获取不同的配置，然后打包到最终的软件发布包中。</p>\n<p>下面我就结合自己的实践经验，以Java为例，对构建环节做下介绍。</p>\n<p>构建过程中我们要用到以下<strong>4种工具</strong>：</p>\n<ul>\n<li><strong>Gitlab</strong>，代码管理工具，也是版本管理工具；</li>\n<li><strong>Maven</strong>，依赖管理和自动化构建工具，业界同类型的工具还有Gradle等；</li>\n<li><strong>Docker</strong>，用来提供一个干净独立的编译环境；</li>\n<li><strong>自动化脚本和平台</strong>，自动化构建的任务我们使用Python脚本来实现代码获取、编译执行、软件包生成等。</li>\n</ul>\n<p>具体整个构建过程图示如下：</p>\n<p><img src=\"https://static001.geekbang.org/resource/image/2e/87/2ecde6e88787e007f41fb01a85718687.png?wh=676*286\" alt=\"\" /></p>\n<p>我们以Java为例描述如下。</p>\n<p>1.首先准备好JDK的编译镜像，这个镜像环境与线上运行环境保持一致，比如OS版本、内核参数以及JDK版本等基础环境。当需要启动一个构建任务时，就创建一个对应的Docker实例，作为独立的编译环境。</p>\n<p>2.构建任务会根据应用配置管理中的Git地址，将代码克隆下来放到指定的编译目录。Docker实例启动后，将编译目录挂载到Docker实例中。</p>\n<p>3.执行mvn package命令进行编译打包，最终会生成一个可发布war的软件包。同样的，对于C++、Go、Node.js，也会准备好类似的编译镜像。不同的是，打包时，对于C++中的cmake和make，Go中的go install等等，最终也会生成一个可发布的软件包。</p>\n<p>4.构建完成后，生成软件包放到指定构件库目录，或者直接发布到maven的构件库中管理，然后将Docker实例销毁。</p>\n<p>上述就是一个完整的构建过程。在这里，你一定会有一些疑问，那么，我先回答几个比较常见的问题，欢迎你留言和我继续讨论。</p>\n<!-- [[[read_end]]] -->\n<h2>几个关键问题</h2>\n<p><strong>1.配置文件如何打包？</strong></p>\n<p>这个问题，我们在前面持续交付的多环境配置管理文章中，已经详细介绍过。这里我们结合构建过程，再介绍一下。</p>\n<p>在上述第3个步骤中，我们要进行代码编译。按照持续交付理念，软件只需打包一次就可以各处运行，这对于代码编译是没有问题的，但是对于一些跟环境相关的配置就无法满足。</p>\n<p>比如，我们前面讲到，不同的环境会涉及到不同的配置，如DB、缓存。而且，其他公共基础服务在不同环境中也会有不同的地址、域名或其他参数配置。</p>\n<p>所以，我们就需要建立环境与配置之间的对应关系，并保存在配置管理平台中，至于如何来做，大家可以参考前面多环境配置管理的文章。</p>\n<p>这里我们回到打包过程上来。</p>\n<p>在做构建时，我们是可以确认这个软件包是要发布到哪个环境的。比如，按照流程，当前处于线下集成测试环境这个流程环节上，这时只要根据集成测试环境对应的配置项，生成配置文件，然后构建进软件包即可。如果是处于预发环境，那就生成预发环境对应的配置文件。</p>\n<p>在我们的实际场景中，多个环境需要多次打包，这与我们持续交付中只构建一次的理念相悖。这并不是有意违背，而是对于Java构建出的交付件，最终无论生成的是war包，还是jar包，上述提到的跟环境相关的配置文件，是要在构建时就打入软件包中的。</p>\n<p>而且在后续启动和运行阶段，我们是无法修改已经构建进软件包里的文件及其内容的。这样一来，配置文件无法独立发布，那么就必须跟软件包一起发布。所以，在实际场景下，我们要针对不同环境多次打包。</p>\n<p>那么，我们如何确保多次打包的效果能够和“只构建一次”理念的效果相一致呢？</p>\n<p>这就还是要依赖我们前面介绍的各个环节的建设过程，主要有以下3个方面：</p>\n<ul>\n<li>代码提交。通过分支提交管理模式，每次构建都以master为基线，确保合入的代码是以线上运行代码为基础的。且前面的发布分支代码未上线之前，后续分支不允许进入线上发布环节，确保发布分支在多环境下是同一套代码。</li>\n<li>编译环境统一。上述过程已经介绍，编译环境通过全新的Docker容器环境来保证。</li>\n<li>配置管理。前面介绍到的多环境配置管理手段， 通过模板和auto-config的配置管理能力，确保多环境配置项和配置值统一管理。</li>\n</ul>\n<p>至此，一个完整的软件构建过程就完成了。可以看到，如果充分完善前期的准备工作，在做后期的方案时就会顺畅很多。</p>\n<p><strong>2.为什么用Docker做编译环境的工具？</strong></p>\n<p>Docker容器很大的一个优势在于其创建和销毁的效率非常高，而且每次新拉起的实例都是全新的，消除了环境共用带来的交叉影响。而且对于并发打包的情况，Docker可以快速创建出多个并行的实例来提供编译环境，所以无论在效率上还是环境隔离上，都有非常好的支持。</p>\n<p>你可以尝试一下我的这个建议，确实会非常方便。</p>\n<p><strong>3.为什么不直接生成Docker镜像做发布？</strong></p>\n<p>在使用Docker容器做编译的过程中，我们最终取得的交付件模式是一个war包，或者是一个jar包，这个也是我们后续发布的对象。</p>\n<p>可能有读者会问：为什么不直接生成Docker镜像，后续直接发布镜像？</p>\n<p>这确实是一个好问题。如果单纯从发布的维度来看，直接发布镜像会更方便，更高效。不过，在现实场景下，我们应该更全面地看问题。</p>\n<p>早期我们曾有一段时间使用OpenStack+Docker的模式进行物理机的虚拟化，以提升资源利用率。这实际上是将容器虚拟机化。</p>\n<p>也就是说，虽然Docker是一个容器，但是我们的使用方式仍然是虚拟机模式，要给它配置IP地址，要增加很多常用命令比如top、sar等等，定位问题需要ssh到容器内。</p>\n<p>这里一方面是因为基于Docker的运维工具和手段没有跟上，当时也缺少Kubernetes这样优秀的编排工具；另一方面，我们之前所有的运维体系都是基于IP模式建设的，比如监控、发布、稳定性以及服务发现等等，完全容器化的模式是没有办法一步到位的。</p>\n<p>所以，这里我们走了个小弯路：容器虚拟机化。那为什么我们不直接使用虚拟机，还能帮我们省去很多为了完善容器功能而做的开发工作？所以一段时间之后，我们还是回归到了KVM虚拟机使用方式上来。</p>\n<p>这样也就有了上述我们基于虚拟机，或者更准确地说，是基于IP管理模式下的持续交付体系。</p>\n<p>经过这样一个完整的持续交付体系过程后，我们总结出一个规律：</p>\n<p>容器也好，虚拟机也罢，这些都是工具，只不过最终交付模式不一样。但是前面我们所讲的不管是标准化、多环境、配置管理等等这些基础工作，无论用不用容器都要去做。而且，容器的高效使用，一定是建立在更加完善和高度标准化的体系之上，否则工具只会是越用越乱。</p>\n<p>关于持续交付流水线软件构建方面的内容，我们今天先分享到这里，欢迎你留言与我讨论。</p>\n<p>如果今天的内容对你有帮助，也欢迎你分享给身边的朋友，我们下期见！</p>\n<p></p>\n","comments":[{"had_liked":false,"id":5207,"user_name":"海格","can_delete":false,"product_type":"c1","uid":1062217,"ip_address":"","ucode":"B38B4E49AAD740","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKagLyKbgMsyKTrLplWu3iauiaGh97dhwFbfQ7RSoCx1SYiaL3icV3UsA5njaUVIYV01a1d2gBzf4CCbQ/132","comment_is_top":false,"comment_ctime":1522846380,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"27292650156","product_id":100003401,"comment_content":"我们就是使用的配置中心，编译完打包车docker镜像，然后调用接口进行部署，启动容器，在启动容器的时候会传入几个参数，会先拉取配置文件，然后在运行jar包。","like_count":7},{"had_liked":false,"id":2661,"user_name":"喜剧。","can_delete":false,"product_type":"c1","uid":1042681,"ip_address":"","ucode":"5F9CF567792B8A","user_header":"https://static001.geekbang.org/account/avatar/00/0f/e8/f9/4412b473.jpg","comment_is_top":false,"comment_ctime":1518226326,"is_pvip":false,"replies":[{"id":"588","content":"有很多配置是启动时就会依赖的，特别是跟环境相关的这些，比如数据库连接不上可能就直接启动异常了，进程无法正常启动，那读取配置中心的配置也就无从谈起了。","user_name":"作者回复","user_name_real":"赵成","uid":"1001380","ctime":1518322143,"ip_address":"","comment_id":2661,"utype":1}],"discussion_count":2,"race_medal":0,"score":"14403128214","product_id":100003401,"comment_content":"如果多套环境多套编译感觉在效率上有点低。针对java程序，我们能否统一打成jar包，然后利用启动参数来控制你是在使用什么样的配置文件呢？如果使用的是微服务架构，我们是否最好将配置文件剥离出来，使用配置中心来管理？","like_count":3,"discussions":[{"author":{"id":1001380,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/a4/6076bd5f.jpg","nickname":"赵成","note":"","ucode":"934FC7D12479AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":415807,"discussion_content":"有很多配置是启动时就会依赖的，特别是跟环境相关的这些，比如数据库连接不上可能就直接启动异常了，进程无法正常启动，那读取配置中心的配置也就无从谈起了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1518322143,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1567397,"avatar":"https://static001.geekbang.org/account/avatar/00/17/ea/a5/1b4a65ba.jpg","nickname":"邢永胜","note":"","ucode":"B64AB17046B42E","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":224489,"discussion_content":"始终没理解到底哪些配置是必须启动之前就确定的 连接数据库的IP地址做成环境变量有什么问题吗","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1586310966,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":20562,"user_name":"快乐就好","can_delete":false,"product_type":"c1","uid":1205376,"ip_address":"","ucode":"5F4806B050FA46","user_header":"https://static001.geekbang.org/account/avatar/00/12/64/80/61107e24.jpg","comment_is_top":false,"comment_ctime":1534549111,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5829516407","product_id":100003401,"comment_content":"现在kubernetes 可以说已经足够完善了，对于应用的发布，我们发布是直接发布应用打包到容器的容器吗？是否有什么缺陷？","like_count":2},{"had_liked":false,"id":8605,"user_name":"赵丹","can_delete":false,"product_type":"c1","uid":1028285,"ip_address":"","ucode":"0856D700BAFE6E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/b0/bd/14cb63c8.jpg","comment_is_top":false,"comment_ctime":1526346739,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5821314035","product_id":100003401,"comment_content":"我们公司用的svn进行代码管理，jenkins，ant工具实现的自动化构建部署，我们使用的工具部署方式需要调整吗，怎么调整会更好些，希望老师给点建议。","like_count":1},{"had_liked":false,"id":79983,"user_name":"Adam","can_delete":false,"product_type":"c1","uid":1305633,"ip_address":"","ucode":"338BA720880E4F","user_header":"https://static001.geekbang.org/account/avatar/00/13/ec/21/b0fe1bfd.jpg","comment_is_top":false,"comment_ctime":1553588367,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1553588367","product_id":100003401,"comment_content":"我是这样做的。pod里面initcontainer配置一个拉取config的程序（程序得开发写好封装成镜像），初始化容器运行完成后才会开始运行业务容器。initcontainer传入不同的环境变量以及应用名就可以拉取对应的配置。","like_count":1},{"had_liked":false,"id":68054,"user_name":"松花皮蛋me","can_delete":false,"product_type":"c1","uid":1000054,"ip_address":"","ucode":"B0846CEEF6B0D1","user_header":"https://static001.geekbang.org/account/avatar/00/0f/42/76/256bbd43.jpg","comment_is_top":false,"comment_ctime":1550397649,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1550397649","product_id":100003401,"comment_content":"我们是只打包一次，然后发布时根据环境将配置文件更换，配置文件和启动脚本和库都是分文件夹存放的。另外docker镜像发布是趋势，不需要先申请机器，快速扩容","like_count":1},{"had_liked":false,"id":15926,"user_name":"森馫鑫","can_delete":false,"product_type":"c1","uid":1010779,"ip_address":"","ucode":"9509D3F430985A","user_header":"https://static001.geekbang.org/account/avatar/00/0f/6c/5b/5bf2c4cc.jpg","comment_is_top":false,"comment_ctime":1531655851,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1531655851","product_id":100003401,"comment_content":"可能有读者会问：为什么不直接生成 Docker 镜像，后续直接发布镜像？<br><br>这里我能想到一个场景就是客户端的持续发布，这个是无法用镜像代替的。","like_count":0},{"had_liked":false,"id":9923,"user_name":"天使","can_delete":false,"product_type":"c1","uid":1069842,"ip_address":"","ucode":"74F10EE17DD77F","user_header":"https://static001.geekbang.org/account/avatar/00/10/53/12/783f6294.jpg","comment_is_top":false,"comment_ctime":1527162186,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1527162186","product_id":100003401,"comment_content":"通过环境变量配置docker，应用读取环境变量获得应用配置；通过config server为应用提供代码配置；docker 的好处在于开发机器上可以迅速启动进行调试；依赖太多的话，启动docker的时候将依赖连到线上dev或qa环境","like_count":0},{"had_liked":false,"id":3573,"user_name":"江龙","can_delete":false,"product_type":"c1","uid":1033442,"ip_address":"","ucode":"1865E545060CC9","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c4/e2/3de4371d.jpg","comment_is_top":false,"comment_ctime":1519918840,"is_pvip":true,"replies":[{"id":"701","content":"有些配置是启动时就依赖的，这种配置只能在构建时打入软件包","user_name":"作者回复","user_name_real":"赵成","uid":"1001380","ctime":1520055345,"ip_address":"","comment_id":3573,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1519918840","product_id":100003401,"comment_content":"实现一套配置中心服务，每个环境独立的一套配置中心，服务起来时会相应的去对应的配置中心中动态请求配置。这样就能实现只一次构建，且代码与配置分离","like_count":0,"discussions":[{"author":{"id":1001380,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/a4/6076bd5f.jpg","nickname":"赵成","note":"","ucode":"934FC7D12479AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":415947,"discussion_content":"有些配置是启动时就依赖的，这种配置只能在构建时打入软件包","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1520055345,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}