{"id":176974,"title":"55 | Cassandra如何使用Netty ？","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/geek_netty\">https://gitee.com/geektime-geekbang/geek_netty</a></p>","comments":[{"had_liked":false,"id":169830,"user_name":"WING","can_delete":false,"product_type":"c3","uid":1485200,"ip_address":"","ucode":"E4723BA4027407","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/IdElofI20lsCUm1NIQPSpYFzAGLbLs41SL324FkmTb0icqnRJicW6mqX4iag1BQUSNtc7BtKJ2fEUYwU4rN47vEsQ/132","comment_is_top":false,"comment_ctime":1578453511,"is_pvip":false,"replies":[{"id":66003,"content":"可以是可以，但是反向查找效率低，一个服务器维持的连接越多，反向找效率越低，所以横竖还是单独维护一个正向查找的map比较好。你的这个设想没有问题，也能搞出来，也比较通用，问题就是效率有问题。个人看法。哈哈","user_name":"作者回复","user_name_real":"stroller","uid":1638649,"ctime":1578538651,"ip_address":"","comment_id":169830,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"感谢老师的回答，继续上面的问题，极客这个留言做的不好啊，不能针对老师的回答提问，鄙视一下，哈哈。老师说netty不能提供session管理这种内置功能。我有个设想，老师看看合不合理：我觉得netty可以提供一个通用的session管理功能，无论业务用什么做id，其实只是session的一个属性，可以设置到channel的attr里，然后可以根据某个attr去反向查找对应的channel，例如在我的案例里，建立socket连接后，将设备号设置到channel的attr里，如果是别场景如用户id等等同理，然后session管理器提供一个根据attr的名称和值去查找对应的channel的接口。老师看这样OK不？","like_count":3,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":480738,"discussion_content":"可以是可以，但是反向查找效率低，一个服务器维持的连接越多，反向找效率越低，所以横竖还是单独维护一个正向查找的map比较好。你的这个设想没有问题，也能搞出来，也比较通用，问题就是效率有问题。个人看法。哈哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578538651,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1762439,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/e4/87/fa7438da.jpg","nickname":"卷毛","note":"","ucode":"B53D459BB63025","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":574120,"discussion_content":"spring 的 websocket 不就是嘛","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1653836405,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2432032,"avatar":"https://static001.geekbang.org/account/avatar/00/25/1c/20/0d8fa034.jpg","nickname":"王耳总丶","note":"","ucode":"14D871CAC7ADF9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":393908,"discussion_content":"我在做一个websocket，每接入一个用户就添加一条连接信息，用的就是你说的这种方法，channel的attr属性+ConcurrentMap，看了一些别人的代码，大多也都是这么写，就是担心有异常情况没去remove掉map里面的元素运行久了会导致对象占用内存过大","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631633207,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":169699,"user_name":"WING","can_delete":false,"product_type":"c3","uid":1485200,"ip_address":"","ucode":"E4723BA4027407","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/IdElofI20lsCUm1NIQPSpYFzAGLbLs41SL324FkmTb0icqnRJicW6mqX4iag1BQUSNtc7BtKJ2fEUYwU4rN47vEsQ/132","comment_is_top":false,"comment_ctime":1578408136,"is_pvip":false,"replies":[{"id":65880,"content":"我觉得你的思路没有问题，想象下：netty肯定不提供这种内置的功能，因为你的是设备号，别人可能是别的id，本质都是一种map，所以需要业务层来维护，这种情况也确实类似session管理的方式，面临的问题也是一样的。另外假设你的设备本身也可以当服务器的话，你服务器端也可以实现一个客户端专门去做反向的消息发送，不然只能按照现在你的思路做。","user_name":"作者回复","user_name_real":"stroller","uid":1638649,"ctime":1578451758,"ip_address":"","comment_id":169699,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"老师，如果我需要服务器主动发消息到客户端怎么做？我的场景是有很多设备连接到了服务器，平时服务器不断接收设备数据，但有时需要人工触发从服务器发命令到设备（可以想象后台应用有个按钮，用户填了设备号，一点按钮，就发命令到对应的设备）。因为服务器主动发命令到设备，不是接收到设备的数据然后响应这种情况，我的难点是我怎么找回那个设备对应的channel？\n\n这个是几年前我做的一个案例，我的做法是，自己维护一个ConcurrentMap，设备连接上来时就将设备号和对应channel保存起来，用户点按钮时我就从这个Map里找回channel，相当于自己维护一个session表（我记得有一章有个同学也问了一个问题：netty怎么维护session的问题，应该也是有这种场景。我想如果netty提供一个类似session的组件就好了。），不知道我这么做正不正路，是否还有更好的办法？","like_count":0,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":480677,"discussion_content":"我觉得你的思路没有问题，想象下：netty肯定不提供这种内置的功能，因为你的是设备号，别人可能是别的id，本质都是一种map，所以需要业务层来维护，这种情况也确实类似session管理的方式，面临的问题也是一样的。另外假设你的设备本身也可以当服务器的话，你服务器端也可以实现一个客户端专门去做反向的消息发送，不然只能按照现在你的思路做。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578451758,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1264707,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4c/43/150c70c2.jpg","nickname":"陈松Plus","note":"","ucode":"0074BDECFA3D1D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":545862,"discussion_content":"老哥，能变相的通知客户端吗，让客户端主动和服务端通信","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642067628,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":330607,"user_name":"陈松Plus","can_delete":false,"product_type":"c3","uid":1264707,"ip_address":"","ucode":"0074BDECFA3D1D","user_header":"https://static001.geekbang.org/account/avatar/00/13/4c/43/150c70c2.jpg","comment_is_top":false,"comment_ctime":1642067091,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"能省掉很多钱。。。","like_count":0}]}