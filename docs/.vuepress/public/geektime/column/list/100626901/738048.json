{"id":738048,"title":"27ï½œRust Bevyæ¸¸æˆå¼€å‘ï¼šç”¨300è¡Œä»£ç åšä¸€ä¸ªè´ªåƒè›‡æ¸¸æˆ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯Mikeã€‚ä»Šå¤©æˆ‘ä»¬ä¸€èµ·æ¥å­¦ä¹ Rustæ¸¸æˆç¼–ç¨‹æŠ€æœ¯ã€‚è¿™èŠ‚è¯¾æˆ‘ä»¬ä¼šåŸºäºBevyæ¸¸æˆæ¡†æ¶æ¥å¼€å‘ä¸€ä¸ªå…¥é—¨ç‰ˆçš„è´ªåƒè›‡æ¸¸æˆã€‚</p><p>Rustç”Ÿæ€å†…ç›®å‰å·²ç»æœ‰ä¸å°‘å¾ˆä¸é”™çš„æ¸¸æˆå¼€å‘æ¡†æ¶ï¼Œè€ŒBevyæ˜¯å…¶ä¸­æœ€çƒ­é—¨çš„é‚£ä¸€ä¸ªï¼Œç›®å‰ï¼ˆ2023å¹´12æœˆï¼‰æœ€æ–°ç‰ˆæœ¬æ˜¯ 0.12ï¼Œè¿˜å¤„åœ¨ç§¯æå¼€å‘çš„è¿‡ç¨‹ä¸­ã€‚Bevyæ¡†æ¶å’ŒAxum Webæ¡†æ¶ã€Slintæ¡†æ¶ç»™äººçš„æ„Ÿè§‰æœ‰ç‚¹å„¿åƒï¼Œéƒ½å¾ˆç®€å•ã€ä¼˜ç¾ã€çµæ´»ã€‚ç”¨Bevyæ¡†æ¶å†™æ¸¸æˆéå¸¸æƒ¬æ„ï¼Œå·²ç»æœ‰ä¸å°‘äººåœ¨å°è¯•ä½¿ç”¨Bevyå¼€å‘è‡ªå·±çš„ç‹¬ç«‹æ¸¸æˆï¼Œç›®å‰æœ‰ä¸‰æ¬¾ï¼ˆMolecooleã€Tiny Gladeã€Roidsï¼‰å·²ç»ä¸Šæ¶æˆ–å³å°†ä¸Šæ¶ Steamã€‚</p><p>ç”¨Bevyå¼€å‘çš„æ¸¸æˆèƒ½å¤Ÿè¿è¡Œåœ¨Windowsã€macOSã€Linux, Webæµè§ˆå™¨ç­‰å¹³å°ã€‚</p><h2>Bevyæ¡†æ¶</h2><p>Bevy æ¡†æ¶æ˜¯ä¸€ä¸ªæ•°æ®é©±åŠ¨çš„æ¸¸æˆå¼€å‘æ¡†æ¶ï¼ˆå¼•æ“ï¼‰ï¼Œå…¶æ ¸å¿ƒæ˜¯ä¸€ä¸ªECSã€‚</p><h3>ECS</h3><p>ECSæ˜¯ Entity Component System çš„ç¼©å†™ï¼Œæ„æ€æ˜¯å®ä½“-ç»„ä»¶-ç³»ç»Ÿã€‚å®ƒæ˜¯ä¸€ç§ç¼–ç¨‹èŒƒå¼ï¼Œè¿™ç§èŒƒå¼éå¸¸æœ‰è¶£ï¼Œä¹Ÿéå¸¸æœ‰æ½œåŠ›ï¼Œç°åœ¨çš„ä¸»æµæ¸¸æˆå¼•æ“éƒ½å¼€å§‹æ”¯æŒè¿™ç§ç¼–ç¨‹èŒƒå¼äº†ã€‚è¿™ç§èŒƒå¼æ˜¯ä¸ä¼ ç»Ÿçš„OOPï¼ˆé¢å‘å¯¹è±¡ç¼–ç¨‹ï¼‰èŒƒå¼ç›¸å¯¹çš„ï¼Œè·ŸRustçš„ trait çš„è®¾è®¡ç†å¿µæœ‰ä¸€äº›ç›¸ä¼¼ä¹‹å¤„ã€‚</p><p>æˆ‘ä»¬ç”¨ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜ECSæ˜¯æ€æ ·å¯¹é—®é¢˜è¿›è¡Œå»ºæ¨¡çš„ã€‚å‡å¦‚ç°åœ¨æœ‰è¿™æ ·ä¸€å¹…ç”»é¢ï¼šä¸€ä¸ªä¸‹åˆï¼Œåœ¨æ¸©æš–çš„å®¶é‡Œé¢ï¼Œçˆ¸çˆ¸Dæ­£åœ¨è¾¹åƒç”œç‚¹è¾¹çœ‹ä¹¦ï¼Œå¦ˆå¦ˆMåœ¨è¾¹åƒç”œç‚¹è¾¹ç©æ‰‹æœºï¼Œå„¿å­Såœ¨å’Œç‹—ç‹—Bç©ã€‚ä½ æƒ³ä¸€æƒ³ï¼Œè¿™ä¸ªåœºæ™¯å¦‚æœç”¨OOPæ–¹å¼ï¼Œåº”è¯¥å¦‚ä½•å»ºæ¨¡å‘¢ï¼Ÿè€Œç”¨ECSèŒƒå¼å¯ä»¥è¿™æ ·å»ºç«‹æ¨¡å‹ï¼š</p><!-- [[[read_end]]] --><p><img src=\"https://static001.geekbang.org/resource/image/8b/b6/8b2071ac10d130561aff84ccaaf600b6.jpg?wh=1710x528\" alt=\"å›¾ç‰‡\"></p><p>Systems:</p><pre><code class=\"language-plain\">system1: dad_task(query: Query&lt;&gt;)\nsystem2: mom_task(query: Query&lt;&gt;)\nsystem3: son_task(query: Query&lt;&gt;)\nsystem4: dog_task(query: Query&lt;&gt;)\n</code></pre><p>è¿™æ ·è¿™ä¸ªæ¨¡å‹å°±å»ºç«‹å¥½äº†ã€‚</p><p>æˆ‘ä»¬ç”¨ç±»ä¼¼æ•°æ®åº“tableæˆ–è€…Excelçš„datasheetçš„å½¢å¼æ¥æè¿° Entity ä¸ Component ä¹‹é—´çš„å…³ç³»ã€‚Entity å°±ç”¨ç®€å•çš„æ•°å­—æ¥è¡¨ç¤ºï¼Œåªè¦èƒ½åŒºåˆ†ä¸åŒçš„å®ä½“å°±å¯ä»¥ã€‚ç„¶åæˆ‘ä»¬å®šä¹‰äº†Roleã€Nameã€Snackã€Bookã€Phoneã€Playmat 6ç§Componentã€‚</p><p>è¿™äº›Componentså°±åƒæ•°æ®åº“tableçš„åˆ—ã€‚ä½†æ˜¯ä¸æ•°æ®åº“ä¸åŒçš„æ˜¯ï¼Œåœ¨ECSèŒƒå¼ä¸­ï¼Œè¿™ä¸ªtableçš„åˆ—æ˜¯å¯ä»¥éšç€ç¨‹åºçš„è¿è¡Œè€ŒåŠ¨æ€å¢åŠ ã€å‡å°‘çš„ã€‚å¦å¤–ä¸€ä¸ªé‡è¦çš„ä¸åŒæ˜¯ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„Entityéƒ½å¼ºåˆ¶æ‹¥æœ‰æ‰€æœ‰çš„Componentï¼ˆåˆ—ï¼‰ï¼Œæ¯ä¸ªEntityå…¶å®åªå…³å¿ƒè‡ªå·±éœ€è¦çš„Componentså°±è¡Œäº†ã€‚å› æ­¤ï¼Œè¿™é‡Œçš„tableè¡¨ç¤ºåœ¨æ•°æ®ä¸Šçš„è¯ï¼Œæ›´åƒä¸€ä¸ªç¨€ç–çŸ©é˜µæˆ–é›†åˆã€‚</p><p>è¿™å…¶å®ä½“ç°äº†ä¸€ç§è®¾è®¡å“²å­¦ï¼š<strong>å°†æ‰€æœ‰çš„ä¿¡æ¯é“ºå¹³ï¼Œç”¨ç»„åˆçš„æ–¹å¼æ¥å»ºæ¨¡</strong>ã€‚æ˜¯ä¸æ˜¯ä¸Rustçš„traitè®¾è®¡å“²å­¦æœ‰ç›¸ä¼¼æ€§ï¼Ÿ</p><p>ä½ å¯ä»¥æŠŠç»„ä»¶ Component çœ‹ä½œä¸€ç»„å±æ€§çš„é›†åˆï¼Œå°†å±æ€§æŒ‰Componentæ‹†å¼€æ¥æ”¾ç½®æœ‰åˆ©äºå¤ç”¨ã€‚åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œ4ä¸ªå®ä½“éƒ½å¤ç”¨ Role ç»„ä»¶å’Œ Nameç»„ä»¶ï¼ŒDadå’ŒMommyå¤ç”¨Snackç»„ä»¶ï¼ŒSonå’ŒDogå¤ç”¨Playmateç»„ä»¶ã€‚</p><p>è€ŒSystemå°±æ˜¯è¡Œä¸ºæˆ–é€»è¾‘ï¼Œç”¨æ¥å¤„ç†ä¸Šé¢å»ºå¥½çš„è¡¨æ ¼æ•°æ®ã€‚ä¸€ä¸ªSystemå¯¹åº”åœ¨Bevyä¸­ï¼Œå°±æ˜¯æ™®é€šçš„Rustå‡½æ•°ã€‚å½“ç„¶ï¼Œè¿™ä¸ªå‡½æ•°é¦–å…ˆè¦æœ‰åŠæ³•æ‹¿åˆ°ä¸Šè¿°è¡¨æ ¼ï¼ˆä¸–ç•ŒçŠ¶æ€ï¼‰çš„æ“ä½œæƒåŠ›æ‰è¡Œï¼Œæ“ä½œçš„æ–¹æ³•å°±æ˜¯Queryæ£€ç´¢ã€‚</p><p>å…³äºECSä¸OOPçš„å¯¹æ¯”ï¼Œä½ å¯ä»¥å‚è€ƒ<a href=\"https://bevy-cheatbook.github.io/programming/intro-data.html#comparison-with-object-oriented-programming\">è¿™é‡Œ</a>ã€‚</p><h3>èµ„æºï¼ˆResourceï¼‰</h3><p>å¯¹äºåœ¨æ•´ä¸ªç³»ç»Ÿä¸­ï¼Œåªä¼šå­˜åœ¨ä¸€ä»½çš„ï¼Œå¯ä»¥æŠŠå®ƒå®šä¹‰ä¸º Resourceã€‚æ¯”å¦‚å¤–éƒ¨çš„å›¾ç‰‡ç´ æã€æ¨¡å‹æ–‡ä»¶ã€éŸ³é¢‘ç´ æç­‰ã€‚å¦å¤–è¿˜åŒ…å«å®šæ—¶å™¨å®ä¾‹ã€è®¾å¤‡æŠ½è±¡ç­‰ã€‚ä½ å¯ä»¥å°†èµ„æºæƒ³è±¡æˆç¼–ç¨‹èŒƒå¼ä¸­çš„ Singleton ï¼ˆå•ä¾‹ï¼‰ã€‚</p><h3>äº‹ä»¶ï¼ˆEventï¼‰</h3><p>æ¸¸æˆä¸–ç•Œä¸­ï¼Œæœ‰æ— å¤„ä¸åœ¨çš„å¹¶è¡Œä»»åŠ¡ï¼Œæ¯”å¦‚ 10 è¾†å¦å…‹åŒæ—¶å¯»è·¯å‰è¿›ï¼Œä»»åŠ¡ä¹‹é—´çš„é€šä¿¡ï¼Œæœ€å¥½æ˜¯é€šè¿‡äº‹ä»¶æ¥æ²Ÿé€šã€‚è¿™æ˜¯ä¸€ç§ç”¨äºè§£è€¦é€»è¾‘çš„ç¼–ç¨‹èŒƒå¼ã€‚</p><h3>ä¸–ç•ŒçŠ¶æ€</h3><p>åŸºäºECSçš„è®¾è®¡ï¼Œé‚£å¼ å¤§è¡¨tableå…¶å®å°±æ˜¯ä¸€ä¸ªä¸–ç•ŒçŠ¶æ€ã€‚åŸºäºECSçš„æ¸¸æˆå¼•æ“ï¼Œå°±éœ€è¦åœ¨å†…éƒ¨ç»´æŠ¤è¿™æ ·ä¸€ä¸ªä¸–ç•ŒçŠ¶æ€ã€‚è¿™ä¸ªä¸–ç•ŒçŠ¶æ€çš„ç»´æŠ¤éå¸¸å…³é”®ï¼Œéœ€è¦ç”¨é«˜æ•ˆçš„æ•°æ®ç»“æ„å’Œç®—æ³•å®ç°ã€‚åœ¨Bevyä¸­å…·ä½“ç”¨ä»€ä¹ˆæ•°æ®ç»“æ„æ¥ç»´æŠ¤çš„ï¼Œä½ å¯ä»¥å‚è€ƒ<a href=\"https://bevy-cheatbook.github.io/patterns/component-storage.html\">è¿™é‡Œ</a>ã€‚</p><h3>å›ºå®šå¸§ç‡</h3><p>æ¸¸æˆä¸€èˆ¬ä¼šä»¥å›ºå®šå¸§ç‡è¿è¡Œï¼Œæ¯”å¦‚æ¯ç§’60å¸§ã€‚æ¸¸æˆå¼•æ“é€šå¸¸ä¼šå°è£…å¥½è¿™ä¸ªï¼Œå°†ä½ ä»å¸§ç‡åˆ·æ–°çš„ä»»åŠ¡ä¸­é‡Šæ”¾å‡ºæ¥ï¼Œä¸“æ³¨äºæ¸¸æˆé€»è¾‘çš„è®¾è®¡ã€‚ä½ åªéœ€è¦çŸ¥é“ï¼Œä½ å†™çš„æ¸¸æˆé€»è¾‘ä¼šæ¯ç§’æ‰§è¡Œ60æ¬¡ï¼Œä¹Ÿå°±æ˜¯60ä¸ªæ»´ç­” tickã€‚</p><h3>åæ ‡ç³»ç»Ÿ</h3><p>Bevyçš„2Dé»˜è®¤çš„åæ ‡ç³»ç»Ÿæ˜¯åŸç‚¹åœ¨çª—å£æ­£ä¸­é—´çš„ä¸€ä¸ªæ­£åæ ‡ç³»ï¼Œåƒä¸‹é¢è¿™æ ·ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/yy/78/yyf79d21925f6787ab176cab1f853078.jpg?wh=1412x1102\" alt=\"\"></p><h3>æ‘„ç›¸æœºï¼ˆCameraï¼‰</h3><p>æ¸¸æˆå¼•æ“ä¸­éƒ½ä¼šæœ‰Cameraçš„æ¦‚å¿µï¼Œ3Dæ¸¸æˆçš„ç”»é¢æ¸²æŸ“ä¸¥é‡ä¾èµ–äºCameraã€‚2Dæ¸¸æˆä¸å¤ªå…³å¿ƒCameraï¼Œä½†ä½¿ç”¨Cameraä¹Ÿä¼šæœ‰æ”¾å¤§ç¼©å°çš„æ•ˆæœï¼Œé»˜è®¤Bevyçš„Cameraåœ¨åæ ‡ç³»çš„Zè½´ä¸Šï¼Œä¹Ÿå°±æ˜¯å½“å‰ä½ çœ¼ç›æ‰€å¤„çš„ä½ç½®ã€‚</p><h3>æ€§èƒ½</h3><p>å€ŸåŠ©äºECSèŒƒå¼ï¼ŒåŠ ä¸ŠRustå¼ºå¤§çš„æ— ç•å¹¶å‘èƒ½åŠ›ï¼ŒBevyèƒ½å¤Ÿè®©ä½ çš„systemså°½å¯èƒ½åœ°è¿è¡Œåœ¨å¤šä¸ªCPUæ ¸ä¸Šï¼Œä¹Ÿå°±æ˜¯å¹¶è¡Œè¿ç®—ã€‚æ‰€ä»¥Bevyçš„åŸºç¡€æ€§èƒ½æ˜¯éå¸¸æ£’çš„ï¼Œå…³äºbenchmarksçš„è®¨è®ºï¼Œä½ å¯ä»¥çœ‹<a href=\"https://github.com/bevyengine/bevy/discussions/655\">è¿™é‡Œ</a>ã€‚</p><p>æœ‰äº†è¿™äº›åŸºç¡€çŸ¥è¯†çš„é“ºå«ï¼Œæˆ‘ä»¬ä¸‹é¢è¿›å…¥å®æˆ˜ç¯èŠ‚å§ã€‚</p><h2>å®æˆ˜è´ªåƒè›‡</h2><p>è¿™é‡Œæˆ‘å…ˆç»™å‡ºå®Œæ•´ä»£ç çš„<a href=\"https://github.com/miketang84/jikeshijian/tree/master/27-bevy_snake\">é“¾æ¥</a>ï¼Œä½ æœ€å¥½ä¸‹è½½ä¸‹æ¥è¾¹è¿è¡Œè¾¹å¯¹ç…§ä¸‹é¢çš„å†…å®¹å­¦ä¹ ã€‚</p><h3>ç¬¬1æ­¥ï¼šå¼•å…¥Bevyåº“</h3><p>å¾ˆç®€å•ï¼Œå¼•å…¥Bevyåº“ï¼Œåˆ›å»ºä¸€ä¸ªAppå®ä¾‹ã€‚</p><pre><code class=\"language-plain\">use bevy::prelude::*;\n\nfn main() {\n&nbsp; &nbsp; App::new().run();\n}\n</code></pre><p>è¿™ä¸ªç¨‹åºè¿è¡Œåé©¬ä¸Šå°±ç»“æŸäº†ï¼Œæ²¡æœ‰ä»»ä½•è¾“å‡ºï¼Œä¹Ÿæ²¡æœ‰çª—å£æ‰“å¼€ã€‚</p><h3>ç¬¬2æ­¥ï¼šåˆ›å»ºçª—å£</h3><p>åŠ å…¥é»˜è®¤Pluginé›†åˆï¼Œé‡Œé¢æœ‰ä¸ªä¸»äº‹ä»¶å¾ªç¯ï¼Œè¿˜æœ‰ä¸ªåˆ›å»ºçª—å£çš„åŠŸèƒ½ã€‚ç„¶åæˆ‘ä»¬éœ€è¦è®¾ç½®2Dçš„Cameraã€‚</p><pre><code class=\"language-plain\">use bevy::prelude::*;\n\nfn main() {\n&nbsp; &nbsp; App::new()\n&nbsp; &nbsp; &nbsp; &nbsp; .add_plugins(DefaultPlugins)\n&nbsp; &nbsp; &nbsp; &nbsp; .add_systems(Startup, setup_camera)\n&nbsp; &nbsp; &nbsp; &nbsp; .run();\n}\n\nfn setup_camera(mut commands: Commands) {\n&nbsp; &nbsp; commands.spawn(Camera2dBundle::default());\n}\n</code></pre><p>ç”±äºå¼•æ“æœ¬èº«æ˜¯ä¸€ä¸ªæ‰˜ç®¡ç³»ç»Ÿï¼ˆå¸¦ä¸»å¾ªç¯çš„Runtimeï¼‰ï¼Œæˆ‘ä»¬è¦åœ¨è¿™ä¸ªå¼•æ“æ‰€ç»´æŠ¤çš„ä¸–ç•ŒçŠ¶æ€é‡Œæ·»åŠ ï¼ˆæˆ–åˆ é™¤ï¼‰æ–°çš„ä¸œè¥¿ï¼Œå¿…é¡»ä½¿ç”¨ Commands è¿™ç§ä»»åŠ¡æŒ‡ä»¤å½¢å¼ã€‚ä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆæ€»çº¿æˆ–æ¶ˆæ¯é˜Ÿåˆ—ç¼–ç¨‹æ¨¡å‹ã€‚</p><p>è¿™ä¸€æ­¥è¿è¡Œåï¼Œå¼¹å‡ºä¸€ä¸ªçª—å£ï¼Œå¹¶ä¸”æ¸²æŸ“é»˜è®¤èƒŒæ™¯è‰²ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/40/2d/4071478ceeea97857b4ce155d5d5dc2d.png?wh=2711x1633\" alt=\"\"></p><h3>ç¬¬3æ­¥ï¼šç”»å‡ºè›‡çš„å¤´</h3><p>è¿™ä¸€æ­¥æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªæ–°å‡½æ•°ï¼Œåˆ›å»ºè›‡çš„å¤´ï¼Œç„¶åç”¨ add_systems æ·»åŠ åˆ°bevy runtime ä¸­ã€‚ä½ å¯ä»¥çœ‹ä¸€ä¸‹ä»£ç å‘ç”Ÿçš„å˜åŒ–ã€‚</p><pre><code class=\"language-plain\">const SNAKE_HEAD_COLOR: Color = Color::rgb(0.7, 0.7, 0.7);\n\n#[derive(Component)]\nstruct SnakeHead;\n\n  // \n  .add_systems(Startup, (setup_camera, spawn_snake))\n  //\n  \nfn spawn_snake(mut commands: Commands) {\n&nbsp; &nbsp; commands\n&nbsp; &nbsp; &nbsp; &nbsp; .spawn(SpriteBundle {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sprite: Sprite {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; color: SNAKE_HEAD_COLOR,\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ..default()\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; },\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; transform: Transform {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; scale: Vec3::new(10.0, 10.0, 10.0),\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ..default()\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; },\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ..default()\n&nbsp; &nbsp; &nbsp; &nbsp; })\n&nbsp; &nbsp; &nbsp; &nbsp; .insert(SnakeHead);\n}\n</code></pre><p>æˆ‘ä»¬ç”¨ struct å®šä¹‰äº† SnakeHead Componentï¼Œå®ƒæ²¡æœ‰ä»»ä½•å­—æ®µã€‚æ²¡å…³ç³»ï¼Œç›®å‰ä¸€ä¸ªç±»å‹åå­—ç¬¦å·å°±èƒ½è¡¨è¾¾æˆ‘ä»¬çš„æ„æ€ï¼Œå½“ä¸€ä¸ªtagç”¨ã€‚ä½ ç»§ç»­å¾€åé¢çœ‹ã€‚</p><p>ä½ å¯ä»¥çœ‹åˆ°ï¼Œä¸€ä¸ªsystemå°±æ˜¯ä¸€ä¸ªæ™®é€šçš„Rustå‡½æ•°ã€‚SpriteBundle æ˜¯ä¸€ä¸ªComponent Bundleï¼Œä¹Ÿå°±æ˜¯ç»„ä»¶åŒ…ï¼Œå¯ä»¥æŠŠä¸€ç»„ components ç»„åˆåœ¨ä¸€èµ·ï¼ŒSpriteBundle é‡Œé¢å°±æœ‰ Spriteã€Transform ç­‰ componentsã€‚Sprite å°±æ˜¯å›¾ç‰‡ç²¾çµçš„æ„æ€ï¼Œæ˜¯æ¸¸æˆé‡Œé¢è¡¨è¾¾è§’è‰²çš„åŸºæœ¬æ–¹æ³•ã€‚Transform æŠ½è±¡çš„æ˜¯è§’è‰²çš„è¿åŠ¨ï¼Œæœ‰ä½ç§»ã€æ—‹è½¬å’Œæ‹‰ä¼¸å˜æ¢ä¸‰ç§å½¢å¼ã€‚</p><p><code>spawn_snake() system</code> ç›®çš„å°±æ˜¯åˆ›å»ºè¿™ä¸ªè›‡çš„å¤´ï¼Œå®ƒä½œä¸ºä¸€ä¸ªentityè¢«æ’å…¥åˆ°ä¸–ç•ŒçŠ¶æ€ä¸­ã€‚<code>.insert(SnakeHead)</code> æŠŠ SnakeHead è¿™ä¸ª Component æ·»åŠ åˆ°è¿™ä¸ªåˆšåˆ›å»ºå¥½çš„ entity ä¸Šé¢ã€‚</p><p><code>add_systems()</code> ä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•° Startupï¼Œç”¨æ¥è¡¨ç¤ºè¿™æ˜¯æ¸¸æˆå¯åŠ¨çš„æ—¶å€™æ‰§è¡Œçš„ systemsã€‚å®ƒä»¬åªæ‰§è¡Œä¸€æ¬¡ï¼Œå¤šä¸ªsystemså†™åœ¨å…ƒç»„é‡Œé¢ï¼Œæ›´ç®€æ´ã€‚</p><p>ä½ å¯ä»¥çœ‹ä¸€ä¸‹è¿™ä¸€æ­¥çš„è¿è¡Œæ•ˆæœï¼Œçª—å£ä¸­é—´å‡ºç°äº†ä¸€ä¸ªå°æ–¹å—ï¼Œé‚£å°±æ˜¯è›‡çš„å¤´ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/53/1e/5378d9ae31aa7b4db568dbf4983c621e.png?wh=2711x1633\" alt=\"img(6)\"></p><h3>ç¬¬4æ­¥ï¼šè®©è¿™æ¡è›‡åŠ¨èµ·æ¥</h3><p>è¿™é‡Œæˆ‘ç»™å‡ºè¿™ä¸€æ­¥æ·»åŠ çš„ä»£ç ï¼Œæˆ‘ä»¬è¾¹çœ‹è¾¹è§£è¯»ã€‚</p><pre><code class=\"language-plain\">.add_systems(Update, snake_movement)\n\nfn snake_movement(mut head_positions: Query&lt;(&amp;SnakeHead, &amp;mut Transform)&gt;) {\n&nbsp; &nbsp; for (_head, mut transform) in head_positions.iter_mut() {\n&nbsp; &nbsp; &nbsp; &nbsp; transform.translation.y += 2.;\n&nbsp; &nbsp; }\n}\n</code></pre><p>è¿™ä¸ª <code>snake_movement()</code> å°±æ˜¯å¤„ç†è›‡è¿åŠ¨çš„systemï¼Œè¯·æ³¨æ„å‚æ•°</p><p>æ˜¯ <code>Query&lt;(&amp;SnakeHead, &amp;mut Transform)&gt;</code> ç±»å‹ï¼Œå®ƒçš„æ„æ€æ˜¯ä»ä¸–ç•ŒçŠ¶æ€ä¸­å»æŸ¥æ‰¾åŒæ—¶æ‹¥æœ‰ SnakeHeadã€Transform ä¸¤ç§ Components çš„entityï¼Œå®ƒå®šä¹‰äº†ä¸€ä¸ªè¿­ä»£å™¨ï¼Œå¹¶ä¸” Transform çš„å®ä¾‹è¿˜æ˜¯å¯ä»¥ä¿®æ”¹çš„ã€‚éå†è¿™ä¸ªè¿­ä»£å™¨ï¼Œå…¶å®ç›®å‰åªæœ‰ä¸€ä¸ªentityï¼Œæ›´æ–°è´Ÿè´£ç®¡ç†å®ƒè¿åŠ¨çš„ transform å®ä¾‹ã€‚<code>transform.translation.y += 2.</code> å°±æ˜¯çºµå‘åæ ‡å‘ä¸Šç§»åŠ¨ 2 ä¸ªåƒç´ ã€‚</p><p><code>add_systems()</code> çš„ç¬¬ä¸€ä¸ªå‚æ•°Updateï¼Œè¡¨ç¤ºè¿™ä¸ªsystemæ˜¯è¿è¡Œåœ¨æ¸¸æˆè¿è¡Œè¿‡ç¨‹ä¸­çš„ï¼Œæ¯ä¸€å¸§éƒ½éœ€è¦æ›´æ–°ä¸€æ¬¡ï¼ˆæ‰§è¡Œä¸€æ¬¡è¿™ä¸ªsystemï¼‰ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªå‡½æ•°1ç§’ä¼šæ‰§è¡Œ60æ¬¡ã€‚</p><p>è¿è¡Œåä½ ä¼šå‘ç°è¿™ä¸ªå°æ–¹å—åœ¨è‡ªåŠ¨å‘ä¸Šç§»åŠ¨ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/01/4d/010cdb4abb3239ced41f6750ebd1954d.png?wh=2667x1633\" alt=\"\"></p><h3>ç¬¬5æ­¥ï¼šæ§åˆ¶è¿™æ¡è›‡çš„æ–¹å‘</h3><p>ä¸‹é¢æˆ‘ä»¬éœ€è¦æ§åˆ¶è›‡çš„æ–¹å‘ï¼Œä¸Šä¸‹å·¦å³å››ä¸ªæ–¹å‘ã€‚è¿™ä¸€æ­¥å°±æ˜¯ç»™ <code>snake_movement system</code> å¡«å……å†…å®¹ã€‚</p><pre><code class=\"language-plain\">fn snake_movement(\n&nbsp; &nbsp; keyboard_input: Res&lt;Input&lt;KeyCode&gt;&gt;,\n&nbsp; &nbsp; mut head_positions: Query&lt;&amp;mut Transform, With&lt;SnakeHead&gt;&gt;,\n) {\n&nbsp; &nbsp; for mut transform in head_positions.iter_mut() {\n&nbsp; &nbsp; &nbsp; &nbsp; if keyboard_input.pressed(KeyCode::Left) {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; transform.translation.x -= 2.;\n&nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; &nbsp; &nbsp; if keyboard_input.pressed(KeyCode::Right) {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; transform.translation.x += 2.;\n&nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; &nbsp; &nbsp; if keyboard_input.pressed(KeyCode::Down) {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; transform.translation.y -= 2.;\n&nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; &nbsp; &nbsp; if keyboard_input.pressed(KeyCode::Up) {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; transform.translation.y += 2.;\n&nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; }\n}\n</code></pre><p><code>Input&lt;KeyCode&gt;</code> æ˜¯Bevyç³»ç»Ÿçº§çš„èµ„æºï¼Œç”¨äºè¡¨ç¤ºè¾“å…¥è®¾å¤‡ï¼Œè¿™é‡Œæ˜¯é”®ç›˜è®¾å¤‡ã€‚è¦è®¿é—®èµ„æºå°±åœ¨systemé‡Œç”¨ <code>Res&lt;T&gt;</code> è¿™ç§å‚æ•°ç±»å‹ã€‚<code>keyboard_input.pressed()</code> ç”¨äºåˆ¤æ–­æ˜¯å¦é”®ç›˜æŒ‰ä¸‹äº†ã€‚</p><p>è¿è¡Œåï¼Œä½ å°±å¯ä»¥ç”¨æ–¹å‘é”®æ§åˆ¶è¿™ä¸ªå°æ–¹å—çš„è¿åŠ¨æ–¹å‘äº†ã€‚</p><h3>ç¬¬6æ­¥ï¼šå°†çª—å£ç½‘æ ¼åŒ–</h3><p>é»˜è®¤Bevyçš„çª—å£åæ ‡ç²’åº¦æ˜¯ä»¥å±å¹•çš„é€»è¾‘åƒç´ ä¸ºå•ä½çš„ã€‚è€Œåƒè´ªåƒè›‡è¿™ç§æ¸¸æˆï¼Œä¼šå°†æ•´ä¸ªç”»å¸ƒåˆ†æˆä¸€ä¸ªä¸ªæ­£æ–¹å½¢çš„å°æ–¹æ ¼ã€‚å…·ä½“æ€ä¹ˆåšï¼Œä½ å¯ä»¥çœ‹ä¸€ä¸‹è¿™ä¸€æ­¥å˜åŒ–çš„ä»£ç ã€‚</p><pre><code class=\"language-plain\">const ARENA_WIDTH: u32 = 10;\nconst ARENA_HEIGHT: u32 = 10;\n\n#[derive(Component, Clone, Copy, PartialEq, Eq)]\nstruct Position {\n&nbsp; &nbsp; x: i32,\n&nbsp; &nbsp; y: i32,\n}\n\n#[derive(Component)]\nstruct Size {\n&nbsp; &nbsp; width: f32,\n&nbsp; &nbsp; height: f32,\n}\n\nimpl Size {\n&nbsp; &nbsp; pub fn square(x: f32) -&gt; Self {\n&nbsp; &nbsp; &nbsp; &nbsp; Self {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; width: x,\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; height: x,\n&nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; }\n}\n\n        //\n        .add_systems(Update, (snake_movement, size_scaling, position_translation))\n        \n        //\n        .insert(Position { x: 3, y: 3 })\n        .insert(Size::square(0.8));\n        //\n\n// è®¡ç®—æ–¹å—å…ƒç´ çš„å¤§å°\nfn size_scaling(primary_query: Query&lt;&amp;Window, With&lt;bevy::window::PrimaryWindow&gt;&gt;, mut q: Query&lt;(&amp;Size, &amp;mut Transform)&gt;) {\n&nbsp; &nbsp; let window = primary_query.get_single().unwrap();\n&nbsp; &nbsp; for (sprite_size, mut transform) in q.iter_mut() {\n&nbsp; &nbsp; &nbsp; &nbsp; transform.scale = Vec3::new(\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sprite_size.width / ARENA_WIDTH as f32 * window.width() as f32,\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sprite_size.height / ARENA_HEIGHT as f32 * window.height() as f32,\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1.0,\n&nbsp; &nbsp; &nbsp; &nbsp; );\n&nbsp; &nbsp; }\n}\n\n// è®¡ç®—ä½ç§»\nfn position_translation(primary_query: Query&lt;&amp;Window, With&lt;bevy::window::PrimaryWindow&gt;&gt;, mut q: Query&lt;(&amp;Position, &amp;mut Transform)&gt;) {\n&nbsp; &nbsp; fn convert(pos: f32, bound_window: f32, bound_game: f32) -&gt; f32 {\n&nbsp; &nbsp; &nbsp; &nbsp; let tile_size = bound_window / bound_game;\n&nbsp; &nbsp; &nbsp; &nbsp; pos / bound_game * bound_window - (bound_window / 2.) + (tile_size / 2.)\n&nbsp; &nbsp; }\n&nbsp; &nbsp; \n&nbsp; &nbsp; let window = primary_query.get_single().unwrap();\n&nbsp; &nbsp; for (pos, mut transform) in q.iter_mut() {\n&nbsp; &nbsp; &nbsp; &nbsp; transform.translation = Vec3::new(\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; convert(pos.x as f32, window.width() as f32, ARENA_WIDTH as f32),\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; convert(pos.y as f32, window.height() as f32, ARENA_HEIGHT as f32),\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0,\n&nbsp; &nbsp; &nbsp; &nbsp; );\n&nbsp; &nbsp; }\n}\n</code></pre><p>è¿™ä¸€æ­¥ï¼Œæˆ‘ä»¬æ·»åŠ äº† Position å’Œ Size ä¸¤ç§Componentsã€‚ç”¨æ¥æ§åˆ¶è›‡å¤´çš„é€»è¾‘ä½ç½®å’Œæ˜¾ç¤ºå¤§å°ã€‚æ–°å¢äº† <code>size_scaling</code> å’Œ <code>position_translation</code> ä¸¤ä¸ªsystemï¼Œç”¨æ¥åœ¨æ¯ä¸€å¸§è®¡ç®—è›‡å¤´çš„å°ºå¯¸å’Œä½ç½®ã€‚</p><p>å…·ä½“çš„ç®—æ³•ç†è§£ä¸Šè¦æ³¨æ„çš„å°±æ˜¯ï¼Œåæ ‡çš„åŸç‚¹æ˜¯åœ¨çª—å£æ­£ä¸­å¤®ï¼Œè½¬æ¢åçš„ç½‘æ ¼gridçš„åæ ‡åŸç‚¹åœ¨çª—å£å·¦ä¸‹è§’ã€‚</p><p>ä½ å¯ä»¥çœ‹ä¸€ä¸‹è¿™ä¸€æ­¥è¿è¡Œåçš„æ•ˆæœã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/38/e7/38e680225d339594bf280af4830564e7.png?wh=2711x1597\" alt=\"\"></p><p>ä½ å¯ä»¥çœ‹åˆ°ï¼Œè›‡çš„å¤´çš„å¤§å°ï¼ˆä¸ºä¸€ä¸ªç½‘æ ¼å¤§å°çš„0.8ï¼‰å’Œä½ç½®å·²ç»å˜åŒ–äº†ã€‚è¿™é‡Œçš„ä½ç½®åœ¨ (3, 3)ï¼Œç½‘æ ¼æ€»å¤§å°ä¸º (10, 10)ï¼Œå·¦ä¸‹è§’ä¸º (0, 0)ã€‚</p><h3>ç¬¬7æ­¥ï¼šè®©è›‡æŒ‰ç½‘æ ¼ç§»åŠ¨</h3><p>ä¸‹é¢è¦è®©è›‡çš„è¿åŠ¨é€‚é…ç½‘æ ¼ã€‚ä½ çœ‹ä¸€ä¸‹è¿™ä¸€æ­¥æ”¹åŠ¨çš„ä»£ç ã€‚</p><pre><code class=\"language-plain\">fn snake_movement(\n&nbsp; &nbsp; keyboard_input: Res&lt;Input&lt;KeyCode&gt;&gt;,\n&nbsp; &nbsp; mut head_positions: Query&lt;&amp;mut Position, With&lt;SnakeHead&gt;&gt;,\n) {\n&nbsp; &nbsp; for mut pos in head_positions.iter_mut() {\n&nbsp; &nbsp; &nbsp; &nbsp; if keyboard_input.pressed(KeyCode::Left) {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pos.x -= 1;\n&nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; &nbsp; &nbsp; if keyboard_input.pressed(KeyCode::Right) {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pos.x += 1;\n&nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; &nbsp; &nbsp; if keyboard_input.pressed(KeyCode::Down) {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pos.y -= 1;\n&nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; &nbsp; &nbsp; if keyboard_input.pressed(KeyCode::Up) {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pos.y += 1;\n&nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; }\n}\n</code></pre><p>è¿™ä¸€æ­¥æˆ‘ä»¬è¦æ›´æ–°è›‡å¤´çš„é€»è¾‘åæ ‡ï¼Œä¹Ÿå°±æ˜¯ä¸Šä¸€æ­¥å®šä¹‰é‚£ä¸ªPosition componentçš„å®ä¾‹ã€‚ç°åœ¨ä½ å¯ä»¥é€šè¿‡æ–¹å‘é”®å°†è¿™ä¸ªå°çŸ©å½¢å—ç§»åŠ¨åˆ°å…¶ä»–ä½ç½®ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/ee/97/eea91bfc1a4a308deea67f06fe4a0c97.png?wh=2711x1603\" alt=\"\"></p><h3>ç¬¬8æ­¥ï¼šé…ç½®çª—å£æ¯”ä¾‹å’Œå°ºå¯¸</h3><p>é»˜è®¤æ‰“å¼€çš„çª—å£æ˜¯é•¿æ–¹å½¢çš„ï¼Œæˆ‘ä»¬è¦ç»™å®ƒé…ç½®æˆæ–¹å½¢ã€‚ä½ å¯ä»¥çœ‹ä¸€ä¸‹è¿™ä¸€æ­¥çš„å˜åŒ–ä»£ç ã€‚</p><pre><code class=\"language-plain\">const ARENA_WIDTH: u32 = 25;\nconst ARENA_HEIGHT: u32 = 25;\n        \n        //\n        .add_plugins(DefaultPlugins.set(WindowPlugin {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; primary_window: Some( Window {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; title: \"Snake!\".to_string(),\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; resolution: bevy::window::WindowResolution::new( 500.0, 500.0 ),\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ..default()\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }),\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ..default()\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; })\n&nbsp; &nbsp; &nbsp; &nbsp; )\n&nbsp; &nbsp; &nbsp; &nbsp; .insert_resource(ClearColor(Color::rgb(0.04, 0.04, 0.04)))\n        //\n</code></pre><p>è¿™ä¸€æ­¥æˆ‘ä»¬åšäº†4ä»¶äº‹æƒ…ã€‚</p><ol>\n<li>è®¾ç½®çª—å£å°ºå¯¸ä¸º500px x 500pxã€‚</li>\n<li>è®¾ç½®çª—å£æ ‡é¢˜ä¸º Snake!ã€‚</li>\n<li>è®¾ç½®çª—å£å¡«å……èƒŒæ™¯é¢œè‰²ä¸º Color::rgb(0.04, 0.04, 0.04)ã€‚</li>\n<li>åˆ†å‰²çª—å£gridä¸ºæ›´å¤§ä¸€ç‚¹çš„æ•°å­—ï¼Œæ¯”å¦‚25x25ã€‚</li>\n</ol><p>ä½ çœ‹ä¸€ä¸‹è¿™ä¸€æ­¥çš„æ•ˆæœã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/6b/9e/6b5d9639cc9dfeff05f3724fb39d369e.png?wh=1151x1193\" alt=\"\"></p><p>ç¦»æˆ‘ä»¬æœŸæœ›çš„æ ·å­è¶Šæ¥è¶Šè¿‘äº†ã€‚</p><h3>ç¬¬9æ­¥ï¼šéšæœºäº§ç”Ÿé£Ÿç‰©</h3><p>ä¸‹é¢è¦å¼€å§‹äº§ç”Ÿé£Ÿç‰©ã€‚é£Ÿç‰©æˆ‘ä»¬ä¹Ÿç”¨å¦ä¸€ç§å°æ–¹å—æ¥è¡¨ç¤ºã€‚ä½ çœ‹ä¸€ä¸‹è¿™ä¸€æ­¥å˜åŒ–çš„ä»£ç ã€‚</p><pre><code class=\"language-plain\">const FOOD_COLOR: Color = Color::rgb(1.0, 0.0, 1.0);\n\n#[derive(Component)]\nstruct Food;\n\n&nbsp; &nbsp; &nbsp; &nbsp; .add_systems(Update, food_spawner)\n\nfn food_spawner(mut commands: Commands) {\n&nbsp; &nbsp; commands\n&nbsp; &nbsp; &nbsp; &nbsp; .spawn(SpriteBundle {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sprite: Sprite {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; color: FOOD_COLOR,\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ..default()\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; },\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ..default()\n&nbsp; &nbsp; &nbsp; &nbsp; })\n&nbsp; &nbsp; &nbsp; &nbsp; .insert(Food)\n&nbsp; &nbsp; &nbsp; &nbsp; .insert(Position {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; x: (random::&lt;f32&gt;() * ARENA_WIDTH as f32) as i32,\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; y: (random::&lt;f32&gt;() * ARENA_HEIGHT as f32) as i32,\n&nbsp; &nbsp; &nbsp; &nbsp; })\n&nbsp; &nbsp; &nbsp; &nbsp; .insert(Size::square(0.8));\n}\n</code></pre><p>é£Ÿç‰©éšæœºäº§ç”Ÿï¼Œæ‰€ä»¥éœ€è¦ç”¨åˆ°randomå‡½æ•°ã€‚åŒæ ·ï¼Œæˆ‘ä»¬å®šä¹‰äº† Food è¿™ä¸ª Compomentï¼Œç„¶åå®šä¹‰äº† food_spawner systemï¼Œå¹¶æ·»åŠ åˆ°runtimeä¸­å»ã€‚åˆ›å»ºçš„é£Ÿç‰©entityä¸Šå¸¦æœ‰ Spriteã€Foodã€Positionã€Size ç­‰ componentsã€‚</p><p>å¯ä»¥æƒ³è±¡ï¼Œè¿™ä¸ªåˆ›å»ºé£Ÿç‰©çš„system1ç§’ä¼šæ‰§è¡Œ60æ¬¡ï¼Œä¹Ÿå°±æ˜¯1ç§’é’Ÿä¼šåˆ›å»º60ä¸ªé£Ÿç‰©ï¼Œé€Ÿåº¦å¤ªå¿«äº†ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/7b/57/7bd5b3534a7b1a647380c76612b0cd57.png?wh=1151x1193\" alt=\"\"></p><h3>ç¬¬10æ­¥ï¼šä½¿ç”¨å®šæ—¶å™¨äº§ç”Ÿé£Ÿç‰©</h3><p>ä¸‹é¢æˆ‘ä»¬è¦æ§åˆ¶é£Ÿç‰©çš„äº§ç”Ÿé€Ÿåº¦ï¼Œæ¯”å¦‚2ç§’äº§ç”Ÿä¸€é¢—é£Ÿç‰©ã€‚æˆ‘ä»¬æ¥çœ‹è¿™ä¸€æ­¥å˜åŒ–çš„ä»£ç ã€‚</p><pre><code class=\"language-plain\">#[derive(Resource)]\nstruct FoodSpawnTimer(Timer);\n\n&nbsp; &nbsp; &nbsp; &nbsp; .insert_resource(FoodSpawnTimer(Timer::from_seconds(\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1.0,\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TimerMode::Repeating,\n&nbsp; &nbsp; &nbsp; &nbsp; )))\n\nfn food_spawner(\n&nbsp; &nbsp; mut commands: Commands,\n&nbsp; &nbsp; time: Res&lt;Time&gt;,\n&nbsp; &nbsp; mut timer: ResMut&lt;FoodSpawnTimer&gt;,\n&nbsp; &nbsp; ) {\n&nbsp; &nbsp; // å¦‚æœæ—¶é—´æœªåˆ° 2s å°±ç«‹å³è¿”å›\n&nbsp; &nbsp; if !timer.0.tick(time.delta()).finished() {\n&nbsp; &nbsp; &nbsp; &nbsp; return;\n&nbsp; &nbsp; }\n&nbsp; &nbsp; commands\n&nbsp; &nbsp; &nbsp; &nbsp; .spawn(SpriteBundle {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sprite: Sprite {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; color: FOOD_COLOR,\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ..default()\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; },\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ..default()\n&nbsp; &nbsp; &nbsp; &nbsp; })\n&nbsp; &nbsp; &nbsp; &nbsp; .insert(Food)\n&nbsp; &nbsp; &nbsp; &nbsp; .insert(Position {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; x: (random::&lt;f32&gt;() * ARENA_WIDTH as f32) as i32,\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; y: (random::&lt;f32&gt;() * ARENA_HEIGHT as f32) as i32,\n&nbsp; &nbsp; &nbsp; &nbsp; })\n&nbsp; &nbsp; &nbsp; &nbsp; .insert(Size::square(0.8));\n}\n</code></pre><p>Timer ç±»å‹æ˜¯Bevyæä¾›çš„å®šæ—¶å™¨ç±»å‹ï¼Œæˆ‘ä»¬ç”¨newtypeæ¨¡å¼å®šä¹‰ä¸€ä¸ªè‡ªå·±çš„å®šæ—¶å™¨ï¼Œå®ƒæ˜¯ä¸€ç§èµ„æºï¼ˆå…¨å±€å”¯ä¸€ï¼‰ã€‚æˆ‘ä»¬ä½¿ç”¨ <code>insert_resource()</code> å°†è¿™ä¸ªèµ„æºåˆå§‹åŒ–å¹¶æ’å…¥åˆ°æ‰˜ç®¡ç³»ç»Ÿä¸­å»ã€‚</p><p>ç„¶ååœ¨ <code>food_spawner system</code> ä¸­ä½¿ç”¨ <code>ResMut&lt;FoodSpawnTimer&gt;</code> è¿™ç§å½¢å¼æ¥ä½¿ç”¨èµ„æºã€‚åŒæ—¶ç”¨ <code>Res&lt;Time&gt;</code> è¿™ç§å½¢å¼æ¥è·å–æ¸¸æˆä¸­çš„æ—¶é—´ï¼Œè¿™ä¸ªä¹Ÿæ˜¯Bevyå¼•æ“æä¾›çš„ã€‚ç»†å¿ƒçš„ä½ å¯èƒ½å‘ç°äº†ï¼ŒBevyé‡‡ç”¨çš„ä¹Ÿæ˜¯å£°æ˜å¼å‚æ•°å®ç°ï¼Œå’Œå‰é¢è¯¾ç¨‹è®²åˆ°çš„Axumé£æ ¼ä¸€æ ·ã€‚è¿™äº›å‚æ•°é¡ºåºæ˜¯å¯ä»¥å˜çš„ï¼åœ¨è¿™é‡Œä½ å¯ä»¥ä½“ä¼šåˆ°Rustå¼ºå¤§çš„è¡¨è¾¾èƒ½åŠ›ã€‚</p><p>æˆ‘ä»¬å†æ¥çœ‹ä¸€å¥ã€‚</p><pre><code class=\"language-plain\">&nbsp; &nbsp; if !timer.0.tick(time.delta()).finished() {\n&nbsp; &nbsp; &nbsp; &nbsp; return;\n&nbsp; &nbsp; }\n</code></pre><p>è¿™ä¸€å¥è¡¨ç¤ºæ¯æ¬¡æ‰§è¡Œè¿™ä¸ª <code>food_spawner system</code>ï¼ˆ1ç§’æ‰§è¡Œ60æ¬¡ï¼‰æ—¶ï¼Œå…ˆåˆ¤æ–­å½“å‰æµé€äº†å¤šå°‘æ—¶é—´ï¼Œå¦‚æœå®šæ—¶å™¨çš„ä¸€æ¬¡é—´éš”è¿˜æ²¡åˆ°ï¼Œå°±ç›´æ¥è¿”å›ï¼Œä¸æ‰§è¡Œè¿™ä¸ªå‡½æ•°åé¢çš„éƒ¨åˆ†ï¼Œä¹Ÿå°±ä¸äº§ç”Ÿä¸€ä¸ªé£Ÿç‰©äº†ã€‚è¿™æ ·å°±å®ç°äº†æ§åˆ¶é£Ÿç‰©äº§ç”Ÿé€Ÿç‡çš„ç›®çš„ã€‚</p><p>ä½ å¯ä»¥çœ‹ä¸€ä¸‹è¿è¡Œæ•ˆæœã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/9e/42/9ef4345a3ca89a281ca25b264ebdc942.png?wh=1151x1193\" alt=\"\"></p><p>ç°åœ¨2ç§’äº§ç”Ÿä¸€é¢—é£Ÿç‰©ï¼Œé€Ÿåº¦æ¯”åˆšæ‰æ…¢å¤šäº†ã€‚</p><h3>ç¬¬11æ­¥ï¼šè®©è›‡è‡ªåŠ¨å‰è¿›</h3><p>ä¸‹é¢æˆ‘ä»¬è¦è®©è›‡è‡ªå·±åŠ¨èµ·æ¥ï¼Œè€Œä¸”ä¹Ÿè¦æ§åˆ¶å®ƒçš„è¿åŠ¨é€Ÿç‡ã€‚åŒæ ·çš„æˆ‘ä»¬ä¼šç”¨å®šæ—¶å™¨æ–¹æ³•ã€‚</p><p>ä½ æ¥çœ‹è¿™ä¸€æ­¥æ”¹åŠ¨çš„ä»£ç ã€‚</p><pre><code class=\"language-plain\">#[derive(Resource)]\nstruct BTimer(Timer);\n\n#[derive(Component)]\nstruct SnakeHead {\n&nbsp; &nbsp; direction: Direction,\n}\n\n#[derive(PartialEq, Copy, Clone)]\nenum Direction {\n&nbsp; &nbsp; Left,\n&nbsp; &nbsp; Up,\n&nbsp; &nbsp; Right,\n&nbsp; &nbsp; Down,\n}\n\nimpl Direction {\n&nbsp; &nbsp; fn opposite(self) -&gt; Self {\n&nbsp; &nbsp; &nbsp; &nbsp; match self {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Self::Left =&gt; Self::Right,\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Self::Right =&gt; Self::Left,\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Self::Up =&gt; Self::Down,\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Self::Down =&gt; Self::Up,\n&nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; }\n}\n        // æ’å…¥å®šæ—¶å™¨èµ„æº\n        .insert_resource(BTimer(Timer::from_seconds(\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.20,\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TimerMode::Repeating,\n&nbsp; &nbsp; &nbsp; &nbsp; )))\n        // æ›´æ–°Updateæ¨¡å¼ä¸‹çš„systemé›†\n        .add_systems(Update, (\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snake_movement_input.before(snake_movement), \n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snake_movement, \n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size_scaling, \n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; position_translation))\n\n// æ ¹æ®ç”¨æˆ·é”®ç›˜è¡Œä¸ºï¼Œé¢„å¤„ç†è›‡çš„å‰è¿›æ–¹å‘\nfn snake_movement_input(\n&nbsp; &nbsp; keyboard_input: Res&lt;Input&lt;KeyCode&gt;&gt;, \n&nbsp; &nbsp; mut heads: Query&lt;&amp;mut SnakeHead&gt;) {\n&nbsp; &nbsp; if let Some(mut head) = heads.iter_mut().next() {\n&nbsp; &nbsp; &nbsp; &nbsp; let dir: Direction = if keyboard_input.just_pressed(KeyCode::Left) {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Direction::Left\n&nbsp; &nbsp; &nbsp; &nbsp; } else if keyboard_input.just_pressed(KeyCode::Down) {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Direction::Down\n&nbsp; &nbsp; &nbsp; &nbsp; } else if keyboard_input.just_pressed(KeyCode::Up) {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Direction::Up\n&nbsp; &nbsp; &nbsp; &nbsp; } else if keyboard_input.just_pressed(KeyCode::Right) {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Direction::Right\n&nbsp; &nbsp; &nbsp; &nbsp; } else {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; head.direction\n&nbsp; &nbsp; &nbsp; &nbsp; };\n&nbsp; &nbsp; &nbsp; &nbsp; if dir != head.direction.opposite() {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; head.direction = dir;\n&nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; }\n}\n\n// è›‡çš„è¿åŠ¨system\nfn snake_movement(\n&nbsp; &nbsp; mut heads: Query&lt;(&amp;mut Position, &amp;SnakeHead)&gt;,\n&nbsp; &nbsp; time: Res&lt;Time&gt;,\n&nbsp; &nbsp; mut timer: ResMut&lt;BTimer&gt;,\n) {\n    // å¦‚æœæ—¶é—´æœªåˆ° 0.2s å°±ç«‹å³è¿”å›\n&nbsp; &nbsp; if !timer.0.tick(time.delta()).finished() {\n&nbsp; &nbsp; &nbsp; &nbsp; return;\n&nbsp; &nbsp; }\n\n&nbsp; &nbsp; if let Some((mut head_pos, head)) = heads.iter_mut().next() {\n&nbsp; &nbsp; &nbsp; &nbsp; match &amp;head.direction {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Direction::Left =&gt; {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; head_pos.x -= 1;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Direction::Right =&gt; {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; head_pos.x += 1;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Direction::Up =&gt; {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; head_pos.y += 1;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Direction::Down =&gt; {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; head_pos.y -= 1;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; &nbsp; &nbsp; };\n&nbsp; &nbsp; }\n}\n</code></pre><p>ç±»ä¼¼åœ°ï¼Œæˆ‘ä»¬å®šä¹‰äº†BTimeræ¥æ§åˆ¶è›‡çš„è‡ªåŠ¨è¡Œèµ°ï¼Œ0.2ç§’èµ°ä¸€æ ¼ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥ç»™è›‡æŒ‡å®šè¡Œèµ°çš„æ–¹å‘äº†ï¼Œå› æ­¤æ–°å®šä¹‰äº† Direction æšä¸¾ï¼Œå¹¶åœ¨ SnakeHead Componenté‡Œæ·»åŠ äº† direction å­—æ®µã€‚</p><p>ä»£ç ä¸­çš„ <code>snake_movement_input.before(snake_movement)</code> è¡¨ç¤ºæ˜ç¡®æŒ‡å®š <code>snake_movement_input</code> åœ¨ <code>snake_movement system</code> ä¹‹å‰å¤„ç†ã€‚å› ä¸ºbevyé»˜è®¤ä¼šå°½å¯èƒ½å¹¶è¡ŒåŒ–ï¼Œæ‰€ä»¥è¿™æ ·æŒ‡å®šèƒ½å¤Ÿæ˜ç¡®systemçš„æ‰§è¡Œé¡ºåºï¼Œä¸ç„¶å¯èƒ½æ˜¯ä¹±åºæ‰§è¡Œçš„ã€‚</p><h3>ç¬¬12æ­¥ï¼šå®šä¹‰è›‡èº«</h3><p>ä¸‹é¢æ˜¯å®šä¹‰è›‡çš„èº«å­ï¼Œè¿™æ˜¯æ•´ä¸ªæ¨¡å‹ç›¸å¯¹å›°éš¾çš„ä¸€æ­¥ã€‚ä½†å…¶å®æŠŠç»“æ„å®šä¹‰å¥½äº†å°±ä¼šå¾ˆç®€å•ã€‚</p><p>ä½ å¯ä»¥çœ‹ä¸€ä¸‹è¿™æ­¥å˜åŒ–çš„ä»£ç ã€‚</p><pre><code class=\"language-plain\">#[derive(Component)]\nstruct SnakeSegment;\n\n#[derive(Resource, Default, Deref, DerefMut)]\nstruct SnakeSegments(Vec&lt;Entity&gt;);\n\n    // æ’å…¥è›‡çš„ç»“æ„ï¼Œå®šä¹‰ä¸ºèµ„æº\n    .insert_resource(SnakeSegments::default())\n\n// åˆ›å»ºè›‡ï¼Œç”¨SnakeSegmentsæ¥ç»´æŠ¤è›‡çš„ç»“æ„    \nfn spawn_snake(mut commands: Commands, mut segments: ResMut&lt;SnakeSegments&gt;) {\n&nbsp; &nbsp; *segments = SnakeSegments(vec![\n&nbsp; &nbsp; &nbsp; &nbsp; commands\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .spawn(SpriteBundle {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sprite: Sprite {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; color: SNAKE_HEAD_COLOR,\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ..default()\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; },\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ..default()\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; })\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .insert(SnakeHead {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; direction: Direction::Up,\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; })\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .insert(SnakeSegment)\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .insert(Position { x: 3, y: 3 })\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .insert(Size::square(0.8))\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .id(),\n&nbsp; &nbsp; &nbsp; &nbsp; spawn_segment(commands, Position { x: 3, y: 2 }),\n&nbsp; &nbsp; ]);\n}\n\n// åˆ›å»ºè›‡çš„ä¸€ä¸ªsegmentï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªå°æ–¹å—\nfn spawn_segment(mut commands: Commands, position: Position) -&gt; Entity {\n&nbsp; &nbsp; commands\n&nbsp; &nbsp; &nbsp; &nbsp; .spawn(SpriteBundle {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sprite: Sprite {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; color: SNAKE_SEGMENT_COLOR,\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ..default()\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; },\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ..default()\n&nbsp; &nbsp; &nbsp; &nbsp; })\n&nbsp; &nbsp; &nbsp; &nbsp; .insert(SnakeSegment)\n&nbsp; &nbsp; &nbsp; &nbsp; .insert(position)\n&nbsp; &nbsp; &nbsp; &nbsp; .insert(Size::square(0.65))\n&nbsp; &nbsp; &nbsp; &nbsp; .id()\n}\n</code></pre><p>è¿™é‡Œï¼Œæœ€å…³é”®çš„æ˜¯å®šä¹‰äº† SnakeSegment Component å’Œ <code>SnakeSegments(Vec&lt;Entity&gt;)</code> è¿™ä¸ª Resourceã€‚æˆ‘ä»¬æŠŠè›‡çš„å¤´å’Œæ¯ä¸€èŠ‚èº«å­å°æ–¹å—éƒ½è§†ä¸ºä¸€ä¸ª SnakeSegmentï¼Œæ•´æ¡è›‡ç”±å¤šä¸ª SnakeSegment ç»„æˆï¼Œå› æ­¤ç”¨ <code>SnakeSegments(Vec&lt;Entity&gt;)</code> è¿™ä¸ªèµ„æºæ¥ç»´æŠ¤è¿™æ¡è›‡çš„ç»“æ„ã€‚<code>SnakeSegments(Vec&lt;Entity&gt;)</code> é‡Œé¢éœ€è¦å­˜ä¸‹æ¯ä¸ª SnakeSegment çš„ Entity idã€‚</p><p>é»˜è®¤å¼€å§‹çš„æ—¶å€™ï¼Œè›‡æœ‰ä¸€èŠ‚èº«å­ï¼Œä½ç½®åœ¨ (3, 2)ã€‚è›‡çš„è¿åŠ¨æ–¹å‘æ˜¯å‘ä¸Šçš„ã€‚è›‡èº«å°æ–¹å—æ˜¯ 0.65 ä¸ªç½‘æ ¼å•å…ƒå¤§å°ã€‚</p><p>ä½ å¯ä»¥çœ‹ä¸€ä¸‹è¿™ä¸€æ­¥è¿è¡Œåçš„æ•ˆæœã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/d9/b1/d9c2ee5655cf634f05905964101d04b1.png?wh=1151x1143\" alt=\"\"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸€èŠ‚è›‡èº«æ²¡æœ‰è·Ÿç€å¤´ä¸€èµ·åŠ¨ã€‚</p><h3>ç¬¬13æ­¥ï¼šè®©è›‡èº«è·Ÿç€è›‡çš„å¤´ä¸€èµ·è¿åŠ¨</h3><p>è®©è›‡èº«è·Ÿç€è›‡å¤´ä¸€èµ·åŠ¨ï¼Œæ¨¡å‹ä¸Šå…¶å®å°±æ˜¯è®©è›‡èº«çš„æ¯ä¸€èŠ‚è·Ÿç€è›‡å¤´çš„ç§»åŠ¨ä¸€èµ·å˜æ¢åæ ‡å°±è¡Œäº†ã€‚æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ä¸€æ­¥çš„ä»£ç å˜åŒ–ã€‚</p><pre><code class=\"language-plain\">fn snake_movement(\n&nbsp; &nbsp; time: Res&lt;Time&gt;,\n&nbsp; &nbsp; mut timer: ResMut&lt;BTimer&gt;,\n&nbsp; &nbsp; segments: ResMut&lt;SnakeSegments&gt;,\n&nbsp; &nbsp; mut heads: Query&lt;(Entity, &amp;SnakeHead)&gt;,\n&nbsp; &nbsp; mut positions: Query&lt;&amp;mut Position&gt;,\n) {\n    // ä¸åˆ°0.2sç«‹å³è¿”å›\n&nbsp; &nbsp; if !timer.0.tick(time.delta()).finished() {\n&nbsp; &nbsp; &nbsp; &nbsp; return;\n&nbsp; &nbsp; }\n\n&nbsp; &nbsp; if let Some((head_entity, head)) = heads.iter_mut().next() {\n&nbsp; &nbsp; &nbsp; &nbsp; let segment_positions = segments\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .iter()\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .map(|e| *positions.get_mut(*e).unwrap())\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .collect::&lt;Vec&lt;Position&gt;&gt;();\n&nbsp; &nbsp; &nbsp; &nbsp; // å¤„ç†è›‡çš„å¤´çš„ä½ç§»\n        let mut head_pos = positions.get_mut(head_entity).unwrap();\n&nbsp; &nbsp; &nbsp; &nbsp; match &amp;head.direction {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Direction::Left =&gt; {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; head_pos.x -= 1;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Direction::Right =&gt; {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; head_pos.x += 1;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Direction::Up =&gt; {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; head_pos.y += 1;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Direction::Down =&gt; {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; head_pos.y -= 1;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; &nbsp; &nbsp; };\n        // å¤„ç†è›‡èº«æ¯ä¸€æ®µçš„ä½ç½®å˜åŒ–\n&nbsp; &nbsp; &nbsp; &nbsp; segment_positions\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .iter()\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .zip(segments.iter().skip(1))\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .for_each(|(pos, segment)| {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *positions.get_mut(*segment).unwrap() = *pos;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; });\n&nbsp; &nbsp; }\n}\n</code></pre><p>è¿™ä¸ªç®—æ³•çš„ç²¾ååœ¨è¿™ä¸€å¥ï¼š</p><pre><code class=\"language-plain\">&nbsp; &nbsp; &nbsp; &nbsp; segment_positions\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .iter()\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .zip(segments.iter().skip(1))\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .for_each(|(pos, segment)| {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *positions.get_mut(*segment).unwrap() = *pos;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; });\n</code></pre><p>æ„æ€å°±æ˜¯ï¼Œå½“è›‡åŠ¨ä¸€æ­¥çš„æ—¶å€™ï¼Œç¬¬ä¸€èŠ‚è›‡èº«çš„åæ ‡å€¼å¡«å……è›‡å¤´çš„åæ ‡å€¼ï¼Œç¬¬äºŒèŠ‚è›‡èº«çš„åæ ‡å€¼å¡«å……ç¬¬ä¸€èŠ‚è›‡èº«çš„åæ ‡å€¼ï¼Œä»¥æ­¤ç±»æ¨ï¼Œç›´åˆ°éå†å®Œæ•´ä¸ªè›‡èº«ã€‚</p><p>å¯ä»¥çœ‹åˆ°ï¼ŒRustå¯ä»¥æŠŠé—®é¢˜è¡¨è¾¾å¾—ç›¸å½“ç²¾ç»ƒã€‚</p><p>ä½ çœ‹ä¸€ä¸‹è¿™ä¸€æ­¥è¿è¡Œåçš„æ•ˆæœã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/48/65/48df50e0837a2080002b8bc343411865.png?wh=1151x1193\" alt=\"\"></p><h3>ç¬¬14æ­¥ï¼šè¾¹åƒè¾¹é•¿å¤§</h3><p>ä¸‹é¢å°±è¯¥å¤„ç†åƒé£Ÿç‰©å¹¶é•¿å¤§çš„æ•ˆæœäº†ã€‚åƒé£Ÿç‰©çš„åŸç†å°±æ˜¯å½“è›‡å¤´å æ®äº†é‚£ä¸ªé£Ÿç‰©çš„ä½ç½®æ—¶ï¼Œå°±åœ¨ç³»ç»Ÿä¸­æ³¨é”€æ‰é‚£ä¸ªé£Ÿç‰©ï¼Œç„¶ååœ¨è›‡èº«çš„å°¾å·´ä½ç½®å¤„æ·»åŠ ä¸€ä¸ªå°æ–¹å—ã€‚</p><p>ä½ çœ‹ä¸€ä¸‹è¿™ä¸€æ­¥å˜åŒ–çš„ä»£ç ã€‚</p><pre><code class=\"language-plain\">#[derive(Event)]\nstruct GrowthEvent;\n\n#[derive(Default, Resource)]\nstruct LastTailPosition(Option&lt;Position&gt;);\n\n        // æ›´æ–°Update systemé›†åˆ\n        .add_systems(Update, (\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snake_movement_input.before(snake_movement), \n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snake_movement,\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snake_eating,\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snake_growth,\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size_scaling, \n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; position_translation))\n\n    *last_tail_position = LastTailPosition(Some(*segment_positions.last().unwrap()));\n \n// å¤„ç†è›‡åƒé£Ÿç‰©çš„system   \nfn snake_eating(\n&nbsp; &nbsp; mut commands: Commands,\n&nbsp; &nbsp; mut growth_writer: EventWriter&lt;GrowthEvent&gt;,\n&nbsp; &nbsp; food_positions: Query&lt;(Entity, &amp;Position), With&lt;Food&gt;&gt;,\n&nbsp; &nbsp; head_positions: Query&lt;&amp;Position, With&lt;SnakeHead&gt;&gt;,\n) {\n&nbsp; &nbsp; for head_pos in head_positions.iter() {\n&nbsp; &nbsp; &nbsp; &nbsp; for (ent, food_pos) in food_positions.iter() {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // é€šè¿‡éå†æ¥åˆ¤æ–­æœ‰æ²¡æœ‰åƒåˆ°ä¸€ä¸ªé£Ÿç‰©\n            if food_pos == head_pos {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; commands.entity(ent).despawn();\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; growth_writer.send(GrowthEvent);\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; }\n}\n\n// å¤„ç†è›‡é•¿å¤§çš„system\nfn snake_growth(\n&nbsp; &nbsp; commands: Commands,\n&nbsp; &nbsp; last_tail_position: Res&lt;LastTailPosition&gt;,\n&nbsp; &nbsp; mut segments: ResMut&lt;SnakeSegments&gt;,\n&nbsp; &nbsp; mut growth_reader: EventReader&lt;GrowthEvent&gt;,\n) {\n    // é€šè¿‡äº‹ä»¶æœºåˆ¶æ¥è§£è€¦è›‡é•¿å¤§çš„é€»è¾‘\n&nbsp; &nbsp; if growth_reader.read().next().is_some() {\n&nbsp; &nbsp; &nbsp; &nbsp; segments.push(spawn_segment(commands, last_tail_position.0.unwrap()));\n&nbsp; &nbsp; }\n}\n</code></pre><p>æˆ‘ä»¬æ·»åŠ äº† <code>LastTailPosition(Option&lt;Position&gt;)</code> è¿™ä¸ªè›‡å°¾çš„ä½ç½®åæ ‡ä½œä¸ºèµ„æºæ¥å®æ—¶æ›´æ–°ï¼Œå¥½çŸ¥é“è›‡é•¿é•¿çš„æ—¶å€™ï¼Œåº”è¯¥åœ¨å“ªä¸ªä½ç½®æ·»åŠ segmentã€‚ç„¶åæ–°å¢äº† <code>snake_eating</code> å’Œ <code>snake_growth</code> ä¸¤ä¸ª systemã€‚</p><p>æˆ‘ä»¬æ–°å®šä¹‰äº† GrowthEvent é•¿å¤§çš„äº‹ä»¶ã€‚</p><p><code>snake_eating system</code> å¤„ç†åƒé£Ÿç‰©çš„ä¸šåŠ¡ï¼Œå°±æ˜¯å½“è›‡å¤´çš„ä½ç½®ä¸é£Ÿç‰©ä½ç½®é‡åˆæ—¶ï¼Œå°±è°ƒç”¨ <code>commands.entity(ent).despawn()</code> å°†é£Ÿç‰©ç»™æ³¨é”€æ‰ã€‚ç„¶åç”¨<code>growth_writer.send(GrowthEvent)</code> å‘ç³»ç»Ÿæ€»çº¿å‘é€ä¸€ä¸ªâ€œé•¿å¤§â€çš„äº‹ä»¶ã€‚</p><p><code>snake_growth system</code> å¤„ç†è›‡é•¿å¤§çš„ä¸šåŠ¡ï¼Œé€šè¿‡ <code>EventReader&lt;GrowthEvent&gt;</code> å®šä¹‰çš„ growth_readerï¼Œè¯»å–ç³»ç»Ÿä¸­çš„é•¿å¤§äº‹ä»¶ï¼Œä½¿ç”¨ <code>spawn_segment()</code> å’Œ <code>segments.push()</code> æŠŠå°¾å·´æ·»åŠ åˆ°è›‡çš„å…¨å±€ç»´æŠ¤èµ„æºä¸­å»ã€‚</p><p><code>snake_eating</code> å’Œ <code>snake_growth</code> åœ¨æ¯ä¸€å¸§æ›´æ–°æ—¶éƒ½ä¼šæ‰§è¡Œã€‚</p><p>å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡è¿™æ ·çš„äº‹ä»¶æ€»çº¿ï¼ŒBevyç³»ç»ŸæŠŠä¸šåŠ¡è§£è€¦å¾—ç›¸å½“æ¼‚äº®ã€‚æ¯ä¸ªsystemå°±ä¸“æ³¨äºå¤„ç†ä¸€ä»¶â€œå°â€äº‹æƒ…å°±è¡Œäº†ã€‚è¿™æ ·å¯¹äºæ„å»ºå¤æ‚çš„æ¸¸æˆç³»ç»Ÿæ¥è¯´ï¼Œå¤§å¤§å‡è½»äº†æˆ‘ä»¬çš„å¿ƒæ™ºè´Ÿæ‹…ã€‚</p><p>ä½ å¯ä»¥çœ‹ä¸€ä¸‹è¿™ä¸€æ­¥æ‰§è¡Œåçš„æ•ˆæœã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/a4/52/a4384058d0dfc46c3386c827bd7af652.png?wh=1151x1193\" alt=\"\"></p><h3>ç¬¬15æ­¥ï¼šæ’å¢™å’Œè‡ªèº«Game Over</h3><p>å¥½äº†ï¼Œæˆ‘ä»¬çš„è´ªåƒè›‡çš„ä¸»ä½“åŠŸèƒ½åŸºæœ¬å®ç°å¥½äº†ï¼Œä¸‹é¢éœ€è¦åŠ å…¥æ’å¢™å’Œæ’è‡ªèº«æ­»çš„åˆ¤æ–­ã€‚ä½ çœ‹ä¸€ä¸‹è¿™ä¸€æ­¥å˜åŒ–çš„ä»£ç ã€‚</p><pre><code class=\"language-plain\">#[derive(Event)]\nstruct GameOverEvent;\n        // æ³¨å†Œäº‹ä»¶åˆ°worldä¸­\n        .add_event::&lt;GameOverEvent&gt;()\n        .add_systems(Update, (\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snake_movement_input.before(snake_movement), \n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snake_movement,\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; game_over.after(snake_movement),\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snake_eating,\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snake_growth,\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size_scaling, \n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; position_translation))\n\n        // åˆ¤æ–­æ’å¢™çš„é€»è¾‘\n&nbsp; &nbsp; &nbsp; &nbsp; if head_pos.x &lt; 0\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || head_pos.y &lt; 0\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || head_pos.x as u32 &gt;= ARENA_WIDTH\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || head_pos.y as u32 &gt;= ARENA_HEIGHT\n&nbsp; &nbsp; &nbsp; &nbsp; {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; game_over_writer.send(GameOverEvent);\n&nbsp; &nbsp; &nbsp; &nbsp; }\n        // åˆ¤æ–­æ’è‡ªå·±èº«å­çš„é€»è¾‘\n&nbsp; &nbsp; &nbsp; &nbsp; if segment_positions.contains(&amp;head_pos) {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; game_over_writer.send(GameOverEvent);\n&nbsp; &nbsp; &nbsp; &nbsp; }\n        //\n\n// game over å­system\nfn game_over(\n&nbsp; &nbsp; mut commands: Commands,\n&nbsp; &nbsp; mut reader: EventReader&lt;GameOverEvent&gt;,\n&nbsp; &nbsp; segments_res: ResMut&lt;SnakeSegments&gt;,\n&nbsp; &nbsp; food: Query&lt;Entity, With&lt;Food&gt;&gt;,\n&nbsp; &nbsp; segments: Query&lt;Entity, With&lt;SnakeSegment&gt;&gt;,\n) {\n&nbsp; &nbsp; if reader.read().next().is_some() {\n&nbsp; &nbsp; &nbsp; &nbsp; for ent in food.iter().chain(segments.iter()) {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; commands.entity(ent).despawn();\n&nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; &nbsp; &nbsp; spawn_snake(commands, segments_res);\n&nbsp; &nbsp; }\n}\n</code></pre><p>æ’å¢™è¿™ä¸ªåªéœ€è¦åˆ¤æ–­æœ‰æ²¡æœ‰è¶…å‡ºgridè¾¹ç•Œå°±å¯ä»¥äº†ã€‚æ’è‡ªèº«åˆ¤æ–­ç”¨ <code>segment_positions.contains(&amp;head_pos)</code> çœ‹æ‰€æœ‰è›‡èº«çš„ segment çš„position Vecé‡Œæœ‰æ²¡æœ‰åŒ…å«è›‡å¤´çš„ä½ç½®ã€‚</p><p>æˆ‘ä»¬æ·»åŠ äº† <code>GameOverEvent</code> äº‹ä»¶å’Œ <code>game_over system</code>ï¼Œä¹Ÿæ˜¯ç”¨çš„å¼‚æ­¥äº‹ä»¶çš„æ–¹å¼ã€‚å½“æ”¶åˆ° <code>GameOverEvent</code> çš„æ—¶å€™ï¼ŒæŠŠæ‰€æœ‰çš„è›‡çš„entityå’Œé£Ÿç‰©çš„entityå…¨éƒ¨æ¸…ç†ï¼ˆdespawnï¼‰æ‰ã€‚æ³¨æ„è¿™é‡Œç”¨äº†ä¸¤ä¸ªè¿­ä»£å™¨çš„ <code>.chain()</code> æ–¹æ³•ï¼Œè®©æ¸…ç†å·¥ä½œè¡¨è¾¾å¾—æ›´ç´§å‡‘ï¼Œä½ å¯ä»¥ä½“ä¼šä¸€ä¸‹ã€‚</p><p>æ¸…ç†å®Œåï¼Œå†é‡æ–°åˆ›å»ºè›‡ï¼Œæ¸¸æˆé‡æ–°å¼€å§‹ã€‚åˆ°è¿™ä¸€æ­¥ï¼Œæ¸¸æˆå·²ç»åŸºæœ¬èƒ½ç©äº†ï¼Œè¿˜å†™ä»€ä¹ˆä»£ç ï¼Œå…ˆç©å‡ æŠŠå§ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/7f/67/7f1b8ca4a2fd813a880363fcc78b6667.png?wh=1151x1193\" alt=\"\"></p><p>ç›®å‰ä¸ºæ­¢ï¼Œæ•´ä¸ªä»£ç ä¸è¿‡330è¡Œå·¦å³ã€‚</p><h2>å°ç»“</h2><p>è¿™èŠ‚è¯¾æˆ‘ä»¬é€šè¿‡è‡ªå·±åŠ¨æ‰‹ç¼–å†™ä¸€ä¸ªè´ªåƒè›‡å°æ¸¸æˆï¼Œå­¦ä¹ äº†Rustæ¸¸æˆå¼€å‘å¼•æ“Bevyçš„åŸºæœ¬ä½¿ç”¨æ–¹å¼ã€‚Bevyæ¸¸æˆå¼•æ“å……åˆ†åˆ©ç”¨Rustè¯­è¨€çš„æ— å¿§å¹¶å‘å’Œå¼ºå¤§çš„è¡¨è¾¾èƒ½åŠ›ï¼Œè®©å¼€å‘æ¸¸æˆå˜å¾—è·Ÿæ¸¸æˆä¸€æ ·å¥½ç©ã€‚æ•´ä¸ªè¿‡ç¨‹ä¸‹æ¥ï¼Œå¿ƒæƒ…æ„‰å¿«ã€èˆ’ç•…ã€‚ä½ å¯ä»¥è·Ÿç€æˆ‘ä¸€æ­¥ä¸€æ­¥æ•²ä»£ç ï¼Œä½“ä¼šè¿™ç§æ„Ÿè§‰ã€‚</p><p>Bevyçš„æ ¸å¿ƒæ˜¯ä¸€å¥—ECSç³»ç»Ÿï¼ŒECSæœ¬è´¨ä¸Šæ¥è¯´æ˜¯ä¸€å¥—ç¼–ç¨‹èŒƒå¼ï¼Œä¸ä»…é™äºåœ¨æ¸¸æˆä¸­ä½¿ç”¨ï¼Œå®ƒä¹Ÿå¯ä»¥åœ¨å…¶ä»–çš„ä¸šåŠ¡ç³»ç»Ÿä¸­ä½¿ç”¨ã€‚ä½ æœ‰å¿…è¦å¤šèŠ±ç‚¹æ—¶é—´æŸ¥é˜…ç›¸å…³èµ„æ–™å»ç†è§£å®ƒã€‚åé¢æœ‰æœºä¼šæˆ‘ä¹Ÿä¼šç»§ç»­å‡ºç›¸å…³çš„ç ”ç©¶å†…å®¹ã€‚</p><p>å†™Bevyä»£ç çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¦ç†è§£Bevyæ˜¯ä¸€ç§Runtimeï¼Œæˆ‘ä»¬å†™çš„ä»£ç å®é™…ä¼šè¢«è¿™ä¸ªRuntimeæ‰˜ç®¡è¿è¡Œã€‚æˆ‘ä»¬è¦åšçš„å°±æ˜¯æŒ‰ç…§ECSè§„èŒƒå®šä¹‰Componentã€Resourceã€Eventç­‰ï¼Œå®ç° system æ·»åŠ åˆ°è¿™ä¸ª Runtime ä¸­ã€‚åº•å±‚é‚£äº›è„æ´»ç´¯æ´»Bevyå…¨å¸®æˆ‘ä»¬åšäº†ï¼Œæˆ‘ä»¬åªéœ€è¦ä¸“å¿ƒæŠ½è±¡æ¨¡å‹ã€å®šä¹‰ç»“æ„ã€å¤„ç†ä¸šåŠ¡ã€‚</p><p>ç„¶åï¼Œé€šè¿‡è¿™èŠ‚è¯¾çš„å†…å®¹æˆ‘ä»¬å¯ä»¥ä½“ä¼šåˆ°ï¼Œå†™å°æ¸¸æˆå…¶å®ä¹Ÿæ˜¯ä¸€ç§ç›¸å½“å¥½çš„å»ºæ¨¡èƒ½åŠ›çš„è®­ç»ƒï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ç§æœ‰è¶£çš„æ–¹æ³•æå‡è‡ªå·±åœ¨è¿™æ–¹é¢çš„èƒ½åŠ›ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/5c/yy/5cfe1952919841131d5c1a1b8deddayy.jpg?wh=2942x4497\" alt=\"\"></p><p>æœ¬è®²æºä»£ç ï¼š<a href=\"https://github.com/miketang84/jikeshijian/tree/master/27-bevy_snake\">https://github.com/miketang84/jikeshijian/tree/master/27-bevy_snake</a></p><p>å¿…è¯»çš„ä¸¤ä¸ªBevyèµ„æ–™ï¼š</p><ul>\n<li><a href=\"https://bevyengine.org/learn/book/introduction/\">https://bevyengine.org/learn/book/introduction/</a></li>\n<li><a href=\"https://bevy-cheatbook.github.io/introduction.html\">https://bevy-cheatbook.github.io/introduction.html</a></li>\n</ul><h2>æ€è€ƒé¢˜</h2><p>è¿™èŠ‚è¯¾çš„ä»£ç è¿˜æœ‰ä¸ªé—®é¢˜ï¼Œå°±æ˜¯é£Ÿç‰©æœ‰å¯èƒ½åœ¨å·²ç»äº§ç”Ÿè¿‡çš„åœ°æ–¹äº§ç”Ÿï¼Œä¹Ÿæœ‰å¯èƒ½åœ¨è›‡èº«ä¸Šäº§ç”Ÿï¼Œè¯·é—®å¦‚ä½•å¤„ç†è¿™ä¸ªBugï¼Ÿæ¬¢è¿ä½ æŠŠä½ çš„å¤„ç†æ€è·¯å’Œå®ç°ä»£ç åˆ†äº«å‡ºæ¥ï¼Œæˆ‘ä»¬ä¸€èµ·æ¢è®¨ï¼Œå¦‚æœä½ è§‰å¾—è¿™èŠ‚è¯¾å¯¹ä½ æœ‰å¸®åŠ©çš„è¯ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾çš„å†…å®¹åˆ†äº«ç»™å…¶ä»–æœ‹å‹ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼</p>","comments":[{"had_liked":false,"id":387136,"user_name":"NiceBlueChai","can_delete":false,"product_type":"c1","uid":2038718,"ip_address":"å±±ä¸œ","ucode":"2043333890C448","user_header":"https://static001.geekbang.org/account/avatar/00/1f/1b/be/525e05ae.jpg","comment_is_top":false,"comment_ctime":1706541746,"is_pvip":true,"replies":[{"id":141111,"content":"å“ˆå“ˆï¼ŒçœŸçš„æ˜¯ã€‚ğŸ¤”ğŸ‘ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1706586532,"ip_address":"é‡åº†","comment_id":387136,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"è¿˜æœ‰ä¸ªbugï¼Œå‘ä¸Šèµ°çš„è¿‡ç¨‹ä¸­å¿«é€ŸæŒ‰å·¦ä¸‹ï¼ˆæˆ–è€…å³ä¸‹ï¼‰ï¼Œè›‡ç›´æ¥åŸåœ°å‘ç›¸åæ–¹å‘èµ°äº†","like_count":1,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":636616,"discussion_content":"å“ˆå“ˆï¼ŒçœŸçš„æ˜¯ã€‚ğŸ¤”ğŸ‘ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1706586532,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":386883,"user_name":"seven9t","can_delete":false,"product_type":"c1","uid":1979955,"ip_address":"å¹¿ä¸œ","ucode":"B7CA7D62C56938","user_header":"https://static001.geekbang.org/account/avatar/00/1e/36/33/3411df0d.jpg","comment_is_top":false,"comment_ctime":1705804204,"is_pvip":false,"replies":[{"id":141075,"content":"éå¸¸å¼ºçš„åŠ¨æ‰‹èƒ½åŠ›ğŸ‘ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1705970760,"ip_address":"é‡åº†","comment_id":386883,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"è¡¥å……äº†ä¸ªæœ€èµ·ç çš„é•¿æŒ‰åŠ é€ŸåŠŸèƒ½ï¼Œæ²¡æ‰¾åˆ°timerçš„å°±åœ°è°ƒé¢‘æ¥å£ï¼Œåªèƒ½å¦å¼€äº†ä¸ªtimeråšåˆ‡æ¢ã€‚å„ä½æœ‰å•¥æ›´å¥½åŠæ³•ä¹ˆã€‚","like_count":0,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":636340,"discussion_content":"éå¸¸å¼ºçš„åŠ¨æ‰‹èƒ½åŠ›ğŸ‘ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1705970760,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":386059,"user_name":"unistart","can_delete":false,"product_type":"c1","uid":1524770,"ip_address":"æ¹–å—","ucode":"C51E5D242530D2","user_header":"https://static001.geekbang.org/account/avatar/00/17/44/22/403a340a.jpg","comment_is_top":false,"comment_ctime":1703942257,"is_pvip":false,"replies":[{"id":140731,"content":"éå¸¸æ£’çš„æ€è€ƒ ğŸ‘. è¦åˆ¤æ–­é£Ÿç‰©ä½ç½®æ˜¯å¦é‡åˆçš„è¯, éœ€è¦ç”¨ä¸€ä¸ªç»“æ„æ¥ç»´æŠ¤é£Ÿç‰©çš„ Positions, å°†å…¶è®¾å®šä¸º Resource. åœ¨æœ€æ–°ä¸€ç¯‡æ€»ç»“æ›´æ–°ä¸­ä¼šè®²åˆ°è¿™ä¸ªé—®é¢˜.","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1704171143,"ip_address":"é‡åº†","comment_id":386059,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"BUG: é£Ÿç‰©å¯èƒ½åœ¨è›‡èº«ä¸Šäº§ç”Ÿ\nå¤„ç†:  åœ¨ç”Ÿæˆé£Ÿç‰©çš„æ—¶å€™ï¼Œåˆ¤æ–­ä¸€ä¸‹éšæœºç”Ÿæˆçš„Positionå€¼æ˜¯å¦å’Œå½“å‰è›‡çš„æŸä¸€ä¸ªéƒ¨åˆ†ä½ç½®æ˜¯é‡åˆçš„ï¼Œå¦‚æœæ˜¯å°±ç›´æ¥returnï¼Œä¸ç”Ÿæˆé£Ÿç‰©ã€‚\n\n&#47;&#47; ä¿®æ”¹food_spawner\nfn food_spawner(\n    mut commands: Commands, \n    time: Res&lt;Time&gt;,\n    mut timer: ResMut&lt;FoodSpawnTimer&gt;,\n    segment_pos_set: Query&lt;&amp;Position, With&lt;SnakeSegment&gt;&gt;\n)\n{\n    &#47;&#47; ...\n\n    let rand_x: i32 = (random::&lt;f32&gt;() * ARENA_WIDTH as f32) as i32;\n    let rand_y: i32 = (random::&lt;f32&gt;() * ARENA_HEIGHT as f32) as i32;\n        \n    for pos in segment_pos_set.iter() {\n        if pos.x == rand_x &amp;&amp; pos.y == rand_y {\n            return;\n        }\n    }\n\n    &#47;&#47; ...\n    .insert(Position {\n        x: rand_x,\n        y: rand_y,\n    })\n    &#47;&#47; ...\n}\n\nBUG: é£Ÿç‰©æœ‰å¯èƒ½åœ¨å·²ç»äº§ç”Ÿè¿‡çš„åœ°æ–¹äº§ç”Ÿ\nä¸ªäººæ„Ÿè§‰è¿™ä¸ªä¸å¤ªç®—bugå§ï¼Œåˆ†ä¸¤ç§æƒ…å†µçœ‹ï¼Œä¸€ç§æ˜¯é£Ÿç‰©Aä¹‹å‰è¢«åƒè¿‡ï¼Œåˆåœ¨ç›¸åŒçš„ä½ç½®ç”Ÿæˆäº†æ–°çš„é£Ÿç‰©ï¼Œè¿™ä¸ªåº”è¯¥æ˜¯æ²¡é—®é¢˜çš„ï¼›å¦ä¸€ç§å°±æ˜¯é£Ÿç‰©Aä¹‹å‰æ²¡æœ‰è¢«åƒè¿‡ï¼ŒåŒæ—¶æ–°ç”Ÿæˆçš„é£Ÿç‰©Bçš„ä½ç½®å’Œé£Ÿç‰©Aé‡åˆï¼Œè¿™æ ·ç¡®å®è²Œä¼¼æœ‰é—®é¢˜ã€‚\nä½†æ˜¯æˆ‘ä¸çŸ¥é“Bevyæ˜¯å¦‚ä½•å¤„ç†çš„ï¼ŒæŒ‰æˆ‘çš„ç†è§£æ¥è¯´é£Ÿç‰©Båº”è¯¥ä¼šç›–æ‰é£Ÿç‰©Aï¼Œå³æŸä¸€ä½ç½®åªä¼šæœ‰ä¸€ä¸ªæœ€æ–°çš„é£Ÿç‰©å®ä½“ã€‚è¿˜æ˜¯è¯´bevyä¸­å‡ºç°è¿™ç§æƒ…å†µï¼ŒåŒä¸€ä½ç½®ä¼šæœ‰å¤šä¸ªå®ä½“ã€‚å¦‚æœæ˜¯åŒä¸€ä½ç½®æœ‰å¤šä¸ªå®ä½“çš„è¯ï¼Œé‚£ä¹ˆå†Queryä¸€ä¸‹å·²ç»ç”Ÿæˆçš„Foodçš„Positionï¼Œç„¶åå’Œæ–°ç”Ÿæˆçš„é£Ÿç‰©åæ ‡æ¯”è¾ƒä¸€ä¸‹æ˜¯å¦æœ‰å‡ºç°çš„é‡åˆå°±è¡Œäº†å§ã€‚","like_count":0,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":634880,"discussion_content":"éå¸¸æ£’çš„æ€è€ƒ ğŸ‘. è¦åˆ¤æ–­é£Ÿç‰©ä½ç½®æ˜¯å¦é‡åˆçš„è¯, éœ€è¦ç”¨ä¸€ä¸ªç»“æ„æ¥ç»´æŠ¤é£Ÿç‰©çš„ Positions, å°†å…¶è®¾å®šä¸º Resource. åœ¨æœ€æ–°ä¸€ç¯‡æ€»ç»“æ›´æ–°ä¸­ä¼šè®²åˆ°è¿™ä¸ªé—®é¢˜.","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1704171143,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1979955,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/36/33/3411df0d.jpg","nickname":"seven9t","note":"","ucode":"B7CA7D62C56938","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":636117,"discussion_content":"ç›®å‰æ˜¯å·æ‡’çš„åšæ³•ï¼Œé‡åˆçš„ä¸€èµ·è¢«åƒæ‰äº†ï¼Œå› ä¸ºsnake_eatingé‡Œçš„food loopæ²¡æœ‰break","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1705637539,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":385934,"user_name":"å¤§ç™½èœğŸ¥¬","can_delete":false,"product_type":"c1","uid":1812108,"ip_address":"é‡åº†","ucode":"A5D7350C80C001","user_header":"https://static001.geekbang.org/account/avatar/00/1b/a6/8c/344f03dd.jpg","comment_is_top":false,"comment_ctime":1703686552,"is_pvip":false,"replies":[{"id":140656,"content":"å¯¹çš„å¯¹çš„","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1703770599,"ip_address":"é‡åº†","comment_id":385934,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"14æ­¥é‚£é‡Œéœ€è¦æ·»åŠ LastTailPositionèµ„æºï¼Œ Appéœ€è¦æ·»åŠ  .insert_resource(LastTailPosition::default())","like_count":0,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":634656,"discussion_content":"å¯¹çš„å¯¹çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1703770600,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":385863,"user_name":"åå…«å“¥","can_delete":false,"product_type":"c1","uid":1027167,"ip_address":"å¤©æ´¥","ucode":"C0130252F97814","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ac/5f/894761f8.jpg","comment_is_top":false,"comment_ctime":1703555569,"is_pvip":false,"replies":[{"id":140631,"content":"ä¸é”™çš„æ€è·¯ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1703577740,"ip_address":"é‡åº†","comment_id":385863,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"å½“å¹´ç”¨vb.netç”¨äº†1åƒè¡Œå®ç°çš„ã€‚æ€è·¯æ˜¯æŒ‰é’®æ•°ç»„ï¼Œä¸€ä¸ªäºŒç»´æ•°ç»„ã€‚","like_count":0,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":634497,"discussion_content":"ä¸é”™çš„æ€è·¯ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1703577740,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]}]}