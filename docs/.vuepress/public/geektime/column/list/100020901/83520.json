{"id":83520,"title":"42 | æ¡ˆä¾‹ç¯‡ï¼šå¦‚ä½•ä¼˜åŒ– NAT æ€§èƒ½ï¼Ÿï¼ˆä¸‹ï¼‰","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å€ªæœ‹é£ã€‚</p><p>ä¸Šä¸€èŠ‚ï¼Œæˆ‘ä»¬å­¦ä¹ äº† NAT çš„åŸç†ï¼Œæ˜ç™½äº†å¦‚ä½•åœ¨ Linux ä¸­ç®¡ç† NAT è§„åˆ™ã€‚å…ˆæ¥ç®€å•å¤ä¹ ä¸€ä¸‹ã€‚</p><p>NAT æŠ€æœ¯èƒ½å¤Ÿé‡å†™ IP æ•°æ®åŒ…çš„æº IP æˆ–ç›®çš„ IPï¼Œæ‰€ä»¥æ™®éç”¨æ¥è§£å†³å…¬ç½‘ IP åœ°å€çŸ­ç¼ºçš„é—®é¢˜ã€‚å®ƒå¯ä»¥è®©ç½‘ç»œä¸­çš„å¤šå°ä¸»æœºï¼Œé€šè¿‡å…±äº«åŒä¸€ä¸ªå…¬ç½‘ IP åœ°å€ï¼Œæ¥è®¿é—®å¤–ç½‘èµ„æºã€‚åŒæ—¶ï¼Œç”±äº NAT å±è”½äº†å†…ç½‘ç½‘ç»œï¼Œä¹Ÿä¸ºå±€åŸŸç½‘ä¸­æœºå™¨èµ·åˆ°å®‰å…¨éš”ç¦»çš„ä½œç”¨ã€‚</p><p>Linux ä¸­çš„NAT ï¼ŒåŸºäºå†…æ ¸çš„è¿æ¥è·Ÿè¸ªæ¨¡å—å®ç°ã€‚æ‰€ä»¥ï¼Œå®ƒç»´æŠ¤æ¯ä¸ªè¿æ¥çŠ¶æ€çš„åŒæ—¶ï¼Œä¹Ÿå¯¹ç½‘ç»œæ€§èƒ½æœ‰ä¸€å®šå½±å“ã€‚é‚£ä¹ˆï¼Œç¢°åˆ° NAT æ€§èƒ½é—®é¢˜æ—¶ï¼Œæˆ‘ä»¬åˆè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘å°±é€šè¿‡ä¸€ä¸ªæ¡ˆä¾‹ï¼Œå¸¦ä½ å­¦ä¹  NAT æ€§èƒ½é—®é¢˜çš„åˆ†ææ€è·¯ã€‚</p><h2>æ¡ˆä¾‹å‡†å¤‡</h2><p>ä¸‹é¢çš„æ¡ˆä¾‹ä»ç„¶åŸºäº Ubuntu 18.04ï¼ŒåŒæ ·é€‚ç”¨äºå…¶ä»–çš„ Linux ç³»ç»Ÿã€‚æˆ‘ä½¿ç”¨çš„æ¡ˆä¾‹ç¯å¢ƒæ˜¯è¿™æ ·çš„ï¼š</p><ul>\n<li>\n<p>æœºå™¨é…ç½®ï¼š2 CPUï¼Œ8GB å†…å­˜ã€‚</p>\n</li>\n<li>\n<p>é¢„å…ˆå®‰è£… dockerã€tcpdumpã€curlã€abã€SystemTap ç­‰å·¥å…·ï¼Œæ¯”å¦‚</p>\n</li>\n</ul><pre><code>  # Ubuntu\n  $ apt-get install -y docker.io tcpdump curl apache2-utils\n  \n  # CentOS\n  $ curl -fsSL https://get.docker.com | sh\n  $ yum install -y tcpdump curl httpd-tools\n</code></pre><p>å¤§éƒ¨åˆ†å·¥å…·ï¼Œä½ åº”è¯¥éƒ½æ¯”è¾ƒç†Ÿæ‚‰ï¼Œè¿™é‡Œæˆ‘ç®€å•ä»‹ç»ä¸€ä¸‹ SystemTap ã€‚</p><p><a href=\"https://sourceware.org/systemtap/\">SystemTap</a> æ˜¯ Linux çš„ä¸€ç§åŠ¨æ€è¿½è¸ªæ¡†æ¶ï¼Œå®ƒæŠŠç”¨æˆ·æä¾›çš„è„šæœ¬ï¼Œè½¬æ¢ä¸ºå†…æ ¸æ¨¡å—æ¥æ‰§è¡Œï¼Œç”¨æ¥ç›‘æµ‹å’Œè·Ÿè¸ªå†…æ ¸çš„è¡Œä¸ºã€‚å…³äºå®ƒçš„åŸç†ï¼Œä½ æš‚æ—¶ä¸ç”¨æ·±ç©¶ï¼Œåé¢çš„å†…å®¹è¿˜ä¼šä»‹ç»åˆ°ã€‚è¿™é‡Œä½ åªè¦çŸ¥é“æ€ä¹ˆå®‰è£…å°±å¯ä»¥äº†ï¼š</p><!-- [[[read_end]]] --><pre><code># Ubuntu\napt-get install -y systemtap-runtime systemtap\n# Configure ddebs source\necho &quot;deb http://ddebs.ubuntu.com $(lsb_release -cs) main restricted universe multiverse\ndeb http://ddebs.ubuntu.com $(lsb_release -cs)-updates main restricted universe multiverse\ndeb http://ddebs.ubuntu.com $(lsb_release -cs)-proposed main restricted universe multiverse&quot; | \\\nsudo tee -a /etc/apt/sources.list.d/ddebs.list\n# Install dbgsym\napt-key adv --keyserver keyserver.ubuntu.com --recv-keys F2EDC64DC5AEE1F6B9C621F0C8CAB6595FDFF622\napt-get update\napt install ubuntu-dbgsym-keyring\nstap-prep\napt-get install linux-image-`uname -r`-dbgsym\n\n# CentOS\nyum install systemtap kernel-devel yum-utils kernel\nstab-prep\n</code></pre><p>æœ¬æ¬¡æ¡ˆä¾‹è¿˜æ˜¯æˆ‘ä»¬æœ€å¸¸è§çš„ Nginxï¼Œå¹¶ä¸”ä¼šç”¨ ab ä½œä¸ºå®ƒçš„å®¢æˆ·ç«¯ï¼Œè¿›è¡Œå‹åŠ›æµ‹è¯•ã€‚æ¡ˆä¾‹ä¸­æ€»å…±ç”¨åˆ°ä¸¤å°è™šæ‹Ÿæœºï¼Œæˆ‘ç”»äº†ä¸€å¼ å›¾æ¥è¡¨ç¤ºå®ƒä»¬çš„å…³ç³»ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/70/c6/7081ad1b72535107e94f852ac41e0dc6.png?wh=1632*1032\" alt=\"\"></p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ‰“å¼€ä¸¤ä¸ªç»ˆç«¯ï¼Œåˆ†åˆ« SSH ç™»å½•åˆ°ä¸¤å°æœºå™¨ä¸Šï¼ˆä»¥ä¸‹æ­¥éª¤ï¼Œå‡è®¾ç»ˆç«¯ç¼–å·ä¸å›¾ç¤ºVM ç¼–å·ä¸€è‡´ï¼‰ï¼Œå¹¶å®‰è£…ä¸Šé¢æåˆ°çš„è¿™äº›å·¥å…·ã€‚æ³¨æ„ï¼Œcurl å’Œ ab åªéœ€è¦åœ¨å®¢æˆ·ç«¯ VMï¼ˆå³ VM2ï¼‰ä¸­å®‰è£…ã€‚</p><p>åŒä»¥å‰çš„æ¡ˆä¾‹ä¸€æ ·ï¼Œä¸‹é¢çš„æ‰€æœ‰å‘½ä»¤éƒ½é»˜è®¤ä»¥ root ç”¨æˆ·è¿è¡Œã€‚å¦‚æœä½ æ˜¯ç”¨æ™®é€šç”¨æˆ·èº«ä»½ç™»é™†ç³»ç»Ÿï¼Œè¯·è¿è¡Œ sudo su root å‘½ä»¤ï¼Œåˆ‡æ¢åˆ° root ç”¨æˆ·ã€‚</p><blockquote>\n<p>å¦‚æœå®‰è£…è¿‡ç¨‹ä¸­æœ‰ä»€ä¹ˆé—®é¢˜ï¼ŒåŒæ ·é¼“åŠ±ä½ å…ˆè‡ªå·±æœç´¢è§£å†³ï¼Œè§£å†³ä¸äº†çš„ï¼Œå¯ä»¥åœ¨ç•™è¨€åŒºå‘æˆ‘æé—®ã€‚å¦‚æœä½ ä»¥å‰å·²ç»å®‰è£…è¿‡äº†ï¼Œå°±å¯ä»¥å¿½ç•¥è¿™ä¸€ç‚¹äº†ã€‚</p>\n</blockquote><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±è¿›å…¥åˆ°æ¡ˆä¾‹ç¯èŠ‚ã€‚</p><h2>æ¡ˆä¾‹åˆ†æ</h2><p>ä¸ºäº†å¯¹æ¯” NAT å¸¦æ¥çš„æ€§èƒ½é—®é¢˜ï¼Œæˆ‘ä»¬é¦–å…ˆè¿è¡Œä¸€ä¸ªä¸ç”¨ NAT çš„ Nginx æœåŠ¡ï¼Œå¹¶ç”¨ ab æµ‹è¯•å®ƒçš„æ€§èƒ½ã€‚</p><p>åœ¨ç»ˆç«¯ä¸€ä¸­ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œå¯åŠ¨ Nginxï¼Œæ³¨æ„é€‰é¡¹ --network=host ï¼Œè¡¨ç¤ºå®¹å™¨ä½¿ç”¨ Host ç½‘ç»œæ¨¡å¼ï¼Œå³ä¸ä½¿ç”¨ NATï¼š</p><pre><code>$ docker run --name nginx-hostnet --privileged --network=host -itd feisky/nginx:80\n</code></pre><p>ç„¶ååˆ°ç»ˆç«¯äºŒä¸­ï¼Œæ‰§è¡Œ curl å‘½ä»¤ï¼Œç¡®è®¤ Nginx æ­£å¸¸å¯åŠ¨ï¼š</p><pre><code>$ curl http://192.168.0.30/\n...\n&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre><p>ç»§ç»­åœ¨ç»ˆç«¯äºŒä¸­ï¼Œæ‰§è¡Œ ab å‘½ä»¤ï¼Œå¯¹ Nginx è¿›è¡Œå‹åŠ›æµ‹è¯•ã€‚ä¸è¿‡åœ¨æµ‹è¯•å‰è¦æ³¨æ„ï¼ŒLinux é»˜è®¤å…è®¸æ‰“å¼€çš„æ–‡ä»¶æè¿°æ•°æ¯”è¾ƒå°ï¼Œæ¯”å¦‚åœ¨æˆ‘çš„æœºå™¨ä¸­ï¼Œè¿™ä¸ªå€¼åªæœ‰ 1024ï¼š</p><pre><code># open files\n$ ulimit -n\n1024\n</code></pre><p>æ‰€ä»¥ï¼Œæ‰§è¡Œ ab å‰ï¼Œå…ˆè¦æŠŠè¿™ä¸ªé€‰é¡¹è°ƒå¤§ï¼Œæ¯”å¦‚è°ƒæˆ 65536:</p><pre><code># ä¸´æ—¶å¢å¤§å½“å‰ä¼šè¯çš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ•°\n$ ulimit -n 65536\n</code></pre><p>æ¥ä¸‹æ¥ï¼Œå†å»æ‰§è¡Œ ab å‘½ä»¤ï¼Œè¿›è¡Œå‹åŠ›æµ‹è¯•ï¼š</p><pre><code># -cè¡¨ç¤ºå¹¶å‘è¯·æ±‚æ•°ä¸º5000ï¼Œ-nè¡¨ç¤ºæ€»çš„è¯·æ±‚æ•°ä¸º10ä¸‡\n# -rè¡¨ç¤ºå¥—æ¥å­—æ¥æ”¶é”™è¯¯æ—¶ä»ç„¶ç»§ç»­æ‰§è¡Œï¼Œ-sè¡¨ç¤ºè®¾ç½®æ¯ä¸ªè¯·æ±‚çš„è¶…æ—¶æ—¶é—´ä¸º2s\n$ ab -c 5000 -n 100000 -r -s 2 http://192.168.0.30/\n...\nRequests per second:    6576.21 [#/sec] (mean)\nTime per request:       760.317 [ms] (mean)\nTime per request:       0.152 [ms] (mean, across all concurrent requests)\nTransfer rate:          5390.19 [Kbytes/sec] received\n\nConnection Times (ms)\n              min  mean[+/-sd] median   max\nConnect:        0  177 714.3      9    7338\nProcessing:     0   27  39.8     19     961\nWaiting:        0   23  39.5     16     951\nTotal:          1  204 716.3     28    7349\n...\n</code></pre><p>å…³äº ab è¾“å‡ºç•Œé¢çš„å«ä¹‰ï¼Œæˆ‘å·²ç»åœ¨ <a href=\"https://time.geekbang.org/column/article/81497\">æ€ä¹ˆè¯„ä¼°ç³»ç»Ÿçš„ç½‘ç»œæ€§èƒ½</a> æ–‡ç« ä¸­ä»‹ç»è¿‡ï¼Œå¿˜äº†çš„è¯è‡ªå·±å…ˆå»å¤ä¹ ã€‚ä»è¿™æ¬¡çš„ç•Œé¢ï¼Œä½ å¯ä»¥çœ‹å‡ºï¼š</p><ul>\n<li>\n<p>æ¯ç§’è¯·æ±‚æ•°ï¼ˆRequests  per secondï¼‰ä¸º 6576ï¼›</p>\n</li>\n<li>\n<p>æ¯ä¸ªè¯·æ±‚çš„å¹³å‡å»¶è¿Ÿï¼ˆTime per requestï¼‰ä¸º 760msï¼›</p>\n</li>\n<li>\n<p>å»ºç«‹è¿æ¥çš„å¹³å‡å»¶è¿Ÿï¼ˆConnectï¼‰ä¸º 177msã€‚</p>\n</li>\n</ul><p>è®°ä½è¿™å‡ ä¸ªæ•°å€¼ï¼Œè¿™å°†æ˜¯æ¥ä¸‹æ¥æ¡ˆä¾‹çš„åŸºå‡†æŒ‡æ ‡ã€‚</p><blockquote>\n<p>æ³¨æ„ï¼Œä½ çš„æœºå™¨ä¸­ï¼Œè¿è¡Œç»“æœè·Ÿæˆ‘çš„å¯èƒ½ä¸ä¸€æ ·ï¼Œä¸è¿‡æ²¡å…³ç³»ï¼Œå¹¶ä¸å½±å“æ¥ä¸‹æ¥çš„æ¡ˆä¾‹åˆ†ææ€è·¯ã€‚</p>\n</blockquote><p>æ¥ç€ï¼Œå›åˆ°ç»ˆç«¯ä¸€ï¼Œåœæ­¢è¿™ä¸ªæœªä½¿ç”¨NATçš„Nginxåº”ç”¨ï¼š</p><pre><code>$ docker rm -f nginx-hostnet\n</code></pre><p>å†æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œå¯åŠ¨ä»Šå¤©çš„æ¡ˆä¾‹åº”ç”¨ã€‚æ¡ˆä¾‹åº”ç”¨ç›‘å¬åœ¨ 8080 ç«¯å£ï¼Œå¹¶ä¸”ä½¿ç”¨äº† DNAT ï¼Œæ¥å®ç° Host çš„ 8080 ç«¯å£ï¼Œåˆ°å®¹å™¨çš„ 8080 ç«¯å£çš„æ˜ å°„å…³ç³»ï¼š</p><pre><code>$ docker run --name nginx --privileged -p 8080:8080 -itd feisky/nginx:nat\n</code></pre><p>Nginx å¯åŠ¨åï¼Œä½ å¯ä»¥æ‰§è¡Œ iptables å‘½ä»¤ï¼Œç¡®è®¤ DNAT è§„åˆ™å·²ç»åˆ›å»ºï¼š</p><pre><code>$ iptables -nL -t nat\nChain PREROUTING (policy ACCEPT)\ntarget     prot opt source               destination\nDOCKER     all  --  0.0.0.0/0            0.0.0.0/0            ADDRTYPE match dst-type LOCAL\n\n...\n\nChain DOCKER (2 references)\ntarget     prot opt source               destination\nRETURN     all  --  0.0.0.0/0            0.0.0.0/0\nDNAT       tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:8080 to:172.17.0.2:8080\n</code></pre><p>ä½ å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ PREROUTING é“¾ä¸­ï¼Œç›®çš„ä¸ºæœ¬åœ°çš„è¯·æ±‚ï¼Œä¼šè½¬åˆ° DOCKER é“¾ï¼›è€Œåœ¨ DOCKER é“¾ä¸­ï¼Œç›®çš„ç«¯å£ä¸º 8080 çš„ tcp è¯·æ±‚ï¼Œä¼šè¢« DNAT åˆ° 172.17.0.2 çš„ 8080 ç«¯å£ã€‚å…¶ä¸­ï¼Œ172.17.0.2 å°±æ˜¯ Nginx å®¹å™¨çš„ IP åœ°å€ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ‡æ¢åˆ°ç»ˆç«¯äºŒä¸­ï¼Œæ‰§è¡Œ curl å‘½ä»¤ï¼Œç¡®è®¤ Nginx å·²ç»æ­£å¸¸å¯åŠ¨ï¼š</p><pre><code>$ curl http://192.168.0.30:8080/\n...\n&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre><p>ç„¶åï¼Œå†æ¬¡æ‰§è¡Œä¸Šè¿°çš„ ab å‘½ä»¤ï¼Œä¸è¿‡è¿™æ¬¡æ³¨æ„ï¼Œè¦æŠŠè¯·æ±‚çš„ç«¯å£å·æ¢æˆ 8080ï¼š</p><pre><code># -cè¡¨ç¤ºå¹¶å‘è¯·æ±‚æ•°ä¸º5000ï¼Œ-nè¡¨ç¤ºæ€»çš„è¯·æ±‚æ•°ä¸º10ä¸‡\n# -rè¡¨ç¤ºå¥—æ¥å­—æ¥æ”¶é”™è¯¯æ—¶ä»ç„¶ç»§ç»­æ‰§è¡Œï¼Œ-sè¡¨ç¤ºè®¾ç½®æ¯ä¸ªè¯·æ±‚çš„è¶…æ—¶æ—¶é—´ä¸º2s\n$ ab -c 5000 -n 100000 -r -s 2 http://192.168.0.30:8080/\n...\napr_pollset_poll: The timeout specified has expired (70007)\nTotal of 5602 requests completed\n</code></pre><p>æœç„¶ï¼Œåˆšæ‰æ­£å¸¸è¿è¡Œçš„ ab ï¼Œç°åœ¨å¤±è´¥äº†ï¼Œè¿˜æŠ¥äº†è¿æ¥è¶…æ—¶çš„é”™è¯¯ã€‚è¿è¡Œ ab æ—¶çš„-s å‚æ•°ï¼Œè®¾ç½®äº†æ¯ä¸ªè¯·æ±‚çš„è¶…æ—¶æ—¶é—´ä¸º 2sï¼Œè€Œä»è¾“å‡ºå¯ä»¥çœ‹åˆ°ï¼Œè¿™æ¬¡åªå®Œæˆäº† 5602 ä¸ªè¯·æ±‚ã€‚</p><p>æ—¢ç„¶æ˜¯ä¸ºäº†å¾—åˆ° ab çš„æµ‹è¯•ç»“æœï¼Œæˆ‘ä»¬ä¸å¦¨æŠŠè¶…æ—¶æ—¶é—´å»¶é•¿ä¸€ä¸‹è¯•è¯•ï¼Œæ¯”å¦‚å»¶é•¿åˆ° 30sã€‚å»¶è¿Ÿå¢å¤§æ„å‘³ç€è¦ç­‰æ›´é•¿æ—¶é—´ï¼Œä¸ºäº†å¿«ç‚¹å¾—åˆ°ç»“æœï¼Œæˆ‘ä»¬å¯ä»¥åŒæ—¶æŠŠæ€»æµ‹è¯•æ¬¡æ•°ï¼Œä¹Ÿå‡å°‘åˆ° 10000:</p><pre><code>$ ab -c 5000 -n 10000 -r -s 30 http://192.168.0.30:8080/\n...\nRequests per second:    76.47 [#/sec] (mean)\nTime per request:       65380.868 [ms] (mean)\nTime per request:       13.076 [ms] (mean, across all concurrent requests)\nTransfer rate:          44.79 [Kbytes/sec] received\n\nConnection Times (ms)\n              min  mean[+/-sd] median   max\nConnect:        0 1300 5578.0      1   65184\nProcessing:     0 37916 59283.2      1  130682\nWaiting:        0    2   8.7      1     414\nTotal:          1 39216 58711.6   1021  130682\n...\n</code></pre><p>å†é‡æ–°çœ‹çœ‹ ab çš„è¾“å‡ºï¼Œè¿™æ¬¡çš„ç»“æœæ˜¾ç¤ºï¼š</p><ul>\n<li>\n<p>æ¯ç§’è¯·æ±‚æ•°ï¼ˆRequests per secondï¼‰ä¸º 76ï¼›</p>\n</li>\n<li>\n<p>æ¯ä¸ªè¯·æ±‚çš„å»¶è¿Ÿï¼ˆTime per requestï¼‰ä¸º 65sï¼›</p>\n</li>\n<li>\n<p>å»ºç«‹è¿æ¥çš„å»¶è¿Ÿï¼ˆConnectï¼‰ä¸º 1300msã€‚</p>\n</li>\n</ul><p>æ˜¾ç„¶ï¼Œæ¯ä¸ªæŒ‡æ ‡éƒ½æ¯”å‰é¢å·®äº†å¾ˆå¤šã€‚</p><p>é‚£ä¹ˆï¼Œç¢°åˆ°è¿™ç§é—®é¢˜æ—¶ï¼Œä½ ä¼šæ€ä¹ˆåŠå‘¢ï¼Ÿä½ å¯ä»¥æ ¹æ®å‰é¢çš„è®²è§£ï¼Œå…ˆè‡ªå·±åˆ†æä¸€ä¸‹ï¼Œå†ç»§ç»­å­¦ä¹ ä¸‹é¢çš„å†…å®¹ã€‚</p><p>åœ¨ä¸Šä¸€èŠ‚ï¼Œæˆ‘ä»¬ä½¿ç”¨ tcpdump æŠ“åŒ…çš„æ–¹æ³•ï¼Œæ‰¾å‡ºäº†å»¶è¿Ÿå¢å¤§çš„æ ¹æºã€‚é‚£ä¹ˆä»Šå¤©çš„æ¡ˆä¾‹ï¼Œæˆ‘ä»¬ä»ç„¶å¯ä»¥ç”¨ç±»ä¼¼çš„æ–¹æ³•å¯»æ‰¾çº¿ç´¢ã€‚ä¸è¿‡ï¼Œç°åœ¨æ¢ä¸ªæ€è·¯ï¼Œå› ä¸ºä»Šå¤©æˆ‘ä»¬å·²ç»äº‹å…ˆçŸ¥é“äº†é—®é¢˜çš„æ ¹æºâ€”â€”é‚£å°±æ˜¯ NATã€‚</p><p>å›å¿†ä¸€ä¸‹Netfilter ä¸­ï¼Œç½‘ç»œåŒ…çš„æµå‘ä»¥åŠ NAT çš„åŸç†ï¼Œä½ ä¼šå‘ç°ï¼Œè¦ä¿è¯ NAT æ­£å¸¸å·¥ä½œï¼Œå°±è‡³å°‘éœ€è¦ä¸¤ä¸ªæ­¥éª¤ï¼š</p><ul>\n<li>\n<p>ç¬¬ä¸€ï¼Œåˆ©ç”¨ Netfilter ä¸­çš„é’©å­å‡½æ•°ï¼ˆHookï¼‰ï¼Œä¿®æ”¹æºåœ°å€æˆ–è€…ç›®çš„åœ°å€ã€‚</p>\n</li>\n<li>\n<p>ç¬¬äºŒï¼Œåˆ©ç”¨è¿æ¥è·Ÿè¸ªæ¨¡å— conntrack ï¼Œå…³è”åŒä¸€ä¸ªè¿æ¥çš„è¯·æ±‚å’Œå“åº”ã€‚</p>\n</li>\n</ul><p>æ˜¯ä¸æ˜¯è¿™ä¸¤ä¸ªåœ°æ–¹å‡ºç°äº†é—®é¢˜å‘¢ï¼Ÿæˆ‘ä»¬ç”¨å‰é¢æåˆ°çš„åŠ¨æ€è¿½è¸ªå·¥å…· SystemTap æ¥è¯•è¯•ã€‚</p><p>ç”±äºä»Šå¤©æ¡ˆä¾‹æ˜¯åœ¨å‹æµ‹åœºæ™¯ä¸‹ï¼Œå¹¶å‘è¯·æ±‚æ•°å¤§å¤§é™ä½ï¼Œå¹¶ä¸”æˆ‘ä»¬æ¸…æ¥šçŸ¥é“ NAT æ˜¯ç½ªé­ç¥¸é¦–ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬æœ‰ç†ç”±æ€€ç–‘ï¼Œå†…æ ¸ä¸­å‘ç”Ÿäº†ä¸¢åŒ…ç°è±¡ã€‚</p><p>æˆ‘ä»¬å¯ä»¥å›åˆ°ç»ˆç«¯ä¸€ä¸­ï¼Œåˆ›å»ºä¸€ä¸ª dropwatch.stp çš„è„šæœ¬æ–‡ä»¶ï¼Œå¹¶å†™å…¥ä¸‹é¢çš„å†…å®¹ï¼š</p><pre><code>#! /usr/bin/env stap\n\n############################################################\n# Dropwatch.stp\n# Author: Neil Horman &lt;nhorman@redhat.com&gt;\n# An example script to mimic the behavior of the dropwatch utility\n# http://fedorahosted.org/dropwatch\n############################################################\n\n# Array to hold the list of drop points we find\nglobal locations\n\n# Note when we turn the monitor on and off\nprobe begin { printf(&quot;Monitoring for dropped packets\\n&quot;) }\nprobe end { printf(&quot;Stopping dropped packet monitor\\n&quot;) }\n\n# increment a drop counter for every location we drop at\nprobe kernel.trace(&quot;kfree_skb&quot;) { locations[$location] &lt;&lt;&lt; 1 }\n\n# Every 5 seconds report our drop locations\nprobe timer.sec(5)\n{\n  printf(&quot;\\n&quot;)\n  foreach (l in locations-) {\n    printf(&quot;%d packets dropped at %s\\n&quot;,\n           @count(locations[l]), symname(l))\n  }\n  delete locations\n}\n</code></pre><p>è¿™ä¸ªè„šæœ¬ï¼Œè·Ÿè¸ªå†…æ ¸å‡½æ•° kfree_skb() çš„è°ƒç”¨ï¼Œå¹¶ç»Ÿè®¡ä¸¢åŒ…çš„ä½ç½®ã€‚æ–‡ä»¶ä¿å­˜å¥½åï¼Œæ‰§è¡Œä¸‹é¢çš„ stap å‘½ä»¤ï¼Œå°±å¯ä»¥è¿è¡Œä¸¢åŒ…è·Ÿè¸ªè„šæœ¬ã€‚è¿™é‡Œçš„stapï¼Œæ˜¯ SystemTap çš„å‘½ä»¤è¡Œå·¥å…·ï¼š</p><pre><code>$ stap --all-modules dropwatch.stp\nMonitoring for dropped packets\n</code></pre><p>å½“ä½ çœ‹åˆ° probe begin è¾“å‡ºçš„ â€œMonitoring for dropped packetsâ€ æ—¶ï¼Œè¡¨æ˜ SystemTap å·²ç»å°†è„šæœ¬ç¼–è¯‘ä¸ºå†…æ ¸æ¨¡å—ï¼Œå¹¶å¯åŠ¨è¿è¡Œäº†ã€‚</p><p>æ¥ç€ï¼Œæˆ‘ä»¬åˆ‡æ¢åˆ°ç»ˆç«¯äºŒä¸­ï¼Œå†æ¬¡æ‰§è¡Œ ab å‘½ä»¤ï¼š</p><pre><code>$ ab -c 5000 -n 10000 -r -s 30 http://192.168.0.30:8080/\n</code></pre><p>ç„¶åï¼Œå†æ¬¡å›åˆ°ç»ˆç«¯ä¸€ä¸­ï¼Œè§‚å¯Ÿ stap å‘½ä»¤çš„è¾“å‡ºï¼š</p><pre><code>10031 packets dropped at nf_hook_slow\n676 packets dropped at tcp_v4_rcv\n\n7284 packets dropped at nf_hook_slow\n268 packets dropped at tcp_v4_rcv\n</code></pre><p>ä½ ä¼šå‘ç°ï¼Œå¤§é‡ä¸¢åŒ…éƒ½å‘ç”Ÿåœ¨ nf_hook_slow ä½ç½®ã€‚çœ‹åˆ°è¿™ä¸ªåå­—ï¼Œä½ åº”è¯¥èƒ½æƒ³åˆ°ï¼Œè¿™æ˜¯åœ¨ Netfilter Hook çš„é’©å­å‡½æ•°ä¸­ï¼Œå‡ºç°ä¸¢åŒ…é—®é¢˜äº†ã€‚ä½†æ˜¯ä¸æ˜¯ NATï¼Œè¿˜ä¸èƒ½ç¡®å®šã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¿˜å¾—å†è·Ÿè¸ª  nf_hook_slow çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œè¿™ä¸€æ­¥å¯ä»¥é€šè¿‡ perf æ¥å®Œæˆã€‚</p><p>æˆ‘ä»¬åˆ‡æ¢åˆ°ç»ˆç«¯äºŒä¸­ï¼Œå†æ¬¡æ‰§è¡Œ ab å‘½ä»¤ï¼š</p><pre><code>$ ab -c 5000 -n 10000 -r -s 30 http://192.168.0.30:8080/\n</code></pre><p>ç„¶åï¼Œå†æ¬¡åˆ‡æ¢å›ç»ˆç«¯ä¸€ï¼Œæ‰§è¡Œ perf record å’Œ perf report å‘½ä»¤</p><pre><code># è®°å½•ä¸€ä¼šï¼ˆæ¯”å¦‚30sï¼‰åæŒ‰Ctrl+Cç»“æŸ\n$ perf record -a -g -- sleep 30\n\n# è¾“å‡ºæŠ¥å‘Š\n$ perf report -g graph,0\n</code></pre><p>åœ¨ perf report ç•Œé¢ä¸­ï¼Œè¾“å…¥æŸ¥æ‰¾å‘½ä»¤ / ç„¶åï¼Œåœ¨å¼¹å‡ºçš„å¯¹è¯æ¡†ä¸­ï¼Œè¾“å…¥ nf_hook_slowï¼›æœ€åå†å±•å¼€è°ƒç”¨æ ˆï¼Œå°±å¯ä»¥å¾—åˆ°ä¸‹é¢è¿™ä¸ªè°ƒç”¨å›¾ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/0e/3c/0e844a471ff1062a1db70a303add943c.png?wh=587*851\" alt=\"\"></p><p>ä»è¿™ä¸ªå›¾æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œnf_hook_slow è°ƒç”¨æœ€å¤šçš„æœ‰ä¸‰ä¸ªåœ°æ–¹ï¼Œåˆ†åˆ«æ˜¯ ipv4_conntrack_inã€br_nf_pre_routing ä»¥åŠ iptable_nat_ipv4_inã€‚æ¢è¨€ä¹‹ï¼Œnf_hook_slow ä¸»è¦åœ¨æ‰§è¡Œä¸‰ä¸ªåŠ¨ä½œã€‚</p><ul>\n<li>\n<p>ç¬¬ä¸€ï¼Œæ¥æ”¶ç½‘ç»œåŒ…æ—¶ï¼Œåœ¨è¿æ¥è·Ÿè¸ªè¡¨ä¸­æŸ¥æ‰¾è¿æ¥ï¼Œå¹¶ä¸ºæ–°çš„è¿æ¥åˆ†é…è·Ÿè¸ªå¯¹è±¡ï¼ˆBucketï¼‰ã€‚</p>\n</li>\n<li>\n<p>ç¬¬äºŒï¼Œåœ¨ Linux ç½‘æ¡¥ä¸­è½¬å‘åŒ…ã€‚è¿™æ˜¯å› ä¸ºæ¡ˆä¾‹ Nginx æ˜¯ä¸€ä¸ª Docker å®¹å™¨ï¼Œè€Œå®¹å™¨çš„ç½‘ç»œé€šè¿‡ç½‘æ¡¥æ¥å®ç°ï¼›</p>\n</li>\n<li>\n<p>ç¬¬ä¸‰ï¼Œæ¥æ”¶ç½‘ç»œåŒ…æ—¶ï¼Œæ‰§è¡Œ DNATï¼Œå³æŠŠ 8080 ç«¯å£æ”¶åˆ°çš„åŒ…è½¬å‘ç»™å®¹å™¨ã€‚</p>\n</li>\n</ul><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å…¶å®å°±æ‰¾åˆ°äº†æ€§èƒ½ä¸‹é™çš„ä¸‰ä¸ªæ¥æºã€‚è¿™ä¸‰ä¸ªæ¥æºï¼Œéƒ½æ˜¯ Linux çš„å†…æ ¸æœºåˆ¶ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥çš„ä¼˜åŒ–ï¼Œè‡ªç„¶ä¹Ÿæ˜¯è¦ä»å†…æ ¸å…¥æ‰‹ã€‚</p><p>æ ¹æ®ä»¥å‰å„ä¸ªèµ„æºæ¨¡å—çš„å†…å®¹ï¼Œæˆ‘ä»¬çŸ¥é“ï¼ŒLinux å†…æ ¸ä¸ºç”¨æˆ·æä¾›äº†å¤§é‡çš„å¯é…ç½®é€‰é¡¹ï¼Œè¿™äº›é€‰é¡¹å¯ä»¥é€šè¿‡ proc æ–‡ä»¶ç³»ç»Ÿï¼Œæˆ–è€… sys æ–‡ä»¶ç³»ç»Ÿï¼Œæ¥æŸ¥çœ‹å’Œä¿®æ”¹ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œä½ è¿˜å¯ä»¥ç”¨ sysctl è¿™ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œæ¥æŸ¥çœ‹å’Œä¿®æ”¹å†…æ ¸é…ç½®ã€‚</p><p>æ¯”å¦‚ï¼Œæˆ‘ä»¬ä»Šå¤©çš„ä¸»é¢˜æ˜¯ DNATï¼Œè€Œ DNAT çš„åŸºç¡€æ˜¯ conntrackï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å…ˆçœ‹çœ‹ï¼Œå†…æ ¸æä¾›äº†å“ªäº› conntrack çš„é…ç½®é€‰é¡¹ã€‚</p><p>æˆ‘ä»¬åœ¨ç»ˆç«¯ä¸€ä¸­ï¼Œç»§ç»­æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š</p><pre><code>$ sysctl -a | grep conntrack\nnet.netfilter.nf_conntrack_count = 180\nnet.netfilter.nf_conntrack_max = 1000\nnet.netfilter.nf_conntrack_buckets = 65536\nnet.netfilter.nf_conntrack_tcp_timeout_syn_recv = 60\nnet.netfilter.nf_conntrack_tcp_timeout_syn_sent = 120\nnet.netfilter.nf_conntrack_tcp_timeout_time_wait = 120\n...\n</code></pre><p>ä½ å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæœ€é‡è¦çš„ä¸‰ä¸ªæŒ‡æ ‡ï¼š</p><ul>\n<li>\n<p>net.netfilter.nf_conntrack_countï¼Œè¡¨ç¤ºå½“å‰è¿æ¥è·Ÿè¸ªæ•°ï¼›</p>\n</li>\n<li>\n<p>net.netfilter.nf_conntrack_maxï¼Œè¡¨ç¤ºæœ€å¤§è¿æ¥è·Ÿè¸ªæ•°ï¼›</p>\n</li>\n<li>\n<p>net.netfilter.nf_conntrack_bucketsï¼Œè¡¨ç¤ºè¿æ¥è·Ÿè¸ªè¡¨çš„å¤§å°ã€‚</p>\n</li>\n</ul><p>æ‰€ä»¥ï¼Œè¿™ä¸ªè¾“å‡ºå‘Šè¯‰æˆ‘ä»¬ï¼Œå½“å‰è¿æ¥è·Ÿè¸ªæ•°æ˜¯ 180ï¼Œæœ€å¤§è¿æ¥è·Ÿè¸ªæ•°æ˜¯ 1000ï¼Œè¿æ¥è·Ÿè¸ªè¡¨çš„å¤§å°ï¼Œåˆ™æ˜¯ 65536ã€‚</p><p>å›æƒ³ä¸€ä¸‹å‰é¢çš„ ab å‘½ä»¤ï¼Œå¹¶å‘è¯·æ±‚æ•°æ˜¯ 5000ï¼Œè€Œè¯·æ±‚æ•°æ˜¯ 100000ã€‚æ˜¾ç„¶ï¼Œè·Ÿè¸ªè¡¨è®¾ç½®æˆï¼Œåªè®°å½• 1000 ä¸ªè¿æ¥ï¼Œæ˜¯è¿œè¿œä¸å¤Ÿçš„ã€‚</p><p>å®é™…ä¸Šï¼Œå†…æ ¸åœ¨å·¥ä½œå¼‚å¸¸æ—¶ï¼Œä¼šæŠŠå¼‚å¸¸ä¿¡æ¯è®°å½•åˆ°æ—¥å¿—ä¸­ã€‚æ¯”å¦‚å‰é¢çš„ ab æµ‹è¯•ï¼Œå†…æ ¸å·²ç»åœ¨æ—¥å¿—ä¸­æŠ¥å‡ºäº† â€œnf_conntrack: table fullâ€ çš„é”™è¯¯ã€‚æ‰§è¡Œ dmesg å‘½ä»¤ï¼Œä½ å°±å¯ä»¥çœ‹åˆ°ï¼š</p><pre><code>$ dmesg | tail\n[104235.156774] nf_conntrack: nf_conntrack: table full, dropping packet\n[104243.800401] net_ratelimit: 3939 callbacks suppressed\n[104243.800401] nf_conntrack: nf_conntrack: table full, dropping packet\n[104262.962157] nf_conntrack: nf_conntrack: table full, dropping packet\n</code></pre><p>å…¶ä¸­ï¼Œnet_ratelimit è¡¨ç¤ºæœ‰å¤§é‡çš„æ—¥å¿—è¢«å‹ç¼©æ‰äº†ï¼Œè¿™æ˜¯å†…æ ¸é¢„é˜²æ—¥å¿—æ”»å‡»çš„ä¸€ç§æªæ–½ã€‚è€Œå½“ä½ çœ‹åˆ° â€œnf_conntrack: table fullâ€ çš„é”™è¯¯æ—¶ï¼Œå°±è¡¨æ˜ nf_conntrack_max å¤ªå°äº†ã€‚</p><p>é‚£æ˜¯ä¸æ˜¯ï¼Œç›´æ¥æŠŠè¿æ¥è·Ÿè¸ªè¡¨è°ƒå¤§å°±å¯ä»¥äº†å‘¢ï¼Ÿè°ƒèŠ‚å‰ï¼Œä½ å…ˆå¾—æ˜ç™½ï¼Œè¿æ¥è·Ÿè¸ªè¡¨ï¼Œå®é™…ä¸Šæ˜¯å†…å­˜ä¸­çš„ä¸€ä¸ªå“ˆå¸Œè¡¨ã€‚å¦‚æœè¿æ¥è·Ÿè¸ªæ•°è¿‡å¤§ï¼Œä¹Ÿä¼šè€—è´¹å¤§é‡å†…å­˜ã€‚</p><p>å…¶å®ï¼Œæˆ‘ä»¬ä¸Šé¢çœ‹åˆ°çš„ nf_conntrack_bucketsï¼Œå°±æ˜¯å“ˆå¸Œè¡¨çš„å¤§å°ã€‚å“ˆå¸Œè¡¨ä¸­çš„æ¯ä¸€é¡¹ï¼Œéƒ½æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼ˆç§°ä¸º Bucketï¼‰ï¼Œè€Œé“¾è¡¨é•¿åº¦ï¼Œå°±ç­‰äº nf_conntrack_max é™¤ä»¥ nf_conntrack_bucketsã€‚</p><p>æ¯”å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä¼°ç®—ä¸€ä¸‹ï¼Œä¸Šè¿°é…ç½®çš„è¿æ¥è·Ÿè¸ªè¡¨å ç”¨çš„å†…å­˜å¤§å°ï¼š</p><pre><code># è¿æ¥è·Ÿè¸ªå¯¹è±¡å¤§å°ä¸º376ï¼Œé“¾è¡¨é¡¹å¤§å°ä¸º16\nnf_conntrack_max*è¿æ¥è·Ÿè¸ªå¯¹è±¡å¤§å°+nf_conntrack_buckets*é“¾è¡¨é¡¹å¤§å° \n= 1000*376+65536*16 B\n= 1.4 MB\n</code></pre><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°† nf_conntrack_max æ”¹å¤§ä¸€äº›ï¼Œæ¯”å¦‚æ”¹æˆ 131072ï¼ˆå³nf_conntrack_bucketsçš„2å€ï¼‰ï¼š</p><pre><code>$ sysctl -w net.netfilter.nf_conntrack_max=131072\n$ sysctl -w net.netfilter.nf_conntrack_buckets=65536\n</code></pre><p>ç„¶åå†åˆ‡æ¢åˆ°ç»ˆç«¯äºŒä¸­ï¼Œé‡æ–°æ‰§è¡Œ ab å‘½ä»¤ã€‚æ³¨æ„ï¼Œè¿™æ¬¡æˆ‘ä»¬æŠŠè¶…æ—¶æ—¶é—´ä¹Ÿæ”¹å›åŸæ¥çš„ 2sï¼š</p><pre><code>$ ab -c 5000 -n 100000 -r -s 2 http://192.168.0.30:8080/\n...\nRequests per second:    6315.99 [#/sec] (mean)\nTime per request:       791.641 [ms] (mean)\nTime per request:       0.158 [ms] (mean, across all concurrent requests)\nTransfer rate:          4985.15 [Kbytes/sec] received\n\nConnection Times (ms)\n              min  mean[+/-sd] median   max\nConnect:        0  355 793.7     29    7352\nProcessing:     8  311 855.9     51   14481\nWaiting:        0  292 851.5     36   14481\nTotal:         15  666 1216.3    148   14645\n</code></pre><p>æœç„¶ï¼Œç°åœ¨ä½ å¯ä»¥çœ‹åˆ°ï¼š</p><ul>\n<li>\n<p>æ¯ç§’è¯·æ±‚æ•°ï¼ˆRequests per secondï¼‰ä¸º 6315ï¼ˆä¸ç”¨NATæ—¶ä¸º6576ï¼‰ï¼›</p>\n</li>\n<li>\n<p>æ¯ä¸ªè¯·æ±‚çš„å»¶è¿Ÿï¼ˆTime per requestï¼‰ä¸º 791msï¼ˆä¸ç”¨NATæ—¶ä¸º760msï¼‰ï¼›</p>\n</li>\n<li>\n<p>å»ºç«‹è¿æ¥çš„å»¶è¿Ÿï¼ˆConnectï¼‰ä¸º 355msï¼ˆä¸ç”¨NATæ—¶ä¸º177msï¼‰ã€‚</p>\n</li>\n</ul><p>è¿™ä¸ªç»“æœï¼Œå·²ç»æ¯”åˆšæ‰çš„æµ‹è¯•å¥½äº†å¾ˆå¤šï¼Œä¹Ÿå¾ˆæ¥è¿‘æœ€åˆä¸ç”¨ NAT æ—¶çš„åŸºå‡†ç»“æœäº†ã€‚</p><p>ä¸è¿‡ï¼Œä½ å¯èƒ½è¿˜æ˜¯å¾ˆå¥½å¥‡ï¼Œè¿æ¥è·Ÿè¸ªè¡¨é‡Œï¼Œåˆ°åº•éƒ½åŒ…å«äº†å“ªäº›ä¸œè¥¿ï¼Ÿè¿™é‡Œçš„ä¸œè¥¿ï¼Œåˆæ˜¯æ€ä¹ˆåˆ·æ–°çš„å‘¢ï¼Ÿ</p><p>å®é™…ä¸Šï¼Œä½ å¯ä»¥ç”¨ conntrack å‘½ä»¤è¡Œå·¥å…·ï¼Œæ¥æŸ¥çœ‹è¿æ¥è·Ÿè¸ªè¡¨çš„å†…å®¹ã€‚æ¯”å¦‚ï¼š</p><pre><code># -Lè¡¨ç¤ºåˆ—è¡¨ï¼Œ-oè¡¨ç¤ºä»¥æ‰©å±•æ ¼å¼æ˜¾ç¤º\n$ conntrack -L -o extended | head\nipv4     2 tcp      6 7 TIME_WAIT src=192.168.0.2 dst=192.168.0.96 sport=51744 dport=8080 src=172.17.0.2 dst=192.168.0.2 sport=8080 dport=51744 [ASSURED] mark=0 use=1\nipv4     2 tcp      6 6 TIME_WAIT src=192.168.0.2 dst=192.168.0.96 sport=51524 dport=8080 src=172.17.0.2 dst=192.168.0.2 sport=8080 dport=51524 [ASSURED] mark=0 use=1\n</code></pre><p>ä»è¿™é‡Œä½ å¯ä»¥å‘ç°ï¼Œè¿æ¥è·Ÿè¸ªè¡¨é‡Œçš„å¯¹è±¡ï¼ŒåŒ…æ‹¬äº†åè®®ã€è¿æ¥çŠ¶æ€ã€æºIPã€æºç«¯å£ã€ç›®çš„IPã€ç›®çš„ç«¯å£ã€è·Ÿè¸ªçŠ¶æ€ç­‰ã€‚ç”±äºè¿™ä¸ªæ ¼å¼æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨ awkã€sort ç­‰å·¥å…·ï¼Œå¯¹å…¶è¿›è¡Œç»Ÿè®¡åˆ†æã€‚</p><p>æ¯”å¦‚ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä»¥ ab ä¸ºä¾‹ã€‚åœ¨ç»ˆç«¯äºŒå¯åŠ¨ ab å‘½ä»¤åï¼Œå†å›åˆ°ç»ˆç«¯ä¸€ä¸­ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š</p><pre><code># ç»Ÿè®¡æ€»çš„è¿æ¥è·Ÿè¸ªæ•°\n$ conntrack -L -o extended | wc -l\n14289\n\n# ç»Ÿè®¡TCPåè®®å„ä¸ªçŠ¶æ€çš„è¿æ¥è·Ÿè¸ªæ•°\n$ conntrack -L -o extended | awk '/^.*tcp.*$/ {sum[$6]++} END {for(i in sum) print i, sum[i]}'\nSYN_RECV 4\nCLOSE_WAIT 9\nESTABLISHED 2877\nFIN_WAIT 3\nSYN_SENT 2113\nTIME_WAIT 9283\n\n# ç»Ÿè®¡å„ä¸ªæºIPçš„è¿æ¥è·Ÿè¸ªæ•°\n$ conntrack -L -o extended | awk '{print $7}' | cut -d &quot;=&quot; -f 2 | sort | uniq -c | sort -nr | head -n 10\n  14116 192.168.0.2\n    172 192.168.0.96\n</code></pre><p>è¿™é‡Œç»Ÿè®¡äº†æ€»è¿æ¥è·Ÿè¸ªæ•°ï¼ŒTCPåè®®å„ä¸ªçŠ¶æ€çš„è¿æ¥è·Ÿè¸ªæ•°ï¼Œä»¥åŠå„ä¸ªæºIPçš„è¿æ¥è·Ÿè¸ªæ•°ã€‚ä½ å¯ä»¥çœ‹åˆ°ï¼Œå¤§éƒ¨åˆ† TCP çš„è¿æ¥è·Ÿè¸ªï¼Œéƒ½å¤„äº TIME_WAIT çŠ¶æ€ï¼Œå¹¶ä¸”å®ƒä»¬å¤§éƒ½æ¥è‡ªäº 192.168.0.2 è¿™ä¸ª IP åœ°å€ï¼ˆä¹Ÿå°±æ˜¯è¿è¡Œ ab å‘½ä»¤çš„ VM2ï¼‰ã€‚</p><p>è¿™äº›å¤„äº TIME_WAIT çš„è¿æ¥è·Ÿè¸ªè®°å½•ï¼Œä¼šåœ¨è¶…æ—¶åæ¸…ç†ï¼Œè€Œé»˜è®¤çš„è¶…æ—¶æ—¶é—´æ˜¯ 120sï¼Œä½ å¯ä»¥æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤æ¥æŸ¥çœ‹ï¼š</p><pre><code>$ sysctl net.netfilter.nf_conntrack_tcp_timeout_time_wait\nnet.netfilter.nf_conntrack_tcp_timeout_time_wait = 120\n</code></pre><p>æ‰€ä»¥ï¼Œå¦‚æœä½ çš„è¿æ¥æ•°éå¸¸å¤§ï¼Œç¡®å®ä¹Ÿåº”è¯¥è€ƒè™‘ï¼Œé€‚å½“å‡å°è¶…æ—¶æ—¶é—´ã€‚</p><p>é™¤äº†ä¸Šé¢è¿™äº›å¸¸è§é…ç½®ï¼Œconntrack è¿˜åŒ…å«äº†å…¶ä»–å¾ˆå¤šé…ç½®é€‰é¡¹ï¼Œä½ å¯ä»¥æ ¹æ®å®é™…éœ€è¦ï¼Œå‚è€ƒ nf_conntrack çš„<a href=\"https://www.kernel.org/doc/Documentation/networking/nf_conntrack-sysctl.txt\">æ–‡æ¡£</a>æ¥é…ç½®ã€‚</p><h2>å°ç»“</h2><p>ä»Šå¤©ï¼Œæˆ‘å¸¦ä½ ä¸€èµ·å­¦ä¹ äº†ï¼Œå¦‚ä½•æ’æŸ¥å’Œä¼˜åŒ– NAT å¸¦æ¥çš„æ€§èƒ½é—®é¢˜ã€‚</p><p>ç”±äº NAT åŸºäº Linux å†…æ ¸çš„è¿æ¥è·Ÿè¸ªæœºåˆ¶æ¥å®ç°ã€‚æ‰€ä»¥ï¼Œåœ¨åˆ†æ NAT æ€§èƒ½é—®é¢˜æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆä» conntrack è§’åº¦æ¥åˆ†æï¼Œæ¯”å¦‚ç”¨ systemtapã€perf ç­‰ï¼Œåˆ†æå†…æ ¸ä¸­ conntrack çš„è¡Œæ–‡ï¼›ç„¶åï¼Œé€šè¿‡è°ƒæ•´ netfilter å†…æ ¸é€‰é¡¹çš„å‚æ•°ï¼Œæ¥è¿›è¡Œä¼˜åŒ–ã€‚</p><p>å…¶å®ï¼ŒLinux è¿™ç§é€šè¿‡è¿æ¥è·Ÿè¸ªæœºåˆ¶å®ç°çš„ NATï¼Œä¹Ÿå¸¸è¢«ç§°ä¸ºæœ‰çŠ¶æ€çš„ NATï¼Œè€Œç»´æŠ¤çŠ¶æ€ï¼Œä¹Ÿå¸¦æ¥äº†å¾ˆé«˜çš„æ€§èƒ½æˆæœ¬ã€‚</p><p>æ‰€ä»¥ï¼Œé™¤äº†è°ƒæ•´å†…æ ¸è¡Œä¸ºå¤–ï¼Œåœ¨ä¸éœ€è¦çŠ¶æ€è·Ÿè¸ªçš„åœºæ™¯ä¸‹ï¼ˆæ¯”å¦‚åªéœ€è¦æŒ‰é¢„å®šçš„IPå’Œç«¯å£è¿›è¡Œæ˜ å°„ï¼Œè€Œä¸éœ€è¦åŠ¨æ€æ˜ å°„ï¼‰ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨æ— çŠ¶æ€çš„ NAT ï¼ˆæ¯”å¦‚ç”¨ tc æˆ–åŸºäº DPDK å¼€å‘ï¼‰ï¼Œæ¥è¿›ä¸€æ­¥æå‡æ€§èƒ½ã€‚</p><h2>æ€è€ƒ</h2><p>æœ€åï¼Œç»™ä½ ç•™ä¸€ä¸ªæ€è€ƒé¢˜ã€‚ä½ æœ‰æ²¡æœ‰ç¢°åˆ°è¿‡ NAT å¸¦æ¥çš„æ€§èƒ½é—®é¢˜ï¼Ÿä½ æ˜¯æ€ä¹ˆå®šä½å’Œåˆ†æå®ƒçš„æ ¹æºçš„ï¼Ÿæœ€åï¼Œåˆæ˜¯é€šè¿‡ä»€ä¹ˆæ–¹æ³•æ¥ä¼˜åŒ–è§£å†³çš„ï¼Ÿä½ å¯ä»¥ç»“åˆä»Šå¤©çš„æ¡ˆä¾‹ï¼Œæ€»ç»“è‡ªå·±çš„æ€è·¯ã€‚</p><p>æ¬¢è¿åœ¨ç•™è¨€åŒºå’Œæˆ‘è®¨è®ºï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™ç¯‡æ–‡ç« åˆ†äº«ç»™ä½ çš„åŒäº‹ã€æœ‹å‹ã€‚æˆ‘ä»¬ä¸€èµ·åœ¨å®æˆ˜ä¸­æ¼”ç»ƒï¼Œåœ¨äº¤æµä¸­è¿›æ­¥ã€‚</p><p></p>","neighbors":{"left":{"article_title":"41 | æ¡ˆä¾‹ç¯‡ï¼šå¦‚ä½•ä¼˜åŒ– NAT æ€§èƒ½ï¼Ÿï¼ˆä¸Šï¼‰","id":83189},"right":{"article_title":"43 | å¥—è·¯ç¯‡ï¼šç½‘ç»œæ€§èƒ½ä¼˜åŒ–çš„å‡ ä¸ªæ€è·¯ï¼ˆä¸Šï¼‰","id":83783}},"comments":[{"had_liked":false,"id":71762,"user_name":"åˆ†æ¸…äº‘æ·¡","can_delete":false,"product_type":"c1","uid":1269873,"ip_address":"","ucode":"7045AE6BF72D31","user_header":"https://static001.geekbang.org/account/avatar/00/13/60/71/895ee6cf.jpg","comment_is_top":false,"comment_ctime":1551428155,"is_pvip":false,"replies":[{"id":"26320","content":"ğŸ‘ è°¢è°¢åˆ†äº«ã€‚å†…æ ¸é—®é¢˜çš„åˆ†æå’Œæ’æŸ¥ä¸€èˆ¬éƒ½æ¯”è¾ƒè€—æ—¶é—´ï¼Œå¯¹åŸºç¡€çŸ¥è¯†çš„è¦æ±‚ä¹Ÿä¼šé«˜ä¸€äº›ã€‚","user_name":"ä½œè€…å›å¤","comment_id":71762,"uid":"1001282","ip_address":"","utype":1,"ctime":1551705007,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":1,"race_medal":0,"score":"164760185403","product_id":100020901,"comment_content":"https:&#47;&#47;mp.weixin.qq.com&#47;s&#47;VYBs8iqf0HsNg9WAxktzYQï¼šï¼ˆå¤šä¸ªå®¹å™¨snatæ—¶å› ä¸ºæœç´¢æœ¬åœ°å¯ç”¨ç«¯å£ï¼ˆéƒ½ä»1025å¼€å§‹ï¼Œåˆ°æ‰¾åˆ°å¯ç”¨ç«¯å£å¹¶æ’å…¥åˆ°conntrackè¡¨æ˜¯ä¸€ä¸ªéäº‹åŠ¡å¹¶ä¸”æœ‰æ—¶å»¶--ç¬¬äºŒä¸ªæ’å…¥ä¼šå¤±è´¥ï¼Œè¿›è€Œå¯¼è‡´ç¬¬ä¸€ä¸ªsynåŒ…è¢«æ‰”æ‰çš„é”™è¯¯ï¼Œæ‰”æ‰åé‡ä¼ æ‰¾åˆ°æ–°çš„å¯ç”¨ç«¯å£ï¼Œè¡¨ç°å°±æ˜¯æ—¶å»¶å¶å°”ä¸º1ç§’æˆ–è€…3ç§’ï¼‰<br><br>è¿™ç¯‡æ–‡ç« æ˜¯æˆ‘è§è¿‡è¯Šæ–­NATé—®é¢˜æœ€ä¸“ä¸šçš„ï¼Œå¤§å®¶è¦å¤šå­¦ä¹ ä¸€ä¸‹é‡Œé¢çš„æ€è·¯å’Œæ‰‹æ®µ","like_count":39,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":441319,"discussion_content":"ğŸ‘ è°¢è°¢åˆ†äº«ã€‚å†…æ ¸é—®é¢˜çš„åˆ†æå’Œæ’æŸ¥ä¸€èˆ¬éƒ½æ¯”è¾ƒè€—æ—¶é—´ï¼Œå¯¹åŸºç¡€çŸ¥è¯†çš„è¦æ±‚ä¹Ÿä¼šé«˜ä¸€äº›ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551705007,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":186767,"user_name":"ben","can_delete":false,"product_type":"c1","uid":1785149,"ip_address":"","ucode":"7084248C8D962C","user_header":"https://static001.geekbang.org/account/avatar/00/1b/3d/3d/66512c23.jpg","comment_is_top":false,"comment_ctime":1583920069,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"117548037061","product_id":100020901,"comment_content":"å…¶å®é‡åˆ°å¾ˆå¤šé—®é¢˜çš„æ—¶å€™å¤šçœ‹çœ‹å†…æ ¸æ—¥å¿—å°±çŸ¥é“äº†ï¼Œlinuxå¾ˆæ™ºèƒ½çš„ï¼Œå¾ˆå¤šæŠ¥é”™ä¿¡æ¯éƒ½åœ¨æ—¥å¿—é‡Œé¢ï¼Œè¶Šé‡åˆ°ç³»ç»Ÿä¼˜åŒ–å±‚é¢ï¼Œå°±å¤šè¦çœ‹çœ‹å†…æ ¸æ—¥å¿—ï¼Œæˆ‘ä¸€èˆ¬æ˜¯ä½¿ç”¨journalctl -k -fæ¥æŸ¥çœ‹ï¼Œæœ‰æŠ¥é”™ä¿¡æ¯å°±Googleï¼Œçº¿ä¸Šé‡åˆ°nf_conntrack: table fullï¼Œå°±æ˜¯è¿™æ ·æ’æŸ¥å‡ºæ¥çš„ï¼ŒæŸ¥çœ‹å†…æ ¸æ—¥å¿—çœŸçš„å¾ˆé‡è¦ï¼Œç‰¹åˆ«åº”ç”¨æ—¥å¿—æ²¡çœ‹å‡ºä»€ä¹ˆæ¥çš„æ—¶å€™","like_count":28},{"had_liked":false,"id":71648,"user_name":"è…¾è¾¾","can_delete":false,"product_type":"c1","uid":1079876,"ip_address":"","ucode":"72F9CFBA44FDEE","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTL9hlAIKQ1sGDu16oWLOHyCSicr18XibygQSMLMjuDvKk73deDlH9aMphFsj41WYJh121aniaqBLiaMNg/132","comment_is_top":false,"comment_ctime":1551406782,"is_pvip":false,"replies":[{"id":"26305","content":"å—¯å—¯ï¼Œæ˜¯ä¸ªå¥½é—®é¢˜ã€‚ä¸‹ä¸€æ¨¡å—ä¸­æœ‰å†…æ ¸çº¿ç¨‹çš„åˆ†ææ€è·¯ï¼Œåˆ°æ—¶å€™å¯ä»¥çœ‹åˆ°åˆ†æçš„æ–¹æ³•","user_name":"ä½œè€…å›å¤","comment_id":71648,"uid":"1001282","ip_address":"","utype":1,"ctime":1551703228,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":1,"race_medal":0,"score":"31616177854","product_id":100020901,"comment_content":"è¿™ä¸ªæ¡ˆä¾‹ï¼Œèƒ½ä¸èƒ½è®²è®²æ€ä¹ˆæ‰¾åˆ°æ˜¯NATé—®é¢˜ï¼Ÿè¿™ä¸ªå¾ˆå…³é”®ï¼Œä½†æ–‡ç« é‡Œç›´æ¥ç‚¹æ˜è¯´æ˜¯NATé—®é¢˜ï¼Œè¿™ä¸ªå°±ä¸å¥½äº†ï¼Œä¸€èˆ¬çœ‹cpu,çœ‹å…¶ä»–æŒ‡æ ‡å¾ˆéš¾æƒ³åˆ°æ˜¯naté—®é¢˜ï¼ŒçœŸå®åœºæ™¯é‡Œï¼Œæ€ä¹ˆä¼šæƒ³åˆ°æ˜¯naté—®é¢˜å‘¢ï¼Ÿ","like_count":8,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":441255,"discussion_content":"å—¯å—¯ï¼Œæ˜¯ä¸ªå¥½é—®é¢˜ã€‚ä¸‹ä¸€æ¨¡å—ä¸­æœ‰å†…æ ¸çº¿ç¨‹çš„åˆ†ææ€è·¯ï¼Œåˆ°æ—¶å€™å¯ä»¥çœ‹åˆ°åˆ†æçš„æ–¹æ³•","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551703228,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":70959,"user_name":"vvccoe","can_delete":false,"product_type":"c1","uid":1099892,"ip_address":"","ucode":"1BE9FDE72175BE","user_header":"https://static001.geekbang.org/account/avatar/00/10/c8/74/a1bd2307.jpg","comment_is_top":false,"comment_ctime":1551234037,"is_pvip":false,"replies":[{"id":"25714","content":"è¿™æ˜¯å†…æ ¸æ•°æ®ç»“æ„çš„å¤§å°ï¼Œä¸€èˆ¬ä¸ä¼šå˜åŒ–","user_name":"ä½œè€…å›å¤","comment_id":70959,"uid":"1001282","ip_address":"","utype":1,"ctime":1551399481,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":3,"race_medal":0,"score":"31616005109","product_id":100020901,"comment_content":"â€˜# è¿æ¥è·Ÿè¸ªå¯¹è±¡å¤§å°ä¸º 376ï¼Œé“¾è¡¨é¡¹å¤§å°ä¸º 16<br>nf_conntrack_max* è¿æ¥è·Ÿè¸ªå¯¹è±¡å¤§å° +nf_conntrack_buckets* é“¾è¡¨é¡¹å¤§å° <br>= 1000*376+65536*16 B<br>= 1.4 MBâ€™   <br>è€å¸ˆ ä¸Šé¢çš„376å’Œ16 æ˜¯å›ºå®šå€¼å—ï¼Ÿ<br>","like_count":7,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440921,"discussion_content":"è¿™æ˜¯å†…æ ¸æ•°æ®ç»“æ„çš„å¤§å°ï¼Œä¸€èˆ¬ä¸ä¼šå˜åŒ–","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551399481,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1284474,"avatar":"https://static001.geekbang.org/account/avatar/00/13/99/7a/558666a5.jpg","nickname":"AceslupK","note":"","ucode":"048F84D019CBBB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":394062,"discussion_content":"çªç„¶å°±æ¥ä¸¤ä¸ªå€¼ï¼Œä¹Ÿæ²¡ç»†è¯´ï¼Œæ‡µåœˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631705867,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1298046,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKZicicibGibtR5zAia782Ajc5I5BN3F3tjAdlibATIknHv67gbxeH21N7B6vbgwLjYb1miaLKhqicptB5ibYw/132","nickname":"é˜¿é£","note":"","ucode":"F8B1FC8521264D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":269739,"discussion_content":"å½“æ—¶æˆ‘çœ‹åˆ°è¿™é‡Œä¹Ÿæœ‰åŒæ ·çš„ç–‘é—®","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589943926,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":84767,"user_name":"Geek_007","can_delete":false,"product_type":"c1","uid":1467182,"ip_address":"","ucode":"C80107538EAA7F","user_header":"https://static001.geekbang.org/account/avatar/00/16/63/2e/e49116d1.jpg","comment_is_top":false,"comment_ctime":1554904274,"is_pvip":false,"replies":[{"id":"30635","content":"1. æœ‰å¾ˆå¤šæœåŠ¡æ˜¯ä¾èµ–conntrackçš„ï¼Œæ‰€ä»¥è¦çœ‹å®é™…éœ€æ±‚ç¡®å®š<br>2. è¦çœ‹iptablesè§„åˆ™æ˜¯ä¸æ˜¯ç”¨åˆ°äº†conntrackåŠŸèƒ½","user_name":"ä½œè€…å›å¤","comment_id":84767,"uid":"1001282","ip_address":"","utype":1,"ctime":1555075053,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":2,"race_medal":1,"score":"27324708050","product_id":100020901,"comment_content":"è€å¸ˆä½ å¥½ï¼Œæœ‰ä¸¤ä¸ªé—®é¢˜æƒ³è¯·æ•™ä¸€ä¸‹ã€‚<br>ç¬¬ä¸€ç‚¹ï¼Œäº†è§£åˆ°ip_conntrackæ¨¡å—æ—¢ç„¶ä¼šé™åˆ¶é“¾æ¥ï¼Œä¸”è°ƒå¤§ä¼šå¯¼è‡´å ç”¨å†…å­˜ï¼Œè€Œä¸”è°ƒå¤§äº†ä¹Ÿä¸ä¸€å®šèƒ½è§£å†³å¤§æµé‡æœåŠ¡å™¨çš„ç½‘ç»œæ€§èƒ½é—®é¢˜ï¼Œæˆ‘ç†è§£æ˜¯ä¸æ˜¯åº”è¯¥å…³æ‰ip_conntrackæ¨¡å—ï¼Œå› ä¸ºä¸šåŠ¡æœåŠ¡å™¨æŒ‰ç†è¯´æ˜¯ä¸éœ€è¦çŠ¶æ€è¿½è¸ªçš„ã€‚<br>ç¬¬äºŒç‚¹ï¼Œå¦‚æœæˆ‘å…³æ‰ip_conntrackï¼Œä¼šä¸ä¼šå› ä¸ºæˆ‘æ‰§è¡Œiptableså‘½ä»¤å¯¼è‡´è¯¥æ¨¡å—è¢«åŠ è½½ï¼Œæˆ–è€…æ‰§è¡Œconntrackå‘½ä»¤å¯¼è‡´æ¨¡å—è¢«åŠ è½½ã€‚ã€‚","like_count":7,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":446440,"discussion_content":"1. æœ‰å¾ˆå¤šæœåŠ¡æ˜¯ä¾èµ–conntrackçš„ï¼Œæ‰€ä»¥è¦çœ‹å®é™…éœ€æ±‚ç¡®å®š\n2. è¦çœ‹iptablesè§„åˆ™æ˜¯ä¸æ˜¯ç”¨åˆ°äº†conntrackåŠŸèƒ½","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1555075053,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2068721,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/90/f1/7f2b5e16.jpg","nickname":"CHN-Lee-ç‰ç±³","note":"","ucode":"0A53080F38F229","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":378013,"discussion_content":"ä½ å¯ä»¥åœ¨rawè¡¨åŠ ä¸€æ¡notrackè§„åˆ™","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1622997436,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":90920,"user_name":"æ— åè€å’","can_delete":false,"product_type":"c1","uid":1348261,"ip_address":"","ucode":"48874CE670E122","user_header":"","comment_is_top":false,"comment_ctime":1556723333,"is_pvip":false,"replies":[{"id":"33127","content":"åº”è¯¥æ˜¯åè¿‡æ¥ï¼Œnf_conntrack_maxæ˜¯æœ€å¤§è¿æ¥è·Ÿè¸ªæ•°ï¼Œnf_conntrack_bucketsæ˜¯è¿æ¥è·Ÿè¸ªè¡¨ï¼ˆå“ˆå¸Œè¡¨ï¼‰å¤§å°ã€‚å“ˆå¸Œè¡¨æœ€å¤§ä¹Ÿå°±æ˜¯æœ€å¤§è¿æ¥è·Ÿè¸ªæ•°","user_name":"ä½œè€…å›å¤","comment_id":90920,"uid":"1001282","ip_address":"","utype":1,"ctime":1557326418,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":2,"race_medal":0,"score":"23031559813","product_id":100020901,"comment_content":"å¾ˆæƒŠè®¶ï¼Œä¹‹å‰åœ¨çº¿ä¸Šç¯å¢ƒä¸­å°±å‡ºç°äº†kernel: nf_conntrack: table full, dropping packet.çš„æŠ¥é”™ï¼Œå½“æ—¶å°±è®¤ä¸ºæ˜¯conntrack_maxå¯¼è‡´çš„ï¼Œåé¢è°ƒæ•´äº†è¿™ä¸ªå€¼ä¹‹åå°±æ¢å¤äº†ï¼Œä½†å…¶å®é‚£æ¬¡æ•…éšœä¹Ÿä¸åº”è¯¥ä¼šåŠ è½½nf_conntrackæ¨¡å—ï¼Œå› ä¸ºiptablesè§„åˆ™åªæ˜¯è®¾ç½®äº†å‡ ä¸ªIPå…è®¸ç™»é™†æœåŠ¡å™¨ï¼Œå½“æ—¶ä¹Ÿä¸æ¸…æ¥šä¸ºä»€ä¹ˆä¼šå»åŠ è½½è¿™ä¸ªæ¨¡å—äº†ã€‚<br><br>åŒæ—¶ï¼Œconntrack_maxå’Œconntrack_bucketsæœ‰æ²¡æœ‰ä»€ä¹ˆè”ç³»å‘¢ï¼Ÿä»æè¿°ä¸­ï¼Œæ„Ÿè§‰conntrack_bucketsåº”è¯¥è¦å¤§äºconntrack_maxæ‰å¯¹ï¼Œä½†å®é™… ä¸Šä¸æ˜¯è¿™æ ·ï¼Œè¯·è€å¸ˆè§£æƒ‘ä¸‹ã€‚","like_count":5,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":448722,"discussion_content":"åº”è¯¥æ˜¯åè¿‡æ¥ï¼Œnf_conntrack_maxæ˜¯æœ€å¤§è¿æ¥è·Ÿè¸ªæ•°ï¼Œnf_conntrack_bucketsæ˜¯è¿æ¥è·Ÿè¸ªè¡¨ï¼ˆå“ˆå¸Œè¡¨ï¼‰å¤§å°ã€‚å“ˆå¸Œè¡¨æœ€å¤§ä¹Ÿå°±æ˜¯æœ€å¤§è¿æ¥è·Ÿè¸ªæ•°","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1557326418,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2110718,"avatar":"https://static001.geekbang.org/account/avatar/00/20/34/fe/e5429b02.jpg","nickname":"glimmer","note":"","ucode":"48A16C52FB4C45","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":367959,"discussion_content":"iptablesä¸€å¼€å¯å°±ä¼šæ¿€æ´»è¿™ä¸ªnf_conntrackï¼Œæˆ–è€…iptablesæ²¡å¼€å¯ä½†æ‰§è¡Œiptables -t nat -L ç­‰æŸ¥è¯¢å‘½ä»¤å¯èƒ½äº¦ä¼šæ¿€æ´»(å› ä¸ºnatæ¨¡å—ä¾èµ–nf_conntrack)ã€‚æ˜¯è¿™æ ·çš„å—ï¼Œè€å¸ˆï¼Ÿ","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1618501715,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":71646,"user_name":"æ˜ç¿¼","can_delete":false,"product_type":"c1","uid":1068361,"ip_address":"","ucode":"E77F86BEB3D5C1","user_header":"https://static001.geekbang.org/account/avatar/00/10/4d/49/28e73b9c.jpg","comment_is_top":false,"comment_ctime":1551406721,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"18731275905","product_id":100020901,"comment_content":"systemtapè¿™ä¸ªçœŸç‰›ï¼Œè¿˜å¯ä»¥è¿½è¸ªå†…æ ¸æ¨¡å—æ‰§è¡Œï¼Œé•¿è§è¯†å’¯ï¼iptableséœ€è¦å­¦ä¹ ä¸‹","like_count":4},{"had_liked":false,"id":71019,"user_name":"æˆ‘æ¥ä¹Ÿ","can_delete":false,"product_type":"c1","uid":1205253,"ip_address":"","ucode":"773D6104F56767","user_header":"https://static001.geekbang.org/account/avatar/00/12/64/05/6989dce6.jpg","comment_is_top":false,"comment_ctime":1551246218,"is_pvip":false,"replies":[{"id":"25715","content":"æ˜¯çš„","user_name":"ä½œè€…å›å¤","comment_id":71019,"uid":"1001282","ip_address":"","utype":1,"ctime":1551399502,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":1,"race_medal":0,"score":"14436148106","product_id":100020901,"comment_content":"[D42æ‰“å¡]<br>ä»Šå¤©çš„å†…å®¹åªèƒ½å›´è§‚äº†.<br>å±…ç„¶è¿˜ç”¨äº†å†…æ ¸åŠ¨æ€è¿½è¸ªå·¥å…·,ç»Ÿè®¡ä¸¢åŒ…ä½ç½®.<br>å¯¹äºæˆ‘è¿™ç§å®Œå…¨ä¸äº†è§£å†…æ ¸çš„äººæ¥è¯´, åªå½“æ˜¯å¼€äº†çœ¼ç•Œ.<br><br>å¯¹äºæˆ‘æ¥è¯´,ç›®å‰çŸ¥é“ NATä¼šå¸¦æ¥æ€§èƒ½æŸè€— å°±è¡Œäº†.ğŸ¤¦â€â™€ï¸<br>èƒ½é¿å…å°±é¿å…ä½¿ç”¨,ä¸èƒ½é¿å…äº†å°±åœ¨è¯·æ±‚æ•°è¾ƒå¤šçš„åœºæ™¯ä¸‹è°ƒäº›å‚æ•°.<br><br>`# è¿æ¥è·Ÿè¸ªå¯¹è±¡å¤§å°ä¸º 376ï¼Œé“¾è¡¨é¡¹å¤§å°ä¸º 16`<br>è¿™åº”è¯¥æ˜¯cç»“æ„ä½“çš„å¤§å°å§.<br>","like_count":3,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440946,"discussion_content":"æ˜¯çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551399502,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":306926,"user_name":"ç« æ˜Ÿ","can_delete":false,"product_type":"c1","uid":1134381,"ip_address":"","ucode":"6A4BC852BE7025","user_header":"https://static001.geekbang.org/account/avatar/00/11/4f/2d/7b5ed6c2.jpg","comment_is_top":false,"comment_ctime":1628778973,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"5923746269","product_id":100020901,"comment_content":"æ‰§è¡Œç¬¬äºŒä¸ª8080çš„å®¹å™¨çš„æ—¶å€™æç¤ºï¼š<br>&#47;bin&#47;sh: 1: cannot create &#47;proc&#47;sys&#47;net&#47;netfilter&#47;nf_conntrack_max: Permission denied  <br>ä¸çŸ¥é“æœ‰æ²¡æœ‰äººç¢°åˆ°ï¼Œæ€ä¹ˆè§£å†³å‘¢<br>root@vm101:&#47;home&#47;zhang# docker logs nginx         <br>&#47;bin&#47;sh: 1: cannot create &#47;proc&#47;sys&#47;net&#47;netfilter&#47;nf_conntrack_max: Permission denied<br>root@vm101:&#47;home&#47;zhang# docker ps -a<br>CONTAINER ID   IMAGE              COMMAND                  CREATED          STATUS                      PORTS     NAMES<br>79b0ea8bb408   feisky&#47;nginx:nat   &quot;&#47;bin&#47;sh -c &#39;echo 10â€¦&quot;   11 minutes ago   Exited (2) 11 minutes ago             nginx","like_count":1,"discussions":[{"author":{"id":1059938,"avatar":"https://static001.geekbang.org/account/avatar/00/10/2c/62/906b5eee.jpg","nickname":"æ¯’ç‹¼","note":"","ucode":"0771F3868CD604","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":579084,"discussion_content":"é«˜ç‰ˆæœ¬å†…æ ¸å¯ä»¥è¿è¡Œå¦‚ä¸‹å‘½ä»¤å¯åŠ¨natå®¹å™¨ï¼šsysctl -w net.nf_conntrack_max=1000; docker run --name nginx --privileged -p 8080:8080 -itd feisky/nginx:nat /bin/sh -c &#34;nginx -g \\&#34;daemon off;\\&#34;&#34;","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1657168049,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1082187,"avatar":"https://static001.geekbang.org/account/avatar/00/10/83/4b/0e96fcae.jpg","nickname":"sky","note":"","ucode":"FC323371453C97","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":552550,"discussion_content":"æˆ‘ä¹Ÿé‡åˆ°äº†ï¼Œä¹Ÿæ²¡æ‰¾åˆ°è§£å†³æ–¹æ¡ˆ.","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1645509284,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":119127,"user_name":"aliuql","can_delete":false,"product_type":"c1","uid":1086235,"ip_address":"","ucode":"FCF6CEC8138A94","user_header":"https://static001.geekbang.org/account/avatar/00/10/93/1b/bf902c9d.jpg","comment_is_top":false,"comment_ctime":1564529463,"is_pvip":false,"replies":[{"id":"44418","content":"ä¸ä¸€å®šï¼Œæ¯”å¦‚ä½¿ç”¨hostnetworkå°±ä¼šç›´æ¥ä½¿ç”¨hostçš„ç½‘ç»œã€‚NATæ”¯æŒæµé‡é™åˆ¶ï¼Œä¸è¿‡éœ€è¦é¢å¤–çš„é…ç½®","user_name":"ä½œè€…å›å¤","comment_id":119127,"uid":"1001282","ip_address":"","utype":1,"ctime":1565017103,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":1,"race_medal":0,"score":"5859496759","product_id":100020901,"comment_content":"è€å¸ˆä½ å¥½ï¼Œdockerï¼Œæ˜¯ä¸æ˜¯å¿…ç„¶ä¼šç”¨åˆ°dnatçš„ç«¯å£æ˜ å°„ï¼ŸlinuxæœåŠ¡å™¨å†… natæœ¬èº«åº”è¯¥ä¹Ÿæœ‰æµé‡é™åˆ¶å§ï¼","like_count":1,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":460753,"discussion_content":"ä¸ä¸€å®šï¼Œæ¯”å¦‚ä½¿ç”¨hostnetworkå°±ä¼šç›´æ¥ä½¿ç”¨hostçš„ç½‘ç»œã€‚NATæ”¯æŒæµé‡é™åˆ¶ï¼Œä¸è¿‡éœ€è¦é¢å¤–çš„é…ç½®","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565017103,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":71052,"user_name":"å¤œç©ºä¸­æœ€äº®çš„æ˜Ÿ","can_delete":false,"product_type":"c1","uid":1267566,"ip_address":"","ucode":"ADC3E7B6789955","user_header":"https://static001.geekbang.org/account/avatar/00/13/57/6e/b6795c44.jpg","comment_is_top":false,"comment_ctime":1551254685,"is_pvip":false,"replies":[{"id":"25716","content":"NATï¼Œä¸æ˜¯netğŸ˜Š","user_name":"ä½œè€…å›å¤","comment_id":71052,"uid":"1001282","ip_address":"","utype":1,"ctime":1551399544,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":1,"race_medal":0,"score":"5846221981","product_id":100020901,"comment_content":"ä»¥å‰åªæ˜¯çŸ¥é“netæ€§èƒ½ä¸å¥½ï¼Œä»Šå¤©é€šè¿‡è€å¸ˆçš„è®²è§£å½»åº•æ˜ç™½äº†æ¥é¾™å»è„‰ã€‚<br>å…¬å¸å†…éƒ¨ä¸Šç½‘ç”¨çš„å°±æ˜¯net äººä¸€å¤šå°±ç‰¹åˆ«æ…¢ã€‚<br>ä¸šåŠ¡åŸºæœ¬ä¸Šæ²¡ç”¨è¿‡netã€‚","like_count":1,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440962,"discussion_content":"NATï¼Œä¸æ˜¯netğŸ˜Š","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551399544,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":70908,"user_name":"Cranliu","can_delete":false,"product_type":"c1","uid":1304302,"ip_address":"","ucode":"DC2DE84B142FDA","user_header":"https://static001.geekbang.org/account/avatar/00/13/e6/ee/e3c4c9b3.jpg","comment_is_top":false,"comment_ctime":1551227377,"is_pvip":false,"replies":[{"id":"25713","content":"å…ˆå°è¯•å°è¯•æ¡ˆä¾‹ï¼Œå†å›å»è¡¥è¡¥åŸºç¡€","user_name":"ä½œè€…å›å¤","comment_id":70908,"uid":"1001282","ip_address":"","utype":1,"ctime":1551399330,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":3,"race_medal":0,"score":"5846194673","product_id":100020901,"comment_content":"ä»Šå¤©æ˜¯è·Ÿä¸ä¸Šäº†ï¼Œæ²¡æœ‰ç½‘ç»œåŸºç¡€ï¼Œè¿›å…¥åˆ°ç½‘ç»œæ¨¡å—å°±å¼€å§‹è§‰å¾—åƒåŠ›äº†ğŸ˜‚","like_count":1,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440894,"discussion_content":"å…ˆå°è¯•å°è¯•æ¡ˆä¾‹ï¼Œå†å›å»è¡¥è¡¥åŸºç¡€","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551399330,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1970516,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLK4NPyaFDl4rzrd4A9z42tQDibFLdCicbrAdyUa5P2B5u8UCUBenpHX7VgUCibvHvhpza4icMBKVnhmA/132","nickname":"å­¦æ— æ­¢å¢ƒ","note":"","ucode":"2C28E8E54DAB4E","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":415293,"discussion_content":"ç¡®å®åƒåŠ›","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637048828,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1297269,"avatar":"https://static001.geekbang.org/account/avatar/00/13/cb/75/0106cd63.jpg","nickname":"æ°¸","note":"","ucode":"F1737EBDB046FB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":128846,"discussion_content":"æœ‰åŒæ„Ÿï¼Œå¾ˆåƒåŠ›ï¼Œè§‰å¾—æ˜¯é•¿è§è¯†äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578665759,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":356893,"user_name":"Brilliant","can_delete":false,"product_type":"c1","uid":1522168,"ip_address":"ä¸Šæµ·","ucode":"CFF4F5BCAF21EE","user_header":"https://static001.geekbang.org/account/avatar/00/17/39/f8/b5a1b669.jpg","comment_is_top":false,"comment_ctime":1662688180,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1662688180","product_id":100020901,"comment_content":"$ docker run --name nginx --privileged -p 8080:8080 -itd feisky&#47;nginx:nat<br>æ‰§è¡Œåå®¹å™¨æ²¡æœ‰å¯åŠ¨èµ·æ¥ï¼Œæ—¥å¿—æ˜¾ç¤º<br>&#47;bin&#47;sh: 1: cannot create &#47;proc&#47;sys&#47;net&#47;netfilter&#47;nf_conntrack_max: Permission denied<br><br>éœ€è¦ä¸ºå®¹å™¨ä¸­çš„å…¥å£æŒ‡ä»¤ææƒï¼Œå¦‚ä¸‹ï¼š<br>$ docker run --name nginx --privileged=true -u=root -p 8080:8080 -itd feisky&#47;nginx:nat &#47;bin&#47;sh<br><br>é™„dockerç‰ˆæœ¬ä¸ºï¼š20.10.17","like_count":0,"discussions":[{"author":{"id":2052700,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/52/5c/d4a9accb.jpg","nickname":"ä»„è¨€","note":"","ucode":"D35DD3AF65A0BE","race_medal":1,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":589039,"discussion_content":"è¸©å‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1664358987,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"æµ™æ±Ÿ"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":353733,"user_name":"è‚¥low","can_delete":false,"product_type":"c1","uid":1043480,"ip_address":"åŒ—äº¬","ucode":"A158AFAAB8C742","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ec/18/bf7254d3.jpg","comment_is_top":false,"comment_ctime":1659706151,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1659706151","product_id":100020901,"comment_content":"è¿™ä¸ªåŸºç¡€çŸ¥è¯†åº”è¯¥å»å“ªé‡Œå­¦ä¹ æ‰èƒ½ä¸èµ°å¼¯è·¯å‘¢â€¦â€¦","like_count":0},{"had_liked":false,"id":329118,"user_name":"JianXu","can_delete":false,"product_type":"c1","uid":1033219,"ip_address":"","ucode":"2A61BDBB573BDC","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c4/03/f753fda7.jpg","comment_is_top":false,"comment_ctime":1641133175,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1641133175","product_id":100020901,"comment_content":"<br># è¿æ¥è·Ÿè¸ªå¯¹è±¡å¤§å°ä¸º376ï¼Œé“¾è¡¨é¡¹å¤§å°ä¸º16<br>nf_conntrack_max*è¿æ¥è·Ÿè¸ªå¯¹è±¡å¤§å°+nf_conntrack_buckets*é“¾è¡¨é¡¹å¤§å° <br>= 1000*376+65536*16 B<br>= 1.4 MB<br><br>åœ¨è¿™æ ·çš„è®¾ç½®ä¸‹ï¼Œæ¯ä¸€ä¸ªbucket æ‰€å¯¹åº”çš„list å¤§å°æ˜¯ 1000&#47;65536 ? é‚£å°±æ˜¯ä¸åˆ°1,  æ„æ€æ˜¯å¤§éƒ¨é—¨æƒ…å†µéƒ½ä¸éœ€è¦å•å‘é“¾è¡¨éå†äº†å—ï¼Ÿ","like_count":0},{"had_liked":false,"id":324818,"user_name":"Issacæ…œ","can_delete":false,"product_type":"c1","uid":1793361,"ip_address":"","ucode":"690B69FC1C0BB2","user_header":"https://static001.geekbang.org/account/avatar/00/1b/5d/51/87fc7ef9.jpg","comment_is_top":false,"comment_ctime":1638663140,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1638663140","product_id":100020901,"comment_content":"åœ¨æµ‹è¯•ç³»ç»Ÿçš„å¹¶å‘å’Œæ–°å»ºæ—¶ï¼Œå‡ºç°è¿‡æŒ‡æ ‡ä¸Šä¸å»çš„é—®é¢˜ã€‚æœ€ç»ˆå°±æ˜¯å‘ç°æœ€å¤§è¿æ¥è·Ÿè¸ªæ•°è®¾ç½®çš„æ¯”è¾ƒå°ï¼Œå¯¼è‡´æµ‹è¯•ä¸é€šè¿‡","like_count":1},{"had_liked":false,"id":311711,"user_name":"å°åˆš","can_delete":false,"product_type":"c1","uid":1018189,"ip_address":"","ucode":"8B30EEF1A194FB","user_header":"","comment_is_top":false,"comment_ctime":1631420305,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1631420305","product_id":100020901,"comment_content":"è¿™ç¯‡æ–‡ç« ä»”ç»†çœ‹äº†å‡ éï¼Œä¹Ÿæ“ä½œäº†æ–‡ä¸­çš„å®é™…æ¡ˆä¾‹ã€‚æœŸé—´é‡åˆ°çš„é—®é¢˜åŠè§£å†³æ–¹æ³•é¡ºä¾¿è®°å½•ä¸€ä¸‹ï¼š<br><br>1.å¸¦NATçš„dockerå¯åŠ¨ä¸èµ·æ¥ï¼Œdocker logs æç¤ºæƒé™ä¸è¶³ï¼Œä¿®æ”¹Dockerfileï¼Œè¿›å…¥dockerå‘ç°å®é™…æ˜¯ &#47;proc&#47;sys&#47;net&#47;netfilter&#47;nf_conntrack_maxæ–‡ä»¶æ— å†™æƒé™<br>2.systemtapæŒ‰æ–‡ä¸­æ­¥éª¤å®‰è£…åï¼Œæ‰§è¡Œè„šæœ¬æŠ¥ç¬¦å·æ‰¾ä¸åˆ°ï¼Œå°è¯•ä»æºç å®‰è£…ä»ä¸å¯ç”¨<br><br>æˆ‘ç”¨çš„ubuntuç‰ˆæœ¬ä¸ºæœ€æ–°ä¸‹è½½çš„18.04.5ï¼ŒåŸå› ä¸ºubuntu18.04.5çš„å†…æ ¸ç‰ˆæœ¬(5.4)è¿‡é«˜å¯¼è‡´çš„å…¼å®¹æ€§é—®é¢˜ï¼Œå®‰è£…18.04.1(å†…æ ¸4.15.0)å³å¯è§£å†³è¿™ä¸¤é—®é¢˜ï¼Œå…¶ä¸­systemtapé—®é¢˜è¦æ³¨æ„ä¸‹systemtapå’Œå†…æ ¸ç‰ˆæœ¬å…¼å®¹ã€‚","like_count":1,"discussions":[{"author":{"id":1970516,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLK4NPyaFDl4rzrd4A9z42tQDibFLdCicbrAdyUa5P2B5u8UCUBenpHX7VgUCibvHvhpza4icMBKVnhmA/132","nickname":"å­¦æ— æ­¢å¢ƒ","note":"","ucode":"2C28E8E54DAB4E","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":415294,"discussion_content":"å“ªæœ‰dockerfile???","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637048859,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":262903,"user_name":"å¤§å¤§","can_delete":false,"product_type":"c1","uid":1340730,"ip_address":"","ucode":"3A3DC9AC382651","user_header":"https://static001.geekbang.org/account/avatar/00/14/75/3a/a7596c06.jpg","comment_is_top":false,"comment_ctime":1605877270,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1605877270","product_id":100020901,"comment_content":"ä¸çŸ¥é“è€å¸ˆç°åœ¨è¿˜èƒ½å›ç­”é—®é¢˜ä¹ˆï¼Œæˆ‘ä»¬çº¿ä¸Šå‡ºç°ä¸€ä¸ªé—®é¢˜ï¼Œå†…æ ¸æ¯”è¾ƒæ–°5.4ï¼Œipvsæ¨¡å¼ä¸‹ï¼Œåªæœ‰ä¸€å°ç‰©ç†æœºä¸Šå‡ºç°é—®é¢˜ï¼Œpodå†…é€šè¿‡serviceè®¿é—®æœåŠ¡ï¼Œå½“åç«¯çš„podåœ¨æœ¬æœºæ—¶ç™¾åˆ†ä¹‹ç™¾è¶…æ—¶å¤±è´¥ï¼Œç»æŠ“åŒ…å‘ç°svcåé¢çš„podè¿”å›tcpä¸‰æ¬¡æ¡æ‰‹çš„ç¬¬äºŒä¸ªåŒ…æ—¶åŸipæ²¡æœ‰æ”¹æˆservice  ipvs å¯¼è‡´client  ç›´æ¥reset","like_count":0},{"had_liked":false,"id":211087,"user_name":"æ¬§é›„è™(Badguyï¼‰","can_delete":false,"product_type":"c1","uid":1573307,"ip_address":"","ucode":"D72B1CC455AA56","user_header":"https://static001.geekbang.org/account/avatar/00/18/01/bb/7d15d44a.jpg","comment_is_top":false,"comment_ctime":1587893853,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1587893853","product_id":100020901,"comment_content":"è€å¸ˆæˆ‘é‚£ä¸ªè„šæœ¬ä¸èƒ½æ‰§è¡ŒæˆåŠŸï¼Œè¾›è‹¦å¸®çœ‹ä¸‹ï¼Œè‡ªå·±ç™¾åº¦æ²¡è§£å†³<br>root@VM-0-5-ubuntu:~# stap --all-modules dropwatch.stp<br>semantic error: while resolving probe point: identifier &#39;kernel&#39; at dropwatch.stp:19:7<br>        source: probe kernel.trace(&quot;kfree_skb&quot;) { locations[$location] &lt;&lt;&lt; 1 }<br>                      ^<br><br>semantic error: no match (similar tracepoints: map, kfree, rdpmc, unmap, read_msr)<br><br>Pass 2: analysis failed.  [man error::pass2]<br>Tip: &#47;usr&#47;share&#47;doc&#47;systemtap&#47;README.Debian should help you get started.<br>root@VM-0-5-ubuntu:~# uname -r<br>4.15.0-54-generic<br>","like_count":0},{"had_liked":false,"id":196086,"user_name":"Hillså½•","can_delete":false,"product_type":"c1","uid":1000004,"ip_address":"","ucode":"779020947ACABA","user_header":"https://static001.geekbang.org/account/avatar/00/0f/42/44/d3d67640.jpg","comment_is_top":false,"comment_ctime":1585234398,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1585234398","product_id":100020901,"comment_content":"è¿™ç¯‡çœ‹çš„å¤ªçˆ½äº†ï¼ŒæœŸå¾…è‡ªå·±æ—©æ—¥èƒ½å¤Ÿå¦‚æ­¤è¿™èˆ¬ï½","like_count":0},{"had_liked":false,"id":190498,"user_name":"Richard","can_delete":false,"product_type":"c1","uid":1316758,"ip_address":"","ucode":"893F958B9DD161","user_header":"https://static001.geekbang.org/account/avatar/00/14/17/96/846fc11b.jpg","comment_is_top":false,"comment_ctime":1584665051,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1584665051","product_id":100020901,"comment_content":"è¿™ä¸ªä¾‹å­æ˜¯æè¿°Linuxä½¿ç”¨natåŠŸèƒ½é‡åˆ°çš„æ€§èƒ½é—®é¢˜ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬éƒ½æ˜¯åœ¨è·¯ç”±å™¨æˆ–è€…é˜²ç«å¢™ä¸­ä½¿ç”¨natï¼Œè¿™ç§æƒ…å†µä¸‹ä¼šä¸ä¼šé‡åˆ°natçš„æ€§èƒ½é—®é¢˜ï¼Ÿå¦‚æœæœ‰é‚£ä¹ˆæœ‰æ²¡æœ‰ç›¸åº”çš„æ’æŸ¥æ–¹å¼ï¼Ÿ","like_count":0},{"had_liked":false,"id":161655,"user_name":"Geek_1386e9","can_delete":false,"product_type":"c1","uid":1584198,"ip_address":"","ucode":"DCD2234365F6C7","user_header":"","comment_is_top":false,"comment_ctime":1576287651,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1576287651","product_id":100020901,"comment_content":"è€å¸ˆï¼Œæœ‰ä¸ªsnaté—®é¢˜è¯·æ•™ä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†åä¸ºäº‘çš„snatç½‘å…³ï¼Œæˆ‘ç†è§£snatç½‘å…³ä»£ç†å†…ç½‘ä¸»æœºè®¿é—®å…¬ç½‘æ˜¯ä½œä¸ºå®¢æˆ·ç«¯è®¿é—®å…¬ç½‘çš„ï¼Œé‚£ä¹ˆæœ€å¤§çš„è¿æ¥æ•°åº”è¯¥å—åˆ°ç«¯å£å·65535çš„é™åˆ¶ï¼Œä¸ºä»€ä¹ˆåœ¨ç®¡ç†åå°å¯ä»¥æŸ¥åˆ°snatçš„è¿æ¥æ•°ä¼šè¶…è¿‡65535å‘¢ï¼Œæƒ³ä¸æ˜ç™½ï¼Œçƒ¦è¯·æŠ½ç©ºè§£ç­”ä¸‹","like_count":0},{"had_liked":false,"id":141643,"user_name":"è¾‰æ™–","can_delete":false,"product_type":"c1","uid":1574062,"ip_address":"","ucode":"E5EC033EE4952B","user_header":"https://static001.geekbang.org/account/avatar/00/18/04/ae/0118c132.jpg","comment_is_top":false,"comment_ctime":1571206361,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1571206361","product_id":100020901,"comment_content":"è¿™è¾¹å®‰è£…å®éªŒä½¿ç”¨abå‹æµ‹ï¼Œæ²¡æœ‰å¤§é‡nf_hook_slowä¸¢åŒ…<br>29384 packets dropped at tcp_rcv_state_process<br>22287 packets dropped at sk_stream_kill_queues<br>12686 packets dropped at tcp_v4_rcv<br>6668 packets dropped at tcp_v4_do_rcv<br>8 packets dropped at unix_stream_connect<br>1 packets dropped at nf_hook_slow<br>1 packets dropped at unix_release_sock","like_count":0},{"had_liked":false,"id":134687,"user_name":"åˆ˜é¼","can_delete":false,"product_type":"c1","uid":1104094,"ip_address":"","ucode":"B534B9394A56F9","user_header":"https://static001.geekbang.org/account/avatar/00/10/d8/de/8f40357d.jpg","comment_is_top":false,"comment_ctime":1568895456,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1568895456","product_id":100020901,"comment_content":"# è¿æ¥è·Ÿè¸ªå¯¹è±¡å¤§å°ä¸º 376ï¼Œé“¾è¡¨é¡¹å¤§å°ä¸º 16<br>nf_conntrack_max* è¿æ¥è·Ÿè¸ªå¯¹è±¡å¤§å° +nf_conntrack_buckets* é“¾è¡¨é¡¹å¤§å° <br>= 1000*376+65536*16 B<br>= 1.4 MB<br><br>è¿™ä¸ªè®¡ç®—ï¼Œåº”è¯¥æ˜¯å‡è®¾æ¯ä¸ªé“¾è¡¨åªæœ‰ä¸€ä¸ªç»“ç‚¹å§ï¼Ÿ<br>æˆ‘ç†è§£æ˜¯æœ‰65535ä¸ªé“¾è¡¨ï¼Œå‡å¦‚1000ä¸ªåœ¨ä¸€ä¸ªé“¾è¡¨ï¼Œåº”è¯¥æ˜¯65535+1000ä¸ªçš„ç»“ç‚¹ç©ºé—´ï¼Ÿ","like_count":0},{"had_liked":false,"id":119261,"user_name":"tony","can_delete":false,"product_type":"c1","uid":1051042,"ip_address":"","ucode":"C8AB60BD90327B","user_header":"https://static001.geekbang.org/account/avatar/00/10/09/a2/40f83a42.jpg","comment_is_top":false,"comment_ctime":1564545242,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1564545242","product_id":100020901,"comment_content":"root@ub1805:~# apt-key adv --keyserver keyserver.ubuntu.com --recv-keys F2EDC64DC5AEE1F6B9C621F0C8CAB6595FDFF622<br>Executing: &#47;tmp&#47;apt-key-gpghome.kvfiZkEsRG&#47;gpg.1.sh --keyserver keyserver.ubuntu.com --recv-keys F2EDC64DC5AEE1F6B9C621F0C8CAB6595FDFF622<br>gpg: keyserver receive failed: Invalid argument<br>root@ub1805:~# stap-prep<br>You need package linux-image-4.15.0-52-generic-dbgsym but it does not seem to be available<br> Ubuntu -dbgsym packages are typically in a separate repository<br> Follow https:&#47;&#47;wiki.ubuntu.com&#47;DebuggingProgramCrash to add this repository<br>root@ub1805:~# apt-get install linux-image-`uname -r`-dbgsym<br>Reading package lists... Done<br>Building dependency tree       <br>Reading state information... Done<br>E: Unable to locate package linux-image-4.15.0-52-generic-dbgsym<br>E: Couldn&#39;t find any package by glob &#39;linux-image-4.15.0-52-generic-dbgsym&#39;<br>E: Couldn&#39;t find any package by regex &#39;linux-image-4.15.0-52-generic-dbgsym&#39;<br>å¥½åƒæ— æ³•å®‰è£…","like_count":0},{"had_liked":false,"id":110057,"user_name":"bigzuo","can_delete":false,"product_type":"c1","uid":1224554,"ip_address":"","ucode":"448C258D31A8A6","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/RQdib68D7dsoFlYXOweiaPqLrcyn2jD6DCGnz8nc2VFmhmX0bpGTeSrVM5M9Qs7ibIInAmt5MeLcpcNja5YjyZCIg/132","comment_is_top":false,"comment_ctime":1562162345,"is_pvip":false,"replies":[{"id":"40092","content":"æ­£å¥½èµ¶ç´§å»è¡¥è¡¥ğŸ˜Š","user_name":"ä½œè€…å›å¤","user_name_real":"å€ªæœ‹é£","uid":"1001282","ctime":1562249197,"ip_address":"","comment_id":110057,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1562162345","product_id":100020901,"comment_content":"ä¸å¤ªç†Ÿæ‚‰linux ç½‘ç»œåº•å±‚è¶…è¿‡ï¼Œè¿™èŠ‚è¯¾çœ‹çš„å¾ˆè´¹åŠ›","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":456701,"discussion_content":"æ­£å¥½èµ¶ç´§å»è¡¥è¡¥ğŸ˜Š","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562249197,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":101943,"user_name":"Goal","can_delete":false,"product_type":"c1","uid":1307012,"ip_address":"","ucode":"C337CD4C7E07B0","user_header":"https://static001.geekbang.org/account/avatar/00/13/f1/84/7d21bd9e.jpg","comment_is_top":false,"comment_ctime":1560065051,"is_pvip":false,"replies":[{"id":"37095","content":"å¯ä»¥åªè°ƒæ•´ä¸€ä¸ªï¼Œä¸è¿‡è¦è®°å¾—è¿™ä¸¤ä¸ªå‚æ•°ä¸€èµ·å†³å®šäº†è¿æ¥è·Ÿè¸ªè¡¨çš„ç»“æ„ï¼Œè¿™æ˜¯ä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œä¸¤è€…ç›¸é™¤è¡¨ç¤ºå†²çªçš„ç¨‹åº¦ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å€ªæœ‹é£","uid":"1001282","ctime":1560260294,"ip_address":"","comment_id":101943,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1560065051","product_id":100020901,"comment_content":"nf_conntrack_buckets å’Œ nf_conntrack_max  ä»æ–‡ä¸­çš„æè¿°æ²¡æœ‰ææ¸…æ¥šï¼Œ<br>æˆ‘ä»¬åªæ˜¯è°ƒæ•´äº† nf_conntrack_maxï¼ˆæœ€å¤§è¿æ¥è·Ÿè¸ªæ•°ï¼‰ï¼Œé‚£ä¹ˆï¼Œè¿™ä¸ªè¿æ¥æ˜¯è®°å½•åœ¨ nf_conntrack_bucketsï¼ˆè¿æ¥è·Ÿè¸ªè¡¨ï¼‰ä¸­çš„å—ï¼Ÿï¼Œé‚£æ˜¯å¦æ„å‘³ç€ï¼Œè°ƒæ•´maxçš„åŒæ—¶ï¼Œä¹Ÿå¾—è°ƒæ•´bucketsè¡¨çš„å¤§å°ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":453182,"discussion_content":"å¯ä»¥åªè°ƒæ•´ä¸€ä¸ªï¼Œä¸è¿‡è¦è®°å¾—è¿™ä¸¤ä¸ªå‚æ•°ä¸€èµ·å†³å®šäº†è¿æ¥è·Ÿè¸ªè¡¨çš„ç»“æ„ï¼Œè¿™æ˜¯ä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œä¸¤è€…ç›¸é™¤è¡¨ç¤ºå†²çªçš„ç¨‹åº¦ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1560260294,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":98159,"user_name":"manatee","can_delete":false,"product_type":"c1","uid":1041112,"ip_address":"","ucode":"708D90E7A265BD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/e2/d8/f0562ede.jpg","comment_is_top":false,"comment_ctime":1558922561,"is_pvip":false,"replies":[{"id":"35924","content":"è°¢è°¢æŒ‡å‡º","user_name":"ä½œè€…å›å¤","user_name_real":"å€ªæœ‹é£","uid":"1001282","ctime":1559429243,"ip_address":"","comment_id":98159,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1558922561","product_id":100020901,"comment_content":"å¦å¤–å®‰è£…centos å®‰è£…systemtapé‚£è¾¹æœ‰ä¸ªå°å°çš„ç¬”è¯¯ï¼Œæœ€åé‚£ä¸ªstab-prep åº”è¯¥æ˜¯stap-prep","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":451583,"discussion_content":"è°¢è°¢æŒ‡å‡º","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1559429243,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":98149,"user_name":"manatee","can_delete":false,"product_type":"c1","uid":1041112,"ip_address":"","ucode":"708D90E7A265BD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/e2/d8/f0562ede.jpg","comment_is_top":false,"comment_ctime":1558921164,"is_pvip":false,"replies":[{"id":"35925","content":"å—¯å—¯ ä¸åŒç‰ˆæœ¬çš„é€‰é¡¹æœ‰å¯èƒ½ä¸ä¸€æ ·ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€ç›´å¼ºè°ƒè¦æŸ¥man","user_name":"ä½œè€…å›å¤","user_name_real":"å€ªæœ‹é£","uid":"1001282","ctime":1559429296,"ip_address":"","comment_id":98149,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1558921164","product_id":100020901,"comment_content":"è®²ä¸ªä¸æ˜¯å¾ˆé‡è¦çš„ç‚¹ï¼Œabå‘½ä»¤åœ¨centosä¸­æ²¡æœ‰-så‚æ•°","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":451578,"discussion_content":"å—¯å—¯ ä¸åŒç‰ˆæœ¬çš„é€‰é¡¹æœ‰å¯èƒ½ä¸ä¸€æ ·ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€ç›´å¼ºè°ƒè¦æŸ¥man","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1559429296,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":79347,"user_name":"Maxwell","can_delete":false,"product_type":"c1","uid":1086275,"ip_address":"","ucode":"720A00AD472616","user_header":"https://static001.geekbang.org/account/avatar/00/10/93/43/0e84492d.jpg","comment_is_top":false,"comment_ctime":1553440908,"is_pvip":false,"replies":[{"id":"29341","content":"å¯èƒ½æ˜¯debuginfoè·Ÿå†…æ ¸ç‰ˆæœ¬ä¸ä¸€è‡´","user_name":"ä½œè€…å›å¤","user_name_real":"å€ªæœ‹é£","uid":"1001282","ctime":1553698804,"ip_address":"","comment_id":79347,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1553440908","product_id":100020901,"comment_content":"è¯·é—®è¿™ä¸ªé”™è¯¯æ˜¯ä»€ä¹ˆåŸå› å¯¼è‡´çš„å‘¢ï¼Ÿ<br>root@maxwell-virtual-machine:&#47;usr&#47;bin&#47;env# stap --all-modules dropwatch.stp<br>semantic error: while resolving probe point: identifier &#39;kernel&#39; at dropwatch.stp:18:7<br>        source: probe kernel.trace(&quot;kfree_skb&quot;) { locations[$location] &lt;&lt;&lt; 1 }<br>                      ^<br><br>semantic error: no match<br><br>Pass 2: analysis failed.  [man error::pass2]<br>Tip: &#47;usr&#47;share&#47;doc&#47;systemtap&#47;README.Debian should help you get started.<br>","like_count":1,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":444463,"discussion_content":"å¯èƒ½æ˜¯debuginfoè·Ÿå†…æ ¸ç‰ˆæœ¬ä¸ä¸€è‡´","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1553698804,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1169422,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d8/0e/1bf7f57a.jpg","nickname":"ğŸ‰æ™¶æ™¶ğŸ‰ğŸ˜„","note":"","ucode":"76B608C42E06A8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":531074,"discussion_content":"[root@localhost ~]# uname -a\nLinux localhost.localdomain 4.18.0-348.el8.x86_64 #1 SMP Tue Oct 19 15:14:17 UTC 2021 x86_64 x86_64 x86_64 GNU/Linux\n[root@localhost ~]#  rpm -qa|grep kernel\nkernel-devel-4.18.0-348.el8.x86_64\nkernel-4.18.0-348.el8.x86_64\nkernel-tools-4.18.0-348.el8.x86_64\nkernel-tools-libs-4.18.0-348.el8.x86_64\nkernel-core-4.18.0-348.el8.x86_64\nkernel-headers-4.18.0-348.el8.x86_64\nkernel-debuginfo-common-x86_64-4.18.0-348.el8.x86_64\nkernel-debuginfo-4.18.0-348.el8.x86_64\nkernel-modules-4.18.0-348.el8.x86_64\n\n\ncentos8ä¸‹ï¼Œæ£€æŸ¥äº†å†…æ ¸ç‰ˆæœ¬ä¸€æ ·çš„ï¼Œè¿˜æ˜¯æœ‰è¿™ä¸ªé—®é¢˜ï¼š\n[root@localhost ~]# stap --all-modules dropwatch.stp\nsemantic error: while resolving probe point: identifier &#39;kernel&#39; at dropwatch.stp:19:7\n        source: probe kernel.trace(&#34;kfree_skb&#34;) { locations[$location] &lt;&lt;&lt; 1 }\n                      ^\n\nsemantic error: no match (similar tracepoints: map, kfree, xrun, reg_rr, reg_wr)","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637221090,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"user_type\":1}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":71326,"user_name":"xfan","can_delete":false,"product_type":"c1","uid":1315147,"ip_address":"","ucode":"48ED8D498D7F56","user_header":"https://static001.geekbang.org/account/avatar/00/14/11/4b/fa64f061.jpg","comment_is_top":false,"comment_ctime":1551320986,"is_pvip":false,"replies":[{"id":"25723","content":"ğŸ˜Š","user_name":"ä½œè€…å›å¤","user_name_real":"å€ªæœ‹é£","uid":"1001282","ctime":1551400586,"ip_address":"","comment_id":71326,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1551320986","product_id":100020901,"comment_content":"è®²çš„ä¸é”™ï¼Œè®©æˆ‘æ‡‚äº†è¿½è¸ªè¿‡ç¨‹ï¼Œå’Œæˆ‘æœ€æƒ³çŸ¥é“çš„ä¸œè¥¿","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":441109,"discussion_content":"ğŸ˜Š","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551400586,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":71249,"user_name":"ninuxer","can_delete":false,"product_type":"c1","uid":1243135,"ip_address":"","ucode":"5394ADAF2667D6","user_header":"https://wx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEKQMM4m7NHuicr55aRiblTSEWIYe0QqbpyHweaoAbG7j2v7UUElqqeP3Ihrm3UfDPDRb1Hv8LvPwXqA/132","comment_is_top":false,"comment_ctime":1551313171,"is_pvip":false,"replies":[{"id":"25720","content":"å—¯ å†…æ ¸æ•°æ®ç»“æ„çš„å¤§å°","user_name":"ä½œè€…å›å¤","user_name_real":"å€ªæœ‹é£","uid":"1001282","ctime":1551400037,"ip_address":"","comment_id":71249,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1551313171","product_id":100020901,"comment_content":"æ‰“å¡day44<br>å¾ˆå°‘ç”¨natï¼Œæ²¡æœ‰å‘è¨€æƒğŸ˜‚<br>ä¸è¿‡å¯¹äºlvsçš„natæ¨¡å¼ï¼Œä¹‹åå¦‚æœç”¨åˆ°ï¼Œå¯ä»¥ç”¨è¿™é‡Œçš„contrackå‘½ä»¤åˆ†æåˆ†æå…·ä½“çŠ¶æ€<br>ç„¶åè®¡ç®—é“¾è¡¨å ç”¨å†…å­˜å¤§å°çš„ï¼Œé“¾æ¥å¯¹è±¡376å’Œé“¾è¡¨å¤§å°16æ˜¯å›ºå®šæ•°å€¼ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":441068,"discussion_content":"å—¯ å†…æ ¸æ•°æ®ç»“æ„çš„å¤§å°","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551400037,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":71153,"user_name":"noma","can_delete":false,"product_type":"c1","uid":1334774,"ip_address":"","ucode":"ADB9D589B9A798","user_header":"","comment_is_top":false,"comment_ctime":1551274493,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1551274493","product_id":100020901,"comment_content":"systemtap è¿™ä¸ªä½¿ç”¨å§¿åŠ¿å¥½é«˜çº§ï¼","like_count":1}]}