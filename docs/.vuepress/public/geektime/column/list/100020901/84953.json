{"id":84953,"title":"46 | æ¡ˆä¾‹ç¯‡ï¼šä¸ºä»€ä¹ˆåº”ç”¨å®¹å™¨åŒ–åï¼Œå¯åŠ¨æ…¢äº†å¾ˆå¤šï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å€ªæœ‹é£ã€‚</p><p>ä¸çŸ¥ä¸è§‰ï¼Œæˆ‘ä»¬å·²ç»å­¦å®Œäº†æ•´ä¸ªä¸“æ çš„å››å¤§åŸºç¡€æ¨¡å—ï¼Œå³ CPUã€å†…å­˜ã€æ–‡ä»¶ç³»ç»Ÿå’Œç£ç›˜ I/Oã€ä»¥åŠç½‘ç»œçš„æ€§èƒ½åˆ†æå’Œä¼˜åŒ–ã€‚ç›¸ä¿¡ä½ å·²ç»æŒæ¡äº†è¿™äº›åŸºç¡€æ¨¡å—çš„åŸºæœ¬åˆ†æã€å®šä½æ€è·¯ï¼Œå¹¶ç†Ÿæ‚‰äº†ç›¸å…³çš„ä¼˜åŒ–æ–¹æ³•ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†è¿›å…¥æœ€åä¸€ä¸ªé‡è¦æ¨¡å—â€”â€” ç»¼åˆå®æˆ˜ç¯‡ã€‚è¿™éƒ¨åˆ†å®æˆ˜å†…å®¹ï¼Œä¹Ÿå°†æ˜¯æˆ‘ä»¬å¯¹å‰é¢æ‰€å­¦çŸ¥è¯†çš„å¤ä¹ å’Œæ·±åŒ–ã€‚</p><p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œéšç€ Kubernetesã€Docker ç­‰æŠ€æœ¯çš„æ™®åŠï¼Œè¶Šæ¥è¶Šå¤šçš„ä¼ä¸šï¼Œéƒ½å·²ç»èµ°ä¸Šäº†åº”ç”¨ç¨‹åºå®¹å™¨åŒ–çš„é“è·¯ã€‚æˆ‘ç›¸ä¿¡ï¼Œä½ åœ¨äº†è§£å­¦ä¹ è¿™äº›æŠ€æœ¯çš„åŒæ—¶ï¼Œä¸€å®šä¹Ÿå¬è¯´è¿‡ä¸å°‘ï¼ŒåŸºäº Docker çš„å¾®æœåŠ¡æ¶æ„å¸¦æ¥çš„å„ç§ä¼˜åŠ¿ï¼Œæ¯”å¦‚ï¼š</p><ul>\n<li>\n<p>ä½¿ç”¨ Docker ï¼ŒæŠŠåº”ç”¨ç¨‹åºä»¥åŠç›¸å…³ä¾èµ–æ‰“åŒ…åˆ°é•œåƒä¸­åï¼Œéƒ¨ç½²å’Œå‡çº§æ›´å¿«æ·ï¼›</p>\n</li>\n<li>\n<p>æŠŠä¼ ç»Ÿçš„å•ä½“åº”ç”¨æ‹†åˆ†æˆå¤šä¸ªæ›´å°çš„å¾®æœåŠ¡åº”ç”¨åï¼Œæ¯ä¸ªå¾®æœåŠ¡çš„åŠŸèƒ½éƒ½æ›´ç®€å•ï¼Œå¹¶ä¸”å¯ä»¥å•ç‹¬ç®¡ç†å’Œç»´æŠ¤ï¼›</p>\n</li>\n<li>\n<p>æ¯ä¸ªå¾®æœåŠ¡éƒ½å¯ä»¥æ ¹æ®éœ€æ±‚æ¨ªå‘æ‰©å±•ã€‚å³ä½¿å‘ç”Ÿæ•…éšœï¼Œä¹Ÿåªæ˜¯å±€éƒ¨æœåŠ¡ä¸å¯ç”¨ï¼Œè€Œä¸åƒä»¥å‰é‚£æ ·ï¼Œå¯¼è‡´æ•´ä¸ªæœåŠ¡ä¸å¯ç”¨ã€‚</p>\n</li>\n</ul><p>ä¸è¿‡ï¼Œä»»ä½•æŠ€æœ¯éƒ½ä¸æ˜¯é“¶å¼¹ã€‚è¿™äº›æ–°æŠ€æœ¯ï¼Œåœ¨å¸¦æ¥è¯¸å¤šä¾¿æ·åŠŸèƒ½ä¹‹å¤–ï¼Œä¹Ÿå¸¦æ¥äº†æ›´é«˜çš„å¤æ‚æ€§ï¼Œæ¯”å¦‚æ€§èƒ½é™ä½ã€æ¶æ„å¤æ‚ã€æ’é”™å›°éš¾ç­‰ç­‰ã€‚</p><p>ä»Šå¤©ï¼Œæˆ‘å°±é€šè¿‡ä¸€ä¸ª Tomcat æ¡ˆä¾‹ï¼Œå¸¦ä½ ä¸€èµ·å­¦ä¹ ï¼Œå¦‚ä½•åˆ†æåº”ç”¨ç¨‹åºå®¹å™¨åŒ–åçš„æ€§èƒ½é—®é¢˜ã€‚</p><!-- [[[read_end]]] --><h2>æ¡ˆä¾‹å‡†å¤‡</h2><p>ä»Šå¤©çš„æ¡ˆä¾‹ï¼Œæˆ‘ä»¬åªéœ€è¦ä¸€å°è™šæ‹Ÿæœºã€‚è¿˜æ˜¯åŸºäº Ubuntu 18.04ï¼ŒåŒæ ·é€‚ç”¨äºå…¶ä»–çš„ Linux ç³»ç»Ÿã€‚æˆ‘ä½¿ç”¨çš„æ¡ˆä¾‹ç¯å¢ƒå¦‚ä¸‹æ‰€ç¤ºï¼š</p><ul>\n<li>\n<p>æœºå™¨é…ç½®ï¼š2 CPUï¼Œ8GB å†…å­˜ã€‚</p>\n</li>\n<li>\n<p>é¢„å…ˆå®‰è£… dockerã€curlã€jqã€pidstat ç­‰å·¥å…·ï¼Œå¦‚ apt install docker.io curl jq sysstatã€‚</p>\n</li>\n</ul><p>å…¶ä¸­ï¼Œjq å·¥å…·ä¸“é—¨ç”¨æ¥åœ¨å‘½ä»¤è¡Œä¸­å¤„ç† jsonã€‚ä¸ºäº†æ›´å¥½çš„å±•ç¤º json æ•°æ®ï¼Œæˆ‘ä»¬ç”¨è¿™ä¸ªå·¥å…·ï¼Œæ¥æ ¼å¼åŒ– json è¾“å‡ºã€‚</p><p>ä½ éœ€è¦æ‰“å¼€ä¸¤ä¸ªç»ˆç«¯ï¼Œç™»å½•åˆ°åŒä¸€å°è™šæ‹Ÿæœºä¸­ï¼Œå¹¶å®‰è£…ä¸Šè¿°å·¥å…·ã€‚</p><p>æ³¨æ„ï¼Œä»¥ä¸‹æ‰€æœ‰å‘½ä»¤éƒ½é»˜è®¤ä»¥ root ç”¨æˆ·è¿è¡Œï¼Œå¦‚æœä½ ç”¨æ™®é€šç”¨æˆ·èº«ä»½ç™»é™†ç³»ç»Ÿï¼Œè¯·è¿è¡Œ sudo su root å‘½ä»¤åˆ‡æ¢åˆ° root ç”¨æˆ·ã€‚</p><blockquote>\n<p>å¦‚æœå®‰è£…è¿‡ç¨‹æœ‰é—®é¢˜ï¼Œä½ å¯ä»¥å…ˆä¸Šç½‘æœç´¢è§£å†³ï¼Œå®åœ¨è§£å†³ä¸äº†çš„ï¼Œè®°å¾—åœ¨ç•™è¨€åŒºå‘æˆ‘æé—®ã€‚</p>\n</blockquote><p>åˆ°è¿™é‡Œï¼Œå‡†å¤‡å·¥ä½œå°±å®Œæˆäº†ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ­£å¼è¿›å…¥æ“ä½œç¯èŠ‚ã€‚</p><h2>æ¡ˆä¾‹åˆ†æ</h2><p>æˆ‘ä»¬ä»Šå¤©è¦åˆ†æçš„æ¡ˆä¾‹ï¼Œæ˜¯ä¸€ä¸ª Tomcat åº”ç”¨ã€‚Tomcat æ˜¯ Apache åŸºé‡‘ä¼šæ——ä¸‹ï¼ŒJakarta é¡¹ç›®å¼€å‘çš„è½»é‡çº§åº”ç”¨æœåŠ¡å™¨ï¼Œå®ƒåŸºäº Java è¯­è¨€å¼€å‘ã€‚Docker ç¤¾åŒºä¹Ÿç»´æŠ¤ç€ Tomcat çš„<a href=\"https://hub.docker.com/_/tomcat\">å®˜æ–¹é•œåƒ</a>ï¼Œä½ å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™ä¸ªé•œåƒï¼Œæ¥å¯åŠ¨ä¸€ä¸ª Tomcat åº”ç”¨ã€‚</p><p>æˆ‘ä»¬çš„æ¡ˆä¾‹ï¼Œä¹ŸåŸºäº Tomcat çš„å®˜æ–¹é•œåƒæ„å»ºï¼Œå…¶æ ¸å¿ƒé€»è¾‘å¾ˆç®€å•ï¼Œå°±æ˜¯åˆ†é…ä¸€ç‚¹å„¿å†…å­˜ï¼Œå¹¶è¾“å‡º â€œHello, world!â€ã€‚</p><pre><code>&lt;%\nbyte data[] = new byte[256*1024*1024];\nout.println(&quot;Hello, wolrd!&quot;);\n%&gt;\n</code></pre><p>ä¸ºäº†æ–¹ä¾¿ä½ è¿è¡Œï¼Œæˆ‘å·²ç»å°†å®ƒæ‰“åŒ…æˆäº†ä¸€ä¸ª <a href=\"https://github.com/feiskyer/linux-perf-examples/tree/master/tomcat\">Docker é•œåƒ</a> feisky/tomcat:8ï¼Œå¹¶æ¨é€åˆ°äº† Docker Hub ä¸­ã€‚ä½ å¯ä»¥ç›´æ¥æŒ‰ç…§ä¸‹é¢çš„æ­¥éª¤æ¥è¿è¡Œå®ƒã€‚</p><p>åœ¨ç»ˆç«¯ä¸€ä¸­ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œå¯åŠ¨ Tomcat åº”ç”¨ï¼Œå¹¶ç›‘å¬ 8080ç«¯å£ã€‚å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œä½ åº”è¯¥å¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„è¾“å‡ºï¼š</p><pre><code># -mè¡¨ç¤ºè®¾ç½®å†…å­˜ä¸º512MB\n$ docker run --name tomcat --cpus 0.1 -m 512M -p 8080:8080 -itd feisky/tomcat:8\nUnable to find image 'feisky/tomcat:8' locally\n8: Pulling from feisky/tomcat\n741437d97401: Pull complete\n...\n22cd96a25579: Pull complete\nDigest: sha256:71871cff17b9043842c2ec99f370cc9f1de7bc121cd2c02d8e2092c6e268f7e2\nStatus: Downloaded newer image for feisky/tomcat:8\nWARNING: Your kernel does not support swap limit capabilities or the cgroup is not mounted. Memory limited without swap.\n2df259b752db334d96da26f19166d662a82283057411f6332f3cbdbcab452249\n</code></pre><p>ä»è¾“å‡ºä¸­ï¼Œä½ å¯ä»¥çœ‹åˆ°ï¼Œdocker run å‘½ä»¤ï¼Œä¼šè‡ªåŠ¨æ‹‰å–é•œåƒå¹¶å¯åŠ¨å®¹å™¨ã€‚</p><p>è¿™é‡Œé¡ºä¾¿æä¸€ä¸‹ï¼Œä¹‹å‰å¾ˆå¤šåŒå­¦ç•™è¨€é—®ï¼Œåˆ°åº•è¦æ€ä¹ˆä¸‹è½½ Docker é•œåƒã€‚å…¶å®ï¼Œä¸Šé¢çš„ docker runï¼Œå°±æ˜¯è‡ªåŠ¨ä¸‹è½½é•œåƒåˆ°æœ¬åœ°åï¼Œæ‰å¼€å§‹è¿è¡Œçš„ã€‚</p><p>ç”±äº Docker é•œåƒåˆ†å¤šå±‚ç®¡ç†ï¼Œæ‰€ä»¥åœ¨ä¸‹è½½æ—¶ï¼Œä½ ä¼šçœ‹åˆ°æ¯å±‚çš„ä¸‹è½½è¿›åº¦ã€‚é™¤äº†åƒdocker run è¿™æ ·è‡ªåŠ¨ä¸‹è½½é•œåƒå¤–ï¼Œä½ ä¹Ÿå¯ä»¥åˆ†ä¸¤æ­¥èµ°ï¼Œå…ˆä¸‹è½½é•œåƒï¼Œç„¶åå†è¿è¡Œå®¹å™¨ã€‚</p><p>æ¯”å¦‚ï¼Œä½ å¯ä»¥å…ˆè¿è¡Œä¸‹é¢çš„ docker pull å‘½ä»¤ï¼Œä¸‹è½½é•œåƒï¼š</p><pre><code>$ docker pull feisky/tomcat:8\n8: Pulling from feisky/tomcat\nDigest: sha256:71871cff17b9043842c2ec99f370cc9f1de7bc121cd2c02d8e2092c6e268f7e2\nStatus: Image is up to date for feisky/tomcat:8\n</code></pre><p>æ˜¾ç„¶ï¼Œåœ¨æˆ‘çš„æœºå™¨ä¸­ï¼Œé•œåƒå·²å­˜åœ¨ï¼Œæ‰€ä»¥å°±ä¸éœ€è¦å†æ¬¡ä¸‹è½½ï¼Œç›´æ¥è¿”å›æˆåŠŸå°±å¯ä»¥äº†ã€‚</p><p>æ¥ç€ï¼Œåœ¨ç»ˆç«¯äºŒä¸­ä½¿ç”¨ curlï¼Œè®¿é—® Tomcat ç›‘å¬çš„ 8080 ç«¯å£ï¼Œç¡®è®¤æ¡ˆä¾‹å·²ç»æ­£å¸¸å¯åŠ¨ï¼š</p><pre><code>$ curl localhost:8080\ncurl: (56) Recv failure: Connection reset by peer\n</code></pre><p>ä¸è¿‡ï¼Œå¾ˆä¸å¹¸ï¼Œcurl è¿”å›äº† â€œConnection reset by peerâ€ çš„é”™è¯¯ï¼Œè¯´æ˜ Tomcat æœåŠ¡ï¼Œå¹¶ä¸èƒ½æ­£å¸¸å“åº”å®¢æˆ·ç«¯è¯·æ±‚ã€‚</p><p>æ˜¯ä¸æ˜¯ Tomcat å¯åŠ¨å‡ºé—®é¢˜äº†å‘¢ï¼Ÿæˆ‘ä»¬åˆ‡æ¢åˆ°ç»ˆç«¯ä¸€ä¸­ï¼Œæ‰§è¡Œ docker logs å‘½ä»¤ï¼ŒæŸ¥çœ‹å®¹å™¨çš„æ—¥å¿—ã€‚è¿™é‡Œæ³¨æ„ï¼Œéœ€è¦åŠ ä¸Š -f å‚æ•°ï¼Œè¡¨ç¤ºè·Ÿè¸ªå®¹å™¨çš„æœ€æ–°æ—¥å¿—è¾“å‡ºï¼š</p><pre><code>$ docker logs -f tomcat\nUsing CATALINA_BASE:   /usr/local/tomcat\nUsing CATALINA_HOME:   /usr/local/tomcat\nUsing CATALINA_TMPDIR: /usr/local/tomcat/temp\nUsing JRE_HOME:        /docker-java-home/jre\nUsing CLASSPATH:       /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar\n</code></pre><p>ä»è¿™å„¿ä½ å¯ä»¥çœ‹åˆ°ï¼ŒTomcat å®¹å™¨åªæ‰“å°äº†ç¯å¢ƒå˜é‡ï¼Œè¿˜æ²¡æœ‰åº”ç”¨ç¨‹åºåˆå§‹åŒ–çš„æ—¥å¿—ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒTomcat è¿˜åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œè¿™æ—¶å€™å»è®¿é—®å®ƒï¼Œå½“ç„¶æ²¡æœ‰å“åº”ã€‚</p><p>ä¸ºäº†è§‚å¯Ÿ Tomcat çš„å¯åŠ¨è¿‡ç¨‹ï¼Œæˆ‘ä»¬åœ¨ç»ˆç«¯ä¸€ä¸­ï¼Œç»§ç»­ä¿ç•™ docker logs -f å‘½ä»¤ï¼Œå¹¶åœ¨ç»ˆç«¯äºŒä¸­æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œå¤šæ¬¡å°è¯•è®¿é—® Tomcatï¼š</p><pre><code>$ for ((i=0;i&lt;30;i++)); do curl localhost:8080; sleep 1; done\ncurl: (56) Recv failure: Connection reset by peer\ncurl: (56) Recv failure: Connection reset by peer\n# è¿™å„¿ä¼šé˜»å¡ä¸€ä¼š\nHello, wolrd!\ncurl: (52) Empty reply from server\ncurl: (7) Failed to connect to localhost port 8080: Connection refused\ncurl: (7) Failed to connect to localhost port 8080: Connection refused\n</code></pre><p>è§‚å¯Ÿä¸€ä¼šå„¿ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œä¸€æ®µæ—¶é—´åï¼Œcurl ç»ˆäºç»™å‡ºäº†æˆ‘ä»¬æƒ³è¦çš„ç»“æœ â€œHello, wolrd!â€ã€‚ä½†æ˜¯ï¼Œéšååˆå‡ºç°äº† â€œEmpty reply from serverâ€ ï¼Œå’Œä¸€ç›´æŒç»­çš„ â€œConnection refusedâ€ é”™è¯¯ã€‚æ¢å¥è¯è¯´ï¼ŒTomcat å“åº”ä¸€æ¬¡è¯·æ±‚åï¼Œå°±å†ä¹Ÿä¸å“åº”äº†ã€‚</p><p>è¿™æ˜¯æ€ä¹ˆå›äº‹å‘¢ï¼Ÿæˆ‘ä»¬å›åˆ°ç»ˆç«¯ä¸€ä¸­ï¼Œè§‚å¯Ÿ Tomcat çš„æ—¥å¿—ï¼Œçœ‹çœ‹èƒ½ä¸èƒ½æ‰¾åˆ°ä»€ä¹ˆçº¿ç´¢ã€‚</p><p>ä»ç»ˆç«¯ä¸€ä¸­ï¼Œä½ åº”è¯¥å¯ä»¥çœ‹åˆ°ä¸‹é¢çš„è¾“å‡ºï¼š</p><pre><code>18-Feb-2019 12:43:32.719 INFO [localhost-startStop-1] org.apache.catalina.startup.HostConfig.deployDirectory Deploying web application directory [/usr/local/tomcat/webapps/docs]\n18-Feb-2019 12:43:33.725 INFO [localhost-startStop-1] org.apache.catalina.startup.HostConfig.deployDirectory Deployment of web application directory [/usr/local/tomcat/webapps/docs] has finished in [1,006] ms\n18-Feb-2019 12:43:33.726 INFO [localhost-startStop-1] org.apache.catalina.startup.HostConfig.deployDirectory Deploying web application directory [/usr/local/tomcat/webapps/manager]\n18-Feb-2019 12:43:34.521 INFO [localhost-startStop-1] org.apache.catalina.startup.HostConfig.deployDirectory Deployment of web application directory [/usr/local/tomcat/webapps/manager] has finished in [795] ms\n18-Feb-2019 12:43:34.722 INFO [main] org.apache.coyote.AbstractProtocol.start Starting ProtocolHandler [&quot;http-nio-8080&quot;]\n18-Feb-2019 12:43:35.319 INFO [main] org.apache.coyote.AbstractProtocol.start Starting ProtocolHandler [&quot;ajp-nio-8009&quot;]\n18-Feb-2019 12:43:35.821 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 24096 ms\nroot@ubuntu:~#\n</code></pre><p>ä»å†…å®¹ä¸Šå¯ä»¥çœ‹åˆ°ï¼ŒTomcat åœ¨å¯åŠ¨ 24s åå®Œæˆåˆå§‹åŒ–ï¼Œå¹¶ä¸”æ­£å¸¸å¯åŠ¨ã€‚ä»æ—¥å¿—ä¸Šæ¥çœ‹ï¼Œæ²¡æœ‰ä»€ä¹ˆé—®é¢˜ã€‚</p><p>ä¸è¿‡ï¼Œç»†å¿ƒçš„ä½ è‚¯å®šæ³¨æ„åˆ°äº†æœ€åä¸€è¡Œï¼Œæ˜æ˜¾æ˜¯å›åˆ°äº† Linux çš„ SHELL ç»ˆç«¯ä¸­ï¼Œè€Œæ²¡æœ‰ç»§ç»­ç­‰å¾… Docker è¾“å‡ºçš„å®¹å™¨æ—¥å¿—ã€‚</p><p>è¾“å‡ºé‡æ–°å›åˆ° SHELL ç»ˆç«¯ï¼Œé€šå¸¸è¡¨ç¤ºä¸Šä¸€ä¸ªå‘½ä»¤å·²ç»ç»“æŸã€‚è€Œæˆ‘ä»¬çš„ä¸Šä¸€ä¸ªå‘½ä»¤ï¼Œæ˜¯ docker logs -f å‘½ä»¤ã€‚é‚£ä¹ˆï¼Œå®ƒçš„é€€å‡ºå°±åªæœ‰ä¸¤ç§å¯èƒ½äº†ï¼Œè¦ä¹ˆæ˜¯å®¹å™¨é€€å‡ºäº†ï¼Œè¦ä¹ˆå°±æ˜¯ dockerd è¿›ç¨‹é€€å‡ºäº†ã€‚</p><p>ç©¶ç«Ÿæ˜¯å“ªç§æƒ…å†µå‘¢ï¼Ÿè¿™å°±éœ€è¦æˆ‘ä»¬è¿›ä¸€æ­¥ç¡®è®¤äº†ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ç»ˆç«¯ä¸€ä¸­ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼ŒæŸ¥çœ‹å®¹å™¨çš„çŠ¶æ€ï¼š</p><pre><code>$ docker ps -a\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                            PORTS               NAMES\n0f2b3fcdd257        feisky/tomcat:8     &quot;catalina.sh run&quot;   2 minutes ago       Exited (137) About a minute ago                       tomcat\n</code></pre><p>ä½ ä¼šçœ‹åˆ°ï¼Œå®¹å™¨å¤„äº Exited çŠ¶æ€ï¼Œè¯´æ˜æ˜¯ç¬¬ä¸€ç§æƒ…å†µï¼Œå®¹å™¨å·²ç»é€€å‡ºã€‚ä¸è¿‡ä¸ºä»€ä¹ˆä¼šè¿™æ ·å‘¢ï¼Ÿæ˜¾ç„¶ï¼Œåœ¨å‰é¢å®¹å™¨çš„æ—¥å¿—é‡Œï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰å‘ç°çº¿ç´¢ï¼Œé‚£å°±åªèƒ½ä» Docker æœ¬èº«å…¥æ‰‹äº†ã€‚</p><p>æˆ‘ä»¬å¯ä»¥è°ƒç”¨ Docker çš„ APIï¼ŒæŸ¥è¯¢å®¹å™¨çš„çŠ¶æ€ã€é€€å‡ºç ä»¥åŠé”™è¯¯ä¿¡æ¯ï¼Œç„¶åç¡®å®šå®¹å™¨é€€å‡ºçš„åŸå› ã€‚è¿™äº›å¯ä»¥é€šè¿‡ docker inspect å‘½ä»¤æ¥å®Œæˆï¼Œæ¯”å¦‚ï¼Œä½ å¯ä»¥ç»§ç»­æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œé€šè¿‡ -f é€‰é¡¹è®¾ç½®åªè¾“å‡ºå®¹å™¨çš„çŠ¶æ€ï¼š</p><pre><code># æ˜¾ç¤ºå®¹å™¨çŠ¶æ€ï¼Œjqç”¨æ¥æ ¼å¼åŒ–jsonè¾“å‡º\n$ docker inspect tomcat -f '{{json .State}}' | jq\n{\n  &quot;Status&quot;: &quot;exited&quot;,\n  &quot;Running&quot;: false,\n  &quot;Paused&quot;: false,\n  &quot;Restarting&quot;: false,\n  &quot;OOMKilled&quot;: true,\n  &quot;Dead&quot;: false,\n  &quot;Pid&quot;: 0,\n  &quot;ExitCode&quot;: 137,\n  &quot;Error&quot;: &quot;&quot;,\n  ...\n}\n</code></pre><p>è¿™æ¬¡ä½ å¯ä»¥çœ‹åˆ°ï¼Œå®¹å™¨å·²ç»å¤„äº exited çŠ¶æ€ï¼ŒOOMKilled æ˜¯ trueï¼ŒExitCode æ˜¯ 137ã€‚è¿™å…¶ä¸­ï¼ŒOOMKilled è¡¨ç¤ºå®¹å™¨è¢« OOM æ€æ­»äº†ã€‚</p><p>æˆ‘ä»¬å‰é¢æåˆ°è¿‡ï¼ŒOOM è¡¨ç¤ºå†…å­˜ä¸è¶³æ—¶ï¼ŒæŸäº›åº”ç”¨ä¼šè¢«ç³»ç»Ÿæ€æ­»ã€‚å¯æ˜¯ï¼Œä¸ºä»€ä¹ˆå†…å­˜ä¼šä¸è¶³å‘¢ï¼Ÿæˆ‘ä»¬çš„åº”ç”¨åˆ†é…äº† 256 MB çš„å†…å­˜ï¼Œè€Œå®¹å™¨å¯åŠ¨æ—¶ï¼Œæ˜æ˜é€šè¿‡ -m é€‰é¡¹ï¼Œè®¾ç½®äº† 512 MB çš„å†…å­˜ï¼ŒæŒ‰è¯´åº”è¯¥æ˜¯è¶³å¤Ÿçš„ã€‚</p><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä¼°è®¡ä½ åº”è¯¥è¿˜è®°å¾—ï¼Œå½“ OOM å‘ç”Ÿæ—¶ï¼Œç³»ç»Ÿä¼šæŠŠç›¸å…³çš„ OOM ä¿¡æ¯ï¼Œè®°å½•åˆ°æ—¥å¿—ä¸­ã€‚æ‰€ä»¥ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç»ˆç«¯ä¸­æ‰§è¡Œ dmesg å‘½ä»¤ï¼ŒæŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—ï¼Œå¹¶å®šä½ OOM ç›¸å…³çš„æ—¥å¿—ï¼š</p><pre><code>$ dmesg\n[193038.106393] java invoked oom-killer: gfp_mask=0x14000c0(GFP_KERNEL), nodemask=(null), order=0, oom_score_adj=0\n[193038.106396] java cpuset=0f2b3fcdd2578165ea77266cdc7b1ad43e75877b0ac1889ecda30a78cb78bd53 mems_allowed=0\n[193038.106402] CPU: 0 PID: 27424 Comm: java Tainted: G  OE    4.15.0-1037 #39-Ubuntu\n[193038.106404] Hardware name: Microsoft Corporation Virtual Machine/Virtual Machine, BIOS 090007  06/02/2017\n[193038.106405] Call Trace:\n[193038.106414]  dump_stack+0x63/0x89\n[193038.106419]  dump_header+0x71/0x285\n[193038.106422]  oom_kill_process+0x220/0x440\n[193038.106424]  out_of_memory+0x2d1/0x4f0\n[193038.106429]  mem_cgroup_out_of_memory+0x4b/0x80\n[193038.106432]  mem_cgroup_oom_synchronize+0x2e8/0x320\n[193038.106435]  ? mem_cgroup_css_online+0x40/0x40\n[193038.106437]  pagefault_out_of_memory+0x36/0x7b\n[193038.106443]  mm_fault_error+0x90/0x180\n[193038.106445]  __do_page_fault+0x4a5/0x4d0\n[193038.106448]  do_page_fault+0x2e/0xe0\n[193038.106454]  ? page_fault+0x2f/0x50\n[193038.106456]  page_fault+0x45/0x50\n[193038.106459] RIP: 0033:0x7fa053e5a20d\n[193038.106460] RSP: 002b:00007fa0060159e8 EFLAGS: 00010206\n[193038.106462] RAX: 0000000000000000 RBX: 00007fa04c4b3000 RCX: 0000000009187440\n[193038.106463] RDX: 00000000943aa440 RSI: 0000000000000000 RDI: 000000009b223000\n[193038.106464] RBP: 00007fa006015a60 R08: 0000000002000002 R09: 00007fa053d0a8a1\n[193038.106465] R10: 00007fa04c018b80 R11: 0000000000000206 R12: 0000000100000768\n[193038.106466] R13: 00007fa04c4b3000 R14: 0000000100000768 R15: 0000000010000000\n[193038.106468] Task in /docker/0f2b3fcdd2578165ea77266cdc7b1ad43e75877b0ac1889ecda30a78cb78bd53 killed as a result of limit of /docker/0f2b3fcdd2578165ea77266cdc7b1ad43e75877b0ac1889ecda30a78cb78bd53\n[193038.106478] memory: usage 524288kB, limit 524288kB, failcnt 77\n[193038.106480] memory+swap: usage 0kB, limit 9007199254740988kB, failcnt 0\n[193038.106481] kmem: usage 3708kB, limit 9007199254740988kB, failcnt 0\n[193038.106481] Memory cgroup stats for /docker/0f2b3fcdd2578165ea77266cdc7b1ad43e75877b0ac1889ecda30a78cb78bd53: cache:0KB rss:520580KB rss_huge:450560KB shmem:0KB mapped_file:0KB dirty:0KB writeback:0KB inactive_anon:0KB active_anon:520580KB inactive_file:0KB active_file:0KB unevictable:0KB\n[193038.106494] [ pid ]   uid  tgid total_vm      rss pgtables_bytes swapents oom_score_adj name\n[193038.106571] [27281]     0 27281  1153302   134371  1466368        0             0 java\n[193038.106574] Memory cgroup out of memory: Kill process 27281 (java) score 1027 or sacrifice child\n[193038.148334] Killed process 27281 (java) total-vm:4613208kB, anon-rss:517316kB, file-rss:20168kB, shmem-rss:0kB\n[193039.607503] oom_reaper: reaped process 27281 (java), now anon-rss:0kB, file-rss:0kB, shmem-rss:0kB\n</code></pre><p>ä» dmesg çš„è¾“å‡ºï¼Œä½ å°±å¯ä»¥çœ‹åˆ°å¾ˆè¯¦ç»†çš„ OOM è®°å½•äº†ã€‚ä½ åº”è¯¥å¯ä»¥çœ‹åˆ°ä¸‹é¢å‡ ä¸ªå…³é”®ç‚¹ã€‚</p><ul>\n<li>\n<p>ç¬¬ä¸€ï¼Œè¢«æ€æ­»çš„æ˜¯ä¸€ä¸ª java è¿›ç¨‹ã€‚ä»å†…æ ¸è°ƒç”¨æ ˆä¸Šçš„ mem_cgroup_out_of_memory å¯ä»¥çœ‹å‡ºï¼Œå®ƒæ˜¯å› ä¸ºè¶…è¿‡ cgroup çš„å†…å­˜é™åˆ¶ï¼Œè€Œè¢« OOM æ€æ­»çš„ã€‚</p>\n</li>\n<li>\n<p>ç¬¬äºŒï¼Œjava è¿›ç¨‹æ˜¯åœ¨å®¹å™¨å†…è¿è¡Œçš„ï¼Œè€Œå®¹å™¨å†…å­˜çš„ä½¿ç”¨é‡å’Œé™åˆ¶éƒ½æ˜¯ 512Mï¼ˆ524288kBï¼‰ã€‚ç›®å‰ä½¿ç”¨é‡å·²ç»è¾¾åˆ°äº†é™åˆ¶ï¼Œæ‰€ä»¥ä¼šå¯¼è‡´ OOMã€‚</p>\n</li>\n<li>\n<p>ç¬¬ä¸‰ï¼Œè¢«æ€æ­»çš„è¿›ç¨‹ï¼ŒPID ä¸º 27281ï¼Œè™šæ‹Ÿå†…å­˜ä¸º 4.3Gï¼ˆtotal-vm:4613208kBï¼‰ï¼ŒåŒ¿åå†…å­˜ä¸º 505Mï¼ˆanon-rss:517316kBï¼‰ï¼Œé¡µå†…å­˜ä¸º 19Mï¼ˆ20168kBï¼‰ã€‚æ¢å¥è¯è¯´ï¼ŒåŒ¿åå†…å­˜æ˜¯ä¸»è¦çš„å†…å­˜å ç”¨ã€‚è€Œä¸”ï¼ŒåŒ¿åå†…å­˜åŠ ä¸Šé¡µå†…å­˜ï¼Œæ€»å…±æ˜¯ 524Mï¼Œå·²ç»è¶…è¿‡äº†  512M çš„é™åˆ¶ã€‚</p>\n</li>\n</ul><p>ç»¼åˆè¿™å‡ ç‚¹ï¼Œå¯ä»¥çœ‹å‡ºï¼ŒTomcat å®¹å™¨çš„å†…å­˜ä¸»è¦ç”¨åœ¨äº†åŒ¿åå†…å­˜ä¸­ï¼Œè€ŒåŒ¿åå†…å­˜ï¼Œå…¶å®å°±æ˜¯ä¸»åŠ¨ç”³è¯·åˆ†é…çš„å †å†…å­˜ã€‚</p><p>ä¸è¿‡ï¼Œä¸ºä»€ä¹ˆ Tomcat ä¼šç”³è¯·è¿™ä¹ˆå¤šçš„å †å†…å­˜å‘¢ï¼Ÿè¦çŸ¥é“ï¼ŒTomcat æ˜¯åŸºäº Java å¼€å‘çš„ï¼Œæ‰€ä»¥åº”è¯¥ä¸éš¾æƒ³åˆ°ï¼Œè¿™å¾ˆå¯èƒ½æ˜¯ JVM å †å†…å­˜é…ç½®çš„é—®é¢˜ã€‚</p><p>æˆ‘ä»¬çŸ¥é“ï¼ŒJVM æ ¹æ®ç³»ç»Ÿçš„å†…å­˜æ€»é‡ï¼Œæ¥è‡ªåŠ¨ç®¡ç†å †å†…å­˜ï¼Œä¸æ˜ç¡®é…ç½®çš„è¯ï¼Œå †å†…å­˜çš„é»˜è®¤é™åˆ¶æ˜¯ç‰©ç†å†…å­˜çš„å››åˆ†ä¹‹ä¸€ã€‚ä¸è¿‡ï¼Œå‰é¢æˆ‘ä»¬å·²ç»é™åˆ¶äº†å®¹å™¨å†…å­˜ä¸º 512 Mï¼Œjava çš„å †å†…å­˜åˆ°åº•æ˜¯å¤šå°‘å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬ç»§ç»­åœ¨ç»ˆç«¯ä¸­ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œé‡æ–°å¯åŠ¨ tomcat å®¹å™¨ï¼Œå¹¶è°ƒç”¨ java å‘½ä»¤è¡Œæ¥æŸ¥çœ‹å †å†…å­˜å¤§å°ï¼š</p><pre><code># é‡æ–°å¯åŠ¨å®¹å™¨\n$ docker rm -f tomcat\n$ docker run --name tomcat --cpus 0.1 -m 512M -p 8080:8080 -itd feisky/tomcat:8\n\n# æŸ¥çœ‹å †å†…å­˜ï¼Œæ³¨æ„å•ä½æ˜¯å­—èŠ‚\n$ docker exec tomcat java -XX:+PrintFlagsFinal -version | grep HeapSize\n    uintx ErgoHeapSizeLimit                         = 0                                   {product}\n    uintx HeapSizePerGCThread                       = 87241520                            {product}\n    uintx InitialHeapSize                          := 132120576                           {product}\n    uintx LargePageHeapSizeThreshold                = 134217728                           {product}\n    uintx MaxHeapSize                              := 2092957696                          {product}\n</code></pre><p>ä½ å¯ä»¥çœ‹åˆ°ï¼Œåˆå§‹å †å†…å­˜çš„å¤§å°ï¼ˆInitialHeapSizeï¼‰æ˜¯ 126MBï¼Œè€Œæœ€å¤§å †å†…å­˜åˆ™æ˜¯ 1.95GBï¼Œè¿™å¯æ¯”å®¹å™¨é™åˆ¶çš„ 512 MB å¤§å¤šäº†ã€‚</p><p>ä¹‹æ‰€ä»¥ä¼šè¿™ä¹ˆå¤§ï¼Œå…¶å®æ˜¯å› ä¸ºï¼Œå®¹å™¨å†…éƒ¨çœ‹ä¸åˆ° Docker ä¸ºå®ƒè®¾ç½®çš„å†…å­˜é™åˆ¶ã€‚è™½ç„¶åœ¨å¯åŠ¨å®¹å™¨æ—¶ï¼Œæˆ‘ä»¬é€šè¿‡ -m 512M é€‰é¡¹ï¼Œç»™å®¹å™¨è®¾ç½®äº† 512M çš„å†…å­˜é™åˆ¶ã€‚ä½†å®é™…ä¸Šï¼Œä»å®¹å™¨å†…éƒ¨çœ‹åˆ°çš„é™åˆ¶ï¼Œå´å¹¶ä¸æ˜¯ 512Mã€‚</p><p>æˆ‘ä»¬åœ¨ç»ˆç«¯ä¸­ï¼Œç»§ç»­æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š</p><pre><code>$ docker exec tomcat free -m\n              total        used        free      shared  buff/cache   available\nMem:           7977         521        1941           0        5514        7148\nSwap:             0           0           0\n</code></pre><p>æœç„¶ï¼Œå®¹å™¨å†…éƒ¨çœ‹åˆ°çš„å†…å­˜ï¼Œä»æ˜¯ä¸»æœºå†…å­˜ã€‚</p><p>çŸ¥é“äº†é—®é¢˜æ ¹æºï¼Œè§£å†³æ–¹æ³•å°±å¾ˆç®€å•äº†ï¼Œç»™ JVM æ­£ç¡®é…ç½®å†…å­˜é™åˆ¶ä¸º 512M å°±å¯ä»¥äº†ã€‚</p><p>æ¯”å¦‚ï¼Œä½ å¯ä»¥æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œé€šè¿‡ç¯å¢ƒå˜é‡ JAVA_OPTS=â€™-Xmx512m -Xms512mâ€™ ï¼ŒæŠŠJVM çš„åˆå§‹å†…å­˜å’Œæœ€å¤§å†…å­˜éƒ½è®¾ä¸º 512MBï¼š</p><pre><code># åˆ é™¤é—®é¢˜å®¹å™¨\n$ docker rm -f tomcat\n# è¿è¡Œæ–°çš„å®¹å™¨\n$ docker run --name tomcat --cpus 0.1 -m 512M -e JAVA_OPTS='-Xmx512m -Xms512m' -p 8080:8080 -itd feisky/tomcat:8\n</code></pre><p>æ¥ç€ï¼Œå†åˆ‡æ¢åˆ°ç»ˆç«¯äºŒä¸­ï¼Œé‡æ–°åœ¨å¾ªç¯ä¸­æ‰§è¡Œ curl å‘½ä»¤ï¼ŒæŸ¥çœ‹ Tomcat çš„å“åº”ï¼š</p><pre><code>$ for ((i=0;i&lt;30;i++)); do curl localhost:8080; sleep 1; done\ncurl: (56) Recv failure: Connection reset by peer\ncurl: (56) Recv failure: Connection reset by peer\nHello, wolrd!\n\nHello, wolrd!\n\nHello, wolrd!\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œåˆšå¼€å§‹æ—¶ï¼Œæ˜¾ç¤ºçš„è¿˜æ˜¯ â€œConnection reset by peerâ€ é”™è¯¯ã€‚ä¸è¿‡ï¼Œç¨ç­‰ä¸€ä¼šå„¿åï¼Œå°±æ˜¯è¿ç»­çš„ â€œHello, wolrd!â€ è¾“å‡ºäº†ã€‚è¿™è¯´æ˜ï¼Œ Tomcat å·²ç»æ­£å¸¸å¯åŠ¨ã€‚</p><p>è¿™æ—¶ï¼Œæˆ‘ä»¬åˆ‡æ¢å›ç»ˆç«¯ä¸€ï¼Œæ‰§è¡Œ docker logs å‘½ä»¤ï¼ŒæŸ¥çœ‹ Tomcat å®¹å™¨çš„æ—¥å¿—ï¼š</p><pre><code>$ docker logs -f tomcat\n...\n18-Feb-2019 12:52:00.823 INFO [localhost-startStop-1] org.apache.catalina.startup.HostConfig.deployDirectory Deploying web application directory [/usr/local/tomcat/webapps/manager]\n18-Feb-2019 12:52:01.422 INFO [localhost-startStop-1] org.apache.catalina.startup.HostConfig.deployDirectory Deployment of web application directory [/usr/local/tomcat/webapps/manager] has finished in [598] ms\n18-Feb-2019 12:52:01.920 INFO [main] org.apache.coyote.AbstractProtocol.start Starting ProtocolHandler [&quot;http-nio-8080&quot;]\n18-Feb-2019 12:52:02.323 INFO [main] org.apache.coyote.AbstractProtocol.start Starting ProtocolHandler [&quot;ajp-nio-8009&quot;]\n18-Feb-2019 12:52:02.523 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 22798 ms\n\n</code></pre><p>è¿™æ¬¡ï¼ŒTomcat ä¹Ÿæ­£å¸¸å¯åŠ¨äº†ã€‚ä¸è¿‡ï¼Œæœ€åä¸€è¡Œçš„å¯åŠ¨æ—¶é—´ï¼Œä¼¼ä¹æ¯”è¾ƒåˆºçœ¼ã€‚å¯åŠ¨è¿‡ç¨‹ï¼Œå±…ç„¶éœ€è¦ 22 ç§’ï¼Œè¿™ä¹Ÿå¤ªæ…¢äº†å§ã€‚</p><p>ç”±äºè¿™ä¸ªæ—¶é—´æ˜¯èŠ±åœ¨å®¹å™¨å¯åŠ¨ä¸Šçš„ï¼Œè¦æ’æŸ¥è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å°±è¦é‡å¯å®¹å™¨ï¼Œå¹¶å€ŸåŠ©æ€§èƒ½åˆ†æå·¥å…·æ¥åˆ†æå®¹å™¨è¿›ç¨‹ã€‚è‡³äºå·¥å…·çš„é€‰ç”¨ï¼Œå›é¡¾ä¸€ä¸‹æˆ‘ä»¬å‰é¢çš„æ¡ˆä¾‹ï¼Œæˆ‘è§‰å¾—å¯ä»¥å…ˆç”¨ top çœ‹çœ‹ã€‚</p><p>æˆ‘ä»¬åˆ‡æ¢åˆ°ç»ˆç«¯äºŒä¸­ï¼Œè¿è¡Œ top å‘½ä»¤ï¼›ç„¶åå†åˆ‡æ¢åˆ°ç»ˆç«¯ä¸€ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œé‡å¯å®¹å™¨ï¼š</p><pre><code># åˆ é™¤æ—§å®¹å™¨\n$ docker rm -f tomcat\n# è¿è¡Œæ–°å®¹å™¨\n$ docker run --name tomcat --cpus 0.1 -m 512M -e JAVA_OPTS='-Xmx512m -Xms512m' -p 8080:8080 -itd feisky/tomcat:8\n</code></pre><p>æ¥ç€ï¼Œå†åˆ‡æ¢åˆ°ç»ˆç«¯äºŒï¼Œè§‚å¯Ÿ top çš„è¾“å‡ºï¼š</p><pre><code>$ top\ntop - 12:57:18 up 2 days,  5:50,  2 users,  load average: 0.00, 0.02, 0.00\nTasks: 131 total,   1 running,  74 sleeping,   0 stopped,   0 zombie\n%Cpu0  :  3.0 us,  0.3 sy,  0.0 ni, 96.6 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\n%Cpu1  :  5.7 us,  0.3 sy,  0.0 ni, 94.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\nKiB Mem :  8169304 total,  2465984 free,   500812 used,  5202508 buff/cache\nKiB Swap:        0 total,        0 free,        0 used.  7353652 avail Mem\n\n  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND\n29457 root      20   0 2791736  73704  19164 S  10.0  0.9   0:01.61 java                         27349 root      20   0 1121372  96760  39340 S   0.3  1.2   4:20.82 dockerd\n27376 root      20   0 1031760  43768  21680 S   0.3  0.5   2:44.47 docker-containe              29430 root      20   0    7376   3604   3128 S   0.3  0.0   0:00.01 docker-containe\n    1 root      20   0   78132   9332   6744 S   0.0  0.1   0:16.12 systemd\n</code></pre><p>ä» top çš„è¾“å‡ºï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œ</p><ul>\n<li>\n<p>ä»ç³»ç»Ÿæ•´ä½“æ¥çœ‹ï¼Œä¸¤ä¸ª CPU çš„ä½¿ç”¨ç‡åˆ†åˆ«æ˜¯ 3% å’Œ 5.7% ï¼Œéƒ½ä¸ç®—é«˜ï¼Œå¤§éƒ¨åˆ†è¿˜æ˜¯ç©ºé—²çš„ï¼›å¯ç”¨å†…å­˜è¿˜æœ‰ 7GBï¼ˆ7353652 avail Memï¼‰ï¼Œä¹Ÿéå¸¸å……è¶³ã€‚</p>\n</li>\n<li>\n<p>å…·ä½“åˆ°è¿›ç¨‹ä¸Šï¼Œjava è¿›ç¨‹çš„ CPU ä½¿ç”¨ç‡ä¸º 10%ï¼Œå†…å­˜ä½¿ç”¨ 0.9%ï¼Œå…¶ä»–è¿›ç¨‹å°±éƒ½å¾ˆä½äº†ã€‚</p>\n</li>\n</ul><p>è¿™äº›æŒ‡æ ‡éƒ½ä¸ç®—é«˜ï¼Œçœ‹èµ·æ¥éƒ½æ²¡å•¥é—®é¢˜ã€‚ä¸è¿‡ï¼Œäº‹å®ç©¶ç«Ÿå¦‚ä½•å‘¢ï¼Ÿæˆ‘ä»¬è¿˜å¾—ç»§ç»­æ‰¾ä¸‹å»ã€‚ç”±äº java è¿›ç¨‹çš„ CPU ä½¿ç”¨ç‡æœ€é«˜ï¼Œæ‰€ä»¥è¦æŠŠå®ƒå½“æˆé‡ç‚¹ï¼Œç»§ç»­åˆ†æå…¶æ€§èƒ½æƒ…å†µã€‚</p><p>è¯´åˆ°è¿›ç¨‹çš„æ€§èƒ½åˆ†æå·¥å…·ï¼Œä½ ä¸€å®šä¹Ÿæƒ³èµ·äº† pidstatã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±ç”¨ pidstat  å†æ¥åˆ†æä¸€ä¸‹ã€‚æˆ‘ä»¬å›åˆ°ç»ˆç«¯ä¸€ä¸­ï¼Œæ‰§è¡Œ pidstat å‘½ä»¤ï¼š</p><pre><code># -tè¡¨ç¤ºæ˜¾ç¤ºçº¿ç¨‹ï¼Œ-pæŒ‡å®šè¿›ç¨‹å·\n$ pidstat -t -p 29457 1\n12:59:59      UID      TGID       TID    %usr %system  %guest   %wait    %CPU   CPU  Command\n13:00:00        0     29457         -    0.00    0.00    0.00    0.00    0.00     0  java\n13:00:00        0         -     29457    0.00    0.00    0.00    0.00    0.00     0  |__java\n13:00:00        0         -     29458    0.00    0.00    0.00    0.00    0.00     1  |__java\n...\n13:00:00        0         -     29491    0.00    0.00    0.00    0.00    0.00     0  |__java\n</code></pre><p>ç»“æœä¸­ï¼Œå„ç§CPUä½¿ç”¨ç‡å…¨æ˜¯0ï¼Œçœ‹èµ·æ¥ä¸å¯¹å‘€ã€‚å†æƒ³æƒ³ï¼Œæˆ‘ä»¬æœ‰æ²¡æœ‰æ¼æ‰ä»€ä¹ˆçº¿ç´¢å‘¢ï¼Ÿå¯¹äº†ï¼Œè¿™æ—¶å€™å®¹å™¨å¯åŠ¨å·²ç»ç»“æŸäº†ï¼Œåœ¨æ²¡æœ‰å®¢æˆ·ç«¯è¯·æ±‚çš„æƒ…å†µä¸‹ï¼ŒTomcat æœ¬èº«å•¥ä¹Ÿä¸ç”¨åšï¼ŒCPU ä½¿ç”¨ç‡å½“ç„¶æ˜¯ 0ã€‚</p><p>ä¸ºäº†åˆ†æå¯åŠ¨è¿‡ç¨‹ä¸­çš„é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦å†æ¬¡é‡å¯å®¹å™¨ã€‚ç»§ç»­åœ¨ç»ˆç«¯ä¸€ï¼ŒæŒ‰ä¸‹ Ctrl+C åœæ­¢ pidstat å‘½ä»¤ï¼›ç„¶åæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œé‡å¯å®¹å™¨ã€‚æˆåŠŸé‡å¯åï¼Œæ‹¿åˆ°æ–°çš„ PIDï¼Œå†é‡æ–°è¿è¡Œ pidstat å‘½ä»¤ï¼š</p><pre><code># åˆ é™¤æ—§å®¹å™¨\n$ docker rm -f tomcat\n# è¿è¡Œæ–°å®¹å™¨\n$ docker run --name tomcat --cpus 0.1 -m 512M -e JAVA_OPTS='-Xmx512m -Xms512m' -p 8080:8080 -itd feisky/tomcat:8\n# æŸ¥è¯¢æ–°å®¹å™¨ä¸­è¿›ç¨‹çš„Pid\n$ PID=$(docker inspect tomcat -f '{{.State.Pid}}')\n# æ‰§è¡Œ pidstat\n$ pidstat -t -p $PID 1\n12:59:28      UID      TGID       TID    %usr %system  %guest   %wait    %CPU   CPU  Command\n12:59:29        0     29850         -   10.00    0.00    0.00    0.00   10.00     0  java\n12:59:29        0         -     29850    0.00    0.00    0.00    0.00    0.00     0  |__java\n12:59:29        0         -     29897    5.00    1.00    0.00   86.00    6.00     1  |__java\n...\n12:59:29        0         -     29905    3.00    0.00    0.00   97.00    3.00     0  |__java\n12:59:29        0         -     29906    2.00    0.00    0.00   49.00    2.00     1  |__java\n12:59:29        0         -     29908    0.00    0.00    0.00   45.00    0.00     0  |__java\n</code></pre><p>ä»”ç»†è§‚å¯Ÿè¿™æ¬¡çš„è¾“å‡ºï¼Œä½ ä¼šå‘ç°ï¼Œè™½ç„¶ CPU ä½¿ç”¨ç‡ï¼ˆ%CPUï¼‰å¾ˆä½ï¼Œä½†ç­‰å¾…è¿è¡Œçš„ä½¿ç”¨ç‡ï¼ˆ%waitï¼‰å´éå¸¸é«˜ï¼Œæœ€é«˜ç”šè‡³å·²ç»è¾¾åˆ°äº† 97%ã€‚è¿™è¯´æ˜ï¼Œè¿™äº›çº¿ç¨‹å¤§éƒ¨åˆ†æ—¶é—´éƒ½åœ¨ç­‰å¾…è°ƒåº¦ï¼Œè€Œä¸æ˜¯çœŸæ­£çš„è¿è¡Œã€‚</p><blockquote>\n<p>æ³¨ï¼šå¦‚æœä½ çœ‹ä¸åˆ° %wait æŒ‡æ ‡ï¼Œè¯·å…ˆå‡çº§ sysstat åå†è¯•è¯•ã€‚</p>\n</blockquote><p>ä¸ºä»€ä¹ˆCPU ä½¿ç”¨ç‡è¿™ä¹ˆä½ï¼Œçº¿ç¨‹çš„å¤§éƒ¨åˆ†æ—¶é—´è¿˜è¦ç­‰å¾… CPU å‘¢ï¼Ÿç”±äºè¿™ä¸ªç°è±¡å›  Docker è€Œèµ·ï¼Œè‡ªç„¶çš„ï¼Œä½ åº”è¯¥æƒ³åˆ°ï¼Œè¿™å¯èƒ½æ˜¯å› ä¸º Docker ä¸ºå®¹å™¨è®¾ç½®äº†é™åˆ¶ã€‚</p><p>å†å›é¡¾ä¸€ä¸‹ï¼Œæ¡ˆä¾‹å¼€å§‹æ—¶å®¹å™¨çš„å¯åŠ¨å‘½ä»¤ã€‚æˆ‘ä»¬ç”¨ --cpus 0.1 ï¼Œä¸ºå®¹å™¨è®¾ç½®äº† 0.1 ä¸ª CPU çš„é™åˆ¶ï¼Œä¹Ÿå°±æ˜¯ 10% çš„ CPUã€‚è¿™é‡Œä¹Ÿå°±å¯ä»¥è§£é‡Šï¼Œä¸ºä»€ä¹ˆ java è¿›ç¨‹åªæœ‰ 10% çš„ CPU ä½¿ç”¨ç‡ï¼Œä¹Ÿä¼šå¤§éƒ¨åˆ†æ—¶é—´éƒ½åœ¨ç­‰å¾…äº†ã€‚</p><p>æ‰¾å‡ºåŸå› ï¼Œæœ€åçš„ä¼˜åŒ–ä¹Ÿå°±ç®€å•äº†ï¼ŒæŠŠ CPU é™åˆ¶å¢å¤§å°±å¯ä»¥äº†ã€‚æ¯”å¦‚ï¼Œä½ å¯ä»¥æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œå°† CPU é™åˆ¶å¢å¤§åˆ° 1 ï¼›ç„¶åå†é‡å¯ï¼Œå¹¶è§‚å¯Ÿå¯åŠ¨æ—¥å¿—ï¼š</p><pre><code># åˆ é™¤æ—§å®¹å™¨\n$ docker rm -f tomcat\n# è¿è¡Œæ–°å®¹å™¨\n$ docker run --name tomcat --cpus 1 -m 512M -e JAVA_OPTS='-Xmx512m -Xms512m' -p 8080:8080 -itd feisky/tomcat:8\n# æŸ¥çœ‹å®¹å™¨æ—¥å¿—\n$ docker logs -f tomcat\n...\n18-Feb-2019 12:54:02.139 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 2001 ms\n</code></pre><p>ç°åœ¨å¯ä»¥çœ‹åˆ°ï¼ŒTomcat çš„å¯åŠ¨è¿‡ç¨‹ï¼Œåªéœ€è¦ 2 ç§’å°±å®Œæˆäº†ï¼Œæœç„¶æ¯”å‰é¢çš„ 22 ç§’å¿«å¤šäº†ã€‚</p><p>è™½ç„¶æˆ‘ä»¬é€šè¿‡å¢å¤§ CPU çš„é™åˆ¶ï¼Œè§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚ä¸è¿‡å†ç¢°åˆ°ç±»ä¼¼é—®é¢˜ï¼Œä½ å¯èƒ½ä¼šè§‰å¾—è¿™ç§æ–¹æ³•å¤ªéº»çƒ¦äº†ã€‚å› ä¸ºè¦è®¾ç½®å®¹å™¨çš„èµ„æºé™åˆ¶ï¼Œè¿˜éœ€è¦æˆ‘ä»¬é¢„å…ˆè¯„ä¼°åº”ç”¨ç¨‹åºçš„æ€§èƒ½ã€‚æ˜¾ç„¶è¿˜æœ‰æ›´ç®€å•çš„æ–¹æ³•ï¼Œæ¯”å¦‚è¯´ç›´æ¥å»æ‰é™åˆ¶ï¼Œè®©å®¹å™¨è·‘å°±æ˜¯äº†ã€‚</p><p>ä¸è¿‡ï¼Œè¿™ç§ç®€å•æ–¹æ³•ï¼Œå´å¾ˆå¯èƒ½å¸¦æ¥æ›´ä¸¥é‡çš„é—®é¢˜ã€‚æ²¡æœ‰èµ„æºé™åˆ¶ï¼Œå°±æ„å‘³ç€å®¹å™¨å¯ä»¥å ç”¨æ•´ä¸ªç³»ç»Ÿçš„èµ„æºã€‚è¿™æ ·ï¼Œä¸€æ—¦ä»»ä½•åº”ç”¨ç¨‹åºå‘ç”Ÿå¼‚å¸¸ï¼Œéƒ½æœ‰å¯èƒ½æ‹–å®æ•´å°æœºå™¨ã€‚</p><p>å®é™…ä¸Šï¼Œè¿™ä¹Ÿæ˜¯åœ¨å„å¤§å®¹å™¨å¹³å°ä¸Šæœ€å¸¸è§çš„ä¸€ä¸ªé—®é¢˜ã€‚ä¸€å¼€å§‹å›¾çœäº‹ä¸è®¾é™ï¼Œä½†å½“å®¹å™¨æ•°é‡å¢é•¿ä¸Šæ¥çš„æ—¶å€™ï¼Œå°±ä¼šç»å¸¸å‡ºç°å„ç§å¼‚å¸¸é—®é¢˜ã€‚æœ€ç»ˆæŸ¥ä¸‹æ¥ï¼Œå¯èƒ½å°±æ˜¯å› ä¸ºæŸä¸ªåº”ç”¨èµ„æºä½¿ç”¨è¿‡é«˜ï¼Œå¯¼è‡´æ•´å°æœºå™¨çŸ­æœŸå†…æ— æ³•å“åº”ã€‚åªæœ‰è®¾ç½®äº†èµ„æºé™åˆ¶ï¼Œæ‰èƒ½ç¡®ä¿æœç»ç±»ä¼¼é—®é¢˜ã€‚</p><h2>å°ç»“</h2><p>ä»Šå¤©ï¼Œæˆ‘å¸¦ä½ å­¦ä¹ äº†ï¼Œå¦‚ä½•åˆ†æå®¹å™¨åŒ–ååº”ç”¨ç¨‹åºæ€§èƒ½ä¸‹é™çš„é—®é¢˜ã€‚</p><p>å¦‚æœä½ åœ¨ Docker å®¹å™¨ä¸­è¿è¡Œ Java åº”ç”¨ï¼Œä¸€å®šè¦ç¡®ä¿ï¼Œåœ¨è®¾ç½®å®¹å™¨èµ„æºé™åˆ¶çš„åŒæ—¶ï¼Œé…ç½®å¥½ JVM çš„èµ„æºé€‰é¡¹ï¼ˆæ¯”å¦‚å †å†…å­˜ç­‰ï¼‰ã€‚å½“ç„¶ï¼Œå¦‚æœä½ å¯ä»¥å‡çº§ Java ç‰ˆæœ¬ï¼Œé‚£ä¹ˆå‡çº§åˆ° Java 10 ï¼Œå°±å¯ä»¥è‡ªåŠ¨è§£å†³ç±»ä¼¼é—®é¢˜äº†ã€‚</p><p>å½“ç¢°åˆ°å®¹å™¨åŒ–çš„åº”ç”¨ç¨‹åºæ€§èƒ½æ—¶ï¼Œä½ ä¾ç„¶å¯ä»¥ä½¿ç”¨ï¼Œæˆ‘ä»¬å‰é¢è®²è¿‡çš„å„ç§æ–¹æ³•æ¥åˆ†æå’Œå®šä½ã€‚åªä¸è¿‡è¦è®°å¾—ï¼Œå®¹å™¨åŒ–åçš„æ€§èƒ½åˆ†æï¼Œè·Ÿå‰é¢å†…å®¹ç¨å¾®æœ‰äº›åŒºåˆ«ï¼Œæ¯”å¦‚ä¸‹é¢è¿™å‡ ç‚¹ã€‚</p><ul>\n<li>\n<p>å®¹å™¨æœ¬èº«é€šè¿‡ cgroups è¿›è¡Œèµ„æºéš”ç¦»ï¼Œæ‰€ä»¥ï¼Œåœ¨åˆ†ææ—¶è¦è€ƒè™‘ cgroups å¯¹åº”ç”¨ç¨‹åºçš„å½±å“ã€‚</p>\n</li>\n<li>\n<p>å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œåè®®æ ˆç­‰è·Ÿä¸»æœºéš”ç¦»ã€‚è™½ç„¶åœ¨å®¹å™¨å¤–é¢ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ†æå®¹å™¨çš„è¡Œä¸ºï¼Œä¸è¿‡æœ‰æ—¶å€™ï¼Œè¿›å…¥å®¹å™¨çš„å‘½åç©ºé—´å†…éƒ¨ï¼Œå¯èƒ½æ›´ä¸ºæ–¹ä¾¿ã€‚</p>\n</li>\n<li>\n<p>å®¹å™¨çš„è¿è¡Œå¯èƒ½è¿˜ä¼šä¾èµ–äºå…¶ä»–ç»„ä»¶ï¼Œæ¯”å¦‚å„ç§ç½‘ç»œæ’ä»¶ï¼ˆæ¯”å¦‚ CNIï¼‰ã€å­˜å‚¨æ’ä»¶ï¼ˆæ¯”å¦‚ CSIï¼‰ã€è®¾å¤‡æ’ä»¶ï¼ˆæ¯”å¦‚ GPUï¼‰ç­‰ï¼Œè®©å®¹å™¨çš„æ€§èƒ½åˆ†ææ›´åŠ å¤æ‚ã€‚å¦‚æœä½ éœ€è¦åˆ†æå®¹å™¨æ€§èƒ½ï¼Œåˆ«å¿˜äº†è€ƒè™‘å®ƒä»¬å¯¹æ€§èƒ½çš„å½±å“ã€‚</p>\n</li>\n</ul><h2>æ€è€ƒ</h2><p>æœ€åï¼Œæˆ‘æƒ³é‚€è¯·ä½ ä¸€èµ·æ¥èŠèŠï¼Œä½ ç¢°åˆ°è¿‡çš„å®¹å™¨æ€§èƒ½é—®é¢˜ã€‚ä½ æ˜¯æ€ä¹ˆåˆ†æå®ƒä»¬çš„ï¼Ÿåˆæ˜¯æ€ä¹ˆè§£å†³æ ¹æºé—®é¢˜çš„ï¼Ÿä½ å¯ä»¥ç»“åˆæˆ‘çš„è®²è§£ï¼Œæ€»ç»“è‡ªå·±çš„æ€è·¯ã€‚</p><p>æ¬¢è¿åœ¨ç•™è¨€åŒºå’Œæˆ‘è®¨è®ºï¼Œä¹Ÿæ¬¢è¿æŠŠè¿™ç¯‡æ–‡ç« åˆ†äº«ç»™ä½ çš„åŒäº‹ã€æœ‹å‹ã€‚æˆ‘ä»¬ä¸€èµ·åœ¨å®æˆ˜ä¸­æ¼”ç»ƒï¼Œåœ¨äº¤æµä¸­è¿›æ­¥ã€‚</p><p></p>","neighbors":{"left":{"article_title":"45 | ç­”ç–‘ï¼ˆäº”ï¼‰ï¼šç½‘ç»œæ”¶å‘è¿‡ç¨‹ä¸­ï¼Œç¼“å†²åŒºä½ç½®åœ¨å“ªé‡Œï¼Ÿ","id":84529},"right":{"article_title":"47 | æ¡ˆä¾‹ç¯‡ï¼šæœåŠ¡å™¨æ€»æ˜¯æ—¶ä¸æ—¶ä¸¢åŒ…ï¼Œæˆ‘è¯¥æ€ä¹ˆåŠï¼Ÿï¼ˆä¸Šï¼‰","id":85201}},"comments":[{"had_liked":false,"id":74615,"user_name":"Adam","can_delete":false,"product_type":"c1","uid":1305633,"ip_address":"","ucode":"338BA720880E4F","user_header":"https://static001.geekbang.org/account/avatar/00/13/ec/21/b0fe1bfd.jpg","comment_is_top":false,"comment_ctime":1552267796,"is_pvip":false,"replies":[{"id":"27335","content":"å—¯å—¯ï¼Œæ­£è§£ï¼","user_name":"ä½œè€…å›å¤","comment_id":74615,"uid":"1001282","ip_address":"","utype":1,"ctime":1552349663,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":2,"race_medal":0,"score":"100336515604","product_id":100020901,"comment_content":"è¿™ä¸ªé—®é¢˜åº”è¯¥æ˜¯&#47;proc æ–‡ä»¶ç³»ç»Ÿå¹¶ä¸çŸ¥é“ç”¨æˆ·é€šè¿‡ Cgroups ç»™è¿™ä¸ªå®¹å™¨åšäº†é™åˆ¶å¯¼è‡´çš„ã€‚<br>","like_count":24,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":442620,"discussion_content":"å—¯å—¯ï¼Œæ­£è§£ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1552349663,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1211178,"avatar":"https://static001.geekbang.org/account/avatar/00/12/7b/2a/7d8b5943.jpg","nickname":"LH","note":"","ucode":"819B9B2409E834","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":291976,"discussion_content":"å¯ä»¥é€šè¿‡é…ç½®rootfsè®©å®¹å™¨å†…çœ‹åˆ°çš„èµ„æºå’Œcgroupé™åˆ¶çš„ä¸€æ ·å—","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595037969,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":135329,"user_name":"é¥­ç²’","can_delete":false,"product_type":"c1","uid":1153455,"ip_address":"","ucode":"4C3220B0D43997","user_header":"https://static001.geekbang.org/account/avatar/00/11/99/af/d29273e2.jpg","comment_is_top":false,"comment_ctime":1569128433,"is_pvip":false,"discussion_count":4,"race_medal":0,"score":"40223834097","product_id":100020901,"comment_content":"æœ‰ä¸ªç–‘é—®ï¼Œå¢åŠ çš„ JVM å †å†…å­˜é™åˆ¶ä¹Ÿæ˜¯ 512M å’Œ å®¹å™¨å†…å­˜é™åˆ¶ 512M çš„ä¸€æ ·ï¼Œé‚£è¿˜æœ‰éå †å†…å­˜å’Œå…¶ä»–çš„è¿è¡Œå†…å­˜å‘¢ï¼Œè¿™ä¸ªå¯èƒ½è¿˜ä¼šæœ‰ OOM å§ï¼Ÿ","like_count":10,"discussions":[{"author":{"id":1651384,"avatar":"https://static001.geekbang.org/account/avatar/00/19/32/b8/6e58cd47.jpg","nickname":"é£äº‘å†³2014","note":"","ucode":"0F406A76EBF30C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":300051,"discussion_content":"æœ‰å¯èƒ½è¿˜ä¼šæœ‰ OOM","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597918902,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1044266,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ef/2a/e9c5c163.jpg","nickname":"å°æ±Ÿå“¥å“¥","note":"","ucode":"E5B3725FC9E366","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":228775,"discussion_content":"åŒé—® é‚£ä¹ˆå¯¹å®¹å™¨çš„èµ„æºé™åˆ¶å’Œtomcatå †å†…å­˜çš„é™åˆ¶éµå¾ªä»€ä¹ˆæ¯”ä¾‹å¥½å‘¢ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586575994,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1651384,"avatar":"https://static001.geekbang.org/account/avatar/00/19/32/b8/6e58cd47.jpg","nickname":"é£äº‘å†³2014","note":"","ucode":"0F406A76EBF30C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1044266,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ef/2a/e9c5c163.jpg","nickname":"å°æ±Ÿå“¥å“¥","note":"","ucode":"E5B3725FC9E366","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":300053,"discussion_content":"å†…å­˜æŒ‰ç»™å®¹å™¨çš„æœ€å¤§æ¯”ä¾‹è®¾ç½® ï¼Œæ¯”å¦‚-XX:InitialRAMPercentage=60.0 -XX:MaxRAMPercentage=80.0","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597919165,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":228775,"ip_address":""},"score":300053,"extra":""},{"author":{"id":1200299,"avatar":"https://static001.geekbang.org/account/avatar/00/12/50/ab/6584e520.jpg","nickname":"é™ˆé¡ºå‰","note":"","ucode":"315732AEA35CD1","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1044266,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ef/2a/e9c5c163.jpg","nickname":"å°æ±Ÿå“¥å“¥","note":"","ucode":"E5B3725FC9E366","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":353102,"discussion_content":"è¿™ä¸ªè¦çœ‹ä½ çš„åº”ç”¨ç±»å‹ï¼Œæ¯”å¦‚åƒ es è¿™ç§ç‹‚åƒæ“ä½œç³»ç»Ÿ buffer çš„ï¼ˆnode èŠ‚ç‚¹ï¼‰ï¼Œå°±éœ€è¦ç»™å®ƒæ›´å®½æ¾çš„é™åˆ¶ï¼Œæ¯”å¦‚å † 4Gï¼Œé‚£ä¹ˆå®¹å™¨çš„é™åˆ¶å°±åº”è¯¥æ˜¯ 8Gï¼Œå¦å¤–çš„ 4G å°±æ˜¯å †å¤–çš„ï¼›å¦‚æœä½ çš„åº”ç”¨åªæ˜¯ä½¿ç”¨å †å†…å­˜ï¼Œé‚£ä¹ˆ 5G é™åˆ¶å°±å¯ä»¥äº†ã€‚","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1615005480,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":228775,"ip_address":""},"score":353102,"extra":""}]}]},{"had_liked":false,"id":101960,"user_name":"Goal","can_delete":false,"product_type":"c1","uid":1307012,"ip_address":"","ucode":"C337CD4C7E07B0","user_header":"https://static001.geekbang.org/account/avatar/00/13/f1/84/7d21bd9e.jpg","comment_is_top":false,"comment_ctime":1560074368,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"23034910848","product_id":100020901,"comment_content":"æ‰“å¡ï¼Œå­¦ä¹ linuxæ€§èƒ½è°ƒä¼˜ï¼Œé¡ºå¸¦å­¦ä¹ dockerçš„åŸºç¡€çŸ¥è¯†ï¼Œè¿™æ¡ˆä¾‹å¤ªèµäº†","like_count":6},{"had_liked":false,"id":75439,"user_name":"è…¾è¾¾","can_delete":false,"product_type":"c1","uid":1079876,"ip_address":"","ucode":"72F9CFBA44FDEE","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTL9hlAIKQ1sGDu16oWLOHyCSicr18XibygQSMLMjuDvKk73deDlH9aMphFsj41WYJh121aniaqBLiaMNg/132","comment_is_top":false,"comment_ctime":1552398085,"is_pvip":false,"replies":[{"id":"28038","content":"Javaçš„é—®é¢˜è¯·å‚è€ƒhttps:&#47;&#47;github.com&#47;jvm-profiling-tools&#47;perf-map-agent","user_name":"ä½œè€…å›å¤","comment_id":75439,"uid":"1001282","ip_address":"","utype":1,"ctime":1552748710,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":1,"race_medal":0,"score":"23027234565","product_id":100020901,"comment_content":"è¿™é‡Œçœ‹javaè¿›ç¨‹cpuçš„æ—¶å€™ï¼Œä½¿ç”¨äº†ä¹‹å‰å­¦åˆ°çš„perf recordæ–¹æ³•ï¼Œä½†çœ‹dockerå†…éƒ¨å‡½æ•°åç§°çš„æ—¶å€™ï¼Œè¿˜æ˜¯é‡åˆ°äº†é—®é¢˜ï¼Œæˆ‘çš„æ­¥éª¤å¦‚ä¸‹ï¼š<br>$ mkdir dockermap<br>$ PID=$(docker inspect --format {{.State.Pid}} tomcat)<br>$ sudo bindfs &#47;proc&#47;$PID&#47;root dockermap<br>$ sudo perf record -g -p $PID<br>$ sudo perf report --symfs dockermap<br><br>-   99.95%     0.00%  java     libjvm.so           [.] 0x00000000008bf292                                                             <br>   - 0x8bf292                                                                                                                         <br>      - 67.44% 0xa79ff1                                                                                                               <br>           0xa79af6                                                                                                                   <br>           0xa78677                                                                                                                   <br>           0xa7afc7                                                                                                                   <br>           0xa75d62                                                                                                                   <br>         + 0x8e6853 ","like_count":5,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":442894,"discussion_content":"Javaçš„é—®é¢˜è¯·å‚è€ƒhttps://github.com/jvm-profiling-tools/perf-map-agent","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1552748710,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":75239,"user_name":"Tony","can_delete":false,"product_type":"c1","uid":1447315,"ip_address":"","ucode":"5F14505DFCDE6F","user_header":"https://static001.geekbang.org/account/avatar/00/16/15/93/cc3a1320.jpg","comment_is_top":false,"comment_ctime":1552369164,"is_pvip":false,"replies":[{"id":"27484","content":"cold startè¯é¢˜å¤ªå¤§äº†ï¼Œæ¶‰åŠçš„ä¸æ­¢æ˜¯å•æœºå†…çš„é—®é¢˜ã€‚ä½ å¦‚æœæœ‰å…·ä½“çš„é—®é¢˜ï¼Œå¯ä»¥åˆ†äº«å‡ºæ¥ï¼Œå¤§å®¶ä¸€èµ·è®¨è®º","user_name":"ä½œè€…å›å¤","comment_id":75239,"uid":"1001282","ip_address":"","utype":1,"ctime":1552399567,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":1,"race_medal":0,"score":"14437271052","product_id":100020901,"comment_content":"è¿™ä¸ªä¾‹å­å¯¹ç¨å¾®æœ‰ç‚¹dockerå’Œjvmçš„åŸºç¡€çš„äººè¿˜æ˜¯å¤ªç®€å•äº†ã€‚åº”è¯¥ä¸Šç‚¹serverlesså†·å¯åŠ¨çš„åˆ†æã€‚cold startæ˜¯FaaSä¸€ä¸ªå¾ˆå¤§çš„é—®é¢˜ï¼Œä¸çŸ¥é“ä½ æ€ä¹ˆç”¨å‰é¢çš„çŸ¥è¯†åˆ†æä¸€ä¸‹ï¼Ÿè°¢è°¢","like_count":4,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":442833,"discussion_content":"cold startè¯é¢˜å¤ªå¤§äº†ï¼Œæ¶‰åŠçš„ä¸æ­¢æ˜¯å•æœºå†…çš„é—®é¢˜ã€‚ä½ å¦‚æœæœ‰å…·ä½“çš„é—®é¢˜ï¼Œå¯ä»¥åˆ†äº«å‡ºæ¥ï¼Œå¤§å®¶ä¸€èµ·è®¨è®º","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1552399567,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":152990,"user_name":"88591","can_delete":false,"product_type":"c1","uid":1254656,"ip_address":"","ucode":"04CE3E46455185","user_header":"https://static001.geekbang.org/account/avatar/00/13/25/00/3afbab43.jpg","comment_is_top":false,"comment_ctime":1574134698,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10164069290","product_id":100020901,"comment_content":"vm å¼€å¯äº†swap å¯¼è‡´ docker å®¹å™¨çš„å†…å­˜ä½¿ç”¨è¶…è¿‡512måè¿˜ç»§ç»­æ‰§è¡Œï¼Œæ²¡æœ‰è¢«oom-killã€‚<br>","like_count":2},{"had_liked":false,"id":74950,"user_name":"xfan","can_delete":false,"product_type":"c1","uid":1315147,"ip_address":"","ucode":"48ED8D498D7F56","user_header":"https://static001.geekbang.org/account/avatar/00/14/11/4b/fa64f061.jpg","comment_is_top":false,"comment_ctime":1552320296,"is_pvip":false,"replies":[{"id":"27341","content":"å—¯å—¯ æ˜¯è¿™æ ·çš„","user_name":"ä½œè€…å›å¤","comment_id":74950,"uid":"1001282","ip_address":"","utype":1,"ctime":1552350148,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":1,"race_medal":0,"score":"10142254888","product_id":100020901,"comment_content":"å’Œè™šæ‹Ÿæœºå†…å­˜è®¾ç½®ä¹Ÿæœ‰å…³ç³»ï¼Œè€å¸ˆçš„æ˜¯8G 30%å°±å¾ˆå¤§ï¼Œæˆ‘çš„2G æ‰€ä»¥ä¸å¤§ï¼Œä¹Ÿä¸ä¼šå¼•èµ·OOMï¼Œå½“æˆ‘è°ƒæˆ8G çš„æ—¶å€™å°±å‡ºç°äº†å’Œè€å¸ˆä¸€æ ·çš„ç°è±¡äº†OOM","like_count":2,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":442753,"discussion_content":"å—¯å—¯ æ˜¯è¿™æ ·çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1552350148,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":74718,"user_name":"ä¸”å¬é£åŸ","can_delete":false,"product_type":"c1","uid":1024045,"ip_address":"","ucode":"BB49580519D117","user_header":"https://static001.geekbang.org/account/avatar/00/0f/a0/2d/2fee2d83.jpg","comment_is_top":false,"comment_ctime":1552286331,"is_pvip":false,"replies":[{"id":"27339","content":"ä¸»æœºå†…å­˜å¤šå¤§ï¼Ÿé‡å¯åå¯ä»¥çœ‹çœ‹ç³»ç»Ÿæ—¥å¿—ï¼Œä¸€èˆ¬ä¼šæœ‰ä¸Šæ¬¡ä¸ºå•¥æ­»æœºçš„çº¿ç´¢","user_name":"ä½œè€…å›å¤","comment_id":74718,"uid":"1001282","ip_address":"","utype":1,"ctime":1552349991,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":1,"race_medal":0,"score":"10142220923","product_id":100020901,"comment_content":"å¯åŠ¨å®¹å™¨å‡ åˆ†é’Ÿåï¼Œç›´æ¥æŠŠå®¿ä¸»æœºè·‘æ­»äº†ï¼Œæ²¡æ³•ç»§ç»­è¿›è¡Œï¼Œè¿™æ˜¯æ€ä¹ˆå›äº‹å‘¢ï¼Ÿ","like_count":3,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":442660,"discussion_content":"ä¸»æœºå†…å­˜å¤šå¤§ï¼Ÿé‡å¯åå¯ä»¥çœ‹çœ‹ç³»ç»Ÿæ—¥å¿—ï¼Œä¸€èˆ¬ä¼šæœ‰ä¸Šæ¬¡ä¸ºå•¥æ­»æœºçš„çº¿ç´¢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1552349991,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":74714,"user_name":"æˆ‘æ¥ä¹Ÿ","can_delete":false,"product_type":"c1","uid":1205253,"ip_address":"","ucode":"773D6104F56767","user_header":"https://static001.geekbang.org/account/avatar/00/12/64/05/6989dce6.jpg","comment_is_top":false,"comment_ctime":1552285408,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5847252704","product_id":100020901,"comment_content":"[D46æ‰“å¡]<br>çœ‹æ¥çœŸæ˜¯æœ‰å¿…è¦å¯¹å®¹å™¨åšèµ„æºé™åˆ¶.<br>åˆšå¼€å§‹åˆ†é…çš„èµ„æºå¯ä»¥ä¸è¦è®¡ç®—å¾—é‚£ä¹ˆç²¾å‡†,åªè¦åˆ«æŠŠæœºå™¨æ‹–å®å³å¯.<br><br>å®æˆ˜ç¯‡è¿˜æ˜¯å¾ˆæœ‰æ„æ€,æ ¹æ®ç—‡çŠ¶å»æ‰¾å„ç§ç¨‹åºåŠç³»ç»Ÿæ—¥å¿—å’Œå„é¡¹é…ç½®å‚æ•°.<br><br>å¦‚æœä¸åšç‰¹æ®Šå¤„ç†,å®¹å™¨å†…éƒ¨çœ‹åˆ°çš„ç³»ç»Ÿcpu&#47;memoryé…ç½®ç¡®å®éƒ½æ˜¯ä¸»æœºçš„.ç¨‹åºé»˜è®¤æ ¹æ®è¿™ä¸ªæ¥åšç­–ç•¥è°ƒæ•´ç¡®å®ä¼šå—åˆ°è¯¯å¯¼.<br><br>ç›®å‰å·¥ä½œä¸­è¿˜æ²¡ä½¿ç”¨å®¹å™¨,æš‚æ—¶è¿˜æ²¡æ³•åœ¨å®¹å™¨ä¸­å®æˆ˜.ğŸ˜","like_count":1},{"had_liked":false,"id":74584,"user_name":"ninuxer","can_delete":false,"product_type":"c1","uid":1243135,"ip_address":"","ucode":"5394ADAF2667D6","user_header":"https://wx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEKQMM4m7NHuicr55aRiblTSEWIYe0QqbpyHweaoAbG7j2v7UUElqqeP3Ihrm3UfDPDRb1Hv8LvPwXqA/132","comment_is_top":false,"comment_ctime":1552263270,"is_pvip":false,"replies":[{"id":"27336","content":"ğŸ‘ è°¢è°¢åˆ†äº«","user_name":"ä½œè€…å›å¤","comment_id":74584,"uid":"1001282","ip_address":"","utype":1,"ctime":1552349695,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":2,"race_medal":0,"score":"5847230566","product_id":100020901,"comment_content":"æ‰“å¡day49<br>å‰ä¸¤å¤©åœ¨æˆ‘ä»¬çº¿ä¸‹ç¯å¢ƒä¸€å°dockerå®¿ä¸»æœºä¸Šï¼Œä¸€ç›´æ— æ³•createå®¹å™¨ï¼Œåæ¥çœ‹æ—¥å¿—ï¼Œå‘ç°æœ‰ä¸¤ä¸ªå¯ç–‘ä¹‹å¤„:<br>ç¬¬ä¸€:dockeræ—¥å¿—æ˜¾ç¤ºsocketæ–‡ä»¶æŸåï¼Œä½†æ˜¯å½“æ—¶è¿è¡Œå…¶ä»–dockerç®¡ç†å‘½ä»¤èƒ½æ­£å¸¸è¿”å›ç»“æœ<br>ç¬¬äºŒ:å®¿ä¸»æœºä¸Šæœ‰ä¸ªkworker&#47;u80è¿›ç¨‹cpuåˆ©ç”¨ç‡ä¸€ç›´100%ï¼Œæœ€ç»ˆæ˜¯é€šè¿‡é‡å¯å®¿ä¸»æœºè§£å†³çš„ï½","like_count":2,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":442605,"discussion_content":"ğŸ‘ è°¢è°¢åˆ†äº«","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1552349695,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1720144,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/3f/50/bf9e9e92.jpg","nickname":"é©¬å®ä¼Ÿ","note":"","ucode":"D72048FB04D550","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":41217,"discussion_content":"è¢«æŒ–å‘äº†å§","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572364618,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":306825,"user_name":"Li~","can_delete":false,"product_type":"c1","uid":1870306,"ip_address":"","ucode":"5FBA30D0D7DA31","user_header":"https://static001.geekbang.org/account/avatar/00/1c/89/e2/4d314444.jpg","comment_is_top":false,"comment_ctime":1628735409,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1628735409","product_id":100020901,"comment_content":"è¯·æ•™è€å¸ˆï¼Œé€šè¿‡ç¯å¢ƒå˜é‡ JAVA_OPTS=â€™-Xmx512m -Xms512mâ€™ ï¼ŒæŠŠ JVM çš„åˆå§‹å†…å­˜å’Œæœ€å¤§å†…å­˜éƒ½è®¾ä¸º 512MBåï¼Œä¸ºä»€ä¹ˆæ‰§è¡Œdocker exec tomcat free -mè¿˜æ˜¯çœ‹åˆ°çš„ä¸»æœºå†…å­˜ï¼Œä¸æ˜¯512MB å‘¢ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1453001,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqT9A3iaTfERufLictBib6nvmVvfFlEyZRSHiaGfz4yNmBK0hibZUiciahMOJdE8QZV65GxDJ1DlXWkePllw/132","nickname":"xiaotuanyu","note":"","ucode":"CE254B914AE921","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":537727,"discussion_content":"ä½ é€šè¿‡å‚æ•°é™åˆ¶çš„æ˜¯jvmçš„å†…å­˜é™åˆ¶ï¼Œè·Ÿä½ çœ‹ä¸»æœºçš„å†…å­˜å°±æ˜¯ä¸¤ç äº‹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639150141,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":273854,"user_name":"å¤§å¤§æ—","can_delete":false,"product_type":"c1","uid":2356257,"ip_address":"","ucode":"AC0F6231884830","user_header":"https://static001.geekbang.org/account/avatar/00/23/f4/21/b6c0d237.jpg","comment_is_top":false,"comment_ctime":1610697091,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1610697091","product_id":100020901,"comment_content":"æˆ‘è¿™ä¸è¡Œå•Š æŒ‰ç…§è€å¸ˆçš„é•œåƒç›´æ¥å¯åŠ¨ æ²¡oom<br>CONTAINER ID        NAME                CPU %               MEM USAGE &#47; LIMIT   MEM %               NET I&#47;O             BLOCK I&#47;O           PIDS<br>9438a69a9630        tomcat              0.63%               343.7MiB &#47; 512MiB   67.14%              3.96kB &#47; 6.53kB     0B &#47; 0B  ","like_count":0,"discussions":[{"author":{"id":1527882,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erGficovWwKUXiahEBR0VgOs1xWjq3HOBSVWmyb6TonFyzTwib7ic9icbFebO9eRWy5tvleemKjRzXaNqg/132","nickname":"Guofire","note":"","ucode":"C8609EB8EE24E5","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375787,"discussion_content":"éœ€è¦å…³é—­swapçš„ï¼Œå¦åˆ™ä¸ä¼šOOMçš„","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1621849833,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":260189,"user_name":"Geek_cef97c","can_delete":false,"product_type":"c1","uid":2114292,"ip_address":"","ucode":"2AC8F17EF1BE88","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/WqfmrOyWdB3icW3WOfZqUGaepQujRsRSNXMnRaiczK0icO4qgCWqpVIr1NPmF7icVP6Qnt4JW8HYwhInlrIy8p1fIg/132","comment_is_top":false,"comment_ctime":1604936479,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1604936479","product_id":100020901,"comment_content":"ä½ å¥½ï¼Œæˆ‘ä»¬åšdockerçš„æ€§èƒ½éªŒè¯æµ‹è¯•ï¼Œé€šè¿‡unixbenchè·‘æ•°æ®ï¼Œå‘ç°é»˜è®¤çš„seccompè®¾ç½®å¯¹æ€§èƒ½æœ‰è¾ƒå¤§å½±å“ï¼Œé€šè¿‡è®¾ç½®--security-opt seccomp:unconfinedå‚æ•°èƒ½å’Œå®¿ä¸»æœºæ€§èƒ½ç›¸å½“ï¼Œè€Œé»˜è®¤seccompå¤§çº¦æœ‰16%å·¦å³æŸè€—ã€‚<br>è¿™ç§æƒ…å†µçš„æ€§èƒ½æŸè€—æ€ä¹ˆå®šä½å‘¢ï¼Ÿ","like_count":0},{"had_liked":false,"id":246240,"user_name":"Geek_8c2731","can_delete":false,"product_type":"c1","uid":1928194,"ip_address":"","ucode":"A87F938209D65A","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJkGGBK46EQpqE6zWCncMs14Jw95s191Y6pk3x3gQpNrvSc2YWoFEgUxmJWicibGp7XsFFKaZxuTSnA/132","comment_is_top":false,"comment_ctime":1599217792,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1599217792","product_id":100020901,"comment_content":"åœ¨è¿™ç« æˆ‘å°±æœ‰ä¸œè¥¿å¯è®²äº†ï¼Œæˆ‘ç ”ç©¶dockerè‡³ä»Šï¼Œå¼€å§‹è®¾ç½®çš„èµ„æºé™åˆ¶å¤ªå°ï¼Œå¯¼è‡´nodejsåº”ç”¨å®¹å™¨OOMï¼Œç”Ÿæˆå¤§é‡æ–‡ä»¶ï¼Œå æ»¡äº†æ•´ä¸ªç¡¬ç›˜ï¼Œå¯¼è‡´å…¶ä»–ç³»ç»Ÿåº”ç”¨ä¸å¯ç”¨ã€‚å†è€…å°±æ˜¯Javaå¼‚æ­¥è¡Œä¸ºè¿‡ç¨‹ä¸åšé™åˆ¶ä¼šæ¶ˆè€—å¤§é‡å†…å­˜ï¼Œåšå®Œé™åˆ¶åå°±ç®—OOMä¹Ÿåªæ˜¯å®ƒè‡ªèº«","like_count":1},{"had_liked":false,"id":225285,"user_name":"æ³¨æ„åŠ›$","can_delete":false,"product_type":"c1","uid":1142316,"ip_address":"","ucode":"7FB3399A1EAB72","user_header":"https://static001.geekbang.org/account/avatar/00/11/6e/2c/e2f3cfc0.jpg","comment_is_top":false,"comment_ctime":1591705358,"is_pvip":false,"discussion_count":2,"race_medal":1,"score":"1591705358","product_id":100020901,"comment_content":"è€å¸ˆï¼Œè¯·é—® PID=$(docker inspect tomcat -f &#39;{{.State.Pid}}&#39;)  è¿™ä¸ªpid  æ˜¯æ€ä¹ˆå–å‡ºæ¥çš„ï¼Œå‰é¢çš„è¯¾ç¨‹é‡Œå¥½åƒä¹Ÿæœ‰è¿™ä¸ªå§ï¼Ÿä¸ç†Ÿæ‚‰shell","like_count":0,"discussions":[{"author":{"id":1964381,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/WCcouXsOEyIJjAHDOdiaQLGqaNJibKiazAj7FopZJDdF6rJAR43TbqvVr6f1jn4mLTv6iblibhCGx7JAf1363ibcuEicw/132","nickname":"Geek_d5e66a","note":"","ucode":"E00F024E9D1905","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":310356,"discussion_content":"ä½ å¯ä»¥è©¦è‘—æŸ¥çœ‹ `docker inspect tomcat` çš„çµæœï¼Œç„¶å¾Œçœ‹ `docker inspect` çš„åƒæ•¸ï¼Œæ‡‰è©²å°±èƒ½ç†è§£äº†ã€‚`$()` ä»£è¡¨å–å¾—è©² shell command çš„è¼¸å‡ºçµæœ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1601795005,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1527882,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erGficovWwKUXiahEBR0VgOs1xWjq3HOBSVWmyb6TonFyzTwib7ic9icbFebO9eRWy5tvleemKjRzXaNqg/132","nickname":"Guofire","note":"","ucode":"C8609EB8EE24E5","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1964381,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/WCcouXsOEyIJjAHDOdiaQLGqaNJibKiazAj7FopZJDdF6rJAR43TbqvVr6f1jn4mLTv6iblibhCGx7JAf1363ibcuEicw/132","nickname":"Geek_d5e66a","note":"","ucode":"E00F024E9D1905","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375788,"discussion_content":"``å’Œ $() è¿™æ˜¯ä¸¤ç§ç”¨æ³•ï¼Œè¿™ä¸¤ä¸ªæ˜¯ç­‰æ•ˆçš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621849941,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":310356,"ip_address":""},"score":375788,"extra":""}]}]},{"had_liked":false,"id":214598,"user_name":"æ‰æ¾å£","can_delete":false,"product_type":"c1","uid":1080578,"ip_address":"","ucode":"ED904CE27CD3C4","user_header":"https://static001.geekbang.org/account/avatar/00/10/7d/02/4862f849.jpg","comment_is_top":false,"comment_ctime":1588770710,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1588770710","product_id":100020901,"comment_content":"æœ‰2ä¸ªé—®é¢˜ï¼š<br>1. å®¹å™¨å’Œjvméƒ½è®¾ç½®äº†å†…å­˜ï¼Œä½†æ˜¯ä¸çŸ¥é“ä¸ºä»€ä¹ˆå®¹å™¨æœ‰çš„æ—¶å€™è¿˜æ˜¯ä¼šOOM<br>2. æ—¢è¦é™åˆ¶å®¹å™¨çš„èµ„æºï¼Œåˆä¸å¥½è®¾ç½®JVMèµ„æºçš„æ—¶å€™ï¼Œæœ‰æ›´æ–¹ä¾¿çš„æ–¹æ³•å—","like_count":0},{"had_liked":false,"id":211697,"user_name":"hhhh","can_delete":false,"product_type":"c1","uid":1256101,"ip_address":"","ucode":"9E87017424B382","user_header":"https://static001.geekbang.org/account/avatar/00/13/2a/a5/625c0a2e.jpg","comment_is_top":false,"comment_ctime":1587996323,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1587996323","product_id":100020901,"comment_content":"ä¹‹å‰é‡åˆ°è¿‡k8sé‡Œé¢è·‘çš„å®¹å™¨ï¼Œcgroupé™åˆ¶çš„å†…å­˜è¿‡å°ï¼Œå¼€å‘äººå‘˜é”™å†™ä¸º1MBï¼ŒrestartPolicyåˆè®¾ç½®æˆäº†always, ç»“æœè¿™ä¸ªcontainerä¸€ç›´è¢«oom killï¼Œdmesgå…¨æ˜¯oomä¿¡æ¯ï¼Œcenos7ä¸Šè¿˜é€ æˆäº†memory allocate dead lock ç‰©ç†æœºç›´æ¥æŒ‚äº†ã€‚ã€‚ã€‚","like_count":0},{"had_liked":false,"id":87131,"user_name":"z.l","can_delete":false,"product_type":"c1","uid":1181055,"ip_address":"","ucode":"805CC5784D3F76","user_header":"https://static001.geekbang.org/account/avatar/00/12/05/7f/d35ab9a1.jpg","comment_is_top":false,"comment_ctime":1555515148,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1555515148","product_id":100020901,"comment_content":"åˆå­¦dockeræ—¶è§£å†³çš„ç¬¬ä¸€ä¸ªé—®é¢˜å°±æ˜¯æ²¡è®¾ç½®jvmçš„-Xmxå¯¼è‡´oomçš„é—®é¢˜ï¼Œå‰é¢çš„åŒäº‹æƒ³å½“ç„¶çš„ä»¥ä¸ºé™åˆ¶äº†å®¹å™¨å†…å­˜ä¹Ÿå¯ä»¥ä¼ é€’ç»™jvmã€‚","like_count":0},{"had_liked":false,"id":85089,"user_name":"å¦‚æœ","can_delete":false,"product_type":"c1","uid":1320638,"ip_address":"","ucode":"138A3EEEE50850","user_header":"","comment_is_top":false,"comment_ctime":1554976306,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1554976306","product_id":100020901,"comment_content":"DAY46ï¼Œæ‰“å¡<br>","like_count":0},{"had_liked":false,"id":80976,"user_name":"å°è€é¼ ","can_delete":false,"product_type":"c1","uid":1257460,"ip_address":"","ucode":"C663A0C863A515","user_header":"https://static001.geekbang.org/account/avatar/00/13/2f/f4/2dede51a.jpg","comment_is_top":false,"comment_ctime":1553767641,"is_pvip":false,"replies":[{"id":"29588","content":"å¯ä»¥çš„","user_name":"ä½œè€…å›å¤","comment_id":80976,"uid":"1001282","ip_address":"","utype":1,"ctime":1554003541,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":1,"race_medal":0,"score":"1553767641","product_id":100020901,"comment_content":"æµ‹è¯•åº”ç”¨è½¯ä»¶çš„æ€§èƒ½ï¼ˆæ¯”å¦‚ç”¨LoadRunner æˆ–JMterï¼‰å¯ä»¥åœ¨å®¹å™¨ä¸­è¿›è¡Œå—ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":445034,"discussion_content":"å¯ä»¥çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1554003541,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":75435,"user_name":"è…¾è¾¾","can_delete":false,"product_type":"c1","uid":1079876,"ip_address":"","ucode":"72F9CFBA44FDEE","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTL9hlAIKQ1sGDu16oWLOHyCSicr18XibygQSMLMjuDvKk73deDlH9aMphFsj41WYJh121aniaqBLiaMNg/132","comment_is_top":false,"comment_ctime":1552397350,"is_pvip":false,"replies":[{"id":"28037","content":"æ‰§è¡Œ docker exec tomcat java -XX:+PrintFlagsFinal -version | grep HeapSize ç¡®è®¤ä¸€ä¸‹å®¹å™¨ä¸­javaçš„å †å†…å­˜ï¼Ÿ","user_name":"ä½œè€…å›å¤","user_name_real":"å€ªæœ‹é£","uid":"1001282","ctime":1552748551,"ip_address":"","comment_id":75435,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1552397350","product_id":100020901,"comment_content":"æˆ‘çš„tomcatä¸ºä»€ä¹ˆä¸èƒ½å®ç°oomï¼Ÿdmesgæ˜¾ç¤ºæ²¡æœ‰oomï¼Œè¿›ç¨‹ä¹Ÿæ²¡æœ‰è¢«æ€æ­»ã€‚æˆ‘çœ‹æœ‰å…¶ä»–ç½‘å‹ç•™è¨€è¯´è¦è™šæ‹Ÿæœºå†…å­˜è®¾ä¸º8Gï¼Œæˆ‘çš„æ˜¯è®¾ç½®ä¸º8Gäº†ã€‚","like_count":1,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":442892,"discussion_content":"æ‰§è¡Œ docker exec tomcat java -XX:+PrintFlagsFinal -version | grep HeapSize ç¡®è®¤ä¸€ä¸‹å®¹å™¨ä¸­javaçš„å †å†…å­˜ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1552748551,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1617171,"avatar":"","nickname":"ä¹Ÿæ›¾å°‘å¹´","note":"","ucode":"62A8C26B689198","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":334397,"discussion_content":"ä½ æ˜¯ä¸æ˜¯å¯ç”¨äº†swapåˆ†åŒº ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1607838218,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":74816,"user_name":"ttxser","can_delete":false,"product_type":"c1","uid":1022694,"ip_address":"","ucode":"47C3FCB59F8027","user_header":"https://static001.geekbang.org/account/avatar/00/0f/9a/e6/e8439f9a.jpg","comment_is_top":false,"comment_ctime":1552300652,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1552300652","product_id":100020901,"comment_content":"å€¼äº†","like_count":0},{"had_liked":false,"id":74798,"user_name":"å¤œç©ºä¸­æœ€äº®çš„æ˜Ÿ","can_delete":false,"product_type":"c1","uid":1267566,"ip_address":"","ucode":"ADC3E7B6789955","user_header":"https://static001.geekbang.org/account/avatar/00/13/57/6e/b6795c44.jpg","comment_is_top":false,"comment_ctime":1552299249,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1552299249","product_id":100020901,"comment_content":"å¾ˆå—å¯å‘ï¼Œæœ€è¿‘ä¹Ÿåœ¨é’»ç ”docker å’Œk8s","like_count":0},{"had_liked":false,"id":74779,"user_name":"rock04","can_delete":false,"product_type":"c1","uid":1316129,"ip_address":"","ucode":"7E104151852AB4","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/XC10ibnwF0jtwgksFoSuUCMtgfK0Ndk5Wib3Xyr5Yyz9xiaCrKibNicPksVmicpZEatWgPPLfMXz3jCGMMiclHHQlku4Q/132","comment_is_top":false,"comment_ctime":1552296755,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1552296755","product_id":100020901,"comment_content":"è€å¸ˆï¼Œä»Šå¤©å·¥ä½œåšé‡åˆ°ä¸€ä¸ªå¹³å‡è´Ÿè½½çš„é—®é¢˜ã€‚8Cçš„è™šæ‹Ÿæœºã€‚åªæœ‰ä¸€ä¸ªjavaè¿›ç¨‹ï¼Œä½†æ˜¯å¹³å‡è´Ÿè½½å¾ˆé«˜è¶…è¿‡8.ç”šè‡³è¾¾åˆ°12ã€‚æŸ¥çœ‹CPU IOéƒ½å¾ˆä½  è¿™ä¸ªåº”è¯¥æ€ä¹ˆæ’æŸ¥","like_count":0}]}