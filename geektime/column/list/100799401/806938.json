{"id":806938,"title":"11ï½œè¡¨å¤ªå¤§äº†ï¼Œä¿®æ”¹è¡¨ç»“æ„å¤ªæ…¢æ€ä¹ˆè§£å†³ï¼Ÿï¼ˆä¸Šï¼‰","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯ä¿Šè¾¾ã€‚</p><p>å¹³æ—¶æˆ‘ä»¬ä½¿ç”¨MySQLï¼Œæˆ–å¤šæˆ–å°‘éƒ½ä¼šé‡åˆ°DDLçš„éœ€æ±‚ã€‚æ¯”å¦‚æœ‰æ–°ä¸šåŠ¡ä¸Šçº¿ï¼Œéœ€è¦ç»™ç°æœ‰çš„è¡¨æ·»åŠ æ–°çš„å­—æ®µï¼›æˆ–è€…éœ€è¦è°ƒæ•´ç´¢å¼•æ¥ä¼˜åŒ–æ€§èƒ½ï¼›æˆ–è€…ç°æœ‰çš„è¡¨å¯èƒ½å­˜åœ¨å¤§é‡ç¢ç‰‡ï¼Œéœ€è¦ä¼˜åŒ–è¡¨ï¼Œæ”¶ç¼©ç©ºé—´ã€‚</p><p>é‚£ä¹ˆå¯¹ç°æœ‰çš„ä¸šåŠ¡è¡¨æ‰§è¡Œå„ç±»DDLæ“ä½œæ—¶ï¼Œéœ€è¦å¤šå°‘æ—¶é—´æ‰èƒ½æ‰§è¡Œå®Œæˆï¼Ÿæ‰§è¡Œçš„è¿‡ç¨‹ä¸­æ˜¯å¦ä¼šé”è¡¨ï¼Œåº”ç”¨ç¨‹åºåœ¨DDLæ‰§è¡Œçš„è¿‡ç¨‹ä¸­æ˜¯å¦èƒ½æ­£å¸¸è¯»å†™æ•°æ®ï¼ŸDDLæ“ä½œæ˜¯å¦ä¼šæ¶ˆè€—å¤§é‡èµ„æºï¼Œå½±å“æ•°æ®åº“çš„æ€§èƒ½ï¼Ÿç‰¹åˆ«æ˜¯å½“æ“ä½œçš„è¡¨ç‰¹åˆ«å¤§ï¼Œæˆ–è€…åº”ç”¨ç³»ç»Ÿçš„å¯ç”¨æ€§è¦æ±‚ç‰¹åˆ«é«˜çš„æ—¶å€™ï¼Œè¿™äº›é—®é¢˜å°±ç‰¹åˆ«é‡è¦ã€‚</p><p>è¿™ä¸€è®²æˆ‘ä»¬å°±æ¥è¯¦ç»†åœ°åˆ†æMySQLä¸­å„ç±»DDLæ“ä½œå…·ä½“æ˜¯å¦‚ä½•æ‰§è¡Œçš„ã€‚å¦‚ä½•åœ¨å®ŒæˆDDLçš„åŒæ—¶ï¼Œå°½é‡å‡å°‘å¯¹ä¸šåŠ¡ç³»ç»Ÿçš„å½±å“ã€‚</p><p>æœ‰äº›DDLåªéœ€è¦ä¿®æ”¹å…ƒæ•°æ®ï¼Œä¸å½±å“è¡¨ä¸­å®é™…å­˜å‚¨çš„æ•°æ®ï¼Œè¿™äº›æ“ä½œé€šå¸¸å¾ˆå¿«å°±èƒ½å®Œæˆã€‚æœ‰äº›DDLéœ€è¦é‡å»ºè¡¨ï¼Œæ‰§è¡Œè¿‡ç¨‹ä¸­éœ€è¦å¤åˆ¶æ•´ä¸ªè¡¨çš„æ•°æ®ï¼Œè¿™äº›DDLçš„å¼€é”€æ¯”è¾ƒå¤§ã€‚ä»MySQL 5.6å¼€å§‹ï¼ŒInnoDBå­˜å‚¨å¼•æ“é€æ¸æ”¯æŒäº†Online DDLï¼Œå¾ˆå¤šDDLæ“ä½œï¼Œåœ¨é‡å»ºè¡¨çš„è¿‡ç¨‹ä¸­å¯ä»¥å°½é‡ä¸é”è¡¨ï¼Œå‡å°‘å¯¹åº”ç”¨ç³»ç»Ÿçš„å½±å“ã€‚ä½†ä¹Ÿæœ‰ä¸€äº›DDLï¼Œåœ¨æ‰§è¡Œçš„æ•´ä¸ªè¿‡ç¨‹ä¸­éƒ½éœ€è¦é”è¡¨ï¼Œåº”ç”¨ç¨‹åºåªèƒ½è¯»å–æ•°æ®ï¼Œæ— æ³•ä¿®æ”¹æ•°æ®ã€‚è¿˜æœ‰ä¸€äº›DDLæ“ä½œï¼Œä¸»è¦æ˜¯åˆ›å»ºç´¢å¼•ï¼Œåœ¨æ‰§è¡ŒæœŸé—´ä¸éœ€è¦é‡å»ºè¡¨ï¼Œä½†éœ€è¦æ‰«ææ•´ä¸ªè¡¨çš„æ•°æ®ï¼ŒæŒ‰ç´¢å¼•å­—æ®µå¯¹æ•°æ®è¿›è¡Œæ’åºï¼Œæ„å»ºæ–°çš„ç´¢å¼•ã€‚</p><!-- [[[read_end]]] --><p>å¾ˆå¤šMySQL DDLè¯­å¥ä¸­ï¼Œå¯ä»¥åŠ ä¸Šå…³é”®å­—ALGORITHMå’ŒLOCKï¼Œç”¨äºæŒ‡å®šDDLçš„æ‰§è¡Œæ–¹å¼ã€‚æ¯”å¦‚åœ¨ä¸‹é¢è¿™ä¸ªSQLä¸­ï¼Œæˆ‘ä»¬æŒ‡å®šäº†ALGORITHMä¸ºINPLACEï¼ŒLOCKä¸ºNONEã€‚ç”±äºè¿™ä¸ªSQLåªæ˜¯ä¿®æ”¹äº†å­—æ®µçš„æ³¨é‡Šï¼Œå› æ­¤æ‰§è¡Œå¾ˆå¿«ã€‚</p><pre><code class=\"language-go\">mysql&gt; desc salaries;\n+-----------+------+------+-----+---------+-------+\n| Field     | Type | Null | Key | Default | Extra |\n+-----------+------+------+-----+---------+-------+\n| emp_no    | int  | NO   | PRI | NULL    |       |\n| salary    | int  | NO   |     | NULL    |       |\n| from_date | date | NO   | PRI | NULL    |       |\n| to_date   | date | YES  |     | NULL    |       |\n+-----------+------+------+-----+---------+-------+\n\n\nmysql&gt; alter table salaries \n    modify emp_no int not null comment 'Employee Identity', \n    algorithm=inplace, \n    lock=none;\n\nQuery OK, 0 rows affected (6.01 sec)\nRecords: 0  Duplicates: 0  Warnings: 0\n</code></pre><p>å¦‚æœDDLä¸æ”¯æŒä»¥ALGORITHMæŒ‡å®šçš„æ–¹å¼æ¥æ‰§è¡Œï¼Œä¼šç›´æ¥æŠ¥é”™ã€‚ä¸‹é¢è¿™ä¸ªSQLä¸­ï¼Œä¿®æ”¹äº†å­—æ®µçš„not nullå±æ€§ï¼Œå› æ­¤æ— æ³•ä»¥INSTANTçš„æ–¹å¼æ‰§è¡Œã€‚</p><pre><code class=\"language-go\">mysql&gt; alter table salaries modify salary int, algorithm=instant;\nERROR 1845 (0A000): ALGORITHM=INSTANT is not supported for this operation. Try ALGORITHM=COPY/INPLACE.\n</code></pre><p>å…³é”®å­—ALGORITHMå¯ä»¥æŒ‡å®šä¸ºDEFAULTã€INSTANTã€INPLACEæˆ–COPYã€‚</p><ul>\n<li>DEFAULTï¼šé»˜è®¤æ–¹å¼ï¼Œä¸åŒçš„DDLç±»å‹ï¼Œé»˜è®¤çš„æ‰§è¡Œæ–¹å¼å¯èƒ½ä¸ä¸€æ ·ã€‚MySQLä¼šä»¥è¯¥DDLå¼€é”€æœ€ä½çš„æ–¹å¼æ¥é€‰æ‹©é»˜è®¤çš„æ‰§è¡Œæ–¹å¼ã€‚</li>\n<li>INSTANTï¼šMySQL 8.0æ–°åŠ çš„æ‰§è¡Œæ–¹å¼ï¼Œä½¿ç”¨è¿™ç§æ‰§è¡Œæ–¹å¼æ—¶ï¼Œæ·»åŠ å­—æ®µå’Œåˆ é™¤å­—æ®µæ—¶ä¸éœ€è¦é‡å»ºè¡¨ã€‚ALGORITHMæŒ‡å®šä¸ºINSTANTæ—¶ï¼Œä¸èƒ½å†æŒ‡å®šLOCKå…³é”®å­—ã€‚</li>\n<li>INPLACEï¼šOnline DDLã€‚ä½¿ç”¨INPLACEæ—¶ï¼Œé»˜è®¤ä¸é”è¡¨ã€‚è¿™é‡Œçš„ä¸é”è¡¨ï¼Œæ˜¯æŒ‡é‡å»ºè¡¨æ—¶å¤åˆ¶æ•°æ®çš„è¿‡ç¨‹ä¸­ï¼Œæˆ–åˆ›å»ºäºŒçº§ç´¢å¼•æ—¶è¯»å–å…¨è¡¨æ•°æ®è¿›è¡Œæ’åºã€ç”Ÿæˆç´¢å¼•çš„è¿‡ç¨‹ä¸­ä¸é”è¡¨ã€‚ä½†æ˜¯åœ¨å¤åˆ¶æ•°æ®æˆ–ç”Ÿæˆç´¢å¼•çš„è¿‡ç¨‹ä¸­ï¼Œè¡¨ä¸Šä¼šæœ‰æ–°çš„DMLä¿®æ”¹æ•°æ®ï¼Œè¿™äº›ä¿®æ”¹ä¼šè®°å½•åˆ°ä¸€ä¸ªåœ¨çº¿çš„å˜æ›´æ—¥å¿—ä¸­ã€‚InnoDBéœ€è¦å°†å˜æ›´æ—¥å¿—ä¸­çš„å†…å®¹æ›´æ–°åˆ°æ–°çš„è¡¨æˆ–ç´¢å¼•ä¸­ï¼Œè€Œè¿™ä¸ªè¿‡ç¨‹ä¸­æ˜¯ä¼šé”è¡¨çš„ï¼Œè¿™ä¸€ç‚¹åé¢ä¼šè¯¦ç»†ä»‹ç»ã€‚</li>\n<li>COPYï¼šä¼ ç»Ÿçš„DDLæ‰§è¡Œæ–¹å¼ï¼Œæ‰§è¡Œè¿‡ç¨‹ä¸­ä¼šé”è¡¨ï¼Œé»˜è®¤é”æ¨¡å¼ä¸ºSHAREDï¼Œåº”ç”¨ç¨‹åºå¯ä»¥è¯»å–è¡¨ä¸­çš„æ•°æ®ï¼Œä½†æ˜¯ä¸èƒ½å†™å…¥æ•°æ®ã€‚å¦‚æœLOCKæŒ‡å®šä¸ºEXCLUSIVEï¼Œé‚£ä¹ˆè¯»æ“ä½œä¹Ÿä¼šè¢«é˜»å¡ã€‚</li>\n</ul><p>å…³é”®å­—LOCKå¯ä»¥æŒ‡å®šä¸ºNONEã€SHAREDæˆ–EXCLUSIVEï¼Œå¦‚æœä¸æŒ‡å®šï¼Œå°±ä¼šæ ¹æ®å…·ä½“çš„DDLè¯­å¥ã€æŒ‡å®šçš„ALGORITHMæ¥ç¡®å®šä¸€ä¸ªé»˜è®¤çš„é”çº§åˆ«ã€‚</p><ul>\n<li>NONEï¼šä¸é”è¡¨ã€‚</li>\n<li>SHAREDï¼šå…±äº«é”ï¼Œå…è®¸è¯»å–æ•°æ®ï¼Œä½†æ˜¯ä¸å…è®¸ä¿®æ”¹æ•°æ®ã€‚</li>\n<li>EXCLUSIVEï¼šæ’å®ƒé”ï¼Œä¸å…è®¸è¯»å–å’Œä¿®æ”¹æ•°æ®ã€‚</li>\n</ul><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ†åˆ«æ¥ä»‹ç»MySQLä¸­å‡ ç§ä¸åŒç±»å‹çš„DDLã€‚</p><h2>åªä¿®æ”¹å…ƒæ•°æ®çš„DDLæ“ä½œ</h2><p>æœ‰ä¸€äº›DDLåªéœ€è¦ä¿®æ”¹å…ƒæ•°æ®ï¼Œä¸éœ€è¦ä¿®æ”¹è¡¨ä¸­å®é™…å­˜å‚¨çš„æ•°æ®ã€‚ä¿®æ”¹è¡¨åã€å­—æ®µåæˆ–ç´¢å¼•åå°±æ˜¯è¿™æ ·çš„æ“ä½œã€‚</p><pre><code class=\"language-go\">mysql&gt; alter table employees rename to employees_v2;\nQuery OK, 0 rows affected (0.03 sec)\n\nmysql&gt; alter table dept_emp rename key dept_no to idx_dept_no;\nQuery OK, 0 rows affected (0.01 sec)\nRecords: 0  Duplicates: 0  Warnings: 0\n\nmysql&gt; alter table dept_emp rename column to_date to end_date;\nQuery OK, 0 rows affected (0.02 sec)\nRecords: 0  Duplicates: 0  Warnings: 0\n</code></pre><p>ä¿®æ”¹è¡¨åæœ‰ä¸€ä¸ªé‡è¦çš„ä½œç”¨ã€‚æ¯”å¦‚æŸä¸ªä¸šåŠ¡è¡¨ä¸å†ä½¿ç”¨äº†ï¼Œæˆ‘ä»¬å…ˆä¸è¦æ€¥ç€DROP TABLEï¼Œè€Œæ˜¯å…ˆå°†è¡¨æ”¹ä¸€ä¸ªåå­—ï¼Œç­‰è¿‡ä¸€æ®µæ—¶é—´ï¼Œç¡®å®šç¡®å®æ²¡æœ‰ä»»ä½•ä¸šåŠ¡ä¼šè®¿é—®è¿™ä¸ªè¡¨äº†ï¼Œå†DROPè¡¨ã€‚å› ä¸ºå¦‚æœDROPè¡¨ä¹‹åï¼Œä½ å†å‘ç°è¿˜æœ‰ä¸šåŠ¡ä¼šè®¿é—®è¿™ä¸ªè¡¨ï¼Œæ¢å¤èµ·æ¥å°±æ¯”è¾ƒéº»çƒ¦äº†ï¼Œå¯èƒ½éœ€è¦æ¯”è¾ƒé•¿çš„æ—¶é—´ï¼Œè€Œæ”¹ä¸ªè¡¨åï¼Œæ¢å¤èµ·æ¥å°±éå¸¸æ–¹ä¾¿äº†ã€‚</p><p>DROP TABLEã€DROP INDEXè¿™æ ·çš„æ“ä½œä¹ŸåŸºæœ¬ä¸Šä¹Ÿåªéœ€è¦ä¿®æ”¹å…ƒæ•°æ®ï¼Œæ‰§è¡Œé€Ÿåº¦ä¸€èˆ¬ä¹Ÿå¾ˆå¿«ã€‚å½“ç„¶DROPè¡¨å’Œç´¢å¼•æ—¶ï¼Œè¿˜éœ€è¦å›æ”¶å®ƒä»¬å ç”¨çš„ç‰©ç†ç©ºé—´ã€‚å¦‚æœå¼€å¯äº†innodb_file_per_tableï¼ŒDROPè¡¨æ—¶éœ€è¦åˆ é™¤å¯¹åº”çš„ibdæ–‡ä»¶ã€‚</p><p>åˆ é™¤ç´¢å¼•ä¹Ÿæ˜¯ä¸€ä¸ªéœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ“ä½œã€‚è™½ç„¶åˆ é™¤ç´¢å¼•å¹¶ä¸ä¼šå½±å“è¡¨ä¸­çš„æ•°æ®ï¼Œä½†å¯èƒ½ä¼šå½±å“ä¸€äº›æŸ¥è¯¢çš„æ€§èƒ½ã€‚ä¸€äº›å…³é”®ç´¢å¼•åˆ é™¤åï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®åº“CPUè¢«æ‰“æ»¡ï¼Œè¿™ä¸ªæ—¶å€™ä½ æƒ³æŠŠç´¢å¼•å†åŠ å›æ¥ï¼Œå¯èƒ½å°±éœ€è¦æ¯”è¾ƒé•¿çš„æ—¶é—´äº†ï¼Œè€Œä¸”å¯èƒ½éœ€è¦å…ˆæŠŠä¸šåŠ¡åœæ‰æ‰è¡Œã€‚MySQL 8.0æ”¯æŒä¸å¯è§ç´¢å¼•ï¼Œåˆ é™¤ç´¢å¼•å‰ï¼Œä½ å¯ä»¥å…ˆæŠŠç´¢å¼•è®¾ç½®ä¸ºä¸å¯è§ã€‚è¿™æ ·ï¼Œæ‰§è¡Œè®¡åˆ’ä¸ä¼šå†è€ƒè™‘è¿™ä¸ªç´¢å¼•ï¼Œä½†æ˜¯æ‰§è¡ŒDMLæ“ä½œæ—¶ï¼Œä¼šæ­£å¸¸ç»´æŠ¤è¿™ä¸ªç´¢å¼•ã€‚</p><pre><code class=\"language-go\">mysql&gt; alter table dept_emp alter index idx_dept_no invisible;\nQuery OK, 0 rows affected (0.00 sec)\nRecords: 0  Duplicates: 0  Warnings: 0\n\nmysql&gt; explain select * from dept_emp where dept_no = 'd005' limit 1;\n+----+-------------+----------+------+---------------+--------+-------------+\n| id | select_type | table    | type | possible_keys | rows   | Extra       |\n+----+-------------+----------+------+---------------+--------+-------------+\n|  1 | SIMPLE      | dept_emp | ALL  | NULL          | 331143 | Using where |\n+----+-------------+----------+------+---------------+--------+-------------+\n</code></pre><p>å¦‚æœä½ å‘ç°ä¸šåŠ¡ç³»ç»Ÿè¿˜éœ€è¦ä½¿ç”¨è¿™ä¸ªç´¢å¼•ï¼Œå¯ä»¥å°†ç´¢å¼•æ”¹æˆå¯è§ï¼Œè¿™ä¸ªæ“ä½œé€šå¸¸ä¹Ÿå¾ˆå¿«èƒ½å®Œæˆã€‚</p><pre><code class=\"language-go\">mysql&gt; alter table dept_emp alter index idx_dept_no visible;\nQuery OK, 0 rows affected (0.01 sec)\nRecords: 0  Duplicates: 0  Warnings: 0\n</code></pre><p>æ­¤å¤–ï¼Œä¿®æ”¹è¡¨å’Œå­—æ®µçš„æ³¨é‡Šï¼Œä¹Ÿåªéœ€è¦ä¿®æ”¹å…ƒæ•°æ®ï¼Œè¿™åº”è¯¥å®¹æ˜“ç†è§£ã€‚</p><pre><code class=\"language-go\">mysql&gt; alter table dept_emp comment='Department Employee Relationship';\nQuery OK, 0 rows affected (0.01 sec)\nRecords: 0  Duplicates: 0  Warnings: 0\n\nmysql&gt; alter table dept_emp modify from_date date not null comment 'From Date', algorithm=instant;\nQuery OK, 0 rows affected (0.01 sec)\nRecords: 0  Duplicates: 0  Warnings: 0\n</code></pre><p>éœ€è¦æ³¨æ„ï¼Œä¿®æ”¹å­—æ®µçš„æ³¨é‡Šæ—¶ï¼Œéœ€è¦ç¡®ä¿å­—æ®µçš„ç±»å‹å’Œæ˜¯å¦ä¸ºNULLå±æ€§ä¸å˜ï¼Œå¦åˆ™å°±ä¸èƒ½ä»…ä»…ä¿®æ”¹å…ƒæ•°æ®äº†ã€‚ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œç”±äºä¿®æ”¹äº†å­—æ®µçš„æ˜¯å¦å¯ä¸ºNULLçš„çº¦æŸï¼Œå¼€é”€å°±æ¯”è¾ƒå¤§äº†ã€‚</p><pre><code class=\"language-go\">mysql&gt; alter table dept_emp modify from_date date comment 'From Date', algorithm=instant;\nERROR 1845 (0A000): ALGORITHM=INSTANT is not supported for this operation. Try ALGORITHM=COPY/INPLACE.\n</code></pre><h2>Instant DDL</h2><p>ç»™è¡¨åŠ å­—æ®µæ˜¯ä¸€ä¸ªå¾ˆå¸¸è§çš„éœ€æ±‚ï¼Œä½†æ˜¯åœ¨5.7åŠæ›´æ—©çš„ç‰ˆæœ¬ä¸­ï¼Œæ¯æ¬¡åŠ å­—æ®µéƒ½éœ€è¦é‡å»ºæ•´ä¸ªè¡¨ï¼Œå¼€é”€å®åœ¨æ˜¯æœ‰ç‚¹å¤§ï¼Œç‰¹åˆ«æ˜¯å½“è¡¨çš„æ•°æ®é‡æ¯”è¾ƒå¤§çš„æ—¶å€™ã€‚MySQL 8.0ä¸­æ–°å¢äº†Instant DDLç‰¹æ€§ï¼Œä¸»è¦è§£å†³äº†åŠ å­—æ®µéœ€è¦é‡å»ºè¡¨çš„è¿™ä¸ªé—®é¢˜ã€‚</p><p>å®é™…ä¸Šåœ¨8.0ä¸­ï¼ŒåŠ å­—æ®µæ—¶ï¼Œå³ä½¿ä¸æŒ‡å®šalgorithm=instantï¼Œé»˜è®¤ä¹Ÿæ˜¯ä½¿ç”¨instantçš„æ–¹å¼ã€‚</p><pre><code class=\"language-go\">mysql&gt; alter table salaries add c1 int, algorithm=instant;\nQuery OK, 0 rows affected (0.02 sec)\nRecords: 0  Duplicates: 0  Warnings: 0\n</code></pre><p>MySQL 8.0.29ç‰ˆæœ¬å¼€å§‹ï¼Œä½ è¿˜å¯ä»¥å°†å­—æ®µåŠ åˆ°ä»»æ„æŒ‡å®šçš„ä½ç½®ã€‚</p><pre><code class=\"language-go\">mysql&gt; alter table salaries add column c2 int after salary, algorithm=instant;\nQuery OK, 0 rows affected (0.01 sec)\nRecords: 0  Duplicates: 0  Warnings: 0\n\nmysql&gt; desc salaries;\n+-----------+------+------+-----+---------+-------+\n| Field     | Type | Null | Key | Default | Extra |\n+-----------+------+------+-----+---------+-------+\n| emp_no    | int  | NO   | PRI | NULL    |       |\n| salary    | int  | NO   |     | NULL    |       |\n| c2        | int  | YES  |     | NULL    |       |\n| from_date | date | NO   | PRI | NULL    |       |\n| to_date   | date | NO   |     | NULL    |       |\n| c1        | int  | YES  |     | NULL    |       |\n+-----------+------+------+-----+---------+-------+\n</code></pre><p>åˆ é™¤å­—æ®µä¹Ÿå¯ä»¥ä½¿ç”¨instantæ–¹å¼ï¼Œä¹Ÿåªéœ€è¦ä¿®æ”¹å…ƒæ•°æ®ã€‚</p><pre><code class=\"language-go\">]mysql&gt; alter table salaries drop column to_date, algorithm=instant;\nQuery OK, 0 rows affected (0.01 sec)\nRecords: 0  Duplicates: 0  Warnings: 0\n</code></pre><p>å½“ç„¶ï¼Œinstant DDLä¹Ÿæœ‰ä¸€äº›é™åˆ¶ï¼Œå°±æ˜¯åŒä¸€ä¸ªè¡¨ï¼Œèƒ½æ‰§è¡Œçš„instantåŠ å­—æ®µæˆ–åˆ é™¤å­—æ®µçš„æ“ä½œæ¬¡æ•°æ˜¯æœ‰é™åˆ¶çš„ï¼Œè¶…è¿‡è¿™ä¸ªæ¬¡æ•°åï¼Œå†æ‰§è¡Œæ—¶å°±ä¼šæŠ¥é”™â€œMaximum row versions reachedâ€ã€‚</p><pre><code class=\"language-go\">mysql&gt; alter table salaries add column cc int, algorithm=instant;\nERROR 4092 (HY000): Maximum row versions reached for table employees/salaries. No more columns can be added or dropped instantly. Please use COPY/INPLACE.\n</code></pre><p>æ¯æ‰§è¡Œä¸€æ¬¡Instant DDLï¼Œè¡¨çš„è¡Œç‰ˆæœ¬å°±ä¼šåŠ 1ï¼Œå½“è¡Œç‰ˆæœ¬è¾¾åˆ°64æ—¶ï¼Œå°±æ— æ³•å†å¯¹è¿™ä¸ªè¡¨æ‰§è¡ŒInstant DDLäº†ã€‚ä»information_schema.innodb_tablesè¿™ä¸ªç³»ç»Ÿè¡¨ä¸­ï¼Œå¯ä»¥æŸ¥çœ‹è¡¨å½“å‰çš„è¡Œç‰ˆæœ¬æ•°ã€‚</p><pre><code class=\"language-go\">mysql&gt; select * from information_schema.innodb_tables where name = 'employees/salaries'\\G\n*************************** 1. row ***************************\n          TABLE_ID: 1510\n              NAME: employees/salaries\n              FLAG: 33\n            N_COLS: 8\n             SPACE: 243\n        ROW_FORMAT: Dynamic\n     ZIP_PAGE_SIZE: 0\n        SPACE_TYPE: Single\n      INSTANT_COLS: 0\nTOTAL_ROW_VERSIONS: 64\n1 row in set (0.00 sec)\n</code></pre><p>è¾¾åˆ°è¡Œç‰ˆæœ¬é™åˆ¶åï¼Œä½ å°±åªèƒ½ä½¿ç”¨inplaceæˆ–copyçš„æ–¹å¼åŠ å­—æ®µäº†ã€‚</p><pre><code class=\"language-go\">mysql&gt;  alter table salaries add column cc int, algorithm=inplace;\nQuery OK, 0 rows affected (4.96 sec)\nRecords: 0  Duplicates: 0  Warnings: 0\n</code></pre><p>ä»¥inplaceæˆ–copyçš„æ–¹å¼æ‰§è¡Œè¿‡åï¼Œè¡¨çš„è¡Œç‰ˆæœ¬æ•°ä¼šæ¸…é›¶ï¼Œç„¶åä½ å°±å¯ä»¥ç»§ç»­å¼€å¿ƒåœ°ä½¿ç”¨instant DDLäº†ã€‚</p><pre><code class=\"language-go\">mysql&gt;  alter table salaries add column d10 int, algorithm=instant;\nQuery OK, 0 rows affected (0.02 sec)\nRecords: 0  Duplicates: 0  Warnings: 0\n\nmysql&gt;  alter table salaries add column d11 int, add column d12 int, algorithm=instant;\nQuery OK, 0 rows affected (0.01 sec)\nRecords: 0  Duplicates: 0  Warnings: 0\n</code></pre><h3>Instant DDLæ˜¯æ€ä¹ˆå®ç°çš„</h3><p>é‚£ä¹ˆInstant DDLæ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿä¸ºä»€ä¹ˆè¦é™åˆ¶è¡Œç‰ˆæœ¬çš„æ•°é‡ï¼Ÿæ‰§è¡Œè¿‡Instant DDLçš„è¡¨ï¼ŒæŸ¥è¯¢æ•°æ®å’Œå†™å…¥æ•°æ®æ—¶æœ‰ä»€ä¹ˆç‰¹æ®Šçš„åœ°æ–¹å—ï¼Ÿè¿™å’ŒInnoDBçš„å…ƒæ•°æ®ï¼Œä»¥åŠInnoDBçš„è¡Œè®°å½•æ ¼å¼ç›¸å…³ã€‚</p><h4>InnoDBå…ƒæ•°æ®å­˜å‚¨</h4><p>å…ƒæ•°æ®ä¸­è®°å½•äº†ä¸€ä¸ªè¡¨æœ‰å“ªäº›å­—æ®µï¼Œè¿™äº›å­—æ®µçš„æ•°æ®ç±»å‹æ˜¯ä»€ä¹ˆï¼Œå­—æ®µçš„é¡ºåºæ˜¯æ€æ ·çš„ã€‚MySQL 8.0å°†å…ƒæ•°æ®å­˜å‚¨åœ¨ä¸€ç³»åˆ—çš„InnoDBè¡¨ä¸­ã€‚ä½ éœ€è¦ä½¿ç”¨Debugç‰ˆæœ¬çš„MySQLï¼Œå¹¶ä¸”è®¾ç½®ä¸€ä¸ªç‰¹æ®Šçš„ä¼šè¯å˜é‡åï¼Œæ‰èƒ½æŸ¥è¯¢è¿™äº›å…ƒæ•°æ®è¡¨ã€‚</p><p>æˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ªæµ‹è¯•è¡¨ï¼Œæ‰§è¡Œä¸€äº›instant DDLæ“ä½œï¼Œç„¶åå†æ¥çœ‹å…ƒæ•°æ®ä¸­æ˜¯æ€ä¹ˆè®°å½•çš„ã€‚</p><pre><code class=\"language-go\">create table t_instant(a int, b int, primary key(a));\nalter table t_instant add c varchar(30), algorithm=instant;\nalter table t_instant add c2 varchar(30), algorithm=instant;\nalter table t_instant drop b, algorithm=instant;\n\n\nmysql&gt;desc t_instant;\n+-------+-------------+------+-----+---------+-------+\n| Field | Type        | Null | Key | Default | Extra |\n+-------+-------------+------+-----+---------+-------+\n| a     | int         | NO   | PRI | NULL    |       |\n| c     | varchar(30) | YES  |     | NULL    |       |\n| c2    | varchar(30) | YES  |     | NULL    |       |\n+-------+-------------+------+-----+---------+-------+\n</code></pre><p>è¦æŸ¥çœ‹å…ƒæ•°æ®ï¼Œéœ€è¦ä½¿ç”¨Debugç‰ˆæœ¬çš„MySQLã€‚å®˜æ–¹æä¾›çš„äºŒè¿›åˆ¶åŒ…ä¸­åŒ…å«äº†Debugç‰ˆæœ¬çš„äºŒè¿›åˆ¶ã€‚ä½ åªéœ€è¦å°†mysqläºŒè¿›åˆ¶åŒ…ä¸­çš„bin/mysqldæ›¿æ¢æˆbin/mysqld-debugï¼Œå°†lib/pluginä¸‹çš„soæ–‡ä»¶éƒ½æ›¿æ¢æˆlib/plugin/debugä¸‹çš„soæ–‡ä»¶ï¼Œå†å¯åŠ¨MySQLå°±å¯ä»¥äº†ã€‚</p><p>ç™»å½•åˆ°Debugç‰ˆæœ¬çš„MySQLåï¼Œè®¾ç½®debugä¼šè¯å˜é‡ï¼Œç„¶åå°±å¯ä»¥è®¿é—®InnoDBçš„å…ƒæ•°æ®äº†ã€‚</p><pre><code class=\"language-go\">mysql&gt; SET SESSION debug='+d,skip_dd_table_access_check';\nQuery OK, 0 rows affected (0.01 sec)\n</code></pre><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å‰é¢åˆ›å»ºçš„é‚£ä¸ªæµ‹è¯•è¡¨t_instantçš„å…ƒæ•°æ®ã€‚</p><pre><code class=\"language-go\">mysql&gt; desc t_instant;\n+-------+-------------+------+-----+---------+-------+\n| Field | Type        | Null | Key | Default | Extra |\n+-------+-------------+------+-----+---------+-------+\n| a     | int         | NO   | PRI | NULL    |       |\n| c     | varchar(30) | YES  |     | NULL    |       |\n| c2    | varchar(30) | YES  |     | NULL    |       |\n+-------+-------------+------+-----+---------+-------+\n3 rows in set (0.01 sec)\n\nmysql&gt; select t2.name, t2.ordinal_position as ord_no, t2.se_private_data, \n    t2.hidden, t2.type, t2.char_length\nfrom mysql.tables t1, mysql.columns t2\nwhere t1.id = t2.table_id\nand t1.name = 't_instant';\n\n+--------------------------+--------+--------------------------------------------------------------+---------+---------------------+-------------+\n| name                     | ord_no | se_private_data                                              | hidden  | type                | char_length |\n+--------------------------+--------+--------------------------------------------------------------+---------+---------------------+-------------+\n| a                        |      1 | physical_pos=0;table_id=1086;                                | Visible | MYSQL_TYPE_LONG     |          11 |\n| c                        |      2 | default_null=1;physical_pos=4;table_id=1086;version_added=1; | Visible | MYSQL_TYPE_VARCHAR  |         120 |\n| c2                       |      3 | default_null=1;physical_pos=5;table_id=1086;version_added=2; | Visible | MYSQL_TYPE_VARCHAR  |         120 |\n| DB_TRX_ID                |      4 | physical_pos=1;table_id=1086;                                | SE      | MYSQL_TYPE_INT24    |           6 |\n| DB_ROLL_PTR              |      5 | physical_pos=2;table_id=1086;                                | SE      | MYSQL_TYPE_LONGLONG |           7 |\n| !hidden!_dropped_v3_p3_b |      6 | physical_pos=3;version_dropped=3;                            | SE      | MYSQL_TYPE_LONG     |          11 |\n+--------------------------+--------+--------------------------------------------------------------+---------+---------------------+-------------+\n</code></pre><p><img src=\"https://static001.geekbang.org/resource/image/93/2e/93167b503b79b14a79b999d910e1622e.png?wh=1852x340\" alt=\"å›¾ç‰‡\"></p><p>ä»å…ƒæ•°æ®ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªè¡¨å®é™…ä¸Šæœ‰6ä¸ªå­—æ®µï¼Œå…¶ä¸­æœ‰3ä¸ªå­—æ®µæ˜¯ä¸å¯è§çš„ï¼Œå¯¹ç”¨æˆ·å¯è§çš„æœ‰3ä¸ªå­—æ®µã€‚å…¶ä¸­å­—æ®µCæ˜¯åœ¨ç‰ˆæœ¬1ä¸­æ·»åŠ çš„ï¼Œå­—æ®µC2æ˜¯åœ¨ç‰ˆæœ¬2ä¸­æ·»åŠ çš„ï¼Œå­—æ®µBåœ¨ç‰ˆæœ¬3ä¸­è¢«åˆ é™¤äº†ã€‚</p><h4>InnoDBè¡Œæ ¼å¼</h4><p>åœ¨InnoDBæ•°æ®é¡µé¢ä¸­ï¼Œæ¯ä¸€è¡Œè®°å½•çš„å¤´éƒ¨ï¼Œæœ‰ä¸€ä¸ªæ ‡è¯†ä½ï¼Œç”¨æ¥æ ‡è®°è¿™è¡Œè®°å½•æ˜¯ä¸æ˜¯åœ¨INSTANT DDLä¹‹åå†™å…¥çš„ã€‚å¯¹äºINSTANT DDLä¹‹åå†™å…¥æˆ–ä¿®æ”¹è¿‡çš„è®°å½•ï¼Œè¿˜ä¼šæœ‰ä¸€ä¸ªversionå­—èŠ‚ï¼Œç”¨æ¥æ ‡è¯†è¿™è¡Œè®°å½•ä¿®æ”¹æ—¶ï¼Œè¡¨ç»“æ„çš„å¯¹åº”ç‰ˆæœ¬ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/e9/36/e91eb4e6d3a9cc5608d69ec8ed396836.jpg?wh=1692x345\" alt=\"å›¾ç‰‡\"></p><p>InnoDBåœ¨è§£ææ•°æ®é¡µä¸­çš„ä¸€è¡Œè®°å½•æ—¶ï¼Œå…ˆè·å–è®°å½•å¤´éƒ¨çš„ç‰ˆæœ¬ä¿¡æ¯ï¼Œå‡è®¾è¿™è¡Œè®°å½•çš„ç‰ˆæœ¬ä¸ºKï¼Œé‚£ä¹ˆåªéœ€ä»å…ƒæ•°æ®ä¸­æŸ¥å‡ºåœ¨ç‰ˆæœ¬Kæˆ–Kä¹‹å‰æ·»åŠ å¹¶ä¸”åœ¨ç‰ˆæœ¬Kä¹‹å‰è¿˜æ²¡æœ‰è¢«åˆ é™¤çš„å­—æ®µï¼Œæ ¹æ®è¿™ä¸ªå­—æ®µåˆ—è¡¨æ¥è§£æè¿™è¡Œè®°å½•ã€‚æœ€åï¼Œåœ¨è¿”å›è¿™è¡Œè®°å½•æ—¶ï¼Œéœ€è¦è¿‡æ»¤æ‰å½“å‰ä¸å¯è§çš„å­—æ®µã€‚</p><p>èƒ½ä»¥INSTANTæ–¹å¼æ‰§è¡ŒDDLçš„å‰æï¼Œæ˜¯è¿™ä¸ªDDLæ“ä½œä¸éœ€è¦ä¿®æ”¹å·²æœ‰æ•°æ®çš„è¡Œè®°å½•æ ¼å¼ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°±å¯ä»¥è¿™æ ·ç†è§£ï¼Œä¿®æ”¹å­—æ®µç±»å‹ä¸èƒ½ä»¥INSTANTçš„æ–¹å¼æ‰§è¡Œï¼Œå› ä¸ºä¸åŒçš„å­—æ®µç±»å‹ï¼Œæ•°æ®å­˜å‚¨æ ¼å¼æ˜¯ä¸ä¸€æ ·çš„ã€‚ä¿®æ”¹å­—æ®µæ˜¯å¦å¯ä»¥ä¸ºNULLï¼Œä¹Ÿä¸èƒ½ä»¥INSTANTçš„æ–¹å¼æ‰§è¡Œã€‚å› ä¸ºå¯¹äºå¯ä»¥ä¸ºNULLçš„å­—æ®µï¼Œè®°å½•å¤´éƒ¨æœ‰ä¸€ä¸ªå¯¹åº”çš„æ¯”ç‰¹ï¼Œç”¨æ¥æ ‡è®°è¿™ä¸ªåˆ—ä¸­å­˜å‚¨çš„æ•°æ®æ˜¯å¦ä¸ºNULLã€‚</p><p>å¯¹äºæšä¸¾ç±»å‹ï¼Œå¦‚æœåªæ˜¯å¾€ç±»å‹æœ€åæ·»åŠ æ–°çš„é€‰é¡¹ï¼Œå¹¶ä¸”æ–°åŠ çš„é€‰é¡¹ä¸ä¼šå¯¼è‡´å­—æ®µå­˜å‚¨é•¿åº¦å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆå°±å¯ä»¥ä½¿ç”¨INSTANT DDLã€‚å‡å°‘æšä¸¾å€¼ã€ä¿®æ”¹æšä¸¾å€¼çš„é¡ºåºã€å°†æ–°çš„æšä¸¾å€¼æ·»åŠ åˆ°å·²æœ‰åˆ—è¡¨çš„ä¸­é—´ï¼Œéƒ½æ— æ³•ä½¿ç”¨instant DDLã€‚</p><pre><code class=\"language-go\">mysql&gt; create table t_enum(a enum('A', 'B'));\nQuery OK, 0 rows affected (3.42 sec)\n\nmysql&gt; alter table t_enum modify a enum('A', 'B', 'C'), algorithm=instant;\nQuery OK, 0 rows affected (0.26 sec)\nRecords: 0  Duplicates: 0  Warnings: 0\n\nmysql&gt; alter table t_enum modify a enum('C', 'B', 'A'), algorithm=instant;\nERROR 1846 (0A000): ALGORITHM=INSTANT is not supported. Reason:\nNeed to rebuild the table to change column type. \nTry ALGORITHM=COPY/INPLACE.\n\nmysql&gt; alter table t_enum modify a enum('A', 'B', 'D', 'C'), algorithm=instant;\nERROR 1846 (0A000): ALGORITHM=INSTANT is not supported. Reason: \nNeed to rebuild the table to change column type. \nTry ALGORITHM=COPY/INPLACE.\n</code></pre><p>ä¿®æ”¹varcharç±»å‹çš„é•¿åº¦ä¸èƒ½ä½¿ç”¨INSTANT DDLã€‚å¦‚æœæ˜¯å¢åŠ é•¿åº¦ï¼Œå¹¶ä¸”é•¿åº¦åœ¨å˜æ›´å‰åéƒ½ä¸è¶…è¿‡255å­—èŠ‚ï¼Œæˆ–è€…é•¿åº¦åœ¨å˜æ›´å‰åéƒ½è¶…è¿‡255å­—èŠ‚ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨INPLACEçš„æ–¹å¼æ‰§è¡Œï¼Œåªéœ€è¦ä¿®æ”¹å…ƒæ•°æ®ã€‚å¦‚æœå˜æ›´å‰é•¿åº¦ä¸åˆ°255å­—èŠ‚ï¼Œå˜æ›´åé•¿åº¦è¶…è¿‡255å­—èŠ‚ï¼Œé‚£ä¹ˆå°±ä¸èƒ½ä½¿ç”¨INPLACEçš„æ–¹å¼æ‰§è¡Œäº†ï¼Œéœ€è¦ç”¨COPYçš„æ–¹å¼æ‰§è¡Œã€‚è¿™ä¸»è¦æ˜¯è·Ÿvarcharå­—æ®µçš„ç‰©ç†å­˜å‚¨æ ¼å¼æœ‰å…³ã€‚</p><p>ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œemployeesè¡¨ä½¿ç”¨äº†utf8mb4å­—ç¬¦é›†ï¼Œå°†last_nameæ”¹æˆvarchar(64)æ—¶ï¼Œé•¿åº¦è¶…è¿‡255å­—èŠ‚äº†ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨COPYçš„æ–¹å¼æ¥æ‰§è¡ŒDDLã€‚</p><pre><code class=\"language-go\">mysql&gt; desc employees;\n+------------+---------------+------+-----+---------+-------+\n| Field      | Type          | Null | Key | Default | Extra |\n+------------+---------------+------+-----+---------+-------+\n| emp_no     | int           | NO   | PRI | NULL    |       |\n| birth_date | date          | NO   |     | NULL    |       |\n| first_name | varchar(14)   | NO   |     | NULL    |       |\n| last_name  | varchar(16)   | NO   |     | NULL    |       |\n| gender     | enum('M','F') | NO   |     | NULL    |       |\n| hire_date  | date          | NO   |     | NULL    |       |\n+------------+---------------+------+-----+---------+-------+\n\nmysql&gt; alter table employees modify last_name varchar(64) not null, algorithm=inplace;\nERROR 1846 (0A000): ALGORITHM=INPLACE is not supported. Reason: Cannot change column type INPLACE. Try ALGORITHM=COPY.\n\n\nmysql&gt; alter table employees modify last_name varchar(64) not null, algorithm=copy;\nQuery OK, 300024 rows affected (1.38 sec)\nRecords: 300024  Duplicates: 0  Warnings: 0\n</code></pre><p>å­—æ®µé•¿åº¦è¶…è¿‡255å­—èŠ‚åï¼Œå†å¢åŠ é•¿åº¦å°±å¯ä»¥ä½¿ç”¨INPLACEæ–¹å¼æ‰§è¡Œï¼Œå¹¶ä¸”ä¸éœ€è¦é‡å»ºè¡¨ï¼Œæ‰§è¡Œé€Ÿåº¦å¾ˆå¿«ã€‚</p><pre><code class=\"language-go\">mysql&gt; alter table employees modify last_name varchar(128) not null, algorithm=inplace;\nQuery OK, 0 rows affected (0.02 sec)\nRecords: 0  Duplicates: 0  Warnings: 0\n</code></pre><p>å¦‚æœä½ è¦ç¼©å‡varcharå­—æ®µçš„é•¿åº¦ï¼Œé‚£ä¹ˆå°±åªèƒ½ä»¥COPYçš„æ–¹å¼æ‰§è¡ŒDDLäº†ã€‚å› ä¸ºç¼©å‡é•¿åº¦æ—¶ï¼Œè¡¨é‡Œé¢å·²æœ‰çš„æ•°æ®å¯èƒ½ä¼šè¶…é•¿ã€‚</p><pre><code class=\"language-go\">mysql&gt; alter table employees modify last_name varchar(100) not null, algorithm=inplace;\nERROR 1846 (0A000): ALGORITHM=INPLACE is not supported. Reason: Cannot change column type INPLACE. Try ALGORITHM=COPY.\n\n\nmysql&gt; alter table employees modify last_name varchar(10) not null, algorithm=inplace;\nERROR 1846 (0A000): ALGORITHM=INPLACE is not supported. Reason: Cannot change column type INPLACE. Try ALGORITHM=COPY.\n</code></pre><h2>æ€»ç»“</h2><p>è¿™ä¸€è®²ä¸­ï¼Œæˆ‘ä»¬è®¨è®ºçš„æ˜¯é€šå¸¸æ‰§è¡Œé€Ÿåº¦å¾ˆå¿«çš„è¿™ä¸€ç±»DDLï¼Œä¹Ÿå°±æ˜¯åªéœ€è¦ä¿®æ”¹å…ƒæ•°æ®çš„DDLã€‚Instant DDLæ˜¯MySQL 8.0å¢åŠ çš„å¿«é€ŸåŠ åˆ—ç‰¹æ€§ï¼Œå¯ä»¥å¿«é€Ÿåœ°ç»™å¤§è¡¨å¢åŠ å­—æ®µã€‚å½“ç„¶ï¼Œè¿˜æœ‰ä¸€äº›DDLï¼Œæ‰§è¡ŒæœŸé—´çš„å¼€é”€ä¼šæ¯”è¾ƒå¤§ï¼Œè¿™ä¸€è®²çš„ä¸‹ç¯‡ä¸­ï¼Œæˆ‘ä»¬å†æ¥è¯¦ç»†è®¨è®ºã€‚</p><h2>æ€è€ƒé¢˜</h2><p>åªä¿®æ”¹å…ƒæ•°æ®çš„DDLã€INSTANT DDLæ‰§è¡Œé€Ÿåº¦é€šå¸¸éƒ½å¾ˆå¿«ï¼Œä½†æ˜¯è¿™äº›DDLæ‰§è¡Œä¹Ÿæ˜¯éœ€è¦è·å–å…ƒæ•°æ®é”çš„ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š</p><ul>\n<li>ä¼šè¯1 å¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼Œæ‰§è¡Œä¸€ä¸ªselect for updateæ“ä½œã€‚</li>\n</ul><pre><code class=\"language-go\">mysql&gt; desc t_ddl;\n+-------+------+------+-----+---------+-------+\n| Field | Type | Null | Key | Default | Extra |\n+-------+------+------+-----+---------+-------+\n| a     | int  | NO   | PRI | NULL    |       |\n| b     | int  | YES  |     | NULL    |       |\n+-------+------+------+-----+---------+-------+\n2 rows in set (0.01 sec)\n\n\nmysql&gt; begin;\nQuery OK, 0 rows affected (0.00 sec)\n\nmysql&gt; select * from t_ddl limit 1 for update;\nEmpty set (1.12 sec)\n</code></pre><ul>\n<li>ä¼šè¯2 æ‰§è¡Œä¸€ä¸ªinstant DDLã€‚</li>\n</ul><pre><code class=\"language-go\">mysql&gt; alter table t_ddl add c int, algorithm=instant;\n</code></pre><ul>\n<li>ä¼šè¯3 æ‰§è¡Œä¸€ä¸ªæ™®é€šçš„selectæ“ä½œã€‚</li>\n</ul><pre><code class=\"language-go\">mysql&gt; select * from t_ddl limit 1;\n</code></pre><p>ä½ ä¼šå‘ç°ï¼Œä¼šè¯2å’Œä¼šè¯3éƒ½è¢«é˜»å¡äº†ã€‚ä»processlistå¯ä»¥çœ‹åˆ°ï¼Œå®ƒä»¬éƒ½åœ¨ç­‰å¾…å…ƒæ•°æ®é”ã€‚ï¼ˆè¾“å‡ºç»“æœåšäº†ç®€åŒ–ï¼‰</p><pre><code class=\"language-go\">mysql&gt; show processlist;\n+----+---------+------+---------------------------------+------------------------------------------------+\n| Id | Command | Time | State                           | Info                                           |\n+----+---------+------+---------------------------------+------------------------------------------------+\n|  8 | Sleep   |  116 |                                 | NULL                                           |\n| 11 | Query   |  105 | Waiting for table metadata lock | alter table t_ddl add c int, algorithm=instant |\n| 12 | Query   |   96 | Waiting for table metadata lock | select * from t_ddl limit 1                    |\n+----+---------+------+---------------------------------+------------------------------------------------+\n</code></pre><p>ä»performance_schema.metadata_locksä¹Ÿå¯ä»¥çœ‹åˆ°t_ddlè¡¨çš„å…ƒæ•°æ®æŒæœ‰å’Œè¯·æ±‚æƒ…å†µã€‚</p><pre><code class=\"language-go\">mysql&gt; select * from metadata_locks where object_name = 't_ddl';\n-------------+-------------------+-------------+-------------------+-----------------+\n OBJECT_NAME | LOCK_TYPE         | LOCK_STATUS | SOURCE            | OWNER_THREAD_ID |\n-------------+-------------------+-------------+-------------------+-----------------+\n t_ddl       | SHARED_WRITE      | GRANTED     | sql_parse.cc:6093 |              49 |\n t_ddl       | SHARED_UPGRADABLE | GRANTED     | sql_parse.cc:6093 |              50 |\n t_ddl       | EXCLUSIVE         | PENDING     | mdl.cc:3753       |              50 |\n t_ddl       | SHARED_READ       | PENDING     | sql_parse.cc:6093 |              51 |\n-------------+-------------------+-------------+-------------------+-----------------+\n</code></pre><p>è¿˜æœ‰å“ªäº›æƒ…å†µä¼šå¯¼è‡´DDLæ— æ³•è·å–åˆ°å…ƒæ•°æ®é”ï¼Ÿæ€ä¹ˆå¿«é€Ÿå®šä½åˆ°å…ƒæ•°æ®é”çš„é˜»å¡æºï¼Ÿ</p><p>æœŸå¾…ä½ çš„æ€è€ƒï¼Œæ¬¢è¿åœ¨ç•™è¨€åŒºä¸­ä¸æˆ‘äº¤æµã€‚å¦‚æœä»Šå¤©çš„è¯¾ç¨‹è®©ä½ æœ‰æ‰€æ”¶è·ï¼Œä¹Ÿæ¬¢è¿è½¬å‘ç»™æœ‰éœ€è¦çš„æœ‹å‹ã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼</p>","comments":[{"had_liked":false,"id":394274,"user_name":"å¶æ˜","can_delete":false,"product_type":"c1","uid":1412429,"ip_address":"æ±Ÿè‹","ucode":"D0B4B7660DA766","user_header":"https://static001.geekbang.org/account/avatar/00/15/8d/4d/992070e8.jpg","comment_is_top":false,"comment_ctime":1726299894,"is_pvip":false,"replies":[{"id":143132,"content":"è¿™ä¸ªç­”æ¡ˆå¾ˆå…¨é¢ã€‚\nğŸ‘ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3898827,"ctime":1726465696,"ip_address":"æµ™æ±Ÿ","comment_id":394274,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100799401,"comment_content":"è¿˜æœ‰å“ªäº›æƒ…å†µä¼šå¯¼è‡´ DDL æ— æ³•è·å–åˆ°å…ƒæ•°æ®é”ï¼Ÿ\n1ã€å¤§äº‹åŠ¡\n2ã€é•¿äº‹åŠ¡ï¼Œæ¯”å¦‚è€—æ—¶è¾ƒé•¿çš„æŸ¥è¯¢\n3ã€å¤‡ä»½\néœ€è¦æŒæœ‰ MDL é”åæ‰èƒ½æ‰§è¡Œçš„è¯­å¥ï¼Œéƒ½ä¼šé˜»å¡ DDLï¼Œå› ä¸ºå…¶ä»–ä¼šè¯æ— æ³•è·å–è¿™äº›è¯­å¥æ¶‰åŠåˆ°çš„è¡¨çš„ MDL å†™é”ï¼ˆMDL çš„è¯»é”å’Œå†™é”å†²çªï¼‰ã€‚\n\næ€ä¹ˆå¿«é€Ÿå®šä½åˆ°å…ƒæ•°æ®é”çš„é˜»å¡æºï¼Ÿ\nä»è§†å›¾ sys.schema_table_lock_waits ä¸­å¯ä»¥æ‰¾åˆ°é€ æˆé˜»å¡çš„æºå’Œè¢«é˜»å¡çš„çº¿ç¨‹ã€‚","like_count":1,"discussions":[{"author":{"id":3898827,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/7d/cb/fa3dae58.jpg","nickname":"ä¿Šè¾¾","note":"","ucode":"F79BF9651AD086","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":651194,"discussion_content":"è¿™ä¸ªç­”æ¡ˆå¾ˆå…¨é¢ã€‚\nğŸ‘ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1726465696,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":394268,"user_name":"123","can_delete":false,"product_type":"c1","uid":2662872,"ip_address":"æ–°åŠ å¡","ucode":"5A343B568B9524","user_header":"https://static001.geekbang.org/account/avatar/00/28/a1/d8/42252c48.jpg","comment_is_top":false,"comment_ctime":1726283827,"is_pvip":false,"replies":[{"id":143128,"content":"instant ddlåŠ åˆ—åï¼Œæ–°æ’å…¥æˆ–æ›´æ–°çš„æ•°æ®ï¼Œä¼šæŠŠæ–°åˆ—çš„å€¼å’Œä¸€è¡Œè®°å½•ä¸­çš„å…¶ä»–åˆ—å­˜æ”¾åœ¨ä¸€èµ·ã€‚\n\ninstant ddlåŠ åˆ—åï¼Œè¡¨é‡ŒåŸå…ˆå°±å­˜åœ¨çš„è®°å½•ï¼Œæ²¡æœ‰å­˜å‚¨æ–°åŠ çš„åˆ—ã€‚æŸ¥è¯¢æ—¶ï¼Œä»å…ƒæ•°æ®ä¸­è·å–æ–°åˆ—çš„é»˜è®¤å€¼ï¼Œå’ŒåŸå…ˆè®°å½•ä¸­çš„åˆ—ï¼Œä¸€èµ·è¿”å›ç»™å®¢æˆ·ç«¯ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3898827,"ctime":1726401576,"ip_address":"æµ™æ±Ÿ","comment_id":394268,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100799401,"comment_content":"è€å¸ˆï¼Œè¯·æ•™ä¸€ä¸ªé—®é¢˜ï¼š\nMySQL8 ä½¿ç”¨instant ddlçš„æ—¶å€™ï¼Œä¾‹å¦‚æ·»åŠ æ–°çš„åˆ—ï¼Œæ–°åˆ—çš„æ•°æ®æ˜¯é¢å¤–å­˜å‚¨çš„å—ï¼Ÿä¾‹å¦‚éœ€è¦ä¿®æ”¹èšç°‡ç´¢å¼•å’ŒäºŒçº§ç´¢å¼•ï¼Œéœ€è¦è·å–è¯¥æ•°æ®è¿”å›ç»™å®¢æˆ·ç«¯çš„æ—¶å€™å†é¢å¤–ä»å¦ä¸€ç§æ•°æ®ç»“æ„ä¸­è·å–ï¼Ÿ\n\n","like_count":1,"discussions":[{"author":{"id":3898827,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/7d/cb/fa3dae58.jpg","nickname":"ä¿Šè¾¾","note":"","ucode":"F79BF9651AD086","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":651176,"discussion_content":"instant ddlåŠ åˆ—åï¼Œæ–°æ’å…¥æˆ–æ›´æ–°çš„æ•°æ®ï¼Œä¼šæŠŠæ–°åˆ—çš„å€¼å’Œä¸€è¡Œè®°å½•ä¸­çš„å…¶ä»–åˆ—å­˜æ”¾åœ¨ä¸€èµ·ã€‚\n\ninstant ddlåŠ åˆ—åï¼Œè¡¨é‡ŒåŸå…ˆå°±å­˜åœ¨çš„è®°å½•ï¼Œæ²¡æœ‰å­˜å‚¨æ–°åŠ çš„åˆ—ã€‚æŸ¥è¯¢æ—¶ï¼Œä»å…ƒæ•°æ®ä¸­è·å–æ–°åˆ—çš„é»˜è®¤å€¼ï¼Œå’ŒåŸå…ˆè®°å½•ä¸­çš„åˆ—ï¼Œä¸€èµ·è¿”å›ç»™å®¢æˆ·ç«¯ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1726401577,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":394200,"user_name":"binzhang","can_delete":false,"product_type":"c1","uid":1647189,"ip_address":"ç¾å›½","ucode":"F2670F2EA24FAD","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q3auHgzwzM59PTNiaDASVicbVaeWBU1WKmOgyHcqVtl85nDwAqDicib1EUKE2RRoU0x0vZctZO4kbPDUTTke8qKfAw/132","comment_is_top":false,"comment_ctime":1726115658,"is_pvip":false,"replies":[{"id":143099,"content":"è¿™ä¸ªé—®é¢˜æå¾—éå¸¸å¥½ã€‚\n\ninnodb_lock_wait_timeoutæ˜¯è¡Œé”çš„è¶…æ—¶æ—¶é—´ã€‚\nä½ å¯èƒ½æ˜¯æƒ³è®¾ç½®lock_wait_timeoutï¼Œè¿™æ˜¯metadata lockçš„è¶…æ—¶æ—¶é—´ã€‚\n\næ‰§è¡Œddlå‰è®¾ç½®lock_wait_timeoutæ˜¯æ¯”è¾ƒå®‰å…¨çš„ä¸€ç§åšæ³•ï¼Œå¯ä»¥é¿å…DDLé•¿æ—¶é—´ç­‰å¾…metadataé”è€Œå½±å“å…¶ä»–DMLè¯­å¥ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3898827,"ctime":1726208962,"ip_address":"æµ™æ±Ÿ","comment_id":394200,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100799401,"comment_content":"is it a best practice to execute &quot;SET innodb_lock_wait_timeout = 1;&quot; before execute any DDL?","like_count":1,"discussions":[{"author":{"id":3898827,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/7d/cb/fa3dae58.jpg","nickname":"ä¿Šè¾¾","note":"","ucode":"F79BF9651AD086","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":651089,"discussion_content":"è¿™ä¸ªé—®é¢˜æå¾—éå¸¸å¥½ã€‚\n\ninnodb_lock_wait_timeoutæ˜¯è¡Œé”çš„è¶…æ—¶æ—¶é—´ã€‚\nä½ å¯èƒ½æ˜¯æƒ³è®¾ç½®lock_wait_timeoutï¼Œè¿™æ˜¯metadata lockçš„è¶…æ—¶æ—¶é—´ã€‚\n\næ‰§è¡Œddlå‰è®¾ç½®lock_wait_timeoutæ˜¯æ¯”è¾ƒå®‰å…¨çš„ä¸€ç§åšæ³•ï¼Œå¯ä»¥é¿å…DDLé•¿æ—¶é—´ç­‰å¾…metadataé”è€Œå½±å“å…¶ä»–DMLè¯­å¥ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1726208962,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":394956,"user_name":"é»‘å¾®ç‹—â€®â€®","can_delete":false,"product_type":"c1","uid":1177797,"ip_address":"æµ™æ±Ÿ","ucode":"D44505E7E97BB3","user_header":"https://static001.geekbang.org/account/avatar/00/11/f8/c5/6d38f3e3.jpg","comment_is_top":false,"comment_ctime":1728906844,"is_pvip":false,"replies":[{"id":143409,"content":"è¿™ä¸ªé—®é¢˜æå¾—éå¸¸å¥½ã€‚\n\næˆ‘å†æ¬¡çœ‹äº†ä¸‹åº”ç”¨row_logçš„è¿™éƒ¨åˆ†ä»£ç ï¼ˆrow_log_table_applyå’Œrow_log_applyè¿™ä¸¤ä¸ªå‡½æ•°ï¼‰ï¼Œ\nåº”ç”¨row_logæ—¶ï¼Œå¦‚æœå½“å‰å¤„ç†çš„ä¸æ˜¯æœ€åä¸€ä¸ªblockï¼Œä¼šå…ˆé‡Šæ”¾ä¸»é”®æˆ–ç´¢å¼•ä¸Šçš„xé”ï¼ˆrw_lock_x_unlockï¼‰ã€‚\n\nåœ¨å¤„ç†æœ€åä¸€ä¸ªblockæ—¶ï¼Œä¼šå¯¹ä¸»é”®æˆ–ç´¢å¼•åŠ é”ï¼ˆrw_lock_x_lockï¼‰ï¼Œç„¶åå†åº”ç”¨row_logã€‚\n\nè¿™é‡Œçš„é”ï¼Œæ˜¯ç´¢å¼•å†…å­˜ç»“æ„ä¸Šçš„è¯»å†™é”ï¼ˆstruct dict_index_t { rw_lock_t lock }ï¼‰ã€‚\n\næ–‡ç« ä¸­å¯¹åº”ç”¨row_logæ—¶çš„åŠ é”ï¼Œæè¿°çš„ä¸å¤ªå‡†ç¡®ã€‚\n\næ„Ÿè°¢æŒ‡æ­£ï¼Œä¹Ÿè§£å†³äº†æˆ‘åŸå…ˆçš„ä¸€ä¸ªç–‘é—®ã€‚ğŸ«¡ğŸ«¡","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3898827,"ctime":1728976399,"ip_address":"æµ™æ±Ÿ","comment_id":394956,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100799401,"comment_content":"è€å¸ˆéº»çƒ¦é—®ä¸‹ï¼Œç½‘ä¸Šçœ‹çš„æ–‡ç« å¯¹äºINPLACEæ‰§è¡Œæµç¨‹çš„æè¿°ï¼Œå…³äºé‡Œé¢row_logçš„åº”ç”¨ï¼Œæƒ³é—®ä¸‹ï¼Œåœ¨executioné˜¶æ®µåŒæ—¶åœ¨åº”ç”¨row_logåˆ°æ–°è¡¨ï¼Œæœ€åcommité˜¶æ®µåªåº”ç”¨æœ€åä¸€ä¸ªblockã€‚è¿˜æ˜¯æ‰€æœ‰çš„row_logéƒ½æ˜¯åœ¨commité˜¶æ®µåº”ç”¨çš„å‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":3898827,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/7d/cb/fa3dae58.jpg","nickname":"ä¿Šè¾¾","note":"","ucode":"F79BF9651AD086","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":652458,"discussion_content":"è¿™ä¸ªé—®é¢˜æå¾—éå¸¸å¥½ã€‚\n\næˆ‘å†æ¬¡çœ‹äº†ä¸‹åº”ç”¨row_logçš„è¿™éƒ¨åˆ†ä»£ç ï¼ˆrow_log_table_applyå’Œrow_log_applyè¿™ä¸¤ä¸ªå‡½æ•°ï¼‰ï¼Œ\nåº”ç”¨row_logæ—¶ï¼Œå¦‚æœå½“å‰å¤„ç†çš„ä¸æ˜¯æœ€åä¸€ä¸ªblockï¼Œä¼šå…ˆé‡Šæ”¾ä¸»é”®æˆ–ç´¢å¼•ä¸Šçš„xé”ï¼ˆrw_lock_x_unlockï¼‰ã€‚\n\nåœ¨å¤„ç†æœ€åä¸€ä¸ªblockæ—¶ï¼Œä¼šå¯¹ä¸»é”®æˆ–ç´¢å¼•åŠ é”ï¼ˆrw_lock_x_lockï¼‰ï¼Œç„¶åå†åº”ç”¨row_logã€‚\n\nè¿™é‡Œçš„é”ï¼Œæ˜¯ç´¢å¼•å†…å­˜ç»“æ„ä¸Šçš„è¯»å†™é”ï¼ˆstruct dict_index_t { rw_lock_t lock }ï¼‰ã€‚\n\næ–‡ç« ä¸­å¯¹åº”ç”¨row_logæ—¶çš„åŠ é”ï¼Œæè¿°çš„ä¸å¤ªå‡†ç¡®ã€‚\n\næ„Ÿè°¢æŒ‡æ­£ï¼Œä¹Ÿè§£å†³äº†æˆ‘åŸå…ˆçš„ä¸€ä¸ªç–‘é—®ã€‚ğŸ«¡ğŸ«¡","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1728976399,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":394358,"user_name":"TheOne","can_delete":false,"product_type":"c1","uid":1582134,"ip_address":"åŒ—äº¬","ucode":"2A359780156A8B","user_header":"https://static001.geekbang.org/account/avatar/00/18/24/36/0829cbdc.jpg","comment_is_top":false,"comment_ctime":1726622329,"is_pvip":false,"replies":[{"id":143148,"content":"é—®é¢˜1. ä¿®æ”¹æ•°æ®ç±»å‹ä¼šæ”¹å˜æ•°æ®çš„å­˜å‚¨æ ¼å¼ï¼Œå› æ­¤instant ddlä¸æ”¯æŒã€‚åˆ é™¤å­—æ®µæ—¶ï¼Œä¸åŠ¨è€çš„æ•°æ®ï¼Œåªè¦åœ¨è§£æè¡Œè®°å½•æ—¶ï¼ŒæŠŠå·²åˆ é™¤å­—æ®µçš„æ•°æ®å¿½ç•¥æ‰å°±è¡Œã€‚\nå…ˆåˆ é™¤å­—æ®µï¼Œå†å¢åŠ å­—æ®µï¼Œå’Œä¿®æ”¹æ•°æ®ç±»å‹æ˜¯ä¸ä¸€æ ·çš„ã€‚ä¿®æ”¹æ•°æ®ç±»å‹ä¼šä¿ç•™å­—æ®µåŸå…ˆçš„æ•°æ®ã€‚\n\né—®é¢˜2. åˆ é™¤å­—æ®µåï¼Œæ›´æ–°äº†å…ƒæ•°æ®ä¸­å­—æ®µå¯¹åº”çš„é‚£ä¸€è¡Œè®°å½•ã€‚\næ¯”å¦‚å­—æ®µbè¢«æ”¹åä¸º!hidden!_dropped_v3_p3_b\n\né—®é¢˜3. å¦‚æœå­—æ®µä¸Šæœ‰ç´¢å¼•ï¼Œå°±ä¸æ”¯æŒä½¿ç”¨instant ddlåˆ é™¤å­—æ®µäº†ã€‚\nåˆ é™¤æœ‰ç´¢å¼•çš„å­—æ®µï¼Œç›¸å½“äºè¦åšå‡ ä¸ªæ“ä½œ\na) åˆ é™¤åŒ…å«è¯¥å­—æ®µçš„ç´¢å¼•\nb) é‡å»ºç´¢å¼•ï¼Œä½†æ˜¯è¦å»æ‰å¾…åˆ é™¤çš„å­—æ®µ\nc) åˆ é™¤å­—æ®µ\nå¦‚æœæ¶‰åŠåˆ°é‡å»ºç´¢å¼•ï¼Œé‚£ä¹ˆè¡¨æ¯”è¾ƒå¤§æ—¶ï¼ŒDDLå°±ä¼šæ¯”è¾ƒæ…¢äº†ã€‚\n","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3898827,"ctime":1726641434,"ip_address":"æµ™æ±Ÿ","comment_id":394358,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100799401,"comment_content":"è€å¸ˆæœ‰å‡ ä¸ªé—®é¢˜æƒ³é—®ä¸‹\n1. å¢åŠ å’Œåˆ é™¤å­—æ®µï¼Œå¯ä»¥é€šè¿‡ instant æ–¹å¼è¿›è¡Œï¼Œä½†æ˜¯ä¿®æ”¹å­—æ®µæ•°æ®ç±»å‹ä¸è¡Œï¼Œæ˜¯å› ä¸ºä¿®æ”¹çš„æ—¶å€™æ¶‰åŠåˆ°æ—§æ•°æ®å—ï¼Ÿä½†æ˜¯åˆ é™¤çš„æ—¶å€™ï¼Œä¹Ÿæ¶‰åŠåˆ°æ—§æ•°æ®å§ï¼Œè¿™é‡Œçš„ä¿®æ”¹æ–¹æ¡ˆå¦‚æœæ˜¯å…ˆåˆ é™¤ï¼Œå†æ–°å¢æ˜¯ä¸æ˜¯ä¹Ÿèƒ½ç”¨ä¸Š instantï¼Ÿ\n\n2.è¡¨ t_instant å…¶å®ä¸€å…±æ“ä½œäº†4ä¸ªå­—æ®µ(aï¼Œbï¼Œcï¼Œc2)ï¼Œä½†æ˜¯å…ƒæ•°æ®é‡Œæœ‰6ä¸ªå­—æ®µï¼Œå¯¹äº add å­—æ®µæ¥è¯´ï¼Œåº”è¯¥ä¼šåœ¨åŸæ•°æ®é‡ŒåŠ ä¸€æ¡ï¼Œä½†æ˜¯åˆ é™¤å­—æ®µçš„æ—¶å€™ï¼Œæ˜¯åœ¨åŸæ¥çš„è¡Œä¸Šåšä¿®æ”¹ï¼Œè¿˜æ˜¯æ–°å¢ä¸€æ¡å‘¢ï¼Ÿ\næˆ‘çœ‹æ‚¨çš„äº‹ä¾‹æ˜¯åœ¨æœ€åæ–°å¢äº†ä¸€æ¡åˆ é™¤çš„è®°å½•ï¼Œç„¶å b å­—æ®µæ¶ˆå¤±äº†\n\n3. åˆ é™¤å­—æ®µè¿™ç§æ“ä½œï¼Œç´¢å¼•é‡Œé¢çš„æ•°æ®ä¼šä¸€èµ·åˆ æ‰å§ï¼Ÿå‡å¦‚è¡¨å¾ˆå¤§çš„è¯ï¼Œæ˜¯ä¸æ˜¯ä¹Ÿä¼šæ¯”è¾ƒæ…¢å‘¢ï¼Œæ¯”å¦‚ 500 ä¸‡","like_count":0,"discussions":[{"author":{"id":3898827,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/7d/cb/fa3dae58.jpg","nickname":"ä¿Šè¾¾","note":"","ucode":"F79BF9651AD086","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":651259,"discussion_content":"é—®é¢˜1. ä¿®æ”¹æ•°æ®ç±»å‹ä¼šæ”¹å˜æ•°æ®çš„å­˜å‚¨æ ¼å¼ï¼Œå› æ­¤instant ddlä¸æ”¯æŒã€‚åˆ é™¤å­—æ®µæ—¶ï¼Œä¸åŠ¨è€çš„æ•°æ®ï¼Œåªè¦åœ¨è§£æè¡Œè®°å½•æ—¶ï¼ŒæŠŠå·²åˆ é™¤å­—æ®µçš„æ•°æ®å¿½ç•¥æ‰å°±è¡Œã€‚\nå…ˆåˆ é™¤å­—æ®µï¼Œå†å¢åŠ å­—æ®µï¼Œå’Œä¿®æ”¹æ•°æ®ç±»å‹æ˜¯ä¸ä¸€æ ·çš„ã€‚ä¿®æ”¹æ•°æ®ç±»å‹ä¼šä¿ç•™å­—æ®µåŸå…ˆçš„æ•°æ®ã€‚\n\né—®é¢˜2. åˆ é™¤å­—æ®µåï¼Œæ›´æ–°äº†å…ƒæ•°æ®ä¸­å­—æ®µå¯¹åº”çš„é‚£ä¸€è¡Œè®°å½•ã€‚\næ¯”å¦‚å­—æ®µbè¢«æ”¹åä¸º!hidden!_dropped_v3_p3_b\n\né—®é¢˜3. å¦‚æœå­—æ®µä¸Šæœ‰ç´¢å¼•ï¼Œå°±ä¸æ”¯æŒä½¿ç”¨instant ddlåˆ é™¤å­—æ®µäº†ã€‚\nåˆ é™¤æœ‰ç´¢å¼•çš„å­—æ®µï¼Œç›¸å½“äºè¦åšå‡ ä¸ªæ“ä½œ\na) åˆ é™¤åŒ…å«è¯¥å­—æ®µçš„ç´¢å¼•\nb) é‡å»ºç´¢å¼•ï¼Œä½†æ˜¯è¦å»æ‰å¾…åˆ é™¤çš„å­—æ®µ\nc) åˆ é™¤å­—æ®µ\nå¦‚æœæ¶‰åŠåˆ°é‡å»ºç´¢å¼•ï¼Œé‚£ä¹ˆè¡¨æ¯”è¾ƒå¤§æ—¶ï¼ŒDDLå°±ä¼šæ¯”è¾ƒæ…¢äº†ã€‚\n","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1726641434,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":394179,"user_name":"Shelly","can_delete":false,"product_type":"c1","uid":2422713,"ip_address":"å¹¿ä¸œ","ucode":"75BA35C2737EA6","user_header":"https://static001.geekbang.org/account/avatar/00/24/f7/b9/f2eec64e.jpg","comment_is_top":false,"comment_ctime":1726046177,"is_pvip":false,"replies":[{"id":143087,"content":"å¯¹çš„ï¼Œå¯ä»¥é€šè¿‡metadata_locksæ¥æŸ¥ã€‚ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3898827,"ctime":1726056676,"ip_address":"æµ™æ±Ÿ","comment_id":394179,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100799401,"comment_content":"ç¡®å®šå…ƒæ•°æ®é”é˜»å¡æºï¼Œæ ¹æ®ç›¸å…³è¡¨å…³è”æŸ¥è¯¢ï¼š\nmysql&gt; SELECT \n    -&gt;     p.id AS ID,\n    -&gt;     p.user as USER,\n    -&gt;     t.PROCESSLIST_DB AS DB_NAME,\n    -&gt;     m.OBJECT_NAME AS TABLE_NAME,\n    -&gt;     t.PROCESSLIST_TIME AS SPEND_TIME,\n    -&gt;     t.PROCESSLIST_INFO AS SQL_TEXT,\n    -&gt;     m.LOCK_TYPE AS LOCK_TYPE,\n    -&gt;     m.LOCK_STATUS as LOCK_STATUS  \n    -&gt; FROM \n    -&gt;     information_schema.processlist p \n    -&gt; JOIN \n    -&gt;     performance_schema.threads t \n    -&gt; ON \n    -&gt;     p.id=t.PROCESSLIST_ID \n    -&gt; JOIN \n    -&gt;     performance_schema.metadata_locks m \n    -&gt; ON \n    -&gt;     m.OWNER_THREAD_ID=t.THREAD_ID \n    -&gt; WHERE \n    -&gt;     m.OBJECT_SCHEMA=&#39;test1&#39; and m.OBJECT_NAME=&#39;t_ddl&#39;\\G\n*************************** 1. row ***************************\n         ID: 52\n       USER: root\n    DB_NAME: test1\n TABLE_NAME: t_ddl\n SPEND_TIME: 1176\n   SQL_TEXT: alter table t_ddl add c int, algorithm=instant\n  LOCK_TYPE: SHARED_UPGRADABLE\nLOCK_STATUS: GRANTED\n*************************** 2. row ***************************\n         ID: 52\n       USER: root\n    DB_NAME: test1\n TABLE_NAME: t_ddl\n SPEND_TIME: 1176\n   SQL_TEXT: alter table t_ddl add c int, algorithm=instant\n  LOCK_TYPE: EXCLUSIVE\nLOCK_STATUS: PENDING\n*************************** 3. row ***************************\n         ID: 54\n       USER: root\n    DB_NAME: test1\n TABLE_NAME: t_ddl\n SPEND_TIME: 1146\n   SQL_TEXT: select * from t_ddl limit 1\n  LOCK_TYPE: SHARED_READ\nLOCK_STATUS: PENDING\n*************************** 4. row ***************************\n         ID: 55\n       USER: root\n    DB_NAME: test1\n TABLE_NAME: t_ddl\n SPEND_TIME: 1187\n   SQL_TEXT: select * from t_ddl limit 1 for update\n  LOCK_TYPE: SHARED_WRITE\nLOCK_STATUS: GRANTED\n4 rows in set (0.02 sec)\n\nå¯ä»¥æŸ¥çœ‹åˆ°é˜»å¡æºæ˜¯select * from t_ddl limit 1 for updateï¼Œkill 55æ€æ‰é˜»å¡æºã€‚","like_count":0,"discussions":[{"author":{"id":3898827,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/7d/cb/fa3dae58.jpg","nickname":"ä¿Šè¾¾","note":"","ucode":"F79BF9651AD086","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":651005,"discussion_content":"å¯¹çš„ï¼Œå¯ä»¥é€šè¿‡metadata_locksæ¥æŸ¥ã€‚ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1726056676,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":394176,"user_name":"Geek_0126","can_delete":false,"product_type":"c1","uid":3952196,"ip_address":"æµ™æ±Ÿ","ucode":"2916F7FB3F6D71","user_header":"https://static001.geekbang.org/account/avatar/00/3c/4e/44/49b29792.jpg","comment_is_top":false,"comment_ctime":1726042199,"is_pvip":false,"replies":[{"id":143088,"content":"æ˜¯çš„ã€‚æ…¢æŸ¥è¯¢å’Œæœªæäº¤çš„äº‹åŠ¡ï¼Œéƒ½æ˜¯metadata lockçš„é˜»å¡æºã€‚ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3898827,"ctime":1726056759,"ip_address":"æµ™æ±Ÿ","comment_id":394176,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100799401,"comment_content":"æœ‰æ…¢æŸ¥è¯¢æˆ–è€…å…¶ä»–äº‹åŠ¡å ç”¨æ­¤è¡¨æ—¶ï¼Œä¼šå¯¼è‡´DDLæ— æ³•è·å–å…ƒæ•°æ®é”ã€‚ä¸€èˆ¬å¯ä»¥é€šè¿‡æŸ¥çœ‹æ´»è·ƒé“¾æ¥åŠäº‹åŠ¡åˆ—è¡¨æ¥ç¡®å®šé˜»å¡æºã€‚","like_count":0,"discussions":[{"author":{"id":3898827,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/7d/cb/fa3dae58.jpg","nickname":"ä¿Šè¾¾","note":"","ucode":"F79BF9651AD086","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":651006,"discussion_content":"æ˜¯çš„ã€‚æ…¢æŸ¥è¯¢å’Œæœªæäº¤çš„äº‹åŠ¡ï¼Œéƒ½æ˜¯metadata lockçš„é˜»å¡æºã€‚ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1726056759,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]}]}