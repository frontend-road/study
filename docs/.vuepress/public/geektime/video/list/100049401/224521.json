{"id":224521,"title":"13 | 动态路由：用Virtual Service和Destination Rule设置路由规则","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/geektime-servicemesh\">https://gitee.com/geektime-geekbang/geektime-servicemesh</a></p>","comments":[{"had_liked":false,"id":255871,"user_name":"写给三月","can_delete":false,"product_type":"c3","uid":1214026,"ip_address":"","ucode":"F9DCF7C9B76AC5","user_header":"https://static001.geekbang.org/account/avatar/00/12/86/4a/0370f832.jpg","comment_is_top":false,"comment_ctime":1603447457,"is_pvip":false,"replies":[{"id":93495,"content":"可以把这个hosts字段理解为是一个外键，它负责把gateway和vs、vs和dr连接起来。\n比如你在gateway里host配置为 www.example.com, 那么当你访问这个url时请求就会找配置了同样host的vs，根据它的路由信息去分发请求。","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1603781137,"ip_address":"","comment_id":255871,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"老师，我现在卡在 gateway中 hosts  VS中的hosts  host   DR 的host 乱套了，让我彻底迷糊了，能特意去讲讲这几个host干什么用的吗？有点晕","like_count":5,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":507857,"discussion_content":"可以把这个hosts字段理解为是一个外键，它负责把gateway和vs、vs和dr连接起来。\n比如你在gateway里host配置为 www.example.com, 那么当你访问这个url时请求就会找配置了同样host的vs，根据它的路由信息去分发请求。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1603781137,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1214026,"avatar":"https://static001.geekbang.org/account/avatar/00/12/86/4a/0370f832.jpg","nickname":"写给三月","note":"","ucode":"F9DCF7C9B76AC5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":323581,"discussion_content":"和下面同学的问题串起来，我懂了，谢谢老师","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604970645,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":213543,"user_name":"V V","can_delete":false,"product_type":"c3","uid":1220390,"ip_address":"","ucode":"9494330A6AA770","user_header":"https://static001.geekbang.org/account/avatar/00/12/9f/26/89eda2c8.jpg","comment_is_top":false,"comment_ctime":1588469983,"is_pvip":false,"replies":[{"id":79331,"content":"这是 VirtualService hosts的官方说明：The destination hosts to which traffic is being sent. Could be a DNS name with wildcard prefix or an IP address. \n\n这是 DestinationRule host的说明：The name of a service from the service registry. Service names are looked up from the platform’s service registry (e.g., Kubernetes services, Consul services, etc.) \n\n简单来说就是，VS里的hosts指向的就是DR的host；DR的host设置的是底层平台（如k8s）的service名称，因为最终是需要利用平台的dns来把请求导向目的地的。\n这种用2个api资源设计的目的之一就是各司其职，VS负责配置路由信息，DR负责配置目标和策略。","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1588694990,"ip_address":"","comment_id":213543,"utype":1}],"discussion_count":4,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"老师，你讲到“虚拟服务中 hosts是用来设置目标地址”？拿它和目标规则中的host 的作用有什么区别？","like_count":5,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493808,"discussion_content":"这是 VirtualService hosts的官方说明：The destination hosts to which traffic is being sent. Could be a DNS name with wildcard prefix or an IP address. \n\n这是 DestinationRule host的说明：The name of a service from the service registry. Service names are looked up from the platform’s service registry (e.g., Kubernetes services, Consul services, etc.) \n\n简单来说就是，VS里的hosts指向的就是DR的host；DR的host设置的是底层平台（如k8s）的service名称，因为最终是需要利用平台的dns来把请求导向目的地的。\n这种用2个api资源设计的目的之一就是各司其职，VS负责配置路由信息，DR负责配置目标和策略。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588694990,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":3,"child_discussions":[{"author":{"id":1567014,"avatar":"https://static001.geekbang.org/account/avatar/00/17/e9/26/472e16e4.jpg","nickname":"Amosヾ","note":"","ucode":"833F6FCB4042AD","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":552916,"discussion_content":"老师，如果vs中route的host配置了reviews，但是没有名为reviews的dr，会直接去找k8s的svc吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1645632538,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":493808,"ip_address":"","group_id":0},"score":552916,"extra":""},{"author":{"id":1195278,"avatar":"https://static001.geekbang.org/account/avatar/00/12/3d/0e/92176eaa.jpg","nickname":"左氧佛沙星人","note":"","ucode":"0D8295E1DABA8C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":575123,"discussion_content":"难道策略不是在vs设置的吗？  http:\n  - match:\n    - headers:\n        end-user:\n          regex: .*","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1654603439,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":493808,"ip_address":"","group_id":0},"score":575123,"extra":""},{"author":{"id":1195278,"avatar":"https://static001.geekbang.org/account/avatar/00/12/3d/0e/92176eaa.jpg","nickname":"左氧佛沙星人","note":"","ucode":"0D8295E1DABA8C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1567014,"avatar":"https://static001.geekbang.org/account/avatar/00/17/e9/26/472e16e4.jpg","nickname":"Amosヾ","note":"","ucode":"833F6FCB4042AD","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":575125,"discussion_content":"我理解不会，如果配置了vs，没有配置dr，vs是生效的，会继续找dr的host，则会发生404或者502/504等","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1654603679,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":552916,"ip_address":"","group_id":0},"score":575125,"extra":""}]}]},{"had_liked":false,"id":270113,"user_name":"无敌小贝塔","can_delete":false,"product_type":"c3","uid":1177175,"ip_address":"","ucode":"5F12AA01DDCBB1","user_header":"https://static001.geekbang.org/account/avatar/00/11/f6/57/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1608913081,"is_pvip":false,"replies":[{"id":98234,"content":"1. 对\n2. 如果我们没有对reviews服务添加路由配置（Virtualservice），那它就使用k8s默认的负载均衡轮询选择版本（本质上是选择同一个服务的不同的pod，因为productpage是通过service name的方式，即reviews.default.svc.cluster.local访问的)，如果你添加了VS，并指定了subset，那它就会根据你定义的路由去选择对应版本的pod，这也就是Istio控制流量的主要方式。","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1609249290,"ip_address":"","comment_id":270113,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"老师你好，我有一个概念有点没太理解：\n在课程12中讲到这个book demo搭建完毕后，每一个deployment的Pod里会自动生成相对应的istio proxy（envoy），所以相对应的规则最后都应该落在这些proxy上去执行然后在发给对应的实际服务；\n在课程13中我们在创建 VirtualService和 DestinationRule等这些对象后，我的理解istiod应该把这些配置自动下发到各自对应的istio proxy中去，在demo的展示中我理解的是系统就自动把这些内容通过API下发给对应的review V1 pod中的istio proxy(问题1：不知道我这么理解是否正确）\n问题2：在review这个服务上，有三个不同版本的pod,这些pod里面各自有一个istio proxy，前端productpage怎么知道它访问的是V1版本的istio proxy呢？\n期盼老师的回复，感谢。","like_count":4,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":512523,"discussion_content":"1. 对\n2. 如果我们没有对reviews服务添加路由配置（Virtualservice），那它就使用k8s默认的负载均衡轮询选择版本（本质上是选择同一个服务的不同的pod，因为productpage是通过service name的方式，即reviews.default.svc.cluster.local访问的)，如果你添加了VS，并指定了subset，那它就会根据你定义的路由去选择对应版本的pod，这也就是Istio控制流量的主要方式。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609249290,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1177175,"avatar":"https://static001.geekbang.org/account/avatar/00/11/f6/57/abb7bfe3.jpg","nickname":"无敌小贝塔","note":"","ucode":"5F12AA01DDCBB1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":338587,"discussion_content":"谢谢老师，“如果你添加了VS，并指定了subset，那它就会根据你定义的路由去选择对应版本的pod”这个对应的配置会下发到reviews服务的3个pod中对应的envoy代理里，productpage发起对reviews的访问其实是访问的reviews的service地址，通过reviews的service地址请求最终会到达任意一个pod前端的envoy代理上，因为这三个代理都知道应该将请求发送给V1版本对应的POD，所以实现了路由控制，我这样的理解对吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609318877,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":271299,"user_name":"无敌小贝塔","can_delete":false,"product_type":"c3","uid":1177175,"ip_address":"","ucode":"5F12AA01DDCBB1","user_header":"https://static001.geekbang.org/account/avatar/00/11/f6/57/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1609518242,"is_pvip":false,"replies":[{"id":98470,"content":"1. 是的，全量下发。因为envoy彼此之间并不知道业务上的调用关系，所以需要获取到所有配置；\n2. envoy的转发比较复杂，牵扯listener、cluster、route等核心概念，你可以简单的理解为：envoy通过改写iptables规则做了流量劫持，productpage的出流量可以通过配置知道要发到哪个review pod。\ntips：\n可以参考这篇文章的分析\nhttps:&#47;&#47;www.servicemesher.com&#47;blog&#47;istio-traffic-management-impl-intro&#47;\n参考envoy配置可以通过 istioctl d envoy podname 查看config dump","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1609731865,"ip_address":"","comment_id":271299,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"老师您好，有一个逻辑点我觉得您没讲深，又或者我一直没get到这个点，比如你课程中demo里创建的4个VS和DR（配置我都是理解的），我的问题1：这4个VS会被下发到所有不同应用pod上的envoy代理（比如productpage的envoy代理，三个reviws pod的envoy代理，rating的envoy代理）还是只下发到其对应 Pod上的envoy代理上呢（比如创建的productpage的VS只下发到productpage的envoy上，review和rating的也是同理），我的理解是下发到所有pod上的envoy代理中，不知道该是怎么理解呢？我的理解是第一种全部envoy代理上有所有的配置策略。如果我怕理解错了是第二中的话那么之间是怎么关联起来对应的呢？谢谢。\n2 我理解的访问数据流是step1:productpage这个容器应用通过其对应的envoy代理去访问k8s下reviews对应发布的service cluster IP, step2:该 serviceIP通过kubeproxy（负载均衡）随机将请求发送至任意一个版本的review的pod（比如到达V3）, 因为在实际到达V3 review应用容器之前会先经过其对应的envoy容器代理,此时envoy容器代理识别出对应的配置比如通过end-user字段:是要发送给V2的，那么这个review v3 envoy 代理就会把请求转给V2对应的review pod，这个请求最终经过review 2 业务容器前端的envoy代理到达review2容器，这样理解对吗？\n我和几个朋友也做了讨论，大家好像都有一些困惑，所以想请老师针对上述问题做一个详细的答复，非常感谢您的帮助。\napiVersion: networking.istio.io&#47;v1alpha3\nkind: VirtualService\nmetadata:\n  name: reviews\nspec:\n  hosts:\n  - reviews\n  http:\n  - match:\n    - headers:\n        end-user:\n          regex: .*\n    route:\n    - destination:\n        host: reviews\n        subset: v2\n  - route:\n    - destination:\n        host: reviews\n        subset: v1","like_count":2,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":512893,"discussion_content":"1. 是的，全量下发。因为envoy彼此之间并不知道业务上的调用关系，所以需要获取到所有配置；\n2. envoy的转发比较复杂，牵扯listener、cluster、route等核心概念，你可以简单的理解为：envoy通过改写iptables规则做了流量劫持，productpage的出流量可以通过配置知道要发到哪个review pod。\ntips：\n可以参考这篇文章的分析\nhttps://www.servicemesher.com/blog/istio-traffic-management-impl-intro/\n参考envoy配置可以通过 istioctl d envoy podname 查看config dump","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609731865,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1177175,"avatar":"https://static001.geekbang.org/account/avatar/00/11/f6/57/abb7bfe3.jpg","nickname":"无敌小贝塔","note":"","ucode":"5F12AA01DDCBB1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":339316,"discussion_content":"经过看后面的log的课程，针对（2 我理解的访问数据流是step1:productpage这个容器应用通过其对应的envoy代理去访问k8s下reviews对应发布的service cluster IP, step2:该 serviceIP通过kubeproxy（负载均衡）随机将请求发送至任意一个版本的review的pod（比如到达V3）, 因为在实际到达V3 review应用容器之前会先经过其对应的envoy容器代理,此时envoy容器代理识别出对应的配置比如通过end-user字段:是要发送给V2的，那么这个review v3 envoy 代理就会把请求转给V2对应的review pod，这个请求最终经过review 2 业务容器前端的envoy代理到达review2容器，这样理解对吗？）我的理解应该是错了，不会出现这样的数据流程。应该是在productpage的envoy代理上直接进行判断后发送给相对应的review pod。那这样的话reviews的VS和DR的策略应该是在productpage的envoy上执行了，那针对问题1也就有了答案，（我的理解是下发到所有pod上的envoy代理中）\n\n请老师指正一下我这次理解是否正确了","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1609601054,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1177175,"avatar":"https://static001.geekbang.org/account/avatar/00/11/f6/57/abb7bfe3.jpg","nickname":"无敌小贝塔","note":"","ucode":"5F12AA01DDCBB1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":339997,"discussion_content":"谢谢老师","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609857614,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":211011,"user_name":"MrPolo","can_delete":false,"product_type":"c3","uid":1449101,"ip_address":"","ucode":"1B08F61A7099F8","user_header":"","comment_is_top":false,"comment_ctime":1587880977,"is_pvip":false,"replies":[{"id":78505,"content":"优秀👍","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1587895069,"ip_address":"","comment_id":211011,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"直接加上regex match 有end-user header的request到rule v2\n\napiVersion: networking.istio.io&#47;v1alpha3\nkind: VirtualService\nmetadata:\n  name: reviews\nspec:\n  hosts:\n  - reviews\n  http:\n  - match:\n    - headers:\n        end-user:\n          regex: .*\n    route:\n    - destination:\n        host: reviews\n        subset: v2\n  - route:\n    - destination:\n        host: reviews\n        subset: v1","like_count":2,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493168,"discussion_content":"优秀👍","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587895069,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":304041,"user_name":"ileruza","can_delete":false,"product_type":"c3","uid":1336951,"ip_address":"","ucode":"C3D83DF4230109","user_header":"https://static001.geekbang.org/account/avatar/00/14/66/77/194ba21d.jpg","comment_is_top":false,"comment_ctime":1627204344,"is_pvip":false,"replies":[{"id":110117,"content":"Istio是基于服务（k8s service）层面进行流量管理的，所以vs 和dr的host需要和pod对应的service一致。和container name没关系","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1627353678,"ip_address":"","comment_id":304041,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"老师，我感觉VS的hosts、host、和DR的host还有pods的container name，是不是都要相同的啊，因为要把它们“串起来”，就因为istio是pods的sidecar，所以就要相同？","like_count":1,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":523911,"discussion_content":"Istio是基于服务（k8s service）层面进行流量管理的，所以vs 和dr的host需要和pod对应的service一致。和container name没关系","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627353678,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":277298,"user_name":"林树煌","can_delete":false,"product_type":"c3","uid":1960405,"ip_address":"","ucode":"048CB18DA26257","user_header":"https://static001.geekbang.org/account/avatar/00/1d/e9/d5/6c0edfb9.jpg","comment_is_top":false,"comment_ctime":1612348876,"is_pvip":false,"replies":[{"id":100654,"content":"可以","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1612429201,"ip_address":"","comment_id":277298,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"老师，你好，能否使用nginx ingress controller 代替 istio的gateway？","like_count":1,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":514991,"discussion_content":"可以","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1612429201,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1960405,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/e9/d5/6c0edfb9.jpg","nickname":"林树煌","note":"","ucode":"048CB18DA26257","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":371464,"discussion_content":"老师，替换了之后，发现virtualservice不生效了，有解决方法吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619776197,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":230094,"user_name":"光","can_delete":false,"product_type":"c3","uid":1284618,"ip_address":"","ucode":"BDA7F41566E4FE","user_header":"https://static001.geekbang.org/account/avatar/00/13/9a/0a/6c74e932.jpg","comment_is_top":false,"comment_ctime":1593257954,"is_pvip":false,"replies":[{"id":85006,"content":"是的，还不支持endpoint级别","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1593333610,"ip_address":"","comment_id":230094,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"老师问下 目前istio 熔断只能针对服务级别得把。可以支持接口级别得么\n","like_count":1,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":499761,"discussion_content":"是的，还不支持endpoint级别","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1593333610,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1248534,"avatar":"https://static001.geekbang.org/account/avatar/00/13/0d/16/92209491.jpg","nickname":"流浪记","note":"","ucode":"972679A33765D6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":633212,"discussion_content":"老师，这块有点不太懂，比如我为服务配置了gateway、vs和dr，同时dr下面配置了subset的子集，然后在子集上配置的熔断，这个时候我使用servicename访问或者gateway的地址访问都不会触发熔断，这是什么原因呢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1701912859,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"安徽","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":374902,"user_name":"Geek_7d539e","can_delete":false,"product_type":"c3","uid":2037654,"ip_address":"福建","ucode":"0D116E904D616E","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIVvyFCLRcfoWfiaJt99K0wiabvicWtQaJdSseVA6QqWyxcvN5nd2TgZqiaUACc94bBvPHZTibnfnZfdtQ/132","comment_is_top":false,"comment_ctime":1684633938,"is_pvip":false,"replies":[{"id":137528,"content":"只从服务发现角度讲没有必要并存。如果需要一般是既想演进到service mesh架构，使用Istio的特性，又想保留原有服务的兼容性等。他们的关系会变成上下游关系，dubbo的注册信息需要转换成Istio的配置并下发。","user_name":"作者回复","user_name_real":"编辑","uid":1046394,"ctime":1688461527,"ip_address":"北京","comment_id":374902,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"请教下马老师，有了 istio 还需要向 dubbo 这种服务注册发现路由的框架吗？如果需要他们是什么样的关系？","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":622602,"discussion_content":"只从服务发现角度讲没有必要并存。如果需要一般是既想演进到service mesh架构，使用Istio的特性，又想保留原有服务的兼容性等。他们的关系会变成上下游关系，dubbo的注册信息需要转换成Istio的配置并下发。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1688461527,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":313449,"user_name":"芒果少侠","can_delete":false,"product_type":"c3","uid":1350159,"ip_address":"","ucode":"98D0BBB52BB80F","user_header":"https://static001.geekbang.org/account/avatar/00/14/9a/0f/da7ed75a.jpg","comment_is_top":false,"comment_ctime":1632447871,"is_pvip":false,"replies":[{"id":113849,"content":"不接管","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1632982775,"ip_address":"","comment_id":313449,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"老师，请问下udp请求能够被istio接管么","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527357,"discussion_content":"不接管","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632982775,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":309873,"user_name":"渺小de尘埃","can_delete":false,"product_type":"c3","uid":1101319,"ip_address":"","ucode":"05AE183A736FD6","user_header":"https://static001.geekbang.org/account/avatar/00/10/ce/07/15a91f75.jpg","comment_is_top":false,"comment_ctime":1630377984,"is_pvip":false,"replies":[{"id":112249,"content":"以最新版本为准","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1630381758,"ip_address":"","comment_id":309873,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100049401,"comment_content":"apiVersion: networking.istio.io&#47;v1alpha3 这个是怎么定的？\n我查看 kubectl api-resources | grep VirtualService\nvirtualservices                    vs                                         networking.istio.io&#47;v1beta1                       true         VirtualService\nistio版本是1.7 是不是我这里就得写v1beta1了","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":526048,"discussion_content":"以最新版本为准","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630381758,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":303231,"user_name":"Geek__Phoenix","can_delete":false,"product_type":"c3","uid":1453358,"ip_address":"","ucode":"EEA694C7DBB4A3","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erGficovWwKUXs0zBEb87TtibFg8CC3icvXpPPicia4fkep5540LVfUAjCPWYhrCR8xQxuU97icS9HSfkzw/132","comment_is_top":false,"comment_ctime":1626678362,"is_pvip":false,"replies":[{"id":110120,"content":"貌似格式错误，没缩进？","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1627353861,"ip_address":"","comment_id":303231,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100049401,"comment_content":"你好！配置文件我是这样写的：\napiVersion: networking.istio.io&#47;v1alpha3\nkind: VirtualService\nmetadata:\n  name: reviews\nspec:\n  hosts:\n  - reviews\n  http:\n  - match:\n    - headers:\n        end-user:\n          regex: .*\n      - route:\n        - destination:\n            host: reviews\n            subset: v2\n  - route:\n    - destination:\n        host: reviews\n        subset: v1\n但是执行之后报错：“error: error parsing virtual-service-all-v1.yaml: error converting YAML to JSON: yaml: line 12: did not find expected key”\n问题是12行根本就不在这部分配置文件里：\n 11         host: productpage\n 12         subset: v1\n 13 ---\n这才是12行及上下行的内容，请问这配置有什么问题吗？\n","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":523599,"discussion_content":"貌似格式错误，没缩进？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627353861,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":290042,"user_name":"Geek_b1592e","can_delete":false,"product_type":"c3","uid":2165248,"ip_address":"","ucode":"5614547DED1877","user_header":"","comment_is_top":false,"comment_ctime":1619336182,"is_pvip":false,"replies":[{"id":106170,"content":"后面授权和认证相关的课程有介绍","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1621343366,"ip_address":"","comment_id":290042,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100049401,"comment_content":"想请教一下, 关于istio的动态路由或者gateway, 怎么配合自己的业务系统进行动态鉴权和路由\n比如: 定义了接口 &#47;api&#47;product&#47;view   授权的访问角色是ROLE_VIEW   只要有此角色的都可以访问此链接\n按照正常的逻辑 需要创建yaml, 然后配置相关的规则后  就可以使用了\n现在的问题是:  如果我想对接口增加一个访问角色 ROLE_CHECK 也能访问此链接, 现有的做法是更新相关的yaml配置,\n然后应用之后才会生效,  那么istio有没有提供相关的接口  可以让用户通过程序的方式来动态的实现这个功能呢?","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":519093,"discussion_content":"后面授权和认证相关的课程有介绍","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621343366,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":228431,"user_name":"光","can_delete":false,"product_type":"c3","uid":1284618,"ip_address":"","ucode":"BDA7F41566E4FE","user_header":"https://static001.geekbang.org/account/avatar/00/13/9a/0a/6c74e932.jpg","comment_is_top":false,"comment_ctime":1592668951,"is_pvip":false,"replies":[{"id":84649,"content":"istio的gateway只是定义没有路由配置，和k8s的ingress不一样。这样可以解耦且复用Virtualservice的路由配置","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1592985190,"ip_address":"","comment_id":228431,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100049401,"comment_content":"istio gateway 通过将 l4-l6 配置与 l7 配置分离  这句话怎么理解呢。和以前ingress 除了控制粒度不同外还有啥不一样的痛点。","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":499031,"discussion_content":"istio的gateway只是定义没有路由配置，和k8s的ingress不一样。这样可以解耦且复用Virtualservice的路由配置","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592985190,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":216034,"user_name":"Jepsenwan","can_delete":false,"product_type":"c3","uid":1220569,"ip_address":"","ucode":"FEED052E0C10F5","user_header":"","comment_is_top":false,"comment_ctime":1589172642,"is_pvip":false,"replies":[{"id":80126,"content":"match没生效吧？ 你这个end-user: 中间有空格？","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1589292644,"ip_address":"","comment_id":216034,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100049401,"comment_content":"您好！ 不知道啥情况，我的 virtualservice description 如下，还是不登录也能进入到v2, 请指点。\nHosts:\n    reviews\n  Http:\n    Match:\n      End - User:\n        Regex:  new*\n    Route:\n      Destination:\n        Host:    reviews\n        Subset:  v2\n    Route:\n      Destination:\n        Host:    reviews\n        Subset:  v1 \n\n谢谢！","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":494647,"discussion_content":"match没生效吧？ 你这个end-user: 中间有空格？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589292644,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":210209,"user_name":"Charles","can_delete":false,"product_type":"c3","uid":1201560,"ip_address":"","ucode":"C8C8A4F2B6C20F","user_header":"https://static001.geekbang.org/account/avatar/00/12/55/98/a49061ab.jpg","comment_is_top":false,"comment_ctime":1587697843,"is_pvip":false,"replies":[{"id":78420,"content":"👍","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1587805464,"ip_address":"","comment_id":210209,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100049401,"comment_content":"定义如下的VirtualService, 假设登录用户为xxx\napiVersion: networking.istio.io&#47;v1alpha3\nkind: VirtualService\nmetadata:\n  name: reviews-login\nspec:\n  hosts:\n  - reviews\n  http:\n  - match:\n    - headers:\n        end-user:\n          exact: &#39;xxx&#39;\n  - route:\n    - destination:\n        host: reviews\n        subset: v2","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492971,"discussion_content":"👍","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587805464,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":260500,"user_name":"lidashuang","can_delete":false,"product_type":"c3","uid":1104850,"ip_address":"","ucode":"560ABE8032760E","user_header":"https://static001.geekbang.org/account/avatar/00/10/db/d2/e29f8834.jpg","comment_is_top":false,"comment_ctime":1605027416,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":2,"score":3,"product_id":100049401,"comment_content":"我发一个完整的，有格式的\nhttps:&#47;&#47;gist.github.com&#47;defp&#47;58add4519206bab5b23a71ecdef617d3","like_count":1,"discussions":[{"author":{"id":1004948,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/55/94/cfde237f.jpg","nickname":"笨笨～龙","note":"","ucode":"19D49EBB516648","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":341309,"discussion_content":"对比了下发现缩进写错了……","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1610374740,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":335527,"user_name":"Amosヾ","can_delete":false,"product_type":"c3","uid":1567014,"ip_address":"","ucode":"833F6FCB4042AD","user_header":"https://static001.geekbang.org/account/avatar/00/17/e9/26/472e16e4.jpg","comment_is_top":false,"comment_ctime":1645576412,"is_pvip":true,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100049401,"comment_content":"老师，如果我们不用gateway而是使用了ingress，也对相关服务创建了vs和dr，那么ingress中指定的svc是vs还是svc？","like_count":0},{"had_liked":false,"id":333361,"user_name":"若星","can_delete":false,"product_type":"c3","uid":1247442,"ip_address":"","ucode":"D92DC0D777724E","user_header":"https://static001.geekbang.org/account/avatar/00/13/08/d2/83bdc5dd.jpg","comment_is_top":false,"comment_ctime":1644310883,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100049401,"comment_content":"老师，loadbalance怎么配置呢？","like_count":0},{"had_liked":false,"id":331589,"user_name":"Wisdom","can_delete":false,"product_type":"c3","uid":1098980,"ip_address":"","ucode":"0787F954B66E93","user_header":"https://static001.geekbang.org/account/avatar/00/10/c4/e4/81ee2d8f.jpg","comment_is_top":false,"comment_ctime":1642665181,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100049401,"comment_content":"老师，你这个是在katacoda 实验吗？怎么看起来像是在本机环境。因为我在katacoda环境安装好这些时，遇到通过本机浏览器无法访问到服务的问题","like_count":0},{"had_liked":false,"id":330627,"user_name":"Hello  World","can_delete":false,"product_type":"c3","uid":1685908,"ip_address":"","ucode":"90DFEA2D041E1E","user_header":"https://static001.geekbang.org/account/avatar/00/19/b9/94/25bfa1ac.jpg","comment_is_top":false,"comment_ctime":1642074724,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100049401,"comment_content":"grafana 的路由怎么配\n","like_count":0}]}