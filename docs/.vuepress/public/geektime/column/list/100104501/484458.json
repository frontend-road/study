{"id":484458,"title":"09 | ç”¨æˆ·æ€è·Ÿè¸ªï¼šå¦‚ä½•ä½¿ç”¨eBPFæ’æŸ¥åº”ç”¨ç¨‹åºï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å€ªæœ‹é£ã€‚</p><p>å‰é¢ä¸¤è®²ï¼Œæˆ‘å¸¦ä½ æ¢³ç†äº†æŸ¥è¯¢ eBPF è·Ÿè¸ªç‚¹çš„å¸¸ç”¨æ–¹æ³•ï¼Œå¹¶ä»¥çŸ­æ—¶è¿›ç¨‹çš„è·Ÿè¸ªä¸ºä¾‹ï¼Œé€šè¿‡ bpftraceã€BCC å’Œ libbpf ç­‰ä¸‰ç§æ–¹æ³•å®ç°äº†çŸ­æ—¶è¿›ç¨‹çš„è·Ÿè¸ªç¨‹åºã€‚å­¦å®Œè¿™äº›å†…å®¹ï¼Œæˆ‘æƒ³ä½ å·²ç»å¯ä»¥æ ¹æ®è‡ªå·±çš„å®é™…éœ€æ±‚ï¼ŒæŸ¥è¯¢åˆ°å†…æ ¸è·Ÿè¸ªç‚¹æˆ–å†…æ ¸å‡½æ•°ï¼Œå¹¶è‡ªå·±å¼€å‘ä¸€ä¸ª eBPF å†…æ ¸è·Ÿè¸ªç¨‹åºã€‚</p><p>ä¹Ÿè®¸ä½ æƒ³é—®ï¼šæˆ‘ä»¬èƒ½ä¸èƒ½åˆ©ç”¨ä¸è·Ÿè¸ªå†…æ ¸çŠ¶æ€ç±»ä¼¼çš„æ–¹æ³•ï¼Œå»è·Ÿè¸ªç”¨æˆ·ç©ºé—´çš„è¿›ç¨‹å‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚åªè¦æŠŠå†…æ ¸æ€è·Ÿè¸ªä½¿ç”¨çš„&nbsp;<code>kprobe</code>&nbsp;å’Œ&nbsp;<code>tracepoint</code>&nbsp;æ›¿æ¢æˆ&nbsp;<code>uprobe</code>&nbsp;ï¼Œæˆ–è€…ç”¨æˆ·ç©ºé—´å®šä¹‰çš„é™æ€è·Ÿè¸ªç‚¹ï¼ˆUser Statically Defined Tracingï¼Œç®€ç§° USDTï¼‰ï¼Œå¹¶æ‰¾å‡ºç”¨æˆ·è¿›ç¨‹éœ€è¦è·Ÿè¸ªçš„å‡½æ•°ï¼Œä½œä¸º eBPF ç¨‹åºçš„æŒ‚è½½ç‚¹ï¼Œä½ å°±å¯ä»¥å»è·Ÿè¸ªç”¨æˆ·è¿›ç¨‹çš„å†…éƒ¨çŠ¶æ€ã€‚</p><p>é‚£å…·ä½“è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿä»Šå¤©ï¼Œæˆ‘å°±å¸¦ä½ ä¸€èµ·æ¥çœ‹çœ‹ï¼Œå¦‚ä½•ä½¿ç”¨ eBPF å»è·Ÿè¸ªç”¨æˆ·è¿›ç¨‹çš„æ‰§è¡ŒçŠ¶æ€ã€‚</p><h2>å¦‚ä½•æŸ¥è¯¢ç”¨æˆ·è¿›ç¨‹è·Ÿè¸ªç‚¹ï¼Ÿ</h2><p>åœ¨ <a href=\"https://time.geekbang.org/column/article/484207\">07è®²</a> ä¸­æˆ‘æ›¾æåˆ°ï¼Œåœ¨è·Ÿè¸ªå†…æ ¸çš„çŠ¶æ€ä¹‹å‰ï¼Œä½ éœ€è¦åˆ©ç”¨å†…æ ¸æä¾›çš„è°ƒè¯•ä¿¡æ¯æŸ¥è¯¢å†…æ ¸å‡½æ•°ã€å†…æ ¸è·Ÿè¸ªç‚¹ä»¥åŠæ€§èƒ½äº‹ä»¶ç­‰ã€‚ç±»ä¼¼åœ°ï¼Œåœ¨è·Ÿè¸ªåº”ç”¨è¿›ç¨‹ä¹‹å‰ï¼Œä½ ä¹Ÿéœ€è¦çŸ¥é“<strong>è¿™ä¸ªè¿›ç¨‹æ‰€å¯¹åº”çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­æä¾›äº†å“ªäº›å¯ç”¨çš„è·Ÿè¸ªç‚¹</strong>ã€‚é‚£ä¹ˆï¼Œä»å“ªé‡Œå¯ä»¥æ‰¾åˆ°è¿™äº›ä¿¡æ¯å‘¢ï¼Ÿå¦‚æœä½ ä½¿ç”¨ GDB ä¹‹ç±»çš„åº”ç”¨è°ƒè¯•è¿‡ç¨‹åºï¼Œè¿™æ—¶åº”è¯¥å·²ç»æƒ³åˆ°äº†ï¼Œé‚£å°±æ˜¯<strong>åº”ç”¨ç¨‹åºäºŒè¿›åˆ¶æ–‡ä»¶ä¸­çš„è°ƒè¯•ä¿¡æ¯</strong>ã€‚</p><!-- [[[read_end]]] --><p>åœ¨é™æ€è¯­è¨€çš„ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œé€šå¸¸ä½ å¯ä»¥åŠ ä¸Š&nbsp;<code>-g</code>&nbsp;é€‰é¡¹ä¿ç•™è°ƒè¯•ä¿¡æ¯ã€‚è¿™æ ·ï¼Œæºä»£ç ä¸­çš„å‡½æ•°ã€å˜é‡ä»¥åŠå®ƒä»¬å¯¹åº”çš„ä»£ç è¡Œå·ç­‰ä¿¡æ¯ï¼Œå°±ä»¥&nbsp;<a href=\"https://dwarfstd.org/\">DWARF</a>ï¼ˆDebugging With Attributed Record Formatsï¼ŒLinux å’Œç±» Unix å¹³å°æœ€ä¸»æµçš„è°ƒè¯•ä¿¡æ¯æ ¼å¼ï¼‰æ ¼å¼å­˜å‚¨åˆ°äº†ç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ã€‚</p><p>æœ‰äº†è°ƒè¯•ä¿¡æ¯ï¼Œä½ å°±å¯ä»¥é€šè¿‡&nbsp;<a href=\"https://man7.org/linux/man-pages/man1/readelf.1.html\">readelf</a>ã€<a href=\"https://man7.org/linux/man-pages/man1/objdump.1.html\">objdump</a>ã€<a href=\"https://man7.org/linux/man-pages/man1/nm.1.html\">nm</a>&nbsp;ç­‰å·¥å…·ï¼ŒæŸ¥è¯¢å¯ç”¨äºè·Ÿè¸ªçš„å‡½æ•°ã€å˜é‡ç­‰ç¬¦å·åˆ—è¡¨ã€‚æ¯”å¦‚ï¼Œæˆ‘ç»å¸¸ä½¿ç”¨ <code>readelf</code> å‘½ä»¤ï¼ŒæŸ¥è¯¢äºŒè¿›åˆ¶æ–‡ä»¶çš„åŸºæœ¬ä¿¡æ¯ã€‚åœ¨ç»ˆç«¯ä¸­æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œå°±å¯ä»¥æŸ¥è¯¢&nbsp;<a href=\"https://www.gnu.org/software/libc/\">libc</a>&nbsp;åŠ¨æ€é“¾æ¥åº“ä¸­çš„ç¬¦å·è¡¨ï¼š</p><pre><code class=\"language-bash\"># æŸ¥è¯¢ç¬¦å·è¡¨ï¼ˆRHEL8ç³»ç»Ÿä¸­è¯·æŠŠåŠ¨æ€åº“è·¯å¾„æ›¿æ¢ä¸º/usr/lib64/libc.so.6ï¼‰\nreadelf -Ws /usr/lib/x86_64-linux-gnu/libc.so.6\n\n# æŸ¥è¯¢USDTä¿¡æ¯ï¼ˆUSDTä¿¡æ¯ä½äºELFæ–‡ä»¶çš„notesæ®µï¼‰\nreadelf -n /usr/lib/x86_64-linux-gnu/libc.so.6\n</code></pre><p>å½“ç„¶ï¼Œæˆ‘ä»¬&nbsp;<a href=\"https://time.geekbang.org/column/article/484207\">07è®²</a>&nbsp;ä¸­æåˆ°çš„ bpftrace å·¥å…·ä¹Ÿå¯ä»¥ç”¨æ¥æŸ¥è¯¢ uprobe å’Œ USDT è·Ÿè¸ªç‚¹ï¼Œå…¶æŸ¥è¯¢æ ¼å¼å¦‚ä¸‹æ‰€ç¤ºï¼ˆåŒæ ·æ”¯æŒ&nbsp;<code>*</code>&nbsp;é€šé…ç¬¦è¿‡æ»¤ï¼‰ï¼š</p><pre><code class=\"language-bash\"># æŸ¥è¯¢uprobeï¼ˆRHEL8ç³»ç»Ÿä¸­è¯·æŠŠåŠ¨æ€åº“è·¯å¾„æ›¿æ¢ä¸º/usr/lib64/libc.so.6ï¼‰\nbpftrace -l 'uprobe:/usr/lib/x86_64-linux-gnu/libc.so.6:*'\n\n# æŸ¥è¯¢USDT\nbpftrace -l 'usdt:/usr/lib/x86_64-linux-gnu/libc.so.6:*'\n</code></pre><p>åŒå†…æ ¸è·Ÿè¸ªç‚¹ç±»ä¼¼ï¼Œä½ ä¹Ÿå¯ä»¥åŠ ä¸Š&nbsp;<code>-v</code>&nbsp;é€‰é¡¹æŸ¥è¯¢ç”¨æˆ·æ¢é’ˆçš„å‚æ•°æ ¼å¼ã€‚ä¸è¿‡éœ€è¦å†æ¬¡å¼ºè°ƒçš„æ˜¯ï¼Œ<strong>æƒ³è¦é€šè¿‡äºŒè¿›åˆ¶æ–‡ä»¶æŸ¥è¯¢ç¬¦å·è¡¨å’Œå‚æ•°å®šä¹‰ï¼Œå¿…é¡»åœ¨ç¼–è¯‘çš„æ—¶å€™ä¿ç•™ DWARF è°ƒè¯•ä¿¡æ¯</strong>ã€‚</p><p>é™¤äº†ç¬¦å·è¡¨ä¹‹å¤–ï¼Œç†è®ºä¸Šä½ å¯ä»¥æŠŠ uprobe æ’æ¡©åˆ°äºŒè¿›åˆ¶æ–‡ä»¶çš„ä»»æ„åœ°å€ã€‚ä¸è¿‡è¿™è¦æ±‚ä½ å¯¹åº”ç”¨ç¨‹åº ELF æ ¼å¼çš„åœ°å€ç©ºé—´éå¸¸ç†Ÿæ‚‰ï¼Œå¹¶ä¸”å…·ä½“çš„åœ°å€ä¼šéšç€åº”ç”¨çš„è¿­ä»£æ›´æ–°è€Œå‘ç”Ÿå˜åŒ–ã€‚æ‰€ä»¥ï¼Œåœ¨éœ€è¦è·Ÿè¸ªåœ°å€çš„åœºæ™¯ä¸­ï¼Œä¸€å®šè¦è®°å¾—å» ELF äºŒè¿›åˆ¶æ–‡ä»¶åŠ¨æ€è·å–åœ°å€ä¿¡æ¯ã€‚</p><p>å¦å¤–éœ€è¦æé†’ä½ çš„æ˜¯ï¼Œ<strong>uprobe æ˜¯åŸºäºæ–‡ä»¶çš„ã€‚å½“æ–‡ä»¶ä¸­çš„æŸä¸ªå‡½æ•°è¢«è·Ÿè¸ªæ—¶ï¼Œé™¤éå¯¹è¿›ç¨‹ PID è¿›è¡Œäº†è¿‡æ»¤ï¼Œé»˜è®¤æ‰€æœ‰ä½¿ç”¨åˆ°è¿™ä¸ªæ–‡ä»¶çš„è¿›ç¨‹éƒ½ä¼šè¢«æ’æ¡©ã€‚</strong></p><h2>ç¼–ç¨‹è¯­è¨€ä¼šå½±å“ eBPF çš„è·Ÿè¸ªå—ï¼Ÿ</h2><p>å¦‚æœä½ äº†è§£è¿‡ä¸åŒçš„ç¼–ç¨‹è¯­è¨€ï¼Œçœ‹åˆ°è¿™é‡Œä½ è‚¯å®šä¼šæƒ³åˆ°ï¼Œè¿™äº›æŸ¥è¯¢è·Ÿè¸ªç‚¹ä¿¡æ¯çš„æ–¹æ³•å¾ˆå¯èƒ½æ˜¯è·Ÿç¼–ç¨‹è¯­è¨€ç›¸å…³çš„ã€‚C è¯­è¨€å’Œ Python è¯­è¨€æ˜¯æˆ‘ä»¬è¯¾ç¨‹çš„å­¦ä¹ åŸºç¡€ï¼Œä¹Ÿæ˜¯å‰é¢å‡ è®²çš„æ¡ˆä¾‹ä¸­åå¤ä½¿ç”¨çš„ç¼–ç¨‹è¯­è¨€ï¼Œæˆ‘ç›¸ä¿¡ä½ è‡³å°‘å·²ç»å¯¹å®ƒä»¬æœ‰äº†ç®€å•çš„äº†è§£ã€‚è¿™é‡Œæˆ‘ä»¬å¯¹æ¯”ä¸‹è¿™ä¸¤ç§ç¼–ç¨‹è¯­è¨€åœ¨è¿è¡Œæ–¹å¼ä¸Šçš„åŒºåˆ«ï¼š</p><ul>\n<li>C è¯­è¨€ç¨‹åºéœ€è¦ç¼–è¯‘ä¸ºäºŒè¿›åˆ¶æ–‡ä»¶ä¹‹åå†æ‰§è¡Œï¼Œç¼–è¯‘æ—¶åŠ ä¸Š&nbsp;<code>-g</code>&nbsp;é€‰é¡¹å°±å¯ä»¥åœ¨æœ€ç»ˆçš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ä¿ç•™è°ƒè¯•ä¿¡æ¯ï¼›</li>\n<li>Python è¯­è¨€ç¨‹åºåˆ™æ˜¯ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œä¸éœ€è¦ C è¯­è¨€é‚£æ ·çš„ç¼–è¯‘è¿‡ç¨‹ï¼Œè€Œæ˜¯ç”± Python è§£é‡Šå™¨è¿›è¡Œè¯­æ³•åˆ†æåæ‰§è¡Œã€‚å› è€Œï¼Œä¸Šè¿°<code>readelf</code>&nbsp;ç­‰å·¥å…·æ²¡æ³•ä»&nbsp;<code>python</code>&nbsp;äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ç›´æ¥è¯»å–åˆ°åº”ç”¨ç¨‹åºçš„è°ƒè¯•ä¿¡æ¯ã€‚</li>\n</ul><p>å½“ç„¶ï¼ŒC å’Œ Python åªæ˜¯æˆ‘ä»¬è¯¾ç¨‹ä¸­ä½¿ç”¨çš„ä¸¤ç§ç¼–ç¨‹è¯­è¨€ï¼Œå®é™…çš„ç¼–ç¨‹è¯­è¨€ç§ç±»è¦å¤šå¾—å¤šã€‚å¦‚æœæŠŠå¸¸ç”¨çš„ç¼–ç¨‹è¯­è¨€è¿›è¡Œå½’ç±»ï¼ŒæŒ‰ç…§å…¶è¿è¡ŒåŸç†ï¼Œæˆ‘è®¤ä¸ºå¤§è‡´ä¸Šå¯ä»¥åˆ†ä¸ºä¸‰ç±»ï¼š</p><ul>\n<li>ç¬¬ä¸€ç±»æ˜¯ Cã€C++ã€Golang ç­‰ç¼–è¯‘ä¸ºæœºå™¨ç åå†æ‰§è¡Œçš„<strong>ç¼–è¯‘å‹è¯­è¨€</strong>ã€‚è¿™ç±»ç¼–ç¨‹è¯­è¨€å¼€å‘çš„ç¨‹åºï¼Œé€šå¸¸ä¼šç¼–è¯‘æˆ ELF æ ¼å¼çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼ŒåŒ…å«äº†ä¿å­˜åœ¨å¯„å­˜å™¨æˆ–æ ˆä¸­çš„å‡½æ•°å‚æ•°å’Œè¿”å›å€¼ï¼Œå› è€Œå¯ä»¥ç›´æ¥é€šè¿‡äºŒè¿›åˆ¶æ–‡ä»¶ä¸­çš„ç¬¦å·è¿›è¡Œè·Ÿè¸ªã€‚</li>\n<li>ç¬¬äºŒç±»æ˜¯ Pythonã€Bashã€Ruby ç­‰é€šè¿‡è§£é‡Šå™¨è¯­æ³•åˆ†æä¹‹åå†æ‰§è¡Œçš„<strong>è§£é‡Šå‹è¯­è¨€</strong>ã€‚è¿™ç±»ç¼–ç¨‹è¯­è¨€å¼€å‘çš„ç¨‹åºï¼Œæ— æ³•ç›´æ¥ä»è¯­è¨€è¿è¡Œæ—¶çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­è·å–åº”ç”¨ç¨‹åºçš„è°ƒè¯•ä¿¡æ¯ï¼Œé€šå¸¸éœ€è¦è·Ÿè¸ªè§£é‡Šå™¨çš„å‡½æ•°ï¼Œå†ä»å…¶å‚æ•°ä¸­è·å–åº”ç”¨ç¨‹åºçš„è¿è¡Œç»†èŠ‚ã€‚</li>\n<li>æœ€åä¸€ç±»æ˜¯ Javaã€.Netã€JavaScript ç­‰å…ˆç¼–è¯‘ä¸ºå­—èŠ‚ç ï¼Œå†ç”±å³æ—¶ç¼–è¯‘å™¨ï¼ˆJITï¼‰ç¼–è¯‘ä¸ºæœºå™¨ç æ‰§è¡Œçš„<strong>å³æ—¶ç¼–è¯‘å‹è¯­è¨€</strong>ã€‚åŒè§£é‡Šå‹è¯­è¨€ç±»ä¼¼ï¼Œè¿™ç±»ç¼–ç¨‹è¯­è¨€æ— æ³•ç›´æ¥ä»è¯­è¨€è¿è¡Œæ—¶çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­è·å–åº”ç”¨ç¨‹åºçš„è°ƒè¯•ä¿¡æ¯ã€‚è·Ÿè¸ª JIT ç¼–ç¨‹è¯­è¨€å¼€å‘çš„ç¨‹åºæ˜¯æœ€å›°éš¾çš„ï¼Œå› ä¸º JIT ç¼–è¯‘çš„çŠ¶æ€åªå­˜åœ¨äºå†…å­˜ä¸­ã€‚</li>\n</ul><p>å¯¹æ¯”è¿™å‡ ç±»ç¼–ç¨‹è¯­è¨€ï¼Œä½ å¯ä»¥å‘ç°ï¼Œç¼–ç¨‹è¯­è¨€çš„ç±»å‹å¯¹ eBPF è·Ÿè¸ªä¹Ÿæœ‰éå¸¸å¤§çš„å½±å“ï¼Œä¸åŒç±»å‹ç¼–ç¨‹è¯­è¨€å¼€å‘çš„åº”ç”¨ç¨‹åºï¼Œå…¶è·Ÿè¸ªè¿‡ç¨‹å’Œéš¾åº¦ä¹Ÿä¸ç›¸åŒã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘å°±ç”¨å‡ ä¸ªæ¡ˆä¾‹å¸¦ä½ ä¸€èµ·æ¥çœ‹çœ‹æ¯ä¸€ç±»ç¼–ç¨‹è¯­è¨€çš„è·Ÿè¸ªæ–¹æ³•ã€‚</p><h2>è·Ÿè¸ªç¼–è¯‘å‹è¯­è¨€åº”ç”¨ç¨‹åº</h2><p>ç”±äºå¯ä»¥ç›´æ¥ä»è°ƒè¯•ä¿¡æ¯ä¸­è·å–åˆ°ç¬¦å·ï¼ˆç”¨äºè·Ÿè¸ªå‡½æ•°ï¼‰å’Œå¸§æŒ‡é’ˆï¼ˆç”¨äºè·Ÿè¸ªè°ƒç”¨æ ˆï¼‰ï¼Œç¼–è¯‘å‹è¯­è¨€å¼€å‘çš„åº”ç”¨ç¨‹åºæ˜¯æ¯”è¾ƒå®¹æ˜“è·Ÿè¸ªçš„ã€‚</p><p>ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¤§éƒ¨åˆ†ç¼–è¯‘å‹è¯­è¨€éµå¾ª&nbsp;<a href=\"https://en.wikipedia.org/wiki/Application_binary_interface\">ABIï¼ˆApplication Binary Interfaceï¼‰</a>&nbsp;è°ƒç”¨è§„èŒƒï¼Œå‡½æ•°çš„å‚æ•°å’Œè¿”å›å€¼éƒ½å­˜æ”¾åœ¨å¯„å­˜å™¨ä¸­ã€‚è€Œ Go 1.17 ä¹‹å‰ä½¿ç”¨çš„æ˜¯&nbsp;<a href=\"https://9p.io/sys/doc/asm.html\">Plan 9</a>&nbsp;è°ƒç”¨è§„èŒƒï¼Œå‡½æ•°çš„å‚æ•°å’Œè¿”å›å€¼éƒ½å­˜æ”¾åœ¨å †æ ˆä¸­ï¼›ç›´åˆ° 1.17ï¼Œ Go æ‰ä» Plan 9 åˆ‡æ¢åˆ° ABI è°ƒç”¨è§„èŒƒã€‚æ‰€ä»¥ï¼Œåœ¨è·Ÿè¸ªå‡½æ•°å‚æ•°å’Œè¿”å›å€¼æ—¶ï¼Œä½ éœ€è¦<strong>é¦–å…ˆåŒºåˆ†ç¼–ç¨‹è¯­è¨€çš„è°ƒç”¨è§„èŒƒ</strong>ï¼Œç„¶åå†å»å¯„å­˜å™¨æˆ–å †æ ˆä¸­è¯»å–å‡½æ•°çš„å‚æ•°å’Œè¿”å›å€¼ã€‚</p><p>æ­¤å¤–ï¼Œ<strong>è°ƒè¯•ä¿¡æ¯å¹¶éä¸€å®šè¦å†…ç½®äºæœ€ç»ˆåˆ†å‘çš„åº”ç”¨ç¨‹åºäºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œå®ƒä»¬ä¹Ÿå¯ä»¥æ”¾åˆ°ç‹¬ç«‹çš„è°ƒè¯•æ–‡ä»¶å­˜å‚¨</strong>ã€‚ä¸ºäº†å‡å°‘åº”ç”¨ç¨‹åºäºŒè¿›åˆ¶æ–‡ä»¶çš„å¤§å°ï¼Œé€šå¸¸ä¼šæŠŠè°ƒè¯•ä¿¡æ¯ä»äºŒè¿›åˆ¶æ–‡ä»¶ä¸­å‰¥ç¦»å‡ºæ¥ï¼Œä¿å­˜åˆ°&nbsp;<code>&lt;åº”ç”¨å&gt;.debuginfo</code>&nbsp;æˆ–è€…&nbsp;<code>&lt;build-id&gt;.debug</code>&nbsp;æ–‡ä»¶ä¸­ï¼Œåç»­æ’æŸ¥é—®é¢˜éœ€è¦ç”¨åˆ°æ—¶å†å®‰è£…ã€‚</p><p>æ¯”å¦‚ï¼Œåœ¨ RHEL å’Œ Ubuntu ç­‰å¸¸è§çš„ Linux å‘è¡Œç‰ˆä¸­ï¼Œè°ƒè¯•ä¿¡æ¯è·Ÿåº”ç”¨ç¨‹åºé€šå¸¸æ˜¯ä¸¤ä¸ªä¸åŒçš„è½¯ä»¶åŒ…ã€‚è€Œå¯¹å¾ˆå¤šå¼€å‘è€…æ¥è¯´ï¼Œæ¯æ¬¡ç¼–è¯‘å’Œå‘å¸ƒåº”ç”¨ç¨‹åºä¹‹å‰ï¼Œé€šå¸¸éƒ½éœ€è¦æ‰§è¡Œä¸€ä¸‹&nbsp;<code>strip</code>&nbsp;å‘½ä»¤ï¼ŒæŠŠè°ƒè¯•ä¿¡æ¯åˆ é™¤åæ‰å‘å¸ƒåˆ°ç”Ÿäº§ç¯å¢ƒä¸­ã€‚</p><p>è¿™é‡Œç»™ä½ ä¸ªå°æç¤ºï¼šELF ç¬¦å·è¡¨åŒ…å«&nbsp;<code>.symtab</code>ï¼ˆåº”ç”¨æœ¬åœ°çš„ç¬¦å·ï¼‰å’Œ&nbsp;<code>.dynsym</code>ï¼ˆè°ƒç”¨åˆ°å¤–éƒ¨çš„ç¬¦å·ï¼‰ï¼Œ<code>strip</code> å‘½ä»¤å®é™…ä¸Šåªæ˜¯åˆ é™¤äº†&nbsp;<code>.symtab</code>&nbsp;çš„å†…å®¹ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘å°±ä»¥æ¯ä¸ª Linux ç”¨æˆ·éƒ½ä¼šä½¿ç”¨çš„ Bash&nbsp;ä¸ºä¾‹ï¼ˆBash æ˜¯ä¸€ä¸ªå…¸å‹çš„ C è¯­è¨€ç¨‹åºï¼‰ï¼Œå¸¦ä½ ä¸€èµ·çœ‹çœ‹ï¼Œå¦‚ä½•è·Ÿè¸ªç¼–è¯‘å‹è¯­è¨€åº”ç”¨ç¨‹åºçš„æ‰§è¡ŒçŠ¶æ€ã€‚</p><p>åœ¨æœåŠ¡å™¨çš„ç»´æŠ¤è¿‡ç¨‹ä¸­ï¼Œç³»ç»Ÿç»´æŠ¤äººå‘˜éƒ½éœ€è¦å®¡è®¡æ¯ä¸ªç”¨æˆ·ç™»å½•åéƒ½æ‰§è¡Œäº†å“ªäº›å‘½ä»¤ï¼Œä»¥ä¾¿äº‹åæ’æŸ¥é—®é¢˜æ—¶å‚è€ƒã€‚ç”±äºç™»å½•åæ‰€æœ‰å‘½ä»¤çš„æ‰§è¡Œéƒ½å‘ç”Ÿåœ¨ Bash ä¸­ï¼Œé‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰å¯èƒ½ä½¿ç”¨ eBPF æ¥è·Ÿè¸ª Bash é‡Œé¢åˆ°åº•æ‰§è¡Œè¿‡ä»€ä¹ˆå‘½ä»¤å‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚</p><p>åœ¨è·Ÿè¸ª Bash ä¹‹å‰ï¼Œé¦–å…ˆæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œå®‰è£…å®ƒçš„è°ƒè¯•ä¿¡æ¯ï¼š</p><pre><code class=\"language-bash\"># Ubuntu\nsudo apt install bash-dbgsym\n\n# RHEL\nsudo debuginfo-install bash\n</code></pre><p>æœ‰äº† Bash è°ƒè¯•ä¿¡æ¯ä¹‹åï¼Œå†æ‰§è¡Œä¸‹é¢çš„å‡ æ­¥ï¼ŒæŸ¥è¯¢ Bash çš„ç¬¦å·è¡¨ï¼š</p><pre><code class=\"language-bash\"># ç¬¬ä¸€æ­¥ï¼ŒæŸ¥è¯¢ Build IDï¼ˆç”¨äºå…³è”è°ƒè¯•ä¿¡æ¯ï¼‰\nreadelf -n /usr/bin/bash | grep 'Build ID'\n# è¾“å‡ºç¤ºä¾‹ä¸ºï¼š\n#     Build ID: 7b140b33fd79d0861f831bae38a0cdfdf639d8bc\n\n# ç¬¬äºŒæ­¥ï¼Œæ‰¾åˆ°è°ƒè¯•ä¿¡æ¯å¯¹åº”çš„æ–‡ä»¶ï¼ˆè°ƒè¯•ä¿¡æ¯ä½äºç›®å½•/usr/lib/debug/.build-idä¸­ï¼Œä¸Šä¸€æ­¥ä¸­å¾—åˆ°çš„Build IDå‰ä¸¤ä¸ªå­—æ¯ä¸ºç›®å½•åï¼‰\nls /usr/lib/debug/.build-id/7b/140b33fd79d0861f831bae38a0cdfdf639d8bc.debug\n\n# ç¬¬ä¸‰æ­¥ï¼Œä»è°ƒè¯•ä¿¡æ¯ä¸­æŸ¥è¯¢ç¬¦å·è¡¨\nreadelf -Ws /usr/lib/debug/.build-id/7b/140b33fd79d0861f831bae38a0cdfdf639d8bc.debug\n</code></pre><p>å‚è€ƒ Bash çš„<a href=\"https://git.savannah.gnu.org/cgit/bash.git/tree/lib/readline/readline.c?h=bash-5.1#n352\">æºä»£ç </a>ï¼Œæ¯æ¡ Bash å‘½ä»¤åœ¨è¿è¡Œå‰ï¼Œéƒ½ä¼šè°ƒç”¨&nbsp;<code>char</code><em><code>readline (const char</code></em><code>prompt)</code>&nbsp;å‡½æ•°è¯»å–ç”¨æˆ·çš„è¾“å…¥ï¼Œç„¶åå†å»è§£ææ‰§è¡Œï¼ˆBash è‡ªèº«æ˜¯ä½¿ç”¨ç¼–è¯‘å‹è¯­è¨€ C å¼€å‘çš„ï¼Œè€Œ Bash è¯­è¨€åˆ™æ˜¯ä¸€ç§è§£é‡Šå‹è¯­è¨€ï¼‰ã€‚</p><p>æ³¨æ„ï¼Œ<code>readline</code>&nbsp;å‡½æ•°çš„å‚æ•°æ˜¯å‘½ä»¤è¡Œæç¤ºç¬¦ï¼ˆé€šè¿‡ç¯å¢ƒå˜é‡&nbsp;<code>PS1</code>ã€<code>PS2</code> ç­‰è®¾ç½®ï¼‰ï¼Œè€Œè¿”å›å€¼æ‰æ˜¯ç”¨æˆ·çš„è¾“å…¥ã€‚å› è€Œï¼Œæˆ‘ä»¬åªéœ€è¦è·Ÿè¸ª&nbsp;<code>readline</code>&nbsp;å‡½æ•°çš„è¿”å›å€¼ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨&nbsp;<code>uretprobe</code>&nbsp;è·Ÿè¸ªã€‚</p><p>bpftraceã€BCC ä»¥åŠ libbpf ç­‰å·¥å…·å‡æ”¯æŒ <code>uretprobe</code>ï¼Œå› è€Œæœ€ç®€å•çš„è·Ÿè¸ªæ–¹æ³•å°±æ˜¯ä½¿ç”¨ bpftrace çš„å•è¡Œå‘½ä»¤ï¼š</p><pre><code class=\"language-bash\">sudo bpftrace -e 'uretprobe:/usr/bin/bash:readline { printf(\"User %d executed \\\"%s\\\" command\\n\", uid, str(retval)); }'\n</code></pre><p>è¿™ä¸ªå‘½ä»¤ä¸­å…·ä½“å†…å®¹çš„ä½œç”¨å¦‚ä¸‹ï¼š</p><ul>\n<li><code>uretprobe:/usr/bin/bash:readline</code>&nbsp;è®¾ç½®è·Ÿè¸ªç±»å‹ä¸º&nbsp;<code>uretprobe</code>ï¼Œè·Ÿè¸ªçš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸º&nbsp;<code>/usr/bin/bash</code>ï¼Œè·Ÿè¸ªç¬¦å·ä¸º&nbsp;<code>readline</code>ï¼›</li>\n<li>ä¸­æ‹¬å·é‡Œçš„å†…å®¹ä¸º uretprobe çš„å¤„ç†å‡½æ•°ï¼›</li>\n<li>å¤„ç†å‡½æ•°ä¸­ï¼Œ<code>uid</code>&nbsp;å’Œ&nbsp;<code>retval</code>&nbsp;æ˜¯ä¸¤ä¸ªå†…ç½®å˜é‡ï¼Œåˆ†åˆ«è¡¨ç¤ºç”¨æˆ· UID ä»¥åŠè¿”å›å€¼ï¼›</li>\n<li><code>str</code> ç”¨äºä»æŒ‡é’ˆä¸­è¯»å–å­—ç¬¦ä¸²ï¼Œ <code>str(retval)</code> å°±æ˜¯ Bash ä¸­è¾“å…¥å‘½ä»¤çš„å­—ç¬¦ä¸²ï¼›</li>\n<li><code>printf</code> ç”¨äºå‘ç»ˆç«¯ä¸­æ‰“å°ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚</li>\n</ul><p>æ‰“å¼€ä¸€ä¸ªç»ˆç«¯ï¼Œå¹¶åœ¨æ–°ç»ˆç«¯ä¸­æ‰§è¡Œ&nbsp;<code>ps</code>&nbsp;å‘½ä»¤ï¼Œç„¶åå°±ä¼šåœ¨ç¬¬ä¸€ä¸ªç»ˆç«¯ä¸­çœ‹åˆ°å¦‚ä¸‹çš„è¾“å‡ºï¼ˆå³ UID ä¸º 1000 çš„ç”¨æˆ·æ‰§è¡Œäº† <code>ps</code> å‘½ä»¤ï¼‰ï¼š</p><pre><code class=\"language-plain\">Attaching 1 probe...\nUser 1000 executed \"ps\" command\n</code></pre><p>å’Œä¸Šä¸€è®²çš„æ¡ˆä¾‹ç±»ä¼¼ï¼Œè¿™é‡Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ BCC å’Œ libbpf å®ç°ç›¸åŒçš„è·Ÿè¸ªç¨‹åºã€‚ç”±äºå®ƒä»¬çš„å®ç°é€»è¾‘æ˜¯ç±»ä¼¼çš„ï¼Œå¹¶ä¸” BCC æä¾›äº†å¯¹åˆå­¦è€…æ›´å‹å¥½çš„æ¥å£ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥ï¼Œæˆ‘å°±ä»¥ BCC ä¸ºä¾‹ï¼Œå¸¦ä½ ä¸€èµ·çœ‹çœ‹å¦‚ä½•æ¥è·Ÿè¸ªç”¨æˆ·ç©ºé—´çš„ Bashã€‚</p><p>è¿˜è®°å¾—ç”¨ BCC æ¥å¼€å‘ä¸€ä¸ª eBPF è·Ÿè¸ªç¨‹åºçš„å…·ä½“æ­¥éª¤å—ï¼Ÿå¦‚æœä½ ä¸è®°å¾—ï¼Œä¹Ÿæ²¡å…³ç³»ï¼Œæˆ‘æ¥å¸¦ä½ ç®€å•å›é¡¾ä¸€ä¸‹ã€‚BCC çš„ä½¿ç”¨å¯ä»¥åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š</p><ul>\n<li>ç¬¬ä¸€éƒ¨åˆ†æ˜¯ç”¨ C è¯­è¨€å¼€å‘çš„ eBPF ç¨‹åºã€‚åœ¨ eBPF ç¨‹åºä¸­ï¼Œä½ å¯ä»¥åˆ©ç”¨ BCC æä¾›çš„<a href=\"https://github.com/iovisor/bcc/blob/master/docs/reference_guide.md\">åº“å‡½æ•°å’Œå®å®šä¹‰</a>ç®€åŒ–ä½ çš„å¤„ç†é€»è¾‘ã€‚</li>\n<li>ç¬¬äºŒéƒ¨åˆ†æ˜¯ç”¨ Python è¯­è¨€å¼€å‘çš„å‰ç«¯ç•Œé¢ï¼Œå…¶ä¸­åŒ…å« eBPF ç¨‹åºåŠ è½½ã€æŒ‚è½½åˆ°å†…æ ¸å‡½æ•°å’Œè·Ÿè¸ªç‚¹ï¼Œä»¥åŠé€šè¿‡ BPF æ˜ å°„è·å–å’Œæ‰“å°æ‰§è¡Œç»“æœç­‰éƒ¨åˆ†ã€‚åœ¨å‰ç«¯ç¨‹åºä¸­ï¼Œä½ åŒæ ·å¯ä»¥åˆ©ç”¨ BCC åº“æ¥è®¿é—® BPF æ˜ å°„ã€‚</li>\n</ul><p>å¯¹äºç¬¬ä¸€éƒ¨åˆ†æ¥è¯´ï¼Œæˆ‘ä»¬è¦åšçš„å°±æ˜¯ä» uretprobe çš„å¤„ç†å‡½æ•°ä¸­è·å–&nbsp;<code>readline</code>&nbsp;çš„è¿”å›å€¼ï¼Œç„¶åæäº¤åˆ°æ€§èƒ½äº‹ä»¶æ˜ å°„ä¸­ã€‚è¿™é‡Œä½ å¯èƒ½æƒ³é—®ï¼šå¦‚ä½•è·å–è¿”å›å€¼å‘¢ï¼Ÿæ˜¯ä¸æ˜¯å·²ç»æœ‰åº“å‡½æ•°å¯ä»¥ç›´æ¥æ‹¿è¿‡æ¥ç”¨å‘¢ï¼Ÿå¯¹æ­¤ï¼Œç‰¹åˆ«æé†’ä½ ä¸€ç‚¹ï¼š<strong>å½“ç¢°åˆ°ä¸æ‡‚çš„é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯ä¸æ¸…æ¥šæ¥å£è°ƒç”¨çš„å…·ä½“æ ¼å¼æ—¶ï¼Œä¸è¦å»äº’è”ç½‘æœç´¢ï¼Œè€Œæ˜¯åº”è¯¥æŸ¥è¯¢å®˜æ–¹æ–‡æ¡£ï¼ˆæˆ–è€…æºä»£ç ï¼‰<strong><strong>æ¥</strong></strong>ç¡®è®¤ã€‚</strong></p><p>å¯¹äº BCC çš„ uretprobe æ¥è¯´ï¼Œå…¶å®˜æ–¹æ–‡æ¡£é“¾æ¥å°±æ˜¯ <a href=\"https://github.com/iovisor/bcc/blob/master/docs/reference_guide.md#5-uretprobes\">uretprobes</a>ã€‚æ ¹æ®è¿™é‡Œçš„æ–‡æ¡£ï¼Œuretprobe å¤„ç†å‡½æ•°çš„å®šä¹‰æ ¼å¼åº”è¯¥ä¸º&nbsp;<code>function_name(struct pt_regs *ctx)</code>ï¼Œè€Œè¿”å›å€¼å¯ä»¥é€šè¿‡å®&nbsp;<code>PT_REGS_RC(ctx)</code>&nbsp;æ¥è·å–ï¼ˆå®é™…ä¸Šï¼Œkretprobe ä¹Ÿæ˜¯é‡‡ç”¨ç›¸åŒçš„æ ¼å¼ï¼‰ã€‚æœ‰äº†è¿™äº›æ–‡æ¡£ï¼Œå°±å¯ä»¥æŒ‰ç…§è¿™é‡Œçš„å‡½æ•°æ ¼å¼æ¥å®Œæˆç¬¬ä¸€éƒ¨åˆ†çš„å¼€å‘äº†ã€‚ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼Œæ¯ä¸€æ­¥æˆ‘éƒ½åŠ äº†è¯¦ç»†çš„æ³¨é‡Šï¼š</p><pre><code class=\"language-c++\">// åŒ…å«å¤´æ–‡ä»¶\n#include &lt;uapi/linux/ptrace.h&gt;\n\n// å®šä¹‰æ•°æ®ç»“æ„å’Œæ€§èƒ½äº‹ä»¶æ˜ å°„\nstruct data_t {\n    u32 uid;\n    char command[64];\n};\nBPF_PERF_OUTPUT(events);\n\n// å®šä¹‰uretprobeå¤„ç†å‡½æ•°\nint bash_readline(struct pt_regs *ctx)\n{\n    // æŸ¥è¯¢uid\n    struct data_t data = { };\n    data.uid = bpf_get_current_uid_gid();\n\n    // ä»PT_REGS_RC(ctx)è¯»å–è¿”å›å€¼\n    bpf_probe_read_user(&amp;data.command, sizeof(data.command), (void *)PT_REGS_RC(ctx));\n\n    // æäº¤æ€§èƒ½äº‹ä»¶\n    events.perf_submit(ctx, &amp;data, sizeof(data));\n    return 0;\n}\n</code></pre><p>ä»ä»£ç ä¸­ä½ å¯ä»¥çœ‹åˆ°ï¼ŒeBPF ç¨‹åºçš„ç»“æ„è·Ÿä¸Šä¸€è®²åŸºæœ¬ç±»ä¼¼ï¼Œå”¯ä¸€éœ€è¦æ³¨æ„çš„æ˜¯å‡½æ•°çš„å®šä¹‰æ ¼å¼ä»¥åŠè¿”å›å€¼çš„è¯»å–ä½ç½®ã€‚å°†ä¸Šè¿°ä»£ç ä¿å­˜åˆ°&nbsp;<code>bashreadline.c</code>&nbsp;æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å°±å®Œæˆäº†ç¬¬ä¸€éƒ¨åˆ†çš„å¼€å‘ã€‚</p><p>æœ‰äº† eBPF ç¨‹åºä¹‹åï¼Œç¬¬äºŒéƒ¨åˆ†çš„ Python å‰ç«¯ä¹Ÿæ¯”è¾ƒç›´è§‚ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code class=\"language-python\"># å¼•å…¥BCCåº“\nfrom bcc import BPF\nfrom time import strftime\n\n# åŠ è½½eBPF ç¨‹åº\nb = BPF(src_file=\"bashreadline.c\")\n\n# æŒ‚è½½uretprobe\nb.attach_uretprobe(name=\"/usr/bin/bash\", sym=\"readline\", fn_name=\"bash_readline\")\n\n# å®šä¹‰æ€§èƒ½äº‹ä»¶å›è°ƒï¼ˆè¾“å‡ºæ—¶é—´ã€UIDä»¥åŠBashä¸­æ‰§è¡Œçš„å‘½ä»¤ï¼‰\ndef print_event(cpu, data, size):\n    event = b[\"events\"].event(data)\n    print(\"%-9s %-6d %s\" % (strftime(\"%H:%M:%S\"), event.uid, event.command.decode(\"utf-8\")))\n\n# æ‰“å°å¤´\nprint(\"%-9s %-6s %s\" % (\"TIME\", \"UID\", \"COMMAND\"))\n\n# ç»‘å®šæ€§èƒ½äº‹ä»¶æ˜ å°„å’Œè¾“å‡ºå‡½æ•°ï¼Œå¹¶ä»æ˜ å°„ä¸­å¾ªç¯è¯»å–æ•°æ®\nb[\"events\"].open_perf_buffer(print_event)\nwhile 1:\n    try:\n        b.perf_buffer_poll()\n    except KeyboardInterrupt:\n        exit()\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™éƒ¨åˆ†çš„ä»£ç è·Ÿä¸Šä¸€è®²æ¡ˆä¾‹çš„ç»“æ„ä¹Ÿæ˜¯ç±»ä¼¼çš„ã€‚ä¸»è¦çš„ä¸åŒç‚¹åœ¨äºï¼ŒæŒ‚è½½ uretprobe çš„æ—¶å€™è°ƒç”¨äº†&nbsp;<code>b.attach_uretprobe()</code>&nbsp;ï¼Œå¹¶åœ¨å…¶å‚æ•°ä¸­ä¼ å…¥äº†äºŒè¿›åˆ¶æ–‡ä»¶çš„è·¯å¾„&nbsp;<code>name=\"/usr/bin/bash\"</code>&nbsp;ï¼Œä»¥åŠè¦è·Ÿè¸ªçš„ç¬¦å·&nbsp;<code>sym=\"readline\"</code>ã€‚</p><p>åœ¨ BCC çš„å†…éƒ¨ï¼Œå½“ä½ æŒ‚è½½ uprobe æˆ–è€… uretprobe åˆ°ç”¨æˆ·ç¨‹åºæ—¶ï¼Œç”±äºåŒä¸€ä¸ªç¬¦å·å¯èƒ½å‡ºç°å¤šæ¬¡ï¼ŒBCC ä¼šé¦–å…ˆæŸ¥è¯¢è¯¥ç¬¦å·çš„æ‰€æœ‰åœ°å€ï¼Œç„¶åæŠŠ eBPF ç¨‹åºæŒ‚è½½åˆ°æ‰€æœ‰ä¸åŒçš„åœ°å€ä¸Šã€‚</p><p>å¦‚æœä½ æ²¡æœ‰ä½¿ç”¨ BCC ç­‰åº“ï¼Œä½ å°±éœ€è¦è‡ªå·±æ¥å®ç°ç±»ä¼¼çš„é€»è¾‘ã€‚è€Œè¦å®ç°å®ƒï¼Œè¿˜éœ€è¦è¯¦ç»†äº†è§£ ELF æ–‡ä»¶æ ¼å¼ï¼Œä»¥åŠå¯¹åº”åº“å‡½æ•°çš„ä½¿ç”¨æ–¹æ³•ï¼Œè¿™ä¸ªéš¾åº¦å°±è¦å¤§å¾ˆå¤šäº†ã€‚è¿™ä¹Ÿæ˜¯æˆ‘æ¨èä½ ä½¿ç”¨ BCCã€libbpf ç­‰åº“è¿›è¡Œ eBPF ç¨‹åºå¼€å‘çš„åŸå› ã€‚è¿™äº›åº“å·²ç»å¸®ä½ æŠŠå¾ˆå¤šç¹æ‚ä¸”è·Ÿ eBPF äº‹ä»¶å¤„ç†ä¸»è¦é€»è¾‘æ— å…³çš„éƒ¨åˆ†å®ç°å¥½äº†ï¼Œä½ åªéœ€è¦è°ƒç”¨å®ƒä»¬å®ç°ä½ æœ€æ ¸å¿ƒçš„ eBPF å¤„ç†é€»è¾‘å³å¯ã€‚</p><p>å°†ä¸Šè¿°ä»£ç ä¿å­˜åˆ°&nbsp;<code>bashreadline.py</code>&nbsp;ï¼Œç„¶åæ‰§è¡Œ&nbsp;<code>sudo python3 bashreadline.py</code>&nbsp;ï¼Œæˆ‘ä»¬å°±å¯ä»¥è¿è¡Œè¿™ä¸ªè·Ÿè¸ªç¨‹åºã€‚æ‰“å¼€ä¸€ä¸ªæ–°ç»ˆç«¯å¹¶è¿è¡Œ&nbsp;<code>ls</code>&nbsp;å‘½ä»¤ï¼Œå›åˆ°ç¬¬ä¸€ä¸ªç»ˆç«¯ï¼Œä½ å°±å¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„è¾“å‡ºï¼š</p><pre><code class=\"language-plain\">TIME      UID    COMMAND\n07:17:07  1000   ls\n</code></pre><p>ä»è¿™é‡Œçš„ä¾‹å­ä¸­ï¼Œä½ å¯ä»¥å‘ç°ï¼šç¼–è¯‘å‹è¯­è¨€åº”ç”¨ç¨‹åºçš„è·Ÿè¸ªä¸å†…æ ¸çš„è·Ÿè¸ªæ˜¯ç±»ä¼¼çš„ï¼Œåªä¸è¿‡æ˜¯æŠŠè·Ÿè¸ªç±»å‹ä» kprobe æ¢æˆäº† uprobe æˆ–è€… USDTï¼ˆUSDT çš„ä¾‹å­æˆ‘ä¼šåœ¨æ¥ä¸‹æ¥çš„å†…å®¹ä¸­è®²åˆ°ï¼‰ã€‚ä¸åŒçš„åœ°æ–¹åœ¨äºç¬¦å·ä¿¡æ¯ï¼šåº”ç”¨ç¨‹åºçš„ç¬¦å·ä¿¡æ¯å¯ä»¥å­˜æ”¾åœ¨ ELF äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œä¹Ÿå¯ä»¥ä»¥å•ç‹¬æ–‡ä»¶çš„å½¢å¼ï¼Œæ”¾åˆ°è°ƒè¯•æ–‡ä»¶ä¸­ï¼›è€Œå†…æ ¸çš„ç¬¦å·ä¿¡æ¯é™¤äº†å¯ä»¥å­˜æ”¾åˆ°å†…æ ¸äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ä¹‹å¤–ï¼Œè¿˜ä¼šä»¥&nbsp;<code>/proc/kallsyms</code>&nbsp;å’Œ&nbsp;<code>/sys/kernel/debug</code>&nbsp;ç­‰å½¢å¼æš´éœ²åˆ°ç”¨æˆ·ç©ºé—´ã€‚</p><h2>è·Ÿè¸ªè§£é‡Šå‹è¯­è¨€åº”ç”¨ç¨‹åº</h2><p>äº†è§£äº†ç¼–è¯‘å‹è¯­è¨€åº”ç”¨ç¨‹åºçš„è·Ÿè¸ªæ–¹æ³•ä¹‹åï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹è§£é‡Šå‹è¯­è¨€åº”ç”¨ç¨‹åºåˆè¯¥å¦‚ä½•è·Ÿè¸ªã€‚</p><p>ä¸Šé¢æˆ‘å·²ç»æåˆ°ï¼Œä½ æ— æ³•ä»è§£é‡Šå‹è¯­è¨€çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ç›´æ¥è·å–åº”ç”¨ç¨‹åºçš„è°ƒè¯•ä¿¡æ¯ï¼Œè€Œåªèƒ½è·å¾—è§£é‡Šå™¨æœ¬èº«çš„ç¬¦å·ä¿¡æ¯ã€‚æ‰€ä»¥ï¼Œå¯¹äºè¿™ç±»è¯­è¨€å¼€å‘çš„åº”ç”¨ç¨‹åºï¼Œé€šå¸¸éœ€è¦è·Ÿè¸ªè§£é‡Šå™¨å†…çš„å‡½æ•°ï¼Œå†ä»å…¶å‚æ•°ä¸­è·å–åº”ç”¨ç¨‹åºçš„è¿è¡Œç»†èŠ‚ã€‚</p><p>å¯¹äºå„ç§è§£é‡Šå‹ç¼–ç¨‹è¯­è¨€çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆå¦‚ Pythonã€PHP ç­‰ï¼‰ï¼Œä½ å¯ä»¥ä½¿ç”¨ç±»ä¼¼ç¼–è¯‘å‹è¯­è¨€åº”ç”¨ç¨‹åºçš„è·Ÿè¸ªç‚¹æŸ¥è¯¢æ–¹æ³•ï¼ŒæŸ¥è¯¢å®ƒä»¬åœ¨è§£é‡Šå™¨å±‚é¢çš„ uprobe å’Œ USDT è·Ÿè¸ªç‚¹ã€‚æ¯”å¦‚ï¼Œå¯¹äº Python3 æ¥è¯´ï¼Œä½ å¯ä»¥æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤æŸ¥è¯¢ï¼š</p><pre><code class=\"language-bash\">sudo bpftrace -l '*:/usr/bin/python3:*'\n</code></pre><p>å‘½ä»¤æ‰§è¡Œåï¼Œä½ ä¼šå¾—åˆ° 1500 å¤šä¸ªè·Ÿè¸ªç‚¹ã€‚æ¥ä¸‹æ¥çš„éš¾ç‚¹åœ¨äºï¼Œ<strong>å¦‚ä½•ä»è¿™äº›è§£é‡Šå™¨çš„è·Ÿè¸ªç‚¹ä¸­æ‰¾å‡ºåº”ç”¨ç¨‹åºçš„å‡½æ•°ä¿¡æ¯</strong>ï¼Œæ‰€ä»¥ä½ éœ€è¦å¯¹è§£é‡Šå™¨çš„è¿è¡ŒåŸç†æœ‰ä¸€å®šçš„äº†è§£ã€‚</p><p>æ—¢ç„¶æˆ‘ä»¬è¿™é—¨è¯¾ä¸­çš„æ¡ˆä¾‹å¤§é‡ä½¿ç”¨äº† Python è¿™ç§è§£é‡Šå‹ç¼–ç¨‹è¯­è¨€ï¼Œé‚£æˆ‘ä»¬ä¸‹é¢å°±æ¥è¯•è¯•ï¼Œèƒ½ä¸èƒ½ä» Python è§£é‡Šå™¨çš„è·Ÿè¸ªç‚¹ä¸­ï¼Œè·Ÿè¸ªåº”ç”¨ç¨‹åºçš„å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ã€‚</p><p>å®é™…ä¸Šï¼Œæ ¹æ® Python&nbsp;<a href=\"https://docs.python.org/zh-cn/3/howto/instrumentation.html\">æ–‡æ¡£</a>ï¼Œä¸ºå…¶å¼€å¯ USDT è·Ÿè¸ªç‚¹ï¼ˆç¼–è¯‘é€‰é¡¹ä¸º&nbsp;<code>--with-dtrace</code>ï¼‰ä¹‹åï¼ŒPython3 äºŒè¿›åˆ¶æ–‡ä»¶ä¸­å°±ä¼šåŒ…å«ä¸€ç³»åˆ—çš„ USDT è·Ÿè¸ªç‚¹ã€‚è¿™äº›è·Ÿè¸ªç‚¹ä¹Ÿå¯ä»¥é€šè¿‡ bpftrace æŸ¥è¯¢åˆ°ï¼š</p><pre><code class=\"language-bash\">$ bpftrace -l '*:/usr/bin/python3:*'\nusdt:/usr/bin/python3:python:audit\nusdt:/usr/bin/python3:python:function__entry\nusdt:/usr/bin/python3:python:function__return\nusdt:/usr/bin/python3:python:gc__done\nusdt:/usr/bin/python3:python:gc__start\nusdt:/usr/bin/python3:python:import__find__load__done\nusdt:/usr/bin/python3:python:import__find__load__start\nusdt:/usr/bin/python3:python:line\n</code></pre><p>å…¶ä¸­ï¼Œè·Ÿå‡½æ•°è°ƒç”¨ç›¸å…³çš„æ­£æ˜¯&nbsp;<code>function__entry</code>&nbsp;å’Œ&nbsp;<code>function__return</code>ï¼Œå› è€Œå®ƒä»¬å°±å¯ä»¥ç”¨æ¥è·Ÿè¸ªå‡½æ•°çš„è°ƒç”¨è¿‡ç¨‹ã€‚æ ¹æ® Python&nbsp;<a href=\"https://docs.python.org/zh-cn/3/howto/instrumentation.html#available-static-markers\">æ–‡æ¡£</a>ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°çš„å®šä¹‰æ ¼å¼ä¸ºï¼š</p><pre><code class=\"language-plain\">// ä¸‰ä¸ªå‚æ•°åˆ†åˆ«æ˜¯æ–‡ä»¶åã€å‡½æ•°åå’Œè¡Œå·\nfunction__entry(str filename, str funcname, int lineno)\nfunction__return(str filename, str funcname, int lineno)\n</code></pre><p>æœ‰äº†è·Ÿè¸ªç‚¹çš„å®šä¹‰æ ¼å¼ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ eBPF æ¥è·Ÿè¸ªè¿™äº›å‡½æ•°ã€‚æ¯”å¦‚ï¼Œå¯¹ <code>function__entry</code> æ¥è¯´ï¼Œæ‰§è¡Œä¸‹é¢çš„ bpftrace å•è¡Œå‘½ä»¤ï¼Œå°±å¯ä»¥è·Ÿè¸ª Python å‡½æ•°çš„è°ƒç”¨ä¿¡æ¯ï¼š</p><pre><code class=\"language-bash\">sudo bpftrace -e 'usdt:/usr/bin/python3:function__entry { printf(\"%s:%d %s\\n\", str(arg0), arg2, str(arg1))}'\n</code></pre><p>åœ¨è¿™ä¸ªå‘½ä»¤ä¸­ï¼Œ <code>arg0</code>ã€ <code>arg1</code> ã€ <code>arg2</code> è¡¨ç¤ºå‡½æ•°çš„ä¸‰ä¸ªå‚æ•°ã€‚è¿™æ¡å‘½ä»¤çš„å«ä¹‰å°±æ˜¯æŠŠè¿™å‡ ä¸ªå‚æ•°æ‹¼æ¥æˆ <code>æ–‡ä»¶å:è¡Œå· å‡½æ•°å</code> çš„æ ¼å¼ï¼Œç„¶åå†æ‰“å°åˆ°ç»ˆç«¯ä¸Šã€‚</p><p>æ‰“å¼€ä¸€ä¸ªæ–°ç»ˆç«¯ï¼Œå¹¶æ‰§è¡Œä¸‹é¢çš„ Python å‘½ä»¤å¼€å¯ä¸€ä¸ª http æœåŠ¡ï¼š</p><pre><code class=\"language-bash\">python3 -m http.server 8080\n</code></pre><p>ç„¶åï¼Œå†å›åˆ°ç¬¬ä¸€ä¸ªç»ˆç«¯ï¼Œå°±å¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„è¾“å‡ºï¼š</p><pre><code class=\"language-plain\">...\n/usr/lib/python3.9/socketserver.py:254 service_actions\n/usr/lib/python3.9/selectors.py:403 select\n/usr/lib/python3.9/socketserver.py:254 service_actions\n/usr/lib/python3.9/selectors.py:403 select\n</code></pre><p>æ­å–œï¼Œåˆ°è¿™é‡Œï¼Œä½ å·²ç»æˆåŠŸä» Python è§£é‡Šå™¨ä¸­è·Ÿè¸ªåˆ°äº†åº”ç”¨ç¨‹åºä¸­çš„å‡½æ•°è°ƒç”¨ã€‚</p><p>å¯¹äºå…¶ä»–çš„è§£é‡Šå‹ç¼–ç¨‹è¯­è¨€ï¼Œå…¶è·Ÿè¸ªè¿‡ç¨‹ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œåªæ˜¯è¦æŠŠè·Ÿè¸ªå‡½æ•°æ¢æˆè¯¥è¯­è¨€è§£é‡Šå™¨ä¸­å¤„ç†å‡½æ•°è°ƒç”¨çš„è·Ÿè¸ªç‚¹ã€‚å¦‚æœä½ ä¸äº†è§£å®ƒä»¬åº•å±‚çš„å®ç°åŸç†ï¼Œå¯ä»¥å‚è€ƒ BCC çš„&nbsp;<a href=\"https://github.com/iovisor/bcc/blob/b82de2db5eece171decc5205f8a426cf8790d19e/tools/lib/ucalls.py#L60-L109\">ucalls</a>&nbsp;å’Œ&nbsp;<a href=\"https://github.com/iovisor/bcc/blob/master/tools/lib/uflow.py\">uflow</a>&nbsp;ï¼Œå¼€å‘é’ˆå¯¹å®ƒä»¬çš„è·Ÿè¸ªç¨‹åºã€‚</p><p>åˆšæ‰æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ bpftraceï¼Œå¦‚æœä½ æƒ³ä½¿ç”¨ BCC å’Œ libbpf æ¥å¼€å‘æ›´å¤æ‚çš„è·Ÿè¸ªåŠŸèƒ½ä¹Ÿæ˜¯æ²¡é—®é¢˜çš„ã€‚æ¯”å¦‚ï¼Œè¿˜æ˜¯ä»¥ BCC ä¸ºä¾‹ï¼Œå®ƒçš„è·Ÿè¸ªè¿‡ç¨‹ä¸ç¼–è¯‘å‹è¯­è¨€ç›¸æ¯”ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªä¸åŒç‚¹ï¼Œä¸‹é¢æˆ‘ä»¬æ¥å…·ä½“çœ‹çœ‹ã€‚</p><p>ç¬¬ä¸€ï¼Œåœ¨ eBPF ç¨‹åºéƒ¨åˆ†ï¼ŒUSDT è·Ÿè¸ªç‚¹éœ€è¦è°ƒç”¨&nbsp;<code>bpf_usdt_readarg()</code>&nbsp;å‡½æ•°ï¼Œæ¥è¯»å–å‡½æ•°å‚æ•°ï¼ˆå¯¹äºæŒ‡é’ˆç±»æ•°æ®ï¼Œè¿˜éœ€è°ƒç”¨&nbsp;<code>bpf_probe_read_user()</code>&nbsp;è¯»å–æŒ‡é’ˆæŒ‡å‘çš„å†…å®¹ï¼‰ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code class=\"language-c++\">// å¤´æ–‡ä»¶å¼•ç”¨å’Œæ•°æ®ç»“æ„å®šä¹‰...\n\nint print_functions(struct pt_regs *ctx)\n{\n    uint64_t argptr;\n    struct data_t data = { };\n\n  // å‚æ•°1æ˜¯æ–‡ä»¶å\n    bpf_usdt_readarg(1, ctx, &amp;argptr);\n    bpf_probe_read_user(&amp;data.filename, sizeof(data.filename),\n                (void *)argptr);\n\n  // å‚æ•°2æ˜¯å‡½æ•°å\n    bpf_usdt_readarg(2, ctx, &amp;argptr);\n    bpf_probe_read_user(&amp;data.funcname, sizeof(data.funcname),\n                (void *)argptr);\n\n  // å‚æ•°3æ˜¯è¡Œå·\n  bpf_usdt_readarg(3, ctx, &amp;data.lineno);\n\n    // æœ€åæäº¤æ€§èƒ½äº‹ä»¶\n    events.perf_submit(ctx, &amp;data, sizeof(data));\n    return 0;\n};\n</code></pre><p>ç¬¬äºŒï¼Œåœ¨ Python å‰ç«¯ç¨‹åºä¸­ï¼ŒæŒ‚è½½è·Ÿè¸ªç‚¹æ—¶éœ€è¦æ¢æˆ USDT è·Ÿè¸ªç‚¹ï¼Œå³ï¼š</p><pre><code class=\"language-python\">from bcc import BPF, USDT\n\nu = USDT(pid=pid)\nu.enable_probe(probe=\"function__entry\", fn_name=\"print_functions\")\nb = BPF(src_file=\"&lt;ebpf-program&gt;.c\", usdt_contexts=[u])\n\n# å…¶ä»–å¤„ç†é€»è¾‘\n</code></pre><p>é™¤äº†è¿™ä¸¤ä¸ªä¸åŒç‚¹ï¼Œå…¶ä»–çš„é€»è¾‘éƒ½æ˜¯ç±»ä¼¼çš„ã€‚é‚£ä¹ˆï¼Œå‚è€ƒä¸Šè¿°çš„ç¼–è¯‘å‹è¯­è¨€è·Ÿè¸ªç¨‹åºï¼Œä½ èƒ½åœ¨è¿™ä¸¤ä¸ªä¸åŒç‚¹çš„åŸºç¡€ä¸Šï¼Œå†™å‡ºå®Œæ•´çš„ BCC è·Ÿè¸ªç¨‹åºå—ï¼Ÿè¿™é‡Œä½ å¯ä»¥å…ˆæƒ³ä¸€æƒ³ï¼Œè¿™ä¹Ÿæ˜¯ä»Šå¤©ç•™ç»™ä½ çš„æ€è€ƒé¢˜ã€‚æ¬¢è¿ä½ åœ¨è¯¾åè·Ÿæˆ‘åˆ†äº«ä½ çš„æ€è·¯å’Œå®ç°æ–¹æ³•ã€‚</p><h2><strong>è·Ÿè¸ªå³æ—¶ç¼–è¯‘å‹è¯­è¨€åº”ç”¨ç¨‹åº</strong></h2><p>é™¤äº†ä¸Šé¢ä¸¤ç±»ç¼–ç¨‹è¯­è¨€ï¼Œè¿˜æœ‰ä¸€ç§æ˜¯ Javaã€.Net ç­‰å³æ—¶ç¼–è¯‘å‹è¯­è¨€ã€‚å¯¹äºè¿™ç±»ç¼–ç¨‹è¯­è¨€å¼€å‘çš„åº”ç”¨ç¨‹åºï¼Œåº”ç”¨æºä»£ç ä¼šå…ˆç¼–è¯‘ä¸ºå­—èŠ‚ç ï¼Œå†ç”±å³æ—¶ç¼–è¯‘å™¨ï¼ˆJITï¼‰ç¼–è¯‘ä¸ºæœºå™¨ç æ‰§è¡Œã€‚ä»¥ Java ä¸ºä¾‹ï¼ŒJava è™šæ‹Ÿæœºï¼ˆJVMï¼‰é™¤äº†ä¼šæ‰§è¡Œå¸¸è§„çš„ JIT å³æ—¶ç¼–è¯‘ä¹‹å¤–ï¼Œè¿˜ä¼šåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å¯¹è¿è¡Œæµç¨‹è¿›è¡Œå‰–æå’Œä¼˜åŒ–ï¼Œå› è€Œä¹ŸåŠ å¤§äº†è·Ÿè¸ªçš„éš¾åº¦ã€‚</p><p>åŒè§£é‡Šå‹ç¼–ç¨‹è¯­è¨€ç±»ä¼¼ï¼Œuprobe å’Œ USDT è·Ÿè¸ªåªèƒ½ç”¨åœ¨å³æ—¶ç¼–è¯‘å™¨ä¸Šï¼Œä»å³æ—¶ç¼–è¯‘å™¨çš„è·Ÿè¸ªç‚¹å‚æ•°é‡Œé¢è·å–æœ€ç»ˆåº”ç”¨ç¨‹åºçš„å‡½æ•°ä¿¡æ¯ã€‚ç”±äº USDT è·Ÿè¸ªç‚¹æ¯” uprobe æ›´ä¸ºç¨³å®šï¼Œå¦‚æœç¼–ç¨‹è¯­è¨€æä¾›äº† USDT è·Ÿè¸ªåŠŸèƒ½ï¼Œæˆ‘æ¨èæ‰“å¼€ USDT è·Ÿè¸ªï¼ˆæ¯”å¦‚ Java éœ€è¦æ‰“å¼€&nbsp;<code>--enable-dtrace</code>&nbsp;ç¼–è¯‘é€‰é¡¹ï¼‰ï¼Œå†åˆ©ç”¨ USDT è€Œä¸æ˜¯ uprobe å»è·Ÿè¸ªåº”ç”¨çš„æ‰§è¡Œè¿‡ç¨‹ã€‚</p><p>è¦æ‰¾å‡ºå³æ—¶ç¼–è¯‘å™¨çš„è·Ÿè¸ªç‚¹åŒåº”ç”¨ç¨‹åºè¿è¡Œä¹‹é—´çš„å…³ç³»ï¼Œå°±éœ€è¦ä½ å¯¹ç¼–ç¨‹è¯­è¨€çš„åº•å±‚è¿è¡ŒåŸç†éå¸¸ç†Ÿæ‚‰ï¼Œè¿™ä¹Ÿæ˜¯è·Ÿè¸ªå³æ—¶ç¼–è¯‘å‹è¯­è¨€åº”ç”¨ç¨‹åºæœ€éš¾çš„ä¸€æ­¥ã€‚ä¸è¿‡è¿™ä¸€æ­¥æ¢³ç†æ¸…æ¥šä¹‹åï¼Œå…·ä½“çš„è·Ÿè¸ªæ­¥éª¤ä¸è§£é‡Šå‹ç¼–ç¨‹è¯­è¨€åº”ç”¨ç¨‹åºæ˜¯ç±»ä¼¼çš„ã€‚</p><p>å¦‚æœä½ éœ€è¦è·Ÿè¸ªè¿™ç±»ç¼–ç¨‹è¯­è¨€å¼€å‘çš„åº”ç”¨ï¼Œå¯ä»¥å‚è€ƒ BCC æä¾›çš„ä¸€ç³»åˆ—<a href=\"https://github.com/iovisor/bcc/tree/master/tools/lib\">ç”¨æˆ·æ€è·Ÿè¸ªåº“</a>ï¼Œè¿™é‡Œé¢å·²ç»åŒ…å«äº†å¸¸è§çš„å‡ ç§ç¼–ç¨‹è¯­è¨€çš„é€‚é…ï¼Œå…·ä½“çš„è·Ÿè¸ªæ­¥éª¤æˆ‘åœ¨è¿™é‡Œå°±ä¸å±•å¼€äº†ã€‚</p><h2><strong>å°ç»“</strong></h2><p>ä»Šå¤©ï¼Œæˆ‘å¸¦ä½ ä¸€èµ·æ¢³ç†äº†åº”ç”¨è¿›ç¨‹çš„è·Ÿè¸ªæ–¹æ³•ï¼Œå¹¶ä»¥ Bash å’Œ Python è¿™ä¸¤ç§ç¼–ç¨‹è¯­è¨€ä¸ºä¾‹ï¼Œå¸¦ä½ å¼€å‘äº†å®ƒä»¬çš„ uprobe å’Œ USDT ç­‰ä¸åŒç±»å‹çš„è·Ÿè¸ªç¨‹åºã€‚</p><p>åœ¨è·Ÿè¸ªåº”ç”¨è¿›ç¨‹ä¹‹å‰ï¼Œä½ éœ€è¦å…ˆè·å–è¿™ä¸ªè¿›ç¨‹æ‰€å¯¹åº”çš„äºŒè¿›åˆ¶æ–‡ä»¶çš„è·Ÿè¸ªç‚¹ï¼Œä»¥åŠè¿™äº›è·Ÿè¸ªç‚¹åŒåº”ç”¨ç¨‹åºå‡½æ•°çš„å¯¹åº”å…³ç³»ã€‚<strong>è¿™ä¸ªå¯¹åº”å…³ç³»ä¾èµ–äºç¼–ç¨‹è¯­è¨€çš„ç±»å‹</strong>ï¼šç¼–è¯‘å‹è¯­è¨€å¼€å‘çš„ç¨‹åºä¸­ç›´æ¥åŒ…å«äº†åº”ç”¨ç¨‹åºçš„ç¬¦å·ä¿¡æ¯ï¼Œå› è€Œå¯ä»¥ç›´æ¥æ‹¿æ¥è·Ÿè¸ªï¼›è€Œè§£é‡Šå‹è¯­è¨€å’Œå³æ—¶ç¼–è¯‘å‹è¯­è¨€çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼ŒåªåŒ…å«äº†è§£é‡Šå™¨æˆ–å³æ—¶ç¼–è¯‘å™¨çš„ç¬¦å·ä¿¡æ¯ï¼Œæ‰€ä»¥åº”ç”¨ç¨‹åºçš„è¿è¡ŒçŠ¶æ€è¿˜éœ€è¦ä»è§£é‡Šå™¨æˆ–å³æ—¶ç¼–è¯‘å™¨è·Ÿè¸ªçš„å‚æ•°ä¸­å»è·å–ã€‚</p><p>åœ¨è¿™ä¸€è®²ç»“æŸä¹‹å‰ï¼Œæˆ‘è¿˜æƒ³æé†’ä½ ï¼š<strong>ç”¨æˆ·è¿›ç¨‹çš„è·Ÿè¸ª</strong><strong>ï¼Œ</strong><strong>æœ¬è´¨ä¸Šæ˜¯é€šè¿‡æ–­ç‚¹å»æ‰§è¡Œ uprobe å¤„ç†ç¨‹åºã€‚</strong>è™½ç„¶å†…æ ¸ç¤¾åŒºå·²ç»å¯¹ BPF åšäº†å¾ˆå¤šçš„æ€§èƒ½è°ƒä¼˜ï¼Œè·Ÿè¸ªç”¨æˆ·æ€å‡½æ•°ï¼ˆç‰¹åˆ«æ˜¯é”äº‰ç”¨ã€å†…å­˜åˆ†é…ä¹‹ç±»çš„é«˜é¢‘å‡½æ•°ï¼‰è¿˜æ˜¯æœ‰å¯èƒ½å¸¦æ¥å¾ˆå¤§çš„æ€§èƒ½å¼€é”€ã€‚å› æ­¤ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨ uprobe æ—¶ï¼Œåº”è¯¥å°½é‡é¿å…è·Ÿè¸ªé«˜é¢‘å‡½æ•°ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>åœ¨è·Ÿè¸ª Python è¯­è¨€ç¨‹åºçš„ BCC æ¡ˆä¾‹ä¸­ï¼Œæˆ‘åˆ—å‡ºäº†å®ƒåœ¨ä½¿ç”¨ USDT è·Ÿè¸ªæ—¶ï¼Œç›¸å¯¹äºç¼–è¯‘å‹è¯­è¨€çš„ä¸¤ä¸ªä¸åŒç‚¹ï¼š</p><ul>\n<li>eBPF ç¨‹åºä¸­éœ€è¦è°ƒç”¨&nbsp;<code>bpf_usdt_readarg()</code>&nbsp;æ¥è¯»å–å‚æ•°ï¼›</li>\n<li>Python å‰ç«¯ä¸­éœ€è¦æŒ‚è½½ USDT è·Ÿè¸ªç‚¹ã€‚</li>\n</ul><p>æ ¹æ®è¿™äº›æç¤ºï¼Œä»¥åŠä¸Šé¢çš„ç¼–è¯‘å‹è¯­è¨€ BCC è·Ÿè¸ªç¨‹åºï¼Œä½ èƒ½è¯•ç€å†™å‡ºå®Œæ•´çš„ BCC è·Ÿè¸ªç¨‹åºå—ï¼Ÿæ¬¢è¿åœ¨è¯„è®ºåŒºå’Œæˆ‘åˆ†äº«ä½ çš„æ€è·¯å’Œè§£å†³æ–¹æ³•ã€‚</p><p>æœŸå¾…ä½ åœ¨ç•™è¨€åŒºå’Œæˆ‘è®¨è®ºï¼Œä¹Ÿæ¬¢è¿æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™ä½ çš„åŒäº‹ã€æœ‹å‹ã€‚è®©æˆ‘ä»¬ä¸€èµ·åœ¨å®æˆ˜ä¸­æ¼”ç»ƒï¼Œåœ¨äº¤æµä¸­è¿›æ­¥ã€‚</p>","comments":[{"had_liked":false,"id":332985,"user_name":"è«å","can_delete":false,"product_type":"c1","uid":1007254,"ip_address":"","ucode":"E28F2602BA25DD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/5e/96/a03175bc.jpg","comment_is_top":false,"comment_ctime":1643941109,"is_pvip":false,"replies":[{"id":121732,"content":"1. å…¶å®æœ€ç»ˆè¿˜æ˜¯è¦çœ‹è·Ÿè¸ªçš„ç›®çš„æ˜¯ä»€ä¹ˆï¼šå¦‚æœæ˜¯è¦æ’æŸ¥Bashå†…éƒ¨çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œé‚£å°±æ˜¯è·Ÿè¸ªç¼–è¯‘å‹è¯­è¨€ï¼›ä½†è¦æ˜¯æ’æŸ¥SHELLè„šæœ¬çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œé‚£å°±å˜æˆäº†è·Ÿè¸ªè§£é‡Šæ€§è¯­è¨€ã€‚\n2. éå¸¸æ£’çš„ç­”æ¡ˆï¼","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001282,"ctime":1644117268,"ip_address":"","comment_id":332985,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"1. è·Ÿè¸ªç¼–è¯‘å‹è¯­è¨€åº”ç”¨ç¨‹åºä»¥ Bash Shell ä½œä¸ºä¾‹å­ï¼Œè§‰å¾—æœ‰äº›å®¹æ˜“ä¸è§£é‡Šå‹è¯­è¨€æ··æ·†ã€‚è§£é‡Šå‹è¯­è¨€çš„ç‰¹å¾æ˜¯è§£é‡Šç¨‹åºè‡ªèº«ä¸ºç¼–è¯‘å‹ç¨‹åºï¼Œåˆ©ç”¨è‡ªèº«å†…ç½®çš„å‡½æ•°è¿›è¡Œè¯­æ³•åˆ†æå’Œæ‰§è¡Œï¼ŒBash readline å‡½æ•°çš„åŠŸèƒ½å³æ˜¯å¦‚æ­¤ã€‚ä»¥ç¼–è¯‘å‹è¯­è¨€ Golang helloworld ç¨‹åºä½¿ç”¨ uprobes æˆ–è€…å¼€æºçš„ Nginx ä½¿ç”¨ USDT å¯èƒ½æ›´æ°å½“ä¸€äº›ã€‚ \n\n2. æ€è€ƒé¢˜å®Œæ•´çš„ BCC è¿½è¸ªç¨‹åºï¼š\n\n----------- python_functions.c -------------\n\n#include &lt;uapi&#47;linux&#47;ptrace.h&gt;\n\nstruct data_t {\n\tchar filename[128];\n\tchar funcname[64];\n\tint lineno;\n};\nBPF_PERF_OUTPUT(events);\n\nint print_functions(struct pt_regs *ctx)\n{\n\tuint64_t argptr;\n\tstruct data_t data = { };\n\n\tbpf_usdt_readarg(1, ctx, &amp;argptr);\n\tbpf_probe_read_user(&amp;data.filename, sizeof(data.filename), (void *)argptr);\n\tbpf_usdt_readarg(2, ctx, &amp;argptr);\n\tbpf_probe_read_user(&amp;data.funcname, sizeof(data.funcname), (void *)argptr);\n\tbpf_usdt_readarg(3, ctx, &amp;data.lineno);\n\n\tevents.perf_submit(ctx, &amp;data, sizeof(data));\n\n\treturn 0;\n};\n\n----------- python_functions.py -------------\n\n#!&#47;usr&#47;bin&#47;python3\n\nimport sys\nfrom bcc import BPF, USDT\n\nif len(sys.argv) &lt; 2:\n    print(&quot;Usage: %s &lt;tracee_pid&gt;&quot; % sys.argv[0])\n    sys.exit(1)\n\nu = USDT(pid=int(sys.argv[1]))\nu.enable_probe(probe=&quot;function__entry&quot;, fn_name=&quot;print_functions&quot;)\nb = BPF(src_file=&quot;python_functions.c&quot;, usdt_contexts=[u])\n\n\ndef print_event(cpu, data, size):\n    event = b[&quot;events&quot;].event(data)\n    printb(&quot;%-9s %-6d %s&quot; % (event.filename, event.lineno, event.funcname))\n\n\nprint(&quot;%-9s %-6s %s&quot; % (&quot;FILENAME&quot;, &quot;LINENO&quot;, &quot;FUNCTION&quot;))\n\nb[&quot;events&quot;].open_perf_buffer(print_event)\nwhile True:\n    try:\n        b.perf_buffer_poll()\n    except KeyboardInterrupt:\n        exit()","like_count":10,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":549590,"discussion_content":"1. å…¶å®æœ€ç»ˆè¿˜æ˜¯è¦çœ‹è·Ÿè¸ªçš„ç›®çš„æ˜¯ä»€ä¹ˆï¼šå¦‚æœæ˜¯è¦æ’æŸ¥Bashå†…éƒ¨çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œé‚£å°±æ˜¯è·Ÿè¸ªç¼–è¯‘å‹è¯­è¨€ï¼›ä½†è¦æ˜¯æ’æŸ¥SHELLè„šæœ¬çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œé‚£å°±å˜æˆäº†è·Ÿè¸ªè§£é‡Šæ€§è¯­è¨€ã€‚\n2. éå¸¸æ£’çš„ç­”æ¡ˆï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644117268,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":333006,"user_name":"ZR2021","can_delete":false,"product_type":"c1","uid":1707352,"ip_address":"","ucode":"4F685C7516F057","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKwGurTWOiaZ2O2oCdxK9kbF4PcwGg0ALqsWhNq87hWvwPy8ZU9cxRzmcGOgdIeJkTOoKfbxgEKqrg/132","comment_is_top":false,"comment_ctime":1643951732,"is_pvip":false,"replies":[{"id":121731,"content":"eBPF æ ˆç©ºé—´çš„é™åˆ¶è·Ÿè¦è·Ÿè·Ÿè¸ªçš„äº‹ä»¶æ˜¯æ²¡å…³ç³»çš„ï¼Œä½†å…¶å®éƒ½å¯ä»¥é€šè¿‡æ˜ å°„é¿å…å†…å­˜é™åˆ¶çš„é—®é¢˜ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001282,"ctime":1644117020,"ip_address":"","comment_id":333006,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"è€å¸ˆï¼Œè·Ÿè¸ªç”¨æˆ·æ€ç¨‹åºçš„æ—¶å€™è¿˜æœ‰512å­—èŠ‚çš„é™åˆ¶å—","like_count":4,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":549588,"discussion_content":"eBPF æ ˆç©ºé—´çš„é™åˆ¶è·Ÿè¦è·Ÿè·Ÿè¸ªçš„äº‹ä»¶æ˜¯æ²¡å…³ç³»çš„ï¼Œä½†å…¶å®éƒ½å¯ä»¥é€šè¿‡æ˜ å°„é¿å…å†…å­˜é™åˆ¶çš„é—®é¢˜ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644117020,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1707352,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKwGurTWOiaZ2O2oCdxK9kbF4PcwGg0ALqsWhNq87hWvwPy8ZU9cxRzmcGOgdIeJkTOoKfbxgEKqrg/132","nickname":"ZR2021","note":"","ucode":"4F685C7516F057","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":549957,"discussion_content":"è°¢è€å¸ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644310694,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":338876,"user_name":"Geek3340","can_delete":false,"product_type":"c1","uid":2028953,"ip_address":"","ucode":"C64D302CD53513","user_header":"","comment_is_top":false,"comment_ctime":1647768835,"is_pvip":false,"replies":[{"id":123960,"content":"ğŸ‘ è°¢è°¢åˆ†äº«å®‰è£…æ­¥éª¤","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001282,"ctime":1647959104,"ip_address":"","comment_id":338876,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"sudo apt install bash-dbgsym å‘½ä»¤ï¼Œæ‰§è¡Œåæ‰¾ä¸åˆ°dbgsymåŒ…çš„ï¼Œå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« \nhttps:&#47;&#47;cloud.tencent.com&#47;developer&#47;article&#47;1637887","like_count":2,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":557777,"discussion_content":"ğŸ‘ è°¢è°¢åˆ†äº«å®‰è£…æ­¥éª¤","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1647959104,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":333007,"user_name":"Geek_59a6f9","can_delete":false,"product_type":"c1","uid":2102108,"ip_address":"","ucode":"6CDDE9A4E57917","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJlaNica7xRH6LlMNJtrbK0toc1od8YdqLZOD2AbnOZ2QyKC13gvrrL9cOx5dyYNcsHnJkR6K4ibxZQ/132","comment_is_top":false,"comment_ctime":1643953624,"is_pvip":false,"replies":[{"id":121730,"content":"å—¯å—¯ï¼Œå±•ç¤ºæ•ˆæœéƒ½æ˜¯å¯ä»¥åœ¨ç”¨æˆ·æ€ç¨‹åºä¸­å»è‡ªå®šä¹‰çš„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001282,"ctime":1644116905,"ip_address":"","comment_id":333007,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"ç”¨æˆ·æ€è¿›ç¨‹è·Ÿè¸ªæ˜¯ä¸æ˜¯ä½¿ç”¨fridaæ•ˆæœæ›´å¥½ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":549587,"discussion_content":"å—¯å—¯ï¼Œå±•ç¤ºæ•ˆæœéƒ½æ˜¯å¯ä»¥åœ¨ç”¨æˆ·æ€ç¨‹åºä¸­å»è‡ªå®šä¹‰çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644116905,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":364863,"user_name":"éƒ‘å°å‡¯","can_delete":false,"product_type":"c1","uid":1766642,"ip_address":"æµ™æ±Ÿ","ucode":"AF7AF4776DBFEE","user_header":"https://static001.geekbang.org/account/avatar/00/1a/f4/f2/9a28aaff.jpg","comment_is_top":false,"comment_ctime":1671614849,"is_pvip":false,"replies":[{"id":134619,"content":"BCCæä¾›äº†ä¸€äº›Javaçš„å·¥å…· https:&#47;&#47;github.com&#47;iovisor&#47;bcc&#47;tree&#47;master&#47;toolsï¼ˆjavaå¼€å¤´çš„å·¥å…·ï¼‰ï¼Œä½ å¯ä»¥è¯•è¯•çœ‹","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001282,"ctime":1677497819,"ip_address":"ä¸Šæµ·","comment_id":364863,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"è€å¸ˆï¼Œå’¨è¯¢ä¸‹ibm jdkï¼Œä½¿ç”¨bccçš„è¯æœ‰åŠæ³•ä¹ˆï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":606927,"discussion_content":"BCCæä¾›äº†ä¸€äº›Javaçš„å·¥å…· https://github.com/iovisor/bcc/tree/master/toolsï¼ˆjavaå¼€å¤´çš„å·¥å…·ï¼‰ï¼Œä½ å¯ä»¥è¯•è¯•çœ‹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1677497819,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":336961,"user_name":"â”‚ï¼Sk","can_delete":false,"product_type":"c1","uid":2453415,"ip_address":"","ucode":"A2EEB2E9585A77","user_header":"https://static001.geekbang.org/account/avatar/00/25/6f/a7/565214bc.jpg","comment_is_top":false,"comment_ctime":1646492827,"is_pvip":false,"replies":[{"id":123144,"content":"æ˜¯çš„","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001282,"ctime":1646568660,"ip_address":"","comment_id":336961,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"è€å¸ˆæ‚¨å¥½ï¼Œè¯·æ•™ä¸€ä¸‹\n\n1. æ‰§è¡Œäº† strip å‘½ä»¤åˆ é™¤äº†  .symtab  çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ˜¯å¦å°±â€œä¸èƒ½â€ç”¨ .symtab é‡Œçš„ç¬¦å·æ‰§è¡Œ bpftrace -e &#39;uretprobe:&#47;usr&#47;bin&#47;bash:ç¬¦å·  {...}&#39; ï¼Ÿ\n\n2. å¦‚æœ 1. ä¸­çš„ç†è§£æ˜¯å¯¹çš„ï¼Œé‚£ä¹ˆä¸Šé¢çš„ &#47;usr&#47;bin&#47;bash çš„ .symtab å®é™…å·²ç»è¢« strip äº†ï¼Œä½†æ˜¯è¿˜èƒ½æ‰§è¡Œä¸Šé¢çš„ trace æ˜¯å¦æ˜¯å› ä¸º BCC ä¼šç”¨ &#47;usr&#47;bin&#47;bash çš„ build id å» &#47;usr&#47;lib&#47;debug&#47;.build-id&#47; å…³è”ç›¸åº”çš„ç¬¦å·è¡¨ï¼Œç„¶åå†ç”¨ç¬¦å·æ‰¾åˆ°å‡½æ•°åœ°å€ï¼Ÿ\n\nè°¢è°¢è€å¸ˆï¼","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":554718,"discussion_content":"æ˜¯çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1646568661,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":336894,"user_name":"ç‹æ’","can_delete":false,"product_type":"c1","uid":2065891,"ip_address":"","ucode":"D985FDF96A6C69","user_header":"https://static001.geekbang.org/account/avatar/00/1f/85/e3/7df90bff.jpg","comment_is_top":false,"comment_ctime":1646451999,"is_pvip":false,"replies":[{"id":123143,"content":"å—¯ è¿™æ—¶å€™å¯ä»¥è·Ÿè¸ªä¸€ä¸‹ç›¸å…³å‡½æ•°çš„å†…æ ¸è°ƒç”¨æ ˆ","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001282,"ctime":1646568641,"ip_address":"","comment_id":336894,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"æŸçº¿ç¨‹CPUå ç”¨ç‡è¿‡é«˜ï¼Œé€šè¿‡perfå·¥å…·ç”Ÿæˆäº†è¯¥çº¿ç¨‹çš„ç«ç„°å›¾ã€‚å‘ç°è¯¥çº¿ç¨‹çš„ç³»ç»Ÿå‡½æ•°å æ¯”è¾ƒé«˜ï¼Œä½†æ˜¯åˆæ— æ³•æŸ¥åˆ°è¿™äº›ç³»ç»Ÿå‡½æ•°çš„è°ƒç”¨å †æ ˆã€‚ï¼ˆç«ç„°å›¾ä¸­ï¼Œia32_sysenter_targetå‡½æ•°å æ¯”çº¦6%ï¼Œsysexit_from_sys_callå‡½æ•°å æ¯”çº¦9%ã€‚ï¼‰\n\nç‰¹åˆ«æƒ³ææ‡‚è¿™äº›å†…æ ¸å‡½æ•°æ˜¯ä»€ä¹ˆæ—¶å€™è¢«è°ƒç”¨çš„ï¼Œè°ƒç”¨å †æ ˆæ˜¯æ€ä¹ˆæ ·çš„ï¼Œä¸ºä»€ä¹ˆè€—æ—¶è¿™ä¹ˆä¹…ã€‚æ‰€ä»¥ç‰¹åœ°æ¥å­¦ä¹ ebpfï¼Œå¸Œæœ›è¾¹å­¦è¾¹è§£å†³å·¥ä½œä¸­çš„å®é™…é—®é¢˜ã€‚","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":554717,"discussion_content":"å—¯ è¿™æ—¶å€™å¯ä»¥è·Ÿè¸ªä¸€ä¸‹ç›¸å…³å‡½æ•°çš„å†…æ ¸è°ƒç”¨æ ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1646568641,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1120024,"avatar":"https://static001.geekbang.org/account/avatar/00/11/17/18/e4382a8e.jpg","nickname":"æœ‰è¯†ä¹‹å£«","note":"","ucode":"23F5594193D200","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":621711,"discussion_content":"æ‰“å¡å­¦ä¹ ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1687528413,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1494491,"avatar":"https://static001.geekbang.org/account/avatar/00/16/cd/db/7467ad23.jpg","nickname":"Bachue Zhou","note":"","ucode":"3175754775CA32","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":612429,"discussion_content":"ç«ç„°å›¾é‡Œä¸æ˜¯ä¼šæœ‰å †æ ˆä¿¡æ¯å—ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1680676418,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":394823,"user_name":"è¡Œæ‰€å½“è¡Œ","can_delete":false,"product_type":"c1","uid":1922457,"ip_address":"å¹¿è¥¿","ucode":"1B36BDA6D3562A","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/WgRsoJMxcTMcDkRlR59jCDLux2JDdtz1G8Ophe3a7EnhP8lqOdFw8F7sURXkRTYXibzVicozrQ8HFYj578myJ0CA/132","comment_is_top":false,"comment_ctime":1728482234,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"è€å¸ˆæ‚¨å¥½ï¼Œbashå†å²æ‰§è¡Œå‘½ä»¤å¯ä»¥ç”¨historyæ¥å¿«æ·æŸ¥çœ‹ï¼Œé‚£ä¹ˆåœ¨å®¡è®¡æ“ä½œç³»ç»Ÿç”¨æˆ·è¡Œä¸ºå’Œæ“ä½œç³»ç»Ÿå®‰å…¨æ–¹é¢ï¼Œebpfè¿˜æœ‰ä»€ä¹ˆå…¸å‹çš„åº”ç”¨åœºæ™¯ï¼Ÿ","like_count":0},{"had_liked":false,"id":375546,"user_name":"Geek_722e86","can_delete":false,"product_type":"c1","uid":3003344,"ip_address":"ä¸­å›½é¦™æ¸¯","ucode":"BF669C3F196E30","user_header":"","comment_is_top":false,"comment_ctime":1685610967,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"è€å¸ˆï¼Œ \n\né™¤äº†ç¬¦å·è¡¨ä¹‹å¤–ï¼Œç†è®ºä¸Šä½ å¯ä»¥æŠŠ uprobe æ’æ¡©åˆ°äºŒè¿›åˆ¶æ–‡ä»¶çš„ä»»æ„åœ°å€ã€‚ä¸è¿‡è¿™è¦æ±‚ä½ å¯¹åº”ç”¨ç¨‹åº ELF æ ¼å¼çš„åœ°å€ç©ºé—´éå¸¸ç†Ÿæ‚‰ï¼Œå¹¶ä¸”å…·ä½“çš„åœ°å€ä¼šéšç€åº”ç”¨çš„è¿­ä»£æ›´æ–°è€Œå‘ç”Ÿå˜åŒ–ã€‚æ‰€ä»¥ï¼Œåœ¨éœ€è¦è·Ÿè¸ªåœ°å€çš„åœºæ™¯ä¸­ï¼Œä¸€å®šè¦è®°å¾—å» ELF äºŒè¿›åˆ¶æ–‡ä»¶åŠ¨æ€è·å–åœ°å€ä¿¡æ¯ã€‚\n\n-----------\nè¯·é—®ï¼Œ è¿™ä¸ªåº”è¯¥æ€ä¹ˆæ“ä½œå‘¢ï¼Ÿ åŠ å…¥æˆ‘OSä¸Šçš„bashå°±æ˜¯æ²¡æœ‰ç¬¦å·ä¿¡æ¯ã€‚ æˆ‘è¿˜æ˜¯æƒ³æŒ‚è½½readlineå‡½æ•°ï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿ\n\n# æŒ‚è½½uretprobeb.attach_uretprobe(name=&quot;&#47;usr&#47;bin&#47;bash&quot;, sym=&quot;readline&quot;, fn_name=&quot;bash_readline&quot;)\nè¿™ä¸ªå‚æ•°å…·ä½“æ˜¯æ€ä¹ˆå†™ï¼Ÿ\n\n\nsudo bpftrace -e &#39;uretprobe:&#47;usr&#47;bin&#47;bash:readline { printf(&quot;User %d executed \\&quot;%s\\&quot; command\\n&quot;, uid, str(retval)); }&#39;\nè¿™ä¸ªå‚æ•°æ€ä¹ˆå†™ï¼Ÿ\n","like_count":0},{"had_liked":false,"id":371964,"user_name":"Bachue Zhou","can_delete":false,"product_type":"c1","uid":1494491,"ip_address":"ä¸Šæµ·","ucode":"3175754775CA32","user_header":"https://static001.geekbang.org/account/avatar/00/16/cd/db/7467ad23.jpg","comment_is_top":false,"comment_ctime":1680570066,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"å¥½å¥‡è¿™ç§ uprobe æ˜¯æ€ä¹ˆåšåˆ°çš„ï¼Ÿåªæ˜¯è°ƒç”¨åº”ç”¨ç¨‹åºé‡Œå¦ä¸€ä¸ªå‡½æ•°ä¸ºä»€ä¹ˆä¼šè¢«å†…æ ¸ä»‹å…¥ï¼Ÿå¦‚æœ epbf ç¨‹åºæ‰§è¡Œæ—¶é—´è¾ƒé•¿ï¼Œæ˜¯ä¸æ˜¯åº”ç”¨ç¨‹åºä¼šç­‰å¾… ebpf æ‰§è¡Œå®Œå†ç»§ç»­æ‰§è¡Œï¼Ÿ","like_count":0},{"had_liked":false,"id":371962,"user_name":"Bachue Zhou","can_delete":false,"product_type":"c1","uid":1494491,"ip_address":"ä¸Šæµ·","ucode":"3175754775CA32","user_header":"https://static001.geekbang.org/account/avatar/00/16/cd/db/7467ad23.jpg","comment_is_top":false,"comment_ctime":1680569000,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100104501,"comment_content":"å…¶å®ç°åœ¨çš„è§£é‡Šå‹è„šæœ¬è¯­è¨€ï¼Œæ¯”å¦‚ Pythonï¼ŒRuby ä¹‹ç±»çš„è¯­è¨€ï¼Œå„è‡ªéƒ½æœ‰è‡ªå·±çš„å­—èŠ‚ç ï¼Œè™šæ‹Ÿæœºå’Œ JITï¼Œæœ¬è´¨ä¸Šå’Œ Java æ²¡æœ‰å¤ªå¤§å·®å¼‚ï¼Œåªæ˜¯ä¸æŠŠå­—èŠ‚ç ä¿å­˜ä¸‹æ¥è€Œå·²ã€‚","like_count":0},{"had_liked":false,"id":370235,"user_name":"çŒªå°æ“","can_delete":false,"product_type":"c1","uid":1370959,"ip_address":"åŒ—äº¬","ucode":"D9552746AE3327","user_header":"https://static001.geekbang.org/account/avatar/00/14/eb/4f/6a97b1cd.jpg","comment_is_top":false,"comment_ctime":1678592563,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100104501,"comment_content":"plan 9å¯¹åº”çš„ä¸æ˜¯elfå—ï¼Ÿæ€ä¹ˆå’Œabiæœ‰å…³ç³»ï¼Ÿ","like_count":0},{"had_liked":false,"id":358808,"user_name":"å¼ Dave","can_delete":false,"product_type":"c1","uid":2440338,"ip_address":"å››å·","ucode":"0E8B6FDEB7505B","user_header":"https://static001.geekbang.org/account/avatar/00/25/3c/92/81fa306d.jpg","comment_is_top":false,"comment_ctime":1664807941,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100104501,"comment_content":"è€å¸ˆï¼Œèƒ½è¯¦ç»†è®²è§£ä¸€ä¸‹USDTå—ï¼Ÿæ€ä¹ˆå®šä¹‰ï¼Ÿæ€ä¹ˆä½¿ç”¨ï¼Ÿæ€ä¹ˆç”Ÿæ•ˆï¼Ÿ","like_count":0},{"had_liked":false,"id":352503,"user_name":"coconut","can_delete":false,"product_type":"c1","uid":2344081,"ip_address":"","ucode":"07B95C7A6AC2F7","user_header":"https://static001.geekbang.org/account/avatar/00/23/c4/91/a017bf72.jpg","comment_is_top":false,"comment_ctime":1658734231,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":3,"product_id":100104501,"comment_content":"&#47;usr&#47;bin&#47;bash å³ä½¿æ²¡æœ‰ç”¨ debuginfo-install å®‰è£…è°ƒè¯•ç¬¦å·ï¼Œä¹Ÿèƒ½æ‰§è¡Œ bpftrace -e &#39;uretprobe:&#47;usr&#47;bin&#47;bash:readline { printf(&quot;User %d executed \\&quot;%s\\&quot; command\\n&quot;, uid, str(retval)); }&#39;","like_count":0,"discussions":[{"author":{"id":1056053,"avatar":"https://static001.geekbang.org/account/avatar/00/10/1d/35/1c0e1a30.jpg","nickname":"Tardis","note":"","ucode":"945358C7420763","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":597252,"discussion_content":"æˆ‘ä¹Ÿå‘ç°æ˜¯è¿™æ ·ï¼Œä¸çŸ¥é“æ˜¯ä»€ä¹ˆåŸå› ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1671589243,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"æ¹–åŒ—","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":341670,"user_name":"éƒ‘æµ·æˆ","can_delete":false,"product_type":"c1","uid":1192616,"ip_address":"","ucode":"B0363EA4B2C646","user_header":"https://static001.geekbang.org/account/avatar/00/12/32/a8/d5bf5445.jpg","comment_is_top":false,"comment_ctime":1649761137,"is_pvip":true,"replies":null,"discussion_count":3,"race_medal":0,"score":3,"product_id":100104501,"comment_content":"sudo bpftrace -l &#39;*:&#47;usr&#47;bin&#47;python3:*&#39; æ‰§è¡Œåæ²¡æœ‰ä»»ä½•è·Ÿè¸ªç‚¹ä¿¡æ¯","like_count":0,"discussions":[{"author":{"id":1494491,"avatar":"https://static001.geekbang.org/account/avatar/00/16/cd/db/7467ad23.jpg","nickname":"Bachue Zhou","note":"","ucode":"3175754775CA32","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":612498,"discussion_content":"æˆ‘å‘ç°åªè¦å‡çº§ Ubuntu åˆ° 22.04ï¼Œç«‹åˆ»å°±è§£å†³äº†ï¼ŒåŸç”Ÿçš„ Python 3 å°±èƒ½ç”¨ï¼Œè¿ --with-dtrace éƒ½ä¸éœ€è¦ã€‚eBPF è¿˜çœŸçš„æ˜¯å†…æ ¸ç‰ˆæœ¬å‡çº§ä¸€ç‚¹ï¼Œæ•ˆæœå°±å¥½ä¸€ç‚¹ï¼Œä¸æ˜¯åªè¦ 5.x å†…æ ¸å°±å®Œäº‹äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1680746588,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1494491,"avatar":"https://static001.geekbang.org/account/avatar/00/16/cd/db/7467ad23.jpg","nickname":"Bachue Zhou","note":"","ucode":"3175754775CA32","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":612427,"discussion_content":"æˆ‘ä¹Ÿåœ¨ç ”ç©¶è¿™ä¸ªã€‚\n----- ä»¥ä¸‹æ˜¯ ChatGPT çš„å›ç­” -----\nè¦ç¼–è¯‘å¯ç”¨Python 3çš„USDTï¼Œæ‚¨éœ€è¦è¿›è¡Œä»¥ä¸‹æ­¥éª¤ï¼š\n\nå®‰è£…DTraceå·¥å…·åŒ…\nåœ¨MacOSä¸Šï¼Œæ‚¨å¯ä»¥ä½¿ç”¨Homebrewå®‰è£…DTraceå·¥å…·åŒ…ã€‚åœ¨ç»ˆç«¯ä¸­è¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼š\n\nbrew install --HEAD dtrace\nå…‹éš†Pythonæºä»£ç åº“\nè¦æ„å»ºPythonä»¥å¯ç”¨USDTåŠŸèƒ½ï¼Œæ‚¨éœ€è¦ä»Pythonæºä»£ç åº“å…‹éš†æœ€æ–°ç‰ˆæœ¬çš„ä»£ç ã€‚åœ¨ç»ˆç«¯ä¸­è¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼š\n\ngit clone https://github.com/python/cpython.git\né…ç½®Python\nåœ¨ç»ˆç«¯ä¸­å¯¼èˆªåˆ°å…‹éš†çš„Pythonæºä»£ç ç›®å½•ï¼Œå¹¶è¿è¡Œconfigureè„šæœ¬ä»¥é…ç½®Pythonã€‚å¦‚æœæ‚¨æƒ³å¯ç”¨USDTåŠŸèƒ½ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š\n\n./configure --with-dtrace\nç¼–è¯‘å’Œå®‰è£…Python\nä½¿ç”¨makeå‘½ä»¤ç¼–è¯‘Pythonï¼Œå¹¶ä½¿ç”¨make installå‘½ä»¤å®‰è£…å®ƒï¼š\n\nmake\nsudo make install\néªŒè¯Pythonæ˜¯å¦æ­£ç¡®å®‰è£…\nåœ¨ç»ˆç«¯ä¸­è¾“å…¥ä»¥ä¸‹å‘½ä»¤ä»¥éªŒè¯Pythonæ˜¯å¦æ­£ç¡®å®‰è£…ï¼š\n\npython3 -c &#34;import sys; print(sys.getdlopenflags() &amp; 0x80)&#34;\nå¦‚æœè¾“å‡ºä¸º1ï¼Œåˆ™è¡¨ç¤ºå·²æˆåŠŸå¯ç”¨USDTåŠŸèƒ½ã€‚å¦‚æœè¾“å‡ºä¸º0ï¼Œåˆ™éœ€è¦é‡æ–°æ£€æŸ¥å‰é¢çš„æ­¥éª¤ã€‚\n\nè¯·æ³¨æ„ï¼Œå¯ç”¨USDTåŠŸèƒ½çš„èƒ½åŠ›å¯èƒ½å–å†³äºæ‚¨çš„æ“ä½œç³»ç»Ÿç‰ˆæœ¬å’ŒPythonç‰ˆæœ¬ã€‚å¦‚æœæ‚¨é‡åˆ°é—®é¢˜ï¼Œè¯·å‚é˜…Pythonæ–‡æ¡£æˆ–ä¸Pythonç¤¾åŒºè”ç³»è·å–å¸®åŠ©ã€‚\n-----\næˆ‘è¯•è¿‡äº†ï¼Œä¸è¡Œã€‚è¾“å‡ºè¿˜æ˜¯ 0ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1680676316,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2649439,"avatar":"https://static001.geekbang.org/account/avatar/00/28/6d/5f/a937f7f1.jpg","nickname":"ä¹Œæ‹‰å‘†zyb","note":"","ucode":"D324583C9CE2EF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":569333,"discussion_content":"åŒé—®ï¼Œè¯·é—®è€å¸ˆ â€œä¸ºå…¶å¼€å¯ USDT è·Ÿè¸ªç‚¹ï¼ˆç¼–è¯‘é€‰é¡¹ä¸º Â --with-dtraceï¼‰â€å…·ä½“è¯¥æ€ä¹ˆæ“ä½œå•Šï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1651408600,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}