{"id":171285,"title":"45 | 优化使用：增强写，延迟与吞吐量的抉择","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/geek_netty\">https://gitee.com/geektime-geekbang/geek_netty</a></p>","comments":[{"had_liked":false,"id":157200,"user_name":"zpzeng","can_delete":false,"product_type":"c3","uid":1697579,"ip_address":"","ucode":"BC53D95766FE7C","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epOLt1slWbKAtNR9yjAfvrM73hlOQpe2Zzptah7jN3relYAhDudicALnysGfAPL0RjVdzhS7Y2Kbmg/132","comment_is_top":false,"comment_ctime":1575080168,"is_pvip":false,"replies":[{"id":60322,"content":"它是flush增强，所以必须调用flush.它才帮你优化(减少你的flush次数)，如果你仅仅write.它不会帮你flush的，否则就是多做事了，从名字也可以看出是flush增强","user_name":"作者回复","user_name_real":"傅健","uid":1638649,"ctime":1575113589,"ip_address":"","comment_id":157200,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"老师，我打开了FlushConsolidationHandler的异步增强，然后客户端发了一次请求，server端只write，没有writeAndFlush，期望是定时任务把数据flush出去，但是并没有，日志只有write，没有flush。这是怎么回事？","like_count":2,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":476360,"discussion_content":"它是flush增强，所以必须调用flush.它才帮你优化(减少你的flush次数)，如果你仅仅write.它不会帮你flush的，否则就是多做事了，从名字也可以看出是flush增强","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1575113589,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1850248,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erZCyXaP2gbxwFHxvtnyaaF2Pyy5KkSMsk9kh7SJl8icp1CD6wicb6VJibiblGibbpDo6IuHrdST6AnWQg/132","nickname":"Geek_1cc6d1","note":"","ucode":"3E083616DD0742","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375137,"discussion_content":"还是需要调用writeAndFlush方法么？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621494330,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":156967,"user_name":"Lemo","can_delete":false,"product_type":"c3","uid":1110744,"ip_address":"","ucode":"DDE7296A9DA381","user_header":"https://static001.geekbang.org/account/avatar/00/10/f2/d8/a620bb3e.jpg","comment_is_top":false,"comment_ctime":1575004199,"is_pvip":false,"replies":[{"id":61520,"content":"您的问题里的分包和校验是指？","user_name":"作者回复","user_name_real":"stroller","uid":1638649,"ctime":1576206944,"ip_address":"","comment_id":156967,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"老是讲的特别好，希望老师讲讲，分包怎么处理，还有一些校验等","like_count":0,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":476288,"discussion_content":"您的问题里的分包和校验是指？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576206944,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1110744,"avatar":"https://static001.geekbang.org/account/avatar/00/10/f2/d8/a620bb3e.jpg","nickname":"Lemo","note":"","ucode":"DDE7296A9DA381","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":93165,"discussion_content":"808协议中的分包和crc检验","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576911531,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":201584,"user_name":"雷刚","can_delete":false,"product_type":"c3","uid":1655725,"ip_address":"","ucode":"115FE2BE1AAB61","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/pTD8nS0SsORKiaRD3wB0NK9Bpd0wFnPWtYLPfBRBhvZ68iaJErMlM2NNSeEibwQfY7GReILSIYZXfT9o8iaicibcyw3g/132","comment_is_top":false,"comment_ctime":1585807878,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"补充一下：OrderServerProcessHandler 并发调用 FlushConsolidationHandler 为什么是线程安全的。\nNetty 的每个 handler 执行时都是在自己的 executor 中执行，如果不指定的话就是 NioEventLoop。通过 ctx 调用 handler 的方法时，Netty 内部会判断这个线程和这个 handler 对应的内部线程是否是同一个，如果是就直接执行了，如果不是会将其封装成一个任务提交到内部线程上。\n\n1. 编解码 hander ：对应的线程是 NioEventLoop。\n2. 业务 OrderServerProcessHandler：对应 UnorderedThreadPoolEventExecutor，业务线程是多个线程并发执行，会并发调用  ctx.writeAndFlush 方法，也就是并发调用 FlushConsolidationHandler#flush()。\n3. FlushConsolidationHandler：对应 NioEventLoop。\n    业务线程 OrderServerProcessHandler 虽然并发调用 flush，但实际执行时都会封装成一个任务提交到 FlushConsolidationHandler  内部线程上。所以 FlushConsolidationHandler 实际执行都是在 NioEventLoop 线程上，它是线程安全的，不用加锁。但 OrderServerProcessHandler 和 FlushConsolidationHandler 是在不同的线程上执行的，所以有可能执行 flush 时，FlushConsolidationHandler#channelRead 等方法可能还未执行。","like_count":7},{"had_liked":false,"id":388853,"user_name":"李兴加","can_delete":false,"product_type":"c3","uid":1960612,"ip_address":"福建","ucode":"03CC7D4E213CBA","user_header":"https://static001.geekbang.org/account/avatar/00/1d/ea/a4/c29c580d.jpg","comment_is_top":false,"comment_ctime":1711008094,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"在im场景的大批量消息时，对于FlushConsolidationHandler的应用效果如何观测","like_count":0},{"had_liked":false,"id":376272,"user_name":"飞翔","can_delete":false,"product_type":"c3","uid":1068571,"ip_address":"美国","ucode":"65AF6AF292DAD6","user_header":"https://static001.geekbang.org/account/avatar/00/10/4e/1b/f4b786b9.jpg","comment_is_top":false,"comment_ctime":1686635836,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"netty 传输100mb文件 很慢 有没有优化方法","like_count":0},{"had_liked":false,"id":365351,"user_name":"猫不如","can_delete":false,"product_type":"c3","uid":1344892,"ip_address":"上海","ucode":"A2D14F57F9703F","user_header":"https://static001.geekbang.org/account/avatar/00/14/85/7c/dcdccb78.jpg","comment_is_top":false,"comment_ctime":1672377447,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"老师，Server中的LogginHandler也是Sharable的，是不是也可以踢出去共享呢","like_count":0},{"had_liked":false,"id":328555,"user_name":"江东","can_delete":false,"product_type":"c3","uid":1793475,"ip_address":"","ucode":"391A62BC7039B3","user_header":"https://static001.geekbang.org/account/avatar/00/1b/5d/c3/69019d24.jpg","comment_is_top":false,"comment_ctime":1640770116,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"代码中表达的思想很是神妙","like_count":0},{"had_liked":false,"id":326221,"user_name":"Z.K","can_delete":false,"product_type":"c3","uid":2061550,"ip_address":"","ucode":"ABA1FD4A77F877","user_header":"https://static001.geekbang.org/account/avatar/00/1f/74/ee/1182b202.jpg","comment_is_top":false,"comment_ctime":1639444229,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"讲的不错","like_count":0}]}