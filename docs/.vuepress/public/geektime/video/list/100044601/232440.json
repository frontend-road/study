{"id":232440,"title":"53 | ForwardedHeaders：确保服务在负载均衡下正常工作","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/NET-Core\">https://gitee.com/geektime-geekbang/NET-Core</a></p>","comments":[{"had_liked":false,"id":220770,"user_name":"🌚😂🙄懒得勤快🤗🤔🌝","can_delete":false,"product_type":"c3","uid":1291721,"ip_address":"","ucode":"4ADE8C73BEB869","user_header":"https://static001.geekbang.org/account/avatar/00/13/b5/c9/e449329d.jpg","comment_is_top":false,"comment_ctime":1590322655,"is_pvip":false,"replies":[{"id":82221,"content":"一般来讲，应用应该只信任内部反向代理提供的X-Forwarded-For，另外反向代理、负载均衡应该关闭对其它X-Forwarded-For的信任，可以设置信任的代理","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1591006472,"ip_address":"","comment_id":220770,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"关于X-Forwarded-For标头，个人最近遇到的一些问题在此分享一下，X-Forwarded-For这个标头是客户端可以进行篡改的，通常是用于伪造IP，前段时间我自己的网站就是因为这个漏洞导致了原本已经被封锁的一些IP段和地区的用户，可以通过伪造X-Forwarded-For标头，比如192.168.1.1、127.0.0.1这样的IP来欺骗web防火墙，而正好去广告工具adguard就正好提供了可以伪造X-Forwarded-For标头的功能，所以实际情况中，我们还需要通过二次比对X-Forwarded-For标头和另外一个代理服务器转发来的原始IP标头，比如：cloudflare的CF-Connecting-IP这种无法被客户端篡改的头，如果请求是没有被篡改的，那么X-Forwarded-For标头和CF-Connecting-IP一定是相等的，如果项目中有要求一定要检测到真实的客户端IP这个问题需要注意一下！","like_count":2,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":496235,"discussion_content":"一般来讲，应用应该只信任内部反向代理提供的X-Forwarded-For，另外反向代理、负载均衡应该关闭对其它X-Forwarded-For的信任，可以设置信任的代理","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591006472,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1291721,"avatar":"https://static001.geekbang.org/account/avatar/00/13/b5/c9/e449329d.jpg","nickname":"🌚😂🙄懒得勤快🤗🤔🌝","note":"","ucode":"4ADE8C73BEB869","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":286588,"discussion_content":"设置可信代理确实是可以的，但是这样需要做额外的配置，如果CDN节点IP发生变动就一定需要去修改配置，增加了额外的维护成本和测试成本，所以我个人还是觉得直接取CDN的真实的客户端IP标头来获取真实IP比较可行。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1593237613,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":230040,"user_name":"小喵喵","can_delete":false,"product_type":"c3","uid":1062444,"ip_address":"","ucode":"FDBBB2A59DB8B6","user_header":"https://static001.geekbang.org/account/avatar/00/10/36/2c/8bd4be3a.jpg","comment_is_top":false,"comment_ctime":1593246378,"is_pvip":false,"replies":[{"id":86000,"content":"访问流量分析，客户地理位置处理等，例如账户异地登陆识别","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1594222069,"ip_address":"","comment_id":230040,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"为什么需要获取原理的地址或ip？这个是用在什么样子的场景中呢？","like_count":0,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":499745,"discussion_content":"访问流量分析，客户地理位置处理等，例如账户异地登陆识别","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594222069,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1291721,"avatar":"https://static001.geekbang.org/account/avatar/00/13/b5/c9/e449329d.jpg","nickname":"🌚😂🙄懒得勤快🤗🤔🌝","note":"","ucode":"4ADE8C73BEB869","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":287324,"discussion_content":"一般是做客户端的埋点统计或者防火墙清洗等场景","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1593415540,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":271149,"user_name":"Yaphet","can_delete":false,"product_type":"c3","uid":1156307,"ip_address":"","ucode":"6A00C081771315","user_header":"https://static001.geekbang.org/account/avatar/00/11/a4/d3/e27a97c4.jpg","comment_is_top":false,"comment_ctime":1609416614,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"你好老师，我现在遇到这样一个问题，我把grpc服务部署到k8s后，发现pod接收到的请求不均匀，我感觉可能是因为grpc服务是长连接的，请问grpc服务部署k8s后怎么实现负载均衡","like_count":1},{"had_liked":false,"id":251740,"user_name":"顾你心安","can_delete":false,"product_type":"c3","uid":1813098,"ip_address":"","ucode":"D0080EBA52CFBB","user_header":"https://static001.geekbang.org/account/avatar/00/1b/aa/6a/fade4619.jpg","comment_is_top":false,"comment_ctime":1601818764,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"受教了","like_count":0}]}