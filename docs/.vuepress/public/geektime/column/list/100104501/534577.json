{"id":534577,"title":"17ï½œéš¾ç‚¹è§£æï¼šeBPFå¤šå†…æ ¸ç‰ˆæœ¬å…¼å®¹è¯¦è§£","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å€ªæœ‹é£ã€‚</p><p>åœ¨ä¸Šä¸€è®²ä¸­ï¼Œæˆ‘å¸¦ä½ è¯¦ç»†æ¢³ç†äº† eBPF å¼€å‘ç¯å¢ƒçš„é…ç½®æ–¹æ³•ï¼Œç‰¹åˆ«æ˜¯ eBPF ç›¸å…³å¼€å‘è½¯ä»¶åŒ…çš„å®‰è£…å’Œå‡çº§æ–¹æ³•ï¼Œä»¥åŠå†…æ ¸çš„é…ç½®å’Œç¼–è¯‘æ–¹æ³•ã€‚ç†Ÿæ‚‰äº† eBPF çš„å¼€å‘ç¯å¢ƒå’Œå†…æ ¸ç¼–è¯‘ä¹‹åï¼Œåœ¨ç•™è¨€åŒºå’Œå¾®ä¿¡ç¾¤ä¸­æˆ‘è¿˜çœ‹åˆ°å¾ˆå¤šåŒå­¦ä¾ç„¶åœ¨ä½¿ç”¨è¾ƒæ—§ç‰ˆæœ¬çš„å†…æ ¸ã€‚è€Œä¸ºäº†å­¦ä¹  eBPFï¼Œå¾ˆå¤šåŒå­¦å·²ç»é…ç½®äº†ä¸€ä¸ªéå¸¸æ–°çš„å†…æ ¸ç‰ˆæœ¬ä½œä¸ºå¼€å‘ç¯å¢ƒï¼Œä½†å´å‘ç°åœ¨æ–°å†…æ ¸ä¸­å¼€å‘çš„ eBPF ç¨‹åºæœ‰æ—¶å´æ²¡æ³•ç›´æ¥åœ¨æ—§ç‰ˆæœ¬çš„å†…æ ¸ä¸­è¿è¡Œã€‚</p><p>ä»Šå¤©ï¼Œæˆ‘å°±å¸¦ä½ ä¸€èµ·æ¥çœ‹çœ‹å¦‚ä½•è®© eBPF ç¨‹åºå…¼å®¹æ–°æ—§ç‰ˆæœ¬çš„å†…æ ¸ï¼Œä»¥ä¾¿åœ¨æ–°ç‰ˆæœ¬å†…æ ¸ä¸­ä½¿ç”¨è¯¸å¦‚ CO-RE ç­‰æ–°ç‰¹æ€§çš„åŒæ—¶ï¼Œè¿˜å¯ä»¥åœ¨æ—§ç‰ˆæœ¬å†…æ ¸ä¸­æ­£å¸¸è¿è¡Œã€‚</p><h2>ä¸ºä»€ä¹ˆéœ€è¦è€ƒè™‘ eBPF ç¨‹åºçš„å†…æ ¸å…¼å®¹æ€§ï¼Ÿ</h2><p>åœ¨å¼€å§‹æ­£å¼çš„å†…å®¹ä¹‹å‰ï¼Œæˆ‘æƒ³ä½ è‚¯å®šæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯ä»€ä¹ˆæ—¶å€™éœ€è¦è€ƒè™‘æ–°æ—§å†…æ ¸ç‰ˆæœ¬çš„å…¼å®¹æ€§ï¼Œä»¥åŠä¸ºä»€ä¹ˆä¼šå‡ºç°æ–°æ—§å†…æ ¸ç‰ˆæœ¬å…¼å®¹æ€§çš„é—®é¢˜ã€‚</p><p>åœ¨ç†æƒ³æƒ…å†µä¸‹ï¼Œå¼€å‘æµ‹è¯•ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒåº”è¯¥éƒ½æ˜¯ä¸€è‡´çš„ï¼ŒåŒ…æ‹¬ä½¿ç”¨ç›¸åŒçš„å†…æ ¸ç‰ˆæœ¬ã€‚å¦‚æœä½ å·²ç»æ»¡è¶³äº†è¿™ä¸ªæ¡ä»¶ï¼Œé‚£ä¹ˆè‡ªç„¶ä¹Ÿå°±ä¸éœ€è¦è€ƒè™‘å†…æ ¸å…¼å®¹çš„é—®é¢˜ã€‚ä½†æ³¨æ„è¿™åªæ˜¯ç†æƒ³æƒ…å†µï¼Œå®é™…æƒ…å†µä¸‹å†…æ ¸ç‰ˆæœ¬ä¸ä¸€è‡´çš„é—®é¢˜æ˜¯ä¸å¯é¿å…çš„ï¼Œæ¯”å¦‚ï¼š</p><ul>\n<li>ä¸ºäº†è·å–æ›´å¥½çš„ç¨³å®šæ€§å’Œç¤¾åŒºæ”¯æŒï¼Œå†…æ ¸ç‰ˆæœ¬ï¼ˆç”šè‡³æ˜¯ Linux&nbsp;å‘è¡Œç‰ˆç‰ˆæœ¬ï¼‰éœ€è¦æŒç»­è·Ÿéšä¸Šæ¸¸ç¤¾åŒºè¿›è¡Œå‡çº§ï¼›</li>\n<li>ä¸ºäº†é‡‡çº³æ–°æŠ€æœ¯ï¼Œæ–°çš„äº§å“æ¶æ„å¯èƒ½ä¸€å¼€å§‹å°±ä¼šé‡‡çº³è¾ƒæ–°çš„å†…æ ¸ï¼Œè€Œä½¿ç”¨æ—§å†…æ ¸çš„é—ç•™ç³»ç»Ÿè¿˜éœ€è¦å¾ˆé•¿æ—¶é—´çš„è¿­ä»£è¿‡ç¨‹ï¼›</li>\n<li>ä¸ºäº†è·å¾—æ›´å¹¿çš„ç”¨æˆ·ï¼Œå¾ˆå¤šå•†ä¸šæˆ–å¼€æºé¡¹ç›®ä¸ä»…è¦æ”¯æŒæœ€æ–°çš„å†…æ ¸ç‰ˆæœ¬ï¼Œè¿˜éœ€è¦å…¼å®¹å„ç§å„æ ·çš„ç”¨æˆ·ç¯å¢ƒï¼Œè€Œè¿™äº›ç”¨æˆ·æ‰€ä½¿ç”¨çš„å†…æ ¸ç‰ˆæœ¬ä¹Ÿæ˜¯åƒå·®ä¸‡åˆ«çš„ã€‚</li>\n</ul><!-- [[[read_end]]] --><p>é‚£ä¹ˆï¼Œåœ¨æ–°æ—§ç‰ˆæœ¬çš„å†…æ ¸ä¸­è¿è¡Œ eBPF ç¨‹åºæ—¶åˆ°åº•ä¼šç¢°åˆ°å“ªäº›é—®é¢˜å‘¢ï¼Ÿæœ€å…¸å‹çš„æœ‰ä»¥ä¸‹è¿™ä¸‰ä¸ªã€‚</p><p><strong>ç¬¬ä¸€ï¼Œæ–°å†…æ ¸å¼•å…¥çš„ eBPF æ–°ç‰¹æ€§æ— æ³•åœ¨æ—§å†…æ ¸ä¸­è¿è¡Œã€‚</strong>ä¸ç»å¤§éƒ¨åˆ†çš„æŠ€æœ¯äº§å“ç±»ä¼¼ï¼ŒLinux å†…æ ¸æ–°ç‰ˆæœ¬ä¸­å¼€å‘çš„ç‰¹æ€§ç»å¤§éƒ¨åˆ†éƒ½ä¸ä¼šè¿ç§»åˆ°æ—§ç‰ˆæœ¬çš„å†…æ ¸ä¸­ï¼Œå¹¶ä¸”æ–°ç‰¹æ€§çš„é»˜è®¤å¼€å¯é€šå¸¸ä¹Ÿéœ€è¦ä¸€ä¸ªæ¯”è¾ƒé•¿çš„è¿‡ç¨‹ï¼ˆä½ å¯ä»¥åœ¨<a href=\"https://github.com/iovisor/bcc/blob/master/docs/kernel-versions.md\">è¿™é‡Œ</a>æ‰¾åˆ°ä¸åŒå†…æ ¸ç‰ˆæœ¬æ”¯æŒçš„ eBPF ç‰¹æ€§ï¼‰ã€‚</p><p><strong>ç¬¬äºŒï¼Œæ–°å†…æ ¸ä¸­çš„æ•°æ®ç»“æ„ã€å‡½æ•°ç­¾åä»¥åŠè·Ÿè¸ªç‚¹ç­‰æœ‰å¯èƒ½è·Ÿæ—§ç‰ˆæœ¬å†…æ ¸ä¸åŒã€‚</strong>æ¯”å¦‚ï¼Œåœ¨æˆ‘ä»¬è¯¾ç¨‹<a href=\"https://time.geekbang.org/column/article/481090\">ç¬¬03è®²</a>çš„è·Ÿè¸ªæ¡ˆä¾‹ä¸­æåˆ°çš„ <code>openat2()</code> ç³»ç»Ÿè°ƒç”¨æ˜¯åœ¨å†…æ ¸ 5.6 ä¸­æ‰æ–°å¢çš„ï¼Œè€Œæ—§ç‰ˆæœ¬å†…æ ¸éœ€è¦æ¢æˆ <code>openat()</code> ç³»ç»Ÿè°ƒç”¨ã€‚</p><p><strong>ç¬¬ä¸‰ï¼Œå³ä¾¿æ˜¯ç›¸åŒçš„å†…æ ¸ç‰ˆæœ¬ï¼Œä¸åŒçš„ç¼–è¯‘é€‰é¡¹ä¹Ÿå¯èƒ½ä¼šå¯¼è‡´å†…æ ¸æ•°æ®ç»“æ„çš„ä¸åŒã€‚</strong>æ¯”å¦‚ï¼Œ<code>CONFIG_THREAD_INFO_IN_TASK</code> çš„å¼€å…³ä¼šç›´æ¥å½±å“å†…æ ¸ <a href=\"https://elixir.bootlin.com/linux/v5.13/source/include/linux/sched.h#L657\">task_struct</a> æ•°æ®ç»“æ„æ‰€æœ‰æˆå‘˜å˜é‡çš„åç§»åœ°å€ã€‚</p><pre><code class=\"language-c++\">  struct task_struct {\n  #ifdef CONFIG_THREAD_INFO_IN_TASK\n  \t/*\n  \t * For reasons of header soup (see current_thread_info()), this\n  \t * must be the first element of task_struct.\n  \t */\n  \tstruct thread_info\t\tthread_info;\n  #endif\n  \t/* -1 unrunnable, 0 runnable, &gt;0 stopped: */\n  \tvolatile long\t\t\tstate;\n    ...\n  }\n</code></pre><p>ç”±äºè¿™äº›å…¼å®¹æ€§é—®é¢˜éƒ½æ˜¯ç”±å†…æ ¸ç‰ˆæœ¬ä¸åŒè€Œå¯¼è‡´çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾ˆå®¹æ˜“æƒ³åˆ°çš„ä¸€ä¸ªç¬¨æ–¹æ³•å°±æ˜¯ç»™æ‰€æœ‰ä¸å…¼å®¹çš„å†…æ ¸ç‰ˆæœ¬åˆ†åˆ«å¼€å‘ä¸åŒçš„ eBPF ç¨‹åºã€‚ä½†è¿™ç§æ–¹æ³•çš„ç¼ºç‚¹å¤ªæ˜æ˜¾äº†ï¼Œç»´æŠ¤å¤§é‡åŠŸèƒ½é‡å¤çš„ eBPF ç¨‹åºæˆæœ¬å¤ªé«˜ï¼Œæ‰€ä»¥æˆ‘å¹¶ä¸æ¨èä½ ä½¿ç”¨è¿™ç§æ–¹æ³•ã€‚</p><p>é‚£ä¹ˆè¿˜æœ‰å“ªäº›æ›´å¥½çš„æ–¹æ³•å‘¢ï¼Ÿæ¥ä¸‹æ¥ï¼Œæˆ‘å°±å¸¦ä½ ä¸€èµ·æ¥çœ‹çœ‹å¦‚ä½•æ›´å¥½åœ°è§£å†³å†…æ ¸ç‰ˆæœ¬ä¸åŒå¸¦æ¥çš„å…¼å®¹æ€§é—®é¢˜ã€‚</p><h2>BCC æ˜¯å¦‚ä½•å…¼å®¹å¤šå†…æ ¸ç‰ˆæœ¬çš„ï¼Ÿ</h2><p>BCC å’Œ bpftrace ä½œä¸ºä½¿ç”¨æœ€å¹¿æ³›çš„ eBPF é¡¹ç›®ï¼Œè‡ªç„¶ä¹Ÿæœ€å®¹æ˜“ç¢°åˆ°å†…æ ¸å…¼å®¹æ€§çš„é—®é¢˜ã€‚é‚£ä¹ˆï¼Œå®ƒä»¬æ˜¯æ€ä¹ˆè§£å†³è¿™äº›å…¼å®¹æ€§é—®é¢˜çš„å‘¢ï¼Ÿå…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œä¸»è¦å°±æ˜¯ä¸‹é¢ä¸¤ä¸ªæ–¹æ³•ï¼š</p><ul>\n<li>ç¬¬ä¸€ï¼Œåœ¨è¿è¡Œ eBPF ç¨‹åºçš„æ—¶å€™ä½¿ç”¨å½“å‰ç³»ç»Ÿå®‰è£…çš„å†…æ ¸å¤´æ–‡ä»¶è¿›è¡Œå°±åœ°ç¼–è¯‘ï¼Œè¿™æ ·å°±å¯ä»¥ç¡®ä¿ eBPF ç¨‹åºä¸­æ‰€å¼•ç”¨çš„å†…æ ¸æ•°æ®ç»“æ„å’Œå‡½æ•°ç­¾åç­‰ï¼Œè·Ÿè¿è¡Œä¸­çš„å†…æ ¸æ˜¯å®Œå…¨åŒ¹é…çš„ã€‚</li>\n<li>ç¬¬äºŒï¼Œåœ¨ eBPF ç¨‹åºç¼–è¯‘å‰äº‹å…ˆæ¢æµ‹å†…æ ¸æ”¯æŒçš„å‡½æ•°ç­¾åå’Œæ•°æ®ç»“æ„ï¼Œè¿›è€Œä¸º eBPF ç¨‹åºç”Ÿæˆé€‚é…å½“å‰å†…æ ¸çš„ç‰ˆæœ¬ã€‚æ¯”å¦‚ï¼Œåœ¨å—è®¾å¤‡ I/O å»¶è¿Ÿè·Ÿè¸ªç¨‹åº <a href=\"https://github.com/iovisor/bcc/blob/master/tools/biolatency.py#L209\">biolantecy</a> ä¸­ï¼ŒBCC å€ŸåŠ©åº“å‡½æ•° <code>BPF.get_kprobe_functions()</code> æ¥åˆ¤æ–­å†…æ ¸æ˜¯ä¸æ˜¯æ”¯æŒç‰¹å®šçš„æ¢é’ˆå‡½æ•°ï¼Œè¿›è€Œå†æ ¹æ®ç»“æœå»é€‰æ‹©æŒ‚è½½ç‚¹ï¼š</li>\n</ul><pre><code class=\"language-python\">  if BPF.get_kprobe_functions(b'__blk_account_io_start'):\n    b.attach_kprobe(event=\"__blk_account_io_start\", fn_name=\"trace_req_start\")\n  else:\n    b.attach_kprobe(event=\"blk_account_io_start\", fn_name=\"trace_req_start\")\n  \n  if BPF.get_kprobe_functions(b'__blk_account_io_done'):\n      b.attach_kprobe(event=\"__blk_account_io_done\", fn_name=\"trace_req_done\")\n  else:\n      b.attach_kprobe(event=\"blk_account_io_done\", fn_name=\"trace_req_done\")\n</code></pre><p>å½“ç„¶äº†ï¼ŒBCC é‡‡ç”¨çš„è¿™äº›æ–¹æ³•è™½ç„¶è§£å†³äº†å†…æ ¸ç‰ˆæœ¬å…¼å®¹çš„é—®é¢˜ï¼Œä½†åŒæ—¶ä¹Ÿå­˜åœ¨å¾ˆå¤šçš„ç¼ºç‚¹ï¼ŒåŒ…æ‹¬éœ€è¦åœ¨æ‰€æœ‰ç›®æ ‡æœºå™¨å®‰è£…å¼€å‘å·¥å…·å’Œå†…æ ¸å¤´æ–‡ä»¶ã€ç¼–è¯‘æ¶ˆè€—é¢å¤–èµ„æºã€eBPF ç¨‹åºå¯åŠ¨æ…¢ä»¥åŠç¼–è¯‘æ—¶é”™è¯¯éš¾ä»¥æ’æŸ¥ç­‰ã€‚</p><p>é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰æ›´å¥½çš„æ–¹æ³•å‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚Linux å†…æ ¸ç»´æŠ¤è€…æä¾›äº†ä¸€ä¸ªæ›´å¥½çš„æ–¹æ¡ˆï¼Œé‚£å°±æ˜¯ä¸€æ¬¡ç¼–è¯‘åˆ°å¤„æ‰§è¡Œï¼ˆCompile Once Run Everywhereï¼Œç®€ç§° CO-REï¼‰ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ CO-RE æ˜¯å¦‚ä½•è§£å†³è¿™äº›é—®é¢˜çš„ã€‚</p><h2>ä¸€æ¬¡ç¼–è¯‘åˆ°å¤„æ‰§è¡Œï¼ˆCO-REï¼‰</h2><p>eBPF çš„ä¸€æ¬¡ç¼–è¯‘åˆ°å¤„æ‰§è¡Œï¼ˆç®€ç§° CO-REï¼‰é¡¹ç›®å€ŸåŠ©äº† BPF ç±»å‹æ ¼å¼ï¼ˆBPF Type Format, ç®€ç§° BTFï¼‰æä¾›çš„è°ƒè¯•ä¿¡æ¯ï¼Œå†é€šè¿‡ä¸‹é¢çš„å››ä¸ªæ­¥éª¤ï¼Œä½¿å¾— eBPF ç¨‹åºå¯ä»¥é€‚é…ä¸åŒç‰ˆæœ¬çš„å†…æ ¸ï¼š</p><ul>\n<li>ç¬¬ä¸€ï¼Œåœ¨ bpftool å·¥å…·ä¸­æä¾›äº†ä» BTF ç”Ÿæˆå¤´æ–‡ä»¶çš„å·¥å…·ï¼Œä»è€Œæ‘†è„±äº†å¯¹å†…æ ¸å¤´æ–‡ä»¶çš„ä¾èµ–ã€‚</li>\n<li>ç¬¬äºŒï¼Œé€šè¿‡å¯¹ BPF ä»£ç ä¸­çš„è®¿é—®åç§»é‡è¿›è¡Œé‡å†™ï¼Œè§£å†³äº†ä¸åŒå†…æ ¸ç‰ˆæœ¬ä¸­æ•°æ®ç»“æ„åç§»é‡ä¸åŒçš„é—®é¢˜ã€‚</li>\n<li>ç¬¬ä¸‰ï¼Œåœ¨ libbpf ä¸­é¢„å®šä¹‰ä¸åŒå†…æ ¸ç‰ˆæœ¬ä¸­æ•°æ®ç»“æ„çš„ä¿®æ”¹ï¼Œè§£å†³äº†ä¸åŒå†…æ ¸ä¸­æ•°æ®ç»“æ„ä¸å…¼å®¹çš„é—®é¢˜ã€‚</li>\n<li>ç¬¬å››ï¼Œåœ¨ libbpf ä¸­æä¾›ä¸€ç³»åˆ—çš„å†…æ ¸ç‰¹æ€§æ¢æµ‹åº“å‡½æ•°ï¼Œè§£å†³äº† eBPF ç¨‹åºåœ¨ä¸åŒå†…æ ¸å†…ç‰ˆæœ¬ä¸­éœ€è¦æ‰§è¡Œä¸åŒè¡Œä¸ºçš„é—®é¢˜ã€‚æ¯”å¦‚ï¼Œä½ å¯ä»¥ç”¨ <code>bpf_core_type_exists()</code> å’Œ<code>bpf_core_field_exists()</code> åˆ†åˆ«æ£€æŸ¥å†…æ ¸æ•°æ®ç±»å‹å’Œæˆå‘˜å˜é‡æ˜¯å¦å­˜åœ¨ï¼Œä¹Ÿå¯ä»¥ç”¨ç±»ä¼¼ <code>extern int LINUX_KERNEL_VERSION __kconfig</code> çš„æ–¹å¼æŸ¥è¯¢å†…æ ¸çš„é…ç½®é€‰é¡¹ã€‚</li>\n</ul><p>é‡‡ç”¨è¿™äº›æ–¹æ³•ä¹‹åï¼ŒCO-RE å°±ä½¿å¾— eBPF ç¨‹åºå¯ä»¥åœ¨å¼€å‘ç¯å¢ƒç¼–è¯‘å®Œæˆä¹‹åï¼Œåˆ†å‘åˆ°ä¸åŒç‰ˆæœ¬å†…æ ¸çš„æœºå™¨ä¸­è¿è¡Œï¼Œå¹¶ä¸”ä¹Ÿä¸å†éœ€è¦ç›®æ ‡æœºå™¨å®‰è£…å„ç§å¼€å‘å·¥å…·å’Œå†…æ ¸å¤´æ–‡ä»¶ã€‚æ‰€ä»¥ï¼Œ<strong>Linux å†…æ ¸ç¤¾åŒºæ›´æ¨èæ‰€æœ‰å¼€å‘è€…ä½¿ç”¨ CO-RE å’Œ libbpf æ¥æ„å»º eBPF ç¨‹åºã€‚</strong>å®é™…ä¸Šï¼Œå¦‚æœä½ çœ‹è¿‡ BCC çš„æºä»£ç ï¼Œä½ ä¼šå‘ç° BCC å·²ç»æŠŠå¾ˆå¤šå·¥å…·éƒ½<a href=\"https://github.com/iovisor/bcc/tree/master/libbpf-tools\">è¿ç§»</a>åˆ°äº† CO-REã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒCO-RE éœ€è¦æ¯”è¾ƒæ–°çš„å†…æ ¸ç‰ˆæœ¬ï¼ˆå¤§äºç­‰äº5.2ï¼‰å¹¶ä¸”éœ€è¦æ‰“å¼€ <code>CONFIG_DEBUG_INFO_BTF</code> é…ç½®é€‰é¡¹ã€‚æ‰€ä»¥ï¼Œå®é™…ä¸Šé‡‡ç”¨ CO-RE æŠ€æœ¯çš„ eBPF ç¨‹åºè¿˜æ˜¯åªèƒ½è¿è¡Œåœ¨æ»¡è¶³è¿™ä¸¤ä¸ªæ¡ä»¶çš„å†…æ ¸ç‰ˆæœ¬ä¸­ã€‚é‚£ä¹ˆï¼Œä¸æ”¯æŒ BTF çš„å†…æ ¸æ€ä¹ˆåŠå‘¢ï¼Ÿæ ¹æ®å¼€æºç¤¾åŒºçš„å®è·µç»éªŒï¼Œæœ‰ä¸¤ç§ä¸åŒçš„è§£å†³åŠæ³•ã€‚</p><p>ç¬¬ä¸€ç§ï¼Œé‡‡ç”¨æ¡ä»¶ç¼–è¯‘çš„æ–¹å¼ï¼Œæ ¹æ®æ˜¯å¦æ”¯æŒ CO-REï¼Œç”Ÿæˆä¸¤ä¸ªä¸åŒçš„ eBPF å­—èŠ‚ç æ–‡ä»¶ã€‚è€Œåˆ°ç¨‹åºè¿è¡Œæ—¶ï¼Œå†æ ¹æ®å†…æ ¸æ˜¯å¦æ”¯æŒ CO-RE é€‰æ‹©å¯¹åº”çš„å­—èŠ‚ç æ–‡ä»¶åŠ è½½è¿è¡Œã€‚</p><p>ç¬¬äºŒç§ï¼Œé‡‡ç”¨ Aqua Security å¼€æºçš„ <a href=\"https://github.com/aquasecurity/btfhub-archive\">btfhub</a> ï¼Œä¸ºç›®æ ‡æœºå™¨åŒ¹é…çš„å†…æ ¸ç‰ˆæœ¬ä¸‹è½½ç‹¬ç«‹çš„ BTF ä¿¡æ¯åº“ï¼Œæœ€åå†é€šè¿‡å¦‚ä¸‹çš„æ–¹æ³•å€ŸåŠ© libbpf è¿›è¡ŒåŠ è½½ï¼š</p><pre><code class=\"language-c++\">\tstruct bpf_object_open_opts openopts = {\n\t\t.sz = sizeof(struct bpf_object_open_opts),\n         // ä»BPF_CUSTOM_BTFç¯å¢ƒå˜é‡è¯»å–BTFæ–‡ä»¶è·¯å¾„\n\t\t.btf_custom_path = getenv(\"BPF_CUSTOM_BTF\"),\n\t};\n\n\tobj = hello_btf_bpf__open_opts(&amp;openopts);\n\tif (!obj) {\n\t\tfprintf(stderr, \"failed to open and/or load BPF object\\n\");\n\t\treturn 1;\n\t}\n</code></pre><p>é™¤æ­¤ä¹‹å¤–ï¼ŒeBPF ç¨‹åºåœ¨è¿è¡Œæ—¶ä¸€èˆ¬ä¸éœ€è¦å†…æ ¸çš„æ‰€æœ‰ BTF ä¿¡æ¯ï¼Œè€Œåªæ˜¯è®¿é—®å…¶ä¸­çš„å‡ ä¸ªå°‘æ•°ç±»å‹ã€‚å› è€Œï¼Œä»å†…æ ¸ 5.18 å¼€å§‹ï¼Œbpftool è¿˜æ–°å¢äº† <code>bpftool gen min_core_btf</code> å‘½ä»¤ï¼Œå¸®ä½ ç²¾ç®€ BTF ä¿¡æ¯ï¼Œè¿›ä¸€æ­¥å‡è½»äº† eBPF ç¨‹åºï¼ˆåŒ…æ‹¬ BTF ä¿¡æ¯ï¼‰çš„åˆ†å‘äº¤ä»˜ã€‚</p><p>ä»¥æˆ‘ä»¬è¯¾ç¨‹ä¸­çš„ <a href=\"https://github.com/feiskyer/ebpf-apps/blob/main/bpf-apps/execsnoop.bpf.c\">execsnoop</a> æ¡ˆä¾‹ä¸ºä¾‹ï¼Œç²¾ç®€åçš„ BTF åªæœ‰å‡ ç™¾ä¸ªå­—èŠ‚ï¼š</p><pre><code class=\"language-bash\">$ ls -lh /sys/kernel/btf/vmlinux\n-r--r--r-- 1 root root 4.8M Jun 20 19:23 /sys/kernel/btf/vmlinux\n\n$ bpftool gen min_core_btf /sys/kernel/btf/vmlinux execsnoop.btf execsnoop.bpf.o\n$ ls -lh execsnoop.btf\n-rw-r--r-- 1 root root 236 Jun 20 20:15 execsnoop.btf\n</code></pre><h2>å°ç»“</h2><p>ä»Šå¤©ï¼Œæˆ‘å¸¦ä½ ä¸€èµ·æ¢³ç†äº†åœ¨å¼€å‘å’Œè¿è¡Œ eBPF ç¨‹åºè¿‡ç¨‹ä¸­å¯èƒ½ä¼šç¢°åˆ°çš„å†…æ ¸ç‰ˆæœ¬å…¼å®¹æ€§é—®é¢˜ï¼Œå¹¶æ€»ç»“äº†è§£å†³è¿™äº›é—®é¢˜çš„å®è·µç»éªŒã€‚ç”±äºä¸åŒç‰ˆæœ¬å†…æ ¸çš„æ•°æ®ç»“æ„ã€å‡½æ•°ç­¾åã€å†…æ ¸ç‰¹æ€§ä»¥åŠå†…æ ¸é…ç½®ç­‰éƒ½æœ‰å¯èƒ½ä¸åŒï¼Œé’ˆå¯¹ä¸€ä¸ªç‰ˆæœ¬å¼€å‘çš„ eBPF ç¨‹åºæœ‰å¯èƒ½æ²¡æ³•ç›´æ¥è¿è¡Œåœ¨å…¶ä»–ä¸åŒç‰ˆæœ¬çš„å†…æ ¸ä¸Šã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒBCC é‡‡ç”¨äº†è¿è¡Œæ—¶ç¼–è¯‘çš„æ–¹å¼ï¼Œç›´æ¥ä»ç›®æ ‡æœºå™¨çš„å†…æ ¸å¤´æ–‡ä»¶ä¸­è·å–æ•°æ®ç»“æ„ï¼Œä½†åŒæ—¶ä¹Ÿå¯¼è‡´äº†éœ€è¦ä¸ºæ‰€æœ‰ç›®æ ‡æœºå™¨å®‰è£…å¼€å‘å·¥å…·å’Œå†…æ ¸å¤´æ–‡ä»¶ã€ç¼–è¯‘æ¶ˆè€—é¢å¤–èµ„æºã€eBPF ç¨‹åºå¯åŠ¨æ…¢ä»¥åŠç¼–è¯‘æ—¶é”™è¯¯éš¾ä»¥æ’æŸ¥ç­‰é¢å¤–çš„é—®é¢˜ã€‚</p><p>ç›¸æ¯”äº BCCï¼ŒCO-RE æä¾›äº†ä¸€ç§æ›´ä¼˜é›…çš„æ–¹å¼ï¼Œä¸ä»…å€ŸåŠ© BTF è§£è€¦äº†å†…æ ¸å¤´æ–‡ä»¶çš„ä¾èµ–ï¼Œé¿å…äº†è¿è¡Œæ—¶ç¼–è¯‘ï¼Œè¿˜é€šè¿‡ libbpf æä¾›äº†ä¸€ç³»åˆ—çš„è¾…åŠ©å‡½æ•°ï¼Œæ–¹ä¾¿ eBPF ç¨‹åºåŠ¨æ€æ¢æµ‹å†…æ ¸æ‰€æ”¯æŒçš„ç‰¹æ€§ï¼Œè¿›è€Œæœ‰é’ˆå¯¹æ€§åœ°å¤„ç†ã€‚å¯¹äºä¸æ”¯æŒ BTF çš„å†…æ ¸ï¼Œlibbpf è¿˜æ”¯æŒåŠ è½½è‡ªå®šä¹‰çš„ BTF æ–‡ä»¶ï¼Œæ‰€ä»¥å¤šå†…æ ¸ç‰ˆæœ¬çš„åˆ†å‘ä¹Ÿä¸å†æ˜¯ä¸€ä¸ªé—®é¢˜ã€‚å¯¹äºå¼€ç¯‡ä¸­æåˆ°çš„ï¼Œåœ¨æ–°å†…æ ¸ä¸­å¼€å‘çš„ eBPF ç¨‹åºæœ‰æ—¶æ²¡æ³•ç›´æ¥åœ¨æ—§ç‰ˆæœ¬å†…æ ¸ä¸­è¿è¡Œçš„é—®é¢˜ï¼Œé€šè¿‡è¿™ä¸ªæ–¹å¼ä¹Ÿå°±å¯ä»¥è§£å†³äº†ã€‚</p><p>ä»Šå¤©è¿™ä¸€è®²å°±åˆ°è¿™é‡Œäº†ï¼Œä¸‹ä¸€æ¬¡çš„åŠ¨æ€æ›´æ–°é¢„è®¡ä¼šåœ¨8æœˆä»½ã€‚å¦‚æœä½ æœ‰å¯¹æˆ‘ä»¬è¯¾ç¨‹æœªæ¥å†…å®¹çš„å»ºè®®ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºæå‡ºæ¥ï¼ŒæœŸå¾…ä½ ä¸æˆ‘ä¸€èµ·å®Œå–„å’Œæ„å»ºä¸€ä¸ªæœ€è´´è¿‘å®è·µçš„ eBPF çŸ¥è¯†ä½“ç³»ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>æœ€åï¼Œæˆ‘æƒ³è¯·ä½ èŠä¸€èŠè¿™ä¸¤ä¸ªé—®é¢˜ï¼š</p><ol>\n<li>é€šè¿‡å‰é¢ä¸€æ®µæ—¶é—´è¯¾ç¨‹çš„å­¦ä¹ ï¼Œä½ å·²ç»æŠŠ eBPF åº”ç”¨åˆ°äº†å“ªäº›åœºæ™¯ï¼Ÿåˆæœ‰å“ªäº›ç»éªŒå’Œæ”¶è·ï¼Ÿ</li>\n<li>åœ¨åˆ†å‘ eBPF ç¨‹åºçš„è¿‡ç¨‹ä¸­ï¼Œä½ æœ‰æ²¡æœ‰ç¢°åˆ°ä»Šå¤©è®²åˆ°çš„å†…æ ¸ç‰ˆæœ¬å…¼å®¹æ€§çš„é—®é¢˜ï¼Ÿç»“åˆä»Šå¤©çš„å†…å®¹ï¼Œä½ æ˜¯æ€ä¹ˆè§£å†³è¿™äº›é—®é¢˜çš„ï¼Ÿ<br>\næ¬¢è¿åœ¨ç•™è¨€åŒºå’Œæˆ‘è®¨è®ºï¼Œä¹Ÿæ¬¢è¿æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™ä½ çš„åŒäº‹ã€æœ‹å‹ã€‚æˆ‘ä»¬ä¸€èµ·åœ¨å®æˆ˜ä¸­æ¼”ç»ƒï¼Œåœ¨äº¤æµä¸­è¿›æ­¥ã€‚</li>\n</ol>","neighbors":{"left":{"article_title":"16ï½œéš¾ç‚¹è§£æï¼šeBPFå¼€å‘ç¯å¢ƒæ­å»ºåŠå†…æ ¸ç¼–è¯‘è¯¦è§£","id":510472},"right":{"article_title":"18ï½œå¹´åº¦æ€»ç»“ï¼šeBPFçš„2022ä¹‹æ—…","id":621590}},"comments":[{"had_liked":false,"id":363793,"user_name":"janey","can_delete":false,"product_type":"c1","uid":1619748,"ip_address":"æ±Ÿè‹","ucode":"B2160B363F23EB","user_header":"https://static001.geekbang.org/account/avatar/00/18/b7/24/17f6c240.jpg","comment_is_top":false,"comment_ctime":1670199797,"is_pvip":false,"replies":[{"id":134621,"content":"æ˜¯çš„ï¼Œä¸€ä¸ªæ„æ€","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001282,"ctime":1677497914,"ip_address":"ä¸Šæµ·","comment_id":363793,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"è¿™é‡Œçš„ä¸€æ¬¡ç¼–è¯‘ï¼Œè·ŸJITå³æ—¶ç¼–è¯‘æ˜¯ä¸€ä¸ªæ„æ€å—ï¼Ÿå¦‚æœä¸æ˜¯ï¼Œé‚£æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":606929,"discussion_content":"æ˜¯çš„ï¼Œä¸€ä¸ªæ„æ€","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1677497914,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":352388,"user_name":"æœ‰è¯†ä¹‹å£«","can_delete":false,"product_type":"c1","uid":1120024,"ip_address":"","ucode":"23F5594193D200","user_header":"https://static001.geekbang.org/account/avatar/00/11/17/18/e4382a8e.jpg","comment_is_top":false,"comment_ctime":1658634154,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"å¾®ä¿¡ç¾¤åœ¨å“ªé‡Œï¼Ÿ","like_count":3},{"had_liked":false,"id":394832,"user_name":"é´»ğŸ‹","can_delete":false,"product_type":"c1","uid":2384921,"ip_address":"å¹¿ä¸œ","ucode":"6B3327214B50A1","user_header":"https://static001.geekbang.org/account/avatar/00/24/64/19/156e7dee.jpg","comment_is_top":false,"comment_ctime":1728529942,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"â€ç¬¬ä¸€ç§ï¼Œé‡‡ç”¨æ¡ä»¶ç¼–è¯‘çš„æ–¹å¼ï¼Œæ ¹æ®æ˜¯å¦æ”¯æŒ CO-REï¼Œç”Ÿæˆä¸¤ä¸ªä¸åŒçš„ eBPF å­—èŠ‚ç æ–‡ä»¶ã€‚è€Œåˆ°ç¨‹åºè¿è¡Œæ—¶ï¼Œå†æ ¹æ®å†…æ ¸æ˜¯å¦æ”¯æŒ CO-RE é€‰æ‹©å¯¹åº”çš„å­—èŠ‚ç æ–‡ä»¶åŠ è½½è¿è¡Œã€‚â€œ è¿™ä¸ªæ˜¯å¦‚ä½•å®ç°","like_count":0},{"had_liked":false,"id":362690,"user_name":"Geek_5ada4a","can_delete":false,"product_type":"c1","uid":2228781,"ip_address":"å¹¿ä¸œ","ucode":"C1532F4A4AAC9A","user_header":"","comment_is_top":false,"comment_ctime":1668756134,"is_pvip":false,"replies":null,"discussion_count":2,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"ç¬¬äºŒï¼Œé€šè¿‡å¯¹ BPF ä»£ç ä¸­çš„è®¿é—®åç§»é‡è¿›è¡Œé‡å†™ï¼Œè§£å†³äº†ä¸åŒå†…æ ¸ç‰ˆæœ¬ä¸­æ•°æ®ç»“æ„åç§»é‡ä¸åŒçš„é—®é¢˜ã€‚ç¬¬ä¸‰ï¼Œåœ¨ libbpf ä¸­é¢„å®šä¹‰ä¸åŒå†…æ ¸ç‰ˆæœ¬ä¸­æ•°æ®ç»“æ„çš„ä¿®æ”¹ï¼Œè§£å†³äº†ä¸åŒå†…æ ¸ä¸­æ•°æ®ç»“æ„ä¸å…¼å®¹çš„é—®é¢˜ã€‚\n\nè€å¸ˆï¼Œæˆ‘ä¸å¤ªç†è§£ç¬¬äºŒç‚¹å’Œç¬¬ä¸‰ç‚¹çš„åŒºåˆ«ã€‚\nâ€œé¢„å®šä¹‰ä¸åŒå†…æ ¸ç‰ˆæœ¬ä¸­æ•°æ®ç»“æ„çš„ä¿®æ”¹â€ï¼Œå°±æ˜¯ä¸ºäº†å®ç°å¯¹â€œè®¿é—®åç§»é‡è¿›è¡Œé‡å†™â€å§ï¼Ÿè¿™ä¸¤ç‚¹è½åˆ°å®å¤„ï¼Œåº”è¯¥å°±æ˜¯ä¸€ç‚¹ï¼Ÿ\nps vmlinux å·²ç»æä¾›äº†å†…æ ¸æ•°æ®ç»“æ„ï¼Œä¸ºä»€ä¹ˆlibbpfä¸­è¿˜è¦â€œé¢„å®šä¹‰ä¸åŒå†…æ ¸ç‰ˆæœ¬ä¸­æ•°æ®ç»“æ„çš„ä¿®æ”¹â€ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":3778146,"avatar":"https://static001.geekbang.org/account/avatar/00/39/a6/62/399b4351.jpg","nickname":"é‘«é‘«","note":"","ucode":"FBEF696715230B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":639299,"discussion_content":"å› ä¸ºæ•°æ®ç»“æ„ä¸­ä¸€äº›æˆå‘˜åå­—ä¼šå‘ç”Ÿå˜åŒ–ï¼Œæˆ–è€…åˆ é™¤","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1710470173,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"ä¼Šæœ—","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2853665,"avatar":"","nickname":"Geek3039","note":"","ucode":"87CA9890C5FF84","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":596407,"discussion_content":"ä¸æ‡‚ï¼ŒåŒé—®","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1670946303,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":356069,"user_name":"lyonger","can_delete":false,"product_type":"c1","uid":1313840,"ip_address":"å¹¿ä¸œ","ucode":"E89A75DADEA2A1","user_header":"https://static001.geekbang.org/account/avatar/00/14/0c/30/d4737cd5.jpg","comment_is_top":false,"comment_ctime":1661947126,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"æ€»ç»“ä¸‹æ¥ï¼Œå¥½åƒå¯¹äº4.9çš„å†…æ ¸æ”¯æŒï¼Œè¿˜æ˜¯ä¸æ˜¯ç‰¹åˆ«å‹å¥½ï¼Œçº¿ä¸Šè¦ä½¿ç”¨è¿˜æ˜¯å¾ˆéº»çƒ¦ã€‚","like_count":0},{"had_liked":false,"id":355645,"user_name":"James","can_delete":false,"product_type":"c1","uid":1189015,"ip_address":"ä¸­å›½å°æ¹¾","ucode":"24993EB1569282","user_header":"https://static001.geekbang.org/account/avatar/00/12/24/97/be102fb1.jpg","comment_is_top":false,"comment_ctime":1661588668,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"Ubuntu 20.04ï¼Œå†…æ ¸5.4.0ï¼Œä½†æ˜¯CONFIG_DEBUG_INFO_BTFæ²¡æ‰“å¼€ï¼Œæ€ä¹ˆæ‰“å¼€å‘¢ï¼Ÿ","like_count":0},{"had_liked":false,"id":352687,"user_name":"åä¸ƒ","can_delete":false,"product_type":"c1","uid":2298813,"ip_address":"","ucode":"B2341AF0E7AD47","user_header":"https://static001.geekbang.org/account/avatar/00/23/13/bd/3e86e791.jpg","comment_is_top":false,"comment_ctime":1658882215,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"å…¼å®¹æ€§è®©äººå¤´ç–¼","like_count":0}]}