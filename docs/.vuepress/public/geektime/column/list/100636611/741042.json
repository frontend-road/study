{"id":741042,"title":"第 17 章 配置FTP服务","content":"\n<p>FTP是File Transfer Protocol（文件传输协议，简称“文传协议”）的英文简写形式，用于在因特网上控制文件的双向传输。它同时也是一个应用程序，用户可以通过它把自己的PC机与世界各地所有运行FTP协议的服务器相连，以访问这些服务器上的大量程序和信息。FTP的主要作用就是让用户连接一个远程计算机（这些计算机上运行着FTP服务器程序），并查看远程计算机中的文件，然后把文件从远程计算机复制到本地计算机，或把本地计算机的文件传送到远程计算机。FTP方便传输数据，所以个人用户很多，但在企业里用得越来越少，因为FTP有一定的安全隐患。在本章，阿铭将会介绍两种FTP软件。</p>\n<h2 id=\"nav_point_345\">17.1 使用<code>vsftpd</code>搭建FTP服务</h2>\n<p>CentOS或者Red Hat Linux上有自带的FTP软件vsftpd，默认并没有安装，需要用<code>yum</code>安装，安装后不用配置，启动后便可以使用，但本节介绍的是它的高级用法。</p>\n<h3 id=\"nav_point_346\">17.1.1 安装<code>vsftpd</code></h3>\n<p>使用yum工具安装<code>vsftpd</code>包，如下所示：</p>\n<pre class=\"code-rows\"><code># yum install -y vsftpd</code></pre>\n<h3 id=\"nav_point_347\">17.1.2 建立账号</h3>\n<p><code>vsftpd</code>默认支持使用系统账号体系登录，但那样不太安全，所以阿铭建议你使用虚拟账号体系登录。</p>\n<p>首先建立与虚拟账号相关联的系统账号，如下所示：</p>\n<pre class=\"code-rows\"><code># useradd virftp -s /sbin/nologin</code></pre>\n<p>接着建立与虚拟账户相关的文件，如下所示：</p>\n<pre class=\"code-rows\"><code># vim /etc/vsftpd/vsftpd_login // 内容如下\ntest1\n123456\ntest2\nabcdef</code></pre>\n<p>需要说明的是，该文件的奇数行为用户名，偶数行为其上一行的用户密码。</p><!-- [[[read_end]]] -->\n<p>然后更改该文件的权限，提升安全级别，如下所示：</p>\n<pre class=\"code-rows\"><code># chmod 600 /etc/vsftpd/vsftpd_login</code></pre>\n<p>vsfptd使用的密码文件不是明文的，需要生成对应的库文件，如下所示：</p>\n<pre class=\"code-rows\"><code># db_load -T -t hash -f /etc/vsftpd/vsftpd_login /etc/vsftpd/vsftpd_login.db</code></pre>\n<p>最后建立与虚拟账号相关的目录以及配置文件，如下所示：</p>\n<pre class=\"code-rows\"><code># mkdir /etc/vsftpd/vsftpd_user_conf\n# cd /etc/vsftpd/vsftpd_user_conf</code></pre>\n<h3 id=\"nav_point_348\">17.1.3 创建和用户对应的配置文件</h3>\n<p>用户的配置文件是单独存在的，每一个用户都有一个自己的配置文件，文件名和用户名一致，如下所示：</p>\n<pre class=\"code-rows\"><code># vim test1 // 内容如下\nlocal_root=/home/virftp/test1\nanonymous_enable=NO\nwrite_enable=YES\nlocal_umask=022\nanon_upload_enable=NO\nanon_mkdir_write_enable=NO\nidle_session_timeout=600\ndata_connection_timeout=120\nmax_clients=10\nmax_per_ip=5\nlocal_max_rate=50000</code></pre>\n<p>其中，<code>local root</code>为test1账号的家目录，<code>anonymous enable</code>用来限制是否允许匿名账号登录（若为<code>NO</code>，表示不允许匿名账号登录），<code>write enable=YES</code>表示可写，<code>local umask</code>指定<code>umask</code>值，<code>anon upload enable</code>表示是否允许匿名账号上传文件，<code>anon mkdir write enable</code>表示是否允许匿名账号可写。以上为关键配置参数，其他参数暂时不用关心。</p>\n<p>创建test2账号的步骤和test1一样，如下所示：</p>\n<pre class=\"code-rows\"><code># mkdir /home/virftp/test1\n# touch /home/virftp/test1/aminglinux.txt\n# chown -R virftp:virftp /home/virftp\n# vim /etc/pam.d/vsftpd // 在该文件最上面添加两行\nauth sufficient /lib64/security/pam_userdb.so db=/etc/vsftpd/vsftpd_login\naccount sufficient /lib64/security/pam_userdb.so db=/etc/vsftpd/vsftpd_login</code></pre>\n<h3 id=\"nav_point_349\">17.1.4 修改全局配置文件/etc/vsftpd/vsftpd.conf</h3>\n<p>修改用户的配置文件后vsftpd还不可用，还需要修改它的一些全局配置文件。</p>\n<p>首先编辑vsftpd.conf文件，如下所示：</p>\n<pre class=\"code-rows\"><code># vim /etc/vsftpd/vsftpd.conf</code></pre>\n<p>修改如下内容：</p>\n<ul>\n<li>将<code>#anon_upload_enable=YES</code>改为<code>anon_upload_enable=NO</code>；</li>\n<li>将<code>#anon_mkdir_write_enable=YES</code>改为<code>anon_mkdir_write_enable=NO</code>。</li>\n</ul>\n<p>再增加如下内容：</p>\n<pre class=\"code-rows\"><code>chroot_local_user=YES\nguest_enable=YES\nguest_username=virftp\nvirtual_use_local_privs=YES\nuser_config_dir=/etc/vsftpd/vsftpd_user_conf\nallow_writeable_chroot=YES</code></pre>\n<p>然后启动<code>vsftpd</code>服务，执行如下命令：</p>\n<pre class=\"code-rows\"><code># systemctl start vsftpd</code></pre>\n<p>整个配置过程的步骤虽然有点烦琐，但是并不复杂。下面我们来做一下测试：</p>\n<pre class=\"code-rows\"><code># ps aux |grep vsftp // 查看进程是否存在\nroot 71785 0.0 0.0 26984 408 ? Ss 22:31 0:00 /usr/sbin/vsftpd /etc/vsftpd/vsftpd.conf\n# yum install lftp // 安装lftp客户端软件\n# lftp test1@127.0.0.1\n口令:\nlftp test1@127.0.0.1:~&gt; ls\n-rw-r--r-- 1 1002 1002 0 Jul 01 14:27 aminglinux.txt</code></pre>\n<p>test1用户密码为123456，成功登录<code>vsftpd</code>后，使用<code>ls</code>列出test1用户家目录下面的aming.txt，其中<code>1002</code>为<code>virftp</code>用户的<code>uid</code>和<code>gid</code>。在这一步，很多同学会遇到问题，遇到问题后请检查/var/log/secure日志，此日志通常会记录一些错误信息。</p>\n<h2 id=\"nav_point_350\">17.2 安装配置pure-ftpd</h2>\n<p>pure-ftpd为另外一款比较小巧实用的FTP软件，阿铭平时用得比较多。</p>\n<h3 id=\"nav_point_351\">17.2.1 安装pure-ftpd</h3>\n<p>默认的CentOS <code>yum</code>源并不包含pure-ftpd，因此需要安装<code>epel</code>扩展源，具体过程如下：</p>\n<pre class=\"code-rows\"><code># yum instll –y epel-release\n# yum install -y pure-ftpd</code></pre>\n<h3 id=\"nav_point_352\">17.2.2 配置pure-ftpd</h3>\n<p>在启动pure-ftpd之前，需要先修改配置文件 /etc/pure-ftpd/pure-ftpd.conf。请查看该配置文件，里面的内容很多。找到<code>PureDB</code>那一行，将其修改为<code>PureDB /etc/pure-ftpd/pureftpd.pdb</code>，然后启动pure-ftpd，启动之前需要先关闭vsftpd，因为有端口冲突，过程如下所示：</p>\n<pre class=\"code-rows\"><code># systemctl stop vsftpd\n# systemctl start pure-ftpd\n# ps aux |grep pure-ftp\nr oot 72453 0.0 0.0 78916 864 ? Ss 23:05 0:00 /usr/sbin/pure-ftpd /etc/pure-ftpd/pure-ftpd.conf</code></pre>\n<p>启动成功的话，<code>ps aux</code>可以看到相关的进程，如果没有正常启动，需通过/var/log/messages日志查看原因。</p>\n<h3 id=\"nav_point_353\">17.2.3 建立账号</h3>\n<p>为了安全，pure-ftpd使用的账号并非Linux的系统账号，而是虚拟账号。首先创建一个账号，如下所示：</p>\n<pre class=\"code-rows\"><code># mkdir /data/ftp/\n# useradd -u 1010 pure-ftp\n# chown -R pure-ftp:pure-ftp /data/ftp\n# pure-pw useradd ftp_user1 -u pure-ftp -d /data/ftp/\nPassword:\nEnter it again:</code></pre>\n<p>其中，<code>-u</code>选项将虚拟用户<code>ftp_user1</code>与系统用户<code>pure-ftp</code>关联在一起，也就是说，使用<code>ftp_user1</code>账号登录FTP后，会以<code>pure-ftp</code>的身份来读取和下载文件，<code>-d</code>选项后面的目录为<code>ftp_user1</code>用户的家目录，这样可以使<code>ftp_user1</code>只能访问其家目录<code>/data/ftp/</code>。</p>\n<p>然后创建用户信息数据库文件，这一步最关键。执行如下命令：</p>\n<pre class=\"code-rows\"><code># pure-pw mkdb</code></pre>\n<p>其中，<code>pure-pw</code>还可以列出当前的FTP账号以及删除某个账号。例如，我们再创建一个账号，如下所示：</p>\n<pre class=\"code-rows\"><code># pure-pw useradd ftp_user2 -u pure-ftp -d /tmp\n# pure-pw mkdb</code></pre>\n<p>列出当前账号，执行如下命令：</p>\n<pre class=\"code-rows\"><code># pure-pw list\nftp_user1 /data/ftp/./\nftp_user2 /tmp/./</code></pre>\n<p>如果想删除账号，执行如下命令：</p>\n<pre class=\"code-rows\"><code># pure-pw userdel ftp_user2</code></pre>\n<h3 id=\"nav_point_354\">17.2.4 测试pure-ftpd</h3>\n<p>测试过程如下：</p>\n<pre class=\"code-rows\"><code># lftp ftp_user1@127.0.0.1\n口令:\nlftp ftp_user1@127.0.0.1:~&gt; ls\ndrwxr-xr-x 2 1010 pure-ftp 6 Jul 1 23:05 .\ndrwxr-xr-x 2 1010 pure-ftp 6 Jul 1 23:05 ..\nlftp ftp_user1@127.0.0.1:/&gt; put /etc/passwd\n1419 bytes transferred\nlftp ftp_user1@127.0.0.1:/&gt; ls\ndrwxr-xr-x 2 1010 pure-ftp 20 Jul 1 23:07 .\ndrwxr-xr-x 2 1010 pure-ftp 20 Jul 1 23:07 ..\n-rw-r--r-- 1 1010 pure-ftp 1419 Jul 1 23:05 passwd</code></pre>\n<p>登录后，使用<code>ls</code>命令可以查看当前目录都有什么文件，使用<code>put</code>命令可以把系统的文件上传到FTP服务器上。你还可以在Windows机器里安装一个FTP客户端软件（阿铭推荐开源的FileZilla），然后远程连接测试。</p>\n<h2 id=\"nav_point_355\">17.3 课后习题</h2>\n<p>(1) FTP服务默认监听哪个端口？我们是否可以更改它？</p>\n<p>(2) 搭建FTP服务的常用软件有哪些？系统自带的是哪一种？</p>\n<p>(3) 如何使用pure-ftpd软件创建一个用户？如何删除一个用户？</p>\n<p>(4) 如何使用pure-ftpd软件更改用户的密码？</p>\n<p>(5) 如何使用pure-ftpd软件查看当前有几个用户？</p>\n<p>(6) 使用vsftpd软件搭建一个FTP服务器。要求：创建三个用户user1、user2和user3，这3个用户都可以访问同一个目录，但是user1可读/写，而user2和user3只读。</p>\n<p>(7) 使用vsftpd软件搭建一个FTP服务器。要求：创建三个用户，user1、user2和user3，这三个用户都可以访问同一个目录，每个用户都可以读取其他用户的文件，但只能更改自己的文件，不能更改其他用户的文件。</p>\n<p>(8) 使用vsftpd软件搭建一个FTP服务器。要求：任何人都可以登录（匿名登录），并且匿名用户可以读/写。</p>\n\n<br style=\"page-break-after:always\" />","comments":[{"had_liked":false,"id":387061,"user_name":"learn more","can_delete":false,"product_type":"c1","uid":1128702,"ip_address":"湖南","ucode":"0EF628B2E0F95E","user_header":"https://static001.geekbang.org/account/avatar/00/11/38/fe/04f56d1e.jpg","comment_is_top":false,"comment_ctime":1706338933,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100636611,"comment_content":"yum instll –y epel-release  应该改为 yum install –y epel-release","like_count":1}]}