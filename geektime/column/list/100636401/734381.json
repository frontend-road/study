{"id":734381,"title":"04ï½œå„å¸å…¶èŒçš„Serverï¼šæ‹†åˆ†å“åº”æ¨¡å—ä¸å¤„ç†æ¨¡å—","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯éƒ­å±¹ã€‚ä»Šå¤©æˆ‘ä»¬ç»§ç»­æ‰‹å†™MiniTomcatã€‚</p><p>åœ¨ä¸Šä¸€èŠ‚è¯¾ï¼Œæˆ‘ä»¬åŸºäºæœ€æ—©çš„æœ€å°å¯ç”¨HttpServeræœåŠ¡å™¨è¿›è¡Œäº†æ”¹é€ ã€‚ä¸»è¦åŒ…æ‹¬å¯¹HTTPåè®®è¿”å›å†…å®¹ä¸­çš„çŠ¶æ€è¡Œä¸è¿”å›å¤´è¿›è¡Œå°è£…ï¼Œä»¥åŠå¼•å…¥åŠ¨æ€èµ„æºå’ŒServletçš„æ¦‚å¿µï¼Œå¯¹Webç«¯è¿”å›å†…å®¹è¿›è¡Œäº†æ‰©å……ï¼Œå·²ç»æœ‰ç‚¹Servletå®¹å™¨çš„é›å½¢äº†ã€‚</p><p>ä½†æˆ‘ä¹Ÿæåˆ°ï¼Œå½“å‰æˆ‘ä»¬è‡ªå®šä¹‰çš„Servletæ¥å£æ˜¯ä¸æ»¡è¶³Java Servletè§„èŒƒçš„ã€‚å› æ­¤è¿™èŠ‚è¯¾æˆ‘ä»¬é¦–å…ˆä¼šè®¨è®ºå¦‚ä½•ç¬¦åˆServletè§„èŒƒï¼Œåœ¨Javaçš„è§„åˆ™ä¸‹å®ç°MiniTomcatã€‚</p><p>å…¶æ¬¡ï¼Œåœ¨å½“å‰çš„HttpServerä¸­ï¼ŒHttpServerç±»æ‰¿æ‹…äº†æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚ã€è°ƒç”¨Servletã€å“åº”å®¢æˆ·ç«¯ç­‰å¤šç§åŠŸèƒ½ï¼ŒåŠŸèƒ½å¤ªå¤šäº†ï¼Œå› æ­¤æˆ‘ä»¬è¦å°†å…¶è¿›è¡ŒåŠŸèƒ½æ‹†åˆ†ï¼Œä½¿å„ä¸ªéƒ¨åˆ†å„å¸å…¶èŒã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/54/a2/54c07fb03981dca6c02f61a9279b4aa2.png?wh=2144x874\" alt=\"\"></p><p>å¥½ï¼Œå°±è®©æˆ‘ä»¬ä¸€èµ·æ¥åŠ¨æ‰‹å®ç°ã€‚</p><h2>é¡¹ç›®ç»“æ„</h2><p>è¿™èŠ‚è¯¾æˆ‘ä»¬è®¡åˆ’é‡‡ç”¨Mavenç»“æ„å¯¹é¡¹ç›®çš„åŒ…ä¾èµ–è¿›è¡Œç®¡ç†ï¼Œçœå»äº†å¯¼å…¥jaråŒ…çš„ç¯èŠ‚ã€‚ä½†æœ‰ä¸€ç‚¹æˆ‘ä»¬å§‹ç»ˆåšæŒï¼Œå°±æ˜¯å¼•å…¥æœ€å°‘çš„ä¾èµ–åŒ…ï¼Œä¸€åˆ‡åŠŸèƒ½å°½å¯èƒ½ç”¨æœ€åŸç”Ÿçš„JDKæ¥å®ç°ï¼Œä»¥ä¾¿äºæˆ‘ä»¬ä»å¤´åšèµ·æ›´æ·±åœ°ç†è§£åŸç†ã€‚åœ¨è¿™èŠ‚è¯¾ä¸­ï¼Œé¡¹ç›®ç»“æ„å˜åŒ–å¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">MiniTomcat\nâ”œâ”€ src\nâ”‚  â”œâ”€ main\nâ”‚  â”‚  â”œâ”€ java\nâ”‚  â”‚  â”‚  â”œâ”€ server\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpConnector.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpProcessor.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpServer.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ Request.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ Response.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ ServletProcessor.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ StatisResourceProcessor.java\nâ”‚  â”‚  â”œâ”€ resources\nâ”‚  â”œâ”€ test\nâ”‚  â”‚  â”œâ”€ java\nâ”‚  â”‚  â”‚  â”œâ”€ test\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ HelloServlet.java\nâ”‚  â”‚  â”œâ”€ resources\nâ”œâ”€ webroot\nâ”‚  â”œâ”€ test\nâ”‚  â”‚  â”œâ”€ HelloServlet.class\nâ”‚  â”œâ”€ hello.txt\nâ”œâ”€ pom.xml\n</code></pre><!-- [[[read_end]]] --><p>å¯¹æ¯”ä¸ŠèŠ‚è¯¾çš„ç›®å½•ï¼Œä½ ä¼šå‘ç°æ–°å¢äº†HttpConnector.javaå’ŒHttpProcessor.javaï¼Œè¿™æ­£æ˜¯ç”¨æ¥æ‹†åˆ†HttpServerä¸¤ä¸ªç±»çš„ï¼Œè€Œæˆ‘ä»¬è‡ªå®šä¹‰çš„Servletå°±æ¶ˆå¤±ä¸è§äº†ã€‚æ ¹æ®Servletè§„èŒƒï¼Œå–è€Œä»£ä¹‹çš„åº”è¯¥æ˜¯javax.servlet.Servletç±»ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦æŠŠjavax.servlet.Servletå¼•å…¥åˆ°ä»£ç ä¹‹ä¸­ï¼Œå‚è€ƒä»¥ä¸‹pom.xmlï¼š</p><pre><code class=\"language-xml\">&lt;project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\"&gt;\n    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;\n    &lt;groupId&gt;day3&lt;/groupId&gt;\n    &lt;artifactId&gt;day3&lt;/artifactId&gt;\n    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;\n    &lt;dependencies&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;javax.servlet&lt;/groupId&gt;\n            &lt;artifactId&gt;javax.servlet-api&lt;/artifactId&gt;\n            &lt;version&gt;4.0.1&lt;/version&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;\n            &lt;artifactId&gt;commons-lang3&lt;/artifactId&gt;\n            &lt;version&gt;3.4&lt;/version&gt;\n        &lt;/dependency&gt;\n    &lt;/dependencies&gt;\n&lt;/project&gt;  \n</code></pre><h2>é€‚é…Servletè§„èŒƒ</h2><p>æ‰€è°“ç¬¦åˆè§„èŒƒï¼Œå¯¹ç¼–å†™ç¨‹åºæ¥è®²ï¼Œå°±æ˜¯éµå®ˆæµç¨‹è°ƒç”¨æ—¶åºå’Œä½¿ç”¨è§„å®šçš„APIæ¥å£åŠæ•°æ®æ ¼å¼ã€‚å¯¹Servletè§„èŒƒæ¥è®²ï¼Œ<strong>ç¬¬ä¸€ä¸ªè¦éµå®ˆçš„å°±æ˜¯å¿…é¡»å®ç° Servlet æ¥å£ã€‚</strong></p><p>åœ¨å¼•å…¥ä¸Šæ–‡çš„servlet-apiä¾èµ–åï¼Œæˆ‘ä»¬å¯ä»¥æŠŠåŸæ¥è‡ªå·±å®šä¹‰çš„Servletæ¥å£åˆ é™¤ï¼Œç”¨javax.servlet.Servletæ›¿æ¢ã€‚æˆ‘ä»¬å…ˆçœ‹çœ‹javax.servlet.Servletçš„æ¥å£å®šä¹‰ã€‚</p><pre><code class=\"language-java\">package javax.servlet;\nimport java.io.IOException;\npublic interface Servlet {\n    void init(ServletConfig var1) throws ServletException;\n    ServletConfig getServletConfig();\n    void service(ServletRequest var1, ServletResponse var2) throws ServletException, IOException;\n    String getServletInfo();\n    void destroy();\n}\n</code></pre><p>åœ¨å·¥ç¨‹ä¸­æ›¿æ¢åï¼ŒåŸå…ˆçš„ä»£ç ä¼šç«‹å³æŠ¥é”™ï¼Œå› ä¸ºserviceæ–¹æ³•ä¼ å…¥çš„å‚æ•°æ˜¯ServletRequestå’ŒServletResponseï¼Œè€Œæˆ‘ä»¬ç›®å‰ä½¿ç”¨çš„æ˜¯è‡ªå®šä¹‰çš„Requestç±»å’ŒResponseç±»ã€‚</p><p>å› æ­¤ï¼Œæ¥ä¸‹æ¥åˆ†åˆ«è®©Requestå’ŒResponseå®ç°ServletRequestä¸ServletResponseï¼Œå®ç°å¦‚ä¸‹ï¼š</p><pre><code class=\"language-java\">public class Request implements ServletRequest{\n    private InputStream input;\n    private String uri;\n    //ä»¥è¾“å…¥æµä½œä¸ºRequestçš„æ¥æ”¶å‚æ•°\n    public Request(InputStream input) {\n        this.input = input;\n    }\n    //ç®€å•çš„parserï¼Œå‡å®šä»è¾“å…¥æµä¸­ä¸€æ¬¡æ€§è·å–å…¨éƒ¨å­—èŠ‚ï¼Œå­˜æ”¾åˆ°2Kç¼“å­˜ä¸­\n    public void parse() {\n        StringBuffer request = new StringBuffer(2048);\n        int i;\n        byte[] buffer = new byte[2048];\n        try {\n            i = input.read(buffer);\n        }\n        catch (IOException e) {\n            e.printStackTrace();\n            i = -1;\n        }\n        for (int j=0; j&lt;i; j++) {\n            request.append((char) buffer[j]);\n        }\n        //ä»è¾“å…¥çš„å­—ç¬¦ä¸²ä¸­è§£æURI\n        uri = parseUri(request.toString());\n    }\n    //æ ¹æ®åè®®æ ¼å¼ï¼Œä»¥ç©ºæ ¼ä¸ºç•Œï¼Œæˆªå–ä¸­é—´çš„ä¸€æ®µï¼Œå³ä¸ºURI\n    private String parseUri(String requestString) {\n        int index1, index2;\n        index1 = requestString.indexOf(' ');\n        if (index1 != -1) {\n            index2 = requestString.indexOf(' ', index1 + 1);\n            if (index2 &gt; index1)\n                return requestString.substring(index1 + 1, index2);\n        }\n        return null;\n    }\n    public String getUri() {\n        return uri;\n    }\n    @Override\n    public AsyncContext getAsyncContext() {\n        return null;\n    }\n    @Override\n    public Object getAttribute(String arg0) {\n        return null;\n    }\n    @Override\n    public Enumeration&lt;String&gt; getAttributeNames() {\n        return null;\n    }\n    @Override\n    public String getCharacterEncoding() {\n        return null;\n    }\n    @Override\n    public int getContentLength() {\n        return 0;\n    }\n    @Override\n    public long getContentLengthLong() {\n        return 0;\n    }\n    @Override\n    public String getContentType() {\n        return null;\n    }\n    @Override\n    public DispatcherType getDispatcherType() {\n        return null;\n    }\n    @Override\n    public ServletInputStream getInputStream() throws IOException {\n        return null;\n    }\n    @Override\n    public String getLocalAddr() {\n        return null;\n    }\n    @Override\n    public String getLocalName() {\n        return null;\n    }\n    @Override\n    public int getLocalPort() {\n        return 0;\n    }\n    @Override\n    public Locale getLocale() {\n        return null;\n    }\n    @Override\n    public Enumeration&lt;Locale&gt; getLocales() {\n        return null;\n    }\n    @Override\n    public String getParameter(String arg0) {\n        return null;\n    }\n    @Override\n    public Map&lt;String, String[]&gt; getParameterMap() {\n        return null;\n    }\n    @Override\n    public Enumeration&lt;String&gt; getParameterNames() {\n        return null;\n    }\n    @Override\n    public String[] getParameterValues(String arg0) {\n        return null;\n    }\n    @Override\n    public String getProtocol() {\n        return null;\n    }\n    @Override\n    public BufferedReader getReader() throws IOException {\n        return null;\n    }\n    @Override\n    public String getRealPath(String arg0) {\n        return null;\n    }\n    @Override\n    public String getRemoteAddr() {\n        return null;\n    }\n    @Override\n    public String getRemoteHost() {\n        return null;\n    }\n    @Override\n    public int getRemotePort() {\n        return 0;\n    }\n    @Override\n    public RequestDispatcher getRequestDispatcher(String arg0) {\n        return null;\n    }\n    @Override\n    public String getScheme() {\n        return null;\n    }\n    @Override\n    public String getServerName() {\n        return null;\n    }\n    @Override\n    public int getServerPort() {\n        return 0;\n    }\n    @Override\n    public ServletContext getServletContext() {\n        return null;\n    }\n    @Override\n    public boolean isAsyncStarted() {\n        return false;\n    }\n    @Override\n    public boolean isAsyncSupported() {\n        return false;\n    }\n    @Override\n    public boolean isSecure() {\n        return false;\n    }\n    @Override\n    public void removeAttribute(String arg0) {\n    }\n    @Override\n    public void setAttribute(String arg0, Object arg1) {\n    }\n    @Override\n    public void setCharacterEncoding(String arg0) throws UnsupportedEncodingException {\n    }\n    @Override\n    public AsyncContext startAsync() throws IllegalStateException {\n        return null;\n    }\n    @Override\n    public AsyncContext startAsync(ServletRequest arg0, ServletResponse arg1) throws IllegalStateException {\n        return null;\n    }\n}\n</code></pre><p>ä»ä»£ç ä¸­å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬åªæ˜¯ç®€å•åœ°å®ç°äº†å¯¹URIçš„è§£æï¼Œåˆ«çš„æ–¹æ³•éƒ½æ˜¯ç•™ç©ºçš„ã€‚Javaçš„APIè€ƒè™‘å¾—å¾ˆå…¨é¢ï¼Œåœ¨Requesté‡Œé¢æ–°å¢äº†è®¸å¤šæ¥å£å®ç°æ–¹æ³•ï¼Œä½†æ˜¯å°±åŸºæœ¬åŠŸèƒ½æ¥è®²ï¼Œåªè¦å¾ˆå°‘çš„æ–¹æ³•å°±å¯ä»¥äº†ï¼Œæˆ‘ä»¬æš‚ä¸”å…ˆæŠŠè¿™äº›ç°åœ¨ä¸ç”¨çš„æ–¹æ³•æ”¾åœ¨ä¸€è¾¹ä¸å®ç°ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹Responseç±»çš„æ”¹é€ ã€‚</p><pre><code class=\"language-java\">package server;\nimport javax.servlet.ServletOutputStream;\nimport javax.servlet.ServletResponse;\nimport java.io.IOException;\nimport java.io.OutputStream;\nimport java.io.OutputStreamWriter;\nimport java.io.PrintWriter;\nimport java.util.Locale;\npublic class Response implements ServletResponse{\n    Request request;\n    OutputStream output;\n    PrintWriter writer;\n    String contentType = null;\n    long contentLength = -1;\n    String charset = null;\n    String characterEncoding = null;\n\n    //ä»¥è¾“å‡ºæµä½œä¸ºæ¥æ”¶å‚æ•°\n    public Response(OutputStream output) {\n        this.output = output;\n    }\n    public void setRequest(Request request) {\n        this.request = request;\n    }\n    public OutputStream getOutput() {\n        return this.output;\n    }\n    @Override\n    public void flushBuffer() throws IOException {\n    }\n    @Override\n    public int getBufferSize() {\n        return 0;\n    }\n    @Override\n    public String getCharacterEncoding() {\n        return this.characterEncoding;\n    }\n    @Override\n    public String getContentType() {\n        return null;\n    }\n    @Override\n    public Locale getLocale() {\n        return null;\n    }\n    @Override\n    public ServletOutputStream getOutputStream() throws IOException {\n        return null;\n    }\n    @Override\n    public PrintWriter getWriter() throws IOException {\n        writer = new PrintWriter(new OutputStreamWriter(output,getCharacterEncoding()), true);\n        return writer;\n    }\n    @Override\n    public boolean isCommitted() {\n        return false;\n    }\n    @Override\n    public void reset() {\n    }\n    @Override\n    public void resetBuffer() {\n    }\n    @Override\n    public void setBufferSize(int arg0) {\n    }\n    @Override\n    public void setCharacterEncoding(String arg0) {\n        this.characterEncoding = arg0;\n    }\n    @Override\n    public void setContentLength(int arg0) {\n    }\n    @Override\n    public void setContentLengthLong(long arg0) {\n    }\n    @Override\n    public void setContentType(String arg0) {\n    }\n    @Override\n    public void setLocale(Locale arg0) {\n    }\n}\n\n</code></pre><p>åŒæ ·çš„ï¼Œè¿™ä¸ªAPIä¹Ÿæä¾›äº†ä¸€å¤§å †æ–¹æ³•ã€‚Responseç±»é‡Œä¹Ÿå› ä¸ºå®ç°æ¥å£ï¼Œæ–°å¢äº†è®¸å¤šæ¥å£å®ç°æ–¹æ³•ï¼Œåœ¨ç›®å‰è¿™ä¸ªé˜¶æ®µï¼Œæˆ‘ä»¬åªéœ€è¦å…³æ³¨ <strong>getWriter()</strong> è¿™ä¸€ä¸ªæ–¹æ³•ã€‚</p><pre><code class=\"language-java\">public PrintWriter getWriter() throws IOException {\n&nbsp; &nbsp; writer = new PrintWriter(new OutputStreamWriter(output,getCharacterEncoding()), true);\n&nbsp; &nbsp; return writer;\n}\n</code></pre><p>çœ‹ä¸Šè¿°å®ç°ï¼Œåœ¨è¿™ä¹‹å‰æˆ‘ä»¬ç”¨ <code>byte[]</code> æ•°ç»„ç±»å‹ä½œä¸ºoutputçš„è¾“å‡ºï¼Œè¿™å¯¹ä¸šåŠ¡ç¨‹åºå‘˜æ¥è¯´æ˜¯ä¸å¤ªä¾¿åˆ©çš„ï¼Œå› æ­¤æˆ‘ä»¬ç°åœ¨æ”¯æŒå¾€è¾“å‡ºæµé‡Œå†™å…¥Stringå­—ç¬¦ä¸²æ•°æ®ï¼Œäºæ˜¯å°±éœ€è¦ç”¨åˆ°PrintWriterç±»ã€‚å¯ä»¥çœ‹åˆ°è¿™é‡Œè°ƒç”¨äº† <code>getCharacterEncoding()</code> æ–¹æ³•ï¼Œä¸€èˆ¬å¸¸ç”¨çš„æ˜¯UTF-8ï¼Œæ‰€ä»¥åœ¨è°ƒç”¨ <code>getWriter()</code> ä¹‹å‰ï¼Œä¸€å®šè¦å…ˆè°ƒç”¨ <code>setCharacterEncoding()</code> è®¾ç½®å­—ç¬¦é›†ã€‚</p><p>åœ¨PrintWriteræ„é€ å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬ç›®å‰è®¾ç½®äº†ä¸€ä¸ªå€¼ä¸ºtrueã€‚è¿™ä¸ªå€¼çš„å«ä¹‰ä¸ºautoflushï¼Œå½“ä¸ºtrueæ—¶ï¼Œprintlnã€printfç­‰æ–¹æ³•ä¼šè‡ªåŠ¨åˆ·æ–°è¾“å‡ºæµçš„ç¼“å†²ã€‚</p><p>å½“æä¾›äº†writeråï¼Œæˆ‘ä»¬ç€æ‰‹æ”¹é€ ServletProcessorï¼Œæ”¹é€ åå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code class=\"language-java\">public class ServletProcessor {\n    //è¿”å›ä¸²çš„æ¨¡æ¿ï¼Œå®é™…è¿”å›æ—¶æ›¿æ¢å˜é‡\n    private static String OKMessage = \"HTTP/1.1 ${StatusCode} ${StatusName}\\r\\n\"+\n            \"Content-Type: ${ContentType}\\r\\n\"+\n            \"Server: minit\\r\\n\"+\n            \"Date: ${ZonedDateTime}\\r\\n\"+\n            \"\\r\\n\";\n    public void process(Request request, Response response) {\n        String uri = request.getUri(); //è·å–URI\n        //æŒ‰ç…§ç®€å•è§„åˆ™ç¡®å®šservletåï¼Œè®¤ä¸ºæœ€åä¸€ä¸ª/ç¬¦å·åçš„å°±æ˜¯servletå\n        String servletName = uri.substring(uri.lastIndexOf(\"/\") + 1);\n        URLClassLoader loader = null;\n        PrintWriter writer = null;\n        try {\n            // create a URLClassLoader\n            URL[] urls = new URL[1];\n            URLStreamHandler streamHandler = null;\n            //ä»å…¨å±€å˜é‡HttpServer.WEB_ROOTä¸­è®¾ç½®ç±»çš„ç›®å½•\n            File classPath = new File(HttpServer.WEB_ROOT);\n            String repository = (new URL(\"file\", null, classPath.getCanonicalPath() + File.separator)).toString() ;\n            urls[0] = new URL(null, repository, streamHandler);\n            loader = new URLClassLoader(urls);\n        }\n        catch (IOException e) {\n            System.out.println(e.toString() );\n        }\n        //è·å–PrintWriter\n        try {\n            response.setCharacterEncoding(\"UTF-8\");\n            writer = response.getWriter();\n        } catch (IOException e1) {\n            e1.printStackTrace();\n        }\n        //åŠ è½½servlet\n        Class&lt;?&gt; servletClass = null;\n        try {\n            servletClass = loader.loadClass(servletName);\n        }\n        catch (ClassNotFoundException e) {\n            System.out.println(e.toString());\n        }\n        \n        //ç”Ÿæˆè¿”å›å¤´\n        String head = composeResponseHead();\n        writer.println(head);\n        Servlet servlet = null;\n        try {  \n            //è°ƒç”¨servletï¼Œç”±servletå†™responseä½“\n            servlet = (Servlet) servletClass.newInstance();\n            servlet.service(request, response);\n        }\n        catch (Exception e) {\n            System.out.println(e.toString());\n        }\n        catch (Throwable e) {\n            System.out.println(e.toString());\n        }\n    }\n    //ç”Ÿæˆè¿”å›å¤´ï¼Œæ ¹æ®åè®®æ ¼å¼æ›¿æ¢å˜é‡\n    private String composeResponseHead() {\n        Map&lt;String,Object&gt; valuesMap = new HashMap&lt;&gt;();\n        valuesMap.put(\"StatusCode\",\"200\");\n        valuesMap.put(\"StatusName\",\"OK\");\n        valuesMap.put(\"ContentType\",\"text/html;charset=UTF-8\");\n        valuesMap.put(\"ZonedDateTime\", DateTimeFormatter.ISO_ZONED_DATE_TIME.format(ZonedDateTime.now()));\n        StrSubstitutor sub = new StrSubstitutor(valuesMap);\n        String responseHead = sub.replace(OKMessage);\n        return responseHead;\n    }\n}\n</code></pre><p>ä¸»è¦å˜åŒ–æœ‰ 3 å¤„ã€‚</p><ol>\n<li>ä½¿ç”¨PrintWriteræ¥å£æ›¿æ¢äº†åŸæ¥çš„OutputStreamã€‚</li>\n<li>åœ¨åŠ è½½Servletä¹‹å‰è®¾ç½®characterEncodingä¸º UTF-8ï¼Œå†è·å–Writerã€‚</li>\n<li>Writerä¸­è®¾ç½®äº†autoflushï¼Œå› æ­¤ä¸å†éœ€è¦åƒåŸæ¥ä¸€æ ·æ‰‹åŠ¨è®¾ç½®output.flushã€‚</li>\n</ol><p>æœ€ååˆ™æ˜¯è°ƒæ•´ç”¨æ¥æµ‹è¯•çš„HelloServletï¼Œå®ç°Servletæ¥å£ï¼Œåœ¨è¾“å‡ºä¹‹å‰è®¾ç½®characterEncodingã€‚</p><pre><code class=\"language-java\">public class HelloServlet implements Servlet{\n    @Override\n    public void service(ServletRequest req, ServletResponse res) throws ServletException, IOException {\n        res.setCharacterEncoding(\"UTF-8\");\n        String doc = \"&lt;!DOCTYPE html&gt; \\n\" +\n                \"&lt;html&gt;\\n\" +\n                \"&lt;head&gt;&lt;meta charset=\\\"utf-8\\\"&gt;&lt;title&gt;Test&lt;/title&gt;&lt;/head&gt;\\n\"+\n                \"&lt;body bgcolor=\\\"#f0f0f0\\\"&gt;\\n\" +\n                \"&lt;h1 align=\\\"center\\\"&gt;\" + \"Hello World ä½ å¥½\" + \"&lt;/h1&gt;\\n\";\n        res.getWriter().println(doc);\n    }\n    @Override\n    public void destroy() {\n    }\n    @Override\n    public ServletConfig getServletConfig() {\n        return null;\n    }\n    @Override\n    public String getServletInfo() {\n        return null;\n    }\n    @Override\n    public void init(ServletConfig arg0) throws ServletException {\n    }\n}\n</code></pre><p>é€šè¿‡æµ‹è¯•æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä¸­æ–‡æ­£ç¡®åœ°è¾“å‡ºäº†ã€‚</p><h2>HttpServerèŒèƒ½æ‹†è§£</h2><p>åœ¨æœåŠ¡å™¨ç¬¦åˆServletè§„èŒƒä¹‹åï¼Œæˆ‘ä»¬å†è½¬å‘æœåŠ¡å™¨æœ¬èº«ï¼Œä¹Ÿå°±æ˜¯HttpServerè¿™ä¸ªæ ¸å¿ƒå®ç°ç±»ã€‚</p><p>ç›®å‰æˆ‘ä»¬å·²æ‹¥æœ‰åŸºæœ¬çš„Servlet ContaineråŠŸèƒ½ï¼Œå…·å¤‡æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚ï¼Œè°ƒç”¨Servletä»¥åŠå“åº”å®¢æˆ·ç«¯è¯·æ±‚çš„èƒ½åŠ›ã€‚ä¸ºäº†è¾¾åˆ°å„å¸å…¶èŒçš„ç›®æ ‡ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒæ‹†åˆ†æˆä¸¤ä¸ªå¤§å—ï¼šConnecctorå’ŒProcessorï¼Œåˆ†åˆ«è´Ÿè´£å¤„ç†æ¥æ”¶ã€å“åº”å®¢æˆ·ç«¯è¯·æ±‚ä»¥åŠè°ƒç”¨Servletã€‚</p><p>å®ç°HttpProcessor.javaå¦‚ä¸‹ï¼š</p><pre><code class=\"language-java\">public class HttpProcessor {\n    public HttpProcessor(){\n    }\n    public void process(Socket socket) {\n        InputStream input = null;\n        OutputStream output = null;\n        try {\n            input = socket.getInputStream();\n            output = socket.getOutputStream();\n            // create Request object and parse\n            Request request = new Request(input);\n            request.parse();\n            // create Response object\n            Response response = new Response(output);\n            response.setRequest(request);\n\n            // check if this is a request for a servlet or a static resource\n            // a request for a servlet begins with \"/servlet/\"\n            if (request.getUri().startsWith(\"/servlet/\")) {\n                ServletProcessor processor = new ServletProcessor();\n                processor.process(request, response);\n            }\n            else {\n                StaticResourceProcessor processor = new StaticResourceProcessor();\n                processor.process(request, response);\n            }\n            // Close the socket\n            //socket.close();\n        } catch (Exception e) {\n            e.printStackTrace();\n        }\n    }\n}\n</code></pre><p>åœ¨HttpProcessorä¸­ï¼Œprocessæ–¹æ³•å…·ä½“å®ç°å’ŒåŸæœ¬å¹¶æ²¡æœ‰å·®å¼‚ï¼Œåªæ˜¯æ–°å¢Socketå‚æ•°ä¼ å…¥ã€‚ç°åœ¨æœ‰äº†è¿™ä¸ªä¸“é—¨çš„æœºæ„æ¥åˆ†å·¥ï¼Œè°ƒç”¨Servletæˆ–è€…æ˜¯é™æ€èµ„æºã€‚</p><p>HttpConnectorå®ç°å¦‚ä¸‹ï¼š</p><pre><code class=\"language-java\">public class HttpConnector implements Runnable {\n    public void run() {\n        ServerSocket serverSocket = null;\n        int port = 8080;\n        try {\n            serverSocket = new ServerSocket(port, 1, InetAddress.getByName(\"127.0.0.1\"));\n        } catch (IOException e) {\n            e.printStackTrace();\n            System.exit(1);\n        }\n        while (true) {\n            Socket socket = null;\n            try {\n                socket = serverSocket.accept();\n                HttpProcessor processor = new HttpProcessor();\n                processor.process(socket);\n                // Close the socket\n                socket.close();\n            } catch (Exception e) {\n                e.printStackTrace();\n            }\n        }\n    }\n    public void start() {\n        Thread thread = new Thread(this);\n        thread.start();\n    }\n}\n</code></pre><p>éœ€è¦æ³¨æ„çš„æ˜¯HttpConnectorï¼Œå®ƒå®ç°äº†Runnableæ¥å£ï¼ŒæŠŠå®ƒçœ‹ä½œä¸€ä¸ªçº¿ç¨‹ï¼Œæ”¯æŒå¹¶å‘å¤„ç†ï¼Œæé«˜æ•´ä¸ªæœåŠ¡å™¨çš„ååé‡ã€‚è€ŒSocketçš„å…³é—­ï¼Œæœ€åä¹Ÿç»Ÿä¸€äº¤ç»™Connectorå¤„ç†ã€‚</p><p>è¿™æ ·æ•´ä¸ªæœåŠ¡å™¨åŸºæœ¬çš„å·¥ä½œæµç¨‹å°±æ˜¯ï¼šç”±Connectoræ¥æ”¶è¿æ¥ï¼Œæ¥äº†ä¸€ä¸ªSocketä¹‹åï¼Œå°±è½¬æ‰‹äº¤ç»™Processorè¿›è¡Œå¤„ç†ï¼Œå¤„ç†å®Œä¹‹åå†è¿”å›ç»™Connectoræ¥å…³é—­ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/15/6d/15e4d0e702f7da74fb8c185c8b31e26d.png?wh=2200x448\" alt=\"\"></p><p>æœ€åè°ƒæ•´HttpServerç±»ï¼Œå½“å‰è¿™ä¸ªç±»çš„å®ç°éå¸¸ç®€å•ï¼Œåªç”¨äºå¯åŠ¨Connectorè¿™ä¸ªçº¿ç¨‹ï¼Œæ¥ç­‰å¾…å®¢æˆ·ç«¯çš„è¯·æ±‚è¿æ¥ã€‚</p><pre><code class=\"language-java\">public class HttpServer {\n    public static final String WEB_ROOT =\n            System.getProperty(\"user.dir\") + File.separator + \"webroot\";\n    public static void main(String[] args) {\n        HttpConnector connector = new HttpConnector();\n        connector.start();\n    }\n}\n</code></pre><h2>æµ‹è¯•</h2><p>åœ¨ <code>src/test/java/test</code> ç›®å½•ä¸‹ï¼Œä¿®æ”¹HelloServletã€‚</p><pre><code class=\"language-java\">package test;\nimport java.io.IOException;\nimport javax.servlet.Servlet;\nimport javax.servlet.ServletConfig;\nimport javax.servlet.ServletException;\nimport javax.servlet.ServletRequest;\nimport javax.servlet.ServletResponse;\npublic class HelloServlet implements Servlet{\n    @Override\n    public void service(ServletRequest req, ServletResponse res) throws ServletException, IOException {\n        res.setCharacterEncoding(\"UTF-8\");\n        String doc = \"&lt;!DOCTYPE html&gt; \\n\" +\n                \"&lt;html&gt;\\n\" +\n                \"&lt;head&gt;&lt;meta charset=\\\"utf-8\\\"&gt;&lt;title&gt;Test&lt;/title&gt;&lt;/head&gt;\\n\"+\n                \"&lt;body bgcolor=\\\"#f0f0f0\\\"&gt;\\n\" +\n                \"&lt;h1 align=\\\"center\\\"&gt;\" + \"Hello World ä½ å¥½\" + \"&lt;/h1&gt;\\n\";\n        res.getWriter().println(doc);\n    }\n    @Override\n    public void destroy() {\n    }\n    @Override\n    public ServletConfig getServletConfig() {\n        return null;\n    }\n    @Override\n    public String getServletInfo() {\n        return null;\n    }\n    @Override\n    public void init(ServletConfig arg0) throws ServletException {\n    }\n}\n</code></pre><p>å®ç°çš„Servletæ˜¯javax.servlet.Servletï¼Œæ–°å¢characterEncodingè®¾ç½®ï¼Œæœ€åç”¨Writerè¾“å‡ºè‡ªå®šä¹‰çš„HTMLæ–‡æœ¬ã€‚</p><p>åœ¨å‡†å¤‡å·¥ä½œè¿›è¡Œå®Œæ¯•ä¹‹åï¼Œæˆ‘ä»¬è¿è¡ŒHttpServeræœåŠ¡å™¨ï¼Œé”®å…¥ <a href=\"http://localhost:8080/hello.txt,\">http://localhost:8080/hello.txt</a> åï¼Œå¯ä»¥å‘ç°hello.txté‡Œçš„æ‰€æœ‰æ–‡æœ¬å†…å®¹ï¼Œéƒ½ä½œä¸ºè¿”å›ä½“å±•ç¤ºåœ¨æµè§ˆå™¨é¡µé¢ä¸Šäº†ã€‚å†è¾“å…¥ <a href=\"http://localhost:8080/servlet/test.HelloServlet\">http://localhost:8080/servlet/test.HelloServlet</a> åï¼Œå°±å¯ä»¥çœ‹åˆ°æµè§ˆå™¨æ˜¾ç¤ºï¼šHello World ä½ å¥½ã€‚è¿™ä¹Ÿæ˜¯æˆ‘ä»¬åœ¨HelloServleté‡Œå®šä¹‰çš„è¿”å›èµ„æºå†…å®¹ã€‚</p><p>è¿™è¯´æ˜æ•´ä½“åŠŸèƒ½æ”¹é€ æˆåŠŸã€‚</p><h2>å°ç»“</h2><p><img src=\"https://static001.geekbang.org/resource/image/55/58/5521ab5327b8b25419138a9fbcd78358.jpg?wh=2564x1626\" alt=\"\"></p><p>è¿™èŠ‚è¯¾æˆ‘ä»¬æŒ‰ç…§Servletè§„èŒƒï¼Œå¯¹Requestã€Responseç±»ä»¥åŠæµ‹è¯•ç”¨çš„HelloServletè¿›è¡Œäº†æ”¹é€ ï¼Œä¸»è¦çš„å†…å®¹å°±æ˜¯æ”¯æŒè§„èŒƒï¼Œæ‰€ä»¥ä»ä»£ç å±‚é¢çœ‹å¢åŠ äº†è®¸å¤šæ–¹æ³•ï¼Œä½†æ˜¯ç›®å‰æˆ‘ä»¬éƒ½æ²¡æœ‰ç”¨åˆ°ï¼Œå®ç°çš„ä¹Ÿä»…ä»…æ˜¯æ ¸å¿ƒéƒ¨åˆ†ã€‚</p><p>ç„¶åæˆ‘ä»¬è¿›ä¸€æ­¥å°†HttpServeråŠŸèƒ½è¿›è¡Œæ‹†åˆ†è§£è€¦ï¼Œåˆ†æˆConnectorå’ŒProcessorï¼ŒConnectorè´Ÿè´£å®ç°æ¥æ”¶ç½‘ç»œè¿æ¥å’Œè¿”å›ï¼ŒProcessorè´Ÿè´£å¤„ç†é€»è¾‘ï¼Œå³è°ƒç”¨Servletå¹¶è¿”å›ã€‚å„ä¸ªéƒ¨åˆ†å„å¸å…¶èŒï¼Œå¹¶ä¸”è€ƒè™‘å®ç°Runnableæ¥å£æ”¯æŒç‹¬ç«‹çº¿ç¨‹å¹¶å‘è°ƒç”¨ï¼Œä¸ºæœªæ¥æé«˜æ•´ä½“æ€§èƒ½åšå‡†å¤‡ã€‚</p><p>æœ¬èŠ‚è¯¾ä»£ç å‚è§ï¼š<a href=\"https://gitee.com/yaleguo1/minit-learning-demo/tree/geek_chapter04\">https://gitee.com/yaleguo1/minit-learning-demo/tree/geek_chapter04</a></p><h2>æ€è€ƒé¢˜</h2><p>å­¦å®Œäº†è¿™èŠ‚è¯¾çš„å†…å®¹ï¼Œæˆ‘ä»¬æ¥æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼šæˆ‘ä»¬ç°åœ¨æ˜¯åœ¨ä¸€ä¸ªæ— é™å¾ªç¯ä¸­æ¯æ¥æ”¶ä¸€ä¸ªSocketè¿æ¥å°±ä¸´æ—¶åˆ›å»ºä¸€ä¸ªProcessoræ¥å¤„ç†è¿™ä¸ªSocketï¼Œå¤„ç†å®Œæ¯•ä¹‹åå†å¼€å§‹ä¸‹ä¸€ä¸ªå¾ªç¯ï¼Œè¿™ä¸ªServeræ˜¯ä¸²è¡Œå·¥ä½œæ¨¡å¼ï¼Œæ€ä¹ˆæé«˜è¿™ä¸ªServerçš„å¹¶å‘åº¦ï¼Ÿ</p><p>æ¬¢è¿ä½ æŠŠä½ æ€è€ƒåçš„ç»“æœåˆ†äº«åˆ°è¯„è®ºåŒºï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾çš„å†…å®¹åˆ†äº«ç»™å…¶ä»–æœ‹å‹ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼</p>","comments":[{"had_liked":false,"id":386145,"user_name":"ï¼Ÿæ–°ï¼","can_delete":false,"product_type":"c1","uid":1537709,"ip_address":"å››å·","ucode":"56E547E279A10A","user_header":"https://static001.geekbang.org/account/avatar/00/17/76/ad/f192d95e.jpg","comment_is_top":false,"comment_ctime":1704188790,"is_pvip":false,"replies":[{"id":140780,"content":"æœ‰é“ç†ã€‚ä½ çœ‹ä¸€ä¸‹catalinaå¼€å¤´çš„æ—¥å¿—æ–‡ä»¶ã€‚\nå†å¯ç”¨ä¸€ä¸‹AccessLogValveçœ‹çœ‹ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ä½œè€…","uid":1864890,"ctime":1704328764,"ip_address":"æ¹–å—","comment_id":386145,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100636401,"comment_content":"è€å¸ˆæˆ‘æœ‰ä¸ªå…³äºtomcatè¿æ¥å±‚çš„é—®é¢˜æ±‚æ•™ï¼Ÿ\n    åœºæ™¯ï¼šå¤–éƒ¨nginxæ—¥å¿—è®°å½•è°ƒç”¨äº†AæœåŠ¡å¹¶ä¸”è¶…æ—¶ï¼Œä½†æ˜¯AæœåŠ¡æœ¬åœ°æ—¥å¿—localhost_access_logï¼Œæ²¡æœ‰è®°å½•ï¼Œäº†è§£åæ€€ç–‘æ˜¯è¿æ¥å±‚ï¼Œä¼šç­‰å¾…é˜Ÿåˆ—å°±è¶…æ—¶äº†ï¼Œæ‰€ä»¥æ²¡æœ‰åˆ°å®¹å™¨å±‚ï¼Œæ²¡æœ‰è¢«localhost_access_logè®°å½•ï¼Ÿ\n    é—®é¢˜ï¼š\n        1  æˆ‘çš„æ€€ç–‘æ˜¯å¦å¯èƒ½ï¼Ÿ\n        2 æœ‰åŠæ³•éªŒè¯å—ï¼Ÿæ¯”å¦‚tomcatç­‰å¾…é˜Ÿåˆ—è¶…æ—¶æˆ–è€…acceptè¶…æ—¶ï¼Œèƒ½è®°å½•æ—¥å¿—\n      ","like_count":1,"discussions":[{"author":{"id":1864890,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/cojb2AA3eM620kb7hj7YoOpq8XI0iaPyfajnQLO6icAhuSoYWR1vrdOZB2nmSuETxmuheo3sxec698SD6RhTFxgQ/132","nickname":"Yale Guo","note":"","ucode":"6736810620B3F0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":635026,"discussion_content":"æœ‰é“ç†ã€‚ä½ çœ‹ä¸€ä¸‹catalinaå¼€å¤´çš„æ—¥å¿—æ–‡ä»¶ã€‚\nå†å¯ç”¨ä¸€ä¸‹AccessLogValveçœ‹çœ‹ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1704328764,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æ¹–å—","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":1,"child_discussions":[{"author":{"id":1537709,"avatar":"https://static001.geekbang.org/account/avatar/00/17/76/ad/f192d95e.jpg","nickname":"ï¼Ÿæ–°ï¼","note":"","ucode":"56E547E279A10A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1864890,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/cojb2AA3eM620kb7hj7YoOpq8XI0iaPyfajnQLO6icAhuSoYWR1vrdOZB2nmSuETxmuheo3sxec698SD6RhTFxgQ/132","nickname":"Yale Guo","note":"","ucode":"6736810620B3F0","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":635044,"discussion_content":"é¦–å…ˆæ„Ÿè°¢è€å¸ˆçš„è§£ç­”ï¼Œæˆ‘æè¿°çš„ä¸å¤ªå‡†ç¡®ï¼Œæˆ‘é‡æ–°æè¿°ä¸€ä¸‹\n   é—®é¢˜å’ŒçŒœæµ‹ï¼šæˆ‘æƒ³éªŒè¯è¯·æ±‚æ˜¯åœ¨maxConnectionsçš„LimitLatchç­‰å¾…ä¸­è¶…æ—¶çš„ï¼Œè¿˜æ˜¯åœ¨workçº¿ç¨‹æ± é˜Ÿåˆ—ä¸­ç­‰å¾…è¶…æ—¶çš„ï¼Ÿ\n    1 èƒŒæ™¯ä¸€æ ·ï¼Œé¦–å…ˆAccessLogValveå·²ç»å¼€å¯ï¼Œå¯¹åº”çš„access_logä¸­å‡ ä¹æ²¡æœ‰è¶…æ—¶çš„è¯·æ±‚è®°å½•ã€‚è¯¥Valveé…ç½®æ˜¯åœ¨Hostä¸‹ï¼Œå¦‚æœè¿æ¥æ²¡æœ‰è¢«workerçº¿ç¨‹æ¶ˆè´¹ï¼Œé‚£ä¹ˆAccessLogValveå™¨å¯èƒ½å°±è®°å½•ä¸åˆ°ã€ä¸ªäººäº†è§£ã€‘\n    2 ã€ä¸ªäººäº†è§£çš„ã€‘catalina æ˜¯Engineå±‚æ—¥å¿—ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæŒ‰ç…§æˆ‘çš„çŒœæµ‹ï¼Œåº”è¯¥ä¹Ÿä¸ä¼šæœ‰è®°å½•å§","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1704339082,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":635026,"ip_address":"å››å·","group_id":0},"score":635044,"extra":""}]}]},{"had_liked":false,"id":385466,"user_name":"peter","can_delete":false,"product_type":"c1","uid":1058183,"ip_address":"åŒ—äº¬","ucode":"261C3FC001DE2D","user_header":"https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg","comment_is_top":false,"comment_ctime":1702692723,"is_pvip":false,"replies":[{"id":140481,"content":"Q1, ä½ è‡ªå·±çœ‹URL apiå¸®åŠ©æ–‡æ¡£\nQ2, @Overrideæ˜¯ä¸€ä¸ªç¼–è¯‘æ—¶æ³¨è§£ï¼ŒåŠ ä¸Šæ˜¯ä¸€ä¸ªå¥½ä¹ æƒ¯ï¼Œæ²¡æœ‰ä¹Ÿä¸ä¼šå‡ºè¿è¡Œæ—¶é”™è¯¯\nQ3ï¼Œè¿™ä¸ªé—®é¢˜å¥½ã€‚æœ‰äº›æµè§ˆå™¨å°†è¯·æ±‚åˆ†æˆç®€å•è¯·æ±‚å’Œéç®€å•è¯·æ±‚ï¼Œå¯¹äºéç®€å•è¯·æ±‚ï¼Œæµè§ˆå™¨ä¼šå…ˆå‘å‡ºä¸€ä¸ªOPTIONSé¢„æ£€è¯·æ±‚ï¼Œè¿™æ˜¯ä¸ºäº†å®‰å…¨æ€§çš„åŸå› ã€‚MiniTomcatæ²¡æœ‰è€ƒè™‘è¿™äº›å®é™…å·¥ä½œä¸­çš„å¤æ‚æ€§ï¼Œç›´æ¥å¿½ç•¥äº†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ä½œè€…","uid":1864890,"ctime":1702778673,"ip_address":"åŒ—äº¬","comment_id":385466,"utype":1}],"discussion_count":5,"race_medal":0,"score":2,"product_id":100636401,"comment_content":"è¯·æ•™è€å¸ˆå‡ ä¸ªé—®é¢˜ï¼š\nQ1ï¼šstreamHandlerä¸éœ€è¦èµ‹å€¼å—ï¼Ÿ\nServletProcessor.javaçš„processæ–¹æ³•ä¸­ï¼š\nURLStreamHandler streamHandler = null;\nurls[0] = new URL(null, repository, streamHandler);\nä»£ç å£°æ˜äº†å˜é‡â€œstreamHandlerâ€ï¼Œ\nä½†æ˜¯æ²¡æœ‰èµ‹å€¼ï¼Œç„¶åç›´æ¥ç”¨æ¥åˆ›å»ºURLçš„å¯¹è±¡ã€‚\nè¯·é—®ï¼šä¸ºä»€ä¹ˆæ²¡æœ‰ç»™â€œstreamHandlerâ€èµ‹å€¼ï¼Ÿ\n\nQ2ï¼šHttpConnectorçš„runæ–¹æ³•ä¸ºä»€ä¹ˆæ²¡æœ‰æ³¨è§£ï¼Ÿ\nç±»å®šä¹‰ï¼šHttpConnector implements Runnableï¼Œ\nå…¶runæ–¹æ³•ä¸Šé¢æ²¡æœ‰æ³¨è§£ï¼ŒIdea2019æç¤ºï¼š\nMissing &#39;@Override&#39; annotation on &#39;run()&#39; ã€‚\nä½†ç¨‹åºèƒ½è¿è¡Œã€‚è¯·é—®è€å¸ˆçš„ä»£ç ä¸­ï¼Œrunæ–¹æ³•ä¸ºä»€ä¹ˆæ²¡æœ‰æ³¨è§£ï¼Ÿ\n\nQ3ï¼šç¬¬03è¯¾ä»£ç ï¼Œä¸€æ¬¡è¯·æ±‚ï¼Œsocket = serverSocket.accept();ä¸ºä»€ä¹ˆè¿è¡Œä¸¤æ¬¡ï¼Ÿ\nHttpServer.javaæ–‡ä»¶ä¸­,while(true)ä»£ç å—,åœ¨serverSocket.accept();è¿™é‡Œé˜»å¡ã€‚æµè§ˆå™¨ä¸­è¾“å…¥è¯·æ±‚ï¼Œåˆ›å»ºRequestï¼ŒæˆåŠŸåœ°èµ°å®Œäº†æ•´ä¸ªæµç¨‹ã€‚èµ°å®Œæ•´ä¸ªæµç¨‹åæŒ‰é“ç†åº”è¯¥è¿˜åœ¨serverSocket.accept();è¿™é‡Œé˜»å¡ã€‚ä½†ç«Ÿç„¶å†æ¬¡åˆ›å»ºRequestï¼Œä¸è¿‡åœ¨Requestç±»çš„parseå‡½æ•°ä¸­ï¼Œåœ¨i = input.read(buffer);è¿™ä¸ªåœ°æ–¹ä¸å†å¾€ä¸‹é¢æ‰§è¡Œã€‚æˆ‘åœ¨input.readå‰åéƒ½åŠ äº†æ‰“å°è¯­å¥ï¼Œå‰é¢çš„æ‰“å°è¯­å¥æ‰§è¡Œäº†ï¼Œåé¢çš„æ²¡æœ‰æ‰§è¡Œï¼Œç¥å¥‡å•Šï¼Œä¸ºä»€ä¹ˆå•Šï¼Ÿ\nç®€å•åœ°è¯´ï¼Œå°±æ˜¯ï¼šæµè§ˆå™¨å‘é€ä¸€ä¸ªè¯·æ±‚ï¼ŒHttpServeræ”¶åˆ°äº†ä¸¤ä¸ªrequest,ç¬¬ä¸€ä¸ªæ­£å¸¸å¤„ç†ï¼Œç¬¬äºŒä¸ªä¸èƒ½æ­£å¸¸æ‰§è¡Œã€‚ï¼ˆæˆ‘ç”¨çš„æ˜¯Chromeæµè§ˆå™¨ï¼Œä¹Ÿè®¸å’Œæµè§ˆå™¨æœ‰å…³ï¼Ÿï¼‰","like_count":1,"discussions":[{"author":{"id":1864890,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/cojb2AA3eM620kb7hj7YoOpq8XI0iaPyfajnQLO6icAhuSoYWR1vrdOZB2nmSuETxmuheo3sxec698SD6RhTFxgQ/132","nickname":"Yale Guo","note":"","ucode":"6736810620B3F0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":633914,"discussion_content":"Q1, ä½ è‡ªå·±çœ‹URL apiå¸®åŠ©æ–‡æ¡£\nQ2, @Overrideæ˜¯ä¸€ä¸ªç¼–è¯‘æ—¶æ³¨è§£ï¼ŒåŠ ä¸Šæ˜¯ä¸€ä¸ªå¥½ä¹ æƒ¯ï¼Œæ²¡æœ‰ä¹Ÿä¸ä¼šå‡ºè¿è¡Œæ—¶é”™è¯¯\nQ3ï¼Œè¿™ä¸ªé—®é¢˜å¥½ã€‚æœ‰äº›æµè§ˆå™¨å°†è¯·æ±‚åˆ†æˆç®€å•è¯·æ±‚å’Œéç®€å•è¯·æ±‚ï¼Œå¯¹äºéç®€å•è¯·æ±‚ï¼Œæµè§ˆå™¨ä¼šå…ˆå‘å‡ºä¸€ä¸ªOPTIONSé¢„æ£€è¯·æ±‚ï¼Œè¿™æ˜¯ä¸ºäº†å®‰å…¨æ€§çš„åŸå› ã€‚MiniTomcatæ²¡æœ‰è€ƒè™‘è¿™äº›å®é™…å·¥ä½œä¸­çš„å¤æ‚æ€§ï¼Œç›´æ¥å¿½ç•¥äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1702778673,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1607786,"avatar":"https://static001.geekbang.org/account/avatar/00/18/88/6a/fe18b26d.jpg","nickname":"åå­—å¥½è…»å®³","note":"","ucode":"2D157076F1D5B7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":642961,"discussion_content":"Q1:æˆ‘ä¹Ÿæœ‰è¿™ä¸ªç–‘é—®,æŸ¥äº†ä¸‹å¯èƒ½æ˜¯è¿™æ ·\nSpecifying a handler of null indicates that the URL should use a default stream handler for the protocol.\nProtocol handlers for the following protocols are guaranteed to exist on the search path :-http, https, file, and jar\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1713947284,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"æ¹–åŒ—","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1331059,"avatar":"https://static001.geekbang.org/account/avatar/00/14/4f/73/d0fffc16.jpg","nickname":"seeker of truth","note":"","ucode":"76ABF9D985BFF1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":636044,"discussion_content":"é’ˆå¯¹Q1ï¼Œæˆ‘çŒœä»–å¤§çº¦æ˜¯æƒ³é—®ä¸ºä»€ä¹ˆåœ¨ä»£ç é‡Œå¼•å…¥äº†URLStreamHandlerè¿™ä¸ªå˜é‡ï¼Œä½†å…¨ç¨‹éƒ½æ˜¯nullï¼Œå¹²å˜›ä¸ç›´æ¥ç”¨nullæ¥åšå‡½æ•°è°ƒç”¨ã€‚æˆ‘ä¹±çŒœæ˜¯ä¸ºäº†ä½¿ä»£ç æ›´é è¿‘æ–‡æ¡£ï¼Œä¹Ÿæ–¹ä¾¿å°†æ¥æ›´æ–°ä»£ç ï¼Œä½¿ç”¨çœŸçš„handlerå§ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1705510325,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"ç¾å›½","group_id":0},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1607786,"avatar":"https://static001.geekbang.org/account/avatar/00/18/88/6a/fe18b26d.jpg","nickname":"åå­—å¥½è…»å®³","note":"","ucode":"2D157076F1D5B7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1331059,"avatar":"https://static001.geekbang.org/account/avatar/00/14/4f/73/d0fffc16.jpg","nickname":"seeker of truth","note":"","ucode":"76ABF9D985BFF1","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":642956,"discussion_content":"ç›´æ¥ç”¨nullç¼–è¯‘ä¸äº†,URLæ„é€ æ–¹æ³•è¿˜æœ‰ä¸€ä¸ªä¸‰ä¸ªStringå‚æ•°çš„æ„é€ æ–¹æ³•,å¦‚æœstreamHandlerä¹Ÿç”¨null,ç¼–è¯‘å™¨ä¸çŸ¥é“ç”¨å“ªä¸ªæ„é€ æ–¹æ³•,è¿‡ä¸äº†ç¼–è¯‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1713944874,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":636044,"ip_address":"æ¹–åŒ—","group_id":0},"score":642956,"extra":""}]},{"author":{"id":1331059,"avatar":"https://static001.geekbang.org/account/avatar/00/14/4f/73/d0fffc16.jpg","nickname":"seeker of truth","note":"","ucode":"76ABF9D985BFF1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":636043,"discussion_content":"é’ˆå¯¹Q1ï¼Œæˆ‘çŒœä»–å¤§çº¦æ˜¯æƒ³é—®ä¸ºä»€ä¹ˆåœ¨ä»£ç é‡Œå¼•å…¥äº†URLStreamHandlerè¿™ä¸ªå˜é‡ï¼Œä½†å…¨ç¨‹éƒ½æ˜¯nullï¼Œå¹²å˜›ä¸ç›´æ¥ç”¨nullæ¥åšå‡½æ•°è°ƒç”¨ã€‚æˆ‘ä¹±çŒœæ˜¯ä¸ºäº†ä½¿ä»£ç æ›´é è¿‘æ–‡æ¡£ï¼Œä¹Ÿæ–¹ä¾¿å°†æ¥æ›´æ–°ä»£ç ï¼Œä½¿ç”¨çœŸçš„handlerå§ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1705510324,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"ç¾å›½","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":385405,"user_name":"HHğŸ·ğŸ ","can_delete":false,"product_type":"c1","uid":1133678,"ip_address":"å¹¿ä¸œ","ucode":"C50172BDA604D5","user_header":"https://static001.geekbang.org/account/avatar/00/11/4c/6e/5435e214.jpg","comment_is_top":false,"comment_ctime":1702597090,"is_pvip":false,"replies":[{"id":140478,"content":"æé«˜å¹¶å‘åº¦æœ‰ä¸€ç³»åˆ—æŠ€æœ¯ã€‚èƒ½ç¬¬ä¸€ååº”å‡ºæ¥çš„å°±æ˜¯å¤šçº¿ç¨‹ï¼Œå°†processorè®¾è®¡æˆå¤šä¸ªçº¿ç¨‹ï¼Œæ”¾åˆ°ä¸€ä¸ªæ± å­é‡Œé¢ï¼ŒæœåŠ¡å™¨æ¥å—å‰ç«¯å¤šä¸ªè¯·æ±‚åäº¤ç»™åé¢çº¿ç¨‹æ± å­é‡Œé¢çš„å¤šä¸ªprocessorçº¿ç¨‹æ¥å¹¶å‘å¤„ç†ã€‚è¿™è§£å†³äº†ä¸€éƒ¨åˆ†é—®é¢˜ï¼Œä½†æ˜¯å¯¹ä¸€ä¸ªprocessoræ¥è¯´ï¼Œå®ƒè¿˜æ˜¯ä¸²è¡Œå·¥ä½œçš„ï¼Œå½“å®ƒæ¶‰åŠåˆ°æ•°æ®åº“è®¿é—®ç½‘ç»œè®¿é—®æ–‡ä»¶æ“ä½œçš„æ—¶å€™ï¼Œå¯ä»¥è¿›ä¸€æ­¥å†åˆ†çº¿ç¨‹ã€‚ä¸è¿‡ç¨‹åºæ¨¡å¼éœ€è¦è°ƒæ•´æˆä½¿ç”¨Futureæˆ–è€…CompletableFuture,å®Œå…¨çš„å“åº”å¼ç¼–ç¨‹ç»“æ„å¤æ‚ã€‚JDK21æå‡ºçš„virtual threadå¾ˆå¥½åœ°è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚å®é™…å·¥ä½œä¸­ï¼Œè¦æ ¹æ®åœºæ™¯è¦æ±‚è¿›è¡Œé€‰æ‹©ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1864890,"ctime":1702776475,"ip_address":"åŒ—äº¬","comment_id":385405,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100636401,"comment_content":"ğŸ˜„æ± å­+é˜Ÿåˆ—ï¼Œ å­¦è‰ºä¸ç²¾å…·ä½“ç»†èŠ‚ç­”ä¸ä¸Šæ¥ï¼Œ è¯·è€å¸ˆæŒ‡ç‚¹ã€‚","like_count":1,"discussions":[{"author":{"id":1864890,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/cojb2AA3eM620kb7hj7YoOpq8XI0iaPyfajnQLO6icAhuSoYWR1vrdOZB2nmSuETxmuheo3sxec698SD6RhTFxgQ/132","nickname":"Yale Guo","note":"","ucode":"6736810620B3F0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":633911,"discussion_content":"æé«˜å¹¶å‘åº¦æœ‰ä¸€ç³»åˆ—æŠ€æœ¯ã€‚èƒ½ç¬¬ä¸€ååº”å‡ºæ¥çš„å°±æ˜¯å¤šçº¿ç¨‹ï¼Œå°†processorè®¾è®¡æˆå¤šä¸ªçº¿ç¨‹ï¼Œæ”¾åˆ°ä¸€ä¸ªæ± å­é‡Œé¢ï¼ŒæœåŠ¡å™¨æ¥å—å‰ç«¯å¤šä¸ªè¯·æ±‚åäº¤ç»™åé¢çº¿ç¨‹æ± å­é‡Œé¢çš„å¤šä¸ªprocessorçº¿ç¨‹æ¥å¹¶å‘å¤„ç†ã€‚è¿™è§£å†³äº†ä¸€éƒ¨åˆ†é—®é¢˜ï¼Œä½†æ˜¯å¯¹ä¸€ä¸ªprocessoræ¥è¯´ï¼Œå®ƒè¿˜æ˜¯ä¸²è¡Œå·¥ä½œçš„ï¼Œå½“å®ƒæ¶‰åŠåˆ°æ•°æ®åº“è®¿é—®ç½‘ç»œè®¿é—®æ–‡ä»¶æ“ä½œçš„æ—¶å€™ï¼Œå¯ä»¥è¿›ä¸€æ­¥å†åˆ†çº¿ç¨‹ã€‚ä¸è¿‡ç¨‹åºæ¨¡å¼éœ€è¦è°ƒæ•´æˆä½¿ç”¨Futureæˆ–è€…CompletableFuture,å®Œå…¨çš„å“åº”å¼ç¼–ç¨‹ç»“æ„å¤æ‚ã€‚JDK21æå‡ºçš„virtual threadå¾ˆå¥½åœ°è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚å®é™…å·¥ä½œä¸­ï¼Œè¦æ ¹æ®åœºæ™¯è¦æ±‚è¿›è¡Œé€‰æ‹©ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1702776475,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":1,"child_discussions":[{"author":{"id":1133678,"avatar":"https://static001.geekbang.org/account/avatar/00/11/4c/6e/5435e214.jpg","nickname":"HHğŸ·ğŸ ","note":"","ucode":"C50172BDA604D5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1864890,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/cojb2AA3eM620kb7hj7YoOpq8XI0iaPyfajnQLO6icAhuSoYWR1vrdOZB2nmSuETxmuheo3sxec698SD6RhTFxgQ/132","nickname":"Yale Guo","note":"","ucode":"6736810620B3F0","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":633976,"discussion_content":"èµ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1702864687,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":633911,"ip_address":"å¹¿ä¸œ","group_id":0},"score":633976,"extra":""}]}]},{"had_liked":false,"id":385816,"user_name":"stars","can_delete":false,"product_type":"c1","uid":1055100,"ip_address":"é™•è¥¿","ucode":"8A75D9E1909729","user_header":"https://static001.geekbang.org/account/avatar/00/10/19/7c/25abe455.jpg","comment_is_top":false,"comment_ctime":1703433833,"is_pvip":false,"replies":[{"id":140640,"content":"æ²¡æœ‰ç®€å•çš„ç­”æ¡ˆã€‚å¯¹Tomcatè¿™ç§åœºæ™¯ï¼Œå‰é¢çš„çº¿ç¨‹ç”¨äºæ¥æ”¶å®¢æˆ·ç«¯ç½‘ç»œè¿æ¥ï¼Œåé¢çš„çº¿ç¨‹ç”¨äºä¸šåŠ¡å¤„ç†ï¼ˆåˆç†çš„å‡å®šä¼šæ¶ˆè€—æ•°æ®åº“ï¼‰ï¼Œè¿™ç§åœºæ™¯å°±æ˜¯ä¼šæé«˜ååé‡çš„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ä½œè€…","uid":1864890,"ctime":1703655420,"ip_address":"æ¹–å—","comment_id":385816,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100636401,"comment_content":"åªæ˜¯åœ¨ä¸»çº¿ç¨‹å¯åŠ¨äº†ä¸€ä¸ªå­çº¿ç¨‹ï¼Œè¿™æ ·å°±æé«˜ååç‡äº†å—ï¼Ÿè¯·æ•™è€å¸ˆã€‚","like_count":0,"discussions":[{"author":{"id":1864890,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/cojb2AA3eM620kb7hj7YoOpq8XI0iaPyfajnQLO6icAhuSoYWR1vrdOZB2nmSuETxmuheo3sxec698SD6RhTFxgQ/132","nickname":"Yale Guo","note":"","ucode":"6736810620B3F0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":634555,"discussion_content":"æ²¡æœ‰ç®€å•çš„ç­”æ¡ˆã€‚å¯¹Tomcatè¿™ç§åœºæ™¯ï¼Œå‰é¢çš„çº¿ç¨‹ç”¨äºæ¥æ”¶å®¢æˆ·ç«¯ç½‘ç»œè¿æ¥ï¼Œåé¢çš„çº¿ç¨‹ç”¨äºä¸šåŠ¡å¤„ç†ï¼ˆåˆç†çš„å‡å®šä¼šæ¶ˆè€—æ•°æ®åº“ï¼‰ï¼Œè¿™ç§åœºæ™¯å°±æ˜¯ä¼šæé«˜ååé‡çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1703655420,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æ¹–å—","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]}]}