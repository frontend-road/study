{"id":355081,"title":"06 | å­˜å‚¨ç³»ç»Ÿï¼šç©ºé—´æ¢æ—¶é—´ï¼Œè¿˜æ˜¯æ—¶é—´æ¢ç©ºé—´ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å´ç£Šã€‚</p><p>ä»Šå¤©ï¼Œæˆ‘ä»¬æ¥å­¦ä¹ Sparkçš„å­˜å‚¨ç³»ç»Ÿï¼Œå®ƒå’Œæˆ‘ä»¬ä¸Šä¸€è®²å­¦è¿‡çš„è°ƒåº¦ç³»ç»Ÿä¸€æ ·ï¼Œéƒ½æ˜¯Sparkåˆ†å¸ƒå¼è®¡ç®—å¼•æ“çš„åŸºç¡€è®¾æ–½ä¹‹ä¸€ã€‚</p><p>ä½ å¯èƒ½ä¼šé—®ï¼šâ€œåœ¨æ—¥å¸¸çš„å¼€å‘å·¥ä½œä¸­ï¼Œé™¤äº†ä¸šåŠ¡é€»è¾‘å®ç°ï¼Œæˆ‘çœŸçš„éœ€è¦å»å…³å¿ƒè¿™ä¹ˆåº•å±‚çš„ä¸œè¥¿å—ï¼Ÿâ€ç¡®å®ï¼Œå­˜å‚¨ç³»ç»Ÿç¦»å¼€å‘è€…æ¯”è¾ƒè¿œã€‚ä¸è¿‡ï¼Œå¦‚æœæŠŠç›®å…‰è½åœ¨å­˜å‚¨ç³»ç»Ÿæ‰€æœåŠ¡çš„å¯¹è±¡ä¸Šï¼Œä½ å¾ˆå¯èƒ½ä¼šæ”¹å˜è¿™ç§çœ‹æ³•ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œå’±ä»¬å°±å…ˆæ¥çœ‹çœ‹Spark å­˜å‚¨ç³»ç»Ÿéƒ½ä¸ºè°æœåŠ¡ï¼Œå†å»æ¢è®¨å®ƒæœ‰å“ªäº›é‡è¦ç»„ä»¶ï¼Œä»¥åŠå®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œå¸¦ä½ ä¸€æ¬¡æ€§æ‘¸é€å­˜å‚¨ç³»ç»Ÿã€‚</p><h2>Sparkå­˜å‚¨ç³»ç»Ÿæ˜¯ä¸ºè°æœåŠ¡çš„ï¼Ÿ</h2><p>Spark å­˜å‚¨ç³»ç»Ÿç”¨äºå­˜å‚¨ 3ä¸ªæ–¹é¢çš„æ•°æ®ï¼Œ<strong>åˆ†åˆ«æ˜¯RDD ç¼“å­˜ã€Shuffle ä¸­é—´æ–‡ä»¶ã€å¹¿æ’­å˜é‡ã€‚æˆ‘ä»¬ä¸€ä¸ªä¸€ä¸ªæ¥è¯´ã€‚</strong></p><p>RDDç¼“å­˜æŒ‡çš„<strong>æ˜¯å°†RDDä»¥ç¼“å­˜çš„å½¢å¼ç‰©åŒ–åˆ°å†…å­˜æˆ–ç£ç›˜çš„è¿‡ç¨‹</strong>ã€‚å¯¹äºä¸€äº›è®¡ç®—æˆæœ¬å’Œè®¿é—®é¢‘ç‡éƒ½æ¯”è¾ƒé«˜çš„RDDæ¥è¯´ï¼Œç¼“å­˜æœ‰ä¸¤ä¸ªå¥½å¤„ï¼šä¸€æ˜¯é€šè¿‡æˆªæ–­DAGï¼Œå¯ä»¥é™ä½å¤±è´¥é‡è¯•çš„è®¡ç®—å¼€é”€ï¼›äºŒæ˜¯é€šè¿‡å¯¹ç¼“å­˜å†…å®¹çš„è®¿é—®ï¼Œå¯ä»¥æœ‰æ•ˆå‡å°‘ä»å¤´è®¡ç®—çš„æ¬¡æ•°ï¼Œä»æ•´ä½“ä¸Šæå‡ä½œä¸šç«¯åˆ°ç«¯çš„æ‰§è¡Œæ€§èƒ½ã€‚</p><p>è€Œè¦è¯´èµ·Shuffleä¸­é—´æ–‡ä»¶ï¼Œæˆ‘ä»¬å°±ä¸å¾—ä¸æShuffleè¿™ä¸ªè¯é¢˜ã€‚åœ¨å¾ˆå¤šåœºæ™¯ä¸­ï¼ŒShuffleéƒ½æ‰®æ¼”ç€æ€§èƒ½ç“¶é¢ˆçš„è§’è‰²ï¼Œè§£å†³æ‰Shuffleå¼•å…¥çš„é—®é¢˜ä¹‹åï¼Œæ‰§è¡Œæ€§èƒ½å¾€å¾€èƒ½æœ‰ç«‹ç«¿è§å½±çš„æå‡ã€‚å› æ­¤ï¼Œå‡¡æ˜¯ä¸Shuffleæœ‰å…³çš„ç¯èŠ‚ï¼Œä½ éƒ½éœ€è¦æ ¼å¤–åœ°é‡è§†ã€‚</p><!-- [[[read_end]]] --><p>å…³äºShuffleçš„å·¥ä½œåŸç†ï¼Œæˆ‘ä»¬åé¢ä¼šè¯¦ç»†æ¥è®²ã€‚è¿™é‡Œï¼Œå’±ä»¬å…ˆç®€å•ç†è§£ä¸€ä¸‹Shuffleçš„è®¡ç®—è¿‡ç¨‹å°±å¯ä»¥äº†ã€‚å®ƒçš„è®¡ç®—è¿‡ç¨‹å¯ä»¥åˆ†ä¸º2ä¸ªé˜¶æ®µï¼š</p><ul>\n<li><strong>Mapé˜¶æ®µ</strong>ï¼šShuffle writeræŒ‰ç…§Reducerçš„åˆ†åŒºè§„åˆ™å°†ä¸­é—´æ•°æ®å†™å…¥æœ¬åœ°ç£ç›˜ï¼›</li>\n<li><strong>Reduce é˜¶æ®µ</strong>ï¼šShuffle readerä»å„ä¸ªèŠ‚ç‚¹ä¸‹è½½æ•°æ®åˆ†ç‰‡ï¼Œå¹¶æ ¹æ®éœ€è¦è¿›è¡Œèšåˆè®¡ç®—ã€‚</li>\n</ul><p>Shuffleä¸­é—´æ–‡ä»¶å®é™…ä¸Šå°±æ˜¯Shuffle Mapé˜¶æ®µçš„è¾“å‡ºç»“æœï¼Œè¿™äº›ç»“æœä¼šä»¥æ–‡ä»¶çš„å½¢å¼æš‚å­˜äºæœ¬åœ°ç£ç›˜ã€‚åœ¨Shuffle Reduceé˜¶æ®µï¼ŒReduceré€šè¿‡ç½‘ç»œæ‹‰å–è¿™äº›ä¸­é—´æ–‡ä»¶ç”¨äºèšåˆè®¡ç®—ï¼Œå¦‚æ±‚å’Œã€è®¡æ•°ç­‰ã€‚åœ¨é›†ç¾¤èŒƒå›´å†…ï¼ŒReduceræƒ³è¦æ‹‰å–å±äºè‡ªå·±çš„é‚£éƒ¨åˆ†ä¸­é—´æ•°æ®ï¼Œå°±å¿…é¡»è¦çŸ¥é“è¿™äº›æ•°æ®éƒ½å­˜å‚¨åœ¨å“ªäº›èŠ‚ç‚¹ï¼Œä»¥åŠä»€ä¹ˆä½ç½®ã€‚è€Œè¿™äº›å…³é”®çš„å…ƒä¿¡æ¯ï¼Œæ­£æ˜¯ç”±Sparkå­˜å‚¨ç³»ç»Ÿä¿å­˜å¹¶ç»´æŠ¤çš„ã€‚å› æ­¤ä½ çœ‹ï¼Œ<strong>æ²¡æœ‰å­˜å‚¨ç³»ç»Ÿï¼ŒShuffleæ˜¯ç©ä¸è½¬çš„ã€‚</strong></p><p>æœ€åï¼Œæˆ‘ä»¬å†æ¥è¯´è¯´å¹¿æ’­å˜é‡ã€‚åœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œå¹¿æ’­å˜é‡å¾€å¾€ç”¨äºåœ¨é›†ç¾¤èŒƒå›´å†…åˆ†å‘è®¿é—®é¢‘ç‡è¾ƒé«˜çš„å°æ•°æ®ã€‚<strong>åˆ©ç”¨å­˜å‚¨ç³»ç»Ÿï¼Œå¹¿æ’­å˜é‡å¯ä»¥åœ¨Executorsè¿›ç¨‹èŒƒç•´å†…ä¿å­˜å…¨é‡æ•°æ®ã€‚</strong>è¿™æ ·ä¸€æ¥ï¼Œå¯¹äºåŒä¸€Executorså†…çš„æ‰€æœ‰è®¡ç®—ä»»åŠ¡ï¼Œåº”ç”¨å°±èƒ½å¤Ÿä»¥Process localçš„æœ¬åœ°æ€§çº§åˆ«ï¼Œæ¥å…±äº«å¹¿æ’­å˜é‡ä¸­æºå¸¦çš„å…¨é‡æ•°æ®äº†ã€‚</p><p>æ€»çš„æ¥è¯´ï¼Œ<strong>è¿™3ä¸ªæœåŠ¡å¯¹è±¡æ˜¯Sparkåº”ç”¨æ€§èƒ½è°ƒä¼˜çš„æœ‰åŠ›â€œæŠ“æ‰‹â€ï¼Œè€Œå®ƒä»¬åˆå’Œå­˜å‚¨ç³»ç»Ÿæœ‰ç€å¯†åˆ‡çš„è”ç³»ï¼Œå› æ­¤æƒ³è¦æœ‰æ•ˆè¿ç”¨è¿™3ä¸ªæ–¹é¢çš„è°ƒä¼˜æŠ€å·§ï¼Œæˆ‘ä»¬å°±å¿…é¡»è¦å¯¹å­˜å‚¨ç³»ç»Ÿæœ‰è¶³å¤Ÿçš„ç†è§£ã€‚</strong></p><h2>å­˜å‚¨ç³»ç»Ÿçš„åŸºæœ¬ç»„ä»¶æœ‰å“ªäº›ï¼Ÿ</h2><p>ä¸è°ƒåº¦ç³»ç»Ÿç±»ä¼¼ï¼ŒSparkå­˜å‚¨ç³»ç»Ÿæ˜¯ä¸€ä¸ªå›Šæ‹¬äº†ä¼—å¤šç»„ä»¶çš„å¤åˆç³»ç»Ÿï¼Œå¦‚BlockManagerã€BlockManagerMasterã€MemoryStoreã€DiskStoreå’ŒDiskBlockManagerç­‰ç­‰ã€‚</p><p>ä¸è¿‡ï¼Œå®¶æœ‰åƒå£ã€ä¸»äº‹ä¸€äººï¼Œ<strong>BlockManageræ˜¯å…¶ä¸­æœ€ä¸ºé‡è¦çš„ç»„ä»¶ï¼Œå®ƒåœ¨Executorsç«¯è´Ÿè´£ç»Ÿä¸€ç®¡ç†å’Œåè°ƒæ•°æ®çš„æœ¬åœ°å­˜å–ä¸è·¨èŠ‚ç‚¹ä¼ è¾“</strong>ã€‚è¿™æ€ä¹ˆç†è§£å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥ä»2æ–¹é¢æ¥çœ‹ã€‚</p><ul>\n<li>\n<p>å¯¹å¤–ï¼ŒBlockManagerä¸Driverç«¯çš„BlockManagerMasteré€šä¿¡ï¼Œä¸ä»…å®šæœŸå‘BlockManagerMasteræ±‡æŠ¥æœ¬åœ°æ•°æ®å…ƒä¿¡æ¯ï¼Œè¿˜ä¼šä¸å®šæ—¶æŒ‰éœ€æ‹‰å–å…¨å±€æ•°æ®å­˜å‚¨çŠ¶æ€ã€‚å¦å¤–ï¼Œä¸åŒExecutorsçš„BlockManagerä¹‹é—´ä¹Ÿä¼šä»¥Server/Clientæ¨¡å¼è·¨èŠ‚ç‚¹æ¨é€å’Œæ‹‰å–æ•°æ®å—ã€‚</p>\n</li>\n<li>\n<p>å¯¹å†…ï¼ŒBlockManageré€šè¿‡ç»„åˆå­˜å‚¨ç³»ç»Ÿå†…éƒ¨ç»„ä»¶çš„åŠŸèƒ½æ¥å®ç°æ•°æ®çš„å­˜ä¸å–ã€æ”¶ä¸å‘ã€‚</p>\n</li>\n</ul><p>é‚£ä¹ˆï¼Œå¯¹äºRDDç¼“å­˜ã€Shuffleä¸­é—´æ–‡ä»¶å’Œå¹¿æ’­å˜é‡è¿™3ä¸ªæœåŠ¡å¯¹è±¡æ¥è¯´ï¼ŒBlockManageråˆæ˜¯å¦‚ä½•å­˜å‚¨çš„å‘¢ï¼Ÿ<strong>Sparkå­˜å‚¨ç³»ç»Ÿæä¾›äº†ä¸¤ç§å­˜å‚¨æŠ½è±¡ï¼šMemoryStoreå’ŒDiskStoreã€‚BlockManageræ­£æ˜¯åˆ©ç”¨å®ƒä»¬æ¥åˆ†åˆ«ç®¡ç†æ•°æ®åœ¨å†…å­˜å’Œç£ç›˜ä¸­çš„å­˜å–ã€‚</strong></p><p>å…¶ä¸­ï¼Œå¹¿æ’­å˜é‡çš„å…¨é‡æ•°æ®å­˜å‚¨åœ¨Executorsè¿›ç¨‹ä¸­ï¼Œå› æ­¤å®ƒç”±MemoryStoreç®¡ç†ã€‚Shuffleä¸­é—´æ–‡ä»¶å¾€å¾€ä¼šè½ç›˜åˆ°æœ¬åœ°èŠ‚ç‚¹ï¼Œæ‰€ä»¥è¿™äº›æ–‡ä»¶çš„è½ç›˜å’Œè®¿é—®å°±è¦ç»ç”±DiskStoreã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼ŒRDDç¼“å­˜ä¼šç¨å¾®å¤æ‚ä¸€äº›ï¼Œç”±äºRDDç¼“å­˜æ”¯æŒå†…å­˜ç¼“å­˜å’Œç£ç›˜ç¼“å­˜ä¸¤ç§æ¨¡å¼ï¼Œå› æ­¤æˆ‘ä»¬è¦è§†æƒ…å†µè€Œå®šï¼Œç¼“å­˜åœ¨å†…å­˜ä¸­çš„æ•°æ®ä¼šå°è£…åˆ°MemoryStoreï¼Œç¼“å­˜åœ¨ç£ç›˜ä¸Šçš„æ•°æ®åˆ™äº¤ç”±DiskStoreç®¡ç†ã€‚</p><p>æœ‰äº†MemoryStoreå’ŒDiskStoreï¼Œæˆ‘ä»¬æš‚æ—¶è§£å†³äº†æ•°æ®â€œå­˜åœ¨å“ªå„¿â€çš„é—®é¢˜ã€‚ä½†æ˜¯ï¼Œè¿™äº›æ•°æ®è¯¥ä»¥â€œä»€ä¹ˆå½¢å¼â€å­˜å‚¨åˆ°MemoryStoreå’ŒDiskStoreå‘¢ï¼Ÿ<strong>å¯¹äºæ•°æ®çš„å­˜å‚¨å½¢å¼ï¼ŒSparkå­˜å‚¨ç³»ç»Ÿæ”¯æŒä¸¤ç§ç±»å‹ï¼šå¯¹è±¡å€¼ï¼ˆObject Valuesï¼‰å’Œå­—èŠ‚æ•°ç»„ï¼ˆByte Arrayï¼‰</strong>ã€‚å®ƒä»¬ä¹‹é—´å¯ä»¥ç›¸äº’è½¬æ¢ï¼Œå…¶ä¸­ï¼Œå¯¹è±¡å€¼å‹ç¼©ä¸ºå­—èŠ‚æ•°ç»„çš„è¿‡ç¨‹å«åšåºåˆ—åŒ–ï¼Œè€Œå­—èŠ‚æ•°ç»„è¿˜åŸæˆåŸå§‹å¯¹è±¡å€¼çš„è¿‡ç¨‹å°±å«åšååºåˆ—åŒ–ã€‚</p><p>å½¢è±¡ç‚¹æ¥è¯´ï¼Œåºåˆ—åŒ–çš„å­—èŠ‚æ•°ç»„å°±åƒæ˜¯ä»å®œå®¶å®¶å…·è¶…å¸‚è´­ä¹°çš„å¾…ç»„è£…æ¿æï¼Œå¯¹è±¡å€¼åˆ™æ˜¯å°†æ¿ææ ¹æ®è¯´æ˜ä¹¦ç»„è£…è€Œæˆçš„å„ç§æ¡Œæ¤…æ¿å‡³ã€‚æ˜¾è€Œæ˜“è§ï¼Œå¯¹è±¡å€¼è¿™ç§å­˜å‚¨å½¢å¼çš„ä¼˜ç‚¹æ˜¯æ‹¿æ¥å³ç”¨ã€æ‰€è§å³æ‰€å¾—ï¼Œç¼ºç‚¹æ˜¯æ‰€éœ€çš„å­˜å‚¨ç©ºé—´è¾ƒå¤§ã€å åœ°å„¿ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œåºåˆ—åŒ–å­—èŠ‚æ•°ç»„çš„ç©ºé—´åˆ©ç”¨ç‡è¦é«˜å¾—å¤šã€‚ä¸è¿‡è¦æ˜¯ä½ ç€æ€¥è®¿é—®é‡Œé¢çš„æ•°æ®å¯¹è±¡ï¼Œè¿˜å¾—è¿›è¡Œååºåˆ—åŒ–ï¼Œæœ‰ç‚¹éº»çƒ¦ã€‚</p><p><strong>ç”±æ­¤å¯è§ï¼Œå¯¹è±¡å€¼å’Œå­—èŠ‚æ•°ç»„äºŒè€…ä¹‹é—´å­˜åœ¨ç€ä¸€ç§åšå¼ˆå…³ç³»ï¼Œ</strong>ä¹Ÿå°±æ˜¯æ‰€è°“çš„â€œä»¥ç©ºé—´æ¢æ—¶é—´â€å’Œâ€œä»¥æ—¶é—´æ¢ç©ºé—´â€ï¼Œä¸¤è€…ä¹‹é—´è¯¥å¦‚ä½•å–èˆï¼Œæˆ‘ä»¬è¿˜æ˜¯è¦çœ‹å…·ä½“çš„åº”ç”¨åœºæ™¯ã€‚<strong>æ ¸å¿ƒåŸåˆ™å°±æ˜¯ï¼šå¦‚æœæƒ³çœåœ°å„¿ï¼Œä½ å¯ä»¥ä¼˜å…ˆè€ƒè™‘å­—èŠ‚æ•°ç»„ï¼›å¦‚æœæƒ³ä»¥æœ€å¿«çš„é€Ÿåº¦è®¿é—®å¯¹è±¡ï¼Œè¿˜æ˜¯å¯¹è±¡å€¼æ›´ç›´æ¥ä¸€äº›ã€‚</strong> ä¸è¿‡ï¼Œè¿™ç§é€‰æ‹©çš„çƒ¦æ¼åªå­˜åœ¨äº MemoryStore ä¹‹ä¸­ï¼Œè€ŒDiskStoreåªèƒ½å­˜å‚¨åºåˆ—åŒ–åçš„å­—èŠ‚æ•°ç»„ï¼Œæ¯•ç«Ÿï¼Œå‡¡æ˜¯è½ç›˜çš„ä¸œè¥¿ï¼Œéƒ½éœ€è¦å…ˆè¿›è¡Œåºåˆ—åŒ–ã€‚</p><h2>é€è¿‡RDDç¼“å­˜çœ‹MemoryStore</h2><p>çŸ¥é“äº†å­˜å‚¨ç³»ç»Ÿæœ‰å“ªäº›æ ¸å¿ƒçš„ç»„ä»¶ï¼Œä¸‹é¢ï¼Œæˆ‘ä»¬æ¥ç€æ¥è¯´è¯´MemoryStoreå’ŒDiskStoreè¿™ä¸¤ä¸ªç»„ä»¶æ˜¯æ€ä¹ˆç®¡ç†å†…å­˜å’Œç£ç›˜æ•°æ®çš„ã€‚</p><p>åˆšåˆšæˆ‘ä»¬æåˆ°ï¼Œ<strong>MemoryStoreåŒæ—¶æ”¯æŒå­˜å‚¨å¯¹è±¡å€¼å’Œå­—èŠ‚æ•°ç»„è¿™ä¸¤ç§ä¸åŒçš„æ•°æ®å½¢å¼ï¼Œå¹¶ä¸”ç»Ÿä¸€é‡‡ç”¨MemoryEntryæ•°æ®æŠ½è±¡å¯¹å®ƒä»¬è¿›è¡Œå°è£…</strong>ã€‚</p><p>MemoryEntryæœ‰ä¸¤ä¸ªå®ç°ç±»ï¼šDeserializedMemoryEntryå’ŒSerializedMemoryEntryï¼Œåˆ†åˆ«ç”¨äºå°è£…åŸå§‹å¯¹è±¡å€¼å’Œåºåˆ—åŒ–ä¹‹åçš„å­—èŠ‚æ•°ç»„ã€‚DeserializedMemoryEntryç”¨ Array[T]æ¥å­˜å‚¨å¯¹è±¡å€¼åºåˆ—ï¼Œå…¶ä¸­Tæ˜¯å¯¹è±¡ç±»å‹ï¼Œè€ŒSerializedMemoryEntryä½¿ç”¨ByteBufferæ¥å­˜å‚¨åºåˆ—åŒ–åçš„å­—èŠ‚åºåˆ—ã€‚</p><p>å¾—ç›ŠäºMemoryEntryå¯¹äºå¯¹è±¡å€¼å’Œå­—èŠ‚æ•°ç»„çš„ç»Ÿä¸€å°è£…ï¼ŒMemoryStoreèƒ½å¤Ÿå€ŸåŠ©ä¸€ç§é«˜æ•ˆçš„æ•°æ®ç»“æ„æ¥ç»Ÿä¸€å­˜å‚¨ä¸è®¿é—®æ•°æ®å—ï¼šLinkedHashMap[BlockId, MemoryEntry]ï¼Œå³ Key ä¸ºBlockIdï¼ŒValue æ˜¯MemoryEntryçš„é“¾å¼å“ˆå¸Œå­—å…¸ã€‚åœ¨è¿™ä¸ªå­—å…¸ä¸­ï¼Œä¸€ä¸ªBlockå¯¹åº”ä¸€ä¸ªMemoryEntryã€‚æ˜¾ç„¶ï¼Œè¿™é‡Œçš„MemoryEntryæ—¢å¯ä»¥æ˜¯DeserializedMemoryEntryï¼Œä¹Ÿå¯ä»¥æ˜¯ SerializedMemoryEntryã€‚æœ‰äº†è¿™ä¸ªå­—å…¸ï¼Œæˆ‘ä»¬é€šè¿‡BlockIdå³å¯æ–¹ä¾¿åœ°æŸ¥æ‰¾å’Œå®šä½MemoryEntryï¼Œå®ç°æ•°æ®å—çš„å¿«é€Ÿå­˜å–ã€‚</p><p>æ¦‚å¿µè¿™ä¹ˆå¤šï¼Œå‘½åä¹Ÿè¿™ä¹ˆç›¸ä¼¼ï¼Œæ˜¯ä¸æ˜¯çœ‹èµ·æ¥å°±è®©äººâ€œå¤´å¤§â€ï¼Ÿåˆ«ç€æ€¥ï¼Œæ¥ä¸‹æ¥ï¼Œå’±ä»¬ä»¥RDDç¼“å­˜ä¸ºä¾‹ï¼Œæ¥çœ‹çœ‹å­˜å‚¨ç³»ç»Ÿæ˜¯å¦‚ä½•åˆ©ç”¨è¿™äº›æ•°æ®ç»“æ„ï¼ŒæŠŠRDDå°è£…çš„æ•°æ®å®ä½“ç¼“å­˜åˆ°å†…å­˜é‡Œå»ã€‚</p><p>åœ¨RDDçš„è¯­å¢ƒä¸‹ï¼Œæˆ‘ä»¬å¾€å¾€ç”¨æ•°æ®åˆ†ç‰‡ï¼ˆPartitions/Splitsï¼‰æ¥è¡¨ç¤ºä¸€ä»½åˆ†å¸ƒå¼æ•°æ®ï¼Œä½†åœ¨å­˜å‚¨ç³»ç»Ÿçš„è¯­å¢ƒä¸‹ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šç”¨æ•°æ®å—ï¼ˆBlocksï¼‰æ¥è¡¨ç¤ºæ•°æ®å­˜å‚¨çš„åŸºæœ¬å•å…ƒã€‚<strong>åœ¨é€»è¾‘å…³ç³»ä¸Šï¼ŒRDDçš„æ•°æ®åˆ†ç‰‡ä¸å­˜å‚¨ç³»ç»Ÿçš„Blockä¸€ä¸€å¯¹åº”ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªRDDæ•°æ®åˆ†ç‰‡ä¼šè¢«ç‰©åŒ–æˆä¸€ä¸ªå†…å­˜æˆ–ç£ç›˜ä¸Šçš„Blockã€‚</strong></p><p>å› æ­¤ï¼Œå¦‚æœç”¨ä¸€å¥è¯æ¥æ¦‚æ‹¬ç¼“å­˜RDDçš„è¿‡ç¨‹ï¼Œå°±æ˜¯å°†RDDè®¡ç®—æ•°æ®çš„è¿­ä»£å™¨ï¼ˆIteratorï¼‰è¿›è¡Œç‰©åŒ–çš„è¿‡ç¨‹ï¼Œæµç¨‹å¦‚ä¸‹æ‰€ç¤ºã€‚å…·ä½“æ¥è¯´ï¼Œå¯ä»¥åˆ†æˆä¸‰æ­¥èµ°ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/1y/0b/1yy5fd9f111f4cab0edc7cf582bd2b0b.jpg?wh=4326*1359\" alt=\"\" title=\"åˆ©ç”¨MemoryStoreåœ¨å†…å­˜ä¸­ç¼“å­˜RDDæ•°æ®å†…å®¹\"></p><p>æ—¢ç„¶è¦æŠŠæ•°æ®å†…å®¹ç¼“å­˜ä¸‹æ¥ï¼Œè‡ªç„¶å¾—å…ˆæŠŠRDDçš„è¿­ä»£å™¨å±•å¼€æˆå®å®åœ¨åœ¨çš„æ•°æ®å€¼æ‰è¡Œã€‚å› æ­¤ï¼Œ<strong>ç¬¬ä¸€æ­¥å°±æ˜¯é€šè¿‡è°ƒç”¨putIteratorAsValuesæˆ–æ˜¯putIteratorAsBytesæ–¹æ³•ï¼ŒæŠŠRDDè¿­ä»£å™¨å±•å¼€ä¸ºæ•°æ®å€¼ï¼Œç„¶åæŠŠè¿™äº›æ•°æ®å€¼æš‚å­˜åˆ°ä¸€ä¸ªå«åšValuesHolderçš„æ•°æ®ç»“æ„é‡Œã€‚</strong>è¿™ä¸€æ­¥ï¼Œæˆ‘ä»¬é€šå¸¸æŠŠå®ƒå«åšâ€œUnrollâ€ã€‚</p><p><strong>ç¬¬äºŒæ­¥ï¼Œä¸ºäº†èŠ‚çœå†…å­˜å¼€é”€ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å­˜å‚¨æ•°æ®å€¼çš„ValuesHolderä¸Šç›´æ¥è°ƒç”¨toArrayæˆ–æ˜¯toByteBufferæ“ä½œï¼ŒæŠŠValuesHolderè½¬æ¢ä¸ºMemoryEntryæ•°æ®ç»“æ„ã€‚</strong>æ³¨æ„å•¦ï¼Œè¿™ä¸€æ­¥çš„è½¬æ¢ä¸æ¶‰åŠå†…å­˜æ‹·è´ï¼Œä¹Ÿä¸äº§ç”Ÿé¢å¤–çš„å†…å­˜å¼€é”€ï¼Œå› æ­¤Sparkå®˜æ–¹æŠŠè¿™ä¸€æ­¥å«åšâ€œä»Unroll memoryåˆ°Storage memoryçš„Transferï¼ˆè½¬ç§»ï¼‰â€ã€‚</p><p><strong>ç¬¬ä¸‰æ­¥ï¼Œè¿™äº›åŒ…å«RDDæ•°æ®å€¼çš„MemoryEntryå’Œä¸ä¹‹å¯¹åº”çš„BlockIdï¼Œä¼šè¢«ä¸€èµ·å­˜å…¥Key ä¸ºBlockIdã€Value æ˜¯MemoryEntryå¼•ç”¨çš„é“¾å¼å“ˆå¸Œå­—å…¸ä¸­ã€‚</strong>å› æ­¤ï¼ŒLinkedHashMap[BlockId, MemoryEntry]ç¼“å­˜çš„æ˜¯å…³äºæ•°æ®å­˜å‚¨çš„å…ƒæ•°æ®ï¼ŒMemoryEntryæ‰æ˜¯çœŸæ­£ä¿å­˜RDDæ•°æ®å®ä½“çš„å­˜å‚¨å•å…ƒã€‚æ¢å¥è¯è¯´ï¼Œå¤§é¢ç§¯å ç”¨å†…å­˜çš„ä¸æ˜¯å“ˆå¸Œå­—å…¸ï¼Œè€Œæ˜¯ä¸€ä¸ªåˆä¸€ä¸ªçš„MemoryEntryã€‚</p><p>æ€»çš„æ¥è¯´ï¼ŒRDDæ•°æ®åˆ†ç‰‡ã€Blockå’ŒMemoryEntryä¸‰è€…ä¹‹é—´æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œå½“æ‰€æœ‰çš„RDDæ•°æ®åˆ†ç‰‡éƒ½ç‰©åŒ–ä¸ºMemoryEntryï¼Œå¹¶ä¸”æ‰€æœ‰çš„ï¼ˆBlock ID, MemoryEntryï¼‰å¯¹éƒ½è®°å½•åˆ°LinkedHashMapå­—å…¸ä¹‹åï¼ŒRDDå°±å®Œæˆäº†æ•°æ®ç¼“å­˜åˆ°å†…å­˜çš„è¿‡ç¨‹ã€‚</p><p>è¿™é‡Œï¼Œä½ å¯èƒ½ä¼šé—®ï¼šâ€œå¦‚æœå†…å­˜ç©ºé—´ä¸è¶³ä»¥å®¹çº³æ•´ä¸ªRDDæ€ä¹ˆåŠï¼Ÿâ€å¾ˆç®€å•ï¼Œå¼ºè¡ŒæŠŠå¤§RDDå¡è¿›æœ‰é™çš„å†…å­˜ç©ºé—´è‚¯å®šä¸æ˜¯æ˜æ™ºä¹‹ä¸¾ï¼Œæ‰€ä»¥Sparkä¼šæŒ‰ç…§LRUç­–ç•¥é€ä¸€æ¸…é™¤å­—å…¸ä¸­æœ€è¿‘ã€æœ€ä¹…æœªä½¿ç”¨çš„Blockï¼Œä»¥åŠå…¶å¯¹åº”çš„MemoryEntryã€‚ç›¸æ¯”é¢‘ç¹çš„å±•å¼€ã€ç‰©åŒ–ã€æ¢é¡µæ‰€å¸¦æ¥çš„æ€§èƒ½å¼€é”€ï¼Œç¼“å­˜ä¸‹æ¥çš„éƒ¨åˆ†æ•°æ®å¯¹äºRDDé«˜æ•ˆè®¿é—®çš„è´¡çŒ®å¯ä»¥è¯´å¾®ä¹å…¶å¾®ã€‚</p><h2>é€è¿‡Shuffleçœ‹DiskStore</h2><p>ç›¸æ¯”MemoryStoreï¼ŒDiskStoreå°±ç›¸å¯¹ç®€å•å¾ˆå¤šï¼Œå› ä¸ºå®ƒå¹¶ä¸éœ€è¦é‚£ä¹ˆå¤šçš„ä¸­é—´æ•°æ®ç»“æ„æ‰èƒ½å®Œæˆæ•°æ®çš„å­˜å–ã€‚<strong>DiskStoreä¸­æ•°æ®çš„å­˜å–æœ¬è´¨ä¸Šå°±æ˜¯å­—èŠ‚åºåˆ—ä¸ç£ç›˜æ–‡ä»¶ä¹‹é—´çš„è½¬æ¢</strong>ï¼Œå®ƒé€šè¿‡putBytesæ–¹æ³•æŠŠå­—èŠ‚åºåˆ—å­˜å…¥ç£ç›˜æ–‡ä»¶ï¼Œå†é€šè¿‡getBytesæ–¹æ³•å°†æ–‡ä»¶å†…å®¹è½¬æ¢ä¸ºæ•°æ®å—ã€‚</p><p>ä¸è¿‡ï¼Œè¦æƒ³å®Œæˆä¸¤è€…ä¹‹é—´çš„è½¬æ¢ï¼Œåƒæ•°æ®å—ä¸æ–‡ä»¶çš„å¯¹åº”å…³ç³»ã€æ–‡ä»¶è·¯å¾„ç­‰ç­‰è¿™äº›å…ƒæ•°æ®æ˜¯å¿…ä¸å¯å°‘çš„ã€‚MemoryStoreé‡‡ç”¨é“¾å¼å“ˆå¸Œå­—å…¸æ¥ç»´æŠ¤ç±»ä¼¼çš„å…ƒæ•°æ®ï¼ŒDiskStoreè¿™ä¸ªç‹¡çŒ¾çš„å®¶ä¼™å¹¶æ²¡æœ‰äº²è‡ªç»´æŠ¤è¿™äº›å…ƒæ•°æ®ï¼Œè€Œæ˜¯è¯·äº†DiskBlockManagerè¿™ä¸ªç»™åŠ›çš„å¸®æ‰‹ã€‚</p><p><strong>DiskBlockManagerçš„ä¸»è¦èŒè´£å°±æ˜¯ï¼Œè®°å½•é€»è¾‘æ•°æ®å—Blockä¸ç£ç›˜æ–‡ä»¶ç³»ç»Ÿä¸­ç‰©ç†æ–‡ä»¶çš„å¯¹åº”å…³ç³»ï¼Œæ¯ä¸ªBlockéƒ½å¯¹åº”ä¸€ä¸ªç£ç›˜æ–‡ä»¶ã€‚</strong>åŒç†ï¼Œæ¯ä¸ªç£ç›˜æ–‡ä»¶éƒ½æœ‰ä¸€ä¸ªä¸ä¹‹å¯¹åº”çš„Block IDï¼Œè¿™å°±å¥½æ¯”è´§æ¶ä¸Šçš„æ¯ä¸€ä»¶è´§ç‰©éƒ½æœ‰å”¯ä¸€çš„ ID æ ‡è¯†ã€‚</p><p>DiskBlockManageråœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œé¦–å…ˆæ ¹æ®é…ç½®é¡¹spark.local.diråœ¨ç£ç›˜çš„ç›¸åº”ä½ç½®åˆ›å»ºæ–‡ä»¶ç›®å½•ã€‚ç„¶åï¼Œåœ¨spark.local.diræŒ‡å®šçš„æ‰€æœ‰ç›®å½•ä¸‹åˆ†åˆ«åˆ›å»ºå­ç›®å½•ï¼Œå­ç›®å½•çš„ä¸ªæ•°ç”±é…ç½®é¡¹spark.diskStore.subDirectoriesæ§åˆ¶ï¼Œå®ƒé»˜è®¤æ˜¯64ã€‚æ‰€æœ‰è¿™äº›ç›®å½•å‡ç”¨äºå­˜å‚¨é€šè¿‡DiskStoreè¿›è¡Œç‰©åŒ–çš„æ•°æ®æ–‡ä»¶ï¼Œå¦‚RDDç¼“å­˜æ–‡ä»¶ã€Shuffleä¸­é—´ç»“æœæ–‡ä»¶ç­‰ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/1e/4f/1eccayy6d9b7348ceea3cf3b12913a4f.jpg?wh=2802*1711\" alt=\"\" title=\"DiskStore ä¸­æ•°æ®çš„å­˜ä¸å–\"></p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†ä»¥Shuffleä¸­é—´æ–‡ä»¶ä¸ºä¾‹ï¼Œæ¥è¯´è¯´DiskStoreä¸DiskBlockManagerçš„äº¤äº’è¿‡ç¨‹ã€‚</p><p><strong>Sparké»˜è®¤é‡‡ç”¨SortShuffleManageræ¥ç®¡ç†Stagesé—´çš„æ•°æ®åˆ†å‘ï¼Œåœ¨Shuffle writeè¿‡ç¨‹ä¸­ï¼Œæœ‰3ç±»ç»“æœæ–‡ä»¶ï¼štemp_shuffle_XXXã€shuffle_XXX.dataå’Œshuffle_XXX.indexã€‚</strong>Dataæ–‡ä»¶å­˜å‚¨åˆ†åŒºæ•°æ®ï¼Œå®ƒæ˜¯ç”±tempæ–‡ä»¶åˆå¹¶è€Œæ¥çš„ï¼Œè€Œindexæ–‡ä»¶è®°å½•dataæ–‡ä»¶å†…ä¸åŒåˆ†åŒºçš„åç§»åœ°å€ã€‚Shuffleä¸­é—´æ–‡ä»¶å…·ä½“æŒ‡çš„å°±æ˜¯dataæ–‡ä»¶å’Œindexæ–‡ä»¶ï¼Œtempæ–‡ä»¶ä½œä¸ºæš‚å­˜ç›˜æ–‡ä»¶æœ€ç»ˆä¼šè¢«åˆ é™¤ã€‚</p><p>åœ¨Shuffle writeçš„ä¸åŒé˜¶æ®µï¼ŒShuffle manageré€šè¿‡BlockManagerè°ƒç”¨DiskStoreçš„putBytesæ–¹æ³•å°†æ•°æ®å—å†™å…¥æ–‡ä»¶ã€‚æ–‡ä»¶ç”±DiskBlockManageråˆ›å»ºï¼Œæ–‡ä»¶åå°±æ˜¯putBytesæ–¹æ³•ä¸­çš„Block IDï¼Œè¿™äº›æ–‡ä»¶ä¼šä»¥â€œtemp_shuffleâ€æˆ–â€œshuffleâ€å¼€å¤´ï¼Œä¿å­˜åœ¨spark.local.dirç›®å½•ä¸‹çš„å­ç›®å½•é‡Œã€‚</p><p>åœ¨Shuffle readé˜¶æ®µï¼ŒShuffle managerå†æ¬¡é€šè¿‡BlockManagerè°ƒç”¨DiskStoreçš„getBytesæ–¹æ³•ï¼Œè¯»å–dataæ–‡ä»¶å’Œindexæ–‡ä»¶ï¼Œå°†æ–‡ä»¶å†…å®¹è½¬åŒ–ä¸ºæ•°æ®å—ï¼Œæœ€ç»ˆè¿™äº›æ•°æ®å—ä¼šé€šè¿‡ç½‘ç»œåˆ†å‘åˆ°Reducerç«¯è¿›è¡Œèšåˆè®¡ç®—ã€‚</p><h2>å°ç»“</h2><p>æŒæ¡å­˜å‚¨ç³»ç»Ÿæ˜¯æˆ‘ä»¬è¿›è¡ŒSparkæ€§èƒ½è°ƒä¼˜çš„å…³é”®ä¸€æ­¥ï¼Œæˆ‘ä»¬å¯ä»¥åˆ†ä¸ºä¸‰æ­¥æ¥æŒæ¡ã€‚</p><p>ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬è¦æ˜ç¡®å­˜å‚¨ç³»ç»Ÿçš„æœåŠ¡å¯¹è±¡ï¼Œåˆ†åˆ«æ˜¯RDDç¼“å­˜ã€Shuffleå’Œå¹¿æ’­å˜é‡ã€‚</p><ul>\n<li>RDDç¼“å­˜ï¼šä¸€äº›è®¡ç®—æˆæœ¬å’Œè®¿é—®é¢‘ç‡è¾ƒé«˜çš„RDDï¼Œå¯ä»¥ä»¥ç¼“å­˜çš„å½¢å¼ç‰©åŒ–åˆ°å†…å­˜æˆ–ç£ç›˜ä¸­ã€‚è¿™æ ·ä¸€æ¥ï¼Œæ—¢å¯ä»¥é¿å…DAGé¢‘ç¹å›æº¯çš„è®¡ç®—å¼€é”€ï¼Œä¹Ÿèƒ½æœ‰æ•ˆæå‡ç«¯åˆ°ç«¯çš„æ‰§è¡Œæ€§èƒ½</li>\n<li>Shuffleï¼šShuffleä¸­é—´æ–‡ä»¶çš„ä½ç½®ä¿¡æ¯ï¼Œéƒ½æ˜¯ç”±Sparkå­˜å‚¨ç³»ç»Ÿä¿å­˜å¹¶ç»´æŠ¤çš„ï¼Œæ²¡æœ‰å­˜å‚¨ç³»ç»Ÿï¼ŒShuffleæ˜¯ç©ä¸è½¬çš„</li>\n<li>å¹¿æ’­å˜é‡ï¼šåˆ©ç”¨å­˜å‚¨ç³»ç»Ÿï¼Œå¹¿æ’­å˜é‡å¯ä»¥åœ¨Executorsè¿›ç¨‹èŒƒç•´å†…ä¿å­˜å…¨é‡æ•°æ®ï¼Œè®©ä»»åŠ¡ä»¥Process localçš„æœ¬åœ°æ€§çº§åˆ«ï¼Œæ¥å…±äº«å¹¿æ’­å˜é‡ä¸­æºå¸¦çš„å…¨é‡æ•°æ®ã€‚</li>\n</ul><p>ç¬¬äºŒæ­¥ï¼Œæˆ‘ä»¬è¦ææ¸…æ¥šå­˜å‚¨ç³»ç»Ÿçš„ä¸¤ä¸ªé‡è¦ç»„ä»¶ï¼šMemoryStoreå’ŒDiskStoreã€‚å…¶ä¸­ï¼ŒMemoryStoreç”¨æ¥ç®¡ç†æ•°æ®åœ¨å†…å­˜ä¸­çš„å­˜å–ï¼ŒDiskStoreç”¨æ¥ç®¡ç†æ•°æ®åœ¨ç£ç›˜ä¸­çš„å­˜å–ã€‚</p><p>å¯¹äºå­˜å‚¨ç³»ç»Ÿçš„3ä¸ªæœåŠ¡å¯¹è±¡æ¥è¯´ï¼Œå¹¿æ’­å˜é‡ç”±MemoryStoreç®¡ç†ï¼ŒShuffleä¸­é—´æ–‡ä»¶çš„è½ç›˜å’Œè®¿é—®è¦ç»ç”±DiskStoreï¼Œè€ŒRDDç¼“å­˜å› ä¸ºä¼šåŒæ—¶æ”¯æŒå†…å­˜ç¼“å­˜å’Œç£ç›˜ç¼“å­˜ä¸¤ç§æ¨¡å¼ï¼Œæ‰€ä»¥ä¸¤ç§ç»„ä»¶éƒ½æœ‰å¯èƒ½ç”¨åˆ°ã€‚</p><p>æœ€åï¼Œæˆ‘ä»¬è¦ç†è§£MemoryStoreå’ŒDiskStoreçš„å·¥ä½œåŸç†ã€‚</p><p>MemoryStoreæ”¯æŒå¯¹è±¡å€¼å’Œå­—èŠ‚æ•°ç»„ï¼Œç»Ÿä¸€é‡‡ç”¨MemoryEntryæ•°æ®æŠ½è±¡å¯¹å®ƒä»¬è¿›è¡Œå°è£…ã€‚å¯¹è±¡å€¼å’Œå­—èŠ‚æ•°ç»„äºŒè€…ä¹‹é—´å­˜åœ¨ç€ä¸€ç§åšå¼ˆå…³ç³»ï¼Œæ‰€è°“çš„â€œä»¥ç©ºé—´æ¢æ—¶é—´â€å’Œâ€œä»¥æ—¶é—´æ¢ç©ºé—´â€ï¼Œä¸¤è€…çš„å–èˆè¿˜è¦çœ‹å…·ä½“çš„åº”ç”¨åœºæ™¯ã€‚</p><p>DiskStoreåˆ™åˆ©ç”¨DiskBlockManagerç»´æŠ¤çš„æ•°æ®å—ä¸ç£ç›˜æ–‡ä»¶çš„å¯¹åº”å…³ç³»ï¼Œæ¥å®Œæˆå­—èŠ‚åºåˆ—ä¸ç£ç›˜æ–‡ä»¶ä¹‹é—´çš„è½¬æ¢ã€‚</p><h2>æ¯æ—¥ä¸€ç»ƒ</h2><ol>\n<li>ç»“åˆRDDæ•°æ®å­˜å‚¨åˆ°MemoryStoreçš„è¿‡ç¨‹ï¼Œä½ èƒ½æ¨æ¼”å‡ºé€šè¿‡MemoryStoreé€šè¿‡getValues/getBytesæ–¹æ³•å»è®¿é—®RDDç¼“å­˜å†…å®¹çš„è¿‡ç¨‹å—ï¼Ÿ</li>\n<li>å‚è€ƒRDDç¼“å­˜å­˜å‚¨çš„è¿‡ç¨‹ï¼Œä½ èƒ½æ¨æ¼”å‡ºå¹¿æ’­å˜é‡å­˜å…¥MemoryStoreçš„æµç¨‹å—ï¼Ÿ</li>\n</ol><p>æœŸå¾…åœ¨ç•™è¨€åŒºçœ‹åˆ°ä½ çš„æ€è€ƒå’Œè®¨è®ºï¼Œæˆ‘ä»¬ä¸‹ä¸€è®²è§ï¼</p>","comments":[{"had_liked":false,"id":285438,"user_name":"Shockang","can_delete":false,"product_type":"c1","uid":1263546,"ip_address":"","ucode":"B871D731F6E6B1","user_header":"https://static001.geekbang.org/account/avatar/00/13/47/ba/d36340c1.jpg","comment_is_top":false,"comment_ctime":1616814029,"is_pvip":false,"replies":[{"id":"103598","content":"Shockè€å¼Ÿï¼Œä¸å¾—ä¸è¯´ï¼Œç®€ç›´å¤ªæ£’äº†ï¼Perfect x 2ï¼Œæ ‡å‡†ç­”æ¡ˆï¼Œå¤©è¡£æ— ç¼ï¼Œæ»¡åˆ†ğŸ’¯ï¼<br><br>ä»ç­”æ¡ˆèƒ½çœ‹å‡ºæ¥ï¼Œè¿™éƒ¨åˆ†æºç ä½ å·²ç»åƒçš„ç›¸å½“é€äº†ï¼Œå¤§èµï½ å’±ä»¬æœ‰è¯»è€…ç¾¤ï¼Œä¸çŸ¥é“ä½ åœ¨ä¸åœ¨é‡Œè¾¹ï¼ŒåŠ¡å¿…åŠ å…¥å•Šï¼è¯¦æƒ…é¡µæœ‰å…¥å£ï¼Œå®åœ¨æ‰¾ä¸åˆ°ï¼ŒåŠ æˆ‘å¾®ä¿¡å¥½å‹ï¼ŒæœrJuniorï¼Œæˆ–è€…â€œæ–¹å—Kâ€ï¼Œæˆ‘æŠŠä½ æ‹‰è¿›å»ï½","user_name":"ä½œè€…å›å¤","comment_id":285438,"uid":"1043100","ip_address":"","utype":1,"ctime":1616837255,"user_name_real":"å´ç£Š"}],"discussion_count":2,"race_medal":0,"score":"169120538573","product_id":100073401,"comment_content":"1.getBytes&#47;getValues çš„å®ç°éƒ½æ¯”è¾ƒç®€å•ï¼Œéƒ½æ˜¯å…ˆå¯¹LinkedHashMapåŠ é”ï¼Œé€šè¿‡blockIdå–å‡ºå¯¹åº”çš„MemoryEntryï¼Œç„¶åé€šè¿‡æ¨¡å¼åŒ¹é…ï¼ŒgetBytesè´Ÿè´£å¤„ç†åºåˆ—åŒ–çš„SerializedMemoryEntryï¼Œå¹¶è¿”å›Option[ChunkedByteBuffer]ï¼ŒChunkedByteBufferæ˜¯ä¸€ä¸ªåªè¯»å­—èŠ‚ç¼“å†²åŒºï¼Œç‰©ç†ä¸Šå­˜å‚¨ä¸ºå¤šä¸ªå—è€Œä¸æ˜¯å•ä¸ªè¿ç»­æ•°ç»„ï¼›getValuesè´Ÿè´£å¤„ç†å¯¹è±¡å€¼åºåˆ—DeserializedMemoryEntryï¼Œè¿”å›ä¸€ä¸ªIterator<br>2.æˆ‘å…ˆæè¿°ä¸‹è°ƒç”¨é“¾è·¯ï¼šTorrentBroadcast#writeBlocks -&gt; BlockManager#putBytes -&gt; BlockManager#save åˆ°è¿™ä¸€æ­¥ä¼šåˆ¤æ–­å­˜å‚¨çº§åˆ«ï¼Œå¦‚æœuseMemory&amp;&amp;deserializedï¼Œä¼šèµ°è¿™æ¡é“¾è·¯ï¼šBlockManager#saveDeserializedValuesToMemoryStore -&gt; MemoryStore#putIteratorAsValues -&gt; MemoryStore#putIteratorï¼Œè¿™ä¸€æ­¥å°è¯•å°†ç»™å®šçš„å—ä½œä¸ºå€¼æˆ–å­—èŠ‚æ”¾å…¥å†…å­˜å­˜å‚¨ã€‚ ä½†æ˜¯è¿­ä»£å™¨å¯èƒ½å¤ªå¤§ï¼Œæ— æ³•å…·ä½“åŒ–å¹¶å­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚ä¸ºäº†é¿å…OOMå¼‚å¸¸ï¼Œè¿™é‡Œä¼šé€æ¸å±•å¼€è¿­ä»£å™¨ï¼ŒåŒæ—¶å®šæœŸæ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„å¯ç”¨å†…å­˜ã€‚å¦‚æœå—è¢«æˆåŠŸç‰©åŒ–ï¼Œé‚£ä¹ˆç‰©åŒ–è¿‡ç¨‹ä¸­ä½¿ç”¨çš„ä¸´æ—¶å±•å¼€å†…å­˜å°±è¢«â€œè½¬ç§»â€åˆ°å­˜å‚¨å†…å­˜ä¸­ï¼›å†å›åˆ°ä¸Šé¢å­˜å‚¨çº§åˆ«çš„åˆ¤æ–­ï¼Œå¦‚æœä½¿ç”¨å†…å­˜å¹¶ä¸”åºåˆ—åŒ–ï¼Œåˆ™èµ°ä¸‹é¢çš„è°ƒç”¨é“¾è·¯ï¼šBlockManager#saveSerializedValuesToMemoryStore -&gt; MemoryStore#putBytesï¼Œè¿™é‡Œä¼šæµ‹è¯•MemoryStoreä¸­æ˜¯å¦æœ‰è¶³å¤Ÿçš„ç©ºé—´ã€‚å¦‚æœç©ºé—´è¶³å¤Ÿï¼Œåˆ™åˆ›å»ºByteBufferå¹¶å°†å…¶æ”¾å…¥MemoryStoreã€‚å¦åˆ™å°±ä¸ä¼šåˆ›å»ºByteBufferã€‚æœ€ç»ˆä¼šç”¨SerializedMemoryEntryå°† ByteBuffer å°è£…èµ·æ¥ï¼Œæ”¾åˆ°è€å¸ˆåœ¨æ–‡ä¸­æåˆ°çš„LinkedHashMapã€‚å¯æƒœæå®¢æ—¶é—´è¯„è®ºæ²¡åŠæ³•å‘å›¾ç‰‡ï¼Œä¸ç„¶è°ƒç”¨é“¾è·¯çœ‹èµ·æ¥ä¼šæ›´ç›´è§‚ã€‚","like_count":40,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":517675,"discussion_content":"Shockè€å¼Ÿï¼Œä¸å¾—ä¸è¯´ï¼Œç®€ç›´å¤ªæ£’äº†ï¼Perfect x 2ï¼Œæ ‡å‡†ç­”æ¡ˆï¼Œå¤©è¡£æ— ç¼ï¼Œæ»¡åˆ†ğŸ’¯ï¼\n\nä»ç­”æ¡ˆèƒ½çœ‹å‡ºæ¥ï¼Œè¿™éƒ¨åˆ†æºç ä½ å·²ç»åƒçš„ç›¸å½“é€äº†ï¼Œå¤§èµï½ å’±ä»¬æœ‰è¯»è€…ç¾¤ï¼Œä¸çŸ¥é“ä½ åœ¨ä¸åœ¨é‡Œè¾¹ï¼ŒåŠ¡å¿…åŠ å…¥å•Šï¼è¯¦æƒ…é¡µæœ‰å…¥å£ï¼Œå®åœ¨æ‰¾ä¸åˆ°ï¼ŒåŠ æˆ‘å¾®ä¿¡å¥½å‹ï¼ŒæœrJuniorï¼Œæˆ–è€…â€œæ–¹å—Kâ€ï¼Œæˆ‘æŠŠä½ æ‹‰è¿›å»ï½","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1616837255,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1589973,"avatar":"https://static001.geekbang.org/account/avatar/00/18/42/d5/1f020437.jpg","nickname":"Blexå…ˆç”Ÿ","note":"","ucode":"5B3987B724D5BF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":370952,"discussion_content":"è·Ÿç€å¤§ä½¬ä»¬çš„æ€è·¯çœ‹äº†MemoryStore.scalaçš„éƒ¨åˆ†ä»£ç ï¼Œè·ç›ŠåŒªæµ…ï¼","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1619590363,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":285392,"user_name":"è¶…çº§è¾¾è¾¾","can_delete":false,"product_type":"c1","uid":1159758,"ip_address":"","ucode":"153FCE3113AD11","user_header":"https://static001.geekbang.org/account/avatar/00/11/b2/4e/13a993a5.jpg","comment_is_top":false,"comment_ctime":1616771142,"is_pvip":false,"replies":[{"id":"103581","content":"éå¸¸å¥½çš„é—®é¢˜ï¼LinkedHashMapä¹Ÿæ˜¯ä¸€ç§HashMapçš„ï¼Œä½†åœ¨å†…éƒ¨ç”¨ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œæ¥ç»´æŠ¤é”®å€¼å¯¹çš„é¡ºåºï¼Œæ¯ä¸ªé”®å€¼å¯¹åŒæ—¶å­˜å‚¨åœ¨å“ˆå¸Œè¡¨ã€å’ŒåŒå‘é“¾è¡¨ä¸­ã€‚<br><br>æˆ‘ä»¬æ¥çœ‹LinkedHashMapç‰¹æ€§ï¼š<br>1 æ’å…¥æœ‰åºï¼Œè¿™ä¸ªå¥½ç†è§£ï¼Œå°±æ˜¯åœ¨é“¾è¡¨åè¿½åŠ å…ƒç´ <br>2 è®¿é—®æœ‰åºï¼Œè¿™ä¸ªå°±å‰å®³äº†ã€‚è®¿é—®æœ‰åºè¯´çš„æ˜¯ï¼Œå¯¹ä¸€ä¸ªkvæ“ä½œï¼Œä¸ç®¡putã€getï¼Œå…ƒç´ éƒ½ä¼šè¢«æŒªåˆ°é“¾è¡¨çš„æœ«å°¾ï¼Œå‘³é“å‡ºæ¥äº†ï½<br><br>åœ¨spark rdd cacheåœºæ™¯ä¸‹ï¼Œç¬¬ä¸€ä¸ªç‰¹æ€§ä¸é‡è¦ï¼Œé‡è¦çš„æ˜¯ç¬¬äºŒä¸ªç‰¹æ€§ã€‚å½“storage memoryä¸è¶³ï¼Œsparkéœ€è¦åˆ é™¤rdd cacheçš„æ—¶å€™ï¼Œéµå¾ªçš„æ˜¯lruï¼Œé‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œå®ƒå’‹å®ç°çš„lruï¼Œç­”æ¡ˆå°±æ˜¯å®ƒå……åˆ†åˆ©ç”¨LinkedHashMapç¬¬äºŒä¸ªç‰¹æ€§ï¼Œå•¥ä¹Ÿä¸ç”¨åšï¼Œå°±è½»æ¾åœ°åšåˆ°äº†è¿™ä¸€ç‚¹ï¼Œæœºä¸æœºæ™ºï¼Ÿ 6ä¸6ï¼Ÿ","user_name":"ä½œè€…å›å¤","comment_id":285392,"uid":"1043100","ip_address":"","utype":1,"ctime":1616808420,"user_name_real":"å´ç£Š"}],"discussion_count":7,"race_medal":0,"score":"87516117062","product_id":100073401,"comment_content":"è¿™é‡Œä¸ºä»€ä¹ˆç”¨åˆ°äº†LinkedHashMapè€Œä¸æ˜¯æ™®é€šçš„HashMapï¼Ÿä»€ä¹ˆåœºæ™¯ä¸‹éœ€è¦ä¿è¯è®¿é—®Blockçš„æœ‰åºæ€§ï¼Ÿ","like_count":21,"discussions":[{"author":{"id":1544692,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83errHypG6kuO0V0bRwp74rm8srjoQ4zXUBNNLMcY19uNdz8Ea3rOFuBJibXMHWePMwBYpGsyyxiav0ibw/132","nickname":"é—¯é—¯","note":"","ucode":"D32958F8EF26BD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":376070,"discussion_content":"æœ¬æ–‡ä¸­æåˆ°Mapå¤ªå¤§ä¼šä½¿ç”¨LRUç®—æ³•è¿›è¡Œæ¸…é™¤ã€‚é‚£ä¹ˆä½¿ç”¨LinkedHashMapæ˜¯æœ€å¥½çš„é€‰æ‹©ã€‚å› ä¸ºLinkedHashMapèƒ½ç›´æ¥å®ç°LRUç®—æ³•ã€‚è¿™éƒ¨åˆ†å±äºç®—æ³•çš„èŒƒç•´äº†ï¼šä¸‹é¢ç»™ä¸€ä¸ªDemo\n\npublic class LinkedLRUCache<K, V> extends LinkedHashMap<K, V> {\n\n    private int cacheSize;\n\n    public LinkedLRUCache(int cacheSize) {\n        // initialCapacity loadFactor éƒ½ä¸é‡è¦, é‡è¦çš„æ˜¯ accessOrder\n        super((int) (Math.ceil((cacheSize / 0.75)) + 1), 0.75f, true);\n        this.cacheSize = cacheSize;\n    }\n\n    @Override\n    protected boolean removeEldestEntry(Map.Entry<K, V> eldest) {\n        return size() > cacheSize;\n    }\n}","likes_number":5,"is_delete":false,"is_hidden":false,"ctime":1621948283,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":1544692,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83errHypG6kuO0V0bRwp74rm8srjoQ4zXUBNNLMcY19uNdz8Ea3rOFuBJibXMHWePMwBYpGsyyxiav0ibw/132","nickname":"é—¯é—¯","note":"","ucode":"D32958F8EF26BD","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":377041,"discussion_content":"ç‰›ï¼èµ~","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1622471285,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":376070,"ip_address":""},"score":377041,"extra":""}]},{"author":{"id":1159758,"avatar":"https://static001.geekbang.org/account/avatar/00/11/b2/4e/13a993a5.jpg","nickname":"è¶…çº§è¾¾è¾¾","note":"","ucode":"153FCE3113AD11","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":361958,"discussion_content":"ä¸€è¯­ç‚¹ç ´ï¼Œè°¢è°¢è€å¸ˆï¼","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1616812777,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2068627,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/90/93/5e94be87.jpg","nickname":"é’æ„Ÿ","note":"","ucode":"50FE1DD4EAEB78","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1159758,"avatar":"https://static001.geekbang.org/account/avatar/00/11/b2/4e/13a993a5.jpg","nickname":"è¶…çº§è¾¾è¾¾","note":"","ucode":"153FCE3113AD11","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":404066,"discussion_content":"é—®çš„å¥½å•Šï¼Œå’ŒåŒå­¦æ²¾å…‰äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634219375,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":361958,"ip_address":""},"score":404066,"extra":""}]},{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":517666,"discussion_content":"éå¸¸å¥½çš„é—®é¢˜ï¼LinkedHashMapä¹Ÿæ˜¯ä¸€ç§HashMapçš„ï¼Œä½†åœ¨å†…éƒ¨ç”¨ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œæ¥ç»´æŠ¤é”®å€¼å¯¹çš„é¡ºåºï¼Œæ¯ä¸ªé”®å€¼å¯¹åŒæ—¶å­˜å‚¨åœ¨å“ˆå¸Œè¡¨ã€å’ŒåŒå‘é“¾è¡¨ä¸­ã€‚\n\næˆ‘ä»¬æ¥çœ‹LinkedHashMapç‰¹æ€§ï¼š\n1 æ’å…¥æœ‰åºï¼Œè¿™ä¸ªå¥½ç†è§£ï¼Œå°±æ˜¯åœ¨é“¾è¡¨åè¿½åŠ å…ƒç´ \n2 è®¿é—®æœ‰åºï¼Œè¿™ä¸ªå°±å‰å®³äº†ã€‚è®¿é—®æœ‰åºè¯´çš„æ˜¯ï¼Œå¯¹ä¸€ä¸ªkvæ“ä½œï¼Œä¸ç®¡putã€getï¼Œå…ƒç´ éƒ½ä¼šè¢«æŒªåˆ°é“¾è¡¨çš„æœ«å°¾ï¼Œå‘³é“å‡ºæ¥äº†ï½\n\nåœ¨spark rdd cacheåœºæ™¯ä¸‹ï¼Œç¬¬ä¸€ä¸ªç‰¹æ€§ä¸é‡è¦ï¼Œé‡è¦çš„æ˜¯ç¬¬äºŒä¸ªç‰¹æ€§ã€‚å½“storage memoryä¸è¶³ï¼Œsparkéœ€è¦åˆ é™¤rdd cacheçš„æ—¶å€™ï¼Œéµå¾ªçš„æ˜¯lruï¼Œé‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œå®ƒå’‹å®ç°çš„lruï¼Œç­”æ¡ˆå°±æ˜¯å®ƒå……åˆ†åˆ©ç”¨LinkedHashMapç¬¬äºŒä¸ªç‰¹æ€§ï¼Œå•¥ä¹Ÿä¸ç”¨åšï¼Œå°±è½»æ¾åœ°åšåˆ°äº†è¿™ä¸€ç‚¹ï¼Œæœºä¸æœºæ™ºï¼Ÿ 6ä¸6ï¼Ÿ","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1616808420,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2406292,"avatar":"https://static001.geekbang.org/account/avatar/00/24/b7/94/22121c60.jpg","nickname":"Kendrick","note":"","ucode":"5DF1269295D24E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":376009,"discussion_content":"èµ","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1621926481,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2162751,"avatar":"https://static001.geekbang.org/account/avatar/00/21/00/3f/a0f84788.jpg","nickname":"Sean","note":"","ucode":"69234046BFD81B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":390017,"discussion_content":"æƒ³é—®ä¸€ä¸‹ï¼Œä½¿ç”¨spark-sql rdd cache çš„æ­£ç¡®å§¿åŠ¿æ˜¯æ€æ ·çš„å‘¢ï¼Œç»“åˆlruæ¸…æ¥šç­–ç•¥ï¼Œæ˜¯ä¸æ˜¯ä¸ç”¨æ‹…å¿ƒcacheå¯¼è‡´oomçš„é—®é¢˜ï¼ˆåªæ˜¯ä¸ªäººç†æƒ³ä¸»ä¹‰ ã€‹.-.ã€Š","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629603894,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":285404,"user_name":"æ¥ä¸–æ„¿åšå‹äºº A","can_delete":false,"product_type":"c1","uid":1181606,"ip_address":"","ucode":"EF20966B0F27E1","user_header":"https://static001.geekbang.org/account/avatar/00/12/07/a6/662bcc6b.jpg","comment_is_top":false,"comment_ctime":1616777305,"is_pvip":false,"replies":[{"id":"103583","content":"Perfect + Awesomeï¼æ¬¢è¿æ¥ç¾¤é‡Œå‚ä¸æ›´å¤šè®¨è®ºå“ˆï½ è¯¾ç¨‹çš„è¯¦æƒ…é¡µæœ‰è¯»è€…ç¾¤çš„äºŒç»´ç ï¼ŒæœŸå¾…ä½ çš„åŠ å…¥ï½<br><br>psï¼šæœ‰ä¸ªå°ç»†èŠ‚ï¼Œä»executorsæ‹‰å–åˆ†ç‰‡ã€åˆ†æ‹…driverå‹åŠ›ï¼Œæ®æˆ‘äº†è§£ï¼Œè¿™éƒ¨åˆ†åŠŸèƒ½ï¼Œcodeå·²ç»readyï¼Œä¸è¿‡åº”è¯¥è¿˜æ²¡æœ‰mergeåˆ°masterã€‚è‡³å°‘ä¹‹å‰æ˜¯è¿™æ ·å“ˆï½ ä¸çŸ¥é“æœ€è¿‘æœ‰æ²¡æœ‰ä»€ä¹ˆå˜åŒ–","user_name":"ä½œè€…å›å¤","comment_id":285404,"uid":"1043100","ip_address":"","utype":1,"ctime":1616809285,"user_name_real":"å´ç£Š"}],"discussion_count":7,"race_medal":0,"score":"40271482969","product_id":100073401,"comment_content":"ç¬¬ä¸€é¢˜ï¼šæ— è®º getBytes è¿˜æ˜¯ getValuesï¼Œéƒ½æ˜¯ä½¿ç”¨ blockId ä»æ–‡ä¸­çš„ linkedHashMap è·å– memoryEntryï¼Œå¹¶ä¸”éƒ½è½¬æ¢æˆ Iterator è¿”å›<br>ç¬¬äºŒé¢˜ï¼šåŒç†ï¼Œå› ä¸ºéƒ½æœ‰é‚£å‡ ä¸ª BlockManager ç­‰ç»„ä»¶ç®¡ç†ï¼Œæ‰€ä»¥ï¼Œå¹¿æ’­å˜é‡é¦–å…ˆä¹Ÿéœ€è¦ blockIdï¼ŒæŸ¥çœ‹å­ç±»å®ç°æœ‰ BroadcastBlockIdï¼Œæ ¼å¼æ˜¯broadcast_&quot; + broadcastId + xxxã€‚ä½¿ç”¨ blockCast çš„æ—¶å€™ï¼Œé¦–å…ˆåœ¨ driver ç«¯è¿›è¡Œå­˜å‚¨ï¼Œå¹¿æ’­å˜é‡driverç«¯é»˜è®¤æ˜¯ MEMORY_AND_DISKï¼Œå¹¶ä¸”ä¼˜å…ˆå†™å…¥ memoryï¼Œåªæœ‰å­˜ä¸ä¸‹æ‰å†™å…¥ diskï¼Œå¹¶ä¸”ä¼¼ä¹æ— æ³•ä¿®æ”¹è¿™å­˜å‚¨ç­‰çº§ï¼Œå¹¶ä¸”ä¼šå­˜ä¸¤ä»½æ•°æ®ï¼Œä¸€ä»½æ˜¯ä¾› driver ç«¯ä½¿ç”¨ï¼Œå’Œé»˜è®¤4må‹ç¼©çš„åºåˆ—åŒ–æ•°æ®ï¼ˆMEMORY_AND_DISK_SER)ï¼Œä¾› executor è¿œç¨‹æ‹‰å–ï¼ŒblockId åˆ†åˆ«æ˜¯ broadcast_&quot; + broadcastId å’Œ broadcast_&quot; + broadcastId + &quot;piece&quot; + range(0, numBlocks) å‘½åã€‚ç„¶ååœ¨ executor ç«¯ï¼Œè°ƒç”¨ Broadcast.valueï¼Œé¦–å…ˆä¼šæŸ¥æ‰¾æœ¬åœ°ç¼“å­˜æ˜¯å¦æœ‰ï¼Œæ²¡æœ‰å°±ä¼šæ‹‰å– driver æˆ–è€…å·²ç»æ‹‰å–çš„å…¶å®ƒ executor çš„å—ï¼Œå¹¶ä¸”æ˜¯é€šè¿‡ broadcast_&quot; + broadcastId + &quot;piece&quot; + range(0, numBlocks) éšæœºè·å–å­˜å‚¨å—ï¼Œåˆ†æ•£ driver çš„å‹åŠ›ï¼Œç„¶åä»¥ MEMORY_AND_DISK_SER çš„çº§åˆ«å­˜å‚¨åœ¨æœ¬åœ°ã€‚åç»­å°±å’Œ rdd ç¼“å­˜æ•°æ®ä¸€æ ·ç±»ä¼¼ï¼Œç”¨ putBytes å­˜å‚¨åˆ°æœ¬åœ°ç¼“å­˜æˆ– diskã€‚","like_count":9,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":517669,"discussion_content":"Perfect + Awesomeï¼æ¬¢è¿æ¥ç¾¤é‡Œå‚ä¸æ›´å¤šè®¨è®ºå“ˆï½ è¯¾ç¨‹çš„è¯¦æƒ…é¡µæœ‰è¯»è€…ç¾¤çš„äºŒç»´ç ï¼ŒæœŸå¾…ä½ çš„åŠ å…¥ï½\n\npsï¼šæœ‰ä¸ªå°ç»†èŠ‚ï¼Œä»executorsæ‹‰å–åˆ†ç‰‡ã€åˆ†æ‹…driverå‹åŠ›ï¼Œæ®æˆ‘äº†è§£ï¼Œè¿™éƒ¨åˆ†åŠŸèƒ½ï¼Œcodeå·²ç»readyï¼Œä¸è¿‡åº”è¯¥è¿˜æ²¡æœ‰mergeåˆ°masterã€‚è‡³å°‘ä¹‹å‰æ˜¯è¿™æ ·å“ˆï½ ä¸çŸ¥é“æœ€è¿‘æœ‰æ²¡æœ‰ä»€ä¹ˆå˜åŒ–","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1616809285,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":362646,"discussion_content":"è¿™ä¸ªticketï¼šã€Executor side broadcast for broadcast joinsã€‘https://issues.apache.org/jira/browse/SPARK-17556ï¼Œçœ‹ä¸Šå»è¿˜æ˜¯è¿›è¡Œä¸­çš„çŠ¶æ€ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1616997696,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1181606,"avatar":"https://static001.geekbang.org/account/avatar/00/12/07/a6/662bcc6b.jpg","nickname":"æ¥ä¸–æ„¿åšå‹äºº A","note":"","ucode":"EF20966B0F27E1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":364612,"discussion_content":"å“¦å“¦ï¼Œè¿™ä¸ªå¯èƒ½æˆ‘æ²¡æœ‰æè¿°æ¸…æ¥šï¼Œæˆ‘çš„åœºæ™¯é™å®šåœ¨ driver ç«¯äº§ç”Ÿçš„ å¹¿æ’­å˜é‡ï¼Œè¿™ä¸ª broadcase joins æ˜¯åœ¨ executor äº§ç”Ÿçš„éœ€è¦å¹¿æ’­çš„å˜é‡ï¼Œåœºæ™¯æ²¡è€ƒè™‘å…¨ï¼Œsorry sorryã€‚è¿™å—ä»£ç æ²¡æœ‰ç ”ç©¶ï¼Œåé¢çœ‹çœ‹ã€‚ç›®å‰çœ‹è¿™ç§åœºæ™¯åº”è¯¥æ˜¯å…ˆæ”¶é›†åˆ° driverï¼Œä½†æ˜¯çŒœæµ‹ä¹Ÿä¸ä¼šç«‹é©¬å¹¿æ’­ï¼Œè€Œæ˜¯å’Œåœºæ™¯åœ¨ driver ç«¯å·®ä¸å¤šï¼Œè§¦å‘å†æ‹‰å–ï¼Œè¿™æ—¶å€™å¯ä»¥ä»å„ä¸ªå·²æœ‰çš„èŠ‚ç‚¹æ‹‰å–ï¼Œå‡è½»è´Ÿè½½","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617538455,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":362646,"ip_address":""},"score":364612,"extra":""},{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":1181606,"avatar":"https://static001.geekbang.org/account/avatar/00/12/07/a6/662bcc6b.jpg","nickname":"æ¥ä¸–æ„¿åšå‹äºº A","note":"","ucode":"EF20966B0F27E1","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":366421,"discussion_content":"å¤šè®¨è®ºè®¨è®ºæŒºå¥½çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618057053,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":364612,"ip_address":""},"score":366421,"extra":""}]},{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":362644,"discussion_content":"æˆ‘åˆçœ‹äº†ä¸‹master branchï¼Œå‘ç°å¹¿æ’­å˜é‡çš„åˆ›å»ºè¿‡ç¨‹è¿˜æ˜¯è¿™æ ·çš„ï¼š\n\nBroadcastExchangeExecä¸­çš„relationFutureç”¨äºè·å–å¹¿æ’­å˜é‡å†…å®¹\nåœ¨relationFutureå†…éƒ¨ï¼š\n  1. å…ˆæ˜¯è°ƒç”¨executeCollectIteratorç”Ÿæˆå†…å®¹relationï¼›\n     å…¶ä¸­ï¼ŒexecuteCollectIteratorè°ƒç”¨collectæŠŠç»“æœé›†æ”¶é›†åˆ°driverç«¯\n  2. ç„¶åç”¨sparkContext.broadcast(relation)ï¼ŒæŠŠç”Ÿæˆå¥½çš„å†…å®¹å¹¿æ’­åˆ°å„ä¸ªExecutors\nå¹¶æ²¡æœ‰çœ‹åˆ°å“ªé‡Œä»Executorsæ‹‰å–æ•°æ®åˆ†ç‰‡ã€æ¥å‡è½»driverè´Ÿè½½ã€‚\n\nè€å¼Ÿshareä¸€ä¸‹ä½ çœ‹åˆ°çš„ä»£ç è·¯å¾„ï¼Ÿ\n\nå¹¶ä¸”ï¼Œè¿™é‡Œè¿˜æœ‰æç¤ºdriverå†…å­˜ä¸å¤Ÿçš„exceptionï¼š\nnew OutOfMemoryError(&#34;Not enough memory to build and broadcast the table to all &#34; + &#34;worker nodes. As a workaround, you can either disable broadcast by setting &#34; + s&#34;${SQLConf.AUTO_BROADCASTJOIN_THRESHOLD.key} to -1 or increase the spark &#34; + s&#34;driver memory by setting ${SparkLauncher.DRIVER_MEMORY} to a higher value.&#34;).initCause(oe.getCause))","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1616997335,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1181606,"avatar":"https://static001.geekbang.org/account/avatar/00/12/07/a6/662bcc6b.jpg","nickname":"æ¥ä¸–æ„¿åšå‹äºº A","note":"","ucode":"EF20966B0F27E1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":364611,"discussion_content":"TorrentBroadcast ä¸­ private lazy val _value: T = readBroadcastBlock() æ˜¯ lazy ä¿®é¥°çš„ï¼Œç„¶ååˆ›å»ºå®ä¾‹çš„æ—¶å€™ï¼Œè°ƒç”¨ TorrentBroadcast.writeBlocksï¼Œåªæ˜¯å†™åˆ°äº† BlockManager ä¸­ï¼Œå¹¶æ²¡æœ‰å‘ç”Ÿå¹¿æ’­ï¼Œåªæœ‰ executor çš„ç¡®ç”¨åˆ°å¹¿æ’­å˜é‡ï¼Œæ‰ä¼šè§¦å‘æ‹‰å– TorrentBroadcast.readBlocksã€‚åˆ¤æ–­ executor çš„æœ¬åœ° BlockManager æ˜¯å¦æœ‰å­˜å‚¨ï¼Œæ²¡æœ‰ä¼šæ‹‰å– driver æˆ–è€… executor ç«¯çš„","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1617538215,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":362644,"ip_address":""},"score":364611,"extra":""}]},{"author":{"id":1181606,"avatar":"https://static001.geekbang.org/account/avatar/00/12/07/a6/662bcc6b.jpg","nickname":"æ¥ä¸–æ„¿åšå‹äºº A","note":"","ucode":"EF20966B0F27E1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":361992,"discussion_content":"åº”è¯¥æ˜¯ï¼Œæˆ‘çœ‹çš„æ˜¯ 3.0 çš„åˆ†æ”¯","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1616819497,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":300863,"user_name":"ç‰¹ç§æµæ°“","can_delete":false,"product_type":"c1","uid":1248825,"ip_address":"","ucode":"D9985CBA8B4AAD","user_header":"https://static001.geekbang.org/account/avatar/00/13/0e/39/174741d1.jpg","comment_is_top":false,"comment_ctime":1625409763,"is_pvip":false,"replies":[{"id":"109049","content":"å¥½é—®é¢˜ï¼Œè¿˜çœŸå¯ä»¥~<br><br>Shuffle writeçš„ä¸­é—´æ–‡ä»¶ï¼Œéƒ½ä¼šè½ç›˜åˆ°spark.local.dirè¿™ä¸ªé…ç½®é¡¹æŒ‡å®šçš„æ–‡ä»¶ç›®å½•ï¼Œå¦‚æœå†…å­˜è¶³å¤Ÿå¤§çš„è¯ï¼Œå¯ä»¥ç”¨Ramdiskå¼€è¾Ÿä¸€å—å†…å­˜ï¼Œç”¨æ¥å½“ä½œæ˜¯æ–‡ä»¶ç³»ç»Ÿã€‚<br><br>ç„¶åï¼ŒæŠŠspark.local.diræŒ‡å‘åˆ°è¿™é‡Œï¼Œé‚£ä¹ˆä¸­é—´æ–‡ä»¶å®é™…ä¸Šå°±æ˜¯æš‚å­˜åˆ°äº†å†…å­˜ä¸­ï¼Œè¿™æ ·å°±èƒ½å®ç°å®Œå…¨çš„â€œå†…å­˜è®¡ç®—â€ï¼Œä¹Ÿå°±æ˜¯è®¡ç®—çš„æ•´ä¸ªè¿‡ç¨‹ï¼Œä»å¤´åˆ°å°¾ï¼Œéƒ½æ˜¯åœ¨å†…å­˜é‡Œé¢å®Œæˆã€‚","user_name":"ä½œè€…å›å¤","comment_id":300863,"uid":"1043100","ip_address":"","utype":1,"ctime":1625526322,"user_name_real":"å´ç£Š"}],"discussion_count":2,"race_medal":0,"score":"27395213539","product_id":100073401,"comment_content":"spark åšshuffleçš„æ—¶å€™ï¼Œshuffle write è¦å†™å…¥ç£ç›˜ï¼Œæ˜¯å¦å¯ä»¥ç›´æ¥é€šè¿‡å†…å­˜ä¼ è¾“","like_count":7,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":522838,"discussion_content":"å¥½é—®é¢˜ï¼Œè¿˜çœŸå¯ä»¥~\n\nShuffle writeçš„ä¸­é—´æ–‡ä»¶ï¼Œéƒ½ä¼šè½ç›˜åˆ°spark.local.dirè¿™ä¸ªé…ç½®é¡¹æŒ‡å®šçš„æ–‡ä»¶ç›®å½•ï¼Œå¦‚æœå†…å­˜è¶³å¤Ÿå¤§çš„è¯ï¼Œå¯ä»¥ç”¨Ramdiskå¼€è¾Ÿä¸€å—å†…å­˜ï¼Œç”¨æ¥å½“ä½œæ˜¯æ–‡ä»¶ç³»ç»Ÿã€‚\n\nç„¶åï¼ŒæŠŠspark.local.diræŒ‡å‘åˆ°è¿™é‡Œï¼Œé‚£ä¹ˆä¸­é—´æ–‡ä»¶å®é™…ä¸Šå°±æ˜¯æš‚å­˜åˆ°äº†å†…å­˜ä¸­ï¼Œè¿™æ ·å°±èƒ½å®ç°å®Œå…¨çš„â€œå†…å­˜è®¡ç®—â€ï¼Œä¹Ÿå°±æ˜¯è®¡ç®—çš„æ•´ä¸ªè¿‡ç¨‹ï¼Œä»å¤´åˆ°å°¾ï¼Œéƒ½æ˜¯åœ¨å†…å­˜é‡Œé¢å®Œæˆã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625526322,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1296063,"avatar":"https://static001.geekbang.org/account/avatar/00/13/c6/bf/52b3f71d.jpg","nickname":"dawn","note":"","ucode":"1757B28F1EF5C4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":585374,"discussion_content":"æˆ‘çœ‹åˆ°çš„æ—¶å€™ï¼Œä¹Ÿåœ¨æƒ³ï¼Œä¸€å®šè¦è½ç›˜å˜›ï¼Œç›´æ¥ä¸¢å†…å­˜ä¸æ˜¯æ›´å¿«ï¼Œåæ­£åªæ˜¯ä¸­é—´æ•°æ®","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661501924,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"æ±Ÿè‹"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":291143,"user_name":"aof","can_delete":false,"product_type":"c1","uid":1062864,"ip_address":"","ucode":"5815D63C4926BC","user_header":"https://static001.geekbang.org/account/avatar/00/10/37/d0/26975fba.jpg","comment_is_top":false,"comment_ctime":1620047429,"is_pvip":false,"replies":[{"id":"105489","content":"å®Œç¾~ Perfect x 2ï¼ï¼ï¼","user_name":"ä½œè€…å›å¤","comment_id":291143,"uid":"1043100","ip_address":"","utype":1,"ctime":1620120549,"user_name_real":"å´ç£Š"}],"discussion_count":1,"race_medal":0,"score":"18799916613","product_id":100073401,"comment_content":"ç¬¬ä¸€é¢˜ï¼š<br>getValues&#47;getBytesä¸¤ä¸ªæ–¹æ³•éƒ½æ˜¯é€šè¿‡blockIdæ¥è·å–ç¼“å­˜æ•°æ®çš„ï¼Œé€šè¿‡blockIdè·å–å¯¹åº”çš„MemoryEntryçš„æ—¶å€™ä¼šå¯¹LinkedHashMapåŠ åŒæ­¥é”ï¼Œç„¶åé€šè¿‡æ¨¡å¼æ¥åŒ¹é…è·å–çš„MemoryEntryæ˜¯DeserializedMemoryEntryè¿˜æ˜¯SerializedMemoryEntryï¼ŒgetBytesæ–¹æ³•ç”¨æ¥è·å–SerializedMemoryEntryå¹¶è¿”å›ChunkedByteBufferï¼ŒgetValuesæ–¹æ³•ç”¨æ¥è·å–DeserializedMemoryEntryå¹¶è¿”å›è¿­ä»£å™¨Iteratorã€‚<br><br>ç¬¬äºŒé¢˜ï¼š<br><br>æˆ‘ä»¬åœ¨å¯¹ä¸€ä¸ªRDDè¿›è¡Œå¹¿æ’­ä¹‹åï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªBroadcast[T]ï¼Œè€ŒBroadcastæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ƒç›®å‰ï¼ˆSpark 2.4.5çš„æºç ï¼‰åªæœ‰ä¸€ä¸ªå®ç°ç±»TorrentBroadcastã€‚TorrentBroadcastçš„æœºåˆ¶ï¼šdriverå°†åºåˆ—åŒ–çš„å¯¹è±¡åˆ’åˆ†ä¸ºå¤šä¸ªå°çš„chunksï¼ˆchunksä¸ºByteBufferç±»å‹çš„æ•°ç»„ï¼Œå³Array[ByteBuffer]ï¼‰ï¼Œç„¶åå°†è¿™äº›chunkså­˜å‚¨åˆ°driverçš„BlockManagerä¸­ã€‚<br><br>æ•´ä¸ªå¹¿æ’­å˜é‡å­˜å…¥MemoryStoreçš„æµç¨‹å¦‚ä¸‹ï¼š<br><br>1. TorrentBroadcast#writeBlocks()æ–¹æ³•ï¼šå°†è¦å¹¿æ’­çš„å¯¹è±¡åˆ’åˆ†ä¸ºå¤šä¸ªblocksï¼Œå¹¶å°†è¿™äº›blocksä¿å­˜åˆ°BlockManagerï¼Œä¸»è¦é€šè¿‡blockManager#putBytes()æ–¹æ³•æ¥å®ç°çš„ï¼›<br>2. blockManager#putBytes()æ–¹æ³•é€šè¿‡è°ƒç”¨ doPutBytes() æ–¹æ³•å°†åºåˆ—åŒ–çš„bytesï¼ˆChunkedByteBufferï¼‰é€šè¿‡æŒ‡å®šçš„StorageLevelä¿å­˜åˆ° memoryStore ä¸­ï¼›<br>3. æ¥ä¸‹æ¥ï¼Œé‡ç‚¹å°±åœ¨doPutBytes() æ–¹æ³•çš„å®ç°ï¼Œé¦–å…ˆå®ƒä¼šæ ¹æ®ä¼ å…¥æ­¤æ–¹æ³•ä¸­çš„ StorageLevel æ¥åˆ¤æ–­ç¼“å­˜æ˜¯å†™å…¥å†…å­˜è¿˜æ˜¯ç£ç›˜ï¼Œä¹Ÿå°±æ˜¯ç”¨ MemoryStoreè¿˜æ˜¯DiskStoreæ¥è¿›è¡Œç¼“å­˜ï¼›<br>4. å¦‚æœç¼“å­˜çº§åˆ«ä¸­ä½¿ç”¨äº†å†…å­˜ï¼Œåˆ™ä¼šè¿›ä¸€æ­¥é€šè¿‡ç¼“å­˜çº§åˆ«ä¸­æœ‰æ²¡æœ‰æŒ‡å®šåºåˆ—åŒ–æ¥åˆ¤æ–­æ˜¯å­˜å¯¹è±¡å€¼åºåˆ—è¿˜æ˜¯å­—èŠ‚åºåˆ—ã€‚ï¼ˆ1ï¼‰å¦‚æœæ˜¯deserializedï¼ˆéåºåˆ—åŒ–ï¼‰çš„ï¼Œå°±å°†bytesè¿›è¡Œååºåˆ—åŒ–ï¼Œç„¶åè°ƒç”¨ memoryStore#putIteratorAsValues()æ–¹æ³•â€”â€”&gt;memoryStore#putIterator() å°†blockä¿å­˜åˆ°MemoryStoreï¼ŒputIterator()æ–¹æ³•ä¸­ï¼Œå¯èƒ½ä¼šå› ä¸ºè¿­ä»£å™¨å¤ªå¤§ï¼Œæ— æ³•ç‰©åŒ–å­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚ä¸ºäº†é¿å…OOMå¼‚å¸¸ï¼Œæ­¤æ–¹æ³•å°†é€æ­¥å±•å¼€è¿­ä»£å™¨ï¼ŒåŒæ—¶å®šæœŸæ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„ç©ºé—²å†…å­˜ã€‚å¦‚æœblockè¢«æˆåŠŸç‰©åŒ–ï¼Œé‚£ä¹ˆç‰©åŒ–æœŸé—´ä½¿ç”¨çš„ä¸´æ—¶å±•å¼€å†…å­˜ï¼ˆunroll memoryï¼‰å°†è¢«â€œè½¬ç§»â€åˆ°å­˜å‚¨å†…å­˜ï¼ˆStorageMemoryï¼‰ï¼Œå› æ­¤æˆ‘ä»¬ä¸ä¼šè·å¾—æ¯”å­˜å‚¨å—å®é™…éœ€è¦çš„æ›´å¤šçš„å†…å­˜ï¼›ï¼ˆ2ï¼‰å¦‚æœæ˜¯serializedï¼ˆåºåˆ—åŒ–ï¼‰çš„ï¼Œè¿˜ä¼šè¿›ä¸€æ­¥åˆ¤æ–­å†…å­˜æ¨¡å‹ï¼ˆMemoryModeï¼‰æ˜¯å †å†…å­˜ï¼ˆON_HEAPï¼‰è¿˜æ˜¯éå †å†…å­˜ï¼ˆON_HEAPï¼‰ï¼Œæ˜¯å“ªç§å†…å­˜æ¨¡å‹ï¼Œå°±ç”³è¯·å¯¹åº”çš„StorageMemoryï¼Œå¹¶å°†byteså®ä¾‹åŒ–ä¸ºä¸€ä¸ªSerializedMemoryEntryæ”¾å…¥entriesï¼ˆLinkedHashMapï¼‰ã€‚<br>5. å¦‚æœç¼“å­˜çº§åˆ«ä¸­ä½¿ç”¨äº†ç£ç›˜ï¼Œåˆ™ä¼šè°ƒç”¨ diskStore#putBytes()è¿›è¡Œæ•°æ®çš„ç¼“å­˜ã€‚","like_count":4,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":519383,"discussion_content":"å®Œç¾~ Perfect x 2ï¼ï¼ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620120549,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":287246,"user_name":"å¿«è·‘","can_delete":false,"product_type":"c1","uid":1564645,"ip_address":"","ucode":"90ED7E6D40C58E","user_header":"https://static001.geekbang.org/account/avatar/00/17/df/e5/65e37812.jpg","comment_is_top":false,"comment_ctime":1617853435,"is_pvip":false,"replies":[{"id":"104302","content":"å¯¹ï¼Œä½ è¯´çš„æ²¡é”™ï¼Œæ˜¯shuffleè¿‡ç¨‹ä¸­ï¼Œå½’å¹¶æ’åºï¼Œè¿™éƒ¨åˆ†ç»†èŠ‚shuffleé‚£ä¸€è®²æœ‰ä»‹ç»ã€‚å…·ä½“å“ªä¸ªç±»ï¼Œå¦‚æœæˆ‘æ²¡è®°é”™çš„è¯ï¼Œåº”è¯¥æ˜¯External Sorterï¼Œåº”è¯¥æ˜¯è¿™ä¸ªï¼Œæˆ‘å›å»ç¿»ç¿»æºç ï¼Œå†ç¡®è®¤ä¸€ä¸‹å“ˆï½","user_name":"ä½œè€…å›å¤","comment_id":287246,"uid":"1043100","ip_address":"","utype":1,"ctime":1617881346,"user_name_real":"å´ç£Š"}],"discussion_count":1,"race_medal":0,"score":"18797722619","product_id":100073401,"comment_content":"è€å¸ˆä½ å¥½ï¼Œæ–‡ä¸­æåˆ°â€œData æ–‡ä»¶å­˜å‚¨åˆ†åŒºæ•°æ®ï¼Œå®ƒæ˜¯ç”± temp æ–‡ä»¶åˆå¹¶è€Œæ¥çš„â€<br>shuffleè¿‡ç¨‹ä¸­çš„æ–‡ä»¶åˆå¹¶è¿™ä¸ªé€»è¾‘åº”è¯¥æ˜¯å½’å¹¶æ’åºæ¥å®ç°çš„å§ï¼Œè¿™æ®µé€»è¾‘æ˜¯å“ªä¸ªç±»è´Ÿè´£çš„ï¼Ÿ","like_count":4,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":518246,"discussion_content":"å¯¹ï¼Œä½ è¯´çš„æ²¡é”™ï¼Œæ˜¯shuffleè¿‡ç¨‹ä¸­ï¼Œå½’å¹¶æ’åºï¼Œè¿™éƒ¨åˆ†ç»†èŠ‚shuffleé‚£ä¸€è®²æœ‰ä»‹ç»ã€‚å…·ä½“å“ªä¸ªç±»ï¼Œå¦‚æœæˆ‘æ²¡è®°é”™çš„è¯ï¼Œåº”è¯¥æ˜¯External Sorterï¼Œåº”è¯¥æ˜¯è¿™ä¸ªï¼Œæˆ‘å›å»ç¿»ç¿»æºç ï¼Œå†ç¡®è®¤ä¸€ä¸‹å“ˆï½","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617881346,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":299243,"user_name":"é™ˆå¨æ´‹","can_delete":false,"product_type":"c1","uid":2264679,"ip_address":"","ucode":"DCF84B4D3A7354","user_header":"https://static001.geekbang.org/account/avatar/00/22/8e/67/afb412fb.jpg","comment_is_top":false,"comment_ctime":1624525845,"is_pvip":false,"replies":[{"id":"108575","content":"ä½ è¯´çš„ç®—æ³•å·¥ç¨‹å¸ˆï¼Œæˆ‘ç†è§£æ˜¯æœºå™¨å­¦ä¹ ç®—æ³•å·¥ç¨‹å¸ˆï¼Œå¦‚æœæ˜¯è¿™æ ·çš„è¯ï¼Œé‚£å…¶å®æˆ‘ä¸æ¨èå»è¯»Sparkçš„æºç ï¼Œå› ä¸ºæ²¡æœ‰å¿…è¦ã€‚å¯¹äºæœºå™¨å­¦ä¹ ç®—æ³•å·¥ç¨‹å¸ˆæ¥è¯´ï¼Œç†Ÿæ‚‰Spark MLlibé‡Œé¢ç‰¹å¾å¤„ç†éƒ¨åˆ†çš„å†…å®¹æ€§ä»·æ¯”ä¼šæ›´é«˜ï¼Œæ¯”å¦‚è¯´å„ç§é¢„å¤„ç†ã€å½’ä¸€åŒ–ã€ç¦»æ•£åŒ–ï¼›Embeddingçš„å„ç§å¤„ç†æŠ€å·§ï¼ˆåŒ…æ‹¬çŸ©é˜µåˆ†è§£ï¼‰ï¼›ç‰¹å¾é€‰æ‹©ï¼Œç­‰ç­‰ã€‚è¿™äº›ä¸œè¥¿å¯¹äºä¸€ä¸ªMLç®—æ³•å·¥ç¨‹å¸ˆæ¥è¯´ï¼Œä¼šéå¸¸çš„æœ‰ç”¨ã€‚<br><br>ä¸è¿‡ï¼Œå¦‚æœä½ è¯´çš„ç®—æ³•å·¥ç¨‹å¸ˆï¼Œå°±æ˜¯æ•°æ®ç»“æ„ç®—æ³•å·¥ç¨‹å¸ˆï¼Œé‚£æˆ‘è§‰å¾—è¯»ä¸€è¯»Sparkçš„æºç å®ç°è¿˜æ˜¯å¾ˆæœ‰å¸®åŠ©çš„ã€‚é€šè¿‡é˜…è¯»æºç ï¼Œå¯ä»¥å­¦ä¹ äººå®¶çš„å„ç§å®ç°æ–¹æ³•ï¼Œæ¯”å¦‚æŠ½è±¡ã€å°è£…ã€ç®—æ³•å®ç°ã€å·§ç”¨æ•°æ®ç»“æ„ï¼ˆå¦‚LinkedHashMapï¼‰ï¼Œè¯¸å¦‚æ­¤ç±»ï¼Œå‡¡æ­¤ç§ç§~","user_name":"ä½œè€…å›å¤","comment_id":299243,"uid":"1043100","ip_address":"","utype":1,"ctime":1624633225,"user_name_real":"å´ç£Š"}],"discussion_count":2,"race_medal":0,"score":"10214460437","product_id":100073401,"comment_content":"å´è€å¸ˆï¼Œæ‚¨å¥½ï¼Œæˆ‘æ˜¯Sparkåº•å±‚å°ç™½ï¼Œæˆ‘çš„é—®é¢˜æ˜¯ï¼š<br><br>å­¦ä¹ Sparkæºç å¯¹äºä¸€ä¸ªç®—æ³•å·¥ç¨‹å¸ˆæœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿåœ¨æ—¥å¸¸çš„å¼€å‘å·¥ä½œä¸­ï¼Œå­¦ä¹ å®ƒèƒ½å¤Ÿå‘æŒ¥ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿ<br><br>å¸Œæœ›å¾—åˆ°è€å¸ˆçš„è§£æƒ‘ï½ ","like_count":2,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":522373,"discussion_content":"ä½ è¯´çš„ç®—æ³•å·¥ç¨‹å¸ˆï¼Œæˆ‘ç†è§£æ˜¯æœºå™¨å­¦ä¹ ç®—æ³•å·¥ç¨‹å¸ˆï¼Œå¦‚æœæ˜¯è¿™æ ·çš„è¯ï¼Œé‚£å…¶å®æˆ‘ä¸æ¨èå»è¯»Sparkçš„æºç ï¼Œå› ä¸ºæ²¡æœ‰å¿…è¦ã€‚å¯¹äºæœºå™¨å­¦ä¹ ç®—æ³•å·¥ç¨‹å¸ˆæ¥è¯´ï¼Œç†Ÿæ‚‰Spark MLlibé‡Œé¢ç‰¹å¾å¤„ç†éƒ¨åˆ†çš„å†…å®¹æ€§ä»·æ¯”ä¼šæ›´é«˜ï¼Œæ¯”å¦‚è¯´å„ç§é¢„å¤„ç†ã€å½’ä¸€åŒ–ã€ç¦»æ•£åŒ–ï¼›Embeddingçš„å„ç§å¤„ç†æŠ€å·§ï¼ˆåŒ…æ‹¬çŸ©é˜µåˆ†è§£ï¼‰ï¼›ç‰¹å¾é€‰æ‹©ï¼Œç­‰ç­‰ã€‚è¿™äº›ä¸œè¥¿å¯¹äºä¸€ä¸ªMLç®—æ³•å·¥ç¨‹å¸ˆæ¥è¯´ï¼Œä¼šéå¸¸çš„æœ‰ç”¨ã€‚\n\nä¸è¿‡ï¼Œå¦‚æœä½ è¯´çš„ç®—æ³•å·¥ç¨‹å¸ˆï¼Œå°±æ˜¯æ•°æ®ç»“æ„ç®—æ³•å·¥ç¨‹å¸ˆï¼Œé‚£æˆ‘è§‰å¾—è¯»ä¸€è¯»Sparkçš„æºç å®ç°è¿˜æ˜¯å¾ˆæœ‰å¸®åŠ©çš„ã€‚é€šè¿‡é˜…è¯»æºç ï¼Œå¯ä»¥å­¦ä¹ äººå®¶çš„å„ç§å®ç°æ–¹æ³•ï¼Œæ¯”å¦‚æŠ½è±¡ã€å°è£…ã€ç®—æ³•å®ç°ã€å·§ç”¨æ•°æ®ç»“æ„ï¼ˆå¦‚LinkedHashMapï¼‰ï¼Œè¯¸å¦‚æ­¤ç±»ï¼Œå‡¡æ­¤ç§ç§~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1624633225,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2264679,"avatar":"https://static001.geekbang.org/account/avatar/00/22/8e/67/afb412fb.jpg","nickname":"é™ˆå¨æ´‹","note":"","ucode":"DCF84B4D3A7354","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":380711,"discussion_content":"éå¸¸æ„Ÿè°¢è€æ‚‰å¿ƒçš„å›å¤å“ˆï¼ï¼ˆæˆ‘è¯´çš„æ˜¯æ¨èç®—æ³•å·¥ç¨‹å¸ˆå“ˆï¼Œåº”è¯¥å’Œæœºå™¨å­¦ä¹ å·¥ç¨‹å¸ˆå·®ä¸å¤šï¼‰","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1624652732,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":304512,"user_name":"Kung","can_delete":false,"product_type":"c1","uid":1086261,"ip_address":"","ucode":"862B39B7263447","user_header":"https://static001.geekbang.org/account/avatar/00/10/93/35/0cfb5732.jpg","comment_is_top":false,"comment_ctime":1627461744,"is_pvip":false,"replies":[{"id":"110177","content":"å¤šç§¯ç´¯ï¼Œå¤šæ€è€ƒï¼Œå¤šé—®â€œä¸ºä»€ä¹ˆâ€~","user_name":"ä½œè€…å›å¤","comment_id":304512,"uid":"1043100","ip_address":"","utype":1,"ctime":1627482316,"user_name_real":"å´ç£Š"}],"discussion_count":2,"race_medal":0,"score":"5922429040","product_id":100073401,"comment_content":"å›ç­”çš„åŒå­¦éƒ½å¤ªç‰›äº†ï¼Œæˆ‘æ˜¯Sparkå°ç™½ï¼Œæ€ä¹ˆæ‰èƒ½è¾¾åˆ°è¿™æ ·çš„æ·±åº¦ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":524067,"discussion_content":"å¤šç§¯ç´¯ï¼Œå¤šæ€è€ƒï¼Œå¤šé—®â€œä¸ºä»€ä¹ˆâ€~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627482316,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2068627,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/90/93/5e94be87.jpg","nickname":"é’æ„Ÿ","note":"","ucode":"50FE1DD4EAEB78","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":404072,"discussion_content":"åŠ æ²¹ï¼ï¼ï¼æœ‰å¿—è€…äº‹ç«Ÿæˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634220235,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":290060,"user_name":"Zå®‡é”¤é”¤","can_delete":false,"product_type":"c1","uid":2188142,"ip_address":"","ucode":"7DB36E986A7A51","user_header":"https://static001.geekbang.org/account/avatar/00/21/63/6e/6b971571.jpg","comment_is_top":false,"comment_ctime":1619342685,"is_pvip":true,"replies":[{"id":"105204","content":"æ²¡é”™~","user_name":"ä½œè€…å›å¤","comment_id":290060,"uid":"1043100","ip_address":"","utype":1,"ctime":1619434842,"user_name_real":"å´ç£Š"}],"discussion_count":1,"race_medal":0,"score":"5914309981","product_id":100073401,"comment_content":"getBytes&#47;getValueçš„å®ç°æ–¹æ³•æ˜¯é€šè¿‡BlockIDåŠ é”è®¿é—®entryã€‚Byteè·å¾—æ˜¯åºåˆ—åŒ–ä¹‹åçš„å­—èŠ‚æµï¼Œå…·æœ‰ChunkedByteBufferå±æ€§ï¼Œå­˜å‚¨ç±»å‹å±æ€§ï¼Œå¯¹è±¡ç±»å‹å±æ€§ã€‚Valuesè·å¾—æ˜¯éåºåˆ—åŒ–çš„å¯¹è±¡ï¼Œè¿”å›å¯¹è±¡æ•°ç»„ï¼Œå¯¹è±¡å¤§å°ï¼Œå¯¹è±¡ç±»å‹ï¼ŒMemoryEntryçš„Modeæ˜¯å †ä¸Šå­˜å‚¨ã€‚","like_count":1,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":519099,"discussion_content":"æ²¡é”™~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619434842,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":354263,"user_name":"Geek_5b7d28","can_delete":false,"product_type":"c1","uid":2057476,"ip_address":"åŒ—äº¬","ucode":"BAA1CDD539C369","user_header":"","comment_is_top":false,"comment_ctime":1660225640,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1660225640","product_id":100073401,"comment_content":"ç›¸æ¯”é¢‘ç¹çš„å±•å¼€ã€ç‰©åŒ–ã€æ¢é¡µæ‰€å¸¦æ¥çš„æ€§èƒ½å¼€é”€ï¼Œç¼“å­˜ä¸‹æ¥çš„éƒ¨åˆ†æ•°æ®å¯¹äº RDD é«˜æ•ˆè®¿é—®çš„è´¡çŒ®å¯ä»¥è¯´å¾®ä¹å…¶å¾®ã€‚<br>è€å¸ˆï¼Œè¿™å¥è¯æ€ä¹ˆç†è§£å‘¢","like_count":0},{"had_liked":false,"id":324631,"user_name":"Unknown element","can_delete":false,"product_type":"c1","uid":2028277,"ip_address":"","ucode":"34A129800D0238","user_header":"https://static001.geekbang.org/account/avatar/00/1e/f2/f5/b82f410d.jpg","comment_is_top":false,"comment_ctime":1638521704,"is_pvip":false,"replies":[{"id":"117820","content":"è€å¼Ÿå¯ä»¥åœ¨å›é¡¾ä¸‹è¿™é‡Œå“ˆï¼š<br>â€œ<br>æ—¢ç„¶è¦æŠŠæ•°æ®å†…å®¹ç¼“å­˜ä¸‹æ¥ï¼Œè‡ªç„¶å¾—å…ˆæŠŠ RDD çš„è¿­ä»£å™¨å±•å¼€æˆå®å®åœ¨åœ¨çš„æ•°æ®å€¼æ‰è¡Œã€‚å› æ­¤ï¼Œç¬¬ä¸€æ­¥å°±æ˜¯é€šè¿‡è°ƒç”¨ putIteratorAsValues æˆ–æ˜¯ putIteratorAsBytes æ–¹æ³•ï¼ŒæŠŠ RDD è¿­ä»£å™¨å±•å¼€ä¸ºæ•°æ®å€¼ï¼Œç„¶åæŠŠè¿™äº›æ•°æ®å€¼æš‚å­˜åˆ°ä¸€ä¸ªå«åš ValuesHolder çš„æ•°æ®ç»“æ„é‡Œã€‚è¿™ä¸€æ­¥ï¼Œæˆ‘ä»¬é€šå¸¸æŠŠå®ƒå«åšâ€œUnrollâ€ã€‚ç¬¬äºŒæ­¥ï¼Œä¸ºäº†èŠ‚çœå†…å­˜å¼€é”€ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å­˜å‚¨æ•°æ®å€¼çš„ ValuesHolder ä¸Šç›´æ¥è°ƒç”¨ toArray æˆ–æ˜¯ toByteBuffer æ“ä½œï¼ŒæŠŠ ValuesHolder è½¬æ¢ä¸º MemoryEntry æ•°æ®ç»“æ„ã€‚æ³¨æ„å•¦ï¼Œè¿™ä¸€æ­¥çš„è½¬æ¢ä¸æ¶‰åŠå†…å­˜æ‹·è´ï¼Œä¹Ÿä¸äº§ç”Ÿé¢å¤–çš„å†…å­˜å¼€é”€ï¼Œå› æ­¤ Spark å®˜æ–¹æŠŠè¿™ä¸€æ­¥å«åšâ€œä» Unroll memory åˆ° Storage memory çš„ Transferï¼ˆè½¬ç§»ï¼‰â€ã€‚ç¬¬ä¸‰æ­¥ï¼Œè¿™äº›åŒ…å« RDD æ•°æ®å€¼çš„ MemoryEntry å’Œä¸ä¹‹å¯¹åº”çš„ BlockIdï¼Œä¼šè¢«ä¸€èµ·å­˜å…¥ Key ä¸º BlockIdã€Value æ˜¯ MemoryEntry å¼•ç”¨çš„é“¾å¼å“ˆå¸Œå­—å…¸ä¸­ã€‚å› æ­¤ï¼ŒLinkedHashMap[BlockId, MemoryEntry]ç¼“å­˜çš„æ˜¯å…³äºæ•°æ®å­˜å‚¨çš„å…ƒæ•°æ®ï¼ŒMemoryEntry æ‰æ˜¯çœŸæ­£ä¿å­˜ RDD æ•°æ®å®ä½“çš„å­˜å‚¨å•å…ƒã€‚æ¢å¥è¯è¯´ï¼Œå¤§é¢ç§¯å ç”¨å†…å­˜çš„ä¸æ˜¯å“ˆå¸Œå­—å…¸ï¼Œè€Œæ˜¯ä¸€ä¸ªåˆä¸€ä¸ªçš„ MemoryEntryã€‚<br>â€<br><br>å¯ä»¥è¿™ä¹ˆç®€å•æ¥ç†è§£ï¼ŒLinkedHashMapä»…ä»…æ˜¯å­˜å‚¨å…³äºCacheçš„å…ƒæ•°æ®ï¼Œå®ƒæœ¬èº«å ç”¨çš„å†…å­˜ç©ºé—´å¹¶ä¸å¤§ï¼ŒçœŸæ­£å ç”¨å†…å­˜çš„ï¼Œæ˜¯ä¸€ä¸ªåˆä¸€ä¸ªMemoryEntryï¼Œè¿™é‡Œé¢å­˜å‚¨çš„ï¼Œæ˜¯å®å®åœ¨åœ¨çš„åˆ†åŒºæ•°æ®ã€‚<br><br>å…³äºIteratoré‚£é‡Œï¼Œè€å¼Ÿéœ€è¦åœ¨æ¸©ä¹ ä¸‹DAGçš„æ¦‚å¿µå“ˆï¼ŒDAGä¸­çš„æ‰€æœ‰ç®—å­çš„è®¡ç®—ï¼Œå®é™…ä¸Šéƒ½æ˜¯ä»¥è¿­ä»£å™¨çš„æ–¹å¼ï¼Œä»æºå¤´è®¿é—®å¹¶è¯»å–æ•°æ®ï¼Œåˆ°äº†Cacheè¿™ä¸€æ­¥ï¼Œéœ€è¦æŠŠIteratorå±•å¼€æˆå®å®åœ¨åœ¨çš„æ•°æ®ï¼Œç„¶ååœ¨èµ°Cacheåé¢çš„2ã€3ä¸¤æ­¥~","user_name":"ä½œè€…å›å¤","comment_id":324631,"uid":"1043100","ip_address":"","utype":1,"ctime":1638611380,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"1638521704","product_id":100073401,"comment_content":"è€å¸ˆæˆ‘æƒ³é—®å‡ ä¸ªé—®é¢˜ï¼š<br>1ã€rddç¼“å­˜çš„ç»ˆç‚¹ LinkedHashMap æ˜¯æºå¸¦äº†å…¨é‡æ•°æ®è¢«å­˜å‚¨åˆ°å†…å­˜ä¸­äº†å—ï¼Ÿ<br>2ã€rddç¼“å­˜çš„èµ·ç‚¹ iterator ä¼šæœ‰ç£ç›˜ioå—ï¼Ÿå¦‚æœæ²¡æœ‰çš„è¯ä¸ºä»€ä¹ˆè¦è°ƒç”¨ä¸€ç³»åˆ—å‡½æ•°æŠŠrddæ¢ä¸€ç§æ•°æ®ç»“æ„ï¼ˆLinkedHashMapï¼‰å­˜åˆ°å†…å­˜ä¸­å‘¢ï¼ˆæ˜¯å› ä¸ºè¿™ç§æ•°æ®ç»“æ„æ”¯æŒéšæœºè¯»å–å—ï¼‰ï¼Ÿå¦‚æœæœ‰çš„è¯é‚£è¯»å–rddç¼“å­˜çš„æ—¶å€™ä½¿ç”¨ blockId ä» linkedHashMap è·å– memoryEntryï¼Œç„¶åè½¬æ¢æˆ Iterator è¿”å›ï¼Œå²‚ä¸æ˜¯ä»â€œçº¯å†…å­˜è¯»å–â€å˜æˆäº†â€œéœ€è¦ç£ç›˜ioâ€ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":535931,"discussion_content":"è€å¼Ÿå¯ä»¥åœ¨å›é¡¾ä¸‹è¿™é‡Œå“ˆï¼š\nâ€œ\næ—¢ç„¶è¦æŠŠæ•°æ®å†…å®¹ç¼“å­˜ä¸‹æ¥ï¼Œè‡ªç„¶å¾—å…ˆæŠŠ RDD çš„è¿­ä»£å™¨å±•å¼€æˆå®å®åœ¨åœ¨çš„æ•°æ®å€¼æ‰è¡Œã€‚å› æ­¤ï¼Œç¬¬ä¸€æ­¥å°±æ˜¯é€šè¿‡è°ƒç”¨ putIteratorAsValues æˆ–æ˜¯ putIteratorAsBytes æ–¹æ³•ï¼ŒæŠŠ RDD è¿­ä»£å™¨å±•å¼€ä¸ºæ•°æ®å€¼ï¼Œç„¶åæŠŠè¿™äº›æ•°æ®å€¼æš‚å­˜åˆ°ä¸€ä¸ªå«åš ValuesHolder çš„æ•°æ®ç»“æ„é‡Œã€‚è¿™ä¸€æ­¥ï¼Œæˆ‘ä»¬é€šå¸¸æŠŠå®ƒå«åšâ€œUnrollâ€ã€‚ç¬¬äºŒæ­¥ï¼Œä¸ºäº†èŠ‚çœå†…å­˜å¼€é”€ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å­˜å‚¨æ•°æ®å€¼çš„ ValuesHolder ä¸Šç›´æ¥è°ƒç”¨ toArray æˆ–æ˜¯ toByteBuffer æ“ä½œï¼ŒæŠŠ ValuesHolder è½¬æ¢ä¸º MemoryEntry æ•°æ®ç»“æ„ã€‚æ³¨æ„å•¦ï¼Œè¿™ä¸€æ­¥çš„è½¬æ¢ä¸æ¶‰åŠå†…å­˜æ‹·è´ï¼Œä¹Ÿä¸äº§ç”Ÿé¢å¤–çš„å†…å­˜å¼€é”€ï¼Œå› æ­¤ Spark å®˜æ–¹æŠŠè¿™ä¸€æ­¥å«åšâ€œä» Unroll memory åˆ° Storage memory çš„ Transferï¼ˆè½¬ç§»ï¼‰â€ã€‚ç¬¬ä¸‰æ­¥ï¼Œè¿™äº›åŒ…å« RDD æ•°æ®å€¼çš„ MemoryEntry å’Œä¸ä¹‹å¯¹åº”çš„ BlockIdï¼Œä¼šè¢«ä¸€èµ·å­˜å…¥ Key ä¸º BlockIdã€Value æ˜¯ MemoryEntry å¼•ç”¨çš„é“¾å¼å“ˆå¸Œå­—å…¸ä¸­ã€‚å› æ­¤ï¼ŒLinkedHashMap[BlockId, MemoryEntry]ç¼“å­˜çš„æ˜¯å…³äºæ•°æ®å­˜å‚¨çš„å…ƒæ•°æ®ï¼ŒMemoryEntry æ‰æ˜¯çœŸæ­£ä¿å­˜ RDD æ•°æ®å®ä½“çš„å­˜å‚¨å•å…ƒã€‚æ¢å¥è¯è¯´ï¼Œå¤§é¢ç§¯å ç”¨å†…å­˜çš„ä¸æ˜¯å“ˆå¸Œå­—å…¸ï¼Œè€Œæ˜¯ä¸€ä¸ªåˆä¸€ä¸ªçš„ MemoryEntryã€‚\nâ€\n\nå¯ä»¥è¿™ä¹ˆç®€å•æ¥ç†è§£ï¼ŒLinkedHashMapä»…ä»…æ˜¯å­˜å‚¨å…³äºCacheçš„å…ƒæ•°æ®ï¼Œå®ƒæœ¬èº«å ç”¨çš„å†…å­˜ç©ºé—´å¹¶ä¸å¤§ï¼ŒçœŸæ­£å ç”¨å†…å­˜çš„ï¼Œæ˜¯ä¸€ä¸ªåˆä¸€ä¸ªMemoryEntryï¼Œè¿™é‡Œé¢å­˜å‚¨çš„ï¼Œæ˜¯å®å®åœ¨åœ¨çš„åˆ†åŒºæ•°æ®ã€‚\n\nå…³äºIteratoré‚£é‡Œï¼Œè€å¼Ÿéœ€è¦åœ¨æ¸©ä¹ ä¸‹DAGçš„æ¦‚å¿µå“ˆï¼ŒDAGä¸­çš„æ‰€æœ‰ç®—å­çš„è®¡ç®—ï¼Œå®é™…ä¸Šéƒ½æ˜¯ä»¥è¿­ä»£å™¨çš„æ–¹å¼ï¼Œä»æºå¤´è®¿é—®å¹¶è¯»å–æ•°æ®ï¼Œåˆ°äº†Cacheè¿™ä¸€æ­¥ï¼Œéœ€è¦æŠŠIteratorå±•å¼€æˆå®å®åœ¨åœ¨çš„æ•°æ®ï¼Œç„¶ååœ¨èµ°Cacheåé¢çš„2ã€3ä¸¤æ­¥~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638611380,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":320361,"user_name":"ã€†ã€ç»´ç”Ÿç´ ã‚","can_delete":false,"product_type":"c1","uid":1230071,"ip_address":"","ucode":"7A2AB5A26F0F49","user_header":"https://static001.geekbang.org/account/avatar/00/12/c4/f7/3cff78f1.jpg","comment_is_top":false,"comment_ctime":1636277358,"is_pvip":false,"replies":[{"id":"116286","content":"æ²¡é”™ï¼Œä»æœ¬åœ°çš„BlockManagerè·å–ï¼ŒBlockManagerä¼šå®šæœŸå’ŒBlockManagerMasteråŒæ­¥ï¼Œè·å–å…¨å±€çš„Blockä¿¡æ¯ï¼Œå› æ­¤ï¼Œæ¯ä¸ªBlockManagerï¼Œæ‰‹é‡Œéƒ½æœ‰ä¸€ä»½å®Œæ•´çš„å…ƒä¿¡æ¯æ‹·è´ï¼Œè¿™äº›ä¿¡æ¯éƒ½æ˜¯é€šè¿‡å¿ƒè·³æœºåˆ¶æ¥åŒæ­¥çš„~","user_name":"ä½œè€…å›å¤","comment_id":320361,"uid":"1043100","ip_address":"","utype":1,"ctime":1636435337,"user_name_real":"å´ç£Š"}],"discussion_count":1,"race_medal":0,"score":"1636277358","product_id":100073401,"comment_content":"è¯·æ•™ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨reducesulté˜¶æ®µæ‹‰å–æ•°æ®çš„æ—¶å€™ï¼Œç¨‹åºæ˜¯å¦‚ä½•åšåˆ°ç²¾ç¡®æ‰¾åˆ°æ•°æ®ä½ç½®å•Š ï¼Ÿä»BlockManagerMasterè·å–ä¿¡æ¯ BlockManagerè·¨èŠ‚ç‚¹åŒæ­¥","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":529967,"discussion_content":"æ²¡é”™ï¼Œä»æœ¬åœ°çš„BlockManagerè·å–ï¼ŒBlockManagerä¼šå®šæœŸå’ŒBlockManagerMasteråŒæ­¥ï¼Œè·å–å…¨å±€çš„Blockä¿¡æ¯ï¼Œå› æ­¤ï¼Œæ¯ä¸ªBlockManagerï¼Œæ‰‹é‡Œéƒ½æœ‰ä¸€ä»½å®Œæ•´çš„å…ƒä¿¡æ¯æ‹·è´ï¼Œè¿™äº›ä¿¡æ¯éƒ½æ˜¯é€šè¿‡å¿ƒè·³æœºåˆ¶æ¥åŒæ­¥çš„~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1636435337,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":320056,"user_name":"ç¦","can_delete":false,"product_type":"c1","uid":2455712,"ip_address":"","ucode":"F2FC7AF5D433C6","user_header":"https://static001.geekbang.org/account/avatar/00/25/78/a0/7a248ddc.jpg","comment_is_top":false,"comment_ctime":1636070402,"is_pvip":true,"replies":[{"id":"116043","content":"linkdhashmapè¿™ä¸ªæ•°æ®ç»“æ„ï¼Œæ¯ä¸ªExecutorséƒ½ä¼šå­˜ä¸€ä»½ï¼Œéš¶å±äºæ¯ä¸ªExecutorsä¸­BlockManagerçš„ä¸€éƒ¨åˆ†ã€‚Executorsçš„BlockManagerï¼Œä¸Driverçš„BlockManagerMasterï¼Œå¯ä»¥ç†è§£æˆæ˜¯å­ä¸çˆ¶çš„å…³ç³»ã€‚Driverçš„BlockManagerMasterï¼Œå¯¹äºlinkdhashmapæœ‰å…¨å±€è§†è§’ï¼Œå…¶ä»–Executorsä»Driverçš„BlockManagerMasteråŒæ­¥ä¿¡æ¯ï¼Œç„¶åé€æ­¥å®Œå–„è‡ªå·±çš„linkdhashmapå†…å®¹ã€‚<br><br>æˆ‘ç†è§£è¿™ä¸ªé—®é¢˜çš„é‡ç‚¹ï¼Œå…¶å®æœ¬è´¨ä¸Šæ˜¯BlockManagerä¸BlockManagerMasterçš„å…³ç³»ï¼Œä»¥åŠExecutorsä¸Driverçš„å…³ç³»ï¼Œä¸æ­¢æ˜¯linkdhashmapï¼Œå…¶ä»–çš„å­˜å‚¨ä¿¡æ¯ï¼Œä¹Ÿéƒ½æ˜¯ç±»ä¼¼çš„å…³ç³»ã€‚å°±æ˜¯ï¼ŒBlockManagerMasterç»´æŒå…¨å±€ä¿¡æ¯ï¼ŒBlockManagerä»BlockManagerMasterè·å–å¹¶åŒæ­¥å…¨å±€ä¿¡æ¯ã€‚å½“ç„¶ï¼ŒBlockManagerMasterçš„å…¨å±€ä¿¡æ¯ï¼Œä¹Ÿæ˜¯æ¥è‡ªä¸€ä¸ªä¸ªçš„BlockManager~","user_name":"ä½œè€…å›å¤","comment_id":320056,"uid":"1043100","ip_address":"","utype":1,"ctime":1636095632,"user_name_real":"å´ç£Š"}],"discussion_count":2,"race_medal":0,"score":"1636070402","product_id":100073401,"comment_content":"è€å¸ˆï¼Œæ‚¨å¥½ï¼Œæ–‡ä¸­è¯´  ä½ å¯èƒ½ä¼šé—®ï¼šâ€œå¦‚æœå†…å­˜ç©ºé—´ä¸è¶³ä»¥å®¹çº³æ•´ä¸ª RDD æ€ä¹ˆåŠï¼Ÿâ€ æ‚¨è¿™è¾¹ä¸»è¦æ˜¯è¯´çš„lruç®—æ³•æ¥åˆ é™¤æœ€è¿‘çš„ï¼Œï¼Œï¼Œï¼Œæˆ‘è¿™ä¸ªåœ°æ–¹ä¸æ˜¯å¾ˆç†è§£ï¼ŒlinkedHashMapå­˜å‚¨äº†blockidå’ŒmemoryEntryï¼Œå®ƒä¸æ˜¯å­˜å‚¨çš„å®Œæ•´çš„ä¸€ä¸ªrddå§ï¼Œæ¯”å¦‚ mapå¾—åˆ°çš„rdd.cache Aï¼Œfilterå¾—åˆ°çš„rdd.catch  Bï¼Œé‚£ä¹ˆrdd Aå’Œrdd Båº”è¯¥ç¼“å­˜åœ¨å¤šä¸ªexecutorçš„linkdhashmapä¸­ï¼Œ è€Œä¸æ˜¯ä¸€ä¸ªlinkdhashmapæ¥å­˜å‚¨æ•´ä¸ªrdd blockidå’ŒmemoryEntry","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":529857,"discussion_content":"linkdhashmapè¿™ä¸ªæ•°æ®ç»“æ„ï¼Œæ¯ä¸ªExecutorséƒ½ä¼šå­˜ä¸€ä»½ï¼Œéš¶å±äºæ¯ä¸ªExecutorsä¸­BlockManagerçš„ä¸€éƒ¨åˆ†ã€‚Executorsçš„BlockManagerï¼Œä¸Driverçš„BlockManagerMasterï¼Œå¯ä»¥ç†è§£æˆæ˜¯å­ä¸çˆ¶çš„å…³ç³»ã€‚Driverçš„BlockManagerMasterï¼Œå¯¹äºlinkdhashmapæœ‰å…¨å±€è§†è§’ï¼Œå…¶ä»–Executorsä»Driverçš„BlockManagerMasteråŒæ­¥ä¿¡æ¯ï¼Œç„¶åé€æ­¥å®Œå–„è‡ªå·±çš„linkdhashmapå†…å®¹ã€‚\n\næˆ‘ç†è§£è¿™ä¸ªé—®é¢˜çš„é‡ç‚¹ï¼Œå…¶å®æœ¬è´¨ä¸Šæ˜¯BlockManagerä¸BlockManagerMasterçš„å…³ç³»ï¼Œä»¥åŠExecutorsä¸Driverçš„å…³ç³»ï¼Œä¸æ­¢æ˜¯linkdhashmapï¼Œå…¶ä»–çš„å­˜å‚¨ä¿¡æ¯ï¼Œä¹Ÿéƒ½æ˜¯ç±»ä¼¼çš„å…³ç³»ã€‚å°±æ˜¯ï¼ŒBlockManagerMasterç»´æŒå…¨å±€ä¿¡æ¯ï¼ŒBlockManagerä»BlockManagerMasterè·å–å¹¶åŒæ­¥å…¨å±€ä¿¡æ¯ã€‚å½“ç„¶ï¼ŒBlockManagerMasterçš„å…¨å±€ä¿¡æ¯ï¼Œä¹Ÿæ˜¯æ¥è‡ªä¸€ä¸ªä¸ªçš„BlockManager~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1636095632,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1221146,"avatar":"https://static001.geekbang.org/account/avatar/00/12/a2/1a/f2c8988b.jpg","nickname":"èè‰å·´ç´¢å°å¸ƒä¸","note":"","ucode":"00C285326B8C77","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":534702,"discussion_content":"è€å¸ˆï¼Œå°±è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘è¿˜æƒ³é—®ï¼Œæç«¯æƒ…å†µä¸‹ï¼Œå³ä½¿æ¸…é™¤æ‰€æœ‰çš„blocksï¼Œå†…å­˜ç©ºé—´ä¹Ÿæ— æ³•å®¹çº³æ•´ä¸ªRDDæ—¶ï¼Œå°±ä¼šå˜æˆç£ç›˜å­˜å‚¨å—ï¼Ÿè¿˜æ˜¯è¯´ä¼šOOMï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638259638,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":529857,"ip_address":""},"score":534702,"extra":""}]}]},{"had_liked":false,"id":290058,"user_name":"Zå®‡é”¤é”¤","can_delete":false,"product_type":"c1","uid":2188142,"ip_address":"","ucode":"7DB36E986A7A51","user_header":"https://static001.geekbang.org/account/avatar/00/21/63/6e/6b971571.jpg","comment_is_top":false,"comment_ctime":1619341732,"is_pvip":true,"replies":[{"id":"105205","content":"å¯¹ï¼Œç”¨BlockIdå»LinkedHashMapé‡Œé¢æ£€ç´¢å°±è¡Œ~","user_name":"ä½œè€…å›å¤","comment_id":290058,"uid":"1043100","ip_address":"","utype":1,"ctime":1619434954,"user_name_real":"å´ç£Š"}],"discussion_count":1,"race_medal":0,"score":"1619341732","product_id":100073401,"comment_content":"MemoryStoreé€šè¿‡partitionå¯¹åº”çš„BlockIDè·å¾—å¯¹åº”çš„partition MemoryEntryã€‚","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":519097,"discussion_content":"å¯¹ï¼Œç”¨BlockIdå»LinkedHashMapé‡Œé¢æ£€ç´¢å°±è¡Œ~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619434954,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":288466,"user_name":"William","can_delete":false,"product_type":"c1","uid":2086573,"ip_address":"","ucode":"EC29D9CD616183","user_header":"https://static001.geekbang.org/account/avatar/00/1f/d6/ad/850992a5.jpg","comment_is_top":false,"comment_ctime":1618480178,"is_pvip":false,"replies":[{"id":"104694","content":"æ²¡äº‹ï¼Œåˆ«ç€æ€¥å…„å¼Ÿï¼Œè¯´è¯´ç»†èŠ‚ï¼Œå› ä¸ºä½ è¿™ä¹ˆè¯´ï¼Œæˆ‘æ¯”è¾ƒéš¾åˆ¤æ–­ã€‚æ¯”å¦‚è¯´ï¼š<br><br>1. ä»€ä¹ˆæ¨¡å‹ï¼ŸLRï¼ŸSVMï¼Ÿæ ‘æ¨¡å‹ï¼ˆRFè¿˜æ˜¯GBDTï¼‰ï¼ŸK-Meansï¼Ÿè¿˜æ˜¯DNNï¼Ÿ<br>2. Data schemaï¼Œæ•°æ®æ¨¡å¼æ˜¯ä»€ä¹ˆï¼Ÿä¹Ÿå°±æ˜¯ä½ çš„è®­ç»ƒæ ·æœ¬ï¼Œéƒ½åŒ…å«å“ªäº›å­—æ®µï¼Ÿéƒ½æ˜¯ä»€ä¹ˆç±»å‹ï¼Ÿæ•°æ®æ˜¯å¦å½’ä¸€åŒ–ï¼Ÿ<br>3. æ¨¡å‹è¶…å‚æ•°ï¼Œæ¯”å¦‚ï¼Œepochã€learning rateã€æ ‘æ·±ã€å¤šå°‘æ£µæ ‘ã€å¤šå°‘å±‚layersã€æ¿€æ´»å‡½æ•°ã€ä¼˜åŒ–ç®—æ³•ï¼ˆSGDã€Adamï¼‰ï¼Ÿç­‰ç­‰ã€‚è¶…å‚æœ¬èº«ä¼šå½±å“æ¨¡å‹è®­ç»ƒçš„æ‰§è¡Œæ€§èƒ½ï¼Œæ¯”å¦‚learning rateå¤ªä½ï¼Œå°±ä¼šå½±å“æ¨¡å‹æ”¶æ•›æ•ˆç‡ã€‚å†æ¯”å¦‚ä¼˜åŒ–ç®—æ³•ï¼Œæ‰§è¡Œæ•ˆç‡ä¸Šé¢å·®çš„æ›´å¤šã€‚<br>4. ç¼“å­˜çš„æ¯”ä¾‹ï¼Œæ˜¯ä¸æ˜¯100%ï¼Ÿè¿˜æ˜¯åªç¼“å­˜äº†ä¸€éƒ¨åˆ†ï¼Ÿ<br><br>æœŸå¾…ä½ çš„ç•™è¨€ï¼Œæˆ‘ä»¬ä¸€èµ·æŠŠé—®é¢˜æå®š~","user_name":"ä½œè€…å›å¤","comment_id":288466,"uid":"1043100","ip_address":"","utype":1,"ctime":1618485073,"user_name_real":"å´ç£Š"}],"discussion_count":4,"race_medal":0,"score":"1618480178","product_id":100073401,"comment_content":"è€å¸ˆï¼Œæ‚¨å¥½ã€‚æˆ‘åˆšåˆšæ¥è§¦sparkï¼Œçœ‹ä½ çš„ä¸“æ å®åœ¨æ”¶è·è‰¯å¤šï¼Œéå¸¸æ„Ÿè°¢ï¼åœ¨è¿™é‡Œå¿ƒæ€¥çš„å‘ä½ è¯·æ•™ä¸€ä¸ªé—®é¢˜ï¼šåœ¨ä½¿ç”¨sparkè®­ç»ƒæ¨¡å‹å‘ç°ï¼šä»…20Wçš„æ•°æ®ï¼Œæ•°æ®æ˜¯ç¼“å­˜åˆ°å†…å­˜çš„ï¼Œä½†æ¨¡å‹è®­ç»ƒæ—¶é—´é•¿è¾¾4-5hï¼Œå®Œå…¨ä¸çŸ¥æ”¹ä»ä½•å¤„å…¥æ‰‹è°ƒä¼˜ï¼Œéº»çƒ¦è€å¸ˆç»™äºˆæŒ‡ç‚¹ã€‚","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":518632,"discussion_content":"æ²¡äº‹ï¼Œåˆ«ç€æ€¥å…„å¼Ÿï¼Œè¯´è¯´ç»†èŠ‚ï¼Œå› ä¸ºä½ è¿™ä¹ˆè¯´ï¼Œæˆ‘æ¯”è¾ƒéš¾åˆ¤æ–­ã€‚æ¯”å¦‚è¯´ï¼š\n\n1. ä»€ä¹ˆæ¨¡å‹ï¼ŸLRï¼ŸSVMï¼Ÿæ ‘æ¨¡å‹ï¼ˆRFè¿˜æ˜¯GBDTï¼‰ï¼ŸK-Meansï¼Ÿè¿˜æ˜¯DNNï¼Ÿ\n2. Data schemaï¼Œæ•°æ®æ¨¡å¼æ˜¯ä»€ä¹ˆï¼Ÿä¹Ÿå°±æ˜¯ä½ çš„è®­ç»ƒæ ·æœ¬ï¼Œéƒ½åŒ…å«å“ªäº›å­—æ®µï¼Ÿéƒ½æ˜¯ä»€ä¹ˆç±»å‹ï¼Ÿæ•°æ®æ˜¯å¦å½’ä¸€åŒ–ï¼Ÿ\n3. æ¨¡å‹è¶…å‚æ•°ï¼Œæ¯”å¦‚ï¼Œepochã€learning rateã€æ ‘æ·±ã€å¤šå°‘æ£µæ ‘ã€å¤šå°‘å±‚layersã€æ¿€æ´»å‡½æ•°ã€ä¼˜åŒ–ç®—æ³•ï¼ˆSGDã€Adamï¼‰ï¼Ÿç­‰ç­‰ã€‚è¶…å‚æœ¬èº«ä¼šå½±å“æ¨¡å‹è®­ç»ƒçš„æ‰§è¡Œæ€§èƒ½ï¼Œæ¯”å¦‚learning rateå¤ªä½ï¼Œå°±ä¼šå½±å“æ¨¡å‹æ”¶æ•›æ•ˆç‡ã€‚å†æ¯”å¦‚ä¼˜åŒ–ç®—æ³•ï¼Œæ‰§è¡Œæ•ˆç‡ä¸Šé¢å·®çš„æ›´å¤šã€‚\n4. ç¼“å­˜çš„æ¯”ä¾‹ï¼Œæ˜¯ä¸æ˜¯100%ï¼Ÿè¿˜æ˜¯åªç¼“å­˜äº†ä¸€éƒ¨åˆ†ï¼Ÿ\n\næœŸå¾…ä½ çš„ç•™è¨€ï¼Œæˆ‘ä»¬ä¸€èµ·æŠŠé—®é¢˜æå®š~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618485073,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2162751,"avatar":"https://static001.geekbang.org/account/avatar/00/21/00/3f/a0f84788.jpg","nickname":"Sean","note":"","ucode":"69234046BFD81B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":390018,"discussion_content":"Perfect x 2","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629604434,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2086573,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/d6/ad/850992a5.jpg","nickname":"William","note":"","ucode":"EC29D9CD616183","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":367946,"discussion_content":"1.æ¨¡å‹æ˜¯GBDTï¼ŒåšäºŒåˆ†ç±»é¢„æµ‹ã€‚\n2.æ ·æœ¬å…±30ä¸ªç‰¹å¾å­—æ®µï¼ŒåŒ…æ‹¬æ•°å€¼å’Œç¦»æ•£æ ‡ç­¾ï¼Œå› ä¸ºæ˜¯æ ‘æ¨¡å‹ï¼Œæœªåšå½’ä¸€åŒ–ã€‚\n3.è¶…å‚æ•°åŸºæœ¬æœªåšå¤ªå¤šè°ƒæ•´ï¼ŒmaxIter=200ï¼ŒstepSize=0.1, maxDepth=7ï¼ŒminInstancePerNode=10ã€‚\n4.ç¼“å­˜æ¯”ä¾‹è¯´æ˜¯spark.storage.memoryFraction å‚æ•°å—ï¼Œä»¥é»˜è®¤0.6ï¼Œæœªä¿®æ”¹ã€‚\nå¦å¤–:executorMemory = 8Gï¼ŒexecutorCores=2, numExecutor=10, defaultParallelism=30","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618499587,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":2086573,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/d6/ad/850992a5.jpg","nickname":"William","note":"","ucode":"EC29D9CD616183","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":370495,"discussion_content":"ä»ä¸¤ä¸ªæ–¹é¢æ¥è¯´ï¼š\n\n1. æ¨¡å‹è¶…å‚ï¼š\n1ï¼‰è¿­ä»£æ¬¡æ•°å¤ªå¤šäº†ï¼Œ100å°±è¡Œï¼ŒmaxIter=200ï¼Œå®¹æ˜“è¿‡æ‹Ÿåˆï¼Œå½“ç„¶ï¼Œè¿˜è¦ç»“åˆä½ çš„å…·ä½“æƒ…å†µï¼Œæˆ‘ç†è§£20wçš„æ•°æ®ï¼Œä½“é‡éå¸¸å°äº†ï¼Œ100éƒ½å¤šï¼Œå¯èƒ½50å°±è¡Œã€‚æˆ‘ä»¬è¿™è¾¹ä¸Šäº¿çš„æ•°æ®ï¼Œä¹Ÿæ‰éœ€è¦100æ¬¡è¿­ä»£ï¼›\n2ï¼‰maxDepthï¼Œæ ‘å¤ªæ·±äº†ï¼Œ5å°±è¡Œï¼Œ7å®¹æ˜“è¿‡æ‹Ÿåˆï¼Œ4-5æ˜¯ä¸é”™çš„é€‰æ‹©ï¼Œç”šè‡³3éƒ½è¡Œï¼›\n3ï¼‰æŠŠcacheç”¨ä¸Šï¼ŒæŠŠä½ çš„training samplesï¼Œcacheåˆ°å†…å­˜é‡Œé¢å»ï¼Œé»˜è®¤çš„cache modeå°±è¡Œï¼Œ20Wæ ·æœ¬ï¼Œç¼“å­˜å®Œå…¨èƒ½æ”¾ï¼›\n\n2. ç³»ç»Ÿé›†æˆï¼š\nGBDTèƒ½æå®šçš„äº‹æƒ…ï¼ŒXGBéƒ½èƒ½æå®šï¼Œå¯ä»¥ç”¨XGB over Sparkï¼ˆXGBoost4J-Sparkï¼‰çš„é›†æˆæ–¹å¼æ¥æå®šæ ‘æ¨¡å‹ã€‚XGBæœ¬èº«åœ¨å·¥ç¨‹ä¸Šæœ‰å¹¶è¡Œä¼˜åŒ–ï¼Œç®—æ³•ä¸Šä¹Ÿæœ‰ä¼˜åŒ–ï¼Œç›¸æ¯”GBDTï¼Œæ‰§è¡Œé€Ÿåº¦å¿«ã€æ”¶æ•›é€Ÿåº¦ä¹Ÿæ›´å¿«","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1619434787,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":367946,"ip_address":""},"score":370495,"extra":""}]}]},{"had_liked":false,"id":285340,"user_name":"L3nvy","can_delete":false,"product_type":"c1","uid":1271157,"ip_address":"","ucode":"0B74B27C121D56","user_header":"https://static001.geekbang.org/account/avatar/00/13/65/75/f9d7e8b7.jpg","comment_is_top":false,"comment_ctime":1616747169,"is_pvip":false,"replies":[{"id":"103560","content":"Perfectï¼ç¬¬äºŒé¢˜å‘¢ï¼Ÿ","user_name":"ä½œè€…å›å¤","comment_id":285340,"uid":"1043100","ip_address":"","utype":1,"ctime":1616757877,"user_name_real":"å´ç£Š"}],"discussion_count":1,"race_medal":0,"score":"1616747169","product_id":100073401,"comment_content":"1. é€šè¿‡blockIdåœ¨LinkedHashMap[BlockId, MemoryEntry]ä¸­è·å–MemoryEntryï¼ŒgetBytesè¿”å›SerializedMemoryEntryä¸­çš„ByteBufferï¼Œç„¶åè¿˜éœ€è¦ååºåˆ—åŒ–æˆè¿­ä»£å™¨æ‰èƒ½è¢«ä½¿ç”¨ï¼›getValuesè¿”å›DeserializedMemoryEntryä¸­çš„Array[T]å¹¶è½¬æ¢æˆè¿­ä»£å™¨ä½¿ç”¨ï¼›","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":517648,"discussion_content":"Perfectï¼ç¬¬äºŒé¢˜å‘¢ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1616757877,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":285324,"user_name":"Stony.ä¿®è¡Œåƒ§","can_delete":false,"product_type":"c1","uid":1061277,"ip_address":"","ucode":"0F2368F7D93E4A","user_header":"https://static001.geekbang.org/account/avatar/00/10/31/9d/daad92d2.jpg","comment_is_top":false,"comment_ctime":1616741100,"is_pvip":false,"replies":[{"id":"103561","content":"ç¬¬ä¸€é¢˜èƒ½å†å±•å¼€è¯´è¯´å—ï¼Ÿ æ¯”å¦‚å…·ä½“æ€ä¹ˆæ“ä½œï¼Ÿ<br><br>ç¬¬äºŒé¢˜å†æƒ³æƒ³å“ˆï¼Œå‚è€ƒrdd cacheçš„è¿‡ç¨‹ï½","user_name":"ä½œè€…å›å¤","comment_id":285324,"uid":"1043100","ip_address":"","utype":1,"ctime":1616757987,"user_name_real":"å´ç£Š"}],"discussion_count":1,"race_medal":0,"score":"1616741100","product_id":100073401,"comment_content":"é—®é¢˜1: åº”è¯¥æ˜¯åœ¨æ“ä½œ linkedhashmap<br>é—®é¢˜2: å¹¿æ’­å˜é‡å€¼ç›¸å¯¹æ¯”è¾ƒå°ï¼Œåº”è¯¥æ˜¯å­˜åœ¨åœ¨arrayé‡Œé¢","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":517646,"discussion_content":"ç¬¬ä¸€é¢˜èƒ½å†å±•å¼€è¯´è¯´å—ï¼Ÿ æ¯”å¦‚å…·ä½“æ€ä¹ˆæ“ä½œï¼Ÿ\n\nç¬¬äºŒé¢˜å†æƒ³æƒ³å“ˆï¼Œå‚è€ƒrdd cacheçš„è¿‡ç¨‹ï½","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1616757987,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}